cscope 15 /cmpt816/data -q 0000011133 0001423021
	@/cmpt816/linux/arch/x86/ia32/audit.c

1 
	~<asm/uni°d_32.h
>

3 
	gü32_dú_˛ass
[] = {

4 
	~<asm-gíîic/audô_dú_wrôe.h
>

8 
	gü32_ch©å_˛ass
[] = {

9 
	~<asm-gíîic/audô_ch™ge_©å.h
>

13 
	gü32_wrôe_˛ass
[] = {

14 
	~<asm-gíîic/audô_wrôe.h
>

18 
	gü32_ªad_˛ass
[] = {

19 
	~<asm-gíîic/audô_ªad.h
>

23 
	gü32_sig«l_˛ass
[] = {

24 
	~<asm-gíîic/audô_sig«l.h
>

28 
	$ü32_˛assify_sysˇŒ
(
sysˇŒ
)

30 
sysˇŒ
) {

31 
__NR_›í
:

33 
__NR_›í©
:

35 
__NR_sockëˇŒ
:

37 
__NR_execve
:

42 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ia32_signal.c

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/uni°d.h
>

20 
	~<löux/°ddef.h
>

21 
	~<löux/≥rs⁄Æôy.h
>

22 
	~<löux/com∑t.h
>

23 
	~<löux/böfmts.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/±ø˚.h
>

28 
	~<asm/ü32_uni°d.h
>

29 
	~<asm/u£r32.h
>

30 
	~<asm/sigc⁄ãxt32.h
>

31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/vdso.h
>

33 
	~<asm/sig‰ame.h
>

34 
	~<asm/sys_ü32.h
>

36 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

38 
	#FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

39 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

40 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

41 
X86_EFLAGS_CF
)

	)

43 
sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
);

45 
	$c›y_sigöfo_to_u£r32
(
com∑t_sigöfo_t
 
__u£r
 *
to
, 
sigöfo_t
 *
‰om
)

47 
îr
 = 0;

49 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
to
, (
com∑t_sigöfo_t
)))

50  -
EFAULT
;

52 
put_u£r_åy
 {

58 
	`put_u£r_ex
(
‰om
->
si_signo
, &
to
->si_signo);

59 
	`put_u£r_ex
(
‰om
->
si_î∫o
, &
to
->si_errno);

60 
	`put_u£r_ex
(()
‰om
->
si_code
, &
to
->si_code);

62 i‡(
‰om
->
si_code
 < 0) {

63 
	`put_u£r_ex
(
‰om
->
si_pid
, &
to
->si_pid);

64 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

65 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
), &
to
->si_ptr);

71 
	`put_u£r_ex
(
‰om
->
_sifõlds
.
_∑d
[0],

72 &
to
->
_sifõlds
.
_∑d
[0]);

73 
‰om
->
si_code
 >> 16) {

74 
__SI_FAULT
 >> 16:

76 
__SI_CHLD
 >> 16:

77 
	`put_u£r_ex
(
‰om
->
si_utime
, &
to
->si_utime);

78 
	`put_u£r_ex
(
‰om
->
si_°ime
, &
to
->si_stime);

79 
	`put_u£r_ex
(
‰om
->
si_°©us
, &
to
->si_status);

82 
__SI_KILL
 >> 16:

83 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

85 
__SI_POLL
 >> 16:

86 
	`put_u£r_ex
(
‰om
->
si_fd
, &
to
->si_fd);

88 
__SI_TIMER
 >> 16:

89 
	`put_u£r_ex
(
‰om
->
si_ovîrun
, &
to
->si_overrun);

90 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
),

91 &
to
->
si_±r
);

94 
__SI_RT
 >> 16:

95 
__SI_MESGQ
 >> 16:

96 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

97 
	`put_u£r_ex
(
‰om
->
si_öt
, &
to
->si_int);

101 } 
	`put_u£r_ˇtch
(
îr
);

103  
îr
;

104 
	}
}

106 
	$c›y_sigöfo_‰om_u£r32
(
sigöfo_t
 *
to
, 
com∑t_sigöfo_t
 
__u£r
 *
‰om
)

108 
îr
 = 0;

109 
u32
 
±r32
;

111 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰om
, (
com∑t_sigöfo_t
)))

112  -
EFAULT
;

114 
gë_u£r_åy
 {

115 
	`gë_u£r_ex
(
to
->
si_signo
, &
‰om
->si_signo);

116 
	`gë_u£r_ex
(
to
->
si_î∫o
, &
‰om
->si_errno);

117 
	`gë_u£r_ex
(
to
->
si_code
, &
‰om
->si_code);

119 
	`gë_u£r_ex
(
to
->
si_pid
, &
‰om
->si_pid);

120 
	`gë_u£r_ex
(
to
->
si_uid
, &
‰om
->si_uid);

121 
	`gë_u£r_ex
(
±r32
, &
‰om
->
si_±r
);

122 
to
->
si_±r
 = 
	`com∑t_±r
(
±r32
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

128 
asmlökage
 
	$sys32_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

130 
mask
 &
_BLOCKABLE
;

131 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

132 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

133 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

134 
	`ªˇlc_sig≥ndög
();

135 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

137 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

138 
	`scheduÀ
();

139 
	`£t_ª°‹e_sigmask
();

140  -
ERESTARTNOHAND
;

141 
	}
}

143 
asmlökage
 
	$sys32_sigÆt°ack
(c⁄° 
°ack_ü32_t
 
__u£r
 *
uss_±r
,

144 
°ack_ü32_t
 
__u£r
 *
uoss_±r
,

145 
±_ªgs
 *
ªgs
)

147 
°ack_t
 
uss
, 
uoss
;

148 
ªt
, 
îr
 = 0;

149 
mm_£gmít_t
 
£g
;

151 i‡(
uss_±r
) {

152 
u32
 
±r
;

154 
	`mem£t
(&
uss
, 0, (
°ack_t
));

155 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
uss_±r
, (
°ack_ü32_t
)))

156  -
EFAULT
;

158 
gë_u£r_åy
 {

159 
	`gë_u£r_ex
(
±r
, &
uss_±r
->
ss_•
);

160 
	`gë_u£r_ex
(
uss
.
ss_Êags
, &
uss_±r
->ss_flags);

161 
	`gë_u£r_ex
(
uss
.
ss_size
, &
uss_±r
->ss_size);

162 } 
	`gë_u£r_ˇtch
(
îr
);

164 i‡(
îr
)

165  -
EFAULT
;

166 
uss
.
ss_•
 = 
	`com∑t_±r
(
±r
);

168 
£g
 = 
	`gë_fs
();

169 
	`£t_fs
(
KERNEL_DS
);

170 
ªt
 = 
	`do_sigÆt°ack
(
uss_±r
 ? &
uss
 : 
NULL
, &
uoss
, 
ªgs
->
•
);

171 
	`£t_fs
(
£g
);

172 i‡(
ªt
 >0 && 
uoss_±r
) {

173 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss_±r
, (
°ack_ü32_t
)))

174  -
EFAULT
;

176 
put_u£r_åy
 {

177 
	`put_u£r_ex
(
	`±r_to_com∑t
(
uoss
.
ss_•
), &
uoss_±r
->ss_sp);

178 
	`put_u£r_ex
(
uoss
.
ss_Êags
, &
uoss_±r
->ss_flags);

179 
	`put_u£r_ex
(
uoss
.
ss_size
, &
uoss_±r
->ss_size);

180 } 
	`put_u£r_ˇtch
(
îr
);

182 i‡(
îr
)

183 
ªt
 = -
EFAULT
;

185  
ªt
;

186 
	}
}

191 
	#lﬂd£gmít_gs
(
v
Ë
	`lﬂd_gs_ödex
(v)

	)

192 
	#lﬂd£gmít_fs
(
v
Ë
	`lﬂd£gmít
(
fs
, v)

	)

193 
	#lﬂd£gmít_ds
(
v
Ë
	`lﬂd£gmít
(
ds
, v)

	)

194 
	#lﬂd£gmít_es
(
v
Ë
	`lﬂd£gmít
(
es
, v)

	)

196 
	#gë_u£r_£g
(
£g
Ë({ 
v
; 
	`ßve£gmít
(£g, v); v; })

	)

197 
	#£t_u£r_£g
(
£g
, 
v
Ë
lﬂd£gmít_
##
	`£g
(v)

	)

199 
	#COPY
(
x
) { \

200 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

201 }

	)

203 
	#GET_SEG
(
£g
) ({ \

204 
tmp
; \

205 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

206 
tmp
; \

207 })

	)

209 
	#COPY_SEG_CPL3
(
£g
) do { \

210 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

211 } 0)

	)

213 
	#RELOAD_SEG
(
£g
) { \

214 
¥e
 = 
	`GET_SEG
(
£g
); \

215 
cur
 = 
	`gë_u£r_£g
(
£g
); \

216 
¥e
 |= 3; \

217 i‡(
¥e
 !
cur
) \

218 
	`£t_u£r_£g
(
£g
, 
¥e
); \

219 }

	)

221 
	$ü32_ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
,

222 
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

223 *
∑x
)

225 
tmpÊags
, 
îr
 = 0;

226 
__u£r
 *
buf
;

227 
u32
 
tmp
;

230 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

232 
gë_u£r_åy
 {

239 
	`RELOAD_SEG
(
gs
);

240 
	`RELOAD_SEG
(
fs
);

241 
	`RELOAD_SEG
(
ds
);

242 
	`RELOAD_SEG
(
es
);

244 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

245 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

248 
	`COPY_SEG_CPL3
(
cs
);

249 
	`COPY_SEG_CPL3
(
ss
);

251 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

252 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

254 
ªgs
->
‹ig_ax
 = -1;

256 
	`gë_u£r_ex
(
tmp
, &
sc
->
Â°©e
);

257 
buf
 = 
	`com∑t_±r
(
tmp
);

258 
îr
 |
	`ª°‹e_i387_x°©e_ü32
(
buf
);

260 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

261 } 
	`gë_u£r_ˇtch
(
îr
);

263  
îr
;

264 
	}
}

266 
asmlökage
 
	$sys32_sigªtu∫
(
±_ªgs
 *
ªgs
)

268 
sig‰ame_ü32
 
__u£r
 *
‰ame
 = (sig‰ame_ü32 __u£∏*)(
ªgs
->
•
-8);

269 
sig£t_t
 
£t
;

270 
ax
;

272 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

273 
bad‰ame
;

274 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
)

275 || (
_COMPAT_NSIG_WORDS
 > 1

276 && 
	`__c›y_‰om_u£r
((((*Ë&
£t
.
sig
) + 4),

277 &
‰ame
->
exåamask
,

278 (
‰ame
->
exåamask
))))

279 
bad‰ame
;

281 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

282 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

283 
cuºít
->
blocked
 = 
£t
;

284 
	`ªˇlc_sig≥ndög
();

285 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

287 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

288 
bad‰ame
;

289  
ax
;

291 
bad‰ame
:

292 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bit sigreturn");

294 
	}
}

296 
asmlökage
 
	$sys32_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

299 
sig£t_t
 
£t
;

300 
ax
;

301 
±_ªgs
 
åegs
;

303 
‰ame
 = (
π_sig‰ame_ü32
 
__u£r
 *)(
ªgs
->
•
 - 4);

305 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

306 
bad‰ame
;

307 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

308 
bad‰ame
;

310 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

311 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

312 
cuºít
->
blocked
 = 
£t
;

313 
	`ªˇlc_sig≥ndög
();

314 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

316 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

317 
bad‰ame
;

319 
åegs
 = *
ªgs
;

320 i‡(
	`sys32_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, &
åegs
Ë=-
EFAULT
)

321 
bad‰ame
;

323  
ax
;

325 
bad‰ame
:

326 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bitÑt sigreturn");

328 
	}
}

334 
	$ü32_£tup_sigc⁄ãxt
(
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

335 
__u£r
 *
Â°©e
,

336 
±_ªgs
 *
ªgs
, 
mask
)

338 
îr
 = 0;

340 
put_u£r_åy
 {

341 
	`put_u£r_ex
(
	`gë_u£r_£g
(
gs
), (
__u£r
 *)&
sc
->gs);

342 
	`put_u£r_ex
(
	`gë_u£r_£g
(
fs
), (
__u£r
 *)&
sc
->fs);

343 
	`put_u£r_ex
(
	`gë_u£r_£g
(
ds
), (
__u£r
 *)&
sc
->ds);

344 
	`put_u£r_ex
(
	`gë_u£r_£g
(
es
), (
__u£r
 *)&
sc
->es);

346 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

347 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

348 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

349 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

350 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

351 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

352 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

353 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

354 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

355 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

356 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

357 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

358 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

359 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

360 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

362 
	`put_u£r_ex
(
	`±r_to_com∑t
(
Â°©e
), &
sc
->fpstate);

365 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

366 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

367 } 
	`put_u£r_ˇtch
(
îr
);

369  
îr
;

370 
	}
}

375 
__u£r
 *
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
,

376 
size_t
 
‰ame_size
,

377 **
Â°©e
)

379 
•
;

382 
•
 = 
ªgs
->sp;

385 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

386 i‡(
	`ßs_ss_Êags
(
•
) == 0)

387 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

391 i‡((
ªgs
->
ss
 & 0xffffË!
__USER32_DS
 &&

392 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

393 
ka
->
ß
.
ß_ª°‹î
)

394 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

396 i‡(
	`u£d_m©h
()) {

397 
•
 = s∞- 
sig_x°©e_ü32_size
;

398 *
Â°©e
 = (
_Â°©e_ü32
 *Ë
•
;

399 i‡(
	`ßve_i387_x°©e_ü32
(*
Â°©e
) < 0)

400  (
__u£r
 *) -1L;

403 
•
 -
‰ame_size
;

406 
•
 = ((sp + 4) & -16ul) - 4;

407  (
__u£r
 *Ë
•
;

408 
	}
}

410 
	$ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

411 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

413 
sig‰ame_ü32
 
__u£r
 *
‰ame
;

414 
__u£r
 *
ª°‹î
;

415 
îr
 = 0;

416 
__u£r
 *
Â°©e
 = 
NULL
;

420 
u16
 
p›lmovl
;

421 
u32
 
vÆ
;

422 
u16
 
öt80
;

423 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

425 
__NR_ü32_sigªtu∫
,

429 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

431 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

432  -
EFAULT
;

434 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

435  -
EFAULT
;

437 i‡(
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

438  -
EFAULT
;

440 i‡(
_COMPAT_NSIG_WORDS
 > 1) {

441 i‡(
	`__c›y_to_u£r
(
‰ame
->
exåamask
, &
£t
->
sig
[1],

442 (
‰ame
->
exåamask
)))

443  -
EFAULT
;

446 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

447 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

450 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

451 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

452 
sigªtu∫
);

454 
ª°‹î
 = &
‰ame
->
ªtcode
;

457 
put_u£r_åy
 {

458 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

464 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

465 } 
	`put_u£r_ˇtch
(
îr
);

467 i‡(
îr
)

468  -
EFAULT
;

471 
ªgs
->
•
 = (Ë
‰ame
;

472 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

475 
ªgs
->
ax
 = 
sig
;

476 
ªgs
->
dx
 = 0;

477 
ªgs
->
cx
 = 0;

479 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

480 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

482 
ªgs
->
cs
 = 
__USER32_CS
;

483 
ªgs
->
ss
 = 
__USER32_DS
;

486 
	}
}

488 
	$ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

489 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

491 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

492 
__u£r
 *
ª°‹î
;

493 
îr
 = 0;

494 
__u£r
 *
Â°©e
 = 
NULL
;

498 
u8
 
movl
;

499 
u32
 
vÆ
;

500 
u16
 
öt80
;

501 
u8
 
∑d
;

502 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

504 
__NR_ü32_π_sigªtu∫
,

509 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

511 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

512  -
EFAULT
;

514 
put_u£r_åy
 {

515 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

516 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
öfo
), &‰ame->
pöfo
);

517 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
uc
), &‰ame->
puc
);

518 
îr
 |
	`c›y_sigöfo_to_u£r32
(&
‰ame
->
öfo
, info);

521 i‡(
˝u_has_xßve
)

522 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

524 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

525 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

526 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

527 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

528 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

529 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

530 
îr
 |
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

531 
ªgs
, 
£t
->
sig
[0]);

532 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

534 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

535 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

537 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

538 
π_sigªtu∫
);

539 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

545 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

546 } 
	`put_u£r_ˇtch
(
îr
);

548 i‡(
îr
)

549  -
EFAULT
;

552 
ªgs
->
•
 = (Ë
‰ame
;

553 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

556 
ªgs
->
ax
 = 
sig
;

557 
ªgs
->
dx
 = (Ë&
‰ame
->
öfo
;

558 
ªgs
->
cx
 = (Ë&
‰ame
->
uc
;

560 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

561 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

563 
ªgs
->
cs
 = 
__USER32_CS
;

564 
ªgs
->
ss
 = 
__USER32_DS
;

567 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ipc32.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/•ölock.h
>

3 
	~<löux/li°.h
>

4 
	~<löux/sysˇŒs.h
>

5 
	~<löux/time.h
>

6 
	~<löux/£m.h
>

7 
	~<löux/msg.h
>

8 
	~<löux/shm.h
>

9 
	~<löux/ùc.h
>

10 
	~<löux/com∑t.h
>

11 
	~<asm/sys_ü32.h
>

13 
asmlökage
 
	$sys32_ùc
(
u32
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

14 
com∑t_u±r_t
 
±r
, 
u32
 
fi·h
)

16 
vîsi⁄
;

18 
vîsi⁄
 = 
ˇŒ
 >> 16;

19 
ˇŒ
 &= 0xffff;

21 
ˇŒ
) {

22 
SEMOP
:

24  
	`sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
, 
NULL
);

25 
SEMTIMEDOP
:

26  
	`com∑t_sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
,

27 
	`com∑t_±r
(
fi·h
));

28 
SEMGET
:

29  
	`sys_£mgë
(
fú°
, 
£c⁄d
, 
thúd
);

30 
SEMCTL
:

31  
	`com∑t_sys_£m˘l
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

33 
MSGSND
:

34  
	`com∑t_sys_msg¢d
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

35 
MSGRCV
:

36  
	`com∑t_sys_msgrcv
(
fú°
, 
£c⁄d
, 
fi·h
, 
thúd
,

37 
vîsi⁄
, 
	`com∑t_±r
(
±r
));

38 
MSGGET
:

39  
	`sys_msggë
((
key_t
Ë
fú°
, 
£c⁄d
);

40 
MSGCTL
:

41  
	`com∑t_sys_msg˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

43 
SHMAT
:

44  
	`com∑t_sys_shm©
(
fú°
, 
£c⁄d
, 
thúd
, 
vîsi⁄
,

45 
	`com∑t_±r
(
±r
));

46 
SHMDT
:

47  
	`sys_shmdt
(
	`com∑t_±r
(
±r
));

48 
SHMGET
:

49  
	`sys_shmgë
(
fú°
, ()
£c⁄d
, 
thúd
);

50 
SHMCTL
:

51  
	`com∑t_sys_shm˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

53  -
ENOSYS
;

54 
	}
}

	@/cmpt816/linux/arch/x86/ia32/sys_ia32.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/sig«l.h
>

28 
	~<löux/sysˇŒs.h
>

29 
	~<löux/times.h
>

30 
	~<löux/ut¢ame.h
>

31 
	~<löux/smp_lock.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/uio.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/≥rs⁄Æôy.h
>

36 
	~<löux/°©.h
>

37 
	~<löux/rw£m.h
>

38 
	~<löux/com∑t.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/±ø˚.h
>

41 
	~<löux/highuid.h
>

42 
	~<löux/sys˘l.h
>

43 
	~<asm/mm™.h
>

44 
	~<asm/ty≥s.h
>

45 
	~<asm/uac˚ss.h
>

46 
	~<asm/©omic.h
>

47 
	~<asm/vgtod.h
>

48 
	~<asm/sys_ü32.h
>

50 
	#AA
(
__x
Ë(()(__x))

	)

53 
asmlökage
 
	$sys32_åunˇã64
(
__u£r
 *
fûíame
,

54 
off£t_low
,

55 
off£t_high
)

57  
	`sys_åunˇã
(
fûíame
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

58 
	}
}

60 
asmlökage
 
	$sys32_·runˇã64
(
fd
, 
off£t_low
,

61 
off£t_high
)

63  
	`sys_·runˇã
(
fd
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

64 
	}
}

70 
	$˝_°©64
(
°©64
 
__u£r
 *
ubuf
, 
k°©
 *
°©
)

72 
	`ty≥of
(
ubuf
->
°_uid
Ë
uid
 = 0;

73 
	`ty≥of
(
ubuf
->
°_gid
Ë
gid
 = 0;

74 
	`SET_UID
(
uid
, 
°©
->uid);

75 
	`SET_GID
(
gid
, 
°©
->gid);

76 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ubuf
, (
°©64
)) ||

77 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
dev
), &
ubuf
->
°_dev
) ||

78 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
__°_öo
) ||

79 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
°_öo
) ||

80 
	`__put_u£r
(
°©
->
mode
, &
ubuf
->
°_mode
) ||

81 
	`__put_u£r
(
°©
->
∆ök
, &
ubuf
->
°_∆ök
) ||

82 
	`__put_u£r
(
uid
, &
ubuf
->
°_uid
) ||

83 
	`__put_u£r
(
gid
, &
ubuf
->
°_gid
) ||

84 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
rdev
), &
ubuf
->
°_rdev
) ||

85 
	`__put_u£r
(
°©
->
size
, &
ubuf
->
°_size
) ||

86 
	`__put_u£r
(
°©
->
©ime
.
tv_£c
, &
ubuf
->
°_©ime
) ||

87 
	`__put_u£r
(
°©
->
©ime
.
tv_n£c
, &
ubuf
->
°_©ime_n£c
) ||

88 
	`__put_u£r
(
°©
->
mtime
.
tv_£c
, &
ubuf
->
°_mtime
) ||

89 
	`__put_u£r
(
°©
->
mtime
.
tv_n£c
, &
ubuf
->
°_mtime_n£c
) ||

90 
	`__put_u£r
(
°©
->
˘ime
.
tv_£c
, &
ubuf
->
°_˘ime
) ||

91 
	`__put_u£r
(
°©
->
˘ime
.
tv_n£c
, &
ubuf
->
°_˘ime_n£c
) ||

92 
	`__put_u£r
(
°©
->
blksize
, &
ubuf
->
°_blksize
) ||

93 
	`__put_u£r
(
°©
->
blocks
, &
ubuf
->
°_blocks
))

94  -
EFAULT
;

96 
	}
}

98 
asmlökage
 
	$sys32_°©64
(
__u£r
 *
fûíame
,

99 
°©64
 
__u£r
 *
°©buf
)

101 
k°©
 
°©
;

102 
ªt
 = 
	`vfs_°©
(
fûíame
, &
°©
);

104 i‡(!
ªt
)

105 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

106  
ªt
;

107 
	}
}

109 
asmlökage
 
	$sys32_l°©64
(
__u£r
 *
fûíame
,

110 
°©64
 
__u£r
 *
°©buf
)

112 
k°©
 
°©
;

113 
ªt
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

114 i‡(!
ªt
)

115 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

116  
ªt
;

117 
	}
}

119 
asmlökage
 
	$sys32_f°©64
(
fd
, 
°©64
 
__u£r
 *
°©buf
)

121 
k°©
 
°©
;

122 
ªt
 = 
	`vfs_f°©
(
fd
, &
°©
);

123 i‡(!
ªt
)

124 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

125  
ªt
;

126 
	}
}

128 
asmlökage
 
	$sys32_f°©©
(
dfd
, 
__u£r
 *
fûíame
,

129 
°©64
 
__u£r
 *
°©buf
, 
Êag
)

131 
k°©
 
°©
;

132 
îr‹
;

134 
îr‹
 = 
	`vfs_f°©©
(
dfd
, 
fûíame
, &
°©
, 
Êag
);

135 i‡(
îr‹
)

136  
îr‹
;

137  
	`˝_°©64
(
°©buf
, &
°©
);

138 
	}
}

146 
	smm≠_¨g_°ru˘
 {

147 
	maddr
;

148 
	mÀn
;

149 
	m¥Ÿ
;

150 
	mÊags
;

151 
	mfd
;

152 
	moff£t
;

155 
asmlökage
 
	$sys32_mm≠
(
mm≠_¨g_°ru˘
 
__u£r
 *
¨g
)

157 
mm≠_¨g_°ru˘
 
a
;

159 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

160  -
EFAULT
;

162 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

163  -
EINVAL
;

165  
	`sys_mm≠_pgoff
(
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,á.
fd
,

166 
a
.
off£t
>>
PAGE_SHIFT
);

167 
	}
}

169 
asmlökage
 
	$sys32_m¥Ÿe˘
(
°¨t
, 
size_t
 
Àn
,

170 
¥Ÿ
)

172  
	`sys_m¥Ÿe˘
(
°¨t
, 
Àn
, 
¥Ÿ
);

173 
	}
}

175 
asmlökage
 
	$sys32_π_siga˘i⁄
(
sig
, 
siga˘i⁄32
 
__u£r
 *
a˘
,

176 
siga˘i⁄32
 
__u£r
 *
ﬂ˘
,

177 
sig£tsize
)

179 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

180 
ªt
;

181 
com∑t_sig£t_t
 
£t32
;

184 i‡(
sig£tsize
 !(
com∑t_sig£t_t
))

185  -
EINVAL
;

187 i‡(
a˘
) {

188 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

190 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

191 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

192 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

193 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

194 
	`__c›y_‰om_u£r
(&
£t32
, &
a˘
->
ß_mask
,

195 (
com∑t_sig£t_t
)))

196  -
EFAULT
;

197 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

198 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

204 
_NSIG_WORDS
) {

205 4: 
√w_ka
.
ß
.
ß_mask
.
sig
[3] = 
£t32
.sig[6]

206 | ((()
£t32
.
sig
[7]) << 32);

207 3: 
√w_ka
.
ß
.
ß_mask
.
sig
[2] = 
£t32
.sig[4]

208 | ((()
£t32
.
sig
[5]) << 32);

209 2: 
√w_ka
.
ß
.
ß_mask
.
sig
[1] = 
£t32
.sig[2]

210 | ((()
£t32
.
sig
[3]) << 32);

211 1: 
√w_ka
.
ß
.
ß_mask
.
sig
[0] = 
£t32
.sig[0]

212 | ((()
£t32
.
sig
[1]) << 32);

216 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

218 i‡(!
ªt
 && 
ﬂ˘
) {

223 
_NSIG_WORDS
) {

225 
£t32
.
sig
[7] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[3] >> 32);

226 
£t32
.
sig
[6] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[3];

228 
£t32
.
sig
[5] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[2] >> 32);

229 
£t32
.
sig
[4] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[2];

231 
£t32
.
sig
[3] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[1] >> 32);

232 
£t32
.
sig
[2] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[1];

234 
£t32
.
sig
[1] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[0] >> 32);

235 
£t32
.
sig
[0] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[0];

237 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

238 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

239 &
ﬂ˘
->
ß_h™dÀr
) ||

240 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

241 &
ﬂ˘
->
ß_ª°‹î
) ||

242 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

243 
	`__c›y_to_u£r
(&
ﬂ˘
->
ß_mask
, &
£t32
,

244 (
com∑t_sig£t_t
)))

245  -
EFAULT
;

248  
ªt
;

249 
	}
}

251 
asmlökage
 
	$sys32_siga˘i⁄
(
sig
, 
ﬁd_siga˘i⁄32
 
__u£r
 *
a˘
,

252 
ﬁd_siga˘i⁄32
 
__u£r
 *
ﬂ˘
)

254 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

255 
ªt
;

257 i‡(
a˘
) {

258 
com∑t_ﬁd_sig£t_t
 
mask
;

259 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

261 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

262 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

263 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

264 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

265 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
))

266  -
EFAULT
;

268 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

269 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

271 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

274 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

276 i‡(!
ªt
 && 
ﬂ˘
) {

277 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

278 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

279 &
ﬂ˘
->
ß_h™dÀr
) ||

280 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

281 &
ﬂ˘
->
ß_ª°‹î
) ||

282 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

283 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask))

284  -
EFAULT
;

287  
ªt
;

288 
	}
}

290 
asmlökage
 
	$sys32_π_sig¥ocmask
(
how
, 
com∑t_sig£t_t
 
__u£r
 *
£t
,

291 
com∑t_sig£t_t
 
__u£r
 *
o£t
,

292 
sig£tsize
)

294 
sig£t_t
 
s
;

295 
com∑t_sig£t_t
 
s32
;

296 
ªt
;

297 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

299 i‡(
£t
) {

300 i‡(
	`c›y_‰om_u£r
(&
s32
, 
£t
, (
com∑t_sig£t_t
)))

301  -
EFAULT
;

302 
_NSIG_WORDS
) {

303 4: 
s
.
sig
[3] = 
s32
.sig[6] | ((()s32.sig[7]) << 32);

304 3: 
s
.
sig
[2] = 
s32
.sig[4] | ((()s32.sig[5]) << 32);

305 2: 
s
.
sig
[1] = 
s32
.sig[2] | ((()s32.sig[3]) << 32);

306 1: 
s
.
sig
[0] = 
s32
.sig[0] | ((()s32.sig[1]) << 32);

309 
	`£t_fs
(
KERNEL_DS
);

310 
ªt
 = 
	`sys_π_sig¥ocmask
(
how
,

311 
£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

312 
o£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

313 
sig£tsize
);

314 
	`£t_fs
(
ﬁd_fs
);

315 i‡(
ªt
)

316  
ªt
;

317 i‡(
o£t
) {

318 
_NSIG_WORDS
) {

319 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

320 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

321 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

322 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

324 i‡(
	`c›y_to_u£r
(
o£t
, &
s32
, (
com∑t_sig£t_t
)))

325  -
EFAULT
;

328 
	}
}

330 
asmlökage
 
	$sys32_Æ¨m
(
£c⁄ds
)

332  
	`Æ¨m_£tôimî
(
£c⁄ds
);

333 
	}
}

335 
	s£l_¨g_°ru˘
 {

336 
	mn
;

337 
	möp
;

338 
	mouç
;

339 
	mexp
;

340 
	mtvp
;

343 
asmlökage
 
	$sys32_ﬁd_£À˘
(
£l_¨g_°ru˘
 
__u£r
 *
¨g
)

345 
£l_¨g_°ru˘
 
a
;

347 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

348  -
EFAULT
;

349  
	`com∑t_sys_£À˘
(
a
.
n
, 
	`com∑t_±r
◊.
öp
), com∑t_±r◊.
ouç
),

350 
	`com∑t_±r
(
a
.
exp
), com∑t_±r◊.
tvp
));

351 
	}
}

353 
asmlökage
 
	$sys32_waôpid
(
com∑t_pid_t
 
pid
, *
°©_addr
,

354 
›ti⁄s
)

356  
	`com∑t_sys_waô4
(
pid
, 
°©_addr
, 
›ti⁄s
, 
NULL
);

357 
	}
}

361 
asmlökage
 
	$sys32_sysfs
(
›ti⁄
, 
u32
 
¨g1
, u32 
¨g2
)

363  
	`sys_sysfs
(
›ti⁄
, 
¨g1
, 
¨g2
);

364 
	}
}

366 
asmlökage
 
	$sys32_sched_º_gë_öãrvÆ
(
com∑t_pid_t
 
pid
,

367 
com∑t_time•ec
 
__u£r
 *
öãrvÆ
)

369 
time•ec
 
t
;

370 
ªt
;

371 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

373 
	`£t_fs
(
KERNEL_DS
);

374 
ªt
 = 
	`sys_sched_º_gë_öãrvÆ
(
pid
, (
time•ec
 
__u£r
 *)&
t
);

375 
	`£t_fs
(
ﬁd_fs
);

376 i‡(
	`put_com∑t_time•ec
(&
t
, 
öãrvÆ
))

377  -
EFAULT
;

378  
ªt
;

379 
	}
}

381 
asmlökage
 
	$sys32_π_sig≥ndög
(
com∑t_sig£t_t
 
__u£r
 *
£t
,

382 
com∑t_size_t
 
sig£tsize
)

384 
sig£t_t
 
s
;

385 
com∑t_sig£t_t
 
s32
;

386 
ªt
;

387 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

389 
	`£t_fs
(
KERNEL_DS
);

390 
ªt
 = 
	`sys_π_sig≥ndög
((
sig£t_t
 
__u£r
 *)&
s
, 
sig£tsize
);

391 
	`£t_fs
(
ﬁd_fs
);

392 i‡(!
ªt
) {

393 
_NSIG_WORDS
) {

394 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

395 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

396 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

397 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

399 i‡(
	`c›y_to_u£r
(
£t
, &
s32
, (
com∑t_sig£t_t
)))

400  -
EFAULT
;

402  
ªt
;

403 
	}
}

405 
asmlökage
 
	$sys32_π_sigqueueöfo
(
pid
, 
sig
,

406 
com∑t_sigöfo_t
 
__u£r
 *
uöfo
)

408 
sigöfo_t
 
öfo
;

409 
ªt
;

410 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

412 i‡(
	`c›y_sigöfo_‰om_u£r32
(&
öfo
, 
uöfo
))

413  -
EFAULT
;

414 
	`£t_fs
(
KERNEL_DS
);

415 
ªt
 = 
	`sys_π_sigqueueöfo
(
pid
, 
sig
, (
sigöfo_t
 
__u£r
 *)&
öfo
);

416 
	`£t_fs
(
ﬁd_fs
);

417  
ªt
;

418 
	}
}

421 
asmlökage
 
	$sys32_¥ód
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

422 
u32
 
po¶o
, u32 
poshi
)

424  
	`sys_¥ód64
(
fd
, 
ubuf
, 
cou¡
,

425 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

426 
	}
}

428 
asmlökage
 
	$sys32_pwrôe
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

429 
u32
 
po¶o
, u32 
poshi
)

431  
	`sys_pwrôe64
(
fd
, 
ubuf
, 
cou¡
,

432 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

433 
	}
}

436 
asmlökage
 
	$sys32_≥rs⁄Æôy
(
≥rs⁄Æôy
)

438 
ªt
;

440 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
 &&

441 
≥rs⁄Æôy
 =
PER_LINUX
)

442 
≥rs⁄Æôy
 = 
PER_LINUX32
;

443 
ªt
 = 
	`sys_≥rs⁄Æôy
(
≥rs⁄Æôy
);

444 i‡(
ªt
 =
PER_LINUX32
)

445 
ªt
 = 
PER_LINUX
;

446  
ªt
;

447 
	}
}

449 
asmlökage
 
	$sys32_£ndfûe
(
out_fd
, 
ö_fd
,

450 
com∑t_off_t
 
__u£r
 *
off£t
, 
s32
 
cou¡
)

452 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

453 
ªt
;

454 
off_t
 
of
;

456 i‡(
off£t
 && 
	`gë_u£r
(
of
, offset))

457  -
EFAULT
;

459 
	`£t_fs
(
KERNEL_DS
);

460 
ªt
 = 
	`sys_£ndfûe
(
out_fd
, 
ö_fd
, 
off£t
 ? (
off_t
 
__u£r
 *)&
of
 : 
NULL
,

461 
cou¡
);

462 
	`£t_fs
(
ﬁd_fs
);

464 i‡(
off£t
 && 
	`put_u£r
(
of
, offset))

465  -
EFAULT
;

466  
ªt
;

467 
	}
}

469 
asmlökage
 
	$sys32_ﬁdu«me
(
ﬁdﬁd_ut¢ame
 
__u£r
 *
«me
)

471 *
¨ch
 = "x86_64";

472 
îr
;

474 i‡(!
«me
)

475  -
EFAULT
;

476 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«me
, (
ﬁdﬁd_ut¢ame
)))

477  -
EFAULT
;

479 
	`down_ªad
(&
uts_£m
);

481 
îr
 = 
	`__c›y_to_u£r
(&
«me
->
sy¢ame
, &
	`ut¢ame
()->sysname,

482 
__OLD_UTS_LEN
);

483 
îr
 |
	`__put_u£r
(0, 
«me
->
sy¢ame
+
__OLD_UTS_LEN
);

484 
îr
 |
	`__c›y_to_u£r
(&
«me
->
nodíame
, &
	`ut¢ame
()->nodename,

485 
__OLD_UTS_LEN
);

486 
îr
 |
	`__put_u£r
(0, 
«me
->
nodíame
+
__OLD_UTS_LEN
);

487 
îr
 |
	`__c›y_to_u£r
(&
«me
->
ªÀa£
, &
	`ut¢ame
()->release,

488 
__OLD_UTS_LEN
);

489 
îr
 |
	`__put_u£r
(0, 
«me
->
ªÀa£
+
__OLD_UTS_LEN
);

490 
îr
 |
	`__c›y_to_u£r
(&
«me
->
vîsi⁄
, &
	`ut¢ame
()->version,

491 
__OLD_UTS_LEN
);

492 
îr
 |
	`__put_u£r
(0, 
«me
->
vîsi⁄
+
__OLD_UTS_LEN
);

494 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

495 
¨ch
 = "i686";

497 
îr
 |
	`__c›y_to_u£r
(&
«me
->
machöe
, 
¨ch
, 
	`°æí
(arch) + 1);

499 
	`up_ªad
(&
uts_£m
);

501 
îr
 =Éº ? -
EFAULT
 : 0;

503  
îr
;

504 
	}
}

506 
	$sys32_u«me
(
ﬁd_ut¢ame
 
__u£r
 *
«me
)

508 
îr
;

510 i‡(!
«me
)

511  -
EFAULT
;

512 
	`down_ªad
(&
uts_£m
);

513 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

514 
	`up_ªad
(&
uts_£m
);

515 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

516 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

518  
îr
 ? -
EFAULT
 : 0;

519 
	}
}

521 
asmlökage
 
	$sys32_execve
(
__u£r
 *
«me
, 
com∑t_u±r_t
 __u£∏*
¨gv
,

522 
com∑t_u±r_t
 
__u£r
 *
ívp
, 
±_ªgs
 *
ªgs
)

524 
îr‹
;

525 *
fûíame
;

527 
fûíame
 = 
	`gë«me
(
«me
);

528 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

529 i‡(
	`IS_ERR
(
fûíame
))

530  
îr‹
;

531 
îr‹
 = 
	`com∑t_do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

532 
	`puäame
(
fûíame
);

533  
îr‹
;

534 
	}
}

536 
asmlökage
 
	$sys32_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

537 
±_ªgs
 *
ªgs
)

539 
__u£r
 *
∑ª¡_tid
 = (__u£∏*)
ªgs
->
dx
;

540 
__u£r
 *
chûd_tid
 = (__u£∏*)
ªgs
->
di
;

542 i‡(!
√w•
)

543 
√w•
 = 
ªgs
->
•
;

544  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

545 
	}
}

551 
	$sys32_l£ek
(
fd
, 
off£t
, 
whí˚
)

553  
	`sys_l£ek
(
fd
, 
off£t
, 
whí˚
);

554 
	}
}

556 
	$sys32_kûl
(
pid
, 
sig
)

558  
	`sys_kûl
(
pid
, 
sig
);

559 
	}
}

561 
	$sys32_Ádvi£64_64
(
fd
, 
__u32
 
off£t_low
, __u32 
off£t_high
,

562 
__u32
 
Àn_low
, __u32 
Àn_high
, 
advi˚
)

564  
	`sys_Ádvi£64_64
(
fd
,

565 (((
u64
)
off£t_high
)<<32Ë| 
off£t_low
,

566 (((
u64
)
Àn_high
)<<32Ë| 
Àn_low
,

567 
advi˚
);

568 
	}
}

570 
	$sys32_vm86_w¨nög
()

572 
èsk_°ru˘
 *
me
 = 
cuºít
;

573 
œ°comm
[(
me
->
comm
)];

575 i‡(
	`°∫cmp
(
œ°comm
, 
me
->
comm
, (lastcomm))) {

576 
	`com∑t_¥ötk
(
KERN_INFO


578 
me
->
comm
);

579 
	`°∫˝y
(
œ°comm
, 
me
->
comm
, (lastcomm));

581  -
ENOSYS
;

582 
	}
}

584 
	$sys32_lookup_dcookõ
(
u32
 
addr_low
, u32 
addr_high
,

585 
__u£r
 *
buf
, 
size_t
 
Àn
)

587  
	`sys_lookup_dcookõ
(((
u64
)
addr_high
 << 32Ë| 
addr_low
, 
buf
, 
Àn
);

588 
	}
}

590 
asmlökage
 
ssize_t
 
	$sys32_ªadahód
(
fd
, 
off_lo
, 
off_hi
,

591 
size_t
 
cou¡
)

593  
	`sys_ªadahód
(
fd
, ((
u64
)
off_hi
 << 32Ë| 
off_lo
, 
cou¡
);

594 
	}
}

596 
asmlökage
 
	$sys32_sync_fûe_ønge
(
fd
, 
off_low
, 
off_hi
,

597 
n_low
, 
n_hi
, 
Êags
)

599  
	`sys_sync_fûe_ønge
(
fd
,

600 ((
u64
)
off_hi
 << 32Ë| 
off_low
,

601 ((
u64
)
n_hi
 << 32Ë| 
n_low
, 
Êags
);

602 
	}
}

604 
asmlökage
 
	$sys32_Ádvi£64
(
fd
, 
off£t_lo
, 
off£t_hi
,

605 
size_t
 
Àn
, 
advi˚
)

607  
	`sys_Ádvi£64_64
(
fd
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

608 
Àn
, 
advi˚
);

609 
	}
}

611 
asmlökage
 
	$sys32_ÁŒoˇã
(
fd
, 
mode
, 
off£t_lo
,

612 
off£t_hi
, 
Àn_lo
,

613 
Àn_hi
)

615  
	`sys_ÁŒoˇã
(
fd
, 
mode
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

616 ((
u64
)
Àn_hi
 << 32Ë| 
Àn_lo
);

617 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<löux/öô.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/a˝i_pmtmr.h
>

29 
	~<löux/efi.h
>

30 
	~<löux/˝umask.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/dmi.h
>

33 
	~<löux/úq.h
>

34 
	~<löux/boŸmem.h
>

35 
	~<löux/i›‹t.h
>

36 
	~<löux/pci.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/io_≠ic.h
>

40 
	~<asm/≠ic.h
>

41 
	~<asm/io.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/smp.h
>

45 
__öôd©a
 
	ga˝i_f‹˚
 = 0;

46 
u32
 
	ga˝i_rsdt_f‹˚d
;

47 
	ga˝i_dißbÀd
;

48 
EXPORT_SYMBOL
(
a˝i_dißbÀd
);

50 #ifdef 
CONFIG_X86_64


51 
	~<asm/¥Ÿo.h
>

54 
	#BAD_MADT_ENTRY
(
íåy
, 
íd
) ( \

55 (!
íåy
Ë|| (Î¡ry + (*íåyË> 
íd
 || \

56 ((
a˝i_subèbÀ_hódî
 *)
íåy
)->
Àngth
 < (*íåy))

	)

58 
	#PREFIX
 "ACPI: "

	)

60 
	ga˝i_noúq
;

61 
	ga˝i_pci_dißbÀd
;

62 
EXPORT_SYMBOL
(
a˝i_pci_dißbÀd
);

63 
a˝i_ht
 
	g__öôd©a
 = 1;

65 
	ga˝i_œpic
;

66 
	ga˝i_iﬂpic
;

67 
	ga˝i_°ri˘
;

69 
u8
 
a˝i_sci_Êags
 
	g__öôd©a
;

70 
a˝i_sci_ovîride_gsi
 
	g__öôd©a
;

71 
a˝i_skù_timî_ovîride
 
	g__öôd©a
;

72 
a˝i_u£_timî_ovîride
 
	g__öôd©a
;

74 #ifde‡
CONFIG_X86_LOCAL_APIC


75 
u64
 
a˝i_œpic_addr
 
	g__öôd©a
 = 
APIC_DEFAULT_PHYS_BASE
;

78 #i‚de‡
__HAVE_ARCH_CMPXCHG


79 #w¨nög 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
™d
 
œãr
 
h¨dw¨e


90 
a˝i_úq_modñ_id
 
	ga˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_PIC
;

105 *
__öô
 
	$__a˝i_m≠_èbÀ
(
phys
, 
size
)

108 i‡(!
phys
 || !
size
)

109  
NULL
;

111  
	`óæy_i‹em≠
(
phys
, 
size
);

112 
	}
}

113 
__öô
 
	$__a˝i_unm≠_èbÀ
(*
m≠
, 
size
)

115 i‡(!
m≠
 || !
size
)

118 
	`óæy_iounm≠
(
m≠
, 
size
);

119 
	}
}

121 #ifde‡
CONFIG_X86_LOCAL_APIC


122 
__öô
 
	$a˝i_∑r£_madt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

124 
a˝i_èbÀ_madt
 *
madt
 = 
NULL
;

126 i‡(!
˝u_has_≠ic
)

127  -
EINVAL
;

129 
madt
 = (
a˝i_èbÀ_madt
 *)
èbÀ
;

130 i‡(!
madt
) {

131 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map MADT\n");

132  -
ENODEV
;

135 i‡(
madt
->
addªss
) {

136 
a˝i_œpic_addr
 = (
u64
Ë
madt
->
addªss
;

138 
	`¥ötk
(
KERN_DEBUG
 
PREFIX
 "Local APICáddress 0x%08x\n",

139 
madt
->
addªss
);

142 
	`deÁu…_a˝i_madt_€m_check
(
madt
->
hódî
.
€m_id
,

143 
madt
->
hódî
.
€m_èbÀ_id
);

146 
	}
}

148 
__˝uöô
 
	$a˝i_ªgi°î_œpic
(
id
, 
u8
 
íabÀd
)

150 
vî
 = 0;

152 i‡(!
íabÀd
) {

153 ++
dißbÀd_˝us
;

157 i‡(
boŸ_˝u_physiˇl_≠icid
 != -1U)

158 
vî
 = 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
];

160 
	`gíîic_¥o˚ss‹_öfo
(
id
, 
vî
);

161 
	}
}

163 
__öô


164 
	$a˝i_∑r£_x2≠ic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

166 
a˝i_madt_loˇl_x2≠ic
 *
¥o˚ss‹
 = 
NULL
;

168 
¥o˚ss‹
 = (
a˝i_madt_loˇl_x2≠ic
 *)
hódî
;

170 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

171  -
EINVAL
;

173 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

175 #ifde‡
CONFIG_X86_X2APIC


183 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
loˇl_≠ic_id
,

184 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

186 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "x2apicÉntry ignored\n");

190 
	}
}

192 
__öô


193 
	$a˝i_∑r£_œpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

195 
a˝i_madt_loˇl_≠ic
 *
¥o˚ss‹
 = 
NULL
;

197 
¥o˚ss‹
 = (
a˝i_madt_loˇl_≠ic
 *)
hódî
;

199 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

200  -
EINVAL
;

202 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

211 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
id
,

212 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

215 
	}
}

217 
__öô


218 
	$a˝i_∑r£_ßpic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

220 
a˝i_madt_loˇl_ßpic
 *
¥o˚ss‹
 = 
NULL
;

222 
¥o˚ss‹
 = (
a˝i_madt_loˇl_ßpic
 *)
hódî
;

224 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

225  -
EINVAL
;

227 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

229 
	`a˝i_ªgi°î_œpic
((
¥o˚ss‹
->
id
 << 8Ë|Öro˚ss‹->
eid
,

230 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

233 
	}
}

235 
__öô


236 
	$a˝i_∑r£_œpic_addr_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

237 c⁄° 
íd
)

239 
a˝i_madt_loˇl_≠ic_ovîride
 *
œpic_addr_ovr
 = 
NULL
;

241 
œpic_addr_ovr
 = (
a˝i_madt_loˇl_≠ic_ovîride
 *)
hódî
;

243 i‡(
	`BAD_MADT_ENTRY
(
œpic_addr_ovr
, 
íd
))

244  -
EINVAL
;

246 
a˝i_œpic_addr
 = 
œpic_addr_ovr
->
addªss
;

249 
	}
}

251 
__öô


252 
	$a˝i_∑r£_x2≠ic_nmi
(
a˝i_subèbÀ_hódî
 *
hódî
,

253 c⁄° 
íd
)

255 
a˝i_madt_loˇl_x2≠ic_nmi
 *
x2≠ic_nmi
 = 
NULL
;

257 
x2≠ic_nmi
 = (
a˝i_madt_loˇl_x2≠ic_nmi
 *)
hódî
;

259 i‡(
	`BAD_MADT_ENTRY
(
x2≠ic_nmi
, 
íd
))

260  -
EINVAL
;

262 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

264 i‡(
x2≠ic_nmi
->
löt
 != 1)

265 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

268 
	}
}

270 
__öô


271 
	$a˝i_∑r£_œpic_nmi
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

273 
a˝i_madt_loˇl_≠ic_nmi
 *
œpic_nmi
 = 
NULL
;

275 
œpic_nmi
 = (
a˝i_madt_loˇl_≠ic_nmi
 *)
hódî
;

277 i‡(
	`BAD_MADT_ENTRY
(
œpic_nmi
, 
íd
))

278  -
EINVAL
;

280 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

282 i‡(
œpic_nmi
->
löt
 != 1)

283 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

286 
	}
}

290 #ifde‡
CONFIG_X86_IO_APIC


292 
__öô


293 
	$a˝i_∑r£_iﬂpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

295 
a˝i_madt_io_≠ic
 *
iﬂpic
 = 
NULL
;

297 
iﬂpic
 = (
a˝i_madt_io_≠ic
 *)
hódî
;

299 i‡(
	`BAD_MADT_ENTRY
(
iﬂpic
, 
íd
))

300  -
EINVAL
;

302 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

304 
	`mp_ªgi°î_iﬂpic
(
iﬂpic
->
id
,

305 
iﬂpic
->
addªss
, iﬂpic->
globÆ_úq_ba£
);

308 
	}
}

313 
__öô
 
	$a˝i_sci_iﬂpic_£tup
(
u32
 
gsi
, 
u16
 
pﬁ¨ôy
, u16 
åiggî
)

315 i‡(
åiggî
 == 0)

316 
åiggî
 = 3;

318 i‡(
pﬁ¨ôy
 == 0)

319 
pﬁ¨ôy
 = 3;

322 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
)

323 
åiggî
 = (
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

325 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
)

326 
pﬁ¨ôy
 = 
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
;

333 
	`mp_ovîride_Àgacy_úq
(
gsi
, 
pﬁ¨ôy
, 
åiggî
, gsi);

339 
a˝i_sci_ovîride_gsi
 = 
gsi
;

341 
	}
}

343 
__öô


344 
	$a˝i_∑r£_öt_§c_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

345 c⁄° 
íd
)

347 
a˝i_madt_öãºu±_ovîride
 *
öt§c
 = 
NULL
;

349 
öt§c
 = (
a˝i_madt_öãºu±_ovîride
 *)
hódî
;

351 i‡(
	`BAD_MADT_ENTRY
(
öt§c
, 
íd
))

352  -
EINVAL
;

354 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

356 i‡(
öt§c
->
sour˚_úq
 =
a˝i_gbl_FADT
.
sci_öãºu±
) {

357 
	`a˝i_sci_iﬂpic_£tup
(
öt§c
->
globÆ_úq
,

358 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

359 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

363 i‡(
a˝i_skù_timî_ovîride
 &&

364 
öt§c
->
sour˚_úq
 =0 && i¡§c->
globÆ_úq
 == 2) {

365 
	`¥ötk
(
PREFIX
 "BIOS IRQ0Öin2 override ignored.\n");

369 
	`mp_ovîride_Àgacy_úq
(
öt§c
->
sour˚_úq
,

370 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

371 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

372 
öt§c
->
globÆ_úq
);

375 
	}
}

377 
__öô


378 
	$a˝i_∑r£_nmi_§c
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

380 
a˝i_madt_nmi_sour˚
 *
nmi_§c
 = 
NULL
;

382 
nmi_§c
 = (
a˝i_madt_nmi_sour˚
 *)
hódî
;

384 i‡(
	`BAD_MADT_ENTRY
(
nmi_§c
, 
íd
))

385  -
EINVAL
;

387 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

392 
	}
}

410 
__öô
 
	$a˝i_pic_sci_£t_åiggî
(
úq
, 
u16
 
åiggî
)

412 
mask
 = 1 << 
úq
;

413 
ﬁd
, 
√w
;

416 
ﬁd
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

423 
√w
 = 
a˝i_noúq
 ? 
ﬁd
 : 0;

429 
åiggî
) {

431 
√w
 &~
mask
;

434 
√w
 |
mask
;

438 i‡(
ﬁd
 =
√w
)

441 
	`¥ötk
(
PREFIX
 "£âög ELCRÅÿ%04x (‰om %04x)\n", 
√w
, 
ﬁd
);

442 
	`outb
(
√w
, 0x4d0);

443 
	`outb
(
√w
 >> 8, 0x4d1);

444 
	}
}

446 
	$a˝i_gsi_to_úq
(
u32
 
gsi
, *
úq
)

448 *
úq
 = 
gsi
;

450 
	}
}

456 
	$a˝i_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

458 
úq
;

459 
∂©_gsi
 = 
gsi
;

461 #ifde‡
CONFIG_PCI


465 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_PIC
) {

466 i‡(
åiggî
 =
ACPI_LEVEL_SENSITIVE
)

467 
	`eiß_£t_Àvñ_úq
(
gsi
);

471 #ifde‡
CONFIG_X86_IO_APIC


472 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
) {

473 
∂©_gsi
 = 
	`mp_ªgi°î_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

476 
	`a˝i_gsi_to_úq
(
∂©_gsi
, &
úq
);

477  
úq
;

478 
	}
}

483 #ifde‡
CONFIG_ACPI_HOTPLUG_CPU


485 
__˝uöô
 
	$_a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

487 
a˝i_buf„r
 
buf„r
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

488 
a˝i_obje˘
 *
obj
;

489 
a˝i_madt_loˇl_≠ic
 *
œpic
;

490 
˝umask_v¨_t
 
tmp_m≠
, 
√w_m≠
;

491 
u8
 
physid
;

492 
˝u
;

493 
ªtvÆ
 = -
ENOMEM
;

495 i‡(
	`ACPI_FAILURE
(
	`a˝i_evÆu©e_obje˘
(
h™dÀ
, "_MAT", 
NULL
, &
buf„r
)))

496  -
EINVAL
;

498 i‡(!
buf„r
.
Àngth
 || !buf„r.
poöãr
)

499  -
EINVAL
;

501 
obj
 = 
buf„r
.
poöãr
;

502 i‡(
obj
->
ty≥
 !
ACPI_TYPE_BUFFER
 ||

503 
obj
->
buf„r
.
Àngth
 < (*
œpic
)) {

504 
	`k‰ì
(
buf„r
.
poöãr
);

505  -
EINVAL
;

508 
œpic
 = (
a˝i_madt_loˇl_≠ic
 *)
obj
->
buf„r
.
poöãr
;

510 i‡(
œpic
->
hódî
.
ty≥
 !
ACPI_MADT_TYPE_LOCAL_APIC
 ||

511 !(
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
)) {

512 
	`k‰ì
(
buf„r
.
poöãr
);

513  -
EINVAL
;

516 
physid
 = 
œpic
->
id
;

518 
	`k‰ì
(
buf„r
.
poöãr
);

519 
buf„r
.
Àngth
 = 
ACPI_ALLOCATE_BUFFER
;

520 
buf„r
.
poöãr
 = 
NULL
;

522 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_m≠
, 
GFP_KERNEL
))

523 
out
;

525 i‡(!
	`Æloc_˝umask_v¨
(&
√w_m≠
, 
GFP_KERNEL
))

526 
‰ì_tmp_m≠
;

528 
	`˝umask_c›y
(
tmp_m≠
, 
˝u_¥e£¡_mask
);

529 
	`a˝i_ªgi°î_œpic
(
physid
, 
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

535 
	`˝umask_™dnŸ
(
√w_m≠
, 
˝u_¥e£¡_mask
, 
tmp_m≠
);

536 i‡(
	`˝umask_em±y
(
√w_m≠
)) {

537 
	`¥ötk
 ("UnableÅo mapÜapicÅoÜogical cpuÇumber\n");

538 
ªtvÆ
 = -
EINVAL
;

539 
‰ì_√w_m≠
;

542 
˝u
 = 
	`˝umask_fú°
(
√w_m≠
);

544 *
p˝u
 = 
˝u
;

545 
ªtvÆ
 = 0;

547 
‰ì_√w_m≠
:

548 
	`‰ì_˝umask_v¨
(
√w_m≠
);

549 
‰ì_tmp_m≠
:

550 
	`‰ì_˝umask_v¨
(
tmp_m≠
);

551 
out
:

552  
ªtvÆ
;

553 
	}
}

556 
__ªf
 
	$a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

558  
	`_a˝i_m≠_lßpic
(
h™dÀ
, 
p˝u
);

559 
	}
}

560 
EXPORT_SYMBOL
(
a˝i_m≠_lßpic
);

562 
	$a˝i_unm≠_lßpic
(
˝u
)

564 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) = -1;

565 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

566 
num_¥o˚ss‹s
--;

569 
	}
}

571 
EXPORT_SYMBOL
(
a˝i_unm≠_lßpic
);

574 
	$a˝i_ªgi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

577  -
EINVAL
;

578 
	}
}

580 
EXPORT_SYMBOL
(
a˝i_ªgi°î_iﬂpic
);

582 
	$a˝i_uƒegi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u32
 
gsi_ba£
)

585  -
EINVAL
;

586 
	}
}

588 
EXPORT_SYMBOL
(
a˝i_uƒegi°î_iﬂpic
);

590 
__öô
 
	$a˝i_∑r£_sbf
(
a˝i_èbÀ_hódî
 *
èbÀ
)

592 
a˝i_èbÀ_boŸ
 *
sb
;

594 
sb
 = (
a˝i_èbÀ_boŸ
 *)
èbÀ
;

595 i‡(!
sb
) {

596 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map SBF\n");

597  -
ENODEV
;

600 
sbf_p‹t
 = 
sb
->
cmos_ödex
;

603 
	}
}

605 #ifde‡
CONFIG_HPET_TIMER


606 
	~<asm/h≥t.h
>

608 
__öôd©a
 
ªsour˚
 *
	gh≥t_ªs
;

610 
__öô
 
	$a˝i_∑r£_h≥t
(
a˝i_èbÀ_hódî
 *
èbÀ
)

612 
a˝i_èbÀ_h≥t
 *
h≥t_tbl
;

614 
h≥t_tbl
 = (
a˝i_èbÀ_h≥t
 *)
èbÀ
;

615 i‡(!
h≥t_tbl
) {

616 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map HPET\n");

617  -
ENODEV
;

620 i‡(
h≥t_tbl
->
addªss
.
•a˚_id
 !
ACPI_SPACE_MEM
) {

621 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPETÅimers must beÜocated in "

626 
h≥t_addªss
 = 
h≥t_tbl
->
addªss
.address;

627 
h≥t_blockid
 = 
h≥t_tbl
->
£quí˚
;

633 i‡(!
h≥t_addªss
) {

634 
	`¥ötk
(
KERN_WARNING
 
PREFIX


636 
h≥t_tbl
->
id
, 
h≥t_addªss
);

639 #ifde‡
CONFIG_X86_64


645 i‡(
h≥t_addªss
 == 0xfed0000000000000UL) {

646 i‡(!
h≥t_f‹˚_u£r
) {

647 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

650 "fix iàu∞tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

651 
h≥t_addªss
 = 0;

654 
	`¥ötk
(
KERN_WARNING
 
PREFIX


656 "tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

657 
h≥t_addªss
 >>= 32;

660 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

661 
h≥t_tbl
->
id
, 
h≥t_addªss
);

667 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

668 
h≥t_ªs
 = 
	`Æloc_boŸmem
((*h≥t_ªsË+ 
HPET_RESOURCE_NAME_SIZE
);

670 
h≥t_ªs
->
«me
 = (*)&hpet_res[1];

671 
h≥t_ªs
->
Êags
 = 
IORESOURCE_MEM
;

672 
	`¢¥ötf
((*)
h≥t_ªs
->
«me
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

673 
h≥t_tbl
->
£quí˚
);

675 
h≥t_ªs
->
°¨t
 = 
h≥t_addªss
;

676 
h≥t_ªs
->
íd
 = 
h≥t_addªss
 + (1 * 1024) - 1;

679 
	}
}

685 
__öô
 
	$h≥t_ö£π_ªsour˚
()

687 i‡(!
h≥t_ªs
)

690  
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
h≥t_ªs
);

691 
	}
}

693 
œã_öôˇŒ
(
h≥t_ö£π_ªsour˚
);

696 
	#a˝i_∑r£_h≥t
 
NULL


	)

699 
__öô
 
	$a˝i_∑r£_Ádt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

702 #ifde‡
CONFIG_X86_PM_TIMER


704 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
) {

706 i‡(
a˝i_gbl_FADT
.
xpm_timî_block
.
•a˚_id
 !=

707 
ACPI_ADR_SPACE_SYSTEM_IO
)

710 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
xpm_timî_block
.
addªss
;

716 i‡(!
pmtmr_i›‹t
)

717 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

720 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

722 i‡(
pmtmr_i›‹t
)

723 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

724 
pmtmr_i›‹t
);

727 
	}
}

729 #ifdef 
CONFIG_X86_LOCAL_APIC


735 
__öô
 
	$a˝i_ªgi°î_œpic_addªss
(
addªss
)

737 
mp_œpic_addr
 = 
addªss
;

739 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
addªss
);

740 i‡(
boŸ_˝u_physiˇl_≠icid
 == -1U) {

741 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

742 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
] =

743 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

745 
	}
}

747 
__öô
 
	$óæy_a˝i_∑r£_madt_œpic_addr_ovr
()

749 
cou¡
;

751 i‡(!
˝u_has_≠ic
)

752  -
ENODEV
;

759 
cou¡
 =

760 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

761 
a˝i_∑r£_œpic_addr_ovr
, 0);

762 i‡(
cou¡
 < 0) {

763 
	`¥ötk
(
KERN_ERR
 
PREFIX


765  
cou¡
;

768 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

770  
cou¡
;

771 
	}
}

773 
__öô
 
	$a˝i_∑r£_madt_œpic_íåõs
()

775 
cou¡
;

776 
x2cou¡
 = 0;

778 i‡(!
˝u_has_≠ic
)

779  -
ENODEV
;

786 
cou¡
 =

787 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

788 
a˝i_∑r£_œpic_addr_ovr
, 0);

789 i‡(
cou¡
 < 0) {

790 
	`¥ötk
(
KERN_ERR
 
PREFIX


792  
cou¡
;

795 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

797 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

798 
a˝i_∑r£_ßpic
, 
MAX_APICS
);

800 i‡(!
cou¡
) {

801 
x2cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

802 
a˝i_∑r£_x2≠ic
, 
MAX_APICS
);

803 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

804 
a˝i_∑r£_œpic
, 
MAX_APICS
);

806 i‡(!
cou¡
 && !
x2cou¡
) {

807 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No LAPICÉntriesÖresent\n");

809  -
ENODEV
;

810 } i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

811 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPICÉntry\n");

813  
cou¡
;

816 
x2cou¡
 =

817 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

818 
a˝i_∑r£_x2≠ic_nmi
, 0);

819 
cou¡
 =

820 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
a˝i_∑r£_œpic_nmi
, 0);

821 i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

822 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPIC NMIÉntry\n");

824  
cou¡
;

827 
	}
}

830 #ifdef 
CONFIG_X86_IO_APIC


831 
	#MP_ISA_BUS
 0

	)

833 #ifde‡
CONFIG_X86_ES7000


834 
es7000_∂©
;

837 
__öô
 
	$a˝i_¥obe_gsi
()

839 
idx
;

840 
gsi
;

841 
max_gsi
 = 0;

843 i‡(
a˝i_dißbÀd
)

846 i‡(!
a˝i_iﬂpic
)

849 
max_gsi
 = 0;

850 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++) {

851 
gsi
 = 
mp_gsi_routög
[
idx
].
gsi_íd
;

853 i‡(
gsi
 > 
max_gsi
)

854 
max_gsi
 = 
gsi
;

857  
max_gsi
 + 1;

858 
	}
}

860 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

861 
mpc_öt§c
 *
mp_úq
)

863 
	`mem˝y
(
mp_úq
, 
m
, (
mpc_öt§c
));

864 
	}
}

866 
	$mp_úq_cmp
(
mpc_öt§c
 *
mp_úq
,

867 
mpc_öt§c
 *
m
)

869  
	`memcmp
(
mp_úq
, 
m
, (
mpc_öt§c
));

870 
	}
}

872 
	$ßve_mp_úq
(
mpc_öt§c
 *
m
)

874 
i
;

876 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

877 i‡(!
	`mp_úq_cmp
(&
mp_úqs
[
i
], 
m
))

881 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

882 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

883 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

884 
	}
}

886 
__öô
 
	$mp_ovîride_Àgacy_úq
(
u8
 
bus_úq
, u8 
pﬁ¨ôy
, u8 
åiggî
, 
u32
 
gsi
)

888 
iﬂpic
;

889 
pö
;

890 
mpc_öt§c
 
mp_úq
;

895 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

896 i‡(
iﬂpic
 < 0)

898 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

905 i‡((
bus_úq
 =0Ë&& (
åiggî
 == 3))

906 
åiggî
 = 1;

908 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

909 
mp_úq
.
úqty≥
 = 
mp_INT
;

910 
mp_úq
.
úqÊag
 = (
åiggî
 << 2Ë| 
pﬁ¨ôy
;

911 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

912 
mp_úq
.
§cbusúq
 = 
bus_úq
;

913 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

914 
mp_úq
.
d°úq
 = 
pö
;

916 
	`ßve_mp_úq
(&
mp_úq
);

917 
	}
}

919 
__öô
 
	$mp_c⁄fig_a˝i_Àgacy_úqs
()

921 
i
;

922 
iﬂpic
;

923 
d°≠ic
;

924 
mpc_öt§c
 
mp_úq
;

926 #i‡
	`deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

930 
mp_bus_id_to_ty≥
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

932 
	`£t_bô
(
MP_ISA_BUS
, 
mp_bus_nŸ_pci
);

933 
	`¥_debug
("Bu†#%d i†ISA\n", 
MP_ISA_BUS
);

935 #ifde‡
CONFIG_X86_ES7000


939 i‡(
es7000_∂©
 == 1)

946 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

947 i‡(
iﬂpic
 < 0)

949 
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

955 
i
 = 0; i < 16; i++) {

956 
idx
;

958 
idx
 = 0; idx < 
mp_úq_íåõs
; idx++) {

959 
mpc_öt§c
 *
úq
 = 
mp_úqs
 + 
idx
;

962 i‡(
úq
->
§cbus
 =
MP_ISA_BUS
 && irq->
§cbusúq
 =
i
)

966 i‡(
úq
->
d°≠ic
 =d°≠i¯&& irq->
d°úq
 =
i
)

970 i‡(
idx
 !
mp_úq_íåõs
) {

971 
	`¥ötk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ovîride.\n", 
i
);

975 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

976 
mp_úq
.
úqÊag
 = 0;

977 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

978 
mp_úq
.
d°≠ic
 = dstapic;

979 
mp_úq
.
úqty≥
 = 
mp_INT
;

980 
mp_úq
.
§cbusúq
 = 
i
;

981 
mp_úq
.
d°úq
 = 
i
;

983 
	`ßve_mp_úq
(&
mp_úq
);

985 
	}
}

987 
	$mp_c⁄fig_a˝i_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
,

988 
pﬁ¨ôy
)

990 #ifde‡
CONFIG_X86_MPPARSE


991 
mpc_öt§c
 
mp_úq
;

992 
pci_dev
 *
pdev
;

993 
numbî
;

994 
dev‚
;

995 
iﬂpic
;

996 
u8
 
pö
;

998 i‡(!
a˝i_iﬂpic
)

1000 i‡(!
dev
)

1002 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1005 
pdev
 = 
	`to_pci_dev
(
dev
);

1006 
numbî
 = 
pdev
->
bus
->number;

1007 
dev‚
 = 
pdev
->devfn;

1008 
pö
 = 
pdev
->pin;

1010 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1011 
mp_úq
.
úqty≥
 = 
mp_INT
;

1012 
mp_úq
.
úqÊag
 = (
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1013 (
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1014 
mp_úq
.
§cbus
 = 
numbî
;

1015 
mp_úq
.
§cbusúq
 = (((
dev‚
 >> 3Ë& 0x1fË<< 2Ë| ((
pö
 - 1) & 3);

1016 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1017 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1018 
mp_úq
.
d°úq
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1020 
	`ßve_mp_úq
(&
mp_úq
);

1023 
	}
}

1025 
	$mp_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

1027 
iﬂpic
;

1028 
iﬂpic_pö
;

1029 
io_≠ic_úq_©å
 
úq_©å
;

1031 i‡(
a˝i_úq_modñ
 !
ACPI_IRQ_MODEL_IOAPIC
)

1032  
gsi
;

1035 i‡(
a˝i_gbl_FADT
.
sci_öãºu±
 =
gsi
)

1036  
gsi
;

1038 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1039 i‡(
iﬂpic
 < 0) {

1040 
	`¥ötk
(
KERN_WARNING
 "NÿIOAPIC f‹ GSI %u\n", 
gsi
);

1041  
gsi
;

1044 
iﬂpic_pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1046 #ifde‡
CONFIG_X86_32


1047 i‡(
iﬂpic_ªnumbî_úq
)

1048 
gsi
 = 
	`iﬂpic_ªnumbî_úq
(
iﬂpic
, gsi);

1051 i‡(
iﬂpic_pö
 > 
MP_MAX_IOAPIC_PIN
) {

1052 
	`¥ötk
(
KERN_ERR
 "InvalidÑeferenceÅo IOAPICÖin "

1053 "%d-%d\n", 
mp_iﬂpics
[
iﬂpic
].
≠icid
,

1054 
iﬂpic_pö
);

1055  
gsi
;

1058 i‡(
íabÀ_upd©e_m±abÀ
)

1059 
	`mp_c⁄fig_a˝i_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

1061 
	`£t_io_≠ic_úq_©å
(&
úq_©å
, 
iﬂpic
, 
iﬂpic_pö
,

1062 
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1063 
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1064 
	`io_≠ic_£t_pci_routög
(
dev
, 
gsi
, &
úq_©å
);

1066  
gsi
;

1067 
	}
}

1073 
__öô
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1075 
cou¡
;

1083 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
)

1084  -
ENODEV
;

1086 i‡(!
˝u_has_≠ic
)

1087  -
ENODEV
;

1092 i‡(
skù_iﬂpic_£tup
) {

1093 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPICÖrobe "

1095  -
ENODEV
;

1098 
cou¡
 =

1099 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
a˝i_∑r£_iﬂpic
,

1100 
MAX_IO_APICS
);

1101 i‡(!
cou¡
) {

1102 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No IOAPICÉntriesÖresent\n");

1103  -
ENODEV
;

1104 } i‡(
cou¡
 < 0) {

1105 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing IOAPICÉntry\n");

1106  
cou¡
;

1109 
cou¡
 =

1110 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
a˝i_∑r£_öt_§c_ovr
,

1111 
ƒ_úqs
);

1112 i‡(
cou¡
 < 0) {

1113 
	`¥ötk
(
KERN_ERR
 
PREFIX


1116  
cou¡
;

1123 i‡(!
a˝i_sci_ovîride_gsi
)

1124 
	`a˝i_sci_iﬂpic_£tup
(
a˝i_gbl_FADT
.
sci_öãºu±
, 0, 0);

1127 
	`mp_c⁄fig_a˝i_Àgacy_úqs
();

1129 
cou¡
 =

1130 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
a˝i_∑r£_nmi_§c
,

1131 
ƒ_úqs
);

1132 i‡(
cou¡
 < 0) {

1133 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing NMI SRCÉntry\n");

1135  
cou¡
;

1139 
	}
}

1141 
ölöe
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1144 
	}
}

1147 
__öô
 
	$óæy_a˝i_¥o˚ss_madt
()

1149 #ifde‡
CONFIG_X86_LOCAL_APIC


1150 
îr‹
;

1152 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1157 
îr‹
 = 
	`óæy_a˝i_∑r£_madt_œpic_addr_ovr
();

1158 i‡(!
îr‹
) {

1159 
a˝i_œpic
 = 1;

1160 
smp_found_c⁄fig
 = 1;

1162 i‡(
îr‹
 =-
EINVAL
) {

1166 
	`¥ötk
(
KERN_ERR
 
PREFIX


1168 
	`dißbÀ_a˝i
();

1172 
	}
}

1174 
__öô
 
	$a˝i_¥o˚ss_madt
()

1176 #ifde‡
CONFIG_X86_LOCAL_APIC


1177 
îr‹
;

1179 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1184 
îr‹
 = 
	`a˝i_∑r£_madt_œpic_íåõs
();

1185 i‡(!
îr‹
) {

1186 
a˝i_œpic
 = 1;

1191 
îr‹
 = 
	`a˝i_∑r£_madt_iﬂpic_íåõs
();

1192 i‡(!
îr‹
) {

1193 
a˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1194 
a˝i_iﬂpic
 = 1;

1196 
smp_found_c⁄fig
 = 1;

1199 i‡(
îr‹
 =-
EINVAL
) {

1203 
	`¥ötk
(
KERN_ERR
 
PREFIX


1205 
	`dißbÀ_a˝i
();

1213 i‡(
smp_found_c⁄fig
) {

1214 
	`¥ötk
(
KERN_WARNING
 
PREFIX


1216 
smp_found_c⁄fig
 = 0;

1224 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

1225 
	`¥ötk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1227 i‡(
a˝i_œpic
)

1228 
	`¥ötk
(
KERN_INFO
 "Using ACPI forÖrocessor (LAPIC) "

1232 
	}
}

1234 
__öô
 
	$dißbÀ_a˝i_úq
(c⁄° 
dmi_sy°em_id
 *
d
)

1236 i‡(!
a˝i_f‹˚
) {

1237 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=noirq\n",

1238 
d
->
idít
);

1239 
	`a˝i_noúq_£t
();

1242 
	}
}

1244 
__öô
 
	$dißbÀ_a˝i_pci
(c⁄° 
dmi_sy°em_id
 *
d
)

1246 i‡(!
a˝i_f‹˚
) {

1247 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofÖci=noacpi\n",

1248 
d
->
idít
);

1249 
	`a˝i_dißbÀ_pci
();

1252 
	}
}

1254 
__öô
 
	$dmi_dißbÀ_a˝i
(c⁄° 
dmi_sy°em_id
 *
d
)

1256 i‡(!
a˝i_f‹˚
) {

1257 
	`¥ötk
(
KERN_NOTICE
 "%†dëe˘ed:á˝òoff\n", 
d
->
idít
);

1258 
	`dißbÀ_a˝i
();

1260 
	`¥ötk
(
KERN_NOTICE


1264 
	}
}

1269 
__öô
 
	$f‹˚_a˝i_ht
(c⁄° 
dmi_sy°em_id
 *
d
)

1271 i‡(!
a˝i_f‹˚
) {

1272 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=ht\n",

1273 
d
->
idít
);

1274 
	`dißbÀ_a˝i
();

1275 
a˝i_ht
 = 1;

1277 
	`¥ötk
(
KERN_NOTICE


1281 
	}
}

1286 
__öô
 
	$dmi_ign‹e_úq0_timî_ovîride
(c⁄° 
dmi_sy°em_id
 *
d
)

1292 i‡(!
a˝i_skù_timî_ovîride
) {

1293 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirkÇot complete.\n");

1294 
	`¥_nŸi˚
("%s detected: Ignoring BIOS IRQ0Öin2 override\n",

1295 
d
->
idít
);

1296 
a˝i_skù_timî_ovîride
 = 1;

1299 
	}
}

1305 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ
[] = {

1310 .
ˇŒback
 = 
dmi_dißbÀ_a˝i
,

1311 .
	gidít
 = "IBM Thinkpad",

1312 .
	gm©ches
 = {

1313 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1314 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1322 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1323 .
	gidít
 = "FSC Primergy T850",

1324 .
	gm©ches
 = {

1325 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

1326 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

1330 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1331 .
	gidít
 = "HP VISUALIZE NT Workstation",

1332 .
	gm©ches
 = {

1333 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

1334 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

1338 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1339 .
	gidít
 = "Compaq Workstation W8000",

1340 .
	gm©ches
 = {

1341 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

1342 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

1346 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1347 .
	gidít
 = "ASUS CUR-DLS",

1348 .
	gm©ches
 = {

1349 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1350 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

1354 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1355 .
	gidít
 = "ABIT i440BX-W83977",

1356 .
	gm©ches
 = {

1357 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

1358 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

1362 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1363 .
	gidít
 = "IBM Bladecenter",

1364 .
	gm©ches
 = {

1365 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1366 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMÉServer BladeCenter HS20"),

1370 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1371 .
	gidít
 = "IBMÉServer xSeries 360",

1372 .
	gm©ches
 = {

1373 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1374 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

1378 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1379 .
	gidít
 = "IBMÉserver xSeries 330",

1380 .
	gm©ches
 = {

1381 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1382 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

1386 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1387 .
	gidít
 = "IBMÉserver xSeries 440",

1388 .
	gm©ches
 = {

1389 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1390 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

1398 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1399 .
	gidít
 = "ASUS A7V",

1400 .
	gm©ches
 = {

1401 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1402 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1404 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1415 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1416 .
	gidít
 = "IBM Thinkpad 600 Series 2645",

1417 .
	gm©ches
 = {

1418 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1419 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1423 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1424 .
	gidít
 = "IBM Thinkpad 600 Series 2646",

1425 .
	gm©ches
 = {

1426 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1427 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1434 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1435 .
	gidít
 = "ASUS PR-DLS",

1436 .
	gm©ches
 = {

1437 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1438 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1439 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1441 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1445 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1446 .
	gidít
 = "Acer TravelMate 36x Laptop",

1447 .
	gm©ches
 = {

1448 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1449 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1456 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ_œã
[] = {

1468 .
ˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1469 .
	gidít
 = "HPÇx6115Üaptop",

1470 .
	gm©ches
 = {

1471 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1472 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6115"),

1476 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1477 .
	gidít
 = "HP NX6125Üaptop",

1478 .
	gm©ches
 = {

1479 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1480 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6125"),

1484 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1485 .
	gidít
 = "HP NX6325Üaptop",

1486 .
	gm©ches
 = {

1487 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1488 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6325"),

1492 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1493 .
	gidít
 = "HP 6715bÜaptop",

1494 .
	gm©ches
 = {

1495 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1496 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1521 
__öô
 
	$a˝i_boŸ_èbÀ_öô
()

1523 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ
);

1529 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1535 i‡(
	`a˝i_èbÀ_öô
()) {

1536 
	`dißbÀ_a˝i
();

1540 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1545 i‡(
	`a˝i_bœckli°ed
()) {

1546 i‡(
a˝i_f‹˚
) {

1547 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1549 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1550 
	`dißbÀ_a˝i
();

1554 
	}
}

1556 
__öô
 
	$óæy_a˝i_boŸ_öô
()

1562 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1568 
	`óæy_a˝i_¥o˚ss_madt
();

1571 
	}
}

1573 
__öô
 
	$a˝i_boŸ_öô
()

1576 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ_œã
);

1582 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1585 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1590 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_FADT
, 
a˝i_∑r£_Ádt
);

1595 
	`a˝i_¥o˚ss_madt
();

1597 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
a˝i_∑r£_h≥t
);

1600 
	}
}

1602 
__öô
 
	$∑r£_a˝i
(*
¨g
)

1604 i‡(!
¨g
)

1605  -
EINVAL
;

1608 i‡(
	`°rcmp
(
¨g
, "off") == 0) {

1609 
	`dißbÀ_a˝i
();

1612 i‡(
	`°rcmp
(
¨g
, "force") == 0) {

1613 
a˝i_f‹˚
 = 1;

1614 
a˝i_ht
 = 1;

1615 
a˝i_dißbÀd
 = 0;

1618 i‡(
	`°rcmp
(
¨g
, "strict") == 0) {

1619 
a˝i_°ri˘
 = 1;

1622 i‡(
	`°rcmp
(
¨g
, "ht") == 0) {

1623 i‡(!
a˝i_f‹˚
)

1624 
	`dißbÀ_a˝i
();

1625 
a˝i_ht
 = 1;

1628 i‡(
	`°rcmp
(
¨g
, "rsdt") == 0) {

1629 
a˝i_rsdt_f‹˚d
 = 1;

1632 i‡(
	`°rcmp
(
¨g
, "noirq") == 0) {

1633 
	`a˝i_noúq_£t
();

1636  -
EINVAL
;

1639 
	}
}

1640 
óæy_∑øm
("a˝i", 
∑r£_a˝i
);

1643 
__öô
 
	$∑r£_pci
(*
¨g
)

1645 i‡(
¨g
 && 
	`°rcmp
(arg, "noacpi") == 0)

1646 
	`a˝i_dißbÀ_pci
();

1648 
	}
}

1649 
óæy_∑øm
("pci", 
∑r£_pci
);

1651 
__öô
 
	$a˝i_mps_check
()

1653 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& !deföed(
CONFIG_X86_MPPARSE
)

1655 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1656 
	`¥ötk
(
KERN_WARNING
 "MPS support code isÇot built-in.\n"

1663 
	}
}

1665 #ifde‡
CONFIG_X86_IO_APIC


1666 
__öô
 
	$∑r£_a˝i_skù_timî_ovîride
(*
¨g
)

1668 
a˝i_skù_timî_ovîride
 = 1;

1670 
	}
}

1671 
óæy_∑øm
("a˝i_skù_timî_ovîride", 
∑r£_a˝i_skù_timî_ovîride
);

1673 
__öô
 
	$∑r£_a˝i_u£_timî_ovîride
(*
¨g
)

1675 
a˝i_u£_timî_ovîride
 = 1;

1677 
	}
}

1678 
óæy_∑øm
("a˝i_u£_timî_ovîride", 
∑r£_a˝i_u£_timî_ovîride
);

1681 
__öô
 
	$£tup_a˝i_sci
(*
s
)

1683 i‡(!
s
)

1684  -
EINVAL
;

1685 i‡(!
	`°rcmp
(
s
, "edge"))

1686 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1687 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1688 i‡(!
	`°rcmp
(
s
, "level"))

1689 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1690 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1691 i‡(!
	`°rcmp
(
s
, "high"))

1692 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1693 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1694 i‡(!
	`°rcmp
(
s
, "low"))

1695 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1696 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1698  -
EINVAL
;

1700 
	}
}

1701 
óæy_∑øm
("a˝i_sci", 
£tup_a˝i_sci
);

1703 
	$__a˝i_acquúe_globÆ_lock
(*
lock
)

1705 
ﬁd
, 
√w
, 
vÆ
;

1707 
ﬁd
 = *
lock
;

1708 
√w
 = (((
ﬁd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1709 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1710 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1711  (
√w
 < 3) ? -1 : 0;

1712 
	}
}

1714 
	$__a˝i_ªÀa£_globÆ_lock
(*
lock
)

1716 
ﬁd
, 
√w
, 
vÆ
;

1718 
ﬁd
 = *
lock
;

1719 
√w
 = 
ﬁd
 & ~0x3;

1720 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1721 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1722  
ﬁd
 & 0x1;

1723 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/sched.h
>

14 
	~<a˝i/¥o˚ss‹.h
>

15 
	~<asm/a˝i.h
>

27 
	$a˝i_¥o˚ss‹_powî_öô_bm_check
(
a˝i_¥o˚ss‹_Êags
 *
Êags
,

28 
˝u
)

30 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

32 
Êags
->
bm_check
 = 0;

33 i‡(
	`num_⁄löe_˝us
() == 1)

34 
Êags
->
bm_check
 = 1;

35 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

41 
Êags
->
bm_check
 = 1;

50 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

51 (
c
->
x86
 > 0x‡|| (c->x86 =6 && c->
x86_modñ
 >= 0x0f)))

52 
Êags
->
bm_c⁄åﬁ
 = 0;

53 
	}
}

54 
EXPORT_SYMBOL
(
a˝i_¥o˚ss‹_powî_öô_bm_check
);

58 
	sc°©e_íåy
 {

60 
	móx
;

61 
	mecx
;

62 } 
	m°©es
[
ACPI_PROCESSOR_MAX_POWER
];

64 
c°©e_íåy
 *
	g˝u_c°©e_íåy
;

66 
	gmwaô_suµ‹ãd
[
ACPI_PROCESSOR_MAX_POWER
];

68 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

69 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

70 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

72 
	#CPUID_MWAIT_LEAF
 (5)

	)

73 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

74 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

76 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

78 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

80 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
(*
_cx
)

82 
a˝i_¥o˚ss‹_cx
 *
cx
 = 
_cx
;

83 
ªtvÆ
;

84 
óx
, 
ebx
, 
ecx
, 
edx
;

85 
edx_∑π
;

86 
c°©e_ty≥
;

87 
num_c°©e_subty≥
;

89 
	`˝uid
(
CPUID_MWAIT_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
c°©e_ty≥
 = ((
cx
->
addªss
 >> 
MWAIT_SUBSTATE_SIZE
) &

93 
MWAIT_CSTATE_MASK
) + 1;

94 
edx_∑π
 = 
edx
 >> (
c°©e_ty≥
 * 
MWAIT_SUBSTATE_SIZE
);

95 
num_c°©e_subty≥
 = 
edx_∑π
 & 
MWAIT_SUBSTATE_MASK
;

97 
ªtvÆ
 = 0;

98 i‡(
num_c°©e_subty≥
 < (
cx
->
addªss
 & 
MWAIT_SUBSTATE_MASK
)) {

99 
ªtvÆ
 = -1;

100 
out
;

104 i‡(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

105 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

106 
ªtvÆ
 = -1;

107 
out
;

110 i‡(!
mwaô_suµ‹ãd
[
c°©e_ty≥
]) {

111 
mwaô_suµ‹ãd
[
c°©e_ty≥
] = 1;

112 
	`¥ötk
(
KERN_DEBUG


114 "°©e\n", 
cx
->
ty≥
);

116 
	`¢¥ötf
(
cx
->
desc
,

117 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

118 
cx
->
addªss
);

119 
out
:

120  
ªtvÆ
;

121 
	}
}

123 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe
(
˝u
,

124 
a˝i_¥o˚ss‹_cx
 *
cx
, 
a˝i_powî_ªgi°î
 *
ªg
)

126 
c°©e_íåy
 *
≥r˝u_íåy
;

127 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

128 
ªtvÆ
;

130 i‡(!
˝u_c°©e_íåy
 || 
c
->
˝uid_Àvñ
 < 
CPUID_MWAIT_LEAF
)

133 i‡(
ªg
->
bô_off£t
 !
NATIVE_CSTATE_BEYOND_HALT
)

136 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

137 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = 0;

138 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 0;

142 
ªtvÆ
 = 
	`w‹k_⁄_˝u
(
˝u
, 
a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
, 
cx
);

143 i‡(
ªtvÆ
 == 0) {

145 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = cx->
addªss
;

146 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

148  
ªtvÆ
;

149 
	}
}

150 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_¥obe
);

152 
	$a˝i_¥o˚ss‹_ffh_c°©e_íãr
(
a˝i_¥o˚ss‹_cx
 *
cx
)

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
c°©e_íåy
 *
≥r˝u_íåy
;

157 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

158 
	`mwaô_idÀ_wôh_höts
(
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
,

159 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
);

160 
	}
}

161 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_íãr
);

163 
__öô
 
	$ffh_c°©e_öô
()

165 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

166 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
)

169 
˝u_c°©e_íåy
 = 
	`Æloc_≥r˝u
(
c°©e_íåy
);

171 
	}
}

173 
__exô
 
	$ffh_c°©e_exô
()

175 
	`‰ì_≥r˝u
(
˝u_c°©e_íåy
);

176 
˝u_c°©e_íåy
 = 
NULL
;

177 
	}
}

179 
¨ch_öôˇŒ
(
ffh_c°©e_öô
);

180 
__exôˇŒ
(
ffh_c°©e_exô
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c

1 
	~"../../../boŸ/ªgs.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boŸ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boŸ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boŸ/video-veß.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boŸ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boŸ.h
"

4 
	$udñay
(
lo›s
)

6 
lo›s
--)

7 
	`io_dñay
();

8 
	}
}

10 
	$bìp
(
hz
)

12 
u8
 
íabÀ
;

14 i‡(!
hz
) {

15 
íabÀ
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_dñay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_dñay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_dñay
();

26 
íabÀ
 = 0x03;

28 
	`öb
(0x61);

29 
	`io_dñay
();

30 
	`outb
(
íabÀ
, 0x61);

31 
	`io_dñay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_m‹£
(c⁄° *
∑âîn
)

41 
s
;

43 (
s
 = *
∑âîn
++)) {

44 
s
) {

46 
	`bìp
(
DOT_HZ
);

47 
	`udñay
(
US_PER_DOT
);

48 
	`bìp
(0);

49 
	`udñay
(
US_PER_DOT
);

52 
	`bìp
(
DASH_HZ
);

53 
	`udñay
(
US_PER_DOT
 * 3);

54 
	`bìp
(0);

55 
	`udñay
(
US_PER_DOT
);

58 
	`udñay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maö
()

67 i‡(
wakeup_hódî
.
ªÆ_magic
 != 0x12345678)

70 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 4)

71 
	`£nd_m‹£
("...-");

73 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 2) {

78 
	`¥obe_ˇrds
(0);

79 
	`£t_mode
(
wakeup_hódî
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<löux/a˝i.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/dmi.h
>

11 
	~<löux/˝umask.h
>

12 
	~<asm/£gmít.h
>

13 
	~<asm/desc.h
>

15 
	~"ªÆmode/wakeup.h
"

16 
	~"¶ìp.h
"

18 
	ga˝i_wakeup_addªss
;

19 
	ga˝i_ªÆmode_Êags
;

22 
	ga˝i_ªÆmode
;

24 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_64BIT
)

25 
	gãmp_°ack
[4096];

36 
	$a˝i_ßve_°©e_mem
()

38 
wakeup_hódî
 *
hódî
;

40 i‡(!
a˝i_ªÆmode
) {

41 
	`¥ötk
(
KERN_ERR
 "CouldÇotállocate memory during boot, "

43  -
ENOMEM
;

45 
	`mem˝y
((*)
a˝i_ªÆmode
, &
wakeup_code_°¨t
, 
WAKEUP_SIZE
);

47 
hódî
 = (
wakeup_hódî
 *)(
a˝i_ªÆmode
 + 
HEADER_OFFSET
);

48 i‡(
hódî
->
sig«tuª
 != 0x51ee1111) {

49 
	`¥ötk
(
KERN_ERR
 "wakeup header doesÇot match\n");

50  -
EINVAL
;

53 
hódî
->
video_mode
 = 
ßved_video_mode
;

55 
hódî
->
wakeup_jmp_£g
 = 
a˝i_wakeup_addªss
 >> 4;

66 
hódî
->
wakeup_gdt
[0] =

67 (
u64
)((
hódî
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
a˝i_wakeup_addªss
 +

69 ((*)&
hódî
->
wakeup_gdt
 - (*)
a˝i_ªÆmode
))

72 
hódî
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
a˝i_wakeup_addªss
, 0xfffff);

75 
hódî
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
a˝i_wakeup_addªss
, 0xfffff);

78 #i‚de‡
CONFIG_64BIT


79 
	`°‹e_gdt
((
desc_±r
 *)&
hódî
->
pmode_gdt
);

81 i‡(
	`rdm§_ß„
(
MSR_EFER
, &
hódî
->
pmode_e„r_low
,

82 &
hódî
->
pmode_e„r_high
))

83 
hódî
->
pmode_e„r_low
 = hódî->
pmode_e„r_high
 = 0;

86 
hódî
->
pmode_¸0
 = 
	`ªad_¸0
();

87 
hódî
->
pmode_¸4
 = 
	`ªad_¸4_ß„
();

88 
hódî
->
ªÆmode_Êags
 = 
a˝i_ªÆmode_Êags
;

89 
hódî
->
ªÆ_magic
 = 0x12345678;

91 #i‚de‡
CONFIG_64BIT


92 
hódî
->
pmode_íåy
 = (
u32
)&
wakeup_pmode_ªtu∫
;

93 
hódî
->
pmode_¸3
 = (
u32
)(
swsu•_pg_dú
 - 
__PAGE_OFFSET
);

94 
ßved_magic
 = 0x12345678;

96 
hódî
->
åampﬁöe_£gmít
 = 
	`£tup_åampﬁöe
() >> 4;

97 #ifde‡
CONFIG_SMP


98 
°ack_°¨t
.
•
 = 
ãmp_°ack
 + (temp_stack);

99 
óæy_gdt_des¸
.
addªss
 =

100 ()
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

101 
öôül_gs
 = 
	`≥r_˝u_off£t
(
	`smp_¥o˚ss‹_id
());

103 
öôül_code
 = ()
wakeup_l⁄g64
;

104 
ßved_magic
 = 0x123456789abcdef0L;

108 
	}
}

113 
	$a˝i_ª°‹e_°©e_mem
()

115 
	}
}

126 
__öô
 
	$a˝i_ª£rve_wakeup_mem‹y
()

128 
mem
;

130 i‡((&
wakeup_code_íd
 - &
wakeup_code_°¨t
Ë> 
WAKEUP_SIZE
) {

131 
	`¥ötk
(
KERN_ERR


136 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
WAKEUP_SIZE
, 
PAGE_SIZE
);

138 i‡(
mem
 == -1L) {

139 
	`¥ötk
(
KERN_ERR
 "ACPI: CannotállocateÜowmem, S3 disabled.\n");

142 
a˝i_ªÆmode
 = (Ë
	`phys_to_vút
(
mem
);

143 
a˝i_wakeup_addªss
 = 
mem
;

144 
	`ª£rve_óæy
(
mem
, mem + 
WAKEUP_SIZE
, "ACPI WAKEUP");

145 
	}
}

148 
__öô
 
	$a˝i_¶ìp_£tup
(*
°r
)

150 (
°r
 !
NULL
) && (*str != '\0')) {

151 i‡(
	`°∫cmp
(
°r
, "s3_bios", 7) == 0)

152 
a˝i_ªÆmode_Êags
 |= 1;

153 i‡(
	`°∫cmp
(
°r
, "s3_mode", 7) == 0)

154 
a˝i_ªÆmode_Êags
 |= 2;

155 i‡(
	`°∫cmp
(
°r
, "s3_beep", 7) == 0)

156 
a˝i_ªÆmode_Êags
 |= 4;

157 #ifde‡
CONFIG_HIBERNATION


158 i‡(
	`°∫cmp
(
°r
, "s4_nohwsig", 10) == 0)

159 
	`a˝i_no_s4_hw_sig«tuª
();

160 i‡(
	`°∫cmp
(
°r
, "s4_nonvs", 8) == 0)

161 
	`a˝i_s4_no_nvs
();

163 i‡(
	`°∫cmp
(
°r
, "old_ordering", 12) == 0)

164 
	`a˝i_ﬁd_su•íd_‹dîög
();

165 i‡(
	`°∫cmp
(
°r
, "sci_force_enable", 16) == 0)

166 
	`a˝i_£t_sci_í_⁄_ªsume
();

167 
°r
 = 
	`°rchr
(str, ',');

168 i‡(
°r
 !
NULL
)

169 
°r
 +
	`°r•n
(str, ", \t");

172 
	}
}

174 
__£tup
("a˝i_¶ìp=", 
a˝i_¶ìp_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/muãx.h
>

4 
	~<löux/li°.h
>

5 
	~<löux/°rögify.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/mm.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~<löux/mem‹y.h
>

10 
	~<asm/Æã∫©ive.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/pgèbÀ.h
>

13 
	~<asm/m˚.h
>

14 
	~<asm/nmi.h
>

15 
	~<asm/vsysˇŒ.h
>

16 
	~<asm/ˇcheÊush.h
>

17 
	~<asm/ébÊush.h
>

18 
	~<asm/io.h
>

19 
	~<asm/fixm≠.h
>

21 
	#MAX_PATCH_LEN
 (255-1)

	)

23 #ifde‡
CONFIG_HOTPLUG_CPU


24 
	gsmp_Æt_⁄˚
;

26 
__öô
 
	$boŸ⁄ly
(*
°r
)

28 
smp_Æt_⁄˚
 = 1;

30 
	}
}

31 
__£tup
("smp-Æt-boŸ", 
boŸ⁄ly
);

33 
	#smp_Æt_⁄˚
 1

	)

36 
__öôd©a_‹_moduÀ
 
	gdebug_Æã∫©ive
;

38 
__öô
 
	$debug_Æt
(*
°r
)

40 
debug_Æã∫©ive
 = 1;

42 
	}
}

43 
__£tup
("debug-Æã∫©ive", 
debug_Æt
);

45 
	gn‹ïœ˚_smp
;

47 
__öô
 
	$£tup_n‹ïœ˚_smp
(*
°r
)

49 
n‹ïœ˚_smp
 = 1;

51 
	}
}

52 
__£tup
("n‹ïœ˚-smp", 
£tup_n‹ïœ˚_smp
);

54 #ifde‡
CONFIG_PARAVIRT


55 
__öôd©a_‹_moduÀ
 
	gn‹ïœ˚_∑øvút
 = 0;

57 
__öô
 
	$£tup_n‹ïœ˚_∑øvút
(*
°r
)

59 
n‹ïœ˚_∑øvút
 = 1;

61 
	}
}

62 
__£tup
("n‹ïœ˚-∑øvút", 
£tup_n‹ïœ˚_∑øvút
);

65 
	#DPRINTK
(
fmt
, 
¨gs
...Ëi‡(
debug_Æã∫©ive
) \

66 
	`¥ötk
(
KERN_DEBUG
 
fmt
, 
¨gs
)

	)

68 #i‡
deföed
(
GENERIC_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

72 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nintelnops: "

73 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


74 
GENERIC_NOP7
 
GENERIC_NOP8


76 c⁄° 
öã ›s
[];

77 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


78 
	göãl_n›s
[
ASM_NOP_MAX
+1] = {

79 
NULL
,

80 
öã ›s
,

81 
öã ›s
 + 1,

82 
öã ›s
 + 1 + 2,

83 
öã ›s
 + 1 + 2 + 3,

84 
öã ›s
 + 1 + 2 + 3 + 4,

85 
öã ›s
 + 1 + 2 + 3 + 4 + 5,

86 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6,

87 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

91 #ifde‡
K8_NOP1


92 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk8nops: "

93 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


94 
K8_NOP7
 
K8_NOP8


96 c⁄° 
k8n›s
[];

97 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


98 
	gk8_n›s
[
ASM_NOP_MAX
+1] = {

99 
NULL
,

100 
k8n›s
,

101 
k8n›s
 + 1,

102 
k8n›s
 + 1 + 2,

103 
k8n›s
 + 1 + 2 + 3,

104 
k8n›s
 + 1 + 2 + 3 + 4,

105 
k8n›s
 + 1 + 2 + 3 + 4 + 5,

106 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

107 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

111 #i‡
deföed
(
K7_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

112 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk7nops: "

113 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


114 
K7_NOP7
 
K7_NOP8


116 c⁄° 
k7n›s
[];

117 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


118 
	gk7_n›s
[
ASM_NOP_MAX
+1] = {

119 
NULL
,

120 
k7n›s
,

121 
k7n›s
 + 1,

122 
k7n›s
 + 1 + 2,

123 
k7n›s
 + 1 + 2 + 3,

124 
k7n›s
 + 1 + 2 + 3 + 4,

125 
k7n›s
 + 1 + 2 + 3 + 4 + 5,

126 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

127 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

131 #ifde‡
P6_NOP1


132 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\np6nops: "

133 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


134 
P6_NOP7
 
P6_NOP8


136 c⁄° 
p6n›s
[];

137 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


138 
	gp6_n›s
[
ASM_NOP_MAX
+1] = {

139 
NULL
,

140 
p6n›s
,

141 
p6n›s
 + 1,

142 
p6n›s
 + 1 + 2,

143 
p6n›s
 + 1 + 2 + 3,

144 
p6n›s
 + 1 + 2 + 3 + 4,

145 
p6n›s
 + 1 + 2 + 3 + 4 + 5,

146 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

147 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

151 #ifde‡
CONFIG_X86_64


153 
__vsysˇŒ_0
;

154 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

156 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

157 
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

158  
p6_n›s
;

160  
k8_n›s
;

161 
	}
}

165 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

167 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K8
))

168  
k8_n›s
;

169 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K7
))

170  
k7_n›s
;

171 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

172  
p6_n›s
;

174  
öãl_n›s
;

175 
	}
}

180 
__öô_‹_moduÀ
 
	$add_n›s
(*
ö¢s
, 
Àn
)

182 c⁄° *c⁄° *
n›èbÀ
 = 
	`föd_n›_èbÀ
();

184 
Àn
 > 0) {

185 
n›Àn
 = 
Àn
;

186 i‡(
n›Àn
 > 
ASM_NOP_MAX
)

187 
n›Àn
 = 
ASM_NOP_MAX
;

188 
	`mem˝y
(
ö¢s
, 
n›èbÀ
[
n›Àn
],Çoplen);

189 
ö¢s
 +
n›Àn
;

190 
Àn
 -
n›Àn
;

192 
	}
}

194 
Æt_ö°r
 
__Æt_ö°ru˘i⁄s
[], 
__Æt_ö°ru˘i⁄s_íd
[];

195 
u8
 *
__smp_locks
[], *
__smp_locks_íd
[];

196 *
ãxt_poke_óæy
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
);

204 
__öô_‹_moduÀ
 
	$≠∂y_Æã∫©ives
(
Æt_ö°r
 *
°¨t
,

205 
Æt_ö°r
 *
íd
)

207 
Æt_ö°r
 *
a
;

208 
ö¢buf
[
MAX_PATCH_LEN
];

210 
	`DPRINTK
("%s:á…ÅabÀ %∞-> %p\n", 
__func__
, 
°¨t
, 
íd
);

211 
a
 = 
°¨t
;á < 
íd
;á++) {

212 
u8
 *
ö°r
 = 
a
->instr;

213 
	`BUG_ON
(
a
->
ª∂a˚míéí
 >á->
ö°æí
);

214 
	`BUG_ON
(
a
->
ö°æí
 > (
ö¢buf
));

215 i‡(!
	`boŸ_˝u_has
(
a
->
˝uid
))

217 #ifde‡
CONFIG_X86_64


219 i‡(
ö°r
 >(
u8
 *)
VSYSCALL_START
 && in°∏< (u8*)
VSYSCALL_END
) {

220 
ö°r
 = 
	`__va
(ö°∏- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__∑_symbﬁ
(&
__vsysˇŒ_0
));

221 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

222 
__func__
, 
a
->
ö°r
, instr);

225 
	`mem˝y
(
ö¢buf
, 
a
->
ª∂a˚mít
,á->
ª∂a˚míéí
);

226 
	`add_n›s
(
ö¢buf
 + 
a
->
ª∂a˚míéí
,

227 
a
->
ö°æí
 -á->
ª∂a˚míéí
);

228 
	`ãxt_poke_óæy
(
ö°r
, 
ö¢buf
, 
a
->
ö°æí
);

230 
	}
}

232 #ifde‡
CONFIG_SMP


234 
	$Æã∫©ives_smp_lock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

236 
u8
 **
±r
;

238 
	`muãx_lock
(&
ãxt_muãx
);

239 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

240 i‡(*
±r
 < 
ãxt
)

242 i‡(*
±r
 > 
ãxt_íd
)

245 
	`ãxt_poke
(*
±r
, (([]){0xf0}), 1);

247 
	`muãx_u∆ock
(&
ãxt_muãx
);

248 
	}
}

250 
	$Æã∫©ives_smp_u∆ock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

252 
u8
 **
±r
;

254 i‡(
n‹ïœ˚_smp
)

257 
	`muãx_lock
(&
ãxt_muãx
);

258 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

259 i‡(*
±r
 < 
ãxt
)

261 i‡(*
±r
 > 
ãxt_íd
)

264 
	`ãxt_poke
(*
±r
, (([]){0x3E}), 1);

266 
	`muãx_u∆ock
(&
ãxt_muãx
);

267 
	}
}

269 
	ssmp_Æt_moduÀ
 {

271 
moduÀ
 *
	mmod
;

272 *
	m«me
;

275 
u8
 **
	mlocks
;

276 
u8
 **
	mlocks_íd
;

279 
u8
 *
	mãxt
;

280 
u8
 *
	mãxt_íd
;

282 
li°_hód
 
	m√xt
;

284 
LIST_HEAD
(
smp_Æt_moduÀs
);

285 
DEFINE_MUTEX
(
smp_Æt
);

286 
	gsmp_mode
 = 1;

288 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_add
(
moduÀ
 *
mod
,

289 *
«me
,

290 *
locks
, *
locks_íd
,

291 *
ãxt
, *
ãxt_íd
)

293 
smp_Æt_moduÀ
 *
smp
;

295 i‡(
n‹ïœ˚_smp
)

298 i‡(
smp_Æt_⁄˚
) {

299 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

300 
	`Æã∫©ives_smp_u∆ock
(
locks
, 
locks_íd
,

301 
ãxt
, 
ãxt_íd
);

305 
smp
 = 
	`kzÆloc
((*smp), 
GFP_KERNEL
);

306 i‡(
NULL
 =
smp
)

309 
smp
->
mod
 = mod;

310 
smp
->
«me
 =Çame;

311 
smp
->
locks
 =Üocks;

312 
smp
->
locks_íd
 =Üocks_end;

313 
smp
->
ãxt
 =Åext;

314 
smp
->
ãxt_íd
 =Åext_end;

315 
	`DPRINTK
("%s:Üocks %p -> %p,Åext %p -> %p,Çame %s\n",

316 
__func__
, 
smp
->
locks
, smp->
locks_íd
,

317 
smp
->
ãxt
, smp->
ãxt_íd
, smp->
«me
);

319 
	`muãx_lock
(&
smp_Æt
);

320 
	`li°_add_èû
(&
smp
->
√xt
, &
smp_Æt_moduÀs
);

321 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

322 
	`Æã∫©ives_smp_u∆ock
(
smp
->
locks
, smp->
locks_íd
,

323 
smp
->
ãxt
, smp->
ãxt_íd
);

324 
	`muãx_u∆ock
(&
smp_Æt
);

325 
	}
}

327 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_dñ
(
moduÀ
 *
mod
)

329 
smp_Æt_moduÀ
 *
ôem
;

331 i‡(
smp_Æt_⁄˚
 || 
n‹ïœ˚_smp
)

334 
	`muãx_lock
(&
smp_Æt
);

335 
	`li°_f‹_óch_íåy
(
ôem
, &
smp_Æt_moduÀs
, 
√xt
) {

336 i‡(
mod
 !
ôem
->mod)

338 
	`li°_dñ
(&
ôem
->
√xt
);

339 
	`muãx_u∆ock
(&
smp_Æt
);

340 
	`DPRINTK
("%s: %s\n", 
__func__
, 
ôem
->
«me
);

341 
	`k‰ì
(
ôem
);

344 
	`muãx_u∆ock
(&
smp_Æt
);

345 
	}
}

347 
	$Æã∫©ives_smp_swôch
(
smp
)

349 
smp_Æt_moduÀ
 *
mod
;

351 #ifde‡
CONFIG_LOCKDEP


359 
	`¥ötk
("lockdep: fixing upálternatives.\n");

362 i‡(
n‹ïœ˚_smp
 || 
smp_Æt_⁄˚
)

364 
	`BUG_ON
(!
smp
 && (
	`num_⁄löe_˝us
() > 1));

366 
	`muãx_lock
(&
smp_Æt
);

372 i‡(
smp
 =
smp_mode
) {

374 } i‡(
smp
) {

375 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo SMP code\n");

376 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

377 
	`˛ór_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

378 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

379 
	`Æã∫©ives_smp_lock
(
mod
->
locks
, mod->
locks_íd
,

380 
mod
->
ãxt
, mod->
ãxt_íd
);

382 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

383 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

384 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

385 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

386 
	`Æã∫©ives_smp_u∆ock
(
mod
->
locks
, mod->
locks_íd
,

387 
mod
->
ãxt
, mod->
ãxt_íd
);

389 
smp_mode
 = 
smp
;

390 
	`muãx_u∆ock
(&
smp_Æt
);

391 
	}
}

395 #ifde‡
CONFIG_PARAVIRT


396 
__öô_‹_moduÀ
 
	$≠∂y_∑øvút
(
∑øvút_∑tch_sôe
 *
°¨t
,

397 
∑øvút_∑tch_sôe
 *
íd
)

399 
∑øvút_∑tch_sôe
 *
p
;

400 
ö¢buf
[
MAX_PATCH_LEN
];

402 i‡(
n‹ïœ˚_∑øvút
)

405 
p
 = 
°¨t
;Ö < 
íd
;Ö++) {

406 
u£d
;

408 
	`BUG_ON
(
p
->
Àn
 > 
MAX_PATCH_LEN
);

410 
	`mem˝y
(
ö¢buf
, 
p
->
ö°r
,Ö->
Àn
);

411 
u£d
 = 
pv_öô_›s
.
	`∑tch
(
p
->
ö°πy≥
,Ö->
˛obbîs
, 
ö¢buf
,

412 ()
p
->
ö°r
,Ö->
Àn
);

414 
	`BUG_ON
(
u£d
 > 
p
->
Àn
);

417 
	`add_n›s
(
ö¢buf
 + 
u£d
, 
p
->
Àn
 - used);

418 
	`ãxt_poke_óæy
(
p
->
ö°r
, 
ö¢buf
,Ö->
Àn
);

420 
	}
}

421 
∑øvút_∑tch_sôe
 
__°¨t_∑øö°ru˘i⁄s
[],

422 
__°›_∑øö°ru˘i⁄s
[];

425 
__öô
 
	$Æã∫©ive_ö°ru˘i⁄s
()

430 
	`°›_nmi
();

443 
	`≠∂y_Æã∫©ives
(
__Æt_ö°ru˘i⁄s
, 
__Æt_ö°ru˘i⁄s_íd
);

448 #ifde‡
CONFIG_HOTPLUG_CPU


449 i‡(
	`num_possibÀ_˝us
() < 2)

450 
smp_Æt_⁄˚
 = 1;

453 #ifde‡
CONFIG_SMP


454 i‡(
smp_Æt_⁄˚
) {

455 i‡(1 =
	`num_possibÀ_˝us
()) {

456 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

457 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

458 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

460 
	`Æã∫©ives_smp_u∆ock
(
__smp_locks
, 
__smp_locks_íd
,

461 
_ãxt
, 
_ëext
);

464 
	`Æã∫©ives_smp_moduÀ_add
(
NULL
, "core kernel",

465 
__smp_locks
, 
__smp_locks_íd
,

466 
_ãxt
, 
_ëext
);

469 i‡(
	`num_¥e£¡_˝us
(Ë=1 || 
£tup_max_˝us
 <= 1)

470 
	`Æã∫©ives_smp_swôch
(0);

473 
	`≠∂y_∑øvút
(
__∑øö°ru˘i⁄s
, 
__∑øö°ru˘i⁄s_íd
);

475 i‡(
smp_Æt_⁄˚
)

476 
	`‰ì_öô_∑ges
("SMPálternatives",

477 ()
__smp_locks
,

478 ()
__smp_locks_íd
);

480 
	`ª°¨t_nmi
();

481 
	}
}

495 *
__öô_‹_moduÀ
 
	$ãxt_poke_óæy
(*
addr
, c⁄° *
›code
,

496 
size_t
 
Àn
)

498 
Êags
;

499 
	`loˇl_úq_ßve
(
Êags
);

500 
	`mem˝y
(
addr
, 
›code
, 
Àn
);

501 
	`sync_c‹e
();

502 
	`loˇl_úq_ª°‹e
(
Êags
);

505  
addr
;

506 
	}
}

521 *
__k¥obes
 
	$ãxt_poke
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

523 
Êags
;

524 *
vaddr
;

525 
∑ge
 *
∑ges
[2];

526 
i
;

528 i‡(!
	`c‹e_kî√l_ãxt
(()
addr
)) {

529 
∑ges
[0] = 
	`vmÆloc_to_∑ge
(
addr
);

530 
∑ges
[1] = 
	`vmÆloc_to_∑ge
(
addr
 + 
PAGE_SIZE
);

532 
∑ges
[0] = 
	`vút_to_∑ge
(
addr
);

533 
	`WARN_ON
(!
	`PageRe£rved
(
∑ges
[0]));

534 
∑ges
[1] = 
	`vút_to_∑ge
(
addr
 + 
PAGE_SIZE
);

536 
	`BUG_ON
(!
∑ges
[0]);

537 
	`loˇl_úq_ßve
(
Êags
);

538 
	`£t_fixm≠
(
FIX_TEXT_POKE0
, 
	`∑ge_to_phys
(
∑ges
[0]));

539 i‡(
∑ges
[1])

540 
	`£t_fixm≠
(
FIX_TEXT_POKE1
, 
	`∑ge_to_phys
(
∑ges
[1]));

541 
vaddr
 = (*)
	`fix_to_vút
(
FIX_TEXT_POKE0
);

542 
	`mem˝y
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
›code
, 
Àn
);

543 
	`˛ór_fixm≠
(
FIX_TEXT_POKE0
);

544 i‡(
∑ges
[1])

545 
	`˛ór_fixm≠
(
FIX_TEXT_POKE1
);

546 
	`loˇl_Êush_éb
();

547 
	`sync_c‹e
();

550 
i
 = 0; i < 
Àn
; i++)

551 
	`BUG_ON
(((*)
addr
)[
i
] !((*)
›code
)[i]);

552 
	`loˇl_úq_ª°‹e
(
Êags
);

553  
addr
;

554 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<löux/pci.h
>

21 
	~<löux/gÂ.h
>

22 
	~<löux/bôm≠.h
>

23 
	~<löux/debugfs.h
>

24 
	~<löux/sˇâîli°.h
>

25 
	~<löux/dma-m≠pög.h
>

26 
	~<löux/iommu-hñ≥r.h
>

27 
	~<löux/iommu.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¨t.h
>

31 
	~<asm/amd_iommu_¥Ÿo.h
>

32 
	~<asm/amd_iommu_ty≥s.h
>

33 
	~<asm/amd_iommu.h
>

35 
	#CMD_SET_TYPE
(
cmd
, 
t
Ë((cmd)->
d©a
[1] |(—Ë<< 28))

	)

37 
	#EXIT_LOOP_COUNT
 10000000

	)

39 
DEFINE_RWLOCK
(
amd_iommu_devèbÀ_lock
);

42 
LIST_HEAD
(
iommu_pd_li°
);

43 
DEFINE_SPINLOCK
(
iommu_pd_li°_lock
);

49 
¥Ÿe˘i⁄_domaö
 *
	g±_domaö
;

51 
iommu_›s
 
	gamd_iommu_›s
;

56 
	siommu_cmd
 {

57 
u32
 
	md©a
[4];

60 
ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
);

61 
upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
);

69 
ölöe
 
u16
 
	$gë_devi˚_id
(
devi˚
 *
dev
)

71 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

73  
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

74 
	}
}

76 
iommu_dev_d©a
 *
	$gë_dev_d©a
(
devi˚
 *
dev
)

78  
dev
->
¨chd©a
.
iommu
;

79 
	}
}

85 
dma_›s_domaö
 *
	$föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
)

87 
dma_›s_domaö
 *
íåy
, *
ªt
 = 
NULL
;

88 
Êags
;

89 
u16
 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

91 i‡(
	`li°_em±y
(&
iommu_pd_li°
))

92  
NULL
;

94 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

96 
	`li°_f‹_óch_íåy
(
íåy
, &
iommu_pd_li°
, 
li°
) {

97 i‡(
íåy
->
èrgë_dev
 =
devid
 ||

98 
íåy
->
èrgë_dev
 =
Æüs
) {

99 
ªt
 = 
íåy
;

104 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

106  
ªt
;

107 
	}
}

113 
boﬁ
 
	$check_devi˚
(
devi˚
 *
dev
)

115 
u16
 
devid
;

117 i‡(!
dev
 || !dev->
dma_mask
)

118  
Ál£
;

121 i‡(!
dev
 || dev->
bus
 !&
pci_bus_ty≥
)

122  
Ál£
;

124 
devid
 = 
	`gë_devi˚_id
(
dev
);

127 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

128  
Ál£
;

130 i‡(
amd_iommu_æookup_èbÀ
[
devid
] =
NULL
)

131  
Ál£
;

133  
åue
;

134 
	}
}

136 
	$iommu_öô_devi˚
(
devi˚
 *
dev
)

138 
iommu_dev_d©a
 *
dev_d©a
;

139 
pci_dev
 *
pdev
;

140 
u16
 
devid
, 
Æüs
;

142 i‡(
dev
->
¨chd©a
.
iommu
)

145 
dev_d©a
 = 
	`kzÆloc
((*dev_d©a), 
GFP_KERNEL
);

146 i‡(!
dev_d©a
)

147  -
ENOMEM
;

149 
dev_d©a
->
dev
 = dev;

151 
devid
 = 
	`gë_devi˚_id
(
dev
);

152 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

153 
pdev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
Æüs
),álias & 0xff);

154 i‡(
pdev
)

155 
dev_d©a
->
Æüs
 = &
pdev
->
dev
;

157 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

159 
dev
->
¨chd©a
.
iommu
 = 
dev_d©a
;

163 
	}
}

165 
	$iommu_unöô_devi˚
(
devi˚
 *
dev
)

167 
	`k‰ì
(
dev
->
¨chd©a
.
iommu
);

168 
	}
}

170 
__öô
 
	$amd_iommu_unöô_devi˚s
()

172 
pci_dev
 *
pdev
 = 
NULL
;

174 
	`f‹_óch_pci_dev
(
pdev
) {

176 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

179 
	`iommu_unöô_devi˚
(&
pdev
->
dev
);

181 
	}
}

183 
__öô
 
	$amd_iommu_öô_devi˚s
()

185 
pci_dev
 *
pdev
 = 
NULL
;

186 
ªt
 = 0;

188 
	`f‹_óch_pci_dev
(
pdev
) {

190 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

193 
ªt
 = 
	`iommu_öô_devi˚
(&
pdev
->
dev
);

194 i‡(
ªt
)

195 
out_‰ì
;

200 
out_‰ì
:

202 
	`amd_iommu_unöô_devi˚s
();

204  
ªt
;

205 
	}
}

206 #ifde‡
CONFIG_AMD_IOMMU_STATS


212 
DECLARE_STATS_COUNTER
(
com∂_waô
);

213 
DECLARE_STATS_COUNTER
(
˙t_m≠_sögÀ
);

214 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

215 
DECLARE_STATS_COUNTER
(
˙t_m≠_sg
);

216 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sg
);

217 
DECLARE_STATS_COUNTER
(
˙t_Æloc_cohîít
);

218 
DECLARE_STATS_COUNTER
(
˙t_‰ì_cohîít
);

219 
DECLARE_STATS_COUNTER
(
¸oss_∑ge
);

220 
DECLARE_STATS_COUNTER
(
domaö_Êush_sögÀ
);

221 
DECLARE_STATS_COUNTER
(
domaö_Êush_Æl
);

222 
DECLARE_STATS_COUNTER
(
Ælo˚d_io_mem
);

223 
DECLARE_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

225 
díåy
 *
	g°©s_dú
;

226 
díåy
 *
	gde_fÊush
;

228 
	$amd_iommu_°©s_add
(
__iommu_cou¡î
 *
˙t
)

230 i‡(
°©s_dú
 =
NULL
)

233 
˙t
->
dít
 = 
	`debugfs_¸óã_u64
(˙t->
«me
, 0444, 
°©s_dú
,

234 &
˙t
->
vÆue
);

235 
	}
}

237 
	$amd_iommu_°©s_öô
()

239 
°©s_dú
 = 
	`debugfs_¸óã_dú
("amd-iommu", 
NULL
);

240 i‡(
°©s_dú
 =
NULL
)

243 
de_fÊush
 = 
	`debugfs_¸óã_boﬁ
("fuŒÊush", 0444, 
°©s_dú
,

244 (
u32
 *)&
amd_iommu_unm≠_Êush
);

246 
	`amd_iommu_°©s_add
(&
com∂_waô
);

247 
	`amd_iommu_°©s_add
(&
˙t_m≠_sögÀ
);

248 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sögÀ
);

249 
	`amd_iommu_°©s_add
(&
˙t_m≠_sg
);

250 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sg
);

251 
	`amd_iommu_°©s_add
(&
˙t_Æloc_cohîít
);

252 
	`amd_iommu_°©s_add
(&
˙t_‰ì_cohîít
);

253 
	`amd_iommu_°©s_add
(&
¸oss_∑ge
);

254 
	`amd_iommu_°©s_add
(&
domaö_Êush_sögÀ
);

255 
	`amd_iommu_°©s_add
(&
domaö_Êush_Æl
);

256 
	`amd_iommu_°©s_add
(&
Ælo˚d_io_mem
);

257 
	`amd_iommu_°©s_add
(&
tŸÆ_m≠_ªque°s
);

258 
	}
}

268 
	$dump_dã_íåy
(
u16
 
devid
)

270 
i
;

272 
i
 = 0; i < 8; ++i)

273 
	`¥_îr
("AMD-Vi: DTE[%d]: %08x\n", 
i
,

274 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
]);

275 
	}
}

277 
	$dump_comm™d
(
phys_addr
)

279 
iommu_cmd
 *
cmd
 = 
	`phys_to_vút
(
phys_addr
);

280 
i
;

282 
i
 = 0; i < 4; ++i)

283 
	`¥_îr
("AMD-Vi: CMD[%d]: %08x\n", 
i
, 
cmd
->
d©a
[i]);

284 
	}
}

286 
	$iommu_¥öt_evít
(
amd_iommu
 *
iommu
, *
__evt
)

288 
u32
 *
evít
 = 
__evt
;

289 
ty≥
 = (
evít
[1] >> 
EVENT_TYPE_SHIFT
Ë& 
EVENT_TYPE_MASK
;

290 
devid
 = (
evít
[0] >> 
EVENT_DEVID_SHIFT
Ë& 
EVENT_DEVID_MASK
;

291 
domid
 = (
evít
[1] >> 
EVENT_DOMID_SHIFT
Ë& 
EVENT_DOMID_MASK
;

292 
Êags
 = (
evít
[1] >> 
EVENT_FLAGS_SHIFT
Ë& 
EVENT_FLAGS_MASK
;

293 
u64
 
addªss
 = (u64)(((u64)
evít
[3]) << 32) |Évent[2];

295 
	`¥ötk
(
KERN_ERR
 "AMD-Vi: EventÜogged [");

297 
ty≥
) {

298 
EVENT_TYPE_ILL_DEV
:

299 
	`¥ötk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

301 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

302 
addªss
, 
Êags
);

303 
	`dump_dã_íåy
(
devid
);

305 
EVENT_TYPE_IO_FAULT
:

306 
	`¥ötk
("IO_PAGE_FAULT device=%02x:%02x.%x "

308 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

309 
domid
, 
addªss
, 
Êags
);

311 
EVENT_TYPE_DEV_TAB_ERR
:

312 
	`¥ötk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

314 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

315 
addªss
, 
Êags
);

317 
EVENT_TYPE_PAGE_TAB_ERR
:

318 
	`¥ötk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

320 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

321 
domid
, 
addªss
, 
Êags
);

323 
EVENT_TYPE_ILL_CMD
:

324 
	`¥ötk
("ILLEGAL_COMMAND_ERRORáddªss=0x%016Œx]\n", 
addªss
);

325 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

326 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

327 
	`dump_comm™d
(
addªss
);

329 
EVENT_TYPE_CMD_HARD_ERR
:

330 
	`¥ötk
("COMMAND_HARDWARE_ERRORáddress=0x%016llx "

331 "Êags=0x%04x]\n", 
addªss
, 
Êags
);

333 
EVENT_TYPE_IOTLB_INV_TO
:

334 
	`¥ötk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

336 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

337 
addªss
);

339 
EVENT_TYPE_INV_DEV_REQ
:

340 
	`¥ötk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

342 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

343 
addªss
, 
Êags
);

346 
	`¥ötk
(
KERN_ERR
 "UNKNOWNÅy≥=0x%02x]\n", 
ty≥
);

348 
	}
}

350 
	$iommu_pﬁl_evíts
(
amd_iommu
 *
iommu
)

352 
u32
 
hód
, 
èû
;

353 
Êags
;

355 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

357 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

358 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

360 
hód
 !
èû
) {

361 
	`iommu_¥öt_evít
(
iommu
, iommu->
evt_buf
 + 
hód
);

362 
hód
 = (hód + 
EVENT_ENTRY_SIZE
Ë% 
iommu
->
evt_buf_size
;

365 
	`wrôñ
(
hód
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

367 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

368 
	}
}

370 
úqªtu∫_t
 
	$amd_iommu_öt_h™dÀr
(
úq
, *
d©a
)

372 
amd_iommu
 *
iommu
;

374 
	`f‹_óch_iommu
(
iommu
)

375 
	`iommu_pﬁl_evíts
(
iommu
);

377  
IRQ_HANDLED
;

378 
	}
}

390 
	$__iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

392 
u32
 
èû
, 
hód
;

393 
u8
 *
èrgë
;

395 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

396 
èrgë
 = 
iommu
->
cmd_buf
 + 
èû
;

397 
	`mem˝y_toio
(
èrgë
, 
cmd
, (*cmd));

398 
èû
 = (èû + (*
cmd
)Ë% 
iommu
->
cmd_buf_size
;

399 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

400 i‡(
èû
 =
hód
)

401  -
ENOMEM
;

402 
	`wrôñ
(
èû
, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

405 
	}
}

411 
	$iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

413 
Êags
;

414 
ªt
;

416 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

417 
ªt
 = 
	`__iommu_queue_comm™d
(
iommu
, 
cmd
);

418 i‡(!
ªt
)

419 
iommu
->
√ed_sync
 = 
åue
;

420 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

422  
ªt
;

423 
	}
}

429 
	$__iommu_waô_f‹_com∂ëi⁄
(
amd_iommu
 *
iommu
)

431 
ªady
 = 0;

432 
°©us
 = 0;

433 
i
 = 0;

435 
	`INC_STATS_COUNTER
(
com∂_waô
);

437 !
ªady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

438 ++
i
;

440 
°©us
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

441 
ªady
 = 
°©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

445 
°©us
 &~
MMIO_STATUS_COM_WAIT_INT_MASK
;

446 
	`wrôñ
(
°©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

448 i‡(
	`u∆ikñy
(
i
 =
EXIT_LOOP_COUNT
))

449 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

450 
	}
}

456 
	$__iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

458 
iommu_cmd
 
cmd
;

460 
	`mem£t
(&
cmd
, 0, (cmd));

461 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

462 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

464  
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

465 
	}
}

474 
	$iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

476 
ªt
 = 0;

477 
Êags
;

479 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

481 i‡(!
iommu
->
√ed_sync
)

482 
out
;

484 
ªt
 = 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

486 
iommu
->
√ed_sync
 = 
Ál£
;

488 i‡(
ªt
)

489 
out
;

491 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

493 
out
:

494 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

496 i‡(
iommu
->
ª£t_ö_¥ogªss
)

497 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

500 
	}
}

502 
	$iommu_Êush_com∂ëe
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

504 
i
;

506 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

507 i‡(!
domaö
->
dev_iommu
[
i
])

514 
	`iommu_com∂ëi⁄_waô
(
amd_iommus
[
i
]);

516 
	}
}

521 
	$iommu_Êush_devi˚
(
devi˚
 *
dev
)

523 
amd_iommu
 *
iommu
;

524 
iommu_cmd
 
cmd
;

525 
u16
 
devid
;

527 
devid
 = 
	`gë_devi˚_id
(
dev
);

528 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

531 
	`mem£t
(&
cmd
, 0, (cmd));

532 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

533 
cmd
.
d©a
[0] = 
devid
;

535  
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

536 
	}
}

538 
	$__iommu_buûd_öv_iommu_∑ges
(
iommu_cmd
 *
cmd
, 
u64
 
addªss
,

539 
u16
 
domid
, 
pde
, 
s
)

541 
	`mem£t
(
cmd
, 0, (*cmd));

542 
addªss
 &
PAGE_MASK
;

543 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

544 
cmd
->
d©a
[1] |
domid
;

545 
cmd
->
d©a
[2] = 
	`lowî_32_bôs
(
addªss
);

546 
cmd
->
d©a
[3] = 
	`uµî_32_bôs
(
addªss
);

547 i‡(
s
)

548 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

549 i‡(
pde
)

550 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_PDE_MASK
;

551 
	}
}

556 
	$iommu_queue_öv_iommu_∑ges
(
amd_iommu
 *
iommu
,

557 
u64
 
addªss
, 
u16
 
domid
, 
pde
, 
s
)

559 
iommu_cmd
 
cmd
;

560 
ªt
;

562 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
addªss
, 
domid
, 
pde
, 
s
);

564 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

566  
ªt
;

567 
	}
}

574 
	$__iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

575 
u64
 
addªss
, 
size_t
 
size
, 
pde
)

577 
s
 = 0, 
i
;

578 
∑ges
 = 
	`iommu_num_∑ges
(
addªss
, 
size
, 
PAGE_SIZE
);

580 
addªss
 &
PAGE_MASK
;

582 i‡(
∑ges
 > 1) {

587 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

588 
s
 = 1;

592 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

593 i‡(!
domaö
->
dev_iommu
[
i
])

600 
	`iommu_queue_öv_iommu_∑ges
(
amd_iommus
[
i
], 
addªss
,

601 
domaö
->
id
, 
pde
, 
s
);

605 
	}
}

607 
	$iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

608 
u64
 
addªss
, 
size_t
 
size
)

610 
	`__iommu_Êush_∑ges
(
domaö
, 
addªss
, 
size
, 0);

611 
	}
}

614 
	$iommu_Êush_éb
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

616 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 0);

617 
	}
}

620 
	$iommu_Êush_éb_pde
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

622 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 1);

623 
	}
}

629 
	$iommu_Êush_domaö_devi˚s
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

631 
iommu_dev_d©a
 *
dev_d©a
;

632 
Êags
;

634 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

636 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
)

637 
	`iommu_Êush_devi˚
(
dev_d©a
->
dev
);

639 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

640 
	}
}

642 
	$iommu_Êush_Æl_domaö_devi˚s
()

644 
¥Ÿe˘i⁄_domaö
 *
domaö
;

645 
Êags
;

647 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

649 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

650 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

651 
	`iommu_Êush_com∂ëe
(
domaö
);

654 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

655 
	}
}

657 
	$amd_iommu_Êush_Æl_devi˚s
()

659 
	`iommu_Êush_Æl_domaö_devi˚s
();

660 
	}
}

666 
	$amd_iommu_Êush_Æl_domaös
()

668 
¥Ÿe˘i⁄_domaö
 *
domaö
;

669 
Êags
;

671 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

673 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

674 
	`•ö_lock
(&
domaö
->
lock
);

675 
	`iommu_Êush_éb_pde
(
domaö
);

676 
	`iommu_Êush_com∂ëe
(
domaö
);

677 
	`•ö_u∆ock
(&
domaö
->
lock
);

680 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

681 
	}
}

683 
	$ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
)

685 
	`¥_îr
("AMD-Vi: Resetting IOMMU command buffer\n");

687 i‡(
iommu
->
ª£t_ö_¥ogªss
)

688 
	`∑nic
("AMD-Vi: ILLEGAL_COMMAND_ERROR whileÑesetting command buffer\n");

690 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

691 
	`amd_iommu_Êush_Æl_devi˚s
();

692 
	`amd_iommu_Êush_Æl_domaös
();

694 
iommu
->
ª£t_ö_¥ogªss
 = 
Ál£
;

695 
	}
}

709 
boﬁ
 
	$ö¸ó£_addªss_•a˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

710 
gÂ_t
 
gÂ
)

712 
u64
 *
±e
;

714 i‡(
domaö
->
mode
 =
PAGE_MODE_6_LEVEL
)

716  
Ál£
;

718 
±e
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

719 i‡(!
±e
)

720  
Ál£
;

722 *
±e
 = 
	`PM_LEVEL_PDE
(
domaö
->
mode
,

723 
	`vút_to_phys
(
domaö
->
±_roŸ
));

724 
domaö
->
±_roŸ
 = 
±e
;

725 
domaö
->
mode
 += 1;

726 
domaö
->
upd©ed
 = 
åue
;

728  
åue
;

729 
	}
}

731 
u64
 *
	$Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

732 
addªss
,

733 
íd_lvl
,

734 
u64
 **
±e_∑ge
,

735 
gÂ_t
 
gÂ
)

737 
u64
 *
±e
, *
∑ge
;

738 
Àvñ
;

740 
addªss
 > 
	`PM_LEVEL_SIZE
(
domaö
->
mode
))

741 
	`ö¸ó£_addªss_•a˚
(
domaö
, 
gÂ
);

743 
Àvñ
 = 
domaö
->
mode
 - 1;

744 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

746 
Àvñ
 > 
íd_lvl
) {

747 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

748 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

749 i‡(!
∑ge
)

750  
NULL
;

751 *
±e
 = 
	`PM_LEVEL_PDE
(
Àvñ
, 
	`vút_to_phys
(
∑ge
));

754 
Àvñ
 -= 1;

756 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

758 i‡(
±e_∑ge
 && 
Àvñ
 =
íd_lvl
)

759 *
±e_∑ge
 = 
±e
;

761 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

764  
±e
;

765 
	}
}

771 
u64
 *
	$„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

772 
addªss
, 
m≠_size
)

774 
Àvñ
;

775 
u64
 *
±e
;

777 
Àvñ
 = 
domaö
->
mode
 - 1;

778 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

780 
Àvñ
 > 
m≠_size
) {

781 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

782  
NULL
;

784 
Àvñ
 -= 1;

786 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

787 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

789 i‡((
	`PM_PTE_LEVEL
(*
±e
Ë=0Ë&& 
Àvñ
 !
m≠_size
) {

790 
±e
 = 
NULL
;

795  
±e
;

796 
	}
}

805 
	$iommu_m≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

806 
bus_addr
,

807 
phys_addr
,

808 
¥Ÿ
,

809 
m≠_size
)

811 
u64
 
__±e
, *
±e
;

813 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

814 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

816 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
bus_addr
));

817 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
phys_addr
));

819 i‡(!(
¥Ÿ
 & 
IOMMU_PROT_MASK
))

820  -
EINVAL
;

822 
±e
 = 
	`Æloc_±e
(
dom
, 
bus_addr
, 
m≠_size
, 
NULL
, 
GFP_KERNEL
);

824 i‡(
	`IOMMU_PTE_PRESENT
(*
±e
))

825  -
EBUSY
;

827 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
;

828 i‡(
¥Ÿ
 & 
IOMMU_PROT_IR
)

829 
__±e
 |
IOMMU_PTE_IR
;

830 i‡(
¥Ÿ
 & 
IOMMU_PROT_IW
)

831 
__±e
 |
IOMMU_PTE_IW
;

833 *
±e
 = 
__±e
;

835 
	`upd©e_domaö
(
dom
);

838 
	}
}

840 
	$iommu_unm≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

841 
bus_addr
, 
m≠_size
)

843 
u64
 *
±e
 = 
	`„tch_±e
(
dom
, 
bus_addr
, 
m≠_size
);

845 i‡(
±e
)

846 *
±e
 = 0;

847 
	}
}

853 
	$iommu_f‹_unôy_m≠
(
amd_iommu
 *
iommu
,

854 
unôy_m≠_íåy
 *
íåy
)

856 
u16
 
bdf
, 
i
;

858 
i
 = 
íåy
->
devid_°¨t
; i <íåy->
devid_íd
; ++i) {

859 
bdf
 = 
amd_iommu_Æüs_èbÀ
[
i
];

860 i‡(
amd_iommu_æookup_èbÀ
[
bdf
] =
iommu
)

865 
	}
}

871 
	$dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

872 
unôy_m≠_íåy
 *
e
)

874 
u64
 
addr
;

875 
ªt
;

877 
addr
 = 
e
->
addªss_°¨t
;ádd∏<É->
addªss_íd
;

878 
addr
 +
PAGE_SIZE
) {

879 
ªt
 = 
	`iommu_m≠_∑ge
(&
dma_dom
->
domaö
, 
addr
,áddr, 
e
->
¥Ÿ
,

880 
PM_MAP_4k
);

881 i‡(
ªt
)

882  
ªt
;

887 i‡(
addr
 < 
dma_dom
->
≠îtuª_size
)

888 
	`__£t_bô
(
addr
 >> 
PAGE_SHIFT
,

889 
dma_dom
->
≠îtuª
[0]->
bôm≠
);

893 
	}
}

901 
	$iommu_öô_unôy_m≠pögs
(
amd_iommu
 *
iommu
)

903 
unôy_m≠_íåy
 *
íåy
;

904 
ªt
;

906 
	`li°_f‹_óch_íåy
(
íåy
, &
amd_iommu_unôy_m≠
, 
li°
) {

907 i‡(!
	`iommu_f‹_unôy_m≠
(
iommu
, 
íåy
))

909 
ªt
 = 
	`dma_›s_unôy_m≠
(
iommu
->
deÁu…_dom
, 
íåy
);

910 i‡(
ªt
)

911  
ªt
;

915 
	}
}

920 
	$öô_unôy_m≠pögs_f‹_devi˚
(
dma_›s_domaö
 *
dma_dom
,

921 
u16
 
devid
)

923 
unôy_m≠_íåy
 *
e
;

924 
ªt
;

926 
	`li°_f‹_óch_íåy
(
e
, &
amd_iommu_unôy_m≠
, 
li°
) {

927 i‡(!(
devid
 >
e
->
devid_°¨t
 && devid <e->
devid_íd
))

929 
ªt
 = 
	`dma_›s_unôy_m≠
(
dma_dom
, 
e
);

930 i‡(
ªt
)

931  
ªt
;

935 
	}
}

957 
	$dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

958 
°¨t_∑ge
,

959 
∑ges
)

961 
i
, 
œ°_∑ge
 = 
dom
->
≠îtuª_size
 >> 
PAGE_SHIFT
;

963 i‡(
°¨t_∑ge
 + 
∑ges
 > 
œ°_∑ge
)

964 
∑ges
 = 
œ°_∑ge
 - 
°¨t_∑ge
;

966 
i
 = 
°¨t_∑ge
; i < sèπ_∑gê+ 
∑ges
; ++i) {

967 
ödex
 = 
i
 / 
APERTURE_RANGE_PAGES
;

968 
∑ge
 = 
i
 % 
APERTURE_RANGE_PAGES
;

969 
	`__£t_bô
(
∑ge
, 
dom
->
≠îtuª
[
ödex
]->
bôm≠
);

971 
	}
}

978 
	$Æloc_√w_ønge
(
dma_›s_domaö
 *
dma_dom
,

979 
boﬁ
 
p›uœã
, 
gÂ_t
 
gÂ
)

981 
ödex
 = 
dma_dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

982 
amd_iommu
 *
iommu
;

983 
i
;

985 #ifde‡
CONFIG_IOMMU_STRESS


986 
p›uœã
 = 
Ál£
;

989 i‡(
ödex
 >
APERTURE_MAX_RANGES
)

990  -
ENOMEM
;

992 
dma_dom
->
≠îtuª
[
ödex
] = 
	`kzÆloc
((
≠îtuª_ønge
), 
gÂ
);

993 i‡(!
dma_dom
->
≠îtuª
[
ödex
])

994  -
ENOMEM
;

996 
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

997 i‡(!
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
)

998 
out_‰ì
;

1000 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 = dma_dom->
≠îtuª_size
;

1002 i‡(
p›uœã
) {

1003 
addªss
 = 
dma_dom
->
≠îtuª_size
;

1004 
i
, 
num_±es
 = 
APERTURE_RANGE_PAGES
 / 512;

1005 
u64
 *
±e
, *
±e_∑ge
;

1007 
i
 = 0; i < 
num_±es
; ++i) {

1008 
±e
 = 
	`Æloc_±e
(&
dma_dom
->
domaö
, 
addªss
, 
PM_MAP_4k
,

1009 &
±e_∑ge
, 
gÂ
);

1010 i‡(!
±e
)

1011 
out_‰ì
;

1013 
dma_dom
->
≠îtuª
[
ödex
]->
±e_∑ges
[
i
] = 
±e_∑ge
;

1015 
addªss
 +
APERTURE_RANGE_SIZE
 / 64;

1019 
dma_dom
->
≠îtuª_size
 +
APERTURE_RANGE_SIZE
;

1022 
	`f‹_óch_iommu
(
iommu
) {

1023 i‡(
iommu
->
ex˛usi⁄_°¨t
 &&

1024 
iommu
->
ex˛usi⁄_°¨t
 >
dma_dom
->
≠îtuª
[
ödex
]->
off£t


1025 && 
iommu
->
ex˛usi⁄_°¨t
 < 
dma_dom
->
≠îtuª_size
) {

1026 
°¨çage
;

1027 
∑ges
 = 
	`iommu_num_∑ges
(
iommu
->
ex˛usi⁄_°¨t
,

1028 
iommu
->
ex˛usi⁄_Àngth
,

1029 
PAGE_SIZE
);

1030 
°¨çage
 = 
iommu
->
ex˛usi⁄_°¨t
 >> 
PAGE_SHIFT
;

1031 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
°¨çage
, 
∑ges
);

1041 
i
 = 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
;

1042 
i
 < 
dma_dom
->
≠îtuª_size
;

1043 
i
 +
PAGE_SIZE
) {

1044 
u64
 *
±e
 = 
	`„tch_±e
(&
dma_dom
->
domaö
, 
i
, 
PM_MAP_4k
);

1045 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

1048 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
i
 << 
PAGE_SHIFT
, 1);

1051 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1055 
out_‰ì
:

1056 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1058 
	`‰ì_∑ge
(()
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
);

1060 
	`k‰ì
(
dma_dom
->
≠îtuª
[
ödex
]);

1061 
dma_dom
->
≠îtuª
[
ödex
] = 
NULL
;

1063  -
ENOMEM
;

1064 
	}
}

1066 
	$dma_›s_¨ó_Æloc
(
devi˚
 *
dev
,

1067 
dma_›s_domaö
 *
dom
,

1068 
∑ges
,

1069 
Æign_mask
,

1070 
u64
 
dma_mask
,

1071 
°¨t
)

1073 
√xt_bô
 = 
dom
->
√xt_addªss
 % 
APERTURE_RANGE_SIZE
;

1074 
max_ödex
 = 
dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

1075 
i
 = 
°¨t
 >> 
APERTURE_RANGE_SHIFT
;

1076 
bound¨y_size
;

1077 
addªss
 = -1;

1078 
limô
;

1080 
√xt_bô
 >>
PAGE_SHIFT
;

1082 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

1083 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

1085 ;
i
 < 
max_ödex
; ++i) {

1086 
off£t
 = 
dom
->
≠îtuª
[
i
]->off£à>> 
PAGE_SHIFT
;

1088 i‡(
dom
->
≠îtuª
[
i
]->
off£t
 >
dma_mask
)

1091 
limô
 = 
	`iommu_devi˚_max_ödex
(
APERTURE_RANGE_PAGES
, 
off£t
,

1092 
dma_mask
 >> 
PAGE_SHIFT
);

1094 
addªss
 = 
	`iommu_¨ó_Æloc
(
dom
->
≠îtuª
[
i
]->
bôm≠
,

1095 
limô
, 
√xt_bô
, 
∑ges
, 0,

1096 
bound¨y_size
, 
Æign_mask
);

1097 i‡(
addªss
 != -1) {

1098 
addªss
 = 
dom
->
≠îtuª
[
i
]->
off£t
 +

1099 (
addªss
 << 
PAGE_SHIFT
);

1100 
dom
->
√xt_addªss
 = 
addªss
 + (
∑ges
 << 
PAGE_SHIFT
);

1104 
√xt_bô
 = 0;

1107  
addªss
;

1108 
	}
}

1110 
	$dma_›s_Æloc_addªs£s
(
devi˚
 *
dev
,

1111 
dma_›s_domaö
 *
dom
,

1112 
∑ges
,

1113 
Æign_mask
,

1114 
u64
 
dma_mask
)

1116 
addªss
;

1118 #ifde‡
CONFIG_IOMMU_STRESS


1119 
dom
->
√xt_addªss
 = 0;

1120 
dom
->
√ed_Êush
 = 
åue
;

1123 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1124 
dma_mask
, 
dom
->
√xt_addªss
);

1126 i‡(
addªss
 == -1) {

1127 
dom
->
√xt_addªss
 = 0;

1128 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1129 
dma_mask
, 0);

1130 
dom
->
√ed_Êush
 = 
åue
;

1133 i‡(
	`u∆ikñy
(
addªss
 == -1))

1134 
addªss
 = 
DMA_ERROR_CODE
;

1136 
	`WARN_ON
((
addªss
 + (
PAGE_SIZE
*
∑ges
)Ë> 
dom
->
≠îtuª_size
);

1138  
addªss
;

1139 
	}
}

1146 
	$dma_›s_‰ì_addªs£s
(
dma_›s_domaö
 *
dom
,

1147 
addªss
,

1148 
∑ges
)

1150 
i
 = 
addªss
 >> 
APERTURE_RANGE_SHIFT
;

1151 
≠îtuª_ønge
 *
ønge
 = 
dom
->
≠îtuª
[
i
];

1153 
	`BUG_ON
(
i
 >
APERTURE_MAX_RANGES
 || 
ønge
 =
NULL
);

1155 #ifde‡
CONFIG_IOMMU_STRESS


1156 i‡(
i
 < 4)

1160 i‡(
addªss
 >
dom
->
√xt_addªss
)

1161 
dom
->
√ed_Êush
 = 
åue
;

1163 
addªss
 = (addªs†% 
APERTURE_RANGE_SIZE
Ë>> 
PAGE_SHIFT
;

1165 
	`bôm≠_˛ór
(
ønge
->
bôm≠
, 
addªss
, 
∑ges
);

1167 
	}
}

1182 
	$add_domaö_to_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1184 
Êags
;

1186 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1187 
	`li°_add
(&
domaö
->
li°
, &
amd_iommu_pd_li°
);

1188 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1189 
	}
}

1195 
	$dñ_domaö_‰om_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1197 
Êags
;

1199 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1200 
	`li°_dñ
(&
domaö
->
li°
);

1201 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1202 
	}
}

1204 
u16
 
	$domaö_id_Æloc
()

1206 
Êags
;

1207 
id
;

1209 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1210 
id
 = 
	`föd_fú°_zîo_bô
(
amd_iommu_pd_Æloc_bôm≠
, 
MAX_DOMAIN_ID
);

1211 
	`BUG_ON
(
id
 == 0);

1212 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1213 
	`__£t_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1215 
id
 = 0;

1216 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1218  
id
;

1219 
	}
}

1221 
	$domaö_id_‰ì
(
id
)

1223 
Êags
;

1225 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1226 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1227 
	`__˛ór_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1228 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1229 
	}
}

1231 
	$‰ì_∑gëabÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1233 
i
, 
j
;

1234 
u64
 *
p1
, *
p2
, *
p3
;

1236 
p1
 = 
domaö
->
±_roŸ
;

1238 i‡(!
p1
)

1241 
i
 = 0; i < 512; ++i) {

1242 i‡(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

1245 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

1246 
j
 = 0; j < 512; ++j) {

1247 i‡(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

1249 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

1250 
	`‰ì_∑ge
(()
p3
);

1253 
	`‰ì_∑ge
(()
p2
);

1256 
	`‰ì_∑ge
(()
p1
);

1258 
domaö
->
±_roŸ
 = 
NULL
;

1259 
	}
}

1265 
	$dma_›s_domaö_‰ì
(
dma_›s_domaö
 *
dom
)

1267 
i
;

1269 i‡(!
dom
)

1272 
	`dñ_domaö_‰om_li°
(&
dom
->
domaö
);

1274 
	`‰ì_∑gëabÀ
(&
dom
->
domaö
);

1276 
i
 = 0; i < 
APERTURE_MAX_RANGES
; ++i) {

1277 i‡(!
dom
->
≠îtuª
[
i
])

1279 
	`‰ì_∑ge
(()
dom
->
≠îtuª
[
i
]->
bôm≠
);

1280 
	`k‰ì
(
dom
->
≠îtuª
[
i
]);

1283 
	`k‰ì
(
dom
);

1284 
	}
}

1291 
dma_›s_domaö
 *
	$dma_›s_domaö_Æloc
()

1293 
dma_›s_domaö
 *
dma_dom
;

1295 
dma_dom
 = 
	`kzÆloc
((
dma_›s_domaö
), 
GFP_KERNEL
);

1296 i‡(!
dma_dom
)

1297  
NULL
;

1299 
	`•ö_lock_öô
(&
dma_dom
->
domaö
.
lock
);

1301 
dma_dom
->
domaö
.
id
 = 
	`domaö_id_Æloc
();

1302 i‡(
dma_dom
->
domaö
.
id
 == 0)

1303 
‰ì_dma_dom
;

1304 
	`INIT_LIST_HEAD
(&
dma_dom
->
domaö
.
dev_li°
);

1305 
dma_dom
->
domaö
.
mode
 = 
PAGE_MODE_2_LEVEL
;

1306 
dma_dom
->
domaö
.
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1307 
dma_dom
->
domaö
.
Êags
 = 
PD_DMA_OPS_MASK
;

1308 
dma_dom
->
domaö
.
¥iv
 = dma_dom;

1309 i‡(!
dma_dom
->
domaö
.
±_roŸ
)

1310 
‰ì_dma_dom
;

1312 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1313 
dma_dom
->
èrgë_dev
 = 0xffff;

1315 
	`add_domaö_to_li°
(&
dma_dom
->
domaö
);

1317 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
åue
, 
GFP_KERNEL
))

1318 
‰ì_dma_dom
;

1324 
dma_dom
->
≠îtuª
[0]->
bôm≠
[0] = 1;

1325 
dma_dom
->
√xt_addªss
 = 0;

1328  
dma_dom
;

1330 
‰ì_dma_dom
:

1331 
	`dma_›s_domaö_‰ì
(
dma_dom
);

1333  
NULL
;

1334 
	}
}

1340 
boﬁ
 
	$dma_›s_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1342  
domaö
->
Êags
 & 
PD_DMA_OPS_MASK
;

1343 
	}
}

1345 
	$£t_dã_íåy
(
u16
 
devid
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1347 
u64
 
±e_roŸ
 = 
	`vút_to_phys
(
domaö
->
±_roŸ
);

1349 
±e_roŸ
 |(
domaö
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

1350 << 
DEV_ENTRY_MODE_SHIFT
;

1351 
±e_roŸ
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1353 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 
domaö
->
id
;

1354 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 
	`uµî_32_bôs
(
±e_roŸ
);

1355 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
	`lowî_32_bôs
(
±e_roŸ
);

1356 
	}
}

1358 
	$˛ór_dã_íåy
(
u16
 
devid
)

1361 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1362 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 0;

1363 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 0;

1365 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

1366 
	}
}

1368 
	$do_©èch
(
devi˚
 *
dev
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1370 
iommu_dev_d©a
 *
dev_d©a
;

1371 
amd_iommu
 *
iommu
;

1372 
u16
 
devid
;

1374 
devid
 = 
	`gë_devi˚_id
(
dev
);

1375 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1376 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1379 
dev_d©a
->
domaö
 = domain;

1380 
	`li°_add
(&
dev_d©a
->
li°
, &
domaö
->
dev_li°
);

1381 
	`£t_dã_íåy
(
devid
, 
domaö
);

1384 
domaö
->
dev_iommu
[
iommu
->
ödex
] += 1;

1385 
domaö
->
dev_˙t
 += 1;

1388 
	`iommu_Êush_devi˚
(
dev
);

1389 
	}
}

1391 
	$do_dëach
(
devi˚
 *
dev
)

1393 
iommu_dev_d©a
 *
dev_d©a
;

1394 
amd_iommu
 *
iommu
;

1395 
u16
 
devid
;

1397 
devid
 = 
	`gë_devi˚_id
(
dev
);

1398 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1399 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1402 
dev_d©a
->
domaö
->
dev_iommu
[
iommu
->
ödex
] -= 1;

1403 
dev_d©a
->
domaö
->
dev_˙t
 -= 1;

1406 
dev_d©a
->
domaö
 = 
NULL
;

1407 
	`li°_dñ
(&
dev_d©a
->
li°
);

1408 
	`˛ór_dã_íåy
(
devid
);

1411 
	`iommu_Êush_devi˚
(
dev
);

1412 
	}
}

1418 
	$__©èch_devi˚
(
devi˚
 *
dev
,

1419 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1421 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1423 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1424 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1426 i‡(!
Æüs_d©a
)

1427  -
EINVAL
;

1430 
	`•ö_lock
(&
domaö
->
lock
);

1433 i‡(
Æüs_d©a
->
domaö
 !
NULL
 &&

1434 
Æüs_d©a
->
domaö
 != domain)

1435  -
EBUSY
;

1437 i‡(
dev_d©a
->
domaö
 !
NULL
 &&

1438 
dev_d©a
->
domaö
 != domain)

1439  -
EBUSY
;

1442 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1443 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1444 i‡(
Æüs_d©a
->
domaö
 =
NULL
)

1445 
	`do_©èch
(
dev_d©a
->
Æüs
, 
domaö
);

1447 
	`©omic_öc
(&
Æüs_d©a
->
böd
);

1450 i‡(
dev_d©a
->
domaö
 =
NULL
)

1451 
	`do_©èch
(
dev
, 
domaö
);

1453 
	`©omic_öc
(&
dev_d©a
->
böd
);

1456 
	`•ö_u∆ock
(&
domaö
->
lock
);

1459 
	}
}

1465 
	$©èch_devi˚
(
devi˚
 *
dev
,

1466 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1468 
Êags
;

1469 
ªt
;

1471 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1472 
ªt
 = 
	`__©èch_devi˚
(
dev
, 
domaö
);

1473 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1480 
	`iommu_Êush_éb_pde
(
domaö
);

1482  
ªt
;

1483 
	}
}

1488 
	$__dëach_devi˚
(
devi˚
 *
dev
)

1490 
iommu_dev_d©a
 *
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1491 
iommu_dev_d©a
 *
Æüs_d©a
;

1492 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1493 
Êags
;

1495 
	`BUG_ON
(!
dev_d©a
->
domaö
);

1497 
domaö
 = 
dev_d©a
->domain;

1499 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1501 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1502 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1503 i‡(
	`©omic_dec_™d_ã°
(&
Æüs_d©a
->
böd
))

1504 
	`do_dëach
(
dev_d©a
->
Æüs
);

1507 i‡(
	`©omic_dec_™d_ã°
(&
dev_d©a
->
böd
))

1508 
	`do_dëach
(
dev
);

1510 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1517 i‡(
iommu_∑ss_through
 &&

1518 (
dev_d©a
->
domaö
 =
NULL
 && domaö !
±_domaö
))

1519 
	`__©èch_devi˚
(
dev
, 
±_domaö
);

1520 
	}
}

1525 
	$dëach_devi˚
(
devi˚
 *
dev
)

1527 
Êags
;

1530 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1531 
	`__dëach_devi˚
(
dev
);

1532 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1533 
	}
}

1539 
¥Ÿe˘i⁄_domaö
 *
	$domaö_f‹_devi˚
(
devi˚
 *
dev
)

1541 
¥Ÿe˘i⁄_domaö
 *
dom
;

1542 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1543 
Êags
;

1544 
u16
 
devid
, 
Æüs
;

1546 
devid
 = 
	`gë_devi˚_id
(
dev
);

1547 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

1548 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1549 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1550 i‡(!
Æüs_d©a
)

1551  
NULL
;

1553 
	`ªad_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1554 
dom
 = 
dev_d©a
->
domaö
;

1555 i‡(
dom
 =
NULL
 &&

1556 
Æüs_d©a
->
domaö
 !
NULL
) {

1557 
	`__©èch_devi˚
(
dev
, 
Æüs_d©a
->
domaö
);

1558 
dom
 = 
Æüs_d©a
->
domaö
;

1561 
	`ªad_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1563  
dom
;

1564 
	}
}

1566 
	$devi˚_ch™ge_nŸifõr
(
nŸifõr_block
 *
nb
,

1567 
a˘i⁄
, *
d©a
)

1569 
devi˚
 *
dev
 = 
d©a
;

1570 
u16
 
devid
;

1571 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1572 
dma_›s_domaö
 *
dma_domaö
;

1573 
amd_iommu
 *
iommu
;

1574 
Êags
;

1576 i‡(!
	`check_devi˚
(
dev
))

1579 
devid
 = 
	`gë_devi˚_id
(
dev
);

1580 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1582 
a˘i⁄
) {

1583 
BUS_NOTIFY_UNBOUND_DRIVER
:

1585 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1587 i‡(!
domaö
)

1588 
out
;

1589 i‡(
iommu_∑ss_through
)

1591 
	`dëach_devi˚
(
dev
);

1593 
BUS_NOTIFY_ADD_DEVICE
:

1595 
	`iommu_öô_devi˚
(
dev
);

1597 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1600 
dma_domaö
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1601 i‡(
dma_domaö
)

1602 
out
;

1603 
dma_domaö
 = 
	`dma_›s_domaö_Æloc
();

1604 i‡(!
dma_domaö
)

1605 
out
;

1606 
dma_domaö
->
èrgë_dev
 = 
devid
;

1608 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1609 
	`li°_add_èû
(&
dma_domaö
->
li°
, &
iommu_pd_li°
);

1610 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1613 
BUS_NOTIFY_DEL_DEVICE
:

1615 
	`iommu_unöô_devi˚
(
dev
);

1618 
out
;

1621 
	`iommu_Êush_devi˚
(
dev
);

1622 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1624 
out
:

1626 
	}
}

1628 
nŸifõr_block
 
	gdevi˚_nb
 = {

1629 .
nŸifõr_ˇŒ
 = 
devi˚_ch™ge_nŸifõr
,

1632 
	$amd_iommu_öô_nŸifõr
()

1634 
	`bus_ªgi°î_nŸifõr
(&
pci_bus_ty≥
, &
devi˚_nb
);

1635 
	}
}

1650 
¥Ÿe˘i⁄_domaö
 *
	$gë_domaö
(
devi˚
 *
dev
)

1652 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1653 
dma_›s_domaö
 *
dma_dom
;

1654 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev
);

1656 i‡(!
	`check_devi˚
(
dev
))

1657  
	`ERR_PTR
(-
EINVAL
);

1659 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1660 i‡(
domaö
 !
NULL
 && !
	`dma_›s_domaö
(domain))

1661  
	`ERR_PTR
(-
EBUSY
);

1663 i‡(
domaö
 !
NULL
)

1664  
domaö
;

1667 
dma_dom
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1668 i‡(!
dma_dom
)

1669 
dma_dom
 = 
amd_iommu_æookup_èbÀ
[
devid
]->
deÁu…_dom
;

1670 
	`©èch_devi˚
(
dev
, &
dma_dom
->
domaö
);

1671 
	`DUMP_¥ötk
("UsingÖrotection domain %d for device %s\n",

1672 
dma_dom
->
domaö
.
id
, 
	`dev_«me
(
dev
));

1674  &
dma_dom
->
domaö
;

1675 
	}
}

1677 
	$upd©e_devi˚_èbÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1679 
iommu_dev_d©a
 *
dev_d©a
;

1681 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
) {

1682 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev_d©a
->
dev
);

1683 
	`£t_dã_íåy
(
devid
, 
domaö
);

1685 
	}
}

1687 
	$upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1689 i‡(!
domaö
->
upd©ed
)

1692 
	`upd©e_devi˚_èbÀ
(
domaö
);

1693 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

1694 
	`iommu_Êush_éb_pde
(
domaö
);

1696 
domaö
->
upd©ed
 = 
Ál£
;

1697 
	}
}

1702 
u64
* 
	$dma_›s_gë_±e
(
dma_›s_domaö
 *
dom
,

1703 
addªss
)

1705 
≠îtuª_ønge
 *
≠îtuª
;

1706 
u64
 *
±e
, *
±e_∑ge
;

1708 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1709 i‡(!
≠îtuª
)

1710  
NULL
;

1712 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1713 i‡(!
±e
) {

1714 
±e
 = 
	`Æloc_±e
(&
dom
->
domaö
, 
addªss
, 
PM_MAP_4k
, &
±e_∑ge
,

1715 
GFP_ATOMIC
);

1716 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)] = 
±e_∑ge
;

1718 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1720 
	`upd©e_domaö
(&
dom
->
domaö
);

1722  
±e
;

1723 
	}
}

1729 
dma_addr_t
 
	$dma_›s_domaö_m≠
(
dma_›s_domaö
 *
dom
,

1730 
addªss
,

1731 
phys_addr_t
 
∑ddr
,

1732 
dúe˘i⁄
)

1734 
u64
 *
±e
, 
__±e
;

1736 
	`WARN_ON
(
addªss
 > 
dom
->
≠îtuª_size
);

1738 
∑ddr
 &
PAGE_MASK
;

1740 
±e
 = 
	`dma_›s_gë_±e
(
dom
, 
addªss
);

1741 i‡(!
±e
)

1742  
DMA_ERROR_CODE
;

1744 
__±e
 = 
∑ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1746 i‡(
dúe˘i⁄
 =
DMA_TO_DEVICE
)

1747 
__±e
 |
IOMMU_PTE_IR
;

1748 i‡(
dúe˘i⁄
 =
DMA_FROM_DEVICE
)

1749 
__±e
 |
IOMMU_PTE_IW
;

1750 i‡(
dúe˘i⁄
 =
DMA_BIDIRECTIONAL
)

1751 
__±e
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1753 
	`WARN_ON
(*
±e
);

1755 *
±e
 = 
__±e
;

1757  (
dma_addr_t
)
addªss
;

1758 
	}
}

1763 
	$dma_›s_domaö_unm≠
(
dma_›s_domaö
 *
dom
,

1764 
addªss
)

1766 
≠îtuª_ønge
 *
≠îtuª
;

1767 
u64
 *
±e
;

1769 i‡(
addªss
 >
dom
->
≠îtuª_size
)

1772 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1773 i‡(!
≠îtuª
)

1776 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1777 i‡(!
±e
)

1780 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1782 
	`WARN_ON
(!*
±e
);

1784 *
±e
 = 0ULL;

1785 
	}
}

1793 
dma_addr_t
 
	$__m≠_sögÀ
(
devi˚
 *
dev
,

1794 
dma_›s_domaö
 *
dma_dom
,

1795 
phys_addr_t
 
∑ddr
,

1796 
size_t
 
size
,

1797 
dú
,

1798 
boﬁ
 
Æign
,

1799 
u64
 
dma_mask
)

1801 
dma_addr_t
 
off£t
 = 
∑ddr
 & ~
PAGE_MASK
;

1802 
dma_addr_t
 
addªss
, 
°¨t
, 
ªt
;

1803 
∑ges
;

1804 
Æign_mask
 = 0;

1805 
i
;

1807 
∑ges
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

1808 
∑ddr
 &
PAGE_MASK
;

1810 
	`INC_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

1812 i‡(
∑ges
 > 1)

1813 
	`INC_STATS_COUNTER
(
¸oss_∑ge
);

1815 i‡(
Æign
)

1816 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

1818 
ªåy
:

1819 
addªss
 = 
	`dma_›s_Æloc_addªs£s
(
dev
, 
dma_dom
, 
∑ges
, 
Æign_mask
,

1820 
dma_mask
);

1821 i‡(
	`u∆ikñy
(
addªss
 =
DMA_ERROR_CODE
)) {

1827 
dma_dom
->
√xt_addªss
 = dma_dom->
≠îtuª_size
;

1829 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
Ál£
, 
GFP_ATOMIC
))

1830 
out
;

1836 
ªåy
;

1839 
°¨t
 = 
addªss
;

1840 
i
 = 0; i < 
∑ges
; ++i) {

1841 
ªt
 = 
	`dma_›s_domaö_m≠
(
dma_dom
, 
°¨t
, 
∑ddr
, 
dú
);

1842 i‡(
ªt
 =
DMA_ERROR_CODE
)

1843 
out_unm≠
;

1845 
∑ddr
 +
PAGE_SIZE
;

1846 
°¨t
 +
PAGE_SIZE
;

1848 
addªss
 +
off£t
;

1850 
	`ADD_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1852 i‡(
	`u∆ikñy
(
dma_dom
->
√ed_Êush
 && !
amd_iommu_unm≠_Êush
)) {

1853 
	`iommu_Êush_éb
(&
dma_dom
->
domaö
);

1854 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1855 } i‡(
	`u∆ikñy
(
amd_iommu_≈_ˇche
))

1856 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
addªss
, 
size
);

1858 
out
:

1859  
addªss
;

1861 
out_unm≠
:

1863 --
i
; i >= 0; --i) {

1864 
°¨t
 -
PAGE_SIZE
;

1865 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1868 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
addªss
, 
∑ges
);

1870  
DMA_ERROR_CODE
;

1871 
	}
}

1877 
	$__unm≠_sögÀ
(
dma_›s_domaö
 *
dma_dom
,

1878 
dma_addr_t
 
dma_addr
,

1879 
size_t
 
size
,

1880 
dú
)

1882 
dma_addr_t
 
i
, 
°¨t
;

1883 
∑ges
;

1885 i‡((
dma_addr
 =
DMA_ERROR_CODE
) ||

1886 (
dma_addr
 + 
size
 > 
dma_dom
->
≠îtuª_size
))

1889 
∑ges
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1890 
dma_addr
 &
PAGE_MASK
;

1891 
°¨t
 = 
dma_addr
;

1893 
i
 = 0; i < 
∑ges
; ++i) {

1894 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1895 
°¨t
 +
PAGE_SIZE
;

1898 
	`SUB_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1900 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
dma_addr
, 
∑ges
);

1902 i‡(
amd_iommu_unm≠_Êush
 || 
dma_dom
->
√ed_Êush
) {

1903 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
dma_addr
, 
size
);

1904 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1906 
	}
}

1911 
dma_addr_t
 
	$m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

1912 
off£t
, 
size_t
 
size
,

1913 
dma_d©a_dúe˘i⁄
 
dú
,

1914 
dma_©ås
 *
©ås
)

1916 
Êags
;

1917 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1918 
dma_addr_t
 
addr
;

1919 
u64
 
dma_mask
;

1920 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

1922 
	`INC_STATS_COUNTER
(
˙t_m≠_sögÀ
);

1924 
domaö
 = 
	`gë_domaö
(
dev
);

1925 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

1926  (
dma_addr_t
)
∑ddr
;

1927 i‡(
	`IS_ERR
(
domaö
))

1928  
DMA_ERROR_CODE
;

1930 
dma_mask
 = *
dev
->dma_mask;

1932 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1934 
addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
, 
size
, 
dú
, 
Ál£
,

1935 
dma_mask
);

1936 i‡(
addr
 =
DMA_ERROR_CODE
)

1937 
out
;

1939 
	`iommu_Êush_com∂ëe
(
domaö
);

1941 
out
:

1942 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1944  
addr
;

1945 
	}
}

1950 
	$unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

1951 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

1953 
Êags
;

1954 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1956 
	`INC_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

1958 
domaö
 = 
	`gë_domaö
(
dev
);

1959 i‡(
	`IS_ERR
(
domaö
))

1962 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1964 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
dú
);

1966 
	`iommu_Êush_com∂ëe
(
domaö
);

1968 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1969 
	}
}

1975 
	$m≠_sg_no_iommu
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1976 
√Àms
, 
dú
)

1978 
sˇâîli°
 *
s
;

1979 
i
;

1981 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1982 
s
->
dma_addªss
 = (
dma_addr_t
)
	`sg_phys
(s);

1983 
s
->
dma_Àngth
 = s->
Àngth
;

1986  
√Àms
;

1987 
	}
}

1993 
	$m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1994 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1995 
dma_©ås
 *
©ås
)

1997 
Êags
;

1998 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1999 
i
;

2000 
sˇâîli°
 *
s
;

2001 
phys_addr_t
 
∑ddr
;

2002 
m≠≥d_ñems
 = 0;

2003 
u64
 
dma_mask
;

2005 
	`INC_STATS_COUNTER
(
˙t_m≠_sg
);

2007 
domaö
 = 
	`gë_domaö
(
dev
);

2008 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

2009  
	`m≠_sg_no_iommu
(
dev
, 
sgli°
, 
√Àms
, 
dú
);

2010 i‡(
	`IS_ERR
(
domaö
))

2013 
dma_mask
 = *
dev
->dma_mask;

2015 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2017 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2018 
∑ddr
 = 
	`sg_phys
(
s
);

2020 
s
->
dma_addªss
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
,

2021 
∑ddr
, 
s
->
Àngth
, 
dú
, 
Ál£
,

2022 
dma_mask
);

2024 i‡(
s
->
dma_addªss
) {

2025 
s
->
dma_Àngth
 = s->
Àngth
;

2026 
m≠≥d_ñems
++;

2028 
unm≠
;

2031 
	`iommu_Êush_com∂ëe
(
domaö
);

2033 
out
:

2034 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2036  
m≠≥d_ñems
;

2037 
unm≠
:

2038 
	`f‹_óch_sg
(
sgli°
, 
s
, 
m≠≥d_ñems
, 
i
) {

2039 i‡(
s
->
dma_addªss
)

2040 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2041 
s
->
dma_Àngth
, 
dú
);

2042 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2045 
m≠≥d_ñems
 = 0;

2047 
out
;

2048 
	}
}

2054 
	$unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

2055 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

2056 
dma_©ås
 *
©ås
)

2058 
Êags
;

2059 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2060 
sˇâîli°
 *
s
;

2061 
i
;

2063 
	`INC_STATS_COUNTER
(
˙t_unm≠_sg
);

2065 
domaö
 = 
	`gë_domaö
(
dev
);

2066 i‡(
	`IS_ERR
(
domaö
))

2069 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2071 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2072 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2073 
s
->
dma_Àngth
, 
dú
);

2074 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2077 
	`iommu_Êush_com∂ëe
(
domaö
);

2079 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2080 
	}
}

2085 *
	$Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2086 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

2088 
Êags
;

2089 *
vút_addr
;

2090 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2091 
phys_addr_t
 
∑ddr
;

2092 
u64
 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2094 
	`INC_STATS_COUNTER
(
˙t_Æloc_cohîít
);

2096 
domaö
 = 
	`gë_domaö
(
dev
);

2097 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
) {

2098 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2099 *
dma_addr
 = 
	`__∑
(
vút_addr
);

2100  
vút_addr
;

2101 } i‡(
	`IS_ERR
(
domaö
))

2102  
NULL
;

2104 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2105 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

2106 
Êag
 |
__GFP_ZERO
;

2108 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2109 i‡(!
vút_addr
)

2110  
NULL
;

2112 
∑ddr
 = 
	`vút_to_phys
(
vút_addr
);

2114 i‡(!
dma_mask
)

2115 
dma_mask
 = *
dev
->dma_mask;

2117 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2119 *
dma_addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
,

2120 
size
, 
DMA_BIDIRECTIONAL
, 
åue
, 
dma_mask
);

2122 i‡(*
dma_addr
 =
DMA_ERROR_CODE
) {

2123 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2124 
out_‰ì
;

2127 
	`iommu_Êush_com∂ëe
(
domaö
);

2129 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2131  
vút_addr
;

2133 
out_‰ì
:

2135 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2137  
NULL
;

2138 
	}
}

2143 
	$‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2144 *
vút_addr
, 
dma_addr_t
 
dma_addr
)

2146 
Êags
;

2147 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2149 
	`INC_STATS_COUNTER
(
˙t_‰ì_cohîít
);

2151 
domaö
 = 
	`gë_domaö
(
dev
);

2152 i‡(
	`IS_ERR
(
domaö
))

2153 
‰ì_mem
;

2155 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2157 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

2159 
	`iommu_Êush_com∂ëe
(
domaö
);

2161 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2163 
‰ì_mem
:

2164 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2165 
	}
}

2171 
	$amd_iommu_dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

2173  
	`check_devi˚
(
dev
);

2174 
	}
}

2183 
	$¥óŒoc_¥Ÿe˘i⁄_domaös
()

2185 
pci_dev
 *
dev
 = 
NULL
;

2186 
dma_›s_domaö
 *
dma_dom
;

2187 
u16
 
devid
;

2189 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2192 i‡(!
	`check_devi˚
(&
dev
->dev))

2196 i‡(
	`domaö_f‹_devi˚
(&
dev
->dev))

2199 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2201 
dma_dom
 = 
	`dma_›s_domaö_Æloc
();

2202 i‡(!
dma_dom
)

2204 
	`öô_unôy_m≠pögs_f‹_devi˚
(
dma_dom
, 
devid
);

2205 
dma_dom
->
èrgë_dev
 = 
devid
;

2207 
	`©èch_devi˚
(&
dev
->dev, &
dma_dom
->
domaö
);

2209 
	`li°_add_èû
(&
dma_dom
->
li°
, &
iommu_pd_li°
);

2211 
	}
}

2213 
dma_m≠_›s
 
	gamd_iommu_dma_›s
 = {

2214 .
Æloc_cohîít
 =álloc_coherent,

2215 .
	g‰ì_cohîít
 = 
‰ì_cohîít
,

2216 .
	gm≠_∑ge
 = 
m≠_∑ge
,

2217 .
	gunm≠_∑ge
 = 
unm≠_∑ge
,

2218 .
	gm≠_sg
 = 
m≠_sg
,

2219 .
	gunm≠_sg
 = 
unm≠_sg
,

2220 .
	gdma_suµ‹ãd
 = 
amd_iommu_dma_suµ‹ãd
,

2227 
__öô
 
	$amd_iommu_öô_≠i
()

2229 
	`ªgi°î_iommu
(&
amd_iommu_›s
);

2230 
	}
}

2232 
__öô
 
	$amd_iommu_öô_dma_›s
()

2234 
amd_iommu
 *
iommu
;

2235 
ªt
;

2242 
	`f‹_óch_iommu
(
iommu
) {

2243 
iommu
->
deÁu…_dom
 = 
	`dma_›s_domaö_Æloc
();

2244 i‡(
iommu
->
deÁu…_dom
 =
NULL
)

2245  -
ENOMEM
;

2246 
iommu
->
deÁu…_dom
->
domaö
.
Êags
 |
PD_DEFAULT_MASK
;

2247 
ªt
 = 
	`iommu_öô_unôy_m≠pögs
(
iommu
);

2248 i‡(
ªt
)

2249 
‰ì_domaös
;

2255 
	`¥óŒoc_¥Ÿe˘i⁄_domaös
();

2257 
iommu_dëe˘ed
 = 1;

2258 
swiŸlb
 = 0;

2259 #ifde‡
CONFIG_GART_IOMMU


2260 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

2261 
g¨t_iommu_≠îtuª
 = 0;

2265 
dma_›s
 = &
amd_iommu_dma_›s
;

2267 
	`amd_iommu_°©s_öô
();

2271 
‰ì_domaös
:

2273 
	`f‹_óch_iommu
(
iommu
) {

2274 i‡(
iommu
->
deÁu…_dom
)

2275 
	`dma_›s_domaö_‰ì
(
iommu
->
deÁu…_dom
);

2278  
ªt
;

2279 
	}
}

2291 
	$˛ónup_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2293 
iommu_dev_d©a
 *
dev_d©a
, *
√xt
;

2294 
Êags
;

2296 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2298 
	`li°_f‹_óch_íåy_ß„
(
dev_d©a
, 
√xt
, &
domaö
->
dev_li°
, 
li°
) {

2299 
devi˚
 *
dev
 = 
dev_d©a
->dev;

2301 
	`do_dëach
(
dev
);

2302 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

2305 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2306 
	}
}

2308 
	$¥Ÿe˘i⁄_domaö_‰ì
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2310 i‡(!
domaö
)

2313 
	`dñ_domaö_‰om_li°
(
domaö
);

2315 i‡(
domaö
->
id
)

2316 
	`domaö_id_‰ì
(
domaö
->
id
);

2318 
	`k‰ì
(
domaö
);

2319 
	}
}

2321 
¥Ÿe˘i⁄_domaö
 *
	$¥Ÿe˘i⁄_domaö_Æloc
()

2323 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2325 
domaö
 = 
	`kzÆloc
((*domaö), 
GFP_KERNEL
);

2326 i‡(!
domaö
)

2327  
NULL
;

2329 
	`•ö_lock_öô
(&
domaö
->
lock
);

2330 
domaö
->
id
 = 
	`domaö_id_Æloc
();

2331 i‡(!
domaö
->
id
)

2332 
out_îr
;

2333 
	`INIT_LIST_HEAD
(&
domaö
->
dev_li°
);

2335 
	`add_domaö_to_li°
(
domaö
);

2337  
domaö
;

2339 
out_îr
:

2340 
	`k‰ì
(
domaö
);

2342  
NULL
;

2343 
	}
}

2345 
	$amd_iommu_domaö_öô
(
iommu_domaö
 *
dom
)

2347 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2349 
domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2350 i‡(!
domaö
)

2351 
out_‰ì
;

2353 
domaö
->
mode
 = 
PAGE_MODE_3_LEVEL
;

2354 
domaö
->
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

2355 i‡(!
domaö
->
±_roŸ
)

2356 
out_‰ì
;

2358 
dom
->
¥iv
 = 
domaö
;

2362 
out_‰ì
:

2363 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2365  -
ENOMEM
;

2366 
	}
}

2368 
	$amd_iommu_domaö_de°roy
(
iommu_domaö
 *
dom
)

2370 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2372 i‡(!
domaö
)

2375 i‡(
domaö
->
dev_˙t
 > 0)

2376 
	`˛ónup_domaö
(
domaö
);

2378 
	`BUG_ON
(
domaö
->
dev_˙t
 != 0);

2380 
	`‰ì_∑gëabÀ
(
domaö
);

2382 
	`domaö_id_‰ì
(
domaö
->
id
);

2384 
	`k‰ì
(
domaö
);

2386 
dom
->
¥iv
 = 
NULL
;

2387 
	}
}

2389 
	$amd_iommu_dëach_devi˚
(
iommu_domaö
 *
dom
,

2390 
devi˚
 *
dev
)

2392 
iommu_dev_d©a
 *
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2393 
amd_iommu
 *
iommu
;

2394 
u16
 
devid
;

2396 i‡(!
	`check_devi˚
(
dev
))

2399 
devid
 = 
	`gë_devi˚_id
(
dev
);

2401 i‡(
dev_d©a
->
domaö
 !
NULL
)

2402 
	`dëach_devi˚
(
dev
);

2404 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2405 i‡(!
iommu
)

2408 
	`iommu_Êush_devi˚
(
dev
);

2409 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2410 
	}
}

2412 
	$amd_iommu_©èch_devi˚
(
iommu_domaö
 *
dom
,

2413 
devi˚
 *
dev
)

2415 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2416 
iommu_dev_d©a
 *
dev_d©a
;

2417 
amd_iommu
 *
iommu
;

2418 
ªt
;

2419 
u16
 
devid
;

2421 i‡(!
	`check_devi˚
(
dev
))

2422  -
EINVAL
;

2424 
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2426 
devid
 = 
	`gë_devi˚_id
(
dev
);

2428 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2429 i‡(!
iommu
)

2430  -
EINVAL
;

2432 i‡(
dev_d©a
->
domaö
)

2433 
	`dëach_devi˚
(
dev
);

2435 
ªt
 = 
	`©èch_devi˚
(
dev
, 
domaö
);

2437 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2439  
ªt
;

2440 
	}
}

2442 
	$amd_iommu_m≠_ønge
(
iommu_domaö
 *
dom
,

2443 
iova
, 
phys_addr_t
 
∑ddr
,

2444 
size_t
 
size
, 
iommu_¥Ÿ
)

2446 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2447 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

2448 
¥Ÿ
 = 0;

2449 
ªt
;

2451 i‡(
iommu_¥Ÿ
 & 
IOMMU_READ
)

2452 
¥Ÿ
 |
IOMMU_PROT_IR
;

2453 i‡(
iommu_¥Ÿ
 & 
IOMMU_WRITE
)

2454 
¥Ÿ
 |
IOMMU_PROT_IW
;

2456 
iova
 &
PAGE_MASK
;

2457 
∑ddr
 &
PAGE_MASK
;

2459 
i
 = 0; i < 
≈ages
; ++i) {

2460 
ªt
 = 
	`iommu_m≠_∑ge
(
domaö
, 
iova
, 
∑ddr
, 
¥Ÿ
, 
PM_MAP_4k
);

2461 i‡(
ªt
)

2462  
ªt
;

2464 
iova
 +
PAGE_SIZE
;

2465 
∑ddr
 +
PAGE_SIZE
;

2469 
	}
}

2471 
	$amd_iommu_unm≠_ønge
(
iommu_domaö
 *
dom
,

2472 
iova
, 
size_t
 
size
)

2475 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2476 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
iova
, 
size
, 
PAGE_SIZE
);

2478 
iova
 &
PAGE_MASK
;

2480 
i
 = 0; i < 
≈ages
; ++i) {

2481 
	`iommu_unm≠_∑ge
(
domaö
, 
iova
, 
PM_MAP_4k
);

2482 
iova
 +
PAGE_SIZE
;

2485 
	`iommu_Êush_éb_pde
(
domaö
);

2486 
	}
}

2488 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaö
 *
dom
,

2489 
iova
)

2491 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2492 
off£t
 = 
iova
 & ~
PAGE_MASK
;

2493 
phys_addr_t
 
∑ddr
;

2494 
u64
 *
±e
;

2496 
±e
 = 
	`„tch_±e
(
domaö
, 
iova
, 
PM_MAP_4k
);

2498 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

2501 
∑ddr
 = *
±e
 & 
IOMMU_PAGE_MASK
;

2502 
∑ddr
 |
off£t
;

2504  
∑ddr
;

2505 
	}
}

2507 
	$amd_iommu_domaö_has_ˇp
(
iommu_domaö
 *
domaö
,

2508 
ˇp
)

2511 
	}
}

2513 
iommu_›s
 
	gamd_iommu_›s
 = {

2514 .
domaö_öô
 = 
amd_iommu_domaö_öô
,

2515 .
	gdomaö_de°roy
 = 
amd_iommu_domaö_de°roy
,

2516 .
	g©èch_dev
 = 
amd_iommu_©èch_devi˚
,

2517 .
	gdëach_dev
 = 
amd_iommu_dëach_devi˚
,

2518 .
	gm≠
 = 
amd_iommu_m≠_ønge
,

2519 .
	gunm≠
 = 
amd_iommu_unm≠_ønge
,

2520 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

2521 .
	gdomaö_has_ˇp
 = 
amd_iommu_domaö_has_ˇp
,

2534 
__öô
 
	$amd_iommu_öô_∑s°hrough
()

2536 
amd_iommu
 *
iommu
;

2537 
pci_dev
 *
dev
 = 
NULL
;

2538 
u16
 
devid
;

2541 
±_domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2542 i‡(!
±_domaö
)

2543  -
ENOMEM
;

2545 
±_domaö
->
mode
 |
PAGE_MODE_NONE
;

2547 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2549 i‡(!
	`check_devi˚
(&
dev
->dev))

2552 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2554 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2555 i‡(!
iommu
)

2558 
	`©èch_devi˚
(&
dev
->dev, 
±_domaö
);

2561 
	`¥_öfo
("AMD-Vi: Initialized for Passthrough Mode\n");

2564 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<löux/pci.h
>

21 
	~<löux/a˝i.h
>

22 
	~<löux/gÂ.h
>

23 
	~<löux/li°.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/msi.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/amd_iommu_¥Ÿo.h
>

29 
	~<asm/amd_iommu_ty≥s.h
>

30 
	~<asm/amd_iommu.h
>

31 
	~<asm/iommu.h
>

32 
	~<asm/g¨t.h
>

33 
	~<asm/x86_öô.h
>

38 
	#IVRS_HEADER_LENGTH
 48

	)

40 
	#ACPI_IVHD_TYPE
 0x10

	)

41 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

42 
	#ACPI_IVMD_TYPE
 0x21

	)

43 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

45 
	#IVHD_DEV_ALL
 0x01

	)

46 
	#IVHD_DEV_SELECT
 0x02

	)

47 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

48 
	#IVHD_DEV_RANGE_END
 0x04

	)

49 
	#IVHD_DEV_ALIAS
 0x42

	)

50 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

51 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

52 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

54 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

55 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

56 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

57 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

59 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

60 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

62 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

63 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

64 
	#ACPI_DEVFLAG_NMI
 0x04

	)

65 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

66 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

67 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

68 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

69 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

82 
	sivhd_hódî
 {

83 
u8
 
	mty≥
;

84 
u8
 
	mÊags
;

85 
u16
 
	mÀngth
;

86 
u16
 
	mdevid
;

87 
u16
 
	mˇp_±r
;

88 
u64
 
	mmmio_phys
;

89 
u16
 
	mpci_£g
;

90 
u16
 
	möfo
;

91 
u32
 
	mª£rved
;

92 } 
__©åibuã__
((
∑cked
));

98 
	sivhd_íåy
 {

99 
u8
 
	mty≥
;

100 
u16
 
	mdevid
;

101 
u8
 
	mÊags
;

102 
u32
 
	mext
;

103 } 
__©åibuã__
((
∑cked
));

109 
	sivmd_hódî
 {

110 
u8
 
	mty≥
;

111 
u8
 
	mÊags
;

112 
u16
 
	mÀngth
;

113 
u16
 
	mdevid
;

114 
u16
 
	maux
;

115 
u64
 
	mªsv
;

116 
u64
 
	mønge_°¨t
;

117 
u64
 
	mønge_Àngth
;

118 } 
__©åibuã__
((
∑cked
));

120 
boﬁ
 
	gamd_iommu_dump
;

122 
__öôd©a
 
	gamd_iommu_dëe˘ed
;

124 
u16
 
	gamd_iommu_œ°_bdf
;

126 
LIST_HEAD
(
amd_iommu_unôy_m≠
);

128 
boﬁ
 
	gamd_iommu_unm≠_Êush
;

130 
LIST_HEAD
(
amd_iommu_li°
);

134 
amd_iommu
 *
	gamd_iommus
[
MAX_IOMMUS
];

135 
	gamd_iommus_¥e£¡
;

138 
boﬁ
 
amd_iommu_≈_ˇche
 
	g__ªad_mo°ly
;

143 
boﬁ
 
	gamd_iommu_öôülized
;

148 
LIST_HEAD
(
amd_iommu_pd_li°
);

149 
•ölock_t
 
	gamd_iommu_pd_lock
;

157 
dev_èbÀ_íåy
 *
	gamd_iommu_dev_èbÀ
;

164 
u16
 *
	gamd_iommu_Æüs_èbÀ
;

170 
amd_iommu
 **
	gamd_iommu_æookup_èbÀ
;

176 *
	gamd_iommu_pd_Æloc_bôm≠
;

178 
u32
 
	gdev_èbÀ_size
;

179 
u32
 
	gÆüs_èbÀ_size
;

180 
u32
 
	gæookup_èbÀ_size
;

182 
ölöe
 
	$upd©e_œ°_devid
(
u16
 
devid
)

184 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

185 
amd_iommu_œ°_bdf
 = 
devid
;

186 
	}
}

188 
ölöe
 
	$tbl_size
(
íåy_size
)

190 
shi·
 = 
PAGE_SHIFT
 +

191 
	`gë_‹dî
((()
amd_iommu_œ°_bdf
 + 1Ë* 
íåy_size
);

193  1UL << 
shi·
;

194 
	}
}

209 
	$iommu_£t_ex˛usi⁄_ønge
(
amd_iommu
 *
iommu
)

211 
u64
 
°¨t
 = 
iommu
->
ex˛usi⁄_°¨t
 & 
PAGE_MASK
;

212 
u64
 
limô
 = (
°¨t
 + 
iommu
->
ex˛usi⁄_Àngth
Ë& 
PAGE_MASK
;

213 
u64
 
íåy
;

215 i‡(!
iommu
->
ex˛usi⁄_°¨t
)

218 
íåy
 = 
°¨t
 | 
MMIO_EXCL_ENABLE_MASK
;

219 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

220 &
íåy
, (entry));

222 
íåy
 = 
limô
;

223 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

224 &
íåy
, (entry));

225 
	}
}

228 
__öô
 
	$iommu_£t_devi˚_èbÀ
(
amd_iommu
 *
iommu
)

230 
u64
 
íåy
;

232 
	`BUG_ON
(
iommu
->
mmio_ba£
 =
NULL
);

234 
íåy
 = 
	`vút_to_phys
(
amd_iommu_dev_èbÀ
);

235 
íåy
 |(
dev_èbÀ_size
 >> 12) - 1;

236 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

237 &
íåy
, (entry));

238 
	}
}

241 
	$iommu_„©uª_íabÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

243 
u32
 
˘æ
;

245 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

246 
˘æ
 |(1 << 
bô
);

247 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

248 
	}
}

250 
	$iommu_„©uª_dißbÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

252 
u32
 
˘æ
;

254 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

255 
˘æ
 &~(1 << 
bô
);

256 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

257 
	}
}

260 
	$iommu_íabÀ
(
amd_iommu
 *
iommu
)

262 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Enabling IOMMUát %s cap 0x%hx\n",

263 
	`dev_«me
(&
iommu
->
dev
->dev), iommu->
ˇp_±r
);

265 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

266 
	}
}

268 
	$iommu_dißbÀ
(
amd_iommu
 *
iommu
)

271 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

274 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

275 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

278 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

279 
	}
}

285 
u8
 * 
__öô
 
	$iommu_m≠_mmio_•a˚
(
u64
 
addªss
)

287 
u8
 *
ªt
;

289 i‡(!
	`ªque°_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
, "amd_iommu"))

290  
NULL
;

292 
ªt
 = 
	`i‹em≠_noˇche
(
addªss
, 
MMIO_REGION_LENGTH
);

293 i‡(
ªt
 !
NULL
)

294  
ªt
;

296 
	`ªÀa£_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
);

298  
NULL
;

299 
	}
}

301 
__öô
 
	$iommu_unm≠_mmio_•a˚
(
amd_iommu
 *
iommu
)

303 i‡(
iommu
->
mmio_ba£
)

304 
	`iounm≠
(
iommu
->
mmio_ba£
);

305 
	`ªÀa£_mem_ªgi⁄
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

306 
	}
}

320 
ölöe
 
	$ivhd_íåy_Àngth
(
u8
 *
ivhd
)

322  0x04 << (*
ivhd
 >> 6);

323 
	}
}

329 
__öô
 
	$föd_œ°_devid_⁄_pci
(
bus
, 
dev
, 
‚
, 
ˇp_±r
)

331 
u32
 
ˇp
;

333 
ˇp
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 
‚
, 
ˇp_±r
+
MMIO_RANGE_OFFSET
);

334 
	`upd©e_œ°_devid
(
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ˇp
), 
	`MMIO_GET_LD
(cap)));

337 
	}
}

343 
__öô
 
	$föd_œ°_devid_‰om_ivhd
(
ivhd_hódî
 *
h
)

345 
u8
 *
p
 = (*)
h
, *
íd
 = (*)h;

346 
ivhd_íåy
 *
dev
;

348 
p
 +(*
h
);

349 
íd
 +
h
->
Àngth
;

351 
	`föd_œ°_devid_⁄_pci
(
	`PCI_BUS
(
h
->
devid
),

352 
	`PCI_SLOT
(
h
->
devid
),

353 
	`PCI_FUNC
(
h
->
devid
),

354 
h
->
ˇp_±r
);

356 
p
 < 
íd
) {

357 
dev
 = (
ivhd_íåy
 *)
p
;

358 
dev
->
ty≥
) {

359 
IVHD_DEV_SELECT
:

360 
IVHD_DEV_RANGE_END
:

361 
IVHD_DEV_ALIAS
:

362 
IVHD_DEV_EXT_SELECT
:

364 
	`upd©e_œ°_devid
(
dev
->
devid
);

369 
p
 +
	`ivhd_íåy_Àngth
(p);

372 
	`WARN_ON
(
p
 !
íd
);

375 
	}
}

382 
__öô
 
	$föd_œ°_devid_a˝i
(
a˝i_èbÀ_hódî
 *
èbÀ
)

384 
i
;

385 
u8
 
checksum
 = 0, *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

386 
ivhd_hódî
 *
h
;

392 
i
 = 0; i < 
èbÀ
->
Àngth
; ++i)

393 
checksum
 +
p
[
i
];

394 i‡(
checksum
 != 0)

396  -
ENODEV
;

398 
p
 +
IVRS_HEADER_LENGTH
;

400 
íd
 +
èbÀ
->
Àngth
;

401 
p
 < 
íd
) {

402 
h
 = (
ivhd_hódî
 *)
p
;

403 
h
->
ty≥
) {

404 
ACPI_IVHD_TYPE
:

405 
	`föd_œ°_devid_‰om_ivhd
(
h
);

410 
p
 +
h
->
Àngth
;

412 
	`WARN_ON
(
p
 !
íd
);

415 
	}
}

431 
u8
 * 
__öô
 
	$Æloc_comm™d_buf„r
(
amd_iommu
 *
iommu
)

433 
u8
 *
cmd_buf
 = (u8 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

434 
	`gë_‹dî
(
CMD_BUFFER_SIZE
));

436 i‡(
cmd_buf
 =
NULL
)

437  
NULL
;

439 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
;

441  
cmd_buf
;

442 
	}
}

448 
	$amd_iommu_ª£t_cmd_buf„r
(
amd_iommu
 *
iommu
)

450 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

452 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

453 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

455 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

456 
	}
}

462 
	$iommu_íabÀ_comm™d_buf„r
(
amd_iommu
 *
iommu
)

464 
u64
 
íåy
;

466 
	`BUG_ON
(
iommu
->
cmd_buf
 =
NULL
);

468 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
cmd_buf
);

469 
íåy
 |
MMIO_CMD_SIZE_512
;

471 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

472 &
íåy
, (entry));

474 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

475 
	}
}

477 
__öô
 
	$‰ì_comm™d_buf„r
(
amd_iommu
 *
iommu
)

479 
	`‰ì_∑ges
(()
iommu
->
cmd_buf
,

480 
	`gë_‹dî
(
iommu
->
cmd_buf_size
));

481 
	}
}

484 
u8
 * 
__öô
 
	$Æloc_evít_buf„r
(
amd_iommu
 *
iommu
)

486 
iommu
->
evt_buf
 = (
u8
 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

487 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

489 i‡(
iommu
->
evt_buf
 =
NULL
)

490  
NULL
;

492 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

494  
iommu
->
evt_buf
;

495 
	}
}

497 
	$iommu_íabÀ_evít_buf„r
(
amd_iommu
 *
iommu
)

499 
u64
 
íåy
;

501 
	`BUG_ON
(
iommu
->
evt_buf
 =
NULL
);

503 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
evt_buf
Ë| 
EVT_LEN_MASK
;

505 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

506 &
íåy
, (entry));

509 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

510 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

512 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

513 
	}
}

515 
__öô
 
	$‰ì_evít_buf„r
(
amd_iommu
 *
iommu
)

517 
	`‰ì_∑ges
(()
iommu
->
evt_buf
, 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

518 
	}
}

521 
	$£t_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

523 
i
 = (
bô
 >> 5) & 0x07;

524 
_bô
 = 
bô
 & 0x1f;

526 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] |(1 << 
_bô
);

527 
	}
}

529 
	$gë_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

531 
i
 = (
bô
 >> 5) & 0x07;

532 
_bô
 = 
bô
 & 0x1f;

534  (
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] & (1 << 
_bô
)) >> _bit;

535 
	}
}

538 
	$amd_iommu_≠∂y_îøtum_63
(
u16
 
devid
)

540 
sysmgt
;

542 
sysmgt
 = 
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
) |

543 (
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
) << 1);

545 i‡(
sysmgt
 == 0x01)

546 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_IW
);

547 
	}
}

550 
__öô
 
	$£t_iommu_f‹_devi˚
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

552 
amd_iommu_æookup_èbÀ
[
devid
] = 
iommu
;

553 
	}
}

559 
__öô
 
	$£t_dev_íåy_‰om_a˝i
(
amd_iommu
 *
iommu
,

560 
u16
 
devid
, 
u32
 
Êags
, u32 
ext_Êags
)

562 i‡(
Êags
 & 
ACPI_DEVFLAG_INITPASS
)

563 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_INIT_PASS
);

564 i‡(
Êags
 & 
ACPI_DEVFLAG_EXTINT
)

565 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_EINT_PASS
);

566 i‡(
Êags
 & 
ACPI_DEVFLAG_NMI
)

567 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_NMI_PASS
);

568 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT1
)

569 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
);

570 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT2
)

571 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
);

572 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT0
)

573 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

574 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT1
)

575 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

577 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

579 
	`£t_iommu_f‹_devi˚
(
iommu
, 
devid
);

580 
	}
}

586 
__öô
 
	$£t_devi˚_ex˛usi⁄_ønge
(
u16
 
devid
, 
ivmd_hódî
 *
m
)

588 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

590 i‡(!(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
))

593 i‡(
iommu
) {

599 
	`£t_dev_íåy_bô
(
m
->
devid
, 
DEV_ENTRY_EX
);

600 
iommu
->
ex˛usi⁄_°¨t
 = 
m
->
ønge_°¨t
;

601 
iommu
->
ex˛usi⁄_Àngth
 = 
m
->
ønge_Àngth
;

603 
	}
}

610 
__öô
 
	$öô_iommu_‰om_pci
(
amd_iommu
 *
iommu
)

612 
ˇp_±r
 = 
iommu
->cap_ptr;

613 
u32
 
ønge
, 
misc
;

615 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

616 &
iommu
->
ˇp
);

617 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_RANGE_OFFSET
,

618 &
ønge
);

619 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_MISC_OFFSET
,

620 &
misc
);

622 
iommu
->
fú°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

623 
	`MMIO_GET_FD
(
ønge
));

624 
iommu
->
œ°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

625 
	`MMIO_GET_LD
(
ønge
));

626 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

627 
	}
}

633 
__öô
 
	$öô_iommu_‰om_a˝i
(
amd_iommu
 *
iommu
,

634 
ivhd_hódî
 *
h
)

636 
u8
 *
p
 = (u8 *)
h
;

637 
u8
 *
íd
 = 
p
, 
Êags
 = 0;

638 
u16
 
dev_i
, 
devid
 = 0, 
devid_°¨t
 = 0, 
devid_to
 = 0;

639 
u32
 
ext_Êags
 = 0;

640 
boﬁ
 
Æüs
 = 
Ál£
;

641 
ivhd_íåy
 *
e
;

647 
h
->
Êags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

648 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_HT_TUN_EN
) :

649 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_HT_TUN_EN
);

651 
h
->
Êags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

652 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_PASSPW_EN
) :

653 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_PASSPW_EN
);

655 
h
->
Êags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

656 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

657 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
);

659 
h
->
Êags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

660 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_ISOC_EN
) :

661 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_ISOC_EN
);

666 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_COHERENT_EN
);

671 
p
 +(
ivhd_hódî
);

672 
íd
 +
h
->
Àngth
;

675 
p
 < 
íd
) {

676 
e
 = (
ivhd_íåy
 *)
p
;

677 
e
->
ty≥
) {

678 
IVHD_DEV_ALL
:

680 
	`DUMP_¥ötk
(" DEV_ALL\t\t\t first devid: %02x:%02x.%x"

682 
	`PCI_BUS
(
iommu
->
fú°_devi˚
),

683 
	`PCI_SLOT
(
iommu
->
fú°_devi˚
),

684 
	`PCI_FUNC
(
iommu
->
fú°_devi˚
),

685 
	`PCI_BUS
(
iommu
->
œ°_devi˚
),

686 
	`PCI_SLOT
(
iommu
->
œ°_devi˚
),

687 
	`PCI_FUNC
(
iommu
->
œ°_devi˚
),

688 
e
->
Êags
);

690 
dev_i
 = 
iommu
->
fú°_devi˚
;

691 
dev_i
 <
iommu
->
œ°_devi˚
; ++dev_i)

692 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

693 
e
->
Êags
, 0);

695 
IVHD_DEV_SELECT
:

697 
	`DUMP_¥ötk
(" DEV_SELECT\t\t\t devid: %02x:%02x.%x "

699 
	`PCI_BUS
(
e
->
devid
),

700 
	`PCI_SLOT
(
e
->
devid
),

701 
	`PCI_FUNC
(
e
->
devid
),

702 
e
->
Êags
);

704 
devid
 = 
e
->devid;

705 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
, 0);

707 
IVHD_DEV_SELECT_RANGE_START
:

709 
	`DUMP_¥ötk
(" DEV_SELECT_RANGE_START\t "

711 
	`PCI_BUS
(
e
->
devid
),

712 
	`PCI_SLOT
(
e
->
devid
),

713 
	`PCI_FUNC
(
e
->
devid
),

714 
e
->
Êags
);

716 
devid_°¨t
 = 
e
->
devid
;

717 
Êags
 = 
e
->flags;

718 
ext_Êags
 = 0;

719 
Æüs
 = 
Ál£
;

721 
IVHD_DEV_ALIAS
:

723 
	`DUMP_¥ötk
(" DEV_ALIAS\t\t\t devid: %02x:%02x.%x "

725 
	`PCI_BUS
(
e
->
devid
),

726 
	`PCI_SLOT
(
e
->
devid
),

727 
	`PCI_FUNC
(
e
->
devid
),

728 
e
->
Êags
,

729 
	`PCI_BUS
(
e
->
ext
 >> 8),

730 
	`PCI_SLOT
(
e
->
ext
 >> 8),

731 
	`PCI_FUNC
(
e
->
ext
 >> 8));

733 
devid
 = 
e
->devid;

734 
devid_to
 = 
e
->
ext
 >> 8;

735 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
 , 
e
->
Êags
, 0);

736 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid_to
, 
e
->
Êags
, 0);

737 
amd_iommu_Æüs_èbÀ
[
devid
] = 
devid_to
;

739 
IVHD_DEV_ALIAS_RANGE
:

741 
	`DUMP_¥ötk
(" DEV_ALIAS_RANGE\t\t "

744 
	`PCI_BUS
(
e
->
devid
),

745 
	`PCI_SLOT
(
e
->
devid
),

746 
	`PCI_FUNC
(
e
->
devid
),

747 
e
->
Êags
,

748 
	`PCI_BUS
(
e
->
ext
 >> 8),

749 
	`PCI_SLOT
(
e
->
ext
 >> 8),

750 
	`PCI_FUNC
(
e
->
ext
 >> 8));

752 
devid_°¨t
 = 
e
->
devid
;

753 
Êags
 = 
e
->flags;

754 
devid_to
 = 
e
->
ext
 >> 8;

755 
ext_Êags
 = 0;

756 
Æüs
 = 
åue
;

758 
IVHD_DEV_EXT_SELECT
:

760 
	`DUMP_¥ötk
(" DEV_EXT_SELECT\t\t devid: %02x:%02x.%x "

762 
	`PCI_BUS
(
e
->
devid
),

763 
	`PCI_SLOT
(
e
->
devid
),

764 
	`PCI_FUNC
(
e
->
devid
),

765 
e
->
Êags
,É->
ext
);

767 
devid
 = 
e
->devid;

768 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
,

769 
e
->
ext
);

771 
IVHD_DEV_EXT_SELECT_RANGE
:

773 
	`DUMP_¥ötk
(" DEV_EXT_SELECT_RANGE\t devid: "

775 
	`PCI_BUS
(
e
->
devid
),

776 
	`PCI_SLOT
(
e
->
devid
),

777 
	`PCI_FUNC
(
e
->
devid
),

778 
e
->
Êags
,É->
ext
);

780 
devid_°¨t
 = 
e
->
devid
;

781 
Êags
 = 
e
->flags;

782 
ext_Êags
 = 
e
->
ext
;

783 
Æüs
 = 
Ál£
;

785 
IVHD_DEV_RANGE_END
:

787 
	`DUMP_¥ötk
(" DEV_RANGE_END\t\t devid: %02x:%02x.%x\n",

788 
	`PCI_BUS
(
e
->
devid
),

789 
	`PCI_SLOT
(
e
->
devid
),

790 
	`PCI_FUNC
(
e
->
devid
));

792 
devid
 = 
e
->devid;

793 
dev_i
 = 
devid_°¨t
; dev_ò<
devid
; ++dev_i) {

794 i‡(
Æüs
) {

795 
amd_iommu_Æüs_èbÀ
[
dev_i
] = 
devid_to
;

796 
	`£t_dev_íåy_‰om_a˝i
(
iommu
,

797 
devid_to
, 
Êags
, 
ext_Êags
);

799 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

800 
Êags
, 
ext_Êags
);

807 
p
 +
	`ivhd_íåy_Àngth
(p);

809 
	}
}

812 
__öô
 
	$öô_iommu_devi˚s
(
amd_iommu
 *
iommu
)

814 
u16
 
i
;

816 
i
 = 
iommu
->
fú°_devi˚
; i <iommu->
œ°_devi˚
; ++i)

817 
	`£t_iommu_f‹_devi˚
(
iommu
, 
i
);

820 
	}
}

822 
__öô
 
	$‰ì_iommu_⁄e
(
amd_iommu
 *
iommu
)

824 
	`‰ì_comm™d_buf„r
(
iommu
);

825 
	`‰ì_evít_buf„r
(
iommu
);

826 
	`iommu_unm≠_mmio_•a˚
(
iommu
);

827 
	}
}

829 
__öô
 
	$‰ì_iommu_Æl
()

831 
amd_iommu
 *
iommu
, *
√xt
;

833 
	`f‹_óch_iommu_ß„
(
iommu
, 
√xt
) {

834 
	`li°_dñ
(&
iommu
->
li°
);

835 
	`‰ì_iommu_⁄e
(
iommu
);

836 
	`k‰ì
(
iommu
);

838 
	}
}

845 
__öô
 
	$öô_iommu_⁄e
(
amd_iommu
 *
iommu
, 
ivhd_hódî
 *
h
)

847 
	`•ö_lock_öô
(&
iommu
->
lock
);

850 
	`li°_add_èû
(&
iommu
->
li°
, &
amd_iommu_li°
);

851 
iommu
->
ödex
 = 
amd_iommus_¥e£¡
++;

853 i‡(
	`u∆ikñy
(
iommu
->
ödex
 >
MAX_IOMMUS
)) {

854 
	`WARN
(1, "AMD-Vi: System has more IOMMUsÅhan supported byÅhis driver\n");

855  -
ENOSYS
;

859 
amd_iommus
[
iommu
->
ödex
] = iommu;

864 
iommu
->
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

865 i‡(!
iommu
->
dev
)

868 
iommu
->
ˇp_±r
 = 
h
->cap_ptr;

869 
iommu
->
pci_£g
 = 
h
->pci_seg;

870 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

871 
iommu
->
mmio_ba£
 = 
	`iommu_m≠_mmio_•a˚
(
h
->
mmio_phys
);

872 i‡(!
iommu
->
mmio_ba£
)

873  -
ENOMEM
;

875 
iommu
->
cmd_buf
 = 
	`Æloc_comm™d_buf„r
(iommu);

876 i‡(!
iommu
->
cmd_buf
)

877  -
ENOMEM
;

879 
iommu
->
evt_buf
 = 
	`Æloc_evít_buf„r
(iommu);

880 i‡(!
iommu
->
evt_buf
)

881  -
ENOMEM
;

883 
iommu
->
öt_íabÀd
 = 
Ál£
;

885 
	`öô_iommu_‰om_pci
(
iommu
);

886 
	`öô_iommu_‰om_a˝i
(
iommu
, 
h
);

887 
	`öô_iommu_devi˚s
(
iommu
);

889 i‡(
iommu
->
ˇp
 & (1UL << 
IOMMU_CAP_NPCACHE
))

890 
amd_iommu_≈_ˇche
 = 
åue
;

892  
	`pci_íabÀ_devi˚
(
iommu
->
dev
);

893 
	}
}

899 
__öô
 
	$öô_iommu_Æl
(
a˝i_èbÀ_hódî
 *
èbÀ
)

901 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

902 
ivhd_hódî
 *
h
;

903 
amd_iommu
 *
iommu
;

904 
ªt
;

906 
íd
 +
èbÀ
->
Àngth
;

907 
p
 +
IVRS_HEADER_LENGTH
;

909 
p
 < 
íd
) {

910 
h
 = (
ivhd_hódî
 *)
p
;

911 *
p
) {

912 
ACPI_IVHD_TYPE
:

914 
	`DUMP_¥ötk
("device: %02x:%02x.%01x cap: %04x "

916 
	`PCI_BUS
(
h
->
devid
), 
	`PCI_SLOT
(h->devid),

917 
	`PCI_FUNC
(
h
->
devid
), h->
ˇp_±r
,

918 
h
->
pci_£g
, h->
Êags
, h->
öfo
);

919 
	`DUMP_¥ötk
(" mmio-addr: %016llx\n",

920 
h
->
mmio_phys
);

922 
iommu
 = 
	`kzÆloc
((
amd_iommu
), 
GFP_KERNEL
);

923 i‡(
iommu
 =
NULL
)

924  -
ENOMEM
;

925 
ªt
 = 
	`öô_iommu_⁄e
(
iommu
, 
h
);

926 i‡(
ªt
)

927  
ªt
;

932 
p
 +
h
->
Àngth
;

935 
	`WARN_ON
(
p
 !
íd
);

937 
amd_iommu_öôülized
 = 
åue
;

940 
	}
}

951 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

953 
r
;

955 i‡(
	`pci_íabÀ_msi
(
iommu
->
dev
))

958 
r
 = 
	`ªque°_úq
(
iommu
->
dev
->
úq
, 
amd_iommu_öt_h™dÀr
,

959 
IRQF_SAMPLE_RANDOM
,

961 
NULL
);

963 i‡(
r
) {

964 
	`pci_dißbÀ_msi
(
iommu
->
dev
);

968 
iommu
->
öt_íabÀd
 = 
åue
;

969 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

972 
	}
}

974 
	$iommu_öô_msi
(
amd_iommu
 *
iommu
)

976 i‡(
iommu
->
öt_íabÀd
)

979 i‡(
	`pci_föd_ˇ∑bûôy
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

980  
	`iommu_£tup_msi
(
iommu
);

983 
	}
}

993 
__öô
 
	$‰ì_unôy_m≠s
()

995 
unôy_m≠_íåy
 *
íåy
, *
√xt
;

997 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, &
amd_iommu_unôy_m≠
, 
li°
) {

998 
	`li°_dñ
(&
íåy
->
li°
);

999 
	`k‰ì
(
íåy
);

1001 
	}
}

1004 
__öô
 
	$öô_ex˛usi⁄_ønge
(
ivmd_hódî
 *
m
)

1006 
i
;

1008 
m
->
ty≥
) {

1009 
ACPI_IVMD_TYPE
:

1010 
	`£t_devi˚_ex˛usi⁄_ønge
(
m
->
devid
, m);

1012 
ACPI_IVMD_TYPE_ALL
:

1013 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1014 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1016 
ACPI_IVMD_TYPE_RANGE
:

1017 
i
 = 
m
->
devid
; i <m->
aux
; ++i)

1018 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1025 
	}
}

1028 
__öô
 
	$öô_unôy_m≠_ønge
(
ivmd_hódî
 *
m
)

1030 
unôy_m≠_íåy
 *
e
 = 0;

1031 *
s
;

1033 
e
 = 
	`kzÆloc
((*e), 
GFP_KERNEL
);

1034 i‡(
e
 =
NULL
)

1035  -
ENOMEM
;

1037 
m
->
ty≥
) {

1039 
	`k‰ì
(
e
);

1041 
ACPI_IVMD_TYPE
:

1042 
s
 = "IVMD_TYPEi\t\t\t";

1043 
e
->
devid_°¨t
 =É->
devid_íd
 = 
m
->
devid
;

1045 
ACPI_IVMD_TYPE_ALL
:

1046 
s
 = "IVMD_TYPE_ALL\t\t";

1047 
e
->
devid_°¨t
 = 0;

1048 
e
->
devid_íd
 = 
amd_iommu_œ°_bdf
;

1050 
ACPI_IVMD_TYPE_RANGE
:

1051 
s
 = "IVMD_TYPE_RANGE\t\t";

1052 
e
->
devid_°¨t
 = 
m
->
devid
;

1053 
e
->
devid_íd
 = 
m
->
aux
;

1056 
e
->
addªss_°¨t
 = 
	`PAGE_ALIGN
(
m
->
ønge_°¨t
);

1057 
e
->
addªss_íd
 =É->
addªss_°¨t
 + 
	`PAGE_ALIGN
(
m
->
ønge_Àngth
);

1058 
e
->
¥Ÿ
 = 
m
->
Êags
 >> 1;

1060 
	`DUMP_¥ötk
("%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x"

1061 "Ñ™ge_°¨t: %016ŒxÑ™ge_íd: %016Œx fœgs: %x\n", 
s
,

1062 
	`PCI_BUS
(
e
->
devid_°¨t
), 
	`PCI_SLOT
(e->devid_start),

1063 
	`PCI_FUNC
(
e
->
devid_°¨t
), 
	`PCI_BUS
”->
devid_íd
),

1064 
	`PCI_SLOT
(
e
->
devid_íd
), 
	`PCI_FUNC
(e->devid_end),

1065 
e
->
addªss_°¨t
,É->
addªss_íd
, 
m
->
Êags
);

1067 
	`li°_add_èû
(&
e
->
li°
, &
amd_iommu_unôy_m≠
);

1070 
	}
}

1073 
__öô
 
	$öô_mem‹y_deföôi⁄s
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1075 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

1076 
ivmd_hódî
 *
m
;

1078 
íd
 +
èbÀ
->
Àngth
;

1079 
p
 +
IVRS_HEADER_LENGTH
;

1081 
p
 < 
íd
) {

1082 
m
 = (
ivmd_hódî
 *)
p
;

1083 i‡(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
)

1084 
	`öô_ex˛usi⁄_ønge
(
m
);

1085 i‡(
m
->
Êags
 & 
IVMD_FLAG_UNITY_MAP
)

1086 
	`öô_unôy_m≠_ønge
(
m
);

1088 
p
 +
m
->
Àngth
;

1092 
	}
}

1098 
	$öô_devi˚_èbÀ
()

1100 
u16
 
devid
;

1102 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid) {

1103 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_VALID
);

1104 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_TRANSLATION
);

1106 
	}
}

1112 
	$íabÀ_iommus
()

1114 
amd_iommu
 *
iommu
;

1116 
	`f‹_óch_iommu
(
iommu
) {

1117 
	`iommu_dißbÀ
(
iommu
);

1118 
	`iommu_£t_devi˚_èbÀ
(
iommu
);

1119 
	`iommu_íabÀ_comm™d_buf„r
(
iommu
);

1120 
	`iommu_íabÀ_evít_buf„r
(
iommu
);

1121 
	`iommu_£t_ex˛usi⁄_ønge
(
iommu
);

1122 
	`iommu_öô_msi
(
iommu
);

1123 
	`iommu_íabÀ
(
iommu
);

1125 
	}
}

1127 
	$dißbÀ_iommus
()

1129 
amd_iommu
 *
iommu
;

1131 
	`f‹_óch_iommu
(
iommu
)

1132 
	`iommu_dißbÀ
(
iommu
);

1133 
	}
}

1140 
	$amd_iommu_ªsume
(
sys_devi˚
 *
dev
)

1143 
	`íabÀ_iommus
();

1149 
	`amd_iommu_Êush_Æl_devi˚s
();

1150 
	`amd_iommu_Êush_Æl_domaös
();

1153 
	}
}

1155 
	$amd_iommu_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1158 
	`dißbÀ_iommus
();

1161 
	}
}

1163 
sysdev_˛ass
 
	gamd_iommu_sysdev_˛ass
 = {

1164 .
«me
 = "amd_iommu",

1165 .
	gsu•íd
 = 
amd_iommu_su•íd
,

1166 .
	gªsume
 = 
amd_iommu_ªsume
,

1169 
sys_devi˚
 
	gdevi˚_amd_iommu
 = {

1170 .
id
 = 0,

1171 .
	g˛s
 = &
amd_iommu_sysdev_˛ass
,

1202 
__öô
 
	$amd_iommu_öô
()

1204 
i
, 
ªt
 = 0;

1211 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
föd_œ°_devid_a˝i
) != 0)

1212  -
ENODEV
;

1214 
dev_èbÀ_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1215 
Æüs_èbÀ_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1216 
æookup_èbÀ_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1218 
ªt
 = -
ENOMEM
;

1221 
amd_iommu_dev_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1222 
	`gë_‹dî
(
dev_èbÀ_size
));

1223 i‡(
amd_iommu_dev_èbÀ
 =
NULL
)

1224 
out
;

1230 
amd_iommu_Æüs_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1231 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1232 i‡(
amd_iommu_Æüs_èbÀ
 =
NULL
)

1233 
‰ì
;

1236 
amd_iommu_æookup_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(

1237 
GFP_KERNEL
 | 
__GFP_ZERO
,

1238 
	`gë_‹dî
(
æookup_èbÀ_size
));

1239 i‡(
amd_iommu_æookup_èbÀ
 =
NULL
)

1240 
‰ì
;

1242 
amd_iommu_pd_Æloc_bôm≠
 = (*)
	`__gë_‰ì_∑ges
(

1243 
GFP_KERNEL
 | 
__GFP_ZERO
,

1244 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1245 i‡(
amd_iommu_pd_Æloc_bôm≠
 =
NULL
)

1246 
‰ì
;

1249 
	`öô_devi˚_èbÀ
();

1254 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1255 
amd_iommu_Æüs_èbÀ
[
i
] = i;

1261 
amd_iommu_pd_Æloc_bôm≠
[0] = 1;

1263 
	`•ö_lock_öô
(&
amd_iommu_pd_lock
);

1269 
ªt
 = -
ENODEV
;

1270 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_iommu_Æl
) != 0)

1271 
‰ì
;

1273 i‡(!
amd_iommu_öôülized
)

1274 
‰ì
;

1276 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_mem‹y_deföôi⁄s
) != 0)

1277 
‰ì
;

1279 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
amd_iommu_sysdev_˛ass
);

1280 i‡(
ªt
)

1281 
‰ì
;

1283 
ªt
 = 
	`sysdev_ªgi°î
(&
devi˚_amd_iommu
);

1284 i‡(
ªt
)

1285 
‰ì
;

1287 
ªt
 = 
	`amd_iommu_öô_devi˚s
();

1288 i‡(
ªt
)

1289 
‰ì
;

1291 i‡(
iommu_∑ss_through
)

1292 
ªt
 = 
	`amd_iommu_öô_∑s°hrough
();

1294 
ªt
 = 
	`amd_iommu_öô_dma_›s
();

1296 i‡(
ªt
)

1297 
‰ì
;

1299 
	`amd_iommu_öô_≠i
();

1301 
	`amd_iommu_öô_nŸifõr
();

1303 
	`íabÀ_iommus
();

1305 i‡(
iommu_∑ss_through
)

1306 
out
;

1308 i‡(
amd_iommu_unm≠_Êush
)

1309 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: IO/TLB flush on unmapÉnabled\n");

1311 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Lazy IO/TLB flushingÉnabled\n");

1313 
x86_∂©f‹m
.
iommu_shutdown
 = 
dißbÀ_iommus
;

1314 
out
:

1315  
ªt
;

1317 
‰ì
:

1319 
	`amd_iommu_unöô_devi˚s
();

1321 
	`‰ì_∑ges
(()
amd_iommu_pd_Æloc_bôm≠
,

1322 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1324 
	`‰ì_∑ges
(()
amd_iommu_æookup_èbÀ
,

1325 
	`gë_‹dî
(
æookup_èbÀ_size
));

1327 
	`‰ì_∑ges
(()
amd_iommu_Æüs_èbÀ
,

1328 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1330 
	`‰ì_∑ges
(()
amd_iommu_dev_èbÀ
,

1331 
	`gë_‹dî
(
dev_èbÀ_size
));

1333 
	`‰ì_iommu_Æl
();

1335 
	`‰ì_unôy_m≠s
();

1337 
out
;

1338 
	}
}

1347 
__öô
 
	$óæy_amd_iommu_dëe˘
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1350 
	}
}

1352 
__öô
 
	$amd_iommu_dëe˘
()

1354 i‡(
no_iommu
 || (
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
))

1357 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
óæy_amd_iommu_dëe˘
) == 0) {

1358 
iommu_dëe˘ed
 = 1;

1359 
amd_iommu_dëe˘ed
 = 1;

1360 
x86_öô
.
iommu
.
iommu_öô
 = 
amd_iommu_öô
;

1363 
	`pci_ªque°_acs
();

1365 
	}
}

1374 
__öô
 
	$∑r£_amd_iommu_dump
(*
°r
)

1376 
amd_iommu_dump
 = 
åue
;

1379 
	}
}

1381 
__öô
 
	$∑r£_amd_iommu_›ti⁄s
(*
°r
)

1383 ; *
°r
; ++str) {

1384 i‡(
	`°∫cmp
(
°r
, "fullflush", 9) == 0)

1385 
amd_iommu_unm≠_Êush
 = 
åue
;

1389 
	}
}

1391 
__£tup
("amd_iommu_dump", 
∑r£_amd_iommu_dump
);

1392 
__£tup
("amd_iommu=", 
∑r£_amd_iommu_›ti⁄s
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/boŸmem.h
>

17 
	~<löux/mmz⁄e.h
>

18 
	~<löux/pci_ids.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/su•íd.h
>

23 
	~<löux/kmemÀak.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/io.h
>

26 
	~<asm/iommu.h
>

27 
	~<asm/g¨t.h
>

28 
	~<asm/pci-dúe˘.h
>

29 
	~<asm/dma.h
>

30 
	~<asm/k8.h
>

31 
	~<asm/x86_öô.h
>

33 
	gg¨t_iommu_≠îtuª
;

34 
EXPORT_SYMBOL_GPL
(
g¨t_iommu_≠îtuª
);

35 
g¨t_iommu_≠îtuª_dißbÀd
 
	g__öôd©a
;

36 
g¨t_iommu_≠îtuª_Ælowed
 
	g__öôd©a
;

38 
ÁŒback_≠î_‹dî
 
	g__öôd©a
 = 1;

39 
ÁŒback_≠î_f‹˚
 
	g__öôd©a
;

41 
fix_≠îtuª
 
	g__öôd©a
 = 1;

43 
	sbus_dev_ønge
 {

44 
	mbus
;

45 
	mdev_ba£
;

46 
	mdev_limô
;

49 
bus_dev_ønge
 
	gbus_dev_ønges
[] 
	g__öôd©a
 = {

55 
ªsour˚
 
	gg¨t_ªsour˚
 = {

56 .
«me
 = "GART",

57 .
	gÊags
 = 
IORESOURCE_MEM
,

60 
__öô
 
	$ö£π_≠îtuª_ªsour˚
(
u32
 
≠î_ba£
, u32 
≠î_size
)

62 
g¨t_ªsour˚
.
°¨t
 = 
≠î_ba£
;

63 
g¨t_ªsour˚
.
íd
 = 
≠î_ba£
 + 
≠î_size
 - 1;

64 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
g¨t_ªsour˚
);

65 
	}
}

70 
u32
 
__öô
 
	$Æloˇã_≠îtuª
()

72 
u32
 
≠î_size
;

73 *
p
;

76 i‡(
ÁŒback_≠î_‹dî
 > 5)

77 
ÁŒback_≠î_‹dî
 = 5;

78 
≠î_size
 = (32 * 1024 * 1024Ë<< 
ÁŒback_≠î_‹dî
;

99 
p
 = 
	`__Æloc_boŸmem_n›™ic
(
≠î_size
,áper_size, 512ULL<<20);

104 
	`kmemÀak_ign‹e
(
p
);

105 i‡(!
p
 || 
	`__∑
’)+
≠î_size
 > 0xffffffff) {

106 
	`¥ötk
(
KERN_ERR


108 
p
, 
≠î_size
>>10);

109 i‡(
p
)

110 
	`‰ì_boŸmem
(
	`__∑
(
p
), 
≠î_size
);

113 
	`¥ötk
(
KERN_INFO
 "Mappingáperture over %d KB of RAM @ %lx\n",

114 
≠î_size
 >> 10, 
	`__∑
(
p
));

115 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
	`__∑
(
p
), 
≠î_size
);

116 
	`ªgi°î_noßve_ªgi⁄
((
u32
)
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

117 (
u32
)
	`__∑
(
p
+
≠î_size
Ë>> 
PAGE_SHIFT
);

119  (
u32
)
	`__∑
(
p
);

120 
	}
}

124 
u32
 
__öô
 
	$föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
)

126 
byãs
;

127 
u8
 
pos
;

129 i‡(!(
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

130 
PCI_STATUS_CAP_LIST
))

133 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

134 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

135 
u8
 
id
;

137 
pos
 &= ~3;

138 
id
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

139 i‡(
id
 == 0xff)

141 i‡(
id
 =
ˇp
)

142  
pos
;

143 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

144 
pos
+
PCI_CAP_LIST_NEXT
);

147 
	}
}

150 
u32
 
__öô
 
	$ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
, 
u32
 *
‹dî
)

152 
u32
 
≠size
;

153 
u32
 
≠sizîeg
;

154 
nbôs
;

155 
u32
 
≠î_low
, 
≠î_hi
;

156 
u64
 
≠î
;

157 
u32
 
ﬁd_‹dî
;

159 
	`¥ötk
(
KERN_INFO
 "AGP bridgê© %02x:%02x:%02x\n", 
bus
, 
¶Ÿ
, 
func
);

160 
≠sizîeg
 = 
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
 + 0x14);

161 i‡(
≠sizîeg
 == 0xffffffff) {

162 
	`¥ötk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

167 
ﬁd_‹dî
 = *
‹dî
;

169 
≠size
 = 
≠sizîeg
 & 0xfff;

171 i‡(
≠size
 & 0xff)

172 
≠size
 |= 0xf00;

173 
nbôs
 = 
	`hweight16
(
≠size
);

174 *
‹dî
 = 7 - 
nbôs
;

175 i‡(()*
‹dî
 < 0)

176 *
‹dî
 = 0;

178 
≠î_low
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x10);

179 
≠î_hi
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x14);

180 
≠î
 = (
≠î_low
 & ~((1<<22)-1)Ë| ((
u64
)
≠î_hi
 << 32);

186 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

187 
≠î
, 32 << 
ﬁd_‹dî
);

188 i‡(
≠î
 + (32ULL<<(20 + *
‹dî
)) > 0x100000000ULL) {

189 
	`¥ötk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) isÇotÑight, using settings from NB\n",

190 32 << *
‹dî
, 
≠sizîeg
);

191 *
‹dî
 = 
ﬁd_‹dî
;

194 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

195 
≠î
, 32 << *
‹dî
, 
≠sizîeg
);

197 i‡(!
	`≠îtuª_vÆid
(
≠î
, (32*1024*1024Ë<< *
‹dî
, 32<<20))

199  (
u32
)
≠î
;

200 
	}
}

215 
u32
 
__öô
 
	$£¨ch_agp_bridge
(
u32
 *
‹dî
, *
vÆid_agp
)

217 
bus
, 
¶Ÿ
, 
func
;

220 
bus
 = 0; bus < 256; bus++) {

221 
¶Ÿ
 = 0; slot < 32; slot++) {

222 
func
 = 0; func < 8; func++) {

223 
u32
 
˛ass
, 
ˇp
;

224 
u8
 
ty≥
;

225 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
,

226 
PCI_CLASS_REVISION
);

227 i‡(
˛ass
 == 0xffffffff)

230 
˛ass
 >> 16) {

231 
PCI_CLASS_BRIDGE_HOST
:

232 
PCI_CLASS_BRIDGE_OTHER
:

234 
ˇp
 = 
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
,

235 
PCI_CAP_ID_AGP
);

236 i‡(!
ˇp
)

238 *
vÆid_agp
 = 1;

239  
	`ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
,

240 
‹dî
);

244 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

245 
PCI_HEADER_TYPE
);

246 i‡(!(
ty≥
 & 0x80))

251 
	`¥ötk
(
KERN_INFO
 "No AGP bridge found\n");

254 
	}
}

256 
g¨t_fix_e820
 
	g__öôd©a
 = 1;

258 
__öô
 
	$∑r£_g¨t_mem
(*
p
)

260 i‡(!
p
)

261  -
EINVAL
;

263 i‡(!
	`°∫cmp
(
p
, "off", 3))

264 
g¨t_fix_e820
 = 0;

265 i‡(!
	`°∫cmp
(
p
, "on", 2))

266 
g¨t_fix_e820
 = 1;

269 
	}
}

270 
óæy_∑øm
("g¨t_fix_e820", 
∑r£_g¨t_mem
);

272 
__öô
 
	$óæy_g¨t_iommu_check
()

284 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

285 
i
, 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

286 
u32
 
˘l
;

287 
u32
 
≠î_size
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

288 
u64
 
≠î_ba£
 = 0, 
œ°_≠î_ba£
 = 0;

289 
≠î_íabÀd
 = 0, 
œ°_≠î_íabÀd
 = 0, 
œ°_vÆid
 = 0;

291 i‡(!
	`óæy_pci_Ælowed
())

295 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

297 
fix
 = 0;

298 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

299 
bus
;

300 
dev_ba£
, 
dev_limô
;

302 
bus
 = 
bus_dev_ønges
[
i
].bus;

303 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

304 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

306 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

307 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

310 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

311 
≠î_íabÀd
 = 
˘l
 & 
AMD64_GARTEN
;

312 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

313 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

314 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

315 
≠î_ba£
 <<= 25;

317 i‡(
œ°_vÆid
) {

318 i‡((
≠î_‹dî
 !
œ°_≠î_‹dî
) ||

319 (
≠î_ba£
 !
œ°_≠î_ba£
) ||

320 (
≠î_íabÀd
 !
œ°_≠î_íabÀd
)) {

321 
fix
 = 1;

326 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

327 
œ°_≠î_ba£
 = 
≠î_ba£
;

328 
œ°_≠î_íabÀd
 = 
≠î_íabÀd
;

329 
œ°_vÆid
 = 1;

333 i‡(!
fix
 && !
≠î_íabÀd
)

336 i‡(!
≠î_ba£
 || !
≠î_size
 ||áper_base +áper_size > 0x100000000UL)

337 
fix
 = 1;

339 i‡(
g¨t_fix_e820
 && !
fix
 && 
≠î_íabÀd
) {

340 i‡(
	`e820_™y_m≠≥d
(
≠î_ba£
,á≥r_ba£ + 
≠î_size
,

341 
E820_RAM
)) {

343 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for GART\n");

344 
	`e820_add_ªgi⁄
(
≠î_ba£
, 
≠î_size
, 
E820_RESERVED
);

345 
	`upd©e_e820
();

349 i‡(
vÆid_agp
)

353 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

354 
bus
;

355 
dev_ba£
, 
dev_limô
;

357 
bus
 = 
bus_dev_ønges
[
i
].bus;

358 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

359 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

361 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

362 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

365 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

366 
˘l
 &~
AMD64_GARTEN
;

367 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

371 
	}
}

373 
__öôd©a
 
	g¥öãd_g¨t_size_msg
;

375 
__öô
 
	$g¨t_iommu_hﬁe_öô
()

377 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

378 
u32
 
≠î_size
, 
≠î_Æloc
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

379 
u64
 
≠î_ba£
, 
œ°_≠î_ba£
 = 0;

380 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

381 
i
, 
node
;

383 i‡(
g¨t_iommu_≠îtuª_dißbÀd
 || !
fix_≠îtuª
 ||

384 !
	`óæy_pci_Ælowed
())

387 
	`¥ötk
(
KERN_INFO
 "Checkingáperture...\n");

389 i‡(!
ÁŒback_≠î_f‹˚
)

390 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

392 
fix
 = 0;

393 
node
 = 0;

394 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

395 
bus
;

396 
dev_ba£
, 
dev_limô
;

398 
bus
 = 
bus_dev_ønges
[
i
].bus;

399 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

400 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

402 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

403 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

406 
iommu_dëe˘ed
 = 1;

407 
g¨t_iommu_≠îtuª
 = 1;

408 
x86_öô
.
iommu
.
iommu_öô
 = 
g¨t_iommu_öô
;

410 
≠î_‹dî
 = (
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
) >> 1) & 7;

411 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

412 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

413 
≠î_ba£
 <<= 25;

415 
	`¥ötk
(
KERN_INFO
 "Node %d:áperture @ %Lx size %u MB\n",

416 
node
, 
≠î_ba£
, 
≠î_size
 >> 20);

417 
node
++;

419 i‡(!
	`≠îtuª_vÆid
(
≠î_ba£
, 
≠î_size
, 64<<20)) {

420 i‡(
vÆid_agp
 && 
agp_≠î_ba£
 &&

421 
agp_≠î_ba£
 =
≠î_ba£
 &&

422 
agp_≠î_‹dî
 =
≠î_‹dî
) {

424 i‡(!
no_iommu
 &&

425 
max_p‚
 > 
MAX_DMA32_PFN
 &&

426 !
¥öãd_g¨t_size_msg
) {

427 
	`¥ötk
(
KERN_ERR
 "youáre using iommu withágp, but GART size isÜessÅhan 64M\n");

428 
	`¥ötk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

429 
	`¥ötk
(
KERN_ERR
 "if BIOS doesn't haveÅhat option, contact your HW vendor!\n");

430 
¥öãd_g¨t_size_msg
 = 1;

433 
fix
 = 1;

434 
out
;

438 i‡((
œ°_≠î_‹dî
 && 
≠î_‹dî
 !=Üast_aper_order) ||

439 (
œ°_≠î_ba£
 && 
≠î_ba£
 !=Üast_aper_base)) {

440 
fix
 = 1;

441 
out
;

443 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

444 
œ°_≠î_ba£
 = 
≠î_ba£
;

448 
out
:

449 i‡(!
fix
 && !
ÁŒback_≠î_f‹˚
) {

450 i‡(
œ°_≠î_ba£
) {

451 
n
 = (32 * 1024 * 1024Ë<< 
œ°_≠î_‹dî
;

453 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
œ°_≠î_ba£
, 
n
);

458 i‡(!
ÁŒback_≠î_f‹˚
) {

459 
≠î_Æloc
 = 
agp_≠î_ba£
;

460 
≠î_‹dî
 = 
agp_≠î_‹dî
;

463 i‡(
≠î_Æloc
) {

465 } i‡((!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

466 
f‹˚_iommu
 ||

467 
vÆid_agp
 ||

468 
ÁŒback_≠î_f‹˚
) {

469 
	`¥ötk
(
KERN_INFO


471 
	`¥ötk
(
KERN_INFO


473 
	`¥ötk
(
KERN_INFO


475 32 << 
ÁŒback_≠î_‹dî
);

477 
≠î_‹dî
 = 
ÁŒback_≠î_‹dî
;

478 
≠î_Æloc
 = 
	`Æloˇã_≠îtuª
();

479 i‡(!
≠î_Æloc
) {

488 
	`∑nic
("NotÉnough memory foráperture");

495 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

496 
bus
;

497 
dev_ba£
, 
dev_limô
;

499 
bus
 = 
bus_dev_ønges
[
i
].bus;

500 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

501 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

502 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

503 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

509 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
≠î_‹dî
 << 1);

510 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
, 
≠î_Æloc
 >> 25);

514 
	`£t_up_g¨t_ªsume
(
≠î_‹dî
, 
≠î_Æloc
);

515 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<löux/≥rf_evít.h
>

18 
	~<löux/kî√l_°©.h
>

19 
	~<löux/mc146818πc.h
>

20 
	~<löux/a˝i_pmtmr.h
>

21 
	~<löux/˛ockchùs.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/·ø˚.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/moduÀ.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/dñay.h
>

29 
	~<löux/timex.h
>

30 
	~<löux/dm¨.h
>

31 
	~<löux/öô.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/dmi.h
>

34 
	~<löux/nmi.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/≥rf_evít.h
>

39 
	~<asm/x86_öô.h
>

40 
	~<asm/pgÆloc.h
>

41 
	~<asm/©omic.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/i8253.h
>

44 
	~<asm/i8259.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/≠ic.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/h≥t.h
>

49 
	~<asm/idÀ.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/smp.h
>

52 
	~<asm/m˚.h
>

53 
	~<asm/kvm_∑ø.h
>

55 
	gnum_¥o˚ss‹s
;

57 
dißbÀd_˝us
 
	g__˝uöôd©a
;

60 
	gboŸ_˝u_physiˇl_≠icid
 = -1U;

65 
	gmax_physiˇl_≠icid
;

70 
physid_mask_t
 
	gphys_˝u_¥e£¡_m≠
;

75 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_˝u_to_≠icid
, 
BAD_APICID
);

76 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_˝u_≠icid
, 
BAD_APICID
);

77 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_≠icid
);

78 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_˝u_≠icid
);

80 #ifde‡
CONFIG_X86_32


86 
	gf‹˚_íabÀ_loˇl_≠ic
;

90 
__öô
 
	$∑r£_œpic
(*
¨g
)

92 
f‹˚_íabÀ_loˇl_≠ic
 = 1;

94 
	}
}

95 
óæy_∑øm
("œpic", 
∑r£_œpic
);

97 
	gíabÀd_vü_≠icba£
;

107 
ölöe
 
	$im¸_pic_to_≠ic
()

110 
	`outb
(0x70, 0x22);

112 
	`outb
(0x01, 0x23);

113 
	}
}

115 
ölöe
 
	$im¸_≠ic_to_pic
()

118 
	`outb
(0x70, 0x22);

120 
	`outb
(0x00, 0x23);

121 
	}
}

124 #ifde‡
CONFIG_X86_64


125 
≠ic_ˇlibøã_pmtmr
 
	g__öôd©a
;

126 
__öô
 
	$£tup_≠i˝mtimî
(*
s
)

128 
≠ic_ˇlibøã_pmtmr
 = 1;

129 
	`nŸsc_£tup
(
NULL
);

131 
	}
}

132 
__£tup
("≠i˝mtimî", 
£tup_≠i˝mtimî
);

135 
	gx2≠ic_mode
;

136 #ifde‡
CONFIG_X86_X2APIC


138 
	gx2≠ic_¥ì«bÀd
;

139 
__öô
 
	$£tup_nox2≠ic
(*
°r
)

141 i‡(
	`x2≠ic_íabÀd
()) {

142 
	`¥_w¨nög
("BiosálreadyÉnabled x2apic, "

147 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_X2APIC
);

149 
	}
}

150 
óæy_∑øm
("nox2≠ic", 
£tup_nox2≠ic
);

153 
	gmp_œpic_addr
;

154 
	gdißbÀ_≠ic
;

156 
dißbÀ_≠ic_timî
 
	g__˝uöôd©a
;

158 
	gloˇl_≠ic_timî_c2_ok
;

159 
EXPORT_SYMBOL_GPL
(
loˇl_≠ic_timî_c2_ok
);

161 
	gfú°_sy°em_ve˘‹
 = 0xfe;

166 
	g≠ic_vîbosôy
;

168 
	gpic_mode
;

171 
	gsmp_found_c⁄fig
;

173 
ªsour˚
 
	gœpic_ªsour˚
 = {

174 .
«me
 = "Local APIC",

175 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

178 
	gˇlibøti⁄_ªsu…
;

180 
œpic_√xt_evít
(
dñè
,

181 
˛ock_evít_devi˚
 *
evt
);

182 
œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

183 
˛ock_evít_devi˚
 *
evt
);

184 
œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
);

185 
≠ic_pm_a˘iv©e
();

190 
˛ock_evít_devi˚
 
	gœpic_˛ockevít
 = {

191 .
«me
 = "lapic",

192 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


193 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

194 .
	gshi·
 = 32,

195 .
	g£t_mode
 = 
œpic_timî_£tup
,

196 .
	g£t_√xt_evít
 = 
œpic_√xt_evít
,

197 .
	gbrﬂdˇ°
 = 
œpic_timî_brﬂdˇ°
,

198 .
	gøtög
 = 100,

199 .
	gúq
 = -1,

201 
DEFINE_PER_CPU
(
˛ock_evít_devi˚
, 
œpic_evíts
);

203 
	g≠ic_phys
;

208 
ölöe
 
	$œpic_gë_vîsi⁄
()

210  
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

211 
	}
}

216 
ölöe
 
	$œpic_is_öãgøãd
()

218 #ifde‡
CONFIG_X86_64


221  
	`APIC_INTEGRATED
(
	`œpic_gë_vîsi⁄
());

223 
	}
}

228 
	$modîn_≠ic
()

231 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
 &&

232 
boŸ_˝u_d©a
.
x86
 >= 0xf)

234  
	`œpic_gë_vîsi⁄
() >= 0x14;

235 
	}
}

241 
	$≠ic_dißbÀ
()

243 
	`¥_öfo
("APIC: switchedÅoápic NOOP\n");

244 
≠ic
 = &
≠ic_no›
;

245 
	}
}

247 
	$«tive_≠ic_waô_i¸_idÀ
()

249 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
)

250 
	`˝u_ªœx
();

251 
	}
}

253 
u32
 
	$«tive_ß„_≠ic_waô_i¸_idÀ
()

255 
u32
 
£nd_°©us
;

256 
timeout
;

258 
timeout
 = 0;

260 
£nd_°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
;

261 i‡(!
£nd_°©us
)

263 
	`udñay
(100);

264 } 
timeout
++ < 1000);

266  
£nd_°©us
;

267 
	}
}

269 
	$«tive_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
)

271 
	`≠ic_wrôe
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

272 
	`≠ic_wrôe
(
APIC_ICR
, 
low
);

273 
	}
}

275 
u64
 
	$«tive_≠ic_i¸_ªad
()

277 
u32
 
i¸1
, 
i¸2
;

279 
i¸2
 = 
	`≠ic_ªad
(
APIC_ICR2
);

280 
i¸1
 = 
	`≠ic_ªad
(
APIC_ICR
);

282  
i¸1
 | ((
u64
)
i¸2
 << 32);

283 
	}
}

288 
__˝uöô
 
	$íabÀ_NMI_through_LVT0
()

290 
v
;

293 
v
 = 
APIC_DM_NMI
;

296 i‡(!
	`œpic_is_öãgøãd
())

297 
v
 |
APIC_LVT_LEVEL_TRIGGER
;

299 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
);

300 
	}
}

302 #ifde‡
CONFIG_X86_32


306 
	$gë_physiˇl_brﬂdˇ°
()

308  
	`modîn_≠ic
() ? 0xff : 0xf;

309 
	}
}

315 
	$œpic_gë_maxlvt
()

317 
v
;

319 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

324  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)Ë? 
	`GET_APIC_MAXLVT
(v) : 2;

325 
	}
}

332 
	#APIC_DIVISOR
 16

	)

344 
	$__£tup_APIC_LVTT
(
˛ocks
, 
⁄eshŸ
, 
úqí
)

346 
lvâ_vÆue
, 
tmp_vÆue
;

348 
lvâ_vÆue
 = 
LOCAL_TIMER_VECTOR
;

349 i‡(!
⁄eshŸ
)

350 
lvâ_vÆue
 |
APIC_LVT_TIMER_PERIODIC
;

351 i‡(!
	`œpic_is_öãgøãd
())

352 
lvâ_vÆue
 |
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

354 i‡(!
úqí
)

355 
lvâ_vÆue
 |
APIC_LVT_MASKED
;

357 
	`≠ic_wrôe
(
APIC_LVTT
, 
lvâ_vÆue
);

362 
tmp_vÆue
 = 
	`≠ic_ªad
(
APIC_TDCR
);

363 
	`≠ic_wrôe
(
APIC_TDCR
,

364 (
tmp_vÆue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

365 
APIC_TDR_DIV_16
);

367 i‡(!
⁄eshŸ
)

368 
	`≠ic_wrôe
(
APIC_TMICT
, 
˛ocks
 / 
APIC_DIVISOR
);

369 
	}
}

381 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

382 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

384 
	$£tup_APIC_eûvt
(
u8
 
lvt_off
, u8 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

386 
ªg
 = (
lvt_off
 << 4Ë+ 
	`APIC_EILVTn
(0);

387 
v
 = (
mask
 << 16Ë| (
msg_ty≥
 << 8Ë| 
ve˘‹
;

389 
	`≠ic_wrôe
(
ªg
, 
v
);

390 
	}
}

392 
u8
 
	$£tup_APIC_eûvt_m˚
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

394 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_MCE
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

395  
APIC_EILVT_LVTOFF_MCE
;

396 
	}
}

398 
u8
 
	$£tup_APIC_eûvt_ibs
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

400 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_IBS
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

401  
APIC_EILVT_LVTOFF_IBS
;

402 
	}
}

403 
EXPORT_SYMBOL_GPL
(
£tup_APIC_eûvt_ibs
);

408 
	$œpic_√xt_evít
(
dñè
,

409 
˛ock_evít_devi˚
 *
evt
)

411 
	`≠ic_wrôe
(
APIC_TMICT
, 
dñè
);

413 
	}
}

418 
	$œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

419 
˛ock_evít_devi˚
 *
evt
)

421 
Êags
;

422 
v
;

425 i‡(
evt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
)

428 
	`loˇl_úq_ßve
(
Êags
);

430 
mode
) {

431 
CLOCK_EVT_MODE_PERIODIC
:

432 
CLOCK_EVT_MODE_ONESHOT
:

433 
	`__£tup_APIC_LVTT
(
ˇlibøti⁄_ªsu…
,

434 
mode
 !
CLOCK_EVT_MODE_PERIODIC
, 1);

436 
CLOCK_EVT_MODE_UNUSED
:

437 
CLOCK_EVT_MODE_SHUTDOWN
:

438 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

439 
v
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

440 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
);

441 
	`≠ic_wrôe
(
APIC_TMICT
, 0);

443 
CLOCK_EVT_MODE_RESUME
:

448 
	`loˇl_úq_ª°‹e
(
Êags
);

449 
	}
}

454 
	$œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
)

456 #ifde‡
CONFIG_SMP


457 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

459 
	}
}

465 
__˝uöô
 
	$£tup_APIC_timî
()

467 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

469 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_ARAT
)) {

470 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_C3STOP
;

472 
œpic_˛ockevít
.
øtög
 = 150;

475 
	`mem˝y
(
Àvt
, &
œpic_˛ockevít
, (*levt));

476 
Àvt
->
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

478 
	`˛ockevíts_ªgi°î_devi˚
(
Àvt
);

479 
	}
}

502 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

504 
__öôd©a
 
	gœpic_ˇl_lo›s
 = -1;

505 
__öôd©a
 
	gœpic_ˇl_t1
, 
	gœpic_ˇl_t2
;

506 
__öôd©a
 
	gœpic_ˇl_tsc1
, 
	gœpic_ˇl_tsc2
;

507 
__öôd©a
 
	gœpic_ˇl_pm1
, 
	gœpic_ˇl_pm2
;

508 
__öôd©a
 
	gœpic_ˇl_j1
, 
	gœpic_ˇl_j2
;

513 
__öô
 
	$œpic_ˇl_h™dÀr
(
˛ock_evít_devi˚
 *
dev
)

515 
tsc
 = 0;

516 
èpic
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

517 
pm
 = 
	`a˝i_pm_ªad_óæy
();

519 i‡(
˝u_has_tsc
)

520 
	`rdts˛l
(
tsc
);

522 
œpic_ˇl_lo›s
++) {

524 
œpic_ˇl_t1
 = 
èpic
;

525 
œpic_ˇl_tsc1
 = 
tsc
;

526 
œpic_ˇl_pm1
 = 
pm
;

527 
œpic_ˇl_j1
 = 
jiffõs
;

530 
LAPIC_CAL_LOOPS
:

531 
œpic_ˇl_t2
 = 
èpic
;

532 
œpic_ˇl_tsc2
 = 
tsc
;

533 i‡(
pm
 < 
œpic_ˇl_pm1
)

534 
pm
 +
ACPI_PM_OVRRUN
;

535 
œpic_ˇl_pm2
 = 
pm
;

536 
œpic_ˇl_j2
 = 
jiffõs
;

539 
	}
}

541 
__öô


542 
	$ˇlibøã_by_pmtimî
(
dñèpm
, *
dñè
, *
dñètsc
)

544 c⁄° 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

545 c⁄° 
pm_thªsh
 = 
pm_100ms
 / 100;

546 
mu…
;

547 
u64
 
ªs
;

549 #i‚de‡
CONFIG_X86_PM_TIMER


553 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-Timî dñè = %ld\n", 
dñèpm
);

556 i‡(!
dñèpm
)

559 
mu…
 = 
	`˛ocksour˚_hz2mu…
(
PMTMR_TICKS_PER_SEC
, 22);

561 i‡(
dñèpm
 > (
pm_100ms
 - 
pm_thªsh
) &&

562 
dñèpm
 < (
pm_100ms
 + 
pm_thªsh
)) {

563 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-TimerÑesult ok\n");

567 
ªs
 = (((
u64
)
dñèpm
Ë* 
mu…
) >> 22;

568 
	`do_div
(
ªs
, 1000000);

569 
	`¥_w¨nög
("APIC calibrationÇot consistent "

570 "wôh PM-Timî: %ldm†ö°ód o‡100ms\n",()
ªs
);

573 
ªs
 = (((
u64
)(*
dñè
)Ë* 
pm_100ms
);

574 
	`do_div
(
ªs
, 
dñèpm
);

575 
	`¥_öfo
("APIC deltaádjustedÅo PM-Timer: "

576 "%lu (%ld)\n", ()
ªs
, *
dñè
);

577 *
dñè
 = ()
ªs
;

580 i‡(
˝u_has_tsc
) {

581 
ªs
 = (((
u64
)(*
dñètsc
)Ë* 
pm_100ms
);

582 
	`do_div
(
ªs
, 
dñèpm
);

583 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "TSC deltaádjustedÅo "

585 ()
ªs
, *
dñètsc
);

586 *
dñètsc
 = ()
ªs
;

590 
	}
}

592 
__öô
 
	$ˇlibøã_APIC_˛ock
()

594 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

595 (*
ªÆ_h™dÀr
)(
˛ock_evít_devi˚
 *
dev
);

596 
dñèj
;

597 
dñè
, 
dñètsc
;

598 
pm_ª„ªn˚d
 = 0;

600 
	`loˇl_úq_dißbÀ
();

603 
ªÆ_h™dÀr
 = 
globÆ_˛ock_evít
->
evít_h™dÀr
;

604 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

610 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

613 
	`loˇl_úq_íabÀ
();

615 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

616 
	`˝u_ªœx
();

618 
	`loˇl_úq_dißbÀ
();

621 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
ªÆ_h™dÀr
;

624 
dñè
 = 
œpic_ˇl_t1
 - 
œpic_ˇl_t2
;

625 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "...Ü≠i¯dñè = %ld\n", 
dñè
);

627 
dñètsc
 = ()(
œpic_ˇl_tsc2
 - 
œpic_ˇl_tsc1
);

630 
pm_ª„ªn˚d
 = !
	`ˇlibøã_by_pmtimî
(
œpic_ˇl_pm2
 - 
œpic_ˇl_pm1
,

631 &
dñè
, &
dñètsc
);

634 
œpic_˛ockevít
.
mu…
 = 
	`div_sc
(
dñè
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

635 
œpic_˛ockevít
.
shi·
);

636 
œpic_˛ockevít
.
max_dñè_ns
 =

637 
	`˛ockevít_dñè2ns
(0x7FFFFF, &
œpic_˛ockevít
);

638 
œpic_˛ockevít
.
mö_dñè_ns
 =

639 
	`˛ockevít_dñè2ns
(0xF, &
œpic_˛ockevít
);

641 
ˇlibøti⁄_ªsu…
 = (
dñè
 * 
APIC_DIVISOR
Ë/ 
LAPIC_CAL_LOOPS
;

643 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... dñè %ld\n", 
dñè
);

644 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... mu…: %u\n", 
œpic_˛ockevít
.
mu…
);

645 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... calibrationÑesult: %u\n",

646 
ˇlibøti⁄_ªsu…
);

648 i‡(
˝u_has_tsc
) {

649 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... CPU clock speed is "

651 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë/ (1000000 / 
HZ
),

652 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë% (1000000 / 
HZ
));

655 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... host bus clock speed is "

657 
ˇlibøti⁄_ªsu…
 / (1000000 / 
HZ
),

658 
ˇlibøti⁄_ªsu…
 % (1000000 / 
HZ
));

663 i‡(
ˇlibøti⁄_ªsu…
 < (1000000 / 
HZ
)) {

664 
	`loˇl_úq_íabÀ
();

665 
	`¥_w¨nög
("APIC frequencyÅoo slow, disablingápicÅimer\n");

669 
Àvt
->
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

675 i‡(!
pm_ª„ªn˚d
) {

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... verify APICÅimer\n");

681 
Àvt
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

682 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Àvt
);

683 
œpic_ˇl_lo›s
 = -1;

686 
	`loˇl_úq_íabÀ
();

688 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

689 
	`˝u_ªœx
();

692 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Àvt
);

695 
dñèj
 = 
œpic_ˇl_j2
 - 
œpic_ˇl_j1
;

696 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffõ†dñè = %lu\n", 
dñèj
);

699 i‡(
dñèj
 >
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

700 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffiesÑesult ok\n");

702 
Àvt
->
„©uªs
 |
CLOCK_EVT_FEAT_DUMMY
;

704 
	`loˇl_úq_íabÀ
();

706 i‡(
Àvt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
) {

707 
	`¥_w¨nög
("APICÅimer disabled dueÅo verification failure\n");

712 
	}
}

719 
__öô
 
	$£tup_boŸ_APIC_˛ock
()

727 i‡(
dißbÀ_≠ic_timî
) {

728 
	`¥_öfo
("Disabling APICÅimer\n");

730 i‡(
	`num_possibÀ_˝us
() > 1) {

731 
œpic_˛ockevít
.
mu…
 = 1;

732 
	`£tup_APIC_timî
();

737 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "UsingÜocal APICÅimer interrupts.\n"

740 i‡(
	`ˇlibøã_APIC_˛ock
()) {

742 i‡(
	`num_possibÀ_˝us
() > 1)

743 
	`£tup_APIC_timî
();

752 i‡(
nmi_w©chdog
 !
NMI_IO_APIC
)

753 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

755 
	`¥_w¨nög
("APICÅimerÑegisteredás dummy,"

756 " duêtÿnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

759 
	`£tup_APIC_timî
();

760 
	}
}

762 
__˝uöô
 
	$£tup_£c⁄d¨y_APIC_˛ock
()

764 
	`£tup_APIC_timî
();

765 
	}
}

770 
	$loˇl_≠ic_timî_öãºu±
()

772 
˝u
 = 
	`smp_¥o˚ss‹_id
();

773 
˛ock_evít_devi˚
 *
evt
 = &
	`≥r_˝u
(
œpic_evíts
, 
˝u
);

786 i‡(!
evt
->
evít_h™dÀr
) {

787 
	`¥_w¨nög
("Spuriou†LAPICÅimî i¡îru± o¿˝u %d\n", 
˝u
);

789 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

796 
	`öc_úq_°©
(
≠ic_timî_úqs
);

798 
evt
->
	`evít_h™dÀr
(evt);

799 
	}
}

809 
__úq_íåy
 
	$smp_≠ic_timî_öãºu±
(
±_ªgs
 *
ªgs
)

811 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

817 
	`ack_APIC_úq
();

823 
	`exô_idÀ
();

824 
	`úq_íãr
();

825 
	`loˇl_≠ic_timî_öãºu±
();

826 
	`úq_exô
();

828 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

829 
	}
}

831 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

833  -
EINVAL
;

834 
	}
}

847 
	$˛ór_loˇl_APIC
()

849 
maxlvt
;

850 
u32
 
v
;

853 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

856 
maxlvt
 = 
	`œpic_gë_maxlvt
();

861 i‡(
maxlvt
 >= 3) {

862 
v
 = 
ERROR_APIC_VECTOR
;

863 
	`≠ic_wrôe
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

869 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

870 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

871 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

872 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

873 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

874 
	`≠ic_wrôe
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

875 i‡(
maxlvt
 >= 4) {

876 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

877 
	`≠ic_wrôe
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

881 #ifde‡
CONFIG_X86_THERMAL_VECTOR


882 i‡(
maxlvt
 >= 5) {

883 
v
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

884 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

887 #ifde‡
CONFIG_X86_MCE_INTEL


888 i‡(
maxlvt
 >= 6) {

889 
v
 = 
	`≠ic_ªad
(
APIC_LVTCMCI
);

890 i‡(!(
v
 & 
APIC_LVT_MASKED
))

891 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

898 
	`≠ic_wrôe
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

899 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

900 
	`≠ic_wrôe
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

901 i‡(
maxlvt
 >= 3)

902 
	`≠ic_wrôe
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

903 i‡(
maxlvt
 >= 4)

904 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

907 i‡(
	`œpic_is_öãgøãd
()) {

908 i‡(
maxlvt
 > 3)

910 
	`≠ic_wrôe
(
APIC_ESR
, 0);

911 
	`≠ic_ªad
(
APIC_ESR
);

913 
	}
}

918 
	$dißbÀ_loˇl_APIC
()

920 
vÆue
;

923 i‡(!
≠ic_phys
)

926 
	`˛ór_loˇl_APIC
();

932 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

933 
vÆue
 &~
APIC_SPIV_APIC_ENABLED
;

934 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

936 #ifde‡
CONFIG_X86_32


941 i‡(
íabÀd_vü_≠icba£
) {

942 
l
, 
h
;

944 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

945 
l
 &~
MSR_IA32_APICBASE_ENABLE
;

946 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

949 
	}
}

957 
	$œpic_shutdown
()

959 
Êags
;

961 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

964 
	`loˇl_úq_ßve
(
Êags
);

966 #ifde‡
CONFIG_X86_32


967 i‡(!
íabÀd_vü_≠icba£
)

968 
	`˛ór_loˇl_APIC
();

971 
	`dißbÀ_loˇl_APIC
();

974 
	`loˇl_úq_ª°‹e
(
Êags
);

975 
	}
}

982 
__öô
 
	$vîify_loˇl_APIC
()

984 
ªg0
, 
ªg1
;

989 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVR
);

990 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg0
);

991 
	`≠ic_wrôe
(
APIC_LVR
, 
ªg0
 ^ 
APIC_LVR_MASK
);

992 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVR
);

993 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg1
);

1000 i‡(
ªg1
 !
ªg0
)

1006 
ªg1
 = 
	`GET_APIC_VERSION
(
ªg0
);

1007 i‡(
ªg1
 == 0x00 ||Ñeg1 == 0xff)

1009 
ªg1
 = 
	`œpic_gë_maxlvt
();

1010 i‡(
ªg1
 < 0x02 ||Ñeg1 == 0xff)

1016 
ªg0
 = 
	`≠ic_ªad
(
APIC_ID
);

1017 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg0
);

1018 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
 ^ 
≠ic
->
≠ic_id_mask
);

1019 
ªg1
 = 
	`≠ic_ªad
(
APIC_ID
);

1020 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg1
);

1021 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
);

1022 i‡(
ªg1
 !(
ªg0
 ^ 
≠ic
->
≠ic_id_mask
))

1030 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1031 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT0: %x\n", 
ªg0
);

1032 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1033 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT1: %x\n", 
ªg1
);

1036 
	}
}

1041 
__öô
 
	$sync_Arb_IDs
()

1047 i‡(
	`modîn_≠ic
(Ë|| 
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
)

1053 
	`≠ic_waô_i¸_idÀ
();

1055 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1056 
	`≠ic_wrôe
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1057 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1058 
	}
}

1063 
__öô
 
	$öô_b•_APIC
()

1065 
vÆue
;

1071 i‡(
smp_found_c⁄fig
 || !
˝u_has_≠ic
)

1077 
	`˛ór_loˇl_APIC
();

1082 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1083 
vÆue
 &~
APIC_VECTOR_MASK
;

1084 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1086 #ifde‡
CONFIG_X86_32


1088 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

1089 (
boŸ_˝u_d©a
.
x86
 == 15))

1090 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1093 
vÆue
 |
APIC_SPIV_FOCUS_DISABLED
;

1094 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1095 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1100 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1101 
vÆue
 = 
APIC_DM_NMI
;

1102 i‡(!
	`œpic_is_öãgøãd
())

1103 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1104 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1105 
	}
}

1107 
__˝uöô
 
	$œpic_£tup_e§
()

1109 
ﬁdvÆue
, 
vÆue
, 
maxlvt
;

1111 i‡(!
	`œpic_is_öãgøãd
()) {

1112 
	`¥_öfo
("No ESR for 82489DX.\n");

1116 i‡(
≠ic
->
dißbÀ_e§
) {

1123 
	`¥_öfo
("Leaving ESR disabled.\n");

1127 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1128 i‡(
maxlvt
 > 3)

1129 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1130 
ﬁdvÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1133 
vÆue
 = 
ERROR_APIC_VECTOR
;

1134 
	`≠ic_wrôe
(
APIC_LVTERR
, 
vÆue
);

1139 i‡(
maxlvt
 > 3)

1140 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1141 
vÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1142 i‡(
vÆue
 !
ﬁdvÆue
)

1143 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ESR value beforeÉnabling "

1145 
ﬁdvÆue
, 
vÆue
);

1146 
	}
}

1152 
__˝uöô
 
	$£tup_loˇl_APIC
()

1154 
vÆue
;

1155 
i
, 
j
;

1157 i‡(
dißbÀ_≠ic
) {

1158 
	`¨ch_dißbÀ_smp_suµ‹t
();

1162 #ifde‡
CONFIG_X86_32


1164 i‡(
	`œpic_is_öãgøãd
(Ë&& 
≠ic
->
dißbÀ_e§
) {

1165 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1166 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1167 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1168 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1171 
	`≥rf_evíts_œpic_öô
();

1173 
	`¥ìm±_dißbÀ
();

1179 
	`BUG_ON
(!
≠ic
->
	`≠ic_id_ªgi°îed
());

1186 
≠ic
->
	`öô_≠ic_ldr
();

1192 
vÆue
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1193 
vÆue
 &~
APIC_TPRI_MASK
;

1194 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
vÆue
);

1207 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1208 
vÆue
 = 
	`≠ic_ªad
(
APIC_ISR
 + 
i
*0x10);

1209 
j
 = 31; j >= 0; j--) {

1210 i‡(
vÆue
 & (1<<
j
))

1211 
	`ack_APIC_úq
();

1218 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1219 
vÆue
 &~
APIC_VECTOR_MASK
;

1223 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1225 #ifde‡
CONFIG_X86_32


1251 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1257 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1258 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1270 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
Ë& 
APIC_LVT_MASKED
;

1271 i‡(!
	`smp_¥o˚ss‹_id
(Ë&& (
pic_mode
 || !
vÆue
)) {

1272 
vÆue
 = 
APIC_DM_EXTINT
;

1273 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1274 
	`smp_¥o˚ss‹_id
());

1276 
vÆue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1277 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1278 
	`smp_¥o˚ss‹_id
());

1280 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1285 i‡(!
	`smp_¥o˚ss‹_id
())

1286 
vÆue
 = 
APIC_DM_NMI
;

1288 
vÆue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1289 i‡(!
	`œpic_is_öãgøãd
())

1290 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1291 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1293 
	`¥ìm±_íabÀ
();

1295 #ifde‡
CONFIG_X86_MCE_INTEL


1297 i‡(
	`smp_¥o˚ss‹_id
() == 0)

1298 
	`cmci_ªcheck
();

1300 
	}
}

1302 
__˝uöô
 
	$íd_loˇl_APIC_£tup
()

1304 
	`œpic_£tup_e§
();

1306 #ifde‡
CONFIG_X86_32


1308 
vÆue
;

1310 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1311 
vÆue
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1312 
	`≠ic_wrôe
(
APIC_LVTT
, 
vÆue
);

1316 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

1317 
	`≠ic_pm_a˘iv©e
();

1318 
	}
}

1320 #ifde‡
CONFIG_X86_X2APIC


1321 
	$check_x2≠ic
()

1323 i‡(
	`x2≠ic_íabÀd
()) {

1324 
	`¥_öfo
("x2apicÉnabled by BIOS, switchingÅo x2apic ops\n");

1325 
x2≠ic_¥ì«bÀd
 = 
x2≠ic_mode
 = 1;

1327 
	}
}

1329 
	$íabÀ_x2≠ic
()

1331 
m§
, 
m§2
;

1333 i‡(!
x2≠ic_mode
)

1336 
	`rdm§
(
MSR_IA32_APICBASE
, 
m§
, 
m§2
);

1337 i‡(!(
m§
 & 
X2APIC_ENABLE
)) {

1338 
	`¥ötk_⁄˚
(
KERN_INFO
 "Enabling x2apic\n");

1339 
	`wrm§
(
MSR_IA32_APICBASE
, 
m§
 | 
X2APIC_ENABLE
, 0);

1341 
	}
}

1344 
__öô
 
	$íabÀ_IR
()

1346 #ifde‡
CONFIG_INTR_REMAP


1347 i‡(!
	`öå_ªm≠pög_suµ‹ãd
()) {

1348 
	`¥_debug
("intr-remappingÇot supported\n");

1352 i‡(!
x2≠ic_¥ì«bÀd
 && 
skù_iﬂpic_£tup
) {

1353 
	`¥_öfo
("SkippedÉnabling intr-remap because of skipping "

1358 i‡(
	`íabÀ_öå_ªm≠pög
(
	`x2≠ic_suµ‹ãd
()))

1361 
	`¥_öfo
("Enabled Interrupt-remapping\n");

1367 
	}
}

1369 
__öô
 
	$íabÀ_IR_x2≠ic
()

1371 
Êags
;

1372 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

1373 
ªt
, 
x2≠ic_íabÀd
 = 0;

1374 
dm¨_èbÀ_öô_ªt
;

1376 
dm¨_èbÀ_öô_ªt
 = 
	`dm¨_èbÀ_öô
();

1377 i‡(
dm¨_èbÀ_öô_ªt
 && !
	`x2≠ic_suµ‹ãd
())

1380 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

1381 i‡(!
iﬂpic_íåõs
) {

1382 
	`¥_îr
("Allocate ioapic_entries failed\n");

1383 
out
;

1386 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

1387 i‡(
ªt
) {

1388 
	`¥_öfo
("Savög IO-APIC sèã faûed: %d\n", 
ªt
);

1389 
out
;

1392 
	`loˇl_úq_ßve
(
Êags
);

1393 
	`mask_8259A
();

1394 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

1396 i‡(
dm¨_èbÀ_öô_ªt
)

1397 
ªt
 = 0;

1399 
ªt
 = 
	`íabÀ_IR
();

1401 i‡(!
ªt
) {

1405 i‡(
max_physiˇl_≠icid
 > 255 || !
	`kvm_∑ø_avaûabÀ
())

1406 
nox2≠ic
;

1411 
	`x2≠ic_f‹˚_phys
();

1414 
x2≠ic_íabÀd
 = 1;

1416 i‡(
	`x2≠ic_suµ‹ãd
(Ë&& !
x2≠ic_mode
) {

1417 
x2≠ic_mode
 = 1;

1418 
	`íabÀ_x2≠ic
();

1419 
	`¥_öfo
("Enabled x2apic\n");

1422 
nox2≠ic
:

1423 i‡(!
ªt
)

1424 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

1425 
	`unmask_8259A
();

1426 
	`loˇl_úq_ª°‹e
(
Êags
);

1428 
out
:

1429 i‡(
iﬂpic_íåõs
)

1430 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

1432 i‡(
x2≠ic_íabÀd
)

1435 i‡(
x2≠ic_¥ì«bÀd
)

1436 
	`∑nic
("x2apic:Énabled by BIOS but kernel init failed.");

1437 i‡(
˝u_has_x2≠ic
)

1438 
	`¥_öfo
("NotÉnabling x2apic, Intr-remapping init failed.\n");

1439 
	}
}

1441 #ifde‡
CONFIG_X86_64


1448 
__öô
 
	$dëe˘_öô_APIC
()

1450 i‡(!
˝u_has_≠ic
) {

1451 
	`¥_öfo
("NoÜocal APICÖresent\n");

1455 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1457 
	}
}

1462 
__öô
 
	$dëe˘_öô_APIC
()

1464 
u32
 
h
, 
l
, 
„©uªs
;

1467 i‡(
dißbÀ_≠ic
)

1470 
boŸ_˝u_d©a
.
x86_víd‹
) {

1471 
X86_VENDOR_AMD
:

1472 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 > 1) ||

1473 (
boŸ_˝u_d©a
.
x86
 >= 15))

1475 
no_≠ic
;

1476 
X86_VENDOR_INTEL
:

1477 i‡(
boŸ_˝u_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1478 (
boŸ_˝u_d©a
.
x86
 =5 && 
˝u_has_≠ic
))

1480 
no_≠ic
;

1482 
no_≠ic
;

1485 i‡(!
˝u_has_≠ic
) {

1490 i‡(!
f‹˚_íabÀ_loˇl_≠ic
) {

1491 
	`¥_öfo
("Local APIC disabled by BIOS -- "

1500 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1501 i‡(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1502 
	`¥_öfo
("Local APIC disabled by BIOS --Ñeenabling.\n");

1503 
l
 &~
MSR_IA32_APICBASE_BASE
;

1504 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1505 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1506 
íabÀd_vü_≠icba£
 = 1;

1513 
„©uªs
 = 
	`˝uid_edx
(1);

1514 i‡(!(
„©uªs
 & (1 << 
X86_FEATURE_APIC
))) {

1515 
	`¥_w¨nög
("CouldÇotÉnable APIC!\n");

1518 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1519 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1522 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1523 i‡(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1524 
mp_œpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1526 
	`¥_öfo
("FoundándÉnabledÜocal APIC!\n");

1528 
	`≠ic_pm_a˘iv©e
();

1532 
no_≠ic
:

1533 
	`¥_öfo
("NoÜocal APICÖresent or hardware disabled\n");

1535 
	}
}

1538 #ifde‡
CONFIG_X86_64


1539 
__öô
 
	$óæy_öô_œpic_m≠pög
()

1545 i‡(!
smp_found_c⁄fig
)

1548 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
mp_œpic_addr
);

1549 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %16lx (%16lx)\n",

1550 
APIC_BASE
, 
mp_œpic_addr
);

1556 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1557 
	}
}

1563 
__öô
 
	$öô_≠ic_m≠pögs
()

1565 
√w_≠icid
;

1567 i‡(
x2≠ic_mode
) {

1568 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1573 i‡(!
smp_found_c⁄fig
 && 
	`dëe˘_öô_APIC
()) {

1575 
	`¥_öfo
("APIC: disableápic facility\n");

1576 
	`≠ic_dißbÀ
();

1578 
≠ic_phys
 = 
mp_œpic_addr
;

1584 i‡(!
a˝i_œpic
)

1585 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
≠ic_phys
);

1587 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %08lx (%08lx)\n",

1588 
APIC_BASE
, 
≠ic_phys
);

1595 
√w_≠icid
 = 
	`ªad_≠ic_id
();

1596 i‡(
boŸ_˝u_physiˇl_≠icid
 !
√w_≠icid
) {

1597 
boŸ_˝u_physiˇl_≠icid
 = 
√w_≠icid
;

1605 
≠ic_vîsi⁄
[
√w_≠icid
] =

1606 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

1608 
	}
}

1614 
	g≠ic_vîsi⁄
[
MAX_APICS
];

1616 
__öô
 
	$APIC_öô_unùro˚ss‹
()

1618 i‡(
dißbÀ_≠ic
) {

1619 
	`¥_öfo
("Apic disabled\n");

1622 #ifde‡
CONFIG_X86_64


1623 i‡(!
˝u_has_≠ic
) {

1624 
dißbÀ_≠ic
 = 1;

1625 
	`¥_öfo
("Apic disabled by BIOS\n");

1629 i‡(!
smp_found_c⁄fig
 && !
˝u_has_≠ic
)

1635 i‡(!
˝u_has_≠ic
 &&

1636 
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

1637 
	`¥_îr
("BIOS bug,Üocal APIC 0x%xÇot detected!...\n",

1638 
boŸ_˝u_physiˇl_≠icid
);

1643 
	`íabÀ_IR_x2≠ic
();

1644 
	`deÁu…_£tup_≠ic_routög
();

1646 
	`vîify_loˇl_APIC
();

1647 
	`c⁄√˘_b•_APIC
();

1649 #ifde‡
CONFIG_X86_64


1650 
	`≠ic_wrôe
(
APIC_ID
, 
	`SET_APIC_ID
(
boŸ_˝u_physiˇl_≠icid
));

1657 #ifde‡
CONFIG_CRASH_DUMP


1658 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1661 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

1662 
	`£tup_loˇl_APIC
();

1664 #ifde‡
CONFIG_X86_IO_APIC


1669 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1670 
	`íabÀ_IO_APIC
();

1673 
	`íd_loˇl_APIC_£tup
();

1675 #ifde‡
CONFIG_X86_IO_APIC


1676 i‡(
smp_found_c⁄fig
 && !
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1677 
	`£tup_IO_APIC
();

1679 
ƒ_iﬂpics
 = 0;

1680 
	`loˇli£_nmi_w©chdog
();

1683 
	`loˇli£_nmi_w©chdog
();

1686 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1687 #ifde‡
CONFIG_X86_64


1688 
	`check_nmi_w©chdog
();

1692 
	}
}

1701 
	$smp_•urious_öãºu±
(
±_ªgs
 *
ªgs
)

1703 
u32
 
v
;

1705 
	`exô_idÀ
();

1706 
	`úq_íãr
();

1712 
v
 = 
	`≠ic_ªad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1713 i‡(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1714 
	`ack_APIC_úq
();

1716 
	`öc_úq_°©
(
úq_•urious_cou¡
);

1719 
	`¥_öfo
("spurious APIC interrupt on CPU#%d, "

1720 "shouldÇevî h≠≥n.\n", 
	`smp_¥o˚ss‹_id
());

1721 
	`úq_exô
();

1722 
	}
}

1727 
	$smp_îr‹_öãºu±
(
±_ªgs
 *
ªgs
)

1729 
u32
 
v
, 
v1
;

1731 
	`exô_idÀ
();

1732 
	`úq_íãr
();

1734 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1735 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1736 
v1
 = 
	`≠ic_ªad
(
APIC_ESR
);

1737 
	`ack_APIC_úq
();

1738 
	`©omic_öc
(&
úq_îr_cou¡
);

1751 
	`¥_debug
("APICÉrror on CPU%d: %02x(%02x)\n",

1752 
	`smp_¥o˚ss‹_id
(), 
v
 , 
v1
);

1753 
	`úq_exô
();

1754 
	}
}

1759 
__öô
 
	$c⁄√˘_b•_APIC
()

1761 #ifde‡
CONFIG_X86_32


1762 i‡(
pic_mode
) {

1766 
	`˛ór_loˇl_APIC
();

1771 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "leaving PIC mode, "

1773 
	`im¸_pic_to_≠ic
();

1776 i‡(
≠ic
->
íabÀ_≠ic_mode
)

1777 
≠ic
->
	`íabÀ_≠ic_mode
();

1778 
	}
}

1787 
	$disc⁄√˘_b•_APIC
(
vút_wúe_£tup
)

1789 
vÆue
;

1791 #ifde‡
CONFIG_X86_32


1792 i‡(
pic_mode
) {

1799 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "disabling APIC mode, "

1801 
	`im¸_≠ic_to_pic
();

1809 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1810 
vÆue
 &~
APIC_VECTOR_MASK
;

1811 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1812 
vÆue
 |= 0xf;

1813 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1815 i‡(!
vút_wúe_£tup
) {

1820 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1821 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1822 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1823 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1824 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1825 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_EXTINT
);

1826 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1829 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1836 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1837 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1838 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1839 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1840 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1841 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_NMI
);

1842 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1843 
	}
}

1845 
__˝uöô
 
	$gíîic_¥o˚ss‹_öfo
(
≠icid
, 
vîsi⁄
)

1847 
˝u
;

1852 i‡(
vîsi⁄
 == 0x0) {

1853 
	`¥_w¨nög
("BIOS bug, APIC version is 0 for CPU#%d! "

1855 
vîsi⁄
);

1856 
vîsi⁄
 = 0x10;

1858 
≠ic_vîsi⁄
[
≠icid
] = 
vîsi⁄
;

1860 i‡(
num_¥o˚ss‹s
 >
ƒ_˝u_ids
) {

1861 
max
 = 
ƒ_˝u_ids
;

1862 
this˝u
 = 
max
 + 
dißbÀd_˝us
;

1864 
	`¥_w¨nög
(

1866 " Pro˚ss‹ %d/0x%x ign‹ed.\n", 
max
, 
this˝u
, 
≠icid
);

1868 
dißbÀd_˝us
++;

1872 
num_¥o˚ss‹s
++;

1873 
˝u
 = 
	`˝umask_√xt_zîo
(-1, 
˝u_¥e£¡_mask
);

1875 i‡(
vîsi⁄
 !
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])

1876 
	`WARN_ONCE
(1,

1878 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
], 
˝u
, 
vîsi⁄
);

1880 
	`physid_£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
);

1881 i‡(
≠icid
 =
boŸ_˝u_physiˇl_≠icid
) {

1887 
˝u
 = 0;

1889 i‡(
≠icid
 > 
max_physiˇl_≠icid
)

1890 
max_physiˇl_≠icid
 = 
≠icid
;

1892 #i‡
	`deföed
(
CONFIG_SMP
Ë|| deföed(
CONFIG_X86_64
)

1893 
	`óæy_≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
≠icid
;

1894 
	`óæy_≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
Ë
≠icid
;

1897 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

1898 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

1899 
	}
}

1901 
	$h¨d_smp_¥o˚ss‹_id
()

1903  
	`ªad_≠ic_id
();

1904 
	}
}

1906 
	$deÁu…_öô_≠ic_ldr
()

1908 
vÆ
;

1910 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1911 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

1912 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_¥o˚ss‹_id
());

1913 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

1914 
	}
}

1916 #ifde‡
CONFIG_X86_32


1917 
	$deÁu…_≠icid_to_node
(
logiˇl_≠icid
)

1919 #ifde‡
CONFIG_SMP


1920  
≠icid_2_node
[
	`h¨d_smp_¥o˚ss‹_id
()];

1924 
	}
}

1930 #ifde‡
CONFIG_PM


1938 
	ma˘ive
;

1940 
	m≠ic_id
;

1941 
	m≠ic_èsk¥i
;

1942 
	m≠ic_ldr
;

1943 
	m≠ic_d‰
;

1944 
	m≠ic_•iv
;

1945 
	m≠ic_lvâ
;

1946 
	m≠ic_lvçc
;

1947 
	m≠ic_lvt0
;

1948 
	m≠ic_lvt1
;

1949 
	m≠ic_lvãº
;

1950 
	m≠ic_tmi˘
;

1951 
	m≠ic_td¸
;

1952 
	m≠ic_thmr
;

1953 } 
	g≠ic_pm_°©e
;

1955 
	$œpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1957 
Êags
;

1958 
maxlvt
;

1960 i‡(!
≠ic_pm_°©e
.
a˘ive
)

1963 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1965 
≠ic_pm_°©e
.
≠ic_id
 = 
	`≠ic_ªad
(
APIC_ID
);

1966 
≠ic_pm_°©e
.
≠ic_èsk¥i
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1967 
≠ic_pm_°©e
.
≠ic_ldr
 = 
	`≠ic_ªad
(
APIC_LDR
);

1968 
≠ic_pm_°©e
.
≠ic_d‰
 = 
	`≠ic_ªad
(
APIC_DFR
);

1969 
≠ic_pm_°©e
.
≠ic_•iv
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1970 
≠ic_pm_°©e
.
≠ic_lvâ
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1971 i‡(
maxlvt
 >= 4)

1972 
≠ic_pm_°©e
.
≠ic_lvçc
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1973 
≠ic_pm_°©e
.
≠ic_lvt0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1974 
≠ic_pm_°©e
.
≠ic_lvt1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1975 
≠ic_pm_°©e
.
≠ic_lvãº
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1976 
≠ic_pm_°©e
.
≠ic_tmi˘
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1977 
≠ic_pm_°©e
.
≠ic_td¸
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1978 #ifde‡
CONFIG_X86_THERMAL_VECTOR


1979 i‡(
maxlvt
 >= 5)

1980 
≠ic_pm_°©e
.
≠ic_thmr
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

1983 
	`loˇl_úq_ßve
(
Êags
);

1984 
	`dißbÀ_loˇl_APIC
();

1986 i‡(
öå_ªm≠pög_íabÀd
)

1987 
	`dißbÀ_öå_ªm≠pög
();

1989 
	`loˇl_úq_ª°‹e
(
Êags
);

1991 
	}
}

1993 
	$œpic_ªsume
(
sys_devi˚
 *
dev
)

1995 
l
, 
h
;

1996 
Êags
;

1997 
maxlvt
;

1998 
ªt
 = 0;

1999 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

2001 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2004 
	`loˇl_úq_ßve
(
Êags
);

2005 i‡(
öå_ªm≠pög_íabÀd
) {

2006 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

2007 i‡(!
iﬂpic_íåõs
) {

2008 
	`WARN
(1, "Alloc ioapic_entries inÜapicÑesume failed.");

2009 
ªt
 = -
ENOMEM
;

2010 
ª°‹e
;

2013 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

2014 i‡(
ªt
) {

2015 
	`WARN
(1, "Savög IO-APIC sèã faûed: %d\n", 
ªt
);

2016 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2017 
ª°‹e
;

2020 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

2021 
	`mask_8259A
();

2024 i‡(
x2≠ic_mode
)

2025 
	`íabÀ_x2≠ic
();

2033 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2034 
l
 &~
MSR_IA32_APICBASE_BASE
;

2035 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
mp_œpic_addr
;

2036 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2039 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2040 
	`≠ic_wrôe
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2041 
	`≠ic_wrôe
(
APIC_ID
, 
≠ic_pm_°©e
.
≠ic_id
);

2042 
	`≠ic_wrôe
(
APIC_DFR
, 
≠ic_pm_°©e
.
≠ic_d‰
);

2043 
	`≠ic_wrôe
(
APIC_LDR
, 
≠ic_pm_°©e
.
≠ic_ldr
);

2044 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
≠ic_pm_°©e
.
≠ic_èsk¥i
);

2045 
	`≠ic_wrôe
(
APIC_SPIV
, 
≠ic_pm_°©e
.
≠ic_•iv
);

2046 
	`≠ic_wrôe
(
APIC_LVT0
, 
≠ic_pm_°©e
.
≠ic_lvt0
);

2047 
	`≠ic_wrôe
(
APIC_LVT1
, 
≠ic_pm_°©e
.
≠ic_lvt1
);

2048 #i‡
	`deföed
(
CONFIG_X86_MCE_P4THERMAL
Ë|| deföed(
CONFIG_X86_MCE_INTEL
)

2049 i‡(
maxlvt
 >= 5)

2050 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
≠ic_pm_°©e
.
≠ic_thmr
);

2052 i‡(
maxlvt
 >= 4)

2053 
	`≠ic_wrôe
(
APIC_LVTPC
, 
≠ic_pm_°©e
.
≠ic_lvçc
);

2054 
	`≠ic_wrôe
(
APIC_LVTT
, 
≠ic_pm_°©e
.
≠ic_lvâ
);

2055 
	`≠ic_wrôe
(
APIC_TDCR
, 
≠ic_pm_°©e
.
≠ic_td¸
);

2056 
	`≠ic_wrôe
(
APIC_TMICT
, 
≠ic_pm_°©e
.
≠ic_tmi˘
);

2057 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2058 
	`≠ic_ªad
(
APIC_ESR
);

2059 
	`≠ic_wrôe
(
APIC_LVTERR
, 
≠ic_pm_°©e
.
≠ic_lvãº
);

2060 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2061 
	`≠ic_ªad
(
APIC_ESR
);

2063 i‡(
öå_ªm≠pög_íabÀd
) {

2064 
	`ªíabÀ_öå_ªm≠pög
(
x2≠ic_mode
);

2065 
	`unmask_8259A
();

2066 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

2067 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2069 
ª°‹e
:

2070 
	`loˇl_úq_ª°‹e
(
Êags
);

2072  
ªt
;

2073 
	}
}

2080 
sysdev_˛ass
 
	gœpic_sys˛ass
 = {

2081 .
«me
 = "lapic",

2082 .
	gªsume
 = 
œpic_ªsume
,

2083 .
	gsu•íd
 = 
œpic_su•íd
,

2086 
sys_devi˚
 
	gdevi˚_œpic
 = {

2087 .
id
 = 0,

2088 .
	g˛s
 = &
œpic_sys˛ass
,

2091 
__˝uöô
 
	$≠ic_pm_a˘iv©e
()

2093 
≠ic_pm_°©e
.
a˘ive
 = 1;

2094 
	}
}

2096 
__öô
 
	$öô_œpic_sysfs
()

2098 
îr‹
;

2100 i‡(!
˝u_has_≠ic
)

2104 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
œpic_sys˛ass
);

2105 i‡(!
îr‹
)

2106 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic
);

2107  
îr‹
;

2108 
	}
}

2111 
c‹e_öôˇŒ
(
öô_œpic_sysfs
);

2115 
	$≠ic_pm_a˘iv©e
(Ë{ 
	}
}

2119 #ifde‡
CONFIG_X86_64


2121 
__˝uöô
 
	$≠ic_˛u°î_num
()

2123 
i
, 
˛u°îs
, 
zîos
;

2124 
id
;

2125 
u16
 *
bios_˝u_≠icid
;

2126 
	`DECLARE_BITMAP
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2128 
bios_˝u_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
);

2129 
	`bôm≠_zîo
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2131 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

2133 i‡(
bios_˝u_≠icid
) {

2134 
id
 = 
bios_˝u_≠icid
[
i
];

2135 } i‡(
i
 < 
ƒ_˝u_ids
) {

2136 i‡(
	`˝u_¥e£¡
(
i
))

2137 
id
 = 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
i
);

2143 i‡(
id
 !
BAD_APICID
)

2144 
	`__£t_bô
(
	`APIC_CLUSTERID
(
id
), 
˛u°îm≠
);

2153 
˛u°îs
 = 0;

2154 
zîos
 = 0;

2155 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2156 i‡(
	`ã°_bô
(
i
, 
˛u°îm≠
)) {

2157 
˛u°îs
 +1 + 
zîos
;

2158 
zîos
 = 0;

2160 ++
zîos
;

2163  
˛u°îs
;

2164 
	}
}

2166 
__˝uöôd©a
 
	gmu…i_checked
;

2167 
__˝uöôd©a
 
	gmu…i
;

2169 
__˝uöô
 
	$£t_mu…i
(c⁄° 
dmi_sy°em_id
 *
d
)

2171 i‡(
mu…i
)

2173 
	`¥_öfo
("APIC: %†dëe˘ed, Mu…òChassis\n", 
d
->
idít
);

2174 
mu…i
 = 1;

2176 
	}
}

2178 c⁄° 
__˝uöôc⁄°
 
dmi_sy°em_id
 
	gmu…i_dmi_èbÀ
[] = {

2180 .
ˇŒback
 = 
£t_mu…i
,

2181 .
	gidít
 = "IBM System Summit2",

2182 .
	gm©ches
 = {

2183 
DMI_MATCH
(
DMI_SYS_VENDOR
, "IBM"),

2184 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Summit2"),

2190 
__˝uöô
 
	$dmi_check_mu…i
()

2192 i‡(
mu…i_checked
)

2195 
	`dmi_check_sy°em
(
mu…i_dmi_èbÀ
);

2196 
mu…i_checked
 = 1;

2197 
	}
}

2207 
__˝uöô
 
	$≠ic_is_˛u°îed_box
()

2209 
	`dmi_check_mu…i
();

2210 i‡(
mu…i
)

2213 i‡(!
	`is_vsmp_box
())

2220 i‡(
	`≠ic_˛u°î_num
() > 1)

2224 
	}
}

2230 
__öô
 
	$£tup_dißbÀ≠ic
(*
¨g
)

2232 
dißbÀ_≠ic
 = 1;

2233 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

2235 
	}
}

2236 
óæy_∑øm
("dißbÀ≠ic", 
£tup_dißbÀ≠ic
);

2239 
__öô
 
	$£tup_nﬁ≠ic
(*
¨g
)

2241  
	`£tup_dißbÀ≠ic
(
¨g
);

2242 
	}
}

2243 
óæy_∑øm
("nﬁ≠ic", 
£tup_nﬁ≠ic
);

2245 
__öô
 
	$∑r£_œpic_timî_c2_ok
(*
¨g
)

2247 
loˇl_≠ic_timî_c2_ok
 = 1;

2249 
	}
}

2250 
óæy_∑øm
("œpic_timî_c2_ok", 
∑r£_œpic_timî_c2_ok
);

2252 
__öô
 
	$∑r£_dißbÀ_≠ic_timî
(*
¨g
)

2254 
dißbÀ_≠ic_timî
 = 1;

2256 
	}
}

2257 
óæy_∑øm
("nﬂpi˘imî", 
∑r£_dißbÀ_≠ic_timî
);

2259 
__öô
 
	$∑r£_nﬁ≠ic_timî
(*
¨g
)

2261 
dißbÀ_≠ic_timî
 = 1;

2263 
	}
}

2264 
óæy_∑øm
("nﬁ≠ic_timî", 
∑r£_nﬁ≠ic_timî
);

2266 
__öô
 
	$≠ic_£t_vîbosôy
(*
¨g
)

2268 i‡(!
¨g
) {

2269 #ifde‡
CONFIG_X86_64


2270 
skù_iﬂpic_£tup
 = 0;

2273  -
EINVAL
;

2276 i‡(
	`°rcmp
("debug", 
¨g
) == 0)

2277 
≠ic_vîbosôy
 = 
APIC_DEBUG
;

2278 i‡(
	`°rcmp
("vîbo£", 
¨g
) == 0)

2279 
≠ic_vîbosôy
 = 
APIC_VERBOSE
;

2281 
	`¥_w¨nög
("APIC VerbosityÜevel %sÇotÑecognised"

2282 " u£ápic=vîbo£ o∏≠ic=debug\n", 
¨g
);

2283  -
EINVAL
;

2287 
	}
}

2288 
óæy_∑øm
("≠ic", 
≠ic_£t_vîbosôy
);

2290 
__öô
 
	$œpic_ö£π_ªsour˚
()

2292 i‡(!
≠ic_phys
)

2296 
œpic_ªsour˚
.
°¨t
 = 
≠ic_phys
;

2297 
œpic_ªsour˚
.
íd
 =Ü≠ic_ªsour˚.
°¨t
 + 
PAGE_SIZE
 - 1;

2298 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
œpic_ªsour˚
);

2301 
	}
}

2307 
œã_öôˇŒ
(
œpic_ö£π_ªsour˚
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/≠ic.h
>

21 
	~<asm/ùi.h
>

23 #ifde‡
CONFIG_ACPI


24 
	~<a˝i/a˝i_bus.h
>

27 
	$Ê©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

30 
	}
}

32 c⁄° 
˝umask
 *
	$Ê©_èrgë_˝us
()

34  
˝u_⁄löe_mask
;

35 
	}
}

37 
	$Ê©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

47 
	`˝umask_˛ór
(
ªtmask
);

48 
	`˝umask_bôs
(
ªtmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$Ê©_öô_≠ic_ldr
()

60 
vÆ
;

61 
num
, 
id
;

63 
num
 = 
	`smp_¥o˚ss‹_id
();

64 
id
 = 1UL << 
num
;

65 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

67 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

69 
	}
}

71 
ölöe
 
	$_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
)

73 
Êags
;

75 
	`loˇl_úq_ßve
(
Êags
);

76 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

77 
	`loˇl_úq_ª°‹e
(
Êags
);

78 
	}
}

80 
	$Ê©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

82 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

84 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

85 
	}
}

88 
	$Ê©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

90 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

91 
˝u
 = 
	`smp_¥o˚ss‹_id
();

93 i‡(
˝u
 < 
BITS_PER_LONG
)

94 
	`˛ór_bô
(
˝u
, &
mask
);

96 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

97 
	}
}

99 
	$Ê©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

101 
˝u
 = 
	`smp_¥o˚ss‹_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hŸ∂ug
 = 1;

105 
hŸ∂ug
 = 0;

107 i‡(
hŸ∂ug
 || 
ve˘‹
 =
NMI_VECTOR
) {

108 i‡(!
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
	`˝umask_of
(
˝u
))) {

109 
mask
 = 
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0];

111 i‡(
˝u
 < 
BITS_PER_LONG
)

112 
	`˛ór_bô
(
˝u
, &
mask
);

114 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

116 } i‡(
	`num_⁄löe_˝us
() > 1) {

117 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLBUT
,

118 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

120 
	}
}

122 
	$Ê©_£nd_IPI_Æl
(
ve˘‹
)

124 i‡(
ve˘‹
 =
NMI_VECTOR
) {

125 
	`Ê©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

127 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLINC
,

128 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

130 
	}
}

132 
	$Ê©_gë_≠ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_≠ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$ªad_x≠ic_id
()

151 
id
;

153 
id
 = 
	`Ê©_gë_≠ic_id
(
	`≠ic_ªad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$Ê©_≠ic_id_ªgi°îed
()

159  
	`physid_is£t
(
	`ªad_x≠ic_id
(), 
phys_˝u_¥e£¡_m≠
);

160 
	}
}

162 
	$Ê©_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

164  
öôül_≠ic_id
 >> 
ödex_msb
;

165 
	}
}

167 
≠ic
 
	g≠ic_Ê©
 = {

168 .
«me
 = "flat",

169 .
	g¥obe
 = 
NULL
,

170 .
	ga˝i_madt_€m_check
 = 
Ê©_a˝i_madt_€m_check
,

171 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

173 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

174 .
	gúq_de°_mode
 = 1,

176 .
	gèrgë_˝us
 = 
Ê©_èrgë_˝us
,

177 .
	gdißbÀ_e§
 = 0,

178 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_≠icid_u£d
 = 
NULL
,

180 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

182 .
	gve˘‹_Æloˇti⁄_domaö
 = 
Ê©_ve˘‹_Æloˇti⁄_domaö
,

183 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

185 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

186 .
	g£tup_≠ic_routög
 = 
NULL
,

187 .
	gmu…i_timî_check
 = 
NULL
,

188 .
	g≠icid_to_node
 = 
NULL
,

189 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

190 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

191 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

192 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

193 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

194 .
	gíabÀ_≠ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

196 .
	gmps_€m_check
 = 
NULL
,

198 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

199 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

200 .
	g≠ic_id_mask
 = 0xFFu << 24,

202 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

203 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

205 .
	g£nd_IPI_mask
 = 
Ê©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_Ælbut£lf
 = 
Ê©_£nd_IPI_mask_Ælbut£lf
,

207 .
	g£nd_IPI_Ælbut£lf
 = 
Ê©_£nd_IPI_Ælbut£lf
,

208 .
	g£nd_IPI_Æl
 = 
Ê©_£nd_IPI_Æl
,

209 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

211 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

214 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

215 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

217 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

218 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

219 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

220 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

221 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

222 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

230 
	$physÊ©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

232 #ifde‡
CONFIG_ACPI


238 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

239 (
a˝i_gbl_FADT
.
Êags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`¥ötk
(
KERN_DEBUG
 "system APIC only can useÖhysical flat");

244 i‡(!
	`°∫cmp
(
€m_id
, "IBM", 3Ë&& !°∫cmp(
€m_èbÀ_id
, "EXA", 3)) {

245 
	`¥ötk
(
KERN_DEBUG
 "IBM Summit detected, will useápicÖhysical");

251 
	}
}

253 c⁄° 
˝umask
 *
	$physÊ©_èrgë_˝us
()

255  
˝u_⁄löe_mask
;

256 
	}
}

258 
	$physÊ©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

260 
	`˝umask_˛ór
(
ªtmask
);

261 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

262 
	}
}

264 
	$physÊ©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

266 
	`deÁu…_£nd_IPI_mask_£quí˚_phys
(
˝umask
, 
ve˘‹
);

267 
	}
}

269 
	$physÊ©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *cpumask,

270 
ve˘‹
)

272 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝umask
, 
ve˘‹
);

273 
	}
}

275 
	$physÊ©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

277 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝u_⁄löe_mask
, 
ve˘‹
);

278 
	}
}

280 
	$physÊ©_£nd_IPI_Æl
(
ve˘‹
)

282 
	`physÊ©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

283 
	}
}

285 
	$physÊ©_˝u_mask_to_≠icid
(c⁄° 
˝umask
 *cpumask)

287 
˝u
;

293 
˝u
 = 
	`˝umask_fú°
(
˝umask
);

294 i‡(()
˝u
 < 
ƒ_˝u_ids
)

295  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

297  
BAD_APICID
;

298 
	}
}

301 
	$physÊ©_˝u_mask_to_≠icid_™d
(c⁄° 
˝umask
 *cpumask,

302 c⁄° 
˝umask
 *
™dmask
)

304 
˝u
;

310 
	`f‹_óch_˝u_™d
(
˝u
, 
˝umask
, 
™dmask
) {

311 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_⁄löe_mask
))

314  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

315 
	}
}

317 
≠ic
 
	g≠ic_physÊ©
 = {

319 .
«me
 = "physical flat",

320 .
	g¥obe
 = 
NULL
,

321 .
	ga˝i_madt_€m_check
 = 
physÊ©_a˝i_madt_€m_check
,

322 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

324 .
	gúq_dñivîy_mode
 = 
de°_Fixed
,

325 .
	gúq_de°_mode
 = 0,

327 .
	gèrgë_˝us
 = 
physÊ©_èrgë_˝us
,

328 .
	gdißbÀ_e§
 = 0,

329 .
	gde°_logiˇl
 = 0,

330 .
	gcheck_≠icid_u£d
 = 
NULL
,

331 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

333 .
	gve˘‹_Æloˇti⁄_domaö
 = 
physÊ©_ve˘‹_Æloˇti⁄_domaö
,

335 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

337 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

338 .
	g£tup_≠ic_routög
 = 
NULL
,

339 .
	gmu…i_timî_check
 = 
NULL
,

340 .
	g≠icid_to_node
 = 
NULL
,

341 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

342 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

343 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

344 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

345 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

346 .
	gíabÀ_≠ic_mode
 = 
NULL
,

347 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

348 .
	gmps_€m_check
 = 
NULL
,

350 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

351 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

352 .
	g≠ic_id_mask
 = 0xFFu << 24,

354 .
	g˝u_mask_to_≠icid
 = 
physÊ©_˝u_mask_to_≠icid
,

355 .
	g˝u_mask_to_≠icid_™d
 = 
physÊ©_˝u_mask_to_≠icid_™d
,

357 .
	g£nd_IPI_mask
 = 
physÊ©_£nd_IPI_mask
,

358 .
	g£nd_IPI_mask_Ælbut£lf
 = 
physÊ©_£nd_IPI_mask_Ælbut£lf
,

359 .
	g£nd_IPI_Ælbut£lf
 = 
physÊ©_£nd_IPI_Ælbut£lf
,

360 .
	g£nd_IPI_Æl
 = 
physÊ©_£nd_IPI_Æl
,

361 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

363 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

364 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

365 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

366 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

367 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

369 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

370 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

371 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

372 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

373 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

374 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/˘y≥.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/î∫o.h
>

20 
	~<asm/fixm≠.h
>

21 
	~<asm/mp•ec.h
>

22 
	~<asm/≠icdef.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/£tup.h
>

26 
	~<löux/smp.h
>

27 
	~<asm/ùi.h
>

29 
	~<löux/öãºu±.h
>

30 
	~<asm/a˝i.h
>

31 
	~<asm/e820.h
>

33 
	$no›_öô_≠ic_ldr
(Ë{ 
	}
}

34 
	$no›_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

35 
	$no›_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

36 
	$no›_£nd_IPI_Ælbut£lf
(
ve˘‹
Ë{ 
	}
}

37 
	$no›_£nd_IPI_Æl
(
ve˘‹
Ë{ 
	}
}

38 
	$no›_£nd_IPI_£lf
(
ve˘‹
Ë{ 
	}
}

39 
	$no›_≠ic_waô_i¸_idÀ
(Ë{ 
	}
}

40 
	$no›_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
Ë{ 
	}
}

42 
	$no›_wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_eù
)

45 
	}
}

47 
u32
 
	$no›_ß„_≠ic_waô_i¸_idÀ
()

50 
	}
}

52 
u64
 
	$no›_≠ic_i¸_ªad
()

55 
	}
}

57 
	$no›_˝u_to_logiˇl_≠icid
(
˝u
)

60 
	}
}

62 
	$no›_phys_pkg_id
(
˝uid_≠ic
, 
ödex_msb
)

65 
	}
}

67 
	$no›_gë_≠ic_id
(
x
)

70 
	}
}

72 
	$no›_¥obe
()

79 
	}
}

81 
	$no›_≠ic_id_ªgi°îed
()

89  
	`physid_is£t
(0, 
phys_˝u_¥e£¡_m≠
);

90 
	}
}

92 c⁄° 
˝umask
 *
	$no›_èrgë_˝us
()

95  
	`˝umask_of
(0);

96 
	}
}

98 
	$no›_check_≠icid_u£d
(
physid_mask_t
 *
m≠
, 
≠icid
)

100  
	`physid_is£t
(
≠icid
, *
m≠
);

101 
	}
}

103 
	$no›_check_≠icid_¥e£¡
(
bô
)

105  
	`physid_is£t
(
bô
, 
phys_˝u_¥e£¡_m≠
);

106 
	}
}

108 
	$no›_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

110 i‡(
˝u
 != 0)

111 
	`¥_w¨nög
("APIC: Vectorállocated forÇon-BSP cpu\n");

112 
	`˝umask_˛ór
(
ªtmask
);

113 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

114 
	}
}

116 
	$no›_≠icid_to_node
(
logiˇl_≠icid
)

120 
	}
}

122 
u32
 
	$no›_≠ic_ªad
(
u32
 
ªg
)

124 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 && !
dißbÀ_≠ic
));

126 
	}
}

128 
	$no›_≠ic_wrôe
(
u32
 
ªg
, u32 
v
)

130 
	`WARN_ON_ONCE
(
˝u_has_≠ic
 && !
dißbÀ_≠ic
);

131 
	}
}

133 
≠ic
 
	g≠ic_no›
 = {

134 .
«me
 = "noop",

135 .
	g¥obe
 = 
no›_¥obe
,

136 .
	ga˝i_madt_€m_check
 = 
NULL
,

138 .
	g≠ic_id_ªgi°îed
 = 
no›_≠ic_id_ªgi°îed
,

140 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

142 .
	gúq_de°_mode
 = 1,

144 .
	gèrgë_˝us
 = 
no›_èrgë_˝us
,

145 .
	gdißbÀ_e§
 = 0,

146 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

147 .
	gcheck_≠icid_u£d
 = 
no›_check_≠icid_u£d
,

148 .
	gcheck_≠icid_¥e£¡
 = 
no›_check_≠icid_¥e£¡
,

150 .
	gve˘‹_Æloˇti⁄_domaö
 = 
no›_ve˘‹_Æloˇti⁄_domaö
,

151 .
	göô_≠ic_ldr
 = 
no›_öô_≠ic_ldr
,

153 .
	giﬂpic_phys_id_m≠
 = 
deÁu…_iﬂpic_phys_id_m≠
,

154 .
	g£tup_≠ic_routög
 = 
NULL
,

155 .
	gmu…i_timî_check
 = 
NULL
,

156 .
	g≠icid_to_node
 = 
no›_≠icid_to_node
,

158 .
	g˝u_to_logiˇl_≠icid
 = 
no›_˝u_to_logiˇl_≠icid
,

159 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

160 .
	g≠icid_to_˝u_¥e£¡
 = 
physid_£t_mask_of_physid
,

162 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

163 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

164 .
	gíabÀ_≠ic_mode
 = 
NULL
,

166 .
	gphys_pkg_id
 = 
no›_phys_pkg_id
,

168 .
	gmps_€m_check
 = 
NULL
,

170 .
	ggë_≠ic_id
 = 
no›_gë_≠ic_id
,

171 .
	g£t_≠ic_id
 = 
NULL
,

172 .
	g≠ic_id_mask
 = 0x0F << 24,

174 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

175 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

177 .
	g£nd_IPI_mask
 = 
no›_£nd_IPI_mask
,

178 .
	g£nd_IPI_mask_Ælbut£lf
 = 
no›_£nd_IPI_mask_Ælbut£lf
,

179 .
	g£nd_IPI_Ælbut£lf
 = 
no›_£nd_IPI_Ælbut£lf
,

180 .
	g£nd_IPI_Æl
 = 
no›_£nd_IPI_Æl
,

181 .
	g£nd_IPI_£lf
 = 
no›_£nd_IPI_£lf
,

183 .
	gwakeup_£c⁄d¨y_˝u
 = 
no›_wakeup_£c⁄d¨y_˝u
,

186 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

187 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

189 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

191 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

192 .
	göquúe_ªmŸe_≠ic
 = 
NULL
,

194 .
	gªad
 = 
no›_≠ic_ªad
,

195 .
	gwrôe
 = 
no›_≠ic_wrôe
,

196 .
	gi¸_ªad
 = 
no›_≠ic_i¸_ªad
,

197 .
	gi¸_wrôe
 = 
no›_≠ic_i¸_wrôe
,

198 .
	gwaô_i¸_idÀ
 = 
no›_≠ic_waô_i¸_idÀ
,

199 .
	gß„_waô_i¸_idÀ
 = 
no›_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<löux/mm.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/sched.h
>

28 
	~<löux/pci.h
>

29 
	~<löux/mc146818πc.h
>

30 
	~<löux/compûî.h
>

31 
	~<löux/a˝i.h
>

32 
	~<löux/moduÀ.h
>

33 
	~<löux/sysdev.h
>

34 
	~<löux/msi.h
>

35 
	~<löux/htúq.h
>

36 
	~<löux/‰ìzî.h
>

37 
	~<löux/kthªad.h
>

38 
	~<löux/jiffõs.h
>

39 #ifde‡
CONFIG_ACPI


40 
	~<a˝i/a˝i_bus.h
>

42 
	~<löux/boŸmem.h
>

43 
	~<löux/dm¨.h
>

44 
	~<löux/h≥t.h
>

46 
	~<asm/idÀ.h
>

47 
	~<asm/io.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/˝u.h
>

50 
	~<asm/desc.h
>

51 
	~<asm/¥Ÿo.h
>

52 
	~<asm/a˝i.h
>

53 
	~<asm/dma.h
>

54 
	~<asm/timî.h
>

55 
	~<asm/i8259.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/msidef.h
>

58 
	~<asm/hy≥πøn•‹t.h
>

59 
	~<asm/£tup.h
>

60 
	~<asm/úq_ªm≠pög.h
>

61 
	~<asm/h≥t.h
>

62 
	~<asm/hw_úq.h
>

64 
	~<asm/≠ic.h
>

66 
	#__≠icdebugöô
(
ty≥
Ëty≥ 
__öô


	)

67 
	#f‹_óch_úq_pö
(
íåy
, 
hód
) \

68 
íåy
 = 
hód
;É¡ry;É¡ry =É¡ry->
√xt
)

	)

74 
	gsis_≠ic_bug
 = -1;

76 
DEFINE_SPINLOCK
(
iﬂpic_lock
);

77 
DEFINE_SPINLOCK
(
ve˘‹_lock
);

82 
	gƒ_iﬂpic_ªgi°îs
[
MAX_IO_APICS
];

85 
mpc_iﬂpic
 
	gmp_iﬂpics
[
MAX_IO_APICS
];

86 
	gƒ_iﬂpics
;

89 
mp_iﬂpic_gsi
 
	gmp_gsi_routög
[
MAX_IO_APICS
];

92 
mpc_öt§c
 
	gmp_úqs
[
MAX_IRQ_SOURCES
];

95 
	gmp_úq_íåõs
;

98 
ƒ_Àgacy_úqs
 
	g__ªad_mo°ly
 = 
NR_IRQS_LEGACY
;

100 
	gƒ_úqs_gsi
 = 
NR_IRQS_LEGACY
;

102 #i‡
deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

103 
	gmp_bus_id_to_ty≥
[
MAX_MP_BUSSES
];

106 
DECLARE_BITMAP
(
mp_bus_nŸ_pci
, 
MAX_MP_BUSSES
);

108 
	gskù_iﬂpic_£tup
;

110 
	$¨ch_dißbÀ_smp_suµ‹t
()

112 #ifde‡
CONFIG_PCI


113 
noiﬂpicquúk
 = 1;

114 
noiﬂpi¸îouã
 = -1;

116 
skù_iﬂpic_£tup
 = 1;

117 
	}
}

119 
__öô
 
	$∑r£_nﬂpic
(*
°r
)

122 
	`¨ch_dißbÀ_smp_suµ‹t
();

124 
	}
}

125 
óæy_∑øm
("nﬂpic", 
∑r£_nﬂpic
);

127 
	súq_pö_li°
 {

128 
	m≠ic
, 
	mpö
;

129 
úq_pö_li°
 *
	m√xt
;

132 
úq_pö_li°
 *
	$gë_⁄e_‰ì_úq_2_pö
(
node
)

134 
úq_pö_li°
 *
pö
;

136 
pö
 = 
	`kzÆloc_node
((*pö), 
GFP_ATOMIC
, 
node
);

138  
pö
;

139 
	}
}

142 #ifde‡
CONFIG_SPARSE_IRQ


143 
úq_cfg
 
	gúq_cfgx
[] = {

145 
úq_cfg
 
úq_cfgx
[
NR_IRQS
] = {

147 [0] = { .
ve˘‹
 = 
IRQ0_VECTOR
, },

148 [1] = { .
ve˘‹
 = 
IRQ1_VECTOR
, },

149 [2] = { .
ve˘‹
 = 
IRQ2_VECTOR
, },

150 [3] = { .
ve˘‹
 = 
IRQ3_VECTOR
, },

151 [4] = { .
ve˘‹
 = 
IRQ4_VECTOR
, },

152 [5] = { .
ve˘‹
 = 
IRQ5_VECTOR
, },

153 [6] = { .
ve˘‹
 = 
IRQ6_VECTOR
, },

154 [7] = { .
ve˘‹
 = 
IRQ7_VECTOR
, },

155 [8] = { .
ve˘‹
 = 
IRQ8_VECTOR
, },

156 [9] = { .
ve˘‹
 = 
IRQ9_VECTOR
, },

157 [10] = { .
ve˘‹
 = 
IRQ10_VECTOR
, },

158 [11] = { .
ve˘‹
 = 
IRQ11_VECTOR
, },

159 [12] = { .
ve˘‹
 = 
IRQ12_VECTOR
, },

160 [13] = { .
ve˘‹
 = 
IRQ13_VECTOR
, },

161 [14] = { .
ve˘‹
 = 
IRQ14_VECTOR
, },

162 [15] = { .
ve˘‹
 = 
IRQ15_VECTOR
, },

165 
__öô
 
	$io_≠ic_dißbÀ_Àgacy
()

167 
ƒ_Àgacy_úqs
 = 0;

168 
ƒ_úqs_gsi
 = 0;

169 
	}
}

171 
__öô
 
	$¨ch_óæy_úq_öô
()

173 
úq_cfg
 *
cfg
;

174 
úq_desc
 *
desc
;

175 
cou¡
;

176 
node
;

177 
i
;

179 
cfg
 = 
úq_cfgx
;

180 
cou¡
 = 
	`ARRAY_SIZE
(
úq_cfgx
);

181 
node

	`˝u_to_node
(
boŸ_˝u_id
);

183 
i
 = 0; i < 
cou¡
; i++) {

184 
desc
 = 
	`úq_to_desc
(
i
);

185 
desc
->
chù_d©a
 = &
cfg
[
i
];

186 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
domaö
, 
GFP_NOWAIT
, 
node
);

187 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
ﬁd_domaö
, 
GFP_NOWAIT
, 
node
);

188 i‡(
i
 < 
ƒ_Àgacy_úqs
)

189 
	`˝umask_£èŒ
(
cfg
[
i
].
domaö
);

193 
	}
}

195 #ifde‡
CONFIG_SPARSE_IRQ


196 
úq_cfg
 *
	$úq_cfg
(
úq
)

198 
úq_cfg
 *
cfg
 = 
NULL
;

199 
úq_desc
 *
desc
;

201 
desc
 = 
	`úq_to_desc
(
úq
);

202 i‡(
desc
)

203 
cfg
 = 
desc
->
chù_d©a
;

205  
cfg
;

206 
	}
}

208 
úq_cfg
 *
	$gë_⁄e_‰ì_úq_cfg
(
node
)

210 
úq_cfg
 *
cfg
;

212 
cfg
 = 
	`kzÆloc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

213 i‡(
cfg
) {

214 i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
domaö
, 
GFP_ATOMIC
, 
node
)) {

215 
	`k‰ì
(
cfg
);

216 
cfg
 = 
NULL
;

217 } i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
ﬁd_domaö
,

218 
GFP_ATOMIC
, 
node
)) {

219 
	`‰ì_˝umask_v¨
(
cfg
->
domaö
);

220 
	`k‰ì
(
cfg
);

221 
cfg
 = 
NULL
;

225  
cfg
;

226 
	}
}

228 
	$¨ch_öô_chù_d©a
(
úq_desc
 *
desc
, 
node
)

230 
úq_cfg
 *
cfg
;

232 
cfg
 = 
desc
->
chù_d©a
;

233 i‡(!
cfg
) {

234 
desc
->
chù_d©a
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

235 i‡(!
desc
->
chù_d©a
) {

236 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_cfg\n");

237 
	`BUG_ON
(1);

242 
	}
}

246 
	$öô_c›y_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
, 
node
)

248 
úq_pö_li°
 *
ﬁd_íåy
, *
hód
, *
èû
, *
íåy
;

250 
cfg
->
úq_2_pö
 = 
NULL
;

251 
ﬁd_íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

252 i‡(!
ﬁd_íåy
)

255 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

256 i‡(!
íåy
)

259 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

260 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

261 
hód
 = 
íåy
;

262 
èû
 = 
íåy
;

263 
ﬁd_íåy
 = old_íåy->
√xt
;

264 
ﬁd_íåy
) {

265 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

266 i‡(!
íåy
) {

267 
íåy
 = 
hód
;

268 
íåy
) {

269 
hód
 = 
íåy
->
√xt
;

270 
	`k‰ì
(
íåy
);

271 
íåy
 = 
hód
;

276 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

277 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

278 
èû
->
√xt
 = 
íåy
;

279 
èû
 = 
íåy
;

280 
ﬁd_íåy
 = old_íåy->
√xt
;

283 
èû
->
√xt
 = 
NULL
;

284 
cfg
->
úq_2_pö
 = 
hód
;

285 
	}
}

287 
	$‰ì_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
)

289 
úq_pö_li°
 *
íåy
, *
√xt
;

291 i‡(
ﬁd_cfg
->
úq_2_pö
 =
cfg
->irq_2_pin)

294 
íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

296 
íåy
) {

297 
√xt
 = 
íåy
->next;

298 
	`k‰ì
(
íåy
);

299 
íåy
 = 
√xt
;

301 
ﬁd_cfg
->
úq_2_pö
 = 
NULL
;

302 
	}
}

304 
	$¨ch_öô_c›y_chù_d©a
(
úq_desc
 *
ﬁd_desc
,

305 
úq_desc
 *
desc
, 
node
)

307 
úq_cfg
 *
cfg
;

308 
úq_cfg
 *
ﬁd_cfg
;

310 
cfg
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

312 i‡(!
cfg
)

315 
desc
->
chù_d©a
 = 
cfg
;

317 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

319 
	`mem˝y
(
cfg
, 
ﬁd_cfg
, (
úq_cfg
));

321 
	`öô_c›y_úq_2_pö
(
ﬁd_cfg
, 
cfg
, 
node
);

322 
	}
}

324 
	$‰ì_úq_cfg
(
úq_cfg
 *
ﬁd_cfg
)

326 
	`k‰ì
(
ﬁd_cfg
);

327 
	}
}

329 
	$¨ch_‰ì_chù_d©a
(
úq_desc
 *
ﬁd_desc
, úq_des¯*
desc
)

331 
úq_cfg
 *
ﬁd_cfg
, *
cfg
;

333 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

334 
cfg
 = 
desc
->
chù_d©a
;

336 i‡(
ﬁd_cfg
 =
cfg
)

339 i‡(
ﬁd_cfg
) {

340 
	`‰ì_úq_2_pö
(
ﬁd_cfg
, 
cfg
);

341 
	`‰ì_úq_cfg
(
ﬁd_cfg
);

342 
ﬁd_desc
->
chù_d©a
 = 
NULL
;

344 
	}
}

348 
úq_cfg
 *
	$úq_cfg
(
úq
)

350  
úq
 < 
ƒ_úqs
 ? 
úq_cfgx
 + irq : 
NULL
;

351 
	}
}

355 
	sio_≠ic
 {

356 
	mödex
;

357 
	munu£d
[3];

358 
	md©a
;

359 
	munu£d2
[11];

360 
	meoi
;

363 
__©åibuã_c⁄°__
 
io_≠ic
 
__iomem
 *
	$io_≠ic_ba£
(
idx
)

365  (
__iomem
 *Ë
	`__fix_to_vút
(
FIX_IO_APIC_BASE_0
 + 
idx
)

366 + (
mp_iﬂpics
[
idx
].
≠iˇddr
 & ~
PAGE_MASK
);

367 
	}
}

369 
ölöe
 
	$io_≠ic_eoi
(
≠ic
, 
ve˘‹
)

371 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

372 
	`wrôñ
(
ve˘‹
, &
io_≠ic
->
eoi
);

373 
	}
}

375 
ölöe
 
	$io_≠ic_ªad
(
≠ic
, 
ªg
)

377 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

378 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

379  
	`ªadl
(&
io_≠ic
->
d©a
);

380 
	}
}

382 
ölöe
 
	$io_≠ic_wrôe
(
≠ic
, 
ªg
, 
vÆue
)

384 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

385 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

386 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

387 
	}
}

395 
ölöe
 
	$io_≠ic_modify
(
≠ic
, 
ªg
, 
vÆue
)

397 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

399 i‡(
sis_≠ic_bug
)

400 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

401 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

402 
	}
}

404 
boﬁ
 
	$io_≠ic_Àvñ_ack_≥ndög
(
úq_cfg
 *
cfg
)

406 
úq_pö_li°
 *
íåy
;

407 
Êags
;

409 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

410 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

411 
ªg
;

412 
pö
;

414 
pö
 = 
íåy
->pin;

415 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
*2);

417 i‡(
ªg
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

418 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

419  
åue
;

422 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

424  
Ál£
;

425 
	}
}

427 
	uíåy_uni⁄
 {

428 °ru˘ { 
u32
 
	mw1
, 
	mw2
; };

429 
IO_APIC_rouã_íåy
 
	míåy
;

432 
IO_APIC_rouã_íåy
 
	$iﬂpic_ªad_íåy
(
≠ic
, 
pö
)

434 
íåy_uni⁄
 
eu
;

435 
Êags
;

436 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

437 
eu
.
w1
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 2 * 
pö
);

438 
eu
.
w2
 = 
	`io_≠ic_ªad
(
≠ic
, 0x11 + 2 * 
pö
);

439 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

440  
eu
.
íåy
;

441 
	}
}

450 
	$__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

452 
íåy_uni⁄
 
eu
 = {{0, 0}};

454 
eu
.
íåy
 = 
e
;

455 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

456 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

457 
	}
}

459 
	$iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

461 
Êags
;

462 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

463 
	`__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
e
);

464 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

465 
	}
}

472 
	$iﬂpic_mask_íåy
(
≠ic
, 
pö
)

474 
Êags
;

475 
íåy_uni⁄
 
eu
 = { .
íåy
.
mask
 = 1 };

477 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

478 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

479 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

480 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

481 
	}
}

489 
	$add_pö_to_úq_node_n›™ic
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

491 
úq_pö_li°
 **
œ°
, *
íåy
;

494 
œ°
 = &
cfg
->
úq_2_pö
;

495 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

496 i‡(
íåy
->
≠ic
 =≠i¯&&É¡ry->
pö
 ==Öin)

498 
œ°
 = &
íåy
->
√xt
;

501 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

502 i‡(!
íåy
) {

503 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_pin_list (%d,%d,%d)\n",

504 
node
, 
≠ic
, 
pö
);

505  -
ENOMEM
;

507 
íåy
->
≠ic
 =ápic;

508 
íåy
->
pö
 =Öin;

510 *
œ°
 = 
íåy
;

512 
	}
}

514 
	$add_pö_to_úq_node
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

516 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
≠ic
, 
pö
))

517 
	`∑nic
("IO-APIC: failedÅoádd irq-pin. CanÇotÖroceed\n");

518 
	}
}

523 
__öô
 
	$ª∂a˚_pö_©_úq_node
(
úq_cfg
 *
cfg
, 
node
,

524 
ﬁd≠ic
, 
ﬁdpö
,

525 
√w≠ic
, 
√wpö
)

527 
úq_pö_li°
 *
íåy
;

529 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

530 i‡(
íåy
->
≠ic
 =
ﬁd≠ic
 &&É¡ry->
pö
 =
ﬁdpö
) {

531 
íåy
->
≠ic
 = 
√w≠ic
;

532 
íåy
->
pö
 = 
√wpö
;

539 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
√w≠ic
, 
√wpö
);

540 
	}
}

542 
__io_≠ic_modify_úq
(
úq_pö_li°
 *
íåy
,

543 
mask_™d
, 
mask_‹
,

544 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

546 
ªg
, 
pö
;

548 
pö
 = 
íåy
->pin;

549 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2);

550 
ªg
 &
mask_™d
;

551 
ªg
 |
mask_‹
;

552 
	`io_≠ic_modify
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2, 
ªg
);

553 i‡(
föÆ
)

554 
	`föÆ
(
íåy
);

555 
	}
}

557 
io_≠ic_modify_úq
(
úq_cfg
 *
cfg
,

558 
mask_™d
, 
mask_‹
,

559 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

561 
úq_pö_li°
 *
íåy
;

563 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

564 
	`__io_≠ic_modify_úq
(
íåy
, 
mask_™d
, 
mask_‹
, 
föÆ
);

565 
	}
}

567 
	$__mask_™d_edge_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

569 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

570 
IO_APIC_REDIR_MASKED
, 
NULL
);

571 
	}
}

573 
	$__unmask_™d_Àvñ_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

575 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_MASKED
,

576 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

577 
	}
}

579 
	$__unmask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

581 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

582 
	}
}

584 
	$io_≠ic_sync
(
úq_pö_li°
 *
íåy
)

590 
io_≠ic
 
__iomem
 *io_apic;

591 
io_≠ic
 = 
	`io_≠ic_ba£
(
íåy
->
≠ic
);

592 
	`ªadl
(&
io_≠ic
->
d©a
);

593 
	}
}

595 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

597 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_≠ic_sync
);

598 
	}
}

600 
	$mask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

602 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

603 
Êags
;

605 
	`BUG_ON
(!
cfg
);

607 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

608 
	`__mask_IO_APIC_úq
(
cfg
);

609 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

610 
	}
}

612 
	$unmask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

614 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

615 
Êags
;

617 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

618 
	`__unmask_IO_APIC_úq
(
cfg
);

619 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

620 
	}
}

622 
	$mask_IO_APIC_úq
(
úq
)

624 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

626 
	`mask_IO_APIC_úq_desc
(
desc
);

627 
	}
}

628 
	$unmask_IO_APIC_úq
(
úq
)

630 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

632 
	`unmask_IO_APIC_úq_desc
(
desc
);

633 
	}
}

635 
	$˛ór_IO_APIC_pö
(
≠ic
, 
pö
)

637 
IO_APIC_rouã_íåy
 
íåy
;

640 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

641 i‡(
íåy
.
dñivîy_mode
 =
de°_SMI
)

646 
	`iﬂpic_mask_íåy
(
≠ic
, 
pö
);

647 
	}
}

649 
	$˛ór_IO_APIC
 ()

651 
≠ic
, 
pö
;

653 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

654 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

655 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

656 
	}
}

658 #ifde‡
CONFIG_X86_32


664 
	#MAX_PIRQS
 8

	)

665 
	gpúq_íåõs
[
MAX_PIRQS
] = {

666 [0 ... 
MAX_PIRQS
 - 1] = -1

669 
__öô
 
	$iﬂpic_púq_£tup
(*
°r
)

671 
i
, 
max
;

672 
öts
[
MAX_PIRQS
+1];

674 
	`gë_›ti⁄s
(
°r
, 
	`ARRAY_SIZE
(
öts
), ints);

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


678 
max
 = 
MAX_PIRQS
;

679 i‡(
öts
[0] < 
MAX_PIRQS
)

680 
max
 = 
öts
[0];

682 
i
 = 0; i < 
max
; i++) {

683 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


684 "... PIRQ%d -> IRQ %d\n", 
i
, 
öts
[i+1]);

688 
púq_íåõs
[
MAX_PIRQS
-
i
-1] = 
öts
[i+1];

691 
	}
}

693 
__£tup
("púq=", 
iﬂpic_púq_£tup
);

696 
IO_APIC_rouã_íåy
 **
	$Æloc_iﬂpic_íåõs
()

698 
≠ic
;

699 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
;

701 
iﬂpic_íåõs
 = 
	`kzÆloc
((*iﬂpic_íåõsË* 
ƒ_iﬂpics
,

702 
GFP_ATOMIC
);

703 i‡(!
iﬂpic_íåõs
)

706 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

707 
iﬂpic_íåõs
[
≠ic
] =

708 
	`kzÆloc
((
IO_APIC_rouã_íåy
) *

709 
ƒ_iﬂpic_ªgi°îs
[
≠ic
], 
GFP_ATOMIC
);

710 i‡(!
iﬂpic_íåõs
[
≠ic
])

711 
nomem
;

714  
iﬂpic_íåõs
;

716 
nomem
:

717 --
≠ic
 >= 0)

718 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

719 
	`k‰ì
(
iﬂpic_íåõs
);

722 
	}
}

727 
	$ßve_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

729 
≠ic
, 
pö
;

731 i‡(!
iﬂpic_íåõs
)

732  -
ENOMEM
;

734 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

735 i‡(!
iﬂpic_íåõs
[
≠ic
])

736  -
ENOMEM
;

738 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

739 
iﬂpic_íåõs
[
≠ic
][
pö
] =

740 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

744 
	}
}

749 
	$mask_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

751 
≠ic
, 
pö
;

753 i‡(!
iﬂpic_íåõs
)

756 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

757 i‡(!
iﬂpic_íåõs
[
≠ic
])

760 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

761 
IO_APIC_rouã_íåy
 
íåy
;

763 
íåy
 = 
iﬂpic_íåõs
[
≠ic
][
pö
];

764 i‡(!
íåy
.
mask
) {

765 
íåy
.
mask
 = 1;

766 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy
);

770 
	}
}

775 
	$ª°‹e_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

777 
≠ic
, 
pö
;

779 i‡(!
iﬂpic_íåõs
)

780  -
ENOMEM
;

782 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

783 i‡(!
iﬂpic_íåõs
[
≠ic
])

784  -
ENOMEM
;

786 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

787 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
,

788 
iﬂpic_íåõs
[
≠ic
][
pö
]);

791 
	}
}

793 
	$‰ì_iﬂpic_íåõs
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

795 
≠ic
;

797 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

798 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

800 
	`k‰ì
(
iﬂpic_íåõs
);

801 
	}
}

806 
	$föd_úq_íåy
(
≠ic
, 
pö
, 
ty≥
)

808 
i
;

810 
i
 = 0; i < 
mp_úq_íåõs
; i++)

811 i‡(
mp_úqs
[
i
].
úqty≥
 =
ty≥
 &&

812 (
mp_úqs
[
i
].
d°≠ic
 =
mp_iﬂpics
[
≠ic
].
≠icid
 ||

813 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
) &&

814 
mp_úqs
[
i
].
d°úq
 =
pö
)

815  
i
;

818 
	}
}

823 
__öô
 
	$föd_iß_úq_pö
(
úq
, 
ty≥
)

825 
i
;

827 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

828 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

830 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

831 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

832 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

834  
mp_úqs
[
i
].
d°úq
;

837 
	}
}

839 
__öô
 
	$föd_iß_úq_≠ic
(
úq
, 
ty≥
)

841 
i
;

843 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

844 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

846 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

847 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

848 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

851 i‡(
i
 < 
mp_úq_íåõs
) {

852 
≠ic
;

853 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

854 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
)

855  
≠ic
;

860 
	}
}

862 #i‡
deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

866 
	$EISA_ELCR
(
úq
)

868 i‡(
úq
 < 
ƒ_Àgacy_úqs
) {

869 
p‹t
 = 0x4d0 + (
úq
 >> 3);

870  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

872 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


873 "Brokí MPèbÀÑï‹t†ISA irq %d\n", 
úq
);

875 
	}
}

882 
	#deÁu…_ISA_åiggî
(
idx
Ë(0)

	)

883 
	#deÁu…_ISA_pﬁ¨ôy
(
idx
Ë(0)

	)

890 
	#deÁu…_EISA_åiggî
(
idx
Ë(
	`EISA_ELCR
(
mp_úqs
[idx].
§cbusúq
))

	)

891 
	#deÁu…_EISA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

896 
	#deÁu…_PCI_åiggî
(
idx
Ë(1)

	)

897 
	#deÁu…_PCI_pﬁ¨ôy
(
idx
Ë(1)

	)

902 
	#deÁu…_MCA_åiggî
(
idx
Ë(1)

	)

903 
	#deÁu…_MCA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

905 
	$MPBIOS_pﬁ¨ôy
(
idx
)

907 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

908 
pﬁ¨ôy
;

913 
mp_úqs
[
idx
].
úqÊag
 & 3)

916 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

917 
pﬁ¨ôy
 = 
	`deÁu…_ISA_pﬁ¨ôy
(
idx
);

919 
pﬁ¨ôy
 = 
	`deÁu…_PCI_pﬁ¨ôy
(
idx
);

923 
pﬁ¨ôy
 = 0;

928 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

929 
pﬁ¨ôy
 = 1;

934 
pﬁ¨ôy
 = 1;

939 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

940 
pﬁ¨ôy
 = 1;

944  
pﬁ¨ôy
;

945 
	}
}

947 
	$MPBIOS_åiggî
(
idx
)

949 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

950 
åiggî
;

955 (
mp_úqs
[
idx
].
úqÊag
>>2) & 3)

958 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

959 
åiggî
 = 
	`deÁu…_ISA_åiggî
(
idx
);

961 
åiggî
 = 
	`deÁu…_PCI_åiggî
(
idx
);

962 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

963 
mp_bus_id_to_ty≥
[
bus
]) {

964 
MP_BUS_ISA
:

969 
MP_BUS_EISA
:

971 
åiggî
 = 
	`deÁu…_EISA_åiggî
(
idx
);

974 
MP_BUS_PCI
:

979 
MP_BUS_MCA
:

981 
åiggî
 = 
	`deÁu…_MCA_åiggî
(
idx
);

986 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

987 
åiggî
 = 1;

995 
åiggî
 = 0;

1000 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1001 
åiggî
 = 1;

1006 
åiggî
 = 1;

1011 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1012 
åiggî
 = 0;

1016  
åiggî
;

1017 
	}
}

1019 
ölöe
 
	$úq_pﬁ¨ôy
(
idx
)

1021  
	`MPBIOS_pﬁ¨ôy
(
idx
);

1022 
	}
}

1024 
ölöe
 
	$úq_åiggî
(
idx
)

1026  
	`MPBIOS_åiggî
(
idx
);

1027 
	}
}

1029 (*
iﬂpic_ªnumbî_úq
)(
iﬂpic
, 
úq
);

1030 
	$pö_2_úq
(
idx
, 
≠ic
, 
pö
)

1032 
úq
, 
i
;

1033 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

1038 i‡(
mp_úqs
[
idx
].
d°úq
 !
pö
)

1039 
	`¥ötk
(
KERN_ERR
 "broken BIOS or MPTABLEÖarser,áyiee!!\n");

1041 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1042 
úq
 = 
mp_úqs
[
idx
].
§cbusúq
;

1047 
i
 = 
úq
 = 0;

1048 
i
 < 
≠ic
)

1049 
úq
 +
ƒ_iﬂpic_ªgi°îs
[
i
++];

1050 
úq
 +
pö
;

1054 i‡(
iﬂpic_ªnumbî_úq
)

1055 
úq
 = 
	`iﬂpic_ªnumbî_úq
(
≠ic
, irq);

1058 #ifde‡
CONFIG_X86_32


1062 i‡((
pö
 >= 16) && (pin <= 23)) {

1063 i‡(
púq_íåõs
[
pö
-16] != -1) {

1064 i‡(!
púq_íåõs
[
pö
-16]) {

1065 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1066 "dißblög PIRQ%d\n", 
pö
-16);

1068 
úq
 = 
púq_íåõs
[
pö
-16];

1069 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1071 
pö
-16, 
úq
);

1077  
úq
;

1078 
	}
}

1084 
	$IO_APIC_gë_PCI_úq_ve˘‹
(
bus
, 
¶Ÿ
, 
pö
,

1085 
io_≠ic_úq_©å
 *
úq_©å
)

1087 
≠ic
, 
i
, 
be°_guess
 = -1;

1089 
	`≠ic_¥ötk
(
APIC_DEBUG
,

1091 
bus
, 
¶Ÿ
, 
pö
);

1092 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1093 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1094 "PCI BIOSÖas£dÇ⁄exi°íàPCI bu†%d!\n", 
bus
);

1097 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

1098 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

1100 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

1101 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
 ||

1102 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
)

1105 i‡(!
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

1106 !
mp_úqs
[
i
].
úqty≥
 &&

1107 (
bus
 =
lbus
) &&

1108 (
¶Ÿ
 =((
mp_úqs
[
i
].
§cbusúq
 >> 2) & 0x1f))) {

1109 
úq
 = 
	`pö_2_úq
(
i
, 
≠ic
, 
mp_úqs
[i].
d°úq
);

1111 i‡(!(
≠ic
 || 
	`IO_APIC_IRQ
(
úq
)))

1114 i‡(
pö
 =(
mp_úqs
[
i
].
§cbusúq
 & 3)) {

1115 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1116 
mp_úqs
[
i
].
d°úq
,

1117 
	`úq_åiggî
(
i
),

1118 
	`úq_pﬁ¨ôy
(
i
));

1119  
úq
;

1125 i‡(
be°_guess
 < 0) {

1126 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1127 
mp_úqs
[
i
].
d°úq
,

1128 
	`úq_åiggî
(
i
),

1129 
	`úq_pﬁ¨ôy
(
i
));

1130 
be°_guess
 = 
úq
;

1134  
be°_guess
;

1135 
	}
}

1136 
EXPORT_SYMBOL
(
IO_APIC_gë_PCI_úq_ve˘‹
);

1138 
	$lock_ve˘‹_lock
()

1143 
	`•ö_lock
(&
ve˘‹_lock
);

1144 
	}
}

1146 
	$u∆ock_ve˘‹_lock
()

1148 
	`•ö_u∆ock
(&
ve˘‹_lock
);

1149 
	}
}

1152 
	$__assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1165 
cuºít_ve˘‹
 = 
FIRST_DEVICE_VECTOR
, 
cuºít_off£t
 = 0;

1166 
ﬁd_ve˘‹
;

1167 
˝u
, 
îr
;

1168 
˝umask_v¨_t
 
tmp_mask
;

1170 i‡(
cfg
->
move_ö_¥ogªss
)

1171  -
EBUSY
;

1173 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_mask
, 
GFP_ATOMIC
))

1174  -
ENOMEM
;

1176 
ﬁd_ve˘‹
 = 
cfg
->
ve˘‹
;

1177 i‡(
ﬁd_ve˘‹
) {

1178 
	`˝umask_™d
(
tmp_mask
, 
mask
, 
˝u_⁄löe_mask
);

1179 
	`˝umask_™d
(
tmp_mask
, 
cfg
->
domaö
,Åmp_mask);

1180 i‡(!
	`˝umask_em±y
(
tmp_mask
)) {

1181 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1187 
îr
 = -
ENOSPC
;

1188 
	`f‹_óch_˝u_™d
(
˝u
, 
mask
, 
˝u_⁄löe_mask
) {

1189 
√w_˝u
;

1190 
ve˘‹
, 
off£t
;

1192 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
tmp_mask
);

1194 
ve˘‹
 = 
cuºít_ve˘‹
;

1195 
off£t
 = 
cuºít_off£t
;

1196 
√xt
:

1197 
ve˘‹
 += 8;

1198 i‡(
ve˘‹
 >
fú°_sy°em_ve˘‹
) {

1200 
off£t
 = (offset + 1) % 8;

1201 
ve˘‹
 = 
FIRST_DEVICE_VECTOR
 + 
off£t
;

1203 i‡(
	`u∆ikñy
(
cuºít_ve˘‹
 =
ve˘‹
))

1206 i‡(
	`ã°_bô
(
ve˘‹
, 
u£d_ve˘‹s
))

1207 
√xt
;

1209 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1210 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] != -1)

1211 
√xt
;

1213 
cuºít_ve˘‹
 = 
ve˘‹
;

1214 
cuºít_off£t
 = 
off£t
;

1215 i‡(
ﬁd_ve˘‹
) {

1216 
cfg
->
move_ö_¥ogªss
 = 1;

1217 
	`˝umask_c›y
(
cfg
->
ﬁd_domaö
, cfg->
domaö
);

1219 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1220 
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] = 
úq
;

1221 
cfg
->
ve˘‹
 = vector;

1222 
	`˝umask_c›y
(
cfg
->
domaö
, 
tmp_mask
);

1223 
îr
 = 0;

1226 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1227  
îr
;

1228 
	}
}

1230 
	$assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1232 
îr
;

1233 
Êags
;

1235 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

1236 
îr
 = 
	`__assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
);

1237 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

1238  
îr
;

1239 
	}
}

1241 
	$__˛ór_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
)

1243 
˝u
, 
ve˘‹
;

1245 
	`BUG_ON
(!
cfg
->
ve˘‹
);

1247 
ve˘‹
 = 
cfg
->vector;

1248 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
domaö
, 
˝u_⁄löe_mask
)

1249 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1251 
cfg
->
ve˘‹
 = 0;

1252 
	`˝umask_˛ór
(
cfg
->
domaö
);

1254 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

1256 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
) {

1257 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
;

1258 
ve˘‹
++) {

1259 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] !
úq
)

1261 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1265 
cfg
->
move_ö_¥ogªss
 = 0;

1266 
	}
}

1268 
	$__£tup_ve˘‹_úq
(
˝u
)

1272 
úq
, 
ve˘‹
;

1273 
úq_cfg
 *
cfg
;

1274 
úq_desc
 *
desc
;

1277 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1278 
cfg
 = 
desc
->
chù_d©a
;

1279 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1281 
ve˘‹
 = 
cfg
->vector;

1282 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = 
úq
;

1285 
ve˘‹
 = 0; ve˘‹ < 
NR_VECTORS
; ++vector) {

1286 
úq
 = 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
];

1287 i‡(
úq
 < 0)

1290 
cfg
 = 
	`úq_cfg
(
úq
);

1291 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1292 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1294 
	}
}

1296 
úq_chù
 
	giﬂpic_chù
;

1297 
úq_chù
 
	gú_iﬂpic_chù
;

1299 
	#IOAPIC_AUTO
 -1

	)

1300 
	#IOAPIC_EDGE
 0

	)

1301 
	#IOAPIC_LEVEL
 1

	)

1303 #ifde‡
CONFIG_X86_32


1304 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1306 
≠ic
, 
idx
, 
pö
;

1308 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1309 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1310 
idx
 = 
	`föd_úq_íåy
(
≠ic
, 
pö
, 
mp_INT
);

1311 i‡((
idx
 !-1Ë&& (
úq
 =
	`pö_2_úq
(idx, 
≠ic
, 
pö
)))

1312  
	`úq_åiggî
(
idx
);

1319 
	}
}

1321 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1324 
	}
}

1327 
	$iﬂpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
, 
åiggî
)

1330 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1331 
åiggî
 =
IOAPIC_LEVEL
)

1332 
desc
->
°©us
 |
IRQ_LEVEL
;

1334 
desc
->
°©us
 &~
IRQ_LEVEL
;

1336 i‡(
	`úq_ªm≠≥d
(
úq
)) {

1337 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

1338 i‡(
åiggî
)

1339 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1340 
h™dÀ_Á°eoi_úq
,

1343 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1344 
h™dÀ_edge_úq
, "edge");

1348 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1349 
åiggî
 =
IOAPIC_LEVEL
)

1350 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1351 
h™dÀ_Á°eoi_úq
,

1354 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1355 
h™dÀ_edge_úq
, "edge");

1356 
	}
}

1358 
	$£tup_iﬂpic_íåy
(
≠ic_id
, 
úq
,

1359 
IO_APIC_rouã_íåy
 *
íåy
,

1360 
de°ö©i⁄
, 
åiggî
,

1361 
pﬁ¨ôy
, 
ve˘‹
, 
pö
)

1366 
	`mem£t
(
íåy
,0,(*entry));

1368 i‡(
öå_ªm≠pög_íabÀd
) {

1369 
öãl_iommu
 *
iommu
 = 
	`m≠_iﬂpic_to_ú
(
≠ic_id
);

1370 
úã
 irte;

1371 
IR_IO_APIC_rouã_íåy
 *
ú_íåy
 =

1372 (
IR_IO_APIC_rouã_íåy
 *Ë
íåy
;

1373 
ödex
;

1375 i‡(!
iommu
)

1376 
	`∑nic
("Nÿm≠pög iommu f‹ iﬂpi¯%d\n", 
≠ic_id
);

1378 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

1379 i‡(
ödex
 < 0)

1380 
	`∑nic
("FaûedÅÿÆloˇã IRTE f‹ iﬂpi¯%d\n", 
≠ic_id
);

1382 
	`mem£t
(&
úã
, 0, (irte));

1384 
úã
.
¥e£¡
 = 1;

1385 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

1393 
úã
.
åiggî_mode
 = 0;

1394 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1395 
úã
.
ve˘‹
 = vector;

1396 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°ö©i⁄
);

1399 
	`£t_iﬂpic_sid
(&
úã
, 
≠ic_id
);

1401 
	`modify_úã
(
úq
, &
úã
);

1403 
ú_íåy
->
ödex2
 = (
ödex
 >> 15) & 0x1;

1404 
ú_íåy
->
zîo
 = 0;

1405 
ú_íåy
->
f‹m©
 = 1;

1406 
ú_íåy
->
ödex
 = (index & 0x7fff);

1411 
ú_íåy
->
ve˘‹
 = 
pö
;

1413 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1414 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1415 
íåy
->
de°
 = 
de°ö©i⁄
;

1416 
íåy
->
ve˘‹
 = vector;

1419 
íåy
->
mask
 = 0;

1420 
íåy
->
åiggî
 =Årigger;

1421 
íåy
->
pﬁ¨ôy
 =Öolarity;

1426 i‡(
åiggî
)

1427 
íåy
->
mask
 = 1;

1429 
	}
}

1431 
	$£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
úq_desc
 *
desc
,

1432 
åiggî
, 
pﬁ¨ôy
)

1434 
úq_cfg
 *
cfg
;

1435 
IO_APIC_rouã_íåy
 
íåy
;

1436 
de°
;

1438 i‡(!
	`IO_APIC_IRQ
(
úq
))

1441 
cfg
 = 
desc
->
chù_d©a
;

1443 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
()))

1446 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

1448 
	`≠ic_¥ötk
(
APIC_VERBOSE
,
KERN_DEBUG


1451 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
, 
pö
, 
cfg
->
ve˘‹
,

1452 
úq
, 
åiggî
, 
pﬁ¨ôy
);

1455 i‡(
	`£tup_iﬂpic_íåy
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
úq
, &
íåy
,

1456 
de°
, 
åiggî
, 
pﬁ¨ôy
, 
cfg
->
ve˘‹
, 
pö
)) {

1457 
	`¥ötk
("FailedÅo setup ioapicÉntry for ioapic %d,Öin %d\n",

1458 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1459 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

1463 
	`iﬂpic_ªgi°î_öå
(
úq
, 
desc
, 
åiggî
);

1464 i‡(
úq
 < 
ƒ_Àgacy_úqs
)

1465 
	`dißbÀ_8259A_úq
(
úq
);

1467 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1468 
	}
}

1471 
DECLARE_BITMAP
(
pö_¥ogømmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

1472 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

1474 
__öô
 
	$£tup_IO_APIC_úqs
()

1476 
≠ic_id
 = 0, 
pö
, 
idx
, 
úq
;

1477 
nŸc⁄
 = 0;

1478 
úq_desc
 *
desc
;

1479 
úq_cfg
 *
cfg
;

1480 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1482 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1484 #ifde‡
CONFIG_ACPI


1485 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

1486 
≠ic_id
 = 
	`mp_föd_iﬂpic
(0);

1487 i‡(
≠ic_id
 < 0)

1488 
≠ic_id
 = 0;

1492 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic_id
];Öin++) {

1493 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1494 i‡(
idx
 == -1) {

1495 i‡(!
nŸc⁄
) {

1496 
nŸc⁄
 = 1;

1497 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1498 
KERN_DEBUG
 " %d-%d",

1499 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1501 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " %d-%d",

1502 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1505 i‡(
nŸc⁄
) {

1506 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1508 
nŸc⁄
 = 0;

1511 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1517 i‡(
≠ic
->
mu…i_timî_check
 &&

1518 
≠ic
->
	`mu…i_timî_check
(
≠ic_id
, 
úq
))

1521 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1522 i‡(!
desc
) {

1523 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1526 
cfg
 = 
desc
->
chù_d©a
;

1527 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1532 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1533 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1536 i‡(
nŸc⁄
)

1537 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1539 
	}
}

1544 
__öô
 
	$£tup_timî_IRQ0_pö
(
≠ic_id
, 
pö
,

1545 
ve˘‹
)

1547 
IO_APIC_rouã_íåy
 
íåy
;

1549 i‡(
öå_ªm≠pög_íabÀd
)

1552 
	`mem£t
(&
íåy
, 0, (entry));

1558 
íåy
.
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1559 
íåy
.
mask
 = 0;

1560 
íåy
.
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
◊pic->
	`èrgë_˝us
());

1561 
íåy
.
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1562 
íåy
.
pﬁ¨ôy
 = 0;

1563 
íåy
.
åiggî
 = 0;

1564 
íåy
.
ve˘‹
 = vector;

1570 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

1575 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1576 
	}
}

1579 
	$__≠icdebugöô
(Ë
	$¥öt_IO_APIC
()

1581 
≠ic
, 
i
;

1582 
IO_APIC_ªg_00
 
ªg_00
;

1583 
IO_APIC_ªg_01
 
ªg_01
;

1584 
IO_APIC_ªg_02
 
ªg_02
;

1585 
IO_APIC_ªg_03
 
ªg_03
;

1586 
Êags
;

1587 
úq_cfg
 *
cfg
;

1588 
úq_desc
 *
desc
;

1589 
úq
;

1591 
	`¥ötk
(
KERN_DEBUG
 "numbî o‡MP IRQ sour˚s: %d.\n", 
mp_úq_íåõs
);

1592 
i
 = 0; i < 
ƒ_iﬂpics
; i++)

1593 
	`¥ötk
(
KERN_DEBUG
 "number of IO-APIC #%dÑegisters: %d.\n",

1594 
mp_iﬂpics
[
i
].
≠icid
, 
ƒ_iﬂpic_ªgi°îs
[i]);

1600 
	`¥ötk
(
KERN_INFO
 "testingÅhe IO APIC.......................\n");

1602 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1604 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1605 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 0);

1606 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1607 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x10)

1608 
ªg_02
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 2);

1609 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x20)

1610 
ªg_03
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 3);

1611 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1613 
	`¥ötk
("\n");

1614 
	`¥ötk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_iﬂpics
[
≠ic
].
≠icid
);

1615 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #00: %08X\n", 
ªg_00
.
øw
);

1616 
	`¥ötk
(
KERN_DEBUG
 "....... :Öhysiˇ»APIC id: %02X\n", 
ªg_00
.
bôs
.
ID
);

1617 
	`¥ötk
(
KERN_DEBUG
 "....... : Dñivîy Ty≥: %X\n", 
ªg_00
.
bôs
.
dñivîy_ty≥
);

1618 
	`¥ötk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
ªg_00
.
bôs
.
LTS
);

1620 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #01: %08X\n", *(*)&
ªg_01
);

1621 
	`¥ötk
(
KERN_DEBUG
 "....... : maxÑedúe˘i⁄É¡rõs: %04X\n", 
ªg_01
.
bôs
.
íåõs
);

1623 
	`¥ötk
(
KERN_DEBUG
 "....... : PRQ im∂emíãd: %X\n", 
ªg_01
.
bôs
.
PRQ
);

1624 
	`¥ötk
(
KERN_DEBUG
 "....... : IO APIC vîsi⁄: %04X\n", 
ªg_01
.
bôs
.
vîsi⁄
);

1631 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x10 && 
ªg_02
.
øw
 !=Ñeg_01.raw) {

1632 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #02: %08X\n", 
ªg_02
.
øw
);

1633 
	`¥ötk
(
KERN_DEBUG
 "....... :árbôøti⁄: %02X\n", 
ªg_02
.
bôs
.
¨bôøti⁄
);

1641 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x20 && 
ªg_03
.
øw
 !
ªg_02
.raw &&

1642 
ªg_03
.
øw
 !
ªg_01
.raw) {

1643 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #03: %08X\n", 
ªg_03
.
øw
);

1644 
	`¥ötk
(
KERN_DEBUG
 "....... : BoŸ DT : %X\n", 
ªg_03
.
bôs
.
boŸ_DT
);

1647 
	`¥ötk
(
KERN_DEBUG
 ".... IRQÑedirectionÅable:\n");

1649 
	`¥ötk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1652 
i
 = 0; i <
ªg_01
.
bôs
.
íåõs
; i++) {

1653 
IO_APIC_rouã_íåy
 
íåy
;

1655 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
i
);

1657 
	`¥ötk
(
KERN_DEBUG
 " %02x %03X ",

1658 
i
,

1659 
íåy
.
de°


1662 
	`¥ötk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1663 
íåy
.
mask
,

1664 
íåy
.
åiggî
,

1665 
íåy
.
úr
,

1666 
íåy
.
pﬁ¨ôy
,

1667 
íåy
.
dñivîy_°©us
,

1668 
íåy
.
de°_mode
,

1669 
íåy
.
dñivîy_mode
,

1670 
íåy
.
ve˘‹


1674 
	`¥ötk
(
KERN_DEBUG
 "IRQÅoÖin mappings:\n");

1675 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1676 
úq_pö_li°
 *
íåy
;

1678 
cfg
 = 
desc
->
chù_d©a
;

1679 
íåy
 = 
cfg
->
úq_2_pö
;

1680 i‡(!
íåy
)

1682 
	`¥ötk
(
KERN_DEBUG
 "IRQ%d ", 
úq
);

1683 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

1684 
	`¥ötk
("-> %d:%d", 
íåy
->
≠ic
,É¡ry->
pö
);

1685 
	`¥ötk
("\n");

1688 
	`¥ötk
(
KERN_INFO
 ".................................... done.\n");

1691 
	}
}

1693 
	$__≠icdebugöô
(Ë
	$¥öt_APIC_fõld
(
ba£
)

1695 
i
;

1697 
	`¥ötk
(
KERN_DEBUG
);

1699 
i
 = 0; i < 8; i++)

1700 
	`¥ötk
(
KERN_CONT
 "%08x", 
	`≠ic_ªad
(
ba£
 + 
i
*0x10));

1702 
	`¥ötk
(
KERN_CONT
 "\n");

1703 
	}
}

1705 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APIC
(*
dummy
)

1707 
i
, 
v
, 
vî
, 
maxlvt
;

1708 
u64
 
i¸
;

1710 
	`¥ötk
(
KERN_DEBUG
 "printingÜocal APIC contents on CPU#%d/%d:\n",

1711 
	`smp_¥o˚ss‹_id
(), 
	`h¨d_smp_¥o˚ss‹_id
());

1712 
v
 = 
	`≠ic_ªad
(
APIC_ID
);

1713 
	`¥ötk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`ªad_≠ic_id
());

1714 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

1715 
	`¥ötk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1716 
vî
 = 
	`GET_APIC_VERSION
(
v
);

1717 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1719 
v
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1720 
	`¥ötk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1722 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1723 i‡(!
	`APIC_XAPIC
(
vî
)) {

1724 
v
 = 
	`≠ic_ªad
(
APIC_ARBPRI
);

1725 
	`¥ötk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1726 
v
 & 
APIC_ARBPRI_MASK
);

1728 
v
 = 
	`≠ic_ªad
(
APIC_PROCPRI
);

1729 
	`¥ötk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1736 i‡(!
	`APIC_INTEGRATED
(
vî
Ë|| 
maxlvt
 == 3) {

1737 
v
 = 
	`≠ic_ªad
(
APIC_RRR
);

1738 
	`¥ötk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1741 
v
 = 
	`≠ic_ªad
(
APIC_LDR
);

1742 
	`¥ötk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1743 i‡(!
	`x2≠ic_íabÀd
()) {

1744 
v
 = 
	`≠ic_ªad
(
APIC_DFR
);

1745 
	`¥ötk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1747 
v
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1748 
	`¥ötk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1750 
	`¥ötk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1751 
	`¥öt_APIC_fõld
(
APIC_ISR
);

1752 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1753 
	`¥öt_APIC_fõld
(
APIC_TMR
);

1754 
	`¥ötk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1755 
	`¥öt_APIC_fõld
(
APIC_IRR
);

1757 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1758 i‡(
maxlvt
 > 3)

1759 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1761 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1762 
	`¥ötk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1765 
i¸
 = 
	`≠ic_i¸_ªad
();

1766 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
i¸
);

1767 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
i¸
 >> 32));

1769 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1770 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1772 i‡(
maxlvt
 > 3) {

1773 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1774 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1776 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1777 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1778 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1779 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1781 i‡(
maxlvt
 > 2) {

1782 
v
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1783 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1786 
v
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1787 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1788 
v
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

1789 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1790 
v
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1791 
	`¥ötk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1793 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_EXTAPIC
)) {

1794 
v
 = 
	`≠ic_ªad
(
APIC_EFEAT
);

1795 
maxlvt
 = (
v
 >> 16) & 0xff;

1796 
	`¥ötk
(
KERN_DEBUG
 "... APIC EFEAT: %08x\n", 
v
);

1797 
v
 = 
	`≠ic_ªad
(
APIC_ECTRL
);

1798 
	`¥ötk
(
KERN_DEBUG
 "... APIC ECTRL: %08x\n", 
v
);

1799 
i
 = 0; i < 
maxlvt
; i++) {

1800 
v
 = 
	`≠ic_ªad
(
	`APIC_EILVTn
(
i
));

1801 
	`¥ötk
(
KERN_DEBUG
 "... APIC EILVT%d: %08x\n", 
i
, 
v
);

1804 
	`¥ötk
("\n");

1805 
	}
}

1807 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APICs
(
max˝u
)

1809 
˝u
;

1811 i‡(!
max˝u
)

1814 
	`¥ìm±_dißbÀ
();

1815 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1816 i‡(
˝u
 >
max˝u
)

1818 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
¥öt_loˇl_APIC
, 
NULL
, 1);

1820 
	`¥ìm±_íabÀ
();

1821 
	}
}

1823 
	$__≠icdebugöô
(Ë
	$¥öt_PIC
()

1825 
v
;

1826 
Êags
;

1828 i‡(!
ƒ_Àgacy_úqs
)

1831 
	`¥ötk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1833 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

1835 
v
 = 
	`öb
(0xa1) << 8 | inb(0x21);

1836 
	`¥ötk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1838 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1839 
	`¥ötk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1841 
	`outb
(0x0b,0xa0);

1842 
	`outb
(0x0b,0x20);

1843 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1844 
	`outb
(0x0a,0xa0);

1845 
	`outb
(0x0a,0x20);

1847 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

1849 
	`¥ötk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1851 
v
 = 
	`öb
(0x4d1) << 8 | inb(0x4d0);

1852 
	`¥ötk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1853 
	}
}

1855 
__öôd©a
 
	gshow_œpic
 = 1;

1856 
__öô
 
	$£tup_show_œpic
(*
¨g
)

1858 
num
 = -1;

1860 i‡(
	`°rcmp
(
¨g
, "all") == 0) {

1861 
show_œpic
 = 
CONFIG_NR_CPUS
;

1863 
	`gë_›ti⁄
(&
¨g
, &
num
);

1864 i‡(
num
 >= 0)

1865 
show_œpic
 = 
num
;

1869 
	}
}

1870 
__£tup
("show_œpic=", 
£tup_show_œpic
);

1872 
	$__≠icdebugöô
(Ë
	$¥öt_ICs
()

1874 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1877 
	`¥öt_PIC
();

1880 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

1883 
	`¥öt_loˇl_APICs
(
show_œpic
);

1884 
	`¥öt_IO_APIC
();

1887 
	}
}

1889 
fs_öôˇŒ
(
¥öt_ICs
);

1893 °ru˘ { 
	mpö
, 
	m≠ic
; } 
	giﬂpic_i8259
 = { -1, -1 };

1895 
__öô
 
	$íabÀ_IO_APIC
()

1897 
IO_APIC_ªg_01
 
ªg_01
;

1898 
i8259_≠ic
, 
i8259_pö
;

1899 
≠ic
;

1900 
Êags
;

1905 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1906 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1907 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1908 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1909 
ƒ_iﬂpic_ªgi°îs
[
≠ic
] = 
ªg_01
.
bôs
.
íåõs
+1;

1912 i‡(!
ƒ_Àgacy_úqs
)

1915 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1916 
pö
;

1918 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1919 
IO_APIC_rouã_íåy
 
íåy
;

1920 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

1925 i‡((
íåy
.
mask
 =0Ë&& (íåy.
dñivîy_mode
 =
de°_ExtINT
)) {

1926 
iﬂpic_i8259
.
≠ic
 =ápic;

1927 
iﬂpic_i8259
.
pö
 =Öin;

1928 
found_i8259
;

1932 
found_i8259
:

1938 
i8259_pö
 = 
	`föd_iß_úq_pö
(0, 
mp_ExtINT
);

1939 
i8259_≠ic
 = 
	`föd_iß_úq_≠ic
(0, 
mp_ExtINT
);

1941 i‡((
iﬂpic_i8259
.
pö
 =-1Ë&& (
i8259_pö
 >= 0)) {

1942 
	`¥ötk
(
KERN_WARNING
 "ExtINTÇot setup in hardware butÑeported by MPÅable\n");

1943 
iﬂpic_i8259
.
pö
 = 
i8259_pö
;

1944 
iﬂpic_i8259
.
≠ic
 = 
i8259_≠ic
;

1947 i‡(((
iﬂpic_i8259
.
≠ic
 !
i8259_≠ic
Ë|| (iﬂpic_i8259.
pö
 !
i8259_pö
)) &&

1948 (
i8259_pö
 >0Ë&& (
iﬂpic_i8259
.
pö
 >= 0))

1950 
	`¥ötk
(
KERN_WARNING
 "ExtINT in hardwareánd MPÅable differ\n");

1956 
	`˛ór_IO_APIC
();

1957 
	}
}

1962 
	$dißbÀ_IO_APIC
()

1967 
	`˛ór_IO_APIC
();

1969 i‡(!
ƒ_Àgacy_úqs
)

1982 i‡(
iﬂpic_i8259
.
pö
 !-1 && !
öå_ªm≠pög_íabÀd
) {

1983 
IO_APIC_rouã_íåy
 
íåy
;

1985 
	`mem£t
(&
íåy
, 0, (entry));

1986 
íåy
.
mask
 = 0;

1987 
íåy
.
åiggî
 = 0;

1988 
íåy
.
úr
 = 0;

1989 
íåy
.
pﬁ¨ôy
 = 0;

1990 
íåy
.
dñivîy_°©us
 = 0;

1991 
íåy
.
de°_mode
 = 0;

1992 
íåy
.
dñivîy_mode
 = 
de°_ExtINT
;

1993 
íåy
.
ve˘‹
 = 0;

1994 
íåy
.
de°
 = 
	`ªad_≠ic_id
();

1999 
	`iﬂpic_wrôe_íåy
(
iﬂpic_i8259
.
≠ic
, iﬂpic_i8259.
pö
, 
íåy
);

2005 i‡(
˝u_has_≠ic
 || 
	`≠ic_‰om_smp_c⁄fig
())

2006 
	`disc⁄√˘_b•_APIC
(!
öå_ªm≠pög_íabÀd
 &&

2007 
iﬂpic_i8259
.
pö
 != -1);

2008 
	}
}

2010 #ifde‡
CONFIG_X86_32


2018 
__öô
 
	$£tup_iﬂpic_ids_‰om_mpc
()

2020 
IO_APIC_ªg_00
 
ªg_00
;

2021 
physid_mask_t
 
phys_id_¥e£¡_m≠
;

2022 
≠ic_id
;

2023 
i
;

2024 
ﬁd_id
;

2025 
Êags
;

2027 i‡(
a˝i_iﬂpic
)

2033 i‡(!(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
)

2034 || 
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

2040 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
phys_id_¥e£¡_m≠
);

2045 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++) {

2048 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2049 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2050 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2052 
ﬁd_id
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2054 i‡(
mp_iﬂpics
[
≠ic_id
].
≠icid
 >
	`gë_physiˇl_brﬂdˇ°
()) {

2055 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inÅhe MPCÅable!...\n",

2056 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2057 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2058 
ªg_00
.
bôs
.
ID
);

2059 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
ªg_00
.
bôs
.
ID
;

2067 i‡(
≠ic
->
	`check_≠icid_u£d
(&
phys_id_¥e£¡_m≠
,

2068 
mp_iﬂpics
[
≠ic_id
].
≠icid
)) {

2069 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d isálready used!...\n",

2070 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2071 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++)

2072 i‡(!
	`physid_is£t
(
i
, 
phys_id_¥e£¡_m≠
))

2074 i‡(
i
 >
	`gë_physiˇl_brﬂdˇ°
())

2075 
	`∑nic
("Max APIC IDÉxceeded!\n");

2076 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2077 
i
);

2078 
	`physid_£t
(
i
, 
phys_id_¥e£¡_m≠
);

2079 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
i
;

2081 
physid_mask_t
 
tmp
;

2082 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, &
tmp
);

2083 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Setting %d inÅhe "

2085 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2086 
	`physids_‹
(
phys_id_¥e£¡_m≠
,Öhys_id_¥e£¡_m≠, 
tmp
);

2094 i‡(
ﬁd_id
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2095 
i
 = 0; i < 
mp_úq_íåõs
; i++)

2096 i‡(
mp_úqs
[
i
].
d°≠ic
 =
ﬁd_id
)

2097 
mp_úqs
[
i
].
d°≠ic


2098 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2104 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


2106 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2108 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2109 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2110 
	`io_≠ic_wrôe
(
≠ic_id
, 0, 
ªg_00
.
øw
);

2111 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2116 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2117 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2118 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2119 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2120 
	`¥ötk
("couldÇot set ID!\n");

2122 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " ok.\n");

2124 
	}
}

2127 
no_timî_check
 
	g__öôd©a
;

2129 
__öô
 
	$nŸimîcheck
(*
s
)

2131 
no_timî_check
 = 1;

2133 
	}
}

2134 
__£tup
("no_timî_check", 
nŸimîcheck
);

2144 
__öô
 
	$timî_úq_w‹ks
()

2146 
t1
 = 
jiffõs
;

2147 
Êags
;

2149 i‡(
no_timî_check
)

2152 
	`loˇl_ßve_Êags
(
Êags
);

2153 
	`loˇl_úq_íabÀ
();

2155 
	`mdñay
((10 * 1000Ë/ 
HZ
);

2156 
	`loˇl_úq_ª°‹e
(
Êags
);

2167 i‡(
	`time_a·î
(
jiffõs
, 
t1
 + 4))

2170 
	}
}

2195 
	$°¨tup_iﬂpic_úq
(
úq
)

2197 
was_≥ndög
 = 0;

2198 
Êags
;

2199 
úq_cfg
 *
cfg
;

2201 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2202 i‡(
úq
 < 
ƒ_Àgacy_úqs
) {

2203 
	`dißbÀ_8259A_úq
(
úq
);

2204 i‡(
	`i8259A_úq_≥ndög
(
úq
))

2205 
was_≥ndög
 = 1;

2207 
cfg
 = 
	`úq_cfg
(
úq
);

2208 
	`__unmask_IO_APIC_úq
(
cfg
);

2209 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2211  
was_≥ndög
;

2212 
	}
}

2214 
	$iﬂpic_ªåiggî_úq
(
úq
)

2217 
úq_cfg
 *
cfg
 = 
	`úq_cfg
(
úq
);

2218 
Êags
;

2220 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

2221 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
	`˝umask_fú°
(
cfg
->
domaö
)), cfg->
ve˘‹
);

2222 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

2225 
	}
}

2236 #ifde‡
CONFIG_SMP


2237 
	$£nd_˛ónup_ve˘‹
(
úq_cfg
 *
cfg
)

2239 
˝umask_v¨_t
 
˛ónup_mask
;

2241 i‡(
	`u∆ikñy
(!
	`Æloc_˝umask_v¨
(&
˛ónup_mask
, 
GFP_ATOMIC
))) {

2242 
i
;

2243 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2244 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

2246 
	`˝umask_™d
(
˛ónup_mask
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
);

2247 
≠ic
->
	`£nd_IPI_mask
(
˛ónup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

2248 
	`‰ì_˝umask_v¨
(
˛ónup_mask
);

2250 
cfg
->
move_ö_¥ogªss
 = 0;

2251 
	}
}

2253 
	$__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
úq_cfg
 *
cfg
)

2255 
≠ic
, 
pö
;

2256 
úq_pö_li°
 *
íåy
;

2257 
u8
 
ve˘‹
 = 
cfg
->vector;

2259 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2260 
ªg
;

2262 
≠ic
 = 
íåy
->apic;

2263 
pö
 = 
íåy
->pin;

2268 i‡(!
	`úq_ªm≠≥d
(
úq
))

2269 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 
pö
*2, 
de°
);

2270 
ªg
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 
pö
*2);

2271 
ªg
 &~
IO_APIC_REDIR_VECTOR_MASK
;

2272 
ªg
 |
ve˘‹
;

2273 
	`io_≠ic_modify
(
≠ic
, 0x10 + 
pö
*2, 
ªg
);

2275 
	}
}

2283 
	$£t_desc_afföôy
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
,

2284 *
de°_id
)

2286 
úq_cfg
 *
cfg
;

2287 
úq
;

2289 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2292 
úq
 = 
desc
->irq;

2293 
cfg
 = 
desc
->
chù_d©a
;

2294 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2297 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2299 *
de°_id
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
desc
->
afföôy
, 
cfg
->
domaö
);

2301 
	}
}

2304 
	$£t_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2306 
úq_cfg
 *
cfg
;

2307 
Êags
;

2308 
de°
;

2309 
úq
;

2310 
ªt
 = -1;

2312 
úq
 = 
desc
->irq;

2313 
cfg
 = 
desc
->
chù_d©a
;

2315 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2316 
ªt
 = 
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
);

2317 i‡(!
ªt
) {

2319 
de°
 = 
	`SET_APIC_LOGICAL_ID
(dest);

2320 
	`__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
cfg
);

2322 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2324  
ªt
;

2325 
	}
}

2328 
	$£t_iﬂpic_afföôy_úq
(
úq
, c⁄° 
˝umask
 *
mask
)

2330 
úq_desc
 *
desc
;

2332 
desc
 = 
	`úq_to_desc
(
úq
);

2334  
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2335 
	}
}

2337 #ifde‡
CONFIG_INTR_REMAP


2351 
	$migøã_iﬂpic_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2353 
úq_cfg
 *
cfg
;

2354 
úã
 irte;

2355 
de°
;

2356 
úq
;

2357 
ªt
 = -1;

2359 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2360  
ªt
;

2362 
úq
 = 
desc
->irq;

2363 i‡(
	`gë_úã
(
úq
, &
úã
))

2364  
ªt
;

2366 
cfg
 = 
desc
->
chù_d©a
;

2367 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2368  
ªt
;

2370 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
, 
mask
);

2372 
úã
.
ve˘‹
 = 
cfg
->vector;

2373 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

2378 
	`modify_úã
(
úq
, &
úã
);

2380 i‡(
cfg
->
move_ö_¥ogªss
)

2381 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2383 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2386 
	}
}

2391 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2392 c⁄° 
˝umask
 *
mask
)

2394  
	`migøã_iﬂpic_úq_desc
(
desc
, 
mask
);

2395 
	}
}

2396 
	$£t_ú_iﬂpic_afföôy_úq
(
úq
,

2397 c⁄° 
˝umask
 *
mask
)

2399 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2401  
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2402 
	}
}

2404 
ölöe
 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2405 c⁄° 
˝umask
 *
mask
)

2408 
	}
}

2411 
asmlökage
 
	$smp_úq_move_˛ónup_öãºu±
()

2413 
ve˘‹
, 
me
;

2415 
	`ack_APIC_úq
();

2416 
	`exô_idÀ
();

2417 
	`úq_íãr
();

2419 
me
 = 
	`smp_¥o˚ss‹_id
();

2420 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

2421 
úq
;

2422 
úr
;

2423 
úq_desc
 *
desc
;

2424 
úq_cfg
 *
cfg
;

2425 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

2427 i‡(
úq
 == -1)

2430 
desc
 = 
	`úq_to_desc
(
úq
);

2431 i‡(!
desc
)

2434 
cfg
 = 
	`úq_cfg
(
úq
);

2435 
	`øw_•ö_lock
(&
desc
->
lock
);

2441 i‡(
cfg
->
move_ö_¥ogªss
)

2442 
u∆ock
;

2444 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2445 
u∆ock
;

2447 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

2455 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

2456 
≠ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2457 
u∆ock
;

2459 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] = -1;

2460 
u∆ock
:

2461 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

2464 
	`úq_exô
();

2465 
	}
}

2467 
	$__úq_com∂ëe_move
(
úq_desc
 **
des˝
, 
ve˘‹
)

2469 
úq_desc
 *
desc
 = *
des˝
;

2470 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2471 
me
;

2473 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

2476 
me
 = 
	`smp_¥o˚ss‹_id
();

2478 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2479 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2480 
	}
}

2482 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
)

2484 
	`__úq_com∂ëe_move
(
des˝
, ~
	`gë_úq_ªgs
()->
‹ig_ax
);

2485 
	}
}

2487 
	$úq_f‹˚_com∂ëe_move
(
úq
)

2489 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2490 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2492 
	`__úq_com∂ëe_move
(&
desc
, 
cfg
->
ve˘‹
);

2493 
	}
}

2495 
ölöe
 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
Ë{
	}
}

2498 
	$ack_≠ic_edge
(
úq
)

2500 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2502 
	`úq_com∂ëe_move
(&
desc
);

2503 
	`move_«tive_úq
(
úq
);

2504 
	`ack_APIC_úq
();

2505 
	}
}

2507 
©omic_t
 
	gúq_mis_cou¡
;

2525 
	$__eoi_iﬂpic_úq
(
úq
, 
úq_cfg
 *
cfg
)

2527 
úq_pö_li°
 *
íåy
;

2529 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2530 i‡(
mp_iﬂpics
[
íåy
->
≠ic
].
≠icvî
 >= 0x20) {

2537 i‡(
	`úq_ªm≠≥d
(
úq
))

2538 
	`io_≠ic_eoi
(
íåy
->
≠ic
,É¡ry->
pö
);

2540 
	`io_≠ic_eoi
(
íåy
->
≠ic
, 
cfg
->
ve˘‹
);

2542 
	`__mask_™d_edge_IO_APIC_úq
(
íåy
);

2543 
	`__unmask_™d_Àvñ_IO_APIC_úq
(
íåy
);

2546 
	}
}

2548 
	$eoi_iﬂpic_úq
(
úq_desc
 *
desc
)

2550 
úq_cfg
 *
cfg
;

2551 
Êags
;

2552 
úq
;

2554 
úq
 = 
desc
->irq;

2555 
cfg
 = 
desc
->
chù_d©a
;

2557 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2558 
	`__eoi_iﬂpic_úq
(
úq
, 
cfg
);

2559 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2560 
	}
}

2562 
	$ack_≠ic_Àvñ
(
úq
)

2564 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2565 
v
;

2566 
i
;

2567 
úq_cfg
 *
cfg
;

2568 
do_unmask_úq
 = 0;

2570 
	`úq_com∂ëe_move
(&
desc
);

2571 #ifde‡
CONFIG_GENERIC_PENDING_IRQ


2573 i‡(
	`u∆ikñy
(
desc
->
°©us
 & 
IRQ_MOVE_PENDING
)) {

2574 
do_unmask_úq
 = 1;

2575 
	`mask_IO_APIC_úq_desc
(
desc
);

2611 
cfg
 = 
desc
->
chù_d©a
;

2612 
i
 = 
cfg
->
ve˘‹
;

2613 
v
 = 
	`≠ic_ªad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2619 
	`ack_APIC_úq
();

2628 i‡(!(
v
 & (1 << (
i
 & 0x1f)))) {

2629 
	`©omic_öc
(&
úq_mis_cou¡
);

2631 
	`eoi_iﬂpic_úq
(
desc
);

2635 i‡(
	`u∆ikñy
(
do_unmask_úq
)) {

2662 
cfg
 = 
desc
->
chù_d©a
;

2663 i‡(!
	`io_≠ic_Àvñ_ack_≥ndög
(
cfg
))

2664 
	`move_masked_úq
(
úq
);

2665 
	`unmask_IO_APIC_úq_desc
(
desc
);

2667 
	}
}

2669 #ifde‡
CONFIG_INTR_REMAP


2670 
	$ú_ack_≠ic_edge
(
úq
)

2672 
	`ack_APIC_úq
();

2673 
	}
}

2675 
	$ú_ack_≠ic_Àvñ
(
úq
)

2677 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2679 
	`ack_APIC_úq
();

2680 
	`eoi_iﬂpic_úq
(
desc
);

2681 
	}
}

2684 
úq_chù
 
iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2685 .
«me
 = "IO-APIC",

2686 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2687 .
	gmask
 = 
mask_IO_APIC_úq
,

2688 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2689 .
	gack
 = 
ack_≠ic_edge
,

2690 .
	geoi
 = 
ack_≠ic_Àvñ
,

2691 #ifde‡
CONFIG_SMP


2692 .
	g£t_afföôy
 = 
£t_iﬂpic_afföôy_úq
,

2694 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2697 
úq_chù
 
ú_iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2698 .
«me
 = "IR-IO-APIC",

2699 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2700 .
	gmask
 = 
mask_IO_APIC_úq
,

2701 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2702 #ifde‡
CONFIG_INTR_REMAP


2703 .
	gack
 = 
ú_ack_≠ic_edge
,

2704 .
	geoi
 = 
ú_ack_≠ic_Àvñ
,

2705 #ifde‡
CONFIG_SMP


2706 .
	g£t_afföôy
 = 
£t_ú_iﬂpic_afföôy_úq
,

2709 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2712 
ölöe
 
	$öô_IO_APIC_å≠s
()

2714 
úq
;

2715 
úq_desc
 *
desc
;

2716 
úq_cfg
 *
cfg
;

2729 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

2730 
cfg
 = 
desc
->
chù_d©a
;

2731 i‡(
	`IO_APIC_IRQ
(
úq
Ë&& 
cfg
 && !cfg->
ve˘‹
) {

2737 i‡(
úq
 < 
ƒ_Àgacy_úqs
)

2738 
	`make_8259A_úq
(
úq
);

2741 
desc
->
chù
 = &
no_úq_chù
;

2744 
	}
}

2750 
	$mask_œpic_úq
(
úq
)

2752 
v
;

2754 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2755 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2756 
	}
}

2758 
	$unmask_œpic_úq
(
úq
)

2760 
v
;

2762 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2763 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2764 
	}
}

2766 
	$ack_œpic_úq
(
úq
)

2768 
	`ack_APIC_úq
();

2769 
	}
}

2771 
úq_chù
 
œpic_chù
 
	g__ªad_mo°ly
 = {

2772 .
«me
 = "local-APIC",

2773 .
	gmask
 = 
mask_œpic_úq
,

2774 .
	gunmask
 = 
unmask_œpic_úq
,

2775 .
	gack
 = 
ack_œpic_úq
,

2778 
	$œpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
)

2780 
desc
->
°©us
 &~
IRQ_LEVEL
;

2781 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
œpic_chù
, 
h™dÀ_edge_úq
,

2783 
	}
}

2785 
__öô
 
	$£tup_nmi
()

2796 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2798 
	`íabÀ_NMI_through_LVT0
();

2800 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " done.\n");

2801 
	}
}

2810 
ölöe
 
__öô
 
	$u∆ock_ExtINT_logic
()

2812 
≠ic
, 
pö
, 
i
;

2813 
IO_APIC_rouã_íåy
 
íåy0
, 
íåy1
;

2814 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

2816 
pö
 = 
	`föd_iß_úq_pö
(8, 
mp_INT
);

2817 i‡(
pö
 == -1) {

2818 
	`WARN_ON_ONCE
(1);

2821 
≠ic
 = 
	`föd_iß_úq_≠ic
(8, 
mp_INT
);

2822 i‡(
≠ic
 == -1) {

2823 
	`WARN_ON_ONCE
(1);

2827 
íåy0
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

2828 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2830 
	`mem£t
(&
íåy1
, 0, (entry1));

2832 
íåy1
.
de°_mode
 = 0;

2833 
íåy1
.
mask
 = 0;

2834 
íåy1
.
de°
 = 
	`h¨d_smp_¥o˚ss‹_id
();

2835 
íåy1
.
dñivîy_mode
 = 
de°_ExtINT
;

2836 
íåy1
.
pﬁ¨ôy
 = 
íåy0
.polarity;

2837 
íåy1
.
åiggî
 = 0;

2838 
íåy1
.
ve˘‹
 = 0;

2840 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy1
);

2842 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2843 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2844 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
 & ~
RTC_RATE_SELECT
) | 0x6,

2845 
RTC_FREQ_SELECT
);

2846 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2848 
i
 = 100;

2849 
i
-- > 0) {

2850 
	`mdñay
(10);

2851 i‡((
	`CMOS_READ
(
RTC_INTR_FLAGS
Ë& 
RTC_PF
) == RTC_PF)

2852 
i
 -= 10;

2855 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

2856 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

2857 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2859 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy0
);

2860 
	}
}

2862 
dißbÀ_timî_pö_1
 
	g__öôd©a
;

2864 
__öô
 
	$dißbÀ_timî_pö_£tup
(*
¨g
)

2866 
dißbÀ_timî_pö_1
 = 1;

2868 
	}
}

2869 
óæy_∑øm
("dißbÀ_timî_pö_1", 
dißbÀ_timî_pö_£tup
);

2871 
timî_through_8259
 
	g__öôd©a
;

2881 
ölöe
 
__öô
 
	$check_timî
()

2883 
úq_desc
 *
desc
 = 
	`úq_to_desc
(0);

2884 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2885 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

2886 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
;

2887 
Êags
;

2888 
no_pö1
 = 0;

2890 
	`loˇl_úq_ßve
(
Êags
);

2895 
	`dißbÀ_8259A_úq
(0);

2896 
	`assign_úq_ve˘‹
(0, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

2907 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2908 
	`öô_8259A
(1);

2909 #ifde‡
CONFIG_X86_32


2911 
vî
;

2913 
vî
 = 
	`≠ic_ªad
(
APIC_LVR
);

2914 
vî
 = 
	`GET_APIC_VERSION
(ver);

2915 
timî_ack
 = (
nmi_w©chdog
 =
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
vî
));

2919 
pö1
 = 
	`föd_iß_úq_pö
(0, 
mp_INT
);

2920 
≠ic1
 = 
	`föd_iß_úq_≠ic
(0, 
mp_INT
);

2921 
pö2
 = 
iﬂpic_i8259
.
pö
;

2922 
≠ic2
 = 
iﬂpic_i8259
.
≠ic
;

2924 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2926 
cfg
->
ve˘‹
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2935 i‡(
pö1
 == -1) {

2936 i‡(
öå_ªm≠pög_íabÀd
)

2937 
	`∑nic
("BIOS bug:ÅimerÇot connectedÅo IO-APIC");

2938 
pö1
 = 
pö2
;

2939 
≠ic1
 = 
≠ic2
;

2940 
no_pö1
 = 1;

2941 } i‡(
pö2
 == -1) {

2942 
pö2
 = 
pö1
;

2943 
≠ic2
 = 
≠ic1
;

2946 i‡(
pö1
 != -1) {

2950 i‡(
no_pö1
) {

2951 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
);

2952 
	`£tup_timî_IRQ0_pö
(
≠ic1
, 
pö1
, 
cfg
->
ve˘‹
);

2959 
idx
;

2960 
idx
 = 
	`föd_úq_íåy
(
≠ic1
, 
pö1
, 
mp_INT
);

2961 i‡(
idx
 !-1 && 
	`úq_åiggî
(idx))

2962 
	`unmask_IO_APIC_úq_desc
(
desc
);

2964 i‡(
	`timî_úq_w‹ks
()) {

2965 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2966 
	`£tup_nmi
();

2967 
	`íabÀ_8259A_úq
(0);

2969 i‡(
dißbÀ_timî_pö_1
 > 0)

2970 
	`˛ór_IO_APIC_pö
(0, 
pö1
);

2971 
out
;

2973 i‡(
öå_ªm≠pög_íabÀd
)

2974 
	`∑nic
("timer doesn't workÅhrough Interrupt-remapped IO-APIC");

2975 
	`loˇl_úq_dißbÀ
();

2976 
	`˛ór_IO_APIC_pö
(
≠ic1
, 
pö1
);

2977 i‡(!
no_pö1
)

2978 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

2981 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingÅo set upÅimer "

2983 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2984 "..... (foundápi¯%dÖö %dË...\n", 
≠ic2
, 
pö2
);

2988 
	`ª∂a˚_pö_©_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2989 
	`£tup_timî_IRQ0_pö
(
≠ic2
, 
pö2
, 
cfg
->
ve˘‹
);

2990 
	`íabÀ_8259A_úq
(0);

2991 i‡(
	`timî_úq_w‹ks
()) {

2992 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

2993 
timî_through_8259
 = 1;

2994 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2995 
	`dißbÀ_8259A_úq
(0);

2996 
	`£tup_nmi
();

2997 
	`íabÀ_8259A_úq
(0);

2999 
out
;

3004 
	`loˇl_úq_dißbÀ
();

3005 
	`dißbÀ_8259A_úq
(0);

3006 
	`˛ór_IO_APIC_pö
(
≠ic2
, 
pö2
);

3007 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

3010 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3011 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

3013 
nmi_w©chdog
 = 
NMI_NONE
;

3015 #ifde‡
CONFIG_X86_32


3016 
timî_ack
 = 0;

3019 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3022 
	`œpic_ªgi°î_öå
(0, 
desc
);

3023 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3024 
	`íabÀ_8259A_úq
(0);

3026 i‡(
	`timî_úq_w‹ks
()) {

3027 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3028 
out
;

3030 
	`loˇl_úq_dißbÀ
();

3031 
	`dißbÀ_8259A_úq
(0);

3032 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3033 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

3035 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3038 
	`öô_8259A
(0);

3039 
	`make_8259A_úq
(0);

3040 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

3042 
	`u∆ock_ExtINT_logic
();

3044 i‡(
	`timî_úq_w‹ks
()) {

3045 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3046 
out
;

3048 
	`loˇl_úq_dißbÀ
();

3049 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

3050 
	`∑nic
("IO-APIC +Åimer doesn't work! Boot withápic=debugánd sendá "

3052 
out
:

3053 
	`loˇl_úq_ª°‹e
(
Êags
);

3054 
	}
}

3073 
	#PIC_IRQS
 (1UL << 
PIC_CASCADE_IR
)

	)

3075 
__öô
 
	$£tup_IO_APIC
()

3081 
io_≠ic_úqs
 = 
ƒ_Àgacy_úqs
 ? ~
PIC_IRQS
 : ~0UL;

3083 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3087 
x86_öô
.
mµ¨£
.
	`£tup_iﬂpic_ids
();

3089 
	`sync_Arb_IDs
();

3090 
	`£tup_IO_APIC_úqs
();

3091 
	`öô_IO_APIC_å≠s
();

3092 i‡(
ƒ_Àgacy_úqs
)

3093 
	`check_timî
();

3094 
	}
}

3101 
__öô
 
	$io_≠ic_bug_föÆize
()

3103 i‡(
sis_≠ic_bug
 == -1)

3104 
sis_≠ic_bug
 = 0;

3106 
	}
}

3108 
œã_öôˇŒ
(
io_≠ic_bug_föÆize
);

3110 
	ssysfs_iﬂpic_d©a
 {

3111 
sys_devi˚
 
	mdev
;

3112 
IO_APIC_rouã_íåy
 
	míåy
[0];

3114 
sysfs_iﬂpic_d©a
 * 
	gmp_iﬂpic_d©a
[
MAX_IO_APICS
];

3116 
	$iﬂpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

3118 
IO_APIC_rouã_íåy
 *
íåy
;

3119 
sysfs_iﬂpic_d©a
 *
d©a
;

3120 
i
;

3122 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3123 
íåy
 = 
d©a
->entry;

3124 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i ++, 
íåy
 ++ )

3125 *
íåy
 = 
	`iﬂpic_ªad_íåy
(
dev
->
id
, 
i
);

3128 
	}
}

3130 
	$iﬂpic_ªsume
(
sys_devi˚
 *
dev
)

3132 
IO_APIC_rouã_íåy
 *
íåy
;

3133 
sysfs_iﬂpic_d©a
 *
d©a
;

3134 
Êags
;

3135 
IO_APIC_ªg_00
 
ªg_00
;

3136 
i
;

3138 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3139 
íåy
 = 
d©a
->entry;

3141 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3142 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
dev
->
id
, 0);

3143 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
dev
->
id
].
≠icid
) {

3144 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
dev
->
id
].
≠icid
;

3145 
	`io_≠ic_wrôe
(
dev
->
id
, 0, 
ªg_00
.
øw
);

3147 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3148 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i++)

3149 
	`iﬂpic_wrôe_íåy
(
dev
->
id
, 
i
, 
íåy
[i]);

3152 
	}
}

3154 
sysdev_˛ass
 
	giﬂpic_sysdev_˛ass
 = {

3155 .
«me
 = "ioapic",

3156 .
	gsu•íd
 = 
iﬂpic_su•íd
,

3157 .
	gªsume
 = 
iﬂpic_ªsume
,

3160 
__öô
 
	$iﬂpic_öô_sysfs
()

3162 
sys_devi˚
 * 
dev
;

3163 
i
, 
size
, 
îr‹
;

3165 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
iﬂpic_sysdev_˛ass
);

3166 i‡(
îr‹
)

3167  
îr‹
;

3169 
i
 = 0; i < 
ƒ_iﬂpics
; i++ ) {

3170 
size
 = (
sys_devi˚
Ë+ 
ƒ_iﬂpic_ªgi°îs
[
i
]

3171 * (
IO_APIC_rouã_íåy
);

3172 
mp_iﬂpic_d©a
[
i
] = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3173 i‡(!
mp_iﬂpic_d©a
[
i
]) {

3174 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3177 
dev
 = &
mp_iﬂpic_d©a
[
i
]->dev;

3178 
dev
->
id
 = 
i
;

3179 
dev
->
˛s
 = &
iﬂpic_sysdev_˛ass
;

3180 
îr‹
 = 
	`sysdev_ªgi°î
(
dev
);

3181 i‡(
îr‹
) {

3182 
	`k‰ì
(
mp_iﬂpic_d©a
[
i
]);

3183 
mp_iﬂpic_d©a
[
i
] = 
NULL
;

3184 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3190 
	}
}

3192 
devi˚_öôˇŒ
(
iﬂpic_öô_sysfs
);

3197 
	$¸óã_úq_ƒ
(
úq_w™t
, 
node
)

3200 
úq
;

3201 
√w
;

3202 
Êags
;

3203 
úq_cfg
 *
cfg_√w
 = 
NULL
;

3204 
úq_desc
 *
desc_√w
 = 
NULL
;

3206 
úq
 = 0;

3207 i‡(
úq_w™t
 < 
ƒ_úqs_gsi
)

3208 
úq_w™t
 = 
ƒ_úqs_gsi
;

3210 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3211 
√w
 = 
úq_w™t
;Çew < 
ƒ_úqs
;Çew++) {

3212 
desc_√w
 = 
	`úq_to_desc_Æloc_node
(
√w
, 
node
);

3213 i‡(!
desc_√w
) {

3214 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
√w
);

3217 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3219 i‡(
cfg_√w
->
ve˘‹
 != 0)

3222 
desc_√w
 = 
	`move_úq_desc
(desc_√w, 
node
);

3223 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3225 i‡(
	`__assign_úq_ve˘‹
(
√w
, 
cfg_√w
, 
≠ic
->
	`èrgë_˝us
()) == 0)

3226 
úq
 = 
√w
;

3229 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3231 i‡(
úq
 > 0) {

3232 
	`dy«mic_úq_öô
(
úq
);

3234 i‡(
desc_√w
)

3235 
desc_√w
->
chù_d©a
 = 
cfg_√w
;

3237  
úq
;

3238 
	}
}

3240 
	$¸óã_úq
()

3242 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3243 
úq_w™t
;

3244 
úq
;

3246 
úq_w™t
 = 
ƒ_úqs_gsi
;

3247 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3249 i‡(
úq
 == 0)

3250 
úq
 = -1;

3252  
úq
;

3253 
	}
}

3255 
	$de°roy_úq
(
úq
)

3257 
Êags
;

3258 
úq_cfg
 *
cfg
;

3259 
úq_desc
 *
desc
;

3262 
desc
 = 
	`úq_to_desc
(
úq
);

3263 
cfg
 = 
desc
->
chù_d©a
;

3264 
	`dy«mic_úq_˛ónup
(
úq
);

3266 
desc
->
chù_d©a
 = 
cfg
;

3268 
	`‰ì_úã
(
úq
);

3269 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3270 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

3271 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3272 
	}
}

3277 #ifde‡
CONFIG_PCI_MSI


3278 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
úq
,

3279 
msi_msg
 *
msg
, 
u8
 
h≥t_id
)

3281 
úq_cfg
 *
cfg
;

3282 
îr
;

3283 
de°
;

3285 i‡(
dißbÀ_≠ic
)

3286  -
ENXIO
;

3288 
cfg
 = 
	`úq_cfg
(
úq
);

3289 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3290 i‡(
îr
)

3291  
îr
;

3293 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

3295 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3296 
úã
 irte;

3297 
ú_ödex
;

3298 
u16
 
sub_h™dÀ
;

3300 
ú_ödex
 = 
	`m≠_úq_to_úã_h™dÀ
(
úq
, &
sub_h™dÀ
);

3301 
	`BUG_ON
(
ú_ödex
 == -1);

3303 
	`mem£t
 (&
úã
, 0, (irte));

3305 
úã
.
¥e£¡
 = 1;

3306 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

3307 
úã
.
åiggî_mode
 = 0;

3308 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3309 
úã
.
ve˘‹
 = 
cfg
->vector;

3310 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3313 i‡(
pdev
)

3314 
	`£t_msi_sid
(&
úã
, 
pdev
);

3316 
	`£t_h≥t_sid
(&
úã
, 
h≥t_id
);

3318 
	`modify_úã
(
úq
, &
úã
);

3320 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3321 
msg
->
d©a
 = 
sub_h™dÀ
;

3322 
msg
->
addªss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3323 
MSI_ADDR_IR_SHV
 |

3324 
	`MSI_ADDR_IR_INDEX1
(
ú_ödex
) |

3325 
	`MSI_ADDR_IR_INDEX2
(
ú_ödex
);

3327 i‡(
	`x2≠ic_íabÀd
())

3328 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
 |

3329 
	`MSI_ADDR_EXT_DEST_ID
(
de°
);

3331 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3333 
msg
->
addªss_lo
 =

3334 
MSI_ADDR_BASE_LO
 |

3335 ((
≠ic
->
úq_de°_mode
 == 0) ?

3336 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3337 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3338 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3339 
MSI_ADDR_REDIRECTION_CPU
:

3340 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3341 
	`MSI_ADDR_DEST_ID
(
de°
);

3343 
msg
->
d©a
 =

3344 
MSI_DATA_TRIGGER_EDGE
 |

3345 
MSI_DATA_LEVEL_ASSERT
 |

3346 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3347 
MSI_DATA_DELIVERY_FIXED
:

3348 
MSI_DATA_DELIVERY_LOWPRI
) |

3349 
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3351  
îr
;

3352 
	}
}

3354 #ifde‡
CONFIG_SMP


3355 
	$£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3357 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3358 
úq_cfg
 *
cfg
;

3359 
msi_msg
 
msg
;

3360 
de°
;

3362 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3365 
cfg
 = 
desc
->
chù_d©a
;

3367 
	`ªad_msi_msg_desc
(
desc
, &
msg
);

3369 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3370 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3371 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3372 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3374 
	`wrôe_msi_msg_desc
(
desc
, &
msg
);

3377 
	}
}

3378 #ifde‡
CONFIG_INTR_REMAP


3384 
	$ú_£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3386 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3387 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

3388 
de°
;

3389 
úã
 irte;

3391 i‡(
	`gë_úã
(
úq
, &
úã
))

3394 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3397 
úã
.
ve˘‹
 = 
cfg
->vector;

3398 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3403 
	`modify_úã
(
úq
, &
úã
);

3410 i‡(
cfg
->
move_ö_¥ogªss
)

3411 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3414 
	}
}

3423 
úq_chù
 
	gmsi_chù
 = {

3424 .
«me
 = "PCI-MSI",

3425 .
	gunmask
 = 
unmask_msi_úq
,

3426 .
	gmask
 = 
mask_msi_úq
,

3427 .
	gack
 = 
ack_≠ic_edge
,

3428 #ifde‡
CONFIG_SMP


3429 .
	g£t_afföôy
 = 
£t_msi_úq_afföôy
,

3431 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3434 
úq_chù
 
	gmsi_ú_chù
 = {

3435 .
«me
 = "IR-PCI-MSI",

3436 .
	gunmask
 = 
unmask_msi_úq
,

3437 .
	gmask
 = 
mask_msi_úq
,

3438 #ifde‡
CONFIG_INTR_REMAP


3439 .
	gack
 = 
ú_ack_≠ic_edge
,

3440 #ifde‡
CONFIG_SMP


3441 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3444 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3452 
	$msi_Æloc_úã
(
pci_dev
 *
dev
, 
úq
, 
nvec
)

3454 
öãl_iommu
 *
iommu
;

3455 
ödex
;

3457 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3458 i‡(!
iommu
) {

3459 
	`¥ötk
(
KERN_ERR


3460 "U«bÀÅÿm≠ PCI %†tÿiommu\n", 
	`pci_«me
(
dev
));

3461  -
ENOENT
;

3464 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 
nvec
);

3465 i‡(
ödex
 < 0) {

3466 
	`¥ötk
(
KERN_ERR


3467 "U«bÀÅÿÆloˇã %d IRTE f‹ PCI %s\n", 
nvec
,

3468 
	`pci_«me
(
dev
));

3469  -
ENOSPC
;

3471  
ödex
;

3472 
	}
}

3474 
	$£tup_msi_úq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
úq
)

3476 
ªt
;

3477 
msi_msg
 
msg
;

3479 
ªt
 = 
	`msi_compo£_msg
(
dev
, 
úq
, &
msg
, -1);

3480 i‡(
ªt
 < 0)

3481  
ªt
;

3483 
	`£t_úq_msi
(
úq
, 
msidesc
);

3484 
	`wrôe_msi_msg
(
úq
, &
msg
);

3486 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3487 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3491 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3492 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_ú_chù
, 
h™dÀ_edge_úq
, "edge");

3494 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_chù
, 
h™dÀ_edge_úq
, "edge");

3496 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ MSI/MSI-X\n", 
úq
);

3499 
	}
}

3501 
	$¨ch_£tup_msi_úqs
(
pci_dev
 *
dev
, 
nvec
, 
ty≥
)

3503 
úq
;

3504 
ªt
, 
sub_h™dÀ
;

3505 
msi_desc
 *
msidesc
;

3506 
úq_w™t
;

3507 
öãl_iommu
 *
iommu
 = 
NULL
;

3508 
ödex
 = 0;

3509 
node
;

3512 i‡(
ty≥
 =
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3515 
node
 = 
	`dev_to_node
(&
dev
->dev);

3516 
úq_w™t
 = 
ƒ_úqs_gsi
;

3517 
sub_h™dÀ
 = 0;

3518 
	`li°_f‹_óch_íåy
(
msidesc
, &
dev
->
msi_li°
, 
li°
) {

3519 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3520 i‡(
úq
 == 0)

3522 
úq_w™t
 = 
úq
 + 1;

3523 i‡(!
öå_ªm≠pög_íabÀd
)

3524 
no_ú
;

3526 i‡(!
sub_h™dÀ
) {

3531 
ödex
 = 
	`msi_Æloc_úã
(
dev
, 
úq
, 
nvec
);

3532 i‡(
ödex
 < 0) {

3533 
ªt
 = 
ödex
;

3534 
îr‹
;

3537 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3538 i‡(!
iommu
) {

3539 
ªt
 = -
ENOENT
;

3540 
îr‹
;

3547 
	`£t_úã_úq
(
úq
, 
iommu
, 
ödex
, 
sub_h™dÀ
);

3549 
no_ú
:

3550 
ªt
 = 
	`£tup_msi_úq
(
dev
, 
msidesc
, 
úq
);

3551 i‡(
ªt
 < 0)

3552 
îr‹
;

3553 
sub_h™dÀ
++;

3557 
îr‹
:

3558 
	`de°roy_úq
(
úq
);

3559  
ªt
;

3560 
	}
}

3562 
	$¨ch_ã¨down_msi_úq
(
úq
)

3564 
	`de°roy_úq
(
úq
);

3565 
	}
}

3567 #i‡
deföed
 (
CONFIG_DMAR
Ë|| deföed (
CONFIG_INTR_REMAP
)

3568 #ifde‡
CONFIG_SMP


3569 
	$dm¨_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3571 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3572 
úq_cfg
 *
cfg
;

3573 
msi_msg
 
msg
;

3574 
de°
;

3576 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3579 
cfg
 = 
desc
->
chù_d©a
;

3581 
	`dm¨_msi_ªad
(
úq
, &
msg
);

3583 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3584 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3585 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3586 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3588 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3591 
	}
}

3595 
úq_chù
 
	gdm¨_msi_ty≥
 = {

3596 .
«me
 = "DMAR_MSI",

3597 .
	gunmask
 = 
dm¨_msi_unmask
,

3598 .
	gmask
 = 
dm¨_msi_mask
,

3599 .
	gack
 = 
ack_≠ic_edge
,

3600 #ifde‡
CONFIG_SMP


3601 .
	g£t_afföôy
 = 
dm¨_msi_£t_afföôy
,

3603 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3606 
	$¨ch_£tup_dm¨_msi
(
úq
)

3608 
ªt
;

3609 
msi_msg
 
msg
;

3611 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, -1);

3612 i‡(
ªt
 < 0)

3613  
ªt
;

3614 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3615 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
dm¨_msi_ty≥
, 
h™dÀ_edge_úq
,

3618 
	}
}

3621 #ifde‡
CONFIG_HPET_TIMER


3623 #ifde‡
CONFIG_SMP


3624 
	$h≥t_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3626 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3627 
úq_cfg
 *
cfg
;

3628 
msi_msg
 
msg
;

3629 
de°
;

3631 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3634 
cfg
 = 
desc
->
chù_d©a
;

3636 
	`h≥t_msi_ªad
(
úq
, &
msg
);

3638 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3639 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3640 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3641 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3643 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3646 
	}
}

3650 
úq_chù
 
	gú_h≥t_msi_ty≥
 = {

3651 .
«me
 = "IR-HPET_MSI",

3652 .
	gunmask
 = 
h≥t_msi_unmask
,

3653 .
	gmask
 = 
h≥t_msi_mask
,

3654 #ifde‡
CONFIG_INTR_REMAP


3655 .
	gack
 = 
ú_ack_≠ic_edge
,

3656 #ifde‡
CONFIG_SMP


3657 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3660 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3663 
úq_chù
 
	gh≥t_msi_ty≥
 = {

3664 .
«me
 = "HPET_MSI",

3665 .
	gunmask
 = 
h≥t_msi_unmask
,

3666 .
	gmask
 = 
h≥t_msi_mask
,

3667 .
	gack
 = 
ack_≠ic_edge
,

3668 #ifde‡
CONFIG_SMP


3669 .
	g£t_afföôy
 = 
h≥t_msi_£t_afföôy
,

3671 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3674 
	$¨ch_£tup_h≥t_msi
(
úq
, 
id
)

3676 
ªt
;

3677 
msi_msg
 
msg
;

3678 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3680 i‡(
öå_ªm≠pög_íabÀd
) {

3681 
öãl_iommu
 *
iommu
 = 
	`m≠_h≥t_to_ú
(
id
);

3682 
ödex
;

3684 i‡(!
iommu
)

3687 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

3688 i‡(
ödex
 < 0)

3692 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, 
id
);

3693 i‡(
ªt
 < 0)

3694  
ªt
;

3696 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3697 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3698 i‡(
	`úq_ªm≠≥d
(
úq
))

3699 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_h≥t_msi_ty≥
,

3700 
h™dÀ_edge_úq
, "edge");

3702 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
h≥t_msi_ty≥
,

3703 
h™dÀ_edge_úq
, "edge");

3706 
	}
}

3713 #ifde‡
CONFIG_HT_IRQ


3715 #ifde‡
CONFIG_SMP


3717 
	$èrgë_ht_úq
(
úq
, 
de°
, 
u8
 
ve˘‹
)

3719 
ht_úq_msg
 
msg
;

3720 
	`„tch_ht_úq_msg
(
úq
, &
msg
);

3722 
msg
.
addªss_lo
 &~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3723 
msg
.
addªss_hi
 &~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3725 
msg
.
addªss_lo
 |
	`HT_IRQ_LOW_VECTOR
(
ve˘‹
Ë| 
	`HT_IRQ_LOW_DEST_ID
(
de°
);

3726 
msg
.
addªss_hi
 |
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3728 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3729 
	}
}

3731 
	$£t_ht_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3733 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3734 
úq_cfg
 *
cfg
;

3735 
de°
;

3737 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3740 
cfg
 = 
desc
->
chù_d©a
;

3742 
	`èrgë_ht_úq
(
úq
, 
de°
, 
cfg
->
ve˘‹
);

3745 
	}
}

3749 
úq_chù
 
	ght_úq_chù
 = {

3750 .
«me
 = "PCI-HT",

3751 .
	gmask
 = 
mask_ht_úq
,

3752 .
	gunmask
 = 
unmask_ht_úq
,

3753 .
	gack
 = 
ack_≠ic_edge
,

3754 #ifde‡
CONFIG_SMP


3755 .
	g£t_afföôy
 = 
£t_ht_úq_afföôy
,

3757 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3760 
	$¨ch_£tup_ht_úq
(
úq
, 
pci_dev
 *
dev
)

3762 
úq_cfg
 *
cfg
;

3763 
îr
;

3765 i‡(
dißbÀ_≠ic
)

3766  -
ENXIO
;

3768 
cfg
 = 
	`úq_cfg
(
úq
);

3769 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3770 i‡(!
îr
) {

3771 
ht_úq_msg
 
msg
;

3772 
de°
;

3774 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,

3775 
≠ic
->
	`èrgë_˝us
());

3777 
msg
.
addªss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3779 
msg
.
addªss_lo
 =

3780 
HT_IRQ_LOW_BASE
 |

3781 
	`HT_IRQ_LOW_DEST_ID
(
de°
) |

3782 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
ve˘‹
) |

3783 ((
≠ic
->
úq_de°_mode
 == 0) ?

3784 
HT_IRQ_LOW_DM_PHYSICAL
 :

3785 
HT_IRQ_LOW_DM_LOGICAL
) |

3786 
HT_IRQ_LOW_RQEOI_EDGE
 |

3787 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3788 
HT_IRQ_LOW_MT_FIXED
 :

3789 
HT_IRQ_LOW_MT_ARBITRATED
) |

3790 
HT_IRQ_LOW_IRQ_MASKED
;

3792 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3794 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ht_úq_chù
,

3795 
h™dÀ_edge_úq
, "edge");

3797 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ HT\n", 
úq
);

3799  
îr
;

3800 
	}
}

3803 
__öô
 
	$io_≠ic_gë_ªdú_íåõs
 (
iﬂpic
)

3805 
IO_APIC_ªg_01
 
ªg_01
;

3806 
Êags
;

3808 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3809 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

3810 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3812  
ªg_01
.
bôs
.
íåõs
;

3813 
	}
}

3815 
__öô
 
	$¥obe_ƒ_úqs_gsi
()

3817 
ƒ
 = 0;

3819 
ƒ
 = 
	`a˝i_¥obe_gsi
();

3820 i‡(
ƒ
 > 
ƒ_úqs_gsi
) {

3821 
ƒ_úqs_gsi
 = 
ƒ
;

3824 
idx
;

3826 
ƒ
 = 0;

3827 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++)

3828 
ƒ
 +
	`io_≠ic_gë_ªdú_íåõs
(
idx
) + 1;

3830 i‡(
ƒ
 > 
ƒ_úqs_gsi
)

3831 
ƒ_úqs_gsi
 = 
ƒ
;

3834 
	`¥ötk
(
KERN_DEBUG
 "ƒ_úqs_gsi: %d\n", 
ƒ_úqs_gsi
);

3835 
	}
}

3837 #ifde‡
CONFIG_SPARSE_IRQ


3838 
__öô
 
	$¨ch_¥obe_ƒ_úqs
()

3840 
ƒ
;

3842 i‡(
ƒ_úqs
 > (
NR_VECTORS
 * 
ƒ_˝u_ids
))

3843 
ƒ_úqs
 = 
NR_VECTORS
 * 
ƒ_˝u_ids
;

3845 
ƒ
 = 
ƒ_úqs_gsi
 + 8 * 
ƒ_˝u_ids
;

3846 #i‡
	`deföed
(
CONFIG_PCI_MSI
Ë|| deföed(
CONFIG_HT_IRQ
)

3850 
ƒ
 +
ƒ_úqs_gsi
 * 16;

3852 i‡(
ƒ
 < 
ƒ_úqs
)

3853 
ƒ_úqs
 = 
ƒ
;

3856 
	}
}

3859 
	$__io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3860 
io_≠ic_úq_©å
 *
úq_©å
)

3862 
úq_desc
 *
desc
;

3863 
úq_cfg
 *
cfg
;

3864 
node
;

3865 
iﬂpic
, 
pö
;

3866 
åiggî
, 
pﬁ¨ôy
;

3868 
iﬂpic
 = 
úq_©å
->ioapic;

3869 i‡(!
	`IO_APIC_IRQ
(
úq
)) {

3870 
	`≠ic_¥ötk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: InvalidÑeferenceÅo IRQ 0\n",

3871 
iﬂpic
);

3872  -
EINVAL
;

3875 i‡(
dev
)

3876 
node
 = 
	`dev_to_node
(
dev
);

3878 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3880 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

3881 i‡(!
desc
) {

3882 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯%d\n", 
úq
);

3886 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3887 
åiggî
 = 
úq_©å
->trigger;

3888 
pﬁ¨ôy
 = 
úq_©å
->polarity;

3893 i‡(
úq
 >
ƒ_Àgacy_úqs
) {

3894 
cfg
 = 
desc
->
chù_d©a
;

3895 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
iﬂpic
, 
pö
)) {

3896 
	`¥ötk
(
KERN_INFO
 "canÇotáddÖin %d for irq %d\n",

3897 
pö
, 
úq
);

3902 
	`£tup_IO_APIC_úq
(
iﬂpic
, 
pö
, 
úq
, 
desc
, 
åiggî
, 
pﬁ¨ôy
);

3905 
	}
}

3907 
	$io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3908 
io_≠ic_úq_©å
 *
úq_©å
)

3910 
iﬂpic
, 
pö
;

3916 
iﬂpic
 = 
úq_©å
->ioapic;

3917 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3918 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
)) {

3919 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

3920 
mp_iﬂpics
[
iﬂpic
].
≠icid
, 
pö
);

3923 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
);

3925  
	`__io_≠ic_£t_pci_routög
(
dev
, 
úq
, 
úq_©å
);

3926 
	}
}

3928 
u8
 
__öô
 
	$io_≠ic_unique_id
(
u8
 
id
)

3930 #ifde‡
CONFIG_X86_32


3931 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

3932 !
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

3933  
	`io_≠ic_gë_unique_id
(
ƒ_iﬂpics
, 
id
);

3935  
id
;

3937 
i
;

3938 
	`DECLARE_BITMAP
(
u£d
, 256);

3940 
	`bôm≠_zîo
(
u£d
, 256);

3941 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

3942 
mpc_iﬂpic
 *
ü
 = &
mp_iﬂpics
[
i
];

3943 
	`__£t_bô
(
ü
->
≠icid
, 
u£d
);

3945 i‡(!
	`ã°_bô
(
id
, 
u£d
))

3946  
id
;

3947  
	`föd_fú°_zîo_bô
(
u£d
, 256);

3949 
	}
}

3951 #ifde‡
CONFIG_X86_32


3952 
__öô
 
	$io_≠ic_gë_unique_id
(
iﬂpic
, 
≠ic_id
)

3954 
IO_APIC_ªg_00
 
ªg_00
;

3955 
physid_mask_t
 
≠ic_id_m≠
 = 
PHYSID_MASK_NONE
;

3956 
physid_mask_t
 
tmp
;

3957 
Êags
;

3958 
i
 = 0;

3969 i‡(
	`physids_em±y
(
≠ic_id_m≠
))

3970 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
≠ic_id_m≠
);

3972 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3973 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

3974 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3976 i‡(
≠ic_id
 >
	`gë_physiˇl_brﬂdˇ°
()) {

3977 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]: Invalidápic_id %d,Årying "

3978 "%d\n", 
iﬂpic
, 
≠ic_id
, 
ªg_00
.
bôs
.
ID
);

3979 
≠ic_id
 = 
ªg_00
.
bôs
.
ID
;

3986 i‡(
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
≠ic_id
)) {

3988 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++) {

3989 i‡(!
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
i
))

3993 i‡(
i
 =
	`gë_physiˇl_brﬂdˇ°
())

3994 
	`∑nic
("Maxápic_idÉxceeded!\n");

3996 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]:ápic_id %dálready used, "

3997 "åyög %d\n", 
iﬂpic
, 
≠ic_id
, 
i
);

3999 
≠ic_id
 = 
i
;

4002 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
≠ic_id
, &
tmp
);

4003 
	`physids_‹
(
≠ic_id_m≠
,ápic_id_m≠, 
tmp
);

4005 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4006 
ªg_00
.
bôs
.
ID
 = 
≠ic_id
;

4008 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4009 
	`io_≠ic_wrôe
(
iﬂpic
, 0, 
ªg_00
.
øw
);

4010 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4011 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4014 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4015 
	`¥ötk
("IOAPIC[%d]: U«bÀÅÿch™gê≠ic_id!\n", 
iﬂpic
);

4020 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


4021 "IOAPIC[%d]: Assig√dápic_id %d\n", 
iﬂpic
, 
≠ic_id
);

4023  
≠ic_id
;

4024 
	}
}

4027 
__öô
 
	$io_≠ic_gë_vîsi⁄
(
iﬂpic
)

4029 
IO_APIC_ªg_01
 
ªg_01
;

4030 
Êags
;

4032 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4033 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

4034 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4036  
ªg_01
.
bôs
.
vîsi⁄
;

4037 
	}
}

4039 
	$a˝i_gë_ovîride_úq
(
bus_úq
, *
åiggî
, *
pﬁ¨ôy
)

4041 
i
;

4043 i‡(
skù_iﬂpic_£tup
)

4046 
i
 = 0; i < 
mp_úq_íåõs
; i++)

4047 i‡(
mp_úqs
[
i
].
úqty≥
 =
mp_INT
 &&

4048 
mp_úqs
[
i
].
§cbusúq
 =
bus_úq
)

4050 i‡(
i
 >
mp_úq_íåõs
)

4053 *
åiggî
 = 
	`úq_åiggî
(
i
);

4054 *
pﬁ¨ôy
 = 
	`úq_pﬁ¨ôy
(
i
);

4056 
	}
}

4063 #ifde‡
CONFIG_SMP


4064 
__öô
 
	$£tup_iﬂpic_de°
()

4066 
pö
, 
iﬂpic
 = 0, 
úq
, 
úq_íåy
;

4067 
úq_desc
 *
desc
;

4068 c⁄° 
˝umask
 *
mask
;

4070 i‡(
skù_iﬂpic_£tup
 == 1)

4073 #ifde‡
CONFIG_ACPI


4074 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

4075 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

4076 i‡(
iﬂpic
 < 0)

4077 
iﬂpic
 = 0;

4081 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
iﬂpic
];Öin++) {

4082 
úq_íåy
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4083 i‡(
úq_íåy
 == -1)

4085 
úq
 = 
	`pö_2_úq
(
úq_íåy
, 
iﬂpic
, 
pö
);

4087 
desc
 = 
	`úq_to_desc
(
úq
);

4092 i‡(
desc
->
°©us
 &

4093 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4094 
mask
 = 
desc
->
afföôy
;

4096 
mask
 = 
≠ic
->
	`èrgë_˝us
();

4098 i‡(
öå_ªm≠pög_íabÀd
)

4099 
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4101 
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4104 
	}
}

4107 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4109 
ªsour˚
 *
	giﬂpic_ªsour˚s
;

4111 
ªsour˚
 * 
__öô
 
	$iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
)

4113 
n
;

4114 
ªsour˚
 *
ªs
;

4115 *
mem
;

4116 
i
;

4118 i‡(
ƒ_iﬂpics
 <= 0)

4119  
NULL
;

4121 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
ªsour˚
);

4122 
n
 *
ƒ_iﬂpics
;

4124 
mem
 = 
	`Æloc_boŸmem
(
n
);

4125 
ªs
 = (*)
mem
;

4127 
mem
 +(
ªsour˚
Ë* 
ƒ_iﬂpics
;

4129 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4130 
ªs
[
i
].
«me
 = 
mem
;

4131 
ªs
[
i
].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4132 
	`¢¥ötf
(
mem
, 
IOAPIC_RESOURCE_NAME_SIZE
, "IOAPIC %u", 
i
);

4133 
mem
 +
IOAPIC_RESOURCE_NAME_SIZE
;

4136 
iﬂpic_ªsour˚s
 = 
ªs
;

4138  
ªs
;

4139 
	}
}

4141 
__öô
 
	$iﬂpic_öô_m≠pögs
()

4143 
iﬂpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4144 
ªsour˚
 *
iﬂpic_ªs
;

4145 
i
;

4147 
iﬂpic_ªs
 = 
	`iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
);

4148 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4149 i‡(
smp_found_c⁄fig
) {

4150 
iﬂpic_phys
 = 
mp_iﬂpics
[
i
].
≠iˇddr
;

4151 #ifde‡
CONFIG_X86_32


4152 i‡(!
iﬂpic_phys
) {

4153 
	`¥ötk
(
KERN_ERR


4157 
smp_found_c⁄fig
 = 0;

4158 
skù_iﬂpic_£tup
 = 1;

4159 
Áke_iﬂpic_∑ge
;

4163 #ifde‡
CONFIG_X86_32


4164 
Áke_iﬂpic_∑ge
:

4166 
iﬂpic_phys
 = ()
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

4167 
iﬂpic_phys
 = 
	`__∑
(ioapic_phys);

4169 
	`£t_fixm≠_noˇche
(
idx
, 
iﬂpic_phys
);

4170 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped IOAPICÅo %08lx (%08lx)\n",

4171 
	`__fix_to_vút
(
idx
Ë+ (
iﬂpic_phys
 & ~
PAGE_MASK
),

4172 
iﬂpic_phys
);

4173 
idx
++;

4175 
iﬂpic_ªs
->
°¨t
 = 
iﬂpic_phys
;

4176 
iﬂpic_ªs
->
íd
 = 
iﬂpic_phys
 + 
IO_APIC_SLOT_SIZE
 - 1;

4177 
iﬂpic_ªs
++;

4179 
	}
}

4181 
__öô
 
	$iﬂpic_ö£π_ªsour˚s
()

4183 
i
;

4184 
ªsour˚
 *
r
 = 
iﬂpic_ªsour˚s
;

4186 i‡(!
r
) {

4187 i‡(
ƒ_iﬂpics
 > 0)

4188 
	`¥ötk
(
KERN_ERR


4193 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4194 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
r
);

4195 
r
++;

4197 
	}
}

4199 
	$mp_föd_iﬂpic
(
gsi
)

4201 
i
 = 0;

4204 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4205 i‡((
gsi
 >
mp_gsi_routög
[
i
].
gsi_ba£
)

4206 && (
gsi
 <
mp_gsi_routög
[
i
].
gsi_íd
))

4207  
i
;

4210 
	`¥ötk
(
KERN_ERR
 "ERROR: U«bÀÅÿloˇã IOAPIC f‹ GSI %d\n", 
gsi
);

4212 
	}
}

4214 
	$mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
)

4216 i‡(
	`WARN_ON
(
iﬂpic
 == -1))

4218 i‡(
	`WARN_ON
(
gsi
 > 
mp_gsi_routög
[
iﬂpic
].
gsi_íd
))

4221  
gsi
 - 
mp_gsi_routög
[
iﬂpic
].
gsi_ba£
;

4222 
	}
}

4224 
	$bad_iﬂpic
(
addªss
)

4226 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

4227 
	`¥ötk
(
KERN_WARNING
 "WARING: Max # of I/O APICs (%d)Éxceeded "

4228 "(found %d), skùpög\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

4231 i‡(!
addªss
) {

4232 
	`¥ötk
(
KERN_WARNING
 "WARNING: Bogus (zero) I/O APICáddress"

4237 
	}
}

4239 
__öô
 
	$mp_ªgi°î_iﬂpic
(
id
, 
u32
 
addªss
, u32 
gsi_ba£
)

4241 
idx
 = 0;

4243 i‡(
	`bad_iﬂpic
(
addªss
))

4246 
idx
 = 
ƒ_iﬂpics
;

4248 
mp_iﬂpics
[
idx
].
ty≥
 = 
MP_IOAPIC
;

4249 
mp_iﬂpics
[
idx
].
Êags
 = 
MPC_APIC_USABLE
;

4250 
mp_iﬂpics
[
idx
].
≠iˇddr
 = 
addªss
;

4252 
	`£t_fixm≠_noˇche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
addªss
);

4253 
mp_iﬂpics
[
idx
].
≠icid
 = 
	`io_≠ic_unique_id
(
id
);

4254 
mp_iﬂpics
[
idx
].
≠icvî
 = 
	`io_≠ic_gë_vîsi⁄
(idx);

4260 
mp_gsi_routög
[
idx
].
gsi_ba£
 = gsi_base;

4261 
mp_gsi_routög
[
idx
].
gsi_íd
 = 
gsi_ba£
 +

4262 
	`io_≠ic_gë_ªdú_íåõs
(
idx
);

4264 
	`¥ötk
(
KERN_INFO
 "IOAPIC[%d]:ápic_id %d, version %d,áddress 0x%x, "

4265 "GSI %d-%d\n", 
idx
, 
mp_iﬂpics
[idx].
≠icid
,

4266 
mp_iﬂpics
[
idx
].
≠icvî
, mp_iﬂpics[idx].
≠iˇddr
,

4267 
mp_gsi_routög
[
idx
].
gsi_ba£
, mp_gsi_routög[idx].
gsi_íd
);

4269 
ƒ_iﬂpics
++;

4270 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<löux/˝umask.h
>

2 
	~<löux/öãºu±.h
>

3 
	~<löux/öô.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/mc146818πc.h
>

10 
	~<löux/ˇche.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/moduÀ.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mår.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/ùi.h
>

22 
	$deÁu…_£nd_IPI_mask_£quí˚_phys
(c⁄° 
˝umask
 *
mask
, 
ve˘‹
)

24 
quîy_˝u
;

25 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

33 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

34 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

35 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

40 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(c⁄° 
˝umask
 *
mask
,

41 
ve˘‹
)

43 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

44 
quîy_˝u
;

45 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

50 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

51 i‡(
quîy_˝u
 =
this_˝u
)

53 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

54 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
	$deÁu…_£nd_IPI_mask_£quí˚_logiˇl
(c⁄° 
˝umask
 *
mask
,

60 
ve˘‹
)

62 
Êags
;

63 
quîy_˝u
;

71 
	`loˇl_úq_ßve
(
Êags
);

72 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
)

73 
	`__deÁu…_£nd_IPI_de°_fõld
(

74 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

75 
≠ic
->
de°_logiˇl
);

76 
	`loˇl_úq_ª°‹e
(
Êags
);

77 
	}
}

79 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_logiˇl
(c⁄° 
˝umask
 *
mask
,

80 
ve˘‹
)

82 
Êags
;

83 
quîy_˝u
;

84 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

88 
	`loˇl_úq_ßve
(
Êags
);

89 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

90 i‡(
quîy_˝u
 =
this_˝u
)

92 
	`__deÁu…_£nd_IPI_de°_fõld
(

93 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

94 
≠ic
->
de°_logiˇl
);

96 
	`loˇl_úq_ª°‹e
(
Êags
);

97 
	}
}

99 #ifde‡
CONFIG_X86_32


104 
	$deÁu…_£nd_IPI_mask_logiˇl
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

106 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

107 
Êags
;

109 i‡(
	`WARN_ONCE
(!
mask
, "empty IPI mask"))

112 
	`loˇl_úq_ßve
(
Êags
);

113 
	`WARN_ON
(
mask
 & ~
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0]);

114 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

118 
	$deÁu…_£nd_IPI_Ælbut£lf
(
ve˘‹
)

124 i‡(!(
	`num_⁄löe_˝us
() > 1))

127 
	`__deÁu…_loˇl_£nd_IPI_Ælbut£lf
(
ve˘‹
);

128 
	}
}

130 
	$deÁu…_£nd_IPI_Æl
(
ve˘‹
)

132 
	`__deÁu…_loˇl_£nd_IPI_Æl
(
ve˘‹
);

133 
	}
}

135 
	$deÁu…_£nd_IPI_£lf
(
ve˘‹
)

137 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

138 
	}
}

141 
	$c⁄vît_≠icid_to_˝u
(
≠ic_id
)

143 
i
;

145 
	`f‹_óch_possibÀ_˝u
(
i
) {

146 i‡(
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
i
Ë=
≠ic_id
)

147  
i
;

150 
	}
}

152 
	$ß„_smp_¥o˚ss‹_id
()

154 
≠icid
, 
˝uid
;

156 i‡(!
˝u_has_≠ic
)

159 
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

160 i‡(
≠icid
 =
BAD_APICID
)

163 
˝uid
 = 
	`c⁄vît_≠icid_to_˝u
(
≠icid
);

165  
˝uid
 >= 0 ? cpuid : 0;

166 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/≠ic.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/sys˘l.h
>

23 
	~<löux/≥r˝u.h
>

24 
	~<löux/k¥obes.h
>

25 
	~<löux/˝umask.h
>

26 
	~<löux/kî√l_°©.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/smp.h
>

30 
	~<asm/i8259.h
>

31 
	~<asm/io_≠ic.h
>

32 
	~<asm/¥Ÿo.h
>

33 
	~<asm/timî.h
>

35 
	~<asm/m˚.h
>

37 
	~<asm/mach_å≠s.h
>

39 
	gunknown_nmi_∑nic
;

40 
	gnmi_w©chdog_íabÀd
;

43 
	$DECLARE_BITMAP
(
backåa˚_mask
, 
NR_CPUS
Ë
__ªad_mo°ly
;

51 
©omic_t
 
nmi_a˘ive
 = 
	`ATOMIC_INIT
(0);

52 
	`EXPORT_SYMBOL
(
nmi_a˘ive
);

54 
nmi_w©chdog
 = 
NMI_NONE
;

55 
	`EXPORT_SYMBOL
(
nmi_w©chdog
);

57 
∑nic_⁄_timeout
;

59 
nmi_hz
 = 
HZ
;

60 
	`DEFINE_PER_CPU
(, 
wd_íabÀd
);

61 
ídÊag
 
__öôd©a
;

63 
ölöe
 
	$gë_nmi_cou¡
(
˝u
)

65  
	`≥r_˝u
(
úq_°©
, 
˝u
).
__nmi_cou¡
;

66 
	}
}

68 
ölöe
 
	$m˚_ö_¥ogªss
()

70 #i‡
	`deföed
(
CONFIG_X86_MCE
)

71  
	`©omic_ªad
(&
m˚_íåy
) > 0;

74 
	}
}

80 
ölöe
 
	$gë_timî_úqs
(
˝u
)

82  
	`≥r_˝u
(
úq_°©
, 
˝u
).
≠ic_timî_úqs
 +

83 
	`≥r_˝u
(
úq_°©
, 
˝u
).
úq0_úqs
;

84 
	}
}

86 #ifde‡
CONFIG_SMP


92 
__öô
 
	$nmi_˝u_busy
(*
d©a
)

94 
	`loˇl_úq_íabÀ_ö_h¨dúq
();

103 
ídÊag
 == 0)

104 
	`mb
();

105 
	}
}

108 
	$ªp‹t_brokí_nmi
(
˝u
, *
¥ev_nmi_cou¡
)

110 
	`¥ötk
(
KERN_CONT
 "\n");

112 
	`¥ötk
(
KERN_WARNING


114 
˝u
, 
¥ev_nmi_cou¡
[˝u], 
	`gë_nmi_cou¡
(cpu));

116 
	`¥ötk
(
KERN_WARNING


118 
	`¥ötk
(
KERN_WARNING


121 
	`≥r_˝u
(
wd_íabÀd
, 
˝u
) = 0;

122 
	`©omic_dec
(&
nmi_a˘ive
);

123 
	}
}

125 
	$__a˝i_nmi_dißbÀ
(*
__unu£d
)

127 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

128 
	}
}

130 
__öô
 
	$check_nmi_w©chdog
()

132 *
¥ev_nmi_cou¡
;

133 
˝u
;

135 i‡(!
	`nmi_w©chdog_a˘ive
(Ë|| !
	`©omic_ªad
(&
nmi_a˘ive
))

138 
¥ev_nmi_cou¡
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

139 i‡(!
¥ev_nmi_cou¡
)

140 
îr‹
;

142 
	`¥ötk
(
KERN_INFO
 "Testing NMI watchdog ... ");

144 #ifde‡
CONFIG_SMP


145 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

146 
	`smp_ˇŒ_fun˘i⁄
(
nmi_˝u_busy
, (*)&
ídÊag
, 0);

149 
	`f‹_óch_possibÀ_˝u
(
˝u
)

150 
¥ev_nmi_cou¡
[
˝u
] = 
	`gë_nmi_cou¡
(cpu);

151 
	`loˇl_úq_íabÀ
();

152 
	`mdñay
((20 * 1000Ë/ 
nmi_hz
);

154 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

155 i‡(!
	`≥r_˝u
(
wd_íabÀd
, 
˝u
))

157 i‡(
	`gë_nmi_cou¡
(
˝u
Ë- 
¥ev_nmi_cou¡
[cpu] <= 5)

158 
	`ªp‹t_brokí_nmi
(
˝u
, 
¥ev_nmi_cou¡
);

160 
ídÊag
 = 1;

161 i‡(!
	`©omic_ªad
(&
nmi_a˘ive
)) {

162 
	`k‰ì
(
¥ev_nmi_cou¡
);

163 
	`©omic_£t
(&
nmi_a˘ive
, -1);

164 
îr‹
;

166 
	`¥ötk
("OK.\n");

172 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

173 
nmi_hz
 = 
	`œpic_adju°_nmi_hz
(1);

175 
	`k‰ì
(
¥ev_nmi_cou¡
);

177 
îr‹
:

178 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

179 i‡(!
timî_through_8259
)

180 
	`dißbÀ_8259A_úq
(0);

181 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

184 #ifde‡
CONFIG_X86_32


185 
timî_ack
 = 0;

188 
	}
}

190 
__öô
 
	$£tup_nmi_w©chdog
(*
°r
)

192 
nmi
;

194 i‡(!
	`°∫cmp
(
°r
, "panic", 5)) {

195 
∑nic_⁄_timeout
 = 1;

196 
°r
 = 
	`°rchr
(str, ',');

197 i‡(!
°r
)

199 ++
°r
;

202 i‡(!
	`°∫cmp
(
°r
, "lapic", 5))

203 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

204 i‡(!
	`°∫cmp
(
°r
, "ioapic", 6))

205 
nmi_w©chdog
 = 
NMI_IO_APIC
;

207 
	`gë_›ti⁄
(&
°r
, &
nmi
);

208 i‡(
nmi
 >
NMI_INVALID
)

210 
nmi_w©chdog
 = 
nmi
;

214 
	}
}

215 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

220 #ifde‡
CONFIG_PM


222 
	gnmi_pm_a˘ive
;

224 
	$œpic_nmi_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

227 
nmi_pm_a˘ive
 = 
	`©omic_ªad
(&
nmi_a˘ive
);

228 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

229 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

231 
	}
}

233 
	$œpic_nmi_ªsume
(
sys_devi˚
 *
dev
)

236 i‡(
nmi_pm_a˘ive
 > 0) {

237 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

238 
	`touch_nmi_w©chdog
();

241 
	}
}

243 
sysdev_˛ass
 
	gnmi_sys˛ass
 = {

244 .
«me
 = "lapic_nmi",

245 .
	gªsume
 = 
œpic_nmi_ªsume
,

246 .
	gsu•íd
 = 
œpic_nmi_su•íd
,

249 
sys_devi˚
 
	gdevi˚_œpic_nmi
 = {

250 .
id
 = 0,

251 .
	g˛s
 = &
nmi_sys˛ass
,

254 
__öô
 
	$öô_œpic_nmi_sysfs
()

256 
îr‹
;

262 i‡(
nmi_w©chdog
 !
NMI_LOCAL_APIC
)

265 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) < 0)

268 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
nmi_sys˛ass
);

269 i‡(!
îr‹
)

270 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic_nmi
);

271  
îr‹
;

272 
	}
}

275 
œã_öôˇŒ
(
öô_œpic_nmi_sysfs
);

279 
	$__a˝i_nmi_íabÀ
(*
__unu£d
)

281 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
);

282 
	}
}

287 
	$a˝i_nmi_íabÀ
()

289 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

290 
	`⁄_óch_˝u
(
__a˝i_nmi_íabÀ
, 
NULL
, 1);

291 
	}
}

296 
	$a˝i_nmi_dißbÀ
()

298 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

299 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

300 
	}
}

306 
	$˝u_nmi_£t_wd_íabÀd
()

308 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

309 
	}
}

311 
	$£tup_≠ic_nmi_w©chdog
(*
unu£d
)

313 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
))

318 i‡(
	`smp_¥o˚ss‹_id
(Ë!0 && 
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

321 
nmi_w©chdog
) {

322 
NMI_LOCAL_APIC
:

323 i‡(
	`œpic_w©chdog_öô
(
nmi_hz
) < 0) {

324 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

328 
NMI_IO_APIC
:

329 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

330 
	`©omic_öc
(&
nmi_a˘ive
);

332 
	}
}

334 
	$°›_≠ic_nmi_w©chdog
(*
unu£d
)

337 i‡(!
	`nmi_w©chdog_a˘ive
())

339 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
) == 0)

341 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

342 
	`œpic_w©chdog_°›
();

344 
	`__a˝i_nmi_dißbÀ
(
NULL
);

345 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

346 
	`©omic_dec
(&
nmi_a˘ive
);

347 
	}
}

363 
DEFINE_PER_CPU
(, 
œ°_úq_sum
);

364 
DEFINE_PER_CPU
(, 
Æît_cou¡î
);

365 
DEFINE_PER_CPU
(, 
nmi_touch
);

367 
	$touch_nmi_w©chdog
()

369 i‡(
	`nmi_w©chdog_a˘ive
()) {

370 
˝u
;

377 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

378 i‡(
	`≥r_˝u
(
nmi_touch
, 
˝u
) != 1)

379 
	`≥r_˝u
(
nmi_touch
, 
˝u
) = 1;

386 
	`touch_so·lockup_w©chdog
();

387 
	}
}

388 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

390 
nŸø˚
 
__k¥obes
 

391 
	$nmi_w©chdog_tick
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

398 
sum
;

399 
touched
 = 0;

400 
˝u
 = 
	`smp_¥o˚ss‹_id
();

401 
rc
 = 0;

404 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

405 =
NOTIFY_STOP
) {

406 
rc
 = 1;

407 
touched
 = 1;

410 
sum
 = 
	`gë_timî_úqs
(
˝u
);

412 i‡(
	`__gë_˝u_v¨
(
nmi_touch
)) {

413 
	`__gë_˝u_v¨
(
nmi_touch
) = 0;

414 
touched
 = 1;

418 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
))) {

419 
	`DEFINE_SPINLOCK
(
lock
);

421 
	`•ö_lock
(&
lock
);

422 
	`¥ötk
(
KERN_WARNING
 "NMI backåa˚ f‹ cpu %d\n", 
˝u
);

423 
	`show_ªgs
(
ªgs
);

424 
	`dump_°ack
();

425 
	`•ö_u∆ock
(&
lock
);

426 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
));

428 
rc
 = 1;

432 i‡(
	`m˚_ö_¥ogªss
())

433 
touched
 = 1;

436 i‡(!
touched
 && 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë=
sum
) {

441 
	`__this_˝u_öc
(
	`≥r_˝u_v¨
(
Æît_cou¡î
));

442 i‡(
	`__this_˝u_ªad
(
	`≥r_˝u_v¨
(
Æît_cou¡î
)Ë=5 * 
nmi_hz
)

446 
	`dõ_nmi
("BUG: NMI Watchdog detected LOCKUP",

447 
ªgs
, 
∑nic_⁄_timeout
);

449 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë
sum
;

450 
	`__this_˝u_wrôe
(
	`≥r_˝u_v¨
(
Æît_cou¡î
), 0);

454 i‡(!
	`__gë_˝u_v¨
(
wd_íabÀd
))

455  
rc
;

456 
nmi_w©chdog
) {

457 
NMI_LOCAL_APIC
:

458 
rc
 |
	`œpic_wd_evít
(
nmi_hz
);

460 
NMI_IO_APIC
:

466 
rc
 = 1;

469  
rc
;

470 
	}
}

472 #ifde‡
CONFIG_SYSCTL


474 
	$íabÀ_iﬂpic_nmi_w©chdog_sögÀ
(*
unu£d
)

476 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

477 
	`©omic_öc
(&
nmi_a˘ive
);

478 
	`__a˝i_nmi_íabÀ
(
NULL
);

479 
	}
}

481 
	$íabÀ_iﬂpic_nmi_w©chdog
()

483 
	`⁄_óch_˝u
(
íabÀ_iﬂpic_nmi_w©chdog_sögÀ
, 
NULL
, 1);

484 
	`touch_nmi_w©chdog
();

485 
	}
}

487 
	$dißbÀ_iﬂpic_nmi_w©chdog
()

489 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

490 
	}
}

492 
__öô
 
	$£tup_unknown_nmi_∑nic
(*
°r
)

494 
unknown_nmi_∑nic
 = 1;

496 
	}
}

497 
__£tup
("unknown_nmi_∑nic", 
£tup_unknown_nmi_∑nic
);

499 
	$unknown_nmi_∑nic_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

501 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

502 
buf
[64];

504 
	`•rötf
(
buf
, "NMIÑe˚ived f‹ unknow¿ªas⁄ %02x\n", 
ªas⁄
);

505 
	`dõ_nmi
(
buf
, 
ªgs
, 1);

507 
	}
}

512 
	$¥oc_nmi_íabÀd
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

513 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

515 
ﬁd_°©e
;

517 
nmi_w©chdog_íabÀd
 = (
	`©omic_ªad
(&
nmi_a˘ive
) > 0) ? 1 : 0;

518 
ﬁd_°©e
 = 
nmi_w©chdog_íabÀd
;

519 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
buf„r
, 
Àngth
, 
µos
);

520 i‡(!!
ﬁd_°©e
 =!!
nmi_w©chdog_íabÀd
)

523 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë< 0 || !
	`nmi_w©chdog_a˘ive
()) {

524 
	`¥ötk
(
KERN_WARNING


526  -
EIO
;

529 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
) {

530 i‡(
nmi_w©chdog_íabÀd
)

531 
	`íabÀ_œpic_nmi_w©chdog
();

533 
	`dißbÀ_œpic_nmi_w©chdog
();

534 } i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

535 i‡(
nmi_w©chdog_íabÀd
)

536 
	`íabÀ_iﬂpic_nmi_w©chdog
();

538 
	`dißbÀ_iﬂpic_nmi_w©chdog
();

540 
	`¥ötk
(
KERN_WARNING


542  -
EIO
;

545 
	}
}

549 
	$do_nmi_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

551 #ifde‡
CONFIG_SYSCTL


552 i‡(
unknown_nmi_∑nic
)

553  
	`unknown_nmi_∑nic_ˇŒback
(
ªgs
, 
˝u
);

556 
	}
}

558 
	$¨ch_åiggî_Æl_˝u_backåa˚
()

560 
i
;

562 
	`˝umask_c›y
(
	`to_˝umask
(
backåa˚_mask
), 
˝u_⁄löe_mask
);

564 
	`¥ötk
(
KERN_INFO
 "sending NMIÅoáll CPUs:\n");

565 
≠ic
->
	`£nd_IPI_Æl
(
NMI_VECTOR
);

568 
i
 = 0; i < 10 * 1000; i++) {

569 i‡(
	`˝umask_em±y
(
	`to_˝umask
(
backåa˚_mask
)))

571 
	`mdñay
(1);

573 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<löux/thªads.h
>

12 
	~<löux/˝umask.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/dm¨.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/ùi.h
>

24 
	~<asm/£tup.h
>

26 
≠ic
 
≠ic_Ê©
;

27 
≠ic
 
≠ic_physÊ©
;

28 
≠ic
 
≠ic_x2xpic_uv_x
;

29 
≠ic
 
≠ic_x2≠ic_phys
;

30 
≠ic
 
≠ic_x2≠ic_˛u°î
;

32 
≠ic
 
__ªad_mo°ly
 *
	g≠ic
 = &
≠ic_Ê©
;

33 
EXPORT_SYMBOL_GPL
(
≠ic
);

35 
≠ic
 *
	g≠ic_¥obe
[] 
	g__öôd©a
 = {

36 #ifde‡
CONFIG_X86_UV


37 &
≠ic_x2≠ic_uv_x
,

39 #ifde‡
CONFIG_X86_X2APIC


40 &
≠ic_x2≠ic_phys
,

41 &
≠ic_x2≠ic_˛u°î
,

43 &
≠ic_physÊ©
,

44 
NULL
,

47 
	$≠icid_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

49  
	`h¨d_smp_¥o˚ss‹_id
(Ë>> 
ödex_msb
;

50 
	}
}

55 
__öô
 
	$deÁu…_£tup_≠ic_routög
()

57 #ifde‡
CONFIG_X86_X2APIC


58 i‡(
x2≠ic_mode


59 #ifde‡
CONFIG_X86_UV


60 && 
≠ic
 !&
≠ic_x2≠ic_uv_x


63 i‡(
x2≠ic_phys
)

64 
≠ic
 = &
≠ic_x2≠ic_phys
;

66 
≠ic
 = &
≠ic_x2≠ic_˛u°î
;

70 i‡(
≠ic
 =&
≠ic_Ê©
 && 
	`num_possibÀ_˝us
() > 8)

71 
≠ic
 = &
≠ic_physÊ©
;

73 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

75 i‡(
	`is_vsmp_box
()) {

77 
≠ic
->
phys_pkg_id
 = 
≠icid_phys_pkg_id
;

84 i‡(
öå_ªm≠pög_íabÀd
)

85 
	`íabÀ_drhd_Áu…_h™dlög
();

86 
	}
}

90 
	$≠ic_£nd_IPI_£lf
(
ve˘‹
)

92 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

93 
	}
}

95 
__öô
 
	$deÁu…_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

97 
i
;

99 
i
 = 0; 
≠ic_¥obe
[i]; ++i) {

100 i‡(
≠ic_¥obe
[
i
]->
	`a˝i_madt_€m_check
(
€m_id
, 
€m_èbÀ_id
)) {

101 
≠ic
 = 
≠ic_¥obe
[
i
];

102 
	`¥ötk
(
KERN_INFO
 "Setting APICÑoutingÅo %s.\n",

103 
≠ic
->
«me
);

108 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<löux/öô.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/audô.h
>

4 
	~<asm/uni°d.h
>

6 
	gdú_˛ass
[] = {

7 
	~<asm-gíîic/audô_dú_wrôe.h
>

11 
	gªad_˛ass
[] = {

12 
	~<asm-gíîic/audô_ªad.h
>

16 
	gwrôe_˛ass
[] = {

17 
	~<asm-gíîic/audô_wrôe.h
>

21 
	gch©å_˛ass
[] = {

22 
	~<asm-gíîic/audô_ch™ge_©å.h
>

26 
	gsig«l_˛ass
[] = {

27 
	~<asm-gíîic/audô_sig«l.h
>

31 
	$audô_˛assify_¨ch
(
¨ch
)

33 #ifde‡
CONFIG_IA32_EMULATION


34 i‡(
¨ch
 =
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$audô_˛assify_sysˇŒ
(
abi
, 
sysˇŒ
)

42 #ifde‡
CONFIG_IA32_EMULATION


43 
	`ü32_˛assify_sysˇŒ
();

44 i‡(
abi
 =
AUDIT_ARCH_I386
)

45  
	`ü32_˛assify_sysˇŒ
(
sysˇŒ
);

47 
sysˇŒ
) {

48 
__NR_›í
:

50 
__NR_›í©
:

52 
__NR_execve
:

57 
	}
}

59 
__öô
 
	$audô_˛as£s_öô
()

61 #ifde‡
CONFIG_IA32_EMULATION


62 
__u32
 
ü32_dú_˛ass
[];

63 
__u32
 
ü32_wrôe_˛ass
[];

64 
__u32
 
ü32_ªad_˛ass
[];

65 
__u32
 
ü32_ch©å_˛ass
[];

66 
__u32
 
ü32_sig«l_˛ass
[];

67 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE_32
, 
ü32_wrôe_˛ass
);

68 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ_32
, 
ü32_ªad_˛ass
);

69 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE_32
, 
ü32_dú_˛ass
);

70 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR_32
, 
ü32_ch©å_˛ass
);

71 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL_32
, 
ü32_sig«l_˛ass
);

73 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE
, 
wrôe_˛ass
);

74 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ
, 
ªad_˛ass
);

75 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE
, 
dú_˛ass
);

76 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR
, 
ch©å_˛ass
);

77 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL
, 
sig«l_˛ass
);

79 
	}
}

81 
__öôˇŒ
(
audô_˛as£s_öô
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<löux/ty≥s.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/•ölock.h
>

10 
	~<löux/a˝i.h
>

11 
	~<asm/io.h
>

13 
	~<löux/mc146818πc.h
>

15 
	#SBF_RESERVED
 (0x78)

	)

16 
	#SBF_PNPOS
 (1<<0)

	)

17 
	#SBF_BOOTING
 (1<<1)

	)

18 
	#SBF_DIAG
 (1<<2)

	)

19 
	#SBF_PARITY
 (1<<7)

	)

21 
sbf_p‹t
 
	g__öôd©a
 = -1;

23 
__öô
 
	$∑rôy
(
u8
 
v
)

25 
x
 = 0;

26 
i
;

28 
i
 = 0; i < 8; i++) {

29 
x
 ^(
v
 & 1);

30 
v
 >>= 1;

33  
x
;

34 
	}
}

36 
__öô
 
	$sbf_wrôe
(
u8
 
v
)

38 
Êags
;

40 i‡(
sbf_p‹t
 != -1) {

41 
v
 &~
SBF_PARITY
;

42 i‡(!
	`∑rôy
(
v
))

43 
v
 |
SBF_PARITY
;

45 
	`¥ötk
(
KERN_INFO
 "Simple Boot Flagát 0x%x setÅo 0x%x\n",

46 
sbf_p‹t
, 
v
);

48 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

49 
	`CMOS_WRITE
(
v
, 
sbf_p‹t
);

50 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

52 
	}
}

54 
u8
 
__öô
 
	$sbf_ªad
()

56 
Êags
;

57 
u8
 
v
;

59 i‡(
sbf_p‹t
 == -1)

62 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

63 
v
 = 
	`CMOS_READ
(
sbf_p‹t
);

64 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

66  
v
;

67 
	}
}

69 
__öô
 
	$sbf_vÆue_vÆid
(
u8
 
v
)

71 i‡(
v
 & 
SBF_RESERVED
)

73 i‡(!
	`∑rôy
(
v
))

77 
	}
}

79 
__öô
 
	$sbf_öô
()

81 
u8
 
v
;

83 i‡(
sbf_p‹t
 == -1)

86 
v
 = 
	`sbf_ªad
();

87 i‡(!
	`sbf_vÆue_vÆid
(
v
)) {

88 
	`¥ötk
(
KERN_WARNING
 "Simple Boot Flag value 0x%xÑead from "

89 "CMOS RAM wa†övÆid\n", 
v
);

92 
v
 &~
SBF_RESERVED
;

93 
v
 &~
SBF_BOOTING
;

94 
v
 &~
SBF_DIAG
;

95 #i‡
	`deföed
(
CONFIG_ISAPNP
)

96 
v
 |
SBF_PNPOS
;

98 
	`sbf_wrôe
(
v
);

101 
	}
}

102 
moduÀ_öô
(
sbf_öô
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/kthªad.h
>

4 
	~<löux/w‹kqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/¥Ÿo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__ªad_mo°ly
 
	gmem‹y_c‹ru±i⁄_check
 = -1;

18 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_size
 = 64*1024;

19 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_≥riod
 = 60;

21 
e820íåy
 
	gsˇn_¨ós
[
MAX_SCAN_AREAS
];

22 
	gnum_sˇn_¨ós
;

25 
__öô
 
	$£t_c‹ru±i⁄_check
(*
¨g
)

27 *
íd
;

29 
mem‹y_c‹ru±i⁄_check
 = 
	`sim∂e_°πﬁ
(
¨g
, &
íd
, 10);

31  (*
íd
 =0Ë? 0 : -
EINVAL
;

32 
	}
}

33 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check", 
£t_c‹ru±i⁄_check
);

35 
__öô
 
	$£t_c‹ru±i⁄_check_≥riod
(*
¨g
)

37 *
íd
;

39 
c‹ru±i⁄_check_≥riod
 = 
	`sim∂e_°πoul
(
¨g
, &
íd
, 10);

41  (*
íd
 =0Ë? 0 : -
EINVAL
;

42 
	}
}

43 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_≥riod", 
£t_c‹ru±i⁄_check_≥riod
);

45 
__öô
 
	$£t_c‹ru±i⁄_check_size
(*
¨g
)

47 *
íd
;

48 
size
;

50 
size
 = 
	`mem∑r£
(
¨g
, &
íd
);

52 i‡(*
íd
 == '\0')

53 
c‹ru±i⁄_check_size
 = 
size
;

55  (
size
 =
c‹ru±i⁄_check_size
Ë? 0 : -
EINVAL
;

56 
	}
}

57 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_size", 
£t_c‹ru±i⁄_check_size
);

60 
__öô
 
	$£tup_bios_c‹ru±i⁄_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 i‡(
mem‹y_c‹ru±i⁄_check
 == -1) {

65 
mem‹y_c‹ru±i⁄_check
 =

66 #ifde‡
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 i‡(
c‹ru±i⁄_check_size
 == 0)

75 
mem‹y_c‹ru±i⁄_check
 = 0;

77 i‡(!
mem‹y_c‹ru±i⁄_check
)

80 
c‹ru±i⁄_check_size
 = 
	`round_up
(c‹ru±i⁄_check_size, 
PAGE_SIZE
);

82 
addr
 < 
c‹ru±i⁄_check_size
 && 
num_sˇn_¨ós
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`föd_e820_¨ó_size
◊ddr, &
size
, 
PAGE_SIZE
);

86 i‡(!(
addr
 + 1))

89 i‡(
addr
 >
c‹ru±i⁄_check_size
)

92 i‡((
addr
 + 
size
Ë> 
c‹ru±i⁄_check_size
)

93 
size
 = 
c‹ru±i⁄_check_size
 - 
addr
;

95 
	`e820_upd©e_ønge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sˇn_¨ós
[
num_sˇn_¨ós
].
addr
 =áddr;

97 
sˇn_¨ós
[
num_sˇn_¨ós
].
size
 = size;

98 
num_sˇn_¨ós
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +
size
;

106 
	`¥ötk
(
KERN_INFO
 "Scanning %dáreas forÜow memory corruption\n",

107 
num_sˇn_¨ós
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_f‹_bios_c‹ru±i⁄
()

114 
i
;

115 
c‹ru±i⁄
 = 0;

117 i‡(!
mem‹y_c‹ru±i⁄_check
)

120 
i
 = 0; i < 
num_sˇn_¨ós
; i++) {

121 *
addr
 = 
	`__va
(
sˇn_¨ós
[
i
].addr);

122 
size
 = 
sˇn_¨ós
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 i‡(!*
addr
)

127 
	`¥ötk
(
KERN_ERR
 "CorruptedÜow memoryát %p (%lxÖhys) = %08lx\n",

128 
addr
, 
	`__∑
(addr), *addr);

129 
c‹ru±i⁄
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
c‹ru±i⁄
, 
KERN_ERR
 "Memory corruption detected inÜow memory\n");

135 
	}
}

137 
check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_w‹k
, 
check_c‹ru±i⁄
);

140 
	$check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
)

142 
	`check_f‹_bios_c‹ru±i⁄
();

143 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
,

144 
	`round_jiffõs_ªœtive
(
c‹ru±i⁄_check_≥riod
*
HZ
));

145 
	}
}

147 
	$°¨t_≥riodic_check_f‹_c‹ru±i⁄
()

149 i‡(!
mem‹y_c‹ru±i⁄_check
 || 
c‹ru±i⁄_check_≥riod
 == 0)

152 
	`¥ötk
(
KERN_INFO
 "Scanning forÜow memory corruptionÉvery %d seconds\n",

153 
c‹ru±i⁄_check_≥riod
);

156 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
, 0);

158 
	}
}

160 
moduÀ_öô
(
°¨t_≥riodic_check_f‹_c‹ru±i⁄
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<löux/˝u.h
>

7 
	~<asm/∑t.h
>

8 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/≠ic.h
>

12 
	s˝uid_bô
 {

13 
u16
 
	m„©uª
;

14 
u8
 
	mªg
;

15 
u8
 
	mbô
;

16 
u32
 
	mÀvñ
;

19 
	e˝uid_ªgs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__˝uöô
 
	$öô_sˇâîed_˝uid_„©uªs
(
˝uöfo_x86
 *
c
)

28 
u32
 
max_Àvñ
;

29 
u32
 
ªgs
[4];

30 c⁄° 
˝uid_bô
 *
cb
;

32 c⁄° 
˝uid_bô
 
__˝uöôc⁄°
 
˝uid_bôs
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

38 
cb
 = 
˝uid_bôs
; cb->
„©uª
; cb++) {

41 
max_Àvñ
 = 
	`˝uid_óx
(
cb
->
Àvñ
 & 0xffff0000);

42 i‡(
max_Àvñ
 < 
cb
->
Àvñ
 ||

43 
max_Àvñ
 > (
cb
->
Àvñ
 | 0xffff))

46 
	`˝uid
(
cb
->
Àvñ
, &
ªgs
[
CR_EAX
], &ªgs[
CR_EBX
],

47 &
ªgs
[
CR_ECX
], &ªgs[
CR_EDX
]);

49 i‡(
ªgs
[
cb
->
ªg
] & (1 << cb->
bô
))

50 
	`£t_˝u_ˇp
(
c
, 
cb
->
„©uª
);

52 
	}
}

55 
	#SMT_LEVEL
 0

	)

58 
	#INVALID_TYPE
 0

	)

59 
	#SMT_TYPE
 1

	)

60 
	#CORE_TYPE
 2

	)

62 
	#LEAFB_SUBTYPE
(
ecx
Ë((”cxË>> 8Ë& 0xff)

	)

63 
	#BITS_SHIFT_NEXT_LEVEL
(
óx
Ë(”axË& 0x1f)

	)

64 
	#LEVEL_MAX_SIBLINGS
(
ebx
Ë(”bxË& 0xffff)

	)

71 
__˝uöô
 
	$dëe˘_exãnded_t›ﬁogy
(
˝uöfo_x86
 *
c
)

73 #ifde‡
CONFIG_SMP


74 
óx
, 
ebx
, 
ecx
, 
edx
, 
sub_ödex
;

75 
ht_mask_width
, 
c‹e_∂us_mask_width
;

76 
c‹e_£À˘_mask
, 
c‹e_Àvñ_siblögs
;

77 
boﬁ
 
¥öãd
;

79 i‡(
c
->
˝uid_Àvñ
 < 0xb)

82 
	`˝uid_cou¡
(0xb, 
SMT_LEVEL
, &
óx
, &
ebx
, &
ecx
, &
edx
);

87 i‡(
ebx
 =0 || (
	`LEAFB_SUBTYPE
(
ecx
Ë!
SMT_TYPE
))

90 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

95 
c
->
öôül_≠icid
 = 
edx
;

100 
c‹e_Àvñ_siblögs
 = 
smp_num_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

101 
c‹e_∂us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

103 
sub_ödex
 = 1;

105 
	`˝uid_cou¡
(0xb, 
sub_ödex
, &
óx
, &
ebx
, &
ecx
, &
edx
);

110 i‡(
	`LEAFB_SUBTYPE
(
ecx
Ë=
CORE_TYPE
) {

111 
c‹e_Àvñ_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

112 
c‹e_∂us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

116 
sub_ödex
++;

117 } 
	`LEAFB_SUBTYPE
(
ecx
Ë!
INVALID_TYPE
);

119 
c‹e_£À˘_mask
 = (~(-1 << 
c‹e_∂us_mask_width
)Ë>> 
ht_mask_width
;

121 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ht_mask_width
)

122 & 
c‹e_£À˘_mask
;

123 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
c‹e_∂us_mask_width
);

127 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

129 
c
->
x86_max_c‹es
 = (
c‹e_Àvñ_siblögs
 / 
smp_num_siblögs
);

131 i‡(!
¥öãd
) {

132 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

133 
c
->
phys_¥oc_id
);

134 i‡(
c
->
x86_max_c‹es
 > 1)

135 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

136 
c
->
˝u_c‹e_id
);

137 
¥öãd
 = 1;

141 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<löux/öô.h
>

2 
	~<löux/bô›s.h
>

3 
	~<löux/mm.h
>

5 
	~<löux/io.h
>

6 
	~<asm/¥o˚ss‹.h
>

7 
	~<asm/≠ic.h
>

8 
	~<asm/˝u.h
>

9 
	~<asm/pci-dúe˘.h
>

11 #ifde‡
CONFIG_X86_64


12 
	~<asm/numa_64.h
>

13 
	~<asm/mmc⁄fig.h
>

14 
	~<asm/ˇcheÊush.h
>

17 
	~"˝u.h
"

19 #ifde‡
CONFIG_X86_32


33 
vide
();

34 
__asm__
(".align 4\nvide:Ñet");

36 
__˝uöô
 
	$öô_amd_k5
(
˝uöfo_x86
 *
c
)

44 
	#CBAR
 (0xfffcË

	)

45 
	#CBAR_ENB
 (0x80000000)

	)

46 
	#CBAR_KEY
 (0X000000CB)

	)

47 i‡(
c
->
x86_modñ
 == 9 || c->x86_model == 10) {

48 i‡(
	`öl
(
CBAR
Ë& 
CBAR_ENB
)

49 
	`oué
(0 | 
CBAR_KEY
, 
CBAR
);

51 
	}
}

54 
__˝uöô
 
	$öô_amd_k6
(
˝uöfo_x86
 *
c
)

56 
u32
 
l
, 
h
;

57 
mbyãs
 = 
num_phy•ages
 >> (20-
PAGE_SHIFT
);

59 i‡(
c
->
x86_modñ
 < 6) {

61 i‡(
c
->
x86_modñ
 == 0) {

62 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_APIC
);

63 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PGE
);

68 i‡(
c
->
x86_modñ
 =6 && c->
x86_mask
 == 1) {

69 c⁄° 
K6_BUG_LOOP
 = 1000000;

70 
n
;

71 (*
f_vide
)();

72 
d
, 
d2
;

74 
	`¥ötk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

81 
n
 = 
K6_BUG_LOOP
;

82 
f_vide
 = 
vide
;

83 
	`rdts˛
(
d
);

84 
n
--)

85 
	`f_vide
();

86 
	`rdts˛
(
d2
);

87 
d
 = 
d2
-d;

89 i‡(
d
 > 20*
K6_BUG_LOOP
)

90 
	`¥ötk
(
KERN_CONT


93 
	`¥ötk
(
KERN_CONT
 "probably OK (after B9730xxxx).\n");

94 
	`¥ötk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

98 i‡(
c
->
x86_modñ
 < 8 ||

99 (
c
->
x86_modñ
 =8 && c->
x86_mask
 < 8)) {

101 i‡(
mbyãs
 > 508)

102 
mbyãs
 = 508;

104 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

105 i‡((
l
&0x0000FFFF) == 0) {

106 
Êags
;

107 
l
 = (1<<0)|((
mbyãs
/4)<<1);

108 
	`loˇl_úq_ßve
(
Êags
);

109 
	`wbövd
();

110 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

111 
	`loˇl_úq_ª°‹e
(
Êags
);

112 
	`¥ötk
(
KERN_INFO
 "Enabling old style K6 writeállocation for %d Mb\n",

113 
mbyãs
);

118 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 > 7) ||

119 
c
->
x86_modñ
 == 9 || c->x86_model == 13) {

122 i‡(
mbyãs
 > 4092)

123 
mbyãs
 = 4092;

125 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

126 i‡((
l
&0xFFFF0000) == 0) {

127 
Êags
;

128 
l
 = ((
mbyãs
>>2)<<22)|(1<<16);

129 
	`loˇl_úq_ßve
(
Êags
);

130 
	`wbövd
();

131 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

132 
	`loˇl_úq_ª°‹e
(
Êags
);

133 
	`¥ötk
(
KERN_INFO
 "EnablingÇew style K6 writeállocation for %d Mb\n",

134 
mbyãs
);

140 i‡(
c
->
x86_modñ
 == 10) {

145 
	}
}

147 
__˝uöô
 
	$amd_k7_smp_check
(
˝uöfo_x86
 *
c
)

149 #ifde‡
CONFIG_SMP


151 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

159 i‡((
c
->
x86_modñ
 =6Ë&& ((c->
x86_mask
 == 0) ||

160 (
c
->
x86_mask
 == 1)))

161 
vÆid_k7
;

164 i‡((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 == 0))

165 
vÆid_k7
;

174 i‡(((
c
->
x86_modñ
 =6Ë&& (c->
x86_mask
 >= 2)) ||

175 ((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 >= 1)) ||

176 (
c
->
x86_modñ
 > 7))

177 i‡(
˝u_has_mp
)

178 
vÆid_k7
;

186 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

188 i‡(!
	`ã°_èöt
(
TAINT_UNSAFE_SMP
))

189 
	`add_èöt
(
TAINT_UNSAFE_SMP
);

191 
vÆid_k7
:

194 
	}
}

196 
__˝uöô
 
	$öô_amd_k7
(
˝uöfo_x86
 *
c
)

198 
u32
 
l
, 
h
;

205 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 10) {

206 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XMM
)) {

207 
	`¥ötk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

208 
	`rdm§
(
MSR_K7_HWCR
, 
l
, 
h
);

209 
l
 &= ~0x00008000;

210 
	`wrm§
(
MSR_K7_HWCR
, 
l
, 
h
);

211 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XMM
);

220 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

221 
	`rdm§
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

222 i‡((
l
 & 0xfff00000) != 0x20000000) {

223 
	`¥ötk
(
KERN_INFO


225 
l
, ((l & 0x000fffff)|0x20000000));

226 
	`wrm§
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

230 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K7
);

232 
	`amd_k7_smp_check
(
c
);

233 
	}
}

236 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

237 
__˝uöô
 
	$√¨by_node
(
≠icid
)

239 
i
, 
node
;

241 
i
 = 
≠icid
 - 1; i >= 0; i--) {

242 
node
 = 
≠icid_to_node
[
i
];

243 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

244  
node
;

246 
i
 = 
≠icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

247 
node
 = 
≠icid_to_node
[
i
];

248 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

249  
node
;

251  
	`fú°_node
(
node_⁄löe_m≠
);

252 
	}
}

259 #ifde‡
CONFIG_X86_HT


260 
__˝uöô
 
	$amd_fixup_dcm
(
˝uöfo_x86
 *
c
)

262 
vÆue
;

263 
u32
 
nodes
, 
c‹es_≥r_node
;

264 
˝u
 = 
	`smp_¥o˚ss‹_id
();

266 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_NODEID_MSR
))

270 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
))

273 
	`rdm§l
(
MSR_FAM10H_NODE_ID
, 
vÆue
);

275 
nodes
 = ((
vÆue
 >> 3) & 7) + 1;

276 i‡(
nodes
 == 1)

279 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_AMD_DCM
);

280 
c‹es_≥r_node
 = 
c
->
x86_max_c‹es
 / 
nodes
;

283 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
vÆue
 & 7;

286 
c
->
˝u_c‹e_id
 = c->˝u_c‹e_id % 
c‹es_≥r_node
;

287 
	}
}

294 
__˝uöô
 
	$amd_dëe˘_cmp
(
˝uöfo_x86
 *
c
)

296 #ifde‡
CONFIG_X86_HT


297 
bôs
;

298 
˝u
 = 
	`smp_¥o˚ss‹_id
();

300 
bôs
 = 
c
->
x86_c‹eid_bôs
;

302 
c
->
˝u_c‹e_id
 = c->
öôül_≠icid
 & ((1 << 
bôs
)-1);

304 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
 >> 
bôs
;

306 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
c
->
phys_¥oc_id
;

308 i‡((
c
->
x86
 =0x10Ë&& (c->
x86_modñ
 == 9))

309 
	`amd_fixup_dcm
(
c
);

311 
	}
}

313 
	$amd_gë_nb_id
(
˝u
)

315 
id
 = 0;

316 #ifde‡
CONFIG_SMP


317 
id
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

319  
id
;

320 
	}
}

321 
EXPORT_SYMBOL_GPL
(
amd_gë_nb_id
);

323 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

325 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

326 
˝u
 = 
	`smp_¥o˚ss‹_id
();

327 
node
;

328 
≠icid
 = 
c
->apicid;

330 
node
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

332 i‡(
≠icid_to_node
[
≠icid
] !
NUMA_NO_NODE
)

333 
node
 = 
≠icid_to_node
[
≠icid
];

334 i‡(!
	`node_⁄löe
(
node
)) {

345 
ht_nodeid
 = 
c
->
öôül_≠icid
;

347 i‡(
ht_nodeid
 >= 0 &&

348 
≠icid_to_node
[
ht_nodeid
] !
NUMA_NO_NODE
)

349 
node
 = 
≠icid_to_node
[
ht_nodeid
];

351 i‡(!
	`node_⁄löe
(
node
))

352 
node
 = 
	`√¨by_node
(
≠icid
);

354 
	`numa_£t_node
(
˝u
, 
node
);

356 
	}
}

358 
__˝uöô
 
	$óæy_öô_amd_mc
(
˝uöfo_x86
 *
c
)

360 #ifde‡
CONFIG_X86_HT


361 
bôs
, 
ecx
;

364 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000008)

367 
ecx
 = 
	`˝uid_ecx
(0x80000008);

369 
c
->
x86_max_c‹es
 = (
ecx
 & 0xff) + 1;

372 
bôs
 = (
ecx
 >> 12) & 0xF;

375 i‡(
bôs
 == 0) {

376 (1 << 
bôs
Ë< 
c
->
x86_max_c‹es
)

377 
bôs
++;

380 
c
->
x86_c‹eid_bôs
 = 
bôs
;

382 
	}
}

384 
__˝uöô
 
	$óæy_öô_amd
(
˝uöfo_x86
 *
c
)

386 
	`óæy_öô_amd_mc
(
c
);

392 i‡(
c
->
x86_powî
 & (1 << 8)) {

393 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

394 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

397 #ifde‡
CONFIG_X86_64


398 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSCALL32
);

401 i‡(
c
->
x86
 == 5)

402 i‡(
c
->
x86_modñ
 == 13 || c->x86_model == 9 ||

403 (
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 8))

404 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K6_MTRR
);

406 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_PCI
)

408 i‡(
˝u_has_≠ic
 && 
c
->
x86
 >= 0xf) {

409 
vÆ
;

410 
vÆ
 = 
	`ªad_pci_c⁄fig
(0, 24, 0, 0x68);

411 i‡((
vÆ
 & ((1 << 17) | (1 << 18))) == ((1 << 17) | (1 << 18)))

412 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EXTD_APICID
);

415 
	}
}

417 
__˝uöô
 
	$öô_amd
(
˝uöfo_x86
 *
c
)

419 #ifde‡
CONFIG_SMP


420 
vÆue
;

429 i‡(
c
->
x86
 == 0xf) {

430 
	`rdm§l
(
MSR_K7_HWCR
, 
vÆue
);

431 
vÆue
 |= 1 << 6;

432 
	`wrm§l
(
MSR_K7_HWCR
, 
vÆue
);

436 
	`óæy_öô_amd
(
c
);

442 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

444 #ifde‡
CONFIG_X86_64


446 i‡(
c
->
x86
 == 0xf) {

447 
u32
 
Àvñ
;

449 
Àvñ
 = 
	`˝uid_óx
(1);

450 i‡((
Àvñ
 >= 0x0f48 &&Üevel < 0x0f50) ||Üevel >= 0x0f58)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

458 i‡(
c
->
x86_modñ
 < 0x14 && 
	`˝u_has
(c, 
X86_FEATURE_LAHF_LM
)) {

459 
u64
 
vÆ
;

461 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_LAHF_LM
);

462 i‡(!
	`rdm§l_amd_ß„
(0xc001100d, &
vÆ
)) {

463 
vÆ
 &= ~(1ULL << 32);

464 
	`wrm§l_amd_ß„
(0xc001100d, 
vÆ
);

469 i‡(
c
->
x86
 == 0x10 || c->x86 == 0x11)

470 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

473 
c
->
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

482 
c
->
x86
) {

484 
	`öô_amd_k5
(
c
);

487 
	`öô_amd_k6
(
c
);

490 
	`öô_amd_k7
(
c
);

495 i‡(
c
->
x86
 < 6)

496 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_MCE
);

500 i‡(
c
->
x86
 >= 6)

501 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

503 i‡(!
c
->
x86_modñ_id
[0]) {

504 
c
->
x86
) {

508 
	`°r˝y
(
c
->
x86_modñ_id
, "Hammer");

513 
	`˝u_dëe˘_ˇche_sizes
(
c
);

516 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

517 
	`amd_dëe˘_cmp
(
c
);

518 
	`§©_dëe˘_node
(
c
);

521 #ifde‡
CONFIG_X86_32


522 
	`dëe˘_ht
(
c
);

525 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000006) {

526 i‡((
c
->
x86
 >0x0fË&& (
	`˝uid_edx
(0x80000006) & 0xf000))

527 
num_ˇche_Àaves
 = 4;

529 
num_ˇche_Àaves
 = 3;

532 i‡(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

533 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K8
);

535 i‡(
˝u_has_xmm2
) {

537 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

540 #ifde‡
CONFIG_X86_64


541 i‡(
c
->
x86
 == 0x10) {

543 i‡(
c
 =&
boŸ_˝u_d©a
)

544 
	`check_íabÀ_amd_mmc⁄f_dmi
();

546 
	`Ám10h_check_íabÀ_mmcfg
();

549 i‡(
c
 =&
boŸ_˝u_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

550 
t£g
;

557 i‡(!
	`rdm§l_ß„
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

558 
	`¥ötk
(
KERN_DEBUG
 "t£g: %010Œx\n", 
t£g
);

559 i‡((
t£g
>>
PMD_SHIFT
) <

560 (
max_low_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

561 ((
t£g
>>
PMD_SHIFT
) <

562 (
max_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

563 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

564 
	`£t_mem‹y_4k
(()
	`__va
(
t£g
), 1);

568 
	}
}

570 #ifde‡
CONFIG_X86_32


571 
__˝uöô
 
	$amd_size_ˇche
(
˝uöfo_x86
 *
c
,

572 
size
)

575 i‡((
c
->
x86
 == 6)) {

577 i‡(
c
->
x86_modñ
 =3 && c->
x86_mask
 == 0)

578 
size
 = 64;

580 i‡(
c
->
x86_modñ
 == 4 &&

581 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

582 
size
 = 256;

584  
size
;

585 
	}
}

588 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gamd_˝u_dev
 = {

589 .
c_víd‹
 = "AMD",

590 .
	gc_idít
 = { "AuthenticAMD" },

591 #ifde‡
CONFIG_X86_32


592 .
	gc_modñs
 = {

593 { .
víd‹
 = 
X86_VENDOR_AMD
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

604 .
	gc_size_ˇche
 = 
amd_size_ˇche
,

606 .
	gc_óæy_öô
 = 
óæy_öô_amd
,

607 .
	gc_öô
 = 
öô_amd
,

608 .
	gc_x86_víd‹
 = 
X86_VENDOR_AMD
,

611 
˝u_dev_ªgi°î
(
amd_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

8 
	~<asm/Æã∫©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/mår.h
>

12 
	~<asm/ˇcheÊush.h
>

14 
__öô
 
	$check_bugs
()

16 
	`idítify_boŸ_˝u
();

17 #i‡!
	`deföed
(
CONFIG_SMP
)

18 
	`¥ötk
(
KERN_INFO
 "CPU: ");

19 
	`¥öt_˝u_öfo
(&
boŸ_˝u_d©a
);

21 
	`Æã∫©ive_ö°ru˘i⁄s
();

31 i‡(!
dúe˘_gb∑ges
)

32 
	`£t_mem‹y_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/˝u„©uª.h
>

3 c⁄° * c⁄° 
	gx86_ˇp_Êags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_EXTD_APICID
] = "extd_apicid",

63 [
X86_FEATURE_AMD_DCM
] = "amd_dcm",

64 [
X86_FEATURE_APERFMPERF
] = "aperfmperf",

65 [
X86_FEATURE_XMM3
] = "pni",

66 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

67 [
X86_FEATURE_DTES64
] = "dtes64",

68 [
X86_FEATURE_MWAIT
] = "monitor",

69 [
X86_FEATURE_DSCPL
] = "ds_cpl",

70 [
X86_FEATURE_VMX
] = "vmx",

71 [
X86_FEATURE_SMX
] = "smx",

72 [
X86_FEATURE_EST
] = "est",

73 [
X86_FEATURE_TM2
] = "tm2",

74 [
X86_FEATURE_SSSE3
] = "ssse3",

75 [
X86_FEATURE_CID
] = "cid",

76 [
X86_FEATURE_FMA
] = "fma",

77 [
X86_FEATURE_CX16
] = "cx16",

78 [
X86_FEATURE_XTPR
] = "xtpr",

79 [
X86_FEATURE_PDCM
] = "pdcm",

80 [
X86_FEATURE_DCA
] = "dca",

81 [
X86_FEATURE_XMM4_1
] = "sse4_1",

82 [
X86_FEATURE_XMM4_2
] = "sse4_2",

83 [
X86_FEATURE_X2APIC
] = "x2apic",

84 [
X86_FEATURE_MOVBE
] = "movbe",

85 [
X86_FEATURE_POPCNT
] = "popcnt",

86 [
X86_FEATURE_AES
] = "aes",

87 [
X86_FEATURE_XSAVE
] = "xsave",

88 [
X86_FEATURE_AVX
] = "avx",

89 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

90 [
X86_FEATURE_XSTORE
] = "rng",

91 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

92 [
X86_FEATURE_XCRYPT
] = "ace",

93 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

94 [
X86_FEATURE_ACE2
] = "ace2",

95 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

96 [
X86_FEATURE_PHE
] = "phe",

97 [
X86_FEATURE_PHE_EN
] = "phe_en",

98 [
X86_FEATURE_PMM
] = "pmm",

99 [
X86_FEATURE_PMM_EN
] = "pmm_en",

100 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

101 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

102 [
X86_FEATURE_SVM
] = "svm",

103 [
X86_FEATURE_EXTAPIC
] = "extapic",

104 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

105 [
X86_FEATURE_ABM
] = "abm",

106 [
X86_FEATURE_SSE4A
] = "sse4a",

107 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

108 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

109 [
X86_FEATURE_OSVW
] = "osvw",

110 [
X86_FEATURE_IBS
] = "ibs",

111 [
X86_FEATURE_SSE5
] = "sse5",

112 [
X86_FEATURE_SKINIT
] = "skinit",

113 [
X86_FEATURE_WDT
] = "wdt",

114 [
X86_FEATURE_NODEID_MSR
] = "nodeid_msr",

115 [
X86_FEATURE_IDA
] = "ida",

116 [
X86_FEATURE_ARAT
] = "arat",

117 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

118 [
X86_FEATURE_VNMI
] = "vnmi",

119 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

120 [
X86_FEATURE_EPT
] = "ept",

121 [
X86_FEATURE_VPID
] = "vpid",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<löux/bô›s.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/¥o˚ss‹.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"˝u.h
"

12 #ifde‡
CONFIG_X86_OOSTORE


14 
u32
 
__˝uöô
 
	$powî2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__˝uöô
 
	$˚¡aur_m¸_ö£π
(
ªg
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |
key
;

36 
	`wrm§
(
ªg
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mår_˚¡aur_ªp‹t_m¸
(
ªg
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__˝uöô
 
	$ømt›
()

47 
u32
 
˛ù
 = 0xFFFFFFFFUL;

48 
u32
 
t›
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 
°¨t
, 
íd
;

54 i‡(
e820
.
m≠
[
i
].
addr
 > 0xFFFFFFFFUL)

60 i‡(
e820
.
m≠
[
i
].
ty≥
 =
E820_RESERVED
) {

61 i‡(
e820
.
m≠
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m≠
[
i
].
addr
 < 
˛ù
)

63 
˛ù
 = 
e820
.
m≠
[
i
].
addr
;

66 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

67 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
;

68 i‡(
°¨t
 >
íd
)

70 i‡(
íd
 > 
t›
)

71 
t›
 = 
íd
;

85 i‡(
t›
 > 
˛ù
)

86 
t›
 = 
˛ù
;

88  
t›
;

89 
	}
}

94 
__˝uöô
 
	$˚¡aur_m¸_compuã
(
ƒ
, 
key
)

96 
u32
 
mem
 = 
	`ømt›
();

97 
u32
 
roŸ
 = 
	`powî2
(
mem
);

98 
u32
 
ba£
 = 
roŸ
;

99 
u32
 
t›
 = 
roŸ
;

100 
u32
 
Êo‹
 = 0;

101 
˘
 = 0;

103 
˘
 < 
ƒ
) {

104 
u32
 
f•a˚
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`powî2
(
mem
-
t›
);

116 
low
 = 
ba£
/2;

122 i‡(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 i‡(
Êo‹
 == 0)

131 
f•a˚
 = 512*1024;

132 i‡(
Êo‹
 == 512*1024)

133 
f•a˚
 = 128*1024;

140 i‡(
f•a˚
 > 
high
 && f•a˚ > 
low
) {

141 
	`˚¡aur_m¸_ö£π
(
˘
, 
Êo‹
, 
f•a˚
, 
key
);

142 
Êo‹
 +
f•a˚
;

143 } i‡(
high
 > 
low
) {

144 
	`˚¡aur_m¸_ö£π
(
˘
, 
t›
, 
high
, 
key
);

145 
t›
 +
high
;

146 } i‡(
low
 > 0) {

147 
ba£
 -
low
;

148 
	`˚¡aur_m¸_ö£π
(
˘
, 
ba£
, 
low
, 
key
);

151 
˘
++;

157  
˘
;

158 
	}
}

160 
__˝uöô
 
	$˚¡aur_¸óã_›timÆ_m¸
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__˝uöô
 
	$wöchù2_¸óã_›timÆ_m¸
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 25);

204 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |1<<(9+
i
);

207 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__˝uöô
 
	$wöchù2_u≈rŸe˘_m¸
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |
key
<<6;

229 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__˝uöô
 
	$wöchù2_¥Ÿe˘_m¸
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28Ë

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6Ë

	)

250 
__˝uöô
 
	$öô_c3
(
˝uöfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 i‡(
	`˝uid_óx
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`˝uid_edx
(0xC0000001);

259 i‡((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |
ACE_FCR
;

262 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 i‡((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |
RNG_ENABLE
;

270 
	`wrm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ˇ∑bûôy
[5] = 
	`˝uid_edx
(0xC0000001);

279 #ifde‡
CONFIG_X86_32


281 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 9) {

282 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

289 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model < 9)

290 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

292 i‡(
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0xf) {

293 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

294 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`˝u_dëe˘_ˇche_sizes
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__˝uöô
 
	$óæy_öô_˚¡aur
(
˝uöfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifde‡
CONFIG_X86_32


327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 i‡(
c
->
x86_modñ
 >= 0xf)

332 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifde‡
CONFIG_X86_64


336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__˝uöô
 
	$öô_˚¡aur
(
˝uöfo_x86
 *
c
)

342 #ifde‡
CONFIG_X86_32


343 *
«me
;

344 
u32
 
f¸_£t
 = 0;

345 
u32
 
f¸_˛r
 = 0;

346 
u32
 
lo
, 
hi
, 
√wlo
;

347 
u32
 
Ø
, 
bb
, 
cc
, 
dd
;

353 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

355 
	`óæy_öô_˚¡aur
(
c
);

356 
c
->
x86
) {

357 #ifde‡
CONFIG_X86_32


359 
c
->
x86_modñ
) {

361 
«me
 = "C6";

362 
f¸_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
f¸_˛r
 = 
DPDC
;

364 
	`¥ötk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TSC
);

366 #ifde‡
CONFIG_X86_OOSTORE


367 
	`˚¡aur_¸óã_›timÆ_m¸
();

378 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
«me
 = "2";

387 
«me
 = "2A";

390 
«me
 = "2B";

393 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
f¸_˛r
 = 
DPDC
;

396 #ifde‡
CONFIG_X86_OOSTORE


397 
	`wöchù2_u≈rŸe˘_m¸
();

398 
	`wöchù2_¸óã_›timÆ_m¸
();

399 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wöchù2_¥Ÿe˘_m¸
();

412 
«me
 = "3";

413 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
f¸_˛r
 = 
DPDC
;

416 #ifde‡
CONFIG_X86_OOSTORE


417 
	`wöchù2_u≈rŸe˘_m¸
();

418 
	`wöchù2_¸óã_›timÆ_m¸
();

419 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wöchù2_¥Ÿe˘_m¸
();

432 
«me
 = "??";

435 
	`rdm§
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
√wlo
 = (
lo
|
f¸_£t
Ë& (~
f¸_˛r
);

438 i‡(
√wlo
 !
lo
) {

439 
	`¥ötk
(
KERN_INFO
 "Centaur FCR was 0x%XÇow 0x%X\n",

440 
lo
, 
√wlo
);

441 
	`wrm§
(
MSR_IDT_FCR1
, 
√wlo
, 
hi
);

443 
	`¥ötk
(
KERN_INFO
 "Cíèu∏FCR i†0x%X\n", 
lo
);

446 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

450 i‡(
c
->
x86_modñ
 >= 8)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

453 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000005) {

455 
	`˝uid
(0x80000005, &
Ø
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ˇche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`•rötf
(
c
->
x86_modñ_id
, "WöChù %s", 
«me
);

463 
	`öô_c3
(
c
);

466 #ifde‡
CONFIG_X86_64


467 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__˝uöô


472 
	$˚¡aur_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

474 #ifde‡
CONFIG_X86_32


476 i‡((
c
->
x86
 =6Ë&& ((c->
x86_modñ
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 == 9) &&

485 (
c
->
x86_mask
 =1Ë&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	g˚¡aur_˝u_dev
 = {

492 .
c_víd‹
 = "Centaur",

493 .
	gc_idít
 = { "CentaurHauls" },

494 .
	gc_óæy_öô
 = 
óæy_öô_˚¡aur
,

495 .
	gc_öô
 = 
öô_˚¡aur
,

496 .
	gc_size_ˇche
 = 
˚¡aur_size_ˇche
,

497 .
	gc_x86_víd‹
 = 
X86_VENDOR_CENTAUR
,

500 
˝u_dev_ªgi°î
(
˚¡aur_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<löux/boŸmem.h
>

2 
	~<löux/lökage.h
>

3 
	~<löux/bô›s.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/≥r˝u.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kgdb.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/io.h
>

15 
	~<asm/°ack¥Ÿe˘‹.h
>

16 
	~<asm/≥rf_evít.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/hy≥rvis‹.h
>

19 
	~<asm/¥o˚ss‹.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<löux/t›ﬁogy.h
>

22 
	~<löux/˝umask.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/≠ic.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/mår.h
>

31 
	~<löux/numa.h
>

32 
	~<asm/asm.h
>

33 
	~<asm/˝u.h
>

34 
	~<asm/m˚.h
>

35 
	~<asm/m§.h
>

36 
	~<asm/∑t.h
>

38 #ifde‡
CONFIG_X86_LOCAL_APIC


39 
	~<asm/uv/uv.h
>

42 
	~"˝u.h
"

45 
˝umask_v¨_t
 
	g˝u_öôülized_mask
;

46 
˝umask_v¨_t
 
	g˝u_ˇŒout_mask
;

47 
˝umask_v¨_t
 
	g˝u_ˇŒö_mask
;

50 
˝umask_v¨_t
 
	g˝u_siblög_£tup_mask
;

53 
__öô
 
	$£tup_˝u_loˇl_masks
()

55 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_öôülized_mask
);

56 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒö_mask
);

57 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒout_mask
);

58 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_siblög_£tup_mask
);

59 
	}
}

61 
__˝uöô
 
	$deÁu…_öô
(
˝uöfo_x86
 *
c
)

63 #ifde‡
CONFIG_X86_64


64 
	`˝u_dëe˘_ˇche_sizes
(
c
);

68 i‡(
c
->
˝uid_Àvñ
 == -1) {

70 i‡(
c
->
x86
 == 4)

71 
	`°r˝y
(
c
->
x86_modñ_id
, "486");

72 i‡(
c
->
x86
 == 3)

73 
	`°r˝y
(
c
->
x86_modñ_id
, "386");

76 
	}
}

78 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gdeÁu…_˝u
 = {

79 .
c_öô
 = 
deÁu…_öô
,

80 .
	gc_víd‹
 = "Unknown",

81 .
	gc_x86_víd‹
 = 
X86_VENDOR_UNKNOWN
,

84 c⁄° 
˝u_dev
 *
this_˝u
 
	g__˝uöôd©a
 = &
deÁu…_˝u
;

86 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_∑ge
, gdt_∑geË{ .
gdt
 = {

87 #ifde‡
CONFIG_X86_64


96 [
GDT_ENTRY_KERNEL32_CS
] = 
GDT_ENTRY_INIT
(0xc09b, 0, 0xfffff),

97 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xa09b, 0, 0xfffff),

98 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc093, 0, 0xfffff),

99 [
GDT_ENTRY_DEFAULT_USER32_CS
] = 
GDT_ENTRY_INIT
(0xc0fb, 0, 0xfffff),

100 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f3, 0, 0xfffff),

101 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xa0fb, 0, 0xfffff),

103 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xc09a, 0, 0xfffff),

104 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

105 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xc0fa, 0, 0xfffff),

106 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f2, 0, 0xfffff),

113 [
GDT_ENTRY_PNPBIOS_CS32
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

115 [
GDT_ENTRY_PNPBIOS_CS16
] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

117 [
GDT_ENTRY_PNPBIOS_DS
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0xffff),

119 [
GDT_ENTRY_PNPBIOS_TS1
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

121 [
GDT_ENTRY_PNPBIOS_TS2
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

127 [
GDT_ENTRY_APMBIOS_BASE
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

129 [
GDT_ENTRY_APMBIOS_BASE
+1] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

131 [
GDT_ENTRY_APMBIOS_BASE
+2] = 
GDT_ENTRY_INIT
(0x4092, 0, 0xffff),

133 [
GDT_ENTRY_ESPFIX_SS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

134 [
GDT_ENTRY_PERCPU
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

135 
	gGDT_STACK_CANARY_INIT


138 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_∑ge
);

140 
__öô
 
	$x86_xßve_£tup
(*
s
)

142 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XSAVE
);

144 
	}
}

145 
__£tup
("noxßve", 
x86_xßve_£tup
);

147 #ifde‡
CONFIG_X86_32


148 
ˇchesize_ovîride
 
	g__˝uöôd©a
 = -1;

149 
dißbÀ_x86_£rül_ƒ
 
	g__˝uöôd©a
 = 1;

151 
__öô
 
	$ˇchesize_£tup
(*
°r
)

153 
	`gë_›ti⁄
(&
°r
, &
ˇchesize_ovîride
);

155 
	}
}

156 
__£tup
("ˇchesize=", 
ˇchesize_£tup
);

158 
__öô
 
	$x86_fx§_£tup
(*
s
)

160 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_FXSR
);

161 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XMM
);

163 
	}
}

164 
__£tup
("nofx§", 
x86_fx§_£tup
);

166 
__öô
 
	$x86_£p_£tup
(*
s
)

168 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_SEP
);

170 
	}
}

171 
__£tup
("no£p", 
x86_£p_£tup
);

174 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

176 
u32
 
f1
, 
f2
;

185 
asm
 volatile ("pushfl \n\t"

196 : "=&r" (
f1
), "=&r" (
f2
)

197 : "ú" (
Êag
));

199  ((
f1
^
f2
Ë& 
Êag
) != 0;

200 
	}
}

203 
__˝uöô
 
	$have_˝uid_p
()

205  
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_ID
);

206 
	}
}

208 
__˝uöô
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

210 
lo
, 
hi
;

212 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_PN
Ë|| !
dißbÀ_x86_£rül_ƒ
)

217 
	`rdm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

218 
lo
 |= 0x200000;

219 
	`wrm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

221 
	`¥ötk
(
KERN_NOTICE
 "CPU serialÇumber disabled.\n");

222 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PN
);

225 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

226 
	}
}

228 
__öô
 
	$x86_£rül_ƒ_£tup
(*
s
)

230 
dißbÀ_x86_£rül_ƒ
 = 0;

232 
	}
}

233 
__£tup
("£rü umbî", 
x86_£rül_ƒ_£tup
);

235 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

238 
	}
}

240 
ölöe
 
	$have_˝uid_p
()

243 
	}
}

244 
ölöe
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

246 
	}
}

254 
	s˝uid_dïídít_„©uª
 {

255 
u32
 
	m„©uª
;

256 
u32
 
	mÀvñ
;

259 c⁄° 
˝uid_dïídít_„©uª
 
__˝uöôc⁄°


260 
	g˝uid_dïídít_„©uªs
[] = {

261 { 
X86_FEATURE_MWAIT
, 0x00000005 },

262 { 
X86_FEATURE_DCA
, 0x00000009 },

263 { 
X86_FEATURE_XSAVE
, 0x0000000d },

267 
__˝uöô
 
	$fûãr_˝uid_„©uªs
(
˝uöfo_x86
 *
c
, 
boﬁ
 
w¨n
)

269 c⁄° 
˝uid_dïídít_„©uª
 *
df
;

271 
df
 = 
˝uid_dïídít_„©uªs
; df->
„©uª
; df++) {

273 i‡(!
	`˝u_has
(
c
, 
df
->
„©uª
))

282 i‡(!((
s32
)
df
->
Àvñ
 < 0 ?

283 (
u32
)
df
->
Àvñ
 > (u32)
c
->
exãnded_˝uid_Àvñ
 :

284 (
s32
)
df
->
Àvñ
 > (s32)
c
->
˝uid_Àvñ
))

287 
	`˛ór_˝u_ˇp
(
c
, 
df
->
„©uª
);

288 i‡(!
w¨n
)

291 
	`¥ötk
(
KERN_WARNING


293 
x86_ˇp_Êags
[
df
->
„©uª
], df->
Àvñ
);

295 
	}
}

305 c⁄° *
__˝uöô
 
	$èbÀ_lookup_modñ
(
˝uöfo_x86
 *
c
)

307 c⁄° 
˝u_modñ_öfo
 *
öfo
;

309 i‡(
c
->
x86_modñ
 >= 16)

310  
NULL
;

312 i‡(!
this_˝u
)

313  
NULL
;

315 
öfo
 = 
this_˝u
->
c_modñs
;

317 
öfo
 && info->
Ámûy
) {

318 i‡(
öfo
->
Ámûy
 =
c
->
x86
)

319  
öfo
->
modñ_«mes
[
c
->
x86_modñ
];

320 
öfo
++;

322  
NULL
;

323 
	}
}

325 
__u32
 
	g˝u_ˇps_˛óªd
[
NCAPINTS
] 
	g__˝uöôd©a
;

326 
__u32
 
	g˝u_ˇps_£t
[
NCAPINTS
] 
	g__˝uöôd©a
;

328 
	$lﬂd_≥r˝u_£gmít
(
˝u
)

330 #ifde‡
CONFIG_X86_32


331 
	`lﬂd£gmít
(
fs
, 
__KERNEL_PERCPU
);

333 
	`lﬂd£gmít
(
gs
, 0);

334 
	`wrm§l
(
MSR_GS_BASE
, ()
	`≥r_˝u
(
úq_°ack_uni⁄
.
gs_ba£
, 
˝u
));

336 
	`lﬂd_°ack_ˇ«ry_£gmít
();

337 
	}
}

343 
	$swôch_to_√w_gdt
(
˝u
)

345 
desc_±r
 
gdt_des¸
;

347 
gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

348 
gdt_des¸
.
size
 = 
GDT_SIZE
 - 1;

349 
	`lﬂd_gdt
(&
gdt_des¸
);

352 
	`lﬂd_≥r˝u_£gmít
(
˝u
);

353 
	}
}

355 c⁄° 
˝u_dev
 *
__˝uöôd©a
 
	g˝u_devs
[
X86_VENDOR_NUM
] = {};

357 
__˝uöô
 
	$gë_modñ_«me
(
˝uöfo_x86
 *
c
)

359 *
v
;

360 *
p
, *
q
;

362 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000004)

365 
v
 = (*)
c
->
x86_modñ_id
;

366 
	`˝uid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

367 
	`˝uid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

368 
	`˝uid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

369 
c
->
x86_modñ_id
[48] = 0;

375 
p
 = 
q
 = &
c
->
x86_modñ_id
[0];

376 *
p
 == ' ')

377 
p
++;

378 i‡(
p
 !
q
) {

379 *
p
)

380 *
q
++ = *
p
++;

381 
q
 <&
c
->
x86_modñ_id
[48])

382 *
q
++ = '\0';

384 
	}
}

386 
__˝uöô
 
	$˝u_dëe˘_ˇche_sizes
(
˝uöfo_x86
 *
c
)

388 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

390 
n
 = 
c
->
exãnded_˝uid_Àvñ
;

392 i‡(
n
 >= 0x80000005) {

393 
	`˝uid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

394 
c
->
x86_ˇche_size
 = (
ecx
>>24Ë+ (
edx
>>24);

395 #ifde‡
CONFIG_X86_64


397 
c
->
x86_ébsize
 = 0;

401 i‡(
n
 < 0x80000006)

404 
	`˝uid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

405 
l2size
 = 
ecx
 >> 16;

407 #ifde‡
CONFIG_X86_64


408 
c
->
x86_ébsize
 +((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

411 i‡(
this_˝u
->
c_size_ˇche
)

412 
l2size
 = 
this_˝u
->
	`c_size_ˇche
(
c
,Ü2size);

415 i‡(
ˇchesize_ovîride
 != -1)

416 
l2size
 = 
ˇchesize_ovîride
;

418 i‡(
l2size
 == 0)

422 
c
->
x86_ˇche_size
 = 
l2size
;

423 
	}
}

425 
__˝uöô
 
	$dëe˘_ht
(
˝uöfo_x86
 *
c
)

427 #ifde‡
CONFIG_X86_HT


428 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

429 
ödex_msb
, 
c‹e_bôs
;

430 
boﬁ
 
¥öãd
;

432 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_HT
))

435 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

436 
out
;

438 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

441 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
edx
);

443 
smp_num_siblögs
 = (
ebx
 & 0xff0000) >> 16;

445 i‡(
smp_num_siblögs
 == 1) {

446 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Hyper-Threading is disabled\n");

447 
out
;

450 i‡(
smp_num_siblögs
 <= 1)

451 
out
;

453 i‡(
smp_num_siblögs
 > 
ƒ_˝u_ids
) {

454 
	`¥_w¨nög
("CPU: UnsupportedÇumber of siblings %d",

455 
smp_num_siblögs
);

456 
smp_num_siblögs
 = 1;

460 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

461 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
);

463 
smp_num_siblögs
 = smp_num_siblög†/ 
c
->
x86_max_c‹es
;

465 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

467 
c‹e_bôs
 = 
	`gë_cou¡_‹dî
(
c
->
x86_max_c‹es
);

469 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
) &

470 ((1 << 
c‹e_bôs
) - 1);

472 
out
:

473 i‡(!
¥öãd
 && (
c
->
x86_max_c‹es
 * 
smp_num_siblögs
) > 1) {

474 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

475 
c
->
phys_¥oc_id
);

476 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

477 
c
->
˝u_c‹e_id
);

478 
¥öãd
 = 1;

481 
	}
}

483 
__˝uöô
 
	$gë_˝u_víd‹
(
˝uöfo_x86
 *
c
)

485 *
v
 = 
c
->
x86_víd‹_id
;

486 
i
;

488 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

489 i‡(!
˝u_devs
[
i
])

492 i‡(!
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[0]) ||

493 (
˝u_devs
[
i
]->
c_idít
[1] &&

494 !
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[1]))) {

496 
this_˝u
 = 
˝u_devs
[
i
];

497 
c
->
x86_víd‹
 = 
this_˝u
->
c_x86_víd‹
;

502 
	`¥ötk_⁄˚
(
KERN_ERR


504 "CPU: You∏sy°em may bêun°abÀ.\n", 
v
);

506 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

507 
this_˝u
 = &
deÁu…_˝u
;

508 
	}
}

510 
__˝uöô
 
	$˝u_dëe˘
(
˝uöfo_x86
 *
c
)

513 
	`˝uid
(0x00000000, (*)&
c
->
˝uid_Àvñ
,

514 (*)&
c
->
x86_víd‹_id
[0],

515 (*)&
c
->
x86_víd‹_id
[8],

516 (*)&
c
->
x86_víd‹_id
[4]);

518 
c
->
x86
 = 4;

520 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

521 
u32
 
junk
, 
tfms
, 
ˇp0
, 
misc
;

523 
	`˝uid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ˇp0
);

524 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

525 
c
->
x86_modñ
 = (
tfms
 >> 4) & 0xf;

526 
c
->
x86_mask
 = 
tfms
 & 0xf;

528 i‡(
c
->
x86
 == 0xf)

529 
c
->
x86
 +(
tfms
 >> 20) & 0xff;

530 i‡(
c
->
x86
 >= 0x6)

531 
c
->
x86_modñ
 +((
tfms
 >> 16) & 0xf) << 4;

533 i‡(
ˇp0
 & (1<<19)) {

534 
c
->
x86_˛Êush_size
 = ((
misc
 >> 8) & 0xff) * 8;

535 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

538 
	}
}

540 
__˝uöô
 
	$gë_˝u_ˇp
(
˝uöfo_x86
 *
c
)

542 
u32
 
tfms
, 
xlvl
;

543 
u32
 
ebx
;

546 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

547 
u32
 
ˇ∑bûôy
, 
exˇp
;

549 
	`˝uid
(0x00000001, &
tfms
, &
ebx
, &
exˇp
, &
ˇ∑bûôy
);

550 
c
->
x86_ˇ∑bûôy
[0] = 
ˇ∑bûôy
;

551 
c
->
x86_ˇ∑bûôy
[4] = 
exˇp
;

555 
xlvl
 = 
	`˝uid_óx
(0x80000000);

556 
c
->
exãnded_˝uid_Àvñ
 = 
xlvl
;

558 i‡((
xlvl
 & 0xffff0000) == 0x80000000) {

559 i‡(
xlvl
 >= 0x80000001) {

560 
c
->
x86_ˇ∑bûôy
[1] = 
	`˝uid_edx
(0x80000001);

561 
c
->
x86_ˇ∑bûôy
[6] = 
	`˝uid_ecx
(0x80000001);

565 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

566 
u32
 
óx
 = 
	`˝uid_óx
(0x80000008);

568 
c
->
x86_vút_bôs
 = (
óx
 >> 8) & 0xff;

569 
c
->
x86_phys_bôs
 = 
óx
 & 0xff;

571 #ifde‡
CONFIG_X86_32


572 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_PAE
Ë|| cpu_has(c, 
X86_FEATURE_PSE36
))

573 
c
->
x86_phys_bôs
 = 36;

576 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000007)

577 
c
->
x86_powî
 = 
	`˝uid_edx
(0x80000007);

579 
	}
}

581 
__˝uöô
 
	$idítify_˝u_wôhout_˝uid
(
˝uöfo_x86
 *
c
)

583 #ifde‡
CONFIG_X86_32


584 
i
;

590 i‡(
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_AC
))

591 
c
->
x86
 = 4;

593 
c
->
x86
 = 3;

595 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

596 i‡(
˝u_devs
[
i
] && cpu_devs[i]->
c_idítify
) {

597 
c
->
x86_víd‹_id
[0] = 0;

598 
˝u_devs
[
i
]->
	`c_idítify
(
c
);

599 i‡(
c
->
x86_víd‹_id
[0]) {

600 
	`gë_˝u_víd‹
(
c
);

605 
	}
}

616 
__öô
 
	$óæy_idítify_˝u
(
˝uöfo_x86
 *
c
)

618 #ifde‡
CONFIG_X86_64


619 
c
->
x86_˛Êush_size
 = 64;

620 
c
->
x86_phys_bôs
 = 36;

621 
c
->
x86_vút_bôs
 = 48;

623 
c
->
x86_˛Êush_size
 = 32;

624 
c
->
x86_phys_bôs
 = 32;

625 
c
->
x86_vút_bôs
 = 32;

627 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

629 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

630 
c
->
exãnded_˝uid_Àvñ
 = 0;

632 i‡(!
	`have_˝uid_p
())

633 
	`idítify_˝u_wôhout_˝uid
(
c
);

636 i‡(!
	`have_˝uid_p
())

639 
	`˝u_dëe˘
(
c
);

641 
	`gë_˝u_víd‹
(
c
);

643 
	`gë_˝u_ˇp
(
c
);

645 i‡(
this_˝u
->
c_óæy_öô
)

646 
this_˝u
->
	`c_óæy_öô
(
c
);

648 #ifde‡
CONFIG_SMP


649 
c
->
˝u_ödex
 = 
boŸ_˝u_id
;

651 
	`fûãr_˝uid_„©uªs
(
c
, 
Ál£
);

652 
	}
}

654 
__öô
 
	$óæy_˝u_öô
()

656 c⁄° 
˝u_dev
 *c⁄° *
cdev
;

657 
cou¡
 = 0;

659 #ifde‡
PROCESSOR_SELECT


660 
	`¥ötk
(
KERN_INFO
 "KERNEL supported cpus:\n");

663 
cdev
 = 
__x86_˝u_dev_°¨t
; cdev < 
__x86_˝u_dev_íd
; cdev++) {

664 c⁄° 
˝u_dev
 *
˝udev
 = *
cdev
;

666 i‡(
cou¡
 >
X86_VENDOR_NUM
)

668 
˝u_devs
[
cou¡
] = 
˝udev
;

669 
cou¡
++;

671 #ifde‡
PROCESSOR_SELECT


673 
j
;

675 
j
 = 0; j < 2; j++) {

676 i‡(!
˝udev
->
c_idít
[
j
])

678 
	`¥ötk
(
KERN_INFO
 " %†%s\n", 
˝udev
->
c_víd‹
,

679 
˝udev
->
c_idít
[
j
]);

684 
	`óæy_idítify_˝u
(&
boŸ_˝u_d©a
);

685 
	}
}

695 
__˝uöô
 
	$dëe˘_n›l
(
˝uöfo_x86
 *
c
)

697 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_NOPL
);

698 
	}
}

700 
__˝uöô
 
	$gíîic_idítify
(
˝uöfo_x86
 *
c
)

702 
c
->
exãnded_˝uid_Àvñ
 = 0;

704 i‡(!
	`have_˝uid_p
())

705 
	`idítify_˝u_wôhout_˝uid
(
c
);

708 i‡(!
	`have_˝uid_p
())

711 
	`˝u_dëe˘
(
c
);

713 
	`gë_˝u_víd‹
(
c
);

715 
	`gë_˝u_ˇp
(
c
);

717 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

718 
c
->
öôül_≠icid
 = (
	`˝uid_ebx
(1) >> 24) & 0xFF;

719 #ifde‡
CONFIG_X86_32


720 #ifde‡
CONFIG_X86_HT


721 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

723 
c
->
≠icid
 = c->
öôül_≠icid
;

727 #ifde‡
CONFIG_X86_HT


728 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
;

732 
	`gë_modñ_«me
(
c
);

734 
	`öô_sˇâîed_˝uid_„©uªs
(
c
);

735 
	`dëe˘_n›l
(
c
);

736 
	}
}

741 
__˝uöô
 
	$idítify_˝u
(
˝uöfo_x86
 *
c
)

743 
i
;

745 
c
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

746 
c
->
x86_ˇche_size
 = -1;

747 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

748 
c
->
x86_modñ
 = c->
x86_mask
 = 0;

749 
c
->
x86_víd‹_id
[0] = '\0';

750 
c
->
x86_modñ_id
[0] = '\0';

751 
c
->
x86_max_c‹es
 = 1;

752 
c
->
x86_c‹eid_bôs
 = 0;

753 #ifde‡
CONFIG_X86_64


754 
c
->
x86_˛Êush_size
 = 64;

755 
c
->
x86_phys_bôs
 = 36;

756 
c
->
x86_vút_bôs
 = 48;

758 
c
->
˝uid_Àvñ
 = -1;

759 
c
->
x86_˛Êush_size
 = 32;

760 
c
->
x86_phys_bôs
 = 32;

761 
c
->
x86_vút_bôs
 = 32;

763 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

764 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

766 
	`gíîic_idítify
(
c
);

768 i‡(
this_˝u
->
c_idítify
)

769 
this_˝u
->
	`c_idítify
(
c
);

772 
i
 = 0; i < 
NCAPINTS
; i++) {

773 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

774 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

777 #ifde‡
CONFIG_X86_64


778 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

791 i‡(
this_˝u
->
c_öô
)

792 
this_˝u
->
	`c_öô
(
c
);

795 
	`squash_the_°upid_£rül_numbî
(
c
);

803 
	`fûãr_˝uid_„©uªs
(
c
, 
åue
);

806 i‡(!
c
->
x86_modñ_id
[0]) {

807 c⁄° *
p
;

808 
p
 = 
	`èbÀ_lookup_modñ
(
c
);

809 i‡(
p
)

810 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

813 
	`•rötf
(
c
->
x86_modñ_id
, "%02x/%02x",

814 
c
->
x86
, c->
x86_modñ
);

817 #ifde‡
CONFIG_X86_64


818 
	`dëe˘_ht
(
c
);

821 
	`öô_hy≥rvis‹
(
c
);

827 
i
 = 0; i < 
NCAPINTS
; i++) {

828 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

829 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

838 i‡(
c
 !&
boŸ_˝u_d©a
) {

840 
i
 = 0; i < 
NCAPINTS
; i++)

841 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[
i
] &
c
->x86_capability[i];

845 
	`mcheck_˝u_öô
(
c
);

847 
	`£À˘_idÀ_routöe
(
c
);

849 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

850 
	`numa_add_˝u
(
	`smp_¥o˚ss‹_id
());

852 
	}
}

854 #ifde‡
CONFIG_X86_64


855 
	$vgë˝u_£t_mode
()

857 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_RDTSCP
))

858 
vgë˝u_mode
 = 
VGETCPU_RDTSCP
;

860 
vgë˝u_mode
 = 
VGETCPU_LSL
;

861 
	}
}

864 
__öô
 
	$idítify_boŸ_˝u
()

866 
	`idítify_˝u
(&
boŸ_˝u_d©a
);

867 
	`öô_c1e_mask
();

868 #ifde‡
CONFIG_X86_32


869 
	`sy£¡î_£tup
();

870 
	`íabÀ_£p_˝u
();

872 
	`vgë˝u_£t_mode
();

874 
	`öô_hw_≥rf_evíts
();

875 
	}
}

877 
__˝uöô
 
	$idítify_£c⁄d¨y_˝u
(
˝uöfo_x86
 *
c
)

879 
	`BUG_ON
(
c
 =&
boŸ_˝u_d©a
);

880 
	`idítify_˝u
(
c
);

881 #ifde‡
CONFIG_X86_32


882 
	`íabÀ_£p_˝u
();

884 
	`mår_≠_öô
();

885 
	}
}

887 
	sm§_ønge
 {

888 
	mmö
;

889 
	mmax
;

892 c⁄° 
m§_ønge
 
	gm§_ønge_¨øy
[] 
	g__˝uöôc⁄°
 = {

899 
__˝uöô
 
	$¥öt_˝u_m§
()

901 
ödex_mö
, 
ödex_max
;

902 
ödex
;

903 
u64
 
vÆ
;

904 
i
;

906 
i
 = 0; i < 
	`ARRAY_SIZE
(
m§_ønge_¨øy
); i++) {

907 
ödex_mö
 = 
m§_ønge_¨øy
[
i
].
mö
;

908 
ödex_max
 = 
m§_ønge_¨øy
[
i
].
max
;

910 
ödex
 = 
ödex_mö
; index < 
ödex_max
; index++) {

911 i‡(
	`rdm§l_amd_ß„
(
ödex
, &
vÆ
))

913 
	`¥ötk
(
KERN_INFO
 " MSR%08x: %016Œx\n", 
ödex
, 
vÆ
);

916 
	}
}

918 
show_m§
 
	g__˝uöôd©a
;

920 
__öô
 
	$£tup_show_m§
(*
¨g
)

922 
num
;

924 
	`gë_›ti⁄
(&
¨g
, &
num
);

926 i‡(
num
 > 0)

927 
show_m§
 = 
num
;

929 
	}
}

930 
__£tup
("show_m§=", 
£tup_show_m§
);

932 
__öô
 
	$£tup_no˛Êush
(*
¨g
)

934 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_CLFLSH
);

936 
	}
}

937 
__£tup
("no˛Êush", 
£tup_no˛Êush
);

939 
__˝uöô
 
	$¥öt_˝u_öfo
(
˝uöfo_x86
 *
c
)

941 c⁄° *
víd‹
 = 
NULL
;

943 i‡(
c
->
x86_víd‹
 < 
X86_VENDOR_NUM
) {

944 
víd‹
 = 
this_˝u
->
c_víd‹
;

946 i‡(
c
->
˝uid_Àvñ
 >= 0)

947 
víd‹
 = 
c
->
x86_víd‹_id
;

950 i‡(
víd‹
 && !
	`°r°r
(
c
->
x86_modñ_id
, vendor))

951 
	`¥ötk
(
KERN_CONT
 "%†", 
víd‹
);

953 i‡(
c
->
x86_modñ_id
[0])

954 
	`¥ötk
(
KERN_CONT
 "%s", 
c
->
x86_modñ_id
);

956 
	`¥ötk
(
KERN_CONT
 "%d86", 
c
->
x86
);

958 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

959 
	`¥ötk
(
KERN_CONT
 " sãµög %02x\n", 
c
->
x86_mask
);

961 
	`¥ötk
(
KERN_CONT
 "\n");

963 #ifde‡
CONFIG_SMP


964 i‡(
c
->
˝u_ödex
 < 
show_m§
)

965 
	`¥öt_˝u_m§
();

967 i‡(
show_m§
)

968 
	`¥öt_˝u_m§
();

970 
	}
}

972 
__öô
 
	$£tup_dißbÀ˝uid
(*
¨g
)

974 
bô
;

976 i‡(
	`gë_›ti⁄
(&
¨g
, &
bô
Ë&& bô < 
NCAPINTS
*32)

977 
	`£tup_˛ór_˝u_ˇp
(
bô
);

982 
	}
}

983 
__£tup
("˛ór˝uid=", 
£tup_dißbÀ˝uid
);

985 #ifde‡
CONFIG_X86_64


986 
desc_±r
 
	gidt_des¸
 = { 
NR_VECTORS
 * 16 - 1, (Ë
idt_èbÀ
 };

988 
	$DEFINE_PER_CPU_FIRST
(
úq_°ack_uni⁄
,

989 
úq_°ack_uni⁄
Ë
	`__Æig√d
(
PAGE_SIZE
);

995 
	$DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë
____ˇchñöe_Æig√d
 =

996 &
öô_èsk
;

997 
	`EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

999 
	`DEFINE_PER_CPU
(, 
kî√l_°ack
) =

1000 ()&
öô_thªad_uni⁄
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

1001 
	`EXPORT_PER_CPU_SYMBOL
(
kî√l_°ack
);

1003 
	`DEFINE_PER_CPU
(*, 
úq_°ack_±r
) =

1004 
	`öô_≥r_˝u_v¨
(
úq_°ack_uni⁄
.
úq_°ack
Ë+ 
IRQ_STACK_SIZE
 - 64;

1006 
	`DEFINE_PER_CPU
(, 
úq_cou¡
) = -1;

1014 c⁄° 
ex˚±i⁄_°ack_sizes
[
N_EXCEPTION_STACKS
] = {

1015 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

1016 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


1017 
	}
};

1019 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
ex˚±i⁄_°acks


1020 [(
N_EXCEPTION_STACKS
 - 1Ë* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
]);

1023 
	$sysˇŒ_öô
()

1030 
	`wrm§l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1031 
	`wrm§l
(
MSR_LSTAR
, 
sy°em_ˇŒ
);

1032 
	`wrm§l
(
MSR_CSTAR
, 
ign‹e_sy§ë
);

1034 #ifde‡
CONFIG_IA32_EMULATION


1035 
	`sysˇŒ32_˝u_öô
();

1039 
	`wrm§l
(
MSR_SYSCALL_MASK
,

1040 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1041 
	}
}

1043 
	gkî√l_eÊags
;

1049 
DEFINE_PER_CPU
(
‹ig_i°
, orig_ist);

1053 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë&
öô_èsk
;

1054 
EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

1056 #ifde‡
CONFIG_CC_STACKPROTECTOR


1057 
DEFINE_PER_CPU_ALIGNED
(
°ack_ˇ«ry
, stack_canary);

1061 
±_ªgs
 * 
__˝uöô
 
	$idÀ_ªgs
(
±_ªgs
 *
ªgs
)

1063 
	`mem£t
(
ªgs
, 0, (
±_ªgs
));

1064 
ªgs
->
fs
 = 
__KERNEL_PERCPU
;

1065 
ªgs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1067  
ªgs
;

1068 
	}
}

1074 
	$˛ór_Æl_debug_ªgs
()

1076 
i
;

1078 
i
 = 0; i < 8; i++) {

1080 i‡((
i
 == 4) || (i == 5))

1083 
	`£t_debugªg
(0, 
i
);

1085 
	}
}

1094 #ifde‡
CONFIG_X86_64


1096 
__˝uöô
 
	$˝u_öô
()

1098 
‹ig_i°
 *
oi°
;

1099 
èsk_°ru˘
 *
me
;

1100 
tss_°ru˘
 *
t
;

1101 
v
;

1102 
˝u
;

1103 
i
;

1105 
˝u
 = 
	`°ack_smp_¥o˚ss‹_id
();

1106 
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1107 
oi°
 = &
	`≥r_˝u
(
‹ig_i°
, 
˝u
);

1109 #ifde‡
CONFIG_NUMA


1110 i‡(
˝u
 !0 && 
	`≥r˝u_ªad
(
node_numbî
) == 0 &&

1111 
	`˝u_to_node
(
˝u
Ë!
NUMA_NO_NODE
)

1112 
	`≥r˝u_wrôe
(
node_numbî
, 
	`˝u_to_node
(
˝u
));

1115 
me
 = 
cuºít
;

1117 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
))

1118 
	`∑nic
("CPU#%dáÃódy inôülized!\n", 
˝u
);

1120 
	`¥_debug
("Inôülizög CPU#%d\n", 
˝u
);

1122 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1129 
	`swôch_to_√w_gdt
(
˝u
);

1130 
	`lﬂd£gmít
(
fs
, 0);

1132 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

1134 
	`mem£t
(
me
->
thªad
.
és_¨øy
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1135 
	`sysˇŒ_öô
();

1137 
	`wrm§l
(
MSR_FS_BASE
, 0);

1138 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 0);

1139 
	`b¨rõr
();

1141 
	`x86_c⁄figuª_nx
();

1142 i‡(
˝u
 != 0)

1143 
	`íabÀ_x2≠ic
();

1148 i‡(!
oi°
->
i°
[0]) {

1149 *
e°acks
 = 
	`≥r_˝u
(
ex˚±i⁄_°acks
, 
˝u
);

1151 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1152 
e°acks
 +
ex˚±i⁄_°ack_sizes
[
v
];

1153 
oi°
->
i°
[
v
] = 
t
->
x86_tss
.ist[v] =

1154 ()
e°acks
;

1158 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1164 
i
 = 0; i <
IO_BITMAP_LONGS
; i++)

1165 
t
->
io_bôm≠
[
i
] = ~0UL;

1167 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1168 
me
->
a˘ive_mm
 = &
öô_mm
;

1169 
	`BUG_ON
(
me
->
mm
);

1170 
	`íãr_œzy_éb
(&
öô_mm
, 
me
);

1172 
	`lﬂd_•0
(
t
, &
cuºít
->
thªad
);

1173 
	`£t_tss_desc
(
˝u
, 
t
);

1174 
	`lﬂd_TR_desc
();

1175 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1177 #ifde‡
CONFIG_KGDB


1184 i‡(
kgdb_c⁄√˘ed
 && 
¨ch_kgdb_›s
.
c‹ª˘_hw_bªak
)

1185 
¨ch_kgdb_›s
.
	`c‹ª˘_hw_bªak
();

1188 
	`˛ór_Æl_debug_ªgs
();

1190 
	`Âu_öô
();

1192 
	`øw_loˇl_ßve_Êags
(
kî√l_eÊags
);

1194 i‡(
	`is_uv_sy°em
())

1195 
	`uv_˝u_öô
();

1196 
	}
}

1200 
__˝uöô
 
	$˝u_öô
()

1202 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1203 
èsk_°ru˘
 *
cuº
 = 
cuºít
;

1204 
tss_°ru˘
 *
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1205 
thªad_°ru˘
 *
thªad
 = &
cuº
->thread;

1207 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
)) {

1208 
	`¥ötk
(
KERN_WARNING
 "CPU#%dáÃódy inôülized!\n", 
˝u
);

1210 
	`loˇl_úq_íabÀ
();

1213 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1215 i‡(
˝u_has_vme
 || 
˝u_has_tsc
 || 
˝u_has_de
)

1216 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1218 
	`lﬂd_idt
(&
idt_des¸
);

1219 
	`swôch_to_√w_gdt
(
˝u
);

1224 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1225 
cuº
->
a˘ive_mm
 = &
öô_mm
;

1226 
	`BUG_ON
(
cuº
->
mm
);

1227 
	`íãr_œzy_éb
(&
öô_mm
, 
cuº
);

1229 
	`lﬂd_•0
(
t
, 
thªad
);

1230 
	`£t_tss_desc
(
˝u
, 
t
);

1231 
	`lﬂd_TR_desc
();

1232 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1234 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1236 #ifde‡
CONFIG_DOUBLEFAULT


1238 
	`__£t_tss_desc
(
˝u
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubÀÁu…_tss
);

1241 
	`˛ór_Æl_debug_ªgs
();

1246 i‡(
˝u_has_xßve
)

1247 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

1249 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

1250 
	`˛ór_u£d_m©h
();

1251 
	`mxc§_„©uª_mask_öô
();

1256 i‡(
	`smp_¥o˚ss‹_id
(Ë=
boŸ_˝u_id
)

1257 
	`öô_thªad_x°©e
();

1259 
	`xßve_öô
();

1260 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<löux/kî√l.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/˝u‰eq.h
>

34 
	~<löux/compûî.h
>

35 
	~<löux/dmi.h
>

36 
	~<åa˚/evíts/powî.h
>

38 
	~<löux/a˝i.h
>

39 
	~<löux/io.h
>

40 
	~<löux/dñay.h
>

41 
	~<löux/uac˚ss.h
>

43 
	~<a˝i/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/¥o˚ss‹.h
>

47 
	~<asm/˝u„©uª.h
>

49 
	#d¥ötk
(
msg
...Ë
	`˝u‰eq_debug_¥ötk
(
CPUFREQ_DEBUG_DRIVER
, \

50 "a˝i-˝u‰eq", 
msg
)

	)

52 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

53 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

54 
MODULE_LICENSE
("GPL");

57 
	mUNDEFINED_CAPABLE
 = 0,

58 
	mSYSTEM_INTEL_MSR_CAPABLE
,

59 
	mSYSTEM_IO_CAPABLE
,

62 
	#INTEL_MSR_RANGE
 (0xffff)

	)

64 
	sa˝i_˝u‰eq_d©a
 {

65 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ma˝i_d©a
;

66 
˝u‰eq_‰equícy_èbÀ
 *
	m‰eq_èbÀ
;

67 
	mªsume
;

68 
	m˝u_„©uª
;

71 
DEFINE_PER_CPU
(
a˝i_˝u‰eq_d©a
 *, 
ac‰eq_d©a
);

73 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ac‰eq_ﬁd_≥rf
);

76 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ga˝i_≥rf_d©a
;

78 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
;

80 
	ga˝i_p°©e_°ri˘
;

82 
	$check_e°_˝u
(
˝uid
)

84 
˝uöfo_x86
 *
˝u
 = &
	`˝u_d©a
(
˝uid
);

86  
	`˝u_has
(
˝u
, 
X86_FEATURE_EST
);

87 
	}
}

89 
	$exåa˘_io
(
u32
 
vÆue
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

91 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

92 
i
;

94 
≥rf
 = 
d©a
->
a˝i_d©a
;

96 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

97 i‡(
vÆue
 =
≥rf
->
°©es
[
i
].
°©us
)

98  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

101 
	}
}

103 
	$exåa˘_m§
(
u32
 
m§
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

105 
i
;

106 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

108 
m§
 &
INTEL_MSR_RANGE
;

109 
≥rf
 = 
d©a
->
a˝i_d©a
;

111 
i
 = 0; 
d©a
->
‰eq_èbÀ
[i].
‰equícy
 !
CPUFREQ_TABLE_END
; i++) {

112 i‡(
m§
 =
≥rf
->
°©es
[
d©a
->
‰eq_èbÀ
[
i
].
ödex
].
°©us
)

113  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

115  
d©a
->
‰eq_èbÀ
[0].
‰equícy
;

116 
	}
}

118 
	$exåa˘_‰eq
(
u32
 
vÆ
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

120 
d©a
->
˝u_„©uª
) {

121 
SYSTEM_INTEL_MSR_CAPABLE
:

122  
	`exåa˘_m§
(
vÆ
, 
d©a
);

123 
SYSTEM_IO_CAPABLE
:

124  
	`exåa˘_io
(
vÆ
, 
d©a
);

128 
	}
}

130 
	sm§_addr
 {

131 
u32
 
	mªg
;

134 
	sio_addr
 {

135 
u16
 
	mp‹t
;

136 
u8
 
	mbô_width
;

139 
	sdrv_cmd
 {

140 
	mty≥
;

141 c⁄° 
˝umask
 *
	mmask
;

143 
m§_addr
 
	mm§
;

144 
io_addr
 
	mio
;

145 } 
	maddr
;

146 
u32
 
	mvÆ
;

150 
	$do_drv_ªad
(*
_cmd
)

152 
drv_cmd
 *
cmd
 = 
_cmd
;

153 
u32
 
h
;

155 
cmd
->
ty≥
) {

156 
SYSTEM_INTEL_MSR_CAPABLE
:

157 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, cmd->
vÆ
, 
h
);

159 
SYSTEM_IO_CAPABLE
:

160 
	`a˝i_os_ªad_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

161 &
cmd
->
vÆ
,

162 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

167 
	}
}

170 
	$do_drv_wrôe
(*
_cmd
)

172 
drv_cmd
 *
cmd
 = 
_cmd
;

173 
u32
 
lo
, 
hi
;

175 
cmd
->
ty≥
) {

176 
SYSTEM_INTEL_MSR_CAPABLE
:

177 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

178 
lo
 = (lÿ& ~
INTEL_MSR_RANGE
Ë| (
cmd
->
vÆ
 & INTEL_MSR_RANGE);

179 
	`wrm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

181 
SYSTEM_IO_CAPABLE
:

182 
	`a˝i_os_wrôe_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

183 
cmd
->
vÆ
,

184 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

189 
	}
}

191 
	$drv_ªad
(
drv_cmd
 *
cmd
)

193 
îr
;

194 
cmd
->
vÆ
 = 0;

196 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_™y
(
cmd
->
mask
, 
do_drv_ªad
, cmd, 1);

197 
	`WARN_ON_ONCE
(
îr
);

198 
	}
}

200 
	$drv_wrôe
(
drv_cmd
 *
cmd
)

202 
this_˝u
;

204 
this_˝u
 = 
	`gë_˝u
();

205 i‡(
	`˝umask_ã°_˝u
(
this_˝u
, 
cmd
->
mask
))

206 
	`do_drv_wrôe
(
cmd
);

207 
	`smp_ˇŒ_fun˘i⁄_m™y
(
cmd
->
mask
, 
do_drv_wrôe
, cmd, 1);

208 
	`put_˝u
();

209 
	}
}

211 
u32
 
	$gë_cur_vÆ
(c⁄° 
˝umask
 *
mask
)

213 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

214 
drv_cmd
 
cmd
;

216 i‡(
	`u∆ikñy
(
	`˝umask_em±y
(
mask
)))

219 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
˝u_„©uª
) {

220 
SYSTEM_INTEL_MSR_CAPABLE
:

221 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

222 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_STATUS
;

224 
SYSTEM_IO_CAPABLE
:

225 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

226 
≥rf
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
a˝i_d©a
;

227 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

228 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

234 
cmd
.
mask
 = mask;

235 
	`drv_ªad
(&
cmd
);

237 
	`d¥ötk
("gë_cur_vÆ = %u\n", 
cmd
.
vÆ
);

239  
cmd
.
vÆ
;

240 
	}
}

243 
	$ªad_mósuªd_≥rf_˘rs
(*
_cur
)

245 
≠îfm≥rf
 *
am
 = 
_cur
;

247 
	`gë_≠îfm≥rf
(
am
);

248 
	}
}

263 
	$gë_mósuªd_≥rf
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

264 
˝u
)

266 
≠îfm≥rf
 
≥rf
;

267 
øtio
;

268 
ªtvÆ
;

270 i‡(
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
ªad_mósuªd_≥rf_˘rs
, &
≥rf
, 1))

273 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(&
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
), &
≥rf
);

274 
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
Ë
≥rf
;

276 
ªtvÆ
 = (
pﬁicy
->
˝uöfo
.
max_‰eq
 * 
øtio
Ë>> 
APERFMPERF_SHIFT
;

278  
ªtvÆ
;

279 
	}
}

281 
	$gë_cur_‰eq_⁄_˝u
(
˝u
)

283 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
);

284 
‰eq
;

285 
ˇched_‰eq
;

287 
	`d¥ötk
("gë_cur_‰eq_⁄_˝u (%d)\n", 
˝u
);

289 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

290 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

294 
ˇched_‰eq
 = 
d©a
->
‰eq_èbÀ
[d©a->
a˝i_d©a
->
°©e
].
‰equícy
;

295 
‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
	`˝umask_of
(
˝u
)), 
d©a
);

296 i‡(
‰eq
 !
ˇched_‰eq
) {

301 
d©a
->
ªsume
 = 1;

304 
	`d¥ötk
("cu∏‰eq = %u\n", 
‰eq
);

306  
‰eq
;

307 
	}
}

309 
	$check_‰eqs
(c⁄° 
˝umask
 *
mask
, 
‰eq
,

310 
a˝i_˝u‰eq_d©a
 *
d©a
)

312 
cur_‰eq
;

313 
i
;

315 
i
 = 0; i < 100; i++) {

316 
cur_‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
mask
), 
d©a
);

317 i‡(
cur_‰eq
 =
‰eq
)

319 
	`udñay
(10);

322 
	}
}

324 
	$a˝i_˝u‰eq_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

325 
èrgë_‰eq
, 
ªœti⁄
)

327 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

328 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

329 
˝u‰eq_‰eqs
 
‰eqs
;

330 
drv_cmd
 
cmd
;

331 
√xt_°©e
 = 0;

332 
√xt_≥rf_°©e
 = 0;

333 
i
;

334 
ªsu…
 = 0;

336 
	`d¥ötk
("a˝i_˝u‰eq_èrgë %d (%d)\n", 
èrgë_‰eq
, 
pﬁicy
->
˝u
);

338 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

339 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

340  -
ENODEV
;

343 
≥rf
 = 
d©a
->
a˝i_d©a
;

344 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_èrgë
(
pﬁicy
,

345 
d©a
->
‰eq_èbÀ
,

346 
èrgë_‰eq
,

347 
ªœti⁄
, &
√xt_°©e
);

348 i‡(
	`u∆ikñy
(
ªsu…
)) {

349 
ªsu…
 = -
ENODEV
;

350 
out
;

353 
√xt_≥rf_°©e
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
ödex
;

354 i‡(
≥rf
->
°©e
 =
√xt_≥rf_°©e
) {

355 i‡(
	`u∆ikñy
(
d©a
->
ªsume
)) {

356 
	`d¥ötk
("CalledáfterÑesume,ÑesettingÅo P%d\n",

357 
√xt_≥rf_°©e
);

358 
d©a
->
ªsume
 = 0;

360 
	`d¥ötk
("AlreadyátÅarget state (P%d)\n",

361 
√xt_≥rf_°©e
);

362 
out
;

366 
	`åa˚_powî_‰equícy
(
POWER_PSTATE
, 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
);

368 
d©a
->
˝u_„©uª
) {

369 
SYSTEM_INTEL_MSR_CAPABLE
:

370 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

371 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_CTL
;

372 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

374 
SYSTEM_IO_CAPABLE
:

375 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

376 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

377 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

378 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

381 
ªsu…
 = -
ENODEV
;

382 
out
;

386 i‡(
pﬁicy
->
sh¨ed_ty≥
 !
CPUFREQ_SHARED_TYPE_ANY
)

387 
cmd
.
mask
 = 
pﬁicy
->
˝us
;

389 
cmd
.
mask
 = 
	`˝umask_of
(
pﬁicy
->
˝u
);

391 
‰eqs
.
ﬁd
 = 
≥rf
->
°©es
[≥rf->
°©e
].
c‹e_‰equícy
 * 1000;

392 
‰eqs
.
√w
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
;

393 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

394 
‰eqs
.
˝u
 = 
i
;

395 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

398 
	`drv_wrôe
(&
cmd
);

400 i‡(
a˝i_p°©e_°ri˘
) {

401 i‡(!
	`check_‰eqs
(
cmd
.
mask
, 
‰eqs
.
√w
, 
d©a
)) {

402 
	`d¥ötk
("acpi_cpufreq_target failed (%d)\n",

403 
pﬁicy
->
˝u
);

404 
ªsu…
 = -
EAGAIN
;

405 
out
;

409 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

410 
‰eqs
.
˝u
 = 
i
;

411 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

413 
≥rf
->
°©e
 = 
√xt_≥rf_°©e
;

415 
out
:

416  
ªsu…
;

417 
	}
}

419 
	$a˝i_˝u‰eq_vîify
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

421 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

423 
	`d¥ötk
("acpi_cpufreq_verify\n");

425  
	`˝u‰eq_‰equícy_èbÀ_vîify
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

426 
	}
}

429 
	$a˝i_˝u‰eq_guess_‰eq
(
a˝i_˝u‰eq_d©a
 *
d©a
, 
˝u
)

431 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
 = 
d©a
->
a˝i_d©a
;

433 i‡(
˝u_khz
) {

435 
i
;

436 
‰eq
;

437 
‰eqn
 = 
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

439 
i
 = 0; i < (
≥rf
->
°©e_cou¡
-1); i++) {

440 
‰eq
 = 
‰eqn
;

441 
‰eqn
 = 
≥rf
->
°©es
[
i
+1].
c‹e_‰equícy
 * 1000;

442 i‡((2 * 
˝u_khz
Ë> (
‰eqn
 + 
‰eq
)) {

443 
≥rf
->
°©e
 = 
i
;

444  
‰eq
;

447 
≥rf
->
°©e
 =Öîf->
°©e_cou¡
-1;

448  
‰eqn
;

451 
≥rf
->
°©e
 = 0;

452  
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

454 
	}
}

456 
	$‰ì_a˝i_≥rf_d©a
()

458 
i
;

461 
	`f‹_óch_possibÀ_˝u
(
i
)

462 
	`‰ì_˝umask_v¨
(
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)

463 ->
sh¨ed_˝u_m≠
);

464 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

465 
	}
}

475 
__öô
 
	$a˝i_˝u‰eq_óæy_öô
()

477 
i
;

478 
	`d¥ötk
("acpi_cpufreq_early_init\n");

480 
a˝i_≥rf_d©a
 = 
	`Æloc_≥r˝u
(
a˝i_¥o˚ss‹_≥rf‹m™˚
);

481 i‡(!
a˝i_≥rf_d©a
) {

482 
	`d¥ötk
("MemoryállocationÉrror forácpi_perf_data.\n");

483  -
ENOMEM
;

485 
	`f‹_óch_possibÀ_˝u
(
i
) {

486 i‡(!
	`zÆloc_˝umask_v¨_node
(

487 &
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)->
sh¨ed_˝u_m≠
,

488 
GFP_KERNEL
, 
	`˝u_to_node
(
i
))) {

491 
	`‰ì_a˝i_≥rf_d©a
();

492  -
ENOMEM
;

497 
	`a˝i_¥o˚ss‹_¥îegi°î_≥rf‹m™˚
(
a˝i_≥rf_d©a
);

499 
	}
}

501 #ifde‡
CONFIG_SMP


508 
	gbios_wôh_sw_™y_bug
;

510 
	$sw_™y_bug_found
(c⁄° 
dmi_sy°em_id
 *
d
)

512 
bios_wôh_sw_™y_bug
 = 1;

514 
	}
}

516 c⁄° 
dmi_sy°em_id
 
	gsw_™y_bug_dmi_èbÀ
[] = {

518 .
ˇŒback
 = 
sw_™y_bug_found
,

519 .
	gidít
 = "Supermicro Server X6DLP",

520 .
	gm©ches
 = {

521 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

522 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

523 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

529 
	$a˝i_˝u‰eq_bœckli°
(
˝uöfo_x86
 *
c
)

536 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

537 i‡((
c
->
x86
 == 15) &&

538 (
c
->
x86_modñ
 == 6) &&

539 (
c
->
x86_mask
 == 8)) {

540 
	`¥ötk
(
KERN_INFO
 "acpi-cpufreq: Intel(R) "

544  -
ENODEV
;

548 
	}
}

551 
	$a˝i_˝u‰eq_˝u_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

553 
i
;

554 
vÆid_°©es
 = 0;

555 
˝u
 = 
pﬁicy
->cpu;

556 
a˝i_˝u‰eq_d©a
 *
d©a
;

557 
ªsu…
 = 0;

558 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
pﬁicy
->
˝u
);

559 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

560 #ifde‡
CONFIG_SMP


561 
bœckli°ed
;

564 
	`d¥ötk
("acpi_cpufreq_cpu_init\n");

566 #ifde‡
CONFIG_SMP


567 i‡(
bœckli°ed
)

568  
bœckli°ed
;

569 
bœckli°ed
 = 
	`a˝i_˝u‰eq_bœckli°
(
c
);

570 i‡(
bœckli°ed
)

571  
bœckli°ed
;

574 
d©a
 = 
	`kzÆloc
((
a˝i_˝u‰eq_d©a
), 
GFP_KERNEL
);

575 i‡(!
d©a
)

576  -
ENOMEM
;

578 
d©a
->
a˝i_d©a
 = 
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
˝u
);

579 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
d©a
;

581 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

582 
a˝i_˝u‰eq_drivî
.
Êags
 |
CPUFREQ_CONST_LOOPS
;

584 
ªsu…
 = 
	`a˝i_¥o˚ss‹_ªgi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
, 
˝u
);

585 i‡(
ªsu…
)

586 
îr_‰ì
;

588 
≥rf
 = 
d©a
->
a˝i_d©a
;

589 
pﬁicy
->
sh¨ed_ty≥
 = 
≥rf
->shared_type;

595 i‡(
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ALL
 ||

596 
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ANY
) {

597 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

599 
	`˝umask_c›y
(
pﬁicy
->
ªœãd_˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

601 #ifde‡
CONFIG_SMP


602 
	`dmi_check_sy°em
(
sw_™y_bug_dmi_èbÀ
);

603 i‡(
bios_wôh_sw_™y_bug
 && 
	`˝umask_weight
(
pﬁicy
->
˝us
) == 1) {

604 
pﬁicy
->
sh¨ed_ty≥
 = 
CPUFREQ_SHARED_TYPE_ALL
;

605 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

610 i‡(
≥rf
->
°©e_cou¡
 <= 1) {

611 
	`d¥ötk
("No P-States\n");

612 
ªsu…
 = -
ENODEV
;

613 
îr_uƒeg
;

616 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 !≥rf->
°©us_ªgi°î
.space_id) {

617 
ªsu…
 = -
ENODEV
;

618 
îr_uƒeg
;

621 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

622 
ACPI_ADR_SPACE_SYSTEM_IO
:

623 
	`d¥ötk
("SYSTEM IOáddr space\n");

624 
d©a
->
˝u_„©uª
 = 
SYSTEM_IO_CAPABLE
;

626 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

627 
	`d¥ötk
("HARDWAREáddr space\n");

628 i‡(!
	`check_e°_˝u
(
˝u
)) {

629 
ªsu…
 = -
ENODEV
;

630 
îr_uƒeg
;

632 
d©a
->
˝u_„©uª
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

635 
	`d¥ötk
("Unknownáddr space %d\n",

636 (
u32
Ë(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
));

637 
ªsu…
 = -
ENODEV
;

638 
îr_uƒeg
;

641 
d©a
->
‰eq_èbÀ
 = 
	`kmÆloc
((
˝u‰eq_‰equícy_èbÀ
) *

642 (
≥rf
->
°©e_cou¡
+1), 
GFP_KERNEL
);

643 i‡(!
d©a
->
‰eq_èbÀ
) {

644 
ªsu…
 = -
ENOMEM
;

645 
îr_uƒeg
;

649 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 0;

650 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

651 i‡((
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000) >

652 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
)

653 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 =

654 
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000;

658 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 =
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

659 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 > 20 * 1000) {

660 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 20 * 1000;

661 
	`¥ötk_⁄˚
(
KERN_INFO


666 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

667 i‡(
i
 > 0 && 
≥rf
->
°©es
[i].
c‹e_‰equícy
 >=

668 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
-1].
‰equícy
 / 1000)

671 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
ödex
 = 
i
;

672 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 =

673 
≥rf
->
°©es
[
i
].
c‹e_‰equícy
 * 1000;

674 
vÆid_°©es
++;

676 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 = 
CPUFREQ_TABLE_END
;

677 
≥rf
->
°©e
 = 0;

679 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_˝uöfo
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

680 i‡(
ªsu…
)

681 
îr_‰eq‰ì
;

683 i‡(
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000 !
pﬁicy
->
˝uöfo
.
max_‰eq
)

684 
	`¥ötk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 isÇot max freq\n");

686 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

687 
ACPI_ADR_SPACE_SYSTEM_IO
:

689 
pﬁicy
->
cur
 = 
	`a˝i_˝u‰eq_guess_‰eq
(
d©a
,Öﬁicy->
˝u
);

691 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

692 
a˝i_˝u‰eq_drivî
.
gë
 = 
gë_cur_‰eq_⁄_˝u
;

693 
pﬁicy
->
cur
 = 
	`gë_cur_‰eq_⁄_˝u
(
˝u
);

700 
	`a˝i_¥o˚ss‹_nŸify_smm
(
THIS_MODULE
);

703 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_APERFMPERF
))

704 
a˝i_˝u‰eq_drivî
.
gëavg
 = 
gë_mósuªd_≥rf
;

706 
	`d¥ötk
("CPU%u - ACPIÖîf‹m™˚ m™agemíàa˘iv©ed.\n", 
˝u
);

707 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++)

708 
	`d¥ötk
(" %cP%d: %d MHz, %d mW, %d uS\n",

709 (
i
 =
≥rf
->
°©e
 ? '*' : ' '), i,

710 (
u32
Ë
≥rf
->
°©es
[
i
].
c‹e_‰equícy
,

711 (
u32
Ë
≥rf
->
°©es
[
i
].
powî
,

712 (
u32
Ë
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
);

714 
	`˝u‰eq_‰equícy_èbÀ_gë_©å
(
d©a
->
‰eq_èbÀ
, 
pﬁicy
->
˝u
);

720 
d©a
->
ªsume
 = 1;

722  
ªsu…
;

724 
îr_‰eq‰ì
:

725 
	`k‰ì
(
d©a
->
‰eq_èbÀ
);

726 
îr_uƒeg
:

727 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
≥rf
, 
˝u
);

728 
îr_‰ì
:

729 
	`k‰ì
(
d©a
);

730 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
NULL
;

732  
ªsu…
;

733 
	}
}

735 
	$a˝i_˝u‰eq_˝u_exô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

737 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

739 
	`d¥ötk
("acpi_cpufreq_cpu_exit\n");

741 i‡(
d©a
) {

742 
	`˝u‰eq_‰equícy_èbÀ_put_©å
(
pﬁicy
->
˝u
);

743 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
Ë
NULL
;

744 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
,

745 
pﬁicy
->
˝u
);

746 
	`k‰ì
(
d©a
);

750 
	}
}

752 
	$a˝i_˝u‰eq_ªsume
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

754 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

756 
	`d¥ötk
("acpi_cpufreq_resume\n");

758 
d©a
->
ªsume
 = 1;

761 
	}
}

763 
‰eq_©å
 *
	ga˝i_˝u‰eq_©å
[] = {

764 &
˝u‰eq_‰eq_©å_sˇlög_avaûabÀ_‰eqs
,

765 
NULL
,

768 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
 = {

769 .
vîify
 = 
a˝i_˝u‰eq_vîify
,

770 .
	gèrgë
 = 
a˝i_˝u‰eq_èrgë
,

771 .
	gbios_limô
 = 
a˝i_¥o˚ss‹_gë_bios_limô
,

772 .
	göô
 = 
a˝i_˝u‰eq_˝u_öô
,

773 .
	gexô
 = 
a˝i_˝u‰eq_˝u_exô
,

774 .
	gªsume
 = 
a˝i_˝u‰eq_ªsume
,

775 .
	g«me
 = "acpi-cpufreq",

776 .
	gow√r
 = 
THIS_MODULE
,

777 .
	g©å
 = 
a˝i_˝u‰eq_©å
,

780 
__öô
 
	$a˝i_˝u‰eq_öô
()

782 
ªt
;

784 i‡(
a˝i_dißbÀd
)

787 
	`d¥ötk
("acpi_cpufreq_init\n");

789 
ªt
 = 
	`a˝i_˝u‰eq_óæy_öô
();

790 i‡(
ªt
)

791  
ªt
;

793 
ªt
 = 
	`˝u‰eq_ªgi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

794 i‡(
ªt
)

795 
	`‰ì_a˝i_≥rf_d©a
();

797  
ªt
;

798 
	}
}

800 
__exô
 
	$a˝i_˝u‰eq_exô
()

802 
	`d¥ötk
("acpi_cpufreq_exit\n");

804 
	`˝u‰eq_uƒegi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

806 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

807 
	}
}

809 
moduÀ_∑øm
(
a˝i_p°©e_°ri˘
, 
uöt
, 0644);

810 
MODULE_PARM_DESC
(
a˝i_p°©e_°ri˘
,

814 
œã_öôˇŒ
(
a˝i_˝u‰eq_öô
);

815 
moduÀ_exô
(
a˝i_˝u‰eq_exô
);

817 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/vmw¨e.h
>

26 
	~<asm/hy≥rvis‹.h
>

28 
ölöe
 
__˝uöô


29 
	$dëe˘_hy≥rvis‹_víd‹
(
˝uöfo_x86
 *
c
)

31 i‡(
	`vmw¨e_∂©f‹m
())

32 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_VMWARE
;

34 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_NONE
;

35 
	}
}

37 
ölöe
 
__˝uöô


38 
	$hy≥rvis‹_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

40 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
) {

41 
	`vmw¨e_£t_„©uª_bôs
(
c
);

44 
	}
}

46 
__˝uöô
 
	$öô_hy≥rvis‹
(
˝uöfo_x86
 *
c
)

48 
	`dëe˘_hy≥rvis‹_víd‹
(
c
);

49 
	`hy≥rvis‹_£t_„©uª_bôs
(
c
);

50 
	}
}

52 
__öô
 
	$öô_hy≥rvis‹_∂©f‹m
()

54 
	`öô_hy≥rvis‹
(&
boŸ_˝u_d©a
);

55 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
)

56 
	`vmw¨e_∂©f‹m_£tup
();

57 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<löux/öô.h
>

2 
	~<löux/kî√l.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/bô›s.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/thªad_öfo.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/uac˚ss.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/pgèbÀ.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/ds.h
>

16 
	~<asm/bugs.h
>

17 
	~<asm/˝u.h
>

19 #ifde‡
CONFIG_X86_64


20 
	~<löux/t›ﬁogy.h
>

21 
	~<asm/numa_64.h
>

24 
	~"˝u.h
"

26 #ifde‡
CONFIG_X86_LOCAL_APIC


27 
	~<asm/mp•ec.h
>

28 
	~<asm/≠ic.h
>

31 
__˝uöô
 
	$óæy_öô_öãl
(
˝uöfo_x86
 *
c
)

34 i‡(
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xd)) {

35 
u64
 
misc_íabÀ
;

37 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

39 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

40 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

41 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

42 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

46 i‡((
c
->
x86
 =0x‡&& c->
x86_modñ
 >= 0x03) ||

47 (
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0x0e))

48 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

50 #ifde‡
CONFIG_X86_64


51 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

54 i‡(
c
->
x86
 =15 && c->
x86_ˇche_Æignmít
 == 64)

55 
c
->
x86_ˇche_Æignmít
 = 128;

59 i‡(
c
->
x86
 =0xF && c->
x86_modñ
 == 0x3

60 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

61 
c
->
x86_phys_bôs
 = 36;

70 i‡(
c
->
x86_powî
 & (1 << 8)) {

71 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

72 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

73 
sched_˛ock_°abÀ
 = 1;

86 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 15)

87 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PAT
);

89 #ifde‡
CONFIG_KMEMCHECK


98 i‡(
c
->
x86
 == 15) {

99 
u64
 
misc_íabÀ
;

101 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

103 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_FAST_STRING
) {

104 
	`¥ötk
(
KERN_INFO
 "kmemcheck: Disabling fast string operations\n");

106 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_FAST_STRING
;

107 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

111 
	}
}

113 #ifde‡
CONFIG_X86_32


120 
__˝uöô
 
	$µro_wôh_øm_bug
()

123 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

124 
boŸ_˝u_d©a
.
x86
 == 6 &&

125 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

126 
boŸ_˝u_d©a
.
x86_mask
 < 8) {

127 
	`¥ötk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. TakingÉvasiveáction.\n");

131 
	}
}

133 #ifde‡
CONFIG_X86_F00F_BUG


134 
__˝uöô
 
	$å≠_öô_f00f_bug
()

136 
	`__£t_fixm≠
(
FIX_F00F_IDT
, 
	`__∑
(&
idt_èbÀ
), 
PAGE_KERNEL_RO
);

142 
idt_des¸
.
addªss
 = 
	`fix_to_vút
(
FIX_F00F_IDT
);

143 
	`lﬂd_idt
(&
idt_des¸
);

144 
	}
}

147 
__˝uöô
 
	$öãl_smp_check
(
˝uöfo_x86
 *
c
)

149 #ifde‡
CONFIG_SMP


151 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

157 i‡(
c
->
x86
 == 5 &&

158 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

159 
c
->
x86_modñ
 <= 3) {

163 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

167 
	}
}

169 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

171 
lo
, 
hi
;

173 #ifde‡
CONFIG_X86_F00F_BUG


180 
c
->
f00f_bug
 = 0;

181 i‡(!
	`∑øvút_íabÀd
(Ë&& 
c
->
x86
 == 5) {

182 
f00f_w‹k¨ound_íabÀd
;

184 
c
->
f00f_bug
 = 1;

185 i‡(!
f00f_w‹k¨ound_íabÀd
) {

186 
	`å≠_öô_f00f_bug
();

187 
	`¥ötk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundÉnabled.\n");

188 
f00f_w‹k¨ound_íabÀd
 = 1;

197 i‡((
c
->
x86
<<8 | c->
x86_modñ
<<4 | c->
x86_mask
) < 0x633)

198 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_SEP
);

204 i‡((
c
->
x86
 =15Ë&& (c->
x86_modñ
 =1Ë&& (c->
x86_mask
 == 1)) {

205 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

206 i‡((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

207 
	`¥ötk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

208 
	`¥ötk
 (
KERN_INFO
 "CPU: Disabling hardwareÖrefetching (Errata 037)\n");

209 
lo
 |
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

210 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

220 i‡(
˝u_has_≠ic
 && (
c
->
x86
<<8 | c->
x86_modñ
<<4) == 0x520 &&

221 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

222 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_11AP
);

225 #ifde‡
CONFIG_X86_INTEL_USERCOPY


229 
c
->
x86
) {

235 
mov¶_mask
.
mask
 = 7;

238 
mov¶_mask
.
mask
 = 7;

243 #ifde‡
CONFIG_X86_NUMAQ


244 
	`numaq_tsc_dißbÀ
();

247 
	`öãl_smp_check
(
c
);

248 
	}
}

250 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

252 
	}
}

255 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

257 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

258 
node
;

259 
˝u
 = 
	`smp_¥o˚ss‹_id
();

260 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

264 
node
 = 
≠icid_to_node
[
≠icid
];

265 i‡(
node
 =
NUMA_NO_NODE
)

266 
node
 = 
	`fú°_node
(
node_⁄löe_m≠
);

267 i‡(!
	`node_⁄löe
(
node
)) {

269 
node
 = 
	`˝u_to_node
(
˝u
);

271 
	`numa_£t_node
(
˝u
, 
node
);

273 
	}
}

278 
__˝uöô
 
	$öãl_num_˝u_c‹es
(
˝uöfo_x86
 *
c
)

280 
óx
, 
ebx
, 
ecx
, 
edx
;

282 i‡(
c
->
˝uid_Àvñ
 < 4)

286 
	`˝uid_cou¡
(4, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

287 i‡(
óx
 & 0x1f)

288  (
óx
 >> 26) + 1;

291 
	}
}

293 
__˝uöô
 
	$dëe˘_vmx_vútˇp
(
˝uöfo_x86
 *
c
)

296 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

297 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

298 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

299 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

300 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

301 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

303 
u32
 
vmx_m§_low
, 
vmx_m§_high
, 
m§_˘l
, 
m§_˘l2
;

305 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

306 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

307 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

308 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

309 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

311 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m§_low
, 
vmx_m§_high
);

312 
m§_˘l
 = 
vmx_m§_high
 | 
vmx_m§_low
;

313 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

314 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

315 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

316 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

317 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

318 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

319 
vmx_m§_low
, 
vmx_m§_high
);

320 
m§_˘l2
 = 
vmx_m§_high
 | 
vmx_m§_low
;

321 i‡((
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

322 (
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

323 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

324 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

325 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

326 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

329 
	}
}

331 
__˝uöô
 
	$öô_öãl
(
˝uöfo_x86
 *
c
)

333 
l2
 = 0;

335 
	`óæy_öô_öãl
(
c
);

337 
	`öãl_w‹k¨ounds
(
c
);

344 
	`dëe˘_exãnded_t›ﬁogy
(
c
);

346 
l2
 = 
	`öô_öãl_ˇcheöfo
(
c
);

347 i‡(
c
->
˝uid_Àvñ
 > 9) {

348 
óx
 = 
	`˝uid_óx
(10);

350 i‡((
óx
 & 0xff) && (((eax>>8) & 0xff) > 1))

351 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

354 i‡(
c
->
˝uid_Àvñ
 > 6) {

355 
ecx
 = 
	`˝uid_ecx
(6);

356 i‡(
ecx
 & 0x01)

357 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_APERFMPERF
);

360 i‡(
˝u_has_xmm2
)

361 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

362 i‡(
˝u_has_ds
) {

363 
l1
;

364 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

365 i‡(!(
l1
 & (1<<11)))

366 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_BTS
);

367 i‡(!(
l1
 & (1<<12)))

368 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PEBS
);

369 
	`ds_öô_öãl
(
c
);

372 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =29 && 
˝u_has_˛Êush
)

373 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

375 #ifde‡
CONFIG_X86_64


376 i‡(
c
->
x86
 == 15)

377 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

378 i‡(
c
->
x86
 == 6)

379 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

386 i‡(
c
->
x86
 == 6) {

387 *
p
 = 
NULL
;

389 
c
->
x86_modñ
) {

391 i‡(
c
->
x86_mask
 == 0) {

392 i‡(
l2
 == 0)

393 
p
 = "Celeron (Covington)";

394 i‡(
l2
 == 256)

395 
p
 = "Mobile Pentium II (Dixon)";

400 i‡(
l2
 == 128)

401 
p
 = "Celeron (Mendocino)";

402 i‡(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

403 
p
 = "Celeron-A";

407 i‡(
l2
 == 128)

408 
p
 = "Celeron (Coppermine)";

412 i‡(
p
)

413 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

416 i‡(
c
->
x86
 == 15)

417 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P4
);

418 i‡(
c
->
x86
 == 6)

419 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P3
);

422 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

427 
c
->
x86_max_c‹es
 = 
	`öãl_num_˝u_c‹es
(c);

428 #ifde‡
CONFIG_X86_32


429 
	`dëe˘_ht
(
c
);

434 
	`§©_dëe˘_node
(
c
);

436 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_VMX
))

437 
	`dëe˘_vmx_vútˇp
(
c
);

438 
	}
}

440 #ifde‡
CONFIG_X86_32


441 
__˝uöô
 
	$öãl_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

449 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 =11Ë&& (
size
 == 0))

450 
size
 = 256;

451  
size
;

452 
	}
}

455 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	göãl_˝u_dev
 = {

456 .
c_víd‹
 = "Intel",

457 .
	gc_idít
 = { "GenuineIntel" },

458 #ifde‡
CONFIG_X86_32


459 .
	gc_modñs
 = {

460 { .
víd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

473 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 5, .
	gmodñ_«mes
 =

484 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 6, .
	gmodñ_«mes
 =

498 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 15, .
	gmodñ_«mes
 =

508 .
	gc_size_ˇche
 = 
öãl_size_ˇche
,

510 .
	gc_óæy_öô
 = 
óæy_öô_öãl
,

511 .
	gc_öô
 = 
öô_öãl
,

512 .
	gc_x86_víd‹
 = 
X86_VENDOR_INTEL
,

515 
˝u_dev_ªgi°î
(
öãl_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<löux/öô.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/˝u.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<löux/smp.h
>

20 
	~<asm/k8.h
>

22 
	#LVL_1_INST
 1

	)

23 
	#LVL_1_DATA
 2

	)

24 
	#LVL_2
 3

	)

25 
	#LVL_3
 4

	)

26 
	#LVL_TRACE
 5

	)

28 
	s_ˇche_èbÀ
 {

29 
	mdes¸ùt‹
;

30 
	mˇche_ty≥
;

31 
	msize
;

37 c⁄° 
_ˇche_èbÀ
 
__˝uöôc⁄°
 
	gˇche_èbÀ
[] =

39 { 0x06, 
LVL_1_INST
, 8 },

40 { 0x08, 
LVL_1_INST
, 16 },

41 { 0x09, 
LVL_1_INST
, 32 },

42 { 0x0a, 
LVL_1_DATA
, 8 },

43 { 0x0c, 
LVL_1_DATA
, 16 },

44 { 0x0d, 
LVL_1_DATA
, 16 },

45 { 0x21, 
LVL_2
, 256 },

46 { 0x22, 
LVL_3
, 512 },

47 { 0x23, 
LVL_3
, 1024 },

48 { 0x25, 
LVL_3
, 2048 },

49 { 0x29, 
LVL_3
, 4096 },

50 { 0x2c, 
LVL_1_DATA
, 32 },

51 { 0x30, 
LVL_1_INST
, 32 },

52 { 0x39, 
LVL_2
, 128 },

53 { 0x3a, 
LVL_2
, 192 },

54 { 0x3b, 
LVL_2
, 128 },

55 { 0x3c, 
LVL_2
, 256 },

56 { 0x3d, 
LVL_2
, 384 },

57 { 0x3e, 
LVL_2
, 512 },

58 { 0x3f, 
LVL_2
, 256 },

59 { 0x41, 
LVL_2
, 128 },

60 { 0x42, 
LVL_2
, 256 },

61 { 0x43, 
LVL_2
, 512 },

62 { 0x44, 
LVL_2
, 1024 },

63 { 0x45, 
LVL_2
, 2048 },

64 { 0x46, 
LVL_3
, 4096 },

65 { 0x47, 
LVL_3
, 8192 },

66 { 0x49, 
LVL_3
, 4096 },

67 { 0x4a, 
LVL_3
, 6144 },

68 { 0x4b, 
LVL_3
, 8192 },

69 { 0x4c, 
LVL_3
, 12288 },

70 { 0x4d, 
LVL_3
, 16384 },

71 { 0x4e, 
LVL_2
, 6144 },

72 { 0x60, 
LVL_1_DATA
, 16 },

73 { 0x66, 
LVL_1_DATA
, 8 },

74 { 0x67, 
LVL_1_DATA
, 16 },

75 { 0x68, 
LVL_1_DATA
, 32 },

76 { 0x70, 
LVL_TRACE
, 12 },

77 { 0x71, 
LVL_TRACE
, 16 },

78 { 0x72, 
LVL_TRACE
, 32 },

79 { 0x73, 
LVL_TRACE
, 64 },

80 { 0x78, 
LVL_2
, 1024 },

81 { 0x79, 
LVL_2
, 128 },

82 { 0x7a, 
LVL_2
, 256 },

83 { 0x7b, 
LVL_2
, 512 },

84 { 0x7c, 
LVL_2
, 1024 },

85 { 0x7d, 
LVL_2
, 2048 },

86 { 0x7f, 
LVL_2
, 512 },

87 { 0x82, 
LVL_2
, 256 },

88 { 0x83, 
LVL_2
, 512 },

89 { 0x84, 
LVL_2
, 1024 },

90 { 0x85, 
LVL_2
, 2048 },

91 { 0x86, 
LVL_2
, 512 },

92 { 0x87, 
LVL_2
, 1024 },

93 { 0xd0, 
LVL_3
, 512 },

94 { 0xd1, 
LVL_3
, 1024 },

95 { 0xd2, 
LVL_3
, 2048 },

96 { 0xd6, 
LVL_3
, 1024 },

97 { 0xd7, 
LVL_3
, 2048 },

98 { 0xd8, 
LVL_3
, 4096 },

99 { 0xdc, 
LVL_3
, 2048 },

100 { 0xdd, 
LVL_3
, 4096 },

101 { 0xde, 
LVL_3
, 8192 },

102 { 0xe2, 
LVL_3
, 2048 },

103 { 0xe3, 
LVL_3
, 4096 },

104 { 0xe4, 
LVL_3
, 8192 },

105 { 0xó, 
LVL_3
, 12288 },

106 { 0xeb, 
LVL_3
, 18432 },

107 { 0xec, 
LVL_3
, 24576 },

112 
	e_ˇche_ty≥
 {

113 
	mCACHE_TYPE_NULL
 = 0,

114 
	mCACHE_TYPE_DATA
 = 1,

115 
	mCACHE_TYPE_INST
 = 2,

116 
	mCACHE_TYPE_UNIFIED
 = 3

119 
	u_˝uid4_Àaf_óx
 {

121 
_ˇche_ty≥
 
	mty≥
:5;

122 
	mÀvñ
:3;

123 
	mis_£lf_öôülizög
:1;

124 
	mis_fuŒy_assocütive
:1;

125 
	mª£rved
:4;

126 
	mnum_thªads_sh¨ög
:12;

127 
	mnum_c‹es_⁄_dõ
:6;

128 } 
	m•lô
;

129 
u32
 
	mfuŒ
;

132 
	u_˝uid4_Àaf_ebx
 {

134 
	mcohîícy_löe_size
:12;

135 
	mphysiˇl_löe_∑πôi⁄
:10;

136 
	mways_of_assocütivôy
:10;

137 } 
	m•lô
;

138 
u32
 
	mfuŒ
;

141 
	u_˝uid4_Àaf_ecx
 {

143 
	mnumbî_of_£ts
:32;

144 } 
	m•lô
;

145 
u32
 
	mfuŒ
;

148 
	s_˝uid4_öfo
 {

149 
_˝uid4_Àaf_óx
 
	móx
;

150 
_˝uid4_Àaf_ebx
 
	mebx
;

151 
_˝uid4_Àaf_ecx
 
	mecx
;

152 
	msize
;

153 
	mˇn_dißbÀ
;

154 
DECLARE_BITMAP
(
sh¨ed_˝u_m≠
, 
NR_CPUS
);

158 
	s_˝uid4_öfo_ªgs
 {

159 
_˝uid4_Àaf_óx
 
	móx
;

160 
_˝uid4_Àaf_ebx
 
	mebx
;

161 
_˝uid4_Àaf_ecx
 
	mecx
;

162 
	msize
;

163 
	mˇn_dißbÀ
;

166 
	gnum_ˇche_Àaves
;

174 
	ul1_ˇche
 {

176 
	mlöe_size
:8;

177 
	mlöes_≥r_èg
:8;

178 
	massoc
:8;

179 
	msize_ö_kb
:8;

181 
	mvÆ
;

184 
	ul2_ˇche
 {

186 
	mlöe_size
:8;

187 
	mlöes_≥r_èg
:4;

188 
	massoc
:4;

189 
	msize_ö_kb
:16;

191 
	mvÆ
;

194 
	ul3_ˇche
 {

196 
	mlöe_size
:8;

197 
	mlöes_≥r_èg
:4;

198 
	massoc
:4;

199 
	mªs
:2;

200 
	msize_ícoded
:14;

202 
	mvÆ
;

205 c⁄° 
__˝uöôc⁄°
 
	gassocs
[] = {

219 c⁄° 
__˝uöôc⁄°
 
	gÀvñs
[] = { 1, 1, 2, 3 };

220 c⁄° 
__˝uöôc⁄°
 
	gty≥s
[] = { 1, 2, 3, 3 };

222 
__˝uöô


223 
	$amd_˝uid4
(
Àaf
, 
_˝uid4_Àaf_óx
 *
óx
,

224 
_˝uid4_Àaf_ebx
 *
ebx
,

225 
_˝uid4_Àaf_ecx
 *
ecx
)

227 
dummy
;

228 
löe_size
, 
löes_≥r_èg
, 
assoc
, 
size_ö_kb
;

229 
l1_ˇche
 
l1i
, 
l1d
;

230 
l2_ˇche
 
l2
;

231 
l3_ˇche
 
l3
;

232 
l1_ˇche
 *
l1
 = &
l1d
;

234 
óx
->
fuŒ
 = 0;

235 
ebx
->
fuŒ
 = 0;

236 
ecx
->
fuŒ
 = 0;

238 
	`˝uid
(0x80000005, &
dummy
, &dummy, &
l1d
.
vÆ
, &
l1i
.val);

239 
	`˝uid
(0x80000006, &
dummy
, &dummy, &
l2
.
vÆ
, &
l3
.val);

241 
Àaf
) {

243 
l1
 = &
l1i
;

245 i‡(!
l1
->
vÆ
)

247 
assoc
 = 
assocs
[
l1
->assoc];

248 
löe_size
 = 
l1
->line_size;

249 
löes_≥r_èg
 = 
l1
->lines_per_tag;

250 
size_ö_kb
 = 
l1
->size_in_kb;

253 i‡(!
l2
.
vÆ
)

255 
assoc
 = 
assocs
[
l2
.assoc];

256 
löe_size
 = 
l2
.line_size;

257 
löes_≥r_èg
 = 
l2
.lines_per_tag;

259 
size_ö_kb
 = 
cuºít_˝u_d©a
.
x86_ˇche_size
;

262 i‡(!
l3
.
vÆ
)

264 
assoc
 = 
assocs
[
l3
.assoc];

265 
löe_size
 = 
l3
.line_size;

266 
löes_≥r_èg
 = 
l3
.lines_per_tag;

267 
size_ö_kb
 = 
l3
.
size_ícoded
 * 512;

268 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_AMD_DCM
)) {

269 
size_ö_kb
 = size_in_kb >> 1;

270 
assoc
 =ássoc >> 1;

277 
óx
->
•lô
.
is_£lf_öôülizög
 = 1;

278 
óx
->
•lô
.
ty≥
 = 
ty≥s
[
Àaf
];

279 
óx
->
•lô
.
Àvñ
 = 
Àvñs
[
Àaf
];

280 
óx
->
•lô
.
num_thªads_sh¨ög
 = 0;

281 
óx
->
•lô
.
num_c‹es_⁄_dõ
 = 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

284 i‡(
assoc
 == 0xffff)

285 
óx
->
•lô
.
is_fuŒy_assocütive
 = 1;

286 
ebx
->
•lô
.
cohîícy_löe_size
 = 
löe_size
 - 1;

287 
ebx
->
•lô
.
ways_of_assocütivôy
 = 
assoc
 - 1;

288 
ebx
->
•lô
.
physiˇl_löe_∑πôi⁄
 = 
löes_≥r_èg
 - 1;

289 
ecx
->
•lô
.
numbî_of_£ts
 = (
size_ö_kb
 * 1024Ë/ 
löe_size
 /

290 (
ebx
->
•lô
.
ways_of_assocütivôy
 + 1) - 1;

291 
	}
}

293 
__˝uöô


294 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

296 i‡(
ödex
 < 3)

299 i‡(
boŸ_˝u_d©a
.
x86
 == 0x11)

303 i‡((
boŸ_˝u_d©a
.
x86
 =0x10Ë&& (boŸ_˝u_d©a.
x86_modñ
 < 0x8))

306 
this_Àaf
->
ˇn_dißbÀ
 = 1;

307 
	}
}

310 
__˝uöô
 
	$˝uid4_ˇche_lookup_ªgs
(
ödex
,

311 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

313 
_˝uid4_Àaf_óx
 
óx
;

314 
_˝uid4_Àaf_ebx
 
ebx
;

315 
_˝uid4_Àaf_ecx
 
ecx
;

316 
edx
;

318 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) {

319 
	`amd_˝uid4
(
ödex
, &
óx
, &
ebx
, &
ecx
);

320 i‡(
boŸ_˝u_d©a
.
x86
 >= 0x10)

321 
	`amd_check_l3_dißbÀ
(
ödex
, 
this_Àaf
);

323 
	`˝uid_cou¡
(4, 
ödex
, &
óx
.
fuŒ
, &
ebx
.fuŒ, &
ecx
.fuŒ, &
edx
);

326 i‡(
óx
.
•lô
.
ty≥
 =
CACHE_TYPE_NULL
)

327  -
EIO
;

329 
this_Àaf
->
óx
 =Éax;

330 
this_Àaf
->
ebx
 =Ébx;

331 
this_Àaf
->
ecx
 =Écx;

332 
this_Àaf
->
size
 = (
ecx
.
•lô
.
numbî_of_£ts
 + 1) *

333 (
ebx
.
•lô
.
cohîícy_löe_size
 + 1) *

334 (
ebx
.
•lô
.
physiˇl_löe_∑πôi⁄
 + 1) *

335 (
ebx
.
•lô
.
ways_of_assocütivôy
 + 1);

337 
	}
}

339 
__˝uöô
 
	$föd_num_ˇche_Àaves
()

341 
óx
, 
ebx
, 
ecx
, 
edx
;

342 
_˝uid4_Àaf_óx
 
ˇche_óx
;

343 
i
 = -1;

346 ++
i
;

348 
	`˝uid_cou¡
(4, 
i
, &
óx
, &
ebx
, &
ecx
, &
edx
);

349 
ˇche_óx
.
fuŒ
 = 
óx
;

350 } 
ˇche_óx
.
•lô
.
ty≥
 !
CACHE_TYPE_NULL
);

351  
i
;

352 
	}
}

354 
__˝uöô
 
	$öô_öãl_ˇcheöfo
(
˝uöfo_x86
 *
c
)

357 
åa˚
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

358 
√w_l1d
 = 0, 
√w_l1i
 = 0;

359 
√w_l2
 = 0, 
√w_l3
 = 0, 
i
;

360 
l2_id
 = 0, 
l3_id
 = 0, 
num_thªads_sh¨ög
, 
ödex_msb
;

361 #ifde‡
CONFIG_X86_HT


362 
˝u
 = 
c
->
˝u_ödex
;

365 i‡(
c
->
˝uid_Àvñ
 > 3) {

366 
is_öôülized
;

368 i‡(
is_öôülized
 == 0) {

370 
num_ˇche_Àaves
 = 
	`föd_num_ˇche_Àaves
();

371 
is_öôülized
++;

378 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

379 
_˝uid4_öfo_ªgs
 
this_Àaf
;

380 
ªtvÆ
;

382 
ªtvÆ
 = 
	`˝uid4_ˇche_lookup_ªgs
(
i
, &
this_Àaf
);

383 i‡(
ªtvÆ
 >= 0) {

384 
this_Àaf
.
óx
.
•lô
.
Àvñ
) {

386 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

387 
CACHE_TYPE_DATA
)

388 
√w_l1d
 = 
this_Àaf
.
size
/1024;

389 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

390 
CACHE_TYPE_INST
)

391 
√w_l1i
 = 
this_Àaf
.
size
/1024;

394 
√w_l2
 = 
this_Àaf
.
size
/1024;

395 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

396 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

397 
l2_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

400 
√w_l3
 = 
this_Àaf
.
size
/1024;

401 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

402 
ödex_msb
 = 
	`gë_cou¡_‹dî
(

403 
num_thªads_sh¨ög
);

404 
l3_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

416 i‡((
num_ˇche_Àaves
 =0 || 
c
->
x86
 =15Ë&& c->
˝uid_Àvñ
 > 1) {

418 
j
, 
n
;

419 
ªgs
[4];

420 *
dp
 = (*)
ªgs
;

421 
⁄ly_åa˚
 = 0;

423 i‡(
num_ˇche_Àaves
 !0 && 
c
->
x86
 == 15)

424 
⁄ly_åa˚
 = 1;

427 
n
 = 
	`˝uid_óx
(2) & 0xFF;

429 
i
 = 0 ; i < 
n
 ; i++) {

430 
	`˝uid
(2, &
ªgs
[0], &regs[1], &regs[2], &regs[3]);

433 
j
 = 0 ; j < 3 ; j++)

434 i‡(
ªgs
[
j
] & (1 << 31))

435 
ªgs
[
j
] = 0;

438 
j
 = 1 ; j < 16 ; j++) {

439 
des
 = 
dp
[
j
];

440 
k
 = 0;

443 
ˇche_èbÀ
[
k
].
des¸ùt‹
 != 0) {

444 i‡(
ˇche_èbÀ
[
k
].
des¸ùt‹
 =
des
) {

445 i‡(
⁄ly_åa˚
 && 
ˇche_èbÀ
[
k
].
ˇche_ty≥
 !
LVL_TRACE
)

447 
ˇche_èbÀ
[
k
].
ˇche_ty≥
) {

448 
LVL_1_INST
:

449 
l1i
 +
ˇche_èbÀ
[
k
].
size
;

451 
LVL_1_DATA
:

452 
l1d
 +
ˇche_èbÀ
[
k
].
size
;

454 
LVL_2
:

455 
l2
 +
ˇche_èbÀ
[
k
].
size
;

457 
LVL_3
:

458 
l3
 +
ˇche_èbÀ
[
k
].
size
;

460 
LVL_TRACE
:

461 
åa˚
 +
ˇche_èbÀ
[
k
].
size
;

468 
k
++;

474 i‡(
√w_l1d
)

475 
l1d
 = 
√w_l1d
;

477 i‡(
√w_l1i
)

478 
l1i
 = 
√w_l1i
;

480 i‡(
√w_l2
) {

481 
l2
 = 
√w_l2
;

482 #ifde‡
CONFIG_X86_HT


483 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l2_id
;

487 i‡(
√w_l3
) {

488 
l3
 = 
√w_l3
;

489 #ifde‡
CONFIG_X86_HT


490 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l3_id
;

494 
c
->
x86_ˇche_size
 = 
l3
 ?Ü3 : (
l2
 ?Ü2 : (
l1i
+
l1d
));

496  
l2
;

497 
	}
}

499 #ifde‡
CONFIG_SYSFS


502 
DEFINE_PER_CPU
(
_˝uid4_öfo
 *, 
ici_˝uid4_öfo
);

503 
	#CPUID4_INFO_IDX
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_˝uid4_öfo
, x))[y]))

	)

505 #ifde‡
CONFIG_SMP


506 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

508 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

509 
num_thªads_sh¨ög
;

510 
ödex_msb
, 
i
, 
siblög
;

511 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

513 i‡((
ödex
 =3Ë&& (
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)) {

514 
	`f‹_óch_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
) {

515 i‡(!
	`≥r_˝u
(
ici_˝uid4_öfo
, 
i
))

517 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

518 
	`f‹_óch_˝u
(
siblög
, 
c
->
Œc_sh¨ed_m≠
) {

519 i‡(!
	`˝u_⁄löe
(
siblög
))

521 
	`£t_bô
(
siblög
, 
this_Àaf
->
sh¨ed_˝u_m≠
);

526 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

527 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
->
óx
.
•lô
.num_threads_sharing;

529 i‡(
num_thªads_sh¨ög
 == 1)

530 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

532 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

534 
	`f‹_óch_⁄löe_˝u
(
i
) {

535 i‡(
	`˝u_d©a
(
i
).
≠icid
 >> 
ödex_msb
 ==

536 
c
->
≠icid
 >> 
ödex_msb
) {

537 
	`˝umask_£t_˝u
(
i
,

538 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

539 i‡(
i
 !
˝u
 && 
	`≥r_˝u
(
ici_˝uid4_öfo
, i)) {

540 
siblög_Àaf
 =

541 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

542 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(

543 
siblög_Àaf
->
sh¨ed_˝u_m≠
));

548 
	}
}

549 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

551 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

552 
siblög
;

554 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

555 
	`f‹_óch_˝u
(
siblög
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
)) {

556 
siblög_Àaf
 = 
	`CPUID4_INFO_IDX
(
siblög
, 
ödex
);

557 
	`˝umask_˛ór_˝u
(
˝u
,

558 
	`to_˝umask
(
siblög_Àaf
->
sh¨ed_˝u_m≠
));

560 
	}
}

562 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

564 
	}
}

566 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

568 
	}
}

571 
__˝uöô
 
	$‰ì_ˇche_©åibuãs
(
˝u
)

573 
i
;

575 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

576 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

578 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

579 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

580 
	}
}

583 
__˝uöô
 
	$˝uid4_ˇche_lookup
(
ödex
, 
_˝uid4_öfo
 *
this_Àaf
)

585 
_˝uid4_öfo_ªgs
 *
Àaf_ªgs
 =

586 (
_˝uid4_öfo_ªgs
 *)
this_Àaf
;

588  
	`˝uid4_ˇche_lookup_ªgs
(
ödex
, 
Àaf_ªgs
);

589 
	}
}

591 
__˝uöô
 
	$gë_˝u_Àaves
(*
_ªtvÆ
)

593 
j
, *
ªtvÆ
 = 
_ªtvÆ
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

596 
j
 = 0; j < 
num_ˇche_Àaves
; j++) {

597 
_˝uid4_öfo
 *
this_Àaf
;

598 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
j
);

599 *
ªtvÆ
 = 
	`˝uid4_ˇche_lookup
(
j
, 
this_Àaf
);

600 i‡(
	`u∆ikñy
(*
ªtvÆ
 < 0)) {

601 
i
;

603 
i
 = 0; i < 
j
; i++)

604 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

607 
	`ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
j
);

609 
	}
}

611 
__˝uöô
 
	$dëe˘_ˇche_©åibuãs
(
˝u
)

613 
ªtvÆ
;

615 i‡(
num_ˇche_Àaves
 == 0)

616  -
ENOENT
;

618 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
	`kzÆloc
(

619 (
_˝uid4_öfo
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

620 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

621  -
ENOMEM
;

623 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
gë_˝u_Àaves
, &
ªtvÆ
, 
åue
);

624 i‡(
ªtvÆ
) {

625 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

626 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

629  
ªtvÆ
;

630 
	}
}

632 
	~<löux/kobje˘.h
>

633 
	~<löux/sysfs.h
>

635 
sysdev_˛ass
 
˝u_sysdev_˛ass
;

638 
DEFINE_PER_CPU
(
kobje˘
 *, 
ici_ˇche_kobje˘
);

640 
	s_ödex_kobje˘
 {

641 
kobje˘
 
	mkobj
;

642 
	m˝u
;

643 
	mödex
;

647 
DEFINE_PER_CPU
(
_ödex_kobje˘
 *, 
ici_ödex_kobje˘
);

648 
	#INDEX_KOBJECT_PTR
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_ödex_kobje˘
, x))[y]))

	)

650 
	#show_⁄e_∂us
(
fûe_«me
, 
obje˘
, 
vÆ
) \

651 
ssize_t
 
show_
##
fûe_«me
 \

652 (
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

654  
	`•rötf
(
buf
, "%lu\n", ()
this_Àaf
->
obje˘
 + 
vÆ
); \

655 }

	)

657 
show_⁄e_∂us
(
Àvñ
, 
óx
.
•lô
.level, 0);

658 
show_⁄e_∂us
(
cohîícy_löe_size
, 
ebx
.
•lô
.coherency_line_size, 1);

659 
show_⁄e_∂us
(
physiˇl_löe_∑πôi⁄
, 
ebx
.
•lô
.physical_line_partition, 1);

660 
show_⁄e_∂us
(
ways_of_assocütivôy
, 
ebx
.
•lô
.ways_of_associativity, 1);

661 
show_⁄e_∂us
(
numbî_of_£ts
, 
ecx
.
•lô
.number_of_sets, 1);

663 
ssize_t
 
	$show_size
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

665  
	`•rötf
(
buf
, "%luK\n", 
this_Àaf
->
size
 / 1024);

666 
	}
}

668 
ssize_t
 
	$show_sh¨ed_˝u_m≠_func
(
_˝uid4_öfo
 *
this_Àaf
,

669 
ty≥
, *
buf
)

671 
±rdiff_t
 
Àn
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

672 
n
 = 0;

674 i‡(
Àn
 > 1) {

675 c⁄° 
˝umask
 *
mask
;

677 
mask
 = 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
);

678 
n
 = 
ty≥
 ?

679 
	`˝uli°_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
) :

680 
	`˝umask_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
);

681 
buf
[
n
++] = '\n';

682 
buf
[
n
] = '\0';

684  
n
;

685 
	}
}

687 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_m≠
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

689  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 0, 
buf
);

690 
	}
}

692 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_li°
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

694  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 1, 
buf
);

695 
	}
}

697 
ssize_t
 
	$show_ty≥
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

699 
this_Àaf
->
óx
.
•lô
.
ty≥
) {

700 
CACHE_TYPE_DATA
:

701  
	`•rötf
(
buf
, "Data\n");

702 
CACHE_TYPE_INST
:

703  
	`•rötf
(
buf
, "Instruction\n");

704 
CACHE_TYPE_UNIFIED
:

705  
	`•rötf
(
buf
, "Unified\n");

707  
	`•rötf
(
buf
, "Unknown\n");

709 
	}
}

711 
	#to_obje˘
(
k
Ë
	`c⁄èöî_of
(k, 
_ödex_kobje˘
, 
kobj
)

	)

712 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
_ˇche_©å
, 
©å
)

	)

714 
ssize_t
 
	$show_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
,

715 
ödex
)

717 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

718 
node
 = 
	`˝u_to_node
(
˝u
);

719 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

720 
ªg
 = 0;

722 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

723  -
EINVAL
;

725 i‡(!
dev
)

726  -
EINVAL
;

728 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, &
ªg
);

729  
	`•rötf
(
buf
, "%x\n", 
ªg
);

730 
	}
}

732 
	#SHOW_CACHE_DISABLE
(
ödex
) \

733 
ssize_t
 \

734 
show_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

736  
	`show_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
ödex
); \

737 }

	)

738 
	$SHOW_CACHE_DISABLE
(0)

739 
	$SHOW_CACHE_DISABLE
(1)

741 
ssize_t
 
	$°‹e_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
,

742 c⁄° *
buf
, 
size_t
 
cou¡
, 
ödex
)

744 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

745 
node
 = 
	`˝u_to_node
(
˝u
);

746 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

747 
vÆ
 = 0;

748 
s¸ubbî
 = 0;

750 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

751  -
EINVAL
;

753 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

754  -
EPERM
;

756 i‡(!
dev
)

757  -
EINVAL
;

759 i‡(
	`°ri˘_°πoul
(
buf
, 10, &
vÆ
) < 0)

760  -
EINVAL
;

762 
vÆ
 |= 0xc0000000;

764 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x58, &
s¸ubbî
);

765 
s¸ubbî
 &= ~0x1f000000;

766 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x58, 
s¸ubbî
);

768 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
 & ~0x40000000);

769 
	`wbövd
();

770 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
);

771  
cou¡
;

772 
	}
}

774 
	#STORE_CACHE_DISABLE
(
ödex
) \

775 
ssize_t
 \

776 
°‹e_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, \

777 c⁄° *
buf
, 
size_t
 
cou¡
) \

779  
	`°‹e_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
cou¡
, 
ödex
); \

780 }

	)

781 
	$STORE_CACHE_DISABLE
(0)

782 
	$STORE_CACHE_DISABLE
(1)

784 
	s_ˇche_©å
 {

785 
©åibuã
 
©å
;

786 
	`ssize_t
 (*
show
)(
_˝uid4_öfo
 *, *);

787 
	`ssize_t
 (*
°‹e
)(
_˝uid4_öfo
 *, c⁄° *, 
size_t
 
cou¡
);

790 
	#deföe_⁄e_ro
(
_«me
) \

791 
_ˇche_©å
 
_«me
 = \

792 
	`__ATTR
(
_«me
, 0444, 
show_
##_«me, 
NULL
)

	)

794 
	`deföe_⁄e_ro
(
Àvñ
);

795 
	`deföe_⁄e_ro
(
ty≥
);

796 
	`deföe_⁄e_ro
(
cohîícy_löe_size
);

797 
	`deföe_⁄e_ro
(
physiˇl_löe_∑πôi⁄
);

798 
	`deföe_⁄e_ro
(
ways_of_assocütivôy
);

799 
	`deföe_⁄e_ro
(
numbî_of_£ts
);

800 
	`deföe_⁄e_ro
(
size
);

801 
	`deföe_⁄e_ro
(
sh¨ed_˝u_m≠
);

802 
	`deföe_⁄e_ro
(
sh¨ed_˝u_li°
);

804 
_ˇche_©å
 
ˇche_dißbÀ_0
 = 
	`__ATTR
(cache_disable_0, 0644,

805 
show_ˇche_dißbÀ_0
, 
°‹e_ˇche_dißbÀ_0
);

806 
_ˇche_©å
 
ˇche_dißbÀ_1
 = 
	`__ATTR
(cache_disable_1, 0644,

807 
show_ˇche_dißbÀ_1
, 
°‹e_ˇche_dißbÀ_1
);

809 
©åibuã
 *
deÁu…_©ås
[] = {

810 &
ty≥
.
©å
,

811 &
Àvñ
.
©å
,

812 &
cohîícy_löe_size
.
©å
,

813 &
physiˇl_löe_∑πôi⁄
.
©å
,

814 &
ways_of_assocütivôy
.
©å
,

815 &
numbî_of_£ts
.
©å
,

816 &
size
.
©å
,

817 &
sh¨ed_˝u_m≠
.
©å
,

818 &
sh¨ed_˝u_li°
.
©å
,

819 &
ˇche_dißbÀ_0
.
©å
,

820 &
ˇche_dißbÀ_1
.
©å
,

821 
NULL


822 
	}
};

824 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

826 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

827 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

828 
ssize_t
 
ªt
;

830 
ªt
 = 
Áâr
->
show
 ?

831 
Áâr
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

832 
buf
) :

834  
ªt
;

835 
	}
}

837 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

838 c⁄° *
buf
, 
size_t
 
cou¡
)

840 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

841 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

842 
ssize_t
 
ªt
;

844 
ªt
 = 
Áâr
->
°‹e
 ?

845 
Áâr
->
	`°‹e
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

846 
buf
, 
cou¡
) :

848  
ªt
;

849 
	}
}

851 
sysfs_›s
 
	gsysfs_›s
 = {

852 .
show
 = show,

853 .
	g°‹e
 = 
°‹e
,

856 
kobj_ty≥
 
	gkty≥_ˇche
 = {

857 .
sysfs_›s
 = &sysfs_ops,

858 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

861 
kobj_ty≥
 
	gkty≥_≥r˝u_íåy
 = {

862 .
sysfs_›s
 = &sysfs_ops,

865 
__˝uöô
 
	$˝uid4_ˇche_sysfs_exô
(
˝u
)

867 
	`k‰ì
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

868 
	`k‰ì
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
));

869 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë
NULL
;

870 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
NULL
;

871 
	`‰ì_ˇche_©åibuãs
(
˝u
);

872 
	}
}

874 
__˝uöô
 
	$˝uid4_ˇche_sysfs_öô
(
˝u
)

876 
îr
;

878 i‡(
num_ˇche_Àaves
 == 0)

879  -
ENOENT
;

881 
îr
 = 
	`dëe˘_ˇche_©åibuãs
(
˝u
);

882 i‡(
îr
)

883  
îr
;

886 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
) =

887 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

888 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë=
NULL
))

889 
îr_out
;

891 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
	`kzÆloc
(

892 (
_ödex_kobje˘
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

893 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë=
NULL
))

894 
îr_out
;

898 
îr_out
:

899 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

900  -
ENOMEM
;

901 
	}
}

903 
DECLARE_BITMAP
(
ˇche_dev_m≠
, 
NR_CPUS
);

906 
__˝uöô
 
	$ˇche_add_dev
(
sys_devi˚
 * 
sys_dev
)

908 
˝u
 = 
sys_dev
->
id
;

909 
i
, 
j
;

910 
_ödex_kobje˘
 *
this_obje˘
;

911 
ªtvÆ
;

913 
ªtvÆ
 = 
	`˝uid4_ˇche_sysfs_öô
(
˝u
);

914 i‡(
	`u∆ikñy
(
ªtvÆ
 < 0))

915  
ªtvÆ
;

917 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

918 &
kty≥_≥r˝u_íåy
,

919 &
sys_dev
->
kobj
, "%s", "cache");

920 i‡(
ªtvÆ
 < 0) {

921 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

922  
ªtvÆ
;

925 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

926 
this_obje˘
 = 
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
);

927 
this_obje˘
->
˝u
 = cpu;

928 
this_obje˘
->
ödex
 = 
i
;

929 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(&(
this_obje˘
->
kobj
),

930 &
kty≥_ˇche
,

931 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

932 "ödex%1lu", 
i
);

933 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

934 
j
 = 0; j < 
i
; j++)

935 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
j
)->
kobj
));

936 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

937 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

938  
ªtvÆ
;

940 
	`kobje˘_uevít
(&(
this_obje˘
->
kobj
), 
KOBJ_ADD
);

942 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

944 
	`kobje˘_uevít
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
), 
KOBJ_ADD
);

946 
	}
}

948 
__˝uöô
 
	$ˇche_ªmove_dev
(
sys_devi˚
 * 
sys_dev
)

950 
˝u
 = 
sys_dev
->
id
;

951 
i
;

953 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

955 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
)))

957 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

959 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

960 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
)->
kobj
));

961 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

962 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

963 
	}
}

965 
__˝uöô
 
	$ˇcheöfo_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

966 
a˘i⁄
, *
h˝u
)

968 
˝u
 = ()
h˝u
;

969 
sys_devi˚
 *
sys_dev
;

971 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

972 
a˘i⁄
) {

973 
CPU_ONLINE
:

974 
CPU_ONLINE_FROZEN
:

975 
	`ˇche_add_dev
(
sys_dev
);

977 
CPU_DEAD
:

978 
CPU_DEAD_FROZEN
:

979 
	`ˇche_ªmove_dev
(
sys_dev
);

982  
NOTIFY_OK
;

983 
	}
}

985 
nŸifõr_block
 
__˝uöôd©a
 
	gˇcheöfo_˝u_nŸifõr
 = {

986 .
nŸifõr_ˇŒ
 = 
ˇcheöfo_˝u_ˇŒback
,

989 
__˝uöô
 
	$ˇche_sysfs_öô
()

991 
i
;

993 i‡(
num_ˇche_Àaves
 == 0)

996 
	`f‹_óch_⁄löe_˝u
(
i
) {

997 
îr
;

998 
sys_devi˚
 *
sys_dev
 = 
	`gë_˝u_sysdev
(
i
);

1000 
îr
 = 
	`ˇche_add_dev
(
sys_dev
);

1001 i‡(
îr
)

1002  
îr
;

1004 
	`ªgi°î_hŸ˝u_nŸifõr
(&
ˇcheöfo_˝u_nŸifõr
);

1006 
	}
}

1008 
devi˚_öôˇŒ
(
ˇche_sysfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/debugfs.h
>

16 
	~<asm/m˚.h
>

18 
	~"m˚-öã∫Æ.h
"

32 
	ec⁄ãxt
 { 
	mIN_KERNEL
 = 1, 
	mIN_USER
 = 2 };

33 
	e£r
 { 
	mSER_REQUIRED
 = 1, 
	mNO_SER
 = 2 };

35 
	s£vîôy
 {

36 
u64
 
	mmask
;

37 
u64
 
	mªsu…
;

38 
	m£v
;

39 
	mmcgmask
;

40 
	mmcgªs
;

41 
	m£r
;

42 
	mc⁄ãxt
;

43 
	mcovîed
;

44 *
	mmsg
;

45 } 
	g£vîôõs
[] = {

46 
	#KERNEL
 .
c⁄ãxt
 = 
IN_KERNEL


	)

47 
	#USER
 .
c⁄ãxt
 = 
IN_USER


	)

48 
	#SER
 .
£r
 = 
SER_REQUIRED


	)

49 
	#NOSER
 .
£r
 = 
NO_SER


	)

50 
	#SEV
(
s
Ë.
£v
 = 
MCE_
 ## s ## 
_SEVERITY


	)

51 
	#BITCLR
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = 0, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

52 
	#BITSET
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = x, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

53 
	#MCGMASK
(
x
, 
ªs
, 
s
, 
m
, 
r
...) \

54 { .
mcgmask
 = 
x
, .
mcgªs
 = 
ªs
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

55 
	#MASK
(
x
, 
y
, 
s
, 
m
, 
r
...) \

56 { .
mask
 = 
x
, .
ªsu…
 = 
y
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

57 
	#MCI_UC_S
 (
MCI_STATUS_UC
|
MCI_STATUS_S
)

	)

58 
	#MCI_UC_SAR
 (
MCI_STATUS_UC
|
MCI_STATUS_S
|
MCI_STATUS_AR
)

	)

59 
	#MCACOD
 0xffff

	)

61 
BITCLR
(
MCI_STATUS_VAL
, 
NO
, "Invalid"),

62 
BITCLR
(
MCI_STATUS_EN
, 
NO
, "NotÉnabled"),

63 
BITSET
(
MCI_STATUS_PCC
, 
PANIC
, "Processor context corrupt"),

65 
MCGMASK
(
MCG_STATUS_MCIP
, 0, 
PANIC
, "MCIPÇot set in MCA handler"),

67 
MCGMASK
(
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
, 0, 
PANIC
,

69 
MCGMASK
(
MCG_STATUS_RIPV
, 0, 
PANIC
, "In kernelándÇoÑestart IP",

70 
KERNEL
),

71 
BITCLR
(
MCI_STATUS_UC
, 
KEEP
, "C‹ª˘edÉº‹", 
NOSER
),

72 
MASK
(
MCI_STATUS_OVER
|
MCI_STATUS_UC
|
MCI_STATUS_EN
, MCI_STATUS_UC, 
SOME
,

73 "Spuriou†nŸÉ«bÀd", 
SER
),

76 
MASK
(
MCI_UC_SAR
, 
MCI_STATUS_UC
, 
KEEP
,

77 "Unc‹ª˘edÇÿa˘i⁄Ñequúed", 
SER
),

78 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_STATUS_UC
|
MCI_STATUS_AR
, 
PANIC
,

79 "IŒegÆ combö©i⁄ (UCNA wôh AR=1)", 
SER
),

80 
MASK
(
MCI_STATUS_S
, 0, 
KEEP
, "N⁄ sig«Œed machöêcheck", 
SER
),

83 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, MCI_STATUS_OVER|MCI_UC_SAR, 
PANIC
,

84 "A˘i⁄Ñequúed wôhÜo°Évíts", 
SER
),

85 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
|
MCACOD
, MCI_UC_SAR, 
PANIC
,

86 "A˘i⁄Ñequúed; unknow¿MCACOD", 
SER
),

89 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|0xfff0, 
MCI_UC_S
|0xc0, 
AO
,

90 "A˘i⁄ o±i⁄Æ: mem‹y s¸ubbögÉº‹", 
SER
),

91 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|
MCACOD
, 
MCI_UC_S
|0x17a, 
AO
,

92 "A˘i⁄ o±i⁄Æ:Üa°Üevñ cachêwrôebackÉº‹", 
SER
),

94 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
, 
SOME
,

95 "A˘i⁄ o±i⁄Æ unknow¿MCACOD", 
SER
),

96 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
|MCI_STATUS_OVER, 
SOME
,

97 "A˘i⁄ o±i⁄Æ wôhÜo°Évíts", 
SER
),

98 
BITSET
(
MCI_STATUS_UC
|
MCI_STATUS_OVER
, 
PANIC
, "Overflowed uncorrected"),

99 
BITSET
(
MCI_STATUS_UC
, 
UC
, "Uncorrected"),

100 
BITSET
(0, 
SOME
, "No match")

107 
	$îr‹_c⁄ãxt
(
m˚
 *
m
)

109 i‡(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
)

110  (
m
->
ù
 && (m->
cs
 & 3Ë=3Ë? 
IN_USER
 : 
IN_KERNEL
;

112  
IN_KERNEL
;

113 
	}
}

115 
	$m˚_£vîôy
(
m˚
 *
a
, 
tﬁî™t
, **
msg
)

117 
c⁄ãxt
 
˘x
 = 
	`îr‹_c⁄ãxt
(
a
);

118 
£vîôy
 *
s
;

120 
s
 = 
£vîôõs
;; s++) {

121 i‡((
a
->
°©us
 & 
s
->
mask
Ë!s->
ªsu…
)

123 i‡((
a
->
mcg°©us
 & 
s
->
mcgmask
Ë!s->
mcgªs
)

125 i‡(
s
->
£r
 =
SER_REQUIRED
 && !
m˚_£r
)

127 i‡(
s
->
£r
 =
NO_SER
 && 
m˚_£r
)

129 i‡(
s
->
c⁄ãxt
 && 
˘x
 != s->context)

131 i‡(
msg
)

132 *
msg
 = 
s
->msg;

133 
s
->
covîed
 = 1;

134 i‡(
s
->
£v
 >
MCE_UC_SEVERITY
 && 
˘x
 =
IN_KERNEL
) {

135 i‡(
∑nic_⁄_o›s
 || 
tﬁî™t
 < 1)

136  
MCE_PANIC_SEVERITY
;

138  
s
->
£v
;

140 
	}
}

142 #ifde‡
CONFIG_DEBUG_FS


143 *
	$s_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

145 i‡(*
pos
 >
	`ARRAY_SIZE
(
£vîôõs
))

146  
NULL
;

147  &
£vîôõs
[*
pos
];

148 
	}
}

150 *
	$s_√xt
(
£q_fûe
 *
f
, *
d©a
, 
loff_t
 *
pos
)

152 i‡(++(*
pos
Ë>
	`ARRAY_SIZE
(
£vîôõs
))

153  
NULL
;

154  &
£vîôõs
[*
pos
];

155 
	}
}

157 
	$s_°›
(
£q_fûe
 *
f
, *
d©a
)

159 
	}
}

161 
	$s_show
(
£q_fûe
 *
f
, *
d©a
)

163 
£vîôy
 *
£r
 = 
d©a
;

164 
	`£q_¥ötf
(
f
, "%d\t%s\n", 
£r
->
covîed
, sî->
msg
);

166 
	}
}

168 c⁄° 
£q_›î©i⁄s
 
	g£vîôõs_£q_›s
 = {

169 .
°¨t
 = 
s_°¨t
,

170 .
	g√xt
 = 
s_√xt
,

171 .
	g°›
 = 
s_°›
,

172 .
	gshow
 = 
s_show
,

175 
	$£vîôõs_covîage_›í
(
öode
 *öode, 
fûe
 *file)

177  
	`£q_›í
(
fûe
, &
£vîôõs_£q_›s
);

178 
	}
}

180 
ssize_t
 
	$£vîôõs_covîage_wrôe
(
fûe
 *file,

181 c⁄° 
__u£r
 *
ubuf
,

182 
size_t
 
cou¡
, 
loff_t
 *
µos
)

184 
i
;

185 
i
 = 0; i < 
	`ARRAY_SIZE
(
£vîôõs
); i++)

186 
£vîôõs
[
i
].
covîed
 = 0;

187  
cou¡
;

188 
	}
}

190 c⁄° 
fûe_›î©i⁄s
 
	g£vîôõs_covîage_f›s
 = {

191 .
›í
 = 
£vîôõs_covîage_›í
,

192 .
	gªÀa£
 = 
£q_ªÀa£
,

193 .
	gªad
 = 
£q_ªad
,

194 .
	gwrôe
 = 
£vîôõs_covîage_wrôe
,

197 
__öô
 
	$£vîôõs_debugfs_öô
()

199 
díåy
 *
dm˚
 = 
NULL
, *
f£vîôõs_covîage
 = NULL;

201 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

202 i‡(
dm˚
 =
NULL
)

203 
îr_out
;

204 
f£vîôõs_covîage
 = 
	`debugfs_¸óã_fûe
("severities-coverage",

205 0444, 
dm˚
, 
NULL
,

206 &
£vîôõs_covîage_f›s
);

207 i‡(
f£vîôõs_covîage
 =
NULL
)

208 
îr_out
;

212 
îr_out
:

213  -
ENOMEM
;

214 
	}
}

215 
œã_öôˇŒ
(
£vîôõs_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c

10 
	~<löux/thªad_öfo.h
>

11 
	~<löux/ˇ∑bûôy.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/kÆlsyms.h
>

16 
	~<löux/rcupd©e.h
>

17 
	~<löux/kobje˘.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≥r˝u.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/sysdev.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/˘y≥.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/sysfs.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/öô.h
>

30 
	~<löux/kmod.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/nmi.h
>

33 
	~<löux/˝u.h
>

34 
	~<löux/smp.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/mm.h
>

37 
	~<löux/debugfs.h
>

39 
	~<asm/¥o˚ss‹.h
>

40 
	~<asm/hw_úq.h
>

41 
	~<asm/≠ic.h
>

42 
	~<asm/idÀ.h
>

43 
	~<asm/ùi.h
>

44 
	~<asm/m˚.h
>

45 
	~<asm/m§.h
>

47 
	~"m˚-öã∫Æ.h
"

49 
	#CREATE_TRACE_POINTS


	)

50 
	~<åa˚/evíts/m˚.h
>

52 
m˚_dißbÀd
 
	g__ªad_mo°ly
;

54 
	#MISC_MCELOG_MINOR
 227

	)

56 
	#SPINUNIT
 100

	)

58 
©omic_t
 
	gm˚_íåy
;

60 
DEFINE_PER_CPU
(, 
m˚_ex˚±i⁄_cou¡
);

69 
tﬁî™t
 
	g__ªad_mo°ly
 = 1;

70 
b™ks
 
	g__ªad_mo°ly
;

71 
rù_m§
 
	g__ªad_mo°ly
;

72 
m˚_boŸlog
 
	g__ªad_mo°ly
 = -1;

73 
m⁄¨ch_timeout
 
	g__ªad_mo°ly
 = -1;

74 
m˚_∑nic_timeout
 
	g__ªad_mo°ly
;

75 
m˚_d⁄t_log_˚
 
	g__ªad_mo°ly
;

76 
m˚_cmci_dißbÀd
 
	g__ªad_mo°ly
;

77 
m˚_ign‹e_˚
 
	g__ªad_mo°ly
;

78 
m˚_£r
 
	g__ªad_mo°ly
;

80 
m˚_b™k
 *
m˚_b™ks
 
	g__ªad_mo°ly
;

83 
	gm˚_√ed_nŸify
;

84 
	gm˚_hñ≥r
[128];

85 *
	gm˚_hñ≥r_¨gv
[2] = { 
m˚_hñ≥r
, 
NULL
 };

87 
DECLARE_WAIT_QUEUE_HEAD
(
m˚_waô
);

88 
DEFINE_PER_CPU
(
m˚
, 
m˚s_£í
);

89 
	g˝u_missög
;

95 
ATOMIC_NOTIFIER_HEAD
(
x86_m˚_decodî_chaö
);

96 
EXPORT_SYMBOL_GPL
(
x86_m˚_decodî_chaö
);

98 
	$deÁu…_decode_m˚
(
nŸifõr_block
 *
nb
, 
vÆ
,

99 *
d©a
)

101 
	`¥_emîg
("No humanÑeadable MCE decoding support onÅhis CPUÅype.\n");

102 
	`¥_emîg
("RunÅhe messageÅhrough 'mcelog --ascii'Åo decode.\n");

104  
NOTIFY_STOP
;

105 
	}
}

107 
nŸifõr_block
 
	gm˚_dec_nb
 = {

108 .
nŸifõr_ˇŒ
 = 
deÁu…_decode_m˚
,

109 .
	g¥i‹ôy
 = -1,

113 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_pﬁl_b™ks
) = {

114 [0 ... 
BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

117 
DEFINE_PER_CPU
(
w‹k_°ru˘
, 
m˚_w‹k
);

120 
	$m˚_£tup
(
m˚
 *
m
)

122 
	`mem£t
(
m
, 0, (
m˚
));

123 
m
->
˝u
 = m->
ext˝u
 = 
	`smp_¥o˚ss‹_id
();

124 
	`rdts˛l
(
m
->
tsc
);

126 
m
->
time
 = 
	`gë_£c⁄ds
();

127 
m
->
˝uvíd‹
 = 
boŸ_˝u_d©a
.
x86_víd‹
;

128 
m
->
˝uid
 = 
	`˝uid_óx
(1);

129 #ifde‡
CONFIG_SMP


130 
m
->
sockëid
 = 
	`˝u_d©a
(m->
ext˝u
).
phys_¥oc_id
;

132 
m
->
≠icid
 = 
	`˝u_d©a
(m->
ext˝u
).
öôül_≠icid
;

133 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
m
->
mcgˇp
);

134 
	}
}

136 
DEFINE_PER_CPU
(
m˚
, 
öje˘m
);

137 
EXPORT_PER_CPU_SYMBOL_GPL
(
öje˘m
);

145 
m˚_log
 
	gm˚log
 = {

146 .
sig«tuª
 = 
MCE_LOG_SIGNATURE
,

147 .
	gÀn
 = 
MCE_LOG_LEN
,

148 .
	gªc‹dÀn
 = (
m˚
),

151 
	$m˚_log
(
m˚
 *mce)

153 
√xt
, 
íåy
;

156 
	`åa˚_m˚_ªc‹d
(
m˚
);

158 
m˚
->
föished
 = 0;

159 
	`wmb
();

161 
íåy
 = 
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
);

168 i‡(
íåy
 >
MCE_LOG_LEN
) {

169 
	`£t_bô
(
MCE_OVERFLOW
,

170 (*)&
m˚log
.
Êags
);

174 i‡(
m˚log
.
íåy
[íåy].
föished
) {

175 
íåy
++;

180 
	`smp_rmb
();

181 
√xt
 = 
íåy
 + 1;

182 i‡(
	`cmpxchg
(&
m˚log
.
√xt
, 
íåy
,Çext) ==Éntry)

185 
	`mem˝y
(
m˚log
.
íåy
 +É¡ry, 
m˚
, (mce));

186 
	`wmb
();

187 
m˚log
.
íåy
[íåy].
föished
 = 1;

188 
	`wmb
();

190 
m˚
->
föished
 = 1;

191 
	`£t_bô
(0, &
m˚_√ed_nŸify
);

192 
	}
}

194 
	$¥öt_m˚
(
m˚
 *
m
)

196 
	`¥_emîg
("CPU %d: Machine Check Exception: %16Lx Bank %d: %016Lx\n",

197 
m
->
ext˝u
, m->
mcg°©us
, m->
b™k
, m->
°©us
);

199 i‡(
m
->
ù
) {

200 
	`¥_emîg
("RIP%s %02x:<%016Lx> ",

201 !(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

202 
m
->
cs
, m->
ù
);

204 i‡(
m
->
cs
 =
__KERNEL_CS
)

205 
	`¥öt_symbﬁ
("{%s}", 
m
->
ù
);

206 
	`¥_c⁄t
("\n");

209 
	`¥_emîg
("TSC %Œx ", 
m
->
tsc
);

210 i‡(
m
->
addr
)

211 
	`¥_c⁄t
("ADDR %Œx ", 
m
->
addr
);

212 i‡(
m
->
misc
)

213 
	`¥_c⁄t
("MISC %Œx ", 
m
->
misc
);

215 
	`¥_c⁄t
("\n");

216 
	`¥_emîg
("PROCESSOR %u:%x TIME %llu SOCKET %u APIC %x\n",

217 
m
->
˝uvíd‹
, m->
˝uid
, m->
time
, m->
sockëid
, m->
≠icid
);

223 
	`©omic_nŸifõr_ˇŒ_chaö
(&
x86_m˚_decodî_chaö
, 0, 
m
);

224 
	}
}

226 
	$¥öt_m˚_hód
()

228 
	`¥_emîg
("\nHARDWARE ERROR\n");

229 
	}
}

231 
	$¥öt_m˚_èû
()

233 
	`¥_emîg
("This isÇotá softwareÖroblem!\n");

234 
	}
}

236 
	#PANIC_TIMEOUT
 5

	)

238 
©omic_t
 
	gm˚_∑ni˚d
;

240 
	gÁke_∑nic
;

241 
©omic_t
 
	gm˚_Áke_∑ni˚d
;

244 
	$waô_f‹_∑nic
()

246 
timeout
 = 
PANIC_TIMEOUT
*
USEC_PER_SEC
;

248 
	`¥ìm±_dißbÀ
();

249 
	`loˇl_úq_íabÀ
();

250 
timeout
-- > 0)

251 
	`udñay
(1);

252 i‡(
∑nic_timeout
 == 0)

253 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

254 
	`∑nic
("Panicing machine check CPU died");

255 
	}
}

257 
	$m˚_∑nic
(*
msg
, 
m˚
 *
föÆ
, *
exp
)

259 
i
;

261 i‡(!
Áke_∑nic
) {

265 i‡(
	`©omic_öc_ªtu∫
(&
m˚_∑ni˚d
) > 1)

266 
	`waô_f‹_∑nic
();

267 
	`b¨rõr
();

269 
	`bu°_•ölocks
(1);

270 
	`c⁄sﬁe_vîbo£
();

273 i‡(
	`©omic_öc_ªtu∫
(&
m˚_Áke_∑ni˚d
) > 1)

276 
	`¥öt_m˚_hód
();

278 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

279 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

280 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

282 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

283 
	`¥öt_m˚
(
m
);

286 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

287 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

288 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

290 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

292 i‡(!
föÆ
 || 
	`memcmp
(
m
, föÆ, (
m˚
)))

293 
	`¥öt_m˚
(
m
);

295 i‡(
föÆ
)

296 
	`¥öt_m˚
(
föÆ
);

297 i‡(
˝u_missög
)

298 
	`¥ötk
(
KERN_EMERG
 "Some CPUs didn'tánswer in synchronization\n");

299 
	`¥öt_m˚_èû
();

300 i‡(
exp
)

301 
	`¥ötk
(
KERN_EMERG
 "Machöêcheck: %s\n", 
exp
);

302 i‡(!
Áke_∑nic
) {

303 i‡(
∑nic_timeout
 == 0)

304 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

305 
	`∑nic
(
msg
);

307 
	`¥ötk
(
KERN_EMERG
 "Fakêkî√»∑nic: %s\n", 
msg
);

308 
	}
}

312 
	$m§_to_off£t
(
u32
 
m§
)

314 
b™k
 = 
	`__gë_˝u_v¨
(
öje˘m
.bank);

316 i‡(
m§
 =
rù_m§
)

317  
	`off£tof
(
m˚
, 
ù
);

318 i‡(
m§
 =
	`MSR_IA32_MCx_STATUS
(
b™k
))

319  
	`off£tof
(
m˚
, 
°©us
);

320 i‡(
m§
 =
	`MSR_IA32_MCx_ADDR
(
b™k
))

321  
	`off£tof
(
m˚
, 
addr
);

322 i‡(
m§
 =
	`MSR_IA32_MCx_MISC
(
b™k
))

323  
	`off£tof
(
m˚
, 
misc
);

324 i‡(
m§
 =
MSR_IA32_MCG_STATUS
)

325  
	`off£tof
(
m˚
, 
mcg°©us
);

327 
	}
}

330 
u64
 
	$m˚_rdm§l
(
u32
 
m§
)

332 
u64
 
v
;

334 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

335 
off£t
 = 
	`m§_to_off£t
(
m§
);

337 i‡(
off£t
 < 0)

339  *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
);

342 i‡(
	`rdm§l_ß„
(
m§
, &
v
)) {

343 
	`WARN_ONCE
(1, "m˚: U«bÀÅÿªad m§ %d!\n", 
m§
);

349 
v
 = 0;

352  
v
;

353 
	}
}

355 
	$m˚_wrm§l
(
u32
 
m§
, 
u64
 
v
)

357 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

358 
off£t
 = 
	`m§_to_off£t
(
m§
);

360 i‡(
off£t
 >= 0)

361 *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
Ë
v
;

364 
	`wrm§l
(
m§
, 
v
);

365 
	}
}

372 
	#MCE_RING_SIZE
 16

	)

374 
	sm˚_rög
 {

375 
	m°¨t
;

376 
	míd
;

377 
	mrög
[
MCE_RING_SIZE
];

379 
DEFINE_PER_CPU
(
m˚_rög
, mce_ring);

382 
	$m˚_rög_em±y
()

384 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

386  
r
->
°¨t
 =r->
íd
;

387 
	}
}

389 
	$m˚_rög_gë
(*
p‚
)

391 
m˚_rög
 *
r
;

392 
ªt
 = 0;

394 *
p‚
 = 0;

395 
	`gë_˝u
();

396 
r
 = &
	`__gë_˝u_v¨
(
m˚_rög
);

397 i‡(
r
->
°¨t
 =r->
íd
)

398 
out
;

399 *
p‚
 = 
r
->
rög
[r->
°¨t
];

400 
r
->
°¨t
 = (r->°¨à+ 1Ë% 
MCE_RING_SIZE
;

401 
ªt
 = 1;

402 
out
:

403 
	`put_˝u
();

404  
ªt
;

405 
	}
}

408 
	$m˚_rög_add
(
p‚
)

410 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

411 
√xt
;

413 
√xt
 = (
r
->
íd
 + 1Ë% 
MCE_RING_SIZE
;

414 i‡(
√xt
 =
r
->
°¨t
)

416 
r
->
rög
[r->
íd
] = 
p‚
;

417 
	`wmb
();

418 
r
->
íd
 = 
√xt
;

420 
	}
}

422 
	$m˚_avaûabÀ
(
˝uöfo_x86
 *
c
)

424 i‡(
m˚_dißbÀd
)

426  
	`˝u_has
(
c
, 
X86_FEATURE_MCE
Ë&& cpu_has(c, 
X86_FEATURE_MCA
);

427 
	}
}

429 
	$m˚_scheduÀ_w‹k
()

431 i‡(!
	`m˚_rög_em±y
()) {

432 
w‹k_°ru˘
 *
w‹k
 = &
	`__gë_˝u_v¨
(
m˚_w‹k
);

433 i‡(!
	`w‹k_≥ndög
(
w‹k
))

434 
	`scheduÀ_w‹k
(
w‹k
);

436 
	}
}

442 
ölöe
 
	$m˚_gë_rù
(
m˚
 *
m
, 
±_ªgs
 *
ªgs
)

445 i‡(
ªgs
 && (
m
->
mcg°©us
 & (
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
))) {

446 
m
->
ù
 = 
ªgs
->ip;

447 
m
->
cs
 = 
ªgs
->cs;

449 
m
->
ù
 = 0;

450 
m
->
cs
 = 0;

452 i‡(
rù_m§
)

453 
m
->
ù
 = 
	`m˚_rdm§l
(
rù_m§
);

454 
	}
}

456 #ifde‡
CONFIG_X86_LOCAL_APIC


462 
asmlökage
 
	$smp_m˚_£lf_öãºu±
(
±_ªgs
 *
ªgs
)

464 
	`ack_APIC_úq
();

465 
	`exô_idÀ
();

466 
	`úq_íãr
();

467 
	`m˚_nŸify_úq
();

468 
	`m˚_scheduÀ_w‹k
();

469 
	`úq_exô
();

470 
	}
}

473 
	$m˚_ªp‹t_evít
(
±_ªgs
 *
ªgs
)

475 i‡(
ªgs
->
Êags
 & (
X86_VM_MASK
|
X86_EFLAGS_IF
)) {

476 
	`m˚_nŸify_úq
();

483 
	`m˚_scheduÀ_w‹k
();

487 #ifde‡
CONFIG_X86_LOCAL_APIC


492 i‡(!
˝u_has_≠ic
)

501 
≠ic
->
	`£nd_IPI_£lf
(
MCE_SELF_VECTOR
);

508 
	`≠ic_waô_i¸_idÀ
();

510 
	}
}

512 
DEFINE_PER_CPU
(, 
m˚_pﬁl_cou¡
);

529 
	$machöe_check_pﬁl
(
m˝_Êags
 
Êags
, 
m˚_b™ks_t
 *
b
)

531 
m˚
 
m
;

532 
i
;

534 
	`__gë_˝u_v¨
(
m˚_pﬁl_cou¡
)++;

536 
	`m˚_£tup
(&
m
);

538 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

539 
i
 = 0; i < 
b™ks
; i++) {

540 i‡(!
m˚_b™ks
[
i
].
˘l
 || !
	`ã°_bô
(i, *
b
))

543 
m
.
misc
 = 0;

544 
m
.
addr
 = 0;

545 
m
.
b™k
 = 
i
;

546 
m
.
tsc
 = 0;

548 
	`b¨rõr
();

549 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

550 i‡(!(
m
.
°©us
 & 
MCI_STATUS_VAL
))

559 i‡(!(
Êags
 & 
MCP_UC
) &&

560 (
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)))

563 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

564 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

565 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

566 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

568 i‡(!(
Êags
 & 
MCP_TIMESTAMP
))

569 
m
.
tsc
 = 0;

574 i‡(!(
Êags
 & 
MCP_DONTLOG
Ë&& !
m˚_d⁄t_log_˚
) {

575 
	`m˚_log
(&
m
);

576 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

582 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

590 
	`sync_c‹e
();

591 
	}
}

592 
EXPORT_SYMBOL_GPL
(
machöe_check_pﬁl
);

598 
	$m˚_no_way_out
(
m˚
 *
m
, **
msg
)

600 
i
;

602 
i
 = 0; i < 
b™ks
; i++) {

603 
m
->
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

604 i‡(
	`m˚_£vîôy
(
m
, 
tﬁî™t
, 
msg
Ë>
MCE_PANIC_SEVERITY
)

608 
	}
}

614 
©omic_t
 
	gm˚_executög
;

619 
©omic_t
 
	gm˚_ˇŒö
;

624 
	$m˚_timed_out
(
u64
 *
t
)

632 
	`rmb
();

633 i‡(
	`©omic_ªad
(&
m˚_∑ni˚d
))

634 
	`waô_f‹_∑nic
();

635 i‡(!
m⁄¨ch_timeout
)

636 
out
;

637 i‡((
s64
)*
t
 < 
SPINUNIT
) {

639 i‡(
tﬁî™t
 < 1)

640 
	`m˚_∑nic
("Timeout synchronizing machine check over CPUs",

641 
NULL
, NULL);

642 
˝u_missög
 = 1;

645 *
t
 -
SPINUNIT
;

646 
out
:

647 
	`touch_nmi_w©chdog
();

649 
	}
}

675 
	$m˚_ªign
()

677 
˝u
;

678 
m˚
 *
m
 = 
NULL
;

679 
globÆ_w‹°
 = 0;

680 *
msg
 = 
NULL
;

681 *
nmsg
 = 
NULL
;

688 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

689 
£vîôy
 = 
	`m˚_£vîôy
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 
tﬁî™t
,

690 &
nmsg
);

691 i‡(
£vîôy
 > 
globÆ_w‹°
) {

692 
msg
 = 
nmsg
;

693 
globÆ_w‹°
 = 
£vîôy
;

694 
m
 = &
	`≥r_˝u
(
m˚s_£í
, 
˝u
);

703 i‡(
m
 && 
globÆ_w‹°
 >
MCE_PANIC_SEVERITY
 && 
tﬁî™t
 < 3)

704 
	`m˚_∑nic
("F©Æ Machöêcheck", 
m
, 
msg
);

716 i‡(
globÆ_w‹°
 <
MCE_KEEP_SEVERITY
 && 
tﬁî™t
 < 3)

717 
	`m˚_∑nic
("Machöêcheck from unknow¿sour˚", 
NULL
, NULL);

723 
	`f‹_óch_possibÀ_˝u
(
˝u
)

724 
	`mem£t
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 0, (
m˚
));

725 
	}
}

727 
©omic_t
 
	gglobÆ_nwo
;

736 
	$m˚_°¨t
(*
no_way_out
)

738 
‹dî
;

739 
˝us
 = 
	`num_⁄löe_˝us
();

740 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

742 i‡(!
timeout
)

745 
	`©omic_add
(*
no_way_out
, &
globÆ_nwo
);

749 
	`smp_wmb
();

750 
‹dî
 = 
	`©omic_öc_ªtu∫
(&
m˚_ˇŒö
);

755 
	`©omic_ªad
(&
m˚_ˇŒö
Ë!
˝us
) {

756 i‡(
	`m˚_timed_out
(&
timeout
)) {

757 
	`©omic_£t
(&
globÆ_nwo
, 0);

760 
	`ndñay
(
SPINUNIT
);

766 
	`smp_rmb
();

768 i‡(
‹dî
 == 1) {

772 
	`©omic_£t
(&
m˚_executög
, 1);

780 
	`©omic_ªad
(&
m˚_executög
Ë< 
‹dî
) {

781 i‡(
	`m˚_timed_out
(&
timeout
)) {

782 
	`©omic_£t
(&
globÆ_nwo
, 0);

785 
	`ndñay
(
SPINUNIT
);

792 *
no_way_out
 = 
	`©omic_ªad
(&
globÆ_nwo
);

794  
‹dî
;

795 
	}
}

801 
	$m˚_íd
(
‹dî
)

803 
ªt
 = -1;

804 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

806 i‡(!
timeout
)

807 
ª£t
;

808 i‡(
‹dî
 < 0)

809 
ª£t
;

814 
	`©omic_öc
(&
m˚_executög
);

816 i‡(
‹dî
 == 1) {

818 
˝us
 = 
	`num_⁄löe_˝us
();

824 
	`©omic_ªad
(&
m˚_executög
Ë<
˝us
) {

825 i‡(
	`m˚_timed_out
(&
timeout
))

826 
ª£t
;

827 
	`ndñay
(
SPINUNIT
);

830 
	`m˚_ªign
();

831 
	`b¨rõr
();

832 
ªt
 = 0;

837 
	`©omic_ªad
(&
m˚_executög
) != 0) {

838 i‡(
	`m˚_timed_out
(&
timeout
))

839 
ª£t
;

840 
	`ndñay
(
SPINUNIT
);

852 
ª£t
:

853 
	`©omic_£t
(&
globÆ_nwo
, 0);

854 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

855 
	`b¨rõr
();

860 
	`©omic_£t
(&
m˚_executög
, 0);

861  
ªt
;

862 
	}
}

870 
	$m˚_ußbÀ_addªss
(
m˚
 *
m
)

872 i‡(!(
m
->
°©us
 & 
MCI_STATUS_MISCV
Ë|| !(m->°©u†& 
MCI_STATUS_ADDRV
))

874 i‡((
m
->
misc
 & 0x3fË> 
PAGE_SHIFT
)

876 i‡(((
m
->
misc
 >> 6Ë& 7Ë!
MCM_ADDR_PHYS
)

879 
	}
}

881 
	$m˚_˛ór_°©e
(*
to˛ór
)

883 
i
;

885 
i
 = 0; i < 
b™ks
; i++) {

886 i‡(
	`ã°_bô
(
i
, 
to˛ór
))

887 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

889 
	}
}

903 
	$do_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

905 
m˚
 
m
, *
föÆ
;

906 
i
;

907 
w‹°
 = 0;

908 
£vîôy
;

913 
‹dî
;

918 
no_way_out
 = 0;

923 
kûl_ô
 = 0;

924 
	`DECLARE_BITMAP
(
to˛ór
, 
MAX_NR_BANKS
);

925 *
msg
 = "Unknown";

927 
	`©omic_öc
(&
m˚_íåy
);

929 
	`__gë_˝u_v¨
(
m˚_ex˚±i⁄_cou¡
)++;

931 i‡(
	`nŸify_dõ
(
DIE_NMI
, "machöêcheck", 
ªgs
, 
îr‹_code
,

932 18, 
SIGKILL
Ë=
NOTIFY_STOP
)

933 
out
;

934 i‡(!
b™ks
)

935 
out
;

937 
	`m˚_£tup
(&
m
);

939 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

940 
föÆ
 = &
	`__gë_˝u_v¨
(
m˚s_£í
);

941 *
föÆ
 = 
m
;

943 
no_way_out
 = 
	`m˚_no_way_out
(&
m
, &
msg
);

945 
	`b¨rõr
();

950 i‡(!(
m
.
mcg°©us
 & 
MCG_STATUS_RIPV
))

951 
kûl_ô
 = 1;

958 
‹dî
 = 
	`m˚_°¨t
(&
no_way_out
);

959 
i
 = 0; i < 
b™ks
; i++) {

960 
	`__˛ór_bô
(
i
, 
to˛ór
);

961 i‡(!
m˚_b™ks
[
i
].
˘l
)

964 
m
.
misc
 = 0;

965 
m
.
addr
 = 0;

966 
m
.
b™k
 = 
i
;

968 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

969 i‡((
m
.
°©us
 & 
MCI_STATUS_VAL
) == 0)

976 i‡(!(
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)) &&

977 !
no_way_out
)

983 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

985 
£vîôy
 = 
	`m˚_£vîôy
(&
m
, 
tﬁî™t
, 
NULL
);

991 i‡(
£vîôy
 =
MCE_KEEP_SEVERITY
 && !
no_way_out
)

993 
	`__£t_bô
(
i
, 
to˛ór
);

994 i‡(
£vîôy
 =
MCE_NO_SEVERITY
) {

1005 i‡(
£vîôy
 =
MCE_AR_SEVERITY
)

1006 
kûl_ô
 = 1;

1008 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

1009 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

1010 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

1011 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

1020 i‡(
£vîôy
 =
MCE_AO_SEVERITY
 && 
	`m˚_ußbÀ_addªss
(&
m
))

1021 
	`m˚_rög_add
(
m
.
addr
 >> 
PAGE_SHIFT
);

1023 
	`m˚_gë_rù
(&
m
, 
ªgs
);

1024 
	`m˚_log
(&
m
);

1026 i‡(
£vîôy
 > 
w‹°
) {

1027 *
föÆ
 = 
m
;

1028 
w‹°
 = 
£vîôy
;

1032 i‡(!
no_way_out
)

1033 
	`m˚_˛ór_°©e
(
to˛ór
);

1039 i‡(
	`m˚_íd
(
‹dî
) < 0)

1040 
no_way_out
 = 
w‹°
 >
MCE_PANIC_SEVERITY
;

1049 i‡(
no_way_out
 && 
tﬁî™t
 < 3)

1050 
	`m˚_∑nic
("F©Æ machöêcheck o¿cuºíàCPU", 
föÆ
, 
msg
);

1059 i‡(
kûl_ô
 && 
tﬁî™t
 < 3)

1060 
	`f‹˚_sig
(
SIGBUS
, 
cuºít
);

1063 
	`£t_thªad_Êag
(
TIF_MCE_NOTIFY
);

1065 i‡(
w‹°
 > 0)

1066 
	`m˚_ªp‹t_evít
(
ªgs
);

1067 
	`m˚_wrm§l
(
MSR_IA32_MCG_STATUS
, 0);

1068 
out
:

1069 
	`©omic_dec
(&
m˚_íåy
);

1070 
	`sync_c‹e
();

1071 
	}
}

1072 
EXPORT_SYMBOL_GPL
(
do_machöe_check
);

1075 
__©åibuã__
((
wók
)Ë
	$mem‹y_Áûuª
(
p‚
, 
ve˘‹
)

1077 
	`¥ötk
(
KERN_ERR
 "A˘i⁄ o±i⁄Æ mem‹y faûuªáà%lx ign‹ed\n", 
p‚
);

1078 
	}
}

1091 
	$m˚_nŸify_¥o˚ss
()

1093 
p‚
;

1094 
	`m˚_nŸify_úq
();

1095 
	`m˚_rög_gë
(&
p‚
))

1096 
	`mem‹y_Áûuª
(
p‚
, 
MCE_VECTOR
);

1097 
	}
}

1099 
	$m˚_¥o˚ss_w‹k
(
w‹k_°ru˘
 *
dummy
)

1101 
	`m˚_nŸify_¥o˚ss
();

1102 
	}
}

1104 #ifde‡
CONFIG_X86_MCE_INTEL


1118 
	$m˚_log_thîm_thrŸ_evít
(
__u64
 
°©us
)

1120 
m˚
 
m
;

1122 
	`m˚_£tup
(&
m
);

1123 
m
.
b™k
 = 
MCE_THERMAL_BANK
;

1124 
m
.
°©us
 = status;

1125 
	`m˚_log
(&
m
);

1126 
	}
}

1134 
	gcheck_öãrvÆ
 = 5 * 60;

1136 
DEFINE_PER_CPU
(, 
m˚_√xt_öãrvÆ
);

1137 
DEFINE_PER_CPU
(
timî_li°
, 
m˚_timî
);

1139 
	$m˚_°¨t_timî
(
d©a
)

1141 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
d©a
);

1142 *
n
;

1144 
	`WARN_ON
(
	`smp_¥o˚ss‹_id
(Ë!
d©a
);

1146 i‡(
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
)) {

1147 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

1148 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

1155 
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1156 i‡(
	`m˚_nŸify_úq
())

1157 *
n
 = 
	`max
(*n/2, 
HZ
/100);

1159 *
n
 = 
	`mö
(*n*2, ()
	`round_jiffõs_ªœtive
(
check_öãrvÆ
*
HZ
));

1161 
t
->
expúes
 = 
jiffõs
 + *
n
;

1162 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1163 
	}
}

1165 
	$m˚_do_åiggî
(
w‹k_°ru˘
 *
w‹k
)

1167 
	`ˇŒ_u£rmodehñ≥r
(
m˚_hñ≥r
, 
m˚_hñ≥r_¨gv
, 
NULL
, 
UMH_NO_WAIT
);

1168 
	}
}

1170 
DECLARE_WORK
(
m˚_åiggî_w‹k
, 
m˚_do_åiggî
);

1177 
	$m˚_nŸify_úq
()

1180 
	`DEFINE_RATELIMIT_STATE
(
øãlimô
, 60*
HZ
, 2);

1182 
	`˛ór_thªad_Êag
(
TIF_MCE_NOTIFY
);

1184 i‡(
	`ã°_™d_˛ór_bô
(0, &
m˚_√ed_nŸify
)) {

1185 
	`wake_up_öãºu±ibÀ
(&
m˚_waô
);

1192 i‡(
m˚_hñ≥r
[0] && !
	`w‹k_≥ndög
(&
m˚_åiggî_w‹k
))

1193 
	`scheduÀ_w‹k
(&
m˚_åiggî_w‹k
);

1195 i‡(
	`__øãlimô
(&
øãlimô
))

1196 
	`¥ötk
(
KERN_INFO
 "Machine checkÉventsÜogged\n");

1201 
	}
}

1202 
EXPORT_SYMBOL_GPL
(
m˚_nŸify_úq
);

1204 
__˝uöô
 
	$__mcheck_˝u_m˚_b™ks_öô
()

1206 
i
;

1208 
m˚_b™ks
 = 
	`kzÆloc
(
b™ks
 * (
m˚_b™k
), 
GFP_KERNEL
);

1209 i‡(!
m˚_b™ks
)

1210  -
ENOMEM
;

1211 
i
 = 0; i < 
b™ks
; i++) {

1212 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1214 
b
->
˘l
 = -1ULL;

1215 
b
->
öô
 = 1;

1218 
	}
}

1223 
__˝uöô
 
	$__mcheck_˝u_ˇp_öô
()

1225 
b
;

1226 
u64
 
ˇp
;

1228 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1230 
b
 = 
ˇp
 & 
MCG_BANKCNT_MASK
;

1231 i‡(!
b™ks
)

1232 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
b
);

1234 i‡(
b
 > 
MAX_NR_BANKS
) {

1235 
	`¥ötk
(
KERN_WARNING


1237 
MAX_NR_BANKS
, 
b
);

1238 
b
 = 
MAX_NR_BANKS
;

1242 
	`WARN_ON
(
b™ks
 !0 && 
b
 != banks);

1243 
b™ks
 = 
b
;

1244 i‡(!
m˚_b™ks
) {

1245 
îr
 = 
	`__mcheck_˝u_m˚_b™ks_öô
();

1247 i‡(
îr
)

1248  
îr
;

1252 i‡((
ˇp
 & 
MCG_EXT_P
Ë&& 
	`MCG_EXT_CNT
(cap) >= 9)

1253 
rù_m§
 = 
MSR_IA32_MCG_EIP
;

1255 i‡(
ˇp
 & 
MCG_SER_P
)

1256 
m˚_£r
 = 1;

1259 
	}
}

1261 
	$__mcheck_˝u_öô_gíîic
()

1263 
m˚_b™ks_t
 
Æl_b™ks
;

1264 
u64
 
ˇp
;

1265 
i
;

1270 
	`bôm≠_fûl
(
Æl_b™ks
, 
MAX_NR_BANKS
);

1271 
	`machöe_check_pﬁl
(
MCP_UC
|(!
m˚_boŸlog
 ? 
MCP_DONTLOG
 : 0), &
Æl_b™ks
);

1273 
	`£t_ö_¸4
(
X86_CR4_MCE
);

1275 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1276 i‡(
ˇp
 & 
MCG_CTL_P
)

1277 
	`wrm§
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

1279 
i
 = 0; i < 
b™ks
; i++) {

1280 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1282 i‡(!
b
->
öô
)

1284 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1285 
	`wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

1287 
	}
}

1290 
__˝uöô
 
	$__mcheck_˝u_≠∂y_quúks
(
˝uöfo_x86
 *
c
)

1292 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_UNKNOWN
) {

1293 
	`¥_öfo
("MCE: unknown CPUÅype -ÇotÉnabling MCE support.\n");

1294  -
EOPNOTSUPP
;

1298 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
) {

1299 i‡(
c
->
x86
 =15 && 
b™ks
 > 4) {

1305 
	`˛ór_bô
(10, (*)&
m˚_b™ks
[4].
˘l
);

1307 i‡(
c
->
x86
 <17 && 
m˚_boŸlog
 < 0) {

1312 
m˚_boŸlog
 = 0;

1318 i‡(
c
->
x86
 =6 && 
b™ks
 > 0)

1319 
m˚_b™ks
[0].
˘l
 = 0;

1322 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

1332 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 0x1A && 
b™ks
 > 0)

1333 
m˚_b™ks
[0].
öô
 = 0;

1339 i‡((
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xe)) &&

1340 
m⁄¨ch_timeout
 < 0)

1341 
m⁄¨ch_timeout
 = 
USEC_PER_SEC
;

1347 i‡(
c
->
x86
 =6 && c->
x86_modñ
 <13 && 
m˚_boŸlog
 < 0)

1348 
m˚_boŸlog
 = 0;

1350 i‡(
m⁄¨ch_timeout
 < 0)

1351 
m⁄¨ch_timeout
 = 0;

1352 i‡(
m˚_boŸlog
 != 0)

1353 
m˚_∑nic_timeout
 = 30;

1356 
	}
}

1358 
__˝uöô
 
	$__mcheck_˝u_™cõ¡_öô
(
˝uöfo_x86
 *
c
)

1360 i‡(
c
->
x86
 != 5)

1362 
c
->
x86_víd‹
) {

1363 
X86_VENDOR_INTEL
:

1364 
	`öãl_p5_mcheck_öô
(
c
);

1366 
X86_VENDOR_CENTAUR
:

1367 
	`wöchù_mcheck_öô
(
c
);

1370 
	}
}

1372 
	$__mcheck_˝u_öô_víd‹
(
˝uöfo_x86
 *
c
)

1374 
c
->
x86_víd‹
) {

1375 
X86_VENDOR_INTEL
:

1376 
	`m˚_öãl_„©uª_öô
(
c
);

1378 
X86_VENDOR_AMD
:

1379 
	`m˚_amd_„©uª_öô
(
c
);

1384 
	}
}

1386 
	$__mcheck_˝u_öô_timî
()

1388 
timî_li°
 *
t
 = &
	`__gë_˝u_v¨
(
m˚_timî
);

1389 *
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1391 
	`£tup_timî
(
t
, 
m˚_°¨t_timî
, 
	`smp_¥o˚ss‹_id
());

1393 i‡(
m˚_ign‹e_˚
)

1396 *
n
 = 
check_öãrvÆ
 * 
HZ
;

1397 i‡(!*
n
)

1399 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 + *
n
);

1400 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1401 
	}
}

1404 
	$u√x≥˘ed_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

1406 
	`¥ötk
(
KERN_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

1407 
	`smp_¥o˚ss‹_id
());

1408 
	}
}

1411 (*
machöe_check_ve˘‹
)(
±_ªgs
 *, 
îr‹_code
) =

1412 
u√x≥˘ed_machöe_check
;

1418 
__˝uöô
 
	$mcheck_˝u_öô
(
˝uöfo_x86
 *
c
)

1420 i‡(
m˚_dißbÀd
)

1423 
	`__mcheck_˝u_™cõ¡_öô
(
c
);

1425 i‡(!
	`m˚_avaûabÀ
(
c
))

1428 i‡(
	`__mcheck_˝u_ˇp_öô
(Ë< 0 || 
	`__mcheck_˝u_≠∂y_quúks
(
c
) < 0) {

1429 
m˚_dißbÀd
 = 1;

1433 
machöe_check_ve˘‹
 = 
do_machöe_check
;

1435 
	`__mcheck_˝u_öô_gíîic
();

1436 
	`__mcheck_˝u_öô_víd‹
(
c
);

1437 
	`__mcheck_˝u_öô_timî
();

1438 
	`INIT_WORK
(&
	`__gë_˝u_v¨
(
m˚_w‹k
), 
m˚_¥o˚ss_w‹k
);

1440 
	}
}

1446 
DEFINE_SPINLOCK
(
m˚_°©e_lock
);

1447 
	g›í_cou¡
;

1448 
	g›í_ex˛u
;

1450 
	$m˚_›í
(
öode
 *öode, 
fûe
 *file)

1452 
	`•ö_lock
(&
m˚_°©e_lock
);

1454 i‡(
›í_ex˛u
 || (
›í_cou¡
 && (
fûe
->
f_Êags
 & 
O_EXCL
))) {

1455 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1457  -
EBUSY
;

1460 i‡(
fûe
->
f_Êags
 & 
O_EXCL
)

1461 
›í_ex˛u
 = 1;

1462 
›í_cou¡
++;

1464 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1466  
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
);

1467 
	}
}

1469 
	$m˚_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1471 
	`•ö_lock
(&
m˚_°©e_lock
);

1473 
›í_cou¡
--;

1474 
›í_ex˛u
 = 0;

1476 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1479 
	}
}

1481 
	$cﬁÀ˘_tscs
(*
d©a
)

1483 *
˝u_tsc
 = (*)
d©a
;

1485 
	`rdts˛l
(
˝u_tsc
[
	`smp_¥o˚ss‹_id
()]);

1486 
	}
}

1488 
DEFINE_MUTEX
(
m˚_ªad_muãx
);

1490 
ssize_t
 
	$m˚_ªad
(
fûe
 *
fûp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

1491 
loff_t
 *
off
)

1493 
__u£r
 *
buf
 = 
ubuf
;

1494 *
˝u_tsc
;

1495 
¥ev
, 
√xt
;

1496 
i
, 
îr
;

1498 
˝u_tsc
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

1499 i‡(!
˝u_tsc
)

1500  -
ENOMEM
;

1502 
	`muãx_lock
(&
m˚_ªad_muãx
);

1503 
√xt
 = 
	`rcu_dîe„ªn˚
(
m˚log
.next);

1506 i‡(*
off
 !0 || 
usize
 < 
MCE_LOG_LEN
*(
m˚
)) {

1507 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1508 
	`k‰ì
(
˝u_tsc
);

1510  -
EINVAL
;

1513 
îr
 = 0;

1514 
¥ev
 = 0;

1516 
i
 = 
¥ev
; i < 
√xt
; i++) {

1517 
°¨t
 = 
jiffõs
;

1519 !
m˚log
.
íåy
[
i
].
föished
) {

1520 i‡(
	`time_a·î_eq
(
jiffõs
, 
°¨t
 + 2)) {

1521 
	`mem£t
(
m˚log
.
íåy
 + 
i
, 0,

1522 (
m˚
));

1523 
timeout
;

1525 
	`˝u_ªœx
();

1527 
	`smp_rmb
();

1528 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
 + 
i
,

1529 (
m˚
));

1530 
buf
 +(
m˚
);

1531 
timeout
:

1535 
	`mem£t
(
m˚log
.
íåy
 + 
¥ev
, 0,

1536 (
√xt
 - 
¥ev
Ë* (
m˚
));

1537 
¥ev
 = 
√xt
;

1538 
√xt
 = 
	`cmpxchg
(&
m˚log
.√xt, 
¥ev
, 0);

1539 } 
√xt
 !
¥ev
);

1541 
	`synchr⁄ize_sched
();

1547 
	`⁄_óch_˝u
(
cﬁÀ˘_tscs
, 
˝u_tsc
, 1);

1549 
i
 = 
√xt
; i < 
MCE_LOG_LEN
; i++) {

1550 i‡(
m˚log
.
íåy
[
i
].
föished
 &&

1551 
m˚log
.
íåy
[
i
].
tsc
 < 
˝u_tsc
[m˚log.íåy[i].
˝u
]) {

1552 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
+
i
,

1553 (
m˚
));

1554 
	`smp_rmb
();

1555 
buf
 +(
m˚
);

1556 
	`mem£t
(&
m˚log
.
íåy
[
i
], 0, (
m˚
));

1559 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1560 
	`k‰ì
(
˝u_tsc
);

1562  
îr
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

1563 
	}
}

1565 
	$m˚_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

1567 
	`pﬁl_waô
(
fûe
, &
m˚_waô
, 
waô
);

1568 i‡(
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
))

1569  
POLLIN
 | 
POLLRDNORM
;

1571 
	}
}

1573 
	$m˚_io˘l
(
fûe
 *
f
, 
cmd
, 
¨g
)

1575 
__u£r
 *
p
 = (__u£∏*)
¨g
;

1577 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1578  -
EPERM
;

1580 
cmd
) {

1581 
MCE_GET_RECORD_LEN
:

1582  
	`put_u£r
((
m˚
), 
p
);

1583 
MCE_GET_LOG_LEN
:

1584  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

1585 
MCE_GETCLEAR_FLAGS
: {

1586 
Êags
;

1589 
Êags
 = 
m˚log
.flags;

1590 } 
	`cmpxchg
(&
m˚log
.
Êags
, flags, 0) != flags);

1592  
	`put_u£r
(
Êags
, 
p
);

1595  -
ENOTTY
;

1597 
	}
}

1600 
fûe_›î©i⁄s
 
	gm˚_chrdev_›s
 = {

1601 .
›í
 = 
m˚_›í
,

1602 .
	gªÀa£
 = 
m˚_ªÀa£
,

1603 .
	gªad
 = 
m˚_ªad
,

1604 .
	gpﬁl
 = 
m˚_pﬁl
,

1605 .
	gu∆ocked_io˘l
 = 
m˚_io˘l
,

1607 
EXPORT_SYMBOL_GPL
(
m˚_chrdev_›s
);

1609 
miscdevi˚
 
	gm˚_log_devi˚
 = {

1610 
MISC_MCELOG_MINOR
,

1612 &
m˚_chrdev_›s
,

1626 
__öô
 
	$mcheck_íabÀ
(*
°r
)

1628 i‡(*
°r
 == 0) {

1629 
	`íabÀ_p5_m˚
();

1632 i‡(*
°r
 == '=')

1633 
°r
++;

1634 i‡(!
	`°rcmp
(
°r
, "off"))

1635 
m˚_dißbÀd
 = 1;

1636 i‡(!
	`°rcmp
(
°r
, "no_cmci"))

1637 
m˚_cmci_dißbÀd
 = 1;

1638 i‡(!
	`°rcmp
(
°r
, "dont_log_ce"))

1639 
m˚_d⁄t_log_˚
 = 1;

1640 i‡(!
	`°rcmp
(
°r
, "ignore_ce"))

1641 
m˚_ign‹e_˚
 = 1;

1642 i‡(!
	`°rcmp
(
°r
, "bootlog") || !strcmp(str, "nobootlog"))

1643 
m˚_boŸlog
 = (
°r
[0] == 'b');

1644 i‡(
	`isdigô
(
°r
[0])) {

1645 
	`gë_›ti⁄
(&
°r
, &
tﬁî™t
);

1646 i‡(*
°r
 == ',') {

1647 ++
°r
;

1648 
	`gë_›ti⁄
(&
°r
, &
m⁄¨ch_timeout
);

1651 
	`¥ötk
(
KERN_INFO
 "mceárgument %s ignored. Please use /sys\n",

1652 
°r
);

1656 
	}
}

1657 
__£tup
("m˚", 
mcheck_íabÀ
);

1659 
__öô
 
	$mcheck_öô
()

1661 
	`©omic_nŸifõr_chaö_ªgi°î
(&
x86_m˚_decodî_chaö
, &
m˚_dec_nb
);

1663 
	`mcheck_öãl_thîm_öô
();

1666 
	}
}

1676 
	$m˚_dißbÀ_îr‹_ªp‹tög
()

1678 
i
;

1680 
i
 = 0; i < 
b™ks
; i++) {

1681 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1683 i‡(
b
->
öô
)

1684 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1687 
	}
}

1689 
	$m˚_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1691  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1692 
	}
}

1694 
	$m˚_shutdown
(
sys_devi˚
 *
dev
)

1696  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1697 
	}
}

1704 
	$m˚_ªsume
(
sys_devi˚
 *
dev
)

1706 
	`__mcheck_˝u_öô_gíîic
();

1707 
	`__mcheck_˝u_öô_víd‹
(&
cuºít_˝u_d©a
);

1710 
	}
}

1712 
	$m˚_˝u_ª°¨t
(*
d©a
)

1714 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1715 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1717 
	`__mcheck_˝u_öô_gíîic
();

1718 
	`__mcheck_˝u_öô_timî
();

1719 
	}
}

1722 
	$m˚_ª°¨t
()

1724 
	`⁄_óch_˝u
(
m˚_˝u_ª°¨t
, 
NULL
, 1);

1725 
	}
}

1728 
	$m˚_dißbÀ_˚
(*
Æl
)

1730 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1732 i‡(
Æl
)

1733 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1734 
	`cmci_˛ór
();

1735 
	}
}

1737 
	$m˚_íabÀ_˚
(*
Æl
)

1739 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1741 
	`cmci_ªíabÀ
();

1742 
	`cmci_ªcheck
();

1743 i‡(
Æl
)

1744 
	`__mcheck_˝u_öô_timî
();

1745 
	}
}

1747 
sysdev_˛ass
 
	gm˚_sys˛ass
 = {

1748 .
su•íd
 = 
m˚_su•íd
,

1749 .
	gshutdown
 = 
m˚_shutdown
,

1750 .
	gªsume
 = 
m˚_ªsume
,

1751 .
	g«me
 = "machinecheck",

1754 
DEFINE_PER_CPU
(
sys_devi˚
, 
m˚_dev
);

1756 
__˝uöôd©a


1757 (*
thªshﬁd_˝u_ˇŒback
)(
a˘i⁄
, 
˝u
);

1759 
ölöe
 
m˚_b™k
 *
	$©å_to_b™k
(
sysdev_©åibuã
 *
©å
)

1761  
	`c⁄èöî_of
(
©å
, 
m˚_b™k
,áttr);

1762 
	}
}

1764 
ssize_t
 
	$show_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1765 *
buf
)

1767  
	`•rötf
(
buf
, "%Œx\n", 
	`©å_to_b™k
(
©å
)->
˘l
);

1768 
	}
}

1770 
ssize_t
 
	$£t_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1771 c⁄° *
buf
, 
size_t
 
size
)

1773 
u64
 
√w
;

1775 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1776  -
EINVAL
;

1778 
	`©å_to_b™k
(
©å
)->
˘l
 = 
√w
;

1779 
	`m˚_ª°¨t
();

1781  
size
;

1782 
	}
}

1784 
ssize_t


1785 
	$show_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
, *
buf
)

1787 
	`°r˝y
(
buf
, 
m˚_hñ≥r
);

1788 
	`°rˇt
(
buf
, "\n");

1789  
	`°æí
(
m˚_hñ≥r
) + 1;

1790 
	}
}

1792 
ssize_t
 
	$£t_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1793 c⁄° *
buf
, 
size_t
 
siz
)

1795 *
p
;

1797 
	`°∫˝y
(
m˚_hñ≥r
, 
buf
, (mce_helper));

1798 
m˚_hñ≥r
[(mce_helper)-1] = 0;

1799 
p
 = 
	`°rchr
(
m˚_hñ≥r
, '\n');

1801 i‡(
p
)

1802 *
p
 = 0;

1804  
	`°æí
(
m˚_hñ≥r
Ë+ !!
p
;

1805 
	}
}

1807 
ssize_t
 
	$£t_ign‹e_˚
(
sys_devi˚
 *
s
,

1808 
sysdev_©åibuã
 *
©å
,

1809 c⁄° *
buf
, 
size_t
 
size
)

1811 
u64
 
√w
;

1813 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1814  -
EINVAL
;

1816 i‡(
m˚_ign‹e_˚
 ^ !!
√w
) {

1817 i‡(
√w
) {

1819 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, (*)1, 1);

1820 
m˚_ign‹e_˚
 = 1;

1823 
m˚_ign‹e_˚
 = 0;

1824 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, (*)1, 1);

1827  
size
;

1828 
	}
}

1830 
ssize_t
 
	$£t_cmci_dißbÀd
(
sys_devi˚
 *
s
,

1831 
sysdev_©åibuã
 *
©å
,

1832 c⁄° *
buf
, 
size_t
 
size
)

1834 
u64
 
√w
;

1836 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1837  -
EINVAL
;

1839 i‡(
m˚_cmci_dißbÀd
 ^ !!
√w
) {

1840 i‡(
√w
) {

1842 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, 
NULL
, 1);

1843 
m˚_cmci_dißbÀd
 = 1;

1846 
m˚_cmci_dißbÀd
 = 0;

1847 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, 
NULL
, 1);

1850  
size
;

1851 
	}
}

1853 
ssize_t
 
	$°‹e_öt_wôh_ª°¨t
(
sys_devi˚
 *
s
,

1854 
sysdev_©åibuã
 *
©å
,

1855 c⁄° *
buf
, 
size_t
 
size
)

1857 
ssize_t
 
ªt
 = 
	`sysdev_°‹e_öt
(
s
, 
©å
, 
buf
, 
size
);

1858 
	`m˚_ª°¨t
();

1859  
ªt
;

1860 
	}
}

1862 
SYSDEV_ATTR
(
åiggî
, 0644, 
show_åiggî
, 
£t_åiggî
);

1863 
SYSDEV_INT_ATTR
(
tﬁî™t
, 0644,Åolerant);

1864 
SYSDEV_INT_ATTR
(
m⁄¨ch_timeout
, 0644, monarch_timeout);

1865 
SYSDEV_INT_ATTR
(
d⁄t_log_˚
, 0644, 
m˚_d⁄t_log_˚
);

1867 
sysdev_ext_©åibuã
 
	g©å_check_öãrvÆ
 = {

1868 
_SYSDEV_ATTR
(
check_öãrvÆ
, 0644, 
sysdev_show_öt
,

1869 
°‹e_öt_wôh_ª°¨t
),

1870 &
check_öãrvÆ


1873 
sysdev_ext_©åibuã
 
	g©å_ign‹e_˚
 = {

1874 
_SYSDEV_ATTR
(
ign‹e_˚
, 0644, 
sysdev_show_öt
, 
£t_ign‹e_˚
),

1875 &
m˚_ign‹e_˚


1878 
sysdev_ext_©åibuã
 
	g©å_cmci_dißbÀd
 = {

1879 
_SYSDEV_ATTR
(
cmci_dißbÀd
, 0644, 
sysdev_show_öt
, 
£t_cmci_dißbÀd
),

1880 &
m˚_cmci_dißbÀd


1883 
sysdev_©åibuã
 *
	gm˚_©ås
[] = {

1884 &
©å_tﬁî™t
.
©å
,

1885 &
©å_check_öãrvÆ
.
©å
,

1886 &
©å_åiggî
,

1887 &
©å_m⁄¨ch_timeout
.
©å
,

1888 &
©å_d⁄t_log_˚
.
©å
,

1889 &
©å_ign‹e_˚
.
©å
,

1890 &
©å_cmci_dißbÀd
.
©å
,

1891 
NULL


1894 
˝umask_v¨_t
 
	gm˚_dev_öôülized
;

1897 
__˝uöô
 
	$m˚_¸óã_devi˚
(
˝u
)

1899 
îr
;

1900 
i
, 
j
;

1902 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1903  -
EIO
;

1905 
	`mem£t
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 0, (
kobje˘
));

1906 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
id
 = cpu;

1907 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
˛s
 = &
m˚_sys˛ass
;

1909 
îr
 = 
	`sysdev_ªgi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1910 i‡(
îr
)

1911  
îr
;

1913 
i
 = 0; 
m˚_©ås
[i]; i++) {

1914 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1915 i‡(
îr
)

1916 
îr‹
;

1918 
j
 = 0; j < 
b™ks
; j++) {

1919 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
),

1920 &
m˚_b™ks
[
j
].
©å
);

1921 i‡(
îr
)

1922 
îr‹2
;

1924 
	`˝umask_£t_˝u
(
˝u
, 
m˚_dev_öôülized
);

1927 
îr‹2
:

1928 --
j
 >= 0)

1929 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
j
].
©å
);

1930 
îr‹
:

1931 --
i
 >= 0)

1932 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1934 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1936  
îr
;

1937 
	}
}

1939 
__˝uöô
 
	$m˚_ªmove_devi˚
(
˝u
)

1941 
i
;

1943 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
m˚_dev_öôülized
))

1946 
i
 = 0; 
m˚_©ås
[i]; i++)

1947 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1949 
i
 = 0; i < 
b™ks
; i++)

1950 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
i
].
©å
);

1952 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1953 
	`˝umask_˛ór_˝u
(
˝u
, 
m˚_dev_öôülized
);

1954 
	}
}

1957 
__˝uöô
 
	$m˚_dißbÀ_˝u
(*
h
)

1959 
a˘i⁄
 = *(*)
h
;

1960 
i
;

1962 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1965 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1966 
	`cmci_˛ór
();

1967 
i
 = 0; i < 
b™ks
; i++) {

1968 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1970 i‡(
b
->
öô
)

1971 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1973 
	}
}

1975 
__˝uöô
 
	$m˚_ªíabÀ_˝u
(*
h
)

1977 
a˘i⁄
 = *(*)
h
;

1978 
i
;

1980 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1983 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1984 
	`cmci_ªíabÀ
();

1985 
i
 = 0; i < 
b™ks
; i++) {

1986 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1988 i‡(
b
->
öô
)

1989 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1991 
	}
}

1994 
__˝uöô


1995 
	$m˚_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
, *
h˝u
)

1997 
˝u
 = ()
h˝u
;

1998 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
˝u
);

2000 
a˘i⁄
) {

2001 
CPU_ONLINE
:

2002 
CPU_ONLINE_FROZEN
:

2003 
	`m˚_¸óã_devi˚
(
˝u
);

2004 i‡(
thªshﬁd_˝u_ˇŒback
)

2005 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2007 
CPU_DEAD
:

2008 
CPU_DEAD_FROZEN
:

2009 i‡(
thªshﬁd_˝u_ˇŒback
)

2010 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2011 
	`m˚_ªmove_devi˚
(
˝u
);

2013 
CPU_DOWN_PREPARE
:

2014 
CPU_DOWN_PREPARE_FROZEN
:

2015 
	`dñ_timî_sync
(
t
);

2016 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_dißbÀ_˝u
, &
a˘i⁄
, 1);

2018 
CPU_DOWN_FAILED
:

2019 
CPU_DOWN_FAILED_FROZEN
:

2020 i‡(!
m˚_ign‹e_˚
 && 
check_öãrvÆ
) {

2021 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 +

2022 
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
));

2023 
	`add_timî_⁄
(
t
, 
˝u
);

2025 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_ªíabÀ_˝u
, &
a˘i⁄
, 1);

2027 
CPU_POST_DEAD
:

2029 
	`cmci_ªdiscovî
(
˝u
);

2032  
NOTIFY_OK
;

2033 
	}
}

2035 
nŸifõr_block
 
m˚_˝u_nŸifõr
 
	g__˝uöôd©a
 = {

2036 .
nŸifõr_ˇŒ
 = 
m˚_˝u_ˇŒback
,

2039 
__öô
 
	$m˚_öô_b™ks
()

2041 
i
;

2043 
i
 = 0; i < 
b™ks
; i++) {

2044 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2045 
sysdev_©åibuã
 *
a
 = &
b
->
©å
;

2047 
a
->
©å
.
«me
 = 
b
->
©å«me
;

2048 
	`¢¥ötf
(
b
->
©å«me
, 
ATTR_LEN
, "b™k%d", 
i
);

2050 
a
->
©å
.
mode
 = 0644;

2051 
a
->
show
 = 
show_b™k
;

2052 
a
->
°‹e
 = 
£t_b™k
;

2054 
	}
}

2056 
__öô
 
	$mcheck_öô_devi˚
()

2058 
îr
;

2059 
i
 = 0;

2061 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

2062  -
EIO
;

2064 
	`zÆloc_˝umask_v¨
(&
m˚_dev_öôülized
, 
GFP_KERNEL
);

2066 
	`m˚_öô_b™ks
();

2068 
îr
 = 
	`sysdev_˛ass_ªgi°î
(&
m˚_sys˛ass
);

2069 i‡(
îr
)

2070  
îr
;

2072 
	`f‹_óch_⁄löe_˝u
(
i
) {

2073 
îr
 = 
	`m˚_¸óã_devi˚
(
i
);

2074 i‡(
îr
)

2075  
îr
;

2078 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m˚_˝u_nŸifõr
);

2079 
	`misc_ªgi°î
(&
m˚_log_devi˚
);

2081  
îr
;

2082 
	}
}

2084 
devi˚_öôˇŒ
(
mcheck_öô_devi˚
);

2089 
__öô
 
	$mcheck_dißbÀ
(*
°r
)

2091 
m˚_dißbÀd
 = 1;

2093 
	}
}

2094 
__£tup
("nom˚", 
mcheck_dißbÀ
);

2096 #ifde‡
CONFIG_DEBUG_FS


2097 
díåy
 *
	$m˚_gë_debugfs_dú
()

2099 
díåy
 *
dm˚
;

2101 i‡(!
dm˚
)

2102 
dm˚
 = 
	`debugfs_¸óã_dú
("m˚", 
NULL
);

2104  
dm˚
;

2105 
	}
}

2107 
	$m˚_ª£t
()

2109 
˝u_missög
 = 0;

2110 
	`©omic_£t
(&
m˚_Áke_∑ni˚d
, 0);

2111 
	`©omic_£t
(&
m˚_executög
, 0);

2112 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

2113 
	`©omic_£t
(&
globÆ_nwo
, 0);

2114 
	}
}

2116 
	$Áke_∑nic_gë
(*
d©a
, 
u64
 *
vÆ
)

2118 *
vÆ
 = 
Áke_∑nic
;

2120 
	}
}

2122 
	$Áke_∑nic_£t
(*
d©a
, 
u64
 
vÆ
)

2124 
	`m˚_ª£t
();

2125 
Áke_∑nic
 = 
vÆ
;

2127 
	}
}

2129 
DEFINE_SIMPLE_ATTRIBUTE
(
Áke_∑nic_f›s
, 
Áke_∑nic_gë
,

2130 
Áke_∑nic_£t
, "%llu\n");

2132 
__öô
 
	$mcheck_debugfs_öô
()

2134 
díåy
 *
dm˚
, *
fÁke_∑nic
;

2136 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

2137 i‡(!
dm˚
)

2138  -
ENOMEM
;

2139 
fÁke_∑nic
 = 
	`debugfs_¸óã_fûe
("Áke_∑nic", 0444, 
dm˚
, 
NULL
,

2140 &
Áke_∑nic_f›s
);

2141 i‡(!
fÁke_∑nic
)

2142  -
ENOMEM
;

2145 
	}
}

2146 
œã_öôˇŒ
(
mcheck_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/kobje˘.h
>

19 
	~<löux/≥r˝u.h
>

20 
	~<löux/sysdev.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/sysfs.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/˝u.h
>

26 
	~<löux/smp.h
>

28 
	~<asm/≠ic.h
>

29 
	~<asm/idÀ.h
>

30 
	~<asm/m˚.h
>

31 
	~<asm/m§.h
>

33 
	#PFX
 "m˚_thªshﬁd: "

	)

34 
	#VERSION
 "vîsi⁄ 1.1.1"

	)

35 
	#NR_BANKS
 6

	)

36 
	#NR_BLOCKS
 9

	)

37 
	#THRESHOLD_MAX
 0xFFF

	)

38 
	#INT_TYPE_APIC
 0x00020000

	)

39 
	#MASK_VALID_HI
 0x80000000

	)

40 
	#MASK_CNTP_HI
 0x40000000

	)

41 
	#MASK_LOCKED_HI
 0x20000000

	)

42 
	#MASK_LVTOFF_HI
 0x00F00000

	)

43 
	#MASK_COUNT_EN_HI
 0x00080000

	)

44 
	#MASK_INT_TYPE_HI
 0x00060000

	)

45 
	#MASK_OVERFLOW_HI
 0x00010000

	)

46 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

47 
	#MASK_BLKPTR_LO
 0xFF000000

	)

48 
	#MCG_XBLK_ADDR
 0xC0000400

	)

50 
	sthªshﬁd_block
 {

51 
	mblock
;

52 
	mb™k
;

53 
	m˝u
;

54 
u32
 
	maddªss
;

55 
u16
 
	möãºu±_íabÀ
;

56 
u16
 
	mthªshﬁd_limô
;

57 
kobje˘
 
	mkobj
;

58 
li°_hód
 
	mmiscj
;

62 
thªshﬁd_block
 
	gthªshﬁd_deÁu…s
 = {

63 .
öãºu±_íabÀ
 = 0,

64 .
	gthªshﬁd_limô
 = 
THRESHOLD_MAX
,

67 
	sthªshﬁd_b™k
 {

68 
kobje˘
 *
	mkobj
;

69 
thªshﬁd_block
 *
	mblocks
;

70 
˝umask_v¨_t
 
	m˝us
;

72 
DEFINE_PER_CPU
(
thªshﬁd_b™k
 * [
NR_BANKS
], 
thªshﬁd_b™ks
);

74 #ifde‡
CONFIG_SMP


75 
	gsh¨ed_b™k
[
NR_BANKS
] = {

80 
DEFINE_PER_CPU
(, 
b™k_m≠
);

82 
amd_thªshﬁd_öãºu±
();

88 
	sthªsh_ª°¨t
 {

89 
thªshﬁd_block
 *
	mb
;

90 
	mª£t
;

91 
u16
 
	mﬁd_limô
;

96 
	$thªshﬁd_ª°¨t_b™k
(*
_å
)

98 
thªsh_ª°¨t
 *
å
 = 
_å
;

99 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

101 
	`rdm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

103 i‡(
å
->
b
->
thªshﬁd_limô
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

104 
å
->
ª£t
 = 1;

106 i‡(
å
->
ª£t
) {

107 
mci_misc_hi
 =

108 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

109 (
THRESHOLD_MAX
 - 
å
->
b
->
thªshﬁd_limô
);

110 } i‡(
å
->
ﬁd_limô
) {

111 
√w_cou¡
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

112 (
å
->
ﬁd_limô
 -År->
b
->
thªshﬁd_limô
);

114 
mci_misc_hi
 = (mci_misc_hò& ~
MASK_ERR_COUNT_HI
) |

115 (
√w_cou¡
 & 
THRESHOLD_MAX
);

118 
å
->
b
->
öãºu±_íabÀ
 ?

119 (
mci_misc_hi
 = (mci_misc_hò& ~
MASK_INT_TYPE_HI
Ë| 
INT_TYPE_APIC
) :

120 (
mci_misc_hi
 &~
MASK_INT_TYPE_HI
);

122 
mci_misc_hi
 |
MASK_COUNT_EN_HI
;

123 
	`wrm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

124 
	}
}

127 
	$m˚_amd_„©uª_öô
(
˝uöfo_x86
 *
c
)

129 
˝u
 = 
	`smp_¥o˚ss‹_id
();

130 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

131 
b™k
, 
block
;

132 
thªsh_ª°¨t
 
å
;

133 
u8
 
lvt_off
;

135 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

136 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

137 i‡(
block
 == 0)

138 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

139 i‡(
block
 == 1) {

140 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

141 i‡(!
addªss
)

143 
addªss
 +
MCG_XBLK_ADDR
;

145 ++
addªss
;

147 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

150 i‡(!(
high
 & 
MASK_VALID_HI
)) {

151 i‡(
block
)

157 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

158 (
high
 & 
MASK_LOCKED_HI
))

161 i‡(!
block
)

162 
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë|(1 << 
b™k
);

163 #ifde‡
CONFIG_SMP


164 i‡(
sh¨ed_b™k
[
b™k
] && 
c
->
˝u_c‹e_id
)

167 
lvt_off
 = 
	`£tup_APIC_eûvt_m˚
(
THRESHOLD_APIC_VECTOR
,

168 
APIC_EILVT_MSG_FIX
, 0);

170 
high
 &~
MASK_LVTOFF_HI
;

171 
high
 |
lvt_off
 << 20;

172 
	`wrm§
(
addªss
, 
low
, 
high
);

174 
thªshﬁd_deÁu…s
.
addªss
 =áddress;

175 
å
.
b
 = &
thªshﬁd_deÁu…s
;

176 
å
.
ª£t
 = 0;

177 
å
.
ﬁd_limô
 = 0;

178 
	`thªshﬁd_ª°¨t_b™k
(&
å
);

180 
m˚_thªshﬁd_ve˘‹
 = 
amd_thªshﬁd_öãºu±
;

183 
	}
}

194 
	$amd_thªshﬁd_öãºu±
()

196 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

197 
b™k
, 
block
;

198 
m˚
 
m
;

200 
	`m˚_£tup
(&
m
);

203 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

204 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
m
.
˝u
Ë& (1 << 
b™k
)))

206 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

207 i‡(
block
 == 0) {

208 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

209 } i‡(
block
 == 1) {

210 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

211 i‡(!
addªss
)

213 
addªss
 +
MCG_XBLK_ADDR
;

215 ++
addªss
;

218 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

221 i‡(!(
high
 & 
MASK_VALID_HI
)) {

222 i‡(
block
)

228 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

229 (
high
 & 
MASK_LOCKED_HI
))

236 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

237 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

239 i‡(
high
 & 
MASK_OVERFLOW_HI
) {

240 
	`rdm§l
(
addªss
, 
m
.
misc
);

241 
	`rdm§l
(
MSR_IA32_MC0_STATUS
 + 
b™k
 * 4,

242 
m
.
°©us
);

243 
m
.
b™k
 = 
K8_MCE_THRESHOLD_BASE


244 + 
b™k
 * 
NR_BLOCKS


245 + 
block
;

246 
	`m˚_log
(&
m
);

251 
	}
}

257 
	sthªshﬁd_©å
 {

258 
©åibuã
 
	m©å
;

259 
ssize_t
 (*
show
Ë(
	mthªshﬁd_block
 *, *);

260 
ssize_t
 (*
°‹e
Ë(
	mthªshﬁd_block
 *, c⁄° *, 
size_t
 
	mcou¡
);

263 
	#SHOW_FIELDS
(
«me
) \

264 
ssize_t
 
show_
 ## 
	`«me
(
thªshﬁd_block
 *
b
, *
buf
) \

266  
	`•rötf
(
buf
, "%lx\n", (Ë
b
->
«me
); \

267 }

	)

268 
	$SHOW_FIELDS
(
öãºu±_íabÀ
)

269 
	$SHOW_FIELDS
(
thªshﬁd_limô
)

271 
ssize_t


272 
	$°‹e_öãºu±_íabÀ
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

274 
thªsh_ª°¨t
 
å
;

275 
√w
;

277 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

278  -
EINVAL
;

280 
b
->
öãºu±_íabÀ
 = !!
√w
;

282 
å
.
b
 = b;

283 
å
.
ª£t
 = 0;

284 
å
.
ﬁd_limô
 = 0;

286 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

288  
size
;

289 
	}
}

291 
ssize_t


292 
	$°‹e_thªshﬁd_limô
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

294 
thªsh_ª°¨t
 
å
;

295 
√w
;

297 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

298  -
EINVAL
;

300 i‡(
√w
 > 
THRESHOLD_MAX
)

301 
√w
 = 
THRESHOLD_MAX
;

302 i‡(
√w
 < 1)

303 
√w
 = 1;

305 
å
.
ﬁd_limô
 = 
b
->
thªshﬁd_limô
;

306 
b
->
thªshﬁd_limô
 = 
√w
;

307 
å
.
b
 = b;

308 
å
.
ª£t
 = 0;

310 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

312  
size
;

313 
	}
}

315 
	sthªshﬁd_block_¸oss_˝u
 {

316 
thªshﬁd_block
 *
	mtb
;

317 
	mªtvÆ
;

320 
	$loˇl_îr‹_cou¡_h™dÀr
(*
_tbcc
)

322 
thªshﬁd_block_¸oss_˝u
 *
tbcc
 = 
_tbcc
;

323 
thªshﬁd_block
 *
b
 = 
tbcc
->
tb
;

324 
u32
 
low
, 
high
;

326 
	`rdm§
(
b
->
addªss
, 
low
, 
high
);

327 
tbcc
->
ªtvÆ
 = (
high
 & 0xFFFË- (
THRESHOLD_MAX
 - 
b
->
thªshﬁd_limô
);

328 
	}
}

330 
ssize_t
 
	$show_îr‹_cou¡
(
thªshﬁd_block
 *
b
, *
buf
)

332 
thªshﬁd_block_¸oss_˝u
 
tbcc
 = { .
tb
 = 
b
, };

334 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
loˇl_îr‹_cou¡_h™dÀr
, &
tbcc
, 1);

335  
	`•rötf
(
buf
, "%lx\n", 
tbcc
.
ªtvÆ
);

336 
	}
}

338 
ssize_t
 
	$°‹e_îr‹_cou¡
(
thªshﬁd_block
 *
b
,

339 c⁄° *
buf
, 
size_t
 
cou¡
)

341 
thªsh_ª°¨t
 
å
 = { .
b
 = b, .
ª£t
 = 1, .
ﬁd_limô
 = 0 };

343 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

345 
	}
}

347 
	#RW_ATTR
(
vÆ
) \

348 
thªshﬁd_©å
 
vÆ
 = { \

349 .
©å
 = {.
«me
 = 
	`__°rögify
(
vÆ
), .
mode
 = 0644 }, \

350 .
show
 = 
show_
## 
vÆ
, \

351 .
°‹e
 = 
°‹e_
## 
vÆ
, \

352 };

	)

354 
RW_ATTR
(
öãºu±_íabÀ
);

355 
RW_ATTR
(
thªshﬁd_limô
);

356 
RW_ATTR
(
îr‹_cou¡
);

358 
©åibuã
 *
	gdeÁu…_©ås
[] = {

359 &
öãºu±_íabÀ
.
©å
,

360 &
thªshﬁd_limô
.
©å
,

361 &
îr‹_cou¡
.
©å
,

362 
NULL


365 
	#to_block
(
k
Ë
	`c⁄èöî_of
(k, 
thªshﬁd_block
, 
kobj
)

	)

366 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
thªshﬁd_©å
, 
©å
)

	)

368 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

370 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

371 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

372 
ssize_t
 
ªt
;

374 
ªt
 = 
a
->
show
 ?á->
	`show
(
b
, 
buf
Ë: -
EIO
;

376  
ªt
;

377 
	}
}

379 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

380 c⁄° *
buf
, 
size_t
 
cou¡
)

382 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

383 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

384 
ssize_t
 
ªt
;

386 
ªt
 = 
a
->
°‹e
 ?á->
	`°‹e
(
b
, 
buf
, 
cou¡
Ë: -
EIO
;

388  
ªt
;

389 
	}
}

391 
sysfs_›s
 
	gthªshﬁd_›s
 = {

392 .
show
 = show,

393 .
	g°‹e
 = 
°‹e
,

396 
kobj_ty≥
 
	gthªshﬁd_kty≥
 = {

397 .
sysfs_›s
 = &
thªshﬁd_›s
,

398 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

401 
__˝uöô
 
	$Æloˇã_thªshﬁd_blocks
(
˝u
,

402 
b™k
,

403 
block
,

404 
u32
 
addªss
)

406 
thªshﬁd_block
 *
b
 = 
NULL
;

407 
u32
 
low
, 
high
;

408 
îr
;

410 i‡((
b™k
 >
NR_BANKS
Ë|| (
block
 >
NR_BLOCKS
))

413 i‡(
	`rdm§_ß„_⁄_˝u
(
˝u
, 
addªss
, &
low
, &
high
))

416 i‡(!(
high
 & 
MASK_VALID_HI
)) {

417 i‡(
block
)

418 
ªcur£
;

423 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

424 (
high
 & 
MASK_LOCKED_HI
))

425 
ªcur£
;

427 
b
 = 
	`kzÆloc
((
thªshﬁd_block
), 
GFP_KERNEL
);

428 i‡(!
b
)

429  -
ENOMEM
;

431 
b
->
block
 = block;

432 
b
->
b™k
 = bank;

433 
b
->
˝u
 = cpu;

434 
b
->
addªss
 =áddress;

435 
b
->
öãºu±_íabÀ
 = 0;

436 
b
->
thªshﬁd_limô
 = 
THRESHOLD_MAX
;

438 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

440 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
) {

441 
	`li°_add
(&
b
->
miscj
,

442 &
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
->
miscj
);

444 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
b
;

447 
îr
 = 
	`kobje˘_öô_™d_add
(&
b
->
kobj
, &
thªshﬁd_kty≥
,

448 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
kobj
,

449 "misc%i", 
block
);

450 i‡(
îr
)

451 
out_‰ì
;

452 
ªcur£
:

453 i‡(!
block
) {

454 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

455 i‡(!
addªss
)

457 
addªss
 +
MCG_XBLK_ADDR
;

459 ++
addªss
;

462 
îr
 = 
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, ++
block
, 
addªss
);

463 i‡(
îr
)

464 
out_‰ì
;

466 i‡(
b
)

467 
	`kobje˘_uevít
(&
b
->
kobj
, 
KOBJ_ADD
);

469  
îr
;

471 
out_‰ì
:

472 i‡(
b
) {

473 
	`kobje˘_put
(&
b
->
kobj
);

474 
	`k‰ì
(
b
);

476  
îr
;

477 
	}
}

479 
__˝uöô
 

480 
	$loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
)

482  
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, 0,

483 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4);

484 
	}
}

487 
__˝uöô
 
	$thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
)

489 
i
, 
îr
 = 0;

490 
thªshﬁd_b™k
 *
b
 = 
NULL
;

491 
«me
[32];

492 #ifde‡
CONFIG_SMP


493 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

496 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

498 #ifde‡
CONFIG_SMP


499 i‡(
	`˝u_d©a
(
˝u
).
˝u_c‹e_id
 && 
sh¨ed_b™k
[
b™k
]) {

500 
i
 = 
	`˝umask_fú°
(
c
->
Œc_sh¨ed_m≠
);

503 i‡(
	`˝u_d©a
(
i
).
˝u_c‹e_id
)

504 
out
;

507 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
])

508 
out
;

510 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
];

512 i‡(!
b
)

513 
out
;

515 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
,

516 
b
->
kobj
, 
«me
);

517 i‡(
îr
)

518 
out
;

520 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

521 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

523 
out
;

527 
b
 = 
	`kzÆloc
((
thªshﬁd_b™k
), 
GFP_KERNEL
);

528 i‡(!
b
) {

529 
îr
 = -
ENOMEM
;

530 
out
;

532 i‡(!
	`Æloc_˝umask_v¨
(&
b
->
˝us
, 
GFP_KERNEL
)) {

533 
	`k‰ì
(
b
);

534 
îr
 = -
ENOMEM
;

535 
out
;

538 
b
->
kobj
 = 
	`kobje˘_¸óã_™d_add
(
«me
, &
	`≥r_˝u
(
m˚_dev
, 
˝u
).kobj);

539 i‡(!
b
->
kobj
)

540 
out_‰ì
;

542 #i‚de‡
CONFIG_SMP


543 
	`˝umask_£èŒ
(
b
->
˝us
);

545 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

548 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

550 
îr
 = 
	`loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
);

551 i‡(
îr
)

552 
out_‰ì
;

554 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

555 i‡(
i
 =
˝u
)

558 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
,

559 
b
->
kobj
, 
«me
);

560 i‡(
îr
)

561 
out
;

563 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
b
;

566 
out
;

568 
out_‰ì
:

569 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

570 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

571 
	`k‰ì
(
b
);

572 
out
:

573  
îr
;

574 
	}
}

577 
__˝uöô
 
	$thªshﬁd_¸óã_devi˚
(
˝u
)

579 
b™k
;

580 
îr
 = 0;

582 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

583 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

585 
îr
 = 
	`thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
);

586 i‡(
îr
)

587 
out
;

589 
out
:

590  
îr
;

591 
	}
}

599 
	$dóŒoˇã_thªshﬁd_block
(
˝u
,

600 
b™k
)

602 
thªshﬁd_block
 *
pos
 = 
NULL
;

603 
thªshﬁd_block
 *
tmp
 = 
NULL
;

604 
thªshﬁd_b™k
 *
hód
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

606 i‡(!
hód
)

609 
	`li°_f‹_óch_íåy_ß„
(
pos
, 
tmp
, &
hód
->
blocks
->
miscj
, miscj) {

610 
	`kobje˘_put
(&
pos
->
kobj
);

611 
	`li°_dñ
(&
pos
->
miscj
);

612 
	`k‰ì
(
pos
);

615 
	`k‰ì
(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
);

616 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
NULL
;

617 
	}
}

619 
	$thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
)

621 
thªshﬁd_b™k
 *
b
;

622 
«me
[32];

623 
i
 = 0;

625 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

626 i‡(!
b
)

628 i‡(!
b
->
blocks
)

629 
‰ì_out
;

631 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

633 #ifde‡
CONFIG_SMP


635 i‡(
sh¨ed_b™k
[
b™k
] && 
b
->
blocks
->
˝u
 != cpu) {

636 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 
«me
);

637 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

644 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

645 i‡(
i
 =
˝u
)

648 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
, 
«me
);

649 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
NULL
;

652 
	`dóŒoˇã_thªshﬁd_block
(
˝u
, 
b™k
);

654 
‰ì_out
:

655 
	`kobje˘_dñ
(
b
->
kobj
);

656 
	`kobje˘_put
(
b
->
kobj
);

657 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

658 
	`k‰ì
(
b
);

659 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

660 
	}
}

662 
	$thªshﬁd_ªmove_devi˚
(
˝u
)

664 
b™k
;

666 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

667 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

669 
	`thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
);

671 
	}
}

674 
__˝uöô


675 
	$amd_64_thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
)

677 
a˘i⁄
) {

678 
CPU_ONLINE
:

679 
CPU_ONLINE_FROZEN
:

680 
	`thªshﬁd_¸óã_devi˚
(
˝u
);

682 
CPU_DEAD
:

683 
CPU_DEAD_FROZEN
:

684 
	`thªshﬁd_ªmove_devi˚
(
˝u
);

689 
	}
}

691 
__öô
 
	$thªshﬁd_öô_devi˚
()

693 
l˝u
 = 0;

696 
	`f‹_óch_⁄löe_˝u
(
l˝u
) {

697 
îr
 = 
	`thªshﬁd_¸óã_devi˚
(
l˝u
);

699 i‡(
îr
)

700  
îr
;

702 
thªshﬁd_˝u_ˇŒback
 = 
amd_64_thªshﬁd_˝u_ˇŒback
;

705 
	}
}

706 
devi˚_öôˇŒ
(
thªshﬁd_öô_devi˚
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c

8 
	~<löux/öô.h
>

9 
	~<löux/öãºu±.h
>

10 
	~<löux/≥r˝u.h
>

11 
	~<löux/sched.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/¥o˚ss‹.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/m˚.h
>

24 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_b™ks_ow√d
);

30 
DEFINE_SPINLOCK
(
cmci_discovî_lock
);

32 
	#CMCI_THRESHOLD
 1

	)

34 
	$cmci_suµ‹ãd
(*
b™ks
)

36 
u64
 
ˇp
;

38 i‡(
m˚_cmci_dißbÀd
 || 
m˚_ign‹e_˚
)

46 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
)

48 i‡(!
˝u_has_≠ic
 || 
	`œpic_gë_maxlvt
() < 6)

50 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

51 *
b™ks
 = 
	`mö_t
(, 
MAX_NR_BANKS
, 
ˇp
 & 0xff);

52  !!(
ˇp
 & 
MCG_CMCI_P
);

53 
	}
}

61 
	$öãl_thªshﬁd_öãºu±
()

63 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

64 
	`m˚_nŸify_úq
();

65 
	}
}

67 
	$¥öt_upd©e
(*
ty≥
, *
hdr
, 
num
)

69 i‡(*
hdr
 == 0)

70 
	`¥ötk
(
KERN_INFO
 "CPU %d MCA b™ks", 
	`smp_¥o˚ss‹_id
());

71 *
hdr
 = 1;

72 
	`¥ötk
(
KERN_CONT
 " %s:%d", 
ty≥
, 
num
);

73 
	}
}

80 
	$cmci_discovî
(
b™ks
, 
boŸ
)

82 *
ow√d
 = (*)&
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
);

83 
Êags
;

84 
hdr
 = 0;

85 
i
;

87 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

88 
i
 = 0; i < 
b™ks
; i++) {

89 
u64
 
vÆ
;

91 i‡(
	`ã°_bô
(
i
, 
ow√d
))

94 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

97 i‡(
vÆ
 & 
CMCI_EN
) {

98 i‡(
	`ã°_™d_˛ór_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

99 
	`¥öt_upd©e
("SHD", &
hdr
, 
i
);

100 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

104 
vÆ
 |
CMCI_EN
 | 
CMCI_THRESHOLD
;

105 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

106 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

109 i‡(
vÆ
 & 
CMCI_EN
) {

110 i‡(!
	`ã°_™d_£t_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

111 
	`¥öt_upd©e
("CMCI", &
hdr
, 
i
);

112 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

114 
	`WARN_ON
(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
)));

117 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

118 i‡(
hdr
)

119 
	`¥ötk
(
KERN_CONT
 "\n");

120 
	}
}

126 
	$cmci_ªcheck
()

128 
Êags
;

129 
b™ks
;

131 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
Ë|| !
	`cmci_suµ‹ãd
(&
b™ks
))

133 
	`loˇl_úq_ßve
(
Êags
);

134 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

135 
	`loˇl_úq_ª°‹e
(
Êags
);

136 
	}
}

142 
	$cmci_˛ór
()

144 
Êags
;

145 
i
;

146 
b™ks
;

147 
u64
 
vÆ
;

149 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

151 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

152 
i
 = 0; i < 
b™ks
; i++) {

153 i‡(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
)))

156 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

157 
vÆ
 &~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

158 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

159 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

161 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

162 
	}
}

168 
	$cmci_ªdiscovî
(
dyög
)

170 
b™ks
;

171 
˝u
;

172 
˝umask_v¨_t
 
ﬁd
;

174 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

176 i‡(!
	`Æloc_˝umask_v¨
(&
ﬁd
, 
GFP_KERNEL
))

178 
	`˝umask_c›y
(
ﬁd
, &
cuºít
->
˝us_Ælowed
);

180 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

181 i‡(
˝u
 =
dyög
)

183 i‡(
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
˝u
)))

186 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

187 
	`cmci_discovî
(
b™ks
, 0);

190 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
ﬁd
);

191 
	`‰ì_˝umask_v¨
(
ﬁd
);

192 
	}
}

197 
	$cmci_ªíabÀ
()

199 
b™ks
;

200 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

201 
	`cmci_discovî
(
b™ks
, 0);

202 
	}
}

204 
	$öãl_öô_cmci
()

206 
b™ks
;

208 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

211 
m˚_thªshﬁd_ve˘‹
 = 
öãl_thªshﬁd_öãºu±
;

212 
	`cmci_discovî
(
b™ks
, 1);

219 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

220 
	`cmci_ªcheck
();

221 
	}
}

223 
	$m˚_öãl_„©uª_öô
(
˝uöfo_x86
 *
c
)

225 
	`öãl_öô_thîmÆ
(
c
);

226 
	`öãl_öô_cmci
();

227 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/jiffõs.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/≥r˝u.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/˝u.h
>

27 
	~<asm/¥o˚ss‹.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

35 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

40 
	sthîmÆ_°©e
 {

41 
boﬁ
 
	mis_thrŸéed
;

43 
u64
 
	m√xt_check
;

44 
	mthrŸée_cou¡
;

45 
	mœ°_thrŸée_cou¡
;

48 
DEFINE_PER_CPU
(
thîmÆ_°©e
,Åhermal_state);

50 
©omic_t
 
	gthîm_thrŸ_í
 = 
ATOMIC_INIT
(0);

52 
u32
 
lvâhmr_öô
 
	g__ªad_mo°ly
;

54 #ifde‡
CONFIG_SYSFS


55 
	#deföe_thîm_thrŸ_sysdev_⁄e_ro
(
_«me
) \

56 
	`SYSDEV_ATTR
(
_«me
, 0444, 
thîm_thrŸ_sysdev_show_
##_«me, 
NULL
)

	)

58 
	#deföe_thîm_thrŸ_sysdev_show_func
(
«me
) \

60 
ssize_t
 
thîm_thrŸ_sysdev_show_
##
	`«me
( \

61 
sys_devi˚
 *
dev
, \

62 
sysdev_©åibuã
 *
©å
, \

63 *
buf
) \

65 
˝u
 = 
dev
->
id
; \

66 
ssize_t
 
ªt
; \

68 
	`¥ìm±_dißbÀ
(); \

69 i‡(
	`˝u_⁄löe
(
˝u
)) \

70 
ªt
 = 
	`•rötf
(
buf
, "%lu\n", \

71 
	`≥r_˝u
(
thîmÆ_°©e
, 
˝u
).
«me
); \

73 
ªt
 = 0; \

74 
	`¥ìm±_íabÀ
(); \

76  
ªt
; \

77 }

	)

79 
deföe_thîm_thrŸ_sysdev_show_func
(
thrŸée_cou¡
);

80 
deföe_thîm_thrŸ_sysdev_⁄e_ro
(
thrŸée_cou¡
);

82 
©åibuã
 *
	gthîmÆ_thrŸée_©ås
[] = {

83 &
©å_thrŸée_cou¡
.
©å
,

84 
NULL


87 
©åibuã_group
 
	gthîmÆ_thrŸée_©å_group
 = {

88 .
©ås
 = 
thîmÆ_thrŸée_©ås
,

89 .
	g«me
 = "thermal_throttle"

109 
	$thîm_thrŸ_¥o˚ss
(
boﬁ
 
is_thrŸéed
)

111 
thîmÆ_°©e
 *
°©e
;

112 
this_˝u
;

113 
boﬁ
 
was_thrŸéed
;

114 
u64
 
now
;

116 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

117 
now
 = 
	`gë_jiffõs_64
();

118 
°©e
 = &
	`≥r_˝u
(
thîmÆ_°©e
, 
this_˝u
);

120 
was_thrŸéed
 = 
°©e
->
is_thrŸéed
;

121 
°©e
->
is_thrŸéed
 = is_throttled;

123 i‡(
is_thrŸéed
)

124 
°©e
->
thrŸée_cou¡
++;

126 i‡(
	`time_bef‹e64
(
now
, 
°©e
->
√xt_check
) &&

127 
°©e
->
thrŸée_cou¡
 !°©e->
œ°_thrŸée_cou¡
)

130 
°©e
->
√xt_check
 = 
now
 + 
CHECK_INTERVAL
;

131 
°©e
->
œ°_thrŸée_cou¡
 = sèã->
thrŸée_cou¡
;

134 i‡(
is_thrŸéed
) {

135 
	`¥ötk
(
KERN_CRIT
 "CPU%d: Tem≥øtuªábovêthªshﬁd, cpu clockÅhrŸéed (tŸÆÉvít†%lu)\n", 
this_˝u
, 
°©e
->
thrŸée_cou¡
);

137 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

140 i‡(
was_thrŸéed
) {

141 
	`¥ötk
(
KERN_INFO
 "CPU%d: Tem≥øtuª/•ìdÇ‹mÆ\n", 
this_˝u
);

146 
	}
}

148 #ifde‡
CONFIG_SYSFS


150 
__˝uöô
 
	$thîmÆ_thrŸée_add_dev
(
sys_devi˚
 *
sys_dev
)

152  
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
,

153 &
thîmÆ_thrŸée_©å_group
);

154 
	}
}

156 
__˝uöô
 
	$thîmÆ_thrŸée_ªmove_dev
(
sys_devi˚
 *
sys_dev
)

158 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
thîmÆ_thrŸée_©å_group
);

159 
	}
}

162 
DEFINE_MUTEX
(
thîm_˝u_lock
);

165 
__˝uöô
 

166 
	$thîmÆ_thrŸée_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

167 
a˘i⁄
,

168 *
h˝u
)

170 
˝u
 = ()
h˝u
;

171 
sys_devi˚
 *
sys_dev
;

172 
îr
 = 0;

174 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

176 
a˘i⁄
) {

177 
CPU_UP_PREPARE
:

178 
CPU_UP_PREPARE_FROZEN
:

179 
	`muãx_lock
(&
thîm_˝u_lock
);

180 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
sys_dev
);

181 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

182 
	`WARN_ON
(
îr
);

184 
CPU_UP_CANCELED
:

185 
CPU_UP_CANCELED_FROZEN
:

186 
CPU_DEAD
:

187 
CPU_DEAD_FROZEN
:

188 
	`muãx_lock
(&
thîm_˝u_lock
);

189 
	`thîmÆ_thrŸée_ªmove_dev
(
sys_dev
);

190 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

193  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

194 
	}
}

196 
nŸifõr_block
 
thîmÆ_thrŸée_˝u_nŸifõr
 
	g__˝uöôd©a
 =

198 .
nŸifõr_ˇŒ
 = 
thîmÆ_thrŸée_˝u_ˇŒback
,

201 
__öô
 
	$thîmÆ_thrŸée_öô_devi˚
()

203 
˝u
 = 0;

204 
îr
;

206 i‡(!
	`©omic_ªad
(&
thîm_thrŸ_í
))

209 
	`ªgi°î_hŸ˝u_nŸifõr
(&
thîmÆ_thrŸée_˝u_nŸifõr
);

211 #ifde‡
CONFIG_HOTPLUG_CPU


212 
	`muãx_lock
(&
thîm_˝u_lock
);

215 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

216 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
	`gë_˝u_sysdev
(
˝u
));

217 
	`WARN_ON
(
îr
);

219 #ifde‡
CONFIG_HOTPLUG_CPU


220 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

224 
	}
}

225 
devi˚_öôˇŒ
(
thîmÆ_thrŸée_öô_devi˚
);

230 
	$öãl_thîmÆ_öãºu±
()

232 
__u64
 
m§_vÆ
;

234 
	`rdm§l
(
MSR_IA32_THERM_STATUS
, 
m§_vÆ
);

235 i‡(
	`thîm_thrŸ_¥o˚ss
((
m§_vÆ
 & 
THERM_STATUS_PROCHOT
) != 0))

236 
	`m˚_log_thîm_thrŸ_evít
(
m§_vÆ
);

237 
	}
}

239 
	$u√x≥˘ed_thîmÆ_öãºu±
()

241 
	`¥ötk
(
KERN_ERR
 "CPU%d: Unexpected LVT TMR interrupt!\n",

242 
	`smp_¥o˚ss‹_id
());

243 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

244 
	}
}

246 (*
smp_thîmÆ_ve˘‹
)(Ë
u√x≥˘ed_thîmÆ_öãºu±
;

248 
asmlökage
 
	$smp_thîmÆ_öãºu±
(
±_ªgs
 *
ªgs
)

250 
	`exô_idÀ
();

251 
	`úq_íãr
();

252 
	`öc_úq_°©
(
úq_thîmÆ_cou¡
);

253 
	`smp_thîmÆ_ve˘‹
();

254 
	`úq_exô
();

256 
	`ack_APIC_úq
();

257 
	}
}

260 
	$öãl_thîmÆ_suµ‹ãd
(
˝uöfo_x86
 *
c
)

262 i‡(!
˝u_has_≠ic
)

264 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
Ë|| !˝u_has(c, 
X86_FEATURE_ACC
))

267 
	}
}

269 
__öô
 
	$mcheck_öãl_thîm_öô
()

276 i‡(
	`öãl_thîmÆ_suµ‹ãd
(&
boŸ_˝u_d©a
))

277 
lvâhmr_öô
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

278 
	}
}

280 
	$öãl_öô_thîmÆ
(
˝uöfo_x86
 *
c
)

282 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
tm2
 = 0;

284 
u32
 
l
, 
h
;

286 i‡(!
	`öãl_thîmÆ_suµ‹ãd
(
c
))

294 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

305 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
lvâhmr_öô
);

307 
h
 = 
lvâhmr_öô
;

309 i‡((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
Ë&& (
h
 & 
APIC_DM_SMI
)) {

310 
	`¥ötk
(
KERN_DEBUG


311 "CPU%d: ThîmÆ m⁄ô‹ög h™dÀd by SMI\n", 
˝u
);

316 i‡(
h
 & 
APIC_VECTOR_MASK
) {

317 
	`¥ötk
(
KERN_DEBUG


319 
˝u
, (
h
 & 
APIC_VECTOR_MASK
));

324 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TM2
)) {

325 i‡(
c
->
x86
 =6 && (c->
x86_modñ
 == 9 || c->x86_model == 13)) {

326 
	`rdm§
(
MSR_THERM2_CTL
, 
l
, 
h
);

327 i‡(
l
 & 
MSR_THERM2_CTL_TM_SELECT
)

328 
tm2
 = 1;

329 } i‡(
l
 & 
MSR_IA32_MISC_ENABLE_TM2
)

330 
tm2
 = 1;

334 
h
 = 
THERMAL_APIC_VECTOR
 | 
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
;

335 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
h
);

337 
	`rdm§
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

338 
	`wrm§
(
MSR_IA32_THERM_INTERRUPT
,

339 
l
 | (
THERM_INT_LOW_ENABLE
 | 
THERM_INT_HIGH_ENABLE
), 
h
);

341 
smp_thîmÆ_ve˘‹
 = 
öãl_thîmÆ_öãºu±
;

343 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

344 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

347 
l
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

348 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

350 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Thermal monitoringÉnabled (%s)\n",

351 
tm2
 ? "TM2" : "TM1");

354 
	`©omic_£t
(&
thîm_thrŸ_í
, 1);

355 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<löux/öãºu±.h
>

5 
	~<löux/kî√l.h
>

7 
	~<asm/úq_ve˘‹s.h
>

8 
	~<asm/≠ic.h
>

9 
	~<asm/idÀ.h
>

10 
	~<asm/m˚.h
>

12 
	$deÁu…_thªshﬁd_öãºu±
()

14 
	`¥ötk
(
KERN_ERR
 "UnexpectedÅhreshold interruptát vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
m˚_thªshﬁd_ve˘‹
)(Ë
deÁu…_thªshﬁd_öãºu±
;

20 
asmlökage
 
	$smp_thªshﬁd_öãºu±
()

22 
	`exô_idÀ
();

23 
	`úq_íãr
();

24 
	`öc_úq_°©
(
úq_thªshﬁd_cou¡
);

25 
	`m˚_thªshﬁd_ve˘‹
();

26 
	`úq_exô
();

28 
	`ack_APIC_úq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/˝u.h
>

25 
	~<löux/s‹t.h
>

26 
	~<löux/muãx.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/kvm_∑ø.h
>

30 
	~<asm/¥o˚ss‹.h
>

31 
	~<asm/e820.h
>

32 
	~<asm/mår.h
>

33 
	~<asm/m§.h
>

35 
	~"mår.h
"

37 
	sªs_ønge
 {

38 
	m°¨t
;

39 
	míd
;

42 
	sv¨_mår_ønge_°©e
 {

43 
	mba£_p‚
;

44 
	msize_p‚
;

45 
mår_ty≥
 
	mty≥
;

48 
	sv¨_mår_°©e
 {

49 
	mønge_°¨tk
;

50 
	mønge_sizek
;

51 
	mchunk_sizek
;

52 
	mgøn_sizek
;

53 
	mªg
;

57 
	#RANGE_NUM
 256

	)

59 
ªs_ønge
 
__öôd©a
 
	gønge
[
RANGE_NUM
];

60 
__öôd©a
 
	gƒ_ønge
;

62 
v¨_mår_ønge_°©e
 
__öôd©a
 
	gønge_°©e
[
RANGE_NUM
];

64 
__öôd©a
 
	gdebug_¥öt
;

65 
	#D¥ötk
(
x
...Ëdÿ{ i‡(
debug_¥öt
Ë
	`¥ötk
(
KERN_DEBUG
 x); } 0)

	)

68 
__öô


69 
	$add_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

70 
°¨t
, 
íd
)

73 i‡(
ƒ_ønge
 >
RANGE_NUM
)

74  
ƒ_ønge
;

76 
ønge
[
ƒ_ønge
].
°¨t
 = start;

77 
ønge
[
ƒ_ønge
].
íd
 =Énd;

79 
ƒ_ønge
++;

81  
ƒ_ønge
;

82 
	}
}

84 
__öô


85 
	$add_ønge_wôh_mîge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

86 
°¨t
, 
íd
)

88 
i
;

91 
i
 = 0; i < 
ƒ_ønge
; i++) {

92 
föÆ_°¨t
, 
föÆ_íd
;

93 
comm⁄_°¨t
, 
comm⁄_íd
;

95 i‡(!
ønge
[
i
].
íd
)

98 
comm⁄_°¨t
 = 
	`max
(
ønge
[
i
].
°¨t
, start);

99 
comm⁄_íd
 = 
	`mö
(
ønge
[
i
].
íd
,Énd);

100 i‡(
comm⁄_°¨t
 > 
comm⁄_íd
 + 1)

103 
föÆ_°¨t
 = 
	`mö
(
ønge
[
i
].
°¨t
, start);

104 
föÆ_íd
 = 
	`max
(
ønge
[
i
].
íd
,Énd);

106 
ønge
[
i
].
°¨t
 = 
föÆ_°¨t
;

107 
ønge
[
i
].
íd
 = 
föÆ_íd
;

108  
ƒ_ønge
;

112  
	`add_ønge
(
ønge
, 
ƒ_ønge
, 
°¨t
, 
íd
);

113 
	}
}

115 
__öô


116 
	$subåa˘_ønge
(
ªs_ønge
 *
ønge
, 
°¨t
, 
íd
)

118 
i
, 
j
;

120 
j
 = 0; j < 
RANGE_NUM
; j++) {

121 i‡(!
ønge
[
j
].
íd
)

124 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end) {

125 
ønge
[
j
].
°¨t
 = 0;

126 
ønge
[
j
].
íd
 = 0;

130 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end &&

131 
ønge
[
j
].
°¨t
 < 
íd
 + 1) {

132 
ønge
[
j
].
°¨t
 = 
íd
 + 1;

137 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end &&

138 
ønge
[
j
].
íd
 > 
°¨t
 - 1) {

139 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

143 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end) {

145 
i
 = 0; i < 
RANGE_NUM
; i++) {

146 i‡(
ønge
[
i
].
íd
 == 0)

149 i‡(
i
 < 
RANGE_NUM
) {

150 
ønge
[
i
].
íd
 =Ñ™ge[
j
].end;

151 
ønge
[
i
].
°¨t
 = 
íd
 + 1;

153 
	`¥ötk
(
KERN_ERR
 "run of slot inÑanges\n");

155 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

159 
	}
}

161 
__öô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

163 c⁄° 
ªs_ønge
 *
r1
 = 
x1
;

164 c⁄° 
ªs_ønge
 *
r2
 = 
x2
;

165 
°¨t1
, 
°¨t2
;

167 
°¨t1
 = 
r1
->
°¨t
;

168 
°¨t2
 = 
r2
->
°¨t
;

170  
°¨t1
 - 
°¨t2
;

171 
	}
}

173 
__öô
 
	$˛ón_s‹t_ønge
(
ªs_ønge
 *
ønge
, 
az
)

175 
i
, 
j
, 
k
 = 
az
 - 1, 
ƒ_ønge
 = 0;

177 
i
 = 0; i < 
k
; i++) {

178 i‡(
ønge
[
i
].
íd
)

180 
j
 = 
k
; j > 
i
; j--) {

181 i‡(
ønge
[
j
].
íd
) {

182 
k
 = 
j
;

186 i‡(
j
 =
i
)

188 
ønge
[
i
].
°¨t
 =Ñ™ge[
k
].start;

189 
ønge
[
i
].
íd
 =Ñ™ge[
k
].end;

190 
ønge
[
k
].
°¨t
 = 0;

191 
ønge
[
k
].
íd
 = 0;

192 
k
--;

195 
i
 = 0; i < 
az
; i++) {

196 i‡(!
ønge
[
i
].
íd
) {

197 
ƒ_ønge
 = 
i
;

203 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

205  
ƒ_ønge
;

206 
	}
}

208 
	#BIOS_BUG_MSG
 
KERN_WARNING
 \

209 "WARNING: BIOS bug: VAR MTRR %d c⁄èö†°øngêUCÉ¡ry undî 1M, check wôh you∏sy°em víd‹!\n"

	)

211 
__öô


212 
	$x86_gë_mår_mem_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

213 
exåa_ªmove_ba£
,

214 
exåa_ªmove_size
)

216 
ba£
, 
size
;

217 
mår_ty≥
 
ty≥
;

218 
i
;

220 
i
 = 0; i < 
num_v¨_ønges
; i++) {

221 
ty≥
 = 
ønge_°©e
[
i
].type;

222 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

224 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

225 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

226 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_ønge, 
ba£
,

227 
ba£
 + 
size
 - 1);

229 i‡(
debug_¥öt
) {

230 
	`¥ötk
(
KERN_DEBUG
 "After WB checking\n");

231 
i
 = 0; i < 
ƒ_ønge
; i++)

232 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

233 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

237 
i
 = 0; i < 
num_v¨_ønges
; i++) {

238 
ty≥
 = 
ønge_°©e
[
i
].type;

239 i‡(
ty≥
 !
MTRR_TYPE_UNCACHABLE
 &&

240 
ty≥
 !
MTRR_TYPE_WRPROT
)

242 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

243 i‡(!
size
)

245 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

246 i‡(
ba£
 < (1<<(20-
PAGE_SHIFT
)Ë&& 
mår_°©e
.
have_fixed
 &&

247 (
mår_°©e
.
íabÀd
 & 1)) {

249 
	`¥ötk
(
BIOS_BUG_MSG
, 
i
);

250 i‡(
ba£
 + 
size
 <(1<<(20-
PAGE_SHIFT
)))

252 
size
 -(1<<(20-
PAGE_SHIFT
)Ë- 
ba£
;

253 
ba£
 = 1<<(20-
PAGE_SHIFT
);

255 
	`subåa˘_ønge
(
ønge
, 
ba£
, ba£ + 
size
 - 1);

257 i‡(
exåa_ªmove_size
)

258 
	`subåa˘_ønge
(
ønge
, 
exåa_ªmove_ba£
,

259 
exåa_ªmove_ba£
 + 
exåa_ªmove_size
 - 1);

261 i‡(
debug_¥öt
) {

262 
	`¥ötk
(
KERN_DEBUG
 "After UC checking\n");

263 
i
 = 0; i < 
RANGE_NUM
; i++) {

264 i‡(!
ønge
[
i
].
íd
)

266 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

267 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

272 
ƒ_ønge
 = 
	`˛ón_s‹t_ønge
(
ønge
, 
RANGE_NUM
);

273 i‡(
debug_¥öt
) {

274 
	`¥ötk
(
KERN_DEBUG
 "After sorting\n");

275 
i
 = 0; i < 
ƒ_ønge
; i++)

276 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

277 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

281 
i
 = 
ƒ_ønge
; i < 
RANGE_NUM
; i++)

282 
	`mem£t
(&
ønge
[
i
], 0, (range[i]));

284  
ƒ_ønge
;

285 
	}
}

287 #ifde‡
CONFIG_MTRR_SANITIZER


289 
__öô
 
	$sum_ønges
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
)

291 
sum
 = 0;

292 
i
;

294 
i
 = 0; i < 
ƒ_ønge
; i++)

295 
sum
 +
ønge
[
i
].
íd
 + 1 -Ñ™ge[i].
°¨t
;

297  
sum
;

298 
	}
}

300 
íabÀ_mår_˛ónup
 
	g__öôd©a
 =

301 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

303 
__öô
 
	$dißbÀ_mår_˛ónup_£tup
(*
°r
)

305 
íabÀ_mår_˛ónup
 = 0;

307 
	}
}

308 
óæy_∑øm
("dißbÀ_mår_˛ónup", 
dißbÀ_mår_˛ónup_£tup
);

310 
__öô
 
	$íabÀ_mår_˛ónup_£tup
(*
°r
)

312 
íabÀ_mår_˛ónup
 = 1;

314 
	}
}

315 
óæy_∑øm
("íabÀ_mår_˛ónup", 
íabÀ_mår_˛ónup_£tup
);

317 
__öô
 
	$mår_˛ónup_debug_£tup
(*
°r
)

319 
debug_¥öt
 = 1;

321 
	}
}

322 
óæy_∑øm
("mår_˛ónup_debug", 
mår_˛ónup_debug_£tup
);

324 
__öô


325 
	$£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

326 
ty≥
, 
addªss_bôs
)

328 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

329 
u64
 
ba£
, 
mask
;

331 i‡(!
sizek
) {

332 
	`fûl_mår_v¨_ønge
(
ªg
, 0, 0, 0, 0);

336 
mask
 = (1ULL << 
addªss_bôs
) - 1;

337 
mask
 &~((((
u64
)
sizek
) << 10) - 1);

339 
ba£
 = ((
u64
)
ba£k
) << 10;

341 
ba£
 |
ty≥
;

342 
mask
 |= 0x800;

344 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

345 
ba£_hi
 = 
ba£
 >> 32;

347 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

348 
mask_hi
 = 
mask
 >> 32;

350 
	`fûl_mår_v¨_ønge
(
ªg
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

351 
	}
}

353 
__öô


354 
	$ßve_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

355 
ty≥
)

357 
ønge_°©e
[
ªg
].
ba£_p‚
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

358 
ønge_°©e
[
ªg
].
size_p‚
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

359 
ønge_°©e
[
ªg
].
ty≥
 =Åype;

360 
	}
}

362 
__öô
 
	$£t_v¨_mår_Æl
(
addªss_bôs
)

364 
ba£k
, 
sizek
;

365 
ty≥
;

366 
ªg
;

368 
ªg
 = 0;Ñeg < 
num_v¨_ønges
;Ñeg++) {

369 
ba£k
 = 
ønge_°©e
[
ªg
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

370 
sizek
 = 
ønge_°©e
[
ªg
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

371 
ty≥
 = 
ønge_°©e
[
ªg
].type;

373 
	`£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
, 
ty≥
, 
addªss_bôs
);

375 
	}
}

377 
	$to_size_Á˘‹
(
sizek
, *
Á˘‹p
)

379 
ba£
 = 
sizek
;

380 
Á˘‹
;

382 i‡(
ba£
 & ((1<<10) - 1)) {

384 
Á˘‹
 = 'K';

385 } i‡(
ba£
 & ((1<<20) - 1)) {

386 
Á˘‹
 = 'M';

387 
ba£
 >>= 10;

389 
Á˘‹
 = 'G';

390 
ba£
 >>= 20;

393 *
Á˘‹p
 = 
Á˘‹
;

395  
ba£
;

396 
	}
}

398 
__öô


399 
	$ønge_to_mår
(
ªg
, 
ønge_°¨tk
,

400 
ønge_sizek
, 
ty≥
)

402 i‡(!
ønge_sizek
 || (
ªg
 >
num_v¨_ønges
))

403  
ªg
;

405 
ønge_sizek
) {

406 
max_Æign
, 
Æign
;

407 
sizek
;

410 i‡(
ønge_°¨tk
)

411 
max_Æign
 = 
	`ffs
(
ønge_°¨tk
) - 1;

413 
max_Æign
 = 32;

415 
Æign
 = 
	`Ês
(
ønge_sizek
) - 1;

416 i‡(
Æign
 > 
max_Æign
)

417 
Æign
 = 
max_Æign
;

419 
sizek
 = 1 << 
Æign
;

420 i‡(
debug_¥öt
) {

421 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

422 
°¨t_ba£
, 
size_ba£
;

424 
°¨t_ba£
 = 
	`to_size_Á˘‹
(
ønge_°¨tk
, &
°¨t_Á˘‹
);

425 
size_ba£
 = 
	`to_size_Á˘‹
(
sizek
, &
size_Á˘‹
);

427 
	`D¥ötk
("Setting variable MTRR %d, "

429 
ªg
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

430 
size_ba£
, 
size_Á˘‹
,

431 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

432 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

435 
	`ßve_v¨_mår
(
ªg
++, 
ønge_°¨tk
, 
sizek
, 
ty≥
);

436 
ønge_°¨tk
 +
sizek
;

437 
ønge_sizek
 -
sizek
;

438 i‡(
ªg
 >
num_v¨_ønges
)

441  
ªg
;

442 
	}
}

444 
__öô


445 
	$ønge_to_mår_wôh_hﬁe
(
v¨_mår_°©e
 *
°©e
, 
ba£k
,

446 
sizek
)

448 
hﬁe_ba£k
, 
hﬁe_sizek
;

449 
£c⁄d_ba£k
, 
£c⁄d_sizek
;

450 
ønge0_ba£k
, 
ønge0_sizek
;

451 
ønge_ba£k
, 
ønge_sizek
;

452 
chunk_sizek
;

453 
gøn_sizek
;

455 
hﬁe_ba£k
 = 0;

456 
hﬁe_sizek
 = 0;

457 
£c⁄d_ba£k
 = 0;

458 
£c⁄d_sizek
 = 0;

459 
chunk_sizek
 = 
°©e
->chunk_sizek;

460 
gøn_sizek
 = 
°©e
->gran_sizek;

463 
ønge_ba£k
 = 
	`ALIGN
(
°©e
->
ønge_°¨tk
, 
gøn_sizek
);

464 i‡((
ønge_ba£k
 > 
ba£k
) && basek)

465  
£c⁄d_sizek
;

467 
°©e
->
ønge_sizek
 -(
ønge_ba£k
 - sèã->
ønge_°¨tk
);

468 
ønge_sizek
 = 
	`ALIGN
(
°©e
->ønge_sizek, 
gøn_sizek
);

470 
ønge_sizek
 > 
°©e
->range_sizek) {

471 
ønge_sizek
 -
gøn_sizek
;

472 i‡(!
ønge_sizek
)

475 
°©e
->
ønge_sizek
 =Ñange_sizek;

478 
ønge0_ba£k
 = 
°©e
->
ønge_°¨tk
;

479 
ønge0_sizek
 = 
	`ALIGN
(
°©e
->
ønge_sizek
, 
chunk_sizek
);

482 i‡(
ønge0_sizek
 =
°©e
->
ønge_sizek
) {

483 
	`D¥ötk
("rangeX: %016lx - %016lx\n",

484 
ønge0_ba£k
<<10,

485 (
ønge0_ba£k
 + 
°©e
->
ønge_sizek
)<<10);

486 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

487 
°©e
->
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

492 i‡(
sizek
) {

493 
ønge0_ba£k
 + 
ønge0_sizek
 > (
ba£k
 + 
sizek
)) {

494 i‡(
ønge0_sizek
 >
chunk_sizek
)

495 
ønge0_sizek
 -
chunk_sizek
;

497 
ønge0_sizek
 = 0;

499 i‡(!
ønge0_sizek
)

504 
£c⁄d_åy
:

505 
ønge_ba£k
 = 
ønge0_ba£k
 + 
ønge0_sizek
;

508 i‡(
ønge_ba£k
 > 
ba£k
 &&Ñ™ge_ba£k <(ba£k + 
sizek
))

509 
£c⁄d_sizek
 = 
ønge_ba£k
 - 
ba£k
;

511 i‡(
ønge0_sizek
 > 
°©e
->
ønge_sizek
) {

514 
hﬁe_sizek
 = 
ønge0_sizek
 - 
°©e
->
ønge_sizek
 - 
£c⁄d_sizek
;

517 i‡(
hﬁe_sizek
 >(
ønge0_sizek
 >> 1) &&

518 
ønge0_sizek
 >
chunk_sizek
) {

519 
ønge0_sizek
 -
chunk_sizek
;

520 
£c⁄d_sizek
 = 0;

521 
hﬁe_sizek
 = 0;

523 
£c⁄d_åy
;

527 i‡(
ønge0_sizek
) {

528 
	`D¥ötk
("range0: %016lx - %016lx\n",

529 
ønge0_ba£k
<<10,

530 (
ønge0_ba£k
 + 
ønge0_sizek
)<<10);

531 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

532 
ønge0_sizek
, 
MTRR_TYPE_WRBACK
);

535 i‡(
ønge0_sizek
 < 
°©e
->
ønge_sizek
) {

537 
ønge_sizek
 = 
°©e
->ønge_sizek - 
ønge0_sizek
;

539 
	`D¥ötk
("range: %016lx - %016lx\n",

540 
ønge_ba£k
<<10,

541 (
ønge_ba£k
 + 
ønge_sizek
)<<10);

543 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge_ba£k
,

544 
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

547 i‡(
hﬁe_sizek
) {

548 
hﬁe_ba£k
 = 
ønge_ba£k
 - 
hﬁe_sizek
 - 
£c⁄d_sizek
;

549 
	`D¥ötk
("hole: %016lx - %016lx\n",

550 
hﬁe_ba£k
<<10,

551 (
hﬁe_ba£k
 + 
hﬁe_sizek
)<<10);

552 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
hﬁe_ba£k
,

553 
hﬁe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

556  
£c⁄d_sizek
;

557 
	}
}

559 
__öô


560 
	$£t_v¨_mår_ønge
(
v¨_mår_°©e
 *
°©e
, 
ba£_p‚
,

561 
size_p‚
)

563 
ba£k
, 
sizek
;

564 
£c⁄d_sizek
 = 0;

566 i‡(
°©e
->
ªg
 >
num_v¨_ønges
)

569 
ba£k
 = 
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

570 
sizek
 = 
size_p‚
 << (
PAGE_SHIFT
 - 10);

573 i‡((
ba£k
 <= 1024) ||

574 (
°©e
->
ønge_°¨tk
 + sèã->
ønge_sizek
 =
ba£k
)) {

575 
ídk
 = 
ba£k
 + 
sizek
;

576 
°©e
->
ønge_sizek
 = 
ídk
 - sèã->
ønge_°¨tk
;

580 i‡(
°©e
->
ønge_sizek
 != 0)

581 
£c⁄d_sizek
 = 
	`ønge_to_mår_wôh_hﬁe
(
°©e
, 
ba£k
, 
sizek
);

584 
°©e
->
ønge_°¨tk
 = 
ba£k
 + 
£c⁄d_sizek
;

585 
°©e
->
ønge_sizek
 = 
sizek
 - 
£c⁄d_sizek
;

586 
	}
}

589 
u64
 
mår_chunk_size
 
	g__öôd©a
 = (256ULL<<20);

591 
__öô
 
	$∑r£_mår_chunk_size_›t
(*
p
)

593 i‡(!
p
)

594  -
EINVAL
;

595 
mår_chunk_size
 = 
	`mem∑r£
(
p
, &p);

597 
	}
}

598 
óæy_∑øm
("mår_chunk_size", 
∑r£_mår_chunk_size_›t
);

601 
u64
 
mår_gøn_size
 
	g__öôd©a
;

603 
__öô
 
	$∑r£_mår_gøn_size_›t
(*
p
)

605 i‡(!
p
)

606  -
EINVAL
;

607 
mår_gøn_size
 = 
	`mem∑r£
(
p
, &p);

609 
	}
}

610 
óæy_∑øm
("mår_gøn_size", 
∑r£_mår_gøn_size_›t
);

612 
ƒ_mår_•¨e_ªg
 
	g__öôd©a
 =

613 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

615 
__öô
 
	$∑r£_mår_•¨e_ªg
(*
¨g
)

617 i‡(
¨g
)

618 
ƒ_mår_•¨e_ªg
 = 
	`sim∂e_°πoul
(
¨g
, 
NULL
, 0);

620 
	}
}

621 
óæy_∑øm
("mår_•¨e_ªg_ƒ", 
∑r£_mår_•¨e_ªg
);

623 
__öô


624 
	$x86_£tup_v¨_mårs
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

625 
u64
 
chunk_size
, u64 
gøn_size
)

627 
v¨_mår_°©e
 
v¨_°©e
;

628 
num_ªg
;

629 
i
;

631 
v¨_°©e
.
ønge_°¨tk
 = 0;

632 
v¨_°©e
.
ønge_sizek
 = 0;

633 
v¨_°©e
.
ªg
 = 0;

634 
v¨_°©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

635 
v¨_°©e
.
gøn_sizek
 = 
gøn_size
 >> 10;

637 
	`mem£t
(
ønge_°©e
, 0, (range_state));

640 
i
 = 0; i < 
ƒ_ønge
; i++) {

641 
	`£t_v¨_mår_ønge
(&
v¨_°©e
, 
ønge
[
i
].
°¨t
,

642 
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
 + 1);

646 i‡(
v¨_°©e
.
ønge_sizek
 != 0)

647 
	`ønge_to_mår_wôh_hﬁe
(&
v¨_°©e
, 0, 0);

649 
num_ªg
 = 
v¨_°©e
.
ªg
;

651 
v¨_°©e
.
ªg
 < 
num_v¨_ønges
) {

652 
	`ßve_v¨_mår
(
v¨_°©e
.
ªg
, 0, 0, 0);

653 
v¨_°©e
.
ªg
++;

656  
num_ªg
;

657 
	}
}

659 
	smår_˛ónup_ªsu…
 {

660 
	mgøn_sizek
;

661 
	mchunk_sizek
;

662 
	mlo£_covî_sizek
;

663 
	mnum_ªg
;

664 
	mbad
;

672 
	#NUM_RESULT
 136

	)

673 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

675 
mår_˛ónup_ªsu…
 
__öôd©a
 
	gªsu…
[
NUM_RESULT
];

676 
__öôd©a
 
	gmö_loss_p‚
[
RANGE_NUM
];

678 
__öô
 
	$¥öt_out_mår_ønge_°©e
()

680 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

681 
°¨t_ba£
, 
size_ba£
;

682 
mår_ty≥
 
ty≥
;

683 
i
;

685 
i
 = 0; i < 
num_v¨_ønges
; i++) {

687 
size_ba£
 = 
ønge_°©e
[
i
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

688 i‡(!
size_ba£
)

691 
size_ba£
 = 
	`to_size_Á˘‹
(size_ba£, &
size_Á˘‹
),

692 
°¨t_ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

693 
°¨t_ba£
 = 
	`to_size_Á˘‹
(°¨t_ba£, &
°¨t_Á˘‹
),

694 
ty≥
 = 
ønge_°©e
[
i
].type;

696 
	`¥ötk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,Ñange: %ld%cB,Åype %s\n",

697 
i
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

698 
size_ba£
, 
size_Á˘‹
,

699 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

700 ((
ty≥
 =
MTRR_TYPE_WRPROT
) ? "WP" :

701 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

704 
	}
}

706 
__öô
 
	$mår_√ed_˛ónup
()

708 
i
;

709 
mår_ty≥
 
ty≥
;

710 
size
;

712 
num
[
MTRR_NUM_TYPES
 + 1];

715 
	`mem£t
(
num
, 0, (num));

716 
i
 = 0; i < 
num_v¨_ønges
; i++) {

717 
ty≥
 = 
ønge_°©e
[
i
].type;

718 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

719 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

721 i‡(!
size
)

722 
ty≥
 = 
MTRR_NUM_TYPES
;

723 
num
[
ty≥
]++;

727 i‡(!
num
[
MTRR_TYPE_UNCACHABLE
])

731 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

732 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

736 
	}
}

738 
__öôd©a
 
	gønge_sums
;

740 
__öô


741 
	$mår_ˇlc_ønge_°©e
(
u64
 
chunk_size
, u64 
gøn_size
,

742 
x_ªmove_ba£
,

743 
x_ªmove_size
, 
i
)

745 
ªs_ønge
 
ønge_√w
[
RANGE_NUM
];

746 
ønge_sums_√w
;

747 
ƒ_ønge_√w
;

748 
num_ªg
;

751 
num_ªg
 = 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

754 
	`mem£t
(
ønge_√w
, 0, (range_new));

755 
ƒ_ønge_√w
 = 
	`x86_gë_mår_mem_ønge
(
ønge_√w
, 0,

756 
x_ªmove_ba£
, 
x_ªmove_size
);

757 
ønge_sums_√w
 = 
	`sum_ønges
(
ønge_√w
, 
ƒ_ønge_√w
);

759 
ªsu…
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

760 
ªsu…
[
i
].
gøn_sizek
 = 
gøn_size
 >> 10;

761 
ªsu…
[
i
].
num_ªg
 =Çum_reg;

763 i‡(
ønge_sums
 < 
ønge_sums_√w
) {

764 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums_√w
 - 
ønge_sums
Ë<< 
PSHIFT
;

765 
ªsu…
[
i
].
bad
 = 1;

767 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums
 - 
ønge_sums_√w
Ë<< 
PSHIFT
;

771 i‡(!
ªsu…
[
i
].
bad
 && !ªsu…[i].
lo£_covî_sizek
) {

772 i‡(
ƒ_ønge_√w
 !
ƒ_ønge
 || 
	`memcmp
(
ønge
, 
ønge_√w
, (range)))

773 
ªsu…
[
i
].
bad
 = 1;

776 i‡(!
ªsu…
[
i
].
bad
 && (
ønge_sums
 - 
ønge_sums_√w
 < 
mö_loss_p‚
[
num_ªg
]))

777 
mö_loss_p‚
[
num_ªg
] = 
ønge_sums
 - 
ønge_sums_√w
;

778 
	}
}

780 
__öô
 
	$mår_¥öt_out_⁄e_ªsu…
(
i
)

782 
gøn_ba£
, 
chunk_ba£
, 
lo£_ba£
;

783 
gøn_Á˘‹
, 
chunk_Á˘‹
, 
lo£_Á˘‹
;

785 
gøn_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
gøn_sizek
, &
gøn_Á˘‹
),

786 
chunk_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
chunk_sizek
, &
chunk_Á˘‹
),

787 
lo£_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
lo£_covî_sizek
, &
lo£_Á˘‹
),

789 
	`¥_öfo
("%sgran_size: %ld%c \tchunk_size: %ld%c \t",

790 
ªsu…
[
i
].
bad
 ? "*BAD*" : " ",

791 
gøn_ba£
, 
gøn_Á˘‹
, 
chunk_ba£
, 
chunk_Á˘‹
);

792 
	`¥_c⁄t
("num_reg: %d \tlose cover RAM: %s%ld%c\n",

793 
ªsu…
[
i
].
num_ªg
,Ñesu…[i].
bad
 ? "-" : "",

794 
lo£_ba£
, 
lo£_Á˘‹
);

795 
	}
}

797 
__öô
 
	$mår_£¨ch_›timÆ_ödex
()

799 
num_ªg_good
;

800 
ödex_good
;

801 
i
;

803 i‡(
ƒ_mår_•¨e_ªg
 >
num_v¨_ønges
)

804 
ƒ_mår_•¨e_ªg
 = 
num_v¨_ønges
 - 1;

806 
num_ªg_good
 = -1;

807 
i
 = 
num_v¨_ønges
 - 
ƒ_mår_•¨e_ªg
; i > 0; i--) {

808 i‡(!
mö_loss_p‚
[
i
])

809 
num_ªg_good
 = 
i
;

812 
ödex_good
 = -1;

813 i‡(
num_ªg_good
 != -1) {

814 
i
 = 0; i < 
NUM_RESULT
; i++) {

815 i‡(!
ªsu…
[
i
].
bad
 &&

816 
ªsu…
[
i
].
num_ªg
 =
num_ªg_good
 &&

817 !
ªsu…
[
i
].
lo£_covî_sizek
) {

818 
ödex_good
 = 
i
;

824  
ödex_good
;

825 
	}
}

827 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

829 
x_ªmove_ba£
, 
x_ªmove_size
;

830 
ba£
, 
size
, 
def
, 
dummy
;

831 
u64
 
chunk_size
, 
gøn_size
;

832 
mår_ty≥
 
ty≥
;

833 
ödex_good
;

834 
i
;

836 i‡(!
	`is_˝u
(
INTEL
Ë|| 
íabÀ_mår_˛ónup
 < 1)

839 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

840 
def
 &= 0xff;

841 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

845 
	`mem£t
(
ønge_°©e
, 0, (range_state));

846 
i
 = 0; i < 
num_v¨_ønges
; i++) {

847 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

848 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

849 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

850 
ønge_°©e
[
i
].
ty≥
 =Åype;

854 i‡(!
	`mår_√ed_˛ónup
())

858 
	`¥ötk
(
KERN_DEBUG
 "original variable MTRRs\n");

859 
	`¥öt_out_mår_ønge_°©e
();

861 
	`mem£t
(
ønge
, 0, (range));

862 
x_ªmove_size
 = 0;

863 
x_ªmove_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

864 i‡(
mår_tom2
)

865 
x_ªmove_size
 = (
mår_tom2
 >> 
PAGE_SHIFT
Ë- 
x_ªmove_ba£
;

867 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
, 0, 
x_ªmove_ba£
, 
x_ªmove_size
);

872 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_range, 0,

873 (1ULL<<(20 - 
PAGE_SHIFT
)) - 1);

875 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

877 
ønge_sums
 = 
	`sum_ønges
(
ønge
, 
ƒ_ønge
);

878 
	`¥ötk
(
KERN_INFO
 "total RAM covered: %ldM\n",

879 
ønge_sums
 >> (20 - 
PAGE_SHIFT
));

881 i‡(
mår_chunk_size
 && 
mår_gøn_size
) {

882 
i
 = 0;

883 
	`mår_ˇlc_ønge_°©e
(
mår_chunk_size
, 
mår_gøn_size
,

884 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

886 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

888 i‡(!
ªsu…
[
i
].
bad
) {

889 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

890 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

891 
	`¥öt_out_mår_ønge_°©e
();

894 
	`¥ötk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

898 
i
 = 0;

899 
	`mem£t
(
mö_loss_p‚
, 0xff, (min_loss_pfn));

900 
	`mem£t
(
ªsu…
, 0, (result));

901 
gøn_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

903 
chunk_size
 = 
gøn_size
; chunk_size < (1ULL<<32);

904 
chunk_size
 <<= 1) {

906 i‡(
i
 >
NUM_RESULT
)

909 
	`mår_ˇlc_ønge_°©e
(
chunk_size
, 
gøn_size
,

910 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

911 i‡(
debug_¥öt
) {

912 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

913 
	`¥ötk
(
KERN_INFO
 "\n");

916 
i
++;

921 
ödex_good
 = 
	`mår_£¨ch_›timÆ_ödex
();

923 i‡(
ödex_good
 != -1) {

924 
	`¥ötk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

925 
i
 = 
ödex_good
;

926 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

929 
chunk_size
 = 
ªsu…
[
i
].
chunk_sizek
;

930 
chunk_size
 <<= 10;

931 
gøn_size
 = 
ªsu…
[
i
].
gøn_sizek
;

932 
gøn_size
 <<= 10;

933 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

934 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

935 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

936 
	`¥öt_out_mår_ønge_°©e
();

940 
i
 = 0; i < 
NUM_RESULT
; i++)

941 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

944 
	`¥ötk
(
KERN_INFO
 "mtrr_cleanup: canÇot find optimal value\n");

945 
	`¥ötk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

948 
	}
}

950 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

953 
	}
}

956 
	gdißbÀ_mår_åim
;

958 
__öô
 
	$dißbÀ_mår_åim_£tup
(*
°r
)

960 
dißbÀ_mår_åim
 = 1;

962 
	}
}

963 
óæy_∑øm
("dißbÀ_mår_åim", 
dißbÀ_mår_åim_£tup
);

971 
	#Tom2E«bÀd
 (1U << 21)

	)

972 
	#Tom2F‹˚MemTy≥WB
 (1U << 22)

	)

974 
__öô
 
	$amd_•ecül_deÁu…_mår
()

976 
u32
 
l
, 
h
;

978 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_AMD
)

980 i‡(
boŸ_˝u_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

983 i‡(
	`rdm§_ß„
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

989 i‡((
l
 & (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
)) ==

990 (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
))

993 
	}
}

995 
u64
 
__öô


996 
	$ªÆ_åim_mem‹y
(
°¨t_p‚
, 
limô_p‚
)

998 
u64
 
åim_°¨t
, 
åim_size
;

1000 
åim_°¨t
 = 
°¨t_p‚
;

1001 
åim_°¨t
 <<
PAGE_SHIFT
;

1003 
åim_size
 = 
limô_p‚
;

1004 
åim_size
 <<
PAGE_SHIFT
;

1005 
åim_size
 -
åim_°¨t
;

1007  
	`e820_upd©e_ønge
(
åim_°¨t
, 
åim_size
, 
E820_RAM
, 
E820_RESERVED
);

1008 
	}
}

1021 
__öô
 
	$mår_åim_unˇched_mem‹y
(
íd_p‚
)

1023 
i
, 
ba£
, 
size
, 
highe°_p‚
 = 0, 
def
, 
dummy
;

1024 
mår_ty≥
 
ty≥
;

1025 
u64
 
tŸÆ_åim_size
;

1027 
num
[
MTRR_NUM_TYPES
 + 1];

1033 i‡(!
	`is_˝u
(
INTEL
Ë|| 
dißbÀ_mår_åim
)

1036 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

1037 
def
 &= 0xff;

1038 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

1042 
	`mem£t
(
ønge_°©e
, 0, (range_state));

1043 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1044 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

1045 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

1046 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

1047 
ønge_°©e
[
i
].
ty≥
 =Åype;

1051 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1052 
ty≥
 = 
ønge_°©e
[
i
].type;

1053 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

1055 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

1056 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1057 i‡(
highe°_p‚
 < 
ba£
 + 
size
)

1058 
highe°_p‚
 = 
ba£
 + 
size
;

1062 i‡(!
highe°_p‚
) {

1063 
	`¥ötk
(
KERN_INFO
 "CPU MTRRsáll blank - virtualized system.\n");

1068 
	`mem£t
(
num
, 0, (num));

1069 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1070 
ty≥
 = 
ønge_°©e
[
i
].type;

1071 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

1073 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1074 i‡(!
size
)

1075 
ty≥
 = 
MTRR_NUM_TYPES
;

1076 
num
[
ty≥
]++;

1080 i‡(!
num
[
MTRR_TYPE_WRBACK
])

1084 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

1085 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

1088 
	`mem£t
(
ønge
, 0, (range));

1089 
ƒ_ønge
 = 0;

1090 i‡(
mår_tom2
) {

1091 
ønge
[
ƒ_ønge
].
°¨t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

1092 
ønge
[
ƒ_ønge
].
íd
 = (
mår_tom2
 >> 
PAGE_SHIFT
) - 1;

1093 i‡(
highe°_p‚
 < 
ønge
[
ƒ_ønge
].
íd
 + 1)

1094 
highe°_p‚
 = 
ønge
[
ƒ_ønge
].
íd
 + 1;

1095 
ƒ_ønge
++;

1097 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
,Çr_range, 0, 0);

1100 
tŸÆ_åim_size
 = 0;

1101 i‡(
ønge
[0].
°¨t
)

1102 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(0, 
ønge
[0].
°¨t
);

1105 
i
 = 0; i < 
ƒ_ønge
 - 1; i++) {

1106 i‡(
ønge
[
i
].
íd
 + 1 <Ñ™ge[i+1].
°¨t
)

1107 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1108 
ønge
[
i
+1].
°¨t
);

1112 
i
 = 
ƒ_ønge
 - 1;

1113 i‡(
ønge
[
i
].
íd
 + 1 < 
íd_p‚
)

1114 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1115 
íd_p‚
);

1117 i‡(
tŸÆ_åim_size
) {

1118 
	`¥_w¨nög
("WARNING: BIOS bug: CPU MTRR†d⁄'àcovîáŒ o‡mem‹y,Üosög %ŒuMB o‡RAM.\n", 
tŸÆ_åim_size
 >> 20);

1120 i‡(!
ch™ged_by_mår_˛ónup
)

1121 
	`WARN_ON
(1);

1123 
	`¥_öfo
("updateÉ820 for mtrr\n");

1124 
	`upd©e_e820
();

1130 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

5 
	#DEBUG


	)

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/io.h
>

11 
	~<löux/mm.h
>

13 
	~<asm/¥o˚ss‹-Êags.h
>

14 
	~<asm/˝u„©uª.h
>

15 
	~<asm/ébÊush.h
>

16 
	~<asm/sy°em.h
>

17 
	~<asm/mår.h
>

18 
	~<asm/m§.h
>

19 
	~<asm/∑t.h
>

21 
	~"mår.h
"

23 
	sfixed_ønge_block
 {

24 
	mba£_m§
;

25 
	mønges
;

28 
fixed_ønge_block
 
	gfixed_ønge_blocks
[] = {

29 { 
MSR_MTRRfix64K_00000
, 1 },

30 { 
MSR_MTRRfix16K_80000
, 2 },

31 { 
MSR_MTRRfix4K_C0000
, 8 },

35 
	gsmp_ch™ges_mask
;

36 
	gmår_°©e_£t
;

37 
u64
 
	gmår_tom2
;

39 
mår_°©e_ty≥
 
	gmår_°©e
;

40 
EXPORT_SYMBOL_GPL
(
mår_°©e
);

50 
ölöe
 
	$k8_check_syscfg_døm_mod_í
()

52 
u32
 
lo
, 
hi
;

54 i‡(!((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) &&

55 (
boŸ_˝u_d©a
.
x86
 >= 0x0f)))

58 
	`rdm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

59 i‡(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

60 
	`¥ötk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

62 
	`smp_¥o˚ss‹_id
());

63 
lo
 &~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

64 
	`mår_wrm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

66 
	}
}

74 
u8
 
	$mår_ty≥_lookup
(
u64
 
°¨t
, u64 
íd
)

76 
i
;

77 
u64
 
ba£
, 
mask
;

78 
u8
 
¥ev_m©ch
, 
cuº_m©ch
;

80 i‡(!
mår_°©e_£t
)

83 i‡(!
mår_°©e
.
íabÀd
)

87 
íd
--;

90 i‡(
mår_°©e
.
have_fixed
 && (
°¨t
 < 0x100000)) {

91 
idx
;

93 i‡(
°¨t
 < 0x80000) {

94 
idx
 = 0;

95 
idx
 +(
°¨t
 >> 16);

96  
mår_°©e
.
fixed_ønges
[
idx
];

97 } i‡(
°¨t
 < 0xC0000) {

98 
idx
 = 1 * 8;

99 
idx
 +((
°¨t
 - 0x80000) >> 14);

100  
mår_°©e
.
fixed_ønges
[
idx
];

101 } i‡(
°¨t
 < 0x1000000) {

102 
idx
 = 3 * 8;

103 
idx
 +((
°¨t
 - 0xC0000) >> 12);

104  
mår_°©e
.
fixed_ønges
[
idx
];

113 i‡(!(
mår_°©e
.
íabÀd
 & 2))

114  
mår_°©e
.
def_ty≥
;

116 
¥ev_m©ch
 = 0xFF;

117 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

118 
°¨t_°©e
, 
íd_°©e
;

120 i‡(!(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11)))

123 
ba£
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
) << 32) +

124 (
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

125 
mask
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
) << 32) +

126 (
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & 
PAGE_MASK
);

128 
°¨t_°©e
 = ((
°¨t
 & 
mask
Ë=(
ba£
 & mask));

129 
íd_°©e
 = ((
íd
 & 
mask
Ë=(
ba£
 & mask));

130 i‡(
°¨t_°©e
 !
íd_°©e
)

133 i‡((
°¨t
 & 
mask
Ë!(
ba£
 & mask))

136 
cuº_m©ch
 = 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff;

137 i‡(
¥ev_m©ch
 == 0xFF) {

138 
¥ev_m©ch
 = 
cuº_m©ch
;

142 i‡(
¥ev_m©ch
 =
MTRR_TYPE_UNCACHABLE
 ||

143 
cuº_m©ch
 =
MTRR_TYPE_UNCACHABLE
) {

144  
MTRR_TYPE_UNCACHABLE
;

147 i‡((
¥ev_m©ch
 =
MTRR_TYPE_WRBACK
 &&

148 
cuº_m©ch
 =
MTRR_TYPE_WRTHROUGH
) ||

149 (
¥ev_m©ch
 =
MTRR_TYPE_WRTHROUGH
 &&

150 
cuº_m©ch
 =
MTRR_TYPE_WRBACK
)) {

151 
¥ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

152 
cuº_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

155 i‡(
¥ev_m©ch
 !
cuº_m©ch
)

156  
MTRR_TYPE_UNCACHABLE
;

159 i‡(
mår_tom2
) {

160 i‡(
°¨t
 >(1ULL<<32Ë&& (
íd
 < 
mår_tom2
))

161  
MTRR_TYPE_WRBACK
;

164 i‡(
¥ev_m©ch
 != 0xFF)

165  
¥ev_m©ch
;

167  
mår_°©e
.
def_ty≥
;

168 
	}
}

172 
	$gë_mår_v¨_ønge
(
ödex
, 
mår_v¨_ønge
 *
vr
)

174 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

175 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

176 
	}
}

179 
	$fûl_mår_v¨_ønge
(
ödex
,

180 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

182 
mår_v¨_ønge
 *
vr
;

184 
vr
 = 
mår_°©e
.
v¨_ønges
;

186 
vr
[
ödex
].
ba£_lo
 = base_lo;

187 
vr
[
ödex
].
ba£_hi
 = base_hi;

188 
vr
[
ödex
].
mask_lo
 = mask_lo;

189 
vr
[
ödex
].
mask_hi
 = mask_hi;

190 
	}
}

192 
	$gë_fixed_ønges
(
mår_ty≥
 *
‰s
)

194 *
p
 = (*)
‰s
;

195 
i
;

197 
	`k8_check_syscfg_døm_mod_í
();

199 
	`rdm§
(
MSR_MTRRfix64K_00000
, 
p
[0],Ö[1]);

201 
i
 = 0; i < 2; i++)

202 
	`rdm§
(
MSR_MTRRfix16K_80000
 + 
i
, 
p
[2 + i * 2],Ö[3 + i * 2]);

203 
i
 = 0; i < 8; i++)

204 
	`rdm§
(
MSR_MTRRfix4K_C0000
 + 
i
, 
p
[6 + i * 2],Ö[7 + i * 2]);

205 
	}
}

207 
	$mår_ßve_fixed_ønges
(*
öfo
)

209 i‡(
˝u_has_mår
)

210 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

211 
	}
}

213 
__öôd©a
 
	gœ°_fixed_°¨t
;

214 
__öôd©a
 
	gœ°_fixed_íd
;

215 
mår_ty≥
 
__öôd©a
 
	gœ°_fixed_ty≥
;

217 
__öô
 
	$¥öt_fixed_œ°
()

219 i‡(!
œ°_fixed_íd
)

222 
	`¥_debug
(" %05X-%05X %s\n", 
œ°_fixed_°¨t
,

223 
œ°_fixed_íd
 - 1, 
	`mår_©åib_to_°r
(
œ°_fixed_ty≥
));

225 
œ°_fixed_íd
 = 0;

226 
	}
}

228 
__öô
 
	$upd©e_fixed_œ°
(
ba£
, 
íd
,

229 
mår_ty≥
 
ty≥
)

231 
œ°_fixed_°¨t
 = 
ba£
;

232 
œ°_fixed_íd
 = 
íd
;

233 
œ°_fixed_ty≥
 = 
ty≥
;

234 
	}
}

236 
__öô


237 
	$¥öt_fixed
(
ba£
, 
°ï
, c⁄° 
mår_ty≥
 *
ty≥s
)

239 
i
;

241 
i
 = 0; i < 8; ++i, ++
ty≥s
, 
ba£
 +
°ï
) {

242 i‡(
œ°_fixed_íd
 == 0) {

243 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

246 i‡(
œ°_fixed_íd
 =
ba£
 && 
œ°_fixed_ty≥
 =*
ty≥s
) {

247 
œ°_fixed_íd
 = 
ba£
 + 
°ï
;

251 
	`¥öt_fixed_œ°
();

252 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

254 
	}
}

256 
¥ï¨e_£t
();

257 
po°_£t
();

259 
__öô
 
	$¥öt_mår_°©e
()

261 
i
;

262 
high_width
;

264 
	`¥_debug
("MTRR defaultÅype: %s\n",

265 
	`mår_©åib_to_°r
(
mår_°©e
.
def_ty≥
));

266 i‡(
mår_°©e
.
have_fixed
) {

267 
	`¥_debug
("MTRR fixedÑanges %sabled:\n",

268 
mår_°©e
.
íabÀd
 & 1 ? "en" : "dis");

269 
	`¥öt_fixed
(0x00000, 0x10000, 
mår_°©e
.
fixed_ønges
 + 0);

270 
i
 = 0; i < 2; ++i)

271 
	`¥öt_fixed
(0x80000 + 
i
 * 0x20000, 0x04000,

272 
mår_°©e
.
fixed_ønges
 + (
i
 + 1) * 8);

273 
i
 = 0; i < 8; ++i)

274 
	`¥öt_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000,

275 
mår_°©e
.
fixed_ønges
 + (
i
 + 3) * 8);

278 
	`¥öt_fixed_œ°
();

280 
	`¥_debug
("MTRR variableÑanges %sabled:\n",

281 
mår_°©e
.
íabÀd
 & 2 ? "en" : "dis");

282 i‡(
size_‹_mask
 & 0xffffffffUL)

283 
high_width
 = 
	`ffs
(
size_‹_mask
 & 0xffffffffUL) - 1;

285 
high_width
 = 
	`ffs
(
size_‹_mask
>>32) + 32 - 1;

286 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

288 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

289 i‡(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11))

290 
	`¥_debug
(" %u base %0*X%05X000 mask %0*X%05X000 %s\n",

291 
i
,

292 
high_width
,

293 
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
,

294 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 >> 12,

295 
high_width
,

296 
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
,

297 
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 >> 12,

298 
	`mår_©åib_to_°r
(
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff));

300 
	`¥_debug
(" %u dißbÀd\n", 
i
);

302 i‡(
mår_tom2
)

303 
	`¥_debug
("TOM2: %016Œxák®%ŒdM\n", 
mår_tom2
, mtrr_tom2>>20);

304 
	}
}

307 
__öô
 
	$gë_mår_°©e
()

309 
mår_v¨_ønge
 *
vrs
;

310 
Êags
;

311 
lo
, 
dummy
;

312 
i
;

314 
vrs
 = 
mår_°©e
.
v¨_ønges
;

316 
	`rdm§
(
MSR_MTRRˇp
, 
lo
, 
dummy
);

317 
mår_°©e
.
have_fixed
 = (
lo
 >> 8) & 1;

319 
i
 = 0; i < 
num_v¨_ønges
; i++)

320 
	`gë_mår_v¨_ønge
(
i
, &
vrs
[i]);

321 i‡(
mår_°©e
.
have_fixed
)

322 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

324 
	`rdm§
(
MSR_MTRRdefTy≥
, 
lo
, 
dummy
);

325 
mår_°©e
.
def_ty≥
 = (
lo
 & 0xff);

326 
mår_°©e
.
íabÀd
 = (
lo
 & 0xc00) >> 10;

328 i‡(
	`amd_•ecül_deÁu…_mår
()) {

329 
low
, 
high
;

332 
	`rdm§
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

333 
mår_tom2
 = 
high
;

334 
mår_tom2
 <<= 32;

335 
mår_tom2
 |
low
;

336 
mår_tom2
 &= 0xffffff800000ULL;

339 
	`¥öt_mår_°©e
();

341 
mår_°©e_£t
 = 1;

344 
	`loˇl_úq_ßve
(
Êags
);

345 
	`¥ï¨e_£t
();

347 
	`∑t_öô
();

349 
	`po°_£t
();

350 
	`loˇl_úq_ª°‹e
(
Êags
);

351 
	}
}

354 
__öô
 
	$mår_°©e_w¨n
()

356 
mask
 = 
smp_ch™ges_mask
;

358 i‡(!
mask
)

360 i‡(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

361 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent fixed MTRR settings\n");

362 i‡(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

363 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent variable MTRR settings\n");

364 i‡(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

365 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent MTRRdefType settings\n");

367 
	`¥ötk
(
KERN_INFO
 "mtrr:Örobably your BIOS doesÇot setupáll CPUs.\n");

368 
	`¥ötk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

369 
	}
}

376 
	$mår_wrm§
(
m§
, 
a
, 
b
)

378 i‡(
	`wrm§_ß„
(
m§
, 
a
, 
b
) < 0) {

379 
	`¥ötk
(
KERN_ERR


381 
	`smp_¥o˚ss‹_id
(), 
m§
, 
a
, 
b
);

383 
	}
}

392 
	$£t_fixed_ønge
(
m§
, 
boﬁ
 *
ch™ged
, *
m§w‹ds
)

394 
lo
, 
hi
;

396 
	`rdm§
(
m§
, 
lo
, 
hi
);

398 i‡(
lo
 !
m§w‹ds
[0] || 
hi
 != msrwords[1]) {

399 
	`mår_wrm§
(
m§
, 
m§w‹ds
[0], msrwords[1]);

400 *
ch™ged
 = 
åue
;

402 
	}
}

413 
	$gíîic_gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚_ªg
)

415 
lba£
, 
lsize
;

416 
mår_ty≥
 
…y≥
;

417 
i
, 
max
;

419 
max
 = 
num_v¨_ønges
;

420 i‡(
ª∂a˚_ªg
 >0 &&Ñïœ˚_ªg < 
max
)

421  
ª∂a˚_ªg
;

423 
i
 = 0; i < 
max
; ++i) {

424 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

425 i‡(
lsize
 == 0)

426  
i
;

429  -
ENOSPC
;

430 
	}
}

432 
	$gíîic_gë_mår
(
ªg
, *
ba£
,

433 *
size
, 
mår_ty≥
 *
ty≥
)

435 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

436 
tmp
, 
hi
;

437 
˝u
;

443 
˝u
 = 
	`gë_˝u
();

445 
	`rdm§
(
	`MTRRphysMask_MSR
(
ªg
), 
mask_lo
, 
mask_hi
);

447 i‡((
mask_lo
 & 0x800) == 0) {

449 *
ba£
 = 0;

450 *
size
 = 0;

451 *
ty≥
 = 0;

452 
out_put_˝u
;

455 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
ba£_lo
, 
ba£_hi
);

458 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
Ë| 
mask_lo
 >> PAGE_SHIFT;

459 
mask_lo
 = 
size_‹_mask
 | 
tmp
;

462 
hi
 = 
	`Ês
(
tmp
);

463 i‡(
hi
 > 0) {

464 
tmp
 |~((1<<(
hi
 - 1)) - 1);

466 i‡(
tmp
 !
mask_lo
) {

467 
	`WARN_ONCE
(1, 
KERN_INFO
 "mtrr: your BIOS has set upán incorrect mask, fixing it up.\n");

468 
mask_lo
 = 
tmp
;

476 *
size
 = -
mask_lo
;

477 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
Ë| 
ba£_lo
 >> PAGE_SHIFT;

478 *
ty≥
 = 
ba£_lo
 & 0xff;

480 
out_put_˝u
:

481 
	`put_˝u
();

482 
	}
}

489 
	$£t_fixed_ønges
(
mår_ty≥
 *
‰s
)

491 *
ßved
 = (*)
‰s
;

492 
boﬁ
 
ch™ged
 = 
Ál£
;

493 
block
 = -1, 
ønge
;

495 
	`k8_check_syscfg_døm_mod_í
();

497 
fixed_ønge_blocks
[++
block
].
ønges
) {

498 
ønge
 = 0;Ñ™gê< 
fixed_ønge_blocks
[
block
].
ønges
;Ñange++)

499 
	`£t_fixed_ønge
(
fixed_ønge_blocks
[
block
].
ba£_m§
 + 
ønge
,

500 &
ch™ged
, (*)
ßved
++);

503  
ch™ged
;

504 
	}
}

510 
boﬁ
 
	$£t_mår_v¨_ønges
(
ödex
, 
mår_v¨_ønge
 *
vr
)

512 
lo
, 
hi
;

513 
boﬁ
 
ch™ged
 = 
Ál£
;

515 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
lo
, 
hi
);

516 i‡((
vr
->
ba£_lo
 & 0xfffff0ffULË!(
lo
 & 0xfffff0ffUL)

517 || (
vr
->
ba£_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

518 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

520 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

521 
ch™ged
 = 
åue
;

524 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
lo
, 
hi
);

526 i‡((
vr
->
mask_lo
 & 0xfffff800ULË!(
lo
 & 0xfffff800UL)

527 || (
vr
->
mask_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

528 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

529 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

530 
ch™ged
 = 
åue
;

532  
ch™ged
;

533 
	}
}

535 
u32
 
	gde·y≥_lo
, 
	gde·y≥_hi
;

543 
	$£t_mår_°©e
()

545 
ch™ge_mask
 = 0;

546 
i
;

548 
i
 = 0; i < 
num_v¨_ønges
; i++) {

549 i‡(
	`£t_mår_v¨_ønges
(
i
, &
mår_°©e
.
v¨_ønges
[i]))

550 
ch™ge_mask
 |
MTRR_CHANGE_MASK_VARIABLE
;

553 i‡(
mår_°©e
.
have_fixed
 && 
	`£t_fixed_ønges
(mår_°©e.
fixed_ønges
))

554 
ch™ge_mask
 |
MTRR_CHANGE_MASK_FIXED
;

560 i‡((
de·y≥_lo
 & 0xffË!
mår_°©e
.
def_ty≥


561 || ((
de·y≥_lo
 & 0xc00Ë>> 10Ë!
mår_°©e
.
íabÀd
) {

563 
de·y≥_lo
 = (de·y≥_lÿ& ~0xcffË| 
mår_°©e
.
def_ty≥
 |

564 (
mår_°©e
.
íabÀd
 << 10);

565 
ch™ge_mask
 |
MTRR_CHANGE_MASK_DEFTYPE
;

568  
ch™ge_mask
;

569 
	}
}

572 
	g¸4
;

573 
DEFINE_SPINLOCK
(
£t_©omicôy_lock
);

582 
	$¥ï¨e_£t
(Ë
	$__acquúes
(
£t_©omicôy_lock
)

584 
¸0
;

593 
	`•ö_lock
(&
£t_©omicôy_lock
);

596 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

597 
	`wrôe_¸0
(
¸0
);

598 
	`wbövd
();

601 i‡(
˝u_has_pge
) {

602 
¸4
 = 
	`ªad_¸4
();

603 
	`wrôe_¸4
(
¸4
 & ~
X86_CR4_PGE
);

607 
	`__Êush_éb
();

610 
	`rdm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

613 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
 & ~0xcff, 
de·y≥_hi
);

614 
	}
}

616 
	$po°_£t
(Ë
	$__ªÀa£s
(
£t_©omicôy_lock
)

619 
	`__Êush_éb
();

622 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

625 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

628 i‡(
˝u_has_pge
)

629 
	`wrôe_¸4
(
¸4
);

630 
	`•ö_u∆ock
(&
£t_©omicôy_lock
);

631 
	}
}

633 
	$gíîic_£t_Æl
()

635 
mask
, 
cou¡
;

636 
Êags
;

638 
	`loˇl_úq_ßve
(
Êags
);

639 
	`¥ï¨e_£t
();

642 
mask
 = 
	`£t_mår_°©e
();

645 
	`∑t_öô
();

647 
	`po°_£t
();

648 
	`loˇl_úq_ª°‹e
(
Êags
);

651 
cou¡
 = 0; cou¡ <  
mask
 * 8; ++count) {

652 i‡(
mask
 & 0x01)

653 
	`£t_bô
(
cou¡
, &
smp_ch™ges_mask
);

654 
mask
 >>= 1;

657 
	}
}

669 
	$gíîic_£t_mår
(
ªg
, 
ba£
,

670 
size
, 
mår_ty≥
 
ty≥
)

672 
Êags
;

673 
mår_v¨_ønge
 *
vr
;

675 
vr
 = &
mår_°©e
.
v¨_ønges
[
ªg
];

677 
	`loˇl_úq_ßve
(
Êags
);

678 
	`¥ï¨e_£t
();

680 i‡(
size
 == 0) {

685 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 0, 0);

686 
	`mem£t
(
vr
, 0, (
mår_v¨_ønge
));

688 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty≥
;

689 
vr
->
ba£_hi
 = (
ba£
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

690 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

691 
vr
->
mask_hi
 = (-
size
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

693 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

694 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 
vr
->
mask_lo
, vr->
mask_hi
);

697 
	`po°_£t
();

698 
	`loˇl_úq_ª°‹e
(
Êags
);

699 
	}
}

701 
	$gíîic_vÆid©e_add_∑ge
(
ba£
, 
size
,

702 
ty≥
)

704 
lba£
, 
œ°
;

710 i‡(
	`is_˝u
(
INTEL
Ë&& 
boŸ_˝u_d©a
.
x86
 == 6 &&

711 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

712 
boŸ_˝u_d©a
.
x86_mask
 <= 7) {

713 i‡(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

714 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸ 4 MiBálig√d\n", 
ba£
);

715  -
EINVAL
;

717 i‡(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

718 (
ty≥
 =
MTRR_TYPE_WRCOMB


719 || 
ty≥
 =
MTRR_TYPE_WRBACK
)) {

720 
	`¥_w¨nög
("mtrr: writable mtrr between 0x70000000ánd 0x7003FFFF may hangÅhe CPU.\n");

721  -
EINVAL
;

729 
œ°
 = 
ba£
 + 
size
 - 1;

730 
lba£
 = 
ba£
; !÷ba£ & 1Ë&& (
œ°
 & 1);

731 
lba£
 =Üba£ >> 1, 
œ°
 =Üast >> 1)

733 i‡(
lba£
 !
œ°
) {

734 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸálig√d o¿®size(0x%lx000Ëbound¨y\n", 
ba£
, 
size
);

735  -
EINVAL
;

738 
	}
}

740 
	$gíîic_have_wrcomb
()

742 
c⁄fig
, 
dummy
;

743 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

744  
c⁄fig
 & (1 << 10);

745 
	}
}

747 
	$posôive_have_wrcomb
()

750 
	}
}

755 
mår_›s
 
	ggíîic_mår_›s
 = {

756 .
u£_öãl_if
 = 1,

757 .
	g£t_Æl
 = 
gíîic_£t_Æl
,

758 .
	ggë
 = 
gíîic_gë_mår
,

759 .
	ggë_‰ì_ªgi⁄
 = 
gíîic_gë_‰ì_ªgi⁄
,

760 .
	g£t
 = 
gíîic_£t_mår
,

761 .
	gvÆid©e_add_∑ge
 = 
gíîic_vÆid©e_add_∑ge
,

762 .
	ghave_wrcomb
 = 
gíîic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<löux/ˇ∑bûôy.h
>

2 
	~<löux/£q_fûe.h
>

3 
	~<löux/uac˚ss.h
>

4 
	~<löux/¥oc_fs.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/˘y≥.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

10 
	#LINE_SIZE
 80

	)

12 
	~<asm/mår.h
>

14 
	~"mår.h
"

16 
	#FILE_FCOUNT
(
f
Ë(((
£q_fûe
 *)((f)->
¥iv©e_d©a
))->
¥iv©e
)

	)

18 c⁄° *c⁄° 
	gmår_°rögs
[
MTRR_NUM_TYPES
] =

29 c⁄° *
	$mår_©åib_to_°r
(
x
)

31  (
x
 <6Ë? 
mår_°rögs
[x] : "?";

32 
	}
}

34 #ifde‡
CONFIG_PROC_FS


37 
	$mår_fûe_add
(
ba£
, 
size
,

38 
ty≥
, 
boﬁ
 
ö¸emít
, 
fûe
 *fûe, 
∑ge
)

40 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

41 
ªg
, 
max
;

43 
max
 = 
num_v¨_ønges
;

44 i‡(
fcou¡
 =
NULL
) {

45 
fcou¡
 = 
	`kzÆloc
(
max
 *  *fcou¡, 
GFP_KERNEL
);

46 i‡(!
fcou¡
)

47  -
ENOMEM
;

48 
	`FILE_FCOUNT
(
fûe
Ë
fcou¡
;

50 i‡(!
∑ge
) {

51 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

52  -
EINVAL
;

53 
ba£
 >>
PAGE_SHIFT
;

54 
size
 >>
PAGE_SHIFT
;

56 
ªg
 = 
	`mår_add_∑ge
(
ba£
, 
size
, 
ty≥
, 
åue
);

57 i‡(
ªg
 >= 0)

58 ++
fcou¡
[
ªg
];

59  
ªg
;

60 
	}
}

63 
	$mår_fûe_dñ
(
ba£
, 
size
,

64 
fûe
 *fûe, 
∑ge
)

66 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

67 
ªg
;

69 i‡(!
∑ge
) {

70 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

71  -
EINVAL
;

72 
ba£
 >>
PAGE_SHIFT
;

73 
size
 >>
PAGE_SHIFT
;

75 
ªg
 = 
	`mår_dñ_∑ge
(-1, 
ba£
, 
size
);

76 i‡(
ªg
 < 0)

77  
ªg
;

78 i‡(
fcou¡
 =
NULL
)

79  
ªg
;

80 i‡(
fcou¡
[
ªg
] < 1)

81  -
EINVAL
;

82 --
fcou¡
[
ªg
];

83  
ªg
;

84 
	}
}

92 
ssize_t


93 
	$mår_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 * 
µos
)

95 
i
, 
îr
;

96 
ªg
;

97 
ba£
, 
size
;

98 *
±r
;

99 
löe
[
LINE_SIZE
];

100 
Àngth
;

101 
size_t
 
löñí
;

103 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

104  -
EPERM
;

106 
	`mem£t
(
löe
, 0, 
LINE_SIZE
);

108 
Àngth
 = 
Àn
;

109 
Àngth
--;

111 i‡(
Àngth
 > 
LINE_SIZE
 - 1)

112 
Àngth
 = 
LINE_SIZE
 - 1;

114 i‡(
Àngth
 < 0)

115  -
EINVAL
;

117 i‡(
	`c›y_‰om_u£r
(
löe
, 
buf
, 
Àngth
))

118  -
EFAULT
;

120 
löñí
 = 
	`°æí
(
löe
);

121 
±r
 = 
löe
 + 
löñí
 - 1;

122 i‡(
löñí
 && *
±r
 == '\n')

123 *
±r
 = '\0';

125 i‡(!
	`°∫cmp
(
löe
, "disable=", 8)) {

126 
ªg
 = 
	`sim∂e_°πoul
(
löe
 + 8, &
±r
, 0);

127 
îr
 = 
	`mår_dñ_∑ge
(
ªg
, 0, 0);

128 i‡(
îr
 < 0)

129  
îr
;

130  
Àn
;

133 i‡(
	`°∫cmp
(
löe
, "base=", 5))

134  -
EINVAL
;

136 
ba£
 = 
	`sim∂e_°πouŒ
(
löe
 + 5, &
±r
, 0);

137 
±r
 = 
	`skù_•a˚s
(ptr);

139 i‡(
	`°∫cmp
(
±r
, "size=", 5))

140  -
EINVAL
;

142 
size
 = 
	`sim∂e_°πouŒ
(
±r
 + 5, &ptr, 0);

143 i‡((
ba£
 & 0xfffË|| (
size
 & 0xfff))

144  -
EINVAL
;

145 
±r
 = 
	`skù_•a˚s
(ptr);

147 i‡(
	`°∫cmp
(
±r
, "type=", 5))

148  -
EINVAL
;

149 
±r
 = 
	`skù_•a˚s
(ptr + 5);

151 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

152 i‡(
	`°rcmp
(
±r
, 
mår_°rögs
[
i
]))

154 
ba£
 >>
PAGE_SHIFT
;

155 
size
 >>
PAGE_SHIFT
;

156 
îr
 = 
	`mår_add_∑ge
(()
ba£
, ()
size
, 
i
, 
åue
);

157 i‡(
îr
 < 0)

158  
îr
;

159  
Àn
;

161  -
EINVAL
;

162 
	}
}

165 
	$mår_io˘l
(
fûe
 *fûe, 
cmd
, 
__¨g
)

167 
îr
 = 0;

168 
mår_ty≥
 
ty≥
;

169 
size
;

170 
mår_£¡ry
 
£¡ry
;

171 
mår_gíåy
 
gíåy
;

172 
__u£r
 *
¨g
 = (__u£∏*Ë
__¨g
;

174 
cmd
) {

175 
MTRRIOC_ADD_ENTRY
:

176 
MTRRIOC_SET_ENTRY
:

177 
MTRRIOC_DEL_ENTRY
:

178 
MTRRIOC_KILL_ENTRY
:

179 
MTRRIOC_ADD_PAGE_ENTRY
:

180 
MTRRIOC_SET_PAGE_ENTRY
:

181 
MTRRIOC_DEL_PAGE_ENTRY
:

182 
MTRRIOC_KILL_PAGE_ENTRY
:

183 i‡(
	`c›y_‰om_u£r
(&
£¡ry
, 
¨g
,  sentry))

184  -
EFAULT
;

186 
MTRRIOC_GET_ENTRY
:

187 
MTRRIOC_GET_PAGE_ENTRY
:

188 i‡(
	`c›y_‰om_u£r
(&
gíåy
, 
¨g
,  gentry))

189  -
EFAULT
;

191 #ifde‡
CONFIG_COMPAT


192 
MTRRIOC32_ADD_ENTRY
:

193 
MTRRIOC32_SET_ENTRY
:

194 
MTRRIOC32_DEL_ENTRY
:

195 
MTRRIOC32_KILL_ENTRY
:

196 
MTRRIOC32_ADD_PAGE_ENTRY
:

197 
MTRRIOC32_SET_PAGE_ENTRY
:

198 
MTRRIOC32_DEL_PAGE_ENTRY
:

199 
MTRRIOC32_KILL_PAGE_ENTRY
: {

200 
mår_£¡ry32
 
__u£r
 *
s32
;

202 
s32
 = (
mår_£¡ry32
 
__u£r
 *)
__¨g
;

203 
îr
 = 
	`gë_u£r
(
£¡ry
.
ba£
, &
s32
->base);

204 
îr
 |
	`gë_u£r
(
£¡ry
.
size
, &
s32
->size);

205 
îr
 |
	`gë_u£r
(
£¡ry
.
ty≥
, &
s32
->type);

206 i‡(
îr
)

207  
îr
;

210 
MTRRIOC32_GET_ENTRY
:

211 
MTRRIOC32_GET_PAGE_ENTRY
: {

212 
mår_gíåy32
 
__u£r
 *
g32
;

214 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

215 
îr
 = 
	`gë_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

216 
îr
 |
	`gë_u£r
(
gíåy
.
ba£
, &
g32
->base);

217 
îr
 |
	`gë_u£r
(
gíåy
.
size
, &
g32
->size);

218 
îr
 |
	`gë_u£r
(
gíåy
.
ty≥
, &
g32
->type);

219 i‡(
îr
)

220  
îr
;

226 
cmd
) {

228  -
ENOTTY
;

229 
MTRRIOC_ADD_ENTRY
:

230 #ifde‡
CONFIG_COMPAT


231 
MTRRIOC32_ADD_ENTRY
:

233 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

234  -
EPERM
;

235 
îr
 =

236 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

237 
fûe
, 0);

239 
MTRRIOC_SET_ENTRY
:

240 #ifde‡
CONFIG_COMPAT


241 
MTRRIOC32_SET_ENTRY
:

243 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

244  -
EPERM
;

245 
îr
 = 
	`mår_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

247 
MTRRIOC_DEL_ENTRY
:

248 #ifde‡
CONFIG_COMPAT


249 
MTRRIOC32_DEL_ENTRY
:

251 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

252  -
EPERM
;

253 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 0);

255 
MTRRIOC_KILL_ENTRY
:

256 #ifde‡
CONFIG_COMPAT


257 
MTRRIOC32_KILL_ENTRY
:

259 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

260  -
EPERM
;

261 
îr
 = 
	`mår_dñ
(-1, 
£¡ry
.
ba£
, síåy.
size
);

263 
MTRRIOC_GET_ENTRY
:

264 #ifde‡
CONFIG_COMPAT


265 
MTRRIOC32_GET_ENTRY
:

267 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

268  -
EINVAL
;

269 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

272 i‡(
gíåy
.
ba£
 + 
size
 - 1 >(1UL << (8 * (gíåy.sizeË- 
PAGE_SHIFT
))

273 || 
size
 >(1UL << (8 * (
gíåy
.sizeË- 
PAGE_SHIFT
)))

274 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

276 
gíåy
.
ba£
 <<
PAGE_SHIFT
;

277 
gíåy
.
size
 = sizê<< 
PAGE_SHIFT
;

278 
gíåy
.
ty≥
 =Åype;

282 
MTRRIOC_ADD_PAGE_ENTRY
:

283 #ifde‡
CONFIG_COMPAT


284 
MTRRIOC32_ADD_PAGE_ENTRY
:

286 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

287  -
EPERM
;

288 
îr
 =

289 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

290 
fûe
, 1);

292 
MTRRIOC_SET_PAGE_ENTRY
:

293 #ifde‡
CONFIG_COMPAT


294 
MTRRIOC32_SET_PAGE_ENTRY
:

296 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

297  -
EPERM
;

298 
îr
 =

299 
	`mår_add_∑ge
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

301 
MTRRIOC_DEL_PAGE_ENTRY
:

302 #ifde‡
CONFIG_COMPAT


303 
MTRRIOC32_DEL_PAGE_ENTRY
:

305 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

306  -
EPERM
;

307 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 1);

309 
MTRRIOC_KILL_PAGE_ENTRY
:

310 #ifde‡
CONFIG_COMPAT


311 
MTRRIOC32_KILL_PAGE_ENTRY
:

313 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

314  -
EPERM
;

315 
îr
 = 
	`mår_dñ_∑ge
(-1, 
£¡ry
.
ba£
, síåy.
size
);

317 
MTRRIOC_GET_PAGE_ENTRY
:

318 #ifde‡
CONFIG_COMPAT


319 
MTRRIOC32_GET_PAGE_ENTRY
:

321 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

322  -
EINVAL
;

323 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

325 i‡(
size
 !(
	`__ty≥of__
(
gíåy
.size))size)

326 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

328 
gíåy
.
size
 = size;

329 
gíåy
.
ty≥
 =Åype;

334 i‡(
îr
)

335  
îr
;

337 
cmd
) {

338 
MTRRIOC_GET_ENTRY
:

339 
MTRRIOC_GET_PAGE_ENTRY
:

340 i‡(
	`c›y_to_u£r
(
¨g
, &
gíåy
,  gentry))

341 
îr
 = -
EFAULT
;

343 #ifde‡
CONFIG_COMPAT


344 
MTRRIOC32_GET_ENTRY
:

345 
MTRRIOC32_GET_PAGE_ENTRY
: {

346 
mår_gíåy32
 
__u£r
 *
g32
;

348 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

349 
îr
 = 
	`put_u£r
(
gíåy
.
ba£
, &
g32
->base);

350 
îr
 |
	`put_u£r
(
gíåy
.
size
, &
g32
->size);

351 
îr
 |
	`put_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

352 
îr
 |
	`put_u£r
(
gíåy
.
ty≥
, &
g32
->type);

357  
îr
;

358 
	}
}

360 
	$mår_˛o£
(
öode
 *
öo
, 
fûe
 *file)

362 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

363 
i
, 
max
;

365 i‡(
fcou¡
 !
NULL
) {

366 
max
 = 
num_v¨_ønges
;

367 
i
 = 0; i < 
max
; ++i) {

368 
fcou¡
[
i
] > 0) {

369 
	`mår_dñ
(
i
, 0, 0);

370 --
fcou¡
[
i
];

373 
	`k‰ì
(
fcou¡
);

374 
	`FILE_FCOUNT
(
fûe
Ë
NULL
;

376  
	`sögÀ_ªÀa£
(
öo
, 
fûe
);

377 
	}
}

379 
mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
);

381 
	$mår_›í
(
öode
 *öode, 
fûe
 *file)

383 i‡(!
mår_if
)

384  -
EIO
;

385 i‡(!
mår_if
->
gë
)

386  -
ENXIO
;

387  
	`sögÀ_›í
(
fûe
, 
mår_£q_show
, 
NULL
);

388 
	}
}

390 c⁄° 
fûe_›î©i⁄s
 
	gmår_f›s
 = {

391 .
ow√r
 = 
THIS_MODULE
,

392 .
	g›í
 = 
mår_›í
,

393 .
	gªad
 = 
£q_ªad
,

394 .
	gŒ£ek
 = 
£q_l£ek
,

395 .
	gwrôe
 = 
mår_wrôe
,

396 .
	gu∆ocked_io˘l
 = 
mår_io˘l
,

397 .
	gcom∑t_io˘l
 = 
mår_io˘l
,

398 .
	gªÀa£
 = 
mår_˛o£
,

401 
	$mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
)

403 
Á˘‹
;

404 
i
, 
max
, 
Àn
;

405 
mår_ty≥
 
ty≥
;

406 
ba£
, 
size
;

408 
Àn
 = 0;

409 
max
 = 
num_v¨_ønges
;

410 
i
 = 0; i < 
max
; i++) {

411 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

412 i‡(
size
 == 0) {

413 
mår_ußge_èbÀ
[
i
] = 0;

416 i‡(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

418 
Á˘‹
 = 'K';

419 
size
 <<
PAGE_SHIFT
 - 10;

421 
Á˘‹
 = 'M';

422 
size
 >>20 - 
PAGE_SHIFT
;

425 
Àn
 +
	`£q_¥ötf
(
£q
, "reg%02i: base=0x%06lx000 "

427 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
,

428 
Á˘‹
, 
mår_ußge_èbÀ
[
i
],

429 
	`mår_©åib_to_°r
(
ty≥
));

432 
	}
}

434 
__öô
 
	$mår_if_öô
()

436 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

438 i‡((!
	`˝u_has
(
c
, 
X86_FEATURE_MTRR
)) &&

439 (!
	`˝u_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

440 (!
	`˝u_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

441 (!
	`˝u_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

442  -
ENODEV
;

444 
	`¥oc_¸óã
("mår", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mår_f›s
);

446 
	}
}

447 
¨ch_öôˇŒ
(
mår_if_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	#DEBUG


	)

36 
	~<löux/ty≥s.h
>

38 
	~<löux/kvm_∑ø.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/moduÀ.h
>

41 
	~<löux/muãx.h
>

42 
	~<löux/öô.h
>

43 
	~<löux/s‹t.h
>

44 
	~<löux/˝u.h
>

45 
	~<löux/pci.h
>

46 
	~<löux/smp.h
>

48 
	~<asm/¥o˚ss‹.h
>

49 
	~<asm/e820.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/m§.h
>

53 
	~"mår.h
"

55 
u32
 
	gnum_v¨_ønges
;

57 
	gmår_ußge_èbÀ
[
MTRR_MAX_VAR_RANGES
];

58 
DEFINE_MUTEX
(
mår_muãx
);

60 
u64
 
	gsize_‹_mask
, 
	gsize_™d_mask
;

61 
boﬁ
 
	gmår_≠s_dñayed_öô
;

63 
mår_›s
 *
	gmår_›s
[
X86_VENDOR_NUM
];

65 
mår_›s
 *
	gmår_if
;

67 
£t_mår
(
ªg
, 
ba£
,

68 
size
, 
mår_ty≥
 
ty≥
);

70 
	$£t_mår_›s
(
mår_›s
 *
›s
)

72 i‡(
›s
->
víd‹
 && ops->víd‹ < 
X86_VENDOR_NUM
)

73 
mår_›s
[
›s
->
víd‹
] = ops;

74 
	}
}

77 
	$have_wrcomb
()

79 
pci_dev
 *
dev
;

80 
u8
 
ªv
;

82 
dev
 = 
	`pci_gë_˛ass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
);

83 i‡(
dev
 !
NULL
) {

89 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_SERVERWORKS
 &&

90 
dev
->
devi˚
 =
PCI_DEVICE_ID_SERVERWORKS_LE
) {

91 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

92 i‡(
ªv
 <= 5) {

93 
	`¥_öfo
("mtrr: Serverworks LEÑev < 6 detected. Write-combining disabled.\n");

94 
	`pci_dev_put
(
dev
);

102 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_INTEL
 &&

103 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTEL_82451NX
) {

104 
	`¥_öfo
("mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

105 
	`pci_dev_put
(
dev
);

108 
	`pci_dev_put
(
dev
);

110  
mår_if
->
have_wrcomb
 ? mår_if->
	`have_wrcomb
() : 0;

111 
	}
}

114 
__öô
 
	$£t_num_v¨_ønges
()

116 
c⁄fig
 = 0, 
dummy
;

118 i‡(
	`u£_öãl
())

119 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

120 i‡(
	`is_˝u
(
AMD
))

121 
c⁄fig
 = 2;

122 i‡(
	`is_˝u
(
CYRIX
Ë|| is_˝u(
CENTAUR
))

123 
c⁄fig
 = 8;

125 
num_v¨_ønges
 = 
c⁄fig
 & 0xff;

126 
	}
}

128 
__öô
 
	$öô_èbÀ
()

130 
i
, 
max
;

132 
max
 = 
num_v¨_ønges
;

133 
i
 = 0; i < 
max
; i++)

134 
mår_ußge_èbÀ
[
i
] = 1;

135 
	}
}

137 
	s£t_mår_d©a
 {

138 
©omic_t
 
	mcou¡
;

139 
©omic_t
 
	mg©e
;

140 
	msmp_ba£
;

141 
	msmp_size
;

142 
	msmp_ªg
;

143 
mår_ty≥
 
	msmp_ty≥
;

151 
	$ùi_h™dÀr
(*
öfo
)

153 #ifde‡
CONFIG_SMP


154 
£t_mår_d©a
 *
d©a
 = 
öfo
;

155 
Êags
;

157 
	`loˇl_úq_ßve
(
Êags
);

159 
	`©omic_dec
(&
d©a
->
cou¡
);

160 !
	`©omic_ªad
(&
d©a
->
g©e
))

161 
	`˝u_ªœx
();

164 i‡(
d©a
->
smp_ªg
 != ~0U) {

165 
mår_if
->
	`£t
(
d©a
->
smp_ªg
, d©a->
smp_ba£
,

166 
d©a
->
smp_size
, d©a->
smp_ty≥
);

167 } i‡(
mår_≠s_dñayed_öô
) {

171 
mår_if
->
	`£t_Æl
();

174 
	`©omic_dec
(&
d©a
->
cou¡
);

175 
	`©omic_ªad
(&
d©a
->
g©e
))

176 
	`˝u_ªœx
();

178 
	`©omic_dec
(&
d©a
->
cou¡
);

179 
	`loˇl_úq_ª°‹e
(
Êags
);

181 
	}
}

183 
ölöe
 
	$ty≥s_com∑tibÀ
(
mår_ty≥
 
ty≥1
, mår_ty≥ 
ty≥2
)

185  
ty≥1
 =
MTRR_TYPE_UNCACHABLE
 ||

186 
ty≥2
 =
MTRR_TYPE_UNCACHABLE
 ||

187 (
ty≥1
 =
MTRR_TYPE_WRTHROUGH
 && 
ty≥2
 =
MTRR_TYPE_WRBACK
) ||

188 (
ty≥1
 =
MTRR_TYPE_WRBACK
 && 
ty≥2
 =
MTRR_TYPE_WRTHROUGH
);

189 
	}
}

232 
	$£t_mår
(
ªg
, 
ba£
, 
size
, 
mår_ty≥
 
ty≥
)

234 
£t_mår_d©a
 
d©a
;

235 
Êags
;

237 
d©a
.
smp_ªg
 = 
ªg
;

238 
d©a
.
smp_ba£
 = 
ba£
;

239 
d©a
.
smp_size
 = 
size
;

240 
d©a
.
smp_ty≥
 = 
ty≥
;

241 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

244 
	`smp_wmb
();

245 
	`©omic_£t
(&
d©a
.
g©e
, 0);

248 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_h™dÀr
, &
d©a
, 0) != 0)

249 
	`∑nic
("mtrr:Åimed out waiting for other CPUs\n");

251 
	`loˇl_úq_ßve
(
Êags
);

253 
	`©omic_ªad
(&
d©a
.
cou¡
))

254 
	`˝u_ªœx
();

257 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

258 
	`smp_wmb
();

259 
	`©omic_£t
(&
d©a
.
g©e
, 1);

270 i‡(
ªg
 != ~0U)

271 
mår_if
->
	`£t
(
ªg
, 
ba£
, 
size
, 
ty≥
);

272 i‡(!
mår_≠s_dñayed_öô
)

273 
mår_if
->
	`£t_Æl
();

276 
	`©omic_ªad
(&
d©a
.
cou¡
))

277 
	`˝u_ªœx
();

279 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

280 
	`smp_wmb
();

281 
	`©omic_£t
(&
d©a
.
g©e
, 0);

287 
	`©omic_ªad
(&
d©a
.
cou¡
))

288 
	`˝u_ªœx
();

290 
	`loˇl_úq_ª°‹e
(
Êags
);

291 
	}
}

328 
	$mår_add_∑ge
(
ba£
, 
size
,

329 
ty≥
, 
boﬁ
 
ö¸emít
)

331 
lba£
, 
lsize
;

332 
i
, 
ª∂a˚
, 
îr‹
;

333 
mår_ty≥
 
…y≥
;

335 i‡(!
mår_if
)

336  -
ENXIO
;

338 
îr‹
 = 
mår_if
->
	`vÆid©e_add_∑ge
(
ba£
, 
size
, 
ty≥
);

339 i‡(
îr‹
)

340  
îr‹
;

342 i‡(
ty≥
 >
MTRR_NUM_TYPES
) {

343 
	`¥_w¨nög
("mår:Åy≥: %u invÆid\n", 
ty≥
);

344  -
EINVAL
;

348 i‡((
ty≥
 =
MTRR_TYPE_WRCOMB
Ë&& !
	`have_wrcomb
()) {

349 
	`¥_w¨nög
("mtrr: yourÖrocessor doesn't support write-combining\n");

350  -
ENOSYS
;

353 i‡(!
size
) {

354 
	`¥_w¨nög
("mtrr: zero sizedÑequest\n");

355  -
EINVAL
;

358 i‡(
ba£
 & 
size_‹_mask
 || 
size
 & size_or_mask) {

359 
	`¥_w¨nög
("mtrr: base or sizeÉxceedsÅhe MTRR width\n");

360  -
EINVAL
;

363 
îr‹
 = -
EINVAL
;

364 
ª∂a˚
 = -1;

367 
	`gë_⁄löe_˝us
();

370 
	`muãx_lock
(&
mår_muãx
);

371 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

372 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

373 i‡(!
lsize
 || 
ba£
 > 
lba£
 +Üsize - 1 ||

374 
ba£
 + 
size
 - 1 < 
lba£
)

380 i‡(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >Üba£ + 
lsize
 - 1) {

381 i‡(
ba£
 <
lba£
 &&

382 
ba£
 + 
size
 - 1 >
lba£
 + 
lsize
 - 1) {

384 i‡(
ty≥
 =
…y≥
) {

385 
ª∂a˚
 =Ñïœ˚ =-1 ? 
i
 : -2;

387 } i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

390 
	`¥_w¨nög
("mtrr: 0x%lx000,0x%lx000 overlapsÉxisting"

391 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

392 
lsize
);

393 
out
;

396 i‡(
…y≥
 !
ty≥
) {

397 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

399 
	`¥_w¨nög
("mtrr:Åype mismatch for %lx000,%lx000 old: %sÇew: %s\n",

400 
ba£
, 
size
, 
	`mår_©åib_to_°r
(
…y≥
),

401 
	`mår_©åib_to_°r
(
ty≥
));

402 
out
;

404 i‡(
ö¸emít
)

405 ++
mår_ußge_èbÀ
[
i
];

406 
îr‹
 = 
i
;

407 
out
;

410 
i
 = 
mår_if
->
	`gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚
);

411 i‡(
i
 >= 0) {

412 
	`£t_mår
(
i
, 
ba£
, 
size
, 
ty≥
);

413 i‡(
	`likñy
(
ª∂a˚
 < 0)) {

414 
mår_ußge_èbÀ
[
i
] = 1;

416 
mår_ußge_èbÀ
[
i
] = mår_ußge_èbÀ[
ª∂a˚
];

417 i‡(
ö¸emít
)

418 
mår_ußge_èbÀ
[
i
]++;

419 i‡(
	`u∆ikñy
(
ª∂a˚
 !
i
)) {

420 
	`£t_mår
(
ª∂a˚
, 0, 0, 0);

421 
mår_ußge_èbÀ
[
ª∂a˚
] = 0;

425 
	`¥_öfo
("mtrr:Ço more MTRRsávailable\n");

427 
îr‹
 = 
i
;

428 
out
:

429 
	`muãx_u∆ock
(&
mår_muãx
);

430 
	`put_⁄löe_˝us
();

431  
îr‹
;

432 
	}
}

434 
	$mår_check
(
ba£
, 
size
)

436 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1))) {

437 
	`¥_w¨nög
("mtrr: sizeánd base must be multiples of 4 kiB\n");

438 
	`¥_debug
("mår: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

439 
	`dump_°ack
();

443 
	}
}

480 
	$mår_add
(
ba£
, 
size
, 
ty≥
,

481 
boﬁ
 
ö¸emít
)

483 i‡(
	`mår_check
(
ba£
, 
size
))

484  -
EINVAL
;

485  
	`mår_add_∑ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty≥
,

486 
ö¸emít
);

487 
	}
}

488 
EXPORT_SYMBOL
(
mår_add
);

504 
	$mår_dñ_∑ge
(
ªg
, 
ba£
, 
size
)

506 
i
, 
max
;

507 
mår_ty≥
 
…y≥
;

508 
lba£
, 
lsize
;

509 
îr‹
 = -
EINVAL
;

511 i‡(!
mår_if
)

512  -
ENXIO
;

514 
max
 = 
num_v¨_ønges
;

516 
	`gë_⁄löe_˝us
();

517 
	`muãx_lock
(&
mår_muãx
);

518 i‡(
ªg
 < 0) {

520 
i
 = 0; i < 
max
; ++i) {

521 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

522 i‡(
lba£
 =
ba£
 && 
lsize
 =
size
) {

523 
ªg
 = 
i
;

527 i‡(
ªg
 < 0) {

528 
	`¥_debug
("mtrr:Ço MTRR for %lx000,%lx000 found\n",

529 
ba£
, 
size
);

530 
out
;

533 i‡(
ªg
 >
max
) {

534 
	`¥_w¨nög
("mår:Ñegi°î: %dÅoÿbig\n", 
ªg
);

535 
out
;

537 
mår_if
->
	`gë
(
ªg
, &
lba£
, &
lsize
, &
…y≥
);

538 i‡(
lsize
 < 1) {

539 
	`¥_w¨nög
("mår: MTRR %dÇŸ u£d\n", 
ªg
);

540 
out
;

542 i‡(
mår_ußge_èbÀ
[
ªg
] < 1) {

543 
	`¥_w¨nög
("mår:Ñeg: %d ha†cou¡=0\n", 
ªg
);

544 
out
;

546 i‡(--
mår_ußge_èbÀ
[
ªg
] < 1)

547 
	`£t_mår
(
ªg
, 0, 0, 0);

548 
îr‹
 = 
ªg
;

549 
out
:

550 
	`muãx_u∆ock
(&
mår_muãx
);

551 
	`put_⁄löe_˝us
();

552  
îr‹
;

553 
	}
}

569 
	$mår_dñ
(
ªg
, 
ba£
, 
size
)

571 i‡(
	`mår_check
(
ba£
, 
size
))

572  -
EINVAL
;

573  
	`mår_dñ_∑ge
(
ªg
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

574 
	}
}

575 
EXPORT_SYMBOL
(
mår_dñ
);

582 
__öô
 
	$öô_ifs
()

584 #i‚de‡
CONFIG_X86_64


585 
	`amd_öô_mår
();

586 
	`cyrix_öô_mår
();

587 
	`˚¡aur_öô_mår
();

589 
	}
}

594 
	smår_vÆue
 {

595 
mår_ty≥
 
	m…y≥
;

596 
	mlba£
;

597 
	mlsize
;

600 
mår_vÆue
 
	gmår_vÆue
[
MTRR_MAX_VAR_RANGES
];

602 
	$mår_ßve
(
sys_devi˚
 *
sysdev
, 
pm_mesßge_t
 
°©e
)

604 
i
;

606 
i
 = 0; i < 
num_v¨_ønges
; i++) {

607 
mår_if
->
	`gë
(
i
, &
mår_vÆue
[i].
lba£
,

608 &
mår_vÆue
[
i
].
lsize
,

609 &
mår_vÆue
[
i
].
…y≥
);

612 
	}
}

614 
	$mår_ª°‹e
(
sys_devi˚
 *
sysdev
)

616 
i
;

618 
i
 = 0; i < 
num_v¨_ønges
; i++) {

619 i‡(
mår_vÆue
[
i
].
lsize
) {

620 
	`£t_mår
(
i
, 
mår_vÆue
[i].
lba£
,

621 
mår_vÆue
[
i
].
lsize
,

622 
mår_vÆue
[
i
].
…y≥
);

626 
	}
}

630 
sysdev_drivî
 
	gmår_sysdev_drivî
 = {

631 .
su•íd
 = 
mår_ßve
,

632 .
	gªsume
 = 
mår_ª°‹e
,

635 
__öôd©a
 
	gch™ged_by_mår_˛ónup
;

644 
__öô
 
	$mår_bp_öô
()

646 
u32
 
phys_addr
;

648 
	`öô_ifs
();

650 
phys_addr
 = 32;

652 i‡(
˝u_has_mår
) {

653 
mår_if
 = &
gíîic_mår_›s
;

654 
size_‹_mask
 = 0xff000000;

655 
size_™d_mask
 = 0x00f00000;

656 
phys_addr
 = 36;

663 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000008) {

664 
phys_addr
 = 
	`˝uid_óx
(0x80000008) & 0xff;

666 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

667 
boŸ_˝u_d©a
.
x86
 == 0xF &&

668 
boŸ_˝u_d©a
.
x86_modñ
 == 0x3 &&

669 (
boŸ_˝u_d©a
.
x86_mask
 == 0x3 ||

670 
boŸ_˝u_d©a
.
x86_mask
 == 0x4))

671 
phys_addr
 = 36;

673 
size_‹_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

674 
size_™d_mask
 = ~
size_‹_mask
 & 0xfffff00000ULL;

675 } i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_CENTAUR
 &&

676 
boŸ_˝u_d©a
.
x86
 == 6) {

681 
size_‹_mask
 = 0xfff00000;

682 
size_™d_mask
 = 0;

683 
phys_addr
 = 32;

686 
boŸ_˝u_d©a
.
x86_víd‹
) {

687 
X86_VENDOR_AMD
:

688 i‡(
˝u_has_k6_mår
) {

690 
mår_if
 = 
mår_›s
[
X86_VENDOR_AMD
];

691 
size_‹_mask
 = 0xfff00000;

692 
size_™d_mask
 = 0;

695 
X86_VENDOR_CENTAUR
:

696 i‡(
˝u_has_˚¡aur_m¸
) {

697 
mår_if
 = 
mår_›s
[
X86_VENDOR_CENTAUR
];

698 
size_‹_mask
 = 0xfff00000;

699 
size_™d_mask
 = 0;

702 
X86_VENDOR_CYRIX
:

703 i‡(
˝u_has_cyrix_¨r
) {

704 
mår_if
 = 
mår_›s
[
X86_VENDOR_CYRIX
];

705 
size_‹_mask
 = 0xfff00000;

706 
size_™d_mask
 = 0;

714 i‡(
mår_if
) {

715 
	`£t_num_v¨_ønges
();

716 
	`öô_èbÀ
();

717 i‡(
	`u£_öãl
()) {

718 
	`gë_mår_°©e
();

720 i‡(
	`mår_˛ónup
(
phys_addr
)) {

721 
ch™ged_by_mår_˛ónup
 = 1;

722 
mår_if
->
	`£t_Æl
();

726 
	}
}

728 
	$mår_≠_öô
()

730 i‡(!
	`u£_öãl
(Ë|| 
mår_≠s_dñayed_öô
)

745 
	`£t_mår
(~0U, 0, 0, 0);

746 
	}
}

751 
	$mår_ßve_°©e
()

753 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(0, 
mår_ßve_fixed_ønges
, 
NULL
, 1);

754 
	}
}

756 
	$£t_mår_≠s_dñayed_öô
()

758 i‡(!
	`u£_öãl
())

761 
mår_≠s_dñayed_öô
 = 
åue
;

762 
	}
}

767 
	$mår_≠s_öô
()

769 i‡(!
	`u£_öãl
())

772 
	`£t_mår
(~0U, 0, 0, 0);

773 
mår_≠s_dñayed_öô
 = 
Ál£
;

774 
	}
}

776 
	$mår_bp_ª°‹e
()

778 i‡(!
	`u£_öãl
())

781 
mår_if
->
	`£t_Æl
();

782 
	}
}

784 
__öô
 
	$mår_öô_föülize
()

786 i‡(!
mår_if
)

789 i‡(
	`u£_öãl
()) {

790 i‡(!
ch™ged_by_mår_˛ónup
)

791 
	`mår_°©e_w¨n
();

803 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mår_sysdev_drivî
);

806 
	}
}

807 
subsys_öôˇŒ
(
mår_öô_föülize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c

1 
	~<löux/öô.h
>

2 
	~<löux/io.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/¥o˚ss‹-cyrix.h
>

6 
	~<asm/¥o˚ss‹-Êags.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"mår.h
"

13 
	$£t_mår_¥ï¨e_ßve
(
£t_mår_c⁄ãxt
 *
˘xt
)

15 
¸0
;

18 
	`loˇl_úq_ßve
(
˘xt
->
Êags
);

20 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

23 i‡(
˝u_has_pge
) {

24 
˘xt
->
¸4vÆ
 = 
	`ªad_¸4
();

25 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
 & ~
X86_CR4_PGE
);

32 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

33 
	`wbövd
();

34 
	`wrôe_¸0
(
¸0
);

35 
	`wbövd
();

37 i‡(
	`u£_öãl
()) {

39 
	`rdm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
, ctxt->
de·y≥_hi
);

45 
˘xt
->
c¸3
 = 
	`gëCx86
(
CX86_CCR3
);

48 
	}
}

50 
	$£t_mår_ˇche_dißbÀ
(
£t_mår_c⁄ãxt
 *
˘xt
)

52 i‡(
	`u£_öãl
()) {

54 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
 & 0xf300UL,

55 
˘xt
->
de·y≥_hi
);

57 i‡(
	`is_˝u
(
CYRIX
)) {

59 
	`£tCx86
(
CX86_CCR3
, (
˘xt
->
c¸3
 & 0x0f) | 0x10);

62 
	}
}

65 
	$£t_mår_d⁄e
(
£t_mår_c⁄ãxt
 *
˘xt
)

67 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

70 
	`wbövd
();

73 i‡(
	`u£_öãl
()) {

75 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
,

76 
˘xt
->
de·y≥_hi
);

82 
	`£tCx86
(
CX86_CCR3
, 
˘xt
->
c¸3
);

86 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

89 i‡(
˝u_has_pge
)

90 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
);

93 
	`loˇl_úq_ª°‹e
(
˘xt
->
Êags
);

94 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c

14 
	~<löux/≥rf_evít.h
>

15 
	~<löux/ˇ∑bûôy.h
>

16 
	~<löux/nŸifõr.h
>

17 
	~<löux/h¨dúq.h
>

18 
	~<löux/k¥obes.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kdebug.h
>

21 
	~<löux/sched.h
>

22 
	~<löux/uac˚ss.h
>

23 
	~<löux/highmem.h
>

24 
	~<löux/˝u.h
>

26 
	~<asm/≠ic.h
>

27 
	~<asm/°ackåa˚.h
>

28 
	~<asm/nmi.h
>

30 
u64
 
≥rf_evít_mask
 
	g__ªad_mo°ly
;

33 
	#MAX_PEBS_EVENTS
 4

	)

36 
	#BTS_RECORD_SIZE
 24

	)

39 
	#BTS_BUFFER_SIZE
 (
BTS_RECORD_SIZE
 * 2048)

	)

42 
	#BTS_OVFL_TH
 (
BTS_RECORD_SIZE
 * 128)

	)

48 
	#X86_DEBUGCTL_TR
 (1 << 6)

	)

49 
	#X86_DEBUGCTL_BTS
 (1 << 7)

	)

50 
	#X86_DEBUGCTL_BTINT
 (1 << 8)

	)

51 
	#X86_DEBUGCTL_BTS_OFF_OS
 (1 << 9)

	)

52 
	#X86_DEBUGCTL_BTS_OFF_USR
 (1 << 10)

	)

59 
	sdebug_°‹e
 {

60 
u64
 
	mbts_buf„r_ba£
;

61 
u64
 
	mbts_ödex
;

62 
u64
 
	mbts_absﬁuã_maximum
;

63 
u64
 
	mbts_öãºu±_thªshﬁd
;

64 
u64
 
	m≥bs_buf„r_ba£
;

65 
u64
 
	m≥bs_ödex
;

66 
u64
 
	m≥bs_absﬁuã_maximum
;

67 
u64
 
	m≥bs_öãºu±_thªshﬁd
;

68 
u64
 
	m≥bs_evít_ª£t
[
MAX_PEBS_EVENTS
];

71 
	s˝u_hw_evíts
 {

72 
≥rf_evít
 *
	mevíts
[
X86_PMC_IDX_MAX
];

73 
	mu£d_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

74 
	ma˘ive_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

75 
	möãºu±s
;

76 
	míabÀd
;

77 
debug_°‹e
 *
	mds
;

80 
	sevít_c⁄°øöt
 {

81 
	midxmsk
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

82 
	mcode
;

85 
	#EVENT_CONSTRAINT
(
c
, 
m
Ë{ .
code
 = (c), .
idxmsk
[0] = (mË}

	)

86 
	#EVENT_CONSTRAINT_END
 { .
code
 = 0, .
idxmsk
[0] = 0 }

	)

88 
	#f‹_óch_evít_c⁄°øöt
(
e
, 
c
) \

89 (
e
Ë(
c
); (e)->
idxmsk
[0]; (e)++)

	)

95 
	sx86_pmu
 {

96 c⁄° *
	m«me
;

97 
	mvîsi⁄
;

98 (*
	mh™dÀ_úq
)(
	m±_ªgs
 *);

99 (*
	mdißbÀ_Æl
)();

100 (*
	míabÀ_Æl
)();

101 (*
	míabÀ
)(
	mhw_≥rf_evít
 *, );

102 (*
	mdißbÀ
)(
	mhw_≥rf_evít
 *, );

103 
	mevít£l
;

104 
	m≥rf˘r
;

105 
u64
 (*
evít_m≠
)();

106 
u64
 (*
øw_evít
)(
	mu64
);

107 
	mmax_evíts
;

108 
	mnum_evíts
;

109 
	mnum_evíts_fixed
;

110 
	mevít_bôs
;

111 
u64
 
	mevít_mask
;

112 
	m≠ic
;

113 
u64
 
	mmax_≥riod
;

114 
u64
 
	möãl_˘æ
;

115 (*
	míabÀ_bts
)(
u64
 
	mc⁄fig
);

116 (*
	mdißbÀ_bts
)();

117 (*
	mgë_evít_idx
)(
˝u_hw_evíts
 *
	m˝uc
,

118 
hw_≥rf_evít
 *
	mhwc
);

121 
x86_pmu
 x86_pmu 
	g__ªad_mo°ly
;

123 
DEFINE_PER_CPU
(
˝u_hw_evíts
, cpu_hw_events) = {

124 .
íabÀd
 = 1,

127 c⁄° 
evít_c⁄°øöt
 *
	gevít_c⁄°øöts
;

132 c⁄° 
u64
 
	gp6_≥rfm⁄_evít_m≠
[] =

134 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0079,

135 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

136 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0f2e,

137 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x012e,

138 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

139 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

140 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x0062,

143 
u64
 
	$p6_pmu_evít_m≠
(
hw_evít
)

145  
p6_≥rfm⁄_evít_m≠
[
hw_evít
];

146 
	}
}

154 
	#P6_NOP_EVENT
 0x0000002EULL

	)

156 
u64
 
	$p6_pmu_øw_evít
(
u64
 
hw_evít
)

158 
	#P6_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

159 
	#P6_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

160 
	#P6_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

161 
	#P6_EVNTSEL_INV_MASK
 0x00800000ULL

	)

162 
	#P6_EVNTSEL_REG_MASK
 0xFF000000ULL

	)

164 
	#P6_EVNTSEL_MASK
 \

165 (
P6_EVNTSEL_EVENT_MASK
 | \

166 
P6_EVNTSEL_UNIT_MASK
 | \

167 
P6_EVNTSEL_EDGE_MASK
 | \

168 
P6_EVNTSEL_INV_MASK
 | \

169 
P6_EVNTSEL_REG_MASK
)

	)

171  
hw_evít
 & 
P6_EVNTSEL_MASK
;

172 
	}
}

174 c⁄° 
evít_c⁄°øöt
 
	göãl_p6_evít_c⁄°øöts
[] =

176 
EVENT_CONSTRAINT
(0xc1, 0x1),

177 
EVENT_CONSTRAINT
(0x10, 0x1),

178 
EVENT_CONSTRAINT
(0x11, 0x1),

179 
EVENT_CONSTRAINT
(0x12, 0x2),

180 
EVENT_CONSTRAINT
(0x13, 0x2),

181 
EVENT_CONSTRAINT
(0x14, 0x1),

182 
EVENT_CONSTRAINT_END


188 c⁄° 
u64
 
	göãl_≥rfm⁄_evít_m≠
[] =

190 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x003c,

191 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

192 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x4f2e,

193 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x412e,

194 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

195 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

196 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x013c,

199 c⁄° 
evít_c⁄°øöt
 
	göãl_c‹e_evít_c⁄°øöts
[] =

201 
EVENT_CONSTRAINT
(0x10, 0x1),

202 
EVENT_CONSTRAINT
(0x11, 0x2),

203 
EVENT_CONSTRAINT
(0x12, 0x2),

204 
EVENT_CONSTRAINT
(0x13, 0x2),

205 
EVENT_CONSTRAINT
(0x14, 0x1),

206 
EVENT_CONSTRAINT
(0x18, 0x1),

207 
EVENT_CONSTRAINT
(0x19, 0x2),

208 
EVENT_CONSTRAINT
(0xa1, 0x1),

209 
EVENT_CONSTRAINT
(0xcb, 0x1),

210 
EVENT_CONSTRAINT_END


213 c⁄° 
evít_c⁄°øöt
 
	göãl_√hÆem_evít_c⁄°øöts
[] =

215 
EVENT_CONSTRAINT
(0x40, 0x3),

216 
EVENT_CONSTRAINT
(0x41, 0x3),

217 
EVENT_CONSTRAINT
(0x42, 0x3),

218 
EVENT_CONSTRAINT
(0x43, 0x3),

219 
EVENT_CONSTRAINT
(0x4e, 0x3),

220 
EVENT_CONSTRAINT
(0x4c, 0x3),

221 
EVENT_CONSTRAINT
(0x51, 0x3),

222 
EVENT_CONSTRAINT
(0x52, 0x3),

223 
EVENT_CONSTRAINT
(0x53, 0x3),

224 
EVENT_CONSTRAINT
(0xc5, 0x3),

225 
EVENT_CONSTRAINT_END


228 
u64
 
	$öãl_pmu_evít_m≠
(
hw_evít
)

230  
öãl_≥rfm⁄_evít_m≠
[
hw_evít
];

231 
	}
}

241 
	#C
(
x
Ë
PERF_COUNT_HW_CACHE_
##
	)
x

243 
u64
 
__ªad_mo°ly
 
	ghw_ˇche_evít_ids


244 [
PERF_COUNT_HW_CACHE_MAX
]

245 [
PERF_COUNT_HW_CACHE_OP_MAX
]

246 [
PERF_COUNT_HW_CACHE_RESULT_MAX
];

248 
__öôc⁄°
 
u64
 
	g√hÆem_hw_ˇche_evít_ids


249 [
PERF_COUNT_HW_CACHE_MAX
]

250 [
PERF_COUNT_HW_CACHE_OP_MAX
]

251 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

253 [ 
C
(
L1D
) ] = {

254 [ 
C
(
OP_READ
) ] = {

255 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

256 [ 
C
(
RESULT_MISS
) ] = 0x0140,

258 [ 
C
(
OP_WRITE
) ] = {

259 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

260 [ 
C
(
RESULT_MISS
) ] = 0x0141,

262 [ 
C
(
OP_PREFETCH
) ] = {

263 [ 
C
(
RESULT_ACCESS
) ] = 0x014e,

264 [ 
C
(
RESULT_MISS
) ] = 0x024e,

267 [ 
C
(
L1I
 ) ] = {

268 [ 
C
(
OP_READ
) ] = {

269 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

270 [ 
C
(
RESULT_MISS
) ] = 0x0280,

272 [ 
C
(
OP_WRITE
) ] = {

273 [ 
C
(
RESULT_ACCESS
) ] = -1,

274 [ 
C
(
RESULT_MISS
) ] = -1,

276 [ 
C
(
OP_PREFETCH
) ] = {

277 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

278 [ 
C
(
RESULT_MISS
) ] = 0x0,

281 [ 
C
(
LL
 ) ] = {

282 [ 
C
(
OP_READ
) ] = {

283 [ 
C
(
RESULT_ACCESS
) ] = 0x0324,

284 [ 
C
(
RESULT_MISS
) ] = 0x0224,

286 [ 
C
(
OP_WRITE
) ] = {

287 [ 
C
(
RESULT_ACCESS
) ] = 0x0c24,

288 [ 
C
(
RESULT_MISS
) ] = 0x0824,

290 [ 
C
(
OP_PREFETCH
) ] = {

291 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2e,

292 [ 
C
(
RESULT_MISS
) ] = 0x412e,

295 [ 
C
(
DTLB
) ] = {

296 [ 
C
(
OP_READ
) ] = {

297 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

298 [ 
C
(
RESULT_MISS
) ] = 0x0108,

300 [ 
C
(
OP_WRITE
) ] = {

301 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

302 [ 
C
(
RESULT_MISS
) ] = 0x010c,

304 [ 
C
(
OP_PREFETCH
) ] = {

305 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

306 [ 
C
(
RESULT_MISS
) ] = 0x0,

309 [ 
C
(
ITLB
) ] = {

310 [ 
C
(
OP_READ
) ] = {

311 [ 
C
(
RESULT_ACCESS
) ] = 0x01c0,

312 [ 
C
(
RESULT_MISS
) ] = 0x20c8,

314 [ 
C
(
OP_WRITE
) ] = {

315 [ 
C
(
RESULT_ACCESS
) ] = -1,

316 [ 
C
(
RESULT_MISS
) ] = -1,

318 [ 
C
(
OP_PREFETCH
) ] = {

319 [ 
C
(
RESULT_ACCESS
) ] = -1,

320 [ 
C
(
RESULT_MISS
) ] = -1,

323 [ 
C
(
BPU
 ) ] = {

324 [ 
C
(
OP_READ
) ] = {

325 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

326 [ 
C
(
RESULT_MISS
) ] = 0x03e8,

328 [ 
C
(
OP_WRITE
) ] = {

329 [ 
C
(
RESULT_ACCESS
) ] = -1,

330 [ 
C
(
RESULT_MISS
) ] = -1,

332 [ 
C
(
OP_PREFETCH
) ] = {

333 [ 
C
(
RESULT_ACCESS
) ] = -1,

334 [ 
C
(
RESULT_MISS
) ] = -1,

339 
__öôc⁄°
 
u64
 
	gc‹e2_hw_ˇche_evít_ids


340 [
PERF_COUNT_HW_CACHE_MAX
]

341 [
PERF_COUNT_HW_CACHE_OP_MAX
]

342 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

344 [ 
C
(
L1D
) ] = {

345 [ 
C
(
OP_READ
) ] = {

346 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

347 [ 
C
(
RESULT_MISS
) ] = 0x0140,

349 [ 
C
(
OP_WRITE
) ] = {

350 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

351 [ 
C
(
RESULT_MISS
) ] = 0x0141,

353 [ 
C
(
OP_PREFETCH
) ] = {

354 [ 
C
(
RESULT_ACCESS
) ] = 0x104e,

355 [ 
C
(
RESULT_MISS
) ] = 0,

358 [ 
C
(
L1I
 ) ] = {

359 [ 
C
(
OP_READ
) ] = {

360 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

361 [ 
C
(
RESULT_MISS
) ] = 0x0081,

363 [ 
C
(
OP_WRITE
) ] = {

364 [ 
C
(
RESULT_ACCESS
) ] = -1,

365 [ 
C
(
RESULT_MISS
) ] = -1,

367 [ 
C
(
OP_PREFETCH
) ] = {

368 [ 
C
(
RESULT_ACCESS
) ] = 0,

369 [ 
C
(
RESULT_MISS
) ] = 0,

372 [ 
C
(
LL
 ) ] = {

373 [ 
C
(
OP_READ
) ] = {

374 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

375 [ 
C
(
RESULT_MISS
) ] = 0x4129,

377 [ 
C
(
OP_WRITE
) ] = {

378 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

379 [ 
C
(
RESULT_MISS
) ] = 0x412A,

381 [ 
C
(
OP_PREFETCH
) ] = {

382 [ 
C
(
RESULT_ACCESS
) ] = 0,

383 [ 
C
(
RESULT_MISS
) ] = 0,

386 [ 
C
(
DTLB
) ] = {

387 [ 
C
(
OP_READ
) ] = {

388 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

389 [ 
C
(
RESULT_MISS
) ] = 0x0208,

391 [ 
C
(
OP_WRITE
) ] = {

392 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

393 [ 
C
(
RESULT_MISS
) ] = 0x0808,

395 [ 
C
(
OP_PREFETCH
) ] = {

396 [ 
C
(
RESULT_ACCESS
) ] = 0,

397 [ 
C
(
RESULT_MISS
) ] = 0,

400 [ 
C
(
ITLB
) ] = {

401 [ 
C
(
OP_READ
) ] = {

402 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

403 [ 
C
(
RESULT_MISS
) ] = 0x1282,

405 [ 
C
(
OP_WRITE
) ] = {

406 [ 
C
(
RESULT_ACCESS
) ] = -1,

407 [ 
C
(
RESULT_MISS
) ] = -1,

409 [ 
C
(
OP_PREFETCH
) ] = {

410 [ 
C
(
RESULT_ACCESS
) ] = -1,

411 [ 
C
(
RESULT_MISS
) ] = -1,

414 [ 
C
(
BPU
 ) ] = {

415 [ 
C
(
OP_READ
) ] = {

416 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

417 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

419 [ 
C
(
OP_WRITE
) ] = {

420 [ 
C
(
RESULT_ACCESS
) ] = -1,

421 [ 
C
(
RESULT_MISS
) ] = -1,

423 [ 
C
(
OP_PREFETCH
) ] = {

424 [ 
C
(
RESULT_ACCESS
) ] = -1,

425 [ 
C
(
RESULT_MISS
) ] = -1,

430 
__öôc⁄°
 
u64
 
	g©om_hw_ˇche_evít_ids


431 [
PERF_COUNT_HW_CACHE_MAX
]

432 [
PERF_COUNT_HW_CACHE_OP_MAX
]

433 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

435 [ 
C
(
L1D
) ] = {

436 [ 
C
(
OP_READ
) ] = {

437 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

438 [ 
C
(
RESULT_MISS
) ] = 0,

440 [ 
C
(
OP_WRITE
) ] = {

441 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

442 [ 
C
(
RESULT_MISS
) ] = 0,

444 [ 
C
(
OP_PREFETCH
) ] = {

445 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

446 [ 
C
(
RESULT_MISS
) ] = 0,

449 [ 
C
(
L1I
 ) ] = {

450 [ 
C
(
OP_READ
) ] = {

451 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

452 [ 
C
(
RESULT_MISS
) ] = 0x0280,

454 [ 
C
(
OP_WRITE
) ] = {

455 [ 
C
(
RESULT_ACCESS
) ] = -1,

456 [ 
C
(
RESULT_MISS
) ] = -1,

458 [ 
C
(
OP_PREFETCH
) ] = {

459 [ 
C
(
RESULT_ACCESS
) ] = 0,

460 [ 
C
(
RESULT_MISS
) ] = 0,

463 [ 
C
(
LL
 ) ] = {

464 [ 
C
(
OP_READ
) ] = {

465 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

466 [ 
C
(
RESULT_MISS
) ] = 0x4129,

468 [ 
C
(
OP_WRITE
) ] = {

469 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

470 [ 
C
(
RESULT_MISS
) ] = 0x412A,

472 [ 
C
(
OP_PREFETCH
) ] = {

473 [ 
C
(
RESULT_ACCESS
) ] = 0,

474 [ 
C
(
RESULT_MISS
) ] = 0,

477 [ 
C
(
DTLB
) ] = {

478 [ 
C
(
OP_READ
) ] = {

479 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

480 [ 
C
(
RESULT_MISS
) ] = 0x0508,

482 [ 
C
(
OP_WRITE
) ] = {

483 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

484 [ 
C
(
RESULT_MISS
) ] = 0x0608,

486 [ 
C
(
OP_PREFETCH
) ] = {

487 [ 
C
(
RESULT_ACCESS
) ] = 0,

488 [ 
C
(
RESULT_MISS
) ] = 0,

491 [ 
C
(
ITLB
) ] = {

492 [ 
C
(
OP_READ
) ] = {

493 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

494 [ 
C
(
RESULT_MISS
) ] = 0x0282,

496 [ 
C
(
OP_WRITE
) ] = {

497 [ 
C
(
RESULT_ACCESS
) ] = -1,

498 [ 
C
(
RESULT_MISS
) ] = -1,

500 [ 
C
(
OP_PREFETCH
) ] = {

501 [ 
C
(
RESULT_ACCESS
) ] = -1,

502 [ 
C
(
RESULT_MISS
) ] = -1,

505 [ 
C
(
BPU
 ) ] = {

506 [ 
C
(
OP_READ
) ] = {

507 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

508 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

510 [ 
C
(
OP_WRITE
) ] = {

511 [ 
C
(
RESULT_ACCESS
) ] = -1,

512 [ 
C
(
RESULT_MISS
) ] = -1,

514 [ 
C
(
OP_PREFETCH
) ] = {

515 [ 
C
(
RESULT_ACCESS
) ] = -1,

516 [ 
C
(
RESULT_MISS
) ] = -1,

521 
u64
 
	$öãl_pmu_øw_evít
(
u64
 
hw_evít
)

523 
	#CORE_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

524 
	#CORE_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

525 
	#CORE_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

526 
	#CORE_EVNTSEL_INV_MASK
 0x00800000ULL

	)

527 
	#CORE_EVNTSEL_REG_MASK
 0xFF000000ULL

	)

529 
	#CORE_EVNTSEL_MASK
 \

530 (
CORE_EVNTSEL_EVENT_MASK
 | \

531 
CORE_EVNTSEL_UNIT_MASK
 | \

532 
CORE_EVNTSEL_EDGE_MASK
 | \

533 
CORE_EVNTSEL_INV_MASK
 | \

534 
CORE_EVNTSEL_REG_MASK
)

	)

536  
hw_evít
 & 
CORE_EVNTSEL_MASK
;

537 
	}
}

539 
__öôc⁄°
 
u64
 
	gamd_hw_ˇche_evít_ids


540 [
PERF_COUNT_HW_CACHE_MAX
]

541 [
PERF_COUNT_HW_CACHE_OP_MAX
]

542 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

544 [ 
C
(
L1D
) ] = {

545 [ 
C
(
OP_READ
) ] = {

546 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

547 [ 
C
(
RESULT_MISS
) ] = 0x0041,

549 [ 
C
(
OP_WRITE
) ] = {

550 [ 
C
(
RESULT_ACCESS
) ] = 0x0142,

551 [ 
C
(
RESULT_MISS
) ] = 0,

553 [ 
C
(
OP_PREFETCH
) ] = {

554 [ 
C
(
RESULT_ACCESS
) ] = 0x0267,

555 [ 
C
(
RESULT_MISS
) ] = 0x0167,

558 [ 
C
(
L1I
 ) ] = {

559 [ 
C
(
OP_READ
) ] = {

560 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

561 [ 
C
(
RESULT_MISS
) ] = 0x0081,

563 [ 
C
(
OP_WRITE
) ] = {

564 [ 
C
(
RESULT_ACCESS
) ] = -1,

565 [ 
C
(
RESULT_MISS
) ] = -1,

567 [ 
C
(
OP_PREFETCH
) ] = {

568 [ 
C
(
RESULT_ACCESS
) ] = 0x014B,

569 [ 
C
(
RESULT_MISS
) ] = 0,

572 [ 
C
(
LL
 ) ] = {

573 [ 
C
(
OP_READ
) ] = {

574 [ 
C
(
RESULT_ACCESS
) ] = 0x037D,

575 [ 
C
(
RESULT_MISS
) ] = 0x037E,

577 [ 
C
(
OP_WRITE
) ] = {

578 [ 
C
(
RESULT_ACCESS
) ] = 0x017F,

579 [ 
C
(
RESULT_MISS
) ] = 0,

581 [ 
C
(
OP_PREFETCH
) ] = {

582 [ 
C
(
RESULT_ACCESS
) ] = 0,

583 [ 
C
(
RESULT_MISS
) ] = 0,

586 [ 
C
(
DTLB
) ] = {

587 [ 
C
(
OP_READ
) ] = {

588 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

589 [ 
C
(
RESULT_MISS
) ] = 0x0046,

591 [ 
C
(
OP_WRITE
) ] = {

592 [ 
C
(
RESULT_ACCESS
) ] = 0,

593 [ 
C
(
RESULT_MISS
) ] = 0,

595 [ 
C
(
OP_PREFETCH
) ] = {

596 [ 
C
(
RESULT_ACCESS
) ] = 0,

597 [ 
C
(
RESULT_MISS
) ] = 0,

600 [ 
C
(
ITLB
) ] = {

601 [ 
C
(
OP_READ
) ] = {

602 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

603 [ 
C
(
RESULT_MISS
) ] = 0x0085,

605 [ 
C
(
OP_WRITE
) ] = {

606 [ 
C
(
RESULT_ACCESS
) ] = -1,

607 [ 
C
(
RESULT_MISS
) ] = -1,

609 [ 
C
(
OP_PREFETCH
) ] = {

610 [ 
C
(
RESULT_ACCESS
) ] = -1,

611 [ 
C
(
RESULT_MISS
) ] = -1,

614 [ 
C
(
BPU
 ) ] = {

615 [ 
C
(
OP_READ
) ] = {

616 [ 
C
(
RESULT_ACCESS
) ] = 0x00c2,

617 [ 
C
(
RESULT_MISS
) ] = 0x00c3,

619 [ 
C
(
OP_WRITE
) ] = {

620 [ 
C
(
RESULT_ACCESS
) ] = -1,

621 [ 
C
(
RESULT_MISS
) ] = -1,

623 [ 
C
(
OP_PREFETCH
) ] = {

624 [ 
C
(
RESULT_ACCESS
) ] = -1,

625 [ 
C
(
RESULT_MISS
) ] = -1,

633 c⁄° 
u64
 
	gamd_≥rfm⁄_evít_m≠
[] =

635 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0076,

636 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

637 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0080,

638 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x0081,

639 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

640 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

643 
u64
 
	$amd_pmu_evít_m≠
(
hw_evít
)

645  
amd_≥rfm⁄_evít_m≠
[
hw_evít
];

646 
	}
}

648 
u64
 
	$amd_pmu_øw_evít
(
u64
 
hw_evít
)

650 
	#K7_EVNTSEL_EVENT_MASK
 0x7000000FFULL

	)

651 
	#K7_EVNTSEL_UNIT_MASK
 0x00000FF00ULL

	)

652 
	#K7_EVNTSEL_EDGE_MASK
 0x000040000ULL

	)

653 
	#K7_EVNTSEL_INV_MASK
 0x000800000ULL

	)

654 
	#K7_EVNTSEL_REG_MASK
 0x0FF000000ULL

	)

656 
	#K7_EVNTSEL_MASK
 \

657 (
K7_EVNTSEL_EVENT_MASK
 | \

658 
K7_EVNTSEL_UNIT_MASK
 | \

659 
K7_EVNTSEL_EDGE_MASK
 | \

660 
K7_EVNTSEL_INV_MASK
 | \

661 
K7_EVNTSEL_REG_MASK
)

	)

663  
hw_evít
 & 
K7_EVNTSEL_MASK
;

664 
	}
}

671 
u64


672 
	$x86_≥rf_evít_upd©e
(
≥rf_evít
 *
evít
,

673 
hw_≥rf_evít
 *
hwc
, 
idx
)

675 
shi·
 = 64 - 
x86_pmu
.
evít_bôs
;

676 
u64
 
¥ev_øw_cou¡
, 
√w_øw_cou¡
;

677 
s64
 
dñè
;

679 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

689 
agaö
:

690 
¥ev_øw_cou¡
 = 
	`©omic64_ªad
(&
hwc
->
¥ev_cou¡
);

691 
	`rdm§l
(
hwc
->
evít_ba£
 + 
idx
, 
√w_øw_cou¡
);

693 i‡(
	`©omic64_cmpxchg
(&
hwc
->
¥ev_cou¡
, 
¥ev_øw_cou¡
,

694 
√w_øw_cou¡
Ë!
¥ev_øw_cou¡
)

695 
agaö
;

705 
dñè
 = (
√w_øw_cou¡
 << 
shi·
Ë- (
¥ev_øw_cou¡
 << shift);

706 
dñè
 >>
shi·
;

708 
	`©omic64_add
(
dñè
, &
evít
->
cou¡
);

709 
	`©omic64_sub
(
dñè
, &
hwc
->
≥riod_À·
);

711  
√w_øw_cou¡
;

712 
	}
}

714 
©omic_t
 
	ga˘ive_evíts
;

715 
DEFINE_MUTEX
(
pmc_ª£rve_muãx
);

717 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
()

719 #ifde‡
CONFIG_X86_LOCAL_APIC


720 
i
;

722 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

723 
	`dißbÀ_œpic_nmi_w©chdog
();

725 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

726 i‡(!
	`ª£rve_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
))

727 
≥rf˘r_Áû
;

730 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

731 i‡(!
	`ª£rve_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
))

732 
evít£l_Áû
;

736  
åue
;

738 #ifde‡
CONFIG_X86_LOCAL_APIC


739 
evít£l_Áû
:

740 
i
--; i >= 0; i--)

741 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

743 
i
 = 
x86_pmu
.
num_evíts
;

745 
≥rf˘r_Áû
:

746 
i
--; i >= 0; i--)

747 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

749 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

750 
	`íabÀ_œpic_nmi_w©chdog
();

752  
Ál£
;

754 
	}
}

756 
	$ªÀa£_pmc_h¨dw¨e
()

758 #ifde‡
CONFIG_X86_LOCAL_APIC


759 
i
;

761 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

762 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

763 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

766 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

767 
	`íabÀ_œpic_nmi_w©chdog
();

769 
	}
}

771 
ölöe
 
boﬁ
 
	$bts_avaûabÀ
()

773  
x86_pmu
.
íabÀ_bts
 !
NULL
;

774 
	}
}

776 
ölöe
 
	$öô_debug_°‹e_⁄_˝u
(
˝u
)

778 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

780 i‡(!
ds
)

783 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
,

784 (
u32
)((
u64
)()
ds
),

785 (
u32
)((
u64
)()
ds
 >> 32));

786 
	}
}

788 
ölöe
 
	$föi_debug_°‹e_⁄_˝u
(
˝u
)

790 i‡(!
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
)

793 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
, 0, 0);

794 
	}
}

796 
	$ªÀa£_bts_h¨dw¨e
()

798 
˝u
;

800 i‡(!
	`bts_avaûabÀ
())

803 
	`gë_⁄löe_˝us
();

805 
	`f‹_óch_⁄löe_˝u
(
˝u
)

806 
	`föi_debug_°‹e_⁄_˝u
(
˝u
);

808 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

809 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

811 i‡(!
ds
)

814 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = 
NULL
;

816 
	`k‰ì
((*)()
ds
->
bts_buf„r_ba£
);

817 
	`k‰ì
(
ds
);

820 
	`put_⁄löe_˝us
();

821 
	}
}

823 
	$ª£rve_bts_h¨dw¨e
()

825 
˝u
, 
îr
 = 0;

827 i‡(!
	`bts_avaûabÀ
())

830 
	`gë_⁄löe_˝us
();

832 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

833 
debug_°‹e
 *
ds
;

834 *
buf„r
;

836 
îr
 = -
ENOMEM
;

837 
buf„r
 = 
	`kzÆloc
(
BTS_BUFFER_SIZE
, 
GFP_KERNEL
);

838 i‡(
	`u∆ikñy
(!
buf„r
))

841 
ds
 = 
	`kzÆloc
((*ds), 
GFP_KERNEL
);

842 i‡(
	`u∆ikñy
(!
ds
)) {

843 
	`k‰ì
(
buf„r
);

847 
ds
->
bts_buf„r_ba£
 = (
u64
)()
buf„r
;

848 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

849 
ds
->
bts_absﬁuã_maximum
 =

850 
ds
->
bts_buf„r_ba£
 + 
BTS_BUFFER_SIZE
;

851 
ds
->
bts_öãºu±_thªshﬁd
 =

852 
ds
->
bts_absﬁuã_maximum
 - 
BTS_OVFL_TH
;

854 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = ds;

855 
îr
 = 0;

858 i‡(
îr
)

859 
	`ªÀa£_bts_h¨dw¨e
();

861 
	`f‹_óch_⁄löe_˝u
(
˝u
)

862 
	`öô_debug_°‹e_⁄_˝u
(
˝u
);

865 
	`put_⁄löe_˝us
();

867  
îr
;

868 
	}
}

870 
	$hw_≥rf_evít_de°roy
(
≥rf_evít
 *
evít
)

872 i‡(
	`©omic_dec_™d_muãx_lock
(&
a˘ive_evíts
, &
pmc_ª£rve_muãx
)) {

873 
	`ªÀa£_pmc_h¨dw¨e
();

874 
	`ªÀa£_bts_h¨dw¨e
();

875 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

877 
	}
}

879 
ölöe
 
	$x86_pmu_öôülized
()

881  
x86_pmu
.
h™dÀ_úq
 !
NULL
;

882 
	}
}

884 
ölöe
 

885 
	$£t_ext_hw_©å
(
hw_≥rf_evít
 *
hwc
, 
≥rf_evít_©å
 *
©å
)

887 
ˇche_ty≥
, 
ˇche_›
, 
ˇche_ªsu…
;

888 
u64
 
c⁄fig
, 
vÆ
;

890 
c⁄fig
 = 
©å
->config;

892 
ˇche_ty≥
 = (
c⁄fig
 >> 0) & 0xff;

893 i‡(
ˇche_ty≥
 >
PERF_COUNT_HW_CACHE_MAX
)

894  -
EINVAL
;

896 
ˇche_›
 = (
c⁄fig
 >> 8) & 0xff;

897 i‡(
ˇche_›
 >
PERF_COUNT_HW_CACHE_OP_MAX
)

898  -
EINVAL
;

900 
ˇche_ªsu…
 = (
c⁄fig
 >> 16) & 0xff;

901 i‡(
ˇche_ªsu…
 >
PERF_COUNT_HW_CACHE_RESULT_MAX
)

902  -
EINVAL
;

904 
vÆ
 = 
hw_ˇche_evít_ids
[
ˇche_ty≥
][
ˇche_›
][
ˇche_ªsu…
];

906 i‡(
vÆ
 == 0)

907  -
ENOENT
;

909 i‡(
vÆ
 == -1)

910  -
EINVAL
;

912 
hwc
->
c⁄fig
 |
vÆ
;

915 
	}
}

917 
	$öãl_pmu_íabÀ_bts
(
u64
 
c⁄fig
)

919 
debug˘lm§
;

921 
debug˘lm§
 = 
	`gë_debug˘lm§
();

923 
debug˘lm§
 |
X86_DEBUGCTL_TR
;

924 
debug˘lm§
 |
X86_DEBUGCTL_BTS
;

925 
debug˘lm§
 |
X86_DEBUGCTL_BTINT
;

927 i‡(!(
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
))

928 
debug˘lm§
 |
X86_DEBUGCTL_BTS_OFF_OS
;

930 i‡(!(
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_USR
))

931 
debug˘lm§
 |
X86_DEBUGCTL_BTS_OFF_USR
;

933 
	`upd©e_debug˘lm§
(
debug˘lm§
);

934 
	}
}

936 
	$öãl_pmu_dißbÀ_bts
()

938 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

939 
debug˘lm§
;

941 i‡(!
˝uc
->
ds
)

944 
debug˘lm§
 = 
	`gë_debug˘lm§
();

946 
debug˘lm§
 &=

947 ~(
X86_DEBUGCTL_TR
 | 
X86_DEBUGCTL_BTS
 | 
X86_DEBUGCTL_BTINT
 |

948 
X86_DEBUGCTL_BTS_OFF_OS
 | 
X86_DEBUGCTL_BTS_OFF_USR
);

950 
	`upd©e_debug˘lm§
(
debug˘lm§
);

951 
	}
}

956 
	$__hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

958 
≥rf_evít_©å
 *
©å
 = &
evít
->attr;

959 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

960 
u64
 
c⁄fig
;

961 
îr
;

963 i‡(!
	`x86_pmu_öôülized
())

964  -
ENODEV
;

966 
îr
 = 0;

967 i‡(!
	`©omic_öc_nŸ_zîo
(&
a˘ive_evíts
)) {

968 
	`muãx_lock
(&
pmc_ª£rve_muãx
);

969 i‡(
	`©omic_ªad
(&
a˘ive_evíts
) == 0) {

970 i‡(!
	`ª£rve_pmc_h¨dw¨e
())

971 
îr
 = -
EBUSY
;

973 
îr
 = 
	`ª£rve_bts_h¨dw¨e
();

975 i‡(!
îr
)

976 
	`©omic_öc
(&
a˘ive_evíts
);

977 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

979 i‡(
îr
)

980  
îr
;

982 
evít
->
de°roy
 = 
hw_≥rf_evít_de°roy
;

988 
hwc
->
c⁄fig
 = 
ARCH_PERFMON_EVENTSEL_INT
;

990 
hwc
->
idx
 = -1;

995 i‡(!
©å
->
ex˛ude_u£r
)

996 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_USR
;

997 i‡(!
©å
->
ex˛ude_kî√l
)

998 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_OS
;

1000 i‡(!
hwc
->
ßm∂e_≥riod
) {

1001 
hwc
->
ßm∂e_≥riod
 = 
x86_pmu
.
max_≥riod
;

1002 
hwc
->
œ°_≥riod
 = hwc->
ßm∂e_≥riod
;

1003 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, hwc->
ßm∂e_≥riod
);

1011 i‡(!
x86_pmu
.
≠ic
)

1012  -
EOPNOTSUPP
;

1018 i‡(
©å
->
ty≥
 =
PERF_TYPE_RAW
) {

1019 
hwc
->
c⁄fig
 |
x86_pmu
.
	`øw_evít
(
©å
->config);

1023 i‡(
©å
->
ty≥
 =
PERF_TYPE_HW_CACHE
)

1024  
	`£t_ext_hw_©å
(
hwc
, 
©å
);

1026 i‡(
©å
->
c⁄fig
 >
x86_pmu
.
max_evíts
)

1027  -
EINVAL
;

1032 
c⁄fig
 = 
x86_pmu
.
	`evít_m≠
(
©å
->config);

1034 i‡(
c⁄fig
 == 0)

1035  -
ENOENT
;

1037 i‡(
c⁄fig
 == -1LL)

1038  -
EINVAL
;

1043 i‡((
©å
->
c⁄fig
 =
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
) &&

1044 (
hwc
->
ßm∂e_≥riod
 == 1)) {

1046 i‡(!
	`bts_avaûabÀ
())

1047  -
EOPNOTSUPP
;

1050 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

1051  -
EOPNOTSUPP
;

1054 
hwc
->
c⁄fig
 |= config;

1057 
	}
}

1059 
	$p6_pmu_dißbÀ_Æl
()

1061 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1062 
u64
 
vÆ
;

1064 i‡(!
˝uc
->
íabÀd
)

1067 
˝uc
->
íabÀd
 = 0;

1068 
	`b¨rõr
();

1071 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1072 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1073 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1074 
	}
}

1076 
	$öãl_pmu_dißbÀ_Æl
()

1078 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1080 i‡(!
˝uc
->
íabÀd
)

1083 
˝uc
->
íabÀd
 = 0;

1084 
	`b¨rõr
();

1086 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 0);

1088 i‡(
	`ã°_bô
(
X86_PMC_IDX_FIXED_BTS
, 
˝uc
->
a˘ive_mask
))

1089 
	`öãl_pmu_dißbÀ_bts
();

1090 
	}
}

1092 
	$amd_pmu_dißbÀ_Æl
()

1094 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1095 
idx
;

1097 i‡(!
˝uc
->
íabÀd
)

1100 
˝uc
->
íabÀd
 = 0;

1106 
	`b¨rõr
();

1108 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1109 
u64
 
vÆ
;

1111 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1113 
	`rdm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1114 i‡(!(
vÆ
 & 
ARCH_PERFMON_EVENTSEL0_ENABLE
))

1116 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1117 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1119 
	}
}

1121 
	$hw_≥rf_dißbÀ
()

1123 i‡(!
	`x86_pmu_öôülized
())

1125  
x86_pmu
.
	`dißbÀ_Æl
();

1126 
	}
}

1128 
	$p6_pmu_íabÀ_Æl
()

1130 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1131 
vÆ
;

1133 i‡(
˝uc
->
íabÀd
)

1136 
˝uc
->
íabÀd
 = 1;

1137 
	`b¨rõr
();

1140 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1141 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1142 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1143 
	}
}

1145 
	$öãl_pmu_íabÀ_Æl
()

1147 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1149 i‡(
˝uc
->
íabÀd
)

1152 
˝uc
->
íabÀd
 = 1;

1153 
	`b¨rõr
();

1155 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
x86_pmu
.
öãl_˘æ
);

1157 i‡(
	`ã°_bô
(
X86_PMC_IDX_FIXED_BTS
, 
˝uc
->
a˘ive_mask
)) {

1158 
≥rf_evít
 *
evít
 =

1159 
˝uc
->
evíts
[
X86_PMC_IDX_FIXED_BTS
];

1161 i‡(
	`WARN_ON_ONCE
(!
evít
))

1164 
	`öãl_pmu_íabÀ_bts
(
evít
->
hw
.
c⁄fig
);

1166 
	}
}

1168 
	$amd_pmu_íabÀ_Æl
()

1170 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1171 
idx
;

1173 i‡(
˝uc
->
íabÀd
)

1176 
˝uc
->
íabÀd
 = 1;

1177 
	`b¨rõr
();

1179 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1180 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
idx
];

1181 
u64
 
vÆ
;

1183 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1186 
vÆ
 = 
evít
->
hw
.
c⁄fig
;

1187 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1188 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1190 
	}
}

1192 
	$hw_≥rf_íabÀ
()

1194 i‡(!
	`x86_pmu_öôülized
())

1196 
x86_pmu
.
	`íabÀ_Æl
();

1197 
	}
}

1199 
ölöe
 
u64
 
	$öãl_pmu_gë_°©us
()

1201 
u64
 
°©us
;

1203 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1205  
°©us
;

1206 
	}
}

1208 
ölöe
 
	$öãl_pmu_ack_°©us
(
u64
 
ack
)

1210 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ack
);

1211 
	}
}

1213 
ölöe
 
	$x86_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1215 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
,

1216 
hwc
->
c⁄fig
 | 
ARCH_PERFMON_EVENTSEL0_ENABLE
);

1217 
	}
}

1219 
ölöe
 
	$x86_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1221 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, hwc->
c⁄fig
);

1222 
	}
}

1224 
ölöe
 

1225 
	$öãl_pmu_dißbÀ_fixed
(
hw_≥rf_evít
 *
hwc
, 
__idx
)

1227 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

1228 
u64
 
˘æ_vÆ
, 
mask
;

1230 
mask
 = 0xfULL << (
idx
 * 4);

1232 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1233 
˘æ_vÆ
 &~
mask
;

1234 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1235 
	}
}

1237 
ölöe
 

1238 
	$p6_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1240 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1241 
u64
 
vÆ
 = 
P6_NOP_EVENT
;

1243 i‡(
˝uc
->
íabÀd
)

1244 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1246 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

1247 
	}
}

1249 
ölöe
 

1250 
	$öãl_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1252 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
)) {

1253 
	`öãl_pmu_dißbÀ_bts
();

1257 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

1258 
	`öãl_pmu_dißbÀ_fixed
(
hwc
, 
idx
);

1262 
	`x86_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1263 
	}
}

1265 
ölöe
 

1266 
	$amd_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1268 
	`x86_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1269 
	}
}

1271 
DEFINE_PER_CPU
(
u64
 [
X86_PMC_IDX_MAX
], 
pmc_¥ev_À·
);

1278 
	$x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
,

1279 
hw_≥rf_evít
 *
hwc
, 
idx
)

1281 
s64
 
À·
 = 
	`©omic64_ªad
(&
hwc
->
≥riod_À·
);

1282 
s64
 
≥riod
 = 
hwc
->
ßm∂e_≥riod
;

1283 
îr
, 
ªt
 = 0;

1285 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

1291 i‡(
	`u∆ikñy
(
À·
 <-
≥riod
)) {

1292 
À·
 = 
≥riod
;

1293 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

1294 
hwc
->
œ°_≥riod
 = 
≥riod
;

1295 
ªt
 = 1;

1298 i‡(
	`u∆ikñy
(
À·
 <= 0)) {

1299 
À·
 +
≥riod
;

1300 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

1301 
hwc
->
œ°_≥riod
 = 
≥riod
;

1302 
ªt
 = 1;

1307 i‡(
	`u∆ikñy
(
À·
 < 2))

1308 
À·
 = 2;

1310 i‡(
À·
 > 
x86_pmu
.
max_≥riod
)

1311 
À·
 = 
x86_pmu
.
max_≥riod
;

1313 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
	`smp_¥o˚ss‹_id
()Ë
À·
;

1319 
	`©omic64_£t
(&
hwc
->
¥ev_cou¡
, (
u64
)-
À·
);

1321 
îr
 = 
	`checkög_wrm§l
(
hwc
->
evít_ba£
 + 
idx
,

1322 (
u64
)(-
À·
Ë& 
x86_pmu
.
evít_mask
);

1324 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1326  
ªt
;

1327 
	}
}

1329 
ölöe
 

1330 
	$öãl_pmu_íabÀ_fixed
(
hw_≥rf_evít
 *
hwc
, 
__idx
)

1332 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

1333 
u64
 
˘æ_vÆ
, 
bôs
, 
mask
;

1334 
îr
;

1341 
bôs
 = 0x8ULL;

1342 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_USR
)

1343 
bôs
 |= 0x2;

1344 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

1345 
bôs
 |= 0x1;

1350 i‡(
x86_pmu
.
vîsi⁄
 > 2 && 
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_ANY
)

1351 
bôs
 |= 0x4;

1353 
bôs
 <<(
idx
 * 4);

1354 
mask
 = 0xfULL << (
idx
 * 4);

1356 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1357 
˘æ_vÆ
 &~
mask
;

1358 
˘æ_vÆ
 |
bôs
;

1359 
îr
 = 
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1360 
	}
}

1362 
	$p6_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1364 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1365 
u64
 
vÆ
;

1367 
vÆ
 = 
hwc
->
c⁄fig
;

1368 i‡(
˝uc
->
íabÀd
)

1369 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1371 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

1372 
	}
}

1375 
	$öãl_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1377 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
)) {

1378 i‡(!
	`__gë_˝u_v¨
(
˝u_hw_evíts
).
íabÀd
)

1381 
	`öãl_pmu_íabÀ_bts
(
hwc
->
c⁄fig
);

1385 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

1386 
	`öãl_pmu_íabÀ_fixed
(
hwc
, 
idx
);

1390 
	`x86_pmu_íabÀ_evít
(
hwc
, 
idx
);

1391 
	}
}

1393 
	$amd_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1395 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1397 i‡(
˝uc
->
íabÀd
)

1398 
	`x86_pmu_íabÀ_evít
(
hwc
, 
idx
);

1399 
	}
}

1401 
	$fixed_mode_idx
(
hw_≥rf_evít
 *
hwc
)

1403 
hw_evít
;

1405 
hw_evít
 = 
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENT_MASK
;

1407 i‡(
	`u∆ikñy
((
hw_evít
 ==

1408 
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
)) &&

1409 (
hwc
->
ßm∂e_≥riod
 == 1)))

1410  
X86_PMC_IDX_FIXED_BTS
;

1412 i‡(!
x86_pmu
.
num_evíts_fixed
)

1418 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENT_FILTER_MASK
)

1421 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_INSTRUCTIONS
)))

1422  
X86_PMC_IDX_FIXED_INSTRUCTIONS
;

1423 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_CPU_CYCLES
)))

1424  
X86_PMC_IDX_FIXED_CPU_CYCLES
;

1425 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_BUS_CYCLES
)))

1426  
X86_PMC_IDX_FIXED_BUS_CYCLES
;

1429 
	}
}

1435 
	$gí_gë_evít_idx
(
˝u_hw_evíts
 *
˝uc
, 
hw_≥rf_evít
 *
hwc
)

1437 
idx
;

1439 
idx
 = 
	`föd_fú°_zîo_bô
(
˝uc
->
u£d_mask
, 
x86_pmu
.
num_evíts
);

1440  
idx
 =
x86_pmu
.
num_evíts
 ? -1 : idx;

1441 
	}
}

1447 
	$öãl_gë_evít_idx
(
˝u_hw_evíts
 *
˝uc
, 
hw_≥rf_evít
 *
hwc
)

1449 c⁄° 
evít_c⁄°øöt
 *event_constraint;

1450 
i
, 
code
;

1452 i‡(!
evít_c⁄°øöts
)

1453 
skù
;

1455 
code
 = 
hwc
->
c⁄fig
 & 
CORE_EVNTSEL_EVENT_MASK
;

1457 
	`f‹_óch_evít_c⁄°øöt
(
evít_c⁄°øöt
, 
evít_c⁄°øöts
) {

1458 i‡(
code
 =
evít_c⁄°øöt
->code) {

1459 
	`f‹_óch_bô
(
i
, 
evít_c⁄°øöt
->
idxmsk
, 
X86_PMC_IDX_MAX
) {

1460 i‡(!
	`ã°_™d_£t_bô
(
i
, 
˝uc
->
u£d_mask
))

1461  
i
;

1466 
skù
:

1467  
	`gí_gë_evít_idx
(
˝uc
, 
hwc
);

1468 
	}
}

1471 
	$x86_scheduÀ_evít
(
˝u_hw_evíts
 *
˝uc
, 
hw_≥rf_evít
 *
hwc
)

1473 
idx
;

1475 
idx
 = 
	`fixed_mode_idx
(
hwc
);

1476 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
) {

1478 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
))

1479  -
EAGAIN
;

1481 
hwc
->
c⁄fig_ba£
 = 0;

1482 
hwc
->
evít_ba£
 = 0;

1483 
hwc
->
idx
 = idx;

1484 } i‡(
idx
 >= 0) {

1489 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
))

1490 
åy_gíîic
;

1492 
hwc
->
c⁄fig_ba£
 = 
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
;

1497 
hwc
->
evít_ba£
 =

1498 
MSR_ARCH_PERFMON_FIXED_CTR0
 - 
X86_PMC_IDX_FIXED
;

1499 
hwc
->
idx
 = idx;

1501 
idx
 = 
hwc
->idx;

1503 i‡(
idx
 =-1 || 
	`ã°_™d_£t_bô
(idx, 
˝uc
->
u£d_mask
)) {

1504 
åy_gíîic
:

1505 
idx
 = 
x86_pmu
.
	`gë_evít_idx
(
˝uc
, 
hwc
);

1506 i‡(
idx
 == -1)

1507  -
EAGAIN
;

1509 
	`£t_bô
(
idx
, 
˝uc
->
u£d_mask
);

1510 
hwc
->
idx
 = idx;

1512 
hwc
->
c⁄fig_ba£
 = 
x86_pmu
.
evít£l
;

1513 
hwc
->
evít_ba£
 = 
x86_pmu
.
≥rf˘r
;

1516  
idx
;

1517 
	}
}

1522 
	$x86_pmu_íabÀ
(
≥rf_evít
 *
evít
)

1524 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1525 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1526 
idx
;

1528 
idx
 = 
	`x86_scheduÀ_evít
(
˝uc
, 
hwc
);

1529 i‡(
idx
 < 0)

1530  
idx
;

1532 
	`≥rf_evíts_œpic_öô
();

1534 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1536 
˝uc
->
evíts
[
idx
] = 
evít
;

1537 
	`£t_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1539 
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
);

1540 
x86_pmu
.
	`íabÀ
(
hwc
, 
idx
);

1542 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1545 
	}
}

1547 
	$x86_pmu_u¡hrŸée
(
≥rf_evít
 *
evít
)

1549 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1550 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1552 i‡(
	`WARN_ON_ONCE
(
hwc
->
idx
 >
X86_PMC_IDX_MAX
 ||

1553 
˝uc
->
evíts
[
hwc
->
idx
] !
evít
))

1556 
x86_pmu
.
	`íabÀ
(
hwc
, hwc->
idx
);

1557 
	}
}

1559 
	$≥rf_evít_¥öt_debug
()

1561 
u64
 
˘æ
, 
°©us
, 
ovîÊow
, 
pmc_˘æ
, 
pmc_cou¡
, 
¥ev_À·
, 
fixed
;

1562 
˝u_hw_evíts
 *
˝uc
;

1563 
Êags
;

1564 
˝u
, 
idx
;

1566 i‡(!
x86_pmu
.
num_evíts
)

1569 
	`loˇl_úq_ßve
(
Êags
);

1571 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1572 
˝uc
 = &
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
);

1574 i‡(
x86_pmu
.
vîsi⁄
 >= 2) {

1575 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
˘æ
);

1576 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1577 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ovîÊow
);

1578 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
, 
fixed
);

1580 
	`¥_öfo
("\n");

1581 
	`¥_öfo
("CPU#%d: cål: %016Œx\n", 
˝u
, 
˘æ
);

1582 
	`¥_öfo
("CPU#%d: sètus: %016Œx\n", 
˝u
, 
°©us
);

1583 
	`¥_öfo
("CPU#%d: ovîÊow: %016Œx\n", 
˝u
, 
ovîÊow
);

1584 
	`¥_öfo
("CPU#%d: fixed: %016Œx\n", 
˝u
, 
fixed
);

1586 
	`¥_öfo
("CPU#%d: u£d: %016Œx\n", 
˝u
, *(
u64
 *)
˝uc
->
u£d_mask
);

1588 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1589 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
pmc_˘æ
);

1590 
	`rdm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 
pmc_cou¡
);

1592 
¥ev_À·
 = 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
˝u
);

1594 
	`¥_öfo
("CPU#%d: gen-PMC%d ctrl: %016llx\n",

1595 
˝u
, 
idx
, 
pmc_˘æ
);

1596 
	`¥_öfo
("CPU#%d: gen-PMC%d count: %016llx\n",

1597 
˝u
, 
idx
, 
pmc_cou¡
);

1598 
	`¥_öfo
("CPU#%d: gen-PMC%dÜeft: %016llx\n",

1599 
˝u
, 
idx
, 
¥ev_À·
);

1601 
idx
 = 0; idx < 
x86_pmu
.
num_evíts_fixed
; idx++) {

1602 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 
pmc_cou¡
);

1604 
	`¥_öfo
("CPU#%d: fixed-PMC%d count: %016llx\n",

1605 
˝u
, 
idx
, 
pmc_cou¡
);

1607 
	`loˇl_úq_ª°‹e
(
Êags
);

1608 
	}
}

1610 
	$öãl_pmu_døö_bts_buf„r
(
˝u_hw_evíts
 *
˝uc
)

1612 
debug_°‹e
 *
ds
 = 
˝uc
->ds;

1613 
	sbts_ªc‹d
 {

1614 
u64
 
‰om
;

1615 
u64
 
to
;

1616 
u64
 
Êags
;

1618 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
X86_PMC_IDX_FIXED_BTS
];

1619 
bts_ªc‹d
 *
©
, *
t›
;

1620 
≥rf_ouçut_h™dÀ
 
h™dÀ
;

1621 
≥rf_evít_hódî
 
hódî
;

1622 
≥rf_ßm∂e_d©a
 
d©a
;

1623 
±_ªgs
 
ªgs
;

1625 i‡(!
evít
)

1628 i‡(!
ds
)

1631 
©
 = (
bts_ªc‹d
 *)()
ds
->
bts_buf„r_ba£
;

1632 
t›
 = (
bts_ªc‹d
 *)()
ds
->
bts_ödex
;

1634 i‡(
t›
 <
©
)

1637 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

1640 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1641 
d©a
.
addr
 = 0;

1642 
d©a
.
øw
 = 
NULL
;

1643 
ªgs
.
ù
 = 0;

1650 
	`≥rf_¥ï¨e_ßm∂e
(&
hódî
, &
d©a
, 
evít
, &
ªgs
);

1652 i‡(
	`≥rf_ouçut_begö
(&
h™dÀ
, 
evít
,

1653 
hódî
.
size
 * (
t›
 - 
©
), 1, 1))

1656 ; 
©
 < 
t›
;át++) {

1657 
d©a
.
ù
 = 
©
->
‰om
;

1658 
d©a
.
addr
 = 
©
->
to
;

1660 
	`≥rf_ouçut_ßm∂e
(&
h™dÀ
, &
hódî
, &
d©a
, 
evít
);

1663 
	`≥rf_ouçut_íd
(&
h™dÀ
);

1666 
evít
->
hw
.
öãºu±s
++;

1667 
evít
->
≥ndög_kûl
 = 
POLL_IN
;

1668 
	}
}

1670 
	$x86_pmu_dißbÀ
(
≥rf_evít
 *
evít
)

1672 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1673 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1674 
idx
 = 
hwc
->idx;

1680 
	`˛ór_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1681 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1687 
	`b¨rõr
();

1693 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1696 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
))

1697 
	`öãl_pmu_døö_bts_buf„r
(
˝uc
);

1699 
˝uc
->
evíts
[
idx
] = 
NULL
;

1700 
	`˛ór_bô
(
idx
, 
˝uc
->
u£d_mask
);

1702 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1703 
	}
}

1709 
	$öãl_pmu_ßve_™d_ª°¨t
(
≥rf_evít
 *
evít
)

1711 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1712 
idx
 = 
hwc
->idx;

1713 
ªt
;

1715 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1716 
ªt
 = 
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
);

1718 i‡(
evít
->
°©e
 =
PERF_EVENT_STATE_ACTIVE
)

1719 
	`öãl_pmu_íabÀ_evít
(
hwc
, 
idx
);

1721  
ªt
;

1722 
	}
}

1724 
	$öãl_pmu_ª£t
()

1726 
debug_°‹e
 *
ds
 = 
	`__gë_˝u_v¨
(
˝u_hw_evíts
).ds;

1727 
Êags
;

1728 
idx
;

1730 i‡(!
x86_pmu
.
num_evíts
)

1733 
	`loˇl_úq_ßve
(
Êags
);

1735 
	`¥ötk
("˛órög PMU sèã o¿CPU#%d\n", 
	`smp_¥o˚ss‹_id
());

1737 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1738 
	`checkög_wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 0ull);

1739 
	`checkög_wrm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 0ull);

1741 
idx
 = 0; idx < 
x86_pmu
.
num_evíts_fixed
; idx++) {

1742 
	`checkög_wrm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 0ull);

1744 i‡(
ds
)

1745 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

1747 
	`loˇl_úq_ª°‹e
(
Êags
);

1748 
	}
}

1750 
	$p6_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1752 
≥rf_ßm∂e_d©a
 
d©a
;

1753 
˝u_hw_evíts
 *
˝uc
;

1754 
≥rf_evít
 *
evít
;

1755 
hw_≥rf_evít
 *
hwc
;

1756 
idx
, 
h™dÀd
 = 0;

1757 
u64
 
vÆ
;

1759 
d©a
.
addr
 = 0;

1760 
d©a
.
øw
 = 
NULL
;

1762 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1764 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1765 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1768 
evít
 = 
˝uc
->
evíts
[
idx
];

1769 
hwc
 = &
evít
->
hw
;

1771 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1772 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
evít_bôs
 - 1)))

1778 
h™dÀd
 = 1;

1779 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1781 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
))

1784 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1785 
	`p6_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1788 i‡(
h™dÀd
)

1789 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1791  
h™dÀd
;

1792 
	}
}

1798 
	$öãl_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1800 
≥rf_ßm∂e_d©a
 
d©a
;

1801 
˝u_hw_evíts
 *
˝uc
;

1802 
bô
, 
lo›s
;

1803 
u64
 
ack
, 
°©us
;

1805 
d©a
.
addr
 = 0;

1806 
d©a
.
øw
 = 
NULL
;

1808 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1810 
	`≥rf_dißbÀ
();

1811 
	`öãl_pmu_døö_bts_buf„r
(
˝uc
);

1812 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1813 i‡(!
°©us
) {

1814 
	`≥rf_íabÀ
();

1818 
lo›s
 = 0;

1819 
agaö
:

1820 i‡(++
lo›s
 > 100) {

1821 
	`WARN_ONCE
(1, "perfevents: irqÜoop stuck!\n");

1822 
	`≥rf_evít_¥öt_debug
();

1823 
	`öãl_pmu_ª£t
();

1824 
	`≥rf_íabÀ
();

1828 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1829 
ack
 = 
°©us
;

1830 
	`f‹_óch_bô
(
bô
, (*)&
°©us
, 
X86_PMC_IDX_MAX
) {

1831 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
bô
];

1833 
	`˛ór_bô
(
bô
, (*Ë&
°©us
);

1834 i‡(!
	`ã°_bô
(
bô
, 
˝uc
->
a˘ive_mask
))

1837 i‡(!
	`öãl_pmu_ßve_™d_ª°¨t
(
evít
))

1840 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1842 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1843 
	`öãl_pmu_dißbÀ_evít
(&
evít
->
hw
, 
bô
);

1846 
	`öãl_pmu_ack_°©us
(
ack
);

1851 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1852 i‡(
°©us
)

1853 
agaö
;

1855 
	`≥rf_íabÀ
();

1858 
	}
}

1860 
	$amd_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1862 
≥rf_ßm∂e_d©a
 
d©a
;

1863 
˝u_hw_evíts
 *
˝uc
;

1864 
≥rf_evít
 *
evít
;

1865 
hw_≥rf_evít
 *
hwc
;

1866 
idx
, 
h™dÀd
 = 0;

1867 
u64
 
vÆ
;

1869 
d©a
.
addr
 = 0;

1870 
d©a
.
øw
 = 
NULL
;

1872 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1874 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1875 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1878 
evít
 = 
˝uc
->
evíts
[
idx
];

1879 
hwc
 = &
evít
->
hw
;

1881 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1882 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
evít_bôs
 - 1)))

1888 
h™dÀd
 = 1;

1889 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1891 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
))

1894 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1895 
	`amd_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1898 i‡(
h™dÀd
)

1899 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1901  
h™dÀd
;

1902 
	}
}

1904 
	$smp_≥rf_≥ndög_öãºu±
(
±_ªgs
 *
ªgs
)

1906 
	`úq_íãr
();

1907 
	`ack_APIC_úq
();

1908 
	`öc_úq_°©
(
≠ic_≥ndög_úqs
);

1909 
	`≥rf_evít_do_≥ndög
();

1910 
	`úq_exô
();

1911 
	}
}

1913 
	$£t_≥rf_evít_≥ndög
()

1915 #ifde‡
CONFIG_X86_LOCAL_APIC


1916 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1919 
≠ic
->
	`£nd_IPI_£lf
(
LOCAL_PENDING_VECTOR
);

1921 
	}
}

1923 
	$≥rf_evíts_œpic_öô
()

1925 #ifde‡
CONFIG_X86_LOCAL_APIC


1926 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1932 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1934 
	}
}

1936 
__k¥obes


1937 
	$≥rf_evít_nmi_h™dÀr
(
nŸifõr_block
 *
£lf
,

1938 
cmd
, *
__¨gs
)

1940 
dõ_¨gs
 *
¨gs
 = 
__¨gs
;

1941 
±_ªgs
 *
ªgs
;

1943 i‡(!
	`©omic_ªad
(&
a˘ive_evíts
))

1944  
NOTIFY_DONE
;

1946 
cmd
) {

1947 
DIE_NMI
:

1948 
DIE_NMI_IPI
:

1952  
NOTIFY_DONE
;

1955 
ªgs
 = 
¨gs
->regs;

1957 #ifde‡
CONFIG_X86_LOCAL_APIC


1958 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1967 
x86_pmu
.
	`h™dÀ_úq
(
ªgs
);

1969  
NOTIFY_STOP
;

1970 
	}
}

1972 
__ªad_mo°ly
 
nŸifõr_block
 
	g≥rf_evít_nmi_nŸifõr
 = {

1973 .
nŸifõr_ˇŒ
 = 
≥rf_evít_nmi_h™dÀr
,

1974 .
	g√xt
 = 
NULL
,

1975 .
	g¥i‹ôy
 = 1

1978 
__öôc⁄°
 
x86_pmu
 
	gp6_pmu
 = {

1979 .
«me
 = "p6",

1980 .
	gh™dÀ_úq
 = 
p6_pmu_h™dÀ_úq
,

1981 .
	gdißbÀ_Æl
 = 
p6_pmu_dißbÀ_Æl
,

1982 .
	gíabÀ_Æl
 = 
p6_pmu_íabÀ_Æl
,

1983 .
	gíabÀ
 = 
p6_pmu_íabÀ_evít
,

1984 .
	gdißbÀ
 = 
p6_pmu_dißbÀ_evít
,

1985 .
	gevít£l
 = 
MSR_P6_EVNTSEL0
,

1986 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

1987 .
	gevít_m≠
 = 
p6_pmu_evít_m≠
,

1988 .
	gøw_evít
 = 
p6_pmu_øw_evít
,

1989 .
	gmax_evíts
 = 
ARRAY_SIZE
(
p6_≥rfm⁄_evít_m≠
),

1990 .
	g≠ic
 = 1,

1991 .
	gmax_≥riod
 = (1ULL << 31) - 1,

1992 .
	gvîsi⁄
 = 0,

1993 .
	gnum_evíts
 = 2,

2001 .
	gevít_bôs
 = 32,

2002 .
	gevít_mask
 = (1ULL << 32) - 1,

2003 .
	ggë_evít_idx
 = 
öãl_gë_evít_idx
,

2006 
__öôc⁄°
 
x86_pmu
 
	göãl_pmu
 = {

2007 .
«me
 = "Intel",

2008 .
	gh™dÀ_úq
 = 
öãl_pmu_h™dÀ_úq
,

2009 .
	gdißbÀ_Æl
 = 
öãl_pmu_dißbÀ_Æl
,

2010 .
	gíabÀ_Æl
 = 
öãl_pmu_íabÀ_Æl
,

2011 .
	gíabÀ
 = 
öãl_pmu_íabÀ_evít
,

2012 .
	gdißbÀ
 = 
öãl_pmu_dißbÀ_evít
,

2013 .
	gevít£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
,

2014 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
,

2015 .
	gevít_m≠
 = 
öãl_pmu_evít_m≠
,

2016 .
	gøw_evít
 = 
öãl_pmu_øw_evít
,

2017 .
	gmax_evíts
 = 
ARRAY_SIZE
(
öãl_≥rfm⁄_evít_m≠
),

2018 .
	g≠ic
 = 1,

2024 .
	gmax_≥riod
 = (1ULL << 31) - 1,

2025 .
	gíabÀ_bts
 = 
öãl_pmu_íabÀ_bts
,

2026 .
	gdißbÀ_bts
 = 
öãl_pmu_dißbÀ_bts
,

2027 .
	ggë_evít_idx
 = 
öãl_gë_evít_idx
,

2030 
__öôc⁄°
 
x86_pmu
 
	gamd_pmu
 = {

2031 .
«me
 = "AMD",

2032 .
	gh™dÀ_úq
 = 
amd_pmu_h™dÀ_úq
,

2033 .
	gdißbÀ_Æl
 = 
amd_pmu_dißbÀ_Æl
,

2034 .
	gíabÀ_Æl
 = 
amd_pmu_íabÀ_Æl
,

2035 .
	gíabÀ
 = 
amd_pmu_íabÀ_evít
,

2036 .
	gdißbÀ
 = 
amd_pmu_dißbÀ_evít
,

2037 .
	gevít£l
 = 
MSR_K7_EVNTSEL0
,

2038 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

2039 .
	gevít_m≠
 = 
amd_pmu_evít_m≠
,

2040 .
	gøw_evít
 = 
amd_pmu_øw_evít
,

2041 .
	gmax_evíts
 = 
ARRAY_SIZE
(
amd_≥rfm⁄_evít_m≠
),

2042 .
	gnum_evíts
 = 4,

2043 .
	gevít_bôs
 = 48,

2044 .
	gevít_mask
 = (1ULL << 48) - 1,

2045 .
	g≠ic
 = 1,

2047 .
	gmax_≥riod
 = (1ULL << 47) - 1,

2048 .
	ggë_evít_idx
 = 
gí_gë_evít_idx
,

2051 
__öô
 
	$p6_pmu_öô
()

2053 
boŸ_˝u_d©a
.
x86_modñ
) {

2061 
evít_c⁄°øöts
 = 
öãl_p6_evít_c⁄°øöts
;

2066 
evít_c⁄°øöts
 = 
öãl_p6_evít_c⁄°øöts
;

2069 
	`¥_c⁄t
("unsupportedÖ6 CPU model %d ",

2070 
boŸ_˝u_d©a
.
x86_modñ
);

2071  -
ENODEV
;

2074 
x86_pmu
 = 
p6_pmu
;

2077 
	}
}

2079 
__öô
 
	$öãl_pmu_öô
()

2081 
˝uid10_edx
 
edx
;

2082 
˝uid10_óx
 
óx
;

2083 
unu£d
;

2084 
ebx
;

2085 
vîsi⁄
;

2087 i‡(!
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

2089 i‡(
boŸ_˝u_d©a
.
x86
 == 6) {

2090  
	`p6_pmu_öô
();

2092  -
ENODEV
;

2100 
	`˝uid
(10, &
óx
.
fuŒ
, &
ebx
, &
unu£d
, &
edx
.full);

2101 i‡(
óx
.
•lô
.
mask_Àngth
 <
ARCH_PERFMON_BRANCH_MISSES_RETIRED
)

2102  -
ENODEV
;

2104 
vîsi⁄
 = 
óx
.
•lô
.
vîsi⁄_id
;

2105 i‡(
vîsi⁄
 < 2)

2106  -
ENODEV
;

2108 
x86_pmu
 = 
öãl_pmu
;

2109 
x86_pmu
.
vîsi⁄
 = version;

2110 
x86_pmu
.
num_evíts
 = 
óx
.
•lô
.num_events;

2111 
x86_pmu
.
evít_bôs
 = 
óx
.
•lô
.
bô_width
;

2112 
x86_pmu
.
evít_mask
 = (1ULL << 
óx
.
•lô
.
bô_width
) - 1;

2118 
x86_pmu
.
num_evíts_fixed
 = 
	`max
(()
edx
.
•lô
.num_events_fixed, 3);

2123 
boŸ_˝u_d©a
.
x86_modñ
) {

2128 
	`mem˝y
(
hw_ˇche_evít_ids
, 
c‹e2_hw_ˇche_evít_ids
,

2129 (
hw_ˇche_evít_ids
));

2131 
	`¥_c⁄t
("Core2Évents, ");

2132 
evít_c⁄°øöts
 = 
öãl_c‹e_evít_c⁄°øöts
;

2136 
	`mem˝y
(
hw_ˇche_evít_ids
, 
√hÆem_hw_ˇche_evít_ids
,

2137 (
hw_ˇche_evít_ids
));

2139 
evít_c⁄°øöts
 = 
öãl_√hÆem_evít_c⁄°øöts
;

2140 
	`¥_c⁄t
("Nehalem/Corei7Évents, ");

2143 
	`mem˝y
(
hw_ˇche_evít_ids
, 
©om_hw_ˇche_evít_ids
,

2144 (
hw_ˇche_evít_ids
));

2146 
	`¥_c⁄t
("AtomÉvents, ");

2150 
	}
}

2152 
__öô
 
	$amd_pmu_öô
()

2155 i‡(
boŸ_˝u_d©a
.
x86
 < 6)

2156  -
ENODEV
;

2158 
x86_pmu
 = 
amd_pmu
;

2161 
	`mem˝y
(
hw_ˇche_evít_ids
, 
amd_hw_ˇche_evít_ids
,

2162 (
hw_ˇche_evít_ids
));

2165 
	}
}

2167 
__öô
 
	$pmu_check_≠ic
()

2169 i‡(
˝u_has_≠ic
)

2172 
x86_pmu
.
≠ic
 = 0;

2173 
	`¥_öfo
("no APIC, boot withÅhe \"lapic\" bootÖarameterÅo force-enable it.\n");

2174 
	`¥_öfo
("no hardware sampling interruptávailable.\n");

2175 
	}
}

2177 
__öô
 
	$öô_hw_≥rf_evíts
()

2179 
îr
;

2181 
	`¥_öfo
("Performance Events: ");

2183 
boŸ_˝u_d©a
.
x86_víd‹
) {

2184 
X86_VENDOR_INTEL
:

2185 
îr
 = 
	`öãl_pmu_öô
();

2187 
X86_VENDOR_AMD
:

2188 
îr
 = 
	`amd_pmu_öô
();

2193 i‡(
îr
 != 0) {

2194 
	`¥_c⁄t
("no PMU driver, softwareÉvents only.\n");

2198 
	`pmu_check_≠ic
();

2200 
	`¥_c⁄t
("%†PMU drivî.\n", 
x86_pmu
.
«me
);

2202 i‡(
x86_pmu
.
num_evíts
 > 
X86_PMC_MAX_GENERIC
) {

2203 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents %d > max(%d), clipping!",

2204 
x86_pmu
.
num_evíts
, 
X86_PMC_MAX_GENERIC
);

2205 
x86_pmu
.
num_evíts
 = 
X86_PMC_MAX_GENERIC
;

2207 
≥rf_evít_mask
 = (1 << 
x86_pmu
.
num_evíts
) - 1;

2208 
≥rf_max_evíts
 = 
x86_pmu
.
num_evíts
;

2210 i‡(
x86_pmu
.
num_evíts_fixed
 > 
X86_PMC_MAX_FIXED
) {

2211 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents fixed %d > max(%d), clipping!",

2212 
x86_pmu
.
num_evíts_fixed
, 
X86_PMC_MAX_FIXED
);

2213 
x86_pmu
.
num_evíts_fixed
 = 
X86_PMC_MAX_FIXED
;

2216 
≥rf_evít_mask
 |=

2217 ((1LL << 
x86_pmu
.
num_evíts_fixed
)-1Ë<< 
X86_PMC_IDX_FIXED
;

2218 
x86_pmu
.
öãl_˘æ
 = 
≥rf_evít_mask
;

2220 
	`≥rf_evíts_œpic_öô
();

2221 
	`ªgi°î_dõ_nŸifõr
(&
≥rf_evít_nmi_nŸifõr
);

2223 
	`¥_öfo
("... vîsi⁄: %d\n", 
x86_pmu
.
vîsi⁄
);

2224 
	`¥_öfo
("... bô width: %d\n", 
x86_pmu
.
evít_bôs
);

2225 
	`¥_öfo
("... gíîi¯ªgi°îs: %d\n", 
x86_pmu
.
num_evíts
);

2226 
	`¥_öfo
("... vÆuêmask: %016Lx\n", 
x86_pmu
.
evít_mask
);

2227 
	`¥_öfo
("... maxÖîiod: %016Lx\n", 
x86_pmu
.
max_≥riod
);

2228 
	`¥_öfo
("... fixed-puΩo£Évíts: %d\n", 
x86_pmu
.
num_evíts_fixed
);

2229 
	`¥_öfo
("...Évíàmask: %016Lx\n", 
≥rf_evít_mask
);

2230 
	}
}

2232 
ölöe
 
	$x86_pmu_ªad
(
≥rf_evít
 *
evít
)

2234 
	`x86_≥rf_evít_upd©e
(
evít
, &evít->
hw
,Évít->hw.
idx
);

2235 
	}
}

2237 c⁄° 
pmu
 
	gpmu
 = {

2238 .
íabÀ
 = 
x86_pmu_íabÀ
,

2239 .
	gdißbÀ
 = 
x86_pmu_dißbÀ
,

2240 .
	gªad
 = 
x86_pmu_ªad
,

2241 .
	gu¡hrŸée
 = 
x86_pmu_u¡hrŸée
,

2245 
	$vÆid©e_evít
(
˝u_hw_evíts
 *
˝uc
, 
≥rf_evít
 *
evít
)

2247 
hw_≥rf_evít
 
Áke_evít
 = 
evít
->
hw
;

2249 i‡(
evít
->
pmu
 &&Évent->pmu != &pmu)

2252  
	`x86_scheduÀ_evít
(
˝uc
, &
Áke_evít
) >= 0;

2253 
	}
}

2255 
	$vÆid©e_group
(
≥rf_evít
 *
evít
)

2257 
≥rf_evít
 *
siblög
, *
Àadî
 = 
evít
->
group_Àadî
;

2258 
˝u_hw_evíts
 
Áke_pmu
;

2260 
	`mem£t
(&
Áke_pmu
, 0, (fake_pmu));

2262 i‡(!
	`vÆid©e_evít
(&
Áke_pmu
, 
Àadî
))

2263  -
ENOSPC
;

2265 
	`li°_f‹_óch_íåy
(
siblög
, &
Àadî
->
siblög_li°
, 
group_íåy
) {

2266 i‡(!
	`vÆid©e_evít
(&
Áke_pmu
, 
siblög
))

2267  -
ENOSPC
;

2270 i‡(!
	`vÆid©e_evít
(&
Áke_pmu
, 
evít
))

2271  -
ENOSPC
;

2274 
	}
}

2276 c⁄° 
pmu
 *
	$hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

2278 
îr
;

2280 
îr
 = 
	`__hw_≥rf_evít_öô
(
evít
);

2281 i‡(!
îr
) {

2282 i‡(
evít
->
group_Àadî
 !=Évent)

2283 
îr
 = 
	`vÆid©e_group
(
evít
);

2285 i‡(
îr
) {

2286 i‡(
evít
->
de°roy
)

2287 
evít
->
	`de°roy
(event);

2288  
	`ERR_PTR
(
îr
);

2291  &
pmu
;

2292 
	}
}

2298 
ölöe


2299 
	$ˇŒchaö_°‹e
(
≥rf_ˇŒchaö_íåy
 *
íåy
, 
u64
 
ù
)

2301 i‡(
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
)

2302 
íåy
->
ù
[íåy->
ƒ
++] = ip;

2303 
	}
}

2305 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_úq_íåy
);

2306 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_nmi_íåy
);

2307 
DEFINE_PER_CPU
(, 
ö_ign‹ed_‰ame
);

2311 
	$backåa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

2314 
	}
}

2316 
	$backåa˚_w¨nög
(*
d©a
, *
msg
)

2319 
	}
}

2321 
	$backåa˚_°ack
(*
d©a
, *
«me
)

2323 
	`≥r_˝u
(
ö_ign‹ed_‰ame
, 
	`smp_¥o˚ss‹_id
()) =

2324 
	`x86_is_°ack_id
(
NMI_STACK
, 
«me
) ||

2325 
	`x86_is_°ack_id
(
DEBUG_STACK
, 
«me
);

2328 
	}
}

2330 
	$backåa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

2332 
≥rf_ˇŒchaö_íåy
 *
íåy
 = 
d©a
;

2334 i‡(
	`≥r_˝u
(
ö_ign‹ed_‰ame
, 
	`smp_¥o˚ss‹_id
()))

2337 i‡(
ªlübÀ
)

2338 
	`ˇŒchaö_°‹e
(
íåy
, 
addr
);

2339 
	}
}

2341 c⁄° 
°ackåa˚_›s
 
	gbackåa˚_›s
 = {

2342 .
w¨nög
 = 
backåa˚_w¨nög
,

2343 .
	gw¨nög_symbﬁ
 = 
backåa˚_w¨nög_symbﬁ
,

2344 .
	g°ack
 = 
backåa˚_°ack
,

2345 .
	gaddªss
 = 
backåa˚_addªss
,

2346 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack_bp
,

2349 
	~"../dump°ack.h
"

2352 
	$≥rf_ˇŒchaö_kî√l
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2354 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_KERNEL
);

2355 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

2357 
	`dump_åa˚
(
NULL
, 
ªgs
, NULL,Ñegs->
bp
, &
backåa˚_›s
, 
íåy
);

2358 
	}
}

2364 
	$c›y_‰om_u£r_nmi
(*
to
, c⁄° 
__u£r
 *
‰om
, 
n
)

2366 
off£t
, 
addr
 = ()
‰om
;

2367 
ty≥
 = 
	`ö_nmi
(Ë? 
KM_NMI
 : 
KM_IRQ0
;

2368 
size
, 
Àn
 = 0;

2369 
∑ge
 *page;

2370 *
m≠
;

2371 
ªt
;

2374 
ªt
 = 
	`__gë_u£r_∑ges_Á°
(
addr
, 1, 0, &
∑ge
);

2375 i‡(!
ªt
)

2378 
off£t
 = 
addr
 & (
PAGE_SIZE
 - 1);

2379 
size
 = 
	`mö
(
PAGE_SIZE
 - 
off£t
, 
n
 - 
Àn
);

2381 
m≠
 = 
	`km≠_©omic
(
∑ge
, 
ty≥
);

2382 
	`mem˝y
(
to
, 
m≠
+
off£t
, 
size
);

2383 
	`kunm≠_©omic
(
m≠
, 
ty≥
);

2384 
	`put_∑ge
(
∑ge
);

2386 
Àn
 +
size
;

2387 
to
 +
size
;

2388 
addr
 +
size
;

2390 } 
Àn
 < 
n
);

2392  
Àn
;

2393 
	}
}

2395 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

2397 
byãs
;

2399 
byãs
 = 
	`c›y_‰om_u£r_nmi
(
‰ame
, 
Â
, (*frame));

2401  
byãs
 =(*
‰ame
);

2402 
	}
}

2405 
	$≥rf_ˇŒchaö_u£r
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2407 
°ack_‰ame
 
‰ame
;

2408 c⁄° 
__u£r
 *
Â
;

2410 i‡(!
	`u£r_mode
(
ªgs
))

2411 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

2413 
Â
 = (
__u£r
 *)
ªgs
->
bp
;

2415 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_USER
);

2416 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

2418 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

2419 
‰ame
.
√xt_‰ame
 = 
NULL
;

2420 
‰ame
.
ªtu∫_addªss
 = 0;

2422 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

2425 i‡(()
Â
 < 
ªgs
->
•
)

2428 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

2429 
Â
 = 
‰ame
.
√xt_‰ame
;

2431 
	}
}

2434 
	$≥rf_do_ˇŒchaö
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2436 
is_u£r
;

2438 i‡(!
ªgs
)

2441 
is_u£r
 = 
	`u£r_mode
(
ªgs
);

2443 i‡(!
cuºít
 || cuºít->
pid
 == 0)

2446 i‡(
is_u£r
 && 
cuºít
->
°©e
 !
TASK_RUNNING
)

2449 i‡(!
is_u£r
)

2450 
	`≥rf_ˇŒchaö_kî√l
(
ªgs
, 
íåy
);

2452 i‡(
cuºít
->
mm
)

2453 
	`≥rf_ˇŒchaö_u£r
(
ªgs
, 
íåy
);

2454 
	}
}

2456 
≥rf_ˇŒchaö_íåy
 *
	$≥rf_ˇŒchaö
(
±_ªgs
 *
ªgs
)

2458 
≥rf_ˇŒchaö_íåy
 *
íåy
;

2460 i‡(
	`ö_nmi
())

2461 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_nmi_íåy
);

2463 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_úq_íåy
);

2465 
íåy
->
ƒ
 = 0;

2467 
	`≥rf_do_ˇŒchaö
(
ªgs
, 
íåy
);

2469  
íåy
;

2470 
	}
}

2472 
	$hw_≥rf_evít_£tup_⁄löe
(
˝u
)

2474 
	`öô_debug_°‹e_⁄_˝u
(
˝u
);

2475 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/bô›s.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/nmi.h
>

20 
	~<löux/k¥obes.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/≥rf_evít.h
>

25 
	snmi_w©chdog_˘lblk
 {

26 
	mcc¸_m§
;

27 
	m≥rf˘r_m§
;

28 
	mev¡£l_m§
;

32 
	swd_›s
 {

33 (*
	mª£rve
)();

34 (*
	muƒe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	mª¨m
)(
nmi_w©chdog_˘lblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m°›
)();

38 
	m≥rf˘r
;

39 
	mev¡£l
;

40 
u64
 
	mcheckbô
;

43 c⁄° 
wd_›s
 *
	gwd_›s
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
≥rf˘r_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
ev¡£l_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_˘lblk
,Çmi_watchdog_ctlblk);

66 
ölöe
 
	$nmi_≥rf˘r_m§_to_bô
(
m§
)

69 
boŸ_˝u_d©a
.
x86_víd‹
) {

70 
X86_VENDOR_AMD
:

71  
m§
 - 
MSR_K7_PERFCTR0
;

72 
X86_VENDOR_INTEL
:

73 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  
m§
 - 
MSR_ARCH_PERFMON_PERFCTR0
;

76 
boŸ_˝u_d©a
.
x86
) {

78  
m§
 - 
MSR_P6_PERFCTR0
;

80  
m§
 - 
MSR_P4_BPU_PERFCTR0
;

84 
	}
}

90 
ölöe
 
	$nmi_ev¡£l_m§_to_bô
(
m§
)

93 
boŸ_˝u_d©a
.
x86_víd‹
) {

94 
X86_VENDOR_AMD
:

95  
m§
 - 
MSR_K7_EVNTSEL0
;

96 
X86_VENDOR_INTEL
:

97 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  
m§
 - 
MSR_ARCH_PERFMON_EVENTSEL0
;

100 
boŸ_˝u_d©a
.
x86
) {

102  
m§
 - 
MSR_P6_EVNTSEL0
;

104  
m§
 - 
MSR_P4_BSU_ESCR0
;

109 
	}
}

112 
	$avaû_to_ª§v_≥rf˘r_nmi_bô
(
cou¡î
)

114 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

116  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

117 
	}
}

120 
	$avaû_to_ª§v_≥rf˘r_nmi
(
m§
)

122 
cou¡î
;

124 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

125 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

127  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

128 
	}
}

129 
EXPORT_SYMBOL
(
avaû_to_ª§v_≥rf˘r_nmi_bô
);

131 
	$ª£rve_≥rf˘r_nmi
(
m§
)

133 
cou¡î
;

135 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

137 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

140 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
))

143 
	}
}

144 
EXPORT_SYMBOL
(
ª£rve_≥rf˘r_nmi
);

146 
	$ªÀa£_≥rf˘r_nmi
(
m§
)

148 
cou¡î
;

150 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

152 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

155 
	`˛ór_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

156 
	}
}

157 
EXPORT_SYMBOL
(
ªÀa£_≥rf˘r_nmi
);

159 
	$ª£rve_ev¡£l_nmi
(
m§
)

161 
cou¡î
;

163 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

165 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

168 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
))

171 
	}
}

172 
EXPORT_SYMBOL
(
ª£rve_ev¡£l_nmi
);

174 
	$ªÀa£_ev¡£l_nmi
(
m§
)

176 
cou¡î
;

178 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

180 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

183 
	`˛ór_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
);

184 
	}
}

185 
EXPORT_SYMBOL
(
ªÀa£_ev¡£l_nmi
);

187 
	$dißbÀ_œpic_nmi_w©chdog
()

189 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

191 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

194 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

196 i‡(
wd_›s
)

197 
wd_›s
->
	`uƒe£rve
();

199 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

200 
	}
}

202 
	$íabÀ_œpic_nmi_w©chdog
()

204 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

207 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) != 0)

211 i‡(!
wd_›s
)

213 i‡(!
wd_›s
->
	`ª£rve
()) {

214 
	`¥ötk
(
KERN_ERR
 "NMI watchdog: cannotÑeserveÖerfctrs\n");

218 
	`⁄_óch_˝u
(
£tup_≠ic_nmi_w©chdog
, 
NULL
, 1);

219 
	`touch_nmi_w©chdog
();

220 
	}
}

226 
	$adju°_f‹_32bô_˘r
(
hz
)

228 
u64
 
cou¡î_vÆ
;

229 
ªtvÆ
 = 
hz
;

238 
cou¡î_vÆ
 = (
u64
)
˝u_khz
 * 1000;

239 
	`do_div
(
cou¡î_vÆ
, 
ªtvÆ
);

240 i‡(
cou¡î_vÆ
 > 0x7fffffffULL) {

241 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

242 
	`do_div
(
cou¡
, 0x7fffffffUL);

243 
ªtvÆ
 = 
cou¡
 + 1;

245  
ªtvÆ
;

246 
	}
}

248 
	$wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
,

249 c⁄° *
des¸
, 
nmi_hz
)

251 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

253 
	`do_div
(
cou¡
, 
nmi_hz
);

254 i‡(
des¸
)

255 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

256 
	`wrm§l
(
≥rf˘r_m§
, 0 - 
cou¡
);

257 
	}
}

259 
	$wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
,

260 c⁄° *
des¸
, 
nmi_hz
)

262 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

264 
	`do_div
(
cou¡
, 
nmi_hz
);

265 i‡(
des¸
)

266 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

267 
	`wrm§
(
≥rf˘r_m§
, (
u32
)(-
cou¡
), 0);

268 
	}
}

274 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

275 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

276 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

277 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

278 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

279 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

281 
	$£tup_k7_w©chdog
(
nmi_hz
)

283 
≥rf˘r_m§
, 
ev¡£l_m§
;

284 
ev¡£l
;

285 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

287 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

288 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

290 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

292 
ev¡£l
 = 
K7_EVNTSEL_INT


293 | 
K7_EVNTSEL_OS


294 | 
K7_EVNTSEL_USR


295 | 
K7_NMI_EVENT
;

298 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

299 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "K7_PERFCTR0", 
nmi_hz
);

302 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

303 
wd
->
ev¡£l_m§
 =Évntsel_msr;

304 
wd
->
cc¸_m§
 = 0;

307 
	`˝u_nmi_£t_wd_íabÀd
();

309 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

310 
ev¡£l
 |
K7_EVNTSEL_ENABLE
;

311 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

314 
	}
}

316 
	$sögÀ_m§_°›_w©chdog
()

318 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

320 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

321 
	}
}

323 
	$sögÀ_m§_ª£rve
()

325 i‡(!
	`ª£rve_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
))

328 i‡(!
	`ª£rve_ev¡£l_nmi
(
wd_›s
->
ev¡£l
)) {

329 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

333 
	}
}

335 
	$sögÀ_m§_uƒe£rve
()

337 
	`ªÀa£_ev¡£l_nmi
(
wd_›s
->
ev¡£l
);

338 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

339 
	}
}

341 
__k¥obes


342 
	$sögÀ_m§_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

345 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

346 
	}
}

348 c⁄° 
wd_›s
 
	gk7_wd_›s
 = {

349 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

350 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

351 .
	g£tup
 = 
£tup_k7_w©chdog
,

352 .
	gª¨m
 = 
sögÀ_m§_ª¨m
,

353 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

354 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

355 .
	gev¡£l
 = 
MSR_K7_EVNTSEL0
,

356 .
	gcheckbô
 = 1ULL << 47,

362 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

363 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

364 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

365 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

366 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

367 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

369 
	$£tup_p6_w©chdog
(
nmi_hz
)

371 
≥rf˘r_m§
, 
ev¡£l_m§
;

372 
ev¡£l
;

373 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

375 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

376 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

379 i‡(
	`wrm§_ß„
(
≥rf˘r_m§
, 0, 0) < 0)

382 
ev¡£l
 = 
P6_EVNTSEL_INT


383 | 
P6_EVNTSEL_OS


384 | 
P6_EVNTSEL_USR


385 | 
P6_NMI_EVENT
;

388 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

389 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

390 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "P6_PERFCTR0", 
nmi_hz
);

393 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

394 
wd
->
ev¡£l_m§
 =Évntsel_msr;

395 
wd
->
cc¸_m§
 = 0;

398 
	`˝u_nmi_£t_wd_íabÀd
();

400 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

401 
ev¡£l
 |
P6_EVNTSEL0_ENABLE
;

402 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

405 
	}
}

407 
__k¥obes
 
	$p6_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

415 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

418 
	`wrôe_w©chdog_cou¡î32
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

419 
	}
}

421 c⁄° 
wd_›s
 
	gp6_wd_›s
 = {

422 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

423 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

424 .
	g£tup
 = 
£tup_p6_w©chdog
,

425 .
	gª¨m
 = 
p6_ª¨m
,

426 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

427 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

428 .
	gev¡£l
 = 
MSR_P6_EVNTSEL0
,

429 .
	gcheckbô
 = 1ULL << 39,

436 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

437 
	#P4_ESCR_EVENT_SELECT
(
N
Ë((NË<< 25)

	)

438 
	#P4_ESCR_OS
 (1 << 3)

	)

439 
	#P4_ESCR_USR
 (1 << 2)

	)

440 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

441 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

442 
	#P4_CCCR_THRESHOLD
(
N
Ë((NË<< 20)

	)

443 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

444 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

445 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

446 
	#P4_CCCR_ESCR_SELECT
(
N
Ë((NË<< 13)

	)

447 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

448 
	#P4_CCCR_OVF
 (1 << 31)

	)

450 
	#P4_CONTROLS
 18

	)

451 
	gp4_c⁄åﬁs
[18] = {

452 
MSR_P4_BPU_CCCR0
,

453 
MSR_P4_BPU_CCCR1
,

454 
MSR_P4_BPU_CCCR2
,

455 
MSR_P4_BPU_CCCR3
,

456 
MSR_P4_MS_CCCR0
,

457 
MSR_P4_MS_CCCR1
,

458 
MSR_P4_MS_CCCR2
,

459 
MSR_P4_MS_CCCR3
,

460 
MSR_P4_FLAME_CCCR0
,

461 
MSR_P4_FLAME_CCCR1
,

462 
MSR_P4_FLAME_CCCR2
,

463 
MSR_P4_FLAME_CCCR3
,

464 
MSR_P4_IQ_CCCR0
,

465 
MSR_P4_IQ_CCCR1
,

466 
MSR_P4_IQ_CCCR2
,

467 
MSR_P4_IQ_CCCR3
,

468 
MSR_P4_IQ_CCCR4
,

469 
MSR_P4_IQ_CCCR5
,

476 
	$£tup_p4_w©chdog
(
nmi_hz
)

478 
≥rf˘r_m§
, 
ev¡£l_m§
, 
cc¸_m§
;

479 
ev¡£l
, 
cc¸_vÆ
;

480 
misc_íabÀ
, 
dummy
;

481 
ht_num
;

482 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

484 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
, 
dummy
);

485 i‡(!(
misc_íabÀ
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

488 #ifde‡
CONFIG_SMP


490 i‡(
smp_num_siblögs
 == 2) {

491 
ebx
, 
≠icid
;

493 
ebx
 = 
	`˝uid_ebx
(1);

494 
≠icid
 = (
ebx
 >> 24) & 0xff;

495 
ht_num
 = 
≠icid
 & 1;

498 
ht_num
 = 0;

506 i‡(!
ht_num
) {

508 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR0
;

509 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

510 
cc¸_m§
 = 
MSR_P4_IQ_CCCR0
;

511 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

522 i‡(
ª£t_devi˚s
) {

523 
low
, 
high
;

524 
i
;

526 
i
 = 0; i < 
P4_CONTROLS
; i++) {

527 
	`rdm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

528 
low
 &~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

529 
	`wrm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

534 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR1
;

535 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

536 
cc¸_m§
 = 
MSR_P4_IQ_CCCR1
;

539 i‡(
boŸ_˝u_d©a
.
x86_modñ
 =4 && boŸ_˝u_d©a.
x86_mask
 == 4)

540 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
;

542 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI1
;

543 
cc¸_vÆ
 |
	`P4_CCCR_ESCR_SELECT
(4);

546 
ev¡£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

547 | 
P4_ESCR_OS


548 | 
P4_ESCR_USR
;

550 
cc¸_vÆ
 |
	`P4_CCCR_THRESHOLD
(15)

551 | 
P4_CCCR_COMPLEMENT


552 | 
P4_CCCR_COMPARE


553 | 
P4_CCCR_REQUIRED
;

555 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

556 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

557 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "P4_IQ_COUNTER0", 
nmi_hz
);

559 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

560 
wd
->
ev¡£l_m§
 =Évntsel_msr;

561 
wd
->
cc¸_m§
 = cccr_msr;

564 
	`˝u_nmi_£t_wd_íabÀd
();

566 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

567 
cc¸_vÆ
 |
P4_CCCR_ENABLE
;

568 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

570 
	}
}

572 
	$°›_p4_w©chdog
()

574 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

575 
	`wrm§
(
wd
->
cc¸_m§
, 0, 0);

576 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

577 
	}
}

579 
	$p4_ª£rve
()

581 i‡(!
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
))

583 #ifde‡
CONFIG_SMP


584 i‡(
smp_num_siblögs
 > 1 && !
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
))

585 
Áû1
;

587 i‡(!
	`ª£rve_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
))

588 
Áû2
;

591 
Áû2
:

592 #ifde‡
CONFIG_SMP


593 i‡(
smp_num_siblögs
 > 1)

594 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

595 
Áû1
:

597 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

599 
	}
}

601 
	$p4_uƒe£rve
()

603 #ifde‡
CONFIG_SMP


604 i‡(
smp_num_siblögs
 > 1)

605 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

607 
	`ªÀa£_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
);

608 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

609 
	}
}

611 
__k¥obes
 
	$p4_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

613 
dummy
;

621 
	`rdm§l
(
wd
->
cc¸_m§
, 
dummy
);

622 
dummy
 &~
P4_CCCR_OVF
;

623 
	`wrm§l
(
wd
->
cc¸_m§
, 
dummy
);

624 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

626 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

627 
	}
}

629 c⁄° 
wd_›s
 
	gp4_wd_›s
 = {

630 .
ª£rve
 = 
p4_ª£rve
,

631 .
	guƒe£rve
 = 
p4_uƒe£rve
,

632 .
	g£tup
 = 
£tup_p4_w©chdog
,

633 .
	gª¨m
 = 
p4_ª¨m
,

634 .
	g°›
 = 
°›_p4_w©chdog
,

636 .
	g≥rf˘r
 = 
MSR_P4_BPU_PERFCTR0
,

637 .
	gev¡£l
 = 
MSR_P4_BSU_ESCR0
,

638 .
	gcheckbô
 = 1ULL << 39,

645 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

646 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

648 
wd_›s
 
	göãl_¨ch_wd_›s
;

650 
	$£tup_öãl_¨ch_w©chdog
(
nmi_hz
)

652 
ebx
;

653 
˝uid10_óx
 
óx
;

654 
unu£d
;

655 
≥rf˘r_m§
, 
ev¡£l_m§
;

656 
ev¡£l
;

657 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

664 
	`˝uid
(10, &(
óx
.
fuŒ
), &
ebx
, &
unu£d
, &unused);

665 i‡((
óx
.
•lô
.
mask_Àngth
 <

666 (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

667 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

670 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

671 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

673 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

675 
ev¡£l
 = 
ARCH_PERFMON_EVENTSEL_INT


676 | 
ARCH_PERFMON_EVENTSEL_OS


677 | 
ARCH_PERFMON_EVENTSEL_USR


678 | 
ARCH_PERFMON_NMI_EVENT_SEL


679 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

682 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

683 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

684 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

686 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

687 
wd
->
ev¡£l_m§
 =Évntsel_msr;

688 
wd
->
cc¸_m§
 = 0;

691 
	`˝u_nmi_£t_wd_íabÀd
();

693 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

694 
ev¡£l
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

695 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

696 
öãl_¨ch_wd_›s
.
checkbô
 = 1ULL << (
óx
.
•lô
.
bô_width
 - 1);

698 
	}
}

700 
wd_›s
 
öãl_¨ch_wd_›s
 
	g__ªad_mo°ly
 = {

701 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

702 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

703 .
	g£tup
 = 
£tup_öãl_¨ch_w©chdog
,

704 .
	gª¨m
 = 
p6_ª¨m
,

705 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

706 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

707 .
	gev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

710 
	$¥obe_nmi_w©chdog
()

712 
boŸ_˝u_d©a
.
x86_víd‹
) {

713 
X86_VENDOR_AMD
:

714 i‡(
boŸ_˝u_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

715 
boŸ_˝u_d©a
.
x86
 != 16 && boot_cpu_data.x86 != 17)

717 
wd_›s
 = &
k7_wd_›s
;

719 
X86_VENDOR_INTEL
:

726 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 14) ||

727 ((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 15 &&

728 
boŸ_˝u_d©a
.
x86_mask
 == 4))) {

729 
öãl_¨ch_wd_›s
.
≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

730 
öãl_¨ch_wd_›s
.
ev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

732 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

733 
wd_›s
 = &
öãl_¨ch_wd_›s
;

736 
boŸ_˝u_d©a
.
x86
) {

738 i‡(
boŸ_˝u_d©a
.
x86_modñ
 > 13)

741 
wd_›s
 = &
p6_wd_›s
;

744 
wd_›s
 = &
p4_wd_›s
;

751 
	}
}

755 
	$œpic_w©chdog_öô
(
nmi_hz
)

757 i‡(!
wd_›s
) {

758 
	`¥obe_nmi_w©chdog
();

759 i‡(!
wd_›s
) {

760 
	`¥ötk
(
KERN_INFO
 "NMI watchdog: CPUÇot supported\n");

764 i‡(!
wd_›s
->
	`ª£rve
()) {

765 
	`¥ötk
(
KERN_ERR


771 i‡(!(
wd_›s
->
	`£tup
(
nmi_hz
))) {

772 
	`¥ötk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

773 
	`øw_smp_¥o˚ss‹_id
());

778 
	}
}

780 
	$œpic_w©chdog_°›
()

782 i‡(
wd_›s
)

783 
wd_›s
->
	`°›
();

784 
	}
}

786 
	$œpic_adju°_nmi_hz
(
hz
)

788 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

789 i‡(
wd
->
≥rf˘r_m§
 =
MSR_P6_PERFCTR0
 ||

790 
wd
->
≥rf˘r_m§
 =
MSR_ARCH_PERFMON_PERFCTR1
)

791 
hz
 = 
	`adju°_f‹_32bô_˘r
(hz);

792  
hz
;

793 
	}
}

795 
__k¥obes
 
	$œpic_wd_evít
(
nmi_hz
)

797 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

798 
u64
 
˘r
;

800 
	`rdm§l
(
wd
->
≥rf˘r_m§
, 
˘r
);

801 i‡(
˘r
 & 
wd_›s
->
checkbô
)

804 
wd_›s
->
	`ª¨m
(
wd
, 
nmi_hz
);

806 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/˝u„©uª.h
>

9 c⁄° *c⁄° 
	gx86_powî_Êags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<löux/smp.h
>

2 
	~<löux/timex.h
>

3 
	~<löux/°rög.h
>

4 
	~<löux/£q_fûe.h
>

5 
	~<löux/˝u‰eq.h
>

10 
	$show_˝uöfo_c‹e
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
,

11 
˝u
)

13 #ifde‡
CONFIG_SMP


14 i‡(
c
->
x86_max_c‹es
 * 
smp_num_siblögs
 > 1) {

15 
	`£q_¥ötf
(
m
, "physiˇ»id\t: %d\n", 
c
->
phys_¥oc_id
);

16 
	`£q_¥ötf
(
m
, "siblings\t: %d\n",

17 
	`˝umask_weight
(
	`˝u_c‹e_mask
(
˝u
)));

18 
	`£q_¥ötf
(
m
, "c‹êid\t\t: %d\n", 
c
->
˝u_c‹e_id
);

19 
	`£q_¥ötf
(
m
, "˝u c‹es\t: %d\n", 
c
->
boŸed_c‹es
);

20 
	`£q_¥ötf
(
m
, "≠icid\t\t: %d\n", 
c
->
≠icid
);

21 
	`£q_¥ötf
(
m
, "öôü»≠icid\t: %d\n", 
c
->
öôül_≠icid
);

24 
	}
}

26 #ifde‡
CONFIG_X86_32


27 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

33 
Âu_ex˚±i⁄
 = 
c
->
h¨d_m©h
 && (
ign‹e_Âu_úq
 || 
˝u_has_Âu
);

34 
	`£q_¥ötf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
h…_w‹ks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¨d_m©h
 ? "yes" : "no",

48 
Âu_ex˚±i⁄
 ? "yes" : "no",

49 
c
->
˝uid_Àvñ
,

50 
c
->
wp_w‹ks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

55 
	`£q_¥ötf
(
m
,

60 
c
->
˝uid_Àvñ
);

61 
	}
}

64 
	$show_˝uöfo
(
£q_fûe
 *
m
, *
v
)

66 
˝uöfo_x86
 *
c
 = 
v
;

67 
˝u
 = 0;

68 
i
;

70 #ifde‡
CONFIG_SMP


71 
˝u
 = 
c
->
˝u_ödex
;

73 
	`£q_¥ötf
(
m
, "processor\t: %u\n"

78 
˝u
,

79 
c
->
x86_víd‹_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_modñ
,

82 
c
->
x86_modñ_id
[0] ? c->x86_model_id : "unknown");

84 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

85 
	`£q_¥ötf
(
m
, "°ïpög\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_¥ötf
(
m
, "stepping\t: unknown\n");

89 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
‰eq
 = 
	`˝u‰eq_quick_gë
(
˝u
);

92 i‡(!
‰eq
)

93 
‰eq
 = 
˝u_khz
;

94 
	`£q_¥ötf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
‰eq
 / 1000, (freq % 1000));

99 i‡(
c
->
x86_ˇche_size
 >= 0)

100 
	`£q_¥ötf
(
m
, "ˇchêsize\t: %d KB\n", 
c
->
x86_ˇche_size
);

102 
	`show_˝uöfo_c‹e
(
m
, 
c
, 
˝u
);

103 
	`show_˝uöfo_misc
(
m
, 
c
);

105 
	`£q_¥ötf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 i‡(
	`˝u_has
(
c
, 
i
Ë&& 
x86_ˇp_Êags
[i] !
NULL
)

108 
	`£q_¥ötf
(
m
, " %s", 
x86_ˇp_Êags
[
i
]);

110 
	`£q_¥ötf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
lo›s_≥r_jiffy
/(500000/
HZ
),

112 (
c
->
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100);

114 #ifde‡
CONFIG_X86_64


115 i‡(
c
->
x86_ébsize
 > 0)

116 
	`£q_¥ötf
(
m
, "TLB size\t: %d 4KÖages\n", 
c
->
x86_ébsize
);

118 
	`£q_¥ötf
(
m
, "˛Êush size\t: %u\n", 
c
->
x86_˛Êush_size
);

119 
	`£q_¥ötf
(
m
, "ˇche_Æignmít\t: %d\n", 
c
->
x86_ˇche_Æignmít
);

120 
	`£q_¥ötf
(
m
, "address sizes\t: %u bitsÖhysical, %u bits virtual\n",

121 
c
->
x86_phys_bôs
, c->
x86_vút_bôs
);

123 
	`£q_¥ötf
(
m
, "power management:");

124 
i
 = 0; i < 32; i++) {

125 i‡(
c
->
x86_powî
 & (1 << 
i
)) {

126 i‡(
i
 < 
	`ARRAY_SIZE
(
x86_powî_Êags
) &&

127 
x86_powî_Êags
[
i
])

128 
	`£q_¥ötf
(
m
, "%s%s",

129 
x86_powî_Êags
[
i
][0] ? " " : "",

130 
x86_powî_Êags
[
i
]);

132 
	`£q_¥ötf
(
m
, " [%d]", 
i
);

136 
	`£q_¥ötf
(
m
, "\n\n");

139 
	}
}

141 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

143 i‡(*
pos
 == 0)

144 *
pos
 = 
	`˝umask_fú°
(
˝u_⁄löe_mask
);

146 *
pos
 = 
	`˝umask_√xt
(*po†- 1, 
˝u_⁄löe_mask
);

147 i‡((*
pos
Ë< 
ƒ_˝u_ids
)

148  &
	`˝u_d©a
(*
pos
);

149  
NULL
;

150 
	}
}

152 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

154 (*
pos
)++;

155  
	`c_°¨t
(
m
, 
pos
);

156 
	}
}

158 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

160 
	}
}

162 c⁄° 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

163 .
°¨t
 = 
c_°¨t
,

164 .
	g√xt
 = 
c_√xt
,

165 .
	g°›
 = 
c_°›
,

166 .
	gshow
 = 
show_˝uöfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/sched.c

1 
	~<löux/sched.h
>

2 
	~<löux/m©h64.h
>

3 
	~<löux/≥r˝u.h
>

4 
	~<löux/úqÊags.h
>

6 
	~<asm/˝u„©uª.h
>

7 
	~<asm/¥o˚ss‹.h
>

9 #ifde‡
CONFIG_SMP


11 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ﬁd_≥rf_sched
);

13 
	$sˇÀ_≠îfm≥rf
()

15 
≠îfm≥rf
 
vÆ
, *
ﬁd
 = &
	`__gë_˝u_v¨
(
ﬁd_≥rf_sched
);

16 
øtio
, 
Êags
;

18 
	`loˇl_úq_ßve
(
Êags
);

19 
	`gë_≠îfm≥rf
(&
vÆ
);

20 
	`loˇl_úq_ª°‹e
(
Êags
);

22 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(
ﬁd
, &
vÆ
);

23 *
ﬁd
 = 
vÆ
;

25  
øtio
;

26 
	}
}

28 
	$¨ch_sˇÀ_‰eq_powî
(
sched_domaö
 *
sd
, 
˝u
)

34 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

35  
	`sˇÀ_≠îfm≥rf
();

41  
	`deÁu…_sˇÀ_‰eq_powî
(
sd
, 
˝u
);

42 
	}
}

44 
	$¨ch_sˇÀ_smt_powî
(
sched_domaö
 *
sd
, 
˝u
)

49 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

50  
SCHED_LOAD_SCALE
;

52  
	`deÁu…_sˇÀ_smt_powî
(
sd
, 
˝u
);

53 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<löux/dmi.h
>

25 
	~<asm/div64.h
>

26 
	~<asm/vmw¨e.h
>

27 
	~<asm/x86_öô.h
>

29 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

30 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

31 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

33 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

34 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

36 
	#VMWARE_PORT
(
cmd
, 
óx
, 
ebx
, 
ecx
, 
edx
) \

37 
	`__asm__
("inl (%%dx)" : \

38 "˜"(
óx
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

39 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

40 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

41 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

42 "mem‹y");

	)

44 
ölöe
 
	$__vmw¨e_∂©f‹m
()

46 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

47 
	`VMWARE_PORT
(
GETVERSION
, 
óx
, 
ebx
, 
ecx
, 
edx
);

48  
óx
 !(
uöt32_t
)-1 && 
ebx
 =
VMWARE_HYPERVISOR_MAGIC
;

49 
	}
}

51 
	$vmw¨e_gë_tsc_khz
()

53 
uöt64_t
 
tsc_hz
;

54 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

56 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

58 
tsc_hz
 = 
óx
 | (((
uöt64_t
)
ebx
) << 32);

59 
	`do_div
(
tsc_hz
, 1000);

60 
	`BUG_ON
(
tsc_hz
 >> 32);

61 
	`¥ötk
(
KERN_INFO
 "TSC freqÑead from hypervisor : %lu.%03lu MHz\n",

62 (Ë
tsc_hz
 / 1000,

63 (Ë
tsc_hz
 % 1000);

64  
tsc_hz
;

65 
	}
}

67 
__öô
 
	$vmw¨e_∂©f‹m_£tup
()

69 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

71 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

73 i‡(
ebx
 !
UINT_MAX
)

74 
x86_∂©f‹m
.
ˇlibøã_tsc
 = 
vmw¨e_gë_tsc_khz
;

76 
	`¥ötk
(
KERN_WARNING


78 
	}
}

85 
	$vmw¨e_∂©f‹m
()

87 i‡(
˝u_has_hy≥rvis‹
) {

88 
óx
, 
ebx
, 
ecx
, 
edx
;

89 
hy≥r_víd‹_id
[13];

91 
	`˝uid
(
CPUID_VMWARE_INFO_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
	`mem˝y
(
hy≥r_víd‹_id
 + 0, &
ebx
, 4);

93 
	`mem˝y
(
hy≥r_víd‹_id
 + 4, &
ecx
, 4);

94 
	`mem˝y
(
hy≥r_víd‹_id
 + 8, &
edx
, 4);

95 
hy≥r_víd‹_id
[12] = '\0';

96 i‡(!
	`°rcmp
(
hy≥r_víd‹_id
, "VMwareVMware"))

98 } i‡(
dmi_avaûabÀ
 && 
	`dmi_«me_ö_£rül
("VMware") &&

99 
	`__vmw¨e_∂©f‹m
())

103 
	}
}

117 
__˝uöô
 
	$vmw¨e_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

119 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

120 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<löux/moduÀ.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/î∫o.h
>

32 
	~<löux/f˙é.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/smp_lock.h
>

37 
	~<löux/maj‹.h
>

38 
	~<löux/fs.h
>

39 
	~<löux/devi˚.h
>

40 
	~<löux/˝u.h
>

41 
	~<löux/nŸifõr.h
>

42 
	~<löux/uac˚ss.h
>

44 
	~<asm/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/sy°em.h
>

48 
˛ass
 *
	g˝uid_˛ass
;

50 
	s˝uid_ªgs
 {

51 
u32
 
	móx
, 
	mebx
, 
	mecx
, 
	medx
;

54 
	$˝uid_smp_˝uid
(*
cmd_block
)

56 
˝uid_ªgs
 *
cmd
 = (˝uid_ªg†*)
cmd_block
;

58 
	`˝uid_cou¡
(
cmd
->
óx
, cmd->
ecx
,

59 &
cmd
->
óx
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

60 
	}
}

62 
loff_t
 
	$˝uid_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

64 
loff_t
 
ªt
;

65 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

67 
	`muãx_lock
(&
öode
->
i_muãx
);

68 
‹ig
) {

70 
fûe
->
f_pos
 = 
off£t
;

71 
ªt
 = 
fûe
->
f_pos
;

74 
fûe
->
f_pos
 +
off£t
;

75 
ªt
 = 
fûe
->
f_pos
;

78 
ªt
 = -
EINVAL
;

80 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

81  
ªt
;

82 
	}
}

84 
ssize_t
 
	$˝uid_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

85 
size_t
 
cou¡
, 
loff_t
 *
µos
)

87 
__u£r
 *
tmp
 = 
buf
;

88 
˝uid_ªgs
 
cmd
;

89 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

90 
u64
 
pos
 = *
µos
;

91 
ssize_t
 
byãs
 = 0;

92 
îr
 = 0;

94 i‡(
cou¡
 % 16)

95  -
EINVAL
;

97 ; 
cou¡
; count -= 16) {

98 
cmd
.
óx
 = 
pos
;

99 
cmd
.
ecx
 = 
pos
 >> 32;

100 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝uid_smp_˝uid
, &
cmd
, 1);

101 i‡(
îr
)

103 i‡(
	`c›y_to_u£r
(
tmp
, &
cmd
, 16)) {

104 
îr
 = -
EFAULT
;

107 
tmp
 += 16;

108 
byãs
 += 16;

109 *
µos
 = ++
pos
;

112  
byãs
 ? byã†: 
îr
;

113 
	}
}

115 
	$˝uid_›í
(
öode
 *öode, 
fûe
 *file)

117 
˝u
;

118 
˝uöfo_x86
 *
c
;

120 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

121 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

122  -
ENXIO
;

124 
c
 = &
	`˝u_d©a
(
˝u
);

125 i‡(
c
->
˝uid_Àvñ
 < 0)

126  -
EIO
;

129 
	}
}

134 c⁄° 
fûe_›î©i⁄s
 
	g˝uid_f›s
 = {

135 .
ow√r
 = 
THIS_MODULE
,

136 .
	gŒ£ek
 = 
˝uid_£ek
,

137 .
	gªad
 = 
˝uid_ªad
,

138 .
	g›í
 = 
˝uid_›í
,

141 
__˝uöô
 
	$˝uid_devi˚_¸óã
(
˝u
)

143 
devi˚
 *
dev
;

145 
dev
 = 
	`devi˚_¸óã
(
˝uid_˛ass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
), NULL,

146 "˝u%d", 
˝u
);

147  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

148 
	}
}

150 
	$˝uid_devi˚_de°roy
(
˝u
)

152 
	`devi˚_de°roy
(
˝uid_˛ass
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
));

153 
	}
}

155 
__˝uöô
 
	$˝uid_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

156 
a˘i⁄
,

157 *
h˝u
)

159 
˝u
 = ()
h˝u
;

160 
îr
 = 0;

162 
a˘i⁄
) {

163 
CPU_UP_PREPARE
:

164 
îr
 = 
	`˝uid_devi˚_¸óã
(
˝u
);

166 
CPU_UP_CANCELED
:

167 
CPU_UP_CANCELED_FROZEN
:

168 
CPU_DEAD
:

169 
	`˝uid_devi˚_de°roy
(
˝u
);

172  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

173 
	}
}

175 
nŸifõr_block
 
__ªfd©a
 
	g˝uid_˛ass_˝u_nŸifõr
 =

177 .
nŸifõr_ˇŒ
 = 
˝uid_˛ass_˝u_ˇŒback
,

180 *
	$˝uid_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

182  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/˝uid", 
	`MINOR
(
dev
->
devt
));

183 
	}
}

185 
__öô
 
	$˝uid_öô
()

187 
i
, 
îr
 = 0;

188 
i
 = 0;

190 i‡(
	`__ªgi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
,

191 "˝u/˝uid", &
˝uid_f›s
)) {

192 
	`¥ötk
(
KERN_ERR
 "cpuid: unableÅo get major %d for cpuid\n",

193 
CPUID_MAJOR
);

194 
îr
 = -
EBUSY
;

195 
out
;

197 
˝uid_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "cpuid");

198 i‡(
	`IS_ERR
(
˝uid_˛ass
)) {

199 
îr
 = 
	`PTR_ERR
(
˝uid_˛ass
);

200 
out_chrdev
;

202 
˝uid_˛ass
->
devnode
 = 
˝uid_devnode
;

203 
	`f‹_óch_⁄löe_˝u
(
i
) {

204 
îr
 = 
	`˝uid_devi˚_¸óã
(
i
);

205 i‡(
îr
 != 0)

206 
out_˛ass
;

208 
	`ªgi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

210 
îr
 = 0;

211 
out
;

213 
out_˛ass
:

214 
i
 = 0;

215 
	`f‹_óch_⁄löe_˝u
(
i
) {

216 
	`˝uid_devi˚_de°roy
(
i
);

218 
	`˛ass_de°roy
(
˝uid_˛ass
);

219 
out_chrdev
:

220 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

221 
out
:

222  
îr
;

223 
	}
}

225 
__exô
 
	$˝uid_exô
()

227 
˝u
 = 0;

229 
	`f‹_óch_⁄löe_˝u
(
˝u
)

230 
	`˝uid_devi˚_de°roy
(
˝u
);

231 
	`˛ass_de°roy
(
˝uid_˛ass
);

232 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

233 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

234 
	}
}

236 
moduÀ_öô
(
˝uid_öô
);

237 
moduÀ_exô
(
˝uid_exô
);

239 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

240 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

241 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<löux/öô.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/ªboŸ.h
>

15 
	~<löux/kexec.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/ñfc‹e.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/h¨dúq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_úq.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/h≥t.h
>

26 
	~<löux/kdebug.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ªboŸ.h
>

29 
	~<asm/vúãxt.h
>

30 
	~<asm/x86_öô.h
>

32 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

34 
	$kdump_nmi_ˇŒback
(
˝u
, 
dõ_¨gs
 *
¨gs
)

36 
±_ªgs
 *
ªgs
;

37 #ifde‡
CONFIG_X86_32


38 
±_ªgs
 
fixed_ªgs
;

41 
ªgs
 = 
¨gs
->regs;

43 #ifde‡
CONFIG_X86_32


44 i‡(!
	`u£r_mode_vm
(
ªgs
)) {

45 
	`¸ash_fixup_ss_e•
(&
fixed_ªgs
, 
ªgs
);

46 
ªgs
 = &
fixed_ªgs
;

49 
	`¸ash_ßve_˝u
(
ªgs
, 
˝u
);

57 
	`˝u_emîgícy_vmxoff
();

58 
	`˝u_emîgícy_svm_dißbÀ
();

60 
	`dißbÀ_loˇl_APIC
();

61 
	}
}

63 
	$kdump_nmi_shoŸdown_˝us
()

65 
	`nmi_shoŸdown_˝us
(
kdump_nmi_ˇŒback
);

67 
	`dißbÀ_loˇl_APIC
();

68 
	}
}

71 
	$kdump_nmi_shoŸdown_˝us
()

74 
	}
}

77 
	$«tive_machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

88 
	`loˇl_úq_dißbÀ
();

90 
	`kdump_nmi_shoŸdown_˝us
();

96 
	`˝u_emîgícy_vmxoff
();

97 
	`˝u_emîgícy_svm_dißbÀ
();

99 
	`œpic_shutdown
();

100 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

101 
	`dißbÀ_IO_APIC
();

103 #ifde‡
CONFIG_HPET_TIMER


104 
	`h≥t_dißbÀ
();

107 #ifde‡
CONFIG_X86_64


108 
x86_∂©f‹m
.
	`iommu_shutdown
();

111 
	`¸ash_ßve_˝u
(
ªgs
, 
	`ß„_smp_¥o˚ss‹_id
());

112 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/io.h
>

14 
	gñfc‹ehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$c›y_ﬁdmem_∑ge
(
p‚
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 i‡(!
csize
)

37 
vaddr
 = 
	`i‹em≠
(
p‚
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 i‡(!
vaddr
)

39  -
ENOMEM
;

41 i‡(
u£rbuf
) {

42 i‡(
	`c›y_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm≠
(
vaddr
);

44  -
EFAULT
;

47 
	`mem˝y
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm≠
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/·ø˚.h
>

14 
	~<löux/kexec.h
>

15 
	~<löux/bug.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/sysfs.h
>

19 
	~<asm/°ackåa˚.h
>

21 
	~"dump°ack.h
"

23 
	g∑nic_⁄_uƒecovîed_nmi
;

24 
	g∑nic_⁄_io_nmi
;

25 
	gcode_byãs
 = 64;

26 
	gk°ack_dïth_to_¥öt
 = 3 * 
STACKSLOTS_PER_LINE
;

27 
	gdõ_cou¡î
;

29 
	$¥ötk_addªss
(
addªss
, 
ªlübÀ
)

31 
	`¥ötk
(" [<%p>] %s%pS\n", (*Ë
addªss
,

32 
ªlübÀ
 ? "" : "? ", (*Ë
addªss
);

33 
	}
}

35 #ifde‡
CONFIG_FUNCTION_GRAPH_TRACER


37 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

38 c⁄° 
°ackåa˚_›s
 *
›s
,

39 
thªad_öfo
 *
töfo
, *
gøph
)

41 
èsk_°ru˘
 *
èsk
 = 
töfo
->task;

42 
ªt_addr
;

43 
ödex
 = 
èsk
->
cuº_ªt_°ack
;

45 i‡(
addr
 !()
ªtu∫_to_h™dÀr
)

48 i‡(!
èsk
->
ªt_°ack
 || 
ödex
 < *
gøph
)

51 
ödex
 -*
gøph
;

52 
ªt_addr
 = 
èsk
->
ªt_°ack
[
ödex
].
ªt
;

54 
›s
->
	`addªss
(
d©a
, 
ªt_addr
, 1);

56 (*
gøph
)++;

57 
	}
}

59 
ölöe
 

60 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

61 c⁄° 
°ackåa˚_›s
 *
›s
,

62 
thªad_öfo
 *
töfo
, *
gøph
)

63 { 
	}
}

73 
ölöe
 
	$vÆid_°ack_±r
(
thªad_öfo
 *
töfo
,

74 *
p
, 
size
, *
íd
)

76 *
t
 = 
töfo
;

77 i‡(
íd
) {

78 i‡(
p
 < 
íd
 &&Ö >”nd-
THREAD_SIZE
))

83  
p
 > 
t
 &&Ö <Å + 
THREAD_SIZE
 - 
size
;

84 
	}
}

87 
	$¥öt_c⁄ãxt_°ack
(
thªad_öfo
 *
töfo
,

88 *
°ack
, 
bp
,

89 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

90 *
íd
, *
gøph
)

92 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

94 
	`vÆid_°ack_±r
(
töfo
, 
°ack
, (*°ack), 
íd
)) {

95 
addr
;

97 
addr
 = *
°ack
;

98 i‡(
	`__kî√l_ãxt_addªss
(
addr
)) {

99 i‡((Ë
°ack
 =
bp
 + ()) {

100 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

101 
‰ame
 = føme->
√xt_‰ame
;

102 
bp
 = (Ë
‰ame
;

104 
›s
->
	`addªss
(
d©a
, 
addr
, 0);

106 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

108 
°ack
++;

110  
bp
;

111 
	}
}

112 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack
);

115 
	$¥öt_c⁄ãxt_°ack_bp
(
thªad_öfo
 *
töfo
,

116 *
°ack
, 
bp
,

117 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

118 *
íd
, *
gøph
)

120 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

121 *
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

123 
	`vÆid_°ack_±r
(
töfo
, 
ªt_addr
, (*ªt_addr), 
íd
)) {

124 
addr
 = *
ªt_addr
;

126 i‡(!
	`__kî√l_ãxt_addªss
(
addr
))

129 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

130 
‰ame
 = føme->
√xt_‰ame
;

131 
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

132 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

135  ()
‰ame
;

136 
	}
}

137 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack_bp
);

141 
	$¥öt_åa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

143 
	`¥ötk
(
d©a
);

144 
	`¥öt_symbﬁ
(
msg
, 
symbﬁ
);

145 
	`¥ötk
("\n");

146 
	}
}

148 
	$¥öt_åa˚_w¨nög
(*
d©a
, *
msg
)

150 
	`¥ötk
("%s%s\n", (*)
d©a
, 
msg
);

151 
	}
}

153 
	$¥öt_åa˚_°ack
(*
d©a
, *
«me
)

155 
	`¥ötk
("%†<%s> ", (*)
d©a
, 
«me
);

157 
	}
}

162 
	$¥öt_åa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

164 
	`touch_nmi_w©chdog
();

165 
	`¥ötk
(
d©a
);

166 
	`¥ötk_addªss
(
addr
, 
ªlübÀ
);

167 
	}
}

169 c⁄° 
°ackåa˚_›s
 
	g¥öt_åa˚_›s
 = {

170 .
w¨nög
 = 
¥öt_åa˚_w¨nög
,

171 .
	gw¨nög_symbﬁ
 = 
¥öt_åa˚_w¨nög_symbﬁ
,

172 .
	g°ack
 = 
¥öt_åa˚_°ack
,

173 .
	gaddªss
 = 
¥öt_åa˚_addªss
,

174 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

178 
	$show_åa˚_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

179 *
°ack
, 
bp
, *
log_lvl
)

181 
	`¥ötk
("%sCÆ»Tø˚:\n", 
log_lvl
);

182 
	`dump_åa˚
(
èsk
, 
ªgs
, 
°ack
, 
bp
, &
¥öt_åa˚_›s
, 
log_lvl
);

183 
	}
}

185 
	$show_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

186 *
°ack
, 
bp
)

188 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
°ack
, 
bp
, "");

189 
	}
}

191 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

193 
	`show_°ack_log_lvl
(
èsk
, 
NULL
, 
•
, 0, "");

194 
	}
}

199 
	$dump_°ack
()

201 
bp
 = 0;

202 
°ack
;

204 #ifde‡
CONFIG_FRAME_POINTER


205 i‡(!
bp
)

206 
	`gë_bp
(
bp
);

209 
	`¥ötk
("Pid: %d, comm: %.20s %s %s %.*s\n",

210 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

211 
	`öô_ut¢ame
()->
ªÀa£
,

212 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

213 
	`öô_ut¢ame
()->
vîsi⁄
);

214 
	`show_åa˚
(
NULL
, NULL, &
°ack
, 
bp
);

215 
	}
}

216 
EXPORT_SYMBOL
(
dump_°ack
);

218 
¨ch_•ölock_t
 
	gdõ_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

219 
	gdõ_ow√r
 = -1;

220 
	gdõ_√°_cou¡
;

222 
__k¥obes
 
	$o›s_begö
()

224 
˝u
;

225 
Êags
;

230 
	`åa˚_hw_bønch_o›s
();

232 
	`o›s_íãr
();

235 
	`øw_loˇl_úq_ßve
(
Êags
);

236 
˝u
 = 
	`smp_¥o˚ss‹_id
();

237 i‡(!
	`¨ch_•ö_åylock
(&
dõ_lock
)) {

238 i‡(
˝u
 =
dõ_ow√r
)

241 
	`¨ch_•ö_lock
(&
dõ_lock
);

243 
dõ_√°_cou¡
++;

244 
dõ_ow√r
 = 
˝u
;

245 
	`c⁄sﬁe_vîbo£
();

246 
	`bu°_•ölocks
(1);

247  
Êags
;

248 
	}
}

250 
__k¥obes
 
	$o›s_íd
(
Êags
, 
±_ªgs
 *
ªgs
, 
sigƒ
)

252 i‡(
ªgs
 && 
	`kexec_should_¸ash
(
cuºít
))

253 
	`¸ash_kexec
(
ªgs
);

255 
	`bu°_•ölocks
(0);

256 
dõ_ow√r
 = -1;

257 
	`add_èöt
(
TAINT_DIE
);

258 
dõ_√°_cou¡
--;

259 i‡(!
dõ_√°_cou¡
)

261 
	`¨ch_•ö_u∆ock
(&
dõ_lock
);

262 
	`øw_loˇl_úq_ª°‹e
(
Êags
);

263 
	`o›s_exô
();

265 i‡(!
sigƒ
)

267 i‡(
	`ö_öãºu±
())

268 
	`∑nic
("FatalÉxception in interrupt");

269 i‡(
∑nic_⁄_o›s
)

270 
	`∑nic
("FatalÉxception");

271 
	`do_exô
(
sigƒ
);

272 
	}
}

274 
__k¥obes
 
	$__dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

276 #ifde‡
CONFIG_X86_32


277 
ss
;

278 
•
;

280 
	`¥ötk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
°r
, 
îr
 & 0xffff, ++
dõ_cou¡î
);

281 #ifde‡
CONFIG_PREEMPT


282 
	`¥ötk
("PREEMPT ");

284 #ifde‡
CONFIG_SMP


285 
	`¥ötk
("SMP ");

287 #ifde‡
CONFIG_DEBUG_PAGEALLOC


288 
	`¥ötk
("DEBUG_PAGEALLOC");

290 
	`¥ötk
("\n");

291 
	`sysfs_¥ötk_œ°_fûe
();

292 i‡(
	`nŸify_dõ
(
DIE_OOPS
, 
°r
, 
ªgs
, 
îr
,

293 
cuºít
->
thªad
.
å≠_no
, 
SIGSEGV
Ë=
NOTIFY_STOP
)

296 
	`show_ªgi°îs
(
ªgs
);

297 #ifde‡
CONFIG_X86_32


298 i‡(
	`u£r_mode_vm
(
ªgs
)) {

299 
•
 = 
ªgs
->sp;

300 
ss
 = 
ªgs
->ss & 0xffff;

302 
•
 = 
	`kî√l_°ack_poöãr
(
ªgs
);

303 
	`ßve£gmít
(
ss
, ss);

305 
	`¥ötk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
ªgs
->
ù
);

306 
	`¥öt_symbﬁ
("%s", 
ªgs
->
ù
);

307 
	`¥ötk
(" SS:ESP %04x:%08lx\n", 
ss
, 
•
);

310 
	`¥ötk
(
KERN_ALERT
 "RIP ");

311 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

312 
	`¥ötk
(" RSP <%016lx>\n", 
ªgs
->
•
);

315 
	}
}

321 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

323 
Êags
 = 
	`o›s_begö
();

324 
sig
 = 
SIGSEGV
;

326 i‡(!
	`u£r_mode_vm
(
ªgs
))

327 
	`ªp‹t_bug
(
ªgs
->
ù
,Ñegs);

329 i‡(
	`__dõ
(
°r
, 
ªgs
, 
îr
))

330 
sig
 = 0;

331 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

332 
	}
}

334 
nŸø˚
 
__k¥obes


335 
	$dõ_nmi
(*
°r
, 
±_ªgs
 *
ªgs
, 
do_∑nic
)

337 
Êags
;

339 i‡(
	`nŸify_dõ
(
DIE_NMIWATCHDOG
, 
°r
, 
ªgs
, 0, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

346 
Êags
 = 
	`o›s_begö
();

347 
	`¥ötk
(
KERN_EMERG
 "%s", 
°r
);

348 
	`¥ötk
(" on CPU%d, ip %08lx,Ñegisters:\n",

349 
	`smp_¥o˚ss‹_id
(), 
ªgs
->
ù
);

350 
	`show_ªgi°îs
(
ªgs
);

351 
	`o›s_íd
(
Êags
, 
ªgs
, 0);

352 i‡(
do_∑nic
 || 
∑nic_⁄_o›s
)

353 
	`∑nic
("Non maskable interrupt");

354 
	`nmi_exô
();

355 
	`loˇl_úq_íabÀ
();

356 
	`do_exô
(
SIGBUS
);

357 
	}
}

359 
__öô
 
	$o›s_£tup
(*
s
)

361 i‡(!
s
)

362  -
EINVAL
;

363 i‡(!
	`°rcmp
(
s
, "panic"))

364 
∑nic_⁄_o›s
 = 1;

366 
	}
}

367 
óæy_∑øm
("o›s", 
o›s_£tup
);

369 
__öô
 
	$k°ack_£tup
(*
s
)

371 i‡(!
s
)

372  -
EINVAL
;

373 
k°ack_dïth_to_¥öt
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

375 
	}
}

376 
óæy_∑øm
("k°ack", 
k°ack_£tup
);

378 
__öô
 
	$code_byãs_£tup
(*
s
)

380 
code_byãs
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

381 i‡(
code_byãs
 > 8192)

382 
code_byãs
 = 8192;

385 
	}
}

386 
__£tup
("code_byãs=", 
code_byãs_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/h¨dúq.h
>

9 
	~<löux/kdebug.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/±ø˚.h
>

12 
	~<löux/kexec.h
>

13 
	~<löux/sysfs.h
>

14 
	~<löux/bug.h
>

15 
	~<löux/nmi.h
>

17 
	~<asm/°ackåa˚.h
>

19 
	~"dump°ack.h
"

21 
	#N_EXCEPTION_STACKS_END
 \

22 (
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
/
EXCEPTION_STKSZ
 - 2)

	)

24 
	gx86_°ack_ids
[][8] = {

25 [ 
DEBUG_STACK
-1 ] = "#DB",

26 [ 
NMI_STACK
-1 ] = "NMI",

27 [ 
DOUBLEFAULT_STACK
-1 ] = "#DF",

28 [ 
STACKFAULT_STACK
-1 ] = "#SS",

29 [ 
MCE_STACK
-1 ] = "#MC",

30 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


31 [ 
N_EXCEPTION_STACKS
 ...

32 
N_EXCEPTION_STACKS_END
 ] = "#DB[?]"

36 
	$x86_is_°ack_id
(
id
, *
«me
)

38  
x86_°ack_ids
[
id
 - 1] =
«me
;

39 
	}
}

41 *
	$ö_ex˚±i⁄_°ack
(
˝u
, 
°ack
,

42 *
u£dp
, **
idp
)

44 
k
;

50 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

51 
íd
 = 
	`≥r_˝u
(
‹ig_i°
, 
˝u
).
i°
[
k
];

56 i‡(
°ack
 >
íd
)

62 i‡(
°ack
 >
íd
 - 
EXCEPTION_STKSZ
) {

69 i‡(*
u£dp
 & (1U << 
k
))

71 *
u£dp
 |1U << 
k
;

72 *
idp
 = 
x86_°ack_ids
[
k
];

73  (*)
íd
;

80 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


81 i‡(
k
 =
DEBUG_STACK
 - 1 && 
°ack
 >
íd
 - 
DEBUG_STKSZ
) {

82 
j
 = 
N_EXCEPTION_STACKS
 - 1;

90 ++
j
;

91 
íd
 -
EXCEPTION_STKSZ
;

92 
x86_°ack_ids
[
j
][4] = '1' +

93 (
j
 - 
N_EXCEPTION_STACKS
);

94 } 
°ack
 < 
íd
 - 
EXCEPTION_STKSZ
);

95 i‡(*
u£dp
 & (1U << 
j
))

97 *
u£dp
 |1U << 
j
;

98 *
idp
 = 
x86_°ack_ids
[
j
];

99  (*)
íd
;

103  
NULL
;

104 
	}
}

106 
ölöe
 

107 
	$ö_úq_°ack
(*
°ack
, *
úq_°ack
,

108 *
úq_°ack_íd
)

110  (
°ack
 >
úq_°ack
 && sèck < 
úq_°ack_íd
);

111 
	}
}

122 
ölöe
 

123 
	$fixup_bp_úq_lök
(
bp
, *
°ack
,

124 *
úq_°ack
, *
úq_°ack_íd
)

126 #ifde‡
CONFIG_FRAME_POINTER


127 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

129 i‡(!
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
))

130  ()
‰ame
->
√xt_‰ame
;

132  
bp
;

133 
	}
}

142 
	$dump_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

143 *
°ack
, 
bp
,

144 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
)

146 c⁄° 
˝u
 = 
	`gë_˝u
();

147 *
úq_°ack_íd
 =

148 (*)
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
);

149 
u£d
 = 0;

150 
thªad_öfo
 *
töfo
;

151 
gøph
 = 0;

153 i‡(!
èsk
)

154 
èsk
 = 
cuºít
;

156 i‡(!
°ack
) {

157 
dummy
;

158 
°ack
 = &
dummy
;

159 i‡(
èsk
 &&Åask !
cuºít
)

160 
°ack
 = (*)
èsk
->
thªad
.
•
;

163 #ifde‡
CONFIG_FRAME_POINTER


164 i‡(!
bp
) {

165 i‡(
èsk
 =
cuºít
) {

167 
	`gë_bp
(
bp
);

170 
bp
 = *(*Ë
èsk
->
thªad
.
•
;

180 
töfo
 = 
	`èsk_thªad_öfo
(
èsk
);

182 *
id
;

183 *
e°ack_íd
;

184 
e°ack_íd
 = 
	`ö_ex˚±i⁄_°ack
(
˝u
, ()
°ack
,

185 &
u£d
, &
id
);

187 i‡(
e°ack_íd
) {

188 i‡(
›s
->
	`°ack
(
d©a
, 
id
) < 0)

191 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp, ops,

192 
d©a
, 
e°ack_íd
, &
gøph
);

193 
›s
->
	`°ack
(
d©a
, "<EOE>");

199 
°ack
 = (*Ë
e°ack_íd
[-2];

202 i‡(
úq_°ack_íd
) {

203 *
úq_°ack
;

204 
úq_°ack
 = 
úq_°ack_íd
 -

205 (
IRQ_STACK_SIZE
 - 64Ë/ (*
úq_°ack
);

207 i‡(
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
)) {

208 i‡(
›s
->
	`°ack
(
d©a
, "IRQ") < 0)

210 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp,

211 
›s
, 
d©a
, 
úq_°ack_íd
, &
gøph
);

217 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

218 
bp
 = 
	`fixup_bp_úq_lök
(bp, 
°ack
, 
úq_°ack
,

219 
úq_°ack_íd
);

220 
úq_°ack_íd
 = 
NULL
;

221 
›s
->
	`°ack
(
d©a
, "EOI");

231 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp, 
›s
, 
d©a
, 
NULL
, &
gøph
);

232 
	`put_˝u
();

233 
	}
}

234 
EXPORT_SYMBOL
(
dump_åa˚
);

237 
	$show_°ack_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

238 *
•
, 
bp
, *
log_lvl
)

240 *
úq_°ack_íd
;

241 *
úq_°ack
;

242 *
°ack
;

243 
˝u
;

244 
i
;

246 
	`¥ìm±_dißbÀ
();

247 
˝u
 = 
	`smp_¥o˚ss‹_id
();

249 
úq_°ack_íd
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
));

250 
úq_°ack
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
Ë- 
IRQ_STACK_SIZE
);

256 i‡(
•
 =
NULL
) {

257 i‡(
èsk
)

258 
•
 = (*)
èsk
->
thªad
.sp;

260 
•
 = (*)&sp;

263 
°ack
 = 
•
;

264 
i
 = 0; i < 
k°ack_dïth_to_¥öt
; i++) {

265 i‡(
°ack
 >
úq_°ack
 && sèck <
úq_°ack_íd
) {

266 i‡(
°ack
 =
úq_°ack_íd
) {

267 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

268 
	`¥ötk
(" <EOI> ");

271 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

274 i‡(
i
 && ((ò% 
STACKSLOTS_PER_LINE
) == 0))

275 
	`¥ötk
("\n%s", 
log_lvl
);

276 
	`¥ötk
(" %016lx", *
°ack
++);

277 
	`touch_nmi_w©chdog
();

279 
	`¥ìm±_íabÀ
();

281 
	`¥ötk
("\n");

282 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
•
, 
bp
, 
log_lvl
);

283 
	}
}

285 
	$show_ªgi°îs
(
±_ªgs
 *
ªgs
)

287 
i
;

288 
•
;

289 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

290 
èsk_°ru˘
 *
cur
 = 
cuºít
;

292 
•
 = 
ªgs
->sp;

293 
	`¥ötk
("CPU %d ", 
˝u
);

294 
	`__show_ªgs
(
ªgs
, 1);

295 
	`¥ötk
("Process %s (pid: %d,Åhreadinfo %p,Åask %p)\n",

296 
cur
->
comm
, cur->
pid
, 
	`èsk_thªad_öfo
(cur), cur);

302 i‡(!
	`u£r_mode
(
ªgs
)) {

303 
code_¥ﬁogue
 = 
code_byãs
 * 43 / 64;

304 
code_Àn
 = 
code_byãs
;

305 
c
;

306 
u8
 *
ù
;

308 
	`¥ötk
(
KERN_EMERG
 "Stack:\n");

309 
	`show_°ack_log_lvl
(
NULL
, 
ªgs
, (*)
•
,

310 
ªgs
->
bp
, 
KERN_EMERG
);

312 
	`¥ötk
(
KERN_EMERG
 "Code: ");

314 
ù
 = (
u8
 *)
ªgs
->ù - 
code_¥ﬁogue
;

315 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 || 
	`¥obe_kî√l_addªss
(ù, 
c
)) {

317 
ù
 = (
u8
 *)
ªgs
->ip;

318 
code_Àn
 = code_À¿- 
code_¥ﬁogue
 + 1;

320 
i
 = 0; i < 
code_Àn
; i++, 
ù
++) {

321 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 ||

322 
	`¥obe_kî√l_addªss
(
ù
, 
c
)) {

323 
	`¥ötk
(" Bad RIP value.");

326 i‡(
ù
 =(
u8
 *)
ªgs
->ip)

327 
	`¥ötk
("<%02x> ", 
c
);

329 
	`¥ötk
("%02x ", 
c
);

332 
	`¥ötk
("\n");

333 
	}
}

335 
	$is_vÆid_bugaddr
(
ù
)

337 
ud2
;

339 i‡(
	`__c›y_‰om_u£r
(&
ud2
, (c⁄° 
__u£r
 *Ë
ù
, (ud2)))

342  
ud2
 == 0x0b0f;

343 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/boŸmem.h
>

15 
	~<löux/i›‹t.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/kexec.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/p‚.h
>

21 
	~<löux/su•íd.h
>

22 
	~<löux/fúmw¨e-m≠.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/∑ge.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/¥Ÿo.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/åampﬁöe.h
>

45 
e820m≠
 
	ge820
;

46 
e820m≠
 
	ge820_ßved
;

49 
	gpci_mem_°¨t
 = 0xaeedbabe;

50 #ifde‡
CONFIG_PCI


51 
EXPORT_SYMBOL
(
pci_mem_°¨t
);

59 
	$e820_™y_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

61 
i
;

63 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

64 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

66 i‡(
ty≥
 && 
ei
->type !=Åype)

68 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

73 
	}
}

74 
EXPORT_SYMBOL_GPL
(
e820_™y_m≠≥d
);

82 
__öô
 
	$e820_Æl_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

84 
i
;

86 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

87 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

89 i‡(
ty≥
 && 
ei
->type !=Åype)

92 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

98 i‡(
ei
->
addr
 <
°¨t
)

99 
°¨t
 = 
ei
->
addr
 +Éi->
size
;

104 i‡(
°¨t
 >
íd
)

108 
	}
}

113 
__öô
 
	$__e820_add_ªgi⁄
(
e820m≠
 *
e820x
, 
u64
 
°¨t
, u64 
size
,

114 
ty≥
)

116 
x
 = 
e820x
->
ƒ_m≠
;

118 i‡(
x
 >
	`ARRAY_SIZE
(
e820x
->
m≠
)) {

119 
	`¥ötk
(
KERN_ERR
 "Ooops! Too manyÉntries inÅhe memory map!\n");

123 
e820x
->
m≠
[
x
].
addr
 = 
°¨t
;

124 
e820x
->
m≠
[
x
].
size
 = size;

125 
e820x
->
m≠
[
x
].
ty≥
 =Åype;

126 
e820x
->
ƒ_m≠
++;

127 
	}
}

129 
__öô
 
	$e820_add_ªgi⁄
(
u64
 
°¨t
, u64 
size
, 
ty≥
)

131 
	`__e820_add_ªgi⁄
(&
e820
, 
°¨t
, 
size
, 
ty≥
);

132 
	}
}

134 
__öô
 
	$e820_¥öt_ty≥
(
u32
 
ty≥
)

136 
ty≥
) {

137 
E820_RAM
:

138 
E820_RESERVED_KERN
:

139 
	`¥ötk
(
KERN_CONT
 "(usable)");

141 
E820_RESERVED
:

142 
	`¥ötk
(
KERN_CONT
 "(reserved)");

144 
E820_ACPI
:

145 
	`¥ötk
(
KERN_CONT
 "(ACPI data)");

147 
E820_NVS
:

148 
	`¥ötk
(
KERN_CONT
 "(ACPI NVS)");

150 
E820_UNUSABLE
:

151 
	`¥ötk
(
KERN_CONT
 "(unusable)");

154 
	`¥ötk
(
KERN_CONT
 "ty≥ %u", 
ty≥
);

157 
	}
}

159 
__öô
 
	$e820_¥öt_m≠
(*
who
)

161 
i
;

163 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

164 
	`¥ötk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

165 (Ë
e820
.
m≠
[
i
].
addr
,

167 (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
));

168 
	`e820_¥öt_ty≥
(
e820
.
m≠
[
i
].
ty≥
);

169 
	`¥ötk
(
KERN_CONT
 "\n");

171 
	}
}

235 
__öô
 
	$ßnôize_e820_m≠
(
e820íåy
 *
biosm≠
, 
max_ƒ_m≠
,

236 
u32
 *
≤r_m≠
)

238 
	sch™ge_membî
 {

239 
e820íåy
 *
pbios
;

240 
addr
;

242 
ch™ge_membî
 
ch™ge_poöt_li°
[2*
E820_X_MAX
] 
__öôd©a
;

243 
ch™ge_membî
 *
ch™ge_poöt
[2*
E820_X_MAX
] 
__öôd©a
;

244 
e820íåy
 *
ovîœp_li°
[
E820_X_MAX
] 
__öôd©a
;

245 
e820íåy
 
√w_bios
[
E820_X_MAX
] 
__öôd©a
;

246 
ch™ge_membî
 *
ch™ge_tmp
;

247 
cuºít_ty≥
, 
œ°_ty≥
;

248 
œ°_addr
;

249 
chgidx
, 
°ûl_ch™gög
;

250 
ovîœp_íåõs
;

251 
√w_bios_íåy
;

252 
ﬁd_ƒ
, 
√w_ƒ
, 
chg_ƒ
;

253 
i
;

256 i‡(*
≤r_m≠
 < 2)

259 
ﬁd_ƒ
 = *
≤r_m≠
;

260 
	`BUG_ON
(
ﬁd_ƒ
 > 
max_ƒ_m≠
);

263 
i
 = 0; i < 
ﬁd_ƒ
; i++)

264 i‡(
biosm≠
[
i
].
addr
 + biosm≠[i].
size
 < biosmap[i].addr)

268 
i
 = 0; i < 2 * 
ﬁd_ƒ
; i++)

269 
ch™ge_poöt
[
i
] = &
ch™ge_poöt_li°
[i];

273 
chgidx
 = 0;

274 
i
 = 0; i < 
ﬁd_ƒ
; i++) {

275 i‡(
biosm≠
[
i
].
size
 != 0) {

276 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr;

277 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

278 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr +

279 
biosm≠
[
i
].
size
;

280 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

283 
chg_ƒ
 = 
chgidx
;

286 
°ûl_ch™gög
 = 1;

287 
°ûl_ch™gög
) {

288 
°ûl_ch™gög
 = 0;

289 
i
 = 1; i < 
chg_ƒ
; i++) {

290 
cuøddr
, 
œ°addr
;

291 
cuΩbaddr
, 
œ°pbaddr
;

293 
cuøddr
 = 
ch™ge_poöt
[
i
]->
addr
;

294 
œ°addr
 = 
ch™ge_poöt
[
i
 - 1]->
addr
;

295 
cuΩbaddr
 = 
ch™ge_poöt
[
i
]->
pbios
->
addr
;

296 
œ°pbaddr
 = 
ch™ge_poöt
[
i
 - 1]->
pbios
->
addr
;

305 i‡(
cuøddr
 < 
œ°addr
 ||

306 (
cuøddr
 =
œ°addr
 && cuødd∏=
cuΩbaddr
 &&

307 
œ°addr
 !
œ°pbaddr
)) {

308 
ch™ge_tmp
 = 
ch™ge_poöt
[
i
];

309 
ch™ge_poöt
[
i
] = change_point[i-1];

310 
ch™ge_poöt
[
i
-1] = 
ch™ge_tmp
;

311 
°ûl_ch™gög
 = 1;

317 
ovîœp_íåõs
 = 0;

318 
√w_bios_íåy
 = 0;

319 
œ°_ty≥
 = 0;

320 
œ°_addr
 = 0;

323 
chgidx
 = 0; chgidx < 
chg_ƒ
; chgidx++) {

325 i‡(
ch™ge_poöt
[
chgidx
]->
addr
 ==

326 
ch™ge_poöt
[
chgidx
]->
pbios
->
addr
) {

331 
ovîœp_li°
[
ovîœp_íåõs
++] =

332 
ch™ge_poöt
[
chgidx
]->
pbios
;

338 
i
 = 0; i < 
ovîœp_íåõs
; i++) {

339 i‡(
ovîœp_li°
[
i
] ==

340 
ch™ge_poöt
[
chgidx
]->
pbios
)

341 
ovîœp_li°
[
i
] =

342 
ovîœp_li°
[
ovîœp_íåõs
-1];

344 
ovîœp_íåõs
--;

351 
cuºít_ty≥
 = 0;

352 
i
 = 0; i < 
ovîœp_íåõs
; i++)

353 i‡(
ovîœp_li°
[
i
]->
ty≥
 > 
cuºít_ty≥
)

354 
cuºít_ty≥
 = 
ovîœp_li°
[
i
]->
ty≥
;

359 i‡(
cuºít_ty≥
 !
œ°_ty≥
) {

360 i‡(
œ°_ty≥
 != 0) {

361 
√w_bios
[
√w_bios_íåy
].
size
 =

362 
ch™ge_poöt
[
chgidx
]->
addr
 - 
œ°_addr
;

367 i‡(
√w_bios
[
√w_bios_íåy
].
size
 != 0)

372 i‡(++
√w_bios_íåy
 >
max_ƒ_m≠
)

375 i‡(
cuºít_ty≥
 != 0) {

376 
√w_bios
[
√w_bios_íåy
].
addr
 =

377 
ch™ge_poöt
[
chgidx
]->
addr
;

378 
√w_bios
[
√w_bios_íåy
].
ty≥
 = 
cuºít_ty≥
;

379 
œ°_addr
 = 
ch™ge_poöt
[
chgidx
]->
addr
;

381 
œ°_ty≥
 = 
cuºít_ty≥
;

385 
√w_ƒ
 = 
√w_bios_íåy
;

388 
	`mem˝y
(
biosm≠
, 
√w_bios
, 
√w_ƒ
 * (
e820íåy
));

389 *
≤r_m≠
 = 
√w_ƒ
;

392 
	}
}

394 
__öô
 
	$__≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

396 
ƒ_m≠
) {

397 
u64
 
°¨t
 = 
biosm≠
->
addr
;

398 
u64
 
size
 = 
biosm≠
->size;

399 
u64
 
íd
 = 
°¨t
 + 
size
;

400 
u32
 
ty≥
 = 
biosm≠
->type;

403 i‡(
°¨t
 > 
íd
)

406 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
ty≥
);

408 
biosm≠
++;

409 
ƒ_m≠
--;

412 
	}
}

423 
__öô
 
	$≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

426 i‡(
ƒ_m≠
 < 2)

429  
	`__≠≥nd_e820_m≠
(
biosm≠
, 
ƒ_m≠
);

430 
	}
}

432 
u64
 
__öô
 
	$__e820_upd©e_ønge
(
e820m≠
 *
e820x
, 
u64
 
°¨t
,

433 
u64
 
size
, 
ﬁd_ty≥
,

434 
√w_ty≥
)

436 
u64
 
íd
;

437 
i
;

438 
u64
 
ªÆ_upd©ed_size
 = 0;

440 
	`BUG_ON
(
ﬁd_ty≥
 =
√w_ty≥
);

442 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

443 
size
 = 
ULLONG_MAX
 - 
°¨t
;

445 
íd
 = 
°¨t
 + 
size
;

446 
	`¥ötk
(
KERN_DEBUG
 "e820 updateÑange: %016Lx - %016Lx ",

447 (Ë
°¨t
,

448 (Ë
íd
);

449 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

450 
	`¥ötk
(
KERN_CONT
 " ==> ");

451 
	`e820_¥öt_ty≥
(
√w_ty≥
);

452 
	`¥ötk
(
KERN_CONT
 "\n");

454 
i
 = 0; i < 
e820x
->
ƒ_m≠
; i++) {

455 
e820íåy
 *
ei
 = &
e820x
->
m≠
[
i
];

456 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

457 
u64
 
ei_íd
;

459 i‡(
ei
->
ty≥
 !
ﬁd_ty≥
)

462 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

464 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

465 
ei
->
ty≥
 = 
√w_ty≥
;

466 
ªÆ_upd©ed_size
 +
ei
->
size
;

471 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

472 
	`__e820_add_ªgi⁄
(
e820x
, 
°¨t
, 
size
, 
√w_ty≥
);

473 
	`__e820_add_ªgi⁄
(
e820x
, 
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

474 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

475 
ªÆ_upd©ed_size
 +
size
;

480 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

481 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

482 i‡(
föÆ_°¨t
 >
föÆ_íd
)

485 
	`__e820_add_ªgi⁄
(
e820x
, 
föÆ_°¨t
, 
föÆ_íd
 - final_start,

486 
√w_ty≥
);

488 
ªÆ_upd©ed_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

494 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

495 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

497 
ei
->
addr
 = 
föÆ_íd
;

499  
ªÆ_upd©ed_size
;

500 
	}
}

502 
u64
 
__öô
 
	$e820_upd©e_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

503 
√w_ty≥
)

505  
	`__e820_upd©e_ønge
(&
e820
, 
°¨t
, 
size
, 
ﬁd_ty≥
, 
√w_ty≥
);

506 
	}
}

508 
u64
 
__öô
 
	$e820_upd©e_ønge_ßved
(
u64
 
°¨t
, u64 
size
,

509 
ﬁd_ty≥
, 
√w_ty≥
)

511  
	`__e820_upd©e_ønge
(&
e820_ßved
, 
°¨t
, 
size
, 
ﬁd_ty≥
,

512 
√w_ty≥
);

513 
	}
}

516 
u64
 
__öô
 
	$e820_ªmove_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

517 
checkty≥
)

519 
i
;

520 
u64
 
ªÆ_ªmoved_size
 = 0;

522 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

523 
size
 = 
ULLONG_MAX
 - 
°¨t
;

525 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

526 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

527 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

529 i‡(
checkty≥
 && 
ei
->
ty≥
 !
ﬁd_ty≥
)

532 i‡(
ei
->
addr
 >
°¨t
 &&

533 (
ei
->
addr
 +Éi->
size
Ë<(
°¨t
 + size)) {

534 
ªÆ_ªmoved_size
 +
ei
->
size
;

535 
	`mem£t
(
ei
, 0, (
e820íåy
));

539 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

540 
föÆ_íd
 = 
	`mö
(
°¨t
 + 
size
, 
ei
->
addr
 +Éi->size);

541 i‡(
föÆ_°¨t
 >
föÆ_íd
)

543 
ªÆ_ªmoved_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

545 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

546 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

548 
ei
->
addr
 = 
föÆ_íd
;

550  
ªÆ_ªmoved_size
;

551 
	}
}

553 
__öô
 
	$upd©e_e820
()

555 
u32
 
ƒ_m≠
;

557 
ƒ_m≠
 = 
e820
.nr_map;

558 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ_m≠
))

560 
e820
.
ƒ_m≠
 =Çr_map;

561 
	`¥ötk
(
KERN_INFO
 "modifiedÖhysical RAM map:\n");

562 
	`e820_¥öt_m≠
("modified");

563 
	}
}

564 
__öô
 
	$upd©e_e820_ßved
()

566 
u32
 
ƒ_m≠
;

568 
ƒ_m≠
 = 
e820_ßved
.nr_map;

569 i‡(
	`ßnôize_e820_m≠
(
e820_ßved
.
m≠
, 
	`ARRAY_SIZE
”820_ßved.m≠), &
ƒ_m≠
))

571 
e820_ßved
.
ƒ_m≠
 =Çr_map;

572 
	}
}

573 
	#MAX_GAP_END
 0x100000000uŒ

	)

577 
__öô
 
	$e820_£¨ch_g≠
(*
g≠°¨t
, *
g≠size
,

578 
°¨t_addr
, 
íd_addr
)

580 
œ°
;

581 
i
 = 
e820
.
ƒ_m≠
;

582 
found
 = 0;

584 
œ°
 = (
íd_addr
 &&Énd_add∏< 
MAX_GAP_END
) ?Énd_addr : MAX_GAP_END;

586 --
i
 >= 0) {

587 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

588 
íd
 = 
°¨t
 + 
e820
.
m≠
[
i
].
size
;

590 i‡(
íd
 < 
°¨t_addr
)

597 i‡(
œ°
 > 
íd
) {

598 
g≠
 = 
œ°
 - 
íd
;

600 i‡(
g≠
 >*
g≠size
) {

601 *
g≠size
 = 
g≠
;

602 *
g≠°¨t
 = 
íd
;

603 
found
 = 1;

606 i‡(
°¨t
 < 
œ°
)

607 
œ°
 = 
°¨t
;

609  
found
;

610 
	}
}

618 
__öô
 
	$e820_£tup_g≠
()

620 
g≠°¨t
, 
g≠size
;

621 
found
;

623 
g≠°¨t
 = 0x10000000;

624 
g≠size
 = 0x400000;

625 
found
 = 
	`e820_£¨ch_g≠
(&
g≠°¨t
, &
g≠size
, 0, 
MAX_GAP_END
);

627 #ifde‡
CONFIG_X86_64


628 i‡(!
found
) {

629 
g≠°¨t
 = (
max_p‚
 << 
PAGE_SHIFT
) + 1024*1024;

630 
	`¥ötk
(
KERN_ERR


639 
pci_mem_°¨t
 = 
g≠°¨t
;

641 
	`¥ötk
(
KERN_INFO


643 
pci_mem_°¨t
, 
g≠°¨t
, 
g≠size
);

644 
	}
}

652 
__öô
 
	$∑r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
∑_d©a
)

654 
u32
 
m≠_Àn
;

655 
íåõs
;

656 
e820íåy
 *
extm≠
;

658 
íåõs
 = 
sd©a
->
Àn
 / (
e820íåy
);

659 
m≠_Àn
 = 
sd©a
->
Àn
 + (
£tup_d©a
);

660 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

661 
sd©a
 = 
	`óæy_i‹em≠
(
∑_d©a
, 
m≠_Àn
);

662 
extm≠
 = (
e820íåy
 *)(
sd©a
->
d©a
);

663 
	`__≠≥nd_e820_m≠
(
extm≠
, 
íåõs
);

664 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

665 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

666 
	`óæy_iounm≠
(
sd©a
, 
m≠_Àn
);

667 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

668 
	`e820_¥öt_m≠
("extended");

669 
	}
}

671 #i‡
deföed
(
CONFIG_X86_64
) || \

672 (
deföed
(
CONFIG_X86_32
Ë&& 
	$deföed
(
CONFIG_HIBERNATION
))

681 
__öô
 
	$e820_m¨k_noßve_ªgi⁄s
(
limô_p‚
)

683 
i
;

684 
p‚
;

686 
p‚
 = 
	`PFN_DOWN
(
e820
.
m≠
[0].
addr
 +É820.m≠[0].
size
);

687 
i
 = 1; i < 
e820
.
ƒ_m≠
; i++) {

688 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

690 i‡(
p‚
 < 
	`PFN_UP
(
ei
->
addr
))

691 
	`ªgi°î_noßve_ªgi⁄
(
p‚
, 
	`PFN_UP
(
ei
->
addr
));

693 
p‚
 = 
	`PFN_DOWN
(
ei
->
addr
 +Éi->
size
);

694 i‡(
ei
->
ty≥
 !
E820_RAM
 &&Éi->ty≥ !
E820_RESERVED_KERN
)

695 
	`ªgi°î_noßve_ªgi⁄
(
	`PFN_UP
(
ei
->
addr
), 
p‚
);

697 i‡(
p‚
 >
limô_p‚
)

700 
	}
}

703 #ifde‡
CONFIG_HIBERNATION


708 
__öô
 
	$e820_m¨k_nvs_mem‹y
()

710 
i
;

712 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

713 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

715 i‡(
ei
->
ty≥
 =
E820_NVS
)

716 
	`hibî«ã_nvs_ªgi°î
(
ei
->
addr
,Éi->
size
);

720 
	}
}

721 
c‹e_öôˇŒ
(
e820_m¨k_nvs_mem‹y
);

727 
	#MAX_EARLY_RES
 32

	)

729 
	sóæy_ªs
 {

730 
u64
 
	m°¨t
, 
	míd
;

731 
	m«me
[16];

732 
	movîœp_ok
;

734 
óæy_ªs
 
	góæy_ªs
[
MAX_EARLY_RES
] 
	g__öôd©a
 = {

735 { 0, 
PAGE_SIZE
, "BIOS dataÖage", 1 },

736 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_X86_TRAMPOLINE
)

742 { 
PAGE_SIZE
, PAGE_SIZE + PAGE_SIZE, "EX TRAMPOLINE", 1 },

748 
__öô
 
	$föd_ovîœµed_óæy
(
u64
 
°¨t
, u64 
íd
)

750 
i
;

751 
óæy_ªs
 *
r
;

753 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

754 
r
 = &
óæy_ªs
[
i
];

755 i‡(
íd
 > 
r
->
°¨t
 && start <Ñ->end)

759  
i
;

760 
	}
}

767 
__öô
 
	$dr›_ønge
(
i
)

769 
j
;

771 
j
 = 
i
 + 1; j < 
MAX_EARLY_RES
 && 
óæy_ªs
[j].
íd
; j++)

774 
	`memmove
(&
óæy_ªs
[
i
], &early_res[i + 1],

775 (
j
 - 1 - 
i
Ë* (
óæy_ªs
));

777 
óæy_ªs
[
j
 - 1].
íd
 = 0;

778 
	}
}

790 
__öô
 
	$dr›_ovîœps_th©_¨e_ok
(
u64
 
°¨t
, u64 
íd
)

792 
i
;

793 
óæy_ªs
 *
r
;

794 
u64
 
lowî_°¨t
, 
lowî_íd
;

795 
u64
 
uµî_°¨t
, 
uµî_íd
;

796 
«me
[16];

798 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

799 
r
 = &
óæy_ªs
[
i
];

802 i‡(
íd
 <
r
->
°¨t
 || start >=Ñ->end)

810 i‡(!
r
->
ovîœp_ok
)

821 
	`°∫˝y
(
«me
, 
r
->name, (name) - 1);

823 
lowî_°¨t
 = 
lowî_íd
 = 0;

824 
uµî_°¨t
 = 
uµî_íd
 = 0;

825 i‡(
r
->
°¨t
 < start) {

826 
lowî_°¨t
 = 
r
->
°¨t
;

827 
lowî_íd
 = 
°¨t
;

829 i‡(
r
->
íd
 >Énd) {

830 
uµî_°¨t
 = 
íd
;

831 
uµî_íd
 = 
r
->
íd
;

835 
	`dr›_ønge
(
i
);

837 
i
--;

840 i‡(
lowî_íd
)

841 
	`ª£rve_óæy_ovîœp_ok
(
lowî_°¨t
, 
lowî_íd
, 
«me
);

842 i‡(
uµî_íd
)

843 
	`ª£rve_óæy_ovîœp_ok
(
uµî_°¨t
, 
uµî_íd
, 
«me
);

845 
	}
}

847 
__öô
 
	$__ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
,

848 
ovîœp_ok
)

850 
i
;

851 
óæy_ªs
 *
r
;

853 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

854 i‡(
i
 >
MAX_EARLY_RES
)

855 
	`∑nic
("Too manyÉarlyÑeservations");

856 
r
 = &
óæy_ªs
[
i
];

857 i‡(
r
->
íd
)

858 
	`∑nic
("OverlappingÉarlyÑeservations "

860 
°¨t
, 
íd
 - 1, 
«me
?«me:"", 
r
->start,

861 
r
->
íd
 - 1,Ñ->
«me
);

862 
r
->
°¨t
 = start;

863 
r
->
íd
 =Énd;

864 
r
->
ovîœp_ok
 = overlap_ok;

865 i‡(
«me
)

866 
	`°∫˝y
(
r
->
«me
,Çame, (r->name) - 1);

867 
	}
}

889 
__öô
 
	$ª£rve_óæy_ovîœp_ok
(
u64
 
°¨t
, u64 
íd
, *
«me
)

891 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

892 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 1);

893 
	}
}

903 
__öô
 
	$ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
)

905 i‡(
°¨t
 >
íd
)

908 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

909 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 0);

910 
	}
}

912 
__öô
 
	$‰ì_óæy
(
u64
 
°¨t
, u64 
íd
)

914 
óæy_ªs
 *
r
;

915 
i
;

917 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

918 
r
 = &
óæy_ªs
[
i
];

919 i‡(
i
 >
MAX_EARLY_RES
 || 
r
->
íd
 !íd ||Ñ->
°¨t
 != start)

920 
	`∑nic
("free_early onÇotÑeservedárea: %llx-%llx!",

921 
°¨t
, 
íd
 - 1);

923 
	`dr›_ønge
(
i
);

924 
	}
}

926 
__öô
 
	$óæy_ªs_to_boŸmem
(
u64
 
°¨t
, u64 
íd
)

928 
i
, 
cou¡
;

929 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

931 
cou¡
 = 0;

932 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++)

933 
cou¡
++;

935 
	`¥ötk
(
KERN_INFO
 "(%dÉarlyÑeservations) ==> bootmem [%010llx - %010llx]\n",

936 
cou¡
, 
°¨t
, 
íd
);

937 
i
 = 0; i < 
cou¡
; i++) {

938 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

939 
	`¥ötk
(
KERN_INFO
 " #%d [%010Œx - %010Œx] %16s", 
i
,

940 
r
->
°¨t
,Ñ->
íd
,Ñ->
«me
);

941 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
r
->start);

942 
föÆ_íd
 = 
	`mö
(
íd
, 
r
->end);

943 i‡(
föÆ_°¨t
 >
föÆ_íd
) {

944 
	`¥ötk
(
KERN_CONT
 "\n");

947 
	`¥ötk
(
KERN_CONT
 " ==> [%010llx - %010llx]\n",

948 
föÆ_°¨t
, 
föÆ_íd
);

949 
	`ª£rve_boŸmem_gíîic
(
föÆ_°¨t
, 
föÆ_íd
 - final_start,

950 
BOOTMEM_DEFAULT
);

952 
	}
}

955 
ölöe
 
__öô
 
	$bad_addr
(
u64
 *
addΩ
, u64 
size
, u64 
Æign
)

957 
i
;

958 
u64
 
addr
 = *
addΩ
;

959 
ch™ged
 = 0;

960 
óæy_ªs
 *
r
;

961 
agaö
:

962 
i
 = 
	`föd_ovîœµed_óæy
(
addr
,ádd∏+ 
size
);

963 
r
 = &
óæy_ªs
[
i
];

964 i‡(
i
 < 
MAX_EARLY_RES
 && 
r
->
íd
) {

965 *
addΩ
 = 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

966 
ch™ged
 = 1;

967 
agaö
;

969  
ch™ged
;

970 
	}
}

973 
ölöe
 
__öô
 
	$bad_addr_size
(
u64
 *
addΩ
, u64 *
sizï
, u64 
Æign
)

975 
i
;

976 
u64
 
addr
 = *
addΩ
, 
œ°
;

977 
u64
 
size
 = *
sizï
;

978 
ch™ged
 = 0;

979 
agaö
:

980 
œ°
 = 
addr
 + 
size
;

981 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

982 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

983 i‡(
œ°
 > 
r
->
°¨t
 && 
addr
 <Ñ->start) {

984 
size
 = 
r
->
°¨t
 - 
addr
;

985 
ch™ged
 = 1;

986 
agaö
;

988 i‡(
œ°
 > 
r
->
íd
 && 
addr
 <Ñ->end) {

989 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

990 
size
 = 
œ°
 - 
addr
;

991 
ch™ged
 = 1;

992 
agaö
;

994 i‡(
œ°
 <
r
->
íd
 && 
addr
 >r->
°¨t
) {

995 (*
sizï
)++;

999 i‡(
ch™ged
) {

1000 *
addΩ
 = 
addr
;

1001 *
sizï
 = 
size
;

1003  
ch™ged
;

1004 
	}
}

1009 
u64
 
__öô
 
	$föd_e820_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

1011 
i
;

1013 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1014 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1015 
u64
 
addr
, 
œ°
;

1016 
u64
 
ei_œ°
;

1018 i‡(
ei
->
ty≥
 !
E820_RAM
)

1020 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1021 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1022 i‡(
addr
 < 
°¨t
)

1023 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1024 i‡(
addr
 >
ei_œ°
)

1026 
	`bad_addr
(&
addr
, 
size
, 
Æign
Ë&&áddr+sizê<
ei_œ°
)

1028 
œ°
 = 
addr
 + 
size
;

1029 i‡(
œ°
 > 
ei_œ°
)

1031 i‡(
œ°
 > 
íd
)

1033  
addr
;

1036 
	}
}

1041 
u64
 
__öô
 
	$föd_e820_¨ó_size
(
u64
 
°¨t
, u64 *
sizï
, u64 
Æign
)

1043 
i
;

1045 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1046 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1047 
u64
 
addr
, 
œ°
;

1048 
u64
 
ei_œ°
;

1050 i‡(
ei
->
ty≥
 !
E820_RAM
)

1052 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1053 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1054 i‡(
addr
 < 
°¨t
)

1055 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1056 i‡(
addr
 >
ei_œ°
)

1058 *
sizï
 = 
ei_œ°
 - 
addr
;

1059 
	`bad_addr_size
(&
addr
, 
sizï
, 
Æign
) &&

1060 
addr
 + *
sizï
 <
ei_œ°
)

1062 
œ°
 = 
addr
 + *
sizï
;

1063 i‡(
œ°
 > 
ei_œ°
)

1065  
addr
;

1069 
	}
}

1074 
u64
 
__öô
 
	$óæy_ª£rve_e820
(
u64
 
°¨â
, u64 
sizë
, u64 
Æign
)

1076 
u64
 
size
 = 0;

1077 
u64
 
addr
;

1078 
u64
 
°¨t
;

1080 
°¨t
 = 
°¨â
; ; sèπ +
size
) {

1081 
°¨t
 = 
	`föd_e820_¨ó_size
(°¨t, &
size
, 
Æign
);

1082 i‡(!(
°¨t
 + 1))

1084 i‡(
size
 >
sizë
)

1088 #ifde‡
CONFIG_X86_32


1089 i‡(
°¨t
 >
MAXMEM
)

1091 i‡(
°¨t
 + 
size
 > 
MAXMEM
)

1092 
size
 = 
MAXMEM
 - 
°¨t
;

1095 
addr
 = 
	`round_down
(
°¨t
 + 
size
 - 
sizë
, 
Æign
);

1096 i‡(
addr
 < 
°¨t
)

1098 
	`e820_upd©e_ønge
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1099 
	`e820_upd©e_ønge_ßved
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1100 
	`¥ötk
(
KERN_INFO
 "updateÉ820 forÉarly_reserve_e820\n");

1101 
	`upd©e_e820
();

1102 
	`upd©e_e820_ßved
();

1104  
addr
;

1105 
	}
}

1107 #ifde‡
CONFIG_X86_32


1108 #ifde‡
CONFIG_X86_PAE


1109 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

1111 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

1114 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

1120 
__öô
 
	$e820_íd_p‚
(
limô_p‚
, 
ty≥
)

1122 
i
;

1123 
œ°_p‚
 = 0;

1124 
max_¨ch_p‚
 = 
MAX_ARCH_PFN
;

1126 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1127 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1128 
°¨t_p‚
;

1129 
íd_p‚
;

1131 i‡(
ei
->
ty≥
 !=Åype)

1134 
°¨t_p‚
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

1135 
íd_p‚
 = (
ei
->
addr
 +Éi->
size
Ë>> 
PAGE_SHIFT
;

1137 i‡(
°¨t_p‚
 >
limô_p‚
)

1139 i‡(
íd_p‚
 > 
limô_p‚
) {

1140 
œ°_p‚
 = 
limô_p‚
;

1143 i‡(
íd_p‚
 > 
œ°_p‚
)

1144 
œ°_p‚
 = 
íd_p‚
;

1147 i‡(
œ°_p‚
 > 
max_¨ch_p‚
)

1148 
œ°_p‚
 = 
max_¨ch_p‚
;

1150 
	`¥ötk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

1151 
œ°_p‚
, 
max_¨ch_p‚
);

1152  
œ°_p‚
;

1153 
	}
}

1154 
__öô
 
	$e820_íd_of_øm_p‚
()

1156  
	`e820_íd_p‚
(
MAX_ARCH_PFN
, 
E820_RAM
);

1157 
	}
}

1159 
__öô
 
	$e820_íd_of_low_øm_p‚
()

1161  
	`e820_íd_p‚
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

1162 
	}
}

1167 
__öô
 
	$e820_föd_a˘ive_ªgi⁄
(c⁄° 
e820íåy
 *
ei
,

1168 
°¨t_p‚
,

1169 
œ°_p‚
,

1170 *
ei_°¨ç‚
,

1171 *
ei_ídp‚
)

1173 
u64
 
Æign
 = 
PAGE_SIZE
;

1175 *
ei_°¨ç‚
 = 
	`round_up
(
ei
->
addr
, 
Æign
Ë>> 
PAGE_SHIFT
;

1176 *
ei_ídp‚
 = 
	`round_down
(
ei
->
addr
 +Éi->
size
, 
Æign
Ë>> 
PAGE_SHIFT
;

1179 i‡(*
ei_°¨ç‚
 >*
ei_ídp‚
)

1183 i‡(
ei
->
ty≥
 !
E820_RAM
 || *
ei_ídp‚
 <
°¨t_p‚
 ||

1184 *
ei_°¨ç‚
 >
œ°_p‚
)

1188 i‡(*
ei_°¨ç‚
 < 
°¨t_p‚
)

1189 *
ei_°¨ç‚
 = 
°¨t_p‚
;

1190 i‡(*
ei_ídp‚
 > 
œ°_p‚
)

1191 *
ei_ídp‚
 = 
œ°_p‚
;

1194 
	}
}

1197 
__öô
 
	$e820_ªgi°î_a˘ive_ªgi⁄s
(
nid
, 
°¨t_p‚
,

1198 
œ°_p‚
)

1200 
ei_°¨ç‚
;

1201 
ei_ídp‚
;

1202 
i
;

1204 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++)

1205 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1206 
°¨t_p‚
, 
œ°_p‚
,

1207 &
ei_°¨ç‚
, &
ei_ídp‚
))

1208 
	`add_a˘ive_ønge
(
nid
, 
ei_°¨ç‚
, 
ei_ídp‚
);

1209 
	}
}

1216 
u64
 
__öô
 
	$e820_hﬁe_size
(
u64
 
°¨t
, u64 
íd
)

1218 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

1219 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

1220 
ei_°¨ç‚
, 
ei_ídp‚
, 
øm
 = 0;

1221 
i
;

1223 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1224 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1225 
°¨t_p‚
, 
œ°_p‚
,

1226 &
ei_°¨ç‚
, &
ei_ídp‚
))

1227 
øm
 +
ei_ídp‚
 - 
ei_°¨ç‚
;

1229  
íd
 - 
°¨t
 - ((
u64
)
øm
 << 
PAGE_SHIFT
);

1230 
	}
}

1232 
	$óæy_∑nic
(*
msg
)

1234 
	`óæy_¥ötk
(
msg
);

1235 
	`∑nic
(
msg
);

1236 
	}
}

1238 
u£rdef
 
	g__öôd©a
;

1241 
__öô
 
	$∑r£_mem›t
(*
p
)

1243 
u64
 
mem_size
;

1245 i‡(!
p
)

1246  -
EINVAL
;

1248 #ifde‡
CONFIG_X86_32


1249 i‡(!
	`°rcmp
(
p
, "nopentium")) {

1250 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_PSE
);

1255 
u£rdef
 = 1;

1256 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1257 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1260 
	}
}

1261 
óæy_∑øm
("mem", 
∑r£_mem›t
);

1263 
__öô
 
	$∑r£_memm≠_›t
(*
p
)

1265 *
ﬁdp
;

1266 
u64
 
°¨t_©
, 
mem_size
;

1268 i‡(!
p
)

1269  -
EINVAL
;

1271 i‡(!
	`°∫cmp
(
p
, "exactmap", 8)) {

1272 #ifde‡
CONFIG_CRASH_DUMP


1278 
ßved_max_p‚
 = 
	`e820_íd_of_øm_p‚
();

1280 
e820
.
ƒ_m≠
 = 0;

1281 
u£rdef
 = 1;

1285 
ﬁdp
 = 
p
;

1286 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1287 i‡(
p
 =
ﬁdp
)

1288  -
EINVAL
;

1290 
u£rdef
 = 1;

1291 i‡(*
p
 == '@') {

1292 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1293 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RAM
);

1294 } i‡(*
p
 == '#') {

1295 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1296 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_ACPI
);

1297 } i‡(*
p
 == '$') {

1298 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1299 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RESERVED
);

1301 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1303  *
p
 ='\0' ? 0 : -
EINVAL
;

1304 
	}
}

1305 
óæy_∑øm
("memm≠", 
∑r£_memm≠_›t
);

1307 
__öô
 
	$föish_e820_∑rsög
()

1309 i‡(
u£rdef
) {

1310 
u32
 
ƒ
 = 
e820
.
ƒ_m≠
;

1312 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ
) < 0)

1313 
	`óæy_∑nic
("Invalid user supplied memory map");

1314 
e820
.
ƒ_m≠
 = 
ƒ
;

1316 
	`¥ötk
(
KERN_INFO
 "user-definedÖhysical RAM map:\n");

1317 
	`e820_¥öt_m≠
("user");

1319 
	}
}

1321 
ölöe
 c⁄° *
	$e820_ty≥_to_°rög
(
e820_ty≥
)

1323 
e820_ty≥
) {

1324 
E820_RESERVED_KERN
:

1325 
E820_RAM
:  "System RAM";

1326 
E820_ACPI
:  "ACPI Tables";

1327 
E820_NVS
:  "ACPI Non-volatile Storage";

1328 
E820_UNUSABLE
:  "Unusable memory";

1331 
	}
}

1336 
ªsour˚
 
__öôd©a
 *
	ge820_ªs
;

1337 
__öô
 
	$e820_ª£rve_ªsour˚s
()

1339 
i
;

1340 
ªsour˚
 *
ªs
;

1341 
u64
 
íd
;

1343 
ªs
 = 
	`Æloc_boŸmem
((
ªsour˚
Ë* 
e820
.
ƒ_m≠
);

1344 
e820_ªs
 = 
ªs
;

1345 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1346 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
 - 1;

1347 i‡(
íd
 !(
ªsour˚_size_t
)end) {

1348 
ªs
++;

1351 
ªs
->
«me
 = 
	`e820_ty≥_to_°rög
(
e820
.
m≠
[
i
].
ty≥
);

1352 
ªs
->
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

1353 
ªs
->
íd
 =Énd;

1355 
ªs
->
Êags
 = 
IORESOURCE_MEM
;

1362 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RESERVED
 || 
ªs
->
°¨t
 < (1ULL<<20)) {

1363 
ªs
->
Êags
 |
IORESOURCE_BUSY
;

1364 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

1366 
ªs
++;

1369 
i
 = 0; i < 
e820_ßved
.
ƒ_m≠
; i++) {

1370 
e820íåy
 *
íåy
 = &
e820_ßved
.
m≠
[
i
];

1371 
	`fúmw¨e_m≠_add_óæy
(
íåy
->
addr
,

1372 
íåy
->
addr
 +É¡ry->
size
 - 1,

1373 
	`e820_ty≥_to_°rög
(
íåy
->
ty≥
));

1375 
	}
}

1378 
	$øm_Æignmít
(
ªsour˚_size_t
 
pos
)

1380 
mb
 = 
pos
 >> 20;

1383 i‡(!
mb
)

1387 i‡(
mb
 < 16)

1392 
	}
}

1394 
	#MAX_RESOURCE_SIZE
 ((
ªsour˚_size_t
)-1)

	)

1396 
__öô
 
	$e820_ª£rve_ªsour˚s_œã
()

1398 
i
;

1399 
ªsour˚
 *
ªs
;

1401 
ªs
 = 
e820_ªs
;

1402 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1403 i‡(!
ªs
->
∑ª¡
 &&Ñes->
íd
)

1404 
	`ö£π_ªsour˚_ex∑nd_to_fô
(&
iomem_ªsour˚
, 
ªs
);

1405 
ªs
++;

1412 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1413 
e820íåy
 *
íåy
 = &
e820
.
m≠
[
i
];

1414 
u64
 
°¨t
, 
íd
;

1416 i‡(
íåy
->
ty≥
 !
E820_RAM
)

1418 
°¨t
 = 
íåy
->
addr
 +É¡ry->
size
;

1419 
íd
 = 
	`round_up
(
°¨t
, 
	`øm_Æignmít
(start)) - 1;

1420 i‡(
íd
 > 
MAX_RESOURCE_SIZE
)

1421 
íd
 = 
MAX_RESOURCE_SIZE
;

1422 i‡(
°¨t
 >
íd
)

1424 
	`ª£rve_ªgi⁄_wôh_•lô
(&
iomem_ªsour˚
, 
°¨t
, 
íd
,

1427 
	}
}

1429 *
__öô
 
	$deÁu…_machöe_•ecific_mem‹y_£tup
()

1431 *
who
 = "BIOS-e820";

1432 
u32
 
√w_ƒ
;

1439 
√w_ƒ
 = 
boŸ_∑øms
.
e820_íåõs
;

1440 
	`ßnôize_e820_m≠
(
boŸ_∑øms
.
e820_m≠
,

1441 
	`ARRAY_SIZE
(
boŸ_∑øms
.
e820_m≠
),

1442 &
√w_ƒ
);

1443 
boŸ_∑øms
.
e820_íåõs
 = 
√w_ƒ
;

1444 i‡(
	`≠≥nd_e820_m≠
(
boŸ_∑øms
.
e820_m≠
, boŸ_∑øms.
e820_íåõs
)

1446 
u64
 
mem_size
;

1449 i‡(
boŸ_∑øms
.
Æt_mem_k


1450 < 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
) {

1451 
mem_size
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
;

1452 
who
 = "BIOS-88";

1454 
mem_size
 = 
boŸ_∑øms
.
Æt_mem_k
;

1455 
who
 = "BIOS-e801";

1458 
e820
.
ƒ_m≠
 = 0;

1459 
	`e820_add_ªgi⁄
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1460 
	`e820_add_ªgi⁄
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1464  
who
;

1465 
	}
}

1467 
__öô
 
	$£tup_mem‹y_m≠
()

1469 *
who
;

1471 
who
 = 
x86_öô
.
ªsour˚s
.
	`mem‹y_£tup
();

1472 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

1473 
	`¥ötk
(
KERN_INFO
 "BIOS-providedÖhysical RAM map:\n");

1474 
	`e820_¥öt_m≠
(
who
);

1475 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<löux/pci.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/pci_ids.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_≠ic.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¨t.h
>

22 
__öô
 
	$fix_hy≥πøn•‹t_c⁄fig
(
num
, 
¶Ÿ
, 
func
)

24 
u32
 
htcfg
;

31 
htcfg
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68);

32 i‡(
htcfg
 & (1 << 18)) {

33 
	`¥ötk
(
KERN_INFO
 "Detected use ofÉxtendedápic ids "

35 i‡((
htcfg
 & (1 << 17)) == 0) {

36 
	`¥ötk
(
KERN_INFO
 "Enabling hypertransportÉxtended "

38 
	`¥ötk
(
KERN_INFO
 "NoteÅhis isá bios bug, "

40 
htcfg
 |= (1 << 17);

41 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68, 
htcfg
);

46 
	}
}

48 
__öô
 
	$vü_bugs
(
num
, 
¶Ÿ
, 
func
)

50 #ifde‡
CONFIG_GART_IOMMU


51 i‡((
max_p‚
 > 
MAX_DMA32_PFN
 || 
f‹˚_iommu
) &&

52 !
g¨t_iommu_≠îtuª_Ælowed
) {

53 
	`¥ötk
(
KERN_INFO


56 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

59 
	}
}

61 #ifde‡
CONFIG_ACPI


62 #ifde‡
CONFIG_X86_IO_APIC


64 
__öô
 
	$nvidü_h≥t_check
(
a˝i_èbÀ_hódî
 *
hódî
)

67 
	}
}

71 
__öô
 
	$nvidü_bugs
(
num
, 
¶Ÿ
, 
func
)

73 #ifde‡
CONFIG_ACPI


74 #ifde‡
CONFIG_X86_IO_APIC


82 i‡(
a˝i_u£_timî_ovîride
)

85 i‡(
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
nvidü_h≥t_check
)) {

86 
a˝i_skù_timî_ovîride
 = 1;

87 
	`¥ötk
(
KERN_INFO
 "Nvidia board "

90 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

97 
	}
}

99 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

100 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

101 
u32
 
__öô
 
	$©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
)

103 
u32
 
d
;

104 
u8
 
b
;

106 
b
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac);

107 
b
 &= ~(1<<5);

108 
	`wrôe_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac, 
b
);

110 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

111 
d
 |= 1<<8;

112 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

114 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

115 
d
 &= 0xff;

116  
d
;

117 
	}
}

120 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

122 
u32
 
d
;

123 
u8
 
b
;

125 i‡(
a˝i_u£_timî_ovîride
)

128 
d
 = 
	`©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
);

129 i‡(
d
 < 0x82)

130 
a˝i_skù_timî_ovîride
 = 1;

133 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

134 i‡(!(
b
 & 0x2))

135 
a˝i_skù_timî_ovîride
 = 1;

138 i‡(
a˝i_skù_timî_ovîride
) {

139 
	`¥ötk
(
KERN_INFO
 "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

140 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

141 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

144 
	}
}

146 
u32
 
__öô
 
	$©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
)

148 
u32
 
ﬁd
, 
d
;

150 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

151 
ﬁd
 = 
d
;

152 
d
 &= ~(1<<8);

153 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

154 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

155 
d
 &= 0xff;

156 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
ﬁd
);

158  
d
;

159 
	}
}

161 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

163 
u32
 
d
, 
ªv
;

165 i‡(
a˝i_u£_timî_ovîride
)

168 
ªv
 = 
	`©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
);

169 i‡(
ªv
 > 0x13)

173 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x64);

174 i‡(!(
d
 & (1<<14)))

175 
a˝i_skù_timî_ovîride
 = 1;

177 i‡(
a˝i_skù_timî_ovîride
) {

178 
	`¥ötk
(
KERN_INFO
 "SB600Ñevisi⁄ 0x%x\n", 
ªv
);

179 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

180 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

183 
	}
}

185 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

187 
	}
}

189 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

191 
	}
}

194 
	#QFLAG_APPLY_ONCE
 0x1

	)

195 
	#QFLAG_APPLIED
 0x2

	)

196 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

197 
	schù£t
 {

198 
u32
 
	mvíd‹
;

199 
u32
 
	mdevi˚
;

200 
u32
 
	m˛ass
;

201 
u32
 
	m˛ass_mask
;

202 
u32
 
	mÊags
;

203 (*
	mf
)(
	mnum
, 
	m¶Ÿ
, 
	mfunc
);

212 
chù£t
 
	góæy_qrk
[] 
	g__öôd©a
 = {

213 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

214 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidü_bugs
 },

215 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

216 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vü_bugs
 },

217 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

218 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy≥πøn•‹t_c⁄fig
 },

219 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

220 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

221 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

222 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_c⁄td
 },

237 
__öô
 
	$check_dev_quúk
(
num
, 
¶Ÿ
, 
func
)

239 
u16
 
˛ass
;

240 
u16
 
víd‹
;

241 
u16
 
devi˚
;

242 
u8
 
ty≥
;

243 
i
;

245 
˛ass
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_CLASS_DEVICE
);

247 i‡(
˛ass
 == 0xffff)

250 
víd‹
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_VENDOR_ID
);

252 
devi˚
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_DEVICE_ID
);

254 
i
 = 0; 
óæy_qrk
[i].
f
 !
NULL
; i++) {

255 i‡(((
óæy_qrk
[
i
].
víd‹
 =
PCI_ANY_ID
) ||

256 (
óæy_qrk
[
i
].
víd‹
 == vendor)) &&

257 ((
óæy_qrk
[
i
].
devi˚
 =
PCI_ANY_ID
) ||

258 (
óæy_qrk
[
i
].
devi˚
 == device)) &&

259 (!((
óæy_qrk
[
i
].
˛ass
 ^ class) &

260 
óæy_qrk
[
i
].
˛ass_mask
))) {

261 i‡((
óæy_qrk
[
i
].
Êags
 &

262 
QFLAG_DONE
) != QFLAG_DONE)

263 
óæy_qrk
[
i
].
	`f
(
num
, 
¶Ÿ
, 
func
);

264 
óæy_qrk
[
i
].
Êags
 |
QFLAG_APPLIED
;

268 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

269 
PCI_HEADER_TYPE
);

270 i‡(!(
ty≥
 & 0x80))

274 
	}
}

276 
__öô
 
	$óæy_quúks
()

278 
¶Ÿ
, 
func
;

280 i‡(!
	`óæy_pci_Ælowed
())

285 
¶Ÿ
 = 0; slot < 32; slot++)

286 
func
 = 0; func < 8; func++) {

288 i‡(
	`check_dev_quúk
(0, 
¶Ÿ
, 
func
))

291 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<löux/c⁄sﬁe.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/s¸ìn_öfo.h
>

6 
	~<löux/usb/ch9.h
>

7 
	~<löux/pci_ªgs.h
>

8 
	~<löux/pci_ids.h
>

9 
	~<löux/î∫o.h
>

10 
	~<asm/io.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/f˙é.h
>

13 
	~<asm/£tup.h
>

14 
	~<xí/hvc-c⁄sﬁe.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/fixm≠.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<löux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcuºít_ypos
 = 25, 
	gcuºít_xpos
;

26 
	$óæy_vga_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
°r
++Ë!'\0' && 
n
-- > 0) {

32 i‡(
cuºít_ypos
 >
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wrôew
(
	`ªadw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wrôew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cuºít_ypos
 = 
max_ypos
-1;

44 i‡(
c
 == '\n') {

45 
cuºít_xpos
 = 0;

46 
cuºít_ypos
++;

47 } i‡(
c
 != '\r') {

48 
	`wrôew
(((0x7 << 8Ë| (Ë
c
),

49 
VGABASE
 + 2*(
max_xpos
*
cuºít_ypos
 +

50 
cuºít_xpos
++));

51 i‡(
cuºít_xpos
 >
max_xpos
) {

52 
cuºít_xpos
 = 0;

53 
cuºít_ypos
++;

57 
	}
}

59 
c⁄sﬁe
 
	góæy_vga_c⁄sﬁe
 = {

60 .
«me
 = "earlyvga",

61 .
	gwrôe
 = 
óæy_vga_wrôe
,

62 .
	gÊags
 = 
CON_PRINTBUFFER
,

63 .
	gödex
 = -1,

68 
	góæy_£rül_ba£
 = 0x3f8;

70 
	#XMTRDY
 0x20

	)

72 
	#DLAB
 0x80

	)

74 
	#TXR
 0

	)

75 
	#RXR
 0

	)

76 
	#IER
 1

	)

77 
	#IIR
 2

	)

78 
	#FCR
 2

	)

79 
	#LCR
 3

	)

80 
	#MCR
 4

	)

81 
	#LSR
 5

	)

82 
	#MSR
 6

	)

83 
	#DLL
 0

	)

84 
	#DLH
 1

	)

86 
	$óæy_£rül_putc
(
ch
)

88 
timeout
 = 0xffff;

90 (
	`öb
(
óæy_£rül_ba£
 + 
LSR
Ë& 
XMTRDY
Ë=0 && --
timeout
)

91 
	`˝u_ªœx
();

92 
	`outb
(
ch
, 
óæy_£rül_ba£
 + 
TXR
);

93  
timeout
 ? 0 : -1;

94 
	}
}

96 
	$óæy_£rül_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
s
, 
n
)

98 *
s
 && 
n
-- > 0) {

99 i‡(*
s
 == '\n')

100 
	`óæy_£rül_putc
('\r');

101 
	`óæy_£rül_putc
(*
s
);

102 
s
++;

104 
	}
}

106 
	#DEFAULT_BAUD
 9600

	)

108 
__öô
 
	$óæy_£rül_öô
(*
s
)

110 
c
;

111 
divis‹
;

112 
baud
 = 
DEFAULT_BAUD
;

113 *
e
;

115 i‡(*
s
 == ',')

116 ++
s
;

118 i‡(*
s
) {

119 
p‹t
;

120 i‡(!
	`°∫cmp
(
s
, "0x", 2)) {

121 
óæy_£rül_ba£
 = 
	`sim∂e_°πoul
(
s
, &
e
, 16);

123 c⁄° 
__öôc⁄°
 
ba£s
[] = { 0x3f8, 0x2f8 };

125 i‡(!
	`°∫cmp
(
s
, "ttyS", 4))

126 
s
 += 4;

127 
p‹t
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

128 i‡(
p‹t
 > 1 || 
s
 =
e
)

129 
p‹t
 = 0;

130 
óæy_£rül_ba£
 = 
ba£s
[
p‹t
];

132 
s
 +
	`°rc•n
(s, ",");

133 i‡(*
s
 == ',')

134 
s
++;

137 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
LCR
);

138 
	`outb
(0, 
óæy_£rül_ba£
 + 
IER
);

139 
	`outb
(0, 
óæy_£rül_ba£
 + 
FCR
);

140 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
MCR
);

142 i‡(*
s
) {

143 
baud
 = 
	`sim∂e_°πoul
(
s
, &
e
, 0);

144 i‡(
baud
 =0 || 
s
 =
e
)

145 
baud
 = 
DEFAULT_BAUD
;

148 
divis‹
 = 115200 / 
baud
;

149 
c
 = 
	`öb
(
óæy_£rül_ba£
 + 
LCR
);

150 
	`outb
(
c
 | 
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

151 
	`outb
(
divis‹
 & 0xff, 
óæy_£rül_ba£
 + 
DLL
);

152 
	`outb
((
divis‹
 >> 8Ë& 0xff, 
óæy_£rül_ba£
 + 
DLH
);

153 
	`outb
(
c
 & ~
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

154 
	}
}

156 
c⁄sﬁe
 
	góæy_£rül_c⁄sﬁe
 = {

157 .
«me
 = "earlyser",

158 .
	gwrôe
 = 
óæy_£rül_wrôe
,

159 .
	gÊags
 = 
CON_PRINTBUFFER
,

160 .
	gödex
 = -1,

164 
c⁄sﬁe
 *
	góæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

165 
__öôd©a
 
	góæy_c⁄sﬁe_öôülized
;

167 
asmlökage
 
	$óæy_¥ötk
(c⁄° *
fmt
, ...)

169 
buf
[512];

170 
n
;

171 
va_li°
 
≠
;

173 
	`va_°¨t
(
≠
, 
fmt
);

174 
n
 = 
	`vs˙¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

175 
óæy_c⁄sﬁe
->
	`wrôe
”¨ly_c⁄sﬁe, 
buf
, 
n
);

176 
	`va_íd
(
≠
);

177 
	}
}

179 
ölöe
 
	$óæy_c⁄sﬁe_ªgi°î
(
c⁄sﬁe
 *
c⁄
, 
kìp_óæy
)

181 i‡(
óæy_c⁄sﬁe
->
ödex
 != -1) {

182 
	`¥ötk
(
KERN_CRIT
 "ERROR:Éarlyprintk= %sálready used\n",

183 
c⁄
->
«me
);

186 
óæy_c⁄sﬁe
 = 
c⁄
;

187 i‡(
kìp_óæy
)

188 
óæy_c⁄sﬁe
->
Êags
 &~
CON_BOOT
;

190 
óæy_c⁄sﬁe
->
Êags
 |
CON_BOOT
;

191 
	`ªgi°î_c⁄sﬁe
(
óæy_c⁄sﬁe
);

192 
	}
}

194 
__öô
 
	$£tup_óæy_¥ötk
(*
buf
)

196 
kìp
;

198 i‡(!
buf
)

201 i‡(
óæy_c⁄sﬁe_öôülized
)

203 
óæy_c⁄sﬁe_öôülized
 = 1;

205 
kìp
 = (
	`°r°r
(
buf
, "kìp"Ë!
NULL
);

207 *
buf
 != '\0') {

208 i‡(!
	`°∫cmp
(
buf
, "serial", 6)) {

209 
buf
 += 6;

210 
	`óæy_£rül_öô
(
buf
);

211 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

212 i‡(!
	`°∫cmp
(
buf
, ",ttyS", 5))

213 
buf
 += 5;

215 i‡(!
	`°∫cmp
(
buf
, "ttyS", 4)) {

216 
	`óæy_£rül_öô
(
buf
 + 4);

217 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

219 i‡(!
	`°∫cmp
(
buf
, "vga", 3) &&

220 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_isVGA
 == 1) {

221 
max_xpos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_cﬁs
;

222 
max_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_löes
;

223 
cuºít_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_y
;

224 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_vga_c⁄sﬁe
, 
kìp
);

226 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


227 i‡(!
	`°∫cmp
(
buf
, "dbgp", 4Ë&& !
	`óæy_dbgp_öô
(buf + 4))

228 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_dbgp_c⁄sﬁe
, 
kìp
);

230 #ifde‡
CONFIG_HVC_XEN


231 i‡(!
	`°∫cmp
(
buf
, "xen", 3))

232 
	`óæy_c⁄sﬁe_ªgi°î
(&
xíboŸ_c⁄sﬁe
, 
kìp
);

234 
buf
++;

237 
	}
}

239 
óæy_∑øm
("óæy¥ötk", 
£tup_óæy_¥ötk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/efi.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/•ölock.h
>

34 
	~<löux/uac˚ss.h
>

35 
	~<löux/time.h
>

36 
	~<löux/io.h
>

37 
	~<löux/ªboŸ.h
>

38 
	~<löux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ˇcheÊush.h
>

44 
	~<asm/ébÊush.h
>

45 
	~<asm/x86_öô.h
>

47 
	#EFI_DEBUG
 1

	)

48 
	#PFX
 "EFI: "

	)

50 
	gefi_íabÀd
;

51 
EXPORT_SYMBOL
(
efi_íabÀd
);

53 
efi
 
	gefi
;

54 
EXPORT_SYMBOL
(
efi
);

56 
efi_mem‹y_m≠
 
	gmemm≠
;

58 
efi
 
efi_phys
 
	g__öôd©a
;

59 
efi_sy°em_èbÀ_t
 
efi_sy°ab
 
	g__öôd©a
;

61 
__öô
 
	$£tup_n€fi
(*
¨g
)

63 
efi_íabÀd
 = 0;

65 
	}
}

66 
óæy_∑øm
("n€fi", 
£tup_n€fi
);

68 
	gadd_efi_memm≠
;

69 
EXPORT_SYMBOL
(
add_efi_memm≠
);

71 
__öô
 
	$£tup_add_efi_memm≠
(*
¨g
)

73 
add_efi_memm≠
 = 1;

75 
	}
}

76 
óæy_∑øm
("add_efi_memm≠", 
£tup_add_efi_memm≠
);

79 
efi_°©us_t
 
	$vút_efi_gë_time
(
efi_time_t
 *
tm
, 
efi_time_ˇp_t
 *
tc
)

81  
	`efi_ˇŒ_vút2
(
gë_time
, 
tm
, 
tc
);

82 
	}
}

84 
efi_°©us_t
 
	$vút_efi_£t_time
(
efi_time_t
 *
tm
)

86  
	`efi_ˇŒ_vút1
(
£t_time
, 
tm
);

87 
	}
}

89 
efi_°©us_t
 
	$vút_efi_gë_wakeup_time
(
efi_boﬁ_t
 *
íabÀd
,

90 
efi_boﬁ_t
 *
≥ndög
,

91 
efi_time_t
 *
tm
)

93  
	`efi_ˇŒ_vút3
(
gë_wakeup_time
,

94 
íabÀd
, 
≥ndög
, 
tm
);

95 
	}
}

97 
efi_°©us_t
 
	$vút_efi_£t_wakeup_time
(
efi_boﬁ_t
 
íabÀd
, 
efi_time_t
 *
tm
)

99  
	`efi_ˇŒ_vút2
(
£t_wakeup_time
,

100 
íabÀd
, 
tm
);

101 
	}
}

103 
efi_°©us_t
 
	$vút_efi_gë_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

104 
efi_guid_t
 *
víd‹
,

105 
u32
 *
©å
,

106 *
d©a_size
,

107 *
d©a
)

109  
	`efi_ˇŒ_vút5
(
gë_v¨übÀ
,

110 
«me
, 
víd‹
, 
©å
,

111 
d©a_size
, 
d©a
);

112 
	}
}

114 
efi_°©us_t
 
	$vút_efi_gë_√xt_v¨übÀ
(*
«me_size
,

115 
efi_ch¨16_t
 *
«me
,

116 
efi_guid_t
 *
víd‹
)

118  
	`efi_ˇŒ_vút3
(
gë_√xt_v¨übÀ
,

119 
«me_size
, 
«me
, 
víd‹
);

120 
	}
}

122 
efi_°©us_t
 
	$vút_efi_£t_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

123 
efi_guid_t
 *
víd‹
,

124 
©å
,

125 
d©a_size
,

126 *
d©a
)

128  
	`efi_ˇŒ_vút5
(
£t_v¨übÀ
,

129 
«me
, 
víd‹
, 
©å
,

130 
d©a_size
, 
d©a
);

131 
	}
}

133 
efi_°©us_t
 
	$vút_efi_gë_√xt_high_m⁄o_cou¡
(
u32
 *
cou¡
)

135  
	`efi_ˇŒ_vút1
(
gë_√xt_high_m⁄o_cou¡
, 
cou¡
);

136 
	}
}

138 
	$vút_efi_ª£t_sy°em
(
ª£t_ty≥
,

139 
efi_°©us_t
 
°©us
,

140 
d©a_size
,

141 
efi_ch¨16_t
 *
d©a
)

143 
	`efi_ˇŒ_vút4
(
ª£t_sy°em
, 
ª£t_ty≥
, 
°©us
,

144 
d©a_size
, 
d©a
);

145 
	}
}

147 
efi_°©us_t
 
	$vút_efi_£t_vútuÆ_addªss_m≠
(

148 
mem‹y_m≠_size
,

149 
des¸ùt‹_size
,

150 
u32
 
des¸ùt‹_vîsi⁄
,

151 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

153  
	`efi_ˇŒ_vút4
(
£t_vútuÆ_addªss_m≠
,

154 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

155 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

156 
	}
}

158 
efi_°©us_t
 
__öô
 
	$phys_efi_£t_vútuÆ_addªss_m≠
(

159 
mem‹y_m≠_size
,

160 
des¸ùt‹_size
,

161 
u32
 
des¸ùt‹_vîsi⁄
,

162 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

164 
efi_°©us_t
 
°©us
;

166 
	`efi_ˇŒ_phys_¥ñog
();

167 
°©us
 = 
	`efi_ˇŒ_phys4
(
efi_phys
.
£t_vútuÆ_addªss_m≠
,

168 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

169 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

170 
	`efi_ˇŒ_phys_ïûog
();

171  
°©us
;

172 
	}
}

174 
efi_°©us_t
 
__öô
 
	$phys_efi_gë_time
(
efi_time_t
 *
tm
,

175 
efi_time_ˇp_t
 *
tc
)

177 
efi_°©us_t
 
°©us
;

179 
	`efi_ˇŒ_phys_¥ñog
();

180 
°©us
 = 
	`efi_ˇŒ_phys2
(
efi_phys
.
gë_time
, 
tm
, 
tc
);

181 
	`efi_ˇŒ_phys_ïûog
();

182  
°©us
;

183 
	}
}

185 
	$efi_£t_πc_mmss
(
nowtime
)

187 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
;

188 
efi_°©us_t
 
°©us
;

189 
efi_time_t
 
e·
;

190 
efi_time_ˇp_t
 
ˇp
;

192 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

193 i‡(
°©us
 !
EFI_SUCCESS
) {

194 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

198 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

199 
ªÆ_möuãs
 = 
nowtime
 / 60;

200 i‡(((
	`abs
(
ªÆ_möuãs
 - 
e·
.
möuã
) + 15)/30) & 1)

201 
ªÆ_möuãs
 += 30;

202 
ªÆ_möuãs
 %= 60;

203 
e·
.
möuã
 = 
ªÆ_möuãs
;

204 
e·
.
£c⁄d
 = 
ªÆ_£c⁄ds
;

206 
°©us
 = 
efi
.
	`£t_time
(&
e·
);

207 i‡(
°©us
 !
EFI_SUCCESS
) {

208 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can't writeÅime!\n");

212 
	}
}

214 
	$efi_gë_time
()

216 
efi_°©us_t
 
°©us
;

217 
efi_time_t
 
e·
;

218 
efi_time_ˇp_t
 
ˇp
;

220 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

221 i‡(
°©us
 !
EFI_SUCCESS
)

222 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

224  
	`mktime
(
e·
.
yór
,É·.
m⁄th
,É·.
day
,É·.
hour
,

225 
e·
.
möuã
,É·.
£c⁄d
);

226 
	}
}

234 
__öô
 
	$do_add_efi_memm≠
()

236 *
p
;

238 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

239 
efi_mem‹y_desc_t
 *
md
 = 
p
;

240 
°¨t
 = 
md
->
phys_addr
;

241 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

242 
e820_ty≥
;

244 
md
->
ty≥
) {

245 
EFI_LOADER_CODE
:

246 
EFI_LOADER_DATA
:

247 
EFI_BOOT_SERVICES_CODE
:

248 
EFI_BOOT_SERVICES_DATA
:

249 
EFI_CONVENTIONAL_MEMORY
:

250 i‡(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)

251 
e820_ty≥
 = 
E820_RAM
;

253 
e820_ty≥
 = 
E820_RESERVED
;

255 
EFI_ACPI_RECLAIM_MEMORY
:

256 
e820_ty≥
 = 
E820_ACPI
;

258 
EFI_ACPI_MEMORY_NVS
:

259 
e820_ty≥
 = 
E820_NVS
;

261 
EFI_UNUSABLE_MEMORY
:

262 
e820_ty≥
 = 
E820_UNUSABLE
;

270 
e820_ty≥
 = 
E820_RESERVED
;

273 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
e820_ty≥
);

275 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

276 
	}
}

278 
__öô
 
	$efi_ª£rve_óæy
()

280 
pm≠
;

282 #ifde‡
CONFIG_X86_32


283 
pm≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
;

285 
pm≠
 = (
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
 |

286 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_hi
<<32));

288 
memm≠
.
phys_m≠
 = (*)
pm≠
;

289 
memm≠
.
ƒ_m≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_size
 /

290 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

291 
memm≠
.
desc_vîsi⁄
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_vîsi⁄
;

292 
memm≠
.
desc_size
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

293 
	`ª£rve_óæy
(
pm≠
,Öm≠ + 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
,

295 
	}
}

297 #i‡
EFI_DEBUG


298 
__öô
 
	$¥öt_efi_memm≠
()

300 
efi_mem‹y_desc_t
 *
md
;

301 *
p
;

302 
i
;

304 
p
 = 
memm≠
.
m≠
, 
i
 = 0;

305 
p
 < 
memm≠
.
m≠_íd
;

306 
p
 +
memm≠
.
desc_size
, 
i
++) {

307 
md
 = 
p
;

308 
	`¥ötk
(
KERN_INFO
 
PFX
 "mem%02u:Åype=%u,áttr=0x%llx, "

310 
i
, 
md
->
ty≥
, md->
©åibuã
, md->
phys_addr
,

311 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
),

312 (
md
->
num_∑ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

314 
	}
}

317 
__öô
 
	$efi_öô
()

319 
efi_c⁄fig_èbÀ_t
 *
c⁄fig_èbÀs
;

320 
efi_ru¡ime_£rvi˚s_t
 *
ru¡ime
;

321 
efi_ch¨16_t
 *
c16
;

322 
víd‹
[100] = "unknown";

323 
i
 = 0;

324 *
tmp
;

326 #ifde‡
CONFIG_X86_32


327 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
;

329 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)

330 (
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
 |

331 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab_hi
<<32));

334 
efi
.
sy°ab
 = 
	`óæy_i‹em≠
(()
efi_phys
.systab,

335 (
efi_sy°em_èbÀ_t
));

336 i‡(
efi
.
sy°ab
 =
NULL
)

337 
	`¥ötk
(
KERN_ERR
 "Couldn't mapÅhe EFI systemÅable!\n");

338 
	`mem˝y
(&
efi_sy°ab
, 
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

339 
	`óæy_iounm≠
(
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

340 
efi
.
sy°ab
 = &
efi_sy°ab
;

345 i‡(
efi
.
sy°ab
->
hdr
.
sig«tuª
 !
EFI_SYSTEM_TABLE_SIGNATURE
)

346 
	`¥ötk
(
KERN_ERR
 "EFI systemÅable signature incorrect!\n");

347 i‡((
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16) == 0)

348 
	`¥ötk
(
KERN_ERR
 "Warning: EFI systemÅable version "

350 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

351 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff);

356 
c16
 = 
tmp
 = 
	`óæy_i‹em≠
(
efi
.
sy°ab
->
fw_víd‹
, 2);

357 i‡(
c16
) {

358 
i
 = 0; i < (
víd‹
Ë- 1 && *
c16
; ++i)

359 
víd‹
[
i
] = *
c16
++;

360 
víd‹
[
i
] = '\0';

362 
	`¥ötk
(
KERN_ERR
 
PFX
 "CouldÇot mapÅhe firmware vendor!\n");

363 
	`óæy_iounm≠
(
tmp
, 2);

365 
	`¥ötk
(
KERN_INFO
 "EFI v%u.%.02u by %s \n",

366 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

367 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff, 
víd‹
);

372 
c⁄fig_èbÀs
 = 
	`óæy_i‹em≠
(

373 
efi
.
sy°ab
->
èbÀs
,

374 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

375 i‡(
c⁄fig_èbÀs
 =
NULL
)

376 
	`¥ötk
(
KERN_ERR
 "CouldÇot map EFI Configuration Table!\n");

378 
	`¥ötk
(
KERN_INFO
);

379 
i
 = 0; i < 
efi
.
sy°ab
->
ƒ_èbÀs
; i++) {

380 i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

381 
efi
.
mps
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

382 
	`¥ötk
(" MPS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

383 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

384 
ACPI_20_TABLE_GUID
)) {

385 
efi
.
a˝i20
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

386 
	`¥ötk
(" ACPI 2.0=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

387 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

388 
ACPI_TABLE_GUID
)) {

389 
efi
.
a˝i
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

390 
	`¥ötk
(" ACPI=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

391 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

392 
SMBIOS_TABLE_GUID
)) {

393 
efi
.
smbios
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

394 
	`¥ötk
(" SMBIOS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

395 #ifde‡
CONFIG_X86_UV


396 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

397 
UV_SYSTEM_TABLE_GUID
)) {

398 
efi
.
uv_sy°ab
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

399 
	`¥ötk
(" UVsy°ab=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

401 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

402 
HCDP_TABLE_GUID
)) {

403 
efi
.
hcdp
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

404 
	`¥ötk
(" HCDP=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

405 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

406 
UGA_IO_PROTOCOL_GUID
)) {

407 
efi
.
uga
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

408 
	`¥ötk
(" UGA=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

411 
	`¥ötk
("\n");

412 
	`óæy_iounm≠
(
c⁄fig_èbÀs
,

413 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

421 
ru¡ime
 = 
	`óæy_i‹em≠
(()
efi
.
sy°ab
->runtime,

422 (
efi_ru¡ime_£rvi˚s_t
));

423 i‡(
ru¡ime
 !
NULL
) {

429 
efi_phys
.
gë_time
 = (
efi_gë_time_t
 *)
ru¡ime
->get_time;

430 
efi_phys
.
£t_vútuÆ_addªss_m≠
 =

431 (
efi_£t_vútuÆ_addªss_m≠_t
 *)

432 
ru¡ime
->
£t_vútuÆ_addªss_m≠
;

437 
efi
.
gë_time
 = 
phys_efi_gë_time
;

439 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFIÑuntime service "

441 
	`óæy_iounm≠
(
ru¡ime
, (
efi_ru¡ime_£rvi˚s_t
));

444 
memm≠
.
m≠
 = 
	`óæy_i‹em≠
(()memm≠.
phys_m≠
,

445 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
);

446 i‡(
memm≠
.
m≠
 =
NULL
)

447 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFI memory map!\n");

448 
memm≠
.
m≠_íd
 = memm≠.
m≠
 + (memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

450 i‡(
memm≠
.
desc_size
 !(
efi_mem‹y_desc_t
))

451 
	`¥ötk
(
KERN_WARNING


454 i‡(
add_efi_memm≠
)

455 
	`do_add_efi_memm≠
();

457 #ifde‡
CONFIG_X86_32


458 
x86_∂©f‹m
.
gë_wÆl˛ock
 = 
efi_gë_time
;

459 
x86_∂©f‹m
.
£t_wÆl˛ock
 = 
efi_£t_πc_mmss
;

463 
ªboŸ_ty≥
 = 
BOOT_EFI
;

465 #i‡
EFI_DEBUG


466 
	`¥öt_efi_memm≠
();

468 
	}
}

470 
__öô
 
	$ru¡ime_code_∑ge_mkexec
()

472 
efi_mem‹y_desc_t
 *
md
;

473 *
p
;

474 
u64
 
addr
, 
≈ages
;

477 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

478 
md
 = 
p
;

480 i‡(
md
->
ty≥
 !
EFI_RUNTIME_SERVICES_CODE
)

483 
addr
 = 
md
->
vút_addr
;

484 
≈ages
 = 
md
->
num_∑ges
;

485 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

486 
	`£t_mem‹y_x
(
addr
, 
≈ages
);

488 
	}
}

498 
__öô
 
	$efi_íãr_vútuÆ_mode
()

500 
efi_mem‹y_desc_t
 *
md
;

501 
efi_°©us_t
 
°©us
;

502 
size
;

503 
u64
 
íd
, 
sy°ab
, 
addr
, 
≈ages
, 
íd_p‚
;

504 *
p
, *
va
;

506 
efi
.
sy°ab
 = 
NULL
;

507 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

508 
md
 = 
p
;

509 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_RUNTIME
))

512 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

513 
íd
 = 
md
->
phys_addr
 + 
size
;

515 
íd_p‚
 = 
	`PFN_UP
(
íd
);

516 i‡(
íd_p‚
 <
max_low_p‚_m≠≥d


517 || (
íd_p‚
 > (1UL << (32 - 
PAGE_SHIFT
))

518 && 
íd_p‚
 <
max_p‚_m≠≥d
))

519 
va
 = 
	`__va
(
md
->
phys_addr
);

521 
va
 = 
	`efi_i‹em≠
(
md
->
phys_addr
, 
size
, md->
ty≥
);

523 
md
->
vút_addr
 = (
u64
Ë(Ë
va
;

525 i‡(!
va
) {

526 
	`¥ötk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

527 ()
md
->
phys_addr
);

531 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)) {

532 
addr
 = 
md
->
vút_addr
;

533 
≈ages
 = 
md
->
num_∑ges
;

534 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

535 
	`£t_mem‹y_uc
(
addr
, 
≈ages
);

538 
sy°ab
 = (
u64
Ë(Ë
efi_phys
.systab;

539 i‡(
md
->
phys_addr
 <
sy°ab
 && sy°ab < 
íd
) {

540 
sy°ab
 +
md
->
vút_addr
 - md->
phys_addr
;

541 
efi
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *) () systab;

545 
	`BUG_ON
(!
efi
.
sy°ab
);

547 
°©us
 = 
	`phys_efi_£t_vútuÆ_addªss_m≠
(

548 
memm≠
.
desc_size
 * memm≠.
ƒ_m≠
,

549 
memm≠
.
desc_size
,

550 
memm≠
.
desc_vîsi⁄
,

551 
memm≠
.
phys_m≠
);

553 i‡(
°©us
 !
EFI_SUCCESS
) {

554 
	`¥ötk
(
KERN_ALERT
 "UnableÅo switch EFI into virtual mode "

555 "(°©us=%lx)!\n", 
°©us
);

556 
	`∑nic
("EFI callÅo SetVirtualAddressMap() failed!");

565 
efi
.
gë_time
 = 
vút_efi_gë_time
;

566 
efi
.
£t_time
 = 
vút_efi_£t_time
;

567 
efi
.
gë_wakeup_time
 = 
vút_efi_gë_wakeup_time
;

568 
efi
.
£t_wakeup_time
 = 
vút_efi_£t_wakeup_time
;

569 
efi
.
gë_v¨übÀ
 = 
vút_efi_gë_v¨übÀ
;

570 
efi
.
gë_√xt_v¨übÀ
 = 
vút_efi_gë_√xt_v¨übÀ
;

571 
efi
.
£t_v¨übÀ
 = 
vút_efi_£t_v¨übÀ
;

572 
efi
.
gë_√xt_high_m⁄o_cou¡
 = 
vút_efi_gë_√xt_high_m⁄o_cou¡
;

573 
efi
.
ª£t_sy°em
 = 
vút_efi_ª£t_sy°em
;

574 
efi
.
£t_vútuÆ_addªss_m≠
 = 
vút_efi_£t_vútuÆ_addªss_m≠
;

575 i‡(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
)

576 
	`ru¡ime_code_∑ge_mkexec
();

577 
	`óæy_iounm≠
(
memm≠
.
m≠
, memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

578 
memm≠
.
m≠
 = 
NULL
;

579 
	}
}

584 
u32
 
	$efi_mem_ty≥
(
phys_addr
)

586 
efi_mem‹y_desc_t
 *
md
;

587 *
p
;

589 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

590 
md
 = 
p
;

591 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

592 (
phys_addr
 < (
md
->phys_addr +

593 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

594  
md
->
ty≥
;

597 
	}
}

599 
u64
 
	$efi_mem_©åibuãs
(
phys_addr
)

601 
efi_mem‹y_desc_t
 *
md
;

602 *
p
;

604 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

605 
md
 = 
p
;

606 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

607 (
phys_addr
 < (
md
->phys_addr +

608 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

609  
md
->
©åibuã
;

612 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/efi.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/ªboŸ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/fixm≠.h
>

41 
pgd_t
 
ßve_pgd
 
	g__öôd©a
;

42 
efi_Êags
 
	g__öôd©a
;

44 
__öô
 
	$óæy_m≠pög_£t_exec
(
°¨t
,

45 
íd
,

46 
execuèbÀ
)

48 
num_∑ges
;

50 
°¨t
 &
PMD_MASK
;

51 
íd
 = (íd + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

52 
num_∑ges
 = (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

53 i‡(
execuèbÀ
)

54 
	`£t_mem‹y_x
(()
	`__va
(
°¨t
), 
num_∑ges
);

56 
	`£t_mem‹y_nx
(()
	`__va
(
°¨t
), 
num_∑ges
);

57 
	}
}

59 
__öô
 
	$óæy_ru¡ime_code_m≠pög_£t_exec
(
execuèbÀ
)

61 
efi_mem‹y_desc_t
 *
md
;

62 *
p
;

64 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

69 
md
 = 
p
;

70 i‡(
md
->
ty≥
 =
EFI_RUNTIME_SERVICES_CODE
) {

71 
íd
;

72 
íd
 = 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
);

73 
	`óæy_m≠pög_£t_exec
(
md
->
phys_addr
, 
íd
, 
execuèbÀ
);

76 
	}
}

78 
__öô
 
	$efi_ˇŒ_phys_¥ñog
()

80 
vaddªss
;

82 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(1);

83 
	`loˇl_úq_ßve
(
efi_Êags
);

84 
vaddªss
 = ()
	`__va
(0x0UL);

85 
ßve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vaddªss
));

87 
	`__Êush_éb_Æl
();

88 
	}
}

90 
__öô
 
	$efi_ˇŒ_phys_ïûog
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
ßve_pgd
);

96 
	`__Êush_éb_Æl
();

97 
	`loˇl_úq_ª°‹e
(
efi_Êags
);

98 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__öô
 
	$efi_i‹em≠
(
phys_addr
, 
size
,

102 
u32
 
ty≥
)

104 
œ°_m≠_p‚
;

106 i‡(
ty≥
 =
EFI_MEMORY_MAPPED_IO
)

107  
	`i‹em≠
(
phys_addr
, 
size
);

109 
œ°_m≠_p‚
 = 
	`öô_mem‹y_m≠pög
(
phys_addr
,Öhys_add∏+ 
size
);

110 i‡((
œ°_m≠_p‚
 << 
PAGE_SHIFT
Ë< 
phys_addr
 + 
size
)

111  
NULL
;

113  (
__iomem
 *)
	`__va
(
phys_addr
);

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/öô.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__öô
 
	$ª£rve_ebda_ªgi⁄
()

21 
lowmem
, 
ebda_addr
;

29 i‡(
	`∑øvút_íabÀd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`gë_bios_ebda
();

41 i‡((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 i‡((
ebda_addr
 =0Ë&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 i‡((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`ª£rve_óæy_ovîœp_ok
(
lowmem
, 0x100000, "BIOSÑeserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<löux/öô.h
>

8 
	~<löux/lökage.h
>

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/≥r˝u.h
>

13 
	~<löux/°¨t_kî√l.h
>

14 
	~<löux/io.h
>

16 
	~<asm/¥o˚ss‹.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/£˘i⁄s.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/åampﬁöe.h
>

27 
	~<asm/bios_ebda.h
>

29 
__öô
 
	$z≠_idítôy_m≠pögs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_˛ór
(
pgd
);

33 
	`__Êush_éb_Æl
();

34 
	}
}

38 
__öô
 
	$˛ór_bss
()

40 
	`mem£t
(
__bss_°¨t
, 0,

41 (Ë
__bss_°›
 - (Ë
__bss_°¨t
);

42 
	}
}

44 
__öô
 
	$c›y_boŸd©a
(*
ªÆ_mode_d©a
)

46 * 
comm™d_löe
;

48 
	`mem˝y
(&
boŸ_∑øms
, 
ªÆ_mode_d©a
,  boot_params);

49 i‡(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
) {

50 
comm™d_löe
 = 
	`__va
(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
);

51 
	`mem˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__öô
 
	$x86_64_°¨t_kî√l
(* 
ªÆ_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1Ë& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vút
(
__íd_of_fixed_addªs£s
Ë<
MODULES_END
);

74 
	`˛ór_bss
();

77 
	`z≠_idítôy_m≠pögs
();

80 
	`˛ónup_highm≠
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifde‡
CONFIG_EARLY_PRINTK


84 
	`£t_öå_g©e
(
i
, &
óæy_idt_h™dÀrs
[i]);

86 
	`£t_öå_g©e
(
i
, 
óæy_idt_h™dÀr
);

89 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

91 i‡(
c⁄sﬁe_logÀvñ
 == 10)

92 
	`óæy_¥ötk
("Kernelálive\n");

94 
	`x86_64_°¨t_ª£rv©i⁄s
(
ªÆ_mode_d©a
);

95 
	}
}

97 
__öô
 
	$x86_64_°¨t_ª£rv©i⁄s
(*
ªÆ_mode_d©a
)

99 
	`c›y_boŸd©a
(
	`__va
(
ªÆ_mode_d©a
));

101 
	`ª£rve_óæy
(
	`__∑_symbﬁ
(&
_ãxt
), __∑_symbﬁ(&
__bss_°›
), "TEXT DATA BSS");

103 #ifde‡
CONFIG_BLK_DEV_INITRD


105 i‡(
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 && boŸ_∑øms.hdr.
ømdisk_image
) {

106 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

107 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

108 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

109 
	`ª£rve_óæy
(
ømdisk_image
, 
ømdisk_íd
, "RAMDISK");

113 
	`ª£rve_ebda_ªgi⁄
();

121 
	`°¨t_kî√l
();

122 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<löux/˛ocksour˚.h
>

2 
	~<löux/˛ockchùs.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/sysdev.h
>

5 
	~<löux/dñay.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/h≥t.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/˝u.h
>

10 
	~<löux/pm.h
>

11 
	~<löux/io.h
>

13 
	~<asm/fixm≠.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/h≥t.h
>

17 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

18 
	#HPET_SHIFT
 22

	)

22 
	#FSEC_PER_NSEC
 1000000L

	)

24 
	#HPET_DEV_USED_BIT
 2

	)

25 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

26 
	#HPET_DEV_VALID
 0x8

	)

27 
	#HPET_DEV_FSB_CAP
 0x1000

	)

28 
	#HPET_DEV_PERI_CAP
 0x2000

	)

30 
	#EVT_TO_HPET_DEV
(
evt
Ë
	`c⁄èöî_of
”vt, 
h≥t_dev
,Évt)

	)

35 
	gh≥t_addªss
;

36 
u8
 
	gh≥t_blockid
;

37 
u8
 
	gh≥t_msi_dißbÀ
;

39 #ifde‡
CONFIG_PCI_MSI


40 
	gh≥t_num_timîs
;

42 
__iomem
 *
	gh≥t_vút_addªss
;

44 
	sh≥t_dev
 {

45 
˛ock_evít_devi˚
 
	mevt
;

46 
	mnum
;

47 
	m˝u
;

48 
	múq
;

49 
	mÊags
;

50 
	m«me
[10];

53 
ölöe
 
	$h≥t_ªadl
(
a
)

55  
	`ªadl
(
h≥t_vút_addªss
 + 
a
);

56 
	}
}

58 
ölöe
 
	$h≥t_wrôñ
(
d
, 
a
)

60 
	`wrôñ
(
d
, 
h≥t_vút_addªss
 + 
a
);

61 
	}
}

63 #ifde‡
CONFIG_X86_64


64 
	~<asm/pgèbÀ.h
>

67 
ölöe
 
	$h≥t_£t_m≠pög
()

69 
h≥t_vút_addªss
 = 
	`i‹em≠_noˇche
(
h≥t_addªss
, 
HPET_MMAP_SIZE
);

70 #ifde‡
CONFIG_X86_64


71 
	`__£t_fixm≠
(
VSYSCALL_HPET
, 
h≥t_addªss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

73 
	}
}

75 
ölöe
 
	$h≥t_˛ór_m≠pög
()

77 
	`iounm≠
(
h≥t_vút_addªss
);

78 
h≥t_vút_addªss
 = 
NULL
;

79 
	}
}

84 
	gboŸ_h≥t_dißbÀ
;

85 
	gh≥t_f‹˚_u£r
;

86 
	gh≥t_vîbo£
;

88 
__öô
 
	$h≥t_£tup
(*
°r
)

90 i‡(
°r
) {

91 i‡(!
	`°∫cmp
("dißbÀ", 
°r
, 7))

92 
boŸ_h≥t_dißbÀ
 = 1;

93 i‡(!
	`°∫cmp
("f‹˚", 
°r
, 5))

94 
h≥t_f‹˚_u£r
 = 1;

95 i‡(!
	`°∫cmp
("vîbo£", 
°r
, 7))

96 
h≥t_vîbo£
 = 1;

99 
	}
}

100 
__£tup
("h≥t=", 
h≥t_£tup
);

102 
__öô
 
	$dißbÀ_h≥t
(*
°r
)

104 
boŸ_h≥t_dißbÀ
 = 1;

106 
	}
}

107 
__£tup
("noh≥t", 
dißbÀ_h≥t
);

109 
ölöe
 
	$is_h≥t_ˇ∑bÀ
()

111  !
boŸ_h≥t_dißbÀ
 && 
h≥t_addªss
;

112 
	}
}

117 
	gh≥t_Àgacy_öt_íabÀd
;

122 
	$is_h≥t_íabÀd
()

124  
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_Àgacy_öt_íabÀd
;

125 
	}
}

126 
EXPORT_SYMBOL_GPL
(
is_h≥t_íabÀd
);

128 
	$_h≥t_¥öt_c⁄fig
(c⁄° *
fun˘i⁄
, 
löe
)

130 
u32
 
i
, 
timîs
, 
l
, 
h
;

131 
	`¥ötk
(
KERN_INFO
 "h≥t: %s(%d):\n", 
fun˘i⁄
, 
löe
);

132 
l
 = 
	`h≥t_ªadl
(
HPET_ID
);

133 
h
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

134 
timîs
 = ((
l
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

135 
	`¥ötk
(
KERN_INFO
 "h≥t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

136 
l
 = 
	`h≥t_ªadl
(
HPET_CFG
);

137 
h
 = 
	`h≥t_ªadl
(
HPET_STATUS
);

138 
	`¥ötk
(
KERN_INFO
 "h≥t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

139 
l
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

140 
h
 = 
	`h≥t_ªadl
(
HPET_COUNTER
+4);

141 
	`¥ötk
(
KERN_INFO
 "h≥t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

143 
i
 = 0; i < 
timîs
; i++) {

144 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

145 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
)+4);

146 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

147 
i
, 
l
, 
h
);

148 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
));

149 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
)+4);

150 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

151 
i
, 
l
, 
h
);

152 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
));

153 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
)+4);

154 
	`¥ötk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

155 
i
, 
l
, 
h
);

157 
	}
}

159 
	#h≥t_¥öt_c⁄fig
() \

161 i‡(
h≥t_vîbo£
) \

162 
	`_h≥t_¥öt_c⁄fig
(
__FUNCTION__
, 
__LINE__
); \

163 } 0)

	)

169 #ifde‡
CONFIG_HPET


171 
h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
);

173 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
)

175 
h≥t
 
__iomem
 *h≥à
h≥t_vút_addªss
;

176 
h≥t_timî
 
__iomem
 *
timî
 = &
h≥t
->
h≥t_timîs
[2];

177 
ƒtimîs
, 
i
;

178 
h≥t_d©a
 
hd
;

180 
ƒtimîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

182 
	`mem£t
(&
hd
, 0, (hd));

183 
hd
.
hd_phys_addªss
 = 
h≥t_addªss
;

184 
hd
.
hd_addªss
 = 
h≥t
;

185 
hd
.
hd_núqs
 = 
ƒtimîs
;

186 
	`h≥t_ª£rve_timî
(&
hd
, 0);

188 #ifde‡
CONFIG_HPET_EMULATE_RTC


189 
	`h≥t_ª£rve_timî
(&
hd
, 1);

197 
hd
.
hd_úq
[0] = 
HPET_LEGACY_8254
;

198 
hd
.
hd_úq
[1] = 
HPET_LEGACY_RTC
;

200 
i
 = 2; i < 
ƒtimîs
; 
timî
++, i++) {

201 
hd
.
hd_úq
[
i
] = (
	`ªadl
(&
timî
->
h≥t_c⁄fig
) &

202 
Tn_INT_ROUTE_CNF_MASK
Ë>> 
Tn_INT_ROUTE_CNF_SHIFT
;

205 
	`h≥t_ª£rve_msi_timîs
(&
hd
);

207 
	`h≥t_Æloc
(&
hd
);

209 
	}
}

211 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
Ë{ 
	}
}

217 
	gh≥t_≥riod
;

219 
h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

220 
˛ock_evít_devi˚
 *
evt
);

221 
h≥t_Àgacy_√xt_evít
(
dñè
,

222 
˛ock_evít_devi˚
 *
evt
);

227 
˛ock_evít_devi˚
 
	gh≥t_˛ockevít
 = {

228 .
«me
 = "hpet",

229 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

230 .
	g£t_mode
 = 
h≥t_Àgacy_£t_mode
,

231 .
	g£t_√xt_evít
 = 
h≥t_Àgacy_√xt_evít
,

232 .
	gshi·
 = 32,

233 .
	gúq
 = 0,

234 .
	gøtög
 = 50,

237 
	$h≥t_°›_cou¡î
()

239 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

240 
cfg
 &~
HPET_CFG_ENABLE
;

241 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

242 
	}
}

244 
	$h≥t_ª£t_cou¡î
()

246 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
);

247 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
 + 4);

248 
	}
}

250 
	$h≥t_°¨t_cou¡î
()

252 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

253 
cfg
 |
HPET_CFG_ENABLE
;

254 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

255 
	}
}

257 
	$h≥t_ª°¨t_cou¡î
()

259 
	`h≥t_°›_cou¡î
();

260 
	`h≥t_ª£t_cou¡î
();

261 
	`h≥t_°¨t_cou¡î
();

262 
	}
}

264 
	$h≥t_ªsume_devi˚
()

266 
	`f‹˚_h≥t_ªsume
();

267 
	}
}

269 
	$h≥t_ªsume_cou¡î
()

271 
	`h≥t_ªsume_devi˚
();

272 
	`h≥t_ª°¨t_cou¡î
();

273 
	}
}

275 
	$h≥t_íabÀ_Àgacy_öt
()

277 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

279 
cfg
 |
HPET_CFG_LEGACY
;

280 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

281 
h≥t_Àgacy_öt_íabÀd
 = 1;

282 
	}
}

284 
	$h≥t_Àgacy_˛ockevít_ªgi°î
()

287 
	`h≥t_íabÀ_Àgacy_öt
();

297 
h≥t_˛ockevít
.
mu…
 = 
	`div_sc
((Ë
FSEC_PER_NSEC
,

298 
h≥t_≥riod
, 
h≥t_˛ockevít
.
shi·
);

300 
h≥t_˛ockevít
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,

301 &
h≥t_˛ockevít
);

303 
h≥t_˛ockevít
.
mö_dñè_ns
 = 5000;

309 
h≥t_˛ockevít
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

310 
	`˛ockevíts_ªgi°î_devi˚
(&
h≥t_˛ockevít
);

311 
globÆ_˛ock_evít
 = &
h≥t_˛ockevít
;

312 
	`¥ötk
(
KERN_DEBUG
 "hpet clockeventÑegistered\n");

313 
	}
}

315 
h≥t_£tup_msi_úq
(
úq
);

317 
	$h≥t_£t_mode
(
˛ock_evít_mode
 
mode
,

318 
˛ock_evít_devi˚
 *
evt
, 
timî
)

320 
cfg
, 
cmp
, 
now
;

321 
uöt64_t
 
dñè
;

323 
mode
) {

324 
CLOCK_EVT_MODE_PERIODIC
:

325 
	`h≥t_°›_cou¡î
();

326 
dñè
 = ((
uöt64_t
)(
NSEC_PER_SEC
/
HZ
)Ë* 
evt
->
mu…
;

327 
dñè
 >>
evt
->
shi·
;

328 
now
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

329 
cmp
 = 
now
 + (Ë
dñè
;

330 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

332 
cfg
 &~
HPET_TN_LEVEL
;

333 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

334 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

335 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

336 
	`h≥t_wrôñ
(
cmp
, 
	`HPET_Tn_CMP
(
timî
));

337 
	`udñay
(1);

345 
	`h≥t_wrôñ
((Ë
dñè
, 
	`HPET_Tn_CMP
(
timî
));

346 
	`h≥t_°¨t_cou¡î
();

347 
	`h≥t_¥öt_c⁄fig
();

350 
CLOCK_EVT_MODE_ONESHOT
:

351 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

352 
cfg
 &~
HPET_TN_PERIODIC
;

353 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

354 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

357 
CLOCK_EVT_MODE_UNUSED
:

358 
CLOCK_EVT_MODE_SHUTDOWN
:

359 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

360 
cfg
 &~
HPET_TN_ENABLE
;

361 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

364 
CLOCK_EVT_MODE_RESUME
:

365 i‡(
timî
 == 0) {

366 
	`h≥t_íabÀ_Àgacy_öt
();

368 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

369 
	`h≥t_£tup_msi_úq
(
hdev
->
úq
);

370 
	`dißbÀ_úq
(
hdev
->
úq
);

371 
	`úq_£t_afföôy
(
hdev
->
úq
, 
	`˝umask_of
(hdev->
˝u
));

372 
	`íabÀ_úq
(
hdev
->
úq
);

374 
	`h≥t_¥öt_c⁄fig
();

377 
	}
}

379 
	$h≥t_√xt_evít
(
dñè
,

380 
˛ock_evít_devi˚
 *
evt
, 
timî
)

382 
u32
 
˙t
;

384 
˙t
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

385 
˙t
 +(
u32
Ë
dñè
;

386 
	`h≥t_wrôñ
(
˙t
, 
	`HPET_Tn_CMP
(
timî
));

403 
	`WARN_ONCE
(
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
)Ë!
˙t
,

404 
KERN_WARNING
 "hpet: compareÑegisterÑead back failed.\n");

406  (
s32
)(
	`h≥t_ªadl
(
HPET_COUNTER
Ë- 
˙t
Ë>0 ? -
ETIME
 : 0;

407 
	}
}

409 
	$h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

410 
˛ock_evít_devi˚
 *
evt
)

412 
	`h≥t_£t_mode
(
mode
, 
evt
, 0);

413 
	}
}

415 
	$h≥t_Àgacy_√xt_evít
(
dñè
,

416 
˛ock_evít_devi˚
 *
evt
)

418  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 0);

419 
	}
}

424 #ifde‡
CONFIG_PCI_MSI


426 
DEFINE_PER_CPU
(
h≥t_dev
 *, 
˝u_h≥t_dev
);

427 
h≥t_dev
 *
	gh≥t_devs
;

429 
	$h≥t_msi_unmask
(
úq
)

431 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

432 
cfg
;

435 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

436 
cfg
 |
HPET_TN_FSB
;

437 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

438 
	}
}

440 
	$h≥t_msi_mask
(
úq
)

442 
cfg
;

443 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

446 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

447 
cfg
 &~
HPET_TN_FSB
;

448 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

449 
	}
}

451 
	$h≥t_msi_wrôe
(
úq
, 
msi_msg
 *
msg
)

453 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

455 
	`h≥t_wrôñ
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

456 
	`h≥t_wrôñ
(
msg
->
addªss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

457 
	}
}

459 
	$h≥t_msi_ªad
(
úq
, 
msi_msg
 *
msg
)

461 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

463 
msg
->
d©a
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

464 
msg
->
addªss_lo
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

465 
msg
->
addªss_hi
 = 0;

466 
	}
}

468 
	$h≥t_msi_£t_mode
(
˛ock_evít_mode
 
mode
,

469 
˛ock_evít_devi˚
 *
evt
)

471 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

472 
	`h≥t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

473 
	}
}

475 
	$h≥t_msi_√xt_evít
(
dñè
,

476 
˛ock_evít_devi˚
 *
evt
)

478 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

479  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 
hdev
->
num
);

480 
	}
}

482 
	$h≥t_£tup_msi_úq
(
úq
)

484 i‡(
	`¨ch_£tup_h≥t_msi
(
úq
, 
h≥t_blockid
)) {

485 
	`de°roy_úq
(
úq
);

486  -
EINVAL
;

489 
	}
}

491 
	$h≥t_assign_úq
(
h≥t_dev
 *
dev
)

493 
úq
;

495 
úq
 = 
	`¸óã_úq
();

496 i‡(!
úq
)

497  -
EINVAL
;

499 
	`£t_úq_d©a
(
úq
, 
dev
);

501 i‡(
	`h≥t_£tup_msi_úq
(
úq
))

502  -
EINVAL
;

504 
dev
->
úq
 = irq;

506 
	}
}

508 
úqªtu∫_t
 
	$h≥t_öãºu±_h™dÀr
(
úq
, *
d©a
)

510 
h≥t_dev
 *
dev
 = (h≥t_dev *)
d©a
;

511 
˛ock_evít_devi˚
 *
hevt
 = &
dev
->
evt
;

513 i‡(!
hevt
->
evít_h™dÀr
) {

514 
	`¥ötk
(
KERN_INFO
 "Spurious HPETÅimer interrupt on HPETÅimer %d\n",

515 
dev
->
num
);

516  
IRQ_HANDLED
;

519 
hevt
->
	`evít_h™dÀr
(hevt);

520  
IRQ_HANDLED
;

521 
	}
}

523 
	$h≥t_£tup_úq
(
h≥t_dev
 *
dev
)

526 i‡(
	`ªque°_úq
(
dev
->
úq
, 
h≥t_öãºu±_h™dÀr
,

527 
IRQF_TIMER
 | 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
,

528 
dev
->
«me
, dev))

531 
	`dißbÀ_úq
(
dev
->
úq
);

532 
	`úq_£t_afföôy
(
dev
->
úq
, 
	`˝umask_of
(dev->
˝u
));

533 
	`íabÀ_úq
(
dev
->
úq
);

535 
	`¥ötk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

536 
dev
->
«me
, dev->
úq
);

539 
	}
}

542 
	$öô_⁄e_h≥t_msi_˛ockevít
(
h≥t_dev
 *
hdev
, 
˝u
)

544 
˛ock_evít_devi˚
 *
evt
 = &
hdev
->evt;

545 
uöt64_t
 
h≥t_‰eq
;

547 
	`WARN_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

548 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

551 i‡(
	`h≥t_£tup_msi_úq
(
hdev
->
úq
))

554 
hdev
->
˝u
 = cpu;

555 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
hdev
;

556 
evt
->
«me
 = 
hdev
->name;

557 
	`h≥t_£tup_úq
(
hdev
);

558 
evt
->
úq
 = 
hdev
->irq;

560 
evt
->
øtög
 = 110;

561 
evt
->
„©uªs
 = 
CLOCK_EVT_FEAT_ONESHOT
;

562 i‡(
hdev
->
Êags
 & 
HPET_DEV_PERI_CAP
)

563 
evt
->
„©uªs
 |
CLOCK_EVT_FEAT_PERIODIC
;

565 
evt
->
£t_mode
 = 
h≥t_msi_£t_mode
;

566 
evt
->
£t_√xt_evít
 = 
h≥t_msi_√xt_evít
;

567 
evt
->
shi·
 = 32;

574 
h≥t_‰eq
 = 1000000000000000ULL;

575 
	`do_div
(
h≥t_‰eq
, 
h≥t_≥riod
);

576 
evt
->
mu…
 = 
	`div_sc
((Ë
h≥t_‰eq
,

577 
NSEC_PER_SEC
, 
evt
->
shi·
);

579 
evt
->
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,Évt);

581 
evt
->
mö_dñè_ns
 = 5000;

583 
evt
->
˝umask
 = 
	`˝umask_of
(
hdev
->
˝u
);

584 
	`˛ockevíts_ªgi°î_devi˚
(
evt
);

585 
	}
}

587 #ifde‡
CONFIG_HPET


589 
	#RESERVE_TIMERS
 1

	)

591 
	#RESERVE_TIMERS
 0

	)

594 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

596 
id
;

597 
num_timîs
;

598 
num_timîs_u£d
 = 0;

599 
i
;

601 i‡(
h≥t_msi_dißbÀ
)

604 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

606 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

608 
num_timîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
);

609 
num_timîs
++;

610 
	`h≥t_¥öt_c⁄fig
();

612 
h≥t_devs
 = 
	`kzÆloc
((
h≥t_dev
Ë* 
num_timîs
, 
GFP_KERNEL
);

613 i‡(!
h≥t_devs
)

616 
h≥t_num_timîs
 = 
num_timîs
;

618 
i
 = 
°¨t_timî
; i < 
num_timîs
 - 
RESERVE_TIMERS
; i++) {

619 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
num_timîs_u£d
];

620 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

623 i‡(!(
cfg
 & 
HPET_TN_FSB_CAP
))

626 
hdev
->
Êags
 = 0;

627 i‡(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

628 
hdev
->
Êags
 |
HPET_DEV_PERI_CAP
;

629 
hdev
->
num
 = 
i
;

631 
	`•rötf
(
hdev
->
«me
, "h≥t%d", 
i
);

632 i‡(
	`h≥t_assign_úq
(
hdev
))

635 
hdev
->
Êags
 |
HPET_DEV_FSB_CAP
;

636 
hdev
->
Êags
 |
HPET_DEV_VALID
;

637 
num_timîs_u£d
++;

638 i‡(
num_timîs_u£d
 =
	`num_possibÀ_˝us
())

642 
	`¥ötk
(
KERN_INFO
 "HPET: %dÅimers inÅotal, %dÅimers will be used forÖer-cpuÅimer\n",

643 
num_timîs
, 
num_timîs_u£d
);

644 
	}
}

646 #ifde‡
CONFIG_HPET


647 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

649 
i
;

651 i‡(!
h≥t_devs
)

654 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

655 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

657 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

660 
hd
->
hd_úq
[
hdev
->
num
] = hdev->
úq
;

661 
	`h≥t_ª£rve_timî
(
hd
, 
hdev
->
num
);

663 
	}
}

666 
h≥t_dev
 *
	$h≥t_gë_unu£d_timî
()

668 
i
;

670 i‡(!
h≥t_devs
)

671  
NULL
;

673 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

674 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

676 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

678 i‡(
	`ã°_™d_£t_bô
(
HPET_DEV_USED_BIT
,

679 (*)&
hdev
->
Êags
))

681  
hdev
;

683  
NULL
;

684 
	}
}

686 
	sh≥t_w‹k_°ru˘
 {

687 
dñayed_w‹k
 
	mw‹k
;

688 
com∂ëi⁄
 
	mcom∂ëe
;

691 
	$h≥t_w‹k
(
w‹k_°ru˘
 *
w
)

693 
h≥t_dev
 *
hdev
;

694 
˝u
 = 
	`smp_¥o˚ss‹_id
();

695 
h≥t_w‹k_°ru˘
 *
h≥t_w‹k
;

697 
h≥t_w‹k
 = 
	`c⁄èöî_of
(
w
, 
h≥t_w‹k_°ru˘
, 
w‹k
.work);

699 
hdev
 = 
	`h≥t_gë_unu£d_timî
();

700 i‡(
hdev
)

701 
	`öô_⁄e_h≥t_msi_˛ockevít
(
hdev
, 
˝u
);

703 
	`com∂ëe
(&
h≥t_w‹k
->
com∂ëe
);

704 
	}
}

706 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

707 
a˘i⁄
, *
h˝u
)

709 
˝u
 = ()
h˝u
;

710 
h≥t_w‹k_°ru˘
 
w‹k
;

711 
h≥t_dev
 *
hdev
 = 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
);

713 
a˘i⁄
 & 0xf) {

714 
CPU_ONLINE
:

715 
	`INIT_DELAYED_WORK_ON_STACK
(&
w‹k
.w‹k, 
h≥t_w‹k
);

716 
	`öô_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

718 
	`scheduÀ_dñayed_w‹k_⁄
(
˝u
, &
w‹k
.work, 0);

719 
	`waô_f‹_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

720 
	`de°roy_timî_⁄_°ack
(&
w‹k
.w‹k.
timî
);

722 
CPU_DEAD
:

723 i‡(
hdev
) {

724 
	`‰ì_úq
(
hdev
->
úq
, hdev);

725 
hdev
->
Êags
 &~
HPET_DEV_USED
;

726 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
NULL
;

730  
NOTIFY_OK
;

731 
	}
}

734 
	$h≥t_£tup_msi_úq
(
úq
)

737 
	}
}

738 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

741 
	}
}

743 #ifde‡
CONFIG_HPET


744 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

747 
	}
}

750 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

751 
a˘i⁄
, *
h˝u
)

753  
NOTIFY_OK
;

754 
	}
}

761 
cy˛e_t
 
	$ªad_h≥t
(
˛ocksour˚
 *
cs
)

763  (
cy˛e_t
)
	`h≥t_ªadl
(
HPET_COUNTER
);

764 
	}
}

766 #ifde‡
CONFIG_X86_64


767 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_h≥t
()

769  
	`ªadl
((c⁄° 
__iomem
 *)
	`fix_to_vút
(
VSYSCALL_HPET
) + 0xf0);

770 
	}
}

773 
˛ocksour˚
 
	g˛ocksour˚_h≥t
 = {

774 .
«me
 = "hpet",

775 .
	gøtög
 = 250,

776 .
	gªad
 = 
ªad_h≥t
,

777 .
	gmask
 = 
HPET_MASK
,

778 .
	gshi·
 = 
HPET_SHIFT
,

779 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

780 .
	gªsume
 = 
h≥t_ªsume_cou¡î
,

781 #ifde‡
CONFIG_X86_64


782 .
	gvªad
 = 
vªad_h≥t
,

786 
	$h≥t_˛ocksour˚_ªgi°î
()

788 
u64
 
°¨t
, 
now
;

789 
cy˛e_t
 
t1
;

792 
	`h≥t_ª°¨t_cou¡î
();

795 
t1
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

796 
	`rdts˛l
(
°¨t
);

805 
	`ªp_n›
();

806 
	`rdts˛l
(
now
);

807 } (
now
 - 
°¨t
) < 200000UL);

809 i‡(
t1
 =
	`h≥t_ªadl
(
HPET_COUNTER
)) {

810 
	`¥ötk
(
KERN_WARNING


812  -
ENODEV
;

823 
˛ocksour˚_h≥t
.
mu…
 = 
	`div_sc
(
h≥t_≥riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

825 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_h≥t
);

828 
	}
}

833 
__öô
 
	$h≥t_íabÀ
()

835 
id
;

836 
i
;

838 i‡(!
	`is_h≥t_ˇ∑bÀ
())

841 
	`h≥t_£t_m≠pög
();

846 
h≥t_≥riod
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

861 
i
 = 0; 
	`h≥t_ªadl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

862 i‡(
i
 == 1000) {

863 
	`¥ötk
(
KERN_WARNING


866 
out_noh≥t
;

870 i‡(
h≥t_≥riod
 < 
HPET_MIN_PERIOD
 || h≥t_≥riod > 
HPET_MAX_PERIOD
)

871 
out_noh≥t
;

877 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

878 
	`h≥t_¥öt_c⁄fig
();

880 #ifde‡
CONFIG_HPET_EMULATE_RTC


885 i‡(!(
id
 & 
HPET_ID_NUMBER
))

886 
out_noh≥t
;

889 i‡(
	`h≥t_˛ocksour˚_ªgi°î
())

890 
out_noh≥t
;

892 i‡(
id
 & 
HPET_ID_LEGSUP
) {

893 
	`h≥t_Àgacy_˛ockevít_ªgi°î
();

898 
out_noh≥t
:

899 
	`h≥t_˛ór_m≠pög
();

900 
h≥t_addªss
 = 0;

902 
	}
}

910 
__öô
 
	$h≥t_œã_öô
()

912 
˝u
;

914 i‡(
boŸ_h≥t_dißbÀ
)

915  -
ENODEV
;

917 i‡(!
h≥t_addªss
) {

918 i‡(!
f‹˚_h≥t_addªss
)

919  -
ENODEV
;

921 
h≥t_addªss
 = 
f‹˚_h≥t_addªss
;

922 
	`h≥t_íabÀ
();

925 i‡(!
h≥t_vút_addªss
)

926  -
ENODEV
;

928 i‡(
	`h≥t_ªadl
(
HPET_ID
Ë& 
HPET_ID_LEGSUP
)

929 
	`h≥t_msi_ˇ∑bûôy_lookup
(2);

931 
	`h≥t_msi_ˇ∑bûôy_lookup
(0);

933 
	`h≥t_ª£rve_∂©f‹m_timîs
(
	`h≥t_ªadl
(
HPET_ID
));

934 
	`h≥t_¥öt_c⁄fig
();

936 i‡(
h≥t_msi_dißbÀ
)

939 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

942 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

943 
	`h≥t_˝uhp_nŸify
(
NULL
, 
CPU_ONLINE
, (*)()
˝u
);

947 
	`hŸ˝u_nŸifõr
(
h≥t_˝uhp_nŸify
, -20);

950 
	}
}

951 
fs_öôˇŒ
(
h≥t_œã_öô
);

953 
	$h≥t_dißbÀ
()

955 i‡(
	`is_h≥t_ˇ∑bÀ
()) {

956 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

958 i‡(
h≥t_Àgacy_öt_íabÀd
) {

959 
cfg
 &~
HPET_CFG_LEGACY
;

960 
h≥t_Àgacy_öt_íabÀd
 = 0;

962 
cfg
 &~
HPET_CFG_ENABLE
;

963 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

965 
	}
}

967 #ifde‡
CONFIG_HPET_EMULATE_RTC


983 
	~<löux/mc146818πc.h
>

984 
	~<löux/πc.h
>

985 
	~<asm/πc.h
>

987 
	#DEFAULT_RTC_INT_FREQ
 64

	)

988 
	#DEFAULT_RTC_SHIFT
 6

	)

989 
	#RTC_NUM_INTS
 1

	)

991 
	gh≥t_πc_Êags
;

992 
	gh≥t_¥ev_upd©e_£c
;

993 
πc_time
 
	gh≥t_Æ¨m_time
;

994 
	gh≥t_põ_cou¡
;

995 
u32
 
	gh≥t_t1_cmp
;

996 
u32
 
	gh≥t_deÁu…_dñè
;

997 
u32
 
	gh≥t_põ_dñè
;

998 
	gh≥t_põ_limô
;

1000 
πc_úq_h™dÀr
 
	gúq_h™dÀr
;

1005 
ölöe
 
	$h≥t_˙t_ahód
(
u32
 
c1
, u32 
c2
)

1007  (
s32
)(
c2
 - 
c1
) < 0;

1008 
	}
}

1013 
	$h≥t_ªgi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1015 i‡(!
	`is_h≥t_íabÀd
())

1016  -
ENODEV
;

1017 i‡(
úq_h™dÀr
)

1018  -
EBUSY
;

1020 
úq_h™dÀr
 = 
h™dÀr
;

1023 
	}
}

1024 
EXPORT_SYMBOL_GPL
(
h≥t_ªgi°î_úq_h™dÀr
);

1030 
	$h≥t_uƒegi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1032 i‡(!
	`is_h≥t_íabÀd
())

1035 
úq_h™dÀr
 = 
NULL
;

1036 
h≥t_πc_Êags
 = 0;

1037 
	}
}

1038 
EXPORT_SYMBOL_GPL
(
h≥t_uƒegi°î_úq_h™dÀr
);

1046 
	$h≥t_πc_timî_öô
()

1048 
cfg
, 
˙t
, 
dñè
;

1049 
Êags
;

1051 i‡(!
	`is_h≥t_íabÀd
())

1054 i‡(!
h≥t_deÁu…_dñè
) {

1055 
uöt64_t
 
˛c
;

1057 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1058 
˛c
 >>
h≥t_˛ockevít
.
shi·
 + 
DEFAULT_RTC_SHIFT
;

1059 
h≥t_deÁu…_dñè
 = 
˛c
;

1062 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1063 
dñè
 = 
h≥t_deÁu…_dñè
;

1065 
dñè
 = 
h≥t_põ_dñè
;

1067 
	`loˇl_úq_ßve
(
Êags
);

1069 
˙t
 = 
dñè
 + 
	`h≥t_ªadl
(
HPET_COUNTER
);

1070 
	`h≥t_wrôñ
(
˙t
, 
HPET_T1_CMP
);

1071 
h≥t_t1_cmp
 = 
˙t
;

1073 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1074 
cfg
 &~
HPET_TN_PERIODIC
;

1075 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1076 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1078 
	`loˇl_úq_ª°‹e
(
Êags
);

1081 
	}
}

1082 
EXPORT_SYMBOL_GPL
(
h≥t_πc_timî_öô
);

1089 
	$h≥t_mask_πc_úq_bô
(
bô_mask
)

1091 i‡(!
	`is_h≥t_íabÀd
())

1094 
h≥t_πc_Êags
 &~
bô_mask
;

1096 
	}
}

1097 
EXPORT_SYMBOL_GPL
(
h≥t_mask_πc_úq_bô
);

1099 
	$h≥t_£t_πc_úq_bô
(
bô_mask
)

1101 
ﬁdbôs
 = 
h≥t_πc_Êags
;

1103 i‡(!
	`is_h≥t_íabÀd
())

1106 
h≥t_πc_Êags
 |
bô_mask
;

1108 i‡((
bô_mask
 & 
RTC_UIE
Ë&& !(
ﬁdbôs
 & RTC_UIE))

1109 
h≥t_¥ev_upd©e_£c
 = -1;

1111 i‡(!
ﬁdbôs
)

1112 
	`h≥t_πc_timî_öô
();

1115 
	}
}

1116 
EXPORT_SYMBOL_GPL
(
h≥t_£t_πc_úq_bô
);

1118 
	$h≥t_£t_Æ¨m_time
(
hrs
, 
mö
,

1119 
£c
)

1121 i‡(!
	`is_h≥t_íabÀd
())

1124 
h≥t_Æ¨m_time
.
tm_hour
 = 
hrs
;

1125 
h≥t_Æ¨m_time
.
tm_mö
 = 
mö
;

1126 
h≥t_Æ¨m_time
.
tm_£c
 = 
£c
;

1129 
	}
}

1130 
EXPORT_SYMBOL_GPL
(
h≥t_£t_Æ¨m_time
);

1132 
	$h≥t_£t_≥riodic_‰eq
(
‰eq
)

1134 
uöt64_t
 
˛c
;

1136 i‡(!
	`is_h≥t_íabÀd
())

1139 i‡(
‰eq
 <
DEFAULT_RTC_INT_FREQ
)

1140 
h≥t_põ_limô
 = 
DEFAULT_RTC_INT_FREQ
 / 
‰eq
;

1142 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1143 
	`do_div
(
˛c
, 
‰eq
);

1144 
˛c
 >>
h≥t_˛ockevít
.
shi·
;

1145 
h≥t_põ_dñè
 = 
˛c
;

1148 
	}
}

1149 
EXPORT_SYMBOL_GPL
(
h≥t_£t_≥riodic_‰eq
);

1151 
	$h≥t_πc_dr›≥d_úq
()

1153  
	`is_h≥t_íabÀd
();

1154 
	}
}

1155 
EXPORT_SYMBOL_GPL
(
h≥t_πc_dr›≥d_úq
);

1157 
	$h≥t_πc_timî_ªöô
()

1159 
cfg
, 
dñè
;

1160 
lo°_öts
 = -1;

1162 i‡(
	`u∆ikñy
(!
h≥t_πc_Êags
)) {

1163 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1164 
cfg
 &~
HPET_TN_ENABLE
;

1165 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1169 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1170 
dñè
 = 
h≥t_deÁu…_dñè
;

1172 
dñè
 = 
h≥t_põ_dñè
;

1179 
h≥t_t1_cmp
 +
dñè
;

1180 
	`h≥t_wrôñ
(
h≥t_t1_cmp
, 
HPET_T1_CMP
);

1181 
lo°_öts
++;

1182 } !
	`h≥t_˙t_ahód
(
h≥t_t1_cmp
, 
	`h≥t_ªadl
(
HPET_COUNTER
)));

1184 i‡(
lo°_öts
) {

1185 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
)

1186 
h≥t_põ_cou¡
 +
lo°_öts
;

1187 i‡(
	`¥ötk_øãlimô
())

1188 
	`¥ötk
(
KERN_WARNING
 "hpet1:Üost %dÑtc interrupts\n",

1189 
lo°_öts
);

1191 
	}
}

1193 
úqªtu∫_t
 
	$h≥t_πc_öãºu±
(
úq
, *
dev_id
)

1195 
πc_time
 
cuº_time
;

1196 
πc_öt_Êag
 = 0;

1198 
	`h≥t_πc_timî_ªöô
();

1199 
	`mem£t
(&
cuº_time
, 0, (
πc_time
));

1201 i‡(
h≥t_πc_Êags
 & (
RTC_UIE
 | 
RTC_AIE
))

1202 
	`gë_πc_time
(&
cuº_time
);

1204 i‡(
h≥t_πc_Êags
 & 
RTC_UIE
 &&

1205 
cuº_time
.
tm_£c
 !
h≥t_¥ev_upd©e_£c
) {

1206 i‡(
h≥t_¥ev_upd©e_£c
 >= 0)

1207 
πc_öt_Êag
 = 
RTC_UF
;

1208 
h≥t_¥ev_upd©e_£c
 = 
cuº_time
.
tm_£c
;

1211 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
 &&

1212 ++
h≥t_põ_cou¡
 >
h≥t_põ_limô
) {

1213 
πc_öt_Êag
 |
RTC_PF
;

1214 
h≥t_põ_cou¡
 = 0;

1217 i‡(
h≥t_πc_Êags
 & 
RTC_AIE
 &&

1218 (
cuº_time
.
tm_£c
 =
h≥t_Æ¨m_time
.tm_sec) &&

1219 (
cuº_time
.
tm_mö
 =
h≥t_Æ¨m_time
.tm_min) &&

1220 (
cuº_time
.
tm_hour
 =
h≥t_Æ¨m_time
.tm_hour))

1221 
πc_öt_Êag
 |
RTC_AF
;

1223 i‡(
πc_öt_Êag
) {

1224 
πc_öt_Êag
 |(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1225 i‡(
úq_h™dÀr
)

1226 
	`úq_h™dÀr
(
πc_öt_Êag
, 
dev_id
);

1228  
IRQ_HANDLED
;

1229 
	}
}

1230 
EXPORT_SYMBOL_GPL
(
h≥t_πc_öãºu±
);

	@/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c

30 
	~<löux/≥rf_evít.h
>

31 
	~<löux/hw_bªakpoöt.h
>

32 
	~<löux/úqÊags.h
>

33 
	~<löux/nŸifõr.h
>

34 
	~<löux/kÆlsyms.h
>

35 
	~<löux/k¥obes.h
>

36 
	~<löux/≥r˝u.h
>

37 
	~<löux/kdebug.h
>

38 
	~<löux/kî√l.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/sched.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/smp.h
>

44 
	~<asm/hw_bªakpoöt.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/debugªg.h
>

49 
DEFINE_PER_CPU
(, 
˝u_dr7
);

50 
EXPORT_PER_CPU_SYMBOL
(
˝u_dr7
);

53 
DEFINE_PER_CPU
(, 
˝u_debugªg
[
HBP_NUM
]);

59 
DEFINE_PER_CPU
(
≥rf_evít
 *, 
bp_≥r_ªg
[
HBP_NUM
]);

62 
ölöe
 

63 
	$__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

65 
bp_öfo
;

67 
bp_öfo
 = (
Àn
 | 
ty≥
) & 0xf;

68 
bp_öfo
 <<(
DR_CONTROL_SHIFT
 + 
d∫um
 * 
DR_CONTROL_SIZE
);

69 
bp_öfo
 |(
DR_GLOBAL_ENABLE
 << (
d∫um
 * 
DR_ENABLE_SIZE
));

71  
bp_öfo
;

72 
	}
}

78 
	$ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

80  
	`__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
Ë| 
DR_GLOBAL_SLOWDOWN
;

81 
	}
}

87 
	$decode_dr7
(
dr7
, 
b≤um
, *
Àn
, *
ty≥
)

89 
bp_öfo
 = 
dr7
 >> (
DR_CONTROL_SHIFT
 + 
b≤um
 * 
DR_CONTROL_SIZE
);

91 *
Àn
 = (
bp_öfo
 & 0xc) | 0x40;

92 *
ty≥
 = (
bp_öfo
 & 0x3) | 0x80;

94  (
dr7
 >> (
b≤um
 * 
DR_ENABLE_SIZE
)) & 0x3;

95 
	}
}

106 
	$¨ch_ö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

108 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

109 *
dr7
;

110 
i
;

112 
i
 = 0; i < 
HBP_NUM
; i++) {

113 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

115 i‡(!*
¶Ÿ
) {

116 *
¶Ÿ
 = 
bp
;

121 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

122  -
EBUSY
;

124 
	`£t_debugªg
(
öfo
->
addªss
, 
i
);

125 
	`__gë_˝u_v¨
(
˝u_debugªg
[
i
]Ë
öfo
->
addªss
;

127 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

128 *
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

130 
	`£t_debugªg
(*
dr7
, 7);

133 
	}
}

144 
	$¨ch_unö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

146 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

147 *
dr7
;

148 
i
;

150 
i
 = 0; i < 
HBP_NUM
; i++) {

151 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

153 i‡(*
¶Ÿ
 =
bp
) {

154 *
¶Ÿ
 = 
NULL
;

159 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

162 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

163 *
dr7
 &~
	`__ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

165 
	`£t_debugªg
(*
dr7
, 7);

166 
	}
}

168 
	$gë_hbp_Àn
(
u8
 
hbp_Àn
)

170 
Àn_ö_byãs
 = 0;

172 
hbp_Àn
) {

173 
X86_BREAKPOINT_LEN_1
:

174 
Àn_ö_byãs
 = 1;

176 
X86_BREAKPOINT_LEN_2
:

177 
Àn_ö_byãs
 = 2;

179 
X86_BREAKPOINT_LEN_4
:

180 
Àn_ö_byãs
 = 4;

182 #ifde‡
CONFIG_X86_64


183 
X86_BREAKPOINT_LEN_8
:

184 
Àn_ö_byãs
 = 8;

188  
Àn_ö_byãs
;

189 
	}
}

194 
	$¨ch_check_va_ö_u£r•a˚
(
va
, 
u8
 
hbp_Àn
)

196 
Àn
;

198 
Àn
 = 
	`gë_hbp_Àn
(
hbp_Àn
);

200  (
va
 <
TASK_SIZE
 - 
Àn
);

201 
	}
}

206 
	$¨ch_check_va_ö_kî√l•a˚
(
va
, 
u8
 
hbp_Àn
)

208 
Àn
;

210 
Àn
 = 
	`gë_hbp_Àn
(
hbp_Àn
);

212  (
va
 >
TASK_SIZE
Ë&& ((v®+ 
Àn
 - 1) >= TASK_SIZE);

213 
	}
}

215 
	$¨ch_bp_gíîic_fõlds
(
x86_Àn
, 
x86_ty≥
,

216 *
gí_Àn
, *
gí_ty≥
)

219 
x86_Àn
) {

220 
X86_BREAKPOINT_LEN_1
:

221 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_1
;

223 
X86_BREAKPOINT_LEN_2
:

224 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_2
;

226 
X86_BREAKPOINT_LEN_4
:

227 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_4
;

229 #ifde‡
CONFIG_X86_64


230 
X86_BREAKPOINT_LEN_8
:

231 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_8
;

235  -
EINVAL
;

239 
x86_ty≥
) {

240 
X86_BREAKPOINT_EXECUTE
:

241 *
gí_ty≥
 = 
HW_BREAKPOINT_X
;

243 
X86_BREAKPOINT_WRITE
:

244 *
gí_ty≥
 = 
HW_BREAKPOINT_W
;

246 
X86_BREAKPOINT_RW
:

247 *
gí_ty≥
 = 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
;

250  -
EINVAL
;

254 
	}
}

257 
	$¨ch_buûd_bp_öfo
(
≥rf_evít
 *
bp
)

259 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

261 
öfo
->
addªss
 = 
bp
->
©å
.
bp_addr
;

264 
bp
->
©å
.
bp_Àn
) {

265 
HW_BREAKPOINT_LEN_1
:

266 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_1
;

268 
HW_BREAKPOINT_LEN_2
:

269 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_2
;

271 
HW_BREAKPOINT_LEN_4
:

272 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_4
;

274 #ifde‡
CONFIG_X86_64


275 
HW_BREAKPOINT_LEN_8
:

276 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_8
;

280  -
EINVAL
;

284 
bp
->
©å
.
bp_ty≥
) {

285 
HW_BREAKPOINT_W
:

286 
öfo
->
ty≥
 = 
X86_BREAKPOINT_WRITE
;

288 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
:

289 
öfo
->
ty≥
 = 
X86_BREAKPOINT_RW
;

291 
HW_BREAKPOINT_X
:

292 
öfo
->
ty≥
 = 
X86_BREAKPOINT_EXECUTE
;

295  -
EINVAL
;

299 
	}
}

303 
	$¨ch_vÆid©e_hwbk±_£âögs
(
≥rf_evít
 *
bp
,

304 
èsk_°ru˘
 *
tsk
)

306 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

307 
Æign
;

308 
ªt
;

311 
ªt
 = 
	`¨ch_buûd_bp_öfo
(
bp
);

312 i‡(
ªt
)

313  
ªt
;

315 
ªt
 = -
EINVAL
;

317 i‡(
öfo
->
ty≥
 =
X86_BREAKPOINT_EXECUTE
)

323 i‡((!
	`¨ch_check_va_ö_u£r•a˚
(
öfo
->
addªss
, info->
Àn
)) &&

324 
öfo
->
Àn
 !
X86_BREAKPOINT_EXECUTE
)

325  
ªt
;

327 
öfo
->
Àn
) {

328 
X86_BREAKPOINT_LEN_1
:

329 
Æign
 = 0;

331 
X86_BREAKPOINT_LEN_2
:

332 
Æign
 = 1;

334 
X86_BREAKPOINT_LEN_4
:

335 
Æign
 = 3;

337 #ifde‡
CONFIG_X86_64


338 
X86_BREAKPOINT_LEN_8
:

339 
Æign
 = 7;

343  
ªt
;

350 i‡(
öfo
->
«me
)

351 
öfo
->
addªss
 = ()

352 
	`kÆlsyms_lookup_«me
(
öfo
->
«me
);

357 i‡(
öfo
->
addªss
 & 
Æign
)

358  -
EINVAL
;

361 i‡(
tsk
) {

362 i‡(!
	`¨ch_check_va_ö_u£r•a˚
(
öfo
->
addªss
, info->
Àn
))

363  -
EFAULT
;

365 i‡(!
	`¨ch_check_va_ö_kî√l•a˚
(
öfo
->
addªss
, info->
Àn
))

366  -
EFAULT
;

370 
	}
}

380 
	$aout_dump_debugªgs
(
u£r
 *
dump
)

382 
i
;

383 
dr7
 = 0;

384 
≥rf_evít
 *
bp
;

385 
¨ch_hw_bªakpoöt
 *
öfo
;

386 
thªad_°ru˘
 *
thªad
 = &
cuºít
->thread;

388 
i
 = 0; i < 
HBP_NUM
; i++) {

389 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

391 i‡(
bp
 && !bp->
©å
.
dißbÀd
) {

392 
dump
->
u_debugªg
[
i
] = 
bp
->
©å
.
bp_addr
;

393 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

394 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

396 
dump
->
u_debugªg
[
i
] = 0;

400 
dump
->
u_debugªg
[4] = 0;

401 
dump
->
u_debugªg
[5] = 0;

402 
dump
->
u_debugªg
[6] = 
cuºít
->
thªad
.
debugªg6
;

404 
dump
->
u_debugªg
[7] = 
dr7
;

405 
	}
}

406 
EXPORT_SYMBOL_GPL
(
aout_dump_debugªgs
);

411 
	$Êush_±ø˚_hw_bªakpoöt
(
èsk_°ru˘
 *
tsk
)

413 
i
;

414 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

416 
i
 = 0; i < 
HBP_NUM
; i++) {

417 
	`uƒegi°î_hw_bªakpoöt
(
t
->
±ø˚_bps
[
i
]);

418 
t
->
±ø˚_bps
[
i
] = 
NULL
;

420 
	}
}

422 
	$hw_bªakpoöt_ª°‹e
()

424 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[0]), 0);

425 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[1]), 1);

426 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[2]), 2);

427 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[3]), 3);

428 
	`£t_debugªg
(
cuºít
->
thªad
.
debugªg6
, 6);

429 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_dr7
), 7);

430 
	}
}

431 
EXPORT_SYMBOL_GPL
(
hw_bªakpoöt_ª°‹e
);

449 
__k¥obes
 
	$hw_bªakpoöt_h™dÀr
(
dõ_¨gs
 *
¨gs
)

451 
i
, 
˝u
, 
rc
 = 
NOTIFY_STOP
;

452 
≥rf_evít
 *
bp
;

453 
dr7
, 
dr6
;

454 *
dr6_p
;

457 
dr6_p
 = (*)
	`ERR_PTR
(
¨gs
->
îr
);

458 
dr6
 = *
dr6_p
;

461 i‡((
dr6
 & 
DR_TRAP_BITS
) == 0)

462  
NOTIFY_DONE
;

464 
	`gë_debugªg
(
dr7
, 7);

466 
	`£t_debugªg
(0UL, 7);

472 
cuºít
->
thªad
.
debugªg6
 &~
DR_TRAP_BITS
;

473 
˝u
 = 
	`gë_˝u
();

476 
i
 = 0; i < 
HBP_NUM
; ++i) {

477 i‡(
	`likñy
(!(
dr6
 & (
DR_TRAP0
 << 
i
))))

486 
	`rcu_ªad_lock
();

488 
bp
 = 
	`≥r_˝u
(
bp_≥r_ªg
[
i
], 
˝u
);

489 i‡(
bp
)

490 
rc
 = 
NOTIFY_DONE
;

495 (*
dr6_p
Ë&~(
DR_TRAP0
 << 
i
);

500 i‡(!
bp
) {

501 
	`rcu_ªad_u∆ock
();

505 
	`≥rf_bp_evít
(
bp
, 
¨gs
->
ªgs
);

507 
	`rcu_ªad_u∆ock
();

509 i‡(
dr6
 & (~
DR_TRAP_BITS
))

510 
rc
 = 
NOTIFY_DONE
;

512 
	`£t_debugªg
(
dr7
, 7);

513 
	`put_˝u
();

515  
rc
;

516 
	}
}

521 
__k¥obes
 
	$hw_bªakpoöt_ex˚±i⁄s_nŸify
(

522 
nŸifõr_block
 *
unu£d
, 
vÆ
, *
d©a
)

524 i‡(
vÆ
 !
DIE_DEBUG
)

525  
NOTIFY_DONE
;

527  
	`hw_bªakpoöt_h™dÀr
(
d©a
);

528 
	}
}

530 
	$hw_bªakpoöt_pmu_ªad
(
≥rf_evít
 *
bp
)

533 
	}
}

535 
	$hw_bªakpoöt_pmu_u¡hrŸée
(
≥rf_evít
 *
bp
)

538 
	}
}

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/ªg£t.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/sigc⁄ãxt.h
>

13 
	~<asm/¥o˚ss‹.h
>

14 
	~<asm/m©h_emu.h
>

15 
	~<asm/uac˚ss.h
>

16 
	~<asm/±ø˚.h
>

17 
	~<asm/i387.h
>

18 
	~<asm/u£r.h
>

20 #ifde‡
CONFIG_X86_64


21 
	~<asm/sigc⁄ãxt32.h
>

22 
	~<asm/u£r32.h
>

24 
	#ßve_i387_x°©e_ü32
 
ßve_i387_x°©e


	)

25 
	#ª°‹e_i387_x°©e_ü32
 
ª°‹e_i387_x°©e


	)

26 
	#_Â°©e_ü32
 
_Â°©e


	)

27 
	#_x°©e_ü32
 
_x°©e


	)

28 
	#sig_x°©e_ü32_size
 
sig_x°©e_size


	)

29 
	#fx_sw_ª£rved_ü32
 
fx_sw_ª£rved


	)

30 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

31 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

34 #ifde‡
CONFIG_MATH_EMULATION


35 
	#HAVE_HWFP
 (
boŸ_˝u_d©a
.
h¨d_m©h
)

	)

37 
	#HAVE_HWFP
 1

	)

40 
mxc§_„©uª_mask
 
	g__ªad_mo°ly
 = 0xffffffffu;

41 
	gx°©e_size
;

42 
	gsig_x°©e_ü32_size
 = (
_Â°©e_ü32
);

43 
i387_fxßve_°ru˘
 
fx_s¸©ch
 
	g__˝uöôd©a
;

45 
__˝uöô
 
	$mxc§_„©uª_mask_öô
()

47 
mask
 = 0;

49 
	`˛ts
();

50 i‡(
˝u_has_fx§
) {

51 
	`mem£t
(&
fx_s¸©ch
, 0, (
i387_fxßve_°ru˘
));

52 
asm
 vﬁ©ûe("fxßvê%0" : : "m" (
fx_s¸©ch
));

53 
mask
 = 
fx_s¸©ch
.
mxc§_mask
;

54 i‡(
mask
 == 0)

55 
mask
 = 0x0000ffbf;

57 
mxc§_„©uª_mask
 &
mask
;

58 
	`°ts
();

59 
	}
}

61 
__˝uöô
 
	$öô_thªad_x°©e
()

63 i‡(!
HAVE_HWFP
) {

64 
x°©e_size
 = (
i387_so·_°ru˘
);

68 i‡(
˝u_has_xßve
) {

69 
	`xßve_˙txt_öô
();

73 i‡(
˝u_has_fx§
)

74 
x°©e_size
 = (
i387_fxßve_°ru˘
);

75 #ifde‡
CONFIG_X86_32


77 
x°©e_size
 = (
i387_fßve_°ru˘
);

79 
	}
}

81 #ifde‡
CONFIG_X86_64


86 
__˝uöô
 
	$Âu_öô
()

88 
ﬁd¸0
 = 
	`ªad_¸0
();

90 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

91 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

93 
	`wrôe_¸0
(
ﬁd¸0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

98 i‡(!
	`smp_¥o˚ss‹_id
())

99 
	`öô_thªad_x°©e
();

100 
	`xßve_öô
();

102 
	`mxc§_„©uª_mask_öô
();

104 i‡(
˝u_has_xßve
)

105 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

107 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

108 
	`˛ór_u£d_m©h
();

109 
	}
}

118 
	$öô_Âu
(
èsk_°ru˘
 *
tsk
)

120 i‡(
	`tsk_u£d_m©h
(
tsk
)) {

121 i‡(
HAVE_HWFP
 && 
tsk
 =
cuºít
)

122 
	`u∆azy_Âu
(
tsk
);

129 i‡(!
tsk
->
thªad
.
x°©e
) {

130 
tsk
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

131 
GFP_KERNEL
);

132 i‡(!
tsk
->
thªad
.
x°©e
)

133  -
ENOMEM
;

136 #ifde‡
CONFIG_X86_32


137 i‡(!
HAVE_HWFP
) {

138 
	`mem£t
(
tsk
->
thªad
.
x°©e
, 0, 
x°©e_size
);

139 
	`föô_èsk
(
tsk
);

140 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

145 i‡(
˝u_has_fx§
) {

146 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

148 
	`mem£t
(
fx
, 0, 
x°©e_size
);

149 
fx
->
cwd
 = 0x37f;

150 i‡(
˝u_has_xmm
)

151 
fx
->
mxc§
 = 
MXCSR_DEFAULT
;

153 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

154 
	`mem£t
(
Â
, 0, 
x°©e_size
);

155 
Â
->
cwd
 = 0xffff037fu;

156 
Â
->
swd
 = 0xffff0000u;

157 
Â
->
twd
 = 0xffffffffu;

158 
Â
->
fos
 = 0xffff0000u;

163 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

165 
	}
}

167 
	$Âªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

169  
	`tsk_u£d_m©h
(
èrgë
Ë? 
ªg£t
->
n
 : 0;

170 
	}
}

172 
	$xÂªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

174  (
˝u_has_fx§
 && 
	`tsk_u£d_m©h
(
èrgë
)Ë? 
ªg£t
->
n
 : 0;

175 
	}
}

177 
	$xÂªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

178 
pos
, 
cou¡
,

179 *
kbuf
, 
__u£r
 *
ubuf
)

181 
ªt
;

183 i‡(!
˝u_has_fx§
)

184  -
ENODEV
;

186 
ªt
 = 
	`öô_Âu
(
èrgë
);

187 i‡(
ªt
)

188  
ªt
;

190  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

191 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

192 
	}
}

194 
	$xÂªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
ªt
;

200 i‡(!
˝u_has_fx§
)

201  -
ENODEV
;

203 
ªt
 = 
	`öô_Âu
(
èrgë
);

204 i‡(
ªt
)

205  
ªt
;

207 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

209 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

210 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

215 
èrgë
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

221 i‡(
˝u_has_xßve
)

222 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

224  
ªt
;

225 
	}
}

227 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


233 
ölöe
 
	$twd_i387_to_fx§
(
twd
)

235 
tmp
;

238 
tmp
 = ~
twd
;

239 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

241 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

242 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

243 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

245  
tmp
;

246 
	}
}

248 
	#FPREG_ADDR
(
f
, 
n
Ë((*)&(f)->
°_•a˚
 + (nË* 16);

	)

249 
	#FP_EXP_TAG_VALID
 0

	)

250 
	#FP_EXP_TAG_ZERO
 1

	)

251 
	#FP_EXP_TAG_SPECIAL
 2

	)

252 
	#FP_EXP_TAG_EMPTY
 3

	)

254 
ölöe
 
u32
 
	$twd_fx§_to_i387
(
i387_fxßve_°ru˘
 *
fxßve
)

256 
_Âxªg
 *
°
;

257 
u32
 
tos
 = (
fxßve
->
swd
 >> 11) & 7;

258 
u32
 
twd
 = (Ë
fxßve
->twd;

259 
u32
 
èg
;

260 
u32
 
ªt
 = 0xffff0000u;

261 
i
;

263 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

264 i‡(
twd
 & 0x1) {

265 
°
 = 
	`FPREG_ADDR
(
fxßve
, (
i
 - 
tos
) & 7);

267 
°
->
exp⁄ít
 & 0x7fff) {

269 
èg
 = 
FP_EXP_TAG_SPECIAL
;

272 i‡(!
°
->
signifiˇnd
[0] &&

273 !
°
->
signifiˇnd
[1] &&

274 !
°
->
signifiˇnd
[2] &&

275 !
°
->
signifiˇnd
[3])

276 
èg
 = 
FP_EXP_TAG_ZERO
;

278 
èg
 = 
FP_EXP_TAG_SPECIAL
;

281 i‡(
°
->
signifiˇnd
[3] & 0x8000)

282 
èg
 = 
FP_EXP_TAG_VALID
;

284 
èg
 = 
FP_EXP_TAG_SPECIAL
;

288 
èg
 = 
FP_EXP_TAG_EMPTY
;

290 
ªt
 |
èg
 << (2 * 
i
);

292  
ªt
;

293 
	}
}

300 
	$c⁄vît_‰om_fx§
(
u£r_i387_ü32_°ru˘
 *
ív
, 
èsk_°ru˘
 *
tsk
)

302 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

303 
_Âªg
 *
to
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

304 
_Âxªg
 *
‰om
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

305 
i
;

307 
ív
->
cwd
 = 
fxßve
->cwd | 0xffff0000u;

308 
ív
->
swd
 = 
fxßve
->swd | 0xffff0000u;

309 
ív
->
twd
 = 
	`twd_fx§_to_i387
(
fxßve
);

311 #ifde‡
CONFIG_X86_64


312 
ív
->
fù
 = 
fxßve
->
rù
;

313 
ív
->
foo
 = 
fxßve
->
rdp
;

314 i‡(
tsk
 =
cuºít
) {

319 
	`asm
("mov %%ds, %[fos]" : [
fos
] "Ù" (
ív
->fos));

320 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "Ù" (
ív
->fcs));

322 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

324 
ív
->
fos
 = 0xffff0000 | 
tsk
->
thªad
.
ds
;

325 
ív
->
fcs
 = 
ªgs
->
cs
;

328 
ív
->
fù
 = 
fxßve
->fip;

329 
ív
->
fcs
 = (
u16
Ë
fxßve
->fc†| ((
u32
Ëfxßve->
f›
 << 16);

330 
ív
->
foo
 = 
fxßve
->foo;

331 
ív
->
fos
 = 
fxßve
->fos;

334 
i
 = 0; i < 8; ++i)

335 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (to[0]));

336 
	}
}

338 
	$c⁄vît_to_fx§
(
èsk_°ru˘
 *
tsk
,

339 c⁄° 
u£r_i387_ü32_°ru˘
 *
ív
)

342 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

343 
_Âªg
 *
‰om
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

344 
_Âxªg
 *
to
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

345 
i
;

347 
fxßve
->
cwd
 = 
ív
->cwd;

348 
fxßve
->
swd
 = 
ív
->swd;

349 
fxßve
->
twd
 = 
	`twd_i387_to_fx§
(
ív
->twd);

350 
fxßve
->
f›
 = (
u16
Ë((
u32
Ë
ív
->
fcs
 >> 16);

351 #ifde‡
CONFIG_X86_64


352 
fxßve
->
rù
 = 
ív
->
fù
;

353 
fxßve
->
rdp
 = 
ív
->
foo
;

356 
fxßve
->
fù
 = 
ív
->fip;

357 
fxßve
->
fcs
 = (
ív
->fcs & 0xffff);

358 
fxßve
->
foo
 = 
ív
->foo;

359 
fxßve
->
fos
 = 
ív
->fos;

362 
i
 = 0; i < 8; ++i)

363 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (from[0]));

364 
	}
}

366 
	$Âªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

367 
pos
, 
cou¡
,

368 *
kbuf
, 
__u£r
 *
ubuf
)

370 
u£r_i387_ü32_°ru˘
 
ív
;

371 
ªt
;

373 
ªt
 = 
	`öô_Âu
(
èrgë
);

374 i‡(
ªt
)

375  
ªt
;

377 i‡(!
HAVE_HWFP
)

378  
	`Âªgs_so·_gë
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

380 i‡(!
˝u_has_fx§
) {

381  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

382 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0,

386 i‡(
kbuf
 && 
pos
 =0 && 
cou¡
 =(
ív
)) {

387 
	`c⁄vît_‰om_fx§
(
kbuf
, 
èrgë
);

391 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

393  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

394 
	}
}

396 
	$Âªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

397 
pos
, 
cou¡
,

398 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

400 
u£r_i387_ü32_°ru˘
 
ív
;

401 
ªt
;

403 
ªt
 = 
	`öô_Âu
(
èrgë
);

404 i‡(
ªt
)

405  
ªt
;

407 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

409 i‡(!
HAVE_HWFP
)

410  
	`Âªgs_so·_£t
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

412 i‡(!
˝u_has_fx§
) {

413  
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

414 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0, -1);

417 i‡(
pos
 > 0 || 
cou¡
 < (
ív
))

418 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

420 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

421 i‡(!
ªt
)

422 
	`c⁄vît_to_fx§
(
èrgë
, &
ív
);

428 i‡(
˝u_has_xßve
)

429 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FP
;

430  
ªt
;

431 
	}
}

437 
ölöe
 
	$ßve_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

439 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

440 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

442 
Â
->
°©us
 = fp->
swd
;

443 i‡(
	`__c›y_to_u£r
(
buf
, 
Â
, (
i387_fßve_°ru˘
)))

446 
	}
}

448 
	$ßve_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

450 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

451 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

452 
u£r_i387_ü32_°ru˘
 
ív
;

453 
îr
 = 0;

455 
	`c⁄vît_‰om_fx§
(&
ív
, 
tsk
);

456 i‡(
	`__c›y_to_u£r
(
buf
, &
ív
, (env)))

459 
îr
 |
	`__put_u£r
(
fx
->
swd
, &
buf
->
°©us
);

460 
îr
 |
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

461 i‡(
îr
)

464 i‡(
	`__c›y_to_u£r
(&
buf
->
_fx§_ív
[0], 
fx
, 
x°©e_size
))

467 
	}
}

469 
	$ßve_i387_xßve
(
__u£r
 *
buf
)

471 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

472 
_Â°©e_ü32
 
__u£r
 *
fx
 = 
buf
;

473 
îr
 = 0;

486 
tsk
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

488 i‡(
	`ßve_i387_fxßve
(
fx
) < 0)

491 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved_ü32
,

492 (
_Âx_sw_byãs
));

493 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

494 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_ü32_size


495 - 
FP_XSTATE_MAGIC2_SIZE
));

496 i‡(
îr
)

500 
	}
}

502 
	$ßve_i387_x°©e_ü32
(
__u£r
 *
buf
)

504 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

505 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

507 i‡(!
	`u£d_m©h
())

510 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_ü32_size
))

511  -
EACCES
;

516 
	`˛ór_u£d_m©h
();

518 i‡(!
HAVE_HWFP
) {

519  
	`Âªgs_so·_gë
(
cuºít
, 
NULL
,

520 0, (
u£r_i387_ü32_°ru˘
),

521 
NULL
, 
Â
) ? -1 : 1;

524 
	`u∆azy_Âu
(
tsk
);

526 i‡(
˝u_has_xßve
)

527  
	`ßve_i387_xßve
(
Â
);

528 i‡(
˝u_has_fx§
)

529  
	`ßve_i387_fxßve
(
Â
);

531  
	`ßve_i387_fßve
(
Â
);

532 
	}
}

534 
ölöe
 
	$ª°‹e_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

536 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

538  
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fßve
, 
buf
,

539 (
i387_fßve_°ru˘
));

540 
	}
}

542 
	$ª°‹e_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
,

543 
size
)

545 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

546 
u£r_i387_ü32_°ru˘
 
ív
;

547 
îr
;

549 
îr
 = 
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fxßve
, &
buf
->
_fx§_ív
[0],

550 
size
);

552 
tsk
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

553 i‡(
îr
 || 
	`__c›y_‰om_u£r
(&
ív
, 
buf
, (env)))

555 
	`c⁄vît_to_fx§
(
tsk
, &
ív
);

558 
	}
}

560 
	$ª°‹e_i387_xßve
(
__u£r
 *
buf
)

562 
_Âx_sw_byãs
 
fx_sw_u£r
;

563 
_Â°©e_ü32
 
__u£r
 *
fx_u£r
 =

564 ((
_Â°©e_ü32
 
__u£r
 *Ë
buf
);

565 
i387_fxßve_°ru˘
 
__u£r
 *
fx
 =

566 (
i387_fxßve_°ru˘
 
__u£r
 *Ë&
fx_u£r
->
_fx§_ív
[0];

567 
xßve_hdr_°ru˘
 *
xßve_hdr
 =

568 &
cuºít
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
;

569 
u64
 
mask
;

570 
îr
;

572 i‡(
	`check_f‹_x°©e
(
fx
, 
buf
, &
fx_sw_u£r
))

573 
fx_⁄ly
;

575 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

577 
îr
 = 
	`ª°‹e_i387_fxßve
(
buf
, 
fx_sw_u£r
.
x°©e_size
);

579 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

583 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

589 
mask
 = ~(
p˙txt_mask
 & ~mask);

590 
xßve_hdr
->
x°©e_bv
 &
mask
;

592  
îr
;

593 
fx_⁄ly
:

599 
xßve_hdr
->
x°©e_bv
 = 
XSTATE_FPSSE
;

600  
	`ª°‹e_i387_fxßve
(
buf
, (
i387_fxßve_°ru˘
));

601 
	}
}

603 
	$ª°‹e_i387_x°©e_ü32
(
__u£r
 *
buf
)

605 
îr
;

606 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

607 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

609 i‡(
HAVE_HWFP
)

610 
	`˛ór_Âu
(
tsk
);

612 i‡(!
buf
) {

613 i‡(
	`u£d_m©h
()) {

614 
	`˛ór_Âu
(
tsk
);

615 
	`˛ór_u£d_m©h
();

620 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_ü32_size
))

621  -
EACCES
;

623 i‡(!
	`u£d_m©h
()) {

624 
îr
 = 
	`öô_Âu
(
tsk
);

625 i‡(
îr
)

626  
îr
;

629 i‡(
HAVE_HWFP
) {

630 i‡(
˝u_has_xßve
)

631 
îr
 = 
	`ª°‹e_i387_xßve
(
buf
);

632 i‡(
˝u_has_fx§
)

633 
îr
 = 
	`ª°‹e_i387_fxßve
(
Â
, (

634 
i387_fxßve_°ru˘
));

636 
îr
 = 
	`ª°‹e_i387_fßve
(
Â
);

638 
îr
 = 
	`Âªgs_so·_£t
(
cuºít
, 
NULL
,

639 0, (
u£r_i387_ü32_°ru˘
),

640 
NULL
, 
Â
) != 0;

642 
	`£t_u£d_m©h
();

644  
îr
;

645 
	}
}

654 
	$dump_Âu
(
±_ªgs
 *
ªgs
, 
u£r_i387_°ru˘
 *
Âu
)

656 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

657 
ÂvÆid
;

659 
ÂvÆid
 = !!
	`u£d_m©h
();

660 i‡(
ÂvÆid
)

661 
ÂvÆid
 = !
	`Âªgs_gë
(
tsk
, 
NULL
,

662 0, (
u£r_i387_ü32_°ru˘
),

663 
Âu
, 
NULL
);

665  
ÂvÆid
;

666 
	}
}

667 
EXPORT_SYMBOL
(
dump_Âu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<löux/öô.h
>

13 
	~<löux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_ªsume
(
sys_devi˚
 *
dev
)

26 
Êags
;

27 
i
;

29 
Êags
 = 
	`˛aim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_cou¡
(
i
, 1);

41 
	`íabÀ_dma
(4);

43 
	`ªÀa£_dma_lock
(
Êags
);

46 
	}
}

48 
	$i8237A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

51 
	}
}

53 
sysdev_˛ass
 
	gi8237_sysdev_˛ass
 = {

54 .
«me
 = "i8237",

55 .
	gsu•íd
 = 
i8237A_su•íd
,

56 .
	gªsume
 = 
i8237A_ªsume
,

59 
sys_devi˚
 
	gdevi˚_i8237A
 = {

60 .
id
 = 0,

61 .
	g˛s
 = &
i8237_sysdev_˛ass
,

64 
__öô
 
	$i8237A_öô_sysfs
()

66 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8237_sysdev_˛ass
);

67 i‡(!
îr‹
)

68 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8237A
);

69  
îr‹
;

70 
	}
}

71 
devi˚_öôˇŒ
(
i8237A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<löux/˛ockchùs.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/jiffõs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/io.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

17 
	~<asm/smp.h
>

19 
DEFINE_SPINLOCK
(
i8253_lock
);

20 
EXPORT_SYMBOL
(
i8253_lock
);

26 
˛ock_evít_devi˚
 *
	gglobÆ_˛ock_evít
;

33 
	$öô_pô_timî
(
˛ock_evít_mode
 
mode
,

34 
˛ock_evít_devi˚
 *
evt
)

36 
	`•ö_lock
(&
i8253_lock
);

38 
mode
) {

39 
CLOCK_EVT_MODE_PERIODIC
:

41 
	`outb_pô
(0x34, 
PIT_MODE
);

42 
	`outb_pô
(
LATCH
 & 0xf‡, 
PIT_CH0
);

43 
	`outb_pô
(
LATCH
 >> 8 , 
PIT_CH0
);

46 
CLOCK_EVT_MODE_SHUTDOWN
:

47 
CLOCK_EVT_MODE_UNUSED
:

48 i‡(
evt
->
mode
 =
CLOCK_EVT_MODE_PERIODIC
 ||

49 
evt
->
mode
 =
CLOCK_EVT_MODE_ONESHOT
) {

50 
	`outb_pô
(0x30, 
PIT_MODE
);

51 
	`outb_pô
(0, 
PIT_CH0
);

52 
	`outb_pô
(0, 
PIT_CH0
);

56 
CLOCK_EVT_MODE_ONESHOT
:

58 
	`outb_pô
(0x38, 
PIT_MODE
);

61 
CLOCK_EVT_MODE_RESUME
:

65 
	`•ö_u∆ock
(&
i8253_lock
);

66 
	}
}

73 
	$pô_√xt_evít
(
dñè
, 
˛ock_evít_devi˚
 *
evt
)

75 
	`•ö_lock
(&
i8253_lock
);

76 
	`outb_pô
(
dñè
 & 0xf‡, 
PIT_CH0
);

77 
	`outb_pô
(
dñè
 >> 8 , 
PIT_CH0
);

78 
	`•ö_u∆ock
(&
i8253_lock
);

81 
	}
}

91 
˛ock_evít_devi˚
 
	gpô_˚
 = {

92 .
«me
 = "pit",

93 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

94 .
	g£t_mode
 = 
öô_pô_timî
,

95 .
	g£t_√xt_evít
 = 
pô_√xt_evít
,

96 .
	gshi·
 = 32,

97 .
	gúq
 = 0,

104 
__öô
 
	$£tup_pô_timî
()

110 
pô_˚
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

111 
pô_˚
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,Öô_˚.
shi·
);

112 
pô_˚
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFF, &pit_ce);

113 
pô_˚
.
mö_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0xF, &pit_ce);

115 
	`˛ockevíts_ªgi°î_devi˚
(&
pô_˚
);

116 
globÆ_˛ock_evít
 = &
pô_˚
;

117 
	}
}

119 #i‚de‡
CONFIG_X86_64


125 
cy˛e_t
 
	$pô_ªad
(
˛ocksour˚
 *
cs
)

127 
ﬁd_cou¡
;

128 
u32
 
ﬁd_jifs
;

129 
Êags
;

130 
cou¡
;

131 
u32
 
jifs
;

133 
	`•ö_lock_úqßve
(&
i8253_lock
, 
Êags
);

147 
jifs
 = 
jiffõs
;

148 
	`outb_pô
(0x00, 
PIT_MODE
);

149 
cou¡
 = 
	`öb_pô
(
PIT_CH0
);

150 
cou¡
 |
	`öb_pô
(
PIT_CH0
) << 8;

153 i‡(
cou¡
 > 
LATCH
) {

154 
	`outb_pô
(0x34, 
PIT_MODE
);

155 
	`outb_pô
(
LATCH
 & 0xff, 
PIT_CH0
);

156 
	`outb_pô
(
LATCH
 >> 8, 
PIT_CH0
);

157 
cou¡
 = 
LATCH
 - 1;

173 i‡(
cou¡
 > 
ﬁd_cou¡
 && 
jifs
 =
ﬁd_jifs
)

174 
cou¡
 = 
ﬁd_cou¡
;

176 
ﬁd_cou¡
 = 
cou¡
;

177 
ﬁd_jifs
 = 
jifs
;

179 
	`•ö_u∆ock_úqª°‹e
(&
i8253_lock
, 
Êags
);

181 
cou¡
 = (
LATCH
 - 1) - count;

183  (
cy˛e_t
)(
jifs
 * 
LATCH
Ë+ 
cou¡
;

184 
	}
}

186 
˛ocksour˚
 
	gpô_cs
 = {

187 .
«me
 = "pit",

188 .
	gøtög
 = 110,

189 .
	gªad
 = 
pô_ªad
,

190 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

191 .
	gmu…
 = 0,

192 .
	gshi·
 = 20,

195 
__öô
 
	$öô_pô_˛ocksour˚
()

204 i‡(
	`num_possibÀ_˝us
(Ë> 1 || 
	`is_h≥t_íabÀd
() ||

205 
pô_˚
.
mode
 !
CLOCK_EVT_MODE_PERIODIC
)

208 
pô_cs
.
mu…
 = 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
,Öô_cs.
shi·
);

210  
	`˛ocksour˚_ªgi°î
(&
pô_cs
);

211 
	}
}

212 
¨ch_öôˇŒ
(
öô_pô_˛ocksour˚
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/sysdev.h
>

13 
	~<löux/bô›s.h
>

14 
	~<löux/a˝i.h
>

15 
	~<löux/io.h
>

16 
	~<löux/dñay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/timî.h
>

21 
	~<asm/hw_úq.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/i8259.h
>

34 
	gi8259A_auto_eoi
;

35 
DEFINE_SPINLOCK
(
i8259A_lock
);

36 
mask_™d_ack_8259A
();

38 
úq_chù
 
	gi8259A_chù
 = {

39 .
«me
 = "XT-PIC",

40 .
	gmask
 = 
dißbÀ_8259A_úq
,

41 .
	gdißbÀ
 = 
dißbÀ_8259A_úq
,

42 .
	gunmask
 = 
íabÀ_8259A_úq
,

43 .
	gmask_ack
 = 
mask_™d_ack_8259A
,

53 
	gˇched_úq_mask
 = 0xffff;

64 
	gio_≠ic_úqs
;

66 
	$dißbÀ_8259A_úq
(
úq
)

68 
mask
 = 1 << 
úq
;

69 
Êags
;

71 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

72 
ˇched_úq_mask
 |
mask
;

73 i‡(
úq
 & 8)

74 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

76 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

77 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

78 
	}
}

80 
	$íabÀ_8259A_úq
(
úq
)

82 
mask
 = ~(1 << 
úq
);

83 
Êags
;

85 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

86 
ˇched_úq_mask
 &
mask
;

87 i‡(
úq
 & 8)

88 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

90 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

91 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

92 
	}
}

94 
	$i8259A_úq_≥ndög
(
úq
)

96 
mask
 = 1<<
úq
;

97 
Êags
;

98 
ªt
;

100 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

101 i‡(
úq
 < 8)

102 
ªt
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
mask
;

104 
ªt
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
mask
 >> 8);

105 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

107  
ªt
;

108 
	}
}

110 
	$make_8259A_úq
(
úq
)

112 
	`dißbÀ_úq_nosync
(
úq
);

113 
io_≠ic_úqs
 &~(1<<
úq
);

114 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
i8259A_chù
, 
h™dÀ_Àvñ_úq
,

116 
	`íabÀ_úq
(
úq
);

117 
	}
}

125 
ölöe
 
	$i8259A_úq_ªÆ
(
úq
)

127 
vÆue
;

128 
úqmask
 = 1<<
úq
;

130 i‡(
úq
 < 8) {

131 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

132 
vÆue
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
úqmask
;

133 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

134  
vÆue
;

136 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

137 
vÆue
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
úqmask
 >> 8);

138 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

139  
vÆue
;

140 
	}
}

148 
	$mask_™d_ack_8259A
(
úq
)

150 
úqmask
 = 1 << 
úq
;

151 
Êags
;

153 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

169 i‡(
ˇched_úq_mask
 & 
úqmask
)

170 
•urious_8259A_úq
;

171 
ˇched_úq_mask
 |
úqmask
;

173 
h™dÀ_ªÆ_úq
:

174 i‡(
úq
 & 8) {

175 
	`öb
(
PIC_SLAVE_IMR
);

176 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

178 
	`outb
(0x60+(
úq
&7), 
PIC_SLAVE_CMD
);

180 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

182 
	`öb
(
PIC_MASTER_IMR
);

183 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

184 
	`outb
(0x60+
úq
, 
PIC_MASTER_CMD
);

186 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

189 
•urious_8259A_úq
:

193 i‡(
	`i8259A_úq_ªÆ
(
úq
))

198 
h™dÀ_ªÆ_úq
;

201 
•urious_úq_mask
;

206 i‡(!(
•urious_úq_mask
 & 
úqmask
)) {

207 
	`¥ötk
(
KERN_DEBUG


208 "•uriou†8259A i¡îru±: IRQ%d.\n", 
úq
);

209 
•urious_úq_mask
 |
úqmask
;

211 
	`©omic_öc
(&
úq_îr_cou¡
);

217 
h™dÀ_ªÆ_úq
;

219 
	}
}

221 
	gúq_åiggî
[2];

225 
	$ª°‹e_ELCR
(*
åiggî
)

227 
	`outb
(
åiggî
[0], 0x4d0);

228 
	`outb
(
åiggî
[1], 0x4d1);

229 
	}
}

231 
	$ßve_ELCR
(*
åiggî
)

234 
åiggî
[0] = 
	`öb
(0x4d0) & 0xF8;

235 
åiggî
[1] = 
	`öb
(0x4d1) & 0xDE;

236 
	}
}

238 
	$i8259A_ªsume
(
sys_devi˚
 *
dev
)

240 
	`öô_8259A
(
i8259A_auto_eoi
);

241 
	`ª°‹e_ELCR
(
úq_åiggî
);

243 
	}
}

245 
	$i8259A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

247 
	`ßve_ELCR
(
úq_åiggî
);

249 
	}
}

251 
	$i8259A_shutdown
(
sys_devi˚
 *
dev
)

257 
	`outb
(0xff, 
PIC_MASTER_IMR
);

258 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

260 
	}
}

262 
sysdev_˛ass
 
	gi8259_sysdev_˛ass
 = {

263 .
«me
 = "i8259",

264 .
	gsu•íd
 = 
i8259A_su•íd
,

265 .
	gªsume
 = 
i8259A_ªsume
,

266 .
	gshutdown
 = 
i8259A_shutdown
,

269 
sys_devi˚
 
	gdevi˚_i8259A
 = {

270 .
id
 = 0,

271 .
	g˛s
 = &
i8259_sysdev_˛ass
,

274 
__öô
 
	$i8259A_öô_sysfs
()

276 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8259_sysdev_˛ass
);

277 i‡(!
îr‹
)

278 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8259A
);

279  
îr‹
;

280 
	}
}

282 
devi˚_öôˇŒ
(
i8259A_öô_sysfs
);

284 
	$mask_8259A
()

286 
Êags
;

288 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

290 
	`outb
(0xff, 
PIC_MASTER_IMR
);

291 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

293 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

294 
	}
}

296 
	$unmask_8259A
()

298 
Êags
;

300 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

302 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

303 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

305 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

306 
	}
}

308 
	$öô_8259A
(
auto_eoi
)

310 
Êags
;

312 
i8259A_auto_eoi
 = 
auto_eoi
;

314 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

316 
	`outb
(0xff, 
PIC_MASTER_IMR
);

317 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

322 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

326 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

329 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

331 i‡(
auto_eoi
)

332 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

334 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

336 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

339 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

341 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

343 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

345 i‡(
auto_eoi
)

350 
i8259A_chù
.
mask_ack
 = 
dißbÀ_8259A_úq
;

352 
i8259A_chù
.
mask_ack
 = 
mask_™d_ack_8259A
;

354 
	`udñay
(100);

356 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

357 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

359 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

9 
	~<asm/uac˚ss.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/desc.h
>

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

23 
thªad_uni⁄
 
öô_thªad_uni⁄
 
	g__öô_èsk_d©a
 =

24 { 
INIT_THREAD_INFO
(
öô_èsk
) };

31 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

32 
EXPORT_SYMBOL
(
öô_èsk
);

41 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_°ru˘
, 
öô_tss
Ë
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/io.h
>

15 
io_dñay_ty≥
 
	g__ªad_mo°ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__öôd©a
 
	gio_dñay_ovîride
;

22 
	$«tive_io_dñay
()

24 
io_dñay_ty≥
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`udñay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
«tive_io_dñay
);

47 
__öô
 
	$dmi_io_dñay_0xed_p‹t
(c⁄° 
dmi_sy°em_id
 *
id
)

49 i‡(
io_dñay_ty≥
 =
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`¥_nŸi˚
("%s: usög 0xed I/O dñayÖ‹t\n", 
id
->
idít
);

51 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy°em_id
 
__öôd©a
 
	gio_dñay_0xed_p‹t_dmi_èbÀ
[] = {

63 .
ˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

64 .
	gidít
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

72 .
	gidít
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

80 .
	gidít
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

88 .
	gidít
 = "HP PavilionÅx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

96 .
	gidít
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__öô
 
	$io_dñay_öô
()

107 i‡(!
io_dñay_ovîride
)

108 
	`dmi_check_sy°em
(
io_dñay_0xed_p‹t_dmi_èbÀ
);

109 
	}
}

111 
__öô
 
	$io_dñay_∑øm
(*
s
)

113 i‡(!
s
)

114  -
EINVAL
;

116 i‡(!
	`°rcmp
(
s
, "0x80"))

117 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 i‡(!
	`°rcmp
(
s
, "0xed"))

119 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 i‡(!
	`°rcmp
(
s
, "udelay"))

121 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 i‡(!
	`°rcmp
(
s
, "none"))

123 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_dñay_ovîride
 = 1;

129 
	}
}

131 
óæy_∑øm
("io_dñay", 
io_dñay_∑øm
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<löux/sched.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/ˇ∑bûôy.h
>

9 
	~<löux/î∫o.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/i›‹t.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/°ddef.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/thªad_öfo.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<asm/sysˇŒs.h
>

20 
	$£t_bôm≠
(*
bôm≠
, 
ba£
,

21 
exã¡
, 
√w_vÆue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
exã¡
; i++) {

26 i‡(
√w_vÆue
)

27 
	`__£t_bô
(
i
, 
bôm≠
);

29 
	`__˛ór_bô
(
i
, 
bôm≠
);

31 
	}
}

36 
asmlökage
 
	$sys_i›îm
(
‰om
, 
num
, 
tu∫_⁄
)

38 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

39 
tss_°ru˘
 *
tss
;

40 
i
, 
max_l⁄g
, 
byãs
, 
byãs_upd©ed
;

42 i‡((
‰om
 + 
num
 <‰omË|| (‰om +Çum > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 i‡(
tu∫_⁄
 && !
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 i‡(!
t
->
io_bôm≠_±r
) {

53 *
bôm≠
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 i‡(!
bôm≠
)

56  -
ENOMEM
;

58 
	`mem£t
(
bôm≠
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_bôm≠_±r
 = 
bôm≠
;

60 
	`£t_thªad_Êag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

72 
	`£t_bôm≠
(
t
->
io_bôm≠_±r
, 
‰om
, 
num
, !
tu∫_⁄
);

78 
max_l⁄g
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 i‡(
t
->
io_bôm≠_±r
[
i
] != ~0UL)

81 
max_l⁄g
 = 
i
;

83 
byãs
 = (
max_l⁄g
 + 1) * ();

84 
byãs_upd©ed
 = 
	`max
(
byãs
, 
t
->
io_bôm≠_max
);

86 
t
->
io_bôm≠_max
 = 
byãs
;

89 
	`mem˝y
(
tss
->
io_bôm≠
, 
t
->
io_bôm≠_±r
, 
byãs_upd©ed
);

91 
	`put_˝u
();

94 
	}
}

106 
	$sys_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

108 
ﬁd
 = (
ªgs
->
Êags
 >> 12) & 3;

109 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

111 i‡(
Àvñ
 > 3)

112  -
EINVAL
;

114 i‡(
Àvñ
 > 
ﬁd
) {

115 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

116  -
EPERM
;

118 
ªgs
->
Êags
 = (ªgs->Êag†& ~
X86_EFLAGS_IOPL
Ë| (
Àvñ
 << 12);

119 
t
->
i›l
 = 
Àvñ
 << 12;

120 
	`£t_i›l_mask
(
t
->
i›l
);

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<löux/˝u.h
>

5 
	~<löux/öãºu±.h
>

6 
	~<löux/kî√l_°©.h
>

7 
	~<löux/£q_fûe.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/·ø˚.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/io_≠ic.h
>

13 
	~<asm/úq.h
>

14 
	~<asm/idÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/hw_úq.h
>

18 
©omic_t
 
	gúq_îr_cou¡
;

21 (*
x86_∂©f‹m_ùi_ˇŒback
)(Ë
NULL
;

27 
	$ack_bad_úq
(
úq
)

29 i‡(
	`¥ötk_øãlimô
())

30 
	`¥_îr
("u√x≥˘ed IRQÅø∞© ve˘‹ %02x\n", 
úq
);

41 
	`ack_APIC_úq
();

42 
	}
}

44 
	#úq_°©s
(
x
Ë(&
	`≥r_˝u
(
úq_°©
, x))

	)

48 
	$show_Ÿhî_öãºu±s
(
£q_fûe
 *
p
, 
¥ec
)

50 
j
;

52 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "NMI");

53 
	`f‹_óch_⁄löe_˝u
(
j
)

54 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
__nmi_cou¡
);

55 
	`£q_¥ötf
(
p
, " Non-maskable interrupts\n");

56 #ifde‡
CONFIG_X86_LOCAL_APIC


57 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "LOC");

58 
	`f‹_óch_⁄löe_˝u
(
j
)

59 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_timî_úqs
);

60 
	`£q_¥ötf
(
p
, " LocalÅimer interrupts\n");

62 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "SPU");

63 
	`f‹_óch_⁄löe_˝u
(
j
)

64 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_•urious_cou¡
);

65 
	`£q_¥ötf
(
p
, " Spurious interrupts\n");

66 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PMI");

67 
	`f‹_óch_⁄löe_˝u
(
j
)

68 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥rf_úqs
);

69 
	`£q_¥ötf
(
p
, " Performance monitoring interrupts\n");

70 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PND");

71 
	`f‹_óch_⁄löe_˝u
(
j
)

72 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥ndög_úqs
);

73 
	`£q_¥ötf
(
p
, " PerformanceÖending work\n");

75 i‡(
x86_∂©f‹m_ùi_ˇŒback
) {

76 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PLT");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
x86_∂©f‹m_ùis
);

79 
	`£q_¥ötf
(
p
, " Platform interrupts\n");

81 #ifde‡
CONFIG_SMP


82 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "RES");

83 
	`f‹_óch_⁄löe_˝u
(
j
)

84 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ªsched_cou¡
);

85 
	`£q_¥ötf
(
p
, " Rescheduling interrupts\n");

86 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CAL");

87 
	`f‹_óch_⁄löe_˝u
(
j
)

88 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ˇŒ_cou¡
);

89 
	`£q_¥ötf
(
p
, " Function call interrupts\n");

90 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TLB");

91 
	`f‹_óch_⁄löe_˝u
(
j
)

92 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_éb_cou¡
);

93 
	`£q_¥ötf
(
p
, " TLB shootdowns\n");

95 #ifde‡
CONFIG_X86_THERMAL_VECTOR


96 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TRM");

97 
	`f‹_óch_⁄löe_˝u
(
j
)

98 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thîmÆ_cou¡
);

99 
	`£q_¥ötf
(
p
, " ThermalÉvent interrupts\n");

101 #ifde‡
CONFIG_X86_MCE_THRESHOLD


102 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "THR");

103 
	`f‹_óch_⁄löe_˝u
(
j
)

104 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thªshﬁd_cou¡
);

105 
	`£q_¥ötf
(
p
, " Threshold APIC interrupts\n");

107 #ifde‡
CONFIG_X86_MCE


108 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCE");

109 
	`f‹_óch_⁄löe_˝u
(
j
)

110 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
j
));

111 
	`£q_¥ötf
(
p
, " Machine checkÉxceptions\n");

112 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCP");

113 
	`f‹_óch_⁄löe_˝u
(
j
)

114 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
j
));

115 
	`£q_¥ötf
(
p
, " Machine checkÖolls\n");

117 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "ERR", 
	`©omic_ªad
(&
úq_îr_cou¡
));

118 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

119 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "MIS", 
	`©omic_ªad
(&
úq_mis_cou¡
));

122 
	}
}

124 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

126 
Êags
, 
™y_cou¡
 = 0;

127 
i
 = *(
loff_t
 *Ë
v
, 
j
, 
¥ec
;

128 
úqa˘i⁄
 *
a˘i⁄
;

129 
úq_desc
 *
desc
;

131 i‡(
i
 > 
ƒ_úqs
)

134 
¥ec
 = 3, 
j
 = 1000;Öª¯< 10 && j <
ƒ_úqs
; ++prec)

135 
j
 *= 10;

137 i‡(
i
 =
ƒ_úqs
)

138  
	`show_Ÿhî_öãºu±s
(
p
, 
¥ec
);

141 i‡(
i
 == 0) {

142 
	`£q_¥ötf
(
p
, "%*s", 
¥ec
 + 8, "");

143 
	`f‹_óch_⁄löe_˝u
(
j
)

144 
	`£q_¥ötf
(
p
, "CPU%-8d", 
j
);

145 
	`£q_putc
(
p
, '\n');

148 
desc
 = 
	`úq_to_desc
(
i
);

149 i‡(!
desc
)

152 
	`øw_•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

153 
	`f‹_óch_⁄löe_˝u
(
j
)

154 
™y_cou¡
 |
	`k°©_úqs_˝u
(
i
, 
j
);

155 
a˘i⁄
 = 
desc
->action;

156 i‡(!
a˘i⁄
 && !
™y_cou¡
)

157 
out
;

159 
	`£q_¥ötf
(
p
, "%*d: ", 
¥ec
, 
i
);

160 
	`f‹_óch_⁄löe_˝u
(
j
)

161 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs_˝u
(
i
, 
j
));

162 
	`£q_¥ötf
(
p
, " %8s", 
desc
->
chù
->
«me
);

163 
	`£q_¥ötf
(
p
, "-%-8s", 
desc
->
«me
);

165 i‡(
a˘i⁄
) {

166 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

167 (
a˘i⁄
 =á˘i⁄->
√xt
Ë!
NULL
)

168 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

171 
	`£q_putc
(
p
, '\n');

172 
out
:

173 
	`øw_•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

175 
	}
}

180 
u64
 
	$¨ch_úq_°©_˝u
(
˝u
)

182 
u64
 
sum
 = 
	`úq_°©s
(
˝u
)->
__nmi_cou¡
;

184 #ifde‡
CONFIG_X86_LOCAL_APIC


185 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_timî_úqs
;

186 
sum
 +
	`úq_°©s
(
˝u
)->
úq_•urious_cou¡
;

187 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥rf_úqs
;

188 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥ndög_úqs
;

190 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

191 
sum
 +
	`úq_°©s
(
˝u
)->
x86_∂©f‹m_ùis
;

192 #ifde‡
CONFIG_SMP


193 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ªsched_cou¡
;

194 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ˇŒ_cou¡
;

195 
sum
 +
	`úq_°©s
(
˝u
)->
úq_éb_cou¡
;

197 #ifde‡
CONFIG_X86_THERMAL_VECTOR


198 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thîmÆ_cou¡
;

200 #ifde‡
CONFIG_X86_MCE_THRESHOLD


201 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thªshﬁd_cou¡
;

203 #ifde‡
CONFIG_X86_MCE


204 
sum
 +
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
˝u
);

205 
sum
 +
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
˝u
);

207  
sum
;

208 
	}
}

210 
u64
 
	$¨ch_úq_°©
()

212 
u64
 
sum
 = 
	`©omic_ªad
(&
úq_îr_cou¡
);

214 #ifde‡
CONFIG_X86_IO_APIC


215 
sum
 +
	`©omic_ªad
(&
úq_mis_cou¡
);

217  
sum
;

218 
	}
}

226 
__úq_íåy
 
	$do_IRQ
(
±_ªgs
 *
ªgs
)

228 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

231 
ve˘‹
 = ~
ªgs
->
‹ig_ax
;

232 
úq
;

234 
	`exô_idÀ
();

235 
	`úq_íãr
();

237 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

239 i‡(!
	`h™dÀ_úq
(
úq
, 
ªgs
)) {

240 
	`ack_APIC_úq
();

242 i‡(
	`¥ötk_øãlimô
())

243 
	`¥_emîg
("%s: %d.%d No irq handler for vector (irq %d)\n",

244 
__func__
, 
	`smp_¥o˚ss‹_id
(), 
ve˘‹
, 
úq
);

247 
	`úq_exô
();

249 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

251 
	}
}

256 
	$smp_x86_∂©f‹m_ùi
(
±_ªgs
 *
ªgs
)

258 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

260 
	`ack_APIC_úq
();

262 
	`exô_idÀ
();

264 
	`úq_íãr
();

266 
	`öc_úq_°©
(
x86_∂©f‹m_ùis
);

268 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

269 
	`x86_∂©f‹m_ùi_ˇŒback
();

271 
	`úq_exô
();

273 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

274 
	}
}

276 
EXPORT_SYMBOL_GPL
(
ve˘‹_u£d_by_≥r˝u_úq
);

278 #ifde‡
CONFIG_HOTPLUG_CPU


280 
	$fixup_úqs
()

282 
úq
, 
ve˘‹
;

283 
w¨√d
;

284 
úq_desc
 *
desc
;

286 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

287 
bªak_afföôy
 = 0;

288 
£t_afföôy
 = 1;

289 c⁄° 
˝umask
 *
afföôy
;

291 i‡(!
desc
)

293 i‡(
úq
 == 2)

297 
	`øw_•ö_lock
(&
desc
->
lock
);

299 
afföôy
 = 
desc
->affinity;

300 i‡(!
	`úq_has_a˘i⁄
(
úq
) ||

301 
	`˝umask_equÆ
(
afföôy
, 
˝u_⁄löe_mask
)) {

302 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

311 
	`úq_f‹˚_com∂ëe_move
(
úq
);

313 i‡(
	`˝umask_™y_™d
(
afföôy
, 
˝u_⁄löe_mask
Ë>
ƒ_˝u_ids
) {

314 
bªak_afföôy
 = 1;

315 
afföôy
 = 
˝u_Æl_mask
;

318 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
mask
)

319 
desc
->
chù
->
	`mask
(
úq
);

321 i‡(
desc
->
chù
->
£t_afföôy
)

322 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
afföôy
);

323 i‡(!(
w¨√d
++))

324 
£t_afföôy
 = 0;

326 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
unmask
)

327 
desc
->
chù
->
	`unmask
(
úq
);

329 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

331 i‡(
bªak_afföôy
 && 
£t_afföôy
)

332 
	`¥ötk
("Brokêafföôy f‹ irq %i\n", 
úq
);

333 i‡(!
£t_afföôy
)

334 
	`¥ötk
("C™nŸ sëáfföôy f‹ irq %i\n", 
úq
);

346 
	`mdñay
(1);

348 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

349 
úr
;

351 i‡(
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] < 0)

354 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

355 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

356 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

358 
desc
 = 
	`úq_to_desc
(
úq
);

359 
	`øw_•ö_lock
(&
desc
->
lock
);

360 i‡(
desc
->
chù
->
ªåiggî
)

361 
desc
->
chù
->
	`ªåiggî
(
úq
);

362 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

365 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/·ø˚.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/smp.h
>

19 
	~<asm/io_≠ic.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/≠ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
úq_˝u°©_t
, 
úq_°©
);

24 
EXPORT_PER_CPU_SYMBOL
(
úq_°©
);

26 
DEFINE_PER_CPU
(
±_ªgs
 *, 
úq_ªgs
);

27 
EXPORT_PER_CPU_SYMBOL
(
úq_ªgs
);

36 
ölöe
 
	$°ack_ovîÊow_check
(
±_ªgs
 *
ªgs
)

38 #ifde‡
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`èsk_°ack_∑ge
(
cuºít
);

41 
	`WARN_ONCE
(
ªgs
->
•
 >
curba£
 &&

42 
ªgs
->
•
 <
curba£
 + 
THREAD_SIZE
 &&

43 
ªgs
->
•
 < 
curba£
 + (
thªad_öfo
) +

44 (
±_ªgs
) + 128,

47 
cuºít
->
comm
, 
curba£
, 
ªgs
->
•
);

49 
	}
}

51 
boﬁ
 
	$h™dÀ_úq
(
úq
, 
±_ªgs
 *
ªgs
)

53 
úq_desc
 *
desc
;

55 
	`°ack_ovîÊow_check
(
ªgs
);

57 
desc
 = 
	`úq_to_desc
(
úq
);

58 i‡(
	`u∆ikñy
(!
desc
))

59  
Ál£
;

61 
	`gíîic_h™dÀ_úq_desc
(
úq
, 
desc
);

62  
åue
;

63 
	}
}

66 
ˇŒ_so·úq
();

68 
asmlökage
 
	$do_so·úq
()

70 
__u32
 
≥ndög
;

71 
Êags
;

73 i‡(
	`ö_öãºu±
())

76 
	`loˇl_úq_ßve
(
Êags
);

77 
≥ndög
 = 
	`loˇl_so·úq_≥ndög
();

79 i‡(
≥ndög
) {

80 
	`ˇŒ_so·úq
();

81 
	`WARN_ON_ONCE
(
	`so·úq_cou¡
());

83 
	`loˇl_úq_ª°‹e
(
Êags
);

84 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/k¥obes.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/kî√l_°©.h
>

13 
	~<löux/sysdev.h
>

14 
	~<löux/bô›s.h
>

15 
	~<löux/a˝i.h
>

16 
	~<löux/io.h
>

17 
	~<löux/dñay.h
>

19 
	~<asm/©omic.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/hw_úq.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/desc.h
>

25 
	~<asm/≠ic.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/i8259.h
>

28 
	~<asm/å≠s.h
>

46 #ifde‡
CONFIG_X86_32


59 
úqªtu∫_t
 
	$m©h_îr‹_úq
(
˝l
, *
dev_id
)

61 
	`outb
(0, 0xF0);

62 i‡(
ign‹e_Âu_úq
 || !
boŸ_˝u_d©a
.
h¨d_m©h
)

63  
IRQ_NONE
;

64 
	`m©h_îr‹
((
__u£r
 *)
	`gë_úq_ªgs
()->
ù
);

65  
IRQ_HANDLED
;

66 
	}
}

72 
úqa˘i⁄
 
	gÂu_úq
 = {

73 .
h™dÀr
 = 
m©h_îr‹_úq
,

74 .
	g«me
 = "fpu",

81 
úqa˘i⁄
 
	gúq2
 = {

82 .
h™dÀr
 = 
no_a˘i⁄
,

83 .
	g«me
 = "cascade",

86 
DEFINE_PER_CPU
(
ve˘‹_úq_t
, 
ve˘‹_úq
) = {

87 [0 ... 
IRQ0_VECTOR
 - 1] = -1,

88 [
IRQ0_VECTOR
] = 0,

89 [
IRQ1_VECTOR
] = 1,

90 [
IRQ2_VECTOR
] = 2,

91 [
IRQ3_VECTOR
] = 3,

92 [
IRQ4_VECTOR
] = 4,

93 [
IRQ5_VECTOR
] = 5,

94 [
IRQ6_VECTOR
] = 6,

95 [
IRQ7_VECTOR
] = 7,

96 [
IRQ8_VECTOR
] = 8,

97 [
IRQ9_VECTOR
] = 9,

98 [
IRQ10_VECTOR
] = 10,

99 [
IRQ11_VECTOR
] = 11,

100 [
IRQ12_VECTOR
] = 12,

101 [
IRQ13_VECTOR
] = 13,

102 [
IRQ14_VECTOR
] = 14,

103 [
IRQ15_VECTOR
] = 15,

104 [
IRQ15_VECTOR
 + 1 ... 
NR_VECTORS
 - 1] = -1

107 
	$ve˘‹_u£d_by_≥r˝u_úq
(
ve˘‹
)

109 
˝u
;

111 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

112 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] != -1)

117 
	}
}

119 
__öô
 
	$öô_ISA_úqs
()

121 
i
;

123 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

124 
	`öô_b•_APIC
();

126 
	`öô_8259A
(0);

131 
i
 = 0; i < 
NR_IRQS_LEGACY
; i++) {

132 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
i
);

134 
desc
->
°©us
 = 
IRQ_DISABLED
;

135 
desc
->
a˘i⁄
 = 
NULL
;

136 
desc
->
dïth
 = 1;

138 
	`£t_úq_chù_™d_h™dÀr_«me
(
i
, &
i8259A_chù
,

139 
h™dÀ_Àvñ_úq
, "XT");

141 
	}
}

143 
__öô
 
	$öô_IRQ
()

145 
x86_öô
.
úqs
.
	`öå_öô
();

146 
	}
}

148 
__öô
 
	$smp_öå_öô
()

150 #ifde‡
CONFIG_SMP


151 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

156 
	`Æloc_öå_g©e
(
RESCHEDULE_VECTOR
, 
ªscheduÀ_öãºu±
);

159 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
övÆid©e_öãºu±0
);

160 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
övÆid©e_öãºu±1
);

161 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
övÆid©e_öãºu±2
);

162 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
övÆid©e_öãºu±3
);

163 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
övÆid©e_öãºu±4
);

164 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
övÆid©e_öãºu±5
);

165 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
övÆid©e_öãºu±6
);

166 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
övÆid©e_öãºu±7
);

169 
	`Æloc_öå_g©e
(
CALL_FUNCTION_VECTOR
, 
ˇŒ_fun˘i⁄_öãºu±
);

172 
	`Æloc_öå_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

173 
ˇŒ_fun˘i⁄_sögÀ_öãºu±
);

176 
	`£t_öå_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
úq_move_˛ónup_öãºu±
);

177 
	`£t_bô
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_ve˘‹s
);

180 
	`Æloc_öå_g©e
(
REBOOT_VECTOR
, 
ªboŸ_öãºu±
);

183 
	}
}

185 
__öô
 
	$≠ic_öå_öô
()

187 
	`smp_öå_öô
();

189 #ifde‡
CONFIG_X86_THERMAL_VECTOR


190 
	`Æloc_öå_g©e
(
THERMAL_APIC_VECTOR
, 
thîmÆ_öãºu±
);

192 #ifde‡
CONFIG_X86_MCE_THRESHOLD


193 
	`Æloc_öå_g©e
(
THRESHOLD_APIC_VECTOR
, 
thªshﬁd_öãºu±
);

195 #i‡
	`deföed
(
CONFIG_X86_MCE
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

196 
	`Æloc_öå_g©e
(
MCE_SELF_VECTOR
, 
m˚_£lf_öãºu±
);

199 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

201 
	`Æloc_öå_g©e
(
LOCAL_TIMER_VECTOR
, 
≠ic_timî_öãºu±
);

204 
	`Æloc_öå_g©e
(
X86_PLATFORM_IPI_VECTOR
, 
x86_∂©f‹m_ùi
);

207 
	`Æloc_öå_g©e
(
SPURIOUS_APIC_VECTOR
, 
•urious_öãºu±
);

208 
	`Æloc_öå_g©e
(
ERROR_APIC_VECTOR
, 
îr‹_öãºu±
);

211 #ifde‡
CONFIG_PERF_EVENTS


212 
	`Æloc_öå_g©e
(
LOCAL_PENDING_VECTOR
, 
≥rf_≥ndög_öãºu±
);

216 
	}
}

218 
__öô
 
	$«tive_öô_IRQ
()

220 
i
;

223 
x86_öô
.
úqs
.
	`¥e_ve˘‹_öô
();

225 
	`≠ic_öå_öô
();

232 
i
 = 
FIRST_EXTERNAL_VECTOR
; i < 
NR_VECTORS
; i++) {

234 i‡(!
	`ã°_bô
(
i
, 
u£d_ve˘‹s
))

235 
	`£t_öå_g©e
(
i
, 
öãºu±
[i-
FIRST_EXTERNAL_VECTOR
]);

238 i‡(!
a˝i_iﬂpic
)

239 
	`£tup_úq
(2, &
úq2
);

241 #ifde‡
CONFIG_X86_32


246 i‡(
boŸ_˝u_d©a
.
h¨d_m©h
 && !
˝u_has_Âu
)

247 
	`£tup_úq
(
FPU_IRQ
, &
Âu_úq
);

249 
	`úq_˘x_öô
(
	`smp_¥o˚ss‹_id
());

251 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<löux/gÂ.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<löux/öô.h
>

8 
	~<löux/î∫o.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/•ölock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_n‹thbridges
;

14 
EXPORT_SYMBOL
(
num_k8_n‹thbridges
);

16 
u32
 *
	gÊush_w‹ds
;

18 
pci_devi˚_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_n‹thbridges
;

26 
EXPORT_SYMBOL
(
k8_n‹thbridges
);

28 
pci_dev
 *
	$√xt_k8_n‹thbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 i‡(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ˇche_k8_n‹thbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 i‡(
num_k8_n‹thbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
)

48 
num_k8_n‹thbridges
++;

50 
k8_n‹thbridges
 = 
	`kmÆloc
((
num_k8_n‹thbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 i‡(!
k8_n‹thbridges
)

53  -
ENOMEM
;

55 i‡(!
num_k8_n‹thbridges
) {

56 
k8_n‹thbridges
[0] = 
NULL
;

60 
Êush_w‹ds
 = 
	`kmÆloc
(
num_k8_n‹thbridges
 * (
u32
), 
GFP_KERNEL
);

61 i‡(!
Êush_w‹ds
) {

62 
	`k‰ì
(
k8_n‹thbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
) {

69 
k8_n‹thbridges
[
i
] = 
dev
;

70 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x9c, &
Êush_w‹ds
[
i
++]);

72 
k8_n‹thbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ˇche_k8_n‹thbridges
);

79 
__öô
 
	$óæy_is_k8_nb
(
u32
 
devi˚
)

81 
pci_devi˚_id
 *
id
;

82 
u32
 
víd‹
 = 
devi˚
 & 0xffff;

83 
devi˚
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
víd‹
; id++)

85 i‡(
víd‹
 =
id
->víd‹ && 
devi˚
 == id->device)

88 
	}
}

90 
	$k8_Êush_g¨ts
()

92 
Êushed
, 
i
;

93 
Êags
;

94 
	`DEFINE_SPINLOCK
(
g¨t_lock
);

100 
	`•ö_lock_úqßve
(&
g¨t_lock
, 
Êags
);

101 
Êushed
 = 0;

102 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

103 
	`pci_wrôe_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
], 0x9c,

104 
Êush_w‹ds
[
i
]|1);

105 
Êushed
++;

107 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_ªad_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
],

112 0x9c, &
w
);

113 i‡(!(
w
 & 1))

115 
	`˝u_ªœx
();

118 
	`•ö_u∆ock_úqª°‹e
(&
g¨t_lock
, 
Êags
);

119 i‡(!
Êushed
)

120 
	`¥ötk
("nothingÅo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_Êush_g¨ts
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<löux/debugfs.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/°©.h
>

14 
	~<löux/io.h
>

15 
	~<löux/mm.h
>

17 
	~<asm/£tup.h
>

19 
díåy
 *
	g¨ch_debugfs_dú
;

20 
EXPORT_SYMBOL
(
¨ch_debugfs_dú
);

22 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


23 
	s£tup_d©a_node
 {

24 
u64
 
	m∑ddr
;

25 
u32
 
	mty≥
;

26 
u32
 
	mÀn
;

29 
ssize_t
 
	$£tup_d©a_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

30 
size_t
 
cou¡
, 
loff_t
 *
µos
)

32 
£tup_d©a_node
 *
node
 = 
fûe
->
¥iv©e_d©a
;

33 
ªmaö
;

34 
loff_t
 
pos
 = *
µos
;

35 
∑ge
 *
pg
;

36 *
p
;

37 
u64
 
∑
;

39 i‡(
pos
 < 0)

40  -
EINVAL
;

42 i‡(
pos
 >
node
->
Àn
)

45 i‡(
cou¡
 > 
node
->
Àn
 - 
pos
)

46 
cou¡
 = 
node
->
Àn
 - 
pos
;

48 
∑
 = 
node
->
∑ddr
 + (
£tup_d©a
Ë+ 
pos
;

49 
pg
 = 
	`p‚_to_∑ge
((
∑
 + 
cou¡
 - 1Ë>> 
PAGE_SHIFT
);

50 i‡(
	`PageHighMem
(
pg
)) {

51 
p
 = 
	`i‹em≠_ˇche
(
∑
, 
cou¡
);

52 i‡(!
p
)

53  -
ENXIO
;

55 
p
 = 
	`__va
(
∑
);

57 
ªmaö
 = 
	`c›y_to_u£r
(
u£r_buf
, 
p
, 
cou¡
);

59 i‡(
	`PageHighMem
(
pg
))

60 
	`iounm≠
(
p
);

62 i‡(
ªmaö
)

63  -
EFAULT
;

65 *
µos
 = 
pos
 + 
cou¡
;

67  
cou¡
;

68 
	}
}

70 
	$£tup_d©a_›í
(
öode
 *öode, 
fûe
 *file)

72 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

75 
	}
}

77 c⁄° 
fûe_›î©i⁄s
 
	gf›s_£tup_d©a
 = {

78 .
ªad
 = 
£tup_d©a_ªad
,

79 .
	g›í
 = 
£tup_d©a_›í
,

82 
__öô


83 
	$¸óã_£tup_d©a_node
(
díåy
 *
∑ª¡
, 
no
,

84 
£tup_d©a_node
 *
node
)

86 
díåy
 *
d
, *
ty≥
, *
d©a
;

87 
buf
[16];

89 
	`•rötf
(
buf
, "%d", 
no
);

90 
d
 = 
	`debugfs_¸óã_dú
(
buf
, 
∑ª¡
);

91 i‡(!
d
)

92  -
ENOMEM
;

94 
ty≥
 = 
	`debugfs_¸óã_x32
("ty≥", 
S_IRUGO
, 
d
, &
node
->type);

95 i‡(!
ty≥
)

96 
îr_dú
;

98 
d©a
 = 
	`debugfs_¸óã_fûe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
f›s_£tup_d©a
);

99 i‡(!
d©a
)

100 
îr_ty≥
;

104 
îr_ty≥
:

105 
	`debugfs_ªmove
(
ty≥
);

106 
îr_dú
:

107 
	`debugfs_ªmove
(
d
);

108  -
ENOMEM
;

109 
	}
}

111 
__öô
 
	$¸óã_£tup_d©a_nodes
(
díåy
 *
∑ª¡
)

113 
£tup_d©a_node
 *
node
;

114 
£tup_d©a
 *
d©a
;

115 
îr‹
 = -
ENOMEM
;

116 
díåy
 *
d
;

117 
∑ge
 *
pg
;

118 
u64
 
∑_d©a
;

119 
no
 = 0;

121 
d
 = 
	`debugfs_¸óã_dú
("£tup_d©a", 
∑ª¡
);

122 i‡(!
d
)

123  -
ENOMEM
;

125 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

127 
∑_d©a
) {

128 
node
 = 
	`kmÆloc
((*node), 
GFP_KERNEL
);

129 i‡(!
node
)

130 
îr_dú
;

132 
pg
 = 
	`p‚_to_∑ge
((
∑_d©a
+(*
d©a
)-1Ë>> 
PAGE_SHIFT
);

133 i‡(
	`PageHighMem
(
pg
)) {

134 
d©a
 = 
	`i‹em≠_ˇche
(
∑_d©a
, (*data));

135 i‡(!
d©a
) {

136 
	`k‰ì
(
node
);

137 
îr‹
 = -
ENXIO
;

138 
îr_dú
;

141 
d©a
 = 
	`__va
(
∑_d©a
);

143 
node
->
∑ddr
 = 
∑_d©a
;

144 
node
->
ty≥
 = 
d©a
->type;

145 
node
->
Àn
 = 
d©a
->len;

146 
îr‹
 = 
	`¸óã_£tup_d©a_node
(
d
, 
no
, 
node
);

147 
∑_d©a
 = 
d©a
->
√xt
;

149 i‡(
	`PageHighMem
(
pg
))

150 
	`iounm≠
(
d©a
);

151 i‡(
îr‹
)

152 
îr_dú
;

153 
no
++;

158 
îr_dú
:

159 
	`debugfs_ªmove
(
d
);

160  
îr‹
;

161 
	}
}

163 
debugfs_blob_wøµî
 
	gboŸ_∑øms_blob
 = {

164 .
d©a
 = &
boŸ_∑øms
,

165 .
	gsize
 = (
boŸ_∑øms
),

168 
__öô
 
	$boŸ_∑øms_kdebugfs_öô
()

170 
díåy
 *
dbp
, *
vîsi⁄
, *
d©a
;

171 
îr‹
 = -
ENOMEM
;

173 
dbp
 = 
	`debugfs_¸óã_dú
("boŸ_∑øms", 
NULL
);

174 i‡(!
dbp
)

175  -
ENOMEM
;

177 
vîsi⁄
 = 
	`debugfs_¸óã_x16
("vîsi⁄", 
S_IRUGO
, 
dbp
,

178 &
boŸ_∑øms
.
hdr
.
vîsi⁄
);

179 i‡(!
vîsi⁄
)

180 
îr_dú
;

182 
d©a
 = 
	`debugfs_¸óã_blob
("d©a", 
S_IRUGO
, 
dbp
,

183 &
boŸ_∑øms_blob
);

184 i‡(!
d©a
)

185 
îr_vîsi⁄
;

187 
îr‹
 = 
	`¸óã_£tup_d©a_nodes
(
dbp
);

188 i‡(
îr‹
)

189 
îr_d©a
;

193 
îr_d©a
:

194 
	`debugfs_ªmove
(
d©a
);

195 
îr_vîsi⁄
:

196 
	`debugfs_ªmove
(
vîsi⁄
);

197 
îr_dú
:

198 
	`debugfs_ªmove
(
dbp
);

199  
îr‹
;

200 
	}
}

203 
__öô
 
	$¨ch_kdebugfs_öô
()

205 
îr‹
 = 0;

207 
¨ch_debugfs_dú
 = 
	`debugfs_¸óã_dú
("x86", 
NULL
);

208 i‡(!
¨ch_debugfs_dú
)

209  -
ENOMEM
;

211 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


212 
îr‹
 = 
	`boŸ_∑øms_kdebugfs_öô
();

215  
îr‹
;

216 
	}
}

217 
¨ch_öôˇŒ
(
¨ch_kdebugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<löux/k¥obes.h
>

44 
	~<löux/±ø˚.h
>

45 
	~<löux/°rög.h
>

46 
	~<löux/¶ab.h
>

47 
	~<löux/h¨dúq.h
>

48 
	~<löux/¥ìm±.h
>

49 
	~<löux/moduÀ.h
>

50 
	~<löux/kdebug.h
>

51 
	~<löux/kÆlsyms.h
>

53 
	~<asm/ˇcheÊush.h
>

54 
	~<asm/desc.h
>

55 
	~<asm/pgèbÀ.h
>

56 
	~<asm/uac˚ss.h
>

57 
	~<asm/Æã∫©ive.h
>

58 
	~<asm/ö¢.h
>

59 
	~<asm/debugªg.h
>

61 
j¥obe_ªtu∫_íd
();

63 
DEFINE_PER_CPU
(
k¥obe
 *, 
cuºít_k¥obe
Ë
NULL
;

64 
DEFINE_PER_CPU
(
k¥obe_˘lblk
, kprobe_ctlblk);

66 
	#°ack_addr
(
ªgs
Ë((*)
	`kî√l_°ack_poöãr
‘egs))

	)

68 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

69 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

70 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

71 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

72 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

73 << (
row
 % 32))

	)

78 c⁄° 
u32
 
	gtwobyã_is_boo°abÀ
[256 / 32] = {

81 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

82 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

83 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

84 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

85 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

86 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

87 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

88 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

89 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

90 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

91 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

92 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

93 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

94 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

95 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

96 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

100 #unde‡
W


102 
kªçrobe_bœckpoöt
 
	gkªçrobe_bœckli°
[] = {

105 {
NULL
, NULL}

107 c⁄° 
	gkªçrobe_bœckli°_size
 = 
ARRAY_SIZE
(
kªçrobe_bœckli°
);

110 
__k¥obes
 
	$£t_jmp_›
(*
‰om
, *
to
)

112 
	s__¨ch_jmp_›
 {

113 
›
;

114 
s32
 
øddr
;

115 } 
	`__©åibuã__
((
∑cked
)Ë* 
j›
;

116 
j›
 = (
__¨ch_jmp_›
 *)
‰om
;

117 
j›
->
øddr
 = (
s32
)(()(
to
Ë- (()(
‰om
) + 5));

118 
j›
->
›
 = 
RELATIVEJUMP_INSTRUCTION
;

119 
	}
}

125 
__k¥obes
 
	$is_REX_¥efix
(
k¥obe_›code_t
 *
ö¢
)

127 #ifde‡
CONFIG_X86_64


128 i‡((*
ö¢
 & 0xf0) == 0x40)

132 
	}
}

138 
__k¥obes
 
	$ˇn_boo°
(
k¥obe_›code_t
 *
›codes
)

140 
k¥obe_›code_t
 
›code
;

141 
k¥obe_›code_t
 *
‹ig_›codes
 = 
›codes
;

143 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(()
›codes
))

146 
ªåy
:

147 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

149 
›code
 = *(
›codes
++);

152 i‡(
›code
 == 0x0f) {

153 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

155  
	`ã°_bô
(*
›codes
,

156 (*)
twobyã_is_boo°abÀ
);

159 
›code
 & 0xf0) {

160 #ifde‡
CONFIG_X86_64


162 
ªåy
;

165 i‡(0x63 < 
›code
 && opcode < 0x67)

166 
ªåy
;

168  (
›code
 != 0x62 && opcode != 0x67);

173  (0xc1 < 
›code
 && opcode < 0xcc) || opcode == 0xcf;

176  (
›code
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

179  ((
›code
 & 0x04) || opcode == 0xea);

181 i‡((
›code
 & 0x0c) == 0 && opcode != 0xf1)

182 
ªåy
;

184  (
›code
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

187 i‡(
›code
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

188 
ªåy
;

190  (
›code
 != 0x2e && opcode != 0x9a);

192 
	}
}

195 
	$ªcovî_¥obed_ö°ru˘i⁄
(
k¥obe_›code_t
 *
buf
, 
addr
)

197 
k¥obe
 *
kp
;

198 
kp
 = 
	`gë_k¥obe
((*)
addr
);

199 i‡(!
kp
)

200  -
EINVAL
;

215 
	`mem˝y
(
buf
, 
kp
->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

216 
buf
[0] = 
kp
->
›code
;

218 
	}
}

221 
	g__dummy_buf
[
KSYM_NAME_LEN
];

224 
__k¥obes
 
	$ˇn_¥obe
(
∑ddr
)

226 
ªt
;

227 
addr
, 
off£t
 = 0;

228 
ö¢
 insn;

229 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

231 i‡(!
	`kÆlsyms_lookup
(
∑ddr
, 
NULL
, &
off£t
, NULL, 
__dummy_buf
))

235 
addr
 = 
∑ddr
 - 
off£t
;

236 
addr
 < 
∑ddr
) {

237 
	`kî√l_ö¢_öô
(&
ö¢
, (*)
addr
);

238 
	`ö¢_gë_›code
(&
ö¢
);

245 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

246 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
, 
addr
);

247 i‡(
ªt
)

254 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

256 
	`ö¢_gë_Àngth
(&
ö¢
);

257 
addr
 +
ö¢
.
Àngth
;

260  (
addr
 =
∑ddr
);

261 
	}
}

266 
__k¥obes
 
	$is_IF_modifõr
(
k¥obe_›code_t
 *
ö¢
)

268 *
ö¢
) {

280 i‡(
	`is_REX_¥efix
(
ö¢
))

281  
	`is_IF_modifõr
(++
ö¢
);

284 
	}
}

293 
__k¥obes
 
	$fix_rùªl
(
k¥obe
 *
p
)

295 #ifde‡
CONFIG_X86_64


296 
ö¢
 insn;

297 
	`kî√l_ö¢_öô
(&
ö¢
, 
p
->
aö¢
.insn);

299 i‡(
	`ö¢_rù_ªœtive
(&
ö¢
)) {

300 
s64
 
√wdi•
;

301 
u8
 *
di•
;

302 
	`ö¢_gë_di•œ˚mít
(&
ö¢
);

315 
√wdi•
 = (
u8
 *Ë
p
->
addr
 + (
s64
Ë
ö¢
.
di•œ˚mít
.
vÆue
 -

316 (
u8
 *Ë
p
->
aö¢
.
ö¢
;

317 
	`BUG_ON
((
s64
Ë(
s32
Ë
√wdi•
 !=Çewdisp);

318 
di•
 = (
u8
 *Ë
p
->
aö¢
.
ö¢
 + 
	`ö¢_off£t_di•œ˚mít
(&insn);

319 *(
s32
 *Ë
di•
 = (s32Ë
√wdi•
;

322 
	}
}

324 
__k¥obes
 
	$¨ch_c›y_k¥obe
(
k¥obe
 *
p
)

326 
	`mem˝y
(
p
->
aö¢
.
ö¢
,Ö->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

328 
	`fix_rùªl
(
p
);

330 i‡(
	`ˇn_boo°
(
p
->
addr
))

331 
p
->
aö¢
.
boo°abÀ
 = 0;

333 
p
->
aö¢
.
boo°abÀ
 = -1;

335 
p
->
›code
 = *p->
addr
;

336 
	}
}

338 
__k¥obes
 
	$¨ch_¥ï¨e_k¥obe
(
k¥obe
 *
p
)

340 i‡(!
	`ˇn_¥obe
(()
p
->
addr
))

341  -
EILSEQ
;

343 
p
->
aö¢
.
ö¢
 = 
	`gë_ö¢_¶Ÿ
();

344 i‡(!
p
->
aö¢
.
ö¢
)

345  -
ENOMEM
;

346 
	`¨ch_c›y_k¥obe
(
p
);

348 
	}
}

350 
__k¥obes
 
	$¨ch_¨m_k¥obe
(
k¥obe
 *
p
)

352 
	`ãxt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

353 
	}
}

355 
__k¥obes
 
	$¨ch_dißrm_k¥obe
(
k¥obe
 *
p
)

357 
	`ãxt_poke
(
p
->
addr
, &p->
›code
, 1);

358 
	}
}

360 
__k¥obes
 
	$¨ch_ªmove_k¥obe
(
k¥obe
 *
p
)

362 i‡(
p
->
aö¢
.
ö¢
) {

363 
	`‰ì_ö¢_¶Ÿ
(
p
->
aö¢
.
ö¢
, (p->aö¢.
boo°abÀ
 == 1));

364 
p
->
aö¢
.
ö¢
 = 
NULL
;

366 
	}
}

368 
__k¥obes
 
	$ßve_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

370 
kcb
->
¥ev_k¥obe
.
kp
 = 
	`k¥obe_ru¬ög
();

371 
kcb
->
¥ev_k¥obe
.
°©us
 = kcb->
k¥obe_°©us
;

372 
kcb
->
¥ev_k¥obe
.
ﬁd_Êags
 = kcb->
k¥obe_ﬁd_Êags
;

373 
kcb
->
¥ev_k¥obe
.
ßved_Êags
 = kcb->
k¥obe_ßved_Êags
;

374 
	}
}

376 
__k¥obes
 
	$ª°‹e_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

378 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
kcb
->
¥ev_k¥obe
.
kp
;

379 
kcb
->
k¥obe_°©us
 = kcb->
¥ev_k¥obe
.
°©us
;

380 
kcb
->
k¥obe_ﬁd_Êags
 = kcb->
¥ev_k¥obe
.
ﬁd_Êags
;

381 
kcb
->
k¥obe_ßved_Êags
 = kcb->
¥ev_k¥obe
.
ßved_Êags
;

382 
	}
}

384 
__k¥obes
 
	$£t_cuºít_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

385 
k¥obe_˘lblk
 *
kcb
)

387 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
p
;

388 
kcb
->
k¥obe_ßved_Êags
 = kcb->
k¥obe_ﬁd_Êags


389 (
ªgs
->
Êags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

390 i‡(
	`is_IF_modifõr
(
p
->
aö¢
.
ö¢
))

391 
kcb
->
k¥obe_ßved_Êags
 &~
X86_EFLAGS_IF
;

392 
	}
}

394 
__k¥obes
 
	$˛ór_btf
()

396 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

397 
	`upd©e_debug˘lm§
(0);

398 
	}
}

400 
__k¥obes
 
	$ª°‹e_btf
()

402 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

403 
	`upd©e_debug˘lm§
(
cuºít
->
thªad
.
debug˘lm§
);

404 
	}
}

406 
__k¥obes
 
	$¥ï¨e_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

408 
	`˛ór_btf
();

409 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

410 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

412 i‡(
p
->
›code
 =
BREAKPOINT_INSTRUCTION
)

413 
ªgs
->
ù
 = ()
p
->
addr
;

415 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

416 
	}
}

418 
__k¥obes
 
	$¨ch_¥ï¨e_kªçrobe
(
kªçrobe_ö°™˚
 *
ri
,

419 
±_ªgs
 *
ªgs
)

421 *
ßø
 = 
	`°ack_addr
(
ªgs
);

423 
ri
->
ªt_addr
 = (
k¥obe_›code_t
 *Ë*
ßø
;

426 *
ßø
 = (Ë&
kªçrobe_åampﬁöe
;

427 
	}
}

429 
__k¥obes
 
	$£tup_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

430 
k¥obe_˘lblk
 *
kcb
)

432 #i‡!
	`deföed
(
CONFIG_PREEMPT
Ë|| deföed(
CONFIG_FREEZER
)

433 i‡(
p
->
aö¢
.
boo°abÀ
 =1 && !p->
po°_h™dÀr
) {

435 
	`ª£t_cuºít_k¥obe
();

436 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

437 
	`¥ìm±_íabÀ_no_ªsched
();

441 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

442 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SS
;

443 
	}
}

450 
__k¥obes
 
	$ªíãr_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

451 
k¥obe_˘lblk
 *
kcb
)

453 
kcb
->
k¥obe_°©us
) {

454 
KPROBE_HIT_SSDONE
:

455 
KPROBE_HIT_ACTIVE
:

456 
	`ßve_¥evious_k¥obe
(
kcb
);

457 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

458 
	`k¥obes_öc_nmis£d_cou¡
(
p
);

459 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

460 
kcb
->
k¥obe_°©us
 = 
KPROBE_REENTER
;

462 
KPROBE_HIT_SS
:

469 
	`¥ötk
(
KERN_WARNING
 "Unrecoverable kprobe detectedát %p.\n",

470 
p
->
addr
);

471 
	`dump_k¥obe
(
p
);

472 
	`BUG
();

475 
	`WARN_ON
(1);

480 
	}
}

486 
__k¥obes
 
	$k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

488 
k¥obe_›code_t
 *
addr
;

489 
k¥obe
 *
p
;

490 
k¥obe_˘lblk
 *
kcb
;

492 
addr
 = (
k¥obe_›code_t
 *)(
ªgs
->
ù
 - (kprobe_opcode_t));

493 i‡(*
addr
 !
BREAKPOINT_INSTRUCTION
) {

503 
ªgs
->
ù
 = ()
addr
;

513 
	`¥ìm±_dißbÀ
();

515 
kcb
 = 
	`gë_k¥obe_˘lblk
();

516 
p
 = 
	`gë_k¥obe
(
addr
);

518 i‡(
p
) {

519 i‡(
	`k¥obe_ru¬ög
()) {

520 i‡(
	`ªíãr_k¥obe
(
p
, 
ªgs
, 
kcb
))

523 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

524 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

534 i‡(!
p
->
¥e_h™dÀr
 || !p->
	`¥e_h™dÀr
’, 
ªgs
))

535 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

538 } i‡(
	`k¥obe_ru¬ög
()) {

539 
p
 = 
	`__gë_˝u_v¨
(
cuºít_k¥obe
);

540 i‡(
p
->
bªak_h™dÀr
 &&Ö->
	`bªak_h™dÀr
’, 
ªgs
)) {

541 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

546 
	`¥ìm±_íabÀ_no_ªsched
();

548 
	}
}

554 
__u£d
 
__k¥obes
 
	$kªçrobe_åampﬁöe_hﬁdî
()

556 
asm
 volatile (

559 #ifde‡
CONFIG_X86_64


641 
	}
}

646 
__u£d
 
__k¥obes
 *
	$åampﬁöe_h™dÀr
(
±_ªgs
 *
ªgs
)

648 
kªçrobe_ö°™˚
 *
ri
 = 
NULL
;

649 
hli°_hód
 *
hód
, 
em±y_Ω
;

650 
hli°_node
 *
node
, *
tmp
;

651 
Êags
, 
‹ig_ªt_addªss
 = 0;

652 
åampﬁöe_addªss
 = ()&
kªçrobe_åampﬁöe
;

654 
	`INIT_HLIST_HEAD
(&
em±y_Ω
);

655 
	`kªçrobe_hash_lock
(
cuºít
, &
hód
, &
Êags
);

657 #ifde‡
CONFIG_X86_64


658 
ªgs
->
cs
 = 
__KERNEL_CS
;

660 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

661 
ªgs
->
gs
 = 0;

663 
ªgs
->
ù
 = 
åampﬁöe_addªss
;

664 
ªgs
->
‹ig_ax
 = ~0UL;

679 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, 
hód
, 
hli°
) {

680 i‡(
ri
->
èsk
 !
cuºít
)

684 i‡(
ri
->
Ω
 &&Ñi->Ω->
h™dÀr
) {

685 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
ri
->
Ω
->
kp
;

686 
	`gë_k¥obe_˘lblk
()->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

687 
ri
->
Ω
->
	`h™dÀr
‘i, 
ªgs
);

688 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

691 
‹ig_ªt_addªss
 = ()
ri
->
ªt_addr
;

692 
	`ªcy˛e_Ω_ö°
(
ri
, &
em±y_Ω
);

694 i‡(
‹ig_ªt_addªss
 !
åampﬁöe_addªss
)

703 
	`kªçrobe_as£π
(
ri
, 
‹ig_ªt_addªss
, 
åampﬁöe_addªss
);

705 
	`kªçrobe_hash_u∆ock
(
cuºít
, &
Êags
);

707 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, &
em±y_Ω
, 
hli°
) {

708 
	`hli°_dñ
(&
ri
->
hli°
);

709 
	`k‰ì
(
ri
);

711  (*)
‹ig_ªt_addªss
;

712 
	}
}

741 
__k¥obes
 
	$ªsume_executi⁄
(
k¥obe
 *
p
,

742 
±_ªgs
 *
ªgs
, 
k¥obe_˘lblk
 *
kcb
)

744 *
tos
 = 
	`°ack_addr
(
ªgs
);

745 
c›y_ù
 = ()
p
->
aö¢
.
ö¢
;

746 
‹ig_ù
 = ()
p
->
addr
;

747 
k¥obe_›code_t
 *
ö¢
 = 
p
->
aö¢
.insn;

750 i‡(
	`is_REX_¥efix
(
ö¢
))

751 
ö¢
++;

753 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

754 *
ö¢
) {

756 *
tos
 &~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

757 *
tos
 |
kcb
->
k¥obe_ﬁd_Êags
;

766 
p
->
aö¢
.
boo°abÀ
 = 1;

767 
no_ch™ge
;

769 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

771 #ifde‡
CONFIG_X86_32


773 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

774 
no_ch™ge
;

777 i‡((
ö¢
[1] & 0x30) == 0x10) {

783 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

784 
no_ch™ge
;

785 } i‡(((
ö¢
[1] & 0x31) == 0x20) ||

786 ((
ö¢
[1] & 0x31) == 0x21)) {

791 
p
->
aö¢
.
boo°abÀ
 = 1;

792 
no_ch™ge
;

798 i‡(
p
->
aö¢
.
boo°abÀ
 == 0) {

799 i‡((
ªgs
->
ù
 > 
c›y_ù
) &&

800 (
ªgs
->
ù
 - 
c›y_ù
Ë+ 5 < 
MAX_INSN_SIZE
) {

805 
	`£t_jmp_›
((*)
ªgs
->
ù
,

806 (*)
‹ig_ù
 + (
ªgs
->
ù
 - 
c›y_ù
));

807 
p
->
aö¢
.
boo°abÀ
 = 1;

809 
p
->
aö¢
.
boo°abÀ
 = -1;

813 
ªgs
->
ù
 +
‹ig_ù
 - 
c›y_ù
;

815 
no_ch™ge
:

816 
	`ª°‹e_btf
();

817 
	}
}

823 
__k¥obes
 
	$po°_k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

825 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

826 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

828 i‡(!
cur
)

831 
	`ªsume_executi⁄
(
cur
, 
ªgs
, 
kcb
);

832 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

834 i‡((
kcb
->
k¥obe_°©us
 !
KPROBE_REENTER
Ë&& 
cur
->
po°_h™dÀr
) {

835 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SSDONE
;

836 
cur
->
	`po°_h™dÀr
(cur, 
ªgs
, 0);

840 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
) {

841 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

842 
out
;

844 
	`ª£t_cuºít_k¥obe
();

845 
out
:

846 
	`¥ìm±_íabÀ_no_ªsched
();

853 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
)

857 
	}
}

859 
__k¥obes
 
	$k¥obe_Áu…_h™dÀr
(
±_ªgs
 *
ªgs
, 
å≠ƒ
)

861 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

862 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

864 
kcb
->
k¥obe_°©us
) {

865 
KPROBE_HIT_SS
:

866 
KPROBE_REENTER
:

874 
ªgs
->
ù
 = ()
cur
->
addr
;

875 
ªgs
->
Êags
 |
kcb
->
k¥obe_ﬁd_Êags
;

876 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
)

877 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

879 
	`ª£t_cuºít_k¥obe
();

880 
	`¥ìm±_íabÀ_no_ªsched
();

882 
KPROBE_HIT_ACTIVE
:

883 
KPROBE_HIT_SSDONE
:

889 
	`k¥obes_öc_nmis£d_cou¡
(
cur
);

898 i‡(
cur
->
Áu…_h™dÀr
 && cur->
	`Áu…_h™dÀr
(cur, 
ªgs
, 
å≠ƒ
))

905 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

917 
	}
}

922 
__k¥obes
 
	$k¥obe_ex˚±i⁄s_nŸify
(
nŸifõr_block
 *
£lf
,

923 
vÆ
, *
d©a
)

925 
dõ_¨gs
 *
¨gs
 = 
d©a
;

926 
ªt
 = 
NOTIFY_DONE
;

928 i‡(
¨gs
->
ªgs
 && 
	`u£r_mode_vm
(args->regs))

929  
ªt
;

931 
vÆ
) {

932 
DIE_INT3
:

933 i‡(
	`k¥obe_h™dÀr
(
¨gs
->
ªgs
))

934 
ªt
 = 
NOTIFY_STOP
;

936 
DIE_DEBUG
:

937 i‡(
	`po°_k¥obe_h™dÀr
(
¨gs
->
ªgs
)) {

942 (*(*)
	`ERR_PTR
(
¨gs
->
îr
)Ë&~
DR_STEP
;

943 
ªt
 = 
NOTIFY_STOP
;

946 
DIE_GPF
:

952 i‡(!
	`¥ìm±ibÀ
(Ë&& 
	`k¥obe_ru¬ög
() &&

953 
	`k¥obe_Áu…_h™dÀr
(
¨gs
->
ªgs
,árgs->
å≠ƒ
))

954 
ªt
 = 
NOTIFY_STOP
;

959  
ªt
;

960 
	}
}

962 
__k¥obes
 
	$£tjmp_¥e_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

964 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

965 
addr
;

966 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

968 
kcb
->
j¥obe_ßved_ªgs
 = *
ªgs
;

969 
kcb
->
j¥obe_ßved_•
 = 
	`°ack_addr
(
ªgs
);

970 
addr
 = ()(
kcb
->
j¥obe_ßved_•
);

979 
	`mem˝y
(
kcb
->
j¥obes_°ack
, (
k¥obe_›code_t
 *)
addr
,

980 
	`MIN_STACK_SIZE
(
addr
));

981 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

982 
	`åa˚_h¨dúqs_off
();

983 
ªgs
->
ù
 = ()(
jp
->
íåy
);

985 
	}
}

987 
__k¥obes
 
	$j¥obe_ªtu∫
()

989 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

991 
asm
 volatile (

992 #ifde‡
CONFIG_X86_64


1001 (
kcb
->
j¥obe_ßved_•
):"memory");

1002 
	}
}

1004 
__k¥obes
 
	$l⁄gjmp_bªak_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1006 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1007 
u8
 *
addr
 = (u8 *Ë(
ªgs
->
ù
 - 1);

1008 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1010 i‡((
addr
 > (
u8
 *Ë
j¥obe_ªtu∫
) &&

1011 (
addr
 < (
u8
 *Ë
j¥obe_ªtu∫_íd
)) {

1012 i‡(
	`°ack_addr
(
ªgs
Ë!
kcb
->
j¥obe_ßved_•
) {

1013 
±_ªgs
 *
ßved_ªgs
 = &
kcb
->
j¥obe_ßved_ªgs
;

1014 
	`¥ötk
(
KERN_ERR


1016 
	`°ack_addr
(
ªgs
), 
kcb
->
j¥obe_ßved_•
);

1017 
	`¥ötk
(
KERN_ERR
 "SavedÑegi°î†f‹ j¥obê%p\n", 
jp
);

1018 
	`show_ªgi°îs
(
ßved_ªgs
);

1019 
	`¥ötk
(
KERN_ERR
 "CurrentÑegisters\n");

1020 
	`show_ªgi°îs
(
ªgs
);

1021 
	`BUG
();

1023 *
ªgs
 = 
kcb
->
j¥obe_ßved_ªgs
;

1024 
	`mem˝y
((
k¥obe_›code_t
 *)(
kcb
->
j¥obe_ßved_•
),

1025 
kcb
->
j¥obes_°ack
,

1026 
	`MIN_STACK_SIZE
(
kcb
->
j¥obe_ßved_•
));

1027 
	`¥ìm±_íabÀ_no_ªsched
();

1031 
	}
}

1033 
__öô
 
	$¨ch_öô_k¥obes
()

1036 
	}
}

1038 
__k¥obes
 
	$¨ch_åampﬁöe_k¥obe
(
k¥obe
 *
p
)

1041 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<löux/î∫o.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/uac˚ss.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/ldt.h
>

19 
	~<asm/desc.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

21 
	~<asm/sysˇŒs.h
>

23 #ifde‡
CONFIG_SMP


24 
	$Êush_ldt
(*
cuºít_mm
)

26 i‡(
cuºít
->
a˘ive_mm
 =
cuºít_mm
)

27 
	`lﬂd_LDT
(&
cuºít
->
a˘ive_mm
->
c⁄ãxt
);

28 
	}
}

31 
	$Æloc_ldt
(
mm_c⁄ãxt_t
 *
pc
, 
möcou¡
, 
ªlﬂd
)

33 *
ﬁdldt
, *
√wldt
;

34 
ﬁdsize
;

36 i‡(
möcou¡
 <
pc
->
size
)

38 
ﬁdsize
 = 
pc
->
size
;

39 
möcou¡
 = (möcou¡ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

40 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

41 i‡(
möcou¡
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

42 
√wldt
 = 
	`vmÆloc
(
möcou¡
 * 
LDT_ENTRY_SIZE
);

44 
√wldt
 = (*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
);

46 i‡(!
√wldt
)

47  -
ENOMEM
;

49 i‡(
ﬁdsize
)

50 
	`mem˝y
(
√wldt
, 
pc
->
ldt
, 
ﬁdsize
 * 
LDT_ENTRY_SIZE
);

51 
ﬁdldt
 = 
pc
->
ldt
;

52 
	`mem£t
(
√wldt
 + 
ﬁdsize
 * 
LDT_ENTRY_SIZE
, 0,

53 (
möcou¡
 - 
ﬁdsize
Ë* 
LDT_ENTRY_SIZE
);

55 
	`∑øvút_Æloc_ldt
(
√wldt
, 
möcou¡
);

57 #ifde‡
CONFIG_X86_64


59 
	`wmb
();

61 
pc
->
ldt
 = 
√wldt
;

62 
	`wmb
();

63 
pc
->
size
 = 
möcou¡
;

64 
	`wmb
();

66 i‡(
ªlﬂd
) {

67 #ifde‡
CONFIG_SMP


68 
	`¥ìm±_dißbÀ
();

69 
	`lﬂd_LDT
(
pc
);

70 i‡(!
	`˝umask_equÆ
(
	`mm_˝umask
(
cuºít
->
mm
),

71 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
())))

72 
	`smp_ˇŒ_fun˘i⁄
(
Êush_ldt
, 
cuºít
->
mm
, 1);

73 
	`¥ìm±_íabÀ
();

75 
	`lﬂd_LDT
(
pc
);

78 i‡(
ﬁdsize
) {

79 
	`∑øvút_‰ì_ldt
(
ﬁdldt
, 
ﬁdsize
);

80 i‡(
ﬁdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

81 
	`v‰ì
(
ﬁdldt
);

83 
	`put_∑ge
(
	`vút_to_∑ge
(
ﬁdldt
));

86 
	}
}

88 
ölöe
 
	$c›y_ldt
(
mm_c⁄ãxt_t
 *
√w
, mm_c⁄ãxt_à*
ﬁd
)

90 
îr
 = 
	`Æloc_ldt
(
√w
, 
ﬁd
->
size
, 0);

91 
i
;

93 i‡(
îr
 < 0)

94  
îr
;

96 
i
 = 0; i < 
ﬁd
->
size
; i++)

97 
	`wrôe_ldt_íåy
(
√w
->
ldt
, 
i
, 
ﬁd
->ldà+ i * 
LDT_ENTRY_SIZE
);

99 
	}
}

105 
	$öô_√w_c⁄ãxt
(
èsk_°ru˘
 *
tsk
, 
mm_°ru˘
 *
mm
)

107 
mm_°ru˘
 *
ﬁd_mm
;

108 
ªtvÆ
 = 0;

110 
	`muãx_öô
(&
mm
->
c⁄ãxt
.
lock
);

111 
mm
->
c⁄ãxt
.
size
 = 0;

112 
ﬁd_mm
 = 
cuºít
->
mm
;

113 i‡(
ﬁd_mm
 && old_mm->
c⁄ãxt
.
size
 > 0) {

114 
	`muãx_lock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

115 
ªtvÆ
 = 
	`c›y_ldt
(&
mm
->
c⁄ãxt
, &
ﬁd_mm
->context);

116 
	`muãx_u∆ock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

118  
ªtvÆ
;

119 
	}
}

126 
	$de°roy_c⁄ãxt
(
mm_°ru˘
 *
mm
)

128 i‡(
mm
->
c⁄ãxt
.
size
) {

129 #ifde‡
CONFIG_X86_32


131 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

132 
	`˛ór_LDT
();

134 
	`∑øvút_‰ì_ldt
(
mm
->
c⁄ãxt
.
ldt
, mm->c⁄ãxt.
size
);

135 i‡(
mm
->
c⁄ãxt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

136 
	`v‰ì
(
mm
->
c⁄ãxt
.
ldt
);

138 
	`put_∑ge
(
	`vút_to_∑ge
(
mm
->
c⁄ãxt
.
ldt
));

139 
mm
->
c⁄ãxt
.
size
 = 0;

141 
	}
}

143 
	$ªad_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

145 
îr
;

146 
size
;

147 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

149 i‡(!
mm
->
c⁄ãxt
.
size
)

151 i‡(
byãcou¡
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

152 
byãcou¡
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

154 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

155 
size
 = 
mm
->
c⁄ãxt
.sizê* 
LDT_ENTRY_SIZE
;

156 i‡(
size
 > 
byãcou¡
)

157 
size
 = 
byãcou¡
;

159 
îr
 = 0;

160 i‡(
	`c›y_to_u£r
(
±r
, 
mm
->
c⁄ãxt
.
ldt
, 
size
))

161 
îr
 = -
EFAULT
;

162 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

163 i‡(
îr
 < 0)

164 
îr‹_ªtu∫
;

165 i‡(
size
 !
byãcou¡
) {

167 i‡(
	`˛ór_u£r
(
±r
 + 
size
, 
byãcou¡
 - size) != 0) {

168 
îr
 = -
EFAULT
;

169 
îr‹_ªtu∫
;

172  
byãcou¡
;

173 
îr‹_ªtu∫
:

174  
îr
;

175 
	}
}

177 
	$ªad_deÁu…_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

180 #ifde‡
CONFIG_X86_32


181 
size
 = 5 * (
desc_°ru˘
);

183 
size
 = 128;

185 i‡(
byãcou¡
 > 
size
)

186 
byãcou¡
 = 
size
;

187 i‡(
	`˛ór_u£r
(
±r
, 
byãcou¡
))

188  -
EFAULT
;

189  
byãcou¡
;

190 
	}
}

192 
	$wrôe_ldt
(
__u£r
 *
±r
, 
byãcou¡
, 
ﬁdmode
)

194 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

195 
desc_°ru˘
 
ldt
;

196 
îr‹
;

197 
u£r_desc
 
ldt_öfo
;

199 
îr‹
 = -
EINVAL
;

200 i‡(
byãcou¡
 !(
ldt_öfo
))

201 
out
;

202 
îr‹
 = -
EFAULT
;

203 i‡(
	`c›y_‰om_u£r
(&
ldt_öfo
, 
±r
, (ldt_info)))

204 
out
;

206 
îr‹
 = -
EINVAL
;

207 i‡(
ldt_öfo
.
íåy_numbî
 >
LDT_ENTRIES
)

208 
out
;

209 i‡(
ldt_öfo
.
c⁄ã¡s
 == 3) {

210 i‡(
ﬁdmode
)

211 
out
;

212 i‡(
ldt_öfo
.
£g_nŸ_¥e£¡
 == 0)

213 
out
;

216 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

217 i‡(
ldt_öfo
.
íåy_numbî
 >
mm
->
c⁄ãxt
.
size
) {

218 
îr‹
 = 
	`Æloc_ldt
(&
cuºít
->
mm
->
c⁄ãxt
,

219 
ldt_öfo
.
íåy_numbî
 + 1, 1);

220 i‡(
îr‹
 < 0)

221 
out_u∆ock
;

225 i‡(
ldt_öfo
.
ba£_addr
 =0 &&Üdt_öfo.
limô
 == 0) {

226 i‡(
ﬁdmode
 || 
	`LDT_em±y
(&
ldt_öfo
)) {

227 
	`mem£t
(&
ldt
, 0, (ldt));

228 
ö°Æl
;

232 
	`fûl_ldt
(&
ldt
, &
ldt_öfo
);

233 i‡(
ﬁdmode
)

234 
ldt
.
avl
 = 0;

237 
ö°Æl
:

238 
	`wrôe_ldt_íåy
(
mm
->
c⁄ãxt
.
ldt
, 
ldt_öfo
.
íåy_numbî
, &ldt);

239 
îr‹
 = 0;

241 
out_u∆ock
:

242 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

243 
out
:

244  
îr‹
;

245 
	}
}

247 
asmlökage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

248 
byãcou¡
)

250 
ªt
 = -
ENOSYS
;

252 
func
) {

254 
ªt
 = 
	`ªad_ldt
(
±r
, 
byãcou¡
);

257 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 1);

260 
ªt
 = 
	`ªad_deÁu…_ldt
(
±r
, 
byãcou¡
);

263 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 0);

266  
ªt
;

267 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<löux/mm.h
>

10 
	~<löux/kexec.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/ªboŸ.h
>

13 
	~<löux/numa.h
>

14 
	~<löux/·ø˚.h
>

15 
	~<löux/io.h
>

16 
	~<löux/su•íd.h
>

18 
	~<asm/pgèbÀ.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

21 
	~<asm/debugªg.h
>

23 
	$öô_⁄e_Àvñ2_∑ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

24 
addr
)

26 
pud_t
 *
pud
;

27 
pmd_t
 *
pmd
;

28 
∑ge
 *page;

29 
ªsu…
 = -
ENOMEM
;

31 
addr
 &
PMD_MASK
;

32 
pgd
 +
	`pgd_ödex
(
addr
);

33 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

34 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

35 i‡(!
∑ge
)

36 
out
;

37 
pud
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

38 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

39 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

41 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

42 i‡(!
	`pud_¥e£¡
(*
pud
)) {

43 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

44 i‡(!
∑ge
)

45 
out
;

46 
pmd
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

47 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

48 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

50 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

51 i‡(!
	`pmd_¥e£¡
(*
pmd
))

52 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

53 
ªsu…
 = 0;

54 
out
:

55  
ªsu…
;

56 
	}
}

58 
	$öô_Àvñ2_∑ge
(
pmd_t
 *
Àvñ2p
, 
addr
)

60 
íd_addr
;

62 
addr
 &
PAGE_MASK
;

63 
íd_addr
 = 
addr
 + 
PUD_SIZE
;

64 
addr
 < 
íd_addr
) {

65 
	`£t_pmd
(
Àvñ2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

66 
addr
 +
PMD_SIZE
;

68 
	}
}

70 
	$öô_Àvñ3_∑ge
(
kimage
 *
image
, 
pud_t
 *
Àvñ3p
,

71 
addr
, 
œ°_addr
)

73 
íd_addr
;

74 
ªsu…
;

76 
ªsu…
 = 0;

77 
addr
 &
PAGE_MASK
;

78 
íd_addr
 = 
addr
 + 
PGDIR_SIZE
;

79 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

80 
∑ge
 *page;

81 
pmd_t
 *
Àvñ2p
;

83 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

84 i‡(!
∑ge
) {

85 
ªsu…
 = -
ENOMEM
;

86 
out
;

88 
Àvñ2p
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

89 
	`öô_Àvñ2_∑ge
(
Àvñ2p
, 
addr
);

90 
	`£t_pud
(
Àvñ3p
++, 
	`__pud
(
	`__∑
(
Àvñ2p
Ë| 
_KERNPG_TABLE
));

91 
addr
 +
PUD_SIZE
;

94 
addr
 < 
íd_addr
) {

95 
	`pud_˛ór
(
Àvñ3p
++);

96 
addr
 +
PUD_SIZE
;

98 
out
:

99  
ªsu…
;

100 
	}
}

103 
	$öô_Àvñ4_∑ge
(
kimage
 *
image
, 
pgd_t
 *
Àvñ4p
,

104 
addr
, 
œ°_addr
)

106 
íd_addr
;

107 
ªsu…
;

109 
ªsu…
 = 0;

110 
addr
 &
PAGE_MASK
;

111 
íd_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

112 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

113 
∑ge
 *page;

114 
pud_t
 *
Àvñ3p
;

116 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

117 i‡(!
∑ge
) {

118 
ªsu…
 = -
ENOMEM
;

119 
out
;

121 
Àvñ3p
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

122 
ªsu…
 = 
	`öô_Àvñ3_∑ge
(
image
, 
Àvñ3p
, 
addr
, 
œ°_addr
);

123 i‡(
ªsu…
)

124 
out
;

125 
	`£t_pgd
(
Àvñ4p
++, 
	`__pgd
(
	`__∑
(
Àvñ3p
Ë| 
_KERNPG_TABLE
));

126 
addr
 +
PGDIR_SIZE
;

129 
addr
 < 
íd_addr
) {

130 
	`pgd_˛ór
(
Àvñ4p
++);

131 
addr
 +
PGDIR_SIZE
;

133 
out
:

134  
ªsu…
;

135 
	}
}

137 
	$‰ì_å™sôi⁄_pgèbÀ
(
kimage
 *
image
)

139 
	`‰ì_∑ge
(()
image
->
¨ch
.
pud
);

140 
	`‰ì_∑ge
(()
image
->
¨ch
.
pmd
);

141 
	`‰ì_∑ge
(()
image
->
¨ch
.
±e
);

142 
	}
}

144 
	$öô_å™sôi⁄_pgèbÀ
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

146 
pud_t
 *
pud
;

147 
pmd_t
 *
pmd
;

148 
±e_t
 *
±e
;

149 
vaddr
, 
∑ddr
;

150 
ªsu…
 = -
ENOMEM
;

152 
vaddr
 = ()
ªloˇã_kî√l
;

153 
∑ddr
 = 
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
)+
PAGE_SIZE
);

154 
pgd
 +
	`pgd_ödex
(
vaddr
);

155 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

156 
pud
 = (
pud_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

157 i‡(!
pud
)

158 
îr
;

159 
image
->
¨ch
.
pud
 =Öud;

160 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

162 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

163 i‡(!
	`pud_¥e£¡
(*
pud
)) {

164 
pmd
 = (
pmd_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

165 i‡(!
pmd
)

166 
îr
;

167 
image
->
¨ch
.
pmd
 =Ömd;

168 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

170 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

171 i‡(!
	`pmd_¥e£¡
(*
pmd
)) {

172 
±e
 = (
±e_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

173 i‡(!
±e
)

174 
îr
;

175 
image
->
¨ch
.
±e
 =Öte;

176 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__∑
(
±e
Ë| 
_KERNPG_TABLE
));

178 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

179 
	`£t_±e
(
±e
, 
	`p‚_±e
(
∑ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

181 
îr
:

182 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

183  
ªsu…
;

184 
	}
}

187 
	$öô_pgèbÀ
(
kimage
 *
image
, 
°¨t_pgèbÀ
)

189 
pgd_t
 *
Àvñ4p
;

190 
ªsu…
;

191 
Àvñ4p
 = (
pgd_t
 *)
	`__va
(
°¨t_pgèbÀ
);

192 
ªsu…
 = 
	`öô_Àvñ4_∑ge
(
image
, 
Àvñ4p
, 0, 
max_p‚
 << 
PAGE_SHIFT
);

193 i‡(
ªsu…
)

194  
ªsu…
;

199 
ªsu…
 = 
	`öô_⁄e_Àvñ2_∑ge
(
image
, 
Àvñ4p
, image->
°¨t
);

200 i‡(
ªsu…
)

201  
ªsu…
;

202  
	`öô_å™sôi⁄_pgèbÀ
(
image
, 
Àvñ4p
);

203 
	}
}

205 
	$£t_idt
(*
√widt
, 
u16
 
limô
)

207 
desc_±r
 
curidt
;

210 
curidt
.
size
 = 
limô
;

211 
curidt
.
addªss
 = ()
√widt
;

213 
__asm__
 
	`__vﬁ©ûe__
 (

215 : : "m" (
curidt
)

217 
	}
};

220 
	$£t_gdt
(*
√wgdt
, 
u16
 
limô
)

222 
desc_±r
 
curgdt
;

225 
curgdt
.
size
 = 
limô
;

226 
curgdt
.
addªss
 = ()
√wgdt
;

228 
__asm__
 
	`__vﬁ©ûe__
 (

230 : : "m" (
curgdt
)

232 
	}
};

234 
	$lﬂd_£gmíts
()

236 
__asm__
 
	`__vﬁ©ûe__
 (

242 : : "a" (
__KERNEL_DS
) : "memory"

244 
	}
}

246 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

248 
°¨t_pgèbÀ
;

249 
ªsu…
;

252 
°¨t_pgèbÀ
 = 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

255 
ªsu…
 = 
	`öô_pgèbÀ
(
image
, 
°¨t_pgèbÀ
);

256 i‡(
ªsu…
)

257  
ªsu…
;

260 
	}
}

262 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

264 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

265 
	}
}

271 
	$machöe_kexec
(
kimage
 *
image
)

273 
∑ge_li°
[
PAGES_NR
];

274 *
c⁄åﬁ_∑ge
;

275 
ßve_·ø˚_íabÀd
;

277 #ifde‡
CONFIG_KEXEC_JUMP


278 i‡(
image
->
¥e£rve_c⁄ãxt
)

279 
	`ßve_¥o˚ss‹_°©e
();

282 
ßve_·ø˚_íabÀd
 = 
	`__·ø˚_íabÀd_ßve
();

285 
	`loˇl_úq_dißbÀ
();

286 
	`hw_bªakpoöt_dißbÀ
();

288 i‡(
image
->
¥e£rve_c⁄ãxt
) {

289 #ifde‡
CONFIG_X86_IO_APIC


297 
	`dißbÀ_IO_APIC
();

301 
c⁄åﬁ_∑ge
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
Ë+ 
PAGE_SIZE
;

302 
	`mem˝y
(
c⁄åﬁ_∑ge
, 
ªloˇã_kî√l
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

304 
∑ge_li°
[
PA_CONTROL_PAGE
] = 
	`vút_to_phys
(
c⁄åﬁ_∑ge
);

305 
∑ge_li°
[
VA_CONTROL_PAGE
] = ()
c⁄åﬁ_∑ge
;

306 
∑ge_li°
[
PA_TABLE_PAGE
] =

307 ()
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
));

309 i‡(
image
->
ty≥
 =
KEXEC_TYPE_DEFAULT
)

310 
∑ge_li°
[
PA_SWAP_PAGE
] = (
	`∑ge_to_p‚
(
image
->
sw≠_∑ge
)

311 << 
PAGE_SHIFT
);

323 
	`lﬂd_£gmíts
();

328 
	`£t_gdt
(
	`phys_to_vút
(0), 0);

329 
	`£t_idt
(
	`phys_to_vút
(0), 0);

332 
image
->
°¨t
 = 
	`ªloˇã_kî√l
(()image->
hód
,

333 ()
∑ge_li°
,

334 
image
->
°¨t
,

335 
image
->
¥e£rve_c⁄ãxt
);

337 #ifde‡
CONFIG_KEXEC_JUMP


338 i‡(
image
->
¥e£rve_c⁄ãxt
)

339 
	`ª°‹e_¥o˚ss‹_°©e
();

342 
	`__·ø˚_íabÀd_ª°‹e
(
ßve_·ø˚_íabÀd
);

343 
	}
}

345 
	$¨ch_¸ash_ßve_vmc‹eöfo
()

347 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

348 
	`VMCOREINFO_SYMBOL
(
öô_Àvñ4_pgt
);

350 #ifde‡
CONFIG_NUMA


351 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

352 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

354 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

17 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

19 
	~<löux/fúmw¨e.h
>

20 
	~<löux/pci_ids.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/vmÆloc.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/pci.h
>

27 
	~<asm/mi¸ocode.h
>

28 
	~<asm/¥o˚ss‹.h
>

29 
	~<asm/m§.h
>

31 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

32 
MODULE_AUTHOR
("Peter Oruba");

33 
MODULE_LICENSE
("GPL v2");

35 
	#UCODE_MAGIC
 0x00414d44

	)

36 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

37 
	#UCODE_UCODE_TYPE
 0x00000001

	)

39 
	sequiv_˝u_íåy
 {

40 
u32
 
	mö°ÆÀd_˝u
;

41 
u32
 
	mfixed_îøè_mask
;

42 
u32
 
	mfixed_îøè_com∑ª
;

43 
u16
 
	mequiv_˝u
;

44 
u16
 
	mªs
;

45 } 
__©åibuã__
((
∑cked
));

47 
	smi¸ocode_hódî_amd
 {

48 
u32
 
	md©a_code
;

49 
u32
 
	m∑tch_id
;

50 
u16
 
	mmc_∑tch_d©a_id
;

51 
u8
 
	mmc_∑tch_d©a_Àn
;

52 
u8
 
	möô_Êag
;

53 
u32
 
	mmc_∑tch_d©a_checksum
;

54 
u32
 
	mnb_dev_id
;

55 
u32
 
	msb_dev_id
;

56 
u16
 
	m¥o˚ss‹_ªv_id
;

57 
u8
 
	mnb_ªv_id
;

58 
u8
 
	msb_ªv_id
;

59 
u8
 
	mbios_≠i_ªv
;

60 
u8
 
	mª£rved1
[3];

61 
u32
 
	mm©ch_ªg
[8];

62 } 
__©åibuã__
((
∑cked
));

64 
	smi¸ocode_amd
 {

65 
mi¸ocode_hódî_amd
 
	mhdr
;

66 
	mmpb
[0];

69 
	#UCODE_MAX_SIZE
 2048

	)

70 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

71 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

73 
equiv_˝u_íåy
 *
	gequiv_˝u_èbÀ
;

75 
	$cﬁÀ˘_˝u_öfo_amd
(
˝u
, 
˝u_sig«tuª
 *
csig
)

77 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

78 
u32
 
dummy
;

80 
	`mem£t
(
csig
, 0, (*csig));

81 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

82 
	`¥_w¨nög
("microcode: CPU%d: AMD CPU family 0x%xÇot "

83 "suµ‹ãd\n", 
˝u
, 
c
->
x86
);

86 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
ªv
, 
dummy
);

87 
	`¥_öfo
("CPU%d:Ö©ch_Àvñ=0x%x\n", 
˝u
, 
csig
->
ªv
);

89 
	}
}

91 
	$gë_m©chög_mi¸ocode
(
˝u
, *
mc
, 
ªv
)

93 
mi¸ocode_hódî_amd
 *
mc_hódî
 = 
mc
;

94 
cuºít_˝u_id
;

95 
u16
 
equiv_˝u_id
 = 0;

96 
i
 = 0;

98 
	`BUG_ON
(
equiv_˝u_èbÀ
 =
NULL
);

99 
cuºít_˝u_id
 = 
	`˝uid_óx
(0x00000001);

101 
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
 != 0) {

102 i‡(
cuºít_˝u_id
 =
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
) {

103 
equiv_˝u_id
 = 
equiv_˝u_èbÀ
[
i
].
equiv_˝u
;

106 
i
++;

109 i‡(!
equiv_˝u_id
)

112 i‡(
mc_hódî
->
¥o˚ss‹_ªv_id
 !
equiv_˝u_id
)

116 i‡(
mc_hódî
->
nb_dev_id
 || mc_hódî->
sb_dev_id
) {

117 
	`¥_îr
("CPU%d:Üoading of chipset specific codeÇot yet supported\n",

118 
˝u
);

122 i‡(
mc_hódî
->
∑tch_id
 <
ªv
)

126 
	}
}

128 
	$≠∂y_mi¸ocode_amd
(
˝u
)

130 
u32
 
ªv
, 
dummy
;

131 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

132 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u_num
;

133 
mi¸ocode_amd
 *
mc_amd
 = 
uci
->
mc
;

136 
	`BUG_ON
(
˝u_num
 !
˝u
);

138 i‡(
mc_amd
 =
NULL
)

141 
	`wrm§l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

143 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
ªv
, 
dummy
);

146 i‡(
ªv
 !
mc_amd
->
hdr
.
∑tch_id
) {

147 
	`¥_îr
("CPU%d: update failed (forÖatch_level=0x%x)\n",

148 
˝u
, 
mc_amd
->
hdr
.
∑tch_id
);

152 
	`¥_öfo
("CPU%d: upd©ed (√wÖ©ch_Àvñ=0x%x)\n", 
˝u
, 
ªv
);

153 
uci
->
˝u_sig
.
ªv
 =Ñev;

156 
	}
}

158 
	$gë_ucode_d©a
(*
to
, c⁄° 
u8
 *
‰om
, 
size_t
 
n
)

160 
	`mem˝y
(
to
, 
‰om
, 
n
);

162 
	}
}

165 
	$gë_√xt_ucode
(c⁄° 
u8
 *
buf
, 
size
, *
mc_size
)

167 
tŸÆ_size
;

168 
u8
 
£˘i⁄_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

169 *
mc
;

171 i‡(
	`gë_ucode_d©a
(
£˘i⁄_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

172  
NULL
;

174 i‡(
£˘i⁄_hdr
[0] !
UCODE_UCODE_TYPE
) {

175 
	`¥_îr
("error: invalidÅype field in container file section header\n");

176  
NULL
;

179 
tŸÆ_size
 = (Ë(
£˘i⁄_hdr
[4] + (section_hdr[5] << 8));

181 i‡(
tŸÆ_size
 > 
size
 ||ÅŸÆ_sizê> 
UCODE_MAX_SIZE
) {

182 
	`¥_îr
("error: size mismatch\n");

183  
NULL
;

186 
mc
 = 
	`vmÆloc
(
UCODE_MAX_SIZE
);

187 i‡(
mc
) {

188 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

189 i‡(
	`gë_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

190 
tŸÆ_size
)) {

191 
	`v‰ì
(
mc
);

192 
mc
 = 
NULL
;

194 *
mc_size
 = 
tŸÆ_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

196  
mc
;

197 
	}
}

199 
	$ö°Æl_equiv_˝u_èbÀ
(c⁄° 
u8
 *
buf
)

201 
u8
 *
c⁄èöî_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

202 *
buf_pos
 = (*)
c⁄èöî_hdr
;

203 
size
;

205 i‡(
	`gë_ucode_d©a
(&
c⁄èöî_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

208 
size
 = 
buf_pos
[2];

210 i‡(
buf_pos
[1] !
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

211 
	`¥_îr
("error: invalidÅype field in container file section header\n");

215 
equiv_˝u_èbÀ
 = (
equiv_˝u_íåy
 *Ë
	`vmÆloc
(
size
);

216 i‡(!
equiv_˝u_èbÀ
) {

217 
	`¥_îr
("failedÅoállocateÉquivalent CPUÅable\n");

221 
buf
 +
UCODE_CONTAINER_HEADER_SIZE
;

222 i‡(
	`gë_ucode_d©a
(
equiv_˝u_èbÀ
, 
buf
, 
size
)) {

223 
	`v‰ì
(
equiv_˝u_èbÀ
);

227  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

228 
	}
}

230 
	$‰ì_equiv_˝u_èbÀ
()

232 
	`v‰ì
(
equiv_˝u_èbÀ
);

233 
equiv_˝u_èbÀ
 = 
NULL
;

234 
	}
}

236 
ucode_°©e


237 
	$gíîic_lﬂd_mi¸ocode
(
˝u
, c⁄° 
u8
 *
d©a
, 
size_t
 
size
)

239 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

240 c⁄° 
u8
 *
ucode_±r
 = 
d©a
;

241 *
√w_mc
 = 
NULL
;

242 *
mc
;

243 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

244 
À·ovî
;

245 
off£t
;

246 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

248 
off£t
 = 
	`ö°Æl_equiv_˝u_èbÀ
(
ucode_±r
);

249 i‡(!
off£t
) {

250 
	`¥_îr
("failedÅo createÉquivalent cpuÅable\n");

251  
UCODE_ERROR
;

254 
ucode_±r
 +
off£t
;

255 
À·ovî
 = 
size
 - 
off£t
;

257 
À·ovî
) {

258 
	`unöôülized_v¨
(
mc_size
);

259 
mi¸ocode_hódî_amd
 *
mc_hódî
;

261 
mc
 = 
	`gë_√xt_ucode
(
ucode_±r
, 
À·ovî
, &
mc_size
);

262 i‡(!
mc
)

265 
mc_hódî
 = (
mi¸ocode_hódî_amd
 *)
mc
;

266 i‡(
	`gë_m©chög_mi¸ocode
(
˝u
, 
mc
, 
√w_ªv
)) {

267 
	`v‰ì
(
√w_mc
);

268 
√w_ªv
 = 
mc_hódî
->
∑tch_id
;

269 
√w_mc
 = 
mc
;

271 
	`v‰ì
(
mc
);

273 
ucode_±r
 +
mc_size
;

274 
À·ovî
 -
mc_size
;

277 i‡(
√w_mc
) {

278 i‡(!
À·ovî
) {

279 
	`v‰ì
(
uci
->
mc
);

280 
uci
->
mc
 = 
√w_mc
;

281 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

282 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

284 
	`v‰ì
(
√w_mc
);

285 
°©e
 = 
UCODE_ERROR
;

288 
°©e
 = 
UCODE_NFOUND
;

290 
	`‰ì_equiv_˝u_èbÀ
();

292  
°©e
;

293 
	}
}

295 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

297 c⁄° *
fw_«me
 = "amd-ucode/microcode_amd.bin";

298 c⁄° 
fúmw¨e
 *firmware;

299 
ucode_°©e
 
ªt
;

301 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
fw_«me
, 
devi˚
)) {

302 
	`¥ötk
(
KERN_ERR
 "mi¸ocode: faûedÅÿlﬂd fûê%s\n", 
fw_«me
);

303  
UCODE_NFOUND
;

306 i‡(*(
u32
 *)
fúmw¨e
->
d©a
 !
UCODE_MAGIC
) {

307 
	`¥_îr
("invalid UCODE_MAGIC (0x%08x)\n",

308 *(
u32
 *)
fúmw¨e
->
d©a
);

309  
UCODE_ERROR
;

312 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, 
fúmw¨e
->
d©a
, fúmw¨e->
size
);

314 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

316  
ªt
;

317 
	}
}

319 
ucode_°©e


320 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

322 
	`¥_öfo
("AMD microcode update via /dev/cpu/microcodeÇot supported\n");

323  
UCODE_ERROR
;

324 
	}
}

326 
	$mi¸ocode_föi_˝u_amd
(
˝u
)

328 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

330 
	`v‰ì
(
uci
->
mc
);

331 
uci
->
mc
 = 
NULL
;

332 
	}
}

334 
mi¸ocode_›s
 
	gmi¸ocode_amd_›s
 = {

335 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

336 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

337 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo_amd
,

338 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode_amd
,

339 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u_amd
,

342 
mi¸ocode_›s
 * 
__öô
 
	$öô_amd_mi¸ocode
()

344  &
mi¸ocode_amd_›s
;

345 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/∂©f‹m_devi˚.h
>

77 
	~<löux/miscdevi˚.h
>

78 
	~<löux/ˇ∑bûôy.h
>

79 
	~<löux/kî√l.h
>

80 
	~<löux/moduÀ.h
>

81 
	~<löux/muãx.h
>

82 
	~<löux/˝u.h
>

83 
	~<löux/fs.h
>

84 
	~<löux/mm.h
>

86 
	~<asm/mi¸ocode.h
>

87 
	~<asm/¥o˚ss‹.h
>

89 
MODULE_DESCRIPTION
("Microcode Update Driver");

90 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

91 
MODULE_LICENSE
("GPL");

93 
	#MICROCODE_VERSION
 "2.00"

	)

95 
mi¸ocode_›s
 *
	gmi¸ocode_›s
;

109 
DEFINE_MUTEX
(
mi¸ocode_muãx
);

111 
ucode_˝u_öfo
 
	gucode_˝u_öfo
[
NR_CPUS
];

112 
EXPORT_SYMBOL_GPL
(
ucode_˝u_öfo
);

118 
	s˝u_öfo_˘x
 {

119 
˝u_sig«tuª
 *
	m˝u_sig
;

120 
	mîr
;

123 
	$cﬁÀ˘_˝u_öfo_loˇl
(*
¨g
)

125 
˝u_öfo_˘x
 *
˘x
 = 
¨g
;

127 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`cﬁÀ˘_˝u_öfo
(
	`smp_¥o˚ss‹_id
(),

128 
˘x
->
˝u_sig
);

129 
	}
}

131 
	$cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, 
˝u_sig«tuª
 *
˝u_sig
)

133 
˝u_öfo_˘x
 
˘x
 = { .
˝u_sig
 = cpu_sig, .
îr
 = 0 };

134 
ªt
;

136 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
cﬁÀ˘_˝u_öfo_loˇl
, &
˘x
, 1);

137 i‡(!
ªt
)

138 
ªt
 = 
˘x
.
îr
;

140  
ªt
;

141 
	}
}

143 
	$cﬁÀ˘_˝u_öfo
(
˝u
)

145 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

146 
ªt
;

148 
	`mem£t
(
uci
, 0, (*uci));

150 
ªt
 = 
	`cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, &
uci
->
˝u_sig
);

151 i‡(!
ªt
)

152 
uci
->
vÆid
 = 1;

154  
ªt
;

155 
	}
}

157 
	s≠∂y_mi¸ocode_˘x
 {

158 
	mîr
;

161 
	$≠∂y_mi¸ocode_loˇl
(*
¨g
)

163 
≠∂y_mi¸ocode_˘x
 *
˘x
 = 
¨g
;

165 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
	`smp_¥o˚ss‹_id
());

166 
	}
}

168 
	$≠∂y_mi¸ocode_⁄_èrgë
(
˝u
)

170 
≠∂y_mi¸ocode_˘x
 
˘x
 = { .
îr
 = 0 };

171 
ªt
;

173 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
≠∂y_mi¸ocode_loˇl
, &
˘x
, 1);

174 i‡(!
ªt
)

175 
ªt
 = 
˘x
.
îr
;

177  
ªt
;

178 
	}
}

180 #ifde‡
CONFIG_MICROCODE_OLD_INTERFACE


181 
	$do_mi¸ocode_upd©e
(c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

183 
îr‹
 = 0;

184 
˝u
;

186 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

187 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

188 
ucode_°©e
 
u°©e
;

190 i‡(!
uci
->
vÆid
)

193 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_u£r
(
˝u
, 
buf
, 
size
);

194 i‡(
u°©e
 =
UCODE_ERROR
) {

195 
îr‹
 = -1;

197 } i‡(
u°©e
 =
UCODE_OK
)

198 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

201  
îr‹
;

202 
	}
}

204 
	$mi¸ocode_›í
(
öode
 *
unu£d1
, 
fûe
 *
unu£d2
)

206  
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
Ë? 0 : -
EPERM
;

207 
	}
}

209 
ssize_t
 
	$mi¸ocode_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

210 
size_t
 
Àn
, 
loff_t
 *
µos
)

212 
ssize_t
 
ªt
 = -
EINVAL
;

214 i‡((
Àn
 >> 
PAGE_SHIFT
Ë> 
tŸÆøm_∑ges
) {

215 
	`¥_îr
("toÿmuch d©®(max %ldÖages)\n", 
tŸÆøm_∑ges
);

216  
ªt
;

219 
	`gë_⁄löe_˝us
();

220 
	`muãx_lock
(&
mi¸ocode_muãx
);

222 i‡(
	`do_mi¸ocode_upd©e
(
buf
, 
Àn
) == 0)

223 
ªt
 = (
ssize_t
)
Àn
;

225 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

226 
	`put_⁄löe_˝us
();

228  
ªt
;

229 
	}
}

231 c⁄° 
fûe_›î©i⁄s
 
	gmi¸ocode_f›s
 = {

232 .
ow√r
 = 
THIS_MODULE
,

233 .
	gwrôe
 = 
mi¸ocode_wrôe
,

234 .
	g›í
 = 
mi¸ocode_›í
,

237 
miscdevi˚
 
	gmi¸ocode_dev
 = {

238 .
mö‹
 = 
MICROCODE_MINOR
,

239 .
	g«me
 = "microcode",

240 .
	gnodíame
 = "cpu/microcode",

241 .
	gf›s
 = &
mi¸ocode_f›s
,

244 
__öô
 
	$mi¸ocode_dev_öô
()

246 
îr‹
;

248 
îr‹
 = 
	`misc_ªgi°î
(&
mi¸ocode_dev
);

249 i‡(
îr‹
) {

250 
	`¥_îr
("ˇn'àmisc_ªgi°î o¿mö‹=%d\n", 
MICROCODE_MINOR
);

251  
îr‹
;

255 
	}
}

257 
	$mi¸ocode_dev_exô
()

259 
	`misc_dîegi°î
(&
mi¸ocode_dev
);

260 
	}
}

262 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

264 
	#mi¸ocode_dev_öô
(Ë0

	)

265 
	#mi¸ocode_dev_exô
(Ëdÿ{ } 0)

	)

269 
∂©f‹m_devi˚
 *
	gmi¸ocode_pdev
;

271 
	$ªlﬂd_f‹_˝u
(
˝u
)

273 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

274 
îr
 = 0;

276 
	`muãx_lock
(&
mi¸ocode_muãx
);

277 i‡(
uci
->
vÆid
) {

278 
ucode_°©e
 
u°©e
;

280 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

281 i‡(
u°©e
 =
UCODE_OK
)

282 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

284 i‡(
u°©e
 =
UCODE_ERROR
)

285 
îr
 = -
EINVAL
;

287 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

289  
îr
;

290 
	}
}

292 
ssize_t
 
	$ªlﬂd_°‹e
(
sys_devi˚
 *
dev
,

293 
sysdev_©åibuã
 *
©å
,

294 c⁄° *
buf
, 
size_t
 
size
)

296 
vÆ
;

297 
˝u
 = 
dev
->
id
;

298 
ªt
 = 0;

299 *
íd
;

301 
vÆ
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

302 i‡(
íd
 =
buf
)

303  -
EINVAL
;

305 i‡(
vÆ
 == 1) {

306 
	`gë_⁄löe_˝us
();

307 i‡(
	`˝u_⁄löe
(
˝u
))

308 
ªt
 = 
	`ªlﬂd_f‹_˝u
(
˝u
);

309 
	`put_⁄löe_˝us
();

312 i‡(!
ªt
)

313 
ªt
 = 
size
;

315  
ªt
;

316 
	}
}

318 
ssize_t
 
	$vîsi⁄_show
(
sys_devi˚
 *
dev
,

319 
sysdev_©åibuã
 *
©å
, *
buf
)

321 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

323  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
ªv
);

324 
	}
}

326 
ssize_t
 
	$pf_show
(
sys_devi˚
 *
dev
,

327 
sysdev_©åibuã
 *
©å
, *
buf
)

329 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

331  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
pf
);

332 
	}
}

334 
SYSDEV_ATTR
(
ªlﬂd
, 0200, 
NULL
, 
ªlﬂd_°‹e
);

335 
SYSDEV_ATTR
(
vîsi⁄
, 0400, 
vîsi⁄_show
, 
NULL
);

336 
SYSDEV_ATTR
(
¥o˚ss‹_Êags
, 0400, 
pf_show
, 
NULL
);

338 
©åibuã
 *
	gmc_deÁu…_©ås
[] = {

339 &
©å_ªlﬂd
.
©å
,

340 &
©å_vîsi⁄
.
©å
,

341 &
©å_¥o˚ss‹_Êags
.
©å
,

342 
NULL


345 
©åibuã_group
 
	gmc_©å_group
 = {

346 .
©ås
 = 
mc_deÁu…_©ås
,

347 .
	g«me
 = "microcode",

350 
	$mi¸ocode_föi_˝u
(
˝u
)

352 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

354 
mi¸ocode_›s
->
	`mi¸ocode_föi_˝u
(
˝u
);

355 
uci
->
vÆid
 = 0;

356 
	}
}

358 
ucode_°©e
 
	$mi¸ocode_ªsume_˝u
(
˝u
)

360 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

362 i‡(!
uci
->
mc
)

363  
UCODE_NFOUND
;

365 
	`¥_debug
("CPU%d upd©ed up⁄Ñesume\n", 
˝u
);

366 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

368  
UCODE_OK
;

369 
	}
}

371 
ucode_°©e
 
	$mi¸ocode_öô_˝u
(
˝u
)

373 
ucode_°©e
 
u°©e
;

375 i‡(
	`cﬁÀ˘_˝u_öfo
(
˝u
))

376  
UCODE_ERROR
;

379 i‡(
sy°em_°©e
 !
SYSTEM_RUNNING
)

380  
UCODE_NFOUND
;

382 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

384 i‡(
u°©e
 =
UCODE_OK
) {

385 
	`¥_debug
("CPU%d upd©ed up⁄ inô\n", 
˝u
);

386 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

389  
u°©e
;

390 
	}
}

392 
ucode_°©e
 
	$mi¸ocode_upd©e_˝u
(
˝u
)

394 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

395 
ucode_°©e
 
u°©e
;

397 i‡(
uci
->
vÆid
)

398 
u°©e
 = 
	`mi¸ocode_ªsume_˝u
(
˝u
);

400 
u°©e
 = 
	`mi¸ocode_öô_˝u
(
˝u
);

402  
u°©e
;

403 
	}
}

405 
	$mc_sysdev_add
(
sys_devi˚
 *
sys_dev
)

407 
îr
, 
˝u
 = 
sys_dev
->
id
;

409 i‡(!
	`˝u_⁄löe
(
˝u
))

412 
	`¥_debug
("CPU%dádded\n", 
˝u
);

414 
îr
 = 
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

415 i‡(
îr
)

416  
îr
;

418 i‡(
	`mi¸ocode_öô_˝u
(
˝u
Ë=
UCODE_ERROR
)

419 
îr
 = -
EINVAL
;

421  
îr
;

422 
	}
}

424 
	$mc_sysdev_ªmove
(
sys_devi˚
 *
sys_dev
)

426 
˝u
 = 
sys_dev
->
id
;

428 i‡(!
	`˝u_⁄löe
(
˝u
))

431 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

432 
	`mi¸ocode_föi_˝u
(
˝u
);

433 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

435 
	}
}

437 
	$mc_sysdev_ªsume
(
sys_devi˚
 *
dev
)

439 
˝u
 = 
dev
->
id
;

440 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

442 i‡(!
	`˝u_⁄löe
(
˝u
))

452 
	`WARN_ON
(
˝u
 != 0);

454 i‡(
uci
->
vÆid
 && uci->
mc
)

455 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
˝u
);

458 
	}
}

460 
sysdev_drivî
 
	gmc_sysdev_drivî
 = {

461 .
add
 = 
mc_sysdev_add
,

462 .
	gªmove
 = 
mc_sysdev_ªmove
,

463 .
	gªsume
 = 
mc_sysdev_ªsume
,

466 
__˝uöô
 

467 
	$mc_˝u_ˇŒback
(
nŸifõr_block
 *
nb
, 
a˘i⁄
, *
h˝u
)

469 
˝u
 = ()
h˝u
;

470 
sys_devi˚
 *
sys_dev
;

472 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

473 
a˘i⁄
) {

474 
CPU_ONLINE
:

475 
CPU_ONLINE_FROZEN
:

476 
	`mi¸ocode_upd©e_˝u
(
˝u
);

477 
CPU_DOWN_FAILED
:

478 
CPU_DOWN_FAILED_FROZEN
:

479 
	`¥_debug
("CPU%dádded\n", 
˝u
);

480 i‡(
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
))

481 
	`¥_îr
("FaûedÅÿ¸óã grou∞f‹ CPU%d\n", 
˝u
);

483 
CPU_DOWN_PREPARE
:

484 
CPU_DOWN_PREPARE_FROZEN
:

486 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

487 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

489 
CPU_DEAD
:

490 
CPU_UP_CANCELED_FROZEN
:

492 
	`mi¸ocode_föi_˝u
(
˝u
);

495  
NOTIFY_OK
;

496 
	}
}

498 
nŸifõr_block
 
__ªfd©a
 
	gmc_˝u_nŸifõr
 = {

499 .
nŸifõr_ˇŒ
 = 
mc_˝u_ˇŒback
,

502 
__öô
 
	$mi¸ocode_öô
()

504 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(0);

505 
îr‹
;

507 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

508 
mi¸ocode_›s
 = 
	`öô_öãl_mi¸ocode
();

509 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)

510 
mi¸ocode_›s
 = 
	`öô_amd_mi¸ocode
();

512 i‡(!
mi¸ocode_›s
) {

513 
	`¥_îr
("no support forÅhis CPU vendor\n");

514  -
ENODEV
;

517 
mi¸ocode_pdev
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("microcode", -1,

518 
NULL
, 0);

519 i‡(
	`IS_ERR
(
mi¸ocode_pdev
)) {

520 
	`mi¸ocode_dev_exô
();

521  
	`PTR_ERR
(
mi¸ocode_pdev
);

524 
	`gë_⁄löe_˝us
();

525 
	`muãx_lock
(&
mi¸ocode_muãx
);

527 
îr‹
 = 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

529 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

530 
	`put_⁄löe_˝us
();

532 i‡(
îr‹
) {

533 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

534  
îr‹
;

537 
îr‹
 = 
	`mi¸ocode_dev_öô
();

538 i‡(
îr‹
)

539  
îr‹
;

541 
	`ªgi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

543 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION


547 
	}
}

548 
moduÀ_öô
(
mi¸ocode_öô
);

550 
__exô
 
	$mi¸ocode_exô
()

552 
	`mi¸ocode_dev_exô
();

554 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

556 
	`gë_⁄löe_˝us
();

557 
	`muãx_lock
(&
mi¸ocode_muãx
);

559 
	`sysdev_drivî_uƒegi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

561 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

562 
	`put_⁄löe_˝us
();

564 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

566 
mi¸ocode_›s
 = 
NULL
;

568 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION
 "Ñemoved.\n");

569 
	}
}

570 
moduÀ_exô
(
mi¸ocode_exô
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/fúmw¨e.h
>

77 
	~<löux/uac˚ss.h
>

78 
	~<löux/kî√l.h
>

79 
	~<löux/moduÀ.h
>

80 
	~<löux/vmÆloc.h
>

82 
	~<asm/mi¸ocode.h
>

83 
	~<asm/¥o˚ss‹.h
>

84 
	~<asm/m§.h
>

86 
MODULE_DESCRIPTION
("Microcode Update Driver");

87 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

88 
MODULE_LICENSE
("GPL");

90 
	smi¸ocode_hódî_öãl
 {

91 
	mhdrvî
;

92 
	mªv
;

93 
	md©e
;

94 
	msig
;

95 
	mcksum
;

96 
	mldrvî
;

97 
	mpf
;

98 
	md©asize
;

99 
	mtŸÆsize
;

100 
	mª£rved
[3];

103 
	smi¸ocode_öãl
 {

104 
mi¸ocode_hódî_öãl
 
	mhdr
;

105 
	mbôs
[0];

109 
	sexãnded_sig«tuª
 {

110 
	msig
;

111 
	mpf
;

112 
	mcksum
;

115 
	sexãnded_sigèbÀ
 {

116 
	mcou¡
;

117 
	mcksum
;

118 
	mª£rved
[3];

119 
exãnded_sig«tuª
 
	msigs
[0];

122 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

123 
	#MC_HEADER_SIZE
 ((
mi¸ocode_hódî_öãl
))

	)

124 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

125 
	#EXT_HEADER_SIZE
 ((
exãnded_sigèbÀ
))

	)

126 
	#EXT_SIGNATURE_SIZE
 ((
exãnded_sig«tuª
))

	)

127 
	#DWSIZE
 ((
u32
))

	)

129 
	#gë_tŸÆsize
(
mc
) \

130 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 ? \

131 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 : \

132 
DEFAULT_UCODE_TOTALSIZE
)

	)

134 
	#gë_d©asize
(
mc
) \

135 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 ? \

136 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

138 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

139 (((
s1
Ë=(
s2
)Ë&& (((
p1
Ë& (
p2
)Ë|| ((’1Ë=0Ë&& (’2Ë=0))))

	)

141 
	#exâabÀ_size
(
ë
Ë(”t)->
cou¡
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

143 
	$cﬁÀ˘_˝u_öfo
(
˝u_num
, 
˝u_sig«tuª
 *
csig
)

145 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u_num
);

146 
vÆ
[2];

148 
	`mem£t
(
csig
, 0, (*csig));

150 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

151 
	`˝u_has
(
c
, 
X86_FEATURE_IA64
)) {

152 
	`¥_îr
("CPU%dÇŸá c≠abÀ I¡ñÖro˚ss‹\n", 
˝u_num
);

156 
csig
->
sig
 = 
	`˝uid_óx
(0x00000001);

158 i‡((
c
->
x86_modñ
 >5Ë|| (c->
x86
 > 6)) {

160 
	`rdm§
(
MSR_IA32_PLATFORM_ID
, 
vÆ
[0], val[1]);

161 
csig
->
pf
 = 1 << ((
vÆ
[1] >> 18) & 7);

164 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

166 
	`sync_c‹e
();

168 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], 
csig
->
ªv
);

170 
	`¥_öfo
("CPU%d sig=0x%x,Öf=0x%x,Ñevision=0x%x\n",

171 
˝u_num
, 
csig
->
sig
, csig->
pf
, csig->
ªv
);

174 
	}
}

176 
ölöe
 
	$upd©e_m©ch_˝u
(
˝u_sig«tuª
 *
csig
, 
sig
, 
pf
)

178  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

179 
	}
}

181 
ölöe
 

182 
	$upd©e_m©ch_ªvisi⁄
(
mi¸ocode_hódî_öãl
 *
mc_hódî
, 
ªv
)

184  (
mc_hódî
->
ªv
 <=Ñev) ? 0 : 1;

185 
	}
}

187 
	$mi¸ocode_ßnôy_check
(*
mc
)

189 
tŸÆ_size
, 
d©a_size
, 
ext_èbÀ_size
;

190 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

191 
exãnded_sigèbÀ
 *
ext_hódî
 = 
NULL
;

192 
sum
, 
‹ig_sum
, 
ext_sigcou¡
 = 0, 
i
;

193 
exãnded_sig«tuª
 *
ext_sig
;

195 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

196 
d©a_size
 = 
	`gë_d©asize
(
mc_hódî
);

198 i‡(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tŸÆ_size
) {

199 
	`¥_îr
("error! Bad data size in microcode data file\n");

200  -
EINVAL
;

203 i‡(
mc_hódî
->
ldrvî
 !1 || mc_hódî->
hdrvî
 != 1) {

204 
	`¥_îr
("error! Unknown microcode update format\n");

205  -
EINVAL
;

207 
ext_èbÀ_size
 = 
tŸÆ_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

208 i‡(
ext_èbÀ_size
) {

209 i‡((
ext_èbÀ_size
 < 
EXT_HEADER_SIZE
)

210 || ((
ext_èbÀ_size
 - 
EXT_HEADER_SIZE
Ë% 
EXT_SIGNATURE_SIZE
)) {

211 
	`¥_îr
("error! SmallÉxttable size in microcode data file\n");

212  -
EINVAL
;

214 
ext_hódî
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

215 i‡(
ext_èbÀ_size
 !
	`exâabÀ_size
(
ext_hódî
)) {

216 
	`¥_îr
("error! BadÉxttable size in microcode data file\n");

217  -
EFAULT
;

219 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

223 i‡(
ext_èbÀ_size
) {

224 
ext_èbÀ_sum
 = 0;

225 *
ext_èbÀp
 = (*)
ext_hódî
;

227 
i
 = 
ext_èbÀ_size
 / 
DWSIZE
;

228 
i
--)

229 
ext_èbÀ_sum
 +
ext_èbÀp
[
i
];

230 i‡(
ext_èbÀ_sum
) {

231 
	`¥_w¨nög
("aborting, badÉxtended signatureÅable checksum\n");

232  -
EINVAL
;

237 
‹ig_sum
 = 0;

238 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
Ë/ 
DWSIZE
;

239 
i
--)

240 
‹ig_sum
 +((*)
mc
)[
i
];

241 i‡(
‹ig_sum
) {

242 
	`¥_îr
("aborting, bad checksum\n");

243  -
EINVAL
;

245 i‡(!
ext_èbÀ_size
)

248 
i
 = 0; i < 
ext_sigcou¡
; i++) {

249 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
 +

250 
EXT_SIGNATURE_SIZE
 * 
i
;

251 
sum
 = 
‹ig_sum


252 - (
mc_hódî
->
sig
 + mc_hódî->
pf
 + mc_hódî->
cksum
)

253 + (
ext_sig
->
sig
 +Éxt_sig->
pf
 +Éxt_sig->
cksum
);

254 i‡(
sum
) {

255 
	`¥_îr
("aborting, bad checksum\n");

256  -
EINVAL
;

260 
	}
}

267 
	$gë_m©chög_mi¸ocode
(
˝u_sig«tuª
 *
˝u_sig
, *
mc
, 
ªv
)

269 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

270 
exãnded_sigèbÀ
 *
ext_hódî
;

271 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

272 
ext_sigcou¡
, 
i
;

273 
exãnded_sig«tuª
 *
ext_sig
;

275 i‡(!
	`upd©e_m©ch_ªvisi⁄
(
mc_hódî
, 
ªv
))

278 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
mc_hódî
->
sig
, mc_hódî->
pf
))

282 i‡(
tŸÆ_size
 <
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
)

285 
ext_hódî
 = 
mc
 + 
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
;

286 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

287 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
;

289 
i
 = 0; i < 
ext_sigcou¡
; i++) {

290 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
ext_sig
->
sig
,Éxt_sig->
pf
))

292 
ext_sig
++;

295 
	}
}

297 
	$≠∂y_mi¸ocode
(
˝u
)

299 
mi¸ocode_öãl
 *
mc_öãl
;

300 
ucode_˝u_öfo
 *
uci
;

301 
vÆ
[2];

302 
˝u_num
;

304 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

305 
uci
 = 
ucode_˝u_öfo
 + 
˝u
;

306 
mc_öãl
 = 
uci
->
mc
;

309 
	`BUG_ON
(
˝u_num
 !
˝u
);

311 i‡(
mc_öãl
 =
NULL
)

315 
	`wrm§
(
MSR_IA32_UCODE_WRITE
,

316 (Ë
mc_öãl
->
bôs
,

317 (Ë
mc_öãl
->
bôs
 >> 16 >> 16);

318 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

321 
	`sync_c‹e
();

324 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], val[1]);

326 i‡(
vÆ
[1] !
mc_öãl
->
hdr
.
ªv
) {

327 
	`¥_îr
("CPU%d updateÅoÑevision 0x%x failed\n",

328 
˝u_num
, 
mc_öãl
->
hdr
.
ªv
);

331 
	`¥_öfo
("CPU%d updatedÅoÑevision 0x%x, date = %04x-%02x-%02x \n",

332 
˝u_num
, 
vÆ
[1],

333 
mc_öãl
->
hdr
.
d©e
 & 0xffff,

334 
mc_öãl
->
hdr
.
d©e
 >> 24,

335 (
mc_öãl
->
hdr
.
d©e
 >> 16) & 0xff);

337 
uci
->
˝u_sig
.
ªv
 = 
vÆ
[1];

340 
	}
}

342 
ucode_°©e
 
gíîic_lﬂd_mi¸ocode
(
˝u
, *
d©a
, 
size_t
 
size
,

343 (*
gë_ucode_d©a
)(*, c⁄° *, 
size_t
))

345 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

346 
u8
 *
ucode_±r
 = 
d©a
, *
√w_mc
 = 
NULL
, *
mc
;

347 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

348 
À·ovî
 = 
size
;

349 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

351 
À·ovî
) {

352 
mi¸ocode_hódî_öãl
 
mc_hódî
;

353 
mc_size
;

355 i‡(
	`gë_ucode_d©a
(&
mc_hódî
, 
ucode_±r
, (mc_header)))

358 
mc_size
 = 
	`gë_tŸÆsize
(&
mc_hódî
);

359 i‡(!
mc_size
 || mc_sizê> 
À·ovî
) {

360 
	`¥_îr
("error! Bad data in microcode data file\n");

364 
mc
 = 
	`vmÆloc
(
mc_size
);

365 i‡(!
mc
)

368 i‡(
	`gë_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

369 
	`mi¸ocode_ßnôy_check
(
mc
) < 0) {

370 
	`v‰ì
(
mc
);

374 i‡(
	`gë_m©chög_mi¸ocode
(&
uci
->
˝u_sig
, 
mc
, 
√w_ªv
)) {

375 i‡(
√w_mc
)

376 
	`v‰ì
(
√w_mc
);

377 
√w_ªv
 = 
mc_hódî
.
ªv
;

378 
√w_mc
 = 
mc
;

380 
	`v‰ì
(
mc
);

382 
ucode_±r
 +
mc_size
;

383 
À·ovî
 -
mc_size
;

386 i‡(
À·ovî
) {

387 i‡(
√w_mc
)

388 
	`v‰ì
(
√w_mc
);

389 
°©e
 = 
UCODE_ERROR
;

390 
out
;

393 i‡(!
√w_mc
) {

394 
°©e
 = 
UCODE_NFOUND
;

395 
out
;

398 i‡(
uci
->
mc
)

399 
	`v‰ì
(
uci
->
mc
);

400 
uci
->
mc
 = (
mi¸ocode_öãl
 *)
√w_mc
;

402 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

403 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

404 
out
:

405  
°©e
;

406 
	}
}

408 
	$gë_ucode_fw
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

410 
	`mem˝y
(
to
, 
‰om
, 
n
);

412 
	}
}

414 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

416 
«me
[30];

417 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

418 c⁄° 
fúmw¨e
 *firmware;

419 
ucode_°©e
 
ªt
;

421 
	`•rötf
(
«me
, "intel-ucode/%02x-%02x-%02x",

422 
c
->
x86
, c->
x86_modñ
, c->
x86_mask
);

424 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
«me
, 
devi˚
)) {

425 
	`¥_debug
("d©®fûê%†lﬂd faûed\n", 
«me
);

426  
UCODE_NFOUND
;

429 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
fúmw¨e
->
d©a
,

430 
fúmw¨e
->
size
, &
gë_ucode_fw
);

432 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

434  
ªt
;

435 
	}
}

437 
	$gë_ucode_u£r
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

439  
	`c›y_‰om_u£r
(
to
, 
‰om
, 
n
);

440 
	}
}

442 
ucode_°©e


443 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

445  
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
buf
, 
size
, &
gë_ucode_u£r
);

446 
	}
}

448 
	$mi¸ocode_föi_˝u
(
˝u
)

450 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

452 
	`v‰ì
(
uci
->
mc
);

453 
uci
->
mc
 = 
NULL
;

454 
	}
}

456 
mi¸ocode_›s
 
	gmi¸ocode_öãl_›s
 = {

457 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

458 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

459 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo
,

460 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode
,

461 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u
,

464 
mi¸ocode_›s
 * 
__öô
 
	$öô_öãl_mi¸ocode
()

466  &
mi¸ocode_öãl_›s
;

467 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/dmi.h
>

10 
	~<asm/pci-dúe˘.h
>

11 
	~<löux/s‹t.h
>

12 
	~<asm/io.h
>

13 
	~<asm/m§.h
>

14 
	~<asm/a˝i.h
>

15 
	~<asm/mmc⁄fig.h
>

16 
	~<asm/pci_x86.h
>

18 
	spci_ho°bridge_¥obe
 {

19 
u32
 
	mbus
;

20 
u32
 
	m¶Ÿ
;

21 
u32
 
	mvíd‹
;

22 
u32
 
	mdevi˚
;

25 
u64
 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£
;

26 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£_°©us
;

28 
pci_ho°bridge_¥obe
 
	gpci_¥obes
[] 
	g__˝uöôd©a
 = {

29 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

30 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

33 
	sønge
 {

34 
u64
 
	m°¨t
;

35 
u64
 
	míd
;

38 
__˝uöô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

40 c⁄° 
ønge
 *
r1
 = 
x1
;

41 c⁄° 
ønge
 *
r2
 = 
x2
;

42 
°¨t1
, 
°¨t2
;

44 
°¨t1
 = 
r1
->
°¨t
 >> 32;

45 
°¨t2
 = 
r2
->
°¨t
 >> 32;

47  
°¨t1
 - 
°¨t2
;

48 
	}
}

52 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

53 
	#BASE_VALID
(
b
Ë((b !(0xfdULL << 32)Ë&& (b !(0x„ULL << 32)))

	)

54 
__˝uöô
 
	$gë_Ám10h_pci_mmc⁄f_ba£
()

56 
i
;

57 
bus
;

58 
¶Ÿ
;

59 
found
;

61 
u64
 
vÆ
;

62 
u32
 
addªss
;

63 
u64
 
tom2
;

64 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

66 
hi_mmio_num
;

67 
ønge
Ñange[8];

71 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
)

74 i‡(!
	`óæy_pci_Ælowed
())

75 
Áû
;

77 
found
 = 0;

78 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_¥obes
); i++) {

79 
u32
 
id
;

80 
u16
 
devi˚
;

81 
u16
 
víd‹
;

83 
bus
 = 
pci_¥obes
[
i
].bus;

84 
¶Ÿ
 = 
pci_¥obes
[
i
].slot;

85 
id
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 0, 
PCI_VENDOR_ID
);

87 
víd‹
 = 
id
 & 0xffff;

88 
devi˚
 = (
id
>>16) & 0xffff;

89 i‡(
pci_¥obes
[
i
].
víd‹
 == vendor &&

90 
pci_¥obes
[
i
].
devi˚
 == device) {

91 
found
 = 1;

96 i‡(!
found
)

97 
Áû
;

100 
addªss
 = 
MSR_K8_SYSCFG
;

101 
	`rdm§l
(
addªss
, 
vÆ
);

104 i‡(!(
vÆ
 & (1<<21))) {

105 
tom2
 = 0;

108 
addªss
 = 
MSR_K8_TOP_MEM2
;

109 
	`rdm§l
(
addªss
, 
vÆ
);

110 
tom2
 = 
vÆ
 & (0xffffULL<<32);

113 i‡(
ba£
 <
tom2
)

114 
ba£
 = 
tom2
 + (1ULL<<32);

120 
hi_mmio_num
 = 0;

121 
i
 = 0; i < 8; i++) {

122 
u32
 
ªg
;

123 
u64
 
°¨t
;

124 
u64
 
íd
;

125 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x80 + (
i
 << 3));

126 i‡(!(
ªg
 & 3))

129 
°¨t
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

130 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x84 + (
i
 << 3));

131 
íd
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

133 i‡(!
íd
)

136 
ønge
[
hi_mmio_num
].
°¨t
 = start;

137 
ønge
[
hi_mmio_num
].
íd
 =Énd;

138 
hi_mmio_num
++;

141 i‡(!
hi_mmio_num
)

142 
out
;

145 
	`s‹t
(
ønge
, 
hi_mmio_num
, (ønge), 
cmp_ønge
, 
NULL
);

147 i‡(
ønge
[
hi_mmio_num
 - 1].
íd
 < 
ba£
)

148 
out
;

149 i‡(
ønge
[0].
°¨t
 > 
ba£
)

150 
out
;

153 
ba£
 = 
ønge
[0].
°¨t
 - (1ULL << 32);

154 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

155 
out
;

156 
ba£
 = 
ønge
[
hi_mmio_num
 - 1].
íd
 + (1ULL << 32);

157 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

158 
out
;

160 i‡(
hi_mmio_num
 > 1)

161 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

162 i‡(
ønge
[
i
 + 1].
°¨t
 > (ønge[i].
íd
 + (1ULL << 32))) {

163 
ba£
 = 
ønge
[
i
].
íd
 + (1ULL << 32);

164 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

165 
out
;

169 
Áû
:

170 
Ám10h_pci_mmc⁄f_ba£_°©us
 = -1;

172 
out
:

173 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

174 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

175 
	}
}

177 
__˝uöô
 
	$Ám10h_check_íabÀ_mmcfg
()

179 
u64
 
vÆ
;

180 
u32
 
addªss
;

182 i‡(!(
pci_¥obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

185 
addªss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

186 
	`rdm§l
(
addªss
, 
vÆ
);

189 i‡(
vÆ
 & 
FAM10H_MMIO_CONF_ENABLE
) {

190 
bu¢bôs
;

191 
bu¢bôs
 = (
vÆ
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

192 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

195 i‡(!
a˝i_pci_dißbÀd
 || 
bu¢bôs
 >= 8) {

196 
u64
 
ba£
;

197 
ba£
 = 
vÆ
 & (0xffffULL << 32);

198 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0) {

199 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

200 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

202 } i‡(
Ám10h_pci_mmc⁄f_ba£
 =
ba£
)

211 
	`gë_Ám10h_pci_mmc⁄f_ba£
();

212 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0)

215 
	`¥ötk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

216 
vÆ
 &~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

217 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

218 
vÆ
 |
Ám10h_pci_mmc⁄f_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

219 
FAM10H_MMIO_CONF_ENABLE
;

220 
	`wrm§l
(
addªss
, 
vÆ
);

221 
	}
}

223 
__devöô
 
	$£t_check_íabÀ_amd_mmc⁄f
(c⁄° 
dmi_sy°em_id
 *
d
)

225 
pci_¥obe
 |
PCI_CHECK_ENABLE_AMD_MMCONF
;

227 
	}
}

229 c⁄° 
dmi_sy°em_id
 
__˝uöôc⁄°
 
	gmmc⁄f_dmi_èbÀ
[] = {

231 .
ˇŒback
 = 
£t_check_íabÀ_amd_mmc⁄f
,

232 .
	gidít
 = "Sun Microsystems Machine",

233 .
	gm©ches
 = {

234 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

240 
__˝uöô
 
	$check_íabÀ_amd_mmc⁄f_dmi
()

242 
	`dmi_check_sy°em
(
mmc⁄f_dmi_èbÀ
);

243 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/bug.h
>

25 
	~<löux/mm.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/pgèbÀ.h
>

32 
	#DEBUGP
 
¥ötk


	)

34 
	#DEBUGP
(
fmt
...)

	)

37 *
	$moduÀ_Æloc
(
size
)

39 
vm_°ru˘
 *
¨ó
;

41 i‡(!
size
)

42  
NULL
;

43 
size
 = 
	`PAGE_ALIGN
(size);

44 i‡(
size
 > 
MODULES_LEN
)

45  
NULL
;

47 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

48 i‡(!
¨ó
)

49  
NULL
;

51  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
,

52 
PAGE_KERNEL_EXEC
);

53 
	}
}

56 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

58 
	`v‰ì
(
moduÀ_ªgi⁄
);

59 
	}
}

62 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

63 
Elf_Shdr
 *
£chdrs
,

64 *
£c°rögs
,

65 
moduÀ
 *
mod
)

68 
	}
}

70 #ifde‡
CONFIG_X86_32


71 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
,

72 c⁄° *
°πab
,

73 
symödex
,

74 
ªl£c
,

75 
moduÀ
 *
me
)

77 
i
;

78 
Elf32_Rñ
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

79 
Elf32_Sym
 *
sym
;

80 
uöt32_t
 *
loˇti⁄
;

82 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

83 
£chdrs
[
ªl£c
].
sh_öfo
);

84 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

86 
loˇti⁄
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


87 + 
ªl
[
i
].
r_off£t
;

90 
sym
 = (
Elf32_Sym
 *)
£chdrs
[
symödex
].
sh_addr


91 + 
	`ELF32_R_SYM
(
ªl
[
i
].
r_öfo
);

93 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

94 
R_386_32
:

96 *
loˇti⁄
 +
sym
->
°_vÆue
;

98 
R_386_PC32
:

100 *
loˇti⁄
 +
sym
->
°_vÆue
 - (
uöt32_t
)location;

103 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %u\n",

104 
me
->
«me
, 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
));

105  -
ENOEXEC
;

109 
	}
}

111 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
,

112 c⁄° *
°πab
,

113 
symödex
,

114 
ªl£c
,

115 
moduÀ
 *
me
)

117 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

118 
me
->
«me
);

119  -
ENOEXEC
;

120 
	}
}

122 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
,

123 c⁄° *
°πab
,

124 
symödex
,

125 
ªl£c
,

126 
moduÀ
 *
me
)

128 
i
;

129 
Elf64_Rña
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

130 
Elf64_Sym
 *
sym
;

131 *
loc
;

132 
u64
 
vÆ
;

134 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

135 
£chdrs
[
ªl£c
].
sh_öfo
);

136 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

138 
loc
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


139 + 
ªl
[
i
].
r_off£t
;

143 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr


144 + 
	`ELF64_R_SYM
(
ªl
[
i
].
r_öfo
);

146 
	`DEBUGP
("type %d st_value %LxÑ_addend %LxÜoc %Lx\n",

147 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
),

148 
sym
->
°_vÆue
, 
ªl
[
i
].
r_addíd
, (
u64
)
loc
);

150 
vÆ
 = 
sym
->
°_vÆue
 + 
ªl
[
i
].
r_addíd
;

152 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

153 
R_X86_64_NONE
:

155 
R_X86_64_64
:

156 *(
u64
 *)
loc
 = 
vÆ
;

158 
R_X86_64_32
:

159 *(
u32
 *)
loc
 = 
vÆ
;

160 i‡(
vÆ
 !*(
u32
 *)
loc
)

161 
ovîÊow
;

163 
R_X86_64_32S
:

164 *(
s32
 *)
loc
 = 
vÆ
;

165 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

166 
ovîÊow
;

168 
R_X86_64_PC32
:

169 
vÆ
 -(
u64
)
loc
;

170 *(
u32
 *)
loc
 = 
vÆ
;

172 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

173 
ovîÊow
;

177 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelaÑelocation: %llu\n",

178 
me
->
«me
, 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
));

179  -
ENOEXEC
;

184 
ovîÊow
:

185 
	`¥ötk
(
KERN_ERR
 "overflow inÑelocationÅype %d val %Lx\n",

186 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
), 
vÆ
);

187 
	`¥ötk
(
KERN_ERR
 "`%s'ÜikelyÇot compiled with -mcmodel=kernel\n",

188 
me
->
«me
);

189  -
ENOEXEC
;

190 
	}
}

192 
	$≠∂y_ªloˇã
(
Elf_Shdr
 *
£chdrs
,

193 c⁄° *
°πab
,

194 
symödex
,

195 
ªl£c
,

196 
moduÀ
 *
me
)

198 
	`¥ötk
(
KERN_ERR
 "nonáddÑelocationÇot supported\n");

199  -
ENOSYS
;

200 
	}
}

204 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
,

205 c⁄° 
Elf_Shdr
 *
£chdrs
,

206 
moduÀ
 *
me
)

208 c⁄° 
Elf_Shdr
 *
s
, *
ãxt
 = 
NULL
, *
Æt
 = NULL, *
locks
 = NULL,

209 *
∑ø
 = 
NULL
;

210 *
£c°rögs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh°∫dx
].
sh_off£t
;

212 
s
 = 
£chdrs
; s < sechdr†+ 
hdr
->
e_shnum
; s++) {

213 i‡(!
	`°rcmp
(".ãxt", 
£c°rögs
 + 
s
->
sh_«me
))

214 
ãxt
 = 
s
;

215 i‡(!
	`°rcmp
(".Ætö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

216 
Æt
 = 
s
;

217 i‡(!
	`°rcmp
(".smp_locks", 
£c°rögs
 + 
s
->
sh_«me
))

218 
locks
 = 
s
;

219 i‡(!
	`°rcmp
(".∑øö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

220 
∑ø
 = 
s
;

223 i‡(
Æt
) {

225 *
a£g
 = (*)
Æt
->
sh_addr
;

226 
	`≠∂y_Æã∫©ives
(
a£g
,á£g + 
Æt
->
sh_size
);

228 i‡(
locks
 && 
ãxt
) {

229 *
l£g
 = (*)
locks
->
sh_addr
;

230 *
t£g
 = (*)
ãxt
->
sh_addr
;

231 
	`Æã∫©ives_smp_moduÀ_add
(
me
, me->
«me
,

232 
l£g
,Ü£g + 
locks
->
sh_size
,

233 
t£g
,Å£g + 
ãxt
->
sh_size
);

236 i‡(
∑ø
) {

237 *
p£g
 = (*)
∑ø
->
sh_addr
;

238 
	`≠∂y_∑øvút
(
p£g
,Ö£g + 
∑ø
->
sh_size
);

241  
	`moduÀ_bug_föÆize
(
hdr
, 
£chdrs
, 
me
);

242 
	}
}

244 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

246 
	`Æã∫©ives_smp_moduÀ_dñ
(
mod
);

247 
	`moduÀ_bug_˛ónup
(
mod
);

248 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<löux/mm.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dñay.h
>

13 
	~<löux/boŸmem.h
>

14 
	~<löux/kî√l_°©.h
>

15 
	~<löux/mc146818πc.h
>

16 
	~<löux/bô›s.h
>

17 
	~<löux/a˝i.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/pci.h
>

22 
	~<asm/mår.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/pgÆloc.h
>

25 
	~<asm/io_≠ic.h
>

26 
	~<asm/¥Ÿo.h
>

27 
	~<asm/bios_ebda.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/åampﬁöe.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/smp.h
>

33 
	~<asm/≠ic.h
>

38 
__öô
 
	$mpf_checksum
(*
mp
, 
Àn
)

40 
sum
 = 0;

42 
Àn
--)

43 
sum
 +*
mp
++;

45  
sum
 & 0xFF;

46 
	}
}

48 
__öô
 
	$deÁu…_mpc_≠ic_id
(
mpc_˝u
 *
m
)

50  
m
->
≠icid
;

51 
	}
}

53 
__öô
 
	$MP_¥o˚ss‹_öfo
(
mpc_˝u
 *
m
)

55 
≠icid
;

56 *
boŸup_˝u
 = "";

58 i‡(!(
m
->
˝uÊag
 & 
CPU_ENABLED
)) {

59 
dißbÀd_˝us
++;

63 
≠icid
 = 
x86_öô
.
mµ¨£
.
	`mpc_≠ic_id
(
m
);

65 i‡(
m
->
˝uÊag
 & 
CPU_BOOTPROCESSOR
) {

66 
boŸup_˝u
 = " (Bootup-CPU)";

67 
boŸ_˝u_physiˇl_≠icid
 = 
m
->
≠icid
;

70 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹ #%d%s\n", 
m
->
≠icid
, 
boŸup_˝u
);

71 
	`gíîic_¥o˚ss‹_öfo
(
≠icid
, 
m
->
≠icvî
);

72 
	}
}

74 #ifde‡
CONFIG_X86_IO_APIC


75 
__öô
 
	$deÁu…_mpc_€m_bus_öfo
(
mpc_bus
 *
m
, *
°r
)

77 
	`mem˝y
(
°r
, 
m
->
bu°y≥
, 6);

78 
°r
[6] = 0;

79 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Bu†#%d i†%s\n", 
m
->
busid
, 
°r
);

80 
	}
}

82 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
)

84 
°r
[7];

86 
x86_öô
.
mµ¨£
.
	`mpc_€m_bus_öfo
(
m
, 
°r
);

88 #i‡
MAX_MP_BUSSES
 < 256

89 i‡(
m
->
busid
 >
MAX_MP_BUSSES
) {

90 
	`¥ötk
(
KERN_WARNING
 "MPÅable busid value (%d) for bustype %s "

92 
m
->
busid
, 
°r
, 
MAX_MP_BUSSES
 - 1);

97 i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

98 
	`£t_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

99 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

100 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_ISA
;

102 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

103 i‡(
x86_öô
.
mµ¨£
.
mpc_€m_pci_bus
)

104 
x86_öô
.
mµ¨£
.
	`mpc_€m_pci_bus
(
m
);

106 
	`˛ór_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

107 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

108 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_PCI
;

109 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

110 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_EISA
;

111 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

112 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_MCA
;

115 
	`¥ötk
(
KERN_WARNING
 "Unknow¿bu°y≥ %†- ign‹ög\n", 
°r
);

116 
	}
}

118 
	$bad_iﬂpic
(
addªss
)

120 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

121 
	`¥ötk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)Éxceeded "

122 "(found %d)\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

123 
	`∑nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

125 i‡(!
addªss
) {

126 
	`¥ötk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APICáddress"

131 
	}
}

133 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
)

135 i‡(!(
m
->
Êags
 & 
MPC_APIC_USABLE
))

138 
	`¥ötk
(
KERN_INFO
 "I/O APIC #%d Version %dát 0x%X.\n",

139 
m
->
≠icid
, m->
≠icvî
, m->
≠iˇddr
);

141 i‡(
	`bad_iﬂpic
(
m
->
≠iˇddr
))

144 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠iˇddr
 = 
m
->apicaddr;

145 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icid
 = 
m
->apicid;

146 
mp_iﬂpics
[
ƒ_iﬂpics
].
ty≥
 = 
m
->type;

147 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icvî
 = 
m
->apicver;

148 
mp_iﬂpics
[
ƒ_iﬂpics
].
Êags
 = 
m
->flags;

149 
ƒ_iﬂpics
++;

150 
	}
}

152 
	$¥öt_MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

154 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

156 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbus
,

157 
m
->
§cbusúq
, m->
d°≠ic
, m->
d°úq
);

158 
	}
}

160 
__öô
 
	$¥öt_mp_úq_öfo
(
mpc_öt§c
 *
mp_úq
)

162 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

164 
mp_úq
->
úqty≥
, mp_úq->
úqÊag
 & 3,

165 (
mp_úq
->
úqÊag
 >> 2Ë& 3, mp_úq->
§cbus
,

166 
mp_úq
->
§cbusúq
, mp_úq->
d°≠ic
, mp_úq->
d°úq
);

167 
	}
}

169 
__öô
 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

170 
mpc_öt§c
 *
mp_úq
)

172 
mp_úq
->
d°≠ic
 = 
m
->dstapic;

173 
mp_úq
->
ty≥
 = 
m
->type;

174 
mp_úq
->
úqty≥
 = 
m
->irqtype;

175 
mp_úq
->
úqÊag
 = 
m
->irqflag;

176 
mp_úq
->
§cbus
 = 
m
->srcbus;

177 
mp_úq
->
§cbusúq
 = 
m
->srcbusirq;

178 
mp_úq
->
d°úq
 = 
m
->dstirq;

179 
	}
}

181 
__öô
 
	$assign_to_mpc_öt§c
(
mpc_öt§c
 *
mp_úq
,

182 
mpc_öt§c
 *
m
)

184 
m
->
d°≠ic
 = 
mp_úq
->dstapic;

185 
m
->
ty≥
 = 
mp_úq
->type;

186 
m
->
úqty≥
 = 
mp_úq
->irqtype;

187 
m
->
úqÊag
 = 
mp_úq
->irqflag;

188 
m
->
§cbus
 = 
mp_úq
->srcbus;

189 
m
->
§cbusúq
 = 
mp_úq
->srcbusirq;

190 
m
->
d°úq
 = 
mp_úq
->dstirq;

191 
	}
}

193 
__öô
 
	$mp_úq_mpc_öt§c_cmp
(
mpc_öt§c
 *
mp_úq
,

194 
mpc_öt§c
 *
m
)

196 i‡(
mp_úq
->
d°≠ic
 !
m
->dstapic)

198 i‡(
mp_úq
->
ty≥
 !
m
->type)

200 i‡(
mp_úq
->
úqty≥
 !
m
->irqtype)

202 i‡(
mp_úq
->
úqÊag
 !
m
->irqflag)

204 i‡(
mp_úq
->
§cbus
 !
m
->srcbus)

206 i‡(
mp_úq
->
§cbusúq
 !
m
->srcbusirq)

208 i‡(
mp_úq
->
d°úq
 !
m
->dstirq)

212 
	}
}

214 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

216 
i
;

218 
	`¥öt_MP_öt§c_öfo
(
m
);

220 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

221 i‡(!
	`mp_úq_mpc_öt§c_cmp
(&
mp_úqs
[
i
], 
m
))

225 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

226 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

227 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

228 
	}
}

230 
ölöe
 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
Ë{
	}
}

231 
ölöe
 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
Ë{
	}
}

232 
ölöe
 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
Ë{
	}
}

236 
__öô
 
	$MP_löt§c_öfo
(
mpc_löt§c
 *
m
)

238 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Lint:Åype %d,Öol %d,Årig %d, bus %02x,"

240 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbusid
,

241 
m
->
§cbusúq
, m->
de°≠ic
, m->
de°≠i˛öt
);

242 
	}
}

248 
__öô
 
	$smp_check_mpc
(
mpc_èbÀ
 *
mpc
, *
€m
, *
°r
)

251 i‡(
	`memcmp
(
mpc
->
sig«tuª
, 
MPC_SIGNATURE
, 4)) {

252 
	`¥ötk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

253 
mpc
->
sig«tuª
[0], mpc->signature[1],

254 
mpc
->
sig«tuª
[2], mpc->signature[3]);

257 i‡(
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
)) {

258 
	`¥ötk
(
KERN_ERR
 "MPTABLE: checksumÉrror!\n");

261 i‡(
mpc
->
•ec
 != 0x01 && mpc->spec != 0x04) {

262 
	`¥ötk
(
KERN_ERR
 "MPTABLE: badÅable version (%d)!!\n",

263 
mpc
->
•ec
);

266 i‡(!
mpc
->
œpic
) {

267 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇullÜocal APICáddress!\n");

270 
	`mem˝y
(
€m
, 
mpc
->oem, 8);

271 
€m
[8] = 0;

272 
	`¥ötk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
€m
);

274 
	`mem˝y
(
°r
, 
mpc
->
¥odu˘id
, 12);

275 
°r
[12] = 0;

277 
	`¥ötk
(
KERN_INFO
 "MPTABLE: Produ˘ ID: %s\n", 
°r
);

279 
	`¥ötk
(
KERN_INFO
 "MPTABLE: APICát: 0x%X\n", 
mpc
->
œpic
);

282 
	}
}

284 
	$skù_íåy
(**
±r
, *
cou¡
, 
size
)

286 *
±r
 +
size
;

287 *
cou¡
 +
size
;

288 
	}
}

290 
__öô
 
	$smp_dump_m±abÀ
(
mpc_èbÀ
 *
mpc
, *
m±
)

292 
	`¥ötk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

293 "ty≥ %x\n", *
m±
);

294 
	`¥öt_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

295 1, 
mpc
, mpc->
Àngth
, 1);

296 
	}
}

298 
__öô
 
	$deÁu…_smp_ªad_mpc_€m
(
mpc_èbÀ
 *
mpc
Ë{ 
	}
}

300 
__öô
 
	$smp_ªad_mpc
(
mpc_èbÀ
 *
mpc
, 
óæy
)

302 
°r
[16];

303 
€m
[10];

305 
cou¡
 = (*
mpc
);

306 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

308 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

311 #ifde‡
CONFIG_X86_32


312 
	`gíîic_mps_€m_check
(
mpc
, 
€m
, 
°r
);

315 i‡(!
a˝i_œpic
)

316 
mp_œpic_addr
 = 
mpc
->
œpic
;

318 i‡(
óæy
)

321 i‡(
mpc
->
€m±r
)

322 
x86_öô
.
mµ¨£
.
	`smp_ªad_mpc_€m
(
mpc
);

327 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(0);

329 
cou¡
 < 
mpc
->
Àngth
) {

330 *
m±
) {

331 
MP_PROCESSOR
:

333 i‡(!
a˝i_œpic
)

334 
	`MP_¥o˚ss‹_öfo
((
mpc_˝u
 *)
m±
);

335 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

337 
MP_BUS
:

338 
	`MP_bus_öfo
((
mpc_bus
 *)
m±
);

339 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

341 
MP_IOAPIC
:

342 
	`MP_iﬂpic_öfo
((
mpc_iﬂpic
 *)
m±
);

343 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

345 
MP_INTSRC
:

346 
	`MP_öt§c_öfo
((
mpc_öt§c
 *)
m±
);

347 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

349 
MP_LINTSRC
:

350 
	`MP_löt§c_öfo
((
mpc_löt§c
 *)
m±
);

351 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

355 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

356 
cou¡
 = 
mpc
->
Àngth
;

359 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(1);

362 i‡(!
num_¥o˚ss‹s
)

363 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇoÖrocessorsÑegistered!\n");

364  
num_¥o˚ss‹s
;

365 
	}
}

367 #ifde‡
CONFIG_X86_IO_APIC


369 
__öô
 
	$ELCR_åiggî
(
úq
)

371 
p‹t
;

373 
p‹t
 = 0x4d0 + (
úq
 >> 3);

374  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

375 
	}
}

377 
__öô
 
	$c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
)

379 
mpc_öt§c
 
öt§c
;

380 
i
;

381 
ELCR_ÁŒback
 = 0;

383 
öt§c
.
ty≥
 = 
MP_INTSRC
;

384 
öt§c
.
úqÊag
 = 0;

385 
öt§c
.
§cbus
 = 0;

386 
öt§c
.
d°≠ic
 = 
mp_iﬂpics
[0].
≠icid
;

388 
öt§c
.
úqty≥
 = 
mp_INT
;

398 i‡(
mpc_deÁu…_ty≥
 == 5) {

399 
	`¥ötk
(
KERN_INFO
 "ISA/PCI busÅype withÇo IRQ information... "

402 i‡(
	`ELCR_åiggî
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

403 
	`ELCR_åiggî
(13))

404 
	`¥ötk
(
KERN_ERR
 "ELCR contains invalid data... "

407 
	`¥ötk
(
KERN_INFO


409 
ELCR_ÁŒback
 = 1;

413 
i
 = 0; i < 16; i++) {

414 
mpc_deÁu…_ty≥
) {

416 i‡(
i
 == 0 || i == 13)

420 i‡(
i
 == 2)

424 i‡(
ELCR_ÁŒback
) {

430 i‡(
	`ELCR_åiggî
(
i
))

431 
öt§c
.
úqÊag
 = 13;

433 
öt§c
.
úqÊag
 = 0;

436 
öt§c
.
§cbusúq
 = 
i
;

437 
öt§c
.
d°úq
 = 
i
 ? i : 2;

438 
	`MP_öt§c_öfo
(&
öt§c
);

441 
öt§c
.
úqty≥
 = 
mp_ExtINT
;

442 
öt§c
.
§cbusúq
 = 0;

443 
öt§c
.
d°úq
 = 0;

444 
	`MP_öt§c_öfo
(&
öt§c
);

445 
	}
}

448 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
)

450 
mpc_iﬂpic
 
iﬂpic
;

451 
mpc_bus
 
bus
;

453 
bus
.
ty≥
 = 
MP_BUS
;

454 
bus
.
busid
 = 0;

455 
mpc_deÁu…_ty≥
) {

457 
	`¥ötk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

458 
mpc_deÁu…_ty≥
);

462 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

467 
	`mem˝y
(
bus
.
bu°y≥
, "EISA ", 6);

471 
	`mem˝y
(
bus
.
bu°y≥
, "MCA ", 6);

473 
	`MP_bus_öfo
(&
bus
);

474 i‡(
mpc_deÁu…_ty≥
 > 4) {

475 
bus
.
busid
 = 1;

476 
	`mem˝y
(
bus
.
bu°y≥
, "PCI ", 6);

477 
	`MP_bus_öfo
(&
bus
);

480 
iﬂpic
.
ty≥
 = 
MP_IOAPIC
;

481 
iﬂpic
.
≠icid
 = 2;

482 
iﬂpic
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

483 
iﬂpic
.
Êags
 = 
MPC_APIC_USABLE
;

484 
iﬂpic
.
≠iˇddr
 = 
IO_APIC_DEFAULT_PHYS_BASE
;

485 
	`MP_iﬂpic_öfo
(&
iﬂpic
);

490 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
);

491 
	}
}

493 
ölöe
 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
Ë{ 
	}
}

496 
ölöe
 
__öô
 
	$c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpc_deÁu…_ty≥
)

498 
mpc_˝u
 
¥o˚ss‹
;

499 
mpc_löt§c
 
löt§c
;

500 
löây≥s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

501 
i
;

506 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

511 
¥o˚ss‹
.
ty≥
 = 
MP_PROCESSOR
;

513 
¥o˚ss‹
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

514 
¥o˚ss‹
.
˝uÊag
 = 
CPU_ENABLED
;

515 
¥o˚ss‹
.
˝u„©uª
 = (
boŸ_˝u_d©a
.
x86
 << 8) |

516 (
boŸ_˝u_d©a
.
x86_modñ
 << 4Ë| boŸ_˝u_d©a.
x86_mask
;

517 
¥o˚ss‹
.
„©uªÊag
 = 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[0];

518 
¥o˚ss‹
.
ª£rved
[0] = 0;

519 
¥o˚ss‹
.
ª£rved
[1] = 0;

520 
i
 = 0; i < 2; i++) {

521 
¥o˚ss‹
.
≠icid
 = 
i
;

522 
	`MP_¥o˚ss‹_öfo
(&
¥o˚ss‹
);

525 
	`c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
);

527 
löt§c
.
ty≥
 = 
MP_LINTSRC
;

528 
löt§c
.
úqÊag
 = 0;

529 
löt§c
.
§cbusid
 = 0;

530 
löt§c
.
§cbusúq
 = 0;

531 
löt§c
.
de°≠ic
 = 
MP_APIC_ALL
;

532 
i
 = 0; i < 2; i++) {

533 
löt§c
.
úqty≥
 = 
löây≥s
[
i
];

534 
löt§c
.
de°≠i˛öt
 = 
i
;

535 
	`MP_löt§c_öfo
(&
löt§c
);

537 
	}
}

539 
mpf_öãl
 *
	gmpf_found
;

541 
__öô
 
	$gë_mpc_size
(
phy•å
)

543 
mpc_èbÀ
 *
mpc
;

544 
size
;

546 
mpc
 = 
	`óæy_i‹em≠
(
phy•å
, 
PAGE_SIZE
);

547 
size
 = 
mpc
->
Àngth
;

548 
	`óæy_iounm≠
(
mpc
, 
PAGE_SIZE
);

549 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy•å
,Öhy•å + 
size
);

551  
size
;

552 
	}
}

554 
__öô
 
	$check_phy•å
(
mpf_öãl
 *
mpf
, 
óæy
)

556 
mpc_èbÀ
 *
mpc
;

557 
size
;

559 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

560 
mpc
 = 
	`óæy_i‹em≠
(
mpf
->
phy•å
, 
size
);

565 i‡(!
	`smp_ªad_mpc
(
mpc
, 
óæy
)) {

566 #ifde‡
CONFIG_X86_LOCAL_APIC


567 
smp_found_c⁄fig
 = 0;

569 
	`¥ötk
(
KERN_ERR
 "BIOS bug, MPÅableÉrrors detected!...\n"

571 
	`óæy_iounm≠
(
mpc
, 
size
);

574 
	`óæy_iounm≠
(
mpc
, 
size
);

576 i‡(
óæy
)

579 #ifde‡
CONFIG_X86_IO_APIC


585 i‡(!
mp_úq_íåõs
) {

586 
mpc_bus
 
bus
;

588 
	`¥ötk
(
KERN_ERR
 "BIOS bug,ÇoÉxplicit IRQÉntries, "

591 
bus
.
ty≥
 = 
MP_BUS
;

592 
bus
.
busid
 = 0;

593 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

594 
	`MP_bus_öfo
(&
bus
);

596 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(0);

601 
	}
}

606 
__öô
 
	$deÁu…_gë_smp_c⁄fig
(
óæy
)

608 
mpf_öãl
 *
mpf
 = 
mpf_found
;

610 i‡(!
mpf
)

613 i‡(
a˝i_œpic
 && 
óæy
)

620 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

623 
	`¥ötk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

624 
mpf
->
•ecifiˇti⁄
);

625 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_X86_32
)

626 i‡(
mpf
->
„©uª2
 & (1 << 7)) {

627 
	`¥ötk
(
KERN_INFO
 " IMCRánd PIC compatibility mode.\n");

628 
pic_mode
 = 1;

630 
	`¥ötk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

631 
pic_mode
 = 0;

637 i‡(
mpf
->
„©uª1
 != 0) {

638 i‡(
óæy
) {

642 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

646 
	`¥ötk
(
KERN_INFO
 "Default MP configuration #%d\n",

647 
mpf
->
„©uª1
);

648 
	`c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpf
->
„©uª1
);

650 } i‡(
mpf
->
phy•å
) {

651 i‡(
	`check_phy•å
(
mpf
, 
óæy
))

654 
	`BUG
();

656 i‡(!
óæy
)

657 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹s: %d\n", 
num_¥o˚ss‹s
);

661 
	}
}

663 
__öô
 
	$smp_ª£rve_mem‹y
(
mpf_öãl
 *
mpf
)

665 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

667 
	`ª£rve_óæy
(
mpf
->
phy•å
, mpf->phy•å+
size
, "MP-table mpc");

668 
	}
}

670 
__öô
 
	$smp_sˇn_c⁄fig
(
ba£
, 
Àngth
)

672 *
bp
 = 
	`phys_to_vút
(
ba£
);

673 
mpf_öãl
 *
mpf
;

674 
mem
;

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

677 
bp
, 
Àngth
);

678 
	`BUILD_BUG_ON
((*
mpf
) != 16);

680 
Àngth
 > 0) {

681 
mpf
 = (
mpf_öãl
 *)
bp
;

682 i‡((*
bp
 =
SMP_MAGIC_IDENT
) &&

683 (
mpf
->
Àngth
 == 1) &&

684 !
	`mpf_checksum
((*)
bp
, 16) &&

685 ((
mpf
->
•ecifiˇti⁄
 == 1)

686 || (
mpf
->
•ecifiˇti⁄
 == 4))) {

687 #ifde‡
CONFIG_X86_LOCAL_APIC


688 
smp_found_c⁄fig
 = 1;

690 
mpf_found
 = 
mpf
;

692 
	`¥ötk
(
KERN_INFO
 "found SMP MP-tableát [%p] %llx\n",

693 
mpf
, (
u64
)
	`vút_to_phys
(mpf));

695 
mem
 = 
	`vút_to_phys
(
mpf
);

696 
	`ª£rve_óæy
(
mem
, mem + (*
mpf
), "MP-table mpf");

697 i‡(
mpf
->
phy•å
)

698 
	`smp_ª£rve_mem‹y
(
mpf
);

702 
bp
 += 4;

703 
Àngth
 -= 16;

706 
	}
}

708 
__öô
 
	$deÁu…_föd_smp_c⁄fig
()

710 
addªss
;

720 i‡(
	`smp_sˇn_c⁄fig
(0x0, 0x400) ||

721 
	`smp_sˇn_c⁄fig
(639 * 0x400, 0x400) ||

722 
	`smp_sˇn_c⁄fig
(0xF0000, 0x10000))

741 
addªss
 = 
	`gë_bios_ebda
();

742 i‡(
addªss
)

743 
	`smp_sˇn_c⁄fig
(
addªss
, 0x400);

744 
	}
}

746 #ifde‡
CONFIG_X86_IO_APIC


747 
u8
 
__öôd©a
 
	gúq_u£d
[
MAX_IRQ_SOURCES
];

749 
__öô
 
	$gë_MP_öt§c_ödex
(
mpc_öt§c
 *
m
)

751 
i
;

753 i‡(
m
->
úqty≥
 !
mp_INT
)

756 i‡(
m
->
úqÊag
 != 0x0f)

761 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

762 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

765 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

768 i‡(
mp_úqs
[
i
].
§cbus
 !
m
->srcbus)

770 i‡(
mp_úqs
[
i
].
§cbusúq
 !
m
->srcbusirq)

772 i‡(
úq_u£d
[
i
]) {

776 
úq_u£d
[
i
] = 1;

777  
i
;

782 
	}
}

784 
	#SPARE_SLOT_NUM
 20

	)

786 
mpc_öt§c
 
__öôd©a
 *
	gm_•¨e
[
SPARE_SLOT_NUM
];

788 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
)

790 
i
;

792 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "OLD ");

793 
	`¥öt_MP_öt§c_öfo
(
m
);

795 
i
 = 
	`gë_MP_öt§c_ödex
(
m
);

796 i‡(
i
 > 0) {

797 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

798 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "NEW ");

799 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

802 i‡(!
i
) {

806 i‡(*
ƒ_m_•¨e
 < 
SPARE_SLOT_NUM
) {

811 
m_•¨e
[*
ƒ_m_•¨e
] = 
m
;

812 *
ƒ_m_•¨e
 += 1;

814 
	}
}

817 
ölöe
 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
Ë{
	}
}

821 
	$check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
)

823 
ªt
 = 0;

825 i‡(!
mpc_√w_phys
 || 
cou¡
 <
mpc_√w_Àngth
) {

826 
	`WARN
(1, "upd©e_m±abÀ: Nÿ•¨ê¶Ÿ†÷ígth: %x)\n", 
cou¡
);

830  
ªt
;

831 
	}
}

833 
__öô
 
	$ª∂a˚_öt§c_Æl
(
mpc_èbÀ
 *
mpc
,

834 
mpc_√w_phys
,

835 
mpc_√w_Àngth
)

837 #ifde‡
CONFIG_X86_IO_APIC


838 
i
;

840 
cou¡
 = (*
mpc
);

841 
ƒ_m_•¨e
 = 0;

842 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

844 
	`¥ötk
(
KERN_INFO
 "mpc_Àngth %x\n", 
mpc
->
Àngth
);

845 
cou¡
 < 
mpc
->
Àngth
) {

846 *
m±
) {

847 
MP_PROCESSOR
:

848 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

850 
MP_BUS
:

851 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

853 
MP_IOAPIC
:

854 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

856 
MP_INTSRC
:

857 
	`check_úq_§c
((
mpc_öt§c
 *)
m±
, &
ƒ_m_•¨e
);

858 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

860 
MP_LINTSRC
:

861 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

865 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

866 
out
;

870 #ifde‡
CONFIG_X86_IO_APIC


871 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

872 i‡(
úq_u£d
[
i
])

875 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

878 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

881 i‡(
ƒ_m_•¨e
 > 0) {

882 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "*NEW* found\n");

883 
ƒ_m_•¨e
--;

884 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m_•¨e
[
ƒ_m_•¨e
]);

885 
m_•¨e
[
ƒ_m_•¨e
] = 
NULL
;

887 
mpc_öt§c
 *
m
 = (mpc_öt§¯*)
m±
;

888 
cou¡
 +(
mpc_öt§c
);

889 i‡(
	`check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
) < 0)

890 
out
;

891 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

892 
mpc
->
Àngth
 = 
cou¡
;

893 
m±
 +(
mpc_öt§c
);

895 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

898 
out
:

900 
mpc
->
checksum
 = 0;

901 
mpc
->
checksum
 -
	`mpf_checksum
((*)mpc, mpc->
Àngth
);

904 
	}
}

906 
	gíabÀ_upd©e_m±abÀ
;

908 
__öô
 
	$upd©e_m±abÀ_£tup
(*
°r
)

910 
íabÀ_upd©e_m±abÀ
 = 1;

911 #ifde‡
CONFIG_PCI


912 
pci_rouãúq
 = 1;

915 
	}
}

916 
óæy_∑øm
("upd©e_m±abÀ", 
upd©e_m±abÀ_£tup
);

918 
__öôd©a
 
	gmpc_√w_phys
;

919 
mpc_√w_Àngth
 
	g__öôd©a
 = 4096;

922 
__öôd©a
 
	gÆloc_m±abÀ
;

923 
__öô
 
	$∑r£_Æloc_m±abÀ_›t
(*
p
)

925 
íabÀ_upd©e_m±abÀ
 = 1;

926 #ifde‡
CONFIG_PCI


927 
pci_rouãúq
 = 1;

929 
Æloc_m±abÀ
 = 1;

930 i‡(!
p
)

932 
mpc_√w_Àngth
 = 
	`mem∑r£
(
p
, &p);

934 
	}
}

935 
óæy_∑øm
("Æloc_m±abÀ", 
∑r£_Æloc_m±abÀ_›t
);

937 
__öô
 
	$óæy_ª£rve_e820_mpc_√w
()

939 i‡(
íabÀ_upd©e_m±abÀ
 && 
Æloc_m±abÀ
) {

940 
u64
 
°¨â
 = 0;

941 
mpc_√w_phys
 = 
	`óæy_ª£rve_e820
(
°¨â
, 
mpc_√w_Àngth
, 4);

943 
	}
}

945 
__öô
 
	$upd©e_mp_èbÀ
()

947 
°r
[16];

948 
€m
[10];

949 
mpf_öãl
 *
mpf
;

950 
mpc_èbÀ
 *
mpc
, *
mpc_√w
;

952 i‡(!
íabÀ_upd©e_m±abÀ
)

955 
mpf
 = 
mpf_found
;

956 i‡(!
mpf
)

962 i‡(
mpf
->
„©uª1
 != 0)

965 i‡(!
mpf
->
phy•å
)

968 
mpc
 = 
	`phys_to_vút
(
mpf
->
phy•å
);

970 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

973 
	`¥ötk
(
KERN_INFO
 "mpf: %Œx\n", (
u64
)
	`vút_to_phys
(
mpf
));

974 
	`¥ötk
(
KERN_INFO
 "phy•å: %x\n", 
mpf
->
phy•å
);

976 i‡(
mpc_√w_phys
 && 
mpc
->
Àngth
 > 
mpc_√w_Àngth
) {

977 
mpc_√w_phys
 = 0;

978 
	`¥ötk
(
KERN_INFO
 "mpc_new_length is %ld,Ölease useálloc_mptable=8k\n",

979 
mpc_√w_Àngth
);

982 i‡(!
mpc_√w_phys
) {

983 
ﬁd
, 
√w
;

985 
mpc
->
checksum
 = 0;

986 
ﬁd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

987 
mpc
->
checksum
 = 0xff;

988 
√w
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

989 i‡(
ﬁd
 =
√w
) {

990 
	`¥ötk
(
KERN_INFO
 "mpc isÑeadonly,ÖleaseÅryálloc_mptable instead\n");

993 
	`¥ötk
(
KERN_INFO
 "use in-positonÑeplacing\n");

995 
mpf
->
phy•å
 = 
mpc_√w_phys
;

996 
mpc_√w
 = 
	`phys_to_vút
(
mpc_√w_phys
);

997 
	`mem˝y
(
mpc_√w
, 
mpc
, mpc->
Àngth
);

998 
mpc
 = 
mpc_√w
;

1000 i‡(
mpc_√w_phys
 - 
mpf
->
phy•å
) {

1001 
mpf_öãl
 *
mpf_√w
;

1003 
	`¥ötk
(
KERN_INFO
 "mpfÇew: %x\n", 0x400 - 16);

1004 
mpf_√w
 = 
	`phys_to_vút
(0x400 - 16);

1005 
	`mem˝y
(
mpf_√w
, 
mpf
, 16);

1006 
mpf
 = 
mpf_√w
;

1007 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1009 
mpf
->
checksum
 = 0;

1010 
mpf
->
checksum
 -
	`mpf_checksum
((*)mpf, 16);

1011 
	`¥ötk
(
KERN_INFO
 "phy•åÇew: %x\n", 
mpf
->
phy•å
);

1020 
	`ª∂a˚_öt§c_Æl
(
mpc
, 
mpc_√w_phys
, 
mpc_√w_Àngth
);

1023 
	}
}

1025 
œã_öôˇŒ
(
upd©e_mp_èbÀ
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

25 
	~<löux/moduÀ.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/î∫o.h
>

29 
	~<löux/f˙é.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/smp_lock.h
>

34 
	~<löux/maj‹.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/devi˚.h
>

37 
	~<löux/˝u.h
>

38 
	~<löux/nŸifõr.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~<asm/¥o˚ss‹.h
>

42 
	~<asm/m§.h
>

43 
	~<asm/sy°em.h
>

45 
˛ass
 *
	gm§_˛ass
;

47 
loff_t
 
	$m§_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

49 
loff_t
 
ªt
;

50 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

52 
	`muãx_lock
(&
öode
->
i_muãx
);

53 
‹ig
) {

55 
fûe
->
f_pos
 = 
off£t
;

56 
ªt
 = 
fûe
->
f_pos
;

59 
fûe
->
f_pos
 +
off£t
;

60 
ªt
 = 
fûe
->
f_pos
;

63 
ªt
 = -
EINVAL
;

65 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

66  
ªt
;

67 
	}
}

69 
ssize_t
 
	$m§_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

70 
size_t
 
cou¡
, 
loff_t
 *
µos
)

72 
u32
 
__u£r
 *
tmp
 = (u32 __u£∏*Ë
buf
;

73 
u32
 
d©a
[2];

74 
u32
 
ªg
 = *
µos
;

75 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

76 
îr
 = 0;

77 
ssize_t
 
byãs
 = 0;

79 i‡(
cou¡
 % 8)

80  -
EINVAL
;

82 ; 
cou¡
; count -= 8) {

83 
îr
 = 
	`rdm§_ß„_⁄_˝u
(
˝u
, 
ªg
, &
d©a
[0], &data[1]);

84 i‡(
îr
)

86 i‡(
	`c›y_to_u£r
(
tmp
, &
d©a
, 8)) {

87 
îr
 = -
EFAULT
;

90 
tmp
 += 2;

91 
byãs
 += 8;

94  
byãs
 ? byã†: 
îr
;

95 
	}
}

97 
ssize_t
 
	$m§_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

98 
size_t
 
cou¡
, 
loff_t
 *
µos
)

100 c⁄° 
u32
 
__u£r
 *
tmp
 = (c⁄° u32 __u£∏*)
buf
;

101 
u32
 
d©a
[2];

102 
u32
 
ªg
 = *
µos
;

103 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

104 
îr
 = 0;

105 
ssize_t
 
byãs
 = 0;

107 i‡(
cou¡
 % 8)

108  -
EINVAL
;

110 ; 
cou¡
; count -= 8) {

111 i‡(
	`c›y_‰om_u£r
(&
d©a
, 
tmp
, 8)) {

112 
îr
 = -
EFAULT
;

115 
îr
 = 
	`wrm§_ß„_⁄_˝u
(
˝u
, 
ªg
, 
d©a
[0], data[1]);

116 i‡(
îr
)

118 
tmp
 += 2;

119 
byãs
 += 8;

122  
byãs
 ? byã†: 
îr
;

123 
	}
}

125 
	$m§_io˘l
(
fûe
 *fûe, 
ioc
, 
¨g
)

127 
u32
 
__u£r
 *
uªgs
 = (u32 __u£∏*)
¨g
;

128 
u32
 
ªgs
[8];

129 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

130 
îr
;

132 
ioc
) {

133 
X86_IOC_RDMSR_REGS
:

134 i‡(!(
fûe
->
f_mode
 & 
FMODE_READ
)) {

135 
îr
 = -
EBADF
;

138 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

139 
îr
 = -
EFAULT
;

142 
îr
 = 
	`rdm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

143 i‡(
îr
)

145 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

146 
îr
 = -
EFAULT
;

149 
X86_IOC_WRMSR_REGS
:

150 i‡(!(
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

151 
îr
 = -
EBADF
;

154 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

155 
îr
 = -
EFAULT
;

158 
îr
 = 
	`wrm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

159 i‡(
îr
)

161 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

162 
îr
 = -
EFAULT
;

166 
îr
 = -
ENOTTY
;

170  
îr
;

171 
	}
}

173 
	$m§_›í
(
öode
 *öode, 
fûe
 *file)

175 
˝u
;

176 
˝uöfo_x86
 *
c
;

178 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

179 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

180  -
ENXIO
;

182 
c
 = &
	`˝u_d©a
(
˝u
);

183 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MSR
))

184  -
EIO
;

187 
	}
}

192 c⁄° 
fûe_›î©i⁄s
 
	gm§_f›s
 = {

193 .
ow√r
 = 
THIS_MODULE
,

194 .
	gŒ£ek
 = 
m§_£ek
,

195 .
	gªad
 = 
m§_ªad
,

196 .
	gwrôe
 = 
m§_wrôe
,

197 .
	g›í
 = 
m§_›í
,

198 .
	gu∆ocked_io˘l
 = 
m§_io˘l
,

199 .
	gcom∑t_io˘l
 = 
m§_io˘l
,

202 
__˝uöô
 
	$m§_devi˚_¸óã
(
˝u
)

204 
devi˚
 *
dev
;

206 
dev
 = 
	`devi˚_¸óã
(
m§_˛ass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
), NULL,

207 "m§%d", 
˝u
);

208  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

209 
	}
}

211 
	$m§_devi˚_de°roy
(
˝u
)

213 
	`devi˚_de°roy
(
m§_˛ass
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
));

214 
	}
}

216 
__˝uöô
 
	$m§_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

217 
a˘i⁄
, *
h˝u
)

219 
˝u
 = ()
h˝u
;

220 
îr
 = 0;

222 
a˘i⁄
) {

223 
CPU_UP_PREPARE
:

224 
îr
 = 
	`m§_devi˚_¸óã
(
˝u
);

226 
CPU_UP_CANCELED
:

227 
CPU_UP_CANCELED_FROZEN
:

228 
CPU_DEAD
:

229 
	`m§_devi˚_de°roy
(
˝u
);

232  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

233 
	}
}

235 
nŸifõr_block
 
__ªfd©a
 
	gm§_˛ass_˝u_nŸifõr
 = {

236 .
nŸifõr_ˇŒ
 = 
m§_˛ass_˝u_ˇŒback
,

239 *
	$m§_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

241  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/m§", 
	`MINOR
(
dev
->
devt
));

242 
	}
}

244 
__öô
 
	$m§_öô
()

246 
i
, 
îr
 = 0;

247 
i
 = 0;

249 i‡(
	`__ªgi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "˝u/m§", &
m§_f›s
)) {

250 
	`¥ötk
(
KERN_ERR
 "msr: unableÅo get major %d for msr\n",

251 
MSR_MAJOR
);

252 
îr
 = -
EBUSY
;

253 
out
;

255 
m§_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "msr");

256 i‡(
	`IS_ERR
(
m§_˛ass
)) {

257 
îr
 = 
	`PTR_ERR
(
m§_˛ass
);

258 
out_chrdev
;

260 
m§_˛ass
->
devnode
 = 
m§_devnode
;

261 
	`f‹_óch_⁄löe_˝u
(
i
) {

262 
îr
 = 
	`m§_devi˚_¸óã
(
i
);

263 i‡(
îr
 != 0)

264 
out_˛ass
;

266 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

268 
îr
 = 0;

269 
out
;

271 
out_˛ass
:

272 
i
 = 0;

273 
	`f‹_óch_⁄löe_˝u
(
i
)

274 
	`m§_devi˚_de°roy
(
i
);

275 
	`˛ass_de°roy
(
m§_˛ass
);

276 
out_chrdev
:

277 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

278 
out
:

279  
îr
;

280 
	}
}

282 
__exô
 
	$m§_exô
()

284 
˝u
 = 0;

285 
	`f‹_óch_⁄löe_˝u
(
˝u
)

286 
	`m§_devi˚_de°roy
(
˝u
);

287 
	`˛ass_de°roy
(
m§_˛ass
);

288 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

289 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

290 
	}
}

292 
moduÀ_öô
(
m§_öô
);

293 
	$moduÀ_exô
(
m§_exô
)

295 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

296 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

297 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<löux/kî√l.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/•ölock.h
>

31 
	~<löux/°rög.h
>

32 
	~<löux/¸ash_dump.h
>

33 
	~<löux/dma-m≠pög.h
>

34 
	~<löux/bôm≠.h
>

35 
	~<löux/pci_ids.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/sˇâîli°.h
>

39 
	~<löux/iommu-hñ≥r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ˇlg¨y.h
>

43 
	~<asm/t˚.h
>

44 
	~<asm/pci-dúe˘.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

49 
	~<asm/x86_öô.h
>

51 #ifde‡
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


52 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 1;

54 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 0;

57 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

58 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

61 
	#CALGARY_CONFIG_REG
 0x0108

	)

62 
	#PHB_CSR_OFFSET
 0x0110

	)

63 
	#PHB_PLSSR_OFFSET
 0x0120

	)

64 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

65 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

66 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

67 
	#PHB_MEM_1_LOW
 0x0190

	)

68 
	#PHB_MEM_1_HIGH
 0x01A0

	)

69 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

70 
	#PHB_MEM_1_SIZE
 0x01C0

	)

71 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

72 
	#PHB_AER_OFFSET
 0x0200

	)

73 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

74 
	#PHB_CONFIG_0_LOW
 0x0230

	)

75 
	#PHB_CONFIG_0_END
 0x0240

	)

76 
	#PHB_MEM_2_LOW
 0x02B0

	)

77 
	#PHB_MEM_2_HIGH
 0x02C0

	)

78 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

79 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

80 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

83 
	#PHB_SAVIOR_L2
 0x0DB0

	)

84 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

85 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

86 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

89 
	#PHB_TCE_ENABLE
 0x20000000

	)

90 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

91 
	#PHB_DAC_DISABLE
 0x01000000

	)

92 
	#PHB_MEM2_ENABLE
 0x00400000

	)

93 
	#PHB_MCSR_ENABLE
 0x00100000

	)

95 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

96 
	#TAR_VALID
 0x0000000000000008UL

	)

98 
	#CSR_AGENT_MASK
 0xf„0ffff

	)

100 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

102 
	#PMR_SOFTSTOP
 0x80000000

	)

103 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

104 
	#PMR_HARDSTOP
 0x20000000

	)

106 
	#MAX_NUM_OF_PHBS
 8

	)

107 
	#MAX_NUM_CHASSIS
 8

	)

109 
	#MAX_PHB_BUS_NUM
 (
MAX_NUM_OF_PHBS
 * 
MAX_NUM_CHASSIS
 * 2)

	)

110 
	#PHBS_PER_CALGARY
 4

	)

113 c⁄° 
	gèr_off£ts
[] = {

120 c⁄° 
	g•lô_queue_off£ts
[] = {

127 c⁄° 
	gphb_off£ts
[] = {

136 c⁄° 
	gphb_debug_off£ts
[] = {

148 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

150 
	#EMERGENCY_PAGES
 32

	)

152 
	g•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

153 
å™¶©e_em±y_¶Ÿs
 
	g__ªad_mo°ly
 = 0;

154 
ˇlg¨y_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

156 
rio_èbÀ_hdr
 *rio_èbÀ_hd∏
	g__öôd©a
;

157 
sˇl_dëaû
 *
	gsˇl_devs
[
MAX_NUMNODES
] 
	g__öôd©a
;

158 
rio_dëaû
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__öôd©a
;

160 
	sˇlg¨y_bus_öfo
 {

161 *
	mt˚_•a˚
;

162 
	må™¶©i⁄_dißbÀd
;

163 sig√d 
	mphbid
;

164 
__iomem
 *
	mbb¨
;

167 
ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

168 
ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

169 
ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

170 
ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

171 
ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

172 
ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

173 
ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
);

174 
gë_t˚_•a˚_‰om_èr
();

176 
ˇl_chù£t_›s
 
	gˇlg¨y_chù_›s
 = {

177 .
h™dÀ_quúks
 = 
ˇlg¨y_h™dÀ_quúks
,

178 .
	gt˚_ˇche_bœ°
 = 
ˇlg¨y_t˚_ˇche_bœ°
,

179 .
	gdump_îr‹_ªgs
 = 
ˇlg¨y_dump_îr‹_ªgs


182 
ˇl_chù£t_›s
 
	gˇlioc2_chù_›s
 = {

183 .
h™dÀ_quúks
 = 
ˇlioc2_h™dÀ_quúks
,

184 .
	gt˚_ˇche_bœ°
 = 
ˇlioc2_t˚_ˇche_bœ°
,

185 .
	gdump_îr‹_ªgs
 = 
ˇlioc2_dump_îr‹_ªgs


188 
ˇlg¨y_bus_öfo
 
	gbus_öfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

190 
ölöe
 
	$å™¶©i⁄_íabÀd
(
iommu_èbÀ
 *
tbl
)

193  (
tbl
 !
NULL
);

194 
	}
}

196 
	$iommu_ønge_ª£rve
(
iommu_èbÀ
 *
tbl
,

197 
°¨t_addr
, 
≈ages
)

199 
ödex
;

200 
íd
;

201 
Êags
;

203 
ödex
 = 
°¨t_addr
 >> 
PAGE_SHIFT
;

206 i‡(
ödex
 >
tbl
->
ô_size
)

209 
íd
 = 
ödex
 + 
≈ages
;

210 i‡(
íd
 > 
tbl
->
ô_size
)

211 
íd
 = 
tbl
->
ô_size
;

213 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

215 
	`bôm≠_£t
(
tbl
->
ô_m≠
, 
ödex
, 
≈ages
);

217 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

218 
	}
}

220 
	$iommu_ønge_Æloc
(
devi˚
 *
dev
,

221 
iommu_èbÀ
 *
tbl
,

222 
≈ages
)

224 
Êags
;

225 
off£t
;

226 
bound¨y_size
;

228 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

229 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

231 
	`BUG_ON
(
≈ages
 == 0);

233 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

235 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
,Åbl->
ô_höt
,

236 
≈ages
, 0, 
bound¨y_size
, 0);

237 i‡(
off£t
 == ~0UL) {

238 
tbl
->
chù_›s
->
	`t˚_ˇche_bœ°
(tbl);

240 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
, 0,

241 
≈ages
, 0, 
bound¨y_size
, 0);

242 i‡(
off£t
 == ~0UL) {

243 
	`¥ötk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

244 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

245 i‡(
∑nic_⁄_ovîÊow
)

246 
	`∑nic
("Calgary: fixÅheállocator.\n");

248  
DMA_ERROR_CODE
;

252 
tbl
->
ô_höt
 = 
off£t
 + 
≈ages
;

253 
	`BUG_ON
(
tbl
->
ô_höt
 >Åbl->
ô_size
);

255 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

257  
off£t
;

258 
	}
}

260 
dma_addr_t
 
	$iommu_Æloc
(
devi˚
 *
dev
, 
iommu_èbÀ
 *
tbl
,

261 *
vaddr
, 
≈ages
, 
dúe˘i⁄
)

263 
íåy
;

264 
dma_addr_t
 
ªt
;

266 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

268 i‡(
	`u∆ikñy
(
íåy
 =
DMA_ERROR_CODE
)) {

269 
	`¥ötk
(
KERN_WARNING
 "Calgary: failedÅoállocate %uÖages in "

270 "iommu %p\n", 
≈ages
, 
tbl
);

271  
DMA_ERROR_CODE
;

275 
ªt
 = (
íåy
 << 
PAGE_SHIFT
Ë| (()
vaddr
 & ~
PAGE_MASK
);

278 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, ()
vaddr
 & 
PAGE_MASK
,

279 
dúe˘i⁄
);

280  
ªt
;

281 
	}
}

283 
	$iommu_‰ì
(
iommu_èbÀ
 *
tbl
, 
dma_addr_t
 
dma_addr
,

284 
≈ages
)

286 
íåy
;

287 
badíd
;

288 
Êags
;

291 
badíd
 = 
DMA_ERROR_CODE
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

292 i‡(
	`u∆ikñy
((
dma_addr
 >
DMA_ERROR_CODE
Ë&& (dma_add∏< 
badíd
))) {

293 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverÅried unmapping bad DMA "

294 "addªs†0x%Lx\n", 
dma_addr
);

298 
íåy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

300 
	`BUG_ON
(
íåy
 + 
≈ages
 > 
tbl
->
ô_size
);

302 
	`t˚_‰ì
(
tbl
, 
íåy
, 
≈ages
);

304 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

306 
	`bôm≠_˛ór
(
tbl
->
ô_m≠
, 
íåy
, 
≈ages
);

308 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

309 
	}
}

311 
ölöe
 
iommu_èbÀ
 *
	$föd_iommu_èbÀ
(
devi˚
 *
dev
)

313 
pci_dev
 *
pdev
;

314 
pci_bus
 *
pbus
;

315 
iommu_èbÀ
 *
tbl
;

317 
pdev
 = 
	`to_pci_dev
(
dev
);

320 
pbus
 = 
pdev
->
bus
;

322 
tbl
 = 
	`pci_iommu
(
pbus
);

323 i‡(
tbl
 &&Åbl->
ô_bu¢o
 =
pbus
->
numbî
)

325 
tbl
 = 
NULL
;

326 
pbus
 =Öbus->
∑ª¡
;

327 } 
pbus
);

329 
	`BUG_ON
(
tbl
 && (tbl->
ô_bu¢o
 !
pbus
->
numbî
));

331  
tbl
;

332 
	}
}

334 
	$ˇlg¨y_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

335 
√Àms
,
dma_d©a_dúe˘i⁄
 
dú
,

336 
dma_©ås
 *
©ås
)

338 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

339 
sˇâîli°
 *
s
;

340 
i
;

342 i‡(!
	`å™¶©i⁄_íabÀd
(
tbl
))

345 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

346 
≈ages
;

347 
dma_addr_t
 
dma
 = 
s
->
dma_addªss
;

348 
dmÆí
 = 
s
->
dma_Àngth
;

350 i‡(
dmÆí
 == 0)

353 
≈ages
 = 
	`iommu_num_∑ges
(
dma
, 
dmÆí
, 
PAGE_SIZE
);

354 
	`iommu_‰ì
(
tbl
, 
dma
, 
≈ages
);

356 
	}
}

358 
	$ˇlg¨y_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

359 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

360 
dma_©ås
 *
©ås
)

362 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

363 
sˇâîli°
 *
s
;

364 
vaddr
;

365 
≈ages
;

366 
íåy
;

367 
i
;

369 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

370 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

372 
vaddr
 = (Ë
	`sg_vút
(
s
);

373 
≈ages
 = 
	`iommu_num_∑ges
(
vaddr
, 
s
->
Àngth
, 
PAGE_SIZE
);

375 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

376 i‡(
íåy
 =
DMA_ERROR_CODE
) {

378 
s
->
dma_Àngth
 = 0;

379 
îr‹
;

382 
s
->
dma_addªss
 = (
íåy
 << 
PAGE_SHIFT
Ë| s->
off£t
;

385 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, 
vaddr
 & 
PAGE_MASK
, 
dú
);

387 
s
->
dma_Àngth
 = s->
Àngth
;

390  
√Àms
;

391 
îr‹
:

392 
	`ˇlg¨y_unm≠_sg
(
dev
, 
sg
, 
√Àms
, 
dú
, 
NULL
);

393 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

394 
sg
->
dma_addªss
 = 
DMA_ERROR_CODE
;

395 
sg
->
dma_Àngth
 = 0;

398 
	}
}

400 
dma_addr_t
 
	$ˇlg¨y_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

401 
off£t
, 
size_t
 
size
,

402 
dma_d©a_dúe˘i⁄
 
dú
,

403 
dma_©ås
 *
©ås
)

405 *
vaddr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

406 
uaddr
;

407 
≈ages
;

408 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

410 
uaddr
 = ()
vaddr
;

411 
≈ages
 = 
	`iommu_num_∑ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

413  
	`iommu_Æloc
(
dev
, 
tbl
, 
vaddr
, 
≈ages
, 
dú
);

414 
	}
}

416 
	$ˇlg¨y_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

417 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

418 
dma_©ås
 *
©ås
)

420 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

421 
≈ages
;

423 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

424 
	`iommu_‰ì
(
tbl
, 
dma_addr
, 
≈ages
);

425 
	}
}

427 * 
	$ˇlg¨y_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

428 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êag
)

430 *
ªt
 = 
NULL
;

431 
dma_addr_t
 
m≠pög
;

432 
≈ages
, 
‹dî
;

433 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

435 
size
 = 
	`PAGE_ALIGN
(size);

436 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

437 
‹dî
 = 
	`gë_‹dî
(
size
);

439 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

442 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
‹dî
);

443 i‡(!
ªt
)

444 
îr‹
;

445 
	`mem£t
(
ªt
, 0, 
size
);

448 
m≠pög
 = 
	`iommu_Æloc
(
dev
, 
tbl
, 
ªt
, 
≈ages
, 
DMA_BIDIRECTIONAL
);

449 i‡(
m≠pög
 =
DMA_ERROR_CODE
)

450 
‰ì
;

451 *
dma_h™dÀ
 = 
m≠pög
;

452  
ªt
;

453 
‰ì
:

454 
	`‰ì_∑ges
(()
ªt
, 
	`gë_‹dî
(
size
));

455 
ªt
 = 
NULL
;

456 
îr‹
:

457  
ªt
;

458 
	}
}

460 
	$ˇlg¨y_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

461 *
vaddr
, 
dma_addr_t
 
dma_h™dÀ
)

463 
≈ages
;

464 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

466 
size
 = 
	`PAGE_ALIGN
(size);

467 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

469 
	`iommu_‰ì
(
tbl
, 
dma_h™dÀ
, 
≈ages
);

470 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

471 
	}
}

473 
dma_m≠_›s
 
	gˇlg¨y_dma_›s
 = {

474 .
Æloc_cohîít
 = 
ˇlg¨y_Æloc_cohîít
,

475 .
	g‰ì_cohîít
 = 
ˇlg¨y_‰ì_cohîít
,

476 .
	gm≠_sg
 = 
ˇlg¨y_m≠_sg
,

477 .
	gunm≠_sg
 = 
ˇlg¨y_unm≠_sg
,

478 .
	gm≠_∑ge
 = 
ˇlg¨y_m≠_∑ge
,

479 .
	gunm≠_∑ge
 = 
ˇlg¨y_unm≠_∑ge
,

482 
ölöe
 
__iomem
 * 
	$bu¢o_to_bb¨
(
num
)

484  
bus_öfo
[
num
].
bb¨
;

485 
	}
}

487 
ölöe
 
	$bu¢o_to_phbid
(
num
)

489  
bus_öfo
[
num
].
phbid
;

490 
	}
}

492 
ölöe
 
	$•lô_queue_off£t
(
num
)

494 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

496  
•lô_queue_off£ts
[
idx
];

497 
	}
}

499 
ölöe
 
	$èr_off£t
(
num
)

501 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

503  
èr_off£ts
[
idx
];

504 
	}
}

506 
ölöe
 
	$phb_off£t
(
num
)

508 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

510  
phb_off£ts
[
idx
];

511 
	}
}

513 
ölöe
 
__iomem
* 
	$ˇlg¨y_ªg
(
__iomem
 *
b¨
, 
off£t
)

515 
èrgë
 = (()
b¨
Ë| 
off£t
;

516  (
__iomem
*)
èrgë
;

517 
	}
}

519 
ölöe
 
	$is_ˇlioc2
(
devi˚
)

521  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALIOC2
);

522 
	}
}

524 
ölöe
 
	$is_ˇlg¨y
(
devi˚
)

526  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
);

527 
	}
}

529 
ölöe
 
	$is_ˇl_pci_dev
(
devi˚
)

531  (
	`is_ˇlg¨y
(
devi˚
Ë|| 
	`is_ˇlioc2
(device));

532 
	}
}

534 
	$ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

536 
u64
 
vÆ
;

537 
u32
 
´r
;

538 
i
 = 0;

539 
__iomem
 *
bb¨
 = 
tbl
->bbar;

540 
__iomem
 *
èrgë
;

543 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

544 
´r
 = 
	`ªadl
(
èrgë
);

545 
	`wrôñ
(0, 
èrgë
);

548 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

549 
vÆ
 = 
	`ªadl
(
èrgë
);

552 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
tbl
->
ô_bu¢o
));

554 
vÆ
 = 
	`ªadq
(
èrgë
);

555 
i
++;

556 } (
vÆ
 & 0xffË!0xf‡&& 
i
 < 100);

557 i‡(
i
 == 100)

558 
	`¥ötk
(
KERN_WARNING
 "Calgary: PCI busÇot quiesced, "

562 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
tbl
->
ô_bu¢o
));

563 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

566 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

567 
	`wrôñ
(
´r
, 
èrgë
);

568 ()
	`ªadl
(
èrgë
);

569 
	}
}

571 
	$ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

573 
__iomem
 *
bb¨
 = 
tbl
->bbar;

574 
__iomem
 *
èrgë
;

575 
u64
 
vÆ64
;

576 
u32
 
vÆ
;

577 
i
 = 0;

578 
cou¡
 = 1;

579 
bus
 = 
tbl
->
ô_bu¢o
;

581 
begö
:

582 
	`¥ötk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xÉnteringÅce cache blast "

583 "£quí˚ - cou¡ %d\n", 
bus
, 
cou¡
);

586 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

587 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

588 
	`¥ötk
(
KERN_DEBUG
 "1a.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

589 
vÆ
 |
PMR_SOFTSTOP
;

590 
	`¥ötk
(
KERN_DEBUG
 "1b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

591 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

594 
	`¥ötk
(
KERN_DEBUG
 "2a. startingÅoÖoll split queues\n");

595 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
bus
));

597 
vÆ64
 = 
	`ªadq
(
èrgë
);

598 
i
++;

599 } (
vÆ64
 & 0xffË!0xf‡&& 
i
 < 100);

600 i‡(
i
 == 100)

601 
	`¥ötk
(
KERN_WARNING
 "CalIOC2: PCI busÇot quiesced, "

605 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

606 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

607 
	`¥ötk
(
KERN_DEBUG
 "3.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

610 i‡(
vÆ
 & 
PMR_SOFTSTOPFAULT
) {

611 i‡(++
cou¡
 < 100)

612 
begö
;

614 
	`¥ötk
(
KERN_WARNING
 "CalIOC2:Åoo many SoftStopFaults, "

621 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

622 
	`¥ötk
(
KERN_DEBUG
 "5a. sœmmög i¡ÿH¨dSt› byÑódög %p\n", 
èrgë
);

623 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

624 
	`¥ötk
(
KERN_DEBUG
 "5b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

625 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

626 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

627 
	`¥ötk
(
KERN_DEBUG
 "5c.Ñód 0x%x [LE] from %∞(debug)\n", 
vÆ
, 
èrgë
);

630 
	`¥ötk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

631 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
bus
));

632 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

635 
	`¥ötk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

636 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

637 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

638 
	`¥ötk
(
KERN_DEBUG
 "7b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

641 
	`¥ötk
(
KERN_DEBUG
 "8a.Ñemoving HardStop from PMCR\n");

642 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

643 
vÆ
 = 0;

644 
	`¥ötk
(
KERN_DEBUG
 "8b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

645 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

646 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

647 
	`¥ötk
(
KERN_DEBUG
 "8c.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

648 
	}
}

650 
__öô
 
	$ˇlg¨y_ª£rve_mem_ªgi⁄
(
pci_dev
 *
dev
, 
u64
 
°¨t
,

651 
u64
 
limô
)

653 
num∑ges
;

655 
limô
 =Üimit | 0xfffff;

656 
limô
++;

658 
num∑ges
 = ((
limô
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

659 
	`iommu_ønge_ª£rve
(
	`pci_iommu
(
dev
->
bus
), 
°¨t
, 
num∑ges
);

660 
	}
}

662 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
pci_dev
 *
dev
)

664 
__iomem
 *
èrgë
;

665 
u64
 
low
, 
high
, 
sizñow
;

666 
u64
 
°¨t
, 
limô
;

667 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

668 
bu¢um
 = 
dev
->
bus
->
numbî
;

669 
__iomem
 *
bb¨
 = 
tbl
->bbar;

672 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_LOW
);

673 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

674 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_HIGH
);

675 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

676 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_SIZE
);

677 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

679 
°¨t
 = (
high
 << 32Ë| 
low
;

680 
limô
 = 
sizñow
;

682 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

683 
	}
}

685 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
pci_dev
 *
dev
)

687 
__iomem
 *
èrgë
;

688 
u32
 
vÆ32
;

689 
u64
 
low
, 
high
, 
sizñow
, 
sizehigh
;

690 
u64
 
°¨t
, 
limô
;

691 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

692 
bu¢um
 = 
dev
->
bus
->
numbî
;

693 
__iomem
 *
bb¨
 = 
tbl
->bbar;

696 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

697 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

698 i‡(!(
vÆ32
 & 
PHB_MEM2_ENABLE
))

701 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_LOW
);

702 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

703 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_HIGH
);

704 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

705 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_LOW
);

706 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

707 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_HIGH
);

708 
sizehigh
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

710 
°¨t
 = (
high
 << 32Ë| 
low
;

711 
limô
 = (
sizehigh
 << 32Ë| 
sizñow
;

713 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

714 
	}
}

723 
__öô
 
	$ˇlg¨y_ª£rve_ªgi⁄s
(
pci_dev
 *
dev
)

725 
≈ages
;

726 
u64
 
°¨t
;

727 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

730 
	`iommu_ønge_ª£rve
(
tbl
, 
DMA_ERROR_CODE
, 
EMERGENCY_PAGES
);

734 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
)) {

735 
°¨t
 = (640 * 1024);

736 
≈ages
 = ((1024 - 640Ë* 1024Ë>> 
PAGE_SHIFT
;

738 
°¨t
 = 0;

739 
≈ages
 = (1 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

741 
	`iommu_ønge_ª£rve
(
tbl
, 
°¨t
, 
≈ages
);

744 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
dev
);

745 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
dev
);

746 
	}
}

748 
__öô
 
	$ˇlg¨y_£tup_èr
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

750 
u64
 
vÆ64
;

751 
u64
 
èbÀ_phys
;

752 
__iomem
 *
èrgë
;

753 
ªt
;

754 
iommu_èbÀ
 *
tbl
;

757 
ªt
 = 
	`buûd_t˚_èbÀ
(
dev
, 
bb¨
);

758 i‡(
ªt
)

759  
ªt
;

761 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

762 
tbl
->
ô_ba£
 = ()
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
;

764 i‡(
	`is_kdump_kî√l
())

765 
	`ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
tbl
);

767 
	`t˚_‰ì
(
tbl
, 0,Åbl->
ô_size
);

769 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
))

770 
tbl
->
chù_›s
 = &
ˇlg¨y_chù_›s
;

771 i‡(
	`is_ˇlioc2
(
dev
->
devi˚
))

772 
tbl
->
chù_›s
 = &
ˇlioc2_chù_›s
;

774 
	`BUG
();

776 
	`ˇlg¨y_ª£rve_ªgi⁄s
(
dev
);

779 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

780 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

783 
vÆ64
 &~
TAR_SW_BITS
;

784 
èbÀ_phys
 = (
u64
)
	`__∑
(
tbl
->
ô_ba£
);

786 
vÆ64
 |
èbÀ_phys
;

788 
	`BUG_ON
(
•ecifõd_èbÀ_size
 > 
TCE_TABLE_SIZE_8M
);

789 
vÆ64
 |(
u64
Ë
•ecifõd_èbÀ_size
;

791 
tbl
->
èr_vÆ
 = 
	`˝u_to_be64
(
vÆ64
);

793 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

794 
	`ªadq
(
èrgë
);

797 
	}
}

799 
__öô
 
	$ˇlg¨y_‰ì_bus
(
pci_dev
 *
dev
)

801 
u64
 
vÆ64
;

802 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

803 
__iomem
 *
èrgë
;

804 
bôm≠sz
;

806 
èrgë
 = 
	`ˇlg¨y_ªg
(
tbl
->
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

807 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

808 
vÆ64
 &~
TAR_SW_BITS
;

809 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

810 
	`ªadq
(
èrgë
);

812 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

813 
	`‰ì_∑ges
(()
tbl
->
ô_m≠
, 
	`gë_‹dî
(
bôm≠sz
));

814 
tbl
->
ô_m≠
 = 
NULL
;

816 
	`k‰ì
(
tbl
);

818 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

821 
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
 = 
NULL
;

822 
	}
}

824 
	$ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

826 
__iomem
 *
bb¨
 = 
tbl
->bbar;

827 
__iomem
 *
èrgë
;

828 
u32
 
c§
, 
∂s§
;

830 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

831 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

833 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

834 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

837 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on Calgary PHB 0x%x, "

838 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
ô_bu¢o
, 
c§
, 
∂s§
);

839 
	}
}

841 
	$ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

843 
__iomem
 *
bb¨
 = 
tbl
->bbar;

844 
u32
 
c§
, 
csmr
, 
∂s§
, 
mck
, 
rc°©
;

845 
__iomem
 *
èrgë
;

846 
phboff
 = 
	`phb_off£t
(
tbl
->
ô_bu¢o
);

847 
îroff
;

848 
u32
 
îºegs
[7];

849 
i
;

852 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_CSR_OFFSET
);

853 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

855 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

856 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

858 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x290);

859 
csmr
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

861 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x800);

862 
mck
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

864 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on CalIOC2 PHB 0x%x\n",

865 
tbl
->
ô_bu¢o
);

867 
	`¥ötk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

868 
c§
, 
∂s§
, 
csmr
, 
mck
);

871 
	`¥ötk
(
KERN_EMERG
 "Calgary: ");

872 
i
 = 0; i < 
	`ARRAY_SIZE
(
îºegs
); i++) {

874 
îroff
 = (0x810 + (
i
 * 0x10));

875 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
îroff
);

876 
îºegs
[
i
] = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

877 
	`¥ötk
("0x%08x@0x%lx ", 
îºegs
[
i
], 
îroff
);

879 
	`¥ötk
("\n");

882 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

883 
rc°©
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

884 
	`¥ötk
(
KERN_EMERG
 "CÆg¨y: 0x%08x@0x%x\n", 
rc°©
,

885 
PHB_ROOT_COMPLEX_STATUS
);

886 
	}
}

888 
	$ˇlg¨y_w©chdog
(
d©a
)

890 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

891 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

892 
__iomem
 *
bb¨
 = 
tbl
->bbar;

893 
u32
 
vÆ32
;

894 
__iomem
 *
èrgë
;

896 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

897 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

900 i‡(
vÆ32
 & 
CSR_AGENT_MASK
) {

901 
tbl
->
chù_›s
->
	`dump_îr‹_ªgs
(tbl);

904 
	`wrôñ
(0, 
èrgë
);

907 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
) |

908 
PHB_CONFIG_RW_OFFSET
);

909 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

910 
vÆ32
 |
PHB_SLOT_DISABLE
;

911 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

912 
	`ªadl
(
èrgë
);

915 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
 + 2 * 
HZ
);

917 
	}
}

919 
__öô
 
	$ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
__iomem
 *
bb¨
,

920 
bu¢um
, 
timeout
)

922 
u64
 
vÆ64
;

923 
__iomem
 *
èrgë
;

924 
phb_shi·
 = ~0;

925 
u64
 
mask
;

927 
	`bu¢o_to_phbid
(
bu¢um
)) {

928 0: 
phb_shi·
 = (63 - 19);

930 1: 
phb_shi·
 = (63 - 23);

932 2: 
phb_shi·
 = (63 - 27);

934 3: 
phb_shi·
 = (63 - 35);

937 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

940 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
CALGARY_CONFIG_REG
);

941 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

944 
mask
 = ~(0xFUL << 
phb_shi·
);

945 
vÆ64
 &
mask
;

946 
vÆ64
 |(
timeout
 << 
phb_shi·
);

947 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

948 
	`ªadq
(
èrgë
);

949 
	}
}

951 
__öô
 
	$ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

953 
bu¢um
 = 
dev
->
bus
->
numbî
;

954 
__iomem
 *
bb¨
 = 
tbl
->bbar;

955 
__iomem
 *
èrgë
;

956 
u32
 
vÆ
;

961 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_SAVIOR_L2
);

962 
vÆ
 = 
	`˝u_to_be32
(
	`ªadl
(
èrgë
));

963 
vÆ
 |= 0x00800000;

964 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

965 
	}
}

967 
__öô
 
	$ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

969 
bu¢um
 = 
dev
->
bus
->
numbî
;

975 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
Ë&& (
bu¢um
 == 1))

976 
	`ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
tbl
->
bb¨
, 
bu¢um
,

977 
CCR_2SEC_TIMEOUT
);

978 
	}
}

980 
__öô
 
	$ˇlg¨y_íabÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

982 
u32
 
vÆ32
;

983 
bu¢um
;

984 
__iomem
 *
èrgë
;

985 
__iomem
 *
bb¨
;

986 
iommu_èbÀ
 *
tbl
;

988 
bu¢um
 = 
dev
->
bus
->
numbî
;

989 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

990 
bb¨
 = 
tbl
->bbar;

993 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

994 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

995 
vÆ32
 |
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

997 
	`¥ötk
(
KERN_INFO
 "Calgary:ÉnablingÅranslation on %s PHB %#x\n",

998 (
dev
->
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
) ?

999 "CÆg¨y" : "CÆIOC2", 
bu¢um
);

1000 
	`¥ötk
(
KERN_INFO
 "Calgary:Érrant DMAs willÇow beÖrevented onÅhis "

1003 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1004 
	`ªadl
(
èrgë
);

1006 
	`öô_timî
(&
tbl
->
w©chdog_timî
);

1007 
tbl
->
w©chdog_timî
.
fun˘i⁄
 = &
ˇlg¨y_w©chdog
;

1008 
tbl
->
w©chdog_timî
.
d©a
 = ()
dev
;

1009 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
);

1010 
	}
}

1012 
__öô
 
	$ˇlg¨y_dißbÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

1014 
u32
 
vÆ32
;

1015 
bu¢um
;

1016 
__iomem
 *
èrgë
;

1017 
__iomem
 *
bb¨
;

1018 
iommu_èbÀ
 *
tbl
;

1020 
bu¢um
 = 
dev
->
bus
->
numbî
;

1021 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1022 
bb¨
 = 
tbl
->bbar;

1025 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

1026 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1027 
vÆ32
 &~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1029 
	`¥ötk
(
KERN_INFO
 "CÆg¨y: dißblögÅøn¶©i⁄ o¿PHB %#x!\n", 
bu¢um
);

1030 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1031 
	`ªadl
(
èrgë
);

1033 
	`dñ_timî_sync
(&
tbl
->
w©chdog_timî
);

1034 
	}
}

1036 
__öô
 
	$ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
pci_dev
 *
dev
)

1038 
	`pci_dev_gë
(
dev
);

1039 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1042 i‡(
dev
->
bus
->
∑ª¡
)

1043 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1045 
dev
->
bus
->
£lf
 = dev;

1046 
	}
}

1048 
__öô
 
	$ˇlg¨y_öô_⁄e
(
pci_dev
 *
dev
)

1050 
__iomem
 *
bb¨
;

1051 
iommu_èbÀ
 *
tbl
;

1052 
ªt
;

1054 
	`BUG_ON
(
dev
->
bus
->
numbî
 >
MAX_PHB_BUS_NUM
);

1056 
bb¨
 = 
	`bu¢o_to_bb¨
(
dev
->
bus
->
numbî
);

1057 
ªt
 = 
	`ˇlg¨y_£tup_èr
(
dev
, 
bb¨
);

1058 i‡(
ªt
)

1059 
d⁄e
;

1061 
	`pci_dev_gë
(
dev
);

1063 i‡(
dev
->
bus
->
∑ª¡
) {

1064 i‡(
dev
->
bus
->
∑ª¡
->
£lf
)

1065 
	`¥ötk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1066 "bus->∑ª¡->£lf!\n", 
dev
);

1067 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1069 
dev
->
bus
->
£lf
 = dev;

1071 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1072 
tbl
->
chù_›s
->
	`h™dÀ_quúks
—bl, 
dev
);

1074 
	`ˇlg¨y_íabÀ_å™¶©i⁄
(
dev
);

1078 
d⁄e
:

1079  
ªt
;

1080 
	}
}

1082 
__öô
 
	$ˇlg¨y_loˇã_bb¨s
()

1084 
ªt
;

1085 
rioidx
, 
phb
, 
bus
;

1086 
__iomem
 *
bb¨
;

1087 
__iomem
 *
èrgë
;

1088 
off£t
;

1089 
u8
 
°¨t_bus
, 
íd_bus
;

1090 
u32
 
vÆ
;

1092 
ªt
 = -
ENODATA
;

1093 
rioidx
 = 0;Ñioidx < 
rio_èbÀ_hdr
->
num_rio_dev
;Ñioidx++) {

1094 
rio_dëaû
 *
rio
 = 
rio_devs
[
rioidx
];

1096 i‡((
rio
->
ty≥
 !
COMPAT_CALGARY
Ë&& (rio->ty≥ !
ALT_CALGARY
))

1100 
bb¨
 = 
	`i‹em≠_noˇche
(
rio
->
BBAR
, 1024 * 1024);

1101 i‡(!
bb¨
)

1102 
îr‹
;

1104 
phb
 = 0;Öhb < 
PHBS_PER_CALGARY
;Öhb++) {

1105 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1106 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
off£t
);

1108 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1110 
°¨t_bus
 = (
u8
)((
vÆ
 & 0x00FF0000) >> 16);

1111 
íd_bus
 = (
u8
)((
vÆ
 & 0x0000FF00) >> 8);

1113 i‡(
íd_bus
) {

1114 
bus
 = 
°¨t_bus
; bu†<
íd_bus
; bus++) {

1115 
bus_öfo
[
bus
].
bb¨
 = bbar;

1116 
bus_öfo
[
bus
].
phbid
 = 
phb
;

1119 
bus_öfo
[
°¨t_bus
].
bb¨
 = bbar;

1120 
bus_öfo
[
°¨t_bus
].
phbid
 = 
phb
;

1127 
îr‹
:

1129 
bus
 = 0; bu†< 
	`ARRAY_SIZE
(
bus_öfo
); bus++)

1130 i‡(
bus_öfo
[
bus
].
bb¨
)

1131 
	`iounm≠
(
bus_öfo
[
bus
].
bb¨
);

1133  
ªt
;

1134 
	}
}

1136 
__öô
 
	$ˇlg¨y_öô
()

1138 
ªt
;

1139 
pci_dev
 *
dev
 = 
NULL
;

1140 
ˇlg¨y_bus_öfo
 *
öfo
;

1142 
ªt
 = 
	`ˇlg¨y_loˇã_bb¨s
();

1143 i‡(
ªt
)

1144  
ªt
;

1147 i‡(
	`is_kdump_kî√l
())

1148 
	`gë_t˚_•a˚_‰om_èr
();

1151 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1152 i‡(!
dev
)

1154 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1157 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1158 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1159 
	`ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
dev
);

1163 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1166 
ªt
 = 
	`ˇlg¨y_öô_⁄e
(
dev
);

1167 i‡(
ªt
)

1168 
îr‹
;

1171 
dev
 = 
NULL
;

1172 
	`f‹_óch_pci_dev
(
dev
) {

1173 
iommu_èbÀ
 *
tbl
;

1175 
tbl
 = 
	`föd_iommu_èbÀ
(&
dev
->dev);

1177 i‡(
	`å™¶©i⁄_íabÀd
(
tbl
))

1178 
dev
->dev.
¨chd©a
.
dma_›s
 = &
ˇlg¨y_dma_›s
;

1181  
ªt
;

1183 
îr‹
:

1185 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1186 i‡(!
dev
)

1188 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1191 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1192 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1193 
	`pci_dev_put
(
dev
);

1196 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1199 
	`ˇlg¨y_dißbÀ_å™¶©i⁄
(
dev
);

1200 
	`ˇlg¨y_‰ì_bus
(
dev
);

1201 
	`pci_dev_put
(
dev
);

1202 
dev
->dev.
¨chd©a
.
dma_›s
 = 
NULL
;

1205  
ªt
;

1206 
	}
}

1208 
ölöe
 
__öô
 
	$dëîmöe_t˚_èbÀ_size
(
u64
 
øm
)

1210 
ªt
;

1212 i‡(
•ecifõd_èbÀ_size
 !
TCE_TABLE_SIZE_UNSPECIFIED
)

1213  
•ecifõd_èbÀ_size
;

1222 
ªt
 = 
	`gë_‹dî
(
øm
 >> 13);

1223 i‡(
ªt
 > 
TCE_TABLE_SIZE_8M
)

1224 
ªt
 = 
TCE_TABLE_SIZE_8M
;

1226  
ªt
;

1227 
	}
}

1229 
__öô
 
	$buûd_dëaû_¨øys
()

1231 
±r
;

1232 
numnodes
, 
i
;

1233 
sˇl_dëaû_size
, 
rio_dëaû_size
;

1235 
numnodes
 = 
rio_èbÀ_hdr
->
num_sˇl_dev
;

1236 i‡(
numnodes
 > 
MAX_NUMNODES
){

1237 
	`¥ötk
(
KERN_WARNING


1240 
MAX_NUMNODES
, 
numnodes
);

1241  -
ENODEV
;

1244 
rio_èbÀ_hdr
->
vîsi⁄
){

1246 
sˇl_dëaû_size
 = 11;

1247 
rio_dëaû_size
 = 13;

1250 
sˇl_dëaû_size
 = 12;

1251 
rio_dëaû_size
 = 15;

1254 
	`¥ötk
(
KERN_WARNING


1256 
rio_èbÀ_hdr
->
vîsi⁄
);

1257  -
EPROTO
;

1260 
±r
 = (()
rio_èbÀ_hdr
) + 3;

1261 
i
 = 0; i < 
numnodes
; i++, 
±r
 +
sˇl_dëaû_size
)

1262 
sˇl_devs
[
i
] = (
sˇl_dëaû
 *)
±r
;

1264 
i
 = 0; i < 
rio_èbÀ_hdr
->
num_rio_dev
;

1265 
i
++, 
±r
 +
rio_dëaû_size
)

1266 
rio_devs
[
i
] = (
rio_dëaû
 *)
±r
;

1269 
	}
}

1271 
__öô
 
	$ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_dev
)

1273 
dev
;

1274 
u32
 
vÆ
;

1276 i‡(
pci_dev
 =
PCI_DEVICE_ID_IBM_CALIOC2
) {

1284 
dev
 = 1; dev < 8; dev++) {

1285 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 0, 0);

1286 i‡(
vÆ
 != 0xffffffff)

1289  (
vÆ
 != 0xffffffff);

1290 
	}
}

1297 
	$ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
)

1299 
u64
 *
ç
;

1300 
ödex
;

1301 
ç
 = ((
u64
 *)
tbl
->
ô_ba£
);

1302 
ödex
 = 0 ; index < 
tbl
->
ô_size
; index++) {

1303 i‡(*
ç
 != 0x0)

1304 
	`£t_bô
(
ödex
, 
tbl
->
ô_m≠
);

1305 
ç
++;

1307 
	}
}

1314 
__öô
 
	$gë_t˚_•a˚_‰om_èr
()

1316 
bus
;

1317 
__iomem
 *
èrgë
;

1318 
t˚_•a˚
;

1320 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1321 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1322 
pci_devi˚
;

1323 
u32
 
vÆ
;

1325 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1326 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1328 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1330 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1333 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1334 
å™¶©e_em±y_¶Ÿs
) {

1335 
èrgë
 = 
	`ˇlg¨y_ªg
(
bus_öfo
[
bus
].
bb¨
,

1336 
	`èr_off£t
(
bus
));

1337 
t˚_•a˚
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

1338 
t˚_•a˚
 =Å˚_•a˚ & 
TAR_SW_BITS
;

1340 
t˚_•a˚
 =Å˚_•a˚ & (~
•ecifõd_èbÀ_size
);

1341 
öfo
->
t˚_•a˚
 = (
u64
 *)
	`__va
(tce_space);

1345 
	}
}

1347 
__öô
 
	$ˇlg¨y_iommu_öô
()

1349 
ªt
;

1352 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1354 
ªt
 = 
	`ˇlg¨y_öô
();

1355 i‡(
ªt
) {

1356 
	`¥ötk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1357 "ÁŒög backÅÿno_iommu\n", 
ªt
);

1358  
ªt
;

1362 
	}
}

1364 
__öô
 
	$dëe˘_ˇlg¨y
()

1366 
bus
;

1367 *
tbl
;

1368 
ˇlg¨y_found
 = 0;

1369 
±r
;

1370 
off£t
, 
¥ev_off£t
;

1371 
ªt
;

1377 i‡(
no_iommu
 || 
iommu_dëe˘ed
)

1380 i‡(!
u£_ˇlg¨y
)

1383 i‡(!
	`óæy_pci_Ælowed
())

1386 
	`¥ötk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDAárea\n");

1388 
±r
 = ()
	`phys_to_vút
(
	`gë_bios_ebda
());

1390 
rio_èbÀ_hdr
 = 
NULL
;

1391 
¥ev_off£t
 = 0;

1392 
off£t
 = 0x180;

1397 
off£t
 > 
¥ev_off£t
) {

1399 i‡(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1401 
rio_èbÀ_hdr
 = (rio_èbÀ_hd∏*)(
±r
 + 
off£t
 + 4);

1404 
¥ev_off£t
 = 
off£t
;

1405 
off£t
 = *((*)(
±r
 + offset));

1407 i‡(!
rio_èbÀ_hdr
) {

1408 
	`¥ötk
(
KERN_DEBUG
 "Calgary: UnableÅoÜocate Rio GrandeÅable "

1413 
ªt
 = 
	`buûd_dëaû_¨øys
();

1414 i‡(
ªt
) {

1415 
	`¥ötk
(
KERN_DEBUG
 "CÆg¨y: buûd_dëaû_¨øy†ªà%d\n", 
ªt
);

1419 
•ecifõd_èbÀ_size
 = 
	`dëîmöe_t˚_èbÀ_size
((
	`is_kdump_kî√l
() ?

1420 
ßved_max_p‚
 : 
max_p‚
Ë* 
PAGE_SIZE
);

1422 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1423 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1424 
pci_devi˚
;

1425 
u32
 
vÆ
;

1427 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1428 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1430 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1433 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1436 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1437 
å™¶©e_em±y_¶Ÿs
) {

1442 i‡(!
	`is_kdump_kî√l
()) {

1443 
tbl
 = 
	`Æloc_t˚_èbÀ
();

1444 i‡(!
tbl
)

1445 
˛ónup
;

1446 
öfo
->
t˚_•a˚
 = 
tbl
;

1448 
ˇlg¨y_found
 = 1;

1452 
	`¥ötk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1453 
ˇlg¨y_found
 ? "found" : "not found");

1455 i‡(
ˇlg¨y_found
) {

1456 
iommu_dëe˘ed
 = 1;

1457 
ˇlg¨y_dëe˘ed
 = 1;

1458 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1459 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary TCEÅable spec is %d\n",

1460 
•ecifõd_èbÀ_size
);

1462 
x86_öô
.
iommu
.
iommu_öô
 = 
ˇlg¨y_iommu_öô
;

1466 
˛ónup
:

1467 --
bus
; bus >= 0; --bus) {

1468 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1470 i‡(
öfo
->
t˚_•a˚
)

1471 
	`‰ì_t˚_èbÀ
(
öfo
->
t˚_•a˚
);

1473 
	}
}

1475 
__öô
 
	$ˇlg¨y_∑r£_›ti⁄s
(*
p
)

1477 
bridge
;

1478 
size_t
 
Àn
;

1479 * 
ídp
;

1481 *
p
) {

1482 i‡(!
	`°∫cmp
(
p
, "64k", 3))

1483 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_64K
;

1484 i‡(!
	`°∫cmp
(
p
, "128k", 4))

1485 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_128K
;

1486 i‡(!
	`°∫cmp
(
p
, "256k", 4))

1487 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_256K
;

1488 i‡(!
	`°∫cmp
(
p
, "512k", 4))

1489 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_512K
;

1490 i‡(!
	`°∫cmp
(
p
, "1M", 2))

1491 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_1M
;

1492 i‡(!
	`°∫cmp
(
p
, "2M", 2))

1493 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_2M
;

1494 i‡(!
	`°∫cmp
(
p
, "4M", 2))

1495 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_4M
;

1496 i‡(!
	`°∫cmp
(
p
, "8M", 2))

1497 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_8M
;

1499 
Àn
 = 
	`°æí
("translate_empty_slots");

1500 i‡(!
	`°∫cmp
(
p
, "å™¶©e_em±y_¶Ÿs", 
Àn
))

1501 
å™¶©e_em±y_¶Ÿs
 = 1;

1503 
Àn
 = 
	`°æí
("disable");

1504 i‡(!
	`°∫cmp
(
p
, "dißbÀ", 
Àn
)) {

1505 
p
 +
Àn
;

1506 i‡(*
p
 == '=')

1507 ++
p
;

1508 i‡(*
p
 == '\0')

1510 
bridge
 = 
	`sim∂e_°πoul
(
p
, &
ídp
, 0);

1511 i‡(
p
 =
ídp
)

1514 i‡(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1515 
	`¥ötk
(
KERN_INFO
 "Calgary: disabling "

1516 "å™¶©i⁄ f‹ PHB %#x\n", 
bridge
);

1517 
bus_öfo
[
bridge
].
å™¶©i⁄_dißbÀd
 = 1;

1521 
p
 = 
	`°Ωbrk
(p, ",");

1522 i‡(!
p
)

1525 
p
++;

1528 
	}
}

1529 
__£tup
("ˇlg¨y=", 
ˇlg¨y_∑r£_›ti⁄s
);

1531 
__öô
 
	$ˇlg¨y_fixup_⁄e_t˚_•a˚
(
pci_dev
 *
dev
)

1533 
iommu_èbÀ
 *
tbl
;

1534 
≈ages
;

1535 
i
;

1537 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1539 
i
 = 0; i < 4; i++) {

1540 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
PCI_BRIDGE_RESOURCES
 + 
i
];

1543 i‡(!(
r
->
Êags
 & 
IORESOURCE_MEM
))

1547 i‡(!
r
->
°¨t
)

1551 
≈ages
 = (
r
->
íd
 -Ñ->
°¨t
Ë>> 
PAGE_SHIFT
;

1552 
≈ages
++;

1554 
	`iommu_ønge_ª£rve
(
tbl
, 
r
->
°¨t
, 
≈ages
);

1556 
	}
}

1558 
__öô
 
	$ˇlg¨y_fixup_t˚_•a˚s
()

1560 
pci_dev
 *
dev
 = 
NULL
;

1561 
ˇlg¨y_bus_öfo
 *
öfo
;

1563 i‡(
no_iommu
 || 
swiŸlb
 || !
ˇlg¨y_dëe˘ed
)

1564  -
ENODEV
;

1566 
	`¥ötk
(
KERN_DEBUG
 "Calgary: fixing upÅce spaces\n");

1569 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1570 i‡(!
dev
)

1572 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1575 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1576 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1579 i‡(!
öfo
->
t˚_•a˚
)

1582 
	`ˇlg¨y_fixup_⁄e_t˚_•a˚
(
dev
);

1587 
	}
}

1593 
roŸfs_öôˇŒ
(
ˇlg¨y_fixup_t˚_•a˚s
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<löux/dma-m≠pög.h
>

2 
	~<löux/dma-debug.h
>

3 
	~<löux/dm¨.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/pci.h
>

6 
	~<löux/kmemÀak.h
>

8 
	~<asm/¥Ÿo.h
>

9 
	~<asm/dma.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/g¨t.h
>

12 
	~<asm/ˇlg¨y.h
>

13 
	~<asm/amd_iommu.h
>

14 
	~<asm/x86_öô.h
>

16 
f‹bid_dac
 
	g__ªad_mo°ly
;

18 
dma_m≠_›s
 *
	gdma_›s
 = &
nommu_dma_›s
;

19 
EXPORT_SYMBOL
(
dma_›s
);

21 
iommu_ßc_f‹˚
 
	g__ªad_mo°ly
;

23 #ifde‡
CONFIG_IOMMU_DEBUG


24 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 1;

25 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 1;

27 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 0;

28 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 0;

31 
iommu_mîge
 
	g__ªad_mo°ly
 = 0;

33 
no_iommu
 
	g__ªad_mo°ly
;

35 
iommu_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

44 
iommu_∑ss_through
 
	g__ªad_mo°ly
;

47 
devi˚
 
	gx86_dma_ÁŒback_dev
 = {

48 .
öô_«me
 = "fallback device",

49 .
	gcohîít_dma_mask
 = 
ISA_DMA_BIT_MASK
,

50 .
	gdma_mask
 = &
x86_dma_ÁŒback_dev
.
cohîít_dma_mask
,

52 
EXPORT_SYMBOL
(
x86_dma_ÁŒback_dev
);

55 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

57 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

59 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

60  -
EIO
;

62 *
dev
->
dma_mask
 = 
mask
;

65 
	}
}

66 
EXPORT_SYMBOL
(
dma_£t_mask
);

68 #ifde‡
CONFIG_X86_64


69 
__öôd©a
 *
	gdma32_boŸmem_±r
;

70 
dma32_boŸmem_size
 
	g__öôd©a
 = (128ULL<<20);

72 
__öô
 
	$∑r£_dma32_size_›t
(*
p
)

74 i‡(!
p
)

75  -
EINVAL
;

76 
dma32_boŸmem_size
 = 
	`mem∑r£
(
p
, &p);

78 
	}
}

79 
óæy_∑øm
("dma32_size", 
∑r£_dma32_size_›t
);

81 
__öô
 
	$dma32_ª£rve_boŸmem
()

83 
size
, 
Æign
;

84 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

91 
Æign
 = 64ULL<<20;

92 
size
 = 
	`roundup
(
dma32_boŸmem_size
, 
Æign
);

93 
dma32_boŸmem_±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
,

99 
	`kmemÀak_ign‹e
(
dma32_boŸmem_±r
);

100 i‡(
dma32_boŸmem_±r
)

101 
dma32_boŸmem_size
 = 
size
;

103 
dma32_boŸmem_size
 = 0;

104 
	}
}

105 
__öô
 
	$dma32_‰ì_boŸmem
()

108 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

111 i‡(!
dma32_boŸmem_±r
)

114 
	`‰ì_boŸmem
(
	`__∑
(
dma32_boŸmem_±r
), 
dma32_boŸmem_size
);

116 
dma32_boŸmem_±r
 = 
NULL
;

117 
dma32_boŸmem_size
 = 0;

118 
	}
}

121 
__öô
 
	$pci_iommu_Æloc
()

123 #ifde‡
CONFIG_X86_64


125 
	`dma32_‰ì_boŸmem
();

127 i‡(
	`pci_swiŸlb_dëe˘
())

128 
out
;

130 
	`g¨t_iommu_hﬁe_öô
();

132 
	`dëe˘_ˇlg¨y
();

134 
	`dëe˘_öãl_iommu
();

137 
	`amd_iommu_dëe˘
();

138 
out
:

139 
	`pci_swiŸlb_öô
();

140 
	}
}

142 *
	$dma_gíîic_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

143 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

145 
dma_mask
;

146 
∑ge
 *page;

147 
dma_addr_t
 
addr
;

149 
dma_mask
 = 
	`dma_Æloc_cohîít_mask
(
dev
, 
Êag
);

151 
Êag
 |
__GFP_ZERO
;

152 
agaö
:

153 
∑ge
 = 
	`Æloc_∑ges_node
(
	`dev_to_node
(
dev
), 
Êag
, 
	`gë_‹dî
(
size
));

154 i‡(!
∑ge
)

155  
NULL
;

157 
addr
 = 
	`∑ge_to_phys
(
∑ge
);

158 i‡(
addr
 + 
size
 > 
dma_mask
) {

159 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

161 i‡(
dma_mask
 < 
	`DMA_BIT_MASK
(32Ë&& !(
Êag
 & 
GFP_DMA
)) {

162 
Êag
 = (Êag & ~
GFP_DMA32
Ë| 
GFP_DMA
;

163 
agaö
;

166  
NULL
;

169 *
dma_addr
 = 
addr
;

170  
	`∑ge_addªss
(
∑ge
);

171 
	}
}

177 
__öô
 
	$iommu_£tup
(*
p
)

179 
iommu_mîge
 = 1;

181 i‡(!
p
)

182  -
EINVAL
;

184 *
p
) {

185 i‡(!
	`°∫cmp
(
p
, "off", 3))

186 
no_iommu
 = 1;

188 i‡(!
	`°∫cmp
(
p
, "force", 5))

189 
f‹˚_iommu
 = 1;

190 i‡(!
	`°∫cmp
(
p
, "noforce", 7)) {

191 
iommu_mîge
 = 0;

192 
f‹˚_iommu
 = 0;

195 i‡(!
	`°∫cmp
(
p
, "biomerge", 8)) {

196 
iommu_mîge
 = 1;

197 
f‹˚_iommu
 = 1;

199 i‡(!
	`°∫cmp
(
p
, "panic", 5))

200 
∑nic_⁄_ovîÊow
 = 1;

201 i‡(!
	`°∫cmp
(
p
, "nopanic", 7))

202 
∑nic_⁄_ovîÊow
 = 0;

203 i‡(!
	`°∫cmp
(
p
, "merge", 5)) {

204 
iommu_mîge
 = 1;

205 
f‹˚_iommu
 = 1;

207 i‡(!
	`°∫cmp
(
p
, "nomerge", 7))

208 
iommu_mîge
 = 0;

209 i‡(!
	`°∫cmp
(
p
, "forcesac", 8))

210 
iommu_ßc_f‹˚
 = 1;

211 i‡(!
	`°∫cmp
(
p
, "allowdac", 8))

212 
f‹bid_dac
 = 0;

213 i‡(!
	`°∫cmp
(
p
, "nodac", 5))

214 
f‹bid_dac
 = 1;

215 i‡(!
	`°∫cmp
(
p
, "usedac", 6)) {

216 
f‹bid_dac
 = -1;

219 #ifde‡
CONFIG_SWIOTLB


220 i‡(!
	`°∫cmp
(
p
, "soft", 4))

221 
swiŸlb
 = 1;

223 i‡(!
	`°∫cmp
(
p
, "pt", 2))

224 
iommu_∑ss_through
 = 1;

226 
	`g¨t_∑r£_›ti⁄s
(
p
);

228 #ifde‡
CONFIG_CALGARY_IOMMU


229 i‡(!
	`°∫cmp
(
p
, "calgary", 7))

230 
u£_ˇlg¨y
 = 1;

233 
p
 +
	`°rc•n
(p, ",");

234 i‡(*
p
 == ',')

235 ++
p
;

238 
	}
}

239 
óæy_∑øm
("iommu", 
iommu_£tup
);

241 
	$dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

243 
dma_m≠_›s
 *
›s
 = 
	`gë_dma_›s
(
dev
);

245 #ifde‡
CONFIG_PCI


246 i‡(
mask
 > 0xfffffff‡&& 
f‹bid_dac
 > 0) {

247 
	`dev_öfo
(
dev
, "PCI: Disallowing DAC for device\n");

252 i‡(
›s
->
dma_suµ‹ãd
)

253  
›s
->
	`dma_suµ‹ãd
(
dev
, 
mask
);

258 i‡(
mask
 < 
	`DMA_BIT_MASK
(24))

273 i‡(
iommu_ßc_f‹˚
 && (
mask
 >
	`DMA_BIT_MASK
(40))) {

274 
	`dev_öfo
(
dev
, "F‹˚ SAC wôh mask %Lx\n", 
mask
);

279 
	}
}

280 
EXPORT_SYMBOL
(
dma_suµ‹ãd
);

282 
__öô
 
	$pci_iommu_öô
()

284 
	`dma_debug_öô
(
PREALLOC_DMA_DEBUG_ENTRIES
);

286 #ifde‡
CONFIG_PCI


287 
	`dma_debug_add_bus
(&
pci_bus_ty≥
);

289 
x86_öô
.
iommu
.
	`iommu_öô
();

291 i‡(
swiŸlb
) {

292 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: "

294 
	`swiŸlb_¥öt_öfo
();

296 
	`swiŸlb_‰ì
();

299 
	}
}

301 
roŸfs_öôˇŒ
(
pci_iommu_öô
);

303 #ifde‡
CONFIG_PCI


306 
__devöô
 
	$vü_no_dac
(
pci_dev
 *
dev
)

308 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
 && 
f‹bid_dac
 == 0) {

309 
	`dev_öfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

310 
f‹bid_dac
 = 1;

312 
	}
}

313 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vü_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<löux/ty≥s.h
>

15 
	~<löux/˘y≥.h
>

16 
	~<löux/agp_backíd.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/•ölock.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/t›ﬁogy.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bôm≠.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<löux/iommu-hñ≥r.h
>

30 
	~<löux/sysdev.h
>

31 
	~<löux/io.h
>

32 
	~<asm/©omic.h
>

33 
	~<asm/mår.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/¥Ÿo.h
>

36 
	~<asm/iommu.h
>

37 
	~<asm/g¨t.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/swiŸlb.h
>

40 
	~<asm/dma.h
>

41 
	~<asm/k8.h
>

42 
	~<asm/x86_öô.h
>

44 
	giommu_bus_ba£
;

45 
	giommu_size
;

46 
	giommu_∑ges
;

48 
u32
 *
	giommu_g©t_ba£
;

50 
dma_addr_t
 
	gbad_dma_addr
;

59 
	giommu_fuŒÊush
 = 1;

62 
DEFINE_SPINLOCK
(
iommu_bôm≠_lock
);

64 *
	giommu_g¨t_bôm≠
;

66 
u32
 
	gg¨t_unm≠≥d_íåy
;

68 
	#GPTE_VALID
 1

	)

69 
	#GPTE_COHERENT
 2

	)

70 
	#GPTE_ENCODE
(
x
) \

71 (((
x
Ë& 0xfffff000Ë| (((xË>> 32Ë<< 4Ë| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

72 
	#GPTE_DECODE
(
x
Ë(((xË& 0xfffff000Ë| (((
u64
)(xË& 0xff0Ë<< 28))

	)

74 
	#EMERGENCY_PAGES
 32

	)

76 #ifde‡
CONFIG_AGP


77 
	#AGPEXTERN
 

	)

79 
	#AGPEXTERN


	)

83 
AGPEXTERN
 
agp_mem‹y_ª£rved
;

84 
AGPEXTERN
 
__u32
 *
	gagp_g©t_èbÀ
;

86 
	g√xt_bô
;

87 
boﬁ
 
	g√ed_Êush
;

89 
	$Æloc_iommu
(
devi˚
 *
dev
, 
size
,

90 
Æign_mask
)

92 
off£t
, 
Êags
;

93 
bound¨y_size
;

94 
ba£_ödex
;

96 
ba£_ödex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_gë_£g_bound¨y
(
dev
),

97 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

98 
bound¨y_size
 = 
	`ALIGN
((
u64
)
	`dma_gë_£g_bound¨y
(
dev
) + 1,

99 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

101 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

102 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 
√xt_bô
,

103 
size
, 
ba£_ödex
, 
bound¨y_size
, 
Æign_mask
);

104 i‡(
off£t
 == -1) {

105 
√ed_Êush
 = 
åue
;

106 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 0,

107 
size
, 
ba£_ödex
, 
bound¨y_size
,

108 
Æign_mask
);

110 i‡(
off£t
 != -1) {

111 
√xt_bô
 = 
off£t
+
size
;

112 i‡(
√xt_bô
 >
iommu_∑ges
) {

113 
√xt_bô
 = 0;

114 
√ed_Êush
 = 
åue
;

117 i‡(
iommu_fuŒÊush
)

118 
√ed_Êush
 = 
åue
;

119 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

121  
off£t
;

122 
	}
}

124 
	$‰ì_iommu
(
off£t
, 
size
)

126 
Êags
;

128 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

129 
	`bôm≠_˛ór
(
iommu_g¨t_bôm≠
, 
off£t
, 
size
);

130 i‡(
off£t
 >
√xt_bô
)

131 
√xt_bô
 = 
off£t
 + 
size
;

132 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

133 
	}
}

138 
	$Êush_g¨t
()

140 
Êags
;

142 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

143 i‡(
√ed_Êush
) {

144 
	`k8_Êush_g¨ts
();

145 
√ed_Êush
 = 
Ál£
;

147 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

148 
	}
}

150 #ifde‡
CONFIG_IOMMU_LEAK


152 
	gÀak_åa˚
;

153 
	giommu_Àak_∑ges
 = 20;

155 
	$dump_Àak
()

157 
dump
;

159 i‡(
dump
)

161 
dump
 = 1;

163 
	`show_°ack
(
NULL
, NULL);

164 
	`debug_dma_dump_m≠pögs
(
NULL
);

165 
	}
}

168 
	$iommu_fuŒ
(
devi˚
 *
dev
, 
size_t
 
size
, 
dú
)

180 
	`dev_îr
(
dev
, "PCI-DMA: Ouào‡IOMMU s∑˚ f‹ %lu byãs\n", 
size
);

182 i‡(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

183 i‡(
dú
 =
PCI_DMA_FROMDEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

184 
	`∑nic
("PCI-DMA: Memory would be corrupted\n");

185 i‡(
dú
 =
PCI_DMA_TODEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

186 
	`∑nic
(
KERN_ERR


189 #ifde‡
CONFIG_IOMMU_LEAK


190 
	`dump_Àak
();

192 
	}
}

194 
ölöe
 

195 
	$√ed_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

197  
f‹˚_iommu
 || !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

198 
	}
}

200 
ölöe
 

201 
	$n⁄f‹˚d_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

203  !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

204 
	}
}

209 
dma_addr_t
 
	$dma_m≠_¨ó
(
devi˚
 *
dev
, 
dma_addr_t
 
phys_mem
,

210 
size_t
 
size
, 
dú
, 
Æign_mask
)

212 
≈ages
 = 
	`iommu_num_∑ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

213 
iommu_∑ge
 = 
	`Æloc_iommu
(
dev
, 
≈ages
, 
Æign_mask
);

214 
i
;

216 i‡(
iommu_∑ge
 == -1) {

217 i‡(!
	`n⁄f‹˚d_iommu
(
dev
, 
phys_mem
, 
size
))

218  
phys_mem
;

219 i‡(
∑nic_⁄_ovîÊow
)

220 
	`∑nic
("dma_m≠_¨ó ovîÊow %lu byãs\n", 
size
);

221 
	`iommu_fuŒ
(
dev
, 
size
, 
dú
);

222  
bad_dma_addr
;

225 
i
 = 0; i < 
≈ages
; i++) {

226 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

227 
phys_mem
 +
PAGE_SIZE
;

229  
iommu_bus_ba£
 + 
iommu_∑ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

230 
	}
}

233 
dma_addr_t
 
	$g¨t_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

234 
off£t
, 
size_t
 
size
,

235 
dma_d©a_dúe˘i⁄
 
dú
,

236 
dma_©ås
 *
©ås
)

238 
bus
;

239 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

241 i‡(!
dev
)

242 
dev
 = &
x86_dma_ÁŒback_dev
;

244 i‡(!
	`√ed_iommu
(
dev
, 
∑ddr
, 
size
))

245  
∑ddr
;

247 
bus
 = 
	`dma_m≠_¨ó
(
dev
, 
∑ddr
, 
size
, 
dú
, 0);

248 
	`Êush_g¨t
();

250  
bus
;

251 
	}
}

256 
	$g¨t_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

257 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

258 
dma_©ås
 *
©ås
)

260 
iommu_∑ge
;

261 
≈ages
;

262 
i
;

264 i‡(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

265 
dma_addr
 >
iommu_bus_ba£
 + 
iommu_size
)

268 
iommu_∑ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

269 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

270 
i
 = 0; i < 
≈ages
; i++) {

271 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
g¨t_unm≠≥d_íåy
;

273 
	`‰ì_iommu
(
iommu_∑ge
, 
≈ages
);

274 
	}
}

279 
	$g¨t_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

280 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

282 
sˇâîli°
 *
s
;

283 
i
;

285 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

286 i‡(!
s
->
dma_Àngth
 || !s->
Àngth
)

288 
	`g¨t_unm≠_∑ge
(
dev
, 
s
->
dma_addªss
, s->
dma_Àngth
, 
dú
, 
NULL
);

290 
	}
}

293 
	$dma_m≠_sg_n⁄f‹˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

294 
√¡s
, 
dú
)

296 
sˇâîli°
 *
s
;

297 
i
;

299 #ifde‡
CONFIG_IOMMU_DEBUG


300 
	`¥_debug
("dma_map_sg overflow\n");

303 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

304 
addr
 = 
	`sg_phys
(
s
);

306 i‡(
	`n⁄f‹˚d_iommu
(
dev
, 
addr
, 
s
->
Àngth
)) {

307 
addr
 = 
	`dma_m≠_¨ó
(
dev
,áddr, 
s
->
Àngth
, 
dú
, 0);

308 i‡(
addr
 =
bad_dma_addr
) {

309 i‡(
i
 > 0)

310 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
i
, 
dú
, 
NULL
);

311 
√¡s
 = 0;

312 
sg
[0].
dma_Àngth
 = 0;

316 
s
->
dma_addªss
 = 
addr
;

317 
s
->
dma_Àngth
 = s->
Àngth
;

319 
	`Êush_g¨t
();

321  
√¡s
;

322 
	}
}

325 
	$__dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
,

326 
√Àms
, 
sˇâîli°
 *
sout
,

327 
∑ges
)

329 
iommu_°¨t
 = 
	`Æloc_iommu
(
dev
, 
∑ges
, 0);

330 
iommu_∑ge
 = 
iommu_°¨t
;

331 
sˇâîli°
 *
s
;

332 
i
;

334 i‡(
iommu_°¨t
 == -1)

337 
	`f‹_óch_sg
(
°¨t
, 
s
, 
√Àms
, 
i
) {

338 
∑ges
, 
addr
;

339 
phys_addr
 = 
s
->
dma_addªss
;

341 
	`BUG_ON
(
s
 !
°¨t
 && s->
off£t
);

342 i‡(
s
 =
°¨t
) {

343 
sout
->
dma_addªss
 = 
iommu_bus_ba£
;

344 
sout
->
dma_addªss
 +
iommu_∑ge
*
PAGE_SIZE
 + 
s
->
off£t
;

345 
sout
->
dma_Àngth
 = 
s
->
Àngth
;

347 
sout
->
dma_Àngth
 +
s
->
Àngth
;

350 
addr
 = 
phys_addr
;

351 
∑ges
 = 
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

352 
∑ges
--) {

353 
iommu_g©t_ba£
[
iommu_∑ge
] = 
	`GPTE_ENCODE
(
addr
);

354 
addr
 +
PAGE_SIZE
;

355 
iommu_∑ge
++;

358 
	`BUG_ON
(
iommu_∑ge
 - 
iommu_°¨t
 !
∑ges
);

361 
	}
}

363 
ölöe
 

364 
	$dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
, 
√Àms
,

365 
sˇâîli°
 *
sout
, 
∑ges
, 
√ed
)

367 i‡(!
√ed
) {

368 
	`BUG_ON
(
√Àms
 != 1);

369 
sout
->
dma_addªss
 = 
°¨t
->dma_address;

370 
sout
->
dma_Àngth
 = 
°¨t
->
Àngth
;

373  
	`__dma_m≠_c⁄t
(
dev
, 
°¨t
, 
√Àms
, 
sout
, 
∑ges
);

374 
	}
}

380 
	$g¨t_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

381 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

383 
sˇâîli°
 *
s
, *
ps
, *
°¨t_sg
, *
sgm≠
;

384 
√ed
 = 0, 
√xäìd
, 
i
, 
out
, 
°¨t
;

385 
∑ges
 = 0;

386 
£g_size
;

387 
max_£g_size
;

389 i‡(
√¡s
 == 0)

392 i‡(!
dev
)

393 
dev
 = &
x86_dma_ÁŒback_dev
;

395 
out
 = 0;

396 
°¨t
 = 0;

397 
°¨t_sg
 = 
sg
;

398 
sgm≠
 = 
sg
;

399 
£g_size
 = 0;

400 
max_£g_size
 = 
	`dma_gë_max_£g_size
(
dev
);

401 
ps
 = 
NULL
;

403 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

404 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

406 
s
->
dma_addªss
 = 
addr
;

407 
	`BUG_ON
(
s
->
Àngth
 == 0);

409 
√xäìd
 = 
	`√ed_iommu
(
dev
, 
addr
, 
s
->
Àngth
);

412 i‡(
i
 > 
°¨t
) {

418 i‡(!
iommu_mîge
 || !
√xäìd
 || !
√ed
 || 
s
->
off£t
 ||

419 (
s
->
Àngth
 + 
£g_size
 > 
max_£g_size
) ||

420 (
ps
->
off£t
 +Ös->
Àngth
Ë% 
PAGE_SIZE
) {

421 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
,

422 
sgm≠
, 
∑ges
, 
√ed
) < 0)

423 
îr‹
;

424 
out
++;

426 
£g_size
 = 0;

427 
sgm≠
 = 
	`sg_√xt
(sgmap);

428 
∑ges
 = 0;

429 
°¨t
 = 
i
;

430 
°¨t_sg
 = 
s
;

434 
£g_size
 +
s
->
Àngth
;

435 
√ed
 = 
√xäìd
;

436 
∑ges
 +
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

437 
ps
 = 
s
;

439 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
, 
sgm≠
, 
∑ges
, 
√ed
) < 0)

440 
îr‹
;

441 
out
++;

442 
	`Êush_g¨t
();

443 i‡(
out
 < 
√¡s
) {

444 
sgm≠
 = 
	`sg_√xt
(sgmap);

445 
sgm≠
->
dma_Àngth
 = 0;

447  
out
;

449 
îr‹
:

450 
	`Êush_g¨t
();

451 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
out
, 
dú
, 
NULL
);

454 i‡(
f‹˚_iommu
 || 
iommu_mîge
) {

455 
out
 = 
	`dma_m≠_sg_n⁄f‹˚
(
dev
, 
sg
, 
√¡s
, 
dú
);

456 i‡(
out
 > 0)

457  
out
;

459 i‡(
∑nic_⁄_ovîÊow
)

460 
	`∑nic
("dma_m≠_sg: ovîÊow o¿%luÖages\n", 
∑ges
);

462 
	`iommu_fuŒ
(
dev
, 
∑ges
 << 
PAGE_SHIFT
, 
dú
);

463 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
)

464 
s
->
dma_addªss
 = 
bad_dma_addr
;

466 
	}
}

470 
	$g¨t_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

471 
gÂ_t
 
Êag
)

473 
dma_addr_t
 
∑ddr
;

474 
Æign_mask
;

475 
∑ge
 *page;

477 i‡(
f‹˚_iommu
 && !(
Êag
 & 
GFP_DMA
)) {

478 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

479 
∑ge
 = 
	`Æloc_∑ges
(
Êag
 | 
__GFP_ZERO
, 
	`gë_‹dî
(
size
));

480 i‡(!
∑ge
)

481  
NULL
;

483 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

484 
∑ddr
 = 
	`dma_m≠_¨ó
(
dev
, 
	`∑ge_to_phys
(
∑ge
), 
size
,

485 
DMA_BIDIRECTIONAL
, 
Æign_mask
);

487 
	`Êush_g¨t
();

488 i‡(
∑ddr
 !
bad_dma_addr
) {

489 *
dma_addr
 = 
∑ddr
;

490  
	`∑ge_addªss
(
∑ge
);

492 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

494  
	`dma_gíîic_Æloc_cohîít
(
dev
, 
size
, 
dma_addr
, 
Êag
);

496  
NULL
;

497 
	}
}

501 
	$g¨t_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

502 
dma_addr_t
 
dma_addr
)

504 
	`g¨t_unm≠_∑ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

505 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

506 
	}
}

508 
	$g¨t_m≠pög_îr‹
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
)

510  (
dma_addr
 =
bad_dma_addr
);

511 
	}
}

513 
	gno_agp
;

515 
__öô
 
	$check_iommu_size
(
≠î
, 
u64
 
≠î_size
)

517 
a
;

519 i‡(!
iommu_size
) {

520 
iommu_size
 = 
≠î_size
;

521 i‡(!
no_agp
)

522 
iommu_size
 /= 2;

525 
a
 = 
≠î
 + 
iommu_size
;

526 
iommu_size
 -
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -á;

528 i‡(
iommu_size
 < 64*1024*1024) {

529 
	`¥_w¨nög
(

532 
iommu_size
 >> 20);

535  
iommu_size
;

536 
	}
}

538 
__öô
 
	$ªad_≠îtuª
(
pci_dev
 *
dev
, 
u32
 *
size
)

540 
≠î_size
 = 0, 
≠î_ba£_32
, 
≠î_‹dî
;

541 
u64
 
≠î_ba£
;

543 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
≠î_ba£_32
);

544 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
≠î_‹dî
);

545 
≠î_‹dî
 = (aper_order >> 1) & 7;

547 
≠î_ba£
 = 
≠î_ba£_32
 & 0x7fff;

548 
≠î_ba£
 <<= 25;

550 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

551 i‡(
≠î_ba£
 + 
≠î_size
 > 0x100000000UL || !aper_size)

552 
≠î_ba£
 = 0;

554 *
size
 = 
≠î_size
;

555  
≠î_ba£
;

556 
	}
}

558 
	$íabÀ_g¨t_å™¶©i⁄s
()

560 
i
;

562 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

563 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

565 
	`íabÀ_g¨t_å™¶©i⁄
(
dev
, 
	`__∑
(
agp_g©t_èbÀ
));

567 
	}
}

573 
boﬁ
 
	gfix_up_n‹th_bridges
;

574 
u32
 
	g≠îtuª_‹dî
;

575 
u32
 
	g≠îtuª_Æloc
;

577 
	$£t_up_g¨t_ªsume
(
u32
 
≠î_‹dî
, u32 
≠î_Æloc
)

579 
fix_up_n‹th_bridges
 = 
åue
;

580 
≠îtuª_‹dî
 = 
≠î_‹dî
;

581 
≠îtuª_Æloc
 = 
≠î_Æloc
;

582 
	}
}

584 
	$g¨t_fixup_n‹thbridges
(
sys_devi˚
 *
dev
)

586 
i
;

588 i‡(!
fix_up_n‹th_bridges
)

591 
	`¥_öfo
("PCI-DMA: Restoring GARTáperture settings\n");

593 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

594 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

600 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
≠îtuª_‹dî
 << 1);

601 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, 
≠îtuª_Æloc
 >> 25);

603 
	}
}

605 
	$g¨t_ªsume
(
sys_devi˚
 *
dev
)

607 
	`¥_öfo
("PCI-DMA: Resuming GART IOMMU\n");

609 
	`g¨t_fixup_n‹thbridges
(
dev
);

611 
	`íabÀ_g¨t_å™¶©i⁄s
();

614 
	}
}

616 
	$g¨t_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

619 
	}
}

621 
sysdev_˛ass
 
	gg¨t_sysdev_˛ass
 = {

622 .
«me
 = "gart",

623 .
	gsu•íd
 = 
g¨t_su•íd
,

624 .
	gªsume
 = 
g¨t_ªsume
,

628 
sys_devi˚
 
	gdevi˚_g¨t
 = {

629 .
˛s
 = &
g¨t_sysdev_˛ass
,

636 
__öô
 
	$öô_k8_g©t
(
agp_kîn_öfo
 *
öfo
)

638 
≠î_size
, 
g©t_size
, 
√w_≠î_size
;

639 
≠î_ba£
, 
√w_≠î_ba£
;

640 
pci_dev
 *
dev
;

641 *
g©t
;

642 
i
, 
îr‹
;

644 
	`¥_öfo
("PCI-DMA: Disabling AGP.\n");

646 
≠î_size
 = 
≠î_ba£
 = 
öfo
->aper_size = 0;

647 
dev
 = 
NULL
;

648 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

649 
dev
 = 
k8_n‹thbridges
[
i
];

650 
√w_≠î_ba£
 = 
	`ªad_≠îtuª
(
dev
, &
√w_≠î_size
);

651 i‡(!
√w_≠î_ba£
)

652 
nommu
;

654 i‡(!
≠î_ba£
) {

655 
≠î_size
 = 
√w_≠î_size
;

656 
≠î_ba£
 = 
√w_≠î_ba£
;

658 i‡(
≠î_size
 !
√w_≠î_size
 || 
≠î_ba£
 !
√w_≠î_ba£
)

659 
nommu
;

661 i‡(!
≠î_ba£
)

662 
nommu
;

664 
öfo
->
≠î_ba£
 =áper_base;

665 
öfo
->
≠î_size
 =áper_size >> 20;

667 
g©t_size
 = (
≠î_size
 >> 
PAGE_SHIFT
Ë* (
u32
);

668 
g©t
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

669 
	`gë_‹dî
(
g©t_size
));

670 i‡(!
g©t
)

671 
	`∑nic
("Cannotállocate GATTÅable");

672 i‡(
	`£t_mem‹y_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

673 
	`∑nic
("CouldÇot set GART PTEsÅo uncacheableÖages");

675 
agp_g©t_èbÀ
 = 
g©t
;

677 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
g¨t_sysdev_˛ass
);

678 i‡(!
îr‹
)

679 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_g¨t
);

680 i‡(
îr‹
)

681 
	`∑nic
("CouldÇotÑegister gart_sysdev -- "

684 
	`Êush_g¨t
();

686 
	`¥_öfo
("PCI-DMA:áperture base @ %x size %u KB\n",

687 
≠î_ba£
, 
≠î_size
>>10);

691 
nommu
:

693 
	`¥_w¨nög
("PCI-DMA: MoreÅhan 4GB of RAMándÇo IOMMU\n"

696 
	}
}

698 
dma_m≠_›s
 
	gg¨t_dma_›s
 = {

699 .
m≠_sg
 = 
g¨t_m≠_sg
,

700 .
	gunm≠_sg
 = 
g¨t_unm≠_sg
,

701 .
	gm≠_∑ge
 = 
g¨t_m≠_∑ge
,

702 .
	gunm≠_∑ge
 = 
g¨t_unm≠_∑ge
,

703 .
	gÆloc_cohîít
 = 
g¨t_Æloc_cohîít
,

704 .
	g‰ì_cohîít
 = 
g¨t_‰ì_cohîít
,

705 .
	gm≠pög_îr‹
 = 
g¨t_m≠pög_îr‹
,

708 
	$g¨t_iommu_shutdown
()

710 
pci_dev
 *
dev
;

711 
i
;

714 i‡(!
no_agp
)

717 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

718 
u32
 
˘l
;

720 
dev
 = 
k8_n‹thbridges
[
i
];

721 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
˘l
);

723 
˘l
 &~
GARTEN
;

725 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
˘l
);

727 
	}
}

729 
__öô
 
	$g¨t_iommu_öô
()

731 
agp_kîn_öfo
 
öfo
;

732 
iommu_°¨t
;

733 
≠î_ba£
, 
≠î_size
;

734 
°¨t_p‚
, 
íd_p‚
;

735 
s¸©ch
;

736 
i
;

738 i‡(
	`ˇche_k8_n‹thbridges
(Ë< 0 || 
num_k8_n‹thbridges
 == 0)

741 #i‚de‡
CONFIG_AGP_AMD64


742 
no_agp
 = 1;

746 
no_agp
 =Ço_agp ||

747 (
	`agp_amd64_öô
() < 0) ||

748 (
	`agp_c›y_öfo
(
agp_bridge
, &
öfo
) < 0);

751 i‡(
no_iommu
 ||

752 (!
f‹˚_iommu
 && 
max_p‚
 <
MAX_DMA32_PFN
) ||

753 !
g¨t_iommu_≠îtuª
 ||

754 (
no_agp
 && 
	`öô_k8_g©t
(&
öfo
) < 0)) {

755 i‡(
max_p‚
 > 
MAX_DMA32_PFN
) {

756 
	`¥_w¨nög
("MoreÅhan 4GB of memory but GART IOMMUÇotávailable.\n");

757 
	`¥_w¨nög
("falling backÅo iommu=soft.\n");

763 
≠î_size
 = 
öfo
.aper_size << 20;

764 
≠î_ba£
 = 
öfo
.aper_base;

765 
íd_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
Ë+ (
≠î_size
>>PAGE_SHIFT);

767 i‡(
íd_p‚
 > 
max_low_p‚_m≠≥d
) {

768 
°¨t_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
);

769 
	`öô_mem‹y_m≠pög
(
°¨t_p‚
<<
PAGE_SHIFT
, 
íd_p‚
<<PAGE_SHIFT);

772 
	`¥_öfo
("PCI-DMA: using GART IOMMU.\n");

773 
iommu_size
 = 
	`check_iommu_size
(
öfo
.
≠î_ba£
, 
≠î_size
);

774 
iommu_∑ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

776 
iommu_g¨t_bôm≠
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

777 
	`gë_‹dî
(
iommu_∑ges
/8));

778 i‡(!
iommu_g¨t_bôm≠
)

779 
	`∑nic
("Cannotállocate iommu bitmap\n");

781 #ifde‡
CONFIG_IOMMU_LEAK


782 i‡(
Àak_åa˚
) {

783 
ªt
;

785 
ªt
 = 
	`dma_debug_ªsize_íåõs
(
iommu_∑ges
);

786 i‡(
ªt
)

787 
	`¥_debug
("PCI-DMA: CannotÅraceállÅheÉntries\n");

795 
	`bôm≠_£t
(
iommu_g¨t_bôm≠
, 0, 
EMERGENCY_PAGES
);

797 
	`¥_öfo
("PCI-DMA: Reserving %luMB of IOMMUárea inÅhe AGPáperture\n",

798 
iommu_size
 >> 20);

800 
agp_mem‹y_ª£rved
 = 
iommu_size
;

801 
iommu_°¨t
 = 
≠î_size
 - 
iommu_size
;

802 
iommu_bus_ba£
 = 
öfo
.
≠î_ba£
 + 
iommu_°¨t
;

803 
bad_dma_addr
 = 
iommu_bus_ba£
;

804 
iommu_g©t_ba£
 = 
agp_g©t_èbÀ
 + (
iommu_°¨t
>>
PAGE_SHIFT
);

815 
	`£t_mem‹y_≈
(()
	`__va
(
iommu_bus_ba£
),

816 
iommu_size
 >> 
PAGE_SHIFT
);

825 
	`wbövd
();

833 
	`íabÀ_g¨t_å™¶©i⁄s
();

841 
s¸©ch
 = 
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

842 i‡(!
s¸©ch
)

843 
	`∑nic
("Cannotállocate iommu scratchÖage");

844 
g¨t_unm≠≥d_íåy
 = 
	`GPTE_ENCODE
(
	`__∑
(
s¸©ch
));

845 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_∑ges
; i++)

846 
iommu_g©t_ba£
[
i
] = 
g¨t_unm≠≥d_íåy
;

848 
	`Êush_g¨t
();

849 
dma_›s
 = &
g¨t_dma_›s
;

850 
x86_∂©f‹m
.
iommu_shutdown
 = 
g¨t_iommu_shutdown
;

851 
swiŸlb
 = 0;

854 
	}
}

856 
__öô
 
	$g¨t_∑r£_›ti⁄s
(*
p
)

858 
¨g
;

860 #ifde‡
CONFIG_IOMMU_LEAK


861 i‡(!
	`°∫cmp
(
p
, "leak", 4)) {

862 
Àak_åa˚
 = 1;

863 
p
 += 4;

864 i‡(*
p
 == '=')

865 ++
p
;

866 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

867 
iommu_Àak_∑ges
 = 
¨g
;

870 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

871 
iommu_size
 = 
¨g
;

872 i‡(!
	`°∫cmp
(
p
, "fullflush", 9))

873 
iommu_fuŒÊush
 = 1;

874 i‡(!
	`°∫cmp
(
p
, "nofullflush", 11))

875 
iommu_fuŒÊush
 = 0;

876 i‡(!
	`°∫cmp
(
p
, "noagp", 5))

877 
no_agp
 = 1;

878 i‡(!
	`°∫cmp
(
p
, "noaperture", 10))

879 
fix_≠îtuª
 = 0;

881 i‡(!
	`°∫cmp
(
p
, "force", 5))

882 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

883 i‡(!
	`°∫cmp
(
p
, "allowed", 7))

884 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

885 i‡(!
	`°∫cmp
(
p
, "memaper", 7)) {

886 
ÁŒback_≠î_f‹˚
 = 1;

887 
p
 += 7;

888 i‡(*
p
 == '=') {

889 ++
p
;

890 i‡(
	`gë_›ti⁄
(&
p
, &
¨g
))

891 
ÁŒback_≠î_‹dî
 = 
¨g
;

894 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<löux/dma-m≠pög.h
>

4 
	~<löux/sˇâîli°.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/pci.h
>

8 
	~<löux/mm.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/dma.h
>

15 
	$check_addr
(*
«me
, 
devi˚
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

17 i‡(
hwdev
 && !
	`dma_ˇ∑bÀ
(hwdev, 
bus
, 
size
)) {

18 i‡(*
hwdev
->
dma_mask
 >
	`DMA_BIT_MASK
(32))

19 
	`¥ötk
(
KERN_ERR


21 
«me
, ()
bus
, 
size
,

22 ()*
hwdev
->
dma_mask
);

26 
	}
}

28 
dma_addr_t
 
	$nommu_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

29 
off£t
, 
size_t
 
size
,

30 
dma_d©a_dúe˘i⁄
 
dú
,

31 
dma_©ås
 *
©ås
)

33 
dma_addr_t
 
bus
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

34 
	`WARN_ON
(
size
 == 0);

35 i‡(!
	`check_addr
("m≠_sögÀ", 
dev
, 
bus
, 
size
))

36  
DMA_ERROR_CODE
;

37 
	`Êush_wrôe_buf„rs
();

38  
bus
;

39 
	}
}

56 
	$nommu_m≠_sg
(
devi˚
 *
hwdev
, 
sˇâîli°
 *
sg
,

57 
√¡s
, 
dma_d©a_dúe˘i⁄
 
dú
,

58 
dma_©ås
 *
©ås
)

60 
sˇâîli°
 *
s
;

61 
i
;

63 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

65 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

66 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

67 
s
->
dma_addªss
 = 
	`sg_phys
(s);

68 i‡(!
	`check_addr
("m≠_sg", 
hwdev
, 
s
->
dma_addªss
, s->
Àngth
))

70 
s
->
dma_Àngth
 = s->
Àngth
;

72 
	`Êush_wrôe_buf„rs
();

73  
√¡s
;

74 
	}
}

76 
	$nommu_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

77 
dma_addr_t
 
dma_addr
)

79 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

80 
	}
}

82 
	$nommu_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
,

83 
dma_addr_t
 
addr
, 
size_t
 
size
,

84 
dma_d©a_dúe˘i⁄
 
dú
)

86 
	`Êush_wrôe_buf„rs
();

87 
	}
}

90 
	$nommu_sync_sg_f‹_devi˚
(
devi˚
 *
dev
,

91 
sˇâîli°
 *
sg
, 
√Àms
,

92 
dma_d©a_dúe˘i⁄
 
dú
)

94 
	`Êush_wrôe_buf„rs
();

95 
	}
}

97 
dma_m≠_›s
 
	gnommu_dma_›s
 = {

98 .
Æloc_cohîít
 = 
dma_gíîic_Æloc_cohîít
,

99 .
	g‰ì_cohîít
 = 
nommu_‰ì_cohîít
,

100 .
	gm≠_sg
 = 
nommu_m≠_sg
,

101 .
	gm≠_∑ge
 = 
nommu_m≠_∑ge
,

102 .
	gsync_sögÀ_f‹_devi˚
 = 
nommu_sync_sögÀ_f‹_devi˚
,

103 .
	gsync_sg_f‹_devi˚
 = 
nommu_sync_sg_f‹_devi˚
,

104 .
	gis_phys
 = 1,

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<löux/pci.h
>

4 
	~<löux/ˇche.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/swiŸlb.h
>

7 
	~<löux/boŸmem.h
>

8 
	~<löux/dma-m≠pög.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiŸlb.h
>

12 
	~<asm/dma.h
>

14 
swiŸlb
 
	g__ªad_mo°ly
;

16 *
	$x86_swiŸlb_Æloc_cohîít
(
devi˚
 *
hwdev
, 
size_t
 
size
,

17 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êags
)

19 *
vaddr
;

21 
vaddr
 = 
	`dma_gíîic_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

22 i‡(
vaddr
)

23  
vaddr
;

25  
	`swiŸlb_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

26 
	}
}

28 
dma_m≠_›s
 
	gswiŸlb_dma_›s
 = {

29 .
m≠pög_îr‹
 = 
swiŸlb_dma_m≠pög_îr‹
,

30 .
	gÆloc_cohîít
 = 
x86_swiŸlb_Æloc_cohîít
,

31 .
	g‰ì_cohîít
 = 
swiŸlb_‰ì_cohîít
,

32 .
	gsync_sögÀ_f‹_˝u
 = 
swiŸlb_sync_sögÀ_f‹_˝u
,

33 .
	gsync_sögÀ_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_f‹_devi˚
,

34 .
	gsync_sögÀ_ønge_f‹_˝u
 = 
swiŸlb_sync_sögÀ_ønge_f‹_˝u
,

35 .
	gsync_sögÀ_ønge_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_ønge_f‹_devi˚
,

36 .
	gsync_sg_f‹_˝u
 = 
swiŸlb_sync_sg_f‹_˝u
,

37 .
	gsync_sg_f‹_devi˚
 = 
swiŸlb_sync_sg_f‹_devi˚
,

38 .
	gm≠_sg
 = 
swiŸlb_m≠_sg_©ås
,

39 .
	gunm≠_sg
 = 
swiŸlb_unm≠_sg_©ås
,

40 .
	gm≠_∑ge
 = 
swiŸlb_m≠_∑ge
,

41 .
	gunm≠_∑ge
 = 
swiŸlb_unm≠_∑ge
,

42 .
	gdma_suµ‹ãd
 = 
NULL
,

51 
__öô
 
	$pci_swiŸlb_dëe˘
()

53 
u£_swiŸlb
 = 
swiŸlb
 | 
swiŸlb_f‹˚
;

56 #ifde‡
CONFIG_X86_64


57 i‡(!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
)

58 
swiŸlb
 = 1;

60 i‡(
swiŸlb_f‹˚
)

61 
swiŸlb
 = 1;

63  
u£_swiŸlb
;

64 
	}
}

66 
__öô
 
	$pci_swiŸlb_öô
()

68 i‡(
swiŸlb
) {

69 
	`swiŸlb_öô
(0);

70 
dma_›s
 = &
swiŸlb_dma_›s
;

72 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<löux/∂©f‹m_devi˚.h
>

2 
	~<löux/îr.h
>

3 
	~<löux/öô.h
>

5 
__öô
 
	$add_pc•kr
()

7 
∂©f‹m_devi˚
 *
pd
;

9 
pd
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("pc•kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
Ë? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
devi˚_öôˇŒ
(
add_pc•kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<löux/jiffõs.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/time.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/˝umask.h
>

22 
	~<löux/a˝i_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/m§.h
>

27 
	~<asm/vsysˇŒ.h
>

29 
ölöe
 
u32
 
	$cyc2us
(
u32
 
cy˛es
)

38 
cy˛es
 *= 286;

39  (
cy˛es
 >> 10);

40 
	}
}

42 
	$pmtimî_waô_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
;

46 
a
 =
b
;

47 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
)

48 
	`˝u_ªœx
();

49  
b
;

50 
	}
}

53 
	$pmtimî_waô
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtimî_waô_tick
();

58 
b
 = 
	`öl
(
pmtmr_i›‹t
);

59 
	`˝u_ªœx
();

60 } 
	`cyc2us
(
b
 - 
a
Ë< 
us
);

61 
	}
}

63 
__öô
 
	$n›mtimî_£tup
(*
s
)

65 
pmtmr_i›‹t
 = 0;

67 
	}
}

69 
__£tup
("n›mtimî", 
n›mtimî_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/smp.h
>

5 
	~<löux/¥˘l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/pm.h
>

10 
	~<löux/˛ockchùs.h
>

11 
	~<löux/øndom.h
>

12 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

13 
	~<löux/dmi.h
>

14 
	~<löux/ut¢ame.h
>

15 
	~<åa˚/evíts/powî.h
>

16 
	~<löux/hw_bªakpoöt.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/sysˇŒs.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/i387.h
>

23 
	~<asm/ds.h
>

24 
	~<asm/debugªg.h
>

26 
	gidÀ_hÆt
;

27 
EXPORT_SYMBOL
(
idÀ_hÆt
);

28 
	gidÀ_nomwaô
;

29 
EXPORT_SYMBOL
(
idÀ_nomwaô
);

31 
kmem_ˇche
 *
	gèsk_x°©e_ˇchï
;

33 
	$¨ch_dup_èsk_°ru˘
(
èsk_°ru˘
 *
d°
, èsk_°ru˘ *
§c
)

35 *
d°
 = *
§c
;

36 i‡(
§c
->
thªad
.
x°©e
) {

37 
d°
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

38 
GFP_KERNEL
);

39 i‡(!
d°
->
thªad
.
x°©e
)

40  -
ENOMEM
;

41 
	`WARN_ON
(()
d°
->
thªad
.
x°©e
 & 15);

42 
	`mem˝y
(
d°
->
thªad
.
x°©e
, 
§c
->thªad.x°©e, 
x°©e_size
);

45 
	}
}

47 
	$‰ì_thªad_x°©e
(
èsk_°ru˘
 *
tsk
)

49 i‡(
tsk
->
thªad
.
x°©e
) {

50 
	`kmem_ˇche_‰ì
(
èsk_x°©e_ˇchï
, 
tsk
->
thªad
.
x°©e
);

51 
tsk
->
thªad
.
x°©e
 = 
NULL
;

54 
	`WARN
(
tsk
->
thªad
.
ds_˘x
, "leaking DS context\n");

55 
	}
}

57 
	$‰ì_thªad_öfo
(
thªad_öfo
 *
ti
)

59 
	`‰ì_thªad_x°©e
(
ti
->
èsk
);

60 
	`‰ì_∑ges
(()
ti
, 
	`gë_‹dî
(
THREAD_SIZE
));

61 
	}
}

63 
	$¨ch_èsk_ˇche_öô
()

65 
èsk_x°©e_ˇchï
 =

66 
	`kmem_ˇche_¸óã
("èsk_x°©e", 
x°©e_size
,

67 
	`__Æignof__
(
thªad_x°©e
),

68 
SLAB_PANIC
 | 
SLAB_NOTRACK
, 
NULL
);

69 
	}
}

74 
	$exô_thªad
()

76 
èsk_°ru˘
 *
me
 = 
cuºít
;

77 
thªad_°ru˘
 *
t
 = &
me
->
thªad
;

78 *
bp
 = 
t
->
io_bôm≠_±r
;

80 i‡(
bp
) {

81 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

83 
t
->
io_bôm≠_±r
 = 
NULL
;

84 
	`˛ór_thªad_Êag
(
TIF_IO_BITMAP
);

88 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
t
->
io_bôm≠_max
);

89 
t
->
io_bôm≠_max
 = 0;

90 
	`put_˝u
();

91 
	`k‰ì
(
bp
);

93 
	}
}

95 
	$show_ªgs_comm⁄
()

97 c⁄° *
bﬂrd
, *
¥odu˘
;

99 
bﬂrd
 = 
	`dmi_gë_sy°em_öfo
(
DMI_BOARD_NAME
);

100 i‡(!
bﬂrd
)

101 
bﬂrd
 = "";

102 
¥odu˘
 = 
	`dmi_gë_sy°em_öfo
(
DMI_PRODUCT_NAME
);

103 i‡(!
¥odu˘
)

104 
¥odu˘
 = "";

106 
	`¥ötk
(
KERN_CONT
 "\n");

107 
	`¥ötk
(
KERN_DEFAULT
 "Pid: %d, comm: %.20s %s %s %.*s %s/%s\n",

108 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

109 
	`öô_ut¢ame
()->
ªÀa£
,

110 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

111 
	`öô_ut¢ame
()->
vîsi⁄
, 
bﬂrd
, 
¥odu˘
);

112 
	}
}

114 
	$Êush_thªad
()

116 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

118 
	`Êush_±ø˚_hw_bªakpoöt
(
tsk
);

119 
	`mem£t
(
tsk
->
thªad
.
és_¨øy
, 0, (tsk->thread.tls_array));

123 
tsk
->
Âu_cou¡î
 = 0;

124 
	`˛ór_Âu
(
tsk
);

125 
	`˛ór_u£d_m©h
();

126 
	}
}

128 
	$h¨d_dißbÀ_TSC
()

130 
	`wrôe_¸4
(
	`ªad_¸4
(Ë| 
X86_CR4_TSD
);

131 
	}
}

133 
	$dißbÀ_TSC
()

135 
	`¥ìm±_dißbÀ
();

136 i‡(!
	`ã°_™d_£t_thªad_Êag
(
TIF_NOTSC
))

141 
	`h¨d_dißbÀ_TSC
();

142 
	`¥ìm±_íabÀ
();

143 
	}
}

145 
	$h¨d_íabÀ_TSC
()

147 
	`wrôe_¸4
(
	`ªad_¸4
(Ë& ~
X86_CR4_TSD
);

148 
	}
}

150 
	$íabÀ_TSC
()

152 
	`¥ìm±_dißbÀ
();

153 i‡(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_NOTSC
))

158 
	`h¨d_íabÀ_TSC
();

159 
	`¥ìm±_íabÀ
();

160 
	}
}

162 
	$gë_tsc_mode
(
adr
)

164 
vÆ
;

166 i‡(
	`ã°_thªad_Êag
(
TIF_NOTSC
))

167 
vÆ
 = 
PR_TSC_SIGSEGV
;

169 
vÆ
 = 
PR_TSC_ENABLE
;

171  
	`put_u£r
(
vÆ
, (
__u£r
 *)
adr
);

172 
	}
}

174 
	$£t_tsc_mode
(
vÆ
)

176 i‡(
vÆ
 =
PR_TSC_SIGSEGV
)

177 
	`dißbÀ_TSC
();

178 i‡(
vÆ
 =
PR_TSC_ENABLE
)

179 
	`íabÀ_TSC
();

181  -
EINVAL
;

184 
	}
}

186 
	$__swôch_to_xåa
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
,

187 
tss_°ru˘
 *
tss
)

189 
thªad_°ru˘
 *
¥ev
, *
√xt
;

191 
¥ev
 = &
¥ev_p
->
thªad
;

192 
√xt
 = &
√xt_p
->
thªad
;

194 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DS_AREA_MSR
) ||

195 
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_DS_AREA_MSR
))

196 
	`ds_swôch_to
(
¥ev_p
, 
√xt_p
);

197 i‡(
√xt
->
debug˘lm§
 !
¥ev
->debugctlmsr)

198 
	`upd©e_debug˘lm§
(
√xt
->
debug˘lm§
);

200 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_NOTSC
) ^

201 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
)) {

203 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
))

204 
	`h¨d_dißbÀ_TSC
();

206 
	`h¨d_íabÀ_TSC
();

209 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_IO_BITMAP
)) {

214 
	`mem˝y
(
tss
->
io_bôm≠
, 
√xt
->
io_bôm≠_±r
,

215 
	`max
(
¥ev
->
io_bôm≠_max
, 
√xt
->io_bitmap_max));

216 } i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_IO_BITMAP
)) {

220 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
¥ev
->
io_bôm≠_max
);

222 
	`¥›ag©e_u£r_ªtu∫_nŸify
(
¥ev_p
, 
√xt_p
);

223 
	}
}

225 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

227  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0, 
NULL
, NULL);

228 
	}
}

240 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

242  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0,

243 
NULL
, NULL);

244 
	}
}

247 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

248 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
, 
±_ªgs
 *
ªgs
)

250 i‡(!
√w•
)

251 
√w•
 = 
ªgs
->
•
;

252  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

253 
	}
}

260 
kî√l_thªad_hñ≥r
();

265 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
Êags
)

267 
±_ªgs
 
ªgs
;

269 
	`mem£t
(&
ªgs
, 0, (regs));

271 
ªgs
.
si
 = (Ë
‚
;

272 
ªgs
.
di
 = (Ë
¨g
;

274 #ifde‡
CONFIG_X86_32


275 
ªgs
.
ds
 = 
__USER_DS
;

276 
ªgs
.
es
 = 
__USER_DS
;

277 
ªgs
.
fs
 = 
__KERNEL_PERCPU
;

278 
ªgs
.
gs
 = 
__KERNEL_STACK_CANARY
;

280 
ªgs
.
ss
 = 
__KERNEL_DS
;

283 
ªgs
.
‹ig_ax
 = -1;

284 
ªgs
.
ù
 = (Ë
kî√l_thªad_hñ≥r
;

285 
ªgs
.
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

286 
ªgs
.
Êags
 = 
X86_EFLAGS_IF
 | 0x2;

289  
	`do_f‹k
(
Êags
 | 
CLONE_VM
 | 
CLONE_UNTRACED
, 0, &
ªgs
, 0, 
NULL
, NULL);

290 
	}
}

291 
EXPORT_SYMBOL
(
kî√l_thªad
);

296 
	$sys_execve
(
__u£r
 *
«me
, __u£∏* __u£∏*
¨gv
,

297 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

299 
îr‹
;

300 *
fûíame
;

302 
fûíame
 = 
	`gë«me
(
«me
);

303 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

304 i‡(
	`IS_ERR
(
fûíame
))

305  
îr‹
;

306 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

308 #ifde‡
CONFIG_X86_32


309 i‡(
îr‹
 == 0) {

311 
	`£t_thªad_Êag
(
TIF_IRET
);

315 
	`puäame
(
fûíame
);

316  
îr‹
;

317 
	}
}

322 
	gboŸ_›ti⁄_idÀ_ovîride
 = 0;

323 
EXPORT_SYMBOL
(
boŸ_›ti⁄_idÀ_ovîride
);

328 (*
pm_idÀ
)();

329 
	`EXPORT_SYMBOL
(
pm_idÀ
);

331 #ifde‡
CONFIG_X86_32


336 
h…_cou¡î
;

337 
	$dißbÀ_h…
()

339 
h…_cou¡î
++;

340 
	}
}

341 
EXPORT_SYMBOL
(
dißbÀ_h…
);

343 
	$íabÀ_h…
()

345 
h…_cou¡î
--;

346 
	}
}

347 
EXPORT_SYMBOL
(
íabÀ_h…
);

349 
ölöe
 
	$h…_u£_hÆt
()

351  (!
h…_cou¡î
 && 
boŸ_˝u_d©a
.
h…_w‹ks_ok
);

352 
	}
}

354 
ölöe
 
	$h…_u£_hÆt
()

357 
	}
}

364 
	$deÁu…_idÀ
()

366 i‡(
	`h…_u£_hÆt
()) {

367 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

368 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_POLLING
;

373 
	`smp_mb
();

375 i‡(!
	`√ed_ªsched
())

376 
	`ß„_hÆt
();

378 
	`loˇl_úq_íabÀ
();

379 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

381 
	`loˇl_úq_íabÀ
();

383 
	`˝u_ªœx
();

385 
	}
}

386 #ifde‡
CONFIG_APM_MODULE


387 
EXPORT_SYMBOL
(
deÁu…_idÀ
);

390 
	$°›_this_˝u
(*
dummy
)

392 
	`loˇl_úq_dißbÀ
();

396 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
Ál£
);

397 
	`dißbÀ_loˇl_APIC
();

400 i‡(
	`h…_w‹ks
(
	`smp_¥o˚ss‹_id
()))

401 
	`hÆt
();

403 
	}
}

405 
	$do_nŸhög
(*
unu£d
)

407 
	}
}

417 
	$˝u_idÀ_waô
()

419 
	`smp_mb
();

421 
	`smp_ˇŒ_fun˘i⁄
(
do_nŸhög
, 
NULL
, 1);

422 
	}
}

423 
EXPORT_SYMBOL_GPL
(
˝u_idÀ_waô
);

435 
	$mwaô_idÀ_wôh_höts
(
ax
, 
cx
)

437 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, (
ax
>>4)+1);

438 i‡(!
	`√ed_ªsched
()) {

439 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

440 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

442 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

443 
	`smp_mb
();

444 i‡(!
	`√ed_ªsched
())

445 
	`__mwaô
(
ax
, 
cx
);

447 
	}
}

450 
	$mwaô_idÀ
()

452 i‡(!
	`√ed_ªsched
()) {

453 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

454 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

455 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

457 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

458 
	`smp_mb
();

459 i‡(!
	`√ed_ªsched
())

460 
	`__°i_mwaô
(0, 0);

462 
	`loˇl_úq_íabÀ
();

464 
	`loˇl_úq_íabÀ
();

465 
	}
}

472 
	$pﬁl_idÀ
()

474 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 0);

475 
	`loˇl_úq_íabÀ
();

476 !
	`√ed_ªsched
())

477 
	`˝u_ªœx
();

478 
	`åa˚_powî_íd
(0);

479 
	}
}

493 
__˝uöôd©a
 
	gf‹˚_mwaô
;

495 
	#MWAIT_INFO
 0x05

	)

496 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

497 
	#MWAIT_EDX_C1
 0xf0

	)

499 
__˝uöô
 
	$mwaô_ußbÀ
(c⁄° 
˝uöfo_x86
 *
c
)

501 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

503 i‡(
f‹˚_mwaô
)

506 i‡(
c
->
˝uid_Àvñ
 < 
MWAIT_INFO
)

509 
	`˝uid
(
MWAIT_INFO
, &
óx
, &
ebx
, &
ecx
, &
edx
);

511 i‡(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

518  (
edx
 & 
MWAIT_EDX_C1
);

519 
	}
}

524 
__˝uöô
 
	$check_c1e_idÀ
(c⁄° 
˝uöfo_x86
 *
c
)

526 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
)

529 i‡(
c
->
x86
 < 0x0F)

533 i‡(
c
->
x86
 =0x0‡&& c->
x86_modñ
 < 0x40)

537 
	}
}

539 
˝umask_v¨_t
 
	gc1e_mask
;

540 
	gc1e_dëe˘ed
;

542 
	$c1e_ªmove_˝u
(
˝u
)

544 i‡(
c1e_mask
 !
NULL
)

545 
	`˝umask_˛ór_˝u
(
˝u
, 
c1e_mask
);

546 
	}
}

553 
	$c1e_idÀ
()

555 i‡(
	`√ed_ªsched
())

558 i‡(!
c1e_dëe˘ed
) {

559 
u32
 
lo
, 
hi
;

561 
	`rdm§
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

562 i‡(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

563 
c1e_dëe˘ed
 = 1;

564 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_NONSTOP_TSC
))

565 
	`m¨k_tsc_un°abÀ
("TSC halt in AMD C1E");

566 
	`¥ötk
(
KERN_INFO
 "System has AMD C1EÉnabled\n");

567 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_AMDC1E
);

571 i‡(
c1e_dëe˘ed
) {

572 
˝u
 = 
	`smp_¥o˚ss‹_id
();

574 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
c1e_mask
)) {

575 
	`˝umask_£t_˝u
(
˝u
, 
c1e_mask
);

579 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

580 &
˝u
);

581 
	`¥ötk
(
KERN_INFO
 "SwitchÅo broadcast mode on CPU%d\n",

582 
˝u
);

584 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
˝u
);

586 
	`deÁu…_idÀ
();

592 
	`loˇl_úq_dißbÀ
();

593 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
˝u
);

594 
	`loˇl_úq_íabÀ
();

596 
	`deÁu…_idÀ
();

597 
	}
}

599 
__˝uöô
 
	$£À˘_idÀ_routöe
(c⁄° 
˝uöfo_x86
 *
c
)

601 #ifde‡
CONFIG_SMP


602 i‡(
pm_idÀ
 =
pﬁl_idÀ
 && 
smp_num_siblögs
 > 1) {

603 
	`¥ötk
(
KERN_WARNING
 "WARNING:Öolling idleánd HTÉnabled,"

607 i‡(
pm_idÀ
)

610 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
Ë&& 
	`mwaô_ußbÀ
(c)) {

614 
	`¥ötk
(
KERN_INFO
 "using mwait in idleÅhreads.\n");

615 
pm_idÀ
 = 
mwaô_idÀ
;

616 } i‡(
	`check_c1e_idÀ
(
c
)) {

617 
	`¥ötk
(
KERN_INFO
 "using C1Eáware idleÑoutine\n");

618 
pm_idÀ
 = 
c1e_idÀ
;

620 
pm_idÀ
 = 
deÁu…_idÀ
;

621 
	}
}

623 
__öô
 
	$öô_c1e_mask
()

626 i‡(
pm_idÀ
 =
c1e_idÀ
)

627 
	`zÆloc_˝umask_v¨
(&
c1e_mask
, 
GFP_KERNEL
);

628 
	}
}

630 
__öô
 
	$idÀ_£tup
(*
°r
)

632 i‡(!
°r
)

633  -
EINVAL
;

635 i‡(!
	`°rcmp
(
°r
, "poll")) {

636 
	`¥ötk
("usingÖolling idleÅhreads.\n");

637 
pm_idÀ
 = 
pﬁl_idÀ
;

638 } i‡(!
	`°rcmp
(
°r
, "mwait"))

639 
f‹˚_mwaô
 = 1;

640 i‡(!
	`°rcmp
(
°r
, "halt")) {

648 
pm_idÀ
 = 
deÁu…_idÀ
;

649 
idÀ_hÆt
 = 1;

651 } i‡(!
	`°rcmp
(
°r
, "nomwait")) {

658 
idÀ_nomwaô
 = 1;

663 
boŸ_›ti⁄_idÀ_ovîride
 = 1;

665 
	}
}

666 
óæy_∑øm
("idÀ", 
idÀ_£tup
);

668 
	$¨ch_Æign_°ack
(
•
)

670 i‡(!(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
Ë&& 
øndomize_va_•a˚
)

671 
•
 -
	`gë_øndom_öt
() % 8192;

672  
•
 & ~0xf;

673 
	}
}

675 
	$¨ch_øndomize_brk
(
mm_°ru˘
 *
mm
)

677 
ønge_íd
 = 
mm
->
brk
 + 0x02000000;

678  
	`øndomize_ønge
(
mm
->
brk
, 
ønge_íd
, 0) ? : mm->brk;

679 
	}
}

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/˝u.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/ñfc‹e.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/u£r.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/dñay.h
>

30 
	~<löux/moduÀ.h
>

31 
	~<löux/±ø˚.h
>

32 
	~<löux/nŸifõr.h
>

33 
	~<löux/k¥obes.h
>

34 
	~<löux/kdebug.h
>

35 
	~<löux/tick.h
>

36 
	~<löux/¥˘l.h
>

37 
	~<löux/uac˚ss.h
>

38 
	~<löux/io.h
>

39 
	~<löux/·ø˚.h
>

41 
	~<asm/pgèbÀ.h
>

42 
	~<asm/sy°em.h
>

43 
	~<asm/¥o˚ss‹.h
>

44 
	~<asm/i387.h
>

45 
	~<asm/mmu_c⁄ãxt.h
>

46 
	~<asm/¥˘l.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/¥Ÿo.h
>

49 
	~<asm/ü32.h
>

50 
	~<asm/idÀ.h
>

51 
	~<asm/sysˇŒs.h
>

52 
	~<asm/ds.h
>

53 
	~<asm/debugªg.h
>

55 
asmlökage
 
ªt_‰om_f‹k
();

57 
DEFINE_PER_CPU
(, 
ﬁd_r•
);

58 
DEFINE_PER_CPU
(, 
is_idÀ
);

60 
ATOMIC_NOTIFIER_HEAD
(
idÀ_nŸifõr
);

62 
	$idÀ_nŸifõr_ªgi°î
(
nŸifõr_block
 *
n
)

64 
	`©omic_nŸifõr_chaö_ªgi°î
(&
idÀ_nŸifõr
, 
n
);

65 
	}
}

66 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_ªgi°î
);

68 
	$idÀ_nŸifõr_uƒegi°î
(
nŸifõr_block
 *
n
)

70 
	`©omic_nŸifõr_chaö_uƒegi°î
(&
idÀ_nŸifõr
, 
n
);

71 
	}
}

72 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_uƒegi°î
);

74 
	$íãr_idÀ
()

76 
	`≥r˝u_wrôe
(
is_idÀ
, 1);

77 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_START
, 
NULL
);

78 
	}
}

80 
	$__exô_idÀ
()

82 i‡(
	`x86_ã°_™d_˛ór_bô_≥r˝u
(0, 
is_idÀ
) == 0)

84 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_END
, 
NULL
);

85 
	}
}

88 
	$exô_idÀ
()

91 i‡(
cuºít
->
pid
)

93 
	`__exô_idÀ
();

94 
	}
}

96 #i‚de‡
CONFIG_SMP


97 
ölöe
 
	$∂ay_dód
()

99 
	`BUG
();

100 
	}
}

109 
	$˝u_idÀ
()

111 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

120 
	`boŸ_öô_°ack_ˇ«ry
();

124 
	`tick_nohz_°›_sched_tick
(1);

125 !
	`√ed_ªsched
()) {

127 
	`rmb
();

129 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
()))

130 
	`∂ay_dód
();

136 
	`loˇl_úq_dißbÀ
();

137 
	`íãr_idÀ
();

139 
	`°›_¸ôiˇl_timögs
();

140 
	`pm_idÀ
();

141 
	`°¨t_¸ôiˇl_timögs
();

145 
	`__exô_idÀ
();

148 
	`tick_nohz_ª°¨t_sched_tick
();

149 
	`¥ìm±_íabÀ_no_ªsched
();

150 
	`scheduÀ
();

151 
	`¥ìm±_dißbÀ
();

153 
	}
}

156 
	$__show_ªgs
(
±_ªgs
 *
ªgs
, 
Æl
)

158 
¸0
 = 0L, 
¸2
 = 0L, 
¸3
 = 0L, 
¸4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

159 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

160 
fsödex
, 
gsödex
;

161 
ds
, 
cs
, 
es
;

163 
	`show_ªgs_comm⁄
();

164 
	`¥ötk
(
KERN_DEFAULT
 "RIP: %04lx:[<%016lx>] ", 
ªgs
->
cs
 & 0xffff,Ñegs->
ù
);

165 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

166 
	`¥ötk
(
KERN_DEFAULT
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
ªgs
->
ss
,

167 
ªgs
->
•
,Ñegs->
Êags
);

168 
	`¥ötk
(
KERN_DEFAULT
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

169 
ªgs
->
ax
,Ñegs->
bx
,Ñegs->
cx
);

170 
	`¥ötk
(
KERN_DEFAULT
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

171 
ªgs
->
dx
,Ñegs->
si
,Ñegs->
di
);

172 
	`¥ötk
(
KERN_DEFAULT
 "RBP: %016lx R08: %016lx R09: %016lx\n",

173 
ªgs
->
bp
,Ñegs->
r8
,Ñegs->
r9
);

174 
	`¥ötk
(
KERN_DEFAULT
 "R10: %016lx R11: %016lx R12: %016lx\n",

175 
ªgs
->
r10
,Ñegs->
r11
,Ñegs->
r12
);

176 
	`¥ötk
(
KERN_DEFAULT
 "R13: %016lx R14: %016lx R15: %016lx\n",

177 
ªgs
->
r13
,Ñegs->
r14
,Ñegs->
r15
);

179 
	`asm
("mov»%%ds,%0" : "Ù" (
ds
));

180 
	`asm
("mov»%%cs,%0" : "Ù" (
cs
));

181 
	`asm
("mov»%%es,%0" : "Ù" (
es
));

182 
	`asm
("mov»%%fs,%0" : "Ù" (
fsödex
));

183 
	`asm
("mov»%%gs,%0" : "Ù" (
gsödex
));

185 
	`rdm§l
(
MSR_FS_BASE
, 
fs
);

186 
	`rdm§l
(
MSR_GS_BASE
, 
gs
);

187 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

189 i‡(!
Æl
)

192 
¸0
 = 
	`ªad_¸0
();

193 
¸2
 = 
	`ªad_¸2
();

194 
¸3
 = 
	`ªad_¸3
();

195 
¸4
 = 
	`ªad_¸4
();

197 
	`¥ötk
(
KERN_DEFAULT
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

198 
fs
, 
fsödex
, 
gs
, 
gsödex
, 
shadowgs
);

199 
	`¥ötk
(
KERN_DEFAULT
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

200 
es
, 
¸0
);

201 
	`¥ötk
(
KERN_DEFAULT
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
¸2
, 
¸3
,

202 
¸4
);

204 
	`gë_debugªg
(
d0
, 0);

205 
	`gë_debugªg
(
d1
, 1);

206 
	`gë_debugªg
(
d2
, 2);

207 
	`¥ötk
(
KERN_DEFAULT
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

208 
	`gë_debugªg
(
d3
, 3);

209 
	`gë_debugªg
(
d6
, 6);

210 
	`gë_debugªg
(
d7
, 7);

211 
	`¥ötk
(
KERN_DEFAULT
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

212 
	}
}

214 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

216 
	`show_ªgi°îs
(
ªgs
);

217 
	`show_åa˚
(
NULL
, 
ªgs
, (*)‘eg†+ 1),Ñegs->
bp
);

218 
	}
}

220 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

222 i‡(
dód_èsk
->
mm
) {

223 i‡(
dód_èsk
->
mm
->
c⁄ãxt
.
size
) {

224 
	`¥ötk
("WARNING: deadÖrocess %8s still has LDT? <%p/%d>\n",

225 
dód_èsk
->
comm
,

226 
dód_èsk
->
mm
->
c⁄ãxt
.
ldt
,

227 
dód_èsk
->
mm
->
c⁄ãxt
.
size
);

228 
	`BUG
();

231 
	}
}

233 
ölöe
 
	$£t_32bô_és
(
èsk_°ru˘
 *
t
, 
és
, 
u32
 
addr
)

235 
u£r_desc
 
ud
 = {

236 .
ba£_addr
 = 
addr
,

237 .
limô
 = 0xfffff,

238 .
£g_32bô
 = 1,

239 .
limô_ö_∑ges
 = 1,

240 .
u£abÀ
 = 1,

242 
desc_°ru˘
 *
desc
 = 
t
->
thªad
.
és_¨øy
;

243 
desc
 +
és
;

244 
	`fûl_ldt
(
desc
, &
ud
);

245 
	}
}

247 
ölöe
 
u32
 
	$ªad_32bô_és
(
èsk_°ru˘
 *
t
, 
és
)

249  
	`gë_desc_ba£
(&
t
->
thªad
.
és_¨øy
[
és
]);

250 
	}
}

256 
	$¥ï¨e_to_c›y
(
èsk_°ru˘
 *
tsk
)

258 
	`u∆azy_Âu
(
tsk
);

259 
	}
}

261 
	$c›y_thªad
(
˛⁄e_Êags
, 
•
,

262 
unu£d
,

263 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

265 
îr
;

266 
±_ªgs
 *
chûdªgs
;

267 
èsk_°ru˘
 *
me
 = 
cuºít
;

269 
chûdªgs
 = ((
±_ªgs
 *)

270 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
p
))) - 1;

271 *
chûdªgs
 = *
ªgs
;

273 
chûdªgs
->
ax
 = 0;

274 i‡(
	`u£r_mode
(
ªgs
))

275 
chûdªgs
->
•
 = sp;

277 
chûdªgs
->
•
 = ()childregs;

279 
p
->
thªad
.
•
 = (Ë
chûdªgs
;

280 
p
->
thªad
.
•0
 = (Ë(
chûdªgs
+1);

281 
p
->
thªad
.
u£r•
 = 
me
->thread.usersp;

283 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_FORK
);

285 
p
->
thªad
.
fs
 = 
me
->thread.fs;

286 
p
->
thªad
.
gs
 = 
me
->thread.gs;

287 
p
->
thªad
.
io_bôm≠_±r
 = 
NULL
;

289 
	`ßve£gmít
(
gs
, 
p
->
thªad
.
gsödex
);

290 
	`ßve£gmít
(
fs
, 
p
->
thªad
.
fsödex
);

291 
	`ßve£gmít
(
es
, 
p
->
thªad
.es);

292 
	`ßve£gmít
(
ds
, 
p
->
thªad
.ds);

294 
îr
 = -
ENOMEM
;

295 
	`mem£t
(
p
->
thªad
.
±ø˚_bps
, 0, (p->thread.ptrace_bps));

297 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
me
, 
TIF_IO_BITMAP
))) {

298 
p
->
thªad
.
io_bôm≠_±r
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

299 i‡(!
p
->
thªad
.
io_bôm≠_±r
) {

300 
p
->
thªad
.
io_bôm≠_max
 = 0;

301  -
ENOMEM
;

303 
	`mem˝y
(
p
->
thªad
.
io_bôm≠_±r
, 
me
->thread.io_bitmap_ptr,

304 
IO_BITMAP_BYTES
);

305 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_IO_BITMAP
);

311 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
) {

312 #ifde‡
CONFIG_IA32_EMULATION


313 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

314 
îr
 = 
	`do_£t_thªad_¨ó
(
p
, -1,

315 (
u£r_desc
 
__u£r
 *)
chûdªgs
->
si
, 0);

318 
îr
 = 
	`do_¨ch_¥˘l
(
p
, 
ARCH_SET_FS
, 
chûdªgs
->
r8
);

319 i‡(
îr
)

320 
out
;

323 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DS_AREA_MSR
);

324 
p
->
thªad
.
ds_˘x
 = 
NULL
;

326 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DEBUGCTLMSR
);

327 
p
->
thªad
.
debug˘lm§
 = 0;

329 
îr
 = 0;

330 
out
:

331 i‡(
îr
 && 
p
->
thªad
.
io_bôm≠_±r
) {

332 
	`k‰ì
(
p
->
thªad
.
io_bôm≠_±r
);

333 
p
->
thªad
.
io_bôm≠_max
 = 0;

336  
îr
;

337 
	}
}

340 
	$°¨t_thªad_comm⁄
(
±_ªgs
 *
ªgs
, 
√w_ù
,

341 
√w_•
,

342 
_cs
, 
_ss
, 
_ds
)

344 
	`lﬂd£gmít
(
fs
, 0);

345 
	`lﬂd£gmít
(
es
, 
_ds
);

346 
	`lﬂd£gmít
(
ds
, 
_ds
);

347 
	`lﬂd_gs_ödex
(0);

348 
ªgs
->
ù
 = 
√w_ù
;

349 
ªgs
->
•
 = 
√w_•
;

350 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√w_•
);

351 
ªgs
->
cs
 = 
_cs
;

352 
ªgs
->
ss
 = 
_ss
;

353 
ªgs
->
Êags
 = 
X86_EFLAGS_IF
;

354 
	`£t_fs
(
USER_DS
);

358 
	`‰ì_thªad_x°©e
(
cuºít
);

359 
	}
}

362 
	$°¨t_thªad
(
±_ªgs
 *
ªgs
, 
√w_ù
, 
√w_•
)

364 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

365 
__USER_CS
, 
__USER_DS
, 0);

366 
	}
}

368 #ifde‡
CONFIG_IA32_EMULATION


369 
	$°¨t_thªad_ü32
(
±_ªgs
 *
ªgs
, 
u32
 
√w_ù
, u32 
√w_•
)

371 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

372 
__USER32_CS
, 
__USER32_DS
, __USER32_DS);

373 
	}
}

386 
__nŸø˚_funcgøph
 
èsk_°ru˘
 *

387 
	$__swôch_to
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
)

389 
thªad_°ru˘
 *
¥ev
 = &
¥ev_p
->
thªad
;

390 
thªad_°ru˘
 *
√xt
 = &
√xt_p
->
thªad
;

391 
˝u
 = 
	`smp_¥o˚ss‹_id
();

392 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

393 
fsödex
, 
gsödex
;

394 
boﬁ
 
¥ñﬂd_Âu
;

401 
¥ñﬂd_Âu
 = 
	`tsk_u£d_m©h
(
√xt_p
Ë&&Çext_p->
Âu_cou¡î
 > 5;

404 i‡(
¥ñﬂd_Âu
)

405 
	`¥e„tch
(
√xt
->
x°©e
);

410 
	`lﬂd_•0
(
tss
, 
√xt
);

416 
	`ßve£gmít
(
es
, 
¥ev
->es);

417 i‡(
	`u∆ikñy
(
√xt
->
es
 | 
¥ev
->es))

418 
	`lﬂd£gmít
(
es
, 
√xt
->es);

420 
	`ßve£gmít
(
ds
, 
¥ev
->ds);

421 i‡(
	`u∆ikñy
(
√xt
->
ds
 | 
¥ev
->ds))

422 
	`lﬂd£gmít
(
ds
, 
√xt
->ds);

430 
	`ßve£gmít
(
fs
, 
fsödex
);

431 
	`ßve£gmít
(
gs
, 
gsödex
);

433 
	`lﬂd_TLS
(
√xt
, 
˝u
);

436 
	`u∆azy_Âu
(
¥ev_p
);

439 i‡(
¥ñﬂd_Âu
)

440 
	`˛ts
();

449 
	`¨ch_íd_c⁄ãxt_swôch
(
√xt_p
);

458 i‡(
	`u∆ikñy
(
fsödex
 | 
√xt
->fsödex | 
¥ev
->
fs
)) {

459 
	`lﬂd£gmít
(
fs
, 
√xt
->
fsödex
);

465 i‡(
fsödex
)

466 
¥ev
->
fs
 = 0;

469 i‡(
√xt
->
fs
)

470 
	`wrm§l
(
MSR_FS_BASE
, 
√xt
->
fs
);

471 
¥ev
->
fsödex
 = fsindex;

473 i‡(
	`u∆ikñy
(
gsödex
 | 
√xt
->gsödex | 
¥ev
->
gs
)) {

474 
	`lﬂd_gs_ödex
(
√xt
->
gsödex
);

475 i‡(
gsödex
)

476 
¥ev
->
gs
 = 0;

478 i‡(
√xt
->
gs
)

479 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 
√xt
->
gs
);

480 
¥ev
->
gsödex
 = gsindex;

485 
¥ev
->
u£r•
 = 
	`≥r˝u_ªad
(
ﬁd_r•
);

486 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√xt
->
u£r•
);

487 
	`≥r˝u_wrôe
(
cuºít_èsk
, 
√xt_p
);

489 
	`≥r˝u_wrôe
(
kî√l_°ack
,

490 ()
	`èsk_°ack_∑ge
(
√xt_p
) +

491 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

496 i‡(
	`u∆ikñy
(
	`èsk_thªad_öfo
(
√xt_p
)->
Êags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

497 
	`èsk_thªad_öfo
(
¥ev_p
)->
Êags
 & 
_TIF_WORK_CTXSW_PREV
))

498 
	`__swôch_to_xåa
(
¥ev_p
, 
√xt_p
, 
tss
);

504 i‡(
¥ñﬂd_Âu
)

505 
	`__m©h_°©e_ª°‹e
();

507  
¥ev_p
;

508 
	}
}

510 
	$£t_≥rs⁄Æôy_64bô
()

515 
	`˛ór_thªad_Êag
(
TIF_IA32
);

521 
cuºít
->
≥rs⁄Æôy
 &~
READ_IMPLIES_EXEC
;

522 
	}
}

524 
	$£t_≥rs⁄Æôy_ü32
()

529 
	`£t_thªad_Êag
(
TIF_IA32
);

530 
cuºít
->
≥rs⁄Æôy
 |
f‹˚_≥rs⁄Æôy32
;

533 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_COMPAT
;

534 
	}
}

536 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

538 
°ack
;

539 
u64
 
Â
, 
ù
;

540 
cou¡
 = 0;

542 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

544 
°ack
 = ()
	`èsk_°ack_∑ge
(
p
);

545 i‡(
p
->
thªad
.
•
 < 
°ack
 ||Ö->thªad.• >°ack+
THREAD_SIZE
)

547 
Â
 = *(
u64
 *)(
p
->
thªad
.
•
);

549 i‡(
Â
 < ()
°ack
 ||

550 
Â
 >()
°ack
+
THREAD_SIZE
)

552 
ù
 = *(
u64
 *)(
Â
+8);

553 i‡(!
	`ö_sched_fun˘i⁄s
(
ù
))

554  
ù
;

555 
Â
 = *(
u64
 *)fp;

556 } 
cou¡
++ < 16);

558 
	}
}

560 
	$do_¨ch_¥˘l
(
èsk_°ru˘
 *
èsk
, 
code
, 
addr
)

562 
ªt
 = 0;

563 
doô
 = 
èsk
 =
cuºít
;

564 
˝u
;

566 
code
) {

567 
ARCH_SET_GS
:

568 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

569  -
EPERM
;

570 
˝u
 = 
	`gë_˝u
();

573 i‡(
addr
 <= 0xffffffff) {

574 
	`£t_32bô_és
(
èsk
, 
GS_TLS
, 
addr
);

575 i‡(
doô
) {

576 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

577 
	`lﬂd_gs_ödex
(
GS_TLS_SEL
);

579 
èsk
->
thªad
.
gsödex
 = 
GS_TLS_SEL
;

580 
èsk
->
thªad
.
gs
 = 0;

582 
èsk
->
thªad
.
gsödex
 = 0;

583 
èsk
->
thªad
.
gs
 = 
addr
;

584 i‡(
doô
) {

585 
	`lﬂd_gs_ödex
(0);

586 
ªt
 = 
	`checkög_wrm§l
(
MSR_KERNEL_GS_BASE
, 
addr
);

589 
	`put_˝u
();

591 
ARCH_SET_FS
:

594 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

595  -
EPERM
;

596 
˝u
 = 
	`gë_˝u
();

599 i‡(
addr
 <= 0xffffffff) {

600 
	`£t_32bô_és
(
èsk
, 
FS_TLS
, 
addr
);

601 i‡(
doô
) {

602 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

603 
	`lﬂd£gmít
(
fs
, 
FS_TLS_SEL
);

605 
èsk
->
thªad
.
fsödex
 = 
FS_TLS_SEL
;

606 
èsk
->
thªad
.
fs
 = 0;

608 
èsk
->
thªad
.
fsödex
 = 0;

609 
èsk
->
thªad
.
fs
 = 
addr
;

610 i‡(
doô
) {

613 
	`lﬂd£gmít
(
fs
, 0);

614 
ªt
 = 
	`checkög_wrm§l
(
MSR_FS_BASE
, 
addr
);

617 
	`put_˝u
();

619 
ARCH_GET_FS
: {

620 
ba£
;

621 i‡(
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
)

622 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
FS_TLS
);

623 i‡(
doô
)

624 
	`rdm§l
(
MSR_FS_BASE
, 
ba£
);

626 
ba£
 = 
èsk
->
thªad
.
fs
;

627 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

630 
ARCH_GET_GS
: {

631 
ba£
;

632 
gsödex
;

633 i‡(
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
)

634 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
GS_TLS
);

635 i‡(
doô
) {

636 
	`ßve£gmít
(
gs
, 
gsödex
);

637 i‡(
gsödex
)

638 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

640 
ba£
 = 
èsk
->
thªad
.
gs
;

642 
ba£
 = 
èsk
->
thªad
.
gs
;

643 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

648 
ªt
 = -
EINVAL
;

652  
ªt
;

653 
	}
}

655 
	$sys_¨ch_¥˘l
(
code
, 
addr
)

657  
	`do_¨ch_¥˘l
(
cuºít
, 
code
, 
addr
);

658 
	}
}

660 
	$KSTK_ESP
(
èsk_°ru˘
 *
èsk
)

662  (
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
)) ?

663 (
	`èsk_±_ªgs
(
èsk
)->
•
Ë: (—ask)->
thªad
.
u£r•
);

664 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/ªg£t.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/u£r.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/£curôy.h
>

21 
	~<löux/audô.h
>

22 
	~<löux/£ccomp.h
>

23 
	~<löux/sig«l.h
>

24 
	~<löux/w‹kqueue.h
>

25 
	~<löux/≥rf_evít.h
>

26 
	~<löux/hw_bªakpoöt.h
>

28 
	~<asm/uac˚ss.h
>

29 
	~<asm/pgèbÀ.h
>

30 
	~<asm/sy°em.h
>

31 
	~<asm/¥o˚ss‹.h
>

32 
	~<asm/i387.h
>

33 
	~<asm/debugªg.h
>

34 
	~<asm/ldt.h
>

35 
	~<asm/desc.h
>

36 
	~<asm/¥˘l.h
>

37 
	~<asm/¥Ÿo.h
>

38 
	~<asm/ds.h
>

39 
	~<asm/hw_bªakpoöt.h
>

41 
	~"és.h
"

43 
	#CREATE_TRACE_POINTS


	)

44 
	~<åa˚/evíts/sysˇŒs.h
>

46 
	ex86_ªg£t
 {

47 
	mREGSET_GENERAL
,

48 
	mREGSET_FP
,

49 
	mREGSET_XFP
,

50 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

51 
	mREGSET_TLS
,

52 
	mREGSET_IOPERM32
,

55 
	s±_ªgs_off£t
 {

56 c⁄° *
	m«me
;

57 
	moff£t
;

60 
	#REG_OFFSET_NAME
(
r
Ë{.
«me
 = #r, .
off£t
 = 
	`off£tof
(
±_ªgs
,Ñ)}

	)

61 
	#REG_OFFSET_END
 {.
«me
 = 
NULL
, .
off£t
 = 0}

	)

63 c⁄° 
±_ªgs_off£t
 
	gªgoff£t_èbÀ
[] = {

64 #ifde‡
CONFIG_X86_64


65 
REG_OFFSET_NAME
(
r15
),

66 
REG_OFFSET_NAME
(
r14
),

67 
REG_OFFSET_NAME
(
r13
),

68 
REG_OFFSET_NAME
(
r12
),

69 
REG_OFFSET_NAME
(
r11
),

70 
REG_OFFSET_NAME
(
r10
),

71 
REG_OFFSET_NAME
(
r9
),

72 
REG_OFFSET_NAME
(
r8
),

74 
REG_OFFSET_NAME
(
bx
),

75 
REG_OFFSET_NAME
(
cx
),

76 
REG_OFFSET_NAME
(
dx
),

77 
REG_OFFSET_NAME
(
si
),

78 
REG_OFFSET_NAME
(
di
),

79 
REG_OFFSET_NAME
(
bp
),

80 
REG_OFFSET_NAME
(
ax
),

81 #ifde‡
CONFIG_X86_32


82 
REG_OFFSET_NAME
(
ds
),

83 
REG_OFFSET_NAME
(
es
),

84 
REG_OFFSET_NAME
(
fs
),

85 
REG_OFFSET_NAME
(
gs
),

87 
REG_OFFSET_NAME
(
‹ig_ax
),

88 
REG_OFFSET_NAME
(
ù
),

89 
REG_OFFSET_NAME
(
cs
),

90 
REG_OFFSET_NAME
(
Êags
),

91 
REG_OFFSET_NAME
(
•
),

92 
REG_OFFSET_NAME
(
ss
),

93 
REG_OFFSET_END
,

103 
	$ªgs_quîy_ªgi°î_off£t
(c⁄° *
«me
)

105 c⁄° 
±_ªgs_off£t
 *
roff
;

106 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

107 i‡(!
	`°rcmp
(
roff
->
«me
,Çame))

108  
roff
->
off£t
;

109  -
EINVAL
;

110 
	}
}

119 c⁄° *
	$ªgs_quîy_ªgi°î_«me
(
off£t
)

121 c⁄° 
±_ªgs_off£t
 *
roff
;

122 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

123 i‡(
roff
->
off£t
 == offset)

124  
roff
->
«me
;

125  
NULL
;

126 
	}
}

128 c⁄° 
	g¨g_offs_èbÀ
[] = {

129 #ifde‡
CONFIG_X86_32


130 [0] = 
off£tof
(
±_ªgs
, 
ax
),

131 [1] = 
off£tof
(
±_ªgs
, 
dx
),

132 [2] = 
off£tof
(
±_ªgs
, 
cx
)

134 [0] = 
off£tof
(
±_ªgs
, 
di
),

135 [1] = 
off£tof
(
±_ªgs
, 
si
),

136 [2] = 
off£tof
(
±_ªgs
, 
dx
),

137 [3] = 
off£tof
(
±_ªgs
, 
cx
),

138 [4] = 
off£tof
(
±_ªgs
, 
r8
),

139 [5] = 
off£tof
(
±_ªgs
, 
r9
)

153 
	$ªgs_gë_¨gumít_¡h
(
±_ªgs
 *
ªgs
, 
n
)

155 i‡(
n
 < 
	`ARRAY_SIZE
(
¨g_offs_èbÀ
))

156  *(*)((*)
ªgs
 + 
¨g_offs_èbÀ
[
n
]);

162 
n
 -
	`ARRAY_SIZE
(
¨g_offs_èbÀ
);

163  
	`ªgs_gë_kî√l_°ack_¡h
(
ªgs
, 1 + 
n
);

165 
	}
}

175 
	#FLAG_MASK_32
 (() \

176 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

177 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

178 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

179 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

180 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

185 
ölöe
 
boﬁ
 
	$övÆid_£À˘‹
(
u16
 
vÆue
)

187  
	`u∆ikñy
(
vÆue
 !0 && (vÆuê& 
SEGMENT_RPL_MASK
Ë!
USER_RPL
);

188 
	}
}

190 #ifde‡
CONFIG_X86_32


192 
	#FLAG_MASK
 
FLAG_MASK_32


	)

194 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
ªgno
)

196 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
bx
) != 0);

197  &
ªgs
->
bx
 + (
ªgno
 >> 2);

198 
	}
}

200 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

205 
ªtvÆ
;

206 i‡(
off£t
 !
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
))

207 
ªtvÆ
 = *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

209 i‡(
èsk
 =
cuºít
)

210 
ªtvÆ
 = 
	`gë_u£r_gs
(
	`èsk_±_ªgs
(
èsk
));

212 
ªtvÆ
 = 
	`èsk_u£r_gs
(
èsk
);

214  
ªtvÆ
;

215 
	}
}

217 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

218 
off£t
, 
u16
 
vÆue
)

223 i‡(
	`övÆid_£À˘‹
(
vÆue
))

224  -
EIO
;

235 
off£t
) {

236 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

237 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

238 i‡(
	`u∆ikñy
(
vÆue
 == 0))

239  -
EIO
;

242 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
Ë
vÆue
;

245 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

246 i‡(
èsk
 =
cuºít
)

247 
	`£t_u£r_gs
(
	`èsk_±_ªgs
(
èsk
), 
vÆue
);

249 
	`èsk_u£r_gs
(
èsk
Ë
vÆue
;

253 
	}
}

257 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

259 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
off£t
)

261 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
r15
) != 0);

262  &
ªgs
->
r15
 + (
off£t
 / (regs->r15));

263 
	}
}

265 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

270 
£g
;

272 
off£t
) {

273 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

274 i‡(
èsk
 =
cuºít
) {

276 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

277  
£g
;

279  
èsk
->
thªad
.
fsödex
;

280 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

281 i‡(
èsk
 =
cuºít
) {

282 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

283  
£g
;

285  
èsk
->
thªad
.
gsödex
;

286 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

287 i‡(
èsk
 =
cuºít
) {

288 
	`asm
("mov»%%ds,%0" : "Ù" (
£g
));

289  
£g
;

291  
èsk
->
thªad
.
ds
;

292 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

293 i‡(
èsk
 =
cuºít
) {

294 
	`asm
("mov»%%es,%0" : "Ù" (
£g
));

295  
£g
;

297  
èsk
->
thªad
.
es
;

299 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

300 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

303  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

304 
	}
}

306 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

307 
off£t
, 
u16
 
vÆue
)

312 i‡(
	`övÆid_£À˘‹
(
vÆue
))

313  -
EIO
;

315 
off£t
) {

316 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs
):

321 i‡((
vÆue
 =
FS_TLS_SEL
 && 
èsk
->
thªad
.
fsödex
 == 0 &&

322 
èsk
->
thªad
.
fs
 != 0) ||

323 (
vÆue
 =0 && 
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
 &&

324 
èsk
->
thªad
.
fs
 == 0))

326 
èsk
->
thªad
.
fsödex
 = 
vÆue
;

327 i‡(
èsk
 =
cuºít
)

328 
	`lﬂd£gmít
(
fs
, 
èsk
->
thªad
.
fsödex
);

330 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs
):

335 i‡((
vÆue
 =
GS_TLS_SEL
 && 
èsk
->
thªad
.
gsödex
 == 0 &&

336 
èsk
->
thªad
.
gs
 != 0) ||

337 (
vÆue
 =0 && 
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
 &&

338 
èsk
->
thªad
.
gs
 == 0))

340 
èsk
->
thªad
.
gsödex
 = 
vÆue
;

341 i‡(
èsk
 =
cuºít
)

342 
	`lﬂd_gs_ödex
(
èsk
->
thªad
.
gsödex
);

344 
	`off£tof
(
u£r_ªgs_°ru˘
,
ds
):

345 
èsk
->
thªad
.
ds
 = 
vÆue
;

346 i‡(
èsk
 =
cuºít
)

347 
	`lﬂd£gmít
(
ds
, 
èsk
->
thªad
.ds);

349 
	`off£tof
(
u£r_ªgs_°ru˘
,
es
):

350 
èsk
->
thªad
.
es
 = 
vÆue
;

351 i‡(
èsk
 =
cuºít
)

352 
	`lﬂd£gmít
(
es
, 
èsk
->
thªad
.es);

358 
	`off£tof
(
u£r_ªgs_°ru˘
,
cs
):

359 i‡(
	`u∆ikñy
(
vÆue
 == 0))

360  -
EIO
;

361 #ifde‡
CONFIG_IA32_EMULATION


362 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

363 
	`èsk_±_ªgs
(
èsk
)->
cs
 = 
vÆue
;

366 
	`off£tof
(
u£r_ªgs_°ru˘
,
ss
):

367 i‡(
	`u∆ikñy
(
vÆue
 == 0))

368  -
EIO
;

369 #ifde‡
CONFIG_IA32_EMULATION


370 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

371 
	`èsk_±_ªgs
(
èsk
)->
ss
 = 
vÆue
;

377 
	}
}

381 
	$gë_Êags
(
èsk_°ru˘
 *
èsk
)

383 
ªtvÆ
 = 
	`èsk_±_ªgs
(
èsk
)->
Êags
;

388 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

389 
ªtvÆ
 &~
X86_EFLAGS_TF
;

391  
ªtvÆ
;

392 
	}
}

394 
	$£t_Êags
(
èsk_°ru˘
 *
èsk
, 
vÆue
)

396 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

403 i‡(
vÆue
 & 
X86_EFLAGS_TF
)

404 
	`˛ór_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
);

405 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

406 
vÆue
 |
X86_EFLAGS_TF
;

408 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FLAG_MASK
Ë| (
vÆue
 & FLAG_MASK);

411 
	}
}

413 
	$puåeg
(
èsk_°ru˘
 *
chûd
,

414 
off£t
, 
vÆue
)

416 
off£t
) {

417 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

418 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

419 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

420 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

421 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

422 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

423  
	`£t_£gmít_ªg
(
chûd
, 
off£t
, 
vÆue
);

425 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

426  
	`£t_Êags
(
chûd
, 
vÆue
);

428 #ifde‡
CONFIG_X86_64


429 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs_ba£
):

430 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

431  -
EIO
;

437 i‡(
chûd
->
thªad
.
fs
 !
vÆue
)

438  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_FS
, 
vÆue
);

440 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs_ba£
):

444 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

445  -
EIO
;

446 i‡(
chûd
->
thªad
.
gs
 !
vÆue
)

447  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_GS
, 
vÆue
);

452 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
chûd
), 
off£t
Ë
vÆue
;

454 
	}
}

456 
	$gëªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

458 
off£t
) {

459 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

460 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

461 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

462 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

463 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

464 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

465  
	`gë_£gmít_ªg
(
èsk
, 
off£t
);

467 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

468  
	`gë_Êags
(
èsk
);

470 #ifde‡
CONFIG_X86_64


471 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs_ba£
): {

477 
£g
 = 
èsk
->
thªad
.
fsödex
;

478 i‡(
èsk
->
thªad
.
fs
 != 0)

479  
èsk
->
thªad
.
fs
;

480 i‡(
èsk
 =
cuºít
)

481 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

482 i‡(
£g
 !
FS_TLS_SEL
)

484  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
FS_TLS
]);

486 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs_ba£
): {

490 
£g
 = 
èsk
->
thªad
.
gsödex
;

491 i‡(
èsk
->
thªad
.
gs
 != 0)

492  
èsk
->
thªad
.
gs
;

493 i‡(
èsk
 =
cuºít
)

494 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

495 i‡(
£g
 !
GS_TLS_SEL
)

497  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
GS_TLS
]);

502  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

503 
	}
}

505 
	$gíªgs_gë
(
èsk_°ru˘
 *
èrgë
,

506 c⁄° 
u£r_ªg£t
 *
ªg£t
,

507 
pos
, 
cou¡
,

508 *
kbuf
, 
__u£r
 *
ubuf
)

510 i‡(
kbuf
) {

511 *
k
 = 
kbuf
;

512 
cou¡
 >(*
k
)) {

513 *
k
++ = 
	`gëªg
(
èrgë
, 
pos
);

514 
cou¡
 -(*
k
);

515 
pos
 +(*
k
);

518 
__u£r
 *
u
 = 
ubuf
;

519 
cou¡
 >(*
u
)) {

520 i‡(
	`__put_u£r
(
	`gëªg
(
èrgë
, 
pos
), 
u
++))

521  -
EFAULT
;

522 
cou¡
 -(*
u
);

523 
pos
 +(*
u
);

528 
	}
}

530 
	$gíªgs_£t
(
èsk_°ru˘
 *
èrgë
,

531 c⁄° 
u£r_ªg£t
 *
ªg£t
,

532 
pos
, 
cou¡
,

533 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

535 
ªt
 = 0;

536 i‡(
kbuf
) {

537 c⁄° *
k
 = 
kbuf
;

538 
cou¡
 >(*
k
Ë&& !
ªt
) {

539 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, *
k
++);

540 
cou¡
 -(*
k
);

541 
pos
 +(*
k
);

544 c⁄° 
__u£r
 *
u
 = 
ubuf
;

545 
cou¡
 >(*
u
Ë&& !
ªt
) {

546 
w‹d
;

547 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

548 i‡(
ªt
)

550 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, 
w‹d
);

551 
cou¡
 -(*
u
);

552 
pos
 +(*
u
);

555  
ªt
;

556 
	}
}

558 
	$±ø˚_åiggîed
(
≥rf_evít
 *
bp
, 
nmi
,

559 
≥rf_ßm∂e_d©a
 *
d©a
,

560 
±_ªgs
 *
ªgs
)

562 
i
;

563 
thªad_°ru˘
 *
thªad
 = &(
cuºít
->thread);

569 
i
 = 0; i < 
HBP_NUM
; i++) {

570 i‡(
thªad
->
±ø˚_bps
[
i
] =
bp
)

574 
thªad
->
debugªg6
 |(
DR_TRAP0
 << 
i
);

575 
	}
}

582 
	$±ø˚_gë_dr7
(
≥rf_evít
 *
bp
[])

584 
i
;

585 
dr7
 = 0;

586 
¨ch_hw_bªakpoöt
 *
öfo
;

588 
i
 = 0; i < 
HBP_NUM
; i++) {

589 i‡(
bp
[
i
] && !bp[i]->
©å
.
dißbÀd
) {

590 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
[
i
]);

591 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

595  
dr7
;

596 
	}
}

599 
	$±ø˚_modify_bªakpoöt
(
≥rf_evít
 *
bp
, 
Àn
, 
ty≥
,

600 
èsk_°ru˘
 *
tsk
, 
dißbÀd
)

602 
îr
;

603 
gí_Àn
, 
gí_ty≥
;

604 
≥rf_evít_©å
 
©å
;

611 i‡(!
bp
)

612  -
EINVAL
;

614 
îr
 = 
	`¨ch_bp_gíîic_fõlds
(
Àn
, 
ty≥
, &
gí_Àn
, &
gí_ty≥
);

615 i‡(
îr
)

616  
îr
;

618 
©å
 = 
bp
->attr;

619 
©å
.
bp_Àn
 = 
gí_Àn
;

620 
©å
.
bp_ty≥
 = 
gí_ty≥
;

621 
©å
.
dißbÀd
 = disabled;

623  
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

624 
	}
}

629 
	$±ø˚_wrôe_dr7
(
èsk_°ru˘
 *
tsk
, 
d©a
)

631 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

632 
ﬁd_dr7
;

633 
i
, 
‹ig_ªt
 = 0, 
rc
 = 0;

634 
íabÀd
, 
£c⁄d_∑ss
 = 0;

635 
Àn
, 
ty≥
;

636 
≥rf_evít
 *
bp
;

638 
d©a
 &~
DR_CONTROL_RESERVED
;

639 
ﬁd_dr7
 = 
	`±ø˚_gë_dr7
(
thªad
->
±ø˚_bps
);

640 
ª°‹e
:

645 
i
 = 0; i < 
HBP_NUM
; i++) {

646 
íabÀd
 = 
	`decode_dr7
(
d©a
, 
i
, &
Àn
, &
ty≥
);

647 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

649 i‡(!
íabÀd
) {

650 i‡(
bp
) {

658 i‡(!
£c⁄d_∑ss
)

661 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
,

662 
tsk
, 1);

663 i‡(
rc
)

669 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
, 
tsk
, 0);

670 i‡(
rc
)

677 i‡(!
£c⁄d_∑ss
) {

678 
£c⁄d_∑ss
 = 1;

679 i‡(
rc
 < 0) {

680 
‹ig_ªt
 = 
rc
;

681 
d©a
 = 
ﬁd_dr7
;

683 
ª°‹e
;

685  ((
‹ig_ªt
 < 0Ë? orig_ªà: 
rc
);

686 
	}
}

691 
	$±ø˚_gë_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
)

693 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

694 
vÆ
 = 0;

696 i‡(
n
 < 
HBP_NUM
) {

697 
≥rf_evít
 *
bp
;

698 
bp
 = 
thªad
->
±ø˚_bps
[
n
];

699 i‡(!
bp
)

701 
vÆ
 = 
bp
->
hw
.
öfo
.
addªss
;

702 } i‡(
n
 == 6) {

703 
vÆ
 = 
thªad
->
debugªg6
;

704 } i‡(
n
 == 7) {

705 
vÆ
 = 
thªad
->
±ø˚_dr7
;

707  
vÆ
;

708 
	}
}

710 
	$±ø˚_£t_bªakpoöt_addr
(
èsk_°ru˘
 *
tsk
, 
ƒ
,

711 
addr
)

713 
≥rf_evít
 *
bp
;

714 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

715 
≥rf_evít_©å
 
©å
;

717 i‡(!
t
->
±ø˚_bps
[
ƒ
]) {

718 
	`hw_bªakpoöt_öô
(&
©å
);

723 
©å
.
bp_addr
 = 
addr
;

724 
©å
.
bp_Àn
 = 
HW_BREAKPOINT_LEN_1
;

725 
©å
.
bp_ty≥
 = 
HW_BREAKPOINT_W
;

726 
©å
.
dißbÀd
 = 1;

728 
bp
 = 
	`ªgi°î_u£r_hw_bªakpoöt
(&
©å
, 
±ø˚_åiggîed
, 
tsk
);

739 i‡(
	`IS_ERR
(
bp
))

740  
	`PTR_ERR
(
bp
);

742 
t
->
±ø˚_bps
[
ƒ
] = 
bp
;

744 
îr
;

746 
bp
 = 
t
->
±ø˚_bps
[
ƒ
];

748 
©å
 = 
bp
->attr;

749 
©å
.
bp_addr
 = 
addr
;

750 
îr
 = 
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

751 i‡(
îr
)

752  
îr
;

757 
	}
}

762 
	$±ø˚_£t_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
, 
vÆ
)

764 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

765 
rc
 = 0;

768 i‡(
n
 == 4 ||Ç == 5)

769  -
EIO
;

771 i‡(
n
 == 6) {

772 
thªad
->
debugªg6
 = 
vÆ
;

773 
ªt_∑th
;

775 i‡(
n
 < 
HBP_NUM
) {

776 
rc
 = 
	`±ø˚_£t_bªakpoöt_addr
(
tsk
, 
n
, 
vÆ
);

777 i‡(
rc
)

778  
rc
;

781 i‡(
n
 == 7) {

782 
rc
 = 
	`±ø˚_wrôe_dr7
(
tsk
, 
vÆ
);

783 i‡(!
rc
)

784 
thªad
->
±ø˚_dr7
 = 
vÆ
;

787 
ªt_∑th
:

788  
rc
;

789 
	}
}

795 
	$i›îm_a˘ive
(
èsk_°ru˘
 *
èrgë
,

796 c⁄° 
u£r_ªg£t
 *
ªg£t
)

798  
èrgë
->
thªad
.
io_bôm≠_max
 / 
ªg£t
->
size
;

799 
	}
}

801 
	$i›îm_gë
(
èsk_°ru˘
 *
èrgë
,

802 c⁄° 
u£r_ªg£t
 *
ªg£t
,

803 
pos
, 
cou¡
,

804 *
kbuf
, 
__u£r
 *
ubuf
)

806 i‡(!
èrgë
->
thªad
.
io_bôm≠_±r
)

807  -
ENXIO
;

809  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

810 
èrgë
->
thªad
.
io_bôm≠_±r
,

811 0, 
IO_BITMAP_BYTES
);

812 
	}
}

814 #ifde‡
CONFIG_X86_PTRACE_BTS


832 
	sbts_c⁄ãxt
 {

834 
bts_åa˚r
 *
	måa˚r
;

837 *
	mbuf„r
;

838 
	msize
;

841 
mm_°ru˘
 *
	mmm
;

844 
èsk_°ru˘
 *
	mèsk
;

847 
	mbts_ovÊ_sig«l
;

850 
w‹k_°ru˘
 
	mw‹k
;

853 
	$Æloc_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
, 
size
)

855 *
buf„r
 = 
NULL
;

856 
îr
 = -
ENOMEM
;

858 
îr
 = 
	`accou¡_locked_mem‹y
(
cuºít
->
mm
, cuºít->
sig«l
->
æim
, 
size
);

859 i‡(
îr
 < 0)

860  
îr
;

862 
buf„r
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

863 i‡(!
buf„r
)

864 
out_ªfund
;

866 
c⁄ãxt
->
buf„r
 = buffer;

867 
c⁄ãxt
->
size
 = size;

868 
c⁄ãxt
->
mm
 = 
	`gë_èsk_mm
(
cuºít
);

872 
out_ªfund
:

873 
	`ªfund_locked_mem‹y
(
cuºít
->
mm
, 
size
);

874  
îr
;

875 
	}
}

877 
ölöe
 
	$‰ì_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
)

879 i‡(!
c⁄ãxt
->
buf„r
)

882 
	`k‰ì
(
c⁄ãxt
->
buf„r
);

883 
c⁄ãxt
->
buf„r
 = 
NULL
;

885 
	`ªfund_locked_mem‹y
(
c⁄ãxt
->
mm
, c⁄ãxt->
size
);

886 
c⁄ãxt
->
size
 = 0;

888 
	`mmput
(
c⁄ãxt
->
mm
);

889 
c⁄ãxt
->
mm
 = 
NULL
;

890 
	}
}

892 
	$‰ì_bts_c⁄ãxt_w‹k
(
w‹k_°ru˘
 *
w
)

894 
bts_c⁄ãxt
 *
c⁄ãxt
;

896 
c⁄ãxt
 = 
	`c⁄èöî_of
(
w
, 
bts_c⁄ãxt
, 
w‹k
);

898 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

899 
	`put_èsk_°ru˘
(
c⁄ãxt
->
èsk
);

900 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

901 
	`k‰ì
(
c⁄ãxt
);

902 
	}
}

904 
ölöe
 
	$‰ì_bts_c⁄ãxt
(
bts_c⁄ãxt
 *
c⁄ãxt
)

906 
	`INIT_WORK
(&
c⁄ãxt
->
w‹k
, 
‰ì_bts_c⁄ãxt_w‹k
);

907 
	`scheduÀ_w‹k
(&
c⁄ãxt
->
w‹k
);

908 
	}
}

910 
ölöe
 
bts_c⁄ãxt
 *
	$Æloc_bts_c⁄ãxt
(
èsk_°ru˘
 *
èsk
)

912 
bts_c⁄ãxt
 *
c⁄ãxt
 = 
	`kzÆloc
((*c⁄ãxt), 
GFP_KERNEL
);

913 i‡(
c⁄ãxt
) {

914 
c⁄ãxt
->
èsk
 =Åask;

915 
èsk
->
bts
 = 
c⁄ãxt
;

917 
	`gë_èsk_°ru˘
(
èsk
);

920  
c⁄ãxt
;

921 
	}
}

923 
	$±ø˚_bts_ªad_ªc‹d
(
èsk_°ru˘
 *
chûd
, 
size_t
 
ödex
,

924 
bts_°ru˘
 
__u£r
 *
out
)

926 
bts_c⁄ãxt
 *
c⁄ãxt
;

927 c⁄° 
bts_åa˚
 *
åa˚
;

928 
bts_°ru˘
 
bts
;

929 c⁄° *
©
;

930 
îr‹
;

932 
c⁄ãxt
 = 
chûd
->
bts
;

933 i‡(!
c⁄ãxt
)

934  -
ESRCH
;

936 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

937 i‡(!
åa˚
)

938  -
ESRCH
;

940 
©
 = 
åa˚
->
ds
.
t›
 - ((
ödex
 + 1Ë*Åø˚->ds.
size
);

941 i‡((*)
©
 < 
åa˚
->
ds
.
begö
)

942 
©
 +(
åa˚
->
ds
.
n
 *Åø˚->ds.
size
);

944 i‡(!
åa˚
->
ªad
)

945  -
EOPNOTSUPP
;

947 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

948 i‡(
îr‹
 < 0)

949  
îr‹
;

951 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

952  -
EFAULT
;

954  (
bts
);

955 
	}
}

957 
	$±ø˚_bts_døö
(
èsk_°ru˘
 *
chûd
,

958 
size
,

959 
bts_°ru˘
 
__u£r
 *
out
)

961 
bts_c⁄ãxt
 *
c⁄ãxt
;

962 c⁄° 
bts_åa˚
 *
åa˚
;

963 c⁄° *
©
;

964 
îr‹
, 
døöed
 = 0;

966 
c⁄ãxt
 = 
chûd
->
bts
;

967 i‡(!
c⁄ãxt
)

968  -
ESRCH
;

970 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

971 i‡(!
åa˚
)

972  -
ESRCH
;

974 i‡(!
åa˚
->
ªad
)

975  -
EOPNOTSUPP
;

977 i‡(
size
 < (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
))

978  -
EIO
;

980 
©
 = 
åa˚
->
ds
.
begö
; (*Ôà<Åø˚->ds.
t›
;

981 
out
++, 
døöed
++, 
©
 +
åa˚
->
ds
.
size
) {

982 
bts_°ru˘
 
bts
;

984 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

985 i‡(
îr‹
 < 0)

986  
îr‹
;

988 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

989  -
EFAULT
;

992 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

994 
îr‹
 = 
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

995 i‡(
îr‹
 < 0)

996  
îr‹
;

998  
døöed
;

999 
	}
}

1001 
	$±ø˚_bts_c⁄fig
(
èsk_°ru˘
 *
chûd
,

1002 
cfg_size
,

1003 c⁄° 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

1005 
bts_c⁄ãxt
 *
c⁄ãxt
;

1006 
±ø˚_bts_c⁄fig
 
cfg
;

1007 
Êags
 = 0;

1009 i‡(
cfg_size
 < (
cfg
))

1010  -
EIO
;

1012 i‡(
	`c›y_‰om_u£r
(&
cfg
, 
ucfg
, (cfg)))

1013  -
EFAULT
;

1015 
c⁄ãxt
 = 
chûd
->
bts
;

1016 i‡(!
c⁄ãxt
)

1017 
c⁄ãxt
 = 
	`Æloc_bts_c⁄ãxt
(
chûd
);

1018 i‡(!
c⁄ãxt
)

1019  -
ENOMEM
;

1021 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SIGNAL
) {

1022 i‡(!
cfg
.
sig«l
)

1023  -
EINVAL
;

1025  -
EOPNOTSUPP
;

1026 
c⁄ãxt
->
bts_ovÊ_sig«l
 = 
cfg
.
sig«l
;

1029 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

1030 
c⁄ãxt
->
åa˚r
 = 
NULL
;

1032 i‡((
cfg
.
Êags
 & 
PTRACE_BTS_O_ALLOC
Ë&& (cfg.
size
 !
c⁄ãxt
->size)) {

1033 
îr
;

1035 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

1036 i‡(!
cfg
.
size
)

1039 
îr
 = 
	`Æloc_bts_buf„r
(
c⁄ãxt
, 
cfg
.
size
);

1040 i‡(
îr
 < 0)

1041  
îr
;

1044 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_TRACE
)

1045 
Êags
 |
BTS_USER
;

1047 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SCHED
)

1048 
Êags
 |
BTS_TIMESTAMPS
;

1050 
c⁄ãxt
->
åa˚r
 =

1051 
	`ds_ªque°_bts_èsk
(
chûd
, 
c⁄ãxt
->
buf„r
, c⁄ãxt->
size
,

1052 
NULL
, (
size_t
)-1, 
Êags
);

1053 i‡(
	`u∆ikñy
(
	`IS_ERR
(
c⁄ãxt
->
åa˚r
))) {

1054 
îr‹
 = 
	`PTR_ERR
(
c⁄ãxt
->
åa˚r
);

1056 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

1057 
c⁄ãxt
->
åa˚r
 = 
NULL
;

1058  
îr‹
;

1061  (
cfg
);

1062 
	}
}

1064 
	$±ø˚_bts_°©us
(
èsk_°ru˘
 *
chûd
,

1065 
cfg_size
,

1066 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

1068 
bts_c⁄ãxt
 *
c⁄ãxt
;

1069 c⁄° 
bts_åa˚
 *
åa˚
;

1070 
±ø˚_bts_c⁄fig
 
cfg
;

1072 
c⁄ãxt
 = 
chûd
->
bts
;

1073 i‡(!
c⁄ãxt
)

1074  -
ESRCH
;

1076 i‡(
cfg_size
 < (
cfg
))

1077  -
EIO
;

1079 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1080 i‡(!
åa˚
)

1081  -
ESRCH
;

1083 
	`mem£t
(&
cfg
, 0, (cfg));

1084 
cfg
.
size
 = 
åa˚
->
ds
.
íd
 -Åø˚->ds.
begö
;

1085 
cfg
.
sig«l
 = 
c⁄ãxt
->
bts_ovÊ_sig«l
;

1086 
cfg
.
bts_size
 = (
bts_°ru˘
);

1088 i‡(
cfg
.
sig«l
)

1089 
cfg
.
Êags
 |
PTRACE_BTS_O_SIGNAL
;

1091 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_USER
)

1092 
cfg
.
Êags
 |
PTRACE_BTS_O_TRACE
;

1094 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_TIMESTAMPS
)

1095 
cfg
.
Êags
 |
PTRACE_BTS_O_SCHED
;

1097 i‡(
	`c›y_to_u£r
(
ucfg
, &
cfg
, (cfg)))

1098  -
EFAULT
;

1100  (
cfg
);

1101 
	}
}

1103 
	$±ø˚_bts_˛ór
(
èsk_°ru˘
 *
chûd
)

1105 
bts_c⁄ãxt
 *
c⁄ãxt
;

1106 c⁄° 
bts_åa˚
 *
åa˚
;

1108 
c⁄ãxt
 = 
chûd
->
bts
;

1109 i‡(!
c⁄ãxt
)

1110  -
ESRCH
;

1112 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1113 i‡(!
åa˚
)

1114  -
ESRCH
;

1116 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

1118  
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

1119 
	}
}

1121 
	$±ø˚_bts_size
(
èsk_°ru˘
 *
chûd
)

1123 
bts_c⁄ãxt
 *
c⁄ãxt
;

1124 c⁄° 
bts_åa˚
 *
åa˚
;

1126 
c⁄ãxt
 = 
chûd
->
bts
;

1127 i‡(!
c⁄ãxt
)

1128  -
ESRCH
;

1130 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1131 i‡(!
åa˚
)

1132  -
ESRCH
;

1134  (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
Ë/Åø˚->ds.
size
;

1135 
	}
}

1141 
	$±ø˚_bts_u¡ø˚
(
èsk_°ru˘
 *
chûd
)

1143 i‡(
	`u∆ikñy
(
chûd
->
bts
)) {

1144 
	`‰ì_bts_c⁄ãxt
(
chûd
->
bts
);

1145 
chûd
->
bts
 = 
NULL
;

1147 
	}
}

1155 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

1157 
	`u£r_dißbÀ_sögÀ_°ï
(
chûd
);

1158 #ifde‡
TIF_SYSCALL_EMU


1159 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_EMU
);

1161 
	}
}

1163 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1164 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
;

1167 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

1169 
ªt
;

1170 
__u£r
 *
d©≠
 = (__u£∏*)
d©a
;

1172 
ªque°
) {

1174 
PTRACE_PEEKUSR
: {

1175 
tmp
;

1177 
ªt
 = -
EIO
;

1178 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

1179 
addr
 >(
u£r
))

1182 
tmp
 = 0;

1183 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

1184 
tmp
 = 
	`gëªg
(
chûd
, 
addr
);

1185 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

1186 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

1187 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

1188 
tmp
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
addr
 / (
d©a
));

1190 
ªt
 = 
	`put_u£r
(
tmp
, 
d©≠
);

1194 
PTRACE_POKEUSR
:

1195 
ªt
 = -
EIO
;

1196 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

1197 
addr
 >(
u£r
))

1200 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

1201 
ªt
 = 
	`puåeg
(
chûd
, 
addr
, 
d©a
);

1202 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

1203 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

1204 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

1205 
ªt
 = 
	`±ø˚_£t_debugªg
(
chûd
,

1206 
addr
 / (
d©a
), data);

1210 
PTRACE_GETREGS
:

1211  
	`c›y_ªg£t_to_u£r
(
chûd
,

1212 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1213 
REGSET_GENERAL
,

1214 0, (
u£r_ªgs_°ru˘
),

1215 
d©≠
);

1217 
PTRACE_SETREGS
:

1218  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

1219 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1220 
REGSET_GENERAL
,

1221 0, (
u£r_ªgs_°ru˘
),

1222 
d©≠
);

1224 
PTRACE_GETFPREGS
:

1225  
	`c›y_ªg£t_to_u£r
(
chûd
,

1226 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1227 
REGSET_FP
,

1228 0, (
u£r_i387_°ru˘
),

1229 
d©≠
);

1231 
PTRACE_SETFPREGS
:

1232  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

1233 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1234 
REGSET_FP
,

1235 0, (
u£r_i387_°ru˘
),

1236 
d©≠
);

1238 #ifde‡
CONFIG_X86_32


1239 
PTRACE_GETFPXREGS
:

1240  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1241 
REGSET_XFP
,

1242 0, (
u£r_fx§_°ru˘
),

1243 
d©≠
Ë? -
EIO
 : 0;

1245 
PTRACE_SETFPXREGS
:

1246  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1247 
REGSET_XFP
,

1248 0, (
u£r_fx§_°ru˘
),

1249 
d©≠
Ë? -
EIO
 : 0;

1252 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1253 
PTRACE_GET_THREAD_AREA
:

1254 i‡(
addr
 < 0)

1255  -
EIO
;

1256 
ªt
 = 
	`do_gë_thªad_¨ó
(
chûd
, 
addr
,

1257 (
u£r_desc
 
__u£r
 *Ë
d©a
);

1260 
PTRACE_SET_THREAD_AREA
:

1261 i‡(
addr
 < 0)

1262  -
EIO
;

1263 
ªt
 = 
	`do_£t_thªad_¨ó
(
chûd
, 
addr
,

1264 (
u£r_desc
 
__u£r
 *Ë
d©a
, 0);

1268 #ifde‡
CONFIG_X86_64


1272 
PTRACE_ARCH_PRCTL
:

1273 
ªt
 = 
	`do_¨ch_¥˘l
(
chûd
, 
d©a
, 
addr
);

1280 #ifde‡
CONFIG_X86_PTRACE_BTS


1281 
PTRACE_BTS_CONFIG
:

1282 
ªt
 = 
±ø˚_bts_c⁄fig


1283 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1286 
PTRACE_BTS_STATUS
:

1287 
ªt
 = 
±ø˚_bts_°©us


1288 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1291 
PTRACE_BTS_SIZE
:

1292 
ªt
 = 
	`±ø˚_bts_size
(
chûd
);

1295 
PTRACE_BTS_GET
:

1296 
ªt
 = 
±ø˚_bts_ªad_ªc‹d


1297 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1300 
PTRACE_BTS_CLEAR
:

1301 
ªt
 = 
	`±ø˚_bts_˛ór
(
chûd
);

1304 
PTRACE_BTS_DRAIN
:

1305 
ªt
 = 
±ø˚_bts_døö


1306 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1311 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1315  
ªt
;

1316 
	}
}

1318 #ifde‡
CONFIG_IA32_EMULATION


1320 
	~<löux/com∑t.h
>

1321 
	~<löux/sysˇŒs.h
>

1322 
	~<asm/ü32.h
>

1323 
	~<asm/u£r32.h
>

1325 
	#R32
(
l
,
q
) \

1326 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1327 
ªgs
->
q
 = 
vÆue
; 

	)

1329 
	#SEG32
(
rs
) \

1330 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1331  
	`£t_£gmít_ªg
(
chûd
, \

1332 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
), \

1333 
vÆue
); \

1334 

	)

1336 
	$puåeg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 
vÆue
)

1338 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1340 
ªgno
) {

1342 
	`SEG32
(
cs
);

1343 
	`SEG32
(
ds
);

1344 
	`SEG32
(
es
);

1345 
	`SEG32
(
fs
);

1346 
	`SEG32
(
gs
);

1347 
	`SEG32
(
ss
);

1349 
	`R32
(
ebx
, 
bx
);

1350 
	`R32
(
ecx
, 
cx
);

1351 
	`R32
(
edx
, 
dx
);

1352 
	`R32
(
edi
, 
di
);

1353 
	`R32
(
esi
, 
si
);

1354 
	`R32
(
ebp
, 
bp
);

1355 
	`R32
(
óx
, 
ax
);

1356 
	`R32
(
eù
, 
ù
);

1357 
	`R32
(
e•
, 
•
);

1359 
	`off£tof
(
u£r32
, 
ªgs
.
‹ig_óx
):

1367 
ªgs
->
‹ig_ax
 = 
vÆue
;

1368 i‡(
	`sysˇŒ_gë_ƒ
(
chûd
, 
ªgs
) >= 0)

1369 
	`èsk_thªad_öfo
(
chûd
)->
°©us
 |
TS_COMPAT
;

1372 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1373  
	`£t_Êags
(
chûd
, 
vÆue
);

1375 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1376 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1377 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1378  
	`±ø˚_£t_debugªg
(
chûd
, 
ªgno
 / 4, 
vÆue
);

1381 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1382  -
EIO
;

1391 
	}
}

1393 #unde‡
R32


1394 #unde‡
SEG32


1396 
	#R32
(
l
,
q
) \

1397 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1398 *
vÆ
 = 
ªgs
->
q
; 

	)

1400 
	#SEG32
(
rs
) \

1401 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1402 *
vÆ
 = 
	`gë_£gmít_ªg
(
chûd
, \

1403 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
)); \

1404 

	)

1406 
	$gëªg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 *
vÆ
)

1408 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1410 
ªgno
) {

1412 
	`SEG32
(
ds
);

1413 
	`SEG32
(
es
);

1414 
	`SEG32
(
fs
);

1415 
	`SEG32
(
gs
);

1417 
	`R32
(
cs
, cs);

1418 
	`R32
(
ss
, ss);

1419 
	`R32
(
ebx
, 
bx
);

1420 
	`R32
(
ecx
, 
cx
);

1421 
	`R32
(
edx
, 
dx
);

1422 
	`R32
(
edi
, 
di
);

1423 
	`R32
(
esi
, 
si
);

1424 
	`R32
(
ebp
, 
bp
);

1425 
	`R32
(
óx
, 
ax
);

1426 
	`R32
(
‹ig_óx
, 
‹ig_ax
);

1427 
	`R32
(
eù
, 
ù
);

1428 
	`R32
(
e•
, 
•
);

1430 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1431 *
vÆ
 = 
	`gë_Êags
(
chûd
);

1434 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1435 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1436 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1437 *
vÆ
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
ªgno
 / 4);

1441 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1442  -
EIO
;

1448 *
vÆ
 = 0;

1452 
	}
}

1454 #unde‡
R32


1455 #unde‡
SEG32


1457 
	$gíªgs32_gë
(
èsk_°ru˘
 *
èrgë
,

1458 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1459 
pos
, 
cou¡
,

1460 *
kbuf
, 
__u£r
 *
ubuf
)

1462 i‡(
kbuf
) {

1463 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1464 
cou¡
 >(*
k
)) {

1465 
	`gëªg32
(
èrgë
, 
pos
, 
k
++);

1466 
cou¡
 -(*
k
);

1467 
pos
 +(*
k
);

1470 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1471 
cou¡
 >(*
u
)) {

1472 
com∑t_ul⁄g_t
 
w‹d
;

1473 
	`gëªg32
(
èrgë
, 
pos
, &
w‹d
);

1474 i‡(
	`__put_u£r
(
w‹d
, 
u
++))

1475  -
EFAULT
;

1476 
cou¡
 -(*
u
);

1477 
pos
 +(*
u
);

1482 
	}
}

1484 
	$gíªgs32_£t
(
èsk_°ru˘
 *
èrgë
,

1485 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1486 
pos
, 
cou¡
,

1487 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

1489 
ªt
 = 0;

1490 i‡(
kbuf
) {

1491 c⁄° 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1492 
cou¡
 >(*
k
Ë&& !
ªt
) {

1493 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, *
k
++);

1494 
cou¡
 -(*
k
);

1495 
pos
 +(*
k
);

1498 c⁄° 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1499 
cou¡
 >(*
u
Ë&& !
ªt
) {

1500 
com∑t_ul⁄g_t
 
w‹d
;

1501 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

1502 i‡(
ªt
)

1504 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, 
w‹d
);

1505 
cou¡
 -(*
u
);

1506 
pos
 +(*
u
);

1509  
ªt
;

1510 
	}
}

1512 
	$com∑t_¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
com∑t_l⁄g_t
 
ªque°
,

1513 
com∑t_ul⁄g_t
 
ˇddr
, com∑t_ul⁄g_à
cd©a
)

1515 
addr
 = 
ˇddr
;

1516 
d©a
 = 
cd©a
;

1517 
__u£r
 *
d©≠
 = 
	`com∑t_±r
(
d©a
);

1518 
ªt
;

1519 
__u32
 
vÆ
;

1521 
ªque°
) {

1522 
PTRACE_PEEKUSR
:

1523 
ªt
 = 
	`gëªg32
(
chûd
, 
addr
, &
vÆ
);

1524 i‡(
ªt
 == 0)

1525 
ªt
 = 
	`put_u£r
(
vÆ
, (
__u32
 
__u£r
 *)
d©≠
);

1528 
PTRACE_POKEUSR
:

1529 
ªt
 = 
	`puåeg32
(
chûd
, 
addr
, 
d©a
);

1532 
PTRACE_GETREGS
:

1533  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1534 
REGSET_GENERAL
,

1535 0, (
u£r_ªgs_°ru˘32
),

1536 
d©≠
);

1538 
PTRACE_SETREGS
:

1539  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1540 
REGSET_GENERAL
, 0,

1541 (
u£r_ªgs_°ru˘32
),

1542 
d©≠
);

1544 
PTRACE_GETFPREGS
:

1545  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1546 
REGSET_FP
, 0,

1547 (
u£r_i387_ü32_°ru˘
),

1548 
d©≠
);

1550 
PTRACE_SETFPREGS
:

1551  
	`c›y_ªg£t_‰om_u£r
(

1552 
chûd
, &
u£r_x86_32_võw
, 
REGSET_FP
,

1553 0, (
u£r_i387_ü32_°ru˘
), 
d©≠
);

1555 
PTRACE_GETFPXREGS
:

1556  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1557 
REGSET_XFP
, 0,

1558 (
u£r32_fx§_°ru˘
),

1559 
d©≠
);

1561 
PTRACE_SETFPXREGS
:

1562  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1563 
REGSET_XFP
, 0,

1564 (
u£r32_fx§_°ru˘
),

1565 
d©≠
);

1567 
PTRACE_GET_THREAD_AREA
:

1568 
PTRACE_SET_THREAD_AREA
:

1569 #ifde‡
CONFIG_X86_PTRACE_BTS


1570 
PTRACE_BTS_CONFIG
:

1571 
PTRACE_BTS_STATUS
:

1572 
PTRACE_BTS_SIZE
:

1573 
PTRACE_BTS_GET
:

1574 
PTRACE_BTS_CLEAR
:

1575 
PTRACE_BTS_DRAIN
:

1577  
	`¨ch_±ø˚
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1580  
	`com∑t_±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1583  
ªt
;

1584 
	}
}

1588 #ifde‡
CONFIG_X86_64


1590 c⁄° 
u£r_ªg£t
 
	gx86_64_ªg£ts
[] = {

1591 [
REGSET_GENERAL
] = {

1592 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1593 .
	gn
 = (
u£r_ªgs_°ru˘
) / (),

1594 .
	gsize
 = (), .
	gÆign
 = (),

1595 .
	ggë
 = 
gíªgs_gë
, .
	g£t
 = 
gíªgs_£t


1597 [
REGSET_FP
] = {

1598 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1599 .
	gn
 = (
u£r_i387_°ru˘
) / (),

1600 .
	gsize
 = (), .
	gÆign
 = (),

1601 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1603 [
REGSET_IOPERM64
] = {

1604 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1605 .
	gn
 = 
IO_BITMAP_LONGS
,

1606 .
	gsize
 = (), .
	gÆign
 = (),

1607 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1611 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_64_võw
 = {

1612 .
«me
 = "x86_64", .
	ge_machöe
 = 
EM_X86_64
,

1613 .
	gªg£ts
 = 
x86_64_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1618 
	#u£r_ªgs_°ru˘32
 
u£r_ªgs_°ru˘


	)

1619 
	#gíªgs32_gë
 
gíªgs_gë


	)

1620 
	#gíªgs32_£t
 
gíªgs_£t


	)

1622 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

1623 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

1627 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1628 c⁄° 
u£r_ªg£t
 
	gx86_32_ªg£ts
[] = {

1629 [
REGSET_GENERAL
] = {

1630 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1631 .
	gn
 = (
u£r_ªgs_°ru˘32
Ë/ (
u32
),

1632 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1633 .
	ggë
 = 
gíªgs32_gë
, .
	g£t
 = 
gíªgs32_£t


1635 [
REGSET_FP
] = {

1636 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1637 .
	gn
 = (
u£r_i387_ü32_°ru˘
Ë/ (
u32
),

1638 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1639 .
	ga˘ive
 = 
Âªgs_a˘ive
, .
	ggë
 = 
Âªgs_gë
, .
	g£t
 = 
Âªgs_£t


1641 [
REGSET_XFP
] = {

1642 .
c‹e_nŸe_ty≥
 = 
NT_PRXFPREG
,

1643 .
	gn
 = (
u£r32_fx§_°ru˘
Ë/ (
u32
),

1644 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1645 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1647 [
REGSET_TLS
] = {

1648 .
c‹e_nŸe_ty≥
 = 
NT_386_TLS
,

1649 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbüs
 = 
GDT_ENTRY_TLS_MIN
,

1650 .
	gsize
 = (
u£r_desc
),

1651 .
	gÆign
 = (
u£r_desc
),

1652 .
	ga˘ive
 = 
ªg£t_és_a˘ive
,

1653 .
	ggë
 = 
ªg£t_és_gë
, .
	g£t
 = 
ªg£t_és_£t


1655 [
REGSET_IOPERM32
] = {

1656 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1657 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1658 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1659 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1663 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
 = {

1664 .
«me
 = "i386", .
	ge_machöe
 = 
EM_386
,

1665 .
	gªg£ts
 = 
x86_32_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1669 c⁄° 
u£r_ªg£t_võw
 *
	$èsk_u£r_ªg£t_võw
(
èsk_°ru˘
 *
èsk
)

1671 #ifde‡
CONFIG_IA32_EMULATION


1672 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

1674 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1675  &
u£r_x86_32_võw
;

1677 #ifde‡
CONFIG_X86_64


1678  &
u£r_x86_64_võw
;

1680 
	}
}

1682 
	$fûl_sigå≠_öfo
(
èsk_°ru˘
 *
tsk
,

1683 
±_ªgs
 *
ªgs
,

1684 
îr‹_code
, 
si_code
,

1685 
sigöfo
 *
öfo
)

1687 
tsk
->
thªad
.
å≠_no
 = 1;

1688 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

1690 
	`mem£t
(
öfo
, 0, (*info));

1691 
öfo
->
si_signo
 = 
SIGTRAP
;

1692 
öfo
->
si_code
 = si_code;

1693 
öfo
->
si_addr
 = 
	`u£r_mode_vm
(
ªgs
Ë? (
__u£r
 *Ïegs->
ù
 : 
NULL
;

1694 
	}
}

1696 
	$u£r_sögÀ_°ï_sigöfo
(
èsk_°ru˘
 *
tsk
,

1697 
±_ªgs
 *
ªgs
,

1698 
sigöfo
 *
öfo
)

1700 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 0, 
TRAP_BRKPT
, 
öfo
);

1701 
	}
}

1703 
	$£nd_sigå≠
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
,

1704 
îr‹_code
, 
si_code
)

1706 
sigöfo
 
öfo
;

1708 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
, &
öfo
);

1710 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

1711 
	}
}

1714 #ifde‡
CONFIG_X86_32


1715 
	#IS_IA32
 1

	)

1716 #ñi‡
deföed
 
CONFIG_IA32_EMULATION


1717 
	#IS_IA32
 
	`is_com∑t_èsk
()

	)

1719 
	#IS_IA32
 0

	)

1726 
asmªg∑rm
 
	$sysˇŒ_åa˚_íãr
(
±_ªgs
 *
ªgs
)

1728 
ªt
 = 0;

1737 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
))

1738 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

1741 
	`£cuª_computög
(
ªgs
->
‹ig_ax
);

1743 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1744 
ªt
 = -1L;

1746 i‡((
ªt
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
)) &&

1747 
	`åa˚hook_ªp‹t_sysˇŒ_íåy
(
ªgs
))

1748 
ªt
 = -1L;

1750 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1751 
	`åa˚_sys_íãr
(
ªgs
,Ñegs->
‹ig_ax
);

1753 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
)) {

1754 i‡(
IS_IA32
)

1755 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_I386
,

1756 
ªgs
->
‹ig_ax
,

1757 
ªgs
->
bx
,Ñegs->
cx
,

1758 
ªgs
->
dx
,Ñegs->
si
);

1759 #ifde‡
CONFIG_X86_64


1761 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_X86_64
,

1762 
ªgs
->
‹ig_ax
,

1763 
ªgs
->
di
,Ñegs->
si
,

1764 
ªgs
->
dx
,Ñegs->
r10
);

1768  
ªt
 ?: 
ªgs
->
‹ig_ax
;

1769 
	}
}

1771 
asmªg∑rm
 
	$sysˇŒ_åa˚_Àave
(
±_ªgs
 *
ªgs
)

1773 
boﬁ
 
°ï
;

1775 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
))

1776 
	`audô_sysˇŒ_exô
(
	`AUDITSC_RESULT
(
ªgs
->
ax
),Ñegs->ax);

1778 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1779 
	`åa˚_sys_exô
(
ªgs
,Ñegs->
ax
);

1787 
°ï
 = 
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
)) &&

1788 !
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
);

1789 i‡(
°ï
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

1790 
	`åa˚hook_ªp‹t_sysˇŒ_exô
(
ªgs
, 
°ï
);

1791 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<löux/pci.h
>

5 
	~<löux/úq.h
>

7 
	~<asm/h≥t.h
>

9 #i‡
deföed
(
CONFIG_X86_IO_APIC
Ë&& deföed(
CONFIG_SMP
Ë&& deföed(
CONFIG_PCI
)

11 
__devöô
 
	$quúk_öãl_úqbÆ™˚
(
pci_dev
 *
dev
)

13 
u8
 
c⁄fig
, 
ªv
;

14 
u16
 
w‹d
;

21 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

22 i‡(
ªv
 > 0x9)

26 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xf4, &
c⁄fig
);

27 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
|0x2);

33 
	`pci_bus_ªad_c⁄fig_w‹d
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
w‹d
);

35 i‡(!(
w‹d
 & (1 << 13))) {

36 
	`dev_öfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noúqdebug_£tup
("");

39 #ifde‡
CONFIG_PROC_FS


40 
no_úq_afföôy
 = 1;

45 i‡(!(
c⁄fig
 & 0x2))

46 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quúk_öãl_úqbÆ™˚
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quúk_öãl_úqbÆ™˚
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quúk_öãl_úqbÆ™˚
);

56 #i‡
deföed
(
CONFIG_HPET_TIMER
)

57 
	gf‹˚_h≥t_addªss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gf‹˚_h≥t_ªsume_ty≥
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_f‹˚_h≥t_ªsume
()

72 
u32
 
vÆ
;

74 i‡(!
f‹˚_h≥t_addªss
)

77 
	`BUG_ON
(
rcba_ba£
 =
NULL
);

80 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

81 i‡(!(
vÆ
 & 0x80)) {

83 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

87 i‡(!(
vÆ
 & 0x80))

88 
	`BUG
();

90 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

93 
	}
}

95 
	$ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

97 
u32
 
vÆ
;

98 
u32
 
	`unöôülized_v¨
(
rcba
);

99 
îr
 = 0;

101 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

104 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 i‡(
rcba
 == 0) {

107 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`i‹em≠_noˇche
(
rcba
, 0x4000);

114 i‡(
rcba_ba£
 =
NULL
) {

115 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

123 i‡(
vÆ
 & 0x80) {

125 
vÆ
 = val & 0x3;

126 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

127 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

128 "0x%lx\n", 
f‹˚_h≥t_addªss
);

129 
	`iounm≠
(
rcba_ba£
);

134 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

137 i‡(!(
vÆ
 & 0x80)) {

138 
îr
 = 1;

140 
vÆ
 = val & 0x3;

141 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

144 i‡(
îr
) {

145 
f‹˚_h≥t_addªss
 = 0;

146 
	`iounm≠
(
rcba_ba£
);

147 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev,

150 
f‹˚_h≥t_ªsume_ty≥
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

152 "0x%lx\n", 
f‹˚_h≥t_addªss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_f‹˚_íabÀ_h≥t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_f‹˚_íabÀ_h≥t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_f‹˚_íabÀ_h≥t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_f‹˚_íabÀ_h≥t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_f‹˚_íabÀ_h≥t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_f‹˚_íabÀ_h≥t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_f‹˚_íabÀ_h≥t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_f‹˚_íabÀ_h≥t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_f‹˚_íabÀ_h≥t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_f‹˚_íabÀ_h≥t
);

177 
pci_dev
 *
	gˇched_dev
;

179 
	$h≥t_¥öt_f‹˚_öfo
()

181 
	`¥ötk
(
KERN_INFO
 "HPETÇotÉnabled in BIOS. "

183 
	}
}

185 
	$ﬁd_ich_f‹˚_h≥t_ªsume
()

187 
u32
 
vÆ
;

188 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

190 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

193 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

194 
gí_˙é
 &= (~(0x7 << 15));

195 
gí_˙é
 |= (0x4 << 15);

197 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, 
gí_˙é
);

198 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

199 
vÆ
 = 
gí_˙é
 >> 15;

200 
vÆ
 &= 0x7;

201 i‡(
vÆ
 == 0x4)

202 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

204 
	`BUG
();

205 
	}
}

207 
	$ﬁd_ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

209 
u32
 
vÆ
;

210 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

212 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

215 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

220 
vÆ
 = 
gí_˙é
 >> 15;

221 
vÆ
 &= 0x7;

222 i‡(
vÆ
 & 0x4) {

223 
vÆ
 &= 0x3;

224 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

225 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

226 
f‹˚_h≥t_addªss
);

234 
gí_˙é
 &= (~(0x7 << 15));

235 
gí_˙é
 |= (0x4 << 15);

236 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0xD0, 
gí_˙é
);

238 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

240 
vÆ
 = 
gí_˙é
 >> 15;

241 
vÆ
 &= 0x7;

242 i‡(
vÆ
 & 0x4) {

244 
vÆ
 &= 0x3;

245 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

246 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

247 "0x%lx\n", 
f‹˚_h≥t_addªss
);

248 
ˇched_dev
 = 
dev
;

249 
f‹˚_h≥t_ªsume_ty≥
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

254 
	}
}

260 
	$ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
(
pci_dev
 *
dev
)

262 i‡(
h≥t_f‹˚_u£r
)

263 
	`ﬁd_ich_f‹˚_íabÀ_h≥t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

282 
	$vt8237_f‹˚_h≥t_ªsume
()

284 
u32
 
vÆ
;

286 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

289 
vÆ
 = 0xfed00000 | 0x80;

290 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, 
vÆ
);

292 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, &
vÆ
);

293 i‡(
vÆ
 & 0x80)

294 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

301 
u32
 
	`unöôülized_v¨
(
vÆ
);

303 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

306 i‡(!
h≥t_f‹˚_u£r
) {

307 
	`h≥t_¥öt_f‹˚_öfo
();

311 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

316 i‡(
vÆ
 & 0x80) {

317 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

318 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

319 
f‹˚_h≥t_addªss
);

327 
vÆ
 = 0xfed00000 | 0x80;

328 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x68, 
vÆ
);

330 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

331 i‡(
vÆ
 & 0x80) {

332 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

333 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

334 "0x%lx\n", 
f‹˚_h≥t_addªss
);

335 
ˇched_dev
 = 
dev
;

336 
f‹˚_h≥t_ªsume_ty≥
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_f‹˚_íabÀ_h≥t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_f‹˚_íabÀ_h≥t
);

348 
	$©i_f‹˚_h≥t_ªsume
()

350 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x14, 0xfed00000);

351 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_ªv
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xac, 
b
);

362 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x70, 
d
);

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
vÆ
;

374 
u8
 
b
;

376 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

379 i‡(!
h≥t_f‹˚_u£r
) {

380 
	`h≥t_¥öt_f‹˚_öfo
();

384 
d
 = 
	`©i_ixp4x0_ªv
(
dev
);

385 i‡(
d
 < 0x82)

389 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x14, 0xfed00000);

390 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x14, &
vÆ
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

397 i‡(!(
b
 & 0x1))

399 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x64, 
d
);

402 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

403 i‡(!(
d
 & (1<<10)))

406 
f‹˚_h≥t_addªss
 = 
vÆ
;

407 
f‹˚_h≥t_ªsume_ty≥
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

409 
f‹˚_h≥t_addªss
);

410 
ˇched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_f‹˚_íabÀ_h≥t
);

418 
	$nvidü_f‹˚_h≥t_ªsume
()

420 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x44, 0xfed00001);

421 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

422 
	}
}

424 
	$nvidü_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

426 
u32
 
	`unöôülized_v¨
(
vÆ
);

428 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

431 i‡(!
h≥t_f‹˚_u£r
) {

432 
	`h≥t_¥öt_f‹˚_öfo
();

436 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x44, 0xfed00001);

437 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x44, &
vÆ
);

438 
f‹˚_h≥t_addªss
 = 
vÆ
 & 0xfffffffe;

439 
f‹˚_h≥t_ªsume_ty≥
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

441 
f‹˚_h≥t_addªss
);

442 
ˇched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidü_f‹˚_íabÀ_h≥t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidü_f‹˚_íabÀ_h≥t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidü_f‹˚_íabÀ_h≥t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidü_f‹˚_íabÀ_h≥t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidü_f‹˚_íabÀ_h≥t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidü_f‹˚_íabÀ_h≥t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidü_f‹˚_íabÀ_h≥t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidü_f‹˚_íabÀ_h≥t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidü_f‹˚_íabÀ_h≥t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidü_f‹˚_íabÀ_h≥t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidü_f‹˚_íabÀ_h≥t
);

472 
	$f‹˚_h≥t_ªsume
()

474 
f‹˚_h≥t_ªsume_ty≥
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_f‹˚_h≥t_ªsume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`ﬁd_ich_f‹˚_h≥t_ªsume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_f‹˚_h≥t_ªsume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidü_f‹˚_h≥t_ªsume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_f‹˚_h≥t_ªsume
();

493 
	}
}

499 
	$f‹˚_dißbÀ_h≥t_msi
(
pci_dev
 *
unu£d
)

501 
h≥t_msi_dißbÀ
 = 1;

502 
	}
}

504 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

505 
f‹˚_dißbÀ_h≥t_msi
);

509 #i‡
deföed
(
CONFIG_PCI
Ë&& deföed(
CONFIG_NUMA
)

511 
__öô
 
	$quúk_amd_nb_node
(
pci_dev
 *
dev
)

513 
pci_dev
 *
nb_ht
;

514 
dev‚
;

515 
u32
 
node
;

516 
u32
 
vÆ
;

518 
dev‚
 = 
	`PCI_DEVFN
(
	`PCI_SLOT
(
dev
->devfn), 0);

519 
nb_ht
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, 
dev‚
);

520 i‡(!
nb_ht
)

523 
	`pci_ªad_c⁄fig_dw‹d
(
nb_ht
, 0x60, &
vÆ
);

524 
node
 = 
vÆ
 & 7;

529 i‡(
	`node_⁄löe
(
node
))

530 
	`£t_dev_node
(&
dev
->dev, 
node
);

531 
	`pci_dev_put
(
nb_ht
);

532 
	}
}

534 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

535 
quúk_amd_nb_node
);

536 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
,

537 
quúk_amd_nb_node
);

538 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
,

539 
quúk_amd_nb_node
);

540 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
,

541 
quúk_amd_nb_node
);

542 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_HT
,

543 
quúk_amd_nb_node
);

544 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MAP
,

545 
quúk_amd_nb_node
);

546 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_DRAM
,

547 
quúk_amd_nb_node
);

548 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
,

549 
quúk_amd_nb_node
);

550 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_LINK
,

551 
quúk_amd_nb_node
);

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ªboŸ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/pm.h
>

5 
	~<löux/efi.h
>

6 
	~<löux/dmi.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/tboŸ.h
>

9 
	~<a˝i/ªboŸ.h
>

10 
	~<asm/io.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/h≥t.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/ªboŸ_fixups.h
>

17 
	~<asm/ªboŸ.h
>

18 
	~<asm/pci_x86.h
>

19 
	~<asm/vúãxt.h
>

20 
	~<asm/˝u.h
>

22 #ifde‡
CONFIG_X86_32


23 
	~<löux/˘y≥.h
>

24 
	~<löux/mc146818πc.h
>

26 
	~<asm/x86_öô.h
>

32 (*
pm_powî_off
)();

33 
	`EXPORT_SYMBOL
(
pm_powî_off
);

35 c⁄° 
desc_±r
 
no_idt
 = {
	}
};

36 
	gªboŸ_mode
;

37 
ªboŸ_ty≥
 
	gªboŸ_ty≥
 = 
BOOT_KBD
;

38 
	gªboŸ_f‹˚
;

40 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_SMP
)

41 
	gªboŸ_˝u
 = -1;

48 
	gªboŸ_emîgícy
;

51 
boﬁ
 
	gp‹t_cf9_ß„
 = 
Ál£
;

65 
__öô
 
	$ªboŸ_£tup
(*
°r
)

68 *
°r
) {

70 
ªboŸ_mode
 = 0x1234;

74 
ªboŸ_mode
 = 0;

77 #ifde‡
CONFIG_X86_32


78 #ifde‡
CONFIG_SMP


80 i‡(
	`isdigô
(*(
°r
+1))) {

81 
ªboŸ_˝u
 = (Ë(*(
°r
+1) - '0');

82 i‡(
	`isdigô
(*(
°r
+2)))

83 
ªboŸ_˝u
 =ÑeboŸ_˝u*10 + ()(*(
°r
+2) - '0');

98 
ªboŸ_ty≥
 = *
°r
;

102 
ªboŸ_f‹˚
 = 1;

106 
°r
 = 
	`°rchr
(str, ',');

107 i‡(
°r
)

108 
°r
++;

113 
	}
}

115 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

118 #ifde‡
CONFIG_X86_32


128 
__öô
 
	$£t_bios_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

130 i‡(
ªboŸ_ty≥
 !
BOOT_BIOS
) {

131 
ªboŸ_ty≥
 = 
BOOT_BIOS
;

132 
	`¥ötk
(
KERN_INFO
 "%†£rõ†bﬂrd dëe˘ed. Sñe˘ög BIOS-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

135 
	}
}

137 
dmi_sy°em_id
 
__öôd©a
 
	gªboŸ_dmi_èbÀ
[] = {

139 .
ˇŒback
 = 
£t_bios_ªboŸ
,

140 .
	gidít
 = "Dell E520",

141 .
	gm©ches
 = {

142 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

143 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

147 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

148 .
	gidít
 = "Dell PowerEdge 1300",

149 .
	gm©ches
 = {

150 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

151 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

155 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

156 .
	gidít
 = "Dell PowerEdge 300",

157 .
	gm©ches
 = {

158 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

159 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

163 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

164 .
	gidít
 = "Dell OptiPlex 745",

165 .
	gm©ches
 = {

166 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

167 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

171 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

172 .
	gidít
 = "Dell OptiPlex 745",

173 .
	gm©ches
 = {

174 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

175 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

176 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

180 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

181 .
	gidít
 = "Dell OptiPlex 745",

182 .
	gm©ches
 = {

183 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

184 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

185 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

189 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

190 .
	gidít
 = "Dell OptiPlex 330",

191 .
	gm©ches
 = {

192 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

193 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

194 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

198 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

199 .
	gidít
 = "Dell OptiPlex 360",

200 .
	gm©ches
 = {

201 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

202 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 360"),

203 
DMI_MATCH
(
DMI_BOARD_NAME
, "0T656F"),

207 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

208 .
	gidít
 = "Dell OptiPlex 760",

209 .
	gm©ches
 = {

210 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

211 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 760"),

212 
DMI_MATCH
(
DMI_BOARD_NAME
, "0G919G"),

216 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

217 .
	gidít
 = "Dell PowerEdge 2400",

218 .
	gm©ches
 = {

219 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

220 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

224 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

225 .
	gidít
 = "Dell Precision T5400",

226 .
	gm©ches
 = {

227 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

228 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

232 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

233 .
	gidít
 = "HP Compaq Laptop",

234 .
	gm©ches
 = {

235 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

236 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

240 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

241 .
	gidít
 = "Dell XPS710",

242 .
	gm©ches
 = {

243 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

244 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

248 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

249 .
	gidít
 = "Dell DXP061",

250 .
	gm©ches
 = {

251 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

252 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

256 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

257 .
	gidít
 = "Sony VGN-Z540N",

258 .
	gm©ches
 = {

259 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

260 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

264 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

265 .
	gidít
 = "CompuLab SBC-FITPC2",

266 .
	gm©ches
 = {

267 
DMI_MATCH
(
DMI_SYS_VENDOR
, "CompuLab"),

268 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "SBC-FITPC2"),

272 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

273 .
	gidít
 = "ASUS P4S800",

274 .
	gm©ches
 = {

275 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

276 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4S800"),

282 
__öô
 
	$ªboŸ_öô
()

284 
	`dmi_check_sy°em
(
ªboŸ_dmi_èbÀ
);

286 
	}
}

287 
c‹e_öôˇŒ
(
ªboŸ_öô
);

296 
	gªÆ_mode_gdt_íåõs
 [3] =

303 c⁄° 
desc_±r


304 
	gªÆ_mode_gdt
 = {  (
ªÆ_mode_gdt_íåõs
) - 1, ()real_mode_gdt_entries },

305 
	gªÆ_mode_idt
 = { 0x3ff, 0 };

325 c⁄° 
	gªÆ_mode_swôch
 [] =

339 c⁄° 
	gjump_to_bios
 [] =

349 
	$machöe_ªÆ_ª°¨t
(c⁄° *
code
, 
Àngth
)

351 
	`loˇl_úq_dißbÀ
();

362 
	`•ö_lock
(&
πc_lock
);

363 
	`CMOS_WRITE
(0x00, 0x8f);

364 
	`•ö_u∆ock
(&
πc_lock
);

369 
	`mem˝y
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

370 (
sw≠≥r_pg_dú
 [0]Ë* 
KERNEL_PGD_PTRS
);

375 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

382 *((*)0x472Ë
ªboŸ_mode
;

389 
	`mem˝y
((*)(0x1000 - (
ªÆ_mode_swôch
) - 100),

390 
ªÆ_mode_swôch
,  (real_mode_switch));

391 
	`mem˝y
((*)(0x1000 - 100), 
code
, 
Àngth
);

394 
	`lﬂd_idt
(&
ªÆ_mode_idt
);

399 
	`lﬂd_gdt
(&
ªÆ_mode_gdt
);

406 
__asm__
 
	`__vﬁ©ûe__
 ("movl $0x0010,%%eax\n"

416 
__asm__
 
	`__vﬁ©ûe__
 ("ljmp $0x0008,%0"

418 : "i" ((*)(0x1000 -  (
ªÆ_mode_swôch
) - 100)));

419 
	}
}

420 #ifde‡
CONFIG_APM_MODULE


421 
EXPORT_SYMBOL
(
machöe_ªÆ_ª°¨t
);

429 
__öô
 
	$£t_pci_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

431 i‡(
ªboŸ_ty≥
 !
BOOT_CF9
) {

432 
ªboŸ_ty≥
 = 
BOOT_CF9
;

433 
	`¥ötk
(
KERN_INFO
 "%s series board detected. "

434 "Sñe˘ög PCI-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

437 
	}
}

439 
dmi_sy°em_id
 
__öôd©a
 
	gpci_ªboŸ_dmi_èbÀ
[] = {

441 .
ˇŒback
 = 
£t_pci_ªboŸ
,

442 .
	gidít
 = "Apple MacBook5",

443 .
	gm©ches
 = {

444 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

445 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBook5"),

449 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

450 .
	gidít
 = "Apple MacBookPro5",

451 .
	gm©ches
 = {

452 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

453 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBookPro5"),

457 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

458 .
	gidít
 = "Apple Macmini3,1",

459 .
	gm©ches
 = {

460 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

461 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Macmini3,1"),

467 
__öô
 
	$pci_ªboŸ_öô
()

469 
	`dmi_check_sy°em
(
pci_ªboŸ_dmi_èbÀ
);

471 
	}
}

472 
c‹e_öôˇŒ
(
pci_ªboŸ_öô
);

474 
ölöe
 
	$kb_waô
()

476 
i
;

478 
i
 = 0; i < 0x10000; i++) {

479 i‡((
	`öb
(0x64) & 0x02) == 0)

481 
	`udñay
(2);

483 
	}
}

485 
	$vmxoff_nmi
(
˝u
, 
dõ_¨gs
 *
¨gs
)

487 
	`˝u_emîgícy_vmxoff
();

488 
	}
}

492 
	$emîgícy_vmx_dißbÀ_Æl
()

495 
	`loˇl_úq_dißbÀ
();

515 i‡(
	`˝u_has_vmx
(Ë&& 
	`˝u_vmx_íabÀd
()) {

518 
	`˝u_vmxoff
();

521 
	`nmi_shoŸdown_˝us
(
vmxoff_nmi
);

524 
	}
}

527 
__©åibuã__
((
wók
)Ë
	$mach_ªboŸ_fixups
()

529 
	}
}

531 
	$«tive_machöe_emîgícy_ª°¨t
()

533 
i
;

535 i‡(
ªboŸ_emîgícy
)

536 
	`emîgícy_vmx_dißbÀ_Æl
();

538 
	`tboŸ_shutdown
(
TB_SHUTDOWN_REBOOT
);

541 *((*)
	`__va
(0x472)Ë
ªboŸ_mode
;

545 
ªboŸ_ty≥
) {

546 
BOOT_KBD
:

547 
	`mach_ªboŸ_fixups
();

549 
i
 = 0; i < 10; i++) {

550 
	`kb_waô
();

551 
	`udñay
(50);

552 
	`outb
(0xfe, 0x64);

553 
	`udñay
(50);

556 
BOOT_TRIPLE
:

557 
	`lﬂd_idt
(&
no_idt
);

558 
__asm__
 
	`__vﬁ©ûe__
("int3");

560 
ªboŸ_ty≥
 = 
BOOT_KBD
;

563 #ifde‡
CONFIG_X86_32


564 
BOOT_BIOS
:

565 
	`machöe_ªÆ_ª°¨t
(
jump_to_bios
, (jump_to_bios));

567 
ªboŸ_ty≥
 = 
BOOT_KBD
;

571 
BOOT_ACPI
:

572 
	`a˝i_ªboŸ
();

573 
ªboŸ_ty≥
 = 
BOOT_KBD
;

576 
BOOT_EFI
:

577 i‡(
efi_íabÀd
)

578 
efi
.
	`ª£t_sy°em
(
ªboŸ_mode
 ?

579 
EFI_RESET_WARM
 :

580 
EFI_RESET_COLD
,

581 
EFI_SUCCESS
, 0, 
NULL
);

582 
ªboŸ_ty≥
 = 
BOOT_KBD
;

585 
BOOT_CF9
:

586 
p‹t_cf9_ß„
 = 
åue
;

589 
BOOT_CF9_COND
:

590 i‡(
p‹t_cf9_ß„
) {

591 
u8
 
cf9
 = 
	`öb
(0xcf9) & ~6;

592 
	`outb
(
cf9
|2, 0xcf9);

593 
	`udñay
(50);

594 
	`outb
(
cf9
|6, 0xcf9);

595 
	`udñay
(50);

597 
ªboŸ_ty≥
 = 
BOOT_KBD
;

601 
	}
}

603 
	$«tive_machöe_shutdown
()

606 #ifde‡
CONFIG_SMP


609 
ªboŸ_˝u_id
 = 0;

611 #ifde‡
CONFIG_X86_32


613 i‡((
ªboŸ_˝u
 !-1Ë&& (ªboŸ_˝u < 
ƒ_˝u_ids
) &&

614 
	`˝u_⁄löe
(
ªboŸ_˝u
))

615 
ªboŸ_˝u_id
 = 
ªboŸ_˝u
;

619 i‡(!
	`˝u_⁄löe
(
ªboŸ_˝u_id
))

620 
ªboŸ_˝u_id
 = 
	`smp_¥o˚ss‹_id
();

623 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
ªboŸ_˝u_id
));

628 
	`smp_£nd_°›
();

631 
	`œpic_shutdown
();

633 #ifde‡
CONFIG_X86_IO_APIC


634 
	`dißbÀ_IO_APIC
();

637 #ifde‡
CONFIG_HPET_TIMER


638 
	`h≥t_dißbÀ
();

641 #ifde‡
CONFIG_X86_64


642 
x86_∂©f‹m
.
	`iommu_shutdown
();

644 
	}
}

646 
	$__machöe_emîgícy_ª°¨t
(
emîgícy
)

648 
ªboŸ_emîgícy
 = 
emîgícy
;

649 
machöe_›s
.
	`emîgícy_ª°¨t
();

650 
	}
}

652 
	$«tive_machöe_ª°¨t
(*
__unu£d
)

654 
	`¥ötk
("machineÑestart\n");

656 i‡(!
ªboŸ_f‹˚
)

657 
	`machöe_shutdown
();

658 
	`__machöe_emîgícy_ª°¨t
(0);

659 
	}
}

661 
	$«tive_machöe_hÆt
()

664 
	`machöe_shutdown
();

666 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

669 
	`°›_this_˝u
(
NULL
);

670 
	}
}

672 
	$«tive_machöe_powî_off
()

674 i‡(
pm_powî_off
) {

675 i‡(!
ªboŸ_f‹˚
)

676 
	`machöe_shutdown
();

677 
	`pm_powî_off
();

680 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

681 
	}
}

683 
machöe_›s
 
	gmachöe_›s
 = {

684 .
powî_off
 = 
«tive_machöe_powî_off
,

685 .
	gshutdown
 = 
«tive_machöe_shutdown
,

686 .
	gemîgícy_ª°¨t
 = 
«tive_machöe_emîgícy_ª°¨t
,

687 .
	gª°¨t
 = 
«tive_machöe_ª°¨t
,

688 .
	ghÆt
 = 
«tive_machöe_hÆt
,

689 #ifde‡
CONFIG_KEXEC


690 .
	g¸ash_shutdown
 = 
«tive_machöe_¸ash_shutdown
,

694 
	$machöe_powî_off
()

696 
machöe_›s
.
	`powî_off
();

697 
	}
}

699 
	$machöe_shutdown
()

701 
machöe_›s
.
	`shutdown
();

702 
	}
}

704 
	$machöe_emîgícy_ª°¨t
()

706 
	`__machöe_emîgícy_ª°¨t
(1);

707 
	}
}

709 
	$machöe_ª°¨t
(*
cmd
)

711 
machöe_›s
.
	`ª°¨t
(
cmd
);

712 
	}
}

714 
	$machöe_hÆt
()

716 
machöe_›s
.
	`hÆt
();

717 
	}
}

719 #ifde‡
CONFIG_KEXEC


720 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

722 
machöe_›s
.
	`¸ash_shutdown
(
ªgs
);

723 
	}
}

727 #i‡
deföed
(
CONFIG_SMP
)

730 
	g¸ashög_˝u
;

731 
nmi_shoŸdown_cb
 
	gshoŸdown_ˇŒback
;

733 
©omic_t
 
	gwaôög_f‹_¸ash_ùi
;

735 
	$¸ash_nmi_ˇŒback
(
nŸifõr_block
 *
£lf
,

736 
vÆ
, *
d©a
)

738 
˝u
;

740 i‡(
vÆ
 !
DIE_NMI_IPI
)

741  
NOTIFY_OK
;

743 
˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

749 i‡(
˝u
 =
¸ashög_˝u
)

750  
NOTIFY_STOP
;

751 
	`loˇl_úq_dißbÀ
();

753 
	`shoŸdown_ˇŒback
(
˝u
, (
dõ_¨gs
 *)
d©a
);

755 
	`©omic_dec
(&
waôög_f‹_¸ash_ùi
);

757 
	`hÆt
();

759 
	`˝u_ªœx
();

762 
	}
}

764 
	$smp_£nd_nmi_Ælbut£lf
()

766 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
NMI_VECTOR
);

767 
	}
}

769 
nŸifõr_block
 
	g¸ash_nmi_nb
 = {

770 .
nŸifõr_ˇŒ
 = 
¸ash_nmi_ˇŒback
,

779 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

781 
m£cs
;

782 
	`loˇl_úq_dißbÀ
();

785 
¸ashög_˝u
 = 
	`ß„_smp_¥o˚ss‹_id
();

787 
shoŸdown_ˇŒback
 = 
ˇŒback
;

789 
	`©omic_£t
(&
waôög_f‹_¸ash_ùi
, 
	`num_⁄löe_˝us
() - 1);

791 i‡(
	`ªgi°î_dõ_nŸifõr
(&
¸ash_nmi_nb
))

796 
	`wmb
();

798 
	`smp_£nd_nmi_Ælbut£lf
();

800 
m£cs
 = 1000;

801 (
	`©omic_ªad
(&
waôög_f‹_¸ash_ùi
Ë> 0Ë&& 
m£cs
) {

802 
	`mdñay
(1);

803 
m£cs
--;

807 
	}
}

809 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

812 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<löux/∂©f‹m_devi˚.h
>

5 
	~<löux/mc146818πc.h
>

6 
	~<löux/a˝i.h
>

7 
	~<löux/bcd.h
>

8 
	~<löux/≤p.h
>

10 
	~<asm/vsysˇŒ.h
>

11 
	~<asm/x86_öô.h
>

12 
	~<asm/time.h
>

14 #ifde‡
CONFIG_X86_32


20 vﬁ©ûê
	gcmos_lock
;

21 
EXPORT_SYMBOL
(
cmos_lock
);

25 
	#CMOS_YEARS_OFFS
 2000

	)

27 
DEFINE_SPINLOCK
(
πc_lock
);

28 
EXPORT_SYMBOL
(
πc_lock
);

40 
	$mach_£t_πc_mmss
(
nowtime
)

42 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

43 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

44 
ªtvÆ
 = 0;

47 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

48 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

51 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

52 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

54 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

55 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

56 
cmos_möuãs
 = 
	`bcd2bö
(cmos_minutes);

64 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

65 
ªÆ_möuãs
 = 
nowtime
 / 60;

67 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

68 
ªÆ_möuãs
 += 30;

69 
ªÆ_möuãs
 %= 60;

71 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

72 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

73 
ªÆ_£c⁄ds
 = 
	`bö2bcd
(real_seconds);

74 
ªÆ_möuãs
 = 
	`bö2bcd
(real_minutes);

76 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
, 
RTC_SECONDS
);

77 
	`CMOS_WRITE
(
ªÆ_möuãs
, 
RTC_MINUTES
);

79 
	`¥ötk
(
KERN_WARNING


81 
cmos_möuãs
, 
ªÆ_möuãs
);

82 
ªtvÆ
 = -1;

92 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

93 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

95  
ªtvÆ
;

96 
	}
}

98 
	$mach_gë_cmos_time
()

100 
°©us
, 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
˚¡ury
 = 0;

108 (
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
))

109 
	`˝u_ªœx
();

111 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

112 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

113 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

114 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

115 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

116 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

118 #ifde‡
CONFIG_ACPI


119 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

120 
a˝i_gbl_FADT
.
˚¡ury
)

121 
˚¡ury
 = 
	`CMOS_READ
(
a˝i_gbl_FADT
.century);

124 
°©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

125 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
°©us
 & 
RTC_DM_BINARY
));

127 i‡(
RTC_ALWAYS_BCD
 || !(
°©us
 & 
RTC_DM_BINARY
)) {

128 
£c
 = 
	`bcd2bö
(sec);

129 
mö
 = 
	`bcd2bö
(min);

130 
hour
 = 
	`bcd2bö
(hour);

131 
day
 = 
	`bcd2bö
(day);

132 
m⁄
 = 
	`bcd2bö
(mon);

133 
yór
 = 
	`bcd2bö
(year);

136 i‡(
˚¡ury
) {

137 
˚¡ury
 = 
	`bcd2bö
(century);

138 
yór
 +
˚¡ury
 * 100;

139 
	`¥ötk
(
KERN_INFO
 "Exãnded CMOS yór: %d\n", 
˚¡ury
 * 100);

141 
yór
 +
CMOS_YEARS_OFFS
;

143  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

144 
	}
}

147 
	$πc_cmos_ªad
(
addr
)

149 
vÆ
;

151 
	`lock_cmos_¥efix
(
addr
);

152 
	`outb
(
addr
, 
	`RTC_PORT
(0));

153 
vÆ
 = 
	`öb
(
	`RTC_PORT
(1));

154 
	`lock_cmos_suffix
(
addr
);

156  
vÆ
;

157 
	}
}

158 
EXPORT_SYMBOL
(
πc_cmos_ªad
);

160 
	$πc_cmos_wrôe
(
vÆ
, 
addr
)

162 
	`lock_cmos_¥efix
(
addr
);

163 
	`outb
(
addr
, 
	`RTC_PORT
(0));

164 
	`outb
(
vÆ
, 
	`RTC_PORT
(1));

165 
	`lock_cmos_suffix
(
addr
);

166 
	}
}

167 
EXPORT_SYMBOL
(
πc_cmos_wrôe
);

169 
	$upd©e_≥rsi°ít_˛ock
(
time•ec
 
now
)

171 
Êags
;

172 
ªtvÆ
;

174 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

175 
ªtvÆ
 = 
x86_∂©f‹m
.
	`£t_wÆl˛ock
(
now
.
tv_£c
);

176 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

178  
ªtvÆ
;

179 
	}
}

182 
	$ªad_≥rsi°ít_˛ock
(
time•ec
 *
ts
)

184 
ªtvÆ
, 
Êags
;

186 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

187 
ªtvÆ
 = 
x86_∂©f‹m
.
	`gë_wÆl˛ock
();

188 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

190 
ts
->
tv_£c
 = 
ªtvÆ
;

191 
ts
->
tv_n£c
 = 0;

192 
	}
}

194 
	$«tive_ªad_tsc
()

196  
	`__«tive_ªad_tsc
();

197 
	}
}

198 
EXPORT_SYMBOL
(
«tive_ªad_tsc
);

201 
ªsour˚
 
	gπc_ªsour˚s
[] = {

203 .
°¨t
 = 
RTC_PORT
(0),

204 .
	gíd
 = 
RTC_PORT
(1),

205 .
	gÊags
 = 
IORESOURCE_IO
,

208 .
°¨t
 = 
RTC_IRQ
,

209 .
	gíd
 = 
RTC_IRQ
,

210 .
	gÊags
 = 
IORESOURCE_IRQ
,

214 
∂©f‹m_devi˚
 
	gπc_devi˚
 = {

215 .
«me
 = "rtc_cmos",

216 .
	gid
 = -1,

217 .
	gªsour˚
 = 
πc_ªsour˚s
,

218 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

221 
__öô
 
	$add_πc_cmos
()

223 #ifde‡
CONFIG_PNP


224 c⁄° *
ids
[] 
__öôc⁄°
 =

226 
≤p_dev
 *
dev
;

227 
≤p_id
 *
id
;

228 
i
;

230 
	`≤p_f‹_óch_dev
(
dev
) {

231 
id
 = 
dev
->id; id; id = id->
√xt
) {

232 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

233 i‡(
	`com∑ª_≤p_id
(
id
, 
ids
[
i
]) != 0)

240 
	`∂©f‹m_devi˚_ªgi°î
(&
πc_devi˚
);

241 
	`dev_öfo
(&
πc_devi˚
.
dev
,

245 
	}
}

246 
devi˚_öôˇŒ
(
add_πc_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<löux/sched.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/mmz⁄e.h
>

27 
	~<löux/s¸ìn_öfo.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/a˝i.h
>

30 
	~<löux/sfi.h
>

31 
	~<löux/≠m_bios.h
>

32 
	~<löux/öôrd.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/c⁄sﬁe.h
>

36 
	~<löux/mˇ.h
>

37 
	~<löux/roŸ_dev.h
>

38 
	~<löux/highmem.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/efi.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/edd.h
>

43 
	~<löux/iscsi_ib·.h
>

44 
	~<löux/nodemask.h
>

45 
	~<löux/kexec.h
>

46 
	~<löux/dmi.h
>

47 
	~<löux/p‚.h
>

48 
	~<löux/pci.h
>

49 
	~<asm/pci-dúe˘.h
>

50 
	~<löux/öô_ohci1394_dma.h
>

51 
	~<löux/kvm_∑ø.h
>

53 
	~<löux/î∫o.h
>

54 
	~<löux/kî√l.h
>

55 
	~<löux/°ddef.h
>

56 
	~<löux/uni°d.h
>

57 
	~<löux/±ø˚.h
>

58 
	~<löux/¶ab.h
>

59 
	~<löux/u£r.h
>

60 
	~<löux/dñay.h
>

62 
	~<löux/kÆlsyms.h
>

63 
	~<löux/˝u‰eq.h
>

64 
	~<löux/dma-m≠pög.h
>

65 
	~<löux/˘y≥.h
>

66 
	~<löux/uac˚ss.h
>

68 
	~<löux/≥r˝u.h
>

69 
	~<löux/¸ash_dump.h
>

70 
	~<löux/tboŸ.h
>

72 
	~<video/edid.h
>

74 
	~<asm/mår.h
>

75 
	~<asm/≠ic.h
>

76 
	~<asm/åampﬁöe.h
>

77 
	~<asm/e820.h
>

78 
	~<asm/mp•ec.h
>

79 
	~<asm/£tup.h
>

80 
	~<asm/efi.h
>

81 
	~<asm/timî.h
>

82 
	~<asm/i8259.h
>

83 
	~<asm/£˘i⁄s.h
>

84 
	~<asm/dmi.h
>

85 
	~<asm/io_≠ic.h
>

86 
	~<asm/i°.h
>

87 
	~<asm/vmi.h
>

88 
	~<asm/£tup_¨ch.h
>

89 
	~<asm/bios_ebda.h
>

90 
	~<asm/ˇcheÊush.h
>

91 
	~<asm/¥o˚ss‹.h
>

92 
	~<asm/bugs.h
>

94 
	~<asm/sy°em.h
>

95 
	~<asm/vsysˇŒ.h
>

96 
	~<asm/˝u.h
>

97 
	~<asm/desc.h
>

98 
	~<asm/dma.h
>

99 
	~<asm/iommu.h
>

100 
	~<asm/g¨t.h
>

101 
	~<asm/mmu_c⁄ãxt.h
>

102 
	~<asm/¥Ÿo.h
>

104 
	~<asm/∑øvút.h
>

105 
	~<asm/hy≥rvis‹.h
>

107 
	~<asm/≥r˝u.h
>

108 
	~<asm/t›ﬁogy.h
>

109 
	~<asm/≠icdef.h
>

110 
	~<asm/k8.h
>

111 #ifde‡
CONFIG_X86_64


112 
	~<asm/numa_64.h
>

114 
	~<asm/m˚.h
>

121 
	gmax_low_p‚_m≠≥d
;

122 
	gmax_p‚_m≠≥d
;

124 
RESERVE_BRK
(
dmi_Æloc
, 65536);

126 
boŸ_˝u_id
 
	g__ªad_mo°ly
;

128 
__öôd©a
 
	g_brk_°¨t
 = ()
__brk_ba£
;

129 
	g_brk_íd
 = ()
__brk_ba£
;

131 #ifde‡
CONFIG_X86_64


132 
	$deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
)

134  
	`__deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
);

135 
	}
}

137 
	$deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
)

139  
	`__deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
);

140 
	}
}

143 #i‚de‡
CONFIG_DEBUG_BOOT_PARAMS


144 
boŸ_∑øms
 
__öôd©a
 
	gboŸ_∑øms
;

146 
boŸ_∑øms
 
	gboŸ_∑øms
;

152 
ªsour˚
 
	gd©a_ªsour˚
 = {

153 .
«me
 = "Kernel data",

154 .
	g°¨t
 = 0,

155 .
	gíd
 = 0,

156 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


159 
ªsour˚
 
	gcode_ªsour˚
 = {

160 .
«me
 = "Kernel code",

161 .
	g°¨t
 = 0,

162 .
	gíd
 = 0,

163 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


166 
ªsour˚
 
	gbss_ªsour˚
 = {

167 .
«me
 = "Kernel bss",

168 .
	g°¨t
 = 0,

169 .
	gíd
 = 0,

170 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


174 #ifde‡
CONFIG_X86_32


176 
˝uöfo_x86
 
√w_˝u_d©a
 
	g__˝uöôd©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

178 
˝uöfo_x86
 
boŸ_˝u_d©a
 
	g__ªad_mo°ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

179 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

180 
	$£t_mˇ_bus
(
x
)

182 #ifde‡
CONFIG_MCA


183 
MCA_bus
 = 
x
;

185 
	}
}

187 
	gdef_to_bigsmp
;

190 
	gmachöe_id
;

191 
	gmachöe_submodñ_id
;

192 
	gBIOS_ªvisi⁄
;

194 
≠m_öfo
 
	g≠m_öfo
;

195 
EXPORT_SYMBOL
(
≠m_öfo
);

197 #i‡
deföed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

198 
	$deföed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

199 
i°_öfo
 ist_info;

200 
	`EXPORT_SYMBOL
(
i°_öfo
);

202 
i°_öfo
 ist_info;

206 
˝uöfo_x86
 
boŸ_˝u_d©a
 
__ªad_mo°ly
 = {

207 .
x86_phys_bôs
 = 
MAX_PHYSMEM_BITS
,

208 
	}
};

209 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

213 #i‡!
deföed
(
CONFIG_X86_PAE
Ë|| deföed(
CONFIG_X86_64
)

214 
	gmmu_¸4_„©uªs
;

216 
	gmmu_¸4_„©uªs
 = 
X86_CR4_PAE
;

220 
	gboŸlﬂdî_ty≥
, 
	gboŸlﬂdî_vîsi⁄
;

225 
s¸ìn_öfo
 
	gs¸ìn_öfo
;

226 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

227 
edid_öfo
 
	gedid_öfo
;

228 
EXPORT_SYMBOL_GPL
(
edid_öfo
);

230 
roŸ_mou¡Êags
;

232 
	gßved_video_mode
;

234 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

235 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

236 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

238 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

239 #ifde‡
CONFIG_CMDLINE_BOOL


240 
__öôd©a
 
	gbuûtö_cmdlöe
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

243 #i‡
deföed
(
CONFIG_EDD
Ë|| deföed(
CONFIG_EDD_MODULE
)

244 
edd
 
	gedd
;

245 #ifde‡
CONFIG_EDD_MODULE


246 
EXPORT_SYMBOL
(
edd
);

253 
ölöe
 
__öô
 
	$c›y_edd
()

255 
	`mem˝y
(
edd
.
mbr_sig«tuª
, 
boŸ_∑øms
.
edd_mbr_sig_buf„r
,

256 (
edd
.
mbr_sig«tuª
));

257 
	`mem˝y
(
edd
.
edd_öfo
, 
boŸ_∑øms
.
eddbuf
, (edd.edd_info));

258 
edd
.
mbr_sig«tuª_ƒ
 = 
boŸ_∑øms
.
edd_mbr_sig_buf_íåõs
;

259 
edd
.
edd_öfo_ƒ
 = 
boŸ_∑øms
.
eddbuf_íåõs
;

260 
	}
}

262 
ölöe
 
__öô
 
	$c›y_edd
()

264 
	}
}

267 * 
__öô
 
	$exãnd_brk
(
size_t
 
size
, size_à
Æign
)

269 
size_t
 
mask
 = 
Æign
 - 1;

270 *
ªt
;

272 
	`BUG_ON
(
_brk_°¨t
 == 0);

273 
	`BUG_ON
(
Æign
 & 
mask
);

275 
_brk_íd
 = (_brk_íd + 
mask
) & ~mask;

276 
	`BUG_ON
((*)(
_brk_íd
 + 
size
Ë> 
__brk_limô
);

278 
ªt
 = (*)
_brk_íd
;

279 
_brk_íd
 +
size
;

281 
	`mem£t
(
ªt
, 0, 
size
);

283  
ªt
;

284 
	}
}

286 #ifde‡
CONFIG_X86_64


287 
__öô
 
	$öô_gb∑ges
()

289 i‡(
dúe˘_gb∑ges
 && 
˝u_has_gb∑ges
)

290 
	`¥ötk
(
KERN_INFO
 "Using GBÖages for direct mapping\n");

292 
dúe˘_gb∑ges
 = 0;

293 
	}
}

295 
ölöe
 
	$öô_gb∑ges
()

297 
	}
}

300 
__öô
 
	$ª£rve_brk
()

302 i‡(
_brk_íd
 > 
_brk_°¨t
)

303 
	`ª£rve_óæy
(
	`__∑
(
_brk_°¨t
), __∑(
_brk_íd
), "BRK");

307 
_brk_°¨t
 = 0;

308 
	}
}

310 #ifde‡
CONFIG_BLK_DEV_INITRD


312 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

313 
__öô
 
	$ªloˇã_öôrd
()

316 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

317 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

318 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

319 
u64
 
ømdisk_hîe
;

320 
¶›
, 
˛í
, 
m≠addr
;

321 *
p
, *
q
;

324 
ømdisk_hîe
 = 
	`föd_e820_¨ó
(0, 
íd_of_lowmem
, 
ømdisk_size
,

325 
PAGE_SIZE
);

327 i‡(
ømdisk_hîe
 == -1ULL)

328 
	`∑nic
("Cannot findÖlace forÇew RAMDISK of size %lld\n",

329 
ømdisk_size
);

333 
	`ª£rve_óæy
(
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
,

335 
öôrd_°¨t
 = 
ømdisk_hîe
 + 
PAGE_OFFSET
;

336 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

337 
	`¥ötk
(
KERN_INFO
 "AllocatedÇew RAMDISK: %08llx - %08llx\n",

338 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
);

340 
q
 = (*)
öôrd_°¨t
;

343 i‡(
ømdisk_image
 < 
íd_of_lowmem
) {

344 
˛í
 = 
íd_of_lowmem
 - 
ømdisk_image
;

345 
p
 = (*)
	`__va
(
ømdisk_image
);

346 
	`mem˝y
(
q
, 
p
, 
˛í
);

347 
q
 +
˛í
;

348 
ømdisk_image
 +
˛í
;

349 
ømdisk_size
 -
˛í
;

353 
ømdisk_size
) {

354 
¶›
 = 
ømdisk_image
 & ~
PAGE_MASK
;

355 
˛í
 = 
ømdisk_size
;

356 i‡(
˛í
 > 
MAX_MAP_CHUNK
-
¶›
)

357 
˛í
 = 
MAX_MAP_CHUNK
-
¶›
;

358 
m≠addr
 = 
ømdisk_image
 & 
PAGE_MASK
;

359 
p
 = 
	`óæy_memªm≠
(
m≠addr
, 
˛í
+
¶›
);

360 
	`mem˝y
(
q
, 
p
+
¶›
, 
˛í
);

361 
	`óæy_iounm≠
(
p
, 
˛í
+
¶›
);

362 
q
 +
˛í
;

363 
ømdisk_image
 +
˛í
;

364 
ømdisk_size
 -
˛í
;

367 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

368 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

369 
	`¥ötk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxÅo"

371 
ømdisk_image
,Ñamdisk_imagê+ 
ømdisk_size
 - 1,

372 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
 - 1);

373 
	}
}

375 
__öô
 
	$ª£rve_öôrd
()

377 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

378 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

379 
u64
 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

380 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

382 i‡(!
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 ||

383 !
ømdisk_image
 || !
ømdisk_size
)

386 
öôrd_°¨t
 = 0;

388 i‡(
ømdisk_size
 >(
íd_of_lowmem
>>1)) {

389 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

390 
	`¥ötk
(
KERN_ERR
 "initrdÅooÜargeÅo handle, "

395 
	`¥ötk
(
KERN_INFO
 "RAMDISK: %08Œx - %08Œx\n", 
ømdisk_image
,

396 
ømdisk_íd
);

399 i‡(
ømdisk_íd
 <
íd_of_lowmem
) {

405 
öôrd_°¨t
 = 
ømdisk_image
 + 
PAGE_OFFSET
;

406 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

410 
	`ªloˇã_öôrd
();

412 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

413 
	}
}

415 
__öô
 
	$ª£rve_öôrd
()

417 
	}
}

420 
__öô
 
	$∑r£_£tup_d©a
()

422 
£tup_d©a
 *
d©a
;

423 
u64
 
∑_d©a
;

425 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

427 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

428 
∑_d©a
) {

429 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, 
PAGE_SIZE
);

430 
d©a
->
ty≥
) {

431 
SETUP_E820_EXT
:

432 
	`∑r£_e820_ext
(
d©a
, 
∑_d©a
);

437 
∑_d©a
 = 
d©a
->
√xt
;

438 
	`óæy_iounm≠
(
d©a
, 
PAGE_SIZE
);

440 
	}
}

442 
__öô
 
	$e820_ª£rve_£tup_d©a
()

444 
£tup_d©a
 *
d©a
;

445 
u64
 
∑_d©a
;

446 
found
 = 0;

448 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

450 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

451 
∑_d©a
) {

452 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

453 
	`e820_upd©e_ønge
(
∑_d©a
, (*
d©a
)+d©a->
Àn
,

454 
E820_RAM
, 
E820_RESERVED_KERN
);

455 
found
 = 1;

456 
∑_d©a
 = 
d©a
->
√xt
;

457 
	`óæy_iounm≠
(
d©a
, (*data));

459 i‡(!
found
)

462 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

463 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

464 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

465 
	`e820_¥öt_m≠
("reserve setup_data");

466 
	}
}

468 
__öô
 
	$ª£rve_óæy_£tup_d©a
()

470 
£tup_d©a
 *
d©a
;

471 
u64
 
∑_d©a
;

472 
buf
[32];

474 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

476 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

477 
∑_d©a
) {

478 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

479 
	`•rötf
(
buf
, "£tu∞d©®%x", 
d©a
->
ty≥
);

480 
	`ª£rve_óæy
(
∑_d©a
,Öa_d©a+(*
d©a
)+d©a->
Àn
, 
buf
);

481 
∑_d©a
 = 
d©a
->
√xt
;

482 
	`óæy_iounm≠
(
d©a
, (*data));

484 
	}
}

490 #ifde‡
CONFIG_KEXEC


492 
ölöe
 
	$gë_tŸÆ_mem
()

494 
tŸÆ
;

496 
tŸÆ
 = 
max_p‚
 - 
mö_low_p‚
;

498  
tŸÆ
 << 
PAGE_SHIFT
;

499 
	}
}

501 
__öô
 
	$ª£rve_¸ashkî√l
()

503 
tŸÆ_mem
;

504 
¸ash_size
, 
¸ash_ba£
;

505 
ªt
;

507 
tŸÆ_mem
 = 
	`gë_tŸÆ_mem
();

509 
ªt
 = 
	`∑r£_¸ashkî√l
(
boŸ_comm™d_löe
, 
tŸÆ_mem
,

510 &
¸ash_size
, &
¸ash_ba£
);

511 i‡(
ªt
 !0 || 
¸ash_size
 <= 0)

515 i‡(
¸ash_ba£
 <= 0) {

516 c⁄° 
Æignmít
 = 16<<20;

518 
¸ash_ba£
 = 
	`föd_e820_¨ó
(
Æignmít
, 
ULONG_MAX
, 
¸ash_size
,

519 
Æignmít
);

520 i‡(
¸ash_ba£
 == -1ULL) {

521 
	`¥_öfo
("crashkernelÑeservation failed - No suitableárea found.\n");

525 
°¨t
;

527 
°¨t
 = 
	`föd_e820_¨ó
(
¸ash_ba£
, 
ULONG_MAX
, 
¸ash_size
,

529 i‡(
°¨t
 !
¸ash_ba£
) {

530 
	`¥_öfo
("crashkernelÑeservation failed - memory is in use.\n");

534 
	`ª£rve_óæy
(
¸ash_ba£
, cøsh_ba£ + 
¸ash_size
, "CRASH KERNEL");

536 
	`¥ötk
(
KERN_INFO
 "Reserving %ldMB of memoryát %ldMB "

538 ()(
¸ash_size
 >> 20),

539 ()(
¸ash_ba£
 >> 20),

540 ()(
tŸÆ_mem
 >> 20));

542 
¸ashk_ªs
.
°¨t
 = 
¸ash_ba£
;

543 
¸ashk_ªs
.
íd
 = 
¸ash_ba£
 + 
¸ash_size
 - 1;

544 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
¸ashk_ªs
);

545 
	}
}

547 
__öô
 
	$ª£rve_¸ashkî√l
()

549 
	}
}

552 
ªsour˚
 
	g°™d¨d_io_ªsour˚s
[] = {

553 { .
«me
 = "dma1", .
	g°¨t
 = 0x00, .
	gíd
 = 0x1f,

554 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

555 { .
	g«me
 = "pic1", .
	g°¨t
 = 0x20, .
	gíd
 = 0x21,

556 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

557 { .
	g«me
 = "timî0", .
	g°¨t
 = 0x40, .
	gíd
 = 0x43,

558 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

559 { .
	g«me
 = "timî1", .
	g°¨t
 = 0x50, .
	gíd
 = 0x53,

560 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

561 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x60, .
	gíd
 = 0x60,

562 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

563 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x64, .
	gíd
 = 0x64,

564 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

565 { .
	g«me
 = "dm®∑gêªg", .
	g°¨t
 = 0x80, .
	gíd
 = 0x8f,

566 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

567 { .
	g«me
 = "pic2", .
	g°¨t
 = 0xa0, .
	gíd
 = 0xa1,

568 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

569 { .
	g«me
 = "dma2", .
	g°¨t
 = 0xc0, .
	gíd
 = 0xdf,

570 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

571 { .
	g«me
 = "Âu", .
	g°¨t
 = 0xf0, .
	gíd
 = 0xff,

572 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

575 
__öô
 
	$ª£rve_°™d¨d_io_ªsour˚s
()

577 
i
;

580 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); i++)

581 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
°™d¨d_io_ªsour˚s
[
i
]);

583 
	}
}

591 #ifde‡
CONFIG_CRASH_DUMP


596 
__öô
 
	$£tup_ñfc‹ehdr
(*
¨g
)

598 *
íd
;

599 i‡(!
¨g
)

600  -
EINVAL
;

601 
ñfc‹ehdr_addr
 = 
	`mem∑r£
(
¨g
, &
íd
);

602  
íd
 > 
¨g
 ? 0 : -
EINVAL
;

603 
	}
}

604 
óæy_∑øm
("ñfc‹ehdr", 
£tup_ñfc‹ehdr
);

607 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


608 
__öô
 
	$dmi_low_mem‹y_c‹ru±i⁄
(c⁄° 
dmi_sy°em_id
 *
d
)

610 
	`¥ötk
(
KERN_NOTICE


612 
d
->
idít
);

614 
	`e820_upd©e_ønge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

615 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

618 
	}
}

622 
dmi_sy°em_id
 
__öôd©a
 
	gbad_bios_dmi_èbÀ
[] = {

623 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


625 .
ˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

626 .
	gidít
 = "AMI BIOS",

627 .
	gm©ches
 = {

628 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

632 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

633 .
	gidít
 = "Phoenix BIOS",

634 .
	gm©ches
 = {

635 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

639 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

640 .
	gidít
 = "Phoenix/MSC BIOS",

641 .
	gm©ches
 = {

642 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix/MSC"),

653 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

654 .
	gidít
 = "AMI BIOS",

655 .
	gm©ches
 = {

656 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45ID"),

660 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

661 .
	gidít
 = "AMI BIOS",

662 .
	gm©ches
 = {

663 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45FC"),

683 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

685 
a˝i
 = 0;

686 
k8
 = 0;

688 #ifde‡
CONFIG_X86_32


689 
	`mem˝y
(&
boŸ_˝u_d©a
, &
√w_˝u_d©a
, (new_cpu_data));

690 
	`visws_óæy_dëe˘
();

692 
	`¥ötk
(
KERN_INFO
 "Comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

696 
	`vmi_öô
();

698 
	`óæy_˝u_öô
();

699 
	`óæy_i‹em≠_öô
();

701 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
boŸ_∑øms
.
hdr
.
roŸ_dev
);

702 
s¸ìn_öfo
 = 
boŸ_∑øms
.screen_info;

703 
edid_öfo
 = 
boŸ_∑øms
.edid_info;

704 #ifde‡
CONFIG_X86_32


705 
≠m_öfo
.
bios
 = 
boŸ_∑øms
.
≠m_bios_öfo
;

706 
i°_öfo
 = 
boŸ_∑øms
.ist_info;

707 i‡(
boŸ_∑øms
.
sys_desc_èbÀ
.
Àngth
 != 0) {

708 
	`£t_mˇ_bus
(
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[3] & 0x2);

709 
machöe_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[0];

710 
machöe_submodñ_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[1];

711 
BIOS_ªvisi⁄
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[2];

714 
ßved_video_mode
 = 
boŸ_∑øms
.
hdr
.
vid_mode
;

715 
boŸlﬂdî_ty≥
 = 
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
;

716 i‡((
boŸlﬂdî_ty≥
 >> 4) == 0xe) {

717 
boŸlﬂdî_ty≥
 &= 0xf;

718 
boŸlﬂdî_ty≥
 |(
boŸ_∑øms
.
hdr
.
ext_lﬂdî_ty≥
+0x10) << 4;

720 
boŸlﬂdî_vîsi⁄
 = 
boŸlﬂdî_ty≥
 & 0xf;

721 
boŸlﬂdî_vîsi⁄
 |
boŸ_∑øms
.
hdr
.
ext_lﬂdî_vî
 << 4;

723 #ifde‡
CONFIG_BLK_DEV_RAM


724 
rd_image_°¨t
 = 
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_IMAGE_START_MASK
;

725 
rd_¥om±
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

726 
rd_dﬁﬂd
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

728 #ifde‡
CONFIG_EFI


729 i‡(!
	`°∫cmp
((*)&
boŸ_∑øms
.
efi_öfo
.
efi_lﬂdî_sig«tuª
,

730 #ifde‡
CONFIG_X86_32


736 
efi_íabÀd
 = 1;

737 
	`efi_ª£rve_óæy
();

741 
x86_öô
.
€m
.
	`¨ch_£tup
();

743 
	`£tup_mem‹y_m≠
();

744 
	`∑r£_£tup_d©a
();

746 
	`e820_ª£rve_£tup_d©a
();

748 
	`c›y_edd
();

750 i‡(!
boŸ_∑øms
.
hdr
.
roŸ_Êags
)

751 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

752 
öô_mm
.
°¨t_code
 = (Ë
_ãxt
;

753 
öô_mm
.
íd_code
 = (Ë
_ëext
;

754 
öô_mm
.
íd_d©a
 = (Ë
_ed©a
;

755 
öô_mm
.
brk
 = 
_brk_íd
;

757 
code_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ãxt
);

758 
code_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ëext
)-1;

759 
d©a_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ëext
);

760 
d©a_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ed©a
)-1;

761 
bss_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(&
__bss_°¨t
);

762 
bss_ªsour˚
.
íd
 = 
	`vút_to_phys
(&
__bss_°›
)-1;

764 #ifde‡
CONFIG_CMDLINE_BOOL


765 #ifde‡
CONFIG_CMDLINE_OVERRIDE


766 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

768 i‡(
buûtö_cmdlöe
[0]) {

770 
	`°æˇt
(
buûtö_cmdlöe
, " ", 
COMMAND_LINE_SIZE
);

771 
	`°æˇt
(
buûtö_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

772 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

777 
	`°æ˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

778 *
cmdlöe_p
 = 
comm™d_löe
;

787 
	`x86_c⁄figuª_nx
();

789 
	`∑r£_óæy_∑øm
();

791 
	`x86_ªp‹t_nx
();

794 
	`vmi_a˘iv©e
();

797 
	`ª£rve_óæy_£tup_d©a
();

799 i‡(
	`a˝i_mps_check
()) {

800 #ifde‡
CONFIG_X86_LOCAL_APIC


801 
dißbÀ_≠ic
 = 1;

803 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

806 #ifde‡
CONFIG_PCI


807 i‡(
pci_óæy_dump_ªgs
)

808 
	`óæy_dump_pci_devi˚s
();

811 
	`föish_e820_∑rsög
();

813 i‡(
efi_íabÀd
)

814 
	`efi_öô
();

816 
	`dmi_sˇn_machöe
();

818 
	`dmi_check_sy°em
(
bad_bios_dmi_èbÀ
);

824 
	`öô_hy≥rvis‹_∂©f‹m
();

826 
x86_öô
.
ªsour˚s
.
	`¥obe_roms
();

829 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
code_ªsour˚
);

830 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
d©a_ªsour˚
);

831 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
bss_ªsour˚
);

834 #ifde‡
CONFIG_X86_32


835 i‡(
	`µro_wôh_øm_bug
()) {

836 
	`e820_upd©e_ønge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

837 
E820_RESERVED
);

838 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

839 
	`¥ötk
(
KERN_INFO
 "fixedÖhysical RAM map:\n");

840 
	`e820_¥öt_m≠
("bad_ppro");

843 
	`óæy_g¨t_iommu_check
();

850 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

853 
	`óæy_ª£rve_e820_mpc_√w
();

855 
	`mår_bp_öô
();

856 i‡(
	`mår_åim_unˇched_mem‹y
(
max_p‚
))

857 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

859 #ifde‡
CONFIG_X86_32


861 
	`föd_low_p‚_ønge
();

863 
num_phy•ages
 = 
max_p‚
;

865 
	`check_x2≠ic
();

869 i‡(
max_p‚
 > (1UL<<(32 - 
PAGE_SHIFT
)))

870 
max_low_p‚
 = 
	`e820_íd_of_low_øm_p‚
();

872 
max_low_p‚
 = 
max_p‚
;

874 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

875 
max_p‚_m≠≥d
 = 
KERNEL_IMAGE_SIZE
 >> 
PAGE_SHIFT
;

878 #ifde‡
CONFIG_X86_CHECK_BIOS_CORRUPTION


879 
	`£tup_bios_c‹ru±i⁄_check
();

882 
	`¥ötk
(
KERN_DEBUG
 "initial memory mapped : 0 - %08lx\n",

883 
max_p‚_m≠≥d
<<
PAGE_SHIFT
);

885 
	`ª£rve_brk
();

890 
	`föd_smp_c⁄fig
();

892 
	`ª£rve_åampﬁöe_mem‹y
();

894 #ifde‡
CONFIG_ACPI_SLEEP


899 
	`a˝i_ª£rve_wakeup_mem‹y
();

901 
	`öô_gb∑ges
();

904 
max_low_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

905 
max_p‚_m≠≥d
 = 
max_low_p‚_m≠≥d
;

907 #ifde‡
CONFIG_X86_64


908 i‡(
max_p‚
 > 
max_low_p‚
) {

909 
max_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(1UL<<32,

910 
max_p‚
<<
PAGE_SHIFT
);

912 
max_low_p‚
 = 
max_p‚
;

920 #ifde‡
CONFIG_PROVIDE_OHCI1394_DMA_INIT


921 i‡(
öô_ohci1394_dma_óæy
)

922 
	`öô_ohci1394_dma_⁄_Æl_c⁄åﬁÀrs
();

925 
	`ª£rve_öôrd
();

927 
	`ª£rve_¸ashkî√l
();

929 
	`vsmp_öô
();

931 
	`io_dñay_öô
();

936 
	`a˝i_boŸ_èbÀ_öô
();

938 
	`óæy_a˝i_boŸ_öô
();

940 #ifde‡
CONFIG_ACPI_NUMA


944 
a˝i
 = 
	`a˝i_numa_öô
();

947 #ifde‡
CONFIG_K8_NUMA


948 i‡(!
a˝i
)

949 
k8
 = !
	`k8_numa_öô
(0, 
max_p‚
);

952 
	`öômem_öô
(0, 
max_p‚
, 
a˝i
, 
k8
);

954 #ifde‡
CONFIG_X86_64


960 
	`dma32_ª£rve_boŸmem
();

963 
	`ª£rve_ib·_ªgi⁄
();

965 #ifde‡
CONFIG_KVM_CLOCK


966 
	`kvm˛ock_öô
();

969 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_°¨t
(
sw≠≥r_pg_dú
);

970 
	`∑gög_öô
();

971 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_d⁄e
(
sw≠≥r_pg_dú
);

973 
	`tboŸ_¥obe
();

975 #ifde‡
CONFIG_X86_64


976 
	`m≠_vsysˇŒ
();

979 
	`gíîic_≠ic_¥obe
();

981 
	`óæy_quúks
();

986 
	`a˝i_boŸ_öô
();

988 
	`sfi_öô
();

993 i‡(
smp_found_c⁄fig
)

994 
	`gë_smp_c⁄fig
();

996 
	`¥efûl_possibÀ_m≠
();

998 #ifde‡
CONFIG_X86_64


999 
	`öô_˝u_to_node
();

1002 
	`öô_≠ic_m≠pögs
();

1003 
	`iﬂpic_öô_m≠pögs
();

1006 
	`¥obe_ƒ_úqs_gsi
();

1008 
	`kvm_gue°_öô
();

1010 
	`e820_ª£rve_ªsour˚s
();

1011 
	`e820_m¨k_noßve_ªgi⁄s
(
max_low_p‚
);

1013 
x86_öô
.
ªsour˚s
.
	`ª£rve_ªsour˚s
();

1015 
	`e820_£tup_g≠
();

1017 #ifde‡
CONFIG_VT


1018 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

1019 i‡(!
efi_íabÀd
 || (
	`efi_mem_ty≥
(0xa0000Ë!
EFI_CONVENTIONAL_MEMORY
))

1020 
c⁄swôchp
 = &
vga_c⁄
;

1021 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

1022 
c⁄swôchp
 = &
dummy_c⁄
;

1025 
x86_öô
.
€m
.
	`b™√r
();

1027 
	`mcheck_öô
();

1028 
	}
}

1030 #ifde‡
CONFIG_X86_32


1032 
ªsour˚
 
	gvideo_øm_ªsour˚
 = {

1033 .
«me
 = "Video RAMárea",

1034 .
	g°¨t
 = 0xa0000,

1035 .
	gíd
 = 0xbffff,

1036 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


1039 
__öô
 
	$i386_ª£rve_ªsour˚s
()

1041 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm_ªsour˚
);

1042 
	`ª£rve_°™d¨d_io_ªsour˚s
();

1043 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

3 
	~<löux/kî√l.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/öô.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/≥r˝u.h
>

8 
	~<löux/kexec.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/smp.h
>

11 
	~<löux/t›ﬁogy.h
>

12 
	~<löux/p‚.h
>

13 
	~<asm/£˘i⁄s.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/£tup.h
>

16 
	~<asm/mp•ec.h
>

17 
	~<asm/≠icdef.h
>

18 
	~<asm/highmem.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/˝umask.h
>

21 
	~<asm/˝u.h
>

22 
	~<asm/°ack¥Ÿe˘‹.h
>

24 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


25 
	#DBG
(
fmt
, ...Ë
	`¥_dbg
(fmt, ##
__VA_ARGS__
)

	)

27 
	#DBG
(
fmt
, ...Ëdÿ{ i‡(0Ë
	`¥_dbg
(fmt, ##
__VA_ARGS__
); } 0)

	)

30 
DEFINE_PER_CPU
(, 
˝u_numbî
);

31 
EXPORT_PER_CPU_SYMBOL
(
˝u_numbî
);

33 #ifde‡
CONFIG_X86_64


34 
	#BOOT_PERCPU_OFFSET
 (()
__≥r_˝u_lﬂd
)

	)

36 
	#BOOT_PERCPU_OFFSET
 0

	)

39 
DEFINE_PER_CPU
(, 
this_˝u_off
Ë
BOOT_PERCPU_OFFSET
;

40 
EXPORT_PER_CPU_SYMBOL
(
this_˝u_off
);

42 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
 = {

43 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

45 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

54 #ifde‡
CONFIG_X86_64


55 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

57 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

60 #ifde‡
CONFIG_X86_32


71 
boﬁ
 
__öô
 
	$p˝u_√ed_numa
()

73 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


74 
pg_d©a_t
 *
œ°
 = 
NULL
;

75 
˝u
;

77 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

78 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

80 i‡(
	`node_⁄löe
(
node
Ë&& 
	`NODE_DATA
(node) &&

81 
œ°
 &&Üa° !
	`NODE_DATA
(
node
))

82  
åue
;

84 
œ°
 = 
	`NODE_DATA
(
node
);

87  
Ál£
;

88 
	}
}

104 * 
__öô
 
	$p˝u_Æloc_boŸmem
(
˝u
, 
size
,

105 
Æign
)

107 c⁄° 
gﬂl
 = 
	`__∑
(
MAX_DMA_ADDRESS
);

108 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


109 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

110 *
±r
;

112 i‡(!
	`node_⁄löe
(
node
Ë|| !
	`NODE_DATA
(node)) {

113 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

114 
	`¥_öfo
("cpu %d hasÇoÇode %d orÇode-local memory\n",

115 
˝u
, 
node
);

116 
	`¥_debug
("per cpu data for cpu%d %lu bytesát %016lx\n",

117 
˝u
, 
size
, 
	`__∑
(
±r
));

119 
±r
 = 
	`__Æloc_boŸmem_node_n›™ic
(
	`NODE_DATA
(
node
),

120 
size
, 
Æign
, 
gﬂl
);

121 
	`¥_debug
("per cpu data for cpu%d %lu bytes onÇode%dát %016lx\n",

122 
˝u
, 
size
, 
node
, 
	`__∑
(
±r
));

124  
±r
;

126  
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

128 
	}
}

133 * 
__öô
 
	$p˝u_fc_Æloc
(
˝u
, 
size_t
 
size
, size_à
Æign
)

135  
	`p˝u_Æloc_boŸmem
(
˝u
, 
size
, 
Æign
);

136 
	}
}

138 
__öô
 
	$p˝u_fc_‰ì
(*
±r
, 
size_t
 
size
)

140 
	`‰ì_boŸmem
(
	`__∑
(
±r
), 
size
);

141 
	}
}

143 
__öô
 
	$p˝u_˝u_di°™˚
(
‰om
, 
to
)

145 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


146 i‡(
	`óæy_˝u_to_node
(
‰om
Ë=óæy_˝u_to_node(
to
))

147  
LOCAL_DISTANCE
;

149  
REMOTE_DISTANCE
;

151  
LOCAL_DISTANCE
;

153 
	}
}

155 
__öô
 
	$p˝up_p›uœã_±e
(
addr
)

157 
	`p›uœã_exåa_±e
(
addr
);

158 
	}
}

160 
ölöe
 
	$£tup_≥r˝u_£gmít
(
˝u
)

162 #ifde‡
CONFIG_X86_32


163 
desc_°ru˘
 
gdt
;

165 
	`∑ck_des¸ùt‹
(&
gdt
, 
	`≥r_˝u_off£t
(
˝u
), 0xFFFFF,

166 0x2 | 
DESCTYPE_S
, 0x8);

167 
gdt
.
s
 = 1;

168 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
),

169 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

171 
	}
}

173 
__öô
 
	$£tup_≥r_˝u_¨ós
()

175 
˝u
;

176 
dñè
;

177 
rc
;

179 
	`¥_öfo
("NR_CPUS:%dÇr_cpumask_bits:%dÇr_cpu_ids:%dÇr_node_ids:%d\n",

180 
NR_CPUS
, 
ƒ_˝umask_bôs
, 
ƒ_˝u_ids
, 
ƒ_node_ids
);

188 #ifde‡
CONFIG_X86_32


189 i‡(
p˝u_cho£n_fc
 =
PCPU_FC_AUTO
 && 
	`p˝u_√ed_numa
())

190 
p˝u_cho£n_fc
 = 
PCPU_FC_PAGE
;

192 
rc
 = -
EINVAL
;

193 i‡(
p˝u_cho£n_fc
 !
PCPU_FC_PAGE
) {

194 c⁄° 
size_t
 
©om_size
 = 
˝u_has_p£
 ? 
PMD_SIZE
 : 
PAGE_SIZE
;

195 c⁄° 
size_t
 
dyn_size
 = 
PERCPU_MODULE_RESERVE
 +

196 
PERCPU_DYNAMIC_RESERVE
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

198 
rc
 = 
	`p˝u_embed_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

199 
dyn_size
, 
©om_size
,

200 
p˝u_˝u_di°™˚
,

201 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
);

202 i‡(
rc
 < 0)

203 
	`¥_w¨nög
("%sállocator failed (%d), falling backÅoÖage size\n",

204 
p˝u_fc_«mes
[
p˝u_cho£n_fc
], 
rc
);

206 i‡(
rc
 < 0)

207 
rc
 = 
	`p˝u_∑ge_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

208 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
,

209 
p˝up_p›uœã_±e
);

210 i‡(
rc
 < 0)

211 
	`∑nic
("ˇ¬Ÿ inôülizê≥r˝uáª®”º=%d)", 
rc
);

214 
dñè
 = ()
p˝u_ba£_addr
 - ()
__≥r_˝u_°¨t
;

215 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

216 
	`≥r_˝u_off£t
(
˝u
Ë
dñè
 + 
p˝u_unô_off£ts
[cpu];

217 
	`≥r_˝u
(
this_˝u_off
, 
˝u
Ë
	`≥r_˝u_off£t
(cpu);

218 
	`≥r_˝u
(
˝u_numbî
, 
˝u
) = cpu;

219 
	`£tup_≥r˝u_£gmít
(
˝u
);

220 
	`£tup_°ack_ˇ«ry_£gmít
(
˝u
);

228 #ifde‡
CONFIG_X86_LOCAL_APIC


229 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) =

230 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_≠icid
, 
˝u
);

231 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
) =

232 
	`óæy_≥r_˝u_m≠
(
x86_bios_˝u_≠icid
, 
˝u
);

234 #ifde‡
CONFIG_X86_64


235 
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
) =

236 
	`≥r_˝u
(
úq_°ack_uni⁄
.
úq_°ack
, 
˝u
) +

237 
IRQ_STACK_SIZE
 - 64;

238 #ifde‡
CONFIG_NUMA


239 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
) =

240 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_node_m≠
, 
˝u
);

247 i‡(
˝u
 =
boŸ_˝u_id
)

248 
	`swôch_to_√w_gdt
(
˝u
);

252 #ifde‡
CONFIG_X86_LOCAL_APIC


253 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
Ë
NULL
;

254 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
Ë
NULL
;

256 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

257 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
Ë
NULL
;

260 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

265 
	`≥r_˝u
(
node_numbî
, 
boŸ_˝u_id
Ë
	`˝u_to_node
(boot_cpu_id);

269 
	`£tup_node_to_˝umask_m≠
();

272 
	`£tup_˝u_loˇl_masks
();

273 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/smp.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/sig«l.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/waô.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/≥rs⁄Æôy.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/uc⁄ãxt.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/vdso.h
>

28 
	~<asm/m˚.h
>

30 #ifde‡
CONFIG_X86_64


31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/ü32_uni°d.h
>

35 
	~<asm/sysˇŒ.h
>

36 
	~<asm/sysˇŒs.h
>

38 
	~<asm/sig‰ame.h
>

40 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

42 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

43 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

44 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

45 
X86_EFLAGS_CF
)

	)

47 #ifde‡
CONFIG_X86_32


48 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

50 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

53 
	#COPY
(
x
) do { \

54 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

55 } 0)

	)

57 
	#GET_SEG
(
£g
) ({ \

58 
tmp
; \

59 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

60 
tmp
; \

61 })

	)

63 
	#COPY_SEG
(
£g
) do { \

64 
ªgs
->
£g
 = 
	`GET_SEG
(seg); \

65 } 0)

	)

67 
	#COPY_SEG_CPL3
(
£g
) do { \

68 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

69 } 0)

	)

72 
	$ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
, 
sigc⁄ãxt
 
__u£r
 *
sc
,

73 *
∑x
)

75 
__u£r
 *
buf
;

76 
tmpÊags
;

77 
îr
 = 0;

80 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

82 
gë_u£r_åy
 {

84 #ifde‡
CONFIG_X86_32


85 
	`£t_u£r_gs
(
ªgs
, 
	`GET_SEG
(
gs
));

86 
	`COPY_SEG
(
fs
);

87 
	`COPY_SEG
(
es
);

88 
	`COPY_SEG
(
ds
);

91 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

92 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

94 #ifde‡
CONFIG_X86_64


95 
	`COPY
(
r8
);

96 
	`COPY
(
r9
);

97 
	`COPY
(
r10
);

98 
	`COPY
(
r11
);

99 
	`COPY
(
r12
);

100 
	`COPY
(
r13
);

101 
	`COPY
(
r14
);

102 
	`COPY
(
r15
);

105 #ifde‡
CONFIG_X86_32


106 
	`COPY_SEG_CPL3
(
cs
);

107 
	`COPY_SEG_CPL3
(
ss
);

112 
	`COPY_SEG_CPL3
(
cs
);

115 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

116 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

117 
ªgs
->
‹ig_ax
 = -1;

119 
	`gë_u£r_ex
(
buf
, &
sc
->
Â°©e
);

120 
îr
 |
	`ª°‹e_i387_x°©e
(
buf
);

122 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

129 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, __u£∏*
Â°©e
,

130 
±_ªgs
 *
ªgs
, 
mask
)

132 
îr
 = 0;

134 
put_u£r_åy
 {

136 #ifde‡
CONFIG_X86_32


137 
	`put_u£r_ex
(
	`gë_u£r_gs
(
ªgs
), (
__u£r
 *)&
sc
->
gs
);

138 
	`put_u£r_ex
(
ªgs
->
fs
, (
__u£r
 *)&
sc
->fs);

139 
	`put_u£r_ex
(
ªgs
->
es
, (
__u£r
 *)&
sc
->es);

140 
	`put_u£r_ex
(
ªgs
->
ds
, (
__u£r
 *)&
sc
->ds);

143 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

144 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

145 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

146 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

147 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

148 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

149 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

150 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

151 #ifde‡
CONFIG_X86_64


152 
	`put_u£r_ex
(
ªgs
->
r8
, &
sc
->r8);

153 
	`put_u£r_ex
(
ªgs
->
r9
, &
sc
->r9);

154 
	`put_u£r_ex
(
ªgs
->
r10
, &
sc
->r10);

155 
	`put_u£r_ex
(
ªgs
->
r11
, &
sc
->r11);

156 
	`put_u£r_ex
(
ªgs
->
r12
, &
sc
->r12);

157 
	`put_u£r_ex
(
ªgs
->
r13
, &
sc
->r13);

158 
	`put_u£r_ex
(
ªgs
->
r14
, &
sc
->r14);

159 
	`put_u£r_ex
(
ªgs
->
r15
, &
sc
->r15);

162 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

163 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

164 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

165 #ifde‡
CONFIG_X86_32


166 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

167 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

168 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

169 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

171 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

172 
	`put_u£r_ex
(
ªgs
->
cs
, &
sc
->cs);

173 
	`put_u£r_ex
(0, &
sc
->
gs
);

174 
	`put_u£r_ex
(0, &
sc
->
fs
);

177 
	`put_u£r_ex
(
Â°©e
, &
sc
->fpstate);

180 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

181 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

182 } 
	`put_u£r_ˇtch
(
îr
);

184  
îr
;

185 
	}
}

194 
	$Æign_sig‰ame
(
•
)

196 #ifde‡
CONFIG_X86_32


201 
•
 = ((sp + 4) & -16ul) - 4;

203 
•
 = 
	`round_down
(sp, 16) - 8;

205  
•
;

206 
	}
}

208 
ölöe
 
__u£r
 *

209 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
size_t
 
‰ame_size
,

210 
__u£r
 **
Â°©e
)

213 
•
 = 
ªgs
->sp;

214 
⁄sig°ack
 = 
	`⁄_sig_°ack
(
•
);

216 #ifde‡
CONFIG_X86_64


218 
•
 -= 128;

221 i‡(!
⁄sig°ack
) {

223 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

224 i‡(
cuºít
->
ßs_ss_size
)

225 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

227 #ifde‡
CONFIG_X86_32


229 i‡((
ªgs
->
ss
 & 0xffffË!
__USER_DS
 &&

230 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

231 
ka
->
ß
.
ß_ª°‹î
)

232 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

237 i‡(
	`u£d_m©h
()) {

238 
•
 -
sig_x°©e_size
;

239 #ifde‡
CONFIG_X86_64


240 
•
 = 
	`round_down
(sp, 64);

242 *
Â°©e
 = (
__u£r
 *)
•
;

245 
•
 = 
	`Æign_sig‰ame
(• - 
‰ame_size
);

251 i‡(
⁄sig°ack
 && !
	`likñy
(
	`⁄_sig_°ack
(
•
)))

252  (
__u£r
 *)-1L;

255 i‡(
	`u£d_m©h
(Ë&& 
	`ßve_i387_x°©e
(*
Â°©e
) < 0)

256  (
__u£r
 *)-1L;

258  (
__u£r
 *)
•
;

259 
	}
}

261 #ifde‡
CONFIG_X86_32


263 
u16
 
	mp›lmovl
;

264 
u32
 
	mvÆ
;

265 
u16
 
	möt80
;

266 } 
__©åibuã__
((
∑cked
)Ë
	gªtcode
 = {

268 
__NR_sigªtu∫
,

273 
u8
 
	mmovl
;

274 
u32
 
	mvÆ
;

275 
u16
 
	möt80
;

276 
u8
 
	m∑d
;

277 } 
__©åibuã__
((
∑cked
)Ë
	gπ_ªtcode
 = {

279 
__NR_π_sigªtu∫
,

285 
	$__£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

286 
±_ªgs
 *
ªgs
)

288 
sig‰ame
 
__u£r
 *
‰ame
;

289 
__u£r
 *
ª°‹î
;

290 
îr
 = 0;

291 
__u£r
 *
Â°©e
 = 
NULL
;

293 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

295 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

296  -
EFAULT
;

298 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

299  -
EFAULT
;

301 i‡(
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

302  -
EFAULT
;

304 i‡(
_NSIG_WORDS
 > 1) {

305 i‡(
	`__c›y_to_u£r
(&
‰ame
->
exåamask
, &
£t
->
sig
[1],

306 (
‰ame
->
exåamask
)))

307  -
EFAULT
;

310 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

311 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
sigªtu∫
);

313 
ª°‹î
 = &
‰ame
->
ªtcode
;

314 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

315 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

318 
îr
 |
	`__put_u£r
(
ª°‹î
, &
‰ame
->
¥ëcode
);

327 
îr
 |
	`__put_u£r
(*((
u64
 *)&
ªtcode
), (u64 *)
‰ame
->retcode);

329 i‡(
îr
)

330  -
EFAULT
;

333 
ªgs
->
•
 = ()
‰ame
;

334 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

335 
ªgs
->
ax
 = ()
sig
;

336 
ªgs
->
dx
 = 0;

337 
ªgs
->
cx
 = 0;

339 
ªgs
->
ds
 = 
__USER_DS
;

340 
ªgs
->
es
 = 
__USER_DS
;

341 
ªgs
->
ss
 = 
__USER_DS
;

342 
ªgs
->
cs
 = 
__USER_CS
;

345 
	}
}

347 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

348 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

350 
π_sig‰ame
 
__u£r
 *
‰ame
;

351 
__u£r
 *
ª°‹î
;

352 
îr
 = 0;

353 
__u£r
 *
Â°©e
 = 
NULL
;

355 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

357 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

358  -
EFAULT
;

360 
put_u£r_åy
 {

361 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

362 
	`put_u£r_ex
(&
‰ame
->
öfo
, &‰ame->
pöfo
);

363 
	`put_u£r_ex
(&
‰ame
->
uc
, &‰ame->
puc
);

364 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

367 i‡(
˝u_has_xßve
)

368 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

370 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

371 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

372 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

373 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

374 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

375 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

376 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

377 
ªgs
, 
£t
->
sig
[0]);

378 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

381 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
π_sigªtu∫
);

382 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

383 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

384 
	`put_u£r_ex
(
ª°‹î
, &
‰ame
->
¥ëcode
);

393 
	`put_u£r_ex
(*((
u64
 *)&
π_ªtcode
), (u64 *)
‰ame
->
ªtcode
);

394 } 
	`put_u£r_ˇtch
(
îr
);

396 i‡(
îr
)

397  -
EFAULT
;

400 
ªgs
->
•
 = ()
‰ame
;

401 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

402 
ªgs
->
ax
 = ()
sig
;

403 
ªgs
->
dx
 = ()&
‰ame
->
öfo
;

404 
ªgs
->
cx
 = ()&
‰ame
->
uc
;

406 
ªgs
->
ds
 = 
__USER_DS
;

407 
ªgs
->
es
 = 
__USER_DS
;

408 
ªgs
->
ss
 = 
__USER_DS
;

409 
ªgs
->
cs
 = 
__USER_CS
;

412 
	}
}

414 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

415 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

417 
π_sig‰ame
 
__u£r
 *
‰ame
;

418 
__u£r
 *
Â
 = 
NULL
;

419 
îr
 = 0;

420 
èsk_°ru˘
 *
me
 = 
cuºít
;

422 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (
π_sig‰ame
), &
Â
);

424 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

425  -
EFAULT
;

427 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
) {

428 i‡(
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info))

429  -
EFAULT
;

432 
put_u£r_åy
 {

434 i‡(
˝u_has_xßve
)

435 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

437 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

438 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

439 
	`put_u£r_ex
(
me
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

440 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

441 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

442 
	`put_u£r_ex
(
me
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

443 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â
, 
ªgs
, 
£t
->
sig
[0]);

444 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

449 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

450 
	`put_u£r_ex
(
ka
->
ß
.
ß_ª°‹î
, &
‰ame
->
¥ëcode
);

453 
îr
 |-
EFAULT
;

455 } 
	`put_u£r_ˇtch
(
îr
);

457 i‡(
îr
)

458  -
EFAULT
;

461 
ªgs
->
di
 = 
sig
;

463 
ªgs
->
ax
 = 0;

467 
ªgs
->
si
 = ()&
‰ame
->
öfo
;

468 
ªgs
->
dx
 = ()&
‰ame
->
uc
;

469 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

471 
ªgs
->
•
 = ()
‰ame
;

475 
ªgs
->
cs
 = 
__USER_CS
;

478 
	}
}

481 #ifde‡
CONFIG_X86_32


485 
asmlökage
 

486 
	$sys_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

488 
mask
 &
_BLOCKABLE
;

489 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

490 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

491 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

492 
	`ªˇlc_sig≥ndög
();

493 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

495 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

496 
	`scheduÀ
();

497 
	`£t_ª°‹e_sigmask
();

499  -
ERESTARTNOHAND
;

500 
	}
}

502 
asmlökage
 

503 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

504 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

506 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

507 
ªt
 = 0;

509 i‡(
a˘
) {

510 
ﬁd_sig£t_t
 
mask
;

512 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)))

513  -
EFAULT
;

515 
gë_u£r_åy
 {

516 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler);

517 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

518 
	`gë_u£r_ex
(
mask
, &
a˘
->
ß_mask
);

519 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer);

520 } 
	`gë_u£r_ˇtch
(
ªt
);

522 i‡(
ªt
)

523  -
EFAULT
;

524 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

527 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

529 i‡(!
ªt
 && 
ﬂ˘
) {

530 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)))

531  -
EFAULT
;

533 
put_u£r_åy
 {

534 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler);

535 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

536 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

537 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer);

538 } 
	`put_u£r_ˇtch
(
ªt
);

540 i‡(
ªt
)

541  -
EFAULT
;

544  
ªt
;

545 
	}
}

549 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
,

550 
±_ªgs
 *
ªgs
)

552  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

553 
	}
}

558 #ifde‡
CONFIG_X86_32


559 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

561 
sig‰ame
 
__u£r
 *
‰ame
;

562 
ax
;

563 
sig£t_t
 
£t
;

565 
‰ame
 = (
sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - 8);

567 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

568 
bad‰ame
;

569 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
Ë|| (
_NSIG_WORDS
 > 1

570 && 
	`__c›y_‰om_u£r
(&
£t
.
sig
[1], &
‰ame
->
exåamask
,

571 (
‰ame
->
exåamask
))))

572 
bad‰ame
;

574 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

575 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

576 
cuºít
->
blocked
 = 
£t
;

577 
	`ªˇlc_sig≥ndög
();

578 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

580 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

581 
bad‰ame
;

582  
ax
;

584 
bad‰ame
:

585 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "sigreturn");

588 
	}
}

591 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

593 
π_sig‰ame
 
__u£r
 *
‰ame
;

594 
ax
;

595 
sig£t_t
 
£t
;

597 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - ());

598 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

599 
bad‰ame
;

600 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

601 
bad‰ame
;

603 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

604 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

605 
cuºít
->
blocked
 = 
£t
;

606 
	`ªˇlc_sig≥ndög
();

607 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

609 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

610 
bad‰ame
;

612 i‡(
	`do_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
•
Ë=-
EFAULT
)

613 
bad‰ame
;

615  
ax
;

617 
bad‰ame
:

618 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "rt_sigreturn");

620 
	}
}

625 
	$sigƒ_c⁄vît
(
sig
)

627 #ifde‡
CONFIG_X86_32


628 
thªad_öfo
 *
öfo
 = 
	`cuºít_thªad_öfo
();

630 i‡(
öfo
->
exec_domaö
 && info->exec_domaö->
sig«l_övm≠
 && 
sig
 < 32)

631  
öfo
->
exec_domaö
->
sig«l_övm≠
[
sig
];

633  
sig
;

634 
	}
}

636 #ifde‡
CONFIG_X86_32


638 
	#is_ü32
 1

	)

639 
	#ü32_£tup_‰ame
 
__£tup_‰ame


	)

640 
	#ü32_£tup_π_‰ame
 
__£tup_π_‰ame


	)

644 #ifde‡
CONFIG_IA32_EMULATION


645 
	#is_ü32
 
	`ã°_thªad_Êag
(
TIF_IA32
)

	)

647 
	#is_ü32
 0

	)

650 
ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

651 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

652 
ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

653 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

658 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

659 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

661 
usig
 = 
	`sigƒ_c⁄vît
(
sig
);

662 
ªt
;

665 i‡(
is_ü32
) {

666 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

667 
ªt
 = 
	`ü32_£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

669 
ªt
 = 
	`ü32_£tup_‰ame
(
usig
, 
ka
, 
£t
, 
ªgs
);

671 
ªt
 = 
	`__£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

673 i‡(
ªt
) {

674 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

675  -
EFAULT
;

678  
ªt
;

679 
	}
}

682 
	$h™dÀ_sig«l
(
sig
, 
sigöfo_t
 *
öfo
, 
k_siga˘i⁄
 *
ka
,

683 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
)

685 
ªt
;

688 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

690 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

691 -
ERESTART_RESTARTBLOCK
:

692 -
ERESTARTNOHAND
:

693 
ªgs
->
ax
 = -
EINTR
;

696 -
ERESTARTSYS
:

697 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

698 
ªgs
->
ax
 = -
EINTR
;

702 -
ERESTARTNOINTR
:

703 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

704 
ªgs
->
ù
 -= 2;

713 i‡(
	`u∆ikñy
(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
) &&

714 
	`likñy
(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_FORCED_TF
)))

715 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

717 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

719 i‡(
ªt
)

720  
ªt
;

722 #ifde‡
CONFIG_X86_64


728 
	`£t_fs
(
USER_DS
);

734 
ªgs
->
Êags
 &~
X86_EFLAGS_DF
;

742 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

744 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

745 
	`sig‹£ts
(&
cuºít
->
blocked
, &cuºít->blocked, &
ka
->
ß
.
ß_mask
);

746 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

747 
	`sigadd£t
(&
cuºít
->
blocked
, 
sig
);

748 
	`ªˇlc_sig≥ndög
();

749 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

751 
	`åa˚hook_sig«l_h™dÀr
(
sig
, 
öfo
, 
ka
, 
ªgs
,

752 
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
));

755 
	}
}

757 #ifde‡
CONFIG_X86_32


758 
	#NR_ª°¨t_sysˇŒ
 
__NR_ª°¨t_sysˇŒ


	)

760 
	#NR_ª°¨t_sysˇŒ
 \

761 
	`ã°_thªad_Êag
(
TIF_IA32
Ë? 
__NR_ü32_ª°¨t_sysˇŒ
 : 
__NR_ª°¨t_sysˇŒ


	)

769 
	$do_sig«l
(
±_ªgs
 *
ªgs
)

771 
k_siga˘i⁄
 
ka
;

772 
sigöfo_t
 
öfo
;

773 
sigƒ
;

774 
sig£t_t
 *
ﬁd£t
;

783 i‡(!
	`u£r_mode
(
ªgs
))

786 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
)

787 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

789 
ﬁd£t
 = &
cuºít
->
blocked
;

791 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

792 i‡(
sigƒ
 > 0) {

794 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
öfo
, &
ka
, 
ﬁd£t
, 
ªgs
) == 0) {

801 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

807 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

809 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

810 -
ERESTARTNOHAND
:

811 -
ERESTARTSYS
:

812 -
ERESTARTNOINTR
:

813 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

814 
ªgs
->
ù
 -= 2;

817 -
ERESTART_RESTARTBLOCK
:

818 
ªgs
->
ax
 = 
NR_ª°¨t_sysˇŒ
;

819 
ªgs
->
ù
 -= 2;

828 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
) {

829 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

830 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

832 
	}
}

839 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, *
unu£d
, 
__u32
 
thªad_öfo_Êags
)

841 #ifde‡
CONFIG_X86_MCE


843 i‡(
thªad_öfo_Êags
 & 
_TIF_MCE_NOTIFY
)

844 
	`m˚_nŸify_¥o˚ss
();

848 i‡(
thªad_öfo_Êags
 & 
_TIF_SIGPENDING
)

849 
	`do_sig«l
(
ªgs
);

851 i‡(
thªad_öfo_Êags
 & 
_TIF_NOTIFY_RESUME
) {

852 
	`˛ór_thªad_Êag
(
TIF_NOTIFY_RESUME
);

853 
	`åa˚hook_nŸify_ªsume
(
ªgs
);

854 i‡(
cuºít
->
ª∂a˚mít_£ssi⁄_keyrög
)

855 
	`key_ª∂a˚_£ssi⁄_keyrög
();

857 i‡(
thªad_öfo_Êags
 & 
_TIF_USER_RETURN_NOTIFY
)

858 
	`fúe_u£r_ªtu∫_nŸifõrs
();

860 #ifde‡
CONFIG_X86_32


861 
	`˛ór_thªad_Êag
(
TIF_IRET
);

863 
	}
}

865 
	$sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
)

867 
èsk_°ru˘
 *
me
 = 
cuºít
;

869 i‡(
show_unh™dÀd_sig«ls
 && 
	`¥ötk_øãlimô
()) {

870 
	`¥ötk
("%s"

872 
	`èsk_pid_ƒ
(
cuºít
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

873 
me
->
comm
, me->
pid
, 
whîe
, 
‰ame
,

874 
ªgs
->
ù
,Ñegs->
•
,Ñegs->
‹ig_ax
);

875 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

876 
	`¥ötk
(
KERN_CONT
 "\n");

879 
	`f‹˚_sig
(
SIGSEGV
, 
me
);

880 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/mc146818πc.h
>

21 
	~<löux/ˇche.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/˝u.h
>

25 
	~<asm/mår.h
>

26 
	~<asm/ébÊush.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/≠ic.h
>

114 
	$«tive_smp_£nd_ªscheduÀ
(
˝u
)

116 i‡(
	`u∆ikñy
(
	`˝u_is_ofÊöe
(
˝u
))) {

117 
	`WARN_ON
(1);

120 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
RESCHEDULE_VECTOR
);

121 
	}
}

123 
	$«tive_£nd_ˇŒ_func_sögÀ_ùi
(
˝u
)

125 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
CALL_FUNCTION_SINGLE_VECTOR
);

126 
	}
}

128 
	$«tive_£nd_ˇŒ_func_ùi
(c⁄° 
˝umask
 *
mask
)

130 
˝umask_v¨_t
 
Ælbut£lf
;

132 i‡(!
	`Æloc_˝umask_v¨
(&
Ælbut£lf
, 
GFP_ATOMIC
)) {

133 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

137 
	`˝umask_c›y
(
Ælbut£lf
, 
˝u_⁄löe_mask
);

138 
	`˝umask_˛ór_˝u
(
	`smp_¥o˚ss‹_id
(), 
Ælbut£lf
);

140 i‡(
	`˝umask_equÆ
(
mask
, 
Ælbut£lf
) &&

141 
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
˝u_ˇŒout_mask
))

142 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
CALL_FUNCTION_VECTOR
);

144 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

146 
	`‰ì_˝umask_v¨
(
Ælbut£lf
);

147 
	}
}

153 
asmlökage
 
	$smp_ªboŸ_öãºu±
()

155 
	`ack_APIC_úq
();

156 
	`úq_íãr
();

157 
	`°›_this_˝u
(
NULL
);

158 
	`úq_exô
();

159 
	}
}

161 
	$«tive_smp_£nd_°›
()

163 
Êags
;

164 
waô
;

166 i‡(
ªboŸ_f‹˚
)

178 i‡(
	`num_⁄löe_˝us
() > 1) {

179 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
REBOOT_VECTOR
);

182 
waô
 = 
USEC_PER_SEC
;

183 
	`num_⁄löe_˝us
(Ë> 1 && 
waô
--)

184 
	`udñay
(1);

187 
	`loˇl_úq_ßve
(
Êags
);

188 
	`dißbÀ_loˇl_APIC
();

189 
	`loˇl_úq_ª°‹e
(
Êags
);

190 
	}
}

197 
	$smp_ªscheduÀ_öãºu±
(
±_ªgs
 *
ªgs
)

199 
	`ack_APIC_úq
();

200 
	`öc_úq_°©
(
úq_ªsched_cou¡
);

204 
	}
}

206 
	$smp_ˇŒ_fun˘i⁄_öãºu±
(
±_ªgs
 *
ªgs
)

208 
	`ack_APIC_úq
();

209 
	`úq_íãr
();

210 
	`gíîic_smp_ˇŒ_fun˘i⁄_öãºu±
();

211 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

212 
	`úq_exô
();

213 
	}
}

215 
	$smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
(
±_ªgs
 *
ªgs
)

217 
	`ack_APIC_úq
();

218 
	`úq_íãr
();

219 
	`gíîic_smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
();

220 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

221 
	`úq_exô
();

222 
	}
}

224 
smp_›s
 
	gsmp_›s
 = {

225 .
smp_¥ï¨e_boŸ_˝u
 = 
«tive_smp_¥ï¨e_boŸ_˝u
,

226 .
	gsmp_¥ï¨e_˝us
 = 
«tive_smp_¥ï¨e_˝us
,

227 .
	gsmp_˝us_d⁄e
 = 
«tive_smp_˝us_d⁄e
,

229 .
	gsmp_£nd_°›
 = 
«tive_smp_£nd_°›
,

230 .
	gsmp_£nd_ªscheduÀ
 = 
«tive_smp_£nd_ªscheduÀ
,

232 .
	g˝u_up
 = 
«tive_˝u_up
,

233 .
	g˝u_dõ
 = 
«tive_˝u_dõ
,

234 .
	g˝u_dißbÀ
 = 
«tive_˝u_dißbÀ
,

235 .
	g∂ay_dód
 = 
«tive_∂ay_dód
,

237 .
	g£nd_ˇŒ_func_ùi
 = 
«tive_£nd_ˇŒ_func_ùi
,

238 .
	g£nd_ˇŒ_func_sögÀ_ùi
 = 
«tive_£nd_ˇŒ_func_sögÀ_ùi
,

240 
EXPORT_SYMBOL_GPL
(
smp_›s
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<löux/öô.h
>

43 
	~<löux/smp.h
>

44 
	~<löux/moduÀ.h
>

45 
	~<löux/sched.h
>

46 
	~<löux/≥r˝u.h
>

47 
	~<löux/boŸmem.h
>

48 
	~<löux/îr.h
>

49 
	~<löux/nmi.h
>

50 
	~<löux/tboŸ.h
>

52 
	~<asm/a˝i.h
>

53 
	~<asm/desc.h
>

54 
	~<asm/nmi.h
>

55 
	~<asm/úq.h
>

56 
	~<asm/idÀ.h
>

57 
	~<asm/åampﬁöe.h
>

58 
	~<asm/˝u.h
>

59 
	~<asm/numa.h
>

60 
	~<asm/pgèbÀ.h
>

61 
	~<asm/ébÊush.h
>

62 
	~<asm/mår.h
>

63 
	~<asm/vmi.h
>

64 
	~<asm/≠ic.h
>

65 
	~<asm/£tup.h
>

66 
	~<asm/uv/uv.h
>

67 
	~<löux/mc146818πc.h
>

69 
	~<asm/smpboŸ_hooks.h
>

71 #ifde‡
CONFIG_X86_32


72 
u8
 
	g≠icid_2_node
[
MAX_APICID
];

73 
	glow_m≠pögs
;

77 
DEFINE_PER_CPU
(, 
˝u_°©e
) = { 0 };

83 #ifde‡
CONFIG_HOTPLUG_CPU


88 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
idÀ_thªad_¨øy
);

89 
	#gë_idÀ_f‹_˝u
(
x
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, x))

	)

90 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, xË’))

	)

92 
èsk_°ru˘
 *
	gidÀ_thªad_¨øy
[
NR_CPUS
] 
	g__˝uöôd©a
 ;

93 
	#gë_idÀ_f‹_˝u
(
x
Ë(
idÀ_thªad_¨øy
[(x)])

	)

94 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
idÀ_thªad_¨øy
[(x)] = (p))

	)

98 
	gsmp_num_siblögs
 = 1;

99 
EXPORT_SYMBOL
(
smp_num_siblögs
);

102 
DEFINE_PER_CPU
(
u16
, 
˝u_Œc_id
Ë
BAD_APICID
;

105 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_siblög_m≠
);

106 
EXPORT_PER_CPU_SYMBOL
(
˝u_siblög_m≠
);

109 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_c‹e_m≠
);

110 
EXPORT_PER_CPU_SYMBOL
(
˝u_c‹e_m≠
);

113 
DEFINE_PER_CPU_SHARED_ALIGNED
(
˝uöfo_x86
, 
˝u_öfo
);

114 
EXPORT_PER_CPU_SYMBOL
(
˝u_öfo
);

116 
©omic_t
 
	göô_dós£πed
;

118 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_32
)

120 
	g˝u_to_node_m≠
[
NR_CPUS
] 
	g__ªad_mo°ly
 = { [0 ... NR_CPUS-1] = 0 };

121 
EXPORT_SYMBOL
(
˝u_to_node_m≠
);

124 
	$m≠_˝u_to_node
(
˝u
, 
node
)

126 
	`¥ötk
(
KERN_INFO
 "M≠pög cpu %dÅÿnodê%d\n", 
˝u
, 
node
);

127 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

128 
˝u_to_node_m≠
[
˝u
] = 
node
;

129 
	}
}

132 
	$unm≠_˝u_to_node
(
˝u
)

134 
node
;

136 
	`¥ötk
(
KERN_INFO
 "Unm≠pög cpu %d fromáŒÇodes\n", 
˝u
);

137 
node
 = 0;Çodê< 
MAX_NUMNODES
;Çode++)

138 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

139 
˝u_to_node_m≠
[
˝u
] = 0;

140 
	}
}

142 
	#m≠_˝u_to_node
(
˝u
, 
node
Ë({})

	)

143 
	#unm≠_˝u_to_node
(
˝u
Ë({})

	)

146 #ifde‡
CONFIG_X86_32


147 
	gboŸ_˝u_logiˇl_≠icid
;

149 
u8
 
	g˝u_2_logiˇl_≠icid
[
NR_CPUS
] 
	g__ªad_mo°ly
 =

150 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

152 
	$m≠_˝u_to_logiˇl_≠icid
()

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

156 
node
 = 
≠ic
->
	`≠icid_to_node
(
≠icid
);

158 i‡(!
	`node_⁄löe
(
node
))

159 
node
 = 
fú°_⁄löe_node
;

161 
˝u_2_logiˇl_≠icid
[
˝u
] = 
≠icid
;

162 
	`m≠_˝u_to_node
(
˝u
, 
node
);

163 
	}
}

165 
	$numa_ªmove_˝u
(
˝u
)

167 
˝u_2_logiˇl_≠icid
[
˝u
] = 
BAD_APICID
;

168 
	`unm≠_˝u_to_node
(
˝u
);

169 
	}
}

171 
	#m≠_˝u_to_logiˇl_≠icid
(Ëdÿ{} 0)

	)

178 
__˝uöô
 
	$smp_ˇŒö
()

180 
˝uid
, 
phys_id
;

181 
timeout
;

189 i‡(
≠ic
->
waô_f‹_öô_dós£π
)

190 
≠ic
->
	`waô_f‹_öô_dós£π
(&
öô_dós£πed
);

195 
phys_id
 = 
	`ªad_≠ic_id
();

196 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

197 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒö_mask
)) {

198 
	`∑nic
("%s:Öhy†CPU#%d, CPU#%dáÃódyÖª£¡??\n", 
__func__
,

199 
phys_id
, 
˝uid
);

201 
	`¥_debug
("CPU#%d (phy†ID: %dËwaôög f‹ CALLOUT\n", 
˝uid
, 
phys_id
);

214 
timeout
 = 
jiffõs
 + 2*
HZ
;

215 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

219 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒout_mask
))

221 
	`˝u_ªœx
();

224 i‡(!
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

225 
	`∑nic
("%s: CPU%d started up but didÇot getá callout!\n",

226 
__func__
, 
˝uid
);

236 
	`¥_debug
("CALLIN, before setup_local_APIC().\n");

237 i‡(
≠ic
->
smp_ˇŒö_˛ór_loˇl_≠ic
)

238 
≠ic
->
	`smp_ˇŒö_˛ór_loˇl_≠ic
();

239 
	`£tup_loˇl_APIC
();

240 
	`íd_loˇl_APIC_£tup
();

241 
	`m≠_˝u_to_logiˇl_≠icid
();

243 
	`nŸify_˝u_°¨tög
(
˝uid
);

250 
	`loˇl_úq_íabÀ
();

251 
	`ˇlibøã_dñay
();

252 
	`loˇl_úq_dißbÀ
();

253 
	`¥_debug
("Sèckáàabouà%p\n", &
˝uid
);

258 
	`smp_°‹e_˝u_öfo
(
˝uid
);

263 
	`˝umask_£t_˝u
(
˝uid
, 
˝u_ˇŒö_mask
);

264 
	}
}

269 
nŸø˚
 
__˝uöô
 
	$°¨t_£c⁄d¨y
(*
unu£d
)

276 
	`vmi_brögup
();

277 
	`˝u_öô
();

278 
	`¥ìm±_dißbÀ
();

279 
	`smp_ˇŒö
();

282 
	`b¨rõr
();

286 
	`check_tsc_sync_èrgë
();

288 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

289 
	`dißbÀ_8259A_úq
(0);

290 
	`íabÀ_NMI_through_LVT0
();

291 
	`íabÀ_8259A_úq
(0);

294 #ifde‡
CONFIG_X86_32


295 
low_m≠pögs
)

296 
	`˝u_ªœx
();

297 
	`__Êush_éb_Æl
();

301 
	`£t_˝u_siblög_m≠
(
	`øw_smp_¥o˚ss‹_id
());

302 
	`wmb
();

316 
	`ùi_ˇŒ_lock
();

317 
	`lock_ve˘‹_lock
();

318 
	`__£tup_ve˘‹_úq
(
	`smp_¥o˚ss‹_id
());

319 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
åue
);

320 
	`u∆ock_ve˘‹_lock
();

321 
	`ùi_ˇŒ_u∆ock
();

322 
	`≥r_˝u
(
˝u_°©e
, 
	`smp_¥o˚ss‹_id
()Ë
CPU_ONLINE
;

325 
	`loˇl_úq_íabÀ
();

327 
x86_˝uöô
.
	`£tup_≥r˝u_˛ockev
();

329 
	`wmb
();

330 
	`˝u_idÀ
();

331 
	}
}

333 #ifde‡
CONFIG_CPUMASK_OFFSTACK


335 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

336 c⁄° 
˝uöfo_x86
 *
§c
)

338 
˝umask
 *
Œc
 = 
d°
->
Œc_sh¨ed_m≠
;

339 *
d°
 = *
§c
;

340 
d°
->
Œc_sh¨ed_m≠
 = 
Œc
;

341 
	}
}

343 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

344 c⁄° 
˝uöfo_x86
 *
§c
)

346 *
d°
 = *
§c
;

347 
	}
}

355 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
id
)

357 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
id
);

359 
	`c›y_˝uöfo_x86
(
c
, &
boŸ_˝u_d©a
);

360 
c
->
˝u_ödex
 = 
id
;

361 i‡(
id
 != 0)

362 
	`idítify_£c⁄d¨y_˝u
(
c
);

363 
	}
}

366 
__˝uöô
 
	$£t_˝u_siblög_m≠
(
˝u
)

368 
i
;

369 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

371 
	`˝umask_£t_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

373 i‡(
smp_num_siblögs
 > 1) {

374 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

375 
˝uöfo_x86
 *
o
 = &
	`˝u_d©a
(
i
);

377 i‡(
c
->
phys_¥oc_id
 =
o
->phys_proc_id &&

378 
c
->
˝u_c‹e_id
 =
o
->cpu_core_id) {

379 
	`˝umask_£t_˝u
(
i
, 
	`˝u_siblög_mask
(
˝u
));

380 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(
i
));

381 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

382 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

383 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

384 
	`˝umask_£t_˝u
(
˝u
, 
o
->
Œc_sh¨ed_m≠
);

388 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(cpu));

391 
	`˝umask_£t_˝u
(
˝u
, 
c
->
Œc_sh¨ed_m≠
);

393 i‡(
cuºít_˝u_d©a
.
x86_max_c‹es
 == 1) {

394 
	`˝umask_c›y
(
	`˝u_c‹e_mask
(
˝u
), 
	`˝u_siblög_mask
(cpu));

395 
c
->
boŸed_c‹es
 = 1;

399 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

400 i‡(
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë!
BAD_APICID
 &&

401 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë=≥r_˝u(˝u_Œc_id, 
i
)) {

402 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

403 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

405 i‡(
c
->
phys_¥oc_id
 =
	`˝u_d©a
(
i
).phys_proc_id) {

406 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

407 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

411 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1) {

416 i‡(
	`˝umask_fú°
(
	`˝u_siblög_mask
(
i
)) == i)

417 
c
->
boŸed_c‹es
++;

422 i‡(
i
 !
˝u
)

423 
	`˝u_d©a
(
i
).
boŸed_c‹es
++;

424 } i‡(
i
 !
˝u
 && !
c
->
boŸed_c‹es
)

425 
c
->
boŸed_c‹es
 = 
	`˝u_d©a
(
i
).booted_cores;

428 
	}
}

431 c⁄° 
˝umask
 *
	$˝u_c‹egroup_mask
(
˝u
)

433 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

438 i‡((
sched_mc_powî_ßvögs
 || 
sched_smt_powî_ßvögs
) &&

439 !(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
)))

440  
	`˝u_c‹e_mask
(
˝u
);

442  
c
->
Œc_sh¨ed_m≠
;

443 
	}
}

445 
	$im¥ess_‰õnds
()

447 
˝u
;

448 
bogosum
 = 0;

452 
	`¥_debug
("Before bogomips.\n");

453 
	`f‹_óch_possibÀ_˝u
(
˝u
)

454 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒout_mask
))

455 
bogosum
 +
	`˝u_d©a
(
˝u
).
lo›s_≥r_jiffy
;

456 
	`¥ötk
(
KERN_INFO


458 
	`num_⁄löe_˝us
(),

459 
bogosum
/(500000/
HZ
),

460 (
bogosum
/(5000/
HZ
))%100);

462 
	`¥_debug
("Before bogocount - settingáctivated=1.\n");

463 
	}
}

465 
	$__öquúe_ªmŸe_≠ic
(
≠icid
)

467 
i
, 
ªgs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

468 *
«mes
[] = { "ID", "VERSION", "SPIV" };

469 
timeout
;

470 
u32
 
°©us
;

472 
	`¥ötk
(
KERN_INFO
 "InquúögÑemŸêAPIC 0x%x...\n", 
≠icid
);

474 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªgs
); i++) {

475 
	`¥ötk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
≠icid
, 
«mes
[
i
]);

480 
°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

481 i‡(
°©us
)

482 
	`¥ötk
(
KERN_CONT


485 
	`≠ic_i¸_wrôe
(
APIC_DM_REMRD
 | 
ªgs
[
i
], 
≠icid
);

487 
timeout
 = 0;

489 
	`udñay
(100);

490 
°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_RR_MASK
;

491 } 
°©us
 =
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

493 
°©us
) {

494 
APIC_ICR_RR_VALID
:

495 
°©us
 = 
	`≠ic_ªad
(
APIC_RRR
);

496 
	`¥ötk
(
KERN_CONT
 "%08x\n", 
°©us
);

499 
	`¥ötk
(
KERN_CONT
 "failed\n");

502 
	}
}

509 
__˝uöô


510 
	$wakeup_£c⁄d¨y_˝u_vü_nmi
(
logiˇl_≠icid
, 
°¨t_eù
)

512 
£nd_°©us
, 
ac˚±_°©us
 = 0;

513 
maxlvt
;

518 
	`≠ic_i¸_wrôe
(
APIC_DM_NMI
 | 
≠ic
->
de°_logiˇl
, 
logiˇl_≠icid
);

520 
	`¥_debug
("Waiting for sendÅo finish...\n");

521 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

526 
	`udñay
(200);

527 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

528 
maxlvt
 = 
	`œpic_gë_maxlvt
();

529 i‡(
maxlvt
 > 3)

530 
	`≠ic_wrôe
(
APIC_ESR
, 0);

531 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

533 
	`¥_debug
("NMI sent.\n");

535 i‡(
£nd_°©us
)

536 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

537 i‡(
ac˚±_°©us
)

538 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

540  (
£nd_°©us
 | 
ac˚±_°©us
);

541 
	}
}

543 
__˝uöô


544 
	$wakeup_£c⁄d¨y_˝u_vü_öô
(
phys_≠icid
, 
°¨t_eù
)

546 
£nd_°©us
, 
ac˚±_°©us
 = 0;

547 
maxlvt
, 
num_°¨ts
, 
j
;

549 
maxlvt
 = 
	`œpic_gë_maxlvt
();

554 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
])) {

555 i‡(
maxlvt
 > 3)

556 
	`≠ic_wrôe
(
APIC_ESR
, 0);

557 
	`≠ic_ªad
(
APIC_ESR
);

560 
	`¥_debug
("Asserting INIT.\n");

568 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

569 
phys_≠icid
);

571 
	`¥_debug
("Waiting for sendÅo finish...\n");

572 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

574 
	`mdñay
(10);

576 
	`¥_debug
("Deasserting INIT.\n");

580 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_≠icid
);

582 
	`¥_debug
("Waiting for sendÅo finish...\n");

583 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

585 
	`mb
();

586 
	`©omic_£t
(&
öô_dós£πed
, 1);

594 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
]))

595 
num_°¨ts
 = 2;

597 
num_°¨ts
 = 0;

603 
	`°¨tup_ùi_hook
(
phys_≠icid
, (Ë
°¨t_£c⁄d¨y
,

604 ()
°ack_°¨t
.
•
);

609 
	`¥_debug
("#°¨tu∞lo›s: %d.\n", 
num_°¨ts
);

611 
j
 = 1; j <
num_°¨ts
; j++) {

612 
	`¥_debug
("Sídög STARTUP #%d.\n", 
j
);

613 i‡(
maxlvt
 > 3)

614 
	`≠ic_wrôe
(
APIC_ESR
, 0);

615 
	`≠ic_ªad
(
APIC_ESR
);

616 
	`¥_debug
("Afterápic_write.\n");

625 
	`≠ic_i¸_wrôe
(
APIC_DM_STARTUP
 | (
°¨t_eù
 >> 12),

626 
phys_≠icid
);

631 
	`udñay
(300);

633 
	`¥_debug
("StartupÖoint 1.\n");

635 
	`¥_debug
("Waiting for sendÅo finish...\n");

636 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

641 
	`udñay
(200);

642 i‡(
maxlvt
 > 3)

643 
	`≠ic_wrôe
(
APIC_ESR
, 0);

644 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

645 i‡(
£nd_°©us
 || 
ac˚±_°©us
)

648 
	`¥_debug
("After Startup.\n");

650 i‡(
£nd_°©us
)

651 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

652 i‡(
ac˚±_°©us
)

653 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

655  (
£nd_°©us
 | 
ac˚±_°©us
);

656 
	}
}

658 
	s¸óã_idÀ
 {

659 
w‹k_°ru˘
 
	mw‹k
;

660 
èsk_°ru˘
 *
	midÀ
;

661 
com∂ëi⁄
 
	md⁄e
;

662 
	m˝u
;

665 
__˝uöô
 
	$do_f‹k_idÀ
(
w‹k_°ru˘
 *
w‹k
)

667 
¸óã_idÀ
 *
c_idÀ
 =

668 
	`c⁄èöî_of
(
w‹k
, 
¸óã_idÀ
, work);

670 
c_idÀ
->
idÀ
 = 
	`f‹k_idÀ
(c_idÀ->
˝u
);

671 
	`com∂ëe
(&
c_idÀ
->
d⁄e
);

672 
	}
}

675 
__˝uöô
 
	$™noun˚_˝u
(
˝u
, 
≠icid
)

677 
cuºít_node
 = -1;

678 
node
 = 
	`˝u_to_node
(
˝u
);

680 i‡(
sy°em_°©e
 =
SYSTEM_BOOTING
) {

681 i‡(
node
 !
cuºít_node
) {

682 i‡(
cuºít_node
 > (-1))

683 
	`¥_c⁄t
(" Ok.\n");

684 
cuºít_node
 = 
node
;

685 
	`¥_öfo
("BoŸög Nodê%3d, Pro˚ss‹†", 
node
);

687 
	`¥_c⁄t
(" #%d%s", 
˝u
, cpu =(
ƒ_˝u_ids
 - 1) ? " Ok.\n" : "");

690 
	`¥_öfo
("Booting Node %d Processor %d APIC 0x%x\n",

691 
node
, 
˝u
, 
≠icid
);

692 
	}
}

700 
__˝uöô
 
	$do_boŸ_˝u
(
≠icid
, 
˝u
)

702 
boŸ_îr‹
 = 0;

703 
°¨t_ù
;

704 
timeout
;

705 
¸óã_idÀ
 
c_idÀ
 = {

706 .
˝u
 = cpu,

707 .
d⁄e
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idÀ
.done),

710 
	`INIT_WORK_ON_STACK
(&
c_idÀ
.
w‹k
, 
do_f‹k_idÀ
);

712 
	`Æã∫©ives_smp_swôch
(1);

714 
c_idÀ
.
idÀ
 = 
	`gë_idÀ_f‹_˝u
(
˝u
);

720 i‡(
c_idÀ
.
idÀ
) {

721 
c_idÀ
.
idÀ
->
thªad
.
•
 = (Ë(((
±_ªgs
 *)

722 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
))) - 1);

723 
	`öô_idÀ
(
c_idÀ
.
idÀ
, 
˝u
);

724 
do_ª°
;

727 i‡(!
	`kevítd_up
(Ë|| 
	`cuºít_is_kevítd
())

728 
c_idÀ
.
w‹k
.
	`func
(&c_idle.work);

730 
	`scheduÀ_w‹k
(&
c_idÀ
.
w‹k
);

731 
	`waô_f‹_com∂ëi⁄
(&
c_idÀ
.
d⁄e
);

734 i‡(
	`IS_ERR
(
c_idÀ
.
idÀ
)) {

735 
	`¥ötk
("Áûed f‹k f‹ CPU %d\n", 
˝u
);

736 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

737  
	`PTR_ERR
(
c_idÀ
.
idÀ
);

740 
	`£t_idÀ_f‹_˝u
(
˝u
, 
c_idÀ
.
idÀ
);

741 
do_ª°
:

742 
	`≥r_˝u
(
cuºít_èsk
, 
˝u
Ë
c_idÀ
.
idÀ
;

743 #ifde‡
CONFIG_X86_32


745 
	`úq_˘x_öô
(
˝u
);

747 
	`˛ór_tsk_thªad_Êag
(
c_idÀ
.
idÀ
, 
TIF_FORK
);

748 
öôül_gs
 = 
	`≥r_˝u_off£t
(
˝u
);

749 
	`≥r_˝u
(
kî√l_°ack
, 
˝u
) =

750 ()
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
) -

751 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

753 
óæy_gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

754 
öôül_code
 = ()
°¨t_£c⁄d¨y
;

755 
°ack_°¨t
.
•
 = (*Ë
c_idÀ
.
idÀ
->
thªad
.sp;

758 
°¨t_ù
 = 
	`£tup_åampﬁöe
();

761 
	`™noun˚_˝u
(
˝u
, 
≠icid
);

768 
	`©omic_£t
(&
öô_dós£πed
, 0);

770 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

772 
	`¥_debug
("Setting warmÑeset codeánd vector.\n");

774 
	`smpboŸ_£tup_w¨m_ª£t_ve˘‹
(
°¨t_ù
);

778 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

779 
	`≠ic_wrôe
(
APIC_ESR
, 0);

780 
	`≠ic_ªad
(
APIC_ESR
);

788 i‡(
≠ic
->
wakeup_£c⁄d¨y_˝u
)

789 
boŸ_îr‹
 = 
≠ic
->
	`wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_ù
);

791 
boŸ_îr‹
 = 
	`wakeup_£c⁄d¨y_˝u_vü_öô
(
≠icid
, 
°¨t_ù
);

793 i‡(!
boŸ_îr‹
) {

797 
	`¥_debug
("Bef‹êCÆlouà%d.\n", 
˝u
);

798 
	`˝umask_£t_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

799 
	`¥_debug
("A·î CÆlouà%d.\n", 
˝u
);

804 
timeout
 = 0;Åimeout < 50000;Åimeout++) {

805 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

807 
	`udñay
(100);

810 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

811 
	`¥_debug
("CPU%d: ha†boŸed.\n", 
˝u
);

813 
boŸ_îr‹
 = 1;

814 i‡(*((vﬁ©ûê*)
åampﬁöe_ba£
)

817 
	`¥_îr
("CPU%d: Stuck ??\n", 
˝u
);

820 
	`¥_îr
("CPU%d: NŸÑe•⁄dög.\n", 
˝u
);

821 i‡(
≠ic
->
öquúe_ªmŸe_≠ic
)

822 
≠ic
->
	`öquúe_ªmŸe_≠ic
(
≠icid
);

826 i‡(
boŸ_îr‹
) {

828 
	`numa_ªmove_˝u
(
˝u
);

831 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

834 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

836 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

837 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
BAD_APICID
;

841 *((vﬁ©ûê*)
åampﬁöe_ba£
) = 0;

843 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

847 
	`smpboŸ_ª°‹e_w¨m_ª£t_ve˘‹
();

850 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

851  
boŸ_îr‹
;

852 
	}
}

854 
__˝uöô
 
	$«tive_˝u_up
(
˝u
)

856 
≠icid
 = 
≠ic
->
	`˝u_¥e£¡_to_≠icid
(
˝u
);

857 
Êags
;

858 
îr
;

860 
	`WARN_ON
(
	`úqs_dißbÀd
());

862 
	`¥_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
˝u
);

864 i‡(
≠icid
 =
BAD_APICID
 ||ápicid =
boŸ_˝u_physiˇl_≠icid
 ||

865 !
	`physid_is£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
)) {

866 
	`¥ötk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
˝u
);

867  -
EINVAL
;

873 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

874 
	`¥_debug
("do_boŸ_˝u %d AÃódy sèπed\n", 
˝u
);

875  -
ENOSYS
;

882 
	`mår_ßve_°©e
();

884 
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë
CPU_UP_PREPARE
;

886 #ifde‡
CONFIG_X86_32


888 
	`˛⁄e_pgd_ønge
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

889 
	`mö_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

890 
	`Êush_éb_Æl
();

891 
low_m≠pögs
 = 1;

893 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

895 
	`z≠_low_m≠pögs
(
Ál£
);

896 
low_m≠pögs
 = 0;

898 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

900 i‡(
îr
) {

901 
	`¥_debug
("do_boŸ_˝u faûed %d\n", 
îr
);

902  -
EIO
;

909 
	`loˇl_úq_ßve
(
Êags
);

910 
	`check_tsc_sync_sour˚
(
˝u
);

911 
	`loˇl_úq_ª°‹e
(
Êags
);

913 !
	`˝u_⁄löe
(
˝u
)) {

914 
	`˝u_ªœx
();

915 
	`touch_nmi_w©chdog
();

919 
	}
}

926 
__öô
 
	$dißbÀ_smp
()

928 
	`öô_˝u_¥e£¡
(
	`˝umask_of
(0));

929 
	`öô_˝u_possibÀ
(
	`˝umask_of
(0));

930 
	`smpboŸ_˛ór_io_≠ic_úqs
();

932 i‡(
smp_found_c⁄fig
)

933 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

935 
	`physid_£t_mask_of_physid
(0, &
phys_˝u_¥e£¡_m≠
);

936 
	`m≠_˝u_to_logiˇl_≠icid
();

937 
	`˝umask_£t_˝u
(0, 
	`˝u_siblög_mask
(0));

938 
	`˝umask_£t_˝u
(0, 
	`˝u_c‹e_mask
(0));

939 
	}
}

944 
__öô
 
	$smp_ßnôy_check
(
max_˝us
)

946 
	`¥ìm±_dißbÀ
();

948 #i‡!
	`deföed
(
CONFIG_X86_BIGSMP
Ë&& deföed(
CONFIG_X86_32
)

949 i‡(
def_to_bigsmp
 && 
ƒ_˝u_ids
 > 8) {

950 
˝u
;

951 
ƒ
;

953 
	`¥ötk
(
KERN_WARNING


957 
ƒ
 = 0;

958 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

959 i‡(
ƒ
 >= 8)

960 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

961 
ƒ
++;

964 
ƒ
 = 0;

965 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

966 i‡(
ƒ
 >= 8)

967 
	`£t_˝u_possibÀ
(
˝u
, 
Ál£
);

968 
ƒ
++;

971 
ƒ_˝u_ids
 = 8;

975 i‡(!
	`physid_is£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
)) {

976 
	`¥ötk
(
KERN_WARNING


978 
	`h¨d_smp_¥o˚ss‹_id
());

980 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

987 i‡(!
smp_found_c⁄fig
 && !
a˝i_œpic
) {

988 
	`¥ìm±_íabÀ
();

989 
	`¥ötk
(
KERN_NOTICE
 "SMP motherboardÇot detected.\n");

990 
	`dißbÀ_smp
();

991 i‡(
	`APIC_öô_unùro˚ss‹
())

992 
	`¥ötk
(
KERN_NOTICE
 "Local APICÇot detected."

1001 i‡(!
≠ic
->
	`check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)) {

1002 
	`¥ötk
(
KERN_NOTICE


1004 
boŸ_˝u_physiˇl_≠icid
);

1005 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

1007 
	`¥ìm±_íabÀ
();

1012 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]) &&

1013 !
˝u_has_≠ic
) {

1014 i‡(!
dißbÀ_≠ic
) {

1015 
	`¥_îr
("BIOS bug,Üocal APIC #%dÇot detected!...\n",

1016 
boŸ_˝u_physiˇl_≠icid
);

1017 
	`¥_îr
("... forcing use of dummy APICÉmulation."

1020 
	`smpboŸ_˛ór_io_≠ic
();

1021 
	`¨ch_dißbÀ_smp_suµ‹t
();

1025 
	`vîify_loˇl_APIC
();

1030 i‡(!
max_˝us
) {

1031 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

1032 
	`smpboŸ_˛ór_io_≠ic
();

1034 
	`loˇli£_nmi_w©chdog
();

1036 
	`c⁄√˘_b•_APIC
();

1037 
	`£tup_loˇl_APIC
();

1038 
	`íd_loˇl_APIC_£tup
();

1043 
	}
}

1045 
__öô
 
	$smp_˝u_ödex_deÁu…
()

1047 
i
;

1048 
˝uöfo_x86
 *
c
;

1050 
	`f‹_óch_possibÀ_˝u
(
i
) {

1051 
c
 = &
	`˝u_d©a
(
i
);

1053 
c
->
˝u_ödex
 = 
ƒ_˝u_ids
;

1055 
	}
}

1061 
__öô
 
	$«tive_smp_¥ï¨e_˝us
(
max_˝us
)

1063 
i
;

1065 
	`¥ìm±_dißbÀ
();

1066 
	`smp_˝u_ödex_deÁu…
();

1067 
cuºít_˝u_d©a
 = 
boŸ_˝u_d©a
;

1068 
	`˝umask_c›y
(
˝u_ˇŒö_mask
, 
	`˝umask_of
(0));

1069 
	`mb
();

1073 
	`smp_°‹e_˝u_öfo
(0);

1074 #ifde‡
CONFIG_X86_32


1075 
boŸ_˝u_logiˇl_≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

1077 
	`cuºít_thªad_öfo
()->
˝u
 = 0;

1078 
	`f‹_óch_possibÀ_˝u
(
i
) {

1079 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
), 
GFP_KERNEL
);

1080 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
), 
GFP_KERNEL
);

1081 
	`zÆloc_˝umask_v¨
(&
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
, 
GFP_KERNEL
);

1083 
	`£t_˝u_siblög_m≠
(0);

1085 
	`íabÀ_IR_x2≠ic
();

1086 
	`deÁu…_£tup_≠ic_routög
();

1088 i‡(
	`smp_ßnôy_check
(
max_˝us
) < 0) {

1089 
	`¥ötk
(
KERN_INFO
 "SMP disabled\n");

1090 
	`dißbÀ_smp
();

1091 
out
;

1094 
	`¥ìm±_dißbÀ
();

1095 i‡(
	`ªad_≠ic_id
(Ë!
boŸ_˝u_physiˇl_≠icid
) {

1096 
	`∑nic
("Boot APIC ID inÜocal APIC unexpected (%d vs %d)",

1097 
	`ªad_≠ic_id
(), 
boŸ_˝u_physiˇl_≠icid
);

1100 
	`¥ìm±_íabÀ
();

1102 
	`c⁄√˘_b•_APIC
();

1107 
	`£tup_loˇl_APIC
();

1112 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1113 
	`íabÀ_IO_APIC
();

1115 
	`íd_loˇl_APIC_£tup
();

1117 
	`m≠_˝u_to_logiˇl_≠icid
();

1119 i‡(
≠ic
->
£tup_p‹tio_ªm≠
)

1120 
≠ic
->
	`£tup_p‹tio_ªm≠
();

1122 
	`smpboŸ_£tup_io_≠ic
();

1127 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 0);

1128 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(0));

1129 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1131 i‡(
	`is_uv_sy°em
())

1132 
	`uv_sy°em_öô
();

1134 
	`£t_mår_≠s_dñayed_öô
();

1135 
out
:

1136 
	`¥ìm±_íabÀ
();

1137 
	}
}

1139 
	$¨ch_íabÀ_n⁄boŸ_˝us_begö
()

1141 
	`£t_mår_≠s_dñayed_öô
();

1142 
	}
}

1144 
	$¨ch_íabÀ_n⁄boŸ_˝us_íd
()

1146 
	`mår_≠s_öô
();

1147 
	}
}

1152 
__öô
 
	$«tive_smp_¥ï¨e_boŸ_˝u
()

1154 
me
 = 
	`smp_¥o˚ss‹_id
();

1155 
	`swôch_to_√w_gdt
(
me
);

1157 
	`˝umask_£t_˝u
(
me
, 
˝u_ˇŒout_mask
);

1158 
	`≥r_˝u
(
˝u_°©e
, 
me
Ë
CPU_ONLINE
;

1159 
	}
}

1161 
__öô
 
	$«tive_smp_˝us_d⁄e
(
max_˝us
)

1163 
	`¥_debug
("Boot done.\n");

1165 
	`im¥ess_‰õnds
();

1166 #ifde‡
CONFIG_X86_IO_APIC


1167 
	`£tup_iﬂpic_de°
();

1169 
	`check_nmi_w©chdog
();

1170 
	`mår_≠s_öô
();

1171 
	}
}

1173 
__öôd©a
 
	g£tup_possibÀ_˝us
 = -1;

1174 
__öô
 
	$_£tup_possibÀ_˝us
(*
°r
)

1176 
	`gë_›ti⁄
(&
°r
, &
£tup_possibÀ_˝us
);

1178 
	}
}

1179 
óæy_∑øm
("possibÀ_˝us", 
_£tup_possibÀ_˝us
);

1199 
__öô
 
	$¥efûl_possibÀ_m≠
()

1201 
i
, 
possibÀ
;

1204 i‡(!
num_¥o˚ss‹s
)

1205 
num_¥o˚ss‹s
 = 1;

1207 i‡(
£tup_possibÀ_˝us
 == -1)

1208 
possibÀ
 = 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
;

1210 
possibÀ
 = 
£tup_possibÀ_˝us
;

1212 
tŸÆ_˝us
 = 
	`max_t
(, 
possibÀ
, 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
);

1214 i‡(
possibÀ
 > 
CONFIG_NR_CPUS
) {

1215 
	`¥ötk
(
KERN_WARNING


1217 
possibÀ
, 
CONFIG_NR_CPUS
);

1218 
possibÀ
 = 
CONFIG_NR_CPUS
;

1221 
	`¥ötk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1222 
possibÀ
, 
	`max_t
(,ÖossibÀ - 
num_¥o˚ss‹s
, 0));

1224 
i
 = 0; i < 
possibÀ
; i++)

1225 
	`£t_˝u_possibÀ
(
i
, 
åue
);

1227 
ƒ_˝u_ids
 = 
possibÀ
;

1228 
	}
}

1230 #ifde‡
CONFIG_HOTPLUG_CPU


1232 
	$ªmove_siblögöfo
(
˝u
)

1234 
siblög
;

1235 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

1237 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_c‹e_mask
(
˝u
)) {

1238 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
siblög
));

1242 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1)

1243 
	`˝u_d©a
(
siblög
).
boŸed_c‹es
--;

1246 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_siblög_mask
(
˝u
))

1247 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_siblög_mask
(
siblög
));

1248 
	`˝umask_˛ór
(
	`˝u_siblög_mask
(
˝u
));

1249 
	`˝umask_˛ór
(
	`˝u_c‹e_mask
(
˝u
));

1250 
c
->
phys_¥oc_id
 = 0;

1251 
c
->
˝u_c‹e_id
 = 0;

1252 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

1253 
	}
}

1255 
__ªf
 
	$ªmove_˝u_‰om_m≠s
(
˝u
)

1257 
	`£t_˝u_⁄löe
(
˝u
, 
Ál£
);

1258 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

1259 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒö_mask
);

1261 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

1262 
	`numa_ªmove_˝u
(
˝u
);

1263 
	}
}

1265 
	$˝u_dißbÀ_comm⁄
()

1267 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1269 
	`ªmove_siblögöfo
(
˝u
);

1272 
	`lock_ve˘‹_lock
();

1273 
	`ªmove_˝u_‰om_m≠s
(
˝u
);

1274 
	`u∆ock_ve˘‹_lock
();

1275 
	`fixup_úqs
();

1276 
	}
}

1278 
	$«tive_˝u_dißbÀ
()

1280 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1290 i‡(
˝u
 == 0)

1291  -
EBUSY
;

1293 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

1294 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

1295 
	`˛ór_loˇl_APIC
();

1297 
	`˝u_dißbÀ_comm⁄
();

1299 
	}
}

1301 
	$«tive_˝u_dõ
(
˝u
)

1304 
i
;

1306 
i
 = 0; i < 10; i++) {

1308 i‡(
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë=
CPU_DEAD
) {

1309 i‡(
sy°em_°©e
 =
SYSTEM_RUNNING
)

1310 
	`¥_öfo
("CPU %u i†now ofÊöe\n", 
˝u
);

1312 i‡(1 =
	`num_⁄löe_˝us
())

1313 
	`Æã∫©ives_smp_swôch
(0);

1316 
	`m¶ìp
(100);

1318 
	`¥_îr
("CPU %u didn'àdõ...\n", 
˝u
);

1319 
	}
}

1321 
	$∂ay_dód_comm⁄
()

1323 
	`idÀ_èsk_exô
();

1324 
	`ª£t_œzy_éb°©e
();

1325 
	`úq_˘x_exô
(
	`øw_smp_¥o˚ss‹_id
());

1326 
	`c1e_ªmove_˝u
(
	`øw_smp_¥o˚ss‹_id
());

1328 
	`mb
();

1330 
	`__gë_˝u_v¨
(
˝u_°©e
Ë
CPU_DEAD
;

1335 
	`loˇl_úq_dißbÀ
();

1336 
	}
}

1338 
	$«tive_∂ay_dód
()

1340 
	`∂ay_dód_comm⁄
();

1341 
	`tboŸ_shutdown
(
TB_SHUTDOWN_WFS
);

1342 
	`wbövd_hÆt
();

1343 
	}
}

1346 
	$«tive_˝u_dißbÀ
()

1348  -
ENOSYS
;

1349 
	}
}

1351 
	$«tive_˝u_dõ
(
˝u
)

1354 
	`BUG
();

1355 
	}
}

1357 
	$«tive_∂ay_dód
()

1359 
	`BUG
();

1360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/uac˚ss.h
>

10 
	~<asm/°ackåa˚.h
>

12 
	$ßve_°ack_w¨nög
(*
d©a
, *
msg
)

14 
	}
}

17 
	$ßve_°ack_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

19 
	}
}

21 
	$ßve_°ack_°ack
(*
d©a
, *
«me
)

24 
	}
}

26 
	$ßve_°ack_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

28 
°ack_åa˚
 *
åa˚
 = 
d©a
;

29 i‡(!
ªlübÀ
)

31 i‡(
åa˚
->
skù
 > 0) {

32 
åa˚
->
skù
--;

35 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

36 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

37 
	}
}

40 
	$ßve_°ack_addªss_nosched
(*
d©a
, 
addr
, 
ªlübÀ
)

42 
°ack_åa˚
 *
åa˚
 = (°ack_åa˚ *)
d©a
;

43 i‡(!
ªlübÀ
)

45 i‡(
	`ö_sched_fun˘i⁄s
(
addr
))

47 i‡(
åa˚
->
skù
 > 0) {

48 
åa˚
->
skù
--;

51 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

53 
	}
}

55 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s
 = {

56 .
w¨nög
 = 
ßve_°ack_w¨nög
,

57 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

58 .
	g°ack
 = 
ßve_°ack_°ack
,

59 .
	gaddªss
 = 
ßve_°ack_addªss
,

60 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

63 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s_nosched
 = {

64 .
w¨nög
 = 
ßve_°ack_w¨nög
,

65 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

66 .
	g°ack
 = 
ßve_°ack_°ack
,

67 .
	gaddªss
 = 
ßve_°ack_addªss_nosched
,

68 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

74 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

76 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 0, &
ßve_°ack_›s
, 
åa˚
);

77 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

78 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

79 
	}
}

80 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚
);

82 
	$ßve_°ack_åa˚_bp
(
°ack_åa˚
 *
åa˚
, 
bp
)

84 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 
bp
, &
ßve_°ack_›s
, 
åa˚
);

85 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

86 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

87 
	}
}

89 
	$ßve_°ack_åa˚_tsk
(
èsk_°ru˘
 *
tsk
, 
°ack_åa˚
 *
åa˚
)

91 
	`dump_åa˚
(
tsk
, 
NULL
, NULL, 0, &
ßve_°ack_›s_nosched
, 
åa˚
);

92 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

93 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

94 
	}
}

95 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚_tsk
);

99 
	s°ack_‰ame
 {

100 c⁄° 
__u£r
 *
	m√xt_Â
;

101 
	mªt_addr
;

104 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

106 
ªt
;

108 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
Â
, (*
‰ame
)))

111 
ªt
 = 1;

112 
	`∑geÁu…_dißbÀ
();

113 i‡(
	`__c›y_‰om_u£r_ö©omic
(
‰ame
, 
Â
, (*frame)))

114 
ªt
 = 0;

115 
	`∑geÁu…_íabÀ
();

117  
ªt
;

118 
	}
}

120 
ölöe
 
	$__ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

122 c⁄° 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

123 c⁄° 
__u£r
 *
Â
 = (c⁄° __u£∏*)
ªgs
->
bp
;

125 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

126 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ªgs
->
ù
;

128 
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
) {

129 
°ack_‰ame
 
‰ame
;

131 
‰ame
.
√xt_Â
 = 
NULL
;

132 
‰ame
.
ªt_addr
 = 0;

133 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

135 i‡(()
Â
 < 
ªgs
->
•
)

137 i‡(
‰ame
.
ªt_addr
) {

138 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] =

139 
‰ame
.
ªt_addr
;

141 i‡(
Â
 =
‰ame
.
√xt_Â
)

143 
Â
 = 
‰ame
.
√xt_Â
;

145 
	}
}

147 
	$ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

152 i‡(
cuºít
->
mm
) {

153 
	`__ßve_°ack_åa˚_u£r
(
åa˚
);

155 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

156 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

157 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<löux/sched.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/±ø˚.h
>

7 
	~<asm/desc.h
>

9 
	$c⁄vît_ù_to_löór
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

11 
addr
, 
£g
;

13 
addr
 = 
ªgs
->
ù
;

14 
£g
 = 
ªgs
->
cs
 & 0xffff;

15 i‡(
	`v8086_mode
(
ªgs
)) {

16 
addr
 = (add∏& 0xffffË+ (
£g
 << 4);

17  
addr
;

26 i‡((
£g
 & 
SEGMENT_TI_MASK
Ë=
SEGMENT_LDT
) {

27 
desc_°ru˘
 *
desc
;

28 
ba£
;

30 
£g
 &= ~7UL;

32 
	`muãx_lock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

33 i‡(
	`u∆ikñy
((
£g
 >> 3Ë>
chûd
->
mm
->
c⁄ãxt
.
size
))

34 
addr
 = -1L;

36 
desc
 = 
chûd
->
mm
->
c⁄ãxt
.
ldt
 + 
£g
;

37 
ba£
 = 
	`gë_desc_ba£
(
desc
);

40 i‡(!
desc
->
d
)

41 
addr
 &= 0xffff;

42 
addr
 +
ba£
;

44 
	`muãx_u∆ock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

47  
addr
;

48 
	}
}

50 
	$is_£âög_å≠_Êag
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

52 
i
, 
c›õd
;

53 
›code
[15];

54 
addr
 = 
	`c⁄vît_ù_to_löór
(
chûd
, 
ªgs
);

56 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, 
›code
, (opcode), 0);

57 
i
 = 0; i < 
c›õd
; i++) {

58 
›code
[
i
]) {

75 #ifde‡
CONFIG_X86_64


77 i‡(
ªgs
->
cs
 !
__USER_CS
)

99 
	}
}

104 
	$íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

106 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

107 
oÊags
;

119 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
)))

120 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

127 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

129 
oÊags
 = 
ªgs
->
Êags
;

132 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

143 i‡(
	`is_£âög_å≠_Êag
(
chûd
, 
ªgs
)) {

144 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

152 i‡(
oÊags
 & 
X86_EFLAGS_TF
)

153  
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

155 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

158 
	}
}

163 
	$wrôe_debug˘lm§
(
èsk_°ru˘
 *
chûd
, 
vÆ
)

165 i‡(
chûd
->
thªad
.
debug˘lm§
 =
vÆ
)

168 
chûd
->
thªad
.
debug˘lm§
 = 
vÆ
;

170 i‡(
chûd
 !
cuºít
)

173 
	`upd©e_debug˘lm§
(
vÆ
);

174 
	}
}

179 
	$íabÀ_°ï
(
èsk_°ru˘
 *
chûd
, 
boﬁ
 
block
)

188 i‡(
	`íabÀ_sögÀ_°ï
(
chûd
Ë&& 
block
) {

189 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

190 
	`wrôe_debug˘lm§
(
chûd
,

191 
chûd
->
thªad
.
debug˘lm§
 | 
DEBUGCTLMSR_BTF
);

193 
	`wrôe_debug˘lm§
(
chûd
,

194 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

196 i‡(!
chûd
->
thªad
.
debug˘lm§
)

197 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

199 
	}
}

201 
	$u£r_íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

203 
	`íabÀ_°ï
(
chûd
, 0);

204 
	}
}

206 
	$u£r_íabÀ_block_°ï
(
èsk_°ru˘
 *
chûd
)

208 
	`íabÀ_°ï
(
chûd
, 1);

209 
	}
}

211 
	$u£r_dißbÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

216 
	`wrôe_debug˘lm§
(
chûd
,

217 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

219 i‡(!
chûd
->
thªad
.
debug˘lm§
)

220 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

223 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

226 i‡(
	`ã°_™d_˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
))

227 
	`èsk_±_ªgs
(
chûd
)->
Êags
 &~
X86_EFLAGS_TF
;

228 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/sysˇŒs.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/fs.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/£m.h
>

8 
	~<löux/msg.h
>

9 
	~<löux/shm.h
>

10 
	~<löux/°©.h
>

11 
	~<löux/mm™.h
>

12 
	~<löux/fûe.h
>

13 
	~<löux/ut¢ame.h
>

14 
	~<löux/≥rs⁄Æôy.h
>

15 
	~<löux/øndom.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/ü32.h
>

19 
	~<asm/sysˇŒs.h
>

21 
	$SYSCALL_DEFINE6
(
mm≠
, , 
addr
, , 
Àn
,

22 , 
¥Ÿ
, , 
Êags
,

23 , 
fd
, , 
off
)

25 
îr‹
;

26 
îr‹
 = -
EINVAL
;

27 i‡(
off
 & ~
PAGE_MASK
)

28 
out
;

30 
îr‹
 = 
	`sys_mm≠_pgoff
(
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
fd
, 
off
 >> 
PAGE_SHIFT
);

31 
out
:

32  
îr‹
;

33 
	}
}

35 
	$föd_°¨t_íd
(
Êags
, *
begö
,

36 *
íd
)

38 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
)) {

39 
√w_begö
;

47 *
begö
 = 0x40000000;

48 *
íd
 = 0x80000000;

49 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

50 
√w_begö
 = 
	`øndomize_ønge
(*
begö
, *begin + 0x02000000, 0);

51 i‡(
√w_begö
)

52 *
begö
 = 
√w_begö
;

55 *
begö
 = 
TASK_UNMAPPED_BASE
;

56 *
íd
 = 
TASK_SIZE
;

58 
	}
}

61 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

62 
Àn
, 
pgoff
, 
Êags
)

64 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

65 
vm_¨ó_°ru˘
 *
vma
;

66 
°¨t_addr
;

67 
begö
, 
íd
;

69 i‡(
Êags
 & 
MAP_FIXED
)

70  
addr
;

72 
	`föd_°¨t_íd
(
Êags
, &
begö
, &
íd
);

74 i‡(
Àn
 > 
íd
)

75  -
ENOMEM
;

77 i‡(
addr
) {

78 
addr
 = 
	`PAGE_ALIGN
(addr);

79 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

80 i‡(
íd
 - 
Àn
 >
addr
 &&

81 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

82  
addr
;

84 i‡(((
Êags
 & 
MAP_32BIT
Ë|| 
	`ã°_thªad_Êag
(
TIF_IA32
))

85 && 
Àn
 <
mm
->
ˇched_hﬁe_size
) {

86 
mm
->
ˇched_hﬁe_size
 = 0;

87 
mm
->
‰ì_¨ó_ˇche
 = 
begö
;

89 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

90 i‡(
addr
 < 
begö
)

91 
addr
 = 
begö
;

92 
°¨t_addr
 = 
addr
;

94 
fuŒ_£¨ch
:

95 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

97 i‡(
íd
 - 
Àn
 < 
addr
) {

102 i‡(
°¨t_addr
 !
begö
) {

103 
°¨t_addr
 = 
addr
 = 
begö
;

104 
mm
->
ˇched_hﬁe_size
 = 0;

105 
fuŒ_£¨ch
;

107  -
ENOMEM
;

109 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

113 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

114  
addr
;

116 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

117 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

119 
addr
 = 
vma
->
vm_íd
;

121 
	}
}

125 
	$¨ch_gë_unm≠≥d_¨ó_t›down
(
fûe
 *
fûp
, c⁄° 
addr0
,

126 c⁄° 
Àn
, c⁄° 
pgoff
,

127 c⁄° 
Êags
)

129 
vm_¨ó_°ru˘
 *
vma
;

130 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

131 
addr
 = 
addr0
;

134 i‡(
Àn
 > 
TASK_SIZE
)

135  -
ENOMEM
;

137 i‡(
Êags
 & 
MAP_FIXED
)

138  
addr
;

141 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
))

142 
bŸtomup
;

145 i‡(
addr
) {

146 
addr
 = 
	`PAGE_ALIGN
(addr);

147 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

148 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

149 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

150  
addr
;

154 i‡(
Àn
 <
mm
->
ˇched_hﬁe_size
) {

155 
mm
->
ˇched_hﬁe_size
 = 0;

156 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

160 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

163 i‡(
addr
 > 
Àn
) {

164 
vma
 = 
	`föd_vma
(
mm
, 
addr
-
Àn
);

165 i‡(!
vma
 || 
addr
 <vma->
vm_°¨t
)

167  
mm
->
‰ì_¨ó_ˇche
 = 
addr
-
Àn
;

170 i‡(
mm
->
mm≠_ba£
 < 
Àn
)

171 
bŸtomup
;

173 
addr
 = 
mm
->
mm≠_ba£
-
Àn
;

181 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

182 i‡(!
vma
 || 
addr
+
Àn
 <vma->
vm_°¨t
)

184  
mm
->
‰ì_¨ó_ˇche
 = 
addr
;

187 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

188 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

191 
addr
 = 
vma
->
vm_°¨t
-
Àn
;

192 } 
Àn
 < 
vma
->
vm_°¨t
);

194 
bŸtomup
:

201 
mm
->
ˇched_hﬁe_size
 = ~0UL;

202 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

203 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó
(
fûp
, 
addr0
, 
Àn
, 
pgoff
, 
Êags
);

207 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

208 
mm
->
ˇched_hﬁe_size
 = ~0UL;

210  
addr
;

211 
	}
}

214 
	$SYSCALL_DEFINE1
(
u«me
, 
√w_ut¢ame
 
__u£r
 *, 
«me
)

216 
îr
;

217 
	`down_ªad
(&
uts_£m
);

218 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

219 
	`up_ªad
(&
uts_£m
);

220 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

221 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

222  
îr
 ? -
EFAULT
 : 0;

223 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<löux/lökage.h
>

4 
	~<löux/sys.h
>

5 
	~<löux/ˇche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
ƒ
, 
sym
Ë
asmlökage
 
	`sym
(Ë;

	)

11 #unde‡
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni°d_64.h
>

14 #unde‡
__SYSCALL


15 
	#__SYSCALL
(
ƒ
, 
sym
Ë[ƒ] = sym,

	)

16 #unde‡
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ˇŒ_±r_t
)();

20 
	`sys_ni_sysˇŒ
();

22 c⁄° 
sys_ˇŒ_±r_t
 
sys_ˇŒ_èbÀ
[
__NR_sysˇŒ_max
+1] = {

27 [0 ... 
__NR_sysˇŒ_max
] = &
sys_ni_sysˇŒ
,

28 
	~<asm/uni°d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/•ölock.h
>

30 
	~<löux/°rög.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/dma-m≠pög.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<asm/t˚.h
>

35 
	~<asm/ˇlg¨y.h
>

36 
	~<asm/¥Ÿo.h
>

39 
ölöe
 
	$Êush_t˚
(* 
t˚addr
)

42 i‡(
˝u_has_˛Êush
)

43 
	`˛Êush
(
t˚addr
);

45 
	`wbövd
();

46 
	}
}

48 
	$t˚_buûd
(
iommu_èbÀ
 *
tbl
, 
ödex
,

49 
≈ages
, 
uaddr
, 
dúe˘i⁄
)

51 
u64
* 
ç
;

52 
u64
 
t
;

53 
u64
 
Ωn
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 i‡(
dúe˘i⁄
 !
DMA_TO_DEVICE
)

57 
t
 |(1 << 
TCE_WRITE_SHIFT
);

59 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

61 
≈ages
--) {

62 
Ωn
 = (
	`vút_to_bus
((*)
uaddr
)Ë>> 
PAGE_SHIFT
;

63 
t
 &~
TCE_RPN_MASK
;

64 
t
 |(
Ωn
 << 
TCE_RPN_SHIFT
);

66 *
ç
 = 
	`˝u_to_be64
(
t
);

67 
	`Êush_t˚
(
ç
);

69 
uaddr
 +
PAGE_SIZE
;

70 
ç
++;

72 
	}
}

74 
	$t˚_‰ì
(
iommu_èbÀ
 *
tbl
, 
ödex
, 
≈ages
)

76 
u64
* 
ç
;

78 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

80 
≈ages
--) {

81 *
ç
 = 
	`˝u_to_be64
(0);

82 
	`Êush_t˚
(
ç
);

83 
ç
++;

85 
	}
}

87 
ölöe
 
	$èbÀ_size_to_numbî_of_íåõs
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$t˚_èbÀ_£ç¨ms
(
pci_dev
 *
dev
, 
iommu_èbÀ
 *
tbl
)

99 
bôm≠sz
;

100 
bmµages
;

101 
ªt
;

103 
tbl
->
ô_bu¢o
 = 
dev
->
bus
->
numbî
;

106 
tbl
->
ô_size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

112 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
bôm≠sz
));

114 i‡(!
bmµages
) {

115 
	`¥ötk
(
KERN_ERR
 "Calgary: cannotállocate bitmap\n");

116 
ªt
 = -
ENOMEM
;

117 
d⁄e
;

120 
tbl
->
ô_m≠
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
ô_m≠
, 0, 
bôm≠sz
);

124 
tbl
->
ô_höt
 = 0;

126 
	`•ö_lock_öô
(&
tbl
->
ô_lock
);

130 
d⁄e
:

131  
ªt
;

132 
	}
}

134 
__öô
 
	$buûd_t˚_èbÀ
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

136 
iommu_èbÀ
 *
tbl
;

137 
ªt
;

139 i‡(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`¥ötk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kzÆloc
((
iommu_èbÀ
), 
GFP_KERNEL
);

146 i‡(!
tbl
) {

147 
	`¥ötk
(
KERN_ERR
 "Calgary:Érrorállocating iommu_table\n");

148 
ªt
 = -
ENOMEM
;

149 
d⁄e
;

152 
ªt
 = 
	`t˚_èbÀ_£ç¨ms
(
dev
, 
tbl
);

153 i‡(
ªt
)

154 
‰ì_tbl
;

156 
tbl
->
bb¨
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
‰ì_tbl
:

163 
	`k‰ì
(
tbl
);

164 
d⁄e
:

165  
ªt
;

166 
	}
}

168 * 
__öô
 
	$Æloc_t˚_èbÀ
()

170 
size
;

172 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

173 
size
 *
TCE_ENTRY_SIZE
;

175  
	`__Æloc_boŸmem_low
(
size
, size, 0);

176 
	}
}

178 
__öô
 
	$‰ì_t˚_èbÀ
(*
tbl
)

180 
size
;

182 i‡(!
tbl
)

185 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

186 
size
 *
TCE_ENTRY_SIZE
;

188 
	`‰ì_boŸmem
(
	`__∑
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/s‹t.h
>

14 
	~<löux/¶ab.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_ã°_d©a
;

45 
	$fudze_ex˚±i⁄_èbÀ
(*
m¨kî
, *
√w
)

47 
moduÀ
 *
mod
 = 
THIS_MODULE
;

48 
ex˚±i⁄_èbÀ_íåy
 *
exèbÀ
;

56 i‡(
mod
->
num_exíåõs
 > 1) {

57 
	`¥ötk
(
KERN_ERR
 "test_nx:Åoo manyÉxceptionÅableÉntries!\n");

58 
	`¥ötk
(
KERN_ERR
 "test_nx:ÅestÑesultsáreÇotÑeliable.\n");

61 
exèbÀ
 = (
ex˚±i⁄_èbÀ_íåy
 *)
mod
->extable;

62 
exèbÀ
[0].
ö¢
 = ()
√w
;

63 
	}
}

71 
foo_œbñ
();

80 
noölöe
 
	$ã°_addªss
(*
addªss
)

82 
ªsu…
;

85 
	`fudze_ex˚±i⁄_èbÀ
(&
foo_œbñ
, 
addªss
);

86 
ªsu…
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¶t
] "Ù" (
ªsu…
)

97 : [
Áke_code
] "r" (
addªss
), [
zîo
] "r" (0UL), "0" (
ªsu…
)

100 
	`fudze_ex˚±i⁄_èbÀ
(
addªss
, &
foo_œbñ
);

102 i‡(
ªsu…
)

103  -
ENODEV
;

105 
	}
}

107 
	gã°_d©a
 = 0xC3;

109 
	$ã°_NX
()

111 
ªt
 = 0;

113 
°ackcode
[] = {0xC3, 0x90, 0 };

114 *
hóp
;

116 
ã°_d©a
 = 0xC3;

118 
	`¥ötk
(
KERN_INFO
 "Testing NXÖrotection\n");

121 i‡(
	`ã°_addªss
(&
°ackcode
)) {

122 
	`¥ötk
(
KERN_ERR
 "test_nx: stack wasÉxecutable\n");

123 
ªt
 = -
ENODEV
;

128 
hóp
 = 
	`kmÆloc
(64, 
GFP_KERNEL
);

129 i‡(!
hóp
)

130  -
ENOMEM
;

131 
hóp
[0] = 0xC3;

133 i‡(
	`ã°_addªss
(
hóp
)) {

134 
	`¥ötk
(
KERN_ERR
 "test_nx: heap wasÉxecutable\n");

135 
ªt
 = -
ENODEV
;

137 
	`k‰ì
(
hóp
);

145 #ifde‡
CONFIG_DEBUG_RODATA


147 i‡(
rod©a_ã°_d©a
 != 0xC3) {

148 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
ªt
 = -
ENODEV
;

150 } i‡(
	`ã°_addªss
(&
rod©a_ã°_d©a
)) {

151 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata section isÉxecutable\n");

152 
ªt
 = -
ENODEV
;

158 i‡(
	`ã°_addªss
(&
ã°_d©a
)) {

159 
	`¥ötk
(
KERN_ERR
 "test_nx: .data section isÉxecutable\n");

160 
ªt
 = -
ENODEV
;

165 
	}
}

167 
	$ã°_exô
()

169 
	}
}

171 
moduÀ_öô
(
ã°_NX
);

172 
moduÀ_exô
(
ã°_exô
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forÅhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time.c

12 
	~<löux/˛ockchùs.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/time.h
>

15 
	~<löux/mˇ.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/x86_öô.h
>

19 
	~<asm/i8259.h
>

20 
	~<asm/i8253.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/time.h
>

25 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_X86_IO_APIC
)

26 
	gtimî_ack
;

29 #ifde‡
CONFIG_X86_64


30 vﬁ©ûê
__jiffõs
 
	g__£˘i⁄_jiffõs
 = 
INITIAL_JIFFIES
;

33 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

35 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

37 i‡(!
	`u£r_mode_vm
(
ªgs
Ë&& 
	`ö_lock_fun˘i⁄s
(
pc
)) {

38 #ifde‡
CONFIG_FRAME_POINTER


39  *(*)(
ªgs
->
bp
 + ());

41 *
•
 =

42 (*)
	`kî√l_°ack_poöãr
(
ªgs
);

48 i‡(
•
[0] >> 22)

49  
•
[0];

50 i‡(
•
[1] >> 22)

51  
•
[1];

54  
pc
;

55 
	}
}

56 
EXPORT_SYMBOL
(
¥ofûe_pc
);

61 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

64 
	`öc_úq_°©
(
úq0_úqs
);

67 i‡(
timî_ack
) {

73 
	`•ö_lock
(&
i8259A_lock
);

74 
	`outb
(0x0c, 
PIC_MASTER_OCW3
);

76 
	`öb
(
PIC_MASTER_POLL
);

77 
	`•ö_u∆ock
(&
i8259A_lock
);

80 
globÆ_˛ock_evít
->
	`evít_h™dÀr
(global_clock_event);

83 i‡(
MCA_bus
)

84 
	`outb_p
(
	`öb_p
(0x61)| 0x80, 0x61);

86  
IRQ_HANDLED
;

87 
	}
}

89 
úqa˘i⁄
 
	gúq0
 = {

90 .
h™dÀr
 = 
timî_öãºu±
,

91 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

92 .
	g«me
 = "timer"

95 
__öô
 
	$£tup_deÁu…_timî_úq
()

97 
	`£tup_úq
(0, &
úq0
);

98 
	}
}

101 
__öô
 
	$h≥t_time_öô
()

103 i‡(!
	`h≥t_íabÀ
())

104 
	`£tup_pô_timî
();

105 
	`£tup_deÁu…_timî_úq
();

106 
	}
}

108 
__öô
 
	$x86_œã_time_öô
()

110 
x86_öô
.
timîs
.
	`timî_öô
();

111 
	`tsc_öô
();

112 
	}
}

118 
__öô
 
	$time_öô
()

120 
œã_time_öô
 = 
x86_œã_time_öô
;

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/u£r.h
>

5 
	~<löux/ªg£t.h
>

7 
	~<asm/uac˚ss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy°em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/¥Ÿo.h
>

13 
	~<asm/sysˇŒs.h
>

15 
	~"és.h
"

20 
	$gë_‰ì_idx
()

22 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 i‡(
	`desc_em±y
(&
t
->
és_¨øy
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_és_desc
(
èsk_°ru˘
 *
p
, 
idx
,

32 c⁄° 
u£r_desc
 *
öfo
, 
n
)

34 
thªad_°ru˘
 *
t
 = &
p
->
thªad
;

35 
desc_°ru˘
 *
desc
 = &
t
->
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
˝u
;

41 
˝u
 = 
	`gë_˝u
();

43 
n
-- > 0) {

44 i‡(
	`LDT_em±y
(
öfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fûl_ldt
(
desc
, 
öfo
);

48 ++
öfo
;

49 ++
desc
;

52 i‡(
t
 =&
cuºít
->
thªad
)

53 
	`lﬂd_TLS
(
t
, 
˝u
);

55 
	`put_˝u
();

56 
	}
}

61 
	$do_£t_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_öfo
,

63 
ˇn_Æloˇã
)

65 
u£r_desc
 
öfo
;

67 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
u_öfo
, (info)))

68  -
EFAULT
;

70 i‡(
idx
 == -1)

71 
idx
 = 
öfo
.
íåy_numbî
;

77 i‡(
idx
 =-1 && 
ˇn_Æloˇã
) {

78 
idx
 = 
	`gë_‰ì_idx
();

79 i‡(
idx
 < 0)

80  
idx
;

81 i‡(
	`put_u£r
(
idx
, &
u_öfo
->
íåy_numbî
))

82  -
EFAULT
;

85 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_és_desc
(
p
, 
idx
, &
öfo
, 1);

91 
	}
}

93 
asmlökage
 
	$sys_£t_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

95 
ªt
 = 
	`do_£t_thªad_¨ó
(
cuºít
, -1, 
u_öfo
, 1);

96 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

97  
ªt
;

98 
	}
}

105 
	$fûl_u£r_desc
(
u£r_desc
 *
öfo
, 
idx
,

106 c⁄° 
desc_°ru˘
 *
desc
)

109 
	`mem£t
(
öfo
, 0, (*info));

110 
öfo
->
íåy_numbî
 = 
idx
;

111 
öfo
->
ba£_addr
 = 
	`gë_desc_ba£
(
desc
);

112 
öfo
->
limô
 = 
	`gë_desc_limô
(
desc
);

113 
öfo
->
£g_32bô
 = 
desc
->
d
;

114 
öfo
->
c⁄ã¡s
 = 
desc
->
ty≥
 >> 2;

115 
öfo
->
ªad_exec_⁄ly
 = !(
desc
->
ty≥
 & 2);

116 
öfo
->
limô_ö_∑ges
 = 
desc
->
g
;

117 
öfo
->
£g_nŸ_¥e£¡
 = !
desc
->
p
;

118 
öfo
->
u£abÀ
 = 
desc
->
avl
;

119 #ifde‡
CONFIG_X86_64


120 
öfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_gë_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_öfo
)

127 
u£r_desc
 
öfo
;

129 i‡(
idx
 =-1 && 
	`gë_u£r
(idx, &
u_öfo
->
íåy_numbî
))

130  -
EFAULT
;

132 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fûl_u£r_desc
(&
öfo
, 
idx
,

136 &
p
->
thªad
.
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 i‡(
	`c›y_to_u£r
(
u_öfo
, &
öfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlökage
 
	$sys_gë_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

145 
ªt
 = 
	`do_gë_thªad_¨ó
(
cuºít
, -1, 
u_öfo
);

146 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

147  
ªt
;

148 
	}
}

150 
	$ªg£t_és_a˘ive
(
èsk_°ru˘
 *
èrgë
,

151 c⁄° 
u£r_ªg£t
 *
ªg£t
)

153 
thªad_°ru˘
 *
t
 = &
èrgë
->
thªad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
és_¨øy
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$ªg£t_és_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

161 
pos
, 
cou¡
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 c⁄° 
desc_°ru˘
 *
és
;

166 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
cou¡
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /(
u£r_desc
);

172 
cou¡
 /(
u£r_desc
);

174 
és
 = &
èrgë
->
thªad
.
és_¨øy
[
pos
];

176 i‡(
kbuf
) {

177 
u£r_desc
 *
öfo
 = 
kbuf
;

178 
cou¡
-- > 0)

179 
	`fûl_u£r_desc
(
öfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
és
++);

182 
u£r_desc
 
__u£r
 *
u_öfo
 = 
ubuf
;

183 
cou¡
-- > 0) {

184 
u£r_desc
 
öfo
;

185 
	`fûl_u£r_desc
(&
öfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
és
++);

186 i‡(
	`__c›y_to_u£r
(
u_öfo
++, &
öfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$ªg£t_és_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
u£r_desc
 
öfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 c⁄° 
u£r_desc
 *
öfo
;

201 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
cou¡
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 i‡(
kbuf
)

207 
öfo
 = 
kbuf
;

208 i‡(
	`__c›y_‰om_u£r
(
öfobuf
, 
ubuf
, 
cou¡
))

209  -
EFAULT
;

211 
öfo
 = 
öfobuf
;

213 
	`£t_és_desc
(
èrgë
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
öfo
, 
cou¡
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<löux/nodemask.h
>

29 
	~<löux/mmz⁄e.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<asm/˝u.h
>

34 
DEFINE_PER_CPU
(
x86_˝u
, 
˝u_devi˚s
);

36 #ifde‡
CONFIG_HOTPLUG_CPU


37 
__ªf
 
	$¨ch_ªgi°î_˝u
(
num
)

48 i‡(
num
)

49 
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
.
hŸ∂uggabÀ
 = 1;

51  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

52 
	}
}

53 
EXPORT_SYMBOL
(
¨ch_ªgi°î_˝u
);

55 
	$¨ch_uƒegi°î_˝u
(
num
)

57 
	`uƒegi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¨ch_uƒegi°î_˝u
);

62 
__öô
 
	$¨ch_ªgi°î_˝u
(
num
)

64  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

65 
	}
}

68 
__öô
 
	$t›ﬁogy_öô
()

70 
i
;

72 #ifde‡
CONFIG_NUMA


73 
	`f‹_óch_⁄löe_node
(
i
)

74 
	`ªgi°î_⁄e_node
(
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
i
)

78 
	`¨ch_ªgi°î_˝u
(
i
);

81 
	}
}

82 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<löux/io.h
>

3 
	~<asm/åampﬁöe.h
>

4 
	~<asm/e820.h
>

6 #i‡
deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_ACPI_SLEEP
)

7 
	#__åampöô


	)

8 
	#__åampöôd©a


	)

10 
	#__åampöô
 
__˝uöô


	)

11 
	#__åampöôd©a
 
__˝uöôd©a


	)

15 *
__åampöôd©a
 
	gåampﬁöe_ba£
;

17 
__öô
 
	$ª£rve_åampﬁöe_mem‹y
()

19 
mem
;

22 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
TRAMPOLINE_SIZE
, 
PAGE_SIZE
);

23 i‡(
mem
 == -1L)

24 
	`∑nic
("CannotállocateÅrampoline\n");

26 
åampﬁöe_ba£
 = 
	`__va
(
mem
);

27 
	`ª£rve_óæy
(
mem
, mem + 
TRAMPOLINE_SIZE
, "TRAMPOLINE");

28 
	}
}

35 
__åampöô
 
	$£tup_åampﬁöe
()

37 
	`mem˝y
(
åampﬁöe_ba£
, 
åampﬁöe_d©a
, 
TRAMPOLINE_SIZE
);

38  
	`vút_to_phys
(
åampﬁöe_ba£
);

39 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<löux/öãºu±.h
>

13 
	~<löux/kÆlsyms.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/k¥obes.h
>

16 
	~<löux/uac˚ss.h
>

17 
	~<löux/kdebug.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/±ø˚.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/î∫o.h
>

24 
	~<löux/kexec.h
>

25 
	~<löux/sched.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/öô.h
>

28 
	~<löux/bug.h
>

29 
	~<löux/nmi.h
>

30 
	~<löux/mm.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/io.h
>

34 #ifde‡
CONFIG_EISA


35 
	~<löux/i›‹t.h
>

36 
	~<löux/eiß.h
>

39 #ifde‡
CONFIG_MCA


40 
	~<löux/mˇ.h
>

43 #i‡
deföed
(
CONFIG_EDAC
)

44 
	~<löux/edac.h
>

47 
	~<asm/kmemcheck.h
>

48 
	~<asm/°ackåa˚.h
>

49 
	~<asm/¥o˚ss‹.h
>

50 
	~<asm/debugªg.h
>

51 
	~<asm/©omic.h
>

52 
	~<asm/sy°em.h
>

53 
	~<asm/å≠s.h
>

54 
	~<asm/desc.h
>

55 
	~<asm/i387.h
>

56 
	~<asm/m˚.h
>

58 
	~<asm/mach_å≠s.h
>

60 #ifde‡
CONFIG_X86_64


61 
	~<asm/x86_öô.h
>

62 
	~<asm/pgÆloc.h
>

63 
	~<asm/¥Ÿo.h
>

65 
	~<asm/¥o˚ss‹-Êags.h
>

66 
	~<asm/£tup.h
>

68 
asmlökage
 
sy°em_ˇŒ
();

71 
	gign‹e_Âu_úq
;

77 
g©e_desc
 
	gidt_èbÀ
[
NR_VECTORS
] 
	g__∑ge_Æig√d_d©a
 = { { { { 0, 0 } } }, };

80 
DECLARE_BITMAP
(
u£d_ve˘‹s
, 
NR_VECTORS
);

81 
EXPORT_SYMBOL_GPL
(
u£d_ve˘‹s
);

83 
	gign‹e_nmis
;

85 
ölöe
 
	$c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

87 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

88 
	`loˇl_úq_íabÀ
();

89 
	}
}

91 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

93 
	`öc_¥ìm±_cou¡
();

94 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

95 
	`loˇl_úq_íabÀ
();

96 
	}
}

98 
ölöe
 
	$c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

100 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

101 
	`loˇl_úq_dißbÀ
();

102 
	}
}

104 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

106 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

107 
	`loˇl_úq_dißbÀ
();

108 
	`dec_¥ìm±_cou¡
();

109 
	}
}

111 #ifde‡
CONFIG_X86_32


112 
ölöe
 

113 
	$dõ_if_kî√l
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

115 i‡(!
	`u£r_mode_vm
(
ªgs
))

116 
	`dõ
(
°r
, 
ªgs
, 
îr
);

117 
	}
}

120 
__k¥obes


121 
	$do_å≠
(
å≠ƒ
, 
sigƒ
, *
°r
, 
±_ªgs
 *
ªgs
,

122 
îr‹_code
, 
sigöfo_t
 *
öfo
)

124 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

126 #ifde‡
CONFIG_X86_32


127 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

132 i‡(
å≠ƒ
 < 6)

133 
vm86_å≠
;

134 
å≠_sig«l
;

138 i‡(!
	`u£r_mode
(
ªgs
))

139 
kî√l_å≠
;

141 #ifde‡
CONFIG_X86_32


142 
å≠_sig«l
:

153 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

154 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

156 #ifde‡
CONFIG_X86_64


157 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
sigƒ
) &&

158 
	`¥ötk_øãlimô
()) {

159 
	`¥ötk
(
KERN_INFO


161 
tsk
->
comm
,Åsk->
pid
, 
°r
,

162 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

163 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

164 
	`¥ötk
("\n");

168 i‡(
öfo
)

169 
	`f‹˚_sig_öfo
(
sigƒ
, 
öfo
, 
tsk
);

171 
	`f‹˚_sig
(
sigƒ
, 
tsk
);

174 
kî√l_å≠
:

175 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

176 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

177 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

178 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

182 #ifde‡
CONFIG_X86_32


183 
vm86_å≠
:

184 i‡(
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

185 
îr‹_code
, 
å≠ƒ
))

186 
å≠_sig«l
;

189 
	}
}

191 
	#DO_ERROR
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
) \

192 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

194 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

195 =
NOTIFY_STOP
) \

197 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

198 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, 
NULL
); \

199 }

	)

201 
	#DO_ERROR_INFO
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
, 
sicode
, 
süddr
) \

202 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

204 
sigöfo_t
 
öfo
; \

205 
öfo
.
si_signo
 = 
sigƒ
; \

206 
öfo
.
si_î∫o
 = 0; \

207 
öfo
.
si_code
 = 
sicode
; \

208 
öfo
.
si_addr
 = (
__u£r
 *)
süddr
; \

209 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

210 =
NOTIFY_STOP
) \

212 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

213 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, &
öfo
); \

214 }

	)

216 
DO_ERROR_INFO
(0, 
SIGFPE
, "dividêîr‹", 
divide_îr‹
, 
FPE_INTDIV
, 
ªgs
->
ù
)

217 
DO_ERROR
(4, 
SIGSEGV
, "ovîÊow", 
ovîÊow
)

218 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

219 
DO_ERROR_INFO
(6, 
SIGILL
, "övÆid opcode", 
övÆid_›
, 
ILL_ILLOPN
, 
ªgs
->
ù
)

220 
DO_ERROR
(9, 
SIGFPE
, "c›ro˚ss‹ segmíàovîrun", 
c›ro˚ss‹_£gmít_ovîrun
)

221 
DO_ERROR
(10, 
SIGSEGV
, "övÆid TSS", 
övÆid_TSS
)

222 
DO_ERROR
(11, 
SIGBUS
, "£gmíànŸÖª£¡", 
£gmít_nŸ_¥e£¡
)

223 #ifde‡
CONFIG_X86_32


224 
DO_ERROR
(12, 
SIGBUS
, "°ack segmít", 
°ack_£gmít
)

226 
DO_ERROR_INFO
(17, 
SIGBUS
, "Æignmíàcheck", 
Æignmít_check
, 
BUS_ADRALN
, 0)

228 #ifde‡
CONFIG_X86_64


230 
dŸø∂ökage
 
	$do_°ack_£gmít
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

232 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "°ack segmít", 
ªgs
, 
îr‹_code
,

233 12, 
SIGBUS
Ë=
NOTIFY_STOP
)

235 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

236 
	`do_å≠
(12, 
SIGBUS
, "°ack segmít", 
ªgs
, 
îr‹_code
, 
NULL
);

237 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

238 
	}
}

240 
dŸø∂ökage
 
	$do_doubÀ_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

242 c⁄° 
°r
[] = "double fault";

243 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

246 
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 8, 
SIGSEGV
);

248 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

249 
tsk
->
thªad
.
å≠_no
 = 8;

256 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

257 
	}
}

260 
dŸø∂ökage
 
__k¥obes


261 
	$do_gíîÆ_¥Ÿe˘i⁄
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

263 
èsk_°ru˘
 *
tsk
;

265 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

267 #ifde‡
CONFIG_X86_32


268 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

269 
gp_ö_vm86
;

272 
tsk
 = 
cuºít
;

273 i‡(!
	`u£r_mode
(
ªgs
))

274 
gp_ö_kî√l
;

276 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

277 
tsk
->
thªad
.
å≠_no
 = 13;

279 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
) &&

280 
	`¥ötk_øãlimô
()) {

281 
	`¥ötk
(
KERN_INFO


283 
tsk
->
comm
, 
	`èsk_pid_ƒ
(tsk),

284 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

285 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

286 
	`¥ötk
("\n");

289 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

292 #ifde‡
CONFIG_X86_32


293 
gp_ö_vm86
:

294 
	`loˇl_úq_íabÀ
();

295 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
);

299 
gp_ö_kî√l
:

300 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

303 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

304 
tsk
->
thªad
.
å≠_no
 = 13;

305 i‡(
	`nŸify_dõ
(
DIE_GPF
, "gíîÆÖrŸe˘i⁄ fau…", 
ªgs
,

306 
îr‹_code
, 13, 
SIGSEGV
Ë=
NOTIFY_STOP
)

308 
	`dõ
("gíîÆÖrŸe˘i⁄ fau…", 
ªgs
, 
îr‹_code
);

309 
	}
}

311 
nŸø˚
 
__k¥obes
 

312 
	$mem_∑rôy_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

314 
	`¥ötk
(
KERN_EMERG


316 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

318 
	`¥ötk
(
KERN_EMERG


321 #i‡
	`deföed
(
CONFIG_EDAC
)

322 i‡(
	`edac_h™dÀr_£t
()) {

323 
	`edac_©omic_as£π_îr‹
();

328 i‡(
∑nic_⁄_uƒecovîed_nmi
)

329 
	`∑nic
("NMI: Not continuing");

331 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

334 
ªas⁄
 = (reason & 0xf) | 4;

335 
	`outb
(
ªas⁄
, 0x61);

336 
	}
}

338 
nŸø˚
 
__k¥obes
 

339 
	$io_check_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

341 
i
;

343 
	`¥ötk
(
KERN_EMERG
 "NMI: IOCKÉrror (debug interrupt?)\n");

344 
	`show_ªgi°îs
(
ªgs
);

346 i‡(
∑nic_⁄_io_nmi
)

347 
	`∑nic
("NMI IOCKÉrror: Not continuing");

350 
ªas⁄
 = (reason & 0xf) | 8;

351 
	`outb
(
ªas⁄
, 0x61);

353 
i
 = 2000;

354 --
i
)

355 
	`udñay
(1000);

357 
ªas⁄
 &= ~8;

358 
	`outb
(
ªas⁄
, 0x61);

359 
	}
}

361 
nŸø˚
 
__k¥obes
 

362 
	$unknown_nmi_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

364 i‡(
	`nŸify_dõ
(
DIE_NMIUNKNOWN
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
) ==

365 
NOTIFY_STOP
)

367 #ifde‡
CONFIG_MCA


372 i‡(
MCA_bus
) {

373 
	`mˇ_h™dÀ_nmi
();

377 
	`¥ötk
(
KERN_EMERG


379 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

381 
	`¥ötk
(
KERN_EMERG
 "Do you haveá strangeÖower saving modeÉnabled?\n");

382 i‡(
∑nic_⁄_uƒecovîed_nmi
)

383 
	`∑nic
("NMI: Not continuing");

385 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

386 
	}
}

388 
nŸø˚
 
__k¥obes
 
	$deÁu…_do_nmi
(
±_ªgs
 *
ªgs
)

390 
ªas⁄
 = 0;

391 
˝u
;

393 
˝u
 = 
	`smp_¥o˚ss‹_id
();

396 i‡(!
˝u
)

397 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

399 i‡(!(
ªas⁄
 & 0xc0)) {

400 i‡(
	`nŸify_dõ
(
DIE_NMI_IPI
, "nmi_ùi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

401 =
NOTIFY_STOP
)

403 #ifde‡
CONFIG_X86_LOCAL_APIC


408 i‡(
	`nmi_w©chdog_tick
(
ªgs
, 
ªas⁄
))

410 i‡(!
	`do_nmi_ˇŒback
(
ªgs
, 
˝u
))

411 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

413 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

418 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

422 i‡(
ªas⁄
 & 0x80)

423 
	`mem_∑rôy_îr‹
(
ªas⁄
, 
ªgs
);

424 i‡(
ªas⁄
 & 0x40)

425 
	`io_check_îr‹
(
ªas⁄
, 
ªgs
);

426 #ifde‡
CONFIG_X86_32


431 
	`ªas£π_nmi
();

433 
	}
}

435 
dŸø∂ökage
 
nŸø˚
 
__k¥obes
 

436 
	$do_nmi
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

438 
	`nmi_íãr
();

440 
	`öc_úq_°©
(
__nmi_cou¡
);

442 i‡(!
ign‹e_nmis
)

443 
	`deÁu…_do_nmi
(
ªgs
);

445 
	`nmi_exô
();

446 
	}
}

448 
	$°›_nmi
()

450 
	`a˝i_nmi_dißbÀ
();

451 
ign‹e_nmis
++;

452 
	}
}

454 
	$ª°¨t_nmi
()

456 
ign‹e_nmis
--;

457 
	`a˝i_nmi_íabÀ
();

458 
	}
}

461 
dŸø∂ökage
 
__k¥obes
 
	$do_öt3
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

463 #ifde‡
CONFIG_KPROBES


464 i‡(
	`nŸify_dõ
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

465 =
NOTIFY_STOP
)

468 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

469 =
NOTIFY_STOP
)

473 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

474 
	`do_å≠
(3, 
SIGTRAP
, "öt3", 
ªgs
, 
îr‹_code
, 
NULL
);

475 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

476 
	}
}

478 #ifde‡
CONFIG_X86_64


484 
asmlökage
 
__k¥obes
 
±_ªgs
 *
	$sync_ªgs
(
±_ªgs
 *
îegs
)

486 
±_ªgs
 *
ªgs
 = 
îegs
;

488 i‡(
îegs
 =(
±_ªgs
 *Îªgs->
•
)

491 i‡(
	`u£r_mode
(
îegs
))

492 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

497 i‡(
îegs
->
Êags
 & 
X86_EFLAGS_IF
)

498 
ªgs
 = (
±_ªgs
 *)(
îegs
->
•
 -= (pt_regs));

499 i‡(
îegs
 !
ªgs
)

500 *
ªgs
 = *
îegs
;

501  
ªgs
;

502 
	}
}

529 
dŸø∂ökage
 
__k¥obes
 
	$do_debug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

531 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

532 
dr6
;

533 
si_code
;

535 
	`gë_debugªg
(
dr6
, 6);

538 i‡((
dr6
 & 
DR_STEP
Ë&& 
	`kmemcheck_å≠
(
ªgs
))

542 
	`£t_debugªg
(0, 6);

546 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUGCTLMSR
);

547 
tsk
->
thªad
.
debug˘lm§
 = 0;

550 
tsk
->
thªad
.
debugªg6
 = 
dr6
;

552 i‡(
	`nŸify_dõ
(
DIE_DEBUG
, "debug", 
ªgs
, 
	`PTR_ERR
(&
dr6
), 
îr‹_code
,

553 
SIGTRAP
Ë=
NOTIFY_STOP
)

557 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

559 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

560 
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

561 
îr‹_code
, 1);

572 i‡((
dr6
 & 
DR_STEP
Ë&& !
	`u£r_mode
(
ªgs
)) {

573 
tsk
->
thªad
.
debugªg6
 &~
DR_STEP
;

574 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_SINGLESTEP
);

575 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

577 
si_code
 = 
	`gë_si_code
(
tsk
->
thªad
.
debugªg6
);

578 i‡(
tsk
->
thªad
.
debugªg6
 & (
DR_STEP
 | 
DR_TRAP_BITS
))

579 
	`£nd_sigå≠
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
);

580 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

583 
	}
}

585 #ifde‡
CONFIG_X86_64


586 
	$kî√l_m©h_îr‹
(
±_ªgs
 *
ªgs
, c⁄° *
°r
, 
å≠ƒ
)

588 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

591 
	`nŸify_dõ
(
DIE_GPF
, 
°r
, 
ªgs
, 0, 
å≠ƒ
, 
SIGFPE
);

593 
cuºít
->
thªad
.
å≠_no
 = 
å≠ƒ
;

594 
	`dõ
(
°r
, 
ªgs
, 0);

596 
	}
}

604 
	$m©h_îr‹
(
__u£r
 *
ù
)

606 
èsk_°ru˘
 *
èsk
;

607 
sigöfo_t
 
öfo
;

608 
cwd
, 
swd
, 
îr
;

613 
èsk
 = 
cuºít
;

614 
	`ßve_öô_Âu
(
èsk
);

615 
èsk
->
thªad
.
å≠_no
 = 16;

616 
èsk
->
thªad
.
îr‹_code
 = 0;

617 
öfo
.
si_signo
 = 
SIGFPE
;

618 
öfo
.
si_î∫o
 = 0;

619 
öfo
.
si_addr
 = 
ù
;

630 
cwd
 = 
	`gë_Âu_cwd
(
èsk
);

631 
swd
 = 
	`gë_Âu_swd
(
èsk
);

633 
îr
 = 
swd
 & ~
cwd
;

635 i‡(
îr
 & 0x001) {

641 
öfo
.
si_code
 = 
FPE_FLTINV
;

642 } i‡(
îr
 & 0x004) {

643 
öfo
.
si_code
 = 
FPE_FLTDIV
;

644 } i‡(
îr
 & 0x008) {

645 
öfo
.
si_code
 = 
FPE_FLTOVF
;

646 } i‡(
îr
 & 0x012) {

647 
öfo
.
si_code
 = 
FPE_FLTUND
;

648 } i‡(
îr
 & 0x020) {

649 
öfo
.
si_code
 = 
FPE_FLTRES
;

657 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

658 
	}
}

660 
dŸø∂ökage
 
	$do_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

662 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

664 #ifde‡
CONFIG_X86_32


665 
ign‹e_Âu_úq
 = 1;

667 i‡(!
	`u£r_mode
(
ªgs
) &&

668 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel x87 mathÉrror", 16))

672 
	`m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

673 
	}
}

675 
	$simd_m©h_îr‹
(
__u£r
 *
ù
)

677 
èsk_°ru˘
 *
èsk
;

678 
sigöfo_t
 
öfo
;

679 
mxc§
;

684 
èsk
 = 
cuºít
;

685 
	`ßve_öô_Âu
(
èsk
);

686 
èsk
->
thªad
.
å≠_no
 = 19;

687 
èsk
->
thªad
.
îr‹_code
 = 0;

688 
öfo
.
si_signo
 = 
SIGFPE
;

689 
öfo
.
si_î∫o
 = 0;

690 
öfo
.
si_code
 = 
__SI_FAULT
;

691 
öfo
.
si_addr
 = 
ù
;

698 
mxc§
 = 
	`gë_Âu_mxc§
(
èsk
);

699 ~((
mxc§
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

704 
öfo
.
si_code
 = 
FPE_FLTINV
;

708 
öfo
.
si_code
 = 
FPE_FLTUND
;

711 
öfo
.
si_code
 = 
FPE_FLTDIV
;

714 
öfo
.
si_code
 = 
FPE_FLTOVF
;

717 
öfo
.
si_code
 = 
FPE_FLTRES
;

720 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

721 
	}
}

723 
dŸø∂ökage
 

724 
	$do_simd_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

726 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

728 #ifde‡
CONFIG_X86_32


729 i‡(
˝u_has_xmm
) {

731 
ign‹e_Âu_úq
 = 1;

732 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

739 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

740 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *)
ªgs
, 
îr‹_code
);

743 
cuºít
->
thªad
.
å≠_no
 = 19;

744 
cuºít
->
thªad
.
îr‹_code
 =Érror_code;

745 
	`dõ_if_kî√l
("ˇchêÊush díõd", 
ªgs
, 
îr‹_code
);

746 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

748 i‡(!
	`u£r_mode
(
ªgs
) &&

749 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel simd mathÉrror", 19))

751 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

753 
	}
}

755 
dŸø∂ökage
 

756 
	$do_•urious_öãºu±_bug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

758 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

761 
	`¥ötk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

763 
	}
}

765 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thîmÆ_öãºu±
()

767 
	}
}

769 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thªshﬁd_öãºu±
()

771 
	}
}

777 
	$__m©h_°©e_ª°‹e
()

779 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

780 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

785 i‡(
	`u∆ikñy
(
	`ª°‹e_Âu_checkög
(
tsk
))) {

786 
	`°ts
();

787 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

791 
thªad
->
°©us
 |
TS_USEDFPU
;

792 
tsk
->
Âu_cou¡î
++;

793 
	}
}

805 
asmlökage
 
	$m©h_°©e_ª°‹e
()

807 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

808 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

810 i‡(!
	`tsk_u£d_m©h
(
tsk
)) {

811 
	`loˇl_úq_íabÀ
();

815 i‡(
	`öô_Âu
(
tsk
)) {

819 
	`do_group_exô
(
SIGKILL
);

822 
	`loˇl_úq_dißbÀ
();

825 
	`˛ts
();

827 
	`__m©h_°©e_ª°‹e
();

828 
	}
}

829 
EXPORT_SYMBOL_GPL
(
m©h_°©e_ª°‹e
);

831 #i‚de‡
CONFIG_MATH_EMULATION


832 
	$m©h_emuœã
(
m©h_emu_öfo
 *
öfo
)

834 
	`¥ötk
(
KERN_EMERG


836 
	`¥ötk
(
KERN_EMERG
 "kûlög %s.\n", 
cuºít
->
comm
);

837 
	`f‹˚_sig
(
SIGFPE
, 
cuºít
);

838 
	`scheduÀ
();

839 
	}
}

842 
dŸø∂ökage
 
__k¥obes


843 
	$do_devi˚_nŸ_avaûabÀ
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

845 #ifde‡
CONFIG_X86_32


846 i‡(
	`ªad_¸0
(Ë& 
X86_CR0_EM
) {

847 
m©h_emu_öfo
 
öfo
 = { };

849 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

851 
öfo
.
ªgs
 =Ñegs;

852 
	`m©h_emuœã
(&
öfo
);

854 
	`m©h_°©e_ª°‹e
();

855 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

858 
	`m©h_°©e_ª°‹e
();

860 
	}
}

862 #ifde‡
CONFIG_X86_32


863 
dŸø∂ökage
 
	$do_úë_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

865 
sigöfo_t
 
öfo
;

866 
	`loˇl_úq_íabÀ
();

868 
öfo
.
si_signo
 = 
SIGILL
;

869 
öfo
.
si_î∫o
 = 0;

870 
öfo
.
si_code
 = 
ILL_BADSTK
;

871 
öfo
.
si_addr
 = 
NULL
;

872 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "iretÉxception",

873 
ªgs
, 
îr‹_code
, 32, 
SIGILL
Ë=
NOTIFY_STOP
)

875 
	`do_å≠
(32, 
SIGILL
, "úëÉx˚±i⁄", 
ªgs
, 
îr‹_code
, &
öfo
);

876 
	}
}

879 
__öô
 
	$å≠_öô
()

881 
i
;

883 #ifde‡
CONFIG_EISA


884 
__iomem
 *
p
 = 
	`óæy_i‹em≠
(0x0FFFD9, 4);

886 i‡(
	`ªadl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

887 
EISA_bus
 = 1;

888 
	`óæy_iounm≠
(
p
, 4);

891 
	`£t_öå_g©e
(0, &
divide_îr‹
);

892 
	`£t_öå_g©e_i°
(1, &
debug
, 
DEBUG_STACK
);

893 
	`£t_öå_g©e_i°
(2, &
nmi
, 
NMI_STACK
);

895 
	`£t_sy°em_öå_g©e_i°
(3, &
öt3
, 
DEBUG_STACK
);

897 
	`£t_sy°em_öå_g©e
(4, &
ovîÊow
);

898 
	`£t_öå_g©e
(5, &
bounds
);

899 
	`£t_öå_g©e
(6, &
övÆid_›
);

900 
	`£t_öå_g©e
(7, &
devi˚_nŸ_avaûabÀ
);

901 #ifde‡
CONFIG_X86_32


902 
	`£t_èsk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

904 
	`£t_öå_g©e_i°
(8, &
doubÀ_Áu…
, 
DOUBLEFAULT_STACK
);

906 
	`£t_öå_g©e
(9, &
c›ro˚ss‹_£gmít_ovîrun
);

907 
	`£t_öå_g©e
(10, &
övÆid_TSS
);

908 
	`£t_öå_g©e
(11, &
£gmít_nŸ_¥e£¡
);

909 
	`£t_öå_g©e_i°
(12, &
°ack_£gmít
, 
STACKFAULT_STACK
);

910 
	`£t_öå_g©e
(13, &
gíîÆ_¥Ÿe˘i⁄
);

911 
	`£t_öå_g©e
(14, &
∑ge_Áu…
);

912 
	`£t_öå_g©e
(15, &
•urious_öãºu±_bug
);

913 
	`£t_öå_g©e
(16, &
c›ro˚ss‹_îr‹
);

914 
	`£t_öå_g©e
(17, &
Æignmít_check
);

915 #ifde‡
CONFIG_X86_MCE


916 
	`£t_öå_g©e_i°
(18, &
machöe_check
, 
MCE_STACK
);

918 
	`£t_öå_g©e
(19, &
simd_c›ro˚ss‹_îr‹
);

921 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

922 
	`£t_bô
(
i
, 
u£d_ve˘‹s
);

924 #ifde‡
CONFIG_IA32_EMULATION


925 
	`£t_sy°em_öå_g©e
(
IA32_SYSCALL_VECTOR
, 
ü32_sysˇŒ
);

926 
	`£t_bô
(
IA32_SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

929 #ifde‡
CONFIG_X86_32


930 i‡(
˝u_has_fx§
) {

931 
	`¥ötk
(
KERN_INFO
 "Enabling fast FPU saveándÑestore... ");

932 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

933 
	`¥ötk
("done.\n");

935 i‡(
˝u_has_xmm
) {

936 
	`¥ötk
(
KERN_INFO


938 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

939 
	`¥ötk
("done.\n");

942 
	`£t_sy°em_å≠_g©e
(
SYSCALL_VECTOR
, &
sy°em_ˇŒ
);

943 
	`£t_bô
(
SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

949 
	`˝u_öô
();

951 
x86_öô
.
úqs
.
	`å≠_öô
();

952 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/timî.h
>

6 
	~<löux/a˝i_pmtmr.h
>

7 
	~<löux/˝u‰eq.h
>

8 
	~<löux/dmi.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/˛ocksour˚.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/timex.h
>

14 
	~<asm/h≥t.h
>

15 
	~<asm/timî.h
>

16 
	~<asm/vgtod.h
>

17 
	~<asm/time.h
>

18 
	~<asm/dñay.h
>

19 
	~<asm/hy≥rvis‹.h
>

20 
	~<asm/nmi.h
>

21 
	~<asm/x86_öô.h
>

23 
__ªad_mo°ly
 
	g˝u_khz
;

24 
EXPORT_SYMBOL
(
˝u_khz
);

26 
__ªad_mo°ly
 
	gtsc_khz
;

27 
EXPORT_SYMBOL
(
tsc_khz
);

32 
__ªad_mo°ly
 
	gtsc_un°abÀ
;

37 
__ªad_mo°ly
 
	gtsc_dißbÀd
 = -1;

39 
	gtsc_˛ocksour˚_ªlübÀ
;

43 
u64
 
	$«tive_sched_˛ock
()

45 
u64
 
this_off£t
;

55 i‡(
	`u∆ikñy
(
tsc_dißbÀd
)) {

57  (
jiffõs_64
 - 
INITIAL_JIFFIES
Ë* (1000000000 / 
HZ
);

61 
	`rdts˛l
(
this_off£t
);

64  
	`__cy˛es_2_ns
(
this_off£t
);

65 
	}
}

69 #ifde‡
CONFIG_PARAVIRT


70 
	$sched_˛ock
()

72  
	`∑øvút_sched_˛ock
();

73 
	}
}

76 
	$sched_˛ock
(Ë
	`__©åibuã__
((
	`Æüs
("native_sched_clock")));

79 
	$check_tsc_un°abÀ
()

81  
tsc_un°abÀ
;

82 
	}
}

83 
EXPORT_SYMBOL_GPL
(
check_tsc_un°abÀ
);

85 #ifde‡
CONFIG_X86_TSC


86 
__öô
 
	$nŸsc_£tup
(*
°r
)

88 
	`¥ötk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

90 
tsc_dißbÀd
 = 1;

92 
	}
}

98 
__öô
 
	$nŸsc_£tup
(*
°r
)

100 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_TSC
);

102 
	}
}

105 
__£tup
("nŸsc", 
nŸsc_£tup
);

107 
__öô
 
	$tsc_£tup
(*
°r
)

109 i‡(!
	`°rcmp
(
°r
, "reliable"))

110 
tsc_˛ocksour˚_ªlübÀ
 = 1;

112 
	}
}

114 
__£tup
("tsc=", 
tsc_£tup
);

116 
	#MAX_RETRIES
 5

	)

117 
	#SMI_TRESHOLD
 50000

	)

122 
u64
 
	$tsc_ªad_ªfs
(
u64
 *
p
, 
h≥t
)

124 
u64
 
t1
, 
t2
;

125 
i
;

127 
i
 = 0; i < 
MAX_RETRIES
; i++) {

128 
t1
 = 
	`gë_cy˛es
();

129 i‡(
h≥t
)

130 *
p
 = 
	`h≥t_ªadl
(
HPET_COUNTER
) & 0xFFFFFFFF;

132 *
p
 = 
	`a˝i_pm_ªad_óæy
();

133 
t2
 = 
	`gë_cy˛es
();

134 i‡((
t2
 - 
t1
Ë< 
SMI_TRESHOLD
)

135  
t2
;

137  
ULLONG_MAX
;

138 
	}
}

143 
	$ˇlc_h≥t_ªf
(
u64
 
dñètsc
, u64 
h≥t1
, u64 
h≥t2
)

145 
u64
 
tmp
;

147 i‡(
h≥t2
 < 
h≥t1
)

148 
h≥t2
 += 0x100000000ULL;

149 
h≥t2
 -
h≥t1
;

150 
tmp
 = ((
u64
)
h≥t2
 * 
	`h≥t_ªadl
(
HPET_PERIOD
));

151 
	`do_div
(
tmp
, 1000000);

152 
	`do_div
(
dñètsc
, 
tmp
);

154  (Ë
dñètsc
;

155 
	}
}

160 
	$ˇlc_pmtimî_ªf
(
u64
 
dñètsc
, u64 
pm1
, u64 
pm2
)

162 
u64
 
tmp
;

164 i‡(!
pm1
 && !
pm2
)

165  
ULONG_MAX
;

167 i‡(
pm2
 < 
pm1
)

168 
pm2
 +(
u64
)
ACPI_PM_OVRRUN
;

169 
pm2
 -
pm1
;

170 
tmp
 = 
pm2
 * 1000000000LL;

171 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

172 
	`do_div
(
dñètsc
, 
tmp
);

174  (Ë
dñètsc
;

175 
	}
}

177 
	#CAL_MS
 10

	)

178 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

179 
	#CAL_PIT_LOOPS
 1000

	)

181 
	#CAL2_MS
 50

	)

182 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

183 
	#CAL2_PIT_LOOPS
 5000

	)

193 
	$pô_ˇlibøã_tsc
(
u32
 
œtch
, 
ms
, 
lo›mö
)

195 
u64
 
tsc
, 
t1
, 
t2
, 
dñè
;

196 
tscmö
, 
tscmax
;

197 
pô˙t
;

200 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

207 
	`outb
(0xb0, 0x43);

208 
	`outb
(
œtch
 & 0xff, 0x42);

209 
	`outb
(
œtch
 >> 8, 0x42);

211 
tsc
 = 
t1
 = 
t2
 = 
	`gë_cy˛es
();

213 
pô˙t
 = 0;

214 
tscmax
 = 0;

215 
tscmö
 = 
ULONG_MAX
;

216 (
	`öb
(0x61) & 0x20) == 0) {

217 
t2
 = 
	`gë_cy˛es
();

218 
dñè
 = 
t2
 - 
tsc
;

219 
tsc
 = 
t2
;

220 i‡((Ë
dñè
 < 
tscmö
)

221 
tscmö
 = (Ë
dñè
;

222 i‡((Ë
dñè
 > 
tscmax
)

223 
tscmax
 = (Ë
dñè
;

224 
pô˙t
++;

236 i‡(
pô˙t
 < 
lo›mö
 || 
tscmax
 > 10 * 
tscmö
)

237  
ULONG_MAX
;

240 
dñè
 = 
t2
 - 
t1
;

241 
	`do_div
(
dñè
, 
ms
);

242  
dñè
;

243 
	}
}

280 
ölöe
 
	$pô_vîify_msb
(
vÆ
)

283 
	`öb
(0x42);

284  
	`öb
(0x42Ë=
vÆ
;

285 
	}
}

287 
ölöe
 
	$pô_ex≥˘_msb
(
vÆ
, 
u64
 *
ts˝
, *
dñèp
)

289 
cou¡
;

290 
u64
 
tsc
 = 0;

292 
cou¡
 = 0; count < 50000; count++) {

293 i‡(!
	`pô_vîify_msb
(
vÆ
))

295 
tsc
 = 
	`gë_cy˛es
();

297 *
dñèp
 = 
	`gë_cy˛es
(Ë- 
tsc
;

298 *
ts˝
 = 
tsc
;

304  
cou¡
 > 5;

305 
	}
}

313 
	#MAX_QUICK_PIT_MS
 25

	)

314 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

316 
	$quick_pô_ˇlibøã
()

318 
i
;

319 
u64
 
tsc
, 
dñè
;

320 
d1
, 
d2
;

323 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

334 
	`outb
(0xb0, 0x43);

337 
	`outb
(0xff, 0x42);

338 
	`outb
(0xff, 0x42);

346 
	`pô_vîify_msb
(0);

348 i‡(
	`pô_ex≥˘_msb
(0xff, &
tsc
, &
d1
)) {

349 
i
 = 1; i <
MAX_QUICK_PIT_ITERATIONS
; i++) {

350 i‡(!
	`pô_ex≥˘_msb
(0xff-
i
, &
dñè
, &
d2
))

356 
dñè
 -
tsc
;

357 i‡(
d1
+
d2
 >
dñè
 >> 11)

367 i‡(!
	`pô_vîify_msb
(0x„ - 
i
))

369 
suc˚ss
;

372 
	`¥ötk
("Fast TSC calibration failed\n");

375 
suc˚ss
:

391 
dñè
 +()(
d2
 - 
d1
)/2;

392 
dñè
 *
PIT_TICK_RATE
;

393 
	`do_div
(
dñè
, 
i
*256*1000);

394 
	`¥ötk
("Fast TSC calibration using PIT\n");

395  
dñè
;

396 
	}
}

401 
	$«tive_ˇlibøã_tsc
()

403 
u64
 
tsc1
, 
tsc2
, 
dñè
, 
ªf1
, 
ªf2
;

404 
tsc_pô_mö
 = 
ULONG_MAX
, 
tsc_ªf_mö
 = ULONG_MAX;

405 
Êags
, 
œtch
, 
ms
, 
Á°_ˇlibøã
;

406 
h≥t
 = 
	`is_h≥t_íabÀd
(), 
i
, 
lo›mö
;

408 
	`loˇl_úq_ßve
(
Êags
);

409 
Á°_ˇlibøã
 = 
	`quick_pô_ˇlibøã
();

410 
	`loˇl_úq_ª°‹e
(
Êags
);

411 i‡(
Á°_ˇlibøã
)

412  
Á°_ˇlibøã
;

440 
œtch
 = 
CAL_LATCH
;

441 
ms
 = 
CAL_MS
;

442 
lo›mö
 = 
CAL_PIT_LOOPS
;

444 
i
 = 0; i < 3; i++) {

445 
tsc_pô_khz
;

453 
	`loˇl_úq_ßve
(
Êags
);

454 
tsc1
 = 
	`tsc_ªad_ªfs
(&
ªf1
, 
h≥t
);

455 
tsc_pô_khz
 = 
	`pô_ˇlibøã_tsc
(
œtch
, 
ms
, 
lo›mö
);

456 
tsc2
 = 
	`tsc_ªad_ªfs
(&
ªf2
, 
h≥t
);

457 
	`loˇl_úq_ª°‹e
(
Êags
);

460 
tsc_pô_mö
 = 
	`mö
—sc_pô_mö, 
tsc_pô_khz
);

463 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
)

467 i‡(
tsc1
 =
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

470 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

471 i‡(
h≥t
)

472 
tsc2
 = 
	`ˇlc_h≥t_ªf
—sc2, 
ªf1
, 
ªf2
);

474 
tsc2
 = 
	`ˇlc_pmtimî_ªf
—sc2, 
ªf1
, 
ªf2
);

476 
tsc_ªf_mö
 = 
	`mö
—sc_ªf_mö, (Ë
tsc2
);

479 
dñè
 = ((
u64
Ë
tsc_pô_mö
) * 100;

480 
	`do_div
(
dñè
, 
tsc_ªf_mö
);

488 i‡(
dñè
 >= 90 && delta <= 110) {

489 
	`¥ötk
(
KERN_INFO


491 
h≥t
 ? "HPET" : "PMTIMER", 
i
 + 1);

492  
tsc_ªf_mö
;

501 i‡(
i
 =1 && 
tsc_pô_mö
 =
ULONG_MAX
) {

502 
œtch
 = 
CAL2_LATCH
;

503 
ms
 = 
CAL2_MS
;

504 
lo›mö
 = 
CAL2_PIT_LOOPS
;

511 i‡(
tsc_pô_mö
 =
ULONG_MAX
) {

513 
	`¥ötk
(
KERN_WARNING
 "TSC: UnableÅo calibrateágainst PIT\n");

516 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

517 
	`¥ötk
("TSC: NoÑeference (HPET/PMTIMER)ávailable\n");

522 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

523 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

529 
	`¥ötk
(
KERN_INFO
 "TSC: using %sÑeference calibration\n",

530 
h≥t
 ? "HPET" : "PMTIMER");

532  
tsc_ªf_mö
;

536 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

537 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

538  
tsc_pô_mö
;

542 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

543 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

545  
tsc_pô_mö
;

553 
	`¥ötk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

554 
h≥t
 ? "HPET" : "PMTIMER", 
tsc_pô_mö
, 
tsc_ªf_mö
);

555 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

556  
tsc_pô_mö
;

557 
	}
}

559 
	$ªˇlibøã_˝u_khz
()

561 #i‚de‡
CONFIG_SMP


562 
˝u_khz_ﬁd
 = 
˝u_khz
;

564 i‡(
˝u_has_tsc
) {

565 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

566 
˝u_khz
 = 
tsc_khz
;

567 
	`˝u_d©a
(0).
lo›s_≥r_jiffy
 =

568 
	`˝u‰eq_sˇÀ
(
	`˝u_d©a
(0).
lo›s_≥r_jiffy
,

569 
˝u_khz_ﬁd
, 
˝u_khz
);

572  -
ENODEV
;

574  -
ENODEV
;

576 
	}
}

578 
EXPORT_SYMBOL
(
ªˇlibøã_˝u_khz
);

603 
DEFINE_PER_CPU
(, 
cyc2ns
);

604 
DEFINE_PER_CPU
(, 
cyc2ns_off£t
);

606 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
)

608 
tsc_now
, 
ns_now
, *
off£t
;

609 
Êags
, *
sˇÀ
;

611 
	`loˇl_úq_ßve
(
Êags
);

612 
	`sched_˛ock_idÀ_¶ìp_evít
();

614 
sˇÀ
 = &
	`≥r_˝u
(
cyc2ns
, 
˝u
);

615 
off£t
 = &
	`≥r_˝u
(
cyc2ns_off£t
, 
˝u
);

617 
	`rdts˛l
(
tsc_now
);

618 
ns_now
 = 
	`__cy˛es_2_ns
(
tsc_now
);

620 i‡(
˝u_khz
) {

621 *
sˇÀ
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

622 *
off£t
 = 
ns_now
 - (
tsc_now
 * *
sˇÀ
 >> 
CYC2NS_SCALE_FACTOR
);

625 
	`sched_˛ock_idÀ_wakeup_evít
(0);

626 
	`loˇl_úq_ª°‹e
(
Êags
);

627 
	}
}

629 #ifde‡
CONFIG_CPU_FREQ


642 
	gªf_‰eq
;

643 
	glo›s_≥r_jiffy_ªf
;

644 
	gtsc_khz_ªf
;

646 
	$time_˝u‰eq_nŸifõr
(
nŸifõr_block
 *
nb
, 
vÆ
,

647 *
d©a
)

649 
˝u‰eq_‰eqs
 *
‰eq
 = 
d©a
;

650 *
Õj
;

652 i‡(
	`˝u_has
(&
	`˝u_d©a
(
‰eq
->
˝u
), 
X86_FEATURE_CONSTANT_TSC
))

655 
Õj
 = &
boŸ_˝u_d©a
.
lo›s_≥r_jiffy
;

656 #ifde‡
CONFIG_SMP


657 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

658 
Õj
 = &
	`˝u_d©a
(
‰eq
->
˝u
).
lo›s_≥r_jiffy
;

661 i‡(!
ªf_‰eq
) {

662 
ªf_‰eq
 = 
‰eq
->
ﬁd
;

663 
lo›s_≥r_jiffy_ªf
 = *
Õj
;

664 
tsc_khz_ªf
 = 
tsc_khz
;

666 i‡((
vÆ
 =
CPUFREQ_PRECHANGE
 && 
‰eq
->
ﬁd
 < fªq->
√w
) ||

667 (
vÆ
 =
CPUFREQ_POSTCHANGE
 && 
‰eq
->
ﬁd
 > fªq->
√w
) ||

668 (
vÆ
 =
CPUFREQ_RESUMECHANGE
)) {

669 *
Õj
 = 
	`˝u‰eq_sˇÀ
(
lo›s_≥r_jiffy_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

671 
tsc_khz
 = 
	`˝u‰eq_sˇÀ
(
tsc_khz_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

672 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

673 
	`m¨k_tsc_un°abÀ
("cpufreq changes");

676 
	`£t_cyc2ns_sˇÀ
(
tsc_khz
, 
‰eq
->
˝u
);

679 
	}
}

681 
nŸifõr_block
 
	gtime_˝u‰eq_nŸifõr_block
 = {

682 .
nŸifõr_ˇŒ
 = 
time_˝u‰eq_nŸifõr


685 
__öô
 
	$˝u‰eq_tsc
()

687 i‡(!
˝u_has_tsc
)

689 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

691 
	`˝u‰eq_ªgi°î_nŸifõr
(&
time_˝u‰eq_nŸifõr_block
,

692 
CPUFREQ_TRANSITION_NOTIFIER
);

694 
	}
}

696 
c‹e_öôˇŒ
(
˝u‰eq_tsc
);

702 
˛ocksour˚
 
	g˛ocksour˚_tsc
;

716 
cy˛e_t
 
	$ªad_tsc
(
˛ocksour˚
 *
cs
)

718 
cy˛e_t
 
ªt
 = (cy˛e_t)
	`gë_cy˛es
();

720  
ªt
 >
˛ocksour˚_tsc
.
cy˛e_œ°
 ?

721 
ªt
 : 
˛ocksour˚_tsc
.
cy˛e_œ°
;

722 
	}
}

724 #ifde‡
CONFIG_X86_64


725 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_tsc
()

727 
cy˛e_t
 
ªt
;

734 
	`rdtsc_b¨rõr
();

735 
ªt
 = (
cy˛e_t
)
	`vgë_cy˛es
();

736 
	`rdtsc_b¨rõr
();

738  
ªt
 >
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 ?

739 
ªt
 : 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

740 
	}
}

743 
	$ªsume_tsc
()

745 
˛ocksour˚_tsc
.
cy˛e_œ°
 = 0;

746 
	}
}

748 
˛ocksour˚
 
	g˛ocksour˚_tsc
 = {

749 .
«me
 = "tsc",

750 .
	gøtög
 = 300,

751 .
	gªad
 = 
ªad_tsc
,

752 .
	gªsume
 = 
ªsume_tsc
,

753 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

754 .
	gshi·
 = 22,

755 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

756 
CLOCK_SOURCE_MUST_VERIFY
,

757 #ifde‡
CONFIG_X86_64


758 .
	gvªad
 = 
vªad_tsc
,

762 
	$m¨k_tsc_un°abÀ
(*
ªas⁄
)

764 i‡(!
tsc_un°abÀ
) {

765 
tsc_un°abÀ
 = 1;

766 
sched_˛ock_°abÀ
 = 0;

767 
	`¥ötk
(
KERN_INFO
 "M¨kög TSC un°abÀ duêtÿ%s\n", 
ªas⁄
);

769 i‡(
˛ocksour˚_tsc
.
mu…
)

770 
	`˛ocksour˚_m¨k_un°abÀ
(&
˛ocksour˚_tsc
);

772 
˛ocksour˚_tsc
.
Êags
 |
CLOCK_SOURCE_UNSTABLE
;

773 
˛ocksour˚_tsc
.
øtög
 = 0;

776 
	}
}

778 
EXPORT_SYMBOL_GPL
(
m¨k_tsc_un°abÀ
);

780 
__öô
 
	$dmi_m¨k_tsc_un°abÀ
(c⁄° 
dmi_sy°em_id
 *
d
)

782 
	`¥ötk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

783 
d
->
idít
);

784 
tsc_un°abÀ
 = 1;

786 
	}
}

789 
dmi_sy°em_id
 
__öôd©a
 
	gbad_tsc_dmi_èbÀ
[] = {

791 .
ˇŒback
 = 
dmi_m¨k_tsc_un°abÀ
,

792 .
	gidít
 = "IBM Thinkpad 380XD",

793 .
	gm©ches
 = {

794 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

795 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

801 
__öô
 
	$check_sy°em_tsc_ªlübÀ
()

803 #ifde‡
CONFIG_MGEODE_LX


805 
	#RTSC_SUSP
 0x100

	)

806 
ªs_low
, 
ªs_high
;

808 
	`rdm§_ß„
(
MSR_GEODE_BUSCONT_CONF0
, &
ªs_low
, &
ªs_high
);

810 i‡(
ªs_low
 & 
RTSC_SUSP
)

811 
tsc_˛ocksour˚_ªlübÀ
 = 1;

813 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

814 
tsc_˛ocksour˚_ªlübÀ
 = 1;

815 
	}
}

821 
__˝uöô
 
	$unsynchr⁄ized_tsc
()

823 i‡(!
˝u_has_tsc
 || 
tsc_un°abÀ
)

826 #ifde‡
CONFIG_SMP


827 i‡(
	`≠ic_is_˛u°îed_box
())

831 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

837 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
) {

839 i‡(
	`num_possibÀ_˝us
() > 1)

840 
tsc_un°abÀ
 = 1;

843  
tsc_un°abÀ
;

844 
	}
}

846 
__öô
 
	$öô_tsc_˛ocksour˚
()

848 
˛ocksour˚_tsc
.
mu…
 = 
	`˛ocksour˚_khz2mu…
(
tsc_khz
,

849 
˛ocksour˚_tsc
.
shi·
);

850 i‡(
tsc_˛ocksour˚_ªlübÀ
)

851 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_MUST_VERIFY
;

853 i‡(
	`check_tsc_un°abÀ
()) {

854 
˛ocksour˚_tsc
.
øtög
 = 0;

855 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_IS_CONTINUOUS
;

857 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_tsc
);

858 
	}
}

860 #ifde‡
CONFIG_X86_64


865 
	#TICK_COUNT
 100000000

	)

866 
__öô
 
	$ˇlibøã_˝u
()

868 
tsc_°¨t
, 
tsc_now
;

869 
i
, 
no_˘r_‰ì
;

870 
ev¡£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

871 
Êags
;

873 
i
 = 0; i < 4; i++)

874 i‡(
	`avaû_to_ª§v_≥rf˘r_nmi_bô
(
i
))

876 
no_˘r_‰ì
 = (
i
 == 4);

877 i‡(
no_˘r_‰ì
) {

878 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMDÖerfctrs busy ... "

880 
i
 = 3;

881 
	`rdm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

882 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

883 
	`rdm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

885 
	`ª£rve_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

886 
	`ª£rve_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

888 
	`loˇl_úq_ßve
(
Êags
);

890 
	`wrm§l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

891 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

892 
	`rdts˛
(
tsc_°¨t
);

894 
	`rdm§l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

895 
tsc_now
 = 
	`gë_cy˛es
();

896 } (
tsc_now
 - 
tsc_°¨t
Ë< 
TICK_COUNT
);

898 
	`loˇl_úq_ª°‹e
(
Êags
);

899 i‡(
no_˘r_‰ì
) {

900 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

901 
	`wrm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

902 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

904 
	`ªÀa£_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

905 
	`ªÀa£_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

908  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_°¨t
);

909 
	}
}

911 
ölöe
 
	$ˇlibøã_˝u
(Ë{  
˝u_khz
; 
	}
}

914 
__öô
 
	$tsc_öô
()

916 
u64
 
Õj
;

917 
˝u
;

919 
x86_öô
.
timîs
.
	`tsc_¥e_öô
();

921 i‡(!
˝u_has_tsc
)

924 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

925 
˝u_khz
 = 
tsc_khz
;

927 i‡(!
tsc_khz
) {

928 
	`m¨k_tsc_un°abÀ
("couldÇot calculate TSC khz");

932 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

933 (
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
))

934 
˝u_khz
 = 
	`ˇlibøã_˝u
();

936 
	`¥ötk
("Detected %lu.%03lu MHzÖrocessor.\n",

937 ()
˝u_khz
 / 1000,

938 ()
˝u_khz
 % 1000);

946 
	`f‹_óch_possibÀ_˝u
(
˝u
)

947 
	`£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
);

949 i‡(
tsc_dißbÀd
 > 0)

953 
tsc_dißbÀd
 = 0;

955 
Õj
 = ((
u64
)
tsc_khz
 * 1000);

956 
	`do_div
(
Õj
, 
HZ
);

957 
Õj_föe
 = 
Õj
;

959 
	`u£_tsc_dñay
();

961 
	`dmi_check_sy°em
(
bad_tsc_dmi_èbÀ
);

963 i‡(
	`unsynchr⁄ized_tsc
())

964 
	`m¨k_tsc_un°abÀ
("TSCs unsynchronized");

966 
	`check_sy°em_tsc_ªlübÀ
();

967 
	`öô_tsc_˛ocksour˚
();

968 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<löux/•ölock.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__˝uöôd©a
 
©omic_t
 
	g°¨t_cou¡
;

29 
__˝uöôd©a
 
©omic_t
 
	g°›_cou¡
;

36 
__˝uöôd©a
 
¨ch_•ölock_t
 
	gsync_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

38 
__˝uöôd©a
 
cy˛es_t
 
	gœ°_tsc
;

39 
__˝uöôd©a
 
cy˛es_t
 
	gmax_w¨p
;

40 
__˝uöôd©a
 
	gƒ_w¨ps
;

45 
__˝uöô
 
	$check_tsc_w¨p
()

47 
cy˛es_t
 
°¨t
, 
now
, 
¥ev
, 
íd
;

48 
i
;

50 
	`rdtsc_b¨rõr
();

51 
°¨t
 = 
	`gë_cy˛es
();

52 
	`rdtsc_b¨rõr
();

56 
íd
 = 
°¨t
 + 
tsc_khz
 * 20ULL;

57 
now
 = 
°¨t
;

59 
i
 = 0; ; i++) {

65 
	`¨ch_•ö_lock
(&
sync_lock
);

66 
¥ev
 = 
œ°_tsc
;

67 
	`rdtsc_b¨rõr
();

68 
now
 = 
	`gë_cy˛es
();

69 
	`rdtsc_b¨rõr
();

70 
œ°_tsc
 = 
now
;

71 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

79 i‡(
	`u∆ikñy
(!(
i
 & 7))) {

80 i‡(
now
 > 
íd
 || 
i
 > 10000000)

82 
	`˝u_ªœx
();

83 
	`touch_nmi_w©chdog
();

89 i‡(
	`u∆ikñy
(
¥ev
 > 
now
)) {

90 
	`¨ch_•ö_lock
(&
sync_lock
);

91 
max_w¨p
 = 
	`max
(max_w¨p, 
¥ev
 - 
now
);

92 
ƒ_w¨ps
++;

93 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

96 
	`WARN
(!(
now
-
°¨t
),

98 
now
-
°¨t
, 
íd
-start);

99 
	}
}

105 
__˝uöô
 
	$check_tsc_sync_sour˚
(
˝u
)

107 
˝us
 = 2;

113 i‡(
	`unsynchr⁄ized_tsc
())

116 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
)) {

117 i‡(
˝u
 =(
ƒ_˝u_ids
-1Ë|| 
sy°em_°©e
 !
SYSTEM_BOOTING
)

118 
	`¥_öfo
(

126 
	`©omic_£t
(&
°›_cou¡
, 0);

131 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
-1)

132 
	`˝u_ªœx
();

136 
	`©omic_öc
(&
°¨t_cou¡
);

138 
	`check_tsc_w¨p
();

140 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
-1)

141 
	`˝u_ªœx
();

143 i‡(
ƒ_w¨ps
) {

144 
	`¥_w¨nög
("TSC synchronization [CPU#%d -> CPU#%d]:\n",

145 
	`smp_¥o˚ss‹_id
(), 
˝u
);

146 
	`¥_w¨nög
("Measured %Ld cycles TSC warp between CPUs, "

147 "tu∫ög of‡TSC clock.\n", 
max_w¨p
);

148 
	`m¨k_tsc_un°abÀ
("check_tsc_sync_source failed");

150 
	`¥_debug
("TSC synchronization [CPU#%d -> CPU#%d]:Öassed\n",

151 
	`smp_¥o˚ss‹_id
(), 
˝u
);

157 
	`©omic_£t
(&
°¨t_cou¡
, 0);

158 
ƒ_w¨ps
 = 0;

159 
max_w¨p
 = 0;

160 
œ°_tsc
 = 0;

165 
	`©omic_öc
(&
°›_cou¡
);

166 
	}
}

171 
__˝uöô
 
	$check_tsc_sync_èrgë
()

173 
˝us
 = 2;

175 i‡(
	`unsynchr⁄ized_tsc
(Ë|| 
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

182 
	`©omic_öc
(&
°¨t_cou¡
);

183 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
)

184 
	`˝u_ªœx
();

186 
	`check_tsc_w¨p
();

191 
	`©omic_öc
(&
°›_cou¡
);

196 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
)

197 
	`˝u_ªœx
();

198 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<löux/öô.h
>

16 
	~<löux/pci_ids.h
>

17 
	~<löux/pci_ªgs.h
>

19 
	~<asm/≠ic.h
>

20 
	~<asm/pci-dúe˘.h
>

21 
	~<asm/io.h
>

22 
	~<asm/∑øvút.h
>

23 
	~<asm/£tup.h
>

25 #i‡
deföed
 
CONFIG_PCI
 && deföed 
CONFIG_PARAVIRT


32 
	$vsmp_ßve_Ê
()

34 
Êags
 = 
	`«tive_ßve_Ê
();

36 i‡(!(
Êags
 & 
X86_EFLAGS_IF
Ë|| (Êag†& 
X86_EFLAGS_AC
))

37 
Êags
 &~
X86_EFLAGS_IF
;

38  
Êags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ßve_Ê
);

42 
	$vsmp_ª°‹e_Ê
(
Êags
)

44 i‡(
Êags
 & 
X86_EFLAGS_IF
)

45 
Êags
 &~
X86_EFLAGS_AC
;

47 
Êags
 |
X86_EFLAGS_AC
;

48 
	`«tive_ª°‹e_Ê
(
Êags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ª°‹e_Ê
);

52 
	$vsmp_úq_dißbÀ
()

54 
Êags
 = 
	`«tive_ßve_Ê
();

56 
	`«tive_ª°‹e_Ê
((
Êags
 & ~
X86_EFLAGS_IF
Ë| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_dißbÀ
);

60 
	$vsmp_úq_íabÀ
()

62 
Êags
 = 
	`«tive_ßve_Ê
();

64 
	`«tive_ª°‹e_Ê
((
Êags
 | 
X86_EFLAGS_IF
Ë& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_íabÀ
);

68 
__öô_‹_moduÀ
 
	$vsmp_∑tch
(
u8
 
ty≥
, 
u16
 
˛obbîs
, *
ibuf
,

69 
addr
, 
Àn
)

71 
ty≥
) {

72 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_íabÀ
):

73 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_dißbÀ
):

74 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ßve_Ê
):

75 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ª°‹e_Ê
):

76  
	`∑øvút_∑tch_deÁu…
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

78  
	`«tive_∑tch
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

81 
	}
}

83 
__öô
 
	$£t_vsmp_pv_›s
()

85 
__iomem
 *
addªss
;

86 
ˇp
, 
˘l
, 
cfg
;

89 
cfg
 = 
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
addªss
 = 
	`óæy_i‹em≠
(
cfg
, 8);

91 
ˇp
 = 
	`ªadl
(
addªss
);

92 
˘l
 = 
	`ªadl
(
addªss
 + 4);

93 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ˇp
, 
˘l
);

95 i‡(
ˇp
 & 
˘l
 & (1 << 4)) {

97 
pv_úq_›s
.
úq_dißbÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_dißbÀ
);

98 
pv_úq_›s
.
úq_íabÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_íabÀ
);

99 
pv_úq_›s
.
ßve_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ßve_Ê
);

100 
pv_úq_›s
.
ª°‹e_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ª°‹e_Ê
);

101 
pv_öô_›s
.
∑tch
 = 
vsmp_∑tch
;

103 
˘l
 &= ~(1 << 4);

104 
	`wrôñ
(
˘l
, 
addªss
 + 4);

105 
˘l
 = 
	`ªadl
(
addªss
 + 4);

106 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: c⁄åﬁ sëÅo:0x%08x\n", 
˘l
);

109 
	`óæy_iounm≠
(
addªss
, 8);

110 
	}
}

112 
__öô
 
	$£t_vsmp_pv_›s
()

114 
	}
}

117 #ifde‡
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__öô
 
	$dëe˘_vsmp_box
()

122 
is_vsmp
 = 0;

124 i‡(!
	`óæy_pci_Ælowed
())

128 i‡(
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 i‡(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__öô
 
	$dëe˘_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__öô
 
	$vsmp_öô
()

154 
	`dëe˘_vsmp_box
();

155 i‡(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_›s
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<löux/time.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/jiffõs.h
>

29 
	~<löux/sys˘l.h
>

30 
	~<löux/˛ocksour˚.h
>

31 
	~<löux/gë˝u.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/smp.h
>

34 
	~<löux/nŸifõr.h
>

36 
	~<asm/vsysˇŒ.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/uni°d.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/î∫o.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gmít.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/t›ﬁogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysˇŒ
(
ƒ
) \

49 
	`__©åibuã__
 ((
unu£d
, 
	`__£˘i⁄__
(".vsysˇŒ_" #ƒ))Ë
nŸø˚


	)

50 
	#__sysˇŒ_˛obbî
 "r11","cx","mem‹y"

	)

58 
__vgë˝u_mode
 
	g__£˘i⁄_vgë˝u_mode
;

60 
vsysˇŒ_gtod_d©a
 
__vsysˇŒ_gtod_d©a
 
	g__£˘i⁄_vsysˇŒ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsys˘l_íabÀd
 = 1,

66 
	$upd©e_vsysˇŒ_tz
()

68 
Êags
;

70 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

72 
vsysˇŒ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

74 
	}
}

76 
	$upd©e_vsysˇŒ
(
time•ec
 *
wÆl_time
, 
˛ocksour˚
 *
˛ock
,

77 
u32
 
mu…
)

79 
Êags
;

81 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

83 
vsysˇŒ_gtod_d©a
.
˛ock
.
vªad
 = clock->vread;

84 
vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 = clock->cycle_last;

85 
vsysˇŒ_gtod_d©a
.
˛ock
.
mask
 = clock->mask;

86 
vsysˇŒ_gtod_d©a
.
˛ock
.
mu…
 = mult;

87 
vsysˇŒ_gtod_d©a
.
˛ock
.
shi·
 = clock->shift;

88 
vsysˇŒ_gtod_d©a
.
wÆl_time_£c
 = 
wÆl_time
->
tv_£c
;

89 
vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
 = 
wÆl_time
->
tv_n£c
;

90 
vsysˇŒ_gtod_d©a
.
wÆl_to_m⁄Ÿ⁄ic
 = wall_to_monotonic;

91 
vsysˇŒ_gtod_d©a
.
wÆl_time_cﬂr£
 = 
	`__cuºít_kî√l_time
();

92 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

93 
	}
}

98 
__Æways_ölöe
 
	$do_gë_tz
(
timez⁄e
 * 
tz
)

100 *
tz
 = 
__vsysˇŒ_gtod_d©a
.
sys_tz
;

101 
	}
}

103 
__Æways_ölöe
 
	$gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

105 
ªt
;

106 
asm
 volatile("syscall"

107 : "˜" (
ªt
)

108 : "0" (
__NR_gëtimeofday
),"D" (
tv
),"S" (
tz
)

109 : 
__sysˇŒ_˛obbî
 );

110  
ªt
;

111 
	}
}

113 
__Æways_ölöe
 
	$time_sysˇŒ
(*
t
)

115 
£cs
;

116 
asm
 volatile("syscall"

117 : "˜" (
£cs
)

118 : "0" (
__NR_time
),"D" (
t
Ë: 
__sysˇŒ_˛obbî
);

119  
£cs
;

120 
	}
}

122 
__Æways_ölöe
 
	$do_vgëtimeofday
(
timevÆ
 * 
tv
)

124 
cy˛e_t
 
now
, 
ba£
, 
mask
, 
cy˛e_dñè
;

125 
£q
;

126 
mu…
, 
shi·
, 
n£c
;

127 
	`cy˛e_t
 (*
vªad
)();

129 
£q
 = 
	`ªad_£qbegö
(&
__vsysˇŒ_gtod_d©a
.
lock
);

131 
vªad
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.vread;

132 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
 || !
vªad
)) {

133 
	`gëtimeofday
(
tv
,
NULL
);

137 
now
 = 
	`vªad
();

138 
ba£
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

139 
mask
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mask;

140 
mu…
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mult;

141 
shi·
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.shift;

143 
tv
->
tv_£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_£c
;

144 
n£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
;

145 } 
	`ªad_£qªåy
(&
__vsysˇŒ_gtod_d©a
.
lock
, 
£q
));

148 
cy˛e_dñè
 = (
now
 - 
ba£
Ë& 
mask
;

150 
n£c
 +(
cy˛e_dñè
 * 
mu…
Ë>> 
shi·
;

152 
n£c
 >
NSEC_PER_SEC
) {

153 
tv
->
tv_£c
 += 1;

154 
n£c
 -
NSEC_PER_SEC
;

156 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

157 
	}
}

159 
	$__vsysˇŒ
(0Ë
	$vgëtimeofday
(
timevÆ
 * 
tv
, 
timez⁄e
 * 
tz
)

161 i‡(
tv
)

162 
	`do_vgëtimeofday
(
tv
);

163 i‡(
tz
)

164 
	`do_gë_tz
(
tz
);

166 
	}
}

170 
time_t
 
	$__vsysˇŒ
(1Ë
	$vtime
(
time_t
 *
t
)

172 
timevÆ
 
tv
;

173 
time_t
 
ªsu…
;

174 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
))

175  
	`time_sysˇŒ
(
t
);

177 
	`vgëtimeofday
(&
tv
, 
NULL
);

178 
ªsu…
 = 
tv
.
tv_£c
;

179 i‡(
t
)

180 *
t
 = 
ªsu…
;

181  
ªsu…
;

182 
	}
}

192 
	$__vsysˇŒ
(2)

193 
	$vgë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

195 
p
;

196 
j
 = 0;

206 i‡(
tˇche
 &&Åˇche->
blob
[0] =(
j
 = 
__jiffõs
)) {

207 
p
 = 
tˇche
->
blob
[1];

208 } i‡(
__vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

210 
	`«tive_ªad_ts˝
(&
p
);

213 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

215 i‡(
tˇche
) {

216 
tˇche
->
blob
[0] = 
j
;

217 
tˇche
->
blob
[1] = 
p
;

219 i‡(
˝u
)

220 *
˝u
 = 
p
 & 0xfff;

221 i‡(
node
)

222 *
node
 = 
p
 >> 12;

224 
	}
}

226 
	$__vsysˇŒ
(3Ë
	$víosys_1
()

228  -
ENOSYS
;

229 
	}
}

231 #ifde‡
CONFIG_SYSCTL


232 
˘l_èbÀ
 
	gkî√l_èbÀ2
[] = {

233 { .
¥o˙ame
 = "vsyscall64",

234 .
	gd©a
 = &
vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
, .
	gmaxÀn
 = (),

235 .
	gmode
 = 0644,

236 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
 },

240 
˘l_èbÀ
 
	gkî√l_roŸ_èbÀ2
[] = {

241 { .
¥o˙ame
 = "kî√l", .
	gmode
 = 0555,

242 .
	gchûd
 = 
kî√l_èbÀ2
 },

249 
__˝uöô
 
	$vsysˇŒ_£t_˝u
(
˝u
)

251 
d
;

252 
node
 = 0;

253 #ifde‡
CONFIG_NUMA


254 
node
 = 
	`˝u_to_node
(
˝u
);

256 i‡(
	`˝u_has
(&
	`˝u_d©a
(
˝u
), 
X86_FEATURE_RDTSCP
))

257 
	`wrôe_rdts˝_aux
((
node
 << 12Ë| 
˝u
);

262 
d
 = 0x0f40000000000ULL;

263 
d
 |
˝u
;

264 
d
 |(
node
 & 0xf) << 12;

265 
d
 |(
node
 >> 4) << 48;

266 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

267 
	}
}

269 
__˝uöô
 
	$˝u_vsysˇŒ_öô
(*
¨g
)

272 
	`vsysˇŒ_£t_˝u
(
	`øw_smp_¥o˚ss‹_id
());

273 
	}
}

275 
__˝uöô


276 
	$˝u_vsysˇŒ_nŸifõr
(
nŸifõr_block
 *
n
, 
a˘i⁄
, *
¨g
)

278 
˝u
 = ()
¨g
;

279 i‡(
a˘i⁄
 =
CPU_ONLINE
 ||á˘i⁄ =
CPU_ONLINE_FROZEN
)

280 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝u_vsysˇŒ_öô
, 
NULL
, 1);

281  
NOTIFY_DONE
;

282 
	}
}

284 
__öô
 
	$m≠_vsysˇŒ
()

286 
__vsysˇŒ_0
;

287 
phyßddr_∑ge0
 = 
	`__∑_symbﬁ
(&
__vsysˇŒ_0
);

290 
	`__£t_fixm≠
(
VSYSCALL_FIRST_PAGE
, 
phyßddr_∑ge0
, 
PAGE_KERNEL_VSYSCALL
);

291 
	}
}

293 
__öô
 
	$vsysˇŒ_öô
()

295 
	`BUG_ON
(((Ë&
vgëtimeofday
 !=

296 
	`VSYSCALL_ADDR
(
__NR_vgëtimeofday
)));

297 
	`BUG_ON
((Ë&
vtime
 !
	`VSYSCALL_ADDR
(
__NR_vtime
));

298 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0Ë!
	`__fix_to_vút
(
VSYSCALL_FIRST_PAGE
)));

299 
	`BUG_ON
((Ë&
vgë˝u
 !
	`VSYSCALL_ADDR
(
__NR_vgë˝u
));

300 #ifde‡
CONFIG_SYSCTL


301 
	`ªgi°î_sys˘l_èbÀ
(
kî√l_roŸ_èbÀ2
);

303 
	`⁄_óch_˝u
(
˝u_vsysˇŒ_öô
, 
NULL
, 1);

304 
	`hŸ˝u_nŸifõr
(
˝u_vsysˇŒ_nŸifõr
, 0);

306 
	}
}

308 
__öôˇŒ
(
vsysˇŒ_öô
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/smp.h
>

7 
	~<√t/checksum.h
>

9 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/uac˚ss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/·ø˚.h
>

15 #ifde‡
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcou¡
);

20 
EXPORT_SYMBOL
(
__gë_u£r_1
);

21 
EXPORT_SYMBOL
(
__gë_u£r_2
);

22 
EXPORT_SYMBOL
(
__gë_u£r_4
);

23 
EXPORT_SYMBOL
(
__gë_u£r_8
);

24 
EXPORT_SYMBOL
(
__put_u£r_1
);

25 
EXPORT_SYMBOL
(
__put_u£r_2
);

26 
EXPORT_SYMBOL
(
__put_u£r_4
);

27 
EXPORT_SYMBOL
(
__put_u£r_8
);

29 
EXPORT_SYMBOL
(
c›y_u£r_gíîic
);

30 
EXPORT_SYMBOL
(
__c›y_u£r_noˇche
);

31 
EXPORT_SYMBOL
(
_c›y_‰om_u£r
);

32 
EXPORT_SYMBOL
(
_c›y_to_u£r
);

34 
EXPORT_SYMBOL
(
c›y_∑ge
);

35 
EXPORT_SYMBOL
(
˛ór_∑ge
);

37 
EXPORT_SYMBOL
(
csum_∑πül
);

43 #unde‡
mem˝y


44 #unde‡
mem£t


45 #unde‡
memmove


47 *
mem£t
(*, , 
__kî√l_size_t
);

48 *
mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

49 *
__mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

51 
EXPORT_SYMBOL
(
mem£t
);

52 
EXPORT_SYMBOL
(
mem˝y
);

53 
EXPORT_SYMBOL
(
__mem˝y
);

55 
EXPORT_SYMBOL
(
em±y_zîo_∑ge
);

56 
EXPORT_SYMBOL
(
öô_Àvñ4_pgt
);

57 #i‚de‡
CONFIG_PARAVIRT


58 
EXPORT_SYMBOL
(
«tive_lﬂd_gs_ödex
);

	@/cmpt816/linux/arch/x86/kernel/x86_init.c

6 
	~<löux/öô.h
>

8 
	~<asm/bios_ebda.h
>

9 
	~<asm/∑øvút.h
>

10 
	~<asm/mp•ec.h
>

11 
	~<asm/£tup.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/e820.h
>

14 
	~<asm/time.h
>

15 
	~<asm/úq.h
>

16 
	~<asm/∑t.h
>

17 
	~<asm/tsc.h
>

18 
	~<asm/iommu.h
>

20 
__˝uöô
 
	$x86_öô_no›
(Ë{ 
	}
}

21 
__öô
 
	$x86_öô_uöt_no›
(
unu£d
Ë{ 
	}
}

22 
__öô
 
	$x86_öô_pgd_no›
(
pgd_t
 *
unu£d
Ë{ 
	}
}

23 
__öô
 
	$iommu_öô_no›
(Ë{  0; 
	}
}

24 
	$iommu_shutdown_no›
(Ë{ 
	}
}

30 
x86_öô_›s
 
x86_öô
 
	g__öôd©a
 = {

32 .
ªsour˚s
 = {

33 .
¥obe_roms
 = 
x86_öô_no›
,

34 .
	gª£rve_ªsour˚s
 = 
ª£rve_°™d¨d_io_ªsour˚s
,

35 .
	gmem‹y_£tup
 = 
deÁu…_machöe_•ecific_mem‹y_£tup
,

38 .
	gmµ¨£
 = {

39 .
mpc_ªc‹d
 = 
x86_öô_uöt_no›
,

40 .
	g£tup_iﬂpic_ids
 = 
x86_öô_no›
,

41 .
	gmpc_≠ic_id
 = 
deÁu…_mpc_≠ic_id
,

42 .
	gsmp_ªad_mpc_€m
 = 
deÁu…_smp_ªad_mpc_€m
,

43 .
	gmpc_€m_bus_öfo
 = 
deÁu…_mpc_€m_bus_öfo
,

44 .
	gföd_smp_c⁄fig
 = 
deÁu…_föd_smp_c⁄fig
,

45 .
	ggë_smp_c⁄fig
 = 
deÁu…_gë_smp_c⁄fig
,

48 .
	gúqs
 = {

49 .
¥e_ve˘‹_öô
 = 
öô_ISA_úqs
,

50 .
	göå_öô
 = 
«tive_öô_IRQ
,

51 .
	gå≠_öô
 = 
x86_öô_no›
,

54 .
	g€m
 = {

55 .
¨ch_£tup
 = 
x86_öô_no›
,

56 .
	gb™√r
 = 
deÁu…_b™√r
,

59 .
	g∑gög
 = {

60 .
∑gëabÀ_£tup_°¨t
 = 
«tive_∑gëabÀ_£tup_°¨t
,

61 .
	g∑gëabÀ_£tup_d⁄e
 = 
«tive_∑gëabÀ_£tup_d⁄e
,

64 .
	gtimîs
 = {

65 .
£tup_≥r˝u_˛ockev
 = 
£tup_boŸ_APIC_˛ock
,

66 .
	gtsc_¥e_öô
 = 
x86_öô_no›
,

67 .
	gtimî_öô
 = 
h≥t_time_öô
,

70 .
	giommu
 = {

71 .
iommu_öô
 = 
iommu_öô_no›
,

75 
x86_˝uöô_›s
 
x86_˝uöô
 
	g__˝uöôd©a
 = {

76 .
£tup_≥r˝u_˛ockev
 = 
£tup_£c⁄d¨y_APIC_˛ock
,

79 
x86_∂©f‹m_›s
 
	gx86_∂©f‹m
 = {

80 .
ˇlibøã_tsc
 = 
«tive_ˇlibøã_tsc
,

81 .
	ggë_wÆl˛ock
 = 
mach_gë_cmos_time
,

82 .
	g£t_wÆl˛ock
 = 
mach_£t_πc_mmss
,

83 .
	giommu_shutdown
 = 
iommu_shutdown_no›
,

84 .
	gis_u¡øcked_∑t_ønge
 = 
is_ISA_ønge
,

	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<löux/boŸmem.h
>

7 
	~<löux/com∑t.h
>

8 
	~<asm/i387.h
>

9 #ifde‡
CONFIG_IA32_EMULATION


10 
	~<asm/sigc⁄ãxt32.h
>

12 
	~<asm/x¸.h
>

17 
u64
 
	gp˙txt_mask
;

19 
_Âx_sw_byãs
 
	gfx_sw_ª£rved
;

20 #ifde‡
CONFIG_IA32_EMULATION


21 
_Âx_sw_byãs
 
	gfx_sw_ª£rved_ü32
;

28 
	$check_f‹_x°©e
(
i387_fxßve_°ru˘
 
__u£r
 *
buf
,

29 
__u£r
 *
Â°©e
,

30 
_Âx_sw_byãs
 *
fx_sw_u£r
)

32 
mö_x°©e_size
 = (
i387_fxßve_°ru˘
) +

33 (
xßve_hdr_°ru˘
);

34 
magic2
;

35 
îr
;

37 
îr
 = 
	`__c›y_‰om_u£r
(
fx_sw_u£r
, &
buf
->
sw_ª£rved
[0],

38 (
_Âx_sw_byãs
));

40 i‡(
îr
)

41  
îr
;

46 i‡(
fx_sw_u£r
->
magic1
 !
FP_XSTATE_MAGIC1
)

52 i‡(
fx_sw_u£r
->
x°©e_size
 < 
mö_x°©e_size
 ||

53 
fx_sw_u£r
->
x°©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x°©e_size
 > fx_sw_u£r->
exãnded_size
)

57 
îr
 = 
	`__gë_u£r
(
magic2
, (
__u32
 *Ë(((*)
Â°©e
) +

58 
fx_sw_u£r
->
exãnded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 i‡(
îr
 || 
magic2
 !
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifde‡
CONFIG_X86_64


77 
	$ßve_i387_x°©e
(
__u£r
 *
buf
)

79 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

80 
îr
 = 0;

82 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x°©e_size
 < 
x°©e_size
);

87 i‡(()
buf
 % 64)

88 
	`¥ötk
("ßve_i387_x°©e: bad fp°©ê%p\n", 
buf
);

90 i‡(!
	`u£d_m©h
())

93 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_USEDFPU
) {

98 
îr
 = 
	`__˛ór_u£r
(
buf
, 
sig_x°©e_size
);

99 i‡(
îr
)

100  
îr
;

102 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

103 
îr
 = 
	`xßve_u£r
(
buf
);

105 
îr
 = 
	`fxßve_u£r
(
buf
);

107 i‡(
îr
)

108  
îr
;

109 
	`èsk_thªad_öfo
(
tsk
)->
°©us
 &~
TS_USEDFPU
;

110 
	`°ts
();

112 i‡(
	`__c›y_to_u£r
(
buf
, &
tsk
->
thªad
.
x°©e
->
fxßve
,

113 
x°©e_size
))

117 
	`˛ór_u£d_m©h
();

119 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
) {

120 
_Â°©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x°©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x°©e_bv
;

124 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved
,

125 (
_Âx_sw_byãs
));

127 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
îr
 |
	`__gë_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

149 
x°©e_bv
 |
XSTATE_FPSSE
;

151 
îr
 |
	`__put_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

153 i‡(
îr
)

154  
îr
;

158 
	}
}

164 
	$ª°‹e_u£r_x°©e
(
__u£r
 *
buf
)

166 
_Âx_sw_byãs
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
îr
;

170 i‡((()
buf
 % 64) ||

171 
	`check_f‹_x°©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_⁄ly
;

174 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

179 
îr
 = 
	`xª°‹e_u£r
(
buf
, 
mask
);

180 i‡(
îr
)

181  
îr
;

186 
mask
 = 
p˙txt_mask
 & ~mask;

188 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
mask
);

192 
fx_⁄ly
:

198 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
p˙txt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)
buf
);

200 
	}
}

205 
	$ª°‹e_i387_x°©e
(
__u£r
 *
buf
)

207 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

208 
îr
 = 0;

210 i‡(!
buf
) {

211 i‡(
	`u£d_m©h
())

212 
˛ór
;

215 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_size
))

216  -
EACCES
;

218 i‡(!
	`u£d_m©h
()) {

219 
îr
 = 
	`öô_Âu
(
tsk
);

220 i‡(
îr
)

221  
îr
;

224 i‡(!(
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 & 
TS_USEDFPU
)) {

225 
	`˛ts
();

226 
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 |
TS_USEDFPU
;

228 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

229 
îr
 = 
	`ª°‹e_u£r_x°©e
(
buf
);

231 
îr
 = 
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)

232 
buf
);

233 i‡(
	`u∆ikñy
(
îr
)) {

238 
˛ór
:

239 
	`˛ór_Âu
(
tsk
);

240 
	`˛ór_u£d_m©h
();

242  
îr
;

243 
	}
}

253 
	$¥ï¨e_fx_sw_‰ame
()

255 
size_exãnded
 = (
x°©e_size
 - (
i387_fxßve_°ru˘
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x°©e_size
 = (
_Â°©e
Ë+ 
size_exãnded
;

260 #ifde‡
CONFIG_IA32_EMULATION


261 
sig_x°©e_ü32_size
 = (
_Â°©e_ü32
Ë+ 
size_exãnded
;

264 
	`mem£t
(&
fx_sw_ª£rved
, 0, (fx_sw_reserved));

266 
fx_sw_ª£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_ª£rved
.
exãnded_size
 = 
sig_x°©e_size
;

268 
fx_sw_ª£rved
.
x°©e_bv
 = 
p˙txt_mask
;

269 
fx_sw_ª£rved
.
x°©e_size
 = xstate_size;

270 #ifde‡
CONFIG_IA32_EMULATION


271 
	`mem˝y
(&
fx_sw_ª£rved_ü32
, &
fx_sw_ª£rved
,

272 (
_Âx_sw_byãs
));

273 
fx_sw_ª£rved_ü32
.
exãnded_size
 = 
sig_x°©e_ü32_size
;

275 
	}
}

280 
xßve_°ru˘
 *
	göô_x°©e_buf
;

282 #ifde‡
CONFIG_X86_64


283 
	gsig_x°©e_size
 = (
_Â°©e
);

289 
__˝uöô
 
	$xßve_öô
()

291 i‡(!
˝u_has_xßve
)

294 
	`£t_ö_¸4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
p˙txt_mask
);

301 
	}
}

306 
__öô
 
	$£tup_x°©e_öô
()

308 
öô_x°©e_buf
 = 
	`Æloc_boŸmem
(
x°©e_size
);

309 
öô_x°©e_buf
->
i387
.
mxc§
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__ªf
 
	$xßve_˙txt_öô
()

317 
óx
, 
ebx
, 
ecx
, 
edx
;

319 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

320 
p˙txt_mask
 = 
óx
 + ((
u64
)
edx
 << 32);

322 i‡((
p˙txt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`¥ötk
(
KERN_ERR
 "FP/SSEÇot shown under xsave features 0x%llx\n",

324 
p˙txt_mask
);

325 
	`BUG
();

331 
p˙txt_mask
 =Ö˙txt_mask & 
XCNTXT_MASK
;

332 
	`xßve_öô
();

337 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

338 
x°©e_size
 = 
ebx
;

340 
	`¥ï¨e_fx_sw_‰ame
();

342 
	`£tup_x°©e_öô
();

344 
	`¥ötk
(
KERN_INFO
 "xsave/xrstor:Énabled xstate_bv 0x%llx, "

346 
p˙txt_mask
, 
x°©e_size
);

347 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/•ölock.h
>

3 
	~<asm/uac˚ss.h
>

6 
	$fixup_ex˚±i⁄
(
±_ªgs
 *
ªgs
)

8 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

10 #ifde‡
CONFIG_PNPBIOS


11 i‡(
	`u∆ikñy
(
	`SEGMENT_IS_PNP_CODE
(
ªgs
->
cs
))) {

12 
u32
 
≤p_bios_Áu…_eù
, 
≤p_bios_Áu…_e•
;

13 
u32
 
≤p_bios_is_uâî_¸≠
;

14 
≤p_bios_is_uâî_¸≠
 = 1;

15 
	`¥ötk
(
KERN_CRIT
 "PNPBIOS fault..áttemptingÑecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
≤p_bios_Áu…_e•
), "g" (
≤p_bios_Áu…_eù
));

20 
	`∑nic
("do_trap: can't hitÅhis");

24 
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
);

25 i‡(
fixup
) {

27 i‡(
fixup
->fixup < 16) {

28 
	`cuºít_thªad_öfo
()->
uac˚ss_îr
 = -
EFAULT
;

29 
ªgs
->
ù
 +
fixup
->fixup;

32 
ªgs
->
ù
 = 
fixup
->fixup;

37 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<löux/magic.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/kdebug.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/boŸmem.h
>

11 
	~<löux/k¥obes.h
>

12 
	~<löux/mmiŸø˚.h
>

13 
	~<löux/≥rf_evít.h
>

15 
	~<asm/å≠s.h
>

16 
	~<asm/pgÆloc.h
>

17 
	~<asm/kmemcheck.h
>

28 
	ex86_pf_îr‹_code
 {

30 
	mPF_PROT
 = 1 << 0,

31 
	mPF_WRITE
 = 1 << 1,

32 
	mPF_USER
 = 1 << 2,

33 
	mPF_RSVD
 = 1 << 3,

34 
	mPF_INSTR
 = 1 << 4,

41 
ölöe
 
__k¥obes


42 
	$kmmio_Áu…
(
±_ªgs
 *
ªgs
, 
addr
)

44 i‡(
	`u∆ikñy
(
	`is_kmmio_a˘ive
()))

45 i‡(
	`kmmio_h™dÀr
(
ªgs
, 
addr
) == 1)

48 
	}
}

50 
ölöe
 
__k¥obes
 
	$nŸify_∑ge_Áu…
(
±_ªgs
 *
ªgs
)

52 
ªt
 = 0;

55 i‡(
	`k¥obes_buût_ö
(Ë&& !
	`u£r_mode_vm
(
ªgs
)) {

56 
	`¥ìm±_dißbÀ
();

57 i‡(
	`k¥obe_ru¬ög
(Ë&& 
	`k¥obe_Áu…_h™dÀr
(
ªgs
, 14))

58 
ªt
 = 1;

59 
	`¥ìm±_íabÀ
();

62  
ªt
;

63 
	}
}

80 
ölöe
 

81 
	$check_¥e„tch_›code
(
±_ªgs
 *
ªgs
, *
ö°r
,

82 
›code
, *
¥e„tch
)

84 
ö°r_hi
 = 
›code
 & 0xf0;

85 
ö°r_lo
 = 
›code
 & 0x0f;

87 
ö°r_hi
) {

96  ((
ö°r_lo
 & 7) == 0x6);

97 #ifde‡
CONFIG_X86_64


106  (!
	`u£r_mode
(
ªgs
)Ë|| (ªgs->
cs
 =
__USER_CS
);

110  (
ö°r_lo
 & 0xC) == 0x4;

113  !
ö°r_lo
 || (instr_lo>>1) == 1;

116 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

119 *
¥e„tch
 = (
ö°r_lo
 == 0xF) &&

120 (
›code
 == 0x0D || opcode == 0x18);

125 
	}
}

128 
	$is_¥e„tch
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addr
)

130 *
max_ö°r
;

131 *
ö°r
;

132 
¥e„tch
 = 0;

138 i‡(
îr‹_code
 & 
PF_INSTR
)

141 
ö°r
 = (*)
	`c⁄vît_ù_to_löór
(
cuºít
, 
ªgs
);

142 
max_ö°r
 = 
ö°r
 + 15;

144 i‡(
	`u£r_mode
(
ªgs
Ë&& 
ö°r
 >(*)
TASK_SIZE
)

147 
ö°r
 < 
max_ö°r
) {

148 
›code
;

150 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

153 
ö°r
++;

155 i‡(!
	`check_¥e„tch_›code
(
ªgs
, 
ö°r
, 
›code
, &
¥e„tch
))

158  
¥e„tch
;

159 
	}
}

162 
	$f‹˚_sig_öfo_Áu…
(
si_signo
, 
si_code
, 
addªss
,

163 
èsk_°ru˘
 *
tsk
)

165 
sigöfo_t
 
öfo
;

167 
öfo
.
si_signo
 = si_signo;

168 
öfo
.
si_î∫o
 = 0;

169 
öfo
.
si_code
 = si_code;

170 
öfo
.
si_addr
 = (
__u£r
 *)
addªss
;

171 
öfo
.
si_addr_lsb
 = 
si_code
 =
BUS_MCEERR_AR
 ? 
PAGE_SHIFT
 : 0;

173 
	`f‹˚_sig_öfo
(
si_signo
, &
öfo
, 
tsk
);

174 
	}
}

176 
DEFINE_SPINLOCK
(
pgd_lock
);

177 
LIST_HEAD
(
pgd_li°
);

179 #ifde‡
CONFIG_X86_32


180 
ölöe
 
pmd_t
 *
	$vmÆloc_sync_⁄e
(
pgd_t
 *
pgd
, 
addªss
)

182 
ödex
 = 
	`pgd_ödex
(
addªss
);

183 
pgd_t
 *
pgd_k
;

184 
pud_t
 *
pud
, *
pud_k
;

185 
pmd_t
 *
pmd
, *
pmd_k
;

187 
pgd
 +
ödex
;

188 
pgd_k
 = 
öô_mm
.
pgd
 + 
ödex
;

190 i‡(!
	`pgd_¥e£¡
(*
pgd_k
))

191  
NULL
;

198 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

199 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
addªss
);

200 i‡(!
	`pud_¥e£¡
(*
pud_k
))

201  
NULL
;

203 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

204 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
addªss
);

205 i‡(!
	`pmd_¥e£¡
(*
pmd_k
))

206  
NULL
;

208 i‡(!
	`pmd_¥e£¡
(*
pmd
))

209 
	`£t_pmd
(
pmd
, *
pmd_k
);

211 
	`BUG_ON
(
	`pmd_∑ge
(*
pmd
Ë!pmd_∑ge(*
pmd_k
));

213  
pmd_k
;

214 
	}
}

216 
	$vmÆloc_sync_Æl
()

218 
addªss
;

220 i‡(
SHARED_KERNEL_PMD
)

223 
addªss
 = 
VMALLOC_START
 & 
PMD_MASK
;

224 
addªss
 >
TASK_SIZE
 &&áddªs†< 
FIXADDR_TOP
;

225 
addªss
 +
PMD_SIZE
) {

227 
Êags
;

228 
∑ge
 *page;

230 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

231 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

232 i‡(!
	`vmÆloc_sync_⁄e
(
	`∑ge_addªss
(
∑ge
), 
addªss
))

235 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

237 
	}
}

244 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

246 
pgd_∑ddr
;

247 
pmd_t
 *
pmd_k
;

248 
±e_t
 *
±e_k
;

251 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

261 
pgd_∑ddr
 = 
	`ªad_¸3
();

262 
pmd_k
 = 
	`vmÆloc_sync_⁄e
(
	`__va
(
pgd_∑ddr
), 
addªss
);

263 i‡(!
pmd_k
)

266 
±e_k
 = 
	`±e_off£t_kî√l
(
pmd_k
, 
addªss
);

267 i‡(!
	`±e_¥e£¡
(*
±e_k
))

271 
	}
}

276 
ölöe
 

277 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

278 
èsk_°ru˘
 *
tsk
)

280 
bô
;

282 i‡(!
	`v8086_mode
(
ªgs
))

285 
bô
 = (
addªss
 - 0xA0000Ë>> 
PAGE_SHIFT
;

286 i‡(
bô
 < 32)

287 
tsk
->
thªad
.
s¸ìn_bôm≠
 |1 << 
bô
;

288 
	}
}

290 
boﬁ
 
	$low_p‚
(
p‚
)

292  
p‚
 < 
max_low_p‚
;

293 
	}
}

295 
	$dump_∑gëabÀ
(
addªss
)

297 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

298 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addªss
)];

299 
pmd_t
 *
pmd
;

300 
±e_t
 *
±e
;

302 #ifde‡
CONFIG_X86_PAE


303 
	`¥ötk
("*pd± = %016Lx ", 
	`pgd_vÆ
(*
pgd
));

304 i‡(!
	`low_p‚
(
	`pgd_vÆ
(*
pgd
Ë>> 
PAGE_SHIFT
Ë|| !
	`pgd_¥e£¡
(*pgd))

305 
out
;

307 
pmd
 = 
	`pmd_off£t
(
	`pud_off£t
(
pgd
, 
addªss
),áddress);

308 
	`¥ötk
(
KERN_CONT
 "*pdê%0*Lx ", (*
pmd
Ë* 2, (
u64
)
	`pmd_vÆ
(*pmd));

316 i‡(!
	`low_p‚
(
	`pmd_p‚
(*
pmd
)Ë|| !
	`pmd_¥e£¡
(*pmdË|| 
	`pmd_œrge
(*pmd))

317 
out
;

319 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

320 
	`¥ötk
("*±ê%0*Lx ", (*
±e
Ë* 2, (
u64
)
	`±e_vÆ
(*pte));

321 
out
:

322 
	`¥ötk
("\n");

323 
	}
}

327 
	$vmÆloc_sync_Æl
()

329 
addªss
;

331 
addªss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;áddªs†<
VMALLOC_END
;

332 
addªss
 +
PGDIR_SIZE
) {

334 c⁄° 
pgd_t
 *
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

335 
Êags
;

336 
∑ge
 *page;

338 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

341 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

342 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

343 
pgd_t
 *
pgd
;

344 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

345 i‡(
	`pgd_n⁄e
(*
pgd
))

346 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

348 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

350 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

352 
	}
}

361 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

363 
pgd_t
 *
pgd
, *
pgd_ªf
;

364 
pud_t
 *
pud
, *
pud_ªf
;

365 
pmd_t
 *
pmd
, *
pmd_ªf
;

366 
±e_t
 *
±e
, *
±e_ªf
;

369 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

377 
pgd
 = 
	`pgd_off£t
(
cuºít
->
a˘ive_mm
, 
addªss
);

378 
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

379 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

382 i‡(
	`pgd_n⁄e
(*
pgd
))

383 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

385 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

392 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

393 
pud_ªf
 = 
	`pud_off£t
(
pgd_ªf
, 
addªss
);

394 i‡(
	`pud_n⁄e
(*
pud_ªf
))

397 i‡(
	`pud_n⁄e
(*
pud
Ë|| 
	`pud_∑ge_vaddr
(*pudË!pud_∑ge_vaddr(*
pud_ªf
))

398 
	`BUG
();

400 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

401 
pmd_ªf
 = 
	`pmd_off£t
(
pud_ªf
, 
addªss
);

402 i‡(
	`pmd_n⁄e
(*
pmd_ªf
))

405 i‡(
	`pmd_n⁄e
(*
pmd
Ë|| 
	`pmd_∑ge
(*pmdË!pmd_∑ge(*
pmd_ªf
))

406 
	`BUG
();

408 
±e_ªf
 = 
	`±e_off£t_kî√l
(
pmd_ªf
, 
addªss
);

409 i‡(!
	`±e_¥e£¡
(*
±e_ªf
))

412 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

419 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| 
	`±e_p‚
(*±eË!±e_p‚(*
±e_ªf
))

420 
	`BUG
();

423 
	}
}

425 c⁄° 
	gîøè93_w¨nög
[] =

426 
KERN_ERR


435 
ölöe
 

436 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

437 
èsk_°ru˘
 *
tsk
)

439 
	}
}

441 
	$bad_addªss
(*
p
)

443 
dummy
;

445  
	`¥obe_kî√l_addªss
((*)
p
, 
dummy
);

446 
	}
}

448 
	$dump_∑gëabÀ
(
addªss
)

450 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
(Ë& 
PHYSICAL_PAGE_MASK
);

451 
pgd_t
 *
pgd
 = 
ba£
 + 
	`pgd_ödex
(
addªss
);

452 
pud_t
 *
pud
;

453 
pmd_t
 *
pmd
;

454 
±e_t
 *
±e
;

456 i‡(
	`bad_addªss
(
pgd
))

457 
bad
;

459 
	`¥ötk
("PGD %lx ", 
	`pgd_vÆ
(*
pgd
));

461 i‡(!
	`pgd_¥e£¡
(*
pgd
))

462 
out
;

464 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

465 i‡(
	`bad_addªss
(
pud
))

466 
bad
;

468 
	`¥ötk
("PUD %lx ", 
	`pud_vÆ
(*
pud
));

469 i‡(!
	`pud_¥e£¡
(*
pud
Ë|| 
	`pud_œrge
(*pud))

470 
out
;

472 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

473 i‡(
	`bad_addªss
(
pmd
))

474 
bad
;

476 
	`¥ötk
("PMD %lx ", 
	`pmd_vÆ
(*
pmd
));

477 i‡(!
	`pmd_¥e£¡
(*
pmd
Ë|| 
	`pmd_œrge
(*pmd))

478 
out
;

480 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

481 i‡(
	`bad_addªss
(
±e
))

482 
bad
;

484 
	`¥ötk
("PTE %lx", 
	`±e_vÆ
(*
±e
));

485 
out
:

486 
	`¥ötk
("\n");

488 
bad
:

489 
	`¥ötk
("BAD\n");

490 
	}
}

508 
	$is_îøè93
(
±_ªgs
 *
ªgs
, 
addªss
)

510 #ifde‡
CONFIG_X86_64


511 i‡(
addªss
 !
ªgs
->
ù
)

514 i‡((
addªss
 >> 32) != 0)

517 
addªss
 |= 0xffffffffUL << 32;

518 i‡((
addªss
 >(
u64
)
_°ext
 &&áddªs†<(u64)
_ëext
) ||

519 (
addªss
 >
MODULES_VADDR
 &&áddªs†<
MODULES_END
)) {

520 
	`¥ötk_⁄˚
(
îøè93_w¨nög
);

521 
ªgs
->
ù
 = 
addªss
;

526 
	}
}

536 
	$is_îøè100
(
±_ªgs
 *
ªgs
, 
addªss
)

538 #ifde‡
CONFIG_X86_64


539 i‡((
ªgs
->
cs
 =
__USER32_CS
 || (ªgs->c†& (1<<2))Ë&& (
addªss
 >> 32))

543 
	}
}

545 
	$is_f00f_bug
(
±_ªgs
 *
ªgs
, 
addªss
)

547 #ifde‡
CONFIG_X86_F00F_BUG


548 
ƒ
;

553 i‡(
boŸ_˝u_d©a
.
f00f_bug
) {

554 
ƒ
 = (
addªss
 - 
idt_des¸
.address) >> 3;

556 i‡(
ƒ
 == 6) {

557 
	`do_övÆid_›
(
ªgs
, 0);

563 
	}
}

565 c⁄° 
	gnx_w¨nög
[] = 
KERN_CRIT


569 
	$show_Áu…_o›s
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

570 
addªss
)

572 i‡(!
	`o›s_may_¥öt
())

575 i‡(
îr‹_code
 & 
PF_INSTR
) {

576 
Àvñ
;

578 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

580 i‡(
±e
 && 
	`±e_¥e£¡
(*±eË&& !
	`±e_exec
(*pte))

581 
	`¥ötk
(
nx_w¨nög
, 
	`cuºít_uid
());

584 
	`¥ötk
(
KERN_ALERT
 "BUG: unableÅo handle kernel ");

585 i‡(
addªss
 < 
PAGE_SIZE
)

586 
	`¥ötk
(
KERN_CONT
 "NULLÖointer dereference");

588 
	`¥ötk
(
KERN_CONT
 "pagingÑequest");

590 
	`¥ötk
(
KERN_CONT
 "áà%p\n", (*Ë
addªss
);

591 
	`¥ötk
(
KERN_ALERT
 "IP:");

592 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

594 
	`dump_∑gëabÀ
(
addªss
);

595 
	}
}

597 
noölöe
 

598 
	$pgèbÀ_bad
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

599 
addªss
)

601 
èsk_°ru˘
 *
tsk
;

602 
Êags
;

603 
sig
;

605 
Êags
 = 
	`o›s_begö
();

606 
tsk
 = 
cuºít
;

607 
sig
 = 
SIGKILL
;

609 
	`¥ötk
(
KERN_ALERT
 "%s: CorruptedÖageÅableátáddress %lx\n",

610 
tsk
->
comm
, 
addªss
);

611 
	`dump_∑gëabÀ
(
addªss
);

613 
tsk
->
thªad
.
¸2
 = 
addªss
;

614 
tsk
->
thªad
.
å≠_no
 = 14;

615 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

617 i‡(
	`__dõ
("BadÖagëabÀ", 
ªgs
, 
îr‹_code
))

618 
sig
 = 0;

620 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

621 
	}
}

623 
noölöe
 

624 
	$no_c⁄ãxt
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

625 
addªss
)

627 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

628 *
°ackíd
;

629 
Êags
;

630 
sig
;

633 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

647 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

650 i‡(
	`is_îøè93
(
ªgs
, 
addªss
))

657 
Êags
 = 
	`o›s_begö
();

659 
	`show_Áu…_o›s
(
ªgs
, 
îr‹_code
, 
addªss
);

661 
°ackíd
 = 
	`íd_of_°ack
(
tsk
);

662 i‡(
tsk
 !&
öô_èsk
 && *
°ackíd
 !
STACK_END_MAGIC
)

663 
	`¥ötk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

665 
tsk
->
thªad
.
¸2
 = 
addªss
;

666 
tsk
->
thªad
.
å≠_no
 = 14;

667 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

669 
sig
 = 
SIGKILL
;

670 i‡(
	`__dõ
("O›s", 
ªgs
, 
îr‹_code
))

671 
sig
 = 0;

674 
	`¥ötk
(
KERN_EMERG
 "CR2: %016lx\n", 
addªss
);

676 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

677 
	}
}

683 
ölöe
 

684 
	$show_sig«l_msg
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

685 
addªss
, 
èsk_°ru˘
 *
tsk
)

687 i‡(!
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
))

690 i‡(!
	`¥ötk_øãlimô
())

693 
	`¥ötk
("%s%s[%d]: segfaultát %lx ip %p sp %pÉrror %lx",

694 
	`èsk_pid_ƒ
(
tsk
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

695 
tsk
->
comm
, 
	`èsk_pid_ƒ
—sk), 
addªss
,

696 (*)
ªgs
->
ù
, (*Ïegs->
•
, 
îr‹_code
);

698 
	`¥öt_vma_addr
(
KERN_CONT
 " i¿", 
ªgs
->
ù
);

700 
	`¥ötk
(
KERN_CONT
 "\n");

701 
	}
}

704 
	$__bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

705 
addªss
, 
si_code
)

707 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

710 i‡(
îr‹_code
 & 
PF_USER
) {

714 
	`loˇl_úq_íabÀ
();

720 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

723 i‡(
	`is_îøè100
(
ªgs
, 
addªss
))

726 i‡(
	`u∆ikñy
(
show_unh™dÀd_sig«ls
))

727 
	`show_sig«l_msg
(
ªgs
, 
îr‹_code
, 
addªss
, 
tsk
);

730 
tsk
->
thªad
.
¸2
 = 
addªss
;

731 
tsk
->
thªad
.
îr‹_code
 =Éº‹_codê| (
addªss
 >
TASK_SIZE
);

732 
tsk
->
thªad
.
å≠_no
 = 14;

734 
	`f‹˚_sig_öfo_Áu…
(
SIGSEGV
, 
si_code
, 
addªss
, 
tsk
);

739 i‡(
	`is_f00f_bug
(
ªgs
, 
addªss
))

742 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

743 
	}
}

745 
noölöe
 

746 
	$bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

747 
addªss
)

749 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

750 
	}
}

753 
	$__bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

754 
addªss
, 
si_code
)

756 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

762 
	`up_ªad
(&
mm
->
mm≠_£m
);

764 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
si_code
);

765 
	}
}

767 
noölöe
 

768 
	$bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

770 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

771 
	}
}

773 
noölöe
 

774 
	$bad_¨ó_ac˚ss_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

775 
addªss
)

777 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_ACCERR
);

778 
	}
}

782 
	$out_of_mem‹y
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

783 
addªss
)

789 
	`up_ªad
(&
cuºít
->
mm
->
mm≠_£m
);

791 
	`∑geÁu…_out_of_mem‹y
();

792 
	}
}

795 
	$do_sigbus
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
,

796 
Áu…
)

798 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

799 
mm_°ru˘
 *
mm
 = 
tsk
->mm;

800 
code
 = 
BUS_ADRERR
;

802 
	`up_ªad
(&
mm
->
mm≠_£m
);

805 i‡(!(
îr‹_code
 & 
PF_USER
))

806 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

809 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

812 
tsk
->
thªad
.
¸2
 = 
addªss
;

813 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

814 
tsk
->
thªad
.
å≠_no
 = 14;

816 #ifde‡
CONFIG_MEMORY_FAILURE


817 i‡(
Áu…
 & 
VM_FAULT_HWPOISON
) {

818 
	`¥ötk
(
KERN_ERR


820 
tsk
->
comm
,Åsk->
pid
, 
addªss
);

821 
code
 = 
BUS_MCEERR_AR
;

824 
	`f‹˚_sig_öfo_Áu…
(
SIGBUS
, 
code
, 
addªss
, 
tsk
);

825 
	}
}

827 
noölöe
 

828 
	$mm_Áu…_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

829 
addªss
, 
Áu…
)

831 i‡(
Áu…
 & 
VM_FAULT_OOM
) {

832 
	`out_of_mem‹y
(
ªgs
, 
îr‹_code
, 
addªss
);

834 i‡(
Áu…
 & (
VM_FAULT_SIGBUS
|
VM_FAULT_HWPOISON
))

835 
	`do_sigbus
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

837 
	`BUG
();

839 
	}
}

841 
	$•urious_Áu…_check
(
îr‹_code
, 
±e_t
 *
±e
)

843 i‡((
îr‹_code
 & 
PF_WRITE
Ë&& !
	`±e_wrôe
(*
±e
))

846 i‡((
îr‹_code
 & 
PF_INSTR
Ë&& !
	`±e_exec
(*
±e
))

850 
	}
}

864 
noölöe
 
__k¥obes
 

865 
	$•urious_Áu…
(
îr‹_code
, 
addªss
)

867 
pgd_t
 *
pgd
;

868 
pud_t
 *
pud
;

869 
pmd_t
 *
pmd
;

870 
±e_t
 *
±e
;

871 
ªt
;

874 i‡(
îr‹_code
 & (
PF_USER
 | 
PF_RSVD
))

877 
pgd
 = 
öô_mm
.pgd + 
	`pgd_ödex
(
addªss
);

878 i‡(!
	`pgd_¥e£¡
(*
pgd
))

881 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

882 i‡(!
	`pud_¥e£¡
(*
pud
))

885 i‡(
	`pud_œrge
(*
pud
))

886  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pud
);

888 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

889 i‡(!
	`pmd_¥e£¡
(*
pmd
))

892 i‡(
	`pmd_œrge
(*
pmd
))

893  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

895 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

896 i‡(!
	`±e_¥e£¡
(*
±e
))

899 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, 
±e
);

900 i‡(!
ªt
)

907 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

908 
	`WARN_ONCE
(!
ªt
, "PMD has incorrectÖermission bits\n");

910  
ªt
;

911 
	}
}

913 
	gshow_unh™dÀd_sig«ls
 = 1;

915 
ölöe
 

916 
	$ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vm_¨ó_°ru˘
 *
vma
)

918 i‡(
wrôe
) {

920 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_WRITE
)))

926 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_PROT
))

930 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

934 
	}
}

936 
	$Áu…_ö_kî√l_•a˚
(
addªss
)

938  
addªss
 >
TASK_SIZE_MAX
;

939 
	}
}

946 
dŸø∂ökage
 
__k¥obes


947 
	$do_∑ge_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

949 
vm_¨ó_°ru˘
 *
vma
;

950 
èsk_°ru˘
 *
tsk
;

951 
addªss
;

952 
mm_°ru˘
 *
mm
;

953 
wrôe
;

954 
Áu…
;

956 
tsk
 = 
cuºít
;

957 
mm
 = 
tsk
->mm;

960 
addªss
 = 
	`ªad_¸2
();

966 i‡(
	`kmemcheck_a˘ive
(
ªgs
))

967 
	`kmemcheck_hide
(
ªgs
);

968 
	`¥e„tchw
(&
mm
->
mm≠_£m
);

970 i‡(
	`u∆ikñy
(
	`kmmio_Áu…
(
ªgs
, 
addªss
)))

986 i‡(
	`u∆ikñy
(
	`Áu…_ö_kî√l_•a˚
(
addªss
))) {

987 i‡(!(
îr‹_code
 & (
PF_RSVD
 | 
PF_USER
 | 
PF_PROT
))) {

988 i‡(
	`vmÆloc_Áu…
(
addªss
) >= 0)

991 i‡(
	`kmemcheck_Áu…
(
ªgs
, 
addªss
, 
îr‹_code
))

996 i‡(
	`•urious_Áu…
(
îr‹_code
, 
addªss
))

1000 i‡(
	`nŸify_∑ge_Áu…
(
ªgs
))

1006 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1012 i‡(
	`u∆ikñy
(
	`nŸify_∑ge_Áu…
(
ªgs
)))

1021 i‡(
	`u£r_mode_vm
(
ªgs
)) {

1022 
	`loˇl_úq_íabÀ
();

1023 
îr‹_code
 |
PF_USER
;

1025 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

1026 
	`loˇl_úq_íabÀ
();

1029 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_RSVD
))

1030 
	`pgèbÀ_bad
(
ªgs
, 
îr‹_code
, 
addªss
);

1032 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS
, 1, 0, 
ªgs
, 
addªss
);

1038 i‡(
	`u∆ikñy
(
	`ö_©omic
(Ë|| !
mm
)) {

1039 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1059 i‡(
	`u∆ikñy
(!
	`down_ªad_åylock
(&
mm
->
mm≠_£m
))) {

1060 i‡((
îr‹_code
 & 
PF_USER
) == 0 &&

1061 !
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
)) {

1062 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1065 
	`down_ªad
(&
mm
->
mm≠_£m
);

1072 
	`might_¶ìp
();

1075 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

1076 i‡(
	`u∆ikñy
(!
vma
)) {

1077 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1080 i‡(
	`likñy
(
vma
->
vm_°¨t
 <
addªss
))

1081 
good_¨ó
;

1082 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))) {

1083 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1086 i‡(
îr‹_code
 & 
PF_USER
) {

1093 i‡(
	`u∆ikñy
(
addªss
 + 65536 + 32 * (Ë< 
ªgs
->
•
)) {

1094 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1098 i‡(
	`u∆ikñy
(
	`ex∑nd_°ack
(
vma
, 
addªss
))) {

1099 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1107 
good_¨ó
:

1108 
wrôe
 = 
îr‹_code
 & 
PF_WRITE
;

1110 i‡(
	`u∆ikñy
(
	`ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vma
))) {

1111 
	`bad_¨ó_ac˚ss_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
);

1120 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
wrôe
 ? 
FAULT_FLAG_WRITE
 : 0);

1122 i‡(
	`u∆ikñy
(
Áu…
 & 
VM_FAULT_ERROR
)) {

1123 
	`mm_Áu…_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

1127 i‡(
Áu…
 & 
VM_FAULT_MAJOR
) {

1128 
tsk
->
maj_Êt
++;

1129 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MAJ
, 1, 0,

1130 
ªgs
, 
addªss
);

1132 
tsk
->
mö_Êt
++;

1133 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MIN
, 1, 0,

1134 
ªgs
, 
addªss
);

1137 
	`check_v8086_mode
(
ªgs
, 
addªss
, 
tsk
);

1139 
	`up_ªad
(&
mm
->
mm≠_£m
);

1140 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<löux/sched.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/vm°©.h
>

10 
	~<löux/highmem.h
>

12 
	~<asm/pgèbÀ.h
>

14 
ölöe
 
±e_t
 
	$gup_gë_±e
(
±e_t
 *
±ï
)

16 #i‚de‡
CONFIG_X86_PAE


17  
	`ACCESS_ONCE
(*
±ï
);

51 
±e_t
 
±e
;

53 
ªåy
:

54 
±e
.
±e_low
 = 
±ï
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±ï
->pte_high;

57 
	`smp_rmb
();

58 i‡(
	`u∆ikñy
(
±e
.
±e_low
 !
±ï
->pte_low))

59 
ªåy
;

61  
±e
;

63 
	}
}

70 
noölöe
 
	$gup_±e_ønge
(
pmd_t
 
pmd
, 
addr
,

71 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

73 
mask
;

74 
±e_t
 *
±ï
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 i‡(
wrôe
)

78 
mask
 |
_PAGE_RW
;

80 
±ï
 = 
	`±e_off£t_m≠
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_gë_±e
(
±ï
);

83 
∑ge
 *page;

85 i‡((
	`±e_Êags
(
±e
Ë& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm≠
(
±ï
);

89 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

90 
∑ge
 = 
	`±e_∑ge
(
±e
);

91 
	`gë_∑ge
(
∑ge
);

92 
∑ges
[*
ƒ
] = 
∑ge
;

93 (*
ƒ
)++;

95 } 
±ï
++, 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

96 
	`±e_unm≠
(
±ï
 - 1);

99 
	}
}

101 
ölöe
 
	$gë_hód_∑ge_mu…ùÀ
(
∑ge
 *∑ge, 
ƒ
)

103 
	`VM_BUG_ON
(
∑ge
 !
	`compound_hód
(page));

104 
	`VM_BUG_ON
(
	`∑ge_cou¡
(
∑ge
) == 0);

105 
	`©omic_add
(
ƒ
, &
∑ge
->
_cou¡
);

106 
	}
}

108 
noölöe
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

111 
mask
;

112 
±e_t
 
±e
 = *’ã_à*)&
pmd
;

113 
∑ge
 *
hód
, *page;

114 
ªfs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 i‡(
wrôe
)

118 
mask
 |
_PAGE_RW
;

119 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

125 
ªfs
 = 0;

126 
hód
 = 
	`±e_∑ge
(
±e
);

127 
∑ge
 = 
hód
 + ((
addr
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

130 
∑ges
[*
ƒ
] = 
∑ge
;

131 (*
ƒ
)++;

132 
∑ge
++;

133 
ªfs
++;

134 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

135 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

138 
	}
}

140 
	$gup_pmd_ønge
(
pud_t
 
pud
, 
addr
, 
íd
,

141 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

143 
√xt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

151 i‡(
	`pmd_n⁄e
(
pmd
))

153 i‡(
	`u∆ikñy
(
	`pmd_œrge
(
pmd
))) {

154 i‡(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

157 i‡(!
	`gup_±e_ønge
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

160 } 
pmdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

163 
	}
}

165 
noölöe
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

168 
mask
;

169 
±e_t
 
±e
 = *’ã_à*)&
pud
;

170 
∑ge
 *
hód
, *page;

171 
ªfs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 i‡(
wrôe
)

175 
mask
 |
_PAGE_RW
;

176 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

182 
ªfs
 = 0;

183 
hód
 = 
	`±e_∑ge
(
±e
);

184 
∑ge
 = 
hód
 + ((
addr
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

187 
∑ges
[*
ƒ
] = 
∑ge
;

188 (*
ƒ
)++;

189 
∑ge
++;

190 
ªfs
++;

191 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

192 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

195 
	}
}

197 
	$gup_pud_ønge
(
pgd_t
 
pgd
, 
addr
, 
íd
,

198 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

200 
√xt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
√xt
 = 
	`pud_addr_íd
(
addr
, 
íd
);

208 i‡(
	`pud_n⁄e
(
pud
))

210 i‡(
	`u∆ikñy
(
	`pud_œrge
(
pud
))) {

211 i‡(!
	`gup_huge_pud
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

214 i‡(!
	`gup_pmd_ønge
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

217 } 
pudp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

220 
	}
}

226 
	$__gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

227 
∑ge
 **
∑ges
)

229 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

230 
addr
, 
Àn
, 
íd
;

231 
√xt
;

232 
Êags
;

233 
pgd_t
 *
pgdp
;

234 
ƒ
 = 0;

236 
°¨t
 &
PAGE_MASK
;

237 
addr
 = 
°¨t
;

238 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

239 
íd
 = 
°¨t
 + 
Àn
;

240 i‡(
	`u∆ikñy
(!
	`ac˚ss_ok
(
wrôe
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

241 (
__u£r
 *)
°¨t
, 
Àn
)))

262 
	`loˇl_úq_ßve
(
Êags
);

263 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

265 
pgd_t
 
pgd
 = *
pgdp
;

267 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

268 i‡(
	`pgd_n⁄e
(
pgd
))

270 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

272 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

273 
	`loˇl_úq_ª°‹e
(
Êags
);

275  
ƒ
;

276 
	}
}

294 
	$gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

295 
∑ge
 **
∑ges
)

297 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

298 
addr
, 
Àn
, 
íd
;

299 
√xt
;

300 
pgd_t
 *
pgdp
;

301 
ƒ
 = 0;

303 
°¨t
 &
PAGE_MASK
;

304 
addr
 = 
°¨t
;

305 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

307 
íd
 = 
°¨t
 + 
Àn
;

308 i‡(
íd
 < 
°¨t
)

309 
¶ow_úq⁄
;

311 #ifde‡
CONFIG_X86_64


312 i‡(
íd
 >> 
__VIRTUAL_MASK_SHIFT
)

313 
¶ow_úq⁄
;

334 
	`loˇl_úq_dißbÀ
();

335 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

337 
pgd_t
 
pgd
 = *
pgdp
;

339 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

340 i‡(
	`pgd_n⁄e
(
pgd
))

341 
¶ow
;

342 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

343 
¶ow
;

344 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

345 
	`loˇl_úq_íabÀ
();

347 
	`VM_BUG_ON
(
ƒ
 !(
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

348  
ƒ
;

351 
ªt
;

353 
¶ow
:

354 
	`loˇl_úq_íabÀ
();

355 
¶ow_úq⁄
:

357 
°¨t
 +
ƒ
 << 
PAGE_SHIFT
;

358 
∑ges
 +
ƒ
;

360 
	`down_ªad
(&
mm
->
mm≠_£m
);

361 
ªt
 = 
	`gë_u£r_∑ges
(
cuºít
, 
mm
, 
°¨t
,

362 (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
, 
wrôe
, 0, 
∑ges
, 
NULL
);

363 
	`up_ªad
(&
mm
->
mm≠_£m
);

366 i‡(
ƒ
 > 0) {

367 i‡(
ªt
 < 0)

368 
ªt
 = 
ƒ
;

370 
ªt
 +
ƒ
;

373  
ªt
;

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<löux/öô.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/hugëlb.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/îr.h
>

14 
	~<löux/sys˘l.h
>

15 
	~<asm/mm™.h
>

16 
	~<asm/éb.h
>

17 
	~<asm/ébÊush.h
>

18 
	~<asm/pgÆloc.h
>

20 
	$∑ge_èbÀ_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
svma
,

21 
vm_¨ó_°ru˘
 *
vma
,

22 
addr
, 
pgoff_t
 
idx
)

24 
ßddr
 = ((
idx
 - 
svma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
) +

25 
svma
->
vm_°¨t
;

26 
sba£
 = 
ßddr
 & 
PUD_MASK
;

27 
s_íd
 = 
sba£
 + 
PUD_SIZE
;

30 
vm_Êags
 = 
vma
->vm_Êag†& ~
VM_LOCKED
;

31 
svm_Êags
 = 
svma
->
vm_Êags
 & ~
VM_LOCKED
;

37 i‡(
	`pmd_ödex
(
addr
Ë!pmd_ödex(
ßddr
) ||

38 
vm_Êags
 !
svm_Êags
 ||

39 
sba£
 < 
svma
->
vm_°¨t
 || svma->
vm_íd
 < 
s_íd
)

42  
ßddr
;

43 
	}
}

45 
	$vma_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

47 
ba£
 = 
addr
 & 
PUD_MASK
;

48 
íd
 = 
ba£
 + 
PUD_SIZE
;

53 i‡(
vma
->
vm_Êags
 & 
VM_MAYSHARE
 &&

54 
vma
->
vm_°¨t
 <
ba£
 && 
íd
 <vma->
vm_íd
)

57 
	}
}

62 
	$huge_pmd_sh¨e
(
mm_°ru˘
 *
mm
, 
addr
, 
pud_t
 *
pud
)

64 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

65 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

66 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_°¨t
Ë>> 
PAGE_SHIFT
) +

67 
vma
->
vm_pgoff
;

68 
¥io_åì_ôî
 
ôî
;

69 
vm_¨ó_°ru˘
 *
svma
;

70 
ßddr
;

71 
±e_t
 *
•ã
 = 
NULL
;

73 i‡(!
	`vma_sh¨óbÀ
(
vma
, 
addr
))

76 
	`•ö_lock
(&
m≠pög
->
i_mm≠_lock
);

77 
	`vma_¥io_åì_f‹óch
(
svma
, &
ôî
, &
m≠pög
->
i_mm≠
, 
idx
, idx) {

78 i‡(
svma
 =
vma
)

81 
ßddr
 = 
	`∑ge_èbÀ_sh¨óbÀ
(
svma
, 
vma
, 
addr
, 
idx
);

82 i‡(
ßddr
) {

83 
•ã
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
ßddr
);

84 i‡(
•ã
) {

85 
	`gë_∑ge
(
	`vút_to_∑ge
(
•ã
));

91 i‡(!
•ã
)

92 
out
;

94 
	`•ö_lock
(&
mm
->
∑ge_èbÀ_lock
);

95 i‡(
	`pud_n⁄e
(*
pud
))

96 
	`pud_p›uœã
(
mm
, 
pud
, (
pmd_t
 *)(()
•ã
 & 
PAGE_MASK
));

98 
	`put_∑ge
(
	`vút_to_∑ge
(
•ã
));

99 
	`•ö_u∆ock
(&
mm
->
∑ge_èbÀ_lock
);

100 
out
:

101 
	`•ö_u∆ock
(&
m≠pög
->
i_mm≠_lock
);

102 
	}
}

116 
	$huge_pmd_unsh¨e
(
mm_°ru˘
 *
mm
, *
addr
, 
±e_t
 *
±ï
)

118 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

119 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

121 
	`BUG_ON
(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 0);

122 i‡(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 1)

125 
	`pud_˛ór
(
pud
);

126 
	`put_∑ge
(
	`vút_to_∑ge
(
±ï
));

127 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

129 
	}
}

131 
±e_t
 *
	$huge_±e_Æloc
(
mm_°ru˘
 *
mm
,

132 
addr
, 
sz
)

134 
pgd_t
 *
pgd
;

135 
pud_t
 *
pud
;

136 
±e_t
 *
±e
 = 
NULL
;

138 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

139 
pud
 = 
	`pud_Æloc
(
mm
, 
pgd
, 
addr
);

140 i‡(
pud
) {

141 i‡(
sz
 =
PUD_SIZE
) {

142 
±e
 = (
±e_t
 *)
pud
;

144 
	`BUG_ON
(
sz
 !
PMD_SIZE
);

145 i‡(
	`pud_n⁄e
(*
pud
))

146 
	`huge_pmd_sh¨e
(
mm
, 
addr
, 
pud
);

147 
±e
 = (
±e_t
 *Ë
	`pmd_Æloc
(
mm
, 
pud
, 
addr
);

150 
	`BUG_ON
(
±e
 && !
	`±e_n⁄e
(*±eË&& !
	`±e_huge
(*pte));

152  
±e
;

153 
	}
}

155 
±e_t
 *
	$huge_±e_off£t
(
mm_°ru˘
 *
mm
, 
addr
)

157 
pgd_t
 *
pgd
;

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
 = 
NULL
;

161 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

162 i‡(
	`pgd_¥e£¡
(*
pgd
)) {

163 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

164 i‡(
	`pud_¥e£¡
(*
pud
)) {

165 i‡(
	`pud_œrge
(*
pud
))

166  (
±e_t
 *)
pud
;

167 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

170  (
±e_t
 *Ë
pmd
;

171 
	}
}

174 
∑ge
 *

175 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

177 
°¨t
 = 
addªss
;

178 
Àngth
 = 1;

179 
ƒ
;

180 
∑ge
 *page;

181 
vm_¨ó_°ru˘
 *
vma
;

183 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

184 i‡(!
vma
 || !
	`is_vm_hugëlb_∑ge
(vma))

185  
	`ERR_PTR
(-
EINVAL
);

187 
±e
 = 
	`huge_±e_off£t
(
mm
, 
addªss
);

190 
	`WARN_ON
(!
±e
 || 
	`±e_n⁄e
(*pte));

192 
∑ge
 = &
	`±e_∑ge
(*
±e
)[
vp‚
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

194 
	`WARN_ON
(!
	`PageHód
(
∑ge
));

196  
∑ge
;

197 
	}
}

199 
	$pmd_huge
(
pmd_t
 
pmd
)

202 
	}
}

204 
	$pud_huge
(
pud_t
 
pud
)

207 
	}
}

209 
∑ge
 *

210 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

211 
pmd_t
 *
pmd
, 
wrôe
)

213  
NULL
;

214 
	}
}

218 
∑ge
 *

219 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

221  
	`ERR_PTR
(-
EINVAL
);

222 
	}
}

224 
	$pmd_huge
(
pmd_t
 
pmd
)

226  !!(
	`pmd_vÆ
(
pmd
Ë& 
_PAGE_PSE
);

227 
	}
}

229 
	$pud_huge
(
pud_t
 
pud
)

231  !!(
	`pud_vÆ
(
pud
Ë& 
_PAGE_PSE
);

232 
	}
}

234 
∑ge
 *

235 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

236 
pmd_t
 *
pmd
, 
wrôe
)

238 
∑ge
 *page;

240 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pmd
);

241 i‡(
∑ge
)

242 
∑ge
 +((
addªss
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

243  
∑ge
;

244 
	}
}

246 
∑ge
 *

247 
	$fﬁlow_huge_pud
(
mm_°ru˘
 *
mm
, 
addªss
,

248 
pud_t
 *
pud
, 
wrôe
)

250 
∑ge
 *page;

252 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pud
);

253 i‡(
∑ge
)

254 
∑ge
 +((
addªss
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

255  
∑ge
;

256 
	}
}

262 #ifde‡
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


263 
	$hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
 *file,

264 
addr
, 
Àn
,

265 
pgoff
, 
Êags
)

267 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

268 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

269 
vm_¨ó_°ru˘
 *
vma
;

270 
°¨t_addr
;

272 i‡(
Àn
 > 
mm
->
ˇched_hﬁe_size
) {

273 
°¨t_addr
 = 
mm
->
‰ì_¨ó_ˇche
;

275 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

276 
mm
->
ˇched_hﬁe_size
 = 0;

279 
fuŒ_£¨ch
:

280 
addr
 = 
	`ALIGN
(
°¨t_addr
, 
	`huge_∑ge_size
(
h
));

282 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

284 i‡(
TASK_SIZE
 - 
Àn
 < 
addr
) {

289 i‡(
°¨t_addr
 !
TASK_UNMAPPED_BASE
) {

290 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

291 
mm
->
ˇched_hﬁe_size
 = 0;

292 
fuŒ_£¨ch
;

294  -
ENOMEM
;

296 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

297 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

298  
addr
;

300 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

301 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

302 
addr
 = 
	`ALIGN
(
vma
->
vm_íd
, 
	`huge_∑ge_size
(
h
));

304 
	}
}

306 
	$hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
 *file,

307 
addr0
, 
Àn
,

308 
pgoff
, 
Êags
)

310 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

311 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

312 
vm_¨ó_°ru˘
 *
vma
, *
¥ev_vma
;

313 
ba£
 = 
mm
->
mm≠_ba£
, 
addr
 = 
addr0
;

314 
œrge°_hﬁe
 = 
mm
->
ˇched_hﬁe_size
;

315 
fú°_time
 = 1;

318 i‡(
mm
->
‰ì_¨ó_ˇche
 > 
ba£
)

319 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

321 i‡(
Àn
 <
œrge°_hﬁe
) {

322 
œrge°_hﬁe
 = 0;

323 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

325 
åy_agaö
:

327 i‡(
mm
->
‰ì_¨ó_ˇche
 < 
Àn
)

328 
Áû
;

331 
addr
 = (
mm
->
‰ì_¨ó_ˇche
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

337 i‡(!(
vma
 = 
	`föd_vma_¥ev
(
mm
, 
addr
, &
¥ev_vma
)))

338  
addr
;

344 i‡(
addr
 + 
Àn
 <
vma
->
vm_°¨t
 &&

345 (!
¥ev_vma
 || (
addr
 >¥ev_vma->
vm_íd
))) {

347 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

348  (
mm
->
‰ì_¨ó_ˇche
 = 
addr
);

351 i‡(
mm
->
‰ì_¨ó_ˇche
 =
vma
->
vm_íd
) {

352 
mm
->
‰ì_¨ó_ˇche
 = 
vma
->
vm_°¨t
;

353 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

358 i‡(
addr
 + 
œrge°_hﬁe
 < 
vma
->
vm_°¨t
)

359 
œrge°_hﬁe
 = 
vma
->
vm_°¨t
 - 
addr
;

362 
addr
 = (
vma
->
vm_°¨t
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

363 } 
Àn
 <
vma
->
vm_°¨t
);

365 
Áû
:

370 i‡(
fú°_time
) {

371 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

372 
œrge°_hﬁe
 = 0;

373 
fú°_time
 = 0;

374 
åy_agaö
;

382 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

383 
mm
->
ˇched_hﬁe_size
 = ~0UL;

384 
addr
 = 
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr0
,

385 
Àn
, 
pgoff
, 
Êags
);

390 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

391 
mm
->
ˇched_hﬁe_size
 = ~0UL;

393  
addr
;

394 
	}
}

397 
	$hugëlb_gë_unm≠≥d_¨ó
(
fûe
 *fûe, 
addr
,

398 
Àn
, 
pgoff
, 
Êags
)

400 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

401 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

402 
vm_¨ó_°ru˘
 *
vma
;

404 i‡(
Àn
 & ~
	`huge_∑ge_mask
(
h
))

405  -
EINVAL
;

406 i‡(
Àn
 > 
TASK_SIZE
)

407  -
ENOMEM
;

409 i‡(
Êags
 & 
MAP_FIXED
) {

410 i‡(
	`¥ï¨e_hugïage_ønge
(
fûe
, 
addr
, 
Àn
))

411  -
EINVAL
;

412  
addr
;

415 i‡(
addr
) {

416 
addr
 = 
	`ALIGN
◊ddr, 
	`huge_∑ge_size
(
h
));

417 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

418 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

419 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

420  
addr
;

422 i‡(
mm
->
gë_unm≠≥d_¨ó
 =
¨ch_gë_unm≠≥d_¨ó
)

423  
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr
, 
Àn
,

424 
pgoff
, 
Êags
);

426  
	`hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
, 
addr
, 
Àn
,

427 
pgoff
, 
Êags
);

428 
	}
}

432 #ifde‡
CONFIG_X86_64


433 
__öô
 
	$£tup_hugïagesz
(*
›t
)

435 
ps
 = 
	`mem∑r£
(
›t
, &opt);

436 i‡(
ps
 =
PMD_SIZE
) {

437 
	`hugëlb_add_h°©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

438 } i‡(
ps
 =
PUD_SIZE
 && 
˝u_has_gb∑ges
) {

439 
	`hugëlb_add_h°©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

441 
	`¥ötk
(
KERN_ERR
 "hugepagesz: UnsupportedÖage size %lu M\n",

442 
ps
 >> 20);

446 
	}
}

447 
__£tup
("hugïagesz=", 
£tup_hugïagesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<löux/öôrd.h
>

2 
	~<löux/i›‹t.h
>

3 
	~<löux/sw≠.h
>

5 
	~<asm/ˇcheÊush.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/öô.h
>

8 
	~<asm/∑ge.h
>

9 
	~<asm/∑ge_ty≥s.h
>

10 
	~<asm/£˘i⁄s.h
>

11 
	~<asm/£tup.h
>

12 
	~<asm/sy°em.h
>

13 
	~<asm/ébÊush.h
>

14 
	~<asm/éb.h
>

15 
	~<asm/¥Ÿo.h
>

17 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

19 
__öôd©a
 
	ge820_èbÀ_°¨t
;

20 
__memöôd©a
 
	ge820_èbÀ_íd
;

21 
__memöôd©a
 
	ge820_èbÀ_t›
;

23 
	ga·î_boŸmem
;

25 
	gdúe˘_gb∑ges


26 #ifde‡
CONFIG_DIRECT_GBPAGES


31 
__öô
 
	$föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
,

32 
u£_gb∑ges
)

34 
puds
, 
pmds
, 
±es
, 
èbÀs
, 
°¨t
;

36 
puds
 = (
íd
 + 
PUD_SIZE
 - 1Ë>> 
PUD_SHIFT
;

37 
èbÀs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

39 i‡(
u£_gb∑ges
) {

40 
exåa
;

42 
exåa
 = 
íd
 - (”nd>>
PUD_SHIFT
) << PUD_SHIFT);

43 
pmds
 = (
exåa
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

45 
pmds
 = (
íd
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

47 
èbÀs
 +
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

49 i‡(
u£_p£
) {

50 
exåa
;

52 
exåa
 = 
íd
 - (”nd>>
PMD_SHIFT
) << PMD_SHIFT);

53 #ifde‡
CONFIG_X86_32


54 
exåa
 +
PMD_SIZE
;

56 
±es
 = (
exåa
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

58 
±es
 = (
íd
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

60 
èbÀs
 +
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

62 #ifde‡
CONFIG_X86_32


64 
èbÀs
 +
	`roundup
(
__íd_of_fixed_addªs£s
 * (
±e_t
), 
PAGE_SIZE
);

72 #ifde‡
CONFIG_X86_32


73 
°¨t
 = 0x7000;

75 
°¨t
 = 0x8000;

77 
e820_èbÀ_°¨t
 = 
	`föd_e820_¨ó
(
°¨t
, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
,

78 
èbÀs
, 
PAGE_SIZE
);

79 i‡(
e820_èbÀ_°¨t
 == -1UL)

80 
	`∑nic
("Cannot find space forÅhe kernelÖageÅables");

82 
e820_èbÀ_°¨t
 >>
PAGE_SHIFT
;

83 
e820_èbÀ_íd
 = 
e820_èbÀ_°¨t
;

84 
e820_èbÀ_t›
 = 
e820_èbÀ_°¨t
 + (
èbÀs
 >> 
PAGE_SHIFT
);

86 
	`¥ötk
(
KERN_DEBUG
 "kernel direct mappingÅables upÅo %lx @ %lx-%lx\n",

87 
íd
, 
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
, 
e820_èbÀ_t›
 << PAGE_SHIFT);

88 
	}
}

90 
	sm≠_ønge
 {

91 
	m°¨t
;

92 
	míd
;

93 
	m∑ge_size_mask
;

96 #ifde‡
CONFIG_X86_32


97 
	#NR_RANGE_MR
 3

	)

99 
	#NR_RANGE_MR
 5

	)

102 
__memöô
 
	$ßve_mr
(
m≠_ønge
 *
mr
, 
ƒ_ønge
,

103 
°¨t_p‚
, 
íd_p‚
,

104 
∑ge_size_mask
)

106 i‡(
°¨t_p‚
 < 
íd_p‚
) {

107 i‡(
ƒ_ønge
 >
NR_RANGE_MR
)

108 
	`∑nic
("run out ofÑange for init_memory_mapping\n");

109 
mr
[
ƒ_ønge
].
°¨t
 = 
°¨t_p‚
<<
PAGE_SHIFT
;

110 
mr
[
ƒ_ønge
].
íd
 = 
íd_p‚
<<
PAGE_SHIFT
;

111 
mr
[
ƒ_ønge
].
∑ge_size_mask
 =Öage_size_mask;

112 
ƒ_ønge
++;

115  
ƒ_ønge
;

116 
	}
}

123 
__öô_ªfok
 
	$öô_mem‹y_m≠pög
(
°¨t
,

124 
íd
)

126 
∑ge_size_mask
 = 0;

127 
°¨t_p‚
, 
íd_p‚
;

128 
ªt
 = 0;

129 
pos
;

131 
m≠_ønge
 
mr
[
NR_RANGE_MR
];

132 
ƒ_ønge
, 
i
;

133 
u£_p£
, 
u£_gb∑ges
;

135 
	`¥ötk
(
KERN_INFO
 "öô_mem‹y_m≠pög: %016lx-%016lx\n", 
°¨t
, 
íd
);

137 #i‡
	`deföed
(
CONFIG_DEBUG_PAGEALLOC
Ë|| deföed(
CONFIG_KMEMCHECK
)

143 
u£_p£
 = 
u£_gb∑ges
 = 0;

145 
u£_p£
 = 
˝u_has_p£
;

146 
u£_gb∑ges
 = 
dúe˘_gb∑ges
;

150 i‡(
˝u_has_p£
)

151 
	`£t_ö_¸4
(
X86_CR4_PSE
);

154 i‡(
˝u_has_pge
) {

155 
	`£t_ö_¸4
(
X86_CR4_PGE
);

156 
__suµ‹ãd_±e_mask
 |
_PAGE_GLOBAL
;

159 i‡(
u£_gb∑ges
)

160 
∑ge_size_mask
 |1 << 
PG_LEVEL_1G
;

161 i‡(
u£_p£
)

162 
∑ge_size_mask
 |1 << 
PG_LEVEL_2M
;

164 
	`mem£t
(
mr
, 0, (mr));

165 
ƒ_ønge
 = 0;

168 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

169 
pos
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

170 #ifde‡
CONFIG_X86_32


177 i‡(
pos
 == 0)

178 
íd_p‚
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

180 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

181 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

183 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1)Ë>> 
PMD_SHIFT
)

184 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

186 i‡(
íd_p‚
 > (
íd
 >> 
PAGE_SHIFT
))

187 
íd_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

188 i‡(
°¨t_p‚
 < 
íd_p‚
) {

189 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

190 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

194 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

195 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

196 #ifde‡
CONFIG_X86_32


197 
íd_p‚
 = (
íd
>>
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

199 
íd_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

200 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

201 i‡(
íd_p‚
 > ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

202 
íd_p‚
 = ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

205 i‡(
°¨t_p‚
 < 
íd_p‚
) {

206 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

207 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

208 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

211 #ifde‡
CONFIG_X86_64


213 
°¨t_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

214 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

215 
íd_p‚
 = (
íd
 >> 
PUD_SHIFT
Ë<< (PUD_SHIFT - 
PAGE_SHIFT
);

216 i‡(
°¨t_p‚
 < 
íd_p‚
) {

217 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

218 
∑ge_size_mask
 &

219 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

220 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

224 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

225 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

226 
íd_p‚
 = (
íd
 >> 
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

227 i‡(
°¨t_p‚
 < 
íd_p‚
) {

228 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

229 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

230 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

235 
°¨t_p‚
 = 
pos
>>
PAGE_SHIFT
;

236 
íd_p‚
 = 
íd
>>
PAGE_SHIFT
;

237 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

240 
i
 = 0; 
ƒ_ønge
 > 1 && i <Çr_range - 1; i++) {

241 
ﬁd_°¨t
;

242 i‡(
mr
[
i
].
íd
 !mr[i+1].
°¨t
 ||

243 
mr
[
i
].
∑ge_size_mask
 != mr[i+1].page_size_mask)

246 
ﬁd_°¨t
 = 
mr
[
i
].
°¨t
;

247 
	`memmove
(&
mr
[
i
], &mr[i+1],

248 (
ƒ_ønge
 - 1 - 
i
Ë* (
m≠_ønge
));

249 
mr
[
i
--].
°¨t
 = 
ﬁd_°¨t
;

250 
ƒ_ønge
--;

253 
i
 = 0; i < 
ƒ_ønge
; i++)

254 
	`¥ötk
(
KERN_DEBUG
 " %010lx - %010lxÖage %s\n",

255 
mr
[
i
].
°¨t
, mr[i].
íd
,

256 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

257 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

266 i‡(!
a·î_boŸmem
)

267 
	`föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
, 
u£_gb∑ges
);

269 #ifde‡
CONFIG_X86_32


270 
i
 = 0; i < 
ƒ_ønge
; i++)

271 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

272 
mr
[
i
].
∑ge_size_mask
);

273 
ªt
 = 
íd
;

275 
i
 = 0; i < 
ƒ_ønge
; i++)

276 
ªt
 = 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

277 
mr
[
i
].
∑ge_size_mask
);

280 #ifde‡
CONFIG_X86_32


281 
	`óæy_i‹em≠_∑ge_èbÀ_ønge_öô
();

283 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

286 #ifde‡
CONFIG_X86_64


287 i‡(!
a·î_boŸmem
 && !
°¨t
) {

288 
pud_t
 *
pud
;

289 
pmd_t
 *
pmd
;

291 
mmu_¸4_„©uªs
 = 
	`ªad_¸4
();

299 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_íd
), _brk_end);

300 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_íd
 - 1);

301 ++
pmd
 <
	`pmd_off£t
(
pud
, ()
_íd
 - 1))

302 
	`pmd_˛ór
(
pmd
);

305 
	`__Êush_éb_Æl
();

307 i‡(!
a·î_boŸmem
 && 
e820_èbÀ_íd
 > 
e820_èbÀ_°¨t
)

308 
	`ª£rve_óæy
(
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
,

309 
e820_èbÀ_íd
 << 
PAGE_SHIFT
, "PGTABLE");

311 i‡(!
a·î_boŸmem
)

312 
	`óæy_memã°
(
°¨t
, 
íd
);

314  
ªt
 >> 
PAGE_SHIFT
;

315 
	}
}

328 
	$devmem_is_Ælowed
(
∑gír
)

330 i‡(
∑gír
 <= 256)

332 i‡(
	`iomem_is_ex˛usive
(
∑gír
 << 
PAGE_SHIFT
))

334 i‡(!
	`∑ge_is_øm
(
∑gír
))

337 
	}
}

339 
	$‰ì_öô_∑ges
(*
wh©
, 
begö
, 
íd
)

341 
addr
 = 
begö
;

343 i‡(
addr
 >
íd
)

351 #ifde‡
CONFIG_DEBUG_PAGEALLOC


352 
	`¥ötk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

353 
begö
, 
	`PAGE_ALIGN
(
íd
));

354 
	`£t_mem‹y_≈
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

361 
	`£t_mem‹y_rw
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

363 
	`¥ötk
(
KERN_INFO
 "Fªeög %s: %luk fªed\n", 
wh©
, (
íd
 - 
begö
) >> 10);

365 ; 
addr
 < 
íd
;ádd∏+
PAGE_SIZE
) {

366 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
addr
));

367 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
addr
));

368 
	`mem£t
((*)(
addr
 & ~(
PAGE_SIZE
-1)),

369 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

370 
	`‰ì_∑ge
(
addr
);

371 
tŸÆøm_∑ges
++;

374 
	}
}

376 
	$‰ì_öômem
()

378 
	`‰ì_öô_∑ges
("unused kernel memory",

379 ()(&
__öô_begö
),

380 ()(&
__öô_íd
));

381 
	}
}

383 #ifde‡
CONFIG_BLK_DEV_INITRD


384 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

386 
	`‰ì_öô_∑ges
("öôrd mem‹y", 
°¨t
, 
íd
);

387 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<löux/sig«l.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/mm™.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sw≠.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/∑gem≠.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/¥oc_fs.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/p‚.h
>

27 
	~<löux/pois⁄.h
>

28 
	~<löux/dma-m≠pög.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/mem‹y_hŸ∂ug.h
>

31 
	~<löux/nmi.h
>

33 
	~<asm/¥o˚ss‹.h
>

34 
	~<asm/bios_ebda.h
>

35 
	~<asm/sy°em.h
>

36 
	~<asm/uac˚ss.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/pgÆloc.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/e820.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/éb.h
>

44 
	~<asm/mmu_c⁄ãxt.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/smp.h
>

47 
	~<asm/£˘i⁄s.h
>

48 
	~<asm/kdebug.h
>

49 
	~<asm/numa.h
>

50 
	~<asm/ˇcheÊush.h
>

51 
	~<asm/öô.h
>

52 
	~<löux/boŸmem.h
>

54 
dma_ª£rve
 
	g__öôd©a
;

56 
__öô
 
	$∑r£_dúe˘_gb∑ges_off
(*
¨g
)

58 
dúe˘_gb∑ges
 = 0;

60 
	}
}

61 
óæy_∑øm
("nogb∑ges", 
∑r£_dúe˘_gb∑ges_off
);

63 
__öô
 
	$∑r£_dúe˘_gb∑ges_⁄
(*
¨g
)

65 
dúe˘_gb∑ges
 = 1;

67 
	}
}

68 
óæy_∑øm
("gb∑ges", 
∑r£_dúe˘_gb∑ges_⁄
);

76 
±evÆ_t
 
__suµ‹ãd_±e_mask
 
	g__ªad_mo°ly
 = ~
_PAGE_IOMAP
;

77 
EXPORT_SYMBOL_GPL
(
__suµ‹ãd_±e_mask
);

79 
	gf‹˚_≥rs⁄Æôy32
;

89 
__öô
 
	$n⁄x32_£tup
(*
°r
)

91 i‡(!
	`°rcmp
(
°r
, "on"))

92 
f‹˚_≥rs⁄Æôy32
 &~
READ_IMPLIES_EXEC
;

93 i‡(!
	`°rcmp
(
°r
, "off"))

94 
f‹˚_≥rs⁄Æôy32
 |
READ_IMPLIES_EXEC
;

96 
	}
}

97 
__£tup
("n€xec32=", 
n⁄x32_£tup
);

103 
__ªf
 *
	$•p_gë∑ge
()

105 *
±r
;

107 i‡(
a·î_boŸmem
)

108 
±r
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

110 
±r
 = 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

112 i‡(!
±r
 || ((Ìå & ~
PAGE_MASK
)) {

113 
	`∑nic
("set_pte_phys: cannotállocateÖage data %s\n",

114 
a·î_boŸmem
 ? "after bootmem" : "");

117 
	`¥_debug
("•p_gë∑gê%p\n", 
±r
);

119  
±r
;

120 
	}
}

122 
pud_t
 *
	$fûl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

124 i‡(
	`pgd_n⁄e
(*
pgd
)) {

125 
pud_t
 *
pud
 = (pud_à*)
	`•p_gë∑ge
();

126 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
pud
);

127 i‡(
pud
 !
	`pud_off£t
(
pgd
, 0))

128 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

129 
pud
, 
	`pud_off£t
(
pgd
, 0));

131  
	`pud_off£t
(
pgd
, 
vaddr
);

132 
	}
}

134 
pmd_t
 *
	$fûl_pmd
(
pud_t
 *
pud
, 
vaddr
)

136 i‡(
	`pud_n⁄e
(*
pud
)) {

137 
pmd_t
 *
pmd
 = (pmd_à*Ë
	`•p_gë∑ge
();

138 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
pmd
);

139 i‡(
pmd
 !
	`pmd_off£t
(
pud
, 0))

140 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

141 
pmd
, 
	`pmd_off£t
(
pud
, 0));

143  
	`pmd_off£t
(
pud
, 
vaddr
);

144 
	}
}

146 
±e_t
 *
	$fûl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

148 i‡(
	`pmd_n⁄e
(*
pmd
)) {

149 
±e_t
 *
±e
 = (±e_à*Ë
	`•p_gë∑ge
();

150 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
±e
);

151 i‡(
±e
 !
	`±e_off£t_kî√l
(
pmd
, 0))

152 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

154  
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

155 
	}
}

157 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_∑ge
, 
vaddr
, 
±e_t
 
√w_±e
)

159 
pud_t
 *
pud
;

160 
pmd_t
 *
pmd
;

161 
±e_t
 *
±e
;

163 
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
vaddr
);

164 
pmd
 = 
	`fûl_pmd
(
pud
, 
vaddr
);

165 
±e
 = 
	`fûl_±e
(
pmd
, 
vaddr
);

167 
	`£t_±e
(
±e
, 
√w_±e
);

173 
	`__Êush_éb_⁄e
(
vaddr
);

174 
	}
}

176 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±evÆ
)

178 
pgd_t
 *
pgd
;

179 
pud_t
 *
pud_∑ge
;

181 
	`¥_debug
("£t_±e_vadd∏%lxÅÿ%lx\n", 
vaddr
, 
	`«tive_±e_vÆ
(
±evÆ
));

183 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

184 i‡(
	`pgd_n⁄e
(*
pgd
)) {

185 
	`¥ötk
(
KERN_ERR


189 
pud_∑ge
 = (
pud_t
*)
	`pgd_∑ge_vaddr
(*
pgd
);

190 
	`£t_±e_vaddr_pud
(
pud_∑ge
, 
vaddr
, 
±evÆ
);

191 
	}
}

193 
pmd_t
 * 
__öô
 
	$p›uœã_exåa_pmd
(
vaddr
)

195 
pgd_t
 *
pgd
;

196 
pud_t
 *
pud
;

198 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

199 
pud
 = 
	`fûl_pud
(
pgd
, 
vaddr
);

200  
	`fûl_pmd
(
pud
, 
vaddr
);

201 
	}
}

203 
±e_t
 * 
__öô
 
	$p›uœã_exåa_±e
(
vaddr
)

205 
pmd_t
 *
pmd
;

207 
pmd
 = 
	`p›uœã_exåa_pmd
(
vaddr
);

208  
	`fûl_±e
(
pmd
, 
vaddr
);

209 
	}
}

214 
__öô
 
	$__öô_exåa_m≠pög
(
phys
, 
size
,

215 
pg¥Ÿ_t
 
¥Ÿ
)

217 
pgd_t
 *
pgd
;

218 
pud_t
 *
pud
;

219 
pmd_t
 *
pmd
;

221 
	`BUG_ON
((
phys
 & ~
PMD_MASK
Ë|| (
size
 & ~PMD_MASK));

222 ; 
size
; 
phys
 +
PMD_SIZE
, size -= PMD_SIZE) {

223 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

224 i‡(
	`pgd_n⁄e
(*
pgd
)) {

225 
pud
 = (
pud_t
 *Ë
	`•p_gë∑ge
();

226 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
 |

227 
_PAGE_USER
));

229 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

230 i‡(
	`pud_n⁄e
(*
pud
)) {

231 
pmd
 = (
pmd_t
 *Ë
	`•p_gë∑ge
();

232 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
 |

233 
_PAGE_USER
));

235 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

236 
	`BUG_ON
(!
	`pmd_n⁄e
(*
pmd
));

237 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg¥Ÿ_vÆ
(
¥Ÿ
)));

239 
	}
}

241 
__öô
 
	$öô_exåa_m≠pög_wb
(
phys
, 
size
)

243 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

244 
	}
}

246 
__öô
 
	$öô_exåa_m≠pög_uc
(
phys
, 
size
)

248 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

249 
	}
}

264 
__öô
 
	$˛ónup_highm≠
()

266 
vaddr
 = 
__START_KERNEL_m≠
;

267 
íd
 = 
	`roundup
(()
_íd
, 
PMD_SIZE
) - 1;

268 
pmd_t
 *
pmd
 = 
Àvñ2_kî√l_pgt
;

269 
pmd_t
 *
œ°_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

271 ; 
pmd
 < 
œ°_pmd
;Ömd++, 
vaddr
 +
PMD_SIZE
) {

272 i‡(
	`pmd_n⁄e
(*
pmd
))

274 i‡(
vaddr
 < (Ë
_ãxt
 || vadd∏> 
íd
)

275 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

277 
	}
}

279 
__ªf
 *
	$Æloc_low_∑ge
(*
phys
)

281 
p‚
 = 
e820_èbÀ_íd
++;

282 *
adr
;

284 i‡(
a·î_boŸmem
) {

285 
adr
 = (*)
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

286 *
phys
 = 
	`__∑
(
adr
);

288  
adr
;

291 i‡(
p‚
 >
e820_èbÀ_t›
)

292 
	`∑nic
("alloc_low_page:Ñan out of memory");

294 
adr
 = 
	`óæy_memªm≠
(
p‚
 * 
PAGE_SIZE
, PAGE_SIZE);

295 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

296 *
phys
 = 
p‚
 * 
PAGE_SIZE
;

297  
adr
;

298 
	}
}

300 
__ªf
 
	$unm≠_low_∑ge
(*
adr
)

302 i‡(
a·î_boŸmem
)

305 
	`óæy_iounm≠
(
adr
, 
PAGE_SIZE
);

306 
	}
}

308 
__memöô


309 
	$phys_±e_öô
(
±e_t
 *
±e_∑ge
, 
addr
, 
íd
,

310 
pg¥Ÿ_t
 
¥Ÿ
)

312 
∑ges
 = 0;

313 
œ°_m≠_addr
 = 
íd
;

314 
i
;

316 
±e_t
 *
±e
 = 
±e_∑ge
 + 
	`±e_ödex
(
addr
);

318 
i
 = 
	`±e_ödex
(
addr
); i < 
PTRS_PER_PTE
; i++,ádd∏+
PAGE_SIZE
, 
±e
++) {

320 i‡(
addr
 >
íd
) {

321 i‡(!
a·î_boŸmem
) {

322 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

323 
	`£t_±e
(
±e
, 
	`__±e
(0));

334 i‡(
	`±e_vÆ
(*
±e
)) {

335 
∑ges
++;

340 
	`¥ötk
("Öte=%páddr=%lxÖte=%016lx\n",

341 
±e
, 
addr
, 
	`p‚_±e
◊dd∏>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

342 
∑ges
++;

343 
	`£t_±e
(
±e
, 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
¥Ÿ
));

344 
œ°_m≠_addr
 = (
addr
 & 
PAGE_MASK
Ë+ 
PAGE_SIZE
;

347 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_4K
, 
∑ges
);

349  
œ°_m≠_addr
;

350 
	}
}

352 
__memöô


353 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
addªss
, 
íd
,

354 
pg¥Ÿ_t
 
¥Ÿ
)

356 
±e_t
 *
±e
 = (±e_à*)
	`pmd_∑ge_vaddr
(*
pmd
);

358  
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
¥Ÿ
);

359 
	}
}

361 
__memöô


362 
	$phys_pmd_öô
(
pmd_t
 *
pmd_∑ge
, 
addªss
, 
íd
,

363 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

365 
∑ges
 = 0;

366 
œ°_m≠_addr
 = 
íd
;

368 
i
 = 
	`pmd_ödex
(
addªss
);

370 ; 
i
 < 
PTRS_PER_PMD
; i++, 
addªss
 +
PMD_SIZE
) {

371 
±e_phys
;

372 
pmd_t
 *
pmd
 = 
pmd_∑ge
 + 
	`pmd_ödex
(
addªss
);

373 
±e_t
 *
±e
;

374 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
¥Ÿ
;

376 i‡(
addªss
 >
íd
) {

377 i‡(!
a·î_boŸmem
) {

378 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

379 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

384 i‡(
	`pmd_vÆ
(*
pmd
)) {

385 i‡(!
	`pmd_œrge
(*
pmd
)) {

386 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

387 
œ°_m≠_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
addªss
,

388 
íd
, 
¥Ÿ
);

389 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

404 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

405 
∑ges
++;

408 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pmd
));

411 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

412 
∑ges
++;

413 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

414 
	`£t_±e
((
±e_t
 *)
pmd
,

415 
	`p‚_±e
(
addªss
 >> 
PAGE_SHIFT
,

416 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_PSE
)));

417 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

418 
œ°_m≠_addr
 = (
addªss
 & 
PMD_MASK
Ë+ 
PMD_SIZE
;

422 
±e
 = 
	`Æloc_low_∑ge
(&
±e_phys
);

423 
œ°_m≠_addr
 = 
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
√w_¥Ÿ
);

424 
	`unm≠_low_∑ge
(
±e
);

426 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

427 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
	`__va
(
±e_phys
));

428 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

430 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_2M
, 
∑ges
);

431  
œ°_m≠_addr
;

432 
	}
}

434 
__memöô


435 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
addªss
, 
íd
,

436 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

438 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

439 
œ°_m≠_addr
;

441 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addªss
, 
íd
, 
∑ge_size_mask
, 
¥Ÿ
);

442 
	`__Êush_éb_Æl
();

443  
œ°_m≠_addr
;

444 
	}
}

446 
__memöô


447 
	$phys_pud_öô
(
pud_t
 *
pud_∑ge
, 
addr
, 
íd
,

448 
∑ge_size_mask
)

450 
∑ges
 = 0;

451 
œ°_m≠_addr
 = 
íd
;

452 
i
 = 
	`pud_ödex
(
addr
);

454 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add∏& 
PUD_MASK
Ë+ 
PUD_SIZE
) {

455 
pmd_phys
;

456 
pud_t
 *
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
addr
);

457 
pmd_t
 *
pmd
;

458 
pg¥Ÿ_t
 
¥Ÿ
 = 
PAGE_KERNEL
;

460 i‡(
addr
 >
íd
)

463 i‡(!
a·î_boŸmem
 &&

464 !
	`e820_™y_m≠≥d
(
addr
,áddr+
PUD_SIZE
, 0)) {

465 
	`£t_pud
(
pud
, 
	`__pud
(0));

469 i‡(
	`pud_vÆ
(*
pud
)) {

470 i‡(!
	`pud_œrge
(*
pud
)) {

471 
œ°_m≠_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
íd
,

472 
∑ge_size_mask
, 
¥Ÿ
);

487 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

488 
∑ges
++;

491 
¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pud
));

494 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

495 
∑ges
++;

496 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

497 
	`£t_±e
((
±e_t
 *)
pud
,

498 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

499 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

500 
œ°_m≠_addr
 = (
addr
 & 
PUD_MASK
Ë+ 
PUD_SIZE
;

504 
pmd
 = 
	`Æloc_low_∑ge
(&
pmd_phys
);

505 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addr
, 
íd
, 
∑ge_size_mask
,

506 
¥Ÿ
);

507 
	`unm≠_low_∑ge
(
pmd
);

509 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

510 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
	`__va
(
pmd_phys
));

511 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

513 
	`__Êush_éb_Æl
();

515 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_1G
, 
∑ges
);

517  
œ°_m≠_addr
;

518 
	}
}

520 
__memöô


521 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
íd
,

522 
∑ge_size_mask
)

524 
pud_t
 *
pud
;

526 
pud
 = (
pud_t
 *)
	`pgd_∑ge_vaddr
(*
pgd
);

528  
	`phys_pud_öô
(
pud
, 
addr
, 
íd
, 
∑ge_size_mask
);

529 
	}
}

531 
__memöô


532 
	$kî√l_physiˇl_m≠pög_öô
(
°¨t
,

533 
íd
,

534 
∑ge_size_mask
)

537 
√xt
, 
œ°_m≠_addr
 = 
íd
;

539 
°¨t
 = ()
	`__va
(start);

540 
íd
 = ()
	`__va
(end);

542 ; 
°¨t
 < 
íd
; sèπ = 
√xt
) {

543 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
°¨t
);

544 
pud_phys
;

545 
pud_t
 *
pud
;

547 
√xt
 = (
°¨t
 + 
PGDIR_SIZE
Ë& 
PGDIR_MASK
;

548 i‡(
√xt
 > 
íd
)

549 
√xt
 = 
íd
;

551 i‡(
	`pgd_vÆ
(*
pgd
)) {

552 
œ°_m≠_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__∑
(
°¨t
),

553 
	`__∑
(
íd
), 
∑ge_size_mask
);

557 
pud
 = 
	`Æloc_low_∑ge
(&
pud_phys
);

558 
œ°_m≠_addr
 = 
	`phys_pud_öô
(
pud
, 
	`__∑
(
°¨t
), __∑(
√xt
),

559 
∑ge_size_mask
);

560 
	`unm≠_low_∑ge
(
pud
);

562 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

563 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
	`__va
(
pud_phys
));

564 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

566 
	`__Êush_éb_Æl
();

568  
œ°_m≠_addr
;

569 
	}
}

571 #i‚de‡
CONFIG_NUMA


572 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
íd_p‚
,

573 
a˝i
, 
k8
)

575 
boŸm≠_size
, 
boŸm≠
;

577 
boŸm≠_size
 = 
	`boŸmem_boŸm≠_∑ges
(
íd_p‚
)<<
PAGE_SHIFT
;

578 
boŸm≠
 = 
	`föd_e820_¨ó
(0, 
íd_p‚
<<
PAGE_SHIFT
, 
boŸm≠_size
,

579 
PAGE_SIZE
);

580 i‡(
boŸm≠
 == -1L)

581 
	`∑nic
("C™nŸ föd boŸmem m≠ o‡sizê%ld\n", 
boŸm≠_size
);

583 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(0), 
boŸm≠
 >> 
PAGE_SHIFT
,

584 0, 
íd_p‚
);

585 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

586 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(0, 
íd_p‚
);

587 
	`óæy_ªs_to_boŸmem
(0, 
íd_p‚
<<
PAGE_SHIFT
);

588 
	`ª£rve_boŸmem
(
boŸm≠
, 
boŸm≠_size
, 
BOOTMEM_DEFAULT
);

589 
	}
}

592 
__öô
 
	$∑gög_öô
()

594 
max_z⁄e_p‚s
[
MAX_NR_ZONES
];

596 
	`mem£t
(
max_z⁄e_p‚s
, 0, (max_zone_pfns));

597 
max_z⁄e_p‚s
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

598 
max_z⁄e_p‚s
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

599 
max_z⁄e_p‚s
[
ZONE_NORMAL
] = 
max_p‚
;

601 
	`•¨£_mem‹y_¥e£¡_wôh_a˘ive_ªgi⁄s
(
MAX_NUMNODES
);

602 
	`•¨£_öô
();

610 
	`node_˛ór_°©e
(0, 
N_NORMAL_MEMORY
);

612 
	`‰ì_¨ó_öô_nodes
(
max_z⁄e_p‚s
);

613 
	}
}

618 #ifde‡
CONFIG_MEMORY_HOTPLUG


623 
	$upd©e_íd_of_mem‹y_v¨s
(
u64
 
°¨t
, u64 
size
)

625 
íd_p‚
 = 
	`PFN_UP
(
°¨t
 + 
size
);

627 i‡(
íd_p‚
 > 
max_p‚
) {

628 
max_p‚
 = 
íd_p‚
;

629 
max_low_p‚
 = 
íd_p‚
;

630 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

632 
	}
}

638 
	$¨ch_add_mem‹y
(
nid
, 
u64
 
°¨t
, u64 
size
)

640 
pgli°_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

641 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
ZONE_NORMAL
;

642 
œ°_m≠≥d_p‚
, 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

643 
ƒ_∑ges
 = 
size
 >> 
PAGE_SHIFT
;

644 
ªt
;

646 
œ°_m≠≥d_p‚
 = 
	`öô_mem‹y_m≠pög
(
°¨t
, sèπ + 
size
);

647 i‡(
œ°_m≠≥d_p‚
 > 
max_p‚_m≠≥d
)

648 
max_p‚_m≠≥d
 = 
œ°_m≠≥d_p‚
;

650 
ªt
 = 
	`__add_∑ges
(
nid
, 
z⁄e
, 
°¨t_p‚
, 
ƒ_∑ges
);

651 
	`WARN_ON_ONCE
(
ªt
);

654 
	`upd©e_íd_of_mem‹y_v¨s
(
°¨t
, 
size
);

656  
ªt
;

657 
	}
}

658 
EXPORT_SYMBOL_GPL
(
¨ch_add_mem‹y
);

660 #i‡!
deföed
(
CONFIG_ACPI_NUMA
Ë&& deföed(
CONFIG_NUMA
)

661 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

664 
	}
}

665 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

670 
kc‹e_li°
 
	gkc‹e_vsysˇŒ
;

672 
__öô
 
	$mem_öô
()

674 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
;

675 
ab£¡_∑ges
;

677 
	`pci_iommu_Æloc
();

681 
ª£rved∑ges
 = 0;

684 #ifde‡
CONFIG_NUMA


685 
tŸÆøm_∑ges
 = 
	`numa_‰ì_Æl_boŸmem
();

687 
tŸÆøm_∑ges
 = 
	`‰ì_Æl_boŸmem
();

690 
ab£¡_∑ges
 = 
	`ab£¡_∑ges_ö_ønge
(0, 
max_p‚
);

691 
ª£rved∑ges
 = 
max_p‚
 - 
tŸÆøm_∑ges
 - 
ab£¡_∑ges
;

692 
a·î_boŸmem
 = 1;

694 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

695 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_ëext
;

696 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

699 
	`k˛i°_add
(&
kc‹e_vsysˇŒ
, (*)
VSYSCALL_START
,

700 
VSYSCALL_END
 - 
VSYSCALL_START
, 
KCORE_OTHER
);

702 
	`¥ötk
(
KERN_INFO
 "Memory: %luk/%lukávailable (%ldk kernel code, "

704 
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

705 
max_p‚
 << (
PAGE_SHIFT
-10),

706 
codesize
 >> 10,

707 
ab£¡_∑ges
 << (
PAGE_SHIFT
-10),

708 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

709 
d©asize
 >> 10,

710 
öôsize
 >> 10);

711 
	}
}

713 #ifde‡
CONFIG_DEBUG_RODATA


714 c⁄° 
	grod©a_ã°_d©a
 = 0xC3;

715 
EXPORT_SYMBOL_GPL
(
rod©a_ã°_d©a
);

717 
	gkî√l_£t_to_ªad⁄ly
;

719 
	$£t_kî√l_ãxt_rw
()

721 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

722 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

724 i‡(!
kî√l_£t_to_ªad⁄ly
)

727 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead write\n",

728 
°¨t
, 
íd
);

735 
	`£t_mem‹y_rw
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

736 
	}
}

738 
	$£t_kî√l_ãxt_ro
()

740 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

741 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

743 i‡(!
kî√l_£t_to_ªad⁄ly
)

746 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead only\n",

747 
°¨t
, 
íd
);

752 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

753 
	}
}

755 
	$m¨k_rod©a_ro
()

757 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

758 
rod©a_°¨t
 =

759 (()
__°¨t_rod©a
 + 
PAGE_SIZE
 - 1Ë& 
PAGE_MASK
;

760 
íd
 = (Ë&
__íd_rod©a_h∑ge_Æign
;

761 
ãxt_íd
 = 
	`PAGE_ALIGN
((Ë&
__°›___ex_èbÀ
);

762 
rod©a_íd
 = 
	`PAGE_ALIGN
((Ë&
__íd_rod©a
);

763 
d©a_°¨t
 = (Ë&
_sd©a
;

765 
	`¥ötk
(
KERN_INFO
 "WriteÖrotectingÅhe kernelÑead-only data: %luk\n",

766 (
íd
 - 
°¨t
) >> 10);

767 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

769 
kî√l_£t_to_ªad⁄ly
 = 1;

775 
	`£t_mem‹y_nx
(
rod©a_°¨t
, (
íd
 -Ñod©a_°¨tË>> 
PAGE_SHIFT
);

777 
	`rod©a_ã°
();

779 #ifde‡
CONFIG_CPA_DEBUG


780 
	`¥ötk
(
KERN_INFO
 "Te°ög CPA: undÿ%lx-%lx\n", 
°¨t
, 
íd
);

781 
	`£t_mem‹y_rw
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

783 
	`¥ötk
(
KERN_INFO
 "Testing CPA:ágain\n");

784 
	`£t_mem‹y_ro
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

787 
	`‰ì_öô_∑ges
("unused kernel memory",

788 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
ãxt_íd
)),

790 
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_°¨t
)));

791 
	`‰ì_öô_∑ges
("unused kernel memory",

792 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_íd
)),

793 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
d©a_°¨t
)));

794 
	}
}

798 
__öô
 
	$ª£rve_boŸmem_gíîic
(
phys
, 
Àn
,

799 
Êags
)

801 #ifde‡
CONFIG_NUMA


802 
nid
, 
√xt_nid
;

803 
ªt
;

805 
p‚
 = 
phys
 >> 
PAGE_SHIFT
;

807 i‡(
p‚
 >
max_p‚
) {

812 i‡(
p‚
 < 
max_p‚_m≠≥d
)

813  -
EFAULT
;

815 
	`¥ötk
(
KERN_ERR
 "reserve_bootmem: illegalÑeserve %lx %lu\n",

816 
phys
, 
Àn
);

817  -
EFAULT
;

821 #ifde‡
CONFIG_NUMA


822 
nid
 = 
	`phys_to_nid
(
phys
);

823 
√xt_nid
 = 
	`phys_to_nid
(
phys
 + 
Àn
 - 1);

824 i‡(
nid
 =
√xt_nid
)

825 
ªt
 = 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Àn
, 
Êags
);

827 
ªt
 = 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

829 i‡(
ªt
 != 0)

830  
ªt
;

833 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

836 i‡(
phys
+
Àn
 <
MAX_DMA_PFN
*
PAGE_SIZE
) {

837 
dma_ª£rve
 +
Àn
 / 
PAGE_SIZE
;

838 
	`£t_dma_ª£rve
(
dma_ª£rve
);

842 
	}
}

844 
	$kîn_addr_vÆid
(
addr
)

846 
above
 = (()
addr
Ë>> 
__VIRTUAL_MASK_SHIFT
;

847 
pgd_t
 *
pgd
;

848 
pud_t
 *
pud
;

849 
pmd_t
 *
pmd
;

850 
±e_t
 *
±e
;

852 i‡(
above
 != 0 &&ábove != -1UL)

855 
pgd
 = 
	`pgd_off£t_k
(
addr
);

856 i‡(
	`pgd_n⁄e
(*
pgd
))

859 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

860 i‡(
	`pud_n⁄e
(*
pud
))

863 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

864 i‡(
	`pmd_n⁄e
(*
pmd
))

867 i‡(
	`pmd_œrge
(*
pmd
))

868  
	`p‚_vÆid
(
	`pmd_p‚
(*
pmd
));

870 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addr
);

871 i‡(
	`±e_n⁄e
(*
±e
))

874  
	`p‚_vÆid
(
	`±e_p‚
(*
±e
));

875 
	}
}

882 
vm_¨ó_°ru˘
 
	gg©e_vma
 = {

883 .
vm_°¨t
 = 
VSYSCALL_START
,

884 .
	gvm_íd
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

885 .
	gvm_∑ge_¥Ÿ
 = 
PAGE_READONLY_EXEC
,

886 .
	gvm_Êags
 = 
VM_READ
 | 
VM_EXEC


889 
vm_¨ó_°ru˘
 *
	$gë_g©e_vma
(
èsk_°ru˘
 *
tsk
)

891 #ifde‡
CONFIG_IA32_EMULATION


892 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
))

893  
NULL
;

895  &
g©e_vma
;

896 
	}
}

898 
	$ö_g©e_¨ó
(
èsk_°ru˘
 *
èsk
, 
addr
)

900 
vm_¨ó_°ru˘
 *
vma
 = 
	`gë_g©e_vma
(
èsk
);

902 i‡(!
vma
)

905  (
addr
 >
vma
->
vm_°¨t
Ë&& (add∏< vma->
vm_íd
);

906 
	}
}

913 
	$ö_g©e_¨ó_no_èsk
(
addr
)

915  (
addr
 >
VSYSCALL_START
Ë&& (add∏< 
VSYSCALL_END
);

916 
	}
}

918 c⁄° *
	$¨ch_vma_«me
(
vm_¨ó_°ru˘
 *
vma
)

920 i‡(
vma
->
vm_mm
 && vma->
vm_°¨t
 =()vma->vm_mm->
c⁄ãxt
.
vdso
)

922 i‡(
vma
 =&
g©e_vma
)

924  
NULL
;

925 
	}
}

927 #ifde‡
CONFIG_SPARSEMEM_VMEMMAP


931 
__memöôd©a
 
	gaddr_°¨t
, 
	gaddr_íd
;

932 
__memöôd©a
 *
	gp_°¨t
, *
	gp_íd
;

933 
__memöôd©a
 
	gnode_°¨t
;

935 
__memöô


936 
	$vmemm≠_p›uœã
(
∑ge
 *
°¨t_∑ge
, 
size
, 
node
)

938 
addr
 = ()
°¨t_∑ge
;

939 
íd
 = ()(
°¨t_∑ge
 + 
size
);

940 
√xt
;

941 
pgd_t
 *
pgd
;

942 
pud_t
 *
pud
;

943 
pmd_t
 *
pmd
;

945 ; 
addr
 < 
íd
;ádd∏
√xt
) {

946 *
p
 = 
NULL
;

948 
pgd
 = 
	`vmemm≠_pgd_p›uœã
(
addr
, 
node
);

949 i‡(!
pgd
)

950  -
ENOMEM
;

952 
pud
 = 
	`vmemm≠_pud_p›uœã
(
pgd
, 
addr
, 
node
);

953 i‡(!
pud
)

954  -
ENOMEM
;

956 i‡(!
˝u_has_p£
) {

957 
√xt
 = (
addr
 + 
PAGE_SIZE
Ë& 
PAGE_MASK
;

958 
pmd
 = 
	`vmemm≠_pmd_p›uœã
(
pud
, 
addr
, 
node
);

960 i‡(!
pmd
)

961  -
ENOMEM
;

963 
p
 = 
	`vmemm≠_±e_p›uœã
(
pmd
, 
addr
, 
node
);

965 i‡(!
p
)

966  -
ENOMEM
;

968 
addr_íd
 = 
addr
 + 
PAGE_SIZE
;

969 
p_íd
 = 
p
 + 
PAGE_SIZE
;

971 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

973 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

974 i‡(
	`pmd_n⁄e
(*
pmd
)) {

975 
±e_t
 
íåy
;

977 
p
 = 
	`vmemm≠_Æloc_block
(
PMD_SIZE
, 
node
);

978 i‡(!
p
)

979  -
ENOMEM
;

981 
íåy
 = 
	`p‚_±e
(
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

982 
PAGE_KERNEL_LARGE
);

983 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_vÆ
(
íåy
)));

986 i‡(
p_íd
 !
p
 || 
node_°¨t
 !
node
) {

987 i‡(
p_°¨t
)

988 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

989 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

990 
addr_°¨t
 = 
addr
;

991 
node_°¨t
 = 
node
;

992 
p_°¨t
 = 
p
;

995 
addr_íd
 = 
addr
 + 
PMD_SIZE
;

996 
p_íd
 = 
p
 + 
PMD_SIZE
;

998 
	`vmemm≠_vîify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
√xt
);

1003 
	}
}

1005 
__memöô
 
	$vmemm≠_p›uœã_¥öt_œ°
()

1007 i‡(
p_°¨t
) {

1008 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

1009 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

1010 
p_°¨t
 = 
NULL
;

1011 
p_íd
 = 
NULL
;

1012 
node_°¨t
 = 0;

1014 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<löux/boŸmem.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/io.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/mmiŸø˚.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm≠.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/∑t.h
>

25 
	~"phyßddr.h
"

27 
	$∑ge_is_øm
(
∑gír
)

29 
ªsour˚_size_t
 
addr
, 
íd
;

30 
i
;

37 i‡(
∑gír
 == 0)

44 i‡(
∑gír
 >(
BIOS_BEGIN
 >> 
PAGE_SHIFT
) &&

45 
∑gír
 < (
BIOS_END
 >> 
PAGE_SHIFT
))

48 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RAM
)

54 
addr
 = (
e820
.
m≠
[
i
].add∏+ 
PAGE_SIZE
-1Ë>> 
PAGE_SHIFT
;

55 
íd
 = (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
Ë>> 
PAGE_SHIFT
;

58 i‡((
∑gír
 >
addr
Ë&& (∑gí∏< 
íd
))

62 
	}
}

68 
	$i‹em≠_ch™ge_©å
(
vaddr
, 
size
,

69 
¥Ÿ_vÆ
)

71 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

72 
îr
;

74 
¥Ÿ_vÆ
) {

75 
_PAGE_CACHE_UC
:

77 
îr
 = 
	`_£t_mem‹y_uc
(
vaddr
, 
ƒ∑ges
);

79 
_PAGE_CACHE_WC
:

80 
îr
 = 
	`_£t_mem‹y_wc
(
vaddr
, 
ƒ∑ges
);

82 
_PAGE_CACHE_WB
:

83 
îr
 = 
	`_£t_mem‹y_wb
(
vaddr
, 
ƒ∑ges
);

87  
îr
;

88 
	}
}

99 
__iomem
 *
	$__i‹em≠_ˇŒî
(
ªsour˚_size_t
 
phys_addr
,

100 
size
, 
¥Ÿ_vÆ
, *
ˇŒî
)

102 
p‚
, 
off£t
, 
vaddr
;

103 
ªsour˚_size_t
 
œ°_addr
;

104 c⁄° 
ªsour˚_size_t
 
u«lig√d_phys_addr
 = 
phys_addr
;

105 c⁄° 
u«lig√d_size
 = 
size
;

106 
vm_°ru˘
 *
¨ó
;

107 
√w_¥Ÿ_vÆ
;

108 
pg¥Ÿ_t
 
¥Ÿ
;

109 
ªtvÆ
;

110 
__iomem
 *
ªt_addr
;

113 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

114 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
)

115  
NULL
;

117 i‡(!
	`phys_addr_vÆid
(
phys_addr
)) {

118 
	`¥ötk
(
KERN_WARNING
 "ioremap: invalidÖhysicaláddress %llx\n",

119 ()
phys_addr
);

120 
	`WARN_ON_ONCE
(1);

121  
NULL
;

127 i‡(
	`is_ISA_ønge
(
phys_addr
, 
œ°_addr
))

128  (
__f‹˚
 
__iomem
 *)
	`phys_to_vút
(
phys_addr
);

134 
	`WARN_ONCE
(
	`iomem_m≠_ßnôy_check
(
phys_addr
, 
size
),

135 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

140 
p‚
 = 
phys_addr
 >> 
PAGE_SHIFT
;

141 (
p‚
 << 
PAGE_SHIFT
Ë< (
œ°_addr
 & 
PAGE_MASK
);

142 
p‚
++) {

144 
is_øm
 = 
	`∑ge_is_øm
(
p‚
);

146 i‡(
is_øm
 && 
	`p‚_vÆid
(
p‚
Ë&& !
	`PageRe£rved
(
	`p‚_to_∑ge
(pfn)))

147  
NULL
;

148 
	`WARN_ON_ONCE
(
is_øm
);

154 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

155 
phys_addr
 &
PAGE_MASK
;

156 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
+1Ë- 
phys_addr
;

158 
ªtvÆ
 = 
	`ª£rve_memty≥
(
phys_addr
, (
u64
Ìhys_add∏+ 
size
,

159 
¥Ÿ_vÆ
, &
√w_¥Ÿ_vÆ
);

160 i‡(
ªtvÆ
) {

161 
	`¥ötk
(
KERN_ERR
 "i‹em≠Ñe£rve_memty≥ faûed %d\n", 
ªtvÆ
);

162  
NULL
;

165 i‡(
¥Ÿ_vÆ
 !
√w_¥Ÿ_vÆ
) {

166 i‡(!
	`is_√w_memty≥_Ælowed
(
phys_addr
, 
size
,

167 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
)) {

168 
	`¥ötk
(
KERN_ERR


170 ()
phys_addr
,

171 ()(
phys_addr
 + 
size
),

172 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
);

173 
îr_‰ì_memty≥
;

175 
¥Ÿ_vÆ
 = 
√w_¥Ÿ_vÆ
;

178 
¥Ÿ_vÆ
) {

179 
_PAGE_CACHE_UC
:

181 
¥Ÿ
 = 
PAGE_KERNEL_IO_NOCACHE
;

183 
_PAGE_CACHE_UC_MINUS
:

184 
¥Ÿ
 = 
PAGE_KERNEL_IO_UC_MINUS
;

186 
_PAGE_CACHE_WC
:

187 
¥Ÿ
 = 
PAGE_KERNEL_IO_WC
;

189 
_PAGE_CACHE_WB
:

190 
¥Ÿ
 = 
PAGE_KERNEL_IO
;

197 
¨ó
 = 
	`gë_vm_¨ó_ˇŒî
(
size
, 
VM_IOREMAP
, 
ˇŒî
);

198 i‡(!
¨ó
)

199 
îr_‰ì_memty≥
;

200 
¨ó
->
phys_addr
 =Öhys_addr;

201 
vaddr
 = (Ë
¨ó
->
addr
;

203 i‡(
	`kî√l_m≠_sync_memty≥
(
phys_addr
, 
size
, 
¥Ÿ_vÆ
))

204 
îr_‰ì_¨ó
;

206 i‡(
	`i‹em≠_∑ge_ønge
(
vaddr
, vadd∏+ 
size
, 
phys_addr
, 
¥Ÿ
))

207 
îr_‰ì_¨ó
;

209 
ªt_addr
 = (
__iomem
 *Ë(
vaddr
 + 
off£t
);

210 
	`mmiŸø˚_i‹em≠
(
u«lig√d_phys_addr
, 
u«lig√d_size
, 
ªt_addr
);

212  
ªt_addr
;

213 
îr_‰ì_¨ó
:

214 
	`‰ì_vm_¨ó
(
¨ó
);

215 
îr_‰ì_memty≥
:

216 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

217  
NULL
;

218 
	}
}

241 
__iomem
 *
	$i‹em≠_noˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

250 
vÆ
 = 
_PAGE_CACHE_UC_MINUS
;

252  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
vÆ
,

253 
	`__buûtö_ªtu∫_addªss
(0));

254 
	}
}

255 
EXPORT_SYMBOL
(
i‹em≠_noˇche
);

267 
__iomem
 *
	$i‹em≠_wc
(
ªsour˚_size_t
 
phys_addr
, 
size
)

269 i‡(
∑t_íabÀd
)

270  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

271 
	`__buûtö_ªtu∫_addªss
(0));

273  
	`i‹em≠_noˇche
(
phys_addr
, 
size
);

274 
	}
}

275 
EXPORT_SYMBOL
(
i‹em≠_wc
);

277 
__iomem
 *
	$i‹em≠_ˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

279  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

280 
	`__buûtö_ªtu∫_addªss
(0));

281 
	}
}

282 
EXPORT_SYMBOL
(
i‹em≠_ˇche
);

284 
__iomem
 *
	$i‹em≠_¥Ÿ
(
ªsour˚_size_t
 
phys_addr
, 
size
,

285 
¥Ÿ_vÆ
)

287  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, (
¥Ÿ_vÆ
 & 
_PAGE_CACHE_MASK
),

288 
	`__buûtö_ªtu∫_addªss
(0));

289 
	}
}

290 
EXPORT_SYMBOL
(
i‹em≠_¥Ÿ
);

298 
	$iounm≠
(vﬁ©ûê
__iomem
 *
addr
)

300 
vm_°ru˘
 *
p
, *
o
;

302 i‡((
__f‹˚
 *)
addr
 <
high_mem‹y
)

310 i‡((
__f‹˚
 *)
addr
 >
	`phys_to_vút
(
ISA_START_ADDRESS
) &&

311 (
__f‹˚
 *)
addr
 < 
	`phys_to_vút
(
ISA_END_ADDRESS
))

314 
addr
 = (vﬁ©ûê
__iomem
 *)

315 (
PAGE_MASK
 & (
__f‹˚
)
addr
);

317 
	`mmiŸø˚_iounm≠
(
addr
);

324 
	`ªad_lock
(&
vmli°_lock
);

325 
p
 = 
vmli°
;Ö;Ö =Ö->
√xt
) {

326 i‡(
p
->
addr
 =(
__f‹˚
 *)addr)

329 
	`ªad_u∆ock
(&
vmli°_lock
);

331 i‡(!
p
) {

332 
	`¥ötk
(
KERN_ERR
 "iounm≠: badáddªs†%p\n", 
addr
);

333 
	`dump_°ack
();

337 
	`‰ì_memty≥
(
p
->
phys_addr
,Ö->phys_add∏+ 
	`gë_vm_¨ó_size
(p));

340 
o
 = 
	`ªmove_vm_¨ó
((
__f‹˚
 *)
addr
);

341 
	`BUG_ON
(
p
 !
o
 || o =
NULL
);

342 
	`k‰ì
(
p
);

343 
	}
}

344 
EXPORT_SYMBOL
(
iounm≠
);

350 *
	$xœã_dev_mem_±r
(
phys
)

352 *
addr
;

353 
°¨t
 = 
phys
 & 
PAGE_MASK
;

356 i‡(
	`∑ge_is_øm
(
°¨t
 >> 
PAGE_SHIFT
))

357  
	`__va
(
phys
);

359 
addr
 = (
__f‹˚
 *)
	`i‹em≠_ˇche
(
°¨t
, 
PAGE_SIZE
);

360 i‡(
addr
)

361 
addr
 = (*)((Ôdd∏| (
phys
 & ~
PAGE_MASK
));

363  
addr
;

364 
	}
}

366 
	$unxœã_dev_mem_±r
(
phys
, *
addr
)

368 i‡(
	`∑ge_is_øm
(
phys
 >> 
PAGE_SHIFT
))

371 
	`iounm≠
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

373 
	}
}

375 
__öôd©a
 
	góæy_i‹em≠_debug
;

377 
__öô
 
	$óæy_i‹em≠_debug_£tup
(*
°r
)

379 
óæy_i‹em≠_debug
 = 1;

382 
	}
}

383 
óæy_∑øm
("óæy_i‹em≠_debug", 
óæy_i‹em≠_debug_£tup
);

385 
__öôd©a
 
	ga·î_∑gög_öô
;

386 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/’ã_t)] 
	g__∑ge_Æig√d_bss
;

388 
ölöe
 
pmd_t
 * 
__öô
 
	$óæy_i‹em≠_pmd
(
addr
)

391 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

392 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addr
)];

393 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

394 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

396  
pmd
;

397 
	}
}

399 
ölöe
 
±e_t
 * 
__öô
 
	$óæy_i‹em≠_±e
(
addr
)

401  &
bm_±e
[
	`±e_ödex
(
addr
)];

402 
	}
}

404 
	g¶Ÿ_vút
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

406 
__öô
 
	$óæy_i‹em≠_öô
()

408 
pmd_t
 *
pmd
;

409 
i
;

411 i‡(
óæy_i‹em≠_debug
)

412 
	`¥ötk
(
KERN_INFO
 "early_ioremap_init()\n");

414 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

415 
¶Ÿ_vút
[
i
] = 
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

417 
pmd
 = 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

418 
	`mem£t
(
bm_±e
, 0, (bm_pte));

419 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
bm_±e
);

425 i‡(
pmd
 !
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
))) {

426 
	`WARN_ON
(1);

427 
	`¥ötk
(
KERN_WARNING
 "pmd %p != %p\n",

428 
pmd
, 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
)));

429 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

430 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

431 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

432 
	`fix_to_vút
(
FIX_BTMAP_END
));

434 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

435 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

436 
FIX_BTMAP_BEGIN
);

438 
	}
}

440 
__öô
 
	$óæy_i‹em≠_ª£t
()

442 
a·î_∑gög_öô
 = 1;

443 
	}
}

445 
__öô
 
	$__óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

446 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
Êags
)

448 
addr
 = 
	`__fix_to_vút
(
idx
);

449 
±e_t
 *
±e
;

451 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

452 
	`BUG
();

455 
±e
 = 
	`óæy_i‹em≠_±e
(
addr
);

457 i‡(
	`pg¥Ÿ_vÆ
(
Êags
))

458 
	`£t_±e
(
±e
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

460 
	`±e_˛ór
(&
öô_mm
, 
addr
, 
±e
);

461 
	`__Êush_éb_⁄e
(
addr
);

462 
	}
}

464 
ölöe
 
__öô
 
	$óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

465 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
¥Ÿ
)

467 i‡(
a·î_∑gög_öô
)

468 
	`__£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

470 
	`__óæy_£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

471 
	}
}

473 
ölöe
 
__öô
 
	$óæy_˛ór_fixm≠
(
fixed_addªs£s
 
idx
)

475 i‡(
a·î_∑gög_öô
)

476 
	`˛ór_fixm≠
(
idx
);

478 
	`__óæy_£t_fixm≠
(
idx
, 0, 
	`__pg¥Ÿ
(0));

479 
	}
}

481 
__iomem
 *
	g¥ev_m≠
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

482 
	g¥ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

484 
__öô
 
	$check_óæy_i‹em≠_Àak
()

486 
cou¡
 = 0;

487 
i
;

489 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

490 i‡(
¥ev_m≠
[
i
])

491 
cou¡
++;

493 i‡(!
cou¡
)

495 
	`WARN
(1, 
KERN_WARNING


497 
cou¡
);

498 
	`¥ötk
(
KERN_WARNING


502 
	}
}

503 
œã_öôˇŒ
(
check_óæy_i‹em≠_Àak
);

505 
__öô
 
__iomem
 *

506 
	$__óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
, 
pg¥Ÿ_t
 
¥Ÿ
)

508 
off£t
;

509 
ªsour˚_size_t
 
œ°_addr
;

510 
ƒ∑ges
;

511 
fixed_addªs£s
 
idx0
, 
idx
;

512 
i
, 
¶Ÿ
;

514 
	`WARN_ON
(
sy°em_°©e
 !
SYSTEM_BOOTING
);

516 
¶Ÿ
 = -1;

517 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

518 i‡(!
¥ev_m≠
[
i
]) {

519 
¶Ÿ
 = 
i
;

524 i‡(
¶Ÿ
 < 0) {

525 
	`¥ötk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)Çot found slot\n",

526 (
u64
)
phys_addr
, 
size
);

527 
	`WARN_ON
(1);

528  
NULL
;

531 i‡(
óæy_i‹em≠_debug
) {

532 
	`¥ötk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

533 (
u64
)
phys_addr
, 
size
, 
¶Ÿ
);

534 
	`dump_°ack
();

538 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

539 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
) {

540 
	`WARN_ON
(1);

541  
NULL
;

544 
¥ev_size
[
¶Ÿ
] = 
size
;

548 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

549 
phys_addr
 &
PAGE_MASK
;

550 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
 + 1Ë- 
phys_addr
;

555 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

556 i‡(
ƒ∑ges
 > 
NR_FIX_BTMAPS
) {

557 
	`WARN_ON
(1);

558  
NULL
;

564 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

565 
idx
 = 
idx0
;

566 
ƒ∑ges
 > 0) {

567 
	`óæy_£t_fixm≠
(
idx
, 
phys_addr
, 
¥Ÿ
);

568 
phys_addr
 +
PAGE_SIZE
;

569 --
idx
;

570 --
ƒ∑ges
;

572 i‡(
óæy_i‹em≠_debug
)

573 
	`¥ötk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¶Ÿ_vút
[
¶Ÿ
]);

575 
¥ev_m≠
[
¶Ÿ
] = (
__iomem
 *)(
off£t
 + 
¶Ÿ_vút
[slot]);

576  
¥ev_m≠
[
¶Ÿ
];

577 
	}
}

580 
__öô
 
__iomem
 *

581 
	$óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

583  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

584 
	}
}

587 
__öô
 
__iomem
 *

588 
	$óæy_memªm≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

590  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

591 
	}
}

593 
__öô
 
	$óæy_iounm≠
(
__iomem
 *
addr
, 
size
)

595 
vút_addr
;

596 
off£t
;

597 
ƒ∑ges
;

598 
fixed_addªs£s
 
idx
;

599 
i
, 
¶Ÿ
;

601 
¶Ÿ
 = -1;

602 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

603 i‡(
¥ev_m≠
[
i
] =
addr
) {

604 
¶Ÿ
 = 
i
;

609 i‡(
¶Ÿ
 < 0) {

610 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx)Çot found slot\n",

611 
addr
, 
size
);

612 
	`WARN_ON
(1);

616 i‡(
¥ev_size
[
¶Ÿ
] !
size
) {

617 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] sizeÇot consistent %08lx\n",

618 
addr
, 
size
, 
¶Ÿ
, 
¥ev_size
[slot]);

619 
	`WARN_ON
(1);

623 i‡(
óæy_i‹em≠_debug
) {

624 
	`¥ötk
(
KERN_INFO
 "óæy_iounm≠(%p, %08lxË[%d]\n", 
addr
,

625 
size
, 
¶Ÿ
);

626 
	`dump_°ack
();

629 
vút_addr
 = ()
addr
;

630 i‡(
vút_addr
 < 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
)) {

631 
	`WARN_ON
(1);

634 
off£t
 = 
vút_addr
 & ~
PAGE_MASK
;

635 
ƒ∑ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1Ë>> 
PAGE_SHIFT
;

637 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

638 
ƒ∑ges
 > 0) {

639 
	`óæy_˛ór_fixm≠
(
idx
);

640 --
idx
;

641 --
ƒ∑ges
;

643 
¥ev_m≠
[
¶Ÿ
] = 
NULL
;

644 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<löux/pci_ids.h
>

16 
	~<löux/a˝i.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/mmz⁄e.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dúe˘.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/k8.h
>

27 
boŸnode
 
__öôd©a
 
	gnodes
[8];

28 
nodemask_t
 
__öôd©a
 
	gnodes_∑r£d
 = 
NODE_MASK_NONE
;

30 
__öô
 
	$föd_n‹thbridge
()

32 
num
;

34 
num
 = 0;Çum < 32;Çum++) {

35 
u32
 
hódî
;

37 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 0, 0x00);

38 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

39 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

40 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

43 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 1, 0x00);

44 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

45 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

46 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

48  
num
;

52 
	}
}

54 
__öô
 
	$óæy_gë_boŸ_˝u_id
()

60 #ifde‡
CONFIG_X86_MPPARSE


64 i‡(
smp_found_c⁄fig
)

65 
	`óæy_gë_smp_c⁄fig
();

67 
	`óæy_öô_œpic_m≠pög
();

68 
	}
}

70 
__öô
 
	$k8_gë_nodes
(
boŸnode
 *
phy¢odes
)

72 
i
;

73 
ªt
 = 0;

75 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

76 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

77 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

78 
ªt
++;

80  
ªt
;

81 
	}
}

83 
__öô
 
	$k8_numa_öô
(
°¨t_p‚
, 
íd_p‚
)

85 
°¨t
 = 
	`PFN_PHYS
(
°¨t_p‚
);

86 
íd
 = 
	`PFN_PHYS
(
íd_p‚
);

87 
numnodes
;

88 
¥evba£
;

89 
i
, 
nb
, 
found
 = 0;

90 
u32
 
nodeid
, 
ªg
;

92 i‡(!
	`óæy_pci_Ælowed
())

95 
nb
 = 
	`föd_n‹thbridge
();

96 i‡(
nb
 < 0)

97  
nb
;

99 
	`¥_öfo
("Sˇ¬ög NUMAÅ›ﬁogy i¿N‹thbridgê%d\n", 
nb
);

101 
ªg
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 0, 0x60);

102 
numnodes
 = ((
ªg
 >> 4) & 0xF) + 1;

103 i‡(
numnodes
 <= 1)

106 
	`¥_öfo
("Numbî o‡physiˇ»node†%d\n", 
numnodes
);

108 
¥evba£
 = 0;

109 
i
 = 0; i < 8; i++) {

110 
ba£
, 
limô
;

112 
ba£
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x40 + 
i
*8);

113 
limô
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x44 + 
i
*8);

115 
nodeid
 = 
limô
 & 7;

116 i‡((
ba£
 & 3) == 0) {

117 i‡(
i
 < 
numnodes
)

118 
	`¥_öfo
("Skùpög dißbÀdÇodê%d\n", 
i
);

121 i‡(
nodeid
 >
numnodes
) {

122 
	`¥_öfo
("Ign‹ögÉx˚s†nodê%d (%lx:%lx)\n", 
nodeid
,

123 
ba£
, 
limô
);

127 i‡(!
limô
) {

128 
	`¥_öfo
("SkippingÇodeÉntry %d (base %lx)\n",

129 
i
, 
ba£
);

132 i‡((
ba£
 >> 8Ë& 3 || (
limô
 >> 8) & 3) {

133 
	`¥_îr
("Node %d using interleaving mode %lx/%lx\n",

134 
nodeid
, (
ba£
 >> 8Ë& 3, (
limô
 >> 8) & 3);

137 i‡(
	`node_is£t
(
nodeid
, 
nodes_∑r£d
)) {

138 
	`¥_öfo
("Node %dálreadyÖresent, skipping\n",

139 
nodeid
);

143 
limô
 >>= 16;

144 
limô
 <<= 24;

145 
limô
 |= (1<<24)-1;

146 
limô
++;

148 i‡(
limô
 > 
íd
)

149 
limô
 = 
íd
;

150 i‡(
limô
 <
ba£
)

153 
ba£
 >>= 16;

154 
ba£
 <<= 24;

156 i‡(
ba£
 < 
°¨t
)

157 
ba£
 = 
°¨t
;

158 i‡(
limô
 > 
íd
)

159 
limô
 = 
íd
;

160 i‡(
limô
 =
ba£
) {

161 
	`¥_îr
("Em±yÇodê%d\n", 
nodeid
);

164 i‡(
limô
 < 
ba£
) {

165 
	`¥_îr
("Node %d bogus settings %lx-%lx.\n",

166 
nodeid
, 
ba£
, 
limô
);

171 i‡(
¥evba£
 > 
ba£
) {

172 
	`¥_îr
("Node mapÇot sorted %lx,%lx\n",

173 
¥evba£
, 
ba£
);

177 
	`¥_öfo
("Node %d MemBase %016lx Limit %016lx\n",

178 
nodeid
, 
ba£
, 
limô
);

180 
found
++;

182 
nodes
[
nodeid
].
°¨t
 = 
ba£
;

183 
nodes
[
nodeid
].
íd
 = 
limô
;

185 
¥evba£
 = 
ba£
;

187 
	`node_£t
(
nodeid
, 
nodes_∑r£d
);

190 i‡(!
found
)

193 
	}
}

195 
__öô
 
	$k8_sˇn_nodes
()

197 
bôs
;

198 
c‹es
;

199 
≠icid_ba£
;

200 
i
;

202 
	`BUG_ON
(
	`nodes_em±y
(
nodes_∑r£d
));

203 
node_possibÀ_m≠
 = 
nodes_∑r£d
;

204 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 8, 
NULL
);

205 i‡(
memnode_shi·
 < 0) {

206 
	`¥_îr
("No NUMAÇode hash function found. Contact maintainer\n");

209 
	`¥_öfo
("UsögÇodêhash shi· o‡%d\n", 
memnode_shi·
);

212 
bôs
 = 
boŸ_˝u_d©a
.
x86_c‹eid_bôs
;

213 
c‹es
 = (1<<
bôs
);

214 
≠icid_ba£
 = 0;

216 
	`óæy_gë_boŸ_˝u_id
();

217 i‡(
boŸ_˝u_physiˇl_≠icid
 > 0) {

218 
	`¥_öfo
("BSP APIC ID: %02x\n", 
boŸ_˝u_physiˇl_≠icid
);

219 
≠icid_ba£
 = 
boŸ_˝u_physiˇl_≠icid
;

222 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

223 
j
;

225 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
,

226 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
,

227 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

228 
j
 = 
≠icid_ba£
; j < 
c‹es
 +ápicid_base; j++)

229 
≠icid_to_node
[(
i
 << 
bôs
Ë+ 
j
] = i;

230 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

233 
	`numa_öô_¨øy
();

235 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<löux/≥rs⁄Æôy.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/limôs.h
>

31 
	~<löux/sched.h
>

32 
	~<asm/ñf.h
>

34 
	$°ack_maxøndom_size
()

36 
max
 = 0;

37 i‡((
cuºít
->
Êags
 & 
PF_RANDOMIZE
) &&

38 !(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
)) {

39 
max
 = ((-1UË& 
STACK_RND_MASK
Ë<< 
PAGE_SHIFT
;

42  
max
;

43 
	}
}

51 
	#MIN_GAP
 (128*1024*1024UL + 
	`°ack_maxøndom_size
())

	)

52 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

57 
	$mm≠_is_ü32
()

59 #ifde‡
CONFIG_X86_32


62 #ifde‡
CONFIG_IA32_EMULATION


63 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

67 
	}
}

69 
	$mm≠_is_Àgacy
()

71 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_COMPAT_LAYOUT
)

74 i‡(
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
 =
RLIM_INFINITY
)

77  
sys˘l_Àgacy_va_œyout
;

78 
	}
}

80 
	$mm≠_∫d
()

82 
∫d
 = 0;

88 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

89 i‡(
	`mm≠_is_ü32
())

90 
∫d
 = ()
	`gë_øndom_öt
() % (1<<8);

92 
∫d
 = ()(
	`gë_øndom_öt
() % (1<<28));

94  
∫d
 << 
PAGE_SHIFT
;

95 
	}
}

97 
	$mm≠_ba£
()

99 
g≠
 = 
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
;

101 i‡(
g≠
 < 
MIN_GAP
)

102 
g≠
 = 
MIN_GAP
;

103 i‡(
g≠
 > 
MAX_GAP
)

104 
g≠
 = 
MAX_GAP
;

106  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g≠
 - 
	`mm≠_∫d
());

107 
	}
}

113 
	$mm≠_Àgacy_ba£
()

115 i‡(
	`mm≠_is_ü32
())

116  
TASK_UNMAPPED_BASE
;

118  
TASK_UNMAPPED_BASE
 + 
	`mm≠_∫d
();

119 
	}
}

125 
	$¨ch_pick_mm≠_œyout
(
mm_°ru˘
 *
mm
)

127 i‡(
	`mm≠_is_Àgacy
()) {

128 
mm
->
mm≠_ba£
 = 
	`mm≠_Àgacy_ba£
();

129 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó
;

130 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó
;

132 
mm
->
mm≠_ba£
 = 
	`mm≠_ba£
();

133 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó_t›down
;

134 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó_t›down
;

136 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<löux/t›ﬁogy.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/boŸmem.h
>

6 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


7 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

9 
	#DBG
(
x
...)

	)

15 
˝umask_v¨_t
 
	gnode_to_˝umask_m≠
[
MAX_NUMNODES
];

16 
EXPORT_SYMBOL
(
node_to_˝umask_m≠
);

25 
__öô
 
	$£tup_node_to_˝umask_m≠
()

27 
node
, 
num
 = 0;

30 i‡(
ƒ_node_ids
 =
MAX_NUMNODES
) {

31 
	`f‹_óch_node_mask
(
node
, 
node_possibÀ_m≠
)

32 
num
 = 
node
;

33 
ƒ_node_ids
 = 
num
 + 1;

37 
node
 = 0;Çodê< 
ƒ_node_ids
;Çode++)

38 
	`Æloc_boŸmem_˝umask_v¨
(&
node_to_˝umask_m≠
[
node
]);

41 
	`¥_debug
("Nodêtÿ˝umask m≠ f‹ %dÇodes\n", 
ƒ_node_ids
);

42 
	}
}

44 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


48 c⁄° 
˝umask
 *
	$˝umask_of_node
(
node
)

50 i‡(
node
 >
ƒ_node_ids
) {

51 
	`¥ötk
(
KERN_WARNING


53 
node
, 
ƒ_node_ids
);

54 
	`dump_°ack
();

55  
˝u_n⁄e_mask
;

57 i‡(
node_to_˝umask_m≠
[
node
] =
NULL
) {

58 
	`¥ötk
(
KERN_WARNING


60 
node
);

61 
	`dump_°ack
();

62  
˝u_⁄löe_mask
;

64  
node_to_˝umask_m≠
[
node
];

65 
	}
}

66 
EXPORT_SYMBOL
(
˝umask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/mmz⁄e.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/a˝i.h
>

21 
	~<asm/k8.h
>

23 
pgli°_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__ªad_mo°ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__˝uöôd©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__öôd©a
;

33 
__öôd©a
 
	gnodem≠_addr
;

34 
__öôd©a
 
	gnodem≠_size
;

36 
DEFINE_PER_CPU
(, 
node_numbî
) = 0;

37 
EXPORT_PER_CPU_SYMBOL
(
node_numbî
);

42 
DEFINE_EARLY_PER_CPU
(, 
x86_˝u_to_node_m≠
, 
NUMA_NO_NODE
);

43 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_node_m≠
);

52 
__öô
 
	$p›uœã_memnodem≠
(c⁄° 
boŸnode
 *
nodes
,

53 
numnodes
, 
shi·
, *
nodeids
)

55 
addr
, 
íd
;

56 
i
, 
ªs
 = -1;

58 
	`mem£t
(
memnodem≠
, 0xff, (
s16
)*
memnodem≠size
);

59 
i
 = 0; i < 
numnodes
; i++) {

60 
addr
 = 
nodes
[
i
].
°¨t
;

61 
íd
 = 
nodes
[
i
].end;

62 i‡(
addr
 >
íd
)

64 i‡((
íd
 >> 
shi·
Ë>
memnodem≠size
)

67 i‡(
memnodem≠
[
addr
 >> 
shi·
] !
NUMA_NO_NODE
)

70 i‡(!
nodeids
)

71 
memnodem≠
[
addr
 >> 
shi·
] = 
i
;

73 
memnodem≠
[
addr
 >> 
shi·
] = 
nodeids
[
i
];

75 
addr
 +(1UL << 
shi·
);

76 } 
addr
 < 
íd
);

77 
ªs
 = 1;

79  
ªs
;

80 
	}
}

82 
__öô
 
	$Æloˇã_ˇchólig√d_memnodem≠
()

84 
addr
;

86 
memnodem≠
 = 
memnode
.
embedded_m≠
;

87 i‡(
memnodem≠size
 <
	`ARRAY_SIZE
(
memnode
.
embedded_m≠
))

90 
addr
 = 0x8000;

91 
nodem≠_size
 = 
	`roundup
((
s16
Ë* 
memnodem≠size
, 
L1_CACHE_BYTES
);

92 
nodem≠_addr
 = 
	`föd_e820_¨ó
(
addr
, 
max_p‚
<<
PAGE_SHIFT
,

93 
nodem≠_size
, 
L1_CACHE_BYTES
);

94 i‡(
nodem≠_addr
 == -1UL) {

95 
	`¥ötk
(
KERN_ERR


97 
nodem≠_addr
 = 
nodem≠_size
 = 0;

100 
memnodem≠
 = 
	`phys_to_vút
(
nodem≠_addr
);

101 
	`ª£rve_óæy
(
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
, "MEMNODEMAP");

103 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

104 
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
);

106 
	}
}

112 
__öô
 
	$exåa˘_lsb_‰om_nodes
(c⁄° 
boŸnode
 *
nodes
,

113 
numnodes
)

115 
i
, 
nodes_u£d
 = 0;

116 
°¨t
, 
íd
;

117 
bôfõld
 = 0, 
memt›
 = 0;

119 
i
 = 0; i < 
numnodes
; i++) {

120 
°¨t
 = 
nodes
[
i
].start;

121 
íd
 = 
nodes
[
i
].end;

122 i‡(
°¨t
 >
íd
)

124 
bôfõld
 |
°¨t
;

125 
nodes_u£d
++;

126 i‡(
íd
 > 
memt›
)

127 
memt›
 = 
íd
;

129 i‡(
nodes_u£d
 <= 1)

130 
i
 = 63;

132 
i
 = 
	`föd_fú°_bô
(&
bôfõld
, ()*8);

133 
memnodem≠size
 = (
memt›
 >> 
i
)+1;

134  
i
;

135 
	}
}

137 
__öô
 
	$compuã_hash_shi·
(
boŸnode
 *
nodes
, 
numnodes
,

138 *
nodeids
)

140 
shi·
;

142 
shi·
 = 
	`exåa˘_lsb_‰om_nodes
(
nodes
, 
numnodes
);

143 i‡(
	`Æloˇã_ˇchólig√d_memnodem≠
())

145 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Using %d forÅhe hash shift.\n",

146 
shi·
);

148 i‡(
	`p›uœã_memnodem≠
(
nodes
, 
numnodes
, 
shi·
, 
nodeids
) != 1) {

149 
	`¥ötk
(
KERN_INFO
 "Your memory isÇotáligned youÇeedÅo "

151 "shi·=%d\n", 
shi·
);

154  
shi·
;

155 
	}
}

157 
__memöô
 
	$__óæy_p‚_to_nid
(
p‚
)

159  
	`phys_to_nid
(
p‚
 << 
PAGE_SHIFT
);

160 
	}
}

162 * 
__öô
 
	$óæy_node_mem
(
nodeid
, 
°¨t
,

163 
íd
, 
size
,

164 
Æign
)

166 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

167 *
±r
;

169 i‡(
mem
 != -1L)

170  
	`__va
(
mem
);

172 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
	`__∑
(
MAX_DMA_ADDRESS
));

173 i‡(
±r
 =
NULL
) {

174 
	`¥ötk
(
KERN_ERR
 "Cannot find %lu bytes inÇode %d\n",

175 
size
, 
nodeid
);

176  
NULL
;

178  
±r
;

179 
	}
}

182 
__öô


183 
	$£tup_node_boŸmem
(
nodeid
, 
°¨t
, 
íd
)

185 
°¨t_p‚
, 
œ°_p‚
, 
boŸm≠_∑ges
, 
boŸm≠_size
;

186 c⁄° 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

187 
boŸm≠_°¨t
, 
noded©a_phys
;

188 *
boŸm≠
;

189 
nid
;

191 i‡(!
íd
)

198 i‡(
íd
 && (íd - 
°¨t
Ë< 
NODE_MIN_SIZE
)

201 
°¨t
 = 
	`roundup
(°¨t, 
ZONE_ALIGN
);

203 
	`¥ötk
(
KERN_INFO
 "BoŸmem sëu∞nodê%d %016lx-%016lx\n", 
nodeid
,

204 
°¨t
, 
íd
);

206 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

207 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

209 
node_d©a
[
nodeid
] = 
	`óæy_node_mem
“odeid, 
°¨t
, 
íd
, 
pgd©_size
,

210 
SMP_CACHE_BYTES
);

211 i‡(
node_d©a
[
nodeid
] =
NULL
)

213 
noded©a_phys
 = 
	`__∑
(
node_d©a
[
nodeid
]);

214 
	`¥ötk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

215 
noded©a_phys
 + 
pgd©_size
 - 1);

217 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

218 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boŸmem_node_d©a
[nodeid];

219 
	`NODE_DATA
(
nodeid
)->
node_°¨t_p‚
 = 
°¨t_p‚
;

220 
	`NODE_DATA
(
nodeid
)->
node_•™√d_∑ges
 = 
œ°_p‚
 - 
°¨t_p‚
;

229 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
œ°_p‚
 - 
°¨t_p‚
);

230 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

231 i‡(
nid
 =
nodeid
)

232 
boŸm≠_°¨t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

234 
boŸm≠_°¨t
 = 
	`roundup
(
°¨t
, 
PAGE_SIZE
);

239 
boŸm≠
 = 
	`óæy_node_mem
(
nodeid
, 
boŸm≠_°¨t
, 
íd
,

240 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

241 i‡(
boŸm≠
 =
NULL
) {

242 i‡(
noded©a_phys
 < 
°¨t
 ||Çoded©a_phy†>
íd
) {

247 i‡(
nid
 !
nodeid
)

248 
	`‰ì_boŸmem
(
noded©a_phys
, 
pgd©_size
);

250 
node_d©a
[
nodeid
] = 
NULL
;

253 
boŸm≠_°¨t
 = 
	`__∑
(
boŸm≠
);

255 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nodeid
),

256 
boŸm≠_°¨t
 >> 
PAGE_SHIFT
,

257 
°¨t_p‚
, 
œ°_p‚
);

259 
	`¥ötk
(
KERN_INFO
 " bootmap [%016lx - %016lx]Öages %lx\n",

260 
boŸm≠_°¨t
, boŸm≠_°¨à+ 
boŸm≠_size
 - 1,

261 
boŸm≠_∑ges
);

263 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(
nodeid
, 
íd
);

270 
	`óæy_ªs_to_boŸmem
(
°¨t
, 
íd
);

276 i‡(
nid
 !
nodeid
)

277 
	`¥ötk
(
KERN_INFO
 " NODE_DATA(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

279 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
noded©a_phys
,

280 
pgd©_size
, 
BOOTMEM_DEFAULT
);

281 
nid
 = 
	`phys_to_nid
(
boŸm≠_°¨t
);

282 i‡(
nid
 !
nodeid
)

283 
	`¥ötk
(
KERN_INFO
 " boŸm≠(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

285 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
boŸm≠_°¨t
,

286 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
BOOTMEM_DEFAULT
);

288 
	`node_£t_⁄löe
(
nodeid
);

289 
	}
}

298 
__öô
 
	$numa_öô_¨øy
()

300 
º
, 
i
;

302 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

303 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

304 i‡(
	`óæy_˝u_to_node
(
i
Ë!
NUMA_NO_NODE
)

306 
	`numa_£t_node
(
i
, 
º
);

307 
º
 = 
	`√xt_node
‘r, 
node_⁄löe_m≠
);

308 i‡(
º
 =
MAX_NUMNODES
)

309 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

311 
	}
}

313 #ifde‡
CONFIG_NUMA_EMU


315 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

316 
boŸnode
 
	gphy¢odes
[
MAX_NUMNODES
] 
	g__öôd©a
;

317 *
cmdlöe
 
	g__öôd©a
;

319 
__öô
 
	$£tup_phy¢odes
(
°¨t
, 
íd
,

320 
a˝i
, 
k8
)

322 
ƒ_nodes
 = 0;

323 
ªt
 = 0;

324 
i
;

326 #ifde‡
CONFIG_ACPI_NUMA


327 i‡(
a˝i
)

328 
ƒ_nodes
 = 
	`a˝i_gë_nodes
(
phy¢odes
);

330 #ifde‡
CONFIG_K8_NUMA


331 i‡(
k8
)

332 
ƒ_nodes
 = 
	`k8_gë_nodes
(
phy¢odes
);

339 
i
 = 0; i < 
ƒ_nodes
; i++) {

340 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

342 i‡(
phy¢odes
[
i
].
°¨t
 > 
íd
) {

343 
phy¢odes
[
i
].
íd
 =Öhy¢odes[i].
°¨t
;

346 i‡(
phy¢odes
[
i
].
íd
 < 
°¨t
) {

347 
phy¢odes
[
i
].
°¨t
 =Öhy¢odes[i].
íd
;

350 i‡(
phy¢odes
[
i
].
°¨t
 < start)

351 
phy¢odes
[
i
].
°¨t
 = start;

352 i‡(
phy¢odes
[
i
].
íd
 >Énd)

353 
phy¢odes
[
i
].
íd
 =Énd;

360 
i
 = 0; i < 
ƒ_nodes
; i++) {

361 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

363 
phy¢odes
[
ªt
].
°¨t
 =Öhy¢odes[
i
].start;

364 
phy¢odes
[
ªt
].
íd
 =Öhy¢odes[
i
].end;

365 
ªt
++;

372 i‡(!
ªt
) {

373 
phy¢odes
[
ªt
].
°¨t
 = start;

374 
phy¢odes
[
ªt
].
íd
 =Énd;

375 
ªt
 = 1;

377  
ªt
;

378 
	}
}

387 
__öô
 
	$£tup_node_ønge
(
nid
, 
u64
 *
addr
, u64 
size
, u64 
max_addr
)

389 
ªt
 = 0;

390 
nodes
[
nid
].
°¨t
 = *
addr
;

391 *
addr
 +
size
;

392 i‡(*
addr
 >
max_addr
) {

393 *
addr
 = 
max_addr
;

394 
ªt
 = -1;

396 
nodes
[
nid
].
íd
 = *
addr
;

397 
	`node_£t
(
nid
, 
node_possibÀ_m≠
);

398 
	`¥ötk
(
KERN_INFO
 "FakögÇodê%dáà%016Lx-%016Lx (%LuMB)\n", 
nid
,

399 
nodes
[
nid
].
°¨t
,Çodes[nid].
íd
,

400 (
nodes
[
nid
].
íd
 -Çodes[nid].
°¨t
) >> 20);

401  
ªt
;

402 
	}
}

408 
__öô
 
	$•lô_nodes_öãæóve
(
u64
 
addr
, u64 
max_addr
,

409 
ƒ_phys_nodes
, 
ƒ_nodes
)

411 
nodemask_t
 
phy¢ode_mask
 = 
NODE_MASK_NONE
;

412 
u64
 
size
;

413 
big
;

414 
ªt
 = 0;

415 
i
;

417 i‡(
ƒ_nodes
 <= 0)

419 i‡(
ƒ_nodes
 > 
MAX_NUMNODES
) {

420 
	`¥_öfo
("numa=fake=%dÅooÜarge,ÑeducingÅo %d\n",

421 
ƒ_nodes
, 
MAX_NUMNODES
);

422 
ƒ_nodes
 = 
MAX_NUMNODES
;

425 
size
 = (
max_addr
 - 
addr
 - 
	`e820_hﬁe_size
◊ddr, max_addr)Ë/ 
ƒ_nodes
;

430 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë& 
ƒ_nodes
) /

431 
FAKE_NODE_MIN_SIZE
;

433 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

434 i‡(!
size
) {

435 
	`¥_îr
("NotÉnough memory forÉachÇode. "

440 
i
 = 0; i < 
ƒ_phys_nodes
; i++)

441 i‡(
phy¢odes
[
i
].
°¨t
 !phy¢odes[i].
íd
)

442 
	`node_£t
(
i
, 
phy¢ode_mask
);

448 
	`nodes_weight
(
phy¢ode_mask
)) {

449 
	`f‹_óch_node_mask
(
i
, 
phy¢ode_mask
) {

450 
u64
 
íd
 = 
phy¢odes
[
i
].
°¨t
 + 
size
;

451 
u64
 
dma32_íd
 = 
	`PFN_PHYS
(
MAX_DMA32_PFN
);

453 i‡(
ªt
 < 
big
)

454 
íd
 +
FAKE_NODE_MIN_SIZE
;

460 
íd
 - 
phy¢odes
[
i
].
°¨t
 -

461 
	`e820_hﬁe_size
(
phy¢odes
[
i
].
°¨t
, 
íd
Ë< 
size
) {

462 
íd
 +
FAKE_NODE_MIN_SIZE
;

463 i‡(
íd
 > 
phy¢odes
[
i
].end) {

464 
íd
 = 
phy¢odes
[
i
].end;

474 i‡(
íd
 < 
dma32_íd
 && dma32_end -Énd -

475 
	`e820_hﬁe_size
(
íd
, 
dma32_íd
Ë< 
FAKE_NODE_MIN_SIZE
)

476 
íd
 = 
dma32_íd
;

483 i‡(
phy¢odes
[
i
].
íd
 -Énd -

484 
	`e820_hﬁe_size
(
íd
, 
phy¢odes
[
i
].ídË< 
size
)

485 
íd
 = 
phy¢odes
[
i
].end;

492 i‡(
	`nodes_weight
(
phy¢ode_mask
Ë+ 
ªt
 >
ƒ_nodes
)

493 
íd
 = 
phy¢odes
[
i
].end;

495 i‡(
	`£tup_node_ønge
(
ªt
++, &
phy¢odes
[
i
].
°¨t
,

496 
íd
 - 
phy¢odes
[
i
].
°¨t
,

497 
phy¢odes
[
i
].
íd
) < 0)

498 
	`node_˛ór
(
i
, 
phy¢ode_mask
);

501  
ªt
;

502 
	}
}

509 
__öô
 
	$•lô_nodes_equÆly
(
u64
 *
addr
, u64 
max_addr
, 
node_°¨t
,

510 
num_nodes
)

512 
big
;

513 
u64
 
size
;

514 
i
;

516 i‡(
num_nodes
 <= 0)

518 i‡(
num_nodes
 > 
MAX_NUMNODES
)

519 
num_nodes
 = 
MAX_NUMNODES
;

520 
size
 = (
max_addr
 - *
addr
 - 
	`e820_hﬁe_size
(*addr, max_addr)) /

521 
num_nodes
;

526 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë* 
num_nodes
) /

527 
FAKE_NODE_MIN_SIZE
;

530 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

531 i‡(!
size
) {

532 
	`¥ötk
(
KERN_ERR
 "NotÉnough memory forÉachÇode. "

537 
i
 = 
node_°¨t
; i < 
num_nodes
 +Çode_start; i++) {

538 
u64
 
íd
 = *
addr
 + 
size
;

540 i‡(
i
 < 
big
)

541 
íd
 +
FAKE_NODE_MIN_SIZE
;

546 i‡(
i
 =
num_nodes
 + 
node_°¨t
 - 1)

547 
íd
 = 
max_addr
;

549 
íd
 - *
addr
 - 
	`e820_hﬁe_size
(*addr,Énd) <

550 
size
) {

551 
íd
 +
FAKE_NODE_MIN_SIZE
;

552 i‡(
íd
 > 
max_addr
) {

553 
íd
 = 
max_addr
;

557 i‡(
	`£tup_node_ønge
(
i
, 
addr
, 
íd
 - *addr, 
max_addr
) < 0)

560  
i
 - 
node_°¨t
 + 1;

561 
	}
}

568 
__öô
 
	$•lô_nodes_by_size
(
u64
 *
addr
, u64 
max_addr
, 
node_°¨t
,

569 
u64
 
size
)

571 
i
 = 
node_°¨t
;

572 
size
 = (sizê<< 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

573 !
	`£tup_node_ønge
(
i
++, 
addr
, 
size
, 
max_addr
))

575  
i
 - 
node_°¨t
;

576 
	}
}

582 
__öô
 
	$numa_emuœti⁄
(
°¨t_p‚
,

583 
œ°_p‚
, 
a˝i
, 
k8
)

585 
u64
 
size
, 
addr
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

586 
u64
 
max_addr
 = 
œ°_p‚
 << 
PAGE_SHIFT
;

587 
num_nodes
 = 0, 
num
 = 0, 
c€ff_Êag
, 
c€ff
 = -1, 
i
;

588 
num_phys_nodes
;

590 
num_phys_nodes
 = 
	`£tup_phy¢odes
(
addr
, 
max_addr
, 
a˝i
, 
k8
);

595 i‡(!
	`°rchr
(
cmdlöe
, '*') && !strchr(cmdline, ',')) {

596 
n
 = 
	`sim∂e_°πﬁ
(
cmdlöe
, 
NULL
, 0);

598 
num_nodes
 = 
	`•lô_nodes_öãæóve
(
addr
, 
max_addr
,

599 
num_phys_nodes
, 
n
);

600 i‡(
num_nodes
 < 0)

601  
num_nodes
;

602 
out
;

606 
c€ff_Êag
 = 0; ; 
cmdlöe
++) {

607 i‡(*
cmdlöe
 && 
	`isdigô
(*cmdline)) {

608 
num
 =Çum * 10 + *
cmdlöe
 - '0';

611 i‡(*
cmdlöe
 == '*') {

612 i‡(
num
 > 0)

613 
c€ff
 = 
num
;

614 
c€ff_Êag
 = 1;

616 i‡(!*
cmdlöe
 || *cmdline == ',') {

617 i‡(!
c€ff_Êag
)

618 
c€ff
 = 1;

623 
size
 = ((
u64
)
num
 << 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

624 i‡(
size
)

625 
i
 = 0; i < 
c€ff
; i++, 
num_nodes
++)

626 i‡(
	`£tup_node_ønge
(
num_nodes
, &
addr
,

627 
size
, 
max_addr
) < 0)

628 
d⁄e
;

629 i‡(!*
cmdlöe
)

631 
c€ff_Êag
 = 0;

632 
c€ff
 = -1;

634 
num
 = 0;

636 
d⁄e
:

637 i‡(!
num_nodes
)

640 i‡(
addr
 < 
max_addr
) {

641 i‡(
c€ff_Êag
 && 
c€ff
 < 0) {

643 
num_nodes
 +
	`•lô_nodes_by_size
(&
addr
, 
max_addr
,

644 
num_nodes
, 
num
);

645 
out
;

647 *(
cmdlöe
 - 1)) {

650 i‡(
c€ff
 <= 0)

652 
num_nodes
 +
	`•lô_nodes_equÆly
(&
addr
, 
max_addr
,

653 
num_nodes
, 
c€ff
);

660 
	`£tup_node_ønge
(
num_nodes
, &
addr
, 
max_addr
 -áddr,

661 
max_addr
);

662 
num_nodes
++;

665 
out
:

666 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 
num_nodes
, 
NULL
);

667 i‡(
memnode_shi·
 < 0) {

668 
memnode_shi·
 = 0;

669 
	`¥ötk
(
KERN_ERR
 "No NUMA hash function found. NUMAÉmulation "

678 
	`ªmove_Æl_a˘ive_ønges
();

679 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

680 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

681 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

682 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

684 
	`a˝i_Áke_nodes
(
nodes
, 
num_nodes
);

685 
	`numa_öô_¨øy
();

687 
	}
}

690 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
œ°_p‚
,

691 
a˝i
, 
k8
)

693 
i
;

695 
	`nodes_˛ór
(
node_possibÀ_m≠
);

696 
	`nodes_˛ór
(
node_⁄löe_m≠
);

698 #ifde‡
CONFIG_NUMA_EMU


699 i‡(
cmdlöe
 && !
	`numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
, 
a˝i
, 
k8
))

701 
	`nodes_˛ór
(
node_possibÀ_m≠
);

702 
	`nodes_˛ór
(
node_⁄löe_m≠
);

705 #ifde‡
CONFIG_ACPI_NUMA


706 i‡(!
numa_off
 && 
a˝i
 && !
	`a˝i_sˇn_nodes
(
°¨t_p‚
 << 
PAGE_SHIFT
,

707 
œ°_p‚
 << 
PAGE_SHIFT
))

709 
	`nodes_˛ór
(
node_possibÀ_m≠
);

710 
	`nodes_˛ór
(
node_⁄löe_m≠
);

713 #ifde‡
CONFIG_K8_NUMA


714 i‡(!
numa_off
 && 
k8
 && !
	`k8_sˇn_nodes
())

716 
	`nodes_˛ór
(
node_possibÀ_m≠
);

717 
	`nodes_˛ór
(
node_⁄löe_m≠
);

719 
	`¥ötk
(
KERN_INFO
 "%s\n",

720 
numa_off
 ? "NUMAÅurned off" : "No NUMA configuration found");

722 
	`¥ötk
(
KERN_INFO
 "FakingáÇodeát %016lx-%016lx\n",

723 
°¨t_p‚
 << 
PAGE_SHIFT
,

724 
œ°_p‚
 << 
PAGE_SHIFT
);

726 
memnode_shi·
 = 63;

727 
memnodem≠
 = 
memnode
.
embedded_m≠
;

728 
memnodem≠
[0] = 0;

729 
	`node_£t_⁄löe
(0);

730 
	`node_£t
(0, 
node_possibÀ_m≠
);

731 
i
 = 0; i < 
ƒ_˝u_ids
; i++)

732 
	`numa_£t_node
(
i
, 0);

733 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
œ°_p‚
);

734 
	`£tup_node_boŸmem
(0, 
°¨t_p‚
 << 
PAGE_SHIFT
, 
œ°_p‚
 << PAGE_SHIFT);

735 
	}
}

737 
__öô
 
	$numa_‰ì_Æl_boŸmem
()

739 
∑ges
 = 0;

740 
i
;

742 
	`f‹_óch_⁄löe_node
(
i
)

743 
∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
i
));

745  
∑ges
;

746 
	}
}

748 
__öô
 
	$numa_£tup
(*
›t
)

750 i‡(!
›t
)

751  -
EINVAL
;

752 i‡(!
	`°∫cmp
(
›t
, "off", 3))

753 
numa_off
 = 1;

754 #ifde‡
CONFIG_NUMA_EMU


755 i‡(!
	`°∫cmp
(
›t
, "fake=", 5))

756 
cmdlöe
 = 
›t
 + 5;

758 #ifde‡
CONFIG_ACPI_NUMA


759 i‡(!
	`°∫cmp
(
›t
, "noacpi", 6))

760 
a˝i_numa
 = -1;

763 
	}
}

764 
óæy_∑øm
("numa", 
numa_£tup
);

766 #ifde‡
CONFIG_NUMA


768 
__öô
 
	$föd_√¨_⁄löe_node
(
node
)

770 
n
, 
vÆ
;

771 
mö_vÆ
 = 
INT_MAX
;

772 
be°_node
 = -1;

774 
	`f‹_óch_⁄löe_node
(
n
) {

775 
vÆ
 = 
	`node_di°™˚
(
node
, 
n
);

777 i‡(
vÆ
 < 
mö_vÆ
) {

778 
mö_vÆ
 = 
vÆ
;

779 
be°_node
 = 
n
;

783  
be°_node
;

784 
	}
}

800 
__öô
 
	$öô_˝u_to_node
()

802 
˝u
;

803 
u16
 *
˝u_to_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
);

805 
	`BUG_ON
(
˝u_to_≠icid
 =
NULL
);

807 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

808 
node
;

809 
u16
 
≠icid
 = 
˝u_to_≠icid
[
˝u
];

811 i‡(
≠icid
 =
BAD_APICID
)

813 
node
 = 
≠icid_to_node
[
≠icid
];

814 i‡(
node
 =
NUMA_NO_NODE
)

816 i‡(!
	`node_⁄löe
(
node
))

817 
node
 = 
	`föd_√¨_⁄löe_node
(node);

818 
	`numa_£t_node
(
˝u
, 
node
);

820 
	}
}

824 
__˝uöô
 
	$numa_£t_node
(
˝u
, 
node
)

826 *
˝u_to_node_m≠
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
);

829 i‡(
˝u_to_node_m≠
) {

830 
˝u_to_node_m≠
[
˝u
] = 
node
;

834 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


835 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_possibÀ
(cpu)) {

836 
	`¥ötk
(
KERN_ERR
 "numa_£t_node: invÆid cpu# (%d)\n", 
˝u
);

837 
	`dump_°ack
();

841 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
Ë
node
;

843 i‡(
node
 !
NUMA_NO_NODE
)

844 
	`≥r_˝u
(
node_numbî
, 
˝u
Ë
node
;

845 
	}
}

847 
__˝uöô
 
	$numa_˛ór_node
(
˝u
)

849 
	`numa_£t_node
(
˝u
, 
NUMA_NO_NODE
);

850 
	}
}

852 #i‚de‡
CONFIG_DEBUG_PER_CPU_MAPS


854 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

856 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

857 
	}
}

859 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

861 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

862 
	}
}

869 
__˝uöô
 
	$numa_£t_˝umask
(
˝u
, 
íabÀ
)

871 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

872 
˝umask
 *
mask
;

873 
buf
[64];

875 
mask
 = 
node_to_˝umask_m≠
[
node
];

876 i‡(
mask
 =
NULL
) {

877 
	`¥ötk
(
KERN_ERR
 "node_to_˝umask_m≠[%i] NULL\n", 
node
);

878 
	`dump_°ack
();

882 i‡(
íabÀ
)

883 
	`˝umask_£t_˝u
(
˝u
, 
mask
);

885 
	`˝umask_˛ór_˝u
(
˝u
, 
mask
);

887 
	`˝uli°_s˙¥ötf
(
buf
, (buf), 
mask
);

888 
	`¥ötk
(
KERN_DEBUG
 "%s cpu %dÇode %d: maskÇow %s\n",

889 
íabÀ
 ? "numa_add_˝u" : "numa_ªmove_˝u", 
˝u
, 
node
, 
buf
);

890 
	}
}

892 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

894 
	`numa_£t_˝umask
(
˝u
, 1);

895 
	}
}

897 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

899 
	`numa_£t_˝umask
(
˝u
, 0);

900 
	}
}

902 
	$˝u_to_node
(
˝u
)

904 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)) {

905 
	`¥ötk
(
KERN_WARNING


906 "˝u_to_node(%d): ußgêtoÿóæy!\n", 
˝u
);

907 
	`dump_°ack
();

908  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

910  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

911 
	}
}

912 
EXPORT_SYMBOL
(
˝u_to_node
);

918 
	$óæy_˝u_to_node
(
˝u
)

920 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
))

921  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

923 i‡(!
	`˝u_possibÀ
(
˝u
)) {

924 
	`¥ötk
(
KERN_WARNING


925 "óæy_˝u_to_node(%d):Çÿ≥r_˝uáªa!\n", 
˝u
);

926 
	`dump_°ack
();

927  
NUMA_NO_NODE
;

929  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

930 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<löux/highmem.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/öãºu±.h
>

12 
	~<löux/£q_fûe.h
>

13 
	~<löux/debugfs.h
>

14 
	~<löux/p‚.h
>

15 
	~<löux/≥r˝u.h
>

17 
	~<asm/e820.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<asm/£tup.h
>

22 
	~<asm/uac˚ss.h
>

23 
	~<asm/pgÆloc.h
>

24 
	~<asm/¥Ÿo.h
>

25 
	~<asm/∑t.h
>

30 
	s˝a_d©a
 {

31 *
	mvaddr
;

32 
pg¥Ÿ_t
 
	mmask_£t
;

33 
pg¥Ÿ_t
 
	mmask_˛r
;

34 
	mnum∑ges
;

35 
	mÊags
;

36 
	mp‚
;

37 
	mf‹˚_•lô
 : 1;

38 
	mcuΩage
;

39 
∑ge
 **
	m∑ges
;

48 
DEFINE_SPINLOCK
(
˝a_lock
);

50 
	#CPA_FLUSHTLB
 1

	)

51 
	#CPA_ARRAY
 2

	)

52 
	#CPA_PAGES_ARRAY
 4

	)

54 #ifde‡
CONFIG_PROC_FS


55 
	gdúe˘_∑ges_cou¡
[
PG_LEVEL_NUM
];

57 
	$upd©e_∑ge_cou¡
(
Àvñ
, 
∑ges
)

59 
Êags
;

62 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

63 
dúe˘_∑ges_cou¡
[
Àvñ
] +
∑ges
;

64 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

65 
	}
}

67 
	$•lô_∑ge_cou¡
(
Àvñ
)

69 
dúe˘_∑ges_cou¡
[
Àvñ
]--;

70 
dúe˘_∑ges_cou¡
[
Àvñ
 - 1] +
PTRS_PER_PTE
;

71 
	}
}

73 
	$¨ch_ªp‹t_memöfo
(
£q_fûe
 *
m
)

75 
	`£q_¥ötf
(
m
, "DirectMap4k: %8lu kB\n",

76 
dúe˘_∑ges_cou¡
[
PG_LEVEL_4K
] << 2);

77 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

78 
	`£q_¥ötf
(
m
, "DirectMap2M: %8lu kB\n",

79 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 11);

81 
	`£q_¥ötf
(
m
, "DirectMap4M: %8lu kB\n",

82 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 12);

84 #ifde‡
CONFIG_X86_64


85 i‡(
dúe˘_gb∑ges
)

86 
	`£q_¥ötf
(
m
, "DirectMap1G: %8lu kB\n",

87 
dúe˘_∑ges_cou¡
[
PG_LEVEL_1G
] << 20);

89 
	}
}

91 
ölöe
 
	$•lô_∑ge_cou¡
(
Àvñ
Ë{ 
	}
}

94 #ifde‡
CONFIG_X86_64


96 
ölöe
 
	$highm≠_°¨t_p‚
()

98  
	`__∑
(
_ãxt
Ë>> 
PAGE_SHIFT
;

99 
	}
}

101 
ölöe
 
	$highm≠_íd_p‚
()

103  
	`__∑
(
	`roundup
(
_brk_íd
, 
PMD_SIZE
)Ë>> 
PAGE_SHIFT
;

104 
	}
}

108 #ifde‡
CONFIG_DEBUG_PAGEALLOC


109 
	#debug_∑góŒoc
 1

	)

111 
	#debug_∑góŒoc
 0

	)

114 
ölöe
 

115 
	$wôhö
(
addr
, 
°¨t
, 
íd
)

117  
addr
 >
°¨t
 &&ádd∏< 
íd
;

118 
	}
}

132 
	$˛Êush_ˇche_ønge
(*
vaddr
, 
size
)

134 *
víd
 = 
vaddr
 + 
size
 - 1;

136 
	`mb
();

138 ; 
vaddr
 < 
víd
; vadd∏+
boŸ_˝u_d©a
.
x86_˛Êush_size
)

139 
	`˛Êush
(
vaddr
);

143 
	`˛Êush
(
víd
);

145 
	`mb
();

146 
	}
}

147 
EXPORT_SYMBOL_GPL
(
˛Êush_ˇche_ønge
);

149 
	$__˝a_Êush_Æl
(*
¨g
)

151 
ˇche
 = ()
¨g
;

157 
	`__Êush_éb_Æl
();

159 i‡(
ˇche
 && 
boŸ_˝u_d©a
.
x86
 >= 4)

160 
	`wbövd
();

161 
	}
}

163 
	$˝a_Êush_Æl
(
ˇche
)

165 
	`BUG_ON
(
	`úqs_dißbÀd
());

167 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
ˇche
, 1);

168 
	}
}

170 
	$__˝a_Êush_ønge
(*
¨g
)

177 
	`__Êush_éb_Æl
();

178 
	}
}

180 
	$˝a_Êush_ønge
(
°¨t
, 
num∑ges
, 
ˇche
)

182 
i
, 
Àvñ
;

183 
addr
;

185 
	`BUG_ON
(
	`úqs_dißbÀd
());

186 
	`WARN_ON
(
	`PAGE_ALIGN
(
°¨t
) != start);

188 
	`⁄_óch_˝u
(
__˝a_Êush_ønge
, 
NULL
, 1);

190 i‡(!
ˇche
)

199 
i
 = 0, 
addr
 = 
°¨t
; i < 
num∑ges
; i++,ádd∏+
PAGE_SIZE
) {

200 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

205 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

206 
	`˛Êush_ˇche_ønge
((*Ë
addr
, 
PAGE_SIZE
);

208 
	}
}

210 
	$˝a_Êush_¨øy
(*
°¨t
, 
num∑ges
, 
ˇche
,

211 
ö_Êags
, 
∑ge
 **
∑ges
)

213 
i
, 
Àvñ
;

214 
do_wbövd
 = 
ˇche
 && 
num∑ges
 >= 1024;

216 
	`BUG_ON
(
	`úqs_dißbÀd
());

218 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
do_wbövd
, 1);

220 i‡(!
ˇche
 || 
do_wbövd
)

229 
i
 = 0; i < 
num∑ges
; i++) {

230 
addr
;

231 
±e_t
 *
±e
;

233 i‡(
ö_Êags
 & 
CPA_PAGES_ARRAY
)

234 
addr
 = ()
	`∑ge_addªss
(
∑ges
[
i
]);

236 
addr
 = 
°¨t
[
i
];

238 
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

243 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

244 
	`˛Êush_ˇche_ønge
((*)
addr
, 
PAGE_SIZE
);

246 
	}
}

254 
ölöe
 
pg¥Ÿ_t
 
	$°©ic_¥Ÿe˘i⁄s
(
pg¥Ÿ_t
 
¥Ÿ
, 
addªss
,

255 
p‚
)

257 
pg¥Ÿ_t
 
f‹biddí
 = 
	`__pg¥Ÿ
(0);

263 i‡(
	`wôhö
(
p‚
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

264 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

271 i‡(
	`wôhö
(
addªss
, ()
_ãxt
, ()
_ëext
))

272 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

278 i‡(
	`wôhö
(
p‚
, 
	`__∑
(()
__°¨t_rod©a
Ë>> 
PAGE_SHIFT
,

279 
	`__∑
(()
__íd_rod©a
Ë>> 
PAGE_SHIFT
))

280 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

282 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_DEBUG_RODATA
)

292 i‡(
kî√l_£t_to_ªad⁄ly
 &&

293 
	`wôhö
(
addªss
, ()
_ãxt
,

294 ()
__íd_rod©a_h∑ge_Æign
))

295 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

298 
¥Ÿ
 = 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
’rŸË& ~pg¥Ÿ_vÆ(
f‹biddí
));

300  
¥Ÿ
;

301 
	}
}

311 
±e_t
 *
	$lookup_addªss
(
addªss
, *
Àvñ
)

313 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
addªss
);

314 
pud_t
 *
pud
;

315 
pmd_t
 *
pmd
;

317 *
Àvñ
 = 
PG_LEVEL_NONE
;

319 i‡(
	`pgd_n⁄e
(*
pgd
))

320  
NULL
;

322 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

323 i‡(
	`pud_n⁄e
(*
pud
))

324  
NULL
;

326 *
Àvñ
 = 
PG_LEVEL_1G
;

327 i‡(
	`pud_œrge
(*
pud
Ë|| !
	`pud_¥e£¡
(*pud))

328  (
±e_t
 *)
pud
;

330 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

331 i‡(
	`pmd_n⁄e
(*
pmd
))

332  
NULL
;

334 *
Àvñ
 = 
PG_LEVEL_2M
;

335 i‡(
	`pmd_œrge
(*
pmd
Ë|| !
	`pmd_¥e£¡
(*pmd))

336  (
±e_t
 *)
pmd
;

338 *
Àvñ
 = 
PG_LEVEL_4K
;

340  
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

341 
	}
}

342 
EXPORT_SYMBOL_GPL
(
lookup_addªss
);

347 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
addªss
,Öã_à
±e
)

350 
	`£t_±e_©omic
(
k±e
, 
±e
);

351 #ifde‡
CONFIG_X86_32


352 i‡(!
SHARED_KERNEL_PMD
) {

353 
∑ge
 *page;

355 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

356 
pgd_t
 *
pgd
;

357 
pud_t
 *
pud
;

358 
pmd_t
 *
pmd
;

360 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

361 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

362 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

363 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

367 
	}
}

370 
	$åy_¥e£rve_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
,

371 
˝a_d©a
 *
˝a
)

373 
√xçage_addr
, 
num∑ges
, 
pmask
, 
psize
, 
Êags
, 
addr
, 
p‚
;

374 
±e_t
 
√w_±e
, 
ﬁd_±e
, *
tmp
;

375 
pg¥Ÿ_t
 
ﬁd_¥Ÿ
, 
√w_¥Ÿ
;

376 
i
, 
do_•lô
 = 1;

377 
Àvñ
;

379 i‡(
˝a
->
f‹˚_•lô
)

382 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

387 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

388 i‡(
tmp
 !
k±e
)

389 
out_u∆ock
;

391 
Àvñ
) {

392 
PG_LEVEL_2M
:

393 
psize
 = 
PMD_PAGE_SIZE
;

394 
pmask
 = 
PMD_PAGE_MASK
;

396 #ifde‡
CONFIG_X86_64


397 
PG_LEVEL_1G
:

398 
psize
 = 
PUD_PAGE_SIZE
;

399 
pmask
 = 
PUD_PAGE_MASK
;

403 
do_•lô
 = -
EINVAL
;

404 
out_u∆ock
;

411 
√xçage_addr
 = (
addªss
 + 
psize
Ë& 
pmask
;

412 
num∑ges
 = (
√xçage_addr
 - 
addªss
Ë>> 
PAGE_SHIFT
;

413 i‡(
num∑ges
 < 
˝a
->numpages)

414 
˝a
->
num∑ges
 =Çumpages;

419 
ﬁd_±e
 = *
k±e
;

420 
ﬁd_¥Ÿ
 = 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

422 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

423 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

429 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
Ë+ ((
addªss
 & (
psize
 - 1)Ë>> 
PAGE_SHIFT
);

430 
˝a
->
p‚
 =Öfn;

432 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

439 
addr
 = 
addªss
 + 
PAGE_SIZE
;

440 
p‚
++;

441 
i
 = 1; i < 
˝a
->
num∑ges
; i++, 
addr
 +
PAGE_SIZE
, 
p‚
++) {

442 
pg¥Ÿ_t
 
chk_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
(
√w_¥Ÿ
, 
addr
, 
p‚
);

444 i‡(
	`pg¥Ÿ_vÆ
(
chk_¥Ÿ
Ë!pg¥Ÿ_vÆ(
√w_¥Ÿ
))

445 
out_u∆ock
;

452 i‡(
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë=pg¥Ÿ_vÆ(
ﬁd_¥Ÿ
)) {

453 
do_•lô
 = 0;

454 
out_u∆ock
;

465 i‡(
addªss
 =(
√xçage_addr
 - 
psize
Ë&& 
˝a
->
num∑ges
 ==Çumpages) {

470 
√w_±e
 = 
	`p‚_±e
(
	`±e_p‚
(
ﬁd_±e
), 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

471 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
√w_±e
);

472 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

473 
do_•lô
 = 0;

476 
out_u∆ock
:

477 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

479  
do_•lô
;

480 
	}
}

482 
	$•lô_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
)

484 
Êags
, 
p‚
, 
p‚öc
 = 1;

485 
i
, 
Àvñ
;

486 
±e_t
 *
pba£
, *
tmp
;

487 
pg¥Ÿ_t
 
ªf_¥Ÿ
;

488 
∑ge
 *
ba£
;

490 i‡(!
debug_∑góŒoc
)

491 
	`•ö_u∆ock
(&
˝a_lock
);

492 
ba£
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_NOTRACK
, 0);

493 i‡(!
debug_∑góŒoc
)

494 
	`•ö_lock
(&
˝a_lock
);

495 i‡(!
ba£
)

496  -
ENOMEM
;

498 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

503 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

504 i‡(
tmp
 !
k±e
)

505 
out_u∆ock
;

507 
pba£
 = (
±e_t
 *)
	`∑ge_addªss
(
ba£
);

508 
	`∑øvút_Æloc_±e
(&
öô_mm
, 
	`∑ge_to_p‚
(
ba£
));

509 
ªf_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*
k±e
));

516 
	`WARN_ON_ONCE
(
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë& 
_PAGE_PAT_LARGE
);

518 #ifde‡
CONFIG_X86_64


519 i‡(
Àvñ
 =
PG_LEVEL_1G
) {

520 
p‚öc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

521 
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë|
_PAGE_PSE
;

528 
p‚
 = 
	`±e_p‚
(*
k±e
);

529 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
p‚
 +
p‚öc
)

530 
	`£t_±e
(&
pba£
[
i
], 
	`p‚_±e
(
p‚
, 
ªf_¥Ÿ
));

532 i‡(
addªss
 >()
	`__va
(0) &&

533 
addªss
 < ()
	`__va
(
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
))

534 
	`•lô_∑ge_cou¡
(
Àvñ
);

536 #ifde‡
CONFIG_X86_64


537 i‡(
addªss
 >()
	`__va
(1UL<<32) &&

538 
addªss
 < ()
	`__va
(
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))

539 
	`•lô_∑ge_cou¡
(
Àvñ
);

549 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
	`mk_±e
(
ba£
, 
	`__pg¥Ÿ
(
_KERNPG_TABLE
)));

559 
	`__Êush_éb_Æl
();

561 
ba£
 = 
NULL
;

563 
out_u∆ock
:

568 i‡(
ba£
)

569 
	`__‰ì_∑ge
(
ba£
);

570 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

573 
	}
}

575 
	$__˝a_¥o˚ss_Áu…
(
˝a_d©a
 *
˝a
, 
vaddr
,

576 
¥im¨y
)

581 i‡(!
¥im¨y
)

591 i‡(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

592 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))) {

593 
˝a
->
num∑ges
 = 1;

594 
˝a
->
p‚
 = 
	`__∑
(
vaddr
Ë>> 
PAGE_SHIFT
;

597 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zeroÖte. "

598 "vadd∏%lx c∑->vadd∏%lx\n", 
vaddr
,

599 *
˝a
->
vaddr
);

601  -
EFAULT
;

603 
	}
}

605 
	$__ch™ge_∑ge_©å
(
˝a_d©a
 *
˝a
, 
¥im¨y
)

607 
addªss
;

608 
do_•lô
, 
îr
;

609 
Àvñ
;

610 
±e_t
 *
k±e
, 
ﬁd_±e
;

612 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

613 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

614 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

616 
addªss
 = ()
	`∑ge_addªss
(
∑ge
);

617 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

618 
addªss
 = 
˝a
->
vaddr
[˝a->
cuΩage
];

620 
addªss
 = *
˝a
->
vaddr
;

621 
ª≥©
:

622 
k±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

623 i‡(!
k±e
)

624  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

626 
ﬁd_±e
 = *
k±e
;

627 i‡(!
	`±e_vÆ
(
ﬁd_±e
))

628  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

630 i‡(
Àvñ
 =
PG_LEVEL_4K
) {

631 
±e_t
 
√w_±e
;

632 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

633 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
);

635 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

636 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

638 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

645 
√w_±e
 = 
	`p‚_±e
(
p‚
, 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

646 
˝a
->
p‚
 =Öfn;

650 i‡(
	`±e_vÆ
(
ﬁd_±e
Ë!±e_vÆ(
√w_±e
)) {

651 
	`£t_±e_©omic
(
k±e
, 
√w_±e
);

652 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

654 
˝a
->
num∑ges
 = 1;

662 
do_•lô
 = 
	`åy_¥e£rve_œrge_∑ge
(
k±e
, 
addªss
, 
˝a
);

668 i‡(
do_•lô
 <= 0)

669  
do_•lô
;

674 
îr
 = 
	`•lô_œrge_∑ge
(
k±e
, 
addªss
);

675 i‡(!
îr
) {

694 
	`Êush_éb_Æl
();

695 
ª≥©
;

698  
îr
;

699 
	}
}

701 
__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
);

703 
	$˝a_¥o˚ss_Æüs
(
˝a_d©a
 *
˝a
)

705 
˝a_d©a
 
Æüs_˝a
;

706 
œddr
 = ()
	`__va
(
˝a
->
p‚
 << 
PAGE_SHIFT
);

707 
vaddr
;

708 
ªt
;

710 i‡(
˝a
->
p‚
 >
max_p‚_m≠≥d
)

713 #ifde‡
CONFIG_X86_64


714 i‡(
˝a
->
p‚
 >
max_low_p‚_m≠≥d
 && c∑->p‚ < (1UL<<(32-
PAGE_SHIFT
)))

721 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

722 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

723 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

725 
vaddr
 = ()
	`∑ge_addªss
(
∑ge
);

726 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

727 
vaddr
 = 
˝a
->vaddr[˝a->
cuΩage
];

729 
vaddr
 = *
˝a
->vaddr;

731 i‡(!(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

732 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
)))) {

734 
Æüs_˝a
 = *
˝a
;

735 
Æüs_˝a
.
vaddr
 = &
œddr
;

736 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

738 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

739 i‡(
ªt
)

740  
ªt
;

743 #ifde‡
CONFIG_X86_64


749 i‡(!
	`wôhö
(
vaddr
, ()
_ãxt
, 
_brk_íd
) &&

750 
	`wôhö
(
˝a
->
p‚
, 
	`highm≠_°¨t_p‚
(), 
	`highm≠_íd_p‚
())) {

751 
ãmp_˝a_vaddr
 = (
˝a
->
p‚
 << 
PAGE_SHIFT
) +

752 
__START_KERNEL_m≠
 - 
phys_ba£
;

753 
Æüs_˝a
 = *
˝a
;

754 
Æüs_˝a
.
vaddr
 = &
ãmp_˝a_vaddr
;

755 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

761 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

766 
	}
}

768 
	$__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
)

770 
ªt
, 
num∑ges
 = 
˝a
->numpages;

772 
num∑ges
) {

777 
˝a
->
num∑ges
 =Çumpages;

779 i‡(
˝a
->
Êags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

780 
˝a
->
num∑ges
 = 1;

782 i‡(!
debug_∑góŒoc
)

783 
	`•ö_lock
(&
˝a_lock
);

784 
ªt
 = 
	`__ch™ge_∑ge_©å
(
˝a
, 
checkÆüs
);

785 i‡(!
debug_∑góŒoc
)

786 
	`•ö_u∆ock
(&
˝a_lock
);

787 i‡(
ªt
)

788  
ªt
;

790 i‡(
checkÆüs
) {

791 
ªt
 = 
	`˝a_¥o˚ss_Æüs
(
˝a
);

792 i‡(
ªt
)

793  
ªt
;

801 
	`BUG_ON
(
˝a
->
num∑ges
 >Çumpages);

802 
num∑ges
 -
˝a
->numpages;

803 i‡(
˝a
->
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

804 
˝a
->
cuΩage
++;

806 *
˝a
->
vaddr
 +˝a->
num∑ges
 * 
PAGE_SIZE
;

810 
	}
}

812 
ölöe
 
	$ˇche_©å
(
pg¥Ÿ_t
 
©å
)

814  
	`pg¥Ÿ_vÆ
(
©å
) &

815 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

816 
	}
}

818 
	$ch™ge_∑ge_©å_£t_˛r
(*
addr
, 
num∑ges
,

819 
pg¥Ÿ_t
 
mask_£t
,Ög¥Ÿ_à
mask_˛r
,

820 
f‹˚_•lô
, 
ö_Êag
,

821 
∑ge
 **
∑ges
)

823 
˝a_d©a
 
˝a
;

824 
ªt
, 
ˇche
, 
checkÆüs
;

825 
baddr
 = 0;

831 
mask_£t
 = 
	`ˇn⁄_pg¥Ÿ
(mask_set);

832 
mask_˛r
 = 
	`ˇn⁄_pg¥Ÿ
(mask_clr);

833 i‡(!
	`pg¥Ÿ_vÆ
(
mask_£t
Ë&& !pg¥Ÿ_vÆ(
mask_˛r
Ë&& !
f‹˚_•lô
)

837 i‡(
ö_Êag
 & 
CPA_ARRAY
) {

838 
i
;

839 
i
 = 0; i < 
num∑ges
; i++) {

840 i‡(
addr
[
i
] & ~
PAGE_MASK
) {

841 
addr
[
i
] &
PAGE_MASK
;

842 
	`WARN_ON_ONCE
(1);

845 } i‡(!(
ö_Êag
 & 
CPA_PAGES_ARRAY
)) {

850 i‡(*
addr
 & ~
PAGE_MASK
) {

851 *
addr
 &
PAGE_MASK
;

855 
	`WARN_ON_ONCE
(1);

861 
baddr
 = *
addr
;

865 
	`km≠_Êush_unu£d
();

867 
	`vm_unm≠_Æü£s
();

869 
˝a
.
vaddr
 = 
addr
;

870 
˝a
.
∑ges
 =Öages;

871 
˝a
.
num∑ges
 =Çumpages;

872 
˝a
.
mask_£t
 = mask_set;

873 
˝a
.
mask_˛r
 = mask_clr;

874 
˝a
.
Êags
 = 0;

875 
˝a
.
cuΩage
 = 0;

876 
˝a
.
f‹˚_•lô
 = force_split;

878 i‡(
ö_Êag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

879 
˝a
.
Êags
 |
ö_Êag
;

882 
checkÆüs
 = (
	`pg¥Ÿ_vÆ
(
mask_£t
Ë|Ög¥Ÿ_vÆ(
mask_˛r
)Ë!
_PAGE_NX
;

884 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 
checkÆüs
);

889 i‡(!(
˝a
.
Êags
 & 
CPA_FLUSHTLB
))

890 
out
;

896 
ˇche
 = 
	`ˇche_©å
(
mask_£t
);

904 i‡(!
ªt
 && 
˝u_has_˛Êush
) {

905 i‡(
˝a
.
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

906 
	`˝a_Êush_¨øy
(
addr
, 
num∑ges
, 
ˇche
,

907 
˝a
.
Êags
, 
∑ges
);

909 
	`˝a_Êush_ønge
(
baddr
, 
num∑ges
, 
ˇche
);

911 
	`˝a_Êush_Æl
(
ˇche
);

913 
out
:

914  
ªt
;

915 
	}
}

917 
ölöe
 
	$ch™ge_∑ge_©å_£t
(*
addr
, 
num∑ges
,

918 
pg¥Ÿ_t
 
mask
, 
¨øy
)

920  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

921 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

922 
	}
}

924 
ölöe
 
	$ch™ge_∑ge_©å_˛ór
(*
addr
, 
num∑ges
,

925 
pg¥Ÿ_t
 
mask
, 
¨øy
)

927  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

928 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

929 
	}
}

931 
ölöe
 
	$˝a_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

932 
pg¥Ÿ_t
 
mask
)

934  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

935 
CPA_PAGES_ARRAY
, 
∑ges
);

936 
	}
}

938 
ölöe
 
	$˝a_˛ór_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

939 
pg¥Ÿ_t
 
mask
)

941  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

942 
CPA_PAGES_ARRAY
, 
∑ges
);

943 
	}
}

945 
	$_£t_mem‹y_uc
(
addr
, 
num∑ges
)

950  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

951 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

952 
	}
}

954 
	$£t_mem‹y_uc
(
addr
, 
num∑ges
)

956 
ªt
;

961 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

962 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

963 i‡(
ªt
)

964 
out_îr
;

966 
ªt
 = 
	`_£t_mem‹y_uc
(
addr
, 
num∑ges
);

967 i‡(
ªt
)

968 
out_‰ì
;

972 
out_‰ì
:

973 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

974 
out_îr
:

975  
ªt
;

976 
	}
}

977 
EXPORT_SYMBOL
(
£t_mem‹y_uc
);

979 
	$£t_mem‹y_¨øy_uc
(*
addr
, 
addrö¨øy
)

981 
i
, 
j
;

982 
ªt
;

987 
i
 = 0; i < 
addrö¨øy
; i++) {

988 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
,

989 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

990 i‡(
ªt
)

991 
out_‰ì
;

994 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(
addr
, 
addrö¨øy
,

995 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 1);

996 i‡(
ªt
)

997 
out_‰ì
;

1001 
out_‰ì
:

1002 
j
 = 0; j < 
i
; j++)

1003 
	`‰ì_memty≥
(
	`__∑
(
addr
[
j
]), __∑◊ddr[j]Ë+ 
PAGE_SIZE
);

1005  
ªt
;

1006 
	}
}

1007 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_uc
);

1009 
	$_£t_mem‹y_wc
(
addr
, 
num∑ges
)

1011 
ªt
;

1012 
addr_c›y
 = 
addr
;

1014 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

1015 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

1016 i‡(!
ªt
) {

1017 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(&
addr_c›y
, 
num∑ges
,

1018 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1019 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1020 0, 0, 
NULL
);

1022  
ªt
;

1023 
	}
}

1025 
	$£t_mem‹y_wc
(
addr
, 
num∑ges
)

1027 
ªt
;

1029 i‡(!
∑t_íabÀd
)

1030  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1032 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

1033 
_PAGE_CACHE_WC
, 
NULL
);

1034 i‡(
ªt
)

1035 
out_îr
;

1037 
ªt
 = 
	`_£t_mem‹y_wc
(
addr
, 
num∑ges
);

1038 i‡(
ªt
)

1039 
out_‰ì
;

1043 
out_‰ì
:

1044 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1045 
out_îr
:

1046  
ªt
;

1047 
	}
}

1048 
EXPORT_SYMBOL
(
£t_mem‹y_wc
);

1050 
	$_£t_mem‹y_wb
(
addr
, 
num∑ges
)

1052  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
,

1053 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 0);

1054 
	}
}

1056 
	$£t_mem‹y_wb
(
addr
, 
num∑ges
)

1058 
ªt
;

1060 
ªt
 = 
	`_£t_mem‹y_wb
(
addr
, 
num∑ges
);

1061 i‡(
ªt
)

1062  
ªt
;

1064 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1066 
	}
}

1067 
EXPORT_SYMBOL
(
£t_mem‹y_wb
);

1069 
	$£t_mem‹y_¨øy_wb
(*
addr
, 
addrö¨øy
)

1071 
i
;

1072 
ªt
;

1074 
ªt
 = 
	`ch™ge_∑ge_©å_˛ór
(
addr
, 
addrö¨øy
,

1075 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 1);

1076 i‡(
ªt
)

1077  
ªt
;

1079 
i
 = 0; i < 
addrö¨øy
; i++)

1080 
	`‰ì_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
);

1083 
	}
}

1084 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wb
);

1086 
	$£t_mem‹y_x
(
addr
, 
num∑ges
)

1088 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1091  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1092 
	}
}

1093 
EXPORT_SYMBOL
(
£t_mem‹y_x
);

1095 
	$£t_mem‹y_nx
(
addr
, 
num∑ges
)

1097 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1100  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1101 
	}
}

1102 
EXPORT_SYMBOL
(
£t_mem‹y_nx
);

1104 
	$£t_mem‹y_ro
(
addr
, 
num∑ges
)

1106  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1107 
	}
}

1108 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_ro
);

1110 
	$£t_mem‹y_rw
(
addr
, 
num∑ges
)

1112  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1113 
	}
}

1114 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_rw
);

1116 
	$£t_mem‹y_≈
(
addr
, 
num∑ges
)

1118  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_PRESENT
), 0);

1119 
	}
}

1121 
	$£t_mem‹y_4k
(
addr
, 
num∑ges
)

1123  
	`ch™ge_∑ge_©å_£t_˛r
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0),

1124 
	`__pg¥Ÿ
(0), 1, 0, 
NULL
);

1125 
	}
}

1127 
	$£t_∑ges_uc
(
∑ge
 *∑ge, 
num∑ges
)

1129 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1131  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1132 
	}
}

1133 
EXPORT_SYMBOL
(
£t_∑ges_uc
);

1135 
	$£t_∑ges_¨øy_uc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1137 
°¨t
;

1138 
íd
;

1139 
i
;

1140 
‰ì_idx
;

1142 
i
 = 0; i < 
addrö¨øy
; i++) {

1143 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1145 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1146 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1147 i‡(
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
_PAGE_CACHE_UC_MINUS
, 
NULL
))

1148 
îr_out
;

1151 i‡(
	`˝a_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1152 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
)) == 0) {

1155 
îr_out
:

1156 
‰ì_idx
 = 
i
;

1157 
i
 = 0; i < 
‰ì_idx
; i++) {

1158 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1160 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1161 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1162 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1164  -
EINVAL
;

1165 
	}
}

1166 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_uc
);

1168 
	$£t_∑ges_wb
(
∑ge
 *∑ge, 
num∑ges
)

1170 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1172  
	`£t_mem‹y_wb
(
addr
, 
num∑ges
);

1173 
	}
}

1174 
EXPORT_SYMBOL
(
£t_∑ges_wb
);

1176 
	$£t_∑ges_¨øy_wb
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1178 
ªtvÆ
;

1179 
°¨t
;

1180 
íd
;

1181 
i
;

1183 
ªtvÆ
 = 
	`˝a_˛ór_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1184 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
));

1185 i‡(
ªtvÆ
)

1186  
ªtvÆ
;

1188 
i
 = 0; i < 
addrö¨øy
; i++) {

1189 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1191 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1192 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1193 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1197 
	}
}

1198 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wb
);

1200 
	$£t_∑ges_x
(
∑ge
 *∑ge, 
num∑ges
)

1202 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1204  
	`£t_mem‹y_x
(
addr
, 
num∑ges
);

1205 
	}
}

1206 
EXPORT_SYMBOL
(
£t_∑ges_x
);

1208 
	$£t_∑ges_nx
(
∑ge
 *∑ge, 
num∑ges
)

1210 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1212  
	`£t_mem‹y_nx
(
addr
, 
num∑ges
);

1213 
	}
}

1214 
EXPORT_SYMBOL
(
£t_∑ges_nx
);

1216 
	$£t_∑ges_ro
(
∑ge
 *∑ge, 
num∑ges
)

1218 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1220  
	`£t_mem‹y_ro
(
addr
, 
num∑ges
);

1221 
	}
}

1223 
	$£t_∑ges_rw
(
∑ge
 *∑ge, 
num∑ges
)

1225 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1227  
	`£t_mem‹y_rw
(
addr
, 
num∑ges
);

1228 
	}
}

1230 #ifde‡
CONFIG_DEBUG_PAGEALLOC


1232 
	$__£t_∑ges_p
(
∑ge
 *∑ge, 
num∑ges
)

1234 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1235 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1236 .
num∑ges
 =Çumpages,

1237 .
mask_£t
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1238 .
mask_˛r
 = 
	`__pg¥Ÿ
(0),

1239 .
Êags
 = 0};

1247  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1248 
	}
}

1250 
	$__£t_∑ges_≈
(
∑ge
 *∑ge, 
num∑ges
)

1252 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1253 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1254 .
num∑ges
 =Çumpages,

1255 .
mask_£t
 = 
	`__pg¥Ÿ
(0),

1256 .
mask_˛r
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1257 .
Êags
 = 0};

1265  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1266 
	}
}

1268 
	$kî√l_m≠_∑ges
(
∑ge
 *∑ge, 
num∑ges
, 
íabÀ
)

1270 i‡(
	`PageHighMem
(
∑ge
))

1272 i‡(!
íabÀ
) {

1273 
	`debug_check_no_locks_‰ìd
(
	`∑ge_addªss
(
∑ge
),

1274 
num∑ges
 * 
PAGE_SIZE
);

1280 i‡(!
debug_∑góŒoc_íabÀd
)

1288 i‡(
íabÀ
)

1289 
	`__£t_∑ges_p
(
∑ge
, 
num∑ges
);

1291 
	`__£t_∑ges_≈
(
∑ge
, 
num∑ges
);

1297 
	`__Êush_éb_Æl
();

1298 
	}
}

1300 #ifde‡
CONFIG_HIBERNATION


1302 
boﬁ
 
	$kî√l_∑ge_¥e£¡
(
∑ge
 *page)

1304 
Àvñ
;

1305 
±e_t
 *
±e
;

1307 i‡(
	`PageHighMem
(
∑ge
))

1308  
Ál£
;

1310 
±e
 = 
	`lookup_addªss
(()
	`∑ge_addªss
(
∑ge
), &
Àvñ
);

1311  (
	`±e_vÆ
(*
±e
Ë& 
_PAGE_PRESENT
);

1312 
	}
}

1322 #ifde‡
CONFIG_CPA_DEBUG


1323 
	~"∑góâr-ã°.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<löux/£q_fûe.h
>

11 
	~<löux/boŸmem.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/gÂ.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/rbåì.h
>

20 
	~<asm/ˇcheÊush.h
>

21 
	~<asm/¥o˚ss‹.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/x86_öô.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/f˙é.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/mår.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/m§.h
>

30 
	~<asm/∑t.h
>

31 
	~<asm/io.h
>

33 #ifde‡
CONFIG_X86_PAT


34 
__ªad_mo°ly
 
	g∑t_íabÀd
 = 1;

36 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

38 
∑t_íabÀd
 = 0;

39 
	`¥ötk
(
KERN_INFO
 "%s\n", 
ªas⁄
);

40 
	}
}

42 
__öô
 
	$n›©
(*
°r
)

44 
	`∑t_dißbÀ
("PAT support disabled.");

46 
	}
}

47 
óæy_∑øm
("n›©", 
n›©
);

49 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

51 ()
ªas⁄
;

52 
	}
}

56 
	gdebug_íabÀ
;

58 
__öô
 
	$∑t_debug_£tup
(*
°r
)

60 
debug_íabÀ
 = 1;

62 
	}
}

63 
__£tup
("debug∑t", 
∑t_debug_£tup
);

65 
	#d¥ötk
(
fmt
, 
¨g
...) \

66 dÿ{ i‡(
debug_íabÀ
Ë
	`¥ötk
(
KERN_INFO
 
fmt
, ##
¨g
); } 0)

	)

69 
u64
 
__ªad_mo°ly
 
	gboŸ_∑t_°©e
;

72 
	mPAT_UC
 = 0,

73 
	mPAT_WC
 = 1,

74 
	mPAT_WT
 = 4,

75 
	mPAT_WP
 = 5,

76 
	mPAT_WB
 = 6,

77 
	mPAT_UC_MINUS
 = 7,

80 
	#PAT
(
x
, 
y
Ë((
u64
)
PAT_
 ## y << ((x)*8))

	)

82 
	$∑t_öô
()

84 
u64
 
∑t
;

85 
boﬁ
 
boŸ_˝u
 = !
boŸ_∑t_°©e
;

87 i‡(!
∑t_íabÀd
)

90 i‡(!
˝u_has_∑t
) {

91 i‡(!
boŸ_∑t_°©e
) {

92 
	`∑t_dißbÀ
("PATÇot supported by CPU.");

100 
	`¥ötk
(
KERN_ERR
 "PATÉnabled, "

102 
	`BUG
();

119 
∑t
 = 
	`PAT
(0, 
WB
Ë| PAT(1, 
WC
Ë| PAT(2, 
UC_MINUS
Ë| PAT(3, 
UC
) |

120 
	`PAT
(4, 
WB
Ë| PAT(5, 
WC
Ë| PAT(6, 
UC_MINUS
Ë| PAT(7, 
UC
);

123 i‡(!
boŸ_∑t_°©e
)

124 
	`rdm§l
(
MSR_IA32_CR_PAT
, 
boŸ_∑t_°©e
);

126 
	`wrm§l
(
MSR_IA32_CR_PAT
, 
∑t
);

128 i‡(
boŸ_˝u
)

129 
	`¥ötk
(
KERN_INFO
 "x86 PATÉnabled: cpu %d, old 0x%Lx,Çew 0x%Lx\n",

130 
	`smp_¥o˚ss‹_id
(), 
boŸ_∑t_°©e
, 
∑t
);

131 
	}
}

133 #unde‡
PAT


135 *
	$ˇâr_«me
(
Êags
)

137 
Êags
 & 
_PAGE_CACHE_MASK
) {

138 
_PAGE_CACHE_UC
:  "uncached";

139 
_PAGE_CACHE_UC_MINUS
:  "uncached-minus";

140 
_PAGE_CACHE_WB
:  "write-back";

141 
_PAGE_CACHE_WC
:  "write-combining";

144 
	}
}

162 
	smemty≥
 {

163 
u64
 
	m°¨t
;

164 
u64
 
	míd
;

165 
	mty≥
;

166 
li°_hód
 
	mnd
;

167 
rb_node
 
	mrb
;

170 
rb_roŸ
 
	gmemty≥_rbroŸ
 = 
RB_ROOT
;

171 
LIST_HEAD
(
memty≥_li°
);

172 
DEFINE_SPINLOCK
(
memty≥_lock
);

174 
memty≥
 *
	$memty≥_rb_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
°¨t
)

176 
rb_node
 *
node
 = 
roŸ
->rb_node;

177 
memty≥
 *
œ°_lowî
 = 
NULL
;

179 
node
) {

180 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

182 i‡(
d©a
->
°¨t
 < start) {

183 
œ°_lowî
 = 
d©a
;

184 
node
 =Çode->
rb_right
;

185 } i‡(
d©a
->
°¨t
 > start) {

186 
node
 =Çode->
rb_À·
;

188  
d©a
;

192  
œ°_lowî
;

193 
	}
}

195 
	$memty≥_rb_ö£π
(
rb_roŸ
 *
roŸ
, 
memty≥
 *
d©a
)

197 
rb_node
 **
√w
 = &(
roŸ
->rb_node);

198 
rb_node
 *
∑ª¡
 = 
NULL
;

200 *
√w
) {

201 
memty≥
 *
this
 = 
	`c⁄èöî_of
(*
√w
, memty≥, 
rb
);

203 
∑ª¡
 = *
√w
;

204 i‡(
d©a
->
°¨t
 <
this
->start)

205 
√w
 = &((*√w)->
rb_À·
);

206 i‡(
d©a
->
°¨t
 > 
this
->start)

207 
√w
 = &((*√w)->
rb_right
);

210 
	`rb_lök_node
(&
d©a
->
rb
, 
∑ª¡
, 
√w
);

211 
	`rb_ö£π_cﬁ‹
(&
d©a
->
rb
, 
roŸ
);

212 
	}
}

221 
	$∑t_x_mår_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
)

227 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WB
) {

228 
u8
 
mår_ty≥
;

230 
mår_ty≥
 = 
	`mår_ty≥_lookup
(
°¨t
, 
íd
);

231 i‡(
mår_ty≥
 !
MTRR_TYPE_WRBACK
)

232  
_PAGE_CACHE_UC_MINUS
;

234  
_PAGE_CACHE_WB
;

237  
ªq_ty≥
;

238 
	}
}

241 
	$chk_c⁄Êi˘
(
memty≥
 *
√w
, memty≥ *
íåy
, *
ty≥
)

243 i‡(
√w
->
ty≥
 !
íåy
->type) {

244 i‡(
ty≥
) {

245 
√w
->
ty≥
 = 
íåy
->type;

246 *
ty≥
 = 
íåy
->type;

248 
c⁄Êi˘
;

252 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
, &
memty≥_li°
, 
nd
) {

253 i‡(
√w
->
íd
 <
íåy
->
°¨t
)

255 i‡(
√w
->
ty≥
 !
íåy
->type)

256 
c⁄Êi˘
;

260 
c⁄Êi˘
:

261 
	`¥ötk
(
KERN_INFO
 "%s:%d conflicting memoryÅypes "

262 "%Lx-%Lx %s<->%s\n", 
cuºít
->
comm
, cuºít->
pid
, 
√w
->
°¨t
,

263 
√w
->
íd
, 
	`ˇâr_«me
“ew->
ty≥
), c©å_«me(
íåy
->type));

264  -
EBUSY
;

265 
	}
}

267 
	$∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
)

269 
øm_∑ge
 = 0, 
nŸ_øm∑ge
 = 0;

270 
∑ge_ƒ
;

272 
∑ge_ƒ
 = (
°¨t
 >> 
PAGE_SHIFT
);Öage_ƒ < (
íd
 >> PAGE_SHIFT);

273 ++
∑ge_ƒ
) {

281 i‡(
∑ge_ƒ
 >(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

282 
	`∑ge_is_øm
(
∑ge_ƒ
))

283 
øm_∑ge
 = 1;

285 
nŸ_øm∑ge
 = 1;

287 i‡(
øm_∑ge
 =
nŸ_øm∑ge
)

291  
øm_∑ge
;

292 
	}
}

302 
	$ª£rve_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

303 *
√w_ty≥
)

305 
∑ge
 *page;

306 
u64
 
p‚
;

308 i‡(
ªq_ty≥
 =
_PAGE_CACHE_UC
) {

310 
	`WARN_ON_ONCE
(1);

311 
ªq_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

314 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

315 
ty≥
;

317 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

318 
ty≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

319 i‡(
ty≥
 != -1) {

320 
	`¥ötk
(
KERN_INFO
 "reserve_ram_pages_type failed "

322 
°¨t
, 
íd
, 
ty≥
, 
ªq_ty≥
);

323 i‡(
√w_ty≥
)

324 *
√w_ty≥
 = 
ty≥
;

326  -
EBUSY
;

330 i‡(
√w_ty≥
)

331 *
√w_ty≥
 = 
ªq_ty≥
;

333 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

334 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

335 
	`£t_∑ge_memty≥
(
∑ge
, 
ªq_ty≥
);

338 
	}
}

340 
	$‰ì_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
)

342 
∑ge
 *page;

343 
u64
 
p‚
;

345 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

346 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

347 
	`£t_∑ge_memty≥
(
∑ge
, -1);

350 
	}
}

364 
	$ª£rve_memty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

365 *
√w_ty≥
)

367 
memty≥
 *
√w
, *
íåy
;

368 
a˘uÆ_ty≥
;

369 
li°_hód
 *
whîe
;

370 
is_ønge_øm
;

371 
îr
 = 0;

373 
	`BUG_ON
(
°¨t
 >
íd
);

375 i‡(!
∑t_íabÀd
) {

377 i‡(
√w_ty≥
) {

378 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WC
)

379 *
√w_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

381 *
√w_ty≥
 = 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
;

387 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
)) {

388 i‡(
√w_ty≥
)

389 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

399 
a˘uÆ_ty≥
 = 
	`∑t_x_mår_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
);

401 i‡(
√w_ty≥
)

402 *
√w_ty≥
 = 
a˘uÆ_ty≥
;

404 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

405 i‡(
is_ønge_øm
 == 1) {

407 
	`•ö_lock
(&
memty≥_lock
);

408 
îr
 = 
	`ª£rve_øm_∑ges_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, 
√w_ty≥
);

409 
	`•ö_u∆ock
(&
memty≥_lock
);

411  
îr
;

412 } i‡(
is_ønge_øm
 < 0) {

413  -
EINVAL
;

416 
√w
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

417 i‡(!
√w
)

418  -
ENOMEM
;

420 
√w
->
°¨t
 = start;

421 
√w
->
íd
 =Énd;

422 
√w
->
ty≥
 = 
a˘uÆ_ty≥
;

424 
	`•ö_lock
(&
memty≥_lock
);

427 
whîe
 = 
NULL
;

428 
	`li°_f‹_óch_íåy
(
íåy
, &
memty≥_li°
, 
nd
) {

429 i‡(
íd
 <
íåy
->
°¨t
) {

430 
whîe
 = 
íåy
->
nd
.
¥ev
;

432 } i‡(
°¨t
 <
íåy
->start) {

433 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

434 i‡(!
îr
) {

435 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

436 
íåy
->
°¨t
,É¡ry->
íd
);

437 
whîe
 = 
íåy
->
nd
.
¥ev
;

440 } i‡(
°¨t
 < 
íåy
->
íd
) {

441 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

442 i‡(!
îr
) {

443 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

444 
íåy
->
°¨t
,É¡ry->
íd
);

450 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
,

451 &
memty≥_li°
, 
nd
) {

452 i‡(
°¨t
 <
íåy
->start) {

453 
whîe
 = 
íåy
->
nd
.
¥ev
;

462 i‡(
îr
) {

463 
	`¥ötk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

465 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
));

466 
	`k‰ì
(
√w
);

467 
	`•ö_u∆ock
(&
memty≥_lock
);

469  
îr
;

472 i‡(
whîe
)

473 
	`li°_add
(&
√w
->
nd
, 
whîe
);

475 
	`li°_add_èû
(&
√w
->
nd
, &
memty≥_li°
);

477 
	`memty≥_rb_ö£π
(&
memty≥_rbroŸ
, 
√w
);

479 
	`•ö_u∆ock
(&
memty≥_lock
);

481 
	`d¥ötk
("reserve_memtypeádded 0x%Lx-0x%Lx,Årack %s,Ñeq %s,Ñet %s\n",

482 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
),

483 
√w_ty≥
 ? 
	`ˇâr_«me
(*new_type) : "-");

485  
îr
;

486 
	}
}

488 
	$‰ì_memty≥
(
u64
 
°¨t
, u64 
íd
)

490 
memty≥
 *
íåy
, *
ßved_íåy
;

491 
îr
 = -
EINVAL
;

492 
is_ønge_øm
;

494 i‡(!
∑t_íabÀd
)

498 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
))

501 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

502 i‡(
is_ønge_øm
 == 1) {

504 
	`•ö_lock
(&
memty≥_lock
);

505 
îr
 = 
	`‰ì_øm_∑ges_ty≥
(
°¨t
, 
íd
);

506 
	`•ö_u∆ock
(&
memty≥_lock
);

508  
îr
;

509 } i‡(
is_ønge_øm
 < 0) {

510  -
EINVAL
;

513 
	`•ö_lock
(&
memty≥_lock
);

515 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
°¨t
);

516 i‡(
	`u∆ikñy
(
íåy
 =
NULL
))

517 
u∆ock_ªt
;

525 
ßved_íåy
 = 
íåy
;

526 
	`li°_f‹_óch_íåy_‰om
(
íåy
, &
memty≥_li°
, 
nd
) {

527 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

528 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

529 
	`li°_dñ
(&
íåy
->
nd
);

530 
	`k‰ì
(
íåy
);

531 
îr
 = 0;

533 } i‡(
íåy
->
°¨t
 > start) {

538 i‡(!
îr
)

539 
u∆ock_ªt
;

541 
íåy
 = 
ßved_íåy
;

542 
	`li°_f‹_óch_íåy_ªvî£
(
íåy
, &
memty≥_li°
, 
nd
) {

543 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

544 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

545 
	`li°_dñ
(&
íåy
->
nd
);

546 
	`k‰ì
(
íåy
);

547 
îr
 = 0;

549 } i‡(
íåy
->
°¨t
 < start) {

553 
u∆ock_ªt
:

554 
	`•ö_u∆ock
(&
memty≥_lock
);

556 i‡(
îr
) {

557 
	`¥ötk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

558 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
, 
íd
);

561 
	`d¥ötk
("‰ì_memty≥Ñeque° 0x%Lx-0x%Lx\n", 
°¨t
, 
íd
);

563  
îr
;

564 
	}
}

576 
	$lookup_memty≥
(
u64
 
∑ddr
)

578 
ªây≥
 = 
_PAGE_CACHE_WB
;

579 
memty≥
 *
íåy
;

581 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
))

582  
ªây≥
;

584 i‡(
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
)) {

585 
∑ge
 *page;

586 
	`•ö_lock
(&
memty≥_lock
);

587 
∑ge
 = 
	`p‚_to_∑ge
(
∑ddr
 >> 
PAGE_SHIFT
);

588 
ªây≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

589 
	`•ö_u∆ock
(&
memty≥_lock
);

594 i‡(
ªây≥
 == -1)

595 
ªây≥
 = 
_PAGE_CACHE_WB
;

597  
ªây≥
;

600 
	`•ö_lock
(&
memty≥_lock
);

602 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
∑ddr
);

603 i‡(
íåy
 !
NULL
)

604 
ªây≥
 = 
íåy
->
ty≥
;

606 
ªây≥
 = 
_PAGE_CACHE_UC_MINUS
;

608 
	`•ö_u∆ock
(&
memty≥_lock
);

609  
ªây≥
;

610 
	}
}

622 
	$io_ª£rve_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
,

623 *
ty≥
)

625 
ªsour˚_size_t
 
size
 = 
íd
 - 
°¨t
;

626 
ªq_ty≥
 = *
ty≥
;

627 
√w_ty≥
;

628 
ªt
;

630 
	`WARN_ON_ONCE
(
	`iomem_m≠_ßnôy_check
(
°¨t
, 
size
));

632 
ªt
 = 
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, &
√w_ty≥
);

633 i‡(
ªt
)

634 
out_îr
;

636 i‡(!
	`is_√w_memty≥_Ælowed
(
°¨t
, 
size
, 
ªq_ty≥
, 
√w_ty≥
))

637 
out_‰ì
;

639 i‡(
	`kî√l_m≠_sync_memty≥
(
°¨t
, 
size
, 
√w_ty≥
) < 0)

640 
out_‰ì
;

642 *
ty≥
 = 
√w_ty≥
;

645 
out_‰ì
:

646 
	`‰ì_memty≥
(
°¨t
, 
íd
);

647 
ªt
 = -
EBUSY
;

648 
out_îr
:

649  
ªt
;

650 
	}
}

657 
	$io_‰ì_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
)

659 
	`‰ì_memty≥
(
°¨t
, 
íd
);

660 
	}
}

662 
pg¥Ÿ_t
 
	$phys_mem_ac˚ss_¥Ÿ
(
fûe
 *fûe, 
p‚
,

663 
size
, 
pg¥Ÿ_t
 
vma_¥Ÿ
)

665  
vma_¥Ÿ
;

666 
	}
}

668 #ifde‡
CONFIG_STRICT_DEVMEM


670 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

673 
	}
}

676 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

678 
u64
 
‰om
 = ((u64)
p‚
Ë<< 
PAGE_SHIFT
;

679 
u64
 
to
 = 
‰om
 + 
size
;

680 
u64
 
curs‹
 = 
‰om
;

682 i‡(!
∑t_íabÀd
)

685 
curs‹
 < 
to
) {

686 i‡(!
	`devmem_is_Ælowed
(
p‚
)) {

687 
	`¥ötk
(
KERN_INFO


689 
cuºít
->
comm
, 
‰om
, 
to
);

692 
curs‹
 +
PAGE_SIZE
;

693 
p‚
++;

696 
	}
}

699 
	$phys_mem_ac˚ss_¥Ÿ_Ælowed
(
fûe
 *fûe, 
p‚
,

700 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
)

702 
Êags
 = 
_PAGE_CACHE_WB
;

704 i‡(!
	`ønge_is_Ælowed
(
p‚
, 
size
))

707 i‡(
fûe
->
f_Êags
 & 
O_DSYNC
)

708 
Êags
 = 
_PAGE_CACHE_UC_MINUS
;

710 #ifde‡
CONFIG_X86_32


719 i‡(!
∑t_íabÀd
 &&

720 !(
	`boŸ_˝u_has
(
X86_FEATURE_MTRR
) ||

721 
	`boŸ_˝u_has
(
X86_FEATURE_K6_MTRR
) ||

722 
	`boŸ_˝u_has
(
X86_FEATURE_CYRIX_ARR
) ||

723 
	`boŸ_˝u_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

724 (
p‚
 << 
PAGE_SHIFT
Ë>
	`__∑
(
high_mem‹y
)) {

725 
Êags
 = 
_PAGE_CACHE_UC
;

729 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_¥ŸË& ~
_PAGE_CACHE_MASK
) |

730 
Êags
);

732 
	}
}

738 
	$kî√l_m≠_sync_memty≥
(
u64
 
ba£
, 
size
, 
Êags
)

740 
id_sz
;

742 i‡(
ba£
 >
	`__∑
(
high_mem‹y
))

745 
id_sz
 = (
	`__∑
(
high_mem‹y
Ë< 
ba£
 + 
size
) ?

746 
	`__∑
(
high_mem‹y
Ë- 
ba£
 :

747 
size
;

749 i‡(
	`i‹em≠_ch™ge_©å
(()
	`__va
(
ba£
), 
id_sz
, 
Êags
) < 0) {

750 
	`¥ötk
(
KERN_INFO


753 
cuºít
->
comm
, cuºít->
pid
,

754 
	`ˇâr_«me
(
Êags
),

755 
ba£
, ()(ba£ + 
size
));

756  -
EINVAL
;

759 
	}
}

766 
	$ª£rve_p‚_ønge
(
u64
 
∑ddr
, 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
,

767 
°ri˘_¥Ÿ
)

769 
is_øm
 = 0;

770 
ªt
;

771 
w™t_Êags
 = (
	`pg¥Ÿ_vÆ
(*
vma_¥Ÿ
Ë& 
_PAGE_CACHE_MASK
);

772 
Êags
 = 
w™t_Êags
;

774 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

781 i‡(
is_øm
) {

782 i‡(!
∑t_íabÀd
)

785 
Êags
 = 
	`lookup_memty≥
(
∑ddr
);

786 i‡(
w™t_Êags
 !
Êags
) {

787 
	`¥ötk
(
KERN_WARNING


789 
cuºít
->
comm
, cuºít->
pid
,

790 
	`ˇâr_«me
(
w™t_Êags
),

791 ()
∑ddr
,

792 ()(
∑ddr
 + 
size
),

793 
	`ˇâr_«me
(
Êags
));

794 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

795 (~
_PAGE_CACHE_MASK
)) |

796 
Êags
);

801 
ªt
 = 
	`ª£rve_memty≥
(
∑ddr
,Öadd∏+ 
size
, 
w™t_Êags
, &
Êags
);

802 i‡(
ªt
)

803  
ªt
;

805 i‡(
Êags
 !
w™t_Êags
) {

806 i‡(
°ri˘_¥Ÿ
 ||

807 !
	`is_√w_memty≥_Ælowed
(
∑ddr
, 
size
, 
w™t_Êags
, 
Êags
)) {

808 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

809 
	`¥ötk
(
KERN_ERR
 "%s:%d mapÖfnÉxpected mappingÅype %s"

811 
cuºít
->
comm
, cuºít->
pid
,

812 
	`ˇâr_«me
(
w™t_Êags
),

813 ()
∑ddr
,

814 ()(
∑ddr
 + 
size
),

815 
	`ˇâr_«me
(
Êags
));

816  -
EINVAL
;

822 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

823 (~
_PAGE_CACHE_MASK
)) |

824 
Êags
);

827 i‡(
	`kî√l_m≠_sync_memty≥
(
∑ddr
, 
size
, 
Êags
) < 0) {

828 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

829  -
EINVAL
;

832 
	}
}

838 
	$‰ì_p‚_ønge
(
u64
 
∑ddr
, 
size
)

840 
is_øm
;

842 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

843 i‡(
is_øm
 == 0)

844 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

845 
	}
}

854 
	$åack_p‚_vma_c›y
(
vm_¨ó_°ru˘
 *
vma
)

856 
ªsour˚_size_t
 
∑ddr
;

857 
¥Ÿ
;

858 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

859 
pg¥Ÿ_t
 
pg¥Ÿ
;

861 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

866 i‡(
	`fﬁlow_phys
(
vma
, vma->
vm_°¨t
, 0, &
¥Ÿ
, &
∑ddr
)) {

867 
	`WARN_ON_ONCE
(1);

868  -
EINVAL
;

870 
pg¥Ÿ
 = 
	`__pg¥Ÿ
(
¥Ÿ
);

871  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, &
pg¥Ÿ
, 1);

875 
	}
}

885 
	$åack_p‚_vma_√w
(
vm_¨ó_°ru˘
 *
vma
, 
pg¥Ÿ_t
 *
¥Ÿ
,

886 
p‚
, 
size
)

888 
Êags
;

889 
ªsour˚_size_t
 
∑ddr
;

890 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

892 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

894 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

895  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, 
¥Ÿ
, 0);

898 i‡(!
∑t_íabÀd
)

902 
Êags
 = 
	`lookup_memty≥
(
p‚
 << 
PAGE_SHIFT
);

903 *
¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
Ë& (~
_PAGE_CACHE_MASK
)) |

904 
Êags
);

907 
	}
}

914 
	$u¡øck_p‚_vma
(
vm_¨ó_°ru˘
 *
vma
, 
p‚
,

915 
size
)

917 
ªsour˚_size_t
 
∑ddr
;

918 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

920 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

922 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

923 
	`‰ì_p‚_ønge
(
∑ddr
, 
vma_size
);

926 
	}
}

928 
pg¥Ÿ_t
 
	$pg¥Ÿ_wrôecomböe
(
pg¥Ÿ_t
 
¥Ÿ
)

930 i‡(
∑t_íabÀd
)

931  
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_CACHE_WC
);

933  
	`pg¥Ÿ_n⁄ˇched
(
¥Ÿ
);

934 
	}
}

935 
EXPORT_SYMBOL_GPL
(
pg¥Ÿ_wrôecomböe
);

937 #i‡
deföed
(
CONFIG_DEBUG_FS
Ë&& deföed(
CONFIG_X86_PAT
)

940 
memty≥
 *
	$memty≥_gë_idx
(
loff_t
 
pos
)

942 
memty≥
 *
li°_node
, *
¥öt_íåy
;

943 
i
 = 1;

945 
¥öt_íåy
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

946 i‡(!
¥öt_íåy
)

947  
NULL
;

949 
	`•ö_lock
(&
memty≥_lock
);

950 
	`li°_f‹_óch_íåy
(
li°_node
, &
memty≥_li°
, 
nd
) {

951 i‡(
pos
 =
i
) {

952 *
¥öt_íåy
 = *
li°_node
;

953 
	`•ö_u∆ock
(&
memty≥_lock
);

954  
¥öt_íåy
;

956 ++
i
;

958 
	`•ö_u∆ock
(&
memty≥_lock
);

959 
	`k‰ì
(
¥öt_íåy
);

961  
NULL
;

962 
	}
}

964 *
	$memty≥_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

966 i‡(*
pos
 == 0) {

967 ++*
pos
;

968 
	`£q_¥ötf
(
£q
, "PAT memtypeÜist:\n");

971  
	`memty≥_gë_idx
(*
pos
);

972 
	}
}

974 *
	$memty≥_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

976 ++*
pos
;

977  
	`memty≥_gë_idx
(*
pos
);

978 
	}
}

980 
	$memty≥_£q_°›
(
£q_fûe
 *
£q
, *
v
)

982 
	}
}

984 
	$memty≥_£q_show
(
£q_fûe
 *
£q
, *
v
)

986 
memty≥
 *
¥öt_íåy
 = (memty≥ *)
v
;

988 
	`£q_¥ötf
(
£q
, "%†@ 0x%Lx-0x%Lx\n", 
	`ˇâr_«me
(
¥öt_íåy
->
ty≥
),

989 
¥öt_íåy
->
°¨t
,Öröt_íåy->
íd
);

990 
	`k‰ì
(
¥öt_íåy
);

993 
	}
}

995 c⁄° 
£q_›î©i⁄s
 
	gmemty≥_£q_›s
 = {

996 .
°¨t
 = 
memty≥_£q_°¨t
,

997 .
	g√xt
 = 
memty≥_£q_√xt
,

998 .
	g°›
 = 
memty≥_£q_°›
,

999 .
	gshow
 = 
memty≥_£q_show
,

1002 
	$memty≥_£q_›í
(
öode
 *öode, 
fûe
 *file)

1004  
	`£q_›í
(
fûe
, &
memty≥_£q_›s
);

1005 
	}
}

1007 c⁄° 
fûe_›î©i⁄s
 
	gmemty≥_f›s
 = {

1008 .
›í
 = 
memty≥_£q_›í
,

1009 .
	gªad
 = 
£q_ªad
,

1010 .
	gŒ£ek
 = 
£q_l£ek
,

1011 .
	gªÀa£
 = 
£q_ªÀa£
,

1014 
__öô
 
	$∑t_memty≥_li°_öô
()

1016 i‡(
∑t_íabÀd
) {

1017 
	`debugfs_¸óã_fûe
("∑t_memty≥_li°", 
S_IRUSR
,

1018 
¨ch_debugfs_dú
, 
NULL
, &
memty≥_f›s
);

1021 
	}
}

1023 
œã_öôˇŒ
(
∑t_memty≥_li°_öô
);

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<löux/mm.h
>

2 
	~<asm/pgÆloc.h
>

3 
	~<asm/pgèbÀ.h
>

4 
	~<asm/éb.h
>

5 
	~<asm/fixm≠.h
>

7 
	#PGALLOC_GFP
 
GFP_KERNEL
 | 
__GFP_NOTRACK
 | 
__GFP_REPEAT
 | 
__GFP_ZERO


	)

9 
±e_t
 *
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

11  (
±e_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

12 
	}
}

14 
pgèbÀ_t
 
	$±e_Æloc_⁄e
(
mm_°ru˘
 *
mm
, 
addªss
)

16 
∑ge
 *
±e
;

18 #ifde‡
CONFIG_HIGHPTE


19 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
 | 
__GFP_HIGHMEM
, 0);

21 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
, 0);

23 i‡(
±e
)

24 
	`pgèbÀ_∑ge_˘‹
(
±e
);

25  
±e
;

26 
	}
}

28 
	$___±e_‰ì_éb
(
mmu_g©hî
 *
éb
, 
∑ge
 *
±e
)

30 
	`pgèbÀ_∑ge_dt‹
(
±e
);

31 
	`∑øvút_ªÀa£_±e
(
	`∑ge_to_p‚
(
±e
));

32 
	`éb_ªmove_∑ge
(
éb
, 
±e
);

33 
	}
}

35 #i‡
PAGETABLE_LEVELS
 > 2

36 
	$___pmd_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pmd_t
 *
pmd
)

38 
	`∑øvút_ªÀa£_pmd
(
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

39 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pmd
));

40 
	}
}

42 #i‡
PAGETABLE_LEVELS
 > 3

43 
	$___pud_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pud_t
 *
pud
)

45 
	`∑øvút_ªÀa£_pud
(
	`__∑
(
pud
Ë>> 
PAGE_SHIFT
);

46 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pud
));

47 
	}
}

51 
ölöe
 
	$pgd_li°_add
(
pgd_t
 *
pgd
)

53 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

55 
	`li°_add
(&
∑ge
->
Ãu
, &
pgd_li°
);

56 
	}
}

58 
ölöe
 
	$pgd_li°_dñ
(
pgd_t
 *
pgd
)

60 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

62 
	`li°_dñ
(&
∑ge
->
Ãu
);

63 
	}
}

65 
	#UNSHARED_PTRS_PER_PGD
 \

66 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

68 
	$pgd_˘‹
(
pgd_t
 *
pgd
)

73 i‡(
PAGETABLE_LEVELS
 == 2 ||

74 (
PAGETABLE_LEVELS
 =3 && 
SHARED_KERNEL_PMD
) ||

75 
PAGETABLE_LEVELS
 == 4) {

76 
	`˛⁄e_pgd_ønge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

77 
sw≠≥r_pg_dú
 + 
KERNEL_PGD_BOUNDARY
,

78 
KERNEL_PGD_PTRS
);

79 
	`∑øvút_Æloc_pmd_˛⁄e
(
	`__∑
(
pgd
Ë>> 
PAGE_SHIFT
,

80 
	`__∑
(
sw≠≥r_pg_dú
Ë>> 
PAGE_SHIFT
,

81 
KERNEL_PGD_BOUNDARY
,

82 
KERNEL_PGD_PTRS
);

86 i‡(!
SHARED_KERNEL_PMD
)

87 
	`pgd_li°_add
(
pgd
);

88 
	}
}

90 
	$pgd_dt‹
(
pgd_t
 *
pgd
)

92 
Êags
;

94 i‡(
SHARED_KERNEL_PMD
)

97 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

98 
	`pgd_li°_dñ
(
pgd
);

99 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

100 
	}
}

113 #ifde‡
CONFIG_X86_PAE


125 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

127 
	$pud_p›uœã
(
mm_°ru˘
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

129 
	`∑øvút_Æloc_pmd
(
mm
, 
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

133 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_PAGE_PRESENT
));

141 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

142 
	`wrôe_¸3
(
	`ªad_¸3
());

143 
	}
}

147 
	#PREALLOCATED_PMDS
 0

	)

151 
	$‰ì_pmds
(
pmd_t
 *
pmds
[])

153 
i
;

155 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

156 i‡(
pmds
[
i
])

157 
	`‰ì_∑ge
(()
pmds
[
i
]);

158 
	}
}

160 
	$¥óŒoˇã_pmds
(
pmd_t
 *
pmds
[])

162 
i
;

163 
boﬁ
 
Áûed
 = 
Ál£
;

165 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

166 
pmd_t
 *
pmd
 = (pmd_à*)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

167 i‡(
pmd
 =
NULL
)

168 
Áûed
 = 
åue
;

169 
pmds
[
i
] = 
pmd
;

172 i‡(
Áûed
) {

173 
	`‰ì_pmds
(
pmds
);

174  -
ENOMEM
;

178 
	}
}

186 
	$pgd_m›_up_pmds
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgdp
)

188 
i
;

190 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

191 
pgd_t
 
pgd
 = 
pgdp
[
i
];

193 i‡(
	`pgd_vÆ
(
pgd
) != 0) {

194 
pmd_t
 *
pmd
 = (pmd_à*)
	`pgd_∑ge_vaddr
(
pgd
);

196 
pgdp
[
i
] = 
	`«tive_make_pgd
(0);

198 
	`∑øvút_ªÀa£_pmd
(
	`pgd_vÆ
(
pgd
Ë>> 
PAGE_SHIFT
);

199 
	`pmd_‰ì
(
mm
, 
pmd
);

202 
	}
}

204 
	$pgd_¥ï›uœã_pmd
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

206 
pud_t
 *
pud
;

207 
addr
;

208 
i
;

210 i‡(
PREALLOCATED_PMDS
 == 0)

213 
pud
 = 
	`pud_off£t
(
pgd
, 0);

215 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

216 
i
++, 
pud
++, 
addr
 +
PUD_SIZE
) {

217 
pmd_t
 *
pmd
 = 
pmds
[
i
];

219 i‡(
i
 >
KERNEL_PGD_BOUNDARY
)

220 
	`mem˝y
(
pmd
, (
pmd_t
 *)
	`pgd_∑ge_vaddr
(
sw≠≥r_pg_dú
[
i
]),

221 (
pmd_t
Ë* 
PTRS_PER_PMD
);

223 
	`pud_p›uœã
(
mm
, 
pud
, 
pmd
);

225 
	}
}

227 
pgd_t
 *
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

229 
pgd_t
 *
pgd
;

230 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

231 
Êags
;

233 
pgd
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

235 i‡(
pgd
 =
NULL
)

236 
out
;

238 
mm
->
pgd
 =Ögd;

240 i‡(
	`¥óŒoˇã_pmds
(
pmds
) != 0)

241 
out_‰ì_pgd
;

243 i‡(
	`∑øvút_pgd_Æloc
(
mm
) != 0)

244 
out_‰ì_pmds
;

251 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

253 
	`pgd_˘‹
(
pgd
);

254 
	`pgd_¥ï›uœã_pmd
(
mm
, 
pgd
, 
pmds
);

256 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

258  
pgd
;

260 
out_‰ì_pmds
:

261 
	`‰ì_pmds
(
pmds
);

262 
out_‰ì_pgd
:

263 
	`‰ì_∑ge
(()
pgd
);

264 
out
:

265  
NULL
;

266 
	}
}

268 
	$pgd_‰ì
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
)

270 
	`pgd_m›_up_pmds
(
mm
, 
pgd
);

271 
	`pgd_dt‹
(
pgd
);

272 
	`∑øvút_pgd_‰ì
(
mm
, 
pgd
);

273 
	`‰ì_∑ge
(()
pgd
);

274 
	}
}

276 
	$±ï_£t_ac˚ss_Êags
(
vm_¨ó_°ru˘
 *
vma
,

277 
addªss
, 
±e_t
 *
±ï
,

278 
±e_t
 
íåy
, 
dúty
)

280 
ch™ged
 = !
	`±e_ßme
(*
±ï
, 
íåy
);

282 i‡(
ch™ged
 && 
dúty
) {

283 *
±ï
 = 
íåy
;

284 
	`±e_upd©e_de„r
(
vma
->
vm_mm
, 
addªss
, 
±ï
);

285 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

288  
ch™ged
;

289 
	}
}

291 
	$±ï_ã°_™d_˛ór_young
(
vm_¨ó_°ru˘
 *
vma
,

292 
addr
, 
±e_t
 *
±ï
)

294 
ªt
 = 0;

296 i‡(
	`±e_young
(*
±ï
))

297 
ªt
 = 
	`ã°_™d_˛ór_bô
(
_PAGE_BIT_ACCESSED
,

298 (*Ë&
±ï
->
±e
);

300 i‡(
ªt
)

301 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±ï
);

303  
ªt
;

304 
	}
}

306 
	$±ï_˛ór_Êush_young
(
vm_¨ó_°ru˘
 *
vma
,

307 
addªss
, 
±e_t
 *
±ï
)

309 
young
;

311 
young
 = 
	`±ï_ã°_™d_˛ór_young
(
vma
, 
addªss
, 
±ï
);

312 i‡(
young
)

313 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

315  
young
;

316 
	}
}

325 
__öô
 
	$ª£rve_t›_addªss
(
ª£rve
)

327 #ifde‡
CONFIG_X86_32


328 
	`BUG_ON
(
fixm≠s_£t
 > 0);

329 
	`¥ötk
(
KERN_INFO
 "Reserving virtualáddress spaceábove 0x%08x\n",

330 ()-
ª£rve
);

331 
__FIXADDR_TOP
 = -
ª£rve
 - 
PAGE_SIZE
;

333 
	}
}

335 
	gfixm≠s_£t
;

337 
	$__«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
±e_t
 
±e
)

339 
addªss
 = 
	`__fix_to_vút
(
idx
);

341 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

342 
	`BUG
();

345 
	`£t_±e_vaddr
(
addªss
, 
±e
);

346 
fixm≠s_£t
++;

347 
	}
}

349 
	$«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
phys_addr_t
 
phys
,

350 
pg¥Ÿ_t
 
Êags
)

352 
	`__«tive_£t_fixm≠
(
idx
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

353 
	}
}

	@/cmpt816/linux/arch/x86/mm/physaddr.c

1 
	~<löux/mmdebug.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/∑ge.h
>

7 
	~"phyßddr.h
"

9 #ifde‡
CONFIG_X86_64


11 
	$__phys_addr
(
x
)

13 i‡(
x
 >
__START_KERNEL_m≠
) {

14 
x
 -
__START_KERNEL_m≠
;

15 
	`VIRTUAL_BUG_ON
(
x
 >
KERNEL_IMAGE_SIZE
);

16 
x
 +
phys_ba£
;

18 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

19 
x
 -
PAGE_OFFSET
;

20 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_vÆid
(
x
));

22  
x
;

23 
	}
}

24 
EXPORT_SYMBOL
(
__phys_addr
);

26 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

28 i‡(
x
 >
__START_KERNEL_m≠
) {

29 
x
 -
__START_KERNEL_m≠
;

30 i‡(
x
 >
KERNEL_IMAGE_SIZE
)

31  
Ál£
;

32 
x
 +
phys_ba£
;

34 i‡(
x
 < 
PAGE_OFFSET
)

35  
Ál£
;

36 
x
 -
PAGE_OFFSET
;

37 i‡(!
	`phys_addr_vÆid
(
x
))

38  
Ál£
;

41  
	`p‚_vÆid
(
x
 >> 
PAGE_SHIFT
);

42 
	}
}

43 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

47 #ifde‡
CONFIG_DEBUG_VIRTUAL


48 
	$__phys_addr
(
x
)

51 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

52 
	`VIRTUAL_BUG_ON
(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
));

53  
x
 - 
PAGE_OFFSET
;

54 
	}
}

55 
EXPORT_SYMBOL
(
__phys_addr
);

58 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

60 i‡(
x
 < 
PAGE_OFFSET
)

61  
Ál£
;

62 i‡(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
))

63  
Ál£
;

64 i‡(
x
 >
FIXADDR_START
)

65  
Ál£
;

66  
	`p‚_vÆid
((
x
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

	@/cmpt816/linux/arch/x86/mm/setup_nx.c

1 
	~<löux/•ölock.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/pgèbÀ.h
>

6 
	~<asm/¥Ÿo.h
>

8 
dißbÀ_nx
 
	g__˝uöôd©a
;

18 
__öô
 
	$n€xec_£tup
(*
°r
)

20 i‡(!
°r
)

21  -
EINVAL
;

22 i‡(!
	`°∫cmp
(
°r
, "on", 2)) {

23 
dißbÀ_nx
 = 0;

24 } i‡(!
	`°∫cmp
(
°r
, "off", 3)) {

25 
dißbÀ_nx
 = 1;

27 
	`x86_c⁄figuª_nx
();

29 
	}
}

30 
óæy_∑øm
("n€xec", 
n€xec_£tup
);

32 
__˝uöô
 
	$x86_c⁄figuª_nx
()

34 i‡(
˝u_has_nx
 && !
dißbÀ_nx
)

35 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

37 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

38 
	}
}

40 
__öô
 
	$x86_ªp‹t_nx
()

42 i‡(!
˝u_has_nx
) {

43 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

46 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

47 i‡(
dißbÀ_nx
) {

48 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

51 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

56 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

60 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/mmz⁄e.h
>

15 
	~<löux/bôm≠.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/t›ﬁogy.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/mm.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/uv/uv.h
>

26 
a˝i_numa
 
	g__öôd©a
;

28 
a˝i_èbÀ_¶ô
 *
	ga˝i_¶ô
;

30 
nodemask_t
 
nodes_∑r£d
 
	g__öôd©a
;

31 
nodemask_t
 
˝u_nodes_∑r£d
 
	g__öôd©a
;

32 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

33 
boŸnode
 
	gnodes_add
[
MAX_NUMNODES
];

35 
num_node_memblks
 
	g__öôd©a
;

36 
boŸnode
 
	gnode_memblk_ønge
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

37 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

39 
__öô
 
	$£tup_node
(
pxm
)

41  
	`a˝i_m≠_pxm_to_node
(
pxm
);

42 
	}
}

44 
__öô
 
	$c⁄Êi˘ög_memblks
(
°¨t
, 
íd
)

46 
i
;

47 
i
 = 0; i < 
num_node_memblks
; i++) {

48 
boŸnode
 *
nd
 = &
node_memblk_ønge
[
i
];

49 i‡(
nd
->
°¨t
 =nd->
íd
)

51 i‡(
nd
->
íd
 > 
°¨t
 &&Çd->start <Énd)

52  
memblk_nodeid
[
i
];

53 i‡(
nd
->
íd
 =íd &&Çd->
°¨t
 == start)

54  
memblk_nodeid
[
i
];

57 
	}
}

59 
__öô
 
	$cutoff_node
(
i
, 
°¨t
, 
íd
)

61 
boŸnode
 *
nd
 = &
nodes
[
i
];

63 i‡(
nd
->
°¨t
 < start) {

64 
nd
->
°¨t
 = start;

65 i‡(
nd
->
íd
 <Çd->
°¨t
)

66 
nd
->
°¨t
 =Çd->
íd
;

68 i‡(
nd
->
íd
 >Énd) {

69 
nd
->
íd
 =Énd;

70 i‡(
nd
->
°¨t
 >Çd->
íd
)

71 
nd
->
°¨t
 =Çd->
íd
;

73 
	}
}

75 
__öô
 
	$bad_§©
()

77 
i
;

78 
	`¥ötk
(
KERN_ERR
 "SRAT: SRATÇot used.\n");

79 
a˝i_numa
 = -1;

80 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

81 
≠icid_to_node
[
i
] = 
NUMA_NO_NODE
;

82 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

83 
nodes
[
i
].
°¨t
 =Çodes[i].
íd
 = 0;

84 
nodes_add
[
i
].
°¨t
 =Çodes_add[i].
íd
 = 0;

86 
	`ªmove_Æl_a˘ive_ønges
();

87 
	}
}

89 
__öô
 
ölöe
 
	$§©_dißbÀd
()

91  
numa_off
 || 
a˝i_numa
 < 0;

92 
	}
}

95 
__öô
 
	$a˝i_numa_¶ô_öô
(
a˝i_èbÀ_¶ô
 *
¶ô
)

97 
Àngth
;

98 
phys
;

100 
Àngth
 = 
¶ô
->
hódî
.length;

101 
phys
 = 
	`föd_e820_¨ó
(0, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
, 
Àngth
,

102 
PAGE_SIZE
);

104 i‡(
phys
 == -1L)

105 
	`∑nic
(" CanÇot save slit!\n");

107 
a˝i_¶ô
 = 
	`__va
(
phys
);

108 
	`mem˝y
(
a˝i_¶ô
, 
¶ô
, 
Àngth
);

109 
	`ª£rve_óæy
(
phys
,Öhy†+ 
Àngth
, "ACPI SLIT");

110 
	}
}

113 
__öô


114 
	$a˝i_numa_x2≠ic_afföôy_öô
(
a˝i_§©_x2≠ic_˝u_afföôy
 *
∑
)

116 
pxm
, 
node
;

117 
≠ic_id
;

119 i‡(
	`§©_dißbÀd
())

121 i‡(
∑
->
hódî
.
Àngth
 < (
a˝i_§©_x2≠ic_˝u_afföôy
)) {

122 
	`bad_§©
();

125 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

127 
pxm
 = 
∑
->
¥oximôy_domaö
;

128 
node
 = 
	`£tup_node
(
pxm
);

129 i‡(
node
 < 0) {

130 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

131 
	`bad_§©
();

135 
≠ic_id
 = 
∑
->apic_id;

136 
≠icid_to_node
[
≠ic_id
] = 
node
;

137 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

138 
a˝i_numa
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%04x -> Node %u\n",

140 
pxm
, 
≠ic_id
, 
node
);

141 
	}
}

144 
__öô


145 
	$a˝i_numa_¥o˚ss‹_afföôy_öô
(
a˝i_§©_˝u_afföôy
 *
∑
)

147 
pxm
, 
node
;

148 
≠ic_id
;

150 i‡(
	`§©_dißbÀd
())

152 i‡(
∑
->
hódî
.
Àngth
 !(
a˝i_§©_˝u_afföôy
)) {

153 
	`bad_§©
();

156 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

158 
pxm
 = 
∑
->
¥oximôy_domaö_lo
;

159 
node
 = 
	`£tup_node
(
pxm
);

160 i‡(
node
 < 0) {

161 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

162 
	`bad_§©
();

166 i‡(
	`gë_uv_sy°em_ty≥
(Ë>
UV_X2APIC
)

167 
≠ic_id
 = (
∑
->≠ic_id << 8Ë|Öa->
loˇl_ßpic_eid
;

169 
≠ic_id
 = 
∑
->apic_id;

170 
≠icid_to_node
[
≠ic_id
] = 
node
;

171 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

172 
a˝i_numa
 = 1;

173 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%02x -> Node %u\n",

174 
pxm
, 
≠ic_id
, 
node
);

175 
	}
}

177 #ifde‡
CONFIG_MEMORY_HOTPLUG_SPARSE


178 
ölöe
 
	$ßve_add_öfo
(Ë{ 1;
	}
}

180 
ölöe
 
	$ßve_add_öfo
(Ë{ 0;
	}
}

186 
__öô


187 
	$upd©e_nodes_add
(
node
, 
°¨t
, 
íd
)

189 
s_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

190 
e_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

191 
ch™ged
 = 0;

192 
boŸnode
 *
nd
 = &
nodes_add
[
node
];

200 i‡((sig√d )(
íd
 - 
°¨t
Ë< 
NODE_MIN_SIZE
) {

201 
	`¥ötk
(
KERN_ERR
 "SRAT: HotplugáreaÅoo small\n");

206 i‡(
	`ab£¡_∑ges_ö_ønge
(
s_p‚
, 
e_p‚
) !=É_pfn - s_pfn) {

207 
	`¥ötk
(
KERN_ERR


209 
s_p‚
, 
e_p‚
);

215 i‡(
nd
->
°¨t
 =nd->
íd
) {

216 
nd
->
°¨t
 = start;

217 
nd
->
íd
 =Énd;

218 
ch™ged
 = 1;

220 i‡(
nd
->
°¨t
 =
íd
) {

221 
nd
->
°¨t
 = start;

222 
ch™ged
 = 1;

224 i‡(
nd
->
íd
 =
°¨t
) {

225 
nd
->
íd
 =Énd;

226 
ch™ged
 = 1;

228 i‡(!
ch™ged
)

229 
	`¥ötk
(
KERN_ERR
 "SRAT: Hotplug zoneÇot continuous. Partly ignored\n");

232 i‡(
ch™ged
) {

233 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

234 
	`¥ötk
(
KERN_INFO
 "SRAT: hotÖlug zone found %Lx - %Lx\n",

235 
nd
->
°¨t
,Çd->
íd
);

237 
	}
}

240 
__öô


241 
	$a˝i_numa_mem‹y_afföôy_öô
(
a˝i_§©_mem_afföôy
 *
ma
)

243 
boŸnode
 *
nd
, 
ﬁdnode
;

244 
°¨t
, 
íd
;

245 
node
, 
pxm
;

246 
i
;

248 i‡(
	`§©_dißbÀd
())

250 i‡(
ma
->
hódî
.
Àngth
 !(
a˝i_§©_mem_afföôy
)) {

251 
	`bad_§©
();

254 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

257 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
Ë&& !
	`ßve_add_öfo
())

259 
°¨t
 = 
ma
->
ba£_addªss
;

260 
íd
 = 
°¨t
 + 
ma
->
Àngth
;

261 
pxm
 = 
ma
->
¥oximôy_domaö
;

262 
node
 = 
	`£tup_node
(
pxm
);

263 i‡(
node
 < 0) {

264 
	`¥ötk
(
KERN_ERR
 "SRAT: Too manyÖroximity domains.\n");

265 
	`bad_§©
();

268 
i
 = 
	`c⁄Êi˘ög_memblks
(
°¨t
, 
íd
);

269 i‡(
i
 =
node
) {

270 
	`¥ötk
(
KERN_WARNING


272 
pxm
, 
°¨t
, 
íd
, 
nodes
[
i
].start,Çodes[i].end);

273 } i‡(
i
 >= 0) {

274 
	`¥ötk
(
KERN_ERR


276 
pxm
, 
°¨t
, 
íd
, 
	`node_to_pxm
(
i
),

277 
nodes
[
i
].
°¨t
,Çodes[i].
íd
);

278 
	`bad_§©
();

281 
nd
 = &
nodes
[
node
];

282 
ﬁdnode
 = *
nd
;

283 i‡(!
	`node_ã°_™d_£t
(
node
, 
nodes_∑r£d
)) {

284 
nd
->
°¨t
 = start;

285 
nd
->
íd
 =Énd;

287 i‡(
°¨t
 < 
nd
->start)

288 
nd
->
°¨t
 = start;

289 i‡(
nd
->
íd
 <Énd)

290 
nd
->
íd
 =Énd;

293 
	`¥ötk
(
KERN_INFO
 "SRAT: Nodê%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

294 
°¨t
, 
íd
);

296 i‡(
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) {

297 
	`upd©e_nodes_add
(
node
, 
°¨t
, 
íd
);

299 *
nd
 = 
ﬁdnode
;

300 i‡((
nd
->
°¨t
 |Çd->
íd
) == 0)

301 
	`node_˛ór
(
node
, 
nodes_∑r£d
);

304 
node_memblk_ønge
[
num_node_memblks
].
°¨t
 = start;

305 
node_memblk_ønge
[
num_node_memblks
].
íd
 =Énd;

306 
memblk_nodeid
[
num_node_memblks
] = 
node
;

307 
num_node_memblks
++;

308 
	}
}

312 
__öô
 
	$nodes_covî_mem‹y
(c⁄° 
boŸnode
 *
nodes
)

314 
i
;

315 
pxmøm
, 
e820øm
;

317 
pxmøm
 = 0;

318 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

319 
s
 = 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
;

320 
e
 = 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
;

321 
pxmøm
 +
e
 - 
s
;

322 
pxmøm
 -
	`__ab£¡_∑ges_ö_ønge
(
i
, 
s
, 
e
);

323 i‡(()
pxmøm
 < 0)

324 
pxmøm
 = 0;

327 
e820øm
 = 
max_p‚
 - (
	`e820_hﬁe_size
(0, max_p‚<<
PAGE_SHIFT
)>>PAGE_SHIFT);

329 i‡(()(
e820øm
 - 
pxmøm
Ë>(1<<(20 - 
PAGE_SHIFT
))) {

330 
	`¥ötk
(
KERN_ERR


332 (
pxmøm
 << 
PAGE_SHIFT
) >> 20,

333 (
e820øm
 << 
PAGE_SHIFT
) >> 20);

337 
	}
}

339 
__öô
 
	$a˝i_numa_¨ch_fixup
(Ë{
	}
}

341 
__öô
 
	$a˝i_gë_nodes
(
boŸnode
 *
phy¢odes
)

343 
i
;

344 
ªt
 = 0;

346 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

347 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

348 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

349 
ªt
++;

351  
ªt
;

352 
	}
}

355 
__öô
 
	$a˝i_sˇn_nodes
(
°¨t
, 
íd
)

357 
i
;

359 i‡(
a˝i_numa
 <= 0)

363 
i
 = 0; i < 
MAX_NUMNODES
; i++)

364 
	`cutoff_node
(
i
, 
°¨t
, 
íd
);

366 
memnode_shi·
 = 
	`compuã_hash_shi·
(
node_memblk_ønge
, 
num_node_memblks
,

367 
memblk_nodeid
);

368 i‡(
memnode_shi·
 < 0) {

369 
	`¥ötk
(
KERN_ERR


371 
	`bad_§©
();

375 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
)

376 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

377 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

379 
	`s‹t_node_m≠
();

380 i‡(!
	`nodes_covî_mem‹y
(
nodes
)) {

381 
	`bad_§©
();

386 
	`nodes_‹
(
node_possibÀ_m≠
, 
nodes_∑r£d
, 
˝u_nodes_∑r£d
);

389 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

390 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

393 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

394 i‡(!
	`node_⁄löe
(
i
))

395 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

397 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

398 
node
 = 
	`óæy_˝u_to_node
(
i
);

400 i‡(
node
 =
NUMA_NO_NODE
)

402 i‡(!
	`node_⁄löe
(
node
))

403 
	`numa_˛ór_node
(
i
);

405 
	`numa_öô_¨øy
();

407 
	}
}

409 #ifde‡
CONFIG_NUMA_EMU


410 
	gÁke_node_to_pxm_m≠
[
MAX_NUMNODES
] 
	g__öôd©a
 = {

411 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


413 
s16
 
	gÁke_≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__öôd©a
 = {

414 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


416 
__öô
 
	$föd_node_by_addr
(
addr
)

418 
ªt
 = 
NUMA_NO_NODE
;

419 
i
;

421 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

427 i‡(
addr
 >
nodes
[
i
].
°¨t
 &&ádd∏<Çodes[i].
íd
) {

428 
ªt
 = 
i
;

432  
ªt
;

433 
	}
}

443 
__öô
 
	$a˝i_Áke_nodes
(c⁄° 
boŸnode
 *
Áke_nodes
, 
num_nodes
)

445 
i
, 
j
;

447 
	`¥ötk
(
KERN_INFO
 "Faking PXMáffinity for fakeÇodes onÑeal "

449 
i
 = 0; i < 
num_nodes
; i++) {

450 
nid
, 
pxm
;

452 
nid
 = 
	`föd_node_by_addr
(
Áke_nodes
[
i
].
°¨t
);

453 i‡(
nid
 =
NUMA_NO_NODE
)

455 
pxm
 = 
	`node_to_pxm
(
nid
);

456 i‡(
pxm
 =
PXM_INVAL
)

458 
Áke_node_to_pxm_m≠
[
i
] = 
pxm
;

463 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

464 i‡(
≠icid_to_node
[
j
] =
nid
)

465 
Áke_≠icid_to_node
[
j
] = 
i
;

467 
i
 = 0; i < 
num_nodes
; i++)

468 
	`__a˝i_m≠_pxm_to_node
(
Áke_node_to_pxm_m≠
[
i
], i);

469 
	`mem˝y
(
≠icid_to_node
, 
Áke_≠icid_to_node
, (apicid_to_node));

471 
	`nodes_˛ór
(
nodes_∑r£d
);

472 
i
 = 0; i < 
num_nodes
; i++)

473 i‡(
Áke_nodes
[
i
].
°¨t
 !Áke_nodes[i].
íd
)

474 
	`node_£t
(
i
, 
nodes_∑r£d
);

475 
	}
}

477 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

479  
	`node_to_pxm
(
a
Ë=node_to_pxm(
b
);

480 
	}
}

482 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

484  
a
 =
b
;

485 
	}
}

488 
	$__node_di°™˚
(
a
, 
b
)

490 
ödex
;

492 i‡(!
a˝i_¶ô
)

493  
	`nuŒ_¶ô_node_com∑ª
(
a
, 
b
Ë? 
LOCAL_DISTANCE
 :

494 
REMOTE_DISTANCE
;

495 
ödex
 = 
a˝i_¶ô
->
loˇlôy_cou¡
 * 
	`node_to_pxm
(
a
);

496  
a˝i_¶ô
->
íåy
[
ödex
 + 
	`node_to_pxm
(
b
)];

497 
	}
}

499 
EXPORT_SYMBOL
(
__node_di°™˚
);

501 #i‡
deföed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
Ë|| deföed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

502 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

504 
i
, 
ªt
 = 0;

506 
	`f‹_óch_node
(
i
)

507 i‡(
nodes_add
[
i
].
°¨t
 <°¨à&&Çodes_add[i].
íd
 > start)

508 
ªt
 = 
i
;

510  
ªt
;

511 
	}
}

512 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<löux/öô.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/•ölock.h
>

5 
	~<löux/smp.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/moduÀ.h
>

9 
	~<asm/ébÊush.h
>

10 
	~<asm/mmu_c⁄ãxt.h
>

11 
	~<asm/ˇche.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/uv/uv.h
>

15 
DEFINE_PER_CPU_SHARED_ALIGNED
(
éb_°©e
, 
˝u_éb°©e
)

16 { &
öô_mm
, 0, };

40 
	usmp_Êush_°©e
 {

42 
mm_°ru˘
 *
	mÊush_mm
;

43 
	mÊush_va
;

44 
•ölock_t
 
	méb°©e_lock
;

45 
DECLARE_BITMAP
(
Êush_˝umask
, 
NR_CPUS
);

47 
	m∑d
[
INTERNODE_CACHE_BYTES
];

48 } 
	g____ˇchñöe_öã∫odólig√d_ö_smp
;

53 
smp_Êush_°©e
 
	gÊush_°©e
[
NUM_INVALIDATE_TLB_VECTORS
];

59 
	$Àave_mm
(
˝u
)

61 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
)

62 
	`BUG
();

63 
	`˝umask_˛ór_˝u
(
˝u
,

64 
	`mm_˝umask
(
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)));

65 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

66 
	}
}

67 
EXPORT_SYMBOL_GPL
(
Àave_mm
);

124 #ifde‡
CONFIG_X86_64


125 
	gasmlökage


127 
	$smp_övÆid©e_öãºu±
(
±_ªgs
 *
ªgs
)

129 
˝u
;

130 
£ndî
;

131 
smp_Êush_°©e
 *
f
;

133 
˝u
 = 
	`smp_¥o˚ss‹_id
();

138 
£ndî
 = ~
ªgs
->
‹ig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

139 
f
 = &
Êush_°©e
[
£ndî
];

141 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
)))

142 
out
;

152 i‡(
f
->
Êush_mm
 =
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)) {

153 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
) {

154 i‡(
f
->
Êush_va
 =
TLB_FLUSH_ALL
)

155 
	`loˇl_Êush_éb
();

157 
	`__Êush_éb_⁄e
(
f
->
Êush_va
);

159 
	`Àave_mm
(
˝u
);

161 
out
:

162 
	`ack_APIC_úq
();

163 
	`smp_mb__bef‹e_˛ór_bô
();

164 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
));

165 
	`smp_mb__a·î_˛ór_bô
();

166 
	`öc_úq_°©
(
úq_éb_cou¡
);

167 
	}
}

169 
	$Êush_éb_Ÿhîs_ùi
(c⁄° 
˝umask
 *cpumask,

170 
mm_°ru˘
 *
mm
, 
va
)

172 
£ndî
;

173 
smp_Êush_°©e
 *
f
;

176 
£ndî
 = 
	`smp_¥o˚ss‹_id
(Ë% 
NUM_INVALIDATE_TLB_VECTORS
;

177 
f
 = &
Êush_°©e
[
£ndî
];

184 
	`•ö_lock
(&
f
->
éb°©e_lock
);

186 
f
->
Êush_mm
 = 
mm
;

187 
f
->
Êush_va
 = 
va
;

188 i‡(
	`˝umask_™dnŸ
(
	`to_˝umask
(
f
->
Êush_˝umask
), 
˝umask
, 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
()))) {

193 
≠ic
->
	`£nd_IPI_mask
(
	`to_˝umask
(
f
->
Êush_˝umask
),

194 
INVALIDATE_TLB_VECTOR_START
 + 
£ndî
);

196 !
	`˝umask_em±y
(
	`to_˝umask
(
f
->
Êush_˝umask
)))

197 
	`˝u_ªœx
();

200 
f
->
Êush_mm
 = 
NULL
;

201 
f
->
Êush_va
 = 0;

202 
	`•ö_u∆ock
(&
f
->
éb°©e_lock
);

203 
	}
}

205 
	$«tive_Êush_éb_Ÿhîs
(c⁄° 
˝umask
 *cpumask,

206 
mm_°ru˘
 *
mm
, 
va
)

208 i‡(
	`is_uv_sy°em
()) {

209 
˝u
;

211 
˝u
 = 
	`gë_˝u
();

212 
˝umask
 = 
	`uv_Êush_éb_Ÿhîs
(˝umask, 
mm
, 
va
, 
˝u
);

213 i‡(
˝umask
)

214 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

215 
	`put_˝u
();

218 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

219 
	}
}

221 
__˝uöô
 
	$öô_smp_Êush
()

223 
i
;

225 
i
 = 0; i < 
	`ARRAY_SIZE
(
Êush_°©e
); i++)

226 
	`•ö_lock_öô
(&
Êush_°©e
[
i
].
éb°©e_lock
);

229 
	}
}

230 
c‹e_öôˇŒ
(
öô_smp_Êush
);

232 
	$Êush_éb_cuºít_èsk
()

234 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

236 
	`¥ìm±_dißbÀ
();

238 
	`loˇl_Êush_éb
();

239 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

240 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

241 
	`¥ìm±_íabÀ
();

242 
	}
}

244 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

246 
	`¥ìm±_dißbÀ
();

248 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

249 i‡(
cuºít
->
mm
)

250 
	`loˇl_Êush_éb
();

252 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

254 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

255 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

257 
	`¥ìm±_íabÀ
();

258 
	}
}

260 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
va
)

262 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

264 
	`¥ìm±_dißbÀ
();

266 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

267 i‡(
cuºít
->
mm
)

268 
	`__Êush_éb_⁄e
(
va
);

270 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

273 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

274 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
va
);

276 
	`¥ìm±_íabÀ
();

277 
	}
}

279 
	$do_Êush_éb_Æl
(*
öfo
)

281 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
	`__Êush_éb_Æl
();

284 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_LAZY
)

285 
	`Àave_mm
(
˝u
);

286 
	}
}

288 
	$Êush_éb_Æl
()

290 
	`⁄_óch_˝u
(
do_Êush_éb_Æl
, 
NULL
, 1);

291 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<löux/kî√l.h
>

16 
	~<löux/posix-timîs.h
>

17 
	~<löux/time.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/vsysˇŒ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/uni°d.h
>

24 
	~<asm/io.h
>

25 
	~"vexã∫.h
"

27 
	#gtod
 
vdso_vsysˇŒ_gtod_d©a


	)

29 
nŸø˚
 
	$vdso_ÁŒback_gëtime
(
˛ock
, 
time•ec
 *
ts
)

31 
ªt
;

32 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

33 "0" (
__NR_˛ock_gëtime
),"D" (
˛ock
), "S" (
ts
) : "memory");

34  
ªt
;

35 
	}
}

37 
nŸø˚
 
ölöe
 
	$vgëns
()

39 
v
;

40 
	`cy˛es_t
 (*
vªad
)();

41 
vªad
 = 
gtod
->
˛ock
.vread;

42 
v
 = (
	`vªad
(Ë- 
gtod
->
˛ock
.
cy˛e_œ°
Ë& gtod->˛ock.
mask
;

43  (
v
 * 
gtod
->
˛ock
.
mu…
Ë>> gtod->˛ock.
shi·
;

44 
	}
}

46 
nŸø˚
 
noölöe
 
	$do_ªÆtime
(
time•ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_n£c
;

53 
ns
 = 
	`vgëns
();

54 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

55 
	`time•ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nŸø˚
 

61 
	$v£t_n‹mÆized_time•ec
(
time•ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >
NSEC_PER_SEC
) {

64 
n£c
 -
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic
(
time•ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
wÆl_time_£c
;

81 
ns
 = 
gtod
->
wÆl_time_n£c
 + 
	`vgëns
();

82 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

83 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

84 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nŸø˚
 
noölöe
 
	$do_ªÆtime_cﬂr£
(
time•ec
 *
ts
)

91 
£q
;

93 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

94 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_sec;

95 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_nsec;

96 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

98 
	}
}

100 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic_cﬂr£
(
time•ec
 *
ts
)

102 
£q
, 
ns
, 
£cs
;

104 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

105 
£cs
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_£c
;

106 
ns
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_n£c
;

107 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

108 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

109 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

110 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

112 
	}
}

114 
nŸø˚
 
	$__vdso_˛ock_gëtime
(
˛ockid_t
 
˛ock
, 
time•ec
 *
ts
)

116 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
))

117 
˛ock
) {

118 
CLOCK_REALTIME
:

119 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

120  
	`do_ªÆtime
(
ts
);

122 
CLOCK_MONOTONIC
:

123 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

124  
	`do_m⁄Ÿ⁄ic
(
ts
);

126 
CLOCK_REALTIME_COARSE
:

127  
	`do_ªÆtime_cﬂr£
(
ts
);

128 
CLOCK_MONOTONIC_COARSE
:

129  
	`do_m⁄Ÿ⁄ic_cﬂr£
(
ts
);

131  
	`vdso_ÁŒback_gëtime
(
˛ock
, 
ts
);

132 
	}
}

133 
	$˛ock_gëtime
(
˛ockid_t
, 
time•ec
 *)

134 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_clock_gettime")));

136 
nŸø˚
 
	$__vdso_gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

138 
ªt
;

139 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
)) {

140 i‡(
	`likñy
(
tv
 !
NULL
)) {

141 
	`BUILD_BUG_ON
(
	`off£tof
(
timevÆ
, 
tv_u£c
) !=

142 
	`off£tof
(
time•ec
, 
tv_n£c
) ||

143 (*
tv
Ë!(
time•ec
));

144 
	`do_ªÆtime
((
time•ec
 *)
tv
);

145 
tv
->
tv_u£c
 /= 1000;

147 i‡(
	`u∆ikñy
(
tz
 !
NULL
)) {

149 
tz
->
tz_möuãswe°
 = 
gtod
->
sys_tz
.tz_minuteswest;

150 
tz
->
tz_d°time
 = 
gtod
->
sys_tz
.tz_dsttime;

154 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

155 "0" (
__NR_gëtimeofday
), "D" (
tv
), "S" (
tz
) : "memory");

156  
ªt
;

157 
	}
}

158 
	$gëtimeofday
(
timevÆ
 *, 
timez⁄e
 *)

159 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/gë˝u.h
>

10 
	~<löux/jiffõs.h
>

11 
	~<löux/time.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vexã∫.h
"

16 
nŸø˚
 

17 
	$__vdso_gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
unu£d
)

19 
p
;

21 i‡(*
vdso_vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

23 
	`«tive_ªad_ts˝
(&
p
);

26 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

28 i‡(
˝u
)

29 *
˝u
 = 
p
 & 0xfff;

30 i‡(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

36 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<löux/mm.h
>

7 
	~<löux/îr.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/øndom.h
>

11 
	~<löux/ñf.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~<asm/¥Ÿo.h
>

15 
	~<asm/vdso.h
>

17 
	~"vexã∫.h
"

18 #unde‡
VEXTERN


20 
__ªad_mo°ly
 
	gvdso_íabÀd
 = 1;

22 
vdso_°¨t
[], 
vdso_íd
[];

23 
vdso_sync_˝uid
;

25 
∑ge
 **
	gvdso_∑ges
;

26 
	gvdso_size
;

28 
ölöe
 *
	$v¨_ªf
(*
p
, *
«me
)

30 i‡(*(**)
p
 !(*)
VMAGIC
) {

31 
	`¥ötk
("VDSO: v¨übÀ %†brokí\n", 
«me
);

32 
vdso_íabÀd
 = 0;

34  
p
;

35 
	}
}

37 
__öô
 
	$öô_vdso_v¨s
()

39 
≈ages
 = (
vdso_íd
 - 
vdso_°¨t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

40 
i
;

41 *
vba£
;

43 
vdso_size
 = 
≈ages
 << 
PAGE_SHIFT
;

44 
vdso_∑ges
 = 
	`kmÆloc
((
∑ge
 *Ë* 
≈ages
, 
GFP_KERNEL
);

45 i‡(!
vdso_∑ges
)

46 
oom
;

47 
i
 = 0; i < 
≈ages
; i++) {

48 
∑ge
 *
p
;

49 
p
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

50 i‡(!
p
)

51 
oom
;

52 
vdso_∑ges
[
i
] = 
p
;

53 
	`c›y_∑ge
(
	`∑ge_addªss
(
p
), 
vdso_°¨t
 + 
i
*
PAGE_SIZE
);

56 
vba£
 = 
	`vm≠
(
vdso_∑ges
, 
≈ages
, 0, 
PAGE_KERNEL
);

57 i‡(!
vba£
)

58 
oom
;

60 i‡(
	`memcmp
(
vba£
, "\177ELF", 4)) {

61 
	`¥ötk
("VDSO: I'm broken;Çot ELF\n");

62 
vdso_íabÀd
 = 0;

65 
	#VEXTERN
(
x
) \

66 *(
	`ty≥of
(
__
 ## 
x
Ë**Ë
	`v¨_ªf
(
	`VDSO64_SYMBOL
(
vba£
, x), #xË&__ ## x;

	)

67 
	~"vexã∫.h
"

68 #unde‡
VEXTERN


71 
oom
:

72 
	`¥ötk
("Cannotállocate vdso\n");

73 
vdso_íabÀd
 = 0;

74  -
ENOMEM
;

75 
	}
}

76 
__öôˇŒ
(
öô_vdso_v¨s
);

78 
	glöux_bö¥m
;

84 
	$vdso_addr
(
°¨t
, 
Àn
)

86 
addr
, 
íd
;

87 
off£t
;

88 
íd
 = (
°¨t
 + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

89 i‡(
íd
 >
TASK_SIZE_MAX
)

90 
íd
 = 
TASK_SIZE_MAX
;

91 
íd
 -
Àn
;

93 
off£t
 = 
	`gë_øndom_öt
(Ë& (
PTRS_PER_PTE
 - 1);

94 
addr
 = 
°¨t
 + (
off£t
 << 
PAGE_SHIFT
);

95 i‡(
addr
 >
íd
)

96 
addr
 = 
íd
;

97  
addr
;

98 
	}
}

102 
	$¨ch_£tup_addôi⁄Æ_∑ges
(
löux_bö¥m
 *
b¥m
, 
u£s_öãΩ
)

104 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

105 
addr
;

106 
ªt
;

108 i‡(!
vdso_íabÀd
)

111 
	`down_wrôe
(&
mm
->
mm≠_£m
);

112 
addr
 = 
	`vdso_addr
(
mm
->
°¨t_°ack
, 
vdso_size
);

113 
addr
 = 
	`gë_unm≠≥d_¨ó
(
NULL
,áddr, 
vdso_size
, 0, 0);

114 i‡(
	`IS_ERR_VALUE
(
addr
)) {

115 
ªt
 = 
addr
;

116 
up_Áû
;

119 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = (*)
addr
;

121 
ªt
 = 
	`ö°Æl_•ecül_m≠pög
(
mm
, 
addr
, 
vdso_size
,

122 
VM_READ
|
VM_EXEC
|

123 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

124 
VM_ALWAYSDUMP
,

125 
vdso_∑ges
);

126 i‡(
ªt
) {

127 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = 
NULL
;

128 
up_Áû
;

131 
up_Áû
:

132 
	`up_wrôe
(&
mm
->
mm≠_£m
);

133  
ªt
;

134 
	}
}

136 
__öô
 
	$vdso_£tup
(*
s
)

138 
vdso_íabÀd
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

140 
	}
}

141 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/time.h
>

7 
	~<asm/vsysˇŒ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
Ë
	`ty≥of
 (
__
 ## xË*c⁄° 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vexã∫.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<löux/jiffõs.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/smp.h
>

13 
	gÕj_föe
;

14 
	g¥e£t_Õj
;

15 
__öô
 
	$Õj_£tup
(*
°r
)

17 
¥e£t_Õj
 = 
	`sim∂e_°πoul
(
°r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Õj=", 
Õj_£tup
);

23 #ifde‡
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100Ë? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
()

35 
¥e_°¨t
, 
°¨t
, 
po°_°¨t
;

36 
¥e_íd
, 
íd
, 
po°_íd
;

37 
°¨t_jiffõs
;

38 
timî_øã_mö
, 
timî_øã_max
;

39 
good_timî_sum
 = 0;

40 
good_timî_cou¡
 = 0;

41 
i
;

43 i‡(
	`ªad_cuºít_timî
(&
¥e_°¨t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
¥e_°¨t
 = 0;

67 
	`ªad_cuºít_timî
(&
°¨t
);

68 
°¨t_jiffõs
 = 
jiffõs
;

69 
jiffõs
 <(
°¨t_jiffõs
 + 1)) {

70 
¥e_°¨t
 = 
°¨t
;

71 
	`ªad_cuºít_timî
(&
°¨t
);

73 
	`ªad_cuºít_timî
(&
po°_°¨t
);

75 
¥e_íd
 = 0;

76 
íd
 = 
po°_°¨t
;

77 
jiffõs
 <=

78 (
°¨t_jiffõs
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
¥e_íd
 = 
íd
;

80 
	`ªad_cuºít_timî
(&
íd
);

82 
	`ªad_cuºít_timî
(&
po°_íd
);

84 
timî_øã_max
 = (
po°_íd
 - 
¥e_°¨t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
timî_øã_mö
 = (
¥e_íd
 - 
po°_°¨t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 i‡(
¥e_°¨t
 !0 && 
¥e_íd
 != 0 &&

94 (
timî_øã_max
 - 
timî_øã_mö
) < (timer_rate_max >> 3)) {

95 
good_timî_cou¡
++;

96 
good_timî_sum
 +
timî_øã_max
;

100 i‡(
good_timî_cou¡
)

101  (
good_timî_sum
/
good_timî_cou¡
);

103 
	`¥ötk
(
KERN_WARNING
 "calibrate_delay_direct() failedÅo getá good "

106 
	}
}

108 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
(Ë{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__˝uöô
 
	$ˇlibøã_dñay
()

124 
ticks
, 
lo›bô
;

125 
Õs_¥ecisi⁄
 = 
LPS_PREC
;

126 
boﬁ
 
¥öãd
;

128 i‡(
¥e£t_Õj
) {

129 
lo›s_≥r_jiffy
 = 
¥e£t_Õj
;

130 i‡(!
¥öãd
)

131 
	`¥_öfo
("Calibrating delayÜoop (skipped) "

133 } i‡((!
¥öãd
Ë&& 
Õj_föe
) {

134 
lo›s_≥r_jiffy
 = 
Õj_föe
;

135 
	`¥_öfo
("Calibrating delayÜoop (skipped), "

137 } i‡((
lo›s_≥r_jiffy
 = 
	`ˇlibøã_dñay_dúe˘
()) != 0) {

138 i‡(!
¥öãd
)

139 
	`¥_öfo
("Calibrating delay usingÅimer "

142 
lo›s_≥r_jiffy
 = (1<<12);

144 i‡(!
¥öãd
)

145 
	`¥_öfo
("Calibrating delayÜoop... ");

146 (
lo›s_≥r_jiffy
 <<= 1) != 0) {

148 
ticks
 = 
jiffõs
;

149 
ticks
 =
jiffõs
)

152 
ticks
 = 
jiffõs
;

153 
	`__dñay
(
lo›s_≥r_jiffy
);

154 
ticks
 = 
jiffõs
 -Åicks;

155 i‡(
ticks
)

163 
lo›s_≥r_jiffy
 >>= 1;

164 
lo›bô
 = 
lo›s_≥r_jiffy
;

165 
Õs_¥ecisi⁄
-- && (
lo›bô
 >>= 1)) {

166 
lo›s_≥r_jiffy
 |
lo›bô
;

167 
ticks
 = 
jiffõs
;

168 
ticks
 =
jiffõs
)

170 
ticks
 = 
jiffõs
;

171 
	`__dñay
(
lo›s_≥r_jiffy
);

172 i‡(
jiffõs
 !
ticks
)

173 
lo›s_≥r_jiffy
 &~
lo›bô
;

176 i‡(!
¥öãd
)

177 
	`¥_c⁄t
("%lu.%02lu BogoMIPS (lpj=%lu)\n",

178 
lo›s_≥r_jiffy
/(500000/
HZ
),

179 (
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100,Üoops_per_jiffy);

181 
¥öãd
 = 
åue
;

182 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/˘y≥.h
>

4 
	~<löux/fd.h
>

5 
	~<löux/ây.h
>

6 
	~<löux/su•íd.h
>

7 
	~<löux/roŸ_dev.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/gíhd.h
>

11 
	~<löux/mou¡.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/öôrd.h
>

16 
	~<löux/async.h
>

17 
	~<löux/fs_°ru˘.h
>

19 
	~<löux/nfs_fs.h
>

20 
	~<löux/nfs_fs_sb.h
>

21 
	~<löux/nfs_mou¡.h
>

23 
	~"do_mou¡s.h
"

25 
__öôd©a
 
	grd_dﬁﬂd
;

27 
	groŸ_mou¡Êags
 = 
MS_RDONLY
 | 
MS_SILENT
;

28 * 
__öôd©a
 
	groŸ_devi˚_«me
;

29 
__öôd©a
 
	gßved_roŸ_«me
[64];

30 
__öôd©a
 
	groŸ_waô
;

32 
dev_t
 
	gROOT_DEV
;

34 
__öô
 
	$lﬂd_ømdisk
(*
°r
)

36 
rd_dﬁﬂd
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 3;

38 
	}
}

39 
__£tup
("lﬂd_ømdisk=", 
lﬂd_ømdisk
);

41 
__öô
 
	$ªad⁄ly
(*
°r
)

43 i‡(*
°r
)

45 
roŸ_mou¡Êags
 |
MS_RDONLY
;

47 
	}
}

49 
__öô
 
	$ªadwrôe
(*
°r
)

51 i‡(*
°r
)

53 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

55 
	}
}

57 
__£tup
("ro", 
ªad⁄ly
);

58 
__£tup
("rw", 
ªadwrôe
);

77 
dev_t
 
	$«me_to_dev_t
(*
«me
)

79 
s
[32];

80 *
p
;

81 
dev_t
 
ªs
 = 0;

82 
∑π
;

84 i‡(
	`°∫cmp
(
«me
, "/dev/", 5) != 0) {

85 
maj
, 
mö
;

87 i‡(
	`ssˇnf
(
«me
, "%u:%u", &
maj
, &
mö
) == 2) {

88 
ªs
 = 
	`MKDEV
(
maj
, 
mö
);

89 i‡(
maj
 !
	`MAJOR
(
ªs
Ë|| 
mö
 !
	`MINOR
(res))

90 
Áû
;

92 
ªs
 = 
	`√w_decode_dev
(
	`sim∂e_°πoul
(
«me
, &
p
, 16));

93 i‡(*
p
)

94 
Áû
;

96 
d⁄e
;

99 
«me
 += 5;

100 
ªs
 = 
RoŸ_NFS
;

101 i‡(
	`°rcmp
(
«me
, "nfs") == 0)

102 
d⁄e
;

103 
ªs
 = 
RoŸ_RAM0
;

104 i‡(
	`°rcmp
(
«me
, "ram") == 0)

105 
d⁄e
;

107 i‡(
	`°æí
(
«me
) > 31)

108 
Áû
;

109 
	`°r˝y
(
s
, 
«me
);

110 
p
 = 
s
; *p;Ö++)

111 i‡(*
p
 == '/')

112 *
p
 = '!';

113 
ªs
 = 
	`blk_lookup_devt
(
s
, 0);

114 i‡(
ªs
)

115 
d⁄e
;

121 
p
 > 
s
 && 
	`isdigô
(p[-1]))

122 
p
--;

123 i‡(
p
 =
s
 || !*p || *p == '0')

124 
Áû
;

127 
∑π
 = 
	`sim∂e_°πoul
(
p
, 
NULL
, 10);

128 *
p
 = '\0';

129 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

130 i‡(
ªs
)

131 
d⁄e
;

134 i‡(
p
 < 
s
 + 2 || !
	`isdigô
(p[-2]) ||Ö[-1] != 'p')

135 
Áû
;

136 
p
[-1] = '\0';

137 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

138 i‡(
ªs
)

139 
d⁄e
;

141 
Áû
:

143 
d⁄e
:

144  
ªs
;

145 
	}
}

147 
__öô
 
	$roŸ_dev_£tup
(*
löe
)

149 
	`°æ˝y
(
ßved_roŸ_«me
, 
löe
, (saved_root_name));

151 
	}
}

153 
__£tup
("roŸ=", 
roŸ_dev_£tup
);

155 
__öô
 
	$roŸwaô_£tup
(*
°r
)

157 i‡(*
°r
)

159 
roŸ_waô
 = 1;

161 
	}
}

163 
__£tup
("roŸwaô", 
roŸwaô_£tup
);

165 * 
__öôd©a
 
	groŸ_mou¡_d©a
;

166 
__öô
 
	$roŸ_d©a_£tup
(*
°r
)

168 
roŸ_mou¡_d©a
 = 
°r
;

170 
	}
}

172 * 
__öôd©a
 
	groŸ_fs_«mes
;

173 
__öô
 
	$fs_«mes_£tup
(*
°r
)

175 
roŸ_fs_«mes
 = 
°r
;

177 
	}
}

179 
__öôd©a
 
	groŸ_dñay
;

180 
__öô
 
	$roŸ_dñay_£tup
(*
°r
)

182 
roŸ_dñay
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 0);

184 
	}
}

186 
__£tup
("roŸÊags=", 
roŸ_d©a_£tup
);

187 
__£tup
("roŸf°y≥=", 
fs_«mes_£tup
);

188 
__£tup
("roŸdñay=", 
roŸ_dñay_£tup
);

190 
__öô
 
	$gë_fs_«mes
(*
∑ge
)

192 *
s
 = 
∑ge
;

194 i‡(
roŸ_fs_«mes
) {

195 
	`°r˝y
(
∑ge
, 
roŸ_fs_«mes
);

196 *
s
++) {

197 i‡(
s
[-1] == ',')

198 
s
[-1] = '\0';

201 
Àn
 = 
	`gë_fûesy°em_li°
(
∑ge
);

202 *
p
, *
√xt
;

204 
∑ge
[
Àn
] = '\0';

205 
p
 = 
∑ge
-1;Ö;Ö = 
√xt
) {

206 
√xt
 = 
	`°rchr
(++
p
, '\n');

207 i‡(*
p
++ != '\t')

209 (*
s
++ = *
p
++) != '\n')

211 
s
[-1] = '\0';

214 *
s
 = '\0';

215 
	}
}

217 
__öô
 
	$do_mou¡_roŸ
(*
«me
, *
fs
, 
Êags
, *
d©a
)

219 
îr
 = 
	`sys_mou¡
(
«me
, "/roŸ", 
fs
, 
Êags
, 
d©a
);

220 i‡(
îr
)

221  
îr
;

223 
	`sys_chdú
("/root");

224 
ROOT_DEV
 = 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_dev
;

225 
	`¥ötk
("VFS: MountedÑoot (%s filesystem)%s on device %u:%u.\n",

226 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_ty≥
->
«me
,

227 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_Êags
 & 
MS_RDONLY
 ?

228 "Ñód⁄ly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

230 
	}
}

232 
__öô
 
	$mou¡_block_roŸ
(*
«me
, 
Êags
)

234 *
fs_«mes
 = 
	`__gë«me_gÂ
(
GFP_KERNEL


235 | 
__GFP_NOTRACK_FALSE_POSITIVE
);

236 *
p
;

237 #ifde‡
CONFIG_BLOCK


238 
b
[
BDEVNAME_SIZE
];

240 c⁄° *
b
 = 
«me
;

243 
	`gë_fs_«mes
(
fs_«mes
);

244 
ªåy
:

245 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1) {

246 
îr
 = 
	`do_mou¡_roŸ
(
«me
, 
p
, 
Êags
, 
roŸ_mou¡_d©a
);

247 
îr
) {

249 
out
;

250 -
EACCES
:

251 
Êags
 |
MS_RDONLY
;

252 
ªåy
;

253 -
EINVAL
:

261 #ifde‡
CONFIG_BLOCK


262 
	`__bdev«me
(
ROOT_DEV
, 
b
);

264 
	`¥ötk
("VFS: Cannot openÑoot device \"%s\" or %s\n",

265 
roŸ_devi˚_«me
, 
b
);

266 
	`¥ötk
("Pleaseáppendá correct \"root=\" boot option; hereáreÅheávailableÖartitions:\n");

268 
	`¥ötk_Æl_∑πôi⁄s
();

269 #ifde‡
CONFIG_DEBUG_BLOCK_EXT_DEVT


270 
	`¥ötk
("DEBUG_BLOCK_EXT_DEVT isÉnabled, youÇeedÅo specify "

273 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

276 
	`¥ötk
("List ofállÖartitions:\n");

277 
	`¥ötk_Æl_∑πôi⁄s
();

278 
	`¥ötk
("No filesystem could mountÑoot,Åried: ");

279 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1)

280 
	`¥ötk
(" %s", 
p
);

281 
	`¥ötk
("\n");

282 #ifde‡
CONFIG_BLOCK


283 
	`__bdev«me
(
ROOT_DEV
, 
b
);

285 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

286 
out
:

287 
	`puäame
(
fs_«mes
);

288 
	}
}

290 #ifde‡
CONFIG_ROOT_NFS


291 
__öô
 
	$mou¡_nfs_roŸ
()

293 *
d©a
 = 
	`nfs_roŸ_d©a
();

295 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

296 i‡(
d©a
 &&

297 
	`do_mou¡_roŸ
("/dev/roŸ", "nfs", 
roŸ_mou¡Êags
, 
d©a
) == 0)

300 
	}
}

303 #i‡
deföed
(
CONFIG_BLK_DEV_RAM
Ë|| deföed(
CONFIG_BLK_DEV_FD
)

304 
__öô
 
	$ch™ge_Ê›py
(*
fmt
, ...)

306 
ãrmios
Åermios;

307 
buf
[80];

308 
c
;

309 
fd
;

310 
va_li°
 
¨gs
;

311 
	`va_°¨t
(
¨gs
, 
fmt
);

312 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

313 
	`va_íd
(
¨gs
);

314 
fd
 = 
	`sys_›í
("/dev/roŸ", 
O_RDWR
 | 
O_NDELAY
, 0);

315 i‡(
fd
 >= 0) {

316 
	`sys_io˘l
(
fd
, 
FDEJECT
, 0);

317 
	`sys_˛o£
(
fd
);

319 
	`¥ötk
(
KERN_NOTICE
 "VFS: In£π %†™dÖªs†ENTER\n", 
buf
);

320 
fd
 = 
	`sys_›í
("/dev/c⁄sﬁe", 
O_RDWR
, 0);

321 i‡(
fd
 >= 0) {

322 
	`sys_io˘l
(
fd
, 
TCGETS
, ()&
ãrmios
);

323 
ãrmios
.
c_lÊag
 &~
ICANON
;

324 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

325 
	`sys_ªad
(
fd
, &
c
, 1);

326 
ãrmios
.
c_lÊag
 |
ICANON
;

327 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

328 
	`sys_˛o£
(
fd
);

330 
	}
}

333 
__öô
 
	$mou¡_roŸ
()

335 #ifde‡
CONFIG_ROOT_NFS


336 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
UNNAMED_MAJOR
) {

337 i‡(
	`mou¡_nfs_roŸ
())

340 
	`¥ötk
(
KERN_ERR
 "VFS: UnableÅo mountÑoot fs via NFS,Årying floppy.\n");

341 
ROOT_DEV
 = 
RoŸ_FD0
;

344 #ifde‡
CONFIG_BLK_DEV_FD


345 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
) {

347 i‡(
rd_dﬁﬂd
==2) {

348 i‡(
	`rd_lﬂd_disk
(1)) {

349 
ROOT_DEV
 = 
RoŸ_RAM1
;

350 
roŸ_devi˚_«me
 = 
NULL
;

353 
	`ch™ge_Ê›py
("root floppy");

356 #ifde‡
CONFIG_BLOCK


357 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

358 
	`mou¡_block_roŸ
("/dev/roŸ", 
roŸ_mou¡Êags
);

360 
	}
}

365 
__öô
 
	$¥ï¨e_«me•a˚
()

367 
is_Ê›py
;

369 i‡(
roŸ_dñay
) {

370 
	`¥ötk
(
KERN_INFO
 "Waiting %dsec before mountingÑoot device...\n",

371 
roŸ_dñay
);

372 
	`s¶ìp
(
roŸ_dñay
);

382 
	`waô_f‹_devi˚_¥obe
();

384 
	`md_run_£tup
();

386 i‡(
ßved_roŸ_«me
[0]) {

387 
roŸ_devi˚_«me
 = 
ßved_roŸ_«me
;

388 i‡(!
	`°∫cmp
(
roŸ_devi˚_«me
, "mtd", 3) ||

389 !
	`°∫cmp
(
roŸ_devi˚_«me
, "ubi", 3)) {

390 
	`mou¡_block_roŸ
(
roŸ_devi˚_«me
, 
roŸ_mou¡Êags
);

391 
out
;

393 
ROOT_DEV
 = 
	`«me_to_dev_t
(
roŸ_devi˚_«me
);

394 i‡(
	`°∫cmp
(
roŸ_devi˚_«me
, "/dev/", 5) == 0)

395 
roŸ_devi˚_«me
 += 5;

398 i‡(
	`öôrd_lﬂd
())

399 
out
;

402 i‡((
ROOT_DEV
 =0Ë&& 
roŸ_waô
) {

403 
	`¥ötk
(
KERN_INFO
 "Waiting forÑoot device %s...\n",

404 
ßved_roŸ_«me
);

405 
	`drivî_¥obe_d⁄e
() != 0 ||

406 (
ROOT_DEV
 = 
	`«me_to_dev_t
(
ßved_roŸ_«me
)) == 0)

407 
	`m¶ìp
(100);

408 
	`async_synchr⁄ize_fuŒ
();

411 
is_Ê›py
 = 
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
;

413 i‡(
is_Ê›py
 && 
rd_dﬁﬂd
 && 
	`rd_lﬂd_disk
(0))

414 
ROOT_DEV
 = 
RoŸ_RAM0
;

416 
	`mou¡_roŸ
();

417 
out
:

418 
	`devtmpfs_mou¡
("dev");

419 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

420 
	`sys_chroŸ
(".");

421 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<löux/uni°d.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/öôrd.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/‰ìzî.h
>

11 
	~"do_mou¡s.h
"

13 
	göôrd_°¨t
, 
	göôrd_íd
;

14 
	göôrd_bñow_°¨t_ok
;

15 
	gªÆ_roŸ_dev
;

16 
__öôd©a
 
	gﬁd_fd
, 
	groŸ_fd
;

17 
__öôd©a
 
	gmou¡_öôrd
 = 1;

19 
__öô
 
	$no_öôrd
(*
°r
)

21 
mou¡_öôrd
 = 0;

23 
	}
}

25 
__£tup
("noöôrd", 
no_öôrd
);

27 
__öô
 
	$do_löuxrc
(* 
shñl
)

29 *
¨gv
[] = { "löuxrc", 
NULL
, };

30 * 
ívp_öô
[];

32 
	`sys_˛o£
(
ﬁd_fd
);sys_˛o£(
roŸ_fd
);

33 
	`sys_˛o£
(0);sys_close(1);sys_close(2);

34 
	`sys_£tsid
();

35 (Ë
	`sys_›í
("/dev/c⁄sﬁe",
O_RDWR
,0);

36 (Ë
	`sys_dup
(0);

37 (Ë
	`sys_dup
(0);

38  
	`kî√l_execve
(
shñl
, 
¨gv
, 
ívp_öô
);

39 
	}
}

41 
__öô
 
	$h™dÀ_öôrd
()

43 
îr‹
;

44 
pid
;

46 
ªÆ_roŸ_dev
 = 
	`√w_ícode_dev
(
ROOT_DEV
);

47 
	`¸óã_dev
("/dev/roŸ.ﬁd", 
RoŸ_RAM0
);

49 
	`mou¡_block_roŸ
("/dev/roŸ.ﬁd", 
roŸ_mou¡Êags
 & ~
MS_RDONLY
);

50 
	`sys_mkdú
("/old", 0700);

51 
roŸ_fd
 = 
	`sys_›í
("/", 0, 0);

52 
ﬁd_fd
 = 
	`sys_›í
("/old", 0, 0);

54 
	`sys_chdú
("/root");

55 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

56 
	`sys_chroŸ
(".");

62 
cuºít
->
Êags
 |
PF_FREEZER_SKIP
;

64 
pid
 = 
	`kî√l_thªad
(
do_löuxrc
, "/löuxrc", 
SIGCHLD
);

65 i‡(
pid
 > 0)

66 
pid
 !
	`sys_waô4
(-1, 
NULL
, 0, NULL))

67 
	`yõld
();

69 
cuºít
->
Êags
 &~
PF_FREEZER_SKIP
;

72 
	`sys_fchdú
(
ﬁd_fd
);

73 
	`sys_mou¡
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

75 
	`sys_fchdú
(
roŸ_fd
);

76 
	`sys_chroŸ
(".");

77 
	`sys_˛o£
(
ﬁd_fd
);

78 
	`sys_˛o£
(
roŸ_fd
);

80 i‡(
	`√w_decode_dev
(
ªÆ_roŸ_dev
Ë=
RoŸ_RAM0
) {

81 
	`sys_chdú
("/old");

85 
ROOT_DEV
 = 
	`√w_decode_dev
(
ªÆ_roŸ_dev
);

86 
	`mou¡_roŸ
();

88 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo move oldÑootÅo /initrd ... ");

89 
îr‹
 = 
	`sys_mou¡
("/ﬁd", "/roŸ/öôrd", 
NULL
, 
MS_MOVE
, NULL);

90 i‡(!
îr‹
)

91 
	`¥ötk
("okay\n");

93 
fd
 = 
	`sys_›í
("/dev/roŸ.ﬁd", 
O_RDWR
, 0);

94 i‡(
îr‹
 =-
ENOENT
)

95 
	`¥ötk
("/initrd doesÇotÉxist. Ignored.\n");

97 
	`¥ötk
("failed\n");

98 
	`¥ötk
(
KERN_NOTICE
 "Unmounting oldÑoot\n");

99 
	`sys_umou¡
("/ﬁd", 
MNT_DETACH
);

100 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo freeÑamdisk memory ... ");

101 i‡(
fd
 < 0) {

102 
îr‹
 = 
fd
;

104 
îr‹
 = 
	`sys_io˘l
(
fd
, 
BLKFLSBUF
, 0);

105 
	`sys_˛o£
(
fd
);

107 
	`¥ötk
(!
îr‹
 ? "okay\n" : "failed\n");

109 
	}
}

111 
__öô
 
	$öôrd_lﬂd
()

113 i‡(
mou¡_öôrd
) {

114 
	`¸óã_dev
("/dev/øm", 
RoŸ_RAM0
);

121 i‡(
	`rd_lﬂd_image
("/öôrd.image"Ë&& 
ROOT_DEV
 !
RoŸ_RAM0
) {

122 
	`sys_u∆ök
("/initrd.image");

123 
	`h™dÀ_öôrd
();

127 
	`sys_u∆ök
("/initrd.image");

129 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<löux/dñay.h
>

2 
	~<löux/øid/md_u.h
>

3 
	~<löux/øid/md_p.h
>

5 
	~"do_mou¡s.h
"

16 #ifde‡
CONFIG_MD_AUTODETECT


17 
__öôd©a
 
	gøid_nﬂutodëe˘
;

19 
__öôd©a
 
	gøid_nﬂutodëe˘
=1;

21 
__öôd©a
 
	gøid_aut›¨t
;

24 
	mmö‹
;

25 
	m∑πôi⁄ed
;

26 
	mÀvñ
;

27 
	mchunk
;

28 *
	mdevi˚_«mes
;

29 } 
	gmd_£tup_¨gs
[256] 
	g__öôd©a
;

31 
md_£tup_íts
 
	g__öôd©a
;

53 
__öô
 
	$md_£tup
(*
°r
)

55 
mö‹
, 
Àvñ
, 
Á˘‹
, 
Áu…
, 
∑πôi⁄ed
 = 0;

56 *
≥∫ame
 = "";

57 *
°r1
;

58 
ít
;

60 i‡(*
°r
 == 'd') {

61 
∑πôi⁄ed
 = 1;

62 
°r
++;

64 i‡(
	`gë_›ti⁄
(&
°r
, &
mö‹
) != 2) {

65 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

68 
°r1
 = 
°r
;

69 
ít
=0 ;É¡< 
md_£tup_íts
 ;Ént++)

70 i‡(
md_£tup_¨gs
[
ít
].
mö‹
 == minor &&

71 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 ==Öartitioned) {

72 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d, Specified moreÅhan once. "

73 "RïœcögÖªviou†deföôi⁄.\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

76 i‡(
ít
 >
	`ARRAY_SIZE
(
md_£tup_¨gs
)) {

77 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d -Åoÿm™y md inôülißti⁄s\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

80 i‡(
ít
 >
md_£tup_íts
)

81 
md_£tup_íts
++;

82 
	`gë_›ti⁄
(&
°r
, &
Àvñ
)) {

84 i‡(
Àvñ
 =0 ||Üevñ =
LEVEL_LINEAR
) {

85 i‡(
	`gë_›ti⁄
(&
°r
, &
Á˘‹
) != 2 ||

86 
	`gë_›ti⁄
(&
°r
, &
Áu…
) != 2) {

87 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

90 
md_£tup_¨gs
[
ít
].
Àvñ
 =Üevel;

91 
md_£tup_¨gs
[
ít
].
chunk
 = 1 << (
Á˘‹
+12);

92 i‡(
Àvñ
 =
LEVEL_LINEAR
)

93 
≥∫ame
 = "linear";

95 
≥∫ame
 = "raid0";

100 
°r
 = 
°r1
;

103 
md_£tup_¨gs
[
ít
].
Àvñ
 = 
LEVEL_NONE
;

104 
≥∫ame
="super-block";

107 
	`¥ötk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mö‹
, 
≥∫ame
, 
°r
);

109 
md_£tup_¨gs
[
ít
].
devi˚_«mes
 = 
°r
;

110 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 =Öartitioned;

111 
md_£tup_¨gs
[
ít
].
mö‹
 = minor;

114 
	}
}

116 
__öô
 
	$md_£tup_drive
()

118 
mö‹
, 
i
, 
ít
, 
∑πôi⁄ed
;

119 
dev_t
 
dev
;

120 
dev_t
 
devi˚s
[
MD_SB_DISKS
+1];

122 
ít
 = 0;É¡ < 
md_£tup_íts
 ;Ént++) {

123 
fd
;

124 
îr
 = 0;

125 *
dev«me
;

126 
mdu_disk_öfo_t
 
döfo
;

127 
«me
[16];

129 
mö‹
 = 
md_£tup_¨gs
[
ít
].minor;

130 
∑πôi⁄ed
 = 
md_£tup_¨gs
[
ít
].partitioned;

131 
dev«me
 = 
md_£tup_¨gs
[
ít
].
devi˚_«mes
;

133 
	`•rötf
(
«me
, "/dev/md%s%d", 
∑πôi⁄ed
?"_d":"", 
mö‹
);

134 i‡(
∑πôi⁄ed
)

135 
dev
 = 
	`MKDEV
(
mdp_maj‹
, 
mö‹
 << 
MdpMö‹Shi·
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mö‹
);

138 
	`¸óã_dev
(
«me
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
dev«me
 !
NULL
; i++) {

140 *
p
;

141 
comp_«me
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`°rchr
(
dev«me
, ',');

145 i‡(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`«me_to_dev_t
(
dev«me
);

149 i‡(
	`°∫cmp
(
dev«me
, "/dev/", 5) == 0)

150 
dev«me
 += 5;

151 
	`¢¥ötf
(
comp_«me
, 63, "/dev/%s", 
dev«me
);

152 
rdev
 = 
	`b°©
(
comp_«me
);

153 i‡(
rdev
)

154 
dev
 = 
	`√w_decode_dev
(
rdev
);

155 i‡(!
dev
) {

156 
	`¥ötk
(
KERN_WARNING
 "md: Unknow¿devi˚Çame: %s\n", 
dev«me
);

160 
devi˚s
[
i
] = 
dev
;

162 
dev«me
 = 
p
;

164 
devi˚s
[
i
] = 0;

166 i‡(!
i
)

169 
	`¥ötk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
∑πôi⁄ed
 ? "_d" : "", 
mö‹
,

171 
md_£tup_¨gs
[
ít
].
devi˚_«mes
);

173 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

174 i‡(
fd
 < 0) {

175 
	`¥ötk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¨øy %s\n", 
«me
);

179 i‡(
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, 0Ë=-
EBUSY
) {

180 
	`¥ötk
(
KERN_WARNING


182 
mö‹
);

183 
	`sys_˛o£
(
fd
);

187 i‡(
md_£tup_¨gs
[
ít
].
Àvñ
 !
LEVEL_NONE
) {

189 
mdu_¨øy_öfo_t
 
aöfo
;

190 
aöfo
.
Àvñ
 = 
md_£tup_¨gs
[
ít
].level;

191 
aöfo
.
size
 = 0;

192 
aöfo
.
ƒ_disks
 =0;

193 
aöfo
.
øid_disks
 =0;

194 
devi˚s
[
aöfo
.
øid_disks
])

195 
aöfo
.
øid_disks
++;

196 
aöfo
.
md_mö‹
 =
mö‹
;

197 
aöfo
.
nŸ_≥rsi°ít
 = 1;

199 
aöfo
.
°©e
 = (1 << 
MD_SB_CLEAN
);

200 
aöfo
.
œyout
 = 0;

201 
aöfo
.
chunk_size
 = 
md_£tup_¨gs
[
ít
].
chunk
;

202 
îr
 = 
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, ()&
aöfo
);

203 
i
 = 0; !
îr
 && i <
MD_SB_DISKS
; i++) {

204 
dev
 = 
devi˚s
[
i
];

205 i‡(!
dev
)

207 
döfo
.
numbî
 = 
i
;

208 
döfo
.
øid_disk
 = 
i
;

209 
döfo
.
°©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

211 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

212 
îr
 = 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

216 
i
 = 0; i <
MD_SB_DISKS
; i++) {

217 
dev
 = 
devi˚s
[
i
];

218 i‡(!
dev
)

220 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

221 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

222 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

225 i‡(!
îr
)

226 
îr
 = 
	`sys_io˘l
(
fd
, 
RUN_ARRAY
, 0);

227 i‡(
îr
)

228 
	`¥ötk
(
KERN_WARNING
 "md: sèπög md%d faûed\n", 
mö‹
);

235 
	`sys_˛o£
(
fd
);

236 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

237 
	`sys_io˘l
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_˛o£
(
fd
);

241 
	}
}

243 
__öô
 
	$øid_£tup
(*
°r
)

245 
Àn
, 
pos
;

247 
Àn
 = 
	`°æí
(
°r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Àn
) {

251 *
comma
 = 
	`°rchr
(
°r
+
pos
, ',');

252 
wÀn
;

253 i‡(
comma
)

254 
wÀn
 = (
comma
-
°r
)-
pos
;

255 
wÀn
 = (
Àn
-1)-
pos
;

257 i‡(!
	`°∫cmp
(
°r
, "nﬂutodëe˘", 
wÀn
))

258 
øid_nﬂutodëe˘
 = 1;

259 i‡(!
	`°∫cmp
(
°r
, "autodëe˘", 
wÀn
))

260 
øid_nﬂutodëe˘
 = 0;

261 i‡(
	`°∫cmp
(
°r
, "∑πôi⁄abÀ", 
wÀn
)==0)

262 
øid_aut›¨t
 = 1;

263 i‡(
	`°∫cmp
(
°r
, "∑π", 
wÀn
)==0)

264 
øid_aut›¨t
 = 1;

265 
pos
 +
wÀn
+1;

268 
	}
}

270 
__£tup
("øid=", 
øid_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__öô
 
	$autodëe˘_øid
()

275 
fd
;

281 
	`¥ötk
(
KERN_INFO
 "md: Waiting foráll devicesÅo beávailable beforeáutodetect\n");

282 
	`¥ötk
(
KERN_INFO
 "md: If you don't useÑaid, useÑaid=noautodetect\n");

284 
	`waô_f‹_devi˚_¥obe
();

286 
fd
 = 
	`sys_›í
("/dev/md0", 0, 0);

287 i‡(
fd
 >= 0) {

288 
	`sys_io˘l
(
fd
, 
RAID_AUTORUN
, 
øid_aut›¨t
);

289 
	`sys_˛o£
(
fd
);

291 
	}
}

293 
__öô
 
	$md_run_£tup
()

295 
	`¸óã_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 i‡(
øid_nﬂutodëe˘
)

298 
	`¥ötk
(
KERN_INFO
 "md: Skippingáutodetection of RAIDárrays. (raid=autodetect will force)\n");

300 
	`autodëe˘_øid
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/¸amfs_fs.h
>

8 
	~<löux/öôrd.h
>

9 
	~<löux/°rög.h
>

11 
	~"do_mou¡s.h
"

12 
	~"../fs/squashfs/squashfs_fs.h
"

14 
	~<löux/decom¥ess/gíîic.h
>

17 
__öôd©a
 
	grd_¥om±
 = 1;

19 
__öô
 
	$¥om±_ømdisk
(*
°r
)

21 
rd_¥om±
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 1;

23 
	}
}

24 
__£tup
("¥om±_ømdisk=", 
¥om±_ømdisk
);

26 
__öôd©a
 
	grd_image_°¨t
;

28 
__öô
 
	$ømdisk_°¨t_£tup
(*
°r
)

30 
rd_image_°¨t
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0);

32 
	}
}

33 
__£tup
("ømdisk_°¨t=", 
ømdisk_°¨t_£tup
);

35 
__öô
 
¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
);

51 
__öô


52 
	$idítify_ømdisk_image
(
fd
, 
°¨t_block
, 
decom¥ess_‚
 *
decom¥ess‹
)

54 c⁄° 
size
 = 512;

55 
möix_su≥r_block
 *
möixsb
;

56 
ext2_su≥r_block
 *
ext2sb
;

57 
romfs_su≥r_block
 *
romfsb
;

58 
¸amfs_su≥r
 *
¸amfsb
;

59 
squashfs_su≥r_block
 *
squashfsb
;

60 
nblocks
 = -1;

61 *
buf
;

62 c⁄° *
com¥ess_«me
;

64 
buf
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

65 i‡(!
buf
)

68 
möixsb
 = (
möix_su≥r_block
 *Ë
buf
;

69 
ext2sb
 = (
ext2_su≥r_block
 *Ë
buf
;

70 
romfsb
 = (
romfs_su≥r_block
 *Ë
buf
;

71 
¸amfsb
 = (
¸amfs_su≥r
 *Ë
buf
;

72 
squashfsb
 = (
squashfs_su≥r_block
 *Ë
buf
;

73 
	`mem£t
(
buf
, 0xe5, 
size
);

78 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

79 
	`sys_ªad
(
fd
, 
buf
, 
size
);

81 *
decom¥ess‹
 = 
	`decom¥ess_mëhod
(
buf
, 
size
, &
com¥ess_«me
);

82 i‡(
com¥ess_«me
) {

83 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: %s image foundát block %d\n",

84 
com¥ess_«me
, 
°¨t_block
);

85 i‡(!*
decom¥ess‹
)

86 
	`¥ötk
(
KERN_EMERG


88 
com¥ess_«me
);

89 
nblocks
 = 0;

90 
d⁄e
;

94 i‡(
romfsb
->
w‹d0
 =
ROMSB_WORD0
 &&

95 
romfsb
->
w‹d1
 =
ROMSB_WORD1
) {

96 
	`¥ötk
(
KERN_NOTICE


98 
°¨t_block
);

99 
nblocks
 = (
	`¡ohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

100 
d⁄e
;

103 i‡(
¸amfsb
->
magic
 =
CRAMFS_MAGIC
) {

104 
	`¥ötk
(
KERN_NOTICE


106 
°¨t_block
);

107 
nblocks
 = (
¸amfsb
->
size
 + 
BLOCK_SIZE
 - 1Ë>> 
BLOCK_SIZE_BITS
;

108 
d⁄e
;

112 i‡(
	`À32_to_˝u
(
squashfsb
->
s_magic
Ë=
SQUASHFS_MAGIC
) {

113 
	`¥ötk
(
KERN_NOTICE


115 
°¨t_block
);

116 
nblocks
 = (
	`À64_to_˝u
(
squashfsb
->
byãs_u£d
Ë+ 
BLOCK_SIZE
 - 1)

117 >> 
BLOCK_SIZE_BITS
;

118 
d⁄e
;

124 
	`sys_l£ek
(
fd
, (
°¨t_block
+1Ë* 
BLOCK_SIZE
, 0);

125 
	`sys_ªad
(
fd
, 
buf
, 
size
);

128 i‡(
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC
 ||

129 
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC2
) {

130 
	`¥ötk
(
KERN_NOTICE


132 
°¨t_block
);

133 
nblocks
 = 
möixsb
->
s_nz⁄es
 << möixsb->
s_log_z⁄e_size
;

134 
d⁄e
;

138 i‡(
ext2sb
->
s_magic
 =
	`˝u_to_À16
(
EXT2_SUPER_MAGIC
)) {

139 
	`¥ötk
(
KERN_NOTICE


141 
°¨t_block
);

142 
nblocks
 = 
	`À32_to_˝u
(
ext2sb
->
s_blocks_cou¡
) <<

143 
	`À32_to_˝u
(
ext2sb
->
s_log_block_size
);

144 
d⁄e
;

147 
	`¥ötk
(
KERN_NOTICE


149 
°¨t_block
);

151 
d⁄e
:

152 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

153 
	`k‰ì
(
buf
);

154  
nblocks
;

155 
	}
}

157 
__öô
 
	$rd_lﬂd_image
(*
‰om
)

159 
ªs
 = 0;

160 
ö_fd
, 
out_fd
;

161 
rd_blocks
, 
devblocks
;

162 
nblocks
, 
i
, 
disk
;

163 *
buf
 = 
NULL
;

164 
rŸ©e
 = 0;

165 
decom¥ess_‚
 
decom¥ess‹
 = 
NULL
;

166 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

167 
rŸ©‹
[4] = { '|' , '/' , '-' , '\\' };

170 
out_fd
 = 
	`sys_›í
("/dev/øm", 
O_RDWR
, 0);

171 i‡(
out_fd
 < 0)

172 
out
;

174 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

175 i‡(
ö_fd
 < 0)

176 
no˛o£_öput
;

178 
nblocks
 = 
	`idítify_ømdisk_image
(
ö_fd
, 
rd_image_°¨t
, &
decom¥ess‹
);

179 i‡(
nblocks
 < 0)

180 
d⁄e
;

182 i‡(
nblocks
 == 0) {

183 i‡(
	`¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess‹
) == 0)

184 
suc˚ssful_lﬂd
;

185 
d⁄e
;

199 i‡(
	`sys_io˘l
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

200 
rd_blocks
 = 0;

202 
rd_blocks
 >>= 1;

204 i‡(
nblocks
 > 
rd_blocks
) {

205 
	`¥ötk
("RAMDISK: imageÅoo big! (%dKiB/%ldKiB)\n",

206 
nblocks
, 
rd_blocks
);

207 
d⁄e
;

213 i‡(
	`sys_io˘l
(
ö_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

214 
devblocks
 = 0;

216 
devblocks
 >>= 1;

218 i‡(
	`°rcmp
(
‰om
, "/initrd.image") == 0)

219 
devblocks
 = 
nblocks
;

221 i‡(
devblocks
 == 0) {

222 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇot determine device size\n");

223 
d⁄e
;

226 
buf
 = 
	`kmÆloc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

227 i‡(!
buf
) {

228 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇotállocate buffer\n");

229 
d⁄e
;

232 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] intoÑam disk... ",

233 
nblocks
, (“blocks-1)/
devblocks
)+1,Çblocks>devblocks ? "s" : "");

234 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

235 i‡(
i
 && (ò% 
devblocks
 == 0)) {

236 
	`¥ötk
("d⁄êdisk #%d.\n", 
disk
++);

237 
rŸ©e
 = 0;

238 i‡(
	`sys_˛o£
(
ö_fd
)) {

239 
	`¥ötk
("Error closingÅhe disk.\n");

240 
no˛o£_öput
;

242 
	`ch™ge_Ê›py
("disk #%d", 
disk
);

243 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

244 i‡(
ö_fd
 < 0) {

245 
	`¥ötk
("Error opening disk.\n");

246 
no˛o£_öput
;

248 
	`¥ötk
("Lﬂdög disk #%d... ", 
disk
);

250 
	`sys_ªad
(
ö_fd
, 
buf
, 
BLOCK_SIZE
);

251 
	`sys_wrôe
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

252 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

253 i‡(!(
i
 % 16)) {

254 
	`¥ötk
("%c\b", 
rŸ©‹
[
rŸ©e
 & 0x3]);

255 
rŸ©e
++;

259 
	`¥ötk
("done.\n");

261 
suc˚ssful_lﬂd
:

262 
ªs
 = 1;

263 
d⁄e
:

264 
	`sys_˛o£
(
ö_fd
);

265 
no˛o£_öput
:

266 
	`sys_˛o£
(
out_fd
);

267 
out
:

268 
	`k‰ì
(
buf
);

269 
	`sys_u∆ök
("/dev/ram");

270  
ªs
;

271 
	}
}

273 
__öô
 
	$rd_lﬂd_disk
(
n
)

275 i‡(
rd_¥om±
)

276 
	`ch™ge_Ê›py
("root floppy diskÅo beÜoaded into RAM disk");

277 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

278 
	`¸óã_dev
("/dev/øm", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

279  
	`rd_lﬂd_image
("/dev/root");

280 
	}
}

282 
	gexô_code
;

283 
	gdecom¥ess_îr‹
;

284 
	g¸d_öfd
, 
	g¸d_outfd
;

286 
__öô
 
	$com¥_fûl
(*
buf
, 
Àn
)

288 
r
 = 
	`sys_ªad
(
¸d_öfd
, 
buf
, 
Àn
);

289 i‡(
r
 < 0)

290 
	`¥ötk
(
KERN_ERR
 "RAMDISK:Érror whileÑeading compressed data");

291 i‡(
r
 == 0)

292 
	`¥ötk
(
KERN_ERR
 "RAMDISK: EOF whileÑeading compressed data");

293  
r
;

294 
	}
}

296 
__öô
 
	$com¥_Êush
(*
wödow
, 
out˙t
)

298 
wrôãn
 = 
	`sys_wrôe
(
¸d_outfd
, 
wödow
, 
out˙t
);

299 i‡(
wrôãn
 !
out˙t
) {

300 i‡(
decom¥ess_îr‹
 == 0)

301 
	`¥ötk
(
KERN_ERR


303 
wrôãn
, 
out˙t
);

304 
decom¥ess_îr‹
 = 1;

307  
out˙t
;

308 
	}
}

310 
__öô
 
	$îr‹
(*
x
)

312 
	`¥ötk
(
KERN_ERR
 "%s\n", 
x
);

313 
exô_code
 = 1;

314 
decom¥ess_îr‹
 = 1;

315 
	}
}

317 
__öô
 
	$¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
)

319 
ªsu…
;

320 
¸d_öfd
 = 
ö_fd
;

321 
¸d_outfd
 = 
out_fd
;

322 
ªsu…
 = 
	`deco
(
NULL
, 0, 
com¥_fûl
, 
com¥_Êush
, NULL, NULL, 
îr‹
);

323 i‡(
decom¥ess_îr‹
)

324 
ªsu…
 = 1;

325  
ªsu…
;

326 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<löux/öô.h
>

2 
	~<löux/fs.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/ty≥s.h
>

5 
	~<löux/f˙é.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dúít.h
>

9 
	~<löux/sysˇŒs.h
>

10 
	~<löux/utime.h
>

12 
__öôd©a
 *
	gmesßge
;

13 
__öô
 
	$îr‹
(*
x
)

15 i‡(!
mesßge
)

16 
mesßge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Àn
Ë(((÷íË+ 1Ë& ~3Ë+ 2)

	)

23 
__öôd©a
 
	shash
 {

24 
	möo
, 
	mmö‹
, 
	mmaj‹
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	m√xt
;

27 
	m«me
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	ghód
[32];

30 
ölöe
 
	$hash
(
maj‹
, 
mö‹
, 
öo
)

32 
tmp
 = 
öo
 + 
mö‹
 + (
maj‹
 << 3);

33 
tmp
 +=Åmp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__öô
 *
	$föd_lök
(
maj‹
, 
mö‹
, 
öo
,

38 
mode_t
 
mode
, *
«me
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
hód
 + 
	`hash
(
maj‹
, 
mö‹
, 
öo
); *p;Ö = &(*p)->
√xt
) {

42 i‡((*
p
)->
öo
 != ino)

44 i‡((*
p
)->
mö‹
 != minor)

46 i‡((*
p
)->
maj‹
 != major)

48 i‡(((*
p
)->
mode
 ^ modeË& 
S_IFMT
)

50  (*
p
)->
«me
;

52 
q
 = 
	`kmÆloc
((
hash
), 
GFP_KERNEL
);

53 i‡(!
q
)

54 
	`∑nic
("can'tállocateÜink hashÉntry");

55 
q
->
maj‹
 = major;

56 
q
->
mö‹
 = minor;

57 
q
->
öo
 = ino;

58 
q
->
mode
 = mode;

59 
	`°r˝y
(
q
->
«me
,Çame);

60 
q
->
√xt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__öô
 
	$‰ì_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
hód
;Ö < head + 32;Ö++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
√xt
;

72 
	`k‰ì
(
q
);

75 
	}
}

77 
__öô
 
	$do_utime
(
__u£r
 *
fûíame
, 
time_t
 
mtime
)

79 
time•ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__öôd©a
 
LIST_HEAD
(
dú_li°
);

90 
	sdú_íåy
 {

91 
li°_hód
 
	mli°
;

92 *
	m«me
;

93 
time_t
 
	mmtime
;

96 
__öô
 
	$dú_add
(c⁄° *
«me
, 
time_t
 
mtime
)

98 
dú_íåy
 *
de
 = 
	`kmÆloc
((dú_íåy), 
GFP_KERNEL
);

99 i‡(!
de
)

100 
	`∑nic
("can'tállocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li°
);

102 
de
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li°_add
(&
de
->
li°
, &
dú_li°
);

105 
	}
}

107 
__öô
 
	$dú_utime
()

109 
dú_íåy
 *
de
, *
tmp
;

110 
	`li°_f‹_óch_íåy_ß„
(
de
, 
tmp
, &
dú_li°
, 
li°
) {

111 
	`li°_dñ
(&
de
->
li°
);

112 
	`do_utime
(
de
->
«me
, de->
mtime
);

113 
	`k‰ì
(
de
->
«me
);

114 
	`k‰ì
(
de
);

116 
	}
}

118 
__öôd©a
 
time_t
 
	gmtime
;

122 
__öôd©a
 
	göo
, 
	gmaj‹
, 
	gmö‹
, 
	g∆ök
;

123 
__öôd©a
 
mode_t
 
	gmode
;

124 
__öôd©a
 
	gbody_Àn
, 
	g«me_Àn
;

125 
__öôd©a
 
uid_t
 
	guid
;

126 
__öôd©a
 
gid_t
 
	ggid
;

127 
__öôd©a
 
	grdev
;

129 
__öô
 
	$∑r£_hódî
(*
s
)

131 
∑r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`mem˝y
(
buf
, 
s
, 8);

138 
∑r£d
[
i
] = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 16);

140 
öo
 = 
∑r£d
[0];

141 
mode
 = 
∑r£d
[1];

142 
uid
 = 
∑r£d
[2];

143 
gid
 = 
∑r£d
[3];

144 
∆ök
 = 
∑r£d
[4];

145 
mtime
 = 
∑r£d
[5];

146 
body_Àn
 = 
∑r£d
[6];

147 
maj‹
 = 
∑r£d
[7];

148 
mö‹
 = 
∑r£d
[8];

149 
rdev
 = 
	`√w_ícode_dev
(
	`MKDEV
(
∑r£d
[9],Öarsed[10]));

150 
«me_Àn
 = 
∑r£d
[11];

151 
	}
}

155 
__öôd©a
 
	e°©e
 {

156 
	mSèπ
,

157 
	mCﬁÀ˘
,

158 
	mGŸHódî
,

159 
	mSkùIt
,

160 
	mGŸName
,

161 
	mC›yFûe
,

162 
	mGŸSymlök
,

163 
	mRe£t


164 } 
	g°©e
, 
	g√xt_°©e
;

166 
__öôd©a
 *
	gvi˘im
;

167 
__öôd©a
 
	gcou¡
;

168 
__öôd©a
 
loff_t
 
	gthis_hódî
, 
	g√xt_hódî
;

170 
ölöe
 
__öô
 
	$ót
(
n
)

172 
vi˘im
 +
n
;

173 
this_hódî
 +
n
;

174 
cou¡
 -
n
;

175 
	}
}

177 
__öôd©a
 *
	gvcﬁÀ˘ed
;

178 
__öôd©a
 *
	gcﬁÀ˘ed
;

179 
__öôd©a
 
	gªmaös
;

180 
__öôd©a
 *
	gcﬁÀ˘
;

182 
__öô
 
	$ªad_öto
(*
buf
, 
size
, 
°©e
 
√xt
)

184 i‡(
cou¡
 >
size
) {

185 
cﬁÀ˘ed
 = 
vi˘im
;

186 
	`ót
(
size
);

187 
°©e
 = 
√xt
;

189 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
buf
;

190 
ªmaös
 = 
size
;

191 
√xt_°©e
 = 
√xt
;

192 
°©e
 = 
CﬁÀ˘
;

194 
	}
}

196 
__öôd©a
 *
	ghódî_buf
, *
	gsymlök_buf
, *
	g«me_buf
;

198 
__öô
 
	$do_°¨t
()

200 
	`ªad_öto
(
hódî_buf
, 110, 
GŸHódî
);

202 
	}
}

204 
__öô
 
	$do_cﬁÀ˘
()

206 
n
 = 
ªmaös
;

207 i‡(
cou¡
 < 
n
)

208 
n
 = 
cou¡
;

209 
	`mem˝y
(
cﬁÀ˘
, 
vi˘im
, 
n
);

210 
	`ót
(
n
);

211 
cﬁÀ˘
 +
n
;

212 i‡((
ªmaös
 -
n
) != 0)

214 
°©e
 = 
√xt_°©e
;

216 
	}
}

218 
__öô
 
	$do_hódî
()

220 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070707", 6)==0) {

221 
	`îr‹
("incorrect cpio method used: use -HÇewc option");

224 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070701", 6)) {

225 
	`îr‹
("no cpio magic");

228 
	`∑r£_hódî
(
cﬁÀ˘ed
);

229 
√xt_hódî
 = 
this_hódî
 + 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

230 
√xt_hódî
 = (next_header + 3) & ~3;

231 
°©e
 = 
SkùIt
;

232 i‡(
«me_Àn
 <0 ||Çame_À¿> 
PATH_MAX
)

234 i‡(
	`S_ISLNK
(
mode
)) {

235 i‡(
body_Àn
 > 
PATH_MAX
)

237 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
symlök_buf
;

238 
ªmaös
 = 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

239 
√xt_°©e
 = 
GŸSymlök
;

240 
°©e
 = 
CﬁÀ˘
;

243 i‡(
	`S_ISREG
(
mode
Ë|| !
body_Àn
)

244 
	`ªad_öto
(
«me_buf
, 
	`N_ALIGN
(
«me_Àn
), 
GŸName
);

246 
	}
}

248 
__öô
 
	$do_skù
()

250 i‡(
this_hódî
 + 
cou¡
 < 
√xt_hódî
) {

251 
	`ót
(
cou¡
);

254 
	`ót
(
√xt_hódî
 - 
this_hódî
);

255 
°©e
 = 
√xt_°©e
;

258 
	}
}

260 
__öô
 
	$do_ª£t
()

262 
cou¡
 && *
vi˘im
 == '\0')

263 
	`ót
(1);

264 i‡(
cou¡
 && (
this_hódî
 & 3))

265 
	`îr‹
("brokenÖadding");

267 
	}
}

269 
__öô
 
	$maybe_lök
()

271 i‡(
∆ök
 >= 2) {

272 *
ﬁd
 = 
	`föd_lök
(
maj‹
, 
mö‹
, 
öo
, 
mode
, 
cﬁÀ˘ed
);

273 i‡(
ﬁd
)

274  (
	`sys_lök
(
ﬁd
, 
cﬁÀ˘ed
) < 0) ? -1 : 1;

277 
	}
}

279 
__öô
 
	$˛ón_∑th
(*
∑th
, 
mode_t
 
mode
)

281 
°©
 
°
;

283 i‡(!
	`sys_√wl°©
(
∑th
, &
°
Ë&& (°.
°_mode
^
mode
Ë& 
S_IFMT
) {

284 i‡(
	`S_ISDIR
(
°
.
°_mode
))

285 
	`sys_rmdú
(
∑th
);

287 
	`sys_u∆ök
(
∑th
);

289 
	}
}

291 
__öôd©a
 
	gwfd
;

293 
__öô
 
	$do_«me
()

295 
°©e
 = 
SkùIt
;

296 
√xt_°©e
 = 
Re£t
;

297 i‡(
	`°rcmp
(
cﬁÀ˘ed
, "TRAILER!!!") == 0) {

298 
	`‰ì_hash
();

301 
	`˛ón_∑th
(
cﬁÀ˘ed
, 
mode
);

302 i‡(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lök
();

304 i‡(
ml
 >= 0) {

305 
›íÊags
 = 
O_WRONLY
|
O_CREAT
;

306 i‡(
ml
 != 1)

307 
›íÊags
 |
O_TRUNC
;

308 
wfd
 = 
	`sys_›í
(
cﬁÀ˘ed
, 
›íÊags
, 
mode
);

310 i‡(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 i‡(
body_Àn
)

314 
	`sys_·runˇã
(
wfd
, 
body_Àn
);

315 
vcﬁÀ˘ed
 = 
	`k°rdup
(
cﬁÀ˘ed
, 
GFP_KERNEL
);

316 
°©e
 = 
C›yFûe
;

319 } i‡(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdú
(
cﬁÀ˘ed
, 
mode
);

321 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

323 
	`dú_add
(
cﬁÀ˘ed
, 
mtime
);

324 } i‡(
	`S_ISBLK
(
mode
Ë|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

326 i‡(
	`maybe_lök
() == 0) {

327 
	`sys_mknod
(
cﬁÀ˘ed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

330 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

334 
	}
}

336 
__öô
 
	$do_c›y
()

338 i‡(
cou¡
 >
body_Àn
) {

339 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
body_Àn
);

340 
	`sys_˛o£
(
wfd
);

341 
	`do_utime
(
vcﬁÀ˘ed
, 
mtime
);

342 
	`k‰ì
(
vcﬁÀ˘ed
);

343 
	`ót
(
body_Àn
);

344 
°©e
 = 
SkùIt
;

347 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
cou¡
);

348 
body_Àn
 -
cou¡
;

349 
	`ót
(
cou¡
);

352 
	}
}

354 
__öô
 
	$do_symlök
()

356 
cﬁÀ˘ed
[
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
] = '\0';

357 
	`˛ón_∑th
(
cﬁÀ˘ed
, 0);

358 
	`sys_symlök
(
cﬁÀ˘ed
 + 
	`N_ALIGN
(
«me_Àn
), collected);

359 
	`sys_lchown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

360 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

361 
°©e
 = 
SkùIt
;

362 
√xt_°©e
 = 
Re£t
;

364 
	}
}

366 
__öôd©a
 (*
a˘i⁄s
[])() = {

367 [
Sèπ
] = 
do_°¨t
,

368 [
CﬁÀ˘
] = 
do_cﬁÀ˘
,

369 [
GŸHódî
] = 
do_hódî
,

370 [
SkùIt
] = 
do_skù
,

371 [
GŸName
] = 
do_«me
,

372 [
C›yFûe
] = 
do_c›y
,

373 [
GŸSymlök
] = 
do_symlök
,

374 [
Re£t
] = 
do_ª£t
,

375 
	}
};

377 
__öô
 
	$wrôe_buf„r
(*
buf
, 
Àn
)

379 
cou¡
 = 
Àn
;

380 
vi˘im
 = 
buf
;

382 !
a˘i⁄s
[
°©e
]())

384  
Àn
 - 
cou¡
;

385 
	}
}

387 
__öô
 
	$Êush_buf„r
(*
bufv
, 
Àn
)

389 *
buf
 = (*Ë
bufv
;

390 
wrôãn
;

391 
‹igLí
 = 
Àn
;

392 i‡(
mesßge
)

394 (
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
)Ë<Üí && !
mesßge
) {

395 
c
 = 
buf
[
wrôãn
];

396 i‡(
c
 == '0') {

397 
buf
 +
wrôãn
;

398 
Àn
 -
wrôãn
;

399 
°©e
 = 
Sèπ
;

400 } i‡(
c
 == 0) {

401 
buf
 +
wrôãn
;

402 
Àn
 -
wrôãn
;

403 
°©e
 = 
Re£t
;

405 
	`îr‹
("junk in compressedárchive");

407  
‹igLí
;

408 
	}
}

410 
	gmy_ö±r
;

412 
	~<löux/decom¥ess/gíîic.h
>

414 * 
__öô
 
	$u≈ack_to_roŸfs
(*
buf
, 
Àn
)

416 
wrôãn
, 
ªs
;

417 
decom¥ess_‚
 
decom¥ess
;

418 c⁄° *
com¥ess_«me
;

419 
__öôd©a
 
msg_buf
[64];

421 
hódî_buf
 = 
	`kmÆloc
(110, 
GFP_KERNEL
);

422 
symlök_buf
 = 
	`kmÆloc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXË+ 1, 
GFP_KERNEL
);

423 
«me_buf
 = 
	`kmÆloc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 i‡(!
hódî_buf
 || !
symlök_buf
 || !
«me_buf
)

426 
	`∑nic
("can'tállocate buffers");

428 
°©e
 = 
Sèπ
;

429 
this_hódî
 = 0;

430 
mesßge
 = 
NULL
;

431 !
mesßge
 && 
Àn
) {

432 
loff_t
 
ßved_off£t
 = 
this_hódî
;

433 i‡(*
buf
 ='0' && !(
this_hódî
 & 3)) {

434 
°©e
 = 
Sèπ
;

435 
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
);

436 
buf
 +
wrôãn
;

437 
Àn
 -
wrôãn
;

440 i‡(!*
buf
) {

441 
buf
++;

442 
Àn
--;

443 
this_hódî
++;

446 
this_hódî
 = 0;

447 
decom¥ess
 = 
	`decom¥ess_mëhod
(
buf
, 
Àn
, &
com¥ess_«me
);

448 i‡(
decom¥ess
) {

449 
ªs
 = 
	`decom¥ess
(
buf
, 
Àn
, 
NULL
, 
Êush_buf„r
, NULL,

450 &
my_ö±r
, 
îr‹
);

451 i‡(
ªs
)

452 
	`îr‹
("decompressor failed");

453 } i‡(
com¥ess_«me
) {

454 i‡(!
mesßge
) {

455 
	`¢¥ötf
(
msg_buf
,  msg_buf,

457 
com¥ess_«me
);

458 
mesßge
 = 
msg_buf
;

461 i‡(
°©e
 !
Re£t
)

462 
	`îr‹
("junk in compressedárchive");

463 
this_hódî
 = 
ßved_off£t
 + 
my_ö±r
;

464 
buf
 +
my_ö±r
;

465 
Àn
 -
my_ö±r
;

467 
	`dú_utime
();

468 
	`k‰ì
(
«me_buf
);

469 
	`k‰ì
(
symlök_buf
);

470 
	`k‰ì
(
hódî_buf
);

471  
mesßge
;

472 
	}
}

474 
__öôd©a
 
	gdo_ªèö_öôrd
;

476 
__öô
 
	$ªèö_öôrd_∑øm
(*
°r
)

478 i‡(*
°r
)

480 
do_ªèö_öôrd
 = 1;

482 
	}
}

483 
__£tup
("ªèö_öôrd", 
ªèö_öôrd_∑øm
);

485 
__öôømfs_°¨t
[], 
__öôømfs_íd
[];

486 
	~<löux/öôrd.h
>

487 
	~<löux/kexec.h
>

489 
__öô
 
	$‰ì_öôrd
()

491 #ifde‡
CONFIG_KEXEC


492 
¸ashk_°¨t
 = ()
	`__va
(
¸ashk_ªs
.
°¨t
);

493 
¸ashk_íd
 = ()
	`__va
(
¸ashk_ªs
.
íd
);

495 i‡(
do_ªèö_öôrd
)

496 
skù
;

498 #ifde‡
CONFIG_KEXEC


503 i‡(
öôrd_°¨t
 < 
¸ashk_íd
 && 
öôrd_íd
 > 
¸ashk_°¨t
) {

508 
	`mem£t
((*)
öôrd_°¨t
, 0, 
öôrd_íd
 - initrd_start);

509 i‡(
öôrd_°¨t
 < 
¸ashk_°¨t
)

510 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
¸ashk_°¨t
);

511 i‡(
öôrd_íd
 > 
¸ashk_íd
)

512 
	`‰ì_öôrd_mem
(
¸ashk_íd
, 
öôrd_íd
);

515 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
öôrd_íd
);

516 
skù
:

517 
öôrd_°¨t
 = 0;

518 
öôrd_íd
 = 0;

519 
	}
}

521 #ifde‡
CONFIG_BLK_DEV_RAM


522 
	#BUF_SIZE
 1024

	)

523 
__öô
 
	$˛ón_roŸfs
()

525 
fd
;

526 *
buf
;

527 
löux_dúít64
 *
dúp
;

528 
cou¡
;

530 
fd
 = 
	`sys_›í
("/", 
O_RDONLY
, 0);

531 
	`WARN_ON
(
fd
 < 0);

532 i‡(
fd
 < 0)

534 
buf
 = 
	`kzÆloc
(
BUF_SIZE
, 
GFP_KERNEL
);

535 
	`WARN_ON
(!
buf
);

536 i‡(!
buf
) {

537 
	`sys_˛o£
(
fd
);

541 
dúp
 = 
buf
;

542 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

543 
cou¡
 > 0) {

544 
cou¡
 > 0) {

545 
°©
 
°
;

546 
ªt
;

548 
ªt
 = 
	`sys_√wl°©
(
dúp
->
d_«me
, &
°
);

549 
	`WARN_ON_ONCE
(
ªt
);

550 i‡(!
ªt
) {

551 i‡(
	`S_ISDIR
(
°
.
°_mode
))

552 
	`sys_rmdú
(
dúp
->
d_«me
);

554 
	`sys_u∆ök
(
dúp
->
d_«me
);

557 
cou¡
 -
dúp
->
d_ª˛í
;

558 
dúp
 = (*)dú∞+ dúp->
d_ª˛í
;

560 
dúp
 = 
buf
;

561 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

562 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

565 
	`sys_˛o£
(
fd
);

566 
	`k‰ì
(
buf
);

567 
	}
}

570 
__öô
 
	$p›uœã_roŸfs
()

572 *
îr
 = 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

573 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

574 i‡(
îr
)

575 
	`∑nic
(
îr
);

576 i‡(
öôrd_°¨t
) {

577 #ifde‡
CONFIG_BLK_DEV_RAM


578 
fd
;

579 
	`¥ötk
(
KERN_INFO
 "TryingÅo unpackÑootfs imageás initramfs...\n");

580 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

581 
öôrd_íd
 - 
öôrd_°¨t
);

582 i‡(!
îr
) {

583 
	`‰ì_öôrd
();

586 
	`˛ón_roŸfs
();

587 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

588 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

590 
	`¥ötk
(
KERN_INFO
 "rootfs image isÇot initramfs (%s)"

591 ";Üook†likê™ inôrd\n", 
îr
);

592 
fd
 = 
	`sys_›í
("/öôrd.image", 
O_WRONLY
|
O_CREAT
, 0700);

593 i‡(
fd
 >= 0) {

594 
	`sys_wrôe
(
fd
, (*)
öôrd_°¨t
,

595 
öôrd_íd
 - 
öôrd_°¨t
);

596 
	`sys_˛o£
(
fd
);

597 
	`‰ì_öôrd
();

600 
	`¥ötk
(
KERN_INFO
 "Unpacking initramfs...\n");

601 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

602 
öôrd_íd
 - 
öôrd_°¨t
);

603 i‡(
îr
)

604 
	`¥ötk
(
KERN_EMERG
 "Inôømf†u≈ackög faûed: %s\n", 
îr
);

605 
	`‰ì_öôrd
();

609 
	}
}

610 
roŸfs_öôˇŒ
(
p›uœã_roŸfs
);

	@/cmpt816/linux/init/main.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/˘y≥.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/smp_lock.h
>

24 
	~<löux/öôrd.h
>

25 
	~<löux/boŸmem.h
>

26 
	~<löux/a˝i.h
>

27 
	~<löux/ây.h
>

28 
	~<löux/gÂ.h
>

29 
	~<löux/≥r˝u.h
>

30 
	~<löux/kmod.h
>

31 
	~<löux/vmÆloc.h
>

32 
	~<löux/kî√l_°©.h
>

33 
	~<löux/°¨t_kî√l.h
>

34 
	~<löux/£curôy.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/¥ofûe.h
>

38 
	~<löux/rcupd©e.h
>

39 
	~<löux/moduÀ∑øm.h
>

40 
	~<löux/kÆlsyms.h
>

41 
	~<löux/wrôeback.h
>

42 
	~<löux/˝u.h
>

43 
	~<löux/˝u£t.h
>

44 
	~<löux/cgroup.h
>

45 
	~<löux/efi.h
>

46 
	~<löux/tick.h
>

47 
	~<löux/öãºu±.h
>

48 
	~<löux/èsk°©s_kîn.h
>

49 
	~<löux/dñayac˘.h
>

50 
	~<löux/uni°d.h
>

51 
	~<löux/rm≠.h
>

52 
	~<löux/mempﬁicy.h
>

53 
	~<löux/key.h
>

54 
	~<löux/buf„r_hód.h
>

55 
	~<löux/∑ge_cgroup.h
>

56 
	~<löux/debug_locks.h
>

57 
	~<löux/debugobje˘s.h
>

58 
	~<löux/lockdï.h
>

59 
	~<löux/kmemÀak.h
>

60 
	~<löux/pid_«me•a˚.h
>

61 
	~<löux/devi˚.h
>

62 
	~<löux/kthªad.h
>

63 
	~<löux/sched.h
>

64 
	~<löux/sig«l.h
>

65 
	~<löux/idr.h
>

66 
	~<löux/·ø˚.h
>

67 
	~<löux/async.h
>

68 
	~<löux/kmemcheck.h
>

69 
	~<löux/kmemåa˚.h
>

70 
	~<löux/sfi.h
>

71 
	~<löux/shmem_fs.h
>

72 
	~<åa˚/boŸ.h
>

74 
	~<asm/io.h
>

75 
	~<asm/bugs.h
>

76 
	~<asm/£tup.h
>

77 
	~<asm/£˘i⁄s.h
>

78 
	~<asm/ˇcheÊush.h
>

80 #ifde‡
CONFIG_X86_LOCAL_APIC


81 
	~<asm/smp.h
>

84 
kî√l_öô
(*);

86 
öô_IRQ
();

87 
f‹k_öô
();

88 
mˇ_öô
();

89 
sbus_öô
();

90 
¥io_åì_öô
();

91 
ødix_åì_öô
();

92 
‰ì_öômem
();

93 #i‚de‡
CONFIG_DEBUG_RODATA


94 
ölöe
 
	$m¨k_rod©a_ro
(Ë{ 
	}
}

97 #ifde‡
CONFIG_TC


98 
tc_öô
();

101 
sy°em_°©es
 
sy°em_°©e
 
	g__ªad_mo°ly
;

102 
EXPORT_SYMBOL
(
sy°em_°©e
);

107 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

108 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

110 
time_öô
();

112 (*
__öôd©a
 
œã_time_öô
)();

113 
	`so·úq_öô
();

116 
__öôd©a
 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
];

118 *
ßved_comm™d_löe
;

120 *
°©ic_comm™d_löe
;

122 *
execuã_comm™d
;

123 *
ømdisk_execuã_comm™d
;

125 #ifde‡
CONFIG_SMP


127 
__öôd©a
 
£tup_max_˝us
 = 
NR_CPUS
;

140 
__wók
 
	$¨ch_dißbÀ_smp_suµ‹t
(Ë{ 
	}
}

142 
__öô
 
	$nosmp
(*
°r
)

144 
£tup_max_˝us
 = 0;

145 
	`¨ch_dißbÀ_smp_suµ‹t
();

148 
	}
}

150 
óæy_∑øm
("nosmp", 
nosmp
);

152 
__öô
 
	$max˝us
(*
°r
)

154 
	`gë_›ti⁄
(&
°r
, &
£tup_max_˝us
);

155 i‡(
£tup_max_˝us
 == 0)

156 
	`¨ch_dißbÀ_smp_suµ‹t
();

159 
	}
}

161 
óæy_∑øm
("max˝us", 
max˝us
);

163 c⁄° 
	g£tup_max_˝us
 = 
NR_CPUS
;

175 
	gª£t_devi˚s
;

176 
EXPORT_SYMBOL
(
ª£t_devi˚s
);

178 
__öô
 
	$£t_ª£t_devi˚s
(*
°r
)

180 
ª£t_devi˚s
 = 1;

182 
	}
}

184 
__£tup
("ª£t_devi˚s", 
£t_ª£t_devi˚s
);

186 * 
	g¨gv_öô
[
MAX_INIT_ARGS
+2] = { "öô", 
NULL
, };

187 * 
	gívp_öô
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMˆöux", 
NULL
, };

188 c⁄° *
	g∑nic_œãr
, *
	g∑nic_∑øm
;

190 
obs_kî√l_∑øm
 
__£tup_°¨t
[], 
__£tup_íd
[];

192 
__öô
 
	$obsﬁëe_check£tup
(*
löe
)

194 
obs_kî√l_∑øm
 *
p
;

195 
had_óæy_∑øm
 = 0;

197 
p
 = 
__£tup_°¨t
;

199 
n
 = 
	`°æí
(
p
->
°r
);

200 i‡(!
	`°∫cmp
(
löe
, 
p
->
°r
, 
n
)) {

201 i‡(
p
->
óæy
) {

206 i‡(
löe
[
n
] == '\0' ||Üine[n] == '=')

207 
had_óæy_∑øm
 = 1;

208 } i‡(!
p
->
£tup_func
) {

209 
	`¥ötk
(
KERN_WARNING
 "Parameter %s is obsolete,"

210 " ign‹ed\n", 
p
->
°r
);

212 } i‡(
p
->
	`£tup_func
(
löe
 + 
n
))

215 
p
++;

216 } 
p
 < 
__£tup_íd
);

218  
had_óæy_∑øm
;

219 
	}
}

225 
	glo›s_≥r_jiffy
 = (1<<12);

227 
EXPORT_SYMBOL
(
lo›s_≥r_jiffy
);

229 
__öô
 
	$debug_kî√l
(*
°r
)

231 
c⁄sﬁe_logÀvñ
 = 10;

233 
	}
}

235 
__öô
 
	$quõt_kî√l
(*
°r
)

237 
c⁄sﬁe_logÀvñ
 = 4;

239 
	}
}

241 
óæy_∑øm
("debug", 
debug_kî√l
);

242 
óæy_∑øm
("quõt", 
quõt_kî√l
);

244 
__öô
 
	$logÀvñ
(*
°r
)

246 
	`gë_›ti⁄
(&
°r
, &
c⁄sﬁe_logÀvñ
);

248 
	}
}

250 
óæy_∑øm
("logÀvñ", 
logÀvñ
);

256 
__öô
 
	$unknown_boŸ›ti⁄
(*
∑øm
, *
vÆ
)

259 i‡(
vÆ
) {

261 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+1)

262 
vÆ
[-1] = '=';

263 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+2) {

264 
vÆ
[-2] = '=';

265 
	`memmove
(
vÆ
-1, vÆ, 
	`°æí
(val)+1);

266 
vÆ
--;

268 
	`BUG
();

272 i‡(
	`obsﬁëe_check£tup
(
∑øm
))

276 i‡(
	`°rchr
(
∑øm
, '.'Ë&& (!
vÆ
 || strchr(param, '.') < val))

279 i‡(
∑nic_œãr
)

282 i‡(
vÆ
) {

284 
i
;

285 
i
 = 0; 
ívp_öô
[i]; i++) {

286 i‡(
i
 =
MAX_INIT_ENVS
) {

287 
∑nic_œãr
 = "Too many bootÉnv varsát `%s'";

288 
∑nic_∑øm
 = 
∑øm
;

290 i‡(!
	`°∫cmp
(
∑øm
, 
ívp_öô
[
i
], 
vÆ
 -Öaram))

293 
ívp_öô
[
i
] = 
∑øm
;

296 
i
;

297 
i
 = 0; 
¨gv_öô
[i]; i++) {

298 i‡(
i
 =
MAX_INIT_ARGS
) {

299 
∑nic_œãr
 = "Too many boot init varsát `%s'";

300 
∑nic_∑øm
 = 
∑øm
;

303 
¨gv_öô
[
i
] = 
∑øm
;

306 
	}
}

308 #ifde‡
CONFIG_DEBUG_PAGEALLOC


309 
__ªad_mo°ly
 
	gdebug_∑góŒoc_íabÀd
 = 0;

312 
__öô
 
	$öô_£tup
(*
°r
)

314 
i
;

316 
execuã_comm™d
 = 
°r
;

323 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

324 
¨gv_öô
[
i
] = 
NULL
;

326 
	}
}

327 
__£tup
("öô=", 
öô_£tup
);

329 
__öô
 
	$rdöô_£tup
(*
°r
)

331 
i
;

333 
ømdisk_execuã_comm™d
 = 
°r
;

335 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

336 
¨gv_öô
[
i
] = 
NULL
;

338 
	}
}

339 
__£tup
("rdöô=", 
rdöô_£tup
);

341 #i‚de‡
CONFIG_SMP


343 #ifde‡
CONFIG_X86_LOCAL_APIC


344 
__öô
 
	$smp_öô
()

346 
	`APIC_öô_unùro˚ss‹
();

347 
	}
}

349 
	#smp_öô
(Ëdÿ{ } 0)

	)

352 
ölöe
 
	$£tup_ƒ_˝u_ids
(Ë{ 
	}
}

353 
ölöe
 
	$smp_¥ï¨e_˝us
(
max˝us
Ë{ 
	}
}

358 
ƒ_˝u_ids
 
	g__ªad_mo°ly
 = 
NR_CPUS
;

359 
EXPORT_SYMBOL
(
ƒ_˝u_ids
);

362 
__öô
 
	$£tup_ƒ_˝u_ids
()

364 
ƒ_˝u_ids
 = 
	`föd_œ°_bô
(
	`˝umask_bôs
(
˝u_possibÀ_mask
),
NR_CPUS
) + 1;

365 
	}
}

368 
__öô
 
	$smp_öô
()

370 
˝u
;

373 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

374 i‡(
	`num_⁄löe_˝us
(Ë>
£tup_max_˝us
)

376 i‡(!
	`˝u_⁄löe
(
˝u
))

377 
	`˝u_up
(
˝u
);

381 
	`¥ötk
(
KERN_INFO
 "Broughàu∞%ld CPUs\n", ()
	`num_⁄löe_˝us
());

382 
	`smp_˝us_d⁄e
(
£tup_max_˝us
);

383 
	}
}

393 
__öô
 
	$£tup_comm™d_löe
(*
comm™d_löe
)

395 
ßved_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
boŸ_comm™d_löe
)+1);

396 
°©ic_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
comm™d_löe
)+1);

397 
	`°r˝y
 (
ßved_comm™d_löe
, 
boŸ_comm™d_löe
);

398 
	`°r˝y
 (
°©ic_comm™d_löe
, 
comm™d_löe
);

399 
	}
}

410 
noölöe
 
__öô_ªfok
 
	$ª°_öô
()

411 
	$__ªÀa£s
(
kî√l_lock
)

413 
pid
;

415 
	`rcu_scheduÀr_°¨tög
();

416 
	`kî√l_thªad
(
kî√l_öô
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

417 
	`numa_deÁu…_pﬁicy
();

418 
pid
 = 
	`kî√l_thªad
(
kthªadd
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

419 
kthªadd_èsk
 = 
	`föd_èsk_by_pid_ns
(
pid
, &
öô_pid_ns
);

420 
	`u∆ock_kî√l
();

426 
	`öô_idÀ_boŸup_èsk
(
cuºít
);

427 
	`¥ìm±_íabÀ_no_ªsched
();

428 
	`scheduÀ
();

429 
	`¥ìm±_dißbÀ
();

432 
	`˝u_idÀ
();

433 
	}
}

436 
__öô
 
	$do_óæy_∑øm
(*
∑øm
, *
vÆ
)

438 
obs_kî√l_∑øm
 *
p
;

440 
p
 = 
__£tup_°¨t
;Ö < 
__£tup_íd
;Ö++) {

441 i‡((
p
->
óæy
 && 
	`°rcmp
(
∑øm
,Ö->
°r
) == 0) ||

442 (
	`°rcmp
(
∑øm
, "console") == 0 &&

443 
	`°rcmp
(
p
->
°r
, "earlycon") == 0)

445 i‡(
p
->
	`£tup_func
(
vÆ
) != 0)

446 
	`¥ötk
(
KERN_WARNING


447 "MÆf‹medÉ¨ly o±i⁄ '%s'\n", 
∑øm
);

452 
	}
}

454 
__öô
 
	$∑r£_óæy_›ti⁄s
(*
cmdlöe
)

456 
	`∑r£_¨gs
("óæy o±i⁄s", 
cmdlöe
, 
NULL
, 0, 
do_óæy_∑øm
);

457 
	}
}

460 
__öô
 
	$∑r£_óæy_∑øm
()

462 
__öôd©a
 
d⁄e
 = 0;

463 
__öôd©a
 
tmp_cmdlöe
[
COMMAND_LINE_SIZE
];

465 i‡(
d⁄e
)

469 
	`°æ˝y
(
tmp_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

470 
	`∑r£_óæy_›ti⁄s
(
tmp_cmdlöe
);

471 
d⁄e
 = 1;

472 
	}
}

478 
__öô
 
	$boŸ_˝u_öô
()

480 
˝u
 = 
	`smp_¥o˚ss‹_id
();

482 
	`£t_˝u_⁄löe
(
˝u
, 
åue
);

483 
	`£t_˝u_a˘ive
(
˝u
, 
åue
);

484 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

485 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

486 
	}
}

488 
__öô
 
__wók
 
	$smp_£tup_¥o˚ss‹_id
()

490 
	}
}

492 
__öô
 
__wók
 
	$thªad_öfo_ˇche_öô
()

494 
	}
}

499 
__öô
 
	$mm_öô
()

505 
	`∑ge_cgroup_öô_Ê©mem
();

506 
	`mem_öô
();

507 
	`kmem_ˇche_öô
();

508 
	`pgèbÀ_ˇche_öô
();

509 
	`vmÆloc_öô
();

510 
	}
}

512 
asmlökage
 
__öô
 
	$°¨t_kî√l
()

514 * 
comm™d_löe
;

515 
kî√l_∑øm
 
__°¨t___∑øm
[], 
__°›___∑øm
[];

517 
	`smp_£tup_¥o˚ss‹_id
();

523 
	`lockdï_öô
();

524 
	`debug_obje˘s_óæy_öô
();

529 
	`boŸ_öô_°ack_ˇ«ry
();

531 
	`cgroup_öô_óæy
();

533 
	`loˇl_úq_dißbÀ
();

534 
	`óæy_boŸ_úqs_off
();

535 
	`óæy_öô_úq_lock_˛ass
();

541 
	`lock_kî√l
();

542 
	`tick_öô
();

543 
	`boŸ_˝u_öô
();

544 
	`∑ge_addªss_öô
();

545 
	`¥ötk
(
KERN_NOTICE
 "%s", 
löux_b™√r
);

546 
	`£tup_¨ch
(&
comm™d_löe
);

547 
	`mm_öô_ow√r
(&
öô_mm
, &
öô_èsk
);

548 
	`£tup_comm™d_löe
(
comm™d_löe
);

549 
	`£tup_ƒ_˝u_ids
();

550 
	`£tup_≥r_˝u_¨ós
();

551 
	`smp_¥ï¨e_boŸ_˝u
();

553 
	`buûd_Æl_z⁄ñi°s
();

554 
	`∑ge_Æloc_öô
();

556 
	`¥ötk
(
KERN_NOTICE
 "Kî√»comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

557 
	`∑r£_óæy_∑øm
();

558 
	`∑r£_¨gs
("BoŸög kî√l", 
°©ic_comm™d_löe
, 
__°¨t___∑øm
,

559 
__°›___∑øm
 - 
__°¨t___∑øm
,

560 &
unknown_boŸ›ti⁄
);

565 
	`pidhash_öô
();

566 
	`vfs_ˇches_öô_óæy
();

567 
	`s‹t_maö_exèbÀ
();

568 
	`å≠_öô
();

569 
	`mm_öô
();

575 
	`sched_öô
();

580 
	`¥ìm±_dißbÀ
();

581 i‡(!
	`úqs_dißbÀd
()) {

582 
	`¥ötk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

584 
	`loˇl_úq_dißbÀ
();

586 
	`rcu_öô
();

588 
	`óæy_úq_öô
();

589 
	`öô_IRQ
();

590 
	`¥io_åì_öô
();

591 
	`öô_timîs
();

592 
	`hπimîs_öô
();

593 
	`so·úq_öô
();

594 
	`timekìpög_öô
();

595 
	`time_öô
();

596 
	`¥ofûe_öô
();

597 i‡(!
	`úqs_dißbÀd
())

598 
	`¥ötk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

600 
	`óæy_boŸ_úqs_⁄
();

601 
	`loˇl_úq_íabÀ
();

604 
	`£t_gÂ_Ælowed_mask
(
__GFP_BITS_MASK
);

606 
	`kmem_ˇche_öô_œã
();

613 
	`c⁄sﬁe_öô
();

614 i‡(
∑nic_œãr
)

615 
	`∑nic
(
∑nic_œãr
, 
∑nic_∑øm
);

617 
	`lockdï_öfo
();

624 
	`lockög_£l·e°
();

626 #ifde‡
CONFIG_BLK_DEV_INITRD


627 i‡(
öôrd_°¨t
 && !
öôrd_bñow_°¨t_ok
 &&

628 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)Ë< 
mö_low_p‚
) {

629 
	`¥ötk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

631 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)),

632 
mö_low_p‚
);

633 
öôrd_°¨t
 = 0;

636 
	`∑ge_cgroup_öô
();

637 
	`íabÀ_debug_∑góŒoc
();

638 
	`kmemåa˚_öô
();

639 
	`kmemÀak_öô
();

640 
	`debug_obje˘s_mem_öô
();

641 
	`idr_öô_ˇche
();

642 
	`£tup_≥r_˝u_∑ge£t
();

643 
	`numa_pﬁicy_öô
();

644 i‡(
œã_time_öô
)

645 
	`œã_time_öô
();

646 
	`sched_˛ock_öô
();

647 
	`ˇlibøã_dñay
();

648 
	`pidm≠_öô
();

649 
	`™⁄_vma_öô
();

650 #ifde‡
CONFIG_X86


651 i‡(
efi_íabÀd
)

652 
	`efi_íãr_vútuÆ_mode
();

654 
	`thªad_öfo_ˇche_öô
();

655 
	`¸ed_öô
();

656 
	`f‹k_öô
(
tŸÆøm_∑ges
);

657 
	`¥oc_ˇches_öô
();

658 
	`buf„r_öô
();

659 
	`key_öô
();

660 
	`ødix_åì_öô
();

661 
	`£curôy_öô
();

662 
	`vfs_ˇches_öô
(
tŸÆøm_∑ges
);

663 
	`sig«ls_öô
();

665 
	`∑ge_wrôeback_öô
();

666 #ifde‡
CONFIG_PROC_FS


667 
	`¥oc_roŸ_öô
();

669 
	`cgroup_öô
();

670 
	`˝u£t_öô
();

671 
	`èsk°©s_öô_óæy
();

672 
	`dñayac˘_öô
();

674 
	`check_bugs
();

676 
	`a˝i_óæy_öô
();

677 
	`sfi_öô_œã
();

679 
	`·ø˚_öô
();

682 
	`ª°_öô
();

683 
	}
}

686 
__öô
 
	$do_˘‹s
()

688 #ifde‡
CONFIG_CONSTRUCTORS


689 
˘‹_‚_t
 *
‚
 = (˘‹_‚_à*Ë
__˘‹s_°¨t
;

691 ; 
‚
 < (
˘‹_‚_t
 *Ë
__˘‹s_íd
; fn++)

692 (*
‚
)();

694 
	}
}

696 
	göôˇŒ_debug
;

697 
c‹e_∑øm
(
öôˇŒ_debug
, inôˇŒ_debug, 
boﬁ
, 0644);

699 
	gmsgbuf
[64];

700 
boŸ_åa˚_ˇŒ
 
	gˇŒ
;

701 
boŸ_åa˚_ªt
 
	gªt
;

703 
	$do_⁄e_öôˇŒ
(
öôˇŒ_t
 
‚
)

705 
cou¡
 = 
	`¥ìm±_cou¡
();

706 
ktime_t
 
ˇŒtime
, 
dñè
, 
ªâime
;

708 i‡(
öôˇŒ_debug
) {

709 
ˇŒ
.
ˇŒî
 = 
	`èsk_pid_ƒ
(
cuºít
);

710 
	`¥ötk
("ˇŒög %pF @ %i\n", 
‚
, 
ˇŒ
.
ˇŒî
);

711 
ˇŒtime
 = 
	`ktime_gë
();

712 
	`åa˚_boŸ_ˇŒ
(&
ˇŒ
, 
‚
);

713 
	`íabÀ_boŸ_åa˚
();

716 
ªt
.
ªsu…
 = 
	`‚
();

718 i‡(
öôˇŒ_debug
) {

719 
	`dißbÀ_boŸ_åa˚
();

720 
ªâime
 = 
	`ktime_gë
();

721 
dñè
 = 
	`ktime_sub
(
ªâime
, 
ˇŒtime
);

722 
ªt
.
duøti⁄
 = (Ë
	`ktime_to_ns
(
dñè
) >> 10;

723 
	`åa˚_boŸ_ªt
(&
ªt
, 
‚
);

724 
	`¥ötk
("öôˇŒ %pFÑëu∫ed %dá·î %Ld u£cs\n", 
‚
,

725 
ªt
.
ªsu…
,Ñë.
duøti⁄
);

728 
msgbuf
[0] = 0;

730 i‡(
ªt
.
ªsu…
 &&Ñë.ªsu… !-
ENODEV
 && 
öôˇŒ_debug
)

731 
	`•rötf
(
msgbuf
, "îr‹ codê%d ", 
ªt
.
ªsu…
);

733 i‡(
	`¥ìm±_cou¡
(Ë!
cou¡
) {

734 
	`°æˇt
(
msgbuf
, "preemption imbalance ", (msgbuf));

735 
	`¥ìm±_cou¡
(Ë
cou¡
;

737 i‡(
	`úqs_dißbÀd
()) {

738 
	`°æˇt
(
msgbuf
, "disabled interrupts ", (msgbuf));

739 
	`loˇl_úq_íabÀ
();

741 i‡(
msgbuf
[0]) {

742 
	`¥ötk
("öôˇŒ %pFÑëu∫ed wôh %s\n", 
‚
, 
msgbuf
);

745  
ªt
.
ªsu…
;

746 
	}
}

749 
öôˇŒ_t
 
__öôˇŒ_°¨t
[], 
__öôˇŒ_íd
[], 
__óæy_öôˇŒ_íd
[];

751 
__öô
 
	$do_öôˇŒs
()

753 
öôˇŒ_t
 *
‚
;

755 
‚
 = 
__óæy_öôˇŒ_íd
; f¿< 
__öôˇŒ_íd
; fn++)

756 
	`do_⁄e_öôˇŒ
(*
‚
);

759 
	`Êush_scheduÀd_w‹k
();

760 
	}
}

769 
__öô
 
	$do_basic_£tup
()

771 
	`öô_w‹kqueues
();

772 
	`˝u£t_öô_smp
();

773 
	`u£rmodehñ≥r_öô
();

774 
	`öô_tmpfs
();

775 
	`drivî_öô
();

776 
	`öô_úq_¥oc
();

777 
	`do_˘‹s
();

778 
	`do_öôˇŒs
();

779 
	}
}

781 
__öô
 
	$do_¥e_smp_öôˇŒs
()

783 
öôˇŒ_t
 *
‚
;

785 
‚
 = 
__öôˇŒ_°¨t
; f¿< 
__óæy_öôˇŒ_íd
; fn++)

786 
	`do_⁄e_öôˇŒ
(*
‚
);

787 
	}
}

789 
	$run_öô_¥o˚ss
(*
öô_fûíame
)

791 
¨gv_öô
[0] = 
öô_fûíame
;

792 
	`kî√l_execve
(
öô_fûíame
, 
¨gv_öô
, 
ívp_öô
);

793 
	}
}

798 
noölöe
 
	$öô_po°
()

799 
	$__ªÀa£s
(
kî√l_lock
)

802 
	`async_synchr⁄ize_fuŒ
();

803 
	`‰ì_öômem
();

804 
	`u∆ock_kî√l
();

805 
	`m¨k_rod©a_ro
();

806 
sy°em_°©e
 = 
SYSTEM_RUNNING
;

807 
	`numa_deÁu…_pﬁicy
();

809 i‡(
	`sys_›í
((c⁄° 
__u£r
 *Ë"/dev/c⁄sﬁe", 
O_RDWR
, 0) < 0)

810 
	`¥ötk
(
KERN_WARNING
 "Warning: unableÅo openán initial console.\n");

812 (Ë
	`sys_dup
(0);

813 (Ë
	`sys_dup
(0);

815 
cuºít
->
sig«l
->
Êags
 |
SIGNAL_UNKILLABLE
;

817 i‡(
ømdisk_execuã_comm™d
) {

818 
	`run_öô_¥o˚ss
(
ømdisk_execuã_comm™d
);

819 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s\n",

820 
ømdisk_execuã_comm™d
);

829 i‡(
execuã_comm™d
) {

830 
	`run_öô_¥o˚ss
(
execuã_comm™d
);

831 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s. Attempting "

832 "deÁu…s...\n", 
execuã_comm™d
);

834 
	`run_öô_¥o˚ss
("/sbin/init");

835 
	`run_öô_¥o˚ss
("/etc/init");

836 
	`run_öô_¥o˚ss
("/bin/init");

837 
	`run_öô_¥o˚ss
("/bin/sh");

839 
	`∑nic
("No init found. TryÖassing init= optionÅo kernel.");

840 
	}
}

842 
__öô
 
	$kî√l_öô
(* 
unu£d
)

844 
	`lock_kî√l
();

849 
	`£t_mems_Ælowed
(
node_possibÀ_m≠
);

853 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
˝u_Æl_mask
);

862 
öô_pid_ns
.
chûd_ª≠î
 = 
cuºít
;

864 
ˇd_pid
 = 
	`èsk_pid
(
cuºít
);

866 
	`smp_¥ï¨e_˝us
(
£tup_max_˝us
);

868 
	`do_¥e_smp_öôˇŒs
();

869 
	`°¨t_boŸ_åa˚
();

871 
	`smp_öô
();

872 
	`sched_öô_smp
();

874 
	`do_basic_£tup
();

881 i‡(!
ømdisk_execuã_comm™d
)

882 
ømdisk_execuã_comm™d
 = "/init";

884 i‡(
	`sys_ac˚ss
((c⁄° 
__u£r
 *Ë
ømdisk_execuã_comm™d
, 0) != 0) {

885 
ømdisk_execuã_comm™d
 = 
NULL
;

886 
	`¥ï¨e_«me•a˚
();

895 
	`öô_po°
();

897 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<gíî©ed/compûe.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/uts.h
>

12 
	~<löux/ut¢ame.h
>

13 
	~<gíî©ed/ut§ñó£.h
>

14 
	~<löux/vîsi⁄.h
>

16 #i‚de‡
CONFIG_KALLSYMS


17 
	#vîsi⁄
(
a
Ë
Vîsi⁄_
 ## 
	)
a

18 
	#vîsi⁄_°rög
(
a
Ë
	`vîsi⁄
◊)

	)

20 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

21 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

24 
uts_«me•a˚
 
	göô_uts_ns
 = {

25 .
kªf
 = {

26 .
ªfcou¡
 = 
ATOMIC_INIT
(2),

28 .
	g«me
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnodíame
 = 
UTS_NODENAME
,

31 .
	gªÀa£
 = 
UTS_RELEASE
,

32 .
	gvîsi⁄
 = 
UTS_VERSION
,

33 .
	gmachöe
 = 
UTS_MACHINE
,

34 .
	gdomaö«me
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
öô_uts_ns
);

40 c⁄° 
	glöux_b™√r
[] =

41 "Löux vîsi⁄ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "Ë(" 
LINUX_COMPILER
 "Ë" 
UTS_VERSION
 "\n";

44 c⁄° 
	glöux_¥oc_b™√r
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
157
6680
/cmpt816/linux/arch/x86/ia32/audit.c
/cmpt816/linux/arch/x86/ia32/ia32_signal.c
/cmpt816/linux/arch/x86/ia32/ipc32.c
/cmpt816/linux/arch/x86/ia32/sys_ia32.c
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c
/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/sched.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/x86_init.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/physaddr.c
/cmpt816/linux/arch/x86/mm/setup_nx.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
