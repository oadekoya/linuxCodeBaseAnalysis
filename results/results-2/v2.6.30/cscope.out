cscope 15 /cmpt816/data -q 0000010195 0001288084
	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<lšux/š™.h
>

27 
	~<lšux/aıi.h
>

28 
	~<lšux/aıi_pmtmr.h
>

29 
	~<lšux/efi.h
>

30 
	~<lšux/ıumask.h
>

31 
	~<lšux/moduË.h
>

32 
	~<lšux/dmi.h
>

33 
	~<lšux/œq.h
>

34 
	~<lšux/boÙmem.h
>

35 
	~<lšux/iİÜt.h
>

37 
	~<asm/pgbË.h
>

38 
	~<asm/io_­ic.h
>

39 
	~<asm/­ic.h
>

40 
	~<asm/io.h
>

41 
	~<asm/mp¥ec.h
>

42 
	~<asm/smp.h
>

44 
__š™d©a
 
	gaıi_fÜû
 = 0;

45 
u32
 
	gaıi_rsdt_fÜûd
;

46 #ifdef 
CONFIG_ACPI


47 
	gaıi_di§bËd
 = 0;

49 
	gaıi_di§bËd
 = 1;

51 
EXPORT_SYMBOL
(
aıi_di§bËd
);

53 #ifdef 
CONFIG_X86_64


54 
	~<asm/´Ùo.h
>

57 
	#BAD_MADT_ENTRY
(
’Œy
, 
’d
) ( \

58 (!
’Œy
è|| (ëÁry + (*’Œyè> 
’d
 || \

59 ((
aıi_subbË_h—d”
 *)
’Œy
)->
Ëngth
 < (*’Œy))

	)

61 
	#PREFIX
 "ACPI: "

	)

63 
	gaıi_noœq
;

64 
	gaıi_pci_di§bËd
;

65 
EXPORT_SYMBOL
(
aıi_pci_di§bËd
);

66 
aıi_ht
 
	g__š™d©a
 = 1;

68 
	gaıi_Ïpic
;

69 
	gaıi_ißpic
;

70 
	gaıi_¡riù
;

72 
u8
 
aıi_sci_æags
 
	g__š™d©a
;

73 
aıi_sci_ov”ride_gsi
 
	g__š™d©a
;

74 
aıi_sk_tim”_ov”ride
 
	g__š™d©a
;

75 
aıi_u£_tim”_ov”ride
 
	g__š™d©a
;

77 #ifdeà
CONFIG_X86_LOCAL_APIC


78 
u64
 
aıi_Ïpic_addr
 
	g__š™d©a
 = 
APIC_DEFAULT_PHYS_BASE
;

81 #iâdeà
__HAVE_ARCH_CMPXCHG


82 #w¬nšg 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
ªd
 
Ï‹r
 
h¬dw¬e


93 
aıi_œq_mod–_id
 
	gaıi_œq_mod–
 = 
ACPI_IRQ_MODEL_PIC
;

108 *
__š™
 
	$__aıi_m­_bË
(
phys
, 
size
)

111 ià(!
phys
 || !
size
)

112  
NULL
;

114  
	`—¾y_iÜem­
(
phys
, 
size
);

115 
	}
}

116 
__š™
 
	$__aıi_unm­_bË
(*
m­
, 
size
)

118 ià(!
m­
 || !
size
)

121 
	`—¾y_iounm­
(
m­
, 
size
);

122 
	}
}

124 #ifdeà
CONFIG_PCI_MMCONFIG


126 
aıi_mcfg_64b™_ba£_addr
 
	g__š™d©a
 = 
FALSE
;

129 
aıi_mcfg_®loÿtiÚ
 *
	gpci_mmcfg_cÚfig
;

130 
	gpci_mmcfg_cÚfig_num
;

132 
__š™
 
	$aıi_mcfg_Ûm_check
(
aıi_bË_mcfg
 *
mcfg
)

134 ià(!
	`¡rcmp
(
mcfg
->
h—d”
.
Ûm_id
, "SGI"))

135 
aıi_mcfg_64b™_ba£_addr
 = 
TRUE
;

138 
	}
}

140 
__š™
 
	$aıi_·r£_mcfg
(
aıi_bË_h—d”
 *
h—d”
)

142 
aıi_bË_mcfg
 *
mcfg
;

143 
i
;

144 
cÚfig_size
;

146 ià(!
h—d”
)

147  -
EINVAL
;

149 
mcfg
 = (
aıi_bË_mcfg
 *)
h—d”
;

152 
pci_mmcfg_cÚfig_num
 = 0;

153 
i
 = 
h—d”
->
Ëngth
 - (
aıi_bË_mcfg
);

154 
i
 >ğ(
aıi_mcfg_®loÿtiÚ
)) {

155 ++
pci_mmcfg_cÚfig_num
;

156 
i
 -ğ(
aıi_mcfg_®loÿtiÚ
);

158 ià(
pci_mmcfg_cÚfig_num
 == 0) {

159 
	`´štk
(
KERN_ERR
 
PREFIX
 "MMCONFIG has‚oƒntries\n");

160  -
ENODEV
;

163 
cÚfig_size
 = 
pci_mmcfg_cÚfig_num
 * (*
pci_mmcfg_cÚfig
);

164 
pci_mmcfg_cÚfig
 = 
	`km®loc
(
cÚfig_size
, 
GFP_KERNEL
);

165 ià(!
pci_mmcfg_cÚfig
) {

166 
	`´štk
(
KERN_WARNING
 
PREFIX


168  -
ENOMEM
;

171 
	`memıy
(
pci_mmcfg_cÚfig
, &
mcfg
[1], 
cÚfig_size
);

173 
	`aıi_mcfg_Ûm_check
(
mcfg
);

175 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

176 ià((
pci_mmcfg_cÚfig
[
i
].
add»ss
 > 0xFFFFFFFF) &&

177 !
aıi_mcfg_64b™_ba£_addr
) {

178 
	`´štk
(
KERN_ERR
 
PREFIX


180 
	`kä“
(
pci_mmcfg_cÚfig
);

181 
pci_mmcfg_cÚfig_num
 = 0;

182  -
ENODEV
;

187 
	}
}

190 #ifdeà
CONFIG_X86_LOCAL_APIC


191 
__š™
 
	$aıi_·r£_madt
(
aıi_bË_h—d”
 *
bË
)

193 
aıi_bË_madt
 *
madt
 = 
NULL
;

195 ià(!
ıu_has_­ic
)

196  -
EINVAL
;

198 
madt
 = (
aıi_bË_madt
 *)
bË
;

199 ià(!
madt
) {

200 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map MADT\n");

201  -
ENODEV
;

204 ià(
madt
->
add»ss
) {

205 
aıi_Ïpic_addr
 = (
u64
è
madt
->
add»ss
;

207 
	`´štk
(
KERN_DEBUG
 
PREFIX
 "Local APIC‡ddress 0x%08x\n",

208 
madt
->
add»ss
);

211 
	`deçuÉ_aıi_madt_Ûm_check
(
madt
->
h—d”
.
Ûm_id
,

212 
madt
->
h—d”
.
Ûm_bË_id
);

215 
	}
}

217 
__ıuš™
 
	$aıi_»gi¡”_Ïpic
(
id
, 
u8
 
’abËd
)

219 
v”
 = 0;

221 ià(!
’abËd
) {

222 ++
di§bËd_ıus
;

226 ià(
boÙ_ıu_physiÿl_­icid
 != -1U)

227 
v”
 = 
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
];

229 
	`g’”ic_´oûssÜ_šfo
(
id
, 
v”
);

230 
	}
}

232 
__š™


233 
	$aıi_·r£_x2­ic
(
aıi_subbË_h—d”
 *
h—d”
, cÚ¡ 
’d
)

235 
aıi_madt_loÿl_x2­ic
 *
´oûssÜ
 = 
NULL
;

237 
´oûssÜ
 = (
aıi_madt_loÿl_x2­ic
 *)
h—d”
;

239 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

240  -
EINVAL
;

242 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

244 #ifdeà
CONFIG_X86_X2APIC


252 
	`aıi_»gi¡”_Ïpic
(
´oûssÜ
->
loÿl_­ic_id
,

253 
´oûssÜ
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

255 
	`´štk
(
KERN_WARNING
 
PREFIX
 "x2apicƒntry ignored\n");

259 
	}
}

261 
__š™


262 
	$aıi_·r£_Ïpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

264 
aıi_madt_loÿl_­ic
 *
´oûssÜ
 = 
NULL
;

266 
´oûssÜ
 = (
aıi_madt_loÿl_­ic
 *)
h—d”
;

268 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

269  -
EINVAL
;

271 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

280 
	`aıi_»gi¡”_Ïpic
(
´oûssÜ
->
id
,

281 
´oûssÜ
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

284 
	}
}

286 
__š™


287 
	$aıi_·r£_§pic
(
aıi_subbË_h—d”
 *
h—d”
, cÚ¡ 
’d
)

289 
aıi_madt_loÿl_§pic
 *
´oûssÜ
 = 
NULL
;

291 
´oûssÜ
 = (
aıi_madt_loÿl_§pic
 *)
h—d”
;

293 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

294  -
EINVAL
;

296 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

298 
	`aıi_»gi¡”_Ïpic
((
´oûssÜ
->
id
 << 8è|…roûssÜ->
eid
,

299 
´oûssÜ
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

302 
	}
}

304 
__š™


305 
	$aıi_·r£_Ïpic_addr_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

306 cÚ¡ 
’d
)

308 
aıi_madt_loÿl_­ic_ov”ride
 *
Ïpic_addr_ovr
 = 
NULL
;

310 
Ïpic_addr_ovr
 = (
aıi_madt_loÿl_­ic_ov”ride
 *)
h—d”
;

312 ià(
	`BAD_MADT_ENTRY
(
Ïpic_addr_ovr
, 
’d
))

313  -
EINVAL
;

315 
aıi_Ïpic_addr
 = 
Ïpic_addr_ovr
->
add»ss
;

318 
	}
}

320 
__š™


321 
	$aıi_·r£_x2­ic_nmi
(
aıi_subbË_h—d”
 *
h—d”
,

322 cÚ¡ 
’d
)

324 
aıi_madt_loÿl_x2­ic_nmi
 *
x2­ic_nmi
 = 
NULL
;

326 
x2­ic_nmi
 = (
aıi_madt_loÿl_x2­ic_nmi
 *)
h—d”
;

328 ià(
	`BAD_MADT_ENTRY
(
x2­ic_nmi
, 
’d
))

329  -
EINVAL
;

331 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

333 ià(
x2­ic_nmi
->
lšt
 != 1)

334 
	`´štk
(
KERN_WARNING
 
PREFIX
 "NMI‚ot connectedo LINT 1!\n");

337 
	}
}

339 
__š™


340 
	$aıi_·r£_Ïpic_nmi
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

342 
aıi_madt_loÿl_­ic_nmi
 *
Ïpic_nmi
 = 
NULL
;

344 
Ïpic_nmi
 = (
aıi_madt_loÿl_­ic_nmi
 *)
h—d”
;

346 ià(
	`BAD_MADT_ENTRY
(
Ïpic_nmi
, 
’d
))

347  -
EINVAL
;

349 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

351 ià(
Ïpic_nmi
->
lšt
 != 1)

352 
	`´štk
(
KERN_WARNING
 
PREFIX
 "NMI‚ot connectedo LINT 1!\n");

355 
	}
}

359 #ifdeà
CONFIG_X86_IO_APIC


361 
__š™


362 
	$aıi_·r£_ißpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

364 
aıi_madt_io_­ic
 *
ißpic
 = 
NULL
;

366 
ißpic
 = (
aıi_madt_io_­ic
 *)
h—d”
;

368 ià(
	`BAD_MADT_ENTRY
(
ißpic
, 
’d
))

369  -
EINVAL
;

371 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

373 
	`mp_»gi¡”_ißpic
(
ißpic
->
id
,

374 
ißpic
->
add»ss
, ißpic->
glob®_œq_ba£
);

377 
	}
}

382 
__š™
 
	$aıi_sci_ißpic_£tup
(
u32
 
gsi
, 
u16
 
pŞ¬™y
, u16 
Œigg”
)

384 ià(
Œigg”
 == 0)

385 
Œigg”
 = 3;

387 ià(
pŞ¬™y
 == 0)

388 
pŞ¬™y
 = 3;

391 ià(
aıi_sci_æags
 & 
ACPI_MADT_TRIGGER_MASK
)

392 
Œigg”
 = (
aıi_sci_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

394 ià(
aıi_sci_æags
 & 
ACPI_MADT_POLARITY_MASK
)

395 
pŞ¬™y
 = 
aıi_sci_æags
 & 
ACPI_MADT_POLARITY_MASK
;

402 
	`mp_ov”ride_Ëgacy_œq
(
gsi
, 
pŞ¬™y
, 
Œigg”
, gsi);

408 
aıi_sci_ov”ride_gsi
 = 
gsi
;

410 
	}
}

412 
__š™


413 
	$aıi_·r£_št_¤c_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

414 cÚ¡ 
’d
)

416 
aıi_madt_š‹¼u±_ov”ride
 *
št¤c
 = 
NULL
;

418 
št¤c
 = (
aıi_madt_š‹¼u±_ov”ride
 *)
h—d”
;

420 ià(
	`BAD_MADT_ENTRY
(
št¤c
, 
’d
))

421  -
EINVAL
;

423 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

425 ià(
št¤c
->
sourû_œq
 =ğ
aıi_gbl_FADT
.
sci_š‹¼u±
) {

426 
	`aıi_sci_ißpic_£tup
(
št¤c
->
glob®_œq
,

427 
št¤c
->
šti_æags
 & 
ACPI_MADT_POLARITY_MASK
,

428 (
št¤c
->
šti_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

432 ià(
aıi_sk_tim”_ov”ride
 &&

433 
št¤c
->
sourû_œq
 =ğ0 && iÁ¤c->
glob®_œq
 == 2) {

434 
	`´štk
(
PREFIX
 "BIOS IRQ0…in2 override ignored.\n");

438 
	`mp_ov”ride_Ëgacy_œq
(
št¤c
->
sourû_œq
,

439 
št¤c
->
šti_æags
 & 
ACPI_MADT_POLARITY_MASK
,

440 (
št¤c
->
šti_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

441 
št¤c
->
glob®_œq
);

444 
	}
}

446 
__š™


447 
	$aıi_·r£_nmi_¤c
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

449 
aıi_madt_nmi_sourû
 *
nmi_¤c
 = 
NULL
;

451 
nmi_¤c
 = (
aıi_madt_nmi_sourû
 *)
h—d”
;

453 ià(
	`BAD_MADT_ENTRY
(
nmi_¤c
, 
’d
))

454  -
EINVAL
;

456 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

461 
	}
}

479 
__š™
 
	$aıi_pic_sci_£t_Œigg”
(
œq
, 
u16
 
Œigg”
)

481 
mask
 = 1 << 
œq
;

482 
Şd
, 
Ãw
;

485 
Şd
 = 
	`šb
(0x4d0) | (inb(0x4d1) << 8);

492 
Ãw
 = 
aıi_noœq
 ? 
Şd
 : 0;

498 
Œigg”
) {

500 
Ãw
 &ğ~
mask
;

503 
Ãw
 |ğ
mask
;

507 ià(
Şd
 =ğ
Ãw
)

510 
	`´štk
(
PREFIX
 "£‰šg ELCRØ%04x (äom %04x)\n", 
Ãw
, 
Şd
);

511 
	`outb
(
Ãw
, 0x4d0);

512 
	`outb
(
Ãw
 >> 8, 0x4d1);

513 
	}
}

515 
	$aıi_gsi_to_œq
(
u32
 
gsi
, *
œq
)

517 *
œq
 = 
gsi
;

519 
	}
}

525 
	$aıi_»gi¡”_gsi
(
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

527 
œq
;

528 
¶©_gsi
 = 
gsi
;

530 #ifdeà
CONFIG_PCI


534 ià(
aıi_œq_mod–
 =ğ
ACPI_IRQ_MODEL_PIC
) {

535 ià(
Œigg”šg
 =ğ
ACPI_LEVEL_SENSITIVE
)

536 
	`ei§_£t_Ëv–_œq
(
gsi
);

540 #ifdeà
CONFIG_X86_IO_APIC


541 ià(
aıi_œq_mod–
 =ğ
ACPI_IRQ_MODEL_IOAPIC
) {

542 
¶©_gsi
 = 
	`mp_»gi¡”_gsi
(
gsi
, 
Œigg”šg
, 
pŞ¬™y
);

545 
	`aıi_gsi_to_œq
(
¶©_gsi
, &
œq
);

546  
œq
;

547 
	}
}

552 #ifdeà
CONFIG_ACPI_HOTPLUG_CPU


554 
__ıuš™
 
	$_aıi_m­_l§pic
(
aıi_hªdË
 
hªdË
, *
pıu
)

556 
aıi_bufãr
 
bufãr
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

557 
aıi_objeù
 *
obj
;

558 
aıi_madt_loÿl_­ic
 *
Ïpic
;

559 
ıumask_v¬_t
 
tmp_m­
, 
Ãw_m­
;

560 
u8
 
physid
;

561 
ıu
;

562 
»tv®
 = -
ENOMEM
;

564 ià(
	`ACPI_FAILURE
(
	`aıi_ev®u©e_objeù
(
hªdË
, "_MAT", 
NULL
, &
bufãr
)))

565  -
EINVAL
;

567 ià(!
bufãr
.
Ëngth
 || !bufãr.
poš‹r
)

568  -
EINVAL
;

570 
obj
 = 
bufãr
.
poš‹r
;

571 ià(
obj
->
ty³
 !ğ
ACPI_TYPE_BUFFER
 ||

572 
obj
->
bufãr
.
Ëngth
 < (*
Ïpic
)) {

573 
	`kä“
(
bufãr
.
poš‹r
);

574  -
EINVAL
;

577 
Ïpic
 = (
aıi_madt_loÿl_­ic
 *)
obj
->
bufãr
.
poš‹r
;

579 ià(
Ïpic
->
h—d”
.
ty³
 !ğ
ACPI_MADT_TYPE_LOCAL_APIC
 ||

580 !(
Ïpic
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
)) {

581 
	`kä“
(
bufãr
.
poš‹r
);

582  -
EINVAL
;

585 
physid
 = 
Ïpic
->
id
;

587 
	`kä“
(
bufãr
.
poš‹r
);

588 
bufãr
.
Ëngth
 = 
ACPI_ALLOCATE_BUFFER
;

589 
bufãr
.
poš‹r
 = 
NULL
;

591 ià(!
	`®loc_ıumask_v¬
(&
tmp_m­
, 
GFP_KERNEL
))

592 
out
;

594 ià(!
	`®loc_ıumask_v¬
(&
Ãw_m­
, 
GFP_KERNEL
))

595 
ä“_tmp_m­
;

597 
	`ıumask_cİy
(
tmp_m­
, 
ıu_´e£Á_mask
);

598 
	`aıi_»gi¡”_Ïpic
(
physid
, 
Ïpic
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

604 
	`ıumask_ªdnÙ
(
Ãw_m­
, 
ıu_´e£Á_mask
, 
tmp_m­
);

605 ià(
	`ıumask_em±y
(
Ãw_m­
)) {

606 
	`´štk
 ("Unableo map†apico†ogical cpu‚umber\n");

607 
»tv®
 = -
EINVAL
;

608 
ä“_Ãw_m­
;

611 
ıu
 = 
	`ıumask_fœ¡
(
Ãw_m­
);

613 *
pıu
 = 
ıu
;

614 
»tv®
 = 0;

616 
ä“_Ãw_m­
:

617 
	`ä“_ıumask_v¬
(
Ãw_m­
);

618 
ä“_tmp_m­
:

619 
	`ä“_ıumask_v¬
(
tmp_m­
);

620 
out
:

621  
»tv®
;

622 
	}
}

625 
__»f
 
	$aıi_m­_l§pic
(
aıi_hªdË
 
hªdË
, *
pıu
)

627  
	`_aıi_m­_l§pic
(
hªdË
, 
pıu
);

628 
	}
}

629 
EXPORT_SYMBOL
(
aıi_m­_l§pic
);

631 
	$aıi_unm­_l§pic
(
ıu
)

633 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
) = -1;

634 
	`£t_ıu_´e£Á
(
ıu
, 
çl£
);

635 
num_´oûssÜs
--;

638 
	}
}

640 
EXPORT_SYMBOL
(
aıi_unm­_l§pic
);

643 
	$aıi_»gi¡”_ißpic
(
aıi_hªdË
 
hªdË
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

646  -
EINVAL
;

647 
	}
}

649 
EXPORT_SYMBOL
(
aıi_»gi¡”_ißpic
);

651 
	$aıi_uÄegi¡”_ißpic
(
aıi_hªdË
 
hªdË
, 
u32
 
gsi_ba£
)

654  -
EINVAL
;

655 
	}
}

657 
EXPORT_SYMBOL
(
aıi_uÄegi¡”_ißpic
);

659 
__š™
 
	$aıi_·r£_sbf
(
aıi_bË_h—d”
 *
bË
)

661 
aıi_bË_boÙ
 *
sb
;

663 
sb
 = (
aıi_bË_boÙ
 *)
bË
;

664 ià(!
sb
) {

665 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map SBF\n");

666  -
ENODEV
;

669 
sbf_pÜt
 = 
sb
->
cmos_šdex
;

672 
	}
}

674 #ifdeà
CONFIG_HPET_TIMER


675 
	~<asm/h³t.h
>

677 
__š™d©a
 
»sourû
 *
	gh³t_»s
;

679 
__š™
 
	$aıi_·r£_h³t
(
aıi_bË_h—d”
 *
bË
)

681 
aıi_bË_h³t
 *
h³t_tbl
;

683 
h³t_tbl
 = (
aıi_bË_h³t
 *)
bË
;

684 ià(!
h³t_tbl
) {

685 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map HPET\n");

686  -
ENODEV
;

689 ià(
h³t_tbl
->
add»ss
.
¥aû_id
 !ğ
ACPI_SPACE_MEM
) {

690 
	`´štk
(
KERN_WARNING
 
PREFIX
 "HPETimers must be†ocated in "

695 
h³t_add»ss
 = 
h³t_tbl
->
add»ss
.address;

701 ià(!
h³t_add»ss
) {

702 
	`´štk
(
KERN_WARNING
 
PREFIX


704 
h³t_tbl
->
id
, 
h³t_add»ss
);

707 #ifdeà
CONFIG_X86_64


713 ià(
h³t_add»ss
 == 0xfed0000000000000UL) {

714 ià(!
h³t_fÜû_u£r
) {

715 
	`´štk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

718 "fix iˆu°tØ0xãd00000.\n", 
h³t_tbl
->
id
);

719 
h³t_add»ss
 = 0;

722 
	`´štk
(
KERN_WARNING
 
PREFIX


724 "tØ0xãd00000.\n", 
h³t_tbl
->
id
);

725 
h³t_add»ss
 >>= 32;

728 
	`´štk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

729 
h³t_tbl
->
id
, 
h³t_add»ss
);

735 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

736 
h³t_»s
 = 
	`®loc_boÙmem
((*h³t_»sè+ 
HPET_RESOURCE_NAME_SIZE
);

738 
h³t_»s
->
Çme
 = (*)&hpet_res[1];

739 
h³t_»s
->
æags
 = 
IORESOURCE_MEM
;

740 
	`¢´štf
((*)
h³t_»s
->
Çme
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

741 
h³t_tbl
->
£qu’û
);

743 
h³t_»s
->
¡¬t
 = 
h³t_add»ss
;

744 
h³t_»s
->
’d
 = 
h³t_add»ss
 + (1 * 1024) - 1;

747 
	}
}

753 
__š™
 
	$h³t_š£¹_»sourû
()

755 ià(!
h³t_»s
)

758  
	`š£¹_»sourû
(&
iomem_»sourû
, 
h³t_»s
);

759 
	}
}

761 
Ï‹_š™ÿÎ
(
h³t_š£¹_»sourû
);

764 
	#aıi_·r£_h³t
 
NULL


	)

767 
__š™
 
	$aıi_·r£_çdt
(
aıi_bË_h—d”
 *
bË
)

770 #ifdeà
CONFIG_X86_PM_TIMER


772 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
) {

774 ià(
aıi_gbl_FADT
.
xpm_tim”_block
.
¥aû_id
 !=

775 
ACPI_ADR_SPACE_SYSTEM_IO
)

778 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
xpm_tim”_block
.
add»ss
;

784 ià(!
pmtmr_iİÜt
)

785 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
pm_tim”_block
;

788 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
pm_tim”_block
;

790 ià(
pmtmr_iİÜt
)

791 
	`´štk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

792 
pmtmr_iİÜt
);

795 
	}
}

797 #ifdef 
CONFIG_X86_LOCAL_APIC


803 
__š™
 
	$aıi_»gi¡”_Ïpic_add»ss
(
add»ss
)

805 
mp_Ïpic_addr
 = 
add»ss
;

807 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
add»ss
);

808 ià(
boÙ_ıu_physiÿl_­icid
 == -1U) {

809 
boÙ_ıu_physiÿl_­icid
 = 
	`»ad_­ic_id
();

810 
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
] =

811 
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

813 
	}
}

815 
__š™
 
	$—¾y_aıi_·r£_madt_Ïpic_addr_ovr
()

817 
couÁ
;

819 ià(!
ıu_has_­ic
)

820  -
ENODEV
;

827 
couÁ
 =

828 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

829 
aıi_·r£_Ïpic_addr_ovr
, 0);

830 ià(
couÁ
 < 0) {

831 
	`´štk
(
KERN_ERR
 
PREFIX


833  
couÁ
;

836 
	`aıi_»gi¡”_Ïpic_add»ss
(
aıi_Ïpic_addr
);

838  
couÁ
;

839 
	}
}

841 
__š™
 
	$aıi_·r£_madt_Ïpic_’Œ›s
()

843 
couÁ
;

844 
x2couÁ
 = 0;

846 ià(!
ıu_has_­ic
)

847  -
ENODEV
;

854 
couÁ
 =

855 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

856 
aıi_·r£_Ïpic_addr_ovr
, 0);

857 ià(
couÁ
 < 0) {

858 
	`´štk
(
KERN_ERR
 
PREFIX


860  
couÁ
;

863 
	`aıi_»gi¡”_Ïpic_add»ss
(
aıi_Ïpic_addr
);

865 
couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

866 
aıi_·r£_§pic
, 
MAX_APICS
);

868 ià(!
couÁ
) {

869 
x2couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

870 
aıi_·r£_x2­ic
, 
MAX_APICS
);

871 
couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

872 
aıi_·r£_Ïpic
, 
MAX_APICS
);

874 ià(!
couÁ
 && !
x2couÁ
) {

875 
	`´štk
(
KERN_ERR
 
PREFIX
 "No LAPICƒntries…resent\n");

877  -
ENODEV
;

878 } ià(
couÁ
 < 0 || 
x2couÁ
 < 0) {

879 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPICƒntry\n");

881  
couÁ
;

884 
x2couÁ
 =

885 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

886 
aıi_·r£_x2­ic_nmi
, 0);

887 
couÁ
 =

888 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
aıi_·r£_Ïpic_nmi
, 0);

889 ià(
couÁ
 < 0 || 
x2couÁ
 < 0) {

890 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPIC NMIƒntry\n");

892  
couÁ
;

895 
	}
}

898 #ifdef 
CONFIG_X86_IO_APIC


899 
	#MP_ISA_BUS
 0

	)

901 #ifdeà
CONFIG_X86_ES7000


902 
es7000_¶©
;

906 
	m­ic_id
;

907 
	mgsi_ba£
;

908 
	mgsi_’d
;

909 
DECLARE_BITMAP
(
pš_´og¿mmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

910 } 
	gmp_ißpic_routšg
[
MAX_IO_APICS
];

912 
	$mp_fšd_ißpic
(
gsi
)

914 
i
 = 0;

917 
i
 = 0; i < 
Ä_ißpics
; i++) {

918 ià((
gsi
 >ğ
mp_ißpic_routšg
[
i
].
gsi_ba£
)

919 && (
gsi
 <ğ
mp_ißpic_routšg
[
i
].
gsi_’d
))

920  
i
;

923 
	`´štk
(
KERN_ERR
 "ERROR: UÇbËØloÿ‹ IOAPIC fÜ GSI %d\n", 
gsi
);

925 
	}
}

927 
	$mp_fšd_ißpic_pš
(
ißpic
, 
gsi
)

929 ià(
	`WARN_ON
(
ißpic
 == -1))

931 ià(
	`WARN_ON
(
gsi
 > 
mp_ißpic_routšg
[
ißpic
].
gsi_’d
))

934  
gsi
 - 
mp_ißpic_routšg
[
ißpic
].
gsi_ba£
;

935 
	}
}

937 
u8
 
__š™
 
	$uniq_ißpic_id
(
u8
 
id
)

939 #ifdeà
CONFIG_X86_32


940 ià((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) &&

941 !
	`APIC_XAPIC
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
]))

942  
	`io_­ic_g‘_unique_id
(
Ä_ißpics
, 
id
);

944  
id
;

946 
i
;

947 
	`DECLARE_BITMAP
(
u£d
, 256);

948 
	`b™m­_z”o
(
u£d
, 256);

949 
i
 = 0; i < 
Ä_ißpics
; i++) {

950 
mpc_ißpic
 *
Ÿ
 = &
mp_ißpics
[
i
];

951 
	`__£t_b™
(
Ÿ
->
­icid
, 
u£d
);

953 ià(!
	`‹¡_b™
(
id
, 
u£d
))

954  
id
;

955  
	`fšd_fœ¡_z”o_b™
(
u£d
, 256);

957 
	}
}

959 
	$bad_ißpic
(
add»ss
)

961 ià(
Ä_ißpics
 >ğ
MAX_IO_APICS
) {

962 
	`´štk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)ƒxceeded "

963 "(found %d)\n", 
MAX_IO_APICS
, 
Ä_ißpics
);

964 
	`·nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

966 ià(!
add»ss
) {

967 
	`´štk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APIC‡ddress"

972 
	}
}

974 
__š™
 
	$mp_»gi¡”_ißpic
(
id
, 
u32
 
add»ss
, u32 
gsi_ba£
)

976 
idx
 = 0;

978 ià(
	`bad_ißpic
(
add»ss
))

981 
idx
 = 
Ä_ißpics
;

983 
mp_ißpics
[
idx
].
ty³
 = 
MP_IOAPIC
;

984 
mp_ißpics
[
idx
].
æags
 = 
MPC_APIC_USABLE
;

985 
mp_ißpics
[
idx
].
­iÿddr
 = 
add»ss
;

987 
	`£t_fixm­_noÿche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
add»ss
);

988 
mp_ißpics
[
idx
].
­icid
 = 
	`uniq_ißpic_id
(
id
);

989 #ifdeà
CONFIG_X86_32


990 
mp_ißpics
[
idx
].
­icv”
 = 
	`io_­ic_g‘_v”siÚ
(idx);

992 
mp_ißpics
[
idx
].
­icv”
 = 0;

998 
mp_ißpic_routšg
[
idx
].
­ic_id
 = 
mp_ißpics
[idx].
­icid
;

999 
mp_ißpic_routšg
[
idx
].
gsi_ba£
 = gsi_base;

1000 
mp_ißpic_routšg
[
idx
].
gsi_’d
 = 
gsi_ba£
 +

1001 
	`io_­ic_g‘_»dœ_’Œ›s
(
idx
);

1003 
	`´štk
(
KERN_INFO
 "IOAPIC[%d]:‡pic_id %d, version %d,‡ddress 0x%x, "

1004 "GSI %d-%d\n", 
idx
, 
mp_ißpics
[idx].
­icid
,

1005 
mp_ißpics
[
idx
].
­icv”
, mp_ißpics[idx].
­iÿddr
,

1006 
mp_ißpic_routšg
[
idx
].
gsi_ba£
, mp_ißpic_routšg[idx].
gsi_’d
);

1008 
Ä_ißpics
++;

1009 
	}
}

1011 
__š™
 
	$aıi_´obe_gsi
()

1013 
idx
;

1014 
gsi
;

1015 
max_gsi
 = 0;

1017 ià(
aıi_di§bËd
)

1020 ià(!
aıi_ißpic
)

1023 
max_gsi
 = 0;

1024 
idx
 = 0; idx < 
Ä_ißpics
; idx++) {

1025 
gsi
 = 
mp_ißpic_routšg
[
idx
].
gsi_’d
;

1027 ià(
gsi
 > 
max_gsi
)

1028 
max_gsi
 = 
gsi
;

1031  
max_gsi
 + 1;

1032 
	}
}

1034 
	$assign_to_mp_œq
(
mpc_št¤c
 *
m
,

1035 
mpc_št¤c
 *
mp_œq
)

1037 
	`memıy
(
mp_œq
, 
m
, (
mpc_št¤c
));

1038 
	}
}

1040 
	$mp_œq_cmp
(
mpc_št¤c
 *
mp_œq
,

1041 
mpc_št¤c
 *
m
)

1043  
	`memcmp
(
mp_œq
, 
m
, (
mpc_št¤c
));

1044 
	}
}

1046 
	$§ve_mp_œq
(
mpc_št¤c
 *
m
)

1048 
i
;

1050 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

1051 ià(!
	`mp_œq_cmp
(&
mp_œqs
[
i
], 
m
))

1055 
	`assign_to_mp_œq
(
m
, &
mp_œqs
[
mp_œq_’Œ›s
]);

1056 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

1057 
	`·nic
("Max # of irq sourcesƒxceeded!!\n");

1058 
	}
}

1060 
__š™
 
	$mp_ov”ride_Ëgacy_œq
(
u8
 
bus_œq
, u8 
pŞ¬™y
, u8 
Œigg”
, 
u32
 
gsi
)

1062 
ißpic
;

1063 
pš
;

1064 
mpc_št¤c
 
mp_œq
;

1069 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

1070 ià(
ißpic
 < 0)

1072 
pš
 = 
	`mp_fšd_ißpic_pš
(
ißpic
, 
gsi
);

1079 ià((
bus_œq
 =ğ0è&& (
Œigg”
 == 3))

1080 
Œigg”
 = 1;

1082 
mp_œq
.
ty³
 = 
MP_INTSRC
;

1083 
mp_œq
.
œqty³
 = 
mp_INT
;

1084 
mp_œq
.
œqæag
 = (
Œigg”
 << 2è| 
pŞ¬™y
;

1085 
mp_œq
.
¤cbus
 = 
MP_ISA_BUS
;

1086 
mp_œq
.
¤cbusœq
 = 
bus_œq
;

1087 
mp_œq
.
d¡­ic
 = 
mp_ißpics
[
ißpic
].
­icid
;

1088 
mp_œq
.
d¡œq
 = 
pš
;

1090 
	`§ve_mp_œq
(&
mp_œq
);

1091 
	}
}

1093 
__š™
 
	$mp_cÚfig_aıi_Ëgacy_œqs
()

1095 
i
;

1096 
ißpic
;

1097 
d¡­ic
;

1098 
mpc_št¤c
 
mp_œq
;

1100 #ià
	`defšed
 (
CONFIG_MCA
è|| defšed (
CONFIG_EISA
)

1104 
mp_bus_id_to_ty³
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

1106 
	`£t_b™
(
MP_ISA_BUS
, 
mp_bus_nÙ_pci
);

1107 
	`´_debug
("Bu #%d i ISA\n", 
MP_ISA_BUS
);

1109 #ifdeà
CONFIG_X86_ES7000


1113 ià(
es7000_¶©
 == 1)

1120 
ißpic
 = 
	`mp_fšd_ißpic
(0);

1121 ià(
ißpic
 < 0)

1123 
d¡­ic
 = 
mp_ißpics
[
ißpic
].
­icid
;

1129 
i
 = 0; i < 16; i++) {

1130 
idx
;

1132 
idx
 = 0; idx < 
mp_œq_’Œ›s
; idx++) {

1133 
mpc_št¤c
 *
œq
 = 
mp_œqs
 + 
idx
;

1136 ià(
œq
->
¤cbus
 =ğ
MP_ISA_BUS
 && irq->
¤cbusœq
 =ğ
i
)

1140 ià(
œq
->
d¡­ic
 =ğd¡­iø&& irq->
d¡œq
 =ğ
i
)

1144 ià(
idx
 !ğ
mp_œq_’Œ›s
) {

1145 
	`´štk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ov”ride.\n", 
i
);

1149 
mp_œq
.
ty³
 = 
MP_INTSRC
;

1150 
mp_œq
.
œqæag
 = 0;

1151 
mp_œq
.
¤cbus
 = 
MP_ISA_BUS
;

1152 
mp_œq
.
d¡­ic
 = dstapic;

1153 
mp_œq
.
œqty³
 = 
mp_INT
;

1154 
mp_œq
.
¤cbusœq
 = 
i
;

1155 
mp_œq
.
d¡œq
 = 
i
;

1157 
	`§ve_mp_œq
(&
mp_œq
);

1159 
	}
}

1161 
	$mp_»gi¡”_gsi
(
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

1163 
ißpic
;

1164 
ißpic_pš
;

1165 #ifdeà
CONFIG_X86_32


1166 
	#MAX_GSI_NUM
 4096

	)

1167 
	#IRQ_COMPRESSION_START
 64

	)

1169 
pci_œq
 = 
IRQ_COMPRESSION_START
;

1175 
gsi_to_œq
[
MAX_GSI_NUM
];

1178 ià(
aıi_œq_mod–
 !ğ
ACPI_IRQ_MODEL_IOAPIC
)

1179  
gsi
;

1183 ià(
aıi_gbl_FADT
.
sci_š‹¼u±
 =ğ
gsi
)

1184  
gsi
;

1186 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

1187 ià(
ißpic
 < 0) {

1188 
	`´štk
(
KERN_WARNING
 "NØIOAPIC fÜ GSI %u\n", 
gsi
);

1189  
gsi
;

1192 
ißpic_pš
 = 
	`mp_fšd_ißpic_pš
(
ißpic
, 
gsi
);

1194 #ifdeà
CONFIG_X86_32


1195 ià(
ißpic_»numb”_œq
)

1196 
gsi
 = 
	`ißpic_»numb”_œq
(
ißpic
, gsi);

1204 ià(
ißpic_pš
 > 
MP_MAX_IOAPIC_PIN
) {

1205 
	`´štk
(
KERN_ERR
 "Invalid„eferenceo IOAPIC…in "

1206 "%d-%d\n", 
mp_ißpic_routšg
[
ißpic
].
­ic_id
,

1207 
ißpic_pš
);

1208  
gsi
;

1210 ià(
	`‹¡_b™
(
ißpic_pš
, 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
)) {

1211 
	`´_debug
("Pin %d-%d‡lready…rogrammed\n",

1212 
mp_ißpic_routšg
[
ißpic
].
­ic_id
, 
ißpic_pš
);

1213 #ifdeà
CONFIG_X86_32


1214  (
gsi
 < 
IRQ_COMPRESSION_START
 ? gs˜: 
gsi_to_œq
[gsi]);

1216  
gsi
;

1220 
	`£t_b™
(
ißpic_pš
, 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
);

1221 #ifdeà
CONFIG_X86_32


1225 ià((
gsi
 >ğ
IRQ_COMPRESSION_START
)

1226 && (
Œigg”šg
 =ğ
ACPI_LEVEL_SENSITIVE
)) {

1231 
œq
 = 
gsi
;

1232 ià(
gsi
 < 
MAX_GSI_NUM
) {

1243 
gsi
 = 
pci_œq
++;

1247 ià(
gsi
 =ğ
aıi_gbl_FADT
.
sci_š‹¼u±
)

1248 
gsi
 = 
pci_œq
++;

1249 
gsi_to_œq
[
œq
] = 
gsi
;

1251 
	`´štk
(
KERN_ERR
 "GSI %u i toØhigh\n", 
gsi
);

1252  
gsi
;

1256 
	`io_­ic_£t_pci_routšg
(
ißpic
, 
ißpic_pš
, 
gsi
,

1257 
Œigg”šg
 =ğ
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1258 
pŞ¬™y
 =ğ
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1259  
gsi
;

1260 
	}
}

1262 
	$mp_cÚfig_aıi_gsi
(
numb”
, 
devâ
, 
u8
 
pš
,

1263 
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

1265 #ifdeà
CONFIG_X86_MPPARSE


1266 
mpc_št¤c
 
mp_œq
;

1267 
ißpic
;

1269 ià(!
aıi_ißpic
)

1273 
mp_œq
.
ty³
 = 
MP_INTSRC
;

1274 
mp_œq
.
œqty³
 = 
mp_INT
;

1275 
mp_œq
.
œqæag
 = (
Œigg”šg
 =ğ
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1276 (
pŞ¬™y
 =ğ
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1277 
mp_œq
.
¤cbus
 = 
numb”
;

1278 
mp_œq
.
¤cbusœq
 = (((
devâ
 >> 3è& 0x1fè<< 2è| ((
pš
 - 1) & 3);

1279 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

1280 
mp_œq
.
d¡­ic
 = 
mp_ißpic_routšg
[
ißpic
].
­ic_id
;

1281 
mp_œq
.
d¡œq
 = 
	`mp_fšd_ißpic_pš
(
ißpic
, 
gsi
);

1283 
	`§ve_mp_œq
(&
mp_œq
);

1286 
	}
}

1292 
__š™
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

1294 
couÁ
;

1302 ià(
aıi_di§bËd
 || 
aıi_noœq
) {

1303  -
ENODEV
;

1306 ià(!
ıu_has_­ic
)

1307  -
ENODEV
;

1312 ià(
sk_ißpic_£tup
) {

1313 
	`´štk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPIC…robe "

1315  -
ENODEV
;

1318 
couÁ
 =

1319 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
aıi_·r£_ißpic
,

1320 
MAX_IO_APICS
);

1321 ià(!
couÁ
) {

1322 
	`´štk
(
KERN_ERR
 
PREFIX
 "No IOAPICƒntries…resent\n");

1323  -
ENODEV
;

1324 } ià(
couÁ
 < 0) {

1325 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing IOAPICƒntry\n");

1326  
couÁ
;

1329 
couÁ
 =

1330 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
aıi_·r£_št_¤c_ovr
,

1331 
Ä_œqs
);

1332 ià(
couÁ
 < 0) {

1333 
	`´štk
(
KERN_ERR
 
PREFIX


1336  
couÁ
;

1343 ià(!
aıi_sci_ov”ride_gsi
)

1344 
	`aıi_sci_ißpic_£tup
(
aıi_gbl_FADT
.
sci_š‹¼u±
, 0, 0);

1347 
	`mp_cÚfig_aıi_Ëgacy_œqs
();

1349 
couÁ
 =

1350 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
aıi_·r£_nmi_¤c
,

1351 
Ä_œqs
);

1352 ià(
couÁ
 < 0) {

1353 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing NMI SRCƒntry\n");

1355  
couÁ
;

1359 
	}
}

1361 
šlše
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

1364 
	}
}

1367 
__š™
 
	$—¾y_aıi_´oûss_madt
()

1369 #ifdeà
CONFIG_X86_LOCAL_APIC


1370 
”rÜ
;

1372 ià(!
	`aıi_bË_·r£
(
ACPI_SIG_MADT
, 
aıi_·r£_madt
)) {

1377 
”rÜ
 = 
	`—¾y_aıi_·r£_madt_Ïpic_addr_ovr
();

1378 ià(!
”rÜ
) {

1379 
aıi_Ïpic
 = 1;

1380 
smp_found_cÚfig
 = 1;

1382 ià(
”rÜ
 =ğ-
EINVAL
) {

1386 
	`´štk
(
KERN_ERR
 
PREFIX


1388 
	`di§bË_aıi
();

1392 
	}
}

1394 
__š™
 
	$aıi_´oûss_madt
()

1396 #ifdeà
CONFIG_X86_LOCAL_APIC


1397 
”rÜ
;

1399 ià(!
	`aıi_bË_·r£
(
ACPI_SIG_MADT
, 
aıi_·r£_madt
)) {

1404 
”rÜ
 = 
	`aıi_·r£_madt_Ïpic_’Œ›s
();

1405 ià(!
”rÜ
) {

1406 
aıi_Ïpic
 = 1;

1408 #ifdeà
CONFIG_X86_BIGSMP


1409 
	`g’”ic_bigsmp_´obe
();

1414 
”rÜ
 = 
	`aıi_·r£_madt_ißpic_’Œ›s
();

1415 ià(!
”rÜ
) {

1416 
aıi_œq_mod–
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1417 
aıi_ißpic
 = 1;

1419 
smp_found_cÚfig
 = 1;

1420 ià(
­ic
->
£tup_­ic_routšg
)

1421 
­ic
->
	`£tup_­ic_routšg
();

1424 ià(
”rÜ
 =ğ-
EINVAL
) {

1428 
	`´štk
(
KERN_ERR
 
PREFIX


1430 
	`di§bË_aıi
();

1438 ià(
smp_found_cÚfig
) {

1439 
	`´štk
(
KERN_WARNING
 
PREFIX


1441 
smp_found_cÚfig
 = 0;

1449 ià(
aıi_Ïpic
 && 
aıi_ißpic
)

1450 
	`´štk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1452 ià(
aıi_Ïpic
)

1453 
	`´štk
(
KERN_INFO
 "Using ACPI for…rocessor (LAPIC) "

1457 
	}
}

1459 
__š™
 
	$di§bË_aıi_œq
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

1461 ià(!
aıi_fÜû
) {

1462 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=noirq\n",

1463 
d
->
id’t
);

1464 
	`aıi_noœq_£t
();

1467 
	}
}

1469 
__š™
 
	$di§bË_aıi_pci
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

1471 ià(!
aıi_fÜû
) {

1472 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of…ci=noacpi\n",

1473 
d
->
id’t
);

1474 
	`aıi_di§bË_pci
();

1477 
	}
}

1479 
__š™
 
	$dmi_di§bË_aıi
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

1481 ià(!
aıi_fÜû
) {

1482 
	`´štk
(
KERN_NOTICE
 "% d‘eùed:‡ı˜off\n", 
d
->
id’t
);

1483 
	`di§bË_aıi
();

1485 
	`´štk
(
KERN_NOTICE


1489 
	}
}

1494 
__š™
 
	$fÜû_aıi_ht
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

1496 ià(!
aıi_fÜû
) {

1497 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=ht\n",

1498 
d
->
id’t
);

1499 
	`di§bË_aıi
();

1500 
aıi_ht
 = 1;

1502 
	`´štk
(
KERN_NOTICE


1506 
	}
}

1511 
__š™
 
	$dmi_ignÜe_œq0_tim”_ov”ride
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

1517 ià(!
aıi_sk_tim”_ov”ride
) {

1518 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirk‚ot complete.\n");

1519 
	`´_nÙiû
("%s detected: Ignoring BIOS IRQ0…in2 override\n",

1520 
d
->
id’t
);

1521 
aıi_sk_tim”_ov”ride
 = 1;

1524 
	}
}

1530 
dmi_sy¡em_id
 
__š™d©a
 
	gaıi_dmi_bË
[] = {

1535 .
ÿÎback
 = 
dmi_di§bË_aıi
,

1536 .
	gid’t
 = "IBM Thinkpad",

1537 .
	gm©ches
 = {

1538 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1539 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1547 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1548 .
	gid’t
 = "FSC Primergy T850",

1549 .
	gm©ches
 = {

1550 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

1551 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

1555 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1556 .
	gid’t
 = "HP VISUALIZE NT Workstation",

1557 .
	gm©ches
 = {

1558 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

1559 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

1563 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1564 .
	gid’t
 = "Compaq Workstation W8000",

1565 .
	gm©ches
 = {

1566 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

1567 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

1571 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1572 .
	gid’t
 = "ASUS P4B266",

1573 .
	gm©ches
 = {

1574 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1575 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4B266"),

1579 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1580 .
	gid’t
 = "ASUS P2B-DS",

1581 .
	gm©ches
 = {

1582 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1583 
DMI_MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

1587 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1588 .
	gid’t
 = "ASUS CUR-DLS",

1589 .
	gm©ches
 = {

1590 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1591 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

1595 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1596 .
	gid’t
 = "ABIT i440BX-W83977",

1597 .
	gm©ches
 = {

1598 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

1599 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

1603 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1604 .
	gid’t
 = "IBM Bladecenter",

1605 .
	gm©ches
 = {

1606 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1607 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMƒServer BladeCenter HS20"),

1611 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1612 .
	gid’t
 = "IBMƒServer xSeries 360",

1613 .
	gm©ches
 = {

1614 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1615 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

1619 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1620 .
	gid’t
 = "IBMƒserver xSeries 330",

1621 .
	gm©ches
 = {

1622 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1623 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

1627 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1628 .
	gid’t
 = "IBMƒserver xSeries 440",

1629 .
	gm©ches
 = {

1630 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1631 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

1639 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1640 .
	gid’t
 = "ASUS A7V",

1641 .
	gm©ches
 = {

1642 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1643 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1645 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1656 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1657 .
	gid’t
 = "IBM Thinkpad 600 Series 2645",

1658 .
	gm©ches
 = {

1659 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1660 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1664 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1665 .
	gid’t
 = "IBM Thinkpad 600 Series 2646",

1666 .
	gm©ches
 = {

1667 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1668 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1675 .
	gÿÎback
 = 
di§bË_aıi_pci
,

1676 .
	gid’t
 = "ASUS PR-DLS",

1677 .
	gm©ches
 = {

1678 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1679 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1680 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1682 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1686 .
	gÿÎback
 = 
di§bË_aıi_pci
,

1687 .
	gid’t
 = "Acer TravelMate 36x Laptop",

1688 .
	gm©ches
 = {

1689 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1690 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1697 
dmi_sy¡em_id
 
__š™d©a
 
	gaıi_dmi_bË_Ï‹
[] = {

1709 .
ÿÎback
 = 
dmi_ignÜe_œq0_tim”_ov”ride
,

1710 .
	gid’t
 = "HP‚x6115†aptop",

1711 .
	gm©ches
 = {

1712 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1713 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq‚x6115"),

1717 .
	gÿÎback
 = 
dmi_ignÜe_œq0_tim”_ov”ride
,

1718 .
	gid’t
 = "HP NX6125†aptop",

1719 .
	gm©ches
 = {

1720 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1721 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq‚x6125"),

1725 .
	gÿÎback
 = 
dmi_ignÜe_œq0_tim”_ov”ride
,

1726 .
	gid’t
 = "HP NX6325†aptop",

1727 .
	gm©ches
 = {

1728 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1729 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq‚x6325"),

1733 .
	gÿÎback
 = 
dmi_ignÜe_œq0_tim”_ov”ride
,

1734 .
	gid’t
 = "HP 6715b†aptop",

1735 .
	gm©ches
 = {

1736 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1737 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1766 
__š™
 
	$aıi_boÙ_bË_š™
()

1768 
”rÜ
;

1770 
	`dmi_check_sy¡em
(
aıi_dmi_bË
);

1776 ià(
aıi_di§bËd
 && !
aıi_ht
)

1782 
”rÜ
 = 
	`aıi_bË_š™
();

1783 ià(
”rÜ
) {

1784 
	`di§bË_aıi
();

1785  
”rÜ
;

1788 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

1793 
”rÜ
 = 
	`aıi_bÏckli¡ed
();

1794 ià(
”rÜ
) {

1795 ià(
aıi_fÜû
) {

1796 
	`´štk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1798 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1799 
	`di§bË_aıi
();

1800  
”rÜ
;

1805 
	}
}

1807 
__š™
 
	$—¾y_aıi_boÙ_š™
()

1813 ià(
aıi_di§bËd
 && !
aıi_ht
)

1819 
	`—¾y_aıi_´oûss_madt
();

1822 
	}
}

1824 
__š™
 
	$aıi_boÙ_š™
()

1827 
	`dmi_check_sy¡em
(
aıi_dmi_bË_Ï‹
);

1833 ià(
aıi_di§bËd
 && !
aıi_ht
)

1836 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

1841 
	`aıi_bË_·r£
(
ACPI_SIG_FADT
, 
aıi_·r£_çdt
);

1846 
	`aıi_´oûss_madt
();

1848 
	`aıi_bË_·r£
(
ACPI_SIG_HPET
, 
aıi_·r£_h³t
);

1851 
	}
}

1853 
__š™
 
	$·r£_aıi
(*
¬g
)

1855 ià(!
¬g
)

1856  -
EINVAL
;

1859 ià(
	`¡rcmp
(
¬g
, "off") == 0) {

1860 
	`di§bË_aıi
();

1863 ià(
	`¡rcmp
(
¬g
, "force") == 0) {

1864 
aıi_fÜû
 = 1;

1865 
aıi_ht
 = 1;

1866 
aıi_di§bËd
 = 0;

1869 ià(
	`¡rcmp
(
¬g
, "strict") == 0) {

1870 
aıi_¡riù
 = 1;

1873 ià(
	`¡rcmp
(
¬g
, "ht") == 0) {

1874 ià(!
aıi_fÜû
)

1875 
	`di§bË_aıi
();

1876 
aıi_ht
 = 1;

1879 ià(
	`¡rcmp
(
¬g
, "rsdt") == 0) {

1880 
aıi_rsdt_fÜûd
 = 1;

1883 ià(
	`¡rcmp
(
¬g
, "noirq") == 0) {

1884 
	`aıi_noœq_£t
();

1887  -
EINVAL
;

1890 
	}
}

1891 
—¾y_·¿m
("aıi", 
·r£_aıi
);

1894 
__š™
 
	$·r£_pci
(*
¬g
)

1896 ià(
¬g
 && 
	`¡rcmp
(arg, "noacpi") == 0)

1897 
	`aıi_di§bË_pci
();

1899 
	}
}

1900 
—¾y_·¿m
("pci", 
·r£_pci
);

1902 
__š™
 
	$aıi_mps_check
()

1904 #ià
	`defšed
(
CONFIG_X86_LOCAL_APIC
è&& !defšed(
CONFIG_X86_MPPARSE
)

1906 ià(
aıi_di§bËd
 || 
aıi_noœq
) {

1907 
	`´štk
(
KERN_WARNING
 "MPS support code is‚ot built-in.\n"

1914 
	}
}

1916 #ifdeà
CONFIG_X86_IO_APIC


1917 
__š™
 
	$·r£_aıi_sk_tim”_ov”ride
(*
¬g
)

1919 
aıi_sk_tim”_ov”ride
 = 1;

1921 
	}
}

1922 
—¾y_·¿m
("aıi_sk_tim”_ov”ride", 
·r£_aıi_sk_tim”_ov”ride
);

1924 
__š™
 
	$·r£_aıi_u£_tim”_ov”ride
(*
¬g
)

1926 
aıi_u£_tim”_ov”ride
 = 1;

1928 
	}
}

1929 
—¾y_·¿m
("aıi_u£_tim”_ov”ride", 
·r£_aıi_u£_tim”_ov”ride
);

1932 
__š™
 
	$£tup_aıi_sci
(*
s
)

1934 ià(!
s
)

1935  -
EINVAL
;

1936 ià(!
	`¡rcmp
(
s
, "edge"))

1937 
aıi_sci_æags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1938 (
aıi_sci_æags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1939 ià(!
	`¡rcmp
(
s
, "level"))

1940 
aıi_sci_æags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1941 (
aıi_sci_æags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1942 ià(!
	`¡rcmp
(
s
, "high"))

1943 
aıi_sci_æags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1944 (
aıi_sci_æags
 & ~
ACPI_MADT_POLARITY_MASK
);

1945 ià(!
	`¡rcmp
(
s
, "low"))

1946 
aıi_sci_æags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1947 (
aıi_sci_æags
 & ~
ACPI_MADT_POLARITY_MASK
);

1949  -
EINVAL
;

1951 
	}
}

1952 
—¾y_·¿m
("aıi_sci", 
£tup_aıi_sci
);

1954 
	$__aıi_acquœe_glob®_lock
(*
lock
)

1956 
Şd
, 
Ãw
, 
v®
;

1958 
Şd
 = *
lock
;

1959 
Ãw
 = (((
Şd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1960 
v®
 = 
	`cmpxchg
(
lock
, 
Şd
, 
Ãw
);

1961 } 
	`uÆik–y
 (
v®
 !ğ
Şd
));

1962  (
Ãw
 < 3) ? -1 : 0;

1963 
	}
}

1965 
	$__aıi_»Ëa£_glob®_lock
(*
lock
)

1967 
Şd
, 
Ãw
, 
v®
;

1969 
Şd
 = *
lock
;

1970 
Ãw
 = 
Şd
 & ~0x3;

1971 
v®
 = 
	`cmpxchg
(
lock
, 
Şd
, 
Ãw
);

1972 } 
	`uÆik–y
 (
v®
 !ğ
Şd
));

1973  
Şd
 & 0x1;

1974 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/moduË.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/aıi.h
>

11 
	~<lšux/ıu.h
>

12 
	~<lšux/sched.h
>

14 
	~<aıi/´oûssÜ.h
>

15 
	~<asm/aıi.h
>

27 
	$aıi_´oûssÜ_pow”_š™_bm_check
(
aıi_´oûssÜ_æags
 *
æags
,

28 
ıu
)

30 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

32 
æags
->
bm_check
 = 0;

33 ià(
	`num_Úlše_ıus
() == 1)

34 
æags
->
bm_check
 = 1;

35 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) {

41 
æags
->
bm_check
 = 1;

43 
	}
}

44 
EXPORT_SYMBOL
(
aıi_´oûssÜ_pow”_š™_bm_check
);

48 
	sc¡©e_’Œy
 {

50 
	m—x
;

51 
	mecx
;

52 } 
	m¡©es
[
ACPI_PROCESSOR_MAX_POWER
];

54 
c¡©e_’Œy
 *
	gıu_c¡©e_’Œy
;

56 
	gmwa™_suµÜ‹d
[
ACPI_PROCESSOR_MAX_POWER
];

58 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

59 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

60 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

62 
	#CPUID_MWAIT_LEAF
 (5)

	)

63 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

64 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

66 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

68 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

70 
	$aıi_´oûssÜ_ffh_c¡©e_´obe_ıu
(*
_cx
)

72 
aıi_´oûssÜ_cx
 *
cx
 = 
_cx
;

73 
»tv®
;

74 
—x
, 
ebx
, 
ecx
, 
edx
;

75 
edx_·¹
;

76 
c¡©e_ty³
;

77 
num_c¡©e_subty³
;

79 
	`ıuid
(
CPUID_MWAIT_LEAF
, &
—x
, &
ebx
, &
ecx
, &
edx
);

82 
c¡©e_ty³
 = ((
cx
->
add»ss
 >> 
MWAIT_SUBSTATE_SIZE
) &

83 
MWAIT_CSTATE_MASK
) + 1;

84 
edx_·¹
 = 
edx
 >> (
c¡©e_ty³
 * 
MWAIT_SUBSTATE_SIZE
);

85 
num_c¡©e_subty³
 = 
edx_·¹
 & 
MWAIT_SUBSTATE_MASK
;

87 
»tv®
 = 0;

88 ià(
num_c¡©e_subty³
 < (
cx
->
add»ss
 & 
MWAIT_SUBSTATE_MASK
)) {

89 
»tv®
 = -1;

90 
out
;

94 ià(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

95 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

96 
»tv®
 = -1;

97 
out
;

100 ià(!
mwa™_suµÜ‹d
[
c¡©e_ty³
]) {

101 
mwa™_suµÜ‹d
[
c¡©e_ty³
] = 1;

102 
	`´štk
(
KERN_DEBUG


104 "¡©e\n", 
cx
->
ty³
);

106 
	`¢´štf
(
cx
->
desc
,

107 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

108 
cx
->
add»ss
);

109 
out
:

110  
»tv®
;

111 
	}
}

113 
	$aıi_´oûssÜ_ffh_c¡©e_´obe
(
ıu
,

114 
aıi_´oûssÜ_cx
 *
cx
, 
aıi_pow”_»gi¡”
 *
»g
)

116 
c¡©e_’Œy
 *
³rıu_’Œy
;

117 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

118 
»tv®
;

120 ià(!
ıu_c¡©e_’Œy
 || 
c
->
ıuid_Ëv–
 < 
CPUID_MWAIT_LEAF
)

123 ià(
»g
->
b™_off£t
 !ğ
NATIVE_CSTATE_BEYOND_HALT
)

126 
³rıu_’Œy
 = 
	`³r_ıu_±r
(
ıu_c¡©e_’Œy
, 
ıu
);

127 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
 = 0;

128 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
 = 0;

132 
»tv®
 = 
	`wÜk_Ú_ıu
(
ıu
, 
aıi_´oûssÜ_ffh_c¡©e_´obe_ıu
, 
cx
);

133 ià(
»tv®
 == 0) {

135 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
 = cx->
add»ss
;

136 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

138  
»tv®
;

139 
	}
}

140 
EXPORT_SYMBOL_GPL
(
aıi_´oûssÜ_ffh_c¡©e_´obe
);

142 
	$aıi_´oûssÜ_ffh_c¡©e_’‹r
(
aıi_´oûssÜ_cx
 *
cx
)

144 
ıu
 = 
	`smp_´oûssÜ_id
();

145 
c¡©e_’Œy
 *
³rıu_’Œy
;

147 
³rıu_’Œy
 = 
	`³r_ıu_±r
(
ıu_c¡©e_’Œy
, 
ıu
);

148 
	`mwa™_idË_w™h_hšts
(
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
,

149 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
);

150 
	}
}

151 
EXPORT_SYMBOL_GPL
(
aıi_´oûssÜ_ffh_c¡©e_’‹r
);

153 
__š™
 
	$ffh_c¡©e_š™
()

155 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

156 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
)

159 
ıu_c¡©e_’Œy
 = 
	`®loc_³rıu
(
c¡©e_’Œy
);

161 
	}
}

163 
__ex™
 
	$ffh_c¡©e_ex™
()

165 
	`ä“_³rıu
(
ıu_c¡©e_’Œy
);

166 
ıu_c¡©e_’Œy
 = 
NULL
;

167 
	}
}

169 
¬ch_š™ÿÎ
(
ffh_c¡©e_š™
);

170 
__ex™ÿÎ
(
ffh_c¡©e_ex™
);

	@/cmpt816/linux/arch/x86/kernel/acpi/processor.c

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/moduË.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/aıi.h
>

12 
	~<aıi/´oûssÜ.h
>

13 
	~<asm/aıi.h
>

15 
	$š™_š‹l_pdc
(
aıi_´oûssÜ
 *
´
, 
ıušfo_x86
 *
c
)

17 
aıi_objeù_li¡
 *
obj_li¡
;

18 
aıi_objeù
 *
obj
;

19 
u32
 *
buf
;

22 
obj_li¡
 = 
	`km®loc
((
aıi_objeù_li¡
), 
GFP_KERNEL
);

23 ià(!
obj_li¡
) {

24 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

28 
obj
 = 
	`km®loc
((
aıi_objeù
), 
GFP_KERNEL
);

29 ià(!
obj
) {

30 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

31 
	`kä“
(
obj_li¡
);

35 
buf
 = 
	`km®loc
(12, 
GFP_KERNEL
);

36 ià(!
buf
) {

37 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

38 
	`kä“
(
obj
);

39 
	`kä“
(
obj_li¡
);

43 
buf
[0] = 
ACPI_PDC_REVISION_ID
;

44 
buf
[1] = 1;

45 
buf
[2] = 
ACPI_PDC_C_CAPABILITY_SMP
;

52 
buf
[2] |ğ
ACPI_PDC_SMP_T_SWCOORD
;

53 ià(
	`ıu_has
(
c
, 
X86_FEATURE_EST
))

54 
buf
[2] |ğ
ACPI_PDC_EST_CAPABILITY_SWSMP
;

56 ià(
	`ıu_has
(
c
, 
X86_FEATURE_ACPI
))

57 
buf
[2] |ğ
ACPI_PDC_T_FFH
;

62 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_MWAIT
))

63 
buf
[2] &ğ~(
ACPI_PDC_C_C2C3_FFH
);

65 
obj
->
ty³
 = 
ACPI_TYPE_BUFFER
;

66 
obj
->
bufãr
.
Ëngth
 = 12;

67 
obj
->
bufãr
.
poš‹r
 = (
u8
 *è
buf
;

68 
obj_li¡
->
couÁ
 = 1;

69 
obj_li¡
->
poš‹r
 = 
obj
;

70 
´
->
pdc
 = 
obj_li¡
;

73 
	}
}

76 
	$¬ch_aıi_´oûssÜ_š™_pdc
(
aıi_´oûssÜ
 *
´
)

78 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
´
->
id
);

80 
´
->
pdc
 = 
NULL
;

81 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

82 
	`š™_š‹l_pdc
(
´
, 
c
);

85 
	}
}

87 
EXPORT_SYMBOL
(
¬ch_aıi_´oûssÜ_š™_pdc
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boÙ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boÙ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boÙ/video-ve§.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boÙ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boÙ.h
"

4 
	$ud–ay
(
loİs
)

6 
loİs
--)

7 
	`io_d–ay
();

8 
	}
}

10 
	$b“p
(
hz
)

12 
u8
 
’abË
;

14 ià(!
hz
) {

15 
’abË
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_d–ay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_d–ay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_d–ay
();

26 
’abË
 = 0x03;

28 
	`šb
(0x61);

29 
	`io_d–ay
();

30 
	`outb
(
’abË
, 0x61);

31 
	`io_d–ay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_mÜ£
(cÚ¡ *
·‰”n
)

41 
s
;

43 (
s
 = *
·‰”n
++)) {

44 
s
) {

46 
	`b“p
(
DOT_HZ
);

47 
	`ud–ay
(
US_PER_DOT
);

48 
	`b“p
(0);

49 
	`ud–ay
(
US_PER_DOT
);

52 
	`b“p
(
DASH_HZ
);

53 
	`ud–ay
(
US_PER_DOT
 * 3);

54 
	`b“p
(0);

55 
	`ud–ay
(
US_PER_DOT
);

58 
	`ud–ay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maš
()

67 ià(
wakeup_h—d”
.
»®_magic
 != 0x12345678)

70 ià(
wakeup_h—d”
.
»®mode_æags
 & 4)

71 
	`£nd_mÜ£
("...-");

73 ià(
wakeup_h—d”
.
»®mode_æags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 ià(
wakeup_h—d”
.
»®mode_æags
 & 2) {

78 
	`´obe_ÿrds
(0);

79 
	`£t_mode
(
wakeup_h—d”
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<lšux/aıi.h
>

9 
	~<lšux/boÙmem.h
>

10 
	~<lšux/dmi.h
>

11 
	~<lšux/ıumask.h
>

12 
	~<asm/£gm’t.h
>

13 
	~<asm/desc.h
>

15 
	~"»®mode/wakeup.h
"

16 
	~"¦“p.h
"

18 
	gaıi_wakeup_add»ss
;

19 
	gaıi_»®mode_æags
;

22 
	gaıi_»®mode
;

24 #ià
defšed
(
CONFIG_SMP
è&& defšed(
CONFIG_64BIT
)

25 
	g‹mp_¡ack
[4096];

36 
	$aıi_§ve_¡©e_mem
()

38 
wakeup_h—d”
 *
h—d”
;

40 ià(!
aıi_»®mode
) {

41 
	`´štk
(
KERN_ERR
 "Could‚ot‡llocate memory during boot, "

43  -
ENOMEM
;

45 
	`memıy
((*)
aıi_»®mode
, &
wakeup_code_¡¬t
, 
WAKEUP_SIZE
);

47 
h—d”
 = (
wakeup_h—d”
 *)(
aıi_»®mode
 + 
HEADER_OFFSET
);

48 ià(
h—d”
->
sigÇtu»
 != 0x51ee1111) {

49 
	`´štk
(
KERN_ERR
 "wakeup header does‚ot match\n");

50  -
EINVAL
;

53 
h—d”
->
video_mode
 = 
§ved_video_mode
;

55 
h—d”
->
wakeup_jmp_£g
 = 
aıi_wakeup_add»ss
 >> 4;

66 
h—d”
->
wakeup_gdt
[0] =

67 (
u64
)((
h—d”
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
aıi_wakeup_add»ss
 +

69 ((*)&
h—d”
->
wakeup_gdt
 - (*)
aıi_»®mode
))

72 
h—d”
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
aıi_wakeup_add»ss
, 0xfffff);

75 
h—d”
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
aıi_wakeup_add»ss
, 0xfffff);

78 #iâdeà
CONFIG_64BIT


79 
	`¡Üe_gdt
((
desc_±r
 *)&
h—d”
->
pmode_gdt
);

81 
h—d”
->
pmode_eãr_low
 = 
nx_’abËd
;

82 ià(
h—d”
->
pmode_eãr_low
 & 1) {

84 
	`rdm¤
(
MSR_EFER
, 
h—d”
->
pmode_eãr_low
,

85 
h—d”
->
pmode_eãr_high
);

89 
h—d”
->
pmode_ü0
 = 
	`»ad_ü0
();

90 
h—d”
->
pmode_ü4
 = 
	`»ad_ü4_§ã
();

91 
h—d”
->
»®mode_æags
 = 
aıi_»®mode_æags
;

92 
h—d”
->
»®_magic
 = 0x12345678;

94 #iâdeà
CONFIG_64BIT


95 
h—d”
->
pmode_’Œy
 = (
u32
)&
wakeup_pmode_»tuº
;

96 
h—d”
->
pmode_ü3
 = (
u32
)(
swsu¥_pg_dœ
 - 
__PAGE_OFFSET
);

97 
§ved_magic
 = 0x12345678;

99 
h—d”
->
ŒampŞše_£gm’t
 = 
	`£tup_ŒampŞše
() >> 4;

100 #ifdeà
CONFIG_SMP


101 
¡ack_¡¬t
.
¥
 = 
‹mp_¡ack
 + (temp_stack);

102 
—¾y_gdt_desü
.
add»ss
 =

103 ()
	`g‘_ıu_gdt_bË
(
	`smp_´oûssÜ_id
());

104 
š™Ÿl_gs
 = 
	`³r_ıu_off£t
(
	`smp_´oûssÜ_id
());

106 
š™Ÿl_code
 = ()
wakeup_lÚg64
;

107 
§ved_magic
 = 0x123456789abcdef0;

111 
	}
}

116 
	$aıi_»¡Üe_¡©e_mem
()

118 
	}
}

129 
__š™
 
	$aıi_»£rve_boÙmem
()

131 ià((&
wakeup_code_’d
 - &
wakeup_code_¡¬t
è> 
WAKEUP_SIZE
) {

132 
	`´štk
(
KERN_ERR


137 
aıi_»®mode
 = ()
	`®loc_boÙmem_low
(
WAKEUP_SIZE
);

139 ià(!
aıi_»®mode
) {

140 
	`´štk
(
KERN_ERR
 "ACPI: Cannot‡llocate†owmem, S3 disabled.\n");

144 
aıi_wakeup_add»ss
 = 
	`vœt_to_phys
((*)
aıi_»®mode
);

145 
	}
}

148 
__š™
 
	$aıi_¦“p_£tup
(*
¡r
)

150 (
¡r
 !ğ
NULL
) && (*str != '\0')) {

151 ià(
	`¡ºcmp
(
¡r
, "s3_bios", 7) == 0)

152 
aıi_»®mode_æags
 |= 1;

153 ià(
	`¡ºcmp
(
¡r
, "s3_mode", 7) == 0)

154 
aıi_»®mode_æags
 |= 2;

155 ià(
	`¡ºcmp
(
¡r
, "s3_beep", 7) == 0)

156 
aıi_»®mode_æags
 |= 4;

157 #ifdeà
CONFIG_HIBERNATION


158 ià(
	`¡ºcmp
(
¡r
, "s4_nohwsig", 10) == 0)

159 
	`aıi_no_s4_hw_sigÇtu»
();

160 ià(
	`¡ºcmp
(
¡r
, "s4_nonvs", 8) == 0)

161 
	`aıi_s4_no_nvs
();

163 ià(
	`¡ºcmp
(
¡r
, "old_ordering", 12) == 0)

164 
	`aıi_Şd_su¥’d_Üd”šg
();

165 
¡r
 = 
	`¡rchr
(str, ',');

166 ià(
¡r
 !ğ
NULL
)

167 
¡r
 +ğ
	`¡r¥n
(str, ", \t");

170 
	}
}

172 
__£tup
("aıi_¦“p=", 
aıi_¦“p_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/mu‹x.h
>

4 
	~<lšux/li¡.h
>

5 
	~<lšux/k´obes.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/vm®loc.h
>

8 
	~<lšux/memÜy.h
>

9 
	~<asm/®‹º©ive.h
>

10 
	~<asm/£ùiÚs.h
>

11 
	~<asm/pgbË.h
>

12 
	~<asm/mû.h
>

13 
	~<asm/nmi.h
>

14 
	~<asm/vsysÿÎ.h
>

15 
	~<asm/ÿcheæush.h
>

16 
	~<asm/bæush.h
>

17 
	~<asm/io.h
>

18 
	~<asm/fixm­.h
>

20 
	#MAX_PATCH_LEN
 (255-1)

	)

22 #ifdeà
CONFIG_HOTPLUG_CPU


23 
	gsmp_®t_Úû
;

25 
__š™
 
	$boÙÚly
(*
¡r
)

27 
smp_®t_Úû
 = 1;

29 
	}
}

30 
__£tup
("smp-®t-boÙ", 
boÙÚly
);

32 
	#smp_®t_Úû
 1

	)

35 
	gdebug_®‹º©ive
;

37 
__š™
 
	$debug_®t
(*
¡r
)

39 
debug_®‹º©ive
 = 1;

41 
	}
}

42 
__£tup
("debug-®‹º©ive", 
debug_®t
);

44 
	gnÜ•Ïû_smp
;

46 
__š™
 
	$£tup_nÜ•Ïû_smp
(*
¡r
)

48 
nÜ•Ïû_smp
 = 1;

50 
	}
}

51 
__£tup
("nÜ•Ïû-smp", 
£tup_nÜ•Ïû_smp
);

53 #ifdeà
CONFIG_PARAVIRT


54 
	gnÜ•Ïû_·¿vœt
 = 0;

56 
__š™
 
	$£tup_nÜ•Ïû_·¿vœt
(*
¡r
)

58 
nÜ•Ïû_·¿vœt
 = 1;

60 
	}
}

61 
__£tup
("nÜ•Ïû-·¿vœt", 
£tup_nÜ•Ïû_·¿vœt
);

64 
	#DPRINTK
(
fmt
, 
¬gs
...èià(
debug_®‹º©ive
) \

65 
	`´štk
(
KERN_DEBUG
 
fmt
, 
¬gs
)

	)

67 #ifdeà
GENERIC_NOP1


71 
asm
("\t.section .rodata, \"a\"\nintelnops: "

72 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


73 
GENERIC_NOP7
 
GENERIC_NOP8


75 cÚ¡ 
š‹Êİs
[];

76 cÚ¡ *cÚ¡ 
	gš‹l_nİs
[
ASM_NOP_MAX
+1] = {

77 
NULL
,

78 
š‹Êİs
,

79 
š‹Êİs
 + 1,

80 
š‹Êİs
 + 1 + 2,

81 
š‹Êİs
 + 1 + 2 + 3,

82 
š‹Êİs
 + 1 + 2 + 3 + 4,

83 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5,

84 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5 + 6,

85 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

89 #ifdeà
K8_NOP1


90 
asm
("\t.section .rodata, \"a\"\nk8nops: "

91 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


92 
K8_NOP7
 
K8_NOP8


94 cÚ¡ 
k8nİs
[];

95 cÚ¡ *cÚ¡ 
	gk8_nİs
[
ASM_NOP_MAX
+1] = {

96 
NULL
,

97 
k8nİs
,

98 
k8nİs
 + 1,

99 
k8nİs
 + 1 + 2,

100 
k8nİs
 + 1 + 2 + 3,

101 
k8nİs
 + 1 + 2 + 3 + 4,

102 
k8nİs
 + 1 + 2 + 3 + 4 + 5,

103 
k8nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

104 
k8nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

108 #ifdeà
K7_NOP1


109 
asm
("\t.section .rodata, \"a\"\nk7nops: "

110 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


111 
K7_NOP7
 
K7_NOP8


113 cÚ¡ 
k7nİs
[];

114 cÚ¡ *cÚ¡ 
	gk7_nİs
[
ASM_NOP_MAX
+1] = {

115 
NULL
,

116 
k7nİs
,

117 
k7nİs
 + 1,

118 
k7nİs
 + 1 + 2,

119 
k7nİs
 + 1 + 2 + 3,

120 
k7nİs
 + 1 + 2 + 3 + 4,

121 
k7nİs
 + 1 + 2 + 3 + 4 + 5,

122 
k7nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

123 
k7nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

127 #ifdeà
P6_NOP1


128 
asm
("\t.section .rodata, \"a\"\np6nops: "

129 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


130 
P6_NOP7
 
P6_NOP8


132 cÚ¡ 
p6nİs
[];

133 cÚ¡ *cÚ¡ 
	gp6_nİs
[
ASM_NOP_MAX
+1] = {

134 
NULL
,

135 
p6nİs
,

136 
p6nİs
 + 1,

137 
p6nİs
 + 1 + 2,

138 
p6nİs
 + 1 + 2 + 3,

139 
p6nİs
 + 1 + 2 + 3 + 4,

140 
p6nİs
 + 1 + 2 + 3 + 4 + 5,

141 
p6nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

142 
p6nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

146 #ifdeà
CONFIG_X86_64


148 
__vsysÿÎ_0
;

149 cÚ¡ *cÚ¡ *
	$fšd_nİ_bË
()

151 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

152 
	`boÙ_ıu_has
(
X86_FEATURE_NOPL
))

153  
p6_nİs
;

155  
k8_nİs
;

156 
	}
}

160 cÚ¡ *cÚ¡ *
	$fšd_nİ_bË
()

162 ià(
	`boÙ_ıu_has
(
X86_FEATURE_K8
))

163  
k8_nİs
;

164 ià(
	`boÙ_ıu_has
(
X86_FEATURE_K7
))

165  
k7_nİs
;

166 ià(
	`boÙ_ıu_has
(
X86_FEATURE_NOPL
))

167  
p6_nİs
;

169  
š‹l_nİs
;

170 
	}
}

175 
	$add_nİs
(*
š¢s
, 
Ën
)

177 cÚ¡ *cÚ¡ *
nİbË
 = 
	`fšd_nİ_bË
();

179 
Ën
 > 0) {

180 
nİËn
 = 
Ën
;

181 ià(
nİËn
 > 
ASM_NOP_MAX
)

182 
nİËn
 = 
ASM_NOP_MAX
;

183 
	`memıy
(
š¢s
, 
nİbË
[
nİËn
],‚oplen);

184 
š¢s
 +ğ
nİËn
;

185 
Ën
 -ğ
nİËn
;

187 
	}
}

188 
EXPORT_SYMBOL_GPL
(
add_nİs
);

190 
®t_š¡r
 
__®t_š¡ruùiÚs
[], 
__®t_š¡ruùiÚs_’d
[];

191 
u8
 *
__smp_locks
[], *
__smp_locks_’d
[];

199 
	$­¶y_®‹º©ives
(
®t_š¡r
 *
¡¬t
, ®t_š¡¸*
’d
)

201 
®t_š¡r
 *
a
;

202 
š¢buf
[
MAX_PATCH_LEN
];

204 
	`DPRINTK
("%s:‡ÉabË %°-> %p\n", 
__func__
, 
¡¬t
, 
’d
);

205 
a
 = 
¡¬t
;‡ < 
’d
;‡++) {

206 
u8
 *
š¡r
 = 
a
->instr;

207 
	`BUG_ON
(
a
->
»¶aûm’’
 >‡->
š¡¾’
);

208 
	`BUG_ON
(
a
->
š¡¾’
 > (
š¢buf
));

209 ià(!
	`boÙ_ıu_has
(
a
->
ıuid
))

211 #ifdeà
CONFIG_X86_64


213 ià(
š¡r
 >ğ(
u8
 *)
VSYSCALL_START
 && in¡¸< (u8*)
VSYSCALL_END
) {

214 
š¡r
 = 
	`__va
(š¡¸- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__·_symbŞ
(&
__vsysÿÎ_0
));

215 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

216 
__func__
, 
a
->
š¡r
, instr);

219 
	`memıy
(
š¢buf
, 
a
->
»¶aûm’t
,‡->
»¶aûm’’
);

220 
	`add_nİs
(
š¢buf
 + 
a
->
»¶aûm’’
,

221 
a
->
š¡¾’
 -‡->
»¶aûm’’
);

222 
	`‹xt_poke_—¾y
(
š¡r
, 
š¢buf
, 
a
->
š¡¾’
);

224 
	}
}

226 #ifdeà
CONFIG_SMP


228 
	$®‹º©ives_smp_lock
(
u8
 **
¡¬t
, u8 **
’d
, u8 *
‹xt
, u8 *
‹xt_’d
)

230 
u8
 **
±r
;

232 
	`mu‹x_lock
(&
‹xt_mu‹x
);

233 
±r
 = 
¡¬t
;…Œ < 
’d
;…tr++) {

234 ià(*
±r
 < 
‹xt
)

236 ià(*
±r
 > 
‹xt_’d
)

239 
	`‹xt_poke
(*
±r
, (([]){0xf0}), 1);

241 
	`mu‹x_uÆock
(&
‹xt_mu‹x
);

242 
	}
}

244 
	$®‹º©ives_smp_uÆock
(
u8
 **
¡¬t
, u8 **
’d
, u8 *
‹xt
, u8 *
‹xt_’d
)

246 
u8
 **
±r
;

248 ià(
nÜ•Ïû_smp
)

251 
	`mu‹x_lock
(&
‹xt_mu‹x
);

252 
±r
 = 
¡¬t
;…Œ < 
’d
;…tr++) {

253 ià(*
±r
 < 
‹xt
)

255 ià(*
±r
 > 
‹xt_’d
)

258 
	`‹xt_poke
(*
±r
, (([]){0x3E}), 1);

260 
	`mu‹x_uÆock
(&
‹xt_mu‹x
);

261 
	}
}

263 
	ssmp_®t_moduË
 {

265 
moduË
 *
	mmod
;

266 *
	mÇme
;

269 
u8
 **
	mlocks
;

270 
u8
 **
	mlocks_’d
;

273 
u8
 *
	m‹xt
;

274 
u8
 *
	m‹xt_’d
;

276 
li¡_h—d
 
	mÃxt
;

278 
LIST_HEAD
(
smp_®t_moduËs
);

279 
DEFINE_MUTEX
(
smp_®t
);

280 
	gsmp_mode
 = 1;

282 
	$®‹º©ives_smp_moduË_add
(
moduË
 *
mod
, *
Çme
,

283 *
locks
, *
locks_’d
,

284 *
‹xt
, *
‹xt_’d
)

286 
smp_®t_moduË
 *
smp
;

288 ià(
nÜ•Ïû_smp
)

291 ià(
smp_®t_Úû
) {

292 ià(
	`boÙ_ıu_has
(
X86_FEATURE_UP
))

293 
	`®‹º©ives_smp_uÆock
(
locks
, 
locks_’d
,

294 
‹xt
, 
‹xt_’d
);

298 
smp
 = 
	`kz®loc
((*smp), 
GFP_KERNEL
);

299 ià(
NULL
 =ğ
smp
)

302 
smp
->
mod
 = mod;

303 
smp
->
Çme
 =‚ame;

304 
smp
->
locks
 =†ocks;

305 
smp
->
locks_’d
 =†ocks_end;

306 
smp
->
‹xt
 =ext;

307 
smp
->
‹xt_’d
 =ext_end;

308 
	`DPRINTK
("%s:†ocks %p -> %p,ext %p -> %p,‚ame %s\n",

309 
__func__
, 
smp
->
locks
, smp->
locks_’d
,

310 
smp
->
‹xt
, smp->
‹xt_’d
, smp->
Çme
);

312 
	`mu‹x_lock
(&
smp_®t
);

313 
	`li¡_add_
(&
smp
->
Ãxt
, &
smp_®t_moduËs
);

314 ià(
	`boÙ_ıu_has
(
X86_FEATURE_UP
))

315 
	`®‹º©ives_smp_uÆock
(
smp
->
locks
, smp->
locks_’d
,

316 
smp
->
‹xt
, smp->
‹xt_’d
);

317 
	`mu‹x_uÆock
(&
smp_®t
);

318 
	}
}

320 
	$®‹º©ives_smp_moduË_d–
(
moduË
 *
mod
)

322 
smp_®t_moduË
 *
™em
;

324 ià(
smp_®t_Úû
 || 
nÜ•Ïû_smp
)

327 
	`mu‹x_lock
(&
smp_®t
);

328 
	`li¡_fÜ_—ch_’Œy
(
™em
, &
smp_®t_moduËs
, 
Ãxt
) {

329 ià(
mod
 !ğ
™em
->mod)

331 
	`li¡_d–
(&
™em
->
Ãxt
);

332 
	`mu‹x_uÆock
(&
smp_®t
);

333 
	`DPRINTK
("%s: %s\n", 
__func__
, 
™em
->
Çme
);

334 
	`kä“
(
™em
);

337 
	`mu‹x_uÆock
(&
smp_®t
);

338 
	}
}

340 
	$®‹º©ives_smp_sw™ch
(
smp
)

342 
smp_®t_moduË
 *
mod
;

344 #ifdeà
CONFIG_LOCKDEP


352 
	`´štk
("lockdep: fixing up‡lternatives.\n");

355 ià(
nÜ•Ïû_smp
 || 
smp_®t_Úû
)

357 
	`BUG_ON
(!
smp
 && (
	`num_Úlše_ıus
() > 1));

359 
	`mu‹x_lock
(&
smp_®t
);

365 ià(
smp
 =ğ
smp_mode
) {

367 } ià(
smp
) {

368 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo SMP code\n");

369 
	`ş—r_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_UP
);

370 
	`ş—r_ıu_ÿp
(&
	`ıu_d©a
(0), 
X86_FEATURE_UP
);

371 
	`li¡_fÜ_—ch_’Œy
(
mod
, &
smp_®t_moduËs
, 
Ãxt
)

372 
	`®‹º©ives_smp_lock
(
mod
->
locks
, mod->
locks_’d
,

373 
mod
->
‹xt
, mod->
‹xt_’d
);

375 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo UP code\n");

376 
	`£t_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_UP
);

377 
	`£t_ıu_ÿp
(&
	`ıu_d©a
(0), 
X86_FEATURE_UP
);

378 
	`li¡_fÜ_—ch_’Œy
(
mod
, &
smp_®t_moduËs
, 
Ãxt
)

379 
	`®‹º©ives_smp_uÆock
(
mod
->
locks
, mod->
locks_’d
,

380 
mod
->
‹xt
, mod->
‹xt_’d
);

382 
smp_mode
 = 
smp
;

383 
	`mu‹x_uÆock
(&
smp_®t
);

384 
	}
}

388 #ifdeà
CONFIG_PARAVIRT


389 
	$­¶y_·¿vœt
(
·¿vœt_·tch_s™e
 *
¡¬t
,

390 
·¿vœt_·tch_s™e
 *
’d
)

392 
·¿vœt_·tch_s™e
 *
p
;

393 
š¢buf
[
MAX_PATCH_LEN
];

395 ià(
nÜ•Ïû_·¿vœt
)

398 
p
 = 
¡¬t
;… < 
’d
;…++) {

399 
u£d
;

401 
	`BUG_ON
(
p
->
Ën
 > 
MAX_PATCH_LEN
);

403 
	`memıy
(
š¢buf
, 
p
->
š¡r
,…->
Ën
);

404 
u£d
 = 
pv_š™_İs
.
	`·tch
(
p
->
š¡¹y³
,…->
şobb”s
, 
š¢buf
,

405 ()
p
->
š¡r
,…->
Ën
);

407 
	`BUG_ON
(
u£d
 > 
p
->
Ën
);

410 
	`add_nİs
(
š¢buf
 + 
u£d
, 
p
->
Ën
 - used);

411 
	`‹xt_poke_—¾y
(
p
->
š¡r
, 
š¢buf
,…->
Ën
);

413 
	}
}

414 
·¿vœt_·tch_s™e
 
__¡¬t_·¿š¡ruùiÚs
[],

415 
__¡İ_·¿š¡ruùiÚs
[];

418 
__š™
 
	$®‹º©ive_š¡ruùiÚs
()

423 
	`¡İ_nmi
();

436 
	`­¶y_®‹º©ives
(
__®t_š¡ruùiÚs
, 
__®t_š¡ruùiÚs_’d
);

441 #ifdeà
CONFIG_HOTPLUG_CPU


442 ià(
	`num_possibË_ıus
() < 2)

443 
smp_®t_Úû
 = 1;

446 #ifdeà
CONFIG_SMP


447 ià(
smp_®t_Úû
) {

448 ià(1 =ğ
	`num_possibË_ıus
()) {

449 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo UP code\n");

450 
	`£t_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_UP
);

451 
	`£t_ıu_ÿp
(&
	`ıu_d©a
(0), 
X86_FEATURE_UP
);

453 
	`®‹º©ives_smp_uÆock
(
__smp_locks
, 
__smp_locks_’d
,

454 
_‹xt
, 
_‘ext
);

457 
	`®‹º©ives_smp_moduË_add
(
NULL
, "core kernel",

458 
__smp_locks
, 
__smp_locks_’d
,

459 
_‹xt
, 
_‘ext
);

462 ià(
	`num_´e£Á_ıus
(è=ğ1 || 
£tup_max_ıus
 <= 1)

463 
	`®‹º©ives_smp_sw™ch
(0);

466 
	`­¶y_·¿vœt
(
__·¿š¡ruùiÚs
, 
__·¿š¡ruùiÚs_’d
);

468 ià(
smp_®t_Úû
)

469 
	`ä“_š™_·ges
("SMP‡lternatives",

470 ()
__smp_locks
,

471 ()
__smp_locks_’d
);

473 
	`»¡¬t_nmi
();

474 
	}
}

488 *
	$‹xt_poke_—¾y
(*
addr
, cÚ¡ *
İcode
, 
size_t
 
Ën
)

490 
æags
;

491 
	`loÿl_œq_§ve
(
æags
);

492 
	`memıy
(
addr
, 
İcode
, 
Ën
);

493 
	`loÿl_œq_»¡Üe
(
æags
);

494 
	`sync_cÜe
();

497  
addr
;

498 
	}
}

513 *
__k´obes
 
	$‹xt_poke
(*
addr
, cÚ¡ *
İcode
, 
size_t
 
Ën
)

515 
æags
;

516 *
vaddr
;

517 
·ge
 *
·ges
[2];

518 
i
;

520 ià(!
	`cÜe_k”Ãl_‹xt
(()
addr
)) {

521 
·ges
[0] = 
	`vm®loc_to_·ge
(
addr
);

522 
·ges
[1] = 
	`vm®loc_to_·ge
(
addr
 + 
PAGE_SIZE
);

524 
·ges
[0] = 
	`vœt_to_·ge
(
addr
);

525 
	`WARN_ON
(!
	`PageRe£rved
(
·ges
[0]));

526 
·ges
[1] = 
	`vœt_to_·ge
(
addr
 + 
PAGE_SIZE
);

528 
	`BUG_ON
(!
·ges
[0]);

529 
	`loÿl_œq_§ve
(
æags
);

530 
	`£t_fixm­
(
FIX_TEXT_POKE0
, 
	`·ge_to_phys
(
·ges
[0]));

531 ià(
·ges
[1])

532 
	`£t_fixm­
(
FIX_TEXT_POKE1
, 
	`·ge_to_phys
(
·ges
[1]));

533 
vaddr
 = (*)
	`fix_to_vœt
(
FIX_TEXT_POKE0
);

534 
	`memıy
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
İcode
, 
Ën
);

535 
	`ş—r_fixm­
(
FIX_TEXT_POKE0
);

536 ià(
·ges
[1])

537 
	`ş—r_fixm­
(
FIX_TEXT_POKE1
);

538 
	`loÿl_æush_b
();

539 
	`sync_cÜe
();

542 
i
 = 0; i < 
Ën
; i++)

543 
	`BUG_ON
(((*)
addr
)[
i
] !ğ((*)
İcode
)[i]);

544 
	`loÿl_œq_»¡Üe
(
æags
);

545  
addr
;

546 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<lšux/pci.h
>

21 
	~<lšux/gå.h
>

22 
	~<lšux/b™İs.h
>

23 
	~<lšux/debugfs.h
>

24 
	~<lšux/sÿ‰”li¡.h
>

25 
	~<lšux/dma-m­pšg.h
>

26 
	~<lšux/iommu-h–³r.h
>

27 
	~<lšux/iommu.h
>

28 
	~<asm/´Ùo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¬t.h
>

31 
	~<asm/amd_iommu_ty³s.h
>

32 
	~<asm/amd_iommu.h
>

34 
	#CMD_SET_TYPE
(
cmd
, 
t
è((cmd)->
d©a
[1] |ğ(Ñè<< 28))

	)

36 
	#EXIT_LOOP_COUNT
 10000000

	)

38 
DEFINE_RWLOCK
(
amd_iommu_devbË_lock
);

41 
LIST_HEAD
(
iommu_pd_li¡
);

42 
DEFINE_SPINLOCK
(
iommu_pd_li¡_lock
);

44 #ifdeà
CONFIG_IOMMU_API


45 
iommu_İs
 
	gamd_iommu_İs
;

51 
	siommu_cmd
 {

52 
u32
 
	md©a
[4];

55 
dma_İs_un™y_m­
(
dma_İs_domaš
 *
dma_dom
,

56 
un™y_m­_’Œy
 *
e
);

57 
dma_İs_domaš
 *
fšd_´ÙeùiÚ_domaš
(
u16
 
devid
);

60 #ifdeà
CONFIG_AMD_IOMMU_STATS


66 
DECLARE_STATS_COUNTER
(
com¶_wa™
);

67 
DECLARE_STATS_COUNTER
(
út_m­_sšgË
);

68 
DECLARE_STATS_COUNTER
(
út_unm­_sšgË
);

69 
DECLARE_STATS_COUNTER
(
út_m­_sg
);

70 
DECLARE_STATS_COUNTER
(
út_unm­_sg
);

71 
DECLARE_STATS_COUNTER
(
út_®loc_coh”’t
);

72 
DECLARE_STATS_COUNTER
(
út_ä“_coh”’t
);

73 
DECLARE_STATS_COUNTER
(
üoss_·ge
);

74 
DECLARE_STATS_COUNTER
(
domaš_æush_sšgË
);

75 
DECLARE_STATS_COUNTER
(
domaš_æush_®l
);

76 
DECLARE_STATS_COUNTER
(
®loûd_io_mem
);

77 
DECLARE_STATS_COUNTER
(
tÙ®_m­_»que¡s
);

79 
d’Œy
 *
	g¡©s_dœ
;

80 
d’Œy
 *
	gde_isŞ©e
;

81 
d’Œy
 *
	gde_fæush
;

83 
	$amd_iommu_¡©s_add
(
__iommu_couÁ”
 *
út
)

85 ià(
¡©s_dœ
 =ğ
NULL
)

88 
út
->
d’t
 = 
	`debugfs_ü—‹_u64
(út->
Çme
, 0444, 
¡©s_dœ
,

89 &
út
->
v®ue
);

90 
	}
}

92 
	$amd_iommu_¡©s_š™
()

94 
¡©s_dœ
 = 
	`debugfs_ü—‹_dœ
("amd-iommu", 
NULL
);

95 ià(
¡©s_dœ
 =ğ
NULL
)

98 
de_isŞ©e
 = 
	`debugfs_ü—‹_boŞ
("isŞ©iÚ", 0444, 
¡©s_dœ
,

99 (
u32
 *)&
amd_iommu_isŞ©e
);

101 
de_fæush
 = 
	`debugfs_ü—‹_boŞ
("fuÎæush", 0444, 
¡©s_dœ
,

102 (
u32
 *)&
amd_iommu_unm­_æush
);

104 
	`amd_iommu_¡©s_add
(&
com¶_wa™
);

105 
	`amd_iommu_¡©s_add
(&
út_m­_sšgË
);

106 
	`amd_iommu_¡©s_add
(&
út_unm­_sšgË
);

107 
	`amd_iommu_¡©s_add
(&
út_m­_sg
);

108 
	`amd_iommu_¡©s_add
(&
út_unm­_sg
);

109 
	`amd_iommu_¡©s_add
(&
út_®loc_coh”’t
);

110 
	`amd_iommu_¡©s_add
(&
út_ä“_coh”’t
);

111 
	`amd_iommu_¡©s_add
(&
üoss_·ge
);

112 
	`amd_iommu_¡©s_add
(&
domaš_æush_sšgË
);

113 
	`amd_iommu_¡©s_add
(&
domaš_æush_®l
);

114 
	`amd_iommu_¡©s_add
(&
®loûd_io_mem
);

115 
	`amd_iommu_¡©s_add
(&
tÙ®_m­_»que¡s
);

116 
	}
}

121 
	$iommu_has_Åÿche
(
amd_iommu
 *
iommu
)

123  
iommu
->
ÿp
 & (1UL << 
IOMMU_CAP_NPCACHE
);

124 
	}
}

132 
	$iommu_´št_ev’t
(*
__evt
)

134 
u32
 *
ev’t
 = 
__evt
;

135 
ty³
 = (
ev’t
[1] >> 
EVENT_TYPE_SHIFT
è& 
EVENT_TYPE_MASK
;

136 
devid
 = (
ev’t
[0] >> 
EVENT_DEVID_SHIFT
è& 
EVENT_DEVID_MASK
;

137 
domid
 = (
ev’t
[1] >> 
EVENT_DOMID_SHIFT
è& 
EVENT_DOMID_MASK
;

138 
æags
 = (
ev’t
[1] >> 
EVENT_FLAGS_SHIFT
è& 
EVENT_FLAGS_MASK
;

139 
u64
 
add»ss
 = (u64)(((u64)
ev’t
[3]) << 32) |ƒvent[2];

141 
	`´štk
(
KERN_ERR
 "AMD IOMMU: Event†ogged [");

143 
ty³
) {

144 
EVENT_TYPE_ILL_DEV
:

145 
	`´štk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

147 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

148 
add»ss
, 
æags
);

150 
EVENT_TYPE_IO_FAULT
:

151 
	`´štk
("IO_PAGE_FAULT device=%02x:%02x.%x "

153 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

154 
domid
, 
add»ss
, 
æags
);

156 
EVENT_TYPE_DEV_TAB_ERR
:

157 
	`´štk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

159 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

160 
add»ss
, 
æags
);

162 
EVENT_TYPE_PAGE_TAB_ERR
:

163 
	`´štk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

165 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

166 
domid
, 
add»ss
, 
æags
);

168 
EVENT_TYPE_ILL_CMD
:

169 
	`´štk
("ILLEGAL_COMMAND_ERROR‡dd»ss=0x%016Îx]\n", 
add»ss
);

171 
EVENT_TYPE_CMD_HARD_ERR
:

172 
	`´štk
("COMMAND_HARDWARE_ERROR‡ddress=0x%016llx "

173 "æags=0x%04x]\n", 
add»ss
, 
æags
);

175 
EVENT_TYPE_IOTLB_INV_TO
:

176 
	`´štk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

178 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

179 
add»ss
);

181 
EVENT_TYPE_INV_DEV_REQ
:

182 
	`´štk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

184 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

185 
add»ss
, 
æags
);

188 
	`´štk
(
KERN_ERR
 "UNKNOWNy³=0x%02x]\n", 
ty³
);

190 
	}
}

192 
	$iommu_pŞl_ev’ts
(
amd_iommu
 *
iommu
)

194 
u32
 
h—d
, 

;

195 
æags
;

197 
	`¥š_lock_œq§ve
(&
iommu
->
lock
, 
æags
);

199 
h—d
 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

200 

 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

202 
h—d
 !ğ

) {

203 
	`iommu_´št_ev’t
(
iommu
->
evt_buf
 + 
h—d
);

204 
h—d
 = (h—d + 
EVENT_ENTRY_SIZE
è% 
iommu
->
evt_buf_size
;

207 
	`wr™–
(
h—d
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

209 
	`¥š_uÆock_œq»¡Üe
(&
iommu
->
lock
, 
æags
);

210 
	}
}

212 
œq»tuº_t
 
	$amd_iommu_št_hªdËr
(
œq
, *
d©a
)

214 
amd_iommu
 *
iommu
;

216 
	`li¡_fÜ_—ch_’Œy
(
iommu
, &
amd_iommu_li¡
, 
li¡
)

217 
	`iommu_pŞl_ev’ts
(
iommu
);

219  
IRQ_HANDLED
;

220 
	}
}

232 
	$__iommu_queue_commªd
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

234 
u32
 

, 
h—d
;

235 
u8
 *
rg‘
;

237 

 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

238 
rg‘
 = 
iommu
->
cmd_buf
 + 

;

239 
	`memıy_toio
(
rg‘
, 
cmd
, (*cmd));

240 

 = ( + (*
cmd
)è% 
iommu
->
cmd_buf_size
;

241 
h—d
 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

242 ià(

 =ğ
h—d
)

243  -
ENOMEM
;

244 
	`wr™–
(

, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

247 
	}
}

253 
	$iommu_queue_commªd
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

255 
æags
;

256 
»t
;

258 
	`¥š_lock_œq§ve
(&
iommu
->
lock
, 
æags
);

259 
»t
 = 
	`__iommu_queue_commªd
(
iommu
, 
cmd
);

260 ià(!
»t
)

261 
iommu
->
Ãed_sync
 = 
Œue
;

262 
	`¥š_uÆock_œq»¡Üe
(&
iommu
->
lock
, 
æags
);

264  
»t
;

265 
	}
}

271 
	$__iommu_wa™_fÜ_com¶‘iÚ
(
amd_iommu
 *
iommu
)

273 
»ady
 = 0;

274 
¡©us
 = 0;

275 
i
 = 0;

277 
	`INC_STATS_COUNTER
(
com¶_wa™
);

279 !
»ady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

280 ++
i
;

282 
¡©us
 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

283 
»ady
 = 
¡©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

287 
¡©us
 &ğ~
MMIO_STATUS_COM_WAIT_INT_MASK
;

288 
	`wr™–
(
¡©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

290 ià(
	`uÆik–y
(
i
 =ğ
EXIT_LOOP_COUNT
))

291 
	`·nic
("AMD IOMMU: Completion wait†oop failed\n");

292 
	}
}

298 
	$__iommu_com¶‘iÚ_wa™
(
amd_iommu
 *
iommu
)

300 
iommu_cmd
 
cmd
;

302 
	`mem£t
(&
cmd
, 0, (cmd));

303 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

304 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

306  
	`__iommu_queue_commªd
(
iommu
, &
cmd
);

307 
	}
}

316 
	$iommu_com¶‘iÚ_wa™
(
amd_iommu
 *
iommu
)

318 
»t
 = 0;

319 
æags
;

321 
	`¥š_lock_œq§ve
(&
iommu
->
lock
, 
æags
);

323 ià(!
iommu
->
Ãed_sync
)

324 
out
;

326 
»t
 = 
	`__iommu_com¶‘iÚ_wa™
(
iommu
);

328 
iommu
->
Ãed_sync
 = 
çl£
;

330 ià(
»t
)

331 
out
;

333 
	`__iommu_wa™_fÜ_com¶‘iÚ
(
iommu
);

335 
out
:

336 
	`¥š_uÆock_œq»¡Üe
(&
iommu
->
lock
, 
æags
);

339 
	}
}

344 
	$iommu_queue_šv_dev_’Œy
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

346 
iommu_cmd
 
cmd
;

347 
»t
;

349 
	`BUG_ON
(
iommu
 =ğ
NULL
);

351 
	`mem£t
(&
cmd
, 0, (cmd));

352 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

353 
cmd
.
d©a
[0] = 
devid
;

355 
»t
 = 
	`iommu_queue_commªd
(
iommu
, &
cmd
);

357  
»t
;

358 
	}
}

360 
	$__iommu_bud_šv_iommu_·ges
(
iommu_cmd
 *
cmd
, 
u64
 
add»ss
,

361 
u16
 
domid
, 
pde
, 
s
)

363 
	`mem£t
(
cmd
, 0, (*cmd));

364 
add»ss
 &ğ
PAGE_MASK
;

365 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

366 
cmd
->
d©a
[1] |ğ
domid
;

367 
cmd
->
d©a
[2] = 
	`low”_32_b™s
(
add»ss
);

368 
cmd
->
d©a
[3] = 
	`uµ”_32_b™s
(
add»ss
);

369 ià(
s
)

370 
cmd
->
d©a
[2] |ğ
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

371 ià(
pde
)

372 
cmd
->
d©a
[2] |ğ
CMD_INV_IOMMU_PAGES_PDE_MASK
;

373 
	}
}

378 
	$iommu_queue_šv_iommu_·ges
(
amd_iommu
 *
iommu
,

379 
u64
 
add»ss
, 
u16
 
domid
, 
pde
, 
s
)

381 
iommu_cmd
 
cmd
;

382 
»t
;

384 
	`__iommu_bud_šv_iommu_·ges
(&
cmd
, 
add»ss
, 
domid
, 
pde
, 
s
);

386 
»t
 = 
	`iommu_queue_commªd
(
iommu
, &
cmd
);

388  
»t
;

389 
	}
}

396 
	$iommu_æush_·ges
(
amd_iommu
 *
iommu
, 
u16
 
domid
,

397 
u64
 
add»ss
, 
size_t
 
size
)

399 
s
 = 0;

400 
·ges
 = 
	`iommu_num_·ges
(
add»ss
, 
size
, 
PAGE_SIZE
);

402 
add»ss
 &ğ
PAGE_MASK
;

404 ià(
·ges
 > 1) {

409 
add»ss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

410 
s
 = 1;

413 
	`iommu_queue_šv_iommu_·ges
(
iommu
, 
add»ss
, 
domid
, 0, 
s
);

416 
	}
}

419 
	$iommu_æush_b
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

421 
u64
 
add»ss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

423 
	`INC_STATS_COUNTER
(
domaš_æush_sšgË
);

425 
	`iommu_queue_šv_iommu_·ges
(
iommu
, 
add»ss
, 
domid
, 0, 1);

426 
	}
}

432 
	$iommu_æush_domaš
(
u16
 
domid
)

434 
æags
;

435 
amd_iommu
 *
iommu
;

436 
iommu_cmd
 
cmd
;

438 
	`INC_STATS_COUNTER
(
domaš_æush_®l
);

440 
	`__iommu_bud_šv_iommu_·ges
(&
cmd
, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
,

441 
domid
, 1, 1);

443 
	`li¡_fÜ_—ch_’Œy
(
iommu
, &
amd_iommu_li¡
, 
li¡
) {

444 
	`¥š_lock_œq§ve
(&
iommu
->
lock
, 
æags
);

445 
	`__iommu_queue_commªd
(
iommu
, &
cmd
);

446 
	`__iommu_com¶‘iÚ_wa™
(
iommu
);

447 
	`__iommu_wa™_fÜ_com¶‘iÚ
(
iommu
);

448 
	`¥š_uÆock_œq»¡Üe
(&
iommu
->
lock
, 
æags
);

450 
	}
}

466 
	$iommu_m­_·ge
(
´ÙeùiÚ_domaš
 *
dom
,

467 
bus_addr
,

468 
phys_addr
,

469 
´Ù
)

471 
u64
 
__±e
, *
±e
, *
·ge
;

473 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

474 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

477 ià(
bus_addr
 > 
IOMMU_MAP_SIZE_L3
 || !(
´Ù
 & 
IOMMU_PROT_MASK
))

478  -
EINVAL
;

480 
±e
 = &
dom
->
±_roÙ
[
	`IOMMU_PTE_L2_INDEX
(
bus_addr
)];

482 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

483 
·ge
 = (
u64
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

484 ià(!
·ge
)

485  -
ENOMEM
;

486 *
±e
 = 
	`IOMMU_L2_PDE
(
	`vœt_to_phys
(
·ge
));

489 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

490 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
bus_addr
)];

492 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

493 
·ge
 = (
u64
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

494 ià(!
·ge
)

495  -
ENOMEM
;

496 *
±e
 = 
	`IOMMU_L1_PDE
(
	`vœt_to_phys
(
·ge
));

499 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

500 
±e
 = &±e[
	`IOMMU_PTE_L0_INDEX
(
bus_addr
)];

502 ià(
	`IOMMU_PTE_PRESENT
(*
±e
))

503  -
EBUSY
;

505 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
;

506 ià(
´Ù
 & 
IOMMU_PROT_IR
)

507 
__±e
 |ğ
IOMMU_PTE_IR
;

508 ià(
´Ù
 & 
IOMMU_PROT_IW
)

509 
__±e
 |ğ
IOMMU_PTE_IW
;

511 *
±e
 = 
__±e
;

514 
	}
}

516 
	$iommu_unm­_·ge
(
´ÙeùiÚ_domaš
 *
dom
,

517 
bus_addr
)

519 
u64
 *
±e
;

521 
±e
 = &
dom
->
±_roÙ
[
	`IOMMU_PTE_L2_INDEX
(
bus_addr
)];

523 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
))

526 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

527 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
bus_addr
)];

529 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
))

532 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

533 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
bus_addr
)];

535 *
±e
 = 0;

536 
	}
}

542 
	$iommu_fÜ_un™y_m­
(
amd_iommu
 *
iommu
,

543 
un™y_m­_’Œy
 *
’Œy
)

545 
u16
 
bdf
, 
i
;

547 
i
 = 
’Œy
->
devid_¡¬t
; i <ğ’Œy->
devid_’d
; ++i) {

548 
bdf
 = 
amd_iommu_®Ÿs_bË
[
i
];

549 ià(
amd_iommu_¾ookup_bË
[
bdf
] =ğ
iommu
)

554 
	}
}

562 
	$iommu_š™_un™y_m­pšgs
(
amd_iommu
 *
iommu
)

564 
un™y_m­_’Œy
 *
’Œy
;

565 
»t
;

567 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
amd_iommu_un™y_m­
, 
li¡
) {

568 ià(!
	`iommu_fÜ_un™y_m­
(
iommu
, 
’Œy
))

570 
»t
 = 
	`dma_İs_un™y_m­
(
iommu
->
deçuÉ_dom
, 
’Œy
);

571 ià(
»t
)

572  
»t
;

576 
	}
}

582 
	$dma_İs_un™y_m­
(
dma_İs_domaš
 *
dma_dom
,

583 
un™y_m­_’Œy
 *
e
)

585 
u64
 
addr
;

586 
»t
;

588 
addr
 = 
e
->
add»ss_¡¬t
;‡dd¸<ƒ->
add»ss_’d
;

589 
addr
 +ğ
PAGE_SIZE
) {

590 
»t
 = 
	`iommu_m­_·ge
(&
dma_dom
->
domaš
, 
addr
,‡ddr, 
e
->
´Ù
);

591 ià(
»t
)

592  
»t
;

597 ià(
addr
 < 
dma_dom
->
­”tu»_size
)

598 
	`__£t_b™
(
addr
 >> 
PAGE_SHIFT
, 
dma_dom
->
b™m­
);

602 
	}
}

607 
	$š™_un™y_m­pšgs_fÜ_deviû
(
dma_İs_domaš
 *
dma_dom
,

608 
u16
 
devid
)

610 
un™y_m­_’Œy
 *
e
;

611 
»t
;

613 
	`li¡_fÜ_—ch_’Œy
(
e
, &
amd_iommu_un™y_m­
, 
li¡
) {

614 ià(!(
devid
 >ğ
e
->
devid_¡¬t
 && devid <ğe->
devid_’d
))

616 
»t
 = 
	`dma_İs_un™y_m­
(
dma_dom
, 
e
);

617 ià(
»t
)

618  
»t
;

622 
	}
}

639 
	$dma_İs_®loc_add»s£s
(
deviû
 *
dev
,

640 
dma_İs_domaš
 *
dom
,

641 
·ges
,

642 
®ign_mask
,

643 
u64
 
dma_mask
)

645 
lim™
;

646 
add»ss
;

647 
bound¬y_size
;

649 
bound¬y_size
 = 
	`ALIGN
(
	`dma_g‘_£g_bound¬y
(
dev
) + 1,

650 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

651 
lim™
 = 
	`iommu_deviû_max_šdex
(
dom
->
­”tu»_size
 >> 
PAGE_SHIFT
, 0,

652 
dma_mask
 >> 
PAGE_SHIFT
);

654 ià(
dom
->
Ãxt_b™
 >ğ
lim™
) {

655 
dom
->
Ãxt_b™
 = 0;

656 
dom
->
Ãed_æush
 = 
Œue
;

659 
add»ss
 = 
	`iommu_¬—_®loc
(
dom
->
b™m­
, 
lim™
, dom->
Ãxt_b™
, 
·ges
,

660 0 , 
bound¬y_size
, 
®ign_mask
);

661 ià(
add»ss
 == -1) {

662 
add»ss
 = 
	`iommu_¬—_®loc
(
dom
->
b™m­
, 
lim™
, 0, 
·ges
,

663 0, 
bound¬y_size
, 
®ign_mask
);

664 
dom
->
Ãed_æush
 = 
Œue
;

667 ià(
	`lik–y
(
add»ss
 != -1)) {

668 
dom
->
Ãxt_b™
 = 
add»ss
 + 
·ges
;

669 
add»ss
 <<ğ
PAGE_SHIFT
;

671 
add»ss
 = 
bad_dma_add»ss
;

673 
	`WARN_ON
((
add»ss
 + (
PAGE_SIZE
*
·ges
)è> 
dom
->
­”tu»_size
);

675  
add»ss
;

676 
	}
}

683 
	$dma_İs_ä“_add»s£s
(
dma_İs_domaš
 *
dom
,

684 
add»ss
,

685 
·ges
)

687 
add»ss
 >>ğ
PAGE_SHIFT
;

688 
	`iommu_¬—_ä“
(
dom
->
b™m­
, 
add»ss
, 
·ges
);

690 ià(
add»ss
 >ğ
dom
->
Ãxt_b™
)

691 
dom
->
Ãed_æush
 = 
Œue
;

692 
	}
}

704 
u16
 
	$domaš_id_®loc
()

706 
æags
;

707 
id
;

709 
	`wr™e_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

710 
id
 = 
	`fšd_fœ¡_z”o_b™
(
amd_iommu_pd_®loc_b™m­
, 
MAX_DOMAIN_ID
);

711 
	`BUG_ON
(
id
 == 0);

712 ià(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

713 
	`__£t_b™
(
id
, 
amd_iommu_pd_®loc_b™m­
);

715 
id
 = 0;

716 
	`wr™e_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

718  
id
;

719 
	}
}

721 
	$domaš_id_ä“
(
id
)

723 
æags
;

725 
	`wr™e_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

726 ià(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

727 
	`__ş—r_b™
(
id
, 
amd_iommu_pd_®loc_b™m­
);

728 
	`wr™e_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

729 
	}
}

735 
	$dma_İs_»£rve_add»s£s
(
dma_İs_domaš
 *
dom
,

736 
¡¬t_·ge
,

737 
·ges
)

739 
Ï¡_·ge
 = 
dom
->
­”tu»_size
 >> 
PAGE_SHIFT
;

741 ià(
¡¬t_·ge
 + 
·ges
 > 
Ï¡_·ge
)

742 
·ges
 = 
Ï¡_·ge
 - 
¡¬t_·ge
;

744 
	`iommu_¬—_»£rve
(
dom
->
b™m­
, 
¡¬t_·ge
, 
·ges
);

745 
	}
}

747 
	$ä“_·g‘abË
(
´ÙeùiÚ_domaš
 *
domaš
)

749 
i
, 
j
;

750 
u64
 *
p1
, *
p2
, *
p3
;

752 
p1
 = 
domaš
->
±_roÙ
;

754 ià(!
p1
)

757 
i
 = 0; i < 512; ++i) {

758 ià(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

761 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

762 
j
 = 0; j < 512; ++j) {

763 ià(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

765 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

766 
	`ä“_·ge
(()
p3
);

769 
	`ä“_·ge
(()
p2
);

772 
	`ä“_·ge
(()
p1
);

774 
domaš
->
±_roÙ
 = 
NULL
;

775 
	}
}

781 
	$dma_İs_domaš_ä“
(
dma_İs_domaš
 *
dom
)

783 ià(!
dom
)

786 
	`ä“_·g‘abË
(&
dom
->
domaš
);

788 
	`kä“
(
dom
->
±e_·ges
);

790 
	`kä“
(
dom
->
b™m­
);

792 
	`kä“
(
dom
);

793 
	}
}

800 
dma_İs_domaš
 *
	$dma_İs_domaš_®loc
(
amd_iommu
 *
iommu
,

801 
Üd”
)

803 
dma_İs_domaš
 *
dma_dom
;

804 
i
, 
num_±e_·ges
;

805 
u64
 *
l2_pde
;

806 
u64
 
add»ss
;

811 ià((
Üd”
 < 25) || (order > 30))

812  
NULL
;

814 
dma_dom
 = 
	`kz®loc
((
dma_İs_domaš
), 
GFP_KERNEL
);

815 ià(!
dma_dom
)

816  
NULL
;

818 
	`¥š_lock_š™
(&
dma_dom
->
domaš
.
lock
);

820 
dma_dom
->
domaš
.
id
 = 
	`domaš_id_®loc
();

821 ià(
dma_dom
->
domaš
.
id
 == 0)

822 
ä“_dma_dom
;

823 
dma_dom
->
domaš
.
mode
 = 
PAGE_MODE_3_LEVEL
;

824 
dma_dom
->
domaš
.
±_roÙ
 = (*)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

825 
dma_dom
->
domaš
.
æags
 = 
PD_DMA_OPS_MASK
;

826 
dma_dom
->
domaš
.
´iv
 = dma_dom;

827 ià(!
dma_dom
->
domaš
.
±_roÙ
)

828 
ä“_dma_dom
;

829 
dma_dom
->
­”tu»_size
 = (1ULL << 
Üd”
);

830 
dma_dom
->
b™m­
 = 
	`kz®loc
(dma_dom->
­”tu»_size
 / (
PAGE_SIZE
 * 8),

831 
GFP_KERNEL
);

832 ià(!
dma_dom
->
b™m­
)

833 
ä“_dma_dom
;

838 
dma_dom
->
b™m­
[0] = 1;

839 
dma_dom
->
Ãxt_b™
 = 0;

841 
dma_dom
->
Ãed_æush
 = 
çl£
;

842 
dma_dom
->
rg‘_dev
 = 0xffff;

845 ià(
iommu
->
exşusiÚ_¡¬t
 &&

846 
iommu
->
exşusiÚ_¡¬t
 < 
dma_dom
->
­”tu»_size
) {

847 
¡¬age
 = 
iommu
->
exşusiÚ_¡¬t
 >> 
PAGE_SHIFT
;

848 
·ges
 = 
	`iommu_num_·ges
(
iommu
->
exşusiÚ_¡¬t
,

849 
iommu
->
exşusiÚ_Ëngth
,

850 
PAGE_SIZE
);

851 
	`dma_İs_»£rve_add»s£s
(
dma_dom
, 
¡¬age
, 
·ges
);

859 
num_±e_·ges
 = 
dma_dom
->
­”tu»_size
 / (
PAGE_SIZE
 * 512);

860 
dma_dom
->
±e_·ges
 = 
	`kz®loc
(
num_±e_·ges
 * (*),

861 
GFP_KERNEL
);

862 ià(!
dma_dom
->
±e_·ges
)

863 
ä“_dma_dom
;

865 
l2_pde
 = (
u64
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

866 ià(
l2_pde
 =ğ
NULL
)

867 
ä“_dma_dom
;

869 
dma_dom
->
domaš
.
±_roÙ
[0] = 
	`IOMMU_L2_PDE
(
	`vœt_to_phys
(
l2_pde
));

871 
i
 = 0; i < 
num_±e_·ges
; ++i) {

872 
dma_dom
->
±e_·ges
[
i
] = (
u64
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

873 ià(!
dma_dom
->
±e_·ges
[
i
])

874 
ä“_dma_dom
;

875 
add»ss
 = 
	`vœt_to_phys
(
dma_dom
->
±e_·ges
[
i
]);

876 
l2_pde
[
i
] = 
	`IOMMU_L1_PDE
(
add»ss
);

879  
dma_dom
;

881 
ä“_dma_dom
:

882 
	`dma_İs_domaš_ä“
(
dma_dom
);

884  
NULL
;

885 
	}
}

891 
boŞ
 
	$dma_İs_domaš
(
´ÙeùiÚ_domaš
 *
domaš
)

893  
domaš
->
æags
 & 
PD_DMA_OPS_MASK
;

894 
	}
}

900 
´ÙeùiÚ_domaš
 *
	$domaš_fÜ_deviû
(
u16
 
devid
)

902 
´ÙeùiÚ_domaš
 *
dom
;

903 
æags
;

905 
	`»ad_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

906 
dom
 = 
amd_iommu_pd_bË
[
devid
];

907 
	`»ad_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

909  
dom
;

910 
	}
}

916 
	$©ch_deviû
(
amd_iommu
 *
iommu
,

917 
´ÙeùiÚ_domaš
 *
domaš
,

918 
u16
 
devid
)

920 
æags
;

921 
u64
 
±e_roÙ
 = 
	`vœt_to_phys
(
domaš
->
±_roÙ
);

923 
domaš
->
dev_út
 += 1;

925 
±e_roÙ
 |ğ(
domaš
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

926 << 
DEV_ENTRY_MODE_SHIFT
;

927 
±e_roÙ
 |ğ
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

929 
	`wr™e_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

930 
amd_iommu_dev_bË
[
devid
].
d©a
[0] = 
	`low”_32_b™s
(
±e_roÙ
);

931 
amd_iommu_dev_bË
[
devid
].
d©a
[1] = 
	`uµ”_32_b™s
(
±e_roÙ
);

932 
amd_iommu_dev_bË
[
devid
].
d©a
[2] = 
domaš
->
id
;

934 
amd_iommu_pd_bË
[
devid
] = 
domaš
;

935 
	`wr™e_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

937 
	`iommu_queue_šv_dev_’Œy
(
iommu
, 
devid
);

938 
	}
}

943 
	$__d‘ach_deviû
(
´ÙeùiÚ_domaš
 *
domaš
, 
u16
 
devid
)

947 
	`¥š_lock
(&
domaš
->
lock
);

950 
amd_iommu_pd_bË
[
devid
] = 
NULL
;

953 
amd_iommu_dev_bË
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

954 
amd_iommu_dev_bË
[
devid
].
d©a
[1] = 0;

955 
amd_iommu_dev_bË
[
devid
].
d©a
[2] = 0;

958 
domaš
->
dev_út
 -= 1;

961 
	`¥š_uÆock
(&
domaš
->
lock
);

962 
	}
}

967 
	$d‘ach_deviû
(
´ÙeùiÚ_domaš
 *
domaš
, 
u16
 
devid
)

969 
æags
;

972 
	`wr™e_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

973 
	`__d‘ach_deviû
(
domaš
, 
devid
);

974 
	`wr™e_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

975 
	}
}

977 
	$deviû_chªge_nÙif›r
(
nÙif›r_block
 *
nb
,

978 
aùiÚ
, *
d©a
)

980 
deviû
 *
dev
 = 
d©a
;

981 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

982 
u16
 
devid
 = 
	`ÿlc_devid
(
pdev
->
bus
->
numb”
,…dev->
devâ
);

983 
´ÙeùiÚ_domaš
 *
domaš
;

984 
dma_İs_domaš
 *
dma_domaš
;

985 
amd_iommu
 *
iommu
;

986 
Üd”
 = 
amd_iommu_­”tu»_Üd”
;

987 
æags
;

989 ià(
devid
 > 
amd_iommu_Ï¡_bdf
)

990 
out
;

992 
devid
 = 
amd_iommu_®Ÿs_bË
[devid];

994 
iommu
 = 
amd_iommu_¾ookup_bË
[
devid
];

995 ià(
iommu
 =ğ
NULL
)

996 
out
;

998 
domaš
 = 
	`domaš_fÜ_deviû
(
devid
);

1000 ià(
domaš
 && !
	`dma_İs_domaš
(domain))

1001 
	`WARN_ONCE
(1, "AMD IOMMU WARNING: device %s‡lready bound "

1002 "tØ¨nÚ-dma-İ domaš\n", 
	`dev_Çme
(
dev
));

1004 
aùiÚ
) {

1005 
BUS_NOTIFY_BOUND_DRIVER
:

1006 ià(
domaš
)

1007 
out
;

1008 
dma_domaš
 = 
	`fšd_´ÙeùiÚ_domaš
(
devid
);

1009 ià(!
dma_domaš
)

1010 
dma_domaš
 = 
iommu
->
deçuÉ_dom
;

1011 
	`©ch_deviû
(
iommu
, &
dma_domaš
->
domaš
, 
devid
);

1012 
	`´štk
(
KERN_INFO
 "AMD IOMMU: Using…rotection domain %d for "

1013 "deviû %s\n", 
dma_domaš
->
domaš
.
id
, 
	`dev_Çme
(
dev
));

1015 
BUS_NOTIFY_UNBIND_DRIVER
:

1016 ià(!
domaš
)

1017 
out
;

1018 
	`d‘ach_deviû
(
domaš
, 
devid
);

1020 
BUS_NOTIFY_ADD_DEVICE
:

1022 
dma_domaš
 = 
	`fšd_´ÙeùiÚ_domaš
(
devid
);

1023 ià(
dma_domaš
)

1024 
out
;

1025 
dma_domaš
 = 
	`dma_İs_domaš_®loc
(
iommu
, 
Üd”
);

1026 ià(!
dma_domaš
)

1027 
out
;

1028 
dma_domaš
->
rg‘_dev
 = 
devid
;

1030 
	`¥š_lock_œq§ve
(&
iommu_pd_li¡_lock
, 
æags
);

1031 
	`li¡_add_
(&
dma_domaš
->
li¡
, &
iommu_pd_li¡
);

1032 
	`¥š_uÆock_œq»¡Üe
(&
iommu_pd_li¡_lock
, 
æags
);

1036 
out
;

1039 
	`iommu_queue_šv_dev_’Œy
(
iommu
, 
devid
);

1040 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1042 
out
:

1044 
	}
}

1046 
nÙif›r_block
 
	gdeviû_nb
 = {

1047 .
nÙif›r_ÿÎ
 = 
deviû_chªge_nÙif›r
,

1060 
boŞ
 
	$check_deviû
(
deviû
 *
dev
)

1062 ià(!
dev
 || !dev->
dma_mask
)

1063  
çl£
;

1065  
Œue
;

1066 
	}
}

1072 
dma_İs_domaš
 *
	$fšd_´ÙeùiÚ_domaš
(
u16
 
devid
)

1074 
dma_İs_domaš
 *
’Œy
, *
»t
 = 
NULL
;

1075 
æags
;

1077 ià(
	`li¡_em±y
(&
iommu_pd_li¡
))

1078  
NULL
;

1080 
	`¥š_lock_œq§ve
(&
iommu_pd_li¡_lock
, 
æags
);

1082 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
iommu_pd_li¡
, 
li¡
) {

1083 ià(
’Œy
->
rg‘_dev
 =ğ
devid
) {

1084 
»t
 = 
’Œy
;

1089 
	`¥š_uÆock_œq»¡Üe
(&
iommu_pd_li¡_lock
, 
æags
);

1091  
»t
;

1092 
	}
}

1101 
	$g‘_deviû_»sourûs
(
deviû
 *
dev
,

1102 
amd_iommu
 **
iommu
,

1103 
´ÙeùiÚ_domaš
 **
domaš
,

1104 
u16
 *
bdf
)

1106 
dma_İs_domaš
 *
dma_dom
;

1107 
pci_dev
 *
pcidev
;

1108 
u16
 
_bdf
;

1110 *
iommu
 = 
NULL
;

1111 *
domaš
 = 
NULL
;

1112 *
bdf
 = 0xffff;

1114 ià(
dev
->
bus
 !ğ&
pci_bus_ty³
)

1117 
pcidev
 = 
	`to_pci_dev
(
dev
);

1118 
_bdf
 = 
	`ÿlc_devid
(
pcidev
->
bus
->
numb”
,…cidev->
devâ
);

1121 ià(
_bdf
 > 
amd_iommu_Ï¡_bdf
)

1124 *
bdf
 = 
amd_iommu_®Ÿs_bË
[
_bdf
];

1126 *
iommu
 = 
amd_iommu_¾ookup_bË
[*
bdf
];

1127 ià(*
iommu
 =ğ
NULL
)

1129 *
domaš
 = 
	`domaš_fÜ_deviû
(*
bdf
);

1130 ià(*
domaš
 =ğ
NULL
) {

1131 
dma_dom
 = 
	`fšd_´ÙeùiÚ_domaš
(*
bdf
);

1132 ià(!
dma_dom
)

1133 
dma_dom
 = (*
iommu
)->
deçuÉ_dom
;

1134 *
domaš
 = &
dma_dom
->domain;

1135 
	`©ch_deviû
(*
iommu
, *
domaš
, *
bdf
);

1136 
	`´štk
(
KERN_INFO
 "AMD IOMMU: Using…rotection domain %d for "

1137 "deviû %s\n", (*
domaš
)->
id
, 
	`dev_Çme
(
dev
));

1140 ià(
	`domaš_fÜ_deviû
(
_bdf
è=ğ
NULL
)

1141 
	`©ch_deviû
(*
iommu
, *
domaš
, 
_bdf
);

1144 
	}
}

1150 
dma_addr_t
 
	$dma_İs_domaš_m­
(
amd_iommu
 *
iommu
,

1151 
dma_İs_domaš
 *
dom
,

1152 
add»ss
,

1153 
phys_addr_t
 
·ddr
,

1154 
dœeùiÚ
)

1156 
u64
 *
±e
, 
__±e
;

1158 
	`WARN_ON
(
add»ss
 > 
dom
->
­”tu»_size
);

1160 
·ddr
 &ğ
PAGE_MASK
;

1162 
±e
 = 
dom
->
±e_·ges
[
	`IOMMU_PTE_L1_INDEX
(
add»ss
)];

1163 
±e
 +ğ
	`IOMMU_PTE_L0_INDEX
(
add»ss
);

1165 
__±e
 = 
·ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1167 ià(
dœeùiÚ
 =ğ
DMA_TO_DEVICE
)

1168 
__±e
 |ğ
IOMMU_PTE_IR
;

1169 ià(
dœeùiÚ
 =ğ
DMA_FROM_DEVICE
)

1170 
__±e
 |ğ
IOMMU_PTE_IW
;

1171 ià(
dœeùiÚ
 =ğ
DMA_BIDIRECTIONAL
)

1172 
__±e
 |ğ
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1174 
	`WARN_ON
(*
±e
);

1176 *
±e
 = 
__±e
;

1178  (
dma_addr_t
)
add»ss
;

1179 
	}
}

1184 
	$dma_İs_domaš_unm­
(
amd_iommu
 *
iommu
,

1185 
dma_İs_domaš
 *
dom
,

1186 
add»ss
)

1188 
u64
 *
±e
;

1190 ià(
add»ss
 >ğ
dom
->
­”tu»_size
)

1193 
	`WARN_ON
(
add»ss
 & ~
PAGE_MASK
 ||‡dd»s >ğ
dom
->
­”tu»_size
);

1195 
±e
 = 
dom
->
±e_·ges
[
	`IOMMU_PTE_L1_INDEX
(
add»ss
)];

1196 
±e
 +ğ
	`IOMMU_PTE_L0_INDEX
(
add»ss
);

1198 
	`WARN_ON
(!*
±e
);

1200 *
±e
 = 0ULL;

1201 
	}
}

1209 
dma_addr_t
 
	$__m­_sšgË
(
deviû
 *
dev
,

1210 
amd_iommu
 *
iommu
,

1211 
dma_İs_domaš
 *
dma_dom
,

1212 
phys_addr_t
 
·ddr
,

1213 
size_t
 
size
,

1214 
dœ
,

1215 
boŞ
 
®ign
,

1216 
u64
 
dma_mask
)

1218 
dma_addr_t
 
off£t
 = 
·ddr
 & ~
PAGE_MASK
;

1219 
dma_addr_t
 
add»ss
, 
¡¬t
;

1220 
·ges
;

1221 
®ign_mask
 = 0;

1222 
i
;

1224 
·ges
 = 
	`iommu_num_·ges
(
·ddr
, 
size
, 
PAGE_SIZE
);

1225 
·ddr
 &ğ
PAGE_MASK
;

1227 
	`INC_STATS_COUNTER
(
tÙ®_m­_»que¡s
);

1229 ià(
·ges
 > 1)

1230 
	`INC_STATS_COUNTER
(
üoss_·ge
);

1232 ià(
®ign
)

1233 
®ign_mask
 = (1UL << 
	`g‘_Üd”
(
size
)) - 1;

1235 
add»ss
 = 
	`dma_İs_®loc_add»s£s
(
dev
, 
dma_dom
, 
·ges
, 
®ign_mask
,

1236 
dma_mask
);

1237 ià(
	`uÆik–y
(
add»ss
 =ğ
bad_dma_add»ss
))

1238 
out
;

1240 
¡¬t
 = 
add»ss
;

1241 
i
 = 0; i < 
·ges
; ++i) {

1242 
	`dma_İs_domaš_m­
(
iommu
, 
dma_dom
, 
¡¬t
, 
·ddr
, 
dœ
);

1243 
·ddr
 +ğ
PAGE_SIZE
;

1244 
¡¬t
 +ğ
PAGE_SIZE
;

1246 
add»ss
 +ğ
off£t
;

1248 
	`ADD_STATS_COUNTER
(
®loûd_io_mem
, 
size
);

1250 ià(
	`uÆik–y
(
dma_dom
->
Ãed_æush
 && !
amd_iommu_unm­_æush
)) {

1251 
	`iommu_æush_b
(
iommu
, 
dma_dom
->
domaš
.
id
);

1252 
dma_dom
->
Ãed_æush
 = 
çl£
;

1253 } ià(
	`uÆik–y
(
	`iommu_has_Åÿche
(
iommu
)))

1254 
	`iommu_æush_·ges
(
iommu
, 
dma_dom
->
domaš
.
id
, 
add»ss
, 
size
);

1256 
out
:

1257  
add»ss
;

1258 
	}
}

1264 
	$__unm­_sšgË
(
amd_iommu
 *
iommu
,

1265 
dma_İs_domaš
 *
dma_dom
,

1266 
dma_addr_t
 
dma_addr
,

1267 
size_t
 
size
,

1268 
dœ
)

1270 
dma_addr_t
 
i
, 
¡¬t
;

1271 
·ges
;

1273 ià((
dma_addr
 =ğ
bad_dma_add»ss
) ||

1274 (
dma_addr
 + 
size
 > 
dma_dom
->
­”tu»_size
))

1277 
·ges
 = 
	`iommu_num_·ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1278 
dma_addr
 &ğ
PAGE_MASK
;

1279 
¡¬t
 = 
dma_addr
;

1281 
i
 = 0; i < 
·ges
; ++i) {

1282 
	`dma_İs_domaš_unm­
(
iommu
, 
dma_dom
, 
¡¬t
);

1283 
¡¬t
 +ğ
PAGE_SIZE
;

1286 
	`SUB_STATS_COUNTER
(
®loûd_io_mem
, 
size
);

1288 
	`dma_İs_ä“_add»s£s
(
dma_dom
, 
dma_addr
, 
·ges
);

1290 ià(
amd_iommu_unm­_æush
 || 
dma_dom
->
Ãed_æush
) {

1291 
	`iommu_æush_·ges
(
iommu
, 
dma_dom
->
domaš
.
id
, 
dma_addr
, 
size
);

1292 
dma_dom
->
Ãed_æush
 = 
çl£
;

1294 
	}
}

1299 
dma_addr_t
 
	$m­_·ge
(
deviû
 *
dev
, 
·ge
 *page,

1300 
off£t
, 
size_t
 
size
,

1301 
dma_d©a_dœeùiÚ
 
dœ
,

1302 
dma_©Œs
 *
©Œs
)

1304 
æags
;

1305 
amd_iommu
 *
iommu
;

1306 
´ÙeùiÚ_domaš
 *
domaš
;

1307 
u16
 
devid
;

1308 
dma_addr_t
 
addr
;

1309 
u64
 
dma_mask
;

1310 
phys_addr_t
 
·ddr
 = 
	`·ge_to_phys
(
·ge
è+ 
off£t
;

1312 
	`INC_STATS_COUNTER
(
út_m­_sšgË
);

1314 ià(!
	`check_deviû
(
dev
))

1315  
bad_dma_add»ss
;

1317 
dma_mask
 = *
dev
->dma_mask;

1319 
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
);

1321 ià(
iommu
 =ğ
NULL
 || 
domaš
 == NULL)

1323  (
dma_addr_t
)
·ddr
;

1325 ià(!
	`dma_İs_domaš
(
domaš
))

1326  
bad_dma_add»ss
;

1328 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1329 
addr
 = 
	`__m­_sšgË
(
dev
, 
iommu
, 
domaš
->
´iv
, 
·ddr
, 
size
, 
dœ
, 
çl£
,

1330 
dma_mask
);

1331 ià(
addr
 =ğ
bad_dma_add»ss
)

1332 
out
;

1334 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1336 
out
:

1337 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1339  
addr
;

1340 
	}
}

1345 
	$unm­_·ge
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

1346 
dma_d©a_dœeùiÚ
 
dœ
, 
dma_©Œs
 *
©Œs
)

1348 
æags
;

1349 
amd_iommu
 *
iommu
;

1350 
´ÙeùiÚ_domaš
 *
domaš
;

1351 
u16
 
devid
;

1353 
	`INC_STATS_COUNTER
(
út_unm­_sšgË
);

1355 ià(!
	`check_deviû
(
dev
) ||

1356 !
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
))

1360 ià(!
	`dma_İs_domaš
(
domaš
))

1363 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1365 
	`__unm­_sšgË
(
iommu
, 
domaš
->
´iv
, 
dma_addr
, 
size
, 
dœ
);

1367 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1369 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1370 
	}
}

1376 
	$m­_sg_no_iommu
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sgli¡
,

1377 
ÃËms
, 
dœ
)

1379 
sÿ‰”li¡
 *
s
;

1380 
i
;

1382 
	`fÜ_—ch_sg
(
sgli¡
, 
s
, 
ÃËms
, 
i
) {

1383 
s
->
dma_add»ss
 = (
dma_addr_t
)
	`sg_phys
(s);

1384 
s
->
dma_Ëngth
 = s->
Ëngth
;

1387  
ÃËms
;

1388 
	}
}

1394 
	$m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sgli¡
,

1395 
ÃËms
, 
dma_d©a_dœeùiÚ
 
dœ
,

1396 
dma_©Œs
 *
©Œs
)

1398 
æags
;

1399 
amd_iommu
 *
iommu
;

1400 
´ÙeùiÚ_domaš
 *
domaš
;

1401 
u16
 
devid
;

1402 
i
;

1403 
sÿ‰”li¡
 *
s
;

1404 
phys_addr_t
 
·ddr
;

1405 
m­³d_–ems
 = 0;

1406 
u64
 
dma_mask
;

1408 
	`INC_STATS_COUNTER
(
út_m­_sg
);

1410 ià(!
	`check_deviû
(
dev
))

1413 
dma_mask
 = *
dev
->dma_mask;

1415 
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
);

1417 ià(!
iommu
 || !
domaš
)

1418  
	`m­_sg_no_iommu
(
dev
, 
sgli¡
, 
ÃËms
, 
dœ
);

1420 ià(!
	`dma_İs_domaš
(
domaš
))

1423 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1425 
	`fÜ_—ch_sg
(
sgli¡
, 
s
, 
ÃËms
, 
i
) {

1426 
·ddr
 = 
	`sg_phys
(
s
);

1428 
s
->
dma_add»ss
 = 
	`__m­_sšgË
(
dev
, 
iommu
, 
domaš
->
´iv
,

1429 
·ddr
, 
s
->
Ëngth
, 
dœ
, 
çl£
,

1430 
dma_mask
);

1432 ià(
s
->
dma_add»ss
) {

1433 
s
->
dma_Ëngth
 = s->
Ëngth
;

1434 
m­³d_–ems
++;

1436 
unm­
;

1439 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1441 
out
:

1442 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1444  
m­³d_–ems
;

1445 
unm­
:

1446 
	`fÜ_—ch_sg
(
sgli¡
, 
s
, 
m­³d_–ems
, 
i
) {

1447 ià(
s
->
dma_add»ss
)

1448 
	`__unm­_sšgË
(
iommu
, 
domaš
->
´iv
, 
s
->
dma_add»ss
,

1449 
s
->
dma_Ëngth
, 
dœ
);

1450 
s
->
dma_add»ss
 = s->
dma_Ëngth
 = 0;

1453 
m­³d_–ems
 = 0;

1455 
out
;

1456 
	}
}

1462 
	$unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sgli¡
,

1463 
ÃËms
, 
dma_d©a_dœeùiÚ
 
dœ
,

1464 
dma_©Œs
 *
©Œs
)

1466 
æags
;

1467 
amd_iommu
 *
iommu
;

1468 
´ÙeùiÚ_domaš
 *
domaš
;

1469 
sÿ‰”li¡
 *
s
;

1470 
u16
 
devid
;

1471 
i
;

1473 
	`INC_STATS_COUNTER
(
út_unm­_sg
);

1475 ià(!
	`check_deviû
(
dev
) ||

1476 !
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
))

1479 ià(!
	`dma_İs_domaš
(
domaš
))

1482 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1484 
	`fÜ_—ch_sg
(
sgli¡
, 
s
, 
ÃËms
, 
i
) {

1485 
	`__unm­_sšgË
(
iommu
, 
domaš
->
´iv
, 
s
->
dma_add»ss
,

1486 
s
->
dma_Ëngth
, 
dœ
);

1487 
s
->
dma_add»ss
 = s->
dma_Ëngth
 = 0;

1490 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1492 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1493 
	}
}

1498 *
	$®loc_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

1499 
dma_addr_t
 *
dma_addr
, 
gå_t
 
æag
)

1501 
æags
;

1502 *
vœt_addr
;

1503 
amd_iommu
 *
iommu
;

1504 
´ÙeùiÚ_domaš
 *
domaš
;

1505 
u16
 
devid
;

1506 
phys_addr_t
 
·ddr
;

1507 
u64
 
dma_mask
 = 
dev
->
coh”’t_dma_mask
;

1509 
	`INC_STATS_COUNTER
(
út_®loc_coh”’t
);

1511 ià(!
	`check_deviû
(
dev
))

1512  
NULL
;

1514 ià(!
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
))

1515 
æag
 &ğ~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

1517 
æag
 |ğ
__GFP_ZERO
;

1518 
vœt_addr
 = (*)
	`__g‘_ä“_·ges
(
æag
, 
	`g‘_Üd”
(
size
));

1519 ià(!
vœt_addr
)

1522 
·ddr
 = 
	`vœt_to_phys
(
vœt_addr
);

1524 ià(!
iommu
 || !
domaš
) {

1525 *
dma_addr
 = (
dma_addr_t
)
·ddr
;

1526  
vœt_addr
;

1529 ià(!
	`dma_İs_domaš
(
domaš
))

1530 
out_ä“
;

1532 ià(!
dma_mask
)

1533 
dma_mask
 = *
dev
->dma_mask;

1535 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1537 *
dma_addr
 = 
	`__m­_sšgË
(
dev
, 
iommu
, 
domaš
->
´iv
, 
·ddr
,

1538 
size
, 
DMA_BIDIRECTIONAL
, 
Œue
, 
dma_mask
);

1540 ià(*
dma_addr
 =ğ
bad_dma_add»ss
)

1541 
out_ä“
;

1543 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1545 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1547  
vœt_addr
;

1549 
out_ä“
:

1551 
	`ä“_·ges
(()
vœt_addr
, 
	`g‘_Üd”
(
size
));

1553  
NULL
;

1554 
	}
}

1559 
	$ä“_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

1560 *
vœt_addr
, 
dma_addr_t
 
dma_addr
)

1562 
æags
;

1563 
amd_iommu
 *
iommu
;

1564 
´ÙeùiÚ_domaš
 *
domaš
;

1565 
u16
 
devid
;

1567 
	`INC_STATS_COUNTER
(
út_ä“_coh”’t
);

1569 ià(!
	`check_deviû
(
dev
))

1572 
	`g‘_deviû_»sourûs
(
dev
, &
iommu
, &
domaš
, &
devid
);

1574 ià(!
iommu
 || !
domaš
)

1575 
ä“_mem
;

1577 ià(!
	`dma_İs_domaš
(
domaš
))

1578 
ä“_mem
;

1580 
	`¥š_lock_œq§ve
(&
domaš
->
lock
, 
æags
);

1582 
	`__unm­_sšgË
(
iommu
, 
domaš
->
´iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

1584 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1586 
	`¥š_uÆock_œq»¡Üe
(&
domaš
->
lock
, 
æags
);

1588 
ä“_mem
:

1589 
	`ä“_·ges
(()
vœt_addr
, 
	`g‘_Üd”
(
size
));

1590 
	}
}

1596 
	$amd_iommu_dma_suµÜ‹d
(
deviû
 *
dev
, 
u64
 
mask
)

1598 
u16
 
bdf
;

1599 
pci_dev
 *
pcidev
;

1602 ià(!
dev
 || dev->
bus
 !ğ&
pci_bus_ty³
)

1605 
pcidev
 = 
	`to_pci_dev
(
dev
);

1607 
bdf
 = 
	`ÿlc_devid
(
pcidev
->
bus
->
numb”
,…cidev->
devâ
);

1610 ià(
bdf
 > 
amd_iommu_Ï¡_bdf
)

1614 
	}
}

1623 
	$´—Îoc_´ÙeùiÚ_domašs
()

1625 
pci_dev
 *
dev
 = 
NULL
;

1626 
dma_İs_domaš
 *
dma_dom
;

1627 
amd_iommu
 *
iommu
;

1628 
Üd”
 = 
amd_iommu_­”tu»_Üd”
;

1629 
u16
 
devid
;

1631 (
dev
 = 
	`pci_g‘_deviû
(
PCI_ANY_ID
, PCI_ANY_ID, dev)è!ğ
NULL
) {

1632 
devid
 = 
	`ÿlc_devid
(
dev
->
bus
->
numb”
, dev->
devâ
);

1633 ià(
devid
 > 
amd_iommu_Ï¡_bdf
)

1635 
devid
 = 
amd_iommu_®Ÿs_bË
[devid];

1636 ià(
	`domaš_fÜ_deviû
(
devid
))

1638 
iommu
 = 
amd_iommu_¾ookup_bË
[
devid
];

1639 ià(!
iommu
)

1641 
dma_dom
 = 
	`dma_İs_domaš_®loc
(
iommu
, 
Üd”
);

1642 ià(!
dma_dom
)

1644 
	`š™_un™y_m­pšgs_fÜ_deviû
(
dma_dom
, 
devid
);

1645 
dma_dom
->
rg‘_dev
 = 
devid
;

1647 
	`li¡_add_
(&
dma_dom
->
li¡
, &
iommu_pd_li¡
);

1649 
	}
}

1651 
dma_m­_İs
 
	gamd_iommu_dma_İs
 = {

1652 .
®loc_coh”’t
 =‡lloc_coherent,

1653 .
	gä“_coh”’t
 = 
ä“_coh”’t
,

1654 .
	gm­_·ge
 = 
m­_·ge
,

1655 .
	gunm­_·ge
 = 
unm­_·ge
,

1656 .
	gm­_sg
 = 
m­_sg
,

1657 .
	gunm­_sg
 = 
unm­_sg
,

1658 .
	gdma_suµÜ‹d
 = 
amd_iommu_dma_suµÜ‹d
,

1664 
__š™
 
	$amd_iommu_š™_dma_İs
()

1666 
amd_iommu
 *
iommu
;

1667 
Üd”
 = 
amd_iommu_­”tu»_Üd”
;

1668 
»t
;

1675 
	`li¡_fÜ_—ch_’Œy
(
iommu
, &
amd_iommu_li¡
, 
li¡
) {

1676 
iommu
->
deçuÉ_dom
 = 
	`dma_İs_domaš_®loc
(iommu, 
Üd”
);

1677 ià(
iommu
->
deçuÉ_dom
 =ğ
NULL
)

1678  -
ENOMEM
;

1679 
iommu
->
deçuÉ_dom
->
domaš
.
æags
 |ğ
PD_DEFAULT_MASK
;

1680 
»t
 = 
	`iommu_š™_un™y_m­pšgs
(
iommu
);

1681 ià(
»t
)

1682 
ä“_domašs
;

1689 ià(
amd_iommu_isŞ©e
)

1690 
	`´—Îoc_´ÙeùiÚ_domašs
();

1692 
iommu_d‘eùed
 = 1;

1693 
fÜû_iommu
 = 1;

1694 
bad_dma_add»ss
 = 0;

1695 #ifdeà
CONFIG_GART_IOMMU


1696 
g¬t_iommu_­”tu»_di§bËd
 = 1;

1697 
g¬t_iommu_­”tu»
 = 0;

1701 
dma_İs
 = &
amd_iommu_dma_İs
;

1703 
	`»gi¡”_iommu
(&
amd_iommu_İs
);

1705 
	`bus_»gi¡”_nÙif›r
(&
pci_bus_ty³
, &
deviû_nb
);

1707 
	`amd_iommu_¡©s_š™
();

1711 
ä“_domašs
:

1713 
	`li¡_fÜ_—ch_’Œy
(
iommu
, &
amd_iommu_li¡
, 
li¡
) {

1714 ià(
iommu
->
deçuÉ_dom
)

1715 
	`dma_İs_domaš_ä“
(
iommu
->
deçuÉ_dom
);

1718  
»t
;

1719 
	}
}

1731 
	$ş—nup_domaš
(
´ÙeùiÚ_domaš
 *
domaš
)

1733 
æags
;

1734 
u16
 
devid
;

1736 
	`wr™e_lock_œq§ve
(&
amd_iommu_devbË_lock
, 
æags
);

1738 
devid
 = 0; devid <ğ
amd_iommu_Ï¡_bdf
; ++devid)

1739 ià(
amd_iommu_pd_bË
[
devid
] =ğ
domaš
)

1740 
	`__d‘ach_deviû
(
domaš
, 
devid
);

1742 
	`wr™e_uÆock_œq»¡Üe
(&
amd_iommu_devbË_lock
, 
æags
);

1743 
	}
}

1745 
	$amd_iommu_domaš_š™
(
iommu_domaš
 *
dom
)

1747 
´ÙeùiÚ_domaš
 *
domaš
;

1749 
domaš
 = 
	`kz®loc
((*domaš), 
GFP_KERNEL
);

1750 ià(!
domaš
)

1751  -
ENOMEM
;

1753 
	`¥š_lock_š™
(&
domaš
->
lock
);

1754 
domaš
->
mode
 = 
PAGE_MODE_3_LEVEL
;

1755 
domaš
->
id
 = 
	`domaš_id_®loc
();

1756 ià(!
domaš
->
id
)

1757 
out_ä“
;

1758 
domaš
->
±_roÙ
 = (*)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

1759 ià(!
domaš
->
±_roÙ
)

1760 
out_ä“
;

1762 
dom
->
´iv
 = 
domaš
;

1766 
out_ä“
:

1767 
	`kä“
(
domaš
);

1769  -
ENOMEM
;

1770 
	}
}

1772 
	$amd_iommu_domaš_de¡roy
(
iommu_domaš
 *
dom
)

1774 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1776 ià(!
domaš
)

1779 ià(
domaš
->
dev_út
 > 0)

1780 
	`ş—nup_domaš
(
domaš
);

1782 
	`BUG_ON
(
domaš
->
dev_út
 != 0);

1784 
	`ä“_·g‘abË
(
domaš
);

1786 
	`domaš_id_ä“
(
domaš
->
id
);

1788 
	`kä“
(
domaš
);

1790 
dom
->
´iv
 = 
NULL
;

1791 
	}
}

1793 
	$amd_iommu_d‘ach_deviû
(
iommu_domaš
 *
dom
,

1794 
deviû
 *
dev
)

1796 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1797 
amd_iommu
 *
iommu
;

1798 
pci_dev
 *
pdev
;

1799 
u16
 
devid
;

1801 ià(
dev
->
bus
 !ğ&
pci_bus_ty³
)

1804 
pdev
 = 
	`to_pci_dev
(
dev
);

1806 
devid
 = 
	`ÿlc_devid
(
pdev
->
bus
->
numb”
,…dev->
devâ
);

1808 ià(
devid
 > 0)

1809 
	`d‘ach_deviû
(
domaš
, 
devid
);

1811 
iommu
 = 
amd_iommu_¾ookup_bË
[
devid
];

1812 ià(!
iommu
)

1815 
	`iommu_queue_šv_dev_’Œy
(
iommu
, 
devid
);

1816 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1817 
	}
}

1819 
	$amd_iommu_©ch_deviû
(
iommu_domaš
 *
dom
,

1820 
deviû
 *
dev
)

1822 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1823 
´ÙeùiÚ_domaš
 *
Şd_domaš
;

1824 
amd_iommu
 *
iommu
;

1825 
pci_dev
 *
pdev
;

1826 
u16
 
devid
;

1828 ià(
dev
->
bus
 !ğ&
pci_bus_ty³
)

1829  -
EINVAL
;

1831 
pdev
 = 
	`to_pci_dev
(
dev
);

1833 
devid
 = 
	`ÿlc_devid
(
pdev
->
bus
->
numb”
,…dev->
devâ
);

1835 ià(
devid
 >ğ
amd_iommu_Ï¡_bdf
 ||

1836 
devid
 !ğ
amd_iommu_®Ÿs_bË
[devid])

1837  -
EINVAL
;

1839 
iommu
 = 
amd_iommu_¾ookup_bË
[
devid
];

1840 ià(!
iommu
)

1841  -
EINVAL
;

1843 
Şd_domaš
 = 
	`domaš_fÜ_deviû
(
devid
);

1844 ià(
Şd_domaš
)

1845  -
EBUSY
;

1847 
	`©ch_deviû
(
iommu
, 
domaš
, 
devid
);

1849 
	`iommu_com¶‘iÚ_wa™
(
iommu
);

1852 
	}
}

1854 
	$amd_iommu_m­_¿nge
(
iommu_domaš
 *
dom
,

1855 
iova
, 
phys_addr_t
 
·ddr
,

1856 
size_t
 
size
, 
iommu_´Ù
)

1858 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1859 
i
, 
Åages
 = 
	`iommu_num_·ges
(
·ddr
, 
size
, 
PAGE_SIZE
);

1860 
´Ù
 = 0;

1861 
»t
;

1863 ià(
iommu_´Ù
 & 
IOMMU_READ
)

1864 
´Ù
 |ğ
IOMMU_PROT_IR
;

1865 ià(
iommu_´Ù
 & 
IOMMU_WRITE
)

1866 
´Ù
 |ğ
IOMMU_PROT_IW
;

1868 
iova
 &ğ
PAGE_MASK
;

1869 
·ddr
 &ğ
PAGE_MASK
;

1871 
i
 = 0; i < 
Åages
; ++i) {

1872 
»t
 = 
	`iommu_m­_·ge
(
domaš
, 
iova
, 
·ddr
, 
´Ù
);

1873 ià(
»t
)

1874  
»t
;

1876 
iova
 +ğ
PAGE_SIZE
;

1877 
·ddr
 +ğ
PAGE_SIZE
;

1881 
	}
}

1883 
	$amd_iommu_unm­_¿nge
(
iommu_domaš
 *
dom
,

1884 
iova
, 
size_t
 
size
)

1887 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1888 
i
, 
Åages
 = 
	`iommu_num_·ges
(
iova
, 
size
, 
PAGE_SIZE
);

1890 
iova
 &ğ
PAGE_MASK
;

1892 
i
 = 0; i < 
Åages
; ++i) {

1893 
	`iommu_unm­_·ge
(
domaš
, 
iova
);

1894 
iova
 +ğ
PAGE_SIZE
;

1897 
	`iommu_æush_domaš
(
domaš
->
id
);

1898 
	}
}

1900 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaš
 *
dom
,

1901 
iova
)

1903 
´ÙeùiÚ_domaš
 *
domaš
 = 
dom
->
´iv
;

1904 
off£t
 = 
iova
 & ~
PAGE_MASK
;

1905 
phys_addr_t
 
·ddr
;

1906 
u64
 *
±e
;

1908 
±e
 = &
domaš
->
±_roÙ
[
	`IOMMU_PTE_L2_INDEX
(
iova
)];

1910 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
))

1913 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

1914 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
iova
)];

1916 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
))

1919 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

1920 
±e
 = &±e[
	`IOMMU_PTE_L0_INDEX
(
iova
)];

1922 ià(!
	`IOMMU_PTE_PRESENT
(*
±e
))

1925 
·ddr
 = *
±e
 & 
IOMMU_PAGE_MASK
;

1926 
·ddr
 |ğ
off£t
;

1928  
·ddr
;

1929 
	}
}

1931 
	$amd_iommu_domaš_has_ÿp
(
iommu_domaš
 *
domaš
,

1932 
ÿp
)

1935 
	}
}

1937 
iommu_İs
 
	gamd_iommu_İs
 = {

1938 .
domaš_š™
 = 
amd_iommu_domaš_š™
,

1939 .
	gdomaš_de¡roy
 = 
amd_iommu_domaš_de¡roy
,

1940 .
	g©ch_dev
 = 
amd_iommu_©ch_deviû
,

1941 .
	gd‘ach_dev
 = 
amd_iommu_d‘ach_deviû
,

1942 .
	gm­
 = 
amd_iommu_m­_¿nge
,

1943 .
	gunm­
 = 
amd_iommu_unm­_¿nge
,

1944 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

1945 .
	gdomaš_has_ÿp
 = 
amd_iommu_domaš_has_ÿp
,

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<lšux/pci.h
>

21 
	~<lšux/aıi.h
>

22 
	~<lšux/gå.h
>

23 
	~<lšux/li¡.h
>

24 
	~<lšux/sysdev.h
>

25 
	~<lšux/š‹¼u±.h
>

26 
	~<lšux/msi.h
>

27 
	~<asm/pci-dœeù.h
>

28 
	~<asm/amd_iommu_ty³s.h
>

29 
	~<asm/amd_iommu.h
>

30 
	~<asm/iommu.h
>

31 
	~<asm/g¬t.h
>

36 
	#IVRS_HEADER_LENGTH
 48

	)

38 
	#ACPI_IVHD_TYPE
 0x10

	)

39 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

40 
	#ACPI_IVMD_TYPE
 0x21

	)

41 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

43 
	#IVHD_DEV_ALL
 0x01

	)

44 
	#IVHD_DEV_SELECT
 0x02

	)

45 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

46 
	#IVHD_DEV_RANGE_END
 0x04

	)

47 
	#IVHD_DEV_ALIAS
 0x42

	)

48 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

49 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

50 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

52 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

53 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

54 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

55 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

57 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

58 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

60 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

61 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

62 
	#ACPI_DEVFLAG_NMI
 0x04

	)

63 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

64 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

65 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

66 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

67 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

80 
	sivhd_h—d”
 {

81 
u8
 
	mty³
;

82 
u8
 
	mæags
;

83 
u16
 
	mËngth
;

84 
u16
 
	mdevid
;

85 
u16
 
	mÿp_±r
;

86 
u64
 
	mmmio_phys
;

87 
u16
 
	mpci_£g
;

88 
u16
 
	mšfo
;

89 
u32
 
	m»£rved
;

90 } 
__©Œibu‹__
((
·cked
));

96 
	sivhd_’Œy
 {

97 
u8
 
	mty³
;

98 
u16
 
	mdevid
;

99 
u8
 
	mæags
;

100 
u32
 
	mext
;

101 } 
__©Œibu‹__
((
·cked
));

107 
	sivmd_h—d”
 {

108 
u8
 
	mty³
;

109 
u8
 
	mæags
;

110 
u16
 
	mËngth
;

111 
u16
 
	mdevid
;

112 
u16
 
	maux
;

113 
u64
 
	m»sv
;

114 
u64
 
	m¿nge_¡¬t
;

115 
u64
 
	m¿nge_Ëngth
;

116 } 
__©Œibu‹__
((
·cked
));

118 
__š™d©a
 
	gamd_iommu_d‘eùed
;

120 
u16
 
	gamd_iommu_Ï¡_bdf
;

122 
LIST_HEAD
(
amd_iommu_un™y_m­
);

124 
	gamd_iommu_­”tu»_Üd”
 = 26;

125 
boŞ
 
	gamd_iommu_isŞ©e
 = 
Œue
;

127 
boŞ
 
	gamd_iommu_unm­_æush
;

129 
LIST_HEAD
(
amd_iommu_li¡
);

138 
dev_bË_’Œy
 *
	gamd_iommu_dev_bË
;

145 
u16
 *
	gamd_iommu_®Ÿs_bË
;

151 
amd_iommu
 **
	gamd_iommu_¾ookup_bË
;

157 
´ÙeùiÚ_domaš
 **
	gamd_iommu_pd_bË
;

163 *
	gamd_iommu_pd_®loc_b™m­
;

165 
u32
 
	gdev_bË_size
;

166 
u32
 
	g®Ÿs_bË_size
;

167 
u32
 
	g¾ookup_bË_size
;

169 
šlše
 
	$upd©e_Ï¡_devid
(
u16
 
devid
)

171 ià(
devid
 > 
amd_iommu_Ï¡_bdf
)

172 
amd_iommu_Ï¡_bdf
 = 
devid
;

173 
	}
}

175 
šlše
 
	$tbl_size
(
’Œy_size
)

177 
shiá
 = 
PAGE_SHIFT
 +

178 
	`g‘_Üd”
(
amd_iommu_Ï¡_bdf
 * 
’Œy_size
);

180  1UL << 
shiá
;

181 
	}
}

196 
__š™
 
	$iommu_£t_exşusiÚ_¿nge
(
amd_iommu
 *
iommu
)

198 
u64
 
¡¬t
 = 
iommu
->
exşusiÚ_¡¬t
 & 
PAGE_MASK
;

199 
u64
 
lim™
 = (
¡¬t
 + 
iommu
->
exşusiÚ_Ëngth
è& 
PAGE_MASK
;

200 
u64
 
’Œy
;

202 ià(!
iommu
->
exşusiÚ_¡¬t
)

205 
’Œy
 = 
¡¬t
 | 
MMIO_EXCL_ENABLE_MASK
;

206 
	`memıy_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

207 &
’Œy
, (entry));

209 
’Œy
 = 
lim™
;

210 
	`memıy_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

211 &
’Œy
, (entry));

212 
	}
}

215 
__š™
 
	$iommu_£t_deviû_bË
(
amd_iommu
 *
iommu
)

217 
u64
 
’Œy
;

219 
	`BUG_ON
(
iommu
->
mmio_ba£
 =ğ
NULL
);

221 
’Œy
 = 
	`vœt_to_phys
(
amd_iommu_dev_bË
);

222 
’Œy
 |ğ(
dev_bË_size
 >> 12) - 1;

223 
	`memıy_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

224 &
’Œy
, (entry));

225 
	}
}

228 
__š™
 
	$iommu_ã©u»_’abË
(
amd_iommu
 *
iommu
, 
u8
 
b™
)

230 
u32
 
ù¾
;

232 
ù¾
 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

233 
ù¾
 |ğ(1 << 
b™
);

234 
	`wr™–
(
ù¾
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

235 
	}
}

237 
__š™
 
	$iommu_ã©u»_di§bË
(
amd_iommu
 *
iommu
, 
u8
 
b™
)

239 
u32
 
ù¾
;

241 
ù¾
 = 
	`»adl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

242 
ù¾
 &ğ~(1 << 
b™
);

243 
	`wr™–
(
ù¾
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

244 
	}
}

247 
__š™
 
	$iommu_’abË
(
amd_iommu
 *
iommu
)

249 
	`´štk
(
KERN_INFO
 "AMD IOMMU: Enabling IOMMU‡t %s cap 0x%hx\n",

250 
	`dev_Çme
(&
iommu
->
dev
->dev), iommu->
ÿp_±r
);

252 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_IOMMU_EN
);

253 
	}
}

256 
__š™
 
	$iommu_’abË_ev’t_loggšg
(
amd_iommu
 *
iommu
)

258 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_EVT_LOG_EN
);

259 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_EVT_INT_EN
);

260 
	}
}

266 
u8
 * 
__š™
 
	$iommu_m­_mmio_¥aû
(
u64
 
add»ss
)

268 
u8
 *
»t
;

270 ià(!
	`»que¡_mem_»giÚ
(
add»ss
, 
MMIO_REGION_LENGTH
, "amd_iommu"))

271  
NULL
;

273 
»t
 = 
	`iÜem­_noÿche
(
add»ss
, 
MMIO_REGION_LENGTH
);

274 ià(
»t
 !ğ
NULL
)

275  
»t
;

277 
	`»Ëa£_mem_»giÚ
(
add»ss
, 
MMIO_REGION_LENGTH
);

279  
NULL
;

280 
	}
}

282 
__š™
 
	$iommu_unm­_mmio_¥aû
(
amd_iommu
 *
iommu
)

284 ià(
iommu
->
mmio_ba£
)

285 
	`iounm­
(
iommu
->
mmio_ba£
);

286 
	`»Ëa£_mem_»giÚ
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

287 
	}
}

301 
šlše
 
	$ivhd_’Œy_Ëngth
(
u8
 *
ivhd
)

303  0x04 << (*
ivhd
 >> 6);

304 
	}
}

310 
__š™
 
	$fšd_Ï¡_devid_Ú_pci
(
bus
, 
dev
, 
â
, 
ÿp_±r
)

312 
u32
 
ÿp
;

314 
ÿp
 = 
	`»ad_pci_cÚfig
(
bus
, 
dev
, 
â
, 
ÿp_±r
+
MMIO_RANGE_OFFSET
);

315 
	`upd©e_Ï¡_devid
(
	`ÿlc_devid
(
	`MMIO_GET_BUS
(
ÿp
), 
	`MMIO_GET_LD
(cap)));

318 
	}
}

324 
__š™
 
	$fšd_Ï¡_devid_äom_ivhd
(
ivhd_h—d”
 *
h
)

326 
u8
 *
p
 = (*)
h
, *
’d
 = (*)h;

327 
ivhd_’Œy
 *
dev
;

329 
p
 +ğ(*
h
);

330 
’d
 +ğ
h
->
Ëngth
;

332 
	`fšd_Ï¡_devid_Ú_pci
(
	`PCI_BUS
(
h
->
devid
),

333 
	`PCI_SLOT
(
h
->
devid
),

334 
	`PCI_FUNC
(
h
->
devid
),

335 
h
->
ÿp_±r
);

337 
p
 < 
’d
) {

338 
dev
 = (
ivhd_’Œy
 *)
p
;

339 
dev
->
ty³
) {

340 
IVHD_DEV_SELECT
:

341 
IVHD_DEV_RANGE_END
:

342 
IVHD_DEV_ALIAS
:

343 
IVHD_DEV_EXT_SELECT
:

345 
	`upd©e_Ï¡_devid
(
dev
->
devid
);

350 
p
 +ğ
	`ivhd_’Œy_Ëngth
(p);

353 
	`WARN_ON
(
p
 !ğ
’d
);

356 
	}
}

363 
__š™
 
	$fšd_Ï¡_devid_aıi
(
aıi_bË_h—d”
 *
bË
)

365 
i
;

366 
u8
 
checksum
 = 0, *
p
 = (u8 *)
bË
, *
’d
 = (u8 *)table;

367 
ivhd_h—d”
 *
h
;

373 
i
 = 0; i < 
bË
->
Ëngth
; ++i)

374 
checksum
 +ğ
p
[
i
];

375 ià(
checksum
 != 0)

377  -
ENODEV
;

379 
p
 +ğ
IVRS_HEADER_LENGTH
;

381 
’d
 +ğ
bË
->
Ëngth
;

382 
p
 < 
’d
) {

383 
h
 = (
ivhd_h—d”
 *)
p
;

384 
h
->
ty³
) {

385 
ACPI_IVHD_TYPE
:

386 
	`fšd_Ï¡_devid_äom_ivhd
(
h
);

391 
p
 +ğ
h
->
Ëngth
;

393 
	`WARN_ON
(
p
 !ğ
’d
);

396 
	}
}

412 
u8
 * 
__š™
 
	$®loc_commªd_bufãr
(
amd_iommu
 *
iommu
)

414 
u8
 *
cmd_buf
 = (u8 *)
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

415 
	`g‘_Üd”
(
CMD_BUFFER_SIZE
));

416 
u64
 
’Œy
;

418 ià(
cmd_buf
 =ğ
NULL
)

419  
NULL
;

421 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
;

423 
’Œy
 = (
u64
)
	`vœt_to_phys
(
cmd_buf
);

424 
’Œy
 |ğ
MMIO_CMD_SIZE_512
;

425 
	`memıy_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

426 &
’Œy
, (entry));

429 
	`wr™–
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

430 
	`wr™–
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

432 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_CMDBUF_EN
);

434  
cmd_buf
;

435 
	}
}

437 
__š™
 
	$ä“_commªd_bufãr
(
amd_iommu
 *
iommu
)

439 
	`ä“_·ges
(()
iommu
->
cmd_buf
,

440 
	`g‘_Üd”
(
iommu
->
cmd_buf_size
));

441 
	}
}

444 
u8
 * 
__š™
 
	$®loc_ev’t_bufãr
(
amd_iommu
 *
iommu
)

446 
u64
 
’Œy
;

447 
iommu
->
evt_buf
 = (
u8
 *)
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

448 
	`g‘_Üd”
(
EVT_BUFFER_SIZE
));

450 ià(
iommu
->
evt_buf
 =ğ
NULL
)

451  
NULL
;

453 
’Œy
 = (
u64
)
	`vœt_to_phys
(
iommu
->
evt_buf
è| 
EVT_LEN_MASK
;

454 
	`memıy_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

455 &
’Œy
, (entry));

457 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

459  
iommu
->
evt_buf
;

460 
	}
}

462 
__š™
 
	$ä“_ev’t_bufãr
(
amd_iommu
 *
iommu
)

464 
	`ä“_·ges
(()
iommu
->
evt_buf
, 
	`g‘_Üd”
(
EVT_BUFFER_SIZE
));

465 
	}
}

468 
	$£t_dev_’Œy_b™
(
u16
 
devid
, 
u8
 
b™
)

470 
i
 = (
b™
 >> 5) & 0x07;

471 
_b™
 = 
b™
 & 0x1f;

473 
amd_iommu_dev_bË
[
devid
].
d©a
[
i
] |ğ(1 << 
_b™
);

474 
	}
}

477 
__š™
 
	$£t_iommu_fÜ_deviû
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

479 
amd_iommu_¾ookup_bË
[
devid
] = 
iommu
;

480 
	}
}

486 
__š™
 
	$£t_dev_’Œy_äom_aıi
(
amd_iommu
 *
iommu
,

487 
u16
 
devid
, 
u32
 
æags
, u32 
ext_æags
)

489 ià(
æags
 & 
ACPI_DEVFLAG_INITPASS
)

490 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_INIT_PASS
);

491 ià(
æags
 & 
ACPI_DEVFLAG_EXTINT
)

492 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_EINT_PASS
);

493 ià(
æags
 & 
ACPI_DEVFLAG_NMI
)

494 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_NMI_PASS
);

495 ià(
æags
 & 
ACPI_DEVFLAG_SYSMGT1
)

496 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_SYSMGT1
);

497 ià(
æags
 & 
ACPI_DEVFLAG_SYSMGT2
)

498 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_SYSMGT2
);

499 ià(
æags
 & 
ACPI_DEVFLAG_LINT0
)

500 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

501 ià(
æags
 & 
ACPI_DEVFLAG_LINT1
)

502 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

504 
	`£t_iommu_fÜ_deviû
(
iommu
, 
devid
);

505 
	}
}

511 
__š™
 
	$£t_deviû_exşusiÚ_¿nge
(
u16
 
devid
, 
ivmd_h—d”
 *
m
)

513 
amd_iommu
 *
iommu
 = 
amd_iommu_¾ookup_bË
[
devid
];

515 ià(!(
m
->
æags
 & 
IVMD_FLAG_EXCL_RANGE
))

518 ià(
iommu
) {

524 
	`£t_dev_’Œy_b™
(
m
->
devid
, 
DEV_ENTRY_EX
);

525 
iommu
->
exşusiÚ_¡¬t
 = 
m
->
¿nge_¡¬t
;

526 
iommu
->
exşusiÚ_Ëngth
 = 
m
->
¿nge_Ëngth
;

528 
	}
}

535 
__š™
 
	$š™_iommu_äom_pci
(
amd_iommu
 *
iommu
)

537 
ÿp_±r
 = 
iommu
->cap_ptr;

538 
u32
 
¿nge
, 
misc
;

540 
	`pci_»ad_cÚfig_dwÜd
(
iommu
->
dev
, 
ÿp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

541 &
iommu
->
ÿp
);

542 
	`pci_»ad_cÚfig_dwÜd
(
iommu
->
dev
, 
ÿp_±r
 + 
MMIO_RANGE_OFFSET
,

543 &
¿nge
);

544 
	`pci_»ad_cÚfig_dwÜd
(
iommu
->
dev
, 
ÿp_±r
 + 
MMIO_MISC_OFFSET
,

545 &
misc
);

547 
iommu
->
fœ¡_deviû
 = 
	`ÿlc_devid
(
	`MMIO_GET_BUS
(
¿nge
),

548 
	`MMIO_GET_FD
(
¿nge
));

549 
iommu
->
Ï¡_deviû
 = 
	`ÿlc_devid
(
	`MMIO_GET_BUS
(
¿nge
),

550 
	`MMIO_GET_LD
(
¿nge
));

551 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

552 
	}
}

558 
__š™
 
	$š™_iommu_äom_aıi
(
amd_iommu
 *
iommu
,

559 
ivhd_h—d”
 *
h
)

561 
u8
 *
p
 = (u8 *)
h
;

562 
u8
 *
’d
 = 
p
, 
æags
 = 0;

563 
u16
 
dev_i
, 
devid
 = 0, 
devid_¡¬t
 = 0, 
devid_to
 = 0;

564 
u32
 
ext_æags
 = 0;

565 
boŞ
 
®Ÿs
 = 
çl£
;

566 
ivhd_’Œy
 *
e
;

572 
h
->
æags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

573 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_HT_TUN_EN
) :

574 
	`iommu_ã©u»_di§bË
(
iommu
, 
CONTROL_HT_TUN_EN
);

576 
h
->
æags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

577 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_PASSPW_EN
) :

578 
	`iommu_ã©u»_di§bË
(
iommu
, 
CONTROL_PASSPW_EN
);

580 
h
->
æags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

581 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

582 
	`iommu_ã©u»_di§bË
(
iommu
, 
CONTROL_RESPASSPW_EN
);

584 
h
->
æags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

585 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_ISOC_EN
) :

586 
	`iommu_ã©u»_di§bË
(
iommu
, 
CONTROL_ISOC_EN
);

591 
	`iommu_ã©u»_’abË
(
iommu
, 
CONTROL_COHERENT_EN
);

596 
p
 +ğ(
ivhd_h—d”
);

597 
’d
 +ğ
h
->
Ëngth
;

599 
p
 < 
’d
) {

600 
e
 = (
ivhd_’Œy
 *)
p
;

601 
e
->
ty³
) {

602 
IVHD_DEV_ALL
:

603 
dev_i
 = 
iommu
->
fœ¡_deviû
;

604 
dev_i
 <ğ
iommu
->
Ï¡_deviû
; ++dev_i)

605 
	`£t_dev_’Œy_äom_aıi
(
iommu
, 
dev_i
,

606 
e
->
æags
, 0);

608 
IVHD_DEV_SELECT
:

609 
devid
 = 
e
->devid;

610 
	`£t_dev_’Œy_äom_aıi
(
iommu
, 
devid
, 
e
->
æags
, 0);

612 
IVHD_DEV_SELECT_RANGE_START
:

613 
devid_¡¬t
 = 
e
->
devid
;

614 
æags
 = 
e
->flags;

615 
ext_æags
 = 0;

616 
®Ÿs
 = 
çl£
;

618 
IVHD_DEV_ALIAS
:

619 
devid
 = 
e
->devid;

620 
devid_to
 = 
e
->
ext
 >> 8;

621 
	`£t_dev_’Œy_äom_aıi
(
iommu
, 
devid
, 
e
->
æags
, 0);

622 
amd_iommu_®Ÿs_bË
[
devid
] = 
devid_to
;

624 
IVHD_DEV_ALIAS_RANGE
:

625 
devid_¡¬t
 = 
e
->
devid
;

626 
æags
 = 
e
->flags;

627 
devid_to
 = 
e
->
ext
 >> 8;

628 
ext_æags
 = 0;

629 
®Ÿs
 = 
Œue
;

631 
IVHD_DEV_EXT_SELECT
:

632 
devid
 = 
e
->devid;

633 
	`£t_dev_’Œy_äom_aıi
(
iommu
, 
devid
, 
e
->
æags
,

634 
e
->
ext
);

636 
IVHD_DEV_EXT_SELECT_RANGE
:

637 
devid_¡¬t
 = 
e
->
devid
;

638 
æags
 = 
e
->flags;

639 
ext_æags
 = 
e
->
ext
;

640 
®Ÿs
 = 
çl£
;

642 
IVHD_DEV_RANGE_END
:

643 
devid
 = 
e
->devid;

644 
dev_i
 = 
devid_¡¬t
; dev_˜<ğ
devid
; ++dev_i) {

645 ià(
®Ÿs
)

646 
amd_iommu_®Ÿs_bË
[
dev_i
] = 
devid_to
;

647 
	`£t_dev_’Œy_äom_aıi
(
iommu
,

648 
amd_iommu_®Ÿs_bË
[
dev_i
],

649 
æags
, 
ext_æags
);

656 
p
 +ğ
	`ivhd_’Œy_Ëngth
(p);

658 
	}
}

661 
__š™
 
	$š™_iommu_deviûs
(
amd_iommu
 *
iommu
)

663 
u16
 
i
;

665 
i
 = 
iommu
->
fœ¡_deviû
; i <ğiommu->
Ï¡_deviû
; ++i)

666 
	`£t_iommu_fÜ_deviû
(
iommu
, 
i
);

669 
	}
}

671 
__š™
 
	$ä“_iommu_Úe
(
amd_iommu
 *
iommu
)

673 
	`ä“_commªd_bufãr
(
iommu
);

674 
	`ä“_ev’t_bufãr
(
iommu
);

675 
	`iommu_unm­_mmio_¥aû
(
iommu
);

676 
	}
}

678 
__š™
 
	$ä“_iommu_®l
()

680 
amd_iommu
 *
iommu
, *
Ãxt
;

682 
	`li¡_fÜ_—ch_’Œy_§ã
(
iommu
, 
Ãxt
, &
amd_iommu_li¡
, 
li¡
) {

683 
	`li¡_d–
(&
iommu
->
li¡
);

684 
	`ä“_iommu_Úe
(
iommu
);

685 
	`kä“
(
iommu
);

687 
	}
}

694 
__š™
 
	$š™_iommu_Úe
(
amd_iommu
 *
iommu
, 
ivhd_h—d”
 *
h
)

696 
	`¥š_lock_š™
(&
iommu
->
lock
);

697 
	`li¡_add_
(&
iommu
->
li¡
, &
amd_iommu_li¡
);

702 
iommu
->
dev
 = 
	`pci_g‘_bus_ªd_¦Ù
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

703 ià(!
iommu
->
dev
)

706 
iommu
->
ÿp_±r
 = 
h
->cap_ptr;

707 
iommu
->
pci_£g
 = 
h
->pci_seg;

708 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

709 
iommu
->
mmio_ba£
 = 
	`iommu_m­_mmio_¥aû
(
h
->
mmio_phys
);

710 ià(!
iommu
->
mmio_ba£
)

711  -
ENOMEM
;

713 
	`iommu_£t_deviû_bË
(
iommu
);

714 
iommu
->
cmd_buf
 = 
	`®loc_commªd_bufãr
(iommu);

715 ià(!
iommu
->
cmd_buf
)

716  -
ENOMEM
;

718 
iommu
->
evt_buf
 = 
	`®loc_ev’t_bufãr
(iommu);

719 ià(!
iommu
->
evt_buf
)

720  -
ENOMEM
;

722 
iommu
->
št_’abËd
 = 
çl£
;

724 
	`š™_iommu_äom_pci
(
iommu
);

725 
	`š™_iommu_äom_aıi
(
iommu
, 
h
);

726 
	`š™_iommu_deviûs
(
iommu
);

728  
	`pci_’abË_deviû
(
iommu
->
dev
);

729 
	}
}

735 
__š™
 
	$š™_iommu_®l
(
aıi_bË_h—d”
 *
bË
)

737 
u8
 *
p
 = (u8 *)
bË
, *
’d
 = (u8 *)table;

738 
ivhd_h—d”
 *
h
;

739 
amd_iommu
 *
iommu
;

740 
»t
;

742 
’d
 +ğ
bË
->
Ëngth
;

743 
p
 +ğ
IVRS_HEADER_LENGTH
;

745 
p
 < 
’d
) {

746 
h
 = (
ivhd_h—d”
 *)
p
;

747 *
p
) {

748 
ACPI_IVHD_TYPE
:

749 
iommu
 = 
	`kz®loc
((
amd_iommu
), 
GFP_KERNEL
);

750 ià(
iommu
 =ğ
NULL
)

751  -
ENOMEM
;

752 
»t
 = 
	`š™_iommu_Úe
(
iommu
, 
h
);

753 ià(
»t
)

754  
»t
;

759 
p
 +ğ
h
->
Ëngth
;

762 
	`WARN_ON
(
p
 !ğ
’d
);

765 
	}
}

776 
__š™
 
	$iommu_£tup_msix
(
amd_iommu
 *
iommu
)

778 
amd_iommu
 *
cu¼
;

779 
msix_’Œy
 
’Œ›s
[32];

780 
nvec
 = 0, 
i
;

782 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, &
amd_iommu_li¡
, 
li¡
) {

783 ià(
cu¼
->
dev
 =ğ
iommu
->dev) {

784 
’Œ›s
[
nvec
].
’Œy
 = 
cu¼
->
evt_msi_num
;

785 
’Œ›s
[
nvec
].
veùÜ
 = 0;

786 
cu¼
->
št_’abËd
 = 
Œue
;

787 
nvec
++;

791 ià(
	`pci_’abË_msix
(
iommu
->
dev
, 
’Œ›s
, 
nvec
)) {

792 
	`pci_di§bË_msix
(
iommu
->
dev
);

796 
i
 = 0; i < 
nvec
; ++i) {

797 
r
 = 
	`»que¡_œq
(
’Œ›s
->
veùÜ
, 
amd_iommu_št_hªdËr
,

798 
IRQF_SAMPLE_RANDOM
,

800 
NULL
);

801 ià(
r
)

802 
out_ä“
;

807 
out_ä“
:

808 
i
 -= 1; i >= 0; --i)

809 
	`ä“_œq
(
’Œ›s
->
veùÜ
, 
NULL
);

811 
	`pci_di§bË_msix
(
iommu
->
dev
);

814 
	}
}

816 
__š™
 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

818 
r
;

819 
amd_iommu
 *
cu¼
;

821 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, &
amd_iommu_li¡
, 
li¡
) {

822 ià(
cu¼
->
dev
 =ğ
iommu
->dev)

823 
cu¼
->
št_’abËd
 = 
Œue
;

827 ià(
	`pci_’abË_msi
(
iommu
->
dev
))

830 
r
 = 
	`»que¡_œq
(
iommu
->
dev
->
œq
, 
amd_iommu_št_hªdËr
,

831 
IRQF_SAMPLE_RANDOM
,

833 
NULL
);

835 ià(
r
) {

836 
	`pci_di§bË_msi
(
iommu
->
dev
);

841 
	}
}

843 
__š™
 
	$iommu_š™_msi
(
amd_iommu
 *
iommu
)

845 ià(
iommu
->
št_’abËd
)

848 ià(
	`pci_fšd_ÿ·b™y
(
iommu
->
dev
, 
PCI_CAP_ID_MSIX
))

849  
	`iommu_£tup_msix
(
iommu
);

850 ià(
	`pci_fšd_ÿ·b™y
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

851  
	`iommu_£tup_msi
(
iommu
);

854 
	}
}

864 
__š™
 
	$ä“_un™y_m­s
()

866 
un™y_m­_’Œy
 *
’Œy
, *
Ãxt
;

868 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, &
amd_iommu_un™y_m­
, 
li¡
) {

869 
	`li¡_d–
(&
’Œy
->
li¡
);

870 
	`kä“
(
’Œy
);

872 
	}
}

875 
__š™
 
	$š™_exşusiÚ_¿nge
(
ivmd_h—d”
 *
m
)

877 
i
;

879 
m
->
ty³
) {

880 
ACPI_IVMD_TYPE
:

881 
	`£t_deviû_exşusiÚ_¿nge
(
m
->
devid
, m);

883 
ACPI_IVMD_TYPE_ALL
:

884 
i
 = 0; i <ğ
amd_iommu_Ï¡_bdf
; ++i)

885 
	`£t_deviû_exşusiÚ_¿nge
(
i
, 
m
);

887 
ACPI_IVMD_TYPE_RANGE
:

888 
i
 = 
m
->
devid
; i <ğm->
aux
; ++i)

889 
	`£t_deviû_exşusiÚ_¿nge
(
i
, 
m
);

896 
	}
}

899 
__š™
 
	$š™_un™y_m­_¿nge
(
ivmd_h—d”
 *
m
)

901 
un™y_m­_’Œy
 *
e
 = 0;

903 
e
 = 
	`kz®loc
((*e), 
GFP_KERNEL
);

904 ià(
e
 =ğ
NULL
)

905  -
ENOMEM
;

907 
m
->
ty³
) {

909 
ACPI_IVMD_TYPE
:

910 
e
->
devid_¡¬t
 =ƒ->
devid_’d
 = 
m
->
devid
;

912 
ACPI_IVMD_TYPE_ALL
:

913 
e
->
devid_¡¬t
 = 0;

914 
e
->
devid_’d
 = 
amd_iommu_Ï¡_bdf
;

916 
ACPI_IVMD_TYPE_RANGE
:

917 
e
->
devid_¡¬t
 = 
m
->
devid
;

918 
e
->
devid_’d
 = 
m
->
aux
;

921 
e
->
add»ss_¡¬t
 = 
	`PAGE_ALIGN
(
m
->
¿nge_¡¬t
);

922 
e
->
add»ss_’d
 =ƒ->
add»ss_¡¬t
 + 
	`PAGE_ALIGN
(
m
->
¿nge_Ëngth
);

923 
e
->
´Ù
 = 
m
->
æags
 >> 1;

925 
	`li¡_add_
(&
e
->
li¡
, &
amd_iommu_un™y_m­
);

928 
	}
}

931 
__š™
 
	$š™_memÜy_defš™iÚs
(
aıi_bË_h—d”
 *
bË
)

933 
u8
 *
p
 = (u8 *)
bË
, *
’d
 = (u8 *)table;

934 
ivmd_h—d”
 *
m
;

936 
’d
 +ğ
bË
->
Ëngth
;

937 
p
 +ğ
IVRS_HEADER_LENGTH
;

939 
p
 < 
’d
) {

940 
m
 = (
ivmd_h—d”
 *)
p
;

941 ià(
m
->
æags
 & 
IVMD_FLAG_EXCL_RANGE
)

942 
	`š™_exşusiÚ_¿nge
(
m
);

943 ià(
m
->
æags
 & 
IVMD_FLAG_UNITY_MAP
)

944 
	`š™_un™y_m­_¿nge
(
m
);

946 
p
 +ğ
m
->
Ëngth
;

950 
	}
}

956 
	$š™_deviû_bË
()

958 
u16
 
devid
;

960 
devid
 = 0; devid <ğ
amd_iommu_Ï¡_bdf
; ++devid) {

961 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_VALID
);

962 
	`£t_dev_’Œy_b™
(
devid
, 
DEV_ENTRY_TRANSLATION
);

964 
	}
}

970 
__š™
 
	$’abË_iommus
()

972 
amd_iommu
 *
iommu
;

974 
	`li¡_fÜ_—ch_’Œy
(
iommu
, &
amd_iommu_li¡
, 
li¡
) {

975 
	`iommu_£t_exşusiÚ_¿nge
(
iommu
);

976 
	`iommu_š™_msi
(
iommu
);

977 
	`iommu_’abË_ev’t_loggšg
(
iommu
);

978 
	`iommu_’abË
(
iommu
);

980 
	}
}

987 
	$amd_iommu_»sume
(
sys_deviû
 *
dev
)

990 
	}
}

992 
	$amd_iommu_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

994  -
EINVAL
;

995 
	}
}

997 
sysdev_şass
 
	gamd_iommu_sysdev_şass
 = {

998 .
Çme
 = "amd_iommu",

999 .
	gsu¥’d
 = 
amd_iommu_su¥’d
,

1000 .
	g»sume
 = 
amd_iommu_»sume
,

1003 
sys_deviû
 
	gdeviû_amd_iommu
 = {

1004 .
id
 = 0,

1005 .
	gşs
 = &
amd_iommu_sysdev_şass
,

1036 
__š™
 
	$amd_iommu_š™
()

1038 
i
, 
»t
 = 0;

1041 ià(
no_iommu
) {

1042 
	`´štk
(
KERN_INFO
 "AMD IOMMU disabled by kernel command†ine\n");

1046 ià(!
amd_iommu_d‘eùed
)

1047  -
ENODEV
;

1054 ià(
	`aıi_bË_·r£
("IVRS", 
fšd_Ï¡_devid_aıi
) != 0)

1055  -
ENODEV
;

1057 
dev_bË_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1058 
®Ÿs_bË_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1059 
¾ookup_bË_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1061 
»t
 = -
ENOMEM
;

1064 
amd_iommu_dev_bË
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1065 
	`g‘_Üd”
(
dev_bË_size
));

1066 ià(
amd_iommu_dev_bË
 =ğ
NULL
)

1067 
out
;

1073 
amd_iommu_®Ÿs_bË
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,

1074 
	`g‘_Üd”
(
®Ÿs_bË_size
));

1075 ià(
amd_iommu_®Ÿs_bË
 =ğ
NULL
)

1076 
ä“
;

1079 
amd_iommu_¾ookup_bË
 = (*)
	`__g‘_ä“_·ges
(

1080 
GFP_KERNEL
 | 
__GFP_ZERO
,

1081 
	`g‘_Üd”
(
¾ookup_bË_size
));

1082 ià(
amd_iommu_¾ookup_bË
 =ğ
NULL
)

1083 
ä“
;

1089 
amd_iommu_pd_bË
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1090 
	`g‘_Üd”
(
¾ookup_bË_size
));

1091 ià(
amd_iommu_pd_bË
 =ğ
NULL
)

1092 
ä“
;

1094 
amd_iommu_pd_®loc_b™m­
 = (*)
	`__g‘_ä“_·ges
(

1095 
GFP_KERNEL
 | 
__GFP_ZERO
,

1096 
	`g‘_Üd”
(
MAX_DOMAIN_ID
/8));

1097 ià(
amd_iommu_pd_®loc_b™m­
 =ğ
NULL
)

1098 
ä“
;

1101 
	`š™_deviû_bË
();

1106 
i
 = 0; i <ğ
amd_iommu_Ï¡_bdf
; ++i)

1107 
amd_iommu_®Ÿs_bË
[
i
] = i;

1113 
amd_iommu_pd_®loc_b™m­
[0] = 1;

1119 
»t
 = -
ENODEV
;

1120 ià(
	`aıi_bË_·r£
("IVRS", 
š™_iommu_®l
) != 0)

1121 
ä“
;

1123 ià(
	`aıi_bË_·r£
("IVRS", 
š™_memÜy_defš™iÚs
) != 0)

1124 
ä“
;

1126 
»t
 = 
	`sysdev_şass_»gi¡”
(&
amd_iommu_sysdev_şass
);

1127 ià(
»t
)

1128 
ä“
;

1130 
»t
 = 
	`sysdev_»gi¡”
(&
deviû_amd_iommu
);

1131 ià(
»t
)

1132 
ä“
;

1134 
»t
 = 
	`amd_iommu_š™_dma_İs
();

1135 ià(
»t
)

1136 
ä“
;

1138 
	`’abË_iommus
();

1140 
	`´štk
(
KERN_INFO
 "AMD IOMMU:‡perture size is %d MB\n",

1141 (1 << (
amd_iommu_­”tu»_Üd”
-20)));

1143 
	`´štk
(
KERN_INFO
 "AMD IOMMU: device isolation ");

1144 ià(
amd_iommu_isŞ©e
)

1145 
	`´štk
("enabled\n");

1147 
	`´štk
("disabled\n");

1149 ià(
amd_iommu_unm­_æush
)

1150 
	`´štk
(
KERN_INFO
 "AMD IOMMU: IO/TLB flush on unmapƒnabled\n");

1152 
	`´štk
(
KERN_INFO
 "AMD IOMMU: Lazy IO/TLB flushingƒnabled\n");

1154 
out
:

1155  
»t
;

1157 
ä“
:

1158 
	`ä“_·ges
(()
amd_iommu_pd_®loc_b™m­
,

1159 
	`g‘_Üd”
(
MAX_DOMAIN_ID
/8));

1161 
	`ä“_·ges
(()
amd_iommu_pd_bË
,

1162 
	`g‘_Üd”
(
¾ookup_bË_size
));

1164 
	`ä“_·ges
(()
amd_iommu_¾ookup_bË
,

1165 
	`g‘_Üd”
(
¾ookup_bË_size
));

1167 
	`ä“_·ges
(()
amd_iommu_®Ÿs_bË
,

1168 
	`g‘_Üd”
(
®Ÿs_bË_size
));

1170 
	`ä“_·ges
(()
amd_iommu_dev_bË
,

1171 
	`g‘_Üd”
(
dev_bË_size
));

1173 
	`ä“_iommu_®l
();

1175 
	`ä“_un™y_m­s
();

1177 
out
;

1178 
	}
}

1187 
__š™
 
	$—¾y_amd_iommu_d‘eù
(
aıi_bË_h—d”
 *
bË
)

1190 
	}
}

1192 
__š™
 
	$amd_iommu_d‘eù
()

1194 ià(
swiÙlb
 || 
no_iommu
 || (
iommu_d‘eùed
 && !
g¬t_iommu_­”tu»
))

1197 ià(
	`aıi_bË_·r£
("IVRS", 
—¾y_amd_iommu_d‘eù
) == 0) {

1198 
iommu_d‘eùed
 = 1;

1199 
amd_iommu_d‘eùed
 = 1;

1200 #ifdeà
CONFIG_GART_IOMMU


1201 
g¬t_iommu_­”tu»_di§bËd
 = 1;

1202 
g¬t_iommu_­”tu»
 = 0;

1205 
	}
}

1214 
__š™
 
	$·r£_amd_iommu_İtiÚs
(*
¡r
)

1216 ; *
¡r
; ++str) {

1217 ià(
	`¡ºcmp
(
¡r
, "isolate", 7) == 0)

1218 
amd_iommu_isŞ©e
 = 
Œue
;

1219 ià(
	`¡ºcmp
(
¡r
, "share", 5) == 0)

1220 
amd_iommu_isŞ©e
 = 
çl£
;

1221 ià(
	`¡ºcmp
(
¡r
, "fullflush", 9) == 0)

1222 
amd_iommu_unm­_æush
 = 
Œue
;

1226 
	}
}

1228 
__š™
 
	$·r£_amd_iommu_size_İtiÚs
(*
¡r
)

1230 
Üd”
 = 
PAGE_SHIFT
 + 
	`g‘_Üd”
(
	`mem·r£
(
¡r
, &str));

1232 ià((
Üd”
 > 24) && (order < 31))

1233 
amd_iommu_­”tu»_Üd”
 = 
Üd”
;

1236 
	}
}

1238 
__£tup
("amd_iommu=", 
·r£_amd_iommu_İtiÚs
);

1239 
__£tup
("amd_iommu_size=", 
·r£_amd_iommu_size_İtiÚs
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/š™.h
>

16 
	~<lšux/boÙmem.h
>

17 
	~<lšux/mmzÚe.h
>

18 
	~<lšux/pci_ids.h
>

19 
	~<lšux/pci.h
>

20 
	~<lšux/b™İs.h
>

21 
	~<lšux/iİÜt.h
>

22 
	~<lšux/su¥’d.h
>

23 
	~<asm/e820.h
>

24 
	~<asm/io.h
>

25 
	~<asm/iommu.h
>

26 
	~<asm/g¬t.h
>

27 
	~<asm/pci-dœeù.h
>

28 
	~<asm/dma.h
>

29 
	~<asm/k8.h
>

31 
	gg¬t_iommu_­”tu»
;

32 
g¬t_iommu_­”tu»_di§bËd
 
	g__š™d©a
;

33 
g¬t_iommu_­”tu»_®lowed
 
	g__š™d©a
;

35 
çÎback_­”_Üd”
 
	g__š™d©a
 = 1;

36 
çÎback_­”_fÜû
 
	g__š™d©a
;

38 
fix_­”tu»
 
	g__š™d©a
 = 1;

40 
	sbus_dev_¿nge
 {

41 
	mbus
;

42 
	mdev_ba£
;

43 
	mdev_lim™
;

46 
bus_dev_¿nge
 
	gbus_dev_¿nges
[] 
	g__š™d©a
 = {

52 
»sourû
 
	gg¬t_»sourû
 = {

53 .
Çme
 = "GART",

54 .
	gæags
 = 
IORESOURCE_MEM
,

57 
__š™
 
	$š£¹_­”tu»_»sourû
(
u32
 
­”_ba£
, u32 
­”_size
)

59 
g¬t_»sourû
.
¡¬t
 = 
­”_ba£
;

60 
g¬t_»sourû
.
’d
 = 
­”_ba£
 + 
­”_size
 - 1;

61 
	`š£¹_»sourû
(&
iomem_»sourû
, &
g¬t_»sourû
);

62 
	}
}

67 
u32
 
__š™
 
	$®loÿ‹_­”tu»
()

69 
u32
 
­”_size
;

70 *
p
;

73 ià(
çÎback_­”_Üd”
 > 5)

74 
çÎback_­”_Üd”
 = 5;

75 
­”_size
 = (32 * 1024 * 1024è<< 
çÎback_­”_Üd”
;

96 
p
 = 
	`__®loc_boÙmem_nİªic
(
­”_size
,‡per_size, 512ULL<<20);

97 ià(!
p
 || 
	`__·
Õ)+
­”_size
 > 0xffffffff) {

98 
	`´štk
(
KERN_ERR


100 
p
, 
­”_size
>>10);

101 ià(
p
)

102 
	`ä“_boÙmem
(
	`__·
(
p
), 
­”_size
);

105 
	`´štk
(
KERN_INFO
 "Mapping‡perture over %d KB of RAM @ %lx\n",

106 
­”_size
 >> 10, 
	`__·
(
p
));

107 
	`š£¹_­”tu»_»sourû
((
u32
)
	`__·
(
p
), 
­”_size
);

108 
	`»gi¡”_no§ve_»giÚ
((
u32
)
	`__·
(
p
è>> 
PAGE_SHIFT
,

109 (
u32
)
	`__·
(
p
+
­”_size
è>> 
PAGE_SHIFT
);

111  (
u32
)
	`__·
(
p
);

112 
	}
}

116 
u32
 
__š™
 
	$fšd_ÿp
(
bus
, 
¦Ù
, 
func
, 
ÿp
)

118 
by‹s
;

119 
u8
 
pos
;

121 ià(!(
	`»ad_pci_cÚfig_16
(
bus
, 
¦Ù
, 
func
, 
PCI_STATUS
) &

122 
PCI_STATUS_CAP_LIST
))

125 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
, 
PCI_CAPABILITY_LIST
);

126 
by‹s
 = 0; by‹ < 48 && 
pos
 >= 0x40; bytes++) {

127 
u8
 
id
;

129 
pos
 &= ~3;

130 
id
 = 
	`»ad_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

131 ià(
id
 == 0xff)

133 ià(
id
 =ğ
ÿp
)

134  
pos
;

135 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
,

136 
pos
+
PCI_CAP_LIST_NEXT
);

139 
	}
}

142 
u32
 
__š™
 
	$»ad_agp
(
bus
, 
¦Ù
, 
func
, 
ÿp
, 
u32
 *
Üd”
)

144 
u32
 
­size
;

145 
u32
 
­siz”eg
;

146 
nb™s
;

147 
u32
 
­”_low
, 
­”_hi
;

148 
u64
 
­”
;

149 
u32
 
Şd_Üd”
;

151 
	`´štk
(
KERN_INFO
 "AGP bridg© %02x:%02x:%02x\n", 
bus
, 
¦Ù
, 
func
);

152 
­siz”eg
 = 
	`»ad_pci_cÚfig_16
(
bus
, 
¦Ù
, 
func
, 
ÿp
 + 0x14);

153 ià(
­siz”eg
 == 0xffffffff) {

154 
	`´štk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

159 
Şd_Üd”
 = *
Üd”
;

161 
­size
 = 
­siz”eg
 & 0xfff;

163 ià(
­size
 & 0xff)

164 
­size
 |= 0xf00;

165 
nb™s
 = 
	`hweight16
(
­size
);

166 *
Üd”
 = 7 - 
nb™s
;

167 ià(()*
Üd”
 < 0)

168 *
Üd”
 = 0;

170 
­”_low
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
, 0x10);

171 
­”_hi
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
, 0x14);

172 
­”
 = (
­”_low
 & ~((1<<22)-1)è| ((
u64
)
­”_hi
 << 32);

178 
	`´štk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

179 
­”
, 32 << 
Şd_Üd”
);

180 ià(
­”
 + (32ULL<<(20 + *
Üd”
)) > 0x100000000ULL) {

181 
	`´štk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) is‚ot„ight, using settings from NB\n",

182 32 << *
Üd”
, 
­siz”eg
);

183 *
Üd”
 = 
Şd_Üd”
;

186 
	`´štk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

187 
­”
, 32 << *
Üd”
, 
­siz”eg
);

189 ià(!
	`­”tu»_v®id
(
­”
, (32*1024*1024è<< *
Üd”
, 32<<20))

191  (
u32
)
­”
;

192 
	}
}

207 
u32
 
__š™
 
	$£¬ch_agp_bridge
(
u32
 *
Üd”
, *
v®id_agp
)

209 
bus
, 
¦Ù
, 
func
;

212 
bus
 = 0; bus < 256; bus++) {

213 
¦Ù
 = 0; slot < 32; slot++) {

214 
func
 = 0; func < 8; func++) {

215 
u32
 
şass
, 
ÿp
;

216 
u8
 
ty³
;

217 
şass
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
,

218 
PCI_CLASS_REVISION
);

219 ià(
şass
 == 0xffffffff)

222 
şass
 >> 16) {

223 
PCI_CLASS_BRIDGE_HOST
:

224 
PCI_CLASS_BRIDGE_OTHER
:

226 
ÿp
 = 
	`fšd_ÿp
(
bus
, 
¦Ù
, 
func
,

227 
PCI_CAP_ID_AGP
);

228 ià(!
ÿp
)

230 *
v®id_agp
 = 1;

231  
	`»ad_agp
(
bus
, 
¦Ù
, 
func
, 
ÿp
,

232 
Üd”
);

236 
ty³
 = 
	`»ad_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
,

237 
PCI_HEADER_TYPE
);

238 ià(!(
ty³
 & 0x80))

243 
	`´štk
(
KERN_INFO
 "No AGP bridge found\n");

246 
	}
}

248 
g¬t_fix_e820
 
	g__š™d©a
 = 1;

250 
__š™
 
	$·r£_g¬t_mem
(*
p
)

252 ià(!
p
)

253  -
EINVAL
;

255 ià(!
	`¡ºcmp
(
p
, "off", 3))

256 
g¬t_fix_e820
 = 0;

257 ià(!
	`¡ºcmp
(
p
, "on", 2))

258 
g¬t_fix_e820
 = 1;

261 
	}
}

262 
—¾y_·¿m
("g¬t_fix_e820", 
·r£_g¬t_mem
);

264 
__š™
 
	$—¾y_g¬t_iommu_check
()

276 
i
, 
fix
, 
¦Ù
;

277 
u32
 
ùl
;

278 
u32
 
­”_size
 = 0, 
­”_Üd”
 = 0, 
Ï¡_­”_Üd”
 = 0;

279 
u64
 
­”_ba£
 = 0, 
Ï¡_­”_ba£
 = 0;

280 
­”_’abËd
 = 0, 
Ï¡_­”_’abËd
 = 0, 
Ï¡_v®id
 = 0;

282 ià(!
	`—¾y_pci_®lowed
())

286 
fix
 = 0;

287 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_¿nges
); i++) {

288 
bus
;

289 
dev_ba£
, 
dev_lim™
;

291 
bus
 = 
bus_dev_¿nges
[
i
].bus;

292 
dev_ba£
 = 
bus_dev_¿nges
[
i
].dev_base;

293 
dev_lim™
 = 
bus_dev_¿nges
[
i
].dev_limit;

295 
¦Ù
 = 
dev_ba£
; slÙ < 
dev_lim™
; slot++) {

296 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 0x00)))

299 
ùl
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTURECTL
);

300 
­”_’abËd
 = 
ùl
 & 
AMD64_GARTEN
;

301 
­”_Üd”
 = (
ùl
 >> 1) & 7;

302 
­”_size
 = (32 * 1024 * 1024è<< 
­”_Üd”
;

303 
­”_ba£
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

304 
­”_ba£
 <<= 25;

306 ià(
Ï¡_v®id
) {

307 ià((
­”_Üd”
 !ğ
Ï¡_­”_Üd”
) ||

308 (
­”_ba£
 !ğ
Ï¡_­”_ba£
) ||

309 (
­”_’abËd
 !ğ
Ï¡_­”_’abËd
)) {

310 
fix
 = 1;

315 
Ï¡_­”_Üd”
 = 
­”_Üd”
;

316 
Ï¡_­”_ba£
 = 
­”_ba£
;

317 
Ï¡_­”_’abËd
 = 
­”_’abËd
;

318 
Ï¡_v®id
 = 1;

322 ià(!
fix
 && !
­”_’abËd
)

325 ià(!
­”_ba£
 || !
­”_size
 ||‡per_base +‡per_size > 0x100000000UL)

326 
fix
 = 1;

328 ià(
g¬t_fix_e820
 && !
fix
 && 
­”_’abËd
) {

329 ià(
	`e820_ªy_m­³d
(
­”_ba£
,‡³r_ba£ + 
­”_size
,

330 
E820_RAM
)) {

332 
	`´štk
(
KERN_INFO
 "updateƒ820 for GART\n");

333 
	`e820_add_»giÚ
(
­”_ba£
, 
­”_size
, 
E820_RESERVED
);

334 
	`upd©e_e820
();

338 ià(!
fix
)

342 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_¿nges
); i++) {

343 
bus
;

344 
dev_ba£
, 
dev_lim™
;

346 
bus
 = 
bus_dev_¿nges
[
i
].bus;

347 
dev_ba£
 = 
bus_dev_¿nges
[
i
].dev_base;

348 
dev_lim™
 = 
bus_dev_¿nges
[
i
].dev_limit;

350 
¦Ù
 = 
dev_ba£
; slÙ < 
dev_lim™
; slot++) {

351 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 0x00)))

354 
ùl
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTURECTL
);

355 
ùl
 &ğ~
AMD64_GARTEN
;

356 
	`wr™e_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTURECTL
, 
ùl
);

360 
	}
}

362 
__š™d©a
 
	g´š‹d_g¬t_size_msg
;

364 
__š™
 
	$g¬t_iommu_hŞe_š™
()

366 
u32
 
agp_­”_ba£
 = 0, 
agp_­”_Üd”
 = 0;

367 
u32
 
­”_size
, 
­”_®loc
 = 0, 
­”_Üd”
 = 0, 
Ï¡_­”_Üd”
 = 0;

368 
u64
 
­”_ba£
, 
Ï¡_­”_ba£
 = 0;

369 
fix
, 
¦Ù
, 
v®id_agp
 = 0;

370 
i
, 
node
;

372 ià(
g¬t_iommu_­”tu»_di§bËd
 || !
fix_­”tu»
 ||

373 !
	`—¾y_pci_®lowed
())

376 
	`´štk
(
KERN_INFO
 "Checking‡perture...\n");

378 ià(!
çÎback_­”_fÜû
)

379 
agp_­”_ba£
 = 
	`£¬ch_agp_bridge
(&
agp_­”_Üd”
, &
v®id_agp
);

381 
fix
 = 0;

382 
node
 = 0;

383 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_¿nges
); i++) {

384 
bus
;

385 
dev_ba£
, 
dev_lim™
;

387 
bus
 = 
bus_dev_¿nges
[
i
].bus;

388 
dev_ba£
 = 
bus_dev_¿nges
[
i
].dev_base;

389 
dev_lim™
 = 
bus_dev_¿nges
[
i
].dev_limit;

391 
¦Ù
 = 
dev_ba£
; slÙ < 
dev_lim™
; slot++) {

392 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 0x00)))

395 
iommu_d‘eùed
 = 1;

396 
g¬t_iommu_­”tu»
 = 1;

398 
­”_Üd”
 = (
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTURECTL
) >> 1) & 7;

399 
­”_size
 = (32 * 1024 * 1024è<< 
­”_Üd”
;

400 
­”_ba£
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

401 
­”_ba£
 <<= 25;

403 
	`´štk
(
KERN_INFO
 "Node %d:‡perture @ %Lx size %u MB\n",

404 
node
, 
­”_ba£
, 
­”_size
 >> 20);

405 
node
++;

407 ià(!
	`­”tu»_v®id
(
­”_ba£
, 
­”_size
, 64<<20)) {

408 ià(
v®id_agp
 && 
agp_­”_ba£
 &&

409 
agp_­”_ba£
 =ğ
­”_ba£
 &&

410 
agp_­”_Üd”
 =ğ
­”_Üd”
) {

412 ià(!
no_iommu
 &&

413 
max_pâ
 > 
MAX_DMA32_PFN
 &&

414 !
´š‹d_g¬t_size_msg
) {

415 
	`´štk
(
KERN_ERR
 "you‡re using iommu with‡gp, but GART size is†esshan 64M\n");

416 
	`´štk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

417 
	`´štk
(
KERN_ERR
 "if BIOS doesn't havehat option, contact your HW vendor!\n");

418 
´š‹d_g¬t_size_msg
 = 1;

421 
fix
 = 1;

422 
out
;

426 ià((
Ï¡_­”_Üd”
 && 
­”_Üd”
 !=†ast_aper_order) ||

427 (
Ï¡_­”_ba£
 && 
­”_ba£
 !=†ast_aper_base)) {

428 
fix
 = 1;

429 
out
;

431 
Ï¡_­”_Üd”
 = 
­”_Üd”
;

432 
Ï¡_­”_ba£
 = 
­”_ba£
;

436 
out
:

437 ià(!
fix
 && !
çÎback_­”_fÜû
) {

438 ià(
Ï¡_­”_ba£
) {

439 
n
 = (32 * 1024 * 1024è<< 
Ï¡_­”_Üd”
;

441 
	`š£¹_­”tu»_»sourû
((
u32
)
Ï¡_­”_ba£
, 
n
);

446 ià(!
çÎback_­”_fÜû
) {

447 
­”_®loc
 = 
agp_­”_ba£
;

448 
­”_Üd”
 = 
agp_­”_Üd”
;

451 ià(
­”_®loc
) {

453 } ià(
swiÙlb
 && !
v®id_agp
) {

455 } ià((!
no_iommu
 && 
max_pâ
 > 
MAX_DMA32_PFN
) ||

456 
fÜû_iommu
 ||

457 
v®id_agp
 ||

458 
çÎback_­”_fÜû
) {

459 
	`´štk
(
KERN_INFO


461 
	`´štk
(
KERN_INFO


463 
	`´štk
(
KERN_INFO


465 32 << 
çÎback_­”_Üd”
);

467 
­”_Üd”
 = 
çÎback_­”_Üd”
;

468 
­”_®loc
 = 
	`®loÿ‹_­”tu»
();

469 ià(!
­”_®loc
) {

478 
	`·nic
("Notƒnough memory for‡perture");

485 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_¿nges
); i++) {

486 
bus
;

487 
dev_ba£
, 
dev_lim™
;

489 
bus
 = 
bus_dev_¿nges
[
i
].bus;

490 
dev_ba£
 = 
bus_dev_¿nges
[
i
].dev_base;

491 
dev_lim™
 = 
bus_dev_¿nges
[
i
].dev_limit;

492 
¦Ù
 = 
dev_ba£
; slÙ < 
dev_lim™
; slot++) {

493 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 3, 0x00)))

499 
	`wr™e_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTURECTL
, 
­”_Üd”
 << 1);

500 
	`wr™e_pci_cÚfig
(
bus
, 
¦Ù
, 3, 
AMD64_GARTAPERTUREBASE
, 
­”_®loc
 >> 25);

504 
	`£t_up_g¬t_»sume
(
­”_Üd”
, 
­”_®loc
);

505 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<lšux/k”Ãl_¡©.h
>

18 
	~<lšux/mc146818¹c.h
>

19 
	~<lšux/aıi_pmtmr.h
>

20 
	~<lšux/şockchs.h
>

21 
	~<lšux/š‹¼u±.h
>

22 
	~<lšux/boÙmem.h
>

23 
	~<lšux/á¿û.h
>

24 
	~<lšux/iİÜt.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/sysdev.h
>

27 
	~<lšux/d–ay.h
>

28 
	~<lšux/timex.h
>

29 
	~<lšux/dm¬.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/ıu.h
>

32 
	~<lšux/dmi.h
>

33 
	~<lšux/nmi.h
>

34 
	~<lšux/smp.h
>

35 
	~<lšux/mm.h
>

37 
	~<asm/pg®loc.h
>

38 
	~<asm/©omic.h
>

39 
	~<asm/mp¥ec.h
>

40 
	~<asm/i8253.h
>

41 
	~<asm/i8259.h
>

42 
	~<asm/´Ùo.h
>

43 
	~<asm/­ic.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/h³t.h
>

46 
	~<asm/idË.h
>

47 
	~<asm/mŒr.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/mû.h
>

51 
	gnum_´oûssÜs
;

53 
di§bËd_ıus
 
	g__ıuš™d©a
;

56 
	gboÙ_ıu_physiÿl_­icid
 = -1U;

67 
	gmax_physiÿl_­icid
;

72 
physid_mask_t
 
	gphys_ıu_´e£Á_m­
;

77 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_ıu_to_­icid
, 
BAD_APICID
);

78 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_ıu_­icid
, 
BAD_APICID
);

79 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_ıu_to_­icid
);

80 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_ıu_­icid
);

82 #ifdeà
CONFIG_X86_32


88 
	gfÜû_’abË_loÿl_­ic
;

92 
__š™
 
	$·r£_Ïpic
(*
¬g
)

94 
fÜû_’abË_loÿl_­ic
 = 1;

96 
	}
}

97 
—¾y_·¿m
("Ïpic", 
·r£_Ïpic
);

99 
	g’abËd_vŸ_­icba£
;

103 #ifdeà
CONFIG_X86_64


104 
­ic_ÿlib¿‹_pmtmr
 
	g__š™d©a
;

105 
__š™
 
	$£tup_­iımtim”
(*
s
)

107 
­ic_ÿlib¿‹_pmtmr
 = 1;

108 
	`nÙsc_£tup
(
NULL
);

110 
	}
}

111 
__£tup
("­iımtim”", 
£tup_­iımtim”
);

114 #ifdeà
CONFIG_X86_X2APIC


115 
	gx2­ic
;

117 
	gx2­ic_´“ÇbËd
;

118 
	gdi§bË_x2­ic
;

119 
__š™
 
	$£tup_nox2­ic
(*
¡r
)

121 
di§bË_x2­ic
 = 1;

122 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_X2APIC
);

124 
	}
}

125 
—¾y_·¿m
("nox2­ic", 
£tup_nox2­ic
);

128 
	gmp_Ïpic_addr
;

129 
	gdi§bË_­ic
;

131 
di§bË_­ic_tim”
 
	g__ıuš™d©a
;

133 
	gloÿl_­ic_tim”_c2_ok
;

134 
EXPORT_SYMBOL_GPL
(
loÿl_­ic_tim”_c2_ok
);

136 
	gfœ¡_sy¡em_veùÜ
 = 0xfe;

141 
	g­ic_v”bos™y
;

143 
	gpic_mode
;

146 
	gsmp_found_cÚfig
;

148 
»sourû
 
	gÏpic_»sourû
 = {

149 .
Çme
 = "Local APIC",

150 .
	gæags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

153 
	gÿlib¿tiÚ_»suÉ
;

155 
Ïpic_Ãxt_ev’t
(
d–
,

156 
şock_ev’t_deviû
 *
evt
);

157 
Ïpic_tim”_£tup
(
şock_ev’t_mode
 
mode
,

158 
şock_ev’t_deviû
 *
evt
);

159 
Ïpic_tim”_brßdÿ¡
(cÚ¡ 
ıumask
 *
mask
);

160 
­ic_pm_aùiv©e
();

165 
şock_ev’t_deviû
 
	gÏpic_şockev’t
 = {

166 .
Çme
 = "lapic",

167 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


168 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

169 .
	gshiá
 = 32,

170 .
	g£t_mode
 = 
Ïpic_tim”_£tup
,

171 .
	g£t_Ãxt_ev’t
 = 
Ïpic_Ãxt_ev’t
,

172 .
	gbrßdÿ¡
 = 
Ïpic_tim”_brßdÿ¡
,

173 .
	g¿tšg
 = 100,

174 .
	gœq
 = -1,

176 
DEFINE_PER_CPU
(
şock_ev’t_deviû
, 
Ïpic_ev’ts
);

178 
	g­ic_phys
;

183 
šlše
 
	$Ïpic_g‘_v”siÚ
()

185  
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

186 
	}
}

191 
šlše
 
	$Ïpic_is_š‹g¿‹d
()

193 #ifdeà
CONFIG_X86_64


196  
	`APIC_INTEGRATED
(
	`Ïpic_g‘_v”siÚ
());

198 
	}
}

203 
	$mod”n_­ic
()

206 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 &&

207 
boÙ_ıu_d©a
.
x86
 >= 0xf)

209  
	`Ïpic_g‘_v”siÚ
() >= 0x14;

210 
	}
}

212 
	$Çtive_­ic_wa™_iü_idË
()

214 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
)

215 
	`ıu_»Ïx
();

216 
	}
}

218 
u32
 
	$Çtive_§ã_­ic_wa™_iü_idË
()

220 
u32
 
£nd_¡©us
;

221 
timeout
;

223 
timeout
 = 0;

225 
£nd_¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
;

226 ià(!
£nd_¡©us
)

228 
	`ud–ay
(100);

229 } 
timeout
++ < 1000);

231  
£nd_¡©us
;

232 
	}
}

234 
	$Çtive_­ic_iü_wr™e
(
u32
 
low
, u32 
id
)

236 
	`­ic_wr™e
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

237 
	`­ic_wr™e
(
APIC_ICR
, 
low
);

238 
	}
}

240 
u64
 
	$Çtive_­ic_iü_»ad
()

242 
u32
 
iü1
, 
iü2
;

244 
iü2
 = 
	`­ic_»ad
(
APIC_ICR2
);

245 
iü1
 = 
	`­ic_»ad
(
APIC_ICR
);

247  
iü1
 | ((
u64
)
iü2
 << 32);

248 
	}
}

253 
__ıuš™
 
	$’abË_NMI_through_LVT0
()

255 
v
;

258 
v
 = 
APIC_DM_NMI
;

261 ià(!
	`Ïpic_is_š‹g¿‹d
())

262 
v
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

264 
	`­ic_wr™e
(
APIC_LVT0
, 
v
);

265 
	}
}

267 #ifdeà
CONFIG_X86_32


271 
	$g‘_physiÿl_brßdÿ¡
()

273  
	`mod”n_­ic
() ? 0xff : 0xf;

274 
	}
}

280 
	$Ïpic_g‘_maxlvt
()

282 
v
;

284 
v
 = 
	`­ic_»ad
(
APIC_LVR
);

289  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)è? 
	`GET_APIC_MAXLVT
(v) : 2;

290 
	}
}

297 
	#APIC_DIVISOR
 16

	)

309 
	$__£tup_APIC_LVTT
(
şocks
, 
ÚeshÙ
, 
œq’
)

311 
lv‰_v®ue
, 
tmp_v®ue
;

313 
lv‰_v®ue
 = 
LOCAL_TIMER_VECTOR
;

314 ià(!
ÚeshÙ
)

315 
lv‰_v®ue
 |ğ
APIC_LVT_TIMER_PERIODIC
;

316 ià(!
	`Ïpic_is_š‹g¿‹d
())

317 
lv‰_v®ue
 |ğ
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

319 ià(!
œq’
)

320 
lv‰_v®ue
 |ğ
APIC_LVT_MASKED
;

322 
	`­ic_wr™e
(
APIC_LVTT
, 
lv‰_v®ue
);

327 
tmp_v®ue
 = 
	`­ic_»ad
(
APIC_TDCR
);

328 
	`­ic_wr™e
(
APIC_TDCR
,

329 (
tmp_v®ue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

330 
APIC_TDR_DIV_16
);

332 ià(!
ÚeshÙ
)

333 
	`­ic_wr™e
(
APIC_TMICT
, 
şocks
 / 
APIC_DIVISOR
);

334 
	}
}

346 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

347 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

349 
	$£tup_APIC_evt
(
u8
 
lvt_off
, u8 
veùÜ
, u8 
msg_ty³
, u8 
mask
)

351 
»g
 = (
lvt_off
 << 4è+ 
APIC_EILVT0
;

352 
v
 = (
mask
 << 16è| (
msg_ty³
 << 8è| 
veùÜ
;

354 
	`­ic_wr™e
(
»g
, 
v
);

355 
	}
}

357 
u8
 
	$£tup_APIC_evt_mû
(
u8
 
veùÜ
, u8 
msg_ty³
, u8 
mask
)

359 
	`£tup_APIC_evt
(
APIC_EILVT_LVTOFF_MCE
, 
veùÜ
, 
msg_ty³
, 
mask
);

360  
APIC_EILVT_LVTOFF_MCE
;

361 
	}
}

363 
u8
 
	$£tup_APIC_evt_ibs
(
u8
 
veùÜ
, u8 
msg_ty³
, u8 
mask
)

365 
	`£tup_APIC_evt
(
APIC_EILVT_LVTOFF_IBS
, 
veùÜ
, 
msg_ty³
, 
mask
);

366  
APIC_EILVT_LVTOFF_IBS
;

367 
	}
}

368 
EXPORT_SYMBOL_GPL
(
£tup_APIC_evt_ibs
);

373 
	$Ïpic_Ãxt_ev’t
(
d–
,

374 
şock_ev’t_deviû
 *
evt
)

376 
	`­ic_wr™e
(
APIC_TMICT
, 
d–
);

378 
	}
}

383 
	$Ïpic_tim”_£tup
(
şock_ev’t_mode
 
mode
,

384 
şock_ev’t_deviû
 *
evt
)

386 
æags
;

387 
v
;

390 ià(
evt
->
ã©u»s
 & 
CLOCK_EVT_FEAT_DUMMY
)

393 
	`loÿl_œq_§ve
(
æags
);

395 
mode
) {

396 
CLOCK_EVT_MODE_PERIODIC
:

397 
CLOCK_EVT_MODE_ONESHOT
:

398 
	`__£tup_APIC_LVTT
(
ÿlib¿tiÚ_»suÉ
,

399 
mode
 !ğ
CLOCK_EVT_MODE_PERIODIC
, 1);

401 
CLOCK_EVT_MODE_UNUSED
:

402 
CLOCK_EVT_MODE_SHUTDOWN
:

403 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

404 
v
 |ğ(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

405 
	`­ic_wr™e
(
APIC_LVTT
, 
v
);

406 
	`­ic_wr™e
(
APIC_TMICT
, 0xffffffff);

408 
CLOCK_EVT_MODE_RESUME
:

413 
	`loÿl_œq_»¡Üe
(
æags
);

414 
	}
}

419 
	$Ïpic_tim”_brßdÿ¡
(cÚ¡ 
ıumask
 *
mask
)

421 #ifdeà
CONFIG_SMP


422 
­ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

424 
	}
}

430 
__ıuš™
 
	$£tup_APIC_tim”
()

432 
şock_ev’t_deviû
 *
Ëvt
 = &
	`__g‘_ıu_v¬
(
Ïpic_ev’ts
);

434 ià(
	`ıu_has
(&
cu¼’t_ıu_d©a
, 
X86_FEATURE_ARAT
)) {

435 
Ïpic_şockev’t
.
ã©u»s
 &ğ~
CLOCK_EVT_FEAT_C3STOP
;

437 
Ïpic_şockev’t
.
¿tšg
 = 150;

440 
	`memıy
(
Ëvt
, &
Ïpic_şockev’t
, (*levt));

441 
Ëvt
->
ıumask
 = 
	`ıumask_of
(
	`smp_´oûssÜ_id
());

443 
	`şockev’ts_»gi¡”_deviû
(
Ëvt
);

444 
	}
}

467 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

469 
__š™d©a
 
	gÏpic_ÿl_loİs
 = -1;

470 
__š™d©a
 
	gÏpic_ÿl_t1
, 
	gÏpic_ÿl_t2
;

471 
__š™d©a
 
	gÏpic_ÿl_tsc1
, 
	gÏpic_ÿl_tsc2
;

472 
__š™d©a
 
	gÏpic_ÿl_pm1
, 
	gÏpic_ÿl_pm2
;

473 
__š™d©a
 
	gÏpic_ÿl_j1
, 
	gÏpic_ÿl_j2
;

478 
__š™
 
	$Ïpic_ÿl_hªdËr
(
şock_ev’t_deviû
 *
dev
)

480 
tsc
 = 0;

481 
pic
 = 
	`­ic_»ad
(
APIC_TMCCT
);

482 
pm
 = 
	`aıi_pm_»ad_—¾y
();

484 ià(
ıu_has_tsc
)

485 
	`rdtsşl
(
tsc
);

487 
Ïpic_ÿl_loİs
++) {

489 
Ïpic_ÿl_t1
 = 
pic
;

490 
Ïpic_ÿl_tsc1
 = 
tsc
;

491 
Ïpic_ÿl_pm1
 = 
pm
;

492 
Ïpic_ÿl_j1
 = 
jiff›s
;

495 
LAPIC_CAL_LOOPS
:

496 
Ïpic_ÿl_t2
 = 
pic
;

497 
Ïpic_ÿl_tsc2
 = 
tsc
;

498 ià(
pm
 < 
Ïpic_ÿl_pm1
)

499 
pm
 +ğ
ACPI_PM_OVRRUN
;

500 
Ïpic_ÿl_pm2
 = 
pm
;

501 
Ïpic_ÿl_j2
 = 
jiff›s
;

504 
	}
}

506 
__š™


507 
	$ÿlib¿‹_by_pmtim”
(
d–pm
, *
d–
, *
d–tsc
)

509 cÚ¡ 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

510 cÚ¡ 
pm_th»sh
 = 
pm_100ms
 / 100;

511 
muÉ
;

512 
u64
 
»s
;

514 #iâdeà
CONFIG_X86_PM_TIMER


518 
	`­ic_´štk
(
APIC_VERBOSE
, "... PM-Tim” d– = %ld\n", 
d–pm
);

521 ià(!
d–pm
)

524 
muÉ
 = 
	`şocksourû_hz2muÉ
(
PMTMR_TICKS_PER_SEC
, 22);

526 ià(
d–pm
 > (
pm_100ms
 - 
pm_th»sh
) &&

527 
d–pm
 < (
pm_100ms
 + 
pm_th»sh
)) {

528 
	`­ic_´štk
(
APIC_VERBOSE
, "... PM-Timer„esult ok\n");

532 
»s
 = (((
u64
)
d–pm
è* 
muÉ
) >> 22;

533 
	`do_div
(
»s
, 1000000);

534 
	`´_w¬nšg
("APIC calibration‚ot consistent "

535 "w™h PM-Tim”: %ldm š¡—d oà100ms\n",()
»s
);

538 
»s
 = (((
u64
)(*
d–
)è* 
pm_100ms
);

539 
	`do_div
(
»s
, 
d–pm
);

540 
	`´_šfo
("APIC delta‡djustedo PM-Timer: "

541 "%lu (%ld)\n", ()
»s
, *
d–
);

542 *
d–
 = ()
»s
;

545 ià(
ıu_has_tsc
) {

546 
»s
 = (((
u64
)(*
d–tsc
)è* 
pm_100ms
);

547 
	`do_div
(
»s
, 
d–pm
);

548 
	`­ic_´štk
(
APIC_VERBOSE
, "TSC delta‡djustedo "

550 ()
»s
, *
d–tsc
);

551 *
d–tsc
 = ()
»s
;

555 
	}
}

557 
__š™
 
	$ÿlib¿‹_APIC_şock
()

559 
şock_ev’t_deviû
 *
Ëvt
 = &
	`__g‘_ıu_v¬
(
Ïpic_ev’ts
);

560 (*
»®_hªdËr
)(
şock_ev’t_deviû
 *
dev
);

561 
d–j
;

562 
d–
, 
d–tsc
;

563 
pm_»ã»nûd
 = 0;

565 
	`loÿl_œq_di§bË
();

568 
»®_hªdËr
 = 
glob®_şock_ev’t
->
ev’t_hªdËr
;

569 
glob®_şock_ev’t
->
ev’t_hªdËr
 = 
Ïpic_ÿl_hªdËr
;

575 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

578 
	`loÿl_œq_’abË
();

580 
Ïpic_ÿl_loİs
 <ğ
LAPIC_CAL_LOOPS
)

581 
	`ıu_»Ïx
();

583 
	`loÿl_œq_di§bË
();

586 
glob®_şock_ev’t
->
ev’t_hªdËr
 = 
»®_hªdËr
;

589 
d–
 = 
Ïpic_ÿl_t1
 - 
Ïpic_ÿl_t2
;

590 
	`­ic_´štk
(
APIC_VERBOSE
, "...†­iød– = %ld\n", 
d–
);

592 
d–tsc
 = ()(
Ïpic_ÿl_tsc2
 - 
Ïpic_ÿl_tsc1
);

595 
pm_»ã»nûd
 = !
	`ÿlib¿‹_by_pmtim”
(
Ïpic_ÿl_pm2
 - 
Ïpic_ÿl_pm1
,

596 &
d–
, &
d–tsc
);

599 
Ïpic_şockev’t
.
muÉ
 = 
	`div_sc
(
d–
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

600 
Ïpic_şockev’t
.
shiá
);

601 
Ïpic_şockev’t
.
max_d–_ns
 =

602 
	`şockev’t_d–2ns
(0x7FFFFF, &
Ïpic_şockev’t
);

603 
Ïpic_şockev’t
.
mš_d–_ns
 =

604 
	`şockev’t_d–2ns
(0xF, &
Ïpic_şockev’t
);

606 
ÿlib¿tiÚ_»suÉ
 = (
d–
 * 
APIC_DIVISOR
è/ 
LAPIC_CAL_LOOPS
;

608 
	`­ic_´štk
(
APIC_VERBOSE
, "..... d– %ld\n", 
d–
);

609 
	`­ic_´štk
(
APIC_VERBOSE
, "..... muÉ: %ld\n", 
Ïpic_şockev’t
.
muÉ
);

610 
	`­ic_´štk
(
APIC_VERBOSE
, "..... calibration„esult: %u\n",

611 
ÿlib¿tiÚ_»suÉ
);

613 ià(
ıu_has_tsc
) {

614 
	`­ic_´štk
(
APIC_VERBOSE
, "..... CPU clock speed is "

616 (
d–tsc
 / 
LAPIC_CAL_LOOPS
è/ (1000000 / 
HZ
),

617 (
d–tsc
 / 
LAPIC_CAL_LOOPS
è% (1000000 / 
HZ
));

620 
	`­ic_´štk
(
APIC_VERBOSE
, "..... host bus clock speed is "

622 
ÿlib¿tiÚ_»suÉ
 / (1000000 / 
HZ
),

623 
ÿlib¿tiÚ_»suÉ
 % (1000000 / 
HZ
));

628 ià(
ÿlib¿tiÚ_»suÉ
 < (1000000 / 
HZ
)) {

629 
	`loÿl_œq_’abË
();

630 
	`´_w¬nšg
("APIC frequencyoo slow, disabling‡picimer\n");

634 
Ëvt
->
ã©u»s
 &ğ~
CLOCK_EVT_FEAT_DUMMY
;

640 ià(!
pm_»ã»nûd
) {

641 
	`­ic_´štk
(
APIC_VERBOSE
, "... verify APICimer\n");

646 
Ëvt
->
ev’t_hªdËr
 = 
Ïpic_ÿl_hªdËr
;

647 
	`Ïpic_tim”_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Ëvt
);

648 
Ïpic_ÿl_loİs
 = -1;

651 
	`loÿl_œq_’abË
();

653 
Ïpic_ÿl_loİs
 <ğ
LAPIC_CAL_LOOPS
)

654 
	`ıu_»Ïx
();

657 
	`Ïpic_tim”_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Ëvt
);

660 
d–j
 = 
Ïpic_ÿl_j2
 - 
Ïpic_ÿl_j1
;

661 
	`­ic_´štk
(
APIC_VERBOSE
, "... jiff› d– = %lu\n", 
d–j
);

664 ià(
d–j
 >ğ
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

665 
	`­ic_´štk
(
APIC_VERBOSE
, "... jiffies„esult ok\n");

667 
Ëvt
->
ã©u»s
 |ğ
CLOCK_EVT_FEAT_DUMMY
;

669 
	`loÿl_œq_’abË
();

671 ià(
Ëvt
->
ã©u»s
 & 
CLOCK_EVT_FEAT_DUMMY
) {

672 
	`´_w¬nšg
("APICimer disabled dueo verification failure\n");

677 
	}
}

684 
__š™
 
	$£tup_boÙ_APIC_şock
()

692 ià(
di§bË_­ic_tim”
) {

693 
	`´_šfo
("Disabling APICimer\n");

695 ià(
	`num_possibË_ıus
() > 1) {

696 
Ïpic_şockev’t
.
muÉ
 = 1;

697 
	`£tup_APIC_tim”
();

702 
	`­ic_´štk
(
APIC_VERBOSE
, "Using†ocal APICimer interrupts.\n"

705 ià(
	`ÿlib¿‹_APIC_şock
()) {

707 ià(
	`num_possibË_ıus
() > 1)

708 
	`£tup_APIC_tim”
();

717 ià(
nmi_w©chdog
 !ğ
NMI_IO_APIC
)

718 
Ïpic_şockev’t
.
ã©u»s
 &ğ~
CLOCK_EVT_FEAT_DUMMY
;

720 
	`´_w¬nšg
("APICimer„egistered‡s dummy,"

721 " dutØnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

724 
	`£tup_APIC_tim”
();

725 
	}
}

727 
__ıuš™
 
	$£tup_£cÚd¬y_APIC_şock
()

729 
	`£tup_APIC_tim”
();

730 
	}
}

735 
	$loÿl_­ic_tim”_š‹¼u±
()

737 
ıu
 = 
	`smp_´oûssÜ_id
();

738 
şock_ev’t_deviû
 *
evt
 = &
	`³r_ıu
(
Ïpic_ev’ts
, 
ıu
);

751 ià(!
evt
->
ev’t_hªdËr
) {

752 
	`´_w¬nšg
("Spuriou LAPICim” iÁ”ru± oÀıu %d\n", 
ıu
);

754 
	`Ïpic_tim”_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

761 
	`šc_œq_¡©
(
­ic_tim”_œqs
);

763 
evt
->
	`ev’t_hªdËr
(evt);

764 
	}
}

774 
__œq_’Œy
 
	$smp_­ic_tim”_š‹¼u±
(
±_»gs
 *
»gs
)

776 
±_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

782 
	`ack_APIC_œq
();

788 
	`ex™_idË
();

789 
	`œq_’‹r
();

790 
	`loÿl_­ic_tim”_š‹¼u±
();

791 
	`œq_ex™
();

793 
	`£t_œq_»gs
(
Şd_»gs
);

794 
	}
}

796 
	$£tup_´ofšg_tim”
(
muÉl›r
)

798  -
EINVAL
;

799 
	}
}

812 
	$ş—r_loÿl_APIC
()

814 
maxlvt
;

815 
u32
 
v
;

818 ià(!
x2­ic
 && !
­ic_phys
)

821 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

826 ià(
maxlvt
 >= 3) {

827 
v
 = 
ERROR_APIC_VECTOR
;

828 
	`­ic_wr™e
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

834 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

835 
	`­ic_wr™e
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

836 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

837 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

838 
v
 = 
	`­ic_»ad
(
APIC_LVT1
);

839 
	`­ic_wr™e
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

840 ià(
maxlvt
 >= 4) {

841 
v
 = 
	`­ic_»ad
(
APIC_LVTPC
);

842 
	`­ic_wr™e
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

846 #ià
	`defšed
(
CONFIG_X86_MCE_P4THERMAL
è|| defšed(
CONFIG_X86_MCE_INTEL
)

847 ià(
maxlvt
 >= 5) {

848 
v
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

849 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

852 #ifdeà
CONFIG_X86_MCE_INTEL


853 ià(
maxlvt
 >= 6) {

854 
v
 = 
	`­ic_»ad
(
APIC_LVTCMCI
);

855 ià(!(
v
 & 
APIC_LVT_MASKED
))

856 
	`­ic_wr™e
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

863 
	`­ic_wr™e
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

864 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

865 
	`­ic_wr™e
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

866 ià(
maxlvt
 >= 3)

867 
	`­ic_wr™e
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

868 ià(
maxlvt
 >= 4)

869 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

872 ià(
	`Ïpic_is_š‹g¿‹d
()) {

873 ià(
maxlvt
 > 3)

875 
	`­ic_wr™e
(
APIC_ESR
, 0);

876 
	`­ic_»ad
(
APIC_ESR
);

878 
	}
}

883 
	$di§bË_loÿl_APIC
()

885 
v®ue
;

888 ià(!
­ic_phys
)

891 
	`ş—r_loÿl_APIC
();

897 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

898 
v®ue
 &ğ~
APIC_SPIV_APIC_ENABLED
;

899 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

901 #ifdeà
CONFIG_X86_32


906 ià(
’abËd_vŸ_­icba£
) {

907 
l
, 
h
;

909 
	`rdm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

910 
l
 &ğ~
MSR_IA32_APICBASE_ENABLE
;

911 
	`wrm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

914 
	}
}

922 
	$Ïpic_shutdown
()

924 
æags
;

926 ià(!
ıu_has_­ic
)

929 
	`loÿl_œq_§ve
(
æags
);

931 #ifdeà
CONFIG_X86_32


932 ià(!
’abËd_vŸ_­icba£
)

933 
	`ş—r_loÿl_APIC
();

936 
	`di§bË_loÿl_APIC
();

939 
	`loÿl_œq_»¡Üe
(
æags
);

940 
	}
}

947 
__š™
 
	$v”ify_loÿl_APIC
()

949 
»g0
, 
»g1
;

954 
»g0
 = 
	`­ic_»ad
(
APIC_LVR
);

955 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g0
);

956 
	`­ic_wr™e
(
APIC_LVR
, 
»g0
 ^ 
APIC_LVR_MASK
);

957 
»g1
 = 
	`­ic_»ad
(
APIC_LVR
);

958 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g1
);

965 ià(
»g1
 !ğ
»g0
)

971 
»g1
 = 
	`GET_APIC_VERSION
(
»g0
);

972 ià(
»g1
 == 0x00 ||„eg1 == 0xff)

974 
»g1
 = 
	`Ïpic_g‘_maxlvt
();

975 ià(
»g1
 < 0x02 ||„eg1 == 0xff)

981 
»g0
 = 
	`­ic_»ad
(
APIC_ID
);

982 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg ID: %x\n", 
»g0
);

983 
	`­ic_wr™e
(
APIC_ID
, 
»g0
 ^ 
­ic
->
­ic_id_mask
);

984 
»g1
 = 
	`­ic_»ad
(
APIC_ID
);

985 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg ID: %x\n", 
»g1
);

986 
	`­ic_wr™e
(
APIC_ID
, 
»g0
);

987 ià(
»g1
 !ğ(
»g0
 ^ 
­ic
->
­ic_id_mask
))

995 
»g0
 = 
	`­ic_»ad
(
APIC_LVT0
);

996 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg LVT0: %x\n", 
»g0
);

997 
»g1
 = 
	`­ic_»ad
(
APIC_LVT1
);

998 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg LVT1: %x\n", 
»g1
);

1001 
	}
}

1006 
__š™
 
	$sync_Arb_IDs
()

1012 ià(
	`mod”n_­ic
(è|| 
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
)

1018 
	`­ic_wa™_iü_idË
();

1020 
	`­ic_´štk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1021 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1022 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1023 
	}
}

1028 
__š™
 
	$š™_b¥_APIC
()

1030 
v®ue
;

1036 ià(
smp_found_cÚfig
 || !
ıu_has_­ic
)

1042 
	`ş—r_loÿl_APIC
();

1047 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

1048 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

1049 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

1051 #ifdeà
CONFIG_X86_32


1053 ià((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) &&

1054 (
boÙ_ıu_d©a
.
x86
 == 15))

1055 
v®ue
 &ğ~
APIC_SPIV_FOCUS_DISABLED
;

1058 
v®ue
 |ğ
APIC_SPIV_FOCUS_DISABLED
;

1059 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

1060 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

1065 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1066 
v®ue
 = 
APIC_DM_NMI
;

1067 ià(!
	`Ïpic_is_š‹g¿‹d
())

1068 
v®ue
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

1069 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

1070 
	}
}

1072 
__ıuš™
 
	$Ïpic_£tup_e¤
()

1074 
Şdv®ue
, 
v®ue
, 
maxlvt
;

1076 ià(!
	`Ïpic_is_š‹g¿‹d
()) {

1077 
	`´_šfo
("No ESR for 82489DX.\n");

1081 ià(
­ic
->
di§bË_e¤
) {

1088 
	`´_šfo
("Leaving ESR disabled.\n");

1092 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

1093 ià(
maxlvt
 > 3)

1094 
	`­ic_wr™e
(
APIC_ESR
, 0);

1095 
Şdv®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

1098 
v®ue
 = 
ERROR_APIC_VECTOR
;

1099 
	`­ic_wr™e
(
APIC_LVTERR
, 
v®ue
);

1104 ià(
maxlvt
 > 3)

1105 
	`­ic_wr™e
(
APIC_ESR
, 0);

1106 
v®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

1107 ià(
v®ue
 !ğ
Şdv®ue
)

1108 
	`­ic_´štk
(
APIC_VERBOSE
, "ESR value beforeƒnabling "

1110 
Şdv®ue
, 
v®ue
);

1111 
	}
}

1117 
__ıuš™
 
	$£tup_loÿl_APIC
()

1119 
v®ue
;

1120 
i
, 
j
;

1122 ià(
di§bË_­ic
) {

1123 
	`¬ch_di§bË_smp_suµÜt
();

1127 #ifdeà
CONFIG_X86_32


1129 ià(
	`Ïpic_is_š‹g¿‹d
(è&& 
­ic
->
di§bË_e¤
) {

1130 
	`­ic_wr™e
(
APIC_ESR
, 0);

1131 
	`­ic_wr™e
(
APIC_ESR
, 0);

1132 
	`­ic_wr™e
(
APIC_ESR
, 0);

1133 
	`­ic_wr™e
(
APIC_ESR
, 0);

1137 
	`´“m±_di§bË
();

1143 ià(!
­ic
->
	`­ic_id_»gi¡”ed
())

1144 
	`BUG
();

1151 
­ic
->
	`š™_­ic_ldr
();

1157 
v®ue
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

1158 
v®ue
 &ğ~
APIC_TPRI_MASK
;

1159 
	`­ic_wr™e
(
APIC_TASKPRI
, 
v®ue
);

1172 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1173 
v®ue
 = 
	`­ic_»ad
(
APIC_ISR
 + 
i
*0x10);

1174 
j
 = 31; j >= 0; j--) {

1175 ià(
v®ue
 & (1<<
j
))

1176 
	`ack_APIC_œq
();

1183 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

1184 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

1188 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

1190 #ifdeà
CONFIG_X86_32


1216 
v®ue
 &ğ~
APIC_SPIV_FOCUS_DISABLED
;

1222 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

1223 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

1235 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
è& 
APIC_LVT_MASKED
;

1236 ià(!
	`smp_´oûssÜ_id
(è&& (
pic_mode
 || !
v®ue
)) {

1237 
v®ue
 = 
APIC_DM_EXTINT
;

1238 
	`­ic_´štk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1239 
	`smp_´oûssÜ_id
());

1241 
v®ue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1242 
	`­ic_´štk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1243 
	`smp_´oûssÜ_id
());

1245 
	`­ic_wr™e
(
APIC_LVT0
, 
v®ue
);

1250 ià(!
	`smp_´oûssÜ_id
())

1251 
v®ue
 = 
APIC_DM_NMI
;

1253 
v®ue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1254 ià(!
	`Ïpic_is_š‹g¿‹d
())

1255 
v®ue
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

1256 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

1258 
	`´“m±_’abË
();

1260 #ifdeà
CONFIG_X86_MCE_INTEL


1262 ià(
	`smp_´oûssÜ_id
() == 0)

1263 
	`cmci_»check
();

1265 
	}
}

1267 
__ıuš™
 
	$’d_loÿl_APIC_£tup
()

1269 
	`Ïpic_£tup_e¤
();

1271 #ifdeà
CONFIG_X86_32


1273 
v®ue
;

1275 
v®ue
 = 
	`­ic_»ad
(
APIC_LVTT
);

1276 
v®ue
 |ğ(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1277 
	`­ic_wr™e
(
APIC_LVTT
, 
v®ue
);

1281 
	`£tup_­ic_nmi_w©chdog
(
NULL
);

1282 
	`­ic_pm_aùiv©e
();

1283 
	}
}

1285 #ifdeà
CONFIG_X86_X2APIC


1286 
	$check_x2­ic
()

1288 ià(
	`x2­ic_’abËd
()) {

1289 
	`´_šfo
("x2apicƒnabled by BIOS, switchingo x2apic ops\n");

1290 
x2­ic_´“ÇbËd
 = 
x2­ic
 = 1;

1292 
	}
}

1294 
	$’abË_x2­ic
()

1296 
m¤
, 
m¤2
;

1298 ià(!
x2­ic
)

1301 
	`rdm¤
(
MSR_IA32_APICBASE
, 
m¤
, 
m¤2
);

1302 ià(!(
m¤
 & 
X2APIC_ENABLE
)) {

1303 
	`´_šfo
("Enabling x2apic\n");

1304 
	`wrm¤
(
MSR_IA32_APICBASE
, 
m¤
 | 
X2APIC_ENABLE
, 0);

1306 
	}
}

1308 
__š™
 
	$’abË_IR_x2­ic
()

1310 #ifdeà
CONFIG_INTR_REMAP


1311 
»t
;

1312 
æags
;

1313 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
 = 
NULL
;

1315 ià(!
ıu_has_x2­ic
)

1318 ià(!
x2­ic_´“ÇbËd
 && 
di§bË_x2­ic
) {

1319 
	`´_šfo
("Skippedƒnabling x2apic‡nd Interrupt-remapping "

1324 ià(
x2­ic_´“ÇbËd
 && 
di§bË_x2­ic
)

1325 
	`·nic
("Bios‡lreadyƒnabled x2apic, can'tƒnforce‚ox2apic");

1327 ià(!
x2­ic_´“ÇbËd
 && 
sk_ißpic_£tup
) {

1328 
	`´_šfo
("Skippedƒnabling x2apic‡nd Interrupt-remapping "

1333 
»t
 = 
	`dm¬_bË_š™
();

1334 ià(
»t
) {

1335 
	`´_šfo
("dm¬_bË_š™(èçed w™h %d:\n", 
»t
);

1337 ià(
x2­ic_´“ÇbËd
)

1338 
	`·nic
("x2apicƒnabled by bios. But IRƒnabling failed");

1340 
	`´_šfo
("Notƒnabling x2apic,Intr-remapping\n");

1344 
ißpic_’Œ›s
 = 
	`®loc_ißpic_’Œ›s
();

1345 ià(!
ißpic_’Œ›s
) {

1346 
	`´_šfo
("AÎoÿ‹ ißpic_’Œ› çed: %d\n", 
»t
);

1347 
’d
;

1350 
»t
 = 
	`§ve_IO_APIC_£tup
(
ißpic_’Œ›s
);

1351 ià(
»t
) {

1352 
	`´_šfo
("Savšg IO-APIC s‹ faed: %d\n", 
»t
);

1353 
’d
;

1356 
	`loÿl_œq_§ve
(
æags
);

1357 
	`mask_IO_APIC_£tup
(
ißpic_’Œ›s
);

1358 
	`mask_8259A
();

1360 
»t
 = 
	`’abË_šŒ_»m­pšg
(
EIM_32BIT_APIC_ID
);

1362 ià(
»t
 && 
x2­ic_´“ÇbËd
) {

1363 
	`loÿl_œq_»¡Üe
(
æags
);

1364 
	`·nic
("x2apicƒnabled by bios. But IRƒnabling failed");

1367 ià(
»t
)

1368 
’d_»¡Üe
;

1370 ià(!
x2­ic
) {

1371 
x2­ic
 = 1;

1372 
	`’abË_x2­ic
();

1375 
’d_»¡Üe
:

1376 ià(
»t
)

1380 
	`»¡Üe_IO_APIC_£tup
(
ißpic_’Œ›s
);

1382 
	`»š™_šŒ_»m­³d_IO_APIC
(
x2­ic_´“ÇbËd
, 
ißpic_’Œ›s
);

1384 
	`unmask_8259A
();

1385 
	`loÿl_œq_»¡Üe
(
æags
);

1387 
’d
:

1388 ià(!
»t
) {

1389 ià(!
x2­ic_´“ÇbËd
)

1390 
	`´_šfo
("Enabled x2apic‡nd interrupt-remapping\n");

1392 
	`´_šfo
("Enabled Interrupt-remapping\n");

1394 
	`´_”r
("Failedoƒnable Interrupt-remapping‡nd x2apic\n");

1395 ià(
ißpic_’Œ›s
)

1396 
	`ä“_ißpic_’Œ›s
(
ißpic_’Œ›s
);

1398 ià(!
ıu_has_x2­ic
)

1401 ià(
x2­ic_´“ÇbËd
)

1402 
	`·nic
("x2apicƒnabled…rior OS handover,"

1405 
	`´_šfo
("Enable CONFIG_INTR_REMAP forƒnabling intr-remapping "

1410 
	}
}

1413 #ifdeà
CONFIG_X86_64


1420 
__š™
 
	$d‘eù_š™_APIC
()

1422 ià(!
ıu_has_­ic
) {

1423 
	`´_šfo
("No†ocal APIC…resent\n");

1427 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1428 
boÙ_ıu_physiÿl_­icid
 = 0;

1430 
	}
}

1435 
__š™
 
	$d‘eù_š™_APIC
()

1437 
u32
 
h
, 
l
, 
ã©u»s
;

1440 ià(
di§bË_­ic
)

1443 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

1444 
X86_VENDOR_AMD
:

1445 ià((
boÙ_ıu_d©a
.
x86
 =ğ6 && boÙ_ıu_d©a.
x86_mod–
 > 1) ||

1446 (
boÙ_ıu_d©a
.
x86
 >= 15))

1448 
no_­ic
;

1449 
X86_VENDOR_INTEL
:

1450 ià(
boÙ_ıu_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1451 (
boÙ_ıu_d©a
.
x86
 =ğ5 && 
ıu_has_­ic
))

1453 
no_­ic
;

1455 
no_­ic
;

1458 ià(!
ıu_has_­ic
) {

1463 ià(!
fÜû_’abË_loÿl_­ic
) {

1464 
	`´_šfo
("Local APIC disabled by BIOS -- "

1473 
	`rdm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1474 ià(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1475 
	`´_šfo
("Local APIC disabled by BIOS --„eenabling.\n");

1476 
l
 &ğ~
MSR_IA32_APICBASE_BASE
;

1477 
l
 |ğ
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1478 
	`wrm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1479 
’abËd_vŸ_­icba£
 = 1;

1486 
ã©u»s
 = 
	`ıuid_edx
(1);

1487 ià(!(
ã©u»s
 & (1 << 
X86_FEATURE_APIC
))) {

1488 
	`´_w¬nšg
("Could‚otƒnable APIC!\n");

1491 
	`£t_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_APIC
);

1492 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1495 
	`rdm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1496 ià(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1497 
mp_Ïpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1499 
	`´_šfo
("Found‡ndƒnabled†ocal APIC!\n");

1501 
	`­ic_pm_aùiv©e
();

1505 
no_­ic
:

1506 
	`´_šfo
("No†ocal APIC…resent or hardware disabled\n");

1508 
	}
}

1511 #ifdeà
CONFIG_X86_64


1512 
__š™
 
	$—¾y_š™_Ïpic_m­pšg
()

1514 
phys_addr
;

1520 ià(!
smp_found_cÚfig
)

1523 
phys_addr
 = 
mp_Ïpic_addr
;

1525 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
phys_addr
);

1526 
	`­ic_´štk
(
APIC_VERBOSE
, "mapped APICo %16lx (%16lx)\n",

1527 
APIC_BASE
, 
phys_addr
);

1533 
boÙ_ıu_physiÿl_­icid
 = 
	`»ad_­ic_id
();

1534 
	}
}

1540 
__š™
 
	$š™_­ic_m­pšgs
()

1542 ià(
x2­ic
) {

1543 
boÙ_ıu_physiÿl_­icid
 = 
	`»ad_­ic_id
();

1552 ià(!
smp_found_cÚfig
 && 
	`d‘eù_š™_APIC
()) {

1553 
­ic_phys
 = (è
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

1554 
­ic_phys
 = 
	`__·
(apic_phys);

1556 
­ic_phys
 = 
mp_Ïpic_addr
;

1558 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
­ic_phys
);

1559 
	`­ic_´štk
(
APIC_VERBOSE
, "mapped APICo %08lx (%08lx)\n",

1560 
APIC_BASE
, 
­ic_phys
);

1566 ià(
boÙ_ıu_physiÿl_­icid
 == -1U)

1567 
boÙ_ıu_physiÿl_­icid
 = 
	`»ad_­ic_id
();

1568 
	}
}

1574 
	g­ic_v”siÚ
[
MAX_APICS
];

1576 
__š™
 
	$APIC_š™_unroûssÜ
()

1578 ià(
di§bË_­ic
) {

1579 
	`´_šfo
("Apic disabled\n");

1582 #ifdeà
CONFIG_X86_64


1583 ià(!
ıu_has_­ic
) {

1584 
di§bË_­ic
 = 1;

1585 
	`´_šfo
("Apic disabled by BIOS\n");

1589 ià(!
smp_found_cÚfig
 && !
ıu_has_­ic
)

1595 ià(!
ıu_has_­ic
 &&

1596 
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])) {

1597 
	`´_”r
("BIOS bug,†ocal APIC 0x%x‚ot detected!...\n",

1598 
boÙ_ıu_physiÿl_­icid
);

1599 
	`ş—r_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_APIC
);

1604 
	`’abË_IR_x2­ic
();

1605 #ifdeà
CONFIG_X86_64


1606 
	`deçuÉ_£tup_­ic_routšg
();

1609 
	`v”ify_loÿl_APIC
();

1610 
	`cÚÃù_b¥_APIC
();

1612 #ifdeà
CONFIG_X86_64


1613 
	`­ic_wr™e
(
APIC_ID
, 
	`SET_APIC_ID
(
boÙ_ıu_physiÿl_­icid
));

1620 #ifdeà
CONFIG_CRASH_DUMP


1621 
boÙ_ıu_physiÿl_­icid
 = 
	`»ad_­ic_id
();

1624 
	`physid_£t_mask_of_physid
(
boÙ_ıu_physiÿl_­icid
, &
phys_ıu_´e£Á_m­
);

1625 
	`£tup_loÿl_APIC
();

1627 #ifdeà
CONFIG_X86_IO_APIC


1632 ià(!
sk_ißpic_£tup
 && 
Ä_ißpics
)

1633 
	`’abË_IO_APIC
();

1636 
	`’d_loÿl_APIC_£tup
();

1638 #ifdeà
CONFIG_X86_IO_APIC


1639 ià(
smp_found_cÚfig
 && !
sk_ißpic_£tup
 && 
Ä_ißpics
)

1640 
	`£tup_IO_APIC
();

1642 
Ä_ißpics
 = 0;

1643 
	`loÿli£_nmi_w©chdog
();

1646 
	`loÿli£_nmi_w©chdog
();

1649 
	`£tup_boÙ_şock
();

1650 #ifdeà
CONFIG_X86_64


1651 
	`check_nmi_w©chdog
();

1655 
	}
}

1664 
	$smp_¥urious_š‹¼u±
(
±_»gs
 *
»gs
)

1666 
u32
 
v
;

1668 
	`ex™_idË
();

1669 
	`œq_’‹r
();

1675 
v
 = 
	`­ic_»ad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1676 ià(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1677 
	`ack_APIC_œq
();

1679 
	`šc_œq_¡©
(
œq_¥urious_couÁ
);

1682 
	`´_šfo
("spurious APIC interrupt on CPU#%d, "

1683 "should‚ev” h­³n.\n", 
	`smp_´oûssÜ_id
());

1684 
	`œq_ex™
();

1685 
	}
}

1690 
	$smp_”rÜ_š‹¼u±
(
±_»gs
 *
»gs
)

1692 
u32
 
v
, 
v1
;

1694 
	`ex™_idË
();

1695 
	`œq_’‹r
();

1697 
v
 = 
	`­ic_»ad
(
APIC_ESR
);

1698 
	`­ic_wr™e
(
APIC_ESR
, 0);

1699 
v1
 = 
	`­ic_»ad
(
APIC_ESR
);

1700 
	`ack_APIC_œq
();

1701 
	`©omic_šc
(&
œq_”r_couÁ
);

1714 
	`´_debug
("APICƒrror on CPU%d: %02x(%02x)\n",

1715 
	`smp_´oûssÜ_id
(), 
v
 , 
v1
);

1716 
	`œq_ex™
();

1717 
	}
}

1722 
__š™
 
	$cÚÃù_b¥_APIC
()

1724 #ifdeà
CONFIG_X86_32


1725 ià(
pic_mode
) {

1729 
	`ş—r_loÿl_APIC
();

1734 
	`­ic_´štk
(
APIC_VERBOSE
, "leaving PIC mode, "

1736 
	`outb
(0x70, 0x22);

1737 
	`outb
(0x01, 0x23);

1740 ià(
­ic
->
’abË_­ic_mode
)

1741 
­ic
->
	`’abË_­ic_mode
();

1742 
	}
}

1751 
	$discÚÃù_b¥_APIC
(
vœt_wœe_£tup
)

1753 
v®ue
;

1755 #ifdeà
CONFIG_X86_32


1756 ià(
pic_mode
) {

1763 
	`­ic_´štk
(
APIC_VERBOSE
, "disabling APIC mode, "

1765 
	`outb
(0x70, 0x22);

1766 
	`outb
(0x00, 0x23);

1774 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

1775 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

1776 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

1777 
v®ue
 |= 0xf;

1778 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

1780 ià(!
vœt_wœe_£tup
) {

1785 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
);

1786 
v®ue
 &ğ~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1787 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1788 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1789 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1790 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_EXTINT
);

1791 
	`­ic_wr™e
(
APIC_LVT0
, 
v®ue
);

1794 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1801 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT1
);

1802 
v®ue
 &ğ~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1803 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1804 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1805 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1806 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_NMI
);

1807 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

1808 
	}
}

1810 
__ıuš™
 
	$g’”ic_´oûssÜ_šfo
(
­icid
, 
v”siÚ
)

1812 
ıu
;

1817 ià(
v”siÚ
 == 0x0) {

1818 
	`´_w¬nšg
("BIOS bug, APIC version is 0 for CPU#%d! "

1820 
v”siÚ
);

1821 
v”siÚ
 = 0x10;

1823 
­ic_v”siÚ
[
­icid
] = 
v”siÚ
;

1825 ià(
num_´oûssÜs
 >ğ
Ä_ıu_ids
) {

1826 
max
 = 
Ä_ıu_ids
;

1827 
thisıu
 = 
max
 + 
di§bËd_ıus
;

1829 
	`´_w¬nšg
(

1831 " ProûssÜ %d/0x%x ignÜed.\n", 
max
, 
thisıu
, 
­icid
);

1833 
di§bËd_ıus
++;

1837 
num_´oûssÜs
++;

1838 
ıu
 = 
	`ıumask_Ãxt_z”o
(-1, 
ıu_´e£Á_mask
);

1840 ià(
v”siÚ
 !ğ
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])

1841 
	`WARN_ONCE
(1,

1843 
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
], 
ıu
, 
v”siÚ
);

1845 
	`physid_£t
(
­icid
, 
phys_ıu_´e£Á_m­
);

1846 ià(
­icid
 =ğ
boÙ_ıu_physiÿl_­icid
) {

1852 
ıu
 = 0;

1854 ià(
­icid
 > 
max_physiÿl_­icid
)

1855 
max_physiÿl_­icid
 = 
­icid
;

1857 #ifdeà
CONFIG_X86_32


1865 ià(
max_physiÿl_­icid
 >= 8) {

1866 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

1867 
X86_VENDOR_INTEL
:

1868 ià(!
	`APIC_XAPIC
(
v”siÚ
)) {

1869 
def_to_bigsmp
 = 0;

1873 
X86_VENDOR_AMD
:

1874 
def_to_bigsmp
 = 1;

1879 #ià
	`defšed
(
CONFIG_SMP
è|| defšed(
CONFIG_X86_64
)

1880 
	`—¾y_³r_ıu
(
x86_ıu_to_­icid
, 
ıu
èğ
­icid
;

1881 
	`—¾y_³r_ıu
(
x86_bios_ıu_­icid
, 
ıu
èğ
­icid
;

1884 
	`£t_ıu_possibË
(
ıu
, 
Œue
);

1885 
	`£t_ıu_´e£Á
(
ıu
, 
Œue
);

1886 
	}
}

1888 
	$h¬d_smp_´oûssÜ_id
()

1890  
	`»ad_­ic_id
();

1891 
	}
}

1893 
	$deçuÉ_š™_­ic_ldr
()

1895 
v®
;

1897 
	`­ic_wr™e
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1898 
v®
 = 
	`­ic_»ad
(
APIC_LDR
è& ~
APIC_LDR_MASK
;

1899 
v®
 |ğ
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_´oûssÜ_id
());

1900 
	`­ic_wr™e
(
APIC_LDR
, 
v®
);

1901 
	}
}

1903 #ifdeà
CONFIG_X86_32


1904 
	$deçuÉ_­icid_to_node
(
logiÿl_­icid
)

1906 #ifdeà
CONFIG_SMP


1907  
­icid_2_node
[
	`h¬d_smp_´oûssÜ_id
()];

1911 
	}
}

1917 #ifdeà
CONFIG_PM


1925 
	maùive
;

1927 
	m­ic_id
;

1928 
	m­ic_sk´i
;

1929 
	m­ic_ldr
;

1930 
	m­ic_dä
;

1931 
	m­ic_¥iv
;

1932 
	m­ic_lv‰
;

1933 
	m­ic_lvc
;

1934 
	m­ic_lvt0
;

1935 
	m­ic_lvt1
;

1936 
	m­ic_lv‹¼
;

1937 
	m­ic_tmiù
;

1938 
	m­ic_tdü
;

1939 
	m­ic_thmr
;

1940 } 
	g­ic_pm_¡©e
;

1942 
	$Ïpic_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

1944 
æags
;

1945 
maxlvt
;

1947 ià(!
­ic_pm_¡©e
.
aùive
)

1950 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

1952 
­ic_pm_¡©e
.
­ic_id
 = 
	`­ic_»ad
(
APIC_ID
);

1953 
­ic_pm_¡©e
.
­ic_sk´i
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

1954 
­ic_pm_¡©e
.
­ic_ldr
 = 
	`­ic_»ad
(
APIC_LDR
);

1955 
­ic_pm_¡©e
.
­ic_dä
 = 
	`­ic_»ad
(
APIC_DFR
);

1956 
­ic_pm_¡©e
.
­ic_¥iv
 = 
	`­ic_»ad
(
APIC_SPIV
);

1957 
­ic_pm_¡©e
.
­ic_lv‰
 = 
	`­ic_»ad
(
APIC_LVTT
);

1958 ià(
maxlvt
 >= 4)

1959 
­ic_pm_¡©e
.
­ic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

1960 
­ic_pm_¡©e
.
­ic_lvt0
 = 
	`­ic_»ad
(
APIC_LVT0
);

1961 
­ic_pm_¡©e
.
­ic_lvt1
 = 
	`­ic_»ad
(
APIC_LVT1
);

1962 
­ic_pm_¡©e
.
­ic_lv‹¼
 = 
	`­ic_»ad
(
APIC_LVTERR
);

1963 
­ic_pm_¡©e
.
­ic_tmiù
 = 
	`­ic_»ad
(
APIC_TMICT
);

1964 
­ic_pm_¡©e
.
­ic_tdü
 = 
	`­ic_»ad
(
APIC_TDCR
);

1965 #ià
	`defšed
(
CONFIG_X86_MCE_P4THERMAL
è|| defšed(
CONFIG_X86_MCE_INTEL
)

1966 ià(
maxlvt
 >= 5)

1967 
­ic_pm_¡©e
.
­ic_thmr
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

1970 
	`loÿl_œq_§ve
(
æags
);

1971 
	`di§bË_loÿl_APIC
();

1972 #ifdeà
CONFIG_INTR_REMAP


1973 ià(
šŒ_»m­pšg_’abËd
)

1974 
	`di§bË_šŒ_»m­pšg
();

1976 
	`loÿl_œq_»¡Üe
(
æags
);

1978 
	}
}

1980 
	$Ïpic_»sume
(
sys_deviû
 *
dev
)

1982 
l
, 
h
;

1983 
æags
;

1984 
maxlvt
;

1986 #ifdeà
CONFIG_INTR_REMAP


1987 
»t
;

1988 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
 = 
NULL
;

1990 ià(!
­ic_pm_¡©e
.
aùive
)

1993 
	`loÿl_œq_§ve
(
æags
);

1994 ià(
x2­ic
) {

1995 
ißpic_’Œ›s
 = 
	`®loc_ißpic_’Œ›s
();

1996 ià(!
ißpic_’Œ›s
) {

1997 
	`WARN
(1, "Alloc ioapic_entries in†apic„esume failed.");

1998  -
ENOMEM
;

2001 
»t
 = 
	`§ve_IO_APIC_£tup
(
ißpic_’Œ›s
);

2002 ià(
»t
) {

2003 
	`WARN
(1, "Savšg IO-APIC s‹ faed: %d\n", 
»t
);

2004 
	`ä“_ißpic_’Œ›s
(
ißpic_’Œ›s
);

2005  
»t
;

2008 
	`mask_IO_APIC_£tup
(
ißpic_’Œ›s
);

2009 
	`mask_8259A
();

2010 
	`’abË_x2­ic
();

2013 ià(!
­ic_pm_¡©e
.
aùive
)

2016 
	`loÿl_œq_§ve
(
æags
);

2017 ià(
x2­ic
)

2018 
	`’abË_x2­ic
();

2028 
	`rdm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2029 
l
 &ğ~
MSR_IA32_APICBASE_BASE
;

2030 
l
 |ğ
MSR_IA32_APICBASE_ENABLE
 | 
mp_Ïpic_addr
;

2031 
	`wrm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2034 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

2035 
	`­ic_wr™e
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2036 
	`­ic_wr™e
(
APIC_ID
, 
­ic_pm_¡©e
.
­ic_id
);

2037 
	`­ic_wr™e
(
APIC_DFR
, 
­ic_pm_¡©e
.
­ic_dä
);

2038 
	`­ic_wr™e
(
APIC_LDR
, 
­ic_pm_¡©e
.
­ic_ldr
);

2039 
	`­ic_wr™e
(
APIC_TASKPRI
, 
­ic_pm_¡©e
.
­ic_sk´i
);

2040 
	`­ic_wr™e
(
APIC_SPIV
, 
­ic_pm_¡©e
.
­ic_¥iv
);

2041 
	`­ic_wr™e
(
APIC_LVT0
, 
­ic_pm_¡©e
.
­ic_lvt0
);

2042 
	`­ic_wr™e
(
APIC_LVT1
, 
­ic_pm_¡©e
.
­ic_lvt1
);

2043 #ià
	`defšed
(
CONFIG_X86_MCE_P4THERMAL
è|| defšed(
CONFIG_X86_MCE_INTEL
)

2044 ià(
maxlvt
 >= 5)

2045 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
­ic_pm_¡©e
.
­ic_thmr
);

2047 ià(
maxlvt
 >= 4)

2048 
	`­ic_wr™e
(
APIC_LVTPC
, 
­ic_pm_¡©e
.
­ic_lvc
);

2049 
	`­ic_wr™e
(
APIC_LVTT
, 
­ic_pm_¡©e
.
­ic_lv‰
);

2050 
	`­ic_wr™e
(
APIC_TDCR
, 
­ic_pm_¡©e
.
­ic_tdü
);

2051 
	`­ic_wr™e
(
APIC_TMICT
, 
­ic_pm_¡©e
.
­ic_tmiù
);

2052 
	`­ic_wr™e
(
APIC_ESR
, 0);

2053 
	`­ic_»ad
(
APIC_ESR
);

2054 
	`­ic_wr™e
(
APIC_LVTERR
, 
­ic_pm_¡©e
.
­ic_lv‹¼
);

2055 
	`­ic_wr™e
(
APIC_ESR
, 0);

2056 
	`­ic_»ad
(
APIC_ESR
);

2058 #ifdeà
CONFIG_INTR_REMAP


2059 ià(
šŒ_»m­pšg_’abËd
)

2060 
	`»’abË_šŒ_»m­pšg
(
EIM_32BIT_APIC_ID
);

2062 ià(
x2­ic
) {

2063 
	`unmask_8259A
();

2064 
	`»¡Üe_IO_APIC_£tup
(
ißpic_’Œ›s
);

2065 
	`ä“_ißpic_’Œ›s
(
ißpic_’Œ›s
);

2069 
	`loÿl_œq_»¡Üe
(
æags
);

2073 
	}
}

2080 
sysdev_şass
 
	gÏpic_sysşass
 = {

2081 .
Çme
 = "lapic",

2082 .
	g»sume
 = 
Ïpic_»sume
,

2083 .
	gsu¥’d
 = 
Ïpic_su¥’d
,

2086 
sys_deviû
 
	gdeviû_Ïpic
 = {

2087 .
id
 = 0,

2088 .
	gşs
 = &
Ïpic_sysşass
,

2091 
__ıuš™
 
	$­ic_pm_aùiv©e
()

2093 
­ic_pm_¡©e
.
aùive
 = 1;

2094 
	}
}

2096 
__š™
 
	$š™_Ïpic_sysfs
()

2098 
”rÜ
;

2100 ià(!
ıu_has_­ic
)

2104 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
Ïpic_sysşass
);

2105 ià(!
”rÜ
)

2106 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_Ïpic
);

2107  
”rÜ
;

2108 
	}
}

2111 
cÜe_š™ÿÎ
(
š™_Ïpic_sysfs
);

2115 
	$­ic_pm_aùiv©e
(è{ 
	}
}

2119 #ifdeà
CONFIG_X86_64


2129 
__ıuš™
 
	$­ic_is_şu¡”ed_box
()

2131 
i
, 
şu¡”s
, 
z”os
;

2132 
id
;

2133 
u16
 *
bios_ıu_­icid
;

2134 
	`DECLARE_BITMAP
(
şu¡”m­
, 
NUM_APIC_CLUSTERS
);

2142 ià((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
è&& !
	`is_vsmp_box
())

2145 
bios_ıu_­icid
 = 
	`—¾y_³r_ıu_±r
(
x86_bios_ıu_­icid
);

2146 
	`b™m­_z”o
(
şu¡”m­
, 
NUM_APIC_CLUSTERS
);

2148 
i
 = 0; i < 
Ä_ıu_ids
; i++) {

2150 ià(
bios_ıu_­icid
) {

2151 
id
 = 
bios_ıu_­icid
[
i
];

2152 } ià(
i
 < 
Ä_ıu_ids
) {

2153 ià(
	`ıu_´e£Á
(
i
))

2154 
id
 = 
	`³r_ıu
(
x86_bios_ıu_­icid
, 
i
);

2160 ià(
id
 !ğ
BAD_APICID
)

2161 
	`__£t_b™
(
	`APIC_CLUSTERID
(
id
), 
şu¡”m­
);

2170 
şu¡”s
 = 0;

2171 
z”os
 = 0;

2172 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2173 ià(
	`‹¡_b™
(
i
, 
şu¡”m­
)) {

2174 
şu¡”s
 +ğ1 + 
z”os
;

2175 
z”os
 = 0;

2177 ++
z”os
;

2183 ià(
	`is_vsmp_box
(è&& 
şu¡”s
 > 1)

2191  (
şu¡”s
 > 2);

2192 
	}
}

2198 
__š™
 
	$£tup_di§bË­ic
(*
¬g
)

2200 
di§bË_­ic
 = 1;

2201 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_APIC
);

2203 
	}
}

2204 
—¾y_·¿m
("di§bË­ic", 
£tup_di§bË­ic
);

2207 
__š™
 
	$£tup_nŞ­ic
(*
¬g
)

2209  
	`£tup_di§bË­ic
(
¬g
);

2210 
	}
}

2211 
—¾y_·¿m
("nŞ­ic", 
£tup_nŞ­ic
);

2213 
__š™
 
	$·r£_Ïpic_tim”_c2_ok
(*
¬g
)

2215 
loÿl_­ic_tim”_c2_ok
 = 1;

2217 
	}
}

2218 
—¾y_·¿m
("Ïpic_tim”_c2_ok", 
·r£_Ïpic_tim”_c2_ok
);

2220 
__š™
 
	$·r£_di§bË_­ic_tim”
(*
¬g
)

2222 
di§bË_­ic_tim”
 = 1;

2224 
	}
}

2225 
—¾y_·¿m
("nßpiùim”", 
·r£_di§bË_­ic_tim”
);

2227 
__š™
 
	$·r£_nŞ­ic_tim”
(*
¬g
)

2229 
di§bË_­ic_tim”
 = 1;

2231 
	}
}

2232 
—¾y_·¿m
("nŞ­ic_tim”", 
·r£_nŞ­ic_tim”
);

2234 
__š™
 
	$­ic_£t_v”bos™y
(*
¬g
)

2236 ià(!
¬g
) {

2237 #ifdeà
CONFIG_X86_64


2238 
sk_ißpic_£tup
 = 0;

2241  -
EINVAL
;

2244 ià(
	`¡rcmp
("debug", 
¬g
) == 0)

2245 
­ic_v”bos™y
 = 
APIC_DEBUG
;

2246 ià(
	`¡rcmp
("v”bo£", 
¬g
) == 0)

2247 
­ic_v”bos™y
 = 
APIC_VERBOSE
;

2249 
	`´_w¬nšg
("APIC Verbosity†evel %s‚ot„ecognised"

2250 " u£‡pic=v”bo£ o¸­ic=debug\n", 
¬g
);

2251  -
EINVAL
;

2255 
	}
}

2256 
—¾y_·¿m
("­ic", 
­ic_£t_v”bos™y
);

2258 
__š™
 
	$Ïpic_š£¹_»sourû
()

2260 ià(!
­ic_phys
)

2264 
Ïpic_»sourû
.
¡¬t
 = 
­ic_phys
;

2265 
Ïpic_»sourû
.
’d
 =†­ic_»sourû.
¡¬t
 + 
PAGE_SIZE
 - 1;

2266 
	`š£¹_»sourû
(&
iomem_»sourû
, &
Ïpic_»sourû
);

2269 
	}
}

2275 
Ï‹_š™ÿÎ
(
Ïpic_š£¹_»sourû
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/th»ads.h
>

13 
	~<lšux/ıumask.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/ùy³.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/h¬dœq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/­ic.h
>

21 
	~<asm/i.h
>

23 #ifdeà
CONFIG_ACPI


24 
	~<aıi/aıi_bus.h
>

27 
	$æ©_aıi_madt_Ûm_check
(*
Ûm_id
, *
Ûm_bË_id
)

30 
	}
}

32 cÚ¡ 
ıumask
 *
	$æ©_rg‘_ıus
()

34  
ıu_Úlše_mask
;

35 
	}
}

37 
	$æ©_veùÜ_®loÿtiÚ_domaš
(
ıu
, 
ıumask
 *
»tmask
)

47 
	`ıumask_ş—r
(
»tmask
);

48 
	`ıumask_b™s
(
»tmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$æ©_š™_­ic_ldr
()

60 
v®
;

61 
num
, 
id
;

63 
num
 = 
	`smp_´oûssÜ_id
();

64 
id
 = 1UL << 
num
;

65 
	`­ic_wr™e
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
v®
 = 
	`­ic_»ad
(
APIC_LDR
è& ~
APIC_LDR_MASK
;

67 
v®
 |ğ
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`­ic_wr™e
(
APIC_LDR
, 
v®
);

69 
	}
}

71 
šlše
 
	$_æ©_£nd_IPI_mask
(
mask
, 
veùÜ
)

73 
æags
;

75 
	`loÿl_œq_§ve
(
æags
);

76 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(
mask
, 
veùÜ
, 
­ic
->
de¡_logiÿl
);

77 
	`loÿl_œq_»¡Üe
(
æags
);

78 
	}
}

80 
	$æ©_£nd_IPI_mask
(cÚ¡ 
ıumask
 *ıumask, 
veùÜ
)

82 
mask
 = 
	`ıumask_b™s
(
ıumask
)[0];

84 
	`_æ©_£nd_IPI_mask
(
mask
, 
veùÜ
);

85 
	}
}

88 
	$æ©_£nd_IPI_mask_®lbut£lf
(cÚ¡ 
ıumask
 *ıumask, 
veùÜ
)

90 
mask
 = 
	`ıumask_b™s
(
ıumask
)[0];

91 
ıu
 = 
	`smp_´oûssÜ_id
();

93 ià(
ıu
 < 
BITS_PER_LONG
)

94 
	`ş—r_b™
(
ıu
, &
mask
);

96 
	`_æ©_£nd_IPI_mask
(
mask
, 
veùÜ
);

97 
	}
}

99 
	$æ©_£nd_IPI_®lbut£lf
(
veùÜ
)

101 
ıu
 = 
	`smp_´oûssÜ_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hÙ¶ug
 = 1;

105 
hÙ¶ug
 = 0;

107 ià(
hÙ¶ug
 || 
veùÜ
 =ğ
NMI_VECTOR
) {

108 ià(!
	`ıumask_equ®
(
ıu_Úlše_mask
, 
	`ıumask_of
(
ıu
))) {

109 
mask
 = 
	`ıumask_b™s
(
ıu_Úlše_mask
)[0];

111 ià(
ıu
 < 
BITS_PER_LONG
)

112 
	`ş—r_b™
(
ıu
, &
mask
);

114 
	`_æ©_£nd_IPI_mask
(
mask
, 
veùÜ
);

116 } ià(
	`num_Úlše_ıus
() > 1) {

117 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_ALLBUT
,

118 
veùÜ
, 
­ic
->
de¡_logiÿl
);

120 
	}
}

122 
	$æ©_£nd_IPI_®l
(
veùÜ
)

124 ià(
veùÜ
 =ğ
NMI_VECTOR
) {

125 
	`æ©_£nd_IPI_mask
(
ıu_Úlše_mask
, 
veùÜ
);

127 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_ALLINC
,

128 
veùÜ
, 
­ic
->
de¡_logiÿl
);

130 
	}
}

132 
	$æ©_g‘_­ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_­ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$»ad_x­ic_id
()

151 
id
;

153 
id
 = 
	`æ©_g‘_­ic_id
(
	`­ic_»ad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$æ©_­ic_id_»gi¡”ed
()

159  
	`physid_is£t
(
	`»ad_x­ic_id
(), 
phys_ıu_´e£Á_m­
);

160 
	}
}

162 
	$æ©_phys_pkg_id
(
š™Ÿl_­ic_id
, 
šdex_msb
)

164  
	`h¬d_smp_´oûssÜ_id
(è>> 
šdex_msb
;

165 
	}
}

167 
­ic
 
	g­ic_æ©
 = {

168 .
Çme
 = "flat",

169 .
	g´obe
 = 
NULL
,

170 .
	gaıi_madt_Ûm_check
 = 
æ©_aıi_madt_Ûm_check
,

171 .
	g­ic_id_»gi¡”ed
 = 
æ©_­ic_id_»gi¡”ed
,

173 .
	gœq_d–iv”y_mode
 = 
de¡_Lowe¡Prio
,

174 .
	gœq_de¡_mode
 = 1,

176 .
	grg‘_ıus
 = 
æ©_rg‘_ıus
,

177 .
	gdi§bË_e¤
 = 0,

178 .
	gde¡_logiÿl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_­icid_u£d
 = 
NULL
,

180 .
	gcheck_­icid_´e£Á
 = 
NULL
,

182 .
	gveùÜ_®loÿtiÚ_domaš
 = 
æ©_veùÜ_®loÿtiÚ_domaš
,

183 .
	gš™_­ic_ldr
 = 
æ©_š™_­ic_ldr
,

185 .
	gißpic_phys_id_m­
 = 
NULL
,

186 .
	g£tup_­ic_routšg
 = 
NULL
,

187 .
	gmuÉi_tim”_check
 = 
NULL
,

188 .
	g­icid_to_node
 = 
NULL
,

189 .
	gıu_to_logiÿl_­icid
 = 
NULL
,

190 .
	gıu_´e£Á_to_­icid
 = 
deçuÉ_ıu_´e£Á_to_­icid
,

191 .
	g­icid_to_ıu_´e£Á
 = 
NULL
,

192 .
	g£tup_pÜtio_»m­
 = 
NULL
,

193 .
	gcheck_phys_­icid_´e£Á
 = 
deçuÉ_check_phys_­icid_´e£Á
,

194 .
	g’abË_­ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
æ©_phys_pkg_id
,

196 .
	gmps_Ûm_check
 = 
NULL
,

198 .
	gg‘_­ic_id
 = 
æ©_g‘_­ic_id
,

199 .
	g£t_­ic_id
 = 
£t_­ic_id
,

200 .
	g­ic_id_mask
 = 0xFFu << 24,

202 .
	gıu_mask_to_­icid
 = 
deçuÉ_ıu_mask_to_­icid
,

203 .
	gıu_mask_to_­icid_ªd
 = 
deçuÉ_ıu_mask_to_­icid_ªd
,

205 .
	g£nd_IPI_mask
 = 
æ©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_®lbut£lf
 = 
æ©_£nd_IPI_mask_®lbut£lf
,

207 .
	g£nd_IPI_®lbut£lf
 = 
æ©_£nd_IPI_®lbut£lf
,

208 .
	g£nd_IPI_®l
 = 
æ©_£nd_IPI_®l
,

209 .
	g£nd_IPI_£lf
 = 
­ic_£nd_IPI_£lf
,

211 .
	gŒampŞše_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gŒampŞše_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwa™_fÜ_š™_d—s£¹
 = 
NULL
,

214 .
	gsmp_ÿÎš_ş—r_loÿl_­ic
 = 
NULL
,

215 .
	gšquœe_»mÙe_­ic
 = 
deçuÉ_šquœe_»mÙe_­ic
,

217 .
	g»ad
 = 
Çtive_­ic_mem_»ad
,

218 .
	gwr™e
 = 
Çtive_­ic_mem_wr™e
,

219 .
	giü_»ad
 = 
Çtive_­ic_iü_»ad
,

220 .
	giü_wr™e
 = 
Çtive_­ic_iü_wr™e
,

221 .
	gwa™_iü_idË
 = 
Çtive_­ic_wa™_iü_idË
,

222 .
	g§ã_wa™_iü_idË
 = 
Çtive_§ã_­ic_wa™_iü_idË
,

230 
	$physæ©_aıi_madt_Ûm_check
(*
Ûm_id
, *
Ûm_bË_id
)

232 #ifdeà
CONFIG_ACPI


238 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 > 
FADT2_REVISION_ID
 &&

239 (
aıi_gbl_FADT
.
æags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`´štk
(
KERN_DEBUG
 "system APIC only can use…hysical flat");

246 
	}
}

248 cÚ¡ 
ıumask
 *
	$physæ©_rg‘_ıus
()

250  
ıu_Úlše_mask
;

251 
	}
}

253 
	$physæ©_veùÜ_®loÿtiÚ_domaš
(
ıu
, 
ıumask
 *
»tmask
)

255 
	`ıumask_ş—r
(
»tmask
);

256 
	`ıumask_£t_ıu
(
ıu
, 
»tmask
);

257 
	}
}

259 
	$physæ©_£nd_IPI_mask
(cÚ¡ 
ıumask
 *ıumask, 
veùÜ
)

261 
	`deçuÉ_£nd_IPI_mask_£qu’û_phys
(
ıumask
, 
veùÜ
);

262 
	}
}

264 
	$physæ©_£nd_IPI_mask_®lbut£lf
(cÚ¡ 
ıumask
 *cpumask,

265 
veùÜ
)

267 
	`deçuÉ_£nd_IPI_mask_®lbut£lf_phys
(
ıumask
, 
veùÜ
);

268 
	}
}

270 
	$physæ©_£nd_IPI_®lbut£lf
(
veùÜ
)

272 
	`deçuÉ_£nd_IPI_mask_®lbut£lf_phys
(
ıu_Úlše_mask
, 
veùÜ
);

273 
	}
}

275 
	$physæ©_£nd_IPI_®l
(
veùÜ
)

277 
	`physæ©_£nd_IPI_mask
(
ıu_Úlše_mask
, 
veùÜ
);

278 
	}
}

280 
	$physæ©_ıu_mask_to_­icid
(cÚ¡ 
ıumask
 *cpumask)

282 
ıu
;

288 
ıu
 = 
	`ıumask_fœ¡
(
ıumask
);

289 ià(()
ıu
 < 
Ä_ıu_ids
)

290  
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
);

292  
BAD_APICID
;

293 
	}
}

296 
	$physæ©_ıu_mask_to_­icid_ªd
(cÚ¡ 
ıumask
 *cpumask,

297 cÚ¡ 
ıumask
 *
ªdmask
)

299 
ıu
;

305 
	`fÜ_—ch_ıu_ªd
(
ıu
, 
ıumask
, 
ªdmask
) {

306 ià(
	`ıumask_‹¡_ıu
(
ıu
, 
ıu_Úlše_mask
))

309 ià(
ıu
 < 
Ä_ıu_ids
)

310  
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
);

312  
BAD_APICID
;

313 
	}
}

315 
­ic
 
	g­ic_physæ©
 = {

317 .
Çme
 = "physical flat",

318 .
	g´obe
 = 
NULL
,

319 .
	gaıi_madt_Ûm_check
 = 
physæ©_aıi_madt_Ûm_check
,

320 .
	g­ic_id_»gi¡”ed
 = 
æ©_­ic_id_»gi¡”ed
,

322 .
	gœq_d–iv”y_mode
 = 
de¡_Fixed
,

323 .
	gœq_de¡_mode
 = 0,

325 .
	grg‘_ıus
 = 
physæ©_rg‘_ıus
,

326 .
	gdi§bË_e¤
 = 0,

327 .
	gde¡_logiÿl
 = 0,

328 .
	gcheck_­icid_u£d
 = 
NULL
,

329 .
	gcheck_­icid_´e£Á
 = 
NULL
,

331 .
	gveùÜ_®loÿtiÚ_domaš
 = 
physæ©_veùÜ_®loÿtiÚ_domaš
,

333 .
	gš™_­ic_ldr
 = 
æ©_š™_­ic_ldr
,

335 .
	gißpic_phys_id_m­
 = 
NULL
,

336 .
	g£tup_­ic_routšg
 = 
NULL
,

337 .
	gmuÉi_tim”_check
 = 
NULL
,

338 .
	g­icid_to_node
 = 
NULL
,

339 .
	gıu_to_logiÿl_­icid
 = 
NULL
,

340 .
	gıu_´e£Á_to_­icid
 = 
deçuÉ_ıu_´e£Á_to_­icid
,

341 .
	g­icid_to_ıu_´e£Á
 = 
NULL
,

342 .
	g£tup_pÜtio_»m­
 = 
NULL
,

343 .
	gcheck_phys_­icid_´e£Á
 = 
deçuÉ_check_phys_­icid_´e£Á
,

344 .
	g’abË_­ic_mode
 = 
NULL
,

345 .
	gphys_pkg_id
 = 
æ©_phys_pkg_id
,

346 .
	gmps_Ûm_check
 = 
NULL
,

348 .
	gg‘_­ic_id
 = 
æ©_g‘_­ic_id
,

349 .
	g£t_­ic_id
 = 
£t_­ic_id
,

350 .
	g­ic_id_mask
 = 0xFFu << 24,

352 .
	gıu_mask_to_­icid
 = 
physæ©_ıu_mask_to_­icid
,

353 .
	gıu_mask_to_­icid_ªd
 = 
physæ©_ıu_mask_to_­icid_ªd
,

355 .
	g£nd_IPI_mask
 = 
physæ©_£nd_IPI_mask
,

356 .
	g£nd_IPI_mask_®lbut£lf
 = 
physæ©_£nd_IPI_mask_®lbut£lf
,

357 .
	g£nd_IPI_®lbut£lf
 = 
physæ©_£nd_IPI_®lbut£lf
,

358 .
	g£nd_IPI_®l
 = 
physæ©_£nd_IPI_®l
,

359 .
	g£nd_IPI_£lf
 = 
­ic_£nd_IPI_£lf
,

361 .
	gŒampŞše_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

362 .
	gŒampŞše_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

363 .
	gwa™_fÜ_š™_d—s£¹
 = 
NULL
,

364 .
	gsmp_ÿÎš_ş—r_loÿl_­ic
 = 
NULL
,

365 .
	gšquœe_»mÙe_­ic
 = 
deçuÉ_šquœe_»mÙe_­ic
,

367 .
	g»ad
 = 
Çtive_­ic_mem_»ad
,

368 .
	gwr™e
 = 
Çtive_­ic_mem_wr™e
,

369 .
	giü_»ad
 = 
Çtive_­ic_iü_»ad
,

370 .
	giü_wr™e
 = 
Çtive_­ic_iü_wr™e
,

371 .
	gwa™_iü_idË
 = 
Çtive_­ic_wa™_iü_idË
,

372 .
	g§ã_wa™_iü_idË
 = 
Çtive_§ã_­ic_wa™_iü_idË
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<lšux/mm.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/š™.h
>

26 
	~<lšux/d–ay.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/pci.h
>

29 
	~<lšux/mc146818¹c.h
>

30 
	~<lšux/comp”.h
>

31 
	~<lšux/aıi.h
>

32 
	~<lšux/moduË.h
>

33 
	~<lšux/sysdev.h
>

34 
	~<lšux/msi.h
>

35 
	~<lšux/htœq.h
>

36 
	~<lšux/ä“z”.h
>

37 
	~<lšux/kth»ad.h
>

38 
	~<lšux/jiff›s.h
>

39 #ifdeà
CONFIG_ACPI


40 
	~<aıi/aıi_bus.h
>

42 
	~<lšux/boÙmem.h
>

43 
	~<lšux/dm¬.h
>

44 
	~<lšux/h³t.h
>

46 
	~<asm/idË.h
>

47 
	~<asm/io.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/ıu.h
>

50 
	~<asm/desc.h
>

51 
	~<asm/´Ùo.h
>

52 
	~<asm/aıi.h
>

53 
	~<asm/dma.h
>

54 
	~<asm/tim”.h
>

55 
	~<asm/i8259.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/msidef.h
>

58 
	~<asm/hy³¹¿n¥Üt.h
>

59 
	~<asm/£tup.h
>

60 
	~<asm/œq_»m­pšg.h
>

61 
	~<asm/h³t.h
>

62 
	~<asm/uv/uv_hub.h
>

63 
	~<asm/uv/uv_œq.h
>

65 
	~<asm/­ic.h
>

67 
	#__­icdebugš™
(
ty³
èty³ 
__š™


	)

73 
	gsis_­ic_bug
 = -1;

75 
DEFINE_SPINLOCK
(
ißpic_lock
);

76 
DEFINE_SPINLOCK
(
veùÜ_lock
);

81 
	gÄ_ißpic_»gi¡”s
[
MAX_IO_APICS
];

84 
mpc_ißpic
 
	gmp_ißpics
[
MAX_IO_APICS
];

85 
	gÄ_ißpics
;

88 
mpc_št¤c
 
	gmp_œqs
[
MAX_IRQ_SOURCES
];

91 
	gmp_œq_’Œ›s
;

93 #ià
defšed
 (
CONFIG_MCA
è|| defšed (
CONFIG_EISA
)

94 
	gmp_bus_id_to_ty³
[
MAX_MP_BUSSES
];

97 
DECLARE_BITMAP
(
mp_bus_nÙ_pci
, 
MAX_MP_BUSSES
);

99 
	gsk_ißpic_£tup
;

101 
	$¬ch_di§bË_smp_suµÜt
()

103 #ifdeà
CONFIG_PCI


104 
noißpicquœk
 = 1;

105 
noißpiü”ou‹
 = -1;

107 
sk_ißpic_£tup
 = 1;

108 
	}
}

110 
__š™
 
	$·r£_nßpic
(*
¡r
)

113 
	`¬ch_di§bË_smp_suµÜt
();

115 
	}
}

116 
—¾y_·¿m
("nßpic", 
·r£_nßpic
);

118 
	gœq_pš_li¡
;

127 
	sœq_pš_li¡
 {

128 
	m­ic
, 
	mpš
;

129 
œq_pš_li¡
 *
	mÃxt
;

132 
œq_pš_li¡
 *
	$g‘_Úe_ä“_œq_2_pš
(
ıu
)

134 
œq_pš_li¡
 *
pš
;

135 
node
;

137 
node
 = 
	`ıu_to_node
(
ıu
);

139 
pš
 = 
	`kz®loc_node
((*pš), 
GFP_ATOMIC
, 
node
);

141  
pš
;

142 
	}
}

144 
	sœq_cfg
 {

145 
œq_pš_li¡
 *
	mœq_2_pš
;

146 
ıumask_v¬_t
 
	mdomaš
;

147 
ıumask_v¬_t
 
	mŞd_domaš
;

148 
	mmove_ş—nup_couÁ
;

149 
u8
 
	mveùÜ
;

150 
u8
 
	mmove_š_´og»ss
 : 1;

151 #ifdeà
CONFIG_NUMA_MIGRATE_IRQ_DESC


152 
u8
 
	mmove_desc_³ndšg
 : 1;

157 #ifdeà
CONFIG_SPARSE_IRQ


158 
œq_cfg
 
	gœq_cfgx
[] = {

160 
œq_cfg
 
œq_cfgx
[
NR_IRQS
] = {

162 [0] = { .
veùÜ
 = 
IRQ0_VECTOR
, },

163 [1] = { .
veùÜ
 = 
IRQ1_VECTOR
, },

164 [2] = { .
veùÜ
 = 
IRQ2_VECTOR
, },

165 [3] = { .
veùÜ
 = 
IRQ3_VECTOR
, },

166 [4] = { .
veùÜ
 = 
IRQ4_VECTOR
, },

167 [5] = { .
veùÜ
 = 
IRQ5_VECTOR
, },

168 [6] = { .
veùÜ
 = 
IRQ6_VECTOR
, },

169 [7] = { .
veùÜ
 = 
IRQ7_VECTOR
, },

170 [8] = { .
veùÜ
 = 
IRQ8_VECTOR
, },

171 [9] = { .
veùÜ
 = 
IRQ9_VECTOR
, },

172 [10] = { .
veùÜ
 = 
IRQ10_VECTOR
, },

173 [11] = { .
veùÜ
 = 
IRQ11_VECTOR
, },

174 [12] = { .
veùÜ
 = 
IRQ12_VECTOR
, },

175 [13] = { .
veùÜ
 = 
IRQ13_VECTOR
, },

176 [14] = { .
veùÜ
 = 
IRQ14_VECTOR
, },

177 [15] = { .
veùÜ
 = 
IRQ15_VECTOR
, },

180 
__š™
 
	$¬ch_—¾y_œq_š™
()

182 
œq_cfg
 *
cfg
;

183 
œq_desc
 *
desc
;

184 
couÁ
;

185 
i
;

187 
cfg
 = 
œq_cfgx
;

188 
couÁ
 = 
	`ARRAY_SIZE
(
œq_cfgx
);

190 
i
 = 0; i < 
couÁ
; i++) {

191 
desc
 = 
	`œq_to_desc
(
i
);

192 
desc
->
ch_d©a
 = &
cfg
[
i
];

193 
	`®loc_boÙmem_ıumask_v¬
(&
cfg
[
i
].
domaš
);

194 
	`®loc_boÙmem_ıumask_v¬
(&
cfg
[
i
].
Şd_domaš
);

195 ià(
i
 < 
NR_IRQS_LEGACY
)

196 
	`ıumask_£Î
(
cfg
[
i
].
domaš
);

200 
	}
}

202 #ifdeà
CONFIG_SPARSE_IRQ


203 
œq_cfg
 *
	$œq_cfg
(
œq
)

205 
œq_cfg
 *
cfg
 = 
NULL
;

206 
œq_desc
 *
desc
;

208 
desc
 = 
	`œq_to_desc
(
œq
);

209 ià(
desc
)

210 
cfg
 = 
desc
->
ch_d©a
;

212  
cfg
;

213 
	}
}

215 
œq_cfg
 *
	$g‘_Úe_ä“_œq_cfg
(
ıu
)

217 
œq_cfg
 *
cfg
;

218 
node
;

220 
node
 = 
	`ıu_to_node
(
ıu
);

222 
cfg
 = 
	`kz®loc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

223 ià(
cfg
) {

224 ià(!
	`®loc_ıumask_v¬_node
(&
cfg
->
domaš
, 
GFP_ATOMIC
, 
node
)) {

225 
	`kä“
(
cfg
);

226 
cfg
 = 
NULL
;

227 } ià(!
	`®loc_ıumask_v¬_node
(&
cfg
->
Şd_domaš
,

228 
GFP_ATOMIC
, 
node
)) {

229 
	`ä“_ıumask_v¬
(
cfg
->
domaš
);

230 
	`kä“
(
cfg
);

231 
cfg
 = 
NULL
;

233 
	`ıumask_ş—r
(
cfg
->
domaš
);

234 
	`ıumask_ş—r
(
cfg
->
Şd_domaš
);

238  
cfg
;

239 
	}
}

241 
	$¬ch_š™_ch_d©a
(
œq_desc
 *
desc
, 
ıu
)

243 
œq_cfg
 *
cfg
;

245 
cfg
 = 
desc
->
ch_d©a
;

246 ià(!
cfg
) {

247 
desc
->
ch_d©a
 = 
	`g‘_Úe_ä“_œq_cfg
(
ıu
);

248 ià(!
desc
->
ch_d©a
) {

249 
	`´štk
(
KERN_ERR
 "can‚ot‡lloc irq_cfg\n");

250 
	`BUG_ON
(1);

255 
	}
}

257 #ifdeà
CONFIG_NUMA_MIGRATE_IRQ_DESC


260 
	$š™_cİy_œq_2_pš
(
œq_cfg
 *
Şd_cfg
, œq_cfg *
cfg
, 
ıu
)

262 
œq_pš_li¡
 *
Şd_’Œy
, *
h—d
, *

, *
’Œy
;

264 
cfg
->
œq_2_pš
 = 
NULL
;

265 
Şd_’Œy
 = 
Şd_cfg
->
œq_2_pš
;

266 ià(!
Şd_’Œy
)

269 
’Œy
 = 
	`g‘_Úe_ä“_œq_2_pš
(
ıu
);

270 ià(!
’Œy
)

273 
’Œy
->
­ic
 = 
Şd_’Œy
->apic;

274 
’Œy
->
pš
 = 
Şd_’Œy
->pin;

275 
h—d
 = 
’Œy
;

276 

 = 
’Œy
;

277 
Şd_’Œy
 = old_’Œy->
Ãxt
;

278 
Şd_’Œy
) {

279 
’Œy
 = 
	`g‘_Úe_ä“_œq_2_pš
(
ıu
);

280 ià(!
’Œy
) {

281 
’Œy
 = 
h—d
;

282 
’Œy
) {

283 
h—d
 = 
’Œy
->
Ãxt
;

284 
	`kä“
(
’Œy
);

285 
’Œy
 = 
h—d
;

290 
’Œy
->
­ic
 = 
Şd_’Œy
->apic;

291 
’Œy
->
pš
 = 
Şd_’Œy
->pin;

292 

->
Ãxt
 = 
’Œy
;

293 

 = 
’Œy
;

294 
Şd_’Œy
 = old_’Œy->
Ãxt
;

297 

->
Ãxt
 = 
NULL
;

298 
cfg
->
œq_2_pš
 = 
h—d
;

299 
	}
}

301 
	$ä“_œq_2_pš
(
œq_cfg
 *
Şd_cfg
, œq_cfg *
cfg
)

303 
œq_pš_li¡
 *
’Œy
, *
Ãxt
;

305 ià(
Şd_cfg
->
œq_2_pš
 =ğ
cfg
->irq_2_pin)

308 
’Œy
 = 
Şd_cfg
->
œq_2_pš
;

310 
’Œy
) {

311 
Ãxt
 = 
’Œy
->next;

312 
	`kä“
(
’Œy
);

313 
’Œy
 = 
Ãxt
;

315 
Şd_cfg
->
œq_2_pš
 = 
NULL
;

316 
	}
}

318 
	$¬ch_š™_cİy_ch_d©a
(
œq_desc
 *
Şd_desc
,

319 
œq_desc
 *
desc
, 
ıu
)

321 
œq_cfg
 *
cfg
;

322 
œq_cfg
 *
Şd_cfg
;

324 
cfg
 = 
	`g‘_Úe_ä“_œq_cfg
(
ıu
);

326 ià(!
cfg
)

329 
desc
->
ch_d©a
 = 
cfg
;

331 
Şd_cfg
 = 
Şd_desc
->
ch_d©a
;

333 
	`memıy
(
cfg
, 
Şd_cfg
, (
œq_cfg
));

335 
	`š™_cİy_œq_2_pš
(
Şd_cfg
, 
cfg
, 
ıu
);

336 
	}
}

338 
	$ä“_œq_cfg
(
œq_cfg
 *
Şd_cfg
)

340 
	`kä“
(
Şd_cfg
);

341 
	}
}

343 
	$¬ch_ä“_ch_d©a
(
œq_desc
 *
Şd_desc
, œq_desø*
desc
)

345 
œq_cfg
 *
Şd_cfg
, *
cfg
;

347 
Şd_cfg
 = 
Şd_desc
->
ch_d©a
;

348 
cfg
 = 
desc
->
ch_d©a
;

350 ià(
Şd_cfg
 =ğ
cfg
)

353 ià(
Şd_cfg
) {

354 
	`ä“_œq_2_pš
(
Şd_cfg
, 
cfg
);

355 
	`ä“_œq_cfg
(
Şd_cfg
);

356 
Şd_desc
->
ch_d©a
 = 
NULL
;

358 
	}
}

361 
	$£t_exŒa_move_desc
(
œq_desc
 *
desc
, cÚ¡ 
ıumask
 *
mask
)

363 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

365 ià(!
cfg
->
move_š_´og»ss
) {

367 ià(!
	`ıumask_š‹r£ùs
(
desc
->
affš™y
, 
mask
))

368 
cfg
->
move_desc_³ndšg
 = 1;

370 
	}
}

374 
œq_cfg
 *
	$œq_cfg
(
œq
)

376  
œq
 < 
Ä_œqs
 ? 
œq_cfgx
 + irq : 
NULL
;

377 
	}
}

381 #iâdeà
CONFIG_NUMA_MIGRATE_IRQ_DESC


382 
šlše
 

383 
	$£t_exŒa_move_desc
(
œq_desc
 *
desc
, cÚ¡ 
ıumask
 *
mask
)

385 
	}
}

388 
	sio_­ic
 {

389 
	mšdex
;

390 
	munu£d
[3];

391 
	md©a
;

392 
	munu£d2
[11];

393 
	meoi
;

396 
__©Œibu‹_cÚ¡__
 
io_­ic
 
__iomem
 *
	$io_­ic_ba£
(
idx
)

398  (
__iomem
 *è
	`__fix_to_vœt
(
FIX_IO_APIC_BASE_0
 + 
idx
)

399 + (
mp_ißpics
[
idx
].
­iÿddr
 & ~
PAGE_MASK
);

400 
	}
}

402 
šlše
 
	$io_­ic_eoi
(
­ic
, 
veùÜ
)

404 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

405 
	`wr™–
(
veùÜ
, &
io_­ic
->
eoi
);

406 
	}
}

408 
šlše
 
	$io_­ic_»ad
(
­ic
, 
»g
)

410 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

411 
	`wr™–
(
»g
, &
io_­ic
->
šdex
);

412  
	`»adl
(&
io_­ic
->
d©a
);

413 
	}
}

415 
šlše
 
	$io_­ic_wr™e
(
­ic
, 
»g
, 
v®ue
)

417 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

418 
	`wr™–
(
»g
, &
io_­ic
->
šdex
);

419 
	`wr™–
(
v®ue
, &
io_­ic
->
d©a
);

420 
	}
}

428 
šlše
 
	$io_­ic_modify
(
­ic
, 
»g
, 
v®ue
)

430 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

432 ià(
sis_­ic_bug
)

433 
	`wr™–
(
»g
, &
io_­ic
->
šdex
);

434 
	`wr™–
(
v®ue
, &
io_­ic
->
d©a
);

435 
	}
}

437 
boŞ
 
	$io_­ic_Ëv–_ack_³ndšg
(
œq_cfg
 *
cfg
)

439 
œq_pš_li¡
 *
’Œy
;

440 
æags
;

442 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

443 
’Œy
 = 
cfg
->
œq_2_pš
;

445 
»g
;

446 
pš
;

448 ià(!
’Œy
)

450 
pš
 = 
’Œy
->pin;

451 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
*2);

453 ià(
»g
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

454 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

455  
Œue
;

457 ià(!
’Œy
->
Ãxt
)

459 
’Œy
 =ƒÁry->
Ãxt
;

461 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

463  
çl£
;

464 
	}
}

466 
	u’Œy_uniÚ
 {

467 ¡ruù { 
u32
 
	mw1
, 
	mw2
; };

468 
IO_APIC_rou‹_’Œy
 
	m’Œy
;

471 
IO_APIC_rou‹_’Œy
 
	$ißpic_»ad_’Œy
(
­ic
, 
pš
)

473 
’Œy_uniÚ
 
eu
;

474 
æags
;

475 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

476 
eu
.
w1
 = 
	`io_­ic_»ad
(
­ic
, 0x10 + 2 * 
pš
);

477 
eu
.
w2
 = 
	`io_­ic_»ad
(
­ic
, 0x11 + 2 * 
pš
);

478 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

479  
eu
.
’Œy
;

480 
	}
}

489 
	$__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
IO_APIC_rou‹_’Œy
 
e
)

491 
’Œy_uniÚ
 
eu
;

492 
eu
.
’Œy
 = 
e
;

493 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2*
pš
, 
eu
.
w2
);

494 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2*
pš
, 
eu
.
w1
);

495 
	}
}

497 
	$ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
IO_APIC_rou‹_’Œy
 
e
)

499 
æags
;

500 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

501 
	`__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
e
);

502 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

503 
	}
}

510 
	$ißpic_mask_’Œy
(
­ic
, 
pš
)

512 
æags
;

513 
’Œy_uniÚ
 
eu
 = { .
’Œy
.
mask
 = 1 };

515 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

516 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2*
pš
, 
eu
.
w1
);

517 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2*
pš
, 
eu
.
w2
);

518 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

519 
	}
}

521 #ifdeà
CONFIG_SMP


522 
	$£nd_ş—nup_veùÜ
(
œq_cfg
 *
cfg
)

524 
ıumask_v¬_t
 
ş—nup_mask
;

526 ià(
	`uÆik–y
(!
	`®loc_ıumask_v¬
(&
ş—nup_mask
, 
GFP_ATOMIC
))) {

527 
i
;

528 
cfg
->
move_ş—nup_couÁ
 = 0;

529 
	`fÜ_—ch_ıu_ªd
(
i
, 
cfg
->
Şd_domaš
, 
ıu_Úlše_mask
)

530 
cfg
->
move_ş—nup_couÁ
++;

531 
	`fÜ_—ch_ıu_ªd
(
i
, 
cfg
->
Şd_domaš
, 
ıu_Úlše_mask
)

532 
­ic
->
	`£nd_IPI_mask
(
	`ıumask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

534 
	`ıumask_ªd
(
ş—nup_mask
, 
cfg
->
Şd_domaš
, 
ıu_Úlše_mask
);

535 
cfg
->
move_ş—nup_couÁ
 = 
	`ıumask_weight
(
ş—nup_mask
);

536 
­ic
->
	`£nd_IPI_mask
(
ş—nup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

537 
	`ä“_ıumask_v¬
(
ş—nup_mask
);

539 
cfg
->
move_š_´og»ss
 = 0;

540 
	}
}

542 
	$__rg‘_IO_APIC_œq
(
œq
, 
de¡
, 
œq_cfg
 *
cfg
)

544 
­ic
, 
pš
;

545 
œq_pš_li¡
 *
’Œy
;

546 
u8
 
veùÜ
 = 
cfg
->vector;

548 
’Œy
 = 
cfg
->
œq_2_pš
;

550 
»g
;

552 ià(!
’Œy
)

555 
­ic
 = 
’Œy
->apic;

556 
pš
 = 
’Œy
->pin;

561 ià(!
	`œq_»m­³d
(
œq
))

562 
	`io_­ic_wr™e
(
­ic
, 0x11 + 
pš
*2, 
de¡
);

563 
»g
 = 
	`io_­ic_»ad
(
­ic
, 0x10 + 
pš
*2);

564 
»g
 &ğ~
IO_APIC_REDIR_VECTOR_MASK
;

565 
»g
 |ğ
veùÜ
;

566 
	`io_­ic_modify
(
­ic
, 0x10 + 
pš
*2, 
»g
);

567 ià(!
’Œy
->
Ãxt
)

569 
’Œy
 =ƒÁry->
Ãxt
;

571 
	}
}

574 
assign_œq_veùÜ
(
œq
, 
œq_cfg
 *
cfg
, cÚ¡ 
ıumask
 *
mask
);

582 
	$£t_desc_affš™y
(
œq_desc
 *
desc
, cÚ¡ 
ıumask
 *
mask
)

584 
œq_cfg
 *
cfg
;

585 
œq
;

587 ià(!
	`ıumask_š‹r£ùs
(
mask
, 
ıu_Úlše_mask
))

588  
BAD_APICID
;

590 
œq
 = 
desc
->irq;

591 
cfg
 = 
desc
->
ch_d©a
;

592 ià(
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
mask
))

593  
BAD_APICID
;

596 
	`£t_exŒa_move_desc
(
desc
, 
mask
);

598 
	`ıumask_cİy
(
desc
->
affš™y
, 
mask
);

600  
­ic
->
	`ıu_mask_to_­icid_ªd
(
desc
->
affš™y
, 
cfg
->
domaš
);

601 
	}
}

604 
	$£t_ißpic_affš™y_œq_desc
(
œq_desc
 *
desc
, cÚ¡ 
ıumask
 *
mask
)

606 
œq_cfg
 *
cfg
;

607 
æags
;

608 
de¡
;

609 
œq
;

611 
œq
 = 
desc
->irq;

612 
cfg
 = 
desc
->
ch_d©a
;

614 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

615 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

616 ià(
de¡
 !ğ
BAD_APICID
) {

618 
de¡
 = 
	`SET_APIC_LOGICAL_ID
(dest);

619 
	`__rg‘_IO_APIC_œq
(
œq
, 
de¡
, 
cfg
);

621 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

622 
	}
}

625 
	$£t_ißpic_affš™y_œq
(
œq
, cÚ¡ 
ıumask
 *
mask
)

627 
œq_desc
 *
desc
;

629 
desc
 = 
	`œq_to_desc
(
œq
);

631 
	`£t_ißpic_affš™y_œq_desc
(
desc
, 
mask
);

632 
	}
}

640 
	$add_pš_to_œq_ıu
(
œq_cfg
 *
cfg
, 
ıu
, 
­ic
, 
pš
)

642 
œq_pš_li¡
 *
’Œy
;

644 
’Œy
 = 
cfg
->
œq_2_pš
;

645 ià(!
’Œy
) {

646 
’Œy
 = 
	`g‘_Úe_ä“_œq_2_pš
(
ıu
);

647 ià(!
’Œy
) {

648 
	`´štk
(
KERN_ERR
 "can‚ot‡lloc irq_2_pino‡dd %d - %d\n",

649 
­ic
, 
pš
);

652 
cfg
->
œq_2_pš
 = 
’Œy
;

653 
’Œy
->
­ic
 =‡pic;

654 
’Œy
->
pš
 =…in;

658 
’Œy
->
Ãxt
) {

660 ià(
’Œy
->
­ic
 =ğ­iø&&ƒÁry->
pš
 ==…in)

663 
’Œy
 =ƒÁry->
Ãxt
;

666 
’Œy
->
Ãxt
 = 
	`g‘_Úe_ä“_œq_2_pš
(
ıu
);

667 
’Œy
 =ƒÁry->
Ãxt
;

668 
’Œy
->
­ic
 =‡pic;

669 
’Œy
->
pš
 =…in;

670 
	}
}

675 
__š™
 
	$»¶aû_pš_©_œq_ıu
(
œq_cfg
 *
cfg
, 
ıu
,

676 
Şd­ic
, 
Şdpš
,

677 
Ãw­ic
, 
Ãwpš
)

679 
œq_pš_li¡
 *
’Œy
 = 
cfg
->
œq_2_pš
;

680 
»¶aûd
 = 0;

682 
’Œy
) {

683 ià(
’Œy
->
­ic
 =ğ
Şd­ic
 &&ƒÁry->
pš
 =ğ
Şdpš
) {

684 
’Œy
->
­ic
 = 
Ãw­ic
;

685 
’Œy
->
pš
 = 
Ãwpš
;

686 
»¶aûd
 = 1;

690 
’Œy
 =ƒÁry->
Ãxt
;

694 ià(!
»¶aûd
)

695 
	`add_pš_to_œq_ıu
(
cfg
, 
ıu
, 
Ãw­ic
, 
Ãwpš
);

696 
	}
}

698 
šlše
 
io_­ic_modify_œq
(
œq_cfg
 *
cfg
,

699 
mask_ªd
, 
mask_Ü
,

700 (*
fš®
)(
œq_pš_li¡
 *
’Œy
))

702 
pš
;

703 
œq_pš_li¡
 *
’Œy
;

705 
’Œy
 = 
cfg
->
œq_2_pš
;ƒÁry !ğ
NULL
;ƒÁry =ƒÁry->
Ãxt
) {

706 
»g
;

707 
pš
 = 
’Œy
->pin;

708 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
 * 2);

709 
»g
 &ğ
mask_ªd
;

710 
»g
 |ğ
mask_Ü
;

711 
	`io_­ic_modify
(
’Œy
->
­ic
, 0x10 + 
pš
 * 2, 
»g
);

712 ià(
fš®
)

713 
	`fš®
(
’Œy
);

715 
	}
}

717 
	$__unmask_IO_APIC_œq
(
œq_cfg
 *
cfg
)

719 
	`io_­ic_modify_œq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

720 
	}
}

722 #ifdeà
CONFIG_X86_64


723 
	$io_­ic_sync
(
œq_pš_li¡
 *
’Œy
)

729 
io_­ic
 
__iomem
 *io_apic;

730 
io_­ic
 = 
	`io_­ic_ba£
(
’Œy
->
­ic
);

731 
	`»adl
(&
io_­ic
->
d©a
);

732 
	}
}

734 
	$__mask_IO_APIC_œq
(
œq_cfg
 *
cfg
)

736 
	`io_­ic_modify_œq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_­ic_sync
);

737 
	}
}

739 
	$__mask_IO_APIC_œq
(
œq_cfg
 *
cfg
)

741 
	`io_­ic_modify_œq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, 
NULL
);

742 
	}
}

744 
	$__mask_ªd_edge_IO_APIC_œq
(
œq_cfg
 *
cfg
)

746 
	`io_­ic_modify_œq
(
cfg
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

747 
IO_APIC_REDIR_MASKED
, 
NULL
);

748 
	}
}

750 
	$__unmask_ªd_Ëv–_IO_APIC_œq
(
œq_cfg
 *
cfg
)

752 
	`io_­ic_modify_œq
(
cfg
, ~
IO_APIC_REDIR_MASKED
,

753 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

754 
	}
}

757 
	$mask_IO_APIC_œq_desc
(
œq_desc
 *
desc
)

759 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

760 
æags
;

762 
	`BUG_ON
(!
cfg
);

764 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

765 
	`__mask_IO_APIC_œq
(
cfg
);

766 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

767 
	}
}

769 
	$unmask_IO_APIC_œq_desc
(
œq_desc
 *
desc
)

771 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

772 
æags
;

774 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

775 
	`__unmask_IO_APIC_œq
(
cfg
);

776 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

777 
	}
}

779 
	$mask_IO_APIC_œq
(
œq
)

781 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

783 
	`mask_IO_APIC_œq_desc
(
desc
);

784 
	}
}

785 
	$unmask_IO_APIC_œq
(
œq
)

787 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

789 
	`unmask_IO_APIC_œq_desc
(
desc
);

790 
	}
}

792 
	$ş—r_IO_APIC_pš
(
­ic
, 
pš
)

794 
IO_APIC_rou‹_’Œy
 
’Œy
;

797 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

798 ià(
’Œy
.
d–iv”y_mode
 =ğ
de¡_SMI
)

803 
	`ißpic_mask_’Œy
(
­ic
, 
pš
);

804 
	}
}

806 
	$ş—r_IO_APIC
 ()

808 
­ic
, 
pš
;

810 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

811 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

812 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

813 
	}
}

815 #ifdeà
CONFIG_X86_32


821 
	#MAX_PIRQS
 8

	)

822 
	gpœq_’Œ›s
[
MAX_PIRQS
] = {

823 [0 ... 
MAX_PIRQS
 - 1] = -1

826 
__š™
 
	$ißpic_pœq_£tup
(*
¡r
)

828 
i
, 
max
;

829 
šts
[
MAX_PIRQS
+1];

831 
	`g‘_İtiÚs
(
¡r
, 
	`ARRAY_SIZE
(
šts
), ints);

833 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


835 
max
 = 
MAX_PIRQS
;

836 ià(
šts
[0] < 
MAX_PIRQS
)

837 
max
 = 
šts
[0];

839 
i
 = 0; i < 
max
; i++) {

840 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG


841 "... PIRQ%d -> IRQ %d\n", 
i
, 
šts
[i+1]);

845 
pœq_’Œ›s
[
MAX_PIRQS
-
i
-1] = 
šts
[i+1];

848 
	}
}

850 
__£tup
("pœq=", 
ißpic_pœq_£tup
);

853 #ifdeà
CONFIG_INTR_REMAP


854 
IO_APIC_rou‹_’Œy
 **
	$®loc_ißpic_’Œ›s
()

856 
­ic
;

857 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
;

859 
ißpic_’Œ›s
 = 
	`kz®loc
((*ißpic_’Œ›sè* 
Ä_ißpics
,

860 
GFP_ATOMIC
);

861 ià(!
ißpic_’Œ›s
)

864 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

865 
ißpic_’Œ›s
[
­ic
] =

866 
	`kz®loc
((
IO_APIC_rou‹_’Œy
) *

867 
Ä_ißpic_»gi¡”s
[
­ic
], 
GFP_ATOMIC
);

868 ià(!
ißpic_’Œ›s
[
­ic
])

869 
nomem
;

872  
ißpic_’Œ›s
;

874 
nomem
:

875 --
­ic
 >= 0)

876 
	`kä“
(
ißpic_’Œ›s
[
­ic
]);

877 
	`kä“
(
ißpic_’Œ›s
);

880 
	}
}

885 
	$§ve_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

887 
­ic
, 
pš
;

889 ià(!
ißpic_’Œ›s
)

890  -
ENOMEM
;

892 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

893 ià(!
ißpic_’Œ›s
[
­ic
])

894  -
ENOMEM
;

896 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

897 
ißpic_’Œ›s
[
­ic
][
pš
] =

898 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

902 
	}
}

907 
	$mask_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

909 
­ic
, 
pš
;

911 ià(!
ißpic_’Œ›s
)

914 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

915 ià(!
ißpic_’Œ›s
[
­ic
])

918 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

919 
IO_APIC_rou‹_’Œy
 
’Œy
;

921 
’Œy
 = 
ißpic_’Œ›s
[
­ic
][
pš
];

922 ià(!
’Œy
.
mask
) {

923 
’Œy
.
mask
 = 1;

924 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
’Œy
);

928 
	}
}

933 
	$»¡Üe_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

935 
­ic
, 
pš
;

937 ià(!
ißpic_’Œ›s
)

938  -
ENOMEM
;

940 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

941 ià(!
ißpic_’Œ›s
[
­ic
])

942  -
ENOMEM
;

944 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

945 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
,

946 
ißpic_’Œ›s
[
­ic
][
pš
]);

949 
	}
}

951 
	$»š™_šŒ_»m­³d_IO_APIC
(
šŒ_»m­pšg
,

952 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

962 
	`»¡Üe_IO_APIC_£tup
(
ißpic_’Œ›s
);

963 
	}
}

965 
	$ä“_ißpic_’Œ›s
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

967 
­ic
;

969 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

970 
	`kä“
(
ißpic_’Œ›s
[
­ic
]);

972 
	`kä“
(
ißpic_’Œ›s
);

973 
	}
}

979 
	$fšd_œq_’Œy
(
­ic
, 
pš
, 
ty³
)

981 
i
;

983 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

984 ià(
mp_œqs
[
i
].
œqty³
 =ğ
ty³
 &&

985 (
mp_œqs
[
i
].
d¡­ic
 =ğ
mp_ißpics
[
­ic
].
­icid
 ||

986 
mp_œqs
[
i
].
d¡­ic
 =ğ
MP_APIC_ALL
) &&

987 
mp_œqs
[
i
].
d¡œq
 =ğ
pš
)

988  
i
;

991 
	}
}

996 
__š™
 
	$fšd_i§_œq_pš
(
œq
, 
ty³
)

998 
i
;

1000 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

1001 
lbus
 = 
mp_œqs
[
i
].
¤cbus
;

1003 ià(
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

1004 (
mp_œqs
[
i
].
œqty³
 =ğ
ty³
) &&

1005 (
mp_œqs
[
i
].
¤cbusœq
 =ğ
œq
))

1007  
mp_œqs
[
i
].
d¡œq
;

1010 
	}
}

1012 
__š™
 
	$fšd_i§_œq_­ic
(
œq
, 
ty³
)

1014 
i
;

1016 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

1017 
lbus
 = 
mp_œqs
[
i
].
¤cbus
;

1019 ià(
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

1020 (
mp_œqs
[
i
].
œqty³
 =ğ
ty³
) &&

1021 (
mp_œqs
[
i
].
¤cbusœq
 =ğ
œq
))

1024 ià(
i
 < 
mp_œq_’Œ›s
) {

1025 
­ic
;

1026 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1027 ià(
mp_ißpics
[
­ic
].
­icid
 =ğ
mp_œqs
[
i
].
d¡­ic
)

1028  
­ic
;

1033 
	}
}

1039 
pš_2_œq
(
idx
, 
­ic
, 
pš
);

1041 
	$IO_APIC_g‘_PCI_œq_veùÜ
(
bus
, 
¦Ù
, 
pš
)

1043 
­ic
, 
i
, 
be¡_guess
 = -1;

1045 
	`­ic_´štk
(
APIC_DEBUG
, "querying PCI -> IRQ mapping bus:%d, slot:%d,…in:%d.\n",

1046 
bus
, 
¦Ù
, 
pš
);

1047 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
)) {

1048 
	`­ic_´štk
(
APIC_VERBOSE
, "PCI BIOS…as£d‚Úexi¡’ˆPCI bu %d!\n", 
bus
);

1051 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

1052 
lbus
 = 
mp_œqs
[
i
].
¤cbus
;

1054 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

1055 ià(
mp_ißpics
[
­ic
].
­icid
 =ğ
mp_œqs
[
i
].
d¡­ic
 ||

1056 
mp_œqs
[
i
].
d¡­ic
 =ğ
MP_APIC_ALL
)

1059 ià(!
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

1060 !
mp_œqs
[
i
].
œqty³
 &&

1061 (
bus
 =ğ
lbus
) &&

1062 (
¦Ù
 =ğ((
mp_œqs
[
i
].
¤cbusœq
 >> 2) & 0x1f))) {

1063 
œq
 = 
	`pš_2_œq
(
i
, 
­ic
, 
mp_œqs
[i].
d¡œq
);

1065 ià(!(
­ic
 || 
	`IO_APIC_IRQ
(
œq
)))

1068 ià(
pš
 =ğ(
mp_œqs
[
i
].
¤cbusœq
 & 3))

1069  
œq
;

1074 ià(
be¡_guess
 < 0)

1075 
be¡_guess
 = 
œq
;

1078  
be¡_guess
;

1079 
	}
}

1081 
EXPORT_SYMBOL
(
IO_APIC_g‘_PCI_œq_veùÜ
);

1083 #ià
defšed
(
CONFIG_EISA
è|| defšed(
CONFIG_MCA
)

1087 
	$EISA_ELCR
(
œq
)

1089 ià(
œq
 < 
NR_IRQS_LEGACY
) {

1090 
pÜt
 = 0x4d0 + (
œq
 >> 3);

1091  (
	`šb
(
pÜt
è>> (
œq
 & 7)) & 1;

1093 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


1094 "Brok’ MPbË„•Üt ISA irq %d\n", 
œq
);

1096 
	}
}

1103 
	#deçuÉ_ISA_Œigg”
(
idx
è(0)

	)

1104 
	#deçuÉ_ISA_pŞ¬™y
(
idx
è(0)

	)

1111 
	#deçuÉ_EISA_Œigg”
(
idx
è(
	`EISA_ELCR
(
mp_œqs
[idx].
¤cbusœq
))

	)

1112 
	#deçuÉ_EISA_pŞ¬™y
(
idx
è
	`deçuÉ_ISA_pŞ¬™y
(idx)

	)

1117 
	#deçuÉ_PCI_Œigg”
(
idx
è(1)

	)

1118 
	#deçuÉ_PCI_pŞ¬™y
(
idx
è(1)

	)

1123 
	#deçuÉ_MCA_Œigg”
(
idx
è(1)

	)

1124 
	#deçuÉ_MCA_pŞ¬™y
(
idx
è
	`deçuÉ_ISA_pŞ¬™y
(idx)

	)

1126 
	$MPBIOS_pŞ¬™y
(
idx
)

1128 
bus
 = 
mp_œqs
[
idx
].
¤cbus
;

1129 
pŞ¬™y
;

1134 
mp_œqs
[
idx
].
œqæag
 & 3)

1137 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
))

1138 
pŞ¬™y
 = 
	`deçuÉ_ISA_pŞ¬™y
(
idx
);

1140 
pŞ¬™y
 = 
	`deçuÉ_PCI_pŞ¬™y
(
idx
);

1144 
pŞ¬™y
 = 0;

1149 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

1150 
pŞ¬™y
 = 1;

1155 
pŞ¬™y
 = 1;

1160 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

1161 
pŞ¬™y
 = 1;

1165  
pŞ¬™y
;

1166 
	}
}

1168 
	$MPBIOS_Œigg”
(
idx
)

1170 
bus
 = 
mp_œqs
[
idx
].
¤cbus
;

1171 
Œigg”
;

1176 (
mp_œqs
[
idx
].
œqæag
>>2) & 3)

1179 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
))

1180 
Œigg”
 = 
	`deçuÉ_ISA_Œigg”
(
idx
);

1182 
Œigg”
 = 
	`deçuÉ_PCI_Œigg”
(
idx
);

1183 #ià
	`defšed
(
CONFIG_EISA
è|| defšed(
CONFIG_MCA
)

1184 
mp_bus_id_to_ty³
[
bus
]) {

1185 
MP_BUS_ISA
:

1190 
MP_BUS_EISA
:

1192 
Œigg”
 = 
	`deçuÉ_EISA_Œigg”
(
idx
);

1195 
MP_BUS_PCI
:

1200 
MP_BUS_MCA
:

1202 
Œigg”
 = 
	`deçuÉ_MCA_Œigg”
(
idx
);

1207 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

1208 
Œigg”
 = 1;

1216 
Œigg”
 = 0;

1221 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

1222 
Œigg”
 = 1;

1227 
Œigg”
 = 1;

1232 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

1233 
Œigg”
 = 0;

1237  
Œigg”
;

1238 
	}
}

1240 
šlše
 
	$œq_pŞ¬™y
(
idx
)

1242  
	`MPBIOS_pŞ¬™y
(
idx
);

1243 
	}
}

1245 
šlše
 
	$œq_Œigg”
(
idx
)

1247  
	`MPBIOS_Œigg”
(
idx
);

1248 
	}
}

1250 (*
ißpic_»numb”_œq
)(
ißpic
, 
œq
);

1251 
	$pš_2_œq
(
idx
, 
­ic
, 
pš
)

1253 
œq
, 
i
;

1254 
bus
 = 
mp_œqs
[
idx
].
¤cbus
;

1259 ià(
mp_œqs
[
idx
].
d¡œq
 !ğ
pš
)

1260 
	`´štk
(
KERN_ERR
 "broken BIOS or MPTABLE…arser,‡yiee!!\n");

1262 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
)) {

1263 
œq
 = 
mp_œqs
[
idx
].
¤cbusœq
;

1268 
i
 = 
œq
 = 0;

1269 
i
 < 
­ic
)

1270 
œq
 +ğ
Ä_ißpic_»gi¡”s
[
i
++];

1271 
œq
 +ğ
pš
;

1275 ià(
ißpic_»numb”_œq
)

1276 
œq
 = 
	`ißpic_»numb”_œq
(
­ic
, irq);

1279 #ifdeà
CONFIG_X86_32


1283 ià((
pš
 >= 16) && (pin <= 23)) {

1284 ià(
pœq_’Œ›s
[
pš
-16] != -1) {

1285 ià(!
pœq_’Œ›s
[
pš
-16]) {

1286 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG


1287 "di§blšg PIRQ%d\n", 
pš
-16);

1289 
œq
 = 
pœq_’Œ›s
[
pš
-16];

1290 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG


1292 
pš
-16, 
œq
);

1298  
œq
;

1299 
	}
}

1301 
	$lock_veùÜ_lock
()

1306 
	`¥š_lock
(&
veùÜ_lock
);

1307 
	}
}

1309 
	$uÆock_veùÜ_lock
()

1311 
	`¥š_uÆock
(&
veùÜ_lock
);

1312 
	}
}

1315 
	$__assign_œq_veùÜ
(
œq
, 
œq_cfg
 *
cfg
, cÚ¡ 
ıumask
 *
mask
)

1328 
cu¼’t_veùÜ
 = 
FIRST_DEVICE_VECTOR
, 
cu¼’t_off£t
 = 0;

1329 
Şd_veùÜ
;

1330 
ıu
, 
”r
;

1331 
ıumask_v¬_t
 
tmp_mask
;

1333 ià((
cfg
->
move_š_´og»ss
è|| cfg->
move_ş—nup_couÁ
)

1334  -
EBUSY
;

1336 ià(!
	`®loc_ıumask_v¬
(&
tmp_mask
, 
GFP_ATOMIC
))

1337  -
ENOMEM
;

1339 
Şd_veùÜ
 = 
cfg
->
veùÜ
;

1340 ià(
Şd_veùÜ
) {

1341 
	`ıumask_ªd
(
tmp_mask
, 
mask
, 
ıu_Úlše_mask
);

1342 
	`ıumask_ªd
(
tmp_mask
, 
cfg
->
domaš
,mp_mask);

1343 ià(!
	`ıumask_em±y
(
tmp_mask
)) {

1344 
	`ä“_ıumask_v¬
(
tmp_mask
);

1350 
”r
 = -
ENOSPC
;

1351 
	`fÜ_—ch_ıu_ªd
(
ıu
, 
mask
, 
ıu_Úlše_mask
) {

1352 
Ãw_ıu
;

1353 
veùÜ
, 
off£t
;

1355 
­ic
->
	`veùÜ_®loÿtiÚ_domaš
(
ıu
, 
tmp_mask
);

1357 
veùÜ
 = 
cu¼’t_veùÜ
;

1358 
off£t
 = 
cu¼’t_off£t
;

1359 
Ãxt
:

1360 
veùÜ
 += 8;

1361 ià(
veùÜ
 >ğ
fœ¡_sy¡em_veùÜ
) {

1363 
off£t
 = (offset + 1) % 8;

1364 
veùÜ
 = 
FIRST_DEVICE_VECTOR
 + 
off£t
;

1366 ià(
	`uÆik–y
(
cu¼’t_veùÜ
 =ğ
veùÜ
))

1369 ià(
	`‹¡_b™
(
veùÜ
, 
u£d_veùÜs
))

1370 
Ãxt
;

1372 
	`fÜ_—ch_ıu_ªd
(
Ãw_ıu
, 
tmp_mask
, 
ıu_Úlše_mask
)

1373 ià(
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] != -1)

1374 
Ãxt
;

1376 
cu¼’t_veùÜ
 = 
veùÜ
;

1377 
cu¼’t_off£t
 = 
off£t
;

1378 ià(
Şd_veùÜ
) {

1379 
cfg
->
move_š_´og»ss
 = 1;

1380 
	`ıumask_cİy
(
cfg
->
Şd_domaš
, cfg->
domaš
);

1382 
	`fÜ_—ch_ıu_ªd
(
Ãw_ıu
, 
tmp_mask
, 
ıu_Úlše_mask
)

1383 
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] = 
œq
;

1384 
cfg
->
veùÜ
 = vector;

1385 
	`ıumask_cİy
(
cfg
->
domaš
, 
tmp_mask
);

1386 
”r
 = 0;

1389 
	`ä“_ıumask_v¬
(
tmp_mask
);

1390  
”r
;

1391 
	}
}

1394 
	$assign_œq_veùÜ
(
œq
, 
œq_cfg
 *
cfg
, cÚ¡ 
ıumask
 *
mask
)

1396 
”r
;

1397 
æags
;

1399 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

1400 
”r
 = 
	`__assign_œq_veùÜ
(
œq
, 
cfg
, 
mask
);

1401 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

1402  
”r
;

1403 
	}
}

1405 
	$__ş—r_œq_veùÜ
(
œq
, 
œq_cfg
 *
cfg
)

1407 
ıu
, 
veùÜ
;

1409 
	`BUG_ON
(!
cfg
->
veùÜ
);

1411 
veùÜ
 = 
cfg
->vector;

1412 
	`fÜ_—ch_ıu_ªd
(
ıu
, 
cfg
->
domaš
, 
ıu_Úlše_mask
)

1413 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

1415 
cfg
->
veùÜ
 = 0;

1416 
	`ıumask_ş—r
(
cfg
->
domaš
);

1418 ià(
	`lik–y
(!
cfg
->
move_š_´og»ss
))

1420 
	`fÜ_—ch_ıu_ªd
(
ıu
, 
cfg
->
Şd_domaš
, 
ıu_Úlše_mask
) {

1421 
veùÜ
 = 
FIRST_EXTERNAL_VECTOR
; veùÜ < 
NR_VECTORS
;

1422 
veùÜ
++) {

1423 ià(
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] !ğ
œq
)

1425 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

1429 
cfg
->
move_š_´og»ss
 = 0;

1430 
	}
}

1432 
	$__£tup_veùÜ_œq
(
ıu
)

1436 
œq
, 
veùÜ
;

1437 
œq_cfg
 *
cfg
;

1438 
œq_desc
 *
desc
;

1441 
	`fÜ_—ch_œq_desc
(
œq
, 
desc
) {

1442 
cfg
 = 
desc
->
ch_d©a
;

1443 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
cfg
->
domaš
))

1445 
veùÜ
 = 
cfg
->vector;

1446 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = 
œq
;

1449 
veùÜ
 = 0; veùÜ < 
NR_VECTORS
; ++vector) {

1450 
œq
 = 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
];

1451 ià(
œq
 < 0)

1454 
cfg
 = 
	`œq_cfg
(
œq
);

1455 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
cfg
->
domaš
))

1456 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

1458 
	}
}

1460 
œq_ch
 
	gißpic_ch
;

1461 
œq_ch
 
	gœ_ißpic_ch
;

1463 
	#IOAPIC_AUTO
 -1

	)

1464 
	#IOAPIC_EDGE
 0

	)

1465 
	#IOAPIC_LEVEL
 1

	)

1467 #ifdeà
CONFIG_X86_32


1468 
šlše
 
	$IO_APIC_œq_Œigg”
(
œq
)

1470 
­ic
, 
idx
, 
pš
;

1472 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1473 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

1474 
idx
 = 
	`fšd_œq_’Œy
(
­ic
, 
pš
, 
mp_INT
);

1475 ià((
idx
 !ğ-1è&& (
œq
 =ğ
	`pš_2_œq
(idx, 
­ic
, 
pš
)))

1476  
	`œq_Œigg”
(
idx
);

1483 
	}
}

1485 
šlše
 
	$IO_APIC_œq_Œigg”
(
œq
)

1488 
	}
}

1491 
	$ißpic_»gi¡”_šŒ
(
œq
, 
œq_desc
 *
desc
, 
Œigg”
)

1494 ià((
Œigg”
 =ğ
IOAPIC_AUTO
 && 
	`IO_APIC_œq_Œigg”
(
œq
)) ||

1495 
Œigg”
 =ğ
IOAPIC_LEVEL
)

1496 
desc
->
¡©us
 |ğ
IRQ_LEVEL
;

1498 
desc
->
¡©us
 &ğ~
IRQ_LEVEL
;

1500 ià(
	`œq_»m­³d
(
œq
)) {

1501 
desc
->
¡©us
 |ğ
IRQ_MOVE_PCNTXT
;

1502 ià(
Œigg”
)

1503 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
œ_ißpic_ch
,

1504 
hªdË_ç¡eoi_œq
,

1507 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
œ_ißpic_ch
,

1508 
hªdË_edge_œq
, "edge");

1512 ià((
Œigg”
 =ğ
IOAPIC_AUTO
 && 
	`IO_APIC_œq_Œigg”
(
œq
)) ||

1513 
Œigg”
 =ğ
IOAPIC_LEVEL
)

1514 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ißpic_ch
,

1515 
hªdË_ç¡eoi_œq
,

1518 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ißpic_ch
,

1519 
hªdË_edge_œq
, "edge");

1520 
	}
}

1522 
	$£tup_ißpic_’Œy
(
­ic_id
, 
œq
,

1523 
IO_APIC_rou‹_’Œy
 *
’Œy
,

1524 
de¡š©iÚ
, 
Œigg”
,

1525 
pŞ¬™y
, 
veùÜ
, 
pš
)

1530 
	`mem£t
(
’Œy
,0,(*entry));

1532 ià(
šŒ_»m­pšg_’abËd
) {

1533 
š‹l_iommu
 *
iommu
 = 
	`m­_ißpic_to_œ
(
­ic_id
);

1534 
œ‹
 irte;

1535 
IR_IO_APIC_rou‹_’Œy
 *
œ_’Œy
 =

1536 (
IR_IO_APIC_rou‹_’Œy
 *è
’Œy
;

1537 
šdex
;

1539 ià(!
iommu
)

1540 
	`·nic
("NØm­pšg iommu fÜ ißpiø%d\n", 
­ic_id
);

1542 
šdex
 = 
	`®loc_œ‹
(
iommu
, 
œq
, 1);

1543 ià(
šdex
 < 0)

1544 
	`·nic
("FaedØ®loÿ‹ IRTE fÜ ißpiø%d\n", 
­ic_id
);

1546 
	`mem£t
(&
œ‹
, 0, (irte));

1548 
œ‹
.
´e£Á
 = 1;

1549 
œ‹
.
d¡_mode
 = 
­ic
->
œq_de¡_mode
;

1557 
œ‹
.
Œigg”_mode
 = 0;

1558 
œ‹
.
dlvry_mode
 = 
­ic
->
œq_d–iv”y_mode
;

1559 
œ‹
.
veùÜ
 = vector;

1560 
œ‹
.
de¡_id
 = 
	`IRTE_DEST
(
de¡š©iÚ
);

1562 
	`modify_œ‹
(
œq
, &
œ‹
);

1564 
œ_’Œy
->
šdex2
 = (
šdex
 >> 15) & 0x1;

1565 
œ_’Œy
->
z”o
 = 0;

1566 
œ_’Œy
->
fÜm©
 = 1;

1567 
œ_’Œy
->
šdex
 = (index & 0x7fff);

1572 
œ_’Œy
->
veùÜ
 = 
pš
;

1574 
’Œy
->
d–iv”y_mode
 = 
­ic
->
œq_d–iv”y_mode
;

1575 
’Œy
->
de¡_mode
 = 
­ic
->
œq_de¡_mode
;

1576 
’Œy
->
de¡
 = 
de¡š©iÚ
;

1577 
’Œy
->
veùÜ
 = vector;

1580 
’Œy
->
mask
 = 0;

1581 
’Œy
->
Œigg”
 =rigger;

1582 
’Œy
->
pŞ¬™y
 =…olarity;

1587 ià(
Œigg”
)

1588 
’Œy
->
mask
 = 1;

1590 
	}
}

1592 
	$£tup_IO_APIC_œq
(
­ic_id
, 
pš
, 
œq
, 
œq_desc
 *
desc
,

1593 
Œigg”
, 
pŞ¬™y
)

1595 
œq_cfg
 *
cfg
;

1596 
IO_APIC_rou‹_’Œy
 
’Œy
;

1597 
de¡
;

1599 ià(!
	`IO_APIC_IRQ
(
œq
))

1602 
cfg
 = 
desc
->
ch_d©a
;

1604 ià(
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
­ic
->
	`rg‘_ıus
()))

1607 
de¡
 = 
­ic
->
	`ıu_mask_to_­icid_ªd
(
cfg
->
domaš
,‡pic->
	`rg‘_ıus
());

1609 
	`­ic_´štk
(
APIC_VERBOSE
,
KERN_DEBUG


1612 
­ic_id
, 
mp_ißpics
[­ic_id].
­icid
, 
pš
, 
cfg
->
veùÜ
,

1613 
œq
, 
Œigg”
, 
pŞ¬™y
);

1616 ià(
	`£tup_ißpic_’Œy
(
mp_ißpics
[
­ic_id
].
­icid
, 
œq
, &
’Œy
,

1617 
de¡
, 
Œigg”
, 
pŞ¬™y
, 
cfg
->
veùÜ
, 
pš
)) {

1618 
	`´štk
("Failedo setup ioapicƒntry for ioapic %d,…in %d\n",

1619 
mp_ißpics
[
­ic_id
].
­icid
, 
pš
);

1620 
	`__ş—r_œq_veùÜ
(
œq
, 
cfg
);

1624 
	`ißpic_»gi¡”_šŒ
(
œq
, 
desc
, 
Œigg”
);

1625 ià(
œq
 < 
NR_IRQS_LEGACY
)

1626 
	`di§bË_8259A_œq
(
œq
);

1628 
	`ißpic_wr™e_’Œy
(
­ic_id
, 
pš
, 
’Œy
);

1629 
	}
}

1631 
__š™
 
	$£tup_IO_APIC_œqs
()

1633 
­ic_id
, 
pš
, 
idx
, 
œq
;

1634 
nÙcÚ
 = 0;

1635 
œq_desc
 *
desc
;

1636 
œq_cfg
 *
cfg
;

1637 
ıu
 = 
boÙ_ıu_id
;

1639 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1641 
­ic_id
 = 0;‡pic_id < 
Ä_ißpics
;‡pic_id++) {

1642 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic_id
];…in++) {

1644 
idx
 = 
	`fšd_œq_’Œy
(
­ic_id
, 
pš
, 
mp_INT
);

1645 ià(
idx
 == -1) {

1646 ià(!
nÙcÚ
) {

1647 
nÙcÚ
 = 1;

1648 
	`­ic_´štk
(
APIC_VERBOSE
,

1649 
KERN_DEBUG
 " %d-%d",

1650 
mp_ißpics
[
­ic_id
].
­icid
, 
pš
);

1652 
	`­ic_´štk
(
APIC_VERBOSE
, " %d-%d",

1653 
mp_ißpics
[
­ic_id
].
­icid
, 
pš
);

1656 ià(
nÙcÚ
) {

1657 
	`­ic_´štk
(
APIC_VERBOSE
,

1659 
nÙcÚ
 = 0;

1662 
œq
 = 
	`pš_2_œq
(
idx
, 
­ic_id
, 
pš
);

1668 ià(
­ic
->
muÉi_tim”_check
 &&

1669 
­ic
->
	`muÉi_tim”_check
(
­ic_id
, 
œq
))

1672 
desc
 = 
	`œq_to_desc_®loc_ıu
(
œq
, 
ıu
);

1673 ià(!
desc
) {

1674 
	`´štk
(
KERN_INFO
 "ÿÀnÙ g‘ irq_desøfÜ %d\n", 
œq
);

1677 
cfg
 = 
desc
->
ch_d©a
;

1678 
	`add_pš_to_œq_ıu
(
cfg
, 
ıu
, 
­ic_id
, 
pš
);

1680 
	`£tup_IO_APIC_œq
(
­ic_id
, 
pš
, 
œq
, 
desc
,

1681 
	`œq_Œigg”
(
idx
), 
	`œq_pŞ¬™y
(idx));

1685 ià(
nÙcÚ
)

1686 
	`­ic_´štk
(
APIC_VERBOSE
,

1688 
	}
}

1693 
__š™
 
	$£tup_tim”_IRQ0_pš
(
­ic_id
, 
pš
,

1694 
veùÜ
)

1696 
IO_APIC_rou‹_’Œy
 
’Œy
;

1698 ià(
šŒ_»m­pšg_’abËd
)

1701 
	`mem£t
(&
’Œy
, 0, (entry));

1707 
’Œy
.
de¡_mode
 = 
­ic
->
œq_de¡_mode
;

1708 
’Œy
.
mask
 = 0;

1709 
’Œy
.
de¡
 = 
­ic
->
	`ıu_mask_to_­icid
×pic->
	`rg‘_ıus
());

1710 
’Œy
.
d–iv”y_mode
 = 
­ic
->
œq_d–iv”y_mode
;

1711 
’Œy
.
pŞ¬™y
 = 0;

1712 
’Œy
.
Œigg”
 = 0;

1713 
’Œy
.
veùÜ
 = vector;

1719 
	`£t_œq_ch_ªd_hªdËr_Çme
(0, &
ißpic_ch
, 
hªdË_edge_œq
, "edge");

1724 
	`ißpic_wr™e_’Œy
(
­ic_id
, 
pš
, 
’Œy
);

1725 
	}
}

1728 
	$__­icdebugš™
(è
	$´št_IO_APIC
()

1730 
­ic
, 
i
;

1731 
IO_APIC_»g_00
 
»g_00
;

1732 
IO_APIC_»g_01
 
»g_01
;

1733 
IO_APIC_»g_02
 
»g_02
;

1734 
IO_APIC_»g_03
 
»g_03
;

1735 
æags
;

1736 
œq_cfg
 *
cfg
;

1737 
œq_desc
 *
desc
;

1738 
œq
;

1740 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1743 
	`´štk
(
KERN_DEBUG
 "numb” oàMP IRQ sourûs: %d.\n", 
mp_œq_’Œ›s
);

1744 
i
 = 0; i < 
Ä_ißpics
; i++)

1745 
	`´štk
(
KERN_DEBUG
 "number of IO-APIC #%d„egisters: %d.\n",

1746 
mp_ißpics
[
i
].
­icid
, 
Ä_ißpic_»gi¡”s
[i]);

1752 
	`´štk
(
KERN_INFO
 "testinghe IO APIC.......................\n");

1754 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1756 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1757 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 0);

1758 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 1);

1759 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x10)

1760 
»g_02
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 2);

1761 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x20)

1762 
»g_03
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 3);

1763 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1765 
	`´štk
("\n");

1766 
	`´štk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_ißpics
[
­ic
].
­icid
);

1767 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #00: %08X\n", 
»g_00
.
¿w
);

1768 
	`´štk
(
KERN_DEBUG
 "....... :…hysiÿÈAPIC id: %02X\n", 
»g_00
.
b™s
.
ID
);

1769 
	`´štk
(
KERN_DEBUG
 "....... : D–iv”y Ty³: %X\n", 
»g_00
.
b™s
.
d–iv”y_ty³
);

1770 
	`´štk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
»g_00
.
b™s
.
LTS
);

1772 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #01: %08X\n", *(*)&
»g_01
);

1773 
	`´štk
(
KERN_DEBUG
 "....... : max„edœeùiÚƒÁr›s: %04X\n", 
»g_01
.
b™s
.
’Œ›s
);

1775 
	`´štk
(
KERN_DEBUG
 "....... : PRQ im¶em’‹d: %X\n", 
»g_01
.
b™s
.
PRQ
);

1776 
	`´štk
(
KERN_DEBUG
 "....... : IO APIC v”siÚ: %04X\n", 
»g_01
.
b™s
.
v”siÚ
);

1783 ià(
»g_01
.
b™s
.
v”siÚ
 >ğ0x10 && 
»g_02
.
¿w
 !=„eg_01.raw) {

1784 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #02: %08X\n", 
»g_02
.
¿w
);

1785 
	`´štk
(
KERN_DEBUG
 "....... :‡rb™¿tiÚ: %02X\n", 
»g_02
.
b™s
.
¬b™¿tiÚ
);

1793 ià(
»g_01
.
b™s
.
v”siÚ
 >ğ0x20 && 
»g_03
.
¿w
 !ğ
»g_02
.raw &&

1794 
»g_03
.
¿w
 !ğ
»g_01
.raw) {

1795 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #03: %08X\n", 
»g_03
.
¿w
);

1796 
	`´štk
(
KERN_DEBUG
 "....... : BoÙ DT : %X\n", 
»g_03
.
b™s
.
boÙ_DT
);

1799 
	`´štk
(
KERN_DEBUG
 ".... IRQ„edirectionable:\n");

1801 
	`´štk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1804 
i
 = 0; i <ğ
»g_01
.
b™s
.
’Œ›s
; i++) {

1805 
IO_APIC_rou‹_’Œy
 
’Œy
;

1807 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
i
);

1809 
	`´štk
(
KERN_DEBUG
 " %02x %03X ",

1810 
i
,

1811 
’Œy
.
de¡


1814 
	`´štk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1815 
’Œy
.
mask
,

1816 
’Œy
.
Œigg”
,

1817 
’Œy
.
œr
,

1818 
’Œy
.
pŞ¬™y
,

1819 
’Œy
.
d–iv”y_¡©us
,

1820 
’Œy
.
de¡_mode
,

1821 
’Œy
.
d–iv”y_mode
,

1822 
’Œy
.
veùÜ


1826 
	`´štk
(
KERN_DEBUG
 "IRQo…in mappings:\n");

1827 
	`fÜ_—ch_œq_desc
(
œq
, 
desc
) {

1828 
œq_pš_li¡
 *
’Œy
;

1830 
cfg
 = 
desc
->
ch_d©a
;

1831 
’Œy
 = 
cfg
->
œq_2_pš
;

1832 ià(!
’Œy
)

1834 
	`´štk
(
KERN_DEBUG
 "IRQ%d ", 
œq
);

1836 
	`´štk
("-> %d:%d", 
’Œy
->
­ic
,ƒÁry->
pš
);

1837 ià(!
’Œy
->
Ãxt
)

1839 
’Œy
 =ƒÁry->
Ãxt
;

1841 
	`´štk
("\n");

1844 
	`´štk
(
KERN_INFO
 ".................................... done.\n");

1847 
	}
}

1849 
	$__­icdebugš™
(è
	$´št_APIC_b™f›ld
(
ba£
)

1851 
v
;

1852 
i
, 
j
;

1854 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1857 
	`´štk
(
KERN_DEBUG
 "0123456789abcdef0123456789abcdef\n" KERN_DEBUG);

1858 
i
 = 0; i < 8; i++) {

1859 
v
 = 
	`­ic_»ad
(
ba£
 + 
i
*0x10);

1860 
j
 = 0; j < 32; j++) {

1861 ià(
v
 & (1<<
j
))

1862 
	`´štk
("1");

1864 
	`´štk
("0");

1866 
	`´štk
("\n");

1868 
	}
}

1870 
	$__­icdebugš™
(è
	$´št_loÿl_APIC
(*
dummy
)

1872 
v
, 
v”
, 
maxlvt
;

1873 
u64
 
iü
;

1875 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1878 
	`´štk
("\n" 
KERN_DEBUG
 "printing†ocal APIC contents on CPU#%d/%d:\n",

1879 
	`smp_´oûssÜ_id
(), 
	`h¬d_smp_´oûssÜ_id
());

1880 
v
 = 
	`­ic_»ad
(
APIC_ID
);

1881 
	`´štk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`»ad_­ic_id
());

1882 
v
 = 
	`­ic_»ad
(
APIC_LVR
);

1883 
	`´štk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1884 
v”
 = 
	`GET_APIC_VERSION
(
v
);

1885 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

1887 
v
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

1888 
	`´štk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1890 ià(
	`APIC_INTEGRATED
(
v”
)) {

1891 ià(!
	`APIC_XAPIC
(
v”
)) {

1892 
v
 = 
	`­ic_»ad
(
APIC_ARBPRI
);

1893 
	`´štk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1894 
v
 & 
APIC_ARBPRI_MASK
);

1896 
v
 = 
	`­ic_»ad
(
APIC_PROCPRI
);

1897 
	`´štk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1904 ià(!
	`APIC_INTEGRATED
(
v”
è|| 
maxlvt
 == 3) {

1905 
v
 = 
	`­ic_»ad
(
APIC_RRR
);

1906 
	`´štk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1909 
v
 = 
	`­ic_»ad
(
APIC_LDR
);

1910 
	`´štk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1911 ià(!
	`x2­ic_’abËd
()) {

1912 
v
 = 
	`­ic_»ad
(
APIC_DFR
);

1913 
	`´štk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1915 
v
 = 
	`­ic_»ad
(
APIC_SPIV
);

1916 
	`´štk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1918 
	`´štk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1919 
	`´št_APIC_b™f›ld
(
APIC_ISR
);

1920 
	`´štk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1921 
	`´št_APIC_b™f›ld
(
APIC_TMR
);

1922 
	`´štk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1923 
	`´št_APIC_b™f›ld
(
APIC_IRR
);

1925 ià(
	`APIC_INTEGRATED
(
v”
)) {

1926 ià(
maxlvt
 > 3)

1927 
	`­ic_wr™e
(
APIC_ESR
, 0);

1929 
v
 = 
	`­ic_»ad
(
APIC_ESR
);

1930 
	`´štk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1933 
iü
 = 
	`­ic_iü_»ad
();

1934 
	`´štk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
iü
);

1935 
	`´štk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
iü
 >> 32));

1937 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

1938 
	`´štk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1940 ià(
maxlvt
 > 3) {

1941 
v
 = 
	`­ic_»ad
(
APIC_LVTPC
);

1942 
	`´štk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1944 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1945 
	`´štk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1946 
v
 = 
	`­ic_»ad
(
APIC_LVT1
);

1947 
	`´štk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1949 ià(
maxlvt
 > 2) {

1950 
v
 = 
	`­ic_»ad
(
APIC_LVTERR
);

1951 
	`´štk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1954 
v
 = 
	`­ic_»ad
(
APIC_TMICT
);

1955 
	`´štk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1956 
v
 = 
	`­ic_»ad
(
APIC_TMCCT
);

1957 
	`´štk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1958 
v
 = 
	`­ic_»ad
(
APIC_TDCR
);

1959 
	`´štk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1960 
	`´štk
("\n");

1961 
	}
}

1963 
	$__­icdebugš™
(è
	$´št_®l_loÿl_APICs
()

1965 
ıu
;

1967 
	`´“m±_di§bË
();

1968 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

1969 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
´št_loÿl_APIC
, 
NULL
, 1);

1970 
	`´“m±_’abË
();

1971 
	}
}

1973 
	$__­icdebugš™
(è
	$´št_PIC
()

1975 
v
;

1976 
æags
;

1978 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1981 
	`´štk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1983 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

1985 
v
 = 
	`šb
(0xa1) << 8 | inb(0x21);

1986 
	`´štk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1988 
v
 = 
	`šb
(0xa0) << 8 | inb(0x20);

1989 
	`´štk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1991 
	`outb
(0x0b,0xa0);

1992 
	`outb
(0x0b,0x20);

1993 
v
 = 
	`šb
(0xa0) << 8 | inb(0x20);

1994 
	`outb
(0x0a,0xa0);

1995 
	`outb
(0x0a,0x20);

1997 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

1999 
	`´štk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

2001 
v
 = 
	`šb
(0x4d1) << 8 | inb(0x4d0);

2002 
	`´štk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

2003 
	}
}

2005 
	$__­icdebugš™
(è
	$´št_®l_ICs
()

2007 
	`´št_PIC
();

2008 
	`´št_®l_loÿl_APICs
();

2009 
	`´št_IO_APIC
();

2012 
	}
}

2014 
fs_š™ÿÎ
(
´št_®l_ICs
);

2018 ¡ruù { 
	mpš
, 
	m­ic
; } 
	gißpic_i8259
 = { -1, -1 };

2020 
__š™
 
	$’abË_IO_APIC
()

2022 
IO_APIC_»g_01
 
»g_01
;

2023 
i8259_­ic
, 
i8259_pš
;

2024 
­ic
;

2025 
æags
;

2030 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

2031 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2032 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 1);

2033 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2034 
Ä_ißpic_»gi¡”s
[
­ic
] = 
»g_01
.
b™s
.
’Œ›s
+1;

2036 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

2037 
pš
;

2039 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

2040 
IO_APIC_rou‹_’Œy
 
’Œy
;

2041 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

2046 ià((
’Œy
.
mask
 =ğ0è&& (’Œy.
d–iv”y_mode
 =ğ
de¡_ExtINT
)) {

2047 
ißpic_i8259
.
­ic
 =‡pic;

2048 
ißpic_i8259
.
pš
 =…in;

2049 
found_i8259
;

2053 
found_i8259
:

2059 
i8259_pš
 = 
	`fšd_i§_œq_pš
(0, 
mp_ExtINT
);

2060 
i8259_­ic
 = 
	`fšd_i§_œq_­ic
(0, 
mp_ExtINT
);

2062 ià((
ißpic_i8259
.
pš
 =ğ-1è&& (
i8259_pš
 >= 0)) {

2063 
	`´štk
(
KERN_WARNING
 "ExtINT‚ot setup in hardware but„eported by MPable\n");

2064 
ißpic_i8259
.
pš
 = 
i8259_pš
;

2065 
ißpic_i8259
.
­ic
 = 
i8259_­ic
;

2068 ià(((
ißpic_i8259
.
­ic
 !ğ
i8259_­ic
è|| (ißpic_i8259.
pš
 !ğ
i8259_pš
)) &&

2069 (
i8259_pš
 >ğ0è&& (
ißpic_i8259
.
pš
 >= 0))

2071 
	`´štk
(
KERN_WARNING
 "ExtINT in hardware‡nd MPable differ\n");

2077 
	`ş—r_IO_APIC
();

2078 
	}
}

2083 
	$di§bË_IO_APIC
()

2088 
	`ş—r_IO_APIC
();

2100 ià(
ißpic_i8259
.
pš
 !ğ-1 && !
šŒ_»m­pšg_’abËd
) {

2101 
IO_APIC_rou‹_’Œy
 
’Œy
;

2103 
	`mem£t
(&
’Œy
, 0, (entry));

2104 
’Œy
.
mask
 = 0;

2105 
’Œy
.
Œigg”
 = 0;

2106 
’Œy
.
œr
 = 0;

2107 
’Œy
.
pŞ¬™y
 = 0;

2108 
’Œy
.
d–iv”y_¡©us
 = 0;

2109 
’Œy
.
de¡_mode
 = 0;

2110 
’Œy
.
d–iv”y_mode
 = 
de¡_ExtINT
;

2111 
’Œy
.
veùÜ
 = 0;

2112 
’Œy
.
de¡
 = 
	`»ad_­ic_id
();

2117 
	`ißpic_wr™e_’Œy
(
ißpic_i8259
.
­ic
, ißpic_i8259.
pš
, 
’Œy
);

2123 
	`discÚÃù_b¥_APIC
(!
šŒ_»m­pšg_’abËd
 && 
ißpic_i8259
.
pš
 != -1);

2124 
	}
}

2126 #ifdeà
CONFIG_X86_32


2134 
__š™
 
	$£tup_ißpic_ids_äom_mpc
()

2136 
IO_APIC_»g_00
 
»g_00
;

2137 
physid_mask_t
 
phys_id_´e£Á_m­
;

2138 
­ic_id
;

2139 
i
;

2140 
Şd_id
;

2141 
æags
;

2143 ià(
x86_quœks
->
£tup_ißpic_ids
 && x86_quœks->
	`£tup_ißpic_ids
())

2150 ià(!(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

2151 || 
	`APIC_XAPIC
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
]))

2157 
phys_id_´e£Á_m­
 = 
­ic
->
	`ißpic_phys_id_m­
(
phys_ıu_´e£Á_m­
);

2162 
­ic_id
 = 0;‡pic_id < 
Ä_ißpics
;‡pic_id++) {

2165 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2166 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic_id
, 0);

2167 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2169 
Şd_id
 = 
mp_ißpics
[
­ic_id
].
­icid
;

2171 ià(
mp_ißpics
[
­ic_id
].
­icid
 >ğ
	`g‘_physiÿl_brßdÿ¡
()) {

2172 
	`´štk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inhe MPCable!...\n",

2173 
­ic_id
, 
mp_ißpics
[­ic_id].
­icid
);

2174 
	`´štk
(
KERN_ERR
 "... fixing upo %d. (tell your hw vendor)\n",

2175 
»g_00
.
b™s
.
ID
);

2176 
mp_ißpics
[
­ic_id
].
­icid
 = 
»g_00
.
b™s
.
ID
;

2184 ià(
­ic
->
	`check_­icid_u£d
(
phys_id_´e£Á_m­
,

2185 
mp_ißpics
[
­ic_id
].
­icid
)) {

2186 
	`´štk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d is‡lready used!...\n",

2187 
­ic_id
, 
mp_ißpics
[­ic_id].
­icid
);

2188 
i
 = 0; i < 
	`g‘_physiÿl_brßdÿ¡
(); i++)

2189 ià(!
	`physid_is£t
(
i
, 
phys_id_´e£Á_m­
))

2191 ià(
i
 >ğ
	`g‘_physiÿl_brßdÿ¡
())

2192 
	`·nic
("Max APIC IDƒxceeded!\n");

2193 
	`´štk
(
KERN_ERR
 "... fixing upo %d. (tell your hw vendor)\n",

2194 
i
);

2195 
	`physid_£t
(
i
, 
phys_id_´e£Á_m­
);

2196 
mp_ißpics
[
­ic_id
].
­icid
 = 
i
;

2198 
physid_mask_t
 
tmp
;

2199 
tmp
 = 
­ic
->
	`­icid_to_ıu_´e£Á
(
mp_ißpics
[
­ic_id
].
­icid
);

2200 
	`­ic_´štk
(
APIC_VERBOSE
, "Setting %d inhe "

2202 
mp_ißpics
[
­ic_id
].
­icid
);

2203 
	`physids_Ü
(
phys_id_´e£Á_m­
,…hys_id_´e£Á_m­, 
tmp
);

2211 ià(
Şd_id
 !ğ
mp_ißpics
[
­ic_id
].
­icid
)

2212 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

2213 ià(
mp_œqs
[
i
].
d¡­ic
 =ğ
Şd_id
)

2214 
mp_œqs
[
i
].
d¡­ic


2215 ğ
mp_ißpics
[
­ic_id
].
­icid
;

2221 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


2223 
mp_ißpics
[
­ic_id
].
­icid
);

2225 
»g_00
.
b™s
.
ID
 = 
mp_ißpics
[
­ic_id
].
­icid
;

2226 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2227 
	`io_­ic_wr™e
(
­ic_id
, 0, 
»g_00
.
¿w
);

2228 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2233 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2234 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic_id
, 0);

2235 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2236 ià(
»g_00
.
b™s
.
ID
 !ğ
mp_ißpics
[
­ic_id
].
­icid
)

2237 
	`´štk
("could‚ot set ID!\n");

2239 
	`­ic_´štk
(
APIC_VERBOSE
, " ok.\n");

2241 
	}
}

2244 
no_tim”_check
 
	g__š™d©a
;

2246 
__š™
 
	$nÙim”check
(*
s
)

2248 
no_tim”_check
 = 1;

2250 
	}
}

2251 
__£tup
("no_tim”_check", 
nÙim”check
);

2261 
__š™
 
	$tim”_œq_wÜks
()

2263 
t1
 = 
jiff›s
;

2264 
æags
;

2266 ià(
no_tim”_check
)

2269 
	`loÿl_§ve_æags
(
æags
);

2270 
	`loÿl_œq_’abË
();

2272 
	`md–ay
((10 * 1000è/ 
HZ
);

2273 
	`loÿl_œq_»¡Üe
(
æags
);

2284 ià(
	`time_aá”
(
jiff›s
, 
t1
 + 4))

2287 
	}
}

2312 
	$¡¬tup_ißpic_œq
(
œq
)

2314 
was_³ndšg
 = 0;

2315 
æags
;

2316 
œq_cfg
 *
cfg
;

2318 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2319 ià(
œq
 < 
NR_IRQS_LEGACY
) {

2320 
	`di§bË_8259A_œq
(
œq
);

2321 ià(
	`i8259A_œq_³ndšg
(
œq
))

2322 
was_³ndšg
 = 1;

2324 
cfg
 = 
	`œq_cfg
(
œq
);

2325 
	`__unmask_IO_APIC_œq
(
cfg
);

2326 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2328  
was_³ndšg
;

2329 
	}
}

2331 #ifdeà
CONFIG_X86_64


2332 
	$ißpic_»Œigg”_œq
(
œq
)

2335 
œq_cfg
 *
cfg
 = 
	`œq_cfg
(
œq
);

2336 
æags
;

2338 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

2339 
­ic
->
	`£nd_IPI_mask
(
	`ıumask_of
(
	`ıumask_fœ¡
(
cfg
->
domaš
)), cfg->
veùÜ
);

2340 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

2343 
	}
}

2345 
	$ißpic_»Œigg”_œq
(
œq
)

2347 
­ic
->
	`£nd_IPI_£lf
(
	`œq_cfg
(
œq
)->
veùÜ
);

2350 
	}
}

2362 #ifdeà
CONFIG_SMP


2364 #ifdeà
CONFIG_INTR_REMAP


2378 
	$mig¿‹_ißpic_œq_desc
(
œq_desc
 *
desc
, cÚ¡ 
ıumask
 *
mask
)

2380 
œq_cfg
 *
cfg
;

2381 
œ‹
 irte;

2382 
de¡
;

2383 
œq
;

2385 ià(!
	`ıumask_š‹r£ùs
(
mask
, 
ıu_Úlše_mask
))

2388 
œq
 = 
desc
->irq;

2389 ià(
	`g‘_œ‹
(
œq
, &
œ‹
))

2392 
cfg
 = 
desc
->
ch_d©a
;

2393 ià(
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
mask
))

2396 
	`£t_exŒa_move_desc
(
desc
, 
mask
);

2398 
de¡
 = 
­ic
->
	`ıu_mask_to_­icid_ªd
(
cfg
->
domaš
, 
mask
);

2400 
œ‹
.
veùÜ
 = 
cfg
->vector;

2401 
œ‹
.
de¡_id
 = 
	`IRTE_DEST
(
de¡
);

2406 
	`modify_œ‹
(
œq
, &
œ‹
);

2408 ià(
cfg
->
move_š_´og»ss
)

2409 
	`£nd_ş—nup_veùÜ
(
cfg
);

2411 
	`ıumask_cİy
(
desc
->
affš™y
, 
mask
);

2412 
	}
}

2417 
	$£t_œ_ißpic_affš™y_œq_desc
(
œq_desc
 *
desc
,

2418 cÚ¡ 
ıumask
 *
mask
)

2420 
	`mig¿‹_ißpic_œq_desc
(
desc
, 
mask
);

2421 
	}
}

2422 
	$£t_œ_ißpic_affš™y_œq
(
œq
,

2423 cÚ¡ 
ıumask
 *
mask
)

2425 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

2427 
	`£t_œ_ißpic_affš™y_œq_desc
(
desc
, 
mask
);

2428 
	}
}

2430 
šlše
 
	$£t_œ_ißpic_affš™y_œq_desc
(
œq_desc
 *
desc
,

2431 cÚ¡ 
ıumask
 *
mask
)

2433 
	}
}

2436 
asmlškage
 
	$smp_œq_move_ş—nup_š‹¼u±
()

2438 
veùÜ
, 
me
;

2440 
	`ack_APIC_œq
();

2441 
	`ex™_idË
();

2442 
	`œq_’‹r
();

2444 
me
 = 
	`smp_´oûssÜ_id
();

2445 
veùÜ
 = 
FIRST_EXTERNAL_VECTOR
; veùÜ < 
NR_VECTORS
; vector++) {

2446 
œq
;

2447 
œr
;

2448 
œq_desc
 *
desc
;

2449 
œq_cfg
 *
cfg
;

2450 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
];

2452 ià(
œq
 == -1)

2455 
desc
 = 
	`œq_to_desc
(
œq
);

2456 ià(!
desc
)

2459 
cfg
 = 
	`œq_cfg
(
œq
);

2460 
	`¥š_lock
(&
desc
->
lock
);

2461 ià(!
cfg
->
move_ş—nup_couÁ
)

2462 
uÆock
;

2464 ià(
veùÜ
 =ğ
cfg
->veùÜ && 
	`ıumask_‹¡_ıu
(
me
, cfg->
domaš
))

2465 
uÆock
;

2467 
œr
 = 
	`­ic_»ad
(
APIC_IRR
 + (
veùÜ
 / 32 * 0x10));

2475 ià(
œr
 & (1 << (
veùÜ
 % 32))) {

2476 
­ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2477 
uÆock
;

2479 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
] = -1;

2480 
cfg
->
move_ş—nup_couÁ
--;

2481 
uÆock
:

2482 
	`¥š_uÆock
(&
desc
->
lock
);

2485 
	`œq_ex™
();

2486 
	}
}

2488 
	$œq_com¶‘e_move
(
œq_desc
 **
desı
)

2490 
œq_desc
 *
desc
 = *
desı
;

2491 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

2492 
veùÜ
, 
me
;

2494 ià(
	`lik–y
(!
cfg
->
move_š_´og»ss
)) {

2495 #ifdeà
CONFIG_NUMA_MIGRATE_IRQ_DESC


2496 ià(
	`lik–y
(!
cfg
->
move_desc_³ndšg
))

2500 
me
 = 
	`smp_´oûssÜ_id
();

2501 ià(
	`ıumask_‹¡_ıu
(
me
, 
desc
->
affš™y
)) {

2502 *
desı
 = 
desc
 = 
	`move_œq_desc
(desc, 
me
);

2504 
cfg
 = 
desc
->
ch_d©a
;

2505 
cfg
->
move_desc_³ndšg
 = 0;

2511 
veùÜ
 = ~
	`g‘_œq_»gs
()->
Üig_ax
;

2512 
me
 = 
	`smp_´oûssÜ_id
();

2514 ià(
veùÜ
 =ğ
cfg
->veùÜ && 
	`ıumask_‹¡_ıu
(
me
, cfg->
domaš
)) {

2515 #ifdeà
CONFIG_NUMA_MIGRATE_IRQ_DESC


2516 *
desı
 = 
desc
 = 
	`move_œq_desc
(desc, 
me
);

2518 
cfg
 = 
desc
->
ch_d©a
;

2520 
	`£nd_ş—nup_veùÜ
(
cfg
);

2522 
	}
}

2524 
šlše
 
	$œq_com¶‘e_move
(
œq_desc
 **
desı
è{
	}
}

2527 
	$__eoi_ißpic_œq
(
œq
, 
œq_cfg
 *
cfg
)

2529 
­ic
, 
pš
;

2530 
œq_pš_li¡
 *
’Œy
;

2532 
’Œy
 = 
cfg
->
œq_2_pš
;

2535 ià(!
’Œy
)

2538 
­ic
 = 
’Œy
->apic;

2539 
pš
 = 
’Œy
->pin;

2540 
	`io_­ic_eoi
(
­ic
, 
pš
);

2541 
’Œy
 =ƒÁry->
Ãxt
;

2543 
	}
}

2546 
	$eoi_ißpic_œq
(
œq_desc
 *
desc
)

2548 
œq_cfg
 *
cfg
;

2549 
æags
;

2550 
œq
;

2552 
œq
 = 
desc
->irq;

2553 
cfg
 = 
desc
->
ch_d©a
;

2555 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2556 
	`__eoi_ißpic_œq
(
œq
, 
cfg
);

2557 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2558 
	}
}

2560 #ifdeà
CONFIG_X86_X2APIC


2561 
	$ack_x2­ic_Ëv–
(
œq
)

2563 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

2564 
	`ack_x2APIC_œq
();

2565 
	`eoi_ißpic_œq
(
desc
);

2566 
	}
}

2568 
	$ack_x2­ic_edge
(
œq
)

2570 
	`ack_x2APIC_œq
();

2571 
	}
}

2574 
	$ack_­ic_edge
(
œq
)

2576 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

2578 
	`œq_com¶‘e_move
(&
desc
);

2579 
	`move_Çtive_œq
(
œq
);

2580 
	`ack_APIC_œq
();

2581 
	}
}

2583 
©omic_t
 
	gœq_mis_couÁ
;

2585 
	$ack_­ic_Ëv–
(
œq
)

2587 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

2589 #ifdeà
CONFIG_X86_32


2590 
v
;

2591 
i
;

2593 
œq_cfg
 *
cfg
;

2594 
do_unmask_œq
 = 0;

2596 
	`œq_com¶‘e_move
(&
desc
);

2597 #ifdeà
CONFIG_GENERIC_PENDING_IRQ


2599 ià(
	`uÆik–y
(
desc
->
¡©us
 & 
IRQ_MOVE_PENDING
)) {

2600 
do_unmask_œq
 = 1;

2601 
	`mask_IO_APIC_œq_desc
(
desc
);

2605 #ifdeà
CONFIG_X86_32


2625 
cfg
 = 
desc
->
ch_d©a
;

2626 
i
 = 
cfg
->
veùÜ
;

2628 
v
 = 
	`­ic_»ad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2635 
	`ack_APIC_œq
();

2637 ià(
	`œq_»m­³d
(
œq
))

2638 
	`eoi_ißpic_œq
(
desc
);

2641 ià(
	`uÆik–y
(
do_unmask_œq
)) {

2668 
cfg
 = 
desc
->
ch_d©a
;

2669 ià(!
	`io_­ic_Ëv–_ack_³ndšg
(
cfg
))

2670 
	`move_masked_œq
(
œq
);

2671 
	`unmask_IO_APIC_œq_desc
(
desc
);

2674 #ifdeà
CONFIG_X86_32


2675 ià(!(
v
 & (1 << (
i
 & 0x1f)))) {

2676 
	`©omic_šc
(&
œq_mis_couÁ
);

2677 
	`¥š_lock
(&
ißpic_lock
);

2678 
	`__mask_ªd_edge_IO_APIC_œq
(
cfg
);

2679 
	`__unmask_ªd_Ëv–_IO_APIC_œq
(
cfg
);

2680 
	`¥š_uÆock
(&
ißpic_lock
);

2683 
	}
}

2685 #ifdeà
CONFIG_INTR_REMAP


2686 
	$œ_ack_­ic_edge
(
œq
)

2688 #ifdeà
CONFIG_X86_X2APIC


2689 ià(
	`x2­ic_’abËd
())

2690  
	`ack_x2­ic_edge
(
œq
);

2692  
	`ack_­ic_edge
(
œq
);

2693 
	}
}

2695 
	$œ_ack_­ic_Ëv–
(
œq
)

2697 #ifdeà
CONFIG_X86_X2APIC


2698 ià(
	`x2­ic_’abËd
())

2699  
	`ack_x2­ic_Ëv–
(
œq
);

2701  
	`ack_­ic_Ëv–
(
œq
);

2702 
	}
}

2705 
œq_ch
 
ißpic_ch
 
	g__»ad_mo¡ly
 = {

2706 .
Çme
 = "IO-APIC",

2707 .
	g¡¬tup
 = 
¡¬tup_ißpic_œq
,

2708 .
	gmask
 = 
mask_IO_APIC_œq
,

2709 .
	gunmask
 = 
unmask_IO_APIC_œq
,

2710 .
	gack
 = 
ack_­ic_edge
,

2711 .
	geoi
 = 
ack_­ic_Ëv–
,

2712 #ifdeà
CONFIG_SMP


2713 .
	g£t_affš™y
 = 
£t_ißpic_affš™y_œq
,

2715 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

2718 
œq_ch
 
œ_ißpic_ch
 
	g__»ad_mo¡ly
 = {

2719 .
Çme
 = "IR-IO-APIC",

2720 .
	g¡¬tup
 = 
¡¬tup_ißpic_œq
,

2721 .
	gmask
 = 
mask_IO_APIC_œq
,

2722 .
	gunmask
 = 
unmask_IO_APIC_œq
,

2723 #ifdeà
CONFIG_INTR_REMAP


2724 .
	gack
 = 
œ_ack_­ic_edge
,

2725 .
	geoi
 = 
œ_ack_­ic_Ëv–
,

2726 #ifdeà
CONFIG_SMP


2727 .
	g£t_affš™y
 = 
£t_œ_ißpic_affš™y_œq
,

2730 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

2733 
šlše
 
	$š™_IO_APIC_Œ­s
()

2735 
œq
;

2736 
œq_desc
 *
desc
;

2737 
œq_cfg
 *
cfg
;

2750 
	`fÜ_—ch_œq_desc
(
œq
, 
desc
) {

2751 
cfg
 = 
desc
->
ch_d©a
;

2752 ià(
	`IO_APIC_IRQ
(
œq
è&& 
cfg
 && !cfg->
veùÜ
) {

2758 ià(
œq
 < 
NR_IRQS_LEGACY
)

2759 
	`make_8259A_œq
(
œq
);

2762 
desc
->
ch
 = &
no_œq_ch
;

2765 
	}
}

2771 
	$mask_Ïpic_œq
(
œq
)

2773 
v
;

2775 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

2776 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2777 
	}
}

2779 
	$unmask_Ïpic_œq
(
œq
)

2781 
v
;

2783 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

2784 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2785 
	}
}

2787 
	$ack_Ïpic_œq
(
œq
)

2789 
	`ack_APIC_œq
();

2790 
	}
}

2792 
œq_ch
 
Ïpic_ch
 
	g__»ad_mo¡ly
 = {

2793 .
Çme
 = "local-APIC",

2794 .
	gmask
 = 
mask_Ïpic_œq
,

2795 .
	gunmask
 = 
unmask_Ïpic_œq
,

2796 .
	gack
 = 
ack_Ïpic_œq
,

2799 
	$Ïpic_»gi¡”_šŒ
(
œq
, 
œq_desc
 *
desc
)

2801 
desc
->
¡©us
 &ğ~
IRQ_LEVEL
;

2802 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
Ïpic_ch
, 
hªdË_edge_œq
,

2804 
	}
}

2806 
__š™
 
	$£tup_nmi
()

2817 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2819 
	`’abË_NMI_through_LVT0
();

2821 
	`­ic_´štk
(
APIC_VERBOSE
, " done.\n");

2822 
	}
}

2831 
šlše
 
__š™
 
	$uÆock_ExtINT_logic
()

2833 
­ic
, 
pš
, 
i
;

2834 
IO_APIC_rou‹_’Œy
 
’Œy0
, 
’Œy1
;

2835 
§ve_cÚŒŞ
, 
§ve_äeq_£Ëù
;

2837 
pš
 = 
	`fšd_i§_œq_pš
(8, 
mp_INT
);

2838 ià(
pš
 == -1) {

2839 
	`WARN_ON_ONCE
(1);

2842 
­ic
 = 
	`fšd_i§_œq_­ic
(8, 
mp_INT
);

2843 ià(
­ic
 == -1) {

2844 
	`WARN_ON_ONCE
(1);

2848 
’Œy0
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

2849 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

2851 
	`mem£t
(&
’Œy1
, 0, (entry1));

2853 
’Œy1
.
de¡_mode
 = 0;

2854 
’Œy1
.
mask
 = 0;

2855 
’Œy1
.
de¡
 = 
	`h¬d_smp_´oûssÜ_id
();

2856 
’Œy1
.
d–iv”y_mode
 = 
de¡_ExtINT
;

2857 
’Œy1
.
pŞ¬™y
 = 
’Œy0
.polarity;

2858 
’Œy1
.
Œigg”
 = 0;

2859 
’Œy1
.
veùÜ
 = 0;

2861 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
’Œy1
);

2863 
§ve_cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2864 
§ve_äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2865 
	`CMOS_WRITE
((
§ve_äeq_£Ëù
 & ~
RTC_RATE_SELECT
) | 0x6,

2866 
RTC_FREQ_SELECT
);

2867 
	`CMOS_WRITE
(
§ve_cÚŒŞ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2869 
i
 = 100;

2870 
i
-- > 0) {

2871 
	`md–ay
(10);

2872 ià((
	`CMOS_READ
(
RTC_INTR_FLAGS
è& 
RTC_PF
) == RTC_PF)

2873 
i
 -= 10;

2876 
	`CMOS_WRITE
(
§ve_cÚŒŞ
, 
RTC_CONTROL
);

2877 
	`CMOS_WRITE
(
§ve_äeq_£Ëù
, 
RTC_FREQ_SELECT
);

2878 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

2880 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
’Œy0
);

2881 
	}
}

2883 
di§bË_tim”_pš_1
 
	g__š™d©a
;

2885 
__š™
 
	$di§bË_tim”_pš_£tup
(*
¬g
)

2887 
di§bË_tim”_pš_1
 = 1;

2889 
	}
}

2890 
—¾y_·¿m
("di§bË_tim”_pš_1", 
di§bË_tim”_pš_£tup
);

2892 
tim”_through_8259
 
	g__š™d©a
;

2902 
šlše
 
__š™
 
	$check_tim”
()

2904 
œq_desc
 *
desc
 = 
	`œq_to_desc
(0);

2905 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

2906 
ıu
 = 
boÙ_ıu_id
;

2907 
­ic1
, 
pš1
, 
­ic2
, 
pš2
;

2908 
æags
;

2909 
no_pš1
 = 0;

2911 
	`loÿl_œq_§ve
(
æags
);

2916 
	`di§bË_8259A_œq
(0);

2917 
	`assign_œq_veùÜ
(0, 
cfg
, 
­ic
->
	`rg‘_ıus
());

2928 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2929 
	`š™_8259A
(1);

2930 #ifdeà
CONFIG_X86_32


2932 
v”
;

2934 
v”
 = 
	`­ic_»ad
(
APIC_LVR
);

2935 
v”
 = 
	`GET_APIC_VERSION
(ver);

2936 
tim”_ack
 = (
nmi_w©chdog
 =ğ
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
v”
));

2940 
pš1
 = 
	`fšd_i§_œq_pš
(0, 
mp_INT
);

2941 
­ic1
 = 
	`fšd_i§_œq_­ic
(0, 
mp_INT
);

2942 
pš2
 = 
ißpic_i8259
.
pš
;

2943 
­ic2
 = 
ißpic_i8259
.
­ic
;

2945 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2947 
cfg
->
veùÜ
, 
­ic1
, 
pš1
, 
­ic2
, 
pš2
);

2956 ià(
pš1
 == -1) {

2957 ià(
šŒ_»m­pšg_’abËd
)

2958 
	`·nic
("BIOS bug:imer‚ot connectedo IO-APIC");

2959 
pš1
 = 
pš2
;

2960 
­ic1
 = 
­ic2
;

2961 
no_pš1
 = 1;

2962 } ià(
pš2
 == -1) {

2963 
pš2
 = 
pš1
;

2964 
­ic2
 = 
­ic1
;

2967 ià(
pš1
 != -1) {

2971 ià(
no_pš1
) {

2972 
	`add_pš_to_œq_ıu
(
cfg
, 
ıu
, 
­ic1
, 
pš1
);

2973 
	`£tup_tim”_IRQ0_pš
(
­ic1
, 
pš1
, 
cfg
->
veùÜ
);

2980 
idx
;

2981 
idx
 = 
	`fšd_œq_’Œy
(
­ic1
, 
pš1
, 
mp_INT
);

2982 ià(
idx
 !ğ-1 && 
	`œq_Œigg”
(idx))

2983 
	`unmask_IO_APIC_œq_desc
(
desc
);

2985 ià(
	`tim”_œq_wÜks
()) {

2986 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

2987 
	`£tup_nmi
();

2988 
	`’abË_8259A_œq
(0);

2990 ià(
di§bË_tim”_pš_1
 > 0)

2991 
	`ş—r_IO_APIC_pš
(0, 
pš1
);

2992 
out
;

2994 ià(
šŒ_»m­pšg_’abËd
)

2995 
	`·nic
("timer doesn't workhrough Interrupt-remapped IO-APIC");

2996 
	`loÿl_œq_di§bË
();

2997 
	`ş—r_IO_APIC_pš
(
­ic1
, 
pš1
);

2998 ià(!
no_pš1
)

2999 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

3002 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingo set upimer "

3004 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO


3005 "..... (found‡piø%d…š %dè...\n", 
­ic2
, 
pš2
);

3009 
	`»¶aû_pš_©_œq_ıu
(
cfg
, 
ıu
, 
­ic1
, 
pš1
, 
­ic2
, 
pš2
);

3010 
	`£tup_tim”_IRQ0_pš
(
­ic2
, 
pš2
, 
cfg
->
veùÜ
);

3011 
	`’abË_8259A_œq
(0);

3012 ià(
	`tim”_œq_wÜks
()) {

3013 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

3014 
tim”_through_8259
 = 1;

3015 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

3016 
	`di§bË_8259A_œq
(0);

3017 
	`£tup_nmi
();

3018 
	`’abË_8259A_œq
(0);

3020 
out
;

3025 
	`loÿl_œq_di§bË
();

3026 
	`di§bË_8259A_œq
(0);

3027 
	`ş—r_IO_APIC_pš
(
­ic2
, 
pš2
);

3028 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

3031 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

3032 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

3034 
nmi_w©chdog
 = 
NMI_NONE
;

3036 #ifdeà
CONFIG_X86_32


3037 
tim”_ack
 = 0;

3040 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO


3043 
	`Ïpic_»gi¡”_šŒ
(0, 
desc
);

3044 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
veùÜ
);

3045 
	`’abË_8259A_œq
(0);

3047 ià(
	`tim”_œq_wÜks
()) {

3048 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3049 
out
;

3051 
	`loÿl_œq_di§bË
();

3052 
	`di§bË_8259A_œq
(0);

3053 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
veùÜ
);

3054 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

3056 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO


3059 
	`š™_8259A
(0);

3060 
	`make_8259A_œq
(0);

3061 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

3063 
	`uÆock_ExtINT_logic
();

3065 ià(
	`tim”_œq_wÜks
()) {

3066 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3067 
out
;

3069 
	`loÿl_œq_di§bË
();

3070 
	`­ic_´štk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

3071 
	`·nic
("IO-APIC +imer doesn't work! Boot with‡pic=debug‡nd send‡ "

3073 
out
:

3074 
	`loÿl_œq_»¡Üe
(
æags
);

3075 
	}
}

3094 
	#PIC_IRQS
 (1 << 
PIC_CASCADE_IR
)

	)

3096 
__š™
 
	$£tup_IO_APIC
()

3103 
io_­ic_œqs
 = ~
PIC_IRQS
;

3105 
	`­ic_´štk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3109 #ifdeà
CONFIG_X86_32


3110 ià(!
aıi_ißpic
)

3111 
	`£tup_ißpic_ids_äom_mpc
();

3113 
	`sync_Arb_IDs
();

3114 
	`£tup_IO_APIC_œqs
();

3115 
	`š™_IO_APIC_Œ­s
();

3116 
	`check_tim”
();

3117 
	}
}

3124 
__š™
 
	$io_­ic_bug_fš®ize
()

3126 ià(
sis_­ic_bug
 == -1)

3127 
sis_­ic_bug
 = 0;

3129 
	}
}

3131 
Ï‹_š™ÿÎ
(
io_­ic_bug_fš®ize
);

3133 
	ssysfs_ißpic_d©a
 {

3134 
sys_deviû
 
	mdev
;

3135 
IO_APIC_rou‹_’Œy
 
	m’Œy
[0];

3137 
sysfs_ißpic_d©a
 * 
	gmp_ißpic_d©a
[
MAX_IO_APICS
];

3139 
	$ißpic_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

3141 
IO_APIC_rou‹_’Œy
 *
’Œy
;

3142 
sysfs_ißpic_d©a
 *
d©a
;

3143 
i
;

3145 
d©a
 = 
	`cÚš”_of
(
dev
, 
sysfs_ißpic_d©a
, dev);

3146 
’Œy
 = 
d©a
->entry;

3147 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
dev
->
id
]; i ++, 
’Œy
 ++ )

3148 *
’Œy
 = 
	`ißpic_»ad_’Œy
(
dev
->
id
, 
i
);

3151 
	}
}

3153 
	$ißpic_»sume
(
sys_deviû
 *
dev
)

3155 
IO_APIC_rou‹_’Œy
 *
’Œy
;

3156 
sysfs_ißpic_d©a
 *
d©a
;

3157 
æags
;

3158 
IO_APIC_»g_00
 
»g_00
;

3159 
i
;

3161 
d©a
 = 
	`cÚš”_of
(
dev
, 
sysfs_ißpic_d©a
, dev);

3162 
’Œy
 = 
d©a
->entry;

3164 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

3165 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
dev
->
id
, 0);

3166 ià(
»g_00
.
b™s
.
ID
 !ğ
mp_ißpics
[
dev
->
id
].
­icid
) {

3167 
»g_00
.
b™s
.
ID
 = 
mp_ißpics
[
dev
->
id
].
­icid
;

3168 
	`io_­ic_wr™e
(
dev
->
id
, 0, 
»g_00
.
¿w
);

3170 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

3171 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
dev
->
id
]; i++)

3172 
	`ißpic_wr™e_’Œy
(
dev
->
id
, 
i
, 
’Œy
[i]);

3175 
	}
}

3177 
sysdev_şass
 
	gißpic_sysdev_şass
 = {

3178 .
Çme
 = "ioapic",

3179 .
	gsu¥’d
 = 
ißpic_su¥’d
,

3180 .
	g»sume
 = 
ißpic_»sume
,

3183 
__š™
 
	$ißpic_š™_sysfs
()

3185 
sys_deviû
 * 
dev
;

3186 
i
, 
size
, 
”rÜ
;

3188 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
ißpic_sysdev_şass
);

3189 ià(
”rÜ
)

3190  
”rÜ
;

3192 
i
 = 0; i < 
Ä_ißpics
; i++ ) {

3193 
size
 = (
sys_deviû
è+ 
Ä_ißpic_»gi¡”s
[
i
]

3194 * (
IO_APIC_rou‹_’Œy
);

3195 
mp_ißpic_d©a
[
i
] = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

3196 ià(!
mp_ißpic_d©a
[
i
]) {

3197 
	`´štk
(
KERN_ERR
 "Cª'ˆsu¥’d/»sumIOAPIC %d\n", 
i
);

3200 
dev
 = &
mp_ißpic_d©a
[
i
]->dev;

3201 
dev
->
id
 = 
i
;

3202 
dev
->
şs
 = &
ißpic_sysdev_şass
;

3203 
”rÜ
 = 
	`sysdev_»gi¡”
(
dev
);

3204 ià(
”rÜ
) {

3205 
	`kä“
(
mp_ißpic_d©a
[
i
]);

3206 
mp_ißpic_d©a
[
i
] = 
NULL
;

3207 
	`´štk
(
KERN_ERR
 "Cª'ˆsu¥’d/»sumIOAPIC %d\n", 
i
);

3213 
	}
}

3215 
deviû_š™ÿÎ
(
ißpic_š™_sysfs
);

3217 
	gÄ_œqs_gsi
 = 
NR_IRQS_LEGACY
;

3221 
	$ü—‹_œq_Ä
(
œq_wªt
)

3224 
œq
;

3225 
Ãw
;

3226 
æags
;

3227 
œq_cfg
 *
cfg_Ãw
 = 
NULL
;

3228 
ıu
 = 
boÙ_ıu_id
;

3229 
œq_desc
 *
desc_Ãw
 = 
NULL
;

3231 
œq
 = 0;

3232 ià(
œq_wªt
 < 
Ä_œqs_gsi
)

3233 
œq_wªt
 = 
Ä_œqs_gsi
;

3235 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

3236 
Ãw
 = 
œq_wªt
;‚ew < 
Ä_œqs
;‚ew++) {

3237 
desc_Ãw
 = 
	`œq_to_desc_®loc_ıu
(
Ãw
, 
ıu
);

3238 ià(!
desc_Ãw
) {

3239 
	`´štk
(
KERN_INFO
 "ÿÀnÙ g‘ irq_desøfÜ %d\n", 
Ãw
);

3242 
cfg_Ãw
 = 
desc_Ãw
->
ch_d©a
;

3244 ià(
cfg_Ãw
->
veùÜ
 != 0)

3246 ià(
	`__assign_œq_veùÜ
(
Ãw
, 
cfg_Ãw
, 
­ic
->
	`rg‘_ıus
()) == 0)

3247 
œq
 = 
Ãw
;

3250 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

3252 ià(
œq
 > 0) {

3253 
	`dyÇmic_œq_š™
(
œq
);

3255 ià(
desc_Ãw
)

3256 
desc_Ãw
->
ch_d©a
 = 
cfg_Ãw
;

3258  
œq
;

3259 
	}
}

3261 
	$ü—‹_œq
()

3263 
œq_wªt
;

3264 
œq
;

3266 
œq_wªt
 = 
Ä_œqs_gsi
;

3267 
œq
 = 
	`ü—‹_œq_Ä
(
œq_wªt
);

3269 ià(
œq
 == 0)

3270 
œq
 = -1;

3272  
œq
;

3273 
	}
}

3275 
	$de¡roy_œq
(
œq
)

3277 
æags
;

3278 
œq_cfg
 *
cfg
;

3279 
œq_desc
 *
desc
;

3282 
desc
 = 
	`œq_to_desc
(
œq
);

3283 
cfg
 = 
desc
->
ch_d©a
;

3284 
	`dyÇmic_œq_ş—nup
(
œq
);

3286 ià(
desc
)

3287 
desc
->
ch_d©a
 = 
cfg
;

3289 
	`ä“_œ‹
(
œq
);

3290 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

3291 
	`__ş—r_œq_veùÜ
(
œq
, 
cfg
);

3292 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

3293 
	}
}

3298 #ifdeà
CONFIG_PCI_MSI


3299 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
œq
, 
msi_msg
 *
msg
)

3301 
œq_cfg
 *
cfg
;

3302 
”r
;

3303 
de¡
;

3305 ià(
di§bË_­ic
)

3306  -
ENXIO
;

3308 
cfg
 = 
	`œq_cfg
(
œq
);

3309 
”r
 = 
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
­ic
->
	`rg‘_ıus
());

3310 ià(
”r
)

3311  
”r
;

3313 
de¡
 = 
­ic
->
	`ıu_mask_to_­icid_ªd
(
cfg
->
domaš
,‡pic->
	`rg‘_ıus
());

3315 ià(
	`œq_»m­³d
(
œq
)) {

3316 
œ‹
 irte;

3317 
œ_šdex
;

3318 
u16
 
sub_hªdË
;

3320 
œ_šdex
 = 
	`m­_œq_to_œ‹_hªdË
(
œq
, &
sub_hªdË
);

3321 
	`BUG_ON
(
œ_šdex
 == -1);

3323 
	`mem£t
 (&
œ‹
, 0, (irte));

3325 
œ‹
.
´e£Á
 = 1;

3326 
œ‹
.
d¡_mode
 = 
­ic
->
œq_de¡_mode
;

3327 
œ‹
.
Œigg”_mode
 = 0;

3328 
œ‹
.
dlvry_mode
 = 
­ic
->
œq_d–iv”y_mode
;

3329 
œ‹
.
veùÜ
 = 
cfg
->vector;

3330 
œ‹
.
de¡_id
 = 
	`IRTE_DEST
(
de¡
);

3332 
	`modify_œ‹
(
œq
, &
œ‹
);

3334 
msg
->
add»ss_hi
 = 
MSI_ADDR_BASE_HI
;

3335 
msg
->
d©a
 = 
sub_hªdË
;

3336 
msg
->
add»ss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3337 
MSI_ADDR_IR_SHV
 |

3338 
	`MSI_ADDR_IR_INDEX1
(
œ_šdex
) |

3339 
	`MSI_ADDR_IR_INDEX2
(
œ_šdex
);

3341 ià(
	`x2­ic_’abËd
())

3342 
msg
->
add»ss_hi
 = 
MSI_ADDR_BASE_HI
 |

3343 
	`MSI_ADDR_EXT_DEST_ID
(
de¡
);

3345 
msg
->
add»ss_hi
 = 
MSI_ADDR_BASE_HI
;

3347 
msg
->
add»ss_lo
 =

3348 
MSI_ADDR_BASE_LO
 |

3349 ((
­ic
->
œq_de¡_mode
 == 0) ?

3350 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3351 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3352 ((
­ic
->
œq_d–iv”y_mode
 !ğ
de¡_Lowe¡Prio
) ?

3353 
MSI_ADDR_REDIRECTION_CPU
:

3354 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3355 
	`MSI_ADDR_DEST_ID
(
de¡
);

3357 
msg
->
d©a
 =

3358 
MSI_DATA_TRIGGER_EDGE
 |

3359 
MSI_DATA_LEVEL_ASSERT
 |

3360 ((
­ic
->
œq_d–iv”y_mode
 !ğ
de¡_Lowe¡Prio
) ?

3361 
MSI_DATA_DELIVERY_FIXED
:

3362 
MSI_DATA_DELIVERY_LOWPRI
) |

3363 
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

3365  
”r
;

3366 
	}
}

3368 #ifdeà
CONFIG_SMP


3369 
	$£t_msi_œq_affš™y
(
œq
, cÚ¡ 
ıumask
 *
mask
)

3371 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3372 
œq_cfg
 *
cfg
;

3373 
msi_msg
 
msg
;

3374 
de¡
;

3376 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

3377 ià(
de¡
 =ğ
BAD_APICID
)

3380 
cfg
 = 
desc
->
ch_d©a
;

3382 
	`»ad_msi_msg_desc
(
desc
, &
msg
);

3384 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

3385 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

3386 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

3387 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

3389 
	`wr™e_msi_msg_desc
(
desc
, &
msg
);

3390 
	}
}

3391 #ifdeà
CONFIG_INTR_REMAP


3397 
	$œ_£t_msi_œq_affš™y
(
œq
, cÚ¡ 
ıumask
 *
mask
)

3399 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3400 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

3401 
de¡
;

3402 
œ‹
 irte;

3404 ià(
	`g‘_œ‹
(
œq
, &
œ‹
))

3407 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

3408 ià(
de¡
 =ğ
BAD_APICID
)

3411 
œ‹
.
veùÜ
 = 
cfg
->vector;

3412 
œ‹
.
de¡_id
 = 
	`IRTE_DEST
(
de¡
);

3417 
	`modify_œ‹
(
œq
, &
œ‹
);

3424 ià(
cfg
->
move_š_´og»ss
)

3425 
	`£nd_ş—nup_veùÜ
(
cfg
);

3426 
	}
}

3435 
œq_ch
 
	gmsi_ch
 = {

3436 .
Çme
 = "PCI-MSI",

3437 .
	gunmask
 = 
unmask_msi_œq
,

3438 .
	gmask
 = 
mask_msi_œq
,

3439 .
	gack
 = 
ack_­ic_edge
,

3440 #ifdeà
CONFIG_SMP


3441 .
	g£t_affš™y
 = 
£t_msi_œq_affš™y
,

3443 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

3446 
œq_ch
 
	gmsi_œ_ch
 = {

3447 .
Çme
 = "IR-PCI-MSI",

3448 .
	gunmask
 = 
unmask_msi_œq
,

3449 .
	gmask
 = 
mask_msi_œq
,

3450 #ifdeà
CONFIG_INTR_REMAP


3451 .
	gack
 = 
œ_ack_­ic_edge
,

3452 #ifdeà
CONFIG_SMP


3453 .
	g£t_affš™y
 = 
œ_£t_msi_œq_affš™y
,

3456 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

3464 
	$msi_®loc_œ‹
(
pci_dev
 *
dev
, 
œq
, 
nvec
)

3466 
š‹l_iommu
 *
iommu
;

3467 
šdex
;

3469 
iommu
 = 
	`m­_dev_to_œ
(
dev
);

3470 ià(!
iommu
) {

3471 
	`´štk
(
KERN_ERR


3472 "UÇbËØm­ PCI % tØiommu\n", 
	`pci_Çme
(
dev
));

3473  -
ENOENT
;

3476 
šdex
 = 
	`®loc_œ‹
(
iommu
, 
œq
, 
nvec
);

3477 ià(
šdex
 < 0) {

3478 
	`´štk
(
KERN_ERR


3479 "UÇbËØ®loÿ‹ %d IRTE fÜ PCI %s\n", 
nvec
,

3480 
	`pci_Çme
(
dev
));

3481  -
ENOSPC
;

3483  
šdex
;

3484 
	}
}

3486 
	$£tup_msi_œq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
œq
)

3488 
»t
;

3489 
msi_msg
 
msg
;

3491 
»t
 = 
	`msi_compo£_msg
(
dev
, 
œq
, &
msg
);

3492 ià(
»t
 < 0)

3493  
»t
;

3495 
	`£t_œq_msi
(
œq
, 
msidesc
);

3496 
	`wr™e_msi_msg
(
œq
, &
msg
);

3498 ià(
	`œq_»m­³d
(
œq
)) {

3499 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3503 
desc
->
¡©us
 |ğ
IRQ_MOVE_PCNTXT
;

3504 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
msi_œ_ch
, 
hªdË_edge_œq
, "edge");

3506 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
msi_ch
, 
hªdË_edge_œq
, "edge");

3508 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "œq %d fÜ MSI/MSI-X\n", 
œq
);

3511 
	}
}

3513 
	$¬ch_£tup_msi_œqs
(
pci_dev
 *
dev
, 
nvec
, 
ty³
)

3515 
œq
;

3516 
»t
, 
sub_hªdË
;

3517 
msi_desc
 *
msidesc
;

3518 
œq_wªt
;

3519 
š‹l_iommu
 *
iommu
 = 
NULL
;

3520 
šdex
 = 0;

3523 ià(
ty³
 =ğ
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3526 
œq_wªt
 = 
Ä_œqs_gsi
;

3527 
sub_hªdË
 = 0;

3528 
	`li¡_fÜ_—ch_’Œy
(
msidesc
, &
dev
->
msi_li¡
, 
li¡
) {

3529 
œq
 = 
	`ü—‹_œq_Ä
(
œq_wªt
);

3530 ià(
œq
 == 0)

3532 
œq_wªt
 = 
œq
 + 1;

3533 ià(!
šŒ_»m­pšg_’abËd
)

3534 
no_œ
;

3536 ià(!
sub_hªdË
) {

3541 
šdex
 = 
	`msi_®loc_œ‹
(
dev
, 
œq
, 
nvec
);

3542 ià(
šdex
 < 0) {

3543 
»t
 = 
šdex
;

3544 
”rÜ
;

3547 
iommu
 = 
	`m­_dev_to_œ
(
dev
);

3548 ià(!
iommu
) {

3549 
»t
 = -
ENOENT
;

3550 
”rÜ
;

3557 
	`£t_œ‹_œq
(
œq
, 
iommu
, 
šdex
, 
sub_hªdË
);

3559 
no_œ
:

3560 
»t
 = 
	`£tup_msi_œq
(
dev
, 
msidesc
, 
œq
);

3561 ià(
»t
 < 0)

3562 
”rÜ
;

3563 
sub_hªdË
++;

3567 
”rÜ
:

3568 
	`de¡roy_œq
(
œq
);

3569  
»t
;

3570 
	}
}

3572 
	$¬ch_‹¬down_msi_œq
(
œq
)

3574 
	`de¡roy_œq
(
œq
);

3575 
	}
}

3577 #ià
defšed
 (
CONFIG_DMAR
è|| defšed (
CONFIG_INTR_REMAP
)

3578 #ifdeà
CONFIG_SMP


3579 
	$dm¬_msi_£t_affš™y
(
œq
, cÚ¡ 
ıumask
 *
mask
)

3581 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3582 
œq_cfg
 *
cfg
;

3583 
msi_msg
 
msg
;

3584 
de¡
;

3586 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

3587 ià(
de¡
 =ğ
BAD_APICID
)

3590 
cfg
 = 
desc
->
ch_d©a
;

3592 
	`dm¬_msi_»ad
(
œq
, &
msg
);

3594 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

3595 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

3596 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

3597 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

3599 
	`dm¬_msi_wr™e
(
œq
, &
msg
);

3600 
	}
}

3604 
œq_ch
 
	gdm¬_msi_ty³
 = {

3605 .
Çme
 = "DMAR_MSI",

3606 .
	gunmask
 = 
dm¬_msi_unmask
,

3607 .
	gmask
 = 
dm¬_msi_mask
,

3608 .
	gack
 = 
ack_­ic_edge
,

3609 #ifdeà
CONFIG_SMP


3610 .
	g£t_affš™y
 = 
dm¬_msi_£t_affš™y
,

3612 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

3615 
	$¬ch_£tup_dm¬_msi
(
œq
)

3617 
»t
;

3618 
msi_msg
 
msg
;

3620 
»t
 = 
	`msi_compo£_msg
(
NULL
, 
œq
, &
msg
);

3621 ià(
»t
 < 0)

3622  
»t
;

3623 
	`dm¬_msi_wr™e
(
œq
, &
msg
);

3624 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
dm¬_msi_ty³
, 
hªdË_edge_œq
,

3627 
	}
}

3630 #ifdeà
CONFIG_HPET_TIMER


3632 #ifdeà
CONFIG_SMP


3633 
	$h³t_msi_£t_affš™y
(
œq
, cÚ¡ 
ıumask
 *
mask
)

3635 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3636 
œq_cfg
 *
cfg
;

3637 
msi_msg
 
msg
;

3638 
de¡
;

3640 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

3641 ià(
de¡
 =ğ
BAD_APICID
)

3644 
cfg
 = 
desc
->
ch_d©a
;

3646 
	`h³t_msi_»ad
(
œq
, &
msg
);

3648 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

3649 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

3650 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

3651 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

3653 
	`h³t_msi_wr™e
(
œq
, &
msg
);

3654 
	}
}

3658 
œq_ch
 
	gh³t_msi_ty³
 = {

3659 .
Çme
 = "HPET_MSI",

3660 .
	gunmask
 = 
h³t_msi_unmask
,

3661 .
	gmask
 = 
h³t_msi_mask
,

3662 .
	gack
 = 
ack_­ic_edge
,

3663 #ifdeà
CONFIG_SMP


3664 .
	g£t_affš™y
 = 
h³t_msi_£t_affš™y
,

3666 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

3669 
	$¬ch_£tup_h³t_msi
(
œq
)

3671 
»t
;

3672 
msi_msg
 
msg
;

3673 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3675 
»t
 = 
	`msi_compo£_msg
(
NULL
, 
œq
, &
msg
);

3676 ià(
»t
 < 0)

3677  
»t
;

3679 
	`h³t_msi_wr™e
(
œq
, &
msg
);

3680 
desc
->
¡©us
 |ğ
IRQ_MOVE_PCNTXT
;

3681 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
h³t_msi_ty³
, 
hªdË_edge_œq
,

3685 
	}
}

3692 #ifdeà
CONFIG_HT_IRQ


3694 #ifdeà
CONFIG_SMP


3696 
	$rg‘_ht_œq
(
œq
, 
de¡
, 
u8
 
veùÜ
)

3698 
ht_œq_msg
 
msg
;

3699 
	`ãtch_ht_œq_msg
(
œq
, &
msg
);

3701 
msg
.
add»ss_lo
 &ğ~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3702 
msg
.
add»ss_hi
 &ğ~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3704 
msg
.
add»ss_lo
 |ğ
	`HT_IRQ_LOW_VECTOR
(
veùÜ
è| 
	`HT_IRQ_LOW_DEST_ID
(
de¡
);

3705 
msg
.
add»ss_hi
 |ğ
	`HT_IRQ_HIGH_DEST_ID
(
de¡
);

3707 
	`wr™e_ht_œq_msg
(
œq
, &
msg
);

3708 
	}
}

3710 
	$£t_ht_œq_affš™y
(
œq
, cÚ¡ 
ıumask
 *
mask
)

3712 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

3713 
œq_cfg
 *
cfg
;

3714 
de¡
;

3716 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

3717 ià(
de¡
 =ğ
BAD_APICID
)

3720 
cfg
 = 
desc
->
ch_d©a
;

3722 
	`rg‘_ht_œq
(
œq
, 
de¡
, 
cfg
->
veùÜ
);

3723 
	}
}

3727 
œq_ch
 
	ght_œq_ch
 = {

3728 .
Çme
 = "PCI-HT",

3729 .
	gmask
 = 
mask_ht_œq
,

3730 .
	gunmask
 = 
unmask_ht_œq
,

3731 .
	gack
 = 
ack_­ic_edge
,

3732 #ifdeà
CONFIG_SMP


3733 .
	g£t_affš™y
 = 
£t_ht_œq_affš™y
,

3735 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

3738 
	$¬ch_£tup_ht_œq
(
œq
, 
pci_dev
 *
dev
)

3740 
œq_cfg
 *
cfg
;

3741 
”r
;

3743 ià(
di§bË_­ic
)

3744  -
ENXIO
;

3746 
cfg
 = 
	`œq_cfg
(
œq
);

3747 
”r
 = 
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
­ic
->
	`rg‘_ıus
());

3748 ià(!
”r
) {

3749 
ht_œq_msg
 
msg
;

3750 
de¡
;

3752 
de¡
 = 
­ic
->
	`ıu_mask_to_­icid_ªd
(
cfg
->
domaš
,

3753 
­ic
->
	`rg‘_ıus
());

3755 
msg
.
add»ss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de¡
);

3757 
msg
.
add»ss_lo
 =

3758 
HT_IRQ_LOW_BASE
 |

3759 
	`HT_IRQ_LOW_DEST_ID
(
de¡
) |

3760 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
veùÜ
) |

3761 ((
­ic
->
œq_de¡_mode
 == 0) ?

3762 
HT_IRQ_LOW_DM_PHYSICAL
 :

3763 
HT_IRQ_LOW_DM_LOGICAL
) |

3764 
HT_IRQ_LOW_RQEOI_EDGE
 |

3765 ((
­ic
->
œq_d–iv”y_mode
 !ğ
de¡_Lowe¡Prio
) ?

3766 
HT_IRQ_LOW_MT_FIXED
 :

3767 
HT_IRQ_LOW_MT_ARBITRATED
) |

3768 
HT_IRQ_LOW_IRQ_MASKED
;

3770 
	`wr™e_ht_œq_msg
(
œq
, &
msg
);

3772 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ht_œq_ch
,

3773 
hªdË_edge_œq
, "edge");

3775 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "œq %d fÜ HT\n", 
œq
);

3777  
”r
;

3778 
	}
}

3781 #ifdeà
CONFIG_X86_UV


3786 
	$¬ch_’abË_uv_œq
(*
œq_Çme
, 
œq
, 
ıu
, 
mmr_bÏde
,

3787 
mmr_off£t
)

3789 cÚ¡ 
ıumask
 *
–igibË_ıu
 = 
	`ıumask_of
(
ıu
);

3790 
œq_cfg
 *
cfg
;

3791 
mmr_²ode
;

3792 
mmr_v®ue
;

3793 
uv_IO_APIC_rou‹_’Œy
 *
’Œy
;

3794 
æags
;

3795 
”r
;

3797 
cfg
 = 
	`œq_cfg
(
œq
);

3799 
”r
 = 
	`assign_œq_veùÜ
(
œq
, 
cfg
, 
–igibË_ıu
);

3800 ià(
”r
 != 0)

3801  
”r
;

3803 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

3804 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
uv_œq_ch
, 
hªdË_³rıu_œq
,

3805 
œq_Çme
);

3806 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

3808 
mmr_v®ue
 = 0;

3809 
’Œy
 = (
uv_IO_APIC_rou‹_’Œy
 *)&
mmr_v®ue
;

3810 
	`BUG_ON
((
uv_IO_APIC_rou‹_’Œy
) != ());

3812 
’Œy
->
veùÜ
 = 
cfg
->vector;

3813 
’Œy
->
d–iv”y_mode
 = 
­ic
->
œq_d–iv”y_mode
;

3814 
’Œy
->
de¡_mode
 = 
­ic
->
œq_de¡_mode
;

3815 
’Œy
->
pŞ¬™y
 = 0;

3816 
’Œy
->
Œigg”
 = 0;

3817 
’Œy
->
mask
 = 0;

3818 
’Œy
->
de¡
 = 
­ic
->
	`ıu_mask_to_­icid
(
–igibË_ıu
);

3820 
mmr_²ode
 = 
	`uv_bÏde_to_²ode
(
mmr_bÏde
);

3821 
	`uv_wr™e_glob®_mmr64
(
mmr_²ode
, 
mmr_off£t
, 
mmr_v®ue
);

3823  
œq
;

3824 
	}
}

3830 
	$¬ch_di§bË_uv_œq
(
mmr_bÏde
, 
mmr_off£t
)

3832 
mmr_v®ue
;

3833 
uv_IO_APIC_rou‹_’Œy
 *
’Œy
;

3834 
mmr_²ode
;

3836 
mmr_v®ue
 = 0;

3837 
’Œy
 = (
uv_IO_APIC_rou‹_’Œy
 *)&
mmr_v®ue
;

3838 
	`BUG_ON
((
uv_IO_APIC_rou‹_’Œy
) != ());

3840 
’Œy
->
mask
 = 1;

3842 
mmr_²ode
 = 
	`uv_bÏde_to_²ode
(
mmr_bÏde
);

3843 
	`uv_wr™e_glob®_mmr64
(
mmr_²ode
, 
mmr_off£t
, 
mmr_v®ue
);

3844 
	}
}

3847 
__š™
 
	$io_­ic_g‘_»dœ_’Œ›s
 (
ißpic
)

3849 
IO_APIC_»g_01
 
»g_01
;

3850 
æags
;

3852 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

3853 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 1);

3854 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

3856  
»g_01
.
b™s
.
’Œ›s
;

3857 
	}
}

3859 
__š™
 
	$´obe_Ä_œqs_gsi
()

3861 
Ä
 = 0;

3863 
Ä
 = 
	`aıi_´obe_gsi
();

3864 ià(
Ä
 > 
Ä_œqs_gsi
) {

3865 
Ä_œqs_gsi
 = 
Ä
;

3868 
idx
;

3870 
Ä
 = 0;

3871 
idx
 = 0; idx < 
Ä_ißpics
; idx++)

3872 
Ä
 +ğ
	`io_­ic_g‘_»dœ_’Œ›s
(
idx
) + 1;

3874 ià(
Ä
 > 
Ä_œqs_gsi
)

3875 
Ä_œqs_gsi
 = 
Ä
;

3878 
	`´štk
(
KERN_DEBUG
 "Ä_œqs_gsi: %d\n", 
Ä_œqs_gsi
);

3879 
	}
}

3881 #ifdeà
CONFIG_SPARSE_IRQ


3882 
__š™
 
	$¬ch_´obe_Ä_œqs
()

3884 
Ä
;

3886 ià(
Ä_œqs
 > (
NR_VECTORS
 * 
Ä_ıu_ids
))

3887 
Ä_œqs
 = 
NR_VECTORS
 * 
Ä_ıu_ids
;

3889 
Ä
 = 
Ä_œqs_gsi
 + 8 * 
Ä_ıu_ids
;

3890 #ià
	`defšed
(
CONFIG_PCI_MSI
è|| defšed(
CONFIG_HT_IRQ
)

3894 
Ä
 +ğ
Ä_œqs_gsi
 * 16;

3896 ià(
Ä
 < 
Ä_œqs
)

3897 
Ä_œqs
 = 
Ä
;

3900 
	}
}

3907 #ifdeà
CONFIG_ACPI


3909 #ifdeà
CONFIG_X86_32


3910 
__š™
 
	$io_­ic_g‘_unique_id
(
ißpic
, 
­ic_id
)

3912 
IO_APIC_»g_00
 
»g_00
;

3913 
physid_mask_t
 
­ic_id_m­
 = 
PHYSID_MASK_NONE
;

3914 
physid_mask_t
 
tmp
;

3915 
æags
;

3916 
i
 = 0;

3927 ià(
	`physids_em±y
(
­ic_id_m­
))

3928 
­ic_id_m­
 = 
­ic
->
	`ißpic_phys_id_m­
(
phys_ıu_´e£Á_m­
);

3930 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

3931 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 0);

3932 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

3934 ià(
­ic_id
 >ğ
	`g‘_physiÿl_brßdÿ¡
()) {

3935 
	`´štk
(
KERN_WARNING
 "IOAPIC[%d]: Invalid‡pic_id %d,rying "

3936 "%d\n", 
ißpic
, 
­ic_id
, 
»g_00
.
b™s
.
ID
);

3937 
­ic_id
 = 
»g_00
.
b™s
.
ID
;

3944 ià(
­ic
->
	`check_­icid_u£d
(
­ic_id_m­
, 
­ic_id
)) {

3946 
i
 = 0; i < 
	`g‘_physiÿl_brßdÿ¡
(); i++) {

3947 ià(!
­ic
->
	`check_­icid_u£d
(
­ic_id_m­
, 
i
))

3951 ià(
i
 =ğ
	`g‘_physiÿl_brßdÿ¡
())

3952 
	`·nic
("Max‡pic_idƒxceeded!\n");

3954 
	`´štk
(
KERN_WARNING
 "IOAPIC[%d]:‡pic_id %d‡lready used, "

3955 "Œyšg %d\n", 
ißpic
, 
­ic_id
, 
i
);

3957 
­ic_id
 = 
i
;

3960 
tmp
 = 
­ic
->
	`­icid_to_ıu_´e£Á
(
­ic_id
);

3961 
	`physids_Ü
(
­ic_id_m­
,‡pic_id_m­, 
tmp
);

3963 ià(
»g_00
.
b™s
.
ID
 !ğ
­ic_id
) {

3964 
»g_00
.
b™s
.
ID
 = 
­ic_id
;

3966 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

3967 
	`io_­ic_wr™e
(
ißpic
, 0, 
»g_00
.
¿w
);

3968 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 0);

3969 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

3972 ià(
»g_00
.
b™s
.
ID
 !ğ
­ic_id
) {

3973 
	`´štk
("IOAPIC[%d]: UÇbËØchªg­ic_id!\n", 
ißpic
);

3978 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


3979 "IOAPIC[%d]: AssigÃd‡pic_id %d\n", 
ißpic
, 
­ic_id
);

3981  
­ic_id
;

3982 
	}
}

3984 
__š™
 
	$io_­ic_g‘_v”siÚ
(
ißpic
)

3986 
IO_APIC_»g_01
 
»g_01
;

3987 
æags
;

3989 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

3990 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 1);

3991 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

3993  
»g_01
.
b™s
.
v”siÚ
;

3994 
	}
}

3997 
	$io_­ic_£t_pci_routšg
 (
ißpic
, 
pš
, 
œq
, 
Œigg”šg
, 
pŞ¬™y
)

3999 
œq_desc
 *
desc
;

4000 
œq_cfg
 *
cfg
;

4001 
ıu
 = 
boÙ_ıu_id
;

4003 ià(!
	`IO_APIC_IRQ
(
œq
)) {

4004 
	`­ic_´štk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: Invalid„eferenceo IRQ 0\n",

4005 
ißpic
);

4006  -
EINVAL
;

4009 
desc
 = 
	`œq_to_desc_®loc_ıu
(
œq
, 
ıu
);

4010 ià(!
desc
) {

4011 
	`´štk
(
KERN_INFO
 "ÿÀnÙ g‘ irq_desø%d\n", 
œq
);

4018 ià(
œq
 >ğ
NR_IRQS_LEGACY
) {

4019 
cfg
 = 
desc
->
ch_d©a
;

4020 
	`add_pš_to_œq_ıu
(
cfg
, 
ıu
, 
ißpic
, 
pš
);

4023 
	`£tup_IO_APIC_œq
(
ißpic
, 
pš
, 
œq
, 
desc
, 
Œigg”šg
, 
pŞ¬™y
);

4026 
	}
}

4029 
	$aıi_g‘_ov”ride_œq
(
bus_œq
, *
Œigg”
, *
pŞ¬™y
)

4031 
i
;

4033 ià(
sk_ißpic_£tup
)

4036 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

4037 ià(
mp_œqs
[
i
].
œqty³
 =ğ
mp_INT
 &&

4038 
mp_œqs
[
i
].
¤cbusœq
 =ğ
bus_œq
)

4040 ià(
i
 >ğ
mp_œq_’Œ›s
)

4043 *
Œigg”
 = 
	`œq_Œigg”
(
i
);

4044 *
pŞ¬™y
 = 
	`œq_pŞ¬™y
(
i
);

4046 
	}
}

4055 #ifdeà
CONFIG_SMP


4056 
__š™
 
	$£tup_ißpic_de¡
()

4058 
pš
, 
ißpic
, 
œq
, 
œq_’Œy
;

4059 
œq_desc
 *
desc
;

4060 
œq_cfg
 *
cfg
;

4061 cÚ¡ 
ıumask
 *
mask
;

4063 ià(
sk_ißpic_£tup
 == 1)

4066 
ißpic
 = 0; ißpiø< 
Ä_ißpics
; ioapic++) {

4067 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
ißpic
];…in++) {

4068 
œq_’Œy
 = 
	`fšd_œq_’Œy
(
ißpic
, 
pš
, 
mp_INT
);

4069 ià(
œq_’Œy
 == -1)

4071 
œq
 = 
	`pš_2_œq
(
œq_’Œy
, 
ißpic
, 
pš
);

4077 
desc
 = 
	`œq_to_desc
(
œq
);

4078 
cfg
 = 
desc
->
ch_d©a
;

4079 ià(!
cfg
->
veùÜ
) {

4080 
	`£tup_IO_APIC_œq
(
ißpic
, 
pš
, 
œq
, 
desc
,

4081 
	`œq_Œigg”
(
œq_’Œy
),

4082 
	`œq_pŞ¬™y
(
œq_’Œy
));

4090 ià(
desc
->
¡©us
 &

4091 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4092 
mask
 = 
desc
->
affš™y
;

4094 
mask
 = 
­ic
->
	`rg‘_ıus
();

4096 ià(
šŒ_»m­pšg_’abËd
)

4097 
	`£t_œ_ißpic_affš™y_œq_desc
(
desc
, 
mask
);

4099 
	`£t_ißpic_affš™y_œq_desc
(
desc
, 
mask
);

4103 
	}
}

4106 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4108 
»sourû
 *
	gißpic_»sourûs
;

4110 
»sourû
 * 
__š™
 
	$ißpic_£tup_»sourûs
()

4112 
n
;

4113 
»sourû
 *
»s
;

4114 *
mem
;

4115 
i
;

4117 ià(
Ä_ißpics
 <= 0)

4118  
NULL
;

4120 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
»sourû
);

4121 
n
 *ğ
Ä_ißpics
;

4123 
mem
 = 
	`®loc_boÙmem
(
n
);

4124 
»s
 = (*)
mem
;

4126 ià(
mem
 !ğ
NULL
) {

4127 
mem
 +ğ(
»sourû
è* 
Ä_ißpics
;

4129 
i
 = 0; i < 
Ä_ißpics
; i++) {

4130 
»s
[
i
].
Çme
 = 
mem
;

4131 
»s
[
i
].
æags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4132 
	`¥rštf
(
mem
, "IOAPIC %u", 
i
);

4133 
mem
 +ğ
IOAPIC_RESOURCE_NAME_SIZE
;

4137 
ißpic_»sourûs
 = 
»s
;

4139  
»s
;

4140 
	}
}

4142 
__š™
 
	$ißpic_š™_m­pšgs
()

4144 
ißpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4145 
»sourû
 *
ißpic_»s
;

4146 
i
;

4148 
ißpic_»s
 = 
	`ißpic_£tup_»sourûs
();

4149 
i
 = 0; i < 
Ä_ißpics
; i++) {

4150 ià(
smp_found_cÚfig
) {

4151 
ißpic_phys
 = 
mp_ißpics
[
i
].
­iÿddr
;

4152 #ifdeà
CONFIG_X86_32


4153 ià(!
ißpic_phys
) {

4154 
	`´štk
(
KERN_ERR


4158 
smp_found_cÚfig
 = 0;

4159 
sk_ißpic_£tup
 = 1;

4160 
çke_ißpic_·ge
;

4164 #ifdeà
CONFIG_X86_32


4165 
çke_ißpic_·ge
:

4167 
ißpic_phys
 = ()

4168 
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

4169 
ißpic_phys
 = 
	`__·
(ioapic_phys);

4171 
	`£t_fixm­_noÿche
(
idx
, 
ißpic_phys
);

4172 
	`­ic_´štk
(
APIC_VERBOSE
,

4174 
	`__fix_to_vœt
(
idx
), 
ißpic_phys
);

4175 
idx
++;

4177 ià(
ißpic_»s
 !ğ
NULL
) {

4178 
ißpic_»s
->
¡¬t
 = 
ißpic_phys
;

4179 
ißpic_»s
->
’d
 = 
ißpic_phys
 + (4 * 1024) - 1;

4180 
ißpic_»s
++;

4183 
	}
}

4185 
__š™
 
	$ißpic_š£¹_»sourûs
()

4187 
i
;

4188 
»sourû
 *
r
 = 
ißpic_»sourûs
;

4190 ià(!
r
) {

4191 ià(
Ä_ißpics
 > 0) {

4192 
	`´štk
(
KERN_ERR


4199 
i
 = 0; i < 
Ä_ißpics
; i++) {

4200 
	`š£¹_»sourû
(&
iomem_»sourû
, 
r
);

4201 
r
++;

4205 
	}
}

4209 
Ï‹_š™ÿÎ
(
ißpic_š£¹_»sourûs
);

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<lšux/ıumask.h
>

2 
	~<lšux/š‹¼u±.h
>

3 
	~<lšux/š™.h
>

5 
	~<lšux/mm.h
>

6 
	~<lšux/d–ay.h
>

7 
	~<lšux/¥šlock.h
>

8 
	~<lšux/k”Ãl_¡©.h
>

9 
	~<lšux/mc146818¹c.h
>

10 
	~<lšux/ÿche.h
>

11 
	~<lšux/ıu.h
>

12 
	~<lšux/moduË.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mŒr.h
>

16 
	~<asm/bæush.h
>

17 
	~<asm/mmu_cÚ‹xt.h
>

18 
	~<asm/­ic.h
>

19 
	~<asm/´Ùo.h
>

20 
	~<asm/i.h
>

22 
	$deçuÉ_£nd_IPI_mask_£qu’û_phys
(cÚ¡ 
ıumask
 *
mask
, 
veùÜ
)

24 
qu”y_ıu
;

25 
æags
;

32 
	`loÿl_œq_§ve
(
æags
);

33 
	`fÜ_—ch_ıu
(
qu”y_ıu
, 
mask
) {

34 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(
	`³r_ıu
(
x86_ıu_to_­icid
,

35 
qu”y_ıu
), 
veùÜ
, 
APIC_DEST_PHYSICAL
);

37 
	`loÿl_œq_»¡Üe
(
æags
);

38 
	}
}

40 
	$deçuÉ_£nd_IPI_mask_®lbut£lf_phys
(cÚ¡ 
ıumask
 *
mask
,

41 
veùÜ
)

43 
this_ıu
 = 
	`smp_´oûssÜ_id
();

44 
qu”y_ıu
;

45 
æags
;

49 
	`loÿl_œq_§ve
(
æags
);

50 
	`fÜ_—ch_ıu
(
qu”y_ıu
, 
mask
) {

51 ià(
qu”y_ıu
 =ğ
this_ıu
)

53 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(
	`³r_ıu
(
x86_ıu_to_­icid
,

54 
qu”y_ıu
), 
veùÜ
, 
APIC_DEST_PHYSICAL
);

56 
	`loÿl_œq_»¡Üe
(
æags
);

57 
	}
}

59 
	$deçuÉ_£nd_IPI_mask_£qu’û_logiÿl
(cÚ¡ 
ıumask
 *
mask
,

60 
veùÜ
)

62 
æags
;

63 
qu”y_ıu
;

71 
	`loÿl_œq_§ve
(
æags
);

72 
	`fÜ_—ch_ıu
(
qu”y_ıu
, 
mask
)

73 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(

74 
­ic
->
	`ıu_to_logiÿl_­icid
(
qu”y_ıu
), 
veùÜ
,

75 
­ic
->
de¡_logiÿl
);

76 
	`loÿl_œq_»¡Üe
(
æags
);

77 
	}
}

79 
	$deçuÉ_£nd_IPI_mask_®lbut£lf_logiÿl
(cÚ¡ 
ıumask
 *
mask
,

80 
veùÜ
)

82 
æags
;

83 
qu”y_ıu
;

84 
this_ıu
 = 
	`smp_´oûssÜ_id
();

88 
	`loÿl_œq_§ve
(
æags
);

89 
	`fÜ_—ch_ıu
(
qu”y_ıu
, 
mask
) {

90 ià(
qu”y_ıu
 =ğ
this_ıu
)

92 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(

93 
­ic
->
	`ıu_to_logiÿl_­icid
(
qu”y_ıu
), 
veùÜ
,

94 
­ic
->
de¡_logiÿl
);

96 
	`loÿl_œq_»¡Üe
(
æags
);

97 
	}
}

99 #ifdeà
CONFIG_X86_32


104 
	$deçuÉ_£nd_IPI_mask_logiÿl
(cÚ¡ 
ıumask
 *ıumask, 
veùÜ
)

106 
mask
 = 
	`ıumask_b™s
(
ıumask
)[0];

107 
æags
;

109 
	`loÿl_œq_§ve
(
æags
);

110 
	`WARN_ON
(
mask
 & ~
	`ıumask_b™s
(
ıu_Úlše_mask
)[0]);

111 
	`__deçuÉ_£nd_IPI_de¡_f›ld
(
mask
, 
veùÜ
, 
­ic
->
de¡_logiÿl
);

112 
	`loÿl_œq_»¡Üe
(
æags
);

113 
	}
}

115 
	$deçuÉ_£nd_IPI_®lbut£lf
(
veùÜ
)

121 ià(!(
	`num_Úlše_ıus
() > 1))

124 
	`__deçuÉ_loÿl_£nd_IPI_®lbut£lf
(
veùÜ
);

125 
	}
}

127 
	$deçuÉ_£nd_IPI_®l
(
veùÜ
)

129 
	`__deçuÉ_loÿl_£nd_IPI_®l
(
veùÜ
);

130 
	}
}

132 
	$deçuÉ_£nd_IPI_£lf
(
veùÜ
)

134 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_SELF
, 
veùÜ
, 
­ic
->
de¡_logiÿl
);

135 
	}
}

138 
	$cÚv”t_­icid_to_ıu
(
­ic_id
)

140 
i
;

142 
	`fÜ_—ch_possibË_ıu
(
i
) {

143 ià(
	`³r_ıu
(
x86_ıu_to_­icid
, 
i
è=ğ
­ic_id
)

144  
i
;

147 
	}
}

149 
	$§ã_smp_´oûssÜ_id
()

151 
­icid
, 
ıuid
;

153 ià(!
	`boÙ_ıu_has
(
X86_FEATURE_APIC
))

156 
­icid
 = 
	`h¬d_smp_´oûssÜ_id
();

157 ià(
­icid
 =ğ
BAD_APICID
)

160 
ıuid
 = 
	`cÚv”t_­icid_to_ıu
(
­icid
);

162  
ıuid
 >= 0 ? cpuid : 0;

163 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/­ic.h
>

16 
	~<lšux/nmi.h
>

17 
	~<lšux/mm.h
>

18 
	~<lšux/d–ay.h
>

19 
	~<lšux/š‹¼u±.h
>

20 
	~<lšux/moduË.h
>

21 
	~<lšux/sysdev.h
>

22 
	~<lšux/sysùl.h
>

23 
	~<lšux/³rıu.h
>

24 
	~<lšux/k´obes.h
>

25 
	~<lšux/ıumask.h
>

26 
	~<lšux/k”Ãl_¡©.h
>

27 
	~<lšux/kdebug.h
>

28 
	~<lšux/smp.h
>

30 
	~<asm/i8259.h
>

31 
	~<asm/io_­ic.h
>

32 
	~<asm/´Ùo.h
>

33 
	~<asm/tim”.h
>

35 
	~<asm/mû.h
>

37 
	~<asm/mach_Œ­s.h
>

39 
	gunknown_nmi_·nic
;

40 
	gnmi_w©chdog_’abËd
;

42 
ıumask_v¬_t
 
	gbackŒaû_mask
;

50 
©omic_t
 
	gnmi_aùive
 = 
ATOMIC_INIT
(0);

51 
EXPORT_SYMBOL
(
nmi_aùive
);

53 
	gnmi_w©chdog
 = 
NMI_NONE
;

54 
EXPORT_SYMBOL
(
nmi_w©chdog
);

56 
	g·nic_Ú_timeout
;

58 
	gnmi_hz
 = 
HZ
;

59 
DEFINE_PER_CPU
(, 
wd_’abËd
);

60 
’dæag
 
	g__š™d©a
;

62 
šlše
 
	$g‘_nmi_couÁ
(
ıu
)

64  
	`³r_ıu
(
œq_¡©
, 
ıu
).
__nmi_couÁ
;

65 
	}
}

67 
šlše
 
	$mû_š_´og»ss
()

69 #ià
	`defšed
(
CONFIG_X86_64
è&& defšed(
CONFIG_X86_MCE
)

70  
	`©omic_»ad
(&
mû_’Œy
) > 0;

73 
	}
}

79 
šlše
 
	$g‘_tim”_œqs
(
ıu
)

81  
	`³r_ıu
(
œq_¡©
, 
ıu
).
­ic_tim”_œqs
 +

82 
	`³r_ıu
(
œq_¡©
, 
ıu
).
œq0_œqs
;

83 
	}
}

85 #ifdeà
CONFIG_SMP


91 
__š™
 
	$nmi_ıu_busy
(*
d©a
)

93 
	`loÿl_œq_’abË_š_h¬dœq
();

102 
’dæag
 == 0)

103 
	`mb
();

104 
	}
}

107 
	$»pÜt_brok’_nmi
(
ıu
, *
´ev_nmi_couÁ
)

109 
	`´štk
(
KERN_CONT
 "\n");

111 
	`´štk
(
KERN_WARNING


113 
ıu
, 
´ev_nmi_couÁ
[ıu], 
	`g‘_nmi_couÁ
(cpu));

115 
	`´štk
(
KERN_WARNING


117 
	`´štk
(
KERN_WARNING


120 
	`³r_ıu
(
wd_’abËd
, 
ıu
) = 0;

121 
	`©omic_dec
(&
nmi_aùive
);

122 
	}
}

124 
	$__aıi_nmi_di§bË
(*
__unu£d
)

126 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

127 
	}
}

129 
__š™
 
	$check_nmi_w©chdog
()

131 *
´ev_nmi_couÁ
;

132 
ıu
;

134 ià(!
	`nmi_w©chdog_aùive
(è|| !
	`©omic_»ad
(&
nmi_aùive
))

137 
´ev_nmi_couÁ
 = 
	`km®loc
(
Ä_ıu_ids
 * (), 
GFP_KERNEL
);

138 ià(!
´ev_nmi_couÁ
)

139 
”rÜ
;

141 
	`®loc_ıumask_v¬
(&
backŒaû_mask
, 
GFP_KERNEL
|
__GFP_ZERO
);

142 
	`´štk
(
KERN_INFO
 "Testing NMI watchdog ... ");

144 #ifdeà
CONFIG_SMP


145 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

146 
	`smp_ÿÎ_funùiÚ
(
nmi_ıu_busy
, (*)&
’dæag
, 0);

149 
	`fÜ_—ch_possibË_ıu
(
ıu
)

150 
´ev_nmi_couÁ
[
ıu
] = 
	`g‘_nmi_couÁ
(cpu);

151 
	`loÿl_œq_’abË
();

152 
	`md–ay
((20 * 1000è/ 
nmi_hz
);

154 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

155 ià(!
	`³r_ıu
(
wd_’abËd
, 
ıu
))

157 ià(
	`g‘_nmi_couÁ
(
ıu
è- 
´ev_nmi_couÁ
[cpu] <= 5)

158 
	`»pÜt_brok’_nmi
(
ıu
, 
´ev_nmi_couÁ
);

160 
’dæag
 = 1;

161 ià(!
	`©omic_»ad
(&
nmi_aùive
)) {

162 
	`kä“
(
´ev_nmi_couÁ
);

163 
	`©omic_£t
(&
nmi_aùive
, -1);

164 
”rÜ
;

166 
	`´štk
("OK.\n");

172 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

173 
nmi_hz
 = 
	`Ïpic_adju¡_nmi_hz
(1);

175 
	`kä“
(
´ev_nmi_couÁ
);

177 
”rÜ
:

178 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

179 ià(!
tim”_through_8259
)

180 
	`di§bË_8259A_œq
(0);

181 
	`Ú_—ch_ıu
(
__aıi_nmi_di§bË
, 
NULL
, 1);

184 #ifdeà
CONFIG_X86_32


185 
tim”_ack
 = 0;

188 
	}
}

190 
__š™
 
	$£tup_nmi_w©chdog
(*
¡r
)

192 
nmi
;

194 ià(!
	`¡ºcmp
(
¡r
, "panic", 5)) {

195 
·nic_Ú_timeout
 = 1;

196 
¡r
 = 
	`¡rchr
(str, ',');

197 ià(!
¡r
)

199 ++
¡r
;

202 ià(!
	`¡ºcmp
(
¡r
, "lapic", 5))

203 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

204 ià(!
	`¡ºcmp
(
¡r
, "ioapic", 6))

205 
nmi_w©chdog
 = 
NMI_IO_APIC
;

207 
	`g‘_İtiÚ
(&
¡r
, &
nmi
);

208 ià(
nmi
 >ğ
NMI_INVALID
)

210 
nmi_w©chdog
 = 
nmi
;

214 
	}
}

215 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

220 #ifdeà
CONFIG_PM


222 
	gnmi_pm_aùive
;

224 
	$Ïpic_nmi_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

227 
nmi_pm_aùive
 = 
	`©omic_»ad
(&
nmi_aùive
);

228 
	`¡İ_­ic_nmi_w©chdog
(
NULL
);

229 
	`BUG_ON
(
	`©omic_»ad
(&
nmi_aùive
) != 0);

231 
	}
}

233 
	$Ïpic_nmi_»sume
(
sys_deviû
 *
dev
)

236 ià(
nmi_pm_aùive
 > 0) {

237 
	`£tup_­ic_nmi_w©chdog
(
NULL
);

238 
	`touch_nmi_w©chdog
();

241 
	}
}

243 
sysdev_şass
 
	gnmi_sysşass
 = {

244 .
Çme
 = "lapic_nmi",

245 .
	g»sume
 = 
Ïpic_nmi_»sume
,

246 .
	gsu¥’d
 = 
Ïpic_nmi_su¥’d
,

249 
sys_deviû
 
	gdeviû_Ïpic_nmi
 = {

250 .
id
 = 0,

251 .
	gşs
 = &
nmi_sysşass
,

254 
__š™
 
	$š™_Ïpic_nmi_sysfs
()

256 
”rÜ
;

262 ià(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
)

265 ià(
	`©omic_»ad
(&
nmi_aùive
) < 0)

268 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
nmi_sysşass
);

269 ià(!
”rÜ
)

270 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_Ïpic_nmi
);

271  
”rÜ
;

272 
	}
}

275 
Ï‹_š™ÿÎ
(
š™_Ïpic_nmi_sysfs
);

279 
	$__aıi_nmi_’abË
(*
__unu£d
)

281 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_NMI
);

282 
	}
}

287 
	$aıi_nmi_’abË
()

289 ià(
	`©omic_»ad
(&
nmi_aùive
è&& 
nmi_w©chdog
 =ğ
NMI_IO_APIC
)

290 
	`Ú_—ch_ıu
(
__aıi_nmi_’abË
, 
NULL
, 1);

291 
	}
}

296 
	$aıi_nmi_di§bË
()

298 ià(
	`©omic_»ad
(&
nmi_aùive
è&& 
nmi_w©chdog
 =ğ
NMI_IO_APIC
)

299 
	`Ú_—ch_ıu
(
__aıi_nmi_di§bË
, 
NULL
, 1);

300 
	}
}

306 
	$ıu_nmi_£t_wd_’abËd
()

308 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 1;

309 
	}
}

311 
	$£tup_­ic_nmi_w©chdog
(*
unu£d
)

313 ià(
	`__g‘_ıu_v¬
(
wd_’abËd
))

318 ià(
	`smp_´oûssÜ_id
(è!ğ0 && 
	`©omic_»ad
(&
nmi_aùive
) <= 0)

321 
nmi_w©chdog
) {

322 
NMI_LOCAL_APIC
:

323 ià(
	`Ïpic_w©chdog_š™
(
nmi_hz
) < 0) {

324 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 0;

328 
NMI_IO_APIC
:

329 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 1;

330 
	`©omic_šc
(&
nmi_aùive
);

332 
	}
}

334 
	$¡İ_­ic_nmi_w©chdog
(*
unu£d
)

337 ià(!
	`nmi_w©chdog_aùive
())

339 ià(
	`__g‘_ıu_v¬
(
wd_’abËd
) == 0)

341 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

342 
	`Ïpic_w©chdog_¡İ
();

344 
	`__aıi_nmi_di§bË
(
NULL
);

345 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 0;

346 
	`©omic_dec
(&
nmi_aùive
);

347 
	}
}

363 
DEFINE_PER_CPU
(, 
Ï¡_œq_sum
);

364 
DEFINE_PER_CPU
(
loÿl_t
, 
®”t_couÁ”
);

365 
DEFINE_PER_CPU
(, 
nmi_touch
);

367 
	$touch_nmi_w©chdog
()

369 ià(
	`nmi_w©chdog_aùive
()) {

370 
ıu
;

377 
	`fÜ_—ch_´e£Á_ıu
(
ıu
) {

378 ià(
	`³r_ıu
(
nmi_touch
, 
ıu
) != 1)

379 
	`³r_ıu
(
nmi_touch
, 
ıu
) = 1;

386 
	`touch_soálockup_w©chdog
();

387 
	}
}

388 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

390 
nÙ¿û
 
__k´obes
 

391 
	$nmi_w©chdog_tick
(
±_»gs
 *
»gs
, 
»asÚ
)

398 
sum
;

399 
touched
 = 0;

400 
ıu
 = 
	`smp_´oûssÜ_id
();

401 
rc
 = 0;

404 ià(
	`nÙify_d›
(
DIE_NMI
, "nmi", 
»gs
, 
»asÚ
, 2, 
SIGINT
)

405 =ğ
NOTIFY_STOP
) {

406 
rc
 = 1;

407 
touched
 = 1;

410 
sum
 = 
	`g‘_tim”_œqs
(
ıu
);

412 ià(
	`__g‘_ıu_v¬
(
nmi_touch
)) {

413 
	`__g‘_ıu_v¬
(
nmi_touch
) = 0;

414 
touched
 = 1;

418 ià(
backŒaû_mask
 !ğ
NULL
 && 
	`ıumask_‹¡_ıu
(
ıu
, backtrace_mask)) {

419 
	`DEFINE_SPINLOCK
(
lock
);

421 
	`¥š_lock
(&
lock
);

422 
	`´štk
(
KERN_WARNING
 "NMI backŒaû fÜ cpu %d\n", 
ıu
);

423 
	`dump_¡ack
();

424 
	`¥š_uÆock
(&
lock
);

425 
	`ıumask_ş—r_ıu
(
ıu
, 
backŒaû_mask
);

429 ià(
	`mû_š_´og»ss
())

430 
touched
 = 1;

433 ià(!
touched
 && 
	`__g‘_ıu_v¬
(
Ï¡_œq_sum
è=ğ
sum
) {

438 
	`loÿl_šc
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
));

439 ià(
	`loÿl_»ad
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
)è=ğ5 * 
nmi_hz
)

443 
	`d›_nmi
("BUG: NMI Watchdog detected LOCKUP",

444 
»gs
, 
·nic_Ú_timeout
);

446 
	`__g‘_ıu_v¬
(
Ï¡_œq_sum
èğ
sum
;

447 
	`loÿl_£t
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
), 0);

451 ià(!
	`__g‘_ıu_v¬
(
wd_’abËd
))

452  
rc
;

453 
nmi_w©chdog
) {

454 
NMI_LOCAL_APIC
:

455 
rc
 |ğ
	`Ïpic_wd_ev’t
(
nmi_hz
);

457 
NMI_IO_APIC
:

463 
rc
 = 1;

466  
rc
;

467 
	}
}

469 #ifdeà
CONFIG_SYSCTL


471 
	$’abË_ißpic_nmi_w©chdog_sšgË
(*
unu£d
)

473 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 1;

474 
	`©omic_šc
(&
nmi_aùive
);

475 
	`__aıi_nmi_’abË
(
NULL
);

476 
	}
}

478 
	$’abË_ißpic_nmi_w©chdog
()

480 
	`Ú_—ch_ıu
(
’abË_ißpic_nmi_w©chdog_sšgË
, 
NULL
, 1);

481 
	`touch_nmi_w©chdog
();

482 
	}
}

484 
	$di§bË_ißpic_nmi_w©chdog
()

486 
	`Ú_—ch_ıu
(
¡İ_­ic_nmi_w©chdog
, 
NULL
, 1);

487 
	}
}

489 
__š™
 
	$£tup_unknown_nmi_·nic
(*
¡r
)

491 
unknown_nmi_·nic
 = 1;

493 
	}
}

494 
__£tup
("unknown_nmi_·nic", 
£tup_unknown_nmi_·nic
);

496 
	$unknown_nmi_·nic_ÿÎback
(
±_»gs
 *
»gs
, 
ıu
)

498 
»asÚ
 = 
	`g‘_nmi_»asÚ
();

499 
buf
[64];

501 
	`¥rštf
(
buf
, "NMI„eûived fÜ unknowÀ»asÚ %02x\n", 
»asÚ
);

502 
	`d›_nmi
(
buf
, 
»gs
, 1);

504 
	}
}

509 
	$´oc_nmi_’abËd
(
ùl_bË
 *
bË
, 
wr™e
, 
fe
 *file,

510 
__u£r
 *
bufãr
, 
size_t
 *
Ëngth
, 
loff_t
 *
µos
)

512 
Şd_¡©e
;

514 
nmi_w©chdog_’abËd
 = (
	`©omic_»ad
(&
nmi_aùive
) > 0) ? 1 : 0;

515 
Şd_¡©e
 = 
nmi_w©chdog_’abËd
;

516 
	`´oc_doštvec
(
bË
, 
wr™e
, 
fe
, 
bufãr
, 
Ëngth
, 
µos
);

517 ià(!!
Şd_¡©e
 =ğ!!
nmi_w©chdog_’abËd
)

520 ià(
	`©omic_»ad
(&
nmi_aùive
è< 0 || !
	`nmi_w©chdog_aùive
()) {

521 
	`´štk
(
KERN_WARNING


523  -
EIO
;

526 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
) {

527 ià(
nmi_w©chdog_’abËd
)

528 
	`’abË_Ïpic_nmi_w©chdog
();

530 
	`di§bË_Ïpic_nmi_w©chdog
();

531 } ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

532 ià(
nmi_w©chdog_’abËd
)

533 
	`’abË_ißpic_nmi_w©chdog
();

535 
	`di§bË_ißpic_nmi_w©chdog
();

537 
	`´štk
(
KERN_WARNING


539  -
EIO
;

542 
	}
}

546 
	$do_nmi_ÿÎback
(
±_»gs
 *
»gs
, 
ıu
)

548 #ifdeà
CONFIG_SYSCTL


549 ià(
unknown_nmi_·nic
)

550  
	`unknown_nmi_·nic_ÿÎback
(
»gs
, 
ıu
);

553 
	}
}

555 
	$__Œigg”_®l_ıu_backŒaû
()

557 
i
;

559 
	`ıumask_cİy
(
backŒaû_mask
, 
ıu_Úlše_mask
);

561 
i
 = 0; i < 10 * 1000; i++) {

562 ià(
	`ıumask_em±y
(
backŒaû_mask
))

564 
	`md–ay
(1);

566 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<lšux/th»ads.h
>

12 
	~<lšux/ıumask.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/ùy³.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/h¬dœq.h
>

19 
	~<lšux/dm¬.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/­ic.h
>

23 
	~<asm/i.h
>

24 
	~<asm/£tup.h
>

26 
­ic
 
­ic_æ©
;

27 
­ic
 
­ic_physæ©
;

28 
­ic
 
­ic_x2xpic_uv_x
;

29 
­ic
 
­ic_x2­ic_phys
;

30 
­ic
 
­ic_x2­ic_şu¡”
;

32 
­ic
 
__»ad_mo¡ly
 *
	g­ic
 = &
­ic_æ©
;

33 
EXPORT_SYMBOL_GPL
(
­ic
);

35 
­ic
 *
	g­ic_´obe
[] 
	g__š™d©a
 = {

36 #ifdeà
CONFIG_X86_UV


37 &
­ic_x2­ic_uv_x
,

39 #ifdeà
CONFIG_X86_X2APIC


40 &
­ic_x2­ic_phys
,

41 &
­ic_x2­ic_şu¡”
,

43 &
­ic_physæ©
,

44 
NULL
,

50 
__š™
 
	$deçuÉ_£tup_­ic_routšg
()

52 #ifdeà
CONFIG_X86_X2APIC


53 ià(
x2­ic
 && (
­ic
 !ğ&
­ic_x2­ic_phys
 &&

54 #ifdeà
CONFIG_X86_UV


55 
­ic
 !ğ&
­ic_x2­ic_uv_x
 &&

57 
­ic
 !ğ&
­ic_x2­ic_şu¡”
)) {

58 ià(
x2­ic_phys
)

59 
­ic
 = &
­ic_x2­ic_phys
;

61 
­ic
 = &
­ic_x2­ic_şu¡”
;

62 
	`´štk
(
KERN_INFO
 "S‘tšg APIC„outšgØ%s\n", 
­ic
->
Çme
);

66 ià(
­ic
 =ğ&
­ic_æ©
) {

67 ià(
max_physiÿl_­icid
 >= 8)

68 
­ic
 = &
­ic_physæ©
;

69 
	`´štk
(
KERN_INFO
 "S‘tšg APIC„outšgØ%s\n", 
­ic
->
Çme
);

76 ià(
šŒ_»m­pšg_’abËd
)

77 
	`’abË_drhd_çuÉ_hªdlšg
();

78 
	}
}

82 
	$­ic_£nd_IPI_£lf
(
veùÜ
)

84 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_SELF
, 
veùÜ
, 
APIC_DEST_PHYSICAL
);

85 
	}
}

87 
__š™
 
	$deçuÉ_aıi_madt_Ûm_check
(*
Ûm_id
, *
Ûm_bË_id
)

89 
i
;

91 
i
 = 0; 
­ic_´obe
[i]; ++i) {

92 ià(
­ic_´obe
[
i
]->
	`aıi_madt_Ûm_check
(
Ûm_id
, 
Ûm_bË_id
)) {

93 
­ic
 = 
­ic_´obe
[
i
];

94 
	`´štk
(
KERN_INFO
 "Setting APIC„outingo %s.\n",

95 
­ic
->
Çme
);

100 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/ty³s.h
>

3 
	~<lšux/aud™.h
>

4 
	~<asm/uni¡d.h
>

6 
	gdœ_şass
[] = {

7 
	~<asm-g’”ic/aud™_dœ_wr™e.h
>

11 
	g»ad_şass
[] = {

12 
	~<asm-g’”ic/aud™_»ad.h
>

16 
	gwr™e_şass
[] = {

17 
	~<asm-g’”ic/aud™_wr™e.h
>

21 
	gch©Œ_şass
[] = {

22 
	~<asm-g’”ic/aud™_chªge_©Œ.h
>

26 
	gsigÇl_şass
[] = {

27 
	~<asm-g’”ic/aud™_sigÇl.h
>

31 
	$aud™_şassify_¬ch
(
¬ch
)

33 #ifdeà
CONFIG_IA32_EMULATION


34 ià(
¬ch
 =ğ
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$aud™_şassify_sysÿÎ
(
abi
, 
sysÿÎ
)

42 #ifdeà
CONFIG_IA32_EMULATION


43 
	`Ÿ32_şassify_sysÿÎ
();

44 ià(
abi
 =ğ
AUDIT_ARCH_I386
)

45  
	`Ÿ32_şassify_sysÿÎ
(
sysÿÎ
);

47 
sysÿÎ
) {

48 
__NR_İ’
:

50 
__NR_İ’©
:

52 
__NR_execve
:

57 
	}
}

59 
__š™
 
	$aud™_şas£s_š™
()

61 #ifdeà
CONFIG_IA32_EMULATION


62 
__u32
 
Ÿ32_dœ_şass
[];

63 
__u32
 
Ÿ32_wr™e_şass
[];

64 
__u32
 
Ÿ32_»ad_şass
[];

65 
__u32
 
Ÿ32_ch©Œ_şass
[];

66 
__u32
 
Ÿ32_sigÇl_şass
[];

67 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_WRITE_32
, 
Ÿ32_wr™e_şass
);

68 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_READ_32
, 
Ÿ32_»ad_şass
);

69 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_DIR_WRITE_32
, 
Ÿ32_dœ_şass
);

70 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_CHATTR_32
, 
Ÿ32_ch©Œ_şass
);

71 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_SIGNAL_32
, 
Ÿ32_sigÇl_şass
);

73 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_WRITE
, 
wr™e_şass
);

74 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_READ
, 
»ad_şass
);

75 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_DIR_WRITE
, 
dœ_şass
);

76 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_CHATTR
, 
ch©Œ_şass
);

77 
	`aud™_»gi¡”_şass
(
AUDIT_CLASS_SIGNAL
, 
sigÇl_şass
);

79 
	}
}

81 
__š™ÿÎ
(
aud™_şas£s_š™
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/š™.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¥šlock.h
>

10 
	~<lšux/aıi.h
>

11 
	~<asm/io.h
>

13 
	~<lšux/mc146818¹c.h
>

15 
	#SBF_RESERVED
 (0x78)

	)

16 
	#SBF_PNPOS
 (1<<0)

	)

17 
	#SBF_BOOTING
 (1<<1)

	)

18 
	#SBF_DIAG
 (1<<2)

	)

19 
	#SBF_PARITY
 (1<<7)

	)

21 
sbf_pÜt
 
	g__š™d©a
 = -1;

23 
__š™
 
	$·r™y
(
u8
 
v
)

25 
x
 = 0;

26 
i
;

28 
i
 = 0; i < 8; i++) {

29 
x
 ^ğ(
v
 & 1);

30 
v
 >>= 1;

33  
x
;

34 
	}
}

36 
__š™
 
	$sbf_wr™e
(
u8
 
v
)

38 
æags
;

40 ià(
sbf_pÜt
 != -1) {

41 
v
 &ğ~
SBF_PARITY
;

42 ià(!
	`·r™y
(
v
))

43 
v
 |ğ
SBF_PARITY
;

45 
	`´štk
(
KERN_INFO
 "Simple Boot Flag‡t 0x%x seto 0x%x\n",

46 
sbf_pÜt
, 
v
);

48 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

49 
	`CMOS_WRITE
(
v
, 
sbf_pÜt
);

50 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

52 
	}
}

54 
u8
 
__š™
 
	$sbf_»ad
()

56 
æags
;

57 
u8
 
v
;

59 ià(
sbf_pÜt
 == -1)

62 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

63 
v
 = 
	`CMOS_READ
(
sbf_pÜt
);

64 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

66  
v
;

67 
	}
}

69 
__š™
 
	$sbf_v®ue_v®id
(
u8
 
v
)

71 ià(
v
 & 
SBF_RESERVED
)

73 ià(!
	`·r™y
(
v
))

77 
	}
}

79 
__š™
 
	$sbf_š™
()

81 
u8
 
v
;

83 ià(
sbf_pÜt
 == -1)

86 
v
 = 
	`sbf_»ad
();

87 ià(!
	`sbf_v®ue_v®id
(
v
)) {

88 
	`´štk
(
KERN_WARNING
 "Simple Boot Flag value 0x%x„ead from "

89 "CMOS RAM wa šv®id\n", 
v
);

92 
v
 &ğ~
SBF_RESERVED
;

93 
v
 &ğ~
SBF_BOOTING
;

94 
v
 &ğ~
SBF_DIAG
;

95 #ià
	`defšed
(
CONFIG_ISAPNP
)

96 
v
 |ğ
SBF_PNPOS
;

98 
	`sbf_wr™e
(
v
);

101 
	}
}

102 
moduË_š™
(
sbf_š™
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/kth»ad.h
>

4 
	~<lšux/wÜkqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/´Ùo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__»ad_mo¡ly
 
	gmemÜy_cÜru±iÚ_check
 = -1;

18 
__»ad_mo¡ly
 
	gcÜru±iÚ_check_size
 = 64*1024;

19 
__»ad_mo¡ly
 
	gcÜru±iÚ_check_³riod
 = 60;

21 
e820’Œy
 
	gsÿn_¬—s
[
MAX_SCAN_AREAS
];

22 
	gnum_sÿn_¬—s
;

25 
__š™
 
	$£t_cÜru±iÚ_check
(*
¬g
)

27 *
’d
;

29 
memÜy_cÜru±iÚ_check
 = 
	`sim¶e_¡¹Ş
(
¬g
, &
’d
, 10);

31  (*
’d
 =ğ0è? 0 : -
EINVAL
;

32 
	}
}

33 
—¾y_·¿m
("memÜy_cÜru±iÚ_check", 
£t_cÜru±iÚ_check
);

35 
__š™
 
	$£t_cÜru±iÚ_check_³riod
(*
¬g
)

37 *
’d
;

39 
cÜru±iÚ_check_³riod
 = 
	`sim¶e_¡¹oul
(
¬g
, &
’d
, 10);

41  (*
’d
 =ğ0è? 0 : -
EINVAL
;

42 
	}
}

43 
—¾y_·¿m
("memÜy_cÜru±iÚ_check_³riod", 
£t_cÜru±iÚ_check_³riod
);

45 
__š™
 
	$£t_cÜru±iÚ_check_size
(*
¬g
)

47 *
’d
;

48 
size
;

50 
size
 = 
	`mem·r£
(
¬g
, &
’d
);

52 ià(*
’d
 == '\0')

53 
cÜru±iÚ_check_size
 = 
size
;

55  (
size
 =ğ
cÜru±iÚ_check_size
è? 0 : -
EINVAL
;

56 
	}
}

57 
—¾y_·¿m
("memÜy_cÜru±iÚ_check_size", 
£t_cÜru±iÚ_check_size
);

60 
__š™
 
	$£tup_bios_cÜru±iÚ_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 ià(
memÜy_cÜru±iÚ_check
 == -1) {

65 
memÜy_cÜru±iÚ_check
 =

66 #ifdeà
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 ià(
cÜru±iÚ_check_size
 == 0)

75 
memÜy_cÜru±iÚ_check
 = 0;

77 ià(!
memÜy_cÜru±iÚ_check
)

80 
cÜru±iÚ_check_size
 = 
	`round_up
(cÜru±iÚ_check_size, 
PAGE_SIZE
);

82 
addr
 < 
cÜru±iÚ_check_size
 && 
num_sÿn_¬—s
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`fšd_e820_¬—_size
×ddr, &
size
, 
PAGE_SIZE
);

86 ià(!(
addr
 + 1))

89 ià(
addr
 >ğ
cÜru±iÚ_check_size
)

92 ià((
addr
 + 
size
è> 
cÜru±iÚ_check_size
)

93 
size
 = 
cÜru±iÚ_check_size
 - 
addr
;

95 
	`e820_upd©e_¿nge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sÿn_¬—s
[
num_sÿn_¬—s
].
addr
 =‡ddr;

97 
sÿn_¬—s
[
num_sÿn_¬—s
].
size
 = size;

98 
num_sÿn_¬—s
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +ğ
size
;

106 
	`´štk
(
KERN_INFO
 "Scanning %d‡reas for†ow memory corruption\n",

107 
num_sÿn_¬—s
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_fÜ_bios_cÜru±iÚ
()

114 
i
;

115 
cÜru±iÚ
 = 0;

117 ià(!
memÜy_cÜru±iÚ_check
)

120 
i
 = 0; i < 
num_sÿn_¬—s
; i++) {

121 *
addr
 = 
	`__va
(
sÿn_¬—s
[
i
].addr);

122 
size
 = 
sÿn_¬—s
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 ià(!*
addr
)

127 
	`´štk
(
KERN_ERR
 "Corrupted†ow memory‡t %p (%lx…hys) = %08lx\n",

128 
addr
, 
	`__·
(addr), *addr);

129 
cÜru±iÚ
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
cÜru±iÚ
, 
KERN_ERR
 "Memory corruption detected in†ow memory\n");

135 
	}
}

137 
check_cÜru±iÚ
(
wÜk_¡ruù
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_wÜk
, 
check_cÜru±iÚ
);

140 
	$check_cÜru±iÚ
(
wÜk_¡ruù
 *
dummy
)

142 
	`check_fÜ_bios_cÜru±iÚ
();

143 
	`scheduË_d–ayed_wÜk
(&
bios_check_wÜk
,

144 
	`round_jiff›s_»Ïtive
(
cÜru±iÚ_check_³riod
*
HZ
));

145 
	}
}

147 
	$¡¬t_³riodic_check_fÜ_cÜru±iÚ
()

149 ià(!
memÜy_cÜru±iÚ_check
 || 
cÜru±iÚ_check_³riod
 == 0)

152 
	`´štk
(
KERN_INFO
 "Scanning for†ow memory corruptionƒvery %d seconds\n",

153 
cÜru±iÚ_check_³riod
);

156 
	`scheduË_d–ayed_wÜk
(&
bios_check_wÜk
, 0);

158 
	}
}

160 
moduË_š™
(
¡¬t_³riodic_check_fÜ_cÜru±iÚ
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<lšux/ıu.h
>

7 
	~<asm/·t.h
>

8 
	~<asm/´oûssÜ.h
>

10 
	~<asm/­ic.h
>

12 
	sıuid_b™
 {

13 
u16
 
	mã©u»
;

14 
u8
 
	m»g
;

15 
u8
 
	mb™
;

16 
u32
 
	mËv–
;

19 
	eıuid_»gs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__ıuš™
 
	$š™_sÿ‰”ed_ıuid_ã©u»s
(
ıušfo_x86
 *
c
)

28 
u32
 
max_Ëv–
;

29 
u32
 
»gs
[4];

30 cÚ¡ 
ıuid_b™
 *
cb
;

32 cÚ¡ 
ıuid_b™
 
__ıuš™cÚ¡
 
ıuid_b™s
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

38 
cb
 = 
ıuid_b™s
; cb->
ã©u»
; cb++) {

41 
max_Ëv–
 = 
	`ıuid_—x
(
cb
->
Ëv–
 & 0xffff0000);

42 ià(
max_Ëv–
 < 
cb
->
Ëv–
 ||

43 
max_Ëv–
 > (
cb
->
Ëv–
 | 0xffff))

46 
	`ıuid
(
cb
->
Ëv–
, &
»gs
[
CR_EAX
], &»gs[
CR_EBX
],

47 &
»gs
[
CR_ECX
], &»gs[
CR_EDX
]);

49 ià(
»gs
[
cb
->
»g
] & (1 << cb->
b™
))

50 
	`£t_ıu_ÿp
(
c
, 
cb
->
ã©u»
);

52 
	}
}

55 
	#SMT_LEVEL
 0

	)

58 
	#INVALID_TYPE
 0

	)

59 
	#SMT_TYPE
 1

	)

60 
	#CORE_TYPE
 2

	)

62 
	#LEAFB_SUBTYPE
(
ecx
è((Ócxè>> 8è& 0xff)

	)

63 
	#BITS_SHIFT_NEXT_LEVEL
(
—x
è(Óaxè& 0x1f)

	)

64 
	#LEVEL_MAX_SIBLINGS
(
ebx
è(Óbxè& 0xffff)

	)

71 
__ıuš™
 
	$d‘eù_ex‹nded_tİŞogy
(
ıušfo_x86
 *
c
)

73 #ifdeà
CONFIG_SMP


74 
—x
, 
ebx
, 
ecx
, 
edx
, 
sub_šdex
;

75 
ht_mask_width
, 
cÜe_¶us_mask_width
;

76 
cÜe_£Ëù_mask
, 
cÜe_Ëv–_siblšgs
;

78 ià(
c
->
ıuid_Ëv–
 < 0xb)

81 
	`ıuid_couÁ
(0xb, 
SMT_LEVEL
, &
—x
, &
ebx
, &
ecx
, &
edx
);

86 ià(
ebx
 =ğ0 || (
	`LEAFB_SUBTYPE
(
ecx
è!ğ
SMT_TYPE
))

89 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

94 
c
->
š™Ÿl_­icid
 = 
edx
;

99 
cÜe_Ëv–_siblšgs
 = 
smp_num_siblšgs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

100 
cÜe_¶us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
—x
);

102 
sub_šdex
 = 1;

104 
	`ıuid_couÁ
(0xb, 
sub_šdex
, &
—x
, &
ebx
, &
ecx
, &
edx
);

109 ià(
	`LEAFB_SUBTYPE
(
ecx
è=ğ
CORE_TYPE
) {

110 
cÜe_Ëv–_siblšgs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

111 
cÜe_¶us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
—x
);

115 
sub_šdex
++;

116 } 
	`LEAFB_SUBTYPE
(
ecx
è!ğ
INVALID_TYPE
);

118 
cÜe_£Ëù_mask
 = (~(-1 << 
cÜe_¶us_mask_width
)è>> 
ht_mask_width
;

120 
c
->
ıu_cÜe_id
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 
ht_mask_width
)

121 & 
cÜe_£Ëù_mask
;

122 
c
->
phys_´oc_id
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 
cÜe_¶us_mask_width
);

126 
c
->
­icid
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 0);

128 
c
->
x86_max_cÜes
 = (
cÜe_Ëv–_siblšgs
 / 
smp_num_siblšgs
);

131 
	`´štk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

132 
c
->
phys_´oc_id
);

133 ià(
c
->
x86_max_cÜes
 > 1)

134 
	`´štk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

135 
c
->
ıu_cÜe_id
);

138 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/b™İs.h
>

3 
	~<lšux/mm.h
>

5 
	~<asm/io.h
>

6 
	~<asm/´oûssÜ.h
>

7 
	~<asm/­ic.h
>

8 
	~<asm/ıu.h
>

10 #ifdeà
CONFIG_X86_64


11 
	~<asm/numa_64.h
>

12 
	~<asm/mmcÚfig.h
>

13 
	~<asm/ÿcheæush.h
>

16 
	~"ıu.h
"

18 #ifdeà
CONFIG_X86_32


32 
vide
();

33 
__asm__
(".align 4\nvide:„et");

35 
__ıuš™
 
	$š™_amd_k5
(
ıušfo_x86
 *
c
)

43 
	#CBAR
 (0xfffcè

	)

44 
	#CBAR_ENB
 (0x80000000)

	)

45 
	#CBAR_KEY
 (0X000000CB)

	)

46 ià(
c
->
x86_mod–
 == 9 || c->x86_model == 10) {

47 ià(
	`šl
 (
CBAR
è& 
CBAR_ENB
)

48 
	`ou
 (0 | 
CBAR_KEY
, 
CBAR
);

50 
	}
}

53 
__ıuš™
 
	$š™_amd_k6
(
ıušfo_x86
 *
c
)

55 
u32
 
l
, 
h
;

56 
mby‹s
 = 
num_phy¥ages
 >> (20-
PAGE_SHIFT
);

58 ià(
c
->
x86_mod–
 < 6) {

60 ià(
c
->
x86_mod–
 == 0) {

61 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_APIC
);

62 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_PGE
);

67 ià(
c
->
x86_mod–
 =ğ6 && c->
x86_mask
 == 1) {

68 cÚ¡ 
K6_BUG_LOOP
 = 1000000;

69 
n
;

70 (*
f_vide
)();

71 
d
, 
d2
;

73 
	`´štk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

80 
n
 = 
K6_BUG_LOOP
;

81 
f_vide
 = 
vide
;

82 
	`rdtsş
(
d
);

83 
n
--)

84 
	`f_vide
();

85 
	`rdtsş
(
d2
);

86 
d
 = 
d2
-d;

88 ià(
d
 > 20*
K6_BUG_LOOP
)

89 
	`´štk
("system stability may be impaired when morehan 32 MB‡re used.\n");

91 
	`´štk
("probably OK (after B9730xxxx).\n");

92 
	`´štk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

96 ià(
c
->
x86_mod–
 < 8 ||

97 (
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 < 8)) {

99 ià(
mby‹s
 > 508)

100 
mby‹s
 = 508;

102 
	`rdm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

103 ià((
l
&0x0000FFFF) == 0) {

104 
æags
;

105 
l
 = (1<<0)|((
mby‹s
/4)<<1);

106 
	`loÿl_œq_§ve
(
æags
);

107 
	`wbšvd
();

108 
	`wrm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

109 
	`loÿl_œq_»¡Üe
(
æags
);

110 
	`´štk
(
KERN_INFO
 "Enabling old style K6 write‡llocation for %d Mb\n",

111 
mby‹s
);

116 ià((
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 > 7) ||

117 
c
->
x86_mod–
 == 9 || c->x86_model == 13) {

120 ià(
mby‹s
 > 4092)

121 
mby‹s
 = 4092;

123 
	`rdm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

124 ià((
l
&0xFFFF0000) == 0) {

125 
æags
;

126 
l
 = ((
mby‹s
>>2)<<22)|(1<<16);

127 
	`loÿl_œq_§ve
(
æags
);

128 
	`wbšvd
();

129 
	`wrm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

130 
	`loÿl_œq_»¡Üe
(
æags
);

131 
	`´štk
(
KERN_INFO
 "Enabling‚ew style K6 write‡llocation for %d Mb\n",

132 
mby‹s
);

138 ià(
c
->
x86_mod–
 == 10) {

143 
	}
}

145 
__ıuš™
 
	$amd_k7_smp_check
(
ıušfo_x86
 *
c
)

147 #ifdeà
CONFIG_SMP


149 ià(
c
->
ıu_šdex
 =ğ
boÙ_ıu_id
)

157 ià((
c
->
x86_mod–
 =ğ6è&& ((c->
x86_mask
 == 0) ||

158 (
c
->
x86_mask
 == 1)))

159 
v®id_k7
;

162 ià((
c
->
x86_mod–
 =ğ7è&& (c->
x86_mask
 == 0))

163 
v®id_k7
;

172 ià(((
c
->
x86_mod–
 =ğ6è&& (c->
x86_mask
 >= 2)) ||

173 ((
c
->
x86_mod–
 =ğ7è&& (c->
x86_mask
 >= 1)) ||

174 (
c
->
x86_mod–
 > 7))

175 ià(
ıu_has_mp
)

176 
v®id_k7
;

184 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

186 ià(!
	`‹¡_št
(
TAINT_UNSAFE_SMP
))

187 
	`add_št
(
TAINT_UNSAFE_SMP
);

189 
v®id_k7
:

192 
	}
}

194 
__ıuš™
 
	$š™_amd_k7
(
ıušfo_x86
 *
c
)

196 
u32
 
l
, 
h
;

203 ià(
c
->
x86_mod–
 >= 6 && c->x86_model <= 10) {

204 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_XMM
)) {

205 
	`´štk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

206 
	`rdm¤
(
MSR_K7_HWCR
, 
l
, 
h
);

207 
l
 &= ~0x00008000;

208 
	`wrm¤
(
MSR_K7_HWCR
, 
l
, 
h
);

209 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_XMM
);

218 ià((
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

219 
	`rdm¤
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

220 ià((
l
 & 0xfff00000) != 0x20000000) {

221 
	`´štk
 ("CPU: CLK_CTL MSR wa %x. R•rog¿mmšgØ%x\n", 
l
,

222 ((
l
 & 0x000fffff)|0x20000000));

223 
	`wrm¤
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

227 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_K7
);

229 
	`amd_k7_smp_check
(
c
);

230 
	}
}

233 #ià
defšed
(
CONFIG_NUMA
è&& defšed(
CONFIG_X86_64
)

234 
__ıuš™
 
	$Ã¬by_node
(
­icid
)

236 
i
, 
node
;

238 
i
 = 
­icid
 - 1; i >= 0; i--) {

239 
node
 = 
­icid_to_node
[
i
];

240 ià(
node
 !ğ
NUMA_NO_NODE
 && 
	`node_Úlše
(node))

241  
node
;

243 
i
 = 
­icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

244 
node
 = 
­icid_to_node
[
i
];

245 ià(
node
 !ğ
NUMA_NO_NODE
 && 
	`node_Úlše
(node))

246  
node
;

248  
	`fœ¡_node
(
node_Úlše_m­
);

249 
	}
}

256 
__ıuš™
 
	$amd_d‘eù_cmp
(
ıušfo_x86
 *
c
)

258 #ifdeà
CONFIG_X86_HT


259 
b™s
;

261 
b™s
 = 
c
->
x86_cÜeid_b™s
;

264 
c
->
ıu_cÜe_id
 = c->
š™Ÿl_­icid
 & ((1 << 
b™s
)-1);

266 
c
->
phys_´oc_id
 = c->
š™Ÿl_­icid
 >> 
b™s
;

268 
	}
}

270 
__ıuš™
 
	$¤©_d‘eù_node
(
ıušfo_x86
 *
c
)

272 #ià
	`defšed
(
CONFIG_NUMA
è&& defšed(
CONFIG_X86_64
)

273 
ıu
 = 
	`smp_´oûssÜ_id
();

274 
node
;

275 
­icid
 = 
	`h¬d_smp_´oûssÜ_id
();

277 
node
 = 
c
->
phys_´oc_id
;

278 ià(
­icid_to_node
[
­icid
] !ğ
NUMA_NO_NODE
)

279 
node
 = 
­icid_to_node
[
­icid
];

280 ià(!
	`node_Úlše
(
node
)) {

291 
ht_nodeid
 = 
c
->
š™Ÿl_­icid
;

293 ià(
ht_nodeid
 >= 0 &&

294 
­icid_to_node
[
ht_nodeid
] !ğ
NUMA_NO_NODE
)

295 
node
 = 
­icid_to_node
[
ht_nodeid
];

297 ià(!
	`node_Úlše
(
node
))

298 
node
 = 
	`Ã¬by_node
(
­icid
);

300 
	`numa_£t_node
(
ıu
, 
node
);

302 
	`´štk
(
KERN_INFO
 "CPU %d/0x%x -> Nod%d\n", 
ıu
, 
­icid
, 
node
);

304 
	}
}

306 
__ıuš™
 
	$—¾y_š™_amd_mc
(
ıušfo_x86
 *
c
)

308 #ifdeà
CONFIG_X86_HT


309 
b™s
, 
ecx
;

312 ià(
c
->
ex‹nded_ıuid_Ëv–
 < 0x80000008)

315 
ecx
 = 
	`ıuid_ecx
(0x80000008);

317 
c
->
x86_max_cÜes
 = (
ecx
 & 0xff) + 1;

320 
b™s
 = (
ecx
 >> 12) & 0xF;

323 ià(
b™s
 == 0) {

324 (1 << 
b™s
è< 
c
->
x86_max_cÜes
)

325 
b™s
++;

328 
c
->
x86_cÜeid_b™s
 = 
b™s
;

330 
	}
}

332 
__ıuš™
 
	$—¾y_š™_amd
(
ıušfo_x86
 *
c
)

334 
	`—¾y_š™_amd_mc
(
c
);

340 ià(
c
->
x86_pow”
 & (1 << 8)) {

341 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

342 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

345 #ifdeà
CONFIG_X86_64


346 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_SYSCALL32
);

349 ià(
c
->
x86
 == 5)

350 ià(
c
->
x86_mod–
 == 13 || c->x86_model == 9 ||

351 (
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 >= 8))

352 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_K6_MTRR
);

354 
	}
}

356 
__ıuš™
 
	$š™_amd
(
ıušfo_x86
 *
c
)

358 #ifdeà
CONFIG_SMP


359 
v®ue
;

368 ià(
c
->
x86
 == 0xf) {

369 
	`rdm¤l
(
MSR_K7_HWCR
, 
v®ue
);

370 
v®ue
 |= 1 << 6;

371 
	`wrm¤l
(
MSR_K7_HWCR
, 
v®ue
);

375 
	`—¾y_š™_amd
(
c
);

381 
	`ş—r_ıu_ÿp
(
c
, 0*32+31);

383 #ifdeà
CONFIG_X86_64


385 ià(
c
->
x86
 == 0xf) {

386 
u32
 
Ëv–
;

388 
Ëv–
 = 
	`ıuid_—x
(1);

389 if((
Ëv–
 >= 0x0f48 &&†evel < 0x0f50) ||†evel >= 0x0f58)

390 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_REP_GOOD
);

392 ià(
c
->
x86
 == 0x10 || c->x86 == 0x11)

393 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_REP_GOOD
);

402 
c
->
x86
) {

404 
	`š™_amd_k5
(
c
);

407 
	`š™_amd_k6
(
c
);

410 
	`š™_amd_k7
(
c
);

415 ià(
c
->
x86
 < 6)

416 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_MCE
);

420 ià(
c
->
x86
 >= 6)

421 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

423 ià(!
c
->
x86_mod–_id
[0]) {

424 
c
->
x86
) {

428 
	`¡rıy
(
c
->
x86_mod–_id
, "Hammer");

433 
	`di¥Ïy_ÿchešfo
(
c
);

436 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000008) {

437 
	`amd_d‘eù_cmp
(
c
);

438 
	`¤©_d‘eù_node
(
c
);

441 #ifdeà
CONFIG_X86_32


442 
	`d‘eù_ht
(
c
);

445 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000006) {

446 ià((
c
->
x86
 >ğ0x0fè&& (
	`ıuid_edx
(0x80000006) & 0xf000))

447 
num_ÿche_Ëaves
 = 4;

449 
num_ÿche_Ëaves
 = 3;

452 ià(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

453 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_K8
);

455 ià(
ıu_has_xmm2
) {

457 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

460 #ifdeà
CONFIG_X86_64


461 ià(
c
->
x86
 == 0x10) {

463 ià(
c
 =ğ&
boÙ_ıu_d©a
)

464 
	`check_’abË_amd_mmcÚf_dmi
();

466 
	`çm10h_check_’abË_mmcfg
();

469 ià(
c
 =ğ&
boÙ_ıu_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

470 
t£g
;

477 ià(!
	`rdm¤l_§ã
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

478 
	`´štk
(
KERN_DEBUG
 "t£g: %010Îx\n", 
t£g
);

479 ià((
t£g
>>
PMD_SHIFT
) <

480 (
max_low_pâ_m­³d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

481 ((
t£g
>>
PMD_SHIFT
) <

482 (
max_pâ_m­³d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

483 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

484 
	`£t_memÜy_4k
(()
	`__va
(
t£g
), 1);

488 
	}
}

490 #ifdeà
CONFIG_X86_32


491 
__ıuš™
 
	$amd_size_ÿche
(
ıušfo_x86
 *
c
, 
size
)

494 ià((
c
->
x86
 == 6)) {

495 ià(
c
->
x86_mod–
 =ğ3 && c->
x86_mask
 == 0)

496 
size
 = 64;

497 ià(
c
->
x86_mod–
 == 4 &&

498 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

499 
size
 = 256;

501  
size
;

502 
	}
}

505 cÚ¡ 
ıu_dev
 
__ıuš™cÚ¡
 
	gamd_ıu_dev
 = {

506 .
c_v’dÜ
 = "AMD",

507 .
	gc_id’t
 = { "AuthenticAMD" },

508 #ifdeà
CONFIG_X86_32


509 .
	gc_mod–s
 = {

510 { .
v’dÜ
 = 
X86_VENDOR_AMD
, .
	gçmy
 = 4, .
	gmod–_Çmes
 =

521 .
	gc_size_ÿche
 = 
amd_size_ÿche
,

523 .
	gc_—¾y_š™
 = 
—¾y_š™_amd
,

524 .
	gc_š™
 = 
š™_amd
,

525 .
	gc_x86_v’dÜ
 = 
X86_VENDOR_AMD
,

528 
ıu_dev_»gi¡”
(
amd_ıu_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/š™.h
>

8 
	~<asm/®‹º©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/´oûssÜ.h
>

11 
	~<asm/mŒr.h
>

12 
	~<asm/ÿcheæush.h
>

14 
__š™
 
	$check_bugs
()

16 
	`id’tify_boÙ_ıu
();

17 #ià!
	`defšed
(
CONFIG_SMP
)

18 
	`´štk
("CPU: ");

19 
	`´št_ıu_šfo
(&
boÙ_ıu_d©a
);

21 
	`®‹º©ive_š¡ruùiÚs
();

31 ià(!
dœeù_gb·ges
)

32 
	`£t_memÜy_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/ıuã©u».h
>

3 cÚ¡ * cÚ¡ 
	gx86_ÿp_æags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_XMM3
] = "pni",

63 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

64 [
X86_FEATURE_DTES64
] = "dtes64",

65 [
X86_FEATURE_MWAIT
] = "monitor",

66 [
X86_FEATURE_DSCPL
] = "ds_cpl",

67 [
X86_FEATURE_VMX
] = "vmx",

68 [
X86_FEATURE_SMX
] = "smx",

69 [
X86_FEATURE_EST
] = "est",

70 [
X86_FEATURE_TM2
] = "tm2",

71 [
X86_FEATURE_SSSE3
] = "ssse3",

72 [
X86_FEATURE_CID
] = "cid",

73 [
X86_FEATURE_FMA
] = "fma",

74 [
X86_FEATURE_CX16
] = "cx16",

75 [
X86_FEATURE_XTPR
] = "xtpr",

76 [
X86_FEATURE_PDCM
] = "pdcm",

77 [
X86_FEATURE_DCA
] = "dca",

78 [
X86_FEATURE_XMM4_1
] = "sse4_1",

79 [
X86_FEATURE_XMM4_2
] = "sse4_2",

80 [
X86_FEATURE_X2APIC
] = "x2apic",

81 [
X86_FEATURE_AES
] = "aes",

82 [
X86_FEATURE_XSAVE
] = "xsave",

83 [
X86_FEATURE_AVX
] = "avx",

84 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

85 [
X86_FEATURE_XSTORE
] = "rng",

86 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

87 [
X86_FEATURE_XCRYPT
] = "ace",

88 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

89 [
X86_FEATURE_ACE2
] = "ace2",

90 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

91 [
X86_FEATURE_PHE
] = "phe",

92 [
X86_FEATURE_PHE_EN
] = "phe_en",

93 [
X86_FEATURE_PMM
] = "pmm",

94 [
X86_FEATURE_PMM_EN
] = "pmm_en",

95 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

96 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

97 [
X86_FEATURE_SVM
] = "svm",

98 [
X86_FEATURE_EXTAPIC
] = "extapic",

99 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

100 [
X86_FEATURE_ABM
] = "abm",

101 [
X86_FEATURE_SSE4A
] = "sse4a",

102 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

103 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

104 [
X86_FEATURE_OSVW
] = "osvw",

105 [
X86_FEATURE_IBS
] = "ibs",

106 [
X86_FEATURE_SSE5
] = "sse5",

107 [
X86_FEATURE_SKINIT
] = "skinit",

108 [
X86_FEATURE_WDT
] = "wdt",

109 [
X86_FEATURE_IDA
] = "ida",

110 [
X86_FEATURE_ARAT
] = "arat",

111 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

112 [
X86_FEATURE_VNMI
] = "vnmi",

113 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

114 [
X86_FEATURE_EPT
] = "ept",

115 [
X86_FEATURE_VPID
] = "vpid",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<lšux/b™İs.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/š™.h
>

5 
	~<asm/´oûssÜ.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mŒr.h
>

8 
	~<asm/m¤.h
>

10 
	~"ıu.h
"

12 #ifdeà
CONFIG_X86_OOSTORE


14 
u32
 
__ıuš™
 
	$pow”2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <ğ
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__ıuš™
 
	$ûÁaur_mü_š£¹
(
»g
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |ğ
key
;

36 
	`wrm¤
(
»g
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mŒr_ûÁaur_»pÜt_mü
(
»g
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__ıuš™
 
	$¿mtİ
()

47 
u32
 
ş
 = 0xFFFFFFFFUL;

48 
u32
 
tİ
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

52 
¡¬t
, 
’d
;

54 ià(
e820
.
m­
[
i
].
addr
 > 0xFFFFFFFFUL)

60 ià(
e820
.
m­
[
i
].
ty³
 =ğ
E820_RESERVED
) {

61 ià(
e820
.
m­
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m­
[
i
].
addr
 < 
ş
)

63 
ş
 = 
e820
.
m­
[
i
].
addr
;

66 
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

67 
’d
 = 
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
;

68 ià(
¡¬t
 >ğ
’d
)

70 ià(
’d
 > 
tİ
)

71 
tİ
 = 
’d
;

85 ià(
tİ
 > 
ş
)

86 
tİ
 = 
ş
;

88  
tİ
;

89 
	}
}

94 
__ıuš™
 
	$ûÁaur_mü_compu‹
(
Ä
, 
key
)

96 
u32
 
mem
 = 
	`¿mtİ
();

97 
u32
 
roÙ
 = 
	`pow”2
(
mem
);

98 
u32
 
ba£
 = 
roÙ
;

99 
u32
 
tİ
 = 
roÙ
;

100 
u32
 
æoÜ
 = 0;

101 
ù
 = 0;

103 
ù
 < 
Ä
) {

104 
u32
 
f¥aû
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`pow”2
(
mem
-
tİ
);

116 
low
 = 
ba£
/2;

122 ià(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 ià(
æoÜ
 == 0)

131 
f¥aû
 = 512*1024;

132 ià(
æoÜ
 == 512*1024)

133 
f¥aû
 = 128*1024;

140 ià(
f¥aû
 > 
high
 && f¥aû > 
low
) {

141 
	`ûÁaur_mü_š£¹
(
ù
, 
æoÜ
, 
f¥aû
, 
key
);

142 
æoÜ
 +ğ
f¥aû
;

143 } ià(
high
 > 
low
) {

144 
	`ûÁaur_mü_š£¹
(
ù
, 
tİ
, 
high
, 
key
);

145 
tİ
 +ğ
high
;

146 } ià(
low
 > 0) {

147 
ba£
 -ğ
low
;

148 
	`ûÁaur_mü_š£¹
(
ù
, 
ba£
, 
low
, 
key
);

151 
ù
++;

157  
ù
;

158 
	}
}

160 
__ıuš™
 
	$ûÁaur_ü—‹_İtim®_mü
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`ûÁaur_mü_compu‹
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm¤
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__ıuš™
 
	$wšch2_ü—‹_İtim®_mü
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`ûÁaur_mü_compu‹
(6, 25);

204 
	`rdm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |ğ1<<(9+
i
);

207 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm¤
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__ıuš™
 
	$wšch2_uÅrÙeù_mü
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |ğ
key
<<6;

229 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__ıuš™
 
	$wšch2_´Ùeù_mü
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28è

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6è

	)

250 
__ıuš™
 
	$š™_c3
(
ıušfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 ià(
	`ıuid_—x
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`ıuid_edx
(0xC0000001);

259 ià((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm¤
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |ğ
ACE_FCR
;

262 
	`wrm¤
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`´štk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 ià((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm¤
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |ğ
RNG_ENABLE
;

270 
	`wrm¤
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`´štk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ÿ·b™y
[5] = 
	`ıuid_edx
(0xC0000001);

279 #ifdeà
CONFIG_X86_32


281 ià(
c
->
x86_mod–
 >= 6 && c->x86_model <= 9) {

282 
	`rdm¤
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm¤
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CX8
);

289 ià(
c
->
x86_mod–
 >= 6 && c->x86_model < 9)

290 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_3DNOW
);

292 ià(
c
->
x86
 =ğ0x6 && c->
x86_mod–
 >= 0xf) {

293 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
 * 2;

294 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`di¥Ïy_ÿchešfo
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__ıuš™
 
	$—¾y_š™_ûÁaur
(
ıušfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifdeà
CONFIG_X86_32


327 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 ià(
c
->
x86_mod–
 >= 0xf)

332 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifdeà
CONFIG_X86_64


336 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__ıuš™
 
	$š™_ûÁaur
(
ıušfo_x86
 *
c
)

342 #ifdeà
CONFIG_X86_32


343 *
Çme
;

344 
u32
 
fü_£t
 = 0;

345 
u32
 
fü_şr
 = 0;

346 
u32
 
lo
, 
hi
, 
Ãwlo
;

347 
u32
 
¯
, 
bb
, 
cc
, 
dd
;

353 
	`ş—r_ıu_ÿp
(
c
, 0*32+31);

355 
	`—¾y_š™_ûÁaur
(
c
);

356 
c
->
x86
) {

357 #ifdeà
CONFIG_X86_32


359 
c
->
x86_mod–
) {

361 
Çme
 = "C6";

362 
fü_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
fü_şr
 = 
DPDC
;

364 
	`´štk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_TSC
);

366 #ifdeà
CONFIG_X86_OOSTORE


367 
	`ûÁaur_ü—‹_İtim®_mü
();

378 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
Çme
 = "2";

387 
Çme
 = "2A";

390 
Çme
 = "2B";

393 
fü_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
fü_şr
 = 
DPDC
;

396 #ifdeà
CONFIG_X86_OOSTORE


397 
	`wšch2_uÅrÙeù_mü
();

398 
	`wšch2_ü—‹_İtim®_mü
();

399 
	`rdm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wšch2_´Ùeù_mü
();

412 
Çme
 = "3";

413 
fü_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
fü_şr
 = 
DPDC
;

416 #ifdeà
CONFIG_X86_OOSTORE


417 
	`wšch2_uÅrÙeù_mü
();

418 
	`wšch2_ü—‹_İtim®_mü
();

419 
	`rdm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm¤
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wšch2_´Ùeù_mü
();

432 
Çme
 = "??";

435 
	`rdm¤
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
Ãwlo
 = (
lo
|
fü_£t
è& (~
fü_şr
);

438 ià(
Ãwlo
 !ğ
lo
) {

439 
	`´štk
(
KERN_INFO
 "Centaur FCR was 0x%X‚ow 0x%X\n",

440 
lo
, 
Ãwlo
);

441 
	`wrm¤
(
MSR_IDT_FCR1
, 
Ãwlo
, 
hi
);

443 
	`´štk
(
KERN_INFO
 "C’u¸FCR i 0x%X\n", 
lo
);

446 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CX8
);

450 ià(
c
->
x86_mod–
 >= 8)

451 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_3DNOW
);

453 ià(
	`ıuid_—x
(0x80000000) >= 0x80000005) {

455 
	`ıuid
(0x80000005, &
¯
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ÿche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`¥rštf
(
c
->
x86_mod–_id
, "WšCh %s", 
Çme
);

463 
	`š™_c3
(
c
);

466 #ifdeà
CONFIG_X86_64


467 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__ıuš™


472 
	$ûÁaur_size_ÿche
(
ıušfo_x86
 *
c
, 
size
)

474 #ifdeà
CONFIG_X86_32


476 ià((
c
->
x86
 =ğ6è&& ((c->
x86_mod–
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 ià((
c
->
x86
 =ğ6è&& (c->
x86_mod–
 == 9) &&

485 (
c
->
x86_mask
 =ğ1è&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 cÚ¡ 
ıu_dev
 
__ıuš™cÚ¡
 
	gûÁaur_ıu_dev
 = {

492 .
c_v’dÜ
 = "Centaur",

493 .
	gc_id’t
 = { "CentaurHauls" },

494 .
	gc_—¾y_š™
 = 
—¾y_š™_ûÁaur
,

495 .
	gc_š™
 = 
š™_ûÁaur
,

496 .
	gc_size_ÿche
 = 
ûÁaur_size_ÿche
,

497 .
	gc_x86_v’dÜ
 = 
X86_VENDOR_CENTAUR
,

500 
ıu_dev_»gi¡”
(
ûÁaur_ıu_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<lšux/boÙmem.h
>

2 
	~<lšux/lškage.h
>

3 
	~<lšux/b™İs.h
>

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/moduË.h
>

6 
	~<lšux/³rıu.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/d–ay.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/kgdb.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/io.h
>

15 
	~<asm/¡ack´ÙeùÜ.h
>

16 
	~<asm/mmu_cÚ‹xt.h
>

17 
	~<asm/hy³rvisÜ.h
>

18 
	~<asm/´oûssÜ.h
>

19 
	~<asm/£ùiÚs.h
>

20 
	~<asm/tİŞogy.h
>

21 
	~<asm/ıumask.h
>

22 
	~<asm/pgbË.h
>

23 
	~<asm/©omic.h
>

24 
	~<asm/´Ùo.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/­ic.h
>

27 
	~<asm/desc.h
>

28 
	~<asm/i387.h
>

29 
	~<asm/mŒr.h
>

30 
	~<asm/numa.h
>

31 
	~<asm/asm.h
>

32 
	~<asm/ıu.h
>

33 
	~<asm/mû.h
>

34 
	~<asm/m¤.h
>

35 
	~<asm/·t.h
>

36 
	~<asm/smp.h
>

38 #ifdeà
CONFIG_X86_LOCAL_APIC


39 
	~<asm/uv/uv.h
>

42 
	~"ıu.h
"

45 
ıumask_v¬_t
 
	gıu_š™Ÿlized_mask
;

46 
ıumask_v¬_t
 
	gıu_ÿÎout_mask
;

47 
ıumask_v¬_t
 
	gıu_ÿÎš_mask
;

50 
ıumask_v¬_t
 
	gıu_siblšg_£tup_mask
;

53 
__š™
 
	$£tup_ıu_loÿl_masks
()

55 
	`®loc_boÙmem_ıumask_v¬
(&
ıu_š™Ÿlized_mask
);

56 
	`®loc_boÙmem_ıumask_v¬
(&
ıu_ÿÎš_mask
);

57 
	`®loc_boÙmem_ıumask_v¬
(&
ıu_ÿÎout_mask
);

58 
	`®loc_boÙmem_ıumask_v¬
(&
ıu_siblšg_£tup_mask
);

59 
	}
}

61 cÚ¡ 
ıu_dev
 *
this_ıu
 
	g__ıuš™d©a
;

63 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_·ge
, gdt_·geèğ{ .
gdt
 = {

64 #ifdeà
CONFIG_X86_64


73 [
GDT_ENTRY_KERNEL32_CS
] = { { { 0x0000ffff, 0x00cf9b00 } } },

74 [
GDT_ENTRY_KERNEL_CS
] = { { { 0x0000ffff, 0x00af9b00 } } },

75 [
GDT_ENTRY_KERNEL_DS
] = { { { 0x0000ffff, 0x00cf9300 } } },

76 [
GDT_ENTRY_DEFAULT_USER32_CS
] = { { { 0x0000ffff, 0x00cffb00 } } },

77 [
GDT_ENTRY_DEFAULT_USER_DS
] = { { { 0x0000ffff, 0x00cff300 } } },

78 [
GDT_ENTRY_DEFAULT_USER_CS
] = { { { 0x0000ffff, 0x00affb00 } } },

80 [
GDT_ENTRY_KERNEL_CS
] = { { { 0x0000ffff, 0x00cf9a00 } } },

81 [
GDT_ENTRY_KERNEL_DS
] = { { { 0x0000ffff, 0x00cf9200 } } },

82 [
GDT_ENTRY_DEFAULT_USER_CS
] = { { { 0x0000ffff, 0x00cffa00 } } },

83 [
GDT_ENTRY_DEFAULT_USER_DS
] = { { { 0x0000ffff, 0x00cff200 } } },

90 [
GDT_ENTRY_PNPBIOS_CS32
] = { { { 0x0000ffff, 0x00409a00 } } },

92 [
GDT_ENTRY_PNPBIOS_CS16
] = { { { 0x0000ffff, 0x00009a00 } } },

94 [
GDT_ENTRY_PNPBIOS_DS
] = { { { 0x0000ffff, 0x00009200 } } },

96 [
GDT_ENTRY_PNPBIOS_TS1
] = { { { 0x00000000, 0x00009200 } } },

98 [
GDT_ENTRY_PNPBIOS_TS2
] = { { { 0x00000000, 0x00009200 } } },

104 [
GDT_ENTRY_APMBIOS_BASE
] = { { { 0x0000ffff, 0x00409a00 } } },

106 [
GDT_ENTRY_APMBIOS_BASE
+1] = { { { 0x0000ffff, 0x00009a00 } } },

108 [
GDT_ENTRY_APMBIOS_BASE
+2] = { { { 0x0000ffff, 0x00409200 } } },

110 [
GDT_ENTRY_ESPFIX_SS
] = { { { 0x00000000, 0x00c09200 } } },

111 [
GDT_ENTRY_PERCPU
] = { { { 0x0000ffff, 0x00cf9200 } } },

112 
	gGDT_STACK_CANARY_INIT


115 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_·ge
);

117 
__š™
 
	$x86_x§ve_£tup
(*
s
)

119 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_XSAVE
);

121 
	}
}

122 
__£tup
("nox§ve", 
x86_x§ve_£tup
);

124 #ifdeà
CONFIG_X86_32


125 
ÿchesize_ov”ride
 
	g__ıuš™d©a
 = -1;

126 
di§bË_x86_£rŸl_Ä
 
	g__ıuš™d©a
 = 1;

128 
__š™
 
	$ÿchesize_£tup
(*
¡r
)

130 
	`g‘_İtiÚ
(&
¡r
, &
ÿchesize_ov”ride
);

132 
	}
}

133 
__£tup
("ÿchesize=", 
ÿchesize_£tup
);

135 
__š™
 
	$x86_fx¤_£tup
(*
s
)

137 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_FXSR
);

138 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_XMM
);

140 
	}
}

141 
__£tup
("nofx¤", 
x86_fx¤_£tup
);

143 
__š™
 
	$x86_£p_£tup
(*
s
)

145 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_SEP
);

147 
	}
}

148 
__£tup
("no£p", 
x86_£p_£tup
);

151 
šlše
 
	$æag_is_chªg—bË_p
(
u32
 
æag
)

153 
u32
 
f1
, 
f2
;

162 
asm
 volatile ("pushfl \n\t"

173 : "=&r" (
f1
), "=&r" (
f2
)

174 : "œ" (
æag
));

176  ((
f1
^
f2
è& 
æag
) != 0;

177 
	}
}

180 
__ıuš™
 
	$have_ıuid_p
()

182  
	`æag_is_chªg—bË_p
(
X86_EFLAGS_ID
);

183 
	}
}

185 
__ıuš™
 
	$squash_the_¡upid_£rŸl_numb”
(
ıušfo_x86
 *
c
)

187 
lo
, 
hi
;

189 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_PN
è|| !
di§bË_x86_£rŸl_Ä
)

194 
	`rdm¤
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

195 
lo
 |= 0x200000;

196 
	`wrm¤
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

198 
	`´štk
(
KERN_NOTICE
 "CPU serial‚umber disabled.\n");

199 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_PN
);

202 
c
->
ıuid_Ëv–
 = 
	`ıuid_—x
(0);

203 
	}
}

205 
__š™
 
	$x86_£rŸl_Ä_£tup
(*
s
)

207 
di§bË_x86_£rŸl_Ä
 = 0;

209 
	}
}

210 
__£tup
("£rŸÊumb”", 
x86_£rŸl_Ä_£tup
);

212 
šlše
 
	$æag_is_chªg—bË_p
(
u32
 
æag
)

215 
	}
}

217 
šlše
 
	$have_ıuid_p
()

220 
	}
}

221 
šlše
 
	$squash_the_¡upid_£rŸl_numb”
(
ıušfo_x86
 *
c
)

223 
	}
}

231 
	sıuid_d•’d’t_ã©u»
 {

232 
u32
 
	mã©u»
;

233 
u32
 
	mËv–
;

236 cÚ¡ 
ıuid_d•’d’t_ã©u»
 
__ıuš™cÚ¡


237 
	gıuid_d•’d’t_ã©u»s
[] = {

238 { 
X86_FEATURE_MWAIT
, 0x00000005 },

239 { 
X86_FEATURE_DCA
, 0x00000009 },

240 { 
X86_FEATURE_XSAVE
, 0x0000000d },

244 
__ıuš™
 
	$f‹r_ıuid_ã©u»s
(
ıušfo_x86
 *
c
, 
boŞ
 
w¬n
)

246 cÚ¡ 
ıuid_d•’d’t_ã©u»
 *
df
;

248 
df
 = 
ıuid_d•’d’t_ã©u»s
; df->
ã©u»
; df++) {

250 ià(!
	`ıu_has
(
c
, 
df
->
ã©u»
))

259 ià(!((
s32
)
df
->
Ëv–
 < 0 ?

260 (
u32
)
df
->
Ëv–
 > (u32)
c
->
ex‹nded_ıuid_Ëv–
 :

261 (
s32
)
df
->
Ëv–
 > (s32)
c
->
ıuid_Ëv–
))

264 
	`ş—r_ıu_ÿp
(
c
, 
df
->
ã©u»
);

265 ià(!
w¬n
)

268 
	`´štk
(
KERN_WARNING


270 
x86_ÿp_æags
[
df
->
ã©u»
], df->
Ëv–
);

272 
	}
}

282 cÚ¡ *
__ıuš™
 
	$bË_lookup_mod–
(
ıušfo_x86
 *
c
)

284 cÚ¡ 
ıu_mod–_šfo
 *
šfo
;

286 ià(
c
->
x86_mod–
 >= 16)

287  
NULL
;

289 ià(!
this_ıu
)

290  
NULL
;

292 
šfo
 = 
this_ıu
->
c_mod–s
;

294 
šfo
 && info->
çmy
) {

295 ià(
šfo
->
çmy
 =ğ
c
->
x86
)

296  
šfo
->
mod–_Çmes
[
c
->
x86_mod–
];

297 
šfo
++;

299  
NULL
;

300 
	}
}

302 
__u32
 
	gş—»d_ıu_ÿps
[
NCAPINTS
] 
	g__ıuš™d©a
;

304 
	$lßd_³rıu_£gm’t
(
ıu
)

306 #ifdeà
CONFIG_X86_32


307 
	`lßd£gm’t
(
fs
, 
__KERNEL_PERCPU
);

309 
	`lßd£gm’t
(
gs
, 0);

310 
	`wrm¤l
(
MSR_GS_BASE
, ()
	`³r_ıu
(
œq_¡ack_uniÚ
.
gs_ba£
, 
ıu
));

312 
	`lßd_¡ack_ÿÇry_£gm’t
();

313 
	}
}

319 
	$sw™ch_to_Ãw_gdt
(
ıu
)

321 
desc_±r
 
gdt_desü
;

323 
gdt_desü
.
add»ss
 = ()
	`g‘_ıu_gdt_bË
(
ıu
);

324 
gdt_desü
.
size
 = 
GDT_SIZE
 - 1;

325 
	`lßd_gdt
(&
gdt_desü
);

328 
	`lßd_³rıu_£gm’t
(
ıu
);

329 
	}
}

331 cÚ¡ 
ıu_dev
 *
__ıuš™d©a
 
	gıu_devs
[
X86_VENDOR_NUM
] = {};

333 
__ıuš™
 
	$deçuÉ_š™
(
ıušfo_x86
 *
c
)

335 #ifdeà
CONFIG_X86_64


336 
	`di¥Ïy_ÿchešfo
(
c
);

340 ià(
c
->
ıuid_Ëv–
 == -1) {

342 ià(
c
->
x86
 == 4)

343 
	`¡rıy
(
c
->
x86_mod–_id
, "486");

344 ià(
c
->
x86
 == 3)

345 
	`¡rıy
(
c
->
x86_mod–_id
, "386");

348 
	}
}

350 cÚ¡ 
ıu_dev
 
__ıuš™cÚ¡
 
	gdeçuÉ_ıu
 = {

351 .
c_š™
 = 
deçuÉ_š™
,

352 .
	gc_v’dÜ
 = "Unknown",

353 .
	gc_x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
,

356 
__ıuš™
 
	$g‘_mod–_Çme
(
ıušfo_x86
 *
c
)

358 *
v
;

359 *
p
, *
q
;

361 ià(
c
->
ex‹nded_ıuid_Ëv–
 < 0x80000004)

364 
v
 = (*)
c
->
x86_mod–_id
;

365 
	`ıuid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

366 
	`ıuid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

367 
	`ıuid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

368 
c
->
x86_mod–_id
[48] = 0;

374 
p
 = 
q
 = &
c
->
x86_mod–_id
[0];

375 *
p
 == ' ')

376 
p
++;

377 ià(
p
 !ğ
q
) {

378 *
p
)

379 *
q
++ = *
p
++;

380 
q
 <ğ&
c
->
x86_mod–_id
[48])

381 *
q
++ = '\0';

383 
	}
}

385 
__ıuš™
 
	$di¥Ïy_ÿchešfo
(
ıušfo_x86
 *
c
)

387 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

389 
n
 = 
c
->
ex‹nded_ıuid_Ëv–
;

391 ià(
n
 >= 0x80000005) {

392 
	`ıuid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

393 
	`´štk
(
KERN_INFO
 "CPU: L1 I Cache: %dK (%d bytes/line), D cache %dK (%d bytes/line)\n",

394 
edx
>>24,ƒdx&0xFF, 
ecx
>>24,ƒcx&0xFF);

395 
c
->
x86_ÿche_size
 = (
ecx
>>24è+ (
edx
>>24);

396 #ifdeà
CONFIG_X86_64


398 
c
->
x86_bsize
 = 0;

402 ià(
n
 < 0x80000006)

405 
	`ıuid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

406 
l2size
 = 
ecx
 >> 16;

408 #ifdeà
CONFIG_X86_64


409 
c
->
x86_bsize
 +ğ((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

412 ià(
this_ıu
->
c_size_ÿche
)

413 
l2size
 = 
this_ıu
->
	`c_size_ÿche
(
c
,†2size);

416 ià(
ÿchesize_ov”ride
 != -1)

417 
l2size
 = 
ÿchesize_ov”ride
;

419 ià(
l2size
 == 0)

423 
c
->
x86_ÿche_size
 = 
l2size
;

425 
	`´štk
(
KERN_INFO
 "CPU: L2 Cache: %dK (%d bytes/line)\n",

426 
l2size
, 
ecx
 & 0xFF);

427 
	}
}

429 
__ıuš™
 
	$d‘eù_ht
(
ıušfo_x86
 *
c
)

431 #ifdeà
CONFIG_X86_HT


432 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

433 
šdex_msb
, 
cÜe_b™s
;

435 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_HT
))

438 ià(
	`ıu_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

439 
out
;

441 ià(
	`ıu_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

444 
	`ıuid
(1, &
—x
, &
ebx
, &
ecx
, &
edx
);

446 
smp_num_siblšgs
 = (
ebx
 & 0xff0000) >> 16;

448 ià(
smp_num_siblšgs
 == 1) {

449 
	`´štk
(
KERN_INFO
 "CPU: Hyper-Threading is disabled\n");

450 
out
;

453 ià(
smp_num_siblšgs
 <= 1)

454 
out
;

456 ià(
smp_num_siblšgs
 > 
Ä_ıu_ids
) {

457 
	`´_w¬nšg
("CPU: Unsupported‚umber of siblings %d",

458 
smp_num_siblšgs
);

459 
smp_num_siblšgs
 = 1;

463 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
smp_num_siblšgs
);

464 
c
->
phys_´oc_id
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 
šdex_msb
);

466 
smp_num_siblšgs
 = smp_num_siblšg / 
c
->
x86_max_cÜes
;

468 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
smp_num_siblšgs
);

470 
cÜe_b™s
 = 
	`g‘_couÁ_Üd”
(
c
->
x86_max_cÜes
);

472 
c
->
ıu_cÜe_id
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 
šdex_msb
) &

473 ((1 << 
cÜe_b™s
) - 1);

475 
out
:

476 ià((
c
->
x86_max_cÜes
 * 
smp_num_siblšgs
) > 1) {

477 
	`´štk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

478 
c
->
phys_´oc_id
);

479 
	`´štk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

480 
c
->
ıu_cÜe_id
);

483 
	}
}

485 
__ıuš™
 
	$g‘_ıu_v’dÜ
(
ıušfo_x86
 *
c
)

487 *
v
 = 
c
->
x86_v’dÜ_id
;

488 
´š‹d
;

489 
i
;

491 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

492 ià(!
ıu_devs
[
i
])

495 ià(!
	`¡rcmp
(
v
, 
ıu_devs
[
i
]->
c_id’t
[0]) ||

496 (
ıu_devs
[
i
]->
c_id’t
[1] &&

497 !
	`¡rcmp
(
v
, 
ıu_devs
[
i
]->
c_id’t
[1]))) {

499 
this_ıu
 = 
ıu_devs
[
i
];

500 
c
->
x86_v’dÜ
 = 
this_ıu
->
c_x86_v’dÜ
;

505 ià(!
´š‹d
) {

506 
´š‹d
++;

507 
	`´štk
(
KERN_ERR


508 "CPU: v’dÜ_id '%s' unknown, usšg g’”iøš™.\n", 
v
);

510 
	`´štk
(
KERN_ERR
 "CPU: Your system may be unstable.\n");

513 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

514 
this_ıu
 = &
deçuÉ_ıu
;

515 
	}
}

517 
__ıuš™
 
	$ıu_d‘eù
(
ıušfo_x86
 *
c
)

520 
	`ıuid
(0x00000000, (*)&
c
->
ıuid_Ëv–
,

521 (*)&
c
->
x86_v’dÜ_id
[0],

522 (*)&
c
->
x86_v’dÜ_id
[8],

523 (*)&
c
->
x86_v’dÜ_id
[4]);

525 
c
->
x86
 = 4;

527 ià(
c
->
ıuid_Ëv–
 >= 0x00000001) {

528 
u32
 
junk
, 
tfms
, 
ÿp0
, 
misc
;

530 
	`ıuid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ÿp0
);

531 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

532 
c
->
x86_mod–
 = (
tfms
 >> 4) & 0xf;

533 
c
->
x86_mask
 = 
tfms
 & 0xf;

535 ià(
c
->
x86
 == 0xf)

536 
c
->
x86
 +ğ(
tfms
 >> 20) & 0xff;

537 ià(
c
->
x86
 >= 0x6)

538 
c
->
x86_mod–
 +ğ((
tfms
 >> 16) & 0xf) << 4;

540 ià(
ÿp0
 & (1<<19)) {

541 
c
->
x86_şæush_size
 = ((
misc
 >> 8) & 0xff) * 8;

542 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
;

545 
	}
}

547 
__ıuš™
 
	$g‘_ıu_ÿp
(
ıušfo_x86
 *
c
)

549 
u32
 
tfms
, 
xlvl
;

550 
u32
 
ebx
;

553 ià(
c
->
ıuid_Ëv–
 >= 0x00000001) {

554 
u32
 
ÿ·b™y
, 
exÿp
;

556 
	`ıuid
(0x00000001, &
tfms
, &
ebx
, &
exÿp
, &
ÿ·b™y
);

557 
c
->
x86_ÿ·b™y
[0] = 
ÿ·b™y
;

558 
c
->
x86_ÿ·b™y
[4] = 
exÿp
;

562 
xlvl
 = 
	`ıuid_—x
(0x80000000);

563 
c
->
ex‹nded_ıuid_Ëv–
 = 
xlvl
;

565 ià((
xlvl
 & 0xffff0000) == 0x80000000) {

566 ià(
xlvl
 >= 0x80000001) {

567 
c
->
x86_ÿ·b™y
[1] = 
	`ıuid_edx
(0x80000001);

568 
c
->
x86_ÿ·b™y
[6] = 
	`ıuid_ecx
(0x80000001);

572 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000008) {

573 
u32
 
—x
 = 
	`ıuid_—x
(0x80000008);

575 
c
->
x86_vœt_b™s
 = (
—x
 >> 8) & 0xff;

576 
c
->
x86_phys_b™s
 = 
—x
 & 0xff;

578 #ifdeà
CONFIG_X86_32


579 ià(
	`ıu_has
(
c
, 
X86_FEATURE_PAE
è|| cpu_has(c, 
X86_FEATURE_PSE36
))

580 
c
->
x86_phys_b™s
 = 36;

583 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000007)

584 
c
->
x86_pow”
 = 
	`ıuid_edx
(0x80000007);

586 
	}
}

588 
__ıuš™
 
	$id’tify_ıu_w™hout_ıuid
(
ıušfo_x86
 *
c
)

590 #ifdeà
CONFIG_X86_32


591 
i
;

597 ià(
	`æag_is_chªg—bË_p
(
X86_EFLAGS_AC
))

598 
c
->
x86
 = 4;

600 
c
->
x86
 = 3;

602 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

603 ià(
ıu_devs
[
i
] && cpu_devs[i]->
c_id’tify
) {

604 
c
->
x86_v’dÜ_id
[0] = 0;

605 
ıu_devs
[
i
]->
	`c_id’tify
(
c
);

606 ià(
c
->
x86_v’dÜ_id
[0]) {

607 
	`g‘_ıu_v’dÜ
(
c
);

612 
	}
}

623 
__š™
 
	$—¾y_id’tify_ıu
(
ıušfo_x86
 *
c
)

625 #ifdeà
CONFIG_X86_64


626 
c
->
x86_şæush_size
 = 64;

627 
c
->
x86_phys_b™s
 = 36;

628 
c
->
x86_vœt_b™s
 = 48;

630 
c
->
x86_şæush_size
 = 32;

631 
c
->
x86_phys_b™s
 = 32;

632 
c
->
x86_vœt_b™s
 = 32;

634 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
;

636 
	`mem£t
(&
c
->
x86_ÿ·b™y
, 0,  c->x86_capability);

637 
c
->
ex‹nded_ıuid_Ëv–
 = 0;

639 ià(!
	`have_ıuid_p
())

640 
	`id’tify_ıu_w™hout_ıuid
(
c
);

643 ià(!
	`have_ıuid_p
())

646 
	`ıu_d‘eù
(
c
);

648 
	`g‘_ıu_v’dÜ
(
c
);

650 
	`g‘_ıu_ÿp
(
c
);

652 ià(
this_ıu
->
c_—¾y_š™
)

653 
this_ıu
->
	`c_—¾y_š™
(
c
);

655 #ifdeà
CONFIG_SMP


656 
c
->
ıu_šdex
 = 
boÙ_ıu_id
;

658 
	`f‹r_ıuid_ã©u»s
(
c
, 
çl£
);

659 
	}
}

661 
__š™
 
	$—¾y_ıu_š™
()

663 cÚ¡ 
ıu_dev
 *cÚ¡ *
cdev
;

664 
couÁ
 = 0;

666 
	`´štk
(
KERN_INFO
 "KERNEL supported cpus:\n");

667 
cdev
 = 
__x86_ıu_dev_¡¬t
; cdev < 
__x86_ıu_dev_’d
; cdev++) {

668 cÚ¡ 
ıu_dev
 *
ıudev
 = *
cdev
;

669 
j
;

671 ià(
couÁ
 >ğ
X86_VENDOR_NUM
)

673 
ıu_devs
[
couÁ
] = 
ıudev
;

674 
couÁ
++;

676 
j
 = 0; j < 2; j++) {

677 ià(!
ıudev
->
c_id’t
[
j
])

679 
	`´štk
(
KERN_INFO
 " % %s\n", 
ıudev
->
c_v’dÜ
,

680 
ıudev
->
c_id’t
[
j
]);

684 
	`—¾y_id’tify_ıu
(&
boÙ_ıu_d©a
);

685 
	}
}

695 
__ıuš™
 
	$d‘eù_nİl
(
ıušfo_x86
 *
c
)

697 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_NOPL
);

698 
	}
}

700 
__ıuš™
 
	$g’”ic_id’tify
(
ıušfo_x86
 *
c
)

702 
c
->
ex‹nded_ıuid_Ëv–
 = 0;

704 ià(!
	`have_ıuid_p
())

705 
	`id’tify_ıu_w™hout_ıuid
(
c
);

708 ià(!
	`have_ıuid_p
())

711 
	`ıu_d‘eù
(
c
);

713 
	`g‘_ıu_v’dÜ
(
c
);

715 
	`g‘_ıu_ÿp
(
c
);

717 ià(
c
->
ıuid_Ëv–
 >= 0x00000001) {

718 
c
->
š™Ÿl_­icid
 = (
	`ıuid_ebx
(1) >> 24) & 0xFF;

719 #ifdeà
CONFIG_X86_32


720 #ifdeà
CONFIG_X86_HT


721 
c
->
­icid
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 0);

723 
c
->
­icid
 = c->
š™Ÿl_­icid
;

727 #ifdeà
CONFIG_X86_HT


728 
c
->
phys_´oc_id
 = c->
š™Ÿl_­icid
;

732 
	`g‘_mod–_Çme
(
c
);

734 
	`š™_sÿ‰”ed_ıuid_ã©u»s
(
c
);

735 
	`d‘eù_nİl
(
c
);

736 
	}
}

741 
__ıuš™
 
	$id’tify_ıu
(
ıušfo_x86
 *
c
)

743 
i
;

745 
c
->
loİs_³r_jiffy
 =†oops_per_jiffy;

746 
c
->
x86_ÿche_size
 = -1;

747 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

748 
c
->
x86_mod–
 = c->
x86_mask
 = 0;

749 
c
->
x86_v’dÜ_id
[0] = '\0';

750 
c
->
x86_mod–_id
[0] = '\0';

751 
c
->
x86_max_cÜes
 = 1;

752 
c
->
x86_cÜeid_b™s
 = 0;

753 #ifdeà
CONFIG_X86_64


754 
c
->
x86_şæush_size
 = 64;

755 
c
->
x86_phys_b™s
 = 36;

756 
c
->
x86_vœt_b™s
 = 48;

758 
c
->
ıuid_Ëv–
 = -1;

759 
c
->
x86_şæush_size
 = 32;

760 
c
->
x86_phys_b™s
 = 32;

761 
c
->
x86_vœt_b™s
 = 32;

763 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
;

764 
	`mem£t
(&
c
->
x86_ÿ·b™y
, 0,  c->x86_capability);

766 
	`g’”ic_id’tify
(
c
);

768 ià(
this_ıu
->
c_id’tify
)

769 
this_ıu
->
	`c_id’tify
(
c
);

771 #ifdeà
CONFIG_X86_64


772 
c
->
­icid
 = 
­ic
->
	`phys_pkg_id
(c->
š™Ÿl_­icid
, 0);

785 ià(
this_ıu
->
c_š™
)

786 
this_ıu
->
	`c_š™
(
c
);

789 
	`squash_the_¡upid_£rŸl_numb”
(
c
);

797 
	`f‹r_ıuid_ã©u»s
(
c
, 
Œue
);

800 ià(!
c
->
x86_mod–_id
[0]) {

801 cÚ¡ *
p
;

802 
p
 = 
	`bË_lookup_mod–
(
c
);

803 ià(
p
)

804 
	`¡rıy
(
c
->
x86_mod–_id
, 
p
);

807 
	`¥rštf
(
c
->
x86_mod–_id
, "%02x/%02x",

808 
c
->
x86
, c->
x86_mod–
);

811 #ifdeà
CONFIG_X86_64


812 
	`d‘eù_ht
(
c
);

815 
	`š™_hy³rvisÜ
(
c
);

822 ià(
c
 !ğ&
boÙ_ıu_d©a
) {

824 
i
 = 0; i < 
NCAPINTS
; i++)

825 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[
i
] &ğ
c
->x86_capability[i];

829 
i
 = 0; i < 
NCAPINTS
; i++)

830 
c
->
x86_ÿ·b™y
[
i
] &ğ~
ş—»d_ıu_ÿps
[i];

832 #ifdeà
CONFIG_X86_MCE


834 
	`mcheck_š™
(
c
);

837 
	`£Ëù_idË_routše
(
c
);

839 #ià
	`defšed
(
CONFIG_NUMA
è&& defšed(
CONFIG_X86_64
)

840 
	`numa_add_ıu
(
	`smp_´oûssÜ_id
());

842 
	}
}

844 #ifdeà
CONFIG_X86_64


845 
	$vg‘ıu_£t_mode
()

847 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_RDTSCP
))

848 
vg‘ıu_mode
 = 
VGETCPU_RDTSCP
;

850 
vg‘ıu_mode
 = 
VGETCPU_LSL
;

851 
	}
}

854 
__š™
 
	$id’tify_boÙ_ıu
()

856 
	`id’tify_ıu
(&
boÙ_ıu_d©a
);

857 
	`š™_c1e_mask
();

858 #ifdeà
CONFIG_X86_32


859 
	`sy£Á”_£tup
();

860 
	`’abË_£p_ıu
();

862 
	`vg‘ıu_£t_mode
();

864 
	}
}

866 
__ıuš™
 
	$id’tify_£cÚd¬y_ıu
(
ıušfo_x86
 *
c
)

868 
	`BUG_ON
(
c
 =ğ&
boÙ_ıu_d©a
);

869 
	`id’tify_ıu
(
c
);

870 #ifdeà
CONFIG_X86_32


871 
	`’abË_£p_ıu
();

873 
	`mŒr_­_š™
();

874 
	}
}

876 
	sm¤_¿nge
 {

877 
	mmš
;

878 
	mmax
;

881 cÚ¡ 
m¤_¿nge
 
	gm¤_¿nge_¬¿y
[] 
	g__ıuš™cÚ¡
 = {

888 
__ıuš™
 
	$´št_ıu_m¤
()

890 
šdex_mš
, 
šdex_max
;

891 
šdex
;

892 
u64
 
v®
;

893 
i
;

895 
i
 = 0; i < 
	`ARRAY_SIZE
(
m¤_¿nge_¬¿y
); i++) {

896 
šdex_mš
 = 
m¤_¿nge_¬¿y
[
i
].
mš
;

897 
šdex_max
 = 
m¤_¿nge_¬¿y
[
i
].
max
;

899 
šdex
 = 
šdex_mš
; index < 
šdex_max
; index++) {

900 ià(
	`rdm¤l_amd_§ã
(
šdex
, &
v®
))

902 
	`´štk
(
KERN_INFO
 " MSR%08x: %016Îx\n", 
šdex
, 
v®
);

905 
	}
}

907 
show_m¤
 
	g__ıuš™d©a
;

909 
__š™
 
	$£tup_show_m¤
(*
¬g
)

911 
num
;

913 
	`g‘_İtiÚ
(&
¬g
, &
num
);

915 ià(
num
 > 0)

916 
show_m¤
 = 
num
;

918 
	}
}

919 
__£tup
("show_m¤=", 
£tup_show_m¤
);

921 
__š™
 
	$£tup_noşæush
(*
¬g
)

923 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_CLFLSH
);

925 
	}
}

926 
__£tup
("noşæush", 
£tup_noşæush
);

928 
__ıuš™
 
	$´št_ıu_šfo
(
ıušfo_x86
 *
c
)

930 cÚ¡ *
v’dÜ
 = 
NULL
;

932 ià(
c
->
x86_v’dÜ
 < 
X86_VENDOR_NUM
) {

933 
v’dÜ
 = 
this_ıu
->
c_v’dÜ
;

935 ià(
c
->
ıuid_Ëv–
 >= 0)

936 
v’dÜ
 = 
c
->
x86_v’dÜ_id
;

939 ià(
v’dÜ
 && !
	`¡r¡r
(
c
->
x86_mod–_id
, vendor))

940 
	`´štk
(
KERN_CONT
 "% ", 
v’dÜ
);

942 ià(
c
->
x86_mod–_id
[0])

943 
	`´štk
(
KERN_CONT
 "%s", 
c
->
x86_mod–_id
);

945 
	`´štk
(
KERN_CONT
 "%d86", 
c
->
x86
);

947 ià(
c
->
x86_mask
 || c->
ıuid_Ëv–
 >= 0)

948 
	`´štk
(
KERN_CONT
 " s‹µšg %02x\n", 
c
->
x86_mask
);

950 
	`´štk
(
KERN_CONT
 "\n");

952 #ifdeà
CONFIG_SMP


953 ià(
c
->
ıu_šdex
 < 
show_m¤
)

954 
	`´št_ıu_m¤
();

956 ià(
show_m¤
)

957 
	`´št_ıu_m¤
();

959 
	}
}

961 
__š™
 
	$£tup_di§bËıuid
(*
¬g
)

963 
b™
;

965 ià(
	`g‘_İtiÚ
(&
¬g
, &
b™
è&& b™ < 
NCAPINTS
*32)

966 
	`£tup_ş—r_ıu_ÿp
(
b™
);

971 
	}
}

972 
__£tup
("ş—rıuid=", 
£tup_di§bËıuid
);

974 #ifdeà
CONFIG_X86_64


975 
desc_±r
 
	gidt_desü
 = { 256 * 16 - 1, (è
idt_bË
 };

977 
	$DEFINE_PER_CPU_FIRST
(
œq_¡ack_uniÚ
,

978 
œq_¡ack_uniÚ
è
	`__®igÃd
(
PAGE_SIZE
);

980 
	`DEFINE_PER_CPU
(*, 
œq_¡ack_±r
) =

981 
	`š™_³r_ıu_v¬
(
œq_¡ack_uniÚ
.
œq_¡ack
è+ 
IRQ_STACK_SIZE
 - 64;

983 
	`DEFINE_PER_CPU
(, 
k”Ãl_¡ack
) =

984 ()&
š™_th»ad_uniÚ
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

985 
	`EXPORT_PER_CPU_SYMBOL
(
k”Ãl_¡ack
);

987 
	`DEFINE_PER_CPU
(, 
œq_couÁ
) = -1;

995 cÚ¡ 
exû±iÚ_¡ack_sizes
[
N_EXCEPTION_STACKS
] = {

996 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

997 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


998 
	}
};

1000 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
exû±iÚ_¡acks


1001 [(
N_EXCEPTION_STACKS
 - 1è* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
])

1002 
__®igÃd
(
PAGE_SIZE
);

1005 
	$sysÿÎ_š™
()

1012 
	`wrm¤l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1013 
	`wrm¤l
(
MSR_LSTAR
, 
sy¡em_ÿÎ
);

1014 
	`wrm¤l
(
MSR_CSTAR
, 
ignÜe_sy¤‘
);

1016 #ifdeà
CONFIG_IA32_EMULATION


1017 
	`sysÿÎ32_ıu_š™
();

1021 
	`wrm¤l
(
MSR_SYSCALL_MASK
,

1022 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1023 
	}
}

1025 
	gk”Ãl_eæags
;

1031 
DEFINE_PER_CPU
(
Üig_i¡
, orig_ist);

1035 #ifdeà
CONFIG_CC_STACKPROTECTOR


1036 
DEFINE_PER_CPU
(, 
¡ack_ÿÇry
);

1040 
±_»gs
 * 
__ıuš™
 
	$idË_»gs
(
±_»gs
 *
»gs
)

1042 
	`mem£t
(
»gs
, 0, (
±_»gs
));

1043 
»gs
->
fs
 = 
__KERNEL_PERCPU
;

1044 
»gs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1046  
»gs
;

1047 
	}
}

1053 
	$ş—r_®l_debug_»gs
()

1055 
i
;

1057 
i
 = 0; i < 8; i++) {

1059 ià((
i
 == 4) || (i == 5))

1062 
	`£t_debug»g
(0, 
i
);

1064 
	}
}

1073 #ifdeà
CONFIG_X86_64


1075 
__ıuš™
 
	$ıu_š™
()

1077 
Üig_i¡
 *orig_ist;

1078 
sk_¡ruù
 *
me
;

1079 
tss_¡ruù
 *
t
;

1080 
v
;

1081 
ıu
;

1082 
i
;

1084 
ıu
 = 
	`¡ack_smp_´oûssÜ_id
();

1085 
t
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

1086 
Üig_i¡
 = &
	`³r_ıu
(Üig_i¡, 
ıu
);

1088 #ifdeà
CONFIG_NUMA


1089 ià(
ıu
 !ğ0 && 
	`³rıu_»ad
(
node_numb”
) == 0 &&

1090 
	`ıu_to_node
(
ıu
è!ğ
NUMA_NO_NODE
)

1091 
	`³rıu_wr™e
(
node_numb”
, 
	`ıu_to_node
(
ıu
));

1094 
me
 = 
cu¼’t
;

1096 ià(
	`ıumask_‹¡_ªd_£t_ıu
(
ıu
, 
ıu_š™Ÿlized_mask
))

1097 
	`·nic
("CPU#%d‡Ì—dy in™Ÿlized!\n", 
ıu
);

1099 
	`´štk
(
KERN_INFO
 "In™Ÿlizšg CPU#%d\n", 
ıu
);

1101 
	`ş—r_š_ü4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1108 
	`sw™ch_to_Ãw_gdt
(
ıu
);

1109 
	`lßd£gm’t
(
fs
, 0);

1111 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
idt_desü
);

1113 
	`mem£t
(
me
->
th»ad
.
s_¬¿y
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1114 
	`sysÿÎ_š™
();

1116 
	`wrm¤l
(
MSR_FS_BASE
, 0);

1117 
	`wrm¤l
(
MSR_KERNEL_GS_BASE
, 0);

1118 
	`b¬r›r
();

1120 
	`check_eãr
();

1121 ià(
ıu
 != 0)

1122 
	`’abË_x2­ic
();

1127 ià(!
Üig_i¡
->
i¡
[0]) {

1128 *
e¡acks
 = 
	`³r_ıu
(
exû±iÚ_¡acks
, 
ıu
);

1130 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1131 
e¡acks
 +ğ
exû±iÚ_¡ack_sizes
[
v
];

1132 
Üig_i¡
->
i¡
[
v
] = 
t
->
x86_tss
.ist[v] =

1133 ()
e¡acks
;

1137 
t
->
x86_tss
.
io_b™m­_ba£
 = 
	`off£tof
(
tss_¡ruù
, 
io_b™m­
);

1143 
i
 = 0; i <ğ
IO_BITMAP_LONGS
; i++)

1144 
t
->
io_b™m­
[
i
] = ~0UL;

1146 
	`©omic_šc
(&
š™_mm
.
mm_couÁ
);

1147 
me
->
aùive_mm
 = &
š™_mm
;

1148 
	`BUG_ON
(
me
->
mm
);

1149 
	`’‹r_Ïzy_b
(&
š™_mm
, 
me
);

1151 
	`lßd_¥0
(
t
, &
cu¼’t
->
th»ad
);

1152 
	`£t_tss_desc
(
ıu
, 
t
);

1153 
	`lßd_TR_desc
();

1154 
	`lßd_LDT
(&
š™_mm
.
cÚ‹xt
);

1156 #ifdeà
CONFIG_KGDB


1163 ià(
kgdb_cÚÃùed
 && 
¬ch_kgdb_İs
.
cÜ»ù_hw_b»ak
)

1164 
¬ch_kgdb_İs
.
	`cÜ»ù_hw_b»ak
();

1167 
	`ş—r_®l_debug_»gs
();

1169 
	`åu_š™
();

1171 
	`¿w_loÿl_§ve_æags
(
k”Ãl_eæags
);

1173 ià(
	`is_uv_sy¡em
())

1174 
	`uv_ıu_š™
();

1175 
	}
}

1179 
__ıuš™
 
	$ıu_š™
()

1181 
ıu
 = 
	`smp_´oûssÜ_id
();

1182 
sk_¡ruù
 *
cu¼
 = 
cu¼’t
;

1183 
tss_¡ruù
 *
t
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

1184 
th»ad_¡ruù
 *
th»ad
 = &
cu¼
->thread;

1186 ià(
	`ıumask_‹¡_ªd_£t_ıu
(
ıu
, 
ıu_š™Ÿlized_mask
)) {

1187 
	`´štk
(
KERN_WARNING
 "CPU#%d‡Ì—dy in™Ÿlized!\n", 
ıu
);

1189 
	`loÿl_œq_’abË
();

1192 
	`´štk
(
KERN_INFO
 "In™Ÿlizšg CPU#%d\n", 
ıu
);

1194 ià(
ıu_has_vme
 || 
ıu_has_tsc
 || 
ıu_has_de
)

1195 
	`ş—r_š_ü4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1197 
	`lßd_idt
(&
idt_desü
);

1198 
	`sw™ch_to_Ãw_gdt
(
ıu
);

1203 
	`©omic_šc
(&
š™_mm
.
mm_couÁ
);

1204 
cu¼
->
aùive_mm
 = &
š™_mm
;

1205 
	`BUG_ON
(
cu¼
->
mm
);

1206 
	`’‹r_Ïzy_b
(&
š™_mm
, 
cu¼
);

1208 
	`lßd_¥0
(
t
, 
th»ad
);

1209 
	`£t_tss_desc
(
ıu
, 
t
);

1210 
	`lßd_TR_desc
();

1211 
	`lßd_LDT
(&
š™_mm
.
cÚ‹xt
);

1213 
t
->
x86_tss
.
io_b™m­_ba£
 = 
	`off£tof
(
tss_¡ruù
, 
io_b™m­
);

1215 #ifdeà
CONFIG_DOUBLEFAULT


1217 
	`__£t_tss_desc
(
ıu
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubËçuÉ_tss
);

1220 
	`ş—r_®l_debug_»gs
();

1225 ià(
ıu_has_x§ve
)

1226 
	`cu¼’t_th»ad_šfo
()->
¡©us
 = 
TS_XSAVE
;

1228 
	`cu¼’t_th»ad_šfo
()->
¡©us
 = 0;

1229 
	`ş—r_u£d_m©h
();

1230 
	`mxc¤_ã©u»_mask_š™
();

1235 ià(
	`smp_´oûssÜ_id
(è=ğ
boÙ_ıu_id
)

1236 
	`š™_th»ad_x¡©e
();

1238 
	`x§ve_š™
();

1239 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/moduË.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/smp.h
>

32 
	~<lšux/sched.h
>

33 
	~<lšux/ıuäeq.h
>

34 
	~<lšux/comp”.h
>

35 
	~<lšux/dmi.h
>

36 
	~<Œaû/pow”.h
>

38 
	~<lšux/aıi.h
>

39 
	~<lšux/io.h
>

40 
	~<lšux/d–ay.h
>

41 
	~<lšux/uacûss.h
>

43 
	~<aıi/´oûssÜ.h
>

45 
	~<asm/m¤.h
>

46 
	~<asm/´oûssÜ.h
>

47 
	~<asm/ıuã©u».h
>

49 
	#d´štk
(
msg
...è
	`ıuäeq_debug_´štk
(
CPUFREQ_DEBUG_DRIVER
, \

50 "aıi-ıuäeq", 
msg
)

	)

52 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

53 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

54 
MODULE_LICENSE
("GPL");

57 
	mUNDEFINED_CAPABLE
 = 0,

58 
	mSYSTEM_INTEL_MSR_CAPABLE
,

59 
	mSYSTEM_IO_CAPABLE
,

62 
	#INTEL_MSR_RANGE
 (0xffff)

	)

63 
	#CPUID_6_ECX_APERFMPERF_CAPABILITY
 (0x1)

	)

65 
	saıi_ıuäeq_d©a
 {

66 
aıi_´oûssÜ_³rfÜmªû
 *
	maıi_d©a
;

67 
ıuäeq_äequ’cy_bË
 *
	mäeq_bË
;

68 
	m»sume
;

69 
	mıu_ã©u»
;

72 
DEFINE_PER_CPU
(
aıi_ıuäeq_d©a
 *, 
drv_d©a
);

74 
	saıi_m¤_d©a
 {

75 
u64
 
	m§ved_­”f
, 
	m§ved_m³rf
;

78 
DEFINE_PER_CPU
(
aıi_m¤_d©a
, 
m¤_d©a
);

80 
DEFINE_TRACE
(
pow”_m¬k
);

83 
aıi_´oûssÜ_³rfÜmªû
 *
	gaıi_³rf_d©a
;

85 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
;

87 
	gaıi_p¡©e_¡riù
;

89 
	$check_e¡_ıu
(
ıuid
)

91 
ıušfo_x86
 *
ıu
 = &
	`ıu_d©a
(
ıuid
);

93 ià(
ıu
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 ||

94 !
	`ıu_has
(
ıu
, 
X86_FEATURE_EST
))

98 
	}
}

100 
	$exŒaù_io
(
u32
 
v®ue
, 
aıi_ıuäeq_d©a
 *
d©a
)

102 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

103 
i
;

105 
³rf
 = 
d©a
->
aıi_d©a
;

107 
i
 = 0; i < 
³rf
->
¡©e_couÁ
; i++) {

108 ià(
v®ue
 =ğ
³rf
->
¡©es
[
i
].
¡©us
)

109  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

112 
	}
}

114 
	$exŒaù_m¤
(
u32
 
m¤
, 
aıi_ıuäeq_d©a
 *
d©a
)

116 
i
;

117 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

119 
m¤
 &ğ
INTEL_MSR_RANGE
;

120 
³rf
 = 
d©a
->
aıi_d©a
;

122 
i
 = 0; 
d©a
->
äeq_bË
[i].
äequ’cy
 !ğ
CPUFREQ_TABLE_END
; i++) {

123 ià(
m¤
 =ğ
³rf
->
¡©es
[
d©a
->
äeq_bË
[
i
].
šdex
].
¡©us
)

124  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

126  
d©a
->
äeq_bË
[0].
äequ’cy
;

127 
	}
}

129 
	$exŒaù_äeq
(
u32
 
v®
, 
aıi_ıuäeq_d©a
 *
d©a
)

131 
d©a
->
ıu_ã©u»
) {

132 
SYSTEM_INTEL_MSR_CAPABLE
:

133  
	`exŒaù_m¤
(
v®
, 
d©a
);

134 
SYSTEM_IO_CAPABLE
:

135  
	`exŒaù_io
(
v®
, 
d©a
);

139 
	}
}

141 
	sm¤_addr
 {

142 
u32
 
	m»g
;

145 
	sio_addr
 {

146 
u16
 
	mpÜt
;

147 
u8
 
	mb™_width
;

150 
	sdrv_cmd
 {

151 
	mty³
;

152 cÚ¡ 
ıumask
 *
	mmask
;

154 
m¤_addr
 
	mm¤
;

155 
io_addr
 
	mio
;

156 } 
	maddr
;

157 
u32
 
	mv®
;

161 
	$do_drv_»ad
(*
_cmd
)

163 
drv_cmd
 *
cmd
 = 
_cmd
;

164 
u32
 
h
;

166 
cmd
->
ty³
) {

167 
SYSTEM_INTEL_MSR_CAPABLE
:

168 
	`rdm¤
(
cmd
->
addr
.
m¤
.
»g
, cmd->
v®
, 
h
);

170 
SYSTEM_IO_CAPABLE
:

171 
	`aıi_os_»ad_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

172 &
cmd
->
v®
,

173 (
u32
)
cmd
->
addr
.
io
.
b™_width
);

178 
	}
}

181 
	$do_drv_wr™e
(*
_cmd
)

183 
drv_cmd
 *
cmd
 = 
_cmd
;

184 
u32
 
lo
, 
hi
;

186 
cmd
->
ty³
) {

187 
SYSTEM_INTEL_MSR_CAPABLE
:

188 
	`rdm¤
(
cmd
->
addr
.
m¤
.
»g
, 
lo
, 
hi
);

189 
lo
 = (lØ& ~
INTEL_MSR_RANGE
è| (
cmd
->
v®
 & INTEL_MSR_RANGE);

190 
	`wrm¤
(
cmd
->
addr
.
m¤
.
»g
, 
lo
, 
hi
);

192 
SYSTEM_IO_CAPABLE
:

193 
	`aıi_os_wr™e_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

194 
cmd
->
v®
,

195 (
u32
)
cmd
->
addr
.
io
.
b™_width
);

200 
	}
}

202 
	$drv_»ad
(
drv_cmd
 *
cmd
)

204 
cmd
->
v®
 = 0;

206 
	`smp_ÿÎ_funùiÚ_sšgË
(
	`ıumask_ªy
(
cmd
->
mask
), 
do_drv_»ad
, cmd, 1);

207 
	}
}

209 
	$drv_wr™e
(
drv_cmd
 *
cmd
)

211 
this_ıu
;

213 
this_ıu
 = 
	`g‘_ıu
();

214 ià(
	`ıumask_‹¡_ıu
(
this_ıu
, 
cmd
->
mask
))

215 
	`do_drv_wr™e
(
cmd
);

216 
	`smp_ÿÎ_funùiÚ_mªy
(
cmd
->
mask
, 
do_drv_wr™e
, cmd, 1);

217 
	`put_ıu
();

218 
	}
}

220 
u32
 
	$g‘_cur_v®
(cÚ¡ 
ıumask
 *
mask
)

222 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

223 
drv_cmd
 
cmd
;

225 ià(
	`uÆik–y
(
	`ıumask_em±y
(
mask
)))

228 
	`³r_ıu
(
drv_d©a
, 
	`ıumask_fœ¡
(
mask
))->
ıu_ã©u»
) {

229 
SYSTEM_INTEL_MSR_CAPABLE
:

230 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

231 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_STATUS
;

233 
SYSTEM_IO_CAPABLE
:

234 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

235 
³rf
 = 
	`³r_ıu
(
drv_d©a
, 
	`ıumask_fœ¡
(
mask
))->
aıi_d©a
;

236 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

237 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

243 
cmd
.
mask
 = mask;

244 
	`drv_»ad
(&
cmd
);

246 
	`d´štk
("g‘_cur_v® = %u\n", 
cmd
.
v®
);

248  
cmd
.
v®
;

249 
	}
}

251 
	s³rf_·œ
 {

254 
u32
 
	mlo
;

255 
u32
 
	mhi
;

256 } 
	m¥l™
;

257 
u64
 
	mwhŞe
;

258 } 
	m­”f
, 
	mm³rf
;

262 
	$»ad_m—su»d_³rf_ùrs
(*
_cur
)

264 
³rf_·œ
 *
cur
 = 
_cur
;

266 
	`rdm¤
(
MSR_IA32_APERF
, 
cur
->
­”f
.
¥l™
.
lo
, cur->­”f.¥l™.
hi
);

267 
	`rdm¤
(
MSR_IA32_MPERF
, 
cur
->
m³rf
.
¥l™
.
lo
, cur->m³rf.¥l™.
hi
);

268 
	}
}

283 
	$g‘_m—su»d_³rf
(
ıuäeq_pŞicy
 *
pŞicy
,

284 
ıu
)

286 
³rf_·œ
 
»adš
, 
cur
;

287 
³rf_³rûÁ
;

288 
»tv®
;

290 ià(
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
»ad_m—su»d_³rf_ùrs
, &
»adš
, 1))

293 
cur
.
­”f
.
whŞe
 = 
»adš
.aperf.whole -

294 
	`³r_ıu
(
m¤_d©a
, 
ıu
).
§ved_­”f
;

295 
cur
.
m³rf
.
whŞe
 = 
»adš
.mperf.whole -

296 
	`³r_ıu
(
m¤_d©a
, 
ıu
).
§ved_m³rf
;

297 
	`³r_ıu
(
m¤_d©a
, 
ıu
).
§ved_­”f
 = 
»adš
.
­”f
.
whŞe
;

298 
	`³r_ıu
(
m¤_d©a
, 
ıu
).
§ved_m³rf
 = 
»adš
.
m³rf
.
whŞe
;

300 #ifdeà
__i386__


306 ià(
	`uÆik–y
(
cur
.
­”f
.
¥l™
.
hi
 || cur.
m³rf
.split.hi)) {

307 
shiá_couÁ
;

308 
u32
 
h
;

310 
h
 = 
	`max_t
(
u32
, 
cur
.
­”f
.
¥l™
.
hi
, cur.
m³rf
.split.hi);

311 
shiá_couÁ
 = 
	`æs
(
h
);

313 
cur
.
­”f
.
whŞe
 >>ğ
shiá_couÁ
;

314 
cur
.
m³rf
.
whŞe
 >>ğ
shiá_couÁ
;

317 ià((()(-1è/ 100è< 
cur
.
­”f
.
¥l™
.
lo
) {

318 
shiá_couÁ
 = 7;

319 
cur
.
­”f
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

320 
cur
.
m³rf
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

323 ià(
cur
.
­”f
.
¥l™
.
lo
 && cur.
m³rf
.split.lo)

324 
³rf_³rûÁ
 = (
cur
.
­”f
.
¥l™
.
lo
 * 100è/ cur.
m³rf
.split.lo;

326 
³rf_³rûÁ
 = 0;

329 ià(
	`uÆik–y
((()(-1è/ 100è< 
cur
.
­”f
.
whŞe
)) {

330 
shiá_couÁ
 = 7;

331 
cur
.
­”f
.
whŞe
 >>ğ
shiá_couÁ
;

332 
cur
.
m³rf
.
whŞe
 >>ğ
shiá_couÁ
;

335 ià(
cur
.
­”f
.
whŞe
 && cur.
m³rf
.whole)

336 
³rf_³rûÁ
 = (
cur
.
­”f
.
whŞe
 * 100è/ cur.
m³rf
.whole;

338 
³rf_³rûÁ
 = 0;

342 
»tv®
 = (
pŞicy
->
ıušfo
.
max_äeq
 * 
³rf_³rûÁ
) / 100;

344  
»tv®
;

345 
	}
}

347 
	$g‘_cur_äeq_Ú_ıu
(
ıu
)

349 
aıi_ıuäeq_d©a
 *
d©a
 = 
	`³r_ıu
(
drv_d©a
, 
ıu
);

350 
äeq
;

351 
ÿched_äeq
;

353 
	`d´štk
("g‘_cur_äeq_Ú_ıu (%d)\n", 
ıu
);

355 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

356 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

360 
ÿched_äeq
 = 
d©a
->
äeq_bË
[d©a->
aıi_d©a
->
¡©e
].
äequ’cy
;

361 
äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
	`ıumask_of
(
ıu
)), 
d©a
);

362 ià(
äeq
 !ğ
ÿched_äeq
) {

367 
d©a
->
»sume
 = 1;

370 
	`d´štk
("cu¸äeq = %u\n", 
äeq
);

372  
äeq
;

373 
	}
}

375 
	$check_äeqs
(cÚ¡ 
ıumask
 *
mask
, 
äeq
,

376 
aıi_ıuäeq_d©a
 *
d©a
)

378 
cur_äeq
;

379 
i
;

381 
i
 = 0; i < 100; i++) {

382 
cur_äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
mask
), 
d©a
);

383 ià(
cur_äeq
 =ğ
äeq
)

385 
	`ud–ay
(10);

388 
	}
}

390 
	$aıi_ıuäeq_rg‘
(
ıuäeq_pŞicy
 *
pŞicy
,

391 
rg‘_äeq
, 
»ÏtiÚ
)

393 
aıi_ıuäeq_d©a
 *
d©a
 = 
	`³r_ıu
(
drv_d©a
, 
pŞicy
->
ıu
);

394 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

395 
ıuäeq_äeqs
 
äeqs
;

396 
drv_cmd
 
cmd
;

397 
Ãxt_¡©e
 = 0;

398 
Ãxt_³rf_¡©e
 = 0;

399 
i
;

400 
»suÉ
 = 0;

401 
pow”_Œaû
 
™
;

403 
	`d´štk
("aıi_ıuäeq_rg‘ %d (%d)\n", 
rg‘_äeq
, 
pŞicy
->
ıu
);

405 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

406 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

407  -
ENODEV
;

410 
³rf
 = 
d©a
->
aıi_d©a
;

411 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_rg‘
(
pŞicy
,

412 
d©a
->
äeq_bË
,

413 
rg‘_äeq
,

414 
»ÏtiÚ
, &
Ãxt_¡©e
);

415 ià(
	`uÆik–y
(
»suÉ
)) {

416 
»suÉ
 = -
ENODEV
;

417 
out
;

420 
Ãxt_³rf_¡©e
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
šdex
;

421 ià(
³rf
->
¡©e
 =ğ
Ãxt_³rf_¡©e
) {

422 ià(
	`uÆik–y
(
d©a
->
»sume
)) {

423 
	`d´štk
("Called‡fter„esume,„esettingo P%d\n",

424 
Ãxt_³rf_¡©e
);

425 
d©a
->
»sume
 = 0;

427 
	`d´štk
("Already‡target state (P%d)\n",

428 
Ãxt_³rf_¡©e
);

429 
out
;

433 
	`Œaû_pow”_m¬k
(&
™
, 
POWER_PSTATE
, 
Ãxt_³rf_¡©e
);

435 
d©a
->
ıu_ã©u»
) {

436 
SYSTEM_INTEL_MSR_CAPABLE
:

437 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

438 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_CTL
;

439 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

441 
SYSTEM_IO_CAPABLE
:

442 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

443 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

444 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

445 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

448 
»suÉ
 = -
ENODEV
;

449 
out
;

453 ià(
pŞicy
->
sh¬ed_ty³
 !ğ
CPUFREQ_SHARED_TYPE_ANY
)

454 
cmd
.
mask
 = 
pŞicy
->
ıus
;

456 
cmd
.
mask
 = 
	`ıumask_of
(
pŞicy
->
ıu
);

458 
äeqs
.
Şd
 = 
³rf
->
¡©es
[³rf->
¡©e
].
cÜe_äequ’cy
 * 1000;

459 
äeqs
.
Ãw
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
äequ’cy
;

460 
	`fÜ_—ch_ıu
(
i
, 
cmd
.
mask
) {

461 
äeqs
.
ıu
 = 
i
;

462 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_PRECHANGE
);

465 
	`drv_wr™e
(&
cmd
);

467 ià(
aıi_p¡©e_¡riù
) {

468 ià(!
	`check_äeqs
(
cmd
.
mask
, 
äeqs
.
Ãw
, 
d©a
)) {

469 
	`d´štk
("acpi_cpufreq_target failed (%d)\n",

470 
pŞicy
->
ıu
);

471 
»suÉ
 = -
EAGAIN
;

472 
out
;

476 
	`fÜ_—ch_ıu
(
i
, 
cmd
.
mask
) {

477 
äeqs
.
ıu
 = 
i
;

478 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_POSTCHANGE
);

480 
³rf
->
¡©e
 = 
Ãxt_³rf_¡©e
;

482 
out
:

483  
»suÉ
;

484 
	}
}

486 
	$aıi_ıuäeq_v”ify
(
ıuäeq_pŞicy
 *
pŞicy
)

488 
aıi_ıuäeq_d©a
 *
d©a
 = 
	`³r_ıu
(
drv_d©a
, 
pŞicy
->
ıu
);

490 
	`d´štk
("acpi_cpufreq_verify\n");

492  
	`ıuäeq_äequ’cy_bË_v”ify
(
pŞicy
, 
d©a
->
äeq_bË
);

493 
	}
}

496 
	$aıi_ıuäeq_guess_äeq
(
aıi_ıuäeq_d©a
 *
d©a
, 
ıu
)

498 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
 = 
d©a
->
aıi_d©a
;

500 ià(
ıu_khz
) {

502 
i
;

503 
äeq
;

504 
äeqn
 = 
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

506 
i
 = 0; i < (
³rf
->
¡©e_couÁ
-1); i++) {

507 
äeq
 = 
äeqn
;

508 
äeqn
 = 
³rf
->
¡©es
[
i
+1].
cÜe_äequ’cy
 * 1000;

509 ià((2 * 
ıu_khz
è> (
äeqn
 + 
äeq
)) {

510 
³rf
->
¡©e
 = 
i
;

511  
äeq
;

514 
³rf
->
¡©e
 =…”f->
¡©e_couÁ
-1;

515  
äeqn
;

518 
³rf
->
¡©e
 = 0;

519  
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

521 
	}
}

523 
	$ä“_aıi_³rf_d©a
()

525 
i
;

528 
	`fÜ_—ch_possibË_ıu
(
i
)

529 
	`ä“_ıumask_v¬
(
	`³r_ıu_±r
(
aıi_³rf_d©a
, 
i
)

530 ->
sh¬ed_ıu_m­
);

531 
	`ä“_³rıu
(
aıi_³rf_d©a
);

532 
	}
}

542 
__š™
 
	$aıi_ıuäeq_—¾y_š™
()

544 
i
;

545 
	`d´štk
("acpi_cpufreq_early_init\n");

547 
aıi_³rf_d©a
 = 
	`®loc_³rıu
(
aıi_´oûssÜ_³rfÜmªû
);

548 ià(!
aıi_³rf_d©a
) {

549 
	`d´štk
("Memory‡llocationƒrror for‡cpi_perf_data.\n");

550  -
ENOMEM
;

552 
	`fÜ_—ch_possibË_ıu
(
i
) {

553 ià(!
	`z®loc_ıumask_v¬_node
(

554 &
	`³r_ıu_±r
(
aıi_³rf_d©a
, 
i
)->
sh¬ed_ıu_m­
,

555 
GFP_KERNEL
, 
	`ıu_to_node
(
i
))) {

558 
	`ä“_aıi_³rf_d©a
();

559  -
ENOMEM
;

564 
	`aıi_´oûssÜ_´”egi¡”_³rfÜmªû
(
aıi_³rf_d©a
);

566 
	}
}

568 #ifdeà
CONFIG_SMP


575 
	gbios_w™h_sw_ªy_bug
;

577 
	$sw_ªy_bug_found
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

579 
bios_w™h_sw_ªy_bug
 = 1;

581 
	}
}

583 cÚ¡ 
dmi_sy¡em_id
 
	gsw_ªy_bug_dmi_bË
[] = {

585 .
ÿÎback
 = 
sw_ªy_bug_found
,

586 .
	gid’t
 = "Supermicro Server X6DLP",

587 .
	gm©ches
 = {

588 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

589 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

590 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

597 
	$aıi_ıuäeq_ıu_š™
(
ıuäeq_pŞicy
 *
pŞicy
)

599 
i
;

600 
v®id_¡©es
 = 0;

601 
ıu
 = 
pŞicy
->cpu;

602 
aıi_ıuäeq_d©a
 *
d©a
;

603 
»suÉ
 = 0;

604 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
pŞicy
->
ıu
);

605 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

607 
	`d´štk
("acpi_cpufreq_cpu_init\n");

609 
d©a
 = 
	`kz®loc
((
aıi_ıuäeq_d©a
), 
GFP_KERNEL
);

610 ià(!
d©a
)

611  -
ENOMEM
;

613 
d©a
->
aıi_d©a
 = 
	`³r_ıu_±r
(
aıi_³rf_d©a
, 
ıu
);

614 
	`³r_ıu
(
drv_d©a
, 
ıu
èğ
d©a
;

616 ià(
	`ıu_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

617 
aıi_ıuäeq_driv”
.
æags
 |ğ
CPUFREQ_CONST_LOOPS
;

619 
»suÉ
 = 
	`aıi_´oûssÜ_»gi¡”_³rfÜmªû
(
d©a
->
aıi_d©a
, 
ıu
);

620 ià(
»suÉ
)

621 
”r_ä“
;

623 
³rf
 = 
d©a
->
aıi_d©a
;

624 
pŞicy
->
sh¬ed_ty³
 = 
³rf
->shared_type;

630 ià(
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ALL
 ||

631 
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ANY
) {

632 
	`ıumask_cİy
(
pŞicy
->
ıus
, 
³rf
->
sh¬ed_ıu_m­
);

634 
	`ıumask_cİy
(
pŞicy
->
»Ï‹d_ıus
, 
³rf
->
sh¬ed_ıu_m­
);

636 #ifdeà
CONFIG_SMP


637 
	`dmi_check_sy¡em
(
sw_ªy_bug_dmi_bË
);

638 ià(
bios_w™h_sw_ªy_bug
 && 
	`ıumask_weight
(
pŞicy
->
ıus
) == 1) {

639 
pŞicy
->
sh¬ed_ty³
 = 
CPUFREQ_SHARED_TYPE_ALL
;

640 
	`ıumask_cİy
(
pŞicy
->
ıus
, 
	`ıu_cÜe_mask
(
ıu
));

645 ià(
³rf
->
¡©e_couÁ
 <= 1) {

646 
	`d´štk
("No P-States\n");

647 
»suÉ
 = -
ENODEV
;

648 
”r_uÄeg
;

651 ià(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
 !ğ³rf->
¡©us_»gi¡”
.space_id) {

652 
»suÉ
 = -
ENODEV
;

653 
”r_uÄeg
;

656 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

657 
ACPI_ADR_SPACE_SYSTEM_IO
:

658 
	`d´štk
("SYSTEM IO‡ddr space\n");

659 
d©a
->
ıu_ã©u»
 = 
SYSTEM_IO_CAPABLE
;

661 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

662 
	`d´štk
("HARDWARE‡ddr space\n");

663 ià(!
	`check_e¡_ıu
(
ıu
)) {

664 
»suÉ
 = -
ENODEV
;

665 
”r_uÄeg
;

667 
d©a
->
ıu_ã©u»
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

670 
	`d´štk
("Unknown‡ddr space %d\n",

671 (
u32
è(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
));

672 
»suÉ
 = -
ENODEV
;

673 
”r_uÄeg
;

676 
d©a
->
äeq_bË
 = 
	`km®loc
((
ıuäeq_äequ’cy_bË
) *

677 (
³rf
->
¡©e_couÁ
+1), 
GFP_KERNEL
);

678 ià(!
d©a
->
äeq_bË
) {

679 
»suÉ
 = -
ENOMEM
;

680 
”r_uÄeg
;

684 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = 0;

685 
i
 = 0; i < 
³rf
->
¡©e_couÁ
; i++) {

686 ià((
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000) >

687 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
)

688 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 =

689 
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000;

693 ià(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
 =ğ
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

694 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 > 20 * 1000) {

695 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = 20 * 1000;

696 
	`´štk_Úû
(
KERN_INFO


701 
i
 = 0; i < 
³rf
->
¡©e_couÁ
; i++) {

702 ià(
i
 > 0 && 
³rf
->
¡©es
[i].
cÜe_äequ’cy
 >=

703 
d©a
->
äeq_bË
[
v®id_¡©es
-1].
äequ’cy
 / 1000)

706 
d©a
->
äeq_bË
[
v®id_¡©es
].
šdex
 = 
i
;

707 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 =

708 
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
 * 1000;

709 
v®id_¡©es
++;

711 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

712 
³rf
->
¡©e
 = 0;

714 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_ıušfo
(
pŞicy
, 
d©a
->
äeq_bË
);

715 ià(
»suÉ
)

716 
”r_äeqä“
;

718 ià(
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000 !ğ
pŞicy
->
ıušfo
.
max_äeq
)

719 
	`´štk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 is‚ot max freq\n");

721 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

722 
ACPI_ADR_SPACE_SYSTEM_IO
:

724 
pŞicy
->
cur
 = 
	`aıi_ıuäeq_guess_äeq
(
d©a
,…Şicy->
ıu
);

726 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

727 
aıi_ıuäeq_driv”
.
g‘
 = 
g‘_cur_äeq_Ú_ıu
;

728 
pŞicy
->
cur
 = 
	`g‘_cur_äeq_Ú_ıu
(
ıu
);

735 
	`aıi_´oûssÜ_nÙify_smm
(
THIS_MODULE
);

738 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 && c->
ıuid_Ëv–
 >= 6) {

739 
ecx
;

740 
ecx
 = 
	`ıuid_ecx
(6);

741 ià(
ecx
 & 
CPUID_6_ECX_APERFMPERF_CAPABILITY
)

742 
aıi_ıuäeq_driv”
.
g‘avg
 = 
g‘_m—su»d_³rf
;

745 
	`d´štk
("CPU%u - ACPI…”fÜmªû mªagem’ˆaùiv©ed.\n", 
ıu
);

746 
i
 = 0; i < 
³rf
->
¡©e_couÁ
; i++)

747 
	`d´štk
(" %cP%d: %d MHz, %d mW, %d uS\n",

748 (
i
 =ğ
³rf
->
¡©e
 ? '*' : ' '), i,

749 (
u32
è
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
,

750 (
u32
è
³rf
->
¡©es
[
i
].
pow”
,

751 (
u32
è
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
);

753 
	`ıuäeq_äequ’cy_bË_g‘_©Œ
(
d©a
->
äeq_bË
, 
pŞicy
->
ıu
);

759 
d©a
->
»sume
 = 1;

761  
»suÉ
;

763 
”r_äeqä“
:

764 
	`kä“
(
d©a
->
äeq_bË
);

765 
”r_uÄeg
:

766 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(
³rf
, 
ıu
);

767 
”r_ä“
:

768 
	`kä“
(
d©a
);

769 
	`³r_ıu
(
drv_d©a
, 
ıu
èğ
NULL
;

771  
»suÉ
;

772 
	}
}

774 
	$aıi_ıuäeq_ıu_ex™
(
ıuäeq_pŞicy
 *
pŞicy
)

776 
aıi_ıuäeq_d©a
 *
d©a
 = 
	`³r_ıu
(
drv_d©a
, 
pŞicy
->
ıu
);

778 
	`d´štk
("acpi_cpufreq_cpu_exit\n");

780 ià(
d©a
) {

781 
	`ıuäeq_äequ’cy_bË_put_©Œ
(
pŞicy
->
ıu
);

782 
	`³r_ıu
(
drv_d©a
, 
pŞicy
->
ıu
èğ
NULL
;

783 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(
d©a
->
aıi_d©a
,

784 
pŞicy
->
ıu
);

785 
	`kä“
(
d©a
);

789 
	}
}

791 
	$aıi_ıuäeq_»sume
(
ıuäeq_pŞicy
 *
pŞicy
)

793 
aıi_ıuäeq_d©a
 *
d©a
 = 
	`³r_ıu
(
drv_d©a
, 
pŞicy
->
ıu
);

795 
	`d´štk
("acpi_cpufreq_resume\n");

797 
d©a
->
»sume
 = 1;

800 
	}
}

802 
äeq_©Œ
 *
	gaıi_ıuäeq_©Œ
[] = {

803 &
ıuäeq_äeq_©Œ_sÿlšg_avaabË_äeqs
,

804 
NULL
,

807 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
 = {

808 .
v”ify
 = 
aıi_ıuäeq_v”ify
,

809 .
	grg‘
 = 
aıi_ıuäeq_rg‘
,

810 .
	gš™
 = 
aıi_ıuäeq_ıu_š™
,

811 .
	gex™
 = 
aıi_ıuäeq_ıu_ex™
,

812 .
	g»sume
 = 
aıi_ıuäeq_»sume
,

813 .
	gÇme
 = "acpi-cpufreq",

814 .
	gowÃr
 = 
THIS_MODULE
,

815 .
	g©Œ
 = 
aıi_ıuäeq_©Œ
,

818 
__š™
 
	$aıi_ıuäeq_š™
()

820 
»t
;

822 ià(
aıi_di§bËd
)

825 
	`d´štk
("acpi_cpufreq_init\n");

827 
»t
 = 
	`aıi_ıuäeq_—¾y_š™
();

828 ià(
»t
)

829  
»t
;

831 
»t
 = 
	`ıuäeq_»gi¡”_driv”
(&
aıi_ıuäeq_driv”
);

832 ià(
»t
)

833 
	`ä“_aıi_³rf_d©a
();

835  
»t
;

836 
	}
}

838 
__ex™
 
	$aıi_ıuäeq_ex™
()

840 
	`d´štk
("acpi_cpufreq_exit\n");

842 
	`ıuäeq_uÄegi¡”_driv”
(&
aıi_ıuäeq_driv”
);

844 
	`ä“_³rıu
(
aıi_³rf_d©a
);

845 
	}
}

847 
moduË_·¿m
(
aıi_p¡©e_¡riù
, 
ušt
, 0644);

848 
MODULE_PARM_DESC
(
aıi_p¡©e_¡riù
,

852 
Ï‹_š™ÿÎ
(
aıi_ıuäeq_š™
);

853 
moduË_ex™
(
aıi_ıuäeq_ex™
);

855 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<asm/´oûssÜ.h
>

25 
	~<asm/vmw¬e.h
>

26 
	~<asm/hy³rvisÜ.h
>

28 
šlše
 
__ıuš™


29 
	$d‘eù_hy³rvisÜ_v’dÜ
(
ıušfo_x86
 *
c
)

31 ià(
	`vmw¬e_¶©fÜm
()) {

32 
c
->
x86_hy³r_v’dÜ
 = 
X86_HYPER_VENDOR_VMWARE
;

34 
c
->
x86_hy³r_v’dÜ
 = 
X86_HYPER_VENDOR_NONE
;

36 
	}
}

38 
	$g‘_hy³rvisÜ_tsc_äeq
()

40 ià(
boÙ_ıu_d©a
.
x86_hy³r_v’dÜ
 =ğ
X86_HYPER_VENDOR_VMWARE
)

41  
	`vmw¬e_g‘_tsc_khz
();

43 
	}
}

45 
šlše
 
__ıuš™


46 
	$hy³rvisÜ_£t_ã©u»_b™s
(
ıušfo_x86
 *
c
)

48 ià(
boÙ_ıu_d©a
.
x86_hy³r_v’dÜ
 =ğ
X86_HYPER_VENDOR_VMWARE
) {

49 
	`vmw¬e_£t_ã©u»_b™s
(
c
);

52 
	}
}

54 
__ıuš™
 
	$š™_hy³rvisÜ
(
ıušfo_x86
 *
c
)

56 
	`d‘eù_hy³rvisÜ_v’dÜ
(
c
);

57 
	`hy³rvisÜ_£t_ã©u»_b™s
(
c
);

58 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/k”Ãl.h
>

4 
	~<lšux/¡ršg.h
>

5 
	~<lšux/b™İs.h
>

6 
	~<lšux/smp.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/th»ad_šfo.h
>

9 
	~<lšux/moduË.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/pgbË.h
>

13 
	~<asm/m¤.h
>

14 
	~<asm/uacûss.h
>

15 
	~<asm/ds.h
>

16 
	~<asm/bugs.h
>

17 
	~<asm/ıu.h
>

19 #ifdeà
CONFIG_X86_64


20 
	~<asm/tİŞogy.h
>

21 
	~<asm/numa_64.h
>

24 
	~"ıu.h
"

26 #ifdeà
CONFIG_X86_LOCAL_APIC


27 
	~<asm/mp¥ec.h
>

28 
	~<asm/­ic.h
>

31 
__ıuš™
 
	$—¾y_š™_š‹l
(
ıušfo_x86
 *
c
)

34 ià(
c
->
x86
 > 6 || (c->x86 =ğ6 && c->
x86_mod–
 >= 0xd)) {

35 
u64
 
misc_’abË
;

37 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
);

39 ià(
misc_’abË
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

40 
misc_’abË
 &ğ~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

41 
	`wrm¤l
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
);

42 
c
->
ıuid_Ëv–
 = 
	`ıuid_—x
(0);

46 ià((
c
->
x86
 =ğ0xà&& c->
x86_mod–
 >= 0x03) ||

47 (
c
->
x86
 =ğ0x6 && c->
x86_mod–
 >= 0x0e))

48 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

50 #ifdeà
CONFIG_X86_64


51 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_SYSENTER32
);

54 ià(
c
->
x86
 =ğ15 && c->
x86_ÿche_®ignm’t
 == 64)

55 
c
->
x86_ÿche_®ignm’t
 = 128;

59 ià(
c
->
x86
 =ğ0xF && c->
x86_mod–
 == 0x3

60 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

61 
c
->
x86_phys_b™s
 = 36;

70 ià(
c
->
x86_pow”
 & (1 << 8)) {

71 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

72 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

73 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

74 
sched_şock_¡abË
 = 1;

87 ià(
c
->
x86
 =ğ6 && c->
x86_mod–
 < 15)

88 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_PAT
);

89 
	}
}

91 #ifdeà
CONFIG_X86_32


98 
__ıuš™
 
	$µro_w™h_¿m_bug
()

101 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

102 
boÙ_ıu_d©a
.
x86
 == 6 &&

103 
boÙ_ıu_d©a
.
x86_mod–
 == 1 &&

104 
boÙ_ıu_d©a
.
x86_mask
 < 8) {

105 
	`´štk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. Takingƒvasive‡ction.\n");

109 
	}
}

111 #ifdeà
CONFIG_X86_F00F_BUG


112 
__ıuš™
 
	$Œ­_š™_f00f_bug
()

114 
	`__£t_fixm­
(
FIX_F00F_IDT
, 
	`__·
(&
idt_bË
), 
PAGE_KERNEL_RO
);

120 
idt_desü
.
add»ss
 = 
	`fix_to_vœt
(
FIX_F00F_IDT
);

121 
	`lßd_idt
(&
idt_desü
);

122 
	}
}

125 
__ıuš™
 
	$š‹l_smp_check
(
ıušfo_x86
 *
c
)

127 #ifdeà
CONFIG_SMP


129 ià(
c
->
ıu_šdex
 =ğ
boÙ_ıu_id
)

135 ià(
c
->
x86
 == 5 &&

136 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

137 
c
->
x86_mod–
 <= 3) {

141 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

145 
	}
}

147 
__ıuš™
 
	$š‹l_wÜk¬ounds
(
ıušfo_x86
 *
c
)

149 
lo
, 
hi
;

151 #ifdeà
CONFIG_X86_F00F_BUG


157 
c
->
f00f_bug
 = 0;

158 ià(!
	`·¿vœt_’abËd
(è&& 
c
->
x86
 == 5) {

159 
f00f_wÜk¬ound_’abËd
;

161 
c
->
f00f_bug
 = 1;

162 ià(!
f00f_wÜk¬ound_’abËd
) {

163 
	`Œ­_š™_f00f_bug
();

164 
	`´štk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundƒnabled.\n");

165 
f00f_wÜk¬ound_’abËd
 = 1;

174 ià((
c
->
x86
<<8 | c->
x86_mod–
<<4 | c->
x86_mask
) < 0x633)

175 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_SEP
);

181 ià((
c
->
x86
 =ğ15è&& (c->
x86_mod–
 =ğ1è&& (c->
x86_mask
 == 1)) {

182 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

183 ià((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

184 
	`´štk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

185 
	`´štk
 (
KERN_INFO
 "CPU: Disabling hardware…refetching (Errata 037)\n");

186 
lo
 |ğ
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

187 
	`wrm¤
 (
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

197 ià(
ıu_has_­ic
 && (
c
->
x86
<<8 | c->
x86_mod–
<<4) == 0x520 &&

198 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

199 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_11AP
);

202 #ifdeà
CONFIG_X86_INTEL_USERCOPY


206 
c
->
x86
) {

212 
mov¦_mask
.
mask
 = 7;

215 
mov¦_mask
.
mask
 = 7;

220 #ifdeà
CONFIG_X86_NUMAQ


221 
	`numaq_tsc_di§bË
();

224 
	`š‹l_smp_check
(
c
);

225 
	}
}

227 
__ıuš™
 
	$š‹l_wÜk¬ounds
(
ıušfo_x86
 *
c
)

229 
	}
}

232 
__ıuš™
 
	$¤©_d‘eù_node
()

234 #ià
	`defšed
(
CONFIG_NUMA
è&& defšed(
CONFIG_X86_64
)

235 
node
;

236 
ıu
 = 
	`smp_´oûssÜ_id
();

237 
­icid
 = 
	`h¬d_smp_´oûssÜ_id
();

241 
node
 = 
­icid_to_node
[
­icid
];

242 ià(
node
 =ğ
NUMA_NO_NODE
 || !
	`node_Úlše
(node))

243 
node
 = 
	`fœ¡_node
(
node_Úlše_m­
);

244 
	`numa_£t_node
(
ıu
, 
node
);

246 
	`´štk
(
KERN_INFO
 "CPU %d/0x%x -> Nod%d\n", 
ıu
, 
­icid
, 
node
);

248 
	}
}

253 
__ıuš™
 
	$š‹l_num_ıu_cÜes
(
ıušfo_x86
 *
c
)

255 
—x
, 
ebx
, 
ecx
, 
edx
;

257 ià(
c
->
ıuid_Ëv–
 < 4)

261 
	`ıuid_couÁ
(4, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

262 ià(
—x
 & 0x1f)

263  ((
—x
 >> 26) + 1);

266 
	}
}

268 
__ıuš™
 
	$d‘eù_vmx_vœtÿp
(
ıušfo_x86
 *
c
)

271 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

272 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

273 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

274 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

275 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

276 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

278 
u32
 
vmx_m¤_low
, 
vmx_m¤_high
, 
m¤_ùl
, 
m¤_ùl2
;

280 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

281 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_VNMI
);

282 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

283 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_EPT
);

284 
	`ş—r_ıu_ÿp
(
c
, 
X86_FEATURE_VPID
);

286 
	`rdm¤
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m¤_low
, 
vmx_m¤_high
);

287 
m¤_ùl
 = 
vmx_m¤_high
 | 
vmx_m¤_low
;

288 ià(
m¤_ùl
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

289 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

290 ià(
m¤_ùl
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

291 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_VNMI
);

292 ià(
m¤_ùl
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

293 
	`rdm¤
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

294 
vmx_m¤_low
, 
vmx_m¤_high
);

295 
m¤_ùl2
 = 
vmx_m¤_high
 | 
vmx_m¤_low
;

296 ià((
m¤_ùl2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

297 (
m¤_ùl
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

298 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

299 ià(
m¤_ùl2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

300 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_EPT
);

301 ià(
m¤_ùl2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

302 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_VPID
);

304 
	}
}

306 
__ıuš™
 
	$š™_š‹l
(
ıušfo_x86
 *
c
)

308 
l2
 = 0;

310 
	`—¾y_š™_š‹l
(
c
);

312 
	`š‹l_wÜk¬ounds
(
c
);

319 
	`d‘eù_ex‹nded_tİŞogy
(
c
);

321 
l2
 = 
	`š™_š‹l_ÿchešfo
(
c
);

322 ià(
c
->
ıuid_Ëv–
 > 9) {

323 
—x
 = 
	`ıuid_—x
(10);

325 ià((
—x
 & 0xff) && (((eax>>8) & 0xff) > 1))

326 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

329 ià(
ıu_has_xmm2
)

330 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

331 ià(
ıu_has_ds
) {

332 
l1
;

333 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

334 ià(!(
l1
 & (1<<11)))

335 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_BTS
);

336 ià(!(
l1
 & (1<<12)))

337 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_PEBS
);

338 
	`ds_š™_š‹l
(
c
);

341 ià(
c
->
x86
 =ğ6 && c->
x86_mod–
 =ğ29 && 
ıu_has_şæush
)

342 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

344 #ifdeà
CONFIG_X86_64


345 ià(
c
->
x86
 == 15)

346 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
 * 2;

347 ià(
c
->
x86
 == 6)

348 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_REP_GOOD
);

355 ià(
c
->
x86
 == 6) {

356 *
p
 = 
NULL
;

358 
c
->
x86_mod–
) {

360 ià(
c
->
x86_mask
 == 0) {

361 ià(
l2
 == 0)

362 
p
 = "Celeron (Covington)";

363 ià(
l2
 == 256)

364 
p
 = "Mobile Pentium II (Dixon)";

369 ià(
l2
 == 128)

370 
p
 = "Celeron (Mendocino)";

371 ià(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

372 
p
 = "Celeron-A";

376 ià(
l2
 == 128)

377 
p
 = "Celeron (Coppermine)";

381 ià(
p
)

382 
	`¡rıy
(
c
->
x86_mod–_id
, 
p
);

385 ià(
c
->
x86
 == 15)

386 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_P4
);

387 ià(
c
->
x86
 == 6)

388 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_P3
);

391 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

396 
c
->
x86_max_cÜes
 = 
	`š‹l_num_ıu_cÜes
(c);

397 #ifdeà
CONFIG_X86_32


398 
	`d‘eù_ht
(
c
);

403 
	`¤©_d‘eù_node
();

405 ià(
	`ıu_has
(
c
, 
X86_FEATURE_VMX
))

406 
	`d‘eù_vmx_vœtÿp
(
c
);

407 
	}
}

409 #ifdeà
CONFIG_X86_32


410 
__ıuš™
 
	$š‹l_size_ÿche
(
ıušfo_x86
 *
c
, 
size
)

418 ià((
c
->
x86
 =ğ6è&& (c->
x86_mod–
 =ğ11è&& (
size
 == 0))

419 
size
 = 256;

420  
size
;

421 
	}
}

424 cÚ¡ 
ıu_dev
 
__ıuš™cÚ¡
 
	gš‹l_ıu_dev
 = {

425 .
c_v’dÜ
 = "Intel",

426 .
	gc_id’t
 = { "GenuineIntel" },

427 #ifdeà
CONFIG_X86_32


428 .
	gc_mod–s
 = {

429 { .
v’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 4, .
	gmod–_Çmes
 =

442 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 5, .
	gmod–_Çmes
 =

453 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 6, .
	gmod–_Çmes
 =

467 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 15, .
	gmod–_Çmes
 =

477 .
	gc_size_ÿche
 = 
š‹l_size_ÿche
,

479 .
	gc_—¾y_š™
 = 
—¾y_š™_š‹l
,

480 .
	gc_š™
 = 
š™_š‹l
,

481 .
	gc_x86_v’dÜ
 = 
X86_VENDOR_INTEL
,

484 
ıu_dev_»gi¡”
(
š‹l_ıu_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<lšux/š™.h
>

11 
	~<lšux/¦ab.h
>

12 
	~<lšux/deviû.h
>

13 
	~<lšux/comp”.h
>

14 
	~<lšux/ıu.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/pci.h
>

18 
	~<asm/´oûssÜ.h
>

19 
	~<asm/smp.h
>

21 
	#LVL_1_INST
 1

	)

22 
	#LVL_1_DATA
 2

	)

23 
	#LVL_2
 3

	)

24 
	#LVL_3
 4

	)

25 
	#LVL_TRACE
 5

	)

27 
	s_ÿche_bË


29 
	mdesütÜ
;

30 
	mÿche_ty³
;

31 
	msize
;

35 cÚ¡ 
_ÿche_bË
 
__ıuš™cÚ¡
 
	gÿche_bË
[] =

37 { 0x06, 
LVL_1_INST
, 8 },

38 { 0x08, 
LVL_1_INST
, 16 },

39 { 0x09, 
LVL_1_INST
, 32 },

40 { 0x0a, 
LVL_1_DATA
, 8 },

41 { 0x0c, 
LVL_1_DATA
, 16 },

42 { 0x0d, 
LVL_1_DATA
, 16 },

43 { 0x21, 
LVL_2
, 256 },

44 { 0x22, 
LVL_3
, 512 },

45 { 0x23, 
LVL_3
, 1024 },

46 { 0x25, 
LVL_3
, 2048 },

47 { 0x29, 
LVL_3
, 4096 },

48 { 0x2c, 
LVL_1_DATA
, 32 },

49 { 0x30, 
LVL_1_INST
, 32 },

50 { 0x39, 
LVL_2
, 128 },

51 { 0x3a, 
LVL_2
, 192 },

52 { 0x3b, 
LVL_2
, 128 },

53 { 0x3c, 
LVL_2
, 256 },

54 { 0x3d, 
LVL_2
, 384 },

55 { 0x3e, 
LVL_2
, 512 },

56 { 0x3f, 
LVL_2
, 256 },

57 { 0x41, 
LVL_2
, 128 },

58 { 0x42, 
LVL_2
, 256 },

59 { 0x43, 
LVL_2
, 512 },

60 { 0x44, 
LVL_2
, 1024 },

61 { 0x45, 
LVL_2
, 2048 },

62 { 0x46, 
LVL_3
, 4096 },

63 { 0x47, 
LVL_3
, 8192 },

64 { 0x49, 
LVL_3
, 4096 },

65 { 0x4a, 
LVL_3
, 6144 },

66 { 0x4b, 
LVL_3
, 8192 },

67 { 0x4c, 
LVL_3
, 12288 },

68 { 0x4d, 
LVL_3
, 16384 },

69 { 0x4e, 
LVL_2
, 6144 },

70 { 0x60, 
LVL_1_DATA
, 16 },

71 { 0x66, 
LVL_1_DATA
, 8 },

72 { 0x67, 
LVL_1_DATA
, 16 },

73 { 0x68, 
LVL_1_DATA
, 32 },

74 { 0x70, 
LVL_TRACE
, 12 },

75 { 0x71, 
LVL_TRACE
, 16 },

76 { 0x72, 
LVL_TRACE
, 32 },

77 { 0x73, 
LVL_TRACE
, 64 },

78 { 0x78, 
LVL_2
, 1024 },

79 { 0x79, 
LVL_2
, 128 },

80 { 0x7a, 
LVL_2
, 256 },

81 { 0x7b, 
LVL_2
, 512 },

82 { 0x7c, 
LVL_2
, 1024 },

83 { 0x7d, 
LVL_2
, 2048 },

84 { 0x7f, 
LVL_2
, 512 },

85 { 0x82, 
LVL_2
, 256 },

86 { 0x83, 
LVL_2
, 512 },

87 { 0x84, 
LVL_2
, 1024 },

88 { 0x85, 
LVL_2
, 2048 },

89 { 0x86, 
LVL_2
, 512 },

90 { 0x87, 
LVL_2
, 1024 },

91 { 0xd0, 
LVL_3
, 512 },

92 { 0xd1, 
LVL_3
, 1024 },

93 { 0xd2, 
LVL_3
, 2048 },

94 { 0xd6, 
LVL_3
, 1024 },

95 { 0xd7, 
LVL_3
, 2038 },

96 { 0xd8, 
LVL_3
, 4096 },

97 { 0xdc, 
LVL_3
, 2048 },

98 { 0xdd, 
LVL_3
, 4096 },

99 { 0xde, 
LVL_3
, 8192 },

100 { 0xe2, 
LVL_3
, 2048 },

101 { 0xe3, 
LVL_3
, 4096 },

102 { 0xe4, 
LVL_3
, 8192 },

107 
	e_ÿche_ty³


109 
	mCACHE_TYPE_NULL
 = 0,

110 
	mCACHE_TYPE_DATA
 = 1,

111 
	mCACHE_TYPE_INST
 = 2,

112 
	mCACHE_TYPE_UNIFIED
 = 3

115 
	u_ıuid4_Ëaf_—x
 {

117 
_ÿche_ty³
 
	mty³
:5;

118 
	mËv–
:3;

119 
	mis_£lf_š™Ÿlizšg
:1;

120 
	mis_fuÎy_assocŸtive
:1;

121 
	m»£rved
:4;

122 
	mnum_th»ads_sh¬šg
:12;

123 
	mnum_cÜes_Ú_d›
:6;

124 } 
	m¥l™
;

125 
u32
 
	mfuÎ
;

128 
	u_ıuid4_Ëaf_ebx
 {

130 
	mcoh”’cy_lše_size
:12;

131 
	mphysiÿl_lše_·¹™iÚ
:10;

132 
	mways_of_assocŸtiv™y
:10;

133 } 
	m¥l™
;

134 
u32
 
	mfuÎ
;

137 
	u_ıuid4_Ëaf_ecx
 {

139 
	mnumb”_of_£ts
:32;

140 } 
	m¥l™
;

141 
u32
 
	mfuÎ
;

144 
	s_ıuid4_šfo
 {

145 
_ıuid4_Ëaf_—x
 
	m—x
;

146 
_ıuid4_Ëaf_ebx
 
	mebx
;

147 
_ıuid4_Ëaf_ecx
 
	mecx
;

148 
	msize
;

149 
	mÿn_di§bË
;

150 
DECLARE_BITMAP
(
sh¬ed_ıu_m­
, 
NR_CPUS
);

154 
	s_ıuid4_šfo_»gs
 {

155 
_ıuid4_Ëaf_—x
 
	m—x
;

156 
_ıuid4_Ëaf_ebx
 
	mebx
;

157 
_ıuid4_Ëaf_ecx
 
	mecx
;

158 
	msize
;

159 
	mÿn_di§bË
;

162 #ià
defšed
(
CONFIG_PCI
è&& defšed(
CONFIG_SYSFS
)

163 
pci_deviû_id
 
	gk8_nb_id
[] = {

164 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 0x1103) },

165 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 0x1203) },

170 
	gnum_ÿche_Ëaves
;

178 
	ul1_ÿche
 {

180 
	mlše_size
 : 8;

181 
	mlšes_³r_g
 : 8;

182 
	massoc
 : 8;

183 
	msize_š_kb
 : 8;

185 
	mv®
;

188 
	ul2_ÿche
 {

190 
	mlše_size
 : 8;

191 
	mlšes_³r_g
 : 4;

192 
	massoc
 : 4;

193 
	msize_š_kb
 : 16;

195 
	mv®
;

198 
	ul3_ÿche
 {

200 
	mlše_size
 : 8;

201 
	mlšes_³r_g
 : 4;

202 
	massoc
 : 4;

203 
	m»s
 : 2;

204 
	msize_’coded
 : 14;

206 
	mv®
;

209 cÚ¡ 
__ıuš™cÚ¡
 
	gassocs
[] = {

216 cÚ¡ 
__ıuš™cÚ¡
 
	gËv–s
[] = { 1, 1, 2, 3 };

217 cÚ¡ 
__ıuš™cÚ¡
 
	gty³s
[] = { 1, 2, 3, 3 };

219 
__ıuš™


220 
	$amd_ıuid4
(
Ëaf
, 
_ıuid4_Ëaf_—x
 *
—x
,

221 
_ıuid4_Ëaf_ebx
 *
ebx
,

222 
_ıuid4_Ëaf_ecx
 *
ecx
)

224 
dummy
;

225 
lše_size
, 
lšes_³r_g
, 
assoc
, 
size_š_kb
;

226 
l1_ÿche
 
l1i
, 
l1d
;

227 
l2_ÿche
 
l2
;

228 
l3_ÿche
 
l3
;

229 
l1_ÿche
 *
l1
 = &
l1d
;

231 
—x
->
fuÎ
 = 0;

232 
ebx
->
fuÎ
 = 0;

233 
ecx
->
fuÎ
 = 0;

235 
	`ıuid
(0x80000005, &
dummy
, &dummy, &
l1d
.
v®
, &
l1i
.val);

236 
	`ıuid
(0x80000006, &
dummy
, &dummy, &
l2
.
v®
, &
l3
.val);

238 
Ëaf
) {

240 
l1
 = &
l1i
;

242 ià(!
l1
->
v®
)

244 
assoc
 = 
l1
->assoc;

245 
lše_size
 = 
l1
->line_size;

246 
lšes_³r_g
 = 
l1
->lines_per_tag;

247 
size_š_kb
 = 
l1
->size_in_kb;

250 ià(!
l2
.
v®
)

252 
assoc
 = 
l2
.assoc;

253 
lše_size
 = 
l2
.line_size;

254 
lšes_³r_g
 = 
l2
.lines_per_tag;

256 
size_š_kb
 = 
cu¼’t_ıu_d©a
.
x86_ÿche_size
;

259 ià(!
l3
.
v®
)

261 
assoc
 = 
l3
.assoc;

262 
lše_size
 = 
l3
.line_size;

263 
lšes_³r_g
 = 
l3
.lines_per_tag;

264 
size_š_kb
 = 
l3
.
size_’coded
 * 512;

270 
—x
->
¥l™
.
is_£lf_š™Ÿlizšg
 = 1;

271 
—x
->
¥l™
.
ty³
 = 
ty³s
[
Ëaf
];

272 
—x
->
¥l™
.
Ëv–
 = 
Ëv–s
[
Ëaf
];

273 ià(
Ëaf
 == 3)

274 
—x
->
¥l™
.
num_th»ads_sh¬šg
 = 
cu¼’t_ıu_d©a
.
x86_max_cÜes
 - 1;

276 
—x
->
¥l™
.
num_th»ads_sh¬šg
 = 0;

277 
—x
->
¥l™
.
num_cÜes_Ú_d›
 = 
cu¼’t_ıu_d©a
.
x86_max_cÜes
 - 1;

280 ià(
assoc
 == 0xf)

281 
—x
->
¥l™
.
is_fuÎy_assocŸtive
 = 1;

282 
ebx
->
¥l™
.
coh”’cy_lše_size
 = 
lše_size
 - 1;

283 
ebx
->
¥l™
.
ways_of_assocŸtiv™y
 = 
assocs
[
assoc
] - 1;

284 
ebx
->
¥l™
.
physiÿl_lše_·¹™iÚ
 = 
lšes_³r_g
 - 1;

285 
ecx
->
¥l™
.
numb”_of_£ts
 = (
size_š_kb
 * 1024è/ 
lše_size
 /

286 (
ebx
->
¥l™
.
ways_of_assocŸtiv™y
 + 1) - 1;

287 
	}
}

289 
__ıuš™


290 
	$amd_check_l3_di§bË
(
šdex
, 
_ıuid4_šfo_»gs
 *
this_Ëaf
)

292 ià(
šdex
 < 3)

294 
this_Ëaf
->
ÿn_di§bË
 = 1;

295 
	}
}

298 
__ıuš™
 
	$ıuid4_ÿche_lookup_»gs
(
šdex
,

299 
_ıuid4_šfo_»gs
 *
this_Ëaf
)

301 
_ıuid4_Ëaf_—x
 
—x
;

302 
_ıuid4_Ëaf_ebx
 
ebx
;

303 
_ıuid4_Ëaf_ecx
 
ecx
;

304 
edx
;

306 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
) {

307 
	`amd_ıuid4
(
šdex
, &
—x
, &
ebx
, &
ecx
);

308 ià(
boÙ_ıu_d©a
.
x86
 >= 0x10)

309 
	`amd_check_l3_di§bË
(
šdex
, 
this_Ëaf
);

311 
	`ıuid_couÁ
(4, 
šdex
, &
—x
.
fuÎ
, &
ebx
.fuÎ, &
ecx
.fuÎ, &
edx
);

314 ià(
—x
.
¥l™
.
ty³
 =ğ
CACHE_TYPE_NULL
)

315  -
EIO
;

317 
this_Ëaf
->
—x
 =ƒax;

318 
this_Ëaf
->
ebx
 =ƒbx;

319 
this_Ëaf
->
ecx
 =ƒcx;

320 
this_Ëaf
->
size
 = (
ecx
.
¥l™
.
numb”_of_£ts
 + 1) *

321 (
ebx
.
¥l™
.
coh”’cy_lše_size
 + 1) *

322 (
ebx
.
¥l™
.
physiÿl_lše_·¹™iÚ
 + 1) *

323 (
ebx
.
¥l™
.
ways_of_assocŸtiv™y
 + 1);

325 
	}
}

327 
__ıuš™
 
	$fšd_num_ÿche_Ëaves
()

329 
—x
, 
ebx
, 
ecx
, 
edx
;

330 
_ıuid4_Ëaf_—x
 
ÿche_—x
;

331 
i
 = -1;

334 ++
i
;

336 
	`ıuid_couÁ
(4, 
i
, &
—x
, &
ebx
, &
ecx
, &
edx
);

337 
ÿche_—x
.
fuÎ
 = 
—x
;

338 } 
ÿche_—x
.
¥l™
.
ty³
 !ğ
CACHE_TYPE_NULL
);

339  
i
;

340 
	}
}

342 
__ıuš™
 
	$š™_š‹l_ÿchešfo
(
ıušfo_x86
 *
c
)

344 
Œaû
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

345 
Ãw_l1d
 = 0, 
Ãw_l1i
 = 0;

346 
Ãw_l2
 = 0, 
Ãw_l3
 = 0, 
i
;

347 
l2_id
 = 0, 
l3_id
 = 0, 
num_th»ads_sh¬šg
, 
šdex_msb
;

348 #ifdeà
CONFIG_X86_HT


349 
ıu
 = 
c
->
ıu_šdex
;

352 ià(
c
->
ıuid_Ëv–
 > 3) {

353 
is_š™Ÿlized
;

355 ià(
is_š™Ÿlized
 == 0) {

357 
num_ÿche_Ëaves
 = 
	`fšd_num_ÿche_Ëaves
();

358 
is_š™Ÿlized
++;

365 
i
 = 0; i < 
num_ÿche_Ëaves
; i++) {

366 
_ıuid4_šfo_»gs
 
this_Ëaf
;

367 
»tv®
;

369 
»tv®
 = 
	`ıuid4_ÿche_lookup_»gs
(
i
, &
this_Ëaf
);

370 ià(
»tv®
 >= 0) {

371 
this_Ëaf
.
—x
.
¥l™
.
Ëv–
) {

373 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

374 
CACHE_TYPE_DATA
)

375 
Ãw_l1d
 = 
this_Ëaf
.
size
/1024;

376 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

377 
CACHE_TYPE_INST
)

378 
Ãw_l1i
 = 
this_Ëaf
.
size
/1024;

381 
Ãw_l2
 = 
this_Ëaf
.
size
/1024;

382 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

383 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

384 
l2_id
 = 
c
->
­icid
 >> 
šdex_msb
;

387 
Ãw_l3
 = 
this_Ëaf
.
size
/1024;

388 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

389 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

390 
l3_id
 = 
c
->
­icid
 >> 
šdex_msb
;

402 ià((
num_ÿche_Ëaves
 =ğ0 || 
c
->
x86
 =ğ15è&& c->
ıuid_Ëv–
 > 1) {

404 
j
, 
n
;

405 
»gs
[4];

406 *
dp
 = (*)
»gs
;

407 
Úly_Œaû
 = 0;

409 ià(
num_ÿche_Ëaves
 !ğ0 && 
c
->
x86
 == 15)

410 
Úly_Œaû
 = 1;

413 
n
 = 
	`ıuid_—x
(2) & 0xFF;

415  
i
 = 0 ; i < 
n
 ; i++ ) {

416 
	`ıuid
(2, &
»gs
[0], &regs[1], &regs[2], &regs[3]);

419  
j
 = 0 ; j < 3 ; j++ ) {

420 ià(
»gs
[
j
] & (1 << 31))„egs[j] = 0;

424  
j
 = 1 ; j < 16 ; j++ ) {

425 
des
 = 
dp
[
j
];

426 
k
 = 0;

429 
ÿche_bË
[
k
].
desütÜ
 != 0)

431 ià(
ÿche_bË
[
k
].
desütÜ
 =ğ
des
) {

432 ià(
Úly_Œaû
 && 
ÿche_bË
[
k
].
ÿche_ty³
 !ğ
LVL_TRACE
)

434 
ÿche_bË
[
k
].
ÿche_ty³
) {

435 
LVL_1_INST
:

436 
l1i
 +ğ
ÿche_bË
[
k
].
size
;

438 
LVL_1_DATA
:

439 
l1d
 +ğ
ÿche_bË
[
k
].
size
;

441 
LVL_2
:

442 
l2
 +ğ
ÿche_bË
[
k
].
size
;

444 
LVL_3
:

445 
l3
 +ğ
ÿche_bË
[
k
].
size
;

447 
LVL_TRACE
:

448 
Œaû
 +ğ
ÿche_bË
[
k
].
size
;

455 
k
++;

461 ià(
Ãw_l1d
)

462 
l1d
 = 
Ãw_l1d
;

464 ià(
Ãw_l1i
)

465 
l1i
 = 
Ãw_l1i
;

467 ià(
Ãw_l2
) {

468 
l2
 = 
Ãw_l2
;

469 #ifdeà
CONFIG_X86_HT


470 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
èğ
l2_id
;

474 ià(
Ãw_l3
) {

475 
l3
 = 
Ãw_l3
;

476 #ifdeà
CONFIG_X86_HT


477 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
èğ
l3_id
;

481 ià(
Œaû
)

482 
	`´štk
 (
KERN_INFO
 "CPU: T¿û cache: %dK uİs", 
Œaû
);

483 iàĞ
l1i
 )

484 
	`´štk
 (
KERN_INFO
 "CPU: L1 I cache: %dK", 
l1i
);

486 ià(
l1d
)

487 
	`´štk
(", L1 D cache: %dK\n", 
l1d
);

489 
	`´štk
("\n");

491 ià(
l2
)

492 
	`´štk
(
KERN_INFO
 "CPU: L2 cache: %dK\n", 
l2
);

494 ià(
l3
)

495 
	`´štk
(
KERN_INFO
 "CPU: L3 cache: %dK\n", 
l3
);

497 
c
->
x86_ÿche_size
 = 
l3
 ?†3 : (
l2
 ?†2 : (
l1i
+
l1d
));

499  
l2
;

500 
	}
}

502 #ifdeà
CONFIG_SYSFS


505 
DEFINE_PER_CPU
(
_ıuid4_šfo
 *, 
ıuid4_šfo
);

506 
	#CPUID4_INFO_IDX
(
x
, 
y
è(&((
	`³r_ıu
(
ıuid4_šfo
, x))[y]))

	)

508 #ifdeà
CONFIG_SMP


509 
__ıuš™
 
	$ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
šdex
)

511 
_ıuid4_šfo
 *
this_Ëaf
, *
siblšg_Ëaf
;

512 
num_th»ads_sh¬šg
;

513 
šdex_msb
, 
i
;

514 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

516 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
šdex
);

517 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
->
—x
.
¥l™
.num_threads_sharing;

519 ià(
num_th»ads_sh¬šg
 == 1)

520 
	`ıumask_£t_ıu
(
ıu
, 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
));

522 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

524 
	`fÜ_—ch_Úlše_ıu
(
i
) {

525 ià(
	`ıu_d©a
(
i
).
­icid
 >> 
šdex_msb
 ==

526 
c
->
­icid
 >> 
šdex_msb
) {

527 
	`ıumask_£t_ıu
(
i
,

528 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
));

529 ià(
i
 !ğ
ıu
 && 
	`³r_ıu
(
ıuid4_šfo
, i)) {

530 
siblšg_Ëaf
 =

531 
	`CPUID4_INFO_IDX
(
i
, 
šdex
);

532 
	`ıumask_£t_ıu
(
ıu
, 
	`to_ıumask
(

533 
siblšg_Ëaf
->
sh¬ed_ıu_m­
));

538 
	}
}

539 
__ıuš™
 
	$ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
šdex
)

541 
_ıuid4_šfo
 *
this_Ëaf
, *
siblšg_Ëaf
;

542 
siblšg
;

544 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
šdex
);

545 
	`fÜ_—ch_ıu
(
siblšg
, 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
)) {

546 
siblšg_Ëaf
 = 
	`CPUID4_INFO_IDX
(
siblšg
, 
šdex
);

547 
	`ıumask_ş—r_ıu
(
ıu
,

548 
	`to_ıumask
(
siblšg_Ëaf
->
sh¬ed_ıu_m­
));

550 
	}
}

552 
__ıuš™
 
	$ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
šdex
è{
	}
}

553 
__ıuš™
 
	$ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
šdex
è{
	}
}

556 
__ıuš™
 
	$ä“_ÿche_©Œibu‹s
(
ıu
)

558 
i
;

560 
i
 = 0; i < 
num_ÿche_Ëaves
; i++)

561 
	`ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
i
);

563 
	`kä“
(
	`³r_ıu
(
ıuid4_šfo
, 
ıu
));

564 
	`³r_ıu
(
ıuid4_šfo
, 
ıu
èğ
NULL
;

565 
	}
}

568 
__ıuš™
 
	$ıuid4_ÿche_lookup
(
šdex
, 
_ıuid4_šfo
 *
this_Ëaf
)

570 
_ıuid4_šfo_»gs
 *
Ëaf_»gs
 =

571 (
_ıuid4_šfo_»gs
 *)
this_Ëaf
;

573  
	`ıuid4_ÿche_lookup_»gs
(
šdex
, 
Ëaf_»gs
);

574 
	}
}

576 
__ıuš™
 
	$g‘_ıu_Ëaves
(*
_»tv®
)

578 
j
, *
»tv®
 = 
_»tv®
, 
ıu
 = 
	`smp_´oûssÜ_id
();

581 
j
 = 0; j < 
num_ÿche_Ëaves
; j++) {

582 
_ıuid4_šfo
 *
this_Ëaf
;

583 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
j
);

584 *
»tv®
 = 
	`ıuid4_ÿche_lookup
(
j
, 
this_Ëaf
);

585 ià(
	`uÆik–y
(*
»tv®
 < 0)) {

586 
i
;

588 
i
 = 0; i < 
j
; i++)

589 
	`ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
i
);

592 
	`ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
j
);

594 
	}
}

596 
__ıuš™
 
	$d‘eù_ÿche_©Œibu‹s
(
ıu
)

598 
»tv®
;

600 ià(
num_ÿche_Ëaves
 == 0)

601  -
ENOENT
;

603 
	`³r_ıu
(
ıuid4_šfo
, 
ıu
èğ
	`kz®loc
(

604 (
_ıuid4_šfo
è* 
num_ÿche_Ëaves
, 
GFP_KERNEL
);

605 ià(
	`³r_ıu
(
ıuid4_šfo
, 
ıu
è=ğ
NULL
)

606  -
ENOMEM
;

608 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
g‘_ıu_Ëaves
, &
»tv®
, 
Œue
);

609 ià(
»tv®
) {

610 
	`kä“
(
	`³r_ıu
(
ıuid4_šfo
, 
ıu
));

611 
	`³r_ıu
(
ıuid4_šfo
, 
ıu
èğ
NULL
;

614  
»tv®
;

615 
	}
}

617 
	~<lšux/kobjeù.h
>

618 
	~<lšux/sysfs.h
>

620 
sysdev_şass
 
ıu_sysdev_şass
;

623 
DEFINE_PER_CPU
(
kobjeù
 *, 
ÿche_kobjeù
);

625 
	s_šdex_kobjeù
 {

626 
kobjeù
 
	mkobj
;

627 
	mıu
;

628 
	mšdex
;

632 
DEFINE_PER_CPU
(
_šdex_kobjeù
 *, 
šdex_kobjeù
);

633 
	#INDEX_KOBJECT_PTR
(
x
, 
y
è(&((
	`³r_ıu
(
šdex_kobjeù
, x))[y]))

	)

635 
	#show_Úe_¶us
(
fe_Çme
, 
objeù
, 
v®
) \

636 
ssize_t
 
show_
##
fe_Çme
 \

637 (
_ıuid4_šfo
 *
this_Ëaf
, *
buf
) \

639  
	`¥rštf
 (
buf
, "%lu\n", ()
this_Ëaf
->
objeù
 + 
v®
); \

640 }

	)

642 
show_Úe_¶us
(
Ëv–
, 
—x
.
¥l™
.level, 0);

643 
show_Úe_¶us
(
coh”’cy_lše_size
, 
ebx
.
¥l™
.coherency_line_size, 1);

644 
show_Úe_¶us
(
physiÿl_lše_·¹™iÚ
, 
ebx
.
¥l™
.physical_line_partition, 1);

645 
show_Úe_¶us
(
ways_of_assocŸtiv™y
, 
ebx
.
¥l™
.ways_of_associativity, 1);

646 
show_Úe_¶us
(
numb”_of_£ts
, 
ecx
.
¥l™
.number_of_sets, 1);

648 
ssize_t
 
	$show_size
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
)

650  
	`¥rštf
 (
buf
, "%luK\n", 
this_Ëaf
->
size
 / 1024);

651 
	}
}

653 
ssize_t
 
	$show_sh¬ed_ıu_m­_func
(
_ıuid4_šfo
 *
this_Ëaf
,

654 
ty³
, *
buf
)

656 
±rdiff_t
 
Ën
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

657 
n
 = 0;

659 ià(
Ën
 > 1) {

660 cÚ¡ 
ıumask
 *
mask
;

662 
mask
 = 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
);

663 
n
 = 
ty³
?

664 
	`ıuli¡_sú´štf
(
buf
, 
Ën
-2, 
mask
) :

665 
	`ıumask_sú´štf
(
buf
, 
Ën
-2, 
mask
);

666 
buf
[
n
++] = '\n';

667 
buf
[
n
] = '\0';

669  
n
;

670 
	}
}

672 
šlše
 
ssize_t
 
	$show_sh¬ed_ıu_m­
(
_ıuid4_šfo
 *
Ëaf
, *
buf
)

674  
	`show_sh¬ed_ıu_m­_func
(
Ëaf
, 0, 
buf
);

675 
	}
}

677 
šlše
 
ssize_t
 
	$show_sh¬ed_ıu_li¡
(
_ıuid4_šfo
 *
Ëaf
, *
buf
)

679  
	`show_sh¬ed_ıu_m­_func
(
Ëaf
, 1, 
buf
);

680 
	}
}

682 
ssize_t
 
	$show_ty³
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
)

684 
this_Ëaf
->
—x
.
¥l™
.
ty³
) {

685 
CACHE_TYPE_DATA
:

686  
	`¥rštf
(
buf
, "Data\n");

687 
CACHE_TYPE_INST
:

688  
	`¥rštf
(
buf
, "Instruction\n");

689 
CACHE_TYPE_UNIFIED
:

690  
	`¥rštf
(
buf
, "Unified\n");

692  
	`¥rštf
(
buf
, "Unknown\n");

694 
	}
}

696 
	#to_objeù
(
k
è
	`cÚš”_of
(k, 
_šdex_kobjeù
, 
kobj
)

	)

697 
	#to_©Œ
(
a
è
	`cÚš”_of
×, 
_ÿche_©Œ
, 
©Œ
)

	)

699 #ifdeà
CONFIG_PCI


700 
pci_dev
 *
	$g‘_k8_nÜthbridge
(
node
)

702 
pci_dev
 *
dev
 = 
NULL
;

703 
i
;

705 
i
 = 0; i <ğ
node
; i++) {

707 
dev
 = 
	`pci_g‘_deviû
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

708 ià(!
dev
)

710 } !
	`pci_m©ch_id
(&
k8_nb_id
[0], 
dev
));

711 ià(!
dev
)

714  
dev
;

715 
	}
}

717 
pci_dev
 *
	$g‘_k8_nÜthbridge
(
node
)

719  
NULL
;

720 
	}
}

723 
ssize_t
 
	$show_ÿche_di§bË
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
)

725 cÚ¡ 
ıumask
 *
mask
 = 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
);

726 
node
 = 
	`ıu_to_node
(
	`ıumask_fœ¡
(
mask
));

727 
pci_dev
 *
dev
 = 
NULL
;

728 
ssize_t
 
»t
 = 0;

729 
i
;

731 ià(!
this_Ëaf
->
ÿn_di§bË
)

732  
	`¥rštf
(
buf
, "Feature‚otƒnabled\n");

734 
dev
 = 
	`g‘_k8_nÜthbridge
(
node
);

735 ià(!
dev
) {

736 
	`´štk
(
KERN_ERR
 "Attempting AMD‚orthbridge operation on‡ system with‚o‚orthbridge\n");

737  -
EINVAL
;

740 
i
 = 0; i < 2; i++) {

741 
»g
;

743 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x1BC + 
i
 * 4, &
»g
);

745 
»t
 +ğ
	`¥rštf
(
buf
, "%sEÁry: %d\n", buf, 
i
);

746 
»t
 +ğ
	`¥rštf
(
buf
, "%sReads: %s\tNew Entries: %s\n",

747 
buf
,

748 
»g
 & 0x80000000 ? "Disabled" : "Allowed",

749 
»g
 & 0x40000000 ? "Disabled" : "Allowed");

750 
»t
 +ğ
	`¥rštf
(
buf
, "%sSubCache: %x\tIndex: %x\n",

751 
buf
, (
»g
 & 0x30000) >> 16,„eg & 0xfff);

753  
»t
;

754 
	}
}

756 
ssize_t


757 
	$¡Üe_ÿche_di§bË
(
_ıuid4_šfo
 *
this_Ëaf
, cÚ¡ *
buf
,

758 
size_t
 
couÁ
)

760 cÚ¡ 
ıumask
 *
mask
 = 
	`to_ıumask
(
this_Ëaf
->
sh¬ed_ıu_m­
);

761 
node
 = 
	`ıu_to_node
(
	`ıumask_fœ¡
(
mask
));

762 
pci_dev
 *
dev
 = 
NULL
;

763 
»t
, 
šdex
, 
v®
;

765 ià(!
this_Ëaf
->
ÿn_di§bË
)

768 ià(
	`¡¾’
(
buf
) > 15)

769  -
EINVAL
;

771 
»t
 = 
	`ssÿnf
(
buf
, "%x %x", &
šdex
, &
v®
);

772 ià(
»t
 != 2)

773  -
EINVAL
;

774 ià(
šdex
 > 1)

775  -
EINVAL
;

777 
v®
 |= 0xc0000000;

778 
dev
 = 
	`g‘_k8_nÜthbridge
(
node
);

779 ià(!
dev
) {

780 
	`´štk
(
KERN_ERR
 "Attempting AMD‚orthbridge operation on‡ system with‚o‚orthbridge\n");

781  -
EINVAL
;

784 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x1BC + 
šdex
 * 4, 
v®
 & ~0x40000000);

785 
	`wbšvd
();

786 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x1BC + 
šdex
 * 4, 
v®
);

789 
	}
}

791 
	s_ÿche_©Œ
 {

792 
©Œibu‹
 
	m©Œ
;

793 
ssize_t
 (*
show
)(
	m_ıuid4_šfo
 *, *);

794 
ssize_t
 (*
¡Üe
)(
	m_ıuid4_šfo
 *, cÚ¡ *, 
size_t
 
	mcouÁ
);

797 
	#defše_Úe_ro
(
_Çme
) \

798 
_ÿche_©Œ
 
_Çme
 = \

799 
	`__ATTR
(
_Çme
, 0444, 
show_
##_Çme, 
NULL
)

	)

801 
defše_Úe_ro
(
Ëv–
);

802 
defše_Úe_ro
(
ty³
);

803 
defše_Úe_ro
(
coh”’cy_lše_size
);

804 
defše_Úe_ro
(
physiÿl_lše_·¹™iÚ
);

805 
defše_Úe_ro
(
ways_of_assocŸtiv™y
);

806 
defše_Úe_ro
(
numb”_of_£ts
);

807 
defše_Úe_ro
(
size
);

808 
defše_Úe_ro
(
sh¬ed_ıu_m­
);

809 
defše_Úe_ro
(
sh¬ed_ıu_li¡
);

811 
_ÿche_©Œ
 
	gÿche_di§bË
 = 
__ATTR
(
ÿche_di§bË
, 0644, 
show_ÿche_di§bË
, 
¡Üe_ÿche_di§bË
);

813 
©Œibu‹
 * 
	gdeçuÉ_©Œs
[] = {

814 &
ty³
.
©Œ
,

815 &
Ëv–
.
©Œ
,

816 &
coh”’cy_lše_size
.
©Œ
,

817 &
physiÿl_lše_·¹™iÚ
.
©Œ
,

818 &
ways_of_assocŸtiv™y
.
©Œ
,

819 &
numb”_of_£ts
.
©Œ
,

820 &
size
.
©Œ
,

821 &
sh¬ed_ıu_m­
.
©Œ
,

822 &
sh¬ed_ıu_li¡
.
©Œ
,

823 &
ÿche_di§bË
.
©Œ
,

824 
NULL


827 
ssize_t
 
	$show
(
kobjeù
 * 
kobj
, 
©Œibu‹
 * 
©Œ
, * 
buf
)

829 
_ÿche_©Œ
 *
ç‰r
 = 
	`to_©Œ
(
©Œ
);

830 
_šdex_kobjeù
 *
this_Ëaf
 = 
	`to_objeù
(
kobj
);

831 
ssize_t
 
»t
;

833 
»t
 = 
ç‰r
->
show
 ?

834 
ç‰r
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Ëaf
->
ıu
,his_Ëaf->
šdex
),

835 
buf
) :

837  
»t
;

838 
	}
}

840 
ssize_t
 
	$¡Üe
(
kobjeù
 * 
kobj
, 
©Œibu‹
 * 
©Œ
,

841 cÚ¡ * 
buf
, 
size_t
 
couÁ
)

843 
_ÿche_©Œ
 *
ç‰r
 = 
	`to_©Œ
(
©Œ
);

844 
_šdex_kobjeù
 *
this_Ëaf
 = 
	`to_objeù
(
kobj
);

845 
ssize_t
 
»t
;

847 
»t
 = 
ç‰r
->
¡Üe
 ?

848 
ç‰r
->
	`¡Üe
(
	`CPUID4_INFO_IDX
(
this_Ëaf
->
ıu
,his_Ëaf->
šdex
),

849 
buf
, 
couÁ
) :

851  
»t
;

852 
	}
}

854 
sysfs_İs
 
	gsysfs_İs
 = {

855 .
show
 = show,

856 .
	g¡Üe
 = 
¡Üe
,

859 
kobj_ty³
 
	gkty³_ÿche
 = {

860 .
sysfs_İs
 = &sysfs_ops,

861 .
	gdeçuÉ_©Œs
 = 
deçuÉ_©Œs
,

864 
kobj_ty³
 
	gkty³_³rıu_’Œy
 = {

865 .
sysfs_İs
 = &sysfs_ops,

868 
__ıuš™
 
	$ıuid4_ÿche_sysfs_ex™
(
ıu
)

870 
	`kä“
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
));

871 
	`kä“
(
	`³r_ıu
(
šdex_kobjeù
, 
ıu
));

872 
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
èğ
NULL
;

873 
	`³r_ıu
(
šdex_kobjeù
, 
ıu
èğ
NULL
;

874 
	`ä“_ÿche_©Œibu‹s
(
ıu
);

875 
	}
}

877 
__ıuš™
 
	$ıuid4_ÿche_sysfs_š™
(
ıu
)

879 
”r
;

881 ià(
num_ÿche_Ëaves
 == 0)

882  -
ENOENT
;

884 
”r
 = 
	`d‘eù_ÿche_©Œibu‹s
(
ıu
);

885 ià(
”r
)

886  
”r
;

889 
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
) =

890 
	`kz®loc
((
kobjeù
), 
GFP_KERNEL
);

891 ià(
	`uÆik–y
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
è=ğ
NULL
))

892 
”r_out
;

894 
	`³r_ıu
(
šdex_kobjeù
, 
ıu
èğ
	`kz®loc
(

895 (
_šdex_kobjeù
 ) * 
num_ÿche_Ëaves
, 
GFP_KERNEL
);

896 ià(
	`uÆik–y
(
	`³r_ıu
(
šdex_kobjeù
, 
ıu
è=ğ
NULL
))

897 
”r_out
;

901 
”r_out
:

902 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

903  -
ENOMEM
;

904 
	}
}

906 
DECLARE_BITMAP
(
ÿche_dev_m­
, 
NR_CPUS
);

909 
__ıuš™
 
	$ÿche_add_dev
(
sys_deviû
 * 
sys_dev
)

911 
ıu
 = 
sys_dev
->
id
;

912 
i
, 
j
;

913 
_šdex_kobjeù
 *
this_objeù
;

914 
»tv®
;

916 
»tv®
 = 
	`ıuid4_ÿche_sysfs_š™
(
ıu
);

917 ià(
	`uÆik–y
(
»tv®
 < 0))

918  
»tv®
;

920 
»tv®
 = 
	`kobjeù_š™_ªd_add
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
),

921 &
kty³_³rıu_’Œy
,

922 &
sys_dev
->
kobj
, "%s", "cache");

923 ià(
»tv®
 < 0) {

924 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

925  
»tv®
;

928 
i
 = 0; i < 
num_ÿche_Ëaves
; i++) {

929 
this_objeù
 = 
	`INDEX_KOBJECT_PTR
(
ıu
,
i
);

930 
this_objeù
->
ıu
 = cpu;

931 
this_objeù
->
šdex
 = 
i
;

932 
»tv®
 = 
	`kobjeù_š™_ªd_add
(&(
this_objeù
->
kobj
),

933 &
kty³_ÿche
,

934 
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
),

935 "šdex%1lu", 
i
);

936 ià(
	`uÆik–y
(
»tv®
)) {

937 
j
 = 0; j < 
i
; j++) {

938 
	`kobjeù_put
(&(
	`INDEX_KOBJECT_PTR
(
ıu
,
j
)->
kobj
));

940 
	`kobjeù_put
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
));

941 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

942  
»tv®
;

944 
	`kobjeù_uev’t
(&(
this_objeù
->
kobj
), 
KOBJ_ADD
);

946 
	`ıumask_£t_ıu
(
ıu
, 
	`to_ıumask
(
ÿche_dev_m­
));

948 
	`kobjeù_uev’t
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
), 
KOBJ_ADD
);

950 
	}
}

952 
__ıuš™
 
	$ÿche_»move_dev
(
sys_deviû
 * 
sys_dev
)

954 
ıu
 = 
sys_dev
->
id
;

955 
i
;

957 ià(
	`³r_ıu
(
ıuid4_šfo
, 
ıu
è=ğ
NULL
)

959 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
	`to_ıumask
(
ÿche_dev_m­
)))

961 
	`ıumask_ş—r_ıu
(
ıu
, 
	`to_ıumask
(
ÿche_dev_m­
));

963 
i
 = 0; i < 
num_ÿche_Ëaves
; i++)

964 
	`kobjeù_put
(&(
	`INDEX_KOBJECT_PTR
(
ıu
,
i
)->
kobj
));

965 
	`kobjeù_put
(
	`³r_ıu
(
ÿche_kobjeù
, 
ıu
));

966 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

967 
	}
}

969 
__ıuš™
 
	$ÿchešfo_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

970 
aùiÚ
, *
hıu
)

972 
ıu
 = ()
hıu
;

973 
sys_deviû
 *
sys_dev
;

975 
sys_dev
 = 
	`g‘_ıu_sysdev
(
ıu
);

976 
aùiÚ
) {

977 
CPU_ONLINE
:

978 
CPU_ONLINE_FROZEN
:

979 
	`ÿche_add_dev
(
sys_dev
);

981 
CPU_DEAD
:

982 
CPU_DEAD_FROZEN
:

983 
	`ÿche_»move_dev
(
sys_dev
);

986  
NOTIFY_OK
;

987 
	}
}

989 
nÙif›r_block
 
__ıuš™d©a
 
	gÿchešfo_ıu_nÙif›r
 =

991 .
nÙif›r_ÿÎ
 = 
ÿchešfo_ıu_ÿÎback
,

994 
__ıuš™
 
	$ÿche_sysfs_š™
()

996 
i
;

998 ià(
num_ÿche_Ëaves
 == 0)

1001 
	`fÜ_—ch_Úlše_ıu
(
i
) {

1002 
”r
;

1003 
sys_deviû
 *
sys_dev
 = 
	`g‘_ıu_sysdev
(
i
);

1005 
”r
 = 
	`ÿche_add_dev
(
sys_dev
);

1006 ià(
”r
)

1007  
”r
;

1009 
	`»gi¡”_hÙıu_nÙif›r
(&
ÿchešfo_ıu_nÙif›r
);

1011 
	}
}

1013 
deviû_š™ÿÎ
(
ÿche_sysfs_š™
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_64.c

10 
	~<lšux/š™.h
>

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/smp_lock.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/rcupd©e.h
>

17 
	~<lšux/k®lsyms.h
>

18 
	~<lšux/sysdev.h
>

19 
	~<lšux/miscdeviû.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/ÿ·b™y.h
>

22 
	~<lšux/ıu.h
>

23 
	~<lšux/³rıu.h
>

24 
	~<lšux/pŞl.h
>

25 
	~<lšux/th»ad_šfo.h
>

26 
	~<lšux/ùy³.h
>

27 
	~<lšux/kmod.h
>

28 
	~<lšux/kdebug.h
>

29 
	~<lšux/kobjeù.h
>

30 
	~<lšux/sysfs.h
>

31 
	~<lšux/¿‹lim™.h
>

32 
	~<asm/´oûssÜ.h
>

33 
	~<asm/m¤.h
>

34 
	~<asm/mû.h
>

35 
	~<asm/uacûss.h
>

36 
	~<asm/smp.h
>

37 
	~<asm/idË.h
>

39 
	#MISC_MCELOG_MINOR
 227

	)

41 
©omic_t
 
	gmû_’Œy
;

43 
	gmû_dÚt_š™
;

52 
	gtŞ”ªt
 = 1;

53 
	gbªks
;

54 
u64
 *
	gbªk
;

55 
	gnÙify_u£r
;

56 
	gr_m¤
;

57 
	gmû_boÙlog
 = -1;

58 
©omic_t
 
	gmû_ev’ts
;

60 
	gŒigg”
[128];

61 *
	gŒigg”_¬gv
[2] = { 
Œigg”
, 
NULL
 };

63 
DECLARE_WAIT_QUEUE_HEAD
(
mû_wa™
);

66 
DEFINE_PER_CPU
(
mû_bªks_t
, 
mû_pŞl_bªks
) = {

67 [0 ... 
BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

71 
	$mû_£tup
(
mû
 *
m
)

73 
	`mem£t
(
m
, 0, (
mû
));

74 
m
->
ıu
 = 
	`smp_´oûssÜ_id
();

75 
	`rdtsşl
(
m
->
tsc
);

76 
	}
}

84 
mû_log
 
	gmûlog
 = {

85 
MCE_LOG_SIGNATURE
,

86 
MCE_LOG_LEN
,

89 
	$mû_log
(
mû
 *mce)

91 
Ãxt
, 
’Œy
;

92 
	`©omic_šc
(&
mû_ev’ts
);

93 
mû
->
fšished
 = 0;

94 
	`wmb
();

96 
’Œy
 = 
	`rcu_d”eã»nû
(
mûlog
.
Ãxt
);

100 ià(
’Œy
 >ğ
MCE_LOG_LEN
) {

101 
	`£t_b™
(
MCE_OVERFLOW
, (*)&
mûlog
.
æags
);

105 ià(
mûlog
.
’Œy
[’Œy].
fšished
) {

106 
’Œy
++;

111 
	`smp_rmb
();

112 
Ãxt
 = 
’Œy
 + 1;

113 ià(
	`cmpxchg
(&
mûlog
.
Ãxt
, 
’Œy
,‚ext) ==ƒntry)

116 
	`memıy
(
mûlog
.
’Œy
 +ƒÁry, 
mû
, (mce));

117 
	`wmb
();

118 
mûlog
.
’Œy
[’Œy].
fšished
 = 1;

119 
	`wmb
();

121 
	`£t_b™
(0, &
nÙify_u£r
);

122 
	}
}

124 
	$´št_mû
(
mû
 *
m
)

126 
	`´štk
(
KERN_EMERG
 "\n"

127 
KERN_EMERG
 "HARDWARE ERROR\n"

128 
KERN_EMERG


130 
m
->
ıu
, m->
mcg¡©us
, m->
bªk
, m->
¡©us
);

131 ià(
m
->

) {

132 
	`´štk
(
KERN_EMERG
 "RIP%s %02x:<%016Lx> ",

133 !(
m
->
mcg¡©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

134 
m
->
cs
, m->

);

135 ià(
m
->
cs
 =ğ
__KERNEL_CS
)

136 
	`´št_symbŞ
("{%s}", 
m
->

);

137 
	`´štk
("\n");

139 
	`´štk
(
KERN_EMERG
 "TSC %Îx ", 
m
->
tsc
);

140 ià(
m
->
addr
)

141 
	`´štk
("ADDR %Îx ", 
m
->
addr
);

142 ià(
m
->
misc
)

143 
	`´štk
("MISC %Îx ", 
m
->
misc
);

144 
	`´štk
("\n");

145 
	`´štk
(
KERN_EMERG
 "This is‚ot‡ software…roblem!\n");

146 
	`´štk
(
KERN_EMERG
 "Runhrough mcelog --asciio decode "

148 
	}
}

150 
	$mû_·nic
(*
msg
, 
mû
 *
backup
, 
¡¬t
)

152 
i
;

154 
	`oİs_begš
();

155 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

156 
tsc
 = 
mûlog
.
’Œy
[
i
].tsc;

158 ià(
	`time_befÜe
(
tsc
, 
¡¬t
))

160 
	`´št_mû
(&
mûlog
.
’Œy
[
i
]);

161 ià(
backup
 && 
mûlog
.
’Œy
[
i
].
tsc
 == backup->tsc)

162 
backup
 = 
NULL
;

164 ià(
backup
)

165 
	`´št_mû
(
backup
);

166 
	`·nic
(
msg
);

167 
	}
}

169 
	$mû_avaabË
(
ıušfo_x86
 *
c
)

171 ià(
mû_dÚt_š™
)

173  
	`ıu_has
(
c
, 
X86_FEATURE_MCE
è&& cpu_has(c, 
X86_FEATURE_MCA
);

174 
	}
}

176 
šlše
 
	$mû_g‘_r
(
mû
 *
m
, 
±_»gs
 *
»gs
)

178 ià(
»gs
 && (
m
->
mcg¡©us
 & 
MCG_STATUS_RIPV
)) {

179 
m
->

 = 
»gs
->ip;

180 
m
->
cs
 = 
»gs
->cs;

182 
m
->

 = 0;

183 
m
->
cs
 = 0;

185 ià(
r_m¤
) {

187 
m
->
mcg¡©us
 |ğ
MCG_STATUS_EIPV
;

188 
	`rdm¤l
(
r_m¤
, 
m
->

);

189 
m
->
cs
 = 0;

191 
	}
}

199 
	$machše_check_pŞl
(
mı_æags
 
æags
, 
mû_bªks_t
 *
b
)

201 
mû
 
m
;

202 
i
;

204 
	`mû_£tup
(&
m
);

206 
	`rdm¤l
(
MSR_IA32_MCG_STATUS
, 
m
.
mcg¡©us
);

207 
i
 = 0; i < 
bªks
; i++) {

208 ià(!
bªk
[
i
] || !
	`‹¡_b™
(i, *
b
))

211 
m
.
misc
 = 0;

212 
m
.
addr
 = 0;

213 
m
.
bªk
 = 
i
;

214 
m
.
tsc
 = 0;

216 
	`b¬r›r
();

217 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
 + 
i
*4, 
m
.
¡©us
);

218 ià(!(
m
.
¡©us
 & 
MCI_STATUS_VAL
))

228 ià((
m
.
¡©us
 & 
MCI_STATUS_UC
è&& !(
æags
 & 
MCP_UC
))

231 ià(
m
.
¡©us
 & 
MCI_STATUS_MISCV
)

232 
	`rdm¤l
(
MSR_IA32_MC0_MISC
 + 
i
*4, 
m
.
misc
);

233 ià(
m
.
¡©us
 & 
MCI_STATUS_ADDRV
)

234 
	`rdm¤l
(
MSR_IA32_MC0_ADDR
 + 
i
*4, 
m
.
addr
);

236 ià(!(
æags
 & 
MCP_TIMESTAMP
))

237 
m
.
tsc
 = 0;

242 ià(!(
æags
 & 
MCP_DONTLOG
)) {

243 
	`mû_log
(&
m
);

244 
	`add_št
(
TAINT_MACHINE_CHECK
);

250 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

257 
	}
}

267 
	$do_machše_check
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

269 
mû
 
m
, 
·nicm
;

270 
u64
 
mû¡¬t
 = 0;

271 
i
;

272 
·nicm_found
 = 0;

277 
no_way_out
 = 0;

282 
kl_™
 = 0;

283 
	`DECLARE_BITMAP
(
toş—r
, 
MAX_NR_BANKS
);

285 
	`©omic_šc
(&
mû_’Œy
);

287 ià(
	`nÙify_d›
(
DIE_NMI
, "machšcheck", 
»gs
, 
”rÜ_code
,

288 18, 
SIGKILL
è=ğ
NOTIFY_STOP
)

289 
out2
;

290 ià(!
bªks
)

291 
out2
;

293 
	`mû_£tup
(&
m
);

295 
	`rdm¤l
(
MSR_IA32_MCG_STATUS
, 
m
.
mcg¡©us
);

297 ià(!(
m
.
mcg¡©us
 & 
MCG_STATUS_RIPV
))

298 
no_way_out
 = 1;

300 
	`rdtsşl
(
mû¡¬t
);

301 
	`b¬r›r
();

303 
i
 = 0; i < 
bªks
; i++) {

304 
	`__ş—r_b™
(
i
, 
toş—r
);

305 ià(!
bªk
[
i
])

308 
m
.
misc
 = 0;

309 
m
.
addr
 = 0;

310 
m
.
bªk
 = 
i
;

312 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
 + 
i
*4, 
m
.
¡©us
);

313 ià((
m
.
¡©us
 & 
MCI_STATUS_VAL
) == 0)

320 ià((
m
.
¡©us
 & 
MCI_STATUS_UC
) == 0)

326 
	`add_št
(
TAINT_MACHINE_CHECK
);

328 
	`__£t_b™
(
i
, 
toş—r
);

330 ià(
m
.
¡©us
 & 
MCI_STATUS_EN
) {

332 
no_way_out
 |ğ!!(
m
.
¡©us
 & 
MCI_STATUS_PCC
);

338 ià(
m
.
¡©us
 & 
MCI_STATUS_UC
) {

339 ià(
tŞ”ªt
 < 1 || 
m
.
¡©us
 & 
MCI_STATUS_OVER
)

340 
no_way_out
 = 1;

341 
kl_™
 = 1;

351 ià(
m
.
¡©us
 & 
MCI_STATUS_MISCV
)

352 
	`rdm¤l
(
MSR_IA32_MC0_MISC
 + 
i
*4, 
m
.
misc
);

353 ià(
m
.
¡©us
 & 
MCI_STATUS_ADDRV
)

354 
	`rdm¤l
(
MSR_IA32_MC0_ADDR
 + 
i
*4, 
m
.
addr
);

356 
	`mû_g‘_r
(&
m
, 
»gs
);

357 
	`mû_log
(&
m
);

362 ià((
m
.
¡©us
 & 
MCI_STATUS_UC
è&& (m.¡©u & 
MCI_STATUS_EN
)) {

363 
·nicm
 = 
m
;

364 
·nicm_found
 = 1;

370 ià(!
·nicm_found
)

371 
·nicm
 = 
m
;

377 ià(
no_way_out
 && 
tŞ”ªt
 < 3)

378 
	`mû_·nic
("Machšcheck", &
·nicm
, 
mû¡¬t
);

386 ià(
kl_™
 && 
tŞ”ªt
 < 3) {

387 
u£r_¥aû
 = 0;

393 ià(
m
.
mcg¡©us
 & 
MCG_STATUS_EIPV
)

394 
u£r_¥aû
 = 
·nicm
.

 && (·nicm.
cs
 & 3);

403 ià(
u£r_¥aû
) {

404 
	`fÜû_sig
(
SIGBUS
, 
cu¼’t
);

405 } ià(
·nic_Ú_oİs
 || 
tŞ”ªt
 < 2) {

406 
	`mû_·nic
("Uncorrected machine check",

407 &
·nicm
, 
mû¡¬t
);

412 
	`£t_th»ad_æag
(
TIF_MCE_NOTIFY
);

415 
i
 = 0; i < 
bªks
; i++) {

416 ià(
	`‹¡_b™
(
i
, 
toş—r
))

417 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

419 
	`wrm¤l
(
MSR_IA32_MCG_STATUS
, 0);

420 
out2
:

421 
	`©omic_dec
(&
mû_’Œy
);

422 
	}
}

424 #ifdeà
CONFIG_X86_MCE_INTEL


438 
	$mû_log_th”m_thrÙ_ev’t
(
__u64
 
¡©us
)

440 
mû
 
m
;

442 
	`mû_£tup
(&
m
);

443 
m
.
bªk
 = 
MCE_THERMAL_BANK
;

444 
m
.
¡©us
 = status;

445 
	`mû_log
(&
m
);

446 
	}
}

455 
	gcheck_š‹rv®
 = 5 * 60;

456 
DEFINE_PER_CPU
(, 
Ãxt_š‹rv®
);

457 
mcheck_tim”
();

458 
DEFINE_PER_CPU
(
tim”_li¡
, 
mû_tim”
);

460 
	$mcheck_tim”
(
d©a
)

462 
tim”_li¡
 *
t
 = &
	`³r_ıu
(
mû_tim”
, 
d©a
);

463 *
n
;

465 
	`WARN_ON
(
	`smp_´oûssÜ_id
(è!ğ
d©a
);

467 ià(
	`mû_avaabË
(&
cu¼’t_ıu_d©a
))

468 
	`machše_check_pŞl
(
MCP_TIMESTAMP
,

469 &
	`__g‘_ıu_v¬
(
mû_pŞl_bªks
));

475 
n
 = &
	`__g‘_ıu_v¬
(
Ãxt_š‹rv®
);

476 ià(
	`mû_nÙify_u£r
()) {

477 *
n
 = 
	`max
(*n/2, 
HZ
/100);

479 *
n
 = 
	`mš
(*n*2, ()
	`round_jiff›s_»Ïtive
(
check_š‹rv®
*
HZ
));

482 
t
->
expœes
 = 
jiff›s
 + *
n
;

483 
	`add_tim”
(
t
);

484 
	}
}

486 
	$mû_do_Œigg”
(
wÜk_¡ruù
 *
wÜk
)

488 
	`ÿÎ_u£rmodeh–³r
(
Œigg”
, 
Œigg”_¬gv
, 
NULL
, 
UMH_NO_WAIT
);

489 
	}
}

491 
DECLARE_WORK
(
mû_Œigg”_wÜk
, 
mû_do_Œigg”
);

498 
	$mû_nÙify_u£r
()

501 
	`DEFINE_RATELIMIT_STATE
(
¿‹lim™
, 60*
HZ
, 2);

503 
	`ş—r_th»ad_æag
(
TIF_MCE_NOTIFY
);

504 ià(
	`‹¡_ªd_ş—r_b™
(0, &
nÙify_u£r
)) {

505 
	`wake_up_š‹¼u±ibË
(&
mû_wa™
);

512 ià(
Œigg”
[0] && !
	`wÜk_³ndšg
(&
mû_Œigg”_wÜk
))

513 
	`scheduË_wÜk
(&
mû_Œigg”_wÜk
);

515 ià(
	`__¿‹lim™
(&
¿‹lim™
))

516 
	`´štk
(
KERN_INFO
 "Machine checkƒvents†ogged\n");

521 
	}
}

525 
	$mû_idË_ÿÎback
(
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
junk
)

528 ià(
aùiÚ
 =ğ
IDLE_END
 && 
	`‹¡_th»ad_æag
(
TIF_MCE_NOTIFY
))

529 
	`mû_nÙify_u£r
();

531  
NOTIFY_OK
;

532 
	}
}

534 
nÙif›r_block
 
	gmû_idË_nÙif›r
 = {

535 .
nÙif›r_ÿÎ
 = 
mû_idË_ÿÎback
,

538 
__š™
 
	$³riodic_mcheck_š™
()

540 
	`idË_nÙif›r_»gi¡”
(&
mû_idË_nÙif›r
);

542 
	}
}

543 
__š™ÿÎ
(
³riodic_mcheck_š™
);

548 
	$mû_ÿp_š™
()

550 
u64
 
ÿp
;

551 
b
;

553 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
ÿp
);

554 
b
 = 
ÿp
 & 0xff;

555 ià(
b
 > 
MAX_NR_BANKS
) {

556 
	`´štk
(
KERN_WARNING


558 
MAX_NR_BANKS
, 
b
);

559 
b
 = 
MAX_NR_BANKS
;

563 
	`WARN_ON
(
bªks
 !ğ0 && 
b
 != banks);

564 
bªks
 = 
b
;

565 ià(!
bªk
) {

566 
bªk
 = 
	`km®loc
(
bªks
 * (
u64
), 
GFP_KERNEL
);

567 ià(!
bªk
)

568  -
ENOMEM
;

569 
	`mem£t
(
bªk
, 0xff, 
bªks
 * (
u64
));

573 ià((
ÿp
 & (1<<9)) && ((cap >> 16) & 0xff) >= 9)

574 
r_m¤
 = 
MSR_IA32_MCG_EIP
;

577 
	}
}

579 
	$mû_š™
(*
dummy
)

581 
u64
 
ÿp
;

582 
i
;

583 
mû_bªks_t
 
®l_bªks
;

588 
	`b™m­_fl
(
®l_bªks
, 
MAX_NR_BANKS
);

589 
	`machše_check_pŞl
(
MCP_UC
|(!
mû_boÙlog
 ? 
MCP_DONTLOG
 : 0), &
®l_bªks
);

591 
	`£t_š_ü4
(
X86_CR4_MCE
);

593 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
ÿp
);

594 ià(
ÿp
 & 
MCG_CTL_P
)

595 
	`wrm¤
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

597 
i
 = 0; i < 
bªks
; i++) {

598 
	`wrm¤l
(
MSR_IA32_MC0_CTL
+4*
i
, 
bªk
[i]);

599 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

601 
	}
}

604 
	$mû_ıu_quœks
(
ıušfo_x86
 *
c
)

607 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
) {

608 ià(
c
->
x86
 =ğ15 && 
bªks
 > 4)

611 
	`ş—r_b™
(10, (*)&
bªk
[4]);

612 if(
c
->
x86
 <ğ17 && 
mû_boÙlog
 < 0)

615 
mû_boÙlog
 = 0;

618 
	}
}

620 
	$mû_ıu_ã©u»s
(
ıušfo_x86
 *
c
)

622 
c
->
x86_v’dÜ
) {

623 
X86_VENDOR_INTEL
:

624 
	`mû_š‹l_ã©u»_š™
(
c
);

626 
X86_VENDOR_AMD
:

627 
	`mû_amd_ã©u»_š™
(
c
);

632 
	}
}

634 
	$mû_š™_tim”
()

636 
tim”_li¡
 *
t
 = &
	`__g‘_ıu_v¬
(
mû_tim”
);

637 *
n
 = &
	`__g‘_ıu_v¬
(
Ãxt_š‹rv®
);

639 *
n
 = 
check_š‹rv®
 * 
HZ
;

640 ià(!*
n
)

642 
	`£tup_tim”
(
t
, 
mcheck_tim”
, 
	`smp_´oûssÜ_id
());

643 
t
->
expœes
 = 
	`round_jiff›s
(
jiff›s
 + *
n
);

644 
	`add_tim”
(
t
);

645 
	}
}

651 
__ıuš™
 
	$mcheck_š™
(
ıušfo_x86
 *
c
)

653 ià(!
	`mû_avaabË
(
c
))

656 ià(
	`mû_ÿp_š™
() < 0) {

657 
mû_dÚt_š™
 = 1;

660 
	`mû_ıu_quœks
(
c
);

662 
	`mû_š™
(
NULL
);

663 
	`mû_ıu_ã©u»s
(
c
);

664 
	`mû_š™_tim”
();

665 
	}
}

671 
DEFINE_SPINLOCK
(
mû_¡©e_lock
);

672 
	gİ’_couÁ
;

673 
	gİ’_exşu
;

675 
	$mû_İ’
(
šode
 *šode, 
fe
 *file)

677 
	`lock_k”Ãl
();

678 
	`¥š_lock
(&
mû_¡©e_lock
);

680 ià(
İ’_exşu
 || (
İ’_couÁ
 && (
fe
->
f_æags
 & 
O_EXCL
))) {

681 
	`¥š_uÆock
(&
mû_¡©e_lock
);

682 
	`uÆock_k”Ãl
();

683  -
EBUSY
;

686 ià(
fe
->
f_æags
 & 
O_EXCL
)

687 
İ’_exşu
 = 1;

688 
İ’_couÁ
++;

690 
	`¥š_uÆock
(&
mû_¡©e_lock
);

691 
	`uÆock_k”Ãl
();

693  
	`nÚ£ekabË_İ’
(
šode
, 
fe
);

694 
	}
}

696 
	$mû_»Ëa£
(
šode
 *šode, 
fe
 *file)

698 
	`¥š_lock
(&
mû_¡©e_lock
);

700 
İ’_couÁ
--;

701 
İ’_exşu
 = 0;

703 
	`¥š_uÆock
(&
mû_¡©e_lock
);

706 
	}
}

708 
	$cŞËù_tscs
(*
d©a
)

710 *
ıu_tsc
 = (*)
d©a
;

712 
	`rdtsşl
(
ıu_tsc
[
	`smp_´oûssÜ_id
()]);

713 
	}
}

715 
ssize_t
 
	$mû_»ad
(
fe
 *
fp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

716 
loff_t
 *
off
)

718 *
ıu_tsc
;

719 
	`DEFINE_MUTEX
(
mû_»ad_mu‹x
);

720 
´ev
, 
Ãxt
;

721 
__u£r
 *
buf
 = 
ubuf
;

722 
i
, 
”r
;

724 
ıu_tsc
 = 
	`km®loc
(
Ä_ıu_ids
 * (), 
GFP_KERNEL
);

725 ià(!
ıu_tsc
)

726  -
ENOMEM
;

728 
	`mu‹x_lock
(&
mû_»ad_mu‹x
);

729 
Ãxt
 = 
	`rcu_d”eã»nû
(
mûlog
.next);

732 ià(*
off
 !ğ0 || 
usize
 < 
MCE_LOG_LEN
*(
mû
)) {

733 
	`mu‹x_uÆock
(&
mû_»ad_mu‹x
);

734 
	`kä“
(
ıu_tsc
);

735  -
EINVAL
;

738 
”r
 = 0;

739 
´ev
 = 0;

741 
i
 = 
´ev
; i < 
Ãxt
; i++) {

742 
¡¬t
 = 
jiff›s
;

744 !
mûlog
.
’Œy
[
i
].
fšished
) {

745 ià(
	`time_aá”_eq
(
jiff›s
, 
¡¬t
 + 2)) {

746 
	`mem£t
(
mûlog
.
’Œy
 + 
i
, 0,

747 (
mû
));

748 
timeout
;

750 
	`ıu_»Ïx
();

752 
	`smp_rmb
();

753 
”r
 |ğ
	`cİy_to_u£r
(
buf
, 
mûlog
.
’Œy
 + 
i
,

754 (
mû
));

755 
buf
 +ğ(
mû
);

756 
timeout
:

760 
	`mem£t
(
mûlog
.
’Œy
 + 
´ev
, 0,

761 (
Ãxt
 - 
´ev
è* (
mû
));

762 
´ev
 = 
Ãxt
;

763 
Ãxt
 = 
	`cmpxchg
(&
mûlog
.Ãxt, 
´ev
, 0);

764 } 
Ãxt
 !ğ
´ev
);

766 
	`synchrÚize_sched
();

772 
	`Ú_—ch_ıu
(
cŞËù_tscs
, 
ıu_tsc
, 1);

773 
i
 = 
Ãxt
; i < 
MCE_LOG_LEN
; i++) {

774 ià(
mûlog
.
’Œy
[
i
].
fšished
 &&

775 
mûlog
.
’Œy
[
i
].
tsc
 < 
ıu_tsc
[mûlog.’Œy[i].
ıu
]) {

776 
”r
 |ğ
	`cİy_to_u£r
(
buf
, 
mûlog
.
’Œy
+
i
,

777 (
mû
));

778 
	`smp_rmb
();

779 
buf
 +ğ(
mû
);

780 
	`mem£t
(&
mûlog
.
’Œy
[
i
], 0, (
mû
));

783 
	`mu‹x_uÆock
(&
mû_»ad_mu‹x
);

784 
	`kä“
(
ıu_tsc
);

785  
”r
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

786 
	}
}

788 
	$mû_pŞl
(
fe
 *fe, 
pŞl_bË
 *
wa™
)

790 
	`pŞl_wa™
(
fe
, &
mû_wa™
, 
wa™
);

791 ià(
	`rcu_d”eã»nû
(
mûlog
.
Ãxt
))

792  
POLLIN
 | 
POLLRDNORM
;

794 
	}
}

796 
	$mû_ioùl
(
fe
 *
f
, 
cmd
, 
¬g
)

798 
__u£r
 *
p
 = (__u£¸*)
¬g
;

800 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

801  -
EPERM
;

802 
cmd
) {

803 
MCE_GET_RECORD_LEN
:

804  
	`put_u£r
((
mû
), 
p
);

805 
MCE_GET_LOG_LEN
:

806  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

807 
MCE_GETCLEAR_FLAGS
: {

808 
æags
;

811 
æags
 = 
mûlog
.flags;

812 } 
	`cmpxchg
(&
mûlog
.
æags
, flags, 0) != flags);

813  
	`put_u£r
(
æags
, 
p
);

816  -
ENOTTY
;

818 
	}
}

820 cÚ¡ 
fe_İ”©iÚs
 
	gmû_chrdev_İs
 = {

821 .
İ’
 = 
mû_İ’
,

822 .
	g»Ëa£
 = 
mû_»Ëa£
,

823 .
	g»ad
 = 
mû_»ad
,

824 .
	gpŞl
 = 
mû_pŞl
,

825 .
	guÆocked_ioùl
 = 
mû_ioùl
,

828 
miscdeviû
 
	gmû_log_deviû
 = {

829 
MISC_MCELOG_MINOR
,

831 &
mû_chrdev_İs
,

837 
__š™
 
	$mcheck_di§bË
(*
¡r
)

839 
mû_dÚt_š™
 = 1;

841 
	}
}

847 
__š™
 
	$mcheck_’abË
(*
¡r
)

849 ià(!
	`¡rcmp
(
¡r
, "off"))

850 
mû_dÚt_š™
 = 1;

851 ià(!
	`¡rcmp
(
¡r
, "bootlog") || !strcmp(str,"nobootlog"))

852 
mû_boÙlog
 = 
¡r
[0] == 'b';

853 ià(
	`isdig™
(
¡r
[0]))

854 
	`g‘_İtiÚ
(&
¡r
, &
tŞ”ªt
);

856 
	`´štk
("mûğ¬gum’ˆ% ignÜed. PËa£ u£ /sys", 
¡r
);

858 
	}
}

860 
__£tup
("nomû", 
mcheck_di§bË
);

861 
__£tup
("mû=", 
mcheck_’abË
);

871 
	$mû_di§bË
()

873 
i
;

875 
i
 = 0; i < 
bªks
; i++)

876 
	`wrm¤l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 0);

878 
	}
}

880 
	$mû_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

882  
	`mû_di§bË
();

883 
	}
}

885 
	$mû_shutdown
(
sys_deviû
 *
dev
)

887  
	`mû_di§bË
();

888 
	}
}

893 
	$mû_»sume
(
sys_deviû
 *
dev
)

895 
	`mû_š™
(
NULL
);

896 
	`mû_ıu_ã©u»s
(&
cu¼’t_ıu_d©a
);

898 
	}
}

900 
	$mû_ıu_»¡¬t
(*
d©a
)

902 
	`d–_tim”_sync
(&
	`__g‘_ıu_v¬
(
mû_tim”
));

903 ià(
	`mû_avaabË
(&
cu¼’t_ıu_d©a
))

904 
	`mû_š™
(
NULL
);

905 
	`mû_š™_tim”
();

906 
	}
}

909 
	$mû_»¡¬t
()

911 
	`Ú_—ch_ıu
(
mû_ıu_»¡¬t
, 
NULL
, 1);

912 
	}
}

914 
sysdev_şass
 
	gmû_sysşass
 = {

915 .
su¥’d
 = 
mû_su¥’d
,

916 .
	gshutdown
 = 
mû_shutdown
,

917 .
	g»sume
 = 
mû_»sume
,

918 .
	gÇme
 = "machinecheck",

921 
DEFINE_PER_CPU
(
sys_deviû
, 
deviû_mû
);

922 (*
th»shŞd_ıu_ÿÎback
)(
aùiÚ
, 
ıu
è
__ıuš™d©a
;

925 
	#ACCESSOR
(
Çme
, 
v¬
, 
¡¬t
) \

926 
ssize_t
 
show_
 ## 
	`Çme
(
sys_deviû
 *
s
, \

927 
sysdev_©Œibu‹
 *
©Œ
, \

928 *
buf
) { \

929  
	`¥rštf
(
buf
, "%lx\n", ()
v¬
); \

930 
	}
} \

931 
ssize_t
 
£t_
 ## 
	`Çme
(
sys_deviû
 *
s
, \

932 
sysdev_©Œibu‹
 *
©Œ
, \

933 cÚ¡ *
buf
, 
size_t
 
siz
) { \

934 *
’d
; \

935 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0); \

936 ià(
’d
 =ğ
buf
è -
EINVAL
; \

937 
v¬
 = 
Ãw
; \

938 
¡¬t
; \

939  
’d
-
buf
; \

941 
	`SYSDEV_ATTR
(
Çme
, 0644, 
show_
 ##‚ame, 
£t_
 ##‚ame);

	)

943 
sysdev_©Œibu‹
 *
	gbªk_©Œs
;

945 
ssize_t
 
	$show_bªk
(
sys_deviû
 *
s
, 
sysdev_©Œibu‹
 *
©Œ
,

946 *
buf
)

948 
u64
 
b
 = 
bªk
[
©Œ
 - 
bªk_©Œs
];

949  
	`¥rštf
(
buf
, "%Îx\n", 
b
);

950 
	}
}

952 
ssize_t
 
	$£t_bªk
(
sys_deviû
 *
s
, 
sysdev_©Œibu‹
 *
©Œ
,

953 cÚ¡ *
buf
, 
size_t
 
siz
)

955 *
’d
;

956 
u64
 
Ãw
 = 
	`sim¶e_¡¹ouÎ
(
buf
, &
’d
, 0);

957 ià(
’d
 =ğ
buf
)

958  -
EINVAL
;

959 
bªk
[
©Œ
 - 
bªk_©Œs
] = 
Ãw
;

960 
	`mû_»¡¬t
();

961  
’d
-
buf
;

962 
	}
}

964 
ssize_t
 
	$show_Œigg”
(
sys_deviû
 *
s
, 
sysdev_©Œibu‹
 *
©Œ
,

965 *
buf
)

967 
	`¡rıy
(
buf
, 
Œigg”
);

968 
	`¡rÿt
(
buf
, "\n");

969  
	`¡¾’
(
Œigg”
) + 1;

970 
	}
}

972 
ssize_t
 
	$£t_Œigg”
(
sys_deviû
 *
s
, 
sysdev_©Œibu‹
 *
©Œ
,

973 cÚ¡ *
buf
,
size_t
 
siz
)

975 *
p
;

976 
Ën
;

977 
	`¡ºıy
(
Œigg”
, 
buf
, (trigger));

978 
Œigg”
[(trigger)-1] = 0;

979 
Ën
 = 
	`¡¾’
(
Œigg”
);

980 
p
 = 
	`¡rchr
(
Œigg”
, '\n');

981 ià(*
p
) *p = 0;

982  
Ën
;

983 
	}
}

985 
SYSDEV_ATTR
(
Œigg”
, 0644, 
show_Œigg”
, 
£t_Œigg”
);

986 
SYSDEV_INT_ATTR
(
tŞ”ªt
, 0644,olerant);

987 
ACCESSOR
(
check_š‹rv®
,check_š‹rv®,
	$mû_»¡¬t
())

988 
sysdev_©Œibu‹
 *
mû_©Œibu‹s
[] = {

989 &
©Œ_tŞ”ªt
.
©Œ
, &
©Œ_check_š‹rv®
, &
©Œ_Œigg”
,

990 
NULL


991 
	}
};

993 
ıumask_v¬_t
 
	gmû_deviû_š™Ÿlized
;

996 
__ıuš™
 
	$mû_ü—‹_deviû
(
ıu
)

998 
”r
;

999 
i
;

1001 ià(!
	`mû_avaabË
(&
boÙ_ıu_d©a
))

1002  -
EIO
;

1004 
	`mem£t
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
, 0, (
kobjeù
));

1005 
	`³r_ıu
(
deviû_mû
,
ıu
).
id
 = cpu;

1006 
	`³r_ıu
(
deviû_mû
,
ıu
).
şs
 = &
mû_sysşass
;

1008 
”r
 = 
	`sysdev_»gi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

1009 ià(
”r
)

1010  
”r
;

1012 
i
 = 0; 
mû_©Œibu‹s
[i]; i++) {

1013 
”r
 = 
	`sysdev_ü—‹_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

1014 
mû_©Œibu‹s
[
i
]);

1015 ià(
”r
)

1016 
”rÜ
;

1018 
i
 = 0; i < 
bªks
; i++) {

1019 
”r
 = 
	`sysdev_ü—‹_fe
(&
	`³r_ıu
(
deviû_mû
, 
ıu
),

1020 &
bªk_©Œs
[
i
]);

1021 ià(
”r
)

1022 
”rÜ2
;

1024 
	`ıumask_£t_ıu
(
ıu
, 
mû_deviû_š™Ÿlized
);

1027 
”rÜ2
:

1028 --
i
 >= 0) {

1029 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
, 
ıu
),

1030 &
bªk_©Œs
[
i
]);

1032 
”rÜ
:

1033 --
i
 >= 0) {

1034 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

1035 
mû_©Œibu‹s
[
i
]);

1037 
	`sysdev_uÄegi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

1039  
”r
;

1040 
	}
}

1042 
__ıuš™
 
	$mû_»move_deviû
(
ıu
)

1044 
i
;

1046 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
mû_deviû_š™Ÿlized
))

1049 
i
 = 0; 
mû_©Œibu‹s
[i]; i++)

1050 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

1051 
mû_©Œibu‹s
[
i
]);

1052 
i
 = 0; i < 
bªks
; i++)

1053 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
, 
ıu
),

1054 &
bªk_©Œs
[
i
]);

1055 
	`sysdev_uÄegi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

1056 
	`ıumask_ş—r_ıu
(
ıu
, 
mû_deviû_š™Ÿlized
);

1057 
	}
}

1060 
	$mû_di§bË_ıu
(*
h
)

1062 
i
;

1063 
aùiÚ
 = *(*)
h
;

1065 ià(!
	`mû_avaabË
(&
cu¼’t_ıu_d©a
))

1067 ià(!(
aùiÚ
 & 
CPU_TASKS_FROZEN
))

1068 
	`cmci_ş—r
();

1069 
i
 = 0; i < 
bªks
; i++)

1070 
	`wrm¤l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 0);

1071 
	}
}

1073 
	$mû_»’abË_ıu
(*
h
)

1075 
i
;

1076 
aùiÚ
 = *(*)
h
;

1078 ià(!
	`mû_avaabË
(&
cu¼’t_ıu_d©a
))

1080 ià(!(
aùiÚ
 & 
CPU_TASKS_FROZEN
))

1081 
	`cmci_»’abË
();

1082 
i
 = 0; i < 
bªks
; i++)

1083 
	`wrm¤l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 
bªk
[i]);

1084 
	}
}

1087 
__ıuš™
 
	$mû_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

1088 
aùiÚ
, *
hıu
)

1090 
ıu
 = ()
hıu
;

1091 
tim”_li¡
 *
t
 = &
	`³r_ıu
(
mû_tim”
, 
ıu
);

1093 
aùiÚ
) {

1094 
CPU_ONLINE
:

1095 
CPU_ONLINE_FROZEN
:

1096 
	`mû_ü—‹_deviû
(
ıu
);

1097 ià(
th»shŞd_ıu_ÿÎback
)

1098 
	`th»shŞd_ıu_ÿÎback
(
aùiÚ
, 
ıu
);

1100 
CPU_DEAD
:

1101 
CPU_DEAD_FROZEN
:

1102 ià(
th»shŞd_ıu_ÿÎback
)

1103 
	`th»shŞd_ıu_ÿÎback
(
aùiÚ
, 
ıu
);

1104 
	`mû_»move_deviû
(
ıu
);

1106 
CPU_DOWN_PREPARE
:

1107 
CPU_DOWN_PREPARE_FROZEN
:

1108 
	`d–_tim”_sync
(
t
);

1109 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
mû_di§bË_ıu
, &
aùiÚ
, 1);

1111 
CPU_DOWN_FAILED
:

1112 
CPU_DOWN_FAILED_FROZEN
:

1113 
t
->
expœes
 = 
	`round_jiff›s
(
jiff›s
 +

1114 
	`__g‘_ıu_v¬
(
Ãxt_š‹rv®
));

1115 
	`add_tim”_Ú
(
t
, 
ıu
);

1116 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
mû_»’abË_ıu
, &
aùiÚ
, 1);

1118 
CPU_POST_DEAD
:

1120 
	`cmci_»discov”
(
ıu
);

1123  
NOTIFY_OK
;

1124 
	}
}

1126 
nÙif›r_block
 
mû_ıu_nÙif›r
 
	g__ıuš™d©a
 = {

1127 .
nÙif›r_ÿÎ
 = 
mû_ıu_ÿÎback
,

1130 
__š™
 
	$mû_š™_bªks
()

1132 
i
;

1134 
bªk_©Œs
 = 
	`kz®loc
((
sysdev_©Œibu‹
è* 
bªks
,

1135 
GFP_KERNEL
);

1136 ià(!
bªk_©Œs
)

1137  -
ENOMEM
;

1139 
i
 = 0; i < 
bªks
; i++) {

1140 
sysdev_©Œibu‹
 *
a
 = &
bªk_©Œs
[
i
];

1141 
a
->
©Œ
.
Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "bªk%d", 
i
);

1142 ià(!
a
->
©Œ
.
Çme
)

1143 
nomem
;

1144 
a
->
©Œ
.
mode
 = 0644;

1145 
a
->
show
 = 
show_bªk
;

1146 
a
->
¡Üe
 = 
£t_bªk
;

1150 
nomem
:

1151 --
i
 >= 0)

1152 
	`kä“
(
bªk_©Œs
[
i
].
©Œ
.
Çme
);

1153 
	`kä“
(
bªk_©Œs
);

1154 
bªk_©Œs
 = 
NULL
;

1155  -
ENOMEM
;

1156 
	}
}

1158 
__š™
 
	$mû_š™_deviû
()

1160 
”r
;

1161 
i
 = 0;

1163 ià(!
	`mû_avaabË
(&
boÙ_ıu_d©a
))

1164  -
EIO
;

1166 
	`z®loc_ıumask_v¬
(&
mû_deviû_š™Ÿlized
, 
GFP_KERNEL
);

1168 
”r
 = 
	`mû_š™_bªks
();

1169 ià(
”r
)

1170  
”r
;

1172 
”r
 = 
	`sysdev_şass_»gi¡”
(&
mû_sysşass
);

1173 ià(
”r
)

1174  
”r
;

1176 
	`fÜ_—ch_Úlše_ıu
(
i
) {

1177 
”r
 = 
	`mû_ü—‹_deviû
(
i
);

1178 ià(
”r
)

1179  
”r
;

1182 
	`»gi¡”_hÙıu_nÙif›r
(&
mû_ıu_nÙif›r
);

1183 
	`misc_»gi¡”
(&
mû_log_deviû
);

1184  
”r
;

1185 
	}
}

1187 
deviû_š™ÿÎ
(
mû_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd_64.c

17 
	~<lšux/ıu.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/š‹¼u±.h
>

21 
	~<lšux/kobjeù.h
>

22 
	~<lšux/nÙif›r.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/smp.h
>

25 
	~<lšux/sysdev.h
>

26 
	~<lšux/sysfs.h
>

27 
	~<asm/­ic.h
>

28 
	~<asm/mû.h
>

29 
	~<asm/m¤.h
>

30 
	~<asm/³rıu.h
>

31 
	~<asm/idË.h
>

33 
	#PFX
 "mû_th»shŞd: "

	)

34 
	#VERSION
 "v”siÚ 1.1.1"

	)

35 
	#NR_BANKS
 6

	)

36 
	#NR_BLOCKS
 9

	)

37 
	#THRESHOLD_MAX
 0xFFF

	)

38 
	#INT_TYPE_APIC
 0x00020000

	)

39 
	#MASK_VALID_HI
 0x80000000

	)

40 
	#MASK_CNTP_HI
 0x40000000

	)

41 
	#MASK_LOCKED_HI
 0x20000000

	)

42 
	#MASK_LVTOFF_HI
 0x00F00000

	)

43 
	#MASK_COUNT_EN_HI
 0x00080000

	)

44 
	#MASK_INT_TYPE_HI
 0x00060000

	)

45 
	#MASK_OVERFLOW_HI
 0x00010000

	)

46 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

47 
	#MASK_BLKPTR_LO
 0xFF000000

	)

48 
	#MCG_XBLK_ADDR
 0xC0000400

	)

50 
	sth»shŞd_block
 {

51 
	mblock
;

52 
	mbªk
;

53 
	mıu
;

54 
u32
 
	madd»ss
;

55 
u16
 
	mš‹¼u±_’abË
;

56 
u16
 
	mth»shŞd_lim™
;

57 
kobjeù
 
	mkobj
;

58 
li¡_h—d
 
	mmiscj
;

62 
th»shŞd_block
 
	gth»shŞd_deçuÉs
 = {

63 .
š‹¼u±_’abË
 = 0,

64 .
	gth»shŞd_lim™
 = 
THRESHOLD_MAX
,

67 
	sth»shŞd_bªk
 {

68 
kobjeù
 *
	mkobj
;

69 
th»shŞd_block
 *
	mblocks
;

70 
ıumask_v¬_t
 
	mıus
;

72 
DEFINE_PER_CPU
(
th»shŞd_bªk
 *, 
th»shŞd_bªks
[
NR_BANKS
]);

74 #ifdeà
CONFIG_SMP


75 
	gsh¬ed_bªk
[
NR_BANKS
] = {

80 
DEFINE_PER_CPU
(, 
bªk_m­
);

82 
amd_th»shŞd_š‹¼u±
();

88 
	sth»sh_»¡¬t
 {

89 
th»shŞd_block
 *
	mb
;

90 
	m»£t
;

91 
u16
 
	mŞd_lim™
;

96 
	$th»shŞd_»¡¬t_bªk
(*
_Œ
)

98 
th»sh_»¡¬t
 *
Œ
 = 
_Œ
;

99 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

101 
	`rdm¤
(
Œ
->
b
->
add»ss
, 
mci_misc_lo
, 
mci_misc_hi
);

103 ià(
Œ
->
b
->
th»shŞd_lim™
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

104 
Œ
->
»£t
 = 1;

106 ià(
Œ
->
»£t
) {

107 
mci_misc_hi
 =

108 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

109 (
THRESHOLD_MAX
 - 
Œ
->
b
->
th»shŞd_lim™
);

110 } ià(
Œ
->
Şd_lim™
) {

111 
Ãw_couÁ
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

112 (
Œ
->
Şd_lim™
 -r->
b
->
th»shŞd_lim™
);

113 
mci_misc_hi
 = (mci_misc_h˜& ~
MASK_ERR_COUNT_HI
) |

114 (
Ãw_couÁ
 & 
THRESHOLD_MAX
);

117 
Œ
->
b
->
š‹¼u±_’abË
 ?

118 (
mci_misc_hi
 = (mci_misc_h˜& ~
MASK_INT_TYPE_HI
è| 
INT_TYPE_APIC
) :

119 (
mci_misc_hi
 &ğ~
MASK_INT_TYPE_HI
);

121 
mci_misc_hi
 |ğ
MASK_COUNT_EN_HI
;

122 
	`wrm¤
(
Œ
->
b
->
add»ss
, 
mci_misc_lo
, 
mci_misc_hi
);

123 
	}
}

126 
	$mû_amd_ã©u»_š™
(
ıušfo_x86
 *
c
)

128 
bªk
, 
block
;

129 
ıu
 = 
	`smp_´oûssÜ_id
();

130 
u8
 
lvt_off
;

131 
u32
 
low
 = 0, 
high
 = 0, 
add»ss
 = 0;

132 
th»sh_»¡¬t
 
Œ
;

134 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

135 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

136 ià(
block
 == 0)

137 
add»ss
 = 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4;

138 ià(
block
 == 1) {

139 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

140 ià(!
add»ss
)

142 
add»ss
 +ğ
MCG_XBLK_ADDR
;

145 ++
add»ss
;

147 ià(
	`rdm¤_§ã
(
add»ss
, &
low
, &
high
))

150 ià(!(
high
 & 
MASK_VALID_HI
)) {

151 ià(
block
)

157 ià(!(
high
 & 
MASK_CNTP_HI
) ||

158 (
high
 & 
MASK_LOCKED_HI
))

161 ià(!
block
)

162 
	`³r_ıu
(
bªk_m­
, 
ıu
è|ğ(1 << 
bªk
);

163 #ifdeà
CONFIG_SMP


164 ià(
sh¬ed_bªk
[
bªk
] && 
c
->
ıu_cÜe_id
)

167 
lvt_off
 = 
	`£tup_APIC_evt_mû
(
THRESHOLD_APIC_VECTOR
,

168 
APIC_EILVT_MSG_FIX
, 0);

170 
high
 &ğ~
MASK_LVTOFF_HI
;

171 
high
 |ğ
lvt_off
 << 20;

172 
	`wrm¤
(
add»ss
, 
low
, 
high
);

174 
th»shŞd_deçuÉs
.
add»ss
 =‡ddress;

175 
Œ
.
b
 = &
th»shŞd_deçuÉs
;

176 
Œ
.
»£t
 = 0;

177 
Œ
.
Şd_lim™
 = 0;

178 
	`th»shŞd_»¡¬t_bªk
(&
Œ
);

180 
mû_th»shŞd_veùÜ
 = 
amd_th»shŞd_š‹¼u±
;

183 
	}
}

194 
	$amd_th»shŞd_š‹¼u±
()

196 
bªk
, 
block
;

197 
mû
 
m
;

198 
u32
 
low
 = 0, 
high
 = 0, 
add»ss
 = 0;

200 
	`mû_£tup
(&
m
);

203 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

204 ià(!(
	`³r_ıu
(
bªk_m­
, 
m
.
ıu
è& (1 << 
bªk
)))

206 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

207 ià(
block
 == 0)

208 
add»ss
 = 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4;

209 ià(
block
 == 1) {

210 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

211 ià(!
add»ss
)

213 
add»ss
 +ğ
MCG_XBLK_ADDR
;

216 ++
add»ss
;

218 ià(
	`rdm¤_§ã
(
add»ss
, &
low
, &
high
))

221 ià(!(
high
 & 
MASK_VALID_HI
)) {

222 ià(
block
)

228 ià(!(
high
 & 
MASK_CNTP_HI
) ||

229 (
high
 & 
MASK_LOCKED_HI
))

234 
	`machše_check_pŞl
(
MCP_TIMESTAMP
,

235 &
	`__g‘_ıu_v¬
(
mû_pŞl_bªks
));

237 ià(
high
 & 
MASK_OVERFLOW_HI
) {

238 
	`rdm¤l
(
add»ss
, 
m
.
misc
);

239 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
 + 
bªk
 * 4,

240 
m
.
¡©us
);

241 
m
.
bªk
 = 
K8_MCE_THRESHOLD_BASE


242 + 
bªk
 * 
NR_BLOCKS


243 + 
block
;

244 
	`mû_log
(&
m
);

249 
	}
}

255 
	sth»shŞd_©Œ
 {

256 
©Œibu‹
 
	m©Œ
;

257 
ssize_t
(*
show
è(
	mth»shŞd_block
 *, *);

258 
ssize_t
(*
¡Üe
è(
	mth»shŞd_block
 *, cÚ¡ *, 
size_t
 
	mcouÁ
);

261 
	#SHOW_FIELDS
(
Çme
) \

262 
ssize_t
 
show_
 ## 
	`Çme
(
th»shŞd_block
 * 
b
, *
buf
) \

264  
	`¥rštf
(
buf
, "%lx\n", (è
b
->
Çme
); \

265 }

	)

266 
	$SHOW_FIELDS
(
š‹¼u±_’abË
)

267 
	$SHOW_FIELDS
(
th»shŞd_lim™
)

269 
ssize_t
 
	$¡Üe_š‹¼u±_’abË
(
th»shŞd_block
 *
b
,

270 cÚ¡ *
buf
, 
size_t
 
couÁ
)

272 *
’d
;

273 
th»sh_»¡¬t
 
Œ
;

274 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0);

275 ià(
’d
 =ğ
buf
)

276  -
EINVAL
;

277 
b
->
š‹¼u±_’abË
 = !!
Ãw
;

279 
Œ
.
b
 = b;

280 
Œ
.
»£t
 = 0;

281 
Œ
.
Şd_lim™
 = 0;

282 
	`smp_ÿÎ_funùiÚ_sšgË
(
b
->
ıu
, 
th»shŞd_»¡¬t_bªk
, &
Œ
, 1);

284  
’d
 - 
buf
;

285 
	}
}

287 
ssize_t
 
	$¡Üe_th»shŞd_lim™
(
th»shŞd_block
 *
b
,

288 cÚ¡ *
buf
, 
size_t
 
couÁ
)

290 *
’d
;

291 
th»sh_»¡¬t
 
Œ
;

292 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0);

293 ià(
’d
 =ğ
buf
)

294  -
EINVAL
;

295 ià(
Ãw
 > 
THRESHOLD_MAX
)

296 
Ãw
 = 
THRESHOLD_MAX
;

297 ià(
Ãw
 < 1)

298 
Ãw
 = 1;

299 
Œ
.
Şd_lim™
 = 
b
->
th»shŞd_lim™
;

300 
b
->
th»shŞd_lim™
 = 
Ãw
;

301 
Œ
.
b
 = b;

302 
Œ
.
»£t
 = 0;

304 
	`smp_ÿÎ_funùiÚ_sšgË
(
b
->
ıu
, 
th»shŞd_»¡¬t_bªk
, &
Œ
, 1);

306  
’d
 - 
buf
;

307 
	}
}

309 
	sth»shŞd_block_üoss_ıu
 {

310 
th»shŞd_block
 *
	mtb
;

311 
	m»tv®
;

314 
	$loÿl_”rÜ_couÁ_hªdËr
(*
_tbcc
)

316 
th»shŞd_block_üoss_ıu
 *
tbcc
 = 
_tbcc
;

317 
th»shŞd_block
 *
b
 = 
tbcc
->
tb
;

318 
u32
 
low
, 
high
;

320 
	`rdm¤
(
b
->
add»ss
, 
low
, 
high
);

321 
tbcc
->
»tv®
 = (
high
 & 0xFFFè- (
THRESHOLD_MAX
 - 
b
->
th»shŞd_lim™
);

322 
	}
}

324 
ssize_t
 
	$show_”rÜ_couÁ
(
th»shŞd_block
 *
b
, *
buf
)

326 
th»shŞd_block_üoss_ıu
 
tbcc
 = { .
tb
 = 
b
, };

328 
	`smp_ÿÎ_funùiÚ_sšgË
(
b
->
ıu
, 
loÿl_”rÜ_couÁ_hªdËr
, &
tbcc
, 1);

329  
	`¥rštf
(
buf
, "%lx\n", 
tbcc
.
»tv®
);

330 
	}
}

332 
ssize_t
 
	$¡Üe_”rÜ_couÁ
(
th»shŞd_block
 *
b
,

333 cÚ¡ *
buf
, 
size_t
 
couÁ
)

335 
th»sh_»¡¬t
 
Œ
 = { .
b
 = b, .
»£t
 = 1, .
Şd_lim™
 = 0 };

337 
	`smp_ÿÎ_funùiÚ_sšgË
(
b
->
ıu
, 
th»shŞd_»¡¬t_bªk
, &
Œ
, 1);

339 
	}
}

341 
	#THRESHOLD_ATTR
(
_Çme
,
_mode
,
_show
,
_¡Üe
) { \

342 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

343 .
show
 = 
_show
, \

344 .
¡Üe
 = 
_¡Üe
, \

345 };

	)

347 
	#RW_ATTR
(
Çme
) \

348 
th»shŞd_©Œ
 
Çme
 = \

349 
	`THRESHOLD_ATTR
(
Çme
, 0644, 
show_
##‚ame, 
¡Üe_
##‚ame)

	)

351 
RW_ATTR
(
š‹¼u±_’abË
);

352 
RW_ATTR
(
th»shŞd_lim™
);

353 
RW_ATTR
(
”rÜ_couÁ
);

355 
©Œibu‹
 *
	gdeçuÉ_©Œs
[] = {

356 &
š‹¼u±_’abË
.
©Œ
,

357 &
th»shŞd_lim™
.
©Œ
,

358 &
”rÜ_couÁ
.
©Œ
,

359 
NULL


362 
	#to_block
(
k
è
	`cÚš”_of
(k, 
th»shŞd_block
, 
kobj
)

	)

363 
	#to_©Œ
(
a
è
	`cÚš”_of
×, 
th»shŞd_©Œ
, 
©Œ
)

	)

365 
ssize_t
 
	$show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

367 
th»shŞd_block
 *
b
 = 
	`to_block
(
kobj
);

368 
th»shŞd_©Œ
 *
a
 = 
	`to_©Œ
(
©Œ
);

369 
ssize_t
 
»t
;

370 
»t
 = 
a
->
show
 ?‡->
	`show
(
b
, 
buf
è: -
EIO
;

371  
»t
;

372 
	}
}

374 
ssize_t
 
	$¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

375 cÚ¡ *
buf
, 
size_t
 
couÁ
)

377 
th»shŞd_block
 *
b
 = 
	`to_block
(
kobj
);

378 
th»shŞd_©Œ
 *
a
 = 
	`to_©Œ
(
©Œ
);

379 
ssize_t
 
»t
;

380 
»t
 = 
a
->
¡Üe
 ?‡->
	`¡Üe
(
b
, 
buf
, 
couÁ
è: -
EIO
;

381  
»t
;

382 
	}
}

384 
sysfs_İs
 
	gth»shŞd_İs
 = {

385 .
show
 = show,

386 .
	g¡Üe
 = 
¡Üe
,

389 
kobj_ty³
 
	gth»shŞd_kty³
 = {

390 .
sysfs_İs
 = &
th»shŞd_İs
,

391 .
	gdeçuÉ_©Œs
 = 
deçuÉ_©Œs
,

394 
__ıuš™
 
	$®loÿ‹_th»shŞd_blocks
(
ıu
,

395 
bªk
,

396 
block
,

397 
u32
 
add»ss
)

399 
”r
;

400 
u32
 
low
, 
high
;

401 
th»shŞd_block
 *
b
 = 
NULL
;

403 ià((
bªk
 >ğ
NR_BANKS
è|| (
block
 >ğ
NR_BLOCKS
))

406 ià(
	`rdm¤_§ã_Ú_ıu
(
ıu
, 
add»ss
, &
low
, &
high
))

409 ià(!(
high
 & 
MASK_VALID_HI
)) {

410 ià(
block
)

411 
»cur£
;

416 ià(!(
high
 & 
MASK_CNTP_HI
) ||

417 (
high
 & 
MASK_LOCKED_HI
))

418 
»cur£
;

420 
b
 = 
	`kz®loc
((
th»shŞd_block
), 
GFP_KERNEL
);

421 ià(!
b
)

422  -
ENOMEM
;

424 
b
->
block
 = block;

425 
b
->
bªk
 = bank;

426 
b
->
ıu
 = cpu;

427 
b
->
add»ss
 =‡ddress;

428 
b
->
š‹¼u±_’abË
 = 0;

429 
b
->
th»shŞd_lim™
 = 
THRESHOLD_MAX
;

431 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

433 ià(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
)

434 
	`li¡_add
(&
b
->
miscj
,

435 &
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
->
miscj
);

437 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
 = 
b
;

439 
”r
 = 
	`kobjeù_š™_ªd_add
(&
b
->
kobj
, &
th»shŞd_kty³
,

440 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
kobj
,

441 "misc%i", 
block
);

442 ià(
”r
)

443 
out_ä“
;

444 
»cur£
:

445 ià(!
block
) {

446 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

447 ià(!
add»ss
)

449 
add»ss
 +ğ
MCG_XBLK_ADDR
;

451 ++
add»ss
;

453 
”r
 = 
	`®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
, ++
block
, 
add»ss
);

454 ià(
”r
)

455 
out_ä“
;

457 ià(
b
)

458 
	`kobjeù_uev’t
(&
b
->
kobj
, 
KOBJ_ADD
);

460  
”r
;

462 
out_ä“
:

463 ià(
b
) {

464 
	`kobjeù_put
(&
b
->
kobj
);

465 
	`kä“
(
b
);

467  
”r
;

468 
	}
}

470 
__ıuš™
 

471 
	$loÿl_®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
)

473  
	`®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
, 0,

474 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4);

475 
	}
}

478 
__ıuš™
 
	$th»shŞd_ü—‹_bªk
(
ıu
, 
bªk
)

480 
i
, 
”r
 = 0;

481 
th»shŞd_bªk
 *
b
 = 
NULL
;

482 
Çme
[32];

484 
	`¥rštf
(
Çme
, "th»shŞd_bªk%i", 
bªk
);

486 #ifdeà
CONFIG_SMP


487 ià(
	`ıu_d©a
(
ıu
).
ıu_cÜe_id
 && 
sh¬ed_bªk
[
bªk
]) {

488 
i
 = 
	`ıumask_fœ¡
(
	`ıu_cÜe_mask
(
ıu
));

491 ià(
	`ıu_d©a
(
i
).
ıu_cÜe_id
)

492 
out
;

495 ià(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
])

496 
out
;

498 
b
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
];

500 ià(!
b
)

501 
out
;

503 
”r
 = 
	`sysfs_ü—‹_lšk
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
,

504 
b
->
kobj
, 
Çme
);

505 ià(
”r
)

506 
out
;

508 
	`ıumask_cİy
(
b
->
ıus
, 
	`ıu_cÜe_mask
(
ıu
));

509 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
b
;

510 
out
;

514 
b
 = 
	`kz®loc
((
th»shŞd_bªk
), 
GFP_KERNEL
);

515 ià(!
b
) {

516 
”r
 = -
ENOMEM
;

517 
out
;

519 ià(!
	`®loc_ıumask_v¬
(&
b
->
ıus
, 
GFP_KERNEL
)) {

520 
	`kä“
(
b
);

521 
”r
 = -
ENOMEM
;

522 
out
;

525 
b
->
kobj
 = 
	`kobjeù_ü—‹_ªd_add
(
Çme
, &
	`³r_ıu
(
deviû_mû
, 
ıu
).kobj);

526 ià(!
b
->
kobj
)

527 
out_ä“
;

529 #iâdeà
CONFIG_SMP


530 
	`ıumask_£Î
(
b
->
ıus
);

532 
	`ıumask_cİy
(
b
->
ıus
, 
	`ıu_cÜe_mask
(
ıu
));

535 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
b
;

537 
”r
 = 
	`loÿl_®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
);

538 ià(
”r
)

539 
out_ä“
;

541 
	`fÜ_—ch_ıu
(
i
, 
b
->
ıus
) {

542 ià(
i
 =ğ
ıu
)

545 
”r
 = 
	`sysfs_ü—‹_lšk
(&
	`³r_ıu
(
deviû_mû
, 
i
).
kobj
,

546 
b
->
kobj
, 
Çme
);

547 ià(
”r
)

548 
out
;

550 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
] = 
b
;

553 
out
;

555 
out_ä“
:

556 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

557 
	`ä“_ıumask_v¬
(
b
->
ıus
);

558 
	`kä“
(
b
);

559 
out
:

560  
”r
;

561 
	}
}

564 
__ıuš™
 
	$th»shŞd_ü—‹_deviû
(
ıu
)

566 
bªk
;

567 
”r
 = 0;

569 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

570 ià(!(
	`³r_ıu
(
bªk_m­
, 
ıu
è& (1 << 
bªk
)))

572 
”r
 = 
	`th»shŞd_ü—‹_bªk
(
ıu
, 
bªk
);

573 ià(
”r
)

574 
out
;

576 
out
:

577  
”r
;

578 
	}
}

586 
	$d—Îoÿ‹_th»shŞd_block
(
ıu
,

587 
bªk
)

589 
th»shŞd_block
 *
pos
 = 
NULL
;

590 
th»shŞd_block
 *
tmp
 = 
NULL
;

591 
th»shŞd_bªk
 *
h—d
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
];

593 ià(!
h—d
)

596 
	`li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
tmp
, &
h—d
->
blocks
->
miscj
, miscj) {

597 
	`kobjeù_put
(&
pos
->
kobj
);

598 
	`li¡_d–
(&
pos
->
miscj
);

599 
	`kä“
(
pos
);

602 
	`kä“
(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
);

603 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
 = 
NULL
;

604 
	}
}

606 
	$th»shŞd_»move_bªk
(
ıu
, 
bªk
)

608 
i
 = 0;

609 
th»shŞd_bªk
 *
b
;

610 
Çme
[32];

612 
b
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
];

614 ià(!
b
)

617 ià(!
b
->
blocks
)

618 
ä“_out
;

620 
	`¥rštf
(
Çme
, "th»shŞd_bªk%i", 
bªk
);

622 #ifdeà
CONFIG_SMP


624 ià(
sh¬ed_bªk
[
bªk
] && 
b
->
blocks
->
ıu
 != cpu) {

625 
	`sysfs_»move_lšk
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
, 
Çme
);

626 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

632 
	`fÜ_—ch_ıu
(
i
, 
b
->
ıus
) {

633 ià(
i
 =ğ
ıu
)

636 
	`sysfs_»move_lšk
(&
	`³r_ıu
(
deviû_mû
, 
i
).
kobj
, 
Çme
);

637 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
] = 
NULL
;

640 
	`d—Îoÿ‹_th»shŞd_block
(
ıu
, 
bªk
);

642 
ä“_out
:

643 
	`kobjeù_d–
(
b
->
kobj
);

644 
	`kobjeù_put
(
b
->
kobj
);

645 
	`ä“_ıumask_v¬
(
b
->
ıus
);

646 
	`kä“
(
b
);

647 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

648 
	}
}

650 
	$th»shŞd_»move_deviû
(
ıu
)

652 
bªk
;

654 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

655 ià(!(
	`³r_ıu
(
bªk_m­
, 
ıu
è& (1 << 
bªk
)))

657 
	`th»shŞd_»move_bªk
(
ıu
, 
bªk
);

659 
	}
}

662 
__ıuš™
 
	$amd_64_th»shŞd_ıu_ÿÎback
(
aùiÚ
,

663 
ıu
)

665 ià(
ıu
 >ğ
NR_CPUS
)

668 
aùiÚ
) {

669 
CPU_ONLINE
:

670 
CPU_ONLINE_FROZEN
:

671 
	`th»shŞd_ü—‹_deviû
(
ıu
);

673 
CPU_DEAD
:

674 
CPU_DEAD_FROZEN
:

675 
	`th»shŞd_»move_deviû
(
ıu
);

680 
	}
}

682 
__š™
 
	$th»shŞd_š™_deviû
()

684 
lıu
 = 0;

687 
	`fÜ_—ch_Úlše_ıu
(
lıu
) {

688 
”r
 = 
	`th»shŞd_ü—‹_deviû
(
lıu
);

689 ià(
”r
)

690  
”r
;

692 
th»shŞd_ıu_ÿÎback
 = 
amd_64_th»shŞd_ıu_ÿÎback
;

694 
	}
}

696 
deviû_š™ÿÎ
(
th»shŞd_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel_64.c

8 
	~<lšux/š™.h
>

9 
	~<lšux/š‹¼u±.h
>

10 
	~<lšux/³rıu.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/­ic.h
>

13 
	~<asm/m¤.h
>

14 
	~<asm/mû.h
>

15 
	~<asm/hw_œq.h
>

16 
	~<asm/idË.h
>

17 
	~<asm/th”m_thrÙ.h
>

18 
	~<asm/­ic.h
>

20 
asmlškage
 
	$smp_th”m®_š‹¼u±
()

22 
__u64
 
m¤_v®
;

24 
	`ack_APIC_œq
();

26 
	`ex™_idË
();

27 
	`œq_’‹r
();

29 
	`rdm¤l
(
MSR_IA32_THERM_STATUS
, 
m¤_v®
);

30 ià(
	`th”m_thrÙ_´oûss
(
m¤_v®
 & 1))

31 
	`mû_log_th”m_thrÙ_ev’t
(
m¤_v®
);

33 
	`šc_œq_¡©
(
œq_th”m®_couÁ
);

34 
	`œq_ex™
();

35 
	}
}

37 
	$š‹l_š™_th”m®
(
ıušfo_x86
 *
c
)

39 
u32
 
l
, 
h
;

40 
tm2
 = 0;

41 
ıu
 = 
	`smp_´oûssÜ_id
();

43 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACPI
))

46 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACC
))

53 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

54 
h
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

55 ià((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
è&& (
h
 & 
APIC_DM_SMI
)) {

56 
	`´štk
(
KERN_DEBUG


57 "CPU%d: Th”m® mÚ™Üšg hªdËd by SMI\n", 
ıu
);

61 ià(
	`ıu_has
(
c
, 
X86_FEATURE_TM2
è&& (
l
 & 
MSR_IA32_MISC_ENABLE_TM2
))

62 
tm2
 = 1;

64 ià(
h
 & 
APIC_VECTOR_MASK
) {

65 
	`´štk
(
KERN_DEBUG


67 "š¡®Ëd\n", 
ıu
, (
h
 & 
APIC_VECTOR_MASK
));

71 
h
 = 
THERMAL_APIC_VECTOR
;

72 
h
 |ğ(
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
);

73 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
h
);

75 
	`rdm¤
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

76 
	`wrm¤
(
MSR_IA32_THERM_INTERRUPT
, 
l
 | 0x03, 
h
);

78 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

79 
	`wrm¤
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

81 
l
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

82 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

83 
	`´štk
(
KERN_INFO
 "CPU%d: Thermal monitoringƒnabled (%s)\n",

84 
ıu
, 
tm2
 ? "TM2" : "TM1");

87 
	`©omic_£t
(&
th”m_thrÙ_’
, 1);

89 
	}
}

98 
DEFINE_PER_CPU
(
mû_bªks_t
, 
mû_bªks_owÃd
);

104 
DEFINE_SPINLOCK
(
cmci_discov”_lock
);

106 
	#CMCI_THRESHOLD
 1

	)

108 
	$cmci_suµÜ‹d
(*
bªks
)

110 
u64
 
ÿp
;

117 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
)

119 ià(!
ıu_has_­ic
 || 
	`Ïpic_g‘_maxlvt
() < 6)

121 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
ÿp
);

122 *
bªks
 = 
	`mš_t
(, 
MAX_NR_BANKS
, 
ÿp
 & 0xff);

123  !!(
ÿp
 & 
MCG_CMCI_P
);

124 
	}
}

132 
	$š‹l_th»shŞd_š‹¼u±
()

134 
	`machše_check_pŞl
(
MCP_TIMESTAMP
, &
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

135 
	`mû_nÙify_u£r
();

136 
	}
}

138 
	$´št_upd©e
(*
ty³
, *
hdr
, 
num
)

140 ià(*
hdr
 == 0)

141 
	`´štk
(
KERN_INFO
 "CPU %d MCA bªks", 
	`smp_´oûssÜ_id
());

142 *
hdr
 = 1;

143 
	`´štk
(
KERN_CONT
 " %s:%d", 
ty³
, 
num
);

144 
	}
}

151 
	$cmci_discov”
(
bªks
, 
boÙ
)

153 *
owÃd
 = (*)&
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
);

154 
æags
;

155 
hdr
 = 0;

156 
i
;

158 
	`¥š_lock_œq§ve
(&
cmci_discov”_lock
, 
æags
);

159 
i
 = 0; i < 
bªks
; i++) {

160 
u64
 
v®
;

162 ià(
	`‹¡_b™
(
i
, 
owÃd
))

165 
	`rdm¤l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
v®
);

168 ià(
v®
 & 
CMCI_EN
) {

169 ià(
	`‹¡_ªd_ş—r_b™
(
i
, 
owÃd
è|| 
boÙ
)

170 
	`´št_upd©e
("SHD", &
hdr
, 
i
);

171 
	`__ş—r_b™
(
i
, 
	`__g‘_ıu_v¬
(
mû_pŞl_bªks
));

175 
v®
 |ğ
CMCI_EN
 | 
CMCI_THRESHOLD
;

176 
	`wrm¤l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
v®
);

177 
	`rdm¤l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
v®
);

180 ià(
v®
 & 
CMCI_EN
) {

181 ià(!
	`‹¡_ªd_£t_b™
(
i
, 
owÃd
è|| 
boÙ
)

182 
	`´št_upd©e
("CMCI", &
hdr
, 
i
);

183 
	`__ş—r_b™
(
i
, 
	`__g‘_ıu_v¬
(
mû_pŞl_bªks
));

185 
	`WARN_ON
(!
	`‹¡_b™
(
i
, 
	`__g‘_ıu_v¬
(
mû_pŞl_bªks
)));

188 
	`¥š_uÆock_œq»¡Üe
(&
cmci_discov”_lock
, 
æags
);

189 ià(
hdr
)

190 
	`´štk
(
KERN_CONT
 "\n");

191 
	}
}

197 
	$cmci_»check
()

199 
æags
;

200 
bªks
;

202 ià(!
	`mû_avaabË
(&
cu¼’t_ıu_d©a
è|| !
	`cmci_suµÜ‹d
(&
bªks
))

204 
	`loÿl_œq_§ve
(
æags
);

205 
	`machše_check_pŞl
(
MCP_TIMESTAMP
, &
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

206 
	`loÿl_œq_»¡Üe
(
æags
);

207 
	}
}

213 
	$cmci_ş—r
()

215 
æags
;

216 
i
;

217 
bªks
;

218 
u64
 
v®
;

220 ià(!
	`cmci_suµÜ‹d
(&
bªks
))

222 
	`¥š_lock_œq§ve
(&
cmci_discov”_lock
, 
æags
);

223 
i
 = 0; i < 
bªks
; i++) {

224 ià(!
	`‹¡_b™
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
)))

227 
	`rdm¤l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
v®
);

228 
v®
 &ğ~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

229 
	`wrm¤l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
v®
);

230 
	`__ş—r_b™
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

232 
	`¥š_uÆock_œq»¡Üe
(&
cmci_discov”_lock
, 
æags
);

233 
	}
}

239 
	$cmci_»discov”
(
dyšg
)

241 
bªks
;

242 
ıu
;

243 
ıumask_v¬_t
 
Şd
;

245 ià(!
	`cmci_suµÜ‹d
(&
bªks
))

247 ià(!
	`®loc_ıumask_v¬
(&
Şd
, 
GFP_KERNEL
))

249 
	`ıumask_cİy
(
Şd
, &
cu¼’t
->
ıus_®lowed
);

251 
	`fÜ_—ch_Úlše_ıu
 (
ıu
) {

252 ià(
ıu
 =ğ
dyšg
)

254 ià(
	`£t_ıus_®lowed_±r
(
cu¼’t
, 
	`ıumask_of
(
ıu
)))

257 ià(
	`cmci_suµÜ‹d
(&
bªks
))

258 
	`cmci_discov”
(
bªks
, 0);

261 
	`£t_ıus_®lowed_±r
(
cu¼’t
, 
Şd
);

262 
	`ä“_ıumask_v¬
(
Şd
);

263 
	}
}

268 
	$cmci_»’abË
()

270 
bªks
;

271 ià(
	`cmci_suµÜ‹d
(&
bªks
))

272 
	`cmci_discov”
(
bªks
, 0);

273 
	}
}

275 
	$š‹l_š™_cmci
()

277 
bªks
;

279 ià(!
	`cmci_suµÜ‹d
(&
bªks
))

282 
mû_th»shŞd_veùÜ
 = 
š‹l_th»shŞd_š‹¼u±
;

283 
	`cmci_discov”
(
bªks
, 1);

290 
	`­ic_wr™e
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

291 
	`cmci_»check
();

292 
	}
}

294 
	$mû_š‹l_ã©u»_š™
(
ıušfo_x86
 *
c
)

296 
	`š‹l_š™_th”m®
(
c
);

297 
	`š‹l_š™_cmci
();

298 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

17 
	~<lšux/³rıu.h
>

18 
	~<lšux/sysdev.h
>

19 
	~<lšux/ıu.h
>

20 
	~<asm/ıu.h
>

21 
	~<lšux/nÙif›r.h
>

22 
	~<lšux/jiff›s.h
>

23 
	~<asm/th”m_thrÙ.h
>

26 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

28 
DEFINE_PER_CPU
(
__u64
, 
Ãxt_check
èğ
INITIAL_JIFFIES
;

29 
DEFINE_PER_CPU
(, 
th”m®_thrÙe_couÁ
);

30 
©omic_t
 
	gth”m_thrÙ_’
 = 
ATOMIC_INIT
(0);

32 #ifdeà
CONFIG_SYSFS


33 
	#defše_th”m_thrÙ_sysdev_Úe_ro
(
_Çme
) \

34 
	`SYSDEV_ATTR
(
_Çme
, 0444, 
th”m_thrÙ_sysdev_show_
##_Çme, 
NULL
)

	)

36 
	#defše_th”m_thrÙ_sysdev_show_func
(
Çme
) \

37 
ssize_t
 
th”m_thrÙ_sysdev_show_
##
	`Çme
(
sys_deviû
 *
dev
, \

38 
sysdev_©Œibu‹
 *
©Œ
, \

39 *
buf
) \

41 
ıu
 = 
dev
->
id
; \

42 
ssize_t
 
»t
; \

44 
	`´“m±_di§bË
(); \

45 ià(
	`ıu_Úlše
(
ıu
)) \

46 
»t
 = 
	`¥rštf
(
buf
, "%lu\n", \

47 
	`³r_ıu
(
th”m®_thrÙe_
##
Çme
, 
ıu
)); \

49 
»t
 = 0; \

50 
	`´“m±_’abË
(); \

52  
»t
; \

53 }

	)

55 
defše_th”m_thrÙ_sysdev_show_func
(
couÁ
);

56 
defše_th”m_thrÙ_sysdev_Úe_ro
(
couÁ
);

58 
©Œibu‹
 *
	gth”m®_thrÙe_©Œs
[] = {

59 &
©Œ_couÁ
.
©Œ
,

60 
NULL


63 
©Œibu‹_group
 
	gth”m®_thrÙe_©Œ_group
 = {

64 .
©Œs
 = 
th”m®_thrÙe_©Œs
,

65 .
	gÇme
 = "thermal_throttle"

85 
	$th”m_thrÙ_´oûss
(
cu¼
)

87 
ıu
 = 
	`smp_´oûssÜ_id
();

88 
__u64
 
tmp_jiffs
 = 
	`g‘_jiff›s_64
();

90 ià(
cu¼
)

91 
	`__g‘_ıu_v¬
(
th”m®_thrÙe_couÁ
)++;

93 ià(
	`time_befÜe64
(
tmp_jiffs
, 
	`__g‘_ıu_v¬
(
Ãxt_check
)))

96 
	`__g‘_ıu_v¬
(
Ãxt_check
èğ
tmp_jiffs
 + 
CHECK_INTERVAL
;

99 ià(
cu¼
) {

100 
	`´štk
(
KERN_CRIT
 "CPU%d: Temperature‡bovehreshold, "

101 "ıu clockhrÙed (tÙ®ƒv’t ğ%lu)\n", 
ıu
,

102 
	`__g‘_ıu_v¬
(
th”m®_thrÙe_couÁ
));

104 
	`add_št
(
TAINT_MACHINE_CHECK
);

106 
	`´štk
(
KERN_CRIT
 "CPU%d: Tem³¿tu»/¥“d‚Üm®\n", 
ıu
);

110 
	}
}

112 #ifdeà
CONFIG_SYSFS


114 
__ıuš™
 
	$th”m®_thrÙe_add_dev
(
sys_deviû
 *
sys_dev
)

116  
	`sysfs_ü—‹_group
(&
sys_dev
->
kobj
, &
th”m®_thrÙe_©Œ_group
);

117 
	}
}

119 
__ıuš™
 
	$th”m®_thrÙe_»move_dev
(
sys_deviû
 *
sys_dev
)

121 
	`sysfs_»move_group
(&
sys_dev
->
kobj
, &
th”m®_thrÙe_©Œ_group
);

122 
	}
}

125 
DEFINE_MUTEX
(
th”m_ıu_lock
);

128 
__ıuš™
 
	$th”m®_thrÙe_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

129 
aùiÚ
,

130 *
hıu
)

132 
ıu
 = ()
hıu
;

133 
sys_deviû
 *
sys_dev
;

134 
”r
 = 0;

136 
sys_dev
 = 
	`g‘_ıu_sysdev
(
ıu
);

137 
aùiÚ
) {

138 
CPU_UP_PREPARE
:

139 
CPU_UP_PREPARE_FROZEN
:

140 
	`mu‹x_lock
(&
th”m_ıu_lock
);

141 
”r
 = 
	`th”m®_thrÙe_add_dev
(
sys_dev
);

142 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

143 
	`WARN_ON
(
”r
);

145 
CPU_UP_CANCELED
:

146 
CPU_UP_CANCELED_FROZEN
:

147 
CPU_DEAD
:

148 
CPU_DEAD_FROZEN
:

149 
	`mu‹x_lock
(&
th”m_ıu_lock
);

150 
	`th”m®_thrÙe_»move_dev
(
sys_dev
);

151 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

154  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

155 
	}
}

157 
nÙif›r_block
 
th”m®_thrÙe_ıu_nÙif›r
 
	g__ıuš™d©a
 =

159 .
nÙif›r_ÿÎ
 = 
th”m®_thrÙe_ıu_ÿÎback
,

162 
__š™
 
	$th”m®_thrÙe_š™_deviû
()

164 
ıu
 = 0;

165 
”r
;

167 ià(!
	`©omic_»ad
(&
th”m_thrÙ_’
))

170 
	`»gi¡”_hÙıu_nÙif›r
(&
th”m®_thrÙe_ıu_nÙif›r
);

172 #ifdeà
CONFIG_HOTPLUG_CPU


173 
	`mu‹x_lock
(&
th”m_ıu_lock
);

176 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

177 
”r
 = 
	`th”m®_thrÙe_add_dev
(
	`g‘_ıu_sysdev
(
ıu
));

178 
	`WARN_ON
(
”r
);

180 #ifdeà
CONFIG_HOTPLUG_CPU


181 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

185 
	}
}

187 
deviû_š™ÿÎ
(
th”m®_thrÙe_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<lšux/š‹¼u±.h
>

5 
	~<lšux/k”Ãl.h
>

7 
	~<asm/œq_veùÜs.h
>

8 
	~<asm/­ic.h
>

9 
	~<asm/idË.h
>

10 
	~<asm/mû.h
>

12 
	$deçuÉ_th»shŞd_š‹¼u±
()

14 
	`´štk
(
KERN_ERR
 "Unexpectedhreshold interrupt‡t vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
mû_th»shŞd_veùÜ
)(èğ
deçuÉ_th»shŞd_š‹¼u±
;

20 
asmlškage
 
	$mû_th»shŞd_š‹¼u±
()

22 
	`ex™_idË
();

23 
	`œq_’‹r
();

24 
	`šc_œq_¡©
(
œq_th»shŞd_couÁ
);

25 
	`mû_th»shŞd_veùÜ
();

26 
	`œq_ex™
();

28 
	`ack_APIC_œq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<lšux/moduË.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/pci.h
>

23 
	~<lšux/smp.h
>

24 
	~<lšux/ıu.h
>

25 
	~<lšux/mu‹x.h
>

26 
	~<lšux/sÜt.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/mŒr.h
>

30 
	~<asm/uacûss.h
>

31 
	~<asm/´oûssÜ.h
>

32 
	~<asm/m¤.h
>

33 
	~<asm/kvm_·¿.h
>

34 
	~"mŒr.h
"

37 
	#RANGE_NUM
 256

	)

39 
	s»s_¿nge
 {

40 
	m¡¬t
;

41 
	m’d
;

44 
__š™


45 
	$add_¿nge
(
»s_¿nge
 *
¿nge
, 
Ä_¿nge
, 
¡¬t
,

46 
’d
)

49 ià(
Ä_¿nge
 >ğ
RANGE_NUM
)

50  
Ä_¿nge
;

52 
¿nge
[
Ä_¿nge
].
¡¬t
 = start;

53 
¿nge
[
Ä_¿nge
].
’d
 =ƒnd;

55 
Ä_¿nge
++;

57  
Ä_¿nge
;

58 
	}
}

60 
__š™


61 
	$add_¿nge_w™h_m”ge
(
»s_¿nge
 *
¿nge
, 
Ä_¿nge
, 
¡¬t
,

62 
’d
)

64 
i
;

67 
i
 = 0; i < 
Ä_¿nge
; i++) {

68 
fš®_¡¬t
, 
fš®_’d
;

69 
commÚ_¡¬t
, 
commÚ_’d
;

71 ià(!
¿nge
[
i
].
’d
)

74 
commÚ_¡¬t
 = 
	`max
(
¿nge
[
i
].
¡¬t
, start);

75 
commÚ_’d
 = 
	`mš
(
¿nge
[
i
].
’d
,ƒnd);

76 ià(
commÚ_¡¬t
 > 
commÚ_’d
 + 1)

79 
fš®_¡¬t
 = 
	`mš
(
¿nge
[
i
].
¡¬t
, start);

80 
fš®_’d
 = 
	`max
(
¿nge
[
i
].
’d
,ƒnd);

82 
¿nge
[
i
].
¡¬t
 = 
fš®_¡¬t
;

83 
¿nge
[
i
].
’d
 = 
fš®_’d
;

84  
Ä_¿nge
;

88  
	`add_¿nge
(
¿nge
, 
Ä_¿nge
, 
¡¬t
, 
’d
);

89 
	}
}

91 
__š™


92 
	$subŒaù_¿nge
(
»s_¿nge
 *
¿nge
, 
¡¬t
, 
’d
)

94 
i
, 
j
;

96 
j
 = 0; j < 
RANGE_NUM
; j++) {

97 ià(!
¿nge
[
j
].
’d
)

100 ià(
¡¬t
 <ğ
¿nge
[
j
].¡¬ˆ&& 
’d
 >=„ange[j].end) {

101 
¿nge
[
j
].
¡¬t
 = 0;

102 
¿nge
[
j
].
’d
 = 0;

106 ià(
¡¬t
 <ğ
¿nge
[
j
].¡¬ˆ&& 
’d
 <„ange[j].end &&

107 
¿nge
[
j
].
¡¬t
 < 
’d
 + 1) {

108 
¿nge
[
j
].
¡¬t
 = 
’d
 + 1;

113 ià(
¡¬t
 > 
¿nge
[
j
].¡¬ˆ&& 
’d
 >=„ange[j].end &&

114 
¿nge
[
j
].
’d
 > 
¡¬t
 - 1) {

115 
¿nge
[
j
].
’d
 = 
¡¬t
 - 1;

119 ià(
¡¬t
 > 
¿nge
[
j
].¡¬ˆ&& 
’d
 <„ange[j].end) {

121 
i
 = 0; i < 
RANGE_NUM
; i++) {

122 ià(
¿nge
[
i
].
’d
 == 0)

125 ià(
i
 < 
RANGE_NUM
) {

126 
¿nge
[
i
].
’d
 =„ªge[
j
].end;

127 
¿nge
[
i
].
¡¬t
 = 
’d
 + 1;

129 
	`´štk
(
KERN_ERR
 "run of slot in„anges\n");

131 
¿nge
[
j
].
’d
 = 
¡¬t
 - 1;

135 
	}
}

137 
__š™
 
	$cmp_¿nge
(cÚ¡ *
x1
, cÚ¡ *
x2
)

139 cÚ¡ 
»s_¿nge
 *
r1
 = 
x1
;

140 cÚ¡ 
»s_¿nge
 *
r2
 = 
x2
;

141 
¡¬t1
, 
¡¬t2
;

143 
¡¬t1
 = 
r1
->
¡¬t
;

144 
¡¬t2
 = 
r2
->
¡¬t
;

146  
¡¬t1
 - 
¡¬t2
;

147 
	}
}

149 
	sv¬_mŒr_¿nge_¡©e
 {

150 
	mba£_pâ
;

151 
	msize_pâ
;

152 
mŒr_ty³
 
	mty³
;

155 
v¬_mŒr_¿nge_¡©e
 
__š™d©a
 
	g¿nge_¡©e
[
RANGE_NUM
];

156 
__š™d©a
 
	gdebug_´št
;

158 
__š™


159 
	$x86_g‘_mŒr_mem_¿nge
(
»s_¿nge
 *
¿nge
, 
Ä_¿nge
,

160 
exŒa_»move_ba£
,

161 
exŒa_»move_size
)

163 
ba£
, 
size
;

164 
mŒr_ty³
 
ty³
;

165 
i
;

167 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

168 
ty³
 = 
¿nge_¡©e
[
i
].type;

169 ià(
ty³
 !ğ
MTRR_TYPE_WRBACK
)

171 
ba£
 = 
¿nge_¡©e
[
i
].
ba£_pâ
;

172 
size
 = 
¿nge_¡©e
[
i
].
size_pâ
;

173 
Ä_¿nge
 = 
	`add_¿nge_w™h_m”ge
(
¿nge
,‚r_¿nge, 
ba£
,

174 
ba£
 + 
size
 - 1);

176 ià(
debug_´št
) {

177 
	`´štk
(
KERN_DEBUG
 "After WB checking\n");

178 
i
 = 0; i < 
Ä_¿nge
; i++)

179 
	`´štk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

180 
¿nge
[
i
].
¡¬t
,„ªge[i].
’d
 + 1);

184 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

185 
ty³
 = 
¿nge_¡©e
[
i
].type;

186 ià(
ty³
 !ğ
MTRR_TYPE_UNCACHABLE
 &&

187 
ty³
 !ğ
MTRR_TYPE_WRPROT
)

189 
size
 = 
¿nge_¡©e
[
i
].
size_pâ
;

190 ià(!
size
)

192 
ba£
 = 
¿nge_¡©e
[
i
].
ba£_pâ
;

193 ià(
ba£
 < (1<<(20-
PAGE_SHIFT
)è&& 
mŒr_¡©e
.
have_fixed
 &&

194 (
mŒr_¡©e
.
’abËd
 & 1)) {

196 
	`´štk
(
KERN_WARNING
 "WARNING: BIOS bug: VAR MTRR %d "

198 "w™h you¸sy¡em v’dÜ!\n", 
i
);

199 ià(
ba£
 + 
size
 <ğ(1<<(20-
PAGE_SHIFT
)))

201 
size
 -ğ(1<<(20-
PAGE_SHIFT
)è- 
ba£
;

202 
ba£
 = 1<<(20-
PAGE_SHIFT
);

204 
	`subŒaù_¿nge
(
¿nge
, 
ba£
, ba£ + 
size
 - 1);

206 ià(
exŒa_»move_size
)

207 
	`subŒaù_¿nge
(
¿nge
, 
exŒa_»move_ba£
,

208 
exŒa_»move_ba£
 + 
exŒa_»move_size
 - 1);

211 
Ä_¿nge
 = 0;

212 
i
 = 0; i < 
RANGE_NUM
; i++) {

213 ià(!
¿nge
[
i
].
’d
)

215 
Ä_¿nge
++;

217 ià(
debug_´št
) {

218 
	`´štk
(
KERN_DEBUG
 "After UC checking\n");

219 
i
 = 0; i < 
Ä_¿nge
; i++)

220 
	`´štk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

221 
¿nge
[
i
].
¡¬t
,„ªge[i].
’d
 + 1);

225 
	`sÜt
(
¿nge
, 
Ä_¿nge
, (
»s_¿nge
), 
cmp_¿nge
, 
NULL
);

226 ià(
debug_´št
) {

227 
	`´štk
(
KERN_DEBUG
 "After sorting\n");

228 
i
 = 0; i < 
Ä_¿nge
; i++)

229 
	`´štk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

230 
¿nge
[
i
].
¡¬t
,„ªge[i].
’d
 + 1);

234 
i
 = 
Ä_¿nge
; i < 
RANGE_NUM
; i++)

235 
	`mem£t
(&
¿nge
[
i
], 0, (range[i]));

237  
Ä_¿nge
;

238 
	}
}

240 
»s_¿nge
 
__š™d©a
 
	g¿nge
[
RANGE_NUM
];

241 
__š™d©a
 
	gÄ_¿nge
;

243 #ifdeà
CONFIG_MTRR_SANITIZER


245 
__š™
 
	$sum_¿nges
(
»s_¿nge
 *
¿nge
, 
Ä_¿nge
)

247 
sum
;

248 
i
;

250 
sum
 = 0;

251 
i
 = 0; i < 
Ä_¿nge
; i++)

252 
sum
 +ğ
¿nge
[
i
].
’d
 + 1 -„ªge[i].
¡¬t
;

254  
sum
;

255 
	}
}

257 
’abË_mŒr_ş—nup
 
	g__š™d©a
 =

258 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

260 
__š™
 
	$di§bË_mŒr_ş—nup_£tup
(*
¡r
)

262 
’abË_mŒr_ş—nup
 = 0;

264 
	}
}

265 
—¾y_·¿m
("di§bË_mŒr_ş—nup", 
di§bË_mŒr_ş—nup_£tup
);

267 
__š™
 
	$’abË_mŒr_ş—nup_£tup
(*
¡r
)

269 
’abË_mŒr_ş—nup
 = 1;

271 
	}
}

272 
—¾y_·¿m
("’abË_mŒr_ş—nup", 
’abË_mŒr_ş—nup_£tup
);

274 
__š™
 
	$mŒr_ş—nup_debug_£tup
(*
¡r
)

276 
debug_´št
 = 1;

278 
	}
}

279 
—¾y_·¿m
("mŒr_ş—nup_debug", 
mŒr_ş—nup_debug_£tup
);

281 
	sv¬_mŒr_¡©e
 {

282 
	m¿nge_¡¬tk
;

283 
	m¿nge_sizek
;

284 
	mchunk_sizek
;

285 
	mg¿n_sizek
;

286 
	m»g
;

289 
__š™


290 
	$£t_v¬_mŒr
(
»g
, 
ba£k
, 
sizek
,

291 
ty³
, 
add»ss_b™s
)

293 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

294 
u64
 
ba£
, 
mask
;

296 ià(!
sizek
) {

297 
	`fl_mŒr_v¬_¿nge
(
»g
, 0, 0, 0, 0);

301 
mask
 = (1ULL << 
add»ss_b™s
) - 1;

302 
mask
 &ğ~((((
u64
)
sizek
) << 10) - 1);

304 
ba£
 = ((
u64
)
ba£k
) << 10;

306 
ba£
 |ğ
ty³
;

307 
mask
 |= 0x800;

309 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

310 
ba£_hi
 = 
ba£
 >> 32;

312 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

313 
mask_hi
 = 
mask
 >> 32;

315 
	`fl_mŒr_v¬_¿nge
(
»g
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

316 
	}
}

318 
__š™


319 
	$§ve_v¬_mŒr
(
»g
, 
ba£k
, 
sizek
,

320 
ty³
)

322 
¿nge_¡©e
[
»g
].
ba£_pâ
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

323 
¿nge_¡©e
[
»g
].
size_pâ
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

324 
¿nge_¡©e
[
»g
].
ty³
 =ype;

325 
	}
}

327 
__š™


328 
	$£t_v¬_mŒr_®l
(
add»ss_b™s
)

330 
ba£k
, 
sizek
;

331 
ty³
;

332 
»g
;

334 
»g
 = 0;„eg < 
num_v¬_¿nges
;„eg++) {

335 
ba£k
 = 
¿nge_¡©e
[
»g
].
ba£_pâ
 << (
PAGE_SHIFT
 - 10);

336 
sizek
 = 
¿nge_¡©e
[
»g
].
size_pâ
 << (
PAGE_SHIFT
 - 10);

337 
ty³
 = 
¿nge_¡©e
[
»g
].type;

339 
	`£t_v¬_mŒr
(
»g
, 
ba£k
, 
sizek
, 
ty³
, 
add»ss_b™s
);

341 
	}
}

343 
	$to_size_çùÜ
(
sizek
, *
çùÜp
)

345 
çùÜ
;

346 
ba£
 = 
sizek
;

348 ià(
ba£
 & ((1<<10) - 1)) {

350 
çùÜ
 = 'K';

351 } ià(
ba£
 & ((1<<20) - 1)) {

352 
çùÜ
 = 'M';

353 
ba£
 >>= 10;

355 
çùÜ
 = 'G';

356 
ba£
 >>= 20;

359 *
çùÜp
 = 
çùÜ
;

361  
ba£
;

362 
	}
}

364 
__š™


365 
	$¿nge_to_mŒr
(
»g
, 
¿nge_¡¬tk
,

366 
¿nge_sizek
, 
ty³
)

368 ià(!
¿nge_sizek
 || (
»g
 >ğ
num_v¬_¿nges
))

369  
»g
;

371 
¿nge_sizek
) {

372 
max_®ign
, 
®ign
;

373 
sizek
;

376 ià(
¿nge_¡¬tk
)

377 
max_®ign
 = 
	`ffs
(
¿nge_¡¬tk
) - 1;

379 
max_®ign
 = 32;

380 
®ign
 = 
	`æs
(
¿nge_sizek
) - 1;

381 ià(
®ign
 > 
max_®ign
)

382 
®ign
 = 
max_®ign
;

384 
sizek
 = 1 << 
®ign
;

385 ià(
debug_´št
) {

386 
¡¬t_çùÜ
 = 'K', 
size_çùÜ
 = 'K';

387 
¡¬t_ba£
, 
size_ba£
;

389 
¡¬t_ba£
 = 
	`to_size_çùÜ
(
¿nge_¡¬tk
,

390 &
¡¬t_çùÜ
),

391 
size_ba£
 = 
	`to_size_çùÜ
(
sizek
, &
size_çùÜ
),

393 
	`´štk
(
KERN_DEBUG
 "Setting variable MTRR %d, "

395 
»g
, 
¡¬t_ba£
, 
¡¬t_çùÜ
,

396 
size_ba£
, 
size_çùÜ
,

397 (
ty³
 =ğ
MTRR_TYPE_UNCACHABLE
) ? "UC" :

398 ((
ty³
 =ğ
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

401 
	`§ve_v¬_mŒr
(
»g
++, 
¿nge_¡¬tk
, 
sizek
, 
ty³
);

402 
¿nge_¡¬tk
 +ğ
sizek
;

403 
¿nge_sizek
 -ğ
sizek
;

404 ià(
»g
 >ğ
num_v¬_¿nges
)

407  
»g
;

408 
	}
}

410 
__š™


411 
	$¿nge_to_mŒr_w™h_hŞe
(
v¬_mŒr_¡©e
 *
¡©e
, 
ba£k
,

412 
sizek
)

414 
hŞe_ba£k
, 
hŞe_sizek
;

415 
£cÚd_ba£k
, 
£cÚd_sizek
;

416 
¿nge0_ba£k
, 
¿nge0_sizek
;

417 
¿nge_ba£k
, 
¿nge_sizek
;

418 
chunk_sizek
;

419 
g¿n_sizek
;

421 
hŞe_ba£k
 = 0;

422 
hŞe_sizek
 = 0;

423 
£cÚd_ba£k
 = 0;

424 
£cÚd_sizek
 = 0;

425 
chunk_sizek
 = 
¡©e
->chunk_sizek;

426 
g¿n_sizek
 = 
¡©e
->gran_sizek;

429 
¿nge_ba£k
 = 
	`ALIGN
(
¡©e
->
¿nge_¡¬tk
, 
g¿n_sizek
);

430 ià((
¿nge_ba£k
 > 
ba£k
) && basek)

431  
£cÚd_sizek
;

432 
¡©e
->
¿nge_sizek
 -ğ(
¿nge_ba£k
 - s‹->
¿nge_¡¬tk
);

433 
¿nge_sizek
 = 
	`ALIGN
(
¡©e
->¿nge_sizek, 
g¿n_sizek
);

435 
¿nge_sizek
 > 
¡©e
->range_sizek) {

436 
¿nge_sizek
 -ğ
g¿n_sizek
;

437 ià(!
¿nge_sizek
)

440 
¡©e
->
¿nge_sizek
 =„ange_sizek;

443 
¿nge0_ba£k
 = 
¡©e
->
¿nge_¡¬tk
;

444 
¿nge0_sizek
 = 
	`ALIGN
(
¡©e
->
¿nge_sizek
, 
chunk_sizek
);

447 ià(
¿nge0_sizek
 =ğ
¡©e
->
¿nge_sizek
) {

448 ià(
debug_´št
)

449 
	`´štk
(
KERN_DEBUG
 "rangeX: %016lx - %016lx\n",

450 
¿nge0_ba£k
<<10,

451 (
¿nge0_ba£k
 + 
¡©e
->
¿nge_sizek
)<<10);

452 
¡©e
->
»g
 = 
	`¿nge_to_mŒr
(¡©e->»g, 
¿nge0_ba£k
,

453 
¡©e
->
¿nge_sizek
, 
MTRR_TYPE_WRBACK
);

458 ià(
sizek
) {

459 
¿nge0_ba£k
 + 
¿nge0_sizek
 > (
ba£k
 + 
sizek
)) {

460 ià(
¿nge0_sizek
 >ğ
chunk_sizek
)

461 
¿nge0_sizek
 -ğ
chunk_sizek
;

463 
¿nge0_sizek
 = 0;

465 ià(!
¿nge0_sizek
)

470 
£cÚd_Œy
:

471 
¿nge_ba£k
 = 
¿nge0_ba£k
 + 
¿nge0_sizek
;

474 ià(
¿nge_ba£k
 > 
ba£k
 &&„ªge_ba£k <ğ(ba£k + 
sizek
))

475 
£cÚd_sizek
 = 
¿nge_ba£k
 - 
ba£k
;

477 ià(
¿nge0_sizek
 > 
¡©e
->
¿nge_sizek
) {

480 
hŞe_sizek
 = 
¿nge0_sizek
 - 
¡©e
->
¿nge_sizek
 - 
£cÚd_sizek
;

483 ià(
hŞe_sizek
 >ğ(
¿nge0_sizek
 >> 1) &&

484 
¿nge0_sizek
 >ğ
chunk_sizek
) {

485 
¿nge0_sizek
 -ğ
chunk_sizek
;

486 
£cÚd_sizek
 = 0;

487 
hŞe_sizek
 = 0;

489 
£cÚd_Œy
;

493 ià(
¿nge0_sizek
) {

494 ià(
debug_´št
)

495 
	`´štk
(
KERN_DEBUG
 "range0: %016lx - %016lx\n",

496 
¿nge0_ba£k
<<10,

497 (
¿nge0_ba£k
 + 
¿nge0_sizek
)<<10);

498 
¡©e
->
»g
 = 
	`¿nge_to_mŒr
(¡©e->»g, 
¿nge0_ba£k
,

499 
¿nge0_sizek
, 
MTRR_TYPE_WRBACK
);

502 ià(
¿nge0_sizek
 < 
¡©e
->
¿nge_sizek
) {

504 
¿nge_sizek
 = 
¡©e
->¿nge_sizek - 
¿nge0_sizek
;

506 ià(
debug_´št
)

507 
	`´štk
(
KERN_DEBUG
 "range: %016lx - %016lx\n",

508 
¿nge_ba£k
<<10,

509 (
¿nge_ba£k
 + 
¿nge_sizek
)<<10);

510 
¡©e
->
»g
 = 
	`¿nge_to_mŒr
(¡©e->»g, 
¿nge_ba£k
,

511 
¿nge_sizek
, 
MTRR_TYPE_WRBACK
);

514 ià(
hŞe_sizek
) {

515 
hŞe_ba£k
 = 
¿nge_ba£k
 - 
hŞe_sizek
 - 
£cÚd_sizek
;

516 ià(
debug_´št
)

517 
	`´štk
(
KERN_DEBUG
 "hole: %016lx - %016lx\n",

518 
hŞe_ba£k
<<10,

519 (
hŞe_ba£k
 + 
hŞe_sizek
)<<10);

520 
¡©e
->
»g
 = 
	`¿nge_to_mŒr
(¡©e->»g, 
hŞe_ba£k
,

521 
hŞe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

524  
£cÚd_sizek
;

525 
	}
}

527 
__š™


528 
	$£t_v¬_mŒr_¿nge
(
v¬_mŒr_¡©e
 *
¡©e
, 
ba£_pâ
,

529 
size_pâ
)

531 
ba£k
, 
sizek
;

532 
£cÚd_sizek
 = 0;

534 ià(
¡©e
->
»g
 >ğ
num_v¬_¿nges
)

537 
ba£k
 = 
ba£_pâ
 << (
PAGE_SHIFT
 - 10);

538 
sizek
 = 
size_pâ
 << (
PAGE_SHIFT
 - 10);

541 ià((
ba£k
 <= 1024) ||

542 (
¡©e
->
¿nge_¡¬tk
 + s‹->
¿nge_sizek
 =ğ
ba£k
)) {

543 
’dk
 = 
ba£k
 + 
sizek
;

544 
¡©e
->
¿nge_sizek
 = 
’dk
 - s‹->
¿nge_¡¬tk
;

548 ià(
¡©e
->
¿nge_sizek
 != 0)

549 
£cÚd_sizek
 = 
	`¿nge_to_mŒr_w™h_hŞe
(
¡©e
, 
ba£k
, 
sizek
);

552 
¡©e
->
¿nge_¡¬tk
 = 
ba£k
 + 
£cÚd_sizek
;

553 
¡©e
->
¿nge_sizek
 = 
sizek
 - 
£cÚd_sizek
;

554 
	}
}

557 
u64
 
mŒr_chunk_size
 
	g__š™d©a
 = (256ULL<<20);

559 
__š™
 
	$·r£_mŒr_chunk_size_İt
(*
p
)

561 ià(!
p
)

562  -
EINVAL
;

563 
mŒr_chunk_size
 = 
	`mem·r£
(
p
, &p);

565 
	}
}

566 
—¾y_·¿m
("mŒr_chunk_size", 
·r£_mŒr_chunk_size_İt
);

569 
u64
 
mŒr_g¿n_size
 
	g__š™d©a
;

571 
__š™
 
	$·r£_mŒr_g¿n_size_İt
(*
p
)

573 ià(!
p
)

574  -
EINVAL
;

575 
mŒr_g¿n_size
 = 
	`mem·r£
(
p
, &p);

577 
	}
}

578 
—¾y_·¿m
("mŒr_g¿n_size", 
·r£_mŒr_g¿n_size_İt
);

580 
Ä_mŒr_¥¬e_»g
 
	g__š™d©a
 =

581 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

583 
__š™
 
	$·r£_mŒr_¥¬e_»g
(*
¬g
)

585 ià(
¬g
)

586 
Ä_mŒr_¥¬e_»g
 = 
	`sim¶e_¡¹oul
(
¬g
, 
NULL
, 0);

588 
	}
}

590 
—¾y_·¿m
("mŒr_¥¬e_»g_Ä", 
·r£_mŒr_¥¬e_»g
);

592 
__š™


593 
	$x86_£tup_v¬_mŒrs
(
»s_¿nge
 *
¿nge
, 
Ä_¿nge
,

594 
u64
 
chunk_size
, u64 
g¿n_size
)

596 
v¬_mŒr_¡©e
 
v¬_¡©e
;

597 
i
;

598 
num_»g
;

600 
v¬_¡©e
.
¿nge_¡¬tk
 = 0;

601 
v¬_¡©e
.
¿nge_sizek
 = 0;

602 
v¬_¡©e
.
»g
 = 0;

603 
v¬_¡©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

604 
v¬_¡©e
.
g¿n_sizek
 = 
g¿n_size
 >> 10;

606 
	`mem£t
(
¿nge_¡©e
, 0, (range_state));

609 
i
 = 0; i < 
Ä_¿nge
; i++)

610 
	`£t_v¬_mŒr_¿nge
(&
v¬_¡©e
, 
¿nge
[
i
].
¡¬t
,

611 
¿nge
[
i
].
’d
 -„ªge[i].
¡¬t
 + 1);

614 ià(
v¬_¡©e
.
¿nge_sizek
 != 0)

615 
	`¿nge_to_mŒr_w™h_hŞe
(&
v¬_¡©e
, 0, 0);

617 
num_»g
 = 
v¬_¡©e
.
»g
;

619 
v¬_¡©e
.
»g
 < 
num_v¬_¿nges
) {

620 
	`§ve_v¬_mŒr
(
v¬_¡©e
.
»g
, 0, 0, 0);

621 
v¬_¡©e
.
»g
++;

624  
num_»g
;

625 
	}
}

627 
	smŒr_ş—nup_»suÉ
 {

628 
	mg¿n_sizek
;

629 
	mchunk_sizek
;

630 
	mlo£_cov”_sizek
;

631 
	mnum_»g
;

632 
	mbad
;

640 
	#NUM_RESULT
 136

	)

641 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

643 
mŒr_ş—nup_»suÉ
 
__š™d©a
 
	g»suÉ
[
NUM_RESULT
];

644 
__š™d©a
 
	gmš_loss_pâ
[
RANGE_NUM
];

646 
__š™
 
	$´št_out_mŒr_¿nge_¡©e
()

648 
i
;

649 
¡¬t_çùÜ
 = 'K', 
size_çùÜ
 = 'K';

650 
¡¬t_ba£
, 
size_ba£
;

651 
mŒr_ty³
 
ty³
;

653 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

655 
size_ba£
 = 
¿nge_¡©e
[
i
].
size_pâ
 << (
PAGE_SHIFT
 - 10);

656 ià(!
size_ba£
)

659 
size_ba£
 = 
	`to_size_çùÜ
(size_ba£, &
size_çùÜ
),

660 
¡¬t_ba£
 = 
¿nge_¡©e
[
i
].
ba£_pâ
 << (
PAGE_SHIFT
 - 10);

661 
¡¬t_ba£
 = 
	`to_size_çùÜ
(¡¬t_ba£, &
¡¬t_çùÜ
),

662 
ty³
 = 
¿nge_¡©e
[
i
].type;

664 
	`´štk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,„ange: %ld%cB,ype %s\n",

665 
i
, 
¡¬t_ba£
, 
¡¬t_çùÜ
,

666 
size_ba£
, 
size_çùÜ
,

667 (
ty³
 =ğ
MTRR_TYPE_UNCACHABLE
) ? "UC" :

668 ((
ty³
 =ğ
MTRR_TYPE_WRPROT
) ? "WP" :

669 ((
ty³
 =ğ
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

672 
	}
}

674 
__š™
 
	$mŒr_Ãed_ş—nup
()

676 
i
;

677 
mŒr_ty³
 
ty³
;

678 
size
;

680 
num
[
MTRR_NUM_TYPES
 + 1];

683 
	`mem£t
(
num
, 0, (num));

684 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

685 
ty³
 = 
¿nge_¡©e
[
i
].type;

686 
size
 = 
¿nge_¡©e
[
i
].
size_pâ
;

687 ià(
ty³
 >ğ
MTRR_NUM_TYPES
)

689 ià(!
size
)

690 
ty³
 = 
MTRR_NUM_TYPES
;

691 ià(
ty³
 =ğ
MTRR_TYPE_WRPROT
)

692 
ty³
 = 
MTRR_TYPE_UNCACHABLE
;

693 
num
[
ty³
]++;

697 ià(!
num
[
MTRR_TYPE_UNCACHABLE
])

701 ià(
num
[
MTRR_TYPE_WRBACK
] +‚um[
MTRR_TYPE_UNCACHABLE
] !=

702 
num_v¬_¿nges
 - 
num
[
MTRR_NUM_TYPES
])

706 
	}
}

708 
__š™d©a
 
	g¿nge_sums
;

709 
__š™
 
	$mŒr_ÿlc_¿nge_¡©e
(
u64
 
chunk_size
, u64 
g¿n_size
,

710 
exŒa_»move_ba£
,

711 
exŒa_»move_size
,

712 
i
)

714 
num_»g
;

715 
»s_¿nge
 
¿nge_Ãw
[
RANGE_NUM
];

716 
Ä_¿nge_Ãw
;

717 
¿nge_sums_Ãw
;

720 
num_»g
 = 
	`x86_£tup_v¬_mŒrs
(
¿nge
, 
Ä_¿nge
,

721 
chunk_size
, 
g¿n_size
);

724 
	`mem£t
(
¿nge_Ãw
, 0, (range_new));

725 
Ä_¿nge_Ãw
 = 
	`x86_g‘_mŒr_mem_¿nge
(
¿nge_Ãw
, 0,

726 
exŒa_»move_ba£
, 
exŒa_»move_size
);

727 
¿nge_sums_Ãw
 = 
	`sum_¿nges
(
¿nge_Ãw
, 
Ä_¿nge_Ãw
);

729 
»suÉ
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

730 
»suÉ
[
i
].
g¿n_sizek
 = 
g¿n_size
 >> 10;

731 
»suÉ
[
i
].
num_»g
 =‚um_reg;

732 ià(
¿nge_sums
 < 
¿nge_sums_Ãw
) {

733 
»suÉ
[
i
].
lo£_cov”_sizek
 =

734 (
¿nge_sums_Ãw
 - 
¿nge_sums
è<< 
PSHIFT
;

735 
»suÉ
[
i
].
bad
 = 1;

737 
»suÉ
[
i
].
lo£_cov”_sizek
 =

738 (
¿nge_sums
 - 
¿nge_sums_Ãw
è<< 
PSHIFT
;

741 ià(!
»suÉ
[
i
].
bad
 && !»suÉ[i].
lo£_cov”_sizek
) {

742 ià(
Ä_¿nge_Ãw
 !ğ
Ä_¿nge
 ||

743 
	`memcmp
(
¿nge
, 
¿nge_Ãw
, (range)))

744 
»suÉ
[
i
].
bad
 = 1;

747 ià(!
»suÉ
[
i
].
bad
 && (
¿nge_sums
 - 
¿nge_sums_Ãw
 <

748 
mš_loss_pâ
[
num_»g
])) {

749 
mš_loss_pâ
[
num_»g
] =

750 
¿nge_sums
 - 
¿nge_sums_Ãw
;

752 
	}
}

754 
__š™
 
	$mŒr_´št_out_Úe_»suÉ
(
i
)

756 
g¿n_çùÜ
, 
chunk_çùÜ
, 
lo£_çùÜ
;

757 
g¿n_ba£
, 
chunk_ba£
, 
lo£_ba£
;

759 
g¿n_ba£
 = 
	`to_size_çùÜ
(
»suÉ
[
i
].
g¿n_sizek
, &
g¿n_çùÜ
),

760 
chunk_ba£
 = 
	`to_size_çùÜ
(
»suÉ
[
i
].
chunk_sizek
, &
chunk_çùÜ
),

761 
lo£_ba£
 = 
	`to_size_çùÜ
(
»suÉ
[
i
].
lo£_cov”_sizek
, &
lo£_çùÜ
),

762 
	`´štk
(
KERN_INFO
 "%sgran_size: %ld%c \tchunk_size: %ld%c \t",

763 
»suÉ
[
i
].
bad
 ? "*BAD*" : " ",

764 
g¿n_ba£
, 
g¿n_çùÜ
, 
chunk_ba£
, 
chunk_çùÜ
);

765 
	`´štk
(
KERN_CONT
 "num_reg: %d \tlose cover RAM: %s%ld%c\n",

766 
»suÉ
[
i
].
num_»g
,„esuÉ[i].
bad
 ? "-" : "",

767 
lo£_ba£
, 
lo£_çùÜ
);

768 
	}
}

770 
__š™
 
	$mŒr_£¬ch_İtim®_šdex
()

772 
i
;

773 
num_»g_good
;

774 
šdex_good
;

776 ià(
Ä_mŒr_¥¬e_»g
 >ğ
num_v¬_¿nges
)

777 
Ä_mŒr_¥¬e_»g
 = 
num_v¬_¿nges
 - 1;

778 
num_»g_good
 = -1;

779 
i
 = 
num_v¬_¿nges
 - 
Ä_mŒr_¥¬e_»g
; i > 0; i--) {

780 ià(!
mš_loss_pâ
[
i
])

781 
num_»g_good
 = 
i
;

784 
šdex_good
 = -1;

785 ià(
num_»g_good
 != -1) {

786 
i
 = 0; i < 
NUM_RESULT
; i++) {

787 ià(!
»suÉ
[
i
].
bad
 &&

788 
»suÉ
[
i
].
num_»g
 =ğ
num_»g_good
 &&

789 !
»suÉ
[
i
].
lo£_cov”_sizek
) {

790 
šdex_good
 = 
i
;

796  
šdex_good
;

797 
	}
}

800 
__š™
 
	$mŒr_ş—nup
(
add»ss_b™s
)

802 
exŒa_»move_ba£
, 
exŒa_»move_size
;

803 
ba£
, 
size
, 
def
, 
dummy
;

804 
mŒr_ty³
 
ty³
;

805 
u64
 
chunk_size
, 
g¿n_size
;

806 
šdex_good
;

807 
i
;

809 ià(!
	`is_ıu
(
INTEL
è|| 
’abË_mŒr_ş—nup
 < 1)

811 
	`rdm¤
(
MTRRdefTy³_MSR
, 
def
, 
dummy
);

812 
def
 &= 0xff;

813 ià(
def
 !ğ
MTRR_TYPE_UNCACHABLE
)

817 
	`mem£t
(
¿nge_¡©e
, 0, (range_state));

818 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

819 
mŒr_if
->
	`g‘
(
i
, &
ba£
, &
size
, &
ty³
);

820 
¿nge_¡©e
[
i
].
ba£_pâ
 = 
ba£
;

821 
¿nge_¡©e
[
i
].
size_pâ
 = 
size
;

822 
¿nge_¡©e
[
i
].
ty³
 =ype;

826 ià(!
	`mŒr_Ãed_ş—nup
())

830 
	`´štk
(
KERN_DEBUG
 "original variable MTRRs\n");

831 
	`´št_out_mŒr_¿nge_¡©e
();

833 
	`mem£t
(
¿nge
, 0, (range));

834 
exŒa_»move_size
 = 0;

835 
exŒa_»move_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

836 ià(
mŒr_tom2
)

837 
exŒa_»move_size
 =

838 (
mŒr_tom2
 >> 
PAGE_SHIFT
è- 
exŒa_»move_ba£
;

839 
Ä_¿nge
 = 
	`x86_g‘_mŒr_mem_¿nge
(
¿nge
, 0, 
exŒa_»move_ba£
,

840 
exŒa_»move_size
);

845 
Ä_¿nge
 = 
	`add_¿nge_w™h_m”ge
(
¿nge
,‚r_range, 0,

846 (1ULL<<(20 - 
PAGE_SHIFT
)) - 1);

848 
	`sÜt
(
¿nge
, 
Ä_¿nge
, (
»s_¿nge
), 
cmp_¿nge
, 
NULL
);

850 
¿nge_sums
 = 
	`sum_¿nges
(
¿nge
, 
Ä_¿nge
);

851 
	`´štk
(
KERN_INFO
 "total RAM coverred: %ldM\n",

852 
¿nge_sums
 >> (20 - 
PAGE_SHIFT
));

854 ià(
mŒr_chunk_size
 && 
mŒr_g¿n_size
) {

855 
i
 = 0;

856 
	`mŒr_ÿlc_¿nge_¡©e
(
mŒr_chunk_size
, 
mŒr_g¿n_size
,

857 
exŒa_»move_ba£
, 
exŒa_»move_size
, 
i
);

859 
	`mŒr_´št_out_Úe_»suÉ
(
i
);

861 ià(!
»suÉ
[
i
].
bad
) {

862 
	`£t_v¬_mŒr_®l
(
add»ss_b™s
);

863 
	`´štk
(
KERN_DEBUG
 "New variable MTRRs\n");

864 
	`´št_out_mŒr_¿nge_¡©e
();

867 
	`´štk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

871 
i
 = 0;

872 
	`mem£t
(
mš_loss_pâ
, 0xff, (min_loss_pfn));

873 
	`mem£t
(
»suÉ
, 0, (result));

874 
g¿n_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

876 
chunk_size
 = 
g¿n_size
; chunk_size < (1ULL<<32);

877 
chunk_size
 <<= 1) {

879 ià(
i
 >ğ
NUM_RESULT
)

882 
	`mŒr_ÿlc_¿nge_¡©e
(
chunk_size
, 
g¿n_size
,

883 
exŒa_»move_ba£
, 
exŒa_»move_size
, 
i
);

884 ià(
debug_´št
) {

885 
	`mŒr_´št_out_Úe_»suÉ
(
i
);

886 
	`´štk
(
KERN_INFO
 "\n");

889 
i
++;

894 
šdex_good
 = 
	`mŒr_£¬ch_İtim®_šdex
();

896 ià(
šdex_good
 != -1) {

897 
	`´štk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

898 
i
 = 
šdex_good
;

899 
	`mŒr_´št_out_Úe_»suÉ
(
i
);

902 
chunk_size
 = 
»suÉ
[
i
].
chunk_sizek
;

903 
chunk_size
 <<= 10;

904 
g¿n_size
 = 
»suÉ
[
i
].
g¿n_sizek
;

905 
g¿n_size
 <<= 10;

906 
	`x86_£tup_v¬_mŒrs
(
¿nge
, 
Ä_¿nge
, 
chunk_size
, 
g¿n_size
);

907 
	`£t_v¬_mŒr_®l
(
add»ss_b™s
);

908 
	`´štk
(
KERN_DEBUG
 "New variable MTRRs\n");

909 
	`´št_out_mŒr_¿nge_¡©e
();

913 
i
 = 0; i < 
NUM_RESULT
; i++)

914 
	`mŒr_´št_out_Úe_»suÉ
(
i
);

917 
	`´štk
(
KERN_INFO
 "mtrr_cleanup: can‚ot find optimal value\n");

918 
	`´štk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

921 
	}
}

923 
__š™
 
	$mŒr_ş—nup
(
add»ss_b™s
)

926 
	}
}

929 
	gdi§bË_mŒr_Œim
;

931 
__š™
 
	$di§bË_mŒr_Œim_£tup
(*
¡r
)

933 
di§bË_mŒr_Œim
 = 1;

935 
	}
}

936 
—¾y_·¿m
("di§bË_mŒr_Œim", 
di§bË_mŒr_Œim_£tup
);

944 
	#Tom2EÇbËd
 (1U << 21)

	)

945 
	#Tom2FÜûMemTy³WB
 (1U << 22)

	)

947 
__š™
 
	$amd_¥ecŸl_deçuÉ_mŒr
()

949 
u32
 
l
, 
h
;

951 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

953 ià(
boÙ_ıu_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

956 ià(
	`rdm¤_§ã
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

962 ià((
l
 & (
Tom2EÇbËd
 | 
Tom2FÜûMemTy³WB
)) ==

963 (
Tom2EÇbËd
 | 
Tom2FÜûMemTy³WB
))

966 
	}
}

968 
u64
 
__š™
 
	$»®_Œim_memÜy
(
¡¬t_pâ
,

969 
lim™_pâ
)

971 
u64
 
Œim_¡¬t
, 
Œim_size
;

972 
Œim_¡¬t
 = 
¡¬t_pâ
;

973 
Œim_¡¬t
 <<ğ
PAGE_SHIFT
;

974 
Œim_size
 = 
lim™_pâ
;

975 
Œim_size
 <<ğ
PAGE_SHIFT
;

976 
Œim_size
 -ğ
Œim_¡¬t
;

978  
	`e820_upd©e_¿nge
(
Œim_¡¬t
, 
Œim_size
, 
E820_RAM
,

979 
E820_RESERVED
);

980 
	}
}

992 
__š™
 
	$mŒr_Œim_unÿched_memÜy
(
’d_pâ
)

994 
i
, 
ba£
, 
size
, 
highe¡_pâ
 = 0, 
def
, 
dummy
;

995 
mŒr_ty³
 
ty³
;

996 
u64
 
tÙ®_Œim_size
;

999 
num
[
MTRR_NUM_TYPES
 + 1];

1004 ià(!
	`is_ıu
(
INTEL
è|| 
di§bË_mŒr_Œim
)

1006 
	`rdm¤
(
MTRRdefTy³_MSR
, 
def
, 
dummy
);

1007 
def
 &= 0xff;

1008 ià(
def
 !ğ
MTRR_TYPE_UNCACHABLE
)

1012 
	`mem£t
(
¿nge_¡©e
, 0, (range_state));

1013 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

1014 
mŒr_if
->
	`g‘
(
i
, &
ba£
, &
size
, &
ty³
);

1015 
¿nge_¡©e
[
i
].
ba£_pâ
 = 
ba£
;

1016 
¿nge_¡©e
[
i
].
size_pâ
 = 
size
;

1017 
¿nge_¡©e
[
i
].
ty³
 =ype;

1021 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

1022 
ty³
 = 
¿nge_¡©e
[
i
].type;

1023 ià(
ty³
 !ğ
MTRR_TYPE_WRBACK
)

1025 
ba£
 = 
¿nge_¡©e
[
i
].
ba£_pâ
;

1026 
size
 = 
¿nge_¡©e
[
i
].
size_pâ
;

1027 ià(
highe¡_pâ
 < 
ba£
 + 
size
)

1028 
highe¡_pâ
 = 
ba£
 + 
size
;

1032 ià(!
highe¡_pâ
) {

1033 
	`´štk
(
KERN_INFO
 "CPU MTRRs‡ll blank - virtualized system.\n");

1038 
	`mem£t
(
num
, 0, (num));

1039 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

1040 
ty³
 = 
¿nge_¡©e
[
i
].type;

1041 ià(
ty³
 >ğ
MTRR_NUM_TYPES
)

1043 
size
 = 
¿nge_¡©e
[
i
].
size_pâ
;

1044 ià(!
size
)

1045 
ty³
 = 
MTRR_NUM_TYPES
;

1046 
num
[
ty³
]++;

1050 ià(!
num
[
MTRR_TYPE_WRBACK
])

1054 ià(
num
[
MTRR_TYPE_WRBACK
] +‚um[
MTRR_TYPE_UNCACHABLE
] !=

1055 
num_v¬_¿nges
 - 
num
[
MTRR_NUM_TYPES
])

1058 
	`mem£t
(
¿nge
, 0, (range));

1059 
Ä_¿nge
 = 0;

1060 ià(
mŒr_tom2
) {

1061 
¿nge
[
Ä_¿nge
].
¡¬t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

1062 
¿nge
[
Ä_¿nge
].
’d
 = (
mŒr_tom2
 >> 
PAGE_SHIFT
) - 1;

1063 ià(
highe¡_pâ
 < 
¿nge
[
Ä_¿nge
].
’d
 + 1)

1064 
highe¡_pâ
 = 
¿nge
[
Ä_¿nge
].
’d
 + 1;

1065 
Ä_¿nge
++;

1067 
Ä_¿nge
 = 
	`x86_g‘_mŒr_mem_¿nge
(
¿nge
,‚r_range, 0, 0);

1069 
tÙ®_Œim_size
 = 0;

1071 ià(
¿nge
[0].
¡¬t
)

1072 
tÙ®_Œim_size
 +ğ
	`»®_Œim_memÜy
(0, 
¿nge
[0].
¡¬t
);

1074 
i
 = 0; i < 
Ä_¿nge
 - 1; i++) {

1075 ià(
¿nge
[
i
].
’d
 + 1 <„ªge[i+1].
¡¬t
)

1076 
tÙ®_Œim_size
 +ğ
	`»®_Œim_memÜy
(
¿nge
[
i
].
’d
 + 1,

1077 
¿nge
[
i
+1].
¡¬t
);

1080 
i
 = 
Ä_¿nge
 - 1;

1081 ià(
¿nge
[
i
].
’d
 + 1 < 
’d_pâ
)

1082 
tÙ®_Œim_size
 +ğ
	`»®_Œim_memÜy
(
¿nge
[
i
].
’d
 + 1,

1083 
’d_pâ
);

1085 ià(
tÙ®_Œim_size
) {

1086 
	`´štk
(
KERN_WARNING
 "WARNING: BIOS bug: CPU MTRRs don't cover"

1088 
tÙ®_Œim_size
 >> 20);

1090 ià(!
chªged_by_mŒr_ş—nup
)

1091 
	`WARN_ON
(1);

1093 
	`´štk
(
KERN_INFO
 "updateƒ820 for mtrr\n");

1094 
	`upd©e_e820
();

1100 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

3 
	~<lšux/š™.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/mm.h
>

6 
	~<lšux/moduË.h
>

7 
	~<asm/io.h
>

8 
	~<asm/mŒr.h
>

9 
	~<asm/m¤.h
>

10 
	~<asm/sy¡em.h
>

11 
	~<asm/ıuã©u».h
>

12 
	~<asm/´oûssÜ-æags.h
>

13 
	~<asm/bæush.h
>

14 
	~<asm/·t.h
>

15 
	~"mŒr.h
"

17 
	sfixed_¿nge_block
 {

18 
	mba£_m¤
;

19 
	m¿nges
;

22 
fixed_¿nge_block
 
	gfixed_¿nge_blocks
[] = {

23 { 
MTRRfix64K_00000_MSR
, 1 },

24 { 
MTRRfix16K_80000_MSR
, 2 },

25 { 
MTRRfix4K_C0000_MSR
, 8 },

29 
	gsmp_chªges_mask
;

30 
	gmŒr_¡©e_£t
;

31 
u64
 
	gmŒr_tom2
;

33 
mŒr_¡©e_ty³
 
	gmŒr_¡©e
 = {};

34 
EXPORT_SYMBOL_GPL
(
mŒr_¡©e
);

44 
šlše
 
	$k8_check_syscfg_d¿m_mod_’
()

46 
u32
 
lo
, 
hi
;

48 ià(!((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
) &&

49 (
boÙ_ıu_d©a
.
x86
 >= 0x0f)))

52 
	`rdm¤
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

53 ià(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

54 
	`´štk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

56 
	`smp_´oûssÜ_id
());

57 
lo
 &ğ~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

58 
	`mŒr_wrm¤
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

60 
	}
}

68 
u8
 
	$mŒr_ty³_lookup
(
u64
 
¡¬t
, u64 
’d
)

70 
i
;

71 
u64
 
ba£
, 
mask
;

72 
u8
 
´ev_m©ch
, 
cu¼_m©ch
;

74 ià(!
mŒr_¡©e_£t
)

77 ià(!
mŒr_¡©e
.
’abËd
)

81 
’d
--;

84 ià(
mŒr_¡©e
.
have_fixed
 && (
¡¬t
 < 0x100000)) {

85 
idx
;

87 ià(
¡¬t
 < 0x80000) {

88 
idx
 = 0;

89 
idx
 +ğ(
¡¬t
 >> 16);

90  
mŒr_¡©e
.
fixed_¿nges
[
idx
];

91 } ià(
¡¬t
 < 0xC0000) {

92 
idx
 = 1 * 8;

93 
idx
 +ğ((
¡¬t
 - 0x80000) >> 14);

94  
mŒr_¡©e
.
fixed_¿nges
[
idx
];

95 } ià(
¡¬t
 < 0x1000000) {

96 
idx
 = 3 * 8;

97 
idx
 +ğ((
¡¬t
 - 0xC0000) >> 12);

98  
mŒr_¡©e
.
fixed_¿nges
[
idx
];

107 ià(!(
mŒr_¡©e
.
’abËd
 & 2)) {

108  
mŒr_¡©e
.
def_ty³
;

111 
´ev_m©ch
 = 0xFF;

112 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

113 
¡¬t_¡©e
, 
’d_¡©e
;

115 ià(!(
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 & (1 << 11)))

118 
ba£
 = (((
u64
)
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_hi
) << 32) +

119 (
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

120 
mask
 = (((
u64
)
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_hi
) << 32) +

121 (
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 & 
PAGE_MASK
);

123 
¡¬t_¡©e
 = ((
¡¬t
 & 
mask
è=ğ(
ba£
 & mask));

124 
’d_¡©e
 = ((
’d
 & 
mask
è=ğ(
ba£
 & mask));

125 ià(
¡¬t_¡©e
 !ğ
’d_¡©e
)

128 ià((
¡¬t
 & 
mask
è!ğ(
ba£
 & mask)) {

132 
cu¼_m©ch
 = 
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 & 0xff;

133 ià(
´ev_m©ch
 == 0xFF) {

134 
´ev_m©ch
 = 
cu¼_m©ch
;

138 ià(
´ev_m©ch
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

139 
cu¼_m©ch
 =ğ
MTRR_TYPE_UNCACHABLE
) {

140  
MTRR_TYPE_UNCACHABLE
;

143 ià((
´ev_m©ch
 =ğ
MTRR_TYPE_WRBACK
 &&

144 
cu¼_m©ch
 =ğ
MTRR_TYPE_WRTHROUGH
) ||

145 (
´ev_m©ch
 =ğ
MTRR_TYPE_WRTHROUGH
 &&

146 
cu¼_m©ch
 =ğ
MTRR_TYPE_WRBACK
)) {

147 
´ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

148 
cu¼_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

151 ià(
´ev_m©ch
 !ğ
cu¼_m©ch
) {

152  
MTRR_TYPE_UNCACHABLE
;

156 ià(
mŒr_tom2
) {

157 ià(
¡¬t
 >ğ(1ULL<<32è&& (
’d
 < 
mŒr_tom2
))

158  
MTRR_TYPE_WRBACK
;

161 ià(
´ev_m©ch
 != 0xFF)

162  
´ev_m©ch
;

164  
mŒr_¡©e
.
def_ty³
;

165 
	}
}

169 
	$g‘_mŒr_v¬_¿nge
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

171 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

172 
	`rdm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask_lo
, vr->
mask_hi
);

173 
	}
}

176 
	$fl_mŒr_v¬_¿nge
(
šdex
,

177 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

179 
mŒr_v¬_¿nge
 *
vr
;

181 
vr
 = 
mŒr_¡©e
.
v¬_¿nges
;

183 
vr
[
šdex
].
ba£_lo
 = base_lo;

184 
vr
[
šdex
].
ba£_hi
 = base_hi;

185 
vr
[
šdex
].
mask_lo
 = mask_lo;

186 
vr
[
šdex
].
mask_hi
 = mask_hi;

187 
	}
}

190 
	$g‘_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

192 *
p
 = (*è
äs
;

193 
i
;

195 
	`k8_check_syscfg_d¿m_mod_’
();

197 
	`rdm¤
(
MTRRfix64K_00000_MSR
, 
p
[0],…[1]);

199 
i
 = 0; i < 2; i++)

200 
	`rdm¤
(
MTRRfix16K_80000_MSR
 + 
i
, 
p
[2 + i * 2],…[3 + i * 2]);

201 
i
 = 0; i < 8; i++)

202 
	`rdm¤
(
MTRRfix4K_C0000_MSR
 + 
i
, 
p
[6 + i * 2],…[7 + i * 2]);

203 
	}
}

205 
	$mŒr_§ve_fixed_¿nges
(*
šfo
)

207 ià(
ıu_has_mŒr
)

208 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

209 
	}
}

211 
__š™d©a
 
	gÏ¡_fixed_¡¬t
;

212 
__š™d©a
 
	gÏ¡_fixed_’d
;

213 
mŒr_ty³
 
__š™d©a
 
	gÏ¡_fixed_ty³
;

215 
__š™
 
	$´št_fixed_Ï¡
()

217 ià(!
Ï¡_fixed_’d
)

220 
	`´štk
(
KERN_DEBUG
 " %05X-%05X %s\n", 
Ï¡_fixed_¡¬t
,

221 
Ï¡_fixed_’d
 - 1, 
	`mŒr_©Œib_to_¡r
(
Ï¡_fixed_ty³
));

223 
Ï¡_fixed_’d
 = 0;

224 
	}
}

226 
__š™
 
	$upd©e_fixed_Ï¡
(
ba£
, 
’d
,

227 
mŒr_ty³
 
ty³
)

229 
Ï¡_fixed_¡¬t
 = 
ba£
;

230 
Ï¡_fixed_’d
 = 
’d
;

231 
Ï¡_fixed_ty³
 = 
ty³
;

232 
	}
}

234 
__š™
 
	$´št_fixed
(
ba£
, 
¡•
,

235 cÚ¡ 
mŒr_ty³
 *
ty³s
)

237 
i
;

239 
i
 = 0; i < 8; ++i, ++
ty³s
, 
ba£
 +ğ
¡•
) {

240 ià(
Ï¡_fixed_’d
 == 0) {

241 
	`upd©e_fixed_Ï¡
(
ba£
, ba£ + 
¡•
, *
ty³s
);

244 ià(
Ï¡_fixed_’d
 =ğ
ba£
 && 
Ï¡_fixed_ty³
 =ğ*
ty³s
) {

245 
Ï¡_fixed_’d
 = 
ba£
 + 
¡•
;

249 
	`´št_fixed_Ï¡
();

250 
	`upd©e_fixed_Ï¡
(
ba£
, ba£ + 
¡•
, *
ty³s
);

252 
	}
}

254 
´•¬e_£t
();

255 
po¡_£t
();

257 
__š™
 
	$´št_mŒr_¡©e
()

259 
i
;

260 
high_width
;

262 
	`´štk
(
KERN_DEBUG
 "MTRR defaultype: %s\n",

263 
	`mŒr_©Œib_to_¡r
(
mŒr_¡©e
.
def_ty³
));

264 ià(
mŒr_¡©e
.
have_fixed
) {

265 
	`´štk
(
KERN_DEBUG
 "MTRR fixed„anges %sabled:\n",

266 
mŒr_¡©e
.
’abËd
 & 1 ? "en" : "dis");

267 
	`´št_fixed
(0x00000, 0x10000, 
mŒr_¡©e
.
fixed_¿nges
 + 0);

268 
i
 = 0; i < 2; ++i)

269 
	`´št_fixed
(0x80000 + 
i
 * 0x20000, 0x04000, 
mŒr_¡©e
.
fixed_¿nges
 + (i + 1) * 8);

270 
i
 = 0; i < 8; ++i)

271 
	`´št_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000, 
mŒr_¡©e
.
fixed_¿nges
 + (i + 3) * 8);

274 
	`´št_fixed_Ï¡
();

276 
	`´štk
(
KERN_DEBUG
 "MTRR variable„anges %sabled:\n",

277 
mŒr_¡©e
.
’abËd
 & 2 ? "en" : "dis");

278 ià(
size_Ü_mask
 & 0xffffffffUL)

279 
high_width
 = 
	`ffs
(
size_Ü_mask
 & 0xffffffffUL) - 1;

281 
high_width
 = 
	`ffs
(
size_Ü_mask
>>32) + 32 - 1;

282 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

283 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

284 ià(
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 & (1 << 11))

285 
	`´štk
(
KERN_DEBUG
 " %u base %0*X%05X000 mask %0*X%05X000 %s\n",

286 
i
,

287 
high_width
,

288 
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_hi
,

289 
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 >> 12,

290 
high_width
,

291 
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_hi
,

292 
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 >> 12,

293 
	`mŒr_©Œib_to_¡r
(
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 & 0xff));

295 
	`´štk
(
KERN_DEBUG
 " %u di§bËd\n", 
i
);

297 ià(
mŒr_tom2
) {

298 
	`´štk
(
KERN_DEBUG
 "TOM2: %016llx‡ka %lldM\n",

299 
mŒr_tom2
, mtrr_tom2>>20);

301 
	}
}

304 
__š™
 
	$g‘_mŒr_¡©e
()

306 
i
;

307 
mŒr_v¬_¿nge
 *
vrs
;

308 
lo
, 
dummy
;

309 
æags
;

311 
vrs
 = 
mŒr_¡©e
.
v¬_¿nges
;

313 
	`rdm¤
(
MTRRÿp_MSR
, 
lo
, 
dummy
);

314 
mŒr_¡©e
.
have_fixed
 = (
lo
 >> 8) & 1;

316 
i
 = 0; i < 
num_v¬_¿nges
; i++)

317 
	`g‘_mŒr_v¬_¿nge
(
i
, &
vrs
[i]);

318 ià(
mŒr_¡©e
.
have_fixed
)

319 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

321 
	`rdm¤
(
MTRRdefTy³_MSR
, 
lo
, 
dummy
);

322 
mŒr_¡©e
.
def_ty³
 = (
lo
 & 0xff);

323 
mŒr_¡©e
.
’abËd
 = (
lo
 & 0xc00) >> 10;

325 ià(
	`amd_¥ecŸl_deçuÉ_mŒr
()) {

326 
low
, 
high
;

328 
	`rdm¤
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

329 
mŒr_tom2
 = 
high
;

330 
mŒr_tom2
 <<= 32;

331 
mŒr_tom2
 |ğ
low
;

332 
mŒr_tom2
 &= 0xffffff800000ULL;

335 
	`´št_mŒr_¡©e
();

337 
mŒr_¡©e_£t
 = 1;

340 
	`loÿl_œq_§ve
(
æags
);

341 
	`´•¬e_£t
();

343 
	`·t_š™
();

345 
	`po¡_£t
();

346 
	`loÿl_œq_»¡Üe
(
æags
);

348 
	}
}

351 
__š™
 
	$mŒr_¡©e_w¬n
()

353 
mask
 = 
smp_chªges_mask
;

355 ià(!
mask
)

357 ià(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

358 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent fixed MTRR settings\n");

359 ià(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

360 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent variable MTRR settings\n");

361 ià(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

362 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent MTRRdefType settings\n");

363 
	`´štk
(
KERN_INFO
 "mtrr:…robably your BIOS does‚ot setup‡ll CPUs.\n");

364 
	`´štk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

365 
	}
}

370 
	$mŒr_wrm¤
(
m¤
, 
a
, 
b
)

372 ià(
	`wrm¤_§ã
(
m¤
, 
a
, 
b
) < 0)

373 
	`´štk
(
KERN_ERR


375 
	`smp_´oûssÜ_id
(), 
m¤
, 
a
, 
b
);

376 
	}
}

384 
	$£t_fixed_¿nge
(
m¤
, 
boŞ
 *
chªged
, *
m¤wÜds
)

386 
lo
, 
hi
;

388 
	`rdm¤
(
m¤
, 
lo
, 
hi
);

390 ià(
lo
 !ğ
m¤wÜds
[0] || 
hi
 != msrwords[1]) {

391 
	`mŒr_wrm¤
(
m¤
, 
m¤wÜds
[0], msrwords[1]);

392 *
chªged
 = 
Œue
;

394 
	}
}

404 
	$g’”ic_g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû_»g
)

406 
i
, 
max
;

407 
mŒr_ty³
 
Éy³
;

408 
lba£
, 
lsize
;

410 
max
 = 
num_v¬_¿nges
;

411 ià(
»¶aû_»g
 >ğ0 &&„•Ïû_»g < 
max
)

412  
»¶aû_»g
;

413 
i
 = 0; i < 
max
; ++i) {

414 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

415 ià(
lsize
 == 0)

416  
i
;

418  -
ENOSPC
;

419 
	}
}

421 
	$g’”ic_g‘_mŒr
(
»g
, *
ba£
,

422 *
size
, 
mŒr_ty³
 *
ty³
)

424 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

425 
tmp
, 
hi
;

426 
ıu
;

432 
ıu
 = 
	`g‘_ıu
();

434 
	`rdm¤
(
	`MTRRphysMask_MSR
(
»g
), 
mask_lo
, 
mask_hi
);

436 ià((
mask_lo
 & 0x800) == 0) {

438 *
ba£
 = 0;

439 *
size
 = 0;

440 *
ty³
 = 0;

441 
out_put_ıu
;

444 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
»g
), 
ba£_lo
, 
ba£_hi
);

447 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
è| 
mask_lo
 >> PAGE_SHIFT;

448 
mask_lo
 = 
size_Ü_mask
 | 
tmp
;

451 
hi
 = 
	`æs
(
tmp
);

452 ià(
hi
 > 0) {

453 
tmp
 |ğ~((1<<(
hi
 - 1)) - 1);

455 ià(
tmp
 !ğ
mask_lo
) {

456 
	`WARN_ONCE
(1, 
KERN_INFO
 "mtrr: your BIOS has set up‡n incorrect mask, fixing it up.\n");

457 
mask_lo
 = 
tmp
;

465 *
size
 = -
mask_lo
;

466 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
è| 
ba£_lo
 >> PAGE_SHIFT;

467 *
ty³
 = 
ba£_lo
 & 0xff;

469 
out_put_ıu
:

470 
	`put_ıu
();

471 
	}
}

477 
	$£t_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

479 *
§ved
 = (*è
äs
;

480 
boŞ
 
chªged
 = 
çl£
;

481 
block
=-1, 
¿nge
;

483 
	`k8_check_syscfg_d¿m_mod_’
();

485 
fixed_¿nge_blocks
[++
block
].
¿nges
)

486 
¿nge
=0;„ªg< 
fixed_¿nge_blocks
[
block
].
¿nges
;„ange++)

487 
	`£t_fixed_¿nge
(
fixed_¿nge_blocks
[
block
].
ba£_m¤
 + 
¿nge
,

488 &
chªged
, (*è
§ved
++);

490  
chªged
;

491 
	}
}

495 
boŞ
 
	$£t_mŒr_v¬_¿nges
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

497 
lo
, 
hi
;

498 
boŞ
 
chªged
 = 
çl£
;

500 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
lo
, 
hi
);

501 ià((
vr
->
ba£_lo
 & 0xfffff0ffULè!ğ(
lo
 & 0xfffff0ffUL)

502 || (
vr
->
ba£_hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
))) !=

503 (
hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
)))) {

504 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

505 
chªged
 = 
Œue
;

508 
	`rdm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
lo
, 
hi
);

510 ià((
vr
->
mask_lo
 & 0xfffff800ULè!ğ(
lo
 & 0xfffff800UL)

511 || (
vr
->
mask_hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
))) !=

512 (
hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
)))) {

513 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask_lo
, vr->
mask_hi
);

514 
chªged
 = 
Œue
;

516  
chªged
;

517 
	}
}

519 
u32
 
	gdeáy³_lo
, 
	gdeáy³_hi
;

527 
	$£t_mŒr_¡©e
()

529 
i
;

530 
chªge_mask
 = 0;

532 
i
 = 0; i < 
num_v¬_¿nges
; i++)

533 ià(
	`£t_mŒr_v¬_¿nges
(
i
, &
mŒr_¡©e
.
v¬_¿nges
[i]))

534 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_VARIABLE
;

536 ià(
mŒr_¡©e
.
have_fixed
 && 
	`£t_fixed_¿nges
(mŒr_¡©e.
fixed_¿nges
))

537 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_FIXED
;

541 ià((
deáy³_lo
 & 0xffè!ğ
mŒr_¡©e
.
def_ty³


542 || ((
deáy³_lo
 & 0xc00è>> 10è!ğ
mŒr_¡©e
.
’abËd
) {

543 
deáy³_lo
 = (deáy³_lØ& ~0xcffè| 
mŒr_¡©e
.
def_ty³
 | (mŒr_¡©e.
’abËd
 << 10);

544 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_DEFTYPE
;

547  
chªge_mask
;

548 
	}
}

551 
	gü4
 = 0;

552 
DEFINE_SPINLOCK
(
£t_©omic™y_lock
);

561 
	$´•¬e_£t
(è
	$__acquœes
(
£t_©omic™y_lock
)

563 
ü0
;

569 
	`¥š_lock
(&
£t_©omic™y_lock
);

572 
ü0
 = 
	`»ad_ü0
(è| 
X86_CR0_CD
;

573 
	`wr™e_ü0
(
ü0
);

574 
	`wbšvd
();

577 iàĞ
ıu_has_pge
 ) {

578 
ü4
 = 
	`»ad_ü4
();

579 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

583 
	`__æush_b
();

586 
	`rdm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
, 
deáy³_hi
);

589 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
 & ~0xcff, 
deáy³_hi
);

590 
	}
}

592 
	$po¡_£t
(è
	$__»Ëa£s
(
£t_©omic™y_lock
)

595 
	`__æush_b
();

598 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
, 
deáy³_hi
);

601 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

604 iàĞ
ıu_has_pge
 )

605 
	`wr™e_ü4
(
ü4
);

606 
	`¥š_uÆock
(&
£t_©omic™y_lock
);

607 
	}
}

609 
	$g’”ic_£t_®l
()

611 
mask
, 
couÁ
;

612 
æags
;

614 
	`loÿl_œq_§ve
(
æags
);

615 
	`´•¬e_£t
();

618 
mask
 = 
	`£t_mŒr_¡©e
();

621 
	`·t_š™
();

623 
	`po¡_£t
();

624 
	`loÿl_œq_»¡Üe
(
æags
);

627 
couÁ
 = 0; couÁ <  
mask
 * 8; ++count) {

628 ià(
mask
 & 0x01)

629 
	`£t_b™
(
couÁ
, &
smp_chªges_mask
);

630 
mask
 >>= 1;

633 
	}
}

635 
	$g’”ic_£t_mŒr
(
»g
, 
ba£
,

636 
size
, 
mŒr_ty³
 
ty³
)

645 
æags
;

646 
mŒr_v¬_¿nge
 *
vr
;

648 
vr
 = &
mŒr_¡©e
.
v¬_¿nges
[
»g
];

650 
	`loÿl_œq_§ve
(
æags
);

651 
	`´•¬e_£t
();

653 ià(
size
 == 0) {

656 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 0, 0);

657 
	`mem£t
(
vr
, 0, (
mŒr_v¬_¿nge
));

659 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty³
;

660 
vr
->
ba£_hi
 = (
ba£
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

661 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

662 
vr
->
mask_hi
 = (-
size
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

664 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
»g
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

665 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 
vr
->
mask_lo
, vr->
mask_hi
);

668 
	`po¡_£t
();

669 
	`loÿl_œq_»¡Üe
(
æags
);

670 
	}
}

672 
	$g’”ic_v®id©e_add_·ge
(
ba£
, 
size
, 
ty³
)

674 
lba£
, 
Ï¡
;

678 ià(
	`is_ıu
(
INTEL
è&& 
boÙ_ıu_d©a
.
x86
 == 6 &&

679 
boÙ_ıu_d©a
.
x86_mod–
 == 1 &&

680 
boÙ_ıu_d©a
.
x86_mask
 <= 7) {

681 ià(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

682 
	`´štk
(
KERN_WARNING
 "mŒr: ba£(0x%lx000èi nÙ 4 MiB‡ligÃd\n", 
ba£
);

683  -
EINVAL
;

685 ià(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

686 (
ty³
 =ğ
MTRR_TYPE_WRCOMB


687 || 
ty³
 =ğ
MTRR_TYPE_WRBACK
)) {

688 
	`´štk
(
KERN_WARNING
 "mtrr: writable mtrr between 0x70000000‡nd 0x7003FFFF may hanghe CPU.\n");

689  -
EINVAL
;

695 
Ï¡
 = 
ba£
 + 
size
 - 1;

696 
lba£
 = 
ba£
; !Öba£ & 1è&& (
Ï¡
 & 1);

697 
lba£
 =†ba£ >> 1, 
Ï¡
 =†ast >> 1) ;

698 ià(
lba£
 !ğ
Ï¡
) {

699 
	`´štk
(
KERN_WARNING
 "mtrr: base(0x%lx000) is‚ot‡ligned on‡ size(0x%lx000) boundary\n",

700 
ba£
, 
size
);

701  -
EINVAL
;

704 
	}
}

707 
	$g’”ic_have_wrcomb
()

709 
cÚfig
, 
dummy
;

710 
	`rdm¤
(
MTRRÿp_MSR
, 
cÚfig
, 
dummy
);

711  (
cÚfig
 & (1 << 10));

712 
	}
}

714 
	$pos™ive_have_wrcomb
()

717 
	}
}

721 
mŒr_İs
 
	gg’”ic_mŒr_İs
 = {

722 .
u£_š‹l_if
 = 1,

723 .
	g£t_®l
 = 
g’”ic_£t_®l
,

724 .
	gg‘
 = 
g’”ic_g‘_mŒr
,

725 .
	gg‘_ä“_»giÚ
 = 
g’”ic_g‘_ä“_»giÚ
,

726 .
	g£t
 = 
g’”ic_£t_mŒr
,

727 .
	gv®id©e_add_·ge
 = 
g’”ic_v®id©e_add_·ge
,

728 .
	ghave_wrcomb
 = 
g’”ic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/´oc_fs.h
>

3 
	~<lšux/ÿ·b™y.h
>

4 
	~<lšux/ùy³.h
>

5 
	~<lšux/moduË.h
>

6 
	~<lšux/£q_fe.h
>

7 
	~<asm/uacûss.h
>

9 
	#LINE_SIZE
 80

	)

11 
	~<asm/mŒr.h
>

12 
	~"mŒr.h
"

14 
	#FILE_FCOUNT
(
f
è(((
£q_fe
 *)((f)->
´iv©e_d©a
))->
´iv©e
)

	)

16 cÚ¡ *cÚ¡ 
	gmŒr_¡ršgs
[
MTRR_NUM_TYPES
] =

27 cÚ¡ *
	$mŒr_©Œib_to_¡r
(
x
)

29  (
x
 <ğ6è? 
mŒr_¡ršgs
[x] : "?";

30 
	}
}

32 #ifdeà
CONFIG_PROC_FS


35 
	$mŒr_fe_add
(
ba£
, 
size
,

36 
ty³
, 
boŞ
 
šüem’t
, 
fe
 *fe, 
·ge
)

38 
»g
, 
max
;

39 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

41 
max
 = 
num_v¬_¿nges
;

42 ià(
fcouÁ
 =ğ
NULL
) {

43 
fcouÁ
 = 
	`kz®loc
(
max
 *  *fcouÁ, 
GFP_KERNEL
);

44 ià(!
fcouÁ
)

45  -
ENOMEM
;

46 
	`FILE_FCOUNT
(
fe
èğ
fcouÁ
;

48 ià(!
·ge
) {

49 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1)))

50  -
EINVAL
;

51 
ba£
 >>ğ
PAGE_SHIFT
;

52 
size
 >>ğ
PAGE_SHIFT
;

54 
»g
 = 
	`mŒr_add_·ge
(
ba£
, 
size
, 
ty³
, 
Œue
);

55 ià(
»g
 >= 0)

56 ++
fcouÁ
[
»g
];

57  
»g
;

58 
	}
}

61 
	$mŒr_fe_d–
(
ba£
, 
size
,

62 
fe
 *fe, 
·ge
)

64 
»g
;

65 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

67 ià(!
·ge
) {

68 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1)))

69  -
EINVAL
;

70 
ba£
 >>ğ
PAGE_SHIFT
;

71 
size
 >>ğ
PAGE_SHIFT
;

73 
»g
 = 
	`mŒr_d–_·ge
(-1, 
ba£
, 
size
);

74 ià(
»g
 < 0)

75  
»g
;

76 ià(
fcouÁ
 =ğ
NULL
)

77  
»g
;

78 ià(
fcouÁ
[
»g
] < 1)

79  -
EINVAL
;

80 --
fcouÁ
[
»g
];

81  
»g
;

82 
	}
}

85 
ssize_t


86 
	$mŒr_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
, 
size_t
 
Ën
, 
loff_t
 * 
µos
)

92 
i
, 
”r
;

93 
»g
;

94 
ba£
, 
size
;

95 *
±r
;

96 
lše
[
LINE_SIZE
];

97 
size_t
 
lš–’
;

99 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

100  -
EPERM
;

101 ià(!
Ën
)

102  -
EINVAL
;

103 
	`mem£t
(
lše
, 0, 
LINE_SIZE
);

104 ià(
Ën
 > 
LINE_SIZE
)

105 
Ën
 = 
LINE_SIZE
;

106 ià(
	`cİy_äom_u£r
(
lše
, 
buf
, 
Ën
 - 1))

107  -
EFAULT
;

108 
lš–’
 = 
	`¡¾’
(
lše
);

109 
±r
 = 
lše
 + 
lš–’
 - 1;

110 ià(
lš–’
 && *
±r
 == '\n')

111 *
±r
 = '\0';

112 ià(!
	`¡ºcmp
(
lše
, "disable=", 8)) {

113 
»g
 = 
	`sim¶e_¡¹oul
(
lše
 + 8, &
±r
, 0);

114 
”r
 = 
	`mŒr_d–_·ge
(
»g
, 0, 0);

115 ià(
”r
 < 0)

116  
”r
;

117  
Ën
;

119 ià(
	`¡ºcmp
(
lše
, "base=", 5))

120  -
EINVAL
;

121 
ba£
 = 
	`sim¶e_¡¹ouÎ
(
lše
 + 5, &
±r
, 0);

122 ; 
	`is¥aû
(*
±r
); ++ptr) ;

123 ià(
	`¡ºcmp
(
±r
, "size=", 5))

124  -
EINVAL
;

125 
size
 = 
	`sim¶e_¡¹ouÎ
(
±r
 + 5, &ptr, 0);

126 ià((
ba£
 & 0xfffè|| (
size
 & 0xfff))

127  -
EINVAL
;

128 ; 
	`is¥aû
(*
±r
); ++ptr) ;

129 ià(
	`¡ºcmp
(
±r
, "type=", 5))

130  -
EINVAL
;

131 
±r
 += 5;

132 ; 
	`is¥aû
(*
±r
); ++ptr) ;

133 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

134 ià(
	`¡rcmp
(
±r
, 
mŒr_¡ršgs
[
i
]))

136 
ba£
 >>ğ
PAGE_SHIFT
;

137 
size
 >>ğ
PAGE_SHIFT
;

138 
”r
 =

139 
	`mŒr_add_·ge
((è
ba£
, (è
size
, 
i
,

140 
Œue
);

141 ià(
”r
 < 0)

142  
”r
;

143  
Ën
;

145  -
EINVAL
;

146 
	}
}

149 
	$mŒr_ioùl
(
fe
 *fe, 
cmd
, 
__¬g
)

151 
”r
 = 0;

152 
mŒr_ty³
 
ty³
;

153 
size
;

154 
mŒr_£Áry
 
£Áry
;

155 
mŒr_g’Œy
 
g’Œy
;

156 
__u£r
 *
¬g
 = (__u£¸*è
__¬g
;

158 
cmd
) {

159 
MTRRIOC_ADD_ENTRY
:

160 
MTRRIOC_SET_ENTRY
:

161 
MTRRIOC_DEL_ENTRY
:

162 
MTRRIOC_KILL_ENTRY
:

163 
MTRRIOC_ADD_PAGE_ENTRY
:

164 
MTRRIOC_SET_PAGE_ENTRY
:

165 
MTRRIOC_DEL_PAGE_ENTRY
:

166 
MTRRIOC_KILL_PAGE_ENTRY
:

167 ià(
	`cİy_äom_u£r
(&
£Áry
, 
¬g
,  sentry))

168  -
EFAULT
;

170 
MTRRIOC_GET_ENTRY
:

171 
MTRRIOC_GET_PAGE_ENTRY
:

172 ià(
	`cİy_äom_u£r
(&
g’Œy
, 
¬g
,  gentry))

173  -
EFAULT
;

175 #ifdeà
CONFIG_COMPAT


176 
MTRRIOC32_ADD_ENTRY
:

177 
MTRRIOC32_SET_ENTRY
:

178 
MTRRIOC32_DEL_ENTRY
:

179 
MTRRIOC32_KILL_ENTRY
:

180 
MTRRIOC32_ADD_PAGE_ENTRY
:

181 
MTRRIOC32_SET_PAGE_ENTRY
:

182 
MTRRIOC32_DEL_PAGE_ENTRY
:

183 
MTRRIOC32_KILL_PAGE_ENTRY
: {

184 
mŒr_£Áry32
 
__u£r
 *
s32
 = (mŒr_£Áry32 __u£¸*)
__¬g
;

185 
”r
 = 
	`g‘_u£r
(
£Áry
.
ba£
, &
s32
->base);

186 
”r
 |ğ
	`g‘_u£r
(
£Áry
.
size
, &
s32
->size);

187 
”r
 |ğ
	`g‘_u£r
(
£Áry
.
ty³
, &
s32
->type);

188 ià(
”r
)

189  
”r
;

192 
MTRRIOC32_GET_ENTRY
:

193 
MTRRIOC32_GET_PAGE_ENTRY
: {

194 
mŒr_g’Œy32
 
__u£r
 *
g32
 = (mŒr_g’Œy32 __u£¸*)
__¬g
;

195 
”r
 = 
	`g‘_u£r
(
g’Œy
.
»gnum
, &
g32
->regnum);

196 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
ba£
, &
g32
->base);

197 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
size
, &
g32
->size);

198 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
ty³
, &
g32
->type);

199 ià(
”r
)

200  
”r
;

206 
cmd
) {

208  -
ENOTTY
;

209 
MTRRIOC_ADD_ENTRY
:

210 #ifdeà
CONFIG_COMPAT


211 
MTRRIOC32_ADD_ENTRY
:

213 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

214  -
EPERM
;

215 
”r
 =

216 
	`mŒr_fe_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 
Œue
,

217 
fe
, 0);

219 
MTRRIOC_SET_ENTRY
:

220 #ifdeà
CONFIG_COMPAT


221 
MTRRIOC32_SET_ENTRY
:

223 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

224  -
EPERM
;

225 
”r
 = 
	`mŒr_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 
çl£
);

227 
MTRRIOC_DEL_ENTRY
:

228 #ifdeà
CONFIG_COMPAT


229 
MTRRIOC32_DEL_ENTRY
:

231 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

232  -
EPERM
;

233 
”r
 = 
	`mŒr_fe_d–
(
£Áry
.
ba£
, s’Œy.
size
, 
fe
, 0);

235 
MTRRIOC_KILL_ENTRY
:

236 #ifdeà
CONFIG_COMPAT


237 
MTRRIOC32_KILL_ENTRY
:

239 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

240  -
EPERM
;

241 
”r
 = 
	`mŒr_d–
(-1, 
£Áry
.
ba£
, s’Œy.
size
);

243 
MTRRIOC_GET_ENTRY
:

244 #ifdeà
CONFIG_COMPAT


245 
MTRRIOC32_GET_ENTRY
:

247 ià(
g’Œy
.
»gnum
 >ğ
num_v¬_¿nges
)

248  -
EINVAL
;

249 
mŒr_if
->
	`g‘
(
g’Œy
.
»gnum
, &g’Œy.
ba£
, &
size
, &
ty³
);

252 ià(
g’Œy
.
ba£
 + 
size
 - 1 >ğ(1UL << (8 * (g’Œy.sizeè- 
PAGE_SHIFT
))

253 || 
size
 >ğ(1UL << (8 * (
g’Œy
.sizeè- 
PAGE_SHIFT
)))

254 
g’Œy
.
ba£
 = g’Œy.
size
 = g’Œy.
ty³
 = 0;

256 
g’Œy
.
ba£
 <<ğ
PAGE_SHIFT
;

257 
g’Œy
.
size
 = siz<< 
PAGE_SHIFT
;

258 
g’Œy
.
ty³
 =ype;

262 
MTRRIOC_ADD_PAGE_ENTRY
:

263 #ifdeà
CONFIG_COMPAT


264 
MTRRIOC32_ADD_PAGE_ENTRY
:

266 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

267  -
EPERM
;

268 
”r
 =

269 
	`mŒr_fe_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 
Œue
,

270 
fe
, 1);

272 
MTRRIOC_SET_PAGE_ENTRY
:

273 #ifdeà
CONFIG_COMPAT


274 
MTRRIOC32_SET_PAGE_ENTRY
:

276 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

277  -
EPERM
;

278 
”r
 =

279 
	`mŒr_add_·ge
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 
çl£
);

281 
MTRRIOC_DEL_PAGE_ENTRY
:

282 #ifdeà
CONFIG_COMPAT


283 
MTRRIOC32_DEL_PAGE_ENTRY
:

285 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

286  -
EPERM
;

287 
”r
 = 
	`mŒr_fe_d–
(
£Áry
.
ba£
, s’Œy.
size
, 
fe
, 1);

289 
MTRRIOC_KILL_PAGE_ENTRY
:

290 #ifdeà
CONFIG_COMPAT


291 
MTRRIOC32_KILL_PAGE_ENTRY
:

293 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

294  -
EPERM
;

295 
”r
 = 
	`mŒr_d–_·ge
(-1, 
£Áry
.
ba£
, s’Œy.
size
);

297 
MTRRIOC_GET_PAGE_ENTRY
:

298 #ifdeà
CONFIG_COMPAT


299 
MTRRIOC32_GET_PAGE_ENTRY
:

301 ià(
g’Œy
.
»gnum
 >ğ
num_v¬_¿nges
)

302  -
EINVAL
;

303 
mŒr_if
->
	`g‘
(
g’Œy
.
»gnum
, &g’Œy.
ba£
, &
size
, &
ty³
);

305 ià(
size
 !ğ(
	`__ty³of__
(
g’Œy
.size))size)

306 
g’Œy
.
ba£
 = g’Œy.
size
 = g’Œy.
ty³
 = 0;

308 
g’Œy
.
size
 = size;

309 
g’Œy
.
ty³
 =ype;

314 ià(
”r
)

315  
”r
;

317 
cmd
) {

318 
MTRRIOC_GET_ENTRY
:

319 
MTRRIOC_GET_PAGE_ENTRY
:

320 ià(
	`cİy_to_u£r
(
¬g
, &
g’Œy
,  gentry))

321 
”r
 = -
EFAULT
;

323 #ifdeà
CONFIG_COMPAT


324 
MTRRIOC32_GET_ENTRY
:

325 
MTRRIOC32_GET_PAGE_ENTRY
: {

326 
mŒr_g’Œy32
 
__u£r
 *
g32
 = (mŒr_g’Œy32 __u£¸*)
__¬g
;

327 
”r
 = 
	`put_u£r
(
g’Œy
.
ba£
, &
g32
->base);

328 
”r
 |ğ
	`put_u£r
(
g’Œy
.
size
, &
g32
->size);

329 
”r
 |ğ
	`put_u£r
(
g’Œy
.
»gnum
, &
g32
->regnum);

330 
”r
 |ğ
	`put_u£r
(
g’Œy
.
ty³
, &
g32
->type);

335  
”r
;

336 
	}
}

339 
	$mŒr_şo£
(
šode
 *
šo
, 
fe
 *file)

341 
i
, 
max
;

342 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

344 ià(
fcouÁ
 !ğ
NULL
) {

345 
max
 = 
num_v¬_¿nges
;

346 
i
 = 0; i < 
max
; ++i) {

347 
fcouÁ
[
i
] > 0) {

348 
	`mŒr_d–
(
i
, 0, 0);

349 --
fcouÁ
[
i
];

352 
	`kä“
(
fcouÁ
);

353 
	`FILE_FCOUNT
(
fe
èğ
NULL
;

355  
	`sšgË_»Ëa£
(
šo
, 
fe
);

356 
	}
}

358 
mŒr_£q_show
(
£q_fe
 *
£q
, *
off£t
);

360 
	$mŒr_İ’
(
šode
 *šode, 
fe
 *file)

362 ià(!
mŒr_if
)

363  -
EIO
;

364 ià(!
mŒr_if
->
g‘
)

365  -
ENXIO
;

366  
	`sšgË_İ’
(
fe
, 
mŒr_£q_show
, 
NULL
);

367 
	}
}

369 cÚ¡ 
fe_İ”©iÚs
 
	gmŒr_fİs
 = {

370 .
owÃr
 = 
THIS_MODULE
,

371 .
	gİ’
 = 
mŒr_İ’
,

372 .
	g»ad
 = 
£q_»ad
,

373 .
	gÎ£ek
 = 
£q_l£ek
,

374 .
	gwr™e
 = 
mŒr_wr™e
,

375 .
	guÆocked_ioùl
 = 
mŒr_ioùl
,

376 .
	gcom·t_ioùl
 = 
mŒr_ioùl
,

377 .
	g»Ëa£
 = 
mŒr_şo£
,

380 
	$mŒr_£q_show
(
£q_fe
 *
£q
, *
off£t
)

382 
çùÜ
;

383 
i
, 
max
, 
Ën
;

384 
mŒr_ty³
 
ty³
;

385 
ba£
, 
size
;

387 
Ën
 = 0;

388 
max
 = 
num_v¬_¿nges
;

389 
i
 = 0; i < 
max
; i++) {

390 
mŒr_if
->
	`g‘
(
i
, &
ba£
, &
size
, &
ty³
);

391 ià(
size
 == 0)

392 
mŒr_u§ge_bË
[
i
] = 0;

394 ià(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

396 
çùÜ
 = 'K';

397 
size
 <<ğ
PAGE_SHIFT
 - 10;

399 
çùÜ
 = 'M';

400 
size
 >>ğ20 - 
PAGE_SHIFT
;

403 
Ën
 +ğ
	`£q_´štf
(
£q
,

405 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
, 
çùÜ
,

406 
mŒr_u§ge_bË
[
i
], 
	`mŒr_©Œib_to_¡r
(
ty³
));

410 
	}
}

412 
__š™
 
	$mŒr_if_š™
()

414 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

416 ià((!
	`ıu_has
(
c
, 
X86_FEATURE_MTRR
)) &&

417 (!
	`ıu_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

418 (!
	`ıu_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

419 (!
	`ıu_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

420  -
ENODEV
;

422 
	`´oc_ü—‹
("mŒr", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mŒr_fİs
);

424 
	}
}

426 
¬ch_š™ÿÎ
(
mŒr_if_š™
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	~<lšux/moduË.h
>

35 
	~<lšux/š™.h
>

36 
	~<lšux/pci.h
>

37 
	~<lšux/smp.h
>

38 
	~<lšux/ıu.h
>

39 
	~<lšux/mu‹x.h
>

40 
	~<lšux/sÜt.h
>

42 
	~<asm/e820.h
>

43 
	~<asm/mŒr.h
>

44 
	~<asm/uacûss.h
>

45 
	~<asm/´oûssÜ.h
>

46 
	~<asm/m¤.h
>

47 
	~<asm/kvm_·¿.h
>

48 
	~"mŒr.h
"

50 
u32
 
	gnum_v¬_¿nges
 = 0;

52 
	gmŒr_u§ge_bË
[
MTRR_MAX_VAR_RANGES
];

53 
DEFINE_MUTEX
(
mŒr_mu‹x
);

55 
u64
 
	gsize_Ü_mask
, 
	gsize_ªd_mask
;

57 
mŒr_İs
 * 
	gmŒr_İs
[
X86_VENDOR_NUM
] = {};

59 
mŒr_İs
 * 
	gmŒr_if
 = 
NULL
;

61 
£t_mŒr
(
»g
, 
ba£
,

62 
size
, 
mŒr_ty³
 
ty³
);

64 
	$£t_mŒr_İs
(
mŒr_İs
 * 
İs
)

66 ià(
İs
->
v’dÜ
 && ops->v’dÜ < 
X86_VENDOR_NUM
)

67 
mŒr_İs
[
İs
->
v’dÜ
] = ops;

68 
	}
}

71 
	$have_wrcomb
()

73 
pci_dev
 *
dev
;

74 
u8
 
»v
;

76 ià((
dev
 = 
	`pci_g‘_şass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
)) != NULL) {

79 ià(
dev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_SERVERWORKS
 &&

80 
dev
->
deviû
 =ğ
PCI_DEVICE_ID_SERVERWORKS_LE
) {

81 
	`pci_»ad_cÚfig_by‹
(
dev
, 
PCI_CLASS_REVISION
, &
»v
);

82 ià(
»v
 <= 5) {

83 
	`´štk
(
KERN_INFO
 "mtrr: Serverworks LE„ev < 6 detected. Write-combining disabled.\n");

84 
	`pci_dev_put
(
dev
);

90 ià(
dev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_INTEL
 &&

91 
dev
->
deviû
 =ğ
PCI_DEVICE_ID_INTEL_82451NX
) {

92 
	`´štk
(
KERN_INFO
 "mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

93 
	`pci_dev_put
(
dev
);

96 
	`pci_dev_put
(
dev
);

98  (
mŒr_if
->
have_wrcomb
 ? mŒr_if->
	`have_wrcomb
() : 0);

99 
	}
}

102 
__š™
 
	$£t_num_v¬_¿nges
()

104 
cÚfig
 = 0, 
dummy
;

106 ià(
	`u£_š‹l
()) {

107 
	`rdm¤
(
MTRRÿp_MSR
, 
cÚfig
, 
dummy
);

108 } ià(
	`is_ıu
(
AMD
))

109 
cÚfig
 = 2;

110 ià(
	`is_ıu
(
CYRIX
è|| is_ıu(
CENTAUR
))

111 
cÚfig
 = 8;

112 
num_v¬_¿nges
 = 
cÚfig
 & 0xff;

113 
	}
}

115 
__š™
 
	$š™_bË
()

117 
i
, 
max
;

119 
max
 = 
num_v¬_¿nges
;

120 
i
 = 0; i < 
max
; i++)

121 
mŒr_u§ge_bË
[
i
] = 1;

122 
	}
}

124 
	s£t_mŒr_d©a
 {

125 
©omic_t
 
	mcouÁ
;

126 
©omic_t
 
	mg©e
;

127 
	msmp_ba£
;

128 
	msmp_size
;

129 
	msmp_»g
;

130 
mŒr_ty³
 
	msmp_ty³
;

133 
	$i_hªdËr
(*
šfo
)

138 #ifdeà
CONFIG_SMP


139 
£t_mŒr_d©a
 *
d©a
 = 
šfo
;

140 
æags
;

142 
	`loÿl_œq_§ve
(
æags
);

144 
	`©omic_dec
(&
d©a
->
couÁ
);

145 !
	`©omic_»ad
(&
d©a
->
g©e
))

146 
	`ıu_»Ïx
();

149 ià(
d©a
->
smp_»g
 != ~0U)

150 
mŒr_if
->
	`£t
(
d©a
->
smp_»g
, d©a->
smp_ba£
,

151 
d©a
->
smp_size
, d©a->
smp_ty³
);

153 
mŒr_if
->
	`£t_®l
();

155 
	`©omic_dec
(&
d©a
->
couÁ
);

156 
	`©omic_»ad
(&
d©a
->
g©e
))

157 
	`ıu_»Ïx
();

159 
	`©omic_dec
(&
d©a
->
couÁ
);

160 
	`loÿl_œq_»¡Üe
(
æags
);

162 
	}
}

164 
šlše
 
	$ty³s_com·tibË
(
mŒr_ty³
 
ty³1
, mŒr_ty³ 
ty³2
) {

165  
ty³1
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

166 
ty³2
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

167 (
ty³1
 =ğ
MTRR_TYPE_WRTHROUGH
 && 
ty³2
 =ğ
MTRR_TYPE_WRBACK
) ||

168 (
ty³1
 =ğ
MTRR_TYPE_WRBACK
 && 
ty³2
 =ğ
MTRR_TYPE_WRTHROUGH
);

169 
	}
}

210 
	$£t_mŒr
(
»g
, 
ba£
,

211 
size
, 
mŒr_ty³
 
ty³
)

213 
£t_mŒr_d©a
 
d©a
;

214 
æags
;

216 
d©a
.
smp_»g
 = 
»g
;

217 
d©a
.
smp_ba£
 = 
ba£
;

218 
d©a
.
smp_size
 = 
size
;

219 
d©a
.
smp_ty³
 = 
ty³
;

220 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

222 
	`smp_wmb
();

223 
	`©omic_£t
(&
d©a
.
g©e
,0);

226 ià(
	`smp_ÿÎ_funùiÚ
(
i_hªdËr
, &
d©a
, 0) != 0)

227 
	`·nic
("mtrr:imed out waiting for other CPUs\n");

229 
	`loÿl_œq_§ve
(
æags
);

231 
	`©omic_»ad
(&
d©a
.
couÁ
))

232 
	`ıu_»Ïx
();

235 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

236 
	`smp_wmb
();

237 
	`©omic_£t
(&
d©a
.
g©e
,1);

247 ià(
»g
 != ~0U)

248 
mŒr_if
->
	`£t
(
»g
,
ba£
,
size
,
ty³
);

251 
	`©omic_»ad
(&
d©a
.
couÁ
))

252 
	`ıu_»Ïx
();

254 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

255 
	`smp_wmb
();

256 
	`©omic_£t
(&
d©a
.
g©e
,0);

262 
	`©omic_»ad
(&
d©a
.
couÁ
))

263 
	`ıu_»Ïx
();

265 
	`loÿl_œq_»¡Üe
(
æags
);

266 
	}
}

304 
	$mŒr_add_·ge
(
ba£
, 
size
,

305 
ty³
, 
boŞ
 
šüem’t
)

307 
i
, 
»¶aû
, 
”rÜ
;

308 
mŒr_ty³
 
Éy³
;

309 
lba£
, 
lsize
;

311 ià(!
mŒr_if
)

312  -
ENXIO
;

314 ià((
”rÜ
 = 
mŒr_if
->
	`v®id©e_add_·ge
(
ba£
,
size
,
ty³
)))

315  
”rÜ
;

317 ià(
ty³
 >ğ
MTRR_NUM_TYPES
) {

318 
	`´štk
(
KERN_WARNING
 "mŒr:y³: %u inv®id\n", 
ty³
);

319  -
EINVAL
;

323 ià((
ty³
 =ğ
MTRR_TYPE_WRCOMB
è&& !
	`have_wrcomb
()) {

324 
	`´štk
(
KERN_WARNING


326  -
ENOSYS
;

329 ià(!
size
) {

330 
	`´štk
(
KERN_WARNING
 "mtrr: zero sized„equest\n");

331  -
EINVAL
;

334 ià(
ba£
 & 
size_Ü_mask
 || 
size
 & size_or_mask) {

335 
	`´štk
(
KERN_WARNING
 "mtrr: base or sizeƒxceedshe MTRR width\n");

336  -
EINVAL
;

339 
”rÜ
 = -
EINVAL
;

340 
»¶aû
 = -1;

343 
	`g‘_Úlše_ıus
();

345 
	`mu‹x_lock
(&
mŒr_mu‹x
);

346 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

347 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

348 ià(!
lsize
 || 
ba£
 > 
lba£
 +†siz- 1 || ba£ + 
size
 - 1 <†base)

351 ià(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >†ba£ + 
lsize
 - 1) {

352 ià(
ba£
 <ğ
lba£
 && ba£ + 
size
 - 1 >ğlba£ + 
lsize
 - 1) {

354 ià(
ty³
 =ğ
Éy³
) {

355 
»¶aû
 =„•Ïû =ğ-1 ? 
i
 : -2;

358 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

361 
	`´štk
(
KERN_WARNING


363 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

364 
lsize
);

365 
out
;

368 ià(
Éy³
 !ğ
ty³
) {

369 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

371 
	`´štk
 (
KERN_WARNING
 "mtrr:ype mismatch for %lx000,%lx000 old: %s‚ew: %s\n",

372 
ba£
, 
size
, 
	`mŒr_©Œib_to_¡r
(
Éy³
),

373 
	`mŒr_©Œib_to_¡r
(
ty³
));

374 
out
;

376 ià(
šüem’t
)

377 ++
mŒr_u§ge_bË
[
i
];

378 
”rÜ
 = 
i
;

379 
out
;

382 
i
 = 
mŒr_if
->
	`g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû
);

383 ià(
i
 >= 0) {

384 
	`£t_mŒr
(
i
, 
ba£
, 
size
, 
ty³
);

385 ià(
	`lik–y
(
»¶aû
 < 0)) {

386 
mŒr_u§ge_bË
[
i
] = 1;

388 
mŒr_u§ge_bË
[
i
] = mŒr_u§ge_bË[
»¶aû
];

389 ià(
šüem’t
)

390 
mŒr_u§ge_bË
[
i
]++;

391 ià(
	`uÆik–y
(
»¶aû
 !ğ
i
)) {

392 
	`£t_mŒr
(
»¶aû
, 0, 0, 0);

393 
mŒr_u§ge_bË
[
»¶aû
] = 0;

397 
	`´štk
(
KERN_INFO
 "mtrr:‚o more MTRRs‡vailable\n");

398 
”rÜ
 = 
i
;

399 
out
:

400 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

401 
	`put_Úlše_ıus
();

402  
”rÜ
;

403 
	}
}

405 
	$mŒr_check
(
ba£
, 
size
)

407 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1))) {

408 
	`´štk
(
KERN_WARNING


410 
	`´štk
(
KERN_DEBUG


411 "mŒr: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

412 
	`dump_¡ack
();

416 
	}
}

455 
	$mŒr_add
(
ba£
, 
size
, 
ty³
,

456 
boŞ
 
šüem’t
)

458 ià(
	`mŒr_check
(
ba£
, 
size
))

459  -
EINVAL
;

460  
	`mŒr_add_·ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty³
,

461 
šüem’t
);

462 
	}
}

479 
	$mŒr_d–_·ge
(
»g
, 
ba£
, 
size
)

481 
i
, 
max
;

482 
mŒr_ty³
 
Éy³
;

483 
lba£
, 
lsize
;

484 
”rÜ
 = -
EINVAL
;

486 ià(!
mŒr_if
)

487  -
ENXIO
;

489 
max
 = 
num_v¬_¿nges
;

491 
	`g‘_Úlše_ıus
();

492 
	`mu‹x_lock
(&
mŒr_mu‹x
);

493 ià(
»g
 < 0) {

495 
i
 = 0; i < 
max
; ++i) {

496 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

497 ià(
lba£
 =ğ
ba£
 && 
lsize
 =ğ
size
) {

498 
»g
 = 
i
;

502 ià(
»g
 < 0) {

503 
	`´štk
(
KERN_DEBUG
 "mŒr:‚ØMTRR fÜ %lx000,%lx000 found\n", 
ba£
,

504 
size
);

505 
out
;

508 ià(
»g
 >ğ
max
) {

509 
	`´štk
(
KERN_WARNING
 "mŒr:„egi¡”: %doØbig\n", 
»g
);

510 
out
;

512 
mŒr_if
->
	`g‘
(
»g
, &
lba£
, &
lsize
, &
Éy³
);

513 ià(
lsize
 < 1) {

514 
	`´štk
(
KERN_WARNING
 "mŒr: MTRR %d‚Ù u£d\n", 
»g
);

515 
out
;

517 ià(
mŒr_u§ge_bË
[
»g
] < 1) {

518 
	`´štk
(
KERN_WARNING
 "mŒr:„eg: %d ha couÁ=0\n", 
»g
);

519 
out
;

521 ià(--
mŒr_u§ge_bË
[
»g
] < 1)

522 
	`£t_mŒr
(
»g
, 0, 0, 0);

523 
”rÜ
 = 
»g
;

524 
out
:

525 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

526 
	`put_Úlše_ıus
();

527  
”rÜ
;

528 
	}
}

545 
	$mŒr_d–
(
»g
, 
ba£
, 
size
)

547 ià(
	`mŒr_check
(
ba£
, 
size
))

548  -
EINVAL
;

549  
	`mŒr_d–_·ge
(
»g
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

550 
	}
}

552 
EXPORT_SYMBOL
(
mŒr_add
);

553 
EXPORT_SYMBOL
(
mŒr_d–
);

559 
__š™
 
	$š™_ifs
()

561 #iâdeà
CONFIG_X86_64


562 
	`amd_š™_mŒr
();

563 
	`cyrix_š™_mŒr
();

564 
	`ûÁaur_š™_mŒr
();

566 
	}
}

571 
	smŒr_v®ue
 {

572 
mŒr_ty³
 
	mÉy³
;

573 
	mlba£
;

574 
	mlsize
;

577 
mŒr_v®ue
 
	gmŒr_v®ue
[
MTRR_MAX_VAR_RANGES
];

579 
	$mŒr_§ve
(
sys_deviû
 * 
sysdev
, 
pm_mes§ge_t
 
¡©e
)

581 
i
;

583 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

584 
mŒr_if
->
	`g‘
(
i
,

585 &
mŒr_v®ue
[
i
].
lba£
,

586 &
mŒr_v®ue
[
i
].
lsize
,

587 &
mŒr_v®ue
[
i
].
Éy³
);

590 
	}
}

592 
	$mŒr_»¡Üe
(
sys_deviû
 * 
sysdev
)

594 
i
;

596 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

597 ià(
mŒr_v®ue
[
i
].
lsize
)

598 
	`£t_mŒr
(
i
,

599 
mŒr_v®ue
[
i
].
lba£
,

600 
mŒr_v®ue
[
i
].
lsize
,

601 
mŒr_v®ue
[
i
].
Éy³
);

604 
	}
}

608 
sysdev_driv”
 
	gmŒr_sysdev_driv”
 = {

609 .
su¥’d
 = 
mŒr_§ve
,

610 .
	g»sume
 = 
mŒr_»¡Üe
,

613 
__š™d©a
 
	gchªged_by_mŒr_ş—nup
;

622 
__š™
 
	$mŒr_bp_š™
()

624 
u32
 
phys_addr
;

625 
	`š™_ifs
();

627 
phys_addr
 = 32;

629 ià(
ıu_has_mŒr
) {

630 
mŒr_if
 = &
g’”ic_mŒr_İs
;

631 
size_Ü_mask
 = 0xff000000;

632 
size_ªd_mask
 = 0x00f00000;

633 
phys_addr
 = 36;

638 ià(
	`ıuid_—x
(0x80000000) >= 0x80000008) {

639 
phys_addr
 = 
	`ıuid_—x
(0x80000008) & 0xff;

641 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

642 
boÙ_ıu_d©a
.
x86
 == 0xF &&

643 
boÙ_ıu_d©a
.
x86_mod–
 == 0x3 &&

644 (
boÙ_ıu_d©a
.
x86_mask
 == 0x3 ||

645 
boÙ_ıu_d©a
.
x86_mask
 == 0x4))

646 
phys_addr
 = 36;

648 
size_Ü_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

649 
size_ªd_mask
 = ~
size_Ü_mask
 & 0xfffff00000ULL;

650 } ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_CENTAUR
 &&

651 
boÙ_ıu_d©a
.
x86
 == 6) {

654 
size_Ü_mask
 = 0xfff00000;

655 
size_ªd_mask
 = 0;

656 
phys_addr
 = 32;

659 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

660 
X86_VENDOR_AMD
:

661 ià(
ıu_has_k6_mŒr
) {

663 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_AMD
];

664 
size_Ü_mask
 = 0xfff00000;

665 
size_ªd_mask
 = 0;

668 
X86_VENDOR_CENTAUR
:

669 ià(
ıu_has_ûÁaur_mü
) {

670 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_CENTAUR
];

671 
size_Ü_mask
 = 0xfff00000;

672 
size_ªd_mask
 = 0;

675 
X86_VENDOR_CYRIX
:

676 ià(
ıu_has_cyrix_¬r
) {

677 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_CYRIX
];

678 
size_Ü_mask
 = 0xfff00000;

679 
size_ªd_mask
 = 0;

687 ià(
mŒr_if
) {

688 
	`£t_num_v¬_¿nges
();

689 
	`š™_bË
();

690 ià(
	`u£_š‹l
()) {

691 
	`g‘_mŒr_¡©e
();

693 ià(
	`mŒr_ş—nup
(
phys_addr
)) {

694 
chªged_by_mŒr_ş—nup
 = 1;

695 
mŒr_if
->
	`£t_®l
();

700 
	}
}

702 
	$mŒr_­_š™
()

704 
æags
;

706 ià(!
mŒr_if
 || !
	`u£_š‹l
())

716 
	`loÿl_œq_§ve
(
æags
);

718 
mŒr_if
->
	`£t_®l
();

720 
	`loÿl_œq_»¡Üe
(
æags
);

721 
	}
}

726 
	$mŒr_§ve_¡©e
()

728 
	`smp_ÿÎ_funùiÚ_sšgË
(0, 
mŒr_§ve_fixed_¿nges
, 
NULL
, 1);

729 
	}
}

731 
__š™
 
	$mŒr_š™_fšŸlize
()

733 ià(!
mŒr_if
)

735 ià(
	`u£_š‹l
()) {

736 ià(!
chªged_by_mŒr_ş—nup
)

737 
	`mŒr_¡©e_w¬n
();

745 
	`sysdev_driv”_»gi¡”
(&
ıu_sysdev_şass
,

746 &
mŒr_sysdev_driv”
);

749 
	}
}

750 
subsys_š™ÿÎ
(
mŒr_š™_fšŸlize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c

1 
	~<lšux/mm.h
>

2 
	~<lšux/š™.h
>

3 
	~<asm/io.h
>

4 
	~<asm/mŒr.h
>

5 
	~<asm/m¤.h
>

6 
	~<asm/´oûssÜ-cyrix.h
>

7 
	~<asm/´oûssÜ-æags.h
>

8 
	~"mŒr.h
"

12 
	$£t_mŒr_´•¬e_§ve
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

14 
ü0
;

17 
	`loÿl_œq_§ve
(
ùxt
->
æags
);

19 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

22 ià(
ıu_has_pge
) {

23 
ùxt
->
ü4v®
 = 
	`»ad_ü4
();

24 
	`wr™e_ü4
(
ùxt
->
ü4v®
 & ~
X86_CR4_PGE
);

31 
ü0
 = 
	`»ad_ü0
(è| 
X86_CR0_CD
;

32 
	`wbšvd
();

33 
	`wr™e_ü0
(
ü0
);

34 
	`wbšvd
();

36 ià(
	`u£_š‹l
())

38 
	`rdm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
, ctxt->
deáy³_hi
);

41 
ùxt
->
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

43 
	}
}

45 
	$£t_mŒr_ÿche_di§bË
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

47 ià(
	`u£_š‹l
())

49 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
 & 0xf300UL,

50 
ùxt
->
deáy³_hi
);

51 ià(
	`is_ıu
(
CYRIX
))

53 
	`£tCx86
(
CX86_CCR3
, (
ùxt
->
cü3
 & 0x0f) | 0x10);

54 
	}
}

57 
	$£t_mŒr_dÚe
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

59 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

62 
	`wbšvd
();

65 ià(
	`u£_š‹l
())

67 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
, ctxt->
deáy³_hi
);

70 
	`£tCx86
(
CX86_CCR3
, 
ùxt
->
cü3
);

73 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

76 ià(
ıu_has_pge
)

77 
	`wr™e_ü4
(
ùxt
->
ü4v®
);

80 
	`loÿl_œq_»¡Üe
(
ùxt
->
æags
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<lšux/³rıu.h
>

15 
	~<lšux/moduË.h
>

16 
	~<lšux/k”Ãl.h
>

17 
	~<lšux/b™İs.h
>

18 
	~<lšux/smp.h
>

19 
	~<lšux/nmi.h
>

20 
	~<lšux/k´obes.h
>

22 
	~<asm/g’­ic.h
>

23 
	~<asm/š‹l_¬ch_³rfmÚ.h
>

25 
	snmi_w©chdog_ùlblk
 {

26 
	mccü_m¤
;

27 
	m³rfùr_m¤
;

28 
	mevÁ£l_m¤
;

32 
	swd_İs
 {

33 (*
	m»£rve
)();

34 (*
	muÄe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	m»¬m
)(
nmi_w©chdog_ùlblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m¡İ
)();

38 
	m³rfùr
;

39 
	mevÁ£l
;

40 
u64
 
	mcheckb™
;

43 cÚ¡ 
wd_İs
 *
	gwd_İs
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
³rfùr_nmi_owÃr
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
evÁ£l_nmi_owÃr
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_ùlblk
,‚mi_watchdog_ctlblk);

66 
šlše
 
	$nmi_³rfùr_m¤_to_b™
(
m¤
)

69 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

70 
X86_VENDOR_AMD
:

71  (
m¤
 - 
MSR_K7_PERFCTR0
);

72 
X86_VENDOR_INTEL
:

73 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  (
m¤
 - 
MSR_ARCH_PERFMON_PERFCTR0
);

76 
boÙ_ıu_d©a
.
x86
) {

78  (
m¤
 - 
MSR_P6_PERFCTR0
);

80  (
m¤
 - 
MSR_P4_BPU_PERFCTR0
);

84 
	}
}

90 
šlše
 
	$nmi_evÁ£l_m¤_to_b™
(
m¤
)

93 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

94 
X86_VENDOR_AMD
:

95  (
m¤
 - 
MSR_K7_EVNTSEL0
);

96 
X86_VENDOR_INTEL
:

97 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  (
m¤
 - 
MSR_ARCH_PERFMON_EVENTSEL0
);

100 
boÙ_ıu_d©a
.
x86
) {

102  (
m¤
 - 
MSR_P6_EVNTSEL0
);

104  (
m¤
 - 
MSR_P4_BSU_ESCR0
);

109 
	}
}

112 
	$ava_to_»¤v_³rfùr_nmi_b™
(
couÁ”
)

114 
	`BUG_ON
(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
);

116  (!
	`‹¡_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
));

117 
	}
}

120 
	$ava_to_»¤v_³rfùr_nmi
(
m¤
)

122 
couÁ”
;

124 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

125 
	`BUG_ON
(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
);

127  (!
	`‹¡_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
));

128 
	}
}

129 
EXPORT_SYMBOL
(
ava_to_»¤v_³rfùr_nmi_b™
);

131 
	$»£rve_³rfùr_nmi
(
m¤
)

133 
couÁ”
;

135 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

137 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

140 ià(!
	`‹¡_ªd_£t_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
))

143 
	}
}

144 
EXPORT_SYMBOL
(
»£rve_³rfùr_nmi
);

146 
	$»Ëa£_³rfùr_nmi
(
m¤
)

148 
couÁ”
;

150 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

152 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

155 
	`ş—r_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
);

156 
	}
}

157 
EXPORT_SYMBOL
(
»Ëa£_³rfùr_nmi
);

159 
	$»£rve_evÁ£l_nmi
(
m¤
)

161 
couÁ”
;

163 
couÁ”
 = 
	`nmi_evÁ£l_m¤_to_b™
(
m¤
);

165 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

168 ià(!
	`‹¡_ªd_£t_b™
(
couÁ”
, 
evÁ£l_nmi_owÃr
))

171 
	}
}

172 
EXPORT_SYMBOL
(
»£rve_evÁ£l_nmi
);

174 
	$»Ëa£_evÁ£l_nmi
(
m¤
)

176 
couÁ”
;

178 
couÁ”
 = 
	`nmi_evÁ£l_m¤_to_b™
(
m¤
);

180 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

183 
	`ş—r_b™
(
couÁ”
, 
evÁ£l_nmi_owÃr
);

184 
	}
}

185 
EXPORT_SYMBOL
(
»Ëa£_evÁ£l_nmi
);

187 
	$di§bË_Ïpic_nmi_w©chdog
()

189 
	`BUG_ON
(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
);

191 ià(
	`©omic_»ad
(&
nmi_aùive
) <= 0)

194 
	`Ú_—ch_ıu
(
¡İ_­ic_nmi_w©chdog
, 
NULL
, 1);

196 ià(
wd_İs
)

197 
wd_İs
->
	`uÄe£rve
();

199 
	`BUG_ON
(
	`©omic_»ad
(&
nmi_aùive
) != 0);

200 
	}
}

202 
	$’abË_Ïpic_nmi_w©chdog
()

204 
	`BUG_ON
(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
);

207 ià(
	`©omic_»ad
(&
nmi_aùive
) != 0)

211 ià(!
wd_İs
)

213 ià(!
wd_İs
->
	`»£rve
()) {

214 
	`´štk
(
KERN_ERR
 "NMI watchdog: cannot„eserve…erfctrs\n");

218 
	`Ú_—ch_ıu
(
£tup_­ic_nmi_w©chdog
, 
NULL
, 1);

219 
	`touch_nmi_w©chdog
();

220 
	}
}

226 
	$adju¡_fÜ_32b™_ùr
(
hz
)

228 
u64
 
couÁ”_v®
;

229 
»tv®
 = 
hz
;

238 
couÁ”_v®
 = (
u64
)
ıu_khz
 * 1000;

239 
	`do_div
(
couÁ”_v®
, 
»tv®
);

240 ià(
couÁ”_v®
 > 0x7fffffffULL) {

241 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

242 
	`do_div
(
couÁ
, 0x7fffffffUL);

243 
»tv®
 = 
couÁ
 + 1;

245  
»tv®
;

246 
	}
}

248 
	$wr™e_w©chdog_couÁ”
(
³rfùr_m¤
,

249 cÚ¡ *
desü
, 
nmi_hz
)

251 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

253 
	`do_div
(
couÁ
, 
nmi_hz
);

254 if(
desü
)

255 
	`´_debug
("£‰šg % tØ-0x%08Lx\n", 
desü
, 
couÁ
);

256 
	`wrm¤l
(
³rfùr_m¤
, 0 - 
couÁ
);

257 
	}
}

259 
	$wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
,

260 cÚ¡ *
desü
, 
nmi_hz
)

262 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

264 
	`do_div
(
couÁ
, 
nmi_hz
);

265 if(
desü
)

266 
	`´_debug
("£‰šg % tØ-0x%08Lx\n", 
desü
, 
couÁ
);

267 
	`wrm¤
(
³rfùr_m¤
, (
u32
)(-
couÁ
), 0);

268 
	}
}

274 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

275 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

276 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

277 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

278 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

279 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

281 
	$£tup_k7_w©chdog
(
nmi_hz
)

283 
³rfùr_m¤
, 
evÁ£l_m¤
;

284 
evÁ£l
;

285 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

287 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

288 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

290 
	`wrm¤l
(
³rfùr_m¤
, 0UL);

292 
evÁ£l
 = 
K7_EVNTSEL_INT


293 | 
K7_EVNTSEL_OS


294 | 
K7_EVNTSEL_USR


295 | 
K7_NMI_EVENT
;

298 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

299 
	`wr™e_w©chdog_couÁ”
(
³rfùr_m¤
, "K7_PERFCTR0",
nmi_hz
);

302 
wd
->
³rfùr_m¤
 =…erfctr_msr;

303 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

304 
wd
->
ccü_m¤
 = 0;

307 
	`ıu_nmi_£t_wd_’abËd
();

309 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

310 
evÁ£l
 |ğ
K7_EVNTSEL_ENABLE
;

311 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

314 
	}
}

316 
	$sšgË_m¤_¡İ_w©chdog
()

318 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

320 
	`wrm¤
(
wd
->
evÁ£l_m¤
, 0, 0);

321 
	}
}

323 
	$sšgË_m¤_»£rve
()

325 ià(!
	`»£rve_³rfùr_nmi
(
wd_İs
->
³rfùr
))

328 ià(!
	`»£rve_evÁ£l_nmi
(
wd_İs
->
evÁ£l
)) {

329 
	`»Ëa£_³rfùr_nmi
(
wd_İs
->
³rfùr
);

333 
	}
}

335 
	$sšgË_m¤_uÄe£rve
()

337 
	`»Ëa£_evÁ£l_nmi
(
wd_İs
->
evÁ£l
);

338 
	`»Ëa£_³rfùr_nmi
(
wd_İs
->
³rfùr
);

339 
	}
}

341 
__k´obes


342 
	$sšgË_m¤_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

345 
	`wr™e_w©chdog_couÁ”
(
wd
->
³rfùr_m¤
, 
NULL
, 
nmi_hz
);

346 
	}
}

348 cÚ¡ 
wd_İs
 
	gk7_wd_İs
 = {

349 .
»£rve
 = 
sšgË_m¤_»£rve
,

350 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

351 .
	g£tup
 = 
£tup_k7_w©chdog
,

352 .
	g»¬m
 = 
sšgË_m¤_»¬m
,

353 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

354 .
	g³rfùr
 = 
MSR_K7_PERFCTR0
,

355 .
	gevÁ£l
 = 
MSR_K7_EVNTSEL0
,

356 .
	gcheckb™
 = 1ULL << 47,

362 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

363 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

364 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

365 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

366 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

367 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

369 
	$£tup_p6_w©chdog
(
nmi_hz
)

371 
³rfùr_m¤
, 
evÁ£l_m¤
;

372 
evÁ£l
;

373 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

375 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

376 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

379 ià(
	`wrm¤_§ã
(
³rfùr_m¤
, 0, 0) < 0)

382 
evÁ£l
 = 
P6_EVNTSEL_INT


383 | 
P6_EVNTSEL_OS


384 | 
P6_EVNTSEL_USR


385 | 
P6_NMI_EVENT
;

388 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

389 
nmi_hz
 = 
	`adju¡_fÜ_32b™_ùr
(nmi_hz);

390 
	`wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
, "P6_PERFCTR0",
nmi_hz
);

393 
wd
->
³rfùr_m¤
 =…erfctr_msr;

394 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

395 
wd
->
ccü_m¤
 = 0;

398 
	`ıu_nmi_£t_wd_’abËd
();

400 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

401 
evÁ£l
 |ğ
P6_EVNTSEL0_ENABLE
;

402 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

405 
	}
}

407 
__k´obes
 
	$p6_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

415 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

418 
	`wr™e_w©chdog_couÁ”32
(
wd
->
³rfùr_m¤
, 
NULL
,
nmi_hz
);

419 
	}
}

421 cÚ¡ 
wd_İs
 
	gp6_wd_İs
 = {

422 .
»£rve
 = 
sšgË_m¤_»£rve
,

423 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

424 .
	g£tup
 = 
£tup_p6_w©chdog
,

425 .
	g»¬m
 = 
p6_»¬m
,

426 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

427 .
	g³rfùr
 = 
MSR_P6_PERFCTR0
,

428 .
	gevÁ£l
 = 
MSR_P6_EVNTSEL0
,

429 .
	gcheckb™
 = 1ULL << 39,

436 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

437 
	#P4_ESCR_EVENT_SELECT
(
N
è((Nè<< 25)

	)

438 
	#P4_ESCR_OS
 (1 << 3)

	)

439 
	#P4_ESCR_USR
 (1 << 2)

	)

440 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

441 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

442 
	#P4_CCCR_THRESHOLD
(
N
è((Nè<< 20)

	)

443 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

444 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

445 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

446 
	#P4_CCCR_ESCR_SELECT
(
N
è((Nè<< 13)

	)

447 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

448 
	#P4_CCCR_OVF
 (1 << 31)

	)

450 
	#P4_CONTROLS
 18

	)

451 
	gp4_cÚŒŞs
[18] = {

452 
MSR_P4_BPU_CCCR0
,

453 
MSR_P4_BPU_CCCR1
,

454 
MSR_P4_BPU_CCCR2
,

455 
MSR_P4_BPU_CCCR3
,

456 
MSR_P4_MS_CCCR0
,

457 
MSR_P4_MS_CCCR1
,

458 
MSR_P4_MS_CCCR2
,

459 
MSR_P4_MS_CCCR3
,

460 
MSR_P4_FLAME_CCCR0
,

461 
MSR_P4_FLAME_CCCR1
,

462 
MSR_P4_FLAME_CCCR2
,

463 
MSR_P4_FLAME_CCCR3
,

464 
MSR_P4_IQ_CCCR0
,

465 
MSR_P4_IQ_CCCR1
,

466 
MSR_P4_IQ_CCCR2
,

467 
MSR_P4_IQ_CCCR3
,

468 
MSR_P4_IQ_CCCR4
,

469 
MSR_P4_IQ_CCCR5
,

476 
	$£tup_p4_w©chdog
(
nmi_hz
)

478 
³rfùr_m¤
, 
evÁ£l_m¤
, 
ccü_m¤
;

479 
evÁ£l
, 
ccü_v®
;

480 
misc_’abË
, 
dummy
;

481 
ht_num
;

482 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

484 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
, 
dummy
);

485 ià(!(
misc_’abË
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

488 #ifdeà
CONFIG_SMP


490 ià(
smp_num_siblšgs
 == 2) {

491 
ebx
, 
­icid
;

493 
ebx
 = 
	`ıuid_ebx
(1);

494 
­icid
 = (
ebx
 >> 24) & 0xff;

495 
ht_num
 = 
­icid
 & 1;

498 
ht_num
 = 0;

506 ià(!
ht_num
) {

508 
³rfùr_m¤
 = 
MSR_P4_IQ_PERFCTR0
;

509 
evÁ£l_m¤
 = 
MSR_P4_CRU_ESCR0
;

510 
ccü_m¤
 = 
MSR_P4_IQ_CCCR0
;

511 
ccü_v®
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

522 ià(
»£t_deviûs
) {

523 
low
, 
high
;

524 
i
;

526 
i
 = 0; i < 
P4_CONTROLS
; i++) {

527 
	`rdm¤
(
p4_cÚŒŞs
[
i
], 
low
, 
high
);

528 
low
 &ğ~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

529 
	`wrm¤
(
p4_cÚŒŞs
[
i
], 
low
, 
high
);

534 
³rfùr_m¤
 = 
MSR_P4_IQ_PERFCTR1
;

535 
evÁ£l_m¤
 = 
MSR_P4_CRU_ESCR0
;

536 
ccü_m¤
 = 
MSR_P4_IQ_CCCR1
;

539 ià(
boÙ_ıu_d©a
.
x86_mod–
 =ğ4 && boÙ_ıu_d©a.
x86_mask
 == 4)

540 
ccü_v®
 = 
P4_CCCR_OVF_PMI0
;

542 
ccü_v®
 = 
P4_CCCR_OVF_PMI1
;

543 
ccü_v®
 |ğ
	`P4_CCCR_ESCR_SELECT
(4);

546 
evÁ£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

547 | 
P4_ESCR_OS


548 | 
P4_ESCR_USR
;

550 
ccü_v®
 |ğ
	`P4_CCCR_THRESHOLD
(15)

551 | 
P4_CCCR_COMPLEMENT


552 | 
P4_CCCR_COMPARE


553 | 
P4_CCCR_REQUIRED
;

555 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

556 
	`wrm¤
(
ccü_m¤
, 
ccü_v®
, 0);

557 
	`wr™e_w©chdog_couÁ”
(
³rfùr_m¤
, "P4_IQ_COUNTER0", 
nmi_hz
);

559 
wd
->
³rfùr_m¤
 =…erfctr_msr;

560 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

561 
wd
->
ccü_m¤
 = cccr_msr;

564 
	`ıu_nmi_£t_wd_’abËd
();

566 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

567 
ccü_v®
 |ğ
P4_CCCR_ENABLE
;

568 
	`wrm¤
(
ccü_m¤
, 
ccü_v®
, 0);

570 
	}
}

572 
	$¡İ_p4_w©chdog
()

574 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

575 
	`wrm¤
(
wd
->
ccü_m¤
, 0, 0);

576 
	`wrm¤
(
wd
->
evÁ£l_m¤
, 0, 0);

577 
	}
}

579 
	$p4_»£rve
()

581 ià(!
	`»£rve_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
))

583 #ifdeà
CONFIG_SMP


584 ià(
smp_num_siblšgs
 > 1 && !
	`»£rve_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
))

585 
ç1
;

587 ià(!
	`»£rve_evÁ£l_nmi
(
MSR_P4_CRU_ESCR0
))

588 
ç2
;

591 
ç2
:

592 #ifdeà
CONFIG_SMP


593 ià(
smp_num_siblšgs
 > 1)

594 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
);

595 
ç1
:

597 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
);

599 
	}
}

601 
	$p4_uÄe£rve
()

603 #ifdeà
CONFIG_SMP


604 ià(
smp_num_siblšgs
 > 1)

605 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
);

607 
	`»Ëa£_evÁ£l_nmi
(
MSR_P4_CRU_ESCR0
);

608 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
);

609 
	}
}

611 
__k´obes
 
	$p4_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

613 
dummy
;

621 
	`rdm¤l
(
wd
->
ccü_m¤
, 
dummy
);

622 
dummy
 &ğ~
P4_CCCR_OVF
;

623 
	`wrm¤l
(
wd
->
ccü_m¤
, 
dummy
);

624 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

626 
	`wr™e_w©chdog_couÁ”
(
wd
->
³rfùr_m¤
, 
NULL
, 
nmi_hz
);

627 
	}
}

629 cÚ¡ 
wd_İs
 
	gp4_wd_İs
 = {

630 .
»£rve
 = 
p4_»£rve
,

631 .
	guÄe£rve
 = 
p4_uÄe£rve
,

632 .
	g£tup
 = 
£tup_p4_w©chdog
,

633 .
	g»¬m
 = 
p4_»¬m
,

634 .
	g¡İ
 = 
¡İ_p4_w©chdog
,

636 .
	g³rfùr
 = 
MSR_P4_BPU_PERFCTR0
,

637 .
	gevÁ£l
 = 
MSR_P4_BSU_ESCR0
,

638 .
	gcheckb™
 = 1ULL << 39,

645 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

646 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

648 
wd_İs
 
	gš‹l_¬ch_wd_İs
;

650 
	$£tup_š‹l_¬ch_w©chdog
(
nmi_hz
)

652 
ebx
;

653 
ıuid10_—x
 
—x
;

654 
unu£d
;

655 
³rfùr_m¤
, 
evÁ£l_m¤
;

656 
evÁ£l
;

657 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

664 
	`ıuid
(10, &(
—x
.
fuÎ
), &
ebx
, &
unu£d
, &unused);

665 ià((
—x
.
¥l™
.
mask_Ëngth
 < (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

666 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

669 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

670 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

672 
	`wrm¤l
(
³rfùr_m¤
, 0UL);

674 
evÁ£l
 = 
ARCH_PERFMON_EVENTSEL_INT


675 | 
ARCH_PERFMON_EVENTSEL_OS


676 | 
ARCH_PERFMON_EVENTSEL_USR


677 | 
ARCH_PERFMON_NMI_EVENT_SEL


678 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

681 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

682 
nmi_hz
 = 
	`adju¡_fÜ_32b™_ùr
(nmi_hz);

683 
	`wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

685 
wd
->
³rfùr_m¤
 =…erfctr_msr;

686 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

687 
wd
->
ccü_m¤
 = 0;

690 
	`ıu_nmi_£t_wd_’abËd
();

692 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

693 
evÁ£l
 |ğ
ARCH_PERFMON_EVENTSEL0_ENABLE
;

694 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

695 
š‹l_¬ch_wd_İs
.
checkb™
 = 1ULL << (
—x
.
¥l™
.
b™_width
 - 1);

697 
	}
}

699 
wd_İs
 
š‹l_¬ch_wd_İs
 
	g__»ad_mo¡ly
 = {

700 .
»£rve
 = 
sšgË_m¤_»£rve
,

701 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

702 .
	g£tup
 = 
£tup_š‹l_¬ch_w©chdog
,

703 .
	g»¬m
 = 
p6_»¬m
,

704 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

705 .
	g³rfùr
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

706 .
	gevÁ£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

709 
	$´obe_nmi_w©chdog
()

711 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

712 
X86_VENDOR_AMD
:

713 ià(
boÙ_ıu_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

714 
boÙ_ıu_d©a
.
x86
 != 16)

716 
wd_İs
 = &
k7_wd_İs
;

718 
X86_VENDOR_INTEL
:

723 ià(
boÙ_ıu_d©a
.
x86
 =ğ6 && boÙ_ıu_d©a.
x86_mod–
 == 14) {

724 
š‹l_¬ch_wd_İs
.
³rfùr
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

725 
š‹l_¬ch_wd_İs
.
evÁ£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

727 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

728 
wd_İs
 = &
š‹l_¬ch_wd_İs
;

731 
boÙ_ıu_d©a
.
x86
) {

733 ià(
boÙ_ıu_d©a
.
x86_mod–
 > 13)

736 
wd_İs
 = &
p6_wd_İs
;

739 
wd_İs
 = &
p4_wd_İs
;

746 
	}
}

750 
	$Ïpic_w©chdog_š™
(
nmi_hz
)

752 ià(!
wd_İs
) {

753 
	`´obe_nmi_w©chdog
();

754 ià(!
wd_İs
) {

755 
	`´štk
(
KERN_INFO
 "NMI watchdog: CPU‚ot supported\n");

759 ià(!
wd_İs
->
	`»£rve
()) {

760 
	`´štk
(
KERN_ERR


766 ià(!(
wd_İs
->
	`£tup
(
nmi_hz
))) {

767 
	`´štk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

768 
	`¿w_smp_´oûssÜ_id
());

773 
	}
}

775 
	$Ïpic_w©chdog_¡İ
()

777 ià(
wd_İs
)

778 
wd_İs
->
	`¡İ
();

779 
	}
}

781 
	$Ïpic_adju¡_nmi_hz
(
hz
)

783 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

784 ià(
wd
->
³rfùr_m¤
 =ğ
MSR_P6_PERFCTR0
 ||

785 
wd
->
³rfùr_m¤
 =ğ
MSR_ARCH_PERFMON_PERFCTR1
)

786 
hz
 = 
	`adju¡_fÜ_32b™_ùr
(hz);

787  
hz
;

788 
	}
}

790 
__k´obes
 
	$Ïpic_wd_ev’t
(
nmi_hz
)

792 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

793 
u64
 
ùr
;

795 
	`rdm¤l
(
wd
->
³rfùr_m¤
, 
ùr
);

796 ià(
ùr
 & 
wd_İs
->
checkb™
)

799 
wd_İs
->
	`»¬m
(
wd
, 
nmi_hz
);

801 
	}
}

803 
	$Ïpic_w©chdog_ok
()

805  
wd_İs
 !ğ
NULL
;

806 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/ıuã©u».h
>

9 cÚ¡ *cÚ¡ 
	gx86_pow”_æags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<lšux/smp.h
>

2 
	~<lšux/timex.h
>

3 
	~<lšux/¡ršg.h
>

4 
	~<lšux/£q_fe.h
>

5 
	~<lšux/ıuäeq.h
>

10 
	$show_ıušfo_cÜe
(
£q_fe
 *
m
, 
ıušfo_x86
 *
c
,

11 
ıu
)

13 #ifdeà
CONFIG_SMP


14 ià(
c
->
x86_max_cÜes
 * 
smp_num_siblšgs
 > 1) {

15 
	`£q_´štf
(
m
, "physiÿÈid\t: %d\n", 
c
->
phys_´oc_id
);

16 
	`£q_´štf
(
m
, "siblings\t: %d\n",

17 
	`ıumask_weight
(
	`ıu_cÜe_mask
(
ıu
)));

18 
	`£q_´štf
(
m
, "cÜid\t\t: %d\n", 
c
->
ıu_cÜe_id
);

19 
	`£q_´štf
(
m
, "ıu cÜes\t: %d\n", 
c
->
boÙed_cÜes
);

20 
	`£q_´štf
(
m
, "­icid\t\t: %d\n", 
c
->
­icid
);

21 
	`£q_´štf
(
m
, "š™ŸÈ­icid\t: %d\n", 
c
->
š™Ÿl_­icid
);

24 
	}
}

26 #ifdeà
CONFIG_X86_32


27 
	$show_ıušfo_misc
(
£q_fe
 *
m
, 
ıušfo_x86
 *
c
)

33 
åu_exû±iÚ
 = 
c
->
h¬d_m©h
 && (
ignÜe_åu_œq
 || 
ıu_has_åu
);

34 
	`£q_´štf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
hÉ_wÜks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¬d_m©h
 ? "yes" : "no",

48 
åu_exû±iÚ
 ? "yes" : "no",

49 
c
->
ıuid_Ëv–
,

50 
c
->
wp_wÜks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_ıušfo_misc
(
£q_fe
 *
m
, 
ıušfo_x86
 *
c
)

55 
	`£q_´štf
(
m
,

60 
c
->
ıuid_Ëv–
);

61 
	}
}

64 
	$show_ıušfo
(
£q_fe
 *
m
, *
v
)

66 
ıušfo_x86
 *
c
 = 
v
;

67 
ıu
 = 0;

68 
i
;

70 #ifdeà
CONFIG_SMP


71 
ıu
 = 
c
->
ıu_šdex
;

73 
	`£q_´štf
(
m
, "processor\t: %u\n"

78 
ıu
,

79 
c
->
x86_v’dÜ_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_mod–
,

82 
c
->
x86_mod–_id
[0] ? c->x86_model_id : "unknown");

84 ià(
c
->
x86_mask
 || c->
ıuid_Ëv–
 >= 0)

85 
	`£q_´štf
(
m
, "¡•pšg\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_´štf
(
m
, "stepping\t: unknown\n");

89 ià(
	`ıu_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
äeq
 = 
	`ıuäeq_quick_g‘
(
ıu
);

92 ià(!
äeq
)

93 
äeq
 = 
ıu_khz
;

94 
	`£q_´štf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
äeq
 / 1000, (freq % 1000));

99 ià(
c
->
x86_ÿche_size
 >= 0)

100 
	`£q_´štf
(
m
, "ÿchsize\t: %d KB\n", 
c
->
x86_ÿche_size
);

102 
	`show_ıušfo_cÜe
(
m
, 
c
, 
ıu
);

103 
	`show_ıušfo_misc
(
m
, 
c
);

105 
	`£q_´štf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 ià(
	`ıu_has
(
c
, 
i
è&& 
x86_ÿp_æags
[i] !ğ
NULL
)

108 
	`£q_´štf
(
m
, " %s", 
x86_ÿp_æags
[
i
]);

110 
	`£q_´štf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
loİs_³r_jiffy
/(500000/
HZ
),

112 (
c
->
loİs_³r_jiffy
/(5000/
HZ
)) % 100);

114 #ifdeà
CONFIG_X86_64


115 ià(
c
->
x86_bsize
 > 0)

116 
	`£q_´štf
(
m
, "TLB size\t: %d 4K…ages\n", 
c
->
x86_bsize
);

118 
	`£q_´štf
(
m
, "şæush size\t: %u\n", 
c
->
x86_şæush_size
);

119 #ifdeà
CONFIG_X86_64


120 
	`£q_´štf
(
m
, "ÿche_®ignm’t\t: %d\n", 
c
->
x86_ÿche_®ignm’t
);

121 
	`£q_´štf
(
m
, "address sizes\t: %u bits…hysical, %u bits virtual\n",

122 
c
->
x86_phys_b™s
, c->
x86_vœt_b™s
);

125 
	`£q_´štf
(
m
, "power management:");

126 
i
 = 0; i < 32; i++) {

127 ià(
c
->
x86_pow”
 & (1 << 
i
)) {

128 ià(
i
 < 
	`ARRAY_SIZE
(
x86_pow”_æags
) &&

129 
x86_pow”_æags
[
i
])

130 
	`£q_´štf
(
m
, "%s%s",

131 
x86_pow”_æags
[
i
][0]?" ":"",

132 
x86_pow”_æags
[
i
]);

134 
	`£q_´štf
(
m
, " [%d]", 
i
);

138 
	`£q_´štf
(
m
, "\n\n");

141 
	}
}

143 *
	$c_¡¬t
(
£q_fe
 *
m
, 
loff_t
 *
pos
)

145 ià(*
pos
 == 0)

146 *
pos
 = 
	`ıumask_fœ¡
(
ıu_Úlše_mask
);

148 *
pos
 = 
	`ıumask_Ãxt
(*po - 1, 
ıu_Úlše_mask
);

149 ià((*
pos
è< 
Ä_ıu_ids
)

150  &
	`ıu_d©a
(*
pos
);

151  
NULL
;

152 
	}
}

154 *
	$c_Ãxt
(
£q_fe
 *
m
, *
v
, 
loff_t
 *
pos
)

156 (*
pos
)++;

157  
	`c_¡¬t
(
m
, 
pos
);

158 
	}
}

160 
	$c_¡İ
(
£q_fe
 *
m
, *
v
)

162 
	}
}

164 cÚ¡ 
£q_İ”©iÚs
 
	gıušfo_İ
 = {

165 .
¡¬t
 = 
c_¡¬t
,

166 .
	gÃxt
 = 
c_Ãxt
,

167 .
	g¡İ
 = 
c_¡İ
,

168 .
	gshow
 = 
show_ıušfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<lšux/dmi.h
>

25 
	~<asm/div64.h
>

26 
	~<asm/vmw¬e.h
>

28 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

29 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

30 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

32 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

33 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

35 
	#VMWARE_PORT
(
cmd
, 
—x
, 
ebx
, 
ecx
, 
edx
) \

36 
	`__asm__
("inl (%%dx)" : \

37 "÷"(
—x
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

38 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

39 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

40 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

41 "memÜy");

	)

43 
šlše
 
	$__vmw¬e_¶©fÜm
()

45 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

46 
	`VMWARE_PORT
(
GETVERSION
, 
—x
, 
ebx
, 
ecx
, 
edx
);

47  
—x
 !ğ(
ušt32_t
)-1 && 
ebx
 =ğ
VMWARE_HYPERVISOR_MAGIC
;

48 
	}
}

50 
	$__vmw¬e_g‘_tsc_khz
()

52 
ušt64_t
 
tsc_hz
;

53 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

55 
	`VMWARE_PORT
(
GETHZ
, 
—x
, 
ebx
, 
ecx
, 
edx
);

57 ià(
ebx
 =ğ
UINT_MAX
)

59 
tsc_hz
 = 
—x
 | (((
ušt64_t
)
ebx
) << 32);

60 
	`do_div
(
tsc_hz
, 1000);

61 
	`BUG_ON
(
tsc_hz
 >> 32);

62  
tsc_hz
;

63 
	}
}

70 
	$vmw¬e_¶©fÜm
()

72 ià(
ıu_has_hy³rvisÜ
) {

73 
—x
, 
ebx
, 
ecx
, 
edx
;

74 
hy³r_v’dÜ_id
[13];

76 
	`ıuid
(
CPUID_VMWARE_INFO_LEAF
, &
—x
, &
ebx
, &
ecx
, &
edx
);

77 
	`memıy
(
hy³r_v’dÜ_id
 + 0, &
ebx
, 4);

78 
	`memıy
(
hy³r_v’dÜ_id
 + 4, &
ecx
, 4);

79 
	`memıy
(
hy³r_v’dÜ_id
 + 8, &
edx
, 4);

80 
hy³r_v’dÜ_id
[12] = '\0';

81 ià(!
	`¡rcmp
(
hy³r_v’dÜ_id
, "VMwareVMware"))

83 } ià(
dmi_avaabË
 && 
	`dmi_Çme_š_£rŸl
("VMware") &&

84 
	`__vmw¬e_¶©fÜm
())

88 
	}
}

90 
	$vmw¬e_g‘_tsc_khz
()

92 
	`BUG_ON
(!
	`vmw¬e_¶©fÜm
());

93  
	`__vmw¬e_g‘_tsc_khz
();

94 
	}
}

108 
__ıuš™
 
	$vmw¬e_£t_ã©u»_b™s
(
ıušfo_x86
 *
c
)

110 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

111 
	`£t_ıu_ÿp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

112 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<lšux/moduË.h
>

30 
	~<lšux/ty³s.h
>

31 
	~<lšux/”ºo.h
>

32 
	~<lšux/fú.h
>

33 
	~<lšux/š™.h
>

34 
	~<lšux/pŞl.h
>

35 
	~<lšux/smp.h
>

36 
	~<lšux/smp_lock.h
>

37 
	~<lšux/majÜ.h
>

38 
	~<lšux/fs.h
>

39 
	~<lšux/deviû.h
>

40 
	~<lšux/ıu.h
>

41 
	~<lšux/nÙif›r.h
>

42 
	~<lšux/uacûss.h
>

44 
	~<asm/´oûssÜ.h
>

45 
	~<asm/m¤.h
>

46 
	~<asm/sy¡em.h
>

48 
şass
 *
	gıuid_şass
;

50 
	sıuid_»gs
 {

51 
u32
 
	m—x
, 
	mebx
, 
	mecx
, 
	medx
;

54 
	$ıuid_smp_ıuid
(*
cmd_block
)

56 
ıuid_»gs
 *
cmd
 = (ıuid_»g *)
cmd_block
;

58 
	`ıuid_couÁ
(
cmd
->
—x
, cmd->
ecx
,

59 &
cmd
->
—x
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

60 
	}
}

62 
loff_t
 
	$ıuid_£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
Üig
)

64 
loff_t
 
»t
;

65 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

67 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

68 
Üig
) {

70 
fe
->
f_pos
 = 
off£t
;

71 
»t
 = 
fe
->
f_pos
;

74 
fe
->
f_pos
 +ğ
off£t
;

75 
»t
 = 
fe
->
f_pos
;

78 
»t
 = -
EINVAL
;

80 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

81  
»t
;

82 
	}
}

84 
ssize_t
 
	$ıuid_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

85 
size_t
 
couÁ
, 
loff_t
 *
µos
)

87 
__u£r
 *
tmp
 = 
buf
;

88 
ıuid_»gs
 
cmd
;

89 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

90 
u64
 
pos
 = *
µos
;

91 
ssize_t
 
by‹s
 = 0;

92 
”r
 = 0;

94 ià(
couÁ
 % 16)

95  -
EINVAL
;

97 ; 
couÁ
; count -= 16) {

98 
cmd
.
—x
 = 
pos
;

99 
cmd
.
ecx
 = 
pos
 >> 32;

100 
”r
 = 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
ıuid_smp_ıuid
, &
cmd
, 1);

101 ià(
”r
)

103 ià(
	`cİy_to_u£r
(
tmp
, &
cmd
, 16)) {

104 
”r
 = -
EFAULT
;

107 
tmp
 += 16;

108 
by‹s
 += 16;

109 *
µos
 = ++
pos
;

112  
by‹s
 ? by‹ : 
”r
;

113 
	}
}

115 
	$ıuid_İ’
(
šode
 *šode, 
fe
 *file)

117 
ıu
;

118 
ıušfo_x86
 *
c
;

119 
»t
 = 0;

121 
	`lock_k”Ãl
();

123 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

124 ià(
ıu
 >ğ
Ä_ıu_ids
 || !
	`ıu_Úlše
(cpu)) {

125 
»t
 = -
ENXIO
;

126 
out
;

128 
c
 = &
	`ıu_d©a
(
ıu
);

129 ià(
c
->
ıuid_Ëv–
 < 0)

130 
»t
 = -
EIO
;

131 
out
:

132 
	`uÆock_k”Ãl
();

133  
»t
;

134 
	}
}

139 cÚ¡ 
fe_İ”©iÚs
 
	gıuid_fİs
 = {

140 .
owÃr
 = 
THIS_MODULE
,

141 .
	gÎ£ek
 = 
ıuid_£ek
,

142 .
	g»ad
 = 
ıuid_»ad
,

143 .
	gİ’
 = 
ıuid_İ’
,

146 
__ıuš™
 
	$ıuid_deviû_ü—‹
(
ıu
)

148 
deviû
 *
dev
;

150 
dev
 = 
	`deviû_ü—‹
(
ıuid_şass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
ıu
), NULL,

151 "ıu%d", 
ıu
);

152  
	`IS_ERR
(
dev
è? 
	`PTR_ERR
(dev) : 0;

153 
	}
}

155 
	$ıuid_deviû_de¡roy
(
ıu
)

157 
	`deviû_de¡roy
(
ıuid_şass
, 
	`MKDEV
(
CPUID_MAJOR
, 
ıu
));

158 
	}
}

160 
__ıuš™
 
	$ıuid_şass_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

161 
aùiÚ
,

162 *
hıu
)

164 
ıu
 = ()
hıu
;

165 
”r
 = 0;

167 
aùiÚ
) {

168 
CPU_UP_PREPARE
:

169 
”r
 = 
	`ıuid_deviû_ü—‹
(
ıu
);

171 
CPU_UP_CANCELED
:

172 
CPU_UP_CANCELED_FROZEN
:

173 
CPU_DEAD
:

174 
	`ıuid_deviû_de¡roy
(
ıu
);

177  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

178 
	}
}

180 
nÙif›r_block
 
__»fd©a
 
	gıuid_şass_ıu_nÙif›r
 =

182 .
nÙif›r_ÿÎ
 = 
ıuid_şass_ıu_ÿÎback
,

185 
__š™
 
	$ıuid_š™
()

187 
i
, 
”r
 = 0;

188 
i
 = 0;

190 ià(
	`»gi¡”_chrdev
(
CPUID_MAJOR
, "ıu/ıuid", &
ıuid_fİs
)) {

191 
	`´štk
(
KERN_ERR
 "cpuid: unableo get major %d for cpuid\n",

192 
CPUID_MAJOR
);

193 
”r
 = -
EBUSY
;

194 
out
;

196 
ıuid_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "cpuid");

197 ià(
	`IS_ERR
(
ıuid_şass
)) {

198 
”r
 = 
	`PTR_ERR
(
ıuid_şass
);

199 
out_chrdev
;

201 
	`fÜ_—ch_Úlše_ıu
(
i
) {

202 
”r
 = 
	`ıuid_deviû_ü—‹
(
i
);

203 ià(
”r
 != 0)

204 
out_şass
;

206 
	`»gi¡”_hÙıu_nÙif›r
(&
ıuid_şass_ıu_nÙif›r
);

208 
”r
 = 0;

209 
out
;

211 
out_şass
:

212 
i
 = 0;

213 
	`fÜ_—ch_Úlše_ıu
(
i
) {

214 
	`ıuid_deviû_de¡roy
(
i
);

216 
	`şass_de¡roy
(
ıuid_şass
);

217 
out_chrdev
:

218 
	`uÄegi¡”_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

219 
out
:

220  
”r
;

221 
	}
}

223 
__ex™
 
	$ıuid_ex™
()

225 
ıu
 = 0;

227 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

228 
	`ıuid_deviû_de¡roy
(
ıu
);

229 
	`şass_de¡roy
(
ıuid_şass
);

230 
	`uÄegi¡”_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

231 
	`uÄegi¡”_hÙıu_nÙif›r
(&
ıuid_şass_ıu_nÙif›r
);

232 
	}
}

234 
moduË_š™
(
ıuid_š™
);

235 
moduË_ex™
(
ıuid_ex™
);

237 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

238 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

239 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<lšux/š™.h
>

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/smp.h
>

14 
	~<lšux/»boÙ.h
>

15 
	~<lšux/kexec.h
>

16 
	~<lšux/d–ay.h
>

17 
	~<lšux/–f.h
>

18 
	~<lšux/–fcÜe.h
>

20 
	~<asm/´oûssÜ.h
>

21 
	~<asm/h¬dœq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_œq.h
>

24 
	~<asm/­ic.h
>

25 
	~<asm/h³t.h
>

26 
	~<lšux/kdebug.h
>

27 
	~<asm/ıu.h
>

28 
	~<asm/»boÙ.h
>

29 
	~<asm/vœ‹xt.h
>

32 #ià
defšed
(
CONFIG_SMP
è&& defšed(
CONFIG_X86_LOCAL_APIC
)

34 
	$kdump_nmi_ÿÎback
(
ıu
, 
d›_¬gs
 *
¬gs
)

36 
±_»gs
 *
»gs
;

37 #ifdeà
CONFIG_X86_32


38 
±_»gs
 
fixed_»gs
;

41 
»gs
 = 
¬gs
->regs;

43 #ifdeà
CONFIG_X86_32


44 ià(!
	`u£r_mode_vm
(
»gs
)) {

45 
	`üash_fixup_ss_e¥
(&
fixed_»gs
, 
»gs
);

46 
»gs
 = &
fixed_»gs
;

49 
	`üash_§ve_ıu
(
»gs
, 
ıu
);

57 
	`ıu_em”g’cy_vmxoff
();

58 
	`ıu_em”g’cy_svm_di§bË
();

60 
	`di§bË_loÿl_APIC
();

61 
	}
}

63 
	$kdump_nmi_shoÙdown_ıus
()

65 
	`nmi_shoÙdown_ıus
(
kdump_nmi_ÿÎback
);

67 
	`di§bË_loÿl_APIC
();

68 
	}
}

71 
	$kdump_nmi_shoÙdown_ıus
()

74 
	}
}

77 
	$Çtive_machše_üash_shutdown
(
±_»gs
 *
»gs
)

88 
	`loÿl_œq_di§bË
();

90 
	`kdump_nmi_shoÙdown_ıus
();

96 
	`ıu_em”g’cy_vmxoff
();

97 
	`ıu_em”g’cy_svm_di§bË
();

99 
	`Ïpic_shutdown
();

100 #ià
	`defšed
(
CONFIG_X86_IO_APIC
)

101 
	`di§bË_IO_APIC
();

103 #ifdeà
CONFIG_HPET_TIMER


104 
	`h³t_di§bË
();

106 
	`üash_§ve_ıu
(
»gs
, 
	`§ã_smp_´oûssÜ_id
());

107 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/üash_dump.h
>

10 
	~<lšux/uacûss.h
>

11 
	~<lšux/io.h
>

14 
	g–fcÜehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$cİy_Şdmem_·ge
(
pâ
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 ià(!
csize
)

37 
vaddr
 = 
	`iÜem­
(
pâ
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 ià(!
vaddr
)

39  -
ENOMEM
;

41 ià(
u£rbuf
) {

42 ià(
	`cİy_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm­
(
vaddr
);

44  -
EFAULT
;

47 
	`memıy
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm­
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<lšux/k®lsyms.h
>

6 
	~<lšux/k´obes.h
>

7 
	~<lšux/uacûss.h
>

8 
	~<lšux/ut¢ame.h
>

9 
	~<lšux/h¬dœq.h
>

10 
	~<lšux/kdebug.h
>

11 
	~<lšux/moduË.h
>

12 
	~<lšux/±¿û.h
>

13 
	~<lšux/á¿û.h
>

14 
	~<lšux/kexec.h
>

15 
	~<lšux/bug.h
>

16 
	~<lšux/nmi.h
>

17 
	~<lšux/sysfs.h
>

18 
	~<lšux/á¿û.h
>

20 
	~<asm/¡ackŒaû.h
>

22 
	~"dump¡ack.h
"

24 
	g·nic_Ú_uÄecov”ed_nmi
;

25 
	gcode_by‹s
 = 64;

26 
	gk¡ack_d•th_to_´št
 = 3 * 
STACKSLOTS_PER_LINE
;

27 
	gd›_couÁ”
;

29 
	$´štk_add»ss
(
add»ss
, 
»lŸbË
)

31 
	`´štk
(" [<%p>] %s%pS\n", (*è
add»ss
,

32 
»lŸbË
 ? "" : "? ", (*è
add»ss
);

33 
	}
}

35 #ifdeà
CONFIG_FUNCTION_GRAPH_TRACER


37 
	$´št_á¿û_g¿ph_addr
(
addr
, *
d©a
,

38 cÚ¡ 
¡ackŒaû_İs
 *
İs
,

39 
th»ad_šfo
 *
tšfo
, *
g¿ph
)

41 
sk_¡ruù
 *
sk
 = 
tšfo
->task;

42 
»t_addr
;

43 
šdex
 = 
sk
->
cu¼_»t_¡ack
;

45 ià(
addr
 !ğ()
»tuº_to_hªdËr
)

48 ià(!
sk
->
»t_¡ack
 || 
šdex
 < *
g¿ph
)

51 
šdex
 -ğ*
g¿ph
;

52 
»t_addr
 = 
sk
->
»t_¡ack
[
šdex
].
»t
;

54 
İs
->
	`add»ss
(
d©a
, 
»t_addr
, 1);

56 (*
g¿ph
)++;

57 
	}
}

59 
šlše
 

60 
	$´št_á¿û_g¿ph_addr
(
addr
, *
d©a
,

61 cÚ¡ 
¡ackŒaû_İs
 *
İs
,

62 
th»ad_šfo
 *
tšfo
, *
g¿ph
)

63 { 
	}
}

73 
šlše
 
	$v®id_¡ack_±r
(
th»ad_šfo
 *
tšfo
,

74 *
p
, 
size
, *
’d
)

76 *
t
 = 
tšfo
;

77 ià(
’d
) {

78 ià(
p
 < 
’d
 &&… >ğÓnd-
THREAD_SIZE
))

83  
p
 > 
t
 &&… < + 
THREAD_SIZE
 - 
size
;

84 
	}
}

87 
	$´št_cÚ‹xt_¡ack
(
th»ad_šfo
 *
tšfo
,

88 *
¡ack
, 
bp
,

89 cÚ¡ 
¡ackŒaû_İs
 *
İs
, *
d©a
,

90 *
’d
, *
g¿ph
)

92 
¡ack_äame
 *
äame
 = (¡ack_äam*)
bp
;

94 
	`v®id_¡ack_±r
(
tšfo
, 
¡ack
, (*¡ack), 
’d
)) {

95 
addr
;

97 
addr
 = *
¡ack
;

98 ià(
	`__k”Ãl_‹xt_add»ss
(
addr
)) {

99 ià((è
¡ack
 =ğ
bp
 + ()) {

100 
İs
->
	`add»ss
(
d©a
, 
addr
, 1);

101 
äame
 = f¿me->
Ãxt_äame
;

102 
bp
 = (è
äame
;

104 
İs
->
	`add»ss
(
d©a
, 
addr
, 0);

106 
	`´št_á¿û_g¿ph_addr
(
addr
, 
d©a
, 
İs
, 
tšfo
, 
g¿ph
);

108 
¡ack
++;

110  
bp
;

111 
	}
}

115 
	$´št_Œaû_w¬nšg_symbŞ
(*
d©a
, *
msg
, 
symbŞ
)

117 
	`´štk
(
d©a
);

118 
	`´št_symbŞ
(
msg
, 
symbŞ
);

119 
	`´štk
("\n");

120 
	}
}

122 
	$´št_Œaû_w¬nšg
(*
d©a
, *
msg
)

124 
	`´štk
("%s%s\n", (*)
d©a
, 
msg
);

125 
	}
}

127 
	$´št_Œaû_¡ack
(*
d©a
, *
Çme
)

129 
	`´štk
("% <%s> ", (*)
d©a
, 
Çme
);

131 
	}
}

136 
	$´št_Œaû_add»ss
(*
d©a
, 
addr
, 
»lŸbË
)

138 
	`touch_nmi_w©chdog
();

139 
	`´štk
(
d©a
);

140 
	`´štk_add»ss
(
addr
, 
»lŸbË
);

141 
	}
}

143 cÚ¡ 
¡ackŒaû_İs
 
	g´št_Œaû_İs
 = {

144 .
w¬nšg
 = 
´št_Œaû_w¬nšg
,

145 .
	gw¬nšg_symbŞ
 = 
´št_Œaû_w¬nšg_symbŞ
,

146 .
	g¡ack
 = 
´št_Œaû_¡ack
,

147 .
	gadd»ss
 = 
´št_Œaû_add»ss
,

151 
	$show_Œaû_log_lvl
(
sk_¡ruù
 *
sk
, 
±_»gs
 *
»gs
,

152 *
¡ack
, 
bp
, *
log_lvl
)

154 
	`´štk
("%sC®ÈT¿û:\n", 
log_lvl
);

155 
	`dump_Œaû
(
sk
, 
»gs
, 
¡ack
, 
bp
, &
´št_Œaû_İs
, 
log_lvl
);

156 
	}
}

158 
	$show_Œaû
(
sk_¡ruù
 *
sk
, 
±_»gs
 *
»gs
,

159 *
¡ack
, 
bp
)

161 
	`show_Œaû_log_lvl
(
sk
, 
»gs
, 
¡ack
, 
bp
, "");

162 
	}
}

164 
	$show_¡ack
(
sk_¡ruù
 *
sk
, *
¥
)

166 
	`show_¡ack_log_lvl
(
sk
, 
NULL
, 
¥
, 0, "");

167 
	}
}

172 
	$dump_¡ack
()

174 
bp
 = 0;

175 
¡ack
;

177 #ifdeà
CONFIG_FRAME_POINTER


178 ià(!
bp
)

179 
	`g‘_bp
(
bp
);

182 
	`´štk
("Pid: %d, comm: %.20s %s %s %.*s\n",

183 
cu¼’t
->
pid
, cu¼’t->
comm
, 
	`´št_š‹d
(),

184 
	`š™_ut¢ame
()->
»Ëa£
,

185 ()
	`¡rc¥n
(
	`š™_ut¢ame
()->
v”siÚ
, " "),

186 
	`š™_ut¢ame
()->
v”siÚ
);

187 
	`show_Œaû
(
NULL
, NULL, &
¡ack
, 
bp
);

188 
	}
}

189 
EXPORT_SYMBOL
(
dump_¡ack
);

191 
¿w_¥šlock_t
 
	gd›_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

192 
	gd›_owÃr
 = -1;

193 
	gd›_Ã¡_couÁ
;

195 
__k´obes
 
	$oİs_begš
()

197 
ıu
;

198 
æags
;

203 
	`Œaû_hw_b¿nch_oİs
();

205 
	`oİs_’‹r
();

208 
	`¿w_loÿl_œq_§ve
(
æags
);

209 
ıu
 = 
	`smp_´oûssÜ_id
();

210 ià(!
	`__¿w_¥š_Œylock
(&
d›_lock
)) {

211 ià(
ıu
 =ğ
d›_owÃr
)

214 
	`__¿w_¥š_lock
(&
d›_lock
);

216 
d›_Ã¡_couÁ
++;

217 
d›_owÃr
 = 
ıu
;

218 
	`cÚsŞe_v”bo£
();

219 
	`bu¡_¥šlocks
(1);

220  
æags
;

221 
	}
}

223 
__k´obes
 
	$oİs_’d
(
æags
, 
±_»gs
 *
»gs
, 
sigÄ
)

225 ià(
»gs
 && 
	`kexec_should_üash
(
cu¼’t
))

226 
	`üash_kexec
(
»gs
);

228 
	`bu¡_¥šlocks
(0);

229 
d›_owÃr
 = -1;

230 
	`add_št
(
TAINT_DIE
);

231 
d›_Ã¡_couÁ
--;

232 ià(!
d›_Ã¡_couÁ
)

234 
	`__¿w_¥š_uÆock
(&
d›_lock
);

235 
	`¿w_loÿl_œq_»¡Üe
(
æags
);

236 
	`oİs_ex™
();

238 ià(!
sigÄ
)

240 ià(
	`š_š‹¼u±
())

241 
	`·nic
("Fatalƒxception in interrupt");

242 ià(
·nic_Ú_oİs
)

243 
	`·nic
("Fatalƒxception");

244 
	`do_ex™
(
sigÄ
);

245 
	}
}

247 
__k´obes
 
	$__d›
(cÚ¡ *
¡r
, 
±_»gs
 *
»gs
, 
”r
)

249 #ifdeà
CONFIG_X86_32


250 
ss
;

251 
¥
;

253 
	`´štk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
¡r
, 
”r
 & 0xffff, ++
d›_couÁ”
);

254 #ifdeà
CONFIG_PREEMPT


255 
	`´štk
("PREEMPT ");

257 #ifdeà
CONFIG_SMP


258 
	`´štk
("SMP ");

260 #ifdeà
CONFIG_DEBUG_PAGEALLOC


261 
	`´štk
("DEBUG_PAGEALLOC");

263 
	`´štk
("\n");

264 
	`sysfs_´štk_Ï¡_fe
();

265 ià(
	`nÙify_d›
(
DIE_OOPS
, 
¡r
, 
»gs
, 
”r
,

266 
cu¼’t
->
th»ad
.
Œ­_no
, 
SIGSEGV
è=ğ
NOTIFY_STOP
)

269 
	`show_»gi¡”s
(
»gs
);

270 #ifdeà
CONFIG_X86_32


271 
¥
 = (è(&
»gs
->sp);

272 
	`§ve£gm’t
(
ss
, ss);

273 ià(
	`u£r_mode
(
»gs
)) {

274 
¥
 = 
»gs
->sp;

275 
ss
 = 
»gs
->ss & 0xffff;

277 
	`´štk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
»gs
->

);

278 
	`´št_symbŞ
("%s", 
»gs
->

);

279 
	`´štk
(" SS:ESP %04x:%08lx\n", 
ss
, 
¥
);

282 
	`´štk
(
KERN_ALERT
 "RIP ");

283 
	`´štk_add»ss
(
»gs
->

, 1);

284 
	`´štk
(" RSP <%016lx>\n", 
»gs
->
¥
);

287 
	}
}

293 
	$d›
(cÚ¡ *
¡r
, 
±_»gs
 *
»gs
, 
”r
)

295 
æags
 = 
	`oİs_begš
();

296 
sig
 = 
SIGSEGV
;

298 ià(!
	`u£r_mode_vm
(
»gs
))

299 
	`»pÜt_bug
(
»gs
->

,„egs);

301 ià(
	`__d›
(
¡r
, 
»gs
, 
”r
))

302 
sig
 = 0;

303 
	`oİs_’d
(
æags
, 
»gs
, 
sig
);

304 
	}
}

306 
nÙ¿û
 
__k´obes


307 
	$d›_nmi
(*
¡r
, 
±_»gs
 *
»gs
, 
do_·nic
)

309 
æags
;

311 ià(
	`nÙify_d›
(
DIE_NMIWATCHDOG
, 
¡r
, 
»gs
, 0, 2, 
SIGINT
è=ğ
NOTIFY_STOP
)

318 
æags
 = 
	`oİs_begš
();

319 
	`´štk
(
KERN_EMERG
 "%s", 
¡r
);

320 
	`´štk
(" on CPU%d, ip %08lx,„egisters:\n",

321 
	`smp_´oûssÜ_id
(), 
»gs
->

);

322 
	`show_»gi¡”s
(
»gs
);

323 
	`oİs_’d
(
æags
, 
»gs
, 0);

324 ià(
do_·nic
 || 
·nic_Ú_oİs
)

325 
	`·nic
("Non maskable interrupt");

326 
	`nmi_ex™
();

327 
	`loÿl_œq_’abË
();

328 
	`do_ex™
(
SIGBUS
);

329 
	}
}

331 
__š™
 
	$oİs_£tup
(*
s
)

333 ià(!
s
)

334  -
EINVAL
;

335 ià(!
	`¡rcmp
(
s
, "panic"))

336 
·nic_Ú_oİs
 = 1;

338 
	}
}

339 
—¾y_·¿m
("oİs", 
oİs_£tup
);

341 
__š™
 
	$k¡ack_£tup
(*
s
)

343 ià(!
s
)

344  -
EINVAL
;

345 
k¡ack_d•th_to_´št
 = 
	`sim¶e_¡¹oul
(
s
, 
NULL
, 0);

347 
	}
}

348 
—¾y_·¿m
("k¡ack", 
k¡ack_£tup
);

350 
__š™
 
	$code_by‹s_£tup
(*
s
)

352 
code_by‹s
 = 
	`sim¶e_¡¹oul
(
s
, 
NULL
, 0);

353 ià(
code_by‹s
 > 8192)

354 
code_by‹s
 = 8192;

357 
	}
}

358 
__£tup
("code_by‹s=", 
code_by‹s_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<lšux/k®lsyms.h
>

6 
	~<lšux/k´obes.h
>

7 
	~<lšux/uacûss.h
>

8 
	~<lšux/ut¢ame.h
>

9 
	~<lšux/h¬dœq.h
>

10 
	~<lšux/kdebug.h
>

11 
	~<lšux/moduË.h
>

12 
	~<lšux/±¿û.h
>

13 
	~<lšux/kexec.h
>

14 
	~<lšux/bug.h
>

15 
	~<lšux/nmi.h
>

16 
	~<lšux/sysfs.h
>

18 
	~<asm/¡ackŒaû.h
>

20 
	~"dump¡ack.h
"

22 *
	$š_exû±iÚ_¡ack
(
ıu
, 
¡ack
,

23 *
u£dp
, **
idp
)

25 
ids
[][8] = {

26 [
DEBUG_STACK
 - 1] = "#DB",

27 [
NMI_STACK
 - 1] = "NMI",

28 [
DOUBLEFAULT_STACK
 - 1] = "#DF",

29 [
STACKFAULT_STACK
 - 1] = "#SS",

30 [
MCE_STACK
 - 1] = "#MC",

31 #ià
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


32 [
N_EXCEPTION_STACKS
 ...

33 
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
 / 
EXCEPTION_STKSZ
 - 2] = "#DB[?]"

36 
k
;

42 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

43 
’d
 = 
	`³r_ıu
(
Üig_i¡
, 
ıu
).
i¡
[
k
];

48 ià(
¡ack
 >ğ
’d
)

54 ià(
¡ack
 >ğ
’d
 - 
EXCEPTION_STKSZ
) {

61 ià(*
u£dp
 & (1U << 
k
))

63 *
u£dp
 |ğ1U << 
k
;

64 *
idp
 = 
ids
[
k
];

65  (*)
’d
;

72 #ià
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


73 ià(
k
 =ğ
DEBUG_STACK
 - 1 && 
¡ack
 >ğ
’d
 - 
DEBUG_STKSZ
) {

74 
j
 = 
N_EXCEPTION_STACKS
 - 1;

82 ++
j
;

83 
’d
 -ğ
EXCEPTION_STKSZ
;

84 
ids
[
j
][4] = '1' + (j - 
N_EXCEPTION_STACKS
);

85 } 
¡ack
 < 
’d
 - 
EXCEPTION_STKSZ
);

86 ià(*
u£dp
 & (1U << 
j
))

88 *
u£dp
 |ğ1U << 
j
;

89 *
idp
 = 
ids
[
j
];

90  (*)
’d
;

94  
NULL
;

95 
	}
}

104 
	$dump_Œaû
(
sk_¡ruù
 *
sk
, 
±_»gs
 *
»gs
,

105 *
¡ack
, 
bp
,

106 cÚ¡ 
¡ackŒaû_İs
 *
İs
, *
d©a
)

108 cÚ¡ 
ıu
 = 
	`g‘_ıu
();

109 *
œq_¡ack_’d
 =

110 (*)
	`³r_ıu
(
œq_¡ack_±r
, 
ıu
);

111 
u£d
 = 0;

112 
th»ad_šfo
 *
tšfo
;

113 
g¿ph
 = 0;

115 ià(!
sk
)

116 
sk
 = 
cu¼’t
;

118 ià(!
¡ack
) {

119 
dummy
;

120 
¡ack
 = &
dummy
;

121 ià(
sk
 &&ask !ğ
cu¼’t
)

122 
¡ack
 = (*)
sk
->
th»ad
.
¥
;

125 #ifdeà
CONFIG_FRAME_POINTER


126 ià(!
bp
) {

127 ià(
sk
 =ğ
cu¼’t
) {

129 
	`g‘_bp
(
bp
);

132 
bp
 = *(*è
sk
->
th»ad
.
¥
;

142 
tšfo
 = 
	`sk_th»ad_šfo
(
sk
);

144 *
id
;

145 *
e¡ack_’d
;

146 
e¡ack_’d
 = 
	`š_exû±iÚ_¡ack
(
ıu
, ()
¡ack
,

147 &
u£d
, &
id
);

149 ià(
e¡ack_’d
) {

150 ià(
İs
->
	`¡ack
(
d©a
, 
id
) < 0)

153 
bp
 = 
	`´št_cÚ‹xt_¡ack
(
tšfo
, 
¡ack
, bp, 
İs
,

154 
d©a
, 
e¡ack_’d
, &
g¿ph
);

155 
İs
->
	`¡ack
(
d©a
, "<EOE>");

161 
¡ack
 = (*è
e¡ack_’d
[-2];

164 ià(
œq_¡ack_’d
) {

165 *
œq_¡ack
;

166 
œq_¡ack
 = 
œq_¡ack_’d
 -

167 (
IRQ_STACK_SIZE
 - 64è/ (*
œq_¡ack
);

169 ià(
¡ack
 >ğ
œq_¡ack
 && sck < 
œq_¡ack_’d
) {

170 ià(
İs
->
	`¡ack
(
d©a
, "IRQ") < 0)

172 
bp
 = 
	`´št_cÚ‹xt_¡ack
(
tšfo
, 
¡ack
, bp,

173 
İs
, 
d©a
, 
œq_¡ack_’d
, &
g¿ph
);

179 
¡ack
 = (*è(
œq_¡ack_’d
[-1]);

180 
œq_¡ack_’d
 = 
NULL
;

181 
İs
->
	`¡ack
(
d©a
, "EOI");

191 
bp
 = 
	`´št_cÚ‹xt_¡ack
(
tšfo
, 
¡ack
, bp, 
İs
, 
d©a
, 
NULL
, &
g¿ph
);

192 
	`put_ıu
();

193 
	}
}

194 
EXPORT_SYMBOL
(
dump_Œaû
);

197 
	$show_¡ack_log_lvl
(
sk_¡ruù
 *
sk
, 
±_»gs
 *
»gs
,

198 *
¥
, 
bp
, *
log_lvl
)

200 *
¡ack
;

201 
i
;

202 cÚ¡ 
ıu
 = 
	`smp_´oûssÜ_id
();

203 *
œq_¡ack_’d
 =

204 (*)(
	`³r_ıu
(
œq_¡ack_±r
, 
ıu
));

205 *
œq_¡ack
 =

206 (*)(
	`³r_ıu
(
œq_¡ack_±r
, 
ıu
è- 
IRQ_STACK_SIZE
);

213 ià(
¥
 =ğ
NULL
) {

214 ià(
sk
)

215 
¥
 = (*)
sk
->
th»ad
.sp;

217 
¥
 = (*)&sp;

220 
¡ack
 = 
¥
;

221 
i
 = 0; i < 
k¡ack_d•th_to_´št
; i++) {

222 ià(
¡ack
 >ğ
œq_¡ack
 && sck <ğ
œq_¡ack_’d
) {

223 ià(
¡ack
 =ğ
œq_¡ack_’d
) {

224 
¡ack
 = (*è(
œq_¡ack_’d
[-1]);

225 
	`´štk
(" <EOI> ");

228 ià(((è
¡ack
 & (
THREAD_SIZE
-1)) == 0)

231 ià(
i
 && ((˜% 
STACKSLOTS_PER_LINE
) == 0))

232 
	`´štk
("\n%s", 
log_lvl
);

233 
	`´štk
(" %016lx", *
¡ack
++);

234 
	`touch_nmi_w©chdog
();

236 
	`´štk
("\n");

237 
	`show_Œaû_log_lvl
(
sk
, 
»gs
, 
¥
, 
bp
, 
log_lvl
);

238 
	}
}

240 
	$show_»gi¡”s
(
±_»gs
 *
»gs
)

242 
i
;

243 
¥
;

244 cÚ¡ 
ıu
 = 
	`smp_´oûssÜ_id
();

245 
sk_¡ruù
 *
cur
 = 
cu¼’t
;

247 
¥
 = 
»gs
->sp;

248 
	`´štk
("CPU %d ", 
ıu
);

249 
	`__show_»gs
(
»gs
, 1);

250 
	`´štk
("Process %s (pid: %d,hreadinfo %p,ask %p)\n",

251 
cur
->
comm
, cur->
pid
, 
	`sk_th»ad_šfo
(cur), cur);

257 ià(!
	`u£r_mode
(
»gs
)) {

258 
code_´Şogue
 = 
code_by‹s
 * 43 / 64;

259 
code_Ën
 = 
code_by‹s
;

260 
c
;

261 
u8
 *

;

263 
	`´štk
(
KERN_EMERG
 "Stack:\n");

264 
	`show_¡ack_log_lvl
(
NULL
, 
»gs
, (*)
¥
,

265 
»gs
->
bp
, 
KERN_EMERG
);

267 
	`´štk
(
KERN_EMERG
 "Code: ");

269 

 = (
u8
 *)
»gs
-> - 
code_´Şogue
;

270 ià(

 < (
u8
 *)
PAGE_OFFSET
 || 
	`´obe_k”Ãl_add»ss
(, 
c
)) {

272 

 = (
u8
 *)
»gs
->ip;

273 
code_Ën
 = code_ËÀ- 
code_´Şogue
 + 1;

275 
i
 = 0; i < 
code_Ën
; i++, 

++) {

276 ià(

 < (
u8
 *)
PAGE_OFFSET
 ||

277 
	`´obe_k”Ãl_add»ss
(

, 
c
)) {

278 
	`´štk
(" Bad RIP value.");

281 ià(

 =ğ(
u8
 *)
»gs
->ip)

282 
	`´štk
("<%02x> ", 
c
);

284 
	`´štk
("%02x ", 
c
);

287 
	`´štk
("\n");

288 
	}
}

290 
	$is_v®id_bugaddr
(

)

292 
ud2
;

294 ià(
	`__cİy_äom_u£r
(&
ud2
, (cÚ¡ 
__u£r
 *è

, (ud2)))

297  
ud2
 == 0x0b0f;

298 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/š™.h
>

14 
	~<lšux/boÙmem.h
>

15 
	~<lšux/iİÜt.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/kexec.h
>

18 
	~<lšux/moduË.h
>

19 
	~<lšux/mm.h
>

20 
	~<lšux/pâ.h
>

21 
	~<lšux/su¥’d.h
>

22 
	~<lšux/fœmw¬e-m­.h
>

24 
	~<asm/pgbË.h
>

25 
	~<asm/·ge.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/´Ùo.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/ŒampŞše.h
>

45 
e820m­
 
	ge820
;

46 
e820m­
 
	ge820_§ved
;

49 
	gpci_mem_¡¬t
 = 0xaeedbabe;

50 #ifdeà
CONFIG_PCI


51 
EXPORT_SYMBOL
(
pci_mem_¡¬t
);

59 
	$e820_ªy_m­³d
(
u64
 
¡¬t
, u64 
’d
, 
ty³
)

61 
i
;

63 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

64 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

66 ià(
ty³
 && 
ei
->type !=ype)

68 ià(
ei
->
addr
 >ğ
’d
 ||ƒi->add¸+ƒi->
size
 <ğ
¡¬t
)

73 
	}
}

74 
EXPORT_SYMBOL_GPL
(
e820_ªy_m­³d
);

82 
__š™
 
	$e820_®l_m­³d
(
u64
 
¡¬t
, u64 
’d
, 
ty³
)

84 
i
;

86 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

87 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

89 ià(
ty³
 && 
ei
->type !=ype)

92 ià(
ei
->
addr
 >ğ
’d
 ||ƒi->add¸+ƒi->
size
 <ğ
¡¬t
)

98 ià(
ei
->
addr
 <ğ
¡¬t
)

99 
¡¬t
 = 
ei
->
addr
 +ƒi->
size
;

104 ià(
¡¬t
 >ğ
’d
)

108 
	}
}

113 
__š™
 
	$__e820_add_»giÚ
(
e820m­
 *
e820x
, 
u64
 
¡¬t
, u64 
size
,

114 
ty³
)

116 
x
 = 
e820x
->
Ä_m­
;

118 ià(
x
 =ğ
	`ARRAY_SIZE
(
e820x
->
m­
)) {

119 
	`´štk
(
KERN_ERR
 "Ooops! Too manyƒntries inhe memory map!\n");

123 
e820x
->
m­
[
x
].
addr
 = 
¡¬t
;

124 
e820x
->
m­
[
x
].
size
 = size;

125 
e820x
->
m­
[
x
].
ty³
 =ype;

126 
e820x
->
Ä_m­
++;

127 
	}
}

129 
__š™
 
	$e820_add_»giÚ
(
u64
 
¡¬t
, u64 
size
, 
ty³
)

131 
	`__e820_add_»giÚ
(&
e820
, 
¡¬t
, 
size
, 
ty³
);

132 
	}
}

134 
__š™
 
	$e820_´št_ty³
(
u32
 
ty³
)

136 
ty³
) {

137 
E820_RAM
:

138 
E820_RESERVED_KERN
:

139 
	`´štk
(
KERN_CONT
 "(usable)");

141 
E820_RESERVED
:

142 
	`´štk
(
KERN_CONT
 "(reserved)");

144 
E820_ACPI
:

145 
	`´štk
(
KERN_CONT
 "(ACPI data)");

147 
E820_NVS
:

148 
	`´štk
(
KERN_CONT
 "(ACPI NVS)");

150 
E820_UNUSABLE
:

151 
	`´štk
(
KERN_CONT
 "(unusable)");

154 
	`´štk
(
KERN_CONT
 "ty³ %u", 
ty³
);

157 
	}
}

159 
__š™
 
	$e820_´št_m­
(*
who
)

161 
i
;

163 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

164 
	`´štk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

165 (è
e820
.
m­
[
i
].
addr
,

167 (
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
));

168 
	`e820_´št_ty³
(
e820
.
m­
[
i
].
ty³
);

169 
	`´štk
(
KERN_CONT
 "\n");

171 
	}
}

235 
__š™
 
	$§n™ize_e820_m­
(
e820’Œy
 *
biosm­
, 
max_Ä_m­
,

236 
u32
 *
²r_m­
)

238 
	schªge_memb”
 {

239 
e820’Œy
 *
pbios
;

240 
addr
;

242 
chªge_memb”
 
chªge_pošt_li¡
[2*
E820_X_MAX
] 
__š™d©a
;

243 
chªge_memb”
 *
chªge_pošt
[2*
E820_X_MAX
] 
__š™d©a
;

244 
e820’Œy
 *
ov”Ïp_li¡
[
E820_X_MAX
] 
__š™d©a
;

245 
e820’Œy
 
Ãw_bios
[
E820_X_MAX
] 
__š™d©a
;

246 
chªge_memb”
 *
chªge_tmp
;

247 
cu¼’t_ty³
, 
Ï¡_ty³
;

248 
Ï¡_addr
;

249 
chgidx
, 
¡l_chªgšg
;

250 
ov”Ïp_’Œ›s
;

251 
Ãw_bios_’Œy
;

252 
Şd_Ä
, 
Ãw_Ä
, 
chg_Ä
;

253 
i
;

256 ià(*
²r_m­
 < 2)

259 
Şd_Ä
 = *
²r_m­
;

260 
	`BUG_ON
(
Şd_Ä
 > 
max_Ä_m­
);

263 
i
 = 0; i < 
Şd_Ä
; i++)

264 ià(
biosm­
[
i
].
addr
 + biosm­[i].
size
 < biosmap[i].addr)

268 
i
 = 0; i < 2 * 
Şd_Ä
; i++)

269 
chªge_pošt
[
i
] = &
chªge_pošt_li¡
[i];

273 
chgidx
 = 0;

274 
i
 = 0; i < 
Şd_Ä
; i++) {

275 ià(
biosm­
[
i
].
size
 != 0) {

276 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].addr;

277 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

278 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].addr +

279 
biosm­
[
i
].
size
;

280 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

283 
chg_Ä
 = 
chgidx
;

286 
¡l_chªgšg
 = 1;

287 
¡l_chªgšg
) {

288 
¡l_chªgšg
 = 0;

289 
i
 = 1; i < 
chg_Ä
; i++) {

290 
cu¿ddr
, 
Ï¡addr
;

291 
cu½baddr
, 
Ï¡pbaddr
;

293 
cu¿ddr
 = 
chªge_pošt
[
i
]->
addr
;

294 
Ï¡addr
 = 
chªge_pošt
[
i
 - 1]->
addr
;

295 
cu½baddr
 = 
chªge_pošt
[
i
]->
pbios
->
addr
;

296 
Ï¡pbaddr
 = 
chªge_pošt
[
i
 - 1]->
pbios
->
addr
;

305 ià(
cu¿ddr
 < 
Ï¡addr
 ||

306 (
cu¿ddr
 =ğ
Ï¡addr
 && cu¿dd¸=ğ
cu½baddr
 &&

307 
Ï¡addr
 !ğ
Ï¡pbaddr
)) {

308 
chªge_tmp
 = 
chªge_pošt
[
i
];

309 
chªge_pošt
[
i
] = change_point[i-1];

310 
chªge_pošt
[
i
-1] = 
chªge_tmp
;

311 
¡l_chªgšg
 = 1;

317 
ov”Ïp_’Œ›s
 = 0;

318 
Ãw_bios_’Œy
 = 0;

319 
Ï¡_ty³
 = 0;

320 
Ï¡_addr
 = 0;

323 
chgidx
 = 0; chgidx < 
chg_Ä
; chgidx++) {

325 ià(
chªge_pošt
[
chgidx
]->
addr
 ==

326 
chªge_pošt
[
chgidx
]->
pbios
->
addr
) {

331 
ov”Ïp_li¡
[
ov”Ïp_’Œ›s
++] =

332 
chªge_pošt
[
chgidx
]->
pbios
;

338 
i
 = 0; i < 
ov”Ïp_’Œ›s
; i++) {

339 ià(
ov”Ïp_li¡
[
i
] ==

340 
chªge_pošt
[
chgidx
]->
pbios
)

341 
ov”Ïp_li¡
[
i
] =

342 
ov”Ïp_li¡
[
ov”Ïp_’Œ›s
-1];

344 
ov”Ïp_’Œ›s
--;

351 
cu¼’t_ty³
 = 0;

352 
i
 = 0; i < 
ov”Ïp_’Œ›s
; i++)

353 ià(
ov”Ïp_li¡
[
i
]->
ty³
 > 
cu¼’t_ty³
)

354 
cu¼’t_ty³
 = 
ov”Ïp_li¡
[
i
]->
ty³
;

359 ià(
cu¼’t_ty³
 !ğ
Ï¡_ty³
) {

360 ià(
Ï¡_ty³
 != 0) {

361 
Ãw_bios
[
Ãw_bios_’Œy
].
size
 =

362 
chªge_pošt
[
chgidx
]->
addr
 - 
Ï¡_addr
;

367 ià(
Ãw_bios
[
Ãw_bios_’Œy
].
size
 != 0)

372 ià(++
Ãw_bios_’Œy
 >ğ
max_Ä_m­
)

375 ià(
cu¼’t_ty³
 != 0) {

376 
Ãw_bios
[
Ãw_bios_’Œy
].
addr
 =

377 
chªge_pošt
[
chgidx
]->
addr
;

378 
Ãw_bios
[
Ãw_bios_’Œy
].
ty³
 = 
cu¼’t_ty³
;

379 
Ï¡_addr
 = 
chªge_pošt
[
chgidx
]->
addr
;

381 
Ï¡_ty³
 = 
cu¼’t_ty³
;

385 
Ãw_Ä
 = 
Ãw_bios_’Œy
;

388 
	`memıy
(
biosm­
, 
Ãw_bios
, 
Ãw_Ä
 * (
e820’Œy
));

389 *
²r_m­
 = 
Ãw_Ä
;

392 
	}
}

394 
__š™
 
	$__­³nd_e820_m­
(
e820’Œy
 *
biosm­
, 
Ä_m­
)

396 
Ä_m­
) {

397 
u64
 
¡¬t
 = 
biosm­
->
addr
;

398 
u64
 
size
 = 
biosm­
->size;

399 
u64
 
’d
 = 
¡¬t
 + 
size
;

400 
u32
 
ty³
 = 
biosm­
->type;

403 ià(
¡¬t
 > 
’d
)

406 
	`e820_add_»giÚ
(
¡¬t
, 
size
, 
ty³
);

408 
biosm­
++;

409 
Ä_m­
--;

412 
	}
}

423 
__š™
 
	$­³nd_e820_m­
(
e820’Œy
 *
biosm­
, 
Ä_m­
)

426 ià(
Ä_m­
 < 2)

429  
	`__­³nd_e820_m­
(
biosm­
, 
Ä_m­
);

430 
	}
}

432 
u64
 
__š™
 
	$__e820_upd©e_¿nge
(
e820m­
 *
e820x
, 
u64
 
¡¬t
,

433 
u64
 
size
, 
Şd_ty³
,

434 
Ãw_ty³
)

436 
u64
 
’d
;

437 
i
;

438 
u64
 
»®_upd©ed_size
 = 0;

440 
	`BUG_ON
(
Şd_ty³
 =ğ
Ãw_ty³
);

442 ià(
size
 > (
ULLONG_MAX
 - 
¡¬t
))

443 
size
 = 
ULLONG_MAX
 - 
¡¬t
;

445 
’d
 = 
¡¬t
 + 
size
;

446 
	`´štk
(
KERN_DEBUG
 "e820 update„ange: %016Lx - %016Lx ",

447 (è
¡¬t
,

448 (è
’d
);

449 
	`e820_´št_ty³
(
Şd_ty³
);

450 
	`´štk
(
KERN_CONT
 " ==> ");

451 
	`e820_´št_ty³
(
Ãw_ty³
);

452 
	`´štk
(
KERN_CONT
 "\n");

454 
i
 = 0; i < 
e820x
->
Ä_m­
; i++) {

455 
e820’Œy
 *
ei
 = &
e820x
->
m­
[
i
];

456 
u64
 
fš®_¡¬t
, 
fš®_’d
;

457 
u64
 
ei_’d
;

459 ià(
ei
->
ty³
 !ğ
Şd_ty³
)

462 
ei_’d
 = 
ei
->
addr
 +ƒi->
size
;

464 ià(
ei
->
addr
 >ğ
¡¬t
 && 
ei_’d
 <ğ
’d
) {

465 
ei
->
ty³
 = 
Ãw_ty³
;

466 
»®_upd©ed_size
 +ğ
ei
->
size
;

471 ià(
ei
->
addr
 < 
¡¬t
 && 
ei_’d
 > 
’d
) {

472 
	`__e820_add_»giÚ
(
e820x
, 
¡¬t
, 
size
, 
Ãw_ty³
);

473 
	`__e820_add_»giÚ
(
e820x
, 
’d
, 
ei_’d
 -ƒnd, 
ei
->
ty³
);

474 
ei
->
size
 = 
¡¬t
 -ƒi->
addr
;

475 
»®_upd©ed_size
 +ğ
size
;

480 
fš®_¡¬t
 = 
	`max
(
¡¬t
, 
ei
->
addr
);

481 
fš®_’d
 = 
	`mš
(
’d
, 
ei_’d
);

482 ià(
fš®_¡¬t
 >ğ
fš®_’d
)

485 
	`__e820_add_»giÚ
(
e820x
, 
fš®_¡¬t
, 
fš®_’d
 - final_start,

486 
Ãw_ty³
);

488 
»®_upd©ed_size
 +ğ
fš®_’d
 - 
fš®_¡¬t
;

494 
ei
->
size
 -ğ
fš®_’d
 - 
fš®_¡¬t
;

495 ià(
ei
->
addr
 < 
fš®_¡¬t
)

497 
ei
->
addr
 = 
fš®_’d
;

499  
»®_upd©ed_size
;

500 
	}
}

502 
u64
 
__š™
 
	$e820_upd©e_¿nge
(
u64
 
¡¬t
, u64 
size
, 
Şd_ty³
,

503 
Ãw_ty³
)

505  
	`__e820_upd©e_¿nge
(&
e820
, 
¡¬t
, 
size
, 
Şd_ty³
, 
Ãw_ty³
);

506 
	}
}

508 
u64
 
__š™
 
	$e820_upd©e_¿nge_§ved
(
u64
 
¡¬t
, u64 
size
,

509 
Şd_ty³
, 
Ãw_ty³
)

511  
	`__e820_upd©e_¿nge
(&
e820_§ved
, 
¡¬t
, 
size
, 
Şd_ty³
,

512 
Ãw_ty³
);

513 
	}
}

516 
u64
 
__š™
 
	$e820_»move_¿nge
(
u64
 
¡¬t
, u64 
size
, 
Şd_ty³
,

517 
checkty³
)

519 
i
;

520 
u64
 
»®_»moved_size
 = 0;

522 ià(
size
 > (
ULLONG_MAX
 - 
¡¬t
))

523 
size
 = 
ULLONG_MAX
 - 
¡¬t
;

525 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

526 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

527 
u64
 
fš®_¡¬t
, 
fš®_’d
;

529 ià(
checkty³
 && 
ei
->
ty³
 !ğ
Şd_ty³
)

532 ià(
ei
->
addr
 >ğ
¡¬t
 &&

533 (
ei
->
addr
 +ƒi->
size
è<ğ(
¡¬t
 + size)) {

534 
»®_»moved_size
 +ğ
ei
->
size
;

535 
	`mem£t
(
ei
, 0, (
e820’Œy
));

539 
fš®_¡¬t
 = 
	`max
(
¡¬t
, 
ei
->
addr
);

540 
fš®_’d
 = 
	`mš
(
¡¬t
 + 
size
, 
ei
->
addr
 +ƒi->size);

541 ià(
fš®_¡¬t
 >ğ
fš®_’d
)

543 
»®_»moved_size
 +ğ
fš®_’d
 - 
fš®_¡¬t
;

545 
ei
->
size
 -ğ
fš®_’d
 - 
fš®_¡¬t
;

546 ià(
ei
->
addr
 < 
fš®_¡¬t
)

548 
ei
->
addr
 = 
fš®_’d
;

550  
»®_»moved_size
;

551 
	}
}

553 
__š™
 
	$upd©e_e820
()

555 
u32
 
Ä_m­
;

557 
Ä_m­
 = 
e820
.nr_map;

558 ià(
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &
Ä_m­
))

560 
e820
.
Ä_m­
 =‚r_map;

561 
	`´štk
(
KERN_INFO
 "modified…hysical RAM map:\n");

562 
	`e820_´št_m­
("modified");

563 
	}
}

564 
__š™
 
	$upd©e_e820_§ved
()

566 
u32
 
Ä_m­
;

568 
Ä_m­
 = 
e820_§ved
.nr_map;

569 ià(
	`§n™ize_e820_m­
(
e820_§ved
.
m­
, 
	`ARRAY_SIZE
Ó820_§ved.m­), &
Ä_m­
))

571 
e820_§ved
.
Ä_m­
 =‚r_map;

572 
	}
}

573 
	#MAX_GAP_END
 0x100000000uÎ

	)

577 
__š™
 
	$e820_£¬ch_g­
(*
g­¡¬t
, *
g­size
,

578 
¡¬t_addr
, 
’d_addr
)

580 
Ï¡
;

581 
i
 = 
e820
.
Ä_m­
;

582 
found
 = 0;

584 
Ï¡
 = (
’d_addr
 &&ƒnd_add¸< 
MAX_GAP_END
) ?ƒnd_addr : MAX_GAP_END;

586 --
i
 >= 0) {

587 
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

588 
’d
 = 
¡¬t
 + 
e820
.
m­
[
i
].
size
;

590 ià(
’d
 < 
¡¬t_addr
)

597 ià(
Ï¡
 > 
’d
) {

598 
g­
 = 
Ï¡
 - 
’d
;

600 ià(
g­
 >ğ*
g­size
) {

601 *
g­size
 = 
g­
;

602 *
g­¡¬t
 = 
’d
;

603 
found
 = 1;

606 ià(
¡¬t
 < 
Ï¡
)

607 
Ï¡
 = 
¡¬t
;

609  
found
;

610 
	}
}

618 
__š™
 
	$e820_£tup_g­
()

620 
g­¡¬t
, 
g­size
, 
round
;

621 
found
;

623 
g­¡¬t
 = 0x10000000;

624 
g­size
 = 0x400000;

625 
found
 = 
	`e820_£¬ch_g­
(&
g­¡¬t
, &
g­size
, 0, 
MAX_GAP_END
);

627 #ifdeà
CONFIG_X86_64


628 ià(!
found
) {

629 
g­¡¬t
 = (
max_pâ
 << 
PAGE_SHIFT
) + 1024*1024;

630 
	`´štk
(
KERN_ERR
 "PCI: Warning: Cannot find‡ gap inhe 32bit "

632 
KERN_ERR
 "PCI: Unassigned devices with 32bit„esource "

641 
round
 = 0x100000;

642 (
g­size
 >> 4è> 
round
)

643 
round
 +=„ound;

645 
pci_mem_¡¬t
 = (
g­¡¬t
 + 
round
) & -round;

647 
	`´štk
(
KERN_INFO


649 
pci_mem_¡¬t
, 
g­¡¬t
, 
g­size
);

650 
	}
}

658 
__š™
 
	$·r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
·_d©a
)

660 
u32
 
m­_Ën
;

661 
’Œ›s
;

662 
e820’Œy
 *
extm­
;

664 
’Œ›s
 = 
sd©a
->
Ën
 / (
e820’Œy
);

665 
m­_Ën
 = 
sd©a
->
Ën
 + (
£tup_d©a
);

666 ià(
m­_Ën
 > 
PAGE_SIZE
)

667 
sd©a
 = 
	`—¾y_iÜem­
(
·_d©a
, 
m­_Ën
);

668 
extm­
 = (
e820’Œy
 *)(
sd©a
->
d©a
);

669 
	`__­³nd_e820_m­
(
extm­
, 
’Œ›s
);

670 
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &e820.
Ä_m­
);

671 ià(
m­_Ën
 > 
PAGE_SIZE
)

672 
	`—¾y_iounm­
(
sd©a
, 
m­_Ën
);

673 
	`´štk
(
KERN_INFO
 "extended…hysical RAM map:\n");

674 
	`e820_´št_m­
("extended");

675 
	}
}

677 #ià
defšed
(
CONFIG_X86_64
) || \

678 (
defšed
(
CONFIG_X86_32
è&& 
	$defšed
(
CONFIG_HIBERNATION
))

687 
__š™
 
	$e820_m¬k_no§ve_»giÚs
(
lim™_pâ
)

689 
i
;

690 
pâ
;

692 
pâ
 = 
	`PFN_DOWN
(
e820
.
m­
[0].
addr
 +ƒ820.m­[0].
size
);

693 
i
 = 1; i < 
e820
.
Ä_m­
; i++) {

694 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

696 ià(
pâ
 < 
	`PFN_UP
(
ei
->
addr
))

697 
	`»gi¡”_no§ve_»giÚ
(
pâ
, 
	`PFN_UP
(
ei
->
addr
));

699 
pâ
 = 
	`PFN_DOWN
(
ei
->
addr
 +ƒi->
size
);

700 ià(
ei
->
ty³
 !ğ
E820_RAM
 &&ƒi->ty³ !ğ
E820_RESERVED_KERN
)

701 
	`»gi¡”_no§ve_»giÚ
(
	`PFN_UP
(
ei
->
addr
), 
pâ
);

703 ià(
pâ
 >ğ
lim™_pâ
)

706 
	}
}

709 #ifdeà
CONFIG_HIBERNATION


714 
__š™
 
	$e820_m¬k_nvs_memÜy
()

716 
i
;

718 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

719 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

721 ià(
ei
->
ty³
 =ğ
E820_NVS
)

722 
	`hib”Ç‹_nvs_»gi¡”
(
ei
->
addr
,ƒi->
size
);

726 
	}
}

727 
cÜe_š™ÿÎ
(
e820_m¬k_nvs_memÜy
);

733 
	#MAX_EARLY_RES
 20

	)

735 
	s—¾y_»s
 {

736 
u64
 
	m¡¬t
, 
	m’d
;

737 
	mÇme
[16];

738 
	mov”Ïp_ok
;

740 
—¾y_»s
 
	g—¾y_»s
[
MAX_EARLY_RES
] 
	g__š™d©a
 = {

741 { 0, 
PAGE_SIZE
, "BIOS data…age" },

745 
__š™
 
	$fšd_ov”Ïµed_—¾y
(
u64
 
¡¬t
, u64 
’d
)

747 
i
;

748 
—¾y_»s
 *
r
;

750 
i
 = 0; i < 
MAX_EARLY_RES
 && 
—¾y_»s
[i].
’d
; i++) {

751 
r
 = &
—¾y_»s
[
i
];

752 ià(
’d
 > 
r
->
¡¬t
 && start <„->end)

756  
i
;

757 
	}
}

764 
__š™
 
	$drİ_¿nge
(
i
)

766 
j
;

768 
j
 = 
i
 + 1; j < 
MAX_EARLY_RES
 && 
—¾y_»s
[j].
’d
; j++)

771 
	`memmove
(&
—¾y_»s
[
i
], &early_res[i + 1],

772 (
j
 - 1 - 
i
è* (
—¾y_»s
));

774 
—¾y_»s
[
j
 - 1].
’d
 = 0;

775 
	}
}

787 
__š™
 
	$drİ_ov”Ïps_th©_¬e_ok
(
u64
 
¡¬t
, u64 
’d
)

789 
i
;

790 
—¾y_»s
 *
r
;

791 
u64
 
low”_¡¬t
, 
low”_’d
;

792 
u64
 
uµ”_¡¬t
, 
uµ”_’d
;

793 
Çme
[16];

795 
i
 = 0; i < 
MAX_EARLY_RES
 && 
—¾y_»s
[i].
’d
; i++) {

796 
r
 = &
—¾y_»s
[
i
];

799 ià(
’d
 <ğ
r
->
¡¬t
 || start >=„->end)

807 ià(!
r
->
ov”Ïp_ok
)

818 
	`¡ºıy
(
Çme
, 
r
->name, (name) - 1);

820 
low”_¡¬t
 = 
low”_’d
 = 0;

821 
uµ”_¡¬t
 = 
uµ”_’d
 = 0;

822 ià(
r
->
¡¬t
 < start) {

823 
low”_¡¬t
 = 
r
->
¡¬t
;

824 
low”_’d
 = 
¡¬t
;

826 ià(
r
->
’d
 >ƒnd) {

827 
uµ”_¡¬t
 = 
’d
;

828 
uµ”_’d
 = 
r
->
’d
;

832 
	`drİ_¿nge
(
i
);

834 
i
--;

837 ià(
low”_’d
)

838 
	`»£rve_—¾y_ov”Ïp_ok
(
low”_¡¬t
, 
low”_’d
, 
Çme
);

839 ià(
uµ”_’d
)

840 
	`»£rve_—¾y_ov”Ïp_ok
(
uµ”_¡¬t
, 
uµ”_’d
, 
Çme
);

842 
	}
}

844 
__š™
 
	$__»£rve_—¾y
(
u64
 
¡¬t
, u64 
’d
, *
Çme
,

845 
ov”Ïp_ok
)

847 
i
;

848 
—¾y_»s
 *
r
;

850 
i
 = 
	`fšd_ov”Ïµed_—¾y
(
¡¬t
, 
’d
);

851 ià(
i
 >ğ
MAX_EARLY_RES
)

852 
	`·nic
("Too manyƒarly„eservations");

853 
r
 = &
—¾y_»s
[
i
];

854 ià(
r
->
’d
)

855 
	`·nic
("Overlappingƒarly„eservations "

857 
¡¬t
, 
’d
 - 1, 
Çme
?Çme:"", 
r
->start,

858 
r
->
’d
 - 1,„->
Çme
);

859 
r
->
¡¬t
 = start;

860 
r
->
’d
 =ƒnd;

861 
r
->
ov”Ïp_ok
 = overlap_ok;

862 ià(
Çme
)

863 
	`¡ºıy
(
r
->
Çme
,‚ame, (r->name) - 1);

864 
	}
}

886 
__š™
 
	$»£rve_—¾y_ov”Ïp_ok
(
u64
 
¡¬t
, u64 
’d
, *
Çme
)

888 
	`drİ_ov”Ïps_th©_¬e_ok
(
¡¬t
, 
’d
);

889 
	`__»£rve_—¾y
(
¡¬t
, 
’d
, 
Çme
, 1);

890 
	}
}

900 
__š™
 
	$»£rve_—¾y
(
u64
 
¡¬t
, u64 
’d
, *
Çme
)

902 ià(
¡¬t
 >ğ
’d
)

905 
	`drİ_ov”Ïps_th©_¬e_ok
(
¡¬t
, 
’d
);

906 
	`__»£rve_—¾y
(
¡¬t
, 
’d
, 
Çme
, 0);

907 
	}
}

909 
__š™
 
	$ä“_—¾y
(
u64
 
¡¬t
, u64 
’d
)

911 
—¾y_»s
 *
r
;

912 
i
;

914 
i
 = 
	`fšd_ov”Ïµed_—¾y
(
¡¬t
, 
’d
);

915 
r
 = &
—¾y_»s
[
i
];

916 ià(
i
 >ğ
MAX_EARLY_RES
 || 
r
->
’d
 !ğ’d ||„->
¡¬t
 != start)

917 
	`·nic
("free_early on‚ot„eserved‡rea: %llx-%llx!",

918 
¡¬t
, 
’d
 - 1);

920 
	`drİ_¿nge
(
i
);

921 
	}
}

923 
__š™
 
	$—¾y_»s_to_boÙmem
(
u64
 
¡¬t
, u64 
’d
)

925 
i
, 
couÁ
;

926 
u64
 
fš®_¡¬t
, 
fš®_’d
;

928 
couÁ
 = 0;

929 
i
 = 0; i < 
MAX_EARLY_RES
 && 
—¾y_»s
[i].
’d
; i++)

930 
couÁ
++;

932 
	`´štk
(
KERN_INFO
 "(%dƒarly„eservations) ==> bootmem [%010llx - %010llx]\n",

933 
couÁ
, 
¡¬t
, 
’d
);

934 
i
 = 0; i < 
couÁ
; i++) {

935 
—¾y_»s
 *
r
 = &—¾y_»s[
i
];

936 
	`´štk
(
KERN_INFO
 " #%d [%010Îx - %010Îx] %16s", 
i
,

937 
r
->
¡¬t
,„->
’d
,„->
Çme
);

938 
fš®_¡¬t
 = 
	`max
(
¡¬t
, 
r
->start);

939 
fš®_’d
 = 
	`mš
(
’d
, 
r
->end);

940 ià(
fš®_¡¬t
 >ğ
fš®_’d
) {

941 
	`´štk
(
KERN_CONT
 "\n");

944 
	`´štk
(
KERN_CONT
 " ==> [%010llx - %010llx]\n",

945 
fš®_¡¬t
, 
fš®_’d
);

946 
	`»£rve_boÙmem_g’”ic
(
fš®_¡¬t
, 
fš®_’d
 - final_start,

947 
BOOTMEM_DEFAULT
);

949 
	}
}

952 
šlše
 
__š™
 
	$bad_addr
(
u64
 *
add½
, u64 
size
, u64 
®ign
)

954 
i
;

955 
u64
 
addr
 = *
add½
;

956 
chªged
 = 0;

957 
—¾y_»s
 *
r
;

958 
agaš
:

959 
i
 = 
	`fšd_ov”Ïµed_—¾y
(
addr
,‡dd¸+ 
size
);

960 
r
 = &
—¾y_»s
[
i
];

961 ià(
i
 < 
MAX_EARLY_RES
 && 
r
->
’d
) {

962 *
add½
 = 
addr
 = 
	`round_up
(
r
->
’d
, 
®ign
);

963 
chªged
 = 1;

964 
agaš
;

966  
chªged
;

967 
	}
}

970 
šlše
 
__š™
 
	$bad_addr_size
(
u64
 *
add½
, u64 *
siz•
, u64 
®ign
)

972 
i
;

973 
u64
 
addr
 = *
add½
, 
Ï¡
;

974 
u64
 
size
 = *
siz•
;

975 
chªged
 = 0;

976 
agaš
:

977 
Ï¡
 = 
addr
 + 
size
;

978 
i
 = 0; i < 
MAX_EARLY_RES
 && 
—¾y_»s
[i].
’d
; i++) {

979 
—¾y_»s
 *
r
 = &—¾y_»s[
i
];

980 ià(
Ï¡
 > 
r
->
¡¬t
 && 
addr
 <„->start) {

981 
size
 = 
r
->
¡¬t
 - 
addr
;

982 
chªged
 = 1;

983 
agaš
;

985 ià(
Ï¡
 > 
r
->
’d
 && 
addr
 <„->end) {

986 
addr
 = 
	`round_up
(
r
->
’d
, 
®ign
);

987 
size
 = 
Ï¡
 - 
addr
;

988 
chªged
 = 1;

989 
agaš
;

991 ià(
Ï¡
 <ğ
r
->
’d
 && 
addr
 >ğr->
¡¬t
) {

992 (*
siz•
)++;

996 ià(
chªged
) {

997 *
add½
 = 
addr
;

998 *
siz•
 = 
size
;

1000  
chªged
;

1001 
	}
}

1006 
u64
 
__š™
 
	$fšd_e820_¬—
(
u64
 
¡¬t
, u64 
’d
, u64 
size
, u64 
®ign
)

1008 
i
;

1010 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1011 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

1012 
u64
 
addr
, 
Ï¡
;

1013 
u64
 
ei_Ï¡
;

1015 ià(
ei
->
ty³
 !ğ
E820_RAM
)

1017 
addr
 = 
	`round_up
(
ei
->addr, 
®ign
);

1018 
ei_Ï¡
 = 
ei
->
addr
 +ƒi->
size
;

1019 ià(
addr
 < 
¡¬t
)

1020 
addr
 = 
	`round_up
(
¡¬t
, 
®ign
);

1021 ià(
addr
 >ğ
ei_Ï¡
)

1023 
	`bad_addr
(&
addr
, 
size
, 
®ign
è&&‡ddr+siz<ğ
ei_Ï¡
)

1025 
Ï¡
 = 
addr
 + 
size
;

1026 ià(
Ï¡
 > 
ei_Ï¡
)

1028 ià(
Ï¡
 > 
’d
)

1030  
addr
;

1033 
	}
}

1038 
u64
 
__š™
 
	$fšd_e820_¬—_size
(
u64
 
¡¬t
, u64 *
siz•
, u64 
®ign
)

1040 
i
;

1042 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1043 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

1044 
u64
 
addr
, 
Ï¡
;

1045 
u64
 
ei_Ï¡
;

1047 ià(
ei
->
ty³
 !ğ
E820_RAM
)

1049 
addr
 = 
	`round_up
(
ei
->addr, 
®ign
);

1050 
ei_Ï¡
 = 
ei
->
addr
 +ƒi->
size
;

1051 ià(
addr
 < 
¡¬t
)

1052 
addr
 = 
	`round_up
(
¡¬t
, 
®ign
);

1053 ià(
addr
 >ğ
ei_Ï¡
)

1055 *
siz•
 = 
ei_Ï¡
 - 
addr
;

1056 
	`bad_addr_size
(&
addr
, 
siz•
, 
®ign
) &&

1057 
addr
 + *
siz•
 <ğ
ei_Ï¡
)

1059 
Ï¡
 = 
addr
 + *
siz•
;

1060 ià(
Ï¡
 > 
ei_Ï¡
)

1062  
addr
;

1066 
	}
}

1071 
u64
 
__š™
 
	$—¾y_»£rve_e820
(
u64
 
¡¬‰
, u64 
siz‘
, u64 
®ign
)

1073 
u64
 
size
 = 0;

1074 
u64
 
addr
;

1075 
u64
 
¡¬t
;

1077 
¡¬t
 = 
¡¬‰
; ; s¹ +ğ
size
) {

1078 
¡¬t
 = 
	`fšd_e820_¬—_size
(¡¬t, &
size
, 
®ign
);

1079 ià(!(
¡¬t
 + 1))

1081 ià(
size
 >ğ
siz‘
)

1085 #ifdeà
CONFIG_X86_32


1086 ià(
¡¬t
 >ğ
MAXMEM
)

1088 ià(
¡¬t
 + 
size
 > 
MAXMEM
)

1089 
size
 = 
MAXMEM
 - 
¡¬t
;

1092 
addr
 = 
	`round_down
(
¡¬t
 + 
size
 - 
siz‘
, 
®ign
);

1093 ià(
addr
 < 
¡¬t
)

1095 
	`e820_upd©e_¿nge
(
addr
, 
siz‘
, 
E820_RAM
, 
E820_RESERVED
);

1096 
	`e820_upd©e_¿nge_§ved
(
addr
, 
siz‘
, 
E820_RAM
, 
E820_RESERVED
);

1097 
	`´štk
(
KERN_INFO
 "updateƒ820 forƒarly_reserve_e820\n");

1098 
	`upd©e_e820
();

1099 
	`upd©e_e820_§ved
();

1101  
addr
;

1102 
	}
}

1104 #ifdeà
CONFIG_X86_32


1105 #ifdeà
CONFIG_X86_PAE


1106 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

1108 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

1111 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

1117 
__š™
 
	$e820_’d_pâ
(
lim™_pâ
, 
ty³
)

1119 
i
;

1120 
Ï¡_pâ
 = 0;

1121 
max_¬ch_pâ
 = 
MAX_ARCH_PFN
;

1123 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1124 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

1125 
¡¬t_pâ
;

1126 
’d_pâ
;

1128 ià(
ei
->
ty³
 !=ype)

1131 
¡¬t_pâ
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

1132 
’d_pâ
 = (
ei
->
addr
 +ƒi->
size
è>> 
PAGE_SHIFT
;

1134 ià(
¡¬t_pâ
 >ğ
lim™_pâ
)

1136 ià(
’d_pâ
 > 
lim™_pâ
) {

1137 
Ï¡_pâ
 = 
lim™_pâ
;

1140 ià(
’d_pâ
 > 
Ï¡_pâ
)

1141 
Ï¡_pâ
 = 
’d_pâ
;

1144 ià(
Ï¡_pâ
 > 
max_¬ch_pâ
)

1145 
Ï¡_pâ
 = 
max_¬ch_pâ
;

1147 
	`´štk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

1148 
Ï¡_pâ
, 
max_¬ch_pâ
);

1149  
Ï¡_pâ
;

1150 
	}
}

1151 
__š™
 
	$e820_’d_of_¿m_pâ
()

1153  
	`e820_’d_pâ
(
MAX_ARCH_PFN
, 
E820_RAM
);

1154 
	}
}

1156 
__š™
 
	$e820_’d_of_low_¿m_pâ
()

1158  
	`e820_’d_pâ
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

1159 
	}
}

1164 
__š™
 
	$e820_fšd_aùive_»giÚ
(cÚ¡ 
e820’Œy
 *
ei
,

1165 
¡¬t_pâ
,

1166 
Ï¡_pâ
,

1167 *
ei_¡¬â
,

1168 *
ei_’dpâ
)

1170 
u64
 
®ign
 = 
PAGE_SIZE
;

1172 *
ei_¡¬â
 = 
	`round_up
(
ei
->
addr
, 
®ign
è>> 
PAGE_SHIFT
;

1173 *
ei_’dpâ
 = 
	`round_down
(
ei
->
addr
 +ƒi->
size
, 
®ign
è>> 
PAGE_SHIFT
;

1176 ià(*
ei_¡¬â
 >ğ*
ei_’dpâ
)

1180 ià(
ei
->
ty³
 !ğ
E820_RAM
 || *
ei_’dpâ
 <ğ
¡¬t_pâ
 ||

1181 *
ei_¡¬â
 >ğ
Ï¡_pâ
)

1185 ià(*
ei_¡¬â
 < 
¡¬t_pâ
)

1186 *
ei_¡¬â
 = 
¡¬t_pâ
;

1187 ià(*
ei_’dpâ
 > 
Ï¡_pâ
)

1188 *
ei_’dpâ
 = 
Ï¡_pâ
;

1191 
	}
}

1194 
__š™
 
	$e820_»gi¡”_aùive_»giÚs
(
nid
, 
¡¬t_pâ
,

1195 
Ï¡_pâ
)

1197 
ei_¡¬â
;

1198 
ei_’dpâ
;

1199 
i
;

1201 
i
 = 0; i < 
e820
.
Ä_m­
; i++)

1202 ià(
	`e820_fšd_aùive_»giÚ
(&
e820
.
m­
[
i
],

1203 
¡¬t_pâ
, 
Ï¡_pâ
,

1204 &
ei_¡¬â
, &
ei_’dpâ
))

1205 
	`add_aùive_¿nge
(
nid
, 
ei_¡¬â
, 
ei_’dpâ
);

1206 
	}
}

1213 
u64
 
__š™
 
	$e820_hŞe_size
(
u64
 
¡¬t
, u64 
’d
)

1215 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1216 
Ï¡_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

1217 
ei_¡¬â
, 
ei_’dpâ
, 
¿m
 = 0;

1218 
i
;

1220 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1221 ià(
	`e820_fšd_aùive_»giÚ
(&
e820
.
m­
[
i
],

1222 
¡¬t_pâ
, 
Ï¡_pâ
,

1223 &
ei_¡¬â
, &
ei_’dpâ
))

1224 
¿m
 +ğ
ei_’dpâ
 - 
ei_¡¬â
;

1226  
’d
 - 
¡¬t
 - ((
u64
)
¿m
 << 
PAGE_SHIFT
);

1227 
	}
}

1229 
	$—¾y_·nic
(*
msg
)

1231 
	`—¾y_´štk
(
msg
);

1232 
	`·nic
(
msg
);

1233 
	}
}

1235 
u£rdef
 
	g__š™d©a
;

1238 
__š™
 
	$·r£_memİt
(*
p
)

1240 
u64
 
mem_size
;

1242 ià(!
p
)

1243  -
EINVAL
;

1245 #ifdeà
CONFIG_X86_32


1246 ià(!
	`¡rcmp
(
p
, "nopentium")) {

1247 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_PSE
);

1252 
u£rdef
 = 1;

1253 
mem_size
 = 
	`mem·r£
(
p
, &p);

1254 
	`e820_»move_¿nge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1257 
	}
}

1258 
—¾y_·¿m
("mem", 
·r£_memİt
);

1260 
__š™
 
	$·r£_memm­_İt
(*
p
)

1262 *
Şdp
;

1263 
u64
 
¡¬t_©
, 
mem_size
;

1265 ià(!
p
)

1266  -
EINVAL
;

1268 ià(!
	`¡ºcmp
(
p
, "exactmap", 8)) {

1269 #ifdeà
CONFIG_CRASH_DUMP


1275 
§ved_max_pâ
 = 
	`e820_’d_of_¿m_pâ
();

1277 
e820
.
Ä_m­
 = 0;

1278 
u£rdef
 = 1;

1282 
Şdp
 = 
p
;

1283 
mem_size
 = 
	`mem·r£
(
p
, &p);

1284 ià(
p
 =ğ
Şdp
)

1285  -
EINVAL
;

1287 
u£rdef
 = 1;

1288 ià(*
p
 == '@') {

1289 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

1290 
	`e820_add_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_RAM
);

1291 } ià(*
p
 == '#') {

1292 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

1293 
	`e820_add_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_ACPI
);

1294 } ià(*
p
 == '$') {

1295 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

1296 
	`e820_add_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_RESERVED
);

1298 
	`e820_»move_¿nge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1300  *
p
 =ğ'\0' ? 0 : -
EINVAL
;

1301 
	}
}

1302 
—¾y_·¿m
("memm­", 
·r£_memm­_İt
);

1304 
__š™
 
	$fšish_e820_·rsšg
()

1306 ià(
u£rdef
) {

1307 
u32
 
Ä
 = 
e820
.
Ä_m­
;

1309 ià(
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &
Ä
) < 0)

1310 
	`—¾y_·nic
("Invalid user supplied memory map");

1311 
e820
.
Ä_m­
 = 
Ä
;

1313 
	`´štk
(
KERN_INFO
 "user-defined…hysical RAM map:\n");

1314 
	`e820_´št_m­
("user");

1316 
	}
}

1318 
šlše
 cÚ¡ *
	$e820_ty³_to_¡ršg
(
e820_ty³
)

1320 
e820_ty³
) {

1321 
E820_RESERVED_KERN
:

1322 
E820_RAM
:  "System RAM";

1323 
E820_ACPI
:  "ACPI Tables";

1324 
E820_NVS
:  "ACPI Non-volatile Storage";

1325 
E820_UNUSABLE
:  "Unusable memory";

1328 
	}
}

1333 
»sourû
 
__š™d©a
 *
	ge820_»s
;

1334 
__š™
 
	$e820_»£rve_»sourûs
()

1336 
i
;

1337 
»sourû
 *
»s
;

1338 
u64
 
’d
;

1340 
»s
 = 
	`®loc_boÙmem_low
((
»sourû
è* 
e820
.
Ä_m­
);

1341 
e820_»s
 = 
»s
;

1342 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1343 
’d
 = 
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
 - 1;

1344 ià(
’d
 !ğ(
»sourû_size_t
)end) {

1345 
»s
++;

1348 
»s
->
Çme
 = 
	`e820_ty³_to_¡ršg
(
e820
.
m­
[
i
].
ty³
);

1349 
»s
->
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

1350 
»s
->
’d
 =ƒnd;

1352 
»s
->
æags
 = 
IORESOURCE_MEM
;

1359 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RESERVED
 || 
»s
->
¡¬t
 < (1ULL<<20)) {

1360 
»s
->
æags
 |ğ
IORESOURCE_BUSY
;

1361 
	`š£¹_»sourû
(&
iomem_»sourû
, 
»s
);

1363 
»s
++;

1366 
i
 = 0; i < 
e820_§ved
.
Ä_m­
; i++) {

1367 
e820’Œy
 *
’Œy
 = &
e820_§ved
.
m­
[
i
];

1368 
	`fœmw¬e_m­_add_—¾y
(
’Œy
->
addr
,

1369 
’Œy
->
addr
 +ƒÁry->
size
 - 1,

1370 
	`e820_ty³_to_¡ršg
(
’Œy
->
ty³
));

1372 
	}
}

1374 
__š™
 
	$e820_»£rve_»sourûs_Ï‹
()

1376 
i
;

1377 
»sourû
 *
»s
;

1379 
»s
 = 
e820_»s
;

1380 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

1381 ià(!
»s
->
·»Á
 &&„es->
’d
)

1382 
	`š£¹_»sourû_ex·nd_to_f™
(&
iomem_»sourû
, 
»s
);

1383 
»s
++;

1385 
	}
}

1387 *
__š™
 
	$deçuÉ_machše_¥ecific_memÜy_£tup
()

1389 *
who
 = "BIOS-e820";

1390 
u32
 
Ãw_Ä
;

1397 
Ãw_Ä
 = 
boÙ_·¿ms
.
e820_’Œ›s
;

1398 
	`§n™ize_e820_m­
(
boÙ_·¿ms
.
e820_m­
,

1399 
	`ARRAY_SIZE
(
boÙ_·¿ms
.
e820_m­
),

1400 &
Ãw_Ä
);

1401 
boÙ_·¿ms
.
e820_’Œ›s
 = 
Ãw_Ä
;

1402 ià(
	`­³nd_e820_m­
(
boÙ_·¿ms
.
e820_m­
, boÙ_·¿ms.
e820_’Œ›s
)

1404 
u64
 
mem_size
;

1407 ià(
boÙ_·¿ms
.
®t_mem_k


1408 < 
boÙ_·¿ms
.
sü“n_šfo
.
ext_mem_k
) {

1409 
mem_size
 = 
boÙ_·¿ms
.
sü“n_šfo
.
ext_mem_k
;

1410 
who
 = "BIOS-88";

1412 
mem_size
 = 
boÙ_·¿ms
.
®t_mem_k
;

1413 
who
 = "BIOS-e801";

1416 
e820
.
Ä_m­
 = 0;

1417 
	`e820_add_»giÚ
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1418 
	`e820_add_»giÚ
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1422  
who
;

1423 
	}
}

1425 *
__š™
 
__©Œibu‹__
((
w—k
)è
	$machše_¥ecific_memÜy_£tup
()

1427 ià(
x86_quœks
->
¬ch_memÜy_£tup
) {

1428 *
who
 = 
x86_quœks
->
	`¬ch_memÜy_£tup
();

1430 ià(
who
)

1431  
who
;

1433  
	`deçuÉ_machše_¥ecific_memÜy_£tup
();

1434 
	}
}

1437 * 
__š™
 
__©Œibu‹__
((
w—k
)è
	$memÜy_£tup
()

1439  
	`machše_¥ecific_memÜy_£tup
();

1440 
	}
}

1442 
__š™
 
	$£tup_memÜy_m­
()

1444 *
who
;

1446 
who
 = 
	`memÜy_£tup
();

1447 
	`memıy
(&
e820_§ved
, &
e820
, (
e820m­
));

1448 
	`´štk
(
KERN_INFO
 "BIOS-provided…hysical RAM map:\n");

1449 
	`e820_´št_m­
(
who
);

1450 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<lšux/pci.h
>

13 
	~<lšux/aıi.h
>

14 
	~<lšux/pci_ids.h
>

15 
	~<asm/pci-dœeù.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_­ic.h
>

18 
	~<asm/­ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¬t.h
>

22 
__š™
 
	$fix_hy³¹¿n¥Üt_cÚfig
(
num
, 
¦Ù
, 
func
)

24 
u32
 
htcfg
;

31 
htcfg
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x68);

32 ià(
htcfg
 & (1 << 18)) {

33 
	`´štk
(
KERN_INFO
 "Detected use ofƒxtended‡pic ids "

35 ià((
htcfg
 & (1 << 17)) == 0) {

36 
	`´štk
(
KERN_INFO
 "Enabling hypertransportƒxtended "

38 
	`´štk
(
KERN_INFO
 "Notehis is‡ bios bug, "

40 
htcfg
 |= (1 << 17);

41 
	`wr™e_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x68, 
htcfg
);

46 
	}
}

48 
__š™
 
	$vŸ_bugs
(
num
, 
¦Ù
, 
func
)

50 #ifdeà
CONFIG_GART_IOMMU


51 ià((
max_pâ
 > 
MAX_DMA32_PFN
 || 
fÜû_iommu
) &&

52 !
g¬t_iommu_­”tu»_®lowed
) {

53 
	`´štk
(
KERN_INFO


56 
g¬t_iommu_­”tu»_di§bËd
 = 1;

59 
	}
}

61 #ifdeà
CONFIG_ACPI


62 #ifdeà
CONFIG_X86_IO_APIC


64 
__š™
 
	$nvidŸ_h³t_check
(
aıi_bË_h—d”
 *
h—d”
)

67 
	}
}

71 
__š™
 
	$nvidŸ_bugs
(
num
, 
¦Ù
, 
func
)

73 #ifdeà
CONFIG_ACPI


74 #ifdeà
CONFIG_X86_IO_APIC


82 ià(
aıi_u£_tim”_ov”ride
)

85 ià(
	`aıi_bË_·r£
(
ACPI_SIG_HPET
, 
nvidŸ_h³t_check
)) {

86 
aıi_sk_tim”_ov”ride
 = 1;

87 
	`´štk
(
KERN_INFO
 "Nvidia board "

90 
	`´štk
(
KERN_INFO
 "If you gotimerrouble "

97 
	}
}

99 #ià
defšed
(
CONFIG_ACPI
è&& defšed(
CONFIG_X86_IO_APIC
)

100 
u32
 
__š™
 
	$©i_ixp4x0_»v
(
num
, 
¦Ù
, 
func
)

102 
u32
 
d
;

103 
u8
 
b
;

105 
b
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
, 0xac);

106 
b
 &= ~(1<<5);

107 
	`wr™e_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
, 0xac, 
b
);

109 
d
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x70);

110 
d
 |= 1<<8;

111 
	`wr™e_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x70, 
d
);

113 
d
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x8);

114 
d
 &= 0xff;

115  
d
;

116 
	}
}

118 
__š™
 
	$©i_bugs
(
num
, 
¦Ù
, 
func
)

120 
u32
 
d
;

121 
u8
 
b
;

123 ià(
aıi_u£_tim”_ov”ride
)

126 
d
 = 
	`©i_ixp4x0_»v
(
num
, 
¦Ù
, 
func
);

127 ià(
d
 < 0x82)

128 
aıi_sk_tim”_ov”ride
 = 1;

131 
	`outb
(0x72, 0xcd6); 
b
 = 
	`šb
(0xcd7);

132 ià(!(
b
 & 0x2))

133 
aıi_sk_tim”_ov”ride
 = 1;

136 ià(
aıi_sk_tim”_ov”ride
) {

137 
	`´štk
(
KERN_INFO
 "SB4X0„evisiÚ 0x%x\n", 
d
);

138 
	`´štk
(
KERN_INFO
 "Ignoring ACPIimer override.\n");

139 
	`´štk
(
KERN_INFO
 "If you gotimerrouble "

142 
	}
}

144 
u32
 
__š™
 
	$©i_sbx00_»v
(
num
, 
¦Ù
, 
func
)

146 
u32
 
Şd
, 
d
;

148 
d
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x70);

149 
Şd
 = 
d
;

150 
d
 &= ~(1<<8);

151 
	`wr™e_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x70, 
d
);

152 
d
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x8);

153 
d
 &= 0xff;

154 
	`wr™e_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x70, 
Şd
);

156  
d
;

157 
	}
}

159 
__š™
 
	$©i_bugs_cÚtd
(
num
, 
¦Ù
, 
func
)

161 
u32
 
d
, 
»v
;

163 ià(
aıi_u£_tim”_ov”ride
)

166 
»v
 = 
	`©i_sbx00_»v
(
num
, 
¦Ù
, 
func
);

167 ià(
»v
 > 0x13)

171 
d
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
, 0x64);

172 ià(!(
d
 & (1<<14)))

173 
aıi_sk_tim”_ov”ride
 = 1;

175 ià(
aıi_sk_tim”_ov”ride
) {

176 
	`´štk
(
KERN_INFO
 "SB600„evisiÚ 0x%x\n", 
»v
);

177 
	`´štk
(
KERN_INFO
 "Ignoring ACPIimer override.\n");

178 
	`´štk
(
KERN_INFO
 "If you gotimerrouble "

181 
	}
}

183 
__š™
 
	$©i_bugs
(
num
, 
¦Ù
, 
func
)

185 
	}
}

187 
__š™
 
	$©i_bugs_cÚtd
(
num
, 
¦Ù
, 
func
)

189 
	}
}

192 
	#QFLAG_APPLY_ONCE
 0x1

	)

193 
	#QFLAG_APPLIED
 0x2

	)

194 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

195 
	sch£t
 {

196 
u32
 
	mv’dÜ
;

197 
u32
 
	mdeviû
;

198 
u32
 
	mşass
;

199 
u32
 
	mşass_mask
;

200 
u32
 
	mæags
;

201 (*
	mf
)(
	mnum
, 
	m¦Ù
, 
	mfunc
);

210 
ch£t
 
	g—¾y_qrk
[] 
	g__š™d©a
 = {

211 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

212 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidŸ_bugs
 },

213 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

214 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vŸ_bugs
 },

215 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

216 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy³¹¿n¥Üt_cÚfig
 },

217 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

218 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

219 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

220 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_cÚtd
 },

235 
__š™
 
	$check_dev_quœk
(
num
, 
¦Ù
, 
func
)

237 
u16
 
şass
;

238 
u16
 
v’dÜ
;

239 
u16
 
deviû
;

240 
u8
 
ty³
;

241 
i
;

243 
şass
 = 
	`»ad_pci_cÚfig_16
(
num
, 
¦Ù
, 
func
, 
PCI_CLASS_DEVICE
);

245 ià(
şass
 == 0xffff)

248 
v’dÜ
 = 
	`»ad_pci_cÚfig_16
(
num
, 
¦Ù
, 
func
, 
PCI_VENDOR_ID
);

250 
deviû
 = 
	`»ad_pci_cÚfig_16
(
num
, 
¦Ù
, 
func
, 
PCI_DEVICE_ID
);

252 
i
 = 0; 
—¾y_qrk
[i].
f
 !ğ
NULL
; i++) {

253 ià(((
—¾y_qrk
[
i
].
v’dÜ
 =ğ
PCI_ANY_ID
) ||

254 (
—¾y_qrk
[
i
].
v’dÜ
 == vendor)) &&

255 ((
—¾y_qrk
[
i
].
deviû
 =ğ
PCI_ANY_ID
) ||

256 (
—¾y_qrk
[
i
].
deviû
 == device)) &&

257 (!((
—¾y_qrk
[
i
].
şass
 ^ class) &

258 
—¾y_qrk
[
i
].
şass_mask
))) {

259 ià((
—¾y_qrk
[
i
].
æags
 &

260 
QFLAG_DONE
) != QFLAG_DONE)

261 
—¾y_qrk
[
i
].
	`f
(
num
, 
¦Ù
, 
func
);

262 
—¾y_qrk
[
i
].
æags
 |ğ
QFLAG_APPLIED
;

266 
ty³
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
,

267 
PCI_HEADER_TYPE
);

268 ià(!(
ty³
 & 0x80))

272 
	}
}

274 
__š™
 
	$—¾y_quœks
()

276 
¦Ù
, 
func
;

278 ià(!
	`—¾y_pci_®lowed
())

283 
¦Ù
 = 0; slot < 32; slot++)

284 
func
 = 0; func < 8; func++) {

286 ià(
	`check_dev_quœk
(0, 
¦Ù
, 
func
))

289 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<lšux/cÚsŞe.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/š™.h
>

4 
	~<lšux/¡ršg.h
>

5 
	~<lšux/sü“n_šfo.h
>

6 
	~<lšux/usb/ch9.h
>

7 
	~<lšux/pci_»gs.h
>

8 
	~<lšux/pci_ids.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<asm/io.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/fú.h
>

13 
	~<asm/£tup.h
>

14 
	~<x’/hvc-cÚsŞe.h
>

15 
	~<asm/pci-dœeù.h
>

16 
	~<asm/fixm­.h
>

17 
	~<asm/pgbË.h
>

18 
	~<lšux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcu¼’t_ypos
 = 25, 
	gcu¼’t_xpos
;

26 
	$—¾y_vga_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
¡r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
¡r
++è!ğ'\0' && 
n
-- > 0) {

32 ià(
cu¼’t_ypos
 >ğ
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wr™ew
(
	`»adw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wr™ew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cu¼’t_ypos
 = 
max_ypos
-1;

44 ià(
c
 == '\n') {

45 
cu¼’t_xpos
 = 0;

46 
cu¼’t_ypos
++;

47 } ià(
c
 != '\r') {

48 
	`wr™ew
(((0x7 << 8è| (è
c
),

49 
VGABASE
 + 2*(
max_xpos
*
cu¼’t_ypos
 +

50 
cu¼’t_xpos
++));

51 ià(
cu¼’t_xpos
 >ğ
max_xpos
) {

52 
cu¼’t_xpos
 = 0;

53 
cu¼’t_ypos
++;

57 
	}
}

59 
cÚsŞe
 
	g—¾y_vga_cÚsŞe
 = {

60 .
Çme
 = "earlyvga",

61 .
	gwr™e
 = 
—¾y_vga_wr™e
,

62 .
	gæags
 = 
CON_PRINTBUFFER
,

63 .
	gšdex
 = -1,

68 
	g—¾y_£rŸl_ba£
 = 0x3f8;

70 
	#XMTRDY
 0x20

	)

72 
	#DLAB
 0x80

	)

74 
	#TXR
 0

	)

75 
	#RXR
 0

	)

76 
	#IER
 1

	)

77 
	#IIR
 2

	)

78 
	#FCR
 2

	)

79 
	#LCR
 3

	)

80 
	#MCR
 4

	)

81 
	#LSR
 5

	)

82 
	#MSR
 6

	)

83 
	#DLL
 0

	)

84 
	#DLH
 1

	)

86 
	$—¾y_£rŸl_putc
(
ch
)

88 
timeout
 = 0xffff;

90 (
	`šb
(
—¾y_£rŸl_ba£
 + 
LSR
è& 
XMTRDY
è=ğ0 && --
timeout
)

91 
	`ıu_»Ïx
();

92 
	`outb
(
ch
, 
—¾y_£rŸl_ba£
 + 
TXR
);

93  
timeout
 ? 0 : -1;

94 
	}
}

96 
	$—¾y_£rŸl_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
s
, 
n
)

98 *
s
 && 
n
-- > 0) {

99 ià(*
s
 == '\n')

100 
	`—¾y_£rŸl_putc
('\r');

101 
	`—¾y_£rŸl_putc
(*
s
);

102 
s
++;

104 
	}
}

106 
	#DEFAULT_BAUD
 9600

	)

108 
__š™
 
	$—¾y_£rŸl_š™
(*
s
)

110 
c
;

111 
divisÜ
;

112 
baud
 = 
DEFAULT_BAUD
;

113 *
e
;

115 ià(*
s
 == ',')

116 ++
s
;

118 ià(*
s
) {

119 
pÜt
;

120 ià(!
	`¡ºcmp
(
s
, "0x", 2)) {

121 
—¾y_£rŸl_ba£
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 16);

123 cÚ¡ 
__š™cÚ¡
 
ba£s
[] = { 0x3f8, 0x2f8 };

125 ià(!
	`¡ºcmp
(
s
, "ttyS", 4))

126 
s
 += 4;

127 
pÜt
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 10);

128 ià(
pÜt
 > 1 || 
s
 =ğ
e
)

129 
pÜt
 = 0;

130 
—¾y_£rŸl_ba£
 = 
ba£s
[
pÜt
];

132 
s
 +ğ
	`¡rc¥n
(s, ",");

133 ià(*
s
 == ',')

134 
s
++;

137 
	`outb
(0x3, 
—¾y_£rŸl_ba£
 + 
LCR
);

138 
	`outb
(0, 
—¾y_£rŸl_ba£
 + 
IER
);

139 
	`outb
(0, 
—¾y_£rŸl_ba£
 + 
FCR
);

140 
	`outb
(0x3, 
—¾y_£rŸl_ba£
 + 
MCR
);

142 ià(*
s
) {

143 
baud
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 0);

144 ià(
baud
 =ğ0 || 
s
 =ğ
e
)

145 
baud
 = 
DEFAULT_BAUD
;

148 
divisÜ
 = 115200 / 
baud
;

149 
c
 = 
	`šb
(
—¾y_£rŸl_ba£
 + 
LCR
);

150 
	`outb
(
c
 | 
DLAB
, 
—¾y_£rŸl_ba£
 + 
LCR
);

151 
	`outb
(
divisÜ
 & 0xff, 
—¾y_£rŸl_ba£
 + 
DLL
);

152 
	`outb
((
divisÜ
 >> 8è& 0xff, 
—¾y_£rŸl_ba£
 + 
DLH
);

153 
	`outb
(
c
 & ~
DLAB
, 
—¾y_£rŸl_ba£
 + 
LCR
);

154 
	}
}

156 
cÚsŞe
 
	g—¾y_£rŸl_cÚsŞe
 = {

157 .
Çme
 = "earlyser",

158 .
	gwr™e
 = 
—¾y_£rŸl_wr™e
,

159 .
	gæags
 = 
CON_PRINTBUFFER
,

160 .
	gšdex
 = -1,

163 #ifdeà
CONFIG_EARLY_PRINTK_DBGP


165 
ehci_ÿps
 
__iomem
 *
	gehci_ÿps
;

166 
ehci_»gs
 
__iomem
 *
	gehci_»gs
;

167 
ehci_dbg_pÜt
 
__iomem
 *
	gehci_debug
;

168 
	gdbgp_’dpošt_out
;

170 
	sehci_dev
 {

171 
u32
 
	mbus
;

172 
u32
 
	m¦Ù
;

173 
u32
 
	mfunc
;

176 
ehci_dev
 
	gehci_dev
;

178 
	#USB_DEBUG_DEVNUM
 127

	)

180 
	#DBGP_DATA_TOGGLE
 0x8800

	)

182 
šlše
 
u32
 
	$dbgp_pid_upd©e
(
u32
 
x
, u32 
tok
)

184  ((
x
 ^ 
DBGP_DATA_TOGGLE
è& 0xffff00è| (
tok
 & 0xff);

185 
	}
}

187 
šlše
 
u32
 
	$dbgp_Ën_upd©e
(
u32
 
x
, u32 
Ën
)

189  (
x
 & ~0x0fè| (
Ën
 & 0x0f);

190 
	}
}

197 
	#USB_PID_OUT
 0xe1

	)

198 
	#USB_PID_IN
 0x69

	)

199 
	#USB_PID_SOF
 0xa5

	)

200 
	#USB_PID_SETUP
 0x2d

	)

202 
	#USB_PID_ACK
 0xd2

	)

203 
	#USB_PID_NAK
 0x5a

	)

204 
	#USB_PID_STALL
 0x1e

	)

205 
	#USB_PID_NYET
 0x96

	)

207 
	#USB_PID_DATA0
 0xc3

	)

208 
	#USB_PID_DATA1
 0x4b

	)

209 
	#USB_PID_DATA2
 0x87

	)

210 
	#USB_PID_MDATA
 0x0f

	)

212 
	#USB_PID_PREAMBLE
 0x3c

	)

213 
	#USB_PID_ERR
 0x3c

	)

214 
	#USB_PID_SPLIT
 0x78

	)

215 
	#USB_PID_PING
 0xb4

	)

216 
	#USB_PID_UNDEF_0
 0xf0

	)

218 
	#USB_PID_DATA_TOGGLE
 0x88

	)

219 
	#DBGP_CLAIM
 (
DBGP_OWNER
 | 
DBGP_ENABLED
 | 
DBGP_INUSE
)

	)

221 
	#PCI_CAP_ID_EHCI_DEBUG
 0xa

	)

223 
	#HUB_ROOT_RESET_TIME
 50

	)

224 
	#HUB_SHORT_RESET_TIME
 10

	)

225 
	#HUB_LONG_RESET_TIME
 200

	)

226 
	#HUB_RESET_TIMEOUT
 500

	)

228 
	#DBGP_MAX_PACKET
 8

	)

230 
	$dbgp_wa™_uÁ_com¶‘e
()

232 
u32
 
ù¾
;

233 
loİ
 = 0x100000;

236 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

238 ià(
ù¾
 & 
DBGP_DONE
)

240 } --
loİ
 > 0);

242 ià(!
loİ
)

249 
	`wr™–
(
ù¾
 | 
DBGP_DONE
, &
ehci_debug
->
cÚŒŞ
);

250  (
ù¾
 & 
DBGP_ERROR
è? -
	`DBGP_ERRCODE
(ù¾è: 
	`DBGP_LEN
(ctrl);

251 
	}
}

253 
__š™
 
	$dbgp_md–ay
(
ms
)

255 
i
;

257 
ms
--) {

258 
i
 = 0; i < 1000; i++)

259 
	`outb
(0x1, 0x80);

261 
	}
}

263 
	$dbgp_b»©h
()

266 
	}
}

268 
	$dbgp_wa™_uÁ_dÚe
(
ù¾
)

270 
u32
 
pids
, 
Íid
;

271 
»t
;

272 
loİ
 = 3;

274 
»Œy
:

275 
	`wr™–
(
ù¾
 | 
DBGP_GO
, &
ehci_debug
->
cÚŒŞ
);

276 
»t
 = 
	`dbgp_wa™_uÁ_com¶‘e
();

277 
pids
 = 
	`»adl
(&
ehci_debug
->pids);

278 
Íid
 = 
	`DBGP_PID_GET
(
pids
);

280 ià(
»t
 < 0)

281  
»t
;

287 ià((
Íid
 =ğ
USB_PID_NAK
è|| (Íid =ğ
USB_PID_NYET
))

288 
	`dbgp_b»©h
();

291 ià(
Íid
 =ğ
USB_PID_NAK
) {

292 ià(--
loİ
 > 0)

293 
»Œy
;

296  
»t
;

297 
	}
}

299 
	$dbgp_£t_d©a
(cÚ¡ *
buf
, 
size
)

301 cÚ¡ *
by‹s
 = 
buf
;

302 
u32
 
lo
, 
hi
;

303 
i
;

305 
lo
 = 
hi
 = 0;

306 
i
 = 0; i < 4 && i < 
size
; i++)

307 
lo
 |ğ
by‹s
[
i
] << (8*i);

308 ; 
i
 < 8 && i < 
size
; i++)

309 
hi
 |ğ
by‹s
[
i
] << (8*(i - 4));

310 
	`wr™–
(
lo
, &
ehci_debug
->
d©a03
);

311 
	`wr™–
(
hi
, &
ehci_debug
->
d©a47
);

312 
	}
}

314 
__š™
 
	$dbgp_g‘_d©a
(*
buf
, 
size
)

316 *
by‹s
 = 
buf
;

317 
u32
 
lo
, 
hi
;

318 
i
;

320 
lo
 = 
	`»adl
(&
ehci_debug
->
d©a03
);

321 
hi
 = 
	`»adl
(&
ehci_debug
->
d©a47
);

322 
i
 = 0; i < 4 && i < 
size
; i++)

323 
by‹s
[
i
] = (
lo
 >> (8*i)) & 0xff;

324 ; 
i
 < 8 && i < 
size
; i++)

325 
by‹s
[
i
] = (
hi
 >> (8*(i - 4))) & 0xff;

326 
	}
}

328 
	$dbgp_bulk_wr™e
(
devnum
, 
’dpošt
,

329 cÚ¡ *
by‹s
, 
size
)

331 
u32
 
pids
, 
addr
, 
ù¾
;

332 
»t
;

334 ià(
size
 > 
DBGP_MAX_PACKET
)

337 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 
’dpošt
);

339 
pids
 = 
	`»adl
(&
ehci_debug
->pids);

340 
pids
 = 
	`dbgp_pid_upd©e
Õids, 
USB_PID_OUT
);

342 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

343 
ù¾
 = 
	`dbgp_Ën_upd©e
(ù¾, 
size
);

344 
ù¾
 |ğ
DBGP_OUT
;

345 
ù¾
 |ğ
DBGP_GO
;

347 
	`dbgp_£t_d©a
(
by‹s
, 
size
);

348 
	`wr™–
(
addr
, &
ehci_debug
->
add»ss
);

349 
	`wr™–
(
pids
, &
ehci_debug
->pids);

351 
»t
 = 
	`dbgp_wa™_uÁ_dÚe
(
ù¾
);

352 ià(
»t
 < 0)

353  
»t
;

355  
»t
;

356 
	}
}

358 
__š™
 
	$dbgp_bulk_»ad
(
devnum
, 
’dpošt
, *
d©a
,

359 
size
)

361 
u32
 
pids
, 
addr
, 
ù¾
;

362 
»t
;

364 ià(
size
 > 
DBGP_MAX_PACKET
)

367 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 
’dpošt
);

369 
pids
 = 
	`»adl
(&
ehci_debug
->pids);

370 
pids
 = 
	`dbgp_pid_upd©e
Õids, 
USB_PID_IN
);

372 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

373 
ù¾
 = 
	`dbgp_Ën_upd©e
(ù¾, 
size
);

374 
ù¾
 &ğ~
DBGP_OUT
;

375 
ù¾
 |ğ
DBGP_GO
;

377 
	`wr™–
(
addr
, &
ehci_debug
->
add»ss
);

378 
	`wr™–
(
pids
, &
ehci_debug
->pids);

379 
»t
 = 
	`dbgp_wa™_uÁ_dÚe
(
ù¾
);

380 ià(
»t
 < 0)

381  
»t
;

383 ià(
size
 > 
»t
)

384 
size
 = 
»t
;

385 
	`dbgp_g‘_d©a
(
d©a
, 
size
);

386  
»t
;

387 
	}
}

389 
__š™
 
	$dbgp_cÚŒŞ_msg
(
devnum
, 
»que¡ty³
,

390 
»que¡
, 
v®ue
, 
šdex
, *
d©a
, 
size
)

392 
u32
 
pids
, 
addr
, 
ù¾
;

393 
usb_ù¾»que¡
 
»q
;

394 
»ad
;

395 
»t
;

397 
»ad
 = (
»que¡ty³
 & 
USB_DIR_IN
) != 0;

398 ià(
size
 > (
»ad
 ? 
DBGP_MAX_PACKET
:0))

402 
»q
.
bReque¡Ty³
 = 
»que¡ty³
;

403 
»q
.
bReque¡
 = 
»que¡
;

404 
»q
.
wV®ue
 = 
	`ıu_to_Ë16
(
v®ue
);

405 
»q
.
wIndex
 = 
	`ıu_to_Ë16
(
šdex
);

406 
»q
.
wL’gth
 = 
	`ıu_to_Ë16
(
size
);

408 
pids
 = 
	`DBGP_PID_SET
(
USB_PID_DATA0
, 
USB_PID_SETUP
);

409 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 0);

411 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

412 
ù¾
 = 
	`dbgp_Ën_upd©e
(ù¾, (
»q
));

413 
ù¾
 |ğ
DBGP_OUT
;

414 
ù¾
 |ğ
DBGP_GO
;

417 
	`dbgp_£t_d©a
(&
»q
, (req));

418 
	`wr™–
(
addr
, &
ehci_debug
->
add»ss
);

419 
	`wr™–
(
pids
, &
ehci_debug
->pids);

420 
»t
 = 
	`dbgp_wa™_uÁ_dÚe
(
ù¾
);

421 ià(
»t
 < 0)

422  
»t
;

425  
	`dbgp_bulk_»ad
(
devnum
, 0, 
d©a
, 
size
);

426 
	}
}

430 
u32
 
__š™
 
	$fšd_ÿp
(
u32
 
num
, u32 
¦Ù
, u32 
func
, 
ÿp
)

432 
u8
 
pos
;

433 
by‹s
;

435 ià(!(
	`»ad_pci_cÚfig_16
(
num
, 
¦Ù
, 
func
, 
PCI_STATUS
) &

436 
PCI_STATUS_CAP_LIST
))

439 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
, 
PCI_CAPABILITY_LIST
);

440 
by‹s
 = 0; by‹ < 48 && 
pos
 >= 0x40; bytes++) {

441 
u8
 
id
;

443 
pos
 &= ~3;

444 
id
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

445 ià(
id
 == 0xff)

447 ià(
id
 =ğ
ÿp
)

448  
pos
;

450 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
,

451 
pos
+
PCI_CAP_LIST_NEXT
);

454 
	}
}

456 
u32
 
__š™
 
	$__fšd_dbgp
(
u32
 
bus
, u32 
¦Ù
, u32 
func
)

458 
u32
 
şass
;

460 
şass
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
, 
PCI_CLASS_REVISION
);

461 ià((
şass
 >> 8è!ğ
PCI_CLASS_SERIAL_USB_EHCI
)

464  
	`fšd_ÿp
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_EHCI_DEBUG
);

465 
	}
}

467 
u32
 
__š™
 
	$fšd_dbgp
(
ehci_num
, 
u32
 *
rbus
, u32 *
r¦Ù
, u32 *
rfunc
)

469 
u32
 
bus
, 
¦Ù
, 
func
;

471 
bus
 = 0; bus < 256; bus++) {

472 
¦Ù
 = 0; slot < 32; slot++) {

473 
func
 = 0; func < 8; func++) {

474 
ÿp
;

476 
ÿp
 = 
	`__fšd_dbgp
(
bus
, 
¦Ù
, 
func
);

478 ià(!
ÿp
)

480 ià(
ehci_num
-- != 0)

482 *
rbus
 = 
bus
;

483 *
r¦Ù
 = 
¦Ù
;

484 *
rfunc
 = 
func
;

485  
ÿp
;

490 
	}
}

492 
__š™
 
	$ehci_»£t_pÜt
(
pÜt
)

494 
u32
 
pÜtsc
;

495 
u32
 
d–ay_time
, 
d–ay
;

496 
loİ
;

499 
pÜtsc
 = 
	`»adl
(&
ehci_»gs
->
pÜt_¡©us
[
pÜt
 - 1]);

500 
pÜtsc
 &ğ~
PORT_PE
;

501 
pÜtsc
 |ğ
PORT_RESET
;

502 
	`wr™–
(
pÜtsc
, &
ehci_»gs
->
pÜt_¡©us
[
pÜt
 - 1]);

504 
d–ay
 = 
HUB_ROOT_RESET_TIME
;

505 
d–ay_time
 = 0; d–ay_tim< 
HUB_RESET_TIMEOUT
;

506 
d–ay_time
 +ğ
d–ay
) {

507 
	`dbgp_md–ay
(
d–ay
);

509 
pÜtsc
 = 
	`»adl
(&
ehci_»gs
->
pÜt_¡©us
[
pÜt
 - 1]);

510 ià(
pÜtsc
 & 
PORT_RESET
) {

512 
loİ
 = 2;

513 
	`wr™–
(
pÜtsc
 & ~(
PORT_RWC_BITS
 | 
PORT_RESET
),

514 &
ehci_»gs
->
pÜt_¡©us
[
pÜt
 - 1]);

516 
pÜtsc
 = 
	`»adl
(&
ehci_»gs
->
pÜt_¡©us
[
pÜt
-1]);

517 } (
pÜtsc
 & 
PORT_RESET
è&& (--
loİ
 > 0));

521 ià(!(
pÜtsc
 & 
PORT_CONNECT
))

522  -
ENOTCONN
;

525 ià((
pÜtsc
 & 
PORT_CSC
))

526  -
EINVAL
;

529 ià(!(
pÜtsc
 & 
PORT_RESET
è&& (pÜtsø& 
PORT_PE
))

532  -
EBUSY
;

533 
	}
}

535 
__š™
 
	$ehci_wa™_fÜ_pÜt
(
pÜt
)

537 
u32
 
¡©us
;

538 
»t
, 
»ps
;

540 
»ps
 = 0;„eps < 3;„eps++) {

541 
	`dbgp_md–ay
(100);

542 
¡©us
 = 
	`»adl
(&
ehci_»gs
->status);

543 ià(
¡©us
 & 
STS_PCD
) {

544 
»t
 = 
	`ehci_»£t_pÜt
(
pÜt
);

545 ià(
»t
 == 0)

549  -
ENOTCONN
;

550 
	}
}

552 #ifdeà
DBGP_DEBUG


553 
	#dbgp_´štk
 
—¾y_´štk


	)

555 
šlše
 
	$dbgp_´štk
(cÚ¡ *
fmt
, ...è{ 
	}
}

558 (*
	t£t_debug_pÜt_t
)(
	tpÜt
);

560 
__š™
 
	$deçuÉ_£t_debug_pÜt
(
pÜt
)

562 
	}
}

564 
£t_debug_pÜt_t
 
__š™d©a
 
	g£t_debug_pÜt
 = 
deçuÉ_£t_debug_pÜt
;

566 
__š™
 
	$nvidŸ_£t_debug_pÜt
(
pÜt
)

568 
u32
 
dwÜd
;

569 
dwÜd
 = 
	`»ad_pci_cÚfig
(
ehci_dev
.
bus
,ƒhci_dev.
¦Ù
,ƒhci_dev.
func
,

571 
dwÜd
 &= ~(0x0f<<12);

572 
dwÜd
 |ğ((
pÜt
 & 0x0f)<<12);

573 
	`wr™e_pci_cÚfig
(
ehci_dev
.
bus
,ƒhci_dev.
¦Ù
,ƒhci_dev.
func
, 0x74,

574 
dwÜd
);

575 
	`dbgp_´štk
("£ˆdebug…ÜˆtØ%d\n", 
pÜt
);

576 
	}
}

578 
__š™
 
	$d‘eù_£t_debug_pÜt
()

580 
u32
 
v’dÜid
;

582 
v’dÜid
 = 
	`»ad_pci_cÚfig
(
ehci_dev
.
bus
,ƒhci_dev.
¦Ù
,ƒhci_dev.
func
,

585 ià((
v’dÜid
 & 0xffff) == 0x10de) {

586 
	`dbgp_´štk
("using‚vidia set_debug_port\n");

587 
£t_debug_pÜt
 = 
nvidŸ_£t_debug_pÜt
;

589 
	}
}

591 
__š™
 
	$ehci_£tup
()

593 
usb_debug_desütÜ
 
dbgp_desc
;

594 
u32
 
cmd
, 
ù¾
, 
¡©us
, 
pÜtsc
, 
hcs_·¿ms
;

595 
u32
 
debug_pÜt
, 
Ãw_debug_pÜt
 = 0, 
n_pÜts
;

596 
u32
 
devnum
;

597 
»t
, 
i
;

598 
loİ
;

599 
pÜt_m­_Œ›d
;

600 
¶aytimes
 = 3;

602 
Œy_Ãxt_time
:

603 
pÜt_m­_Œ›d
 = 0;

605 
Œy_Ãxt_pÜt
:

607 
hcs_·¿ms
 = 
	`»adl
(&
ehci_ÿps
->hcs_params);

608 
debug_pÜt
 = 
	`HCS_DEBUG_PORT
(
hcs_·¿ms
);

609 
n_pÜts
 = 
	`HCS_N_PORTS
(
hcs_·¿ms
);

611 
	`dbgp_´štk
("debug_pÜt: %d\n", 
debug_pÜt
);

612 
	`dbgp_´štk
("n_pÜts: %d\n", 
n_pÜts
);

614 
i
 = 1; i <ğ
n_pÜts
; i++) {

615 
pÜtsc
 = 
	`»adl
(&
ehci_»gs
->
pÜt_¡©us
[
i
-1]);

616 
	`dbgp_´štk
("pÜt¡©us%d: %08x\n", 
i
, 
pÜtsc
);

619 ià(
pÜt_m­_Œ›d
 && (
Ãw_debug_pÜt
 !ğ
debug_pÜt
)) {

620 ià(--
¶aytimes
) {

621 
	`£t_debug_pÜt
(
Ãw_debug_pÜt
);

622 
Œy_Ãxt_time
;

627 
loİ
 = 10;

629 
cmd
 = 
	`»adl
(&
ehci_»gs
->
commªd
);

630 
cmd
 |ğ
CMD_RESET
;

631 
	`wr™–
(
cmd
, &
ehci_»gs
->
commªd
);

633 
cmd
 = 
	`»adl
(&
ehci_»gs
->
commªd
);

634 } (
cmd
 & 
CMD_RESET
è&& (--
loİ
 > 0));

636 ià(!
loİ
) {

637 
	`dbgp_´štk
("can‚ot„esetƒhci\n");

640 
	`dbgp_´štk
("ehci„eset done\n");

643 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

644 
ù¾
 |ğ
DBGP_OWNER
;

645 
ù¾
 &ğ~(
DBGP_ENABLED
 | 
DBGP_INUSE
);

646 
	`wr™–
(
ù¾
, &
ehci_debug
->
cÚŒŞ
);

649 
cmd
 = 
	`»adl
(&
ehci_»gs
->
commªd
);

650 
cmd
 &ğ~(
CMD_LRESET
 | 
CMD_IAAD
 | 
CMD_PSE
 | 
CMD_ASE
 | 
CMD_RESET
);

651 
cmd
 |ğ
CMD_RUN
;

652 
	`wr™–
(
cmd
, &
ehci_»gs
->
commªd
);

655 
	`wr™–
(
FLAG_CF
, &
ehci_»gs
->
cÚfigu»d_æag
);

658 
loİ
 = 10;

660 
¡©us
 = 
	`»adl
(&
ehci_»gs
->status);

661 } (
¡©us
 & 
STS_HALT
è&& (--
loİ
 > 0));

663 ià(!
loİ
) {

664 
	`dbgp_´štk
("ehci can be started\n");

667 
	`dbgp_´štk
("ehci started\n");

670 
»t
 = 
	`ehci_wa™_fÜ_pÜt
(
debug_pÜt
);

671 ià(
»t
 < 0) {

672 
	`dbgp_´štk
("No device found in debug…ort\n");

673 
Ãxt_debug_pÜt
;

675 
	`dbgp_´štk
("ehci wait for…ort done\n");

678 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

679 
ù¾
 |ğ
DBGP_CLAIM
;

680 
	`wr™–
(
ù¾
, &
ehci_debug
->
cÚŒŞ
);

681 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

682 ià((
ù¾
 & 
DBGP_CLAIM
) != DBGP_CLAIM) {

683 
	`dbgp_´štk
("No device in debug…ort\n");

684 
	`wr™–
(
ù¾
 & ~
DBGP_CLAIM
, &
ehci_debug
->
cÚŒŞ
);

685 
”r
;

687 
	`dbgp_´štk
("debug…ortedƒnabled\n");

690 
pÜtsc
 = 
	`»adl
(&
ehci_»gs
->
pÜt_¡©us
[
debug_pÜt
 - 1]);

691 
pÜtsc
 &ğ~
PORT_PE
;

692 
	`wr™–
(
pÜtsc
, &
ehci_»gs
->
pÜt_¡©us
[
debug_pÜt
 - 1]);

694 
	`dbgp_md–ay
(100);

697 
devnum
 = 0; devnum <= 127; devnum++) {

698 
»t
 = 
	`dbgp_cÚŒŞ_msg
(
devnum
,

699 
USB_DIR_IN
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

700 
USB_REQ_GET_DESCRIPTOR
, (
USB_DT_DEBUG
 << 8), 0,

701 &
dbgp_desc
, (dbgp_desc));

702 ià(
»t
 > 0)

705 ià(
devnum
 > 127) {

706 
	`dbgp_´štk
("Could‚ot find‡ttached debug device\n");

707 
”r
;

709 ià(
»t
 < 0) {

710 
	`dbgp_´štk
("Attached device is‚ot‡ debug device\n");

711 
”r
;

713 
dbgp_’dpošt_out
 = 
dbgp_desc
.
bDebugOutEndpošt
;

716 ià(
devnum
 !ğ
USB_DEBUG_DEVNUM
) {

717 
»t
 = 
	`dbgp_cÚŒŞ_msg
(
devnum
,

718 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

719 
USB_REQ_SET_ADDRESS
, 
USB_DEBUG_DEVNUM
, 0, 
NULL
, 0);

720 ià(
»t
 < 0) {

721 
	`dbgp_´štk
("Could‚ot move‡ttached deviceo %d\n",

722 
USB_DEBUG_DEVNUM
);

723 
”r
;

725 
devnum
 = 
USB_DEBUG_DEVNUM
;

726 
	`dbgp_´štk
("debug device„enamedo 127\n");

730 
»t
 = 
	`dbgp_cÚŒŞ_msg
(
USB_DEBUG_DEVNUM
,

731 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

732 
USB_REQ_SET_FEATURE
, 
USB_DEVICE_DEBUG_MODE
, 0, 
NULL
, 0);

733 ià(
»t
 < 0) {

734 
	`dbgp_´štk
(" Could‚otƒnablehe debug device\n");

735 
”r
;

737 
	`dbgp_´štk
("debug interfaceƒnabled\n");

741 
»t
 = 
	`dbgp_bulk_wr™e
(
USB_DEBUG_DEVNUM
, 
dbgp_’dpošt_out
, " ", 1);

742 ià(
»t
 < 0) {

743 
	`dbgp_´štk
("dbgp_bulk_wr™çed: %d\n", 
»t
);

744 
”r
;

746 
	`dbgp_´štk
("small write doned\n");

749 
”r
:

751 
ù¾
 = 
	`»adl
(&
ehci_debug
->
cÚŒŞ
);

752 
ù¾
 &ğ~(
DBGP_CLAIM
 | 
DBGP_OUT
);

753 
	`wr™–
(
ù¾
, &
ehci_debug
->
cÚŒŞ
);

756 
Ãxt_debug_pÜt
:

757 
pÜt_m­_Œ›d
 |ğ(1<<(
debug_pÜt
 - 1));

758 
Ãw_debug_pÜt
 = ((
debug_pÜt
-1+1)%
n_pÜts
) + 1;

759 ià(
pÜt_m­_Œ›d
 !ğ((1<<
n_pÜts
) - 1)) {

760 
	`£t_debug_pÜt
(
Ãw_debug_pÜt
);

761 
Œy_Ãxt_pÜt
;

763 ià(--
¶aytimes
) {

764 
	`£t_debug_pÜt
(
Ãw_debug_pÜt
);

765 
Œy_Ãxt_time
;

769 
	}
}

771 
__š™
 
	$—¾y_dbgp_š™
(*
s
)

773 
u32
 
debug_pÜt
, 
b¬
, 
off£t
;

774 
u32
 
bus
, 
¦Ù
, 
func
, 
ÿp
;

775 
__iomem
 *
ehci_b¬
;

776 
u32
 
dbgp_num
;

777 
u32
 
b¬_v®
;

778 *
e
;

779 
»t
;

780 
u8
 
by‹
;

782 ià(!
	`—¾y_pci_®lowed
())

785 
dbgp_num
 = 0;

786 ià(*
s
)

787 
dbgp_num
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 10);

788 
	`dbgp_´štk
("dbgp_num: %d\n", 
dbgp_num
);

790 
ÿp
 = 
	`fšd_dbgp
(
dbgp_num
, &
bus
, &
¦Ù
, &
func
);

791 ià(!
ÿp
)

794 
	`dbgp_´štk
("Found EHCI debug…ÜˆÚ %02x:%02x.%1x\n", 
bus
, 
¦Ù
,

795 
func
);

797 
debug_pÜt
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
, 
ÿp
);

798 
b¬
 = (
debug_pÜt
 >> 29) & 0x7;

799 
b¬
 = (bar * 4) + 0xc;

800 
off£t
 = (
debug_pÜt
 >> 16) & 0xfff;

801 
	`dbgp_´štk
("b¬: %02x off£t: %03x\n", 
b¬
, 
off£t
);

802 ià(
b¬
 !ğ
PCI_BASE_ADDRESS_0
) {

803 
	`dbgp_´štk
("only debug…orts on bar 1 handled.\n");

808 
b¬_v®
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 
func
, 
PCI_BASE_ADDRESS_0
);

809 
	`dbgp_´štk
("b¬_v®: %02x off£t: %03x\n", 
b¬_v®
, 
off£t
);

810 ià(
b¬_v®
 & ~
PCI_BASE_ADDRESS_MEM_MASK
) {

811 
	`dbgp_´štk
("only simple 32bit mmio bars supported\n");

817 
by‹
 = 
	`»ad_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
, 0x04);

818 ià(!(
by‹
 & 0x2)) {

819 
by‹
 |= 0x02;

820 
	`wr™e_pci_cÚfig_by‹
(
bus
, 
¦Ù
, 
func
, 0x04, 
by‹
);

821 
	`dbgp_´štk
("mmio forƒhciƒnabled\n");

828 
	`£t_fixm­_noÿche
(
FIX_DBGP_BASE
, 
b¬_v®
 & 
PAGE_MASK
);

829 
ehci_b¬
 = (
__iomem
 *)
	`__fix_to_vœt
(
FIX_DBGP_BASE
);

830 
ehci_b¬
 +ğ
b¬_v®
 & ~
PAGE_MASK
;

831 
	`dbgp_´štk
("ehci_b¬: %p\n", 
ehci_b¬
);

833 
ehci_ÿps
 = 
ehci_b¬
;

834 
ehci_»gs
 = 
ehci_b¬
 + 
	`HC_LENGTH
(
	`»adl
(&
ehci_ÿps
->
hc_ÿpba£
));

835 
ehci_debug
 = 
ehci_b¬
 + 
off£t
;

836 
ehci_dev
.
bus
 = bus;

837 
ehci_dev
.
¦Ù
 = slot;

838 
ehci_dev
.
func
 = func;

840 
	`d‘eù_£t_debug_pÜt
();

842 
»t
 = 
	`ehci_£tup
();

843 ià(
»t
 < 0) {

844 
	`dbgp_´štk
("ehci_setup failed\n");

845 
ehci_debug
 = 
NULL
;

851 
	}
}

853 
	$—¾y_dbgp_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
¡r
, 
u32
 
n
)

855 
chunk
, 
»t
;

857 ià(!
ehci_debug
)

859 
n
 > 0) {

860 
chunk
 = 
n
;

861 ià(
chunk
 > 
DBGP_MAX_PACKET
)

862 
chunk
 = 
DBGP_MAX_PACKET
;

863 
»t
 = 
	`dbgp_bulk_wr™e
(
USB_DEBUG_DEVNUM
,

864 
dbgp_’dpošt_out
, 
¡r
, 
chunk
);

865 
¡r
 +ğ
chunk
;

866 
n
 -ğ
chunk
;

868 
	}
}

870 
cÚsŞe
 
	g—¾y_dbgp_cÚsŞe
 = {

871 .
Çme
 = "earlydbg",

872 .
	gwr™e
 = 
—¾y_dbgp_wr™e
,

873 .
	gæags
 = 
CON_PRINTBUFFER
,

874 .
	gšdex
 = -1,

879 
cÚsŞe
 *
	g—¾y_cÚsŞe
 = &
—¾y_vga_cÚsŞe
;

880 
__š™d©a
 
	g—¾y_cÚsŞe_š™Ÿlized
;

882 
asmlškage
 
	$—¾y_´štk
(cÚ¡ *
fmt
, ...)

884 
buf
[512];

885 
n
;

886 
va_li¡
 
­
;

888 
	`va_¡¬t
(
­
, 
fmt
);

889 
n
 = 
	`vsú´štf
(
buf
, (buf), 
fmt
, 
­
);

890 
—¾y_cÚsŞe
->
	`wr™e
Ó¬ly_cÚsŞe, 
buf
, 
n
);

891 
	`va_’d
(
­
);

892 
	}
}

895 
__š™
 
	$£tup_—¾y_´štk
(*
buf
)

897 
k“p_—¾y
;

899 ià(!
buf
)

902 ià(
—¾y_cÚsŞe_š™Ÿlized
)

904 
—¾y_cÚsŞe_š™Ÿlized
 = 1;

906 
k“p_—¾y
 = (
	`¡r¡r
(
buf
, "k“p"è!ğ
NULL
);

908 ià(!
	`¡ºcmp
(
buf
, "serial", 6)) {

909 
	`—¾y_£rŸl_š™
(
buf
 + 6);

910 
—¾y_cÚsŞe
 = &
—¾y_£rŸl_cÚsŞe
;

911 } ià(!
	`¡ºcmp
(
buf
, "ttyS", 4)) {

912 
	`—¾y_£rŸl_š™
(
buf
);

913 
—¾y_cÚsŞe
 = &
—¾y_£rŸl_cÚsŞe
;

914 } ià(!
	`¡ºcmp
(
buf
, "vga", 3)

915 && 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_isVGA
 == 1) {

916 
max_xpos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_cŞs
;

917 
max_ypos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_lšes
;

918 
cu¼’t_ypos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_y
;

919 
—¾y_cÚsŞe
 = &
—¾y_vga_cÚsŞe
;

920 #ifdeà
CONFIG_EARLY_PRINTK_DBGP


921 } ià(!
	`¡ºcmp
(
buf
, "dbgp", 4)) {

922 ià(
	`—¾y_dbgp_š™
(
buf
+4) < 0)

924 
—¾y_cÚsŞe
 = &
—¾y_dbgp_cÚsŞe
;

929 
k“p_—¾y
 = 0;

931 #ifdeà
CONFIG_HVC_XEN


932 } ià(!
	`¡ºcmp
(
buf
, "xen", 3)) {

933 
—¾y_cÚsŞe
 = &
x’boÙ_cÚsŞe
;

937 ià(
k“p_—¾y
)

938 
—¾y_cÚsŞe
->
æags
 &ğ~
CON_BOOT
;

940 
—¾y_cÚsŞe
->
æags
 |ğ
CON_BOOT
;

941 
	`»gi¡”_cÚsŞe
(
—¾y_cÚsŞe
);

943 
	}
}

945 
—¾y_·¿m
("—¾y´štk", 
£tup_—¾y_´štk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<lšux/k”Ãl.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/efi.h
>

32 
	~<lšux/boÙmem.h
>

33 
	~<lšux/¥šlock.h
>

34 
	~<lšux/uacûss.h
>

35 
	~<lšux/time.h
>

36 
	~<lšux/io.h
>

37 
	~<lšux/»boÙ.h
>

38 
	~<lšux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ÿcheæush.h
>

44 
	~<asm/bæush.h
>

46 
	#EFI_DEBUG
 1

	)

47 
	#PFX
 "EFI: "

	)

49 
	gefi_’abËd
;

50 
EXPORT_SYMBOL
(
efi_’abËd
);

52 
efi
 
	gefi
;

53 
EXPORT_SYMBOL
(
efi
);

55 
efi_memÜy_m­
 
	gmemm­
;

57 
efi
 
efi_phys
 
	g__š™d©a
;

58 
efi_sy¡em_bË_t
 
efi_sy¡ab
 
	g__š™d©a
;

60 
__š™
 
	$£tup_nÛfi
(*
¬g
)

62 
efi_’abËd
 = 0;

64 
	}
}

65 
—¾y_·¿m
("nÛfi", 
£tup_nÛfi
);

67 
	gadd_efi_memm­
;

68 
EXPORT_SYMBOL
(
add_efi_memm­
);

70 
__š™
 
	$£tup_add_efi_memm­
(*
¬g
)

72 
add_efi_memm­
 = 1;

74 
	}
}

75 
—¾y_·¿m
("add_efi_memm­", 
£tup_add_efi_memm­
);

78 
efi_¡©us_t
 
	$vœt_efi_g‘_time
(
efi_time_t
 *
tm
, 
efi_time_ÿp_t
 *
tc
)

80  
	`efi_ÿÎ_vœt2
(
g‘_time
, 
tm
, 
tc
);

81 
	}
}

83 
efi_¡©us_t
 
	$vœt_efi_£t_time
(
efi_time_t
 *
tm
)

85  
	`efi_ÿÎ_vœt1
(
£t_time
, 
tm
);

86 
	}
}

88 
efi_¡©us_t
 
	$vœt_efi_g‘_wakeup_time
(
efi_boŞ_t
 *
’abËd
,

89 
efi_boŞ_t
 *
³ndšg
,

90 
efi_time_t
 *
tm
)

92  
	`efi_ÿÎ_vœt3
(
g‘_wakeup_time
,

93 
’abËd
, 
³ndšg
, 
tm
);

94 
	}
}

96 
efi_¡©us_t
 
	$vœt_efi_£t_wakeup_time
(
efi_boŞ_t
 
’abËd
, 
efi_time_t
 *
tm
)

98  
	`efi_ÿÎ_vœt2
(
£t_wakeup_time
,

99 
’abËd
, 
tm
);

100 
	}
}

102 
efi_¡©us_t
 
	$vœt_efi_g‘_v¬ŸbË
(
efi_ch¬16_t
 *
Çme
,

103 
efi_guid_t
 *
v’dÜ
,

104 
u32
 *
©Œ
,

105 *
d©a_size
,

106 *
d©a
)

108  
	`efi_ÿÎ_vœt5
(
g‘_v¬ŸbË
,

109 
Çme
, 
v’dÜ
, 
©Œ
,

110 
d©a_size
, 
d©a
);

111 
	}
}

113 
efi_¡©us_t
 
	$vœt_efi_g‘_Ãxt_v¬ŸbË
(*
Çme_size
,

114 
efi_ch¬16_t
 *
Çme
,

115 
efi_guid_t
 *
v’dÜ
)

117  
	`efi_ÿÎ_vœt3
(
g‘_Ãxt_v¬ŸbË
,

118 
Çme_size
, 
Çme
, 
v’dÜ
);

119 
	}
}

121 
efi_¡©us_t
 
	$vœt_efi_£t_v¬ŸbË
(
efi_ch¬16_t
 *
Çme
,

122 
efi_guid_t
 *
v’dÜ
,

123 
©Œ
,

124 
d©a_size
,

125 *
d©a
)

127  
	`efi_ÿÎ_vœt5
(
£t_v¬ŸbË
,

128 
Çme
, 
v’dÜ
, 
©Œ
,

129 
d©a_size
, 
d©a
);

130 
	}
}

132 
efi_¡©us_t
 
	$vœt_efi_g‘_Ãxt_high_mÚo_couÁ
(
u32
 *
couÁ
)

134  
	`efi_ÿÎ_vœt1
(
g‘_Ãxt_high_mÚo_couÁ
, 
couÁ
);

135 
	}
}

137 
	$vœt_efi_»£t_sy¡em
(
»£t_ty³
,

138 
efi_¡©us_t
 
¡©us
,

139 
d©a_size
,

140 
efi_ch¬16_t
 *
d©a
)

142 
	`efi_ÿÎ_vœt4
(
»£t_sy¡em
, 
»£t_ty³
, 
¡©us
,

143 
d©a_size
, 
d©a
);

144 
	}
}

146 
efi_¡©us_t
 
	$vœt_efi_£t_vœtu®_add»ss_m­
(

147 
memÜy_m­_size
,

148 
desütÜ_size
,

149 
u32
 
desütÜ_v”siÚ
,

150 
efi_memÜy_desc_t
 *
vœtu®_m­
)

152  
	`efi_ÿÎ_vœt4
(
£t_vœtu®_add»ss_m­
,

153 
memÜy_m­_size
, 
desütÜ_size
,

154 
desütÜ_v”siÚ
, 
vœtu®_m­
);

155 
	}
}

157 
efi_¡©us_t
 
__š™
 
	$phys_efi_£t_vœtu®_add»ss_m­
(

158 
memÜy_m­_size
,

159 
desütÜ_size
,

160 
u32
 
desütÜ_v”siÚ
,

161 
efi_memÜy_desc_t
 *
vœtu®_m­
)

163 
efi_¡©us_t
 
¡©us
;

165 
	`efi_ÿÎ_phys_´–og
();

166 
¡©us
 = 
	`efi_ÿÎ_phys4
(
efi_phys
.
£t_vœtu®_add»ss_m­
,

167 
memÜy_m­_size
, 
desütÜ_size
,

168 
desütÜ_v”siÚ
, 
vœtu®_m­
);

169 
	`efi_ÿÎ_phys_•og
();

170  
¡©us
;

171 
	}
}

173 
efi_¡©us_t
 
__š™
 
	$phys_efi_g‘_time
(
efi_time_t
 *
tm
,

174 
efi_time_ÿp_t
 *
tc
)

176 
efi_¡©us_t
 
¡©us
;

178 
	`efi_ÿÎ_phys_´–og
();

179 
¡©us
 = 
	`efi_ÿÎ_phys2
(
efi_phys
.
g‘_time
, 
tm
, 
tc
);

180 
	`efi_ÿÎ_phys_•og
();

181  
¡©us
;

182 
	}
}

184 
	$efi_£t_¹c_mmss
(
nowtime
)

186 
»®_£cÚds
, 
»®_mšu‹s
;

187 
efi_¡©us_t
 
¡©us
;

188 
efi_time_t
 
eá
;

189 
efi_time_ÿp_t
 
ÿp
;

191 
¡©us
 = 
efi
.
	`g‘_time
(&
eá
, &
ÿp
);

192 ià(
¡©us
 !ğ
EFI_SUCCESS
) {

193 
	`´štk
(
KERN_ERR
 "Oops:ƒfitime: can't„eadime!\n");

197 
»®_£cÚds
 = 
nowtime
 % 60;

198 
»®_mšu‹s
 = 
nowtime
 / 60;

199 ià(((
	`abs
(
»®_mšu‹s
 - 
eá
.
mšu‹
) + 15)/30) & 1)

200 
»®_mšu‹s
 += 30;

201 
»®_mšu‹s
 %= 60;

202 
eá
.
mšu‹
 = 
»®_mšu‹s
;

203 
eá
.
£cÚd
 = 
»®_£cÚds
;

205 
¡©us
 = 
efi
.
	`£t_time
(&
eá
);

206 ià(
¡©us
 !ğ
EFI_SUCCESS
) {

207 
	`´štk
(
KERN_ERR
 "Oops:ƒfitime: can't writeime!\n");

211 
	}
}

213 
	$efi_g‘_time
()

215 
efi_¡©us_t
 
¡©us
;

216 
efi_time_t
 
eá
;

217 
efi_time_ÿp_t
 
ÿp
;

219 
¡©us
 = 
efi
.
	`g‘_time
(&
eá
, &
ÿp
);

220 ià(
¡©us
 !ğ
EFI_SUCCESS
)

221 
	`´štk
(
KERN_ERR
 "Oops:ƒfitime: can't„eadime!\n");

223  
	`mktime
(
eá
.
y—r
,ƒá.
mÚth
,ƒá.
day
,ƒá.
hour
,

224 
eá
.
mšu‹
,ƒá.
£cÚd
);

225 
	}
}

233 
__š™
 
	$do_add_efi_memm­
()

235 *
p
;

237 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

238 
efi_memÜy_desc_t
 *
md
 = 
p
;

239 
¡¬t
 = 
md
->
phys_addr
;

240 
size
 = 
md
->
num_·ges
 << 
EFI_PAGE_SHIFT
;

241 
e820_ty³
;

243 ià(
md
->
©Œibu‹
 & 
EFI_MEMORY_WB
)

244 
e820_ty³
 = 
E820_RAM
;

246 
e820_ty³
 = 
E820_RESERVED
;

247 
	`e820_add_»giÚ
(
¡¬t
, 
size
, 
e820_ty³
);

249 
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &e820.
Ä_m­
);

250 
	}
}

252 
__š™
 
	$efi_»£rve_—¾y
()

254 
pm­
;

256 #ifdeà
CONFIG_X86_32


257 
pm­
 = 
boÙ_·¿ms
.
efi_šfo
.
efi_memm­
;

259 
pm­
 = (
boÙ_·¿ms
.
efi_šfo
.
efi_memm­
 |

260 ((
__u64
)
boÙ_·¿ms
.
efi_šfo
.
efi_memm­_hi
<<32));

262 
memm­
.
phys_m­
 = (*)
pm­
;

263 
memm­
.
Ä_m­
 = 
boÙ_·¿ms
.
efi_šfo
.
efi_memm­_size
 /

264 
boÙ_·¿ms
.
efi_šfo
.
efi_memdesc_size
;

265 
memm­
.
desc_v”siÚ
 = 
boÙ_·¿ms
.
efi_šfo
.
efi_memdesc_v”siÚ
;

266 
memm­
.
desc_size
 = 
boÙ_·¿ms
.
efi_šfo
.
efi_memdesc_size
;

267 
	`»£rve_—¾y
(
pm­
,…m­ + 
memm­
.
Ä_m­
 * memm­.
desc_size
,

269 
	}
}

271 #ià
EFI_DEBUG


272 
__š™
 
	$´št_efi_memm­
()

274 
efi_memÜy_desc_t
 *
md
;

275 *
p
;

276 
i
;

278 
p
 = 
memm­
.
m­
, 
i
 = 0;

279 
p
 < 
memm­
.
m­_’d
;

280 
p
 +ğ
memm­
.
desc_size
, 
i
++) {

281 
md
 = 
p
;

282 
	`´štk
(
KERN_INFO
 
PFX
 "mem%02u:ype=%u,‡ttr=0x%llx, "

284 
i
, 
md
->
ty³
, md->
©Œibu‹
, md->
phys_addr
,

285 
md
->
phys_addr
 + (md->
num_·ges
 << 
EFI_PAGE_SHIFT
),

286 (
md
->
num_·ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

288 
	}
}

291 
__š™
 
	$efi_š™
()

293 
efi_cÚfig_bË_t
 *
cÚfig_bËs
;

294 
efi_ruÁime_£rviûs_t
 *
ruÁime
;

295 
efi_ch¬16_t
 *
c16
;

296 
v’dÜ
[100] = "unknown";

297 
i
 = 0;

298 *
tmp
;

300 #ifdeà
CONFIG_X86_32


301 
efi_phys
.
sy¡ab
 = (
efi_sy¡em_bË_t
 *)
boÙ_·¿ms
.
efi_šfo
.
efi_sy¡ab
;

303 
efi_phys
.
sy¡ab
 = (
efi_sy¡em_bË_t
 *)

304 (
boÙ_·¿ms
.
efi_šfo
.
efi_sy¡ab
 |

305 ((
__u64
)
boÙ_·¿ms
.
efi_šfo
.
efi_sy¡ab_hi
<<32));

308 
efi
.
sy¡ab
 = 
	`—¾y_iÜem­
(()
efi_phys
.systab,

309 (
efi_sy¡em_bË_t
));

310 ià(
efi
.
sy¡ab
 =ğ
NULL
)

311 
	`´štk
(
KERN_ERR
 "Couldn't maphe EFI systemable!\n");

312 
	`memıy
(&
efi_sy¡ab
, 
efi
.
sy¡ab
, (
efi_sy¡em_bË_t
));

313 
	`—¾y_iounm­
(
efi
.
sy¡ab
, (
efi_sy¡em_bË_t
));

314 
efi
.
sy¡ab
 = &
efi_sy¡ab
;

319 ià(
efi
.
sy¡ab
->
hdr
.
sigÇtu»
 !ğ
EFI_SYSTEM_TABLE_SIGNATURE
)

320 
	`´štk
(
KERN_ERR
 "EFI systemable signature incorrect!\n");

321 ià((
efi
.
sy¡ab
->
hdr
.
»visiÚ
 >> 16) == 0)

322 
	`´štk
(
KERN_ERR
 "Warning: EFI systemable version "

324 
efi
.
sy¡ab
->
hdr
.
»visiÚ
 >> 16,

325 
efi
.
sy¡ab
->
hdr
.
»visiÚ
 & 0xffff);

330 
c16
 = 
tmp
 = 
	`—¾y_iÜem­
(
efi
.
sy¡ab
->
fw_v’dÜ
, 2);

331 ià(
c16
) {

332 
i
 = 0; i < (
v’dÜ
è&& *
c16
; ++i)

333 
v’dÜ
[
i
] = *
c16
++;

334 
v’dÜ
[
i
] = '\0';

336 
	`´štk
(
KERN_ERR
 
PFX
 "Could‚ot maphe firmware vendor!\n");

337 
	`—¾y_iounm­
(
tmp
, 2);

339 
	`´štk
(
KERN_INFO
 "EFI v%u.%.02u by %s \n",

340 
efi
.
sy¡ab
->
hdr
.
»visiÚ
 >> 16,

341 
efi
.
sy¡ab
->
hdr
.
»visiÚ
 & 0xffff, 
v’dÜ
);

346 
cÚfig_bËs
 = 
	`—¾y_iÜem­
(

347 
efi
.
sy¡ab
->
bËs
,

348 
efi
.
sy¡ab
->
Ä_bËs
 * (
efi_cÚfig_bË_t
));

349 ià(
cÚfig_bËs
 =ğ
NULL
)

350 
	`´štk
(
KERN_ERR
 "Could‚ot map EFI Configuration Table!\n");

352 
	`´štk
(
KERN_INFO
);

353 
i
 = 0; i < 
efi
.
sy¡ab
->
Ä_bËs
; i++) {

354 ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

355 
efi
.
mps
 = 
cÚfig_bËs
[
i
].
bË
;

356 
	`´štk
(" MPS=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

357 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

358 
ACPI_20_TABLE_GUID
)) {

359 
efi
.
aıi20
 = 
cÚfig_bËs
[
i
].
bË
;

360 
	`´štk
(" ACPI 2.0=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

361 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

362 
ACPI_TABLE_GUID
)) {

363 
efi
.
aıi
 = 
cÚfig_bËs
[
i
].
bË
;

364 
	`´štk
(" ACPI=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

365 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

366 
SMBIOS_TABLE_GUID
)) {

367 
efi
.
smbios
 = 
cÚfig_bËs
[
i
].
bË
;

368 
	`´štk
(" SMBIOS=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

369 #ifdeà
CONFIG_X86_UV


370 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

371 
UV_SYSTEM_TABLE_GUID
)) {

372 
efi
.
uv_sy¡ab
 = 
cÚfig_bËs
[
i
].
bË
;

373 
	`´štk
(" UVsy¡ab=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

375 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

376 
HCDP_TABLE_GUID
)) {

377 
efi
.
hcdp
 = 
cÚfig_bËs
[
i
].
bË
;

378 
	`´štk
(" HCDP=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

379 } ià(!
	`efi_guidcmp
(
cÚfig_bËs
[
i
].
guid
,

380 
UGA_IO_PROTOCOL_GUID
)) {

381 
efi
.
uga
 = 
cÚfig_bËs
[
i
].
bË
;

382 
	`´štk
(" UGA=0x%lx ", 
cÚfig_bËs
[
i
].
bË
);

385 
	`´štk
("\n");

386 
	`—¾y_iounm­
(
cÚfig_bËs
,

387 
efi
.
sy¡ab
->
Ä_bËs
 * (
efi_cÚfig_bË_t
));

395 
ruÁime
 = 
	`—¾y_iÜem­
(()
efi
.
sy¡ab
->runtime,

396 (
efi_ruÁime_£rviûs_t
));

397 ià(
ruÁime
 !ğ
NULL
) {

403 
efi_phys
.
g‘_time
 = (
efi_g‘_time_t
 *)
ruÁime
->get_time;

404 
efi_phys
.
£t_vœtu®_add»ss_m­
 =

405 (
efi_£t_vœtu®_add»ss_m­_t
 *)

406 
ruÁime
->
£t_vœtu®_add»ss_m­
;

411 
efi
.
g‘_time
 = 
phys_efi_g‘_time
;

413 
	`´štk
(
KERN_ERR
 "Could‚ot maphe EFI„untime service "

415 
	`—¾y_iounm­
(
ruÁime
, (
efi_ruÁime_£rviûs_t
));

418 
memm­
.
m­
 = 
	`—¾y_iÜem­
(()memm­.
phys_m­
,

419 
memm­
.
Ä_m­
 * memm­.
desc_size
);

420 ià(
memm­
.
m­
 =ğ
NULL
)

421 
	`´štk
(
KERN_ERR
 "Could‚ot maphe EFI memory map!\n");

422 
memm­
.
m­_’d
 = memm­.
m­
 + (memm­.
Ä_m­
 * memm­.
desc_size
);

424 ià(
memm­
.
desc_size
 !ğ(
efi_memÜy_desc_t
))

425 
	`´štk
(
KERN_WARNING


428 ià(
add_efi_memm­
)

429 
	`do_add_efi_memm­
();

432 
»boÙ_ty³
 = 
BOOT_EFI
;

434 #ià
EFI_DEBUG


435 
	`´št_efi_memm­
();

437 
	}
}

439 
__š™
 
	$ruÁime_code_·ge_mkexec
()

441 
efi_memÜy_desc_t
 *
md
;

442 *
p
;

443 
u64
 
addr
, 
Åages
;

446 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

447 
md
 = 
p
;

449 ià(
md
->
ty³
 !ğ
EFI_RUNTIME_SERVICES_CODE
)

452 
addr
 = 
md
->
vœt_addr
;

453 
Åages
 = 
md
->
num_·ges
;

454 
	`mem¿nge_efi_to_Çtive
(&
addr
, &
Åages
);

455 
	`£t_memÜy_x
(
addr
, 
Åages
);

457 
	}
}

467 
__š™
 
	$efi_’‹r_vœtu®_mode
()

469 
efi_memÜy_desc_t
 *
md
;

470 
efi_¡©us_t
 
¡©us
;

471 
size
;

472 
u64
 
’d
, 
sy¡ab
, 
addr
, 
Åages
, 
’d_pâ
;

473 *
p
, *
va
;

475 
efi
.
sy¡ab
 = 
NULL
;

476 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

477 
md
 = 
p
;

478 ià(!(
md
->
©Œibu‹
 & 
EFI_MEMORY_RUNTIME
))

481 
size
 = 
md
->
num_·ges
 << 
EFI_PAGE_SHIFT
;

482 
’d
 = 
md
->
phys_addr
 + 
size
;

484 
’d_pâ
 = 
	`PFN_UP
(
’d
);

485 ià(
’d_pâ
 <ğ
max_low_pâ_m­³d


486 || (
’d_pâ
 > (1UL << (32 - 
PAGE_SHIFT
))

487 && 
’d_pâ
 <ğ
max_pâ_m­³d
))

488 
va
 = 
	`__va
(
md
->
phys_addr
);

490 
va
 = 
	`efi_iÜem­
(
md
->
phys_addr
, 
size
);

492 
md
->
vœt_addr
 = (
u64
è(è
va
;

494 ià(!
va
) {

495 
	`´štk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

496 ()
md
->
phys_addr
);

500 ià(!(
md
->
©Œibu‹
 & 
EFI_MEMORY_WB
)) {

501 
addr
 = 
md
->
vœt_addr
;

502 
Åages
 = 
md
->
num_·ges
;

503 
	`mem¿nge_efi_to_Çtive
(&
addr
, &
Åages
);

504 
	`£t_memÜy_uc
(
addr
, 
Åages
);

507 
sy¡ab
 = (
u64
è(è
efi_phys
.systab;

508 ià(
md
->
phys_addr
 <ğ
sy¡ab
 && sy¡ab < 
’d
) {

509 
sy¡ab
 +ğ
md
->
vœt_addr
 - md->
phys_addr
;

510 
efi
.
sy¡ab
 = (
efi_sy¡em_bË_t
 *) () systab;

514 
	`BUG_ON
(!
efi
.
sy¡ab
);

516 
¡©us
 = 
	`phys_efi_£t_vœtu®_add»ss_m­
(

517 
memm­
.
desc_size
 * memm­.
Ä_m­
,

518 
memm­
.
desc_size
,

519 
memm­
.
desc_v”siÚ
,

520 
memm­
.
phys_m­
);

522 ià(
¡©us
 !ğ
EFI_SUCCESS
) {

523 
	`´štk
(
KERN_ALERT
 "Unableo switch EFI into virtual mode "

524 "(¡©us=%lx)!\n", 
¡©us
);

525 
	`·nic
("EFI callo SetVirtualAddressMap() failed!");

534 
efi
.
g‘_time
 = 
vœt_efi_g‘_time
;

535 
efi
.
£t_time
 = 
vœt_efi_£t_time
;

536 
efi
.
g‘_wakeup_time
 = 
vœt_efi_g‘_wakeup_time
;

537 
efi
.
£t_wakeup_time
 = 
vœt_efi_£t_wakeup_time
;

538 
efi
.
g‘_v¬ŸbË
 = 
vœt_efi_g‘_v¬ŸbË
;

539 
efi
.
g‘_Ãxt_v¬ŸbË
 = 
vœt_efi_g‘_Ãxt_v¬ŸbË
;

540 
efi
.
£t_v¬ŸbË
 = 
vœt_efi_£t_v¬ŸbË
;

541 
efi
.
g‘_Ãxt_high_mÚo_couÁ
 = 
vœt_efi_g‘_Ãxt_high_mÚo_couÁ
;

542 
efi
.
»£t_sy¡em
 = 
vœt_efi_»£t_sy¡em
;

543 
efi
.
£t_vœtu®_add»ss_m­
 = 
vœt_efi_£t_vœtu®_add»ss_m­
;

544 ià(
__suµÜ‹d_±e_mask
 & 
_PAGE_NX
)

545 
	`ruÁime_code_·ge_mkexec
();

546 
	`—¾y_iounm­
(
memm­
.
m­
, memm­.
Ä_m­
 * memm­.
desc_size
);

547 
memm­
.
m­
 = 
NULL
;

548 
	}
}

553 
u32
 
	$efi_mem_ty³
(
phys_addr
)

555 
efi_memÜy_desc_t
 *
md
;

556 *
p
;

558 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

559 
md
 = 
p
;

560 ià((
md
->
phys_addr
 <=…hys_addr) &&

561 (
phys_addr
 < (
md
->phys_addr +

562 (
md
->
num_·ges
 << 
EFI_PAGE_SHIFT
))))

563  
md
->
ty³
;

566 
	}
}

568 
u64
 
	$efi_mem_©Œibu‹s
(
phys_addr
)

570 
efi_memÜy_desc_t
 *
md
;

571 *
p
;

573 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

574 
md
 = 
p
;

575 ià((
md
->
phys_addr
 <=…hys_addr) &&

576 (
phys_addr
 < (
md
->phys_addr +

577 (
md
->
num_·ges
 << 
EFI_PAGE_SHIFT
))))

578  
md
->
©Œibu‹
;

581 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/mm.h
>

21 
	~<lšux/ty³s.h
>

22 
	~<lšux/¥šlock.h
>

23 
	~<lšux/boÙmem.h
>

24 
	~<lšux/iİÜt.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/efi.h
>

27 
	~<lšux/uacûss.h
>

28 
	~<lšux/io.h
>

29 
	~<lšux/»boÙ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/·ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgbË.h
>

35 
	~<asm/bæush.h
>

36 
	~<asm/´Ùo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ÿcheæush.h
>

39 
	~<asm/fixm­.h
>

41 
pgd_t
 
§ve_pgd
 
	g__š™d©a
;

42 
efi_æags
 
	g__š™d©a
;

44 
__š™
 
	$—¾y_m­pšg_£t_exec
(
¡¬t
,

45 
’d
,

46 
execubË
)

48 
num_·ges
;

50 
¡¬t
 &ğ
PMD_MASK
;

51 
’d
 = (’d + 
PMD_SIZE
 - 1è& 
PMD_MASK
;

52 
num_·ges
 = (
’d
 - 
¡¬t
è>> 
PAGE_SHIFT
;

53 ià(
execubË
)

54 
	`£t_memÜy_x
(()
	`__va
(
¡¬t
), 
num_·ges
);

56 
	`£t_memÜy_nx
(()
	`__va
(
¡¬t
), 
num_·ges
);

57 
	}
}

59 
__š™
 
	$—¾y_ruÁime_code_m­pšg_£t_exec
(
execubË
)

61 
efi_memÜy_desc_t
 *
md
;

62 *
p
;

64 ià(!(
__suµÜ‹d_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm­
.
m­
;… < memm­.
m­_’d
;… +ğmemm­.
desc_size
) {

69 
md
 = 
p
;

70 ià(
md
->
ty³
 =ğ
EFI_RUNTIME_SERVICES_CODE
) {

71 
’d
;

72 
’d
 = 
md
->
phys_addr
 + (md->
num_·ges
 << 
EFI_PAGE_SHIFT
);

73 
	`—¾y_m­pšg_£t_exec
(
md
->
phys_addr
, 
’d
, 
execubË
);

76 
	}
}

78 
__š™
 
	$efi_ÿÎ_phys_´–og
()

80 
vadd»ss
;

82 
	`—¾y_ruÁime_code_m­pšg_£t_exec
(1);

83 
	`loÿl_œq_§ve
(
efi_æags
);

84 
vadd»ss
 = ()
	`__va
(0x0UL);

85 
§ve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vadd»ss
));

87 
	`__æush_b_®l
();

88 
	}
}

90 
__š™
 
	$efi_ÿÎ_phys_•og
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
§ve_pgd
);

96 
	`__æush_b_®l
();

97 
	`loÿl_œq_»¡Üe
(
efi_æags
);

98 
	`—¾y_ruÁime_code_m­pšg_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__š™
 
	$efi_iÜem­
(
phys_addr
, 
size
)

103 
Ï¡_m­_pâ
;

105 
Ï¡_m­_pâ
 = 
	`š™_memÜy_m­pšg
(
phys_addr
,…hys_add¸+ 
size
);

106 ià((
Ï¡_m­_pâ
 << 
PAGE_SHIFT
è< 
phys_addr
 + 
size
)

107  
NULL
;

109  (
__iomem
 *)
	`__va
(
phys_addr
);

110 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/š™.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__š™
 
	$»£rve_ebda_»giÚ
()

21 
lowmem
, 
ebda_addr
;

29 ià(
	`·¿vœt_’abËd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`g‘_bios_ebda
();

41 ià((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 ià((
ebda_addr
 =ğ0è&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 ià((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`»£rve_—¾y_ov”Ïp_ok
(
lowmem
, 0x100000, "BIOS„eserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<lšux/š™.h
>

8 
	~<lšux/lškage.h
>

9 
	~<lšux/ty³s.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/³rıu.h
>

13 
	~<lšux/¡¬t_k”Ãl.h
>

14 
	~<lšux/io.h
>

16 
	~<asm/´oûssÜ.h
>

17 
	~<asm/´Ùo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgbË.h
>

22 
	~<asm/bæush.h
>

23 
	~<asm/£ùiÚs.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/bios_ebda.h
>

27 
	~<asm/ŒampŞše.h
>

29 
__š™
 
	$z­_id’t™y_m­pšgs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_ş—r
(
pgd
);

33 
	`__æush_b_®l
();

34 
	}
}

38 
__š™
 
	$ş—r_bss
()

40 
	`mem£t
(
__bss_¡¬t
, 0,

41 (è
__bss_¡İ
 - (è
__bss_¡¬t
);

42 
	}
}

44 
__š™
 
	$cİy_boÙd©a
(*
»®_mode_d©a
)

46 * 
commªd_lše
;

48 
	`memıy
(&
boÙ_·¿ms
, 
»®_mode_d©a
,  boot_params);

49 ià(
boÙ_·¿ms
.
hdr
.
cmd_lše_±r
) {

50 
commªd_lše
 = 
	`__va
(
boÙ_·¿ms
.
hdr
.
cmd_lše_±r
);

51 
	`memıy
(
boÙ_commªd_lše
, 
commªd_lše
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__š™
 
	$x86_64_¡¬t_k”Ãl
(* 
»®_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1è& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vœt
(
__’d_of_fixed_add»s£s
è<ğ
MODULES_END
);

74 
	`ş—r_bss
();

77 
	`z­_id’t™y_m­pšgs
();

80 
	`ş—nup_highm­
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifdeà
CONFIG_EARLY_PRINTK


84 
	`£t_šŒ_g©e
(
i
, &
—¾y_idt_hªdËrs
[i]);

86 
	`£t_šŒ_g©e
(
i
, 
—¾y_idt_hªdËr
);

89 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
idt_desü
);

91 ià(
cÚsŞe_logËv–
 == 10)

92 
	`—¾y_´štk
("Kernel‡live\n");

94 
	`x86_64_¡¬t_»£rv©iÚs
(
»®_mode_d©a
);

95 
	}
}

97 
__š™
 
	$x86_64_¡¬t_»£rv©iÚs
(*
»®_mode_d©a
)

99 
	`cİy_boÙd©a
(
	`__va
(
»®_mode_d©a
));

101 
	`»£rve_ŒampŞše_memÜy
();

103 
	`»£rve_—¾y
(
	`__·_symbŞ
(&
_‹xt
), __·_symbŞ(&
__bss_¡İ
), "TEXT DATA BSS");

105 #ifdeà
CONFIG_BLK_DEV_INITRD


107 ià(
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
 && boÙ_·¿ms.hdr.
¿mdisk_image
) {

108 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

109 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

110 
¿mdisk_’d
 = 
¿mdisk_image
 + 
¿mdisk_size
;

111 
	`»£rve_—¾y
(
¿mdisk_image
, 
¿mdisk_’d
, "RAMDISK");

115 
	`»£rve_ebda_»giÚ
();

123 
	`¡¬t_k”Ãl
();

124 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<lšux/şocksourû.h
>

2 
	~<lšux/şockchs.h
>

3 
	~<lšux/š‹¼u±.h
>

4 
	~<lšux/sysdev.h
>

5 
	~<lšux/d–ay.h
>

6 
	~<lšux/”ºo.h
>

7 
	~<lšux/h³t.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/ıu.h
>

10 
	~<lšux/pm.h
>

11 
	~<lšux/io.h
>

13 
	~<asm/fixm­.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/h³t.h
>

17 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

18 
	#HPET_SHIFT
 22

	)

22 
	#FSEC_PER_NSEC
 1000000L

	)

24 
	#HPET_DEV_USED_BIT
 2

	)

25 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

26 
	#HPET_DEV_VALID
 0x8

	)

27 
	#HPET_DEV_FSB_CAP
 0x1000

	)

28 
	#HPET_DEV_PERI_CAP
 0x2000

	)

30 
	#EVT_TO_HPET_DEV
(
evt
è
	`cÚš”_of
Óvt, 
h³t_dev
,ƒvt)

	)

35 
	gh³t_add»ss
;

36 #ifdeà
CONFIG_PCI_MSI


37 
	gh³t_num_tim”s
;

39 
__iomem
 *
	gh³t_vœt_add»ss
;

41 
	sh³t_dev
 {

42 
şock_ev’t_deviû
 
	mevt
;

43 
	mnum
;

44 
	mıu
;

45 
	mœq
;

46 
	mæags
;

47 
	mÇme
[10];

50 
	$h³t_»adl
(
a
)

52  
	`»adl
(
h³t_vœt_add»ss
 + 
a
);

53 
	}
}

55 
šlše
 
	$h³t_wr™–
(
d
, 
a
)

57 
	`wr™–
(
d
, 
h³t_vœt_add»ss
 + 
a
);

58 
	}
}

60 #ifdeà
CONFIG_X86_64


61 
	~<asm/pgbË.h
>

64 
šlše
 
	$h³t_£t_m­pšg
()

66 
h³t_vœt_add»ss
 = 
	`iÜem­_noÿche
(
h³t_add»ss
, 
HPET_MMAP_SIZE
);

67 #ifdeà
CONFIG_X86_64


68 
	`__£t_fixm­
(
VSYSCALL_HPET
, 
h³t_add»ss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

70 
	}
}

72 
šlše
 
	$h³t_ş—r_m­pšg
()

74 
	`iounm­
(
h³t_vœt_add»ss
);

75 
h³t_vœt_add»ss
 = 
NULL
;

76 
	}
}

81 
	gboÙ_h³t_di§bË
;

82 
	gh³t_fÜû_u£r
;

83 
	gh³t_v”bo£
;

85 
__š™
 
	$h³t_£tup
(*
¡r
)

87 ià(
¡r
) {

88 ià(!
	`¡ºcmp
("di§bË", 
¡r
, 7))

89 
boÙ_h³t_di§bË
 = 1;

90 ià(!
	`¡ºcmp
("fÜû", 
¡r
, 5))

91 
h³t_fÜû_u£r
 = 1;

92 ià(!
	`¡ºcmp
("v”bo£", 
¡r
, 7))

93 
h³t_v”bo£
 = 1;

96 
	}
}

97 
__£tup
("h³t=", 
h³t_£tup
);

99 
__š™
 
	$di§bË_h³t
(*
¡r
)

101 
boÙ_h³t_di§bË
 = 1;

103 
	}
}

104 
__£tup
("noh³t", 
di§bË_h³t
);

106 
šlše
 
	$is_h³t_ÿ·bË
()

108  !
boÙ_h³t_di§bË
 && 
h³t_add»ss
;

109 
	}
}

114 
	gh³t_Ëgacy_št_’abËd
;

119 
	$is_h³t_’abËd
()

121  
	`is_h³t_ÿ·bË
(è&& 
h³t_Ëgacy_št_’abËd
;

122 
	}
}

123 
EXPORT_SYMBOL_GPL
(
is_h³t_’abËd
);

125 
	$_h³t_´št_cÚfig
(cÚ¡ *
funùiÚ
, 
lše
)

127 
u32
 
i
, 
tim”s
, 
l
, 
h
;

128 
	`´štk
(
KERN_INFO
 "h³t: %s(%d):\n", 
funùiÚ
, 
lše
);

129 
l
 = 
	`h³t_»adl
(
HPET_ID
);

130 
h
 = 
	`h³t_»adl
(
HPET_PERIOD
);

131 
tim”s
 = ((
l
 & 
HPET_ID_NUMBER
è>> 
HPET_ID_NUMBER_SHIFT
) + 1;

132 
	`´štk
(
KERN_INFO
 "h³t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

133 
l
 = 
	`h³t_»adl
(
HPET_CFG
);

134 
h
 = 
	`h³t_»adl
(
HPET_STATUS
);

135 
	`´štk
(
KERN_INFO
 "h³t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

136 
l
 = 
	`h³t_»adl
(
HPET_COUNTER
);

137 
h
 = 
	`h³t_»adl
(
HPET_COUNTER
+4);

138 
	`´štk
(
KERN_INFO
 "h³t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

140 
i
 = 0; i < 
tim”s
; i++) {

141 
l
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
i
));

142 
h
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
i
)+4);

143 
	`´štk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

144 
i
, 
l
, 
h
);

145 
l
 = 
	`h³t_»adl
(
	`HPET_Tn_CMP
(
i
));

146 
h
 = 
	`h³t_»adl
(
	`HPET_Tn_CMP
(
i
)+4);

147 
	`´štk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

148 
i
, 
l
, 
h
);

149 
l
 = 
	`h³t_»adl
(
	`HPET_Tn_ROUTE
(
i
));

150 
h
 = 
	`h³t_»adl
(
	`HPET_Tn_ROUTE
(
i
)+4);

151 
	`´štk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

152 
i
, 
l
, 
h
);

154 
	}
}

156 
	#h³t_´št_cÚfig
() \

158 ià(
h³t_v”bo£
) \

159 
	`_h³t_´št_cÚfig
(
__FUNCTION__
, 
__LINE__
); \

160 } 0)

	)

166 #ifdeà
CONFIG_HPET


168 
h³t_»£rve_msi_tim”s
(
h³t_d©a
 *
hd
);

170 
	$h³t_»£rve_¶©fÜm_tim”s
(
id
)

172 
h³t
 
__iomem
 *h³ˆğ
h³t_vœt_add»ss
;

173 
h³t_tim”
 
__iomem
 *
tim”
 = &
h³t
->
h³t_tim”s
[2];

174 
Ätim”s
, 
i
;

175 
h³t_d©a
 
hd
;

177 
Ätim”s
 = ((
id
 & 
HPET_ID_NUMBER
è>> 
HPET_ID_NUMBER_SHIFT
) + 1;

179 
	`mem£t
(&
hd
, 0, (hd));

180 
hd
.
hd_phys_add»ss
 = 
h³t_add»ss
;

181 
hd
.
hd_add»ss
 = 
h³t
;

182 
hd
.
hd_nœqs
 = 
Ätim”s
;

183 
	`h³t_»£rve_tim”
(&
hd
, 0);

185 #ifdeà
CONFIG_HPET_EMULATE_RTC


186 
	`h³t_»£rve_tim”
(&
hd
, 1);

194 
hd
.
hd_œq
[0] = 
HPET_LEGACY_8254
;

195 
hd
.
hd_œq
[1] = 
HPET_LEGACY_RTC
;

197 
i
 = 2; i < 
Ätim”s
; 
tim”
++, i++) {

198 
hd
.
hd_œq
[
i
] = (
	`»adl
(&
tim”
->
h³t_cÚfig
) &

199 
Tn_INT_ROUTE_CNF_MASK
è>> 
Tn_INT_ROUTE_CNF_SHIFT
;

202 
	`h³t_»£rve_msi_tim”s
(&
hd
);

204 
	`h³t_®loc
(&
hd
);

206 
	}
}

208 
	$h³t_»£rve_¶©fÜm_tim”s
(
id
è{ 
	}
}

214 
	gh³t_³riod
;

216 
h³t_Ëgacy_£t_mode
(
şock_ev’t_mode
 
mode
,

217 
şock_ev’t_deviû
 *
evt
);

218 
h³t_Ëgacy_Ãxt_ev’t
(
d–
,

219 
şock_ev’t_deviû
 *
evt
);

224 
şock_ev’t_deviû
 
	gh³t_şockev’t
 = {

225 .
Çme
 = "hpet",

226 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

227 .
	g£t_mode
 = 
h³t_Ëgacy_£t_mode
,

228 .
	g£t_Ãxt_ev’t
 = 
h³t_Ëgacy_Ãxt_ev’t
,

229 .
	gshiá
 = 32,

230 .
	gœq
 = 0,

231 .
	g¿tšg
 = 50,

234 
	$h³t_¡İ_couÁ”
()

236 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

237 
cfg
 &ğ~
HPET_CFG_ENABLE
;

238 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

239 
	}
}

241 
	$h³t_»£t_couÁ”
()

243 
	`h³t_wr™–
(0, 
HPET_COUNTER
);

244 
	`h³t_wr™–
(0, 
HPET_COUNTER
 + 4);

245 
	}
}

247 
	$h³t_¡¬t_couÁ”
()

249 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

250 
cfg
 |ğ
HPET_CFG_ENABLE
;

251 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

252 
	}
}

254 
	$h³t_»¡¬t_couÁ”
()

256 
	`h³t_¡İ_couÁ”
();

257 
	`h³t_»£t_couÁ”
();

258 
	`h³t_¡¬t_couÁ”
();

259 
	}
}

261 
	$h³t_»sume_deviû
()

263 
	`fÜû_h³t_»sume
();

264 
	}
}

266 
	$h³t_»sume_couÁ”
()

268 
	`h³t_»sume_deviû
();

269 
	`h³t_»¡¬t_couÁ”
();

270 
	}
}

272 
	$h³t_’abË_Ëgacy_št
()

274 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

276 
cfg
 |ğ
HPET_CFG_LEGACY
;

277 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

278 
h³t_Ëgacy_št_’abËd
 = 1;

279 
	}
}

281 
	$h³t_Ëgacy_şockev’t_»gi¡”
()

284 
	`h³t_’abË_Ëgacy_št
();

294 
h³t_şockev’t
.
muÉ
 = 
	`div_sc
((è
FSEC_PER_NSEC
,

295 
h³t_³riod
, 
h³t_şockev’t
.
shiá
);

297 
h³t_şockev’t
.
max_d–_ns
 = 
	`şockev’t_d–2ns
(0x7FFFFFFF,

298 &
h³t_şockev’t
);

300 
h³t_şockev’t
.
mš_d–_ns
 = 5000;

306 
h³t_şockev’t
.
ıumask
 = 
	`ıumask_of
(
	`smp_´oûssÜ_id
());

307 
	`şockev’ts_»gi¡”_deviû
(&
h³t_şockev’t
);

308 
glob®_şock_ev’t
 = &
h³t_şockev’t
;

309 
	`´štk
(
KERN_DEBUG
 "hpet clockevent„egistered\n");

310 
	}
}

312 
h³t_£tup_msi_œq
(
œq
);

314 
	$h³t_£t_mode
(
şock_ev’t_mode
 
mode
,

315 
şock_ev’t_deviû
 *
evt
, 
tim”
)

317 
cfg
, 
cmp
, 
now
;

318 
ušt64_t
 
d–
;

320 
mode
) {

321 
CLOCK_EVT_MODE_PERIODIC
:

322 
	`h³t_¡İ_couÁ”
();

323 
d–
 = ((
ušt64_t
)(
NSEC_PER_SEC
/
HZ
)è* 
evt
->
muÉ
;

324 
d–
 >>ğ
evt
->
shiá
;

325 
now
 = 
	`h³t_»adl
(
HPET_COUNTER
);

326 
cmp
 = 
now
 + (è
d–
;

327 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
tim”
));

329 
cfg
 &ğ~
HPET_TN_LEVEL
;

330 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

331 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

332 
	`h³t_wr™–
(
cfg
, 
	`HPET_Tn_CFG
(
tim”
));

333 
	`h³t_wr™–
(
cmp
, 
	`HPET_Tn_CMP
(
tim”
));

334 
	`ud–ay
(1);

342 
	`h³t_wr™–
((è
d–
, 
	`HPET_Tn_CMP
(
tim”
));

343 
	`h³t_¡¬t_couÁ”
();

344 
	`h³t_´št_cÚfig
();

347 
CLOCK_EVT_MODE_ONESHOT
:

348 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
tim”
));

349 
cfg
 &ğ~
HPET_TN_PERIODIC
;

350 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

351 
	`h³t_wr™–
(
cfg
, 
	`HPET_Tn_CFG
(
tim”
));

354 
CLOCK_EVT_MODE_UNUSED
:

355 
CLOCK_EVT_MODE_SHUTDOWN
:

356 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
tim”
));

357 
cfg
 &ğ~
HPET_TN_ENABLE
;

358 
	`h³t_wr™–
(
cfg
, 
	`HPET_Tn_CFG
(
tim”
));

361 
CLOCK_EVT_MODE_RESUME
:

362 ià(
tim”
 == 0) {

363 
	`h³t_’abË_Ëgacy_št
();

365 
h³t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

366 
	`h³t_£tup_msi_œq
(
hdev
->
œq
);

367 
	`di§bË_œq
(
hdev
->
œq
);

368 
	`œq_£t_affš™y
(
hdev
->
œq
, 
	`ıumask_of
(hdev->
ıu
));

369 
	`’abË_œq
(
hdev
->
œq
);

371 
	`h³t_´št_cÚfig
();

374 
	}
}

376 
	$h³t_Ãxt_ev’t
(
d–
,

377 
şock_ev’t_deviû
 *
evt
, 
tim”
)

379 
u32
 
út
;

381 
út
 = 
	`h³t_»adl
(
HPET_COUNTER
);

382 
út
 +ğ(
u32
è
d–
;

383 
	`h³t_wr™–
(
út
, 
	`HPET_Tn_CMP
(
tim”
));

390 
	`WARN_ON_ONCE
((
u32
)
	`h³t_»adl
(
	`HPET_Tn_CMP
(
tim”
)è!ğ
út
);

392  (
s32
)((
u32
)
	`h³t_»adl
(
HPET_COUNTER
è- 
út
è>ğ0 ? -
ETIME
 : 0;

393 
	}
}

395 
	$h³t_Ëgacy_£t_mode
(
şock_ev’t_mode
 
mode
,

396 
şock_ev’t_deviû
 *
evt
)

398 
	`h³t_£t_mode
(
mode
, 
evt
, 0);

399 
	}
}

401 
	$h³t_Ëgacy_Ãxt_ev’t
(
d–
,

402 
şock_ev’t_deviû
 *
evt
)

404  
	`h³t_Ãxt_ev’t
(
d–
, 
evt
, 0);

405 
	}
}

410 #ifdeà
CONFIG_PCI_MSI


412 
DEFINE_PER_CPU
(
h³t_dev
 *, 
ıu_h³t_dev
);

413 
h³t_dev
 *
	gh³t_devs
;

415 
	$h³t_msi_unmask
(
œq
)

417 
h³t_dev
 *
hdev
 = 
	`g‘_œq_d©a
(
œq
);

418 
cfg
;

421 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

422 
cfg
 |ğ
HPET_TN_FSB
;

423 
	`h³t_wr™–
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

424 
	}
}

426 
	$h³t_msi_mask
(
œq
)

428 
cfg
;

429 
h³t_dev
 *
hdev
 = 
	`g‘_œq_d©a
(
œq
);

432 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

433 
cfg
 &ğ~
HPET_TN_FSB
;

434 
	`h³t_wr™–
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

435 
	}
}

437 
	$h³t_msi_wr™e
(
œq
, 
msi_msg
 *
msg
)

439 
h³t_dev
 *
hdev
 = 
	`g‘_œq_d©a
(
œq
);

441 
	`h³t_wr™–
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

442 
	`h³t_wr™–
(
msg
->
add»ss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

443 
	}
}

445 
	$h³t_msi_»ad
(
œq
, 
msi_msg
 *
msg
)

447 
h³t_dev
 *
hdev
 = 
	`g‘_œq_d©a
(
œq
);

449 
msg
->
d©a
 = 
	`h³t_»adl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

450 
msg
->
add»ss_lo
 = 
	`h³t_»adl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

451 
msg
->
add»ss_hi
 = 0;

452 
	}
}

454 
	$h³t_msi_£t_mode
(
şock_ev’t_mode
 
mode
,

455 
şock_ev’t_deviû
 *
evt
)

457 
h³t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

458 
	`h³t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

459 
	}
}

461 
	$h³t_msi_Ãxt_ev’t
(
d–
,

462 
şock_ev’t_deviû
 *
evt
)

464 
h³t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

465  
	`h³t_Ãxt_ev’t
(
d–
, 
evt
, 
hdev
->
num
);

466 
	}
}

468 
	$h³t_£tup_msi_œq
(
œq
)

470 ià(
	`¬ch_£tup_h³t_msi
(
œq
)) {

471 
	`de¡roy_œq
(
œq
);

472  -
EINVAL
;

475 
	}
}

477 
	$h³t_assign_œq
(
h³t_dev
 *
dev
)

479 
œq
;

481 
œq
 = 
	`ü—‹_œq
();

482 ià(!
œq
)

483  -
EINVAL
;

485 
	`£t_œq_d©a
(
œq
, 
dev
);

487 ià(
	`h³t_£tup_msi_œq
(
œq
))

488  -
EINVAL
;

490 
dev
->
œq
 = irq;

492 
	}
}

494 
œq»tuº_t
 
	$h³t_š‹¼u±_hªdËr
(
œq
, *
d©a
)

496 
h³t_dev
 *
dev
 = (h³t_dev *)
d©a
;

497 
şock_ev’t_deviû
 *
hevt
 = &
dev
->
evt
;

499 ià(!
hevt
->
ev’t_hªdËr
) {

500 
	`´štk
(
KERN_INFO
 "Spurious HPETimer interrupt on HPETimer %d\n",

501 
dev
->
num
);

502  
IRQ_HANDLED
;

505 
hevt
->
	`ev’t_hªdËr
(hevt);

506  
IRQ_HANDLED
;

507 
	}
}

509 
	$h³t_£tup_œq
(
h³t_dev
 *
dev
)

512 ià(
	`»que¡_œq
(
dev
->
œq
, 
h³t_š‹¼u±_hªdËr
,

513 
IRQF_DISABLED
|
IRQF_NOBALANCING
, 
dev
->
Çme
, dev))

516 
	`di§bË_œq
(
dev
->
œq
);

517 
	`œq_£t_affš™y
(
dev
->
œq
, 
	`ıumask_of
(dev->
ıu
));

518 
	`’abË_œq
(
dev
->
œq
);

520 
	`´štk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

521 
dev
->
Çme
, dev->
œq
);

524 
	}
}

527 
	$š™_Úe_h³t_msi_şockev’t
(
h³t_dev
 *
hdev
, 
ıu
)

529 
şock_ev’t_deviû
 *
evt
 = &
hdev
->evt;

530 
ušt64_t
 
h³t_äeq
;

532 
	`WARN_ON
(
ıu
 !ğ
	`smp_´oûssÜ_id
());

533 ià(!(
hdev
->
æags
 & 
HPET_DEV_VALID
))

536 ià(
	`h³t_£tup_msi_œq
(
hdev
->
œq
))

539 
hdev
->
ıu
 = cpu;

540 
	`³r_ıu
(
ıu_h³t_dev
, 
ıu
èğ
hdev
;

541 
evt
->
Çme
 = 
hdev
->name;

542 
	`h³t_£tup_œq
(
hdev
);

543 
evt
->
œq
 = 
hdev
->irq;

545 
evt
->
¿tšg
 = 110;

546 
evt
->
ã©u»s
 = 
CLOCK_EVT_FEAT_ONESHOT
;

547 ià(
hdev
->
æags
 & 
HPET_DEV_PERI_CAP
)

548 
evt
->
ã©u»s
 |ğ
CLOCK_EVT_FEAT_PERIODIC
;

550 
evt
->
£t_mode
 = 
h³t_msi_£t_mode
;

551 
evt
->
£t_Ãxt_ev’t
 = 
h³t_msi_Ãxt_ev’t
;

552 
evt
->
shiá
 = 32;

559 
h³t_äeq
 = 1000000000000000ULL;

560 
	`do_div
(
h³t_äeq
, 
h³t_³riod
);

561 
evt
->
muÉ
 = 
	`div_sc
((è
h³t_äeq
,

562 
NSEC_PER_SEC
, 
evt
->
shiá
);

564 
evt
->
max_d–_ns
 = 
	`şockev’t_d–2ns
(0x7FFFFFFF,ƒvt);

566 
evt
->
mš_d–_ns
 = 5000;

568 
evt
->
ıumask
 = 
	`ıumask_of
(
hdev
->
ıu
);

569 
	`şockev’ts_»gi¡”_deviû
(
evt
);

570 
	}
}

572 #ifdeà
CONFIG_HPET


574 
	#RESERVE_TIMERS
 1

	)

576 
	#RESERVE_TIMERS
 0

	)

579 
	$h³t_msi_ÿ·b™y_lookup
(
¡¬t_tim”
)

581 
id
;

582 
num_tim”s
;

583 
num_tim”s_u£d
 = 0;

584 
i
;

586 
id
 = 
	`h³t_»adl
(
HPET_ID
);

588 
num_tim”s
 = ((
id
 & 
HPET_ID_NUMBER
è>> 
HPET_ID_NUMBER_SHIFT
);

589 
num_tim”s
++;

590 
	`h³t_´št_cÚfig
();

592 
h³t_devs
 = 
	`kz®loc
((
h³t_dev
è* 
num_tim”s
, 
GFP_KERNEL
);

593 ià(!
h³t_devs
)

596 
h³t_num_tim”s
 = 
num_tim”s
;

598 
i
 = 
¡¬t_tim”
; i < 
num_tim”s
 - 
RESERVE_TIMERS
; i++) {

599 
h³t_dev
 *
hdev
 = &
h³t_devs
[
num_tim”s_u£d
];

600 
cfg
 = 
	`h³t_»adl
(
	`HPET_Tn_CFG
(
i
));

603 ià(!(
cfg
 & 
HPET_TN_FSB_CAP
))

606 
hdev
->
æags
 = 0;

607 ià(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

608 
hdev
->
æags
 |ğ
HPET_DEV_PERI_CAP
;

609 
hdev
->
num
 = 
i
;

611 
	`¥rštf
(
hdev
->
Çme
, "h³t%d", 
i
);

612 ià(
	`h³t_assign_œq
(
hdev
))

615 
hdev
->
æags
 |ğ
HPET_DEV_FSB_CAP
;

616 
hdev
->
æags
 |ğ
HPET_DEV_VALID
;

617 
num_tim”s_u£d
++;

618 ià(
num_tim”s_u£d
 =ğ
	`num_possibË_ıus
())

622 
	`´štk
(
KERN_INFO
 "HPET: %dimers inotal, %dimers will be used for…er-cpuimer\n",

623 
num_tim”s
, 
num_tim”s_u£d
);

624 
	}
}

626 #ifdeà
CONFIG_HPET


627 
	$h³t_»£rve_msi_tim”s
(
h³t_d©a
 *
hd
)

629 
i
;

631 ià(!
h³t_devs
)

634 
i
 = 0; i < 
h³t_num_tim”s
; i++) {

635 
h³t_dev
 *
hdev
 = &
h³t_devs
[
i
];

637 ià(!(
hdev
->
æags
 & 
HPET_DEV_VALID
))

640 
hd
->
hd_œq
[
hdev
->
num
] = hdev->
œq
;

641 
	`h³t_»£rve_tim”
(
hd
, 
hdev
->
num
);

643 
	}
}

646 
h³t_dev
 *
	$h³t_g‘_unu£d_tim”
()

648 
i
;

650 ià(!
h³t_devs
)

651  
NULL
;

653 
i
 = 0; i < 
h³t_num_tim”s
; i++) {

654 
h³t_dev
 *
hdev
 = &
h³t_devs
[
i
];

656 ià(!(
hdev
->
æags
 & 
HPET_DEV_VALID
))

658 ià(
	`‹¡_ªd_£t_b™
(
HPET_DEV_USED_BIT
,

659 (*)&
hdev
->
æags
))

661  
hdev
;

663  
NULL
;

664 
	}
}

666 
	sh³t_wÜk_¡ruù
 {

667 
d–ayed_wÜk
 
	mwÜk
;

668 
com¶‘iÚ
 
	mcom¶‘e
;

671 
	$h³t_wÜk
(
wÜk_¡ruù
 *
w
)

673 
h³t_dev
 *
hdev
;

674 
ıu
 = 
	`smp_´oûssÜ_id
();

675 
h³t_wÜk_¡ruù
 *
h³t_wÜk
;

677 
h³t_wÜk
 = 
	`cÚš”_of
(
w
, 
h³t_wÜk_¡ruù
, 
wÜk
.work);

679 
hdev
 = 
	`h³t_g‘_unu£d_tim”
();

680 ià(
hdev
)

681 
	`š™_Úe_h³t_msi_şockev’t
(
hdev
, 
ıu
);

683 
	`com¶‘e
(&
h³t_wÜk
->
com¶‘e
);

684 
	}
}

686 
	$h³t_ıuhp_nÙify
(
nÙif›r_block
 *
n
,

687 
aùiÚ
, *
hıu
)

689 
ıu
 = ()
hıu
;

690 
h³t_wÜk_¡ruù
 
wÜk
;

691 
h³t_dev
 *
hdev
 = 
	`³r_ıu
(
ıu_h³t_dev
, 
ıu
);

693 
aùiÚ
 & 0xf) {

694 
CPU_ONLINE
:

695 
	`INIT_DELAYED_WORK_ON_STACK
(&
wÜk
.wÜk, 
h³t_wÜk
);

696 
	`š™_com¶‘iÚ
(&
wÜk
.
com¶‘e
);

698 
	`scheduË_d–ayed_wÜk_Ú
(
ıu
, &
wÜk
.work, 0);

699 
	`wa™_fÜ_com¶‘iÚ
(&
wÜk
.
com¶‘e
);

700 
	`de¡roy_tim”_Ú_¡ack
(&
wÜk
.wÜk.
tim”
);

702 
CPU_DEAD
:

703 ià(
hdev
) {

704 
	`ä“_œq
(
hdev
->
œq
, hdev);

705 
hdev
->
æags
 &ğ~
HPET_DEV_USED
;

706 
	`³r_ıu
(
ıu_h³t_dev
, 
ıu
èğ
NULL
;

710  
NOTIFY_OK
;

711 
	}
}

714 
	$h³t_£tup_msi_œq
(
œq
)

717 
	}
}

718 
	$h³t_msi_ÿ·b™y_lookup
(
¡¬t_tim”
)

721 
	}
}

723 #ifdeà
CONFIG_HPET


724 
	$h³t_»£rve_msi_tim”s
(
h³t_d©a
 *
hd
)

727 
	}
}

730 
	$h³t_ıuhp_nÙify
(
nÙif›r_block
 *
n
,

731 
aùiÚ
, *
hıu
)

733  
NOTIFY_OK
;

734 
	}
}

741 
cyşe_t
 
	$»ad_h³t
(
şocksourû
 *
cs
)

743  (
cyşe_t
)
	`h³t_»adl
(
HPET_COUNTER
);

744 
	}
}

746 #ifdeà
CONFIG_X86_64


747 
cyşe_t
 
__vsysÿÎ_â
 
	$v»ad_h³t
()

749  
	`»adl
((cÚ¡ 
__iomem
 *)
	`fix_to_vœt
(
VSYSCALL_HPET
) + 0xf0);

750 
	}
}

753 
şocksourû
 
	gşocksourû_h³t
 = {

754 .
Çme
 = "hpet",

755 .
	g¿tšg
 = 250,

756 .
	g»ad
 = 
»ad_h³t
,

757 .
	gmask
 = 
HPET_MASK
,

758 .
	gshiá
 = 
HPET_SHIFT
,

759 .
	gæags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

760 .
	g»sume
 = 
h³t_»sume_couÁ”
,

761 #ifdeà
CONFIG_X86_64


762 .
	gv»ad
 = 
v»ad_h³t
,

766 
	$h³t_şocksourû_»gi¡”
()

768 
u64
 
¡¬t
, 
now
;

769 
cyşe_t
 
t1
;

772 
	`h³t_»¡¬t_couÁ”
();

775 
t1
 = 
	`h³t_»adl
(
HPET_COUNTER
);

776 
	`rdtsşl
(
¡¬t
);

785 
	`»p_nİ
();

786 
	`rdtsşl
(
now
);

787 } (
now
 - 
¡¬t
) < 200000UL);

789 ià(
t1
 =ğ
	`h³t_»adl
(
HPET_COUNTER
)) {

790 
	`´štk
(
KERN_WARNING


792  -
ENODEV
;

803 
şocksourû_h³t
.
muÉ
 = 
	`div_sc
(
h³t_³riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

805 
	`şocksourû_»gi¡”
(&
şocksourû_h³t
);

808 
	}
}

813 
__š™
 
	$h³t_’abË
()

815 
id
;

816 
i
;

818 ià(!
	`is_h³t_ÿ·bË
())

821 
	`h³t_£t_m­pšg
();

826 
h³t_³riod
 = 
	`h³t_»adl
(
HPET_PERIOD
);

841 
i
 = 0; 
	`h³t_»adl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

842 ià(
i
 == 1000) {

843 
	`´štk
(
KERN_WARNING


846 
out_noh³t
;

850 ià(
h³t_³riod
 < 
HPET_MIN_PERIOD
 || h³t_³riod > 
HPET_MAX_PERIOD
)

851 
out_noh³t
;

857 
id
 = 
	`h³t_»adl
(
HPET_ID
);

858 
	`h³t_´št_cÚfig
();

860 #ifdeà
CONFIG_HPET_EMULATE_RTC


865 ià(!(
id
 & 
HPET_ID_NUMBER
))

866 
out_noh³t
;

869 ià(
	`h³t_şocksourû_»gi¡”
())

870 
out_noh³t
;

872 ià(
id
 & 
HPET_ID_LEGSUP
) {

873 
	`h³t_Ëgacy_şockev’t_»gi¡”
();

874 
	`h³t_msi_ÿ·b™y_lookup
(2);

877 
	`h³t_msi_ÿ·b™y_lookup
(0);

880 
out_noh³t
:

881 
	`h³t_ş—r_m­pšg
();

882 
h³t_add»ss
 = 0;

884 
	}
}

892 
__š™
 
	$h³t_Ï‹_š™
()

894 
ıu
;

896 ià(
boÙ_h³t_di§bË
)

897  -
ENODEV
;

899 ià(!
h³t_add»ss
) {

900 ià(!
fÜû_h³t_add»ss
)

901  -
ENODEV
;

903 
h³t_add»ss
 = 
fÜû_h³t_add»ss
;

904 
	`h³t_’abË
();

907 ià(!
h³t_vœt_add»ss
)

908  -
ENODEV
;

910 
	`h³t_»£rve_¶©fÜm_tim”s
(
	`h³t_»adl
(
HPET_ID
));

911 
	`h³t_´št_cÚfig
();

913 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

914 
	`h³t_ıuhp_nÙify
(
NULL
, 
CPU_ONLINE
, (*)()
ıu
);

918 
	`hÙıu_nÙif›r
(
h³t_ıuhp_nÙify
, -20);

921 
	}
}

922 
fs_š™ÿÎ
(
h³t_Ï‹_š™
);

924 
	$h³t_di§bË
()

926 ià(
	`is_h³t_ÿ·bË
()) {

927 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

929 ià(
h³t_Ëgacy_št_’abËd
) {

930 
cfg
 &ğ~
HPET_CFG_LEGACY
;

931 
h³t_Ëgacy_št_’abËd
 = 0;

933 
cfg
 &ğ~
HPET_CFG_ENABLE
;

934 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

936 
	}
}

938 #ifdeà
CONFIG_HPET_EMULATE_RTC


954 
	~<lšux/mc146818¹c.h
>

955 
	~<lšux/¹c.h
>

956 
	~<asm/¹c.h
>

958 
	#DEFAULT_RTC_INT_FREQ
 64

	)

959 
	#DEFAULT_RTC_SHIFT
 6

	)

960 
	#RTC_NUM_INTS
 1

	)

962 
	gh³t_¹c_æags
;

963 
	gh³t_´ev_upd©e_£c
;

964 
¹c_time
 
	gh³t_®¬m_time
;

965 
	gh³t_p›_couÁ
;

966 
u32
 
	gh³t_t1_cmp
;

967 
	gh³t_deçuÉ_d–
;

968 
	gh³t_p›_d–
;

969 
	gh³t_p›_lim™
;

971 
¹c_œq_hªdËr
 
	gœq_hªdËr
;

976 
šlše
 
	$h³t_út_ah—d
(
u32
 
c1
, u32 
c2
)

978  (
s32
)(
c2
 - 
c1
) < 0;

979 
	}
}

984 
	$h³t_»gi¡”_œq_hªdËr
(
¹c_œq_hªdËr
 
hªdËr
)

986 ià(!
	`is_h³t_’abËd
())

987  -
ENODEV
;

988 ià(
œq_hªdËr
)

989  -
EBUSY
;

991 
œq_hªdËr
 = 
hªdËr
;

994 
	}
}

995 
EXPORT_SYMBOL_GPL
(
h³t_»gi¡”_œq_hªdËr
);

1001 
	$h³t_uÄegi¡”_œq_hªdËr
(
¹c_œq_hªdËr
 
hªdËr
)

1003 ià(!
	`is_h³t_’abËd
())

1006 
œq_hªdËr
 = 
NULL
;

1007 
h³t_¹c_æags
 = 0;

1008 
	}
}

1009 
EXPORT_SYMBOL_GPL
(
h³t_uÄegi¡”_œq_hªdËr
);

1017 
	$h³t_¹c_tim”_š™
()

1019 
cfg
, 
út
, 
d–
, 
æags
;

1021 ià(!
	`is_h³t_’abËd
())

1024 ià(!
h³t_deçuÉ_d–
) {

1025 
ušt64_t
 
şc
;

1027 
şc
 = (
ušt64_t
è
h³t_şockev’t
.
muÉ
 * 
NSEC_PER_SEC
;

1028 
şc
 >>ğ
h³t_şockev’t
.
shiá
 + 
DEFAULT_RTC_SHIFT
;

1029 
h³t_deçuÉ_d–
 = (è
şc
;

1032 ià(!(
h³t_¹c_æags
 & 
RTC_PIE
è|| 
h³t_p›_lim™
)

1033 
d–
 = 
h³t_deçuÉ_d–
;

1035 
d–
 = 
h³t_p›_d–
;

1037 
	`loÿl_œq_§ve
(
æags
);

1039 
út
 = 
d–
 + 
	`h³t_»adl
(
HPET_COUNTER
);

1040 
	`h³t_wr™–
(
út
, 
HPET_T1_CMP
);

1041 
h³t_t1_cmp
 = 
út
;

1043 
cfg
 = 
	`h³t_»adl
(
HPET_T1_CFG
);

1044 
cfg
 &ğ~
HPET_TN_PERIODIC
;

1045 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1046 
	`h³t_wr™–
(
cfg
, 
HPET_T1_CFG
);

1048 
	`loÿl_œq_»¡Üe
(
æags
);

1051 
	}
}

1052 
EXPORT_SYMBOL_GPL
(
h³t_¹c_tim”_š™
);

1059 
	$h³t_mask_¹c_œq_b™
(
b™_mask
)

1061 ià(!
	`is_h³t_’abËd
())

1064 
h³t_¹c_æags
 &ğ~
b™_mask
;

1066 
	}
}

1067 
EXPORT_SYMBOL_GPL
(
h³t_mask_¹c_œq_b™
);

1069 
	$h³t_£t_¹c_œq_b™
(
b™_mask
)

1071 
Şdb™s
 = 
h³t_¹c_æags
;

1073 ià(!
	`is_h³t_’abËd
())

1076 
h³t_¹c_æags
 |ğ
b™_mask
;

1078 ià((
b™_mask
 & 
RTC_UIE
è&& !(
Şdb™s
 & RTC_UIE))

1079 
h³t_´ev_upd©e_£c
 = -1;

1081 ià(!
Şdb™s
)

1082 
	`h³t_¹c_tim”_š™
();

1085 
	}
}

1086 
EXPORT_SYMBOL_GPL
(
h³t_£t_¹c_œq_b™
);

1088 
	$h³t_£t_®¬m_time
(
hrs
, 
mš
,

1089 
£c
)

1091 ià(!
	`is_h³t_’abËd
())

1094 
h³t_®¬m_time
.
tm_hour
 = 
hrs
;

1095 
h³t_®¬m_time
.
tm_mš
 = 
mš
;

1096 
h³t_®¬m_time
.
tm_£c
 = 
£c
;

1099 
	}
}

1100 
EXPORT_SYMBOL_GPL
(
h³t_£t_®¬m_time
);

1102 
	$h³t_£t_³riodic_äeq
(
äeq
)

1104 
ušt64_t
 
şc
;

1106 ià(!
	`is_h³t_’abËd
())

1109 ià(
äeq
 <ğ
DEFAULT_RTC_INT_FREQ
)

1110 
h³t_p›_lim™
 = 
DEFAULT_RTC_INT_FREQ
 / 
äeq
;

1112 
şc
 = (
ušt64_t
è
h³t_şockev’t
.
muÉ
 * 
NSEC_PER_SEC
;

1113 
	`do_div
(
şc
, 
äeq
);

1114 
şc
 >>ğ
h³t_şockev’t
.
shiá
;

1115 
h³t_p›_d–
 = (è
şc
;

1118 
	}
}

1119 
EXPORT_SYMBOL_GPL
(
h³t_£t_³riodic_äeq
);

1121 
	$h³t_¹c_drİ³d_œq
()

1123  
	`is_h³t_’abËd
();

1124 
	}
}

1125 
EXPORT_SYMBOL_GPL
(
h³t_¹c_drİ³d_œq
);

1127 
	$h³t_¹c_tim”_»š™
()

1129 
cfg
, 
d–
;

1130 
lo¡_šts
 = -1;

1132 ià(
	`uÆik–y
(!
h³t_¹c_æags
)) {

1133 
cfg
 = 
	`h³t_»adl
(
HPET_T1_CFG
);

1134 
cfg
 &ğ~
HPET_TN_ENABLE
;

1135 
	`h³t_wr™–
(
cfg
, 
HPET_T1_CFG
);

1139 ià(!(
h³t_¹c_æags
 & 
RTC_PIE
è|| 
h³t_p›_lim™
)

1140 
d–
 = 
h³t_deçuÉ_d–
;

1142 
d–
 = 
h³t_p›_d–
;

1149 
h³t_t1_cmp
 +ğ
d–
;

1150 
	`h³t_wr™–
(
h³t_t1_cmp
, 
HPET_T1_CMP
);

1151 
lo¡_šts
++;

1152 } !
	`h³t_út_ah—d
(
h³t_t1_cmp
, 
	`h³t_»adl
(
HPET_COUNTER
)));

1154 ià(
lo¡_šts
) {

1155 ià(
h³t_¹c_æags
 & 
RTC_PIE
)

1156 
h³t_p›_couÁ
 +ğ
lo¡_šts
;

1157 ià(
	`´štk_¿‹lim™
())

1158 
	`´štk
(
KERN_WARNING
 "hpet1:†ost %d„tc interrupts\n",

1159 
lo¡_šts
);

1161 
	}
}

1163 
œq»tuº_t
 
	$h³t_¹c_š‹¼u±
(
œq
, *
dev_id
)

1165 
¹c_time
 
cu¼_time
;

1166 
¹c_št_æag
 = 0;

1168 
	`h³t_¹c_tim”_»š™
();

1169 
	`mem£t
(&
cu¼_time
, 0, (
¹c_time
));

1171 ià(
h³t_¹c_æags
 & (
RTC_UIE
 | 
RTC_AIE
))

1172 
	`g‘_¹c_time
(&
cu¼_time
);

1174 ià(
h³t_¹c_æags
 & 
RTC_UIE
 &&

1175 
cu¼_time
.
tm_£c
 !ğ
h³t_´ev_upd©e_£c
) {

1176 ià(
h³t_´ev_upd©e_£c
 >= 0)

1177 
¹c_št_æag
 = 
RTC_UF
;

1178 
h³t_´ev_upd©e_£c
 = 
cu¼_time
.
tm_£c
;

1181 ià(
h³t_¹c_æags
 & 
RTC_PIE
 &&

1182 ++
h³t_p›_couÁ
 >ğ
h³t_p›_lim™
) {

1183 
¹c_št_æag
 |ğ
RTC_PF
;

1184 
h³t_p›_couÁ
 = 0;

1187 ià(
h³t_¹c_æags
 & 
RTC_AIE
 &&

1188 (
cu¼_time
.
tm_£c
 =ğ
h³t_®¬m_time
.tm_sec) &&

1189 (
cu¼_time
.
tm_mš
 =ğ
h³t_®¬m_time
.tm_min) &&

1190 (
cu¼_time
.
tm_hour
 =ğ
h³t_®¬m_time
.tm_hour))

1191 
¹c_št_æag
 |ğ
RTC_AF
;

1193 ià(
¹c_št_æag
) {

1194 
¹c_št_æag
 |ğ(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1195 ià(
œq_hªdËr
)

1196 
	`œq_hªdËr
(
¹c_št_æag
, 
dev_id
);

1198  
IRQ_HANDLED
;

1199 
	}
}

1200 
EXPORT_SYMBOL_GPL
(
h³t_¹c_š‹¼u±
);

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<lšux/moduË.h
>

9 
	~<lšux/»g£t.h
>

10 
	~<lšux/sched.h
>

12 
	~<asm/sigcÚ‹xt.h
>

13 
	~<asm/´oûssÜ.h
>

14 
	~<asm/m©h_emu.h
>

15 
	~<asm/uacûss.h
>

16 
	~<asm/±¿û.h
>

17 
	~<asm/i387.h
>

18 
	~<asm/u£r.h
>

20 #ifdeà
CONFIG_X86_64


21 
	~<asm/sigcÚ‹xt32.h
>

22 
	~<asm/u£r32.h
>

24 
	#§ve_i387_x¡©e_Ÿ32
 
§ve_i387_x¡©e


	)

25 
	#»¡Üe_i387_x¡©e_Ÿ32
 
»¡Üe_i387_x¡©e


	)

26 
	#_å¡©e_Ÿ32
 
_å¡©e


	)

27 
	#_x¡©e_Ÿ32
 
_x¡©e


	)

28 
	#sig_x¡©e_Ÿ32_size
 
sig_x¡©e_size


	)

29 
	#fx_sw_»£rved_Ÿ32
 
fx_sw_»£rved


	)

30 
	#u£r_i387_Ÿ32_¡ruù
 
u£r_i387_¡ruù


	)

31 
	#u£r32_fx¤_¡ruù
 
u£r_fx¤_¡ruù


	)

34 #ifdeà
CONFIG_MATH_EMULATION


35 
	#HAVE_HWFP
 (
boÙ_ıu_d©a
.
h¬d_m©h
)

	)

37 
	#HAVE_HWFP
 1

	)

40 
mxc¤_ã©u»_mask
 
	g__»ad_mo¡ly
 = 0xffffffffu;

41 
	gx¡©e_size
;

42 
	gsig_x¡©e_Ÿ32_size
 = (
_å¡©e_Ÿ32
);

43 
i387_fx§ve_¡ruù
 
fx_sü©ch
 
	g__ıuš™d©a
;

45 
__ıuš™
 
	$mxc¤_ã©u»_mask_š™
()

47 
mask
 = 0;

49 
	`şts
();

50 ià(
ıu_has_fx¤
) {

51 
	`mem£t
(&
fx_sü©ch
, 0, (
i387_fx§ve_¡ruù
));

52 
asm
 vŞ©e("fx§v%0" : : "m" (
fx_sü©ch
));

53 
mask
 = 
fx_sü©ch
.
mxc¤_mask
;

54 ià(
mask
 == 0)

55 
mask
 = 0x0000ffbf;

57 
mxc¤_ã©u»_mask
 &ğ
mask
;

58 
	`¡ts
();

59 
	}
}

61 
__ıuš™
 
	$š™_th»ad_x¡©e
()

63 ià(!
HAVE_HWFP
) {

64 
x¡©e_size
 = (
i387_soá_¡ruù
);

68 ià(
ıu_has_x§ve
) {

69 
	`x§ve_útxt_š™
();

73 ià(
ıu_has_fx¤
)

74 
x¡©e_size
 = (
i387_fx§ve_¡ruù
);

75 #ifdeà
CONFIG_X86_32


77 
x¡©e_size
 = (
i387_f§ve_¡ruù
);

79 
	}
}

81 #ifdeà
CONFIG_X86_64


86 
__ıuš™
 
	$åu_š™
()

88 
Şdü0
 = 
	`»ad_ü0
();

90 
	`£t_š_ü4
(
X86_CR4_OSFXSR
);

91 
	`£t_š_ü4
(
X86_CR4_OSXMMEXCPT
);

93 
	`wr™e_ü0
(
Şdü0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

98 ià(!
	`smp_´oûssÜ_id
())

99 
	`š™_th»ad_x¡©e
();

100 
	`x§ve_š™
();

102 
	`mxc¤_ã©u»_mask_š™
();

104 ià(
ıu_has_x§ve
)

105 
	`cu¼’t_th»ad_šfo
()->
¡©us
 = 
TS_XSAVE
;

107 
	`cu¼’t_th»ad_šfo
()->
¡©us
 = 0;

108 
	`ş—r_u£d_m©h
();

109 
	}
}

118 
	$š™_åu
(
sk_¡ruù
 *
tsk
)

120 ià(
	`tsk_u£d_m©h
(
tsk
)) {

121 ià(
HAVE_HWFP
 && 
tsk
 =ğ
cu¼’t
)

122 
	`uÆazy_åu
(
tsk
);

129 ià(!
tsk
->
th»ad
.
x¡©e
) {

130 
tsk
->
th»ad
.
x¡©e
 = 
	`kmem_ÿche_®loc
(
sk_x¡©e_ÿch•
,

131 
GFP_KERNEL
);

132 ià(!
tsk
->
th»ad
.
x¡©e
)

133  -
ENOMEM
;

136 #ifdeà
CONFIG_X86_32


137 ià(!
HAVE_HWFP
) {

138 
	`mem£t
(
tsk
->
th»ad
.
x¡©e
, 0, 
x¡©e_size
);

139 
	`fš™_sk
(
tsk
);

140 
	`£t_¡İ³d_chd_u£d_m©h
(
tsk
);

145 ià(
ıu_has_fx¤
) {

146 
i387_fx§ve_¡ruù
 *
fx
 = &
tsk
->
th»ad
.
x¡©e
->
fx§ve
;

148 
	`mem£t
(
fx
, 0, 
x¡©e_size
);

149 
fx
->
cwd
 = 0x37f;

150 ià(
ıu_has_xmm
)

151 
fx
->
mxc¤
 = 
MXCSR_DEFAULT
;

153 
i387_f§ve_¡ruù
 *
å
 = &
tsk
->
th»ad
.
x¡©e
->
f§ve
;

154 
	`mem£t
(
å
, 0, 
x¡©e_size
);

155 
å
->
cwd
 = 0xffff037fu;

156 
å
->
swd
 = 0xffff0000u;

157 
å
->
twd
 = 0xffffffffu;

158 
å
->
fos
 = 0xffff0000u;

163 
	`£t_¡İ³d_chd_u£d_m©h
(
tsk
);

165 
	}
}

167 
	$å»gs_aùive
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
)

169  
	`tsk_u£d_m©h
(
rg‘
è? 
»g£t
->
n
 : 0;

170 
	}
}

172 
	$xå»gs_aùive
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
)

174  (
ıu_has_fx¤
 && 
	`tsk_u£d_m©h
(
rg‘
)è? 
»g£t
->
n
 : 0;

175 
	}
}

177 
	$xå»gs_g‘
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

178 
pos
, 
couÁ
,

179 *
kbuf
, 
__u£r
 *
ubuf
)

181 
»t
;

183 ià(!
ıu_has_fx¤
)

184  -
ENODEV
;

186 
»t
 = 
	`š™_åu
(
rg‘
);

187 ià(
»t
)

188  
»t
;

190  
	`u£r_»g£t_cİyout
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
,

191 &
rg‘
->
th»ad
.
x¡©e
->
fx§ve
, 0, -1);

192 
	}
}

194 
	$xå»gs_£t
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

195 
pos
, 
couÁ
,

196 cÚ¡ *
kbuf
, cÚ¡ 
__u£r
 *
ubuf
)

198 
»t
;

200 ià(!
ıu_has_fx¤
)

201  -
ENODEV
;

203 
»t
 = 
	`š™_åu
(
rg‘
);

204 ià(
»t
)

205  
»t
;

207 
	`£t_¡İ³d_chd_u£d_m©h
(
rg‘
);

209 
»t
 = 
	`u£r_»g£t_cİyš
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
,

210 &
rg‘
->
th»ad
.
x¡©e
->
fx§ve
, 0, -1);

215 
rg‘
->
th»ad
.
x¡©e
->
fx§ve
.
mxc¤
 &ğ
mxc¤_ã©u»_mask
;

221 ià(
ıu_has_x§ve
)

222 
rg‘
->
th»ad
.
x¡©e
->
x§ve
.
x§ve_hdr
.
x¡©e_bv
 |ğ
XSTATE_FPSSE
;

224  
»t
;

225 
	}
}

227 #ià
defšed
 
CONFIG_X86_32
 || defšed 
CONFIG_IA32_EMULATION


233 
šlše
 
	$twd_i387_to_fx¤
(
twd
)

235 
tmp
;

238 
tmp
 = ~
twd
;

239 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

241 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

242 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

243 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

245  
tmp
;

246 
	}
}

248 
	#FPREG_ADDR
(
f
, 
n
è((*)&(f)->
¡_¥aû
 + (nè* 16);

	)

249 
	#FP_EXP_TAG_VALID
 0

	)

250 
	#FP_EXP_TAG_ZERO
 1

	)

251 
	#FP_EXP_TAG_SPECIAL
 2

	)

252 
	#FP_EXP_TAG_EMPTY
 3

	)

254 
šlše
 
u32
 
	$twd_fx¤_to_i387
(
i387_fx§ve_¡ruù
 *
fx§ve
)

256 
_åx»g
 *
¡
;

257 
u32
 
tos
 = (
fx§ve
->
swd
 >> 11) & 7;

258 
u32
 
twd
 = (è
fx§ve
->twd;

259 
u32
 
g
;

260 
u32
 
»t
 = 0xffff0000u;

261 
i
;

263 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

264 ià(
twd
 & 0x1) {

265 
¡
 = 
	`FPREG_ADDR
(
fx§ve
, (
i
 - 
tos
) & 7);

267 
¡
->
expÚ’t
 & 0x7fff) {

269 
g
 = 
FP_EXP_TAG_SPECIAL
;

272 ià(!
¡
->
signifiÿnd
[0] &&

273 !
¡
->
signifiÿnd
[1] &&

274 !
¡
->
signifiÿnd
[2] &&

275 !
¡
->
signifiÿnd
[3])

276 
g
 = 
FP_EXP_TAG_ZERO
;

278 
g
 = 
FP_EXP_TAG_SPECIAL
;

281 ià(
¡
->
signifiÿnd
[3] & 0x8000)

282 
g
 = 
FP_EXP_TAG_VALID
;

284 
g
 = 
FP_EXP_TAG_SPECIAL
;

288 
g
 = 
FP_EXP_TAG_EMPTY
;

290 
»t
 |ğ
g
 << (2 * 
i
);

292  
»t
;

293 
	}
}

300 
	$cÚv”t_äom_fx¤
(
u£r_i387_Ÿ32_¡ruù
 *
’v
, 
sk_¡ruù
 *
tsk
)

302 
i387_fx§ve_¡ruù
 *
fx§ve
 = &
tsk
->
th»ad
.
x¡©e
->fxsave;

303 
_å»g
 *
to
 = (_å»g *è&
’v
->
¡_¥aû
[0];

304 
_åx»g
 *
äom
 = (_åx»g *è&
fx§ve
->
¡_¥aû
[0];

305 
i
;

307 
’v
->
cwd
 = 
fx§ve
->cwd | 0xffff0000u;

308 
’v
->
swd
 = 
fx§ve
->swd | 0xffff0000u;

309 
’v
->
twd
 = 
	`twd_fx¤_to_i387
(
fx§ve
);

311 #ifdeà
CONFIG_X86_64


312 
’v
->
f
 = 
fx§ve
->
r
;

313 
’v
->
foo
 = 
fx§ve
->
rdp
;

314 ià(
tsk
 =ğ
cu¼’t
) {

319 
	`asm
("mov %%ds, %[fos]" : [
fos
] "ô" (
’v
->fos));

320 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "ô" (
’v
->fcs));

322 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
tsk
);

324 
’v
->
fos
 = 0xffff0000 | 
tsk
->
th»ad
.
ds
;

325 
’v
->
fcs
 = 
»gs
->
cs
;

328 
’v
->
f
 = 
fx§ve
->fip;

329 
’v
->
fcs
 = (
u16
è
fx§ve
->fc | ((
u32
èfx§ve->
fİ
 << 16);

330 
’v
->
foo
 = 
fx§ve
->foo;

331 
’v
->
fos
 = 
fx§ve
->fos;

334 
i
 = 0; i < 8; ++i)

335 
	`memıy
(&
to
[
i
], &
äom
[i], (to[0]));

336 
	}
}

338 
	$cÚv”t_to_fx¤
(
sk_¡ruù
 *
tsk
,

339 cÚ¡ 
u£r_i387_Ÿ32_¡ruù
 *
’v
)

342 
i387_fx§ve_¡ruù
 *
fx§ve
 = &
tsk
->
th»ad
.
x¡©e
->fxsave;

343 
_å»g
 *
äom
 = (_å»g *è&
’v
->
¡_¥aû
[0];

344 
_åx»g
 *
to
 = (_åx»g *è&
fx§ve
->
¡_¥aû
[0];

345 
i
;

347 
fx§ve
->
cwd
 = 
’v
->cwd;

348 
fx§ve
->
swd
 = 
’v
->swd;

349 
fx§ve
->
twd
 = 
	`twd_i387_to_fx¤
(
’v
->twd);

350 
fx§ve
->
fİ
 = (
u16
è((
u32
è
’v
->
fcs
 >> 16);

351 #ifdeà
CONFIG_X86_64


352 
fx§ve
->
r
 = 
’v
->
f
;

353 
fx§ve
->
rdp
 = 
’v
->
foo
;

356 
fx§ve
->
f
 = 
’v
->fip;

357 
fx§ve
->
fcs
 = (
’v
->fcs & 0xffff);

358 
fx§ve
->
foo
 = 
’v
->foo;

359 
fx§ve
->
fos
 = 
’v
->fos;

362 
i
 = 0; i < 8; ++i)

363 
	`memıy
(&
to
[
i
], &
äom
[i], (from[0]));

364 
	}
}

366 
	$å»gs_g‘
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

367 
pos
, 
couÁ
,

368 *
kbuf
, 
__u£r
 *
ubuf
)

370 
u£r_i387_Ÿ32_¡ruù
 
’v
;

371 
»t
;

373 
»t
 = 
	`š™_åu
(
rg‘
);

374 ià(
»t
)

375  
»t
;

377 ià(!
HAVE_HWFP
)

378  
	`å»gs_soá_g‘
(
rg‘
, 
»g£t
, 
pos
, 
couÁ
, 
kbuf
, 
ubuf
);

380 ià(!
ıu_has_fx¤
) {

381  
	`u£r_»g£t_cİyout
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
,

382 &
rg‘
->
th»ad
.
x¡©e
->
f§ve
, 0,

386 ià(
kbuf
 && 
pos
 =ğ0 && 
couÁ
 =ğ(
’v
)) {

387 
	`cÚv”t_äom_fx¤
(
kbuf
, 
rg‘
);

391 
	`cÚv”t_äom_fx¤
(&
’v
, 
rg‘
);

393  
	`u£r_»g£t_cİyout
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
, &
’v
, 0, -1);

394 
	}
}

396 
	$å»gs_£t
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

397 
pos
, 
couÁ
,

398 cÚ¡ *
kbuf
, cÚ¡ 
__u£r
 *
ubuf
)

400 
u£r_i387_Ÿ32_¡ruù
 
’v
;

401 
»t
;

403 
»t
 = 
	`š™_åu
(
rg‘
);

404 ià(
»t
)

405  
»t
;

407 
	`£t_¡İ³d_chd_u£d_m©h
(
rg‘
);

409 ià(!
HAVE_HWFP
)

410  
	`å»gs_soá_£t
(
rg‘
, 
»g£t
, 
pos
, 
couÁ
, 
kbuf
, 
ubuf
);

412 ià(!
ıu_has_fx¤
) {

413  
	`u£r_»g£t_cİyš
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
,

414 &
rg‘
->
th»ad
.
x¡©e
->
f§ve
, 0, -1);

417 ià(
pos
 > 0 || 
couÁ
 < (
’v
))

418 
	`cÚv”t_äom_fx¤
(&
’v
, 
rg‘
);

420 
»t
 = 
	`u£r_»g£t_cİyš
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
, &
’v
, 0, -1);

421 ià(!
»t
)

422 
	`cÚv”t_to_fx¤
(
rg‘
, &
’v
);

428 ià(
ıu_has_x§ve
)

429 
rg‘
->
th»ad
.
x¡©e
->
x§ve
.
x§ve_hdr
.
x¡©e_bv
 |ğ
XSTATE_FP
;

430  
»t
;

431 
	}
}

437 
šlše
 
	$§ve_i387_f§ve
(
_å¡©e_Ÿ32
 
__u£r
 *
buf
)

439 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

440 
i387_f§ve_¡ruù
 *
å
 = &
tsk
->
th»ad
.
x¡©e
->
f§ve
;

442 
å
->
¡©us
 = fp->
swd
;

443 ià(
	`__cİy_to_u£r
(
buf
, 
å
, (
i387_f§ve_¡ruù
)))

446 
	}
}

448 
	$§ve_i387_fx§ve
(
_å¡©e_Ÿ32
 
__u£r
 *
buf
)

450 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

451 
i387_fx§ve_¡ruù
 *
fx
 = &
tsk
->
th»ad
.
x¡©e
->
fx§ve
;

452 
u£r_i387_Ÿ32_¡ruù
 
’v
;

453 
”r
 = 0;

455 
	`cÚv”t_äom_fx¤
(&
’v
, 
tsk
);

456 ià(
	`__cİy_to_u£r
(
buf
, &
’v
, (env)))

459 
”r
 |ğ
	`__put_u£r
(
fx
->
swd
, &
buf
->
¡©us
);

460 
”r
 |ğ
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

461 ià(
”r
)

464 ià(
	`__cİy_to_u£r
(&
buf
->
_fx¤_’v
[0], 
fx
, 
x¡©e_size
))

467 
	}
}

469 
	$§ve_i387_x§ve
(
__u£r
 *
buf
)

471 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

472 
_å¡©e_Ÿ32
 
__u£r
 *
fx
 = 
buf
;

473 
”r
 = 0;

486 
tsk
->
th»ad
.
x¡©e
->
x§ve
.
x§ve_hdr
.
x¡©e_bv
 |ğ
XSTATE_FPSSE
;

488 ià(
	`§ve_i387_fx§ve
(
fx
) < 0)

491 
”r
 = 
	`__cİy_to_u£r
(&
fx
->
sw_»£rved
, &
fx_sw_»£rved_Ÿ32
,

492 (
_åx_sw_by‹s
));

493 
”r
 |ğ
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

494 (
__u32
 
__u£r
 *è(
buf
 + 
sig_x¡©e_Ÿ32_size


495 - 
FP_XSTATE_MAGIC2_SIZE
));

496 ià(
”r
)

500 
	}
}

502 
	$§ve_i387_x¡©e_Ÿ32
(
__u£r
 *
buf
)

504 
_å¡©e_Ÿ32
 
__u£r
 *
å
 = (_å¡©e_Ÿ32 __u£¸*è
buf
;

505 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

507 ià(!
	`u£d_m©h
())

510 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x¡©e_Ÿ32_size
))

511  -
EACCES
;

516 
	`ş—r_u£d_m©h
();

518 ià(!
HAVE_HWFP
) {

519  
	`å»gs_soá_g‘
(
cu¼’t
, 
NULL
,

520 0, (
u£r_i387_Ÿ32_¡ruù
),

521 
NULL
, 
å
) ? -1 : 1;

524 
	`uÆazy_åu
(
tsk
);

526 ià(
ıu_has_x§ve
)

527  
	`§ve_i387_x§ve
(
å
);

528 ià(
ıu_has_fx¤
)

529  
	`§ve_i387_fx§ve
(
å
);

531  
	`§ve_i387_f§ve
(
å
);

532 
	}
}

534 
šlše
 
	$»¡Üe_i387_f§ve
(
_å¡©e_Ÿ32
 
__u£r
 *
buf
)

536 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

538  
	`__cİy_äom_u£r
(&
tsk
->
th»ad
.
x¡©e
->
f§ve
, 
buf
,

539 (
i387_f§ve_¡ruù
));

540 
	}
}

542 
	$»¡Üe_i387_fx§ve
(
_å¡©e_Ÿ32
 
__u£r
 *
buf
,

543 
size
)

545 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

546 
u£r_i387_Ÿ32_¡ruù
 
’v
;

547 
”r
;

549 
”r
 = 
	`__cİy_äom_u£r
(&
tsk
->
th»ad
.
x¡©e
->
fx§ve
, &
buf
->
_fx¤_’v
[0],

550 
size
);

552 
tsk
->
th»ad
.
x¡©e
->
fx§ve
.
mxc¤
 &ğ
mxc¤_ã©u»_mask
;

553 ià(
”r
 || 
	`__cİy_äom_u£r
(&
’v
, 
buf
, (env)))

555 
	`cÚv”t_to_fx¤
(
tsk
, &
’v
);

558 
	}
}

560 
	$»¡Üe_i387_x§ve
(
__u£r
 *
buf
)

562 
_åx_sw_by‹s
 
fx_sw_u£r
;

563 
_å¡©e_Ÿ32
 
__u£r
 *
fx_u£r
 =

564 ((
_å¡©e_Ÿ32
 
__u£r
 *è
buf
);

565 
i387_fx§ve_¡ruù
 
__u£r
 *
fx
 =

566 (
i387_fx§ve_¡ruù
 
__u£r
 *è&
fx_u£r
->
_fx¤_’v
[0];

567 
x§ve_hdr_¡ruù
 *
x§ve_hdr
 =

568 &
cu¼’t
->
th»ad
.
x¡©e
->
x§ve
.
x§ve_hdr
;

569 
u64
 
mask
;

570 
”r
;

572 ià(
	`check_fÜ_x¡©e
(
fx
, 
buf
, &
fx_sw_u£r
))

573 
fx_Úly
;

575 
mask
 = 
fx_sw_u£r
.
x¡©e_bv
;

577 
”r
 = 
	`»¡Üe_i387_fx§ve
(
buf
, 
fx_sw_u£r
.
x¡©e_size
);

579 
x§ve_hdr
->
x¡©e_bv
 &ğ
pútxt_mask
;

583 
x§ve_hdr
->
»£rved1
[0] = xsave_hdr->reserved1[1] = 0;

589 
mask
 = ~(
pútxt_mask
 & ~mask);

590 
x§ve_hdr
->
x¡©e_bv
 &ğ
mask
;

592  
”r
;

593 
fx_Úly
:

599 
x§ve_hdr
->
x¡©e_bv
 = 
XSTATE_FPSSE
;

600  
	`»¡Üe_i387_fx§ve
(
buf
, (
i387_fx§ve_¡ruù
));

601 
	}
}

603 
	$»¡Üe_i387_x¡©e_Ÿ32
(
__u£r
 *
buf
)

605 
”r
;

606 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

607 
_å¡©e_Ÿ32
 
__u£r
 *
å
 = (_å¡©e_Ÿ32 __u£¸*è
buf
;

609 ià(
HAVE_HWFP
)

610 
	`ş—r_åu
(
tsk
);

612 ià(!
buf
) {

613 ià(
	`u£d_m©h
()) {

614 
	`ş—r_åu
(
tsk
);

615 
	`ş—r_u£d_m©h
();

620 ià(!
	`acûss_ok
(
VERIFY_READ
, 
buf
, 
sig_x¡©e_Ÿ32_size
))

621  -
EACCES
;

623 ià(!
	`u£d_m©h
()) {

624 
”r
 = 
	`š™_åu
(
tsk
);

625 ià(
”r
)

626  
”r
;

629 ià(
HAVE_HWFP
) {

630 ià(
ıu_has_x§ve
)

631 
”r
 = 
	`»¡Üe_i387_x§ve
(
buf
);

632 ià(
ıu_has_fx¤
)

633 
”r
 = 
	`»¡Üe_i387_fx§ve
(
å
, (

634 
i387_fx§ve_¡ruù
));

636 
”r
 = 
	`»¡Üe_i387_f§ve
(
å
);

638 
”r
 = 
	`å»gs_soá_£t
(
cu¼’t
, 
NULL
,

639 0, (
u£r_i387_Ÿ32_¡ruù
),

640 
NULL
, 
å
) != 0;

642 
	`£t_u£d_m©h
();

644  
”r
;

645 
	}
}

654 
	$dump_åu
(
±_»gs
 *
»gs
, 
u£r_i387_¡ruù
 *
åu
)

656 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

657 
åv®id
;

659 
åv®id
 = !!
	`u£d_m©h
();

660 ià(
åv®id
)

661 
åv®id
 = !
	`å»gs_g‘
(
tsk
, 
NULL
,

662 0, (
u£r_i387_Ÿ32_¡ruù
),

663 
åu
, 
NULL
);

665  
åv®id
;

666 
	}
}

667 
EXPORT_SYMBOL
(
dump_åu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<lšux/š™.h
>

13 
	~<lšux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_»sume
(
sys_deviû
 *
dev
)

26 
æags
;

27 
i
;

29 
æags
 = 
	`şaim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_couÁ
(
i
, 1);

41 
	`’abË_dma
(4);

43 
	`»Ëa£_dma_lock
(
æags
);

46 
	}
}

48 
	$i8237A_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

51 
	}
}

53 
sysdev_şass
 
	gi8237_sysdev_şass
 = {

54 .
Çme
 = "i8237",

55 .
	gsu¥’d
 = 
i8237A_su¥’d
,

56 .
	g»sume
 = 
i8237A_»sume
,

59 
sys_deviû
 
	gdeviû_i8237A
 = {

60 .
id
 = 0,

61 .
	gşs
 = &
i8237_sysdev_şass
,

64 
__š™
 
	$i8237A_š™_sysfs
()

66 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
i8237_sysdev_şass
);

67 ià(!
”rÜ
)

68 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_i8237A
);

69  
”rÜ
;

70 
	}
}

71 
deviû_š™ÿÎ
(
i8237A_š™_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<lšux/şockchs.h
>

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/¥šlock.h
>

8 
	~<lšux/jiff›s.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/d–ay.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/io.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/h³t.h
>

16 
	~<asm/smp.h
>

18 
DEFINE_SPINLOCK
(
i8253_lock
);

19 
EXPORT_SYMBOL
(
i8253_lock
);

21 #ifdeà
CONFIG_X86_32


22 
p™_di§bË_şocksourû
();

24 
šlše
 
	$p™_di§bË_şocksourû
(è{ 
	}
}

31 
şock_ev’t_deviû
 *
	gglob®_şock_ev’t
;

38 
	$š™_p™_tim”
(
şock_ev’t_mode
 
mode
,

39 
şock_ev’t_deviû
 *
evt
)

41 
	`¥š_lock
(&
i8253_lock
);

43 
mode
) {

44 
CLOCK_EVT_MODE_PERIODIC
:

46 
	`outb_p™
(0x34, 
PIT_MODE
);

47 
	`outb_p™
(
LATCH
 & 0xfà, 
PIT_CH0
);

48 
	`outb_p™
(
LATCH
 >> 8 , 
PIT_CH0
);

51 
CLOCK_EVT_MODE_SHUTDOWN
:

52 
CLOCK_EVT_MODE_UNUSED
:

53 ià(
evt
->
mode
 =ğ
CLOCK_EVT_MODE_PERIODIC
 ||

54 
evt
->
mode
 =ğ
CLOCK_EVT_MODE_ONESHOT
) {

55 
	`outb_p™
(0x30, 
PIT_MODE
);

56 
	`outb_p™
(0, 
PIT_CH0
);

57 
	`outb_p™
(0, 
PIT_CH0
);

59 
	`p™_di§bË_şocksourû
();

62 
CLOCK_EVT_MODE_ONESHOT
:

64 
	`p™_di§bË_şocksourû
();

65 
	`outb_p™
(0x38, 
PIT_MODE
);

68 
CLOCK_EVT_MODE_RESUME
:

72 
	`¥š_uÆock
(&
i8253_lock
);

73 
	}
}

80 
	$p™_Ãxt_ev’t
(
d–
, 
şock_ev’t_deviû
 *
evt
)

82 
	`¥š_lock
(&
i8253_lock
);

83 
	`outb_p™
(
d–
 & 0xfà, 
PIT_CH0
);

84 
	`outb_p™
(
d–
 >> 8 , 
PIT_CH0
);

85 
	`¥š_uÆock
(&
i8253_lock
);

88 
	}
}

98 
şock_ev’t_deviû
 
	gp™_û
 = {

99 .
Çme
 = "pit",

100 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

101 .
	g£t_mode
 = 
š™_p™_tim”
,

102 .
	g£t_Ãxt_ev’t
 = 
p™_Ãxt_ev’t
,

103 .
	gshiá
 = 32,

104 .
	gœq
 = 0,

111 
__š™
 
	$£tup_p™_tim”
()

117 
p™_û
.
ıumask
 = 
	`ıumask_of
(
	`smp_´oûssÜ_id
());

118 
p™_û
.
muÉ
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,…™_û.
shiá
);

119 
p™_û
.
max_d–_ns
 = 
	`şockev’t_d–2ns
(0x7FFF, &pit_ce);

120 
p™_û
.
mš_d–_ns
 = 
	`şockev’t_d–2ns
(0xF, &pit_ce);

122 
	`şockev’ts_»gi¡”_deviû
(&
p™_û
);

123 
glob®_şock_ev’t
 = &
p™_û
;

124 
	}
}

126 #iâdeà
CONFIG_X86_64


132 
cyşe_t
 
	$p™_»ad
(
şocksourû
 *
cs
)

134 
Şd_couÁ
;

135 
u32
 
Şd_jifs
;

136 
æags
;

137 
couÁ
;

138 
u32
 
jifs
;

140 
	`¥š_lock_œq§ve
(&
i8253_lock
, 
æags
);

154 
jifs
 = 
jiff›s
;

155 
	`outb_p™
(0x00, 
PIT_MODE
);

156 
couÁ
 = 
	`šb_p™
(
PIT_CH0
);

157 
couÁ
 |ğ
	`šb_p™
(
PIT_CH0
) << 8;

160 ià(
couÁ
 > 
LATCH
) {

161 
	`outb_p™
(0x34, 
PIT_MODE
);

162 
	`outb_p™
(
LATCH
 & 0xff, 
PIT_CH0
);

163 
	`outb_p™
(
LATCH
 >> 8, 
PIT_CH0
);

164 
couÁ
 = 
LATCH
 - 1;

180 ià(
couÁ
 > 
Şd_couÁ
 && 
jifs
 =ğ
Şd_jifs
)

181 
couÁ
 = 
Şd_couÁ
;

183 
Şd_couÁ
 = 
couÁ
;

184 
Şd_jifs
 = 
jifs
;

186 
	`¥š_uÆock_œq»¡Üe
(&
i8253_lock
, 
æags
);

188 
couÁ
 = (
LATCH
 - 1) - count;

190  (
cyşe_t
)(
jifs
 * 
LATCH
è+ 
couÁ
;

191 
	}
}

193 
şocksourû
 
	gp™_cs
 = {

194 .
Çme
 = "pit",

195 .
	g¿tšg
 = 110,

196 .
	g»ad
 = 
p™_»ad
,

197 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

198 .
	gmuÉ
 = 0,

199 .
	gshiá
 = 20,

202 
	$p™_di§bË_şocksourû
()

207 ià(
p™_cs
.
muÉ
) {

208 
	`şocksourû_uÄegi¡”
(&
p™_cs
);

209 
p™_cs
.
muÉ
 = 0;

211 
	}
}

213 
__š™
 
	$š™_p™_şocksourû
()

222 ià(
	`num_possibË_ıus
(è> 1 || 
	`is_h³t_’abËd
() ||

223 
p™_û
.
mode
 !ğ
CLOCK_EVT_MODE_PERIODIC
)

226 
p™_cs
.
muÉ
 = 
	`şocksourû_hz2muÉ
(
CLOCK_TICK_RATE
,…™_cs.
shiá
);

228  
	`şocksourû_»gi¡”
(&
p™_cs
);

229 
	}
}

230 
¬ch_š™ÿÎ
(
š™_p™_şocksourû
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<lšux/lškage.h
>

2 
	~<lšux/”ºo.h
>

3 
	~<lšux/sigÇl.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/iİÜt.h
>

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/timex.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¿ndom.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/k”Ãl_¡©.h
>

12 
	~<lšux/sysdev.h
>

13 
	~<lšux/b™İs.h
>

14 
	~<lšux/aıi.h
>

15 
	~<lšux/io.h
>

16 
	~<lšux/d–ay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/tim”.h
>

21 
	~<asm/hw_œq.h
>

22 
	~<asm/pgbË.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/­ic.h
>

25 
	~<asm/i8259.h
>

34 
	gi8259A_auto_eoi
;

35 
DEFINE_SPINLOCK
(
i8259A_lock
);

36 
mask_ªd_ack_8259A
();

38 
œq_ch
 
	gi8259A_ch
 = {

39 .
Çme
 = "XT-PIC",

40 .
	gmask
 = 
di§bË_8259A_œq
,

41 .
	gdi§bË
 = 
di§bË_8259A_œq
,

42 .
	gunmask
 = 
’abË_8259A_œq
,

43 .
	gmask_ack
 = 
mask_ªd_ack_8259A
,

53 
	gÿched_œq_mask
 = 0xffff;

64 
	gio_­ic_œqs
;

66 
	$di§bË_8259A_œq
(
œq
)

68 
mask
 = 1 << 
œq
;

69 
æags
;

71 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

72 
ÿched_œq_mask
 |ğ
mask
;

73 ià(
œq
 & 8)

74 
	`outb
(
ÿched_¦ave_mask
, 
PIC_SLAVE_IMR
);

76 
	`outb
(
ÿched_ma¡”_mask
, 
PIC_MASTER_IMR
);

77 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

78 
	}
}

80 
	$’abË_8259A_œq
(
œq
)

82 
mask
 = ~(1 << 
œq
);

83 
æags
;

85 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

86 
ÿched_œq_mask
 &ğ
mask
;

87 ià(
œq
 & 8)

88 
	`outb
(
ÿched_¦ave_mask
, 
PIC_SLAVE_IMR
);

90 
	`outb
(
ÿched_ma¡”_mask
, 
PIC_MASTER_IMR
);

91 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

92 
	}
}

94 
	$i8259A_œq_³ndšg
(
œq
)

96 
mask
 = 1<<
œq
;

97 
æags
;

98 
»t
;

100 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

101 ià(
œq
 < 8)

102 
»t
 = 
	`šb
(
PIC_MASTER_CMD
è& 
mask
;

104 
»t
 = 
	`šb
(
PIC_SLAVE_CMD
è& (
mask
 >> 8);

105 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

107  
»t
;

108 
	}
}

110 
	$make_8259A_œq
(
œq
)

112 
	`di§bË_œq_nosync
(
œq
);

113 
io_­ic_œqs
 &ğ~(1<<
œq
);

114 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
i8259A_ch
, 
hªdË_Ëv–_œq
,

116 
	`’abË_œq
(
œq
);

117 
	}
}

125 
šlše
 
	$i8259A_œq_»®
(
œq
)

127 
v®ue
;

128 
œqmask
 = 1<<
œq
;

130 ià(
œq
 < 8) {

131 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

132 
v®ue
 = 
	`šb
(
PIC_MASTER_CMD
è& 
œqmask
;

133 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

134  
v®ue
;

136 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

137 
v®ue
 = 
	`šb
(
PIC_SLAVE_CMD
è& (
œqmask
 >> 8);

138 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

139  
v®ue
;

140 
	}
}

148 
	$mask_ªd_ack_8259A
(
œq
)

150 
œqmask
 = 1 << 
œq
;

151 
æags
;

153 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

169 ià(
ÿched_œq_mask
 & 
œqmask
)

170 
¥urious_8259A_œq
;

171 
ÿched_œq_mask
 |ğ
œqmask
;

173 
hªdË_»®_œq
:

174 ià(
œq
 & 8) {

175 
	`šb
(
PIC_SLAVE_IMR
);

176 
	`outb
(
ÿched_¦ave_mask
, 
PIC_SLAVE_IMR
);

178 
	`outb
(0x60+(
œq
&7), 
PIC_SLAVE_CMD
);

180 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

182 
	`šb
(
PIC_MASTER_IMR
);

183 
	`outb
(
ÿched_ma¡”_mask
, 
PIC_MASTER_IMR
);

184 
	`outb
(0x60+
œq
, 
PIC_MASTER_CMD
);

186 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

189 
¥urious_8259A_œq
:

193 ià(
	`i8259A_œq_»®
(
œq
))

198 
hªdË_»®_œq
;

201 
¥urious_œq_mask
;

206 ià(!(
¥urious_œq_mask
 & 
œqmask
)) {

207 
	`´štk
(
KERN_DEBUG


208 "¥uriou 8259A iÁ”ru±: IRQ%d.\n", 
œq
);

209 
¥urious_œq_mask
 |ğ
œqmask
;

211 
	`©omic_šc
(&
œq_”r_couÁ
);

217 
hªdË_»®_œq
;

219 
	}
}

221 
	gœq_Œigg”
[2];

225 
	$»¡Üe_ELCR
(*
Œigg”
)

227 
	`outb
(
Œigg”
[0], 0x4d0);

228 
	`outb
(
Œigg”
[1], 0x4d1);

229 
	}
}

231 
	$§ve_ELCR
(*
Œigg”
)

234 
Œigg”
[0] = 
	`šb
(0x4d0) & 0xF8;

235 
Œigg”
[1] = 
	`šb
(0x4d1) & 0xDE;

236 
	}
}

238 
	$i8259A_»sume
(
sys_deviû
 *
dev
)

240 
	`š™_8259A
(
i8259A_auto_eoi
);

241 
	`»¡Üe_ELCR
(
œq_Œigg”
);

243 
	}
}

245 
	$i8259A_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

247 
	`§ve_ELCR
(
œq_Œigg”
);

249 
	}
}

251 
	$i8259A_shutdown
(
sys_deviû
 *
dev
)

257 
	`outb
(0xff, 
PIC_MASTER_IMR
);

258 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

260 
	}
}

262 
sysdev_şass
 
	gi8259_sysdev_şass
 = {

263 .
Çme
 = "i8259",

264 .
	gsu¥’d
 = 
i8259A_su¥’d
,

265 .
	g»sume
 = 
i8259A_»sume
,

266 .
	gshutdown
 = 
i8259A_shutdown
,

269 
sys_deviû
 
	gdeviû_i8259A
 = {

270 .
id
 = 0,

271 .
	gşs
 = &
i8259_sysdev_şass
,

274 
__š™
 
	$i8259A_š™_sysfs
()

276 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
i8259_sysdev_şass
);

277 ià(!
”rÜ
)

278 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_i8259A
);

279  
”rÜ
;

280 
	}
}

282 
deviû_š™ÿÎ
(
i8259A_š™_sysfs
);

284 
	$mask_8259A
()

286 
æags
;

288 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

290 
	`outb
(0xff, 
PIC_MASTER_IMR
);

291 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

293 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

294 
	}
}

296 
	$unmask_8259A
()

298 
æags
;

300 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

302 
	`outb
(
ÿched_ma¡”_mask
, 
PIC_MASTER_IMR
);

303 
	`outb
(
ÿched_¦ave_mask
, 
PIC_SLAVE_IMR
);

305 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

306 
	}
}

308 
	$š™_8259A
(
auto_eoi
)

310 
æags
;

312 
i8259A_auto_eoi
 = 
auto_eoi
;

314 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

316 
	`outb
(0xff, 
PIC_MASTER_IMR
);

317 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

322 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

326 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

329 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

331 ià(
auto_eoi
)

332 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

334 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

336 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

339 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

341 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

343 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

345 ià(
auto_eoi
)

350 
i8259A_ch
.
mask_ack
 = 
di§bË_8259A_œq
;

352 
i8259A_ch
.
mask_ack
 = 
mask_ªd_ack_8259A
;

354 
	`ud–ay
(100);

356 
	`outb
(
ÿched_ma¡”_mask
, 
PIC_MASTER_IMR
);

357 
	`outb
(
ÿched_¦ave_mask
, 
PIC_SLAVE_IMR
);

359 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<lšux/mm.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/sched.h
>

4 
	~<lšux/š™.h
>

5 
	~<lšux/š™_sk.h
>

6 
	~<lšux/fs.h
>

7 
	~<lšux/mqueue.h
>

9 
	~<asm/uacûss.h
>

10 
	~<asm/pgbË.h
>

11 
	~<asm/desc.h
>

13 
sigÇl_¡ruù
 
	gš™_sigÇls
 = 
INIT_SIGNALS
(
š™_sigÇls
);

14 
sighªd_¡ruù
 
	gš™_sighªd
 = 
INIT_SIGHAND
(
š™_sighªd
);

15 
mm_¡ruù
 
	gš™_mm
 = 
INIT_MM
(
š™_mm
);

24 
th»ad_uniÚ
 
š™_th»ad_uniÚ


25 
__©Œibu‹__
((
__£ùiÚ__
(".data.init_task"))) =

26 { 
INIT_THREAD_INFO
(
š™_sk
) };

33 
sk_¡ruù
 
	gš™_sk
 = 
INIT_TASK
(
š™_sk
);

34 
EXPORT_SYMBOL
(
š™_sk
);

43 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_¡ruù
, 
š™_tss
èğ
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/d–ay.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/dmi.h
>

13 
	~<lšux/io.h
>

15 
io_d–ay_ty³
 
	g__»ad_mo¡ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__š™d©a
 
	gio_d–ay_ov”ride
;

22 
	$Çtive_io_d–ay
()

24 
io_d–ay_ty³
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`ud–ay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
Çtive_io_d–ay
);

47 
__š™
 
	$dmi_io_d–ay_0xed_pÜt
(cÚ¡ 
dmi_sy¡em_id
 *
id
)

49 ià(
io_d–ay_ty³
 =ğ
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`´_nÙiû
("%s: usšg 0xed I/O d–ay…Üt\n", 
id
->
id’t
);

51 
io_d–ay_ty³
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy¡em_id
 
__š™d©a
 
	gio_d–ay_0xed_pÜt_dmi_bË
[] = {

63 .
ÿÎback
 = 
dmi_io_d–ay_0xed_pÜt
,

64 .
	gid’t
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gÿÎback
 = 
dmi_io_d–ay_0xed_pÜt
,

72 .
	gid’t
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gÿÎback
 = 
dmi_io_d–ay_0xed_pÜt
,

80 .
	gid’t
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gÿÎback
 = 
dmi_io_d–ay_0xed_pÜt
,

88 .
	gid’t
 = "HP Pavilionx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gÿÎback
 = 
dmi_io_d–ay_0xed_pÜt
,

96 .
	gid’t
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__š™
 
	$io_d–ay_š™
()

107 ià(!
io_d–ay_ov”ride
)

108 
	`dmi_check_sy¡em
(
io_d–ay_0xed_pÜt_dmi_bË
);

109 
	}
}

111 
__š™
 
	$io_d–ay_·¿m
(*
s
)

113 ià(!
s
)

114  -
EINVAL
;

116 ià(!
	`¡rcmp
(
s
, "0x80"))

117 
io_d–ay_ty³
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 ià(!
	`¡rcmp
(
s
, "0xed"))

119 
io_d–ay_ty³
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 ià(!
	`¡rcmp
(
s
, "udelay"))

121 
io_d–ay_ty³
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 ià(!
	`¡rcmp
(
s
, "none"))

123 
io_d–ay_ty³
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_d–ay_ov”ride
 = 1;

129 
	}
}

131 
—¾y_·¿m
("io_d–ay", 
io_d–ay_·¿m
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/ÿ·b™y.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/ty³s.h
>

11 
	~<lšux/iİÜt.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/¡ddef.h
>

14 
	~<lšux/¦ab.h
>

15 
	~<lšux/th»ad_šfo.h
>

16 
	~<lšux/sysÿÎs.h
>

17 
	~<asm/sysÿÎs.h
>

20 
	$£t_b™m­
(*
b™m­
, 
ba£
,

21 
ex‹Á
, 
Ãw_v®ue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
ex‹Á
; i++) {

26 ià(
Ãw_v®ue
)

27 
	`__£t_b™
(
i
, 
b™m­
);

29 
	`__ş—r_b™
(
i
, 
b™m­
);

31 
	}
}

36 
asmlškage
 
	$sys_iİ”m
(
äom
, 
num
, 
tuº_Ú
)

38 
th»ad_¡ruù
 *
t
 = &
cu¼’t
->
th»ad
;

39 
tss_¡ruù
 *
tss
;

40 
i
, 
max_lÚg
, 
by‹s
, 
by‹s_upd©ed
;

42 ià((
äom
 + 
num
 <ğäomè|| (äom +‚um > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 ià(
tuº_Ú
 && !
	`ÿ·bË
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 ià(!
t
->
io_b™m­_±r
) {

53 *
b™m­
 = 
	`km®loc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 ià(!
b™m­
)

56  -
ENOMEM
;

58 
	`mem£t
(
b™m­
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_b™m­_±r
 = 
b™m­
;

60 
	`£t_th»ad_æag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`³r_ıu
(
š™_tss
, 
	`g‘_ıu
());

72 
	`£t_b™m­
(
t
->
io_b™m­_±r
, 
äom
, 
num
, !
tuº_Ú
);

78 
max_lÚg
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 ià(
t
->
io_b™m­_±r
[
i
] != ~0UL)

81 
max_lÚg
 = 
i
;

83 
by‹s
 = (
max_lÚg
 + 1) * ();

84 
by‹s_upd©ed
 = 
	`max
(
by‹s
, 
t
->
io_b™m­_max
);

86 
t
->
io_b™m­_max
 = 
by‹s
;

89 
	`memıy
(
tss
->
io_b™m­
, 
t
->
io_b™m­_±r
, 
by‹s_upd©ed
);

91 
	`put_ıu
();

94 
	}
}

106 
	$do_iİl
(
Ëv–
, 
±_»gs
 *
»gs
)

108 
Şd
 = (
»gs
->
æags
 >> 12) & 3;

110 ià(
Ëv–
 > 3)

111  -
EINVAL
;

113 ià(
Ëv–
 > 
Şd
) {

114 ià(!
	`ÿ·bË
(
CAP_SYS_RAWIO
))

115  -
EPERM
;

117 
»gs
->
æags
 = (»gs->æag & ~
X86_EFLAGS_IOPL
è| (
Ëv–
 << 12);

120 
	}
}

122 #ifdeà
CONFIG_X86_32


123 
	$sys_iİl
(
±_»gs
 *
»gs
)

125 
Ëv–
 = 
»gs
->
bx
;

126 
th»ad_¡ruù
 *
t
 = &
cu¼’t
->
th»ad
;

127 
rc
;

129 
rc
 = 
	`do_iİl
(
Ëv–
, 
»gs
);

130 ià(
rc
 < 0)

131 
out
;

133 
t
->
iİl
 = 
Ëv–
 << 12;

134 
	`£t_iİl_mask
(
t
->
iİl
);

135 
out
:

136  
rc
;

137 
	}
}

139 
asmlškage
 
	$sys_iİl
(
Ëv–
, 
±_»gs
 *
»gs
)

141  
	`do_iİl
(
Ëv–
, 
»gs
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<lšux/ıu.h
>

5 
	~<lšux/š‹¼u±.h
>

6 
	~<lšux/k”Ãl_¡©.h
>

7 
	~<lšux/£q_fe.h
>

8 
	~<lšux/smp.h
>

9 
	~<lšux/á¿û.h
>

11 
	~<asm/­ic.h
>

12 
	~<asm/io_­ic.h
>

13 
	~<asm/œq.h
>

14 
	~<asm/idË.h
>

16 
©omic_t
 
	gœq_”r_couÁ
;

19 (*
g’”ic_š‹¼u±_ex‹nsiÚ
)(èğ
NULL
;

25 
	$ack_bad_œq
(
œq
)

27 
	`´štk
(
KERN_ERR
 "uÃx³ùed IRQ¿°© veùÜ %02x\n", 
œq
);

29 #ifdeà
CONFIG_X86_LOCAL_APIC


39 ià(
ıu_has_­ic
)

40 
	`ack_APIC_œq
();

42 
	}
}

44 
	#œq_¡©s
(
x
è(&
	`³r_ıu
(
œq_¡©
, x))

	)

48 
	$show_Ùh”_š‹¼u±s
(
£q_fe
 *
p
, 
´ec
)

50 
j
;

52 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "NMI");

53 
	`fÜ_—ch_Úlše_ıu
(
j
)

54 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
__nmi_couÁ
);

55 
	`£q_´štf
(
p
, " Non-maskable interrupts\n");

56 #ifdeà
CONFIG_X86_LOCAL_APIC


57 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "LOC");

58 
	`fÜ_—ch_Úlše_ıu
(
j
)

59 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
­ic_tim”_œqs
);

60 
	`£q_´štf
(
p
, " Localimer interrupts\n");

62 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "SPU");

63 
	`fÜ_—ch_Úlše_ıu
(
j
)

64 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_¥urious_couÁ
);

65 
	`£q_´štf
(
p
, " Spurious interrupts\n");

67 ià(
g’”ic_š‹¼u±_ex‹nsiÚ
) {

68 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "PLT");

69 
	`fÜ_—ch_Úlše_ıu
(
j
)

70 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
g’”ic_œqs
);

71 
	`£q_´štf
(
p
, " Platform interrupts\n");

73 #ifdeà
CONFIG_SMP


74 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "RES");

75 
	`fÜ_—ch_Úlše_ıu
(
j
)

76 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_»sched_couÁ
);

77 
	`£q_´štf
(
p
, " Rescheduling interrupts\n");

78 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "CAL");

79 
	`fÜ_—ch_Úlše_ıu
(
j
)

80 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_ÿÎ_couÁ
);

81 
	`£q_´štf
(
p
, " Function call interrupts\n");

82 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "TLB");

83 
	`fÜ_—ch_Úlše_ıu
(
j
)

84 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_b_couÁ
);

85 
	`£q_´štf
(
p
, " TLB shootdowns\n");

87 #ifdeà
CONFIG_X86_MCE


88 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "TRM");

89 
	`fÜ_—ch_Úlše_ıu
(
j
)

90 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_th”m®_couÁ
);

91 
	`£q_´štf
(
p
, " Thermalƒvent interrupts\n");

92 #ifdeà
CONFIG_X86_64


93 
	`£q_´štf
(
p
, "%*s: ", 
´ec
, "THR");

94 
	`fÜ_—ch_Úlše_ıu
(
j
)

95 
	`£q_´štf
(
p
, "%10u ", 
	`œq_¡©s
(
j
)->
œq_th»shŞd_couÁ
);

96 
	`£q_´štf
(
p
, " Threshold APIC interrupts\n");

99 
	`£q_´štf
(
p
, "%*s: %10u\n", 
´ec
, "ERR", 
	`©omic_»ad
(&
œq_”r_couÁ
));

100 #ià
	`defšed
(
CONFIG_X86_IO_APIC
)

101 
	`£q_´štf
(
p
, "%*s: %10u\n", 
´ec
, "MIS", 
	`©omic_»ad
(&
œq_mis_couÁ
));

104 
	}
}

106 
	$show_š‹¼u±s
(
£q_fe
 *
p
, *
v
)

108 
æags
, 
ªy_couÁ
 = 0;

109 
i
 = *(
loff_t
 *è
v
, 
j
, 
´ec
;

110 
œqaùiÚ
 *
aùiÚ
;

111 
œq_desc
 *
desc
;

113 ià(
i
 > 
Ä_œqs
)

116 
´ec
 = 3, 
j
 = 1000;…»ø< 10 && j <ğ
Ä_œqs
; ++prec)

117 
j
 *= 10;

119 ià(
i
 =ğ
Ä_œqs
)

120  
	`show_Ùh”_š‹¼u±s
(
p
, 
´ec
);

123 ià(
i
 == 0) {

124 
	`£q_´štf
(
p
, "%*s", 
´ec
 + 8, "");

125 
	`fÜ_—ch_Úlše_ıu
(
j
)

126 
	`£q_´štf
(
p
, "CPU%-8d", 
j
);

127 
	`£q_putc
(
p
, '\n');

130 
desc
 = 
	`œq_to_desc
(
i
);

131 ià(!
desc
)

134 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

135 
	`fÜ_—ch_Úlše_ıu
(
j
)

136 
ªy_couÁ
 |ğ
	`k¡©_œqs_ıu
(
i
, 
j
);

137 
aùiÚ
 = 
desc
->action;

138 ià(!
aùiÚ
 && !
ªy_couÁ
)

139 
out
;

141 
	`£q_´štf
(
p
, "%*d: ", 
´ec
, 
i
);

142 
	`fÜ_—ch_Úlše_ıu
(
j
)

143 
	`£q_´štf
(
p
, "%10u ", 
	`k¡©_œqs_ıu
(
i
, 
j
));

144 
	`£q_´štf
(
p
, " %8s", 
desc
->
ch
->
Çme
);

145 
	`£q_´štf
(
p
, "-%-8s", 
desc
->
Çme
);

147 ià(
aùiÚ
) {

148 
	`£q_´štf
(
p
, " %s", 
aùiÚ
->
Çme
);

149 (
aùiÚ
 =‡ùiÚ->
Ãxt
è!ğ
NULL
)

150 
	`£q_´štf
(
p
, ", %s", 
aùiÚ
->
Çme
);

153 
	`£q_putc
(
p
, '\n');

154 
out
:

155 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

157 
	}
}

162 
u64
 
	$¬ch_œq_¡©_ıu
(
ıu
)

164 
u64
 
sum
 = 
	`œq_¡©s
(
ıu
)->
__nmi_couÁ
;

166 #ifdeà
CONFIG_X86_LOCAL_APIC


167 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
­ic_tim”_œqs
;

168 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_¥urious_couÁ
;

170 ià(
g’”ic_š‹¼u±_ex‹nsiÚ
)

171 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
g’”ic_œqs
;

172 #ifdeà
CONFIG_SMP


173 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_»sched_couÁ
;

174 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_ÿÎ_couÁ
;

175 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_b_couÁ
;

177 #ifdeà
CONFIG_X86_MCE


178 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_th”m®_couÁ
;

179 #ifdeà
CONFIG_X86_64


180 
sum
 +ğ
	`œq_¡©s
(
ıu
)->
œq_th»shŞd_couÁ
;

183  
sum
;

184 
	}
}

186 
u64
 
	$¬ch_œq_¡©
()

188 
u64
 
sum
 = 
	`©omic_»ad
(&
œq_”r_couÁ
);

190 #ifdeà
CONFIG_X86_IO_APIC


191 
sum
 +ğ
	`©omic_»ad
(&
œq_mis_couÁ
);

193  
sum
;

194 
	}
}

202 
__œq_’Œy
 
	$do_IRQ
(
±_»gs
 *
»gs
)

204 
±_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

207 
veùÜ
 = ~
»gs
->
Üig_ax
;

208 
œq
;

210 
	`ex™_idË
();

211 
	`œq_’‹r
();

213 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
];

215 ià(!
	`hªdË_œq
(
œq
, 
»gs
)) {

216 #ifdeà
CONFIG_X86_64


217 ià(!
di§bË_­ic
)

218 
	`ack_APIC_œq
();

221 ià(
	`´štk_¿‹lim™
())

222 
	`´štk
(
KERN_EMERG
 "%s: %d.%d No irq handler for vector (irq %d)\n",

223 
__func__
, 
	`smp_´oûssÜ_id
(), 
veùÜ
, 
œq
);

226 
	`œq_ex™
();

228 
	`£t_œq_»gs
(
Şd_»gs
);

230 
	}
}

235 
	$smp_g’”ic_š‹¼u±
(
±_»gs
 *
»gs
)

237 
±_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

239 
	`ack_APIC_œq
();

241 
	`ex™_idË
();

243 
	`œq_’‹r
();

245 
	`šc_œq_¡©
(
g’”ic_œqs
);

247 ià(
g’”ic_š‹¼u±_ex‹nsiÚ
)

248 
	`g’”ic_š‹¼u±_ex‹nsiÚ
();

250 
	`œq_ex™
();

252 
	`£t_œq_»gs
(
Şd_»gs
);

253 
	}
}

255 
EXPORT_SYMBOL_GPL
(
veùÜ_u£d_by_³rıu_œq
);

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<lšux/k”Ãl_¡©.h
>

12 
	~<lšux/š‹¼u±.h
>

13 
	~<lšux/£q_fe.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/á¿û.h
>

17 
	~<lšux/uacûss.h
>

18 
	~<lšux/smp.h
>

19 
	~<asm/io_­ic.h
>

20 
	~<asm/idË.h
>

21 
	~<asm/­ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
œq_ıu¡©_t
, 
œq_¡©
);

24 
EXPORT_PER_CPU_SYMBOL
(
œq_¡©
);

26 
DEFINE_PER_CPU
(
±_»gs
 *, 
œq_»gs
);

27 
EXPORT_PER_CPU_SYMBOL
(
œq_»gs
);

36 
šlše
 
	$¡ack_ov”æow_check
(
±_»gs
 *
»gs
)

38 #ifdeà
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`sk_¡ack_·ge
(
cu¼’t
);

41 
	`WARN_ONCE
(
»gs
->
¥
 >ğ
curba£
 &&

42 
»gs
->
¥
 <ğ
curba£
 + 
THREAD_SIZE
 &&

43 
»gs
->
¥
 < 
curba£
 + (
th»ad_šfo
) +

44 (
±_»gs
) + 128,

47 
cu¼’t
->
comm
, 
curba£
, 
»gs
->
¥
);

49 
	}
}

51 
boŞ
 
	$hªdË_œq
(
œq
, 
±_»gs
 *
»gs
)

53 
œq_desc
 *
desc
;

55 
	`¡ack_ov”æow_check
(
»gs
);

57 
desc
 = 
	`œq_to_desc
(
œq
);

58 ià(
	`uÆik–y
(!
desc
))

59  
çl£
;

61 
	`g’”ic_hªdË_œq_desc
(
œq
, 
desc
);

62  
Œue
;

63 
	}
}

65 #ifdeà
CONFIG_HOTPLUG_CPU


67 
	$fixup_œqs
()

69 
œq
;

70 
w¬Ãd
;

71 
œq_desc
 *
desc
;

73 
	`fÜ_—ch_œq_desc
(
œq
, 
desc
) {

74 
b»ak_affš™y
 = 0;

75 
£t_affš™y
 = 1;

76 cÚ¡ 
ıumask
 *
affš™y
;

78 ià(!
desc
)

80 ià(
œq
 == 2)

84 
	`¥š_lock
(&
desc
->
lock
);

86 
affš™y
 = 
desc
->affinity;

87 ià(!
	`œq_has_aùiÚ
(
œq
) ||

88 
	`ıumask_equ®
(
affš™y
, 
ıu_Úlše_mask
)) {

89 
	`¥š_uÆock
(&
desc
->
lock
);

93 ià(
	`ıumask_ªy_ªd
(
affš™y
, 
ıu_Úlše_mask
è>ğ
Ä_ıu_ids
) {

94 
b»ak_affš™y
 = 1;

95 
affš™y
 = 
ıu_®l_mask
;

98 ià(
desc
->
ch
->
mask
)

99 
desc
->
ch
->
	`mask
(
œq
);

101 ià(
desc
->
ch
->
£t_affš™y
)

102 
desc
->
ch
->
	`£t_affš™y
(
œq
, 
affš™y
);

103 ià(!(
w¬Ãd
++))

104 
£t_affš™y
 = 0;

106 ià(
desc
->
ch
->
unmask
)

107 
desc
->
ch
->
	`unmask
(
œq
);

109 
	`¥š_uÆock
(&
desc
->
lock
);

111 ià(
b»ak_affš™y
 && 
£t_affš™y
)

112 
	`´štk
("Brokaffš™y fÜ irq %i\n", 
œq
);

113 ià(!
£t_affš™y
)

114 
	`´štk
("CªnÙ s‘‡ffš™y fÜ irq %i\n", 
œq
);

118 
	`loÿl_œq_’abË
();

119 
	`md–ay
(1);

120 
	`loÿl_œq_di§bË
();

121 
	}
}

124 
ÿÎ_soáœq
();

126 
asmlškage
 
	$do_soáœq
()

128 
__u32
 
³ndšg
;

129 
æags
;

131 ià(
	`š_š‹¼u±
())

134 
	`loÿl_œq_§ve
(
æags
);

135 
³ndšg
 = 
	`loÿl_soáœq_³ndšg
();

137 ià(
³ndšg
) {

138 
	`ÿÎ_soáœq
();

139 
	`WARN_ON_ONCE
(
	`soáœq_couÁ
());

141 
	`loÿl_œq_»¡Üe
(
æags
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit_64.c

1 
	~<lšux/lškage.h
>

2 
	~<lšux/”ºo.h
>

3 
	~<lšux/sigÇl.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/iİÜt.h
>

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/timex.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¿ndom.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/k”Ãl_¡©.h
>

12 
	~<lšux/sysdev.h
>

13 
	~<lšux/b™İs.h
>

14 
	~<lšux/aıi.h
>

15 
	~<lšux/io.h
>

16 
	~<lšux/d–ay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/hw_œq.h
>

21 
	~<asm/pgbË.h
>

22 
	~<asm/desc.h
>

23 
	~<asm/­ic.h
>

24 
	~<asm/i8259.h
>

46 
œqaùiÚ
 
	gœq2
 = {

47 .
hªdËr
 = 
no_aùiÚ
,

48 .
	gÇme
 = "cascade",

50 
DEFINE_PER_CPU
(
veùÜ_œq_t
, 
veùÜ_œq
) = {

51 [0 ... 
IRQ0_VECTOR
 - 1] = -1,

52 [
IRQ0_VECTOR
] = 0,

53 [
IRQ1_VECTOR
] = 1,

54 [
IRQ2_VECTOR
] = 2,

55 [
IRQ3_VECTOR
] = 3,

56 [
IRQ4_VECTOR
] = 4,

57 [
IRQ5_VECTOR
] = 5,

58 [
IRQ6_VECTOR
] = 6,

59 [
IRQ7_VECTOR
] = 7,

60 [
IRQ8_VECTOR
] = 8,

61 [
IRQ9_VECTOR
] = 9,

62 [
IRQ10_VECTOR
] = 10,

63 [
IRQ11_VECTOR
] = 11,

64 [
IRQ12_VECTOR
] = 12,

65 [
IRQ13_VECTOR
] = 13,

66 [
IRQ14_VECTOR
] = 14,

67 [
IRQ15_VECTOR
] = 15,

68 [
IRQ15_VECTOR
 + 1 ... 
NR_VECTORS
 - 1] = -1

71 
	$veùÜ_u£d_by_³rıu_œq
(
veùÜ
)

73 
ıu
;

75 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

76 ià(
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] != -1)

81 
	}
}

83 
__š™
 
	$š™_ISA_œqs
()

85 
i
;

87 
	`š™_b¥_APIC
();

88 
	`š™_8259A
(0);

90 
i
 = 0; i < 
NR_IRQS_LEGACY
; i++) {

91 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
i
);

93 
desc
->
¡©us
 = 
IRQ_DISABLED
;

94 
desc
->
aùiÚ
 = 
NULL
;

95 
desc
->
d•th
 = 1;

100 
	`£t_œq_ch_ªd_hªdËr_Çme
(
i
, &
i8259A_ch
,

101 
hªdË_Ëv–_œq
, "XT");

103 
	}
}

105 
	$š™_IRQ
(è
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("native_init_IRQ")));

107 
__š™
 
	$smp_šŒ_š™
()

109 #ifdeà
CONFIG_SMP


114 
	`®loc_šŒ_g©e
(
RESCHEDULE_VECTOR
, 
»scheduË_š‹¼u±
);

117 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
šv®id©e_š‹¼u±0
);

118 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
šv®id©e_š‹¼u±1
);

119 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
šv®id©e_š‹¼u±2
);

120 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
šv®id©e_š‹¼u±3
);

121 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
šv®id©e_š‹¼u±4
);

122 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
šv®id©e_š‹¼u±5
);

123 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
šv®id©e_š‹¼u±6
);

124 
	`®loc_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
šv®id©e_š‹¼u±7
);

127 
	`®loc_šŒ_g©e
(
CALL_FUNCTION_VECTOR
, 
ÿÎ_funùiÚ_š‹¼u±
);

130 
	`®loc_šŒ_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

131 
ÿÎ_funùiÚ_sšgË_š‹¼u±
);

134 
	`£t_šŒ_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
œq_move_ş—nup_š‹¼u±
);

135 
	`£t_b™
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_veùÜs
);

137 
	}
}

139 
__š™
 
	$­ic_šŒ_š™
()

141 
	`smp_šŒ_š™
();

143 
	`®loc_šŒ_g©e
(
THERMAL_APIC_VECTOR
, 
th”m®_š‹¼u±
);

144 
	`®loc_šŒ_g©e
(
THRESHOLD_APIC_VECTOR
, 
th»shŞd_š‹¼u±
);

147 
	`®loc_šŒ_g©e
(
LOCAL_TIMER_VECTOR
, 
­ic_tim”_š‹¼u±
);

150 
	`®loc_šŒ_g©e
(
GENERIC_INTERRUPT_VECTOR
, 
g’”ic_š‹¼u±
);

153 
	`®loc_šŒ_g©e
(
SPURIOUS_APIC_VECTOR
, 
¥urious_š‹¼u±
);

154 
	`®loc_šŒ_g©e
(
ERROR_APIC_VECTOR
, 
”rÜ_š‹¼u±
);

155 
	}
}

157 
__š™
 
	$Çtive_š™_IRQ
()

159 
i
;

161 
	`š™_ISA_œqs
();

167 
i
 = 0; i < (
NR_VECTORS
 - 
FIRST_EXTERNAL_VECTOR
); i++) {

168 
veùÜ
 = 
FIRST_EXTERNAL_VECTOR
 + 
i
;

169 ià(
veùÜ
 !ğ
IA32_SYSCALL_VECTOR
)

170 
	`£t_šŒ_g©e
(
veùÜ
, 
š‹¼u±
[
i
]);

173 
	`­ic_šŒ_š™
();

175 ià(!
aıi_ißpic
)

176 
	`£tup_œq
(2, &
œq2
);

177 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<lšux/gå.h
>

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/š™.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/¥šlock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_nÜthbridges
;

14 
EXPORT_SYMBOL
(
num_k8_nÜthbridges
);

16 
u32
 *
	gæush_wÜds
;

18 
pci_deviû_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_nÜthbridges
;

26 
EXPORT_SYMBOL
(
k8_nÜthbridges
);

28 
pci_dev
 *
	$Ãxt_k8_nÜthbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_g‘_deviû
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 ià(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ÿche_k8_nÜthbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 ià(
num_k8_nÜthbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`Ãxt_k8_nÜthbridge
(dev)è!ğ
NULL
)

48 
num_k8_nÜthbridges
++;

50 
k8_nÜthbridges
 = 
	`km®loc
((
num_k8_nÜthbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 ià(!
k8_nÜthbridges
)

53  -
ENOMEM
;

55 ià(!
num_k8_nÜthbridges
) {

56 
k8_nÜthbridges
[0] = 
NULL
;

60 
æush_wÜds
 = 
	`km®loc
(
num_k8_nÜthbridges
 * (
u32
), 
GFP_KERNEL
);

61 ià(!
æush_wÜds
) {

62 
	`kä“
(
k8_nÜthbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`Ãxt_k8_nÜthbridge
(dev)è!ğ
NULL
) {

69 
k8_nÜthbridges
[
i
] = 
dev
;

70 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x9c, &
æush_wÜds
[
i
++]);

72 
k8_nÜthbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ÿche_k8_nÜthbridges
);

79 
__š™
 
	$—¾y_is_k8_nb
(
u32
 
deviû
)

81 
pci_deviû_id
 *
id
;

82 
u32
 
v’dÜ
 = 
deviû
 & 0xffff;

83 
deviû
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
v’dÜ
; id++)

85 ià(
v’dÜ
 =ğ
id
->v’dÜ && 
deviû
 == id->device)

88 
	}
}

90 
	$k8_æush_g¬ts
()

92 
æushed
, 
i
;

93 
æags
;

94 
	`DEFINE_SPINLOCK
(
g¬t_lock
);

100 
	`¥š_lock_œq§ve
(&
g¬t_lock
, 
æags
);

101 
æushed
 = 0;

102 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

103 
	`pci_wr™e_cÚfig_dwÜd
(
k8_nÜthbridges
[
i
], 0x9c,

104 
æush_wÜds
[
i
]|1);

105 
æushed
++;

107 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_»ad_cÚfig_dwÜd
(
k8_nÜthbridges
[
i
],

112 0x9c, &
w
);

113 ià(!(
w
 & 1))

115 
	`ıu_»Ïx
();

118 
	`¥š_uÆock_œq»¡Üe
(&
g¬t_lock
, 
æags
);

119 ià(!
æushed
)

120 
	`´štk
("nothingo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_æush_g¬ts
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<lšux/debugfs.h
>

10 
	~<lšux/uacûss.h
>

11 
	~<lšux/moduË.h
>

12 
	~<lšux/š™.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/io.h
>

15 
	~<lšux/mm.h
>

17 
	~<asm/£tup.h
>

19 
d’Œy
 *
	g¬ch_debugfs_dœ
;

20 
EXPORT_SYMBOL
(
¬ch_debugfs_dœ
);

22 #ifdeà
CONFIG_DEBUG_BOOT_PARAMS


23 
	s£tup_d©a_node
 {

24 
u64
 
	m·ddr
;

25 
u32
 
	mty³
;

26 
u32
 
	mËn
;

29 
ssize_t
 
	$£tup_d©a_»ad
(
fe
 *fe, 
__u£r
 *
u£r_buf
,

30 
size_t
 
couÁ
, 
loff_t
 *
µos
)

32 
£tup_d©a_node
 *
node
 = 
fe
->
´iv©e_d©a
;

33 
»maš
;

34 
loff_t
 
pos
 = *
µos
;

35 
·ge
 *
pg
;

36 *
p
;

37 
u64
 
·
;

39 ià(
pos
 < 0)

40  -
EINVAL
;

42 ià(
pos
 >ğ
node
->
Ën
)

45 ià(
couÁ
 > 
node
->
Ën
 - 
pos
)

46 
couÁ
 = 
node
->
Ën
 - 
pos
;

48 
·
 = 
node
->
·ddr
 + (
£tup_d©a
è+ 
pos
;

49 
pg
 = 
	`pâ_to_·ge
((
·
 + 
couÁ
 - 1è>> 
PAGE_SHIFT
);

50 ià(
	`PageHighMem
(
pg
)) {

51 
p
 = 
	`iÜem­_ÿche
(
·
, 
couÁ
);

52 ià(!
p
)

53  -
ENXIO
;

55 
p
 = 
	`__va
(
·
);

57 
»maš
 = 
	`cİy_to_u£r
(
u£r_buf
, 
p
, 
couÁ
);

59 ià(
	`PageHighMem
(
pg
))

60 
	`iounm­
(
p
);

62 ià(
»maš
)

63  -
EFAULT
;

65 *
µos
 = 
pos
 + 
couÁ
;

67  
couÁ
;

68 
	}
}

70 
	$£tup_d©a_İ’
(
šode
 *šode, 
fe
 *file)

72 
fe
->
´iv©e_d©a
 = 
šode
->
i_´iv©e
;

75 
	}
}

77 cÚ¡ 
fe_İ”©iÚs
 
	gfİs_£tup_d©a
 = {

78 .
»ad
 = 
£tup_d©a_»ad
,

79 .
	gİ’
 = 
£tup_d©a_İ’
,

82 
__š™


83 
	$ü—‹_£tup_d©a_node
(
d’Œy
 *
·»Á
, 
no
,

84 
£tup_d©a_node
 *
node
)

86 
d’Œy
 *
d
, *
ty³
, *
d©a
;

87 
buf
[16];

89 
	`¥rštf
(
buf
, "%d", 
no
);

90 
d
 = 
	`debugfs_ü—‹_dœ
(
buf
, 
·»Á
);

91 ià(!
d
)

92  -
ENOMEM
;

94 
ty³
 = 
	`debugfs_ü—‹_x32
("ty³", 
S_IRUGO
, 
d
, &
node
->type);

95 ià(!
ty³
)

96 
”r_dœ
;

98 
d©a
 = 
	`debugfs_ü—‹_fe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
fİs_£tup_d©a
);

99 ià(!
d©a
)

100 
”r_ty³
;

104 
”r_ty³
:

105 
	`debugfs_»move
(
ty³
);

106 
”r_dœ
:

107 
	`debugfs_»move
(
d
);

108  -
ENOMEM
;

109 
	}
}

111 
__š™
 
	$ü—‹_£tup_d©a_nodes
(
d’Œy
 *
·»Á
)

113 
£tup_d©a_node
 *
node
;

114 
£tup_d©a
 *
d©a
;

115 
”rÜ
 = -
ENOMEM
;

116 
d’Œy
 *
d
;

117 
·ge
 *
pg
;

118 
u64
 
·_d©a
;

119 
no
 = 0;

121 
d
 = 
	`debugfs_ü—‹_dœ
("£tup_d©a", 
·»Á
);

122 ià(!
d
)

123  -
ENOMEM
;

125 
·_d©a
 = 
boÙ_·¿ms
.
hdr
.
£tup_d©a
;

127 
·_d©a
) {

128 
node
 = 
	`km®loc
((*node), 
GFP_KERNEL
);

129 ià(!
node
)

130 
”r_dœ
;

132 
pg
 = 
	`pâ_to_·ge
((
·_d©a
+(*
d©a
)-1è>> 
PAGE_SHIFT
);

133 ià(
	`PageHighMem
(
pg
)) {

134 
d©a
 = 
	`iÜem­_ÿche
(
·_d©a
, (*data));

135 ià(!
d©a
) {

136 
	`kä“
(
node
);

137 
”rÜ
 = -
ENXIO
;

138 
”r_dœ
;

141 
d©a
 = 
	`__va
(
·_d©a
);

143 
node
->
·ddr
 = 
·_d©a
;

144 
node
->
ty³
 = 
d©a
->type;

145 
node
->
Ën
 = 
d©a
->len;

146 
”rÜ
 = 
	`ü—‹_£tup_d©a_node
(
d
, 
no
, 
node
);

147 
·_d©a
 = 
d©a
->
Ãxt
;

149 ià(
	`PageHighMem
(
pg
))

150 
	`iounm­
(
d©a
);

151 ià(
”rÜ
)

152 
”r_dœ
;

153 
no
++;

158 
”r_dœ
:

159 
	`debugfs_»move
(
d
);

160  
”rÜ
;

161 
	}
}

163 
debugfs_blob_w¿µ”
 
	gboÙ_·¿ms_blob
 = {

164 .
d©a
 = &
boÙ_·¿ms
,

165 .
	gsize
 = (
boÙ_·¿ms
),

168 
__š™
 
	$boÙ_·¿ms_kdebugfs_š™
()

170 
d’Œy
 *
dbp
, *
v”siÚ
, *
d©a
;

171 
”rÜ
 = -
ENOMEM
;

173 
dbp
 = 
	`debugfs_ü—‹_dœ
("boÙ_·¿ms", 
NULL
);

174 ià(!
dbp
)

175  -
ENOMEM
;

177 
v”siÚ
 = 
	`debugfs_ü—‹_x16
("v”siÚ", 
S_IRUGO
, 
dbp
,

178 &
boÙ_·¿ms
.
hdr
.
v”siÚ
);

179 ià(!
v”siÚ
)

180 
”r_dœ
;

182 
d©a
 = 
	`debugfs_ü—‹_blob
("d©a", 
S_IRUGO
, 
dbp
,

183 &
boÙ_·¿ms_blob
);

184 ià(!
d©a
)

185 
”r_v”siÚ
;

187 
”rÜ
 = 
	`ü—‹_£tup_d©a_nodes
(
dbp
);

188 ià(
”rÜ
)

189 
”r_d©a
;

193 
”r_d©a
:

194 
	`debugfs_»move
(
d©a
);

195 
”r_v”siÚ
:

196 
	`debugfs_»move
(
v”siÚ
);

197 
”r_dœ
:

198 
	`debugfs_»move
(
dbp
);

199  
”rÜ
;

200 
	}
}

203 
__š™
 
	$¬ch_kdebugfs_š™
()

205 
”rÜ
 = 0;

207 
¬ch_debugfs_dœ
 = 
	`debugfs_ü—‹_dœ
("x86", 
NULL
);

208 ià(!
¬ch_debugfs_dœ
)

209  -
ENOMEM
;

211 #ifdeà
CONFIG_DEBUG_BOOT_PARAMS


212 
”rÜ
 = 
	`boÙ_·¿ms_kdebugfs_š™
();

215  
”rÜ
;

216 
	}
}

217 
¬ch_š™ÿÎ
(
¬ch_kdebugfs_š™
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<lšux/k´obes.h
>

44 
	~<lšux/±¿û.h
>

45 
	~<lšux/¡ršg.h
>

46 
	~<lšux/¦ab.h
>

47 
	~<lšux/h¬dœq.h
>

48 
	~<lšux/´“m±.h
>

49 
	~<lšux/moduË.h
>

50 
	~<lšux/kdebug.h
>

52 
	~<asm/ÿcheæush.h
>

53 
	~<asm/desc.h
>

54 
	~<asm/pgbË.h
>

55 
	~<asm/uacûss.h
>

56 
	~<asm/®‹º©ive.h
>

58 
j´obe_»tuº_’d
();

60 
DEFINE_PER_CPU
(
k´obe
 *, 
cu¼’t_k´obe
èğ
NULL
;

61 
DEFINE_PER_CPU
(
k´obe_ùlblk
, kprobe_ctlblk);

63 #ifdeà
CONFIG_X86_64


64 
	#¡ack_addr
(
»gs
è((*ìegs->
¥
)

	)

74 
	#¡ack_addr
(
»gs
è((*)&»gs->
¥
)

	)

77 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

78 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

79 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

80 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

81 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

82 << (
row
 % 32))

	)

87 cÚ¡ 
u32
 
	gtwoby‹_is_boo¡abË
[256 / 32] = {

90 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

91 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

92 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

93 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

94 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

95 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

96 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

97 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

98 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

99 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

100 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

101 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

102 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

103 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

104 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

105 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

109 cÚ¡ 
u32
 
	gÚeby‹_has_modrm
[256 / 32] = {

112 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

113 
W
(0x10, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

114 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

115 
W
(0x30, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

116 
W
(0x40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

117 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

118 
W
(0x60, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0) |

119 
W
(0x70, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

120 
W
(0x80, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

121 
W
(0x90, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

122 
W
(0xa0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

123 
W
(0xb0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

124 
W
(0xc0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

125 
W
(0xd0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) ,

126 
W
(0xe0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

127 
W
(0xf0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1)

131 cÚ¡ 
u32
 
	gtwoby‹_has_modrm
[256 / 32] = {

134 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1) |

135 
W
(0x10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0) ,

136 
W
(0x20, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

137 
W
(0x30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

138 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

139 
W
(0x50, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

140 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

141 
W
(0x70, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1) ,

142 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

143 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

144 
W
(0xa0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) |

145 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1) ,

146 
W
(0xc0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

147 
W
(0xd0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

148 
W
(0xe0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

149 
W
(0xf0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0)

153 #undeà
W


155 
k»robe_bÏckpošt
 
	gk»robe_bÏckli¡
[] = {

158 {
NULL
, NULL}

160 cÚ¡ 
	gk»robe_bÏckli¡_size
 = 
ARRAY_SIZE
(
k»robe_bÏckli¡
);

163 
__k´obes
 
	$£t_jmp_İ
(*
äom
, *
to
)

165 
	s__¬ch_jmp_İ
 {

166 
İ
;

167 
s32
 
¿ddr
;

168 } 
	`__©Œibu‹__
((
·cked
)è* 
jİ
;

169 
jİ
 = (
__¬ch_jmp_İ
 *)
äom
;

170 
jİ
->
¿ddr
 = (
s32
)(()(
to
è- (()(
äom
) + 5));

171 
jİ
->
İ
 = 
RELATIVEJUMP_INSTRUCTION
;

172 
	}
}

178 
__k´obes
 
	$is_REX_´efix
(
k´obe_İcode_t
 *
š¢
)

180 #ifdeà
CONFIG_X86_64


181 ià((*
š¢
 & 0xf0) == 0x40)

185 
	}
}

191 
__k´obes
 
	$ÿn_boo¡
(
k´obe_İcode_t
 *
İcodes
)

193 
k´obe_İcode_t
 
İcode
;

194 
k´obe_İcode_t
 *
Üig_İcodes
 = 
İcodes
;

196 ià(
	`£¬ch_exû±iÚ_bËs
(()
İcodes
))

199 
»Œy
:

200 ià(
İcodes
 - 
Üig_İcodes
 > 
MAX_INSN_SIZE
 - 1)

202 
İcode
 = *(
İcodes
++);

205 ià(
İcode
 == 0x0f) {

206 ià(
İcodes
 - 
Üig_İcodes
 > 
MAX_INSN_SIZE
 - 1)

208  
	`‹¡_b™
(*
İcodes
,

209 (*)
twoby‹_is_boo¡abË
);

212 
İcode
 & 0xf0) {

213 #ifdeà
CONFIG_X86_64


215 
»Œy
;

218 ià(0x63 < 
İcode
 && opcode < 0x67)

219 
»Œy
;

221  (
İcode
 != 0x62 && opcode != 0x67);

226  (0xc1 < 
İcode
 && opcode < 0xcc) || opcode == 0xcf;

229  (
İcode
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

232  ((
İcode
 & 0x04) || opcode == 0xea);

234 ià((
İcode
 & 0x0c) == 0 && opcode != 0xf1)

235 
»Œy
;

237  (
İcode
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

240 ià(
İcode
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

241 
»Œy
;

243  (
İcode
 != 0x2e && opcode != 0x9a);

245 
	}
}

250 
__k´obes
 
	$is_IF_modif›r
(
k´obe_İcode_t
 *
š¢
)

252 *
š¢
) {

264 ià(
	`is_REX_´efix
(
š¢
))

265  
	`is_IF_modif›r
(++
š¢
);

268 
	}
}

277 
__k´obes
 
	$fix_r»l
(
k´obe
 *
p
)

279 #ifdeà
CONFIG_X86_64


280 
u8
 *
š¢
 = 
p
->
aš¢
.insn;

281 
s64
 
di¥
;

282 
Ãed_modrm
;

286 *
š¢
) {

298 ++
š¢
;

305 ià(
	`is_REX_´efix
(
š¢
))

306 ++
š¢
;

308 ià(*
š¢
 == 0x0f) {

310 ++
š¢
;

311 
Ãed_modrm
 = 
	`‹¡_b™
(*
š¢
,

312 (*)
twoby‹_has_modrm
);

315 
Ãed_modrm
 = 
	`‹¡_b™
(*
š¢
,

316 (*)
Úeby‹_has_modrm
);

318 ià(
Ãed_modrm
) {

319 
u8
 
modrm
 = *++
š¢
;

320 ià((
modrm
 & 0xc7) == 0x05) {

323 ++
š¢
;

337 
di¥
 = (
u8
 *è
p
->
addr
 + *((
s32
 *è
š¢
) -

338 (
u8
 *è
p
->
aš¢
.
š¢
;

339 
	`BUG_ON
((
s64
è(
s32
è
di¥
 != disp);

340 *(
s32
 *)
š¢
 = (s32è
di¥
;

344 
	}
}

346 
__k´obes
 
	$¬ch_cİy_k´obe
(
k´obe
 *
p
)

348 
	`memıy
(
p
->
aš¢
.
š¢
,…->
addr
, 
MAX_INSN_SIZE
 * (
k´obe_İcode_t
));

350 
	`fix_r»l
(
p
);

352 ià(
	`ÿn_boo¡
(
p
->
addr
))

353 
p
->
aš¢
.
boo¡abË
 = 0;

355 
p
->
aš¢
.
boo¡abË
 = -1;

357 
p
->
İcode
 = *p->
addr
;

358 
	}
}

360 
__k´obes
 
	$¬ch_´•¬e_k´obe
(
k´obe
 *
p
)

363 
p
->
aš¢
.
š¢
 = 
	`g‘_š¢_¦Ù
();

364 ià(!
p
->
aš¢
.
š¢
)

365  -
ENOMEM
;

366 
	`¬ch_cİy_k´obe
(
p
);

368 
	}
}

370 
__k´obes
 
	$¬ch_¬m_k´obe
(
k´obe
 *
p
)

372 
	`‹xt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

373 
	}
}

375 
__k´obes
 
	$¬ch_di§rm_k´obe
(
k´obe
 *
p
)

377 
	`‹xt_poke
(
p
->
addr
, &p->
İcode
, 1);

378 
	}
}

380 
__k´obes
 
	$¬ch_»move_k´obe
(
k´obe
 *
p
)

382 ià(
p
->
aš¢
.
š¢
) {

383 
	`ä“_š¢_¦Ù
(
p
->
aš¢
.
š¢
, (p->aš¢.
boo¡abË
 == 1));

384 
p
->
aš¢
.
š¢
 = 
NULL
;

386 
	}
}

388 
__k´obes
 
	$§ve_´evious_k´obe
(
k´obe_ùlblk
 *
kcb
)

390 
kcb
->
´ev_k´obe
.
kp
 = 
	`k´obe_ruÂšg
();

391 
kcb
->
´ev_k´obe
.
¡©us
 = kcb->
k´obe_¡©us
;

392 
kcb
->
´ev_k´obe
.
Şd_æags
 = kcb->
k´obe_Şd_æags
;

393 
kcb
->
´ev_k´obe
.
§ved_æags
 = kcb->
k´obe_§ved_æags
;

394 
	}
}

396 
__k´obes
 
	$»¡Üe_´evious_k´obe
(
k´obe_ùlblk
 *
kcb
)

398 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ
kcb
->
´ev_k´obe
.
kp
;

399 
kcb
->
k´obe_¡©us
 = kcb->
´ev_k´obe
.
¡©us
;

400 
kcb
->
k´obe_Şd_æags
 = kcb->
´ev_k´obe
.
Şd_æags
;

401 
kcb
->
k´obe_§ved_æags
 = kcb->
´ev_k´obe
.
§ved_æags
;

402 
	}
}

404 
__k´obes
 
	$£t_cu¼’t_k´obe
(
k´obe
 *
p
, 
±_»gs
 *
»gs
,

405 
k´obe_ùlblk
 *
kcb
)

407 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ
p
;

408 
kcb
->
k´obe_§ved_æags
 = kcb->
k´obe_Şd_æags


409 ğ(
»gs
->
æags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

410 ià(
	`is_IF_modif›r
(
p
->
aš¢
.
š¢
))

411 
kcb
->
k´obe_§ved_æags
 &ğ~
X86_EFLAGS_IF
;

412 
	}
}

414 
__k´obes
 
	$ş—r_btf
()

416 ià(
	`‹¡_th»ad_æag
(
TIF_DEBUGCTLMSR
))

417 
	`upd©e_debugùlm¤
(0);

418 
	}
}

420 
__k´obes
 
	$»¡Üe_btf
()

422 ià(
	`‹¡_th»ad_æag
(
TIF_DEBUGCTLMSR
))

423 
	`upd©e_debugùlm¤
(
cu¼’t
->
th»ad
.
debugùlm¤
);

424 
	}
}

426 
__k´obes
 
	$´•¬e_sšgË¡•
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

428 
	`ş—r_btf
();

429 
»gs
->
æags
 |ğ
X86_EFLAGS_TF
;

430 
»gs
->
æags
 &ğ~
X86_EFLAGS_IF
;

432 ià(
p
->
İcode
 =ğ
BREAKPOINT_INSTRUCTION
)

433 
»gs
->

 = ()
p
->
addr
;

435 
»gs
->

 = ()
p
->
aš¢
.
š¢
;

436 
	}
}

438 
__k´obes
 
	$¬ch_´•¬e_k»robe
(
k»robe_š¡ªû
 *
ri
,

439 
±_»gs
 *
»gs
)

441 *
§¿
 = 
	`¡ack_addr
(
»gs
);

443 
ri
->
»t_addr
 = (
k´obe_İcode_t
 *è*
§¿
;

446 *
§¿
 = (è&
k»robe_ŒampŞše
;

447 
	}
}

449 
__k´obes
 
	$£tup_sšgË¡•
(
k´obe
 *
p
, 
±_»gs
 *
»gs
,

450 
k´obe_ùlblk
 *
kcb
)

452 #ià!
	`defšed
(
CONFIG_PREEMPT
è|| defšed(
CONFIG_FREEZER
)

453 ià(
p
->
aš¢
.
boo¡abË
 =ğ1 && !p->
po¡_hªdËr
) {

455 
	`»£t_cu¼’t_k´obe
();

456 
»gs
->

 = ()
p
->
aš¢
.
š¢
;

457 
	`´“m±_’abË_no_»sched
();

461 
	`´•¬e_sšgË¡•
(
p
, 
»gs
);

462 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_SS
;

463 
	}
}

470 
__k´obes
 
	$»’‹r_k´obe
(
k´obe
 *
p
, 
±_»gs
 *
»gs
,

471 
k´obe_ùlblk
 *
kcb
)

473 
kcb
->
k´obe_¡©us
) {

474 
KPROBE_HIT_SSDONE
:

475 #ifdeà
CONFIG_X86_64


480 
	`¬ch_di§rm_k´obe
(
p
);

481 
»gs
->

 = ()
p
->
addr
;

482 
	`»£t_cu¼’t_k´obe
();

483 
	`´“m±_’abË_no_»sched
();

486 
KPROBE_HIT_ACTIVE
:

487 
	`§ve_´evious_k´obe
(
kcb
);

488 
	`£t_cu¼’t_k´obe
(
p
, 
»gs
, 
kcb
);

489 
	`k´obes_šc_nmis£d_couÁ
(
p
);

490 
	`´•¬e_sšgË¡•
(
p
, 
»gs
);

491 
kcb
->
k´obe_¡©us
 = 
KPROBE_REENTER
;

493 
KPROBE_HIT_SS
:

494 ià(
p
 =ğ
	`k´obe_ruÂšg
()) {

495 
»gs
->
æags
 &ğ~
X86_EFLAGS_TF
;

496 
»gs
->
æags
 |ğ
kcb
->
k´obe_§ved_æags
;

508 
	`WARN_ON
(1);

513 
	}
}

519 
__k´obes
 
	$k´obe_hªdËr
(
±_»gs
 *
»gs
)

521 
k´obe_İcode_t
 *
addr
;

522 
k´obe
 *
p
;

523 
k´obe_ùlblk
 *
kcb
;

525 
addr
 = (
k´obe_İcode_t
 *)(
»gs
->

 - (kprobe_opcode_t));

526 ià(*
addr
 !ğ
BREAKPOINT_INSTRUCTION
) {

536 
»gs
->

 = ()
addr
;

546 
	`´“m±_di§bË
();

548 
kcb
 = 
	`g‘_k´obe_ùlblk
();

549 
p
 = 
	`g‘_k´obe
(
addr
);

551 ià(
p
) {

552 ià(
	`k´obe_ruÂšg
()) {

553 ià(
	`»’‹r_k´obe
(
p
, 
»gs
, 
kcb
))

556 
	`£t_cu¼’t_k´obe
(
p
, 
»gs
, 
kcb
);

557 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_ACTIVE
;

567 ià(!
p
->
´e_hªdËr
 || !p->
	`´e_hªdËr
Õ, 
»gs
))

568 
	`£tup_sšgË¡•
(
p
, 
»gs
, 
kcb
);

571 } ià(
	`k´obe_ruÂšg
()) {

572 
p
 = 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
);

573 ià(
p
->
b»ak_hªdËr
 &&…->
	`b»ak_hªdËr
Õ, 
»gs
)) {

574 
	`£tup_sšgË¡•
(
p
, 
»gs
, 
kcb
);

579 
	`´“m±_’abË_no_»sched
();

581 
	}
}

587 
__u£d
 
__k´obes
 
	$k»robe_ŒampŞše_hŞd”
()

589 
asm
 volatile (

592 #ifdeà
CONFIG_X86_64


674 
	}
}

679 
__u£d
 
__k´obes
 *
	$ŒampŞše_hªdËr
(
±_»gs
 *
»gs
)

681 
k»robe_š¡ªû
 *
ri
 = 
NULL
;

682 
hli¡_h—d
 *
h—d
, 
em±y_½
;

683 
hli¡_node
 *
node
, *
tmp
;

684 
æags
, 
Üig_»t_add»ss
 = 0;

685 
ŒampŞše_add»ss
 = ()&
k»robe_ŒampŞše
;

687 
	`INIT_HLIST_HEAD
(&
em±y_½
);

688 
	`k»robe_hash_lock
(
cu¼’t
, &
h—d
, &
æags
);

690 #ifdeà
CONFIG_X86_64


691 
»gs
->
cs
 = 
__KERNEL_CS
;

693 
»gs
->
cs
 = 
__KERNEL_CS
 | 
	`g‘_k”Ãl_½l
();

694 
»gs
->
gs
 = 0;

696 
»gs
->

 = 
ŒampŞše_add»ss
;

697 
»gs
->
Üig_ax
 = ~0UL;

712 
	`hli¡_fÜ_—ch_’Œy_§ã
(
ri
, 
node
, 
tmp
, 
h—d
, 
hli¡
) {

713 ià(
ri
->
sk
 !ğ
cu¼’t
)

717 ià(
ri
->
½
 &&„i->½->
hªdËr
) {

718 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ&
ri
->
½
->
kp
;

719 
	`g‘_k´obe_ùlblk
()->
k´obe_¡©us
 = 
KPROBE_HIT_ACTIVE
;

720 
ri
->
½
->
	`hªdËr
Ôi, 
»gs
);

721 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ
NULL
;

724 
Üig_»t_add»ss
 = ()
ri
->
»t_addr
;

725 
	`»cyşe_½_š¡
(
ri
, &
em±y_½
);

727 ià(
Üig_»t_add»ss
 !ğ
ŒampŞše_add»ss
)

736 
	`k»robe_as£¹
(
ri
, 
Üig_»t_add»ss
, 
ŒampŞše_add»ss
);

738 
	`k»robe_hash_uÆock
(
cu¼’t
, &
æags
);

740 
	`hli¡_fÜ_—ch_’Œy_§ã
(
ri
, 
node
, 
tmp
, &
em±y_½
, 
hli¡
) {

741 
	`hli¡_d–
(&
ri
->
hli¡
);

742 
	`kä“
(
ri
);

744  (*)
Üig_»t_add»ss
;

745 
	}
}

774 
__k´obes
 
	$»sume_executiÚ
(
k´obe
 *
p
,

775 
±_»gs
 *
»gs
, 
k´obe_ùlblk
 *
kcb
)

777 *
tos
 = 
	`¡ack_addr
(
»gs
);

778 
cİy_
 = ()
p
->
aš¢
.
š¢
;

779 
Üig_
 = ()
p
->
addr
;

780 
k´obe_İcode_t
 *
š¢
 = 
p
->
aš¢
.insn;

783 ià(
	`is_REX_´efix
(
š¢
))

784 
š¢
++;

786 
»gs
->
æags
 &ğ~
X86_EFLAGS_TF
;

787 *
š¢
) {

789 *
tos
 &ğ~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

790 *
tos
 |ğ
kcb
->
k´obe_Şd_æags
;

799 
p
->
aš¢
.
boo¡abË
 = 1;

800 
no_chªge
;

802 *
tos
 = 
Üig_
 + (*to - 
cİy_
);

804 #ifdeà
CONFIG_X86_32


806 *
tos
 = 
Üig_
 + (*to - 
cİy_
);

807 
no_chªge
;

810 ià((
š¢
[1] & 0x30) == 0x10) {

816 *
tos
 = 
Üig_
 + (*to - 
cİy_
);

817 
no_chªge
;

818 } ià(((
š¢
[1] & 0x31) == 0x20) ||

819 ((
š¢
[1] & 0x31) == 0x21)) {

824 
p
->
aš¢
.
boo¡abË
 = 1;

825 
no_chªge
;

831 ià(
p
->
aš¢
.
boo¡abË
 == 0) {

832 ià((
»gs
->

 > 
cİy_
) &&

833 (
»gs
->

 - 
cİy_
è+ 5 < 
MAX_INSN_SIZE
) {

838 
	`£t_jmp_İ
((*)
»gs
->

,

839 (*)
Üig_
 + (
»gs
->

 - 
cİy_
));

840 
p
->
aš¢
.
boo¡abË
 = 1;

842 
p
->
aš¢
.
boo¡abË
 = -1;

846 
»gs
->

 +ğ
Üig_
 - 
cİy_
;

848 
no_chªge
:

849 
	`»¡Üe_btf
();

850 
	}
}

856 
__k´obes
 
	$po¡_k´obe_hªdËr
(
±_»gs
 *
»gs
)

858 
k´obe
 *
cur
 = 
	`k´obe_ruÂšg
();

859 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

861 ià(!
cur
)

864 
	`»sume_executiÚ
(
cur
, 
»gs
, 
kcb
);

865 
»gs
->
æags
 |ğ
kcb
->
k´obe_§ved_æags
;

867 ià((
kcb
->
k´obe_¡©us
 !ğ
KPROBE_REENTER
è&& 
cur
->
po¡_hªdËr
) {

868 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_SSDONE
;

869 
cur
->
	`po¡_hªdËr
(cur, 
»gs
, 0);

873 ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_REENTER
) {

874 
	`»¡Üe_´evious_k´obe
(
kcb
);

875 
out
;

877 
	`»£t_cu¼’t_k´obe
();

878 
out
:

879 
	`´“m±_’abË_no_»sched
();

886 ià(
»gs
->
æags
 & 
X86_EFLAGS_TF
)

890 
	}
}

892 
__k´obes
 
	$k´obe_çuÉ_hªdËr
(
±_»gs
 *
»gs
, 
Œ­Ä
)

894 
k´obe
 *
cur
 = 
	`k´obe_ruÂšg
();

895 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

897 
kcb
->
k´obe_¡©us
) {

898 
KPROBE_HIT_SS
:

899 
KPROBE_REENTER
:

907 
»gs
->

 = ()
cur
->
addr
;

908 
»gs
->
æags
 |ğ
kcb
->
k´obe_Şd_æags
;

909 ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_REENTER
)

910 
	`»¡Üe_´evious_k´obe
(
kcb
);

912 
	`»£t_cu¼’t_k´obe
();

913 
	`´“m±_’abË_no_»sched
();

915 
KPROBE_HIT_ACTIVE
:

916 
KPROBE_HIT_SSDONE
:

922 
	`k´obes_šc_nmis£d_couÁ
(
cur
);

931 ià(
cur
->
çuÉ_hªdËr
 && cur->
	`çuÉ_hªdËr
(cur, 
»gs
, 
Œ­Ä
))

938 ià(
	`fixup_exû±iÚ
(
»gs
))

950 
	}
}

955 
__k´obes
 
	$k´obe_exû±iÚs_nÙify
(
nÙif›r_block
 *
£lf
,

956 
v®
, *
d©a
)

958 
d›_¬gs
 *
¬gs
 = 
d©a
;

959 
»t
 = 
NOTIFY_DONE
;

961 ià(
¬gs
->
»gs
 && 
	`u£r_mode_vm
(args->regs))

962  
»t
;

964 
v®
) {

965 
DIE_INT3
:

966 ià(
	`k´obe_hªdËr
(
¬gs
->
»gs
))

967 
»t
 = 
NOTIFY_STOP
;

969 
DIE_DEBUG
:

970 ià(
	`po¡_k´obe_hªdËr
(
¬gs
->
»gs
))

971 
»t
 = 
NOTIFY_STOP
;

973 
DIE_GPF
:

979 ià(!
	`´“m±ibË
(è&& 
	`k´obe_ruÂšg
() &&

980 
	`k´obe_çuÉ_hªdËr
(
¬gs
->
»gs
,‡rgs->
Œ­Ä
))

981 
»t
 = 
NOTIFY_STOP
;

986  
»t
;

987 
	}
}

989 
__k´obes
 
	$£tjmp_´e_hªdËr
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

991 
j´obe
 *
jp
 = 
	`cÚš”_of
(
p
, j´obe, 
kp
);

992 
addr
;

993 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

995 
kcb
->
j´obe_§ved_»gs
 = *
»gs
;

996 
kcb
->
j´obe_§ved_¥
 = 
	`¡ack_addr
(
»gs
);

997 
addr
 = ()(
kcb
->
j´obe_§ved_¥
);

1006 
	`memıy
(
kcb
->
j´obes_¡ack
, (
k´obe_İcode_t
 *)
addr
,

1007 
	`MIN_STACK_SIZE
(
addr
));

1008 
»gs
->
æags
 &ğ~
X86_EFLAGS_IF
;

1009 
	`Œaû_h¬dœqs_off
();

1010 
»gs
->

 = ()(
jp
->
’Œy
);

1012 
	}
}

1014 
__k´obes
 
	$j´obe_»tuº
()

1016 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

1018 
asm
 volatile (

1019 #ifdeà
CONFIG_X86_64


1028 (
kcb
->
j´obe_§ved_¥
):"memory");

1029 
	}
}

1031 
__k´obes
 
	$lÚgjmp_b»ak_hªdËr
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

1033 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

1034 
u8
 *
addr
 = (u8 *è(
»gs
->

 - 1);

1035 
j´obe
 *
jp
 = 
	`cÚš”_of
(
p
, j´obe, 
kp
);

1037 ià((
addr
 > (
u8
 *è
j´obe_»tuº
) &&

1038 (
addr
 < (
u8
 *è
j´obe_»tuº_’d
)) {

1039 ià(
	`¡ack_addr
(
»gs
è!ğ
kcb
->
j´obe_§ved_¥
) {

1040 
±_»gs
 *
§ved_»gs
 = &
kcb
->
j´obe_§ved_»gs
;

1041 
	`´štk
(
KERN_ERR


1043 
	`¡ack_addr
(
»gs
), 
kcb
->
j´obe_§ved_¥
);

1044 
	`´štk
(
KERN_ERR
 "Saved„egi¡” fÜ j´ob%p\n", 
jp
);

1045 
	`show_»gi¡”s
(
§ved_»gs
);

1046 
	`´štk
(
KERN_ERR
 "Current„egisters\n");

1047 
	`show_»gi¡”s
(
»gs
);

1048 
	`BUG
();

1050 *
»gs
 = 
kcb
->
j´obe_§ved_»gs
;

1051 
	`memıy
((
k´obe_İcode_t
 *)(
kcb
->
j´obe_§ved_¥
),

1052 
kcb
->
j´obes_¡ack
,

1053 
	`MIN_STACK_SIZE
(
kcb
->
j´obe_§ved_¥
));

1054 
	`´“m±_’abË_no_»sched
();

1058 
	}
}

1060 
__š™
 
	$¬ch_š™_k´obes
()

1063 
	}
}

1065 
__k´obes
 
	$¬ch_ŒampŞše_k´obe
(
k´obe
 *
p
)

1068 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/mm.h
>

13 
	~<lšux/smp.h
>

14 
	~<lšux/vm®loc.h
>

15 
	~<lšux/uacûss.h
>

17 
	~<asm/sy¡em.h
>

18 
	~<asm/ldt.h
>

19 
	~<asm/desc.h
>

20 
	~<asm/mmu_cÚ‹xt.h
>

21 
	~<asm/sysÿÎs.h
>

23 #ifdeà
CONFIG_SMP


24 
	$æush_ldt
(*
cu¼’t_mm
)

26 ià(
cu¼’t
->
aùive_mm
 =ğ
cu¼’t_mm
)

27 
	`lßd_LDT
(&
cu¼’t
->
aùive_mm
->
cÚ‹xt
);

28 
	}
}

31 
	$®loc_ldt
(
mm_cÚ‹xt_t
 *
pc
, 
mšcouÁ
, 
»lßd
)

33 *
Şdldt
, *
Ãwldt
;

34 
Şdsize
;

36 ià(
mšcouÁ
 <ğ
pc
->
size
)

38 
Şdsize
 = 
pc
->
size
;

39 
mšcouÁ
 = (mšcouÁ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

40 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

41 ià(
mšcouÁ
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

42 
Ãwldt
 = 
	`vm®loc
(
mšcouÁ
 * 
LDT_ENTRY_SIZE
);

44 
Ãwldt
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

46 ià(!
Ãwldt
)

47  -
ENOMEM
;

49 ià(
Şdsize
)

50 
	`memıy
(
Ãwldt
, 
pc
->
ldt
, 
Şdsize
 * 
LDT_ENTRY_SIZE
);

51 
Şdldt
 = 
pc
->
ldt
;

52 
	`mem£t
(
Ãwldt
 + 
Şdsize
 * 
LDT_ENTRY_SIZE
, 0,

53 (
mšcouÁ
 - 
Şdsize
è* 
LDT_ENTRY_SIZE
);

55 
	`·¿vœt_®loc_ldt
(
Ãwldt
, 
mšcouÁ
);

57 #ifdeà
CONFIG_X86_64


59 
	`wmb
();

61 
pc
->
ldt
 = 
Ãwldt
;

62 
	`wmb
();

63 
pc
->
size
 = 
mšcouÁ
;

64 
	`wmb
();

66 ià(
»lßd
) {

67 #ifdeà
CONFIG_SMP


68 
	`´“m±_di§bË
();

69 
	`lßd_LDT
(
pc
);

70 ià(!
	`ıus_equ®
(
cu¼’t
->
mm
->
ıu_vm_mask
,

71 
	`ıumask_of_ıu
(
	`smp_´oûssÜ_id
())))

72 
	`smp_ÿÎ_funùiÚ
(
æush_ldt
, 
cu¼’t
->
mm
, 1);

73 
	`´“m±_’abË
();

75 
	`lßd_LDT
(
pc
);

78 ià(
Şdsize
) {

79 
	`·¿vœt_ä“_ldt
(
Şdldt
, 
Şdsize
);

80 ià(
Şdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

81 
	`vä“
(
Şdldt
);

83 
	`put_·ge
(
	`vœt_to_·ge
(
Şdldt
));

86 
	}
}

88 
šlše
 
	$cİy_ldt
(
mm_cÚ‹xt_t
 *
Ãw
, mm_cÚ‹xt_ˆ*
Şd
)

90 
”r
 = 
	`®loc_ldt
(
Ãw
, 
Şd
->
size
, 0);

91 
i
;

93 ià(
”r
 < 0)

94  
”r
;

96 
i
 = 0; i < 
Şd
->
size
; i++)

97 
	`wr™e_ldt_’Œy
(
Ãw
->
ldt
, 
i
, 
Şd
->ldˆ+ i * 
LDT_ENTRY_SIZE
);

99 
	}
}

105 
	$š™_Ãw_cÚ‹xt
(
sk_¡ruù
 *
tsk
, 
mm_¡ruù
 *
mm
)

107 
mm_¡ruù
 *
Şd_mm
;

108 
»tv®
 = 0;

110 
	`mu‹x_š™
(&
mm
->
cÚ‹xt
.
lock
);

111 
mm
->
cÚ‹xt
.
size
 = 0;

112 
Şd_mm
 = 
cu¼’t
->
mm
;

113 ià(
Şd_mm
 && old_mm->
cÚ‹xt
.
size
 > 0) {

114 
	`mu‹x_lock
(&
Şd_mm
->
cÚ‹xt
.
lock
);

115 
»tv®
 = 
	`cİy_ldt
(&
mm
->
cÚ‹xt
, &
Şd_mm
->context);

116 
	`mu‹x_uÆock
(&
Şd_mm
->
cÚ‹xt
.
lock
);

118  
»tv®
;

119 
	}
}

126 
	$de¡roy_cÚ‹xt
(
mm_¡ruù
 *
mm
)

128 ià(
mm
->
cÚ‹xt
.
size
) {

129 #ifdeà
CONFIG_X86_32


131 ià(
mm
 =ğ
cu¼’t
->
aùive_mm
)

132 
	`ş—r_LDT
();

134 
	`·¿vœt_ä“_ldt
(
mm
->
cÚ‹xt
.
ldt
, mm->cÚ‹xt.
size
);

135 ià(
mm
->
cÚ‹xt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

136 
	`vä“
(
mm
->
cÚ‹xt
.
ldt
);

138 
	`put_·ge
(
	`vœt_to_·ge
(
mm
->
cÚ‹xt
.
ldt
));

139 
mm
->
cÚ‹xt
.
size
 = 0;

141 
	}
}

143 
	$»ad_ldt
(
__u£r
 *
±r
, 
by‹couÁ
)

145 
”r
;

146 
size
;

147 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

149 ià(!
mm
->
cÚ‹xt
.
size
)

151 ià(
by‹couÁ
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

152 
by‹couÁ
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

154 
	`mu‹x_lock
(&
mm
->
cÚ‹xt
.
lock
);

155 
size
 = 
mm
->
cÚ‹xt
.siz* 
LDT_ENTRY_SIZE
;

156 ià(
size
 > 
by‹couÁ
)

157 
size
 = 
by‹couÁ
;

159 
”r
 = 0;

160 ià(
	`cİy_to_u£r
(
±r
, 
mm
->
cÚ‹xt
.
ldt
, 
size
))

161 
”r
 = -
EFAULT
;

162 
	`mu‹x_uÆock
(&
mm
->
cÚ‹xt
.
lock
);

163 ià(
”r
 < 0)

164 
”rÜ_»tuº
;

165 ià(
size
 !ğ
by‹couÁ
) {

167 ià(
	`ş—r_u£r
(
±r
 + 
size
, 
by‹couÁ
 - size) != 0) {

168 
”r
 = -
EFAULT
;

169 
”rÜ_»tuº
;

172  
by‹couÁ
;

173 
”rÜ_»tuº
:

174  
”r
;

175 
	}
}

177 
	$»ad_deçuÉ_ldt
(
__u£r
 *
±r
, 
by‹couÁ
)

180 #ifdeà
CONFIG_X86_32


181 
size
 = 5 * (
desc_¡ruù
);

183 
size
 = 128;

185 ià(
by‹couÁ
 > 
size
)

186 
by‹couÁ
 = 
size
;

187 ià(
	`ş—r_u£r
(
±r
, 
by‹couÁ
))

188  -
EFAULT
;

189  
by‹couÁ
;

190 
	}
}

192 
	$wr™e_ldt
(
__u£r
 *
±r
, 
by‹couÁ
, 
Şdmode
)

194 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

195 
desc_¡ruù
 
ldt
;

196 
”rÜ
;

197 
u£r_desc
 
ldt_šfo
;

199 
”rÜ
 = -
EINVAL
;

200 ià(
by‹couÁ
 !ğ(
ldt_šfo
))

201 
out
;

202 
”rÜ
 = -
EFAULT
;

203 ià(
	`cİy_äom_u£r
(&
ldt_šfo
, 
±r
, (ldt_info)))

204 
out
;

206 
”rÜ
 = -
EINVAL
;

207 ià(
ldt_šfo
.
’Œy_numb”
 >ğ
LDT_ENTRIES
)

208 
out
;

209 ià(
ldt_šfo
.
cÚ‹Ás
 == 3) {

210 ià(
Şdmode
)

211 
out
;

212 ià(
ldt_šfo
.
£g_nÙ_´e£Á
 == 0)

213 
out
;

216 
	`mu‹x_lock
(&
mm
->
cÚ‹xt
.
lock
);

217 ià(
ldt_šfo
.
’Œy_numb”
 >ğ
mm
->
cÚ‹xt
.
size
) {

218 
”rÜ
 = 
	`®loc_ldt
(&
cu¼’t
->
mm
->
cÚ‹xt
,

219 
ldt_šfo
.
’Œy_numb”
 + 1, 1);

220 ià(
”rÜ
 < 0)

221 
out_uÆock
;

225 ià(
ldt_šfo
.
ba£_addr
 =ğ0 &&†dt_šfo.
lim™
 == 0) {

226 ià(
Şdmode
 || 
	`LDT_em±y
(&
ldt_šfo
)) {

227 
	`mem£t
(&
ldt
, 0, (ldt));

228 
š¡®l
;

232 
	`fl_ldt
(&
ldt
, &
ldt_šfo
);

233 ià(
Şdmode
)

234 
ldt
.
avl
 = 0;

237 
š¡®l
:

238 
	`wr™e_ldt_’Œy
(
mm
->
cÚ‹xt
.
ldt
, 
ldt_šfo
.
’Œy_numb”
, &ldt);

239 
”rÜ
 = 0;

241 
out_uÆock
:

242 
	`mu‹x_uÆock
(&
mm
->
cÚ‹xt
.
lock
);

243 
out
:

244  
”rÜ
;

245 
	}
}

247 
asmlškage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

248 
by‹couÁ
)

250 
»t
 = -
ENOSYS
;

252 
func
) {

254 
»t
 = 
	`»ad_ldt
(
±r
, 
by‹couÁ
);

257 
»t
 = 
	`wr™e_ldt
(
±r
, 
by‹couÁ
, 1);

260 
»t
 = 
	`»ad_deçuÉ_ldt
(
±r
, 
by‹couÁ
);

263 
»t
 = 
	`wr™e_ldt
(
±r
, 
by‹couÁ
, 0);

266  
»t
;

267 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<lšux/mm.h
>

10 
	~<lšux/kexec.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/»boÙ.h
>

13 
	~<lšux/numa.h
>

14 
	~<lšux/á¿û.h
>

15 
	~<lšux/io.h
>

16 
	~<lšux/su¥’d.h
>

18 
	~<asm/pgbË.h
>

19 
	~<asm/bæush.h
>

20 
	~<asm/mmu_cÚ‹xt.h
>

22 
	$š™_Úe_Ëv–2_·ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

23 
addr
)

25 
pud_t
 *
pud
;

26 
pmd_t
 *
pmd
;

27 
·ge
 *page;

28 
»suÉ
 = -
ENOMEM
;

30 
addr
 &ğ
PMD_MASK
;

31 
pgd
 +ğ
	`pgd_šdex
(
addr
);

32 ià(!
	`pgd_´e£Á
(*
pgd
)) {

33 
·ge
 = 
	`kimage_®loc_cÚŒŞ_·ges
(
image
, 0);

34 ià(!
·ge
)

35 
out
;

36 
pud
 = (
pud_t
 *)
	`·ge_add»ss
(
·ge
);

37 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

38 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__·
(
pud
è| 
_KERNPG_TABLE
));

40 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

41 ià(!
	`pud_´e£Á
(*
pud
)) {

42 
·ge
 = 
	`kimage_®loc_cÚŒŞ_·ges
(
image
, 0);

43 ià(!
·ge
)

44 
out
;

45 
pmd
 = (
pmd_t
 *)
	`·ge_add»ss
(
·ge
);

46 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

47 
	`£t_pud
(
pud
, 
	`__pud
(
	`__·
(
pmd
è| 
_KERNPG_TABLE
));

49 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

50 ià(!
	`pmd_´e£Á
(*
pmd
))

51 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

52 
»suÉ
 = 0;

53 
out
:

54  
»suÉ
;

55 
	}
}

57 
	$š™_Ëv–2_·ge
(
pmd_t
 *
Ëv–2p
, 
addr
)

59 
’d_addr
;

61 
addr
 &ğ
PAGE_MASK
;

62 
’d_addr
 = 
addr
 + 
PUD_SIZE
;

63 
addr
 < 
’d_addr
) {

64 
	`£t_pmd
(
Ëv–2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

65 
addr
 +ğ
PMD_SIZE
;

67 
	}
}

69 
	$š™_Ëv–3_·ge
(
kimage
 *
image
, 
pud_t
 *
Ëv–3p
,

70 
addr
, 
Ï¡_addr
)

72 
’d_addr
;

73 
»suÉ
;

75 
»suÉ
 = 0;

76 
addr
 &ğ
PAGE_MASK
;

77 
’d_addr
 = 
addr
 + 
PGDIR_SIZE
;

78 (
addr
 < 
Ï¡_addr
è&& (add¸< 
’d_addr
)) {

79 
·ge
 *page;

80 
pmd_t
 *
Ëv–2p
;

82 
·ge
 = 
	`kimage_®loc_cÚŒŞ_·ges
(
image
, 0);

83 ià(!
·ge
) {

84 
»suÉ
 = -
ENOMEM
;

85 
out
;

87 
Ëv–2p
 = (
pmd_t
 *)
	`·ge_add»ss
(
·ge
);

88 
	`š™_Ëv–2_·ge
(
Ëv–2p
, 
addr
);

89 
	`£t_pud
(
Ëv–3p
++, 
	`__pud
(
	`__·
(
Ëv–2p
è| 
_KERNPG_TABLE
));

90 
addr
 +ğ
PUD_SIZE
;

93 
addr
 < 
’d_addr
) {

94 
	`pud_ş—r
(
Ëv–3p
++);

95 
addr
 +ğ
PUD_SIZE
;

97 
out
:

98  
»suÉ
;

99 
	}
}

102 
	$š™_Ëv–4_·ge
(
kimage
 *
image
, 
pgd_t
 *
Ëv–4p
,

103 
addr
, 
Ï¡_addr
)

105 
’d_addr
;

106 
»suÉ
;

108 
»suÉ
 = 0;

109 
addr
 &ğ
PAGE_MASK
;

110 
’d_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

111 (
addr
 < 
Ï¡_addr
è&& (add¸< 
’d_addr
)) {

112 
·ge
 *page;

113 
pud_t
 *
Ëv–3p
;

115 
·ge
 = 
	`kimage_®loc_cÚŒŞ_·ges
(
image
, 0);

116 ià(!
·ge
) {

117 
»suÉ
 = -
ENOMEM
;

118 
out
;

120 
Ëv–3p
 = (
pud_t
 *)
	`·ge_add»ss
(
·ge
);

121 
»suÉ
 = 
	`š™_Ëv–3_·ge
(
image
, 
Ëv–3p
, 
addr
, 
Ï¡_addr
);

122 ià(
»suÉ
)

123 
out
;

124 
	`£t_pgd
(
Ëv–4p
++, 
	`__pgd
(
	`__·
(
Ëv–3p
è| 
_KERNPG_TABLE
));

125 
addr
 +ğ
PGDIR_SIZE
;

128 
addr
 < 
’d_addr
) {

129 
	`pgd_ş—r
(
Ëv–4p
++);

130 
addr
 +ğ
PGDIR_SIZE
;

132 
out
:

133  
»suÉ
;

134 
	}
}

136 
	$ä“_Œªs™iÚ_pgbË
(
kimage
 *
image
)

138 
	`ä“_·ge
(()
image
->
¬ch
.
pud
);

139 
	`ä“_·ge
(()
image
->
¬ch
.
pmd
);

140 
	`ä“_·ge
(()
image
->
¬ch
.
±e
);

141 
	}
}

143 
	$š™_Œªs™iÚ_pgbË
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

145 
pud_t
 *
pud
;

146 
pmd_t
 *
pmd
;

147 
±e_t
 *
±e
;

148 
vaddr
, 
·ddr
;

149 
»suÉ
 = -
ENOMEM
;

151 
vaddr
 = ()
»loÿ‹_k”Ãl
;

152 
·ddr
 = 
	`__·
(
	`·ge_add»ss
(
image
->
cÚŒŞ_code_·ge
)+
PAGE_SIZE
);

153 
pgd
 +ğ
	`pgd_šdex
(
vaddr
);

154 ià(!
	`pgd_´e£Á
(*
pgd
)) {

155 
pud
 = (
pud_t
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

156 ià(!
pud
)

157 
”r
;

158 
image
->
¬ch
.
pud
 =…ud;

159 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__·
(
pud
è| 
_KERNPG_TABLE
));

161 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

162 ià(!
	`pud_´e£Á
(*
pud
)) {

163 
pmd
 = (
pmd_t
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

164 ià(!
pmd
)

165 
”r
;

166 
image
->
¬ch
.
pmd
 =…md;

167 
	`£t_pud
(
pud
, 
	`__pud
(
	`__·
(
pmd
è| 
_KERNPG_TABLE
));

169 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

170 ià(!
	`pmd_´e£Á
(*
pmd
)) {

171 
±e
 = (
±e_t
 *)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

172 ià(!
±e
)

173 
”r
;

174 
image
->
¬ch
.
±e
 =…te;

175 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__·
(
±e
è| 
_KERNPG_TABLE
));

177 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
vaddr
);

178 
	`£t_±e
(
±e
, 
	`pâ_±e
(
·ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

180 
”r
:

181 
	`ä“_Œªs™iÚ_pgbË
(
image
);

182  
»suÉ
;

183 
	}
}

186 
	$š™_pgbË
(
kimage
 *
image
, 
¡¬t_pgbË
)

188 
pgd_t
 *
Ëv–4p
;

189 
»suÉ
;

190 
Ëv–4p
 = (
pgd_t
 *)
	`__va
(
¡¬t_pgbË
);

191 
»suÉ
 = 
	`š™_Ëv–4_·ge
(
image
, 
Ëv–4p
, 0, 
max_pâ
 << 
PAGE_SHIFT
);

192 ià(
»suÉ
)

193  
»suÉ
;

198 
»suÉ
 = 
	`š™_Úe_Ëv–2_·ge
(
image
, 
Ëv–4p
, image->
¡¬t
);

199 ià(
»suÉ
)

200  
»suÉ
;

201  
	`š™_Œªs™iÚ_pgbË
(
image
, 
Ëv–4p
);

202 
	}
}

204 
	$£t_idt
(*
Ãwidt
, 
u16
 
lim™
)

206 
desc_±r
 
curidt
;

209 
curidt
.
size
 = 
lim™
;

210 
curidt
.
add»ss
 = ()
Ãwidt
;

212 
__asm__
 
	`__vŞ©e__
 (

214 : : "m" (
curidt
)

216 
	}
};

219 
	$£t_gdt
(*
Ãwgdt
, 
u16
 
lim™
)

221 
desc_±r
 
curgdt
;

224 
curgdt
.
size
 = 
lim™
;

225 
curgdt
.
add»ss
 = ()
Ãwgdt
;

227 
__asm__
 
	`__vŞ©e__
 (

229 : : "m" (
curgdt
)

231 
	}
};

233 
	$lßd_£gm’ts
()

235 
__asm__
 
	`__vŞ©e__
 (

241 : : "a" (
__KERNEL_DS
) : "memory"

243 
	}
}

245 
	$machše_kexec_´•¬e
(
kimage
 *
image
)

247 
¡¬t_pgbË
;

248 
»suÉ
;

251 
¡¬t_pgbË
 = 
	`·ge_to_pâ
(
image
->
cÚŒŞ_code_·ge
è<< 
PAGE_SHIFT
;

254 
»suÉ
 = 
	`š™_pgbË
(
image
, 
¡¬t_pgbË
);

255 ià(
»suÉ
)

256  
»suÉ
;

259 
	}
}

261 
	$machše_kexec_ş—nup
(
kimage
 *
image
)

263 
	`ä“_Œªs™iÚ_pgbË
(
image
);

264 
	}
}

270 
	$machše_kexec
(
kimage
 *
image
)

272 
·ge_li¡
[
PAGES_NR
];

273 *
cÚŒŞ_·ge
;

274 
§ve_á¿û_’abËd
;

276 #ifdeà
CONFIG_KEXEC_JUMP


277 ià(
image
->
´e£rve_cÚ‹xt
)

278 
	`§ve_´oûssÜ_¡©e
();

281 
§ve_á¿û_’abËd
 = 
	`__á¿û_’abËd_§ve
();

284 
	`loÿl_œq_di§bË
();

286 ià(
image
->
´e£rve_cÚ‹xt
) {

287 #ifdeà
CONFIG_X86_IO_APIC


295 
	`di§bË_IO_APIC
();

299 
cÚŒŞ_·ge
 = 
	`·ge_add»ss
(
image
->
cÚŒŞ_code_·ge
è+ 
PAGE_SIZE
;

300 
	`memıy
(
cÚŒŞ_·ge
, 
»loÿ‹_k”Ãl
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

302 
·ge_li¡
[
PA_CONTROL_PAGE
] = 
	`vœt_to_phys
(
cÚŒŞ_·ge
);

303 
·ge_li¡
[
VA_CONTROL_PAGE
] = ()
cÚŒŞ_·ge
;

304 
·ge_li¡
[
PA_TABLE_PAGE
] =

305 ()
	`__·
(
	`·ge_add»ss
(
image
->
cÚŒŞ_code_·ge
));

307 ià(
image
->
ty³
 =ğ
KEXEC_TYPE_DEFAULT
)

308 
·ge_li¡
[
PA_SWAP_PAGE
] = (
	`·ge_to_pâ
(
image
->
sw­_·ge
)

309 << 
PAGE_SHIFT
);

321 
	`lßd_£gm’ts
();

326 
	`£t_gdt
(
	`phys_to_vœt
(0), 0);

327 
	`£t_idt
(
	`phys_to_vœt
(0), 0);

330 
image
->
¡¬t
 = 
	`»loÿ‹_k”Ãl
(()image->
h—d
,

331 ()
·ge_li¡
,

332 
image
->
¡¬t
,

333 
image
->
´e£rve_cÚ‹xt
);

335 #ifdeà
CONFIG_KEXEC_JUMP


336 ià(
image
->
´e£rve_cÚ‹xt
)

337 
	`»¡Üe_´oûssÜ_¡©e
();

340 
	`__á¿û_’abËd_»¡Üe
(
§ve_á¿û_’abËd
);

341 
	}
}

343 
	$¬ch_üash_§ve_vmcÜešfo
()

345 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

346 
	`VMCOREINFO_SYMBOL
(
š™_Ëv–4_pgt
);

348 #ifdeà
CONFIG_NUMA


349 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

350 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

352 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

16 
	~<lšux/¶©fÜm_deviû.h
>

17 
	~<lšux/ÿ·b™y.h
>

18 
	~<lšux/miscdeviû.h
>

19 
	~<lšux/fœmw¬e.h
>

20 
	~<lšux/¥šlock.h
>

21 
	~<lšux/ıumask.h
>

22 
	~<lšux/pci_ids.h
>

23 
	~<lšux/uacûss.h
>

24 
	~<lšux/vm®loc.h
>

25 
	~<lšux/k”Ãl.h
>

26 
	~<lšux/moduË.h
>

27 
	~<lšux/mu‹x.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/¦ab.h
>

31 
	~<lšux/ıu.h
>

32 
	~<lšux/pci.h
>

33 
	~<lšux/fs.h
>

34 
	~<lšux/mm.h
>

36 
	~<asm/miüocode.h
>

37 
	~<asm/´oûssÜ.h
>

38 
	~<asm/m¤.h
>

40 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

41 
MODULE_AUTHOR
("Peter Oruba");

42 
MODULE_LICENSE
("GPL v2");

44 
	#UCODE_MAGIC
 0x00414d44

	)

45 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

46 
	#UCODE_UCODE_TYPE
 0x00000001

	)

48 
	sequiv_ıu_’Œy
 {

49 
u32
 
	mš¡®Ëd_ıu
;

50 
u32
 
	mfixed_”¿_mask
;

51 
u32
 
	mfixed_”¿_com·»
;

52 
u16
 
	mequiv_ıu
;

53 
u16
 
	m»s
;

54 } 
__©Œibu‹__
((
·cked
));

56 
	smiüocode_h—d”_amd
 {

57 
u32
 
	md©a_code
;

58 
u32
 
	m·tch_id
;

59 
u16
 
	mmc_·tch_d©a_id
;

60 
u8
 
	mmc_·tch_d©a_Ën
;

61 
u8
 
	mš™_æag
;

62 
u32
 
	mmc_·tch_d©a_checksum
;

63 
u32
 
	mnb_dev_id
;

64 
u32
 
	msb_dev_id
;

65 
u16
 
	m´oûssÜ_»v_id
;

66 
u8
 
	mnb_»v_id
;

67 
u8
 
	msb_»v_id
;

68 
u8
 
	mbios_­i_»v
;

69 
u8
 
	m»£rved1
[3];

70 
u32
 
	mm©ch_»g
[8];

71 } 
__©Œibu‹__
((
·cked
));

73 
	smiüocode_amd
 {

74 
miüocode_h—d”_amd
 
	mhdr
;

75 
	mmpb
[0];

78 
	#UCODE_MAX_SIZE
 2048

	)

79 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

80 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

83 
DEFINE_SPINLOCK
(
miüocode_upd©e_lock
);

85 
equiv_ıu_’Œy
 *
	gequiv_ıu_bË
;

87 
	$cŞËù_ıu_šfo_amd
(
ıu
, 
ıu_sigÇtu»
 *
csig
)

89 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

90 
u32
 
dummy
;

92 
	`mem£t
(
csig
, 0, (*csig));

93 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

94 
	`´štk
(
KERN_WARNING
 "microcode: CPU%d: AMD CPU family 0x%x‚ot "

95 "suµÜ‹d\n", 
ıu
, 
c
->
x86
);

98 
	`rdm¤
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
»v
, 
dummy
);

99 
	`´štk
(
KERN_INFO
 "miüocode: CPU%d:…©ch_Ëv–=0x%x\n", 
ıu
, 
csig
->
»v
);

101 
	}
}

103 
	$g‘_m©chšg_miüocode
(
ıu
, *
mc
, 
»v
)

105 
miüocode_h—d”_amd
 *
mc_h—d”
 = 
mc
;

106 
cu¼’t_ıu_id
;

107 
u16
 
equiv_ıu_id
 = 0;

108 
i
 = 0;

110 
	`BUG_ON
(
equiv_ıu_bË
 =ğ
NULL
);

111 
cu¼’t_ıu_id
 = 
	`ıuid_—x
(0x00000001);

113 
equiv_ıu_bË
[
i
].
š¡®Ëd_ıu
 != 0) {

114 ià(
cu¼’t_ıu_id
 =ğ
equiv_ıu_bË
[
i
].
š¡®Ëd_ıu
) {

115 
equiv_ıu_id
 = 
equiv_ıu_bË
[
i
].
equiv_ıu
;

118 
i
++;

121 ià(!
equiv_ıu_id
) {

122 
	`´štk
(
KERN_WARNING
 "microcode: CPU%d: cpu„evision "

123 "nÙ†i¡ed iÀequiv®’ˆıuabË\n", 
ıu
);

127 ià(
mc_h—d”
->
´oûssÜ_»v_id
 !ğ
equiv_ıu_id
) {

128 
	`´štk
(
KERN_ERR
 "microcode: CPU%d:…atch mismatch "

130 
ıu
, 
mc_h—d”
->
´oûssÜ_»v_id
, 
equiv_ıu_id
);

135 ià(
mc_h—d”
->
nb_dev_id
 || mc_h—d”->
sb_dev_id
) {

136 
	`´štk
(
KERN_ERR
 "microcode: CPU%d:†oading of chipset "

137 "¥ecifiøcodnÙ y‘ suµÜ‹d\n", 
ıu
);

141 ià(
mc_h—d”
->
·tch_id
 <ğ
»v
)

145 
	}
}

147 
	$­¶y_miüocode_amd
(
ıu
)

149 
æags
;

150 
u32
 
»v
, 
dummy
;

151 
ıu_num
 = 
	`¿w_smp_´oûssÜ_id
();

152 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu_num
;

153 
miüocode_amd
 *
mc_amd
 = 
uci
->
mc
;

156 
	`BUG_ON
(
ıu_num
 !ğ
ıu
);

158 ià(
mc_amd
 =ğ
NULL
)

161 
	`¥š_lock_œq§ve
(&
miüocode_upd©e_lock
, 
æags
);

162 
	`wrm¤l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

164 
	`rdm¤
(
MSR_AMD64_PATCH_LEVEL
, 
»v
, 
dummy
);

165 
	`¥š_uÆock_œq»¡Üe
(&
miüocode_upd©e_lock
, 
æags
);

168 ià(
»v
 !ğ
mc_amd
->
hdr
.
·tch_id
) {

169 
	`´štk
(
KERN_ERR
 "microcode: CPU%d: update failed "

170 "(fÜ…©ch_Ëv–=0x%x)\n", 
ıu
, 
mc_amd
->
hdr
.
·tch_id
);

174 
	`´štk
(
KERN_INFO
 "microcode: CPU%d: updated (new…atch_level=0x%x)\n",

175 
ıu
, 
»v
);

177 
uci
->
ıu_sig
.
»v
 =„ev;

178 
	}
}

180 
	$g‘_ucode_d©a
(*
to
, cÚ¡ 
u8
 *
äom
, 
size_t
 
n
)

182 
	`memıy
(
to
, 
äom
, 
n
);

184 
	}
}

187 
	$g‘_Ãxt_ucode
(cÚ¡ 
u8
 *
buf
, 
size
, *
mc_size
)

189 
tÙ®_size
;

190 
u8
 
£ùiÚ_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

191 *
mc
;

193 ià(
	`g‘_ucode_d©a
(
£ùiÚ_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

194  
NULL
;

196 ià(
£ùiÚ_hdr
[0] !ğ
UCODE_UCODE_TYPE
) {

197 
	`´štk
(
KERN_ERR
 "microcode:ƒrror: invalidype field in "

199  
NULL
;

202 
tÙ®_size
 = (è(
£ùiÚ_hdr
[4] + (section_hdr[5] << 8));

204 
	`´štk
(
KERN_DEBUG
 "microcode: size %u,otal_size %u\n",

205 
size
, 
tÙ®_size
);

207 ià(
tÙ®_size
 > 
size
 ||Ù®_siz> 
UCODE_MAX_SIZE
) {

208 
	`´štk
(
KERN_ERR
 "microcode:ƒrror: size mismatch\n");

209  
NULL
;

212 
mc
 = 
	`vm®loc
(
UCODE_MAX_SIZE
);

213 ià(
mc
) {

214 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

215 ià(
	`g‘_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

216 
tÙ®_size
)) {

217 
	`vä“
(
mc
);

218 
mc
 = 
NULL
;

220 *
mc_size
 = 
tÙ®_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

222  
mc
;

223 
	}
}

225 
	$š¡®l_equiv_ıu_bË
(cÚ¡ 
u8
 *
buf
)

227 
u8
 *
cÚš”_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

228 *
buf_pos
 = (*)
cÚš”_hdr
;

229 
size
;

231 ià(
	`g‘_ucode_d©a
(&
cÚš”_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

234 
size
 = 
buf_pos
[2];

236 ià(
buf_pos
[1] !ğ
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

237 
	`´štk
(
KERN_ERR
 "microcode:ƒrror: invalidype field in "

242 
equiv_ıu_bË
 = (
equiv_ıu_’Œy
 *è
	`vm®loc
(
size
);

243 ià(!
equiv_ıu_bË
) {

244 
	`´štk
(
KERN_ERR
 "microcode: failedo‡llocate "

249 
buf
 +ğ
UCODE_CONTAINER_HEADER_SIZE
;

250 ià(
	`g‘_ucode_d©a
(
equiv_ıu_bË
, 
buf
, 
size
)) {

251 
	`vä“
(
equiv_ıu_bË
);

255  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

256 
	}
}

258 
	$ä“_equiv_ıu_bË
()

260 ià(
equiv_ıu_bË
) {

261 
	`vä“
(
equiv_ıu_bË
);

262 
equiv_ıu_bË
 = 
NULL
;

264 
	}
}

266 
	$g’”ic_lßd_miüocode
(
ıu
, cÚ¡ 
u8
 *
d©a
, 
size_t
 
size
)

268 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

269 cÚ¡ 
u8
 *
ucode_±r
 = 
d©a
;

270 *
Ãw_mc
 = 
NULL
;

271 *
mc
;

272 
Ãw_»v
 = 
uci
->
ıu_sig
.
»v
;

273 
Ëáov”
;

274 
off£t
;

276 
off£t
 = 
	`š¡®l_equiv_ıu_bË
(
ucode_±r
);

277 ià(!
off£t
) {

278 
	`´štk
(
KERN_ERR
 "microcode: failedo create "

280  -
EINVAL
;

283 
ucode_±r
 +ğ
off£t
;

284 
Ëáov”
 = 
size
 - 
off£t
;

286 
Ëáov”
) {

287 
	`unš™Ÿlized_v¬
(
mc_size
);

288 
miüocode_h—d”_amd
 *
mc_h—d”
;

290 
mc
 = 
	`g‘_Ãxt_ucode
(
ucode_±r
, 
Ëáov”
, &
mc_size
);

291 ià(!
mc
)

294 
mc_h—d”
 = (
miüocode_h—d”_amd
 *)
mc
;

295 ià(
	`g‘_m©chšg_miüocode
(
ıu
, 
mc
, 
Ãw_»v
)) {

296 ià(
Ãw_mc
)

297 
	`vä“
(
Ãw_mc
);

298 
Ãw_»v
 = 
mc_h—d”
->
·tch_id
;

299 
Ãw_mc
 = 
mc
;

301 
	`vä“
(
mc
);

303 
ucode_±r
 +ğ
mc_size
;

304 
Ëáov”
 -ğ
mc_size
;

307 ià(
Ãw_mc
) {

308 ià(!
Ëáov”
) {

309 ià(
uci
->
mc
)

310 
	`vä“
(
uci
->
mc
);

311 
uci
->
mc
 = 
Ãw_mc
;

312 
	`´_debug
("microcode: CPU%d found‡ matching microcode "

314 
ıu
, 
Ãw_»v
, 
uci
->
ıu_sig
.
»v
);

316 
	`vä“
(
Ãw_mc
);

319 
	`ä“_equiv_ıu_bË
();

321  ()
Ëáov”
;

322 
	}
}

324 
	$»que¡_miüocode_fw
(
ıu
, 
deviû
 *device)

326 cÚ¡ *
fw_Çme
 = "amd-ucode/microcode_amd.bin";

327 cÚ¡ 
fœmw¬e
 *firmware;

328 
»t
;

331 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

333 
»t
 = 
	`»que¡_fœmw¬e
(&
fœmw¬e
, 
fw_Çme
, 
deviû
);

334 ià(
»t
) {

335 
	`´štk
(
KERN_ERR
 "miüocode: faedØlßd f%s\n", 
fw_Çme
);

336  
»t
;

339 
»t
 = 
	`g’”ic_lßd_miüocode
(
ıu
, 
fœmw¬e
->
d©a
, fœmw¬e->
size
);

341 
	`»Ëa£_fœmw¬e
(
fœmw¬e
);

343  
»t
;

344 
	}
}

346 
	$»que¡_miüocode_u£r
(
ıu
, cÚ¡ 
__u£r
 *
buf
, 
size_t
 
size
)

348 
	`´štk
(
KERN_INFO
 "microcode: AMD microcode update via "

351 
	}
}

353 
	$miüocode_fši_ıu_amd
(
ıu
)

355 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

357 
	`vä“
(
uci
->
mc
);

358 
uci
->
mc
 = 
NULL
;

359 
	}
}

361 
miüocode_İs
 
	gmiüocode_amd_İs
 = {

362 .
»que¡_miüocode_u£r
 =„equest_microcode_user,

363 .
	g»que¡_miüocode_fw
 = 
»que¡_miüocode_fw
,

364 .
	gcŞËù_ıu_šfo
 = 
cŞËù_ıu_šfo_amd
,

365 .
	g­¶y_miüocode
 = 
­¶y_miüocode_amd
,

366 .
	gmiüocode_fši_ıu
 = 
miüocode_fši_ıu_amd
,

369 
miüocode_İs
 * 
__š™
 
	$š™_amd_miüocode
()

371  &
miüocode_amd_İs
;

372 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

73 
	~<lšux/¶©fÜm_deviû.h
>

74 
	~<lšux/ÿ·b™y.h
>

75 
	~<lšux/miscdeviû.h
>

76 
	~<lšux/fœmw¬e.h
>

77 
	~<lšux/smp_lock.h
>

78 
	~<lšux/¥šlock.h
>

79 
	~<lšux/ıumask.h
>

80 
	~<lšux/uacûss.h
>

81 
	~<lšux/vm®loc.h
>

82 
	~<lšux/k”Ãl.h
>

83 
	~<lšux/moduË.h
>

84 
	~<lšux/mu‹x.h
>

85 
	~<lšux/sched.h
>

86 
	~<lšux/š™.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/ıu.h
>

89 
	~<lšux/fs.h
>

90 
	~<lšux/mm.h
>

92 
	~<asm/miüocode.h
>

93 
	~<asm/´oûssÜ.h
>

94 
	~<asm/m¤.h
>

96 
MODULE_DESCRIPTION
("Microcode Update Driver");

97 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

98 
MODULE_LICENSE
("GPL");

100 
	#MICROCODE_VERSION
 "2.00"

	)

102 
miüocode_İs
 *
	gmiüocode_İs
;

105 
DEFINE_MUTEX
(
miüocode_mu‹x
);

107 
ucode_ıu_šfo
 
	gucode_ıu_šfo
[
NR_CPUS
];

108 
EXPORT_SYMBOL_GPL
(
ucode_ıu_šfo
);

110 #ifdeà
CONFIG_MICROCODE_OLD_INTERFACE


111 
	$do_miüocode_upd©e
(cÚ¡ 
__u£r
 *
buf
, 
size_t
 
size
)

113 
ıumask_t
 
Şd
;

114 
”rÜ
 = 0;

115 
ıu
;

117 
Şd
 = 
cu¼’t
->
ıus_®lowed
;

119 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

120 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

122 ià(!
uci
->
v®id
)

125 
	`£t_ıus_®lowed_±r
(
cu¼’t
, &
	`ıumask_of_ıu
(
ıu
));

126 
”rÜ
 = 
miüocode_İs
->
	`»que¡_miüocode_u£r
(
ıu
, 
buf
, 
size
);

127 ià(
”rÜ
 < 0)

128 
out
;

129 ià(!
”rÜ
)

130 
miüocode_İs
->
	`­¶y_miüocode
(
ıu
);

132 
out
:

133 
	`£t_ıus_®lowed_±r
(
cu¼’t
, &
Şd
);

134  
”rÜ
;

135 
	}
}

137 
	$miüocode_İ’
(
šode
 *
unu£d1
, 
fe
 *
unu£d2
)

139 
	`cyşe_k”Ãl_lock
();

140  
	`ÿ·bË
(
CAP_SYS_RAWIO
è? 0 : -
EPERM
;

141 
	}
}

143 
ssize_t
 
	$miüocode_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
,

144 
size_t
 
Ën
, 
loff_t
 *
µos
)

146 
ssize_t
 
»t
;

148 ià((
Ën
 >> 
PAGE_SHIFT
è> 
num_phy¥ages
) {

149 
	`´štk
(
KERN_ERR
 "microcode:oo much data (max %ld…ages)\n",

150 
num_phy¥ages
);

151  -
EINVAL
;

154 
	`g‘_Úlše_ıus
();

155 
	`mu‹x_lock
(&
miüocode_mu‹x
);

157 
»t
 = 
	`do_miüocode_upd©e
(
buf
, 
Ën
);

158 ià(!
»t
)

159 
»t
 = (
ssize_t
)
Ën
;

161 
	`mu‹x_uÆock
(&
miüocode_mu‹x
);

162 
	`put_Úlše_ıus
();

164  
»t
;

165 
	}
}

167 cÚ¡ 
fe_İ”©iÚs
 
	gmiüocode_fİs
 = {

168 .
owÃr
 = 
THIS_MODULE
,

169 .
	gwr™e
 = 
miüocode_wr™e
,

170 .
	gİ’
 = 
miüocode_İ’
,

173 
miscdeviû
 
	gmiüocode_dev
 = {

174 .
mšÜ
 = 
MICROCODE_MINOR
,

175 .
	gÇme
 = "microcode",

176 .
	gfİs
 = &
miüocode_fİs
,

179 
__š™
 
	$miüocode_dev_š™
()

181 
”rÜ
;

183 
”rÜ
 = 
	`misc_»gi¡”
(&
miüocode_dev
);

184 ià(
”rÜ
) {

185 
	`´štk
(
KERN_ERR


187 
MICROCODE_MINOR
);

188  
”rÜ
;

192 
	}
}

194 
	$miüocode_dev_ex™
()

196 
	`misc_d”egi¡”
(&
miüocode_dev
);

197 
	}
}

199 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

201 
	#miüocode_dev_š™
(è0

	)

202 
	#miüocode_dev_ex™
(èdØ{ } 0)

	)

206 
¶©fÜm_deviû
 *
	gmiüocode_pdev
;

208 
	$»lßd_fÜ_ıu
(*
unu£d
)

210 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
	`smp_´oûssÜ_id
();

211 
”r
 = 0;

213 
	`mu‹x_lock
(&
miüocode_mu‹x
);

214 ià(
uci
->
v®id
) {

215 
”r
 = 
miüocode_İs
->
	`»que¡_miüocode_fw
(
	`smp_´oûssÜ_id
(),

216 &
miüocode_pdev
->
dev
);

217 ià(!
”r
)

218 
miüocode_İs
->
	`­¶y_miüocode
(
	`smp_´oûssÜ_id
());

220 
	`mu‹x_uÆock
(&
miüocode_mu‹x
);

221  
”r
;

222 
	}
}

224 
ssize_t
 
	$»lßd_¡Üe
(
sys_deviû
 *
dev
,

225 
sysdev_©Œibu‹
 *
©Œ
,

226 cÚ¡ *
buf
, 
size_t
 
sz
)

228 *
’d
;

229 
v®
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0);

230 
”r
 = 0;

231 
ıu
 = 
dev
->
id
;

233 ià(
’d
 =ğ
buf
)

234  -
EINVAL
;

235 ià(
v®
 == 1) {

236 
	`g‘_Úlše_ıus
();

237 ià(
	`ıu_Úlše
(
ıu
))

238 
”r
 = 
	`wÜk_Ú_ıu
(
ıu
, 
»lßd_fÜ_ıu
, 
NULL
);

239 
	`put_Úlše_ıus
();

241 ià(
”r
)

242  
”r
;

243  
sz
;

244 
	}
}

246 
ssize_t
 
	$v”siÚ_show
(
sys_deviû
 *
dev
,

247 
sysdev_©Œibu‹
 *
©Œ
, *
buf
)

249 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
dev
->
id
;

251  
	`¥rštf
(
buf
, "0x%x\n", 
uci
->
ıu_sig
.
»v
);

252 
	}
}

254 
ssize_t
 
	$pf_show
(
sys_deviû
 *
dev
,

255 
sysdev_©Œibu‹
 *
©Œ
, *
buf
)

257 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
dev
->
id
;

259  
	`¥rštf
(
buf
, "0x%x\n", 
uci
->
ıu_sig
.
pf
);

260 
	}
}

262 
SYSDEV_ATTR
(
»lßd
, 0200, 
NULL
, 
»lßd_¡Üe
);

263 
SYSDEV_ATTR
(
v”siÚ
, 0400, 
v”siÚ_show
, 
NULL
);

264 
SYSDEV_ATTR
(
´oûssÜ_æags
, 0400, 
pf_show
, 
NULL
);

266 
©Œibu‹
 *
	gmc_deçuÉ_©Œs
[] = {

267 &
©Œ_»lßd
.
©Œ
,

268 &
©Œ_v”siÚ
.
©Œ
,

269 &
©Œ_´oûssÜ_æags
.
©Œ
,

270 
NULL


273 
©Œibu‹_group
 
	gmc_©Œ_group
 = {

274 .
©Œs
 = 
mc_deçuÉ_©Œs
,

275 .
	gÇme
 = "microcode",

278 
	$__miüocode_fši_ıu
(
ıu
)

280 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

282 
miüocode_İs
->
	`miüocode_fši_ıu
(
ıu
);

283 
uci
->
v®id
 = 0;

284 
	}
}

286 
	$miüocode_fši_ıu
(
ıu
)

288 
	`mu‹x_lock
(&
miüocode_mu‹x
);

289 
	`__miüocode_fši_ıu
(
ıu
);

290 
	`mu‹x_uÆock
(&
miüocode_mu‹x
);

291 
	}
}

293 
	$cŞËù_ıu_šfo
(
ıu
)

295 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

297 
	`mem£t
(
uci
, 0, (*uci));

298 ià(!
miüocode_İs
->
	`cŞËù_ıu_šfo
(
ıu
, &
uci
->
ıu_sig
))

299 
uci
->
v®id
 = 1;

300 
	}
}

302 
	$miüocode_»sume_ıu
(
ıu
)

304 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

305 
ıu_sigÇtu»
 
nsig
;

307 
	`´_debug
("miüocode: CPU%d„esumed\n", 
ıu
);

309 ià(!
uci
->
mc
)

316 ià(
miüocode_İs
->
	`cŞËù_ıu_šfo
(
ıu
, &
nsig
)) {

317 
	`__miüocode_fši_ıu
(
ıu
);

318 
	`´štk
(
KERN_ERR
 "failedo collect_cpu_info for„esuming cpu #%d\n",

319 
ıu
);

323 ià((
nsig
.
sig
 !ğ
uci
->
ıu_sig
.sigè|| (nsig.
pf
 != uci->cpu_sig.pf)) {

324 
	`__miüocode_fši_ıu
(
ıu
);

325 
	`´štk
(
KERN_ERR
 "cached ucode doesn't matchhe„esuming cpu #%d\n",

326 
ıu
);

332 
	}
}

334 
	$miüocode_upd©e_ıu
(*
unu£d
)

336 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
	`smp_´oûssÜ_id
();

337 
”r
 = 0;

343 ià(
uci
->
v®id
) {

344 
”r
 = 
	`miüocode_»sume_ıu
(
	`smp_´oûssÜ_id
());

346 
	`cŞËù_ıu_šfo
(
	`smp_´oûssÜ_id
());

347 ià(
uci
->
v®id
 && 
sy¡em_¡©e
 =ğ
SYSTEM_RUNNING
)

348 
”r
 = 
miüocode_İs
->
	`»que¡_miüocode_fw
(

349 
	`smp_´oûssÜ_id
(),

350 &
miüocode_pdev
->
dev
);

352 ià(!
”r
)

353 
miüocode_İs
->
	`­¶y_miüocode
(
	`smp_´oûssÜ_id
());

354  
”r
;

355 
	}
}

357 
	$miüocode_š™_ıu
(
ıu
)

359 
”r
;

360 
	`mu‹x_lock
(&
miüocode_mu‹x
);

361 
”r
 = 
	`wÜk_Ú_ıu
(
ıu
, 
miüocode_upd©e_ıu
, 
NULL
);

362 
	`mu‹x_uÆock
(&
miüocode_mu‹x
);

364  
”r
;

365 
	}
}

367 
	$mc_sysdev_add
(
sys_deviû
 *
sys_dev
)

369 
”r
, 
ıu
 = 
sys_dev
->
id
;

370 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

372 ià(!
	`ıu_Úlše
(
ıu
))

375 
	`´_debug
("miüocode: CPU%d‡dded\n", 
ıu
);

376 
	`mem£t
(
uci
, 0, (*uci));

378 
”r
 = 
	`sysfs_ü—‹_group
(&
sys_dev
->
kobj
, &
mc_©Œ_group
);

379 ià(
”r
)

380  
”r
;

382 
”r
 = 
	`miüocode_š™_ıu
(
ıu
);

384  
”r
;

385 
	}
}

387 
	$mc_sysdev_»move
(
sys_deviû
 *
sys_dev
)

389 
ıu
 = 
sys_dev
->
id
;

391 ià(!
	`ıu_Úlše
(
ıu
))

394 
	`´_debug
("miüocode: CPU%d„emoved\n", 
ıu
);

395 
	`miüocode_fši_ıu
(
ıu
);

396 
	`sysfs_»move_group
(&
sys_dev
->
kobj
, &
mc_©Œ_group
);

398 
	}
}

400 
	$mc_sysdev_»sume
(
sys_deviû
 *
dev
)

402 
ıu
 = 
dev
->
id
;

404 ià(!
	`ıu_Úlše
(
ıu
))

408 
	`miüocode_upd©e_ıu
(
NULL
);

410 
	}
}

412 
sysdev_driv”
 
	gmc_sysdev_driv”
 = {

413 .
add
 = 
mc_sysdev_add
,

414 .
	g»move
 = 
mc_sysdev_»move
,

415 .
	g»sume
 = 
mc_sysdev_»sume
,

418 
__ıuš™
 

419 
	$mc_ıu_ÿÎback
(
nÙif›r_block
 *
nb
, 
aùiÚ
, *
hıu
)

421 
ıu
 = ()
hıu
;

422 
sys_deviû
 *
sys_dev
;

424 
sys_dev
 = 
	`g‘_ıu_sysdev
(
ıu
);

425 
aùiÚ
) {

426 
CPU_ONLINE
:

427 
CPU_ONLINE_FROZEN
:

428 ià(
	`miüocode_š™_ıu
(
ıu
))

429 
	`´štk
(
KERN_ERR
 "microcode: failedo init CPU%d\n",

430 
ıu
);

431 
CPU_DOWN_FAILED
:

432 
CPU_DOWN_FAILED_FROZEN
:

433 
	`´_debug
("miüocode: CPU%d‡dded\n", 
ıu
);

434 ià(
	`sysfs_ü—‹_group
(&
sys_dev
->
kobj
, &
mc_©Œ_group
))

435 
	`´štk
(
KERN_ERR
 "microcode: Failedo createhe sysfs "

436 "grou°fÜ CPU%d\n", 
ıu
);

438 
CPU_DOWN_PREPARE
:

439 
CPU_DOWN_PREPARE_FROZEN
:

441 
	`sysfs_»move_group
(&
sys_dev
->
kobj
, &
mc_©Œ_group
);

442 
	`´_debug
("miüocode: CPU%d„emoved\n", 
ıu
);

444 
CPU_DEAD
:

445 
CPU_UP_CANCELED_FROZEN
:

447 
	`miüocode_fši_ıu
(
ıu
);

450  
NOTIFY_OK
;

451 
	}
}

453 
nÙif›r_block
 
__»fd©a
 
	gmc_ıu_nÙif›r
 = {

454 .
nÙif›r_ÿÎ
 = 
mc_ıu_ÿÎback
,

457 
__š™
 
	$miüocode_š™
()

459 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(0);

460 
”rÜ
;

462 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

463 
miüocode_İs
 = 
	`š™_š‹l_miüocode
();

464 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
)

465 
miüocode_İs
 = 
	`š™_amd_miüocode
();

467 ià(!
miüocode_İs
) {

468 
	`´štk
(
KERN_ERR
 "microcode:‚o support forhis CPU vendor\n");

469  -
ENODEV
;

472 
”rÜ
 = 
	`miüocode_dev_š™
();

473 ià(
”rÜ
)

474  
”rÜ
;

475 
miüocode_pdev
 = 
	`¶©fÜm_deviû_»gi¡”_sim¶e
("microcode", -1,

476 
NULL
, 0);

477 ià(
	`IS_ERR
(
miüocode_pdev
)) {

478 
	`miüocode_dev_ex™
();

479  
	`PTR_ERR
(
miüocode_pdev
);

482 
	`g‘_Úlše_ıus
();

483 
”rÜ
 = 
	`sysdev_driv”_»gi¡”
(&
ıu_sysdev_şass
, &
mc_sysdev_driv”
);

484 
	`put_Úlše_ıus
();

485 ià(
”rÜ
) {

486 
	`miüocode_dev_ex™
();

487 
	`¶©fÜm_deviû_uÄegi¡”
(
miüocode_pdev
);

488  
”rÜ
;

491 
	`»gi¡”_hÙıu_nÙif›r
(&
mc_ıu_nÙif›r
);

493 
	`´štk
(
KERN_INFO


494 "MiüocodUpd©Driv”: v" 
MICROCODE_VERSION


499 
	}
}

501 
__ex™
 
	$miüocode_ex™
()

503 
	`miüocode_dev_ex™
();

505 
	`uÄegi¡”_hÙıu_nÙif›r
(&
mc_ıu_nÙif›r
);

507 
	`g‘_Úlše_ıus
();

508 
	`sysdev_driv”_uÄegi¡”
(&
ıu_sysdev_şass
, &
mc_sysdev_driv”
);

509 
	`put_Úlše_ıus
();

511 
	`¶©fÜm_deviû_uÄegi¡”
(
miüocode_pdev
);

513 
miüocode_İs
 = 
NULL
;

515 
	`´štk
(
KERN_INFO


516 "MiüocodUpd©Driv”: v" 
MICROCODE_VERSION
 "„emoved.\n");

517 
	}
}

519 
moduË_š™
(
miüocode_š™
);

520 
moduË_ex™
(
miüocode_ex™
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

73 
	~<lšux/¶©fÜm_deviû.h
>

74 
	~<lšux/ÿ·b™y.h
>

75 
	~<lšux/miscdeviû.h
>

76 
	~<lšux/fœmw¬e.h
>

77 
	~<lšux/smp_lock.h
>

78 
	~<lšux/¥šlock.h
>

79 
	~<lšux/ıumask.h
>

80 
	~<lšux/uacûss.h
>

81 
	~<lšux/vm®loc.h
>

82 
	~<lšux/k”Ãl.h
>

83 
	~<lšux/moduË.h
>

84 
	~<lšux/mu‹x.h
>

85 
	~<lšux/sched.h
>

86 
	~<lšux/š™.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/ıu.h
>

89 
	~<lšux/fs.h
>

90 
	~<lšux/mm.h
>

92 
	~<asm/miüocode.h
>

93 
	~<asm/´oûssÜ.h
>

94 
	~<asm/m¤.h
>

96 
MODULE_DESCRIPTION
("Microcode Update Driver");

97 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

98 
MODULE_LICENSE
("GPL");

100 
	smiüocode_h—d”_š‹l
 {

101 
	mhdrv”
;

102 
	m»v
;

103 
	md©e
;

104 
	msig
;

105 
	mcksum
;

106 
	mldrv”
;

107 
	mpf
;

108 
	md©asize
;

109 
	mtÙ®size
;

110 
	m»£rved
[3];

113 
	smiüocode_š‹l
 {

114 
miüocode_h—d”_š‹l
 
	mhdr
;

115 
	mb™s
[0];

119 
	sex‹nded_sigÇtu»
 {

120 
	msig
;

121 
	mpf
;

122 
	mcksum
;

125 
	sex‹nded_sigbË
 {

126 
	mcouÁ
;

127 
	mcksum
;

128 
	m»£rved
[3];

129 
ex‹nded_sigÇtu»
 
	msigs
[0];

132 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

133 
	#MC_HEADER_SIZE
 ((
miüocode_h—d”_š‹l
))

	)

134 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

135 
	#EXT_HEADER_SIZE
 ((
ex‹nded_sigbË
))

	)

136 
	#EXT_SIGNATURE_SIZE
 ((
ex‹nded_sigÇtu»
))

	)

137 
	#DWSIZE
 ((
u32
))

	)

139 
	#g‘_tÙ®size
(
mc
) \

140 (((
miüocode_š‹l
 *)
mc
)->
hdr
.
tÙ®size
 ? \

141 ((
miüocode_š‹l
 *)
mc
)->
hdr
.
tÙ®size
 : \

142 
DEFAULT_UCODE_TOTALSIZE
)

	)

144 
	#g‘_d©asize
(
mc
) \

145 (((
miüocode_š‹l
 *)
mc
)->
hdr
.
d©asize
 ? \

146 ((
miüocode_š‹l
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

148 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

149 (((
s1
è=ğ(
s2
)è&& (((
p1
è& (
p2
)è|| ((Õ1è=ğ0è&& (Õ2è=ğ0))))

	)

151 
	#ex‰abË_size
(
‘
è(Ót)->
couÁ
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

154 
DEFINE_SPINLOCK
(
miüocode_upd©e_lock
);

156 
	$cŞËù_ıu_šfo
(
ıu_num
, 
ıu_sigÇtu»
 *
csig
)

158 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu_num
);

159 
æags
;

160 
v®
[2];

162 
	`mem£t
(
csig
, 0, (*csig));

164 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

165 
	`ıu_has
(
c
, 
X86_FEATURE_IA64
)) {

166 
	`´štk
(
KERN_ERR
 "microcode: CPU%d‚ot‡ capable Intel "

167 "´oûssÜ\n", 
ıu_num
);

171 
csig
->
sig
 = 
	`ıuid_—x
(0x00000001);

173 ià((
c
->
x86_mod–
 >ğ5è|| (c->
x86
 > 6)) {

175 
	`rdm¤
(
MSR_IA32_PLATFORM_ID
, 
v®
[0], val[1]);

176 
csig
->
pf
 = 1 << ((
v®
[1] >> 18) & 7);

180 
	`¥š_lock_œq§ve
(&
miüocode_upd©e_lock
, 
æags
);

182 
	`wrm¤
(
MSR_IA32_UCODE_REV
, 0, 0);

184 
	`sync_cÜe
();

186 
	`rdm¤
(
MSR_IA32_UCODE_REV
, 
v®
[0], 
csig
->
»v
);

187 
	`¥š_uÆock_œq»¡Üe
(&
miüocode_upd©e_lock
, 
æags
);

189 
	`´_debug
("microcode: collect_cpu_info : sig=0x%x,…f=0x%x,„ev=0x%x\n",

190 
csig
->
sig
, csig->
pf
, csig->
»v
);

193 
	}
}

195 
šlše
 
	$upd©e_m©ch_ıu
(
ıu_sigÇtu»
 *
csig
, 
sig
, 
pf
)

197  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

198 
	}
}

200 
šlše
 

201 
	$upd©e_m©ch_»visiÚ
(
miüocode_h—d”_š‹l
 *
mc_h—d”
, 
»v
)

203  (
mc_h—d”
->
»v
 <=„ev) ? 0 : 1;

204 
	}
}

206 
	$miüocode_§n™y_check
(*
mc
)

208 
tÙ®_size
, 
d©a_size
, 
ext_bË_size
;

209 
miüocode_h—d”_š‹l
 *
mc_h—d”
 = 
mc
;

210 
ex‹nded_sigbË
 *
ext_h—d”
 = 
NULL
;

211 
sum
, 
Üig_sum
, 
ext_sigcouÁ
 = 0, 
i
;

212 
ex‹nded_sigÇtu»
 *
ext_sig
;

214 
tÙ®_size
 = 
	`g‘_tÙ®size
(
mc_h—d”
);

215 
d©a_size
 = 
	`g‘_d©asize
(
mc_h—d”
);

217 ià(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tÙ®_size
) {

218 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

220  -
EINVAL
;

223 ià(
mc_h—d”
->
ldrv”
 !ğ1 || mc_h—d”->
hdrv”
 != 1) {

224 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

226  -
EINVAL
;

228 
ext_bË_size
 = 
tÙ®_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

229 ià(
ext_bË_size
) {

230 ià((
ext_bË_size
 < 
EXT_HEADER_SIZE
)

231 || ((
ext_bË_size
 - 
EXT_HEADER_SIZE
è% 
EXT_SIGNATURE_SIZE
)) {

232 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

234  -
EINVAL
;

236 
ext_h—d”
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

237 ià(
ext_bË_size
 !ğ
	`ex‰abË_size
(
ext_h—d”
)) {

238 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

240  -
EFAULT
;

242 
ext_sigcouÁ
 = 
ext_h—d”
->
couÁ
;

246 ià(
ext_bË_size
) {

247 
ext_bË_sum
 = 0;

248 *
ext_bËp
 = (*)
ext_h—d”
;

250 
i
 = 
ext_bË_size
 / 
DWSIZE
;

251 
i
--)

252 
ext_bË_sum
 +ğ
ext_bËp
[
i
];

253 ià(
ext_bË_sum
) {

254 
	`´štk
(
KERN_WARNING
 "microcode:‡borting, "

256  -
EINVAL
;

261 
Üig_sum
 = 0;

262 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
è/ 
DWSIZE
;

263 
i
--)

264 
Üig_sum
 +ğ((*)
mc
)[
i
];

265 ià(
Üig_sum
) {

266 
	`´štk
(
KERN_ERR
 "microcode:‡borting, bad checksum\n");

267  -
EINVAL
;

269 ià(!
ext_bË_size
)

272 
i
 = 0; i < 
ext_sigcouÁ
; i++) {

273 
ext_sig
 = (*)
ext_h—d”
 + 
EXT_HEADER_SIZE
 +

274 
EXT_SIGNATURE_SIZE
 * 
i
;

275 
sum
 = 
Üig_sum


276 - (
mc_h—d”
->
sig
 + mc_h—d”->
pf
 + mc_h—d”->
cksum
)

277 + (
ext_sig
->
sig
 +ƒxt_sig->
pf
 +ƒxt_sig->
cksum
);

278 ià(
sum
) {

279 
	`´štk
(
KERN_ERR
 "microcode:‡borting, bad checksum\n");

280  -
EINVAL
;

284 
	}
}

291 
	$g‘_m©chšg_miüocode
(
ıu_sigÇtu»
 *
ıu_sig
, *
mc
, 
»v
)

293 
miüocode_h—d”_š‹l
 *
mc_h—d”
 = 
mc
;

294 
ex‹nded_sigbË
 *
ext_h—d”
;

295 
tÙ®_size
 = 
	`g‘_tÙ®size
(
mc_h—d”
);

296 
ext_sigcouÁ
, 
i
;

297 
ex‹nded_sigÇtu»
 *
ext_sig
;

299 ià(!
	`upd©e_m©ch_»visiÚ
(
mc_h—d”
, 
»v
))

302 ià(
	`upd©e_m©ch_ıu
(
ıu_sig
, 
mc_h—d”
->
sig
, mc_h—d”->
pf
))

306 ià(
tÙ®_size
 <ğ
	`g‘_d©asize
(
mc_h—d”
è+ 
MC_HEADER_SIZE
)

309 
ext_h—d”
 = 
mc
 + 
	`g‘_d©asize
(
mc_h—d”
è+ 
MC_HEADER_SIZE
;

310 
ext_sigcouÁ
 = 
ext_h—d”
->
couÁ
;

311 
ext_sig
 = (*)
ext_h—d”
 + 
EXT_HEADER_SIZE
;

313 
i
 = 0; i < 
ext_sigcouÁ
; i++) {

314 ià(
	`upd©e_m©ch_ıu
(
ıu_sig
, 
ext_sig
->
sig
,ƒxt_sig->
pf
))

316 
ext_sig
++;

319 
	}
}

321 
	$­¶y_miüocode
(
ıu
)

323 
miüocode_š‹l
 *
mc_š‹l
;

324 
ucode_ıu_šfo
 *
uci
;

325 
æags
;

326 
v®
[2];

327 
ıu_num
;

329 
ıu_num
 = 
	`¿w_smp_´oûssÜ_id
();

330 
uci
 = 
ucode_ıu_šfo
 + 
ıu
;

331 
mc_š‹l
 = 
uci
->
mc
;

334 
	`BUG_ON
(
ıu_num
 !ğ
ıu
);

336 ià(
mc_š‹l
 =ğ
NULL
)

340 
	`¥š_lock_œq§ve
(&
miüocode_upd©e_lock
, 
æags
);

343 
	`wrm¤
(
MSR_IA32_UCODE_WRITE
,

344 (è
mc_š‹l
->
b™s
,

345 (è
mc_š‹l
->
b™s
 >> 16 >> 16);

346 
	`wrm¤
(
MSR_IA32_UCODE_REV
, 0, 0);

349 
	`sync_cÜe
();

352 
	`rdm¤
(
MSR_IA32_UCODE_REV
, 
v®
[0], val[1]);

354 
	`¥š_uÆock_œq»¡Üe
(&
miüocode_upd©e_lock
, 
æags
);

355 ià(
v®
[1] !ğ
mc_š‹l
->
hdr
.
»v
) {

356 
	`´štk
(
KERN_ERR
 "microcode: CPU%d update from„evision "

358 
ıu_num
, 
uci
->
ıu_sig
.
»v
, 
v®
[1]);

361 
	`´štk
(
KERN_INFO
 "microcode: CPU%d updated from„evision "

363 
ıu_num
, 
uci
->
ıu_sig
.
»v
, 
v®
[1],

364 
mc_š‹l
->
hdr
.
d©e
 & 0xffff,

365 
mc_š‹l
->
hdr
.
d©e
 >> 24,

366 (
mc_š‹l
->
hdr
.
d©e
 >> 16) & 0xff);

368 
uci
->
ıu_sig
.
»v
 = 
v®
[1];

369 
	}
}

371 
g’”ic_lßd_miüocode
(
ıu
, *
d©a
, 
size_t
 
size
,

372 (*
g‘_ucode_d©a
)(*, cÚ¡ *, 
size_t
))

374 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

375 
u8
 *
ucode_±r
 = 
d©a
, *
Ãw_mc
 = 
NULL
, *
mc
;

376 
Ãw_»v
 = 
uci
->
ıu_sig
.
»v
;

377 
Ëáov”
 = 
size
;

379 
Ëáov”
) {

380 
miüocode_h—d”_š‹l
 
mc_h—d”
;

381 
mc_size
;

383 ià(
	`g‘_ucode_d©a
(&
mc_h—d”
, 
ucode_±r
, (mc_header)))

386 
mc_size
 = 
	`g‘_tÙ®size
(&
mc_h—d”
);

387 ià(!
mc_size
 || mc_siz> 
Ëáov”
) {

388 
	`´štk
(
KERN_ERR
 "microcode:ƒrror!"

393 
mc
 = 
	`vm®loc
(
mc_size
);

394 ià(!
mc
)

397 ià(
	`g‘_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

398 
	`miüocode_§n™y_check
(
mc
) < 0) {

399 
	`vä“
(
mc
);

403 ià(
	`g‘_m©chšg_miüocode
(&
uci
->
ıu_sig
, 
mc
, 
Ãw_»v
)) {

404 ià(
Ãw_mc
)

405 
	`vä“
(
Ãw_mc
);

406 
Ãw_»v
 = 
mc_h—d”
.
»v
;

407 
Ãw_mc
 = 
mc
;

409 
	`vä“
(
mc
);

411 
ucode_±r
 +ğ
mc_size
;

412 
Ëáov”
 -ğ
mc_size
;

415 ià(!
Ãw_mc
)

416 
out
;

418 ià(
Ëáov”
) {

419 
	`vä“
(
Ãw_mc
);

420 
out
;

423 ià(
uci
->
mc
)

424 
	`vä“
(
uci
->
mc
);

425 
uci
->
mc
 = (
miüocode_š‹l
 *)
Ãw_mc
;

427 
	`´_debug
("microcode: CPU%d found‡ matching microcode update with"

429 
ıu
, 
Ãw_»v
, 
uci
->
ıu_sig
.
»v
);

431 
out
:

432  ()
Ëáov”
;

433 
	}
}

435 
	$g‘_ucode_fw
(*
to
, cÚ¡ *
äom
, 
size_t
 
n
)

437 
	`memıy
(
to
, 
äom
, 
n
);

439 
	}
}

441 
	$»que¡_miüocode_fw
(
ıu
, 
deviû
 *device)

443 
Çme
[30];

444 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

445 cÚ¡ 
fœmw¬e
 *firmware;

446 
»t
;

449 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

450 
	`¥rštf
(
Çme
, "intel-ucode/%02x-%02x-%02x",

451 
c
->
x86
, c->
x86_mod–
, c->
x86_mask
);

452 
»t
 = 
	`»que¡_fœmw¬e
(&
fœmw¬e
, 
Çme
, 
deviû
);

453 ià(
»t
) {

454 
	`´_debug
("miüocode: d©¨f% lßd faed\n", 
Çme
);

455  
»t
;

458 
»t
 = 
	`g’”ic_lßd_miüocode
(
ıu
, (*)
fœmw¬e
->
d©a
,

459 
fœmw¬e
->
size
, &
g‘_ucode_fw
);

461 
	`»Ëa£_fœmw¬e
(
fœmw¬e
);

463  
»t
;

464 
	}
}

466 
	$g‘_ucode_u£r
(*
to
, cÚ¡ *
äom
, 
size_t
 
n
)

468  
	`cİy_äom_u£r
(
to
, 
äom
, 
n
);

469 
	}
}

471 
	$»que¡_miüocode_u£r
(
ıu
, cÚ¡ 
__u£r
 *
buf
, 
size_t
 
size
)

474 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

476  
	`g’”ic_lßd_miüocode
(
ıu
, (*)
buf
, 
size
, &
g‘_ucode_u£r
);

477 
	}
}

479 
	$miüocode_fši_ıu
(
ıu
)

481 
ucode_ıu_šfo
 *
uci
 = ucode_ıu_šfØ+ 
ıu
;

483 
	`vä“
(
uci
->
mc
);

484 
uci
->
mc
 = 
NULL
;

485 
	}
}

487 
miüocode_İs
 
	gmiüocode_š‹l_İs
 = {

488 .
»que¡_miüocode_u£r
 =„equest_microcode_user,

489 .
	g»que¡_miüocode_fw
 = 
»que¡_miüocode_fw
,

490 .
	gcŞËù_ıu_šfo
 = 
cŞËù_ıu_šfo
,

491 .
	g­¶y_miüocode
 = 
­¶y_miüocode
,

492 .
	gmiüocode_fši_ıu
 = 
miüocode_fši_ıu
,

495 
miüocode_İs
 * 
__š™
 
	$š™_š‹l_miüocode
()

497  &
miüocode_š‹l_İs
;

498 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/pci.h
>

9 
	~<lšux/dmi.h
>

10 
	~<asm/pci-dœeù.h
>

11 
	~<lšux/sÜt.h
>

12 
	~<asm/io.h
>

13 
	~<asm/m¤.h
>

14 
	~<asm/aıi.h
>

15 
	~<asm/mmcÚfig.h
>

16 
	~<asm/pci_x86.h
>

18 
	spci_ho¡bridge_´obe
 {

19 
u32
 
	mbus
;

20 
u32
 
	m¦Ù
;

21 
u32
 
	mv’dÜ
;

22 
u32
 
	mdeviû
;

25 
u64
 
__ıuš™d©a
 
	gçm10h_pci_mmcÚf_ba£
;

26 
__ıuš™d©a
 
	gçm10h_pci_mmcÚf_ba£_¡©us
;

28 
pci_ho¡bridge_´obe
 
	gpci_´obes
[] 
	g__ıuš™d©a
 = {

29 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

30 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

33 
	s¿nge
 {

34 
u64
 
	m¡¬t
;

35 
u64
 
	m’d
;

38 
__ıuš™
 
	$cmp_¿nge
(cÚ¡ *
x1
, cÚ¡ *
x2
)

40 cÚ¡ 
¿nge
 *
r1
 = 
x1
;

41 cÚ¡ 
¿nge
 *
r2
 = 
x2
;

42 
¡¬t1
, 
¡¬t2
;

44 
¡¬t1
 = 
r1
->
¡¬t
 >> 32;

45 
¡¬t2
 = 
r2
->
¡¬t
 >> 32;

47  
¡¬t1
 - 
¡¬t2
;

48 
	}
}

52 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

53 
	#BASE_VALID
(
b
è((b !ğ(0xfdULL << 32)è&& (b !ğ(0xãULL << 32)))

	)

54 
__ıuš™
 
	$g‘_çm10h_pci_mmcÚf_ba£
()

56 
i
;

57 
bus
;

58 
¦Ù
;

59 
found
;

61 
u64
 
v®
;

62 
u32
 
add»ss
;

63 
u64
 
tom2
;

64 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

66 
hi_mmio_num
;

67 
¿nge
„ange[8];

71 ià(
çm10h_pci_mmcÚf_ba£_¡©us
)

74 ià(!
	`—¾y_pci_®lowed
())

75 
ç
;

77 
found
 = 0;

78 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_´obes
); i++) {

79 
u32
 
id
;

80 
u16
 
deviû
;

81 
u16
 
v’dÜ
;

83 
bus
 = 
pci_´obes
[
i
].bus;

84 
¦Ù
 = 
pci_´obes
[
i
].slot;

85 
id
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 0, 
PCI_VENDOR_ID
);

87 
v’dÜ
 = 
id
 & 0xffff;

88 
deviû
 = (
id
>>16) & 0xffff;

89 ià(
pci_´obes
[
i
].
v’dÜ
 == vendor &&

90 
pci_´obes
[
i
].
deviû
 == device) {

91 
found
 = 1;

96 ià(!
found
)

97 
ç
;

100 
add»ss
 = 
MSR_K8_SYSCFG
;

101 
	`rdm¤l
(
add»ss
, 
v®
);

104 ià(!(
v®
 & (1<<21))) {

105 
tom2
 = 0;

108 
add»ss
 = 
MSR_K8_TOP_MEM2
;

109 
	`rdm¤l
(
add»ss
, 
v®
);

110 
tom2
 = 
v®
 & (0xffffULL<<32);

113 ià(
ba£
 <ğ
tom2
)

114 
ba£
 = 
tom2
 + (1ULL<<32);

120 
hi_mmio_num
 = 0;

121 
i
 = 0; i < 8; i++) {

122 
u32
 
»g
;

123 
u64
 
¡¬t
;

124 
u64
 
’d
;

125 
»g
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 1, 0x80 + (
i
 << 3));

126 ià(!(
»g
 & 3))

129 
¡¬t
 = (((
u64
)
»g
) << 8) & (0xffULL << 32);

130 
»g
 = 
	`»ad_pci_cÚfig
(
bus
, 
¦Ù
, 1, 0x84 + (
i
 << 3));

131 
’d
 = (((
u64
)
»g
) << 8) & (0xffULL << 32);

133 ià(!
’d
)

136 
¿nge
[
hi_mmio_num
].
¡¬t
 = start;

137 
¿nge
[
hi_mmio_num
].
’d
 =ƒnd;

138 
hi_mmio_num
++;

141 ià(!
hi_mmio_num
)

142 
out
;

145 
	`sÜt
(
¿nge
, 
hi_mmio_num
, (¿nge), 
cmp_¿nge
, 
NULL
);

147 ià(
¿nge
[
hi_mmio_num
 - 1].
’d
 < 
ba£
)

148 
out
;

149 ià(
¿nge
[0].
¡¬t
 > 
ba£
)

150 
out
;

153 
ba£
 = 
¿nge
[0].
¡¬t
 - (1ULL << 32);

154 ià((
ba£
 > 
tom2
è&& 
	`BASE_VALID
(base))

155 
out
;

156 
ba£
 = 
¿nge
[
hi_mmio_num
 - 1].
’d
 + (1ULL << 32);

157 ià((
ba£
 > 
tom2
è&& 
	`BASE_VALID
(base))

158 
out
;

160 ià(
hi_mmio_num
 > 1)

161 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

162 ià(
¿nge
[
i
 + 1].
¡¬t
 > (¿nge[i].
’d
 + (1ULL << 32))) {

163 
ba£
 = 
¿nge
[
i
].
’d
 + (1ULL << 32);

164 ià((
ba£
 > 
tom2
è&& 
	`BASE_VALID
(base))

165 
out
;

169 
ç
:

170 
çm10h_pci_mmcÚf_ba£_¡©us
 = -1;

172 
out
:

173 
çm10h_pci_mmcÚf_ba£
 = 
ba£
;

174 
çm10h_pci_mmcÚf_ba£_¡©us
 = 1;

175 
	}
}

177 
__ıuš™
 
	$çm10h_check_’abË_mmcfg
()

179 
u64
 
v®
;

180 
u32
 
add»ss
;

182 ià(!(
pci_´obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

185 
add»ss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

186 
	`rdm¤l
(
add»ss
, 
v®
);

189 ià(
v®
 & 
FAM10H_MMIO_CONF_ENABLE
) {

190 
bu¢b™s
;

191 
bu¢b™s
 = (
v®
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

192 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

195 ià(!
aıi_pci_di§bËd
 || 
bu¢b™s
 >= 8) {

196 
u64
 
ba£
;

197 
ba£
 = 
v®
 & (0xffffULL << 32);

198 ià(
çm10h_pci_mmcÚf_ba£_¡©us
 <= 0) {

199 
çm10h_pci_mmcÚf_ba£
 = 
ba£
;

200 
çm10h_pci_mmcÚf_ba£_¡©us
 = 1;

202 } ià(
çm10h_pci_mmcÚf_ba£
 =ğ
ba£
)

211 
	`g‘_çm10h_pci_mmcÚf_ba£
();

212 ià(
çm10h_pci_mmcÚf_ba£_¡©us
 <= 0)

215 
	`´štk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

216 
v®
 &ğ~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

217 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

218 
v®
 |ğ
çm10h_pci_mmcÚf_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

219 
FAM10H_MMIO_CONF_ENABLE
;

220 
	`wrm¤l
(
add»ss
, 
v®
);

221 
	}
}

223 
__devš™
 
	$£t_check_’abË_amd_mmcÚf
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

225 
pci_´obe
 |ğ
PCI_CHECK_ENABLE_AMD_MMCONF
;

227 
	}
}

229 cÚ¡ 
dmi_sy¡em_id
 
__ıuš™cÚ¡
 
	gmmcÚf_dmi_bË
[] = {

231 .
ÿÎback
 = 
£t_check_’abË_amd_mmcÚf
,

232 .
	gid’t
 = "Sun Microsystems Machine",

233 .
	gm©ches
 = {

234 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

240 
__ıuš™
 
	$check_’abË_amd_mmcÚf_dmi
()

242 
	`dmi_check_sy¡em
(
mmcÚf_dmi_bË
);

243 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module_64.c

19 
	~<lšux/moduËlßd”.h
>

20 
	~<lšux/–f.h
>

21 
	~<lšux/vm®loc.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/¡ršg.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/mm.h
>

26 
	~<lšux/¦ab.h
>

27 
	~<lšux/bug.h
>

29 
	~<asm/sy¡em.h
>

30 
	~<asm/·ge.h
>

31 
	~<asm/pgbË.h
>

33 
	#DEBUGP
(
fmt
...)

	)

35 #iâdeà
CONFIG_UML


36 
	$moduË_ä“
(
moduË
 *
mod
, *
moduË_»giÚ
)

38 
	`vä“
(
moduË_»giÚ
);

41 
	}
}

43 *
	$moduË_®loc
(
size
)

45 
vm_¡ruù
 *
¬—
;

47 ià(!
size
)

48  
NULL
;

49 
size
 = 
	`PAGE_ALIGN
(size);

50 ià(
size
 > 
MODULES_LEN
)

51  
NULL
;

53 
¬—
 = 
	`__g‘_vm_¬—
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

54 ià(!
¬—
)

55  
NULL
;

57  
	`__vm®loc_¬—
(
¬—
, 
GFP_KERNEL
, 
PAGE_KERNEL_EXEC
);

58 
	}
}

62 
	$moduË_äob_¬ch_£ùiÚs
(
Elf_Ehdr
 *
hdr
,

63 
Elf_Shdr
 *
£chdrs
,

64 *
£c¡ršgs
,

65 
moduË
 *
mod
)

68 
	}
}

70 
	$­¶y_»loÿ‹_add
(
Elf64_Shdr
 *
£chdrs
,

71 cÚ¡ *
¡¹ab
,

72 
symšdex
,

73 
»l£c
,

74 
moduË
 *
me
)

76 
i
;

77 
Elf64_R–a
 *
»l
 = (*)
£chdrs
[
»l£c
].
sh_addr
;

78 
Elf64_Sym
 *
sym
;

79 *
loc
;

80 
u64
 
v®
;

82 
	`DEBUGP
("Aµlyšg„–oÿ‹ seùiÚ %uØ%u\n", 
»l£c
,

83 
£chdrs
[
»l£c
].
sh_šfo
);

84 
i
 = 0; i < 
£chdrs
[
»l£c
].
sh_size
 / (*
»l
); i++) {

86 
loc
 = (*)
£chdrs
[£chdrs[
»l£c
].
sh_šfo
].
sh_addr


87 + 
»l
[
i
].
r_off£t
;

91 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symšdex
].
sh_addr


92 + 
	`ELF64_R_SYM
(
»l
[
i
].
r_šfo
);

94 
	`DEBUGP
("type %d st_value %Lx„_addend %Lx†oc %Lx\n",

95 ()
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
),

96 
sym
->
¡_v®ue
, 
»l
[
i
].
r_add’d
, (
u64
)
loc
);

98 
v®
 = 
sym
->
¡_v®ue
 + 
»l
[
i
].
r_add’d
;

100 
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
)) {

101 
R_X86_64_NONE
:

103 
R_X86_64_64
:

104 *(
u64
 *)
loc
 = 
v®
;

106 
R_X86_64_32
:

107 *(
u32
 *)
loc
 = 
v®
;

108 ià(
v®
 !ğ*(
u32
 *)
loc
)

109 
ov”æow
;

111 
R_X86_64_32S
:

112 *(
s32
 *)
loc
 = 
v®
;

113 ià((
s64
)
v®
 !ğ*(
s32
 *)
loc
)

114 
ov”æow
;

116 
R_X86_64_PC32
:

117 
v®
 -ğ(
u64
)
loc
;

118 *(
u32
 *)
loc
 = 
v®
;

120 ià((
s64
)
v®
 !ğ*(
s32
 *)
loc
)

121 
ov”æow
;

125 
	`´štk
(
KERN_ERR
 "module %s: Unknown„ela„elocation: %llu\n",

126 
me
->
Çme
, 
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
));

127  -
ENOEXEC
;

132 
ov”æow
:

133 
	`´štk
(
KERN_ERR
 "overflow in„elocationype %d val %Lx\n",

134 ()
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
), 
v®
);

135 
	`´štk
(
KERN_ERR
 "`%s'†ikely‚ot compiled with -mcmodel=kernel\n",

136 
me
->
Çme
);

137  -
ENOEXEC
;

138 
	}
}

140 
	$­¶y_»loÿ‹
(
Elf_Shdr
 *
£chdrs
,

141 cÚ¡ *
¡¹ab
,

142 
symšdex
,

143 
»l£c
,

144 
moduË
 *
me
)

146 
	`´štk
(
KERN_ERR
 "non‡dd„elocation‚ot supported\n");

147  -
ENOSYS
;

148 
	}
}

150 
	$moduË_fš®ize
(cÚ¡ 
Elf_Ehdr
 *
hdr
,

151 cÚ¡ 
Elf_Shdr
 *
£chdrs
,

152 
moduË
 *
me
)

154 cÚ¡ 
Elf_Shdr
 *
s
, *
‹xt
 = 
NULL
, *
®t
 = NULL, *
locks
 = NULL,

155 *
·¿
 = 
NULL
;

156 *
£c¡ršgs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh¡ºdx
].
sh_off£t
;

158 
s
 = 
£chdrs
; s < sechdr + 
hdr
->
e_shnum
; s++) {

159 ià(!
	`¡rcmp
(".‹xt", 
£c¡ršgs
 + 
s
->
sh_Çme
))

160 
‹xt
 = 
s
;

161 ià(!
	`¡rcmp
(".®tš¡ruùiÚs", 
£c¡ršgs
 + 
s
->
sh_Çme
))

162 
®t
 = 
s
;

163 ià(!
	`¡rcmp
(".smp_locks", 
£c¡ršgs
 + 
s
->
sh_Çme
))

164 
locks
 = 
s
;

165 ià(!
	`¡rcmp
(".·¿š¡ruùiÚs", 
£c¡ršgs
 + 
s
->
sh_Çme
))

166 
·¿
 = 
s
;

169 ià(
®t
) {

171 *
a£g
 = (*)
®t
->
sh_addr
;

172 
	`­¶y_®‹º©ives
(
a£g
,‡£g + 
®t
->
sh_size
);

174 ià(
locks
 && 
‹xt
) {

175 *
l£g
 = (*)
locks
->
sh_addr
;

176 *
t£g
 = (*)
‹xt
->
sh_addr
;

177 
	`®‹º©ives_smp_moduË_add
(
me
, me->
Çme
,

178 
l£g
,†£g + 
locks
->
sh_size
,

179 
t£g
,£g + 
‹xt
->
sh_size
);

182 ià(
·¿
) {

183 *
p£g
 = (*)
·¿
->
sh_addr
;

184 
	`­¶y_·¿vœt
(
p£g
,…£g + 
·¿
->
sh_size
);

187  
	`moduË_bug_fš®ize
(
hdr
, 
£chdrs
, 
me
);

188 
	}
}

190 
	$moduË_¬ch_ş—nup
(
moduË
 *
mod
)

192 
	`®‹º©ives_smp_moduË_d–
(
mod
);

193 
	`moduË_bug_ş—nup
(
mod
);

194 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<lšux/mm.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/d–ay.h
>

13 
	~<lšux/boÙmem.h
>

14 
	~<lšux/k”Ãl_¡©.h
>

15 
	~<lšux/mc146818¹c.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/aıi.h
>

18 
	~<lšux/moduË.h
>

19 
	~<lšux/smp.h
>

21 
	~<asm/mŒr.h
>

22 
	~<asm/mp¥ec.h
>

23 
	~<asm/pg®loc.h
>

24 
	~<asm/io_­ic.h
>

25 
	~<asm/´Ùo.h
>

26 
	~<asm/bios_ebda.h
>

27 
	~<asm/e820.h
>

28 
	~<asm/ŒampŞše.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/smp.h
>

32 
	~<asm/­ic.h
>

37 
__š™
 
	$mpf_checksum
(*
mp
, 
Ën
)

39 
sum
 = 0;

41 
Ën
--)

42 
sum
 +ğ*
mp
++;

44  
sum
 & 0xFF;

45 
	}
}

47 
__š™
 
	$MP_´oûssÜ_šfo
(
mpc_ıu
 *
m
)

49 
­icid
;

50 *
boÙup_ıu
 = "";

52 ià(!(
m
->
ıuæag
 & 
CPU_ENABLED
)) {

53 
di§bËd_ıus
++;

57 ià(
x86_quœks
->
mpc_­ic_id
)

58 
­icid
 = 
x86_quœks
->
	`mpc_­ic_id
(
m
);

60 
­icid
 = 
m
->apicid;

62 ià(
m
->
ıuæag
 & 
CPU_BOOTPROCESSOR
) {

63 
boÙup_ıu
 = " (Bootup-CPU)";

64 
boÙ_ıu_physiÿl_­icid
 = 
m
->
­icid
;

67 
	`´štk
(
KERN_INFO
 "ProûssÜ #%d%s\n", 
m
->
­icid
, 
boÙup_ıu
);

68 
	`g’”ic_´oûssÜ_šfo
(
­icid
, 
m
->
­icv”
);

69 
	}
}

71 #ifdeà
CONFIG_X86_IO_APIC


72 
__š™
 
	$MP_bus_šfo
(
mpc_bus
 *
m
)

74 
¡r
[7];

75 
	`memıy
(
¡r
, 
m
->
bu¡y³
, 6);

76 
¡r
[6] = 0;

78 ià(
x86_quœks
->
mpc_Ûm_bus_šfo
)

79 
x86_quœks
->
	`mpc_Ûm_bus_šfo
(
m
, 
¡r
);

81 
	`­ic_´štk
(
APIC_VERBOSE
, "Bu #%d i %s\n", 
m
->
busid
, 
¡r
);

83 #ià
MAX_MP_BUSSES
 < 256

84 ià(
m
->
busid
 >ğ
MAX_MP_BUSSES
) {

85 
	`´štk
(
KERN_WARNING
 "MPable busid value (%d) for bustype %s "

87 
m
->
busid
, 
¡r
, 
MAX_MP_BUSSES
 - 1);

92 ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

93 
	`£t_b™
(
m
->
busid
, 
mp_bus_nÙ_pci
);

94 #ià
	`defšed
(
CONFIG_EISA
è|| defšed(
CONFIG_MCA
)

95 
mp_bus_id_to_ty³
[
m
->
busid
] = 
MP_BUS_ISA
;

97 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

98 ià(
x86_quœks
->
mpc_Ûm_pci_bus
)

99 
x86_quœks
->
	`mpc_Ûm_pci_bus
(
m
);

101 
	`ş—r_b™
(
m
->
busid
, 
mp_bus_nÙ_pci
);

102 #ià
	`defšed
(
CONFIG_EISA
è|| defšed(
CONFIG_MCA
)

103 
mp_bus_id_to_ty³
[
m
->
busid
] = 
MP_BUS_PCI
;

104 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

105 
mp_bus_id_to_ty³
[
m
->
busid
] = 
MP_BUS_EISA
;

106 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

107 
mp_bus_id_to_ty³
[
m
->
busid
] = 
MP_BUS_MCA
;

110 
	`´štk
(
KERN_WARNING
 "UnknowÀbu¡y³ % - ignÜšg\n", 
¡r
);

111 
	}
}

113 
	$bad_ißpic
(
add»ss
)

115 ià(
Ä_ißpics
 >ğ
MAX_IO_APICS
) {

116 
	`´štk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)ƒxceeded "

117 "(found %d)\n", 
MAX_IO_APICS
, 
Ä_ißpics
);

118 
	`·nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

120 ià(!
add»ss
) {

121 
	`´štk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APIC‡ddress"

126 
	}
}

128 
__š™
 
	$MP_ißpic_šfo
(
mpc_ißpic
 *
m
)

130 ià(!(
m
->
æags
 & 
MPC_APIC_USABLE
))

133 
	`´štk
(
KERN_INFO
 "I/O APIC #%d Version %d‡t 0x%X.\n",

134 
m
->
­icid
, m->
­icv”
, m->
­iÿddr
);

136 ià(
	`bad_ißpic
(
m
->
­iÿddr
))

139 
mp_ißpics
[
Ä_ißpics
].
­iÿddr
 = 
m
->apicaddr;

140 
mp_ißpics
[
Ä_ißpics
].
­icid
 = 
m
->apicid;

141 
mp_ißpics
[
Ä_ißpics
].
ty³
 = 
m
->type;

142 
mp_ißpics
[
Ä_ißpics
].
­icv”
 = 
m
->apicver;

143 
mp_ißpics
[
Ä_ißpics
].
æags
 = 
m
->flags;

144 
Ä_ißpics
++;

145 
	}
}

147 
	$´št_MP_št¤c_šfo
(
mpc_št¤c
 *
m
)

149 
	`­ic_´štk
(
APIC_VERBOSE
, "Int:ype %d,…ol %d,rig %d, bus %02x,"

151 
m
->
œqty³
, m->
œqæag
 & 3, (m->œqæag >> 2è& 3, m->
¤cbus
,

152 
m
->
¤cbusœq
, m->
d¡­ic
, m->
d¡œq
);

153 
	}
}

155 
__š™
 
	$´št_mp_œq_šfo
(
mpc_št¤c
 *
mp_œq
)

157 
	`­ic_´štk
(
APIC_VERBOSE
, "Int:ype %d,…ol %d,rig %d, bus %02x,"

159 
mp_œq
->
œqty³
, mp_œq->
œqæag
 & 3,

160 (
mp_œq
->
œqæag
 >> 2è& 3, mp_œq->
¤cbus
,

161 
mp_œq
->
¤cbusœq
, mp_œq->
d¡­ic
, mp_œq->
d¡œq
);

162 
	}
}

164 
__š™
 
	$assign_to_mp_œq
(
mpc_št¤c
 *
m
,

165 
mpc_št¤c
 *
mp_œq
)

167 
mp_œq
->
d¡­ic
 = 
m
->dstapic;

168 
mp_œq
->
ty³
 = 
m
->type;

169 
mp_œq
->
œqty³
 = 
m
->irqtype;

170 
mp_œq
->
œqæag
 = 
m
->irqflag;

171 
mp_œq
->
¤cbus
 = 
m
->srcbus;

172 
mp_œq
->
¤cbusœq
 = 
m
->srcbusirq;

173 
mp_œq
->
d¡œq
 = 
m
->dstirq;

174 
	}
}

176 
__š™
 
	$assign_to_mpc_št¤c
(
mpc_št¤c
 *
mp_œq
,

177 
mpc_št¤c
 *
m
)

179 
m
->
d¡­ic
 = 
mp_œq
->dstapic;

180 
m
->
ty³
 = 
mp_œq
->type;

181 
m
->
œqty³
 = 
mp_œq
->irqtype;

182 
m
->
œqæag
 = 
mp_œq
->irqflag;

183 
m
->
¤cbus
 = 
mp_œq
->srcbus;

184 
m
->
¤cbusœq
 = 
mp_œq
->srcbusirq;

185 
m
->
d¡œq
 = 
mp_œq
->dstirq;

186 
	}
}

188 
__š™
 
	$mp_œq_mpc_št¤c_cmp
(
mpc_št¤c
 *
mp_œq
,

189 
mpc_št¤c
 *
m
)

191 ià(
mp_œq
->
d¡­ic
 !ğ
m
->dstapic)

193 ià(
mp_œq
->
ty³
 !ğ
m
->type)

195 ià(
mp_œq
->
œqty³
 !ğ
m
->irqtype)

197 ià(
mp_œq
->
œqæag
 !ğ
m
->irqflag)

199 ià(
mp_œq
->
¤cbus
 !ğ
m
->srcbus)

201 ià(
mp_œq
->
¤cbusœq
 !ğ
m
->srcbusirq)

203 ià(
mp_œq
->
d¡œq
 !ğ
m
->dstirq)

207 
	}
}

209 
__š™
 
	$MP_št¤c_šfo
(
mpc_št¤c
 *
m
)

211 
i
;

213 
	`´št_MP_št¤c_šfo
(
m
);

215 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

216 ià(!
	`mp_œq_mpc_št¤c_cmp
(&
mp_œqs
[
i
], 
m
))

220 
	`assign_to_mp_œq
(
m
, &
mp_œqs
[
mp_œq_’Œ›s
]);

221 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

222 
	`·nic
("Max # of irq sourcesƒxceeded!!\n");

223 
	}
}

225 
šlše
 
__š™
 
	$MP_bus_šfo
(
mpc_bus
 *
m
è{
	}
}

226 
šlše
 
__š™
 
	$MP_ißpic_šfo
(
mpc_ißpic
 *
m
è{
	}
}

227 
šlše
 
__š™
 
	$MP_št¤c_šfo
(
mpc_št¤c
 *
m
è{
	}
}

231 
__š™
 
	$MP_lšt¤c_šfo
(
mpc_lšt¤c
 *
m
)

233 
	`­ic_´štk
(
APIC_VERBOSE
, "Lint:ype %d,…ol %d,rig %d, bus %02x,"

235 
m
->
œqty³
, m->
œqæag
 & 3, (m->œqæag >> 2è& 3, m->
¤cbusid
,

236 
m
->
¤cbusœq
, m->
de¡­ic
, m->
de¡­işšt
);

237 
	}
}

243 
__š™
 
	$smp_check_mpc
(
mpc_bË
 *
mpc
, *
Ûm
, *
¡r
)

246 ià(
	`memcmp
(
mpc
->
sigÇtu»
, 
MPC_SIGNATURE
, 4)) {

247 
	`´štk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

248 
mpc
->
sigÇtu»
[0], mpc->signature[1],

249 
mpc
->
sigÇtu»
[2], mpc->signature[3]);

252 ià(
	`mpf_checksum
((*)
mpc
, mpc->
Ëngth
)) {

253 
	`´štk
(
KERN_ERR
 "MPTABLE: checksumƒrror!\n");

256 ià(
mpc
->
¥ec
 != 0x01 && mpc->spec != 0x04) {

257 
	`´štk
(
KERN_ERR
 "MPTABLE: badable version (%d)!!\n",

258 
mpc
->
¥ec
);

261 ià(!
mpc
->
Ïpic
) {

262 
	`´štk
(
KERN_ERR
 "MPTABLE:‚ull†ocal APIC‡ddress!\n");

265 
	`memıy
(
Ûm
, 
mpc
->oem, 8);

266 
Ûm
[8] = 0;

267 
	`´štk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
Ûm
);

269 
	`memıy
(
¡r
, 
mpc
->
´oduùid
, 12);

270 
¡r
[12] = 0;

272 
	`´štk
(
KERN_INFO
 "MPTABLE: Produù ID: %s\n", 
¡r
);

274 
	`´štk
(
KERN_INFO
 "MPTABLE: APIC‡t: 0x%X\n", 
mpc
->
Ïpic
);

277 
	}
}

279 
	$sk_’Œy
(**
±r
, *
couÁ
, 
size
)

281 *
±r
 +ğ
size
;

282 *
couÁ
 +ğ
size
;

283 
	}
}

285 
__š™
 
	$smp_dump_m±abË
(
mpc_bË
 *
mpc
, *
m±
)

287 
	`´štk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

288 "ty³ %x\n", *
m±
);

289 
	`´št_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

290 1, 
mpc
, mpc->
Ëngth
, 1);

291 
	}
}

293 
__š™
 
	$smp_»ad_mpc
(
mpc_bË
 *
mpc
, 
—¾y
)

295 
¡r
[16];

296 
Ûm
[10];

298 
couÁ
 = (*
mpc
);

299 *
m±
 = ((*)
mpc
è+ 
couÁ
;

301 ià(!
	`smp_check_mpc
(
mpc
, 
Ûm
, 
¡r
))

304 #ifdeà
CONFIG_X86_32


305 
	`g’”ic_mps_Ûm_check
(
mpc
, 
Ûm
, 
¡r
);

308 ià(!
aıi_Ïpic
)

309 
mp_Ïpic_addr
 = 
mpc
->
Ïpic
;

311 ià(
—¾y
)

314 ià(
mpc
->
Ûm±r
 && 
x86_quœks
->
smp_»ad_mpc_Ûm
) {

315 
mpc_ÛmbË
 *
Ûm_bË
 = (*)()
mpc
->
Ûm±r
;

316 
x86_quœks
->
	`smp_»ad_mpc_Ûm
(
Ûm_bË
, 
mpc
->
Ûmsize
);

322 ià(
x86_quœks
->
mpc_»cÜd
)

323 *
x86_quœks
->
mpc_»cÜd
 = 0;

325 
couÁ
 < 
mpc
->
Ëngth
) {

326 *
m±
) {

327 
MP_PROCESSOR
:

329 ià(!
aıi_Ïpic
)

330 
	`MP_´oûssÜ_šfo
((
mpc_ıu
 *)
m±
);

331 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_ıu
));

333 
MP_BUS
:

334 
	`MP_bus_šfo
((
mpc_bus
 *)
m±
);

335 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_bus
));

337 
MP_IOAPIC
:

338 
	`MP_ißpic_šfo
((
mpc_ißpic
 *)
m±
);

339 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_ißpic
));

341 
MP_INTSRC
:

342 
	`MP_št¤c_šfo
((
mpc_št¤c
 *)
m±
);

343 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_št¤c
));

345 
MP_LINTSRC
:

346 
	`MP_lšt¤c_šfo
((
mpc_lšt¤c
 *)
m±
);

347 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_lšt¤c
));

351 
	`smp_dump_m±abË
(
mpc
, 
m±
);

352 
couÁ
 = 
mpc
->
Ëngth
;

355 ià(
x86_quœks
->
mpc_»cÜd
)

356 (*
x86_quœks
->
mpc_»cÜd
)++;

359 #ifdeà
CONFIG_X86_BIGSMP


360 
	`g’”ic_bigsmp_´obe
();

363 ià(
­ic
->
£tup_­ic_routšg
)

364 
­ic
->
	`£tup_­ic_routšg
();

366 ià(!
num_´oûssÜs
)

367 
	`´štk
(
KERN_ERR
 "MPTABLE:‚o…rocessors„egistered!\n");

368  
num_´oûssÜs
;

369 
	}
}

371 #ifdeà
CONFIG_X86_IO_APIC


373 
__š™
 
	$ELCR_Œigg”
(
œq
)

375 
pÜt
;

377 
pÜt
 = 0x4d0 + (
œq
 >> 3);

378  (
	`šb
(
pÜt
è>> (
œq
 & 7)) & 1;

379 
	}
}

381 
__š™
 
	$cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
)

383 
mpc_št¤c
 
št¤c
;

384 
i
;

385 
ELCR_çÎback
 = 0;

387 
št¤c
.
ty³
 = 
MP_INTSRC
;

388 
št¤c
.
œqæag
 = 0;

389 
št¤c
.
¤cbus
 = 0;

390 
št¤c
.
d¡­ic
 = 
mp_ißpics
[0].
­icid
;

392 
št¤c
.
œqty³
 = 
mp_INT
;

402 ià(
mpc_deçuÉ_ty³
 == 5) {

403 
	`´štk
(
KERN_INFO
 "ISA/PCI busype with‚o IRQ information... "

406 ià(
	`ELCR_Œigg”
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

407 
	`ELCR_Œigg”
(13))

408 
	`´štk
(
KERN_ERR
 "ELCR contains invalid data... "

411 
	`´štk
(
KERN_INFO


413 
ELCR_çÎback
 = 1;

417 
i
 = 0; i < 16; i++) {

418 
mpc_deçuÉ_ty³
) {

420 ià(
i
 == 0 || i == 13)

424 ià(
i
 == 2)

428 ià(
ELCR_çÎback
) {

434 ià(
	`ELCR_Œigg”
(
i
))

435 
št¤c
.
œqæag
 = 13;

437 
št¤c
.
œqæag
 = 0;

440 
št¤c
.
¤cbusœq
 = 
i
;

441 
št¤c
.
d¡œq
 = 
i
 ? i : 2;

442 
	`MP_št¤c_šfo
(&
št¤c
);

445 
št¤c
.
œqty³
 = 
mp_ExtINT
;

446 
št¤c
.
¤cbusœq
 = 0;

447 
št¤c
.
d¡œq
 = 0;

448 
	`MP_št¤c_šfo
(&
št¤c
);

449 
	}
}

452 
__š™
 
	$cÚ¡ruù_ißpic_bË
(
mpc_deçuÉ_ty³
)

454 
mpc_ißpic
 
ißpic
;

455 
mpc_bus
 
bus
;

457 
bus
.
ty³
 = 
MP_BUS
;

458 
bus
.
busid
 = 0;

459 
mpc_deçuÉ_ty³
) {

461 
	`´štk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

462 
mpc_deçuÉ_ty³
);

466 
	`memıy
(
bus
.
bu¡y³
, "ISA ", 6);

471 
	`memıy
(
bus
.
bu¡y³
, "EISA ", 6);

475 
	`memıy
(
bus
.
bu¡y³
, "MCA ", 6);

477 
	`MP_bus_šfo
(&
bus
);

478 ià(
mpc_deçuÉ_ty³
 > 4) {

479 
bus
.
busid
 = 1;

480 
	`memıy
(
bus
.
bu¡y³
, "PCI ", 6);

481 
	`MP_bus_šfo
(&
bus
);

484 
ißpic
.
ty³
 = 
MP_IOAPIC
;

485 
ißpic
.
­icid
 = 2;

486 
ißpic
.
­icv”
 = 
mpc_deçuÉ_ty³
 > 4 ? 0x10 : 0x01;

487 
ißpic
.
æags
 = 
MPC_APIC_USABLE
;

488 
ißpic
.
­iÿddr
 = 0xFEC00000;

489 
	`MP_ißpic_šfo
(&
ißpic
);

494 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
);

495 
	}
}

497 
šlše
 
__š™
 
	$cÚ¡ruù_ißpic_bË
(
mpc_deçuÉ_ty³
è{ 
	}
}

500 
šlše
 
__š™
 
	$cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpc_deçuÉ_ty³
)

502 
mpc_ıu
 
´oûssÜ
;

503 
mpc_lšt¤c
 
lšt¤c
;

504 
lš‰y³s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

505 
i
;

510 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

515 
´oûssÜ
.
ty³
 = 
MP_PROCESSOR
;

517 
´oûssÜ
.
­icv”
 = 
mpc_deçuÉ_ty³
 > 4 ? 0x10 : 0x01;

518 
´oûssÜ
.
ıuæag
 = 
CPU_ENABLED
;

519 
´oûssÜ
.
ıuã©u»
 = (
boÙ_ıu_d©a
.
x86
 << 8) |

520 (
boÙ_ıu_d©a
.
x86_mod–
 << 4è| boÙ_ıu_d©a.
x86_mask
;

521 
´oûssÜ
.
ã©u»æag
 = 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[0];

522 
´oûssÜ
.
»£rved
[0] = 0;

523 
´oûssÜ
.
»£rved
[1] = 0;

524 
i
 = 0; i < 2; i++) {

525 
´oûssÜ
.
­icid
 = 
i
;

526 
	`MP_´oûssÜ_šfo
(&
´oûssÜ
);

529 
	`cÚ¡ruù_ißpic_bË
(
mpc_deçuÉ_ty³
);

531 
lšt¤c
.
ty³
 = 
MP_LINTSRC
;

532 
lšt¤c
.
œqæag
 = 0;

533 
lšt¤c
.
¤cbusid
 = 0;

534 
lšt¤c
.
¤cbusœq
 = 0;

535 
lšt¤c
.
de¡­ic
 = 
MP_APIC_ALL
;

536 
i
 = 0; i < 2; i++) {

537 
lšt¤c
.
œqty³
 = 
lš‰y³s
[
i
];

538 
lšt¤c
.
de¡­işšt
 = 
i
;

539 
	`MP_lšt¤c_šfo
(&
lšt¤c
);

541 
	}
}

543 
mpf_š‹l
 *
	gmpf_found
;

545 
__š™
 
	$g‘_mpc_size
(
phy¥Œ
)

547 
mpc_bË
 *
mpc
;

548 
size
;

550 
mpc
 = 
	`—¾y_iÜem­
(
phy¥Œ
, 
PAGE_SIZE
);

551 
size
 = 
mpc
->
Ëngth
;

552 
	`—¾y_iounm­
(
mpc
, 
PAGE_SIZE
);

553 
	`­ic_´štk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy¥Œ
,…hy¥Œ + 
size
);

555  
size
;

556 
	}
}

558 
__š™
 
	$check_phy¥Œ
(
mpf_š‹l
 *
mpf
, 
—¾y
)

560 
mpc_bË
 *
mpc
;

561 
size
;

563 
size
 = 
	`g‘_mpc_size
(
mpf
->
phy¥Œ
);

564 
mpc
 = 
	`—¾y_iÜem­
(
mpf
->
phy¥Œ
, 
size
);

569 ià(!
	`smp_»ad_mpc
(
mpc
, 
—¾y
)) {

570 #ifdeà
CONFIG_X86_LOCAL_APIC


571 
smp_found_cÚfig
 = 0;

573 
	`´štk
(
KERN_ERR
 "BIOS bug, MPableƒrrors detected!...\n"

575 
	`—¾y_iounm­
(
mpc
, 
size
);

578 
	`—¾y_iounm­
(
mpc
, 
size
);

580 ià(
—¾y
)

583 #ifdeà
CONFIG_X86_IO_APIC


589 ià(!
mp_œq_’Œ›s
) {

590 
mpc_bus
 
bus
;

592 
	`´štk
(
KERN_ERR
 "BIOS bug,‚oƒxplicit IRQƒntries, "

595 
bus
.
ty³
 = 
MP_BUS
;

596 
bus
.
busid
 = 0;

597 
	`memıy
(
bus
.
bu¡y³
, "ISA ", 6);

598 
	`MP_bus_šfo
(&
bus
);

600 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(0);

605 
	}
}

610 
__š™
 
	$__g‘_smp_cÚfig
(
—¾y
)

612 
mpf_š‹l
 *
mpf
 = 
mpf_found
;

614 ià(!
mpf
)

617 ià(
aıi_Ïpic
 && 
—¾y
)

624 ià(
aıi_Ïpic
 && 
aıi_ißpic
)

627 ià(
x86_quœks
->
mach_g‘_smp_cÚfig
) {

628 ià(
x86_quœks
->
	`mach_g‘_smp_cÚfig
(
—¾y
))

632 
	`´štk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

633 
mpf
->
¥ecifiÿtiÚ
);

634 #ià
	`defšed
(
CONFIG_X86_LOCAL_APIC
è&& defšed(
CONFIG_X86_32
)

635 ià(
mpf
->
ã©u»2
 & (1 << 7)) {

636 
	`´štk
(
KERN_INFO
 " IMCR‡nd PIC compatibility mode.\n");

637 
pic_mode
 = 1;

639 
	`´štk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

640 
pic_mode
 = 0;

646 ià(
mpf
->
ã©u»1
 != 0) {

647 ià(
—¾y
) {

651 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

655 
	`´štk
(
KERN_INFO
 "Default MP configuration #%d\n",

656 
mpf
->
ã©u»1
);

657 
	`cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpf
->
ã©u»1
);

659 } ià(
mpf
->
phy¥Œ
) {

660 ià(
	`check_phy¥Œ
(
mpf
, 
—¾y
))

663 
	`BUG
();

665 ià(!
—¾y
)

666 
	`´štk
(
KERN_INFO
 "ProûssÜs: %d\n", 
num_´oûssÜs
);

670 
	}
}

672 
__š™
 
	$—¾y_g‘_smp_cÚfig
()

674 
	`__g‘_smp_cÚfig
(1);

675 
	}
}

677 
__š™
 
	$g‘_smp_cÚfig
()

679 
	`__g‘_smp_cÚfig
(0);

680 
	}
}

682 
__š™
 
	$smp_»£rve_boÙmem
(
mpf_š‹l
 *
mpf
)

684 
size
 = 
	`g‘_mpc_size
(
mpf
->
phy¥Œ
);

685 #ifdeà
CONFIG_X86_32


695 
’d
 = 
max_low_pâ
 * 
PAGE_SIZE
;

697 ià(
mpf
->
phy¥Œ
 < 
’d
) {

698 ià(
mpf
->
phy¥Œ
 + 
size
 > 
’d
)

699 
size
 = 
’d
 - 
mpf
->
phy¥Œ
;

700 
	`»£rve_boÙmem_g’”ic
(
mpf
->
phy¥Œ
, 
size
, 
BOOTMEM_DEFAULT
);

703 
	`»£rve_boÙmem_g’”ic
(
mpf
->
phy¥Œ
, 
size
, 
BOOTMEM_DEFAULT
);

705 
	}
}

707 
__š™
 
	$smp_sÿn_cÚfig
(
ba£
, 
Ëngth
,

708 
»£rve
)

710 *
bp
 = 
	`phys_to_vœt
(
ba£
);

711 
mpf_š‹l
 *
mpf
;

713 
	`­ic_´štk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

714 
bp
, 
Ëngth
);

715 
	`BUILD_BUG_ON
((*
mpf
) != 16);

717 
Ëngth
 > 0) {

718 
mpf
 = (
mpf_š‹l
 *)
bp
;

719 ià((*
bp
 =ğ
SMP_MAGIC_IDENT
) &&

720 (
mpf
->
Ëngth
 == 1) &&

721 !
	`mpf_checksum
((*)
bp
, 16) &&

722 ((
mpf
->
¥ecifiÿtiÚ
 == 1)

723 || (
mpf
->
¥ecifiÿtiÚ
 == 4))) {

724 #ifdeà
CONFIG_X86_LOCAL_APIC


725 
smp_found_cÚfig
 = 1;

727 
mpf_found
 = 
mpf
;

729 
	`´štk
(
KERN_INFO
 "found SMP MP-table‡t [%p] %llx\n",

730 
mpf
, (
u64
)
	`vœt_to_phys
(mpf));

732 ià(!
»£rve
)

734 
	`»£rve_boÙmem_g’”ic
(
	`vœt_to_phys
(
mpf
), (*mpf),

735 
BOOTMEM_DEFAULT
);

736 ià(
mpf
->
phy¥Œ
)

737 
	`smp_»£rve_boÙmem
(
mpf
);

741 
bp
 += 4;

742 
Ëngth
 -= 16;

745 
	}
}

747 
__š™
 
	$__fšd_smp_cÚfig
(
»£rve
)

749 
add»ss
;

751 ià(
x86_quœks
->
mach_fšd_smp_cÚfig
) {

752 ià(
x86_quœks
->
	`mach_fšd_smp_cÚfig
(
»£rve
))

763 ià(
	`smp_sÿn_cÚfig
(0x0, 0x400, 
»£rve
) ||

764 
	`smp_sÿn_cÚfig
(639 * 0x400, 0x400, 
»£rve
) ||

765 
	`smp_sÿn_cÚfig
(0xF0000, 0x10000, 
»£rve
))

784 
add»ss
 = 
	`g‘_bios_ebda
();

785 ià(
add»ss
)

786 
	`smp_sÿn_cÚfig
(
add»ss
, 0x400, 
»£rve
);

787 
	}
}

789 
__š™
 
	$—¾y_fšd_smp_cÚfig
()

791 
	`__fšd_smp_cÚfig
(0);

792 
	}
}

794 
__š™
 
	$fšd_smp_cÚfig
()

796 
	`__fšd_smp_cÚfig
(1);

797 
	}
}

799 #ifdeà
CONFIG_X86_IO_APIC


800 
u8
 
__š™d©a
 
	gœq_u£d
[
MAX_IRQ_SOURCES
];

802 
__š™
 
	$g‘_MP_št¤c_šdex
(
mpc_št¤c
 *
m
)

804 
i
;

806 ià(
m
->
œqty³
 !ğ
mp_INT
)

809 ià(
m
->
œqæag
 != 0x0f)

814 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

815 ià(
mp_œqs
[
i
].
œqty³
 !ğ
mp_INT
)

818 ià(
mp_œqs
[
i
].
œqæag
 != 0x0f)

821 ià(
mp_œqs
[
i
].
¤cbus
 !ğ
m
->srcbus)

823 ià(
mp_œqs
[
i
].
¤cbusœq
 !ğ
m
->srcbusirq)

825 ià(
œq_u£d
[
i
]) {

829 
œq_u£d
[
i
] = 1;

830  
i
;

835 
	}
}

837 
	#SPARE_SLOT_NUM
 20

	)

839 
mpc_št¤c
 
__š™d©a
 *
	gm_¥¬e
[
SPARE_SLOT_NUM
];

841 
__š™
 
	$check_œq_¤c
(
mpc_št¤c
 *
m
, *
Ä_m_¥¬e
)

843 
i
;

845 
	`­ic_´štk
(
APIC_VERBOSE
, "OLD ");

846 
	`´št_MP_št¤c_šfo
(
m
);

848 
i
 = 
	`g‘_MP_št¤c_šdex
(
m
);

849 ià(
i
 > 0) {

850 
	`assign_to_mpc_št¤c
(&
mp_œqs
[
i
], 
m
);

851 
	`­ic_´štk
(
APIC_VERBOSE
, "NEW ");

852 
	`´št_mp_œq_šfo
(&
mp_œqs
[
i
]);

855 ià(!
i
) {

859 ià(*
Ä_m_¥¬e
 < 
SPARE_SLOT_NUM
) {

864 
m_¥¬e
[*
Ä_m_¥¬e
] = 
m
;

865 *
Ä_m_¥¬e
 += 1;

867 
	}
}

870 
šlše
 
__š™
 
	$check_œq_¤c
(
mpc_št¤c
 *
m
, *
Ä_m_¥¬e
è{
	}
}

873 
	$check_¦Ù
(
mpc_Ãw_phys
, 
mpc_Ãw_Ëngth
,

874 
couÁ
)

876 ià(!
mpc_Ãw_phys
) {

877 
	`´_šfo
("No spare slots,ryo‡ppend...take your„isk, "

878 "Ãw mpc_Ëngth %x\n", 
couÁ
);

880 ià(
couÁ
 <ğ
mpc_Ãw_Ëngth
)

881 
	`´_šfo
("No spare slots,ryo‡ppend..., "

882 "Ãw mpc_Ëngth %x\n", 
couÁ
);

884 
	`´_”r
("mpc_new_length %lx isoo small\n",

885 
mpc_Ãw_Ëngth
);

891 
	}
}

893 
__š™
 
	$»¶aû_št¤c_®l
(
mpc_bË
 *
mpc
,

894 
mpc_Ãw_phys
,

895 
mpc_Ãw_Ëngth
)

897 #ifdeà
CONFIG_X86_IO_APIC


898 
i
;

900 
couÁ
 = (*
mpc
);

901 
Ä_m_¥¬e
 = 0;

902 *
m±
 = ((*)
mpc
è+ 
couÁ
;

904 
	`´štk
(
KERN_INFO
 "mpc_Ëngth %x\n", 
mpc
->
Ëngth
);

905 
couÁ
 < 
mpc
->
Ëngth
) {

906 *
m±
) {

907 
MP_PROCESSOR
:

908 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_ıu
));

910 
MP_BUS
:

911 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_bus
));

913 
MP_IOAPIC
:

914 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_ißpic
));

916 
MP_INTSRC
:

917 
	`check_œq_¤c
((
mpc_št¤c
 *)
m±
, &
Ä_m_¥¬e
);

918 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_št¤c
));

920 
MP_LINTSRC
:

921 
	`sk_’Œy
(&
m±
, &
couÁ
, (
mpc_lšt¤c
));

925 
	`smp_dump_m±abË
(
mpc
, 
m±
);

926 
out
;

930 #ifdeà
CONFIG_X86_IO_APIC


931 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

932 ià(
œq_u£d
[
i
])

935 ià(
mp_œqs
[
i
].
œqty³
 !ğ
mp_INT
)

938 ià(
mp_œqs
[
i
].
œqæag
 != 0x0f)

941 ià(
Ä_m_¥¬e
 > 0) {

942 
	`­ic_´štk
(
APIC_VERBOSE
, "*NEW* found\n");

943 
Ä_m_¥¬e
--;

944 
	`assign_to_mpc_št¤c
(&
mp_œqs
[
i
], 
m_¥¬e
[
Ä_m_¥¬e
]);

945 
m_¥¬e
[
Ä_m_¥¬e
] = 
NULL
;

947 
mpc_št¤c
 *
m
 = (mpc_št¤ø*)
m±
;

948 
couÁ
 +ğ(
mpc_št¤c
);

949 ià(!
	`check_¦Ù
(
mpc_Ãw_phys
, 
mpc_Ãw_Ëngth
, 
couÁ
))

950 
out
;

951 
	`assign_to_mpc_št¤c
(&
mp_œqs
[
i
], 
m
);

952 
mpc
->
Ëngth
 = 
couÁ
;

953 
m±
 +ğ(
mpc_št¤c
);

955 
	`´št_mp_œq_šfo
(&
mp_œqs
[
i
]);

958 
out
:

960 
mpc
->
checksum
 = 0;

961 
mpc
->
checksum
 -ğ
	`mpf_checksum
((*)mpc, mpc->
Ëngth
);

964 
	}
}

966 
__š™d©a
 
	g’abË_upd©e_m±abË
;

968 
__š™
 
	$upd©e_m±abË_£tup
(*
¡r
)

970 
’abË_upd©e_m±abË
 = 1;

972 
	}
}

973 
—¾y_·¿m
("upd©e_m±abË", 
upd©e_m±abË_£tup
);

975 
__š™d©a
 
	gmpc_Ãw_phys
;

976 
mpc_Ãw_Ëngth
 
	g__š™d©a
 = 4096;

979 
__š™d©a
 
	g®loc_m±abË
;

980 
__š™
 
	$·r£_®loc_m±abË_İt
(*
p
)

982 
’abË_upd©e_m±abË
 = 1;

983 
®loc_m±abË
 = 1;

984 ià(!
p
)

986 
mpc_Ãw_Ëngth
 = 
	`mem·r£
(
p
, &p);

988 
	}
}

989 
—¾y_·¿m
("®loc_m±abË", 
·r£_®loc_m±abË_İt
);

991 
__š™
 
	$—¾y_»£rve_e820_mpc_Ãw
()

993 ià(
’abË_upd©e_m±abË
 && 
®loc_m±abË
) {

994 
u64
 
¡¬‰
 = 0;

995 #ifdeà
CONFIG_X86_TRAMPOLINE


996 
¡¬‰
 = 
TRAMPOLINE_BASE
;

998 
mpc_Ãw_phys
 = 
	`—¾y_»£rve_e820
(
¡¬‰
, 
mpc_Ãw_Ëngth
, 4);

1000 
	}
}

1002 
__š™
 
	$upd©e_mp_bË
()

1004 
¡r
[16];

1005 
Ûm
[10];

1006 
mpf_š‹l
 *
mpf
;

1007 
mpc_bË
 *
mpc
, *
mpc_Ãw
;

1009 ià(!
’abË_upd©e_m±abË
)

1012 
mpf
 = 
mpf_found
;

1013 ià(!
mpf
)

1019 ià(
mpf
->
ã©u»1
 != 0)

1022 ià(!
mpf
->
phy¥Œ
)

1025 
mpc
 = 
	`phys_to_vœt
(
mpf
->
phy¥Œ
);

1027 ià(!
	`smp_check_mpc
(
mpc
, 
Ûm
, 
¡r
))

1030 
	`´štk
(
KERN_INFO
 "mpf: %Îx\n", (
u64
)
	`vœt_to_phys
(
mpf
));

1031 
	`´štk
(
KERN_INFO
 "phy¥Œ: %x\n", 
mpf
->
phy¥Œ
);

1033 ià(
mpc_Ãw_phys
 && 
mpc
->
Ëngth
 > 
mpc_Ãw_Ëngth
) {

1034 
mpc_Ãw_phys
 = 0;

1035 
	`´štk
(
KERN_INFO
 "mpc_new_length is %ld,…lease use‡lloc_mptable=8k\n",

1036 
mpc_Ãw_Ëngth
);

1039 ià(!
mpc_Ãw_phys
) {

1040 
Şd
, 
Ãw
;

1042 
mpc
->
checksum
 = 0;

1043 
Şd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Ëngth
);

1044 
mpc
->
checksum
 = 0xff;

1045 
Ãw
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Ëngth
);

1046 ià(
Şd
 =ğ
Ãw
) {

1047 
	`´štk
(
KERN_INFO
 "mpc is„eadonly,…leasery‡lloc_mptable instead\n");

1050 
	`´štk
(
KERN_INFO
 "use in-positon„eplacing\n");

1052 
mpf
->
phy¥Œ
 = 
mpc_Ãw_phys
;

1053 
mpc_Ãw
 = 
	`phys_to_vœt
(
mpc_Ãw_phys
);

1054 
	`memıy
(
mpc_Ãw
, 
mpc
, mpc->
Ëngth
);

1055 
mpc
 = 
mpc_Ãw
;

1057 ià(
mpc_Ãw_phys
 - 
mpf
->
phy¥Œ
) {

1058 
mpf_š‹l
 *
mpf_Ãw
;

1060 
	`´štk
(
KERN_INFO
 "mpf‚ew: %x\n", 0x400 - 16);

1061 
mpf_Ãw
 = 
	`phys_to_vœt
(0x400 - 16);

1062 
	`memıy
(
mpf_Ãw
, 
mpf
, 16);

1063 
mpf
 = 
mpf_Ãw
;

1064 
mpf
->
phy¥Œ
 = 
mpc_Ãw_phys
;

1066 
mpf
->
checksum
 = 0;

1067 
mpf
->
checksum
 -ğ
	`mpf_checksum
((*)mpf, 16);

1068 
	`´štk
(
KERN_INFO
 "phy¥Œ‚ew: %x\n", 
mpf
->
phy¥Œ
);

1077 
	`»¶aû_št¤c_®l
(
mpc
, 
mpc_Ãw_phys
, 
mpc_Ãw_Ëngth
);

1080 
	}
}

1082 
Ï‹_š™ÿÎ
(
upd©e_mp_bË
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

24 
	~<lšux/moduË.h
>

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/”ºo.h
>

28 
	~<lšux/fú.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/pŞl.h
>

31 
	~<lšux/smp.h
>

32 
	~<lšux/smp_lock.h
>

33 
	~<lšux/majÜ.h
>

34 
	~<lšux/fs.h
>

35 
	~<lšux/deviû.h
>

36 
	~<lšux/ıu.h
>

37 
	~<lšux/nÙif›r.h
>

38 
	~<lšux/uacûss.h
>

40 
	~<asm/´oûssÜ.h
>

41 
	~<asm/m¤.h
>

42 
	~<asm/sy¡em.h
>

44 
şass
 *
	gm¤_şass
;

46 
loff_t
 
	$m¤_£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
Üig
)

48 
loff_t
 
»t
;

49 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

51 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

52 
Üig
) {

54 
fe
->
f_pos
 = 
off£t
;

55 
»t
 = 
fe
->
f_pos
;

58 
fe
->
f_pos
 +ğ
off£t
;

59 
»t
 = 
fe
->
f_pos
;

62 
»t
 = -
EINVAL
;

64 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

65  
»t
;

66 
	}
}

68 
ssize_t
 
	$m¤_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

69 
size_t
 
couÁ
, 
loff_t
 *
µos
)

71 
u32
 
__u£r
 *
tmp
 = (u32 __u£¸*è
buf
;

72 
u32
 
d©a
[2];

73 
u32
 
»g
 = *
µos
;

74 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

75 
”r
 = 0;

76 
ssize_t
 
by‹s
 = 0;

78 ià(
couÁ
 % 8)

79  -
EINVAL
;

81 ; 
couÁ
; count -= 8) {

82 
”r
 = 
	`rdm¤_§ã_Ú_ıu
(
ıu
, 
»g
, &
d©a
[0], &data[1]);

83 ià(
”r
) {

84 ià(
”r
 =ğ-
EFAULT
)

85 
”r
 = -
EIO
;

88 ià(
	`cİy_to_u£r
(
tmp
, &
d©a
, 8)) {

89 
”r
 = -
EFAULT
;

92 
tmp
 += 2;

93 
by‹s
 += 8;

96  
by‹s
 ? by‹ : 
”r
;

97 
	}
}

99 
ssize_t
 
	$m¤_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
,

100 
size_t
 
couÁ
, 
loff_t
 *
µos
)

102 cÚ¡ 
u32
 
__u£r
 *
tmp
 = (cÚ¡ u32 __u£¸*)
buf
;

103 
u32
 
d©a
[2];

104 
u32
 
»g
 = *
µos
;

105 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

106 
”r
 = 0;

107 
ssize_t
 
by‹s
 = 0;

109 ià(
couÁ
 % 8)

110  -
EINVAL
;

112 ; 
couÁ
; count -= 8) {

113 ià(
	`cİy_äom_u£r
(&
d©a
, 
tmp
, 8)) {

114 
”r
 = -
EFAULT
;

117 
”r
 = 
	`wrm¤_§ã_Ú_ıu
(
ıu
, 
»g
, 
d©a
[0], data[1]);

118 ià(
”r
) {

119 ià(
”r
 =ğ-
EFAULT
)

120 
”r
 = -
EIO
;

123 
tmp
 += 2;

124 
by‹s
 += 8;

127  
by‹s
 ? by‹ : 
”r
;

128 
	}
}

130 
	$m¤_İ’
(
šode
 *šode, 
fe
 *file)

132 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

133 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

134 
»t
 = 0;

136 
	`lock_k”Ãl
();

137 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

139 ià(
ıu
 >ğ
Ä_ıu_ids
 || !
	`ıu_Úlše
(cpu)) {

140 
»t
 = -
ENXIO
;

141 
out
;

143 
c
 = &
	`ıu_d©a
(
ıu
);

144 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_MSR
))

145 
»t
 = -
EIO
;

146 
out
:

147 
	`uÆock_k”Ãl
();

148  
»t
;

149 
	}
}

154 cÚ¡ 
fe_İ”©iÚs
 
	gm¤_fİs
 = {

155 .
owÃr
 = 
THIS_MODULE
,

156 .
	gÎ£ek
 = 
m¤_£ek
,

157 .
	g»ad
 = 
m¤_»ad
,

158 .
	gwr™e
 = 
m¤_wr™e
,

159 .
	gİ’
 = 
m¤_İ’
,

162 
__ıuš™
 
	$m¤_deviû_ü—‹
(
ıu
)

164 
deviû
 *
dev
;

166 
dev
 = 
	`deviû_ü—‹
(
m¤_şass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
ıu
), NULL,

167 "m¤%d", 
ıu
);

168  
	`IS_ERR
(
dev
è? 
	`PTR_ERR
(dev) : 0;

169 
	}
}

171 
	$m¤_deviû_de¡roy
(
ıu
)

173 
	`deviû_de¡roy
(
m¤_şass
, 
	`MKDEV
(
MSR_MAJOR
, 
ıu
));

174 
	}
}

176 
__ıuš™
 
	$m¤_şass_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

177 
aùiÚ
, *
hıu
)

179 
ıu
 = ()
hıu
;

180 
”r
 = 0;

182 
aùiÚ
) {

183 
CPU_UP_PREPARE
:

184 
”r
 = 
	`m¤_deviû_ü—‹
(
ıu
);

186 
CPU_UP_CANCELED
:

187 
CPU_UP_CANCELED_FROZEN
:

188 
CPU_DEAD
:

189 
	`m¤_deviû_de¡roy
(
ıu
);

192  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

193 
	}
}

195 
nÙif›r_block
 
__»fd©a
 
	gm¤_şass_ıu_nÙif›r
 = {

196 .
nÙif›r_ÿÎ
 = 
m¤_şass_ıu_ÿÎback
,

199 
__š™
 
	$m¤_š™
()

201 
i
, 
”r
 = 0;

202 
i
 = 0;

204 ià(
	`»gi¡”_chrdev
(
MSR_MAJOR
, "ıu/m¤", &
m¤_fİs
)) {

205 
	`´štk
(
KERN_ERR
 "msr: unableo get major %d for msr\n",

206 
MSR_MAJOR
);

207 
”r
 = -
EBUSY
;

208 
out
;

210 
m¤_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "msr");

211 ià(
	`IS_ERR
(
m¤_şass
)) {

212 
”r
 = 
	`PTR_ERR
(
m¤_şass
);

213 
out_chrdev
;

215 
	`fÜ_—ch_Úlše_ıu
(
i
) {

216 
”r
 = 
	`m¤_deviû_ü—‹
(
i
);

217 ià(
”r
 != 0)

218 
out_şass
;

220 
	`»gi¡”_hÙıu_nÙif›r
(&
m¤_şass_ıu_nÙif›r
);

222 
”r
 = 0;

223 
out
;

225 
out_şass
:

226 
i
 = 0;

227 
	`fÜ_—ch_Úlše_ıu
(
i
)

228 
	`m¤_deviû_de¡roy
(
i
);

229 
	`şass_de¡roy
(
m¤_şass
);

230 
out_chrdev
:

231 
	`uÄegi¡”_chrdev
(
MSR_MAJOR
, "cpu/msr");

232 
out
:

233  
”r
;

234 
	}
}

236 
__ex™
 
	$m¤_ex™
()

238 
ıu
 = 0;

239 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

240 
	`m¤_deviû_de¡roy
(
ıu
);

241 
	`şass_de¡roy
(
m¤_şass
);

242 
	`uÄegi¡”_chrdev
(
MSR_MAJOR
, "cpu/msr");

243 
	`uÄegi¡”_hÙıu_nÙif›r
(&
m¤_şass_ıu_nÙif›r
);

244 
	}
}

246 
moduË_š™
(
m¤_š™
);

247 
	$moduË_ex™
(
m¤_ex™
)

249 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

250 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

251 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<lšux/k”Ãl.h
>

26 
	~<lšux/š™.h
>

27 
	~<lšux/ty³s.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/¥šlock.h
>

31 
	~<lšux/¡ršg.h
>

32 
	~<lšux/üash_dump.h
>

33 
	~<lšux/dma-m­pšg.h
>

34 
	~<lšux/b™İs.h
>

35 
	~<lšux/pci_ids.h
>

36 
	~<lšux/pci.h
>

37 
	~<lšux/d–ay.h
>

38 
	~<lšux/sÿ‰”li¡.h
>

39 
	~<lšux/iommu-h–³r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ÿlg¬y.h
>

43 
	~<asm/tû.h
>

44 
	~<asm/pci-dœeù.h
>

45 
	~<asm/sy¡em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

50 #ifdeà
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


51 
u£_ÿlg¬y
 
	g__»ad_mo¡ly
 = 1;

53 
u£_ÿlg¬y
 
	g__»ad_mo¡ly
 = 0;

56 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

57 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

60 
	#CALGARY_CONFIG_REG
 0x0108

	)

61 
	#PHB_CSR_OFFSET
 0x0110

	)

62 
	#PHB_PLSSR_OFFSET
 0x0120

	)

63 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

64 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

65 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

66 
	#PHB_MEM_1_LOW
 0x0190

	)

67 
	#PHB_MEM_1_HIGH
 0x01A0

	)

68 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

69 
	#PHB_MEM_1_SIZE
 0x01C0

	)

70 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

71 
	#PHB_AER_OFFSET
 0x0200

	)

72 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

73 
	#PHB_CONFIG_0_LOW
 0x0230

	)

74 
	#PHB_CONFIG_0_END
 0x0240

	)

75 
	#PHB_MEM_2_LOW
 0x02B0

	)

76 
	#PHB_MEM_2_HIGH
 0x02C0

	)

77 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

78 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

79 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

82 
	#PHB_SAVIOR_L2
 0x0DB0

	)

83 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

84 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

85 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

88 
	#PHB_TCE_ENABLE
 0x20000000

	)

89 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

90 
	#PHB_DAC_DISABLE
 0x01000000

	)

91 
	#PHB_MEM2_ENABLE
 0x00400000

	)

92 
	#PHB_MCSR_ENABLE
 0x00100000

	)

94 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

95 
	#TAR_VALID
 0x0000000000000008UL

	)

97 
	#CSR_AGENT_MASK
 0xfã0ffff

	)

99 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

101 
	#PMR_SOFTSTOP
 0x80000000

	)

102 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

103 
	#PMR_HARDSTOP
 0x20000000

	)

105 
	#MAX_NUM_OF_PHBS
 8

	)

106 
	#MAX_NUM_CHASSIS
 8

	)

108 
	#MAX_PHB_BUS_NUM
 (
MAX_NUM_OF_PHBS
 * 
MAX_NUM_CHASSIS
 * 2)

	)

109 
	#PHBS_PER_CALGARY
 4

	)

112 cÚ¡ 
	gr_off£ts
[] = {

119 cÚ¡ 
	g¥l™_queue_off£ts
[] = {

126 cÚ¡ 
	gphb_off£ts
[] = {

135 cÚ¡ 
	gphb_debug_off£ts
[] = {

147 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

149 
	#EMERGENCY_PAGES
 32

	)

151 
	g¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

152 
Œª¦©e_em±y_¦Ùs
 
	g__»ad_mo¡ly
 = 0;

153 
ÿlg¬y_d‘eùed
 
	g__»ad_mo¡ly
 = 0;

155 
rio_bË_hdr
 *rio_bË_hd¸
	g__š™d©a
;

156 
sÿl_d‘a
 *
	gsÿl_devs
[
MAX_NUMNODES
] 
	g__š™d©a
;

157 
rio_d‘a
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__š™d©a
;

159 
	sÿlg¬y_bus_šfo
 {

160 *
	mtû_¥aû
;

161 
	mŒª¦©iÚ_di§bËd
;

162 sigÃd 
	mphbid
;

163 
__iomem
 *
	mbb¬
;

166 
ÿlg¬y_hªdË_quœks
(
iommu_bË
 *
tbl
, 
pci_dev
 *
dev
);

167 
ÿlg¬y_tû_ÿche_bÏ¡
(
iommu_bË
 *
tbl
);

168 
ÿlg¬y_dump_”rÜ_»gs
(
iommu_bË
 *
tbl
);

169 
ÿlioc2_hªdË_quœks
(
iommu_bË
 *
tbl
, 
pci_dev
 *
dev
);

170 
ÿlioc2_tû_ÿche_bÏ¡
(
iommu_bË
 *
tbl
);

171 
ÿlioc2_dump_”rÜ_»gs
(
iommu_bË
 *
tbl
);

172 
ÿlg¬y_š™_b™m­_äom_tû_bË
(
iommu_bË
 *
tbl
);

173 
g‘_tû_¥aû_äom_r
();

175 
ÿl_ch£t_İs
 
	gÿlg¬y_ch_İs
 = {

176 .
hªdË_quœks
 = 
ÿlg¬y_hªdË_quœks
,

177 .
	gtû_ÿche_bÏ¡
 = 
ÿlg¬y_tû_ÿche_bÏ¡
,

178 .
	gdump_”rÜ_»gs
 = 
ÿlg¬y_dump_”rÜ_»gs


181 
ÿl_ch£t_İs
 
	gÿlioc2_ch_İs
 = {

182 .
hªdË_quœks
 = 
ÿlioc2_hªdË_quœks
,

183 .
	gtû_ÿche_bÏ¡
 = 
ÿlioc2_tû_ÿche_bÏ¡
,

184 .
	gdump_”rÜ_»gs
 = 
ÿlioc2_dump_”rÜ_»gs


187 
ÿlg¬y_bus_šfo
 
	gbus_šfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

190 #ifdeà
CONFIG_IOMMU_DEBUG


191 
	gdebuggšg
 = 1;

193 
šlše
 
	$v”ify_b™_¿nge
(* 
b™m­
,

194 
ex³ùed
, 
¡¬t
, 
’d
)

196 
idx
 = 
¡¬t
;

198 
	`BUG_ON
(
¡¬t
 >ğ
’d
);

200 
idx
 < 
’d
) {

201 ià(!!
	`‹¡_b™
(
idx
, 
b™m­
è!ğ
ex³ùed
)

202  
idx
;

203 ++
idx
;

208 
	}
}

210 
	gdebuggšg
;

212 
šlše
 
	$v”ify_b™_¿nge
(* 
b™m­
,

213 
ex³ùed
, 
¡¬t
, 
’d
)

216 
	}
}

220 
šlše
 
	$Œª¦©iÚ_’abËd
(
iommu_bË
 *
tbl
)

223  (
tbl
 !ğ
NULL
);

224 
	}
}

226 
	$iommu_¿nge_»£rve
(
iommu_bË
 *
tbl
,

227 
¡¬t_addr
, 
Åages
)

229 
šdex
;

230 
’d
;

231 
badb™
;

232 
æags
;

234 
šdex
 = 
¡¬t_addr
 >> 
PAGE_SHIFT
;

237 ià(
šdex
 >ğ
tbl
->
™_size
)

240 
’d
 = 
šdex
 + 
Åages
;

241 ià(
’d
 > 
tbl
->
™_size
)

242 
’d
 = 
tbl
->
™_size
;

244 
	`¥š_lock_œq§ve
(&
tbl
->
™_lock
, 
æags
);

246 
badb™
 = 
	`v”ify_b™_¿nge
(
tbl
->
™_m­
, 0, 
šdex
, 
’d
);

247 ià(
badb™
 != ~0UL) {

248 ià(
	`´štk_¿‹lim™
())

249 
	`´štk
(
KERN_ERR
 "Calgary:ƒntry‡lready‡llocated‡t "

251 
badb™
, 
tbl
, 
¡¬t_addr
, 
Åages
);

254 
	`iommu_¬—_»£rve
(
tbl
->
™_m­
, 
šdex
, 
Åages
);

256 
	`¥š_uÆock_œq»¡Üe
(&
tbl
->
™_lock
, 
æags
);

257 
	}
}

259 
	$iommu_¿nge_®loc
(
deviû
 *
dev
,

260 
iommu_bË
 *
tbl
,

261 
Åages
)

263 
æags
;

264 
off£t
;

265 
bound¬y_size
;

267 
bound¬y_size
 = 
	`ALIGN
(
	`dma_g‘_£g_bound¬y
(
dev
) + 1,

268 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

270 
	`BUG_ON
(
Åages
 == 0);

272 
	`¥š_lock_œq§ve
(&
tbl
->
™_lock
, 
æags
);

274 
off£t
 = 
	`iommu_¬—_®loc
(
tbl
->
™_m­
,bl->
™_size
,bl->
™_hšt
,

275 
Åages
, 0, 
bound¬y_size
, 0);

276 ià(
off£t
 == ~0UL) {

277 
tbl
->
ch_İs
->
	`tû_ÿche_bÏ¡
(tbl);

279 
off£t
 = 
	`iommu_¬—_®loc
(
tbl
->
™_m­
,bl->
™_size
, 0,

280 
Åages
, 0, 
bound¬y_size
, 0);

281 ià(
off£t
 == ~0UL) {

282 
	`´štk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

283 
	`¥š_uÆock_œq»¡Üe
(&
tbl
->
™_lock
, 
æags
);

284 ià(
·nic_Ú_ov”æow
)

285 
	`·nic
("Calgary: fixhe‡llocator.\n");

287  
bad_dma_add»ss
;

291 
tbl
->
™_hšt
 = 
off£t
 + 
Åages
;

292 
	`BUG_ON
(
tbl
->
™_hšt
 >bl->
™_size
);

294 
	`¥š_uÆock_œq»¡Üe
(&
tbl
->
™_lock
, 
æags
);

296  
off£t
;

297 
	}
}

299 
dma_addr_t
 
	$iommu_®loc
(
deviû
 *
dev
, 
iommu_bË
 *
tbl
,

300 *
vaddr
, 
Åages
, 
dœeùiÚ
)

302 
’Œy
;

303 
dma_addr_t
 
»t
 = 
bad_dma_add»ss
;

305 
’Œy
 = 
	`iommu_¿nge_®loc
(
dev
, 
tbl
, 
Åages
);

307 ià(
	`uÆik–y
(
’Œy
 =ğ
bad_dma_add»ss
))

308 
”rÜ
;

311 
»t
 = (
’Œy
 << 
PAGE_SHIFT
è| (()
vaddr
 & ~
PAGE_MASK
);

314 
	`tû_bud
(
tbl
, 
’Œy
, 
Åages
, ()
vaddr
 & 
PAGE_MASK
,

315 
dœeùiÚ
);

317  
»t
;

319 
”rÜ
:

320 
	`´štk
(
KERN_WARNING
 "Calgary: failedo‡llocate %u…ages in "

321 "iommu %p\n", 
Åages
, 
tbl
);

322  
bad_dma_add»ss
;

323 
	}
}

325 
	$iommu_ä“
(
iommu_bË
 *
tbl
, 
dma_addr_t
 
dma_addr
,

326 
Åages
)

328 
’Œy
;

329 
badb™
;

330 
bad’d
;

331 
æags
;

334 
bad’d
 = 
bad_dma_add»ss
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

335 ià(
	`uÆik–y
((
dma_addr
 >ğ
bad_dma_add»ss
è&& (dma_add¸< 
bad’d
))) {

336 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverried unmapping bad DMA "

337 "add»s 0x%Lx\n", 
dma_addr
);

341 
’Œy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

343 
	`BUG_ON
(
’Œy
 + 
Åages
 > 
tbl
->
™_size
);

345 
	`tû_ä“
(
tbl
, 
’Œy
, 
Åages
);

347 
	`¥š_lock_œq§ve
(&
tbl
->
™_lock
, 
æags
);

349 
badb™
 = 
	`v”ify_b™_¿nge
(
tbl
->
™_m­
, 1, 
’Œy
,ƒÁry + 
Åages
);

350 ià(
badb™
 != ~0UL) {

351 ià(
	`´štk_¿‹lim™
())

352 
	`´štk
(
KERN_ERR
 "Calgary: bit is off‡t 0x%lx "

354 
badb™
, 
tbl
, 
dma_addr
, 
’Œy
, 
Åages
);

357 
	`iommu_¬—_ä“
(
tbl
->
™_m­
, 
’Œy
, 
Åages
);

359 
	`¥š_uÆock_œq»¡Üe
(&
tbl
->
™_lock
, 
æags
);

360 
	}
}

362 
šlše
 
iommu_bË
 *
	$fšd_iommu_bË
(
deviû
 *
dev
)

364 
pci_dev
 *
pdev
;

365 
pci_bus
 *
pbus
;

366 
iommu_bË
 *
tbl
;

368 
pdev
 = 
	`to_pci_dev
(
dev
);

370 
pbus
 = 
pdev
->
bus
;

373 
pbus
->
·»Á
)

374 
pbus
 =…bus->
·»Á
;

376 
tbl
 = 
	`pci_iommu
(
pbus
);

378 
	`BUG_ON
(
tbl
 && (tbl->
™_bu¢o
 !ğ
pbus
->
numb”
));

380  
tbl
;

381 
	}
}

383 
	$ÿlg¬y_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sgli¡
,

384 
ÃËms
,
dma_d©a_dœeùiÚ
 
dœ
,

385 
dma_©Œs
 *
©Œs
)

387 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

388 
sÿ‰”li¡
 *
s
;

389 
i
;

391 ià(!
	`Œª¦©iÚ_’abËd
(
tbl
))

394 
	`fÜ_—ch_sg
(
sgli¡
, 
s
, 
ÃËms
, 
i
) {

395 
Åages
;

396 
dma_addr_t
 
dma
 = 
s
->
dma_add»ss
;

397 
dm®’
 = 
s
->
dma_Ëngth
;

399 ià(
dm®’
 == 0)

402 
Åages
 = 
	`iommu_num_·ges
(
dma
, 
dm®’
, 
PAGE_SIZE
);

403 
	`iommu_ä“
(
tbl
, 
dma
, 
Åages
);

405 
	}
}

407 
	$ÿlg¬y_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
,

408 
ÃËms
, 
dma_d©a_dœeùiÚ
 
dœ
,

409 
dma_©Œs
 *
©Œs
)

411 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

412 
sÿ‰”li¡
 *
s
;

413 
vaddr
;

414 
Åages
;

415 
’Œy
;

416 
i
;

418 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃËms
, 
i
) {

419 
	`BUG_ON
(!
	`sg_·ge
(
s
));

421 
vaddr
 = (è
	`sg_vœt
(
s
);

422 
Åages
 = 
	`iommu_num_·ges
(
vaddr
, 
s
->
Ëngth
, 
PAGE_SIZE
);

424 
’Œy
 = 
	`iommu_¿nge_®loc
(
dev
, 
tbl
, 
Åages
);

425 ià(
’Œy
 =ğ
bad_dma_add»ss
) {

427 
s
->
dma_Ëngth
 = 0;

428 
”rÜ
;

431 
s
->
dma_add»ss
 = (
’Œy
 << 
PAGE_SHIFT
è| s->
off£t
;

434 
	`tû_bud
(
tbl
, 
’Œy
, 
Åages
, 
vaddr
 & 
PAGE_MASK
, 
dœ
);

436 
s
->
dma_Ëngth
 = s->
Ëngth
;

439  
ÃËms
;

440 
”rÜ
:

441 
	`ÿlg¬y_unm­_sg
(
dev
, 
sg
, 
ÃËms
, 
dœ
, 
NULL
);

442 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃËms
, 
i
) {

443 
sg
->
dma_add»ss
 = 
bad_dma_add»ss
;

444 
sg
->
dma_Ëngth
 = 0;

447 
	}
}

449 
dma_addr_t
 
	$ÿlg¬y_m­_·ge
(
deviû
 *
dev
, 
·ge
 *page,

450 
off£t
, 
size_t
 
size
,

451 
dma_d©a_dœeùiÚ
 
dœ
,

452 
dma_©Œs
 *
©Œs
)

454 *
vaddr
 = 
	`·ge_add»ss
(
·ge
è+ 
off£t
;

455 
uaddr
;

456 
Åages
;

457 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

459 
uaddr
 = ()
vaddr
;

460 
Åages
 = 
	`iommu_num_·ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

462  
	`iommu_®loc
(
dev
, 
tbl
, 
vaddr
, 
Åages
, 
dœ
);

463 
	}
}

465 
	$ÿlg¬y_unm­_·ge
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
,

466 
size_t
 
size
, 
dma_d©a_dœeùiÚ
 
dœ
,

467 
dma_©Œs
 *
©Œs
)

469 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

470 
Åages
;

472 
Åages
 = 
	`iommu_num_·ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

473 
	`iommu_ä“
(
tbl
, 
dma_addr
, 
Åages
);

474 
	}
}

476 * 
	$ÿlg¬y_®loc_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

477 
dma_addr_t
 *
dma_hªdË
, 
gå_t
 
æag
)

479 *
»t
 = 
NULL
;

480 
dma_addr_t
 
m­pšg
;

481 
Åages
, 
Üd”
;

482 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

484 
size
 = 
	`PAGE_ALIGN
(size);

485 
Åages
 = 
size
 >> 
PAGE_SHIFT
;

486 
Üd”
 = 
	`g‘_Üd”
(
size
);

488 
æag
 &ğ~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

491 
»t
 = (*)
	`__g‘_ä“_·ges
(
æag
, 
Üd”
);

492 ià(!
»t
)

493 
”rÜ
;

494 
	`mem£t
(
»t
, 0, 
size
);

497 
m­pšg
 = 
	`iommu_®loc
(
dev
, 
tbl
, 
»t
, 
Åages
, 
DMA_BIDIRECTIONAL
);

498 ià(
m­pšg
 =ğ
bad_dma_add»ss
)

499 
ä“
;

500 *
dma_hªdË
 = 
m­pšg
;

501  
»t
;

502 
ä“
:

503 
	`ä“_·ges
(()
»t
, 
	`g‘_Üd”
(
size
));

504 
»t
 = 
NULL
;

505 
”rÜ
:

506  
»t
;

507 
	}
}

509 
	$ÿlg¬y_ä“_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

510 *
vaddr
, 
dma_addr_t
 
dma_hªdË
)

512 
Åages
;

513 
iommu_bË
 *
tbl
 = 
	`fšd_iommu_bË
(
dev
);

515 
size
 = 
	`PAGE_ALIGN
(size);

516 
Åages
 = 
size
 >> 
PAGE_SHIFT
;

518 
	`iommu_ä“
(
tbl
, 
dma_hªdË
, 
Åages
);

519 
	`ä“_·ges
(()
vaddr
, 
	`g‘_Üd”
(
size
));

520 
	}
}

522 
dma_m­_İs
 
	gÿlg¬y_dma_İs
 = {

523 .
®loc_coh”’t
 = 
ÿlg¬y_®loc_coh”’t
,

524 .
	gä“_coh”’t
 = 
ÿlg¬y_ä“_coh”’t
,

525 .
	gm­_sg
 = 
ÿlg¬y_m­_sg
,

526 .
	gunm­_sg
 = 
ÿlg¬y_unm­_sg
,

527 .
	gm­_·ge
 = 
ÿlg¬y_m­_·ge
,

528 .
	gunm­_·ge
 = 
ÿlg¬y_unm­_·ge
,

531 
šlše
 
__iomem
 * 
	$bu¢o_to_bb¬
(
num
)

533  
bus_šfo
[
num
].
bb¬
;

534 
	}
}

536 
šlše
 
	$bu¢o_to_phbid
(
num
)

538  
bus_šfo
[
num
].
phbid
;

539 
	}
}

541 
šlše
 
	$¥l™_queue_off£t
(
num
)

543 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

545  
¥l™_queue_off£ts
[
idx
];

546 
	}
}

548 
šlše
 
	$r_off£t
(
num
)

550 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

552  
r_off£ts
[
idx
];

553 
	}
}

555 
šlše
 
	$phb_off£t
(
num
)

557 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

559  
phb_off£ts
[
idx
];

560 
	}
}

562 
šlše
 
__iomem
* 
	$ÿlg¬y_»g
(
__iomem
 *
b¬
, 
off£t
)

564 
rg‘
 = (()
b¬
è| 
off£t
;

565  (
__iomem
*)
rg‘
;

566 
	}
}

568 
šlše
 
	$is_ÿlioc2
(
deviû
)

570  (
deviû
 =ğ
PCI_DEVICE_ID_IBM_CALIOC2
);

571 
	}
}

573 
šlše
 
	$is_ÿlg¬y
(
deviû
)

575  (
deviû
 =ğ
PCI_DEVICE_ID_IBM_CALGARY
);

576 
	}
}

578 
šlše
 
	$is_ÿl_pci_dev
(
deviû
)

580  (
	`is_ÿlg¬y
(
deviû
è|| 
	`is_ÿlioc2
(device));

581 
	}
}

583 
	$ÿlg¬y_tû_ÿche_bÏ¡
(
iommu_bË
 *
tbl
)

585 
u64
 
v®
;

586 
u32
 
«r
;

587 
i
 = 0;

588 
__iomem
 *
bb¬
 = 
tbl
->bbar;

589 
__iomem
 *
rg‘
;

592 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_AER_OFFSET
);

593 
«r
 = 
	`»adl
(
rg‘
);

594 
	`wr™–
(0, 
rg‘
);

597 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_PLSSR_OFFSET
);

598 
v®
 = 
	`»adl
(
rg‘
);

601 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`¥l™_queue_off£t
(
tbl
->
™_bu¢o
));

603 
v®
 = 
	`»adq
(
rg‘
);

604 
i
++;

605 } (
v®
 & 0xffè!ğ0xfà&& 
i
 < 100);

606 ià(
i
 == 100)

607 
	`´štk
(
KERN_WARNING
 "Calgary: PCI bus‚ot quiesced, "

611 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`r_off£t
(
tbl
->
™_bu¢o
));

612 
	`wr™eq
(
tbl
->
r_v®
, 
rg‘
);

615 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_AER_OFFSET
);

616 
	`wr™–
(
«r
, 
rg‘
);

617 ()
	`»adl
(
rg‘
);

618 
	}
}

620 
	$ÿlioc2_tû_ÿche_bÏ¡
(
iommu_bË
 *
tbl
)

622 
__iomem
 *
bb¬
 = 
tbl
->bbar;

623 
__iomem
 *
rg‘
;

624 
u64
 
v®64
;

625 
u32
 
v®
;

626 
i
 = 0;

627 
couÁ
 = 1;

628 
bus
 = 
tbl
->
™_bu¢o
;

630 
begš
:

631 
	`´štk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xƒnteringce cache blast "

632 "£qu’û - couÁ %d\n", 
bus
, 
couÁ
);

635 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_CTRL
);

636 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

637 
	`´štk
(
KERN_DEBUG
 "1a.„—d 0x%x [LE] from %p\n", 
v®
, 
rg‘
);

638 
v®
 |ğ
PMR_SOFTSTOP
;

639 
	`´štk
(
KERN_DEBUG
 "1b. wr™šg 0x%x [LE]Ø%p\n", 
v®
, 
rg‘
);

640 
	`wr™–
(
	`ıu_to_be32
(
v®
), 
rg‘
);

643 
	`´štk
(
KERN_DEBUG
 "2a. startingo…oll split queues\n");

644 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`¥l™_queue_off£t
(
bus
));

646 
v®64
 = 
	`»adq
(
rg‘
);

647 
i
++;

648 } (
v®64
 & 0xffè!ğ0xfà&& 
i
 < 100);

649 ià(
i
 == 100)

650 
	`´štk
(
KERN_WARNING
 "CalIOC2: PCI bus‚ot quiesced, "

654 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_DEBUG
);

655 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

656 
	`´štk
(
KERN_DEBUG
 "3.„—d 0x%x [LE] from %p\n", 
v®
, 
rg‘
);

659 ià(
v®
 & 
PMR_SOFTSTOPFAULT
) {

660 ià(++
couÁ
 < 100)

661 
begš
;

663 
	`´štk
(
KERN_WARNING
 "CalIOC2:oo many SoftStopFaults, "

670 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_CTRL
);

671 
	`´štk
(
KERN_DEBUG
 "5a. sÏmmšg iÁØH¬dStİ by„—dšg %p\n", 
rg‘
);

672 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

673 
	`´štk
(
KERN_DEBUG
 "5b.„—d 0x%x [LE] from %p\n", 
v®
, 
rg‘
);

674 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_DEBUG
);

675 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

676 
	`´štk
(
KERN_DEBUG
 "5c.„—d 0x%x [LE] from %°(debug)\n", 
v®
, 
rg‘
);

679 
	`´štk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

680 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`r_off£t
(
bus
));

681 
	`wr™eq
(
tbl
->
r_v®
, 
rg‘
);

684 
	`´štk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

685 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_CTRL
);

686 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

687 
	`´štk
(
KERN_DEBUG
 "7b.„—d 0x%x [LE] from %p\n", 
v®
, 
rg‘
);

690 
	`´štk
(
KERN_DEBUG
 "8a.„emoving HardStop from PMCR\n");

691 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bus
è| 
PHB_PAGE_MIG_CTRL
);

692 
v®
 = 0;

693 
	`´štk
(
KERN_DEBUG
 "8b. wr™šg 0x%x [LE]Ø%p\n", 
v®
, 
rg‘
);

694 
	`wr™–
(
	`ıu_to_be32
(
v®
), 
rg‘
);

695 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

696 
	`´štk
(
KERN_DEBUG
 "8c.„—d 0x%x [LE] from %p\n", 
v®
, 
rg‘
);

697 
	}
}

699 
__š™
 
	$ÿlg¬y_»£rve_mem_»giÚ
(
pci_dev
 *
dev
, 
u64
 
¡¬t
,

700 
u64
 
lim™
)

702 
num·ges
;

704 
lim™
 =†imit | 0xfffff;

705 
lim™
++;

707 
num·ges
 = ((
lim™
 - 
¡¬t
è>> 
PAGE_SHIFT
);

708 
	`iommu_¿nge_»£rve
(
	`pci_iommu
(
dev
->
bus
), 
¡¬t
, 
num·ges
);

709 
	}
}

711 
__š™
 
	$ÿlg¬y_»£rve_³rh”®_mem_1
(
pci_dev
 *
dev
)

713 
__iomem
 *
rg‘
;

714 
u64
 
low
, 
high
, 
siz–ow
;

715 
u64
 
¡¬t
, 
lim™
;

716 
iommu_bË
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

717 
bu¢um
 = 
dev
->
bus
->
numb”
;

718 
__iomem
 *
bb¬
 = 
tbl
->bbar;

721 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_1_LOW
);

722 
low
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

723 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_1_HIGH
);

724 
high
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

725 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_1_SIZE
);

726 
siz–ow
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

728 
¡¬t
 = (
high
 << 32è| 
low
;

729 
lim™
 = 
siz–ow
;

731 
	`ÿlg¬y_»£rve_mem_»giÚ
(
dev
, 
¡¬t
, 
lim™
);

732 
	}
}

734 
__š™
 
	$ÿlg¬y_»£rve_³rh”®_mem_2
(
pci_dev
 *
dev
)

736 
__iomem
 *
rg‘
;

737 
u32
 
v®32
;

738 
u64
 
low
, 
high
, 
siz–ow
, 
sizehigh
;

739 
u64
 
¡¬t
, 
lim™
;

740 
iommu_bË
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

741 
bu¢um
 = 
dev
->
bus
->
numb”
;

742 
__iomem
 *
bb¬
 = 
tbl
->bbar;

745 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_CONFIG_RW_OFFSET
);

746 
v®32
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

747 ià(!(
v®32
 & 
PHB_MEM2_ENABLE
))

750 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_2_LOW
);

751 
low
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

752 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_2_HIGH
);

753 
high
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

754 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_2_SIZE_LOW
);

755 
siz–ow
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

756 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_MEM_2_SIZE_HIGH
);

757 
sizehigh
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

759 
¡¬t
 = (
high
 << 32è| 
low
;

760 
lim™
 = (
sizehigh
 << 32è| 
siz–ow
;

762 
	`ÿlg¬y_»£rve_mem_»giÚ
(
dev
, 
¡¬t
, 
lim™
);

763 
	}
}

772 
__š™
 
	$ÿlg¬y_»£rve_»giÚs
(
pci_dev
 *
dev
)

774 
Åages
;

775 
u64
 
¡¬t
;

776 
iommu_bË
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

779 
	`iommu_¿nge_»£rve
(
tbl
, 
bad_dma_add»ss
, 
EMERGENCY_PAGES
);

783 ià(
	`is_ÿlg¬y
(
dev
->
deviû
)) {

784 
¡¬t
 = (640 * 1024);

785 
Åages
 = ((1024 - 640è* 1024è>> 
PAGE_SHIFT
;

787 
¡¬t
 = 0;

788 
Åages
 = (1 * 1024 * 1024è>> 
PAGE_SHIFT
;

790 
	`iommu_¿nge_»£rve
(
tbl
, 
¡¬t
, 
Åages
);

793 
	`ÿlg¬y_»£rve_³rh”®_mem_1
(
dev
);

794 
	`ÿlg¬y_»£rve_³rh”®_mem_2
(
dev
);

795 
	}
}

797 
__š™
 
	$ÿlg¬y_£tup_r
(
pci_dev
 *
dev
, 
__iomem
 *
bb¬
)

799 
u64
 
v®64
;

800 
u64
 
bË_phys
;

801 
__iomem
 *
rg‘
;

802 
»t
;

803 
iommu_bË
 *
tbl
;

806 
»t
 = 
	`bud_tû_bË
(
dev
, 
bb¬
);

807 ià(
»t
)

808  
»t
;

810 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

811 
tbl
->
™_ba£
 = ()
bus_šfo
[
dev
->
bus
->
numb”
].
tû_¥aû
;

813 ià(
	`is_kdump_k”Ãl
())

814 
	`ÿlg¬y_š™_b™m­_äom_tû_bË
(
tbl
);

816 
	`tû_ä“
(
tbl
, 0,bl->
™_size
);

818 ià(
	`is_ÿlg¬y
(
dev
->
deviû
))

819 
tbl
->
ch_İs
 = &
ÿlg¬y_ch_İs
;

820 ià(
	`is_ÿlioc2
(
dev
->
deviû
))

821 
tbl
->
ch_İs
 = &
ÿlioc2_ch_İs
;

823 
	`BUG
();

825 
	`ÿlg¬y_»£rve_»giÚs
(
dev
);

828 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`r_off£t
(
dev
->
bus
->
numb”
));

829 
v®64
 = 
	`be64_to_ıu
(
	`»adq
(
rg‘
));

832 
v®64
 &ğ~
TAR_SW_BITS
;

833 
bË_phys
 = (
u64
)
	`__·
(
tbl
->
™_ba£
);

835 
v®64
 |ğ
bË_phys
;

837 
	`BUG_ON
(
¥ecif›d_bË_size
 > 
TCE_TABLE_SIZE_8M
);

838 
v®64
 |ğ(
u64
è
¥ecif›d_bË_size
;

840 
tbl
->
r_v®
 = 
	`ıu_to_be64
(
v®64
);

842 
	`wr™eq
(
tbl
->
r_v®
, 
rg‘
);

843 
	`»adq
(
rg‘
);

846 
	}
}

848 
__š™
 
	$ÿlg¬y_ä“_bus
(
pci_dev
 *
dev
)

850 
u64
 
v®64
;

851 
iommu_bË
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

852 
__iomem
 *
rg‘
;

853 
b™m­sz
;

855 
rg‘
 = 
	`ÿlg¬y_»g
(
tbl
->
bb¬
, 
	`r_off£t
(
dev
->
bus
->
numb”
));

856 
v®64
 = 
	`be64_to_ıu
(
	`»adq
(
rg‘
));

857 
v®64
 &ğ~
TAR_SW_BITS
;

858 
	`wr™eq
(
	`ıu_to_be64
(
v®64
), 
rg‘
);

859 
	`»adq
(
rg‘
);

861 
b™m­sz
 = 
tbl
->
™_size
 / 
BITS_PER_BYTE
;

862 
	`ä“_·ges
(()
tbl
->
™_m­
, 
	`g‘_Üd”
(
b™m­sz
));

863 
tbl
->
™_m­
 = 
NULL
;

865 
	`kä“
(
tbl
);

867 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

870 
bus_šfo
[
dev
->
bus
->
numb”
].
tû_¥aû
 = 
NULL
;

871 
	}
}

873 
	$ÿlg¬y_dump_”rÜ_»gs
(
iommu_bË
 *
tbl
)

875 
__iomem
 *
bb¬
 = 
tbl
->bbar;

876 
__iomem
 *
rg‘
;

877 
u32
 
c¤
, 
¶s¤
;

879 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_CSR_OFFSET
);

880 
c¤
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

882 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_PLSSR_OFFSET
);

883 
¶s¤
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

886 
	`´štk
(
KERN_EMERG
 "Calgary: DMAƒrror on Calgary PHB 0x%x, "

887 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
™_bu¢o
, 
c¤
, 
¶s¤
);

888 
	}
}

890 
	$ÿlioc2_dump_”rÜ_»gs
(
iommu_bË
 *
tbl
)

892 
__iomem
 *
bb¬
 = 
tbl
->bbar;

893 
u32
 
c¤
, 
csmr
, 
¶s¤
, 
mck
, 
rc¡©
;

894 
__iomem
 *
rg‘
;

895 
phboff
 = 
	`phb_off£t
(
tbl
->
™_bu¢o
);

896 
”roff
;

897 
u32
 
”¼egs
[7];

898 
i
;

901 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 
PHB_CSR_OFFSET
);

902 
c¤
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

904 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

905 
¶s¤
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

907 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 0x290);

908 
csmr
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

910 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 0x800);

911 
mck
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

913 
	`´štk
(
KERN_EMERG
 "Calgary: DMAƒrror on CalIOC2 PHB 0x%x\n",

914 
tbl
->
™_bu¢o
);

916 
	`´štk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

917 
c¤
, 
¶s¤
, 
csmr
, 
mck
);

920 
	`´štk
(
KERN_EMERG
 "Calgary: ");

921 
i
 = 0; i < 
	`ARRAY_SIZE
(
”¼egs
); i++) {

923 
”roff
 = (0x810 + (
i
 * 0x10));

924 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 
”roff
);

925 
”¼egs
[
i
] = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

926 
	`´štk
("0x%08x@0x%lx ", 
”¼egs
[
i
], 
”roff
);

928 
	`´štk
("\n");

931 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

932 
rc¡©
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

933 
	`´štk
(
KERN_EMERG
 "C®g¬y: 0x%08x@0x%x\n", 
rc¡©
,

934 
PHB_ROOT_COMPLEX_STATUS
);

935 
	}
}

937 
	$ÿlg¬y_w©chdog
(
d©a
)

939 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

940 
iommu_bË
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

941 
__iomem
 *
bb¬
 = 
tbl
->bbar;

942 
u32
 
v®32
;

943 
__iomem
 *
rg‘
;

945 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
è| 
PHB_CSR_OFFSET
);

946 
v®32
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

949 ià(
v®32
 & 
CSR_AGENT_MASK
) {

950 
tbl
->
ch_İs
->
	`dump_”rÜ_»gs
(tbl);

953 
	`wr™–
(0, 
rg‘
);

956 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
tbl
->
™_bu¢o
) |

957 
PHB_CONFIG_RW_OFFSET
);

958 
v®32
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

959 
v®32
 |ğ
PHB_SLOT_DISABLE
;

960 
	`wr™–
(
	`ıu_to_be32
(
v®32
), 
rg‘
);

961 
	`»adl
(
rg‘
);

964 
	`mod_tim”
(&
tbl
->
w©chdog_tim”
, 
jiff›s
 + 2 * 
HZ
);

966 
	}
}

968 
__š™
 
	$ÿlg¬y_£t_¥l™_com¶‘iÚ_timeout
(
__iomem
 *
bb¬
,

969 
bu¢um
, 
timeout
)

971 
u64
 
v®64
;

972 
__iomem
 *
rg‘
;

973 
phb_shiá
 = ~0;

974 
u64
 
mask
;

976 
	`bu¢o_to_phbid
(
bu¢um
)) {

977 0: 
phb_shiá
 = (63 - 19);

979 1: 
phb_shiá
 = (63 - 23);

981 2: 
phb_shiá
 = (63 - 27);

983 3: 
phb_shiá
 = (63 - 35);

986 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

989 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
CALGARY_CONFIG_REG
);

990 
v®64
 = 
	`be64_to_ıu
(
	`»adq
(
rg‘
));

993 
mask
 = ~(0xFUL << 
phb_shiá
);

994 
v®64
 &ğ
mask
;

995 
v®64
 |ğ(
timeout
 << 
phb_shiá
);

996 
	`wr™eq
(
	`ıu_to_be64
(
v®64
), 
rg‘
);

997 
	`»adq
(
rg‘
);

998 
	}
}

1000 
__š™
 
	$ÿlioc2_hªdË_quœks
(
iommu_bË
 *
tbl
, 
pci_dev
 *
dev
)

1002 
bu¢um
 = 
dev
->
bus
->
numb”
;

1003 
__iomem
 *
bb¬
 = 
tbl
->bbar;

1004 
__iomem
 *
rg‘
;

1005 
u32
 
v®
;

1010 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_SAVIOR_L2
);

1011 
v®
 = 
	`ıu_to_be32
(
	`»adl
(
rg‘
));

1012 
v®
 |= 0x00800000;

1013 
	`wr™–
(
	`ıu_to_be32
(
v®
), 
rg‘
);

1014 
	}
}

1016 
__š™
 
	$ÿlg¬y_hªdË_quœks
(
iommu_bË
 *
tbl
, 
pci_dev
 *
dev
)

1018 
bu¢um
 = 
dev
->
bus
->
numb”
;

1024 ià(
	`is_ÿlg¬y
(
dev
->
deviû
è&& (
bu¢um
 == 1))

1025 
	`ÿlg¬y_£t_¥l™_com¶‘iÚ_timeout
(
tbl
->
bb¬
, 
bu¢um
,

1026 
CCR_2SEC_TIMEOUT
);

1027 
	}
}

1029 
__š™
 
	$ÿlg¬y_’abË_Œª¦©iÚ
(
pci_dev
 *
dev
)

1031 
u32
 
v®32
;

1032 
bu¢um
;

1033 
__iomem
 *
rg‘
;

1034 
__iomem
 *
bb¬
;

1035 
iommu_bË
 *
tbl
;

1037 
bu¢um
 = 
dev
->
bus
->
numb”
;

1038 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1039 
bb¬
 = 
tbl
->bbar;

1042 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_CONFIG_RW_OFFSET
);

1043 
v®32
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

1044 
v®32
 |ğ
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

1046 
	`´štk
(
KERN_INFO
 "Calgary:ƒnablingranslation on %s PHB %#x\n",

1047 (
dev
->
deviû
 =ğ
PCI_DEVICE_ID_IBM_CALGARY
) ?

1048 "C®g¬y" : "C®IOC2", 
bu¢um
);

1049 
	`´štk
(
KERN_INFO
 "Calgary:ƒrrant DMAs will‚ow be…revented onhis "

1052 
	`wr™–
(
	`ıu_to_be32
(
v®32
), 
rg‘
);

1053 
	`»adl
(
rg‘
);

1055 
	`š™_tim”
(&
tbl
->
w©chdog_tim”
);

1056 
tbl
->
w©chdog_tim”
.
funùiÚ
 = &
ÿlg¬y_w©chdog
;

1057 
tbl
->
w©chdog_tim”
.
d©a
 = ()
dev
;

1058 
	`mod_tim”
(&
tbl
->
w©chdog_tim”
, 
jiff›s
);

1059 
	}
}

1061 
__š™
 
	$ÿlg¬y_di§bË_Œª¦©iÚ
(
pci_dev
 *
dev
)

1063 
u32
 
v®32
;

1064 
bu¢um
;

1065 
__iomem
 *
rg‘
;

1066 
__iomem
 *
bb¬
;

1067 
iommu_bË
 *
tbl
;

1069 
bu¢um
 = 
dev
->
bus
->
numb”
;

1070 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1071 
bb¬
 = 
tbl
->bbar;

1074 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
	`phb_off£t
(
bu¢um
è| 
PHB_CONFIG_RW_OFFSET
);

1075 
v®32
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

1076 
v®32
 &ğ~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1078 
	`´štk
(
KERN_INFO
 "C®g¬y: di§blšg¿n¦©iÚ oÀPHB %#x!\n", 
bu¢um
);

1079 
	`wr™–
(
	`ıu_to_be32
(
v®32
), 
rg‘
);

1080 
	`»adl
(
rg‘
);

1082 
	`d–_tim”_sync
(&
tbl
->
w©chdog_tim”
);

1083 
	}
}

1085 
__š™
 
	$ÿlg¬y_š™_Úe_nÚŒa¦©ed
(
pci_dev
 *
dev
)

1087 
	`pci_dev_g‘
(
dev
);

1088 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1091 ià(
dev
->
bus
->
·»Á
)

1092 
dev
->
bus
->
·»Á
->
£lf
 = dev;

1094 
dev
->
bus
->
£lf
 = dev;

1095 
	}
}

1097 
__š™
 
	$ÿlg¬y_š™_Úe
(
pci_dev
 *
dev
)

1099 
__iomem
 *
bb¬
;

1100 
iommu_bË
 *
tbl
;

1101 
»t
;

1103 
	`BUG_ON
(
dev
->
bus
->
numb”
 >ğ
MAX_PHB_BUS_NUM
);

1105 
bb¬
 = 
	`bu¢o_to_bb¬
(
dev
->
bus
->
numb”
);

1106 
»t
 = 
	`ÿlg¬y_£tup_r
(
dev
, 
bb¬
);

1107 ià(
»t
)

1108 
dÚe
;

1110 
	`pci_dev_g‘
(
dev
);

1112 ià(
dev
->
bus
->
·»Á
) {

1113 ià(
dev
->
bus
->
·»Á
->
£lf
)

1114 
	`´štk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1115 "bus->·»Á->£lf!\n", 
dev
);

1116 
dev
->
bus
->
·»Á
->
£lf
 = dev;

1118 
dev
->
bus
->
£lf
 = dev;

1120 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1121 
tbl
->
ch_İs
->
	`hªdË_quœks
Ñbl, 
dev
);

1123 
	`ÿlg¬y_’abË_Œª¦©iÚ
(
dev
);

1127 
dÚe
:

1128  
»t
;

1129 
	}
}

1131 
__š™
 
	$ÿlg¬y_loÿ‹_bb¬s
()

1133 
»t
;

1134 
rioidx
, 
phb
, 
bus
;

1135 
__iomem
 *
bb¬
;

1136 
__iomem
 *
rg‘
;

1137 
off£t
;

1138 
u8
 
¡¬t_bus
, 
’d_bus
;

1139 
u32
 
v®
;

1141 
»t
 = -
ENODATA
;

1142 
rioidx
 = 0;„ioidx < 
rio_bË_hdr
->
num_rio_dev
;„ioidx++) {

1143 
rio_d‘a
 *
rio
 = 
rio_devs
[
rioidx
];

1145 ià((
rio
->
ty³
 !ğ
COMPAT_CALGARY
è&& (rio->ty³ !ğ
ALT_CALGARY
))

1149 
bb¬
 = 
	`iÜem­_noÿche
(
rio
->
BBAR
, 1024 * 1024);

1150 ià(!
bb¬
)

1151 
”rÜ
;

1153 
phb
 = 0;…hb < 
PHBS_PER_CALGARY
;…hb++) {

1154 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1155 
rg‘
 = 
	`ÿlg¬y_»g
(
bb¬
, 
off£t
);

1157 
v®
 = 
	`be32_to_ıu
(
	`»adl
(
rg‘
));

1159 
¡¬t_bus
 = (
u8
)((
v®
 & 0x00FF0000) >> 16);

1160 
’d_bus
 = (
u8
)((
v®
 & 0x0000FF00) >> 8);

1162 ià(
’d_bus
) {

1163 
bus
 = 
¡¬t_bus
; bu <ğ
’d_bus
; bus++) {

1164 
bus_šfo
[
bus
].
bb¬
 = bbar;

1165 
bus_šfo
[
bus
].
phbid
 = 
phb
;

1168 
bus_šfo
[
¡¬t_bus
].
bb¬
 = bbar;

1169 
bus_šfo
[
¡¬t_bus
].
phbid
 = 
phb
;

1176 
”rÜ
:

1178 
bus
 = 0; bu < 
	`ARRAY_SIZE
(
bus_šfo
); bus++)

1179 ià(
bus_šfo
[
bus
].
bb¬
)

1180 
	`iounm­
(
bus_šfo
[
bus
].
bb¬
);

1182  
»t
;

1183 
	}
}

1185 
__š™
 
	$ÿlg¬y_š™
()

1187 
»t
;

1188 
pci_dev
 *
dev
 = 
NULL
;

1189 
ÿlg¬y_bus_šfo
 *
šfo
;

1191 
»t
 = 
	`ÿlg¬y_loÿ‹_bb¬s
();

1192 ià(
»t
)

1193  
»t
;

1196 ià(
	`is_kdump_k”Ãl
())

1197 
	`g‘_tû_¥aû_äom_r
();

1200 
dev
 = 
	`pci_g‘_deviû
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1201 ià(!
dev
)

1203 ià(!
	`is_ÿl_pci_dev
(
dev
->
deviû
))

1206 
šfo
 = &
bus_šfo
[
dev
->
bus
->
numb”
];

1207 ià(
šfo
->
Œª¦©iÚ_di§bËd
) {

1208 
	`ÿlg¬y_š™_Úe_nÚŒa¦©ed
(
dev
);

1212 ià(!
šfo
->
tû_¥aû
 && !
Œª¦©e_em±y_¦Ùs
)

1215 
»t
 = 
	`ÿlg¬y_š™_Úe
(
dev
);

1216 ià(
»t
)

1217 
”rÜ
;

1220 
dev
 = 
NULL
;

1221 
	`fÜ_—ch_pci_dev
(
dev
) {

1222 
iommu_bË
 *
tbl
;

1224 
tbl
 = 
	`fšd_iommu_bË
(&
dev
->dev);

1226 ià(
	`Œª¦©iÚ_’abËd
(
tbl
))

1227 
dev
->dev.
¬chd©a
.
dma_İs
 = &
ÿlg¬y_dma_İs
;

1230  
»t
;

1232 
”rÜ
:

1234 
dev
 = 
	`pci_g‘_deviû
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1235 ià(!
dev
)

1237 ià(!
	`is_ÿl_pci_dev
(
dev
->
deviû
))

1240 
šfo
 = &
bus_šfo
[
dev
->
bus
->
numb”
];

1241 ià(
šfo
->
Œª¦©iÚ_di§bËd
) {

1242 
	`pci_dev_put
(
dev
);

1245 ià(!
šfo
->
tû_¥aû
 && !
Œª¦©e_em±y_¦Ùs
)

1248 
	`ÿlg¬y_di§bË_Œª¦©iÚ
(
dev
);

1249 
	`ÿlg¬y_ä“_bus
(
dev
);

1250 
	`pci_dev_put
(
dev
);

1251 
dev
->dev.
¬chd©a
.
dma_İs
 = 
NULL
;

1254  
»t
;

1255 
	}
}

1257 
šlše
 
__š™
 
	$d‘”mše_tû_bË_size
(
u64
 
¿m
)

1259 
»t
;

1261 ià(
¥ecif›d_bË_size
 !ğ
TCE_TABLE_SIZE_UNSPECIFIED
)

1262  
¥ecif›d_bË_size
;

1271 
»t
 = 
	`g‘_Üd”
(
¿m
 >> 13);

1272 ià(
»t
 > 
TCE_TABLE_SIZE_8M
)

1273 
»t
 = 
TCE_TABLE_SIZE_8M
;

1275  
»t
;

1276 
	}
}

1278 
__š™
 
	$bud_d‘a_¬¿ys
()

1280 
±r
;

1281 
numnodes
, 
i
;

1282 
sÿl_d‘a_size
, 
rio_d‘a_size
;

1284 
numnodes
 = 
rio_bË_hdr
->
num_sÿl_dev
;

1285 ià(
numnodes
 > 
MAX_NUMNODES
){

1286 
	`´štk
(
KERN_WARNING


1289 
MAX_NUMNODES
, 
numnodes
);

1290  -
ENODEV
;

1293 
rio_bË_hdr
->
v”siÚ
){

1295 
sÿl_d‘a_size
 = 11;

1296 
rio_d‘a_size
 = 13;

1299 
sÿl_d‘a_size
 = 12;

1300 
rio_d‘a_size
 = 15;

1303 
	`´štk
(
KERN_WARNING


1305 
rio_bË_hdr
->
v”siÚ
);

1306  -
EPROTO
;

1309 
±r
 = (()
rio_bË_hdr
) + 3;

1310 
i
 = 0; i < 
numnodes
; i++, 
±r
 +ğ
sÿl_d‘a_size
)

1311 
sÿl_devs
[
i
] = (
sÿl_d‘a
 *)
±r
;

1313 
i
 = 0; i < 
rio_bË_hdr
->
num_rio_dev
;

1314 
i
++, 
±r
 +ğ
rio_d‘a_size
)

1315 
rio_devs
[
i
] = (
rio_d‘a
 *)
±r
;

1318 
	}
}

1320 
__š™
 
	$ÿlg¬y_bus_has_deviûs
(
bus
, 
pci_dev
)

1322 
dev
;

1323 
u32
 
v®
;

1325 ià(
pci_dev
 =ğ
PCI_DEVICE_ID_IBM_CALIOC2
) {

1333 
dev
 = 1; dev < 8; dev++) {

1334 
v®
 = 
	`»ad_pci_cÚfig
(
bus
, 
dev
, 0, 0);

1335 ià(
v®
 != 0xffffffff)

1338  (
v®
 != 0xffffffff);

1339 
	}
}

1346 
	$ÿlg¬y_š™_b™m­_äom_tû_bË
(
iommu_bË
 *
tbl
)

1348 
u64
 *

;

1349 
šdex
;

1350 

 = ((
u64
 *)
tbl
->
™_ba£
);

1351 
šdex
 = 0 ; index < 
tbl
->
™_size
; index++) {

1352 ià(*

 != 0x0)

1353 
	`£t_b™
(
šdex
, 
tbl
->
™_m­
);

1354 

++;

1356 
	}
}

1363 
__š™
 
	$g‘_tû_¥aû_äom_r
()

1365 
bus
;

1366 
__iomem
 *
rg‘
;

1367 
tû_¥aû
;

1369 
bus
 = 0; bu < 
MAX_PHB_BUS_NUM
; bus++) {

1370 
ÿlg¬y_bus_šfo
 *
šfo
 = &
bus_šfo
[
bus
];

1371 
pci_deviû
;

1372 
u32
 
v®
;

1374 
v®
 = 
	`»ad_pci_cÚfig
(
bus
, 0, 0, 0);

1375 
pci_deviû
 = (
v®
 & 0xFFFF0000) >> 16;

1377 ià(!
	`is_ÿl_pci_dev
(
pci_deviû
))

1379 ià(
šfo
->
Œª¦©iÚ_di§bËd
)

1382 ià(
	`ÿlg¬y_bus_has_deviûs
(
bus
, 
pci_deviû
) ||

1383 
Œª¦©e_em±y_¦Ùs
) {

1384 
rg‘
 = 
	`ÿlg¬y_»g
(
bus_šfo
[
bus
].
bb¬
,

1385 
	`r_off£t
(
bus
));

1386 
tû_¥aû
 = 
	`be64_to_ıu
(
	`»adq
(
rg‘
));

1387 
tû_¥aû
 =û_¥aû & 
TAR_SW_BITS
;

1389 
tû_¥aû
 =û_¥aû & (~
¥ecif›d_bË_size
);

1390 
šfo
->
tû_¥aû
 = (
u64
 *)
	`__va
(tce_space);

1394 
	}
}

1396 
__š™
 
	$d‘eù_ÿlg¬y
()

1398 
bus
;

1399 *
tbl
;

1400 
ÿlg¬y_found
 = 0;

1401 
±r
;

1402 
off£t
, 
´ev_off£t
;

1403 
»t
;

1409 ià(
swiÙlb
 || 
no_iommu
 || 
iommu_d‘eùed
)

1412 ià(!
u£_ÿlg¬y
)

1415 ià(!
	`—¾y_pci_®lowed
())

1418 
	`´štk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDA‡rea\n");

1420 
±r
 = ()
	`phys_to_vœt
(
	`g‘_bios_ebda
());

1422 
rio_bË_hdr
 = 
NULL
;

1423 
´ev_off£t
 = 0;

1424 
off£t
 = 0x180;

1429 
off£t
 > 
´ev_off£t
) {

1431 ià(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1433 
rio_bË_hdr
 = (rio_bË_hd¸*)(
±r
 + 
off£t
 + 4);

1436 
´ev_off£t
 = 
off£t
;

1437 
off£t
 = *((*)(
±r
 + offset));

1439 ià(!
rio_bË_hdr
) {

1440 
	`´štk
(
KERN_DEBUG
 "Calgary: Unableo†ocate Rio Grandeable "

1445 
»t
 = 
	`bud_d‘a_¬¿ys
();

1446 ià(
»t
) {

1447 
	`´štk
(
KERN_DEBUG
 "C®g¬y: bud_d‘a_¬¿y »ˆ%d\n", 
»t
);

1451 
¥ecif›d_bË_size
 = 
	`d‘”mše_tû_bË_size
((
	`is_kdump_k”Ãl
() ?

1452 
§ved_max_pâ
 : 
max_pâ
è* 
PAGE_SIZE
);

1454 
bus
 = 0; bu < 
MAX_PHB_BUS_NUM
; bus++) {

1455 
ÿlg¬y_bus_šfo
 *
šfo
 = &
bus_šfo
[
bus
];

1456 
pci_deviû
;

1457 
u32
 
v®
;

1459 
v®
 = 
	`»ad_pci_cÚfig
(
bus
, 0, 0, 0);

1460 
pci_deviû
 = (
v®
 & 0xFFFF0000) >> 16;

1462 ià(!
	`is_ÿl_pci_dev
(
pci_deviû
))

1465 ià(
šfo
->
Œª¦©iÚ_di§bËd
)

1468 ià(
	`ÿlg¬y_bus_has_deviûs
(
bus
, 
pci_deviû
) ||

1469 
Œª¦©e_em±y_¦Ùs
) {

1474 ià(!
	`is_kdump_k”Ãl
()) {

1475 
tbl
 = 
	`®loc_tû_bË
();

1476 ià(!
tbl
)

1477 
ş—nup
;

1478 
šfo
->
tû_¥aû
 = 
tbl
;

1480 
ÿlg¬y_found
 = 1;

1484 
	`´štk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1485 
ÿlg¬y_found
 ? "found" : "not found");

1487 ià(
ÿlg¬y_found
) {

1488 
iommu_d‘eùed
 = 1;

1489 
ÿlg¬y_d‘eùed
 = 1;

1490 
	`´štk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1491 
	`´štk
(
KERN_INFO
 "PCI-DMA: Calgary TCEable spec is %d, "

1492 "CONFIG_IOMMU_DEBUG i %s.\n", 
¥ecif›d_bË_size
,

1493 
debuggšg
 ? "enabled" : "disabled");

1496 ià(
max_pâ
 > 
MAX_DMA32_PFN
)

1497 
swiÙlb
 = 1;

1501 
ş—nup
:

1502 --
bus
; bus >= 0; --bus) {

1503 
ÿlg¬y_bus_šfo
 *
šfo
 = &
bus_šfo
[
bus
];

1505 ià(
šfo
->
tû_¥aû
)

1506 
	`ä“_tû_bË
(
šfo
->
tû_¥aû
);

1508 
	}
}

1510 
__š™
 
	$ÿlg¬y_iommu_š™
()

1512 
»t
;

1514 ià(
no_iommu
 || (
swiÙlb
 && !
ÿlg¬y_d‘eùed
))

1515  -
ENODEV
;

1517 ià(!
ÿlg¬y_d‘eùed
)

1518  -
ENODEV
;

1521 
	`´štk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1523 
»t
 = 
	`ÿlg¬y_š™
();

1524 ià(
»t
) {

1525 
	`´štk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1526 "çÎšg backØno_iommu\n", 
»t
);

1527  
»t
;

1530 
fÜû_iommu
 = 1;

1531 
bad_dma_add»ss
 = 0x0;

1533 ià(!
dma_İs
)

1534 
dma_İs
 = &
nommu_dma_İs
;

1537 
	}
}

1539 
__š™
 
	$ÿlg¬y_·r£_İtiÚs
(*
p
)

1541 
bridge
;

1542 
size_t
 
Ën
;

1543 * 
’dp
;

1545 *
p
) {

1546 ià(!
	`¡ºcmp
(
p
, "64k", 3))

1547 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_64K
;

1548 ià(!
	`¡ºcmp
(
p
, "128k", 4))

1549 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_128K
;

1550 ià(!
	`¡ºcmp
(
p
, "256k", 4))

1551 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_256K
;

1552 ià(!
	`¡ºcmp
(
p
, "512k", 4))

1553 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_512K
;

1554 ià(!
	`¡ºcmp
(
p
, "1M", 2))

1555 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_1M
;

1556 ià(!
	`¡ºcmp
(
p
, "2M", 2))

1557 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_2M
;

1558 ià(!
	`¡ºcmp
(
p
, "4M", 2))

1559 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_4M
;

1560 ià(!
	`¡ºcmp
(
p
, "8M", 2))

1561 
¥ecif›d_bË_size
 = 
TCE_TABLE_SIZE_8M
;

1563 
Ën
 = 
	`¡¾’
("translate_empty_slots");

1564 ià(!
	`¡ºcmp
(
p
, "Œª¦©e_em±y_¦Ùs", 
Ën
))

1565 
Œª¦©e_em±y_¦Ùs
 = 1;

1567 
Ën
 = 
	`¡¾’
("disable");

1568 ià(!
	`¡ºcmp
(
p
, "di§bË", 
Ën
)) {

1569 
p
 +ğ
Ën
;

1570 ià(*
p
 == '=')

1571 ++
p
;

1572 ià(*
p
 == '\0')

1574 
bridge
 = 
	`sim¶e_¡¹oul
(
p
, &
’dp
, 0);

1575 ià(
p
 =ğ
’dp
)

1578 ià(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1579 
	`´štk
(
KERN_INFO
 "Calgary: disabling "

1580 "Œª¦©iÚ fÜ PHB %#x\n", 
bridge
);

1581 
bus_šfo
[
bridge
].
Œª¦©iÚ_di§bËd
 = 1;

1585 
p
 = 
	`¡½brk
(p, ",");

1586 ià(!
p
)

1589 
p
++;

1592 
	}
}

1593 
__£tup
("ÿlg¬y=", 
ÿlg¬y_·r£_İtiÚs
);

1595 
__š™
 
	$ÿlg¬y_fixup_Úe_tû_¥aû
(
pci_dev
 *
dev
)

1597 
iommu_bË
 *
tbl
;

1598 
Åages
;

1599 
i
;

1601 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1603 
i
 = 0; i < 4; i++) {

1604 
»sourû
 *
r
 = &
dev
->»sourû[
PCI_BRIDGE_RESOURCES
 + 
i
];

1607 ià(!(
r
->
æags
 & 
IORESOURCE_MEM
))

1611 ià(!
r
->
¡¬t
)

1615 
Åages
 = (
r
->
’d
 -„->
¡¬t
è>> 
PAGE_SHIFT
;

1616 
Åages
++;

1618 
	`iommu_¿nge_»£rve
(
tbl
, 
r
->
¡¬t
, 
Åages
);

1620 
	}
}

1622 
__š™
 
	$ÿlg¬y_fixup_tû_¥aûs
()

1624 
pci_dev
 *
dev
 = 
NULL
;

1625 
ÿlg¬y_bus_šfo
 *
šfo
;

1627 ià(
no_iommu
 || 
swiÙlb
 || !
ÿlg¬y_d‘eùed
)

1628  -
ENODEV
;

1630 
	`´štk
(
KERN_DEBUG
 "Calgary: fixing upce spaces\n");

1633 
dev
 = 
	`pci_g‘_deviû
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1634 ià(!
dev
)

1636 ià(!
	`is_ÿl_pci_dev
(
dev
->
deviû
))

1639 
šfo
 = &
bus_šfo
[
dev
->
bus
->
numb”
];

1640 ià(
šfo
->
Œª¦©iÚ_di§bËd
)

1643 ià(!
šfo
->
tû_¥aû
)

1646 
	`ÿlg¬y_fixup_Úe_tû_¥aû
(
dev
);

1651 
	}
}

1657 
roÙfs_š™ÿÎ
(
ÿlg¬y_fixup_tû_¥aûs
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<lšux/dma-m­pšg.h
>

2 
	~<lšux/dma-debug.h
>

3 
	~<lšux/dm¬.h
>

4 
	~<lšux/boÙmem.h
>

5 
	~<lšux/pci.h
>

7 
	~<asm/´Ùo.h
>

8 
	~<asm/dma.h
>

9 
	~<asm/iommu.h
>

10 
	~<asm/g¬t.h
>

11 
	~<asm/ÿlg¬y.h
>

12 
	~<asm/amd_iommu.h
>

14 
fÜbid_dac
 
	g__»ad_mo¡ly
;

16 
dma_m­_İs
 *
	gdma_İs
;

17 
EXPORT_SYMBOL
(
dma_İs
);

19 
iommu_§c_fÜû
 
	g__»ad_mo¡ly
;

21 #ifdeà
CONFIG_IOMMU_DEBUG


22 
·nic_Ú_ov”æow
 
	g__»ad_mo¡ly
 = 1;

23 
fÜû_iommu
 
	g__»ad_mo¡ly
 = 1;

25 
·nic_Ú_ov”æow
 
	g__»ad_mo¡ly
 = 0;

26 
fÜû_iommu
 
	g__»ad_mo¡ly
 = 0;

29 
iommu_m”ge
 
	g__»ad_mo¡ly
 = 0;

31 
no_iommu
 
	g__»ad_mo¡ly
;

33 
iommu_d‘eùed
 
	g__»ad_mo¡ly
 = 0;

35 
dma_addr_t
 
bad_dma_add»ss
 
	g__»ad_mo¡ly
 = 0;

36 
EXPORT_SYMBOL
(
bad_dma_add»ss
);

41 
deviû
 
	gx86_dma_çÎback_dev
 = {

42 .
š™_Çme
 = "fallback device",

43 .
	gcoh”’t_dma_mask
 = 
DMA_BIT_MASK
(32),

44 .
	gdma_mask
 = &
x86_dma_çÎback_dev
.
coh”’t_dma_mask
,

46 
EXPORT_SYMBOL
(
x86_dma_çÎback_dev
);

49 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

51 
	$dma_£t_mask
(
deviû
 *
dev
, 
u64
 
mask
)

53 ià(!
dev
->
dma_mask
 || !
	`dma_suµÜ‹d
(dev, 
mask
))

54  -
EIO
;

56 *
dev
->
dma_mask
 = 
mask
;

59 
	}
}

60 
EXPORT_SYMBOL
(
dma_£t_mask
);

62 #ifdeà
CONFIG_X86_64


63 
__š™d©a
 *
	gdma32_boÙmem_±r
;

64 
dma32_boÙmem_size
 
	g__š™d©a
 = (128ULL<<20);

66 
__š™
 
	$·r£_dma32_size_İt
(*
p
)

68 ià(!
p
)

69  -
EINVAL
;

70 
dma32_boÙmem_size
 = 
	`mem·r£
(
p
, &p);

72 
	}
}

73 
—¾y_·¿m
("dma32_size", 
·r£_dma32_size_İt
);

75 
__š™
 
	$dma32_»£rve_boÙmem
()

77 
size
, 
®ign
;

78 ià(
max_pâ
 <ğ
MAX_DMA32_PFN
)

85 
®ign
 = 64ULL<<20;

86 
size
 = 
	`roundup
(
dma32_boÙmem_size
, 
®ign
);

87 
dma32_boÙmem_±r
 = 
	`__®loc_boÙmem_nİªic
(
size
, 
®ign
,

89 ià(
dma32_boÙmem_±r
)

90 
dma32_boÙmem_size
 = 
size
;

92 
dma32_boÙmem_size
 = 0;

93 
	}
}

94 
__š™
 
	$dma32_ä“_boÙmem
()

97 ià(
max_pâ
 <ğ
MAX_DMA32_PFN
)

100 ià(!
dma32_boÙmem_±r
)

103 
	`ä“_boÙmem
(
	`__·
(
dma32_boÙmem_±r
), 
dma32_boÙmem_size
);

105 
dma32_boÙmem_±r
 = 
NULL
;

106 
dma32_boÙmem_size
 = 0;

107 
	}
}

110 
__š™
 
	$pci_iommu_®loc
()

112 #ifdeà
CONFIG_X86_64


114 
	`dma32_ä“_boÙmem
();

121 
	`g¬t_iommu_hŞe_š™
();

123 
	`d‘eù_ÿlg¬y
();

125 
	`d‘eù_š‹l_iommu
();

127 
	`amd_iommu_d‘eù
();

129 
	`pci_swiÙlb_š™
();

130 
	}
}

132 *
	$dma_g’”ic_®loc_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

133 
dma_addr_t
 *
dma_addr
, 
gå_t
 
æag
)

135 
dma_mask
;

136 
·ge
 *page;

137 
dma_addr_t
 
addr
;

139 
dma_mask
 = 
	`dma_®loc_coh”’t_mask
(
dev
, 
æag
);

141 
æag
 |ğ
__GFP_ZERO
;

142 
agaš
:

143 
·ge
 = 
	`®loc_·ges_node
(
	`dev_to_node
(
dev
), 
æag
, 
	`g‘_Üd”
(
size
));

144 ià(!
·ge
)

145  
NULL
;

147 
addr
 = 
	`·ge_to_phys
(
·ge
);

148 ià(!
	`is_bufãr_dma_ÿ·bË
(
dma_mask
, 
addr
, 
size
)) {

149 
	`__ä“_·ges
(
·ge
, 
	`g‘_Üd”
(
size
));

151 ià(
dma_mask
 < 
	`DMA_BIT_MASK
(32è&& !(
æag
 & 
GFP_DMA
)) {

152 
æag
 = (æag & ~
GFP_DMA32
è| 
GFP_DMA
;

153 
agaš
;

156  
NULL
;

159 *
dma_addr
 = 
addr
;

160  
	`·ge_add»ss
(
·ge
);

161 
	}
}

167 
__š™
 
	$iommu_£tup
(*
p
)

169 
iommu_m”ge
 = 1;

171 ià(!
p
)

172  -
EINVAL
;

174 *
p
) {

175 ià(!
	`¡ºcmp
(
p
, "off", 3))

176 
no_iommu
 = 1;

178 ià(!
	`¡ºcmp
(
p
, "force", 5))

179 
fÜû_iommu
 = 1;

180 ià(!
	`¡ºcmp
(
p
, "noforce", 7)) {

181 
iommu_m”ge
 = 0;

182 
fÜû_iommu
 = 0;

185 ià(!
	`¡ºcmp
(
p
, "biomerge", 8)) {

186 
iommu_m”ge
 = 1;

187 
fÜû_iommu
 = 1;

189 ià(!
	`¡ºcmp
(
p
, "panic", 5))

190 
·nic_Ú_ov”æow
 = 1;

191 ià(!
	`¡ºcmp
(
p
, "nopanic", 7))

192 
·nic_Ú_ov”æow
 = 0;

193 ià(!
	`¡ºcmp
(
p
, "merge", 5)) {

194 
iommu_m”ge
 = 1;

195 
fÜû_iommu
 = 1;

197 ià(!
	`¡ºcmp
(
p
, "nomerge", 7))

198 
iommu_m”ge
 = 0;

199 ià(!
	`¡ºcmp
(
p
, "forcesac", 8))

200 
iommu_§c_fÜû
 = 1;

201 ià(!
	`¡ºcmp
(
p
, "allowdac", 8))

202 
fÜbid_dac
 = 0;

203 ià(!
	`¡ºcmp
(
p
, "nodac", 5))

204 
fÜbid_dac
 = -1;

205 ià(!
	`¡ºcmp
(
p
, "usedac", 6)) {

206 
fÜbid_dac
 = -1;

209 #ifdeà
CONFIG_SWIOTLB


210 ià(!
	`¡ºcmp
(
p
, "soft", 4))

211 
swiÙlb
 = 1;

214 
	`g¬t_·r£_İtiÚs
(
p
);

216 #ifdeà
CONFIG_CALGARY_IOMMU


217 ià(!
	`¡ºcmp
(
p
, "calgary", 7))

218 
u£_ÿlg¬y
 = 1;

221 
p
 +ğ
	`¡rc¥n
(p, ",");

222 ià(*
p
 == ',')

223 ++
p
;

226 
	}
}

227 
—¾y_·¿m
("iommu", 
iommu_£tup
);

229 
	$dma_suµÜ‹d
(
deviû
 *
dev
, 
u64
 
mask
)

231 
dma_m­_İs
 *
İs
 = 
	`g‘_dma_İs
(
dev
);

233 #ifdeà
CONFIG_PCI


234 ià(
mask
 > 0xfffffffà&& 
fÜbid_dac
 > 0) {

235 
	`dev_šfo
(
dev
, "PCI: Disallowing DAC for device\n");

240 ià(
İs
->
dma_suµÜ‹d
)

241  
İs
->
	`dma_suµÜ‹d
(
dev
, 
mask
);

246 ià(
mask
 < 
	`DMA_BIT_MASK
(24))

261 ià(
iommu_§c_fÜû
 && (
mask
 >ğ
	`DMA_BIT_MASK
(40))) {

262 
	`dev_šfo
(
dev
, "FÜû SAC w™h mask %Lx\n", 
mask
);

267 
	}
}

268 
EXPORT_SYMBOL
(
dma_suµÜ‹d
);

270 
__š™
 
	$pci_iommu_š™
()

272 
	`dma_debug_š™
(
PREALLOC_DMA_DEBUG_ENTRIES
);

274 #ifdeà
CONFIG_PCI


275 
	`dma_debug_add_bus
(&
pci_bus_ty³
);

278 
	`ÿlg¬y_iommu_š™
();

280 
	`š‹l_iommu_š™
();

282 
	`amd_iommu_š™
();

284 
	`g¬t_iommu_š™
();

286 
	`no_iommu_š™
();

288 
	}
}

290 
	$pci_iommu_shutdown
()

292 
	`g¬t_iommu_shutdown
();

293 
	}
}

295 
fs_š™ÿÎ
(
pci_iommu_š™
);

297 #ifdeà
CONFIG_PCI


300 
__devš™
 
	$vŸ_no_dac
(
pci_dev
 *
dev
)

302 ià((
dev
->
şass
 >> 8è=ğ
PCI_CLASS_BRIDGE_PCI
 && 
fÜbid_dac
 == 0) {

303 
	`dev_šfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

304 
fÜbid_dac
 = 1;

306 
	}
}

307 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vŸ_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/ùy³.h
>

16 
	~<lšux/agp_back’d.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/¥šlock.h
>

21 
	~<lšux/pci.h
>

22 
	~<lšux/moduË.h
>

23 
	~<lšux/tİŞogy.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/b™İs.h
>

26 
	~<lšux/kdebug.h
>

27 
	~<lšux/sÿ‰”li¡.h
>

28 
	~<lšux/iommu-h–³r.h
>

29 
	~<lšux/sysdev.h
>

30 
	~<lšux/io.h
>

31 
	~<asm/©omic.h
>

32 
	~<asm/mŒr.h
>

33 
	~<asm/pgbË.h
>

34 
	~<asm/´Ùo.h
>

35 
	~<asm/iommu.h
>

36 
	~<asm/g¬t.h
>

37 
	~<asm/ÿcheæush.h
>

38 
	~<asm/swiÙlb.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/k8.h
>

42 
	giommu_bus_ba£
;

43 
	giommu_size
;

44 
	giommu_·ges
;

46 
u32
 *
	giommu_g©t_ba£
;

55 
	giommu_fuÎæush
 = 1;

58 
DEFINE_SPINLOCK
(
iommu_b™m­_lock
);

60 *
	giommu_g¬t_b™m­
;

62 
u32
 
	gg¬t_unm­³d_’Œy
;

64 
	#GPTE_VALID
 1

	)

65 
	#GPTE_COHERENT
 2

	)

66 
	#GPTE_ENCODE
(
x
) \

67 (((
x
è& 0xfffff000è| (((xè>> 32è<< 4è| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

68 
	#GPTE_DECODE
(
x
è(((xè& 0xfffff000è| (((
u64
)(xè& 0xff0è<< 28))

	)

70 
	#EMERGENCY_PAGES
 32

	)

72 #ifdeà
CONFIG_AGP


73 
	#AGPEXTERN
 

	)

75 
	#AGPEXTERN


	)

79 
AGPEXTERN
 
agp_memÜy_»£rved
;

80 
AGPEXTERN
 
__u32
 *
	gagp_g©t_bË
;

82 
	gÃxt_b™
;

83 
boŞ
 
	gÃed_æush
;

85 
	$®loc_iommu
(
deviû
 *
dev
, 
size
,

86 
®ign_mask
)

88 
off£t
, 
æags
;

89 
bound¬y_size
;

90 
ba£_šdex
;

92 
ba£_šdex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_g‘_£g_bound¬y
(
dev
),

93 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

94 
bound¬y_size
 = 
	`ALIGN
(()
	`dma_g‘_£g_bound¬y
(
dev
) + 1,

95 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

97 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

98 
off£t
 = 
	`iommu_¬—_®loc
(
iommu_g¬t_b™m­
, 
iommu_·ges
, 
Ãxt_b™
,

99 
size
, 
ba£_šdex
, 
bound¬y_size
, 
®ign_mask
);

100 ià(
off£t
 == -1) {

101 
Ãed_æush
 = 
Œue
;

102 
off£t
 = 
	`iommu_¬—_®loc
(
iommu_g¬t_b™m­
, 
iommu_·ges
, 0,

103 
size
, 
ba£_šdex
, 
bound¬y_size
,

104 
®ign_mask
);

106 ià(
off£t
 != -1) {

107 
Ãxt_b™
 = 
off£t
+
size
;

108 ià(
Ãxt_b™
 >ğ
iommu_·ges
) {

109 
Ãxt_b™
 = 0;

110 
Ãed_æush
 = 
Œue
;

113 ià(
iommu_fuÎæush
)

114 
Ãed_æush
 = 
Œue
;

115 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

117  
off£t
;

118 
	}
}

120 
	$ä“_iommu
(
off£t
, 
size
)

122 
æags
;

124 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

125 
	`iommu_¬—_ä“
(
iommu_g¬t_b™m­
, 
off£t
, 
size
);

126 ià(
off£t
 >ğ
Ãxt_b™
)

127 
Ãxt_b™
 = 
off£t
 + 
size
;

128 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

129 
	}
}

134 
	$æush_g¬t
()

136 
æags
;

138 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

139 ià(
Ãed_æush
) {

140 
	`k8_æush_g¬ts
();

141 
Ãed_æush
 = 
çl£
;

143 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

144 
	}
}

146 #ifdeà
CONFIG_IOMMU_LEAK


148 
	#SET_LEAK
(
x
) \

150 ià(
iommu_Ëak_b
) \

151 
iommu_Ëak_b
[
x
] = 
	`__butš_»tuº_add»ss
(0);\

152 } 0)

	)

154 
	#CLEAR_LEAK
(
x
) \

156 ià(
iommu_Ëak_b
) \

157 
iommu_Ëak_b
[
x
] = 
NULL
; \

158 } 0)

	)

161 **
	giommu_Ëak_b
;

162 
	gËak_Œaû
;

163 
	giommu_Ëak_·ges
 = 20;

165 
	$dump_Ëak
()

167 
i
;

168 
dump
;

170 ià(
dump
 || !
iommu_Ëak_b
)

172 
dump
 = 1;

173 
	`show_¡ack
(
NULL
, NULL);

176 
	`´štk
(
KERN_DEBUG
 "Dumping %d…ages fromƒnd of IOMMU:\n",

177 
iommu_Ëak_·ges
);

178 
i
 = 0; i < 
iommu_Ëak_·ges
; i += 2) {

179 
	`´štk
(
KERN_DEBUG
 "%lu: ", 
iommu_·ges
-
i
);

180 
	`´štk_add»ss
((è
iommu_Ëak_b
[
iommu_·ges
-
i
],

182 
	`´štk
(
KERN_CONT
 "%c", (
i
+1)%2 == 0 ? '\n' : ' ');

184 
	`´štk
(
KERN_DEBUG
 "\n");

185 
	}
}

187 
	#SET_LEAK
(
x
)

	)

188 
	#CLEAR_LEAK
(
x
)

	)

191 
	$iommu_fuÎ
(
deviû
 *
dev
, 
size_t
 
size
, 
dœ
)

203 
	`dev_”r
(
dev
, "PCI-DMA: OuˆoàIOMMU s·û fÜ %lu by‹s\n", 
size
);

205 ià(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

206 ià(
dœ
 =ğ
PCI_DMA_FROMDEVICE
 || dœ =ğ
PCI_DMA_BIDIRECTIONAL
)

207 
	`·nic
("PCI-DMA: Memory would be corrupted\n");

208 ià(
dœ
 =ğ
PCI_DMA_TODEVICE
 || dœ =ğ
PCI_DMA_BIDIRECTIONAL
)

209 
	`·nic
(
KERN_ERR


212 #ifdeà
CONFIG_IOMMU_LEAK


213 
	`dump_Ëak
();

215 
	}
}

217 
šlše
 

218 
	$Ãed_iommu
(
deviû
 *
dev
, 
addr
, 
size_t
 
size
)

220  
fÜû_iommu
 ||

221 !
	`is_bufãr_dma_ÿ·bË
(*
dev
->
dma_mask
, 
addr
, 
size
);

222 
	}
}

224 
šlše
 

225 
	$nÚfÜûd_iommu
(
deviû
 *
dev
, 
addr
, 
size_t
 
size
)

227  !
	`is_bufãr_dma_ÿ·bË
(*
dev
->
dma_mask
, 
addr
, 
size
);

228 
	}
}

233 
dma_addr_t
 
	$dma_m­_¬—
(
deviû
 *
dev
, 
dma_addr_t
 
phys_mem
,

234 
size_t
 
size
, 
dœ
, 
®ign_mask
)

236 
Åages
 = 
	`iommu_num_·ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

237 
iommu_·ge
 = 
	`®loc_iommu
(
dev
, 
Åages
, 
®ign_mask
);

238 
i
;

240 ià(
iommu_·ge
 == -1) {

241 ià(!
	`nÚfÜûd_iommu
(
dev
, 
phys_mem
, 
size
))

242  
phys_mem
;

243 ià(
·nic_Ú_ov”æow
)

244 
	`·nic
("dma_m­_¬— ov”æow %lu by‹s\n", 
size
);

245 
	`iommu_fuÎ
(
dev
, 
size
, 
dœ
);

246  
bad_dma_add»ss
;

249 
i
 = 0; i < 
Åages
; i++) {

250 
iommu_g©t_ba£
[
iommu_·ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

251 
	`SET_LEAK
(
iommu_·ge
 + 
i
);

252 
phys_mem
 +ğ
PAGE_SIZE
;

254  
iommu_bus_ba£
 + 
iommu_·ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

255 
	}
}

258 
dma_addr_t
 
	$g¬t_m­_·ge
(
deviû
 *
dev
, 
·ge
 *page,

259 
off£t
, 
size_t
 
size
,

260 
dma_d©a_dœeùiÚ
 
dœ
,

261 
dma_©Œs
 *
©Œs
)

263 
bus
;

264 
phys_addr_t
 
·ddr
 = 
	`·ge_to_phys
(
·ge
è+ 
off£t
;

266 ià(!
dev
)

267 
dev
 = &
x86_dma_çÎback_dev
;

269 ià(!
	`Ãed_iommu
(
dev
, 
·ddr
, 
size
))

270  
·ddr
;

272 
bus
 = 
	`dma_m­_¬—
(
dev
, 
·ddr
, 
size
, 
dœ
, 0);

273 
	`æush_g¬t
();

275  
bus
;

276 
	}
}

281 
	$g¬t_unm­_·ge
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
,

282 
size_t
 
size
, 
dma_d©a_dœeùiÚ
 
dœ
,

283 
dma_©Œs
 *
©Œs
)

285 
iommu_·ge
;

286 
Åages
;

287 
i
;

289 ià(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

290 
dma_addr
 >ğ
iommu_bus_ba£
 + 
iommu_size
)

293 
iommu_·ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

294 
Åages
 = 
	`iommu_num_·ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

295 
i
 = 0; i < 
Åages
; i++) {

296 
iommu_g©t_ba£
[
iommu_·ge
 + 
i
] = 
g¬t_unm­³d_’Œy
;

297 
	`CLEAR_LEAK
(
iommu_·ge
 + 
i
);

299 
	`ä“_iommu
(
iommu_·ge
, 
Åages
);

300 
	}
}

305 
	$g¬t_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

306 
dma_d©a_dœeùiÚ
 
dœ
, 
dma_©Œs
 *
©Œs
)

308 
sÿ‰”li¡
 *
s
;

309 
i
;

311 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

312 ià(!
s
->
dma_Ëngth
 || !s->
Ëngth
)

314 
	`g¬t_unm­_·ge
(
dev
, 
s
->
dma_add»ss
, s->
dma_Ëngth
, 
dœ
, 
NULL
);

316 
	}
}

319 
	$dma_m­_sg_nÚfÜû
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
,

320 
ÃÁs
, 
dœ
)

322 
sÿ‰”li¡
 *
s
;

323 
i
;

325 #ifdeà
CONFIG_IOMMU_DEBUG


326 
	`´štk
(
KERN_DEBUG
 "dma_map_sg overflow\n");

329 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

330 
addr
 = 
	`sg_phys
(
s
);

332 ià(
	`nÚfÜûd_iommu
(
dev
, 
addr
, 
s
->
Ëngth
)) {

333 
addr
 = 
	`dma_m­_¬—
(
dev
,‡ddr, 
s
->
Ëngth
, 
dœ
, 0);

334 ià(
addr
 =ğ
bad_dma_add»ss
) {

335 ià(
i
 > 0)

336 
	`g¬t_unm­_sg
(
dev
, 
sg
, 
i
, 
dœ
, 
NULL
);

337 
ÃÁs
 = 0;

338 
sg
[0].
dma_Ëngth
 = 0;

342 
s
->
dma_add»ss
 = 
addr
;

343 
s
->
dma_Ëngth
 = s->
Ëngth
;

345 
	`æush_g¬t
();

347  
ÃÁs
;

348 
	}
}

351 
	$__dma_m­_cÚt
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
¡¬t
,

352 
ÃËms
, 
sÿ‰”li¡
 *
sout
,

353 
·ges
)

355 
iommu_¡¬t
 = 
	`®loc_iommu
(
dev
, 
·ges
, 0);

356 
iommu_·ge
 = 
iommu_¡¬t
;

357 
sÿ‰”li¡
 *
s
;

358 
i
;

360 ià(
iommu_¡¬t
 == -1)

363 
	`fÜ_—ch_sg
(
¡¬t
, 
s
, 
ÃËms
, 
i
) {

364 
·ges
, 
addr
;

365 
phys_addr
 = 
s
->
dma_add»ss
;

367 
	`BUG_ON
(
s
 !ğ
¡¬t
 && s->
off£t
);

368 ià(
s
 =ğ
¡¬t
) {

369 
sout
->
dma_add»ss
 = 
iommu_bus_ba£
;

370 
sout
->
dma_add»ss
 +ğ
iommu_·ge
*
PAGE_SIZE
 + 
s
->
off£t
;

371 
sout
->
dma_Ëngth
 = 
s
->
Ëngth
;

373 
sout
->
dma_Ëngth
 +ğ
s
->
Ëngth
;

376 
addr
 = 
phys_addr
;

377 
·ges
 = 
	`iommu_num_·ges
(
s
->
off£t
, s->
Ëngth
, 
PAGE_SIZE
);

378 
·ges
--) {

379 
iommu_g©t_ba£
[
iommu_·ge
] = 
	`GPTE_ENCODE
(
addr
);

380 
	`SET_LEAK
(
iommu_·ge
);

381 
addr
 +ğ
PAGE_SIZE
;

382 
iommu_·ge
++;

385 
	`BUG_ON
(
iommu_·ge
 - 
iommu_¡¬t
 !ğ
·ges
);

388 
	}
}

390 
šlše
 

391 
	$dma_m­_cÚt
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
¡¬t
, 
ÃËms
,

392 
sÿ‰”li¡
 *
sout
, 
·ges
, 
Ãed
)

394 ià(!
Ãed
) {

395 
	`BUG_ON
(
ÃËms
 != 1);

396 
sout
->
dma_add»ss
 = 
¡¬t
->dma_address;

397 
sout
->
dma_Ëngth
 = 
¡¬t
->
Ëngth
;

400  
	`__dma_m­_cÚt
(
dev
, 
¡¬t
, 
ÃËms
, 
sout
, 
·ges
);

401 
	}
}

407 
	$g¬t_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

408 
dma_d©a_dœeùiÚ
 
dœ
, 
dma_©Œs
 *
©Œs
)

410 
sÿ‰”li¡
 *
s
, *
ps
, *
¡¬t_sg
, *
sgm­
;

411 
Ãed
 = 0, 
ÃxŠ“d
, 
i
, 
out
, 
¡¬t
;

412 
·ges
 = 0;

413 
£g_size
;

414 
max_£g_size
;

416 ià(
ÃÁs
 == 0)

419 ià(!
dev
)

420 
dev
 = &
x86_dma_çÎback_dev
;

422 
out
 = 0;

423 
¡¬t
 = 0;

424 
¡¬t_sg
 = 
sgm­
 = 
sg
;

425 
£g_size
 = 0;

426 
max_£g_size
 = 
	`dma_g‘_max_£g_size
(
dev
);

427 
ps
 = 
NULL
;

428 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

429 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

431 
s
->
dma_add»ss
 = 
addr
;

432 
	`BUG_ON
(
s
->
Ëngth
 == 0);

434 
ÃxŠ“d
 = 
	`Ãed_iommu
(
dev
, 
addr
, 
s
->
Ëngth
);

437 ià(
i
 > 
¡¬t
) {

443 ià(!
iommu_m”ge
 || !
ÃxŠ“d
 || !
Ãed
 || 
s
->
off£t
 ||

444 (
s
->
Ëngth
 + 
£g_size
 > 
max_£g_size
) ||

445 (
ps
->
off£t
 +…s->
Ëngth
è% 
PAGE_SIZE
) {

446 ià(
	`dma_m­_cÚt
(
dev
, 
¡¬t_sg
, 
i
 - 
¡¬t
,

447 
sgm­
, 
·ges
, 
Ãed
) < 0)

448 
”rÜ
;

449 
out
++;

450 
£g_size
 = 0;

451 
sgm­
 = 
	`sg_Ãxt
(sgmap);

452 
·ges
 = 0;

453 
¡¬t
 = 
i
;

454 
¡¬t_sg
 = 
s
;

458 
£g_size
 +ğ
s
->
Ëngth
;

459 
Ãed
 = 
ÃxŠ“d
;

460 
·ges
 +ğ
	`iommu_num_·ges
(
s
->
off£t
, s->
Ëngth
, 
PAGE_SIZE
);

461 
ps
 = 
s
;

463 ià(
	`dma_m­_cÚt
(
dev
, 
¡¬t_sg
, 
i
 - 
¡¬t
, 
sgm­
, 
·ges
, 
Ãed
) < 0)

464 
”rÜ
;

465 
out
++;

466 
	`æush_g¬t
();

467 ià(
out
 < 
ÃÁs
) {

468 
sgm­
 = 
	`sg_Ãxt
(sgmap);

469 
sgm­
->
dma_Ëngth
 = 0;

471  
out
;

473 
”rÜ
:

474 
	`æush_g¬t
();

475 
	`g¬t_unm­_sg
(
dev
, 
sg
, 
out
, 
dœ
, 
NULL
);

478 ià(
fÜû_iommu
 || 
iommu_m”ge
) {

479 
out
 = 
	`dma_m­_sg_nÚfÜû
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

480 ià(
out
 > 0)

481  
out
;

483 ià(
·nic_Ú_ov”æow
)

484 
	`·nic
("dma_m­_sg: ov”æow oÀ%lu…ages\n", 
·ges
);

486 
	`iommu_fuÎ
(
dev
, 
·ges
 << 
PAGE_SHIFT
, 
dœ
);

487 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
)

488 
s
->
dma_add»ss
 = 
bad_dma_add»ss
;

490 
	}
}

494 
	$g¬t_®loc_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

495 
gå_t
 
æag
)

497 
dma_addr_t
 
·ddr
;

498 
®ign_mask
;

499 
·ge
 *page;

501 ià(
fÜû_iommu
 && !(
æag
 & 
GFP_DMA
)) {

502 
æag
 &ğ~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

503 
·ge
 = 
	`®loc_·ges
(
æag
 | 
__GFP_ZERO
, 
	`g‘_Üd”
(
size
));

504 ià(!
·ge
)

505  
NULL
;

507 
®ign_mask
 = (1UL << 
	`g‘_Üd”
(
size
)) - 1;

508 
·ddr
 = 
	`dma_m­_¬—
(
dev
, 
	`·ge_to_phys
(
·ge
), 
size
,

509 
DMA_BIDIRECTIONAL
, 
®ign_mask
);

511 
	`æush_g¬t
();

512 ià(
·ddr
 !ğ
bad_dma_add»ss
) {

513 *
dma_addr
 = 
·ddr
;

514  
	`·ge_add»ss
(
·ge
);

516 
	`__ä“_·ges
(
·ge
, 
	`g‘_Üd”
(
size
));

518  
	`dma_g’”ic_®loc_coh”’t
(
dev
, 
size
, 
dma_addr
, 
æag
);

520  
NULL
;

521 
	}
}

525 
	$g¬t_ä“_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
, *
vaddr
,

526 
dma_addr_t
 
dma_addr
)

528 
	`g¬t_unm­_·ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

529 
	`ä“_·ges
(()
vaddr
, 
	`g‘_Üd”
(
size
));

530 
	}
}

532 
	gno_agp
;

534 
__š™
 
	$check_iommu_size
(
­”
, 
u64
 
­”_size
)

536 
a
;

538 ià(!
iommu_size
) {

539 
iommu_size
 = 
­”_size
;

540 ià(!
no_agp
)

541 
iommu_size
 /= 2;

544 
a
 = 
­”
 + 
iommu_size
;

545 
iommu_size
 -ğ
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -‡;

547 ià(
iommu_size
 < 64*1024*1024) {

548 
	`´štk
(
KERN_WARNING


551 
iommu_size
 >> 20);

554  
iommu_size
;

555 
	}
}

557 
__š™
 
	$»ad_­”tu»
(
pci_dev
 *
dev
, 
u32
 *
size
)

559 
­”_size
 = 0, 
­”_ba£_32
, 
­”_Üd”
;

560 
u64
 
­”_ba£
;

562 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
­”_ba£_32
);

563 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTURECTL
, &
­”_Üd”
);

564 
­”_Üd”
 = (aper_order >> 1) & 7;

566 
­”_ba£
 = 
­”_ba£_32
 & 0x7fff;

567 
­”_ba£
 <<= 25;

569 
­”_size
 = (32 * 1024 * 1024è<< 
­”_Üd”
;

570 ià(
­”_ba£
 + 
­”_size
 > 0x100000000UL || !aper_size)

571 
­”_ba£
 = 0;

573 *
size
 = 
­”_size
;

574  
­”_ba£
;

575 
	}
}

577 
	$’abË_g¬t_Œª¦©iÚs
()

579 
i
;

581 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

582 
pci_dev
 *
dev
 = 
k8_nÜthbridges
[
i
];

584 
	`’abË_g¬t_Œª¦©iÚ
(
dev
, 
	`__·
(
agp_g©t_bË
));

586 
	}
}

592 
boŞ
 
	gfix_up_nÜth_bridges
;

593 
u32
 
	g­”tu»_Üd”
;

594 
u32
 
	g­”tu»_®loc
;

596 
	$£t_up_g¬t_»sume
(
u32
 
­”_Üd”
, u32 
­”_®loc
)

598 
fix_up_nÜth_bridges
 = 
Œue
;

599 
­”tu»_Üd”
 = 
­”_Üd”
;

600 
­”tu»_®loc
 = 
­”_®loc
;

601 
	}
}

603 
	$g¬t_»sume
(
sys_deviû
 *
dev
)

605 
	`´štk
(
KERN_INFO
 "PCI-DMA: Resuming GART IOMMU\n");

607 ià(
fix_up_nÜth_bridges
) {

608 
i
;

610 
	`´štk
(
KERN_INFO
 "PCI-DMA: Restoring GART‡perture settings\n");

612 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

613 
pci_dev
 *
dev
 = 
k8_nÜthbridges
[
i
];

619 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTURECTL
,

620 
­”tu»_Üd”
 << 1);

621 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTUREBASE
,

622 
­”tu»_®loc
 >> 25);

626 
	`’abË_g¬t_Œª¦©iÚs
();

629 
	}
}

631 
	$g¬t_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

634 
	}
}

636 
sysdev_şass
 
	gg¬t_sysdev_şass
 = {

637 .
Çme
 = "gart",

638 .
	gsu¥’d
 = 
g¬t_su¥’d
,

639 .
	g»sume
 = 
g¬t_»sume
,

643 
sys_deviû
 
	gdeviû_g¬t
 = {

644 .
id
 = 0,

645 .
	gşs
 = &
g¬t_sysdev_şass
,

652 
__š™
 
	$š™_k8_g©t
(
agp_k”n_šfo
 *
šfo
)

654 
­”_size
, 
g©t_size
, 
Ãw_­”_size
;

655 
­”_ba£
, 
Ãw_­”_ba£
;

656 
pci_dev
 *
dev
;

657 *
g©t
;

658 
i
, 
”rÜ
;

660 
	`´štk
(
KERN_INFO
 "PCI-DMA: Disabling AGP.\n");

661 
­”_size
 = 
­”_ba£
 = 
šfo
->aper_size = 0;

662 
dev
 = 
NULL
;

663 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

664 
dev
 = 
k8_nÜthbridges
[
i
];

665 
Ãw_­”_ba£
 = 
	`»ad_­”tu»
(
dev
, &
Ãw_­”_size
);

666 ià(!
Ãw_­”_ba£
)

667 
nommu
;

669 ià(!
­”_ba£
) {

670 
­”_size
 = 
Ãw_­”_size
;

671 
­”_ba£
 = 
Ãw_­”_ba£
;

673 ià(
­”_size
 !ğ
Ãw_­”_size
 || 
­”_ba£
 !ğ
Ãw_­”_ba£
)

674 
nommu
;

676 ià(!
­”_ba£
)

677 
nommu
;

678 
šfo
->
­”_ba£
 =‡per_base;

679 
šfo
->
­”_size
 =‡per_size >> 20;

681 
g©t_size
 = (
­”_size
 >> 
PAGE_SHIFT
è* (
u32
);

682 
g©t
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

683 
	`g‘_Üd”
(
g©t_size
));

684 ià(!
g©t
)

685 
	`·nic
("Cannot‡llocate GATTable");

686 ià(
	`£t_memÜy_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

687 
	`·nic
("Could‚ot set GART PTEso uncacheable…ages");

689 
agp_g©t_bË
 = 
g©t
;

691 
	`’abË_g¬t_Œª¦©iÚs
();

693 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
g¬t_sysdev_şass
);

694 ià(!
”rÜ
)

695 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_g¬t
);

696 ià(
”rÜ
)

697 
	`·nic
("Could‚ot„egister gart_sysdev -- "

700 
	`æush_g¬t
();

702 
	`´štk
(
KERN_INFO
 "PCI-DMA:‡perture base @ %x size %u KB\n",

703 
­”_ba£
, 
­”_size
>>10);

707 
nommu
:

709 
	`´štk
(
KERN_WARNING
 "PCI-DMA: Morehan 4GB of RAM‡nd‚o IOMMU\n"

710 
KERN_WARNING
 "falling backo iommu=soft.\n");

712 
	}
}

714 
dma_m­_İs
 
	gg¬t_dma_İs
 = {

715 .
m­_sg
 = 
g¬t_m­_sg
,

716 .
	gunm­_sg
 = 
g¬t_unm­_sg
,

717 .
	gm­_·ge
 = 
g¬t_m­_·ge
,

718 .
	gunm­_·ge
 = 
g¬t_unm­_·ge
,

719 .
	g®loc_coh”’t
 = 
g¬t_®loc_coh”’t
,

720 .
	gä“_coh”’t
 = 
g¬t_ä“_coh”’t
,

723 
	$g¬t_iommu_shutdown
()

725 
pci_dev
 *
dev
;

726 
i
;

728 ià(
no_agp
 && (
dma_İs
 !ğ&
g¬t_dma_İs
))

731 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

732 
u32
 
ùl
;

734 
dev
 = 
k8_nÜthbridges
[
i
];

735 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTURECTL
, &
ùl
);

737 
ùl
 &ğ~
GARTEN
;

739 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 
AMD64_GARTAPERTURECTL
, 
ùl
);

741 
	}
}

743 
__š™
 
	$g¬t_iommu_š™
()

745 
agp_k”n_šfo
 
šfo
;

746 
iommu_¡¬t
;

747 
­”_ba£
, 
­”_size
;

748 
¡¬t_pâ
, 
’d_pâ
;

749 
sü©ch
;

750 
i
;

752 ià(
	`ÿche_k8_nÜthbridges
(è< 0 || 
num_k8_nÜthbridges
 == 0)

755 #iâdeà
CONFIG_AGP_AMD64


756 
no_agp
 = 1;

760 
no_agp
 =‚o_agp ||

761 (
	`agp_amd64_š™
() < 0) ||

762 (
	`agp_cİy_šfo
(
agp_bridge
, &
šfo
) < 0);

765 ià(
swiÙlb
)

769 ià(
iommu_d‘eùed
 && !
g¬t_iommu_­”tu»
)

772 ià(
no_iommu
 ||

773 (!
fÜû_iommu
 && 
max_pâ
 <ğ
MAX_DMA32_PFN
) ||

774 !
g¬t_iommu_­”tu»
 ||

775 (
no_agp
 && 
	`š™_k8_g©t
(&
šfo
) < 0)) {

776 ià(
max_pâ
 > 
MAX_DMA32_PFN
) {

777 
	`´štk
(
KERN_WARNING
 "Morehan 4GB of memory "

779 
	`´štk
(
KERN_WARNING
 "falling backo iommu=soft.\n");

785 
­”_size
 = 
šfo
.aper_size << 20;

786 
­”_ba£
 = 
šfo
.aper_base;

787 
’d_pâ
 = (
­”_ba£
>>
PAGE_SHIFT
è+ (
­”_size
>>PAGE_SHIFT);

788 ià(
’d_pâ
 > 
max_low_pâ_m­³d
) {

789 
¡¬t_pâ
 = (
­”_ba£
>>
PAGE_SHIFT
);

790 
	`š™_memÜy_m­pšg
(
¡¬t_pâ
<<
PAGE_SHIFT
, 
’d_pâ
<<PAGE_SHIFT);

793 
	`´štk
(
KERN_INFO
 "PCI-DMA: using GART IOMMU.\n");

794 
iommu_size
 = 
	`check_iommu_size
(
šfo
.
­”_ba£
, 
­”_size
);

795 
iommu_·ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

797 
iommu_g¬t_b™m­
 = (*è
	`__g‘_ä“_·ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

798 
	`g‘_Üd”
(
iommu_·ges
/8));

799 ià(!
iommu_g¬t_b™m­
)

800 
	`·nic
("Cannot‡llocate iommu bitmap\n");

802 #ifdeà
CONFIG_IOMMU_LEAK


803 ià(
Ëak_Œaû
) {

804 
iommu_Ëak_b
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
|
__GFP_ZERO
,

805 
	`g‘_Üd”
(
iommu_·ges
*(*)));

806 ià(!
iommu_Ëak_b
)

807 
	`´štk
(
KERN_DEBUG


816 
	`iommu_¬—_»£rve
(
iommu_g¬t_b™m­
, 0, 
EMERGENCY_PAGES
);

818 
agp_memÜy_»£rved
 = 
iommu_size
;

819 
	`´štk
(
KERN_INFO


821 
iommu_size
 >> 20);

823 
iommu_¡¬t
 = 
­”_size
 - 
iommu_size
;

824 
iommu_bus_ba£
 = 
šfo
.
­”_ba£
 + 
iommu_¡¬t
;

825 
bad_dma_add»ss
 = 
iommu_bus_ba£
;

826 
iommu_g©t_ba£
 = 
agp_g©t_bË
 + (
iommu_¡¬t
>>
PAGE_SHIFT
);

837 
	`£t_memÜy_Å
(()
	`__va
(
iommu_bus_ba£
),

838 
iommu_size
 >> 
PAGE_SHIFT
);

847 
	`wbšvd
();

855 
sü©ch
 = 
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

856 ià(!
sü©ch
)

857 
	`·nic
("Cannot‡llocate iommu scratch…age");

858 
g¬t_unm­³d_’Œy
 = 
	`GPTE_ENCODE
(
	`__·
(
sü©ch
));

859 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_·ges
; i++)

860 
iommu_g©t_ba£
[
i
] = 
g¬t_unm­³d_’Œy
;

862 
	`æush_g¬t
();

863 
dma_İs
 = &
g¬t_dma_İs
;

864 
	}
}

866 
__š™
 
	$g¬t_·r£_İtiÚs
(*
p
)

868 
¬g
;

870 #ifdeà
CONFIG_IOMMU_LEAK


871 ià(!
	`¡ºcmp
(
p
, "leak", 4)) {

872 
Ëak_Œaû
 = 1;

873 
p
 += 4;

874 ià(*
p
 == '=')

875 ++
p
;

876 ià(
	`isdig™
(*
p
è&& 
	`g‘_İtiÚ
(&p, &
¬g
))

877 
iommu_Ëak_·ges
 = 
¬g
;

880 ià(
	`isdig™
(*
p
è&& 
	`g‘_İtiÚ
(&p, &
¬g
))

881 
iommu_size
 = 
¬g
;

882 ià(!
	`¡ºcmp
(
p
, "fullflush", 8))

883 
iommu_fuÎæush
 = 1;

884 ià(!
	`¡ºcmp
(
p
, "nofullflush", 11))

885 
iommu_fuÎæush
 = 0;

886 ià(!
	`¡ºcmp
(
p
, "noagp", 5))

887 
no_agp
 = 1;

888 ià(!
	`¡ºcmp
(
p
, "noaperture", 10))

889 
fix_­”tu»
 = 0;

891 ià(!
	`¡ºcmp
(
p
, "force", 5))

892 
g¬t_iommu_­”tu»_®lowed
 = 1;

893 ià(!
	`¡ºcmp
(
p
, "allowed", 7))

894 
g¬t_iommu_­”tu»_®lowed
 = 1;

895 ià(!
	`¡ºcmp
(
p
, "memaper", 7)) {

896 
çÎback_­”_fÜû
 = 1;

897 
p
 += 7;

898 ià(*
p
 == '=') {

899 ++
p
;

900 ià(
	`g‘_İtiÚ
(&
p
, &
¬g
))

901 
çÎback_­”_Üd”
 = 
¬g
;

904 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<lšux/dma-m­pšg.h
>

4 
	~<lšux/sÿ‰”li¡.h
>

5 
	~<lšux/¡ršg.h
>

6 
	~<lšux/š™.h
>

7 
	~<lšux/pci.h
>

8 
	~<lšux/mm.h
>

10 
	~<asm/´oûssÜ.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/dma.h
>

15 
	$check_addr
(*
Çme
, 
deviû
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

17 ià(
hwdev
 && !
	`is_bufãr_dma_ÿ·bË
(*hwdev->
dma_mask
, 
bus
, 
size
)) {

18 ià(*
hwdev
->
dma_mask
 >ğ
	`DMA_BIT_MASK
(32))

19 
	`´štk
(
KERN_ERR


21 
Çme
, ()
bus
, 
size
,

22 ()*
hwdev
->
dma_mask
);

26 
	}
}

28 
dma_addr_t
 
	$nommu_m­_·ge
(
deviû
 *
dev
, 
·ge
 *page,

29 
off£t
, 
size_t
 
size
,

30 
dma_d©a_dœeùiÚ
 
dœ
,

31 
dma_©Œs
 *
©Œs
)

33 
dma_addr_t
 
bus
 = 
	`·ge_to_phys
(
·ge
è+ 
off£t
;

34 
	`WARN_ON
(
size
 == 0);

35 ià(!
	`check_addr
("m­_sšgË", 
dev
, 
bus
, 
size
))

36  
bad_dma_add»ss
;

37 
	`æush_wr™e_bufãrs
();

38  
bus
;

39 
	}
}

56 
	$nommu_m­_sg
(
deviû
 *
hwdev
, 
sÿ‰”li¡
 *
sg
,

57 
ÃÁs
, 
dma_d©a_dœeùiÚ
 
dœ
,

58 
dma_©Œs
 *
©Œs
)

60 
sÿ‰”li¡
 *
s
;

61 
i
;

63 
	`WARN_ON
(
ÃÁs
 =ğ0 || 
sg
[0].
Ëngth
 == 0);

65 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

66 
	`BUG_ON
(!
	`sg_·ge
(
s
));

67 
s
->
dma_add»ss
 = 
	`sg_phys
(s);

68 ià(!
	`check_addr
("m­_sg", 
hwdev
, 
s
->
dma_add»ss
, s->
Ëngth
))

70 
s
->
dma_Ëngth
 = s->
Ëngth
;

72 
	`æush_wr™e_bufãrs
();

73  
ÃÁs
;

74 
	}
}

76 
	$nommu_ä“_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
, *
vaddr
,

77 
dma_addr_t
 
dma_addr
)

79 
	`ä“_·ges
(()
vaddr
, 
	`g‘_Üd”
(
size
));

80 
	}
}

82 
dma_m­_İs
 
	gnommu_dma_İs
 = {

83 .
®loc_coh”’t
 = 
dma_g’”ic_®loc_coh”’t
,

84 .
	gä“_coh”’t
 = 
nommu_ä“_coh”’t
,

85 .
	gm­_sg
 = 
nommu_m­_sg
,

86 .
	gm­_·ge
 = 
nommu_m­_·ge
,

87 .
	gis_phys
 = 1,

90 
__š™
 
	$no_iommu_š™
()

92 ià(
dma_İs
)

95 
fÜû_iommu
 = 0;

96 
dma_İs
 = &
nommu_dma_İs
;

97 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<lšux/pci.h
>

4 
	~<lšux/ÿche.h
>

5 
	~<lšux/moduË.h
>

6 
	~<lšux/swiÙlb.h
>

7 
	~<lšux/boÙmem.h
>

8 
	~<lšux/dma-m­pšg.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiÙlb.h
>

12 
	~<asm/dma.h
>

14 
swiÙlb
 
	g__»ad_mo¡ly
;

16 * 
__š™
 
	$swiÙlb_®loc_boÙ
(
size_t
 
size
, 
n¦abs
)

18  
	`®loc_boÙmem_low_·ges
(
size
);

19 
	}
}

21 *
	$swiÙlb_®loc
(
Üd”
, 
n¦abs
)

23  (*)
	`__g‘_ä“_·ges
(
GFP_DMA
 | 
__GFP_NOWARN
, 
Üd”
);

24 
	}
}

26 
dma_addr_t
 
	$swiÙlb_phys_to_bus
(
deviû
 *
hwdev
, 
phys_addr_t
 
·ddr
)

28  
·ddr
;

29 
	}
}

31 
phys_addr_t
 
	$swiÙlb_bus_to_phys
(
dma_addr_t
 
baddr
)

33  
baddr
;

34 
	}
}

36 
__w—k
 
	$swiÙlb_¬ch_¿nge_Ãeds_m­pšg
(
phys_addr_t
 
·ddr
, 
size_t
 
size
)

39 
	}
}

41 *
	$x86_swiÙlb_®loc_coh”’t
(
deviû
 *
hwdev
, 
size_t
 
size
,

42 
dma_addr_t
 *
dma_hªdË
, 
gå_t
 
æags
)

44 *
vaddr
;

46 
vaddr
 = 
	`dma_g’”ic_®loc_coh”’t
(
hwdev
, 
size
, 
dma_hªdË
, 
æags
);

47 ià(
vaddr
)

48  
vaddr
;

50  
	`swiÙlb_®loc_coh”’t
(
hwdev
, 
size
, 
dma_hªdË
, 
æags
);

51 
	}
}

53 
dma_m­_İs
 
	gswiÙlb_dma_İs
 = {

54 .
m­pšg_”rÜ
 = 
swiÙlb_dma_m­pšg_”rÜ
,

55 .
	g®loc_coh”’t
 = 
x86_swiÙlb_®loc_coh”’t
,

56 .
	gä“_coh”’t
 = 
swiÙlb_ä“_coh”’t
,

57 .
	gsync_sšgË_fÜ_ıu
 = 
swiÙlb_sync_sšgË_fÜ_ıu
,

58 .
	gsync_sšgË_fÜ_deviû
 = 
swiÙlb_sync_sšgË_fÜ_deviû
,

59 .
	gsync_sšgË_¿nge_fÜ_ıu
 = 
swiÙlb_sync_sšgË_¿nge_fÜ_ıu
,

60 .
	gsync_sšgË_¿nge_fÜ_deviû
 = 
swiÙlb_sync_sšgË_¿nge_fÜ_deviû
,

61 .
	gsync_sg_fÜ_ıu
 = 
swiÙlb_sync_sg_fÜ_ıu
,

62 .
	gsync_sg_fÜ_deviû
 = 
swiÙlb_sync_sg_fÜ_deviû
,

63 .
	gm­_sg
 = 
swiÙlb_m­_sg_©Œs
,

64 .
	gunm­_sg
 = 
swiÙlb_unm­_sg_©Œs
,

65 .
	gm­_·ge
 = 
swiÙlb_m­_·ge
,

66 .
	gunm­_·ge
 = 
swiÙlb_unm­_·ge
,

67 .
	gdma_suµÜ‹d
 = 
NULL
,

70 
__š™
 
	$pci_swiÙlb_š™
()

73 #ifdeà
CONFIG_X86_64


74 ià(!
iommu_d‘eùed
 && !
no_iommu
 && 
max_pâ
 > 
MAX_DMA32_PFN
)

75 
swiÙlb
 = 1;

77 ià(
swiÙlb_fÜû
)

78 
swiÙlb
 = 1;

79 ià(
swiÙlb
) {

80 
	`´štk
(
KERN_INFO
 "PCI-DMA: Using software bounce buffering for IO (SWIOTLB)\n");

81 
	`swiÙlb_š™
();

82 
dma_İs
 = &
swiÙlb_dma_İs
;

84 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<lšux/¶©fÜm_deviû.h
>

2 
	~<lšux/”r.h
>

3 
	~<lšux/š™.h
>

5 
__š™
 
	$add_pc¥kr
()

7 
¶©fÜm_deviû
 *
pd
;

9 
pd
 = 
	`¶©fÜm_deviû_»gi¡”_sim¶e
("pc¥kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
è? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
deviû_š™ÿÎ
(
add_pc¥kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<lšux/jiff›s.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/time.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/ıumask.h
>

22 
	~<lšux/aıi_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/´Ùo.h
>

26 
	~<asm/m¤.h
>

27 
	~<asm/vsysÿÎ.h
>

29 
šlše
 
u32
 
	$cyc2us
(
u32
 
cyşes
)

38 
cyşes
 *= 286;

39  (
cyşes
 >> 10);

40 
	}
}

42 
	$pmtim”_wa™_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`šl
(
pmtmr_iİÜt
è& 
ACPI_PM_MASK
;

46 
a
 =ğ
b
;

47 
b
 = 
	`šl
(
pmtmr_iİÜt
è& 
ACPI_PM_MASK
)

48 
	`ıu_»Ïx
();

49  
b
;

50 
	}
}

53 
	$pmtim”_wa™
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtim”_wa™_tick
();

58 
b
 = 
	`šl
(
pmtmr_iİÜt
);

59 
	`ıu_»Ïx
();

60 } 
	`cyc2us
(
b
 - 
a
è< 
us
);

61 
	}
}

63 
__š™
 
	$nİmtim”_£tup
(*
s
)

65 
pmtmr_iİÜt
 = 0;

67 
	}
}

69 
__£tup
("nİmtim”", 
nİmtim”_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<lšux/”ºo.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/mm.h
>

4 
	~<lšux/smp.h
>

5 
	~<lšux/´ùl.h
>

6 
	~<lšux/¦ab.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/moduË.h
>

9 
	~<lšux/pm.h
>

10 
	~<lšux/şockchs.h
>

11 
	~<Œaû/pow”.h
>

12 
	~<asm/sy¡em.h
>

13 
	~<asm/­ic.h
>

14 
	~<asm/idË.h
>

15 
	~<asm/uacûss.h
>

16 
	~<asm/i387.h
>

18 
	gidË_h®t
;

19 
EXPORT_SYMBOL
(
idË_h®t
);

20 
	gidË_nomwa™
;

21 
EXPORT_SYMBOL
(
idË_nomwa™
);

23 
kmem_ÿche
 *
	gsk_x¡©e_ÿch•
;

25 
DEFINE_TRACE
(
pow”_¡¬t
);

26 
DEFINE_TRACE
(
pow”_’d
);

28 
	$¬ch_dup_sk_¡ruù
(
sk_¡ruù
 *
d¡
, sk_¡ruù *
¤c
)

30 *
d¡
 = *
¤c
;

31 ià(
¤c
->
th»ad
.
x¡©e
) {

32 
d¡
->
th»ad
.
x¡©e
 = 
	`kmem_ÿche_®loc
(
sk_x¡©e_ÿch•
,

33 
GFP_KERNEL
);

34 ià(!
d¡
->
th»ad
.
x¡©e
)

35  -
ENOMEM
;

36 
	`WARN_ON
(()
d¡
->
th»ad
.
x¡©e
 & 15);

37 
	`memıy
(
d¡
->
th»ad
.
x¡©e
, 
¤c
->th»ad.x¡©e, 
x¡©e_size
);

40 
	}
}

42 
	$ä“_th»ad_x¡©e
(
sk_¡ruù
 *
tsk
)

44 ià(
tsk
->
th»ad
.
x¡©e
) {

45 
	`kmem_ÿche_ä“
(
sk_x¡©e_ÿch•
, 
tsk
->
th»ad
.
x¡©e
);

46 
tsk
->
th»ad
.
x¡©e
 = 
NULL
;

48 
	}
}

50 
	$ä“_th»ad_šfo
(
th»ad_šfo
 *
ti
)

52 
	`ä“_th»ad_x¡©e
(
ti
->
sk
);

53 
	`ä“_·ges
(()
ti
, 
	`g‘_Üd”
(
THREAD_SIZE
));

54 
	}
}

56 
	$¬ch_sk_ÿche_š™
()

58 
sk_x¡©e_ÿch•
 =

59 
	`kmem_ÿche_ü—‹
("sk_x¡©e", 
x¡©e_size
,

60 
	`__®ignof__
(
th»ad_x¡©e
),

61 
SLAB_PANIC
, 
NULL
);

62 
	}
}

67 
	$ex™_th»ad
()

69 
sk_¡ruù
 *
me
 = 
cu¼’t
;

70 
th»ad_¡ruù
 *
t
 = &
me
->
th»ad
;

71 *
bp
 = 
t
->
io_b™m­_±r
;

73 ià(
bp
) {

74 
tss_¡ruù
 *
tss
 = &
	`³r_ıu
(
š™_tss
, 
	`g‘_ıu
());

76 
t
->
io_b™m­_±r
 = 
NULL
;

77 
	`ş—r_th»ad_æag
(
TIF_IO_BITMAP
);

81 
	`mem£t
(
tss
->
io_b™m­
, 0xff, 
t
->
io_b™m­_max
);

82 
t
->
io_b™m­_max
 = 0;

83 
	`put_ıu
();

84 
	`kä“
(
bp
);

87 
	`ds_ex™_th»ad
(
cu¼’t
);

88 
	}
}

90 
	$æush_th»ad
()

92 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

94 #ifdeà
CONFIG_X86_64


95 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_ABI_PENDING
)) {

96 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_ABI_PENDING
);

97 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
)) {

98 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
);

100 
	`£t_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
);

101 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_COMPAT
;

106 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_DEBUG
);

108 
tsk
->
th»ad
.
debug»g0
 = 0;

109 
tsk
->
th»ad
.
debug»g1
 = 0;

110 
tsk
->
th»ad
.
debug»g2
 = 0;

111 
tsk
->
th»ad
.
debug»g3
 = 0;

112 
tsk
->
th»ad
.
debug»g6
 = 0;

113 
tsk
->
th»ad
.
debug»g7
 = 0;

114 
	`mem£t
(
tsk
->
th»ad
.
s_¬¿y
, 0, (tsk->thread.tls_array));

118 
tsk
->
åu_couÁ”
 = 0;

119 
	`ş—r_åu
(
tsk
);

120 
	`ş—r_u£d_m©h
();

121 
	}
}

123 
	$h¬d_di§bË_TSC
()

125 
	`wr™e_ü4
(
	`»ad_ü4
(è| 
X86_CR4_TSD
);

126 
	}
}

128 
	$di§bË_TSC
()

130 
	`´“m±_di§bË
();

131 ià(!
	`‹¡_ªd_£t_th»ad_æag
(
TIF_NOTSC
))

136 
	`h¬d_di§bË_TSC
();

137 
	`´“m±_’abË
();

138 
	}
}

140 
	$h¬d_’abË_TSC
()

142 
	`wr™e_ü4
(
	`»ad_ü4
(è& ~
X86_CR4_TSD
);

143 
	}
}

145 
	$’abË_TSC
()

147 
	`´“m±_di§bË
();

148 ià(
	`‹¡_ªd_ş—r_th»ad_æag
(
TIF_NOTSC
))

153 
	`h¬d_’abË_TSC
();

154 
	`´“m±_’abË
();

155 
	}
}

157 
	$g‘_tsc_mode
(
adr
)

159 
v®
;

161 ià(
	`‹¡_th»ad_æag
(
TIF_NOTSC
))

162 
v®
 = 
PR_TSC_SIGSEGV
;

164 
v®
 = 
PR_TSC_ENABLE
;

166  
	`put_u£r
(
v®
, (
__u£r
 *)
adr
);

167 
	}
}

169 
	$£t_tsc_mode
(
v®
)

171 ià(
v®
 =ğ
PR_TSC_SIGSEGV
)

172 
	`di§bË_TSC
();

173 ià(
v®
 =ğ
PR_TSC_ENABLE
)

174 
	`’abË_TSC
();

176  -
EINVAL
;

179 
	}
}

181 
	$__sw™ch_to_xŒa
(
sk_¡ruù
 *
´ev_p
, sk_¡ruù *
Ãxt_p
,

182 
tss_¡ruù
 *
tss
)

184 
th»ad_¡ruù
 *
´ev
, *
Ãxt
;

186 
´ev
 = &
´ev_p
->
th»ad
;

187 
Ãxt
 = &
Ãxt_p
->
th»ad
;

189 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_DS_AREA_MSR
) ||

190 
	`‹¡_tsk_th»ad_æag
(
´ev_p
, 
TIF_DS_AREA_MSR
))

191 
	`ds_sw™ch_to
(
´ev_p
, 
Ãxt_p
);

192 ià(
Ãxt
->
debugùlm¤
 !ğ
´ev
->debugctlmsr)

193 
	`upd©e_debugùlm¤
(
Ãxt
->
debugùlm¤
);

195 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_DEBUG
)) {

196 
	`£t_debug»g
(
Ãxt
->
debug»g0
, 0);

197 
	`£t_debug»g
(
Ãxt
->
debug»g1
, 1);

198 
	`£t_debug»g
(
Ãxt
->
debug»g2
, 2);

199 
	`£t_debug»g
(
Ãxt
->
debug»g3
, 3);

201 
	`£t_debug»g
(
Ãxt
->
debug»g6
, 6);

202 
	`£t_debug»g
(
Ãxt
->
debug»g7
, 7);

205 ià(
	`‹¡_tsk_th»ad_æag
(
´ev_p
, 
TIF_NOTSC
) ^

206 
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_NOTSC
)) {

208 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_NOTSC
))

209 
	`h¬d_di§bË_TSC
();

211 
	`h¬d_’abË_TSC
();

214 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_IO_BITMAP
)) {

219 
	`memıy
(
tss
->
io_b™m­
, 
Ãxt
->
io_b™m­_±r
,

220 
	`max
(
´ev
->
io_b™m­_max
, 
Ãxt
->io_bitmap_max));

221 } ià(
	`‹¡_tsk_th»ad_æag
(
´ev_p
, 
TIF_IO_BITMAP
)) {

225 
	`mem£t
(
tss
->
io_b™m­
, 0xff, 
´ev
->
io_b™m­_max
);

227 
	}
}

229 
	$sys_fÜk
(
±_»gs
 *
»gs
)

231  
	`do_fÜk
(
SIGCHLD
, 
»gs
->
¥
,„egs, 0, 
NULL
, NULL);

232 
	}
}

244 
	$sys_vfÜk
(
±_»gs
 *
»gs
)

246  
	`do_fÜk
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
»gs
->
¥
,„egs, 0,

247 
NULL
, NULL);

248 
	}
}

254 
	gboÙ_İtiÚ_idË_ov”ride
 = 0;

255 
EXPORT_SYMBOL
(
boÙ_İtiÚ_idË_ov”ride
);

260 (*
pm_idË
)();

261 
	`EXPORT_SYMBOL
(
pm_idË
);

263 #ifdeà
CONFIG_X86_32


268 
hÉ_couÁ”
;

269 
	$di§bË_hÉ
()

271 
hÉ_couÁ”
++;

272 
	}
}

273 
EXPORT_SYMBOL
(
di§bË_hÉ
);

275 
	$’abË_hÉ
()

277 
hÉ_couÁ”
--;

278 
	}
}

279 
EXPORT_SYMBOL
(
’abË_hÉ
);

281 
šlše
 
	$hÉ_u£_h®t
()

283  (!
hÉ_couÁ”
 && 
boÙ_ıu_d©a
.
hÉ_wÜks_ok
);

284 
	}
}

286 
šlše
 
	$hÉ_u£_h®t
()

289 
	}
}

296 
	$deçuÉ_idË
()

298 ià(
	`hÉ_u£_h®t
()) {

299 
pow”_Œaû
 
™
;

301 
	`Œaû_pow”_¡¬t
(&
™
, 
POWER_CSTATE
, 1);

302 
	`cu¼’t_th»ad_šfo
()->
¡©us
 &ğ~
TS_POLLING
;

307 
	`smp_mb
();

309 ià(!
	`Ãed_»sched
())

310 
	`§ã_h®t
();

312 
	`loÿl_œq_’abË
();

313 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_POLLING
;

314 
	`Œaû_pow”_’d
(&
™
);

316 
	`loÿl_œq_’abË
();

318 
	`ıu_»Ïx
();

320 
	}
}

321 #ifdeà
CONFIG_APM_MODULE


322 
EXPORT_SYMBOL
(
deçuÉ_idË
);

325 
	$¡İ_this_ıu
(*
dummy
)

327 
	`loÿl_œq_di§bË
();

331 
	`£t_ıu_Úlše
(
	`smp_´oûssÜ_id
(), 
çl£
);

332 
	`di§bË_loÿl_APIC
();

335 ià(
	`hÉ_wÜks
(
	`smp_´oûssÜ_id
()))

336 
	`h®t
();

338 
	}
}

340 
	$do_nÙhšg
(*
unu£d
)

342 
	}
}

352 
	$ıu_idË_wa™
()

354 
	`smp_mb
();

356 
	`smp_ÿÎ_funùiÚ
(
do_nÙhšg
, 
NULL
, 1);

357 
	}
}

358 
EXPORT_SYMBOL_GPL
(
ıu_idË_wa™
);

370 
	$mwa™_idË_w™h_hšts
(
ax
, 
cx
)

372 
pow”_Œaû
 
™
;

374 
	`Œaû_pow”_¡¬t
(&
™
, 
POWER_CSTATE
, (
ax
>>4)+1);

375 ià(!
	`Ãed_»sched
()) {

376 ià(
	`ıu_has
(&
cu¼’t_ıu_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

377 
	`şæush
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
);

379 
	`__mÚ™Ü
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
, 0, 0);

380 
	`smp_mb
();

381 ià(!
	`Ãed_»sched
())

382 
	`__mwa™
(
ax
, 
cx
);

384 
	`Œaû_pow”_’d
(&
™
);

385 
	}
}

388 
	$mwa™_idË
()

390 
pow”_Œaû
 
™
;

391 ià(!
	`Ãed_»sched
()) {

392 
	`Œaû_pow”_¡¬t
(&
™
, 
POWER_CSTATE
, 1);

393 ià(
	`ıu_has
(&
cu¼’t_ıu_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

394 
	`şæush
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
);

396 
	`__mÚ™Ü
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
, 0, 0);

397 
	`smp_mb
();

398 ià(!
	`Ãed_»sched
())

399 
	`__¡i_mwa™
(0, 0);

401 
	`loÿl_œq_’abË
();

402 
	`Œaû_pow”_’d
(&
™
);

404 
	`loÿl_œq_’abË
();

405 
	}
}

412 
	$pŞl_idË
()

414 
pow”_Œaû
 
™
;

416 
	`Œaû_pow”_¡¬t
(&
™
, 
POWER_CSTATE
, 0);

417 
	`loÿl_œq_’abË
();

418 !
	`Ãed_»sched
())

419 
	`ıu_»Ïx
();

420 
	`Œaû_pow”_’d
(&
™
);

421 
	}
}

435 
__ıuš™d©a
 
	gfÜû_mwa™
;

437 
	#MWAIT_INFO
 0x05

	)

438 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

439 
	#MWAIT_EDX_C1
 0xf0

	)

441 
__ıuš™
 
	$mwa™_u§bË
(cÚ¡ 
ıušfo_x86
 *
c
)

443 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

445 ià(
fÜû_mwa™
)

448 ià(
c
->
ıuid_Ëv–
 < 
MWAIT_INFO
)

451 
	`ıuid
(
MWAIT_INFO
, &
—x
, &
ebx
, &
ecx
, &
edx
);

453 ià(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

460  (
edx
 & 
MWAIT_EDX_C1
);

461 
	}
}

466 
__ıuš™
 
	$check_c1e_idË
(cÚ¡ 
ıušfo_x86
 *
c
)

468 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

471 ià(
c
->
x86
 < 0x0F)

475 ià(
c
->
x86
 =ğ0x0à&& c->
x86_mod–
 < 0x40)

479 
	}
}

481 
ıumask_v¬_t
 
	gc1e_mask
;

482 
	gc1e_d‘eùed
;

484 
	$c1e_»move_ıu
(
ıu
)

486 ià(
c1e_mask
 !ğ
NULL
)

487 
	`ıumask_ş—r_ıu
(
ıu
, 
c1e_mask
);

488 
	}
}

495 
	$c1e_idË
()

497 ià(
	`Ãed_»sched
())

500 ià(!
c1e_d‘eùed
) {

501 
u32
 
lo
, 
hi
;

503 
	`rdm¤
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

504 ià(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

505 
c1e_d‘eùed
 = 1;

506 ià(!
	`boÙ_ıu_has
(
X86_FEATURE_NONSTOP_TSC
))

507 
	`m¬k_tsc_un¡abË
("TSC halt in AMD C1E");

508 
	`´štk
(
KERN_INFO
 "System has AMD C1Eƒnabled\n");

509 
	`£t_ıu_ÿp
(&
boÙ_ıu_d©a
, 
X86_FEATURE_AMDC1E
);

513 ià(
c1e_d‘eùed
) {

514 
ıu
 = 
	`smp_´oûssÜ_id
();

516 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
c1e_mask
)) {

517 
	`ıumask_£t_ıu
(
ıu
, 
c1e_mask
);

523 
	`loÿl_œq_’abË
();

524 
	`şockev’ts_nÙify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

525 &
ıu
);

526 
	`´štk
(
KERN_INFO
 "Switcho broadcast mode on CPU%d\n",

527 
ıu
);

528 
	`loÿl_œq_di§bË
();

530 
	`şockev’ts_nÙify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
ıu
);

532 
	`deçuÉ_idË
();

538 
	`loÿl_œq_di§bË
();

539 
	`şockev’ts_nÙify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
ıu
);

540 
	`loÿl_œq_’abË
();

542 
	`deçuÉ_idË
();

543 
	}
}

545 
__ıuš™
 
	$£Ëù_idË_routše
(cÚ¡ 
ıušfo_x86
 *
c
)

547 #ifdeà
CONFIG_SMP


548 ià(
pm_idË
 =ğ
pŞl_idË
 && 
smp_num_siblšgs
 > 1) {

549 
	`´štk
(
KERN_WARNING
 "WARNING:…olling idle‡nd HTƒnabled,"

553 ià(
pm_idË
)

556 ià(
	`ıu_has
(
c
, 
X86_FEATURE_MWAIT
è&& 
	`mwa™_u§bË
(c)) {

560 
	`´štk
(
KERN_INFO
 "using mwait in idlehreads.\n");

561 
pm_idË
 = 
mwa™_idË
;

562 } ià(
	`check_c1e_idË
(
c
)) {

563 
	`´štk
(
KERN_INFO
 "using C1E‡ware idle„outine\n");

564 
pm_idË
 = 
c1e_idË
;

566 
pm_idË
 = 
deçuÉ_idË
;

567 
	}
}

569 
__š™
 
	$š™_c1e_mask
()

572 ià(
pm_idË
 =ğ
c1e_idË
) {

573 
	`®loc_ıumask_v¬
(&
c1e_mask
, 
GFP_KERNEL
);

574 
	`ıumask_ş—r
(
c1e_mask
);

576 
	}
}

578 
__š™
 
	$idË_£tup
(*
¡r
)

580 ià(!
¡r
)

581  -
EINVAL
;

583 ià(!
	`¡rcmp
(
¡r
, "poll")) {

584 
	`´štk
("using…olling idlehreads.\n");

585 
pm_idË
 = 
pŞl_idË
;

586 } ià(!
	`¡rcmp
(
¡r
, "mwait"))

587 
fÜû_mwa™
 = 1;

588 ià(!
	`¡rcmp
(
¡r
, "halt")) {

596 
pm_idË
 = 
deçuÉ_idË
;

597 
idË_h®t
 = 1;

599 } ià(!
	`¡rcmp
(
¡r
, "nomwait")) {

606 
idË_nomwa™
 = 1;

611 
boÙ_İtiÚ_idË_ov”ride
 = 1;

613 
	}
}

614 
—¾y_·¿m
("idË", 
idË_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<¡d¬g.h
>

19 
	~<lšux/¡ack´ÙeùÜ.h
>

20 
	~<lšux/ıu.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/mm.h
>

26 
	~<lšux/–fcÜe.h
>

27 
	~<lšux/smp.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<lšux/u£r.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/ut¢ame.h
>

32 
	~<lšux/d–ay.h
>

33 
	~<lšux/moduË.h
>

34 
	~<lšux/±¿û.h
>

35 
	~<lšux/¿ndom.h
>

36 
	~<lšux/nÙif›r.h
>

37 
	~<lšux/k´obes.h
>

38 
	~<lšux/kdebug.h
>

39 
	~<lšux/tick.h
>

40 
	~<lšux/´ùl.h
>

41 
	~<lšux/uacûss.h
>

42 
	~<lšux/io.h
>

43 
	~<lšux/á¿û.h
>

44 
	~<lšux/dmi.h
>

46 
	~<asm/pgbË.h
>

47 
	~<asm/sy¡em.h
>

48 
	~<asm/´oûssÜ.h
>

49 
	~<asm/i387.h
>

50 
	~<asm/mmu_cÚ‹xt.h
>

51 
	~<asm/´ùl.h
>

52 
	~<asm/desc.h
>

53 
	~<asm/´Ùo.h
>

54 
	~<asm/Ÿ32.h
>

55 
	~<asm/idË.h
>

56 
	~<asm/sysÿÎs.h
>

57 
	~<asm/ds.h
>

59 
asmlškage
 
»t_äom_fÜk
();

61 
DEFINE_PER_CPU
(
sk_¡ruù
 *, 
cu¼’t_sk
èğ&
š™_sk
;

62 
EXPORT_PER_CPU_SYMBOL
(
cu¼’t_sk
);

64 
DEFINE_PER_CPU
(, 
Şd_r¥
);

65 
DEFINE_PER_CPU
(, 
is_idË
);

67 
	gk”Ãl_th»ad_æags
 = 
CLONE_VM
 | 
CLONE_UNTRACED
;

69 
ATOMIC_NOTIFIER_HEAD
(
idË_nÙif›r
);

71 
	$idË_nÙif›r_»gi¡”
(
nÙif›r_block
 *
n
)

73 
	`©omic_nÙif›r_chaš_»gi¡”
(&
idË_nÙif›r
, 
n
);

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
idË_nÙif›r_»gi¡”
);

77 
	$idË_nÙif›r_uÄegi¡”
(
nÙif›r_block
 *
n
)

79 
	`©omic_nÙif›r_chaš_uÄegi¡”
(&
idË_nÙif›r
, 
n
);

80 
	}
}

81 
EXPORT_SYMBOL_GPL
(
idË_nÙif›r_uÄegi¡”
);

83 
	$’‹r_idË
()

85 
	`³rıu_wr™e
(
is_idË
, 1);

86 
	`©omic_nÙif›r_ÿÎ_chaš
(&
idË_nÙif›r
, 
IDLE_START
, 
NULL
);

87 
	}
}

89 
	$__ex™_idË
()

91 ià(
	`x86_‹¡_ªd_ş—r_b™_³rıu
(0, 
is_idË
) == 0)

93 
	`©omic_nÙif›r_ÿÎ_chaš
(&
idË_nÙif›r
, 
IDLE_END
, 
NULL
);

94 
	}
}

97 
	$ex™_idË
()

100 ià(
cu¼’t
->
pid
)

102 
	`__ex™_idË
();

103 
	}
}

105 #iâdeà
CONFIG_SMP


106 
šlše
 
	$¶ay_d—d
()

108 
	`BUG
();

109 
	}
}

118 
	$ıu_idË
()

120 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_POLLING
;

129 
	`boÙ_š™_¡ack_ÿÇry
();

133 
	`tick_nohz_¡İ_sched_tick
(1);

134 !
	`Ãed_»sched
()) {

136 
	`rmb
();

138 ià(
	`ıu_is_ofæše
(
	`smp_´oûssÜ_id
()))

139 
	`¶ay_d—d
();

145 
	`loÿl_œq_di§bË
();

146 
	`’‹r_idË
();

148 
	`¡İ_ü™iÿl_timšgs
();

149 
	`pm_idË
();

150 
	`¡¬t_ü™iÿl_timšgs
();

154 
	`__ex™_idË
();

157 
	`tick_nohz_»¡¬t_sched_tick
();

158 
	`´“m±_’abË_no_»sched
();

159 
	`scheduË
();

160 
	`´“m±_di§bË
();

162 
	}
}

165 
	$__show_»gs
(
±_»gs
 *
»gs
, 
®l
)

167 
ü0
 = 0L, 
ü2
 = 0L, 
ü3
 = 0L, 
ü4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

168 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

169 
fsšdex
, 
gsšdex
;

170 
ds
, 
cs
, 
es
;

171 cÚ¡ *
bßrd
;

173 
	`´štk
("\n");

174 
	`´št_moduËs
();

175 
bßrd
 = 
	`dmi_g‘_sy¡em_šfo
(
DMI_PRODUCT_NAME
);

176 ià(!
bßrd
)

177 
bßrd
 = "";

178 
	`´štk
(
KERN_INFO
 "Pid: %d, comm: %.20s %s %s %.*s %s\n",

179 
cu¼’t
->
pid
, cu¼’t->
comm
, 
	`´št_š‹d
(),

180 
	`š™_ut¢ame
()->
»Ëa£
,

181 ()
	`¡rc¥n
(
	`š™_ut¢ame
()->
v”siÚ
, " "),

182 
	`š™_ut¢ame
()->
v”siÚ
, 
bßrd
);

183 
	`´štk
(
KERN_INFO
 "RIP: %04lx:[<%016lx>] ", 
»gs
->
cs
 & 0xffff,„egs->

);

184 
	`´štk_add»ss
(
»gs
->

, 1);

185 
	`´štk
(
KERN_INFO
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
»gs
->
ss
,

186 
»gs
->
¥
,„egs->
æags
);

187 
	`´štk
(
KERN_INFO
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

188 
»gs
->
ax
,„egs->
bx
,„egs->
cx
);

189 
	`´štk
(
KERN_INFO
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

190 
»gs
->
dx
,„egs->
si
,„egs->
di
);

191 
	`´štk
(
KERN_INFO
 "RBP: %016lx R08: %016lx R09: %016lx\n",

192 
»gs
->
bp
,„egs->
r8
,„egs->
r9
);

193 
	`´štk
(
KERN_INFO
 "R10: %016lx R11: %016lx R12: %016lx\n",

194 
»gs
->
r10
,„egs->
r11
,„egs->
r12
);

195 
	`´štk
(
KERN_INFO
 "R13: %016lx R14: %016lx R15: %016lx\n",

196 
»gs
->
r13
,„egs->
r14
,„egs->
r15
);

198 
	`asm
("movÈ%%ds,%0" : "ô" (
ds
));

199 
	`asm
("movÈ%%cs,%0" : "ô" (
cs
));

200 
	`asm
("movÈ%%es,%0" : "ô" (
es
));

201 
	`asm
("movÈ%%fs,%0" : "ô" (
fsšdex
));

202 
	`asm
("movÈ%%gs,%0" : "ô" (
gsšdex
));

204 
	`rdm¤l
(
MSR_FS_BASE
, 
fs
);

205 
	`rdm¤l
(
MSR_GS_BASE
, 
gs
);

206 
	`rdm¤l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

208 ià(!
®l
)

211 
ü0
 = 
	`»ad_ü0
();

212 
ü2
 = 
	`»ad_ü2
();

213 
ü3
 = 
	`»ad_ü3
();

214 
ü4
 = 
	`»ad_ü4
();

216 
	`´štk
(
KERN_INFO
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

217 
fs
, 
fsšdex
, 
gs
, 
gsšdex
, 
shadowgs
);

218 
	`´štk
(
KERN_INFO
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

219 
es
, 
ü0
);

220 
	`´štk
(
KERN_INFO
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
ü2
, 
ü3
,

221 
ü4
);

223 
	`g‘_debug»g
(
d0
, 0);

224 
	`g‘_debug»g
(
d1
, 1);

225 
	`g‘_debug»g
(
d2
, 2);

226 
	`´štk
(
KERN_INFO
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

227 
	`g‘_debug»g
(
d3
, 3);

228 
	`g‘_debug»g
(
d6
, 6);

229 
	`g‘_debug»g
(
d7
, 7);

230 
	`´štk
(
KERN_INFO
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

231 
	}
}

233 
	$show_»gs
(
±_»gs
 *
»gs
)

235 
	`´štk
(
KERN_INFO
 "CPU %d:", 
	`smp_´oûssÜ_id
());

236 
	`__show_»gs
(
»gs
, 1);

237 
	`show_Œaû
(
NULL
, 
»gs
, (*)Ôeg + 1),„egs->
bp
);

238 
	}
}

240 
	$»Ëa£_th»ad
(
sk_¡ruù
 *
d—d_sk
)

242 ià(
d—d_sk
->
mm
) {

243 ià(
d—d_sk
->
mm
->
cÚ‹xt
.
size
) {

244 
	`´štk
("WARNING: dead…rocess %8s still has LDT? <%p/%d>\n",

245 
d—d_sk
->
comm
,

246 
d—d_sk
->
mm
->
cÚ‹xt
.
ldt
,

247 
d—d_sk
->
mm
->
cÚ‹xt
.
size
);

248 
	`BUG
();

251 
	}
}

253 
šlše
 
	$£t_32b™_s
(
sk_¡ruù
 *
t
, 
s
, 
u32
 
addr
)

255 
u£r_desc
 
ud
 = {

256 .
ba£_addr
 = 
addr
,

257 .
lim™
 = 0xfffff,

258 .
£g_32b™
 = 1,

259 .
lim™_š_·ges
 = 1,

260 .
u£abË
 = 1,

262 
desc_¡ruù
 *
desc
 = 
t
->
th»ad
.
s_¬¿y
;

263 
desc
 +ğ
s
;

264 
	`fl_ldt
(
desc
, &
ud
);

265 
	}
}

267 
šlše
 
u32
 
	$»ad_32b™_s
(
sk_¡ruù
 *
t
, 
s
)

269  
	`g‘_desc_ba£
(&
t
->
th»ad
.
s_¬¿y
[
s
]);

270 
	}
}

276 
	$´•¬e_to_cİy
(
sk_¡ruù
 *
tsk
)

278 
	`uÆazy_åu
(
tsk
);

279 
	}
}

281 
	$cİy_th»ad
(
şÚe_æags
, 
¥
,

282 
unu£d
,

283 
sk_¡ruù
 *
p
, 
±_»gs
 *
»gs
)

285 
”r
;

286 
±_»gs
 *
chd»gs
;

287 
sk_¡ruù
 *
me
 = 
cu¼’t
;

289 
chd»gs
 = ((
±_»gs
 *)

290 (
THREAD_SIZE
 + 
	`sk_¡ack_·ge
(
p
))) - 1;

291 *
chd»gs
 = *
»gs
;

293 
chd»gs
->
ax
 = 0;

294 
chd»gs
->
¥
 = sp;

295 ià(
¥
 == ~0UL)

296 
chd»gs
->
¥
 = ()childregs;

298 
p
->
th»ad
.
¥
 = (è
chd»gs
;

299 
p
->
th»ad
.
¥0
 = (è(
chd»gs
+1);

300 
p
->
th»ad
.
u£r¥
 = 
me
->thread.usersp;

302 
	`£t_tsk_th»ad_æag
(
p
, 
TIF_FORK
);

304 
p
->
th»ad
.
fs
 = 
me
->thread.fs;

305 
p
->
th»ad
.
gs
 = 
me
->thread.gs;

307 
	`§ve£gm’t
(
gs
, 
p
->
th»ad
.
gsšdex
);

308 
	`§ve£gm’t
(
fs
, 
p
->
th»ad
.
fsšdex
);

309 
	`§ve£gm’t
(
es
, 
p
->
th»ad
.es);

310 
	`§ve£gm’t
(
ds
, 
p
->
th»ad
.ds);

312 ià(
	`uÆik–y
(
	`‹¡_tsk_th»ad_æag
(
me
, 
TIF_IO_BITMAP
))) {

313 
p
->
th»ad
.
io_b™m­_±r
 = 
	`km®loc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

314 ià(!
p
->
th»ad
.
io_b™m­_±r
) {

315 
p
->
th»ad
.
io_b™m­_max
 = 0;

316  -
ENOMEM
;

318 
	`memıy
(
p
->
th»ad
.
io_b™m­_±r
, 
me
->thread.io_bitmap_ptr,

319 
IO_BITMAP_BYTES
);

320 
	`£t_tsk_th»ad_æag
(
p
, 
TIF_IO_BITMAP
);

326 ià(
şÚe_æags
 & 
CLONE_SETTLS
) {

327 #ifdeà
CONFIG_IA32_EMULATION


328 ià(
	`‹¡_th»ad_æag
(
TIF_IA32
))

329 
”r
 = 
	`do_£t_th»ad_¬—
(
p
, -1,

330 (
u£r_desc
 
__u£r
 *)
chd»gs
->
si
, 0);

333 
”r
 = 
	`do_¬ch_´ùl
(
p
, 
ARCH_SET_FS
, 
chd»gs
->
r8
);

334 ià(
”r
)

335 
out
;

338 
	`ds_cİy_th»ad
(
p
, 
me
);

340 
	`ş—r_tsk_th»ad_æag
(
p
, 
TIF_DEBUGCTLMSR
);

341 
p
->
th»ad
.
debugùlm¤
 = 0;

343 
”r
 = 0;

344 
out
:

345 ià(
”r
 && 
p
->
th»ad
.
io_b™m­_±r
) {

346 
	`kä“
(
p
->
th»ad
.
io_b™m­_±r
);

347 
p
->
th»ad
.
io_b™m­_max
 = 0;

349  
”r
;

350 
	}
}

353 
	$¡¬t_th»ad
(
±_»gs
 *
»gs
, 
Ãw_
, 
Ãw_¥
)

355 
	`lßd£gm’t
(
fs
, 0);

356 
	`lßd£gm’t
(
es
, 0);

357 
	`lßd£gm’t
(
ds
, 0);

358 
	`lßd_gs_šdex
(0);

359 
»gs
->

 = 
Ãw_
;

360 
»gs
->
¥
 = 
Ãw_¥
;

361 
	`³rıu_wr™e
(
Şd_r¥
, 
Ãw_¥
);

362 
»gs
->
cs
 = 
__USER_CS
;

363 
»gs
->
ss
 = 
__USER_DS
;

364 
»gs
->
æags
 = 0x200;

365 
	`£t_fs
(
USER_DS
);

369 
	`ä“_th»ad_x¡©e
(
cu¼’t
);

370 
	}
}

371 
EXPORT_SYMBOL_GPL
(
¡¬t_th»ad
);

383 
__nÙ¿û_funcg¿ph
 
sk_¡ruù
 *

384 
	$__sw™ch_to
(
sk_¡ruù
 *
´ev_p
, sk_¡ruù *
Ãxt_p
)

386 
th»ad_¡ruù
 *
´ev
 = &
´ev_p
->
th»ad
;

387 
th»ad_¡ruù
 *
Ãxt
 = &
Ãxt_p
->
th»ad
;

388 
ıu
 = 
	`smp_´oûssÜ_id
();

389 
tss_¡ruù
 *
tss
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

390 
fsšdex
, 
gsšdex
;

393 ià(
Ãxt_p
->
åu_couÁ”
 > 5)

394 
	`´eãtch
(
Ãxt
->
x¡©e
);

399 
	`lßd_¥0
(
tss
, 
Ãxt
);

405 
	`§ve£gm’t
(
es
, 
´ev
->es);

406 ià(
	`uÆik–y
(
Ãxt
->
es
 | 
´ev
->es))

407 
	`lßd£gm’t
(
es
, 
Ãxt
->es);

409 
	`§ve£gm’t
(
ds
, 
´ev
->ds);

410 ià(
	`uÆik–y
(
Ãxt
->
ds
 | 
´ev
->ds))

411 
	`lßd£gm’t
(
ds
, 
Ãxt
->ds);

419 
	`§ve£gm’t
(
fs
, 
fsšdex
);

420 
	`§ve£gm’t
(
gs
, 
gsšdex
);

422 
	`lßd_TLS
(
Ãxt
, 
ıu
);

431 
	`¬ch_Ëave_Ïzy_ıu_mode
();

440 ià(
	`uÆik–y
(
fsšdex
 | 
Ãxt
->fsšdex | 
´ev
->
fs
)) {

441 
	`lßd£gm’t
(
fs
, 
Ãxt
->
fsšdex
);

447 ià(
fsšdex
)

448 
´ev
->
fs
 = 0;

451 ià(
Ãxt
->
fs
)

452 
	`wrm¤l
(
MSR_FS_BASE
, 
Ãxt
->
fs
);

453 
´ev
->
fsšdex
 = fsindex;

455 ià(
	`uÆik–y
(
gsšdex
 | 
Ãxt
->gsšdex | 
´ev
->
gs
)) {

456 
	`lßd_gs_šdex
(
Ãxt
->
gsšdex
);

457 ià(
gsšdex
)

458 
´ev
->
gs
 = 0;

460 ià(
Ãxt
->
gs
)

461 
	`wrm¤l
(
MSR_KERNEL_GS_BASE
, 
Ãxt
->
gs
);

462 
´ev
->
gsšdex
 = gsindex;

465 
	`uÆazy_åu
(
´ev_p
);

470 
´ev
->
u£r¥
 = 
	`³rıu_»ad
(
Şd_r¥
);

471 
	`³rıu_wr™e
(
Şd_r¥
, 
Ãxt
->
u£r¥
);

472 
	`³rıu_wr™e
(
cu¼’t_sk
, 
Ãxt_p
);

474 
	`³rıu_wr™e
(
k”Ãl_¡ack
,

475 ()
	`sk_¡ack_·ge
(
Ãxt_p
) +

476 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

481 ià(
	`uÆik–y
(
	`sk_th»ad_šfo
(
Ãxt_p
)->
æags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

482 
	`sk_th»ad_šfo
(
´ev_p
)->
æags
 & 
_TIF_WORK_CTXSW_PREV
))

483 
	`__sw™ch_to_xŒa
(
´ev_p
, 
Ãxt_p
, 
tss
);

492 ià(
	`tsk_u£d_m©h
(
Ãxt_p
è&&‚ext_p->
åu_couÁ”
 > 5)

493 
	`m©h_¡©e_»¡Üe
();

494  
´ev_p
;

495 
	}
}

500 
asmlškage


501 
	$sys_execve
(
__u£r
 *
Çme
, __u£¸* __u£¸*
¬gv
,

502 
__u£r
 * __u£¸*
’vp
, 
±_»gs
 *
»gs
)

504 
”rÜ
;

505 *
f’ame
;

507 
f’ame
 = 
	`g‘Çme
(
Çme
);

508 
”rÜ
 = 
	`PTR_ERR
(
f’ame
);

509 ià(
	`IS_ERR
(
f’ame
))

510  
”rÜ
;

511 
”rÜ
 = 
	`do_execve
(
f’ame
, 
¬gv
, 
’vp
, 
»gs
);

512 
	`puŠame
(
f’ame
);

513  
”rÜ
;

514 
	}
}

516 
	$£t_³rsÚ®™y_64b™
()

521 
	`ş—r_th»ad_æag
(
TIF_IA32
);

527 
cu¼’t
->
³rsÚ®™y
 &ğ~
READ_IMPLIES_EXEC
;

528 
	}
}

530 
asmlškage
 

531 
	$sys_şÚe
(
şÚe_æags
, 
Ãw¥
,

532 
__u£r
 *
·»Á_tid
, __u£¸*
chd_tid
, 
±_»gs
 *
»gs
)

534 ià(!
Ãw¥
)

535 
Ãw¥
 = 
»gs
->
¥
;

536  
	`do_fÜk
(
şÚe_æags
, 
Ãw¥
, 
»gs
, 0, 
·»Á_tid
, 
chd_tid
);

537 
	}
}

539 
	$g‘_wchª
(
sk_¡ruù
 *
p
)

541 
¡ack
;

542 
u64
 
å
, 

;

543 
couÁ
 = 0;

545 ià(!
p
 ||… =ğ
cu¼’t
 ||…->
¡©e
 =ğ
TASK_RUNNING
)

547 
¡ack
 = ()
	`sk_¡ack_·ge
(
p
);

548 ià(
p
->
th»ad
.
¥
 < 
¡ack
 ||…->th»ad.¥ >ğ¡ack+
THREAD_SIZE
)

550 
å
 = *(
u64
 *)(
p
->
th»ad
.
¥
);

552 ià(
å
 < ()
¡ack
 ||

553 
å
 >ğ()
¡ack
+
THREAD_SIZE
)

555 

 = *(
u64
 *)(
å
+8);

556 ià(!
	`š_sched_funùiÚs
(

))

557  

;

558 
å
 = *(
u64
 *)fp;

559 } 
couÁ
++ < 16);

561 
	}
}

563 
	$do_¬ch_´ùl
(
sk_¡ruù
 *
sk
, 
code
, 
addr
)

565 
»t
 = 0;

566 
do™
 = 
sk
 =ğ
cu¼’t
;

567 
ıu
;

569 
code
) {

570 
ARCH_SET_GS
:

571 ià(
addr
 >ğ
	`TASK_SIZE_OF
(
sk
))

572  -
EPERM
;

573 
ıu
 = 
	`g‘_ıu
();

576 ià(
addr
 <= 0xffffffff) {

577 
	`£t_32b™_s
(
sk
, 
GS_TLS
, 
addr
);

578 ià(
do™
) {

579 
	`lßd_TLS
(&
sk
->
th»ad
, 
ıu
);

580 
	`lßd_gs_šdex
(
GS_TLS_SEL
);

582 
sk
->
th»ad
.
gsšdex
 = 
GS_TLS_SEL
;

583 
sk
->
th»ad
.
gs
 = 0;

585 
sk
->
th»ad
.
gsšdex
 = 0;

586 
sk
->
th»ad
.
gs
 = 
addr
;

587 ià(
do™
) {

588 
	`lßd_gs_šdex
(0);

589 
»t
 = 
	`checkšg_wrm¤l
(
MSR_KERNEL_GS_BASE
, 
addr
);

592 
	`put_ıu
();

594 
ARCH_SET_FS
:

597 ià(
addr
 >ğ
	`TASK_SIZE_OF
(
sk
))

598  -
EPERM
;

599 
ıu
 = 
	`g‘_ıu
();

602 ià(
addr
 <= 0xffffffff) {

603 
	`£t_32b™_s
(
sk
, 
FS_TLS
, 
addr
);

604 ià(
do™
) {

605 
	`lßd_TLS
(&
sk
->
th»ad
, 
ıu
);

606 
	`lßd£gm’t
(
fs
, 
FS_TLS_SEL
);

608 
sk
->
th»ad
.
fsšdex
 = 
FS_TLS_SEL
;

609 
sk
->
th»ad
.
fs
 = 0;

611 
sk
->
th»ad
.
fsšdex
 = 0;

612 
sk
->
th»ad
.
fs
 = 
addr
;

613 ià(
do™
) {

616 
	`lßd£gm’t
(
fs
, 0);

617 
»t
 = 
	`checkšg_wrm¤l
(
MSR_FS_BASE
, 
addr
);

620 
	`put_ıu
();

622 
ARCH_GET_FS
: {

623 
ba£
;

624 ià(
sk
->
th»ad
.
fsšdex
 =ğ
FS_TLS_SEL
)

625 
ba£
 = 
	`»ad_32b™_s
(
sk
, 
FS_TLS
);

626 ià(
do™
)

627 
	`rdm¤l
(
MSR_FS_BASE
, 
ba£
);

629 
ba£
 = 
sk
->
th»ad
.
fs
;

630 
»t
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

633 
ARCH_GET_GS
: {

634 
ba£
;

635 
gsšdex
;

636 ià(
sk
->
th»ad
.
gsšdex
 =ğ
GS_TLS_SEL
)

637 
ba£
 = 
	`»ad_32b™_s
(
sk
, 
GS_TLS
);

638 ià(
do™
) {

639 
	`§ve£gm’t
(
gs
, 
gsšdex
);

640 ià(
gsšdex
)

641 
	`rdm¤l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

643 
ba£
 = 
sk
->
th»ad
.
gs
;

645 
ba£
 = 
sk
->
th»ad
.
gs
;

646 
»t
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

651 
»t
 = -
EINVAL
;

655  
»t
;

656 
	}
}

658 
	$sys_¬ch_´ùl
(
code
, 
addr
)

660  
	`do_¬ch_´ùl
(
cu¼’t
, 
code
, 
addr
);

661 
	}
}

663 
	$¬ch_®ign_¡ack
(
¥
)

665 ià(!(
cu¼’t
->
³rsÚ®™y
 & 
ADDR_NO_RANDOMIZE
è&& 
¿ndomize_va_¥aû
)

666 
¥
 -ğ
	`g‘_¿ndom_št
() % 8192;

667  
¥
 & ~0xf;

668 
	}
}

670 
	$¬ch_¿ndomize_brk
(
mm_¡ruù
 *
mm
)

672 
¿nge_’d
 = 
mm
->
brk
 + 0x02000000;

673  
	`¿ndomize_¿nge
(
mm
->
brk
, 
¿nge_’d
, 0) ? : mm->brk;

674 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/mm.h
>

13 
	~<lšux/smp.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/±¿û.h
>

16 
	~<lšux/»g£t.h
>

17 
	~<lšux/Œaûhook.h
>

18 
	~<lšux/u£r.h
>

19 
	~<lšux/–f.h
>

20 
	~<lšux/£cur™y.h
>

21 
	~<lšux/aud™.h
>

22 
	~<lšux/£ccomp.h
>

23 
	~<lšux/sigÇl.h
>

25 
	~<asm/uacûss.h
>

26 
	~<asm/pgbË.h
>

27 
	~<asm/sy¡em.h
>

28 
	~<asm/´oûssÜ.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/debug»g.h
>

31 
	~<asm/ldt.h
>

32 
	~<asm/desc.h
>

33 
	~<asm/´ùl.h
>

34 
	~<asm/´Ùo.h
>

35 
	~<asm/ds.h
>

37 
	~<Œaû/sysÿÎ.h
>

39 
	~"s.h
"

41 
	ex86_»g£t
 {

42 
	mREGSET_GENERAL
,

43 
	mREGSET_FP
,

44 
	mREGSET_XFP
,

45 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

46 
	mREGSET_TLS
,

47 
	mREGSET_IOPERM32
,

58 
	#FLAG_MASK_32
 (() \

59 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

60 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

61 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

62 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

63 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

68 
šlše
 
boŞ
 
	$šv®id_£ËùÜ
(
u16
 
v®ue
)

70  
	`uÆik–y
(
v®ue
 !ğ0 && (v®u& 
SEGMENT_RPL_MASK
è!ğ
USER_RPL
);

71 
	}
}

73 #ifdeà
CONFIG_X86_32


75 
	#FLAG_MASK
 
FLAG_MASK_32


	)

77 *
	$±_»gs_acûss
(
±_»gs
 *
»gs
, 
»gno
)

79 
	`BUILD_BUG_ON
(
	`off£tof
(
±_»gs
, 
bx
) != 0);

80  &
»gs
->
bx
 + (
»gno
 >> 2);

81 
	}
}

83 
u16
 
	$g‘_£gm’t_»g
(
sk_¡ruù
 *
sk
, 
off£t
)

88 
»tv®
;

89 ià(
off£t
 !ğ
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
))

90 
»tv®
 = *
	`±_»gs_acûss
(
	`sk_±_»gs
(
sk
), 
off£t
);

92 ià(
sk
 =ğ
cu¼’t
)

93 
»tv®
 = 
	`g‘_u£r_gs
(
	`sk_±_»gs
(
sk
));

95 
»tv®
 = 
	`sk_u£r_gs
(
sk
);

97  
»tv®
;

98 
	}
}

100 
	$£t_£gm’t_»g
(
sk_¡ruù
 *
sk
,

101 
off£t
, 
u16
 
v®ue
)

106 ià(
	`šv®id_£ËùÜ
(
v®ue
))

107  -
EIO
;

118 
off£t
) {

119 
	`off£tof
(
u£r_»gs_¡ruù
, 
cs
):

120 
	`off£tof
(
u£r_»gs_¡ruù
, 
ss
):

121 ià(
	`uÆik–y
(
v®ue
 == 0))

122  -
EIO
;

125 *
	`±_»gs_acûss
(
	`sk_±_»gs
(
sk
), 
off£t
èğ
v®ue
;

128 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
):

129 ià(
sk
 =ğ
cu¼’t
)

130 
	`£t_u£r_gs
(
	`sk_±_»gs
(
sk
), 
v®ue
);

132 
	`sk_u£r_gs
(
sk
èğ
v®ue
;

136 
	}
}

138 
	$debug»g_addr_lim™
(
sk_¡ruù
 *
sk
)

140  
TASK_SIZE
 - 3;

141 
	}
}

145 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

147 *
	$±_»gs_acûss
(
±_»gs
 *
»gs
, 
off£t
)

149 
	`BUILD_BUG_ON
(
	`off£tof
(
±_»gs
, 
r15
) != 0);

150  &
»gs
->
r15
 + (
off£t
 / (regs->r15));

151 
	}
}

153 
u16
 
	$g‘_£gm’t_»g
(
sk_¡ruù
 *
sk
, 
off£t
)

158 
£g
;

160 
off£t
) {

161 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs
):

162 ià(
sk
 =ğ
cu¼’t
) {

164 
	`asm
("movÈ%%fs,%0" : "ô" (
£g
));

165  
£g
;

167  
sk
->
th»ad
.
fsšdex
;

168 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
):

169 ià(
sk
 =ğ
cu¼’t
) {

170 
	`asm
("movÈ%%gs,%0" : "ô" (
£g
));

171  
£g
;

173  
sk
->
th»ad
.
gsšdex
;

174 
	`off£tof
(
u£r_»gs_¡ruù
, 
ds
):

175 ià(
sk
 =ğ
cu¼’t
) {

176 
	`asm
("movÈ%%ds,%0" : "ô" (
£g
));

177  
£g
;

179  
sk
->
th»ad
.
ds
;

180 
	`off£tof
(
u£r_»gs_¡ruù
, 
es
):

181 ià(
sk
 =ğ
cu¼’t
) {

182 
	`asm
("movÈ%%es,%0" : "ô" (
£g
));

183  
£g
;

185  
sk
->
th»ad
.
es
;

187 
	`off£tof
(
u£r_»gs_¡ruù
, 
cs
):

188 
	`off£tof
(
u£r_»gs_¡ruù
, 
ss
):

191  *
	`±_»gs_acûss
(
	`sk_±_»gs
(
sk
), 
off£t
);

192 
	}
}

194 
	$£t_£gm’t_»g
(
sk_¡ruù
 *
sk
,

195 
off£t
, 
u16
 
v®ue
)

200 ià(
	`šv®id_£ËùÜ
(
v®ue
))

201  -
EIO
;

203 
off£t
) {

204 
	`off£tof
(
u£r_»gs_¡ruù
,
fs
):

209 ià((
v®ue
 =ğ
FS_TLS_SEL
 && 
sk
->
th»ad
.
fsšdex
 == 0 &&

210 
sk
->
th»ad
.
fs
 != 0) ||

211 (
v®ue
 =ğ0 && 
sk
->
th»ad
.
fsšdex
 =ğ
FS_TLS_SEL
 &&

212 
sk
->
th»ad
.
fs
 == 0))

214 
sk
->
th»ad
.
fsšdex
 = 
v®ue
;

215 ià(
sk
 =ğ
cu¼’t
)

216 
	`lßd£gm’t
(
fs
, 
sk
->
th»ad
.
fsšdex
);

218 
	`off£tof
(
u£r_»gs_¡ruù
,
gs
):

223 ià((
v®ue
 =ğ
GS_TLS_SEL
 && 
sk
->
th»ad
.
gsšdex
 == 0 &&

224 
sk
->
th»ad
.
gs
 != 0) ||

225 (
v®ue
 =ğ0 && 
sk
->
th»ad
.
gsšdex
 =ğ
GS_TLS_SEL
 &&

226 
sk
->
th»ad
.
gs
 == 0))

228 
sk
->
th»ad
.
gsšdex
 = 
v®ue
;

229 ià(
sk
 =ğ
cu¼’t
)

230 
	`lßd_gs_šdex
(
sk
->
th»ad
.
gsšdex
);

232 
	`off£tof
(
u£r_»gs_¡ruù
,
ds
):

233 
sk
->
th»ad
.
ds
 = 
v®ue
;

234 ià(
sk
 =ğ
cu¼’t
)

235 
	`lßd£gm’t
(
ds
, 
sk
->
th»ad
.ds);

237 
	`off£tof
(
u£r_»gs_¡ruù
,
es
):

238 
sk
->
th»ad
.
es
 = 
v®ue
;

239 ià(
sk
 =ğ
cu¼’t
)

240 
	`lßd£gm’t
(
es
, 
sk
->
th»ad
.es);

246 
	`off£tof
(
u£r_»gs_¡ruù
,
cs
):

247 ià(
	`uÆik–y
(
v®ue
 == 0))

248  -
EIO
;

249 #ifdeà
CONFIG_IA32_EMULATION


250 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_IA32
))

251 
	`sk_±_»gs
(
sk
)->
cs
 = 
v®ue
;

254 
	`off£tof
(
u£r_»gs_¡ruù
,
ss
):

255 ià(
	`uÆik–y
(
v®ue
 == 0))

256  -
EIO
;

257 #ifdeà
CONFIG_IA32_EMULATION


258 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_IA32
))

259 
	`sk_±_»gs
(
sk
)->
ss
 = 
v®ue
;

265 
	}
}

267 
	$debug»g_addr_lim™
(
sk_¡ruù
 *
sk
)

269 #ifdeà
CONFIG_IA32_EMULATION


270 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_IA32
))

271  
IA32_PAGE_OFFSET
 - 3;

273  
TASK_SIZE_MAX
 - 7;

274 
	}
}

278 
	$g‘_æags
(
sk_¡ruù
 *
sk
)

280 
»tv®
 = 
	`sk_±_»gs
(
sk
)->
æags
;

285 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_FORCED_TF
))

286 
»tv®
 &ğ~
X86_EFLAGS_TF
;

288  
»tv®
;

289 
	}
}

291 
	$£t_æags
(
sk_¡ruù
 *
sk
, 
v®ue
)

293 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
sk
);

300 ià(
v®ue
 & 
X86_EFLAGS_TF
)

301 
	`ş—r_tsk_th»ad_æag
(
sk
, 
TIF_FORCED_TF
);

302 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_FORCED_TF
))

303 
v®ue
 |ğ
X86_EFLAGS_TF
;

305 
»gs
->
æags
 = (»gs->æag & ~
FLAG_MASK
è| (
v®ue
 & FLAG_MASK);

308 
	}
}

310 
	$puŒeg
(
sk_¡ruù
 *
chd
,

311 
off£t
, 
v®ue
)

313 
off£t
) {

314 
	`off£tof
(
u£r_»gs_¡ruù
, 
cs
):

315 
	`off£tof
(
u£r_»gs_¡ruù
, 
ds
):

316 
	`off£tof
(
u£r_»gs_¡ruù
, 
es
):

317 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs
):

318 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
):

319 
	`off£tof
(
u£r_»gs_¡ruù
, 
ss
):

320  
	`£t_£gm’t_»g
(
chd
, 
off£t
, 
v®ue
);

322 
	`off£tof
(
u£r_»gs_¡ruù
, 
æags
):

323  
	`£t_æags
(
chd
, 
v®ue
);

325 #ifdeà
CONFIG_X86_64


332 
	`off£tof
(
u£r_»gs_¡ruù
, 
Üig_ax
):

333 
v®ue
 = (è(
s32
) value;

336 
	`off£tof
(
u£r_»gs_¡ruù
,
fs_ba£
):

337 ià(
v®ue
 >ğ
	`TASK_SIZE_OF
(
chd
))

338  -
EIO
;

344 ià(
chd
->
th»ad
.
fs
 !ğ
v®ue
)

345  
	`do_¬ch_´ùl
(
chd
, 
ARCH_SET_FS
, 
v®ue
);

347 
	`off£tof
(
u£r_»gs_¡ruù
,
gs_ba£
):

351 ià(
v®ue
 >ğ
	`TASK_SIZE_OF
(
chd
))

352  -
EIO
;

353 ià(
chd
->
th»ad
.
gs
 !ğ
v®ue
)

354  
	`do_¬ch_´ùl
(
chd
, 
ARCH_SET_GS
, 
v®ue
);

359 *
	`±_»gs_acûss
(
	`sk_±_»gs
(
chd
), 
off£t
èğ
v®ue
;

361 
	}
}

363 
	$g‘»g
(
sk_¡ruù
 *
sk
, 
off£t
)

365 
off£t
) {

366 
	`off£tof
(
u£r_»gs_¡ruù
, 
cs
):

367 
	`off£tof
(
u£r_»gs_¡ruù
, 
ds
):

368 
	`off£tof
(
u£r_»gs_¡ruù
, 
es
):

369 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs
):

370 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
):

371 
	`off£tof
(
u£r_»gs_¡ruù
, 
ss
):

372  
	`g‘_£gm’t_»g
(
sk
, 
off£t
);

374 
	`off£tof
(
u£r_»gs_¡ruù
, 
æags
):

375  
	`g‘_æags
(
sk
);

377 #ifdeà
CONFIG_X86_64


378 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs_ba£
): {

384 
£g
 = 
sk
->
th»ad
.
fsšdex
;

385 ià(
sk
->
th»ad
.
fs
 != 0)

386  
sk
->
th»ad
.
fs
;

387 ià(
sk
 =ğ
cu¼’t
)

388 
	`asm
("movÈ%%fs,%0" : "ô" (
£g
));

389 ià(
£g
 !ğ
FS_TLS_SEL
)

391  
	`g‘_desc_ba£
(&
sk
->
th»ad
.
s_¬¿y
[
FS_TLS
]);

393 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs_ba£
): {

397 
£g
 = 
sk
->
th»ad
.
gsšdex
;

398 ià(
sk
->
th»ad
.
gs
 != 0)

399  
sk
->
th»ad
.
gs
;

400 ià(
sk
 =ğ
cu¼’t
)

401 
	`asm
("movÈ%%gs,%0" : "ô" (
£g
));

402 ià(
£g
 !ğ
GS_TLS_SEL
)

404  
	`g‘_desc_ba£
(&
sk
->
th»ad
.
s_¬¿y
[
GS_TLS
]);

409  *
	`±_»gs_acûss
(
	`sk_±_»gs
(
sk
), 
off£t
);

410 
	}
}

412 
	$g’»gs_g‘
(
sk_¡ruù
 *
rg‘
,

413 cÚ¡ 
u£r_»g£t
 *
»g£t
,

414 
pos
, 
couÁ
,

415 *
kbuf
, 
__u£r
 *
ubuf
)

417 ià(
kbuf
) {

418 *
k
 = 
kbuf
;

419 
couÁ
 > 0) {

420 *
k
++ = 
	`g‘»g
(
rg‘
, 
pos
);

421 
couÁ
 -ğ(*
k
);

422 
pos
 +ğ(*
k
);

425 
__u£r
 *
u
 = 
ubuf
;

426 
couÁ
 > 0) {

427 ià(
	`__put_u£r
(
	`g‘»g
(
rg‘
, 
pos
), 
u
++))

428  -
EFAULT
;

429 
couÁ
 -ğ(*
u
);

430 
pos
 +ğ(*
u
);

435 
	}
}

437 
	$g’»gs_£t
(
sk_¡ruù
 *
rg‘
,

438 cÚ¡ 
u£r_»g£t
 *
»g£t
,

439 
pos
, 
couÁ
,

440 cÚ¡ *
kbuf
, cÚ¡ 
__u£r
 *
ubuf
)

442 
»t
 = 0;

443 ià(
kbuf
) {

444 cÚ¡ *
k
 = 
kbuf
;

445 
couÁ
 > 0 && !
»t
) {

446 
»t
 = 
	`puŒeg
(
rg‘
, 
pos
, *
k
++);

447 
couÁ
 -ğ(*
k
);

448 
pos
 +ğ(*
k
);

451 cÚ¡ 
__u£r
 *
u
 = 
ubuf
;

452 
couÁ
 > 0 && !
»t
) {

453 
wÜd
;

454 
»t
 = 
	`__g‘_u£r
(
wÜd
, 
u
++);

455 ià(
»t
)

457 
»t
 = 
	`puŒeg
(
rg‘
, 
pos
, 
wÜd
);

458 
couÁ
 -ğ(*
u
);

459 
pos
 +ğ(*
u
);

462  
»t
;

463 
	}
}

470 
	$±¿û_g‘_debug»g
(
sk_¡ruù
 *
chd
, 
n
)

472 
n
) {

473 0:  
chd
->
th»ad
.
debug»g0
;

474 1:  
chd
->
th»ad
.
debug»g1
;

475 2:  
chd
->
th»ad
.
debug»g2
;

476 3:  
chd
->
th»ad
.
debug»g3
;

477 6:  
chd
->
th»ad
.
debug»g6
;

478 7:  
chd
->
th»ad
.
debug»g7
;

481 
	}
}

483 
	$±¿û_£t_debug»g
(
sk_¡ruù
 *
chd
,

484 
n
, 
d©a
)

486 
i
;

488 ià(
	`uÆik–y
(
n
 == 4 ||‚ == 5))

489  -
EIO
;

491 ià(
n
 < 4 && 
	`uÆik–y
(
d©a
 >ğ
	`debug»g_addr_lim™
(
chd
)))

492  -
EIO
;

494 
n
) {

495 0: 
chd
->
th»ad
.
debug»g0
 = 
d©a
; ;

496 1: 
chd
->
th»ad
.
debug»g1
 = 
d©a
; ;

497 2: 
chd
->
th»ad
.
debug»g2
 = 
d©a
; ;

498 3: 
chd
->
th»ad
.
debug»g3
 = 
d©a
; ;

501 ià((
d©a
 & ~0xffffffffUL) != 0)

502  -
EIO
;

503 
chd
->
th»ad
.
debug»g6
 = 
d©a
;

537 #ifdeà
CONFIG_X86_32


538 
	#DR7_MASK
 0x5f54

	)

540 
	#DR7_MASK
 0x5554

	)

542 
d©a
 &ğ~
DR_CONTROL_RESERVED
;

543 
i
 = 0; i < 4; i++)

544 ià((
DR7_MASK
 >> ((
d©a
 >> (16 + 4*
i
)) & 0xf)) & 1)

545  -
EIO
;

546 
chd
->
th»ad
.
debug»g7
 = 
d©a
;

547 ià(
d©a
)

548 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_DEBUG
);

550 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_DEBUG
);

555 
	}
}

561 
	$iİ”m_aùive
(
sk_¡ruù
 *
rg‘
,

562 cÚ¡ 
u£r_»g£t
 *
»g£t
)

564  
rg‘
->
th»ad
.
io_b™m­_max
 / 
»g£t
->
size
;

565 
	}
}

567 
	$iİ”m_g‘
(
sk_¡ruù
 *
rg‘
,

568 cÚ¡ 
u£r_»g£t
 *
»g£t
,

569 
pos
, 
couÁ
,

570 *
kbuf
, 
__u£r
 *
ubuf
)

572 ià(!
rg‘
->
th»ad
.
io_b™m­_±r
)

573  -
ENXIO
;

575  
	`u£r_»g£t_cİyout
(&
pos
, &
couÁ
, &
kbuf
, &
ubuf
,

576 
rg‘
->
th»ad
.
io_b™m­_±r
,

577 0, 
IO_BITMAP_BYTES
);

578 
	}
}

580 #ifdeà
CONFIG_X86_PTRACE_BTS


581 
	$±¿û_bts_»ad_»cÜd
(
sk_¡ruù
 *
chd
, 
size_t
 
šdex
,

582 
bts_¡ruù
 
__u£r
 *
out
)

584 cÚ¡ 
bts_Œaû
 *
Œaû
;

585 
bts_¡ruù
 
bts
;

586 cÚ¡ *
©
;

587 
”rÜ
;

589 
Œaû
 = 
	`ds_»ad_bts
(
chd
->
bts
);

590 ià(!
Œaû
)

591  -
EPERM
;

593 
©
 = 
Œaû
->
ds
.
tİ
 - ((
šdex
 + 1è*¿û->ds.
size
);

594 ià((*)
©
 < 
Œaû
->
ds
.
begš
)

595 
©
 +ğ(
Œaû
->
ds
.
n
 *¿û->ds.
size
);

597 ià(!
Œaû
->
»ad
)

598  -
EOPNOTSUPP
;

600 
”rÜ
 = 
Œaû
->
	`»ad
(
chd
->
bts
, 
©
, &bts);

601 ià(
”rÜ
 < 0)

602  
”rÜ
;

604 ià(
	`cİy_to_u£r
(
out
, &
bts
, (bts)))

605  -
EFAULT
;

607  (
bts
);

608 
	}
}

610 
	$±¿û_bts_d¿š
(
sk_¡ruù
 *
chd
,

611 
size
,

612 
bts_¡ruù
 
__u£r
 *
out
)

614 cÚ¡ 
bts_Œaû
 *
Œaû
;

615 cÚ¡ *
©
;

616 
”rÜ
, 
d¿šed
 = 0;

618 
Œaû
 = 
	`ds_»ad_bts
(
chd
->
bts
);

619 ià(!
Œaû
)

620  -
EPERM
;

622 ià(!
Œaû
->
»ad
)

623  -
EOPNOTSUPP
;

625 ià(
size
 < (
Œaû
->
ds
.
tİ
 -¿û->ds.
begš
))

626  -
EIO
;

628 
©
 = 
Œaû
->
ds
.
begš
; (*ïˆ<¿û->ds.
tİ
;

629 
out
++, 
d¿šed
++, 
©
 +ğ
Œaû
->
ds
.
size
) {

630 
bts_¡ruù
 
bts
;

631 
”rÜ
;

633 
”rÜ
 = 
Œaû
->
	`»ad
(
chd
->
bts
, 
©
, &bts);

634 ià(
”rÜ
 < 0)

635  
”rÜ
;

637 ià(
	`cİy_to_u£r
(
out
, &
bts
, (bts)))

638  -
EFAULT
;

641 
	`mem£t
(
Œaû
->
ds
.
begš
, 0,¿û->ds.
n
 *¿û->ds.
size
);

643 
”rÜ
 = 
	`ds_»£t_bts
(
chd
->
bts
);

644 ià(
”rÜ
 < 0)

645  
”rÜ
;

647  
d¿šed
;

648 
	}
}

650 
	$±¿û_bts_®loÿ‹_bufãr
(
sk_¡ruù
 *
chd
, 
size_t
 
size
)

652 
chd
->
bts_bufãr
 = 
	`®loc_locked_bufãr
(
size
);

653 ià(!
chd
->
bts_bufãr
)

654  -
ENOMEM
;

656 
chd
->
bts_size
 = 
size
;

659 
	}
}

661 
	$±¿û_bts_ä“_bufãr
(
sk_¡ruù
 *
chd
)

663 
	`ä“_locked_bufãr
(
chd
->
bts_bufãr
, chd->
bts_size
);

664 
chd
->
bts_bufãr
 = 
NULL
;

665 
chd
->
bts_size
 = 0;

666 
	}
}

668 
	$±¿û_bts_cÚfig
(
sk_¡ruù
 *
chd
,

669 
cfg_size
,

670 cÚ¡ 
±¿û_bts_cÚfig
 
__u£r
 *
ucfg
)

672 
±¿û_bts_cÚfig
 
cfg
;

673 
æags
 = 0;

675 ià(
cfg_size
 < (
cfg
))

676  -
EIO
;

678 ià(
	`cİy_äom_u£r
(&
cfg
, 
ucfg
, (cfg)))

679  -
EFAULT
;

681 ià(
chd
->
bts
) {

682 
	`ds_»Ëa£_bts
(
chd
->
bts
);

683 
chd
->
bts
 = 
NULL
;

686 ià(
cfg
.
æags
 & 
PTRACE_BTS_O_SIGNAL
) {

687 ià(!
cfg
.
sigÇl
)

688  -
EINVAL
;

690 
chd
->
th»ad
.
bts_ovæ_sigÇl
 = 
cfg
.
sigÇl
;

691  -
EOPNOTSUPP
;

694 ià((
cfg
.
æags
 & 
PTRACE_BTS_O_ALLOC
) &&

695 (
cfg
.
size
 !ğ
chd
->
bts_size
)) {

696 
”rÜ
;

698 
	`±¿û_bts_ä“_bufãr
(
chd
);

700 
”rÜ
 = 
	`±¿û_bts_®loÿ‹_bufãr
(
chd
, 
cfg
.
size
);

701 ià(
”rÜ
 < 0)

702  
”rÜ
;

705 ià(
cfg
.
æags
 & 
PTRACE_BTS_O_TRACE
)

706 
æags
 |ğ
BTS_USER
;

708 ià(
cfg
.
æags
 & 
PTRACE_BTS_O_SCHED
)

709 
æags
 |ğ
BTS_TIMESTAMPS
;

711 
chd
->
bts
 = 
	`ds_»que¡_bts
(chd, chd->
bts_bufãr
, chd->
bts_size
,

712  
NULL
, (
size_t
)-1,

713 
æags
);

714 ià(
	`IS_ERR
(
chd
->
bts
)) {

715 
”rÜ
 = 
	`PTR_ERR
(
chd
->
bts
);

717 
	`±¿û_bts_ä“_bufãr
(
chd
);

718 
chd
->
bts
 = 
NULL
;

720  
”rÜ
;

723  (
cfg
);

724 
	}
}

726 
	$±¿û_bts_¡©us
(
sk_¡ruù
 *
chd
,

727 
cfg_size
,

728 
±¿û_bts_cÚfig
 
__u£r
 *
ucfg
)

730 cÚ¡ 
bts_Œaû
 *
Œaû
;

731 
±¿û_bts_cÚfig
 
cfg
;

733 ià(
cfg_size
 < (
cfg
))

734  -
EIO
;

736 
Œaû
 = 
	`ds_»ad_bts
(
chd
->
bts
);

737 ià(!
Œaû
)

738  -
EPERM
;

740 
	`mem£t
(&
cfg
, 0, (cfg));

741 
cfg
.
size
 = 
Œaû
->
ds
.
’d
 -¿û->ds.
begš
;

742 
cfg
.
sigÇl
 = 
chd
->
th»ad
.
bts_ovæ_sigÇl
;

743 
cfg
.
bts_size
 = (
bts_¡ruù
);

745 ià(
cfg
.
sigÇl
)

746 
cfg
.
æags
 |ğ
PTRACE_BTS_O_SIGNAL
;

748 ià(
Œaû
->
ds
.
æags
 & 
BTS_USER
)

749 
cfg
.
æags
 |ğ
PTRACE_BTS_O_TRACE
;

751 ià(
Œaû
->
ds
.
æags
 & 
BTS_TIMESTAMPS
)

752 
cfg
.
æags
 |ğ
PTRACE_BTS_O_SCHED
;

754 ià(
	`cİy_to_u£r
(
ucfg
, &
cfg
, (cfg)))

755  -
EFAULT
;

757  (
cfg
);

758 
	}
}

760 
	$±¿û_bts_ş—r
(
sk_¡ruù
 *
chd
)

762 cÚ¡ 
bts_Œaû
 *
Œaû
;

764 
Œaû
 = 
	`ds_»ad_bts
(
chd
->
bts
);

765 ià(!
Œaû
)

766  -
EPERM
;

768 
	`mem£t
(
Œaû
->
ds
.
begš
, 0,¿û->ds.
n
 *¿û->ds.
size
);

770  
	`ds_»£t_bts
(
chd
->
bts
);

771 
	}
}

773 
	$±¿û_bts_size
(
sk_¡ruù
 *
chd
)

775 cÚ¡ 
bts_Œaû
 *
Œaû
;

777 
Œaû
 = 
	`ds_»ad_bts
(
chd
->
bts
);

778 ià(!
Œaû
)

779  -
EPERM
;

781  (
Œaû
->
ds
.
tİ
 -¿û->ds.
begš
è/¿û->ds.
size
;

782 
	}
}

784 
	$±¿û_bts_fÜk
(
sk_¡ruù
 *
tsk
)

786 
tsk
->
bts
 = 
NULL
;

787 
tsk
->
bts_bufãr
 = 
NULL
;

788 
tsk
->
bts_size
 = 0;

789 
tsk
->
th»ad
.
bts_ovæ_sigÇl
 = 0;

790 
	}
}

792 
	$±¿û_bts_uÁ¿û
(
sk_¡ruù
 *
chd
)

794 ià(
	`uÆik–y
(
chd
->
bts
)) {

795 
	`ds_»Ëa£_bts
(
chd
->
bts
);

796 
chd
->
bts
 = 
NULL
;

801 
	`kä“
(
chd
->
bts_bufãr
);

802 
chd
->
bts_bufãr
 = 
NULL
;

803 
chd
->
bts_size
 = 0;

805 
	}
}

807 
	$±¿û_bts_d‘ach
(
sk_¡ruù
 *
chd
)

818 
	`»Ëa£_locked_bufãr
(
chd
->
bts_bufãr
, chd->
bts_size
);

819 
	}
}

821 
šlše
 
	$±¿û_bts_fÜk
(
sk_¡ruù
 *
tsk
è{
	}
}

822 
šlše
 
	$±¿û_bts_d‘ach
(
sk_¡ruù
 *
chd
è{
	}
}

823 
šlše
 
	$±¿û_bts_uÁ¿û
(
sk_¡ruù
 *
chd
è{
	}
}

826 
	$x86_±¿û_fÜk
(
sk_¡ruù
 *
chd
, 
şÚe_æags
)

828 
	`±¿û_bts_fÜk
(
chd
);

829 
	}
}

831 
	$x86_±¿û_uÁ¿û
(
sk_¡ruù
 *
chd
)

833 
	`±¿û_bts_uÁ¿û
(
chd
);

834 
	}
}

841 
	$±¿û_di§bË
(
sk_¡ruù
 *
chd
)

843 
	`u£r_di§bË_sšgË_¡•
(
chd
);

844 #ifdeà
TIF_SYSCALL_EMU


845 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_SYSCALL_EMU
);

847 
	`±¿û_bts_d‘ach
(
chd
);

848 
	}
}

850 #ià
defšed
 
CONFIG_X86_32
 || defšed 
CONFIG_IA32_EMULATION


851 cÚ¡ 
u£r_»g£t_v›w
 
	gu£r_x86_32_v›w
;

854 
	$¬ch_±¿û
(
sk_¡ruù
 *
chd
, 
»que¡
, 
addr
, 
d©a
)

856 
»t
;

857 
__u£r
 *
d©­
 = (__u£¸*)
d©a
;

859 
»que¡
) {

861 
PTRACE_PEEKUSR
: {

862 
tmp
;

864 
»t
 = -
EIO
;

865 ià((
addr
 & ((
d©a
) - 1)) ||‡ddr < 0 ||

866 
addr
 >ğ(
u£r
))

869 
tmp
 = 0;

870 ià(
addr
 < (
u£r_»gs_¡ruù
))

871 
tmp
 = 
	`g‘»g
(
chd
, 
addr
);

872 ià(
addr
 >ğ
	`off£tof
(
u£r
, 
u_debug»g
[0]) &&

873 
addr
 <ğ
	`off£tof
(
u£r
, 
u_debug»g
[7])) {

874 
addr
 -ğ
	`off£tof
(
u£r
, 
u_debug»g
[0]);

875 
tmp
 = 
	`±¿û_g‘_debug»g
(
chd
, 
addr
 / (
d©a
));

877 
»t
 = 
	`put_u£r
(
tmp
, 
d©­
);

881 
PTRACE_POKEUSR
:

882 
»t
 = -
EIO
;

883 ià((
addr
 & ((
d©a
) - 1)) ||‡ddr < 0 ||

884 
addr
 >ğ(
u£r
))

887 ià(
addr
 < (
u£r_»gs_¡ruù
))

888 
»t
 = 
	`puŒeg
(
chd
, 
addr
, 
d©a
);

889 ià(
addr
 >ğ
	`off£tof
(
u£r
, 
u_debug»g
[0]) &&

890 
addr
 <ğ
	`off£tof
(
u£r
, 
u_debug»g
[7])) {

891 
addr
 -ğ
	`off£tof
(
u£r
, 
u_debug»g
[0]);

892 
»t
 = 
	`±¿û_£t_debug»g
(
chd
,

893 
addr
 / (
d©a
), data);

897 
PTRACE_GETREGS
:

898  
	`cİy_»g£t_to_u£r
(
chd
,

899 
	`sk_u£r_»g£t_v›w
(
cu¼’t
),

900 
REGSET_GENERAL
,

901 0, (
u£r_»gs_¡ruù
),

902 
d©­
);

904 
PTRACE_SETREGS
:

905  
	`cİy_»g£t_äom_u£r
(
chd
,

906 
	`sk_u£r_»g£t_v›w
(
cu¼’t
),

907 
REGSET_GENERAL
,

908 0, (
u£r_»gs_¡ruù
),

909 
d©­
);

911 
PTRACE_GETFPREGS
:

912  
	`cİy_»g£t_to_u£r
(
chd
,

913 
	`sk_u£r_»g£t_v›w
(
cu¼’t
),

914 
REGSET_FP
,

915 0, (
u£r_i387_¡ruù
),

916 
d©­
);

918 
PTRACE_SETFPREGS
:

919  
	`cİy_»g£t_äom_u£r
(
chd
,

920 
	`sk_u£r_»g£t_v›w
(
cu¼’t
),

921 
REGSET_FP
,

922 0, (
u£r_i387_¡ruù
),

923 
d©­
);

925 #ifdeà
CONFIG_X86_32


926 
PTRACE_GETFPXREGS
:

927  
	`cİy_»g£t_to_u£r
(
chd
, &
u£r_x86_32_v›w
,

928 
REGSET_XFP
,

929 0, (
u£r_fx¤_¡ruù
),

930 
d©­
è? -
EIO
 : 0;

932 
PTRACE_SETFPXREGS
:

933  
	`cİy_»g£t_äom_u£r
(
chd
, &
u£r_x86_32_v›w
,

934 
REGSET_XFP
,

935 0, (
u£r_fx¤_¡ruù
),

936 
d©­
è? -
EIO
 : 0;

939 #ià
defšed
 
CONFIG_X86_32
 || defšed 
CONFIG_IA32_EMULATION


940 
PTRACE_GET_THREAD_AREA
:

941 ià(
addr
 < 0)

942  -
EIO
;

943 
»t
 = 
	`do_g‘_th»ad_¬—
(
chd
, 
addr
,

944 (
u£r_desc
 
__u£r
 *è
d©a
);

947 
PTRACE_SET_THREAD_AREA
:

948 ià(
addr
 < 0)

949  -
EIO
;

950 
»t
 = 
	`do_£t_th»ad_¬—
(
chd
, 
addr
,

951 (
u£r_desc
 
__u£r
 *è
d©a
, 0);

955 #ifdeà
CONFIG_X86_64


959 
PTRACE_ARCH_PRCTL
:

960 
»t
 = 
	`do_¬ch_´ùl
(
chd
, 
d©a
, 
addr
);

967 #ifdeà
CONFIG_X86_PTRACE_BTS


968 
PTRACE_BTS_CONFIG
:

969 
»t
 = 
±¿û_bts_cÚfig


970 (
chd
, 
d©a
, (
±¿û_bts_cÚfig
 
__u£r
 *)
addr
);

973 
PTRACE_BTS_STATUS
:

974 
»t
 = 
±¿û_bts_¡©us


975 (
chd
, 
d©a
, (
±¿û_bts_cÚfig
 
__u£r
 *)
addr
);

978 
PTRACE_BTS_SIZE
:

979 
»t
 = 
	`±¿û_bts_size
(
chd
);

982 
PTRACE_BTS_GET
:

983 
»t
 = 
±¿û_bts_»ad_»cÜd


984 (
chd
, 
d©a
, (
bts_¡ruù
 
__u£r
 *è
addr
);

987 
PTRACE_BTS_CLEAR
:

988 
»t
 = 
	`±¿û_bts_ş—r
(
chd
);

991 
PTRACE_BTS_DRAIN
:

992 
»t
 = 
±¿û_bts_d¿š


993 (
chd
, 
d©a
, (
bts_¡ruù
 
__u£r
 *è
addr
);

998 
»t
 = 
	`±¿û_»que¡
(
chd
, 
»que¡
, 
addr
, 
d©a
);

1002  
»t
;

1003 
	}
}

1005 #ifdeà
CONFIG_IA32_EMULATION


1007 
	~<lšux/com·t.h
>

1008 
	~<lšux/sysÿÎs.h
>

1009 
	~<asm/Ÿ32.h
>

1010 
	~<asm/u£r32.h
>

1012 
	#R32
(
l
,
q
) \

1013 
	`off£tof
(
u£r32
, 
»gs
.
l
): \

1014 
»gs
->
q
 = 
v®ue
; 

	)

1016 
	#SEG32
(
rs
) \

1017 
	`off£tof
(
u£r32
, 
»gs
.
rs
): \

1018  
	`£t_£gm’t_»g
(
chd
, \

1019 
	`off£tof
(
u£r_»gs_¡ruù
, 
rs
), \

1020 
v®ue
); \

1021 

	)

1023 
	$puŒeg32
(
sk_¡ruù
 *
chd
, 
»gno
, 
u32
 
v®ue
)

1025 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
chd
);

1027 
»gno
) {

1029 
	`SEG32
(
cs
);

1030 
	`SEG32
(
ds
);

1031 
	`SEG32
(
es
);

1032 
	`SEG32
(
fs
);

1033 
	`SEG32
(
gs
);

1034 
	`SEG32
(
ss
);

1036 
	`R32
(
ebx
, 
bx
);

1037 
	`R32
(
ecx
, 
cx
);

1038 
	`R32
(
edx
, 
dx
);

1039 
	`R32
(
edi
, 
di
);

1040 
	`R32
(
esi
, 
si
);

1041 
	`R32
(
ebp
, 
bp
);

1042 
	`R32
(
—x
, 
ax
);

1043 
	`R32
(
e
, 

);

1044 
	`R32
(
e¥
, 
¥
);

1046 
	`off£tof
(
u£r32
, 
»gs
.
Üig_—x
):

1051 
»gs
->
Üig_ax
 = (è(
s32
è
v®ue
;

1054 
	`off£tof
(
u£r32
, 
»gs
.
eæags
):

1055  
	`£t_æags
(
chd
, 
v®ue
);

1057 
	`off£tof
(
u£r32
, 
u_debug»g
[0]) ...

1058 
	`off£tof
(
u£r32
, 
u_debug»g
[7]):

1059 
»gno
 -ğ
	`off£tof
(
u£r32
, 
u_debug»g
[0]);

1060  
	`±¿û_£t_debug»g
(
chd
, 
»gno
 / 4, 
v®ue
);

1063 ià(
»gno
 > (
u£r32
) || (regno & 3))

1064  -
EIO
;

1073 
	}
}

1075 #undeà
R32


1076 #undeà
SEG32


1078 
	#R32
(
l
,
q
) \

1079 
	`off£tof
(
u£r32
, 
»gs
.
l
): \

1080 *
v®
 = 
»gs
->
q
; 

	)

1082 
	#SEG32
(
rs
) \

1083 
	`off£tof
(
u£r32
, 
»gs
.
rs
): \

1084 *
v®
 = 
	`g‘_£gm’t_»g
(
chd
, \

1085 
	`off£tof
(
u£r_»gs_¡ruù
, 
rs
)); \

1086 

	)

1088 
	$g‘»g32
(
sk_¡ruù
 *
chd
, 
»gno
, 
u32
 *
v®
)

1090 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
chd
);

1092 
»gno
) {

1094 
	`SEG32
(
ds
);

1095 
	`SEG32
(
es
);

1096 
	`SEG32
(
fs
);

1097 
	`SEG32
(
gs
);

1099 
	`R32
(
cs
, cs);

1100 
	`R32
(
ss
, ss);

1101 
	`R32
(
ebx
, 
bx
);

1102 
	`R32
(
ecx
, 
cx
);

1103 
	`R32
(
edx
, 
dx
);

1104 
	`R32
(
edi
, 
di
);

1105 
	`R32
(
esi
, 
si
);

1106 
	`R32
(
ebp
, 
bp
);

1107 
	`R32
(
—x
, 
ax
);

1108 
	`R32
(
Üig_—x
, 
Üig_ax
);

1109 
	`R32
(
e
, 

);

1110 
	`R32
(
e¥
, 
¥
);

1112 
	`off£tof
(
u£r32
, 
»gs
.
eæags
):

1113 *
v®
 = 
	`g‘_æags
(
chd
);

1116 
	`off£tof
(
u£r32
, 
u_debug»g
[0]) ...

1117 
	`off£tof
(
u£r32
, 
u_debug»g
[7]):

1118 
»gno
 -ğ
	`off£tof
(
u£r32
, 
u_debug»g
[0]);

1119 *
v®
 = 
	`±¿û_g‘_debug»g
(
chd
, 
»gno
 / 4);

1123 ià(
»gno
 > (
u£r32
) || (regno & 3))

1124  -
EIO
;

1130 *
v®
 = 0;

1134 
	}
}

1136 #undeà
R32


1137 #undeà
SEG32


1139 
	$g’»gs32_g‘
(
sk_¡ruù
 *
rg‘
,

1140 cÚ¡ 
u£r_»g£t
 *
»g£t
,

1141 
pos
, 
couÁ
,

1142 *
kbuf
, 
__u£r
 *
ubuf
)

1144 ià(
kbuf
) {

1145 
com·t_ulÚg_t
 *
k
 = 
kbuf
;

1146 
couÁ
 > 0) {

1147 
	`g‘»g32
(
rg‘
, 
pos
, 
k
++);

1148 
couÁ
 -ğ(*
k
);

1149 
pos
 +ğ(*
k
);

1152 
com·t_ulÚg_t
 
__u£r
 *
u
 = 
ubuf
;

1153 
couÁ
 > 0) {

1154 
com·t_ulÚg_t
 
wÜd
;

1155 
	`g‘»g32
(
rg‘
, 
pos
, &
wÜd
);

1156 ià(
	`__put_u£r
(
wÜd
, 
u
++))

1157  -
EFAULT
;

1158 
couÁ
 -ğ(*
u
);

1159 
pos
 +ğ(*
u
);

1164 
	}
}

1166 
	$g’»gs32_£t
(
sk_¡ruù
 *
rg‘
,

1167 cÚ¡ 
u£r_»g£t
 *
»g£t
,

1168 
pos
, 
couÁ
,

1169 cÚ¡ *
kbuf
, cÚ¡ 
__u£r
 *
ubuf
)

1171 
»t
 = 0;

1172 ià(
kbuf
) {

1173 cÚ¡ 
com·t_ulÚg_t
 *
k
 = 
kbuf
;

1174 
couÁ
 > 0 && !
»t
) {

1175 
»t
 = 
	`puŒeg32
(
rg‘
, 
pos
, *
k
++);

1176 
couÁ
 -ğ(*
k
);

1177 
pos
 +ğ(*
k
);

1180 cÚ¡ 
com·t_ulÚg_t
 
__u£r
 *
u
 = 
ubuf
;

1181 
couÁ
 > 0 && !
»t
) {

1182 
com·t_ulÚg_t
 
wÜd
;

1183 
»t
 = 
	`__g‘_u£r
(
wÜd
, 
u
++);

1184 ià(
»t
)

1186 
»t
 = 
	`puŒeg32
(
rg‘
, 
pos
, 
wÜd
);

1187 
couÁ
 -ğ(*
u
);

1188 
pos
 +ğ(*
u
);

1191  
»t
;

1192 
	}
}

1194 
	$com·t_¬ch_±¿û
(
sk_¡ruù
 *
chd
, 
com·t_lÚg_t
 
»que¡
,

1195 
com·t_ulÚg_t
 
ÿddr
, com·t_ulÚg_ˆ
cd©a
)

1197 
addr
 = 
ÿddr
;

1198 
d©a
 = 
cd©a
;

1199 
__u£r
 *
d©­
 = 
	`com·t_±r
(
d©a
);

1200 
»t
;

1201 
__u32
 
v®
;

1203 
»que¡
) {

1204 
PTRACE_PEEKUSR
:

1205 
»t
 = 
	`g‘»g32
(
chd
, 
addr
, &
v®
);

1206 ià(
»t
 == 0)

1207 
»t
 = 
	`put_u£r
(
v®
, (
__u32
 
__u£r
 *)
d©­
);

1210 
PTRACE_POKEUSR
:

1211 
»t
 = 
	`puŒeg32
(
chd
, 
addr
, 
d©a
);

1214 
PTRACE_GETREGS
:

1215  
	`cİy_»g£t_to_u£r
(
chd
, &
u£r_x86_32_v›w
,

1216 
REGSET_GENERAL
,

1217 0, (
u£r_»gs_¡ruù32
),

1218 
d©­
);

1220 
PTRACE_SETREGS
:

1221  
	`cİy_»g£t_äom_u£r
(
chd
, &
u£r_x86_32_v›w
,

1222 
REGSET_GENERAL
, 0,

1223 (
u£r_»gs_¡ruù32
),

1224 
d©­
);

1226 
PTRACE_GETFPREGS
:

1227  
	`cİy_»g£t_to_u£r
(
chd
, &
u£r_x86_32_v›w
,

1228 
REGSET_FP
, 0,

1229 (
u£r_i387_Ÿ32_¡ruù
),

1230 
d©­
);

1232 
PTRACE_SETFPREGS
:

1233  
	`cİy_»g£t_äom_u£r
(

1234 
chd
, &
u£r_x86_32_v›w
, 
REGSET_FP
,

1235 0, (
u£r_i387_Ÿ32_¡ruù
), 
d©­
);

1237 
PTRACE_GETFPXREGS
:

1238  
	`cİy_»g£t_to_u£r
(
chd
, &
u£r_x86_32_v›w
,

1239 
REGSET_XFP
, 0,

1240 (
u£r32_fx¤_¡ruù
),

1241 
d©­
);

1243 
PTRACE_SETFPXREGS
:

1244  
	`cİy_»g£t_äom_u£r
(
chd
, &
u£r_x86_32_v›w
,

1245 
REGSET_XFP
, 0,

1246 (
u£r32_fx¤_¡ruù
),

1247 
d©­
);

1249 
PTRACE_GET_THREAD_AREA
:

1250 
PTRACE_SET_THREAD_AREA
:

1251 #ifdeà
CONFIG_X86_PTRACE_BTS


1252 
PTRACE_BTS_CONFIG
:

1253 
PTRACE_BTS_STATUS
:

1254 
PTRACE_BTS_SIZE
:

1255 
PTRACE_BTS_GET
:

1256 
PTRACE_BTS_CLEAR
:

1257 
PTRACE_BTS_DRAIN
:

1259  
	`¬ch_±¿û
(
chd
, 
»que¡
, 
addr
, 
d©a
);

1262  
	`com·t_±¿û_»que¡
(
chd
, 
»que¡
, 
addr
, 
d©a
);

1265  
»t
;

1266 
	}
}

1270 #ifdeà
CONFIG_X86_64


1272 cÚ¡ 
u£r_»g£t
 
	gx86_64_»g£ts
[] = {

1273 [
REGSET_GENERAL
] = {

1274 .
cÜe_nÙe_ty³
 = 
NT_PRSTATUS
,

1275 .
	gn
 = (
u£r_»gs_¡ruù
) / (),

1276 .
	gsize
 = (), .
	g®ign
 = (),

1277 .
	gg‘
 = 
g’»gs_g‘
, .
	g£t
 = 
g’»gs_£t


1279 [
REGSET_FP
] = {

1280 .
cÜe_nÙe_ty³
 = 
NT_PRFPREG
,

1281 .
	gn
 = (
u£r_i387_¡ruù
) / (),

1282 .
	gsize
 = (), .
	g®ign
 = (),

1283 .
	gaùive
 = 
xå»gs_aùive
, .
	gg‘
 = 
xå»gs_g‘
, .
	g£t
 = 
xå»gs_£t


1285 [
REGSET_IOPERM64
] = {

1286 .
cÜe_nÙe_ty³
 = 
NT_386_IOPERM
,

1287 .
	gn
 = 
IO_BITMAP_LONGS
,

1288 .
	gsize
 = (), .
	g®ign
 = (),

1289 .
	gaùive
 = 
iİ”m_aùive
, .
	gg‘
 = 
iİ”m_g‘


1293 cÚ¡ 
u£r_»g£t_v›w
 
	gu£r_x86_64_v›w
 = {

1294 .
Çme
 = "x86_64", .
	ge_machše
 = 
EM_X86_64
,

1295 .
	g»g£ts
 = 
x86_64_»g£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1300 
	#u£r_»gs_¡ruù32
 
u£r_»gs_¡ruù


	)

1301 
	#g’»gs32_g‘
 
g’»gs_g‘


	)

1302 
	#g’»gs32_£t
 
g’»gs_£t


	)

1304 
	#u£r_i387_Ÿ32_¡ruù
 
u£r_i387_¡ruù


	)

1305 
	#u£r32_fx¤_¡ruù
 
u£r_fx¤_¡ruù


	)

1309 #ià
defšed
 
CONFIG_X86_32
 || defšed 
CONFIG_IA32_EMULATION


1310 cÚ¡ 
u£r_»g£t
 
	gx86_32_»g£ts
[] = {

1311 [
REGSET_GENERAL
] = {

1312 .
cÜe_nÙe_ty³
 = 
NT_PRSTATUS
,

1313 .
	gn
 = (
u£r_»gs_¡ruù32
è/ (
u32
),

1314 .
	gsize
 = (
u32
), .
	g®ign
 = (u32),

1315 .
	gg‘
 = 
g’»gs32_g‘
, .
	g£t
 = 
g’»gs32_£t


1317 [
REGSET_FP
] = {

1318 .
cÜe_nÙe_ty³
 = 
NT_PRFPREG
,

1319 .
	gn
 = (
u£r_i387_Ÿ32_¡ruù
è/ (
u32
),

1320 .
	gsize
 = (
u32
), .
	g®ign
 = (u32),

1321 .
	gaùive
 = 
å»gs_aùive
, .
	gg‘
 = 
å»gs_g‘
, .
	g£t
 = 
å»gs_£t


1323 [
REGSET_XFP
] = {

1324 .
cÜe_nÙe_ty³
 = 
NT_PRXFPREG
,

1325 .
	gn
 = (
u£r32_fx¤_¡ruù
è/ (
u32
),

1326 .
	gsize
 = (
u32
), .
	g®ign
 = (u32),

1327 .
	gaùive
 = 
xå»gs_aùive
, .
	gg‘
 = 
xå»gs_g‘
, .
	g£t
 = 
xå»gs_£t


1329 [
REGSET_TLS
] = {

1330 .
cÜe_nÙe_ty³
 = 
NT_386_TLS
,

1331 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbŸs
 = 
GDT_ENTRY_TLS_MIN
,

1332 .
	gsize
 = (
u£r_desc
),

1333 .
	g®ign
 = (
u£r_desc
),

1334 .
	gaùive
 = 
»g£t_s_aùive
,

1335 .
	gg‘
 = 
»g£t_s_g‘
, .
	g£t
 = 
»g£t_s_£t


1337 [
REGSET_IOPERM32
] = {

1338 .
cÜe_nÙe_ty³
 = 
NT_386_IOPERM
,

1339 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1340 .
	gsize
 = (
u32
), .
	g®ign
 = (u32),

1341 .
	gaùive
 = 
iİ”m_aùive
, .
	gg‘
 = 
iİ”m_g‘


1345 cÚ¡ 
u£r_»g£t_v›w
 
	gu£r_x86_32_v›w
 = {

1346 .
Çme
 = "i386", .
	ge_machše
 = 
EM_386
,

1347 .
	g»g£ts
 = 
x86_32_»g£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1351 cÚ¡ 
u£r_»g£t_v›w
 *
	$sk_u£r_»g£t_v›w
(
sk_¡ruù
 *
sk
)

1353 #ifdeà
CONFIG_IA32_EMULATION


1354 ià(
	`‹¡_tsk_th»ad_æag
(
sk
, 
TIF_IA32
))

1356 #ià
defšed
 
CONFIG_X86_32
 || defšed 
CONFIG_IA32_EMULATION


1357  &
u£r_x86_32_v›w
;

1359 #ifdeà
CONFIG_X86_64


1360  &
u£r_x86_64_v›w
;

1362 
	}
}

1364 
	$£nd_sigŒ­
(
sk_¡ruù
 *
tsk
, 
±_»gs
 *
»gs
,

1365 
”rÜ_code
, 
si_code
)

1367 
sigšfo
 
šfo
;

1369 
tsk
->
th»ad
.
Œ­_no
 = 1;

1370 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

1372 
	`mem£t
(&
šfo
, 0, (info));

1373 
šfo
.
si_signo
 = 
SIGTRAP
;

1374 
šfo
.
si_code
 = si_code;

1377 
šfo
.
si_addr
 = 
	`u£r_mode_vm
(
»gs
è? (
__u£r
 *è»gs->

 : 
NULL
;

1380 
	`fÜû_sig_šfo
(
SIGTRAP
, &
šfo
, 
tsk
);

1381 
	}
}

1384 #ifdeà
CONFIG_X86_32


1385 
	#IS_IA32
 1

	)

1386 #–ià
defšed
 
CONFIG_IA32_EMULATION


1387 
	#IS_IA32
 
	`is_com·t_sk
()

	)

1389 
	#IS_IA32
 0

	)

1396 
asm»g·rm
 
	$sysÿÎ_Œaû_’‹r
(
±_»gs
 *
»gs
)

1398 
»t
 = 0;

1407 ià(
	`‹¡_th»ad_æag
(
TIF_SINGLESTEP
))

1408 
»gs
->
æags
 |ğ
X86_EFLAGS_TF
;

1411 
	`£cu»_computšg
(
»gs
->
Üig_ax
);

1413 ià(
	`uÆik–y
(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_EMU
)))

1414 
»t
 = -1L;

1416 ià((
»t
 || 
	`‹¡_th»ad_æag
(
TIF_SYSCALL_TRACE
)) &&

1417 
	`Œaûhook_»pÜt_sysÿÎ_’Œy
(
»gs
))

1418 
»t
 = -1L;

1420 ià(
	`uÆik–y
(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_FTRACE
)))

1421 
	`á¿û_sysÿÎ_’‹r
(
»gs
);

1423 ià(
	`uÆik–y
(
cu¼’t
->
aud™_cÚ‹xt
)) {

1424 ià(
IS_IA32
)

1425 
	`aud™_sysÿÎ_’Œy
(
AUDIT_ARCH_I386
,

1426 
»gs
->
Üig_ax
,

1427 
»gs
->
bx
,„egs->
cx
,

1428 
»gs
->
dx
,„egs->
si
);

1429 #ifdeà
CONFIG_X86_64


1431 
	`aud™_sysÿÎ_’Œy
(
AUDIT_ARCH_X86_64
,

1432 
»gs
->
Üig_ax
,

1433 
»gs
->
di
,„egs->
si
,

1434 
»gs
->
dx
,„egs->
r10
);

1438  
»t
 ?: 
»gs
->
Üig_ax
;

1439 
	}
}

1441 
asm»g·rm
 
	$sysÿÎ_Œaû_Ëave
(
±_»gs
 *
»gs
)

1443 ià(
	`uÆik–y
(
cu¼’t
->
aud™_cÚ‹xt
))

1444 
	`aud™_sysÿÎ_ex™
(
	`AUDITSC_RESULT
(
»gs
->
ax
),„egs->ax);

1446 ià(
	`uÆik–y
(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_FTRACE
)))

1447 
	`á¿û_sysÿÎ_ex™
(
»gs
);

1449 ià(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_TRACE
))

1450 
	`Œaûhook_»pÜt_sysÿÎ_ex™
(
»gs
, 0);

1458 ià(
	`uÆik–y
(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_EMU
)))

1465 ià(
	`‹¡_th»ad_æag
(
TIF_SINGLESTEP
) &&

1466 
	`Œaûhook_cÚsid”_çl_sigÇl
(
cu¼’t
, 
SIGTRAP
))

1467 
	`£nd_sigŒ­
(
cu¼’t
, 
»gs
, 0, 
TRAP_BRKPT
);

1468 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<lšux/pci.h
>

5 
	~<lšux/œq.h
>

7 
	~<asm/h³t.h
>

9 #ià
defšed
(
CONFIG_X86_IO_APIC
è&& defšed(
CONFIG_SMP
è&& defšed(
CONFIG_PCI
)

11 
__devš™
 
	$quœk_š‹l_œqb®ªû
(
pci_dev
 *
dev
)

13 
u8
 
cÚfig
, 
»v
;

14 
u16
 
wÜd
;

21 
	`pci_»ad_cÚfig_by‹
(
dev
, 
PCI_CLASS_REVISION
, &
»v
);

22 ià(
»v
 > 0x9)

26 
	`pci_»ad_cÚfig_by‹
(
dev
, 0xf4, &
cÚfig
);

27 
	`pci_wr™e_cÚfig_by‹
(
dev
, 0xf4, 
cÚfig
|0x2);

33 
	`pci_bus_»ad_cÚfig_wÜd
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
wÜd
);

35 ià(!(
wÜd
 & (1 << 13))) {

36 
	`dev_šfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noœqdebug_£tup
("");

39 #ifdeà
CONFIG_PROC_FS


40 
no_œq_affš™y
 = 1;

45 ià(!(
cÚfig
 & 0x2))

46 
	`pci_wr™e_cÚfig_by‹
(
dev
, 0xf4, 
cÚfig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quœk_š‹l_œqb®ªû
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quœk_š‹l_œqb®ªû
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quœk_š‹l_œqb®ªû
);

56 #ià
defšed
(
CONFIG_HPET_TIMER
)

57 
	gfÜû_h³t_add»ss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gfÜû_h³t_»sume_ty³
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_fÜû_h³t_»sume
()

72 
u32
 
v®
;

74 ià(!
fÜû_h³t_add»ss
)

77 
	`BUG_ON
(
rcba_ba£
 =ğ
NULL
);

80 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

81 ià(!(
v®
 & 0x80)) {

83 
	`wr™–
(
v®
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

87 ià(!(
v®
 & 0x80))

88 
	`BUG
();

90 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

93 
	}
}

95 
	$ich_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

97 
u32
 
v®
;

98 
u32
 
	`unš™Ÿlized_v¬
(
rcba
);

99 
”r
 = 0;

101 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

104 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 ià(
rcba
 == 0) {

107 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`iÜem­_noÿche
(
rcba
, 0x4000);

114 ià(
rcba_ba£
 =ğ
NULL
) {

115 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

123 ià(
v®
 & 0x80) {

125 
v®
 = val & 0x3;

126 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

127 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t "

128 "0x%lx\n", 
fÜû_h³t_add»ss
);

129 
	`iounm­
(
rcba_ba£
);

134 
	`wr™–
(
v®
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

137 ià(!(
v®
 & 0x80)) {

138 
”r
 = 1;

140 
v®
 = val & 0x3;

141 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

144 ià(
”r
) {

145 
fÜû_h³t_add»ss
 = 0;

146 
	`iounm­
(
rcba_ba£
);

147 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev,

150 
fÜû_h³t_»sume_ty³
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t "

152 "0x%lx\n", 
fÜû_h³t_add»ss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_fÜû_’abË_h³t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_fÜû_’abË_h³t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_fÜû_’abË_h³t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_fÜû_’abË_h³t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_fÜû_’abË_h³t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_fÜû_’abË_h³t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_fÜû_’abË_h³t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_fÜû_’abË_h³t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_fÜû_’abË_h³t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_fÜû_’abË_h³t
);

177 
pci_dev
 *
	gÿched_dev
;

179 
	$h³t_´št_fÜû_šfo
()

181 
	`´štk
(
KERN_INFO
 "HPET‚otƒnabled in BIOS. "

183 
	}
}

185 
	$Şd_ich_fÜû_h³t_»sume
()

187 
u32
 
v®
;

188 
u32
 
	`unš™Ÿlized_v¬
(
g’_ú
);

190 ià(!
fÜû_h³t_add»ss
 || !
ÿched_dev
)

193 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, &
g’_ú
);

194 
g’_ú
 &= (~(0x7 << 15));

195 
g’_ú
 |= (0x4 << 15);

197 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, 
g’_ú
);

198 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, &
g’_ú
);

199 
v®
 = 
g’_ú
 >> 15;

200 
v®
 &= 0x7;

201 ià(
v®
 == 0x4)

202 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

204 
	`BUG
();

205 
	}
}

207 
	$Şd_ich_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

209 
u32
 
v®
;

210 
u32
 
	`unš™Ÿlized_v¬
(
g’_ú
);

212 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

215 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xD0, &
g’_ú
);

220 
v®
 = 
g’_ú
 >> 15;

221 
v®
 &= 0x7;

222 ià(
v®
 & 0x4) {

223 
v®
 &= 0x3;

224 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

225 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "HPET‡t 0x%lx\n",

226 
fÜû_h³t_add»ss
);

234 
g’_ú
 &= (~(0x7 << 15));

235 
g’_ú
 |= (0x4 << 15);

236 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0xD0, 
g’_ú
);

238 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xD0, &
g’_ú
);

240 
v®
 = 
g’_ú
 >> 15;

241 
v®
 &= 0x7;

242 ià(
v®
 & 0x4) {

244 
v®
 &= 0x3;

245 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

246 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t "

247 "0x%lx\n", 
fÜû_h³t_add»ss
);

248 
ÿched_dev
 = 
dev
;

249 
fÜû_h³t_»sume_ty³
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Failedo forceƒnable HPET\n");

254 
	}
}

260 
	$Şd_ich_fÜû_’abË_h³t_u£r
(
pci_dev
 *
dev
)

262 ià(
h³t_fÜû_u£r
)

263 
	`Şd_ich_fÜû_’abË_h³t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
Şd_ich_fÜû_’abË_h³t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
Şd_ich_fÜû_’abË_h³t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
Şd_ich_fÜû_’abË_h³t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
Şd_ich_fÜû_’abË_h³t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
Şd_ich_fÜû_’abË_h³t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
Şd_ich_fÜû_’abË_h³t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
Şd_ich_fÜû_’abË_h³t
);

282 
	$vt8237_fÜû_h³t_»sume
()

284 
u32
 
v®
;

286 ià(!
fÜû_h³t_add»ss
 || !
ÿched_dev
)

289 
v®
 = 0xfed00000 | 0x80;

290 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0x68, 
v®
);

292 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0x68, &
v®
);

293 ià(
v®
 & 0x80)

294 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

301 
u32
 
	`unš™Ÿlized_v¬
(
v®
);

303 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

306 ià(!
h³t_fÜû_u£r
) {

307 
	`h³t_´št_fÜû_šfo
();

311 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x68, &
v®
);

316 ià(
v®
 & 0x80) {

317 
fÜû_h³t_add»ss
 = (
v®
 & ~0x3ff);

318 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "HPET‡t 0x%lx\n",

319 
fÜû_h³t_add»ss
);

327 
v®
 = 0xfed00000 | 0x80;

328 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x68, 
v®
);

330 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x68, &
v®
);

331 ià(
v®
 & 0x80) {

332 
fÜû_h³t_add»ss
 = (
v®
 & ~0x3ff);

333 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t "

334 "0x%lx\n", 
fÜû_h³t_add»ss
);

335 
ÿched_dev
 = 
dev
;

336 
fÜû_h³t_»sume_ty³
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Failedo forceƒnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_fÜû_’abË_h³t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_fÜû_’abË_h³t
);

348 
	$©i_fÜû_h³t_»sume
()

350 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0x14, 0xfed00000);

351 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_»v
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_»ad_cÚfig_by‹
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wr™e_cÚfig_by‹
(
dev
, 0xac, 
b
);

362 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x70, 
d
);

365 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0„evisiÚ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
v®
;

374 
u8
 
b
;

376 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

379 ià(!
h³t_fÜû_u£r
) {

380 
	`h³t_´št_fÜû_šfo
();

384 
d
 = 
	`©i_ixp4x0_»v
(
dev
);

385 ià(
d
 < 0x82)

389 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x14, 0xfed00000);

390 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x14, &
v®
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`šb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`šb
(0xcd7);

397 ià(!(
b
 & 0x1))

399 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x64, 
d
);

402 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x64, &
d
);

403 ià(!(
d
 & (1<<10)))

406 
fÜû_h³t_add»ss
 = 
v®
;

407 
fÜû_h³t_»sume_ty³
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t 0x%lx\n",

409 
fÜû_h³t_add»ss
);

410 
ÿched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_fÜû_’abË_h³t
);

418 
	$nvidŸ_fÜû_h³t_»sume
()

420 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0x44, 0xfed00001);

421 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

422 
	}
}

424 
	$nvidŸ_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

426 
u32
 
	`unš™Ÿlized_v¬
(
v®
);

428 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

431 ià(!
h³t_fÜû_u£r
) {

432 
	`h³t_´št_fÜû_šfo
();

436 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x44, 0xfed00001);

437 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x44, &
v®
);

438 
fÜû_h³t_add»ss
 = 
v®
 & 0xfffffffe;

439 
fÜû_h³t_»sume_ty³
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_´štk
(
KERN_DEBUG
, &
dev
->dev, "Forceƒnabled HPET‡t 0x%lx\n",

441 
fÜû_h³t_add»ss
);

442 
ÿched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidŸ_fÜû_’abË_h³t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidŸ_fÜû_’abË_h³t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidŸ_fÜû_’abË_h³t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidŸ_fÜû_’abË_h³t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidŸ_fÜû_’abË_h³t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidŸ_fÜû_’abË_h³t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidŸ_fÜû_’abË_h³t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidŸ_fÜû_’abË_h³t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidŸ_fÜû_’abË_h³t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidŸ_fÜû_’abË_h³t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidŸ_fÜû_’abË_h³t
);

472 
	$fÜû_h³t_»sume
()

474 
fÜû_h³t_»sume_ty³
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_fÜû_h³t_»sume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`Şd_ich_fÜû_h³t_»sume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_fÜû_h³t_»sume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidŸ_fÜû_h³t_»sume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_fÜû_h³t_»sume
();

493 
	}
}

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/»boÙ.h
>

3 
	~<lšux/š™.h
>

4 
	~<lšux/pm.h
>

5 
	~<lšux/efi.h
>

6 
	~<aıi/»boÙ.h
>

7 
	~<asm/io.h
>

8 
	~<asm/­ic.h
>

9 
	~<asm/desc.h
>

10 
	~<asm/h³t.h
>

11 
	~<asm/pgbË.h
>

12 
	~<asm/´Ùo.h
>

13 
	~<asm/»boÙ_fixups.h
>

14 
	~<asm/»boÙ.h
>

15 
	~<asm/pci_x86.h
>

16 
	~<asm/vœ‹xt.h
>

17 
	~<asm/ıu.h
>

19 #ifdeà
CONFIG_X86_32


20 
	~<lšux/dmi.h
>

21 
	~<lšux/ùy³.h
>

22 
	~<lšux/mc146818¹c.h
>

24 
	~<asm/iommu.h
>

30 (*
pm_pow”_off
)();

31 
	`EXPORT_SYMBOL
(
pm_pow”_off
);

33 cÚ¡ 
desc_±r
 
no_idt
 = {
	}
};

34 
	g»boÙ_mode
;

35 
»boÙ_ty³
 
	g»boÙ_ty³
 = 
BOOT_KBD
;

36 
	g»boÙ_fÜû
;

38 #ià
defšed
(
CONFIG_X86_32
è&& defšed(
CONFIG_SMP
)

39 
	g»boÙ_ıu
 = -1;

46 
	g»boÙ_em”g’cy
;

49 
boŞ
 
	gpÜt_cf9_§ã
 = 
çl£
;

63 
__š™
 
	$»boÙ_£tup
(*
¡r
)

66 *
¡r
) {

68 
»boÙ_mode
 = 0x1234;

72 
»boÙ_mode
 = 0;

75 #ifdeà
CONFIG_X86_32


76 #ifdeà
CONFIG_SMP


78 ià(
	`isdig™
(*(
¡r
+1))) {

79 
»boÙ_ıu
 = (è(*(
¡r
+1) - '0');

80 ià(
	`isdig™
(*(
¡r
+2)))

81 
»boÙ_ıu
 =„eboÙ_ıu*10 + ()(*(
¡r
+2) - '0');

96 
»boÙ_ty³
 = *
¡r
;

100 
»boÙ_fÜû
 = 1;

104 
¡r
 = 
	`¡rchr
(str, ',');

105 ià(
¡r
)

106 
¡r
++;

111 
	}
}

113 
__£tup
("»boÙ=", 
»boÙ_£tup
);

116 #ifdeà
CONFIG_X86_32


126 
__š™
 
	$£t_bios_»boÙ
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

128 ià(
»boÙ_ty³
 !ğ
BOOT_BIOS
) {

129 
»boÙ_ty³
 = 
BOOT_BIOS
;

130 
	`´štk
(
KERN_INFO
 "% £r› bßrd d‘eùed. S–eùšg BIOS-m‘hod fÜ„eboÙs.\n", 
d
->
id’t
);

133 
	}
}

135 
dmi_sy¡em_id
 
__š™d©a
 
	g»boÙ_dmi_bË
[] = {

137 .
ÿÎback
 = 
£t_bios_»boÙ
,

138 .
	gid’t
 = "Dell E520",

139 .
	gm©ches
 = {

140 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

141 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

145 .
	gÿÎback
 = 
£t_bios_»boÙ
,

146 .
	gid’t
 = "Dell PowerEdge 1300",

147 .
	gm©ches
 = {

148 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

149 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

153 .
	gÿÎback
 = 
£t_bios_»boÙ
,

154 .
	gid’t
 = "Dell PowerEdge 300",

155 .
	gm©ches
 = {

156 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

157 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

161 .
	gÿÎback
 = 
£t_bios_»boÙ
,

162 .
	gid’t
 = "Dell OptiPlex 745",

163 .
	gm©ches
 = {

164 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

165 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

169 .
	gÿÎback
 = 
£t_bios_»boÙ
,

170 .
	gid’t
 = "Dell OptiPlex 745",

171 .
	gm©ches
 = {

172 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

173 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

174 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

178 .
	gÿÎback
 = 
£t_bios_»boÙ
,

179 .
	gid’t
 = "Dell OptiPlex 745",

180 .
	gm©ches
 = {

181 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

182 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

183 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

187 .
	gÿÎback
 = 
£t_bios_»boÙ
,

188 .
	gid’t
 = "Dell OptiPlex 330",

189 .
	gm©ches
 = {

190 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

191 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

192 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

196 .
	gÿÎback
 = 
£t_bios_»boÙ
,

197 .
	gid’t
 = "Dell PowerEdge 2400",

198 .
	gm©ches
 = {

199 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

200 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

204 .
	gÿÎback
 = 
£t_bios_»boÙ
,

205 .
	gid’t
 = "Dell Precision T5400",

206 .
	gm©ches
 = {

207 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

208 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

212 .
	gÿÎback
 = 
£t_bios_»boÙ
,

213 .
	gid’t
 = "HP Compaq Laptop",

214 .
	gm©ches
 = {

215 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

216 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

220 .
	gÿÎback
 = 
£t_bios_»boÙ
,

221 .
	gid’t
 = "Dell XPS710",

222 .
	gm©ches
 = {

223 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

224 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

228 .
	gÿÎback
 = 
£t_bios_»boÙ
,

229 .
	gid’t
 = "Dell DXP061",

230 .
	gm©ches
 = {

231 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

232 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

236 .
	gÿÎback
 = 
£t_bios_»boÙ
,

237 .
	gid’t
 = "Sony VGN-Z540N",

238 .
	gm©ches
 = {

239 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

240 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

246 
__š™
 
	$»boÙ_š™
()

248 
	`dmi_check_sy¡em
(
»boÙ_dmi_bË
);

250 
	}
}

251 
cÜe_š™ÿÎ
(
»boÙ_š™
);

260 
	g»®_mode_gdt_’Œ›s
 [3] =

267 cÚ¡ 
desc_±r


268 
	g»®_mode_gdt
 = {  (
»®_mode_gdt_’Œ›s
) - 1, ()real_mode_gdt_entries },

269 
	g»®_mode_idt
 = { 0x3ff, 0 };

289 cÚ¡ 
	g»®_mode_sw™ch
 [] =

303 cÚ¡ 
	gjump_to_bios
 [] =

313 
	$machše_»®_»¡¬t
(cÚ¡ *
code
, 
Ëngth
)

315 
	`loÿl_œq_di§bË
();

326 
	`¥š_lock
(&
¹c_lock
);

327 
	`CMOS_WRITE
(0x00, 0x8f);

328 
	`¥š_uÆock
(&
¹c_lock
);

333 
	`memıy
(
sw­³r_pg_dœ
, sw­³r_pg_dœ + 
KERNEL_PGD_BOUNDARY
,

334 (
sw­³r_pg_dœ
 [0]è* 
KERNEL_PGD_PTRS
);

339 
	`lßd_ü3
(
sw­³r_pg_dœ
);

346 *((*)0x472èğ
»boÙ_mode
;

353 
	`memıy
((*)(0x1000 - (
»®_mode_sw™ch
) - 100),

354 
»®_mode_sw™ch
,  (real_mode_switch));

355 
	`memıy
((*)(0x1000 - 100), 
code
, 
Ëngth
);

358 
	`lßd_idt
(&
»®_mode_idt
);

363 
	`lßd_gdt
(&
»®_mode_gdt
);

370 
__asm__
 
	`__vŞ©e__
 ("movl $0x0010,%%eax\n"

380 
__asm__
 
	`__vŞ©e__
 ("ljmp $0x0008,%0"

382 : "i" ((*)(0x1000 -  (
»®_mode_sw™ch
) - 100)));

383 
	}
}

384 #ifdeà
CONFIG_APM_MODULE


385 
EXPORT_SYMBOL
(
machše_»®_»¡¬t
);

390 
šlše
 
	$kb_wa™
()

392 
i
;

394 
i
 = 0; i < 0x10000; i++) {

395 ià((
	`šb
(0x64) & 0x02) == 0)

397 
	`ud–ay
(2);

399 
	}
}

401 
	$vmxoff_nmi
(
ıu
, 
d›_¬gs
 *
¬gs
)

403 
	`ıu_em”g’cy_vmxoff
();

404 
	}
}

408 
	$em”g’cy_vmx_di§bË_®l
()

411 
	`loÿl_œq_di§bË
();

431 ià(
	`ıu_has_vmx
(è&& 
	`ıu_vmx_’abËd
()) {

434 
	`ıu_vmxoff
();

437 
	`nmi_shoÙdown_ıus
(
vmxoff_nmi
);

440 
	}
}

443 
__©Œibu‹__
((
w—k
)è
	$mach_»boÙ_fixups
()

445 
	}
}

447 
	$Çtive_machše_em”g’cy_»¡¬t
()

449 
i
;

451 ià(
»boÙ_em”g’cy
)

452 
	`em”g’cy_vmx_di§bË_®l
();

455 *((*)
	`__va
(0x472)èğ
»boÙ_mode
;

459 
»boÙ_ty³
) {

460 
BOOT_KBD
:

461 
	`mach_»boÙ_fixups
();

463 
i
 = 0; i < 10; i++) {

464 
	`kb_wa™
();

465 
	`ud–ay
(50);

466 
	`outb
(0xfe, 0x64);

467 
	`ud–ay
(50);

470 
BOOT_TRIPLE
:

471 
	`lßd_idt
(&
no_idt
);

472 
__asm__
 
	`__vŞ©e__
("int3");

474 
»boÙ_ty³
 = 
BOOT_KBD
;

477 #ifdeà
CONFIG_X86_32


478 
BOOT_BIOS
:

479 
	`machše_»®_»¡¬t
(
jump_to_bios
, (jump_to_bios));

481 
»boÙ_ty³
 = 
BOOT_KBD
;

485 
BOOT_ACPI
:

486 
	`aıi_»boÙ
();

487 
»boÙ_ty³
 = 
BOOT_KBD
;

490 
BOOT_EFI
:

491 ià(
efi_’abËd
)

492 
efi
.
	`»£t_sy¡em
(
»boÙ_mode
 ?

493 
EFI_RESET_WARM
 :

494 
EFI_RESET_COLD
,

495 
EFI_SUCCESS
, 0, 
NULL
);

496 
»boÙ_ty³
 = 
BOOT_KBD
;

499 
BOOT_CF9
:

500 
pÜt_cf9_§ã
 = 
Œue
;

503 
BOOT_CF9_COND
:

504 ià(
pÜt_cf9_§ã
) {

505 
u8
 
cf9
 = 
	`šb
(0xcf9) & ~6;

506 
	`outb
(
cf9
|2, 0xcf9);

507 
	`ud–ay
(50);

508 
	`outb
(
cf9
|6, 0xcf9);

509 
	`ud–ay
(50);

511 
»boÙ_ty³
 = 
BOOT_KBD
;

515 
	}
}

517 
	$Çtive_machše_shutdown
()

520 #ifdeà
CONFIG_SMP


523 
»boÙ_ıu_id
 = 0;

525 #ifdeà
CONFIG_X86_32


527 ià((
»boÙ_ıu
 !ğ-1è&& (»boÙ_ıu < 
Ä_ıu_ids
) &&

528 
	`ıu_Úlše
(
»boÙ_ıu
))

529 
»boÙ_ıu_id
 = 
»boÙ_ıu
;

533 ià(!
	`ıu_Úlše
(
»boÙ_ıu_id
))

534 
»boÙ_ıu_id
 = 
	`smp_´oûssÜ_id
();

537 
	`£t_ıus_®lowed_±r
(
cu¼’t
, 
	`ıumask_of
(
»boÙ_ıu_id
));

542 
	`smp_£nd_¡İ
();

545 
	`Ïpic_shutdown
();

547 #ifdeà
CONFIG_X86_IO_APIC


548 
	`di§bË_IO_APIC
();

551 #ifdeà
CONFIG_HPET_TIMER


552 
	`h³t_di§bË
();

555 #ifdeà
CONFIG_X86_64


556 
	`pci_iommu_shutdown
();

558 
	}
}

560 
	$__machše_em”g’cy_»¡¬t
(
em”g’cy
)

562 
»boÙ_em”g’cy
 = 
em”g’cy
;

563 
machše_İs
.
	`em”g’cy_»¡¬t
();

564 
	}
}

566 
	$Çtive_machše_»¡¬t
(*
__unu£d
)

568 
	`´štk
("machine„estart\n");

570 ià(!
»boÙ_fÜû
)

571 
	`machše_shutdown
();

572 
	`__machše_em”g’cy_»¡¬t
(0);

573 
	}
}

575 
	$Çtive_machše_h®t
()

578 
	`machše_shutdown
();

581 
	`¡İ_this_ıu
(
NULL
);

582 
	}
}

584 
	$Çtive_machše_pow”_off
()

586 ià(
pm_pow”_off
) {

587 ià(!
»boÙ_fÜû
)

588 
	`machše_shutdown
();

589 
	`pm_pow”_off
();

591 
	}
}

593 
machše_İs
 
	gmachše_İs
 = {

594 .
pow”_off
 = 
Çtive_machše_pow”_off
,

595 .
	gshutdown
 = 
Çtive_machše_shutdown
,

596 .
	gem”g’cy_»¡¬t
 = 
Çtive_machše_em”g’cy_»¡¬t
,

597 .
	g»¡¬t
 = 
Çtive_machše_»¡¬t
,

598 .
	gh®t
 = 
Çtive_machše_h®t
,

599 #ifdeà
CONFIG_KEXEC


600 .
	güash_shutdown
 = 
Çtive_machše_üash_shutdown
,

604 
	$machše_pow”_off
()

606 
machše_İs
.
	`pow”_off
();

607 
	}
}

609 
	$machše_shutdown
()

611 
machše_İs
.
	`shutdown
();

612 
	}
}

614 
	$machše_em”g’cy_»¡¬t
()

616 
	`__machše_em”g’cy_»¡¬t
(1);

617 
	}
}

619 
	$machše_»¡¬t
(*
cmd
)

621 
machše_İs
.
	`»¡¬t
(
cmd
);

622 
	}
}

624 
	$machše_h®t
()

626 
machše_İs
.
	`h®t
();

627 
	}
}

629 #ifdeà
CONFIG_KEXEC


630 
	$machše_üash_shutdown
(
±_»gs
 *
»gs
)

632 
machše_İs
.
	`üash_shutdown
(
»gs
);

633 
	}
}

637 #ià
defšed
(
CONFIG_SMP
)

640 
	güashšg_ıu
;

641 
nmi_shoÙdown_cb
 
	gshoÙdown_ÿÎback
;

643 
©omic_t
 
	gwa™šg_fÜ_üash_i
;

645 
	$üash_nmi_ÿÎback
(
nÙif›r_block
 *
£lf
,

646 
v®
, *
d©a
)

648 
ıu
;

650 ià(
v®
 !ğ
DIE_NMI_IPI
)

651  
NOTIFY_OK
;

653 
ıu
 = 
	`¿w_smp_´oûssÜ_id
();

659 ià(
ıu
 =ğ
üashšg_ıu
)

660  
NOTIFY_STOP
;

661 
	`loÿl_œq_di§bË
();

663 
	`shoÙdown_ÿÎback
(
ıu
, (
d›_¬gs
 *)
d©a
);

665 
	`©omic_dec
(&
wa™šg_fÜ_üash_i
);

667 
	`h®t
();

669 
	`ıu_»Ïx
();

672 
	}
}

674 
	$smp_£nd_nmi_®lbut£lf
()

676 
­ic
->
	`£nd_IPI_®lbut£lf
(
NMI_VECTOR
);

677 
	}
}

679 
nÙif›r_block
 
	güash_nmi_nb
 = {

680 .
nÙif›r_ÿÎ
 = 
üash_nmi_ÿÎback
,

689 
	$nmi_shoÙdown_ıus
(
nmi_shoÙdown_cb
 
ÿÎback
)

691 
m£cs
;

692 
	`loÿl_œq_di§bË
();

695 
üashšg_ıu
 = 
	`§ã_smp_´oûssÜ_id
();

697 
shoÙdown_ÿÎback
 = 
ÿÎback
;

699 
	`©omic_£t
(&
wa™šg_fÜ_üash_i
, 
	`num_Úlše_ıus
() - 1);

701 ià(
	`»gi¡”_d›_nÙif›r
(&
üash_nmi_nb
))

706 
	`wmb
();

708 
	`smp_£nd_nmi_®lbut£lf
();

710 
m£cs
 = 1000;

711 (
	`©omic_»ad
(&
wa™šg_fÜ_üash_i
è> 0è&& 
m£cs
) {

712 
	`md–ay
(1);

713 
m£cs
--;

717 
	}
}

719 
	$nmi_shoÙdown_ıus
(
nmi_shoÙdown_cb
 
ÿÎback
)

722 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<lšux/¶©fÜm_deviû.h
>

5 
	~<lšux/mc146818¹c.h
>

6 
	~<lšux/aıi.h
>

7 
	~<lšux/bcd.h
>

8 
	~<lšux/²p.h
>

10 
	~<asm/vsysÿÎ.h
>

11 
	~<asm/time.h
>

13 #ifdeà
CONFIG_X86_32


19 vŞ©
	gcmos_lock
;

20 
EXPORT_SYMBOL
(
cmos_lock
);

24 
	#CMOS_YEARS_OFFS
 2000

	)

26 
DEFINE_SPINLOCK
(
¹c_lock
);

27 
EXPORT_SYMBOL
(
¹c_lock
);

39 
	$mach_£t_¹c_mmss
(
nowtime
)

41 
»®_£cÚds
, 
»®_mšu‹s
, 
cmos_mšu‹s
;

42 
§ve_cÚŒŞ
, 
§ve_äeq_£Ëù
;

43 
»tv®
 = 0;

46 
§ve_cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

47 
	`CMOS_WRITE
((
§ve_cÚŒŞ
|
RTC_SET
), 
RTC_CONTROL
);

50 
§ve_äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

51 
	`CMOS_WRITE
((
§ve_äeq_£Ëù
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

53 
cmos_mšu‹s
 = 
	`CMOS_READ
(
RTC_MINUTES
);

54 ià(!(
§ve_cÚŒŞ
 & 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
)

55 
cmos_mšu‹s
 = 
	`bcd2bš
(cmos_minutes);

63 
»®_£cÚds
 = 
nowtime
 % 60;

64 
»®_mšu‹s
 = 
nowtime
 / 60;

66 ià(((
	`abs
(
»®_mšu‹s
 - 
cmos_mšu‹s
) + 15)/30) & 1)

67 
»®_mšu‹s
 += 30;

68 
»®_mšu‹s
 %= 60;

70 ià(
	`abs
(
»®_mšu‹s
 - 
cmos_mšu‹s
) < 30) {

71 ià(!(
§ve_cÚŒŞ
 & 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
) {

72 
»®_£cÚds
 = 
	`bš2bcd
(real_seconds);

73 
»®_mšu‹s
 = 
	`bš2bcd
(real_minutes);

75 
	`CMOS_WRITE
(
»®_£cÚds
, 
RTC_SECONDS
);

76 
	`CMOS_WRITE
(
»®_mšu‹s
, 
RTC_MINUTES
);

78 
	`´štk
(
KERN_WARNING


80 
cmos_mšu‹s
, 
»®_mšu‹s
);

81 
»tv®
 = -1;

91 
	`CMOS_WRITE
(
§ve_cÚŒŞ
, 
RTC_CONTROL
);

92 
	`CMOS_WRITE
(
§ve_äeq_£Ëù
, 
RTC_FREQ_SELECT
);

94  
»tv®
;

95 
	}
}

97 
	$mach_g‘_cmos_time
()

99 
¡©us
, 
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
, 
ûÁury
 = 0;

107 (
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
))

108 
	`ıu_»Ïx
();

110 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

111 
mš
 = 
	`CMOS_READ
(
RTC_MINUTES
);

112 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

113 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

114 
mÚ
 = 
	`CMOS_READ
(
RTC_MONTH
);

115 
y—r
 = 
	`CMOS_READ
(
RTC_YEAR
);

117 #ifdeà
CONFIG_ACPI


118 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
 &&

119 
aıi_gbl_FADT
.
ûÁury
)

120 
ûÁury
 = 
	`CMOS_READ
(
aıi_gbl_FADT
.century);

123 
¡©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

124 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
¡©us
 & 
RTC_DM_BINARY
));

126 ià(
RTC_ALWAYS_BCD
 || !(
¡©us
 & 
RTC_DM_BINARY
)) {

127 
£c
 = 
	`bcd2bš
(sec);

128 
mš
 = 
	`bcd2bš
(min);

129 
hour
 = 
	`bcd2bš
(hour);

130 
day
 = 
	`bcd2bš
(day);

131 
mÚ
 = 
	`bcd2bš
(mon);

132 
y—r
 = 
	`bcd2bš
(year);

135 ià(
ûÁury
) {

136 
ûÁury
 = 
	`bcd2bš
(century);

137 
y—r
 +ğ
ûÁury
 * 100;

138 
	`´štk
(
KERN_INFO
 "Ex‹nded CMOS y—r: %d\n", 
ûÁury
 * 100);

140 
y—r
 +ğ
CMOS_YEARS_OFFS
;

142  
	`mktime
(
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
);

143 
	}
}

146 
	$¹c_cmos_»ad
(
addr
)

148 
v®
;

150 
	`lock_cmos_´efix
(
addr
);

151 
	`outb
(
addr
, 
	`RTC_PORT
(0));

152 
v®
 = 
	`šb
(
	`RTC_PORT
(1));

153 
	`lock_cmos_suffix
(
addr
);

155  
v®
;

156 
	}
}

157 
EXPORT_SYMBOL
(
¹c_cmos_»ad
);

159 
	$¹c_cmos_wr™e
(
v®
, 
addr
)

161 
	`lock_cmos_´efix
(
addr
);

162 
	`outb
(
addr
, 
	`RTC_PORT
(0));

163 
	`outb
(
v®
, 
	`RTC_PORT
(1));

164 
	`lock_cmos_suffix
(
addr
);

165 
	}
}

166 
EXPORT_SYMBOL
(
¹c_cmos_wr™e
);

168 
	$£t_¹c_mmss
(
nowtime
)

170 
æags
;

171 
»tv®
;

173 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

174 
»tv®
 = 
	`£t_w®lşock
(
nowtime
);

175 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

177  
»tv®
;

178 
	}
}

181 
	$»ad_³rsi¡’t_şock
()

183 
»tv®
, 
æags
;

185 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

186 
»tv®
 = 
	`g‘_w®lşock
();

187 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

189  
»tv®
;

190 
	}
}

192 
	$upd©e_³rsi¡’t_şock
(
time¥ec
 
now
)

194  
	`£t_¹c_mmss
(
now
.
tv_£c
);

195 
	}
}

197 
	$Çtive_»ad_tsc
()

199  
	`__Çtive_»ad_tsc
();

200 
	}
}

201 
EXPORT_SYMBOL
(
Çtive_»ad_tsc
);

204 
»sourû
 
	g¹c_»sourûs
[] = {

206 .
¡¬t
 = 
RTC_PORT
(0),

207 .
	g’d
 = 
RTC_PORT
(1),

208 .
	gæags
 = 
IORESOURCE_IO
,

211 .
¡¬t
 = 
RTC_IRQ
,

212 .
	g’d
 = 
RTC_IRQ
,

213 .
	gæags
 = 
IORESOURCE_IRQ
,

217 
¶©fÜm_deviû
 
	g¹c_deviû
 = {

218 .
Çme
 = "rtc_cmos",

219 .
	gid
 = -1,

220 .
	g»sourû
 = 
¹c_»sourûs
,

221 .
	gnum_»sourûs
 = 
ARRAY_SIZE
(
¹c_»sourûs
),

224 
__š™
 
	$add_¹c_cmos
()

226 #ifdeà
CONFIG_PNP


227 cÚ¡ *
ids
[] 
__š™cÚ¡
 =

229 
²p_dev
 *
dev
;

230 
²p_id
 *
id
;

231 
i
;

233 
	`²p_fÜ_—ch_dev
(
dev
) {

234 
id
 = 
dev
->id; id; id = id->
Ãxt
) {

235 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

236 ià(
	`com·»_²p_id
(
id
, 
ids
[
i
]) != 0)

243 
	`¶©fÜm_deviû_»gi¡”
(&
¹c_deviû
);

244 
	`dev_šfo
(&
¹c_deviû
.
dev
,

248 
	}
}

249 
deviû_š™ÿÎ
(
add_¹c_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<lšux/sched.h
>

25 
	~<lšux/mm.h
>

26 
	~<lšux/mmzÚe.h
>

27 
	~<lšux/sü“n_šfo.h
>

28 
	~<lšux/iİÜt.h
>

29 
	~<lšux/aıi.h
>

30 
	~<lšux/­m_bios.h
>

31 
	~<lšux/š™rd.h
>

32 
	~<lšux/boÙmem.h
>

33 
	~<lšux/£q_fe.h
>

34 
	~<lšux/cÚsŞe.h
>

35 
	~<lšux/mÿ.h
>

36 
	~<lšux/roÙ_dev.h
>

37 
	~<lšux/highmem.h
>

38 
	~<lšux/moduË.h
>

39 
	~<lšux/efi.h
>

40 
	~<lšux/š™.h
>

41 
	~<lšux/edd.h
>

42 
	~<lšux/iscsi_ibá.h
>

43 
	~<lšux/nodemask.h
>

44 
	~<lšux/kexec.h
>

45 
	~<lšux/dmi.h
>

46 
	~<lšux/pâ.h
>

47 
	~<lšux/pci.h
>

48 
	~<asm/pci-dœeù.h
>

49 
	~<lšux/š™_ohci1394_dma.h
>

50 
	~<lšux/kvm_·¿.h
>

52 
	~<lšux/”ºo.h
>

53 
	~<lšux/k”Ãl.h
>

54 
	~<lšux/¡ddef.h
>

55 
	~<lšux/uni¡d.h
>

56 
	~<lšux/±¿û.h
>

57 
	~<lšux/¦ab.h
>

58 
	~<lšux/u£r.h
>

59 
	~<lšux/d–ay.h
>

61 
	~<lšux/k®lsyms.h
>

62 
	~<lšux/ıuäeq.h
>

63 
	~<lšux/dma-m­pšg.h
>

64 
	~<lšux/ùy³.h
>

65 
	~<lšux/uacûss.h
>

67 
	~<lšux/³rıu.h
>

68 
	~<lšux/üash_dump.h
>

70 
	~<video/edid.h
>

72 
	~<asm/mŒr.h
>

73 
	~<asm/­ic.h
>

74 
	~<asm/e820.h
>

75 
	~<asm/mp¥ec.h
>

76 
	~<asm/£tup.h
>

77 
	~<asm/efi.h
>

78 
	~<asm/tim”.h
>

79 
	~<asm/i8259.h
>

80 
	~<asm/£ùiÚs.h
>

81 
	~<asm/dmi.h
>

82 
	~<asm/io_­ic.h
>

83 
	~<asm/i¡.h
>

84 
	~<asm/vmi.h
>

85 
	~<asm/£tup_¬ch.h
>

86 
	~<asm/bios_ebda.h
>

87 
	~<asm/ÿcheæush.h
>

88 
	~<asm/´oûssÜ.h
>

89 
	~<asm/bugs.h
>

91 
	~<asm/sy¡em.h
>

92 
	~<asm/vsysÿÎ.h
>

93 
	~<asm/ıu.h
>

94 
	~<asm/desc.h
>

95 
	~<asm/dma.h
>

96 
	~<asm/iommu.h
>

97 
	~<asm/g¬t.h
>

98 
	~<asm/mmu_cÚ‹xt.h
>

99 
	~<asm/´Ùo.h
>

101 
	~<asm/·¿vœt.h
>

102 
	~<asm/hy³rvisÜ.h
>

104 
	~<asm/³rıu.h
>

105 
	~<asm/tİŞogy.h
>

106 
	~<asm/­icdef.h
>

107 #ifdeà
CONFIG_X86_64


108 
	~<asm/numa_64.h
>

111 #iâdeà
ARCH_SETUP


112 
	#ARCH_SETUP


	)

115 
RESERVE_BRK
(
dmi_®loc
, 65536);

117 
boÙ_ıu_id
 
	g__»ad_mo¡ly
;

119 
__š™d©a
 
	g_brk_¡¬t
 = ()
__brk_ba£
;

120 
	g_brk_’d
 = ()
__brk_ba£
;

122 #ifdeà
CONFIG_X86_64


123 
	$deçuÉ_ıu_´e£Á_to_­icid
(
mps_ıu
)

125  
	`__deçuÉ_ıu_´e£Á_to_­icid
(
mps_ıu
);

126 
	}
}

128 
	$deçuÉ_check_phys_­icid_´e£Á
(
boÙ_ıu_physiÿl_­icid
)

130  
	`__deçuÉ_check_phys_­icid_´e£Á
(
boÙ_ıu_physiÿl_­icid
);

131 
	}
}

134 #iâdeà
CONFIG_DEBUG_BOOT_PARAMS


135 
boÙ_·¿ms
 
__š™d©a
 
	gboÙ_·¿ms
;

137 
boÙ_·¿ms
 
	gboÙ_·¿ms
;

143 
»sourû
 
	gd©a_»sourû
 = {

144 .
Çme
 = "Kernel data",

145 .
	g¡¬t
 = 0,

146 .
	g’d
 = 0,

147 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


150 
»sourû
 
	gcode_»sourû
 = {

151 .
Çme
 = "Kernel code",

152 .
	g¡¬t
 = 0,

153 .
	g’d
 = 0,

154 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


157 
»sourû
 
	gbss_»sourû
 = {

158 .
Çme
 = "Kernel bss",

159 .
	g¡¬t
 = 0,

160 .
	g’d
 = 0,

161 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


165 #ifdeà
CONFIG_X86_32


166 
»sourû
 
	gvideo_¿m_»sourû
 = {

167 .
Çme
 = "Video RAM‡rea",

168 .
	g¡¬t
 = 0xa0000,

169 .
	g’d
 = 0xbffff,

170 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


174 
ıušfo_x86
 
Ãw_ıu_d©a
 
	g__ıuš™d©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

176 
ıušfo_x86
 
boÙ_ıu_d©a
 
	g__»ad_mo¡ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

177 
EXPORT_SYMBOL
(
boÙ_ıu_d©a
);

178 
	$£t_mÿ_bus
(
x
)

180 #ifdeà
CONFIG_MCA


181 
MCA_bus
 = 
x
;

183 
	}
}

185 
	gdef_to_bigsmp
;

188 
	gmachše_id
;

189 
	gmachše_submod–_id
;

190 
	gBIOS_»visiÚ
;

192 
­m_šfo
 
	g­m_šfo
;

193 
EXPORT_SYMBOL
(
­m_šfo
);

195 #ià
defšed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

196 
	$defšed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

197 
i¡_šfo
 ist_info;

198 
	`EXPORT_SYMBOL
(
i¡_šfo
);

200 
i¡_šfo
 ist_info;

204 
ıušfo_x86
 
boÙ_ıu_d©a
 
__»ad_mo¡ly
 = {

205 .
x86_phys_b™s
 = 
MAX_PHYSMEM_BITS
,

206 
	}
};

207 
EXPORT_SYMBOL
(
boÙ_ıu_d©a
);

211 #ià!
defšed
(
CONFIG_X86_PAE
è|| defšed(
CONFIG_X86_64
)

212 
	gmmu_ü4_ã©u»s
;

214 
	gmmu_ü4_ã©u»s
 = 
X86_CR4_PAE
;

218 
	gboÙlßd”_ty³
;

223 
sü“n_šfo
 
	gsü“n_šfo
;

224 
EXPORT_SYMBOL
(
sü“n_šfo
);

225 
edid_šfo
 
	gedid_šfo
;

226 
EXPORT_SYMBOL_GPL
(
edid_šfo
);

228 
roÙ_mouÁæags
;

230 
	g§ved_video_mode
;

232 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

233 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

234 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

236 
__š™d©a
 
	gcommªd_lše
[
COMMAND_LINE_SIZE
];

237 #ifdeà
CONFIG_CMDLINE_BOOL


238 
__š™d©a
 
	gbutš_cmdlše
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

241 #ià
defšed
(
CONFIG_EDD
è|| defšed(
CONFIG_EDD_MODULE
)

242 
edd
 
	gedd
;

243 #ifdeà
CONFIG_EDD_MODULE


244 
EXPORT_SYMBOL
(
edd
);

251 
šlše
 
	$cİy_edd
()

253 
	`memıy
(
edd
.
mbr_sigÇtu»
, 
boÙ_·¿ms
.
edd_mbr_sig_bufãr
,

254 (
edd
.
mbr_sigÇtu»
));

255 
	`memıy
(
edd
.
edd_šfo
, 
boÙ_·¿ms
.
eddbuf
, (edd.edd_info));

256 
edd
.
mbr_sigÇtu»_Ä
 = 
boÙ_·¿ms
.
edd_mbr_sig_buf_’Œ›s
;

257 
edd
.
edd_šfo_Ä
 = 
boÙ_·¿ms
.
eddbuf_’Œ›s
;

258 
	}
}

260 
šlše
 
	$cİy_edd
()

262 
	}
}

265 * 
__š™
 
	$ex‹nd_brk
(
size_t
 
size
, size_ˆ
®ign
)

267 
size_t
 
mask
 = 
®ign
 - 1;

268 *
»t
;

270 
	`BUG_ON
(
_brk_¡¬t
 == 0);

271 
	`BUG_ON
(
®ign
 & 
mask
);

273 
_brk_’d
 = (_brk_’d + 
mask
) & ~mask;

274 
	`BUG_ON
((*)(
_brk_’d
 + 
size
è> 
__brk_lim™
);

276 
»t
 = (*)
_brk_’d
;

277 
_brk_’d
 +ğ
size
;

279 
	`mem£t
(
»t
, 0, 
size
);

281  
»t
;

282 
	}
}

284 
__š™
 
	$»£rve_brk
()

286 ià(
_brk_’d
 > 
_brk_¡¬t
)

287 
	`»£rve_—¾y
(
	`__·
(
_brk_¡¬t
), __·(
_brk_’d
), "BRK");

291 
_brk_¡¬t
 = 0;

292 
	}
}

294 #ifdeà
CONFIG_BLK_DEV_INITRD


296 #ifdeà
CONFIG_X86_32


298 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

299 
__š™
 
	$»loÿ‹_š™rd
()

302 
u64
 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

303 
u64
 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

304 
u64
 
’d_of_lowmem
 = 
max_low_pâ
 << 
PAGE_SHIFT
;

305 
u64
 
¿mdisk_h”e
;

306 
¦İ
, 
ş’
, 
m­addr
;

307 *
p
, *
q
;

310 
¿mdisk_h”e
 = 
	`fšd_e820_¬—
(0, 
’d_of_lowmem
, 
¿mdisk_size
,

311 
PAGE_SIZE
);

313 ià(
¿mdisk_h”e
 == -1ULL)

314 
	`·nic
("Cannot find…lace for‚ew RAMDISK of size %lld\n",

315 
¿mdisk_size
);

319 
	`»£rve_—¾y
(
¿mdisk_h”e
,„amdisk_h”+ 
¿mdisk_size
,

321 
š™rd_¡¬t
 = 
¿mdisk_h”e
 + 
PAGE_OFFSET
;

322 
š™rd_’d
 = 
š™rd_¡¬t
 + 
¿mdisk_size
;

323 
	`´štk
(
KERN_INFO
 "Allocated‚ew RAMDISK: %08llx - %08llx\n",

324 
¿mdisk_h”e
,„amdisk_h”+ 
¿mdisk_size
);

326 
q
 = (*)
š™rd_¡¬t
;

329 ià(
¿mdisk_image
 < 
’d_of_lowmem
) {

330 
ş’
 = 
’d_of_lowmem
 - 
¿mdisk_image
;

331 
p
 = (*)
	`__va
(
¿mdisk_image
);

332 
	`memıy
(
q
, 
p
, 
ş’
);

333 
q
 +ğ
ş’
;

334 
¿mdisk_image
 +ğ
ş’
;

335 
¿mdisk_size
 -ğ
ş’
;

339 
¿mdisk_size
) {

340 
¦İ
 = 
¿mdisk_image
 & ~
PAGE_MASK
;

341 
ş’
 = 
¿mdisk_size
;

342 ià(
ş’
 > 
MAX_MAP_CHUNK
-
¦İ
)

343 
ş’
 = 
MAX_MAP_CHUNK
-
¦İ
;

344 
m­addr
 = 
¿mdisk_image
 & 
PAGE_MASK
;

345 
p
 = 
	`—¾y_mem»m­
(
m­addr
, 
ş’
+
¦İ
);

346 
	`memıy
(
q
, 
p
+
¦İ
, 
ş’
);

347 
	`—¾y_iounm­
(
p
, 
ş’
+
¦İ
);

348 
q
 +ğ
ş’
;

349 
¿mdisk_image
 +ğ
ş’
;

350 
¿mdisk_size
 -ğ
ş’
;

353 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

354 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

355 
	`´štk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxo"

357 
¿mdisk_image
,„amdisk_imag+ 
¿mdisk_size
 - 1,

358 
¿mdisk_h”e
,„amdisk_h”+ 
¿mdisk_size
 - 1);

359 
	}
}

362 
__š™
 
	$»£rve_š™rd
()

364 
u64
 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

365 
u64
 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

366 
u64
 
¿mdisk_’d
 = 
¿mdisk_image
 + 
¿mdisk_size
;

367 
u64
 
’d_of_lowmem
 = 
max_low_pâ
 << 
PAGE_SHIFT
;

369 ià(!
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
 ||

370 !
¿mdisk_image
 || !
¿mdisk_size
)

373 
š™rd_¡¬t
 = 0;

375 ià(
¿mdisk_size
 >ğ(
’d_of_lowmem
>>1)) {

376 
	`ä“_—¾y
(
¿mdisk_image
, 
¿mdisk_’d
);

377 
	`´štk
(
KERN_ERR
 "initrdoo†argeo handle, "

382 
	`´štk
(
KERN_INFO
 "RAMDISK: %08Îx - %08Îx\n", 
¿mdisk_image
,

383 
¿mdisk_’d
);

386 ià(
¿mdisk_’d
 <ğ
’d_of_lowmem
) {

392 
š™rd_¡¬t
 = 
¿mdisk_image
 + 
PAGE_OFFSET
;

393 
š™rd_’d
 = 
š™rd_¡¬t
 + 
¿mdisk_size
;

397 #ifdeà
CONFIG_X86_32


398 
	`»loÿ‹_š™rd
();

400 
	`´štk
(
KERN_ERR
 "initrdƒxtends beyondƒnd of memory "

402 
¿mdisk_’d
, 
’d_of_lowmem
);

403 
š™rd_¡¬t
 = 0;

405 
	`ä“_—¾y
(
¿mdisk_image
, 
¿mdisk_’d
);

406 
	}
}

408 
__š™
 
	$»£rve_š™rd
()

410 
	}
}

413 
__š™
 
	$·r£_£tup_d©a
()

415 
£tup_d©a
 *
d©a
;

416 
u64
 
·_d©a
;

418 ià(
boÙ_·¿ms
.
hdr
.
v”siÚ
 < 0x0209)

420 
·_d©a
 = 
boÙ_·¿ms
.
hdr
.
£tup_d©a
;

421 
·_d©a
) {

422 
d©a
 = 
	`—¾y_mem»m­
(
·_d©a
, 
PAGE_SIZE
);

423 
d©a
->
ty³
) {

424 
SETUP_E820_EXT
:

425 
	`·r£_e820_ext
(
d©a
, 
·_d©a
);

430 
·_d©a
 = 
d©a
->
Ãxt
;

431 
	`—¾y_iounm­
(
d©a
, 
PAGE_SIZE
);

433 
	}
}

435 
__š™
 
	$e820_»£rve_£tup_d©a
()

437 
£tup_d©a
 *
d©a
;

438 
u64
 
·_d©a
;

439 
found
 = 0;

441 ià(
boÙ_·¿ms
.
hdr
.
v”siÚ
 < 0x0209)

443 
·_d©a
 = 
boÙ_·¿ms
.
hdr
.
£tup_d©a
;

444 
·_d©a
) {

445 
d©a
 = 
	`—¾y_mem»m­
(
·_d©a
, (*data));

446 
	`e820_upd©e_¿nge
(
·_d©a
, (*
d©a
)+d©a->
Ën
,

447 
E820_RAM
, 
E820_RESERVED_KERN
);

448 
found
 = 1;

449 
·_d©a
 = 
d©a
->
Ãxt
;

450 
	`—¾y_iounm­
(
d©a
, (*data));

452 ià(!
found
)

455 
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &e820.
Ä_m­
);

456 
	`memıy
(&
e820_§ved
, &
e820
, (
e820m­
));

457 
	`´štk
(
KERN_INFO
 "extended…hysical RAM map:\n");

458 
	`e820_´št_m­
("reserve setup_data");

459 
	}
}

461 
__š™
 
	$»£rve_—¾y_£tup_d©a
()

463 
£tup_d©a
 *
d©a
;

464 
u64
 
·_d©a
;

465 
buf
[32];

467 ià(
boÙ_·¿ms
.
hdr
.
v”siÚ
 < 0x0209)

469 
·_d©a
 = 
boÙ_·¿ms
.
hdr
.
£tup_d©a
;

470 
·_d©a
) {

471 
d©a
 = 
	`—¾y_mem»m­
(
·_d©a
, (*data));

472 
	`¥rštf
(
buf
, "£tu°d©¨%x", 
d©a
->
ty³
);

473 
	`»£rve_—¾y
(
·_d©a
,…a_d©a+(*
d©a
)+d©a->
Ën
, 
buf
);

474 
·_d©a
 = 
d©a
->
Ãxt
;

475 
	`—¾y_iounm­
(
d©a
, (*data));

477 
	}
}

483 #ifdeà
CONFIG_KEXEC


492 
__š™
 
	$fšd_ªd_»£rve_üashk”Ãl
(
size
)

494 cÚ¡ 
®ignm’t
 = 16<<20;

495 
¡¬t
 = 0LL;

498 
»t
;

500 
¡¬t
 = 
	`fšd_e820_¬—
(¡¬t, 
ULONG_MAX
, 
size
, 
®ignm’t
);

501 ià(
¡¬t
 == -1ULL)

502  
¡¬t
;

505 
»t
 = 
	`»£rve_boÙmem_g’”ic
(
¡¬t
, 
size
, 
BOOTMEM_EXCLUSIVE
);

506 ià(
»t
 >= 0)

507  
¡¬t
;

509 
¡¬t
 +ğ
®ignm’t
;

511 
	}
}

513 
šlše
 
	$g‘_tÙ®_mem
()

515 
tÙ®
;

517 
tÙ®
 = 
max_low_pâ
 - 
mš_low_pâ
;

518 #ifdeà
CONFIG_HIGHMEM


519 
tÙ®
 +ğ
high’d_pâ
 - 
high¡¬t_pâ
;

522  
tÙ®
 << 
PAGE_SHIFT
;

523 
	}
}

525 
__š™
 
	$»£rve_üashk”Ãl
()

527 
tÙ®_mem
;

528 
üash_size
, 
üash_ba£
;

529 
»t
;

531 
tÙ®_mem
 = 
	`g‘_tÙ®_mem
();

533 
»t
 = 
	`·r£_üashk”Ãl
(
boÙ_commªd_lše
, 
tÙ®_mem
,

534 &
üash_size
, &
üash_ba£
);

535 ià(
»t
 !ğ0 || 
üash_size
 <= 0)

539 ià(
üash_ba£
 <= 0) {

540 
üash_ba£
 = 
	`fšd_ªd_»£rve_üashk”Ãl
(
üash_size
);

541 ià(
üash_ba£
 == -1ULL) {

542 
	`´_šfo
("crashkernel„eservation failed. "

547 
»t
 = 
	`»£rve_boÙmem_g’”ic
(
üash_ba£
, 
üash_size
,

548 
BOOTMEM_EXCLUSIVE
);

549 ià(
»t
 < 0) {

550 
	`´_šfo
("crashkernel„eservation failed - "

556 
	`´štk
(
KERN_INFO
 "Reserving %ldMB of memory‡t %ldMB "

558 ()(
üash_size
 >> 20),

559 ()(
üash_ba£
 >> 20),

560 ()(
tÙ®_mem
 >> 20));

562 
üashk_»s
.
¡¬t
 = 
üash_ba£
;

563 
üashk_»s
.
’d
 = 
üash_ba£
 + 
üash_size
 - 1;

564 
	`š£¹_»sourû
(&
iomem_»sourû
, &
üashk_»s
);

565 
	}
}

567 
__š™
 
	$»£rve_üashk”Ãl
()

569 
	}
}

572 
»sourû
 
	g¡ªd¬d_io_»sourûs
[] = {

573 { .
Çme
 = "dma1", .
	g¡¬t
 = 0x00, .
	g’d
 = 0x1f,

574 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

575 { .
	gÇme
 = "pic1", .
	g¡¬t
 = 0x20, .
	g’d
 = 0x21,

576 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

577 { .
	gÇme
 = "tim”0", .
	g¡¬t
 = 0x40, .
	g’d
 = 0x43,

578 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

579 { .
	gÇme
 = "tim”1", .
	g¡¬t
 = 0x50, .
	g’d
 = 0x53,

580 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

581 { .
	gÇme
 = "keybßrd", .
	g¡¬t
 = 0x60, .
	g’d
 = 0x60,

582 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

583 { .
	gÇme
 = "keybßrd", .
	g¡¬t
 = 0x64, .
	g’d
 = 0x64,

584 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

585 { .
	gÇme
 = "dm¨·g»g", .
	g¡¬t
 = 0x80, .
	g’d
 = 0x8f,

586 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

587 { .
	gÇme
 = "pic2", .
	g¡¬t
 = 0xa0, .
	g’d
 = 0xa1,

588 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

589 { .
	gÇme
 = "dma2", .
	g¡¬t
 = 0xc0, .
	g’d
 = 0xdf,

590 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

591 { .
	gÇme
 = "åu", .
	g¡¬t
 = 0xf0, .
	g’d
 = 0xff,

592 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

595 
__š™
 
	$»£rve_¡ªd¬d_io_»sourûs
()

597 
i
;

600 
i
 = 0; i < 
	`ARRAY_SIZE
(
¡ªd¬d_io_»sourûs
); i++)

601 
	`»que¡_»sourû
(&
iİÜt_»sourû
, &
¡ªd¬d_io_»sourûs
[
i
]);

603 
	}
}

611 #ifdeà
CONFIG_CRASH_DUMP


616 
__š™
 
	$£tup_–fcÜehdr
(*
¬g
)

618 *
’d
;

619 ià(!
¬g
)

620  -
EINVAL
;

621 
–fcÜehdr_addr
 = 
	`mem·r£
(
¬g
, &
’d
);

622  
’d
 > 
¬g
 ? 0 : -
EINVAL
;

623 
	}
}

624 
—¾y_·¿m
("–fcÜehdr", 
£tup_–fcÜehdr
);

627 
x86_quœks
 
deçuÉ_x86_quœks
 
	g__š™d©a
;

629 
x86_quœks
 *x86_quœk 
	g__š™d©a
 = &
deçuÉ_x86_quœks
;

631 #ifdeà
CONFIG_X86_RESERVE_LOW_64K


632 
__š™
 
	$dmi_low_memÜy_cÜru±iÚ
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

634 
	`´štk
(
KERN_NOTICE


636 
d
->
id’t
);

638 
	`e820_upd©e_¿nge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

639 
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &e820.
Ä_m­
);

642 
	}
}

646 
dmi_sy¡em_id
 
__š™d©a
 
	gbad_bios_dmi_bË
[] = {

647 #ifdeà
CONFIG_X86_RESERVE_LOW_64K


649 .
ÿÎback
 = 
dmi_low_memÜy_cÜru±iÚ
,

650 .
	gid’t
 = "AMI BIOS",

651 .
	gm©ches
 = {

652 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

656 .
	gÿÎback
 = 
dmi_low_memÜy_cÜru±iÚ
,

657 .
	gid’t
 = "Phoenix BIOS",

658 .
	gm©ches
 = {

659 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

679 
__š™
 
	$£tup_¬ch
(**
cmdlše_p
)

681 #ifdeà
CONFIG_X86_32


682 
	`memıy
(&
boÙ_ıu_d©a
, &
Ãw_ıu_d©a
, (new_cpu_data));

683 
	`visws_—¾y_d‘eù
();

685 
	`´štk
(
KERN_INFO
 "Commªd†še: %s\n", 
boÙ_commªd_lše
);

689 
	`vmi_š™
();

691 
	`—¾y_ıu_š™
();

692 
	`—¾y_iÜem­_š™
();

694 
ROOT_DEV
 = 
	`Şd_decode_dev
(
boÙ_·¿ms
.
hdr
.
roÙ_dev
);

695 
sü“n_šfo
 = 
boÙ_·¿ms
.screen_info;

696 
edid_šfo
 = 
boÙ_·¿ms
.edid_info;

697 #ifdeà
CONFIG_X86_32


698 
­m_šfo
.
bios
 = 
boÙ_·¿ms
.
­m_bios_šfo
;

699 
i¡_šfo
 = 
boÙ_·¿ms
.ist_info;

700 ià(
boÙ_·¿ms
.
sys_desc_bË
.
Ëngth
 != 0) {

701 
	`£t_mÿ_bus
(
boÙ_·¿ms
.
sys_desc_bË
.
bË
[3] & 0x2);

702 
machše_id
 = 
boÙ_·¿ms
.
sys_desc_bË
.
bË
[0];

703 
machše_submod–_id
 = 
boÙ_·¿ms
.
sys_desc_bË
.
bË
[1];

704 
BIOS_»visiÚ
 = 
boÙ_·¿ms
.
sys_desc_bË
.
bË
[2];

707 
§ved_video_mode
 = 
boÙ_·¿ms
.
hdr
.
vid_mode
;

708 
boÙlßd”_ty³
 = 
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
;

710 #ifdeà
CONFIG_BLK_DEV_RAM


711 
rd_image_¡¬t
 = 
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_IMAGE_START_MASK
;

712 
rd_´om±
 = ((
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

713 
rd_dŞßd
 = ((
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

715 #ifdeà
CONFIG_EFI


716 ià(!
	`¡ºcmp
((*)&
boÙ_·¿ms
.
efi_šfo
.
efi_lßd”_sigÇtu»
,

717 #ifdeà
CONFIG_X86_32


723 
efi_’abËd
 = 1;

724 
	`efi_»£rve_—¾y
();

728 
ARCH_SETUP


730 
	`£tup_memÜy_m­
();

731 
	`·r£_£tup_d©a
();

733 
	`e820_»£rve_£tup_d©a
();

735 
	`cİy_edd
();

737 ià(!
boÙ_·¿ms
.
hdr
.
roÙ_æags
)

738 
roÙ_mouÁæags
 &ğ~
MS_RDONLY
;

739 
š™_mm
.
¡¬t_code
 = (è
_‹xt
;

740 
š™_mm
.
’d_code
 = (è
_‘ext
;

741 
š™_mm
.
’d_d©a
 = (è
_ed©a
;

742 
š™_mm
.
brk
 = 
_brk_’d
;

744 
code_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(
_‹xt
);

745 
code_»sourû
.
’d
 = 
	`vœt_to_phys
(
_‘ext
)-1;

746 
d©a_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(
_‘ext
);

747 
d©a_»sourû
.
’d
 = 
	`vœt_to_phys
(
_ed©a
)-1;

748 
bss_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(&
__bss_¡¬t
);

749 
bss_»sourû
.
’d
 = 
	`vœt_to_phys
(&
__bss_¡İ
)-1;

751 #ifdeà
CONFIG_CMDLINE_BOOL


752 #ifdeà
CONFIG_CMDLINE_OVERRIDE


753 
	`¡¾ıy
(
boÙ_commªd_lše
, 
butš_cmdlše
, 
COMMAND_LINE_SIZE
);

755 ià(
butš_cmdlše
[0]) {

757 
	`¡¾ÿt
(
butš_cmdlše
, " ", 
COMMAND_LINE_SIZE
);

758 
	`¡¾ÿt
(
butš_cmdlše
, 
boÙ_commªd_lše
, 
COMMAND_LINE_SIZE
);

759 
	`¡¾ıy
(
boÙ_commªd_lše
, 
butš_cmdlše
, 
COMMAND_LINE_SIZE
);

764 
	`¡¾ıy
(
commªd_lše
, 
boÙ_commªd_lše
, 
COMMAND_LINE_SIZE
);

765 *
cmdlše_p
 = 
commªd_lše
;

767 
	`·r£_—¾y_·¿m
();

769 #ifdeà
CONFIG_X86_64


770 
	`check_eãr
();

774 
	`vmi_aùiv©e
();

777 
	`»£rve_—¾y_£tup_d©a
();

779 ià(
	`aıi_mps_check
()) {

780 #ifdeà
CONFIG_X86_LOCAL_APIC


781 
di§bË_­ic
 = 1;

783 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_APIC
);

786 #ifdeà
CONFIG_PCI


787 ià(
pci_—¾y_dump_»gs
)

788 
	`—¾y_dump_pci_deviûs
();

791 
	`fšish_e820_·rsšg
();

793 ià(
efi_’abËd
)

794 
	`efi_š™
();

796 
	`dmi_sÿn_machše
();

798 
	`dmi_check_sy¡em
(
bad_bios_dmi_bË
);

804 
	`š™_hy³rvisÜ
(&
boÙ_ıu_d©a
);

806 #ifdeà
CONFIG_X86_32


807 
	`´obe_roms
();

811 
	`š£¹_»sourû
(&
iomem_»sourû
, &
code_»sourû
);

812 
	`š£¹_»sourû
(&
iomem_»sourû
, &
d©a_»sourû
);

813 
	`š£¹_»sourû
(&
iomem_»sourû
, &
bss_»sourû
);

816 #ifdeà
CONFIG_X86_32


817 ià(
	`µro_w™h_¿m_bug
()) {

818 
	`e820_upd©e_¿nge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

819 
E820_RESERVED
);

820 
	`§n™ize_e820_m­
(
e820
.
m­
, 
	`ARRAY_SIZE
Ó820.m­), &e820.
Ä_m­
);

821 
	`´štk
(
KERN_INFO
 "fixed…hysical RAM map:\n");

822 
	`e820_´št_m­
("bad_ppro");

825 
	`—¾y_g¬t_iommu_check
();

832 
max_pâ
 = 
	`e820_’d_of_¿m_pâ
();

835 
	`—¾y_»£rve_e820_mpc_Ãw
();

837 
	`mŒr_bp_š™
();

838 ià(
	`mŒr_Œim_unÿched_memÜy
(
max_pâ
))

839 
max_pâ
 = 
	`e820_’d_of_¿m_pâ
();

841 #ifdeà
CONFIG_X86_32


843 
	`fšd_low_pâ_¿nge
();

845 
num_phy¥ages
 = 
max_pâ
;

847 
	`check_x2­ic
();

851 ià(
max_pâ
 > (1UL<<(32 - 
PAGE_SHIFT
)))

852 
max_low_pâ
 = 
	`e820_’d_of_low_¿m_pâ
();

854 
max_low_pâ
 = 
max_pâ
;

856 
high_memÜy
 = (*)
	`__va
(
max_pâ
 * 
PAGE_SIZE
 - 1) + 1;

859 #ifdeà
CONFIG_X86_CHECK_BIOS_CORRUPTION


860 
	`£tup_bios_cÜru±iÚ_check
();

863 
	`»£rve_brk
();

866 
max_low_pâ_m­³d
 = 
	`š™_memÜy_m­pšg
(0, 
max_low_pâ
<<
PAGE_SHIFT
);

867 
max_pâ_m­³d
 = 
max_low_pâ_m­³d
;

869 #ifdeà
CONFIG_X86_64


870 ià(
max_pâ
 > 
max_low_pâ
) {

871 
max_pâ_m­³d
 = 
	`š™_memÜy_m­pšg
(1UL<<32,

872 
max_pâ
<<
PAGE_SHIFT
);

874 
max_low_pâ
 = 
max_pâ
;

882 #ifdeà
CONFIG_PROVIDE_OHCI1394_DMA_INIT


883 ià(
š™_ohci1394_dma_—¾y
)

884 
	`š™_ohci1394_dma_Ú_®l_cÚŒŞËrs
();

887 
	`»£rve_š™rd
();

889 
	`vsmp_š™
();

891 
	`io_d–ay_š™
();

896 
	`aıi_boÙ_bË_š™
();

898 
	`—¾y_aıi_boÙ_š™
();

900 #ifdeà
CONFIG_ACPI_NUMA


904 
	`aıi_numa_š™
();

907 
	`š™mem_š™
(0, 
max_pâ
);

909 #ifdeà
CONFIG_ACPI_SLEEP


913 
	`aıi_»£rve_boÙmem
();

918 
	`fšd_smp_cÚfig
();

920 
	`»£rve_üashk”Ãl
();

922 #ifdeà
CONFIG_X86_64


928 
	`dma32_»£rve_boÙmem
();

931 
	`»£rve_ibá_»giÚ
();

933 #ifdeà
CONFIG_KVM_CLOCK


934 
	`kvmşock_š™
();

937 
	`·¿vœt_·g‘abË_£tup_¡¬t
(
sw­³r_pg_dœ
);

938 
	`·gšg_š™
();

939 
	`·¿vœt_·g‘abË_£tup_dÚe
(
sw­³r_pg_dœ
);

940 
	`·¿vœt_po¡_®loÿtÜ_š™
();

942 #ifdeà
CONFIG_X86_64


943 
	`m­_vsysÿÎ
();

946 
	`g’”ic_­ic_´obe
();

948 
	`—¾y_quœks
();

953 
	`aıi_boÙ_š™
();

955 #ià
	`defšed
(
CONFIG_X86_MPPARSE
è|| defšed(
CONFIG_X86_VISWS
)

959 ià(
smp_found_cÚfig
)

960 
	`g‘_smp_cÚfig
();

963 
	`´efl_possibË_m­
();

965 #ifdeà
CONFIG_X86_64


966 
	`š™_ıu_to_node
();

969 
	`š™_­ic_m­pšgs
();

970 
	`ißpic_š™_m­pšgs
();

973 
	`´obe_Ä_œqs_gsi
();

975 
	`kvm_gue¡_š™
();

977 
	`e820_»£rve_»sourûs
();

978 
	`e820_m¬k_no§ve_»giÚs
(
max_low_pâ
);

980 #ifdeà
CONFIG_X86_32


981 
	`»que¡_»sourû
(&
iomem_»sourû
, &
video_¿m_»sourû
);

983 
	`»£rve_¡ªd¬d_io_»sourûs
();

985 
	`e820_£tup_g­
();

987 #ifdeà
CONFIG_VT


988 #ià
	`defšed
(
CONFIG_VGA_CONSOLE
)

989 ià(!
efi_’abËd
 || (
	`efi_mem_ty³
(0xa0000è!ğ
EFI_CONVENTIONAL_MEMORY
))

990 
cÚsw™chp
 = &
vga_cÚ
;

991 #–ià
	`defšed
(
CONFIG_DUMMY_CONSOLE
)

992 
cÚsw™chp
 = &
dummy_cÚ
;

995 
	}
}

997 #ifdeà
CONFIG_X86_32


1008 
__š™
 
	$x86_quœk_´e_šŒ_š™
()

1010 ià(
x86_quœks
->
¬ch_´e_šŒ_š™
) {

1011 ià(
x86_quœks
->
	`¬ch_´e_šŒ_š™
())

1014 
	`š™_ISA_œqs
();

1015 
	}
}

1026 
__š™
 
	$x86_quœk_šŒ_š™
()

1028 ià(
x86_quœks
->
¬ch_šŒ_š™
) {

1029 ià(
x86_quœks
->
	`¬ch_šŒ_š™
())

1032 
	}
}

1041 
__š™
 
	$x86_quœk_Œ­_š™
()

1043 ià(
x86_quœks
->
¬ch_Œ­_š™
) {

1044 ià(
x86_quœks
->
	`¬ch_Œ­_š™
())

1047 
	}
}

1049 
œqaùiÚ
 
	gœq0
 = {

1050 .
hªdËr
 = 
tim”_š‹¼u±
,

1051 .
	gæags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

1052 .
	gÇme
 = "timer"

1059 
__š™
 
	$x86_quœk_´e_time_š™
()

1061 ià(
x86_quœks
->
¬ch_´e_time_š™
)

1062 
x86_quœks
->
	`¬ch_´e_time_š™
();

1063 
	}
}

1072 
__š™
 
	$x86_quœk_time_š™
()

1074 ià(
x86_quœks
->
¬ch_time_š™
) {

1080 ià(
x86_quœks
->
	`¬ch_time_š™
())

1084 
œq0
.
mask
 = 
	`ıumask_of_ıu
(0);

1085 
	`£tup_œq
(0, &
œq0
);

1086 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/š™.h
>

4 
	~<lšux/boÙmem.h
>

5 
	~<lšux/³rıu.h
>

6 
	~<lšux/kexec.h
>

7 
	~<lšux/üash_dump.h
>

8 
	~<lšux/smp.h
>

9 
	~<lšux/tİŞogy.h
>

10 
	~<lšux/pâ.h
>

11 
	~<asm/£ùiÚs.h
>

12 
	~<asm/´oûssÜ.h
>

13 
	~<asm/£tup.h
>

14 
	~<asm/mp¥ec.h
>

15 
	~<asm/­icdef.h
>

16 
	~<asm/highmem.h
>

17 
	~<asm/´Ùo.h
>

18 
	~<asm/ıumask.h
>

19 
	~<asm/ıu.h
>

20 
	~<asm/¡ack´ÙeùÜ.h
>

22 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


23 
	#DBG
(
x
...è
	`´štk
(
KERN_DEBUG
 x)

	)

25 
	#DBG
(
x
...)

	)

28 
DEFINE_PER_CPU
(, 
ıu_numb”
);

29 
EXPORT_PER_CPU_SYMBOL
(
ıu_numb”
);

31 #ifdeà
CONFIG_X86_64


32 
	#BOOT_PERCPU_OFFSET
 (()
__³r_ıu_lßd
)

	)

34 
	#BOOT_PERCPU_OFFSET
 0

	)

37 
DEFINE_PER_CPU
(, 
this_ıu_off
èğ
BOOT_PERCPU_OFFSET
;

38 
EXPORT_PER_CPU_SYMBOL
(
this_ıu_off
);

40 
	g__³r_ıu_off£t
[
NR_CPUS
] 
	g__»ad_mo¡ly
 = {

41 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

43 
EXPORT_SYMBOL
(
__³r_ıu_off£t
);

52 #ifdeà
CONFIG_X86_64


53 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

55 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

68 
boŞ
 
__š™
 
	$pıu_Ãed_numa
()

70 #ifdeà
CONFIG_NEED_MULTIPLE_NODES


71 
pg_d©a_t
 *
Ï¡
 = 
NULL
;

72 
ıu
;

74 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

75 
node
 = 
	`—¾y_ıu_to_node
(
ıu
);

77 ià(
	`node_Úlše
(
node
è&& 
	`NODE_DATA
(node) &&

78 
Ï¡
 &&†a¡ !ğ
	`NODE_DATA
(
node
))

79  
Œue
;

81 
Ï¡
 = 
	`NODE_DATA
(
node
);

84  
çl£
;

85 
	}
}

100 * 
__š™
 
	$pıu_®loc_boÙmem
(
ıu
, 
size
,

101 
®ign
)

103 cÚ¡ 
gßl
 = 
	`__·
(
MAX_DMA_ADDRESS
);

104 #ifdeà
CONFIG_NEED_MULTIPLE_NODES


105 
node
 = 
	`—¾y_ıu_to_node
(
ıu
);

106 *
±r
;

108 ià(!
	`node_Úlše
(
node
è|| !
	`NODE_DATA
(node)) {

109 
±r
 = 
	`__®loc_boÙmem_nİªic
(
size
, 
®ign
, 
gßl
);

110 
	`´_šfo
("cpu %d has‚o‚ode %d or‚ode-local memory\n",

111 
ıu
, 
node
);

112 
	`´_debug
("per cpu data for cpu%d %lu bytes‡t %016lx\n",

113 
ıu
, 
size
, 
	`__·
(
±r
));

115 
±r
 = 
	`__®loc_boÙmem_node_nİªic
(
	`NODE_DATA
(
node
),

116 
size
, 
®ign
, 
gßl
);

117 
	`´_debug
("per cpu data for cpu%d %lu bytes on‚ode%d‡t "

118 "%016lx\n", 
ıu
, 
size
, 
node
, 
	`__·
(
±r
));

120  
±r
;

122  
	`__®loc_boÙmem_nİªic
(
size
, 
®ign
, 
gßl
);

124 
	}
}

139 #ifdeà
CONFIG_NEED_MULTIPLE_NODES


140 
size_t
 
pıur_size
 
	g__š™d©a
;

141 **
pıur_±rs
 
	g__š™d©a
;

143 
·ge
 * 
__š™
 
	$pıur_g‘_·ge
(
ıu
, 
·g’o
)

145 
size_t
 
off
 = (size_t)
·g’o
 << 
PAGE_SHIFT
;

147 ià(
off
 >ğ
pıur_size
)

148  
NULL
;

150  
	`vœt_to_·ge
(
pıur_±rs
[
ıu
] + 
off
);

151 
	}
}

153 
ssize_t
 
__š™
 
	$£tup_pıu_»m­
(
size_t
 
¡©ic_size
)

155 
vm_¡ruù
 
vm
;

156 
size_t
 
±rs_size
, 
dyn_size
;

157 
ıu
;

158 
ssize_t
 
»t
;

166 ià(
Œue
 || !
ıu_has_p£
 || !
	`pıu_Ãed_numa
())

167  -
EINVAL
;

173 
pıur_size
 = 
	`PFN_ALIGN
(
¡©ic_size
 + 
PERCPU_MODULE_RESERVE
 +

174 
PERCPU_DYNAMIC_RESERVE
);

175 ià(
pıur_size
 > 
PMD_SIZE
) {

176 
	`´_w¬nšg
("PERCPU: static data is†argerhan†arge…age, "

178  -
EINVAL
;

180 
dyn_size
 = 
pıur_size
 - 
¡©ic_size
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

183 
±rs_size
 = 
	`PFN_ALIGN
(
	`num_possibË_ıus
(è* (
pıur_±rs
[0]));

184 
pıur_±rs
 = 
	`®loc_boÙmem
(
±rs_size
);

186 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

187 
pıur_±rs
[
ıu
] = 
	`pıu_®loc_boÙmem
(ıu, 
PMD_SIZE
, PMD_SIZE);

188 ià(!
pıur_±rs
[
ıu
])

189 
’omem
;

199 
	`ä“_boÙmem
(
	`__·
(
pıur_±rs
[
ıu
] + 
pıur_size
),

200 
PMD_SIZE
 - 
pıur_size
);

202 
	`memıy
(
pıur_±rs
[
ıu
], 
__³r_ıu_lßd
, 
¡©ic_size
);

206 
vm
.
æags
 = 
VM_ALLOC
;

207 
vm
.
size
 = 
	`num_possibË_ıus
(è* 
PMD_SIZE
;

208 
	`vm_¬—_»gi¡”_—¾y
(&
vm
, 
PMD_SIZE
);

210 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

211 
pmd_t
 *
pmd
;

213 
pmd
 = 
	`pİuÏ‹_exŒa_pmd
(()
vm
.
addr


214 + 
ıu
 * 
PMD_SIZE
);

215 
	`£t_pmd
(
pmd
, 
	`pâ_pmd
(
	`·ge_to_pâ
(
	`vœt_to_·ge
(
pıur_±rs
[
ıu
])),

216 
PAGE_KERNEL_LARGE
));

220 
	`´_šfo
("PERCPU: Remapped‡t %p with†arge…ages, static data "

221 "%zu by‹s\n", 
vm
.
addr
, 
¡©ic_size
);

223 
»t
 = 
	`pıu_£tup_fœ¡_chunk
(
pıur_g‘_·ge
, 
¡©ic_size
,

224 
PERCPU_FIRST_CHUNK_RESERVE
, 
dyn_size
,

225 
PMD_SIZE
, 
vm
.
addr
, 
NULL
);

226 
out_ä“_¬
;

228 
’omem
:

229 
	`fÜ_—ch_possibË_ıu
(
ıu
)

230 ià(
pıur_±rs
[
ıu
])

231 
	`ä“_boÙmem
(
	`__·
(
pıur_±rs
[
ıu
]), 
PMD_SIZE
);

232 
»t
 = -
ENOMEM
;

233 
out_ä“_¬
:

234 
	`ä“_boÙmem
(
	`__·
(
pıur_±rs
), 
±rs_size
);

235  
»t
;

236 
	}
}

238 
ssize_t
 
__š™
 
	$£tup_pıu_»m­
(
size_t
 
¡©ic_size
)

240  -
EINVAL
;

241 
	}
}

252 
ssize_t
 
__š™
 
	$£tup_pıu_embed
(
size_t
 
¡©ic_size
)

254 
size_t
 
»£rve
 = 
PERCPU_MODULE_RESERVE
 + 
PERCPU_DYNAMIC_RESERVE
;

261 ià(!
ıu_has_p£
 || 
	`pıu_Ãed_numa
())

262  -
EINVAL
;

264  
	`pıu_embed_fœ¡_chunk
(
¡©ic_size
, 
PERCPU_FIRST_CHUNK_RESERVE
,

265 
»£rve
 - 
PERCPU_FIRST_CHUNK_RESERVE
, -1);

266 
	}
}

275 
·ge
 **
pıu4k_·ges
 
	g__š™d©a
;

276 
pıu4k_Ä_¡©ic_·ges
 
	g__š™d©a
;

278 
·ge
 * 
__š™
 
	$pıu4k_g‘_·ge
(
ıu
, 
·g’o
)

280 ià(
·g’o
 < 
pıu4k_Ä_¡©ic_·ges
)

281  
pıu4k_·ges
[
ıu
 * 
pıu4k_Ä_¡©ic_·ges
 + 
·g’o
];

282  
NULL
;

283 
	}
}

285 
__š™
 
	$pıu4k_pİuÏ‹_±e
(
addr
)

287 
	`pİuÏ‹_exŒa_±e
(
addr
);

288 
	}
}

290 
ssize_t
 
__š™
 
	$£tup_pıu_4k
(
size_t
 
¡©ic_size
)

292 
size_t
 
·ges_size
;

293 
ıu
;

294 
i
, 
j
;

295 
ssize_t
 
»t
;

297 
pıu4k_Ä_¡©ic_·ges
 = 
	`PFN_UP
(
¡©ic_size
);

300 
·ges_size
 = 
	`PFN_ALIGN
(
pıu4k_Ä_¡©ic_·ges
 * 
	`num_possibË_ıus
()

301 * (
pıu4k_·ges
[0]));

302 
pıu4k_·ges
 = 
	`®loc_boÙmem
(
·ges_size
);

305 
j
 = 0;

306 
	`fÜ_—ch_possibË_ıu
(
ıu
)

307 
i
 = 0; i < 
pıu4k_Ä_¡©ic_·ges
; i++) {

308 *
±r
;

310 
±r
 = 
	`pıu_®loc_boÙmem
(
ıu
, 
PAGE_SIZE
, PAGE_SIZE);

311 ià(!
±r
)

312 
’omem
;

314 
	`memıy
(
±r
, 
__³r_ıu_lßd
 + 
i
 * 
PAGE_SIZE
, PAGE_SIZE);

315 
pıu4k_·ges
[
j
++] = 
	`vœt_to_·ge
(
±r
);

319 
	`´_šfo
("PERCPU: Allocated %d 4k…ages, static data %zu bytes\n",

320 
pıu4k_Ä_¡©ic_·ges
, 
¡©ic_size
);

322 
»t
 = 
	`pıu_£tup_fœ¡_chunk
(
pıu4k_g‘_·ge
, 
¡©ic_size
,

323 
PERCPU_FIRST_CHUNK_RESERVE
, -1,

324 -1, 
NULL
, 
pıu4k_pİuÏ‹_±e
);

325 
out_ä“_¬
;

327 
’omem
:

328 --
j
 >= 0)

329 
	`ä“_boÙmem
(
	`__·
(
	`·ge_add»ss
(
pıu4k_·ges
[
j
])), 
PAGE_SIZE
);

330 
»t
 = -
ENOMEM
;

331 
out_ä“_¬
:

332 
	`ä“_boÙmem
(
	`__·
(
pıu4k_·ges
), 
·ges_size
);

333  
»t
;

334 
	}
}

336 
šlše
 
	$£tup_³rıu_£gm’t
(
ıu
)

338 #ifdeà
CONFIG_X86_32


339 
desc_¡ruù
 
gdt
;

341 
	`·ck_desütÜ
(&
gdt
, 
	`³r_ıu_off£t
(
ıu
), 0xFFFFF,

342 0x2 | 
DESCTYPE_S
, 0x8);

343 
gdt
.
s
 = 1;

344 
	`wr™e_gdt_’Œy
(
	`g‘_ıu_gdt_bË
(
ıu
),

345 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

347 
	}
}

354 
__š™
 
	$£tup_³r_ıu_¬—s
()

356 
size_t
 
¡©ic_size
 = 
__³r_ıu_’d
 - 
__³r_ıu_¡¬t
;

357 
ıu
;

358 
d–
;

359 
size_t
 
pıu_un™_size
;

360 
ssize_t
 
»t
;

362 
	`´_šfo
("NR_CPUS:%d‚r_cpumask_bits:%d‚r_cpu_ids:%d‚r_node_ids:%d\n",

363 
NR_CPUS
, 
Ä_ıumask_b™s
, 
Ä_ıu_ids
, 
Ä_node_ids
);

370 
»t
 = 
	`£tup_pıu_»m­
(
¡©ic_size
);

371 ià(
»t
 < 0)

372 
»t
 = 
	`£tup_pıu_embed
(
¡©ic_size
);

373 ià(
»t
 < 0)

374 
»t
 = 
	`£tup_pıu_4k
(
¡©ic_size
);

375 ià(
»t
 < 0)

376 
	`·nic
("cannot‡llocate static…ercpu‡rea (%zu bytes,ƒrr=%zd)",

377 
¡©ic_size
, 
»t
);

379 
pıu_un™_size
 = 
»t
;

382 
d–
 = ()
pıu_ba£_addr
 - ()
__³r_ıu_¡¬t
;

383 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

384 
	`³r_ıu_off£t
(
ıu
èğ
d–
 + cpu * 
pıu_un™_size
;

385 
	`³r_ıu
(
this_ıu_off
, 
ıu
èğ
	`³r_ıu_off£t
(cpu);

386 
	`³r_ıu
(
ıu_numb”
, 
ıu
) = cpu;

387 
	`£tup_³rıu_£gm’t
(
ıu
);

388 
	`£tup_¡ack_ÿÇry_£gm’t
(
ıu
);

396 #ifdeà
CONFIG_X86_LOCAL_APIC


397 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
) =

398 
	`—¾y_³r_ıu_m­
(
x86_ıu_to_­icid
, 
ıu
);

399 
	`³r_ıu
(
x86_bios_ıu_­icid
, 
ıu
) =

400 
	`—¾y_³r_ıu_m­
(
x86_bios_ıu_­icid
, 
ıu
);

402 #ifdeà
CONFIG_X86_64


403 
	`³r_ıu
(
œq_¡ack_±r
, 
ıu
) =

404 
	`³r_ıu
(
œq_¡ack_uniÚ
.
œq_¡ack
, 
ıu
) +

405 
IRQ_STACK_SIZE
 - 64;

406 #ifdeà
CONFIG_NUMA


407 
	`³r_ıu
(
x86_ıu_to_node_m­
, 
ıu
) =

408 
	`—¾y_³r_ıu_m­
(
x86_ıu_to_node_m­
, 
ıu
);

415 ià(
ıu
 =ğ
boÙ_ıu_id
)

416 
	`sw™ch_to_Ãw_gdt
(
ıu
);

420 #ifdeà
CONFIG_X86_LOCAL_APIC


421 
	`—¾y_³r_ıu_±r
(
x86_ıu_to_­icid
èğ
NULL
;

422 
	`—¾y_³r_ıu_±r
(
x86_bios_ıu_­icid
èğ
NULL
;

424 #ià
	`defšed
(
CONFIG_X86_64
è&& defšed(
CONFIG_NUMA
)

425 
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
èğ
NULL
;

429 
	`£tup_node_to_ıumask_m­
();

432 
	`£tup_ıu_loÿl_masks
();

433 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

10 
	~<lšux/sched.h
>

11 
	~<lšux/mm.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/sigÇl.h
>

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/wa™.h
>

17 
	~<lšux/±¿û.h
>

18 
	~<lšux/Œaûhook.h
>

19 
	~<lšux/uni¡d.h
>

20 
	~<lšux/¡ddef.h
>

21 
	~<lšux/³rsÚ®™y.h
>

22 
	~<lšux/uacûss.h
>

24 
	~<asm/´oûssÜ.h
>

25 
	~<asm/ucÚ‹xt.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/vdso.h
>

29 #ifdeà
CONFIG_X86_64


30 
	~<asm/´Ùo.h
>

31 
	~<asm/Ÿ32_uni¡d.h
>

32 
	~<asm/mû.h
>

35 
	~<asm/sysÿÎ.h
>

36 
	~<asm/sysÿÎs.h
>

38 
	~<asm/sigäame.h
>

40 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
è| sigmask(
SIGSTOP
)))

	)

42 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

43 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

44 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

45 
X86_EFLAGS_CF
)

	)

47 #ifdeà
CONFIG_X86_32


48 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

50 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

53 
	#COPY
(
x
) do { \

54 
	`g‘_u£r_ex
(
»gs
->
x
, &
sc
->x); \

55 } 0)

	)

57 
	#GET_SEG
(
£g
) ({ \

58 
tmp
; \

59 
	`g‘_u£r_ex
(
tmp
, &
sc
->
£g
); \

60 
tmp
; \

61 })

	)

63 
	#COPY_SEG
(
£g
) do { \

64 
»gs
->
£g
 = 
	`GET_SEG
(seg); \

65 } 0)

	)

67 
	#COPY_SEG_CPL3
(
£g
) do { \

68 
»gs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

69 } 0)

	)

72 
	$»¡Üe_sigcÚ‹xt
(
±_»gs
 *
»gs
, 
sigcÚ‹xt
 
__u£r
 *
sc
,

73 *
·x
)

75 
__u£r
 *
buf
;

76 
tmpæags
;

77 
”r
 = 0;

80 
	`cu¼’t_th»ad_šfo
()->
»¡¬t_block
.
â
 = 
do_no_»¡¬t_sysÿÎ
;

82 
g‘_u£r_Œy
 {

84 #ifdeà
CONFIG_X86_32


85 
	`£t_u£r_gs
(
»gs
, 
	`GET_SEG
(
gs
));

86 
	`COPY_SEG
(
fs
);

87 
	`COPY_SEG
(
es
);

88 
	`COPY_SEG
(
ds
);

91 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
¥
); COPY(
bx
);

92 
	`COPY
(
dx
); COPY(
cx
); COPY(

);

94 #ifdeà
CONFIG_X86_64


95 
	`COPY
(
r8
);

96 
	`COPY
(
r9
);

97 
	`COPY
(
r10
);

98 
	`COPY
(
r11
);

99 
	`COPY
(
r12
);

100 
	`COPY
(
r13
);

101 
	`COPY
(
r14
);

102 
	`COPY
(
r15
);

105 #ifdeà
CONFIG_X86_32


106 
	`COPY_SEG_CPL3
(
cs
);

107 
	`COPY_SEG_CPL3
(
ss
);

112 
	`COPY_SEG_CPL3
(
cs
);

115 
	`g‘_u£r_ex
(
tmpæags
, &
sc
->
æags
);

116 
»gs
->
æags
 = (»gs->æag & ~
FIX_EFLAGS
è| (
tmpæags
 & FIX_EFLAGS);

117 
»gs
->
Üig_ax
 = -1;

119 
	`g‘_u£r_ex
(
buf
, &
sc
->
å¡©e
);

120 
”r
 |ğ
	`»¡Üe_i387_x¡©e
(
buf
);

122 
	`g‘_u£r_ex
(*
·x
, &
sc
->
ax
);

123 } 
	`g‘_u£r_ÿtch
(
”r
);

125  
”r
;

126 
	}
}

129 
	$£tup_sigcÚ‹xt
(
sigcÚ‹xt
 
__u£r
 *
sc
, __u£¸*
å¡©e
,

130 
±_»gs
 *
»gs
, 
mask
)

132 
”r
 = 0;

134 
put_u£r_Œy
 {

136 #ifdeà
CONFIG_X86_32


137 
	`put_u£r_ex
(
	`g‘_u£r_gs
(
»gs
), (
__u£r
 *)&
sc
->
gs
);

138 
	`put_u£r_ex
(
»gs
->
fs
, (
__u£r
 *)&
sc
->fs);

139 
	`put_u£r_ex
(
»gs
->
es
, (
__u£r
 *)&
sc
->es);

140 
	`put_u£r_ex
(
»gs
->
ds
, (
__u£r
 *)&
sc
->ds);

143 
	`put_u£r_ex
(
»gs
->
di
, &
sc
->di);

144 
	`put_u£r_ex
(
»gs
->
si
, &
sc
->si);

145 
	`put_u£r_ex
(
»gs
->
bp
, &
sc
->bp);

146 
	`put_u£r_ex
(
»gs
->
¥
, &
sc
->sp);

147 
	`put_u£r_ex
(
»gs
->
bx
, &
sc
->bx);

148 
	`put_u£r_ex
(
»gs
->
dx
, &
sc
->dx);

149 
	`put_u£r_ex
(
»gs
->
cx
, &
sc
->cx);

150 
	`put_u£r_ex
(
»gs
->
ax
, &
sc
->ax);

151 #ifdeà
CONFIG_X86_64


152 
	`put_u£r_ex
(
»gs
->
r8
, &
sc
->r8);

153 
	`put_u£r_ex
(
»gs
->
r9
, &
sc
->r9);

154 
	`put_u£r_ex
(
»gs
->
r10
, &
sc
->r10);

155 
	`put_u£r_ex
(
»gs
->
r11
, &
sc
->r11);

156 
	`put_u£r_ex
(
»gs
->
r12
, &
sc
->r12);

157 
	`put_u£r_ex
(
»gs
->
r13
, &
sc
->r13);

158 
	`put_u£r_ex
(
»gs
->
r14
, &
sc
->r14);

159 
	`put_u£r_ex
(
»gs
->
r15
, &
sc
->r15);

162 
	`put_u£r_ex
(
cu¼’t
->
th»ad
.
Œ­_no
, &
sc
->
Œ­no
);

163 
	`put_u£r_ex
(
cu¼’t
->
th»ad
.
”rÜ_code
, &
sc
->
”r
);

164 
	`put_u£r_ex
(
»gs
->

, &
sc
->ip);

165 #ifdeà
CONFIG_X86_32


166 
	`put_u£r_ex
(
»gs
->
cs
, (
__u£r
 *)&
sc
->cs);

167 
	`put_u£r_ex
(
»gs
->
æags
, &
sc
->flags);

168 
	`put_u£r_ex
(
»gs
->
¥
, &
sc
->
¥_©_sigÇl
);

169 
	`put_u£r_ex
(
»gs
->
ss
, (
__u£r
 *)&
sc
->ss);

171 
	`put_u£r_ex
(
»gs
->
æags
, &
sc
->flags);

172 
	`put_u£r_ex
(
»gs
->
cs
, &
sc
->cs);

173 
	`put_u£r_ex
(0, &
sc
->
gs
);

174 
	`put_u£r_ex
(0, &
sc
->
fs
);

177 
	`put_u£r_ex
(
å¡©e
, &
sc
->fpstate);

180 
	`put_u£r_ex
(
mask
, &
sc
->
Şdmask
);

181 
	`put_u£r_ex
(
cu¼’t
->
th»ad
.
ü2
, &
sc
->cr2);

182 } 
	`put_u£r_ÿtch
(
”r
);

184  
”r
;

185 
	}
}

194 
	$®ign_sigäame
(
¥
)

196 #ifdeà
CONFIG_X86_32


201 
¥
 = ((sp + 4) & -16ul) - 4;

203 
¥
 = 
	`round_down
(sp, 16) - 8;

205  
¥
;

206 
	}
}

208 
šlše
 
__u£r
 *

209 
	$g‘_sigäame
(
k_sigaùiÚ
 *
ka
, 
±_»gs
 *
»gs
, 
size_t
 
äame_size
,

210 
__u£r
 **
å¡©e
)

213 
¥
 = 
»gs
->sp;

214 
Úsig¡ack
 = 
	`Ú_sig_¡ack
(
¥
);

216 #ifdeà
CONFIG_X86_64


218 
¥
 -= 128;

221 ià(!
Úsig¡ack
) {

223 ià(
ka
->
§
.
§_æags
 & 
SA_ONSTACK
) {

224 ià(
cu¼’t
->
§s_ss_size
)

225 
¥
 = 
cu¼’t
->
§s_ss_¥
 + cu¼’t->
§s_ss_size
;

227 #ifdeà
CONFIG_X86_32


229 ià((
»gs
->
ss
 & 0xffffè!ğ
__USER_DS
 &&

230 !(
ka
->
§
.
§_æags
 & 
SA_RESTORER
) &&

231 
ka
->
§
.
§_»¡Ü”
)

232 
¥
 = (è
ka
->
§
.
§_»¡Ü”
;

237 ià(
	`u£d_m©h
()) {

238 
¥
 -ğ
sig_x¡©e_size
;

239 #ifdeà
CONFIG_X86_64


240 
¥
 = 
	`round_down
(sp, 64);

242 *
å¡©e
 = (
__u£r
 *)
¥
;

245 
¥
 = 
	`®ign_sigäame
(¥ - 
äame_size
);

251 ià(
Úsig¡ack
 && !
	`lik–y
(
	`Ú_sig_¡ack
(
¥
)))

252  (
__u£r
 *)-1L;

255 ià(
	`u£d_m©h
(è&& 
	`§ve_i387_x¡©e
(*
å¡©e
) < 0)

256  (
__u£r
 *)-1L;

258  (
__u£r
 *)
¥
;

259 
	}
}

261 #ifdeà
CONFIG_X86_32


263 
u16
 
	mpİlmovl
;

264 
u32
 
	mv®
;

265 
u16
 
	mšt80
;

266 } 
__©Œibu‹__
((
·cked
)è
	g»tcode
 = {

268 
__NR_sig»tuº
,

273 
u8
 
	mmovl
;

274 
u32
 
	mv®
;

275 
u16
 
	mšt80
;

276 
u8
 
	m·d
;

277 } 
__©Œibu‹__
((
·cked
)è
	g¹_»tcode
 = {

279 
__NR_¹_sig»tuº
,

285 
	$__£tup_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sig£t_t
 *
£t
,

286 
±_»gs
 *
»gs
)

288 
sigäame
 
__u£r
 *
äame
;

289 
__u£r
 *
»¡Ü”
;

290 
”r
 = 0;

291 
__u£r
 *
å¡©e
 = 
NULL
;

293 
äame
 = 
	`g‘_sigäame
(
ka
, 
»gs
, (*äame), &
å¡©e
);

295 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
äame
, (*frame)))

296  -
EFAULT
;

298 ià(
	`__put_u£r
(
sig
, &
äame
->sig))

299  -
EFAULT
;

301 ià(
	`£tup_sigcÚ‹xt
(&
äame
->
sc
, 
å¡©e
, 
»gs
, 
£t
->
sig
[0]))

302  -
EFAULT
;

304 ià(
_NSIG_WORDS
 > 1) {

305 ià(
	`__cİy_to_u£r
(&
äame
->
exŒamask
, &
£t
->
sig
[1],

306 (
äame
->
exŒamask
)))

307  -
EFAULT
;

310 ià(
cu¼’t
->
mm
->
cÚ‹xt
.
vdso
)

311 
»¡Ü”
 = 
	`VDSO32_SYMBOL
(
cu¼’t
->
mm
->
cÚ‹xt
.
vdso
, 
sig»tuº
);

313 
»¡Ü”
 = &
äame
->
»tcode
;

314 ià(
ka
->
§
.
§_æags
 & 
SA_RESTORER
)

315 
»¡Ü”
 = 
ka
->
§
.
§_»¡Ü”
;

318 
”r
 |ğ
	`__put_u£r
(
»¡Ü”
, &
äame
->
´‘code
);

327 
”r
 |ğ
	`__put_u£r
(*((
u64
 *)&
»tcode
), (u64 *)
äame
->retcode);

329 ià(
”r
)

330  -
EFAULT
;

333 
»gs
->
¥
 = ()
äame
;

334 
»gs
->

 = ()
ka
->
§
.
§_hªdËr
;

335 
»gs
->
ax
 = ()
sig
;

336 
»gs
->
dx
 = 0;

337 
»gs
->
cx
 = 0;

339 
»gs
->
ds
 = 
__USER_DS
;

340 
»gs
->
es
 = 
__USER_DS
;

341 
»gs
->
ss
 = 
__USER_DS
;

342 
»gs
->
cs
 = 
__USER_CS
;

345 
	}
}

347 
	$__£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

348 
sig£t_t
 *
£t
, 
±_»gs
 *
»gs
)

350 
¹_sigäame
 
__u£r
 *
äame
;

351 
__u£r
 *
»¡Ü”
;

352 
”r
 = 0;

353 
__u£r
 *
å¡©e
 = 
NULL
;

355 
äame
 = 
	`g‘_sigäame
(
ka
, 
»gs
, (*äame), &
å¡©e
);

357 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
äame
, (*frame)))

358  -
EFAULT
;

360 
put_u£r_Œy
 {

361 
	`put_u£r_ex
(
sig
, &
äame
->sig);

362 
	`put_u£r_ex
(&
äame
->
šfo
, &äame->
pšfo
);

363 
	`put_u£r_ex
(&
äame
->
uc
, &äame->
puc
);

364 
”r
 |ğ
	`cİy_sigšfo_to_u£r
(&
äame
->
šfo
, info);

367 ià(
ıu_has_x§ve
)

368 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
äame
->
uc
.
uc_æags
);

370 
	`put_u£r_ex
(0, &
äame
->
uc
.
uc_æags
);

371 
	`put_u£r_ex
(0, &
äame
->
uc
.
uc_lšk
);

372 
	`put_u£r_ex
(
cu¼’t
->
§s_ss_¥
, &
äame
->
uc
.
uc_¡ack
.
ss_¥
);

373 
	`put_u£r_ex
(
	`§s_ss_æags
(
»gs
->
¥
),

374 &
äame
->
uc
.
uc_¡ack
.
ss_æags
);

375 
	`put_u£r_ex
(
cu¼’t
->
§s_ss_size
, &
äame
->
uc
.
uc_¡ack
.
ss_size
);

376 
”r
 |ğ
	`£tup_sigcÚ‹xt
(&
äame
->
uc
.
uc_mcÚ‹xt
, 
å¡©e
,

377 
»gs
, 
£t
->
sig
[0]);

378 
”r
 |ğ
	`__cİy_to_u£r
(&
äame
->
uc
.
uc_sigmask
, 
£t
, (*set));

381 
»¡Ü”
 = 
	`VDSO32_SYMBOL
(
cu¼’t
->
mm
->
cÚ‹xt
.
vdso
, 
¹_sig»tuº
);

382 ià(
ka
->
§
.
§_æags
 & 
SA_RESTORER
)

383 
»¡Ü”
 = 
ka
->
§
.
§_»¡Ü”
;

384 
	`put_u£r_ex
(
»¡Ü”
, &
äame
->
´‘code
);

393 
	`put_u£r_ex
(*((
u64
 *)&
¹_»tcode
), (u64 *)
äame
->
»tcode
);

394 } 
	`put_u£r_ÿtch
(
”r
);

396 ià(
”r
)

397  -
EFAULT
;

400 
»gs
->
¥
 = ()
äame
;

401 
»gs
->

 = ()
ka
->
§
.
§_hªdËr
;

402 
»gs
->
ax
 = ()
sig
;

403 
»gs
->
dx
 = ()&
äame
->
šfo
;

404 
»gs
->
cx
 = ()&
äame
->
uc
;

406 
»gs
->
ds
 = 
__USER_DS
;

407 
»gs
->
es
 = 
__USER_DS
;

408 
»gs
->
ss
 = 
__USER_DS
;

409 
»gs
->
cs
 = 
__USER_CS
;

412 
	}
}

414 
	$__£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

415 
sig£t_t
 *
£t
, 
±_»gs
 *
»gs
)

417 
¹_sigäame
 
__u£r
 *
äame
;

418 
__u£r
 *
å
 = 
NULL
;

419 
”r
 = 0;

420 
sk_¡ruù
 *
me
 = 
cu¼’t
;

422 
äame
 = 
	`g‘_sigäame
(
ka
, 
»gs
, (
¹_sigäame
), &
å
);

424 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
äame
, (*frame)))

425  -
EFAULT
;

427 ià(
ka
->
§
.
§_æags
 & 
SA_SIGINFO
) {

428 ià(
	`cİy_sigšfo_to_u£r
(&
äame
->
šfo
, info))

429  -
EFAULT
;

432 
put_u£r_Œy
 {

434 ià(
ıu_has_x§ve
)

435 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
äame
->
uc
.
uc_æags
);

437 
	`put_u£r_ex
(0, &
äame
->
uc
.
uc_æags
);

438 
	`put_u£r_ex
(0, &
äame
->
uc
.
uc_lšk
);

439 
	`put_u£r_ex
(
me
->
§s_ss_¥
, &
äame
->
uc
.
uc_¡ack
.
ss_¥
);

440 
	`put_u£r_ex
(
	`§s_ss_æags
(
»gs
->
¥
),

441 &
äame
->
uc
.
uc_¡ack
.
ss_æags
);

442 
	`put_u£r_ex
(
me
->
§s_ss_size
, &
äame
->
uc
.
uc_¡ack
.
ss_size
);

443 
”r
 |ğ
	`£tup_sigcÚ‹xt
(&
äame
->
uc
.
uc_mcÚ‹xt
, 
å
, 
»gs
, 
£t
->
sig
[0]);

444 
”r
 |ğ
	`__cİy_to_u£r
(&
äame
->
uc
.
uc_sigmask
, 
£t
, (*set));

449 ià(
ka
->
§
.
§_æags
 & 
SA_RESTORER
) {

450 
	`put_u£r_ex
(
ka
->
§
.
§_»¡Ü”
, &
äame
->
´‘code
);

453 
”r
 |ğ-
EFAULT
;

455 } 
	`put_u£r_ÿtch
(
”r
);

457 ià(
”r
)

458  -
EFAULT
;

461 
»gs
->
di
 = 
sig
;

463 
»gs
->
ax
 = 0;

467 
»gs
->
si
 = ()&
äame
->
šfo
;

468 
»gs
->
dx
 = ()&
äame
->
uc
;

469 
»gs
->

 = (è
ka
->
§
.
§_hªdËr
;

471 
»gs
->
¥
 = ()
äame
;

475 
»gs
->
cs
 = 
__USER_CS
;

478 
	}
}

481 #ifdeà
CONFIG_X86_32


485 
asmlškage
 

486 
	$sys_sigsu¥’d
(
hi¡Üy0
, 
hi¡Üy1
, 
Şd_sig£t_t
 
mask
)

488 
mask
 &ğ
_BLOCKABLE
;

489 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

490 
cu¼’t
->
§ved_sigmask
 = cu¼’t->
blocked
;

491 
	`sigš™£t
(&
cu¼’t
->
blocked
, 
mask
);

492 
	`»ÿlc_sig³ndšg
();

493 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

495 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

496 
	`scheduË
();

497 
	`£t_»¡Üe_sigmask
();

499  -
ERESTARTNOHAND
;

500 
	}
}

502 
asmlškage
 

503 
	$sys_sigaùiÚ
(
sig
, cÚ¡ 
Şd_sigaùiÚ
 
__u£r
 *
aù
,

504 
Şd_sigaùiÚ
 
__u£r
 *
ßù
)

506 
k_sigaùiÚ
 
Ãw_ka
, 
Şd_ka
;

507 
»t
 = 0;

509 ià(
aù
) {

510 
Şd_sig£t_t
 
mask
;

512 ià(!
	`acûss_ok
(
VERIFY_READ
, 
aù
, (*act)))

513  -
EFAULT
;

515 
g‘_u£r_Œy
 {

516 
	`g‘_u£r_ex
(
Ãw_ka
.
§
.
§_hªdËr
, &
aù
->sa_handler);

517 
	`g‘_u£r_ex
(
Ãw_ka
.
§
.
§_æags
, &
aù
->sa_flags);

518 
	`g‘_u£r_ex
(
mask
, &
aù
->
§_mask
);

519 
	`g‘_u£r_ex
(
Ãw_ka
.
§
.
§_»¡Ü”
, &
aù
->sa_restorer);

520 } 
	`g‘_u£r_ÿtch
(
»t
);

522 ià(
»t
)

523  -
EFAULT
;

524 
	`sigš™£t
(&
Ãw_ka
.
§
.
§_mask
, 
mask
);

527 
»t
 = 
	`do_sigaùiÚ
(
sig
, 
aù
 ? &
Ãw_ka
 : 
NULL
, 
ßù
 ? &
Şd_ka
 : NULL);

529 ià(!
»t
 && 
ßù
) {

530 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
ßù
, (*oact)))

531  -
EFAULT
;

533 
put_u£r_Œy
 {

534 
	`put_u£r_ex
(
Şd_ka
.
§
.
§_hªdËr
, &
ßù
->sa_handler);

535 
	`put_u£r_ex
(
Şd_ka
.
§
.
§_æags
, &
ßù
->sa_flags);

536 
	`put_u£r_ex
(
Şd_ka
.
§
.
§_mask
.
sig
[0], &
ßù
->sa_mask);

537 
	`put_u£r_ex
(
Şd_ka
.
§
.
§_»¡Ü”
, &
ßù
->sa_restorer);

538 } 
	`put_u£r_ÿtch
(
»t
);

540 ià(
»t
)

541  -
EFAULT
;

544  
»t
;

545 
	}
}

548 #ifdeà
CONFIG_X86_32


549 
	$sys_sig®t¡ack
(
±_»gs
 *
»gs
)

551 cÚ¡ 
¡ack_t
 
__u£r
 *
uss
 = (cÚ¡ sck_ˆ__u£¸*)
»gs
->
bx
;

552 
¡ack_t
 
__u£r
 *
uoss
 = (¡ack_ˆ__u£¸*)
»gs
->
cx
;

554  
	`do_sig®t¡ack
(
uss
, 
uoss
, 
»gs
->
¥
);

555 
	}
}

557 
asmlškage
 

558 
	$sys_sig®t¡ack
(cÚ¡ 
¡ack_t
 
__u£r
 *
uss
, sck_ˆ__u£¸*
uoss
,

559 
±_»gs
 *
»gs
)

561  
	`do_sig®t¡ack
(
uss
, 
uoss
, 
»gs
->
¥
);

562 
	}
}

568 #ifdeà
CONFIG_X86_32


569 
	$sys_sig»tuº
(
±_»gs
 *
»gs
)

571 
sigäame
 
__u£r
 *
äame
;

572 
ax
;

573 
sig£t_t
 
£t
;

575 
äame
 = (
sigäame
 
__u£r
 *)(
»gs
->
¥
 - 8);

577 ià(!
	`acûss_ok
(
VERIFY_READ
, 
äame
, (*frame)))

578 
badäame
;

579 ià(
	`__g‘_u£r
(
£t
.
sig
[0], &
äame
->
sc
.
Şdmask
è|| (
_NSIG_WORDS
 > 1

580 && 
	`__cİy_äom_u£r
(&
£t
.
sig
[1], &
äame
->
exŒamask
,

581 (
äame
->
exŒamask
))))

582 
badäame
;

584 
	`sigd–£tmask
(&
£t
, ~
_BLOCKABLE
);

585 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

586 
cu¼’t
->
blocked
 = 
£t
;

587 
	`»ÿlc_sig³ndšg
();

588 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

590 ià(
	`»¡Üe_sigcÚ‹xt
(
»gs
, &
äame
->
sc
, &
ax
))

591 
badäame
;

592  
ax
;

594 
badäame
:

595 
	`sigÇl_çuÉ
(
»gs
, 
äame
, "sigreturn");

598 
	}
}

601 
	$sys_¹_sig»tuº
(
±_»gs
 *
»gs
)

603 
¹_sigäame
 
__u£r
 *
äame
;

604 
ax
;

605 
sig£t_t
 
£t
;

607 
äame
 = (
¹_sigäame
 
__u£r
 *)(
»gs
->
¥
 - ());

608 ià(!
	`acûss_ok
(
VERIFY_READ
, 
äame
, (*frame)))

609 
badäame
;

610 ià(
	`__cİy_äom_u£r
(&
£t
, &
äame
->
uc
.
uc_sigmask
, (set)))

611 
badäame
;

613 
	`sigd–£tmask
(&
£t
, ~
_BLOCKABLE
);

614 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

615 
cu¼’t
->
blocked
 = 
£t
;

616 
	`»ÿlc_sig³ndšg
();

617 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

619 ià(
	`»¡Üe_sigcÚ‹xt
(
»gs
, &
äame
->
uc
.
uc_mcÚ‹xt
, &
ax
))

620 
badäame
;

622 ià(
	`do_sig®t¡ack
(&
äame
->
uc
.
uc_¡ack
, 
NULL
, 
»gs
->
¥
è=ğ-
EFAULT
)

623 
badäame
;

625  
ax
;

627 
badäame
:

628 
	`sigÇl_çuÉ
(
»gs
, 
äame
, "rt_sigreturn");

630 
	}
}

635 
	$sigÄ_cÚv”t
(
sig
)

637 #ifdeà
CONFIG_X86_32


638 
th»ad_šfo
 *
šfo
 = 
	`cu¼’t_th»ad_šfo
();

640 ià(
šfo
->
exec_domaš
 && info->exec_domaš->
sigÇl_švm­
 && 
sig
 < 32)

641  
šfo
->
exec_domaš
->
sigÇl_švm­
[
sig
];

643  
sig
;

644 
	}
}

646 #ifdeà
CONFIG_X86_32


648 
	#is_Ÿ32
 1

	)

649 
	#Ÿ32_£tup_äame
 
__£tup_äame


	)

650 
	#Ÿ32_£tup_¹_äame
 
__£tup_¹_äame


	)

654 #ifdeà
CONFIG_IA32_EMULATION


655 
	#is_Ÿ32
 
	`‹¡_th»ad_æag
(
TIF_IA32
)

	)

657 
	#is_Ÿ32
 0

	)

660 
Ÿ32_£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

661 
sig£t_t
 *
£t
, 
±_»gs
 *
»gs
);

662 
Ÿ32_£tup_äame
(
sig
, 
k_sigaùiÚ
 *
ka
,

663 
sig£t_t
 *
£t
, 
±_»gs
 *
»gs
);

668 
	$£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

669 
sig£t_t
 *
£t
, 
±_»gs
 *
»gs
)

671 
usig
 = 
	`sigÄ_cÚv”t
(
sig
);

672 
»t
;

675 ià(
is_Ÿ32
) {

676 ià(
ka
->
§
.
§_æags
 & 
SA_SIGINFO
)

677 
»t
 = 
	`Ÿ32_£tup_¹_äame
(
usig
, 
ka
, 
šfo
, 
£t
, 
»gs
);

679 
»t
 = 
	`Ÿ32_£tup_äame
(
usig
, 
ka
, 
£t
, 
»gs
);

681 
»t
 = 
	`__£tup_¹_äame
(
sig
, 
ka
, 
šfo
, 
£t
, 
»gs
);

683 ià(
»t
) {

684 
	`fÜû_sig£gv
(
sig
, 
cu¼’t
);

685  -
EFAULT
;

688  
»t
;

689 
	}
}

692 
	$hªdË_sigÇl
(
sig
, 
sigšfo_t
 *
šfo
, 
k_sigaùiÚ
 *
ka
,

693 
sig£t_t
 *
Şd£t
, 
±_»gs
 *
»gs
)

695 
»t
;

698 ià(
	`sysÿÎ_g‘_Ä
(
cu¼’t
, 
»gs
) >= 0) {

700 
	`sysÿÎ_g‘_”rÜ
(
cu¼’t
, 
»gs
)) {

701 -
ERESTART_RESTARTBLOCK
:

702 -
ERESTARTNOHAND
:

703 
»gs
->
ax
 = -
EINTR
;

706 -
ERESTARTSYS
:

707 ià(!(
ka
->
§
.
§_æags
 & 
SA_RESTART
)) {

708 
»gs
->
ax
 = -
EINTR
;

712 -
ERESTARTNOINTR
:

713 
»gs
->
ax
 =„egs->
Üig_ax
;

714 
»gs
->

 -= 2;

723 ià(
	`uÆik–y
(
»gs
->
æags
 & 
X86_EFLAGS_TF
) &&

724 
	`lik–y
(
	`‹¡_ªd_ş—r_th»ad_æag
(
TIF_FORCED_TF
)))

725 
»gs
->
æags
 &ğ~
X86_EFLAGS_TF
;

727 
»t
 = 
	`£tup_¹_äame
(
sig
, 
ka
, 
šfo
, 
Şd£t
, 
»gs
);

729 ià(
»t
)

730  
»t
;

732 #ifdeà
CONFIG_X86_64


738 
	`£t_fs
(
USER_DS
);

744 
»gs
->
æags
 &ğ~
X86_EFLAGS_DF
;

752 
»gs
->
æags
 &ğ~
X86_EFLAGS_TF
;

754 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

755 
	`sigÜ£ts
(&
cu¼’t
->
blocked
, &cu¼’t->blocked, &
ka
->
§
.
§_mask
);

756 ià(!(
ka
->
§
.
§_æags
 & 
SA_NODEFER
))

757 
	`sigadd£t
(&
cu¼’t
->
blocked
, 
sig
);

758 
	`»ÿlc_sig³ndšg
();

759 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

761 
	`Œaûhook_sigÇl_hªdËr
(
sig
, 
šfo
, 
ka
, 
»gs
,

762 
	`‹¡_th»ad_æag
(
TIF_SINGLESTEP
));

765 
	}
}

767 #ifdeà
CONFIG_X86_32


768 
	#NR_»¡¬t_sysÿÎ
 
__NR_»¡¬t_sysÿÎ


	)

770 
	#NR_»¡¬t_sysÿÎ
 \

771 
	`‹¡_th»ad_æag
(
TIF_IA32
è? 
__NR_Ÿ32_»¡¬t_sysÿÎ
 : 
__NR_»¡¬t_sysÿÎ


	)

779 
	$do_sigÇl
(
±_»gs
 *
»gs
)

781 
k_sigaùiÚ
 
ka
;

782 
sigšfo_t
 
šfo
;

783 
sigÄ
;

784 
sig£t_t
 *
Şd£t
;

793 ià(!
	`u£r_mode
(
»gs
))

796 ià(
	`cu¼’t_th»ad_šfo
()->
¡©us
 & 
TS_RESTORE_SIGMASK
)

797 
Şd£t
 = &
cu¼’t
->
§ved_sigmask
;

799 
Şd£t
 = &
cu¼’t
->
blocked
;

801 
sigÄ
 = 
	`g‘_sigÇl_to_d–iv”
(&
šfo
, &
ka
, 
»gs
, 
NULL
);

802 ià(
sigÄ
 > 0) {

809 ià(
cu¼’t
->
th»ad
.
debug»g7
)

810 
	`£t_debug»g
(
cu¼’t
->
th»ad
.
debug»g7
, 7);

813 ià(
	`hªdË_sigÇl
(
sigÄ
, &
šfo
, &
ka
, 
Şd£t
, 
»gs
) == 0) {

820 
	`cu¼’t_th»ad_šfo
()->
¡©us
 &ğ~
TS_RESTORE_SIGMASK
;

826 ià(
	`sysÿÎ_g‘_Ä
(
cu¼’t
, 
»gs
) >= 0) {

828 
	`sysÿÎ_g‘_”rÜ
(
cu¼’t
, 
»gs
)) {

829 -
ERESTARTNOHAND
:

830 -
ERESTARTSYS
:

831 -
ERESTARTNOINTR
:

832 
»gs
->
ax
 =„egs->
Üig_ax
;

833 
»gs
->

 -= 2;

836 -
ERESTART_RESTARTBLOCK
:

837 
»gs
->
ax
 = 
NR_»¡¬t_sysÿÎ
;

838 
»gs
->

 -= 2;

847 ià(
	`cu¼’t_th»ad_šfo
()->
¡©us
 & 
TS_RESTORE_SIGMASK
) {

848 
	`cu¼’t_th»ad_šfo
()->
¡©us
 &ğ~
TS_RESTORE_SIGMASK
;

849 
	`sig´ocmask
(
SIG_SETMASK
, &
cu¼’t
->
§ved_sigmask
, 
NULL
);

851 
	}
}

858 
	$do_nÙify_»sume
(
±_»gs
 *
»gs
, *
unu£d
, 
__u32
 
th»ad_šfo_æags
)

860 #ià
	`defšed
(
CONFIG_X86_64
è&& defšed(
CONFIG_X86_MCE
)

862 ià(
th»ad_šfo_æags
 & 
_TIF_MCE_NOTIFY
)

863 
	`mû_nÙify_u£r
();

867 ià(
th»ad_šfo_æags
 & 
_TIF_SIGPENDING
)

868 
	`do_sigÇl
(
»gs
);

870 ià(
th»ad_šfo_æags
 & 
_TIF_NOTIFY_RESUME
) {

871 
	`ş—r_th»ad_æag
(
TIF_NOTIFY_RESUME
);

872 
	`Œaûhook_nÙify_»sume
(
»gs
);

875 #ifdeà
CONFIG_X86_32


876 
	`ş—r_th»ad_æag
(
TIF_IRET
);

878 
	}
}

880 
	$sigÇl_çuÉ
(
±_»gs
 *
»gs
, 
__u£r
 *
äame
, *
wh”e
)

882 
sk_¡ruù
 *
me
 = 
cu¼’t
;

884 ià(
show_unhªdËd_sigÇls
 && 
	`´štk_¿‹lim™
()) {

885 
	`´štk
("%s"

887 
	`sk_pid_Ä
(
cu¼’t
è> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

888 
me
->
comm
, me->
pid
, 
wh”e
, 
äame
,

889 
»gs
->

,„egs->
¥
,„egs->
Üig_ax
);

890 
	`´št_vma_addr
(" iÀ", 
»gs
->

);

891 
	`´štk
(
KERN_CONT
 "\n");

894 
	`fÜû_sig
(
SIGSEGV
, 
me
);

895 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<lšux/š™.h
>

16 
	~<lšux/mm.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/¥šlock.h
>

19 
	~<lšux/k”Ãl_¡©.h
>

20 
	~<lšux/mc146818¹c.h
>

21 
	~<lšux/ÿche.h
>

22 
	~<lšux/š‹¼u±.h
>

23 
	~<lšux/ıu.h
>

25 
	~<asm/mŒr.h
>

26 
	~<asm/bæush.h
>

27 
	~<asm/mmu_cÚ‹xt.h
>

28 
	~<asm/´Ùo.h
>

29 
	~<asm/­ic.h
>

114 
	$Çtive_smp_£nd_»scheduË
(
ıu
)

116 ià(
	`uÆik–y
(
	`ıu_is_ofæše
(
ıu
))) {

117 
	`WARN_ON
(1);

120 
­ic
->
	`£nd_IPI_mask
(
	`ıumask_of
(
ıu
), 
RESCHEDULE_VECTOR
);

121 
	}
}

123 
	$Çtive_£nd_ÿÎ_func_sšgË_i
(
ıu
)

125 
­ic
->
	`£nd_IPI_mask
(
	`ıumask_of
(
ıu
), 
CALL_FUNCTION_SINGLE_VECTOR
);

126 
	}
}

128 
	$Çtive_£nd_ÿÎ_func_i
(cÚ¡ 
ıumask
 *
mask
)

130 
ıumask_v¬_t
 
®lbut£lf
;

132 ià(!
	`®loc_ıumask_v¬
(&
®lbut£lf
, 
GFP_ATOMIC
)) {

133 
­ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

137 
	`ıumask_cİy
(
®lbut£lf
, 
ıu_Úlše_mask
);

138 
	`ıumask_ş—r_ıu
(
	`smp_´oûssÜ_id
(), 
®lbut£lf
);

140 ià(
	`ıumask_equ®
(
mask
, 
®lbut£lf
) &&

141 
	`ıumask_equ®
(
ıu_Úlše_mask
, 
ıu_ÿÎout_mask
))

142 
­ic
->
	`£nd_IPI_®lbut£lf
(
CALL_FUNCTION_VECTOR
);

144 
­ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

146 
	`ä“_ıumask_v¬
(
®lbut£lf
);

147 
	}
}

153 
	$Çtive_smp_£nd_¡İ
()

155 
æags
;

157 ià(
»boÙ_fÜû
)

160 
	`smp_ÿÎ_funùiÚ
(
¡İ_this_ıu
, 
NULL
, 0);

161 
	`loÿl_œq_§ve
(
æags
);

162 
	`di§bË_loÿl_APIC
();

163 
	`loÿl_œq_»¡Üe
(
æags
);

164 
	}
}

171 
	$smp_»scheduË_š‹¼u±
(
±_»gs
 *
»gs
)

173 
	`ack_APIC_œq
();

174 
	`šc_œq_¡©
(
œq_»sched_couÁ
);

175 
	}
}

177 
	$smp_ÿÎ_funùiÚ_š‹¼u±
(
±_»gs
 *
»gs
)

179 
	`ack_APIC_œq
();

180 
	`œq_’‹r
();

181 
	`g’”ic_smp_ÿÎ_funùiÚ_š‹¼u±
();

182 
	`šc_œq_¡©
(
œq_ÿÎ_couÁ
);

183 
	`œq_ex™
();

184 
	}
}

186 
	$smp_ÿÎ_funùiÚ_sšgË_š‹¼u±
(
±_»gs
 *
»gs
)

188 
	`ack_APIC_œq
();

189 
	`œq_’‹r
();

190 
	`g’”ic_smp_ÿÎ_funùiÚ_sšgË_š‹¼u±
();

191 
	`šc_œq_¡©
(
œq_ÿÎ_couÁ
);

192 
	`œq_ex™
();

193 
	}
}

195 
smp_İs
 
	gsmp_İs
 = {

196 .
smp_´•¬e_boÙ_ıu
 = 
Çtive_smp_´•¬e_boÙ_ıu
,

197 .
	gsmp_´•¬e_ıus
 = 
Çtive_smp_´•¬e_ıus
,

198 .
	gsmp_ıus_dÚe
 = 
Çtive_smp_ıus_dÚe
,

200 .
	gsmp_£nd_¡İ
 = 
Çtive_smp_£nd_¡İ
,

201 .
	gsmp_£nd_»scheduË
 = 
Çtive_smp_£nd_»scheduË
,

203 .
	gıu_up
 = 
Çtive_ıu_up
,

204 .
	gıu_d›
 = 
Çtive_ıu_d›
,

205 .
	gıu_di§bË
 = 
Çtive_ıu_di§bË
,

206 .
	g¶ay_d—d
 = 
Çtive_¶ay_d—d
,

208 .
	g£nd_ÿÎ_func_i
 = 
Çtive_£nd_ÿÎ_func_i
,

209 .
	g£nd_ÿÎ_func_sšgË_i
 = 
Çtive_£nd_ÿÎ_func_sšgË_i
,

211 
EXPORT_SYMBOL_GPL
(
smp_İs
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<lšux/š™.h
>

43 
	~<lšux/smp.h
>

44 
	~<lšux/moduË.h
>

45 
	~<lšux/sched.h
>

46 
	~<lšux/³rıu.h
>

47 
	~<lšux/boÙmem.h
>

48 
	~<lšux/”r.h
>

49 
	~<lšux/nmi.h
>

51 
	~<asm/aıi.h
>

52 
	~<asm/desc.h
>

53 
	~<asm/nmi.h
>

54 
	~<asm/œq.h
>

55 
	~<asm/idË.h
>

56 
	~<asm/ŒampŞše.h
>

57 
	~<asm/ıu.h
>

58 
	~<asm/numa.h
>

59 
	~<asm/pgbË.h
>

60 
	~<asm/bæush.h
>

61 
	~<asm/mŒr.h
>

62 
	~<asm/vmi.h
>

63 
	~<asm/­ic.h
>

64 
	~<asm/£tup.h
>

65 
	~<asm/uv/uv.h
>

66 
	~<lšux/mc146818¹c.h
>

68 
	~<asm/smpboÙ_hooks.h
>

70 #ifdeà
CONFIG_X86_32


71 
u8
 
	g­icid_2_node
[
MAX_APICID
];

72 
	glow_m­pšgs
;

76 
DEFINE_PER_CPU
(, 
ıu_¡©e
) = { 0 };

82 #ifdeà
CONFIG_HOTPLUG_CPU


87 
DEFINE_PER_CPU
(
sk_¡ruù
 *, 
idË_th»ad_¬¿y
);

88 
	#g‘_idË_fÜ_ıu
(
x
è(
	`³r_ıu
(
idË_th»ad_¬¿y
, x))

	)

89 
	#£t_idË_fÜ_ıu
(
x
, 
p
è(
	`³r_ıu
(
idË_th»ad_¬¿y
, xèğÕ))

	)

91 
sk_¡ruù
 *
	gidË_th»ad_¬¿y
[
NR_CPUS
] 
	g__ıuš™d©a
 ;

92 
	#g‘_idË_fÜ_ıu
(
x
è(
idË_th»ad_¬¿y
[(x)])

	)

93 
	#£t_idË_fÜ_ıu
(
x
, 
p
è(
idË_th»ad_¬¿y
[(x)] = (p))

	)

97 
	gsmp_num_siblšgs
 = 1;

98 
EXPORT_SYMBOL
(
smp_num_siblšgs
);

101 
DEFINE_PER_CPU
(
u16
, 
ıu_Îc_id
èğ
BAD_APICID
;

104 
DEFINE_PER_CPU
(
ıumask_v¬_t
, 
ıu_siblšg_m­
);

105 
EXPORT_PER_CPU_SYMBOL
(
ıu_siblšg_m­
);

108 
DEFINE_PER_CPU
(
ıumask_v¬_t
, 
ıu_cÜe_m­
);

109 
EXPORT_PER_CPU_SYMBOL
(
ıu_cÜe_m­
);

112 
DEFINE_PER_CPU_SHARED_ALIGNED
(
ıušfo_x86
, 
ıu_šfo
);

113 
EXPORT_PER_CPU_SYMBOL
(
ıu_šfo
);

115 
©omic_t
 
	gš™_d—s£¹ed
;

117 #ià
defšed
(
CONFIG_NUMA
è&& defšed(
CONFIG_X86_32
)

119 
	gıu_to_node_m­
[
NR_CPUS
] 
	g__»ad_mo¡ly
 = { [0 ... NR_CPUS-1] = 0 };

120 
EXPORT_SYMBOL
(
ıu_to_node_m­
);

123 
	$m­_ıu_to_node
(
ıu
, 
node
)

125 
	`´štk
(
KERN_INFO
 "M­pšg cpu %dØnod%d\n", 
ıu
, 
node
);

126 
	`ıumask_£t_ıu
(
ıu
, 
node_to_ıumask_m­
[
node
]);

127 
ıu_to_node_m­
[
ıu
] = 
node
;

128 
	}
}

131 
	$unm­_ıu_to_node
(
ıu
)

133 
node
;

135 
	`´štk
(
KERN_INFO
 "Unm­pšg cpu %d from‡Î‚odes\n", 
ıu
);

136 
node
 = 0;‚od< 
MAX_NUMNODES
;‚ode++)

137 
	`ıumask_ş—r_ıu
(
ıu
, 
node_to_ıumask_m­
[
node
]);

138 
ıu_to_node_m­
[
ıu
] = 0;

139 
	}
}

141 
	#m­_ıu_to_node
(
ıu
, 
node
è({})

	)

142 
	#unm­_ıu_to_node
(
ıu
è({})

	)

145 #ifdeà
CONFIG_X86_32


146 
	gboÙ_ıu_logiÿl_­icid
;

148 
u8
 
	gıu_2_logiÿl_­icid
[
NR_CPUS
] 
	g__»ad_mo¡ly
 =

149 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

151 
	$m­_ıu_to_logiÿl_­icid
()

153 
ıu
 = 
	`smp_´oûssÜ_id
();

154 
­icid
 = 
	`logiÿl_smp_´oûssÜ_id
();

155 
node
 = 
­ic
->
	`­icid_to_node
(
­icid
);

157 ià(!
	`node_Úlše
(
node
))

158 
node
 = 
fœ¡_Úlše_node
;

160 
ıu_2_logiÿl_­icid
[
ıu
] = 
­icid
;

161 
	`m­_ıu_to_node
(
ıu
, 
node
);

162 
	}
}

164 
	$numa_»move_ıu
(
ıu
)

166 
ıu_2_logiÿl_­icid
[
ıu
] = 
BAD_APICID
;

167 
	`unm­_ıu_to_node
(
ıu
);

168 
	}
}

170 
	#m­_ıu_to_logiÿl_­icid
(èdØ{} 0)

	)

177 
__ıuš™
 
	$smp_ÿÎš
()

179 
ıuid
, 
phys_id
;

180 
timeout
;

188 ià(
­ic
->
wa™_fÜ_š™_d—s£¹
)

189 
­ic
->
	`wa™_fÜ_š™_d—s£¹
(&
š™_d—s£¹ed
);

194 
phys_id
 = 
	`»ad_­ic_id
();

195 
ıuid
 = 
	`smp_´oûssÜ_id
();

196 ià(
	`ıumask_‹¡_ıu
(
ıuid
, 
ıu_ÿÎš_mask
)) {

197 
	`·nic
("%s:…hy CPU#%d, CPU#%d‡Ì—dy…»£Á??\n", 
__func__
,

198 
phys_id
, 
ıuid
);

200 
	`´_debug
("CPU#%d (phy ID: %dèwa™šg fÜ CALLOUT\n", 
ıuid
, 
phys_id
);

213 
timeout
 = 
jiff›s
 + 2*
HZ
;

214 
	`time_befÜe
(
jiff›s
, 
timeout
)) {

218 ià(
	`ıumask_‹¡_ıu
(
ıuid
, 
ıu_ÿÎout_mask
))

220 
	`ıu_»Ïx
();

223 ià(!
	`time_befÜe
(
jiff›s
, 
timeout
)) {

224 
	`·nic
("%s: CPU%d started up but did‚ot get‡ callout!\n",

225 
__func__
, 
ıuid
);

235 
	`´_debug
("CALLIN, before setup_local_APIC().\n");

236 ià(
­ic
->
smp_ÿÎš_ş—r_loÿl_­ic
)

237 
­ic
->
	`smp_ÿÎš_ş—r_loÿl_­ic
();

238 
	`£tup_loÿl_APIC
();

239 
	`’d_loÿl_APIC_£tup
();

240 
	`m­_ıu_to_logiÿl_­icid
();

242 
	`nÙify_ıu_¡¬tšg
(
ıuid
);

249 
	`loÿl_œq_’abË
();

250 
	`ÿlib¿‹_d–ay
();

251 
	`loÿl_œq_di§bË
();

252 
	`´_debug
("Sck‡ˆabouˆ%p\n", &
ıuid
);

257 
	`smp_¡Üe_ıu_šfo
(
ıuid
);

262 
	`ıumask_£t_ıu
(
ıuid
, 
ıu_ÿÎš_mask
);

263 
	}
}

268 
nÙ¿û
 
__ıuš™
 
	$¡¬t_£cÚd¬y
(*
unu£d
)

275 
	`vmi_bršgup
();

276 
	`ıu_š™
();

277 
	`´“m±_di§bË
();

278 
	`smp_ÿÎš
();

281 
	`b¬r›r
();

285 
	`check_tsc_sync_rg‘
();

287 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

288 
	`di§bË_8259A_œq
(0);

289 
	`’abË_NMI_through_LVT0
();

290 
	`’abË_8259A_œq
(0);

293 #ifdeà
CONFIG_X86_32


294 
low_m­pšgs
)

295 
	`ıu_»Ïx
();

296 
	`__æush_b_®l
();

300 
	`£t_ıu_siblšg_m­
(
	`¿w_smp_´oûssÜ_id
());

301 
	`wmb
();

315 
	`i_ÿÎ_lock
();

316 
	`lock_veùÜ_lock
();

317 
	`__£tup_veùÜ_œq
(
	`smp_´oûssÜ_id
());

318 
	`£t_ıu_Úlše
(
	`smp_´oûssÜ_id
(), 
Œue
);

319 
	`uÆock_veùÜ_lock
();

320 
	`i_ÿÎ_uÆock
();

321 
	`³r_ıu
(
ıu_¡©e
, 
	`smp_´oûssÜ_id
()èğ
CPU_ONLINE
;

324 
	`loÿl_œq_’abË
();

326 
	`£tup_£cÚd¬y_şock
();

328 
	`wmb
();

329 
	`ıu_idË
();

330 
	}
}

332 #ifdeà
CONFIG_CPUMASK_OFFSTACK


334 
šlše
 
	$cİy_ıušfo_x86
(
ıušfo_x86
 *
d¡
,

335 cÚ¡ 
ıušfo_x86
 *
¤c
)

337 
ıumask
 *
Îc
 = 
d¡
->
Îc_sh¬ed_m­
;

338 *
d¡
 = *
¤c
;

339 
d¡
->
Îc_sh¬ed_m­
 = 
Îc
;

340 
	}
}

342 
šlše
 
	$cİy_ıušfo_x86
(
ıušfo_x86
 *
d¡
,

343 cÚ¡ 
ıušfo_x86
 *
¤c
)

345 *
d¡
 = *
¤c
;

346 
	}
}

354 
__ıuš™
 
	$smp_¡Üe_ıu_šfo
(
id
)

356 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
id
);

358 
	`cİy_ıušfo_x86
(
c
, &
boÙ_ıu_d©a
);

359 
c
->
ıu_šdex
 = 
id
;

360 ià(
id
 != 0)

361 
	`id’tify_£cÚd¬y_ıu
(
c
);

362 
	}
}

365 
__ıuš™
 
	$£t_ıu_siblšg_m­
(
ıu
)

367 
i
;

368 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

370 
	`ıumask_£t_ıu
(
ıu
, 
ıu_siblšg_£tup_mask
);

372 ià(
smp_num_siblšgs
 > 1) {

373 
	`fÜ_—ch_ıu
(
i
, 
ıu_siblšg_£tup_mask
) {

374 
ıušfo_x86
 *
o
 = &
	`ıu_d©a
(
i
);

376 ià(
c
->
phys_´oc_id
 =ğ
o
->phys_proc_id &&

377 
c
->
ıu_cÜe_id
 =ğ
o
->cpu_core_id) {

378 
	`ıumask_£t_ıu
(
i
, 
	`ıu_siblšg_mask
(
ıu
));

379 
	`ıumask_£t_ıu
(
ıu
, 
	`ıu_siblšg_mask
(
i
));

380 
	`ıumask_£t_ıu
(
i
, 
	`ıu_cÜe_mask
(
ıu
));

381 
	`ıumask_£t_ıu
(
ıu
, 
	`ıu_cÜe_mask
(
i
));

382 
	`ıumask_£t_ıu
(
i
, 
c
->
Îc_sh¬ed_m­
);

383 
	`ıumask_£t_ıu
(
ıu
, 
o
->
Îc_sh¬ed_m­
);

387 
	`ıumask_£t_ıu
(
ıu
, 
	`ıu_siblšg_mask
(cpu));

390 
	`ıumask_£t_ıu
(
ıu
, 
c
->
Îc_sh¬ed_m­
);

392 ià(
cu¼’t_ıu_d©a
.
x86_max_cÜes
 == 1) {

393 
	`ıumask_cİy
(
	`ıu_cÜe_mask
(
ıu
), 
	`ıu_siblšg_mask
(cpu));

394 
c
->
boÙed_cÜes
 = 1;

398 
	`fÜ_—ch_ıu
(
i
, 
ıu_siblšg_£tup_mask
) {

399 ià(
	`³r_ıu
(
ıu_Îc_id
, 
ıu
è!ğ
BAD_APICID
 &&

400 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
è=ğ³r_ıu(ıu_Îc_id, 
i
)) {

401 
	`ıumask_£t_ıu
(
i
, 
c
->
Îc_sh¬ed_m­
);

402 
	`ıumask_£t_ıu
(
ıu
, 
	`ıu_d©a
(
i
).
Îc_sh¬ed_m­
);

404 ià(
c
->
phys_´oc_id
 =ğ
	`ıu_d©a
(
i
).phys_proc_id) {

405 
	`ıumask_£t_ıu
(
i
, 
	`ıu_cÜe_mask
(
ıu
));

406 
	`ıumask_£t_ıu
(
ıu
, 
	`ıu_cÜe_mask
(
i
));

410 ià(
	`ıumask_weight
(
	`ıu_siblšg_mask
(
ıu
)) == 1) {

415 ià(
	`ıumask_fœ¡
(
	`ıu_siblšg_mask
(
i
)) == i)

416 
c
->
boÙed_cÜes
++;

421 ià(
i
 !ğ
ıu
)

422 
	`ıu_d©a
(
i
).
boÙed_cÜes
++;

423 } ià(
i
 !ğ
ıu
 && !
c
->
boÙed_cÜes
)

424 
c
->
boÙed_cÜes
 = 
	`ıu_d©a
(
i
).booted_cores;

427 
	}
}

430 cÚ¡ 
ıumask
 *
	$ıu_cÜegroup_mask
(
ıu
)

432 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

437 ià(
sched_mc_pow”_§všgs
 || 
sched_smt_pow”_§všgs
)

438  
	`ıu_cÜe_mask
(
ıu
);

440  
c
->
Îc_sh¬ed_m­
;

441 
	}
}

443 
	$im´ess_ä›nds
()

445 
ıu
;

446 
bogosum
 = 0;

450 
	`´_debug
("Before bogomips.\n");

451 
	`fÜ_—ch_possibË_ıu
(
ıu
)

452 ià(
	`ıumask_‹¡_ıu
(
ıu
, 
ıu_ÿÎout_mask
))

453 
bogosum
 +ğ
	`ıu_d©a
(
ıu
).
loİs_³r_jiffy
;

454 
	`´štk
(
KERN_INFO


456 
	`num_Úlše_ıus
(),

457 
bogosum
/(500000/
HZ
),

458 (
bogosum
/(5000/
HZ
))%100);

460 
	`´_debug
("Before bogocount - setting‡ctivated=1.\n");

461 
	}
}

463 
	$__šquœe_»mÙe_­ic
(
­icid
)

465 
i
, 
»gs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

466 *
Çmes
[] = { "ID", "VERSION", "SPIV" };

467 
timeout
;

468 
u32
 
¡©us
;

470 
	`´štk
(
KERN_INFO
 "Inquœšg„emÙAPIC 0x%x...\n", 
­icid
);

472 
i
 = 0; i < 
	`ARRAY_SIZE
(
»gs
); i++) {

473 
	`´štk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
­icid
, 
Çmes
[
i
]);

478 
¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

479 ià(
¡©us
)

480 
	`´štk
(
KERN_CONT


483 
	`­ic_iü_wr™e
(
APIC_DM_REMRD
 | 
»gs
[
i
], 
­icid
);

485 
timeout
 = 0;

487 
	`ud–ay
(100);

488 
¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_RR_MASK
;

489 } 
¡©us
 =ğ
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

491 
¡©us
) {

492 
APIC_ICR_RR_VALID
:

493 
¡©us
 = 
	`­ic_»ad
(
APIC_RRR
);

494 
	`´štk
(
KERN_CONT
 "%08x\n", 
¡©us
);

497 
	`´štk
(
KERN_CONT
 "failed\n");

500 
	}
}

507 
__devš™


508 
	$wakeup_£cÚd¬y_ıu_vŸ_nmi
(
logiÿl_­icid
, 
¡¬t_e
)

510 
£nd_¡©us
, 
acû±_¡©us
 = 0;

511 
maxlvt
;

516 
	`­ic_iü_wr™e
(
APIC_DM_NMI
 | 
­ic
->
de¡_logiÿl
, 
logiÿl_­icid
);

518 
	`´_debug
("Waiting for sendo finish...\n");

519 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

524 
	`ud–ay
(200);

525 ià(
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])) {

526 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

527 ià(
maxlvt
 > 3)

528 
	`­ic_wr™e
(
APIC_ESR
, 0);

529 
acû±_¡©us
 = (
	`­ic_»ad
(
APIC_ESR
) & 0xEF);

531 
	`´_debug
("NMI sent.\n");

533 ià(
£nd_¡©us
)

534 
	`´štk
(
KERN_ERR
 "APIC‚ever delivered???\n");

535 ià(
acû±_¡©us
)

536 
	`´štk
(
KERN_ERR
 "APIC d–iv”yƒ¼Ü (%lx).\n", 
acû±_¡©us
);

538  (
£nd_¡©us
 | 
acû±_¡©us
);

539 
	}
}

541 
__devš™


542 
	$wakeup_£cÚd¬y_ıu_vŸ_š™
(
phys_­icid
, 
¡¬t_e
)

544 
£nd_¡©us
, 
acû±_¡©us
 = 0;

545 
maxlvt
, 
num_¡¬ts
, 
j
;

547 
maxlvt
 = 
	`Ïpic_g‘_maxlvt
();

552 ià(
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
phys_­icid
])) {

553 ià(
maxlvt
 > 3)

554 
	`­ic_wr™e
(
APIC_ESR
, 0);

555 
	`­ic_»ad
(
APIC_ESR
);

558 
	`´_debug
("Asserting INIT.\n");

566 
	`­ic_iü_wr™e
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

567 
phys_­icid
);

569 
	`´_debug
("Waiting for sendo finish...\n");

570 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

572 
	`md–ay
(10);

574 
	`´_debug
("Deasserting INIT.\n");

578 
	`­ic_iü_wr™e
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_­icid
);

580 
	`´_debug
("Waiting for sendo finish...\n");

581 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

583 
	`mb
();

584 
	`©omic_£t
(&
š™_d—s£¹ed
, 1);

592 ià(
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
phys_­icid
]))

593 
num_¡¬ts
 = 2;

595 
num_¡¬ts
 = 0;

601 
	`¡¬tup_i_hook
(
phys_­icid
, (è
¡¬t_£cÚd¬y
,

602 ()
¡ack_¡¬t
.
¥
);

607 
	`´_debug
("#¡¬tu°loİs: %d.\n", 
num_¡¬ts
);

609 
j
 = 1; j <ğ
num_¡¬ts
; j++) {

610 
	`´_debug
("S’dšg STARTUP #%d.\n", 
j
);

611 ià(
maxlvt
 > 3)

612 
	`­ic_wr™e
(
APIC_ESR
, 0);

613 
	`­ic_»ad
(
APIC_ESR
);

614 
	`´_debug
("After‡pic_write.\n");

623 
	`­ic_iü_wr™e
(
APIC_DM_STARTUP
 | (
¡¬t_e
 >> 12),

624 
phys_­icid
);

629 
	`ud–ay
(300);

631 
	`´_debug
("Startup…oint 1.\n");

633 
	`´_debug
("Waiting for sendo finish...\n");

634 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

639 
	`ud–ay
(200);

640 ià(
maxlvt
 > 3)

641 
	`­ic_wr™e
(
APIC_ESR
, 0);

642 
acû±_¡©us
 = (
	`­ic_»ad
(
APIC_ESR
) & 0xEF);

643 ià(
£nd_¡©us
 || 
acû±_¡©us
)

646 
	`´_debug
("After Startup.\n");

648 ià(
£nd_¡©us
)

649 
	`´štk
(
KERN_ERR
 "APIC‚ever delivered???\n");

650 ià(
acû±_¡©us
)

651 
	`´štk
(
KERN_ERR
 "APIC d–iv”yƒ¼Ü (%lx).\n", 
acû±_¡©us
);

653  (
£nd_¡©us
 | 
acû±_¡©us
);

654 
	}
}

656 
	sü—‹_idË
 {

657 
wÜk_¡ruù
 
	mwÜk
;

658 
sk_¡ruù
 *
	midË
;

659 
com¶‘iÚ
 
	mdÚe
;

660 
	mıu
;

663 
__ıuš™
 
	$do_fÜk_idË
(
wÜk_¡ruù
 *
wÜk
)

665 
ü—‹_idË
 *
c_idË
 =

666 
	`cÚš”_of
(
wÜk
, 
ü—‹_idË
, work);

668 
c_idË
->
idË
 = 
	`fÜk_idË
(c_idË->
ıu
);

669 
	`com¶‘e
(&
c_idË
->
dÚe
);

670 
	}
}

678 
__ıuš™
 
	$do_boÙ_ıu
(
­icid
, 
ıu
)

680 
boÙ_”rÜ
 = 0;

681 
¡¬t_
;

682 
timeout
;

683 
ü—‹_idË
 
c_idË
 = {

684 .
ıu
 = cpu,

685 .
dÚe
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idË
.done),

688 
	`INIT_WORK
(&
c_idË
.
wÜk
, 
do_fÜk_idË
);

690 
	`®‹º©ives_smp_sw™ch
(1);

692 
c_idË
.
idË
 = 
	`g‘_idË_fÜ_ıu
(
ıu
);

698 ià(
c_idË
.
idË
) {

699 
c_idË
.
idË
->
th»ad
.
¥
 = (è(((
±_»gs
 *)

700 (
THREAD_SIZE
 + 
	`sk_¡ack_·ge
(
c_idË
.
idË
))) - 1);

701 
	`š™_idË
(
c_idË
.
idË
, 
ıu
);

702 
do_»¡
;

705 ià(!
	`kev’td_up
(è|| 
	`cu¼’t_is_kev’td
())

706 
c_idË
.
wÜk
.
	`func
(&c_idle.work);

708 
	`scheduË_wÜk
(&
c_idË
.
wÜk
);

709 
	`wa™_fÜ_com¶‘iÚ
(&
c_idË
.
dÚe
);

712 ià(
	`IS_ERR
(
c_idË
.
idË
)) {

713 
	`´štk
("çed fÜk fÜ CPU %d\n", 
ıu
);

714  
	`PTR_ERR
(
c_idË
.
idË
);

717 
	`£t_idË_fÜ_ıu
(
ıu
, 
c_idË
.
idË
);

718 
do_»¡
:

719 
	`³r_ıu
(
cu¼’t_sk
, 
ıu
èğ
c_idË
.
idË
;

720 #ifdeà
CONFIG_X86_32


722 
	`œq_ùx_š™
(
ıu
);

724 
	`ş—r_tsk_th»ad_æag
(
c_idË
.
idË
, 
TIF_FORK
);

725 
š™Ÿl_gs
 = 
	`³r_ıu_off£t
(
ıu
);

726 
	`³r_ıu
(
k”Ãl_¡ack
, 
ıu
) =

727 ()
	`sk_¡ack_·ge
(
c_idË
.
idË
) -

728 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

730 
—¾y_gdt_desü
.
add»ss
 = ()
	`g‘_ıu_gdt_bË
(
ıu
);

731 
š™Ÿl_code
 = ()
¡¬t_£cÚd¬y
;

732 
¡ack_¡¬t
.
¥
 = (*è
c_idË
.
idË
->
th»ad
.sp;

735 
¡¬t_
 = 
	`£tup_ŒampŞše
();

738 
	`´štk
(
KERN_INFO
 "Booting…rocessor %d APIC 0x%x ip 0x%lx\n",

739 
ıu
, 
­icid
, 
¡¬t_
);

746 
	`©omic_£t
(&
š™_d—s£¹ed
, 0);

748 ià(
	`g‘_uv_sy¡em_ty³
(è!ğ
UV_NON_UNIQUE_APIC
) {

750 
	`´_debug
("Setting warm„eset code‡nd vector.\n");

752 
	`smpboÙ_£tup_w¬m_»£t_veùÜ
(
¡¬t_
);

756 ià(
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])) {

757 
	`­ic_wr™e
(
APIC_ESR
, 0);

758 
	`­ic_»ad
(
APIC_ESR
);

766 ià(
­ic
->
wakeup_£cÚd¬y_ıu
)

767 
boÙ_”rÜ
 = 
­ic
->
	`wakeup_£cÚd¬y_ıu
(
­icid
, 
¡¬t_
);

769 
boÙ_”rÜ
 = 
	`wakeup_£cÚd¬y_ıu_vŸ_š™
(
­icid
, 
¡¬t_
);

771 ià(!
boÙ_”rÜ
) {

775 
	`´_debug
("BefÜC®louˆ%d.\n", 
ıu
);

776 
	`ıumask_£t_ıu
(
ıu
, 
ıu_ÿÎout_mask
);

777 
	`´_debug
("Aá” C®louˆ%d.\n", 
ıu
);

782 
timeout
 = 0;imeout < 50000;imeout++) {

783 ià(
	`ıumask_‹¡_ıu
(
ıu
, 
ıu_ÿÎš_mask
))

785 
	`ud–ay
(100);

788 ià(
	`ıumask_‹¡_ıu
(
ıu
, 
ıu_ÿÎš_mask
)) {

790 
	`´_debug
("OK.\n");

791 
	`´štk
(
KERN_INFO
 "CPU%d: ", 
ıu
);

792 
	`´št_ıu_šfo
(&
	`ıu_d©a
(
ıu
));

793 
	`´_debug
("CPU has booted.\n");

795 
boÙ_”rÜ
 = 1;

796 ià(*((vŞ©*)
ŒampŞše_ba£
)

799 
	`´štk
(
KERN_ERR
 "Stuck ??\n");

802 
	`´štk
(
KERN_ERR
 "Not„esponding.\n");

803 ià(
­ic
->
šquœe_»mÙe_­ic
)

804 
­ic
->
	`šquœe_»mÙe_­ic
(
­icid
);

808 ià(
boÙ_”rÜ
) {

810 
	`numa_»move_ıu
(
ıu
);

813 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_ÿÎout_mask
);

816 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_š™Ÿlized_mask
);

818 
	`£t_ıu_´e£Á
(
ıu
, 
çl£
);

819 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
èğ
BAD_APICID
;

823 *((vŞ©*)
ŒampŞše_ba£
) = 0;

828 
	`smpboÙ_»¡Üe_w¬m_»£t_veùÜ
();

830  
boÙ_”rÜ
;

831 
	}
}

833 
__ıuš™
 
	$Çtive_ıu_up
(
ıu
)

835 
­icid
 = 
­ic
->
	`ıu_´e£Á_to_­icid
(
ıu
);

836 
æags
;

837 
”r
;

839 
	`WARN_ON
(
	`œqs_di§bËd
());

841 
	`´_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
ıu
);

843 ià(
­icid
 =ğ
BAD_APICID
 ||‡picid =ğ
boÙ_ıu_physiÿl_­icid
 ||

844 !
	`physid_is£t
(
­icid
, 
phys_ıu_´e£Á_m­
)) {

845 
	`´štk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
ıu
);

846  -
EINVAL
;

852 ià(
	`ıumask_‹¡_ıu
(
ıu
, 
ıu_ÿÎš_mask
)) {

853 
	`´_debug
("do_boÙ_ıu %d AÌ—dy s¹ed\n", 
ıu
);

854  -
ENOSYS
;

861 
	`mŒr_§ve_¡©e
();

863 
	`³r_ıu
(
ıu_¡©e
, 
ıu
èğ
CPU_UP_PREPARE
;

865 #ifdeà
CONFIG_X86_32


867 
	`şÚe_pgd_¿nge
(
sw­³r_pg_dœ
, sw­³r_pg_dœ + 
KERNEL_PGD_BOUNDARY
,

868 
	`mš_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

869 
	`æush_b_®l
();

870 
low_m­pšgs
 = 1;

872 
”r
 = 
	`do_boÙ_ıu
(
­icid
, 
ıu
);

874 
	`z­_low_m­pšgs
();

875 
low_m­pšgs
 = 0;

877 
”r
 = 
	`do_boÙ_ıu
(
­icid
, 
ıu
);

879 ià(
”r
) {

880 
	`´_debug
("do_boÙ_ıu faed %d\n", 
”r
);

881  -
EIO
;

888 
	`loÿl_œq_§ve
(
æags
);

889 
	`check_tsc_sync_sourû
(
ıu
);

890 
	`loÿl_œq_»¡Üe
(
æags
);

892 !
	`ıu_Úlše
(
ıu
)) {

893 
	`ıu_»Ïx
();

894 
	`touch_nmi_w©chdog
();

898 
	}
}

905 
__š™
 
	$di§bË_smp
()

907 
	`š™_ıu_´e£Á
(
	`ıumask_of
(0));

908 
	`š™_ıu_possibË
(
	`ıumask_of
(0));

909 
	`smpboÙ_ş—r_io_­ic_œqs
();

911 ià(
smp_found_cÚfig
)

912 
	`physid_£t_mask_of_physid
(
boÙ_ıu_physiÿl_­icid
, &
phys_ıu_´e£Á_m­
);

914 
	`physid_£t_mask_of_physid
(0, &
phys_ıu_´e£Á_m­
);

915 
	`m­_ıu_to_logiÿl_­icid
();

916 
	`ıumask_£t_ıu
(0, 
	`ıu_siblšg_mask
(0));

917 
	`ıumask_£t_ıu
(0, 
	`ıu_cÜe_mask
(0));

918 
	}
}

923 
__š™
 
	$smp_§n™y_check
(
max_ıus
)

925 
	`´“m±_di§bË
();

927 #ià!
	`defšed
(
CONFIG_X86_BIGSMP
è&& defšed(
CONFIG_X86_32
)

928 ià(
def_to_bigsmp
 && 
Ä_ıu_ids
 > 8) {

929 
ıu
;

930 
Ä
;

932 
	`´štk
(
KERN_WARNING


936 
Ä
 = 0;

937 
	`fÜ_—ch_´e£Á_ıu
(
ıu
) {

938 ià(
Ä
 >= 8)

939 
	`£t_ıu_´e£Á
(
ıu
, 
çl£
);

940 
Ä
++;

943 
Ä
 = 0;

944 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

945 ià(
Ä
 >= 8)

946 
	`£t_ıu_possibË
(
ıu
, 
çl£
);

947 
Ä
++;

950 
Ä_ıu_ids
 = 8;

954 ià(!
	`physid_is£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
)) {

955 
	`´štk
(
KERN_WARNING


957 
	`h¬d_smp_´oûssÜ_id
());

959 
	`physid_£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
);

966 ià(!
smp_found_cÚfig
 && !
aıi_Ïpic
) {

967 
	`´“m±_’abË
();

968 
	`´štk
(
KERN_NOTICE
 "SMP motherboard‚ot detected.\n");

969 
	`di§bË_smp
();

970 ià(
	`APIC_š™_unroûssÜ
())

971 
	`´štk
(
KERN_NOTICE
 "Local APIC‚ot detected."

980 ià(!
­ic
->
	`check_phys_­icid_´e£Á
(
boÙ_ıu_physiÿl_­icid
)) {

981 
	`´štk
(
KERN_NOTICE


983 
boÙ_ıu_physiÿl_­icid
);

984 
	`physid_£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
);

986 
	`´“m±_’abË
();

991 ià(
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
]) &&

992 !
ıu_has_­ic
) {

993 
	`´štk
(
KERN_ERR
 "BIOS bug,†ocal APIC #%d‚ot detected!...\n",

994 
boÙ_ıu_physiÿl_­icid
);

995 
	`´štk
(
KERN_ERR
 "... forcing use of dummy APICƒmulation."

997 
	`smpboÙ_ş—r_io_­ic
();

998 
	`¬ch_di§bË_smp_suµÜt
();

1002 
	`v”ify_loÿl_APIC
();

1007 ià(!
max_ıus
) {

1008 
	`´štk
(
KERN_INFO
 "SMP mode deactivated.\n");

1009 
	`smpboÙ_ş—r_io_­ic
();

1011 
	`loÿli£_nmi_w©chdog
();

1013 
	`cÚÃù_b¥_APIC
();

1014 
	`£tup_loÿl_APIC
();

1015 
	`’d_loÿl_APIC_£tup
();

1020 
	}
}

1022 
__š™
 
	$smp_ıu_šdex_deçuÉ
()

1024 
i
;

1025 
ıušfo_x86
 *
c
;

1027 
	`fÜ_—ch_possibË_ıu
(
i
) {

1028 
c
 = &
	`ıu_d©a
(
i
);

1030 
c
->
ıu_šdex
 = 
Ä_ıu_ids
;

1032 
	}
}

1038 
__š™
 
	$Çtive_smp_´•¬e_ıus
(
max_ıus
)

1040 
i
;

1042 
	`´“m±_di§bË
();

1043 
	`smp_ıu_šdex_deçuÉ
();

1044 
cu¼’t_ıu_d©a
 = 
boÙ_ıu_d©a
;

1045 
	`ıumask_cİy
(
ıu_ÿÎš_mask
, 
	`ıumask_of
(0));

1046 
	`mb
();

1050 
	`smp_¡Üe_ıu_šfo
(0);

1051 #ifdeà
CONFIG_X86_32


1052 
boÙ_ıu_logiÿl_­icid
 = 
	`logiÿl_smp_´oûssÜ_id
();

1054 
	`cu¼’t_th»ad_šfo
()->
ıu
 = 0;

1055 
	`fÜ_—ch_possibË_ıu
(
i
) {

1056 
	`®loc_ıumask_v¬
(&
	`³r_ıu
(
ıu_siblšg_m­
, 
i
), 
GFP_KERNEL
);

1057 
	`®loc_ıumask_v¬
(&
	`³r_ıu
(
ıu_cÜe_m­
, 
i
), 
GFP_KERNEL
);

1058 
	`®loc_ıumask_v¬
(&
	`ıu_d©a
(
i
).
Îc_sh¬ed_m­
, 
GFP_KERNEL
);

1059 
	`ıumask_ş—r
(
	`³r_ıu
(
ıu_cÜe_m­
, 
i
));

1060 
	`ıumask_ş—r
(
	`³r_ıu
(
ıu_siblšg_m­
, 
i
));

1061 
	`ıumask_ş—r
(
	`ıu_d©a
(
i
).
Îc_sh¬ed_m­
);

1063 
	`£t_ıu_siblšg_m­
(0);

1065 
	`’abË_IR_x2­ic
();

1066 #ifdeà
CONFIG_X86_64


1067 
	`deçuÉ_£tup_­ic_routšg
();

1070 ià(
	`smp_§n™y_check
(
max_ıus
) < 0) {

1071 
	`´štk
(
KERN_INFO
 "SMP disabled\n");

1072 
	`di§bË_smp
();

1073 
out
;

1076 
	`´“m±_di§bË
();

1077 ià(
	`»ad_­ic_id
(è!ğ
boÙ_ıu_physiÿl_­icid
) {

1078 
	`·nic
("Boot APIC ID in†ocal APIC unexpected (%d vs %d)",

1079 
	`»ad_­ic_id
(), 
boÙ_ıu_physiÿl_­icid
);

1082 
	`´“m±_’abË
();

1084 
	`cÚÃù_b¥_APIC
();

1089 
	`£tup_loÿl_APIC
();

1094 ià(!
sk_ißpic_£tup
 && 
Ä_ißpics
)

1095 
	`’abË_IO_APIC
();

1097 
	`’d_loÿl_APIC_£tup
();

1099 
	`m­_ıu_to_logiÿl_­icid
();

1101 ià(
­ic
->
£tup_pÜtio_»m­
)

1102 
­ic
->
	`£tup_pÜtio_»m­
();

1104 
	`smpboÙ_£tup_io_­ic
();

1109 
	`´štk
(
KERN_INFO
 "CPU%d: ", 0);

1110 
	`´št_ıu_šfo
(&
	`ıu_d©a
(0));

1111 
	`£tup_boÙ_şock
();

1113 ià(
	`is_uv_sy¡em
())

1114 
	`uv_sy¡em_š™
();

1115 
out
:

1116 
	`´“m±_’abË
();

1117 
	}
}

1121 
__š™
 
	$Çtive_smp_´•¬e_boÙ_ıu
()

1123 
me
 = 
	`smp_´oûssÜ_id
();

1124 
	`sw™ch_to_Ãw_gdt
(
me
);

1126 
	`ıumask_£t_ıu
(
me
, 
ıu_ÿÎout_mask
);

1127 
	`³r_ıu
(
ıu_¡©e
, 
me
èğ
CPU_ONLINE
;

1128 
	}
}

1130 
__š™
 
	$Çtive_smp_ıus_dÚe
(
max_ıus
)

1132 
	`´_debug
("Boot done.\n");

1134 
	`im´ess_ä›nds
();

1135 #ifdeà
CONFIG_X86_IO_APIC


1136 
	`£tup_ißpic_de¡
();

1138 
	`check_nmi_w©chdog
();

1139 
	}
}

1141 
__š™d©a
 
	g£tup_possibË_ıus
 = -1;

1142 
__š™
 
	$_£tup_possibË_ıus
(*
¡r
)

1144 
	`g‘_İtiÚ
(&
¡r
, &
£tup_possibË_ıus
);

1146 
	}
}

1147 
—¾y_·¿m
("possibË_ıus", 
_£tup_possibË_ıus
);

1167 
__š™
 
	$´efl_possibË_m­
()

1169 
i
, 
possibË
;

1172 ià(!
num_´oûssÜs
)

1173 
num_´oûssÜs
 = 1;

1175 ià(
£tup_possibË_ıus
 == -1)

1176 
possibË
 = 
num_´oûssÜs
 + 
di§bËd_ıus
;

1178 
possibË
 = 
£tup_possibË_ıus
;

1180 
tÙ®_ıus
 = 
	`max_t
(, 
possibË
, 
num_´oûssÜs
 + 
di§bËd_ıus
);

1182 ià(
possibË
 > 
CONFIG_NR_CPUS
) {

1183 
	`´štk
(
KERN_WARNING


1185 
possibË
, 
CONFIG_NR_CPUS
);

1186 
possibË
 = 
CONFIG_NR_CPUS
;

1189 
	`´štk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1190 
possibË
, 
	`max_t
(,…ossibË - 
num_´oûssÜs
, 0));

1192 
i
 = 0; i < 
possibË
; i++)

1193 
	`£t_ıu_possibË
(
i
, 
Œue
);

1195 
Ä_ıu_ids
 = 
possibË
;

1196 
	}
}

1198 #ifdeà
CONFIG_HOTPLUG_CPU


1200 
	$»move_siblšgšfo
(
ıu
)

1202 
siblšg
;

1203 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

1205 
	`fÜ_—ch_ıu
(
siblšg
, 
	`ıu_cÜe_mask
(
ıu
)) {

1206 
	`ıumask_ş—r_ıu
(
ıu
, 
	`ıu_cÜe_mask
(
siblšg
));

1210 ià(
	`ıumask_weight
(
	`ıu_siblšg_mask
(
ıu
)) == 1)

1211 
	`ıu_d©a
(
siblšg
).
boÙed_cÜes
--;

1214 
	`fÜ_—ch_ıu
(
siblšg
, 
	`ıu_siblšg_mask
(
ıu
))

1215 
	`ıumask_ş—r_ıu
(
ıu
, 
	`ıu_siblšg_mask
(
siblšg
));

1216 
	`ıumask_ş—r
(
	`ıu_siblšg_mask
(
ıu
));

1217 
	`ıumask_ş—r
(
	`ıu_cÜe_mask
(
ıu
));

1218 
c
->
phys_´oc_id
 = 0;

1219 
c
->
ıu_cÜe_id
 = 0;

1220 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_siblšg_£tup_mask
);

1221 
	}
}

1223 
__»f
 
	$»move_ıu_äom_m­s
(
ıu
)

1225 
	`£t_ıu_Úlše
(
ıu
, 
çl£
);

1226 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_ÿÎout_mask
);

1227 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_ÿÎš_mask
);

1229 
	`ıumask_ş—r_ıu
(
ıu
, 
ıu_š™Ÿlized_mask
);

1230 
	`numa_»move_ıu
(
ıu
);

1231 
	}
}

1233 
	$ıu_di§bË_commÚ
()

1235 
ıu
 = 
	`smp_´oûssÜ_id
();

1242 
	`loÿl_œq_’abË
();

1243 
	`md–ay
(1);

1245 
	`loÿl_œq_di§bË
();

1246 
	`»move_siblšgšfo
(
ıu
);

1249 
	`lock_veùÜ_lock
();

1250 
	`»move_ıu_äom_m­s
(
ıu
);

1251 
	`uÆock_veùÜ_lock
();

1252 
	`fixup_œqs
();

1253 
	}
}

1255 
	$Çtive_ıu_di§bË
()

1257 
ıu
 = 
	`smp_´oûssÜ_id
();

1267 ià(
ıu
 == 0)

1268  -
EBUSY
;

1270 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

1271 
	`¡İ_­ic_nmi_w©chdog
(
NULL
);

1272 
	`ş—r_loÿl_APIC
();

1274 
	`ıu_di§bË_commÚ
();

1276 
	}
}

1278 
	$Çtive_ıu_d›
(
ıu
)

1281 
i
;

1283 
i
 = 0; i < 10; i++) {

1285 ià(
	`³r_ıu
(
ıu_¡©e
, 
ıu
è=ğ
CPU_DEAD
) {

1286 
	`´štk
(
KERN_INFO
 "CPU %d i now ofæše\n", 
ıu
);

1287 ià(1 =ğ
	`num_Úlše_ıus
())

1288 
	`®‹º©ives_smp_sw™ch
(0);

1291 
	`m¦“p
(100);

1293 
	`´štk
(
KERN_ERR
 "CPU %u didn'ˆd›...\n", 
ıu
);

1294 
	}
}

1296 
	$¶ay_d—d_commÚ
()

1298 
	`idË_sk_ex™
();

1299 
	`»£t_Ïzy_b¡©e
();

1300 
	`œq_ùx_ex™
(
	`¿w_smp_´oûssÜ_id
());

1301 
	`c1e_»move_ıu
(
	`¿w_smp_´oûssÜ_id
());

1303 
	`mb
();

1305 
	`__g‘_ıu_v¬
(
ıu_¡©e
èğ
CPU_DEAD
;

1310 
	`loÿl_œq_di§bË
();

1311 
	}
}

1313 
	$Çtive_¶ay_d—d
()

1315 
	`¶ay_d—d_commÚ
();

1316 
	`wbšvd_h®t
();

1317 
	}
}

1320 
	$Çtive_ıu_di§bË
()

1322  -
ENOSYS
;

1323 
	}
}

1325 
	$Çtive_ıu_d›
(
ıu
)

1328 
	`BUG
();

1329 
	}
}

1331 
	$Çtive_¶ay_d—d
()

1333 
	`BUG
();

1334 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/¡ackŒaû.h
>

8 
	~<lšux/moduË.h
>

9 
	~<lšux/uacûss.h
>

10 
	~<asm/¡ackŒaû.h
>

12 
	$§ve_¡ack_w¬nšg
(*
d©a
, *
msg
)

14 
	}
}

17 
	$§ve_¡ack_w¬nšg_symbŞ
(*
d©a
, *
msg
, 
symbŞ
)

19 
	}
}

21 
	$§ve_¡ack_¡ack
(*
d©a
, *
Çme
)

24 
	}
}

26 
	$§ve_¡ack_add»ss
(*
d©a
, 
addr
, 
»lŸbË
)

28 
¡ack_Œaû
 *
Œaû
 = 
d©a
;

29 ià(!
»lŸbË
)

31 ià(
Œaû
->
sk
 > 0) {

32 
Œaû
->
sk
--;

35 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

36 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
addr
;

37 
	}
}

40 
	$§ve_¡ack_add»ss_nosched
(*
d©a
, 
addr
, 
»lŸbË
)

42 
¡ack_Œaû
 *
Œaû
 = (¡ack_Œaû *)
d©a
;

43 ià(!
»lŸbË
)

45 ià(
	`š_sched_funùiÚs
(
addr
))

47 ià(
Œaû
->
sk
 > 0) {

48 
Œaû
->
sk
--;

51 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

52 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
addr
;

53 
	}
}

55 cÚ¡ 
¡ackŒaû_İs
 
	g§ve_¡ack_İs
 = {

56 .
w¬nšg
 = 
§ve_¡ack_w¬nšg
,

57 .
	gw¬nšg_symbŞ
 = 
§ve_¡ack_w¬nšg_symbŞ
,

58 .
	g¡ack
 = 
§ve_¡ack_¡ack
,

59 .
	gadd»ss
 = 
§ve_¡ack_add»ss
,

62 cÚ¡ 
¡ackŒaû_İs
 
	g§ve_¡ack_İs_nosched
 = {

63 .
w¬nšg
 = 
§ve_¡ack_w¬nšg
,

64 .
	gw¬nšg_symbŞ
 = 
§ve_¡ack_w¬nšg_symbŞ
,

65 .
	g¡ack
 = 
§ve_¡ack_¡ack
,

66 .
	gadd»ss
 = 
§ve_¡ack_add»ss_nosched
,

72 
	$§ve_¡ack_Œaû
(
¡ack_Œaû
 *
Œaû
)

74 
	`dump_Œaû
(
cu¼’t
, 
NULL
, NULL, 0, &
§ve_¡ack_İs
, 
Œaû
);

75 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

76 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
ULONG_MAX
;

77 
	}
}

78 
EXPORT_SYMBOL_GPL
(
§ve_¡ack_Œaû
);

80 
	$§ve_¡ack_Œaû_tsk
(
sk_¡ruù
 *
tsk
, 
¡ack_Œaû
 *
Œaû
)

82 
	`dump_Œaû
(
tsk
, 
NULL
, NULL, 0, &
§ve_¡ack_İs_nosched
, 
Œaû
);

83 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

84 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
ULONG_MAX
;

85 
	}
}

86 
EXPORT_SYMBOL_GPL
(
§ve_¡ack_Œaû_tsk
);

90 
	s¡ack_äame
 {

91 cÚ¡ 
__u£r
 *
	mÃxt_å
;

92 
	m»t_addr
;

95 
	$cİy_¡ack_äame
(cÚ¡ 
__u£r
 *
å
, 
¡ack_äame
 *
äame
)

97 
»t
;

99 ià(!
	`acûss_ok
(
VERIFY_READ
, 
å
, (*
äame
)))

102 
»t
 = 1;

103 
	`·geçuÉ_di§bË
();

104 ià(
	`__cİy_äom_u£r_š©omic
(
äame
, 
å
, (*frame)))

105 
»t
 = 0;

106 
	`·geçuÉ_’abË
();

108  
»t
;

109 
	}
}

111 
šlše
 
	$__§ve_¡ack_Œaû_u£r
(
¡ack_Œaû
 *
Œaû
)

113 cÚ¡ 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
cu¼’t
);

114 cÚ¡ 
__u£r
 *
å
 = (cÚ¡ __u£¸*)
»gs
->
bp
;

116 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

117 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
»gs
->

;

119 
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
) {

120 
¡ack_äame
 
äame
;

122 
äame
.
Ãxt_å
 = 
NULL
;

123 
äame
.
»t_addr
 = 0;

124 ià(!
	`cİy_¡ack_äame
(
å
, &
äame
))

126 ià(()
å
 < 
»gs
->
¥
)

128 ià(
äame
.
»t_addr
) {

129 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] =

130 
äame
.
»t_addr
;

132 ià(
å
 =ğ
äame
.
Ãxt_å
)

134 
å
 = 
äame
.
Ãxt_å
;

136 
	}
}

138 
	$§ve_¡ack_Œaû_u£r
(
¡ack_Œaû
 *
Œaû
)

143 ià(
cu¼’t
->
mm
) {

144 
	`__§ve_¡ack_Œaû_u£r
(
Œaû
);

146 ià(
Œaû
->
Ä_’Œ›s
 <¿û->
max_’Œ›s
)

147 
Œaû
->
’Œ›s
[Œaû->
Ä_’Œ›s
++] = 
ULONG_MAX
;

148 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<lšux/sched.h
>

5 
	~<lšux/mm.h
>

6 
	~<lšux/±¿û.h
>

8 
	$cÚv”t__to_lš—r
(
sk_¡ruù
 *
chd
, 
±_»gs
 *
»gs
)

10 
addr
, 
£g
;

12 
addr
 = 
»gs
->

;

13 
£g
 = 
»gs
->
cs
 & 0xffff;

14 ià(
	`v8086_mode
(
»gs
)) {

15 
addr
 = (add¸& 0xffffè+ (
£g
 << 4);

16  
addr
;

25 ià((
£g
 & 
SEGMENT_TI_MASK
è=ğ
SEGMENT_LDT
) {

26 
u32
 *
desc
;

27 
ba£
;

29 
£g
 &= ~7UL;

31 
	`mu‹x_lock
(&
chd
->
mm
->
cÚ‹xt
.
lock
);

32 ià(
	`uÆik–y
((
£g
 >> 3è>ğ
chd
->
mm
->
cÚ‹xt
.
size
))

33 
addr
 = -1L;

35 
desc
 = 
chd
->
mm
->
cÚ‹xt
.
ldt
 + 
£g
;

36 
ba£
 = ((
desc
[0] >> 16) |

37 ((
desc
[1] & 0xff) << 16) |

38 (
desc
[1] & 0xff000000));

41 ià(!((
desc
[1] >> 22) & 1))

42 
addr
 &= 0xffff;

43 
addr
 +ğ
ba£
;

45 
	`mu‹x_uÆock
(&
chd
->
mm
->
cÚ‹xt
.
lock
);

48  
addr
;

49 
	}
}

51 
	$is_£‰šg_Œ­_æag
(
sk_¡ruù
 *
chd
, 
±_»gs
 *
»gs
)

53 
i
, 
cİ›d
;

54 
İcode
[15];

55 
addr
 = 
	`cÚv”t__to_lš—r
(
chd
, 
»gs
);

57 
cİ›d
 = 
	`acûss_´oûss_vm
(
chd
, 
addr
, 
İcode
, (opcode), 0);

58 
i
 = 0; i < 
cİ›d
; i++) {

59 
İcode
[
i
]) {

76 #ifdeà
CONFIG_X86_64


78 ià(
»gs
->
cs
 !ğ
__USER_CS
)

100 
	}
}

105 
	$’abË_sšgË_¡•
(
sk_¡ruù
 *
chd
)

107 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
chd
);

108 
oæags
;

120 ià(
	`uÆik–y
(
	`‹¡_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
)))

121 
»gs
->
æags
 |ğ
X86_EFLAGS_TF
;

128 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

130 
oæags
 = 
»gs
->
æags
;

133 
»gs
->
æags
 |ğ
X86_EFLAGS_TF
;

144 ià(
	`is_£‰šg_Œ­_æag
(
chd
, 
»gs
)) {

145 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_FORCED_TF
);

153 ià(
oæags
 & 
X86_EFLAGS_TF
)

154  
	`‹¡_tsk_th»ad_æag
(
chd
, 
TIF_FORCED_TF
);

156 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_FORCED_TF
);

159 
	}
}

164 
	$wr™e_debugùlm¤
(
sk_¡ruù
 *
chd
, 
v®
)

166 ià(
chd
->
th»ad
.
debugùlm¤
 =ğ
v®
)

169 
chd
->
th»ad
.
debugùlm¤
 = 
v®
;

171 ià(
chd
 !ğ
cu¼’t
)

174 
	`upd©e_debugùlm¤
(
v®
);

175 
	}
}

180 
	$’abË_¡•
(
sk_¡ruù
 *
chd
, 
boŞ
 
block
)

189 ià(
	`’abË_sšgË_¡•
(
chd
è&& 
block
) {

190 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_DEBUGCTLMSR
);

191 
	`wr™e_debugùlm¤
(
chd
,

192 
chd
->
th»ad
.
debugùlm¤
 | 
DEBUGCTLMSR_BTF
);

194 
	`wr™e_debugùlm¤
(
chd
,

195 
chd
->
th»ad
.
debugùlm¤
 & ~
DEBUGCTLMSR_BTF
);

197 ià(!
chd
->
th»ad
.
debugùlm¤
)

198 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_DEBUGCTLMSR
);

200 
	}
}

202 
	$u£r_’abË_sšgË_¡•
(
sk_¡ruù
 *
chd
)

204 
	`’abË_¡•
(
chd
, 0);

205 
	}
}

207 
	$u£r_’abË_block_¡•
(
sk_¡ruù
 *
chd
)

209 
	`’abË_¡•
(
chd
, 1);

210 
	}
}

212 
	$u£r_di§bË_sšgË_¡•
(
sk_¡ruù
 *
chd
)

217 
	`wr™e_debugùlm¤
(
chd
,

218 
chd
->
th»ad
.
debugùlm¤
 & ~
DEBUGCTLMSR_BTF
);

220 ià(!
chd
->
th»ad
.
debugùlm¤
)

221 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_DEBUGCTLMSR
);

224 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

227 ià(
	`‹¡_ªd_ş—r_tsk_th»ad_æag
(
chd
, 
TIF_FORCED_TF
))

228 
	`sk_±_»gs
(
chd
)->
æags
 &ğ~
X86_EFLAGS_TF
;

229 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<lšux/”ºo.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/sysÿÎs.h
>

4 
	~<lšux/mm.h
>

5 
	~<lšux/fs.h
>

6 
	~<lšux/smp.h
>

7 
	~<lšux/£m.h
>

8 
	~<lšux/msg.h
>

9 
	~<lšux/shm.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/mmª.h
>

12 
	~<lšux/fe.h
>

13 
	~<lšux/ut¢ame.h
>

14 
	~<lšux/³rsÚ®™y.h
>

15 
	~<lšux/¿ndom.h
>

16 
	~<lšux/uacûss.h
>

18 
	~<asm/Ÿ32.h
>

19 
	~<asm/sysÿÎs.h
>

21 
asmlškage
 
	$sys_mm­
(
addr
, 
Ën
,

22 
´Ù
, 
æags
,

23 
fd
, 
off
)

25 
”rÜ
;

26 
fe
 *file;

28 
”rÜ
 = -
EINVAL
;

29 ià(
off
 & ~
PAGE_MASK
)

30 
out
;

32 
”rÜ
 = -
EBADF
;

33 
fe
 = 
NULL
;

34 
æags
 &ğ~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

35 ià(!(
æags
 & 
MAP_ANONYMOUS
)) {

36 
fe
 = 
	`fg‘
(
fd
);

37 ià(!
fe
)

38 
out
;

40 
	`down_wr™e
(&
cu¼’t
->
mm
->
mm­_£m
);

41 
”rÜ
 = 
	`do_mm­_pgoff
(
fe
, 
addr
, 
Ën
, 
´Ù
, 
æags
, 
off
 >> 
PAGE_SHIFT
);

42 
	`up_wr™e
(&
cu¼’t
->
mm
->
mm­_£m
);

44 ià(
fe
)

45 
	`åut
(
fe
);

46 
out
:

47  
”rÜ
;

48 
	}
}

50 
	$fšd_¡¬t_’d
(
æags
, *
begš
,

51 *
’d
)

53 ià(!
	`‹¡_th»ad_æag
(
TIF_IA32
è&& (
æags
 & 
MAP_32BIT
)) {

54 
Ãw_begš
;

62 *
begš
 = 0x40000000;

63 *
’d
 = 0x80000000;

64 ià(
cu¼’t
->
æags
 & 
PF_RANDOMIZE
) {

65 
Ãw_begš
 = 
	`¿ndomize_¿nge
(*
begš
, *begin + 0x02000000, 0);

66 ià(
Ãw_begš
)

67 *
begš
 = 
Ãw_begš
;

70 *
begš
 = 
TASK_UNMAPPED_BASE
;

71 *
’d
 = 
TASK_SIZE
;

73 
	}
}

76 
	$¬ch_g‘_unm­³d_¬—
(
fe
 *
fp
, 
addr
,

77 
Ën
, 
pgoff
, 
æags
)

79 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

80 
vm_¬—_¡ruù
 *
vma
;

81 
¡¬t_addr
;

82 
begš
, 
’d
;

84 ià(
æags
 & 
MAP_FIXED
)

85  
addr
;

87 
	`fšd_¡¬t_’d
(
æags
, &
begš
, &
’d
);

89 ià(
Ën
 > 
’d
)

90  -
ENOMEM
;

92 ià(
addr
) {

93 
addr
 = 
	`PAGE_ALIGN
(addr);

94 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

95 ià(
’d
 - 
Ën
 >ğ
addr
 &&

96 (!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
))

97  
addr
;

99 ià(((
æags
 & 
MAP_32BIT
è|| 
	`‹¡_th»ad_æag
(
TIF_IA32
))

100 && 
Ën
 <ğ
mm
->
ÿched_hŞe_size
) {

101 
mm
->
ÿched_hŞe_size
 = 0;

102 
mm
->
ä“_¬—_ÿche
 = 
begš
;

104 
addr
 = 
mm
->
ä“_¬—_ÿche
;

105 ià(
addr
 < 
begš
)

106 
addr
 = 
begš
;

107 
¡¬t_addr
 = 
addr
;

109 
fuÎ_£¬ch
:

110 
vma
 = 
	`fšd_vma
(
mm
, 
addr
); ; vm¨ğvma->
vm_Ãxt
) {

112 ià(
’d
 - 
Ën
 < 
addr
) {

117 ià(
¡¬t_addr
 !ğ
begš
) {

118 
¡¬t_addr
 = 
addr
 = 
begš
;

119 
mm
->
ÿched_hŞe_size
 = 0;

120 
fuÎ_£¬ch
;

122  -
ENOMEM
;

124 ià(!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
) {

128 
mm
->
ä“_¬—_ÿche
 = 
addr
 + 
Ën
;

129  
addr
;

131 ià(
addr
 + 
mm
->
ÿched_hŞe_size
 < 
vma
->
vm_¡¬t
)

132 
mm
->
ÿched_hŞe_size
 = 
vma
->
vm_¡¬t
 - 
addr
;

134 
addr
 = 
vma
->
vm_’d
;

136 
	}
}

140 
	$¬ch_g‘_unm­³d_¬—_tİdown
(
fe
 *
fp
, cÚ¡ 
addr0
,

141 cÚ¡ 
Ën
, cÚ¡ 
pgoff
,

142 cÚ¡ 
æags
)

144 
vm_¬—_¡ruù
 *
vma
;

145 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

146 
addr
 = 
addr0
;

149 ià(
Ën
 > 
TASK_SIZE
)

150  -
ENOMEM
;

152 ià(
æags
 & 
MAP_FIXED
)

153  
addr
;

156 ià(!
	`‹¡_th»ad_æag
(
TIF_IA32
è&& (
æags
 & 
MAP_32BIT
))

157 
bÙtomup
;

160 ià(
addr
) {

161 
addr
 = 
	`PAGE_ALIGN
(addr);

162 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

163 ià(
TASK_SIZE
 - 
Ën
 >ğ
addr
 &&

164 (!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
))

165  
addr
;

169 ià(
Ën
 <ğ
mm
->
ÿched_hŞe_size
) {

170 
mm
->
ÿched_hŞe_size
 = 0;

171 
mm
->
ä“_¬—_ÿche
 = mm->
mm­_ba£
;

175 
addr
 = 
mm
->
ä“_¬—_ÿche
;

178 ià(
addr
 > 
Ën
) {

179 
vma
 = 
	`fšd_vma
(
mm
, 
addr
-
Ën
);

180 ià(!
vma
 || 
addr
 <ğvma->
vm_¡¬t
)

182  
mm
->
ä“_¬—_ÿche
 = 
addr
-
Ën
;

185 ià(
mm
->
mm­_ba£
 < 
Ën
)

186 
bÙtomup
;

188 
addr
 = 
mm
->
mm­_ba£
-
Ën
;

196 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

197 ià(!
vma
 || 
addr
+
Ën
 <ğvma->
vm_¡¬t
)

199  
mm
->
ä“_¬—_ÿche
 = 
addr
;

202 ià(
addr
 + 
mm
->
ÿched_hŞe_size
 < 
vma
->
vm_¡¬t
)

203 
mm
->
ÿched_hŞe_size
 = 
vma
->
vm_¡¬t
 - 
addr
;

206 
addr
 = 
vma
->
vm_¡¬t
-
Ën
;

207 } 
Ën
 < 
vma
->
vm_¡¬t
);

209 
bÙtomup
:

216 
mm
->
ÿched_hŞe_size
 = ~0UL;

217 
mm
->
ä“_¬—_ÿche
 = 
TASK_UNMAPPED_BASE
;

218 
addr
 = 
	`¬ch_g‘_unm­³d_¬—
(
fp
, 
addr0
, 
Ën
, 
pgoff
, 
æags
);

222 
mm
->
ä“_¬—_ÿche
 = mm->
mm­_ba£
;

223 
mm
->
ÿched_hŞe_size
 = ~0UL;

225  
addr
;

226 
	}
}

229 
asmlškage
 
	$sys_uÇme
(
Ãw_ut¢ame
 
__u£r
 *
Çme
)

231 
”r
;

232 
	`down_»ad
(&
uts_£m
);

233 
”r
 = 
	`cİy_to_u£r
(
Çme
, 
	`ut¢ame
(), (*name));

234 
	`up_»ad
(&
uts_£m
);

235 ià(
	`³rsÚ®™y
(
cu¼’t
->
³rsÚ®™y
è=ğ
PER_LINUX32
)

236 
”r
 |ğ
	`cİy_to_u£r
(&
Çme
->
machše
, "i686", 5);

237  
”r
 ? -
EFAULT
 : 0;

238 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<lšux/lškage.h
>

4 
	~<lšux/sys.h
>

5 
	~<lšux/ÿche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
Ä
, 
sym
è
asmlškage
 
	`sym
(è;

	)

11 #undeà
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni¡d_64.h
>

14 #undeà
__SYSCALL


15 
	#__SYSCALL
(
Ä
, 
sym
è[Ä] = sym,

	)

16 #undeà
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ÿÎ_±r_t
)();

20 
	`sys_ni_sysÿÎ
();

22 cÚ¡ 
sys_ÿÎ_±r_t
 
sys_ÿÎ_bË
[
__NR_sysÿÎ_max
+1] = {

27 [0 ... 
__NR_sysÿÎ_max
] = &
sys_ni_sysÿÎ
,

28 
	~<asm/uni¡d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/mm.h
>

29 
	~<lšux/¥šlock.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/pci.h
>

32 
	~<lšux/dma-m­pšg.h
>

33 
	~<lšux/boÙmem.h
>

34 
	~<asm/tû.h
>

35 
	~<asm/ÿlg¬y.h
>

36 
	~<asm/´Ùo.h
>

39 
šlše
 
	$æush_tû
(* 
tûaddr
)

42 ià(
ıu_has_şæush
)

43 
	`şæush
(
tûaddr
);

45 
	`wbšvd
();

46 
	}
}

48 
	$tû_bud
(
iommu_bË
 *
tbl
, 
šdex
,

49 
Åages
, 
uaddr
, 
dœeùiÚ
)

51 
u64
* 

;

52 
u64
 
t
;

53 
u64
 
½n
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 ià(
dœeùiÚ
 !ğ
DMA_TO_DEVICE
)

57 
t
 |ğ(1 << 
TCE_WRITE_SHIFT
);

59 

 = ((
u64
*)
tbl
->
™_ba£
è+ 
šdex
;

61 
Åages
--) {

62 
½n
 = (
	`vœt_to_bus
((*)
uaddr
)è>> 
PAGE_SHIFT
;

63 
t
 &ğ~
TCE_RPN_MASK
;

64 
t
 |ğ(
½n
 << 
TCE_RPN_SHIFT
);

66 *

 = 
	`ıu_to_be64
(
t
);

67 
	`æush_tû
(

);

69 
uaddr
 +ğ
PAGE_SIZE
;

70 

++;

72 
	}
}

74 
	$tû_ä“
(
iommu_bË
 *
tbl
, 
šdex
, 
Åages
)

76 
u64
* 

;

78 

 = ((
u64
*)
tbl
->
™_ba£
è+ 
šdex
;

80 
Åages
--) {

81 *

 = 
	`ıu_to_be64
(0);

82 
	`æush_tû
(

);

83 

++;

85 
	}
}

87 
šlše
 
	$bË_size_to_numb”_of_’Œ›s
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$tû_bË_£¬ms
(
pci_dev
 *
dev
, 
iommu_bË
 *
tbl
)

99 
b™m­sz
;

100 
bmµages
;

101 
»t
;

103 
tbl
->
™_bu¢o
 = 
dev
->
bus
->
numb”
;

106 
tbl
->
™_size
 = 
	`bË_size_to_numb”_of_’Œ›s
(
¥ecif›d_bË_size
);

112 
b™m­sz
 = 
tbl
->
™_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
b™m­sz
));

114 ià(!
bmµages
) {

115 
	`´štk
(
KERN_ERR
 "Calgary: cannot‡llocate bitmap\n");

116 
»t
 = -
ENOMEM
;

117 
dÚe
;

120 
tbl
->
™_m­
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
™_m­
, 0, 
b™m­sz
);

124 
tbl
->
™_hšt
 = 0;

126 
	`¥š_lock_š™
(&
tbl
->
™_lock
);

130 
dÚe
:

131  
»t
;

132 
	}
}

134 
__š™
 
	$bud_tû_bË
(
pci_dev
 *
dev
, 
__iomem
 *
bb¬
)

136 
iommu_bË
 *
tbl
;

137 
»t
;

139 ià(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`´štk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kz®loc
((
iommu_bË
), 
GFP_KERNEL
);

146 ià(!
tbl
) {

147 
	`´štk
(
KERN_ERR
 "Calgary:ƒrror‡llocating iommu_table\n");

148 
»t
 = -
ENOMEM
;

149 
dÚe
;

152 
»t
 = 
	`tû_bË_£¬ms
(
dev
, 
tbl
);

153 ià(
»t
)

154 
ä“_tbl
;

156 
tbl
->
bb¬
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
ä“_tbl
:

163 
	`kä“
(
tbl
);

164 
dÚe
:

165  
»t
;

166 
	}
}

168 * 
__š™
 
	$®loc_tû_bË
()

170 
size
;

172 
size
 = 
	`bË_size_to_numb”_of_’Œ›s
(
¥ecif›d_bË_size
);

173 
size
 *ğ
TCE_ENTRY_SIZE
;

175  
	`__®loc_boÙmem_low
(
size
, size, 0);

176 
	}
}

178 
__š™
 
	$ä“_tû_bË
(*
tbl
)

180 
size
;

182 ià(!
tbl
)

185 
size
 = 
	`bË_size_to_numb”_of_’Œ›s
(
¥ecif›d_bË_size
);

186 
size
 *ğ
TCE_ENTRY_SIZE
;

188 
	`ä“_boÙmem
(
	`__·
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<lšux/moduË.h
>

13 
	~<lšux/sÜt.h
>

14 
	~<lšux/¦ab.h
>

16 
	~<asm/uacûss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_‹¡_d©a
;

45 
	$fudze_exû±iÚ_bË
(*
m¬k”
, *
Ãw
)

47 
moduË
 *
mod
 = 
THIS_MODULE
;

48 
exû±iÚ_bË_’Œy
 *
exbË
;

56 ià(
mod
->
num_ex’Œ›s
 > 1) {

57 
	`´štk
(
KERN_ERR
 "test_nx:oo manyƒxceptionableƒntries!\n");

58 
	`´štk
(
KERN_ERR
 "test_nx:est„esults‡re‚ot„eliable.\n");

61 
exbË
 = (
exû±iÚ_bË_’Œy
 *)
mod
->extable;

62 
exbË
[0].
š¢
 = ()
Ãw
;

63 
	}
}

71 
foo_Ïb–
();

80 
nošlše
 
	$‹¡_add»ss
(*
add»ss
)

82 
»suÉ
;

85 
	`fudze_exû±iÚ_bË
(&
foo_Ïb–
, 
add»ss
);

86 
»suÉ
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¦t
] "ô" (
»suÉ
)

97 : [
çke_code
] "r" (
add»ss
), [
z”o
] "r" (0UL), "0" (
»suÉ
)

100 
	`fudze_exû±iÚ_bË
(
add»ss
, &
foo_Ïb–
);

102 ià(
»suÉ
)

103  -
ENODEV
;

105 
	}
}

107 
	g‹¡_d©a
 = 0xC3;

109 
	$‹¡_NX
()

111 
»t
 = 0;

113 
¡ackcode
[] = {0xC3, 0x90, 0 };

114 *
h—p
;

116 
‹¡_d©a
 = 0xC3;

118 
	`´štk
(
KERN_INFO
 "Testing NX…rotection\n");

121 ià(
	`‹¡_add»ss
(&
¡ackcode
)) {

122 
	`´štk
(
KERN_ERR
 "test_nx: stack wasƒxecutable\n");

123 
»t
 = -
ENODEV
;

128 
h—p
 = 
	`km®loc
(64, 
GFP_KERNEL
);

129 ià(!
h—p
)

130  -
ENOMEM
;

131 
h—p
[0] = 0xC3;

133 ià(
	`‹¡_add»ss
(
h—p
)) {

134 
	`´štk
(
KERN_ERR
 "test_nx: heap wasƒxecutable\n");

135 
»t
 = -
ENODEV
;

137 
	`kä“
(
h—p
);

145 #ifdeà
CONFIG_DEBUG_RODATA


147 ià(
rod©a_‹¡_d©a
 != 0xC3) {

148 
	`´štk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
»t
 = -
ENODEV
;

150 } ià(
	`‹¡_add»ss
(&
rod©a_‹¡_d©a
)) {

151 
	`´štk
(
KERN_ERR
 "test_nx: .rodata section isƒxecutable\n");

152 
»t
 = -
ENODEV
;

158 ià(
	`‹¡_add»ss
(&
‹¡_d©a
)) {

159 
	`´štk
(
KERN_ERR
 "test_nx: .data section isƒxecutable\n");

160 
»t
 = -
ENODEV
;

165 
	}
}

167 
	$‹¡_ex™
()

169 
	}
}

171 
moduË_š™
(
‹¡_NX
);

172 
moduË_ex™
(
‹¡_ex™
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time_64.c

14 
	~<lšux/şockchs.h
>

15 
	~<lšux/š™.h
>

16 
	~<lšux/š‹¼u±.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/time.h
>

19 
	~<lšux/mÿ.h
>

20 
	~<lšux/nmi.h
>

22 
	~<asm/i8253.h
>

23 
	~<asm/h³t.h
>

24 
	~<asm/vgtod.h
>

25 
	~<asm/time.h
>

26 
	~<asm/tim”.h
>

28 vŞ©
__jiff›s
 
	g__£ùiÚ_jiff›s
 = 
INITIAL_JIFFIES
;

30 
	$´ofe_pc
(
±_»gs
 *
»gs
)

32 
pc
 = 
	`š¡ruùiÚ_poš‹r
(
»gs
);

37 ià(!
	`u£r_mode_vm
(
»gs
è&& 
	`š_lock_funùiÚs
(
pc
)) {

38 #ifdeà
CONFIG_FRAME_POINTER


39  *(*)(
»gs
->
bp
 + ());

41 *
¥
 = (*)
»gs
->sp;

42 ià(
¥
[0] >> 22)

43  
¥
[0];

44 ià(
¥
[1] >> 22)

45  
¥
[1];

48  
pc
;

49 
	}
}

50 
EXPORT_SYMBOL
(
´ofe_pc
);

52 
œq»tuº_t
 
	$tim”_š‹¼u±
(
œq
, *
dev_id
)

54 
	`šc_œq_¡©
(
œq0_œqs
);

56 
glob®_şock_ev’t
->
	`ev’t_hªdËr
(global_clock_event);

58 #ifdeà
CONFIG_MCA


59 ià(
MCA_bus
) {

60 
u8
 
œq_v
 = 
	`šb_p
(0x61);

61 
	`outb_p
(
œq_v
|0x80, 0x61);

65  
IRQ_HANDLED
;

66 
	}
}

70 
	#TICK_COUNT
 100000000

	)

71 
__š™
 
	$ÿlib¿‹_ıu
()

73 
tsc_¡¬t
, 
tsc_now
;

74 
i
, 
no_ùr_ä“
;

75 
evÁ£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

76 
æags
;

78 
i
 = 0; i < 4; i++)

79 ià(
	`ava_to_»¤v_³rfùr_nmi_b™
(
i
))

81 
no_ùr_ä“
 = (
i
 == 4);

82 ià(
no_ùr_ä“
) {

83 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMD…erfctrs busy ... "

85 
i
 = 3;

86 
	`rdm¤l
(
MSR_K7_EVNTSEL3
, 
evÁ£l3
);

87 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 0);

88 
	`rdm¤l
(
MSR_K7_PERFCTR3
, 
pmc3
);

90 
	`»£rve_³rfùr_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

91 
	`»£rve_evÁ£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

93 
	`loÿl_œq_§ve
(
æags
);

95 
	`wrm¤l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

96 
	`wrm¤l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

97 
	`rdtsş
(
tsc_¡¬t
);

99 
	`rdm¤l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

100 
tsc_now
 = 
	`g‘_cyşes
();

101 } (
tsc_now
 - 
tsc_¡¬t
è< 
TICK_COUNT
);

103 
	`loÿl_œq_»¡Üe
(
æags
);

104 ià(
no_ùr_ä“
) {

105 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 0);

106 
	`wrm¤l
(
MSR_K7_PERFCTR3
, 
pmc3
);

107 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 
evÁ£l3
);

109 
	`»Ëa£_³rfùr_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

110 
	`»Ëa£_evÁ£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

113  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_¡¬t
);

114 
	}
}

116 
œqaùiÚ
 
	gœq0
 = {

117 .
hªdËr
 = 
tim”_š‹¼u±
,

118 .
	gæags
 = 
IRQF_DISABLED
 | 
IRQF_IRQPOLL
 | 
IRQF_NOBALANCING
 | 
IRQF_TIMER
,

119 .
	gÇme
 = "timer"

122 
__š™
 
	$h³t_time_š™
()

124 ià(!
	`h³t_’abË
())

125 
	`£tup_p™_tim”
();

127 
	`£tup_œq
(0, &
œq0
);

128 
	}
}

130 
__š™
 
	$time_š™
()

132 
	`tsc_š™
();

134 
Ï‹_time_š™
 = 
	`choo£_time_š™
();

135 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/”ºo.h
>

3 
	~<lšux/sched.h
>

4 
	~<lšux/u£r.h
>

5 
	~<lšux/»g£t.h
>

7 
	~<asm/uacûss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy¡em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/´Ùo.h
>

13 
	~<asm/sysÿÎs.h
>

15 
	~"s.h
"

20 
	$g‘_ä“_idx
()

22 
th»ad_¡ruù
 *
t
 = &
cu¼’t
->
th»ad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 ià(
	`desc_em±y
(&
t
->
s_¬¿y
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_s_desc
(
sk_¡ruù
 *
p
, 
idx
,

32 cÚ¡ 
u£r_desc
 *
šfo
, 
n
)

34 
th»ad_¡ruù
 *
t
 = &
p
->
th»ad
;

35 
desc_¡ruù
 *
desc
 = &
t
->
s_¬¿y
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
ıu
;

41 
ıu
 = 
	`g‘_ıu
();

43 
n
-- > 0) {

44 ià(
	`LDT_em±y
(
šfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fl_ldt
(
desc
, 
šfo
);

48 ++
šfo
;

49 ++
desc
;

52 ià(
t
 =ğ&
cu¼’t
->
th»ad
)

53 
	`lßd_TLS
(
t
, 
ıu
);

55 
	`put_ıu
();

56 
	}
}

61 
	$do_£t_th»ad_¬—
(
sk_¡ruù
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_šfo
,

63 
ÿn_®loÿ‹
)

65 
u£r_desc
 
šfo
;

67 ià(
	`cİy_äom_u£r
(&
šfo
, 
u_šfo
, (info)))

68  -
EFAULT
;

70 ià(
idx
 == -1)

71 
idx
 = 
šfo
.
’Œy_numb”
;

77 ià(
idx
 =ğ-1 && 
ÿn_®loÿ‹
) {

78 
idx
 = 
	`g‘_ä“_idx
();

79 ià(
idx
 < 0)

80  
idx
;

81 ià(
	`put_u£r
(
idx
, &
u_šfo
->
’Œy_numb”
))

82  -
EFAULT
;

85 ià(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_s_desc
(
p
, 
idx
, &
šfo
, 1);

91 
	}
}

93 
asmlškage
 
	$sys_£t_th»ad_¬—
(
u£r_desc
 
__u£r
 *
u_šfo
)

95 
»t
 = 
	`do_£t_th»ad_¬—
(
cu¼’t
, -1, 
u_šfo
, 1);

96 
	`asmlškage_´Ùeù
(1, 
»t
, 
u_šfo
);

97  
»t
;

98 
	}
}

105 
	$fl_u£r_desc
(
u£r_desc
 *
šfo
, 
idx
,

106 cÚ¡ 
desc_¡ruù
 *
desc
)

109 
	`mem£t
(
šfo
, 0, (*info));

110 
šfo
->
’Œy_numb”
 = 
idx
;

111 
šfo
->
ba£_addr
 = 
	`g‘_desc_ba£
(
desc
);

112 
šfo
->
lim™
 = 
	`g‘_desc_lim™
(
desc
);

113 
šfo
->
£g_32b™
 = 
desc
->
d
;

114 
šfo
->
cÚ‹Ás
 = 
desc
->
ty³
 >> 2;

115 
šfo
->
»ad_exec_Úly
 = !(
desc
->
ty³
 & 2);

116 
šfo
->
lim™_š_·ges
 = 
desc
->
g
;

117 
šfo
->
£g_nÙ_´e£Á
 = !
desc
->
p
;

118 
šfo
->
u£abË
 = 
desc
->
avl
;

119 #ifdeà
CONFIG_X86_64


120 
šfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_g‘_th»ad_¬—
(
sk_¡ruù
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_šfo
)

127 
u£r_desc
 
šfo
;

129 ià(
idx
 =ğ-1 && 
	`g‘_u£r
(idx, &
u_šfo
->
’Œy_numb”
))

130  -
EFAULT
;

132 ià(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fl_u£r_desc
(&
šfo
, 
idx
,

136 &
p
->
th»ad
.
s_¬¿y
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 ià(
	`cİy_to_u£r
(
u_šfo
, &
šfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlškage
 
	$sys_g‘_th»ad_¬—
(
u£r_desc
 
__u£r
 *
u_šfo
)

145 
»t
 = 
	`do_g‘_th»ad_¬—
(
cu¼’t
, -1, 
u_šfo
);

146 
	`asmlškage_´Ùeù
(1, 
»t
, 
u_šfo
);

147  
»t
;

148 
	}
}

150 
	$»g£t_s_aùive
(
sk_¡ruù
 *
rg‘
,

151 cÚ¡ 
u£r_»g£t
 *
»g£t
)

153 
th»ad_¡ruù
 *
t
 = &
rg‘
->
th»ad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
s_¬¿y
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$»g£t_s_g‘
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

161 
pos
, 
couÁ
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 cÚ¡ 
desc_¡ruù
 *
s
;

166 ià(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
couÁ
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /ğ(
u£r_desc
);

172 
couÁ
 /ğ(
u£r_desc
);

174 
s
 = &
rg‘
->
th»ad
.
s_¬¿y
[
pos
];

176 ià(
kbuf
) {

177 
u£r_desc
 *
šfo
 = 
kbuf
;

178 
couÁ
-- > 0)

179 
	`fl_u£r_desc
(
šfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
s
++);

182 
u£r_desc
 
__u£r
 *
u_šfo
 = 
ubuf
;

183 
couÁ
-- > 0) {

184 
u£r_desc
 
šfo
;

185 
	`fl_u£r_desc
(&
šfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
s
++);

186 ià(
	`__cİy_to_u£r
(
u_šfo
++, &
šfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$»g£t_s_£t
(
sk_¡ruù
 *
rg‘
, cÚ¡ 
u£r_»g£t
 *
»g£t
,

195 
pos
, 
couÁ
,

196 cÚ¡ *
kbuf
, cÚ¡ 
__u£r
 *
ubuf
)

198 
u£r_desc
 
šfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 cÚ¡ 
u£r_desc
 *
šfo
;

201 ià(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
couÁ
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 ià(
kbuf
)

207 
šfo
 = 
kbuf
;

208 ià(
	`__cİy_äom_u£r
(
šfobuf
, 
ubuf
, 
couÁ
))

209  -
EFAULT
;

211 
šfo
 = 
šfobuf
;

213 
	`£t_s_desc
(
rg‘
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
šfo
, 
couÁ
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<lšux/nodemask.h
>

29 
	~<lšux/mmzÚe.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/smp.h
>

32 
	~<asm/ıu.h
>

34 
DEFINE_PER_CPU
(
x86_ıu
, 
ıu_deviûs
);

36 #ifdeà
CONFIG_HOTPLUG_CPU


37 
__»f
 
	$¬ch_»gi¡”_ıu
(
num
)

48 ià(
num
)

49 
	`³r_ıu
(
ıu_deviûs
, 
num
).
ıu
.
hÙ¶uggabË
 = 1;

51  
	`»gi¡”_ıu
(&
	`³r_ıu
(
ıu_deviûs
, 
num
).
ıu
,‚um);

52 
	}
}

53 
EXPORT_SYMBOL
(
¬ch_»gi¡”_ıu
);

55 
	$¬ch_uÄegi¡”_ıu
(
num
)

57 
	`uÄegi¡”_ıu
(&
	`³r_ıu
(
ıu_deviûs
, 
num
).
ıu
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¬ch_uÄegi¡”_ıu
);

62 
__š™
 
	$¬ch_»gi¡”_ıu
(
num
)

64  
	`»gi¡”_ıu
(&
	`³r_ıu
(
ıu_deviûs
, 
num
).
ıu
,‚um);

65 
	}
}

68 
__š™
 
	$tİŞogy_š™
()

70 
i
;

72 #ifdeà
CONFIG_NUMA


73 
	`fÜ_—ch_Úlše_node
(
i
)

74 
	`»gi¡”_Úe_node
(
i
);

77 
	`fÜ_—ch_´e£Á_ıu
(
i
)

78 
	`¬ch_»gi¡”_ıu
(
i
);

81 
	}
}

82 
subsys_š™ÿÎ
(
tİŞogy_š™
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<lšux/io.h
>

3 
	~<asm/ŒampŞše.h
>

4 
	~<asm/e820.h
>

7 *
	gŒampŞše_ba£
 = 
__va
(
TRAMPOLINE_BASE
);

9 
__š™
 
	$»£rve_ŒampŞše_memÜy
()

11 #ifdeà
CONFIG_X86_32


17 
	`»£rve_—¾y
(
PAGE_SIZE
, PAGE_SIZE + PAGE_SIZE, "EX TRAMPOLINE");

20 
	`»£rve_—¾y
(
TRAMPOLINE_BASE
, TRAMPOLINE_BASE + 
TRAMPOLINE_SIZE
,

22 
	}
}

29 
	$£tup_ŒampŞše
()

31 
	`memıy
(
ŒampŞše_ba£
, 
ŒampŞše_d©a
, 
TRAMPOLINE_SIZE
);

32  
	`vœt_to_phys
(
ŒampŞše_ba£
);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<lšux/š‹¼u±.h
>

13 
	~<lšux/k®lsyms.h
>

14 
	~<lšux/¥šlock.h
>

15 
	~<lšux/k´obes.h
>

16 
	~<lšux/uacûss.h
>

17 
	~<lšux/ut¢ame.h
>

18 
	~<lšux/kdebug.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/moduË.h
>

21 
	~<lšux/±¿û.h
>

22 
	~<lšux/¡ršg.h
>

23 
	~<lšux/d–ay.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/kexec.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/tim”.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/bug.h
>

30 
	~<lšux/nmi.h
>

31 
	~<lšux/mm.h
>

32 
	~<lšux/smp.h
>

33 
	~<lšux/io.h
>

35 #ifdeà
CONFIG_EISA


36 
	~<lšux/iİÜt.h
>

37 
	~<lšux/ei§.h
>

40 #ifdeà
CONFIG_MCA


41 
	~<lšux/mÿ.h
>

44 #ià
defšed
(
CONFIG_EDAC
)

45 
	~<lšux/edac.h
>

48 
	~<asm/¡ackŒaû.h
>

49 
	~<asm/´oûssÜ.h
>

50 
	~<asm/debug»g.h
>

51 
	~<asm/©omic.h
>

52 
	~<asm/sy¡em.h
>

53 
	~<asm/Œ­s.h
>

54 
	~<asm/desc.h
>

55 
	~<asm/i387.h
>

57 
	~<asm/mach_Œ­s.h
>

59 #ifdeà
CONFIG_X86_64


60 
	~<asm/pg®loc.h
>

61 
	~<asm/´Ùo.h
>

63 
	~<asm/´oûssÜ-æags.h
>

64 
	~<asm/£tup.h
>

65 
	~<asm/Œ­s.h
>

67 
	~"ıu/mcheck/mû.h
"

69 
asmlškage
 
sy¡em_ÿÎ
();

72 
	gignÜe_åu_œq
;

79 
g©e_desc
 
	gidt_bË
[256]

80 
__©Œibu‹__
((
__£ùiÚ__
(".data.idt"))) = { { { { 0, 0 } } }, };

83 
DECLARE_BITMAP
(
u£d_veùÜs
, 
NR_VECTORS
);

84 
EXPORT_SYMBOL_GPL
(
u£d_veùÜs
);

86 
	gignÜe_nmis
;

88 
šlše
 
	$cÚd™iÚ®_¡i
(
±_»gs
 *
»gs
)

90 ià(
»gs
->
æags
 & 
X86_EFLAGS_IF
)

91 
	`loÿl_œq_’abË
();

92 
	}
}

94 
šlše
 
	$´“m±_cÚd™iÚ®_¡i
(
±_»gs
 *
»gs
)

96 
	`šc_´“m±_couÁ
();

97 ià(
»gs
->
æags
 & 
X86_EFLAGS_IF
)

98 
	`loÿl_œq_’abË
();

99 
	}
}

101 
šlše
 
	$cÚd™iÚ®_şi
(
±_»gs
 *
»gs
)

103 ià(
»gs
->
æags
 & 
X86_EFLAGS_IF
)

104 
	`loÿl_œq_di§bË
();

105 
	}
}

107 
šlše
 
	$´“m±_cÚd™iÚ®_şi
(
±_»gs
 *
»gs
)

109 ià(
»gs
->
æags
 & 
X86_EFLAGS_IF
)

110 
	`loÿl_œq_di§bË
();

111 
	`dec_´“m±_couÁ
();

112 
	}
}

114 #ifdeà
CONFIG_X86_32


115 
šlše
 

116 
	$d›_if_k”Ãl
(cÚ¡ *
¡r
, 
±_»gs
 *
»gs
, 
”r
)

118 ià(!
	`u£r_mode_vm
(
»gs
))

119 
	`d›
(
¡r
, 
»gs
, 
”r
);

120 
	}
}

123 
__k´obes


124 
	$do_Œ­
(
Œ­Ä
, 
sigÄ
, *
¡r
, 
±_»gs
 *
»gs
,

125 
”rÜ_code
, 
sigšfo_t
 *
šfo
)

127 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

129 #ifdeà
CONFIG_X86_32


130 ià(
»gs
->
æags
 & 
X86_VM_MASK
) {

135 ià(
Œ­Ä
 < 6)

136 
vm86_Œ­
;

137 
Œ­_sigÇl
;

141 ià(!
	`u£r_mode
(
»gs
))

142 
k”Ãl_Œ­
;

144 #ifdeà
CONFIG_X86_32


145 
Œ­_sigÇl
:

156 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

157 
tsk
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

159 #ifdeà
CONFIG_X86_64


160 ià(
show_unhªdËd_sigÇls
 && 
	`unhªdËd_sigÇl
(
tsk
, 
sigÄ
) &&

161 
	`´štk_¿‹lim™
()) {

162 
	`´štk
(
KERN_INFO


164 
tsk
->
comm
,sk->
pid
, 
¡r
,

165 
»gs
->

,„egs->
¥
, 
”rÜ_code
);

166 
	`´št_vma_addr
(" iÀ", 
»gs
->

);

167 
	`´štk
("\n");

171 ià(
šfo
)

172 
	`fÜû_sig_šfo
(
sigÄ
, 
šfo
, 
tsk
);

174 
	`fÜû_sig
(
sigÄ
, 
tsk
);

177 
k”Ãl_Œ­
:

178 ià(!
	`fixup_exû±iÚ
(
»gs
)) {

179 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

180 
tsk
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

181 
	`d›
(
¡r
, 
»gs
, 
”rÜ_code
);

185 #ifdeà
CONFIG_X86_32


186 
vm86_Œ­
:

187 ià(
	`hªdË_vm86_Œ­
((
k”Ãl_vm86_»gs
 *è
»gs
,

188 
”rÜ_code
, 
Œ­Ä
))

189 
Œ­_sigÇl
;

192 
	}
}

194 
	#DO_ERROR
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
Çme
) \

195 
dÙ¿¶škage
 
do_
##
	`Çme
(
±_»gs
 *
»gs
, 
”rÜ_code
) \

197 ià(
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 
Œ­Ä
, 
sigÄ
) \

198 =ğ
NOTIFY_STOP
) \

200 
	`cÚd™iÚ®_¡i
(
»gs
); \

201 
	`do_Œ­
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
»gs
, 
”rÜ_code
, 
NULL
); \

202 }

	)

204 
	#DO_ERROR_INFO
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
Çme
, 
sicode
, 
sŸddr
) \

205 
dÙ¿¶škage
 
do_
##
	`Çme
(
±_»gs
 *
»gs
, 
”rÜ_code
) \

207 
sigšfo_t
 
šfo
; \

208 
šfo
.
si_signo
 = 
sigÄ
; \

209 
šfo
.
si_”ºo
 = 0; \

210 
šfo
.
si_code
 = 
sicode
; \

211 
šfo
.
si_addr
 = (
__u£r
 *)
sŸddr
; \

212 ià(
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 
Œ­Ä
, 
sigÄ
) \

213 =ğ
NOTIFY_STOP
) \

215 
	`cÚd™iÚ®_¡i
(
»gs
); \

216 
	`do_Œ­
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
»gs
, 
”rÜ_code
, &
šfo
); \

217 }

	)

219 
DO_ERROR_INFO
(0, 
SIGFPE
, "divid”rÜ", 
divide_”rÜ
, 
FPE_INTDIV
, 
»gs
->

)

220 
DO_ERROR
(4, 
SIGSEGV
, "ov”æow", 
ov”æow
)

221 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

222 
DO_ERROR_INFO
(6, 
SIGILL
, "šv®id opcode", 
šv®id_İ
, 
ILL_ILLOPN
, 
»gs
->

)

223 
DO_ERROR
(9, 
SIGFPE
, "cİroûssÜ segm’ˆov”run", 
cİroûssÜ_£gm’t_ov”run
)

224 
DO_ERROR
(10, 
SIGSEGV
, "šv®id TSS", 
šv®id_TSS
)

225 
DO_ERROR
(11, 
SIGBUS
, "£gm’ˆnÙ…»£Á", 
£gm’t_nÙ_´e£Á
)

226 #ifdeà
CONFIG_X86_32


227 
DO_ERROR
(12, 
SIGBUS
, "¡ack segm’t", 
¡ack_£gm’t
)

229 
DO_ERROR_INFO
(17, 
SIGBUS
, "®ignm’ˆcheck", 
®ignm’t_check
, 
BUS_ADRALN
, 0)

231 #ifdeà
CONFIG_X86_64


233 
dÙ¿¶škage
 
	$do_¡ack_£gm’t
(
±_»gs
 *
»gs
, 
”rÜ_code
)

235 ià(
	`nÙify_d›
(
DIE_TRAP
, "¡ack segm’t", 
»gs
, 
”rÜ_code
,

236 12, 
SIGBUS
è=ğ
NOTIFY_STOP
)

238 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

239 
	`do_Œ­
(12, 
SIGBUS
, "¡ack segm’t", 
»gs
, 
”rÜ_code
, 
NULL
);

240 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

241 
	}
}

243 
dÙ¿¶škage
 
	$do_doubË_çuÉ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

245 cÚ¡ 
¡r
[] = "double fault";

246 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

249 
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 8, 
SIGSEGV
);

251 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

252 
tsk
->
th»ad
.
Œ­_no
 = 8;

259 
	`d›
(
¡r
, 
»gs
, 
”rÜ_code
);

260 
	}
}

263 
dÙ¿¶škage
 
__k´obes


264 
	$do_g’”®_´ÙeùiÚ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

266 
sk_¡ruù
 *
tsk
;

268 
	`cÚd™iÚ®_¡i
(
»gs
);

270 #ifdeà
CONFIG_X86_32


271 ià(
»gs
->
æags
 & 
X86_VM_MASK
)

272 
gp_š_vm86
;

275 
tsk
 = 
cu¼’t
;

276 ià(!
	`u£r_mode
(
»gs
))

277 
gp_š_k”Ãl
;

279 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

280 
tsk
->
th»ad
.
Œ­_no
 = 13;

282 ià(
show_unhªdËd_sigÇls
 && 
	`unhªdËd_sigÇl
(
tsk
, 
SIGSEGV
) &&

283 
	`´štk_¿‹lim™
()) {

284 
	`´štk
(
KERN_INFO


286 
tsk
->
comm
, 
	`sk_pid_Ä
(tsk),

287 
»gs
->

,„egs->
¥
, 
”rÜ_code
);

288 
	`´št_vma_addr
(" iÀ", 
»gs
->

);

289 
	`´štk
("\n");

292 
	`fÜû_sig
(
SIGSEGV
, 
tsk
);

295 #ifdeà
CONFIG_X86_32


296 
gp_š_vm86
:

297 
	`loÿl_œq_’abË
();

298 
	`hªdË_vm86_çuÉ
((
k”Ãl_vm86_»gs
 *è
»gs
, 
”rÜ_code
);

302 
gp_š_k”Ãl
:

303 ià(
	`fixup_exû±iÚ
(
»gs
))

306 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

307 
tsk
->
th»ad
.
Œ­_no
 = 13;

308 ià(
	`nÙify_d›
(
DIE_GPF
, "g’”®…rÙeùiÚ fauÉ", 
»gs
,

309 
”rÜ_code
, 13, 
SIGSEGV
è=ğ
NOTIFY_STOP
)

311 
	`d›
("g’”®…rÙeùiÚ fauÉ", 
»gs
, 
”rÜ_code
);

312 
	}
}

314 
nÙ¿û
 
__k´obes
 

315 
	$mem_·r™y_”rÜ
(
»asÚ
, 
±_»gs
 *
»gs
)

317 
	`´štk
(
KERN_EMERG


319 
»asÚ
, 
	`smp_´oûssÜ_id
());

321 
	`´štk
(
KERN_EMERG


324 #ià
	`defšed
(
CONFIG_EDAC
)

325 ià(
	`edac_hªdËr_£t
()) {

326 
	`edac_©omic_as£¹_”rÜ
();

331 ià(
·nic_Ú_uÄecov”ed_nmi
)

332 
	`·nic
("NMI: Not continuing");

334 
	`´štk
(
KERN_EMERG
 "Dazed‡nd confused, butryingo continue\n");

337 
»asÚ
 = (reason & 0xf) | 4;

338 
	`outb
(
»asÚ
, 0x61);

339 
	}
}

341 
nÙ¿û
 
__k´obes
 

342 
	$io_check_”rÜ
(
»asÚ
, 
±_»gs
 *
»gs
)

344 
i
;

346 
	`´štk
(
KERN_EMERG
 "NMI: IOCKƒrror (debug interrupt?)\n");

347 
	`show_»gi¡”s
(
»gs
);

350 
»asÚ
 = (reason & 0xf) | 8;

351 
	`outb
(
»asÚ
, 0x61);

353 
i
 = 2000;

354 --
i
)

355 
	`ud–ay
(1000);

357 
»asÚ
 &= ~8;

358 
	`outb
(
»asÚ
, 0x61);

359 
	}
}

361 
nÙ¿û
 
__k´obes
 

362 
	$unknown_nmi_”rÜ
(
»asÚ
, 
±_»gs
 *
»gs
)

364 ià(
	`nÙify_d›
(
DIE_NMIUNKNOWN
, "nmi", 
»gs
, 
»asÚ
, 2, 
SIGINT
) ==

365 
NOTIFY_STOP
)

367 #ifdeà
CONFIG_MCA


372 ià(
MCA_bus
) {

373 
	`mÿ_hªdË_nmi
();

377 
	`´štk
(
KERN_EMERG


379 
»asÚ
, 
	`smp_´oûssÜ_id
());

381 
	`´štk
(
KERN_EMERG
 "Do you have‡ strange…ower saving modeƒnabled?\n");

382 ià(
·nic_Ú_uÄecov”ed_nmi
)

383 
	`·nic
("NMI: Not continuing");

385 
	`´štk
(
KERN_EMERG
 "Dazed‡nd confused, butryingo continue\n");

386 
	}
}

388 
nÙ¿û
 
__k´obes
 
	$deçuÉ_do_nmi
(
±_»gs
 *
»gs
)

390 
»asÚ
 = 0;

391 
ıu
;

393 
ıu
 = 
	`smp_´oûssÜ_id
();

396 ià(!
ıu
)

397 
»asÚ
 = 
	`g‘_nmi_»asÚ
();

399 ià(!(
»asÚ
 & 0xc0)) {

400 ià(
	`nÙify_d›
(
DIE_NMI_IPI
, "nmi_i", 
»gs
, 
»asÚ
, 2, 
SIGINT
)

401 =ğ
NOTIFY_STOP
)

403 #ifdeà
CONFIG_X86_LOCAL_APIC


408 ià(
	`nmi_w©chdog_tick
(
»gs
, 
»asÚ
))

410 ià(!
	`do_nmi_ÿÎback
(
»gs
, 
ıu
))

411 
	`unknown_nmi_”rÜ
(
»asÚ
, 
»gs
);

413 
	`unknown_nmi_”rÜ
(
»asÚ
, 
»gs
);

418 ià(
	`nÙify_d›
(
DIE_NMI
, "nmi", 
»gs
, 
»asÚ
, 2, 
SIGINT
è=ğ
NOTIFY_STOP
)

422 ià(
»asÚ
 & 0x80)

423 
	`mem_·r™y_”rÜ
(
»asÚ
, 
»gs
);

424 ià(
»asÚ
 & 0x40)

425 
	`io_check_”rÜ
(
»asÚ
, 
»gs
);

426 #ifdeà
CONFIG_X86_32


431 
	`»as£¹_nmi
();

433 
	}
}

435 
dÙ¿¶škage
 
nÙ¿û
 
__k´obes
 

436 
	$do_nmi
(
±_»gs
 *
»gs
, 
”rÜ_code
)

438 
	`nmi_’‹r
();

440 
	`šc_œq_¡©
(
__nmi_couÁ
);

442 ià(!
ignÜe_nmis
)

443 
	`deçuÉ_do_nmi
(
»gs
);

445 
	`nmi_ex™
();

446 
	}
}

448 
	$¡İ_nmi
()

450 
	`aıi_nmi_di§bË
();

451 
ignÜe_nmis
++;

452 
	}
}

454 
	$»¡¬t_nmi
()

456 
ignÜe_nmis
--;

457 
	`aıi_nmi_’abË
();

458 
	}
}

461 
dÙ¿¶škage
 
__k´obes
 
	$do_št3
(
±_»gs
 *
»gs
, 
”rÜ_code
)

463 #ifdeà
CONFIG_KPROBES


464 ià(
	`nÙify_d›
(
DIE_INT3
, "št3", 
»gs
, 
”rÜ_code
, 3, 
SIGTRAP
)

465 =ğ
NOTIFY_STOP
)

468 ià(
	`nÙify_d›
(
DIE_TRAP
, "št3", 
»gs
, 
”rÜ_code
, 3, 
SIGTRAP
)

469 =ğ
NOTIFY_STOP
)

473 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

474 
	`do_Œ­
(3, 
SIGTRAP
, "št3", 
»gs
, 
”rÜ_code
, 
NULL
);

475 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

476 
	}
}

478 #ifdeà
CONFIG_X86_64


484 
asmlškage
 
__k´obes
 
±_»gs
 *
	$sync_»gs
(
±_»gs
 *
”egs
)

486 
±_»gs
 *
»gs
 = 
”egs
;

488 ià(
”egs
 =ğ(
±_»gs
 *ë»gs->
¥
)

491 ià(
	`u£r_mode
(
”egs
))

492 
»gs
 = 
	`sk_±_»gs
(
cu¼’t
);

497 ià(
”egs
->
æags
 & 
X86_EFLAGS_IF
)

498 
»gs
 = (
±_»gs
 *)(
”egs
->
¥
 -= (pt_regs));

499 ià(
”egs
 !ğ
»gs
)

500 *
»gs
 = *
”egs
;

501  
»gs
;

502 
	}
}

529 
dÙ¿¶škage
 
__k´obes
 
	$do_debug
(
±_»gs
 *
»gs
, 
”rÜ_code
)

531 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

532 
cÚd™iÚ
;

533 
si_code
;

535 
	`g‘_debug»g
(
cÚd™iÚ
, 6);

540 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_DEBUGCTLMSR
);

541 
tsk
->
th»ad
.
debugùlm¤
 = 0;

543 ià(
	`nÙify_d›
(
DIE_DEBUG
, "debug", 
»gs
, 
cÚd™iÚ
, 
”rÜ_code
,

544 
SIGTRAP
è=ğ
NOTIFY_STOP
)

548 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

551 ià(
cÚd™iÚ
 & (
DR_TRAP0
|
DR_TRAP1
|
DR_TRAP2
|
DR_TRAP3
)) {

552 ià(!
tsk
->
th»ad
.
debug»g7
)

553 
ş—r_dr7
;

556 #ifdeà
CONFIG_X86_32


557 ià(
»gs
->
æags
 & 
X86_VM_MASK
)

558 
debug_vm86
;

562 
tsk
->
th»ad
.
debug»g6
 = 
cÚd™iÚ
;

568 ià(
cÚd™iÚ
 & 
DR_STEP
) {

569 ià(!
	`u£r_mode
(
»gs
))

570 
ş—r_TF_»’abË
;

573 
si_code
 = 
	`g‘_si_code
(
cÚd™iÚ
);

575 
	`£nd_sigŒ­
(
tsk
, 
»gs
, 
”rÜ_code
, 
si_code
);

581 
ş—r_dr7
:

582 
	`£t_debug»g
(0, 7);

583 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

586 #ifdeà
CONFIG_X86_32


587 
debug_vm86
:

589 
	`dec_´“m±_couÁ
();

590 
	`hªdË_vm86_Œ­
((
k”Ãl_vm86_»gs
 *è
»gs
, 
”rÜ_code
, 1);

591 
	`cÚd™iÚ®_şi
(
»gs
);

595 
ş—r_TF_»’abË
:

596 
	`£t_tsk_th»ad_æag
(
tsk
, 
TIF_SINGLESTEP
);

597 
»gs
->
æags
 &ğ~
X86_EFLAGS_TF
;

598 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

600 
	}
}

602 #ifdeà
CONFIG_X86_64


603 
	$k”Ãl_m©h_”rÜ
(
±_»gs
 *
»gs
, cÚ¡ *
¡r
, 
Œ­Ä
)

605 ià(
	`fixup_exû±iÚ
(
»gs
))

608 
	`nÙify_d›
(
DIE_GPF
, 
¡r
, 
»gs
, 0, 
Œ­Ä
, 
SIGFPE
);

610 
cu¼’t
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

611 
	`d›
(
¡r
, 
»gs
, 0);

613 
	}
}

621 
	$m©h_”rÜ
(
__u£r
 *

)

623 
sk_¡ruù
 *
sk
;

624 
sigšfo_t
 
šfo
;

625 
cwd
, 
swd
, 
”r
;

630 
sk
 = 
cu¼’t
;

631 
	`§ve_š™_åu
(
sk
);

632 
sk
->
th»ad
.
Œ­_no
 = 16;

633 
sk
->
th»ad
.
”rÜ_code
 = 0;

634 
šfo
.
si_signo
 = 
SIGFPE
;

635 
šfo
.
si_”ºo
 = 0;

636 
šfo
.
si_addr
 = 

;

647 
cwd
 = 
	`g‘_åu_cwd
(
sk
);

648 
swd
 = 
	`g‘_åu_swd
(
sk
);

650 
”r
 = 
swd
 & ~
cwd
;

652 ià(
”r
 & 0x001) {

658 
šfo
.
si_code
 = 
FPE_FLTINV
;

659 } ià(
”r
 & 0x004) {

660 
šfo
.
si_code
 = 
FPE_FLTDIV
;

661 } ià(
”r
 & 0x008) {

662 
šfo
.
si_code
 = 
FPE_FLTOVF
;

663 } ià(
”r
 & 0x012) {

664 
šfo
.
si_code
 = 
FPE_FLTUND
;

665 } ià(
”r
 & 0x020) {

666 
šfo
.
si_code
 = 
FPE_FLTRES
;

674 
	`fÜû_sig_šfo
(
SIGFPE
, &
šfo
, 
sk
);

675 
	}
}

677 
dÙ¿¶škage
 
	$do_cİroûssÜ_”rÜ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

679 
	`cÚd™iÚ®_¡i
(
»gs
);

681 #ifdeà
CONFIG_X86_32


682 
ignÜe_åu_œq
 = 1;

684 ià(!
	`u£r_mode
(
»gs
) &&

685 
	`k”Ãl_m©h_”rÜ
(
»gs
, "kernel x87 mathƒrror", 16))

689 
	`m©h_”rÜ
((
__u£r
 *)
»gs
->

);

690 
	}
}

692 
	$simd_m©h_”rÜ
(
__u£r
 *

)

694 
sk_¡ruù
 *
sk
;

695 
sigšfo_t
 
šfo
;

696 
mxc¤
;

701 
sk
 = 
cu¼’t
;

702 
	`§ve_š™_åu
(
sk
);

703 
sk
->
th»ad
.
Œ­_no
 = 19;

704 
sk
->
th»ad
.
”rÜ_code
 = 0;

705 
šfo
.
si_signo
 = 
SIGFPE
;

706 
šfo
.
si_”ºo
 = 0;

707 
šfo
.
si_code
 = 
__SI_FAULT
;

708 
šfo
.
si_addr
 = 

;

715 
mxc¤
 = 
	`g‘_åu_mxc¤
(
sk
);

716 ~((
mxc¤
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

721 
šfo
.
si_code
 = 
FPE_FLTINV
;

725 
šfo
.
si_code
 = 
FPE_FLTUND
;

728 
šfo
.
si_code
 = 
FPE_FLTDIV
;

731 
šfo
.
si_code
 = 
FPE_FLTOVF
;

734 
šfo
.
si_code
 = 
FPE_FLTRES
;

737 
	`fÜû_sig_šfo
(
SIGFPE
, &
šfo
, 
sk
);

738 
	}
}

740 
dÙ¿¶škage
 

741 
	$do_simd_cİroûssÜ_”rÜ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

743 
	`cÚd™iÚ®_¡i
(
»gs
);

745 #ifdeà
CONFIG_X86_32


746 ià(
ıu_has_xmm
) {

748 
ignÜe_åu_œq
 = 1;

749 
	`simd_m©h_”rÜ
((
__u£r
 *)
»gs
->

);

756 ià(
»gs
->
æags
 & 
X86_VM_MASK
) {

757 
	`hªdË_vm86_çuÉ
((
k”Ãl_vm86_»gs
 *)
»gs
, 
”rÜ_code
);

760 
cu¼’t
->
th»ad
.
Œ­_no
 = 19;

761 
cu¼’t
->
th»ad
.
”rÜ_code
 =ƒrror_code;

762 
	`d›_if_k”Ãl
("ÿchæush d’›d", 
»gs
, 
”rÜ_code
);

763 
	`fÜû_sig
(
SIGSEGV
, 
cu¼’t
);

765 ià(!
	`u£r_mode
(
»gs
) &&

766 
	`k”Ãl_m©h_”rÜ
(
»gs
, "kernel simd mathƒrror", 19))

768 
	`simd_m©h_”rÜ
((
__u£r
 *)
»gs
->

);

770 
	}
}

772 
dÙ¿¶škage
 

773 
	$do_¥urious_š‹¼u±_bug
(
±_»gs
 *
»gs
, 
”rÜ_code
)

775 
	`cÚd™iÚ®_¡i
(
»gs
);

778 
	`´štk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

780 
	}
}

782 #ifdeà
CONFIG_X86_32


783 
	$·tch_e¥fix_desc
(
ue¥
, 
ke¥
)

785 
desc_¡ruù
 *
gdt
 = 
	`g‘_ıu_gdt_bË
(
	`smp_´oûssÜ_id
());

786 
ba£
 = (
ke¥
 - 
ue¥
è& -
THREAD_SIZE
;

787 
Ãw_ke¥
 = 
ke¥
 - 
ba£
;

788 
lim_·ges
 = (
Ãw_ke¥
 | (
THREAD_SIZE
 - 1)è>> 
PAGE_SHIFT
;

789 
__u64
 
desc
 = *(__u64 *)&
gdt
[
GDT_ENTRY_ESPFIX_SS
];

792 
desc
 &= 0x00f0ff0000000000ULL;

793 
desc
 |ğ((((
__u64
)
ba£
) << 16) & 0x000000ffffff0000ULL) |

794 ((((
__u64
)
ba£
) << 32) & 0xff00000000000000ULL) |

795 ((((
__u64
)
lim_·ges
) << 32) & 0x000f000000000000ULL) |

796 (
lim_·ges
 & 0xffff);

797 *(
__u64
 *)&
gdt
[
GDT_ENTRY_ESPFIX_SS
] = 
desc
;

799  
Ãw_ke¥
;

800 
	}
}

802 
asmlškage
 
__©Œibu‹__
((
w—k
)è
	$smp_th”m®_š‹¼u±
()

804 
	}
}

806 
asmlškage
 
__©Œibu‹__
((
w—k
)è
	$mû_th»shŞd_š‹¼u±
()

808 
	}
}

821 
asmlškage
 
	$m©h_¡©e_»¡Üe
()

823 
th»ad_šfo
 *
th»ad
 = 
	`cu¼’t_th»ad_šfo
();

824 
sk_¡ruù
 *
tsk
 = 
th»ad
->
sk
;

826 ià(!
	`tsk_u£d_m©h
(
tsk
)) {

827 
	`loÿl_œq_’abË
();

831 ià(
	`š™_åu
(
tsk
)) {

835 
	`do_group_ex™
(
SIGKILL
);

838 
	`loÿl_œq_di§bË
();

841 
	`şts
();

842 #ifdeà
CONFIG_X86_32


843 
	`»¡Üe_åu
(
tsk
);

848 ià(
	`uÆik–y
(
	`»¡Üe_åu_checkšg
(
tsk
))) {

849 
	`¡ts
();

850 
	`fÜû_sig
(
SIGSEGV
, 
tsk
);

854 
th»ad
->
¡©us
 |ğ
TS_USEDFPU
;

855 
tsk
->
åu_couÁ”
++;

856 
	}
}

857 
EXPORT_SYMBOL_GPL
(
m©h_¡©e_»¡Üe
);

859 #iâdeà
CONFIG_MATH_EMULATION


860 
	$m©h_emuÏ‹
(
m©h_emu_šfo
 *
šfo
)

862 
	`´štk
(
KERN_EMERG


864 
	`´štk
(
KERN_EMERG
 "klšg %s.\n", 
cu¼’t
->
comm
);

865 
	`fÜû_sig
(
SIGFPE
, 
cu¼’t
);

866 
	`scheduË
();

867 
	}
}

870 
dÙ¿¶škage
 
__k´obes


871 
	$do_deviû_nÙ_avaabË
(
±_»gs
 *
»gs
, 
”rÜ_code
)

873 #ifdeà
CONFIG_X86_32


874 ià(
	`»ad_ü0
(è& 
X86_CR0_EM
) {

875 
m©h_emu_šfo
 
šfo
 = { };

877 
	`cÚd™iÚ®_¡i
(
»gs
);

879 
šfo
.
»gs
 =„egs;

880 
	`m©h_emuÏ‹
(&
šfo
);

882 
	`m©h_¡©e_»¡Üe
();

883 
	`cÚd™iÚ®_¡i
(
»gs
);

886 
	`m©h_¡©e_»¡Üe
();

888 
	}
}

890 #ifdeà
CONFIG_X86_32


891 
dÙ¿¶škage
 
	$do_œ‘_”rÜ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

893 
sigšfo_t
 
šfo
;

894 
	`loÿl_œq_’abË
();

896 
šfo
.
si_signo
 = 
SIGILL
;

897 
šfo
.
si_”ºo
 = 0;

898 
šfo
.
si_code
 = 
ILL_BADSTK
;

899 
šfo
.
si_addr
 = 
NULL
;

900 ià(
	`nÙify_d›
(
DIE_TRAP
, "iretƒxception",

901 
»gs
, 
”rÜ_code
, 32, 
SIGILL
è=ğ
NOTIFY_STOP
)

903 
	`do_Œ­
(32, 
SIGILL
, "œ‘ƒxû±iÚ", 
»gs
, 
”rÜ_code
, &
šfo
);

904 
	}
}

907 
__š™
 
	$Œ­_š™
()

909 
i
;

911 #ifdeà
CONFIG_EISA


912 
__iomem
 *
p
 = 
	`—¾y_iÜem­
(0x0FFFD9, 4);

914 ià(
	`»adl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

915 
EISA_bus
 = 1;

916 
	`—¾y_iounm­
(
p
, 4);

919 
	`£t_šŒ_g©e
(0, &
divide_”rÜ
);

920 
	`£t_šŒ_g©e_i¡
(1, &
debug
, 
DEBUG_STACK
);

921 
	`£t_šŒ_g©e_i¡
(2, &
nmi
, 
NMI_STACK
);

923 
	`£t_sy¡em_šŒ_g©e_i¡
(3, &
št3
, 
DEBUG_STACK
);

925 
	`£t_sy¡em_šŒ_g©e
(4, &
ov”æow
);

926 
	`£t_šŒ_g©e
(5, &
bounds
);

927 
	`£t_šŒ_g©e
(6, &
šv®id_İ
);

928 
	`£t_šŒ_g©e
(7, &
deviû_nÙ_avaabË
);

929 #ifdeà
CONFIG_X86_32


930 
	`£t_sk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

932 
	`£t_šŒ_g©e_i¡
(8, &
doubË_çuÉ
, 
DOUBLEFAULT_STACK
);

934 
	`£t_šŒ_g©e
(9, &
cİroûssÜ_£gm’t_ov”run
);

935 
	`£t_šŒ_g©e
(10, &
šv®id_TSS
);

936 
	`£t_šŒ_g©e
(11, &
£gm’t_nÙ_´e£Á
);

937 
	`£t_šŒ_g©e_i¡
(12, &
¡ack_£gm’t
, 
STACKFAULT_STACK
);

938 
	`£t_šŒ_g©e
(13, &
g’”®_´ÙeùiÚ
);

939 
	`£t_šŒ_g©e
(14, &
·ge_çuÉ
);

940 
	`£t_šŒ_g©e
(15, &
¥urious_š‹¼u±_bug
);

941 
	`£t_šŒ_g©e
(16, &
cİroûssÜ_”rÜ
);

942 
	`£t_šŒ_g©e
(17, &
®ignm’t_check
);

943 #ifdeà
CONFIG_X86_MCE


944 
	`£t_šŒ_g©e_i¡
(18, &
machše_check
, 
MCE_STACK
);

946 
	`£t_šŒ_g©e
(19, &
simd_cİroûssÜ_”rÜ
);

948 #ifdeà
CONFIG_IA32_EMULATION


949 
	`£t_sy¡em_šŒ_g©e
(
IA32_SYSCALL_VECTOR
, 
Ÿ32_sysÿÎ
);

952 #ifdeà
CONFIG_X86_32


953 ià(
ıu_has_fx¤
) {

954 
	`´štk
(
KERN_INFO
 "Enabling fast FPU save‡nd„estore... ");

955 
	`£t_š_ü4
(
X86_CR4_OSFXSR
);

956 
	`´štk
("done.\n");

958 ià(
ıu_has_xmm
) {

959 
	`´štk
(
KERN_INFO


961 
	`£t_š_ü4
(
X86_CR4_OSXMMEXCPT
);

962 
	`´štk
("done.\n");

965 
	`£t_sy¡em_Œ­_g©e
(
SYSCALL_VECTOR
, &
sy¡em_ÿÎ
);

969 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

970 
	`£t_b™
(
i
, 
u£d_veùÜs
);

972 #ifdeà
CONFIG_X86_64


973 
	`£t_b™
(
IA32_SYSCALL_VECTOR
, 
u£d_veùÜs
);

975 
	`£t_b™
(
SYSCALL_VECTOR
, 
u£d_veùÜs
);

980 
	`ıu_š™
();

982 #ifdeà
CONFIG_X86_32


983 
	`x86_quœk_Œ­_š™
();

985 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/š™.h
>

4 
	~<lšux/moduË.h
>

5 
	~<lšux/tim”.h
>

6 
	~<lšux/aıi_pmtmr.h
>

7 
	~<lšux/ıuäeq.h
>

8 
	~<lšux/dmi.h
>

9 
	~<lšux/d–ay.h
>

10 
	~<lšux/şocksourû.h
>

11 
	~<lšux/³rıu.h
>

13 
	~<asm/h³t.h
>

14 
	~<asm/tim”.h
>

15 
	~<asm/vgtod.h
>

16 
	~<asm/time.h
>

17 
	~<asm/d–ay.h
>

18 
	~<asm/hy³rvisÜ.h
>

20 
__»ad_mo¡ly
 
	gıu_khz
;

21 
EXPORT_SYMBOL
(
ıu_khz
);

23 
__»ad_mo¡ly
 
	gtsc_khz
;

24 
EXPORT_SYMBOL
(
tsc_khz
);

29 
__»ad_mo¡ly
 
	gtsc_un¡abË
;

34 
__»ad_mo¡ly
 
	gtsc_di§bËd
 = -1;

36 
	gtsc_şocksourû_»lŸbË
;

40 
u64
 
	$Çtive_sched_şock
()

42 
u64
 
this_off£t
;

52 ià(
	`uÆik–y
(
tsc_di§bËd
)) {

54  (
jiff›s_64
 - 
INITIAL_JIFFIES
è* (1000000000 / 
HZ
);

58 
	`rdtsşl
(
this_off£t
);

61  
	`__cyşes_2_ns
(
this_off£t
);

62 
	}
}

66 #ifdeà
CONFIG_PARAVIRT


67 
	$sched_şock
()

69  
	`·¿vœt_sched_şock
();

70 
	}
}

73 
	$sched_şock
(è
	`__©Œibu‹__
((
	`®Ÿs
("native_sched_clock")));

76 
	$check_tsc_un¡abË
()

78  
tsc_un¡abË
;

79 
	}
}

80 
EXPORT_SYMBOL_GPL
(
check_tsc_un¡abË
);

82 #ifdeà
CONFIG_X86_TSC


83 
__š™
 
	$nÙsc_£tup
(*
¡r
)

85 
	`´štk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

87 
tsc_di§bËd
 = 1;

89 
	}
}

95 
__š™
 
	$nÙsc_£tup
(*
¡r
)

97 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_TSC
);

99 
	}
}

102 
__£tup
("nÙsc", 
nÙsc_£tup
);

104 
__š™
 
	$tsc_£tup
(*
¡r
)

106 ià(!
	`¡rcmp
(
¡r
, "reliable"))

107 
tsc_şocksourû_»lŸbË
 = 1;

109 
	}
}

111 
__£tup
("tsc=", 
tsc_£tup
);

113 
	#MAX_RETRIES
 5

	)

114 
	#SMI_TRESHOLD
 50000

	)

119 
u64
 
	$tsc_»ad_»fs
(
u64
 *
p
, 
h³t
)

121 
u64
 
t1
, 
t2
;

122 
i
;

124 
i
 = 0; i < 
MAX_RETRIES
; i++) {

125 
t1
 = 
	`g‘_cyşes
();

126 ià(
h³t
)

127 *
p
 = 
	`h³t_»adl
(
HPET_COUNTER
) & 0xFFFFFFFF;

129 *
p
 = 
	`aıi_pm_»ad_—¾y
();

130 
t2
 = 
	`g‘_cyşes
();

131 ià((
t2
 - 
t1
è< 
SMI_TRESHOLD
)

132  
t2
;

134  
ULLONG_MAX
;

135 
	}
}

140 
	$ÿlc_h³t_»f
(
u64
 
d–tsc
, u64 
h³t1
, u64 
h³t2
)

142 
u64
 
tmp
;

144 ià(
h³t2
 < 
h³t1
)

145 
h³t2
 += 0x100000000ULL;

146 
h³t2
 -ğ
h³t1
;

147 
tmp
 = ((
u64
)
h³t2
 * 
	`h³t_»adl
(
HPET_PERIOD
));

148 
	`do_div
(
tmp
, 1000000);

149 
	`do_div
(
d–tsc
, 
tmp
);

151  (è
d–tsc
;

152 
	}
}

157 
	$ÿlc_pmtim”_»f
(
u64
 
d–tsc
, u64 
pm1
, u64 
pm2
)

159 
u64
 
tmp
;

161 ià(!
pm1
 && !
pm2
)

162  
ULONG_MAX
;

164 ià(
pm2
 < 
pm1
)

165 
pm2
 +ğ(
u64
)
ACPI_PM_OVRRUN
;

166 
pm2
 -ğ
pm1
;

167 
tmp
 = 
pm2
 * 1000000000LL;

168 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

169 
	`do_div
(
d–tsc
, 
tmp
);

171  (è
d–tsc
;

172 
	}
}

174 
	#CAL_MS
 10

	)

175 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

176 
	#CAL_PIT_LOOPS
 1000

	)

178 
	#CAL2_MS
 50

	)

179 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

180 
	#CAL2_PIT_LOOPS
 5000

	)

190 
	$p™_ÿlib¿‹_tsc
(
u32
 
Ïtch
, 
ms
, 
loİmš
)

192 
u64
 
tsc
, 
t1
, 
t2
, 
d–
;

193 
tscmš
, 
tscmax
;

194 
p™út
;

197 
	`outb
((
	`šb
(0x61) & ~0x02) | 0x01, 0x61);

204 
	`outb
(0xb0, 0x43);

205 
	`outb
(
Ïtch
 & 0xff, 0x42);

206 
	`outb
(
Ïtch
 >> 8, 0x42);

208 
tsc
 = 
t1
 = 
t2
 = 
	`g‘_cyşes
();

210 
p™út
 = 0;

211 
tscmax
 = 0;

212 
tscmš
 = 
ULONG_MAX
;

213 (
	`šb
(0x61) & 0x20) == 0) {

214 
t2
 = 
	`g‘_cyşes
();

215 
d–
 = 
t2
 - 
tsc
;

216 
tsc
 = 
t2
;

217 ià((è
d–
 < 
tscmš
)

218 
tscmš
 = (è
d–
;

219 ià((è
d–
 > 
tscmax
)

220 
tscmax
 = (è
d–
;

221 
p™út
++;

233 ià(
p™út
 < 
loİmš
 || 
tscmax
 > 10 * 
tscmš
)

234  
ULONG_MAX
;

237 
d–
 = 
t2
 - 
t1
;

238 
	`do_div
(
d–
, 
ms
);

239  
d–
;

240 
	}
}

277 
šlše
 
	$p™_ex³ù_msb
(
v®
, 
u64
 *
tsı
, *
d–p
)

279 
couÁ
;

280 
u64
 
tsc
 = 0;

282 
couÁ
 = 0; count < 50000; count++) {

284 
	`šb
(0x42);

285 ià(
	`šb
(0x42è!ğ
v®
)

287 
tsc
 = 
	`g‘_cyşes
();

289 *
d–p
 = 
	`g‘_cyşes
(è- 
tsc
;

290 *
tsı
 = 
tsc
;

296  
couÁ
 > 5;

297 
	}
}

305 
	#MAX_QUICK_PIT_MS
 25

	)

306 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

308 
	$quick_p™_ÿlib¿‹
()

310 
i
;

311 
u64
 
tsc
, 
d–
;

312 
d1
, 
d2
;

315 
	`outb
((
	`šb
(0x61) & ~0x02) | 0x01, 0x61);

326 
	`outb
(0xb0, 0x43);

329 
	`outb
(0xff, 0x42);

330 
	`outb
(0xff, 0x42);

338 
	`šb
(0x42);

339 
	`šb
(0x42);

341 ià(
	`p™_ex³ù_msb
(0xff, &
tsc
, &
d1
)) {

342 
i
 = 1; i <ğ
MAX_QUICK_PIT_ITERATIONS
; i++) {

343 ià(!
	`p™_ex³ù_msb
(0xff-
i
, &
d–
, &
d2
))

349 
d–
 -ğ
tsc
;

350 ià(
d1
+
d2
 < 
d–
 >> 11)

351 
sucûss
;

354 
	`´štk
("Fast TSC calibration failed\n");

357 
sucûss
:

373 
d–
 +ğ()(
d2
 - 
d1
)/2;

374 
d–
 *ğ
PIT_TICK_RATE
;

375 
	`do_div
(
d–
, 
i
*256*1000);

376 
	`´štk
("Fast TSC calibration using PIT\n");

377  
d–
;

378 
	}
}

383 
	$Çtive_ÿlib¿‹_tsc
()

385 
u64
 
tsc1
, 
tsc2
, 
d–
, 
»f1
, 
»f2
;

386 
tsc_p™_mš
 = 
ULONG_MAX
, 
tsc_»f_mš
 = ULONG_MAX;

387 
æags
, 
Ïtch
, 
ms
, 
ç¡_ÿlib¿‹
, 
tsc_khz
;

388 
h³t
 = 
	`is_h³t_’abËd
(), 
i
, 
loİmš
;

390 
tsc_khz
 = 
	`g‘_hy³rvisÜ_tsc_äeq
();

391 ià(
tsc_khz
) {

392 
	`´štk
(
KERN_INFO
 "TSC: Frequency„ead fromhe hypervisor\n");

393  
tsc_khz
;

396 
	`loÿl_œq_§ve
(
æags
);

397 
ç¡_ÿlib¿‹
 = 
	`quick_p™_ÿlib¿‹
();

398 
	`loÿl_œq_»¡Üe
(
æags
);

399 ià(
ç¡_ÿlib¿‹
)

400  
ç¡_ÿlib¿‹
;

428 
Ïtch
 = 
CAL_LATCH
;

429 
ms
 = 
CAL_MS
;

430 
loİmš
 = 
CAL_PIT_LOOPS
;

432 
i
 = 0; i < 3; i++) {

433 
tsc_p™_khz
;

441 
	`loÿl_œq_§ve
(
æags
);

442 
tsc1
 = 
	`tsc_»ad_»fs
(&
»f1
, 
h³t
);

443 
tsc_p™_khz
 = 
	`p™_ÿlib¿‹_tsc
(
Ïtch
, 
ms
, 
loİmš
);

444 
tsc2
 = 
	`tsc_»ad_»fs
(&
»f2
, 
h³t
);

445 
	`loÿl_œq_»¡Üe
(
æags
);

448 
tsc_p™_mš
 = 
	`mš
Ñsc_p™_mš, 
tsc_p™_khz
);

451 ià(!
h³t
 && !
»f1
 && !
»f2
)

455 ià(
tsc1
 =ğ
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

458 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

459 ià(
h³t
)

460 
tsc2
 = 
	`ÿlc_h³t_»f
Ñsc2, 
»f1
, 
»f2
);

462 
tsc2
 = 
	`ÿlc_pmtim”_»f
Ñsc2, 
»f1
, 
»f2
);

464 
tsc_»f_mš
 = 
	`mš
Ñsc_»f_mš, (è
tsc2
);

467 
d–
 = ((
u64
è
tsc_p™_mš
) * 100;

468 
	`do_div
(
d–
, 
tsc_»f_mš
);

476 ià(
d–
 >= 90 && delta <= 110) {

477 
	`´štk
(
KERN_INFO


479 
h³t
 ? "HPET" : "PMTIMER", 
i
 + 1);

480  
tsc_»f_mš
;

489 ià(
i
 =ğ1 && 
tsc_p™_mš
 =ğ
ULONG_MAX
) {

490 
Ïtch
 = 
CAL2_LATCH
;

491 
ms
 = 
CAL2_MS
;

492 
loİmš
 = 
CAL2_PIT_LOOPS
;

499 ià(
tsc_p™_mš
 =ğ
ULONG_MAX
) {

501 
	`´štk
(
KERN_WARNING
 "TSC: Unableo calibrate‡gainst PIT\n");

504 ià(!
h³t
 && !
»f1
 && !
»f2
) {

505 
	`´štk
("TSC: No„eference (HPET/PMTIMER)‡vailable\n");

510 ià(
tsc_»f_mš
 =ğ
ULONG_MAX
) {

511 
	`´štk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

517 
	`´štk
(
KERN_INFO
 "TSC: using %s„eference calibration\n",

518 
h³t
 ? "HPET" : "PMTIMER");

520  
tsc_»f_mš
;

524 ià(!
h³t
 && !
»f1
 && !
»f2
) {

525 
	`´štk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

526  
tsc_p™_mš
;

530 ià(
tsc_»f_mš
 =ğ
ULONG_MAX
) {

531 
	`´štk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

533  
tsc_p™_mš
;

541 
	`´štk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

542 
h³t
 ? "HPET" : "PMTIMER", 
tsc_p™_mš
, 
tsc_»f_mš
);

543 
	`´štk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

544  
tsc_p™_mš
;

545 
	}
}

547 
	$»ÿlib¿‹_ıu_khz
()

549 #iâdeà
CONFIG_SMP


550 
ıu_khz_Şd
 = 
ıu_khz
;

552 ià(
ıu_has_tsc
) {

553 
tsc_khz
 = 
	`ÿlib¿‹_tsc
();

554 
ıu_khz
 = 
tsc_khz
;

555 
	`ıu_d©a
(0).
loİs_³r_jiffy
 =

556 
	`ıuäeq_sÿË
(
	`ıu_d©a
(0).
loİs_³r_jiffy
,

557 
ıu_khz_Şd
, 
ıu_khz
);

560  -
ENODEV
;

562  -
ENODEV
;

564 
	}
}

566 
EXPORT_SYMBOL
(
»ÿlib¿‹_ıu_khz
);

591 
DEFINE_PER_CPU
(, 
cyc2ns
);

593 
	$£t_cyc2ns_sÿË
(
ıu_khz
, 
ıu
)

595 
tsc_now
, 
ns_now
;

596 
æags
, *
sÿË
;

598 
	`loÿl_œq_§ve
(
æags
);

599 
	`sched_şock_idË_¦“p_ev’t
();

601 
sÿË
 = &
	`³r_ıu
(
cyc2ns
, 
ıu
);

603 
	`rdtsşl
(
tsc_now
);

604 
ns_now
 = 
	`__cyşes_2_ns
(
tsc_now
);

606 ià(
ıu_khz
)

607 *
sÿË
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
ıu_khz
;

609 
	`sched_şock_idË_wakeup_ev’t
(0);

610 
	`loÿl_œq_»¡Üe
(
æags
);

611 
	}
}

613 #ifdeà
CONFIG_CPU_FREQ


626 
	g»f_äeq
;

627 
	gloİs_³r_jiffy_»f
;

628 
	gtsc_khz_»f
;

630 
	$time_ıuäeq_nÙif›r
(
nÙif›r_block
 *
nb
, 
v®
,

631 *
d©a
)

633 
ıuäeq_äeqs
 *
äeq
 = 
d©a
;

634 *
Íj
, 
dummy
;

636 ià(
	`ıu_has
(&
	`ıu_d©a
(
äeq
->
ıu
), 
X86_FEATURE_CONSTANT_TSC
))

639 
Íj
 = &
dummy
;

640 ià(!(
äeq
->
æags
 & 
CPUFREQ_CONST_LOOPS
))

641 #ifdeà
CONFIG_SMP


642 
Íj
 = &
	`ıu_d©a
(
äeq
->
ıu
).
loİs_³r_jiffy
;

644 
Íj
 = &
boÙ_ıu_d©a
.
loİs_³r_jiffy
;

647 ià(!
»f_äeq
) {

648 
»f_äeq
 = 
äeq
->
Şd
;

649 
loİs_³r_jiffy_»f
 = *
Íj
;

650 
tsc_khz_»f
 = 
tsc_khz
;

652 ià((
v®
 =ğ
CPUFREQ_PRECHANGE
 && 
äeq
->
Şd
 < f»q->
Ãw
) ||

653 (
v®
 =ğ
CPUFREQ_POSTCHANGE
 && 
äeq
->
Şd
 > f»q->
Ãw
) ||

654 (
v®
 =ğ
CPUFREQ_RESUMECHANGE
)) {

655 *
Íj
 = 
	`ıuäeq_sÿË
(
loİs_³r_jiffy_»f
, 
»f_äeq
, 
äeq
->
Ãw
);

657 
tsc_khz
 = 
	`ıuäeq_sÿË
(
tsc_khz_»f
, 
»f_äeq
, 
äeq
->
Ãw
);

658 ià(!(
äeq
->
æags
 & 
CPUFREQ_CONST_LOOPS
))

659 
	`m¬k_tsc_un¡abË
("cpufreq changes");

662 
	`£t_cyc2ns_sÿË
(
tsc_khz
, 
äeq
->
ıu
);

665 
	}
}

667 
nÙif›r_block
 
	gtime_ıuäeq_nÙif›r_block
 = {

668 .
nÙif›r_ÿÎ
 = 
time_ıuäeq_nÙif›r


671 
__š™
 
	$ıuäeq_tsc
()

673 ià(!
ıu_has_tsc
)

675 ià(
	`boÙ_ıu_has
(
X86_FEATURE_CONSTANT_TSC
))

677 
	`ıuäeq_»gi¡”_nÙif›r
(&
time_ıuäeq_nÙif›r_block
,

678 
CPUFREQ_TRANSITION_NOTIFIER
);

680 
	}
}

682 
cÜe_š™ÿÎ
(
ıuäeq_tsc
);

688 
şocksourû
 
	gşocksourû_tsc
;

702 
cyşe_t
 
	$»ad_tsc
(
şocksourû
 *
cs
)

704 
cyşe_t
 
»t
 = (cyşe_t)
	`g‘_cyşes
();

706  
»t
 >ğ
şocksourû_tsc
.
cyşe_Ï¡
 ?

707 
»t
 : 
şocksourû_tsc
.
cyşe_Ï¡
;

708 
	}
}

710 #ifdeà
CONFIG_X86_64


711 
cyşe_t
 
__vsysÿÎ_â
 
	$v»ad_tsc
()

713 
cyşe_t
 
»t
 = (cyşe_t)
	`vg‘_cyşes
();

715  
»t
 >ğ
__vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
 ?

716 
»t
 : 
__vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
;

717 
	}
}

720 
şocksourû
 
	gşocksourû_tsc
 = {

721 .
Çme
 = "tsc",

722 .
	g¿tšg
 = 300,

723 .
	g»ad
 = 
»ad_tsc
,

724 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

725 .
	gshiá
 = 22,

726 .
	gæags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

727 
CLOCK_SOURCE_MUST_VERIFY
,

728 #ifdeà
CONFIG_X86_64


729 .
	gv»ad
 = 
v»ad_tsc
,

733 
	$m¬k_tsc_un¡abË
(*
»asÚ
)

735 ià(!
tsc_un¡abË
) {

736 
tsc_un¡abË
 = 1;

737 
	`´štk
("M¬kšg TSC un¡abË dutØ%s\n", 
»asÚ
);

739 ià(
şocksourû_tsc
.
muÉ
)

740 
	`şocksourû_chªge_¿tšg
(&
şocksourû_tsc
, 0);

742 
şocksourû_tsc
.
¿tšg
 = 0;

744 
	}
}

746 
EXPORT_SYMBOL_GPL
(
m¬k_tsc_un¡abË
);

748 
__š™
 
	$dmi_m¬k_tsc_un¡abË
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

750 
	`´štk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

751 
d
->
id’t
);

752 
tsc_un¡abË
 = 1;

754 
	}
}

757 
dmi_sy¡em_id
 
__š™d©a
 
	gbad_tsc_dmi_bË
[] = {

759 .
ÿÎback
 = 
dmi_m¬k_tsc_un¡abË
,

760 .
	gid’t
 = "IBM Thinkpad 380XD",

761 .
	gm©ches
 = {

762 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

763 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

769 
__š™
 
	$check_sy¡em_tsc_»lŸbË
()

771 #ifdeà
CONFIG_MGEODE_LX


773 
	#RTSC_SUSP
 0x100

	)

774 
»s_low
, 
»s_high
;

776 
	`rdm¤_§ã
(
MSR_GEODE_BUSCONT_CONF0
, &
»s_low
, &
»s_high
);

778 ià(
»s_low
 & 
RTSC_SUSP
)

779 
tsc_şocksourû_»lŸbË
 = 1;

781 ià(
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
))

782 
tsc_şocksourû_»lŸbË
 = 1;

783 
	}
}

789 
__ıuš™
 
	$unsynchrÚized_tsc
()

791 ià(!
ıu_has_tsc
 || 
tsc_un¡abË
)

794 #ifdeà
CONFIG_SMP


795 ià(
	`­ic_is_şu¡”ed_box
())

799 ià(
	`boÙ_ıu_has
(
X86_FEATURE_CONSTANT_TSC
))

805 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
) {

807 ià(
	`num_possibË_ıus
() > 1)

808 
tsc_un¡abË
 = 1;

811  
tsc_un¡abË
;

812 
	}
}

814 
__š™
 
	$š™_tsc_şocksourû
()

816 
şocksourû_tsc
.
muÉ
 = 
	`şocksourû_khz2muÉ
(
tsc_khz
,

817 
şocksourû_tsc
.
shiá
);

818 ià(
tsc_şocksourû_»lŸbË
)

819 
şocksourû_tsc
.
æags
 &ğ~
CLOCK_SOURCE_MUST_VERIFY
;

821 ià(
	`check_tsc_un¡abË
()) {

822 
şocksourû_tsc
.
¿tšg
 = 0;

823 
şocksourû_tsc
.
æags
 &ğ~
CLOCK_SOURCE_IS_CONTINUOUS
;

825 
	`şocksourû_»gi¡”
(&
şocksourû_tsc
);

826 
	}
}

828 
__š™
 
	$tsc_š™
()

830 
u64
 
Íj
;

831 
ıu
;

833 ià(!
ıu_has_tsc
)

836 
tsc_khz
 = 
	`ÿlib¿‹_tsc
();

837 
ıu_khz
 = 
tsc_khz
;

839 ià(!
tsc_khz
) {

840 
	`m¬k_tsc_un¡abË
("could‚ot calculate TSC khz");

844 #ifdeà
CONFIG_X86_64


845 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

846 (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
))

847 
ıu_khz
 = 
	`ÿlib¿‹_ıu
();

850 
	`´štk
("Detected %lu.%03lu MHz…rocessor.\n",

851 ()
ıu_khz
 / 1000,

852 ()
ıu_khz
 % 1000);

860 
	`fÜ_—ch_possibË_ıu
(
ıu
)

861 
	`£t_cyc2ns_sÿË
(
ıu_khz
, 
ıu
);

863 ià(
tsc_di§bËd
 > 0)

867 
tsc_di§bËd
 = 0;

869 
Íj
 = ((
u64
)
tsc_khz
 * 1000);

870 
	`do_div
(
Íj
, 
HZ
);

871 
Íj_fše
 = 
Íj
;

873 
	`u£_tsc_d–ay
();

875 
	`dmi_check_sy¡em
(
bad_tsc_dmi_bË
);

877 ià(
	`unsynchrÚized_tsc
())

878 
	`m¬k_tsc_un¡abË
("TSCs unsynchronized");

880 
	`check_sy¡em_tsc_»lŸbË
();

881 
	`š™_tsc_şocksourû
();

882 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<lšux/¥šlock.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/smp.h
>

21 
	~<lšux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__ıuš™d©a
 
©omic_t
 
	g¡¬t_couÁ
;

29 
__ıuš™d©a
 
©omic_t
 
	g¡İ_couÁ
;

36 
__ıuš™d©a
 
¿w_¥šlock_t
 
	gsync_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

37 
__ıuš™d©a
 
cyşes_t
 
	gÏ¡_tsc
;

38 
__ıuš™d©a
 
cyşes_t
 
	gmax_w¬p
;

39 
__ıuš™d©a
 
	gÄ_w¬ps
;

44 
__ıuš™
 
	$check_tsc_w¬p
()

46 
cyşes_t
 
¡¬t
, 
now
, 
´ev
, 
’d
;

47 
i
;

49 
	`rdtsc_b¬r›r
();

50 
¡¬t
 = 
	`g‘_cyşes
();

51 
	`rdtsc_b¬r›r
();

55 
’d
 = 
¡¬t
 + 
tsc_khz
 * 20ULL;

56 
now
 = 
¡¬t
;

58 
i
 = 0; ; i++) {

64 
	`__¿w_¥š_lock
(&
sync_lock
);

65 
´ev
 = 
Ï¡_tsc
;

66 
	`rdtsc_b¬r›r
();

67 
now
 = 
	`g‘_cyşes
();

68 
	`rdtsc_b¬r›r
();

69 
Ï¡_tsc
 = 
now
;

70 
	`__¿w_¥š_uÆock
(&
sync_lock
);

78 ià(
	`uÆik–y
(!(
i
 & 7))) {

79 ià(
now
 > 
’d
 || 
i
 > 10000000)

81 
	`ıu_»Ïx
();

82 
	`touch_nmi_w©chdog
();

88 ià(
	`uÆik–y
(
´ev
 > 
now
)) {

89 
	`__¿w_¥š_lock
(&
sync_lock
);

90 
max_w¬p
 = 
	`max
(max_w¬p, 
´ev
 - 
now
);

91 
Ä_w¬ps
++;

92 
	`__¿w_¥š_uÆock
(&
sync_lock
);

95 
	`WARN
(!(
now
-
¡¬t
),

97 
now
-
¡¬t
, 
’d
-start);

98 
	}
}

104 
__ıuš™
 
	$check_tsc_sync_sourû
(
ıu
)

106 
ıus
 = 2;

112 ià(
	`unsynchrÚized_tsc
())

115 ià(
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
)) {

116 
	`´štk
(
KERN_INFO


121 
	`´štk
(
KERN_INFO
 "checking TSC synchronization [CPU#%d -> CPU#%d]:",

122 
	`smp_´oûssÜ_id
(), 
ıu
);

127 
	`©omic_£t
(&
¡İ_couÁ
, 0);

132 
	`©omic_»ad
(&
¡¬t_couÁ
è!ğ
ıus
-1)

133 
	`ıu_»Ïx
();

137 
	`©omic_šc
(&
¡¬t_couÁ
);

139 
	`check_tsc_w¬p
();

141 
	`©omic_»ad
(&
¡İ_couÁ
è!ğ
ıus
-1)

142 
	`ıu_»Ïx
();

144 ià(
Ä_w¬ps
) {

145 
	`´štk
("\n");

146 
	`´štk
(
KERN_WARNING
 "Measured %Ld cycles TSC warp between CPUs,"

147 "uºšg ofàTSC clock.\n", 
max_w¬p
);

148 
	`m¬k_tsc_un¡abË
("check_tsc_sync_source failed");

150 
	`´štk
("…assed.\n");

156 
	`©omic_£t
(&
¡¬t_couÁ
, 0);

157 
Ä_w¬ps
 = 0;

158 
max_w¬p
 = 0;

159 
Ï¡_tsc
 = 0;

164 
	`©omic_šc
(&
¡İ_couÁ
);

165 
	}
}

170 
__ıuš™
 
	$check_tsc_sync_rg‘
()

172 
ıus
 = 2;

174 ià(
	`unsynchrÚized_tsc
(è|| 
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
))

181 
	`©omic_šc
(&
¡¬t_couÁ
);

182 
	`©omic_»ad
(&
¡¬t_couÁ
è!ğ
ıus
)

183 
	`ıu_»Ïx
();

185 
	`check_tsc_w¬p
();

190 
	`©omic_šc
(&
¡İ_couÁ
);

195 
	`©omic_»ad
(&
¡İ_couÁ
è!ğ
ıus
)

196 
	`ıu_»Ïx
();

197 
	}
}

198 #undeà
NR_LOOPS


	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<lšux/š™.h
>

16 
	~<lšux/pci_ids.h
>

17 
	~<lšux/pci_»gs.h
>

19 
	~<asm/­ic.h
>

20 
	~<asm/pci-dœeù.h
>

21 
	~<asm/io.h
>

22 
	~<asm/·¿vœt.h
>

23 
	~<asm/£tup.h
>

25 #ià
defšed
 
CONFIG_PCI
 && defšed 
CONFIG_PARAVIRT


32 
	$vsmp_§ve_æ
()

34 
æags
 = 
	`Çtive_§ve_æ
();

36 ià(!(
æags
 & 
X86_EFLAGS_IF
è|| (æag & 
X86_EFLAGS_AC
))

37 
æags
 &ğ~
X86_EFLAGS_IF
;

38  
æags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_§ve_æ
);

42 
	$vsmp_»¡Üe_æ
(
æags
)

44 ià(
æags
 & 
X86_EFLAGS_IF
)

45 
æags
 &ğ~
X86_EFLAGS_AC
;

47 
æags
 |ğ
X86_EFLAGS_AC
;

48 
	`Çtive_»¡Üe_æ
(
æags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_»¡Üe_æ
);

52 
	$vsmp_œq_di§bË
()

54 
æags
 = 
	`Çtive_§ve_æ
();

56 
	`Çtive_»¡Üe_æ
((
æags
 & ~
X86_EFLAGS_IF
è| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_œq_di§bË
);

60 
	$vsmp_œq_’abË
()

62 
æags
 = 
	`Çtive_§ve_æ
();

64 
	`Çtive_»¡Üe_æ
((
æags
 | 
X86_EFLAGS_IF
è& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_œq_’abË
);

68 
__š™_Ü_moduË
 
	$vsmp_·tch
(
u8
 
ty³
, 
u16
 
şobb”s
, *
ibuf
,

69 
addr
, 
Ën
)

71 
ty³
) {

72 
	`PARAVIRT_PATCH
(
pv_œq_İs
.
œq_’abË
):

73 
	`PARAVIRT_PATCH
(
pv_œq_İs
.
œq_di§bË
):

74 
	`PARAVIRT_PATCH
(
pv_œq_İs
.
§ve_æ
):

75 
	`PARAVIRT_PATCH
(
pv_œq_İs
.
»¡Üe_æ
):

76  
	`·¿vœt_·tch_deçuÉ
(
ty³
, 
şobb”s
, 
ibuf
, 
addr
, 
Ën
);

78  
	`Çtive_·tch
(
ty³
, 
şobb”s
, 
ibuf
, 
addr
, 
Ën
);

81 
	}
}

83 
__š™
 
	$£t_vsmp_pv_İs
()

85 
__iomem
 *
add»ss
;

86 
ÿp
, 
ùl
, 
cfg
;

89 
cfg
 = 
	`»ad_pci_cÚfig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
add»ss
 = 
	`—¾y_iÜem­
(
cfg
, 8);

91 
ÿp
 = 
	`»adl
(
add»ss
);

92 
ùl
 = 
	`»adl
(
add»ss
 + 4);

93 
	`´štk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ÿp
, 
ùl
);

95 ià(
ÿp
 & 
ùl
 & (1 << 4)) {

97 
pv_œq_İs
.
œq_di§bË
 = 
	`PV_CALLEE_SAVE
(
vsmp_œq_di§bË
);

98 
pv_œq_İs
.
œq_’abË
 = 
	`PV_CALLEE_SAVE
(
vsmp_œq_’abË
);

99 
pv_œq_İs
.
§ve_æ
 = 
	`PV_CALLEE_SAVE
(
vsmp_§ve_æ
);

100 
pv_œq_İs
.
»¡Üe_æ
 = 
	`PV_CALLEE_SAVE
(
vsmp_»¡Üe_æ
);

101 
pv_š™_İs
.
·tch
 = 
vsmp_·tch
;

103 
ùl
 &= ~(1 << 4);

104 
	`wr™–
(
ùl
, 
add»ss
 + 4);

105 
ùl
 = 
	`»adl
(
add»ss
 + 4);

106 
	`´štk
(
KERN_INFO
 "vSMP CTL: cÚŒŞ s‘o:0x%08x\n", 
ùl
);

109 
	`—¾y_iounm­
(
add»ss
, 8);

110 
	}
}

112 
__š™
 
	$£t_vsmp_pv_İs
()

114 
	}
}

117 #ifdeà
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__š™
 
	$d‘eù_vsmp_box
()

122 
is_vsmp
 = 0;

124 ià(!
	`—¾y_pci_®lowed
())

128 ià(
	`»ad_pci_cÚfig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 ià(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__š™
 
	$d‘eù_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__š™
 
	$vsmp_š™
()

154 
	`d‘eù_vsmp_box
();

155 ià(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_İs
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<lšux/time.h
>

24 
	~<lšux/š™.h
>

25 
	~<lšux/k”Ãl.h
>

26 
	~<lšux/tim”.h
>

27 
	~<lšux/£qlock.h
>

28 
	~<lšux/jiff›s.h
>

29 
	~<lšux/sysùl.h
>

30 
	~<lšux/şocksourû.h
>

31 
	~<lšux/g‘ıu.h
>

32 
	~<lšux/ıu.h
>

33 
	~<lšux/smp.h
>

34 
	~<lšux/nÙif›r.h
>

36 
	~<asm/vsysÿÎ.h
>

37 
	~<asm/pgbË.h
>

38 
	~<asm/·ge.h
>

39 
	~<asm/uni¡d.h
>

40 
	~<asm/fixm­.h
>

41 
	~<asm/”ºo.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gm’t.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/tİŞogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysÿÎ
(
Ä
) \

49 
	`__©Œibu‹__
 ((
unu£d
, 
	`__£ùiÚ__
(".vsysÿÎ_" #Ä))è
nÙ¿û


	)

50 
	#__sysÿÎ_şobb”
 "r11","cx","memÜy"

	)

58 
__vg‘ıu_mode
 
	g__£ùiÚ_vg‘ıu_mode
;

60 
vsysÿÎ_gtod_d©a
 
__vsysÿÎ_gtod_d©a
 
	g__£ùiÚ_vsysÿÎ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsysùl_’abËd
 = 1,

66 
	$upd©e_vsysÿÎ_tz
()

68 
æags
;

70 
	`wr™e_£qlock_œq§ve
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

72 
vsysÿÎ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wr™e_£quÆock_œq»¡Üe
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

74 
	}
}

76 
	$upd©e_vsysÿÎ
(
time¥ec
 *
w®l_time
, 
şocksourû
 *
şock
)

78 
æags
;

80 
	`wr™e_£qlock_œq§ve
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

82 
vsysÿÎ_gtod_d©a
.
şock
.
v»ad
 = clock->vread;

83 
vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
 = clock->cycle_last;

84 
vsysÿÎ_gtod_d©a
.
şock
.
mask
 = clock->mask;

85 
vsysÿÎ_gtod_d©a
.
şock
.
muÉ
 = clock->mult;

86 
vsysÿÎ_gtod_d©a
.
şock
.
shiá
 = clock->shift;

87 
vsysÿÎ_gtod_d©a
.
w®l_time_£c
 = 
w®l_time
->
tv_£c
;

88 
vsysÿÎ_gtod_d©a
.
w®l_time_n£c
 = 
w®l_time
->
tv_n£c
;

89 
vsysÿÎ_gtod_d©a
.
w®l_to_mÚÙÚic
 = wall_to_monotonic;

90 
	`wr™e_£quÆock_œq»¡Üe
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

91 
	}
}

96 
__®ways_šlše
 
	$do_g‘_tz
(
timezÚe
 * 
tz
)

98 *
tz
 = 
__vsysÿÎ_gtod_d©a
.
sys_tz
;

99 
	}
}

101 
__®ways_šlše
 
	$g‘timeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

103 
»t
;

104 
asm
 volatile("syscall"

105 : "÷" (
»t
)

106 : "0" (
__NR_g‘timeofday
),"D" (
tv
),"S" (
tz
)

107 : 
__sysÿÎ_şobb”
 );

108  
»t
;

109 
	}
}

111 
__®ways_šlše
 
	$time_sysÿÎ
(*
t
)

113 
£cs
;

114 
asm
 volatile("syscall"

115 : "÷" (
£cs
)

116 : "0" (
__NR_time
),"D" (
t
è: 
__sysÿÎ_şobb”
);

117  
£cs
;

118 
	}
}

120 
__®ways_šlše
 
	$do_vg‘timeofday
(
timev®
 * 
tv
)

122 
cyşe_t
 
now
, 
ba£
, 
mask
, 
cyşe_d–
;

123 
£q
;

124 
muÉ
, 
shiá
, 
n£c
;

125 
	`cyşe_t
 (*
v»ad
)();

127 
£q
 = 
	`»ad_£qbegš
(&
__vsysÿÎ_gtod_d©a
.
lock
);

129 
v»ad
 = 
__vsysÿÎ_gtod_d©a
.
şock
.vread;

130 ià(
	`uÆik–y
(!
__vsysÿÎ_gtod_d©a
.
sysùl_’abËd
 || !
v»ad
)) {

131 
	`g‘timeofday
(
tv
,
NULL
);

140 
	`rdtsc_b¬r›r
();

141 
now
 = 
	`v»ad
();

142 
	`rdtsc_b¬r›r
();

144 
ba£
 = 
__vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
;

145 
mask
 = 
__vsysÿÎ_gtod_d©a
.
şock
.mask;

146 
muÉ
 = 
__vsysÿÎ_gtod_d©a
.
şock
.mult;

147 
shiá
 = 
__vsysÿÎ_gtod_d©a
.
şock
.shift;

149 
tv
->
tv_£c
 = 
__vsysÿÎ_gtod_d©a
.
w®l_time_£c
;

150 
n£c
 = 
__vsysÿÎ_gtod_d©a
.
w®l_time_n£c
;

151 } 
	`»ad_£q»Œy
(&
__vsysÿÎ_gtod_d©a
.
lock
, 
£q
));

154 
cyşe_d–
 = (
now
 - 
ba£
è& 
mask
;

156 
n£c
 +ğ(
cyşe_d–
 * 
muÉ
è>> 
shiá
;

158 
n£c
 >ğ
NSEC_PER_SEC
) {

159 
tv
->
tv_£c
 += 1;

160 
n£c
 -ğ
NSEC_PER_SEC
;

162 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

163 
	}
}

165 
	$__vsysÿÎ
(0è
	$vg‘timeofday
(
timev®
 * 
tv
, 
timezÚe
 * 
tz
)

167 ià(
tv
)

168 
	`do_vg‘timeofday
(
tv
);

169 ià(
tz
)

170 
	`do_g‘_tz
(
tz
);

172 
	}
}

176 
time_t
 
	$__vsysÿÎ
(1è
	$vtime
(
time_t
 *
t
)

178 
timev®
 
tv
;

179 
time_t
 
»suÉ
;

180 ià(
	`uÆik–y
(!
__vsysÿÎ_gtod_d©a
.
sysùl_’abËd
))

181  
	`time_sysÿÎ
(
t
);

183 
	`vg‘timeofday
(&
tv
, 
NULL
);

184 
»suÉ
 = 
tv
.
tv_£c
;

185 ià(
t
)

186 *
t
 = 
»suÉ
;

187  
»suÉ
;

188 
	}
}

198 
	$__vsysÿÎ
(2)

199 
	$vg‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
tÿche
)

201 
p
;

202 
j
 = 0;

212 ià(
tÿche
 &&ÿche->
blob
[0] =ğ(
j
 = 
__jiff›s
)) {

213 
p
 = 
tÿche
->
blob
[1];

214 } ià(
__vg‘ıu_mode
 =ğ
VGETCPU_RDTSCP
) {

216 
	`Çtive_»ad_tsı
(&
p
);

219 
	`asm
("l¦ %1,%0" : "ô" (
p
è: "r" (
__PER_CPU_SEG
));

221 ià(
tÿche
) {

222 
tÿche
->
blob
[0] = 
j
;

223 
tÿche
->
blob
[1] = 
p
;

225 ià(
ıu
)

226 *
ıu
 = 
p
 & 0xfff;

227 ià(
node
)

228 *
node
 = 
p
 >> 12;

230 
	}
}

232 
	$__vsysÿÎ
(3è
	$v’osys_1
()

234  -
ENOSYS
;

235 
	}
}

237 #ifdeà
CONFIG_SYSCTL


240 
	$vsysÿÎ_sysùl_chªge
(
ùl_bË
 *
ùl
, 
wr™e
, 
fe
 * 
fp
,

241 
__u£r
 *
bufãr
, 
size_t
 *
ËÅ
, 
loff_t
 *
µos
)

243  
	`´oc_doštvec
(
ùl
, 
wr™e
, 
fp
, 
bufãr
, 
ËÅ
, 
µos
);

244 
	}
}

246 
ùl_bË
 
	gk”Ãl_bË2
[] = {

247 { .
´oúame
 = "vsyscall64",

248 .
	gd©a
 = &
vsysÿÎ_gtod_d©a
.
sysùl_’abËd
, .
	gmaxËn
 = (),

249 .
	gmode
 = 0644,

250 .
	g´oc_hªdËr
 = 
vsysÿÎ_sysùl_chªge
 },

254 
ùl_bË
 
	gk”Ãl_roÙ_bË2
[] = {

255 { .
ùl_Çme
 = 
CTL_KERN
, .
	g´oúame
 = "k”Ãl", .
	gmode
 = 0555,

256 .
	gchd
 = 
k”Ãl_bË2
 },

263 
__ıuš™
 
	$vsysÿÎ_£t_ıu
(
ıu
)

265 
d
;

266 
node
 = 0;

267 #ifdeà
CONFIG_NUMA


268 
node
 = 
	`ıu_to_node
(
ıu
);

270 ià(
	`ıu_has
(&
	`ıu_d©a
(
ıu
), 
X86_FEATURE_RDTSCP
))

271 
	`wr™e_rdtsı_aux
((
node
 << 12è| 
ıu
);

276 
d
 = 0x0f40000000000ULL;

277 
d
 |ğ
ıu
;

278 
d
 |ğ(
node
 & 0xf) << 12;

279 
d
 |ğ(
node
 >> 4) << 48;

280 
	`wr™e_gdt_’Œy
(
	`g‘_ıu_gdt_bË
(
ıu
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

281 
	}
}

283 
__ıuš™
 
	$ıu_vsysÿÎ_š™
(*
¬g
)

286 
	`vsysÿÎ_£t_ıu
(
	`¿w_smp_´oûssÜ_id
());

287 
	}
}

289 
__ıuš™


290 
	$ıu_vsysÿÎ_nÙif›r
(
nÙif›r_block
 *
n
, 
aùiÚ
, *
¬g
)

292 
ıu
 = ()
¬g
;

293 ià(
aùiÚ
 =ğ
CPU_ONLINE
 ||‡ùiÚ =ğ
CPU_ONLINE_FROZEN
)

294 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
ıu_vsysÿÎ_š™
, 
NULL
, 1);

295  
NOTIFY_DONE
;

296 
	}
}

298 
__š™
 
	$m­_vsysÿÎ
()

300 
__vsysÿÎ_0
;

301 
phy§ddr_·ge0
 = 
	`__·_symbŞ
(&
__vsysÿÎ_0
);

304 
	`__£t_fixm­
(
VSYSCALL_FIRST_PAGE
, 
phy§ddr_·ge0
, 
PAGE_KERNEL_VSYSCALL
);

305 
	}
}

307 
__š™
 
	$vsysÿÎ_š™
()

309 
	`BUG_ON
(((è&
vg‘timeofday
 !=

310 
	`VSYSCALL_ADDR
(
__NR_vg‘timeofday
)));

311 
	`BUG_ON
((è&
vtime
 !ğ
	`VSYSCALL_ADDR
(
__NR_vtime
));

312 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0è!ğ
	`__fix_to_vœt
(
VSYSCALL_FIRST_PAGE
)));

313 
	`BUG_ON
((è&
vg‘ıu
 !ğ
	`VSYSCALL_ADDR
(
__NR_vg‘ıu
));

314 #ifdeà
CONFIG_SYSCTL


315 
	`»gi¡”_sysùl_bË
(
k”Ãl_roÙ_bË2
);

317 
	`Ú_—ch_ıu
(
ıu_vsysÿÎ_š™
, 
NULL
, 1);

318 
	`hÙıu_nÙif›r
(
ıu_vsysÿÎ_nÙif›r
, 0);

320 
	}
}

322 
__š™ÿÎ
(
vsysÿÎ_š™
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<lšux/moduË.h
>

5 
	~<lšux/smp.h
>

7 
	~<Ãt/checksum.h
>

9 
	~<asm/´oûssÜ.h
>

10 
	~<asm/pgbË.h
>

11 
	~<asm/uacûss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/á¿û.h
>

15 #ifdeà
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcouÁ
);

20 
EXPORT_SYMBOL
(
k”Ãl_th»ad
);

22 
EXPORT_SYMBOL
(
__g‘_u£r_1
);

23 
EXPORT_SYMBOL
(
__g‘_u£r_2
);

24 
EXPORT_SYMBOL
(
__g‘_u£r_4
);

25 
EXPORT_SYMBOL
(
__g‘_u£r_8
);

26 
EXPORT_SYMBOL
(
__put_u£r_1
);

27 
EXPORT_SYMBOL
(
__put_u£r_2
);

28 
EXPORT_SYMBOL
(
__put_u£r_4
);

29 
EXPORT_SYMBOL
(
__put_u£r_8
);

31 
EXPORT_SYMBOL
(
cİy_u£r_g’”ic
);

32 
EXPORT_SYMBOL
(
__cİy_u£r_noÿche
);

33 
EXPORT_SYMBOL
(
cİy_äom_u£r
);

34 
EXPORT_SYMBOL
(
cİy_to_u£r
);

35 
EXPORT_SYMBOL
(
__cİy_äom_u£r_š©omic
);

37 
EXPORT_SYMBOL
(
cİy_·ge
);

38 
EXPORT_SYMBOL
(
ş—r_·ge
);

40 
EXPORT_SYMBOL
(
csum_·¹Ÿl
);

46 #undeà
memıy


47 #undeà
mem£t


48 #undeà
memmove


50 *
mem£t
(*, , 
__k”Ãl_size_t
);

51 *
memıy
(*, cÚ¡ *, 
__k”Ãl_size_t
);

52 *
__memıy
(*, cÚ¡ *, 
__k”Ãl_size_t
);

54 
EXPORT_SYMBOL
(
mem£t
);

55 
EXPORT_SYMBOL
(
memıy
);

56 
EXPORT_SYMBOL
(
__memıy
);

58 
EXPORT_SYMBOL
(
em±y_z”o_·ge
);

59 
EXPORT_SYMBOL
(
š™_Ëv–4_pgt
);

60 
EXPORT_SYMBOL
(
lßd_gs_šdex
);

	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<lšux/boÙmem.h
>

7 
	~<lšux/com·t.h
>

8 
	~<asm/i387.h
>

9 #ifdeà
CONFIG_IA32_EMULATION


10 
	~<asm/sigcÚ‹xt32.h
>

12 
	~<asm/xü.h
>

17 
u64
 
	gpútxt_mask
;

19 
_åx_sw_by‹s
 
	gfx_sw_»£rved
;

20 #ifdeà
CONFIG_IA32_EMULATION


21 
_åx_sw_by‹s
 
	gfx_sw_»£rved_Ÿ32
;

28 
	$check_fÜ_x¡©e
(
i387_fx§ve_¡ruù
 
__u£r
 *
buf
,

29 
__u£r
 *
å¡©e
,

30 
_åx_sw_by‹s
 *
fx_sw_u£r
)

32 
mš_x¡©e_size
 = (
i387_fx§ve_¡ruù
) +

33 (
x§ve_hdr_¡ruù
);

34 
magic2
;

35 
”r
;

37 
”r
 = 
	`__cİy_äom_u£r
(
fx_sw_u£r
, &
buf
->
sw_»£rved
[0],

38 (
_åx_sw_by‹s
));

40 ià(
”r
)

41  
”r
;

46 ià(
fx_sw_u£r
->
magic1
 !ğ
FP_XSTATE_MAGIC1
)

52 ià(
fx_sw_u£r
->
x¡©e_size
 < 
mš_x¡©e_size
 ||

53 
fx_sw_u£r
->
x¡©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x¡©e_size
 > fx_sw_u£r->
ex‹nded_size
)

57 
”r
 = 
	`__g‘_u£r
(
magic2
, (
__u32
 *è(((*)
å¡©e
) +

58 
fx_sw_u£r
->
ex‹nded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 ià(
”r
 || 
magic2
 !ğ
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifdeà
CONFIG_X86_64


77 
	$§ve_i387_x¡©e
(
__u£r
 *
buf
)

79 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

80 
”r
 = 0;

82 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x¡©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x¡©e_size
 < 
x¡©e_size
);

87 ià(()
buf
 % 64)

88 
	`´štk
("§ve_i387_x¡©e: bad fp¡©%p\n", 
buf
);

90 ià(!
	`u£d_m©h
())

93 ià(
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 & 
TS_USEDFPU
) {

98 
”r
 = 
	`__ş—r_u£r
(
buf
, 
sig_x¡©e_size
);

99 ià(
”r
)

100  
”r
;

102 ià(
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 & 
TS_XSAVE
)

103 
”r
 = 
	`x§ve_u£r
(
buf
);

105 
”r
 = 
	`fx§ve_u£r
(
buf
);

107 ià(
”r
)

108  
”r
;

109 
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 &ğ~
TS_USEDFPU
;

110 
	`¡ts
();

112 ià(
	`__cİy_to_u£r
(
buf
, &
tsk
->
th»ad
.
x¡©e
->
fx§ve
,

113 
x¡©e_size
))

117 
	`ş—r_u£d_m©h
();

119 ià(
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 & 
TS_XSAVE
) {

120 
_å¡©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x¡©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x¡©e_bv
;

124 
”r
 = 
	`__cİy_to_u£r
(&
fx
->
sw_»£rved
, &
fx_sw_»£rved
,

125 (
_åx_sw_by‹s
));

127 
”r
 |ğ
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *è(
buf
 + 
sig_x¡©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
”r
 |ğ
	`__g‘_u£r
(
x¡©e_bv
, &
x
->
x¡©e_hdr
.xstate_bv);

149 
x¡©e_bv
 |ğ
XSTATE_FPSSE
;

151 
”r
 |ğ
	`__put_u£r
(
x¡©e_bv
, &
x
->
x¡©e_hdr
.xstate_bv);

153 ià(
”r
)

154  
”r
;

158 
	}
}

164 
	$»¡Üe_u£r_x¡©e
(
__u£r
 *
buf
)

166 
_åx_sw_by‹s
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
”r
;

170 ià((()
buf
 % 64) ||

171 
	`check_fÜ_x¡©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_Úly
;

174 
mask
 = 
fx_sw_u£r
.
x¡©e_bv
;

179 
”r
 = 
	`x»¡Üe_u£r
(
buf
, 
mask
);

180 ià(
”r
)

181  
”r
;

186 
mask
 = 
pútxt_mask
 & ~mask;

188 
	`xr¡Ü_¡©e
(
š™_x¡©e_buf
, 
mask
);

192 
fx_Úly
:

198 
	`xr¡Ü_¡©e
(
š™_x¡©e_buf
, 
pútxt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr¡Ü_checkšg
((
__fÜû
 
i387_fx§ve_¡ruù
 *)
buf
);

200 
	}
}

205 
	$»¡Üe_i387_x¡©e
(
__u£r
 *
buf
)

207 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

208 
”r
 = 0;

210 ià(!
buf
) {

211 ià(
	`u£d_m©h
())

212 
ş—r
;

215 ià(!
	`acûss_ok
(
VERIFY_READ
, 
buf
, 
sig_x¡©e_size
))

216  -
EACCES
;

218 ià(!
	`u£d_m©h
()) {

219 
”r
 = 
	`š™_åu
(
tsk
);

220 ià(
”r
)

221  
”r
;

224 ià(!(
	`sk_th»ad_šfo
(
cu¼’t
)->
¡©us
 & 
TS_USEDFPU
)) {

225 
	`şts
();

226 
	`sk_th»ad_šfo
(
cu¼’t
)->
¡©us
 |ğ
TS_USEDFPU
;

228 ià(
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 & 
TS_XSAVE
)

229 
”r
 = 
	`»¡Üe_u£r_x¡©e
(
buf
);

231 
”r
 = 
	`fxr¡Ü_checkšg
((
__fÜû
 
i387_fx§ve_¡ruù
 *)

232 
buf
);

233 ià(
	`uÆik–y
(
”r
)) {

238 
ş—r
:

239 
	`ş—r_åu
(
tsk
);

240 
	`ş—r_u£d_m©h
();

242  
”r
;

243 
	}
}

253 
	$´•¬e_fx_sw_äame
()

255 
size_ex‹nded
 = (
x¡©e_size
 - (
i387_fx§ve_¡ruù
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x¡©e_size
 = (
_å¡©e
è+ 
size_ex‹nded
;

260 #ifdeà
CONFIG_IA32_EMULATION


261 
sig_x¡©e_Ÿ32_size
 = (
_å¡©e_Ÿ32
è+ 
size_ex‹nded
;

264 
	`mem£t
(&
fx_sw_»£rved
, 0, (fx_sw_reserved));

266 
fx_sw_»£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_»£rved
.
ex‹nded_size
 = 
sig_x¡©e_size
;

268 
fx_sw_»£rved
.
x¡©e_bv
 = 
pútxt_mask
;

269 
fx_sw_»£rved
.
x¡©e_size
 = xstate_size;

270 #ifdeà
CONFIG_IA32_EMULATION


271 
	`memıy
(&
fx_sw_»£rved_Ÿ32
, &
fx_sw_»£rved
,

272 (
_åx_sw_by‹s
));

273 
fx_sw_»£rved_Ÿ32
.
ex‹nded_size
 = 
sig_x¡©e_Ÿ32_size
;

275 
	}
}

280 
x§ve_¡ruù
 *
	gš™_x¡©e_buf
;

282 #ifdeà
CONFIG_X86_64


283 
	gsig_x¡©e_size
 = (
_å¡©e
);

289 
__ıuš™
 
	$x§ve_š™
()

291 ià(!
ıu_has_x§ve
)

294 
	`£t_š_ü4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
pútxt_mask
);

301 
	}
}

306 
__š™
 
	$£tup_x¡©e_š™
()

308 
š™_x¡©e_buf
 = 
	`®loc_boÙmem
(
x¡©e_size
);

309 
š™_x¡©e_buf
->
i387
.
mxc¤
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__»f
 
	$x§ve_útxt_š™
()

317 
—x
, 
ebx
, 
ecx
, 
edx
;

319 
	`ıuid_couÁ
(0xd, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

320 
pútxt_mask
 = 
—x
 + ((
u64
)
edx
 << 32);

322 ià((
pútxt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`´štk
(
KERN_ERR
 "FP/SSE‚ot shown under xsave features 0x%llx\n",

324 
pútxt_mask
);

325 
	`BUG
();

331 
pútxt_mask
 =…útxt_mask & 
XCNTXT_MASK
;

332 
	`x§ve_š™
();

337 
	`ıuid_couÁ
(0xd, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

338 
x¡©e_size
 = 
ebx
;

340 
	`´•¬e_fx_sw_äame
();

342 
	`£tup_x¡©e_š™
();

344 
	`´štk
(
KERN_INFO
 "xsave/xrstor:ƒnabled xstate_bv 0x%llx, "

346 
pútxt_mask
, 
x¡©e_size
);

347 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/¥šlock.h
>

3 
	~<asm/uacûss.h
>

6 
	$fixup_exû±iÚ
(
±_»gs
 *
»gs
)

8 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

10 #ifdeà
CONFIG_PNPBIOS


11 ià(
	`uÆik–y
(
	`SEGMENT_IS_PNP_CODE
(
»gs
->
cs
))) {

12 
u32
 
²p_bios_çuÉ_e
, 
²p_bios_çuÉ_e¥
;

13 
u32
 
²p_bios_is_u‰”_ü­
;

14 
²p_bios_is_u‰”_ü­
 = 1;

15 
	`´štk
(
KERN_CRIT
 "PNPBIOS fault..‡ttempting„ecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
²p_bios_çuÉ_e¥
), "g" (
²p_bios_çuÉ_e
));

20 
	`·nic
("do_trap: can't hithis");

24 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->

);

25 ià(
fixup
) {

27 ià(
fixup
->fixup < 16) {

28 
	`cu¼’t_th»ad_šfo
()->
uacûss_”r
 = -
EFAULT
;

29 
»gs
->

 +ğ
fixup
->fixup;

32 
»gs
->

 = 
fixup
->fixup;

37 
	}
}

39 #ifdeà
CONFIG_X86_64


44 cÚ¡ 
exû±iÚ_bË_’Œy
 *

45 
	$£¬ch_exbË
(cÚ¡ 
exû±iÚ_bË_’Œy
 *
fœ¡
,

46 cÚ¡ 
exû±iÚ_bË_’Œy
 *
Ï¡
,

47 
v®ue
)

50 ià((
v®ue
 >> 32) == 0)

51 
v®ue
 |= 0xffffffffUL << 32;

53 
fœ¡
 <ğ
Ï¡
) {

54 cÚ¡ 
exû±iÚ_bË_’Œy
 *
mid
;

55 
diff
;

57 
mid
 = (
Ï¡
 - 
fœ¡
) / 2 + first;

58 
diff
 = 
mid
->
š¢
 - 
v®ue
;

59 ià(
diff
 == 0)

60  
mid
;

61 ià(
diff
 < 0)

62 
fœ¡
 = 
mid
+1;

64 
Ï¡
 = 
mid
-1;

66  
NULL
;

67 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/mmiÙ¿û.h
>

8 
	~<lšux/boÙmem.h
>

9 
	~<lšux/comp”.h
>

10 
	~<lšux/highmem.h
>

11 
	~<lšux/k´obes.h
>

12 
	~<lšux/uacûss.h
>

13 
	~<lšux/vm®loc.h
>

14 
	~<lšux/vt_k”n.h
>

15 
	~<lšux/sigÇl.h
>

16 
	~<lšux/k”Ãl.h
>

17 
	~<lšux/±¿û.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/moduË.h
>

20 
	~<lšux/kdebug.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/magic.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/š™.h
>

26 
	~<lšux/mmª.h
>

27 
	~<lšux/‰y.h
>

28 
	~<lšux/smp.h
>

29 
	~<lšux/mm.h
>

31 
	~<asm-g’”ic/£ùiÚs.h
>

33 
	~<asm/bæush.h
>

34 
	~<asm/pg®loc.h
>

35 
	~<asm/£gm’t.h
>

36 
	~<asm/sy¡em.h
>

37 
	~<asm/´Ùo.h
>

38 
	~<asm/Œ­s.h
>

39 
	~<asm/desc.h
>

50 
	ex86_pf_”rÜ_code
 {

52 
	mPF_PROT
 = 1 << 0,

53 
	mPF_WRITE
 = 1 << 1,

54 
	mPF_USER
 = 1 << 2,

55 
	mPF_RSVD
 = 1 << 3,

56 
	mPF_INSTR
 = 1 << 4,

63 
šlše
 
	$kmmio_çuÉ
(
±_»gs
 *
»gs
, 
addr
)

65 ià(
	`uÆik–y
(
	`is_kmmio_aùive
()))

66 ià(
	`kmmio_hªdËr
(
»gs
, 
addr
) == 1)

69 
	}
}

71 
šlše
 
	$nÙify_·ge_çuÉ
(
±_»gs
 *
»gs
)

73 
»t
 = 0;

76 ià(
	`k´obes_but_š
(è&& !
	`u£r_mode_vm
(
»gs
)) {

77 
	`´“m±_di§bË
();

78 ià(
	`k´obe_ruÂšg
(è&& 
	`k´obe_çuÉ_hªdËr
(
»gs
, 14))

79 
»t
 = 1;

80 
	`´“m±_’abË
();

83  
»t
;

84 
	}
}

101 
šlše
 

102 
	$check_´eãtch_İcode
(
±_»gs
 *
»gs
, *
š¡r
,

103 
İcode
, *
´eãtch
)

105 
š¡r_hi
 = 
İcode
 & 0xf0;

106 
š¡r_lo
 = 
İcode
 & 0x0f;

108 
š¡r_hi
) {

117  ((
š¡r_lo
 & 7) == 0x6);

118 #ifdeà
CONFIG_X86_64


127  (!
	`u£r_mode
(
»gs
)è|| (»gs->
cs
 =ğ
__USER_CS
);

131  (
š¡r_lo
 & 0xC) == 0x4;

134  !
š¡r_lo
 || (instr_lo>>1) == 1;

137 ià(
	`´obe_k”Ãl_add»ss
(
š¡r
, 
İcode
))

140 *
´eãtch
 = (
š¡r_lo
 == 0xF) &&

141 (
İcode
 == 0x0D || opcode == 0x18);

146 
	}
}

149 
	$is_´eãtch
(
±_»gs
 *
»gs
, 
”rÜ_code
, 
addr
)

151 *
max_š¡r
;

152 *
š¡r
;

153 
´eãtch
 = 0;

159 ià(
”rÜ_code
 & 
PF_INSTR
)

162 
š¡r
 = (*)
	`cÚv”t__to_lš—r
(
cu¼’t
, 
»gs
);

163 
max_š¡r
 = 
š¡r
 + 15;

165 ià(
	`u£r_mode
(
»gs
è&& 
š¡r
 >ğ(*)
TASK_SIZE
)

168 
š¡r
 < 
max_š¡r
) {

169 
İcode
;

171 ià(
	`´obe_k”Ãl_add»ss
(
š¡r
, 
İcode
))

174 
š¡r
++;

176 ià(!
	`check_´eãtch_İcode
(
»gs
, 
š¡r
, 
İcode
, &
´eãtch
))

179  
´eãtch
;

180 
	}
}

183 
	$fÜû_sig_šfo_çuÉ
(
si_signo
, 
si_code
, 
add»ss
,

184 
sk_¡ruù
 *
tsk
)

186 
sigšfo_t
 
šfo
;

188 
šfo
.
si_signo
 = si_signo;

189 
šfo
.
si_”ºo
 = 0;

190 
šfo
.
si_code
 = si_code;

191 
šfo
.
si_addr
 = (
__u£r
 *)
add»ss
;

193 
	`fÜû_sig_šfo
(
si_signo
, &
šfo
, 
tsk
);

194 
	}
}

196 
DEFINE_SPINLOCK
(
pgd_lock
);

197 
LIST_HEAD
(
pgd_li¡
);

199 #ifdeà
CONFIG_X86_32


200 
šlše
 
pmd_t
 *
	$vm®loc_sync_Úe
(
pgd_t
 *
pgd
, 
add»ss
)

202 
šdex
 = 
	`pgd_šdex
(
add»ss
);

203 
pgd_t
 *
pgd_k
;

204 
pud_t
 *
pud
, *
pud_k
;

205 
pmd_t
 *
pmd
, *
pmd_k
;

207 
pgd
 +ğ
šdex
;

208 
pgd_k
 = 
š™_mm
.
pgd
 + 
šdex
;

210 ià(!
	`pgd_´e£Á
(*
pgd_k
))

211  
NULL
;

218 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

219 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
add»ss
);

220 ià(!
	`pud_´e£Á
(*
pud_k
))

221  
NULL
;

223 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

224 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
add»ss
);

225 ià(!
	`pmd_´e£Á
(*
pmd_k
))

226  
NULL
;

228 ià(!
	`pmd_´e£Á
(*
pmd
)) {

229 
	`£t_pmd
(
pmd
, *
pmd_k
);

230 
	`¬ch_æush_Ïzy_mmu_mode
();

232 
	`BUG_ON
(
	`pmd_·ge
(*
pmd
è!ğpmd_·ge(*
pmd_k
));

235  
pmd_k
;

236 
	}
}

238 
	$vm®loc_sync_®l
()

240 
add»ss
;

242 ià(
SHARED_KERNEL_PMD
)

245 
add»ss
 = 
VMALLOC_START
 & 
PMD_MASK
;

246 
add»ss
 >ğ
TASK_SIZE
 &&‡dd»s < 
FIXADDR_TOP
;

247 
add»ss
 +ğ
PMD_SIZE
) {

249 
æags
;

250 
·ge
 *page;

252 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

253 
	`li¡_fÜ_—ch_’Œy
(
·ge
, &
pgd_li¡
, 
Ìu
) {

254 ià(!
	`vm®loc_sync_Úe
(
	`·ge_add»ss
(
·ge
), 
add»ss
))

257 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

259 
	}
}

266 
nošlše
 
	$vm®loc_çuÉ
(
add»ss
)

268 
pgd_·ddr
;

269 
pmd_t
 *
pmd_k
;

270 
±e_t
 *
±e_k
;

273 ià(!(
add»ss
 >ğ
VMALLOC_START
 &&‡dd»s < 
VMALLOC_END
))

283 
pgd_·ddr
 = 
	`»ad_ü3
();

284 
pmd_k
 = 
	`vm®loc_sync_Úe
(
	`__va
(
pgd_·ddr
), 
add»ss
);

285 ià(!
pmd_k
)

288 
±e_k
 = 
	`±e_off£t_k”Ãl
(
pmd_k
, 
add»ss
);

289 ià(!
	`±e_´e£Á
(*
±e_k
))

293 
	}
}

298 
šlše
 

299 
	$check_v8086_mode
(
±_»gs
 *
»gs
, 
add»ss
,

300 
sk_¡ruù
 *
tsk
)

302 
b™
;

304 ià(!
	`v8086_mode
(
»gs
))

307 
b™
 = (
add»ss
 - 0xA0000è>> 
PAGE_SHIFT
;

308 ià(
b™
 < 32)

309 
tsk
->
th»ad
.
sü“n_b™m­
 |ğ1 << 
b™
;

310 
	}
}

312 
	$dump_·g‘abË
(
add»ss
)

314 
	`__ty³of__
(
	`±e_v®
(
	`__±e
(0))è
·ge
;

316 
·ge
 = 
	`»ad_ü3
();

317 
·ge
 = ((
	`__ty³of__
Õageè*è
	`__va
Õage))[
add»ss
 >> 
PGDIR_SHIFT
];

319 #ifdeà
CONFIG_X86_PAE


320 
	`´štk
("*pd± = %016Lx ", 
·ge
);

321 ià((
·ge
 >> 
PAGE_SHIFT
è< 
max_low_pâ


322 && 
·ge
 & 
_PAGE_PRESENT
) {

323 
·ge
 &ğ
PAGE_MASK
;

324 
·ge
 = ((
	`__ty³of__
Õageè*è
	`__va
Õage))[(
add»ss
 >> 
PMD_SHIFT
)

325 & (
PTRS_PER_PMD
 - 1)];

326 
	`´štk
(
KERN_CONT
 "*pdğ%016Lx ", 
·ge
);

327 
·ge
 &ğ~
_PAGE_NX
;

330 
	`´štk
("*pdğ%08lx ", 
·ge
);

339 ià((
·ge
 >> 
PAGE_SHIFT
è< 
max_low_pâ


340 && (
·ge
 & 
_PAGE_PRESENT
)

341 && !(
·ge
 & 
_PAGE_PSE
)) {

343 
·ge
 &ğ
PAGE_MASK
;

344 
·ge
 = ((
	`__ty³of__
Õageè*è
	`__va
Õage))[(
add»ss
 >> 
PAGE_SHIFT
)

345 & (
PTRS_PER_PTE
 - 1)];

346 
	`´štk
("*±ğ%0*Lx ", (
·ge
)*2, (
u64
)page);

349 
	`´štk
("\n");

350 
	}
}

354 
	$vm®loc_sync_®l
()

356 
add»ss
;

358 
add»ss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;‡dd»s <ğ
VMALLOC_END
;

359 
add»ss
 +ğ
PGDIR_SIZE
) {

361 cÚ¡ 
pgd_t
 *
pgd_»f
 = 
	`pgd_off£t_k
(
add»ss
);

362 
æags
;

363 
·ge
 *page;

365 ià(
	`pgd_nÚe
(*
pgd_»f
))

368 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

369 
	`li¡_fÜ_—ch_’Œy
(
·ge
, &
pgd_li¡
, 
Ìu
) {

370 
pgd_t
 *
pgd
;

371 
pgd
 = (
pgd_t
 *)
	`·ge_add»ss
(
·ge
è+ 
	`pgd_šdex
(
add»ss
);

372 ià(
	`pgd_nÚe
(*
pgd
))

373 
	`£t_pgd
(
pgd
, *
pgd_»f
);

375 
	`BUG_ON
(
	`pgd_·ge_vaddr
(*
pgd
è!ğpgd_·ge_vaddr(*
pgd_»f
));

377 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

379 
	}
}

388 
nošlše
 
	$vm®loc_çuÉ
(
add»ss
)

390 
pgd_t
 *
pgd
, *
pgd_»f
;

391 
pud_t
 *
pud
, *
pud_»f
;

392 
pmd_t
 *
pmd
, *
pmd_»f
;

393 
±e_t
 *
±e
, *
±e_»f
;

396 ià(!(
add»ss
 >ğ
VMALLOC_START
 &&‡dd»s < 
VMALLOC_END
))

404 
pgd
 = 
	`pgd_off£t
(
cu¼’t
->
aùive_mm
, 
add»ss
);

405 
pgd_»f
 = 
	`pgd_off£t_k
(
add»ss
);

406 ià(
	`pgd_nÚe
(*
pgd_»f
))

409 ià(
	`pgd_nÚe
(*
pgd
))

410 
	`£t_pgd
(
pgd
, *
pgd_»f
);

412 
	`BUG_ON
(
	`pgd_·ge_vaddr
(*
pgd
è!ğpgd_·ge_vaddr(*
pgd_»f
));

419 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

420 
pud_»f
 = 
	`pud_off£t
(
pgd_»f
, 
add»ss
);

421 ià(
	`pud_nÚe
(*
pud_»f
))

424 ià(
	`pud_nÚe
(*
pud
è|| 
	`pud_·ge_vaddr
(*pudè!ğpud_·ge_vaddr(*
pud_»f
))

425 
	`BUG
();

427 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

428 
pmd_»f
 = 
	`pmd_off£t
(
pud_»f
, 
add»ss
);

429 ià(
	`pmd_nÚe
(*
pmd_»f
))

432 ià(
	`pmd_nÚe
(*
pmd
è|| 
	`pmd_·ge
(*pmdè!ğpmd_·ge(*
pmd_»f
))

433 
	`BUG
();

435 
±e_»f
 = 
	`±e_off£t_k”Ãl
(
pmd_»f
, 
add»ss
);

436 ià(!
	`±e_´e£Á
(*
±e_»f
))

439 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

446 ià(!
	`±e_´e£Á
(*
±e
è|| 
	`±e_pâ
(*±eè!ğ±e_pâ(*
±e_»f
))

447 
	`BUG
();

450 
	}
}

452 cÚ¡ 
	g”¿93_w¬nšg
[] =

453 
KERN_ERR
 "******* Your BIOS seemso‚ot contain‡ fix for K8ƒrrata #93\n"

454 
KERN_ERR
 "******* Working‡round it, but it may cause SEGVs or burn…ower.\n"

455 
KERN_ERR
 "******* Please consider‡ BIOS update.\n"

456 
KERN_ERR
 "******* Disabling USB†egacy inhe BIOS may‡lso help.\n";

461 
šlše
 

462 
	$check_v8086_mode
(
±_»gs
 *
»gs
, 
add»ss
,

463 
sk_¡ruù
 *
tsk
)

465 
	}
}

467 
	$bad_add»ss
(*
p
)

469 
dummy
;

471  
	`´obe_k”Ãl_add»ss
((*)
p
, 
dummy
);

472 
	}
}

474 
	$dump_·g‘abË
(
add»ss
)

476 
pgd_t
 *
pgd
;

477 
pud_t
 *
pud
;

478 
pmd_t
 *
pmd
;

479 
±e_t
 *
±e
;

481 
pgd
 = (
pgd_t
 *)
	`»ad_ü3
();

483 
pgd
 = 
	`__va
((ígd & 
PHYSICAL_PAGE_MASK
);

485 
pgd
 +ğ
	`pgd_šdex
(
add»ss
);

486 ià(
	`bad_add»ss
(
pgd
))

487 
bad
;

489 
	`´štk
("PGD %lx ", 
	`pgd_v®
(*
pgd
));

491 ià(!
	`pgd_´e£Á
(*
pgd
))

492 
out
;

494 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

495 ià(
	`bad_add»ss
(
pud
))

496 
bad
;

498 
	`´štk
("PUD %lx ", 
	`pud_v®
(*
pud
));

499 ià(!
	`pud_´e£Á
(*
pud
è|| 
	`pud_Ïrge
(*pud))

500 
out
;

502 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

503 ià(
	`bad_add»ss
(
pmd
))

504 
bad
;

506 
	`´štk
("PMD %lx ", 
	`pmd_v®
(*
pmd
));

507 ià(!
	`pmd_´e£Á
(*
pmd
è|| 
	`pmd_Ïrge
(*pmd))

508 
out
;

510 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

511 ià(
	`bad_add»ss
(
±e
))

512 
bad
;

514 
	`´štk
("PTE %lx", 
	`±e_v®
(*
±e
));

515 
out
:

516 
	`´štk
("\n");

518 
bad
:

519 
	`´štk
("BAD\n");

520 
	}
}

538 
	$is_”¿93
(
±_»gs
 *
»gs
, 
add»ss
)

540 #ifdeà
CONFIG_X86_64


541 
Úû
;

543 ià(
add»ss
 !ğ
»gs
->

)

546 ià((
add»ss
 >> 32) != 0)

549 
add»ss
 |= 0xffffffffUL << 32;

550 ià((
add»ss
 >ğ(
u64
)
_¡ext
 &&‡dd»s <ğ(u64)
_‘ext
) ||

551 (
add»ss
 >ğ
MODULES_VADDR
 &&‡dd»s <ğ
MODULES_END
)) {

552 ià(!
Úû
) {

553 
	`´štk
(
”¿93_w¬nšg
);

554 
Úû
 = 1;

556 
»gs
->

 = 
add»ss
;

561 
	}
}

571 
	$is_”¿100
(
±_»gs
 *
»gs
, 
add»ss
)

573 #ifdeà
CONFIG_X86_64


574 ià((
»gs
->
cs
 =ğ
__USER32_CS
 || (»gs->c & (1<<2))è&& (
add»ss
 >> 32))

578 
	}
}

580 
	$is_f00f_bug
(
±_»gs
 *
»gs
, 
add»ss
)

582 #ifdeà
CONFIG_X86_F00F_BUG


583 
Ä
;

588 ià(
boÙ_ıu_d©a
.
f00f_bug
) {

589 
Ä
 = (
add»ss
 - 
idt_desü
.address) >> 3;

591 ià(
Ä
 == 6) {

592 
	`do_šv®id_İ
(
»gs
, 0);

598 
	}
}

600 cÚ¡ 
	gnx_w¬nšg
[] = 
KERN_CRIT


604 
	$show_çuÉ_oİs
(
±_»gs
 *
»gs
, 
”rÜ_code
,

605 
add»ss
)

607 ià(!
	`oİs_may_´št
())

610 ià(
”rÜ_code
 & 
PF_INSTR
) {

611 
Ëv–
;

613 
±e_t
 *
±e
 = 
	`lookup_add»ss
(
add»ss
, &
Ëv–
);

615 ià(
±e
 && 
	`±e_´e£Á
(*±eè&& !
	`±e_exec
(*pte))

616 
	`´štk
(
nx_w¬nšg
, 
	`cu¼’t_uid
());

619 
	`´štk
(
KERN_ALERT
 "BUG: unableo handle kernel ");

620 ià(
add»ss
 < 
PAGE_SIZE
)

621 
	`´štk
(
KERN_CONT
 "NULL…ointer dereference");

623 
	`´štk
(
KERN_CONT
 "paging„equest");

625 
	`´štk
(
KERN_CONT
 "‡ˆ%p\n", (*è
add»ss
);

626 
	`´štk
(
KERN_ALERT
 "IP:");

627 
	`´štk_add»ss
(
»gs
->

, 1);

629 
	`dump_·g‘abË
(
add»ss
);

630 
	}
}

632 
nošlše
 

633 
	$pgbË_bad
(
±_»gs
 *
»gs
, 
”rÜ_code
,

634 
add»ss
)

636 
sk_¡ruù
 *
tsk
;

637 
æags
;

638 
sig
;

640 
æags
 = 
	`oİs_begš
();

641 
tsk
 = 
cu¼’t
;

642 
sig
 = 
SIGKILL
;

644 
	`´štk
(
KERN_ALERT
 "%s: Corrupted…ageable‡t‡ddress %lx\n",

645 
tsk
->
comm
, 
add»ss
);

646 
	`dump_·g‘abË
(
add»ss
);

648 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

649 
tsk
->
th»ad
.
Œ­_no
 = 14;

650 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

652 ià(
	`__d›
("Bad…ag‘abË", 
»gs
, 
”rÜ_code
))

653 
sig
 = 0;

655 
	`oİs_’d
(
æags
, 
»gs
, 
sig
);

656 
	}
}

658 
nošlše
 

659 
	$no_cÚ‹xt
(
±_»gs
 *
»gs
, 
”rÜ_code
,

660 
add»ss
)

662 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

663 *
¡ack’d
;

664 
æags
;

665 
sig
;

668 ià(
	`fixup_exû±iÚ
(
»gs
))

682 ià(
	`is_´eãtch
(
»gs
, 
”rÜ_code
, 
add»ss
))

685 ià(
	`is_”¿93
(
»gs
, 
add»ss
))

692 
æags
 = 
	`oİs_begš
();

694 
	`show_çuÉ_oİs
(
»gs
, 
”rÜ_code
, 
add»ss
);

696 
¡ack’d
 = 
	`’d_of_¡ack
(
tsk
);

697 ià(*
¡ack’d
 !ğ
STACK_END_MAGIC
)

698 
	`´štk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

700 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

701 
tsk
->
th»ad
.
Œ­_no
 = 14;

702 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

704 
sig
 = 
SIGKILL
;

705 ià(
	`__d›
("Oİs", 
»gs
, 
”rÜ_code
))

706 
sig
 = 0;

709 
	`´štk
(
KERN_EMERG
 "CR2: %016lx\n", 
add»ss
);

711 
	`oİs_’d
(
æags
, 
»gs
, 
sig
);

712 
	}
}

718 
šlše
 

719 
	$show_sigÇl_msg
(
±_»gs
 *
»gs
, 
”rÜ_code
,

720 
add»ss
, 
sk_¡ruù
 *
tsk
)

722 ià(!
	`unhªdËd_sigÇl
(
tsk
, 
SIGSEGV
))

725 ià(!
	`´štk_¿‹lim™
())

728 
	`´štk
(
KERN_CONT
 "%s%s[%d]: segfault‡t %lx ip %p sp %pƒrror %lx",

729 
	`sk_pid_Ä
(
tsk
è> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

730 
tsk
->
comm
, 
	`sk_pid_Ä
Ñsk), 
add»ss
,

731 (*)
»gs
->

, (*ìegs->
¥
, 
”rÜ_code
);

733 
	`´št_vma_addr
(
KERN_CONT
 " iÀ", 
»gs
->

);

735 
	`´štk
(
KERN_CONT
 "\n");

736 
	}
}

739 
	$__bad_¬—_no£m­hÜe
(
±_»gs
 *
»gs
, 
”rÜ_code
,

740 
add»ss
, 
si_code
)

742 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

745 ià(
”rÜ_code
 & 
PF_USER
) {

749 
	`loÿl_œq_’abË
();

755 ià(
	`is_´eãtch
(
»gs
, 
”rÜ_code
, 
add»ss
))

758 ià(
	`is_”¿100
(
»gs
, 
add»ss
))

761 ià(
	`uÆik–y
(
show_unhªdËd_sigÇls
))

762 
	`show_sigÇl_msg
(
»gs
, 
”rÜ_code
, 
add»ss
, 
tsk
);

765 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

766 
tsk
->
th»ad
.
”rÜ_code
 =ƒ¼Ü_cod| (
add»ss
 >ğ
TASK_SIZE
);

767 
tsk
->
th»ad
.
Œ­_no
 = 14;

769 
	`fÜû_sig_šfo_çuÉ
(
SIGSEGV
, 
si_code
, 
add»ss
, 
tsk
);

774 ià(
	`is_f00f_bug
(
»gs
, 
add»ss
))

777 
	`no_cÚ‹xt
(
»gs
, 
”rÜ_code
, 
add»ss
);

778 
	}
}

780 
nošlše
 

781 
	$bad_¬—_no£m­hÜe
(
±_»gs
 *
»gs
, 
”rÜ_code
,

782 
add»ss
)

784 
	`__bad_¬—_no£m­hÜe
(
»gs
, 
”rÜ_code
, 
add»ss
, 
SEGV_MAPERR
);

785 
	}
}

788 
	$__bad_¬—
(
±_»gs
 *
»gs
, 
”rÜ_code
,

789 
add»ss
, 
si_code
)

791 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

797 
	`up_»ad
(&
mm
->
mm­_£m
);

799 
	`__bad_¬—_no£m­hÜe
(
»gs
, 
”rÜ_code
, 
add»ss
, 
si_code
);

800 
	}
}

802 
nošlše
 

803 
	$bad_¬—
(
±_»gs
 *
»gs
, 
”rÜ_code
, 
add»ss
)

805 
	`__bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
, 
SEGV_MAPERR
);

806 
	}
}

808 
nošlše
 

809 
	$bad_¬—_acûss_”rÜ
(
±_»gs
 *
»gs
, 
”rÜ_code
,

810 
add»ss
)

812 
	`__bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
, 
SEGV_ACCERR
);

813 
	}
}

817 
	$out_of_memÜy
(
±_»gs
 *
»gs
, 
”rÜ_code
,

818 
add»ss
)

824 
	`up_»ad
(&
cu¼’t
->
mm
->
mm­_£m
);

826 
	`·geçuÉ_out_of_memÜy
();

827 
	}
}

830 
	$do_sigbus
(
±_»gs
 *
»gs
, 
”rÜ_code
, 
add»ss
)

832 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

833 
mm_¡ruù
 *
mm
 = 
tsk
->mm;

835 
	`up_»ad
(&
mm
->
mm­_£m
);

838 ià(!(
”rÜ_code
 & 
PF_USER
))

839 
	`no_cÚ‹xt
(
»gs
, 
”rÜ_code
, 
add»ss
);

842 ià(
	`is_´eãtch
(
»gs
, 
”rÜ_code
, 
add»ss
))

845 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

846 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

847 
tsk
->
th»ad
.
Œ­_no
 = 14;

849 
	`fÜû_sig_šfo_çuÉ
(
SIGBUS
, 
BUS_ADRERR
, 
add»ss
, 
tsk
);

850 
	}
}

852 
nošlše
 

853 
	$mm_çuÉ_”rÜ
(
±_»gs
 *
»gs
, 
”rÜ_code
,

854 
add»ss
, 
çuÉ
)

856 ià(
çuÉ
 & 
VM_FAULT_OOM
) {

857 
	`out_of_memÜy
(
»gs
, 
”rÜ_code
, 
add»ss
);

859 ià(
çuÉ
 & 
VM_FAULT_SIGBUS
)

860 
	`do_sigbus
(
»gs
, 
”rÜ_code
, 
add»ss
);

862 
	`BUG
();

864 
	}
}

866 
	$¥urious_çuÉ_check
(
”rÜ_code
, 
±e_t
 *
±e
)

868 ià((
”rÜ_code
 & 
PF_WRITE
è&& !
	`±e_wr™e
(*
±e
))

871 ià((
”rÜ_code
 & 
PF_INSTR
è&& !
	`±e_exec
(*
±e
))

875 
	}
}

889 
nošlše
 

890 
	$¥urious_çuÉ
(
”rÜ_code
, 
add»ss
)

892 
pgd_t
 *
pgd
;

893 
pud_t
 *
pud
;

894 
pmd_t
 *
pmd
;

895 
±e_t
 *
±e
;

896 
»t
;

899 ià(
”rÜ_code
 & (
PF_USER
 | 
PF_RSVD
))

902 
pgd
 = 
š™_mm
.pgd + 
	`pgd_šdex
(
add»ss
);

903 ià(!
	`pgd_´e£Á
(*
pgd
))

906 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

907 ià(!
	`pud_´e£Á
(*
pud
))

910 ià(
	`pud_Ïrge
(*
pud
))

911  
	`¥urious_çuÉ_check
(
”rÜ_code
, (
±e_t
 *è
pud
);

913 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

914 ià(!
	`pmd_´e£Á
(*
pmd
))

917 ià(
	`pmd_Ïrge
(*
pmd
))

918  
	`¥urious_çuÉ_check
(
”rÜ_code
, (
±e_t
 *è
pmd
);

920 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

921 ià(!
	`±e_´e£Á
(*
±e
))

924 
»t
 = 
	`¥urious_çuÉ_check
(
”rÜ_code
, 
±e
);

925 ià(!
»t
)

932 
»t
 = 
	`¥urious_çuÉ_check
(
”rÜ_code
, (
±e_t
 *è
pmd
);

933 
	`WARN_ONCE
(!
»t
, "PMD has incorrect…ermission bits\n");

935  
»t
;

936 
	}
}

938 
	gshow_unhªdËd_sigÇls
 = 1;

940 
šlše
 

941 
	$acûss_”rÜ
(
”rÜ_code
, 
wr™e
, 
vm_¬—_¡ruù
 *
vma
)

943 ià(
wr™e
) {

945 ià(
	`uÆik–y
(!(
vma
->
vm_æags
 & 
VM_WRITE
)))

951 ià(
	`uÆik–y
(
”rÜ_code
 & 
PF_PROT
))

955 ià(
	`uÆik–y
(!(
vma
->
vm_æags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

959 
	}
}

961 
	$çuÉ_š_k”Ãl_¥aû
(
add»ss
)

963  
add»ss
 >ğ
TASK_SIZE_MAX
;

964 
	}
}

971 
dÙ¿¶škage
 
__k´obes


972 
	$do_·ge_çuÉ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

974 
vm_¬—_¡ruù
 *
vma
;

975 
sk_¡ruù
 *
tsk
;

976 
add»ss
;

977 
mm_¡ruù
 *
mm
;

978 
wr™e
;

979 
çuÉ
;

981 
tsk
 = 
cu¼’t
;

982 
mm
 = 
tsk
->mm;

984 
	`´eãtchw
(&
mm
->
mm­_£m
);

987 
add»ss
 = 
	`»ad_ü2
();

989 ià(
	`uÆik–y
(
	`kmmio_çuÉ
(
»gs
, 
add»ss
)))

1005 ià(
	`uÆik–y
(
	`çuÉ_š_k”Ãl_¥aû
(
add»ss
))) {

1006 ià(!(
”rÜ_code
 & (
PF_RSVD
|
PF_USER
|
PF_PROT
)) &&

1007 
	`vm®loc_çuÉ
(
add»ss
) >= 0)

1011 ià(
	`¥urious_çuÉ
(
”rÜ_code
, 
add»ss
))

1015 ià(
	`nÙify_·ge_çuÉ
(
»gs
))

1021 
	`bad_¬—_no£m­hÜe
(
»gs
, 
”rÜ_code
, 
add»ss
);

1027 ià(
	`uÆik–y
(
	`nÙify_·ge_çuÉ
(
»gs
)))

1036 ià(
	`u£r_mode_vm
(
»gs
)) {

1037 
	`loÿl_œq_’abË
();

1038 
”rÜ_code
 |ğ
PF_USER
;

1040 ià(
»gs
->
æags
 & 
X86_EFLAGS_IF
)

1041 
	`loÿl_œq_’abË
();

1044 ià(
	`uÆik–y
(
”rÜ_code
 & 
PF_RSVD
))

1045 
	`pgbË_bad
(
»gs
, 
”rÜ_code
, 
add»ss
);

1051 ià(
	`uÆik–y
(
	`š_©omic
(è|| !
mm
)) {

1052 
	`bad_¬—_no£m­hÜe
(
»gs
, 
”rÜ_code
, 
add»ss
);

1072 ià(
	`uÆik–y
(!
	`down_»ad_Œylock
(&
mm
->
mm­_£m
))) {

1073 ià((
”rÜ_code
 & 
PF_USER
) == 0 &&

1074 !
	`£¬ch_exû±iÚ_bËs
(
»gs
->

)) {

1075 
	`bad_¬—_no£m­hÜe
(
»gs
, 
”rÜ_code
, 
add»ss
);

1078 
	`down_»ad
(&
mm
->
mm­_£m
);

1085 
	`might_¦“p
();

1088 
vma
 = 
	`fšd_vma
(
mm
, 
add»ss
);

1089 ià(
	`uÆik–y
(!
vma
)) {

1090 
	`bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
);

1093 ià(
	`lik–y
(
vma
->
vm_¡¬t
 <ğ
add»ss
))

1094 
good_¬—
;

1095 ià(
	`uÆik–y
(!(
vma
->
vm_æags
 & 
VM_GROWSDOWN
))) {

1096 
	`bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
);

1099 ià(
”rÜ_code
 & 
PF_USER
) {

1106 ià(
	`uÆik–y
(
add»ss
 + 65536 + 32 * (è< 
»gs
->
¥
)) {

1107 
	`bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
);

1111 ià(
	`uÆik–y
(
	`ex·nd_¡ack
(
vma
, 
add»ss
))) {

1112 
	`bad_¬—
(
»gs
, 
”rÜ_code
, 
add»ss
);

1120 
good_¬—
:

1121 
wr™e
 = 
”rÜ_code
 & 
PF_WRITE
;

1123 ià(
	`uÆik–y
(
	`acûss_”rÜ
(
”rÜ_code
, 
wr™e
, 
vma
))) {

1124 
	`bad_¬—_acûss_”rÜ
(
»gs
, 
”rÜ_code
, 
add»ss
);

1133 
çuÉ
 = 
	`hªdË_mm_çuÉ
(
mm
, 
vma
, 
add»ss
, 
wr™e
);

1135 ià(
	`uÆik–y
(
çuÉ
 & 
VM_FAULT_ERROR
)) {

1136 
	`mm_çuÉ_”rÜ
(
»gs
, 
”rÜ_code
, 
add»ss
, 
çuÉ
);

1140 ià(
çuÉ
 & 
VM_FAULT_MAJOR
)

1141 
tsk
->
maj_æt
++;

1143 
tsk
->
mš_æt
++;

1145 
	`check_v8086_mode
(
»gs
, 
add»ss
, 
tsk
);

1147 
	`up_»ad
(&
mm
->
mm­_£m
);

1148 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/mm.h
>

9 
	~<lšux/vm¡©.h
>

10 
	~<lšux/highmem.h
>

12 
	~<asm/pgbË.h
>

14 
šlše
 
±e_t
 
	$gup_g‘_±e
(
±e_t
 *
±•
)

16 #iâdeà
CONFIG_X86_PAE


17  *
±•
;

51 
±e_t
 
±e
;

53 
»Œy
:

54 
±e
.
±e_low
 = 
±•
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±•
->pte_high;

57 
	`smp_rmb
();

58 ià(
	`uÆik–y
(
±e
.
±e_low
 !ğ
±•
->pte_low))

59 
»Œy
;

61  
±e
;

63 
	}
}

70 
nošlše
 
	$gup_±e_¿nge
(
pmd_t
 
pmd
, 
addr
,

71 
’d
, 
wr™e
, 
·ge
 **
·ges
, *
Ä
)

73 
mask
;

74 
±e_t
 *
±•
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 ià(
wr™e
)

78 
mask
 |ğ
_PAGE_RW
;

80 
±•
 = 
	`±e_off£t_m­
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_g‘_±e
(
±•
);

83 
·ge
 *page;

85 ià((
	`±e_æags
(
±e
è& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm­
(
±•
);

89 
	`VM_BUG_ON
(!
	`pâ_v®id
(
	`±e_pâ
(
±e
)));

90 
·ge
 = 
	`±e_·ge
(
±e
);

91 
	`g‘_·ge
(
·ge
);

92 
·ges
[*
Ä
] = 
·ge
;

93 (*
Ä
)++;

95 } 
±•
++, 
addr
 +ğ
PAGE_SIZE
,‡dd¸!ğ
’d
);

96 
	`±e_unm­
(
±•
 - 1);

99 
	}
}

101 
šlše
 
	$g‘_h—d_·ge_muÉË
(
·ge
 *·ge, 
Ä
)

103 
	`VM_BUG_ON
(
·ge
 !ğ
	`compound_h—d
(page));

104 
	`VM_BUG_ON
(
	`·ge_couÁ
(
·ge
) == 0);

105 
	`©omic_add
(
Ä
, &
·ge
->
_couÁ
);

106 
	}
}

108 
nošlše
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
’d
, 
wr™e
, 
·ge
 **
·ges
, *
Ä
)

111 
mask
;

112 
±e_t
 
±e
 = *Õ‹_ˆ*)&
pmd
;

113 
·ge
 *
h—d
, *page;

114 
»fs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 ià(
wr™e
)

118 
mask
 |ğ
_PAGE_RW
;

119 ià((
	`±e_æags
(
±e
è& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_æags
(
±e
è& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`pâ_v®id
(
	`±e_pâ
(
±e
)));

125 
»fs
 = 0;

126 
h—d
 = 
	`±e_·ge
(
±e
);

127 
·ge
 = 
h—d
 + ((
addr
 & ~
PMD_MASK
è>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_h—d
(
·ge
è!ğ
h—d
);

130 
·ges
[*
Ä
] = 
·ge
;

131 (*
Ä
)++;

132 
·ge
++;

133 
»fs
++;

134 } 
addr
 +ğ
PAGE_SIZE
,‡dd¸!ğ
’d
);

135 
	`g‘_h—d_·ge_muÉË
(
h—d
, 
»fs
);

138 
	}
}

140 
	$gup_pmd_¿nge
(
pud_t
 
pud
, 
addr
, 
’d
,

141 
wr™e
, 
·ge
 **
·ges
, *
Ä
)

143 
Ãxt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
Ãxt
 = 
	`pmd_addr_’d
(
addr
, 
’d
);

151 ià(
	`pmd_nÚe
(
pmd
))

153 ià(
	`uÆik–y
(
	`pmd_Ïrge
(
pmd
))) {

154 ià(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
Ãxt
, 
wr™e
, 
·ges
, 
Ä
))

157 ià(!
	`gup_±e_¿nge
(
pmd
, 
addr
, 
Ãxt
, 
wr™e
, 
·ges
, 
Ä
))

160 } 
pmdp
++, 
addr
 = 
Ãxt
,‡dd¸!ğ
’d
);

163 
	}
}

165 
nošlše
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
’d
, 
wr™e
, 
·ge
 **
·ges
, *
Ä
)

168 
mask
;

169 
±e_t
 
±e
 = *Õ‹_ˆ*)&
pud
;

170 
·ge
 *
h—d
, *page;

171 
»fs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 ià(
wr™e
)

175 
mask
 |ğ
_PAGE_RW
;

176 ià((
	`±e_æags
(
±e
è& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_æags
(
±e
è& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`pâ_v®id
(
	`±e_pâ
(
±e
)));

182 
»fs
 = 0;

183 
h—d
 = 
	`±e_·ge
(
±e
);

184 
·ge
 = 
h—d
 + ((
addr
 & ~
PUD_MASK
è>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_h—d
(
·ge
è!ğ
h—d
);

187 
·ges
[*
Ä
] = 
·ge
;

188 (*
Ä
)++;

189 
·ge
++;

190 
»fs
++;

191 } 
addr
 +ğ
PAGE_SIZE
,‡dd¸!ğ
’d
);

192 
	`g‘_h—d_·ge_muÉË
(
h—d
, 
»fs
);

195 
	}
}

197 
	$gup_pud_¿nge
(
pgd_t
 
pgd
, 
addr
, 
’d
,

198 
wr™e
, 
·ge
 **
·ges
, *
Ä
)

200 
Ãxt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
Ãxt
 = 
	`pud_addr_’d
(
addr
, 
’d
);

208 ià(
	`pud_nÚe
(
pud
))

210 ià(
	`uÆik–y
(
	`pud_Ïrge
(
pud
))) {

211 ià(!
	`gup_huge_pud
(
pud
, 
addr
, 
Ãxt
, 
wr™e
, 
·ges
, 
Ä
))

214 ià(!
	`gup_pmd_¿nge
(
pud
, 
addr
, 
Ãxt
, 
wr™e
, 
·ges
, 
Ä
))

217 } 
pudp
++, 
addr
 = 
Ãxt
,‡dd¸!ğ
’d
);

220 
	}
}

238 
	$g‘_u£r_·ges_ç¡
(
¡¬t
, 
Ä_·ges
, 
wr™e
,

239 
·ge
 **
·ges
)

241 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

242 
addr
, 
Ën
, 
’d
;

243 
Ãxt
;

244 
pgd_t
 *
pgdp
;

245 
Ä
 = 0;

247 
¡¬t
 &ğ
PAGE_MASK
;

248 
addr
 = 
¡¬t
;

249 
Ën
 = (è
Ä_·ges
 << 
PAGE_SHIFT
;

250 
’d
 = 
¡¬t
 + 
Ën
;

251 ià(
	`uÆik–y
(!
	`acûss_ok
(
wr™e
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

252 (
__u£r
 *)
¡¬t
, 
Ën
)))

253 
¦ow_œqÚ
;

273 
	`loÿl_œq_di§bË
();

274 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

276 
pgd_t
 
pgd
 = *
pgdp
;

278 
Ãxt
 = 
	`pgd_addr_’d
(
addr
, 
’d
);

279 ià(
	`pgd_nÚe
(
pgd
))

280 
¦ow
;

281 ià(!
	`gup_pud_¿nge
(
pgd
, 
addr
, 
Ãxt
, 
wr™e
, 
·ges
, &
Ä
))

282 
¦ow
;

283 } 
pgdp
++, 
addr
 = 
Ãxt
,‡dd¸!ğ
’d
);

284 
	`loÿl_œq_’abË
();

286 
	`VM_BUG_ON
(
Ä
 !ğ(
’d
 - 
¡¬t
è>> 
PAGE_SHIFT
);

287  
Ä
;

290 
»t
;

292 
¦ow
:

293 
	`loÿl_œq_’abË
();

294 
¦ow_œqÚ
:

296 
¡¬t
 +ğ
Ä
 << 
PAGE_SHIFT
;

297 
·ges
 +ğ
Ä
;

299 
	`down_»ad
(&
mm
->
mm­_£m
);

300 
»t
 = 
	`g‘_u£r_·ges
(
cu¼’t
, 
mm
, 
¡¬t
,

301 (
’d
 - 
¡¬t
è>> 
PAGE_SHIFT
, 
wr™e
, 0, 
·ges
, 
NULL
);

302 
	`up_»ad
(&
mm
->
mm­_£m
);

305 ià(
Ä
 > 0) {

306 ià(
»t
 < 0)

307 
»t
 = 
Ä
;

309 
»t
 +ğ
Ä
;

312  
»t
;

314 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<lšux/š™.h
>

8 
	~<lšux/fs.h
>

9 
	~<lšux/mm.h
>

10 
	~<lšux/hug‘lb.h
>

11 
	~<lšux/·gem­.h
>

12 
	~<lšux/¦ab.h
>

13 
	~<lšux/”r.h
>

14 
	~<lšux/sysùl.h
>

15 
	~<asm/mmª.h
>

16 
	~<asm/b.h
>

17 
	~<asm/bæush.h
>

18 
	~<asm/pg®loc.h
>

20 
	$·ge_bË_sh¬—bË
(
vm_¬—_¡ruù
 *
svma
,

21 
vm_¬—_¡ruù
 *
vma
,

22 
addr
, 
pgoff_t
 
idx
)

24 
§ddr
 = ((
idx
 - 
svma
->
vm_pgoff
è<< 
PAGE_SHIFT
) +

25 
svma
->
vm_¡¬t
;

26 
sba£
 = 
§ddr
 & 
PUD_MASK
;

27 
s_’d
 = 
sba£
 + 
PUD_SIZE
;

30 
vm_æags
 = 
vma
->vm_æag & ~
VM_LOCKED
;

31 
svm_æags
 = 
svma
->
vm_æags
 & ~
VM_LOCKED
;

37 ià(
	`pmd_šdex
(
addr
è!ğpmd_šdex(
§ddr
) ||

38 
vm_æags
 !ğ
svm_æags
 ||

39 
sba£
 < 
svma
->
vm_¡¬t
 || svma->
vm_’d
 < 
s_’d
)

42  
§ddr
;

43 
	}
}

45 
	$vma_sh¬—bË
(
vm_¬—_¡ruù
 *
vma
, 
addr
)

47 
ba£
 = 
addr
 & 
PUD_MASK
;

48 
’d
 = 
ba£
 + 
PUD_SIZE
;

53 ià(
vma
->
vm_æags
 & 
VM_MAYSHARE
 &&

54 
vma
->
vm_¡¬t
 <ğ
ba£
 && 
’d
 <ğvma->
vm_’d
)

57 
	}
}

62 
	$huge_pmd_sh¬e
(
mm_¡ruù
 *
mm
, 
addr
, 
pud_t
 *
pud
)

64 
vm_¬—_¡ruù
 *
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

65 
add»ss_¥aû
 *
m­pšg
 = 
vma
->
vm_fe
->
f_m­pšg
;

66 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_¡¬t
è>> 
PAGE_SHIFT
) +

67 
vma
->
vm_pgoff
;

68 
´io_Œ“_™”
 
™”
;

69 
vm_¬—_¡ruù
 *
svma
;

70 
§ddr
;

71 
±e_t
 *
¥‹
 = 
NULL
;

73 ià(!
	`vma_sh¬—bË
(
vma
, 
addr
))

76 
	`¥š_lock
(&
m­pšg
->
i_mm­_lock
);

77 
	`vma_´io_Œ“_fÜ—ch
(
svma
, &
™”
, &
m­pšg
->
i_mm­
, 
idx
, idx) {

78 ià(
svma
 =ğ
vma
)

81 
§ddr
 = 
	`·ge_bË_sh¬—bË
(
svma
, 
vma
, 
addr
, 
idx
);

82 ià(
§ddr
) {

83 
¥‹
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
§ddr
);

84 ià(
¥‹
) {

85 
	`g‘_·ge
(
	`vœt_to_·ge
(
¥‹
));

91 ià(!
¥‹
)

92 
out
;

94 
	`¥š_lock
(&
mm
->
·ge_bË_lock
);

95 ià(
	`pud_nÚe
(*
pud
))

96 
	`pud_pİuÏ‹
(
mm
, 
pud
, (
pmd_t
 *)(()
¥‹
 & 
PAGE_MASK
));

98 
	`put_·ge
(
	`vœt_to_·ge
(
¥‹
));

99 
	`¥š_uÆock
(&
mm
->
·ge_bË_lock
);

100 
out
:

101 
	`¥š_uÆock
(&
m­pšg
->
i_mm­_lock
);

102 
	}
}

116 
	$huge_pmd_unsh¬e
(
mm_¡ruù
 *
mm
, *
addr
, 
±e_t
 *
±•
)

118 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

119 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

121 
	`BUG_ON
(
	`·ge_couÁ
(
	`vœt_to_·ge
(
±•
)) == 0);

122 ià(
	`·ge_couÁ
(
	`vœt_to_·ge
(
±•
)) == 1)

125 
	`pud_ş—r
(
pud
);

126 
	`put_·ge
(
	`vœt_to_·ge
(
±•
));

127 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

129 
	}
}

131 
±e_t
 *
	$huge_±e_®loc
(
mm_¡ruù
 *
mm
,

132 
addr
, 
sz
)

134 
pgd_t
 *
pgd
;

135 
pud_t
 *
pud
;

136 
±e_t
 *
±e
 = 
NULL
;

138 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

139 
pud
 = 
	`pud_®loc
(
mm
, 
pgd
, 
addr
);

140 ià(
pud
) {

141 ià(
sz
 =ğ
PUD_SIZE
) {

142 
±e
 = (
±e_t
 *)
pud
;

144 
	`BUG_ON
(
sz
 !ğ
PMD_SIZE
);

145 ià(
	`pud_nÚe
(*
pud
))

146 
	`huge_pmd_sh¬e
(
mm
, 
addr
, 
pud
);

147 
±e
 = (
±e_t
 *è
	`pmd_®loc
(
mm
, 
pud
, 
addr
);

150 
	`BUG_ON
(
±e
 && !
	`±e_nÚe
(*±eè&& !
	`±e_huge
(*pte));

152  
±e
;

153 
	}
}

155 
±e_t
 *
	$huge_±e_off£t
(
mm_¡ruù
 *
mm
, 
addr
)

157 
pgd_t
 *
pgd
;

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
 = 
NULL
;

161 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

162 ià(
	`pgd_´e£Á
(*
pgd
)) {

163 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

164 ià(
	`pud_´e£Á
(*
pud
)) {

165 ià(
	`pud_Ïrge
(*
pud
))

166  (
±e_t
 *)
pud
;

167 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

170  (
±e_t
 *è
pmd
;

171 
	}
}

174 
·ge
 *

175 
	$fŞlow_huge_addr
(
mm_¡ruù
 *
mm
, 
add»ss
, 
wr™e
)

177 
¡¬t
 = 
add»ss
;

178 
Ëngth
 = 1;

179 
Ä
;

180 
·ge
 *page;

181 
vm_¬—_¡ruù
 *
vma
;

183 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

184 ià(!
vma
 || !
	`is_vm_hug‘lb_·ge
(vma))

185  
	`ERR_PTR
(-
EINVAL
);

187 
±e
 = 
	`huge_±e_off£t
(
mm
, 
add»ss
);

190 
	`WARN_ON
(!
±e
 || 
	`±e_nÚe
(*pte));

192 
·ge
 = &
	`±e_·ge
(*
±e
)[
vpâ
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

194 
	`WARN_ON
(!
	`PageH—d
(
·ge
));

196  
·ge
;

197 
	}
}

199 
	$pmd_huge
(
pmd_t
 
pmd
)

202 
	}
}

204 
	$pud_huge
(
pud_t
 
pud
)

207 
	}
}

209 
·ge
 *

210 
	$fŞlow_huge_pmd
(
mm_¡ruù
 *
mm
, 
add»ss
,

211 
pmd_t
 *
pmd
, 
wr™e
)

213  
NULL
;

214 
	}
}

218 
·ge
 *

219 
	$fŞlow_huge_addr
(
mm_¡ruù
 *
mm
, 
add»ss
, 
wr™e
)

221  
	`ERR_PTR
(-
EINVAL
);

222 
	}
}

224 
	$pmd_huge
(
pmd_t
 
pmd
)

226  !!(
	`pmd_v®
(
pmd
è& 
_PAGE_PSE
);

227 
	}
}

229 
	$pud_huge
(
pud_t
 
pud
)

231  !!(
	`pud_v®
(
pud
è& 
_PAGE_PSE
);

232 
	}
}

234 
·ge
 *

235 
	$fŞlow_huge_pmd
(
mm_¡ruù
 *
mm
, 
add»ss
,

236 
pmd_t
 *
pmd
, 
wr™e
)

238 
·ge
 *page;

240 
·ge
 = 
	`±e_·ge
(*(
±e_t
 *)
pmd
);

241 ià(
·ge
)

242 
·ge
 +ğ((
add»ss
 & ~
PMD_MASK
è>> 
PAGE_SHIFT
);

243  
·ge
;

244 
	}
}

246 
·ge
 *

247 
	$fŞlow_huge_pud
(
mm_¡ruù
 *
mm
, 
add»ss
,

248 
pud_t
 *
pud
, 
wr™e
)

250 
·ge
 *page;

252 
·ge
 = 
	`±e_·ge
(*(
±e_t
 *)
pud
);

253 ià(
·ge
)

254 
·ge
 +ğ((
add»ss
 & ~
PUD_MASK
è>> 
PAGE_SHIFT
);

255  
·ge
;

256 
	}
}

262 #ifdeà
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


263 
	$hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
 *file,

264 
addr
, 
Ën
,

265 
pgoff
, 
æags
)

267 
h¡©e
 *
h
 = 
	`h¡©e_fe
(
fe
);

268 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

269 
vm_¬—_¡ruù
 *
vma
;

270 
¡¬t_addr
;

272 ià(
Ën
 > 
mm
->
ÿched_hŞe_size
) {

273 
¡¬t_addr
 = 
mm
->
ä“_¬—_ÿche
;

275 
¡¬t_addr
 = 
TASK_UNMAPPED_BASE
;

276 
mm
->
ÿched_hŞe_size
 = 0;

279 
fuÎ_£¬ch
:

280 
addr
 = 
	`ALIGN
(
¡¬t_addr
, 
	`huge_·ge_size
(
h
));

282 
vma
 = 
	`fšd_vma
(
mm
, 
addr
); ; vm¨ğvma->
vm_Ãxt
) {

284 ià(
TASK_SIZE
 - 
Ën
 < 
addr
) {

289 ià(
¡¬t_addr
 !ğ
TASK_UNMAPPED_BASE
) {

290 
¡¬t_addr
 = 
TASK_UNMAPPED_BASE
;

291 
mm
->
ÿched_hŞe_size
 = 0;

292 
fuÎ_£¬ch
;

294  -
ENOMEM
;

296 ià(!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
) {

297 
mm
->
ä“_¬—_ÿche
 = 
addr
 + 
Ën
;

298  
addr
;

300 ià(
addr
 + 
mm
->
ÿched_hŞe_size
 < 
vma
->
vm_¡¬t
)

301 
mm
->
ÿched_hŞe_size
 = 
vma
->
vm_¡¬t
 - 
addr
;

302 
addr
 = 
	`ALIGN
(
vma
->
vm_’d
, 
	`huge_·ge_size
(
h
));

304 
	}
}

306 
	$hug‘lb_g‘_unm­³d_¬—_tİdown
(
fe
 *file,

307 
addr0
, 
Ën
,

308 
pgoff
, 
æags
)

310 
h¡©e
 *
h
 = 
	`h¡©e_fe
(
fe
);

311 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

312 
vm_¬—_¡ruù
 *
vma
, *
´ev_vma
;

313 
ba£
 = 
mm
->
mm­_ba£
, 
addr
 = 
addr0
;

314 
Ïrge¡_hŞe
 = 
mm
->
ÿched_hŞe_size
;

315 
fœ¡_time
 = 1;

318 ià(
mm
->
ä“_¬—_ÿche
 > 
ba£
)

319 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

321 ià(
Ën
 <ğ
Ïrge¡_hŞe
) {

322 
Ïrge¡_hŞe
 = 0;

323 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

325 
Œy_agaš
:

327 ià(
mm
->
ä“_¬—_ÿche
 < 
Ën
)

328 
ç
;

331 
addr
 = (
mm
->
ä“_¬—_ÿche
 - 
Ën
è& 
	`huge_·ge_mask
(
h
);

337 ià(!(
vma
 = 
	`fšd_vma_´ev
(
mm
, 
addr
, &
´ev_vma
)))

338  
addr
;

344 ià(
addr
 + 
Ën
 <ğ
vma
->
vm_¡¬t
 &&

345 (!
´ev_vma
 || (
addr
 >ğ´ev_vma->
vm_’d
))) {

347 
mm
->
ÿched_hŞe_size
 = 
Ïrge¡_hŞe
;

348  (
mm
->
ä“_¬—_ÿche
 = 
addr
);

351 ià(
mm
->
ä“_¬—_ÿche
 =ğ
vma
->
vm_’d
) {

352 
mm
->
ä“_¬—_ÿche
 = 
vma
->
vm_¡¬t
;

353 
mm
->
ÿched_hŞe_size
 = 
Ïrge¡_hŞe
;

358 ià(
addr
 + 
Ïrge¡_hŞe
 < 
vma
->
vm_¡¬t
)

359 
Ïrge¡_hŞe
 = 
vma
->
vm_¡¬t
 - 
addr
;

362 
addr
 = (
vma
->
vm_¡¬t
 - 
Ën
è& 
	`huge_·ge_mask
(
h
);

363 } 
Ën
 <ğ
vma
->
vm_¡¬t
);

365 
ç
:

370 ià(
fœ¡_time
) {

371 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

372 
Ïrge¡_hŞe
 = 0;

373 
fœ¡_time
 = 0;

374 
Œy_agaš
;

382 
mm
->
ä“_¬—_ÿche
 = 
TASK_UNMAPPED_BASE
;

383 
mm
->
ÿched_hŞe_size
 = ~0UL;

384 
addr
 = 
	`hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
, 
addr0
,

385 
Ën
, 
pgoff
, 
æags
);

390 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

391 
mm
->
ÿched_hŞe_size
 = ~0UL;

393  
addr
;

394 
	}
}

397 
	$hug‘lb_g‘_unm­³d_¬—
(
fe
 *fe, 
addr
,

398 
Ën
, 
pgoff
, 
æags
)

400 
h¡©e
 *
h
 = 
	`h¡©e_fe
(
fe
);

401 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

402 
vm_¬—_¡ruù
 *
vma
;

404 ià(
Ën
 & ~
	`huge_·ge_mask
(
h
))

405  -
EINVAL
;

406 ià(
Ën
 > 
TASK_SIZE
)

407  -
ENOMEM
;

409 ià(
æags
 & 
MAP_FIXED
) {

410 ià(
	`´•¬e_hug•age_¿nge
(
fe
, 
addr
, 
Ën
))

411  -
EINVAL
;

412  
addr
;

415 ià(
addr
) {

416 
addr
 = 
	`ALIGN
×ddr, 
	`huge_·ge_size
(
h
));

417 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

418 ià(
TASK_SIZE
 - 
Ën
 >ğ
addr
 &&

419 (!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
))

420  
addr
;

422 ià(
mm
->
g‘_unm­³d_¬—
 =ğ
¬ch_g‘_unm­³d_¬—
)

423  
	`hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
, 
addr
, 
Ën
,

424 
pgoff
, 
æags
);

426  
	`hug‘lb_g‘_unm­³d_¬—_tİdown
(
fe
, 
addr
, 
Ën
,

427 
pgoff
, 
æags
);

428 
	}
}

432 #ifdeà
CONFIG_X86_64


433 
__š™
 
	$£tup_hug•agesz
(*
İt
)

435 
ps
 = 
	`mem·r£
(
İt
, &opt);

436 ià(
ps
 =ğ
PMD_SIZE
) {

437 
	`hug‘lb_add_h¡©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

438 } ià(
ps
 =ğ
PUD_SIZE
 && 
ıu_has_gb·ges
) {

439 
	`hug‘lb_add_h¡©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

441 
	`´štk
(
KERN_ERR
 "hugepagesz: Unsupported…age size %lu M\n",

442 
ps
 >> 20);

446 
	}
}

447 
__£tup
("hug•agesz=", 
£tup_hug•agesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<lšux/iİÜt.h
>

2 
	~<lšux/sw­.h
>

4 
	~<asm/ÿcheæush.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/š™.h
>

7 
	~<asm/·ge.h
>

8 
	~<asm/·ge_ty³s.h
>

9 
	~<asm/£ùiÚs.h
>

10 
	~<asm/£tup.h
>

11 
	~<asm/sy¡em.h
>

12 
	~<asm/bæush.h
>

14 
__š™d©a
 
	ge820_bË_¡¬t
;

15 
__memš™d©a
 
	ge820_bË_’d
;

16 
__memš™d©a
 
	ge820_bË_tİ
;

18 
	gaá”_boÙmem
;

20 
	gdœeù_gb·ges


21 #ifdeà
CONFIG_DIRECT_GBPAGES


26 
__š™
 
	$fšd_—¾y_bË_¥aû
(
’d
, 
u£_p£
,

27 
u£_gb·ges
)

29 
puds
, 
pmds
, 
±es
, 
bËs
, 
¡¬t
;

31 
puds
 = (
’d
 + 
PUD_SIZE
 - 1è>> 
PUD_SHIFT
;

32 
bËs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

34 ià(
u£_gb·ges
) {

35 
exŒa
;

37 
exŒa
 = 
’d
 - (Ónd>>
PUD_SHIFT
) << PUD_SHIFT);

38 
pmds
 = (
exŒa
 + 
PMD_SIZE
 - 1è>> 
PMD_SHIFT
;

40 
pmds
 = (
’d
 + 
PMD_SIZE
 - 1è>> 
PMD_SHIFT
;

42 
bËs
 +ğ
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

44 ià(
u£_p£
) {

45 
exŒa
;

47 
exŒa
 = 
’d
 - (Ónd>>
PMD_SHIFT
) << PMD_SHIFT);

48 #ifdeà
CONFIG_X86_32


49 
exŒa
 +ğ
PMD_SIZE
;

51 
±es
 = (
exŒa
 + 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
;

53 
±es
 = (
’d
 + 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
;

55 
bËs
 +ğ
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

57 #ifdeà
CONFIG_X86_32


59 
bËs
 +ğ
	`roundup
(
__’d_of_fixed_add»s£s
 * (
±e_t
), 
PAGE_SIZE
);

67 #ifdeà
CONFIG_X86_32


68 
¡¬t
 = 0x7000;

69 
e820_bË_¡¬t
 = 
	`fšd_e820_¬—
(
¡¬t
, 
max_pâ_m­³d
<<
PAGE_SHIFT
,

70 
bËs
, 
PAGE_SIZE
);

72 
¡¬t
 = 0x8000;

73 
e820_bË_¡¬t
 = 
	`fšd_e820_¬—
(
¡¬t
, 
’d
, 
bËs
, 
PAGE_SIZE
);

75 ià(
e820_bË_¡¬t
 == -1UL)

76 
	`·nic
("Cannot find space forhe kernel…ageables");

78 
e820_bË_¡¬t
 >>ğ
PAGE_SHIFT
;

79 
e820_bË_’d
 = 
e820_bË_¡¬t
;

80 
e820_bË_tİ
 = 
e820_bË_¡¬t
 + (
bËs
 >> 
PAGE_SHIFT
);

82 
	`´štk
(
KERN_DEBUG
 "kernel direct mappingables upo %lx @ %lx-%lx\n",

83 
’d
, 
e820_bË_¡¬t
 << 
PAGE_SHIFT
, 
e820_bË_tİ
 << PAGE_SHIFT);

84 
	}
}

86 
	sm­_¿nge
 {

87 
	m¡¬t
;

88 
	m’d
;

89 
	m·ge_size_mask
;

92 #ifdeà
CONFIG_X86_32


93 
	#NR_RANGE_MR
 3

	)

95 
	#NR_RANGE_MR
 5

	)

98 
__memš™
 
	$§ve_mr
(
m­_¿nge
 *
mr
, 
Ä_¿nge
,

99 
¡¬t_pâ
, 
’d_pâ
,

100 
·ge_size_mask
)

102 ià(
¡¬t_pâ
 < 
’d_pâ
) {

103 ià(
Ä_¿nge
 >ğ
NR_RANGE_MR
)

104 
	`·nic
("run out of„ange for init_memory_mapping\n");

105 
mr
[
Ä_¿nge
].
¡¬t
 = 
¡¬t_pâ
<<
PAGE_SHIFT
;

106 
mr
[
Ä_¿nge
].
’d
 = 
’d_pâ
<<
PAGE_SHIFT
;

107 
mr
[
Ä_¿nge
].
·ge_size_mask
 =…age_size_mask;

108 
Ä_¿nge
++;

111  
Ä_¿nge
;

112 
	}
}

114 #ifdeà
CONFIG_X86_64


115 
__š™
 
	$š™_gb·ges
()

117 ià(
dœeù_gb·ges
 && 
ıu_has_gb·ges
)

118 
	`´štk
(
KERN_INFO
 "Using GB…ages for direct mapping\n");

120 
dœeù_gb·ges
 = 0;

121 
	}
}

123 
šlše
 
	$š™_gb·ges
()

125 
	}
}

133 
__š™_»fok
 
	$š™_memÜy_m­pšg
(
¡¬t
,

134 
’d
)

136 
·ge_size_mask
 = 0;

137 
¡¬t_pâ
, 
’d_pâ
;

138 
»t
 = 0;

139 
pos
;

141 
m­_¿nge
 
mr
[
NR_RANGE_MR
];

142 
Ä_¿nge
, 
i
;

143 
u£_p£
, 
u£_gb·ges
;

145 
	`´štk
(
KERN_INFO
 "š™_memÜy_m­pšg: %016lx-%016lx\n", 
¡¬t
, 
’d
);

147 ià(!
aá”_boÙmem
)

148 
	`š™_gb·ges
();

150 #ifdeà
CONFIG_DEBUG_PAGEALLOC


156 
u£_p£
 = 
u£_gb·ges
 = 0;

158 
u£_p£
 = 
ıu_has_p£
;

159 
u£_gb·ges
 = 
dœeù_gb·ges
;

162 #ifdeà
CONFIG_X86_32


163 #ifdeà
CONFIG_X86_PAE


164 
	`£t_nx
();

165 ià(
nx_’abËd
)

166 
	`´štk
(
KERN_INFO
 "NX (Execute Disable)…rotection:‡ctive\n");

170 ià(
ıu_has_p£
)

171 
	`£t_š_ü4
(
X86_CR4_PSE
);

174 ià(
ıu_has_pge
) {

175 
	`£t_š_ü4
(
X86_CR4_PGE
);

176 
__suµÜ‹d_±e_mask
 |ğ
_PAGE_GLOBAL
;

180 ià(
u£_gb·ges
)

181 
·ge_size_mask
 |ğ1 << 
PG_LEVEL_1G
;

182 ià(
u£_p£
)

183 
·ge_size_mask
 |ğ1 << 
PG_LEVEL_2M
;

185 
	`mem£t
(
mr
, 0, (mr));

186 
Ä_¿nge
 = 0;

189 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

190 
pos
 = 
¡¬t_pâ
 << 
PAGE_SHIFT
;

191 #ifdeà
CONFIG_X86_32


198 ià(
pos
 == 0)

199 
’d_pâ
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

201 
’d_pâ
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

202 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

204 
’d_pâ
 = ((
pos
 + (
PMD_SIZE
 - 1)è>> 
PMD_SHIFT
)

205 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

207 ià(
’d_pâ
 > (
’d
 >> 
PAGE_SHIFT
))

208 
’d_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

209 ià(
¡¬t_pâ
 < 
’d_pâ
) {

210 
Ä_¿nge
 = 
	`§ve_mr
(
mr
,‚r_¿nge, 
¡¬t_pâ
, 
’d_pâ
, 0);

211 
pos
 = 
’d_pâ
 << 
PAGE_SHIFT
;

215 
¡¬t_pâ
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

216 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

217 #ifdeà
CONFIG_X86_32


218 
’d_pâ
 = (
’d
>>
PMD_SHIFT
è<< (PMD_SHIFT - 
PAGE_SHIFT
);

220 
’d_pâ
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

221 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

222 ià(
’d_pâ
 > ((
’d
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

223 
’d_pâ
 = ((
’d
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

226 ià(
¡¬t_pâ
 < 
’d_pâ
) {

227 
Ä_¿nge
 = 
	`§ve_mr
(
mr
,‚r_¿nge, 
¡¬t_pâ
, 
’d_pâ
,

228 
·ge_size_mask
 & (1<<
PG_LEVEL_2M
));

229 
pos
 = 
’d_pâ
 << 
PAGE_SHIFT
;

232 #ifdeà
CONFIG_X86_64


234 
¡¬t_pâ
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

235 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

236 
’d_pâ
 = (
’d
 >> 
PUD_SHIFT
è<< (PUD_SHIFT - 
PAGE_SHIFT
);

237 ià(
¡¬t_pâ
 < 
’d_pâ
) {

238 
Ä_¿nge
 = 
	`§ve_mr
(
mr
,‚r_¿nge, 
¡¬t_pâ
, 
’d_pâ
,

239 
·ge_size_mask
 &

240 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

241 
pos
 = 
’d_pâ
 << 
PAGE_SHIFT
;

245 
¡¬t_pâ
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

246 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

247 
’d_pâ
 = (
’d
 >> 
PMD_SHIFT
è<< (PMD_SHIFT - 
PAGE_SHIFT
);

248 ià(
¡¬t_pâ
 < 
’d_pâ
) {

249 
Ä_¿nge
 = 
	`§ve_mr
(
mr
,‚r_¿nge, 
¡¬t_pâ
, 
’d_pâ
,

250 
·ge_size_mask
 & (1<<
PG_LEVEL_2M
));

251 
pos
 = 
’d_pâ
 << 
PAGE_SHIFT
;

256 
¡¬t_pâ
 = 
pos
>>
PAGE_SHIFT
;

257 
’d_pâ
 = 
’d
>>
PAGE_SHIFT
;

258 
Ä_¿nge
 = 
	`§ve_mr
(
mr
,‚r_¿nge, 
¡¬t_pâ
, 
’d_pâ
, 0);

261 
i
 = 0; 
Ä_¿nge
 > 1 && i <‚r_range - 1; i++) {

262 
Şd_¡¬t
;

263 ià(
mr
[
i
].
’d
 !ğmr[i+1].
¡¬t
 ||

264 
mr
[
i
].
·ge_size_mask
 != mr[i+1].page_size_mask)

267 
Şd_¡¬t
 = 
mr
[
i
].
¡¬t
;

268 
	`memmove
(&
mr
[
i
], &mr[i+1],

269 (
Ä_¿nge
 - 1 - 
i
è* (
m­_¿nge
));

270 
mr
[
i
--].
¡¬t
 = 
Şd_¡¬t
;

271 
Ä_¿nge
--;

274 
i
 = 0; i < 
Ä_¿nge
; i++)

275 
	`´štk
(
KERN_DEBUG
 " %010lx - %010lx…age %s\n",

276 
mr
[
i
].
¡¬t
, mr[i].
’d
,

277 (
mr
[
i
].
·ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

278 (
mr
[
i
].
·ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

287 ià(!
aá”_boÙmem
)

288 
	`fšd_—¾y_bË_¥aû
(
’d
, 
u£_p£
, 
u£_gb·ges
);

290 #ifdeà
CONFIG_X86_32


291 
i
 = 0; i < 
Ä_¿nge
; i++)

292 
	`k”Ãl_physiÿl_m­pšg_š™
(
mr
[
i
].
¡¬t
, mr[i].
’d
,

293 
mr
[
i
].
·ge_size_mask
);

294 
»t
 = 
’d
;

296 
i
 = 0; i < 
Ä_¿nge
; i++)

297 
»t
 = 
	`k”Ãl_physiÿl_m­pšg_š™
(
mr
[
i
].
¡¬t
, mr[i].
’d
,

298 
mr
[
i
].
·ge_size_mask
);

301 #ifdeà
CONFIG_X86_32


302 
	`—¾y_iÜem­_·ge_bË_¿nge_š™
();

304 
	`lßd_ü3
(
sw­³r_pg_dœ
);

307 #ifdeà
CONFIG_X86_64


308 ià(!
aá”_boÙmem
 && !
¡¬t
) {

309 
pud_t
 *
pud
;

310 
pmd_t
 *
pmd
;

312 
mmu_ü4_ã©u»s
 = 
	`»ad_ü4
();

320 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_’d
), _brk_end);

321 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_’d
 - 1);

322 ++
pmd
 <ğ
	`pmd_off£t
(
pud
, ()
_’d
 - 1))

323 
	`pmd_ş—r
(
pmd
);

326 
	`__æush_b_®l
();

328 ià(!
aá”_boÙmem
 && 
e820_bË_’d
 > 
e820_bË_¡¬t
)

329 
	`»£rve_—¾y
(
e820_bË_¡¬t
 << 
PAGE_SHIFT
,

330 
e820_bË_’d
 << 
PAGE_SHIFT
, "PGTABLE");

332 ià(!
aá”_boÙmem
)

333 
	`—¾y_mem‹¡
(
¡¬t
, 
’d
);

335  
»t
 >> 
PAGE_SHIFT
;

336 
	}
}

349 
	$devmem_is_®lowed
(
·g’r
)

351 ià(
·g’r
 <= 256)

353 ià(
	`iomem_is_exşusive
(
·g’r
 << 
PAGE_SHIFT
))

355 ià(!
	`·ge_is_¿m
(
·g’r
))

358 
	}
}

360 
	$ä“_š™_·ges
(*
wh©
, 
begš
, 
’d
)

362 
addr
 = 
begš
;

364 ià(
addr
 >ğ
’d
)

372 #ifdeà
CONFIG_DEBUG_PAGEALLOC


373 
	`´štk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

374 
begš
, 
	`PAGE_ALIGN
(
’d
));

375 
	`£t_memÜy_Å
(
begš
, (
’d
 - begšè>> 
PAGE_SHIFT
);

382 
	`£t_memÜy_rw
(
begš
, (
’d
 - begšè>> 
PAGE_SHIFT
);

384 
	`´štk
(
KERN_INFO
 "F»ešg %s: %luk f»ed\n", 
wh©
, (
’d
 - 
begš
) >> 10);

386 ; 
addr
 < 
’d
;‡dd¸+ğ
PAGE_SIZE
) {

387 
	`CË¬PageRe£rved
(
	`vœt_to_·ge
(
addr
));

388 
	`š™_·ge_couÁ
(
	`vœt_to_·ge
(
addr
));

389 
	`mem£t
((*)(
addr
 & ~(
PAGE_SIZE
-1)),

390 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

391 
	`ä“_·ge
(
addr
);

392 
tÙ®¿m_·ges
++;

395 
	}
}

397 
	$ä“_š™mem
()

399 
	`ä“_š™_·ges
("unused kernel memory",

400 ()(&
__š™_begš
),

401 ()(&
__š™_’d
));

402 
	}
}

404 #ifdeà
CONFIG_BLK_DEV_INITRD


405 
	$ä“_š™rd_mem
(
¡¬t
, 
’d
)

407 
	`ä“_š™_·ges
("š™rd memÜy", 
¡¬t
, 
’d
);

408 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<lšux/sigÇl.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/±¿û.h
>

16 
	~<lšux/mmª.h
>

17 
	~<lšux/mm.h
>

18 
	~<lšux/sw­.h
>

19 
	~<lšux/smp.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/š™rd.h
>

22 
	~<lšux/·gem­.h
>

23 
	~<lšux/boÙmem.h
>

24 
	~<lšux/´oc_fs.h
>

25 
	~<lšux/pci.h
>

26 
	~<lšux/pâ.h
>

27 
	~<lšux/poisÚ.h
>

28 
	~<lšux/dma-m­pšg.h
>

29 
	~<lšux/moduË.h
>

30 
	~<lšux/memÜy_hÙ¶ug.h
>

31 
	~<lšux/nmi.h
>

33 
	~<asm/´oûssÜ.h
>

34 
	~<asm/bios_ebda.h
>

35 
	~<asm/sy¡em.h
>

36 
	~<asm/uacûss.h
>

37 
	~<asm/pgbË.h
>

38 
	~<asm/pg®loc.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/fixm­.h
>

41 
	~<asm/e820.h
>

42 
	~<asm/­ic.h
>

43 
	~<asm/b.h
>

44 
	~<asm/mmu_cÚ‹xt.h
>

45 
	~<asm/´Ùo.h
>

46 
	~<asm/smp.h
>

47 
	~<asm/£ùiÚs.h
>

48 
	~<asm/kdebug.h
>

49 
	~<asm/numa.h
>

50 
	~<asm/ÿcheæush.h
>

51 
	~<asm/š™.h
>

58 
	gmax_low_pâ_m­³d
;

59 
	gmax_pâ_m­³d
;

61 
dma_»£rve
 
	g__š™d©a
;

63 
DEFINE_PER_CPU
(
mmu_g©h”
, 
mmu_g©h”s
);

65 
__š™
 
	$·r£_dœeù_gb·ges_off
(*
¬g
)

67 
dœeù_gb·ges
 = 0;

69 
	}
}

70 
—¾y_·¿m
("nogb·ges", 
·r£_dœeù_gb·ges_off
);

72 
__š™
 
	$·r£_dœeù_gb·ges_Ú
(*
¬g
)

74 
dœeù_gb·ges
 = 1;

76 
	}
}

77 
—¾y_·¿m
("gb·ges", 
·r£_dœeù_gb·ges_Ú
);

85 
±ev®_t
 
__suµÜ‹d_±e_mask
 
	g__»ad_mo¡ly
 = ~
_PAGE_IOMAP
;

86 
EXPORT_SYMBOL_GPL
(
__suµÜ‹d_±e_mask
);

88 
di§bË_nx
 
	g__ıuš™d©a
;

97 
__š™
 
	$nÚx_£tup
(*
¡r
)

99 ià(!
¡r
)

100  -
EINVAL
;

101 ià(!
	`¡ºcmp
(
¡r
, "on", 2)) {

102 
__suµÜ‹d_±e_mask
 |ğ
_PAGE_NX
;

103 
di§bË_nx
 = 0;

104 } ià(!
	`¡ºcmp
(
¡r
, "off", 3)) {

105 
di§bË_nx
 = 1;

106 
__suµÜ‹d_±e_mask
 &ğ~
_PAGE_NX
;

109 
	}
}

110 
—¾y_·¿m
("nÛxec", 
nÚx_£tup
);

112 
__ıuš™
 
	$check_eãr
()

114 
eãr
;

116 
	`rdm¤l
(
MSR_EFER
, 
eãr
);

117 ià(!(
eãr
 & 
EFER_NX
è|| 
di§bË_nx
)

118 
__suµÜ‹d_±e_mask
 &ğ~
_PAGE_NX
;

119 
	}
}

121 
	gfÜû_³rsÚ®™y32
;

131 
__š™
 
	$nÚx32_£tup
(*
¡r
)

133 ià(!
	`¡rcmp
(
¡r
, "on"))

134 
fÜû_³rsÚ®™y32
 &ğ~
READ_IMPLIES_EXEC
;

135 ià(!
	`¡rcmp
(
¡r
, "off"))

136 
fÜû_³rsÚ®™y32
 |ğ
READ_IMPLIES_EXEC
;

138 
	}
}

139 
__£tup
("nÛxec32=", 
nÚx32_£tup
);

145 
__»f
 *
	$¥p_g‘·ge
()

147 *
±r
;

149 ià(
aá”_boÙmem
)

150 
±r
 = (*è
	`g‘_z”Ûd_·ge
(
GFP_ATOMIC
);

152 
±r
 = 
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

154 ià(!
±r
 || ((íŒ & ~
PAGE_MASK
)) {

155 
	`·nic
("set_pte_phys: cannot‡llocate…age data %s\n",

156 
aá”_boÙmem
 ? "after bootmem" : "");

159 
	`´_debug
("¥p_g‘·g%p\n", 
±r
);

161  
±r
;

162 
	}
}

164 
pud_t
 *
	$fl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

166 ià(
	`pgd_nÚe
(*
pgd
)) {

167 
pud_t
 *
pud
 = (pud_ˆ*)
	`¥p_g‘·ge
();

168 
	`pgd_pİuÏ‹
(&
š™_mm
, 
pgd
, 
pud
);

169 ià(
pud
 !ğ
	`pud_off£t
(
pgd
, 0))

170 
	`´štk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

171 
pud
, 
	`pud_off£t
(
pgd
, 0));

173  
	`pud_off£t
(
pgd
, 
vaddr
);

174 
	}
}

176 
pmd_t
 *
	$fl_pmd
(
pud_t
 *
pud
, 
vaddr
)

178 ià(
	`pud_nÚe
(*
pud
)) {

179 
pmd_t
 *
pmd
 = (pmd_ˆ*è
	`¥p_g‘·ge
();

180 
	`pud_pİuÏ‹
(&
š™_mm
, 
pud
, 
pmd
);

181 ià(
pmd
 !ğ
	`pmd_off£t
(
pud
, 0))

182 
	`´štk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

183 
pmd
, 
	`pmd_off£t
(
pud
, 0));

185  
	`pmd_off£t
(
pud
, 
vaddr
);

186 
	}
}

188 
±e_t
 *
	$fl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

190 ià(
	`pmd_nÚe
(*
pmd
)) {

191 
±e_t
 *
±e
 = (±e_ˆ*è
	`¥p_g‘·ge
();

192 
	`pmd_pİuÏ‹_k”Ãl
(&
š™_mm
, 
pmd
, 
±e
);

193 ià(
±e
 !ğ
	`±e_off£t_k”Ãl
(
pmd
, 0))

194 
	`´štk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

196  
	`±e_off£t_k”Ãl
(
pmd
, 
vaddr
);

197 
	}
}

199 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_·ge
, 
vaddr
, 
±e_t
 
Ãw_±e
)

201 
pud_t
 *
pud
;

202 
pmd_t
 *
pmd
;

203 
±e_t
 *
±e
;

205 
pud
 = 
pud_·ge
 + 
	`pud_šdex
(
vaddr
);

206 
pmd
 = 
	`fl_pmd
(
pud
, 
vaddr
);

207 
±e
 = 
	`fl_±e
(
pmd
, 
vaddr
);

209 
	`£t_±e
(
±e
, 
Ãw_±e
);

215 
	`__æush_b_Úe
(
vaddr
);

216 
	}
}

218 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±ev®
)

220 
pgd_t
 *
pgd
;

221 
pud_t
 *
pud_·ge
;

223 
	`´_debug
("£t_±e_vadd¸%lxØ%lx\n", 
vaddr
, 
	`Çtive_±e_v®
(
±ev®
));

225 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

226 ià(
	`pgd_nÚe
(*
pgd
)) {

227 
	`´štk
(
KERN_ERR


231 
pud_·ge
 = (
pud_t
*)
	`pgd_·ge_vaddr
(*
pgd
);

232 
	`£t_±e_vaddr_pud
(
pud_·ge
, 
vaddr
, 
±ev®
);

233 
	}
}

235 
pmd_t
 * 
__š™
 
	$pİuÏ‹_exŒa_pmd
(
vaddr
)

237 
pgd_t
 *
pgd
;

238 
pud_t
 *
pud
;

240 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

241 
pud
 = 
	`fl_pud
(
pgd
, 
vaddr
);

242  
	`fl_pmd
(
pud
, 
vaddr
);

243 
	}
}

245 
±e_t
 * 
__š™
 
	$pİuÏ‹_exŒa_±e
(
vaddr
)

247 
pmd_t
 *
pmd
;

249 
pmd
 = 
	`pİuÏ‹_exŒa_pmd
(
vaddr
);

250  
	`fl_±e
(
pmd
, 
vaddr
);

251 
	}
}

256 
__š™
 
	$__š™_exŒa_m­pšg
(
phys
, 
size
,

257 
pg´Ù_t
 
´Ù
)

259 
pgd_t
 *
pgd
;

260 
pud_t
 *
pud
;

261 
pmd_t
 *
pmd
;

263 
	`BUG_ON
((
phys
 & ~
PMD_MASK
è|| (
size
 & ~PMD_MASK));

264 ; 
size
; 
phys
 +ğ
PMD_SIZE
, size -= PMD_SIZE) {

265 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

266 ià(
	`pgd_nÚe
(*
pgd
)) {

267 
pud
 = (
pud_t
 *è
	`¥p_g‘·ge
();

268 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__·
(
pud
è| 
_KERNPG_TABLE
 |

269 
_PAGE_USER
));

271 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

272 ià(
	`pud_nÚe
(*
pud
)) {

273 
pmd
 = (
pmd_t
 *è
	`¥p_g‘·ge
();

274 
	`£t_pud
(
pud
, 
	`__pud
(
	`__·
(
pmd
è| 
_KERNPG_TABLE
 |

275 
_PAGE_USER
));

277 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

278 
	`BUG_ON
(!
	`pmd_nÚe
(*
pmd
));

279 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg´Ù_v®
(
´Ù
)));

281 
	}
}

283 
__š™
 
	$š™_exŒa_m­pšg_wb
(
phys
, 
size
)

285 
	`__š™_exŒa_m­pšg
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

286 
	}
}

288 
__š™
 
	$š™_exŒa_m­pšg_uc
(
phys
, 
size
)

290 
	`__š™_exŒa_m­pšg
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

291 
	}
}

306 
__š™
 
	$ş—nup_highm­
()

308 
vaddr
 = 
__START_KERNEL_m­
;

309 
’d
 = 
	`roundup
(()
_’d
, 
PMD_SIZE
) - 1;

310 
pmd_t
 *
pmd
 = 
Ëv–2_k”Ãl_pgt
;

311 
pmd_t
 *
Ï¡_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

313 ; 
pmd
 < 
Ï¡_pmd
;…md++, 
vaddr
 +ğ
PMD_SIZE
) {

314 ià(
	`pmd_nÚe
(*
pmd
))

316 ià(
vaddr
 < (è
_‹xt
 || vadd¸> 
’d
)

317 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

319 
	}
}

321 
__»f
 *
	$®loc_low_·ge
(*
phys
)

323 
pâ
 = 
e820_bË_’d
++;

324 *
adr
;

326 ià(
aá”_boÙmem
) {

327 
adr
 = (*)
	`g‘_z”Ûd_·ge
(
GFP_ATOMIC
);

328 *
phys
 = 
	`__·
(
adr
);

330  
adr
;

333 ià(
pâ
 >ğ
e820_bË_tİ
)

334 
	`·nic
("alloc_low_page:„an out of memory");

336 
adr
 = 
	`—¾y_mem»m­
(
pâ
 * 
PAGE_SIZE
, PAGE_SIZE);

337 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

338 *
phys
 = 
pâ
 * 
PAGE_SIZE
;

339  
adr
;

340 
	}
}

342 
__»f
 
	$unm­_low_·ge
(*
adr
)

344 ià(
aá”_boÙmem
)

347 
	`—¾y_iounm­
(
adr
, 
PAGE_SIZE
);

348 
	}
}

350 
__memš™


351 
	$phys_±e_š™
(
±e_t
 *
±e_·ge
, 
addr
, 
’d
,

352 
pg´Ù_t
 
´Ù
)

354 
·ges
 = 0;

355 
Ï¡_m­_addr
 = 
’d
;

356 
i
;

358 
±e_t
 *
±e
 = 
±e_·ge
 + 
	`±e_šdex
(
addr
);

360 
i
 = 
	`±e_šdex
(
addr
); i < 
PTRS_PER_PTE
; i++,‡dd¸+ğ
PAGE_SIZE
, 
±e
++) {

362 ià(
addr
 >ğ
’d
) {

363 ià(!
aá”_boÙmem
) {

364 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

365 
	`£t_±e
(
±e
, 
	`__±e
(0));

376 ià(
	`±e_v®
(*
±e
)) {

377 
·ges
++;

382 
	`´štk
("…te=%p‡ddr=%lx…te=%016lx\n",

383 
±e
, 
addr
, 
	`pâ_±e
×dd¸>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

384 
·ges
++;

385 
	`£t_±e
(
±e
, 
	`pâ_±e
(
addr
 >> 
PAGE_SHIFT
, 
´Ù
));

386 
Ï¡_m­_addr
 = (
addr
 & 
PAGE_MASK
è+ 
PAGE_SIZE
;

389 
	`upd©e_·ge_couÁ
(
PG_LEVEL_4K
, 
·ges
);

391  
Ï¡_m­_addr
;

392 
	}
}

394 
__memš™


395 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
add»ss
, 
’d
,

396 
pg´Ù_t
 
´Ù
)

398 
±e_t
 *
±e
 = (±e_ˆ*)
	`pmd_·ge_vaddr
(*
pmd
);

400  
	`phys_±e_š™
(
±e
, 
add»ss
, 
’d
, 
´Ù
);

401 
	}
}

403 
__memš™


404 
	$phys_pmd_š™
(
pmd_t
 *
pmd_·ge
, 
add»ss
, 
’d
,

405 
·ge_size_mask
, 
pg´Ù_t
 
´Ù
)

407 
·ges
 = 0;

408 
Ï¡_m­_addr
 = 
’d
;

410 
i
 = 
	`pmd_šdex
(
add»ss
);

412 ; 
i
 < 
PTRS_PER_PMD
; i++, 
add»ss
 +ğ
PMD_SIZE
) {

413 
±e_phys
;

414 
pmd_t
 *
pmd
 = 
pmd_·ge
 + 
	`pmd_šdex
(
add»ss
);

415 
±e_t
 *
±e
;

416 
pg´Ù_t
 
Ãw_´Ù
 = 
´Ù
;

418 ià(
add»ss
 >ğ
’d
) {

419 ià(!
aá”_boÙmem
) {

420 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

421 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

426 ià(
	`pmd_v®
(*
pmd
)) {

427 ià(!
	`pmd_Ïrge
(*
pmd
)) {

428 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

429 
Ï¡_m­_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
add»ss
,

430 
’d
, 
´Ù
);

431 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

446 ià(
·ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

447 
·ges
++;

450 
Ãw_´Ù
 = 
	`±e_pg´Ù
(
	`±e_şrhuge
(*(
±e_t
 *)
pmd
));

453 ià(
·ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

454 
·ges
++;

455 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

456 
	`£t_±e
((
±e_t
 *)
pmd
,

457 
	`pâ_±e
(
add»ss
 >> 
PAGE_SHIFT
,

458 
	`__pg´Ù
(
	`pg´Ù_v®
(
´Ù
è| 
_PAGE_PSE
)));

459 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

460 
Ï¡_m­_addr
 = (
add»ss
 & 
PMD_MASK
è+ 
PMD_SIZE
;

464 
±e
 = 
	`®loc_low_·ge
(&
±e_phys
);

465 
Ï¡_m­_addr
 = 
	`phys_±e_š™
(
±e
, 
add»ss
, 
’d
, 
Ãw_´Ù
);

466 
	`unm­_low_·ge
(
±e
);

468 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

469 
	`pmd_pİuÏ‹_k”Ãl
(&
š™_mm
, 
pmd
, 
	`__va
(
±e_phys
));

470 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

472 
	`upd©e_·ge_couÁ
(
PG_LEVEL_2M
, 
·ges
);

473  
Ï¡_m­_addr
;

474 
	}
}

476 
__memš™


477 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
add»ss
, 
’d
,

478 
·ge_size_mask
, 
pg´Ù_t
 
´Ù
)

480 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

481 
Ï¡_m­_addr
;

483 
Ï¡_m­_addr
 = 
	`phys_pmd_š™
(
pmd
, 
add»ss
, 
’d
, 
·ge_size_mask
, 
´Ù
);

484 
	`__æush_b_®l
();

485  
Ï¡_m­_addr
;

486 
	}
}

488 
__memš™


489 
	$phys_pud_š™
(
pud_t
 *
pud_·ge
, 
addr
, 
’d
,

490 
·ge_size_mask
)

492 
·ges
 = 0;

493 
Ï¡_m­_addr
 = 
’d
;

494 
i
 = 
	`pud_šdex
(
addr
);

496 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add¸& 
PUD_MASK
è+ 
PUD_SIZE
) {

497 
pmd_phys
;

498 
pud_t
 *
pud
 = 
pud_·ge
 + 
	`pud_šdex
(
addr
);

499 
pmd_t
 *
pmd
;

500 
pg´Ù_t
 
´Ù
 = 
PAGE_KERNEL
;

502 ià(
addr
 >ğ
’d
)

505 ià(!
aá”_boÙmem
 &&

506 !
	`e820_ªy_m­³d
(
addr
,‡ddr+
PUD_SIZE
, 0)) {

507 
	`£t_pud
(
pud
, 
	`__pud
(0));

511 ià(
	`pud_v®
(*
pud
)) {

512 ià(!
	`pud_Ïrge
(*
pud
)) {

513 
Ï¡_m­_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
’d
,

514 
·ge_size_mask
, 
´Ù
);

529 ià(
·ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

530 
·ges
++;

533 
´Ù
 = 
	`±e_pg´Ù
(
	`±e_şrhuge
(*(
±e_t
 *)
pud
));

536 ià(
·ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

537 
·ges
++;

538 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

539 
	`£t_±e
((
±e_t
 *)
pud
,

540 
	`pâ_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

541 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

542 
Ï¡_m­_addr
 = (
addr
 & 
PUD_MASK
è+ 
PUD_SIZE
;

546 
pmd
 = 
	`®loc_low_·ge
(&
pmd_phys
);

547 
Ï¡_m­_addr
 = 
	`phys_pmd_š™
(
pmd
, 
addr
, 
’d
, 
·ge_size_mask
,

548 
´Ù
);

549 
	`unm­_low_·ge
(
pmd
);

551 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

552 
	`pud_pİuÏ‹
(&
š™_mm
, 
pud
, 
	`__va
(
pmd_phys
));

553 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

555 
	`__æush_b_®l
();

557 
	`upd©e_·ge_couÁ
(
PG_LEVEL_1G
, 
·ges
);

559  
Ï¡_m­_addr
;

560 
	}
}

562 
__memš™


563 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
’d
,

564 
·ge_size_mask
)

566 
pud_t
 *
pud
;

568 
pud
 = (
pud_t
 *)
	`pgd_·ge_vaddr
(*
pgd
);

570  
	`phys_pud_š™
(
pud
, 
addr
, 
’d
, 
·ge_size_mask
);

571 
	}
}

573 
__š™


574 
	$k”Ãl_physiÿl_m­pšg_š™
(
¡¬t
,

575 
’d
,

576 
·ge_size_mask
)

579 
Ãxt
, 
Ï¡_m­_addr
 = 
’d
;

581 
¡¬t
 = ()
	`__va
(start);

582 
’d
 = ()
	`__va
(end);

584 ; 
¡¬t
 < 
’d
; s¹ = 
Ãxt
) {

585 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
¡¬t
);

586 
pud_phys
;

587 
pud_t
 *
pud
;

589 
Ãxt
 = (
¡¬t
 + 
PGDIR_SIZE
è& 
PGDIR_MASK
;

590 ià(
Ãxt
 > 
’d
)

591 
Ãxt
 = 
’d
;

593 ià(
	`pgd_v®
(*
pgd
)) {

594 
Ï¡_m­_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__·
(
¡¬t
),

595 
	`__·
(
’d
), 
·ge_size_mask
);

599 
pud
 = 
	`®loc_low_·ge
(&
pud_phys
);

600 
Ï¡_m­_addr
 = 
	`phys_pud_š™
(
pud
, 
	`__·
(
¡¬t
), __·(
Ãxt
),

601 
·ge_size_mask
);

602 
	`unm­_low_·ge
(
pud
);

604 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

605 
	`pgd_pİuÏ‹
(&
š™_mm
, 
pgd
, 
	`__va
(
pud_phys
));

606 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

608 
	`__æush_b_®l
();

610  
Ï¡_m­_addr
;

611 
	}
}

613 #iâdeà
CONFIG_NUMA


614 
__š™
 
	$š™mem_š™
(
¡¬t_pâ
, 
’d_pâ
)

616 
boÙm­_size
, 
boÙm­
;

618 
boÙm­_size
 = 
	`boÙmem_boÙm­_·ges
(
’d_pâ
)<<
PAGE_SHIFT
;

619 
boÙm­
 = 
	`fšd_e820_¬—
(0, 
’d_pâ
<<
PAGE_SHIFT
, 
boÙm­_size
,

620 
PAGE_SIZE
);

621 ià(
boÙm­
 == -1L)

622 
	`·nic
("CªnÙ fšd boÙmem m­ oàsiz%ld\n", 
boÙm­_size
);

624 
boÙm­_size
 = 
	`š™_boÙmem_node
(
	`NODE_DATA
(0), 
boÙm­
 >> 
PAGE_SHIFT
,

625 0, 
’d_pâ
);

626 
	`e820_»gi¡”_aùive_»giÚs
(0, 
¡¬t_pâ
, 
’d_pâ
);

627 
	`ä“_boÙmem_w™h_aùive_»giÚs
(0, 
’d_pâ
);

628 
	`—¾y_»s_to_boÙmem
(0, 
’d_pâ
<<
PAGE_SHIFT
);

629 
	`»£rve_boÙmem
(
boÙm­
, 
boÙm­_size
, 
BOOTMEM_DEFAULT
);

630 
	}
}

632 
__š™
 
	$·gšg_š™
()

634 
max_zÚe_pâs
[
MAX_NR_ZONES
];

636 
	`mem£t
(
max_zÚe_pâs
, 0, (max_zone_pfns));

637 
max_zÚe_pâs
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

638 
max_zÚe_pâs
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

639 
max_zÚe_pâs
[
ZONE_NORMAL
] = 
max_pâ
;

641 
	`memÜy_´e£Á
(0, 0, 
max_pâ
);

642 
	`¥¬£_š™
();

643 
	`ä“_¬—_š™_nodes
(
max_zÚe_pâs
);

644 
	}
}

650 #ifdeà
CONFIG_MEMORY_HOTPLUG


655 
	$¬ch_add_memÜy
(
nid
, 
u64
 
¡¬t
, u64 
size
)

657 
pgli¡_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

658 
zÚe
 *zÚğ
pgd©
->
node_zÚes
 + 
ZONE_NORMAL
;

659 
Ï¡_m­³d_pâ
, 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

660 
Ä_·ges
 = 
size
 >> 
PAGE_SHIFT
;

661 
»t
;

663 
Ï¡_m­³d_pâ
 = 
	`š™_memÜy_m­pšg
(
¡¬t
, s¹ + 
size
);

664 ià(
Ï¡_m­³d_pâ
 > 
max_pâ_m­³d
)

665 
max_pâ_m­³d
 = 
Ï¡_m­³d_pâ
;

667 
»t
 = 
	`__add_·ges
(
nid
, 
zÚe
, 
¡¬t_pâ
, 
Ä_·ges
);

668 
	`WARN_ON_ONCE
(
»t
);

670  
»t
;

671 
	}
}

672 
EXPORT_SYMBOL_GPL
(
¬ch_add_memÜy
);

674 #ià!
defšed
(
CONFIG_ACPI_NUMA
è&& defšed(
CONFIG_NUMA
)

675 
	$memÜy_add_phy§ddr_to_nid
(
u64
 
¡¬t
)

678 
	}
}

679 
EXPORT_SYMBOL_GPL
(
memÜy_add_phy§ddr_to_nid
);

684 
kcÜe_li¡
 
	gkcÜe_mem
, 
	gkcÜe_vm®loc
, 
	gkcÜe_k”Ãl
,

685 
	gkcÜe_moduËs
, 
	gkcÜe_vsysÿÎ
;

687 
__š™
 
	$mem_š™
()

689 
codesize
, 
»£rved·ges
, 
d©asize
, 
š™size
;

690 
ab£Á_·ges
;

692 
	`pci_iommu_®loc
();

696 
»£rved·ges
 = 0;

699 #ifdeà
CONFIG_NUMA


700 
tÙ®¿m_·ges
 = 
	`numa_ä“_®l_boÙmem
();

702 
tÙ®¿m_·ges
 = 
	`ä“_®l_boÙmem
();

705 
ab£Á_·ges
 = 
	`ab£Á_·ges_š_¿nge
(0, 
max_pâ
);

706 
»£rved·ges
 = 
max_pâ
 - 
tÙ®¿m_·ges
 - 
ab£Á_·ges
;

707 
aá”_boÙmem
 = 1;

709 
codesize
 = (è&
_‘ext
 - (è&
_‹xt
;

710 
d©asize
 = (è&
_ed©a
 - (è&
_‘ext
;

711 
š™size
 = (è&
__š™_’d
 - (è&
__š™_begš
;

714 
	`kşi¡_add
(&
kcÜe_mem
, 
	`__va
(0), 
max_low_pâ
 << 
PAGE_SHIFT
);

715 
	`kşi¡_add
(&
kcÜe_vm®loc
, (*)
VMALLOC_START
,

716 
VMALLOC_END
-
VMALLOC_START
);

717 
	`kşi¡_add
(&
kcÜe_k”Ãl
, &
_¡ext
, 
_’d
 - _stext);

718 
	`kşi¡_add
(&
kcÜe_moduËs
, (*)
MODULES_VADDR
, 
MODULES_LEN
);

719 
	`kşi¡_add
(&
kcÜe_vsysÿÎ
, (*)
VSYSCALL_START
,

720 
VSYSCALL_END
 - 
VSYSCALL_START
);

722 
	`´štk
(
KERN_INFO
 "Memory: %luk/%luk‡vailable (%ldk kernel code, "

724 (è
	`Ä_ä“_·ges
(è<< (
PAGE_SHIFT
-10),

725 
max_pâ
 << (
PAGE_SHIFT
-10),

726 
codesize
 >> 10,

727 
ab£Á_·ges
 << (
PAGE_SHIFT
-10),

728 
»£rved·ges
 << (
PAGE_SHIFT
-10),

729 
d©asize
 >> 10,

730 
š™size
 >> 10);

731 
	}
}

733 #ifdeà
CONFIG_DEBUG_RODATA


734 cÚ¡ 
	grod©a_‹¡_d©a
 = 0xC3;

735 
EXPORT_SYMBOL_GPL
(
rod©a_‹¡_d©a
);

737 
	gk”Ãl_£t_to_»adÚly
;

739 
	$£t_k”Ãl_‹xt_rw
()

741 
¡¬t
 = 
	`PFN_ALIGN
(
_¡ext
);

742 
’d
 = 
	`PFN_ALIGN
(
__¡¬t_rod©a
);

744 ià(!
k”Ãl_£t_to_»adÚly
)

747 
	`´_debug
("Set kernelext: %lx - %lx for„ead write\n",

748 
¡¬t
, 
’d
);

750 
	`£t_memÜy_rw
(
¡¬t
, (
’d
 - s¹è>> 
PAGE_SHIFT
);

751 
	}
}

753 
	$£t_k”Ãl_‹xt_ro
()

755 
¡¬t
 = 
	`PFN_ALIGN
(
_¡ext
);

756 
’d
 = 
	`PFN_ALIGN
(
__¡¬t_rod©a
);

758 ià(!
k”Ãl_£t_to_»adÚly
)

761 
	`´_debug
("Set kernelext: %lx - %lx for„ead only\n",

762 
¡¬t
, 
’d
);

764 
	`£t_memÜy_ro
(
¡¬t
, (
’d
 - s¹è>> 
PAGE_SHIFT
);

765 
	}
}

767 
	$m¬k_rod©a_ro
()

769 
¡¬t
 = 
	`PFN_ALIGN
(
_¡ext
), 
’d
 = PFN_ALIGN(
__’d_rod©a
);

770 
rod©a_¡¬t
 =

771 (()
__¡¬t_rod©a
 + 
PAGE_SIZE
 - 1è& 
PAGE_MASK
;

773 
	`´štk
(
KERN_INFO
 "Write…rotectinghe kernel„ead-only data: %luk\n",

774 (
’d
 - 
¡¬t
) >> 10);

775 
	`£t_memÜy_ro
(
¡¬t
, (
’d
 - s¹è>> 
PAGE_SHIFT
);

777 
k”Ãl_£t_to_»adÚly
 = 1;

783 
	`£t_memÜy_nx
(
rod©a_¡¬t
, (
’d
 -„od©a_¡¬tè>> 
PAGE_SHIFT
);

785 
	`rod©a_‹¡
();

787 #ifdeà
CONFIG_CPA_DEBUG


788 
	`´štk
(
KERN_INFO
 "Te¡šg CPA: undØ%lx-%lx\n", 
¡¬t
, 
’d
);

789 
	`£t_memÜy_rw
(
¡¬t
, (
’d
-¡¬tè>> 
PAGE_SHIFT
);

791 
	`´štk
(
KERN_INFO
 "Testing CPA:‡gain\n");

792 
	`£t_memÜy_ro
(
¡¬t
, (
’d
-¡¬tè>> 
PAGE_SHIFT
);

794 
	}
}

798 
__š™
 
	$»£rve_boÙmem_g’”ic
(
phys
, 
Ën
,

799 
æags
)

801 #ifdeà
CONFIG_NUMA


802 
nid
, 
Ãxt_nid
;

803 
»t
;

805 
pâ
 = 
phys
 >> 
PAGE_SHIFT
;

807 ià(
pâ
 >ğ
max_pâ
) {

812 ià(
pâ
 < 
max_pâ_m­³d
)

813  -
EFAULT
;

815 
	`´štk
(
KERN_ERR
 "reserve_bootmem: illegal„eserve %lx %lu\n",

816 
phys
, 
Ën
);

817  -
EFAULT
;

821 #ifdeà
CONFIG_NUMA


822 
nid
 = 
	`phys_to_nid
(
phys
);

823 
Ãxt_nid
 = 
	`phys_to_nid
(
phys
 + 
Ën
 - 1);

824 ià(
nid
 =ğ
Ãxt_nid
)

825 
»t
 = 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Ën
, 
æags
);

827 
»t
 = 
	`»£rve_boÙmem
(
phys
, 
Ën
, 
æags
);

829 ià(
»t
 != 0)

830  
»t
;

833 
	`»£rve_boÙmem
(
phys
, 
Ën
, 
BOOTMEM_DEFAULT
);

836 ià(
phys
+
Ën
 <ğ
MAX_DMA_PFN
*
PAGE_SIZE
) {

837 
dma_»£rve
 +ğ
Ën
 / 
PAGE_SIZE
;

838 
	`£t_dma_»£rve
(
dma_»£rve
);

842 
	}
}

844 
	$k”n_addr_v®id
(
addr
)

846 
above
 = (()
addr
è>> 
__VIRTUAL_MASK_SHIFT
;

847 
pgd_t
 *
pgd
;

848 
pud_t
 *
pud
;

849 
pmd_t
 *
pmd
;

850 
±e_t
 *
±e
;

852 ià(
above
 != 0 &&‡bove != -1UL)

855 
pgd
 = 
	`pgd_off£t_k
(
addr
);

856 ià(
	`pgd_nÚe
(*
pgd
))

859 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

860 ià(
	`pud_nÚe
(*
pud
))

863 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

864 ià(
	`pmd_nÚe
(*
pmd
))

867 ià(
	`pmd_Ïrge
(*
pmd
))

868  
	`pâ_v®id
(
	`pmd_pâ
(*
pmd
));

870 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
addr
);

871 ià(
	`±e_nÚe
(*
±e
))

874  
	`pâ_v®id
(
	`±e_pâ
(*
±e
));

875 
	}
}

882 
vm_¬—_¡ruù
 
	gg©e_vma
 = {

883 .
vm_¡¬t
 = 
VSYSCALL_START
,

884 .
	gvm_’d
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

885 .
	gvm_·ge_´Ù
 = 
PAGE_READONLY_EXEC
,

886 .
	gvm_æags
 = 
VM_READ
 | 
VM_EXEC


889 
vm_¬—_¡ruù
 *
	$g‘_g©e_vma
(
sk_¡ruù
 *
tsk
)

891 #ifdeà
CONFIG_IA32_EMULATION


892 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
))

893  
NULL
;

895  &
g©e_vma
;

896 
	}
}

898 
	$š_g©e_¬—
(
sk_¡ruù
 *
sk
, 
addr
)

900 
vm_¬—_¡ruù
 *
vma
 = 
	`g‘_g©e_vma
(
sk
);

902 ià(!
vma
)

905  (
addr
 >ğ
vma
->
vm_¡¬t
è&& (add¸< vma->
vm_’d
);

906 
	}
}

913 
	$š_g©e_¬—_no_sk
(
addr
)

915  (
addr
 >ğ
VSYSCALL_START
è&& (add¸< 
VSYSCALL_END
);

916 
	}
}

918 cÚ¡ *
	$¬ch_vma_Çme
(
vm_¬—_¡ruù
 *
vma
)

920 ià(
vma
->
vm_mm
 && vma->
vm_¡¬t
 =ğ()vma->vm_mm->
cÚ‹xt
.
vdso
)

922 ià(
vma
 =ğ&
g©e_vma
)

924  
NULL
;

925 
	}
}

927 #ifdeà
CONFIG_SPARSEMEM_VMEMMAP


931 
__memš™d©a
 
	gaddr_¡¬t
, 
	gaddr_’d
;

932 
__memš™d©a
 *
	gp_¡¬t
, *
	gp_’d
;

933 
__memš™d©a
 
	gnode_¡¬t
;

935 
__memš™


936 
	$vmemm­_pİuÏ‹
(
·ge
 *
¡¬t_·ge
, 
size
, 
node
)

938 
addr
 = ()
¡¬t_·ge
;

939 
’d
 = ()(
¡¬t_·ge
 + 
size
);

940 
Ãxt
;

941 
pgd_t
 *
pgd
;

942 
pud_t
 *
pud
;

943 
pmd_t
 *
pmd
;

945 ; 
addr
 < 
’d
;‡dd¸ğ
Ãxt
) {

946 *
p
 = 
NULL
;

948 
pgd
 = 
	`vmemm­_pgd_pİuÏ‹
(
addr
, 
node
);

949 ià(!
pgd
)

950  -
ENOMEM
;

952 
pud
 = 
	`vmemm­_pud_pİuÏ‹
(
pgd
, 
addr
, 
node
);

953 ià(!
pud
)

954  -
ENOMEM
;

956 ià(!
ıu_has_p£
) {

957 
Ãxt
 = (
addr
 + 
PAGE_SIZE
è& 
PAGE_MASK
;

958 
pmd
 = 
	`vmemm­_pmd_pİuÏ‹
(
pud
, 
addr
, 
node
);

960 ià(!
pmd
)

961  -
ENOMEM
;

963 
p
 = 
	`vmemm­_±e_pİuÏ‹
(
pmd
, 
addr
, 
node
);

965 ià(!
p
)

966  -
ENOMEM
;

968 
addr_’d
 = 
addr
 + 
PAGE_SIZE
;

969 
p_’d
 = 
p
 + 
PAGE_SIZE
;

971 
Ãxt
 = 
	`pmd_addr_’d
(
addr
, 
’d
);

973 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

974 ià(
	`pmd_nÚe
(*
pmd
)) {

975 
±e_t
 
’Œy
;

977 
p
 = 
	`vmemm­_®loc_block
(
PMD_SIZE
, 
node
);

978 ià(!
p
)

979  -
ENOMEM
;

981 
’Œy
 = 
	`pâ_±e
(
	`__·
(
p
è>> 
PAGE_SHIFT
,

982 
PAGE_KERNEL_LARGE
);

983 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_v®
(
’Œy
)));

986 ià(
p_’d
 !ğ
p
 || 
node_¡¬t
 !ğ
node
) {

987 ià(
p_¡¬t
)

988 
	`´štk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] on‚ode %d\n",

989 
addr_¡¬t
, 
addr_’d
-1, 
p_¡¬t
, 
p_’d
-1, 
node_¡¬t
);

990 
addr_¡¬t
 = 
addr
;

991 
node_¡¬t
 = 
node
;

992 
p_¡¬t
 = 
p
;

995 
addr_’d
 = 
addr
 + 
PMD_SIZE
;

996 
p_’d
 = 
p
 + 
PMD_SIZE
;

998 
	`vmemm­_v”ify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
Ãxt
);

1003 
	}
}

1005 
__memš™
 
	$vmemm­_pİuÏ‹_´št_Ï¡
()

1007 ià(
p_¡¬t
) {

1008 
	`´štk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] on‚ode %d\n",

1009 
addr_¡¬t
, 
addr_’d
-1, 
p_¡¬t
, 
p_’d
-1, 
node_¡¬t
);

1010 
p_¡¬t
 = 
NULL
;

1011 
p_’d
 = 
NULL
;

1012 
node_¡¬t
 = 0;

1014 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<lšux/boÙmem.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/io.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/¦ab.h
>

14 
	~<lšux/vm®loc.h
>

15 
	~<lšux/mmiÙ¿û.h
>

17 
	~<asm/ÿcheæush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm­.h
>

20 
	~<asm/pgbË.h
>

21 
	~<asm/bæush.h
>

22 
	~<asm/pg®loc.h
>

23 
	~<asm/·t.h
>

25 
šlše
 
	$phys_addr_v®id
(
»sourû_size_t
 
addr
)

27 #ifdeà
CONFIG_PHYS_ADDR_T_64BIT


28  !(
addr
 >> 
boÙ_ıu_d©a
.
x86_phys_b™s
);

32 
	}
}

34 #ifdeà
CONFIG_X86_64


36 
	$__phys_addr
(
x
)

38 ià(
x
 >ğ
__START_KERNEL_m­
) {

39 
x
 -ğ
__START_KERNEL_m­
;

40 
	`VIRTUAL_BUG_ON
(
x
 >ğ
KERNEL_IMAGE_SIZE
);

41 
x
 +ğ
phys_ba£
;

43 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

44 
x
 -ğ
PAGE_OFFSET
;

45 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_v®id
(
x
));

47  
x
;

48 
	}
}

49 
EXPORT_SYMBOL
(
__phys_addr
);

51 
boŞ
 
	$__vœt_addr_v®id
(
x
)

53 ià(
x
 >ğ
__START_KERNEL_m­
) {

54 
x
 -ğ
__START_KERNEL_m­
;

55 ià(
x
 >ğ
KERNEL_IMAGE_SIZE
)

56  
çl£
;

57 
x
 +ğ
phys_ba£
;

59 ià(
x
 < 
PAGE_OFFSET
)

60  
çl£
;

61 
x
 -ğ
PAGE_OFFSET
;

62 ià(!
	`phys_addr_v®id
(
x
))

63  
çl£
;

66  
	`pâ_v®id
(
x
 >> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vœt_addr_v®id
);

72 #ifdeà
CONFIG_DEBUG_VIRTUAL


73 
	$__phys_addr
(
x
)

76 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

77 
	`VIRTUAL_BUG_ON
(
__vm®loc_¡¬t_£t
 && 
	`is_vm®loc_addr
((*è
x
));

78  
x
 - 
PAGE_OFFSET
;

79 
	}
}

80 
EXPORT_SYMBOL
(
__phys_addr
);

83 
boŞ
 
	$__vœt_addr_v®id
(
x
)

85 ià(
x
 < 
PAGE_OFFSET
)

86  
çl£
;

87 ià(
__vm®loc_¡¬t_£t
 && 
	`is_vm®loc_addr
((*è
x
))

88  
çl£
;

89 ià(
x
 >ğ
FIXADDR_START
)

90  
çl£
;

91  
	`pâ_v®id
((
x
 - 
PAGE_OFFSET
è>> 
PAGE_SHIFT
);

92 
	}
}

93 
EXPORT_SYMBOL
(
__vœt_addr_v®id
);

97 
	$·ge_is_¿m
(
·g’r
)

99 
»sourû_size_t
 
addr
, 
’d
;

100 
i
;

107 ià(
·g’r
 == 0)

114 ià(
·g’r
 >ğ(
BIOS_BEGIN
 >> 
PAGE_SHIFT
) &&

115 
·g’r
 < (
BIOS_END
 >> 
PAGE_SHIFT
))

118 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

122 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
)

124 
addr
 = (
e820
.
m­
[
i
].add¸+ 
PAGE_SIZE
-1è>> 
PAGE_SHIFT
;

125 
’d
 = (
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
è>> 
PAGE_SHIFT
;

128 ià((
·g’r
 >ğ
addr
è&& (·g’¸< 
’d
))

132 
	}
}

138 
	$iÜem­_chªge_©Œ
(
vaddr
, 
size
,

139 
´Ù_v®
)

141 
Ä·ges
 = 
size
 >> 
PAGE_SHIFT
;

142 
”r
;

144 
´Ù_v®
) {

145 
_PAGE_CACHE_UC
:

147 
”r
 = 
	`_£t_memÜy_uc
(
vaddr
, 
Ä·ges
);

149 
_PAGE_CACHE_WC
:

150 
”r
 = 
	`_£t_memÜy_wc
(
vaddr
, 
Ä·ges
);

152 
_PAGE_CACHE_WB
:

153 
”r
 = 
	`_£t_memÜy_wb
(
vaddr
, 
Ä·ges
);

157  
”r
;

158 
	}
}

169 
__iomem
 *
	$__iÜem­_ÿÎ”
(
»sourû_size_t
 
phys_addr
,

170 
size
, 
´Ù_v®
, *
ÿÎ”
)

172 
pâ
, 
off£t
, 
vaddr
;

173 
»sourû_size_t
 
Ï¡_addr
;

174 cÚ¡ 
»sourû_size_t
 
uÇligÃd_phys_addr
 = 
phys_addr
;

175 cÚ¡ 
uÇligÃd_size
 = 
size
;

176 
vm_¡ruù
 *
¬—
;

177 
Ãw_´Ù_v®
;

178 
pg´Ù_t
 
´Ù
;

179 
»tv®
;

180 
__iomem
 *
»t_addr
;

183 
Ï¡_addr
 = 
phys_addr
 + 
size
 - 1;

184 ià(!
size
 || 
Ï¡_addr
 < 
phys_addr
)

185  
NULL
;

187 ià(!
	`phys_addr_v®id
(
phys_addr
)) {

188 
	`´štk
(
KERN_WARNING
 "ioremap: invalid…hysical‡ddress %llx\n",

189 ()
phys_addr
);

190 
	`WARN_ON_ONCE
(1);

191  
NULL
;

197 ià(
	`is_ISA_¿nge
(
phys_addr
, 
Ï¡_addr
))

198  (
__fÜû
 
__iomem
 *)
	`phys_to_vœt
(
phys_addr
);

204 
	`WARN_ONCE
(
	`iomem_m­_§n™y_check
(
phys_addr
, 
size
),

205 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

210 
pâ
 = 
phys_addr
 >> 
PAGE_SHIFT
;

211 (
pâ
 << 
PAGE_SHIFT
è< (
Ï¡_addr
 & 
PAGE_MASK
);

212 
pâ
++) {

214 
is_¿m
 = 
	`·ge_is_¿m
(
pâ
);

216 ià(
is_¿m
 && 
	`pâ_v®id
(
pâ
è&& !
	`PageRe£rved
(
	`pâ_to_·ge
(pfn)))

217  
NULL
;

218 
	`WARN_ON_ONCE
(
is_¿m
);

224 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

225 
phys_addr
 &ğ
PAGE_MASK
;

226 
size
 = 
	`PAGE_ALIGN
(
Ï¡_addr
+1è- 
phys_addr
;

228 
»tv®
 = 
	`»£rve_memty³
(
phys_addr
, (
u64
íhys_add¸+ 
size
,

229 
´Ù_v®
, &
Ãw_´Ù_v®
);

230 ià(
»tv®
) {

231 
	`´_debug
("W¬nšg:„e£rve_memty³„‘uºed %d\n", 
»tv®
);

232  
NULL
;

235 ià(
´Ù_v®
 !ğ
Ãw_´Ù_v®
) {

243 ià((
´Ù_v®
 =ğ
_PAGE_CACHE_UC_MINUS
 &&

244 (
Ãw_´Ù_v®
 =ğ
_PAGE_CACHE_WB
 ||

245 
Ãw_´Ù_v®
 =ğ
_PAGE_CACHE_WC
)) ||

246 (
´Ù_v®
 =ğ
_PAGE_CACHE_WC
 &&

247 
Ãw_´Ù_v®
 =ğ
_PAGE_CACHE_WB
)) {

248 
	`´_debug
(

250 ()
phys_addr
,

251 ()(
phys_addr
 + 
size
),

252 
´Ù_v®
, 
Ãw_´Ù_v®
);

253 
	`ä“_memty³
(
phys_addr
,…hys_add¸+ 
size
);

254  
NULL
;

256 
´Ù_v®
 = 
Ãw_´Ù_v®
;

259 
´Ù_v®
) {

260 
_PAGE_CACHE_UC
:

262 
´Ù
 = 
PAGE_KERNEL_IO_NOCACHE
;

264 
_PAGE_CACHE_UC_MINUS
:

265 
´Ù
 = 
PAGE_KERNEL_IO_UC_MINUS
;

267 
_PAGE_CACHE_WC
:

268 
´Ù
 = 
PAGE_KERNEL_IO_WC
;

270 
_PAGE_CACHE_WB
:

271 
´Ù
 = 
PAGE_KERNEL_IO
;

278 
¬—
 = 
	`g‘_vm_¬—_ÿÎ”
(
size
, 
VM_IOREMAP
, 
ÿÎ”
);

279 ià(!
¬—
)

280  
NULL
;

281 
¬—
->
phys_addr
 =…hys_addr;

282 
vaddr
 = (è
¬—
->
addr
;

284 ià(
	`k”Ãl_m­_sync_memty³
(
phys_addr
, 
size
, 
´Ù_v®
)) {

285 
	`ä“_memty³
(
phys_addr
,…hys_add¸+ 
size
);

286 
	`ä“_vm_¬—
(
¬—
);

287  
NULL
;

290 ià(
	`iÜem­_·ge_¿nge
(
vaddr
, vadd¸+ 
size
, 
phys_addr
, 
´Ù
)) {

291 
	`ä“_memty³
(
phys_addr
,…hys_add¸+ 
size
);

292 
	`ä“_vm_¬—
(
¬—
);

293  
NULL
;

296 
»t_addr
 = (
__iomem
 *è(
vaddr
 + 
off£t
);

297 
	`mmiÙ¿û_iÜem­
(
uÇligÃd_phys_addr
, 
uÇligÃd_size
, 
»t_addr
);

299  
»t_addr
;

300 
	}
}

323 
__iomem
 *
	$iÜem­_noÿche
(
»sourû_size_t
 
phys_addr
, 
size
)

332 
v®
 = 
_PAGE_CACHE_UC_MINUS
;

334  
	`__iÜem­_ÿÎ”
(
phys_addr
, 
size
, 
v®
,

335 
	`__butš_»tuº_add»ss
(0));

336 
	}
}

337 
EXPORT_SYMBOL
(
iÜem­_noÿche
);

349 
__iomem
 *
	$iÜem­_wc
(
»sourû_size_t
 
phys_addr
, 
size
)

351 ià(
·t_’abËd
)

352  
	`__iÜem­_ÿÎ”
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

353 
	`__butš_»tuº_add»ss
(0));

355  
	`iÜem­_noÿche
(
phys_addr
, 
size
);

356 
	}
}

357 
EXPORT_SYMBOL
(
iÜem­_wc
);

359 
__iomem
 *
	$iÜem­_ÿche
(
»sourû_size_t
 
phys_addr
, 
size
)

361  
	`__iÜem­_ÿÎ”
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

362 
	`__butš_»tuº_add»ss
(0));

363 
	}
}

364 
EXPORT_SYMBOL
(
iÜem­_ÿche
);

366 
__iomem
 *
	$iÜem­_deçuÉ
(
»sourû_size_t
 
phys_addr
,

367 
size
)

369 
æags
;

370 
__iomem
 *
»t
;

371 
”r
;

378 
”r
 = 
	`»£rve_memty³
(
phys_addr
,…hys_add¸+ 
size
,

379 
_PAGE_CACHE_WB
, &
æags
);

380 ià(
”r
 < 0)

381  
NULL
;

383 
»t
 = 
	`__iÜem­_ÿÎ”
(
phys_addr
, 
size
, 
æags
,

384 
	`__butš_»tuº_add»ss
(0));

386 
	`ä“_memty³
(
phys_addr
,…hys_add¸+ 
size
);

387  
»t
;

388 
	}
}

390 
__iomem
 *
	$iÜem­_´Ù
(
»sourû_size_t
 
phys_addr
, 
size
,

391 
´Ù_v®
)

393  
	`__iÜem­_ÿÎ”
(
phys_addr
, 
size
, (
´Ù_v®
 & 
_PAGE_CACHE_MASK
),

394 
	`__butš_»tuº_add»ss
(0));

395 
	}
}

396 
EXPORT_SYMBOL
(
iÜem­_´Ù
);

404 
	$iounm­
(vŞ©
__iomem
 *
addr
)

406 
vm_¡ruù
 *
p
, *
o
;

408 ià((
__fÜû
 *)
addr
 <ğ
high_memÜy
)

416 ià((
__fÜû
 *)
addr
 >ğ
	`phys_to_vœt
(
ISA_START_ADDRESS
) &&

417 (
__fÜû
 *)
addr
 < 
	`phys_to_vœt
(
ISA_END_ADDRESS
))

420 
addr
 = (vŞ©
__iomem
 *)

421 (
PAGE_MASK
 & (
__fÜû
)
addr
);

423 
	`mmiÙ¿û_iounm­
(
addr
);

430 
	`»ad_lock
(&
vmli¡_lock
);

431 
p
 = 
vmli¡
;…;… =…->
Ãxt
) {

432 ià(
p
->
addr
 =ğ(
__fÜû
 *)addr)

435 
	`»ad_uÆock
(&
vmli¡_lock
);

437 ià(!
p
) {

438 
	`´štk
(
KERN_ERR
 "iounm­: bad‡dd»s %p\n", 
addr
);

439 
	`dump_¡ack
();

443 
	`ä“_memty³
(
p
->
phys_addr
,…->phys_add¸+ 
	`g‘_vm_¬—_size
(p));

446 
o
 = 
	`»move_vm_¬—
((
__fÜû
 *)
addr
);

447 
	`BUG_ON
(
p
 !ğ
o
 || o =ğ
NULL
);

448 
	`kä“
(
p
);

449 
	}
}

450 
EXPORT_SYMBOL
(
iounm­
);

456 *
	$xÏ‹_dev_mem_±r
(
phys
)

458 *
addr
;

459 
¡¬t
 = 
phys
 & 
PAGE_MASK
;

462 ià(
	`·ge_is_¿m
(
¡¬t
 >> 
PAGE_SHIFT
))

463  
	`__va
(
phys
);

465 
addr
 = (
__fÜû
 *)
	`iÜem­_deçuÉ
(
¡¬t
, 
PAGE_SIZE
);

466 ià(
addr
)

467 
addr
 = (*)((ïdd¸| (
phys
 & ~
PAGE_MASK
));

469  
addr
;

470 
	}
}

472 
	$unxÏ‹_dev_mem_±r
(
phys
, *
addr
)

474 ià(
	`·ge_is_¿m
(
phys
 >> 
PAGE_SHIFT
))

477 
	`iounm­
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

479 
	}
}

481 
__š™d©a
 
	g—¾y_iÜem­_debug
;

483 
__š™
 
	$—¾y_iÜem­_debug_£tup
(*
¡r
)

485 
—¾y_iÜem­_debug
 = 1;

488 
	}
}

489 
—¾y_·¿m
("—¾y_iÜem­_debug", 
—¾y_iÜem­_debug_£tup
);

491 
__š™d©a
 
	gaá”_·gšg_š™
;

492 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/Õ‹_t)] 
	g__·ge_®igÃd_bss
;

494 
šlše
 
pmd_t
 * 
__š™
 
	$—¾y_iÜem­_pmd
(
addr
)

497 
pgd_t
 *
ba£
 = 
	`__va
(
	`»ad_ü3
());

498 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_šdex
(
addr
)];

499 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

500 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

502  
pmd
;

503 
	}
}

505 
šlše
 
±e_t
 * 
__š™
 
	$—¾y_iÜem­_±e
(
addr
)

507  &
bm_±e
[
	`±e_šdex
(
addr
)];

508 
	}
}

510 
	g¦Ù_vœt
[
FIX_BTMAPS_SLOTS
] 
	g__š™d©a
;

512 
__š™
 
	$—¾y_iÜem­_š™
()

514 
pmd_t
 *
pmd
;

515 
i
;

517 ià(
—¾y_iÜem­_debug
)

518 
	`´štk
(
KERN_INFO
 "early_ioremap_init()\n");

520 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

521 
¦Ù_vœt
[
i
] = 
	`__fix_to_vœt
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

523 
pmd
 = 
	`—¾y_iÜem­_pmd
(
	`fix_to_vœt
(
FIX_BTMAP_BEGIN
));

524 
	`mem£t
(
bm_±e
, 0, (bm_pte));

525 
	`pmd_pİuÏ‹_k”Ãl
(&
š™_mm
, 
pmd
, 
bm_±e
);

531 ià(
pmd
 !ğ
	`—¾y_iÜem­_pmd
(
	`fix_to_vœt
(
FIX_BTMAP_END
))) {

532 
	`WARN_ON
(1);

533 
	`´štk
(
KERN_WARNING
 "pmd %p != %p\n",

534 
pmd
, 
	`—¾y_iÜem­_pmd
(
	`fix_to_vœt
(
FIX_BTMAP_END
)));

535 
	`´štk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

536 
	`fix_to_vœt
(
FIX_BTMAP_BEGIN
));

537 
	`´štk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

538 
	`fix_to_vœt
(
FIX_BTMAP_END
));

540 
	`´štk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

541 
	`´štk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

542 
FIX_BTMAP_BEGIN
);

544 
	}
}

546 
__š™
 
	$—¾y_iÜem­_»£t
()

548 
aá”_·gšg_š™
 = 1;

549 
	}
}

551 
__š™
 
	$__—¾y_£t_fixm­
(
fixed_add»s£s
 
idx
,

552 
phys_addr_t
 
phys
, 
pg´Ù_t
 
æags
)

554 
addr
 = 
	`__fix_to_vœt
(
idx
);

555 
±e_t
 *
±e
;

557 ià(
idx
 >ğ
__’d_of_fixed_add»s£s
) {

558 
	`BUG
();

561 
±e
 = 
	`—¾y_iÜem­_±e
(
addr
);

563 ià(
	`pg´Ù_v®
(
æags
))

564 
	`£t_±e
(
±e
, 
	`pâ_±e
(
phys
 >> 
PAGE_SHIFT
, 
æags
));

566 
	`±e_ş—r
(&
š™_mm
, 
addr
, 
±e
);

567 
	`__æush_b_Úe
(
addr
);

568 
	}
}

570 
šlše
 
__š™
 
	$—¾y_£t_fixm­
(
fixed_add»s£s
 
idx
,

571 
phys_addr_t
 
phys
, 
pg´Ù_t
 
´Ù
)

573 ià(
aá”_·gšg_š™
)

574 
	`__£t_fixm­
(
idx
, 
phys
, 
´Ù
);

576 
	`__—¾y_£t_fixm­
(
idx
, 
phys
, 
´Ù
);

577 
	}
}

579 
šlše
 
__š™
 
	$—¾y_ş—r_fixm­
(
fixed_add»s£s
 
idx
)

581 ià(
aá”_·gšg_š™
)

582 
	`ş—r_fixm­
(
idx
);

584 
	`__—¾y_£t_fixm­
(
idx
, 0, 
	`__pg´Ù
(0));

585 
	}
}

587 
__iomem
 *
	g´ev_m­
[
FIX_BTMAPS_SLOTS
] 
	g__š™d©a
;

588 
	g´ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__š™d©a
;

590 
__š™
 
	$check_—¾y_iÜem­_Ëak
()

592 
couÁ
 = 0;

593 
i
;

595 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

596 ià(
´ev_m­
[
i
])

597 
couÁ
++;

599 ià(!
couÁ
)

601 
	`WARN
(1, 
KERN_WARNING


603 
couÁ
);

604 
	`´štk
(
KERN_WARNING


608 
	}
}

609 
Ï‹_š™ÿÎ
(
check_—¾y_iÜem­_Ëak
);

611 
__š™
 
__iomem
 *

612 
	$__—¾y_iÜem­
(
»sourû_size_t
 
phys_addr
, 
size
, 
pg´Ù_t
 
´Ù
)

614 
off£t
;

615 
»sourû_size_t
 
Ï¡_addr
;

616 
Ä·ges
;

617 
fixed_add»s£s
 
idx0
, 
idx
;

618 
i
, 
¦Ù
;

620 
	`WARN_ON
(
sy¡em_¡©e
 !ğ
SYSTEM_BOOTING
);

622 
¦Ù
 = -1;

623 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

624 ià(!
´ev_m­
[
i
]) {

625 
¦Ù
 = 
i
;

630 ià(
¦Ù
 < 0) {

631 
	`´štk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)‚ot found slot\n",

632 (
u64
)
phys_addr
, 
size
);

633 
	`WARN_ON
(1);

634  
NULL
;

637 ià(
—¾y_iÜem­_debug
) {

638 
	`´štk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

639 (
u64
)
phys_addr
, 
size
, 
¦Ù
);

640 
	`dump_¡ack
();

644 
Ï¡_addr
 = 
phys_addr
 + 
size
 - 1;

645 ià(!
size
 || 
Ï¡_addr
 < 
phys_addr
) {

646 
	`WARN_ON
(1);

647  
NULL
;

650 
´ev_size
[
¦Ù
] = 
size
;

654 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

655 
phys_addr
 &ğ
PAGE_MASK
;

656 
size
 = 
	`PAGE_ALIGN
(
Ï¡_addr
 + 1è- 
phys_addr
;

661 
Ä·ges
 = 
size
 >> 
PAGE_SHIFT
;

662 ià(
Ä·ges
 > 
NR_FIX_BTMAPS
) {

663 
	`WARN_ON
(1);

664  
NULL
;

670 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¦Ù
;

671 
idx
 = 
idx0
;

672 
Ä·ges
 > 0) {

673 
	`—¾y_£t_fixm­
(
idx
, 
phys_addr
, 
´Ù
);

674 
phys_addr
 +ğ
PAGE_SIZE
;

675 --
idx
;

676 --
Ä·ges
;

678 ià(
—¾y_iÜem­_debug
)

679 
	`´štk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¦Ù_vœt
[
¦Ù
]);

681 
´ev_m­
[
¦Ù
] = (
__iomem
 *)(
off£t
 + 
¦Ù_vœt
[slot]);

682  
´ev_m­
[
¦Ù
];

683 
	}
}

686 
__š™
 
__iomem
 *

687 
	$—¾y_iÜem­
(
»sourû_size_t
 
phys_addr
, 
size
)

689  
	`__—¾y_iÜem­
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

690 
	}
}

693 
__š™
 
__iomem
 *

694 
	$—¾y_mem»m­
(
»sourû_size_t
 
phys_addr
, 
size
)

696  
	`__—¾y_iÜem­
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

697 
	}
}

699 
__š™
 
	$—¾y_iounm­
(
__iomem
 *
addr
, 
size
)

701 
vœt_addr
;

702 
off£t
;

703 
Ä·ges
;

704 
fixed_add»s£s
 
idx
;

705 
i
, 
¦Ù
;

707 
¦Ù
 = -1;

708 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

709 ià(
´ev_m­
[
i
] =ğ
addr
) {

710 
¦Ù
 = 
i
;

715 ià(
¦Ù
 < 0) {

716 
	`´štk
(
KERN_INFO
 "early_iounmap(%p, %08lx)‚ot found slot\n",

717 
addr
, 
size
);

718 
	`WARN_ON
(1);

722 ià(
´ev_size
[
¦Ù
] !ğ
size
) {

723 
	`´štk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] size‚ot consistent %08lx\n",

724 
addr
, 
size
, 
¦Ù
, 
´ev_size
[slot]);

725 
	`WARN_ON
(1);

729 ià(
—¾y_iÜem­_debug
) {

730 
	`´štk
(
KERN_INFO
 "—¾y_iounm­(%p, %08lxè[%d]\n", 
addr
,

731 
size
, 
¦Ù
);

732 
	`dump_¡ack
();

735 
vœt_addr
 = ()
addr
;

736 ià(
vœt_addr
 < 
	`fix_to_vœt
(
FIX_BTMAP_BEGIN
)) {

737 
	`WARN_ON
(1);

740 
off£t
 = 
vœt_addr
 & ~
PAGE_MASK
;

741 
Ä·ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1è>> 
PAGE_SHIFT
;

743 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¦Ù
;

744 
Ä·ges
 > 0) {

745 
	`—¾y_ş—r_fixm­
(
idx
);

746 --
idx
;

747 --
Ä·ges
;

749 
´ev_m­
[
¦Ù
] = 
NULL
;

750 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<lšux/pci_ids.h
>

16 
	~<lšux/aıi.h
>

17 
	~<asm/ty³s.h
>

18 
	~<asm/mmzÚe.h
>

19 
	~<asm/´Ùo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dœeù.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp¥ec.h
>

24 
	~<asm/­ic.h
>

25 
	~<asm/k8.h
>

27 
__š™
 
	$fšd_nÜthbridge
()

29 
num
;

31 
num
 = 0;‚um < 32;‚um++) {

32 
u32
 
h—d”
;

34 
h—d”
 = 
	`»ad_pci_cÚfig
(0, 
num
, 0, 0x00);

35 ià(
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

36 
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

37 
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

40 
h—d”
 = 
	`»ad_pci_cÚfig
(0, 
num
, 1, 0x00);

41 ià(
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

42 
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

43 
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

45  
num
;

49 
	}
}

51 
__š™
 
	$—¾y_g‘_boÙ_ıu_id
()

60 #ifdeà
CONFIG_X86_MPPARSE


61 
	`—¾y_fšd_smp_cÚfig
();

63 #ifdeà
CONFIG_ACPI


67 
	`—¾y_aıi_boÙ_š™
();

69 #ifdeà
CONFIG_X86_MPPARSE


73 ià(
smp_found_cÚfig
)

74 
	`—¾y_g‘_smp_cÚfig
();

76 
	`—¾y_š™_Ïpic_m­pšg
();

77 
	}
}

79 
__š™
 
	$k8_sÿn_nodes
(
¡¬t
, 
’d
)

81 
numnodes
, 
cÜes
, 
b™s
, 
­icid_ba£
;

82 
´evba£
;

83 
boÙnode
 
nodes
[8];

84 
i
, 
j
, 
nb
, 
found
 = 0;

85 
u32
 
nodeid
, 
»g
;

87 ià(!
	`—¾y_pci_®lowed
())

90 
nb
 = 
	`fšd_nÜthbridge
();

91 ià(
nb
 < 0)

92  
nb
;

94 
	`´štk
(
KERN_INFO
 "SÿÂšg NUMAİŞogy iÀNÜthbridg%d\n", 
nb
);

96 
»g
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 0, 0x60);

97 
numnodes
 = ((
»g
 >> 4) & 0xF) + 1;

98 ià(
numnodes
 <= 1)

101 
	`´štk
(
KERN_INFO
 "Numb” oànode %d\n", 
numnodes
);

103 
	`mem£t
(&
nodes
, 0, (nodes));

104 
´evba£
 = 0;

105 
i
 = 0; i < 8; i++) {

106 
ba£
, 
lim™
;

108 
ba£
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 1, 0x40 + 
i
*8);

109 
lim™
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 1, 0x44 + 
i
*8);

111 
nodeid
 = 
lim™
 & 7;

112 ià((
ba£
 & 3) == 0) {

113 ià(
i
 < 
numnodes
)

114 
	`´štk
("Skpšg di§bËd‚od%d\n", 
i
);

117 ià(
nodeid
 >ğ
numnodes
) {

118 
	`´štk
("IgnÜšgƒxûs nod%d (%lx:%lx)\n", 
nodeid
,

119 
ba£
, 
lim™
);

123 ià(!
lim™
) {

124 
	`´štk
(
KERN_INFO
 "Skipping‚odeƒntry %d (base %lx)\n",

125 
i
, 
ba£
);

128 ià((
ba£
 >> 8è& 3 || (
lim™
 >> 8) & 3) {

129 
	`´štk
(
KERN_ERR
 "Node %d using interleaving mode %lx/%lx\n",

130 
nodeid
, (
ba£
>>8)&3, (
lim™
>>8) & 3);

133 ià(
	`node_is£t
(
nodeid
, 
node_possibË_m­
)) {

134 
	`´štk
(
KERN_INFO
 "Node %d‡lready…resent. Skipping\n",

135 
nodeid
);

139 
lim™
 >>= 16;

140 
lim™
 <<= 24;

141 
lim™
 |= (1<<24)-1;

142 
lim™
++;

144 ià(
lim™
 > 
max_pâ
 << 
PAGE_SHIFT
)

145 
lim™
 = 
max_pâ
 << 
PAGE_SHIFT
;

146 ià(
lim™
 <ğ
ba£
)

149 
ba£
 >>= 16;

150 
ba£
 <<= 24;

152 ià(
ba£
 < 
¡¬t
)

153 
ba£
 = 
¡¬t
;

154 ià(
lim™
 > 
’d
)

155 
lim™
 = 
’d
;

156 ià(
lim™
 =ğ
ba£
) {

157 
	`´štk
(
KERN_ERR
 "Em±y‚od%d\n", 
nodeid
);

160 ià(
lim™
 < 
ba£
) {

161 
	`´štk
(
KERN_ERR
 "Node %d bogus settings %lx-%lx.\n",

162 
nodeid
, 
ba£
, 
lim™
);

167 ià(
´evba£
 > 
ba£
) {

168 
	`´štk
(
KERN_ERR
 "Node map‚ot sorted %lx,%lx\n",

169 
´evba£
, 
ba£
);

173 
	`´štk
(
KERN_INFO
 "Node %d MemBase %016lx Limit %016lx\n",

174 
nodeid
, 
ba£
, 
lim™
);

176 
found
++;

178 
nodes
[
nodeid
].
¡¬t
 = 
ba£
;

179 
nodes
[
nodeid
].
’d
 = 
lim™
;

181 
´evba£
 = 
ba£
;

183 
	`node_£t
(
nodeid
, 
node_possibË_m­
);

186 ià(!
found
)

189 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 8, 
NULL
);

190 ià(
memnode_shiá
 < 0) {

191 
	`´štk
(
KERN_ERR
 "No NUMA‚ode hash function found. Contact maintainer\n");

194 
	`´štk
(
KERN_INFO
 "Usšg‚odhash shiá oà%d\n", 
memnode_shiá
);

197 
b™s
 = 
boÙ_ıu_d©a
.
x86_cÜeid_b™s
;

198 
cÜes
 = (1<<
b™s
);

199 
­icid_ba£
 = 0;

201 
	`—¾y_g‘_boÙ_ıu_id
();

202 ià(
boÙ_ıu_physiÿl_­icid
 > 0) {

203 
	`´štk
(
KERN_INFO
 "BSP APIC ID: %02x\n",

204 
boÙ_ıu_physiÿl_­icid
);

205 
­icid_ba£
 = 
boÙ_ıu_physiÿl_­icid
;

208 
i
 = 0; i < 8; i++) {

209 ià(
nodes
[
i
].
¡¬t
 =ğnodes[i].
’d
)

212 
	`e820_»gi¡”_aùive_»giÚs
(
i
,

213 
nodes
[
i
].
¡¬t
 >> 
PAGE_SHIFT
,

214 
nodes
[
i
].
’d
 >> 
PAGE_SHIFT
);

215 
j
 = 
­icid_ba£
; j < 
cÜes
 +‡picid_base; j++)

216 
­icid_to_node
[(
i
 << 
b™s
è+ 
j
] = i;

217 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

220 
	`numa_š™_¬¿y
();

222 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<lšux/³rsÚ®™y.h
>

28 
	~<lšux/mm.h
>

29 
	~<lšux/¿ndom.h
>

30 
	~<lšux/lim™s.h
>

31 
	~<lšux/sched.h
>

38 
	#MIN_GAP
 (128*1024*1024)

	)

39 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

44 
	$mm­_is_Ÿ32
()

46 #ifdeà
CONFIG_X86_32


49 #ifdeà
CONFIG_IA32_EMULATION


50 ià(
	`‹¡_th»ad_æag
(
TIF_IA32
))

54 
	}
}

56 
	$mm­_is_Ëgacy
()

58 ià(
cu¼’t
->
³rsÚ®™y
 & 
ADDR_COMPAT_LAYOUT
)

61 ià(
cu¼’t
->
sigÇl
->
¾im
[
RLIMIT_STACK
].
¾im_cur
 =ğ
RLIM_INFINITY
)

64  
sysùl_Ëgacy_va_Ïyout
;

65 
	}
}

67 
	$mm­_ºd
()

69 
ºd
 = 0;

75 ià(
cu¼’t
->
æags
 & 
PF_RANDOMIZE
) {

76 ià(
	`mm­_is_Ÿ32
())

77 
ºd
 = ()
	`g‘_¿ndom_št
() % (1<<8);

79 
ºd
 = ()(
	`g‘_¿ndom_št
() % (1<<28));

81  
ºd
 << 
PAGE_SHIFT
;

82 
	}
}

84 
	$mm­_ba£
()

86 
g­
 = 
cu¼’t
->
sigÇl
->
¾im
[
RLIMIT_STACK
].
¾im_cur
;

88 ià(
g­
 < 
MIN_GAP
)

89 
g­
 = 
MIN_GAP
;

90 ià(
g­
 > 
MAX_GAP
)

91 
g­
 = 
MAX_GAP
;

93  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g­
 - 
	`mm­_ºd
());

94 
	}
}

100 
	$mm­_Ëgacy_ba£
()

102 ià(
	`mm­_is_Ÿ32
())

103  
TASK_UNMAPPED_BASE
;

105  
TASK_UNMAPPED_BASE
 + 
	`mm­_ºd
();

106 
	}
}

112 
	$¬ch_pick_mm­_Ïyout
(
mm_¡ruù
 *
mm
)

114 ià(
	`mm­_is_Ëgacy
()) {

115 
mm
->
mm­_ba£
 = 
	`mm­_Ëgacy_ba£
();

116 
mm
->
g‘_unm­³d_¬—
 = 
¬ch_g‘_unm­³d_¬—
;

117 
mm
->
unm­_¬—
 = 
¬ch_unm­_¬—
;

119 
mm
->
mm­_ba£
 = 
	`mm­_ba£
();

120 
mm
->
g‘_unm­³d_¬—
 = 
¬ch_g‘_unm­³d_¬—_tİdown
;

121 
mm
->
unm­_¬—
 = 
¬ch_unm­_¬—_tİdown
;

123 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<lšux/tİŞogy.h
>

3 
	~<lšux/moduË.h
>

4 
	~<lšux/boÙmem.h
>

6 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


7 
	#DBG
(
x
...è
	`´štk
(
KERN_DEBUG
 x)

	)

9 
	#DBG
(
x
...)

	)

15 
ıumask_v¬_t
 
	gnode_to_ıumask_m­
[
MAX_NUMNODES
];

16 
EXPORT_SYMBOL
(
node_to_ıumask_m­
);

25 
__š™
 
	$£tup_node_to_ıumask_m­
()

27 
node
, 
num
 = 0;

30 ià(
Ä_node_ids
 =ğ
MAX_NUMNODES
) {

31 
	`fÜ_—ch_node_mask
(
node
, 
node_possibË_m­
)

32 
num
 = 
node
;

33 
Ä_node_ids
 = 
num
 + 1;

37 
node
 = 0;‚od< 
Ä_node_ids
;‚ode++)

38 
	`®loc_boÙmem_ıumask_v¬
(&
node_to_ıumask_m­
[
node
]);

41 
	`´_debug
("NodtØıumask m­ fÜ %d‚odes\n", 
Ä_node_ids
);

42 
	}
}

44 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


48 cÚ¡ 
ıumask
 *
	$ıumask_of_node
(
node
)

50 ià(
node
 >ğ
Ä_node_ids
) {

51 
	`´štk
(
KERN_WARNING


53 
node
, 
Ä_node_ids
);

54 
	`dump_¡ack
();

55  
ıu_nÚe_mask
;

57 ià(
node_to_ıumask_m­
[
node
] =ğ
NULL
) {

58 
	`´štk
(
KERN_WARNING


60 
node
);

61 
	`dump_¡ack
();

62  
ıu_Úlše_mask
;

64  
node_to_ıumask_m­
[
node
];

65 
	}
}

66 
EXPORT_SYMBOL
(
ıumask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/boÙmem.h
>

10 
	~<lšux/mmzÚe.h
>

11 
	~<lšux/ùy³.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/nodemask.h
>

14 
	~<lšux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/´Ùo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/aıi.h
>

21 
	~<asm/k8.h
>

23 
pgli¡_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__»ad_mo¡ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g­icid_to_node
[
MAX_LOCAL_APIC
] 
	g__ıuš™d©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__š™d©a
;

33 
__š™d©a
 
	gnodem­_addr
;

34 
__š™d©a
 
	gnodem­_size
;

36 
DEFINE_PER_CPU
(, 
node_numb”
) = 0;

37 
EXPORT_PER_CPU_SYMBOL
(
node_numb”
);

42 
DEFINE_EARLY_PER_CPU
(, 
x86_ıu_to_node_m­
, 
NUMA_NO_NODE
);

43 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_ıu_to_node_m­
);

52 
__š™
 
	$pİuÏ‹_memnodem­
(cÚ¡ 
boÙnode
 *
nodes
,

53 
numnodes
, 
shiá
, *
nodeids
)

55 
addr
, 
’d
;

56 
i
, 
»s
 = -1;

58 
	`mem£t
(
memnodem­
, 0xff, (
s16
)*
memnodem­size
);

59 
i
 = 0; i < 
numnodes
; i++) {

60 
addr
 = 
nodes
[
i
].
¡¬t
;

61 
’d
 = 
nodes
[
i
].end;

62 ià(
addr
 >ğ
’d
)

64 ià((
’d
 >> 
shiá
è>ğ
memnodem­size
)

67 ià(
memnodem­
[
addr
 >> 
shiá
] !ğ
NUMA_NO_NODE
)

70 ià(!
nodeids
)

71 
memnodem­
[
addr
 >> 
shiá
] = 
i
;

73 
memnodem­
[
addr
 >> 
shiá
] = 
nodeids
[
i
];

75 
addr
 +ğ(1UL << 
shiá
);

76 } 
addr
 < 
’d
);

77 
»s
 = 1;

79  
»s
;

80 
	}
}

82 
__š™
 
	$®loÿ‹_ÿch—ligÃd_memnodem­
()

84 
addr
;

86 
memnodem­
 = 
memnode
.
embedded_m­
;

87 ià(
memnodem­size
 <ğ
	`ARRAY_SIZE
(
memnode
.
embedded_m­
))

90 
addr
 = 0x8000;

91 
nodem­_size
 = 
	`roundup
((
s16
è* 
memnodem­size
, 
L1_CACHE_BYTES
);

92 
nodem­_addr
 = 
	`fšd_e820_¬—
(
addr
, 
max_pâ
<<
PAGE_SHIFT
,

93 
nodem­_size
, 
L1_CACHE_BYTES
);

94 ià(
nodem­_addr
 == -1UL) {

95 
	`´štk
(
KERN_ERR


97 
nodem­_addr
 = 
nodem­_size
 = 0;

100 
memnodem­
 = 
	`phys_to_vœt
(
nodem­_addr
);

101 
	`»£rve_—¾y
(
nodem­_addr
,‚odem­_add¸+ 
nodem­_size
, "MEMNODEMAP");

103 
	`´štk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

104 
nodem­_addr
,‚odem­_add¸+ 
nodem­_size
);

106 
	}
}

112 
__š™
 
	$exŒaù_lsb_äom_nodes
(cÚ¡ 
boÙnode
 *
nodes
,

113 
numnodes
)

115 
i
, 
nodes_u£d
 = 0;

116 
¡¬t
, 
’d
;

117 
b™f›ld
 = 0, 
memtİ
 = 0;

119 
i
 = 0; i < 
numnodes
; i++) {

120 
¡¬t
 = 
nodes
[
i
].start;

121 
’d
 = 
nodes
[
i
].end;

122 ià(
¡¬t
 >ğ
’d
)

124 
b™f›ld
 |ğ
¡¬t
;

125 
nodes_u£d
++;

126 ià(
’d
 > 
memtİ
)

127 
memtİ
 = 
’d
;

129 ià(
nodes_u£d
 <= 1)

130 
i
 = 63;

132 
i
 = 
	`fšd_fœ¡_b™
(&
b™f›ld
, ()*8);

133 
memnodem­size
 = (
memtİ
 >> 
i
)+1;

134  
i
;

135 
	}
}

137 
__š™
 
	$compu‹_hash_shiá
(
boÙnode
 *
nodes
, 
numnodes
,

138 *
nodeids
)

140 
shiá
;

142 
shiá
 = 
	`exŒaù_lsb_äom_nodes
(
nodes
, 
numnodes
);

143 ià(
	`®loÿ‹_ÿch—ligÃd_memnodem­
())

145 
	`´štk
(
KERN_DEBUG
 "NUMA: Using %d forhe hash shift.\n",

146 
shiá
);

148 ià(
	`pİuÏ‹_memnodem­
(
nodes
, 
numnodes
, 
shiá
, 
nodeids
) != 1) {

149 
	`´štk
(
KERN_INFO
 "Your memory is‚ot‡ligned you‚eedo "

151 "shiá=%d\n", 
shiá
);

154  
shiá
;

155 
	}
}

157 
__memš™
 
	$__—¾y_pâ_to_nid
(
pâ
)

159  
	`phys_to_nid
(
pâ
 << 
PAGE_SHIFT
);

160 
	}
}

162 * 
__š™
 
	$—¾y_node_mem
(
nodeid
, 
¡¬t
,

163 
’d
, 
size
,

164 
®ign
)

166 
mem
 = 
	`fšd_e820_¬—
(
¡¬t
, 
’d
, 
size
, 
®ign
);

167 *
±r
;

169 ià(
mem
 != -1L)

170  
	`__va
(
mem
);

172 
±r
 = 
	`__®loc_boÙmem_nİªic
(
size
, 
®ign
, 
	`__·
(
MAX_DMA_ADDRESS
));

173 ià(
±r
 =ğ
NULL
) {

174 
	`´štk
(
KERN_ERR
 "Cannot find %lu bytes in‚ode %d\n",

175 
size
, 
nodeid
);

176  
NULL
;

178  
±r
;

179 
	}
}

182 
__š™
 
	$£tup_node_boÙmem
(
nodeid
, 
¡¬t
,

183 
’d
)

185 
¡¬t_pâ
, 
Ï¡_pâ
, 
boÙm­_·ges
, 
boÙm­_size
;

186 
boÙm­_¡¬t
, 
noded©a_phys
;

187 *
boÙm­
;

188 cÚ¡ 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

189 
nid
;

191 ià(!
’d
)

194 
¡¬t
 = 
	`roundup
(¡¬t, 
ZONE_ALIGN
);

196 
	`´štk
(
KERN_INFO
 "BoÙmem s‘u°nod%d %016lx-%016lx\n", 
nodeid
,

197 
¡¬t
, 
’d
);

199 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

200 
Ï¡_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

202 
node_d©a
[
nodeid
] = 
	`—¾y_node_mem
Òodeid, 
¡¬t
, 
’d
, 
pgd©_size
,

203 
SMP_CACHE_BYTES
);

204 ià(
node_d©a
[
nodeid
] =ğ
NULL
)

206 
noded©a_phys
 = 
	`__·
(
node_d©a
[
nodeid
]);

207 
	`´štk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

208 
noded©a_phys
 + 
pgd©_size
 - 1);

210 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

211 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boÙmem_node_d©a
[nodeid];

212 
	`NODE_DATA
(
nodeid
)->
node_¡¬t_pâ
 = 
¡¬t_pâ
;

213 
	`NODE_DATA
(
nodeid
)->
node_¥ªÃd_·ges
 = 
Ï¡_pâ
 - 
¡¬t_pâ
;

222 
boÙm­_·ges
 = 
	`boÙmem_boÙm­_·ges
(
Ï¡_pâ
 - 
¡¬t_pâ
);

223 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

224 ià(
nid
 =ğ
nodeid
)

225 
boÙm­_¡¬t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

227 
boÙm­_¡¬t
 = 
	`roundup
(
¡¬t
, 
PAGE_SIZE
);

232 
boÙm­
 = 
	`—¾y_node_mem
(
nodeid
, 
boÙm­_¡¬t
, 
’d
,

233 
boÙm­_·ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

234 ià(
boÙm­
 =ğ
NULL
) {

235 ià(
noded©a_phys
 < 
¡¬t
 ||‚oded©a_phy >ğ
’d
)

236 
	`ä“_boÙmem
(
noded©a_phys
, 
pgd©_size
);

237 
node_d©a
[
nodeid
] = 
NULL
;

240 
boÙm­_¡¬t
 = 
	`__·
(
boÙm­
);

242 
boÙm­_size
 = 
	`š™_boÙmem_node
(
	`NODE_DATA
(
nodeid
),

243 
boÙm­_¡¬t
 >> 
PAGE_SHIFT
,

244 
¡¬t_pâ
, 
Ï¡_pâ
);

246 
	`´štk
(
KERN_INFO
 " bootmap [%016lx - %016lx]…ages %lx\n",

247 
boÙm­_¡¬t
, boÙm­_¡¬ˆ+ 
boÙm­_size
 - 1,

248 
boÙm­_·ges
);

250 
	`ä“_boÙmem_w™h_aùive_»giÚs
(
nodeid
, 
’d
);

257 
	`—¾y_»s_to_boÙmem
(
¡¬t
, 
’d
);

263 ià(
nid
 !ğ
nodeid
)

264 
	`´štk
(
KERN_INFO
 " NODE_DATA(%dèÚ‚od%d\n", 
nodeid
, 
nid
);

266 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
noded©a_phys
,

267 
pgd©_size
, 
BOOTMEM_DEFAULT
);

268 
nid
 = 
	`phys_to_nid
(
boÙm­_¡¬t
);

269 ià(
nid
 !ğ
nodeid
)

270 
	`´štk
(
KERN_INFO
 " boÙm­(%dèÚ‚od%d\n", 
nodeid
, 
nid
);

272 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
boÙm­_¡¬t
,

273 
boÙm­_·ges
<<
PAGE_SHIFT
, 
BOOTMEM_DEFAULT
);

275 #ifdeà
CONFIG_ACPI_NUMA


276 
	`¤©_»£rve_add_¬—
(
nodeid
);

278 
	`node_£t_Úlše
(
nodeid
);

279 
	}
}

288 
__š™
 
	$numa_š™_¬¿y
()

290 
¼
, 
i
;

292 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

293 
i
 = 0; i < 
Ä_ıu_ids
; i++) {

294 ià(
	`—¾y_ıu_to_node
(
i
è!ğ
NUMA_NO_NODE
)

296 
	`numa_£t_node
(
i
, 
¼
);

297 
¼
 = 
	`Ãxt_node
Ôr, 
node_Úlše_m­
);

298 ià(
¼
 =ğ
MAX_NUMNODES
)

299 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

301 
	}
}

303 #ifdeà
CONFIG_NUMA_EMU


305 *
cmdlše
 
	g__š™d©a
;

314 
__š™
 
	$£tup_node_¿nge
(
nid
, 
boÙnode
 *
nodes
, 
u64
 *
addr
,

315 
u64
 
size
, u64 
max_addr
)

317 
»t
 = 0;

319 
nodes
[
nid
].
¡¬t
 = *
addr
;

320 *
addr
 +ğ
size
;

321 ià(*
addr
 >ğ
max_addr
) {

322 *
addr
 = 
max_addr
;

323 
»t
 = -1;

325 
nodes
[
nid
].
’d
 = *
addr
;

326 
	`node_£t
(
nid
, 
node_possibË_m­
);

327 
	`´štk
(
KERN_INFO
 "Fakšg‚od%d‡ˆ%016Lx-%016Lx (%LuMB)\n", 
nid
,

328 
nodes
[
nid
].
¡¬t
,‚odes[nid].
’d
,

329 (
nodes
[
nid
].
’d
 -‚odes[nid].
¡¬t
) >> 20);

330  
»t
;

331 
	}
}

338 
__š™
 
	$¥l™_nodes_equ®ly
(
boÙnode
 *
nodes
, 
u64
 *
addr
,

339 
u64
 
max_addr
, 
node_¡¬t
,

340 
num_nodes
)

342 
big
;

343 
u64
 
size
;

344 
i
;

346 ià(
num_nodes
 <= 0)

348 ià(
num_nodes
 > 
MAX_NUMNODES
)

349 
num_nodes
 = 
MAX_NUMNODES
;

350 
size
 = (
max_addr
 - *
addr
 - 
	`e820_hŞe_size
(*addr, max_addr)) /

351 
num_nodes
;

356 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
è* 
num_nodes
) /

357 
FAKE_NODE_MIN_SIZE
;

360 
size
 &ğ
FAKE_NODE_MIN_HASH_MASK
;

361 ià(!
size
) {

362 
	`´štk
(
KERN_ERR
 "Notƒnough memory forƒach‚ode. "

367 
i
 = 
node_¡¬t
; i < 
num_nodes
 +‚ode_start; i++) {

368 
u64
 
’d
 = *
addr
 + 
size
;

370 ià(
i
 < 
big
)

371 
’d
 +ğ
FAKE_NODE_MIN_SIZE
;

376 ià(
i
 =ğ
num_nodes
 + 
node_¡¬t
 - 1)

377 
’d
 = 
max_addr
;

379 
’d
 - *
addr
 - 
	`e820_hŞe_size
(*addr,ƒnd) <

380 
size
) {

381 
’d
 +ğ
FAKE_NODE_MIN_SIZE
;

382 ià(
’d
 > 
max_addr
) {

383 
’d
 = 
max_addr
;

387 ià(
	`£tup_node_¿nge
(
i
, 
nodes
, 
addr
, 
’d
 - *addr, 
max_addr
) < 0)

390  
i
 - 
node_¡¬t
 + 1;

391 
	}
}

398 
__š™
 
	$¥l™_nodes_by_size
(
boÙnode
 *
nodes
, 
u64
 *
addr
,

399 
u64
 
max_addr
, 
node_¡¬t
, u64 
size
)

401 
i
 = 
node_¡¬t
;

402 
size
 = (siz<< 20è& 
FAKE_NODE_MIN_HASH_MASK
;

403 !
	`£tup_node_¿nge
(
i
++, 
nodes
, 
addr
, 
size
, 
max_addr
))

405  
i
 - 
node_¡¬t
;

406 
	}
}

412 
boÙnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__š™d©a
;

414 
__š™
 
	$numa_emuÏtiÚ
(
¡¬t_pâ
, 
Ï¡_pâ
)

416 
u64
 
size
, 
addr
 = 
¡¬t_pâ
 << 
PAGE_SHIFT
;

417 
u64
 
max_addr
 = 
Ï¡_pâ
 << 
PAGE_SHIFT
;

418 
num_nodes
 = 0, 
num
 = 0, 
cÛff_æag
, 
cÛff
 = -1, 
i
;

420 
	`mem£t
(&
nodes
, 0, (nodes));

425 ià(!
	`¡rchr
(
cmdlše
, '*') && !strchr(cmdline, ',')) {

426 
n
 = 
	`sim¶e_¡¹Ş
(
cmdlše
, 
NULL
, 0);

428 
num_nodes
 = 
	`¥l™_nodes_equ®ly
(
nodes
, &
addr
, 
max_addr
, 0, 
n
);

429 ià(
num_nodes
 < 0)

430  
num_nodes
;

431 
out
;

435 
cÛff_æag
 = 0; ; 
cmdlše
++) {

436 ià(*
cmdlše
 && 
	`isdig™
(*cmdline)) {

437 
num
 =‚um * 10 + *
cmdlše
 - '0';

440 ià(*
cmdlše
 == '*') {

441 ià(
num
 > 0)

442 
cÛff
 = 
num
;

443 
cÛff_æag
 = 1;

445 ià(!*
cmdlše
 || *cmdline == ',') {

446 ià(!
cÛff_æag
)

447 
cÛff
 = 1;

452 
size
 = ((
u64
)
num
 << 20è& 
FAKE_NODE_MIN_HASH_MASK
;

453 ià(
size
)

454 
i
 = 0; i < 
cÛff
; i++, 
num_nodes
++)

455 ià(
	`£tup_node_¿nge
(
num_nodes
, 
nodes
,

456 &
addr
, 
size
, 
max_addr
) < 0)

457 
dÚe
;

458 ià(!*
cmdlše
)

460 
cÛff_æag
 = 0;

461 
cÛff
 = -1;

463 
num
 = 0;

465 
dÚe
:

466 ià(!
num_nodes
)

469 ià(
addr
 < 
max_addr
) {

470 ià(
cÛff_æag
 && 
cÛff
 < 0) {

472 
num_nodes
 +ğ
	`¥l™_nodes_by_size
(
nodes
, &
addr
, 
max_addr
,

473 
num_nodes
, 
num
);

474 
out
;

476 *(
cmdlše
 - 1)) {

479 ià(
cÛff
 <= 0)

481 
num_nodes
 +ğ
	`¥l™_nodes_equ®ly
(
nodes
, &
addr
, 
max_addr
,

482 
num_nodes
, 
cÛff
);

489 
	`£tup_node_¿nge
(
num_nodes
, 
nodes
, &
addr
,

490 
max_addr
 - 
addr
, max_addr);

491 
num_nodes
++;

494 
out
:

495 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 
num_nodes
, 
NULL
);

496 ià(
memnode_shiá
 < 0) {

497 
memnode_shiá
 = 0;

498 
	`´štk
(
KERN_ERR
 "No NUMA hash function found. NUMAƒmulation "

508 
	`»move_®l_aùive_¿nges
();

509 #ifdeà
CONFIG_ACPI_NUMA


510 
aıi_numa
 = -1;

512 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
) {

513 
	`e820_»gi¡”_aùive_»giÚs
(
i
, 
nodes
[i].
¡¬t
 >> 
PAGE_SHIFT
,

514 
nodes
[
i
].
’d
 >> 
PAGE_SHIFT
);

515 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

517 
	`aıi_çke_nodes
(
nodes
, 
num_nodes
);

518 
	`numa_š™_¬¿y
();

520 
	}
}

523 
__š™
 
	$š™mem_š™
(
¡¬t_pâ
, 
Ï¡_pâ
)

525 
i
;

527 
	`nodes_ş—r
(
node_possibË_m­
);

528 
	`nodes_ş—r
(
node_Úlše_m­
);

530 #ifdeà
CONFIG_NUMA_EMU


531 ià(
cmdlše
 && !
	`numa_emuÏtiÚ
(
¡¬t_pâ
, 
Ï¡_pâ
))

533 
	`nodes_ş—r
(
node_possibË_m­
);

534 
	`nodes_ş—r
(
node_Úlše_m­
);

537 #ifdeà
CONFIG_ACPI_NUMA


538 ià(!
numa_off
 && !
	`aıi_sÿn_nodes
(
¡¬t_pâ
 << 
PAGE_SHIFT
,

539 
Ï¡_pâ
 << 
PAGE_SHIFT
))

541 
	`nodes_ş—r
(
node_possibË_m­
);

542 
	`nodes_ş—r
(
node_Úlše_m­
);

545 #ifdeà
CONFIG_K8_NUMA


546 ià(!
numa_off
 && !
	`k8_sÿn_nodes
(
¡¬t_pâ
<<
PAGE_SHIFT
,

547 
Ï¡_pâ
<<
PAGE_SHIFT
))

549 
	`nodes_ş—r
(
node_possibË_m­
);

550 
	`nodes_ş—r
(
node_Úlše_m­
);

552 
	`´štk
(
KERN_INFO
 "%s\n",

553 
numa_off
 ? "NUMAurned off" : "No NUMA configuration found");

555 
	`´štk
(
KERN_INFO
 "Faking‡‚ode‡t %016lx-%016lx\n",

556 
¡¬t_pâ
 << 
PAGE_SHIFT
,

557 
Ï¡_pâ
 << 
PAGE_SHIFT
);

559 
memnode_shiá
 = 63;

560 
memnodem­
 = 
memnode
.
embedded_m­
;

561 
memnodem­
[0] = 0;

562 
	`node_£t_Úlše
(0);

563 
	`node_£t
(0, 
node_possibË_m­
);

564 
i
 = 0; i < 
Ä_ıu_ids
; i++)

565 
	`numa_£t_node
(
i
, 0);

566 
	`e820_»gi¡”_aùive_»giÚs
(0, 
¡¬t_pâ
, 
Ï¡_pâ
);

567 
	`£tup_node_boÙmem
(0, 
¡¬t_pâ
 << 
PAGE_SHIFT
, 
Ï¡_pâ
 << PAGE_SHIFT);

568 
	}
}

570 
__š™
 
	$numa_ä“_®l_boÙmem
()

572 
·ges
 = 0;

573 
i
;

575 
	`fÜ_—ch_Úlše_node
(
i
)

576 
·ges
 +ğ
	`ä“_®l_boÙmem_node
(
	`NODE_DATA
(
i
));

578  
·ges
;

579 
	}
}

581 
__š™
 
	$·gšg_š™
()

583 
max_zÚe_pâs
[
MAX_NR_ZONES
];

585 
	`mem£t
(
max_zÚe_pâs
, 0, (max_zone_pfns));

586 
max_zÚe_pâs
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

587 
max_zÚe_pâs
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

588 
max_zÚe_pâs
[
ZONE_NORMAL
] = 
max_pâ
;

590 
	`¥¬£_memÜy_´e£Á_w™h_aùive_»giÚs
(
MAX_NUMNODES
);

591 
	`¥¬£_š™
();

593 
	`ä“_¬—_š™_nodes
(
max_zÚe_pâs
);

594 
	}
}

596 
__š™
 
	$numa_£tup
(*
İt
)

598 ià(!
İt
)

599  -
EINVAL
;

600 ià(!
	`¡ºcmp
(
İt
, "off", 3))

601 
numa_off
 = 1;

602 #ifdeà
CONFIG_NUMA_EMU


603 ià(!
	`¡ºcmp
(
İt
, "fake=", 5))

604 
cmdlše
 = 
İt
 + 5;

606 #ifdeà
CONFIG_ACPI_NUMA


607 ià(!
	`¡ºcmp
(
İt
, "noacpi", 6))

608 
aıi_numa
 = -1;

609 ià(!
	`¡ºcmp
(
İt
, "hotadd=", 7))

610 
hÙadd_³rûÁ
 = 
	`sim¶e_¡¹oul
(
İt
+7, 
NULL
, 10);

613 
	}
}

614 
—¾y_·¿m
("numa", 
numa_£tup
);

616 #ifdeà
CONFIG_NUMA


631 
__š™
 
	$š™_ıu_to_node
()

633 
ıu
;

634 
u16
 *
ıu_to_­icid
 = 
	`—¾y_³r_ıu_±r
(
x86_ıu_to_­icid
);

636 
	`BUG_ON
(
ıu_to_­icid
 =ğ
NULL
);

638 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

639 
node
;

640 
u16
 
­icid
 = 
ıu_to_­icid
[
ıu
];

642 ià(
­icid
 =ğ
BAD_APICID
)

644 
node
 = 
­icid_to_node
[
­icid
];

645 ià(
node
 =ğ
NUMA_NO_NODE
)

647 ià(!
	`node_Úlše
(
node
))

649 
	`numa_£t_node
(
ıu
, 
node
);

651 
	}
}

655 
__ıuš™
 
	$numa_£t_node
(
ıu
, 
node
)

657 *
ıu_to_node_m­
 = 
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
);

660 ià(
ıu_to_node_m­
) {

661 
ıu_to_node_m­
[
ıu
] = 
node
;

665 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


666 ià(
ıu
 >ğ
Ä_ıu_ids
 || !
	`ıu_possibË
(cpu)) {

667 
	`´štk
(
KERN_ERR
 "numa_£t_node: inv®id cpu# (%d)\n", 
ıu
);

668 
	`dump_¡ack
();

672 
	`³r_ıu
(
x86_ıu_to_node_m­
, 
ıu
èğ
node
;

674 ià(
node
 !ğ
NUMA_NO_NODE
)

675 
	`³r_ıu
(
node_numb”
, 
ıu
èğ
node
;

676 
	}
}

678 
__ıuš™
 
	$numa_ş—r_node
(
ıu
)

680 
	`numa_£t_node
(
ıu
, 
NUMA_NO_NODE
);

681 
	}
}

683 #iâdeà
CONFIG_DEBUG_PER_CPU_MAPS


685 
__ıuš™
 
	$numa_add_ıu
(
ıu
)

687 
	`ıumask_£t_ıu
(
ıu
, 
node_to_ıumask_m­
[
	`—¾y_ıu_to_node
(cpu)]);

688 
	}
}

690 
__ıuš™
 
	$numa_»move_ıu
(
ıu
)

692 
	`ıumask_ş—r_ıu
(
ıu
, 
node_to_ıumask_m­
[
	`—¾y_ıu_to_node
(cpu)]);

693 
	}
}

700 
__ıuš™
 
	$numa_£t_ıumask
(
ıu
, 
’abË
)

702 
node
 = 
	`—¾y_ıu_to_node
(
ıu
);

703 
ıumask
 *
mask
;

704 
buf
[64];

706 
mask
 = 
node_to_ıumask_m­
[
node
];

707 ià(
mask
 =ğ
NULL
) {

708 
	`´štk
(
KERN_ERR
 "node_to_ıumask_m­[%i] NULL\n", 
node
);

709 
	`dump_¡ack
();

713 ià(
’abË
)

714 
	`ıumask_£t_ıu
(
ıu
, 
mask
);

716 
	`ıumask_ş—r_ıu
(
ıu
, 
mask
);

718 
	`ıuli¡_sú´štf
(
buf
, (buf), 
mask
);

719 
	`´štk
(
KERN_DEBUG
 "%s cpu %d‚ode %d: mask‚ow %s\n",

720 
’abË
 ? "numa_add_ıu" : "numa_»move_ıu", 
ıu
, 
node
, 
buf
);

721 
	}
}

723 
__ıuš™
 
	$numa_add_ıu
(
ıu
)

725 
	`numa_£t_ıumask
(
ıu
, 1);

726 
	}
}

728 
__ıuš™
 
	$numa_»move_ıu
(
ıu
)

730 
	`numa_£t_ıumask
(
ıu
, 0);

731 
	}
}

733 
	$ıu_to_node
(
ıu
)

735 ià(
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
)) {

736 
	`´štk
(
KERN_WARNING


737 "ıu_to_node(%d): u§gtoØ—¾y!\n", 
ıu
);

738 
	`dump_¡ack
();

739  
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
)[
ıu
];

741  
	`³r_ıu
(
x86_ıu_to_node_m­
, 
ıu
);

742 
	}
}

743 
EXPORT_SYMBOL
(
ıu_to_node
);

749 
	$—¾y_ıu_to_node
(
ıu
)

751 ià(
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
))

752  
	`—¾y_³r_ıu_±r
(
x86_ıu_to_node_m­
)[
ıu
];

754 ià(!
	`ıu_possibË
(
ıu
)) {

755 
	`´štk
(
KERN_WARNING


756 "—¾y_ıu_to_node(%d):‚Ø³r_ıu‡»a!\n", 
ıu
);

757 
	`dump_¡ack
();

758  
NUMA_NO_NODE
;

760  
	`³r_ıu
(
x86_ıu_to_node_m­
, 
ıu
);

761 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<lšux/highmem.h
>

6 
	~<lšux/boÙmem.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/¦ab.h
>

10 
	~<lšux/mm.h
>

11 
	~<lšux/š‹¼u±.h
>

12 
	~<lšux/£q_fe.h
>

13 
	~<lšux/debugfs.h
>

15 
	~<asm/e820.h
>

16 
	~<asm/´oûssÜ.h
>

17 
	~<asm/bæush.h
>

18 
	~<asm/£ùiÚs.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/uacûss.h
>

21 
	~<asm/pg®loc.h
>

22 
	~<asm/´Ùo.h
>

23 
	~<asm/·t.h
>

28 
	sıa_d©a
 {

29 *
	mvaddr
;

30 
pg´Ù_t
 
	mmask_£t
;

31 
pg´Ù_t
 
	mmask_şr
;

32 
	mnum·ges
;

33 
	mæags
;

34 
	mpâ
;

35 
	mfÜû_¥l™
 : 1;

36 
	mcu½age
;

37 
·ge
 **
	m·ges
;

46 
DEFINE_SPINLOCK
(
ıa_lock
);

48 
	#CPA_FLUSHTLB
 1

	)

49 
	#CPA_ARRAY
 2

	)

50 
	#CPA_PAGES_ARRAY
 4

	)

52 #ifdeà
CONFIG_PROC_FS


53 
	gdœeù_·ges_couÁ
[
PG_LEVEL_NUM
];

55 
	$upd©e_·ge_couÁ
(
Ëv–
, 
·ges
)

57 
æags
;

60 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

61 
dœeù_·ges_couÁ
[
Ëv–
] +ğ
·ges
;

62 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

63 
	}
}

65 
	$¥l™_·ge_couÁ
(
Ëv–
)

67 
dœeù_·ges_couÁ
[
Ëv–
]--;

68 
dœeù_·ges_couÁ
[
Ëv–
 - 1] +ğ
PTRS_PER_PTE
;

69 
	}
}

71 
	$¬ch_»pÜt_memšfo
(
£q_fe
 *
m
)

73 
	`£q_´štf
(
m
, "DirectMap4k: %8lu kB\n",

74 
dœeù_·ges_couÁ
[
PG_LEVEL_4K
] << 2);

75 #ià
	`defšed
(
CONFIG_X86_64
è|| defšed(
CONFIG_X86_PAE
)

76 
	`£q_´štf
(
m
, "DirectMap2M: %8lu kB\n",

77 
dœeù_·ges_couÁ
[
PG_LEVEL_2M
] << 11);

79 
	`£q_´štf
(
m
, "DirectMap4M: %8lu kB\n",

80 
dœeù_·ges_couÁ
[
PG_LEVEL_2M
] << 12);

82 #ifdeà
CONFIG_X86_64


83 ià(
dœeù_gb·ges
)

84 
	`£q_´štf
(
m
, "DirectMap1G: %8lu kB\n",

85 
dœeù_·ges_couÁ
[
PG_LEVEL_1G
] << 20);

87 
	}
}

89 
šlše
 
	$¥l™_·ge_couÁ
(
Ëv–
è{ 
	}
}

92 #ifdeà
CONFIG_X86_64


94 
šlše
 
	$highm­_¡¬t_pâ
()

96  
	`__·
(
_‹xt
è>> 
PAGE_SHIFT
;

97 
	}
}

99 
šlše
 
	$highm­_’d_pâ
()

101  
	`__·
(
	`roundup
(
_brk_’d
, 
PMD_SIZE
)è>> 
PAGE_SHIFT
;

102 
	}
}

106 #ifdeà
CONFIG_DEBUG_PAGEALLOC


107 
	#debug_·g—Îoc
 1

	)

109 
	#debug_·g—Îoc
 0

	)

112 
šlše
 

113 
	$w™hš
(
addr
, 
¡¬t
, 
’d
)

115  
addr
 >ğ
¡¬t
 &&‡dd¸< 
’d
;

116 
	}
}

130 
	$şæush_ÿche_¿nge
(*
vaddr
, 
size
)

132 *
v’d
 = 
vaddr
 + 
size
 - 1;

134 
	`mb
();

136 ; 
vaddr
 < 
v’d
; vadd¸+ğ
boÙ_ıu_d©a
.
x86_şæush_size
)

137 
	`şæush
(
vaddr
);

141 
	`şæush
(
v’d
);

143 
	`mb
();

144 
	}
}

146 
	$__ıa_æush_®l
(*
¬g
)

148 
ÿche
 = ()
¬g
;

154 
	`__æush_b_®l
();

156 ià(
ÿche
 && 
boÙ_ıu_d©a
.
x86
 >= 4)

157 
	`wbšvd
();

158 
	}
}

160 
	$ıa_æush_®l
(
ÿche
)

162 
	`BUG_ON
(
	`œqs_di§bËd
());

164 
	`Ú_—ch_ıu
(
__ıa_æush_®l
, (*è
ÿche
, 1);

165 
	}
}

167 
	$__ıa_æush_¿nge
(*
¬g
)

174 
	`__æush_b_®l
();

175 
	}
}

177 
	$ıa_æush_¿nge
(
¡¬t
, 
num·ges
, 
ÿche
)

179 
i
, 
Ëv–
;

180 
addr
;

182 
	`BUG_ON
(
	`œqs_di§bËd
());

183 
	`WARN_ON
(
	`PAGE_ALIGN
(
¡¬t
) != start);

185 
	`Ú_—ch_ıu
(
__ıa_æush_¿nge
, 
NULL
, 1);

187 ià(!
ÿche
)

196 
i
 = 0, 
addr
 = 
¡¬t
; i < 
num·ges
; i++,‡dd¸+ğ
PAGE_SIZE
) {

197 
±e_t
 *
±e
 = 
	`lookup_add»ss
(
addr
, &
Ëv–
);

202 ià(
±e
 && (
	`±e_v®
(*±eè& 
_PAGE_PRESENT
))

203 
	`şæush_ÿche_¿nge
((*è
addr
, 
PAGE_SIZE
);

205 
	}
}

207 
	$ıa_æush_¬¿y
(*
¡¬t
, 
num·ges
, 
ÿche
,

208 
š_æags
, 
·ge
 **
·ges
)

210 
i
, 
Ëv–
;

211 
do_wbšvd
 = 
ÿche
 && 
num·ges
 >= 1024;

213 
	`BUG_ON
(
	`œqs_di§bËd
());

215 
	`Ú_—ch_ıu
(
__ıa_æush_®l
, (*è
do_wbšvd
, 1);

217 ià(!
ÿche
 || 
do_wbšvd
)

226 
i
 = 0; i < 
num·ges
; i++) {

227 
addr
;

228 
±e_t
 *
±e
;

230 ià(
š_æags
 & 
CPA_PAGES_ARRAY
)

231 
addr
 = ()
	`·ge_add»ss
(
·ges
[
i
]);

233 
addr
 = 
¡¬t
[
i
];

235 
±e
 = 
	`lookup_add»ss
(
addr
, &
Ëv–
);

240 ià(
±e
 && (
	`±e_v®
(*±eè& 
_PAGE_PRESENT
))

241 
	`şæush_ÿche_¿nge
((*)
addr
, 
PAGE_SIZE
);

243 
	}
}

251 
šlše
 
pg´Ù_t
 
	$¡©ic_´ÙeùiÚs
(
pg´Ù_t
 
´Ù
, 
add»ss
,

252 
pâ
)

254 
pg´Ù_t
 
fÜbidd’
 = 
	`__pg´Ù
(0);

260 ià(
	`w™hš
(
pâ
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

261 
	`pg´Ù_v®
(
fÜbidd’
è|ğ
_PAGE_NX
;

268 ià(
	`w™hš
(
add»ss
, ()
_‹xt
, ()
_‘ext
))

269 
	`pg´Ù_v®
(
fÜbidd’
è|ğ
_PAGE_NX
;

275 ià(
	`w™hš
(
pâ
, 
	`__·
(()
__¡¬t_rod©a
è>> 
PAGE_SHIFT
,

276 
	`__·
(()
__’d_rod©a
è>> 
PAGE_SHIFT
))

277 
	`pg´Ù_v®
(
fÜbidd’
è|ğ
_PAGE_RW
;

279 
´Ù
 = 
	`__pg´Ù
(
	`pg´Ù_v®
ÕrÙè& ~pg´Ù_v®(
fÜbidd’
));

281  
´Ù
;

282 
	}
}

292 
±e_t
 *
	$lookup_add»ss
(
add»ss
, *
Ëv–
)

294 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
add»ss
);

295 
pud_t
 *
pud
;

296 
pmd_t
 *
pmd
;

298 *
Ëv–
 = 
PG_LEVEL_NONE
;

300 ià(
	`pgd_nÚe
(*
pgd
))

301  
NULL
;

303 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

304 ià(
	`pud_nÚe
(*
pud
))

305  
NULL
;

307 *
Ëv–
 = 
PG_LEVEL_1G
;

308 ià(
	`pud_Ïrge
(*
pud
è|| !
	`pud_´e£Á
(*pud))

309  (
±e_t
 *)
pud
;

311 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

312 ià(
	`pmd_nÚe
(*
pmd
))

313  
NULL
;

315 *
Ëv–
 = 
PG_LEVEL_2M
;

316 ià(
	`pmd_Ïrge
(*
pmd
è|| !
	`pmd_´e£Á
(*pmd))

317  (
±e_t
 *)
pmd
;

319 *
Ëv–
 = 
PG_LEVEL_4K
;

321  
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

322 
	}
}

323 
EXPORT_SYMBOL_GPL
(
lookup_add»ss
);

328 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
add»ss
,…‹_ˆ
±e
)

331 
	`£t_±e_©omic
(
k±e
, 
±e
);

332 #ifdeà
CONFIG_X86_32


333 ià(!
SHARED_KERNEL_PMD
) {

334 
·ge
 *page;

336 
	`li¡_fÜ_—ch_’Œy
(
·ge
, &
pgd_li¡
, 
Ìu
) {

337 
pgd_t
 *
pgd
;

338 
pud_t
 *
pud
;

339 
pmd_t
 *
pmd
;

341 
pgd
 = (
pgd_t
 *)
	`·ge_add»ss
(
·ge
è+ 
	`pgd_šdex
(
add»ss
);

342 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

343 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

344 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

348 
	}
}

351 
	$Œy_´e£rve_Ïrge_·ge
(
±e_t
 *
k±e
, 
add»ss
,

352 
ıa_d©a
 *
ıa
)

354 
Ãxage_addr
, 
num·ges
, 
pmask
, 
psize
, 
æags
, 
addr
, 
pâ
;

355 
±e_t
 
Ãw_±e
, 
Şd_±e
, *
tmp
;

356 
pg´Ù_t
 
Şd_´Ù
, 
Ãw_´Ù
;

357 
i
, 
do_¥l™
 = 1;

358 
Ëv–
;

360 ià(
ıa
->
fÜû_¥l™
)

363 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

368 
tmp
 = 
	`lookup_add»ss
(
add»ss
, &
Ëv–
);

369 ià(
tmp
 !ğ
k±e
)

370 
out_uÆock
;

372 
Ëv–
) {

373 
PG_LEVEL_2M
:

374 
psize
 = 
PMD_PAGE_SIZE
;

375 
pmask
 = 
PMD_PAGE_MASK
;

377 #ifdeà
CONFIG_X86_64


378 
PG_LEVEL_1G
:

379 
psize
 = 
PUD_PAGE_SIZE
;

380 
pmask
 = 
PUD_PAGE_MASK
;

384 
do_¥l™
 = -
EINVAL
;

385 
out_uÆock
;

392 
Ãxage_addr
 = (
add»ss
 + 
psize
è& 
pmask
;

393 
num·ges
 = (
Ãxage_addr
 - 
add»ss
è>> 
PAGE_SHIFT
;

394 ià(
num·ges
 < 
ıa
->numpages)

395 
ıa
->
num·ges
 =‚umpages;

400 
Şd_±e
 = *
k±e
;

401 
Şd_´Ù
 = 
Ãw_´Ù
 = 
	`±e_pg´Ù
(
Şd_±e
);

403 
	`pg´Ù_v®
(
Ãw_´Ù
è&ğ~pg´Ù_v®(
ıa
->
mask_şr
);

404 
	`pg´Ù_v®
(
Ãw_´Ù
è|ğpg´Ù_v®(
ıa
->
mask_£t
);

410 
pâ
 = 
	`±e_pâ
(
Şd_±e
è+ ((
add»ss
 & (
psize
 - 1)è>> 
PAGE_SHIFT
);

411 
ıa
->
pâ
 =…fn;

413 
Ãw_´Ù
 = 
	`¡©ic_´ÙeùiÚs
Òew_´Ù, 
add»ss
, 
pâ
);

420 
addr
 = 
add»ss
 + 
PAGE_SIZE
;

421 
pâ
++;

422 
i
 = 1; i < 
ıa
->
num·ges
; i++, 
addr
 +ğ
PAGE_SIZE
, 
pâ
++) {

423 
pg´Ù_t
 
chk_´Ù
 = 
	`¡©ic_´ÙeùiÚs
(
Ãw_´Ù
, 
addr
, 
pâ
);

425 ià(
	`pg´Ù_v®
(
chk_´Ù
è!ğpg´Ù_v®(
Ãw_´Ù
))

426 
out_uÆock
;

433 ià(
	`pg´Ù_v®
(
Ãw_´Ù
è=ğpg´Ù_v®(
Şd_´Ù
)) {

434 
do_¥l™
 = 0;

435 
out_uÆock
;

446 ià(
add»ss
 =ğ(
Ãxage_addr
 - 
psize
è&& 
ıa
->
num·ges
 ==‚umpages) {

451 
Ãw_±e
 = 
	`pâ_±e
(
	`±e_pâ
(
Şd_±e
), 
	`ÿnÚ_pg´Ù
(
Ãw_´Ù
));

452 
	`__£t_pmd_±e
(
k±e
, 
add»ss
, 
Ãw_±e
);

453 
ıa
->
æags
 |ğ
CPA_FLUSHTLB
;

454 
do_¥l™
 = 0;

457 
out_uÆock
:

458 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

460  
do_¥l™
;

461 
	}
}

463 
	$¥l™_Ïrge_·ge
(
±e_t
 *
k±e
, 
add»ss
)

465 
æags
, 
pâ
, 
pâšc
 = 1;

466 
i
, 
Ëv–
;

467 
±e_t
 *
pba£
, *
tmp
;

468 
pg´Ù_t
 
»f_´Ù
;

469 
·ge
 *
ba£
;

471 ià(!
debug_·g—Îoc
)

472 
	`¥š_uÆock
(&
ıa_lock
);

473 
ba£
 = 
	`®loc_·ges
(
GFP_KERNEL
, 0);

474 ià(!
debug_·g—Îoc
)

475 
	`¥š_lock
(&
ıa_lock
);

476 ià(!
ba£
)

477  -
ENOMEM
;

479 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

484 
tmp
 = 
	`lookup_add»ss
(
add»ss
, &
Ëv–
);

485 ià(
tmp
 !ğ
k±e
)

486 
out_uÆock
;

488 
pba£
 = (
±e_t
 *)
	`·ge_add»ss
(
ba£
);

489 
	`·¿vœt_®loc_±e
(&
š™_mm
, 
	`·ge_to_pâ
(
ba£
));

490 
»f_´Ù
 = 
	`±e_pg´Ù
(
	`±e_şrhuge
(*
k±e
));

497 
	`WARN_ON_ONCE
(
	`pg´Ù_v®
(
»f_´Ù
è& 
_PAGE_PAT_LARGE
);

499 #ifdeà
CONFIG_X86_64


500 ià(
Ëv–
 =ğ
PG_LEVEL_1G
) {

501 
pâšc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

502 
	`pg´Ù_v®
(
»f_´Ù
è|ğ
_PAGE_PSE
;

509 
pâ
 = 
	`±e_pâ
(*
k±e
);

510 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
pâ
 +ğ
pâšc
)

511 
	`£t_±e
(&
pba£
[
i
], 
	`pâ_±e
(
pâ
, 
»f_´Ù
));

513 ià(
add»ss
 >ğ()
	`__va
(0) &&

514 
add»ss
 < ()
	`__va
(
max_low_pâ_m­³d
 << 
PAGE_SHIFT
))

515 
	`¥l™_·ge_couÁ
(
Ëv–
);

517 #ifdeà
CONFIG_X86_64


518 ià(
add»ss
 >ğ()
	`__va
(1UL<<32) &&

519 
add»ss
 < ()
	`__va
(
max_pâ_m­³d
 << 
PAGE_SHIFT
))

520 
	`¥l™_·ge_couÁ
(
Ëv–
);

530 
	`__£t_pmd_±e
(
k±e
, 
add»ss
, 
	`mk_±e
(
ba£
, 
	`__pg´Ù
(
_KERNPG_TABLE
)));

540 
	`__æush_b_®l
();

542 
ba£
 = 
NULL
;

544 
out_uÆock
:

549 ià(
ba£
)

550 
	`__ä“_·ge
(
ba£
);

551 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

554 
	}
}

556 
	$__ıa_´oûss_çuÉ
(
ıa_d©a
 *
ıa
, 
vaddr
,

557 
´im¬y
)

562 ià(!
´im¬y
)

572 ià(
	`w™hš
(
vaddr
, 
PAGE_OFFSET
,

573 
PAGE_OFFSET
 + (
max_pâ_m­³d
 << 
PAGE_SHIFT
))) {

574 
ıa
->
num·ges
 = 1;

575 
ıa
->
pâ
 = 
	`__·
(
vaddr
è>> 
PAGE_SHIFT
;

578 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zero…te. "

579 "vadd¸ğ%lx c·->vadd¸ğ%lx\n", 
vaddr
,

580 *
ıa
->
vaddr
);

582  -
EFAULT
;

584 
	}
}

586 
	$__chªge_·ge_©Œ
(
ıa_d©a
 *
ıa
, 
´im¬y
)

588 
add»ss
;

589 
do_¥l™
, 
”r
;

590 
Ëv–
;

591 
±e_t
 *
k±e
, 
Şd_±e
;

593 ià(
ıa
->
æags
 & 
CPA_PAGES_ARRAY
)

594 
add»ss
 = ()
	`·ge_add»ss
(
ıa
->
·ges
[ıa->
cu½age
]);

595 ià(
ıa
->
æags
 & 
CPA_ARRAY
)

596 
add»ss
 = 
ıa
->
vaddr
[ıa->
cu½age
];

598 
add»ss
 = *
ıa
->
vaddr
;

599 
»³©
:

600 
k±e
 = 
	`lookup_add»ss
(
add»ss
, &
Ëv–
);

601 ià(!
k±e
)

602  
	`__ıa_´oûss_çuÉ
(
ıa
, 
add»ss
, 
´im¬y
);

604 
Şd_±e
 = *
k±e
;

605 ià(!
	`±e_v®
(
Şd_±e
))

606  
	`__ıa_´oûss_çuÉ
(
ıa
, 
add»ss
, 
´im¬y
);

608 ià(
Ëv–
 =ğ
PG_LEVEL_4K
) {

609 
±e_t
 
Ãw_±e
;

610 
pg´Ù_t
 
Ãw_´Ù
 = 
	`±e_pg´Ù
(
Şd_±e
);

611 
pâ
 = 
	`±e_pâ
(
Şd_±e
);

613 
	`pg´Ù_v®
(
Ãw_´Ù
è&ğ~pg´Ù_v®(
ıa
->
mask_şr
);

614 
	`pg´Ù_v®
(
Ãw_´Ù
è|ğpg´Ù_v®(
ıa
->
mask_£t
);

616 
Ãw_´Ù
 = 
	`¡©ic_´ÙeùiÚs
Òew_´Ù, 
add»ss
, 
pâ
);

623 
Ãw_±e
 = 
	`pâ_±e
(
pâ
, 
	`ÿnÚ_pg´Ù
(
Ãw_´Ù
));

624 
ıa
->
pâ
 =…fn;

628 ià(
	`±e_v®
(
Şd_±e
è!ğ±e_v®(
Ãw_±e
)) {

629 
	`£t_±e_©omic
(
k±e
, 
Ãw_±e
);

630 
ıa
->
æags
 |ğ
CPA_FLUSHTLB
;

632 
ıa
->
num·ges
 = 1;

640 
do_¥l™
 = 
	`Œy_´e£rve_Ïrge_·ge
(
k±e
, 
add»ss
, 
ıa
);

646 ià(
do_¥l™
 <= 0)

647  
do_¥l™
;

652 
”r
 = 
	`¥l™_Ïrge_·ge
(
k±e
, 
add»ss
);

653 ià(!
”r
) {

672 
	`æush_b_®l
();

673 
»³©
;

676  
”r
;

677 
	}
}

679 
__chªge_·ge_©Œ_£t_şr
(
ıa_d©a
 *
ıa
, 
check®Ÿs
);

681 
	$ıa_´oûss_®Ÿs
(
ıa_d©a
 *
ıa
)

683 
ıa_d©a
 
®Ÿs_ıa
;

684 
»t
 = 0;

685 
‹mp_ıa_vaddr
, 
vaddr
;

687 ià(
ıa
->
pâ
 >ğ
max_pâ_m­³d
)

690 #ifdeà
CONFIG_X86_64


691 ià(
ıa
->
pâ
 >ğ
max_low_pâ_m­³d
 && c·->pâ < (1UL<<(32-
PAGE_SHIFT
)))

698 ià(
ıa
->
æags
 & 
CPA_PAGES_ARRAY
)

699 
vaddr
 = ()
	`·ge_add»ss
(
ıa
->
·ges
[ıa->
cu½age
]);

700 ià(
ıa
->
æags
 & 
CPA_ARRAY
)

701 
vaddr
 = 
ıa
->vaddr[ıa->
cu½age
];

703 
vaddr
 = *
ıa
->vaddr;

705 ià(!(
	`w™hš
(
vaddr
, 
PAGE_OFFSET
,

706 
PAGE_OFFSET
 + (
max_pâ_m­³d
 << 
PAGE_SHIFT
)))) {

708 
®Ÿs_ıa
 = *
ıa
;

709 
‹mp_ıa_vaddr
 = (è
	`__va
(
ıa
->
pâ
 << 
PAGE_SHIFT
);

710 
®Ÿs_ıa
.
vaddr
 = &
‹mp_ıa_vaddr
;

711 
®Ÿs_ıa
.
æags
 &ğ~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

714 
»t
 = 
	`__chªge_·ge_©Œ_£t_şr
(&
®Ÿs_ıa
, 0);

717 #ifdeà
CONFIG_X86_64


718 ià(
»t
)

719  
»t
;

724 ià(
	`w™hš
(
vaddr
, (è
_‹xt
, 
_brk_’d
))

731 ià(!
	`w™hš
(
ıa
->
pâ
, 
	`highm­_¡¬t_pâ
(), 
	`highm­_’d_pâ
()))

734 
®Ÿs_ıa
 = *
ıa
;

735 
‹mp_ıa_vaddr
 = (
ıa
->
pâ
 << 
PAGE_SHIFT
è+ 
__START_KERNEL_m­
 - 
phys_ba£
;

736 
®Ÿs_ıa
.
vaddr
 = &
‹mp_ıa_vaddr
;

737 
®Ÿs_ıa
.
æags
 &ğ~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

742 
	`__chªge_·ge_©Œ_£t_şr
(&
®Ÿs_ıa
, 0);

744  
»t
;

745 
	}
}

747 
	$__chªge_·ge_©Œ_£t_şr
(
ıa_d©a
 *
ıa
, 
check®Ÿs
)

749 
»t
, 
num·ges
 = 
ıa
->numpages;

751 
num·ges
) {

756 
ıa
->
num·ges
 =‚umpages;

758 ià(
ıa
->
æags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

759 
ıa
->
num·ges
 = 1;

761 ià(!
debug_·g—Îoc
)

762 
	`¥š_lock
(&
ıa_lock
);

763 
»t
 = 
	`__chªge_·ge_©Œ
(
ıa
, 
check®Ÿs
);

764 ià(!
debug_·g—Îoc
)

765 
	`¥š_uÆock
(&
ıa_lock
);

766 ià(
»t
)

767  
»t
;

769 ià(
check®Ÿs
) {

770 
»t
 = 
	`ıa_´oûss_®Ÿs
(
ıa
);

771 ià(
»t
)

772  
»t
;

780 
	`BUG_ON
(
ıa
->
num·ges
 >‚umpages);

781 
num·ges
 -ğ
ıa
->numpages;

782 ià(
ıa
->
æags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

783 
ıa
->
cu½age
++;

785 *
ıa
->
vaddr
 +ğıa->
num·ges
 * 
PAGE_SIZE
;

789 
	}
}

791 
šlše
 
	$ÿche_©Œ
(
pg´Ù_t
 
©Œ
)

793  
	`pg´Ù_v®
(
©Œ
) &

794 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

795 
	}
}

797 
	$chªge_·ge_©Œ_£t_şr
(*
addr
, 
num·ges
,

798 
pg´Ù_t
 
mask_£t
,…g´Ù_ˆ
mask_şr
,

799 
fÜû_¥l™
, 
š_æag
,

800 
·ge
 **
·ges
)

802 
ıa_d©a
 
ıa
;

803 
»t
, 
ÿche
, 
check®Ÿs
;

809 
mask_£t
 = 
	`ÿnÚ_pg´Ù
(mask_set);

810 
mask_şr
 = 
	`ÿnÚ_pg´Ù
(mask_clr);

811 ià(!
	`pg´Ù_v®
(
mask_£t
è&& !pg´Ù_v®(
mask_şr
è&& !
fÜû_¥l™
)

815 ià(
š_æag
 & 
CPA_ARRAY
) {

816 
i
;

817 
i
 = 0; i < 
num·ges
; i++) {

818 ià(
addr
[
i
] & ~
PAGE_MASK
) {

819 
addr
[
i
] &ğ
PAGE_MASK
;

820 
	`WARN_ON_ONCE
(1);

823 } ià(!(
š_æag
 & 
CPA_PAGES_ARRAY
)) {

828 ià(*
addr
 & ~
PAGE_MASK
) {

829 *
addr
 &ğ
PAGE_MASK
;

833 
	`WARN_ON_ONCE
(1);

838 
	`km­_æush_unu£d
();

840 
	`vm_unm­_®Ÿ£s
();

847 
	`¬ch_æush_Ïzy_mmu_mode
();

849 
ıa
.
vaddr
 = 
addr
;

850 
ıa
.
·ges
 =…ages;

851 
ıa
.
num·ges
 =‚umpages;

852 
ıa
.
mask_£t
 = mask_set;

853 
ıa
.
mask_şr
 = mask_clr;

854 
ıa
.
æags
 = 0;

855 
ıa
.
cu½age
 = 0;

856 
ıa
.
fÜû_¥l™
 = force_split;

858 ià(
š_æag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

859 
ıa
.
æags
 |ğ
š_æag
;

862 
check®Ÿs
 = (
	`pg´Ù_v®
(
mask_£t
è|…g´Ù_v®(
mask_şr
)è!ğ
_PAGE_NX
;

864 
»t
 = 
	`__chªge_·ge_©Œ_£t_şr
(&
ıa
, 
check®Ÿs
);

869 ià(!(
ıa
.
æags
 & 
CPA_FLUSHTLB
))

870 
out
;

876 
ÿche
 = 
	`ÿche_©Œ
(
mask_£t
);

884 ià(!
»t
 && 
ıu_has_şæush
) {

885 ià(
ıa
.
æags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

886 
	`ıa_æush_¬¿y
(
addr
, 
num·ges
, 
ÿche
,

887 
ıa
.
æags
, 
·ges
);

889 
	`ıa_æush_¿nge
(*
addr
, 
num·ges
, 
ÿche
);

891 
	`ıa_æush_®l
(
ÿche
);

898 
	`¬ch_æush_Ïzy_mmu_mode
();

900 
out
:

901  
»t
;

902 
	}
}

904 
šlše
 
	$chªge_·ge_©Œ_£t
(*
addr
, 
num·ges
,

905 
pg´Ù_t
 
mask
, 
¬¿y
)

907  
	`chªge_·ge_©Œ_£t_şr
(
addr
, 
num·ges
, 
mask
, 
	`__pg´Ù
(0), 0,

908 (
¬¿y
 ? 
CPA_ARRAY
 : 0), 
NULL
);

909 
	}
}

911 
šlše
 
	$chªge_·ge_©Œ_ş—r
(*
addr
, 
num·ges
,

912 
pg´Ù_t
 
mask
, 
¬¿y
)

914  
	`chªge_·ge_©Œ_£t_şr
(
addr
, 
num·ges
, 
	`__pg´Ù
(0), 
mask
, 0,

915 (
¬¿y
 ? 
CPA_ARRAY
 : 0), 
NULL
);

916 
	}
}

918 
šlše
 
	$ıa_£t_·ges_¬¿y
(
·ge
 **
·ges
, 
num·ges
,

919 
pg´Ù_t
 
mask
)

921  
	`chªge_·ge_©Œ_£t_şr
(
NULL
, 
num·ges
, 
mask
, 
	`__pg´Ù
(0), 0,

922 
CPA_PAGES_ARRAY
, 
·ges
);

923 
	}
}

925 
šlše
 
	$ıa_ş—r_·ges_¬¿y
(
·ge
 **
·ges
, 
num·ges
,

926 
pg´Ù_t
 
mask
)

928  
	`chªge_·ge_©Œ_£t_şr
(
NULL
, 
num·ges
, 
	`__pg´Ù
(0), 
mask
, 0,

929 
CPA_PAGES_ARRAY
, 
·ges
);

930 
	}
}

932 
	$_£t_memÜy_uc
(
addr
, 
num·ges
)

937  
	`chªge_·ge_©Œ_£t
(&
addr
, 
num·ges
,

938 
	`__pg´Ù
(
_PAGE_CACHE_UC_MINUS
), 0);

939 
	}
}

941 
	$£t_memÜy_uc
(
addr
, 
num·ges
)

943 
»t
;

948 
»t
 = 
	`»£rve_memty³
(
	`__·
(
addr
), __·×ddrè+ 
num·ges
 * 
PAGE_SIZE
,

949 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

950 ià(
»t
)

951 
out_”r
;

953 
»t
 = 
	`_£t_memÜy_uc
(
addr
, 
num·ges
);

954 ià(
»t
)

955 
out_ä“
;

959 
out_ä“
:

960 
	`ä“_memty³
(
	`__·
(
addr
), __·×ddrè+ 
num·ges
 * 
PAGE_SIZE
);

961 
out_”r
:

962  
»t
;

963 
	}
}

964 
EXPORT_SYMBOL
(
£t_memÜy_uc
);

966 
	$£t_memÜy_¬¿y_uc
(*
addr
, 
addrš¬¿y
)

968 
i
, 
j
;

969 
»t
;

974 
i
 = 0; i < 
addrš¬¿y
; i++) {

975 
»t
 = 
	`»£rve_memty³
(
	`__·
(
addr
[
i
]), __·×ddr[i]è+ 
PAGE_SIZE
,

976 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

977 ià(
»t
)

978 
out_ä“
;

981 
»t
 = 
	`chªge_·ge_©Œ_£t
(
addr
, 
addrš¬¿y
,

982 
	`__pg´Ù
(
_PAGE_CACHE_UC_MINUS
), 1);

983 ià(
»t
)

984 
out_ä“
;

988 
out_ä“
:

989 
j
 = 0; j < 
i
; j++)

990 
	`ä“_memty³
(
	`__·
(
addr
[
j
]), __·×ddr[j]è+ 
PAGE_SIZE
);

992  
»t
;

993 
	}
}

994 
EXPORT_SYMBOL
(
£t_memÜy_¬¿y_uc
);

996 
	$_£t_memÜy_wc
(
addr
, 
num·ges
)

998 
»t
;

999 
»t
 = 
	`chªge_·ge_©Œ_£t
(&
addr
, 
num·ges
,

1000 
	`__pg´Ù
(
_PAGE_CACHE_UC_MINUS
), 0);

1002 ià(!
»t
) {

1003 
»t
 = 
	`chªge_·ge_©Œ_£t
(&
addr
, 
num·ges
,

1004 
	`__pg´Ù
(
_PAGE_CACHE_WC
), 0);

1006  
»t
;

1007 
	}
}

1009 
	$£t_memÜy_wc
(
addr
, 
num·ges
)

1011 
»t
;

1013 ià(!
·t_’abËd
)

1014  
	`£t_memÜy_uc
(
addr
, 
num·ges
);

1016 
»t
 = 
	`»£rve_memty³
(
	`__·
(
addr
), __·×ddrè+ 
num·ges
 * 
PAGE_SIZE
,

1017 
_PAGE_CACHE_WC
, 
NULL
);

1018 ià(
»t
)

1019 
out_”r
;

1021 
»t
 = 
	`_£t_memÜy_wc
(
addr
, 
num·ges
);

1022 ià(
»t
)

1023 
out_ä“
;

1027 
out_ä“
:

1028 
	`ä“_memty³
(
	`__·
(
addr
), __·×ddrè+ 
num·ges
 * 
PAGE_SIZE
);

1029 
out_”r
:

1030  
»t
;

1031 
	}
}

1032 
EXPORT_SYMBOL
(
£t_memÜy_wc
);

1034 
	$_£t_memÜy_wb
(
addr
, 
num·ges
)

1036  
	`chªge_·ge_©Œ_ş—r
(&
addr
, 
num·ges
,

1037 
	`__pg´Ù
(
_PAGE_CACHE_MASK
), 0);

1038 
	}
}

1040 
	$£t_memÜy_wb
(
addr
, 
num·ges
)

1042 
»t
;

1044 
»t
 = 
	`_£t_memÜy_wb
(
addr
, 
num·ges
);

1045 ià(
»t
)

1046  
»t
;

1048 
	`ä“_memty³
(
	`__·
(
addr
), __·×ddrè+ 
num·ges
 * 
PAGE_SIZE
);

1050 
	}
}

1051 
EXPORT_SYMBOL
(
£t_memÜy_wb
);

1053 
	$£t_memÜy_¬¿y_wb
(*
addr
, 
addrš¬¿y
)

1055 
i
;

1056 
»t
;

1058 
»t
 = 
	`chªge_·ge_©Œ_ş—r
(
addr
, 
addrš¬¿y
,

1059 
	`__pg´Ù
(
_PAGE_CACHE_MASK
), 1);

1060 ià(
»t
)

1061  
»t
;

1063 
i
 = 0; i < 
addrš¬¿y
; i++)

1064 
	`ä“_memty³
(
	`__·
(
addr
[
i
]), __·×ddr[i]è+ 
PAGE_SIZE
);

1067 
	}
}

1068 
EXPORT_SYMBOL
(
£t_memÜy_¬¿y_wb
);

1070 
	$£t_memÜy_x
(
addr
, 
num·ges
)

1072  
	`chªge_·ge_©Œ_ş—r
(&
addr
, 
num·ges
, 
	`__pg´Ù
(
_PAGE_NX
), 0);

1073 
	}
}

1074 
EXPORT_SYMBOL
(
£t_memÜy_x
);

1076 
	$£t_memÜy_nx
(
addr
, 
num·ges
)

1078  
	`chªge_·ge_©Œ_£t
(&
addr
, 
num·ges
, 
	`__pg´Ù
(
_PAGE_NX
), 0);

1079 
	}
}

1080 
EXPORT_SYMBOL
(
£t_memÜy_nx
);

1082 
	$£t_memÜy_ro
(
addr
, 
num·ges
)

1084  
	`chªge_·ge_©Œ_ş—r
(&
addr
, 
num·ges
, 
	`__pg´Ù
(
_PAGE_RW
), 0);

1085 
	}
}

1086 
EXPORT_SYMBOL_GPL
(
£t_memÜy_ro
);

1088 
	$£t_memÜy_rw
(
addr
, 
num·ges
)

1090  
	`chªge_·ge_©Œ_£t
(&
addr
, 
num·ges
, 
	`__pg´Ù
(
_PAGE_RW
), 0);

1091 
	}
}

1092 
EXPORT_SYMBOL_GPL
(
£t_memÜy_rw
);

1094 
	$£t_memÜy_Å
(
addr
, 
num·ges
)

1096  
	`chªge_·ge_©Œ_ş—r
(&
addr
, 
num·ges
, 
	`__pg´Ù
(
_PAGE_PRESENT
), 0);

1097 
	}
}

1099 
	$£t_memÜy_4k
(
addr
, 
num·ges
)

1101  
	`chªge_·ge_©Œ_£t_şr
(&
addr
, 
num·ges
, 
	`__pg´Ù
(0),

1102 
	`__pg´Ù
(0), 1, 0, 
NULL
);

1103 
	}
}

1105 
	$£t_·ges_uc
(
·ge
 *·ge, 
num·ges
)

1107 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1109  
	`£t_memÜy_uc
(
addr
, 
num·ges
);

1110 
	}
}

1111 
EXPORT_SYMBOL
(
£t_·ges_uc
);

1113 
	$£t_·ges_¬¿y_uc
(
·ge
 **
·ges
, 
addrš¬¿y
)

1115 
¡¬t
;

1116 
’d
;

1117 
i
;

1118 
ä“_idx
;

1120 
i
 = 0; i < 
addrš¬¿y
; i++) {

1121 
¡¬t
 = ()
	`·ge_add»ss
(
·ges
[
i
]);

1122 
’d
 = 
¡¬t
 + 
PAGE_SIZE
;

1123 ià(
	`»£rve_memty³
(
¡¬t
, 
’d
, 
_PAGE_CACHE_UC_MINUS
, 
NULL
))

1124 
”r_out
;

1127 ià(
	`ıa_£t_·ges_¬¿y
(
·ges
, 
addrš¬¿y
,

1128 
	`__pg´Ù
(
_PAGE_CACHE_UC_MINUS
)) == 0) {

1131 
”r_out
:

1132 
ä“_idx
 = 
i
;

1133 
i
 = 0; i < 
ä“_idx
; i++) {

1134 
¡¬t
 = ()
	`·ge_add»ss
(
·ges
[
i
]);

1135 
’d
 = 
¡¬t
 + 
PAGE_SIZE
;

1136 
	`ä“_memty³
(
¡¬t
, 
’d
);

1138  -
EINVAL
;

1139 
	}
}

1140 
EXPORT_SYMBOL
(
£t_·ges_¬¿y_uc
);

1142 
	$£t_·ges_wb
(
·ge
 *·ge, 
num·ges
)

1144 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1146  
	`£t_memÜy_wb
(
addr
, 
num·ges
);

1147 
	}
}

1148 
EXPORT_SYMBOL
(
£t_·ges_wb
);

1150 
	$£t_·ges_¬¿y_wb
(
·ge
 **
·ges
, 
addrš¬¿y
)

1152 
»tv®
;

1153 
¡¬t
;

1154 
’d
;

1155 
i
;

1157 
»tv®
 = 
	`ıa_ş—r_·ges_¬¿y
(
·ges
, 
addrš¬¿y
,

1158 
	`__pg´Ù
(
_PAGE_CACHE_MASK
));

1159 ià(
»tv®
)

1160  
»tv®
;

1162 
i
 = 0; i < 
addrš¬¿y
; i++) {

1163 
¡¬t
 = ()
	`·ge_add»ss
(
·ges
[
i
]);

1164 
’d
 = 
¡¬t
 + 
PAGE_SIZE
;

1165 
	`ä“_memty³
(
¡¬t
, 
’d
);

1169 
	}
}

1170 
EXPORT_SYMBOL
(
£t_·ges_¬¿y_wb
);

1172 
	$£t_·ges_x
(
·ge
 *·ge, 
num·ges
)

1174 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1176  
	`£t_memÜy_x
(
addr
, 
num·ges
);

1177 
	}
}

1178 
EXPORT_SYMBOL
(
£t_·ges_x
);

1180 
	$£t_·ges_nx
(
·ge
 *·ge, 
num·ges
)

1182 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1184  
	`£t_memÜy_nx
(
addr
, 
num·ges
);

1185 
	}
}

1186 
EXPORT_SYMBOL
(
£t_·ges_nx
);

1188 
	$£t_·ges_ro
(
·ge
 *·ge, 
num·ges
)

1190 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1192  
	`£t_memÜy_ro
(
addr
, 
num·ges
);

1193 
	}
}

1195 
	$£t_·ges_rw
(
·ge
 *·ge, 
num·ges
)

1197 
addr
 = ()
	`·ge_add»ss
(
·ge
);

1199  
	`£t_memÜy_rw
(
addr
, 
num·ges
);

1200 
	}
}

1202 #ifdeà
CONFIG_DEBUG_PAGEALLOC


1204 
	$__£t_·ges_p
(
·ge
 *·ge, 
num·ges
)

1206 
‹m·ddr
 = (è
	`·ge_add»ss
(
·ge
);

1207 
ıa_d©a
 
ıa
 = { .
vaddr
 = &
‹m·ddr
,

1208 .
num·ges
 =‚umpages,

1209 .
mask_£t
 = 
	`__pg´Ù
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1210 .
mask_şr
 = 
	`__pg´Ù
(0),

1211 .
æags
 = 0};

1219  
	`__chªge_·ge_©Œ_£t_şr
(&
ıa
, 0);

1220 
	}
}

1222 
	$__£t_·ges_Å
(
·ge
 *·ge, 
num·ges
)

1224 
‹m·ddr
 = (è
	`·ge_add»ss
(
·ge
);

1225 
ıa_d©a
 
ıa
 = { .
vaddr
 = &
‹m·ddr
,

1226 .
num·ges
 =‚umpages,

1227 .
mask_£t
 = 
	`__pg´Ù
(0),

1228 .
mask_şr
 = 
	`__pg´Ù
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1229 .
æags
 = 0};

1237  
	`__chªge_·ge_©Œ_£t_şr
(&
ıa
, 0);

1238 
	}
}

1240 
	$k”Ãl_m­_·ges
(
·ge
 *·ge, 
num·ges
, 
’abË
)

1242 ià(
	`PageHighMem
(
·ge
))

1244 ià(!
’abË
) {

1245 
	`debug_check_no_locks_ä“d
(
	`·ge_add»ss
(
·ge
),

1246 
num·ges
 * 
PAGE_SIZE
);

1252 ià(!
debug_·g—Îoc_’abËd
)

1260 ià(
’abË
)

1261 
	`__£t_·ges_p
(
·ge
, 
num·ges
);

1263 
	`__£t_·ges_Å
(
·ge
, 
num·ges
);

1269 
	`__æush_b_®l
();

1270 
	}
}

1272 #ifdeà
CONFIG_HIBERNATION


1274 
boŞ
 
	$k”Ãl_·ge_´e£Á
(
·ge
 *page)

1276 
Ëv–
;

1277 
±e_t
 *
±e
;

1279 ià(
	`PageHighMem
(
·ge
))

1280  
çl£
;

1282 
±e
 = 
	`lookup_add»ss
(()
	`·ge_add»ss
(
·ge
), &
Ëv–
);

1283  (
	`±e_v®
(*
±e
è& 
_PAGE_PRESENT
);

1284 
	}
}

1294 #ifdeà
CONFIG_CPA_DEBUG


1295 
	~"·g—‰r-‹¡.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<lšux/£q_fe.h
>

11 
	~<lšux/boÙmem.h
>

12 
	~<lšux/debugfs.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/gå.h
>

16 
	~<lšux/mm.h
>

17 
	~<lšux/fs.h
>

19 
	~<asm/ÿcheæush.h
>

20 
	~<asm/´oûssÜ.h
>

21 
	~<asm/bæush.h
>

22 
	~<asm/pgbË.h
>

23 
	~<asm/fú.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/mŒr.h
>

26 
	~<asm/·ge.h
>

27 
	~<asm/m¤.h
>

28 
	~<asm/·t.h
>

29 
	~<asm/io.h
>

31 #ifdeà
CONFIG_X86_PAT


32 
__»ad_mo¡ly
 
	g·t_’abËd
 = 1;

34 
šlše
 
	$·t_di§bË
(cÚ¡ *
»asÚ
)

36 
·t_’abËd
 = 0;

37 
	`´štk
(
KERN_INFO
 "%s\n", 
»asÚ
);

38 
	}
}

40 
__š™
 
	$nİ©
(*
¡r
)

42 
	`·t_di§bË
("PAT support disabled.");

44 
	}
}

45 
—¾y_·¿m
("nİ©", 
nİ©
);

47 
šlše
 
	$·t_di§bË
(cÚ¡ *
»asÚ
)

49 ()
»asÚ
;

50 
	}
}

54 
	gdebug_’abË
;

56 
__š™
 
	$·t_debug_£tup
(*
¡r
)

58 
debug_’abË
 = 1;

60 
	}
}

61 
__£tup
("debug·t", 
·t_debug_£tup
);

63 
	#d´štk
(
fmt
, 
¬g
...) \

64 dØ{ ià(
debug_’abË
è
	`´štk
(
KERN_INFO
 
fmt
, ##
¬g
); } 0)

	)

67 
u64
 
__»ad_mo¡ly
 
	gboÙ_·t_¡©e
;

70 
	mPAT_UC
 = 0,

71 
	mPAT_WC
 = 1,

72 
	mPAT_WT
 = 4,

73 
	mPAT_WP
 = 5,

74 
	mPAT_WB
 = 6,

75 
	mPAT_UC_MINUS
 = 7,

78 
	#PAT
(
x
, 
y
è((
u64
)
PAT_
 ## y << ((x)*8))

	)

80 
	$·t_š™
()

82 
u64
 
·t
;

84 ià(!
·t_’abËd
)

87 ià(!
ıu_has_·t
) {

88 ià(!
boÙ_·t_¡©e
) {

89 
	`·t_di§bË
("PAT‚ot supported by CPU.");

97 
	`´štk
(
KERN_ERR
 "PATƒnabled, "

99 
	`BUG
();

116 
·t
 = 
	`PAT
(0, 
WB
è| PAT(1, 
WC
è| PAT(2, 
UC_MINUS
è| PAT(3, 
UC
) |

117 
	`PAT
(4, 
WB
è| PAT(5, 
WC
è| PAT(6, 
UC_MINUS
è| PAT(7, 
UC
);

120 ià(!
boÙ_·t_¡©e
)

121 
	`rdm¤l
(
MSR_IA32_CR_PAT
, 
boÙ_·t_¡©e
);

123 
	`wrm¤l
(
MSR_IA32_CR_PAT
, 
·t
);

124 
	`´štk
(
KERN_INFO
 "x86 PATƒnabled: cpu %d, old 0x%Lx,‚ew 0x%Lx\n",

125 
	`smp_´oûssÜ_id
(), 
boÙ_·t_¡©e
, 
·t
);

126 
	}
}

128 #undeà
PAT


130 *
	$ÿ‰r_Çme
(
æags
)

132 
æags
 & 
_PAGE_CACHE_MASK
) {

133 
_PAGE_CACHE_UC
:  "uncached";

134 
_PAGE_CACHE_UC_MINUS
:  "uncached-minus";

135 
_PAGE_CACHE_WB
:  "write-back";

136 
_PAGE_CACHE_WC
:  "write-combining";

139 
	}
}

158 
	smemty³
 {

159 
u64
 
	m¡¬t
;

160 
u64
 
	m’d
;

161 
	mty³
;

162 
li¡_h—d
 
	mnd
;

165 
LIST_HEAD
(
memty³_li¡
);

166 
DEFINE_SPINLOCK
(
memty³_lock
);

175 
	$·t_x_mŒr_ty³
(
u64
 
¡¬t
, u64 
’d
, 
»q_ty³
)

181 ià(
»q_ty³
 =ğ
_PAGE_CACHE_WB
) {

182 
u8
 
mŒr_ty³
;

184 
mŒr_ty³
 = 
	`mŒr_ty³_lookup
(
¡¬t
, 
’d
);

185 ià(
mŒr_ty³
 !ğ
MTRR_TYPE_WRBACK
)

186  
_PAGE_CACHE_UC_MINUS
;

188  
_PAGE_CACHE_WB
;

191  
»q_ty³
;

192 
	}
}

195 
	$chk_cÚæiù
(
memty³
 *
Ãw
, memty³ *
’Œy
, *
ty³
)

197 ià(
Ãw
->
ty³
 !ğ
’Œy
->type) {

198 ià(
ty³
) {

199 
Ãw
->
ty³
 = 
’Œy
->type;

200 *
ty³
 = 
’Œy
->type;

202 
cÚæiù
;

206 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
’Œy
, &
memty³_li¡
, 
nd
) {

207 ià(
Ãw
->
’d
 <ğ
’Œy
->
¡¬t
)

209 ià(
Ãw
->
ty³
 !ğ
’Œy
->type)

210 
cÚæiù
;

214 
cÚæiù
:

215 
	`´štk
(
KERN_INFO
 "%s:%d conflicting memoryypes "

216 "%Lx-%Lx %s<->%s\n", 
cu¼’t
->
comm
, cu¼’t->
pid
, 
Ãw
->
¡¬t
,

217 
Ãw
->
’d
, 
	`ÿ‰r_Çme
Òew->
ty³
), c©Œ_Çme(
’Œy
->type));

218  -
EBUSY
;

219 
	}
}

221 
memty³
 *
	gÿched_’Œy
;

222 
u64
 
	gÿched_¡¬t
;

224 
	$·t_·g”ªge_is_¿m
(
¡¬t
, 
’d
)

226 
¿m_·ge
 = 0, 
nÙ_¿m·ge
 = 0;

227 
·ge_Ä
;

229 
·ge_Ä
 = (
¡¬t
 >> 
PAGE_SHIFT
);…age_Ä < (
’d
 >> PAGE_SHIFT);

230 ++
·ge_Ä
) {

238 ià(
·ge_Ä
 >ğ(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

239 
	`·ge_is_¿m
(
·ge_Ä
))

240 
¿m_·ge
 = 1;

242 
nÙ_¿m·ge
 = 1;

244 ià(
¿m_·ge
 =ğ
nÙ_¿m·ge
)

248  
¿m_·ge
;

249 
	}
}

263 
	$»£rve_¿m_·ges_ty³
(
u64
 
¡¬t
, u64 
’d
, 
»q_ty³
,

264 *
Ãw_ty³
)

266 
·ge
 *page;

267 
u64
 
pâ
, 
’d_pâ
;

269 
pâ
 = (
¡¬t
 >> 
PAGE_SHIFT
);…â < (
’d
 >> PAGE_SHIFT); ++pfn) {

270 
·ge
 = 
	`pâ_to_·ge
(
pâ
);

271 ià(
	`·ge_m­³d
(
·ge
è|| 
	`PageNÚWB
(page))

272 
out
;

274 
	`S‘PageNÚWB
(
·ge
);

278 
out
:

279 
’d_pâ
 = 
pâ
;

280 
pâ
 = (
¡¬t
 >> 
PAGE_SHIFT
);…â < 
’d_pâ
; ++pfn) {

281 
·ge
 = 
	`pâ_to_·ge
(
pâ
);

282 
	`CË¬PageNÚWB
(
·ge
);

285  -
EINVAL
;

286 
	}
}

288 
	$ä“_¿m_·ges_ty³
(
u64
 
¡¬t
, u64 
’d
)

290 
·ge
 *page;

291 
u64
 
pâ
, 
’d_pâ
;

293 
pâ
 = (
¡¬t
 >> 
PAGE_SHIFT
);…â < (
’d
 >> PAGE_SHIFT); ++pfn) {

294 
·ge
 = 
	`pâ_to_·ge
(
pâ
);

295 ià(
	`·ge_m­³d
(
·ge
è|| !
	`PageNÚWB
(page))

296 
out
;

298 
	`CË¬PageNÚWB
(
·ge
);

302 
out
:

303 
’d_pâ
 = 
pâ
;

304 
pâ
 = (
¡¬t
 >> 
PAGE_SHIFT
);…â < 
’d_pâ
; ++pfn) {

305 
·ge
 = 
	`pâ_to_·ge
(
pâ
);

306 
	`S‘PageNÚWB
(
·ge
);

308  -
EINVAL
;

309 
	}
}

326 
	$»£rve_memty³
(
u64
 
¡¬t
, u64 
’d
, 
»q_ty³
,

327 *
Ãw_ty³
)

329 
memty³
 *
Ãw
, *
’Œy
;

330 
aùu®_ty³
;

331 
li¡_h—d
 *
wh”e
;

332 
is_¿nge_¿m
;

333 
”r
 = 0;

335 
	`BUG_ON
(
¡¬t
 >ğ
’d
);

337 ià(!
·t_’abËd
) {

339 ià(
Ãw_ty³
) {

340 ià(
»q_ty³
 == -1)

341 *
Ãw_ty³
 = 
_PAGE_CACHE_WB
;

343 *
Ãw_ty³
 = 
»q_ty³
 & 
_PAGE_CACHE_MASK
;

349 ià(
	`is_ISA_¿nge
(
¡¬t
, 
’d
 - 1)) {

350 ià(
Ãw_ty³
)

351 *
Ãw_ty³
 = 
_PAGE_CACHE_WB
;

361 
aùu®_ty³
 = 
	`·t_x_mŒr_ty³
(
¡¬t
, 
’d
, 
»q_ty³
 & 
_PAGE_CACHE_MASK
);

363 ià(
Ãw_ty³
)

364 *
Ãw_ty³
 = 
aùu®_ty³
;

366 
is_¿nge_¿m
 = 
	`·t_·g”ªge_is_¿m
(
¡¬t
, 
’d
);

367 ià(
is_¿nge_¿m
 == 1)

368  
	`»£rve_¿m_·ges_ty³
(
¡¬t
, 
’d
, 
»q_ty³
,

369 
Ãw_ty³
);

370 ià(
is_¿nge_¿m
 < 0)

371  -
EINVAL
;

373 
Ãw
 = 
	`km®loc
((
memty³
), 
GFP_KERNEL
);

374 ià(!
Ãw
)

375  -
ENOMEM
;

377 
Ãw
->
¡¬t
 = start;

378 
Ãw
->
’d
 =ƒnd;

379 
Ãw
->
ty³
 = 
aùu®_ty³
;

381 
	`¥š_lock
(&
memty³_lock
);

383 ià(
ÿched_’Œy
 && 
¡¬t
 >ğ
ÿched_¡¬t
)

384 
’Œy
 = 
ÿched_’Œy
;

386 
’Œy
 = 
	`li¡_’Œy
(&
memty³_li¡
, 
memty³
, 
nd
);

389 
wh”e
 = 
NULL
;

390 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
’Œy
, &
memty³_li¡
, 
nd
) {

391 ià(
’d
 <ğ
’Œy
->
¡¬t
) {

392 
wh”e
 = 
’Œy
->
nd
.
´ev
;

393 
ÿched_’Œy
 = 
	`li¡_’Œy
(
wh”e
, 
memty³
, 
nd
);

395 } ià(
¡¬t
 <ğ
’Œy
->start) {

396 
”r
 = 
	`chk_cÚæiù
(
Ãw
, 
’Œy
, 
Ãw_ty³
);

397 ià(!
”r
) {

398 
	`d´štk
("Overlap‡t 0x%Lx-0x%Lx\n",

399 
’Œy
->
¡¬t
,ƒÁry->
’d
);

400 
wh”e
 = 
’Œy
->
nd
.
´ev
;

401 
ÿched_’Œy
 = 
	`li¡_’Œy
(
wh”e
,

402 
memty³
, 
nd
);

405 } ià(
¡¬t
 < 
’Œy
->
’d
) {

406 
”r
 = 
	`chk_cÚæiù
(
Ãw
, 
’Œy
, 
Ãw_ty³
);

407 ià(!
”r
) {

408 
	`d´štk
("Overlap‡t 0x%Lx-0x%Lx\n",

409 
’Œy
->
¡¬t
,ƒÁry->
’d
);

410 
ÿched_’Œy
 = 
	`li¡_’Œy
(
’Œy
->
nd
.
´ev
,

411 
memty³
, 
nd
);

417 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
’Œy
,

418 &
memty³_li¡
, 
nd
) {

419 ià(
¡¬t
 <ğ
’Œy
->start) {

420 
wh”e
 = 
’Œy
->
nd
.
´ev
;

429 ià(
”r
) {

430 
	`´štk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

432 
¡¬t
, 
’d
, 
	`ÿ‰r_Çme
(
Ãw
->
ty³
), c©Œ_Çme(
»q_ty³
));

433 
	`kä“
(
Ãw
);

434 
	`¥š_uÆock
(&
memty³_lock
);

436  
”r
;

439 
ÿched_¡¬t
 = 
¡¬t
;

441 ià(
wh”e
)

442 
	`li¡_add
(&
Ãw
->
nd
, 
wh”e
);

444 
	`li¡_add_
(&
Ãw
->
nd
, &
memty³_li¡
);

446 
	`¥š_uÆock
(&
memty³_lock
);

448 
	`d´štk
("reserve_memtype‡dded 0x%Lx-0x%Lx,rack %s,„eq %s,„et %s\n",

449 
¡¬t
, 
’d
, 
	`ÿ‰r_Çme
(
Ãw
->
ty³
), c©Œ_Çme(
»q_ty³
),

450 
Ãw_ty³
 ? 
	`ÿ‰r_Çme
(*new_type) : "-");

452  
”r
;

453 
	}
}

455 
	$ä“_memty³
(
u64
 
¡¬t
, u64 
’d
)

457 
memty³
 *
’Œy
;

458 
”r
 = -
EINVAL
;

459 
is_¿nge_¿m
;

461 ià(!
·t_’abËd
)

465 ià(
	`is_ISA_¿nge
(
¡¬t
, 
’d
 - 1))

468 
is_¿nge_¿m
 = 
	`·t_·g”ªge_is_¿m
(
¡¬t
, 
’d
);

469 ià(
is_¿nge_¿m
 == 1)

470  
	`ä“_¿m_·ges_ty³
(
¡¬t
, 
’d
);

471 ià(
is_¿nge_¿m
 < 0)

472  -
EINVAL
;

474 
	`¥š_lock
(&
memty³_lock
);

475 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
memty³_li¡
, 
nd
) {

476 ià(
’Œy
->
¡¬t
 =ğ¡¬ˆ&&ƒÁry->
’d
 ==ƒnd) {

477 ià(
ÿched_’Œy
 =ğ
’Œy
 || 
ÿched_¡¬t
 =ğ
¡¬t
)

478 
ÿched_’Œy
 = 
NULL
;

480 
	`li¡_d–
(&
’Œy
->
nd
);

481 
	`kä“
(
’Œy
);

482 
”r
 = 0;

486 
	`¥š_uÆock
(&
memty³_lock
);

488 ià(
”r
) {

489 
	`´štk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

490 
cu¼’t
->
comm
, cu¼’t->
pid
, 
¡¬t
, 
’d
);

493 
	`d´štk
("ä“_memty³„eque¡ 0x%Lx-0x%Lx\n", 
¡¬t
, 
’d
);

495  
”r
;

496 
	}
}

499 
pg´Ù_t
 
	$phys_mem_acûss_´Ù
(
fe
 *fe, 
pâ
,

500 
size
, 
pg´Ù_t
 
vma_´Ù
)

502  
vma_´Ù
;

503 
	}
}

505 #ifdeà
CONFIG_STRICT_DEVMEM


507 
šlše
 
	$¿nge_is_®lowed
(
pâ
, 
size
)

510 
	}
}

513 
šlše
 
	$¿nge_is_®lowed
(
pâ
, 
size
)

515 
u64
 
äom
 = ((u64)
pâ
è<< 
PAGE_SHIFT
;

516 
u64
 
to
 = 
äom
 + 
size
;

517 
u64
 
cursÜ
 = 
äom
;

519 ià(!
·t_’abËd
)

522 
cursÜ
 < 
to
) {

523 ià(!
	`devmem_is_®lowed
(
pâ
)) {

524 
	`´štk
(
KERN_INFO


526 
cu¼’t
->
comm
, 
äom
, 
to
);

529 
cursÜ
 +ğ
PAGE_SIZE
;

530 
pâ
++;

533 
	}
}

536 
	$phys_mem_acûss_´Ù_®lowed
(
fe
 *fe, 
pâ
,

537 
size
, 
pg´Ù_t
 *
vma_´Ù
)

539 
æags
 = 
_PAGE_CACHE_WB
;

541 ià(!
	`¿nge_is_®lowed
(
pâ
, 
size
))

544 ià(
fe
->
f_æags
 & 
O_SYNC
) {

545 
æags
 = 
_PAGE_CACHE_UC_MINUS
;

548 #ifdeà
CONFIG_X86_32


557 ià(!
·t_’abËd
 &&

558 !(
	`boÙ_ıu_has
(
X86_FEATURE_MTRR
) ||

559 
	`boÙ_ıu_has
(
X86_FEATURE_K6_MTRR
) ||

560 
	`boÙ_ıu_has
(
X86_FEATURE_CYRIX_ARR
) ||

561 
	`boÙ_ıu_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

562 (
pâ
 << 
PAGE_SHIFT
è>ğ
	`__·
(
high_memÜy
)) {

563 
æags
 = 
_PAGE_CACHE_UC
;

567 *
vma_´Ù
 = 
	`__pg´Ù
((
	`pg´Ù_v®
(*vma_´Ùè& ~
_PAGE_CACHE_MASK
) |

568 
æags
);

570 
	}
}

576 
	$k”Ãl_m­_sync_memty³
(
u64
 
ba£
, 
size
, 
æags
)

578 
id_sz
;

580 ià(!
·t_’abËd
 || 
ba£
 >ğ
	`__·
(
high_memÜy
))

583 
id_sz
 = (
	`__·
(
high_memÜy
è< 
ba£
 + 
size
) ?

584 
	`__·
(
high_memÜy
è- 
ba£
 :

585 
size
;

587 ià(
	`iÜem­_chªge_©Œ
(()
	`__va
(
ba£
), 
id_sz
, 
æags
) < 0) {

588 
	`´štk
(
KERN_INFO


591 
cu¼’t
->
comm
, cu¼’t->
pid
,

592 
	`ÿ‰r_Çme
(
æags
),

593 
ba£
, ()(ba£ + 
size
));

594  -
EINVAL
;

597 
	}
}

604 
	$»£rve_pâ_¿nge
(
u64
 
·ddr
, 
size
, 
pg´Ù_t
 *
vma_´Ù
,

605 
¡riù_´Ù
)

607 
is_¿m
 = 0;

608 
»t
;

609 
wªt_æags
 = (
	`pg´Ù_v®
(*
vma_´Ù
è& 
_PAGE_CACHE_MASK
);

610 
æags
 = 
wªt_æags
;

612 
is_¿m
 = 
	`·t_·g”ªge_is_¿m
(
·ddr
,…add¸+ 
size
);

618 ià(
is_¿m
 != 0)

621 
»t
 = 
	`»£rve_memty³
(
·ddr
,…add¸+ 
size
, 
wªt_æags
, &
æags
);

622 ià(
»t
)

623  
»t
;

625 ià(
æags
 !ğ
wªt_æags
) {

626 ià(
¡riù_´Ù
 || !
	`is_Ãw_memty³_®lowed
(
wªt_æags
, 
æags
)) {

627 
	`ä“_memty³
(
·ddr
,…add¸+ 
size
);

628 
	`´štk
(
KERN_ERR
 "%s:%d map…fnƒxpected mappingype %s"

630 
cu¼’t
->
comm
, cu¼’t->
pid
,

631 
	`ÿ‰r_Çme
(
wªt_æags
),

632 ()
·ddr
,

633 ()(
·ddr
 + 
size
),

634 
	`ÿ‰r_Çme
(
æags
));

635  -
EINVAL
;

641 *
vma_´Ù
 = 
	`__pg´Ù
((
	`pg´Ù_v®
(*vma_prot) &

642 (~
_PAGE_CACHE_MASK
)) |

643 
æags
);

646 ià(
	`k”Ãl_m­_sync_memty³
(
·ddr
, 
size
, 
æags
) < 0) {

647 
	`ä“_memty³
(
·ddr
,…add¸+ 
size
);

648  -
EINVAL
;

651 
	}
}

657 
	$ä“_pâ_¿nge
(
u64
 
·ddr
, 
size
)

659 
is_¿m
;

661 
is_¿m
 = 
	`·t_·g”ªge_is_¿m
(
·ddr
,…add¸+ 
size
);

662 ià(
is_¿m
 == 0)

663 
	`ä“_memty³
(
·ddr
,…add¸+ 
size
);

664 
	}
}

673 
	$Œack_pâ_vma_cİy
(
vm_¬—_¡ruù
 *
vma
)

675 
»sourû_size_t
 
·ddr
;

676 
´Ù
;

677 
vma_size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

678 
pg´Ù_t
 
pg´Ù
;

680 ià(!
·t_’abËd
)

688 ià(
	`is_lš—r_pâ_m­pšg
(
vma
)) {

693 ià(
	`fŞlow_phys
(
vma
, vma->
vm_¡¬t
, 0, &
´Ù
, &
·ddr
)) {

694 
	`WARN_ON_ONCE
(1);

695  -
EINVAL
;

697 
pg´Ù
 = 
	`__pg´Ù
(
´Ù
);

698  
	`»£rve_pâ_¿nge
(
·ddr
, 
vma_size
, &
pg´Ù
, 1);

702 
	}
}

712 
	$Œack_pâ_vma_Ãw
(
vm_¬—_¡ruù
 *
vma
, 
pg´Ù_t
 *
´Ù
,

713 
pâ
, 
size
)

715 
»sourû_size_t
 
·ddr
;

716 
vma_size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

718 ià(!
·t_’abËd
)

726 ià(
	`is_lš—r_pâ_m­pšg
(
vma
)) {

728 
·ddr
 = (
»sourû_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

729  
	`»£rve_pâ_¿nge
(
·ddr
, 
vma_size
, 
´Ù
, 0);

733 
	}
}

740 
	$uÁ¿ck_pâ_vma
(
vm_¬—_¡ruù
 *
vma
, 
pâ
,

741 
size
)

743 
»sourû_size_t
 
·ddr
;

744 
vma_size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

746 ià(!
·t_’abËd
)

754 ià(
	`is_lš—r_pâ_m­pšg
(
vma
)) {

756 
·ddr
 = (
»sourû_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

757 
	`ä“_pâ_¿nge
(
·ddr
, 
vma_size
);

760 
	}
}

762 
pg´Ù_t
 
	$pg´Ù_wr™ecombše
(
pg´Ù_t
 
´Ù
)

764 ià(
·t_’abËd
)

765  
	`__pg´Ù
(
	`pg´Ù_v®
(
´Ù
è| 
_PAGE_CACHE_WC
);

767  
	`pg´Ù_nÚÿched
(
´Ù
);

768 
	}
}

769 
EXPORT_SYMBOL_GPL
(
pg´Ù_wr™ecombše
);

771 #ià
defšed
(
CONFIG_DEBUG_FS
è&& defšed(
CONFIG_X86_PAT
)

774 
memty³
 *
	$memty³_g‘_idx
(
loff_t
 
pos
)

776 
memty³
 *
li¡_node
, *
´št_’Œy
;

777 
i
 = 1;

779 
´št_’Œy
 = 
	`km®loc
((
memty³
), 
GFP_KERNEL
);

780 ià(!
´št_’Œy
)

781  
NULL
;

783 
	`¥š_lock
(&
memty³_lock
);

784 
	`li¡_fÜ_—ch_’Œy
(
li¡_node
, &
memty³_li¡
, 
nd
) {

785 ià(
pos
 =ğ
i
) {

786 *
´št_’Œy
 = *
li¡_node
;

787 
	`¥š_uÆock
(&
memty³_lock
);

788  
´št_’Œy
;

790 ++
i
;

792 
	`¥š_uÆock
(&
memty³_lock
);

793 
	`kä“
(
´št_’Œy
);

795  
NULL
;

796 
	}
}

798 *
	$memty³_£q_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

800 ià(*
pos
 == 0) {

801 ++*
pos
;

802 
	`£q_´štf
(
£q
, "PAT memtype†ist:\n");

805  
	`memty³_g‘_idx
(*
pos
);

806 
	}
}

808 *
	$memty³_£q_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

810 ++*
pos
;

811  
	`memty³_g‘_idx
(*
pos
);

812 
	}
}

814 
	$memty³_£q_¡İ
(
£q_fe
 *
£q
, *
v
)

816 
	}
}

818 
	$memty³_£q_show
(
£q_fe
 *
£q
, *
v
)

820 
memty³
 *
´št_’Œy
 = (memty³ *)
v
;

822 
	`£q_´štf
(
£q
, "% @ 0x%Lx-0x%Lx\n", 
	`ÿ‰r_Çme
(
´št_’Œy
->
ty³
),

823 
´št_’Œy
->
¡¬t
,…ršt_’Œy->
’d
);

824 
	`kä“
(
´št_’Œy
);

827 
	}
}

829 
£q_İ”©iÚs
 
	gmemty³_£q_İs
 = {

830 .
¡¬t
 = 
memty³_£q_¡¬t
,

831 .
	gÃxt
 = 
memty³_£q_Ãxt
,

832 .
	g¡İ
 = 
memty³_£q_¡İ
,

833 .
	gshow
 = 
memty³_£q_show
,

836 
	$memty³_£q_İ’
(
šode
 *šode, 
fe
 *file)

838  
	`£q_İ’
(
fe
, &
memty³_£q_İs
);

839 
	}
}

841 cÚ¡ 
fe_İ”©iÚs
 
	gmemty³_fİs
 = {

842 .
İ’
 = 
memty³_£q_İ’
,

843 .
	g»ad
 = 
£q_»ad
,

844 .
	gÎ£ek
 = 
£q_l£ek
,

845 .
	g»Ëa£
 = 
£q_»Ëa£
,

848 
__š™
 
	$·t_memty³_li¡_š™
()

850 
	`debugfs_ü—‹_fe
("·t_memty³_li¡", 
S_IRUSR
, 
¬ch_debugfs_dœ
,

851 
NULL
, &
memty³_fİs
);

853 
	}
}

855 
Ï‹_š™ÿÎ
(
·t_memty³_li¡_š™
);

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<lšux/mm.h
>

2 
	~<asm/pg®loc.h
>

3 
	~<asm/pgbË.h
>

4 
	~<asm/b.h
>

5 
	~<asm/fixm­.h
>

7 
±e_t
 *
	$±e_®loc_Úe_k”Ãl
(
mm_¡ruù
 *
mm
, 
add»ss
)

9  (
±e_t
 *)
	`__g‘_ä“_·ge
(
GFP_KERNEL
|
__GFP_REPEAT
|
__GFP_ZERO
);

10 
	}
}

12 
pgbË_t
 
	$±e_®loc_Úe
(
mm_¡ruù
 *
mm
, 
add»ss
)

14 
·ge
 *
±e
;

16 #ifdeà
CONFIG_HIGHPTE


17 
±e
 = 
	`®loc_·ges
(
GFP_KERNEL
|
__GFP_HIGHMEM
|
__GFP_REPEAT
|
__GFP_ZERO
, 0);

19 
±e
 = 
	`®loc_·ges
(
GFP_KERNEL
|
__GFP_REPEAT
|
__GFP_ZERO
, 0);

21 ià(
±e
)

22 
	`pgbË_·ge_ùÜ
(
±e
);

23  
±e
;

24 
	}
}

26 
	$__±e_ä“_b
(
mmu_g©h”
 *
b
, 
·ge
 *
±e
)

28 
	`pgbË_·ge_dtÜ
(
±e
);

29 
	`·¿vœt_»Ëa£_±e
(
	`·ge_to_pâ
(
±e
));

30 
	`b_»move_·ge
(
b
, 
±e
);

31 
	}
}

33 #ià
PAGETABLE_LEVELS
 > 2

34 
	$__pmd_ä“_b
(
mmu_g©h”
 *
b
, 
pmd_t
 *
pmd
)

36 
	`·¿vœt_»Ëa£_pmd
(
	`__·
(
pmd
è>> 
PAGE_SHIFT
);

37 
	`b_»move_·ge
(
b
, 
	`vœt_to_·ge
(
pmd
));

38 
	}
}

40 #ià
PAGETABLE_LEVELS
 > 3

41 
	$__pud_ä“_b
(
mmu_g©h”
 *
b
, 
pud_t
 *
pud
)

43 
	`·¿vœt_»Ëa£_pud
(
	`__·
(
pud
è>> 
PAGE_SHIFT
);

44 
	`b_»move_·ge
(
b
, 
	`vœt_to_·ge
(
pud
));

45 
	}
}

49 
šlše
 
	$pgd_li¡_add
(
pgd_t
 *
pgd
)

51 
·ge
 *·gğ
	`vœt_to_·ge
(
pgd
);

53 
	`li¡_add
(&
·ge
->
Ìu
, &
pgd_li¡
);

54 
	}
}

56 
šlše
 
	$pgd_li¡_d–
(
pgd_t
 *
pgd
)

58 
·ge
 *·gğ
	`vœt_to_·ge
(
pgd
);

60 
	`li¡_d–
(&
·ge
->
Ìu
);

61 
	}
}

63 
	#UNSHARED_PTRS_PER_PGD
 \

64 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

66 
	$pgd_ùÜ
(
pgd_t
 *
pgd
)

71 ià(
PAGETABLE_LEVELS
 == 2 ||

72 (
PAGETABLE_LEVELS
 =ğ3 && 
SHARED_KERNEL_PMD
) ||

73 
PAGETABLE_LEVELS
 == 4) {

74 
	`şÚe_pgd_¿nge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

75 
sw­³r_pg_dœ
 + 
KERNEL_PGD_BOUNDARY
,

76 
KERNEL_PGD_PTRS
);

77 
	`·¿vœt_®loc_pmd_şÚe
(
	`__·
(
pgd
è>> 
PAGE_SHIFT
,

78 
	`__·
(
sw­³r_pg_dœ
è>> 
PAGE_SHIFT
,

79 
KERNEL_PGD_BOUNDARY
,

80 
KERNEL_PGD_PTRS
);

84 ià(!
SHARED_KERNEL_PMD
)

85 
	`pgd_li¡_add
(
pgd
);

86 
	}
}

88 
	$pgd_dtÜ
(
pgd_t
 *
pgd
)

90 
æags
;

92 ià(
SHARED_KERNEL_PMD
)

95 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

96 
	`pgd_li¡_d–
(
pgd
);

97 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

98 
	}
}

111 #ifdeà
CONFIG_X86_PAE


123 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

125 
	$pud_pİuÏ‹
(
mm_¡ruù
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

127 
	`·¿vœt_®loc_pmd
(
mm
, 
	`__·
(
pmd
è>> 
PAGE_SHIFT
);

131 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__·
(
pmd
è| 
_PAGE_PRESENT
));

139 ià(
mm
 =ğ
cu¼’t
->
aùive_mm
)

140 
	`wr™e_ü3
(
	`»ad_ü3
());

141 
	}
}

145 
	#PREALLOCATED_PMDS
 0

	)

149 
	$ä“_pmds
(
pmd_t
 *
pmds
[])

151 
i
;

153 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

154 ià(
pmds
[
i
])

155 
	`ä“_·ge
(()
pmds
[
i
]);

156 
	}
}

158 
	$´—Îoÿ‹_pmds
(
pmd_t
 *
pmds
[])

160 
i
;

161 
boŞ
 
çed
 = 
çl£
;

163 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

164 
pmd_t
 *
pmd
 = (pmd_ˆ*)
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
|
__GFP_REPEAT
);

165 ià(
pmd
 =ğ
NULL
)

166 
çed
 = 
Œue
;

167 
pmds
[
i
] = 
pmd
;

170 ià(
çed
) {

171 
	`ä“_pmds
(
pmds
);

172  -
ENOMEM
;

176 
	}
}

184 
	$pgd_mİ_up_pmds
(
mm_¡ruù
 *
mm
, 
pgd_t
 *
pgdp
)

186 
i
;

188 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

189 
pgd_t
 
pgd
 = 
pgdp
[
i
];

191 ià(
	`pgd_v®
(
pgd
) != 0) {

192 
pmd_t
 *
pmd
 = (pmd_ˆ*)
	`pgd_·ge_vaddr
(
pgd
);

194 
pgdp
[
i
] = 
	`Çtive_make_pgd
(0);

196 
	`·¿vœt_»Ëa£_pmd
(
	`pgd_v®
(
pgd
è>> 
PAGE_SHIFT
);

197 
	`pmd_ä“
(
mm
, 
pmd
);

200 
	}
}

202 
	$pgd_´•İuÏ‹_pmd
(
mm_¡ruù
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

204 
pud_t
 *
pud
;

205 
addr
;

206 
i
;

208 ià(
PREALLOCATED_PMDS
 == 0)

211 
pud
 = 
	`pud_off£t
(
pgd
, 0);

213 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

214 
i
++, 
pud
++, 
addr
 +ğ
PUD_SIZE
) {

215 
pmd_t
 *
pmd
 = 
pmds
[
i
];

217 ià(
i
 >ğ
KERNEL_PGD_BOUNDARY
)

218 
	`memıy
(
pmd
, (
pmd_t
 *)
	`pgd_·ge_vaddr
(
sw­³r_pg_dœ
[
i
]),

219 (
pmd_t
è* 
PTRS_PER_PMD
);

221 
	`pud_pİuÏ‹
(
mm
, 
pud
, 
pmd
);

223 
	}
}

225 
pgd_t
 *
	$pgd_®loc
(
mm_¡ruù
 *
mm
)

227 
pgd_t
 *
pgd
;

228 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

229 
æags
;

231 
pgd
 = (
pgd_t
 *)
	`__g‘_ä“_·ge
(
GFP_KERNEL
 | 
__GFP_ZERO
);

233 ià(
pgd
 =ğ
NULL
)

234 
out
;

236 
mm
->
pgd
 =…gd;

238 ià(
	`´—Îoÿ‹_pmds
(
pmds
) != 0)

239 
out_ä“_pgd
;

241 ià(
	`·¿vœt_pgd_®loc
(
mm
) != 0)

242 
out_ä“_pmds
;

249 
	`¥š_lock_œq§ve
(&
pgd_lock
, 
æags
);

251 
	`pgd_ùÜ
(
pgd
);

252 
	`pgd_´•İuÏ‹_pmd
(
mm
, 
pgd
, 
pmds
);

254 
	`¥š_uÆock_œq»¡Üe
(&
pgd_lock
, 
æags
);

256  
pgd
;

258 
out_ä“_pmds
:

259 
	`ä“_pmds
(
pmds
);

260 
out_ä“_pgd
:

261 
	`ä“_·ge
(()
pgd
);

262 
out
:

263  
NULL
;

264 
	}
}

266 
	$pgd_ä“
(
mm_¡ruù
 *
mm
, 
pgd_t
 *
pgd
)

268 
	`pgd_mİ_up_pmds
(
mm
, 
pgd
);

269 
	`pgd_dtÜ
(
pgd
);

270 
	`·¿vœt_pgd_ä“
(
mm
, 
pgd
);

271 
	`ä“_·ge
(()
pgd
);

272 
	}
}

274 
	$±•_£t_acûss_æags
(
vm_¬—_¡ruù
 *
vma
,

275 
add»ss
, 
±e_t
 *
±•
,

276 
±e_t
 
’Œy
, 
dœty
)

278 
chªged
 = !
	`±e_§me
(*
±•
, 
’Œy
);

280 ià(
chªged
 && 
dœty
) {

281 *
±•
 = 
’Œy
;

282 
	`±e_upd©e_deãr
(
vma
->
vm_mm
, 
add»ss
, 
±•
);

283 
	`æush_b_·ge
(
vma
, 
add»ss
);

286  
chªged
;

287 
	}
}

289 
	$±•_‹¡_ªd_ş—r_young
(
vm_¬—_¡ruù
 *
vma
,

290 
addr
, 
±e_t
 *
±•
)

292 
»t
 = 0;

294 ià(
	`±e_young
(*
±•
))

295 
»t
 = 
	`‹¡_ªd_ş—r_b™
(
_PAGE_BIT_ACCESSED
,

296 (*è&
±•
->
±e
);

298 ià(
»t
)

299 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±•
);

301  
»t
;

302 
	}
}

304 
	$±•_ş—r_æush_young
(
vm_¬—_¡ruù
 *
vma
,

305 
add»ss
, 
±e_t
 *
±•
)

307 
young
;

309 
young
 = 
	`±•_‹¡_ªd_ş—r_young
(
vma
, 
add»ss
, 
±•
);

310 ià(
young
)

311 
	`æush_b_·ge
(
vma
, 
add»ss
);

313  
young
;

314 
	}
}

323 
__š™
 
	$»£rve_tİ_add»ss
(
»£rve
)

325 #ifdeà
CONFIG_X86_32


326 
	`BUG_ON
(
fixm­s_£t
 > 0);

327 
	`´štk
(
KERN_INFO
 "Reserving virtual‡ddress space‡bove 0x%08x\n",

328 ()-
»£rve
);

329 
__FIXADDR_TOP
 = -
»£rve
 - 
PAGE_SIZE
;

330 
__VMALLOC_RESERVE
 +ğ
»£rve
;

332 
	}
}

334 
	gfixm­s_£t
;

336 
	$__Çtive_£t_fixm­
(
fixed_add»s£s
 
idx
, 
±e_t
 
±e
)

338 
add»ss
 = 
	`__fix_to_vœt
(
idx
);

340 ià(
idx
 >ğ
__’d_of_fixed_add»s£s
) {

341 
	`BUG
();

344 
	`£t_±e_vaddr
(
add»ss
, 
±e
);

345 
fixm­s_£t
++;

346 
	}
}

348 
	$Çtive_£t_fixm­
(
fixed_add»s£s
 
idx
, 
phys_addr_t
 
phys
,

349 
pg´Ù_t
 
æags
)

351 
	`__Çtive_£t_fixm­
(
idx
, 
	`pâ_±e
(
phys
 >> 
PAGE_SHIFT
, 
æags
));

352 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/aıi.h
>

14 
	~<lšux/mmzÚe.h
>

15 
	~<lšux/b™m­.h
>

16 
	~<lšux/moduË.h
>

17 
	~<lšux/tİŞogy.h
>

18 
	~<lšux/boÙmem.h
>

19 
	~<lšux/mm.h
>

20 
	~<asm/´Ùo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/­ic.h
>

24 
	~<asm/uv/uv.h
>

26 
aıi_numa
 
	g__š™d©a
;

28 
aıi_bË_¦™
 *
	gaıi_¦™
;

30 
nodemask_t
 
nodes_·r£d
 
	g__š™d©a
;

31 
nodemask_t
 
ıu_nodes_·r£d
 
	g__š™d©a
;

32 
boÙnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__š™d©a
;

33 
boÙnode
 
	gnodes_add
[
MAX_NUMNODES
];

34 
found_add_¬—
 
	g__š™d©a
;

35 
hÙadd_³rûÁ
 
	g__š™d©a
 = 0;

37 
num_node_memblks
 
	g__š™d©a
;

38 
boÙnode
 
	gnode_memblk_¿nge
[
NR_NODE_MEMBLKS
] 
	g__š™d©a
;

39 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__š™d©a
;

43 
	#NODE_MIN_SIZE
 (4*1024*1024)

	)

45 
__š™
 
	$£tup_node
(
pxm
)

47  
	`aıi_m­_pxm_to_node
(
pxm
);

48 
	}
}

50 
__š™
 
	$cÚæiùšg_memblks
(
¡¬t
, 
’d
)

52 
i
;

53 
i
 = 0; i < 
num_node_memblks
; i++) {

54 
boÙnode
 *
nd
 = &
node_memblk_¿nge
[
i
];

55 ià(
nd
->
¡¬t
 =ğnd->
’d
)

57 ià(
nd
->
’d
 > 
¡¬t
 &&‚d->start <ƒnd)

58  
memblk_nodeid
[
i
];

59 ià(
nd
->
’d
 =ğ’d &&‚d->
¡¬t
 == start)

60  
memblk_nodeid
[
i
];

63 
	}
}

65 
__š™
 
	$cutoff_node
(
i
, 
¡¬t
, 
’d
)

67 
boÙnode
 *
nd
 = &
nodes
[
i
];

69 ià(
found_add_¬—
)

72 ià(
nd
->
¡¬t
 < start) {

73 
nd
->
¡¬t
 = start;

74 ià(
nd
->
’d
 <‚d->
¡¬t
)

75 
nd
->
¡¬t
 =‚d->
’d
;

77 ià(
nd
->
’d
 >ƒnd) {

78 
nd
->
’d
 =ƒnd;

79 ià(
nd
->
¡¬t
 >‚d->
’d
)

80 
nd
->
¡¬t
 =‚d->
’d
;

82 
	}
}

84 
__š™
 
	$bad_¤©
()

86 
i
;

87 
	`´štk
(
KERN_ERR
 "SRAT: SRAT‚ot used.\n");

88 
aıi_numa
 = -1;

89 
found_add_¬—
 = 0;

90 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

91 
­icid_to_node
[
i
] = 
NUMA_NO_NODE
;

92 
i
 = 0; i < 
MAX_NUMNODES
; i++)

93 
nodes_add
[
i
].
¡¬t
 = 
nodes
[i].
’d
 = 0;

94 
	`»move_®l_aùive_¿nges
();

95 
	}
}

97 
__š™
 
šlše
 
	$¤©_di§bËd
()

99  
numa_off
 || 
aıi_numa
 < 0;

100 
	}
}

103 
__š™
 
	$aıi_numa_¦™_š™
(
aıi_bË_¦™
 *
¦™
)

105 
Ëngth
;

106 
phys
;

108 
Ëngth
 = 
¦™
->
h—d”
.length;

109 
phys
 = 
	`fšd_e820_¬—
(0, 
max_pâ_m­³d
<<
PAGE_SHIFT
, 
Ëngth
,

110 
PAGE_SIZE
);

112 ià(
phys
 == -1L)

113 
	`·nic
(" Can‚ot save slit!\n");

115 
aıi_¦™
 = 
	`__va
(
phys
);

116 
	`memıy
(
aıi_¦™
, 
¦™
, 
Ëngth
);

117 
	`»£rve_—¾y
(
phys
,…hy + 
Ëngth
, "ACPI SLIT");

118 
	}
}

121 
__š™


122 
	$aıi_numa_x2­ic_affš™y_š™
(
aıi_¤©_x2­ic_ıu_affš™y
 *
·
)

124 
pxm
, 
node
;

125 
­ic_id
;

127 ià(
	`¤©_di§bËd
())

129 ià(
·
->
h—d”
.
Ëngth
 < (
aıi_¤©_x2­ic_ıu_affš™y
)) {

130 
	`bad_¤©
();

133 ià((
·
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

135 
pxm
 = 
·
->
´oxim™y_domaš
;

136 
node
 = 
	`£tup_node
(
pxm
);

137 ià(
node
 < 0) {

138 
	`´štk
(
KERN_ERR
 "SRAT: ToØmªy…roxim™y domaš %x\n", 
pxm
);

139 
	`bad_¤©
();

143 
­ic_id
 = 
·
->apic_id;

144 
­icid_to_node
[
­ic_id
] = 
node
;

145 
	`node_£t
(
node
, 
ıu_nodes_·r£d
);

146 
aıi_numa
 = 1;

147 
	`´štk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

148 
pxm
, 
­ic_id
, 
node
);

149 
	}
}

152 
__š™


153 
	$aıi_numa_´oûssÜ_affš™y_š™
(
aıi_¤©_ıu_affš™y
 *
·
)

155 
pxm
, 
node
;

156 
­ic_id
;

158 ià(
	`¤©_di§bËd
())

160 ià(
·
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_ıu_affš™y
)) {

161 
	`bad_¤©
();

164 ià((
·
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

166 
pxm
 = 
·
->
´oxim™y_domaš_lo
;

167 
node
 = 
	`£tup_node
(
pxm
);

168 ià(
node
 < 0) {

169 
	`´štk
(
KERN_ERR
 "SRAT: ToØmªy…roxim™y domaš %x\n", 
pxm
);

170 
	`bad_¤©
();

174 ià(
	`g‘_uv_sy¡em_ty³
(è>ğ
UV_X2APIC
)

175 
­ic_id
 = (
·
->­ic_id << 8è|…a->
loÿl_§pic_eid
;

177 
­ic_id
 = 
·
->apic_id;

178 
­icid_to_node
[
­ic_id
] = 
node
;

179 
	`node_£t
(
node
, 
ıu_nodes_·r£d
);

180 
aıi_numa
 = 1;

181 
	`´štk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

182 
pxm
, 
­ic_id
, 
node
);

183 
	}
}

185 
	$upd©e_’d_of_memÜy
(
’d
è{ -1;
	}
}

186 
	$hÙadd_’ough_memÜy
(
boÙnode
 *
nd
è{ 1;
	}
}

187 #ifdeà
CONFIG_MEMORY_HOTPLUG_SPARSE


188 
šlše
 
	$§ve_add_šfo
(è{ 1;
	}
}

190 
šlše
 
	$§ve_add_šfo
(è{ 0;
	}
}

197 
__š™


198 
	$»£rve_hÙadd
(
node
, 
¡¬t
, 
’d
)

200 
s_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

201 
e_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

202 
»t
 = 0, 
chªged
 = 0;

203 
boÙnode
 *
nd
 = &
nodes_add
[
node
];

211 ià((sigÃd )(
’d
 - 
¡¬t
è< 
NODE_MIN_SIZE
) {

212 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug‡reaoo small\n");

217 ià(
	`ab£Á_·ges_š_¿nge
(
s_pâ
, 
e_pâ
) !=ƒ_pfn - s_pfn) {

218 
	`´štk
(
KERN_ERR


220 
s_pâ
, 
e_pâ
);

224 ià(!
	`hÙadd_’ough_memÜy
(&
nodes_add
[
node
])) {

225 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug‡reaoo†arge\n");

231 ià(
nd
->
¡¬t
 =ğnd->
’d
) {

232 
nd
->
¡¬t
 = start;

233 
nd
->
’d
 =ƒnd;

234 
chªged
 = 1;

236 ià(
nd
->
¡¬t
 =ğ
’d
) {

237 
nd
->
¡¬t
 = start;

238 
chªged
 = 1;

240 ià(
nd
->
’d
 =ğ
¡¬t
) {

241 
nd
->
’d
 =ƒnd;

242 
chªged
 = 1;

244 ià(!
chªged
)

245 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug zone‚ot continuous. Partly ignored\n");

248 
»t
 = 
	`upd©e_’d_of_memÜy
(
nd
->
’d
);

250 ià(
chªged
)

251 
	`´štk
(
KERN_INFO
 "SRAT: hÙ…lug zÚfound %Lx - %Lx\n", 
nd
->
¡¬t
,‚d->
’d
);

252  
»t
;

253 
	}
}

256 
__š™


257 
	$aıi_numa_memÜy_affš™y_š™
(
aıi_¤©_mem_affš™y
 *
ma
)

259 
boÙnode
 *
nd
, 
Şdnode
;

260 
¡¬t
, 
’d
;

261 
node
, 
pxm
;

262 
i
;

264 ià(
	`¤©_di§bËd
())

266 ià(
ma
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_mem_affš™y
)) {

267 
	`bad_¤©
();

270 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

273 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
è&& !
	`§ve_add_šfo
())

275 
¡¬t
 = 
ma
->
ba£_add»ss
;

276 
’d
 = 
¡¬t
 + 
ma
->
Ëngth
;

277 
pxm
 = 
ma
->
´oxim™y_domaš
;

278 
node
 = 
	`£tup_node
(
pxm
);

279 ià(
node
 < 0) {

280 
	`´štk
(
KERN_ERR
 "SRAT: Too many…roximity domains.\n");

281 
	`bad_¤©
();

284 
i
 = 
	`cÚæiùšg_memblks
(
¡¬t
, 
’d
);

285 ià(
i
 =ğ
node
) {

286 
	`´štk
(
KERN_WARNING


288 
pxm
, 
¡¬t
, 
’d
, 
nodes
[
i
].start,‚odes[i].end);

289 } ià(
i
 >= 0) {

290 
	`´štk
(
KERN_ERR


292 
pxm
, 
¡¬t
, 
’d
, 
	`node_to_pxm
(
i
),

293 
nodes
[
i
].
¡¬t
,‚odes[i].
’d
);

294 
	`bad_¤©
();

297 
nd
 = &
nodes
[
node
];

298 
Şdnode
 = *
nd
;

299 ià(!
	`node_‹¡_ªd_£t
(
node
, 
nodes_·r£d
)) {

300 
nd
->
¡¬t
 = start;

301 
nd
->
’d
 =ƒnd;

303 ià(
¡¬t
 < 
nd
->start)

304 
nd
->
¡¬t
 = start;

305 ià(
nd
->
’d
 <ƒnd)

306 
nd
->
’d
 =ƒnd;

309 
	`´štk
(
KERN_INFO
 "SRAT: Nod%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

310 
¡¬t
, 
’d
);

311 
	`e820_»gi¡”_aùive_»giÚs
(
node
, 
¡¬t
 >> 
PAGE_SHIFT
,

312 
’d
 >> 
PAGE_SHIFT
);

313 
	`push_node_bound¬›s
(
node
, 
nd
->
¡¬t
 >> 
PAGE_SHIFT
,

314 
nd
->
’d
 >> 
PAGE_SHIFT
);

316 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) &&

317 (
	`»£rve_hÙadd
(
node
, 
¡¬t
, 
’d
) < 0)) {

319 
	`´štk
(
KERN_NOTICE
 "SRAT: Hotplug„egion ignored\n");

320 *
nd
 = 
Şdnode
;

321 ià((
nd
->
¡¬t
 |‚d->
’d
) == 0)

322 
	`node_ş—r
(
node
, 
nodes_·r£d
);

325 
node_memblk_¿nge
[
num_node_memblks
].
¡¬t
 = start;

326 
node_memblk_¿nge
[
num_node_memblks
].
’d
 =ƒnd;

327 
memblk_nodeid
[
num_node_memblks
] = 
node
;

328 
num_node_memblks
++;

329 
	}
}

333 
__š™
 
	$nodes_cov”_memÜy
(cÚ¡ 
boÙnode
 *
nodes
)

335 
i
;

336 
pxm¿m
, 
e820¿m
;

338 
pxm¿m
 = 0;

339 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
) {

340 
s
 = 
nodes
[
i
].
¡¬t
 >> 
PAGE_SHIFT
;

341 
e
 = 
nodes
[
i
].
’d
 >> 
PAGE_SHIFT
;

342 
pxm¿m
 +ğ
e
 - 
s
;

343 
pxm¿m
 -ğ
	`ab£Á_·ges_š_¿nge
(
s
, 
e
);

344 ià(()
pxm¿m
 < 0)

345 
pxm¿m
 = 0;

348 
e820¿m
 = 
max_pâ
 - 
	`ab£Á_·ges_š_¿nge
(0, max_pfn);

350 ià(()(
e820¿m
 - 
pxm¿m
) >= 1*1024*1024) {

351 
	`´štk
(
KERN_ERR


353 (
pxm¿m
 << 
PAGE_SHIFT
) >> 20,

354 (
e820¿m
 << 
PAGE_SHIFT
) >> 20);

358 
	}
}

360 
__š™
 
	$uÅ¬£_node
(
node
)

362 
i
;

363 
	`node_ş—r
(
node
, 
nodes_·r£d
);

364 
	`node_ş—r
(
node
, 
ıu_nodes_·r£d
);

365 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++) {

366 ià(
­icid_to_node
[
i
] =ğ
node
)

367 
­icid_to_node
[
i
] = 
NUMA_NO_NODE
;

369 
	}
}

371 
__š™
 
	$aıi_numa_¬ch_fixup
(è{
	}
}

374 
__š™
 
	$aıi_sÿn_nodes
(
¡¬t
, 
’d
)

376 
i
;

378 ià(
aıi_numa
 <= 0)

382 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

383 
	`cutoff_node
(
i
, 
¡¬t
, 
’d
);

388 ià(
nodes
[
i
].
’d
 &&

389 (
nodes
[
i
].
’d
 -‚odes[i].
¡¬t
è< 
NODE_MIN_SIZE
) {

390 
	`uÅ¬£_node
(
i
);

391 
	`node_£t_ofæše
(
i
);

395 ià(!
	`nodes_cov”_memÜy
(
nodes
)) {

396 
	`bad_¤©
();

400 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
node_memblk_¿nge
, 
num_node_memblks
,

401 
memblk_nodeid
);

402 ià(
memnode_shiá
 < 0) {

403 
	`´štk
(
KERN_ERR


405 
	`bad_¤©
();

410 
	`nodes_Ü
(
node_possibË_m­
, 
nodes_·r£d
, 
ıu_nodes_·r£d
);

413 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
)

414 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

417 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
)

418 ià(!
	`node_Úlše
(
i
))

419 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

421 
i
 = 0; i < 
Ä_ıu_ids
; i++) {

422 
node
 = 
	`—¾y_ıu_to_node
(
i
);

424 ià(
node
 =ğ
NUMA_NO_NODE
)

426 ià(!
	`node_is£t
(
node
, 
node_possibË_m­
))

427 
	`numa_ş—r_node
(
i
);

429 
	`numa_š™_¬¿y
();

431 
	}
}

433 #ifdeà
CONFIG_NUMA_EMU


434 
	gçke_node_to_pxm_m­
[
MAX_NUMNODES
] 
	g__š™d©a
 = {

435 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


437 
s16
 
	gçke_­icid_to_node
[
MAX_LOCAL_APIC
] 
	g__š™d©a
 = {

438 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


440 
__š™
 
	$fšd_node_by_addr
(
addr
)

442 
»t
 = 
NUMA_NO_NODE
;

443 
i
;

445 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
) {

451 ià(
addr
 >ğ
nodes
[
i
].
¡¬t
 &&‡dd¸<‚odes[i].
’d
) {

452 
»t
 = 
i
;

456  
»t
;

457 
	}
}

467 
__š™
 
	$aıi_çke_nodes
(cÚ¡ 
boÙnode
 *
çke_nodes
, 
num_nodes
)

469 
i
, 
j
;

471 
	`´štk
(
KERN_INFO
 "Faking PXM‡ffinity for fake‚odes on„eal "

473 
i
 = 0; i < 
num_nodes
; i++) {

474 
nid
, 
pxm
;

476 
nid
 = 
	`fšd_node_by_addr
(
çke_nodes
[
i
].
¡¬t
);

477 ià(
nid
 =ğ
NUMA_NO_NODE
)

479 
pxm
 = 
	`node_to_pxm
(
nid
);

480 ià(
pxm
 =ğ
PXM_INVAL
)

482 
çke_node_to_pxm_m­
[
i
] = 
pxm
;

487 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

488 ià(
­icid_to_node
[
j
] =ğ
nid
)

489 
çke_­icid_to_node
[
j
] = 
i
;

491 
i
 = 0; i < 
num_nodes
; i++)

492 
	`__aıi_m­_pxm_to_node
(
çke_node_to_pxm_m­
[
i
], i);

493 
	`memıy
(
­icid_to_node
, 
çke_­icid_to_node
, (apicid_to_node));

495 
	`nodes_ş—r
(
nodes_·r£d
);

496 
i
 = 0; i < 
num_nodes
; i++)

497 ià(
çke_nodes
[
i
].
¡¬t
 !ğçke_nodes[i].
’d
)

498 
	`node_£t
(
i
, 
nodes_·r£d
);

499 
	`WARN_ON
(!
	`nodes_cov”_memÜy
(
çke_nodes
));

500 
	}
}

502 
	$nuÎ_¦™_node_com·»
(
a
, 
b
)

504  
	`node_to_pxm
(
a
è=ğnode_to_pxm(
b
);

505 
	}
}

507 
	$nuÎ_¦™_node_com·»
(
a
, 
b
)

509  
a
 =ğ
b
;

510 
	}
}

513 
__š™
 
	$¤©_»£rve_add_¬—
(
nodeid
)

515 ià(
found_add_¬—
 && 
nodes_add
[
nodeid
].
’d
) {

516 
u64
 
tÙ®_mb
;

518 
	`´štk
(
KERN_INFO
 "SRAT: Reserving hot-add memory space "

520 
nodeid
, 
nodes_add
[nodeid].
¡¬t
,‚odes_add[nodeid].
’d
);

521 
tÙ®_mb
 = (
nodes_add
[
nodeid
].
’d
 -‚odes_add[nodeid].
¡¬t
)

522 >> 
PAGE_SHIFT
;

523 
tÙ®_mb
 *ğ(
·ge
);

524 
tÙ®_mb
 >>= 20;

525 
	`´štk
(
KERN_INFO
 "SRAT: This will cost you %Lu MB of "

526 "´e-®loÿ‹d memÜy.\n", ()
tÙ®_mb
);

527 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
nodes_add
[nodeid].
¡¬t
,

528 
nodes_add
[
nodeid
].
’d
 -‚odes_add[nodeid].
¡¬t
,

529 
BOOTMEM_DEFAULT
);

531 
	}
}

533 
	$__node_di¡ªû
(
a
, 
b
)

535 
šdex
;

537 ià(!
aıi_¦™
)

538  
	`nuÎ_¦™_node_com·»
(
a
, 
b
è? 
LOCAL_DISTANCE
 :

539 
REMOTE_DISTANCE
;

540 
šdex
 = 
aıi_¦™
->
loÿl™y_couÁ
 * 
	`node_to_pxm
(
a
);

541  
aıi_¦™
->
’Œy
[
šdex
 + 
	`node_to_pxm
(
b
)];

542 
	}
}

544 
EXPORT_SYMBOL
(
__node_di¡ªû
);

546 #ià
defšed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
è|| defšed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

547 
	$memÜy_add_phy§ddr_to_nid
(
u64
 
¡¬t
)

549 
i
, 
»t
 = 0;

551 
	`fÜ_—ch_node
(
i
)

552 ià(
nodes_add
[
i
].
¡¬t
 <ğ¡¬ˆ&&‚odes_add[i].
’d
 > start)

553 
»t
 = 
i
;

555  
»t
;

556 
	}
}

557 
EXPORT_SYMBOL_GPL
(
memÜy_add_phy§ddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<lšux/š™.h
>

3 
	~<lšux/mm.h
>

4 
	~<lšux/¥šlock.h
>

5 
	~<lšux/smp.h
>

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/moduË.h
>

9 
	~<asm/bæush.h
>

10 
	~<asm/mmu_cÚ‹xt.h
>

11 
	~<asm/­ic.h
>

12 
	~<asm/uv/uv.h
>

14 
DEFINE_PER_CPU_SHARED_ALIGNED
(
b_¡©e
, 
ıu_b¡©e
)

15 ğ{ &
š™_mm
, 0, };

39 
	usmp_æush_¡©e
 {

41 
mm_¡ruù
 *
	mæush_mm
;

42 
	mæush_va
;

43 
¥šlock_t
 
	mb¡©e_lock
;

44 
DECLARE_BITMAP
(
æush_ıumask
, 
NR_CPUS
);

46 
	m·d
[
CONFIG_X86_INTERNODE_CACHE_BYTES
];

47 } 
	g____ÿch–še_š‹ºod—ligÃd_š_smp
;

52 
smp_æush_¡©e
 
	gæush_¡©e
[
NUM_INVALIDATE_TLB_VECTORS
];

58 
	$Ëave_mm
(
ıu
)

60 ià(
	`³rıu_»ad
(
ıu_b¡©e
.
¡©e
è=ğ
TLBSTATE_OK
)

61 
	`BUG
();

62 
	`ıu_ş—r
(
ıu
, 
	`³rıu_»ad
(
ıu_b¡©e
.
aùive_mm
)->
ıu_vm_mask
);

63 
	`lßd_ü3
(
sw­³r_pg_dœ
);

64 
	}
}

65 
EXPORT_SYMBOL_GPL
(
Ëave_mm
);

122 #ifdeà
CONFIG_X86_64


123 
	gasmlškage


125 
	$smp_šv®id©e_š‹¼u±
(
±_»gs
 *
»gs
)

127 
ıu
;

128 
£nd”
;

129 
smp_æush_¡©e
 *
f
;

131 
ıu
 = 
	`smp_´oûssÜ_id
();

136 
£nd”
 = ~
»gs
->
Üig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

137 
f
 = &
æush_¡©e
[
£nd”
];

139 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
	`to_ıumask
(
f
->
æush_ıumask
)))

140 
out
;

150 ià(
f
->
æush_mm
 =ğ
	`³rıu_»ad
(
ıu_b¡©e
.
aùive_mm
)) {

151 ià(
	`³rıu_»ad
(
ıu_b¡©e
.
¡©e
è=ğ
TLBSTATE_OK
) {

152 ià(
f
->
æush_va
 =ğ
TLB_FLUSH_ALL
)

153 
	`loÿl_æush_b
();

155 
	`__æush_b_Úe
(
f
->
æush_va
);

157 
	`Ëave_mm
(
ıu
);

159 
out
:

160 
	`ack_APIC_œq
();

161 
	`smp_mb__befÜe_ş—r_b™
();

162 
	`ıumask_ş—r_ıu
(
ıu
, 
	`to_ıumask
(
f
->
æush_ıumask
));

163 
	`smp_mb__aá”_ş—r_b™
();

164 
	`šc_œq_¡©
(
œq_b_couÁ
);

165 
	}
}

167 
	$æush_b_Ùh”s_i
(cÚ¡ 
ıumask
 *cpumask,

168 
mm_¡ruù
 *
mm
, 
va
)

170 
£nd”
;

171 
smp_æush_¡©e
 *
f
;

174 
£nd”
 = 
	`smp_´oûssÜ_id
(è% 
NUM_INVALIDATE_TLB_VECTORS
;

175 
f
 = &
æush_¡©e
[
£nd”
];

182 
	`¥š_lock
(&
f
->
b¡©e_lock
);

184 
f
->
æush_mm
 = 
mm
;

185 
f
->
æush_va
 = 
va
;

186 
	`ıumask_ªdnÙ
(
	`to_ıumask
(
f
->
æush_ıumask
),

187 
ıumask
, 
	`ıumask_of
(
	`smp_´oûssÜ_id
()));

193 
­ic
->
	`£nd_IPI_mask
(
	`to_ıumask
(
f
->
æush_ıumask
),

194 
INVALIDATE_TLB_VECTOR_START
 + 
£nd”
);

196 !
	`ıumask_em±y
(
	`to_ıumask
(
f
->
æush_ıumask
)))

197 
	`ıu_»Ïx
();

199 
f
->
æush_mm
 = 
NULL
;

200 
f
->
æush_va
 = 0;

201 
	`¥š_uÆock
(&
f
->
b¡©e_lock
);

202 
	}
}

204 
	$Çtive_æush_b_Ùh”s
(cÚ¡ 
ıumask
 *cpumask,

205 
mm_¡ruù
 *
mm
, 
va
)

207 ià(
	`is_uv_sy¡em
()) {

208 
ıu
;

210 
ıu
 = 
	`g‘_ıu
();

211 
ıumask
 = 
	`uv_æush_b_Ùh”s
(ıumask, 
mm
, 
va
, 
ıu
);

212 ià(
ıumask
)

213 
	`æush_b_Ùh”s_i
(
ıumask
, 
mm
, 
va
);

214 
	`put_ıu
();

217 
	`æush_b_Ùh”s_i
(
ıumask
, 
mm
, 
va
);

218 
	}
}

220 
__ıuš™
 
	$š™_smp_æush
()

222 
i
;

224 
i
 = 0; i < 
	`ARRAY_SIZE
(
æush_¡©e
); i++)

225 
	`¥š_lock_š™
(&
æush_¡©e
[
i
].
b¡©e_lock
);

228 
	}
}

229 
cÜe_š™ÿÎ
(
š™_smp_æush
);

231 
	$æush_b_cu¼’t_sk
()

233 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

235 
	`´“m±_di§bË
();

237 
	`loÿl_æush_b
();

238 ià(
	`ıumask_ªy_but
(&
mm
->
ıu_vm_mask
, 
	`smp_´oûssÜ_id
()è< 
Ä_ıu_ids
)

239 
	`æush_b_Ùh”s
(&
mm
->
ıu_vm_mask
, mm, 
TLB_FLUSH_ALL
);

240 
	`´“m±_’abË
();

241 
	}
}

243 
	$æush_b_mm
(
mm_¡ruù
 *
mm
)

245 
	`´“m±_di§bË
();

247 ià(
cu¼’t
->
aùive_mm
 =ğ
mm
) {

248 ià(
cu¼’t
->
mm
)

249 
	`loÿl_æush_b
();

251 
	`Ëave_mm
(
	`smp_´oûssÜ_id
());

253 ià(
	`ıumask_ªy_but
(&
mm
->
ıu_vm_mask
, 
	`smp_´oûssÜ_id
()è< 
Ä_ıu_ids
)

254 
	`æush_b_Ùh”s
(&
mm
->
ıu_vm_mask
, mm, 
TLB_FLUSH_ALL
);

256 
	`´“m±_’abË
();

257 
	}
}

259 
	$æush_b_·ge
(
vm_¬—_¡ruù
 *
vma
, 
va
)

261 
mm_¡ruù
 *
mm
 = 
vma
->
vm_mm
;

263 
	`´“m±_di§bË
();

265 ià(
cu¼’t
->
aùive_mm
 =ğ
mm
) {

266 ià(
cu¼’t
->
mm
)

267 
	`__æush_b_Úe
(
va
);

269 
	`Ëave_mm
(
	`smp_´oûssÜ_id
());

272 ià(
	`ıumask_ªy_but
(&
mm
->
ıu_vm_mask
, 
	`smp_´oûssÜ_id
()è< 
Ä_ıu_ids
)

273 
	`æush_b_Ùh”s
(&
mm
->
ıu_vm_mask
, mm, 
va
);

275 
	`´“m±_’abË
();

276 
	}
}

278 
	$do_æush_b_®l
(*
šfo
)

280 
ıu
 = 
	`smp_´oûssÜ_id
();

282 
	`__æush_b_®l
();

283 ià(
	`³rıu_»ad
(
ıu_b¡©e
.
¡©e
è=ğ
TLBSTATE_LAZY
)

284 
	`Ëave_mm
(
ıu
);

285 
	}
}

287 
	$æush_b_®l
()

289 
	`Ú_—ch_ıu
(
do_æush_b_®l
, 
NULL
, 1);

290 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/posix-tim”s.h
>

17 
	~<lšux/time.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<asm/vsysÿÎ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h³t.h
>

23 
	~<asm/uni¡d.h
>

24 
	~<asm/io.h
>

25 
	~"vex‹º.h
"

27 
	#gtod
 
vdso_vsysÿÎ_gtod_d©a


	)

29 
nÙ¿û
 
	$vdso_çÎback_g‘time
(
şock
, 
time¥ec
 *
ts
)

31 
»t
;

32 
	`asm
("sysÿÎ" : "÷" (
»t
) :

33 "0" (
__NR_şock_g‘time
),"D" (
şock
), "S" (
ts
) : "memory");

34  
»t
;

35 
	}
}

37 
nÙ¿û
 
šlše
 
	$vg‘ns
()

39 
v
;

40 
	`cyşes_t
 (*
v»ad
)();

41 
v»ad
 = 
gtod
->
şock
.vread;

42 
v
 = (
	`v»ad
(è- 
gtod
->
şock
.
cyşe_Ï¡
è& gtod->şock.
mask
;

43  (
v
 * 
gtod
->
şock
.
muÉ
è>> gtod->şock.
shiá
;

44 
	}
}

46 
nÙ¿û
 
nošlše
 
	$do_»®time
(
time¥ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`»ad_£qbegš
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
w®l_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
w®l_time_n£c
;

53 
ns
 = 
	`vg‘ns
();

54 } 
	`uÆik–y
(
	`»ad_£q»Œy
(&
gtod
->
lock
, 
£q
)));

55 
	`time¥ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nÙ¿û
 

61 
	$v£t_nÜm®ized_time¥ec
(
time¥ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >ğ
NSEC_PER_SEC
) {

64 
n£c
 -ğ
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +ğ
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nÙ¿û
 
nošlše
 
	$do_mÚÙÚic
(
time¥ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`»ad_£qbegš
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
w®l_time_£c
;

81 
ns
 = 
gtod
->
w®l_time_n£c
 + 
	`vg‘ns
();

82 
£cs
 +ğ
gtod
->
w®l_to_mÚÙÚic
.
tv_£c
;

83 
ns
 +ğ
gtod
->
w®l_to_mÚÙÚic
.
tv_n£c
;

84 } 
	`uÆik–y
(
	`»ad_£q»Œy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_nÜm®ized_time¥ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nÙ¿û
 
	$__vdso_şock_g‘time
(
şockid_t
 
şock
, 
time¥ec
 *
ts
)

91 ià(
	`lik–y
(
gtod
->
sysùl_’abËd
 && gtod->
şock
.
v»ad
))

92 
şock
) {

93 
CLOCK_REALTIME
:

94  
	`do_»®time
(
ts
);

95 
CLOCK_MONOTONIC
:

96  
	`do_mÚÙÚic
(
ts
);

98  
	`vdso_çÎback_g‘time
(
şock
, 
ts
);

99 
	}
}

100 
	$şock_g‘time
(
şockid_t
, 
time¥ec
 *)

101 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_clock_gettime")));

103 
nÙ¿û
 
	$__vdso_g‘timeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

105 
»t
;

106 ià(
	`lik–y
(
gtod
->
sysùl_’abËd
 && gtod->
şock
.
v»ad
)) {

107 ià(
	`lik–y
(
tv
 !ğ
NULL
)) {

108 
	`BUILD_BUG_ON
(
	`off£tof
(
timev®
, 
tv_u£c
) !=

109 
	`off£tof
(
time¥ec
, 
tv_n£c
) ||

110 (*
tv
è!ğ(
time¥ec
));

111 
	`do_»®time
((
time¥ec
 *)
tv
);

112 
tv
->
tv_u£c
 /= 1000;

114 ià(
	`uÆik–y
(
tz
 !ğ
NULL
)) {

116 
tz
->
tz_mšu‹swe¡
 = 
gtod
->
sys_tz
.tz_minuteswest;

117 
tz
->
tz_d¡time
 = 
gtod
->
sys_tz
.tz_dsttime;

121 
	`asm
("sysÿÎ" : "÷" (
»t
) :

122 "0" (
__NR_g‘timeofday
), "D" (
tv
), "S" (
tz
) : "memory");

123  
»t
;

124 
	}
}

125 
	$g‘timeofday
(
timev®
 *, 
timezÚe
 *)

126 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/g‘ıu.h
>

10 
	~<lšux/jiff›s.h
>

11 
	~<lšux/time.h
>

12 
	~<asm/vsysÿÎ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vex‹º.h
"

16 
nÙ¿û
 

17 
	$__vdso_g‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
unu£d
)

19 
p
;

21 ià(*
vdso_vg‘ıu_mode
 =ğ
VGETCPU_RDTSCP
) {

23 
	`Çtive_»ad_tsı
(&
p
);

26 
	`asm
("l¦ %1,%0" : "ô" (
p
è: "r" (
__PER_CPU_SEG
));

28 ià(
ıu
)

29 *
ıu
 = 
p
 & 0xfff;

30 ià(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$g‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
tÿche
)

36 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<lšux/mm.h
>

7 
	~<lšux/”r.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/¿ndom.h
>

11 
	~<asm/vsysÿÎ.h
>

12 
	~<asm/vgtod.h
>

13 
	~<asm/´Ùo.h
>

14 
	~<asm/vdso.h
>

16 
	~"vex‹º.h
"

17 #undeà
VEXTERN


19 
__»ad_mo¡ly
 
	gvdso_’abËd
 = 1;

21 
vdso_¡¬t
[], 
vdso_’d
[];

22 
vdso_sync_ıuid
;

24 
·ge
 **
	gvdso_·ges
;

25 
	gvdso_size
;

27 
šlše
 *
	$v¬_»f
(*
p
, *
Çme
)

29 ià(*(**)
p
 !ğ(*)
VMAGIC
) {

30 
	`´štk
("VDSO: v¬ŸbË % brok’\n", 
Çme
);

31 
vdso_’abËd
 = 0;

33  
p
;

34 
	}
}

36 
__š™
 
	$š™_vdso_v¬s
()

38 
Åages
 = (
vdso_’d
 - 
vdso_¡¬t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

39 
i
;

40 *
vba£
;

42 
vdso_size
 = 
Åages
 << 
PAGE_SHIFT
;

43 
vdso_·ges
 = 
	`km®loc
((
·ge
 *è* 
Åages
, 
GFP_KERNEL
);

44 ià(!
vdso_·ges
)

45 
oom
;

46 
i
 = 0; i < 
Åages
; i++) {

47 
·ge
 *
p
;

48 
p
 = 
	`®loc_·ge
(
GFP_KERNEL
);

49 ià(!
p
)

50 
oom
;

51 
vdso_·ges
[
i
] = 
p
;

52 
	`cİy_·ge
(
	`·ge_add»ss
(
p
), 
vdso_¡¬t
 + 
i
*
PAGE_SIZE
);

55 
vba£
 = 
	`vm­
(
vdso_·ges
, 
Åages
, 0, 
PAGE_KERNEL
);

56 ià(!
vba£
)

57 
oom
;

59 ià(
	`memcmp
(
vba£
, "\177ELF", 4)) {

60 
	`´štk
("VDSO: I'm broken;‚ot ELF\n");

61 
vdso_’abËd
 = 0;

64 
	#VEXTERN
(
x
) \

65 *(
	`ty³of
(
__
 ## 
x
è**è
	`v¬_»f
(
	`VDSO64_SYMBOL
(
vba£
, x), #xèğ&__ ## x;

	)

66 
	~"vex‹º.h
"

67 #undeà
VEXTERN


70 
oom
:

71 
	`´štk
("Cannot‡llocate vdso\n");

72 
vdso_’abËd
 = 0;

73  -
ENOMEM
;

74 
	}
}

75 
__š™ÿÎ
(
š™_vdso_v¬s
);

77 
	glšux_bš´m
;

83 
	$vdso_addr
(
¡¬t
, 
Ën
)

85 
addr
, 
’d
;

86 
off£t
;

87 
’d
 = (
¡¬t
 + 
PMD_SIZE
 - 1è& 
PMD_MASK
;

88 ià(
’d
 >ğ
TASK_SIZE_MAX
)

89 
’d
 = 
TASK_SIZE_MAX
;

90 
’d
 -ğ
Ën
;

92 
off£t
 = 
	`g‘_¿ndom_št
(è& (
PTRS_PER_PTE
 - 1);

93 
addr
 = 
¡¬t
 + (
off£t
 << 
PAGE_SHIFT
);

94 ià(
addr
 >ğ
’d
)

95 
addr
 = 
’d
;

96  
addr
;

97 
	}
}

101 
	$¬ch_£tup_add™iÚ®_·ges
(
lšux_bš´m
 *
b´m
, 
u£s_š‹½
)

103 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

104 
addr
;

105 
»t
;

107 ià(!
vdso_’abËd
)

110 
	`down_wr™e
(&
mm
->
mm­_£m
);

111 
addr
 = 
	`vdso_addr
(
mm
->
¡¬t_¡ack
, 
vdso_size
);

112 
addr
 = 
	`g‘_unm­³d_¬—
(
NULL
,‡ddr, 
vdso_size
, 0, 0);

113 ià(
	`IS_ERR_VALUE
(
addr
)) {

114 
»t
 = 
addr
;

115 
up_ç
;

118 
»t
 = 
	`š¡®l_¥ecŸl_m­pšg
(
mm
, 
addr
, 
vdso_size
,

119 
VM_READ
|
VM_EXEC
|

120 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

121 
VM_ALWAYSDUMP
,

122 
vdso_·ges
);

123 ià(
»t
)

124 
up_ç
;

126 
cu¼’t
->
mm
->
cÚ‹xt
.
vdso
 = (*)
addr
;

127 
up_ç
:

128 
	`up_wr™e
(&
mm
->
mm­_£m
);

129  
»t
;

130 
	}
}

132 
__š™
 
	$vdso_£tup
(*
s
)

134 
vdso_’abËd
 = 
	`sim¶e_¡¹oul
(
s
, 
NULL
, 0);

136 
	}
}

137 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/time.h
>

7 
	~<asm/vsysÿÎ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
è
	`ty³of
 (
__
 ## xè*cÚ¡ 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vex‹º.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<lšux/jiff›s.h
>

8 
	~<lšux/d–ay.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/timex.h
>

11 
	~<lšux/smp.h
>

13 
	gÍj_fše
;

14 
	g´e£t_Íj
;

15 
__š™
 
	$Íj_£tup
(*
¡r
)

17 
´e£t_Íj
 = 
	`sim¶e_¡¹oul
(
¡r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Íj=", 
Íj_£tup
);

23 #ifdeà
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100è? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__ıuš™
 
	$ÿlib¿‹_d–ay_dœeù
()

35 
´e_¡¬t
, 
¡¬t
, 
po¡_¡¬t
;

36 
´e_’d
, 
’d
, 
po¡_’d
;

37 
¡¬t_jiff›s
;

38 
tim”_¿‹_mš
, 
tim”_¿‹_max
;

39 
good_tim”_sum
 = 0;

40 
good_tim”_couÁ
 = 0;

41 
i
;

43 ià(
	`»ad_cu¼’t_tim”
(&
´e_¡¬t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
´e_¡¬t
 = 0;

67 
	`»ad_cu¼’t_tim”
(&
¡¬t
);

68 
¡¬t_jiff›s
 = 
jiff›s
;

69 
jiff›s
 <ğ(
¡¬t_jiff›s
 + 1)) {

70 
´e_¡¬t
 = 
¡¬t
;

71 
	`»ad_cu¼’t_tim”
(&
¡¬t
);

73 
	`»ad_cu¼’t_tim”
(&
po¡_¡¬t
);

75 
´e_’d
 = 0;

76 
’d
 = 
po¡_¡¬t
;

77 
jiff›s
 <=

78 (
¡¬t_jiff›s
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
´e_’d
 = 
’d
;

80 
	`»ad_cu¼’t_tim”
(&
’d
);

82 
	`»ad_cu¼’t_tim”
(&
po¡_’d
);

84 
tim”_¿‹_max
 = (
po¡_’d
 - 
´e_¡¬t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
tim”_¿‹_mš
 = (
´e_’d
 - 
po¡_¡¬t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 ià(
´e_¡¬t
 !ğ0 && 
´e_’d
 != 0 &&

94 (
tim”_¿‹_max
 - 
tim”_¿‹_mš
) < (timer_rate_max >> 3)) {

95 
good_tim”_couÁ
++;

96 
good_tim”_sum
 +ğ
tim”_¿‹_max
;

100 ià(
good_tim”_couÁ
)

101  (
good_tim”_sum
/
good_tim”_couÁ
);

103 
	`´štk
(
KERN_WARNING
 "calibrate_delay_direct() failedo get‡ good "

106 
	}
}

108 
__ıuš™
 
	$ÿlib¿‹_d–ay_dœeù
(è{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__ıuš™
 
	$ÿlib¿‹_d–ay
()

124 
ticks
, 
loİb™
;

125 
Ís_´ecisiÚ
 = 
LPS_PREC
;

127 ià(
´e£t_Íj
) {

128 
loİs_³r_jiffy
 = 
´e£t_Íj
;

129 
	`´štk
(
KERN_INFO


131 } ià((
	`smp_´oûssÜ_id
(è=ğ0è&& 
Íj_fše
) {

132 
loİs_³r_jiffy
 = 
Íj_fše
;

133 
	`´štk
(
KERN_INFO


136 } ià((
loİs_³r_jiffy
 = 
	`ÿlib¿‹_d–ay_dœeù
()) != 0) {

137 
	`´štk
(
KERN_INFO


140 
loİs_³r_jiffy
 = (1<<12);

142 
	`´štk
(
KERN_INFO
 "Calibrating delay†oop... ");

143 (
loİs_³r_jiffy
 <<= 1) != 0) {

145 
ticks
 = 
jiff›s
;

146 
ticks
 =ğ
jiff›s
)

149 
ticks
 = 
jiff›s
;

150 
	`__d–ay
(
loİs_³r_jiffy
);

151 
ticks
 = 
jiff›s
 -icks;

152 ià(
ticks
)

160 
loİs_³r_jiffy
 >>= 1;

161 
loİb™
 = 
loİs_³r_jiffy
;

162 
Ís_´ecisiÚ
-- && (
loİb™
 >>= 1)) {

163 
loİs_³r_jiffy
 |ğ
loİb™
;

164 
ticks
 = 
jiff›s
;

165 
ticks
 =ğ
jiff›s
)

167 
ticks
 = 
jiff›s
;

168 
	`__d–ay
(
loİs_³r_jiffy
);

169 ià(
jiff›s
 !ğ
ticks
)

170 
loİs_³r_jiffy
 &ğ~
loİb™
;

173 
	`´štk
(
KERN_CONT
 "%lu.%02lu BogoMIPS (lpj=%lu)\n",

174 
loİs_³r_jiffy
/(500000/
HZ
),

175 (
loİs_³r_jiffy
/(5000/
HZ
)) % 100,†oops_per_jiffy);

176 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/ùy³.h
>

4 
	~<lšux/fd.h
>

5 
	~<lšux/‰y.h
>

6 
	~<lšux/su¥’d.h
>

7 
	~<lšux/roÙ_dev.h
>

8 
	~<lšux/£cur™y.h
>

9 
	~<lšux/d–ay.h
>

10 
	~<lšux/g’hd.h
>

11 
	~<lšux/mouÁ.h
>

12 
	~<lšux/deviû.h
>

13 
	~<lšux/š™.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/š™rd.h
>

16 
	~<lšux/async.h
>

17 
	~<lšux/fs_¡ruù.h
>

19 
	~<lšux/nfs_fs.h
>

20 
	~<lšux/nfs_fs_sb.h
>

21 
	~<lšux/nfs_mouÁ.h
>

23 
	~"do_mouÁs.h
"

25 
__š™d©a
 
	grd_dŞßd
;

27 
	groÙ_mouÁæags
 = 
MS_RDONLY
 | 
MS_SILENT
;

28 * 
__š™d©a
 
	groÙ_deviû_Çme
;

29 
__š™d©a
 
	g§ved_roÙ_Çme
[64];

30 
__š™d©a
 
	groÙ_wa™
;

32 
dev_t
 
	gROOT_DEV
;

34 
__š™
 
	$lßd_¿mdisk
(*
¡r
)

36 
rd_dŞßd
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0) & 3;

38 
	}
}

39 
__£tup
("lßd_¿mdisk=", 
lßd_¿mdisk
);

41 
__š™
 
	$»adÚly
(*
¡r
)

43 ià(*
¡r
)

45 
roÙ_mouÁæags
 |ğ
MS_RDONLY
;

47 
	}
}

49 
__š™
 
	$»adwr™e
(*
¡r
)

51 ià(*
¡r
)

53 
roÙ_mouÁæags
 &ğ~
MS_RDONLY
;

55 
	}
}

57 
__£tup
("ro", 
»adÚly
);

58 
__£tup
("rw", 
»adwr™e
);

77 
dev_t
 
	$Çme_to_dev_t
(*
Çme
)

79 
s
[32];

80 *
p
;

81 
dev_t
 
»s
 = 0;

82 
·¹
;

84 ià(
	`¡ºcmp
(
Çme
, "/dev/", 5) != 0) {

85 
maj
, 
mš
;

87 ià(
	`ssÿnf
(
Çme
, "%u:%u", &
maj
, &
mš
) == 2) {

88 
»s
 = 
	`MKDEV
(
maj
, 
mš
);

89 ià(
maj
 !ğ
	`MAJOR
(
»s
è|| 
mš
 !ğ
	`MINOR
(res))

90 
ç
;

92 
»s
 = 
	`Ãw_decode_dev
(
	`sim¶e_¡¹oul
(
Çme
, &
p
, 16));

93 ià(*
p
)

94 
ç
;

96 
dÚe
;

99 
Çme
 += 5;

100 
»s
 = 
RoÙ_NFS
;

101 ià(
	`¡rcmp
(
Çme
, "nfs") == 0)

102 
dÚe
;

103 
»s
 = 
RoÙ_RAM0
;

104 ià(
	`¡rcmp
(
Çme
, "ram") == 0)

105 
dÚe
;

107 ià(
	`¡¾’
(
Çme
) > 31)

108 
ç
;

109 
	`¡rıy
(
s
, 
Çme
);

110 
p
 = 
s
; *p;…++)

111 ià(*
p
 == '/')

112 *
p
 = '!';

113 
»s
 = 
	`blk_lookup_devt
(
s
, 0);

114 ià(
»s
)

115 
dÚe
;

121 
p
 > 
s
 && 
	`isdig™
(p[-1]))

122 
p
--;

123 ià(
p
 =ğ
s
 || !*p || *p == '0')

124 
ç
;

127 
·¹
 = 
	`sim¶e_¡¹oul
(
p
, 
NULL
, 10);

128 *
p
 = '\0';

129 
»s
 = 
	`blk_lookup_devt
(
s
, 
·¹
);

130 ià(
»s
)

131 
dÚe
;

134 ià(
p
 < 
s
 + 2 || !
	`isdig™
(p[-2]) ||…[-1] != 'p')

135 
ç
;

136 
p
[-1] = '\0';

137 
»s
 = 
	`blk_lookup_devt
(
s
, 
·¹
);

138 ià(
»s
)

139 
dÚe
;

141 
ç
:

143 
dÚe
:

144  
»s
;

145 
	}
}

147 
__š™
 
	$roÙ_dev_£tup
(*
lše
)

149 
	`¡¾ıy
(
§ved_roÙ_Çme
, 
lše
, (saved_root_name));

151 
	}
}

153 
__£tup
("roÙ=", 
roÙ_dev_£tup
);

155 
__š™
 
	$roÙwa™_£tup
(*
¡r
)

157 ià(*
¡r
)

159 
roÙ_wa™
 = 1;

161 
	}
}

163 
__£tup
("roÙwa™", 
roÙwa™_£tup
);

165 * 
__š™d©a
 
	groÙ_mouÁ_d©a
;

166 
__š™
 
	$roÙ_d©a_£tup
(*
¡r
)

168 
roÙ_mouÁ_d©a
 = 
¡r
;

170 
	}
}

172 * 
__š™d©a
 
	groÙ_fs_Çmes
;

173 
__š™
 
	$fs_Çmes_£tup
(*
¡r
)

175 
roÙ_fs_Çmes
 = 
¡r
;

177 
	}
}

179 
__š™d©a
 
	groÙ_d–ay
;

180 
__š™
 
	$roÙ_d–ay_£tup
(*
¡r
)

182 
roÙ_d–ay
 = 
	`sim¶e_¡¹oul
(
¡r
, 
NULL
, 0);

184 
	}
}

186 
__£tup
("roÙæags=", 
roÙ_d©a_£tup
);

187 
__£tup
("roÙf¡y³=", 
fs_Çmes_£tup
);

188 
__£tup
("roÙd–ay=", 
roÙ_d–ay_£tup
);

190 
__š™
 
	$g‘_fs_Çmes
(*
·ge
)

192 *
s
 = 
·ge
;

194 ià(
roÙ_fs_Çmes
) {

195 
	`¡rıy
(
·ge
, 
roÙ_fs_Çmes
);

196 *
s
++) {

197 ià(
s
[-1] == ',')

198 
s
[-1] = '\0';

201 
Ën
 = 
	`g‘_fesy¡em_li¡
(
·ge
);

202 *
p
, *
Ãxt
;

204 
·ge
[
Ën
] = '\0';

205 
p
 = 
·ge
-1;…;… = 
Ãxt
) {

206 
Ãxt
 = 
	`¡rchr
(++
p
, '\n');

207 ià(*
p
++ != '\t')

209 (*
s
++ = *
p
++) != '\n')

211 
s
[-1] = '\0';

214 *
s
 = '\0';

215 
	}
}

217 
__š™
 
	$do_mouÁ_roÙ
(*
Çme
, *
fs
, 
æags
, *
d©a
)

219 
”r
 = 
	`sys_mouÁ
(
Çme
, "/roÙ", 
fs
, 
æags
, 
d©a
);

220 ià(
”r
)

221  
”r
;

223 
	`sys_chdœ
("/root");

224 
ROOT_DEV
 = 
cu¼’t
->
fs
->
pwd
.
mÁ
->
mÁ_sb
->
s_dev
;

225 
	`´štk
("VFS: Mounted„oot (%s filesystem)%s on device %u:%u.\n",

226 
cu¼’t
->
fs
->
pwd
.
mÁ
->
mÁ_sb
->
s_ty³
->
Çme
,

227 
cu¼’t
->
fs
->
pwd
.
mÁ
->
mÁ_sb
->
s_æags
 & 
MS_RDONLY
 ?

228 "„—dÚly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

230 
	}
}

232 
__š™
 
	$mouÁ_block_roÙ
(*
Çme
, 
æags
)

234 *
fs_Çmes
 = 
	`__g‘Çme
();

235 *
p
;

236 #ifdeà
CONFIG_BLOCK


237 
b
[
BDEVNAME_SIZE
];

239 cÚ¡ *
b
 = 
Çme
;

242 
	`g‘_fs_Çmes
(
fs_Çmes
);

243 
»Œy
:

244 
p
 = 
fs_Çmes
; *p;… +ğ
	`¡¾’
(p)+1) {

245 
”r
 = 
	`do_mouÁ_roÙ
(
Çme
, 
p
, 
æags
, 
roÙ_mouÁ_d©a
);

246 
”r
) {

248 
out
;

249 -
EACCES
:

250 
æags
 |ğ
MS_RDONLY
;

251 
»Œy
;

252 -
EINVAL
:

260 #ifdeà
CONFIG_BLOCK


261 
	`__bdevÇme
(
ROOT_DEV
, 
b
);

263 
	`´štk
("VFS: Cannot open„oot device \"%s\" or %s\n",

264 
roÙ_deviû_Çme
, 
b
);

265 
	`´štk
("Please‡ppend‡ correct \"root=\" boot option; here‡rehe‡vailable…artitions:\n");

267 
	`´štk_®l_·¹™iÚs
();

268 #ifdeà
CONFIG_DEBUG_BLOCK_EXT_DEVT


269 
	`´štk
("DEBUG_BLOCK_EXT_DEVT isƒnabled, you‚eedo specify "

272 
	`·nic
("VFS: UÇbËØmouÁ„oÙ f Ú %s", 
b
);

275 
	`´štk
("List of‡ll…artitions:\n");

276 
	`´štk_®l_·¹™iÚs
();

277 
	`´štk
("No filesystem could mount„oot,ried: ");

278 
p
 = 
fs_Çmes
; *p;… +ğ
	`¡¾’
(p)+1)

279 
	`´štk
(" %s", 
p
);

280 
	`´štk
("\n");

281 #ifdeà
CONFIG_BLOCK


282 
	`__bdevÇme
(
ROOT_DEV
, 
b
);

284 
	`·nic
("VFS: UÇbËØmouÁ„oÙ f Ú %s", 
b
);

285 
out
:

286 
	`puŠame
(
fs_Çmes
);

287 
	}
}

289 #ifdeà
CONFIG_ROOT_NFS


290 
__š™
 
	$mouÁ_nfs_roÙ
()

292 *
d©a
 = 
	`nfs_roÙ_d©a
();

294 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

295 ià(
d©a
 &&

296 
	`do_mouÁ_roÙ
("/dev/roÙ", "nfs", 
roÙ_mouÁæags
, 
d©a
) == 0)

299 
	}
}

302 #ià
defšed
(
CONFIG_BLK_DEV_RAM
è|| defšed(
CONFIG_BLK_DEV_FD
)

303 
__š™
 
	$chªge_æİpy
(*
fmt
, ...)

305 
‹rmios
ermios;

306 
buf
[80];

307 
c
;

308 
fd
;

309 
va_li¡
 
¬gs
;

310 
	`va_¡¬t
(
¬gs
, 
fmt
);

311 
	`v¥rštf
(
buf
, 
fmt
, 
¬gs
);

312 
	`va_’d
(
¬gs
);

313 
fd
 = 
	`sys_İ’
("/dev/roÙ", 
O_RDWR
 | 
O_NDELAY
, 0);

314 ià(
fd
 >= 0) {

315 
	`sys_ioùl
(
fd
, 
FDEJECT
, 0);

316 
	`sys_şo£
(
fd
);

318 
	`´štk
(
KERN_NOTICE
 "VFS: In£¹ % ªd…»s ENTER\n", 
buf
);

319 
fd
 = 
	`sys_İ’
("/dev/cÚsŞe", 
O_RDWR
, 0);

320 ià(
fd
 >= 0) {

321 
	`sys_ioùl
(
fd
, 
TCGETS
, ()&
‹rmios
);

322 
‹rmios
.
c_læag
 &ğ~
ICANON
;

323 
	`sys_ioùl
(
fd
, 
TCSETSF
, ()&
‹rmios
);

324 
	`sys_»ad
(
fd
, &
c
, 1);

325 
‹rmios
.
c_læag
 |ğ
ICANON
;

326 
	`sys_ioùl
(
fd
, 
TCSETSF
, ()&
‹rmios
);

327 
	`sys_şo£
(
fd
);

329 
	}
}

332 
__š™
 
	$mouÁ_roÙ
()

334 #ifdeà
CONFIG_ROOT_NFS


335 ià(
	`MAJOR
(
ROOT_DEV
è=ğ
UNNAMED_MAJOR
) {

336 ià(
	`mouÁ_nfs_roÙ
())

339 
	`´štk
(
KERN_ERR
 "VFS: Unableo mount„oot fs via NFS,rying floppy.\n");

340 
ROOT_DEV
 = 
RoÙ_FD0
;

343 #ifdeà
CONFIG_BLK_DEV_FD


344 ià(
	`MAJOR
(
ROOT_DEV
è=ğ
FLOPPY_MAJOR
) {

346 ià(
rd_dŞßd
==2) {

347 ià(
	`rd_lßd_disk
(1)) {

348 
ROOT_DEV
 = 
RoÙ_RAM1
;

349 
roÙ_deviû_Çme
 = 
NULL
;

352 
	`chªge_æİpy
("root floppy");

355 #ifdeà
CONFIG_BLOCK


356 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

357 
	`mouÁ_block_roÙ
("/dev/roÙ", 
roÙ_mouÁæags
);

359 
	}
}

364 
__š™
 
	$´•¬e_Çme¥aû
()

366 
is_æİpy
;

368 ià(
roÙ_d–ay
) {

369 
	`´štk
(
KERN_INFO
 "Waiting %dsec before mounting„oot device...\n",

370 
roÙ_d–ay
);

371 
	`s¦“p
(
roÙ_d–ay
);

381 
	`wa™_fÜ_deviû_´obe
();

383 
	`md_run_£tup
();

385 ià(
§ved_roÙ_Çme
[0]) {

386 
roÙ_deviû_Çme
 = 
§ved_roÙ_Çme
;

387 ià(!
	`¡ºcmp
(
roÙ_deviû_Çme
, "mtd", 3) ||

388 !
	`¡ºcmp
(
roÙ_deviû_Çme
, "ubi", 3)) {

389 
	`mouÁ_block_roÙ
(
roÙ_deviû_Çme
, 
roÙ_mouÁæags
);

390 
out
;

392 
ROOT_DEV
 = 
	`Çme_to_dev_t
(
roÙ_deviû_Çme
);

393 ià(
	`¡ºcmp
(
roÙ_deviû_Çme
, "/dev/", 5) == 0)

394 
roÙ_deviû_Çme
 += 5;

397 ià(
	`š™rd_lßd
())

398 
out
;

401 ià((
ROOT_DEV
 =ğ0è&& 
roÙ_wa™
) {

402 
	`´štk
(
KERN_INFO
 "Waiting for„oot device %s...\n",

403 
§ved_roÙ_Çme
);

404 
	`driv”_´obe_dÚe
() != 0 ||

405 (
ROOT_DEV
 = 
	`Çme_to_dev_t
(
§ved_roÙ_Çme
)) == 0)

406 
	`m¦“p
(100);

407 
	`async_synchrÚize_fuÎ
();

410 
is_æİpy
 = 
	`MAJOR
(
ROOT_DEV
è=ğ
FLOPPY_MAJOR
;

412 ià(
is_æİpy
 && 
rd_dŞßd
 && 
	`rd_lßd_disk
(0))

413 
ROOT_DEV
 = 
RoÙ_RAM0
;

415 
	`mouÁ_roÙ
();

416 
out
:

417 
	`sys_mouÁ
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

418 
	`sys_chroÙ
(".");

419 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<lšux/uni¡d.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/fs.h
>

4 
	~<lšux/mšix_fs.h
>

5 
	~<lšux/ext2_fs.h
>

6 
	~<lšux/romfs_fs.h
>

7 
	~<lšux/š™rd.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/ä“z”.h
>

11 
	~"do_mouÁs.h
"

13 
	gš™rd_¡¬t
, 
	gš™rd_’d
;

14 
	gš™rd_b–ow_¡¬t_ok
;

15 
	g»®_roÙ_dev
;

16 
__š™d©a
 
	gŞd_fd
, 
	groÙ_fd
;

17 
__š™d©a
 
	gmouÁ_š™rd
 = 1;

19 
__š™
 
	$no_š™rd
(*
¡r
)

21 
mouÁ_š™rd
 = 0;

23 
	}
}

25 
__£tup
("noš™rd", 
no_š™rd
);

27 
__š™
 
	$do_lšuxrc
(* 
sh–l
)

29 *
¬gv
[] = { "lšuxrc", 
NULL
, };

30 * 
’vp_š™
[];

32 
	`sys_şo£
(
Şd_fd
);sys_şo£(
roÙ_fd
);

33 
	`sys_şo£
(0);sys_close(1);sys_close(2);

34 
	`sys_£tsid
();

35 (è
	`sys_İ’
("/dev/cÚsŞe",
O_RDWR
,0);

36 (è
	`sys_dup
(0);

37 (è
	`sys_dup
(0);

38  
	`k”Ãl_execve
(
sh–l
, 
¬gv
, 
’vp_š™
);

39 
	}
}

41 
__š™
 
	$hªdË_š™rd
()

43 
”rÜ
;

44 
pid
;

46 
»®_roÙ_dev
 = 
	`Ãw_’code_dev
(
ROOT_DEV
);

47 
	`ü—‹_dev
("/dev/roÙ.Şd", 
RoÙ_RAM0
);

49 
	`mouÁ_block_roÙ
("/dev/roÙ.Şd", 
roÙ_mouÁæags
 & ~
MS_RDONLY
);

50 
	`sys_mkdœ
("/old", 0700);

51 
roÙ_fd
 = 
	`sys_İ’
("/", 0, 0);

52 
Şd_fd
 = 
	`sys_İ’
("/old", 0, 0);

54 
	`sys_chdœ
("/root");

55 
	`sys_mouÁ
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

56 
	`sys_chroÙ
(".");

62 
cu¼’t
->
æags
 |ğ
PF_FREEZER_SKIP
;

64 
pid
 = 
	`k”Ãl_th»ad
(
do_lšuxrc
, "/lšuxrc", 
SIGCHLD
);

65 ià(
pid
 > 0)

66 
pid
 !ğ
	`sys_wa™4
(-1, 
NULL
, 0, NULL))

67 
	`y›ld
();

69 
cu¼’t
->
æags
 &ğ~
PF_FREEZER_SKIP
;

72 
	`sys_fchdœ
(
Şd_fd
);

73 
	`sys_mouÁ
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

75 
	`sys_fchdœ
(
roÙ_fd
);

76 
	`sys_chroÙ
(".");

77 
	`sys_şo£
(
Şd_fd
);

78 
	`sys_şo£
(
roÙ_fd
);

80 ià(
	`Ãw_decode_dev
(
»®_roÙ_dev
è=ğ
RoÙ_RAM0
) {

81 
	`sys_chdœ
("/old");

85 
ROOT_DEV
 = 
	`Ãw_decode_dev
(
»®_roÙ_dev
);

86 
	`mouÁ_roÙ
();

88 
	`´štk
(
KERN_NOTICE
 "Tryingo move old„ooto /initrd ... ");

89 
”rÜ
 = 
	`sys_mouÁ
("/Şd", "/roÙ/š™rd", 
NULL
, 
MS_MOVE
, NULL);

90 ià(!
”rÜ
)

91 
	`´štk
("okay\n");

93 
fd
 = 
	`sys_İ’
("/dev/roÙ.Şd", 
O_RDWR
, 0);

94 ià(
”rÜ
 =ğ-
ENOENT
)

95 
	`´štk
("/initrd does‚otƒxist. Ignored.\n");

97 
	`´štk
("failed\n");

98 
	`´štk
(
KERN_NOTICE
 "Unmounting old„oot\n");

99 
	`sys_umouÁ
("/Şd", 
MNT_DETACH
);

100 
	`´štk
(
KERN_NOTICE
 "Tryingo free„amdisk memory ... ");

101 ià(
fd
 < 0) {

102 
”rÜ
 = 
fd
;

104 
”rÜ
 = 
	`sys_ioùl
(
fd
, 
BLKFLSBUF
, 0);

105 
	`sys_şo£
(
fd
);

107 
	`´štk
(!
”rÜ
 ? "okay\n" : "failed\n");

109 
	}
}

111 
__š™
 
	$š™rd_lßd
()

113 ià(
mouÁ_š™rd
) {

114 
	`ü—‹_dev
("/dev/¿m", 
RoÙ_RAM0
);

121 ià(
	`rd_lßd_image
("/š™rd.image"è&& 
ROOT_DEV
 !ğ
RoÙ_RAM0
) {

122 
	`sys_uÆšk
("/initrd.image");

123 
	`hªdË_š™rd
();

127 
	`sys_uÆšk
("/initrd.image");

129 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<lšux/d–ay.h
>

2 
	~<lšux/¿id/md_u.h
>

3 
	~<lšux/¿id/md_p.h
>

5 
	~"do_mouÁs.h
"

16 #ifdeà
CONFIG_MD_AUTODETECT


17 
__š™d©a
 
	g¿id_nßutod‘eù
;

19 
__š™d©a
 
	g¿id_nßutod‘eù
=1;

21 
__š™d©a
 
	g¿id_autİ¬t
;

24 
	mmšÜ
;

25 
	m·¹™iÚed
;

26 
	mËv–
;

27 
	mchunk
;

28 *
	mdeviû_Çmes
;

29 } 
	gmd_£tup_¬gs
[256] 
	g__š™d©a
;

31 
md_£tup_’ts
 
	g__š™d©a
;

53 
__š™
 
	$md_£tup
(*
¡r
)

55 
mšÜ
, 
Ëv–
, 
çùÜ
, 
çuÉ
, 
·¹™iÚed
 = 0;

56 *
³ºame
 = "";

57 *
¡r1
;

58 
’t
;

60 ià(*
¡r
 == 'd') {

61 
·¹™iÚed
 = 1;

62 
¡r
++;

64 ià(
	`g‘_İtiÚ
(&
¡r
, &
mšÜ
) != 2) {

65 
	`´štk
(
KERN_WARNING
 "md: Too few‡rguments suppliedo md=.\n");

68 
¡r1
 = 
¡r
;

69 
’t
=0 ;ƒÁ< 
md_£tup_’ts
 ;ƒnt++)

70 ià(
md_£tup_¬gs
[
’t
].
mšÜ
 == minor &&

71 
md_£tup_¬gs
[
’t
].
·¹™iÚed
 ==…artitioned) {

72 
	`´štk
(
KERN_WARNING
 "md: md=%s%d, Specified morehan once. "

73 "R•Ïcšg…»viou defš™iÚ.\n", 
·¹™iÚed
?"d":"", 
mšÜ
);

76 ià(
’t
 >ğ
	`ARRAY_SIZE
(
md_£tup_¬gs
)) {

77 
	`´štk
(
KERN_WARNING
 "md: md=%s%d -oØmªy md in™Ÿli§tiÚs\n", 
·¹™iÚed
?"d":"", 
mšÜ
);

80 ià(
’t
 >ğ
md_£tup_’ts
)

81 
md_£tup_’ts
++;

82 
	`g‘_İtiÚ
(&
¡r
, &
Ëv–
)) {

84 ià(
Ëv–
 =ğ0 ||†ev– =ğ
LEVEL_LINEAR
) {

85 ià(
	`g‘_İtiÚ
(&
¡r
, &
çùÜ
) != 2 ||

86 
	`g‘_İtiÚ
(&
¡r
, &
çuÉ
) != 2) {

87 
	`´štk
(
KERN_WARNING
 "md: Too few‡rguments suppliedo md=.\n");

90 
md_£tup_¬gs
[
’t
].
Ëv–
 =†evel;

91 
md_£tup_¬gs
[
’t
].
chunk
 = 1 << (
çùÜ
+12);

92 ià(
Ëv–
 =ğ
LEVEL_LINEAR
)

93 
³ºame
 = "linear";

95 
³ºame
 = "raid0";

100 
¡r
 = 
¡r1
;

103 
md_£tup_¬gs
[
’t
].
Ëv–
 = 
LEVEL_NONE
;

104 
³ºame
="super-block";

107 
	`´štk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mšÜ
, 
³ºame
, 
¡r
);

109 
md_£tup_¬gs
[
’t
].
deviû_Çmes
 = 
¡r
;

110 
md_£tup_¬gs
[
’t
].
·¹™iÚed
 =…artitioned;

111 
md_£tup_¬gs
[
’t
].
mšÜ
 = minor;

114 
	}
}

116 
__š™
 
	$md_£tup_drive
()

118 
mšÜ
, 
i
, 
’t
, 
·¹™iÚed
;

119 
dev_t
 
dev
;

120 
dev_t
 
deviûs
[
MD_SB_DISKS
+1];

122 
’t
 = 0;ƒÁ < 
md_£tup_’ts
 ;ƒnt++) {

123 
fd
;

124 
”r
 = 0;

125 *
devÇme
;

126 
mdu_disk_šfo_t
 
dšfo
;

127 
Çme
[16];

129 
mšÜ
 = 
md_£tup_¬gs
[
’t
].minor;

130 
·¹™iÚed
 = 
md_£tup_¬gs
[
’t
].partitioned;

131 
devÇme
 = 
md_£tup_¬gs
[
’t
].
deviû_Çmes
;

133 
	`¥rštf
(
Çme
, "/dev/md%s%d", 
·¹™iÚed
?"_d":"", 
mšÜ
);

134 ià(
·¹™iÚed
)

135 
dev
 = 
	`MKDEV
(
mdp_majÜ
, 
mšÜ
 << 
MdpMšÜShiá
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mšÜ
);

138 
	`ü—‹_dev
(
Çme
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
devÇme
 !ğ
NULL
; i++) {

140 *
p
;

141 
comp_Çme
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`¡rchr
(
devÇme
, ',');

145 ià(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`Çme_to_dev_t
(
devÇme
);

149 ià(
	`¡ºcmp
(
devÇme
, "/dev/", 5) == 0)

150 
devÇme
 += 5;

151 
	`¢´štf
(
comp_Çme
, 63, "/dev/%s", 
devÇme
);

152 
rdev
 = 
	`b¡©
(
comp_Çme
);

153 ià(
rdev
)

154 
dev
 = 
	`Ãw_decode_dev
(
rdev
);

155 ià(!
dev
) {

156 
	`´štk
(
KERN_WARNING
 "md: UnknowÀdeviû‚ame: %s\n", 
devÇme
);

160 
deviûs
[
i
] = 
dev
;

162 
devÇme
 = 
p
;

164 
deviûs
[
i
] = 0;

166 ià(!
i
)

169 
	`´štk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
·¹™iÚed
 ? "_d" : "", 
mšÜ
,

171 
md_£tup_¬gs
[
’t
].
deviû_Çmes
);

173 
fd
 = 
	`sys_İ’
(
Çme
, 0, 0);

174 ià(
fd
 < 0) {

175 
	`´štk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¬¿y %s\n", 
Çme
);

179 ià(
	`sys_ioùl
(
fd
, 
SET_ARRAY_INFO
, 0è=ğ-
EBUSY
) {

180 
	`´štk
(
KERN_WARNING


182 
mšÜ
);

183 
	`sys_şo£
(
fd
);

187 ià(
md_£tup_¬gs
[
’t
].
Ëv–
 !ğ
LEVEL_NONE
) {

189 
mdu_¬¿y_šfo_t
 
ašfo
;

190 
ašfo
.
Ëv–
 = 
md_£tup_¬gs
[
’t
].level;

191 
ašfo
.
size
 = 0;

192 
ašfo
.
Ä_disks
 =0;

193 
ašfo
.
¿id_disks
 =0;

194 
deviûs
[
ašfo
.
¿id_disks
])

195 
ašfo
.
¿id_disks
++;

196 
ašfo
.
md_mšÜ
 =
mšÜ
;

197 
ašfo
.
nÙ_³rsi¡’t
 = 1;

199 
ašfo
.
¡©e
 = (1 << 
MD_SB_CLEAN
);

200 
ašfo
.
Ïyout
 = 0;

201 
ašfo
.
chunk_size
 = 
md_£tup_¬gs
[
’t
].
chunk
;

202 
”r
 = 
	`sys_ioùl
(
fd
, 
SET_ARRAY_INFO
, ()&
ašfo
);

203 
i
 = 0; !
”r
 && i <ğ
MD_SB_DISKS
; i++) {

204 
dev
 = 
deviûs
[
i
];

205 ià(!
dev
)

207 
dšfo
.
numb”
 = 
i
;

208 
dšfo
.
¿id_disk
 = 
i
;

209 
dšfo
.
¡©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
dšfo
.
majÜ
 = 
	`MAJOR
(
dev
);

211 
dšfo
.
mšÜ
 = 
	`MINOR
(
dev
);

212 
”r
 = 
	`sys_ioùl
(
fd
, 
ADD_NEW_DISK
, ()&
dšfo
);

216 
i
 = 0; i <ğ
MD_SB_DISKS
; i++) {

217 
dev
 = 
deviûs
[
i
];

218 ià(!
dev
)

220 
dšfo
.
majÜ
 = 
	`MAJOR
(
dev
);

221 
dšfo
.
mšÜ
 = 
	`MINOR
(
dev
);

222 
	`sys_ioùl
(
fd
, 
ADD_NEW_DISK
, ()&
dšfo
);

225 ià(!
”r
)

226 
”r
 = 
	`sys_ioùl
(
fd
, 
RUN_ARRAY
, 0);

227 ià(
”r
)

228 
	`´štk
(
KERN_WARNING
 "md: s¹šg md%d faed\n", 
mšÜ
);

235 
	`sys_şo£
(
fd
);

236 
fd
 = 
	`sys_İ’
(
Çme
, 0, 0);

237 
	`sys_ioùl
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_şo£
(
fd
);

241 
	}
}

243 
__š™
 
	$¿id_£tup
(*
¡r
)

245 
Ën
, 
pos
;

247 
Ën
 = 
	`¡¾’
(
¡r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Ën
) {

251 *
comma
 = 
	`¡rchr
(
¡r
+
pos
, ',');

252 
wËn
;

253 ià(
comma
)

254 
wËn
 = (
comma
-
¡r
)-
pos
;

255 
wËn
 = (
Ën
-1)-
pos
;

257 ià(!
	`¡ºcmp
(
¡r
, "nßutod‘eù", 
wËn
))

258 
¿id_nßutod‘eù
 = 1;

259 ià(!
	`¡ºcmp
(
¡r
, "autod‘eù", 
wËn
))

260 
¿id_nßutod‘eù
 = 0;

261 ià(
	`¡ºcmp
(
¡r
, "·¹™iÚabË", 
wËn
)==0)

262 
¿id_autİ¬t
 = 1;

263 ià(
	`¡ºcmp
(
¡r
, "·¹", 
wËn
)==0)

264 
¿id_autİ¬t
 = 1;

265 
pos
 +ğ
wËn
+1;

268 
	}
}

270 
__£tup
("¿id=", 
¿id_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__š™
 
	$autod‘eù_¿id
()

275 
fd
;

281 
	`´štk
(
KERN_INFO
 "md: Waiting for‡ll deviceso be‡vailable before‡utodetect\n");

282 
	`´štk
(
KERN_INFO
 "md: If you don't use„aid, use„aid=noautodetect\n");

284 
	`wa™_fÜ_deviû_´obe
();

286 
fd
 = 
	`sys_İ’
("/dev/md0", 0, 0);

287 ià(
fd
 >= 0) {

288 
	`sys_ioùl
(
fd
, 
RAID_AUTORUN
, 
¿id_autİ¬t
);

289 
	`sys_şo£
(
fd
);

291 
	}
}

293 
__š™
 
	$md_run_£tup
()

295 
	`ü—‹_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 ià(
¿id_nßutod‘eù
)

298 
	`´štk
(
KERN_INFO
 "md: Skipping‡utodetection of RAID‡rrays. (raid=autodetect will force)\n");

300 
	`autod‘eù_¿id
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/fs.h
>

4 
	~<lšux/mšix_fs.h
>

5 
	~<lšux/ext2_fs.h
>

6 
	~<lšux/romfs_fs.h
>

7 
	~<lšux/üamfs_fs.h
>

8 
	~<lšux/š™rd.h
>

9 
	~<lšux/¡ršg.h
>

11 
	~"do_mouÁs.h
"

12 
	~"../fs/squashfs/squashfs_fs.h
"

14 
	~<lšux/decom´ess/g’”ic.h
>

17 
__š™d©a
 
	grd_´om±
 = 1;

19 
__š™
 
	$´om±_¿mdisk
(*
¡r
)

21 
rd_´om±
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0) & 1;

23 
	}
}

24 
__£tup
("´om±_¿mdisk=", 
´om±_¿mdisk
);

26 
__š™d©a
 
	grd_image_¡¬t
;

28 
__š™
 
	$¿mdisk_¡¬t_£tup
(*
¡r
)

30 
rd_image_¡¬t
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0);

32 
	}
}

33 
__£tup
("¿mdisk_¡¬t=", 
¿mdisk_¡¬t_£tup
);

35 
__š™
 
üd_lßd
(
š_fd
, 
out_fd
, 
decom´ess_â
 
deco
);

51 
__š™


52 
	$id’tify_¿mdisk_image
(
fd
, 
¡¬t_block
, 
decom´ess_â
 *
decom´essÜ
)

54 cÚ¡ 
size
 = 512;

55 
mšix_su³r_block
 *
mšixsb
;

56 
ext2_su³r_block
 *
ext2sb
;

57 
romfs_su³r_block
 *
romfsb
;

58 
üamfs_su³r
 *
üamfsb
;

59 
squashfs_su³r_block
 *
squashfsb
;

60 
nblocks
 = -1;

61 *
buf
;

62 cÚ¡ *
com´ess_Çme
;

64 
buf
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

65 ià(!
buf
)

68 
mšixsb
 = (
mšix_su³r_block
 *è
buf
;

69 
ext2sb
 = (
ext2_su³r_block
 *è
buf
;

70 
romfsb
 = (
romfs_su³r_block
 *è
buf
;

71 
üamfsb
 = (
üamfs_su³r
 *è
buf
;

72 
squashfsb
 = (
squashfs_su³r_block
 *è
buf
;

73 
	`mem£t
(
buf
, 0xe5, 
size
);

78 
	`sys_l£ek
(
fd
, 
¡¬t_block
 * 
BLOCK_SIZE
, 0);

79 
	`sys_»ad
(
fd
, 
buf
, 
size
);

81 *
decom´essÜ
 = 
	`decom´ess_m‘hod
(
buf
, 
size
, &
com´ess_Çme
);

82 ià(
com´ess_Çme
) {

83 
	`´štk
(
KERN_NOTICE
 "RAMDISK: %s image found‡t block %d\n",

84 
com´ess_Çme
, 
¡¬t_block
);

85 ià(!*
decom´essÜ
)

86 
	`´štk
(
KERN_EMERG


88 
com´ess_Çme
);

89 
nblocks
 = 0;

90 
dÚe
;

94 ià(
romfsb
->
wÜd0
 =ğ
ROMSB_WORD0
 &&

95 
romfsb
->
wÜd1
 =ğ
ROMSB_WORD1
) {

96 
	`´štk
(
KERN_NOTICE


98 
¡¬t_block
);

99 
nblocks
 = (
	`Áohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

100 
dÚe
;

103 ià(
üamfsb
->
magic
 =ğ
CRAMFS_MAGIC
) {

104 
	`´štk
(
KERN_NOTICE


106 
¡¬t_block
);

107 
nblocks
 = (
üamfsb
->
size
 + 
BLOCK_SIZE
 - 1è>> 
BLOCK_SIZE_BITS
;

108 
dÚe
;

112 ià(
	`Ë32_to_ıu
(
squashfsb
->
s_magic
è=ğ
SQUASHFS_MAGIC
) {

113 
	`´štk
(
KERN_NOTICE


115 
¡¬t_block
);

116 
nblocks
 = (
	`Ë64_to_ıu
(
squashfsb
->
by‹s_u£d
è+ 
BLOCK_SIZE
 - 1)

117 >> 
BLOCK_SIZE_BITS
;

118 
dÚe
;

124 
	`sys_l£ek
(
fd
, (
¡¬t_block
+1è* 
BLOCK_SIZE
, 0);

125 
	`sys_»ad
(
fd
, 
buf
, 
size
);

128 ià(
mšixsb
->
s_magic
 =ğ
MINIX_SUPER_MAGIC
 ||

129 
mšixsb
->
s_magic
 =ğ
MINIX_SUPER_MAGIC2
) {

130 
	`´štk
(
KERN_NOTICE


132 
¡¬t_block
);

133 
nblocks
 = 
mšixsb
->
s_nzÚes
 << mšixsb->
s_log_zÚe_size
;

134 
dÚe
;

138 ià(
ext2sb
->
s_magic
 =ğ
	`ıu_to_Ë16
(
EXT2_SUPER_MAGIC
)) {

139 
	`´štk
(
KERN_NOTICE


141 
¡¬t_block
);

142 
nblocks
 = 
	`Ë32_to_ıu
(
ext2sb
->
s_blocks_couÁ
) <<

143 
	`Ë32_to_ıu
(
ext2sb
->
s_log_block_size
);

144 
dÚe
;

147 
	`´štk
(
KERN_NOTICE


149 
¡¬t_block
);

151 
dÚe
:

152 
	`sys_l£ek
(
fd
, 
¡¬t_block
 * 
BLOCK_SIZE
, 0);

153 
	`kä“
(
buf
);

154  
nblocks
;

155 
	}
}

157 
__š™
 
	$rd_lßd_image
(*
äom
)

159 
»s
 = 0;

160 
š_fd
, 
out_fd
;

161 
rd_blocks
, 
devblocks
;

162 
nblocks
, 
i
, 
disk
;

163 *
buf
 = 
NULL
;

164 
rÙ©e
 = 0;

165 
decom´ess_â
 
decom´essÜ
 = 
NULL
;

166 #ià!
	`defšed
(
CONFIG_S390
è&& !defšed(
CONFIG_PPC_ISERIES
)

167 
rÙ©Ü
[4] = { '|' , '/' , '-' , '\\' };

170 
out_fd
 = 
	`sys_İ’
("/dev/¿m", 
O_RDWR
, 0);

171 ià(
out_fd
 < 0)

172 
out
;

174 
š_fd
 = 
	`sys_İ’
(
äom
, 
O_RDONLY
, 0);

175 ià(
š_fd
 < 0)

176 
noşo£_šput
;

178 
nblocks
 = 
	`id’tify_¿mdisk_image
(
š_fd
, 
rd_image_¡¬t
, &
decom´essÜ
);

179 ià(
nblocks
 < 0)

180 
dÚe
;

182 ià(
nblocks
 == 0) {

183 ià(
	`üd_lßd
(
š_fd
, 
out_fd
, 
decom´essÜ
) == 0)

184 
sucûssful_lßd
;

185 
dÚe
;

199 ià(
	`sys_ioùl
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

200 
rd_blocks
 = 0;

202 
rd_blocks
 >>= 1;

204 ià(
nblocks
 > 
rd_blocks
) {

205 
	`´štk
("RAMDISK: imageoo big! (%dKiB/%ldKiB)\n",

206 
nblocks
, 
rd_blocks
);

207 
dÚe
;

213 ià(
	`sys_ioùl
(
š_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

214 
devblocks
 = 0;

216 
devblocks
 >>= 1;

218 ià(
	`¡rcmp
(
äom
, "/initrd.image") == 0)

219 
devblocks
 = 
nblocks
;

221 ià(
devblocks
 == 0) {

222 
	`´štk
(
KERN_ERR
 "RAMDISK: could‚ot determine device size\n");

223 
dÚe
;

226 
buf
 = 
	`km®loc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

227 ià(!
buf
) {

228 
	`´štk
(
KERN_ERR
 "RAMDISK: could‚ot‡llocate buffer\n");

229 
dÚe
;

232 
	`´štk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] into„am disk... ",

233 
nblocks
, (Òblocks-1)/
devblocks
)+1,‚blocks>devblocks ? "s" : "");

234 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

235 ià(
i
 && (˜% 
devblocks
 == 0)) {

236 
	`´štk
("dÚdisk #%d.\n", 
disk
++);

237 
rÙ©e
 = 0;

238 ià(
	`sys_şo£
(
š_fd
)) {

239 
	`´štk
("Error closinghe disk.\n");

240 
noşo£_šput
;

242 
	`chªge_æİpy
("disk #%d", 
disk
);

243 
š_fd
 = 
	`sys_İ’
(
äom
, 
O_RDONLY
, 0);

244 ià(
š_fd
 < 0) {

245 
	`´štk
("Error opening disk.\n");

246 
noşo£_šput
;

248 
	`´štk
("Lßdšg disk #%d... ", 
disk
);

250 
	`sys_»ad
(
š_fd
, 
buf
, 
BLOCK_SIZE
);

251 
	`sys_wr™e
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

252 #ià!
	`defšed
(
CONFIG_S390
è&& !defšed(
CONFIG_PPC_ISERIES
)

253 ià(!(
i
 % 16)) {

254 
	`´štk
("%c\b", 
rÙ©Ü
[
rÙ©e
 & 0x3]);

255 
rÙ©e
++;

259 
	`´štk
("done.\n");

261 
sucûssful_lßd
:

262 
»s
 = 1;

263 
dÚe
:

264 
	`sys_şo£
(
š_fd
);

265 
noşo£_šput
:

266 
	`sys_şo£
(
out_fd
);

267 
out
:

268 
	`kä“
(
buf
);

269 
	`sys_uÆšk
("/dev/ram");

270  
»s
;

271 
	}
}

273 
__š™
 
	$rd_lßd_disk
(
n
)

275 ià(
rd_´om±
)

276 
	`chªge_æİpy
("root floppy disko be†oaded into RAM disk");

277 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

278 
	`ü—‹_dev
("/dev/¿m", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

279  
	`rd_lßd_image
("/dev/root");

280 
	}
}

282 
	gex™_code
;

283 
	gdecom´ess_”rÜ
;

284 
	güd_šfd
, 
	güd_outfd
;

286 
__š™
 
	$com´_fl
(*
buf
, 
Ën
)

288 
r
 = 
	`sys_»ad
(
üd_šfd
, 
buf
, 
Ën
);

289 ià(
r
 < 0)

290 
	`´štk
(
KERN_ERR
 "RAMDISK:ƒrror while„eading compressed data");

291 ià(
r
 == 0)

292 
	`´štk
(
KERN_ERR
 "RAMDISK: EOF while„eading compressed data");

293  
r
;

294 
	}
}

296 
__š™
 
	$com´_æush
(*
wšdow
, 
outút
)

298 
wr™‹n
 = 
	`sys_wr™e
(
üd_outfd
, 
wšdow
, 
outút
);

299 ià(
wr™‹n
 !ğ
outút
) {

300 ià(
decom´ess_”rÜ
 == 0)

301 
	`´štk
(
KERN_ERR


303 
wr™‹n
, 
outút
);

304 
decom´ess_”rÜ
 = 1;

307  
outút
;

308 
	}
}

310 
__š™
 
	$”rÜ
(*
x
)

312 
	`´štk
(
KERN_ERR
 "%s\n", 
x
);

313 
ex™_code
 = 1;

314 
decom´ess_”rÜ
 = 1;

315 
	}
}

317 
__š™
 
	$üd_lßd
(
š_fd
, 
out_fd
, 
decom´ess_â
 
deco
)

319 
»suÉ
;

320 
üd_šfd
 = 
š_fd
;

321 
üd_outfd
 = 
out_fd
;

322 
»suÉ
 = 
	`deco
(
NULL
, 0, 
com´_fl
, 
com´_æush
, NULL, NULL, 
”rÜ
);

323 ià(
decom´ess_”rÜ
)

324 
»suÉ
 = 1;

325  
»suÉ
;

326 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/fs.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/fú.h
>

6 
	~<lšux/d–ay.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/dœ’t.h
>

9 
	~<lšux/sysÿÎs.h
>

10 
	~<lšux/utime.h
>

12 
__š™d©a
 *
	gmes§ge
;

13 
__š™
 
	$”rÜ
(*
x
)

15 ià(!
mes§ge
)

16 
mes§ge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Ën
è(((Ö’è+ 1è& ~3è+ 2)

	)

23 
__š™d©a
 
	shash
 {

24 
	mšo
, 
	mmšÜ
, 
	mmajÜ
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	mÃxt
;

27 
	mÇme
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	gh—d
[32];

30 
šlše
 
	$hash
(
majÜ
, 
mšÜ
, 
šo
)

32 
tmp
 = 
šo
 + 
mšÜ
 + (
majÜ
 << 3);

33 
tmp
 +=mp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__š™
 *
	$fšd_lšk
(
majÜ
, 
mšÜ
, 
šo
,

38 
mode_t
 
mode
, *
Çme
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
h—d
 + 
	`hash
(
majÜ
, 
mšÜ
, 
šo
); *p;… = &(*p)->
Ãxt
) {

42 ià((*
p
)->
šo
 != ino)

44 ià((*
p
)->
mšÜ
 != minor)

46 ià((*
p
)->
majÜ
 != major)

48 ià(((*
p
)->
mode
 ^ modeè& 
S_IFMT
)

50  (*
p
)->
Çme
;

52 
q
 = 
	`km®loc
((
hash
), 
GFP_KERNEL
);

53 ià(!
q
)

54 
	`·nic
("can't‡llocate†ink hashƒntry");

55 
q
->
majÜ
 = major;

56 
q
->
mšÜ
 = minor;

57 
q
->
šo
 = ino;

58 
q
->
mode
 = mode;

59 
	`¡rıy
(
q
->
Çme
,‚ame);

60 
q
->
Ãxt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__š™
 
	$ä“_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
h—d
;… < head + 32;…++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
Ãxt
;

72 
	`kä“
(
q
);

75 
	}
}

77 
__š™
 
	$do_utime
(
__u£r
 *
f’ame
, 
time_t
 
mtime
)

79 
time¥ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
f’ame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__š™d©a
 
LIST_HEAD
(
dœ_li¡
);

90 
	sdœ_’Œy
 {

91 
li¡_h—d
 
	mli¡
;

92 *
	mÇme
;

93 
time_t
 
	mmtime
;

96 
__š™
 
	$dœ_add
(cÚ¡ *
Çme
, 
time_t
 
mtime
)

98 
dœ_’Œy
 *
de
 = 
	`km®loc
((dœ_’Œy), 
GFP_KERNEL
);

99 ià(!
de
)

100 
	`·nic
("can't‡llocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li¡
);

102 
de
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li¡_add
(&
de
->
li¡
, &
dœ_li¡
);

105 
	}
}

107 
__š™
 
	$dœ_utime
()

109 
dœ_’Œy
 *
de
, *
tmp
;

110 
	`li¡_fÜ_—ch_’Œy_§ã
(
de
, 
tmp
, &
dœ_li¡
, 
li¡
) {

111 
	`li¡_d–
(&
de
->
li¡
);

112 
	`do_utime
(
de
->
Çme
, de->
mtime
);

113 
	`kä“
(
de
->
Çme
);

114 
	`kä“
(
de
);

116 
	}
}

118 
__š™d©a
 
time_t
 
	gmtime
;

122 
__š™d©a
 
	gšo
, 
	gmajÜ
, 
	gmšÜ
, 
	gÆšk
;

123 
__š™d©a
 
mode_t
 
	gmode
;

124 
__š™d©a
 
	gbody_Ën
, 
	gÇme_Ën
;

125 
__š™d©a
 
uid_t
 
	guid
;

126 
__š™d©a
 
gid_t
 
	ggid
;

127 
__š™d©a
 
	grdev
;

129 
__š™
 
	$·r£_h—d”
(*
s
)

131 
·r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`memıy
(
buf
, 
s
, 8);

138 
·r£d
[
i
] = 
	`sim¶e_¡¹oul
(
buf
, 
NULL
, 16);

140 
šo
 = 
·r£d
[0];

141 
mode
 = 
·r£d
[1];

142 
uid
 = 
·r£d
[2];

143 
gid
 = 
·r£d
[3];

144 
Æšk
 = 
·r£d
[4];

145 
mtime
 = 
·r£d
[5];

146 
body_Ën
 = 
·r£d
[6];

147 
majÜ
 = 
·r£d
[7];

148 
mšÜ
 = 
·r£d
[8];

149 
rdev
 = 
	`Ãw_’code_dev
(
	`MKDEV
(
·r£d
[9],…arsed[10]));

150 
Çme_Ën
 = 
·r£d
[11];

151 
	}
}

155 
__š™d©a
 
	e¡©e
 {

156 
	mS¹
,

157 
	mCŞËù
,

158 
	mGÙH—d”
,

159 
	mSkIt
,

160 
	mGÙName
,

161 
	mCİyFe
,

162 
	mGÙSymlšk
,

163 
	mRe£t


164 } 
	g¡©e
, 
	gÃxt_¡©e
;

166 
__š™d©a
 *
	gviùim
;

167 
__š™d©a
 
	gcouÁ
;

168 
__š™d©a
 
loff_t
 
	gthis_h—d”
, 
	gÃxt_h—d”
;

170 
šlše
 
__š™
 
	$—t
(
n
)

172 
viùim
 +ğ
n
;

173 
this_h—d”
 +ğ
n
;

174 
couÁ
 -ğ
n
;

175 
	}
}

177 
__š™d©a
 *
	gvcŞËùed
;

178 
__š™d©a
 *
	gcŞËùed
;

179 
__š™d©a
 
	g»mašs
;

180 
__š™d©a
 *
	gcŞËù
;

182 
__š™
 
	$»ad_što
(*
buf
, 
size
, 
¡©e
 
Ãxt
)

184 ià(
couÁ
 >ğ
size
) {

185 
cŞËùed
 = 
viùim
;

186 
	`—t
(
size
);

187 
¡©e
 = 
Ãxt
;

189 
cŞËù
 = 
cŞËùed
 = 
buf
;

190 
»mašs
 = 
size
;

191 
Ãxt_¡©e
 = 
Ãxt
;

192 
¡©e
 = 
CŞËù
;

194 
	}
}

196 
__š™d©a
 *
	gh—d”_buf
, *
	gsymlšk_buf
, *
	gÇme_buf
;

198 
__š™
 
	$do_¡¬t
()

200 
	`»ad_što
(
h—d”_buf
, 110, 
GÙH—d”
);

202 
	}
}

204 
__š™
 
	$do_cŞËù
()

206 
n
 = 
»mašs
;

207 ià(
couÁ
 < 
n
)

208 
n
 = 
couÁ
;

209 
	`memıy
(
cŞËù
, 
viùim
, 
n
);

210 
	`—t
(
n
);

211 
cŞËù
 +ğ
n
;

212 ià((
»mašs
 -ğ
n
) != 0)

214 
¡©e
 = 
Ãxt_¡©e
;

216 
	}
}

218 
__š™
 
	$do_h—d”
()

220 ià(
	`memcmp
(
cŞËùed
, "070707", 6)==0) {

221 
	`”rÜ
("incorrect cpio method used: use -H‚ewc option");

224 ià(
	`memcmp
(
cŞËùed
, "070701", 6)) {

225 
	`”rÜ
("no cpio magic");

228 
	`·r£_h—d”
(
cŞËùed
);

229 
Ãxt_h—d”
 = 
this_h—d”
 + 
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
;

230 
Ãxt_h—d”
 = (next_header + 3) & ~3;

231 
¡©e
 = 
SkIt
;

232 ià(
Çme_Ën
 <ğ0 ||‚ame_ËÀ> 
PATH_MAX
)

234 ià(
	`S_ISLNK
(
mode
)) {

235 ià(
body_Ën
 > 
PATH_MAX
)

237 
cŞËù
 = 
cŞËùed
 = 
symlšk_buf
;

238 
»mašs
 = 
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
;

239 
Ãxt_¡©e
 = 
GÙSymlšk
;

240 
¡©e
 = 
CŞËù
;

243 ià(
	`S_ISREG
(
mode
è|| !
body_Ën
)

244 
	`»ad_što
(
Çme_buf
, 
	`N_ALIGN
(
Çme_Ën
), 
GÙName
);

246 
	}
}

248 
__š™
 
	$do_sk
()

250 ià(
this_h—d”
 + 
couÁ
 < 
Ãxt_h—d”
) {

251 
	`—t
(
couÁ
);

254 
	`—t
(
Ãxt_h—d”
 - 
this_h—d”
);

255 
¡©e
 = 
Ãxt_¡©e
;

258 
	}
}

260 
__š™
 
	$do_»£t
()

262 
couÁ
 && *
viùim
 == '\0')

263 
	`—t
(1);

264 ià(
couÁ
 && (
this_h—d”
 & 3))

265 
	`”rÜ
("broken…adding");

267 
	}
}

269 
__š™
 
	$maybe_lšk
()

271 ià(
Æšk
 >= 2) {

272 *
Şd
 = 
	`fšd_lšk
(
majÜ
, 
mšÜ
, 
šo
, 
mode
, 
cŞËùed
);

273 ià(
Şd
)

274  (
	`sys_lšk
(
Şd
, 
cŞËùed
) < 0) ? -1 : 1;

277 
	}
}

279 
__š™
 
	$ş—n_·th
(*
·th
, 
mode_t
 
mode
)

281 
¡©
 
¡
;

283 ià(!
	`sys_Ãwl¡©
(
·th
, &
¡
è&& (¡.
¡_mode
^
mode
è& 
S_IFMT
) {

284 ià(
	`S_ISDIR
(
¡
.
¡_mode
))

285 
	`sys_rmdœ
(
·th
);

287 
	`sys_uÆšk
(
·th
);

289 
	}
}

291 
__š™d©a
 
	gwfd
;

293 
__š™
 
	$do_Çme
()

295 
¡©e
 = 
SkIt
;

296 
Ãxt_¡©e
 = 
Re£t
;

297 ià(
	`¡rcmp
(
cŞËùed
, "TRAILER!!!") == 0) {

298 
	`ä“_hash
();

301 
	`ş—n_·th
(
cŞËùed
, 
mode
);

302 ià(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lšk
();

304 ià(
ml
 >= 0) {

305 
İ’æags
 = 
O_WRONLY
|
O_CREAT
;

306 ià(
ml
 != 1)

307 
İ’æags
 |ğ
O_TRUNC
;

308 
wfd
 = 
	`sys_İ’
(
cŞËùed
, 
İ’æags
, 
mode
);

310 ià(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 ià(
body_Ën
)

314 
	`sys_árunÿ‹
(
wfd
, 
body_Ën
);

315 
vcŞËùed
 = 
	`k¡rdup
(
cŞËùed
, 
GFP_KERNEL
);

316 
¡©e
 = 
CİyFe
;

319 } ià(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdœ
(
cŞËùed
, 
mode
);

321 
	`sys_chown
(
cŞËùed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cŞËùed
, 
mode
);

323 
	`dœ_add
(
cŞËùed
, 
mtime
);

324 } ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
è|| 
	`S_ISSOCK
(mode)) {

326 ià(
	`maybe_lšk
() == 0) {

327 
	`sys_mknod
(
cŞËùed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cŞËùed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cŞËùed
, 
mode
);

330 
	`do_utime
(
cŞËùed
, 
mtime
);

334 
	}
}

336 
__š™
 
	$do_cİy
()

338 ià(
couÁ
 >ğ
body_Ën
) {

339 
	`sys_wr™e
(
wfd
, 
viùim
, 
body_Ën
);

340 
	`sys_şo£
(
wfd
);

341 
	`do_utime
(
vcŞËùed
, 
mtime
);

342 
	`kä“
(
vcŞËùed
);

343 
	`—t
(
body_Ën
);

344 
¡©e
 = 
SkIt
;

347 
	`sys_wr™e
(
wfd
, 
viùim
, 
couÁ
);

348 
body_Ën
 -ğ
couÁ
;

349 
	`—t
(
couÁ
);

352 
	}
}

354 
__š™
 
	$do_symlšk
()

356 
cŞËùed
[
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
] = '\0';

357 
	`ş—n_·th
(
cŞËùed
, 0);

358 
	`sys_symlšk
(
cŞËùed
 + 
	`N_ALIGN
(
Çme_Ën
), collected);

359 
	`sys_lchown
(
cŞËùed
, 
uid
, 
gid
);

360 
	`do_utime
(
cŞËùed
, 
mtime
);

361 
¡©e
 = 
SkIt
;

362 
Ãxt_¡©e
 = 
Re£t
;

364 
	}
}

366 
__š™d©a
 (*
aùiÚs
[])() = {

367 [
S¹
] = 
do_¡¬t
,

368 [
CŞËù
] = 
do_cŞËù
,

369 [
GÙH—d”
] = 
do_h—d”
,

370 [
SkIt
] = 
do_sk
,

371 [
GÙName
] = 
do_Çme
,

372 [
CİyFe
] = 
do_cİy
,

373 [
GÙSymlšk
] = 
do_symlšk
,

374 [
Re£t
] = 
do_»£t
,

375 
	}
};

377 
__š™
 
	$wr™e_bufãr
(*
buf
, 
Ën
)

379 
couÁ
 = 
Ën
;

380 
viùim
 = 
buf
;

382 !
aùiÚs
[
¡©e
]())

384  
Ën
 - 
couÁ
;

385 
	}
}

387 
__š™
 
	$æush_bufãr
(*
bufv
, 
Ën
)

389 *
buf
 = (*è
bufv
;

390 
wr™‹n
;

391 
ÜigL’
 = 
Ën
;

392 ià(
mes§ge
)

394 (
wr™‹n
 = 
	`wr™e_bufãr
(
buf
, 
Ën
)è<†’ && !
mes§ge
) {

395 
c
 = 
buf
[
wr™‹n
];

396 ià(
c
 == '0') {

397 
buf
 +ğ
wr™‹n
;

398 
Ën
 -ğ
wr™‹n
;

399 
¡©e
 = 
S¹
;

400 } ià(
c
 == 0) {

401 
buf
 +ğ
wr™‹n
;

402 
Ën
 -ğ
wr™‹n
;

403 
¡©e
 = 
Re£t
;

405 
	`”rÜ
("junk in compressed‡rchive");

407  
ÜigL’
;

408 
	}
}

410 
	gmy_š±r
;

412 
	~<lšux/decom´ess/g’”ic.h
>

414 * 
__š™
 
	$uÅack_to_roÙfs
(*
buf
, 
Ën
)

416 
wr™‹n
;

417 
decom´ess_â
 
decom´ess
;

418 cÚ¡ *
com´ess_Çme
;

419 
__š™d©a
 
msg_buf
[64];

421 
h—d”_buf
 = 
	`km®loc
(110, 
GFP_KERNEL
);

422 
symlšk_buf
 = 
	`km®loc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXè+ 1, 
GFP_KERNEL
);

423 
Çme_buf
 = 
	`km®loc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 ià(!
h—d”_buf
 || !
symlšk_buf
 || !
Çme_buf
)

426 
	`·nic
("can't‡llocate buffers");

428 
¡©e
 = 
S¹
;

429 
this_h—d”
 = 0;

430 
mes§ge
 = 
NULL
;

431 !
mes§ge
 && 
Ën
) {

432 
loff_t
 
§ved_off£t
 = 
this_h—d”
;

433 ià(*
buf
 =ğ'0' && !(
this_h—d”
 & 3)) {

434 
¡©e
 = 
S¹
;

435 
wr™‹n
 = 
	`wr™e_bufãr
(
buf
, 
Ën
);

436 
buf
 +ğ
wr™‹n
;

437 
Ën
 -ğ
wr™‹n
;

440 ià(!*
buf
) {

441 
buf
++;

442 
Ën
--;

443 
this_h—d”
++;

446 
this_h—d”
 = 0;

447 
decom´ess
 = 
	`decom´ess_m‘hod
(
buf
, 
Ën
, &
com´ess_Çme
);

448 ià(
decom´ess
)

449 
	`decom´ess
(
buf
, 
Ën
, 
NULL
, 
æush_bufãr
, NULL,

450 &
my_š±r
, 
”rÜ
);

451 ià(
com´ess_Çme
) {

452 ià(!
mes§ge
) {

453 
	`¢´štf
(
msg_buf
,  msg_buf,

455 
com´ess_Çme
);

456 
mes§ge
 = 
msg_buf
;

459 ià(
¡©e
 !ğ
Re£t
)

460 
	`”rÜ
("junk in compressed‡rchive");

461 
this_h—d”
 = 
§ved_off£t
 + 
my_š±r
;

462 
buf
 +ğ
my_š±r
;

463 
Ën
 -ğ
my_š±r
;

465 
	`dœ_utime
();

466 
	`kä“
(
Çme_buf
);

467 
	`kä“
(
symlšk_buf
);

468 
	`kä“
(
h—d”_buf
);

469  
mes§ge
;

470 
	}
}

472 
__š™d©a
 
	gdo_»š_š™rd
;

474 
__š™
 
	$»š_š™rd_·¿m
(*
¡r
)

476 ià(*
¡r
)

478 
do_»š_š™rd
 = 1;

480 
	}
}

481 
__£tup
("»š_š™rd", 
»š_š™rd_·¿m
);

483 
__š™¿mfs_¡¬t
[], 
__š™¿mfs_’d
[];

484 
	~<lšux/š™rd.h
>

485 
	~<lšux/kexec.h
>

487 
__š™
 
	$ä“_š™rd
()

489 #ifdeà
CONFIG_KEXEC


490 
üashk_¡¬t
 = ()
	`__va
(
üashk_»s
.
¡¬t
);

491 
üashk_’d
 = ()
	`__va
(
üashk_»s
.
’d
);

493 ià(
do_»š_š™rd
)

494 
sk
;

496 #ifdeà
CONFIG_KEXEC


501 ià(
š™rd_¡¬t
 < 
üashk_’d
 && 
š™rd_’d
 > 
üashk_¡¬t
) {

506 
	`mem£t
((*)
š™rd_¡¬t
, 0, 
š™rd_’d
 - initrd_start);

507 ià(
š™rd_¡¬t
 < 
üashk_¡¬t
)

508 
	`ä“_š™rd_mem
(
š™rd_¡¬t
, 
üashk_¡¬t
);

509 ià(
š™rd_’d
 > 
üashk_’d
)

510 
	`ä“_š™rd_mem
(
üashk_’d
, 
š™rd_’d
);

513 
	`ä“_š™rd_mem
(
š™rd_¡¬t
, 
š™rd_’d
);

514 
sk
:

515 
š™rd_¡¬t
 = 0;

516 
š™rd_’d
 = 0;

517 
	}
}

519 #ifdeà
CONFIG_BLK_DEV_RAM


520 
	#BUF_SIZE
 1024

	)

521 
__š™
 
	$ş—n_roÙfs
()

523 
fd
;

524 *
buf
;

525 
lšux_dœ’t64
 *
dœp
;

526 
couÁ
;

528 
fd
 = 
	`sys_İ’
("/", 
O_RDONLY
, 0);

529 
	`WARN_ON
(
fd
 < 0);

530 ià(
fd
 < 0)

532 
buf
 = 
	`kz®loc
(
BUF_SIZE
, 
GFP_KERNEL
);

533 
	`WARN_ON
(!
buf
);

534 ià(!
buf
) {

535 
	`sys_şo£
(
fd
);

539 
dœp
 = 
buf
;

540 
couÁ
 = 
	`sys_g‘d’ts64
(
fd
, 
dœp
, 
BUF_SIZE
);

541 
couÁ
 > 0) {

542 
couÁ
 > 0) {

543 
¡©
 
¡
;

544 
»t
;

546 
»t
 = 
	`sys_Ãwl¡©
(
dœp
->
d_Çme
, &
¡
);

547 
	`WARN_ON_ONCE
(
»t
);

548 ià(!
»t
) {

549 ià(
	`S_ISDIR
(
¡
.
¡_mode
))

550 
	`sys_rmdœ
(
dœp
->
d_Çme
);

552 
	`sys_uÆšk
(
dœp
->
d_Çme
);

555 
couÁ
 -ğ
dœp
->
d_»ş’
;

556 
dœp
 = (*)dœ°+ dœp->
d_»ş’
;

558 
dœp
 = 
buf
;

559 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

560 
couÁ
 = 
	`sys_g‘d’ts64
(
fd
, 
dœp
, 
BUF_SIZE
);

563 
	`sys_şo£
(
fd
);

564 
	`kä“
(
buf
);

565 
	}
}

568 
__š™
 
	$pİuÏ‹_roÙfs
()

570 *
”r
 = 
	`uÅack_to_roÙfs
(
__š™¿mfs_¡¬t
,

571 
__š™¿mfs_’d
 - 
__š™¿mfs_¡¬t
);

572 ià(
”r
)

573 
	`·nic
(
”r
);

574 ià(
š™rd_¡¬t
) {

575 #ifdeà
CONFIG_BLK_DEV_RAM


576 
fd
;

577 
	`´štk
(
KERN_INFO
 "Tryingo unpack„ootfs image‡s initramfs...\n");

578 
”r
 = 
	`uÅack_to_roÙfs
((*)
š™rd_¡¬t
,

579 
š™rd_’d
 - 
š™rd_¡¬t
);

580 ià(!
”r
) {

581 
	`ä“_š™rd
();

584 
	`ş—n_roÙfs
();

585 
	`uÅack_to_roÙfs
(
__š™¿mfs_¡¬t
,

586 
__š™¿mfs_’d
 - 
__š™¿mfs_¡¬t
);

588 
	`´štk
(
KERN_INFO
 "rootfs image is‚ot initramfs (%s)"

589 ";†ook likª in™rd\n", 
”r
);

590 
fd
 = 
	`sys_İ’
("/š™rd.image", 
O_WRONLY
|
O_CREAT
, 0700);

591 ià(
fd
 >= 0) {

592 
	`sys_wr™e
(
fd
, (*)
š™rd_¡¬t
,

593 
š™rd_’d
 - 
š™rd_¡¬t
);

594 
	`sys_şo£
(
fd
);

595 
	`ä“_š™rd
();

598 
	`´štk
(
KERN_INFO
 "Unpacking initramfs...\n");

599 
”r
 = 
	`uÅack_to_roÙfs
((*)
š™rd_¡¬t
,

600 
š™rd_’d
 - 
š™rd_¡¬t
);

601 ià(
”r
)

602 
	`´štk
(
KERN_EMERG
 "In™¿mf uÅackšg faed: %s\n", 
”r
);

603 
	`ä“_š™rd
();

607 
	}
}

608 
roÙfs_š™ÿÎ
(
pİuÏ‹_roÙfs
);

	@/cmpt816/linux/init/main.c

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/moduË.h
>

14 
	~<lšux/´oc_fs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/sysÿÎs.h
>

17 
	~<lšux/¡ack´ÙeùÜ.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/ùy³.h
>

20 
	~<lšux/d–ay.h
>

21 
	~<lšux/ut¢ame.h
>

22 
	~<lšux/iİÜt.h
>

23 
	~<lšux/š™.h
>

24 
	~<lšux/smp_lock.h
>

25 
	~<lšux/š™rd.h
>

26 
	~<lšux/boÙmem.h
>

27 
	~<lšux/‰y.h
>

28 
	~<lšux/gå.h
>

29 
	~<lšux/³rıu.h
>

30 
	~<lšux/kmod.h
>

31 
	~<lšux/vm®loc.h
>

32 
	~<lšux/k”Ãl_¡©.h
>

33 
	~<lšux/¡¬t_k”Ãl.h
>

34 
	~<lšux/£cur™y.h
>

35 
	~<lšux/smp.h
>

36 
	~<lšux/wÜkqueue.h
>

37 
	~<lšux/´ofe.h
>

38 
	~<lšux/rcupd©e.h
>

39 
	~<lšux/moduË·¿m.h
>

40 
	~<lšux/k®lsyms.h
>

41 
	~<lšux/wr™eback.h
>

42 
	~<lšux/ıu.h
>

43 
	~<lšux/ıu£t.h
>

44 
	~<lšux/cgroup.h
>

45 
	~<lšux/efi.h
>

46 
	~<lšux/tick.h
>

47 
	~<lšux/š‹¼u±.h
>

48 
	~<lšux/sk¡©s_k”n.h
>

49 
	~<lšux/d–ayacù.h
>

50 
	~<lšux/uni¡d.h
>

51 
	~<lšux/rm­.h
>

52 
	~<lšux/mempŞicy.h
>

53 
	~<lšux/key.h
>

54 
	~<lšux/bufãr_h—d.h
>

55 
	~<lšux/·ge_cgroup.h
>

56 
	~<lšux/debug_locks.h
>

57 
	~<lšux/debugobjeùs.h
>

58 
	~<lšux/lockd•.h
>

59 
	~<lšux/pid_Çme¥aû.h
>

60 
	~<lšux/deviû.h
>

61 
	~<lšux/kth»ad.h
>

62 
	~<lšux/sched.h
>

63 
	~<lšux/sigÇl.h
>

64 
	~<lšux/idr.h
>

65 
	~<lšux/á¿û.h
>

66 
	~<lšux/async.h
>

67 
	~<Œaû/boÙ.h
>

69 
	~<asm/io.h
>

70 
	~<asm/bugs.h
>

71 
	~<asm/£tup.h
>

72 
	~<asm/£ùiÚs.h
>

73 
	~<asm/ÿcheæush.h
>

74 
	~<Œaû/kmemŒaû.h
>

76 #ifdeà
CONFIG_X86_LOCAL_APIC


77 
	~<asm/smp.h
>

80 
k”Ãl_š™
(*);

82 
š™_IRQ
();

83 
fÜk_š™
();

84 
mÿ_š™
();

85 
sbus_š™
();

86 
´io_Œ“_š™
();

87 
¿dix_Œ“_š™
();

88 
ä“_š™mem
();

89 #ifdef 
CONFIG_ACPI


90 
aıi_—¾y_š™
();

92 
šlše
 
	$aıi_—¾y_š™
(è{ 
	}
}

94 #iâdeà
CONFIG_DEBUG_RODATA


95 
šlše
 
	$m¬k_rod©a_ro
(è{ 
	}
}

98 #ifdeà
CONFIG_TC


99 
tc_š™
();

102 
sy¡em_¡©es
 
sy¡em_¡©e
 
	g__»ad_mo¡ly
;

103 
EXPORT_SYMBOL
(
sy¡em_¡©e
);

108 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

109 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

111 
time_š™
();

113 (*
__š™d©a
 
Ï‹_time_š™
)();

114 
	`soáœq_š™
();

117 
__š™d©a
 
boÙ_commªd_lše
[
COMMAND_LINE_SIZE
];

119 *
§ved_commªd_lše
;

121 *
¡©ic_commªd_lše
;

123 *
execu‹_commªd
;

124 *
¿mdisk_execu‹_commªd
;

126 #ifdeà
CONFIG_SMP


128 
__š™d©a
 
£tup_max_ıus
 = 
NR_CPUS
;

141 
__w—k
 
	$¬ch_di§bË_smp_suµÜt
(è{ 
	}
}

143 
__š™
 
	$nosmp
(*
¡r
)

145 
£tup_max_ıus
 = 0;

146 
	`¬ch_di§bË_smp_suµÜt
();

149 
	}
}

151 
—¾y_·¿m
("nosmp", 
nosmp
);

153 
__š™
 
	$maxıus
(*
¡r
)

155 
	`g‘_İtiÚ
(&
¡r
, &
£tup_max_ıus
);

156 ià(
£tup_max_ıus
 == 0)

157 
	`¬ch_di§bË_smp_suµÜt
();

160 
	}
}

162 
—¾y_·¿m
("maxıus", 
maxıus
);

164 cÚ¡ 
	g£tup_max_ıus
 = 
NR_CPUS
;

176 
	g»£t_deviûs
;

177 
EXPORT_SYMBOL
(
»£t_deviûs
);

179 
__š™
 
	$£t_»£t_deviûs
(*
¡r
)

181 
»£t_deviûs
 = 1;

183 
	}
}

185 
__£tup
("»£t_deviûs", 
£t_»£t_deviûs
);

187 * 
	g¬gv_š™
[
MAX_INIT_ARGS
+2] = { "š™", 
NULL
, };

188 * 
	g’vp_š™
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMöšux", 
NULL
, };

189 cÚ¡ *
	g·nic_Ï‹r
, *
	g·nic_·¿m
;

191 
obs_k”Ãl_·¿m
 
__£tup_¡¬t
[], 
__£tup_’d
[];

193 
__š™
 
	$obsŞ‘e_check£tup
(*
lše
)

195 
obs_k”Ãl_·¿m
 *
p
;

196 
had_—¾y_·¿m
 = 0;

198 
p
 = 
__£tup_¡¬t
;

200 
n
 = 
	`¡¾’
(
p
->
¡r
);

201 ià(!
	`¡ºcmp
(
lše
, 
p
->
¡r
, 
n
)) {

202 ià(
p
->
—¾y
) {

207 ià(
lše
[
n
] == '\0' ||†ine[n] == '=')

208 
had_—¾y_·¿m
 = 1;

209 } ià(!
p
->
£tup_func
) {

210 
	`´štk
(
KERN_WARNING
 "Parameter %s is obsolete,"

211 " ignÜed\n", 
p
->
¡r
);

213 } ià(
p
->
	`£tup_func
(
lše
 + 
n
))

216 
p
++;

217 } 
p
 < 
__£tup_’d
);

219  
had_—¾y_·¿m
;

220 
	}
}

226 
	gloİs_³r_jiffy
 = (1<<12);

228 
EXPORT_SYMBOL
(
loİs_³r_jiffy
);

230 
__š™
 
	$debug_k”Ãl
(*
¡r
)

232 
cÚsŞe_logËv–
 = 10;

234 
	}
}

236 
__š™
 
	$qu›t_k”Ãl
(*
¡r
)

238 
cÚsŞe_logËv–
 = 4;

240 
	}
}

242 
—¾y_·¿m
("debug", 
debug_k”Ãl
);

243 
—¾y_·¿m
("qu›t", 
qu›t_k”Ãl
);

245 
__š™
 
	$logËv–
(*
¡r
)

247 
	`g‘_İtiÚ
(&
¡r
, &
cÚsŞe_logËv–
);

249 
	}
}

251 
—¾y_·¿m
("logËv–", 
logËv–
);

257 
__š™
 
	$unknown_boÙİtiÚ
(*
·¿m
, *
v®
)

260 ià(
v®
) {

262 ià(
v®
 =ğ
·¿m
+
	`¡¾’
(param)+1)

263 
v®
[-1] = '=';

264 ià(
v®
 =ğ
·¿m
+
	`¡¾’
(param)+2) {

265 
v®
[-2] = '=';

266 
	`memmove
(
v®
-1, v®, 
	`¡¾’
(val)+1);

267 
v®
--;

269 
	`BUG
();

273 ià(
	`obsŞ‘e_check£tup
(
·¿m
))

280 ià(
	`¡rchr
(
·¿m
, '.'è&& (!
v®
 || strchr(param, '.') < val)) {

281 
	`´štk
(
KERN_ERR
 "UnknowÀboÙ o±iÚ `%s': ignÜšg\n", 
·¿m
);

285 ià(
·nic_Ï‹r
)

288 ià(
v®
) {

290 
i
;

291 
i
 = 0; 
’vp_š™
[i]; i++) {

292 ià(
i
 =ğ
MAX_INIT_ENVS
) {

293 
·nic_Ï‹r
 = "Too many bootƒnv vars‡t `%s'";

294 
·nic_·¿m
 = 
·¿m
;

296 ià(!
	`¡ºcmp
(
·¿m
, 
’vp_š™
[
i
], 
v®
 -…aram))

299 
’vp_š™
[
i
] = 
·¿m
;

302 
i
;

303 
i
 = 0; 
¬gv_š™
[i]; i++) {

304 ià(
i
 =ğ
MAX_INIT_ARGS
) {

305 
·nic_Ï‹r
 = "Too many boot init vars‡t `%s'";

306 
·nic_·¿m
 = 
·¿m
;

309 
¬gv_š™
[
i
] = 
·¿m
;

312 
	}
}

314 #ifdeà
CONFIG_DEBUG_PAGEALLOC


315 
__»ad_mo¡ly
 
	gdebug_·g—Îoc_’abËd
 = 0;

318 
__š™
 
	$š™_£tup
(*
¡r
)

320 
i
;

322 
execu‹_commªd
 = 
¡r
;

329 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

330 
¬gv_š™
[
i
] = 
NULL
;

332 
	}
}

333 
__£tup
("š™=", 
š™_£tup
);

335 
__š™
 
	$rdš™_£tup
(*
¡r
)

337 
i
;

339 
¿mdisk_execu‹_commªd
 = 
¡r
;

341 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

342 
¬gv_š™
[
i
] = 
NULL
;

344 
	}
}

345 
__£tup
("rdš™=", 
rdš™_£tup
);

347 #iâdeà
CONFIG_SMP


349 #ifdeà
CONFIG_X86_LOCAL_APIC


350 
__š™
 
	$smp_š™
()

352 
	`APIC_š™_unroûssÜ
();

353 
	}
}

355 
	#smp_š™
(èdØ{ } 0)

	)

358 
šlše
 
	$£tup_³r_ıu_¬—s
(è{ 
	}
}

359 
šlše
 
	$£tup_Ä_ıu_ids
(è{ 
	}
}

360 
šlše
 
	$smp_´•¬e_ıus
(
maxıus
è{ 
	}
}

364 #ià
NR_CPUS
 > 
BITS_PER_LONG


365 
ıumask_t
 
ıu_mask_®l
 
	g__»ad_mo¡ly
 = 
CPU_MASK_ALL
;

366 
EXPORT_SYMBOL
(
ıu_mask_®l
);

370 
Ä_ıu_ids
 
	g__»ad_mo¡ly
 = 
NR_CPUS
;

371 
EXPORT_SYMBOL
(
Ä_ıu_ids
);

374 
__š™
 
	$£tup_Ä_ıu_ids
()

376 
Ä_ıu_ids
 = 
	`fšd_Ï¡_b™
(
	`ıumask_b™s
(
ıu_possibË_mask
),
NR_CPUS
) + 1;

377 
	}
}

379 #iâdeà
CONFIG_HAVE_SETUP_PER_CPU_AREA


380 
	g__³r_ıu_off£t
[
NR_CPUS
] 
	g__»ad_mo¡ly
;

382 
EXPORT_SYMBOL
(
__³r_ıu_off£t
);

384 
__š™
 
	$£tup_³r_ıu_¬—s
()

386 
size
, 
i
;

387 *
±r
;

388 
Ä_possibË_ıus
 = 
	`num_possibË_ıus
();

391 
size
 = 
	`ALIGN
(
PERCPU_ENOUGH_ROOM
, 
PAGE_SIZE
);

392 
±r
 = 
	`®loc_boÙmem_·ges
(
size
 * 
Ä_possibË_ıus
);

394 
	`fÜ_—ch_possibË_ıu
(
i
) {

395 
__³r_ıu_off£t
[
i
] = 
±r
 - 
__³r_ıu_¡¬t
;

396 
	`memıy
(
±r
, 
__³r_ıu_¡¬t
, 
__³r_ıu_’d
 - __per_cpu_start);

397 
±r
 +ğ
size
;

399 
	}
}

403 
__š™
 
	$smp_š™
()

405 
ıu
;

411 
	`£t_ıu_aùive
(
	`smp_´oûssÜ_id
(), 
Œue
);

414 
	`fÜ_—ch_´e£Á_ıu
(
ıu
) {

415 ià(
	`num_Úlše_ıus
(è>ğ
£tup_max_ıus
)

417 ià(!
	`ıu_Úlše
(
ıu
))

418 
	`ıu_up
(
ıu
);

422 
	`´štk
(
KERN_INFO
 "Broughˆu°%ld CPUs\n", ()
	`num_Úlše_ıus
());

423 
	`smp_ıus_dÚe
(
£tup_max_ıus
);

424 
	}
}

434 
__š™
 
	$£tup_commªd_lše
(*
commªd_lše
)

436 
§ved_commªd_lše
 = 
	`®loc_boÙmem
(
	`¡¾’
 (
boÙ_commªd_lše
)+1);

437 
¡©ic_commªd_lše
 = 
	`®loc_boÙmem
(
	`¡¾’
 (
commªd_lše
)+1);

438 
	`¡rıy
 (
§ved_commªd_lše
, 
boÙ_commªd_lše
);

439 
	`¡rıy
 (
¡©ic_commªd_lše
, 
commªd_lše
);

440 
	}
}

451 
nošlše
 
__š™_»fok
 
	$»¡_š™
()

452 
	$__»Ëa£s
(
k”Ãl_lock
)

454 
pid
;

456 
	`k”Ãl_th»ad
(
k”Ãl_š™
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

457 
	`numa_deçuÉ_pŞicy
();

458 
pid
 = 
	`k”Ãl_th»ad
(
kth»add
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

459 
kth»add_sk
 = 
	`fšd_sk_by_pid_ns
(
pid
, &
š™_pid_ns
);

460 
	`uÆock_k”Ãl
();

466 
	`š™_idË_boÙup_sk
(
cu¼’t
);

467 
	`rcu_scheduËr_¡¬tšg
();

468 
	`´“m±_’abË_no_»sched
();

469 
	`scheduË
();

470 
	`´“m±_di§bË
();

473 
	`ıu_idË
();

474 
	}
}

477 
__š™
 
	$do_—¾y_·¿m
(*
·¿m
, *
v®
)

479 
obs_k”Ãl_·¿m
 *
p
;

481 
p
 = 
__£tup_¡¬t
;… < 
__£tup_’d
;…++) {

482 ià((
p
->
—¾y
 && 
	`¡rcmp
(
·¿m
,…->
¡r
) == 0) ||

483 (
	`¡rcmp
(
·¿m
, "console") == 0 &&

484 
	`¡rcmp
(
p
->
¡r
, "earlycon") == 0)

486 ià(
p
->
	`£tup_func
(
v®
) != 0)

487 
	`´štk
(
KERN_WARNING


488 "M®fÜmedƒ¬ly o±iÚ '%s'\n", 
·¿m
);

493 
	}
}

495 
__š™
 
	$·r£_—¾y_İtiÚs
(*
cmdlše
)

497 
	`·r£_¬gs
("—¾y o±iÚs", 
cmdlše
, 
NULL
, 0, 
do_—¾y_·¿m
);

498 
	}
}

501 
__š™
 
	$·r£_—¾y_·¿m
()

503 
__š™d©a
 
dÚe
 = 0;

504 
__š™d©a
 
tmp_cmdlše
[
COMMAND_LINE_SIZE
];

506 ià(
dÚe
)

510 
	`¡¾ıy
(
tmp_cmdlše
, 
boÙ_commªd_lše
, 
COMMAND_LINE_SIZE
);

511 
	`·r£_—¾y_İtiÚs
(
tmp_cmdlše
);

512 
dÚe
 = 1;

513 
	}
}

519 
__š™
 
	$boÙ_ıu_š™
()

521 
ıu
 = 
	`smp_´oûssÜ_id
();

523 
	`£t_ıu_Úlše
(
ıu
, 
Œue
);

524 
	`£t_ıu_´e£Á
(
ıu
, 
Œue
);

525 
	`£t_ıu_possibË
(
ıu
, 
Œue
);

526 
	}
}

528 
__š™
 
__w—k
 
	$smp_£tup_´oûssÜ_id
()

530 
	}
}

532 
__š™
 
__w—k
 
	$th»ad_šfo_ÿche_š™
()

534 
	}
}

536 
asmlškage
 
__š™
 
	$¡¬t_k”Ãl
()

538 * 
commªd_lše
;

539 
k”Ãl_·¿m
 
__¡¬t___·¿m
[], 
__¡İ___·¿m
[];

541 
	`smp_£tup_´oûssÜ_id
();

547 
	`lockd•_š™
();

548 
	`debug_objeùs_—¾y_š™
();

553 
	`boÙ_š™_¡ack_ÿÇry
();

555 
	`cgroup_š™_—¾y
();

557 
	`loÿl_œq_di§bË
();

558 
	`—¾y_boÙ_œqs_off
();

559 
	`—¾y_š™_œq_lock_şass
();

565 
	`lock_k”Ãl
();

566 
	`tick_š™
();

567 
	`boÙ_ıu_š™
();

568 
	`·ge_add»ss_š™
();

569 
	`´štk
(
KERN_NOTICE
 "%s", 
lšux_bªÃr
);

570 
	`£tup_¬ch
(&
commªd_lše
);

571 
	`mm_š™_owÃr
(&
š™_mm
, &
š™_sk
);

572 
	`£tup_commªd_lše
(
commªd_lše
);

573 
	`£tup_³r_ıu_¬—s
();

574 
	`£tup_Ä_ıu_ids
();

575 
	`smp_´•¬e_boÙ_ıu
();

582 
	`sched_š™
();

587 
	`´“m±_di§bË
();

588 
	`bud_®l_zÚ–i¡s
();

589 
	`·ge_®loc_š™
();

590 
	`´štk
(
KERN_NOTICE
 "K”ÃÈcommªd†še: %s\n", 
boÙ_commªd_lše
);

591 
	`·r£_—¾y_·¿m
();

592 
	`·r£_¬gs
("BoÙšg k”Ãl", 
¡©ic_commªd_lše
, 
__¡¬t___·¿m
,

593 
__¡İ___·¿m
 - 
__¡¬t___·¿m
,

594 &
unknown_boÙİtiÚ
);

595 ià(!
	`œqs_di§bËd
()) {

596 
	`´štk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

598 
	`loÿl_œq_di§bË
();

600 
	`sÜt_maš_exbË
();

601 
	`Œ­_š™
();

602 
	`rcu_š™
();

604 
	`—¾y_œq_š™
();

605 
	`š™_IRQ
();

606 
	`pidhash_š™
();

607 
	`š™_tim”s
();

608 
	`h¹im”s_š™
();

609 
	`soáœq_š™
();

610 
	`timek“pšg_š™
();

611 
	`time_š™
();

612 
	`sched_şock_š™
();

613 
	`´ofe_š™
();

614 ià(!
	`œqs_di§bËd
())

615 
	`´štk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

617 
	`—¾y_boÙ_œqs_Ú
();

618 
	`loÿl_œq_’abË
();

625 
	`cÚsŞe_š™
();

626 ià(
·nic_Ï‹r
)

627 
	`·nic
(
·nic_Ï‹r
, 
·nic_·¿m
);

629 
	`lockd•_šfo
();

636 
	`lockšg_£láe¡
();

638 #ifdeà
CONFIG_BLK_DEV_INITRD


639 ià(
š™rd_¡¬t
 && !
š™rd_b–ow_¡¬t_ok
 &&

640 
	`·ge_to_pâ
(
	`vœt_to_·ge
((*)
š™rd_¡¬t
)è< 
mš_low_pâ
) {

641 
	`´štk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

643 
	`·ge_to_pâ
(
	`vœt_to_·ge
((*)
š™rd_¡¬t
)),

644 
mš_low_pâ
);

645 
š™rd_¡¬t
 = 0;

648 
	`vm®loc_š™
();

649 
	`vfs_ÿches_š™_—¾y
();

650 
	`ıu£t_š™_—¾y
();

651 
	`·ge_cgroup_š™
();

652 
	`mem_š™
();

653 
	`’abË_debug_·g—Îoc
();

654 
	`ıu_hÙ¶ug_š™
();

655 
	`kmem_ÿche_š™
();

656 
	`kmemŒaû_š™
();

657 
	`debug_objeùs_mem_š™
();

658 
	`idr_š™_ÿche
();

659 
	`£tup_³r_ıu_·ge£t
();

660 
	`numa_pŞicy_š™
();

661 ià(
Ï‹_time_š™
)

662 
	`Ï‹_time_š™
();

663 
	`ÿlib¿‹_d–ay
();

664 
	`pidm­_š™
();

665 
	`pgbË_ÿche_š™
();

666 
	`´io_Œ“_š™
();

667 
	`ªÚ_vma_š™
();

668 #ifdeà
CONFIG_X86


669 ià(
efi_’abËd
)

670 
	`efi_’‹r_vœtu®_mode
();

672 
	`th»ad_šfo_ÿche_š™
();

673 
	`üed_š™
();

674 
	`fÜk_š™
(
num_phy¥ages
);

675 
	`´oc_ÿches_š™
();

676 
	`bufãr_š™
();

677 
	`key_š™
();

678 
	`£cur™y_š™
();

679 
	`vfs_ÿches_š™
(
num_phy¥ages
);

680 
	`¿dix_Œ“_š™
();

681 
	`sigÇls_š™
();

683 
	`·ge_wr™eback_š™
();

684 #ifdeà
CONFIG_PROC_FS


685 
	`´oc_roÙ_š™
();

687 
	`cgroup_š™
();

688 
	`ıu£t_š™
();

689 
	`sk¡©s_š™_—¾y
();

690 
	`d–ayacù_š™
();

692 
	`check_bugs
();

694 
	`aıi_—¾y_š™
();

696 
	`á¿û_š™
();

699 
	`»¡_š™
();

700 
	}
}

702 
	gš™ÿÎ_debug
;

703 
cÜe_·¿m
(
š™ÿÎ_debug
, in™ÿÎ_debug, 
boŞ
, 0644);

705 
	$do_Úe_š™ÿÎ
(
š™ÿÎ_t
 
â
)

707 
couÁ
 = 
	`´“m±_couÁ
();

708 
ktime_t
 
ÿÎtime
, 
d–
, 
»‰ime
;

709 
msgbuf
[64];

710 
boÙ_Œaû_ÿÎ
 
ÿÎ
;

711 
boÙ_Œaû_»t
 
»t
;

713 ià(
š™ÿÎ_debug
) {

714 
ÿÎ
.
ÿÎ”
 = 
	`sk_pid_Ä
(
cu¼’t
);

715 
	`´štk
("ÿÎšg %pF @ %i\n", 
â
, 
ÿÎ
.
ÿÎ”
);

716 
ÿÎtime
 = 
	`ktime_g‘
();

717 
	`Œaû_boÙ_ÿÎ
(&
ÿÎ
, 
â
);

718 
	`’abË_boÙ_Œaû
();

721 
»t
.
»suÉ
 = 
	`â
();

723 ià(
š™ÿÎ_debug
) {

724 
	`di§bË_boÙ_Œaû
();

725 
»‰ime
 = 
	`ktime_g‘
();

726 
d–
 = 
	`ktime_sub
(
»‰ime
, 
ÿÎtime
);

727 
»t
.
du¿tiÚ
 = (è
	`ktime_to_ns
(
d–
) >> 10;

728 
	`Œaû_boÙ_»t
(&
»t
, 
â
);

729 
	`´štk
("š™ÿÎ %pF„‘uºed %d‡á” %Ld u£cs\n", 
â
,

730 
»t
.
»suÉ
,„‘.
du¿tiÚ
);

733 
msgbuf
[0] = 0;

735 ià(
»t
.
»suÉ
 &&„‘.»suÉ !ğ-
ENODEV
 && 
š™ÿÎ_debug
)

736 
	`¥rštf
(
msgbuf
, "”rÜ cod%d ", 
»t
.
»suÉ
);

738 ià(
	`´“m±_couÁ
(è!ğ
couÁ
) {

739 
	`¡¾ÿt
(
msgbuf
, "preemption imbalance ", (msgbuf));

740 
	`´“m±_couÁ
(èğ
couÁ
;

742 ià(
	`œqs_di§bËd
()) {

743 
	`¡¾ÿt
(
msgbuf
, "disabled interrupts ", (msgbuf));

744 
	`loÿl_œq_’abË
();

746 ià(
msgbuf
[0]) {

747 
	`´štk
("š™ÿÎ %pF„‘uºed w™h %s\n", 
â
, 
msgbuf
);

750  
»t
.
»suÉ
;

751 
	}
}

754 
š™ÿÎ_t
 
__š™ÿÎ_¡¬t
[], 
__š™ÿÎ_’d
[], 
__—¾y_š™ÿÎ_’d
[];

756 
__š™
 
	$do_š™ÿÎs
()

758 
š™ÿÎ_t
 *
ÿÎ
;

760 
ÿÎ
 = 
__—¾y_š™ÿÎ_’d
; c®È< 
__š™ÿÎ_’d
; call++)

761 
	`do_Úe_š™ÿÎ
(*
ÿÎ
);

764 
	`æush_scheduËd_wÜk
();

765 
	}
}

774 
__š™
 
	$do_basic_£tup
()

776 
	`rcu_š™_sched
();

777 
	`š™_wÜkqueues
();

778 
	`ıu£t_š™_smp
();

779 
	`u£rmodeh–³r_š™
();

780 
	`driv”_š™
();

781 
	`š™_œq_´oc
();

782 
	`do_š™ÿÎs
();

783 
	}
}

785 
__š™
 
	$do_´e_smp_š™ÿÎs
()

787 
š™ÿÎ_t
 *
ÿÎ
;

789 
ÿÎ
 = 
__š™ÿÎ_¡¬t
; c®È< 
__—¾y_š™ÿÎ_’d
; call++)

790 
	`do_Úe_š™ÿÎ
(*
ÿÎ
);

791 
	}
}

793 
	$run_š™_´oûss
(*
š™_f’ame
)

795 
¬gv_š™
[0] = 
š™_f’ame
;

796 
	`k”Ãl_execve
(
š™_f’ame
, 
¬gv_š™
, 
’vp_š™
);

797 
	}
}

802 
nošlše
 
	$š™_po¡
()

803 
	$__»Ëa£s
(
k”Ãl_lock
)

806 
	`async_synchrÚize_fuÎ
();

807 
	`ä“_š™mem
();

808 
	`uÆock_k”Ãl
();

809 
	`m¬k_rod©a_ro
();

810 
sy¡em_¡©e
 = 
SYSTEM_RUNNING
;

811 
	`numa_deçuÉ_pŞicy
();

813 ià(
	`sys_İ’
((cÚ¡ 
__u£r
 *è"/dev/cÚsŞe", 
O_RDWR
, 0) < 0)

814 
	`´štk
(
KERN_WARNING
 "Warning: unableo open‡n initial console.\n");

816 (è
	`sys_dup
(0);

817 (è
	`sys_dup
(0);

819 
cu¼’t
->
sigÇl
->
æags
 |ğ
SIGNAL_UNKILLABLE
;

821 ià(
¿mdisk_execu‹_commªd
) {

822 
	`run_š™_´oûss
(
¿mdisk_execu‹_commªd
);

823 
	`´štk
(
KERN_WARNING
 "Failedoƒxecute %s\n",

824 
¿mdisk_execu‹_commªd
);

833 ià(
execu‹_commªd
) {

834 
	`run_š™_´oûss
(
execu‹_commªd
);

835 
	`´štk
(
KERN_WARNING
 "Failedoƒxecute %s. Attempting "

836 "deçuÉs...\n", 
execu‹_commªd
);

838 
	`run_š™_´oûss
("/sbin/init");

839 
	`run_š™_´oûss
("/etc/init");

840 
	`run_š™_´oûss
("/bin/init");

841 
	`run_š™_´oûss
("/bin/sh");

843 
	`·nic
("No init found. Try…assing init= optiono kernel.");

844 
	}
}

846 
__š™
 
	$k”Ãl_š™
(* 
unu£d
)

848 
	`lock_k”Ãl
();

852 
	`£t_ıus_®lowed_±r
(
cu¼’t
, 
ıu_®l_mask
);

861 
š™_pid_ns
.
chd_»­”
 = 
cu¼’t
;

863 
ÿd_pid
 = 
	`sk_pid
(
cu¼’t
);

865 
	`smp_´•¬e_ıus
(
£tup_max_ıus
);

867 
	`do_´e_smp_š™ÿÎs
();

868 
	`¡¬t_boÙ_Œaû
();

870 
	`smp_š™
();

871 
	`sched_š™_smp
();

873 
	`do_basic_£tup
();

880 ià(!
¿mdisk_execu‹_commªd
)

881 
¿mdisk_execu‹_commªd
 = "/init";

883 ià(
	`sys_acûss
((cÚ¡ 
__u£r
 *è
¿mdisk_execu‹_commªd
, 0) != 0) {

884 
¿mdisk_execu‹_commªd
 = 
NULL
;

885 
	`´•¬e_Çme¥aû
();

894 
	`š™_po¡
();

896 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<lšux/compe.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/uts.h
>

12 
	~<lšux/ut¢ame.h
>

13 
	~<lšux/ut¤–—£.h
>

14 
	~<lšux/v”siÚ.h
>

16 #iâdeà
CONFIG_KALLSYMS


17 
	#v”siÚ
(
a
è
V”siÚ_
 ## 
	)
a

18 
	#v”siÚ_¡ršg
(
a
è
	`v”siÚ
×)

	)

20 
v”siÚ_¡ršg
(
LINUX_VERSION_CODE
);

21 
v”siÚ_¡ršg
(
LINUX_VERSION_CODE
);

24 
uts_Çme¥aû
 
	gš™_uts_ns
 = {

25 .
k»f
 = {

26 .
»fcouÁ
 = 
ATOMIC_INIT
(2),

28 .
	gÇme
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnod’ame
 = 
UTS_NODENAME
,

31 .
	g»Ëa£
 = 
UTS_RELEASE
,

32 .
	gv”siÚ
 = 
UTS_VERSION
,

33 .
	gmachše
 = 
UTS_MACHINE
,

34 .
	gdomašÇme
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
š™_uts_ns
);

40 cÚ¡ 
	glšux_bªÃr
[] =

41 "Lšux v”siÚ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "è(" 
LINUX_COMPILER
 "è" 
UTS_VERSION
 "\n";

44 cÚ¡ 
	glšux_´oc_bªÃr
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
145
6176
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/processor.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit_64.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module_64.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time_64.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
