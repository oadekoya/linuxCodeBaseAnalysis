cscope 15 /cmpt816/data -q 0000011183 0001411885
	@/cmpt816/linux/arch/x86/ia32/audit.c

1 
	~<asm/uni°d_32.h
>

3 
	gü32_dú_˛ass
[] = {

4 
	~<asm-gíîic/audô_dú_wrôe.h
>

8 
	gü32_ch©å_˛ass
[] = {

9 
	~<asm-gíîic/audô_ch™ge_©å.h
>

13 
	gü32_wrôe_˛ass
[] = {

14 
	~<asm-gíîic/audô_wrôe.h
>

18 
	gü32_ªad_˛ass
[] = {

19 
	~<asm-gíîic/audô_ªad.h
>

23 
	gü32_sig«l_˛ass
[] = {

24 
	~<asm-gíîic/audô_sig«l.h
>

28 
	$ü32_˛assify_sysˇŒ
(
sysˇŒ
)

30 
sysˇŒ
) {

31 
__NR_›í
:

33 
__NR_›í©
:

35 
__NR_sockëˇŒ
:

37 
__NR_execve
:

42 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ia32_signal.c

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/uni°d.h
>

20 
	~<löux/°ddef.h
>

21 
	~<löux/≥rs⁄Æôy.h
>

22 
	~<löux/com∑t.h
>

23 
	~<löux/böfmts.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/±ø˚.h
>

28 
	~<asm/ü32_uni°d.h
>

29 
	~<asm/u£r32.h
>

30 
	~<asm/sigc⁄ãxt32.h
>

31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/vdso.h
>

33 
	~<asm/sig‰ame.h
>

34 
	~<asm/sys_ü32.h
>

36 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

38 
	#FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

39 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

40 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

41 
X86_EFLAGS_CF
)

	)

43 
sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
);

45 
	$c›y_sigöfo_to_u£r32
(
com∑t_sigöfo_t
 
__u£r
 *
to
, 
sigöfo_t
 *
‰om
)

47 
îr
 = 0;

49 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
to
, (
com∑t_sigöfo_t
)))

50  -
EFAULT
;

52 
put_u£r_åy
 {

58 
	`put_u£r_ex
(
‰om
->
si_signo
, &
to
->si_signo);

59 
	`put_u£r_ex
(
‰om
->
si_î∫o
, &
to
->si_errno);

60 
	`put_u£r_ex
(()
‰om
->
si_code
, &
to
->si_code);

62 i‡(
‰om
->
si_code
 < 0) {

63 
	`put_u£r_ex
(
‰om
->
si_pid
, &
to
->si_pid);

64 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

65 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
), &
to
->si_ptr);

71 
	`put_u£r_ex
(
‰om
->
_sifõlds
.
_∑d
[0],

72 &
to
->
_sifõlds
.
_∑d
[0]);

73 
‰om
->
si_code
 >> 16) {

74 
__SI_FAULT
 >> 16:

76 
__SI_CHLD
 >> 16:

77 
	`put_u£r_ex
(
‰om
->
si_utime
, &
to
->si_utime);

78 
	`put_u£r_ex
(
‰om
->
si_°ime
, &
to
->si_stime);

79 
	`put_u£r_ex
(
‰om
->
si_°©us
, &
to
->si_status);

82 
__SI_KILL
 >> 16:

83 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

85 
__SI_POLL
 >> 16:

86 
	`put_u£r_ex
(
‰om
->
si_fd
, &
to
->si_fd);

88 
__SI_TIMER
 >> 16:

89 
	`put_u£r_ex
(
‰om
->
si_ovîrun
, &
to
->si_overrun);

90 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
),

91 &
to
->
si_±r
);

94 
__SI_RT
 >> 16:

95 
__SI_MESGQ
 >> 16:

96 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

97 
	`put_u£r_ex
(
‰om
->
si_öt
, &
to
->si_int);

101 } 
	`put_u£r_ˇtch
(
îr
);

103  
îr
;

104 
	}
}

106 
	$c›y_sigöfo_‰om_u£r32
(
sigöfo_t
 *
to
, 
com∑t_sigöfo_t
 
__u£r
 *
‰om
)

108 
îr
 = 0;

109 
u32
 
±r32
;

111 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰om
, (
com∑t_sigöfo_t
)))

112  -
EFAULT
;

114 
gë_u£r_åy
 {

115 
	`gë_u£r_ex
(
to
->
si_signo
, &
‰om
->si_signo);

116 
	`gë_u£r_ex
(
to
->
si_î∫o
, &
‰om
->si_errno);

117 
	`gë_u£r_ex
(
to
->
si_code
, &
‰om
->si_code);

119 
	`gë_u£r_ex
(
to
->
si_pid
, &
‰om
->si_pid);

120 
	`gë_u£r_ex
(
to
->
si_uid
, &
‰om
->si_uid);

121 
	`gë_u£r_ex
(
±r32
, &
‰om
->
si_±r
);

122 
to
->
si_±r
 = 
	`com∑t_±r
(
±r32
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

128 
asmlökage
 
	$sys32_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

130 
mask
 &
_BLOCKABLE
;

131 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

132 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

133 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

134 
	`ªˇlc_sig≥ndög
();

135 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

137 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

138 
	`scheduÀ
();

139 
	`£t_ª°‹e_sigmask
();

140  -
ERESTARTNOHAND
;

141 
	}
}

143 
asmlökage
 
	$sys32_sigÆt°ack
(c⁄° 
°ack_ü32_t
 
__u£r
 *
uss_±r
,

144 
°ack_ü32_t
 
__u£r
 *
uoss_±r
,

145 
±_ªgs
 *
ªgs
)

147 
°ack_t
 
uss
, 
uoss
;

148 
ªt
, 
îr
 = 0;

149 
mm_£gmít_t
 
£g
;

151 i‡(
uss_±r
) {

152 
u32
 
±r
;

154 
	`mem£t
(&
uss
, 0, (
°ack_t
));

155 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
uss_±r
, (
°ack_ü32_t
)))

156  -
EFAULT
;

158 
gë_u£r_åy
 {

159 
	`gë_u£r_ex
(
±r
, &
uss_±r
->
ss_•
);

160 
	`gë_u£r_ex
(
uss
.
ss_Êags
, &
uss_±r
->ss_flags);

161 
	`gë_u£r_ex
(
uss
.
ss_size
, &
uss_±r
->ss_size);

162 } 
	`gë_u£r_ˇtch
(
îr
);

164 i‡(
îr
)

165  -
EFAULT
;

166 
uss
.
ss_•
 = 
	`com∑t_±r
(
±r
);

168 
£g
 = 
	`gë_fs
();

169 
	`£t_fs
(
KERNEL_DS
);

170 
ªt
 = 
	`do_sigÆt°ack
(
uss_±r
 ? &
uss
 : 
NULL
, &
uoss
, 
ªgs
->
•
);

171 
	`£t_fs
(
£g
);

172 i‡(
ªt
 >0 && 
uoss_±r
) {

173 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss_±r
, (
°ack_ü32_t
)))

174  -
EFAULT
;

176 
put_u£r_åy
 {

177 
	`put_u£r_ex
(
	`±r_to_com∑t
(
uoss
.
ss_•
), &
uoss_±r
->ss_sp);

178 
	`put_u£r_ex
(
uoss
.
ss_Êags
, &
uoss_±r
->ss_flags);

179 
	`put_u£r_ex
(
uoss
.
ss_size
, &
uoss_±r
->ss_size);

180 } 
	`put_u£r_ˇtch
(
îr
);

182 i‡(
îr
)

183 
ªt
 = -
EFAULT
;

185  
ªt
;

186 
	}
}

191 
	#lﬂd£gmít_gs
(
v
Ë
	`lﬂd_gs_ödex
(v)

	)

192 
	#lﬂd£gmít_fs
(
v
Ë
	`lﬂd£gmít
(
fs
, v)

	)

193 
	#lﬂd£gmít_ds
(
v
Ë
	`lﬂd£gmít
(
ds
, v)

	)

194 
	#lﬂd£gmít_es
(
v
Ë
	`lﬂd£gmít
(
es
, v)

	)

196 
	#gë_u£r_£g
(
£g
Ë({ 
v
; 
	`ßve£gmít
(£g, v); v; })

	)

197 
	#£t_u£r_£g
(
£g
, 
v
Ë
lﬂd£gmít_
##
	`£g
(v)

	)

199 
	#COPY
(
x
) { \

200 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

201 }

	)

203 
	#GET_SEG
(
£g
) ({ \

204 
tmp
; \

205 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

206 
tmp
; \

207 })

	)

209 
	#COPY_SEG_CPL3
(
£g
) do { \

210 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

211 } 0)

	)

213 
	#RELOAD_SEG
(
£g
) { \

214 
¥e
 = 
	`GET_SEG
(
£g
); \

215 
cur
 = 
	`gë_u£r_£g
(
£g
); \

216 
¥e
 |= 3; \

217 i‡(
¥e
 !
cur
) \

218 
	`£t_u£r_£g
(
£g
, 
¥e
); \

219 }

	)

221 
	$ü32_ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
,

222 
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

223 *
∑x
)

225 
tmpÊags
, 
îr
 = 0;

226 
__u£r
 *
buf
;

227 
u32
 
tmp
;

230 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

232 
gë_u£r_åy
 {

239 
	`RELOAD_SEG
(
gs
);

240 
	`RELOAD_SEG
(
fs
);

241 
	`RELOAD_SEG
(
ds
);

242 
	`RELOAD_SEG
(
es
);

244 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

245 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

248 
	`COPY_SEG_CPL3
(
cs
);

249 
	`COPY_SEG_CPL3
(
ss
);

251 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

252 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

254 
ªgs
->
‹ig_ax
 = -1;

256 
	`gë_u£r_ex
(
tmp
, &
sc
->
Â°©e
);

257 
buf
 = 
	`com∑t_±r
(
tmp
);

258 
îr
 |
	`ª°‹e_i387_x°©e_ü32
(
buf
);

260 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

261 } 
	`gë_u£r_ˇtch
(
îr
);

263  
îr
;

264 
	}
}

266 
asmlökage
 
	$sys32_sigªtu∫
(
±_ªgs
 *
ªgs
)

268 
sig‰ame_ü32
 
__u£r
 *
‰ame
 = (sig‰ame_ü32 __u£∏*)(
ªgs
->
•
-8);

269 
sig£t_t
 
£t
;

270 
ax
;

272 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

273 
bad‰ame
;

274 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
)

275 || (
_COMPAT_NSIG_WORDS
 > 1

276 && 
	`__c›y_‰om_u£r
((((*Ë&
£t
.
sig
) + 4),

277 &
‰ame
->
exåamask
,

278 (
‰ame
->
exåamask
))))

279 
bad‰ame
;

281 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

282 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

283 
cuºít
->
blocked
 = 
£t
;

284 
	`ªˇlc_sig≥ndög
();

285 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

287 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

288 
bad‰ame
;

289  
ax
;

291 
bad‰ame
:

292 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bit sigreturn");

294 
	}
}

296 
asmlökage
 
	$sys32_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

299 
sig£t_t
 
£t
;

300 
ax
;

301 
±_ªgs
 
åegs
;

303 
‰ame
 = (
π_sig‰ame_ü32
 
__u£r
 *)(
ªgs
->
•
 - 4);

305 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

306 
bad‰ame
;

307 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

308 
bad‰ame
;

310 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

311 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

312 
cuºít
->
blocked
 = 
£t
;

313 
	`ªˇlc_sig≥ndög
();

314 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

316 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

317 
bad‰ame
;

319 
åegs
 = *
ªgs
;

320 i‡(
	`sys32_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, &
åegs
Ë=-
EFAULT
)

321 
bad‰ame
;

323  
ax
;

325 
bad‰ame
:

326 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bitÑt sigreturn");

328 
	}
}

334 
	$ü32_£tup_sigc⁄ãxt
(
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

335 
__u£r
 *
Â°©e
,

336 
±_ªgs
 *
ªgs
, 
mask
)

338 
îr
 = 0;

340 
put_u£r_åy
 {

341 
	`put_u£r_ex
(
	`gë_u£r_£g
(
gs
), (
__u£r
 *)&
sc
->gs);

342 
	`put_u£r_ex
(
	`gë_u£r_£g
(
fs
), (
__u£r
 *)&
sc
->fs);

343 
	`put_u£r_ex
(
	`gë_u£r_£g
(
ds
), (
__u£r
 *)&
sc
->ds);

344 
	`put_u£r_ex
(
	`gë_u£r_£g
(
es
), (
__u£r
 *)&
sc
->es);

346 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

347 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

348 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

349 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

350 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

351 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

352 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

353 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

354 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

355 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

356 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

357 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

358 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

359 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

360 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

362 
	`put_u£r_ex
(
	`±r_to_com∑t
(
Â°©e
), &
sc
->fpstate);

365 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

366 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

367 } 
	`put_u£r_ˇtch
(
îr
);

369  
îr
;

370 
	}
}

375 
__u£r
 *
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
,

376 
size_t
 
‰ame_size
,

377 **
Â°©e
)

379 
•
;

382 
•
 = 
ªgs
->sp;

385 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

386 i‡(
	`ßs_ss_Êags
(
•
) == 0)

387 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

391 i‡((
ªgs
->
ss
 & 0xffffË!
__USER32_DS
 &&

392 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

393 
ka
->
ß
.
ß_ª°‹î
)

394 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

396 i‡(
	`u£d_m©h
()) {

397 
•
 = s∞- 
sig_x°©e_ü32_size
;

398 *
Â°©e
 = (
_Â°©e_ü32
 *Ë
•
;

399 i‡(
	`ßve_i387_x°©e_ü32
(*
Â°©e
) < 0)

400  (
__u£r
 *) -1L;

403 
•
 -
‰ame_size
;

406 
•
 = ((sp + 4) & -16ul) - 4;

407  (
__u£r
 *Ë
•
;

408 
	}
}

410 
	$ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

411 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

413 
sig‰ame_ü32
 
__u£r
 *
‰ame
;

414 
__u£r
 *
ª°‹î
;

415 
îr
 = 0;

416 
__u£r
 *
Â°©e
 = 
NULL
;

420 
u16
 
p›lmovl
;

421 
u32
 
vÆ
;

422 
u16
 
öt80
;

423 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

425 
__NR_ü32_sigªtu∫
,

429 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

431 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

432  -
EFAULT
;

434 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

435  -
EFAULT
;

437 i‡(
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

438  -
EFAULT
;

440 i‡(
_COMPAT_NSIG_WORDS
 > 1) {

441 i‡(
	`__c›y_to_u£r
(
‰ame
->
exåamask
, &
£t
->
sig
[1],

442 (
‰ame
->
exåamask
)))

443  -
EFAULT
;

446 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

447 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

450 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

451 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

452 
sigªtu∫
);

454 
ª°‹î
 = &
‰ame
->
ªtcode
;

457 
put_u£r_åy
 {

458 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

464 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

465 } 
	`put_u£r_ˇtch
(
îr
);

467 i‡(
îr
)

468  -
EFAULT
;

471 
ªgs
->
•
 = (Ë
‰ame
;

472 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

475 
ªgs
->
ax
 = 
sig
;

476 
ªgs
->
dx
 = 0;

477 
ªgs
->
cx
 = 0;

479 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

480 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

482 
ªgs
->
cs
 = 
__USER32_CS
;

483 
ªgs
->
ss
 = 
__USER32_DS
;

486 
	}
}

488 
	$ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

489 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

491 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

492 
__u£r
 *
ª°‹î
;

493 
îr
 = 0;

494 
__u£r
 *
Â°©e
 = 
NULL
;

498 
u8
 
movl
;

499 
u32
 
vÆ
;

500 
u16
 
öt80
;

501 
u8
 
∑d
;

502 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

504 
__NR_ü32_π_sigªtu∫
,

509 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

511 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

512  -
EFAULT
;

514 
put_u£r_åy
 {

515 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

516 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
öfo
), &‰ame->
pöfo
);

517 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
uc
), &‰ame->
puc
);

518 
îr
 |
	`c›y_sigöfo_to_u£r32
(&
‰ame
->
öfo
, info);

521 i‡(
˝u_has_xßve
)

522 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

524 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

525 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

526 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

527 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

528 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

529 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

530 
îr
 |
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

531 
ªgs
, 
£t
->
sig
[0]);

532 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

534 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

535 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

537 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

538 
π_sigªtu∫
);

539 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

545 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

546 } 
	`put_u£r_ˇtch
(
îr
);

548 i‡(
îr
)

549  -
EFAULT
;

552 
ªgs
->
•
 = (Ë
‰ame
;

553 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

556 
ªgs
->
ax
 = 
sig
;

557 
ªgs
->
dx
 = (Ë&
‰ame
->
öfo
;

558 
ªgs
->
cx
 = (Ë&
‰ame
->
uc
;

560 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

561 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

563 
ªgs
->
cs
 = 
__USER32_CS
;

564 
ªgs
->
ss
 = 
__USER32_DS
;

567 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ipc32.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/•ölock.h
>

3 
	~<löux/li°.h
>

4 
	~<löux/sysˇŒs.h
>

5 
	~<löux/time.h
>

6 
	~<löux/£m.h
>

7 
	~<löux/msg.h
>

8 
	~<löux/shm.h
>

9 
	~<löux/ùc.h
>

10 
	~<löux/com∑t.h
>

11 
	~<asm/sys_ü32.h
>

13 
asmlökage
 
	$sys32_ùc
(
u32
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

14 
com∑t_u±r_t
 
±r
, 
u32
 
fi·h
)

16 
vîsi⁄
;

18 
vîsi⁄
 = 
ˇŒ
 >> 16;

19 
ˇŒ
 &= 0xffff;

21 
ˇŒ
) {

22 
SEMOP
:

24  
	`sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
, 
NULL
);

25 
SEMTIMEDOP
:

26  
	`com∑t_sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
,

27 
	`com∑t_±r
(
fi·h
));

28 
SEMGET
:

29  
	`sys_£mgë
(
fú°
, 
£c⁄d
, 
thúd
);

30 
SEMCTL
:

31  
	`com∑t_sys_£m˘l
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

33 
MSGSND
:

34  
	`com∑t_sys_msg¢d
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

35 
MSGRCV
:

36  
	`com∑t_sys_msgrcv
(
fú°
, 
£c⁄d
, 
fi·h
, 
thúd
,

37 
vîsi⁄
, 
	`com∑t_±r
(
±r
));

38 
MSGGET
:

39  
	`sys_msggë
((
key_t
Ë
fú°
, 
£c⁄d
);

40 
MSGCTL
:

41  
	`com∑t_sys_msg˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

43 
SHMAT
:

44  
	`com∑t_sys_shm©
(
fú°
, 
£c⁄d
, 
thúd
, 
vîsi⁄
,

45 
	`com∑t_±r
(
±r
));

46 
SHMDT
:

47  
	`sys_shmdt
(
	`com∑t_±r
(
±r
));

48 
SHMGET
:

49  
	`sys_shmgë
(
fú°
, ()
£c⁄d
, 
thúd
);

50 
SHMCTL
:

51  
	`com∑t_sys_shm˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

53  -
ENOSYS
;

54 
	}
}

	@/cmpt816/linux/arch/x86/ia32/sys_ia32.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/sig«l.h
>

28 
	~<löux/sysˇŒs.h
>

29 
	~<löux/times.h
>

30 
	~<löux/ut¢ame.h
>

31 
	~<löux/smp_lock.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/uio.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/≥rs⁄Æôy.h
>

36 
	~<löux/°©.h
>

37 
	~<löux/rw£m.h
>

38 
	~<löux/com∑t.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/±ø˚.h
>

41 
	~<löux/highuid.h
>

42 
	~<löux/sys˘l.h
>

43 
	~<löux/¶ab.h
>

44 
	~<asm/mm™.h
>

45 
	~<asm/ty≥s.h
>

46 
	~<asm/uac˚ss.h
>

47 
	~<asm/©omic.h
>

48 
	~<asm/vgtod.h
>

49 
	~<asm/sys_ü32.h
>

51 
	#AA
(
__x
Ë(()(__x))

	)

54 
asmlökage
 
	$sys32_åunˇã64
(
__u£r
 *
fûíame
,

55 
off£t_low
,

56 
off£t_high
)

58  
	`sys_åunˇã
(
fûíame
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

59 
	}
}

61 
asmlökage
 
	$sys32_·runˇã64
(
fd
, 
off£t_low
,

62 
off£t_high
)

64  
	`sys_·runˇã
(
fd
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

65 
	}
}

71 
	$˝_°©64
(
°©64
 
__u£r
 *
ubuf
, 
k°©
 *
°©
)

73 
	`ty≥of
(
ubuf
->
°_uid
Ë
uid
 = 0;

74 
	`ty≥of
(
ubuf
->
°_gid
Ë
gid
 = 0;

75 
	`SET_UID
(
uid
, 
°©
->uid);

76 
	`SET_GID
(
gid
, 
°©
->gid);

77 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ubuf
, (
°©64
)) ||

78 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
dev
), &
ubuf
->
°_dev
) ||

79 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
__°_öo
) ||

80 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
°_öo
) ||

81 
	`__put_u£r
(
°©
->
mode
, &
ubuf
->
°_mode
) ||

82 
	`__put_u£r
(
°©
->
∆ök
, &
ubuf
->
°_∆ök
) ||

83 
	`__put_u£r
(
uid
, &
ubuf
->
°_uid
) ||

84 
	`__put_u£r
(
gid
, &
ubuf
->
°_gid
) ||

85 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
rdev
), &
ubuf
->
°_rdev
) ||

86 
	`__put_u£r
(
°©
->
size
, &
ubuf
->
°_size
) ||

87 
	`__put_u£r
(
°©
->
©ime
.
tv_£c
, &
ubuf
->
°_©ime
) ||

88 
	`__put_u£r
(
°©
->
©ime
.
tv_n£c
, &
ubuf
->
°_©ime_n£c
) ||

89 
	`__put_u£r
(
°©
->
mtime
.
tv_£c
, &
ubuf
->
°_mtime
) ||

90 
	`__put_u£r
(
°©
->
mtime
.
tv_n£c
, &
ubuf
->
°_mtime_n£c
) ||

91 
	`__put_u£r
(
°©
->
˘ime
.
tv_£c
, &
ubuf
->
°_˘ime
) ||

92 
	`__put_u£r
(
°©
->
˘ime
.
tv_n£c
, &
ubuf
->
°_˘ime_n£c
) ||

93 
	`__put_u£r
(
°©
->
blksize
, &
ubuf
->
°_blksize
) ||

94 
	`__put_u£r
(
°©
->
blocks
, &
ubuf
->
°_blocks
))

95  -
EFAULT
;

97 
	}
}

99 
asmlökage
 
	$sys32_°©64
(
__u£r
 *
fûíame
,

100 
°©64
 
__u£r
 *
°©buf
)

102 
k°©
 
°©
;

103 
ªt
 = 
	`vfs_°©
(
fûíame
, &
°©
);

105 i‡(!
ªt
)

106 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

107  
ªt
;

108 
	}
}

110 
asmlökage
 
	$sys32_l°©64
(
__u£r
 *
fûíame
,

111 
°©64
 
__u£r
 *
°©buf
)

113 
k°©
 
°©
;

114 
ªt
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

115 i‡(!
ªt
)

116 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

117  
ªt
;

118 
	}
}

120 
asmlökage
 
	$sys32_f°©64
(
fd
, 
°©64
 
__u£r
 *
°©buf
)

122 
k°©
 
°©
;

123 
ªt
 = 
	`vfs_f°©
(
fd
, &
°©
);

124 i‡(!
ªt
)

125 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

126  
ªt
;

127 
	}
}

129 
asmlökage
 
	$sys32_f°©©
(
dfd
, 
__u£r
 *
fûíame
,

130 
°©64
 
__u£r
 *
°©buf
, 
Êag
)

132 
k°©
 
°©
;

133 
îr‹
;

135 
îr‹
 = 
	`vfs_f°©©
(
dfd
, 
fûíame
, &
°©
, 
Êag
);

136 i‡(
îr‹
)

137  
îr‹
;

138  
	`˝_°©64
(
°©buf
, &
°©
);

139 
	}
}

147 
	smm≠_¨g_°ru˘32
 {

148 
	maddr
;

149 
	mÀn
;

150 
	m¥Ÿ
;

151 
	mÊags
;

152 
	mfd
;

153 
	moff£t
;

156 
asmlökage
 
	$sys32_mm≠
(
mm≠_¨g_°ru˘32
 
__u£r
 *
¨g
)

158 
mm≠_¨g_°ru˘32
 
a
;

160 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

161  -
EFAULT
;

163 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

164  -
EINVAL
;

166  
	`sys_mm≠_pgoff
(
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,á.
fd
,

167 
a
.
off£t
>>
PAGE_SHIFT
);

168 
	}
}

170 
asmlökage
 
	$sys32_m¥Ÿe˘
(
°¨t
, 
size_t
 
Àn
,

171 
¥Ÿ
)

173  
	`sys_m¥Ÿe˘
(
°¨t
, 
Àn
, 
¥Ÿ
);

174 
	}
}

176 
asmlökage
 
	$sys32_π_siga˘i⁄
(
sig
, 
siga˘i⁄32
 
__u£r
 *
a˘
,

177 
siga˘i⁄32
 
__u£r
 *
ﬂ˘
,

178 
sig£tsize
)

180 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

181 
ªt
;

182 
com∑t_sig£t_t
 
£t32
;

185 i‡(
sig£tsize
 !(
com∑t_sig£t_t
))

186  -
EINVAL
;

188 i‡(
a˘
) {

189 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

191 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

192 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

193 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

194 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

195 
	`__c›y_‰om_u£r
(&
£t32
, &
a˘
->
ß_mask
,

196 (
com∑t_sig£t_t
)))

197  -
EFAULT
;

198 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

199 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

205 
_NSIG_WORDS
) {

206 4: 
√w_ka
.
ß
.
ß_mask
.
sig
[3] = 
£t32
.sig[6]

207 | ((()
£t32
.
sig
[7]) << 32);

208 3: 
√w_ka
.
ß
.
ß_mask
.
sig
[2] = 
£t32
.sig[4]

209 | ((()
£t32
.
sig
[5]) << 32);

210 2: 
√w_ka
.
ß
.
ß_mask
.
sig
[1] = 
£t32
.sig[2]

211 | ((()
£t32
.
sig
[3]) << 32);

212 1: 
√w_ka
.
ß
.
ß_mask
.
sig
[0] = 
£t32
.sig[0]

213 | ((()
£t32
.
sig
[1]) << 32);

217 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

219 i‡(!
ªt
 && 
ﬂ˘
) {

224 
_NSIG_WORDS
) {

226 
£t32
.
sig
[7] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[3] >> 32);

227 
£t32
.
sig
[6] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[3];

229 
£t32
.
sig
[5] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[2] >> 32);

230 
£t32
.
sig
[4] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[2];

232 
£t32
.
sig
[3] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[1] >> 32);

233 
£t32
.
sig
[2] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[1];

235 
£t32
.
sig
[1] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[0] >> 32);

236 
£t32
.
sig
[0] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[0];

238 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

239 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

240 &
ﬂ˘
->
ß_h™dÀr
) ||

241 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

242 &
ﬂ˘
->
ß_ª°‹î
) ||

243 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

244 
	`__c›y_to_u£r
(&
ﬂ˘
->
ß_mask
, &
£t32
,

245 (
com∑t_sig£t_t
)))

246  -
EFAULT
;

249  
ªt
;

250 
	}
}

252 
asmlökage
 
	$sys32_siga˘i⁄
(
sig
, 
ﬁd_siga˘i⁄32
 
__u£r
 *
a˘
,

253 
ﬁd_siga˘i⁄32
 
__u£r
 *
ﬂ˘
)

255 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

256 
ªt
;

258 i‡(
a˘
) {

259 
com∑t_ﬁd_sig£t_t
 
mask
;

260 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

262 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

263 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

264 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

265 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

266 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
))

267  -
EFAULT
;

269 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

270 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

272 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

275 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

277 i‡(!
ªt
 && 
ﬂ˘
) {

278 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

279 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

280 &
ﬂ˘
->
ß_h™dÀr
) ||

281 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

282 &
ﬂ˘
->
ß_ª°‹î
) ||

283 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

284 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask))

285  -
EFAULT
;

288  
ªt
;

289 
	}
}

291 
asmlökage
 
	$sys32_π_sig¥ocmask
(
how
, 
com∑t_sig£t_t
 
__u£r
 *
£t
,

292 
com∑t_sig£t_t
 
__u£r
 *
o£t
,

293 
sig£tsize
)

295 
sig£t_t
 
s
;

296 
com∑t_sig£t_t
 
s32
;

297 
ªt
;

298 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

300 i‡(
£t
) {

301 i‡(
	`c›y_‰om_u£r
(&
s32
, 
£t
, (
com∑t_sig£t_t
)))

302  -
EFAULT
;

303 
_NSIG_WORDS
) {

304 4: 
s
.
sig
[3] = 
s32
.sig[6] | ((()s32.sig[7]) << 32);

305 3: 
s
.
sig
[2] = 
s32
.sig[4] | ((()s32.sig[5]) << 32);

306 2: 
s
.
sig
[1] = 
s32
.sig[2] | ((()s32.sig[3]) << 32);

307 1: 
s
.
sig
[0] = 
s32
.sig[0] | ((()s32.sig[1]) << 32);

310 
	`£t_fs
(
KERNEL_DS
);

311 
ªt
 = 
	`sys_π_sig¥ocmask
(
how
,

312 
£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

313 
o£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

314 
sig£tsize
);

315 
	`£t_fs
(
ﬁd_fs
);

316 i‡(
ªt
)

317  
ªt
;

318 i‡(
o£t
) {

319 
_NSIG_WORDS
) {

320 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

321 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

322 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

323 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

325 i‡(
	`c›y_to_u£r
(
o£t
, &
s32
, (
com∑t_sig£t_t
)))

326  -
EFAULT
;

329 
	}
}

331 
asmlökage
 
	$sys32_Æ¨m
(
£c⁄ds
)

333  
	`Æ¨m_£tôimî
(
£c⁄ds
);

334 
	}
}

336 
asmlökage
 
	$sys32_waôpid
(
com∑t_pid_t
 
pid
, *
°©_addr
,

337 
›ti⁄s
)

339  
	`com∑t_sys_waô4
(
pid
, 
°©_addr
, 
›ti⁄s
, 
NULL
);

340 
	}
}

344 
asmlökage
 
	$sys32_sysfs
(
›ti⁄
, 
u32
 
¨g1
, u32 
¨g2
)

346  
	`sys_sysfs
(
›ti⁄
, 
¨g1
, 
¨g2
);

347 
	}
}

349 
asmlökage
 
	$sys32_sched_º_gë_öãrvÆ
(
com∑t_pid_t
 
pid
,

350 
com∑t_time•ec
 
__u£r
 *
öãrvÆ
)

352 
time•ec
 
t
;

353 
ªt
;

354 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

356 
	`£t_fs
(
KERNEL_DS
);

357 
ªt
 = 
	`sys_sched_º_gë_öãrvÆ
(
pid
, (
time•ec
 
__u£r
 *)&
t
);

358 
	`£t_fs
(
ﬁd_fs
);

359 i‡(
	`put_com∑t_time•ec
(&
t
, 
öãrvÆ
))

360  -
EFAULT
;

361  
ªt
;

362 
	}
}

364 
asmlökage
 
	$sys32_π_sig≥ndög
(
com∑t_sig£t_t
 
__u£r
 *
£t
,

365 
com∑t_size_t
 
sig£tsize
)

367 
sig£t_t
 
s
;

368 
com∑t_sig£t_t
 
s32
;

369 
ªt
;

370 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

372 
	`£t_fs
(
KERNEL_DS
);

373 
ªt
 = 
	`sys_π_sig≥ndög
((
sig£t_t
 
__u£r
 *)&
s
, 
sig£tsize
);

374 
	`£t_fs
(
ﬁd_fs
);

375 i‡(!
ªt
) {

376 
_NSIG_WORDS
) {

377 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

378 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

379 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

380 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

382 i‡(
	`c›y_to_u£r
(
£t
, &
s32
, (
com∑t_sig£t_t
)))

383  -
EFAULT
;

385  
ªt
;

386 
	}
}

388 
asmlökage
 
	$sys32_π_sigqueueöfo
(
pid
, 
sig
,

389 
com∑t_sigöfo_t
 
__u£r
 *
uöfo
)

391 
sigöfo_t
 
öfo
;

392 
ªt
;

393 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

395 i‡(
	`c›y_sigöfo_‰om_u£r32
(&
öfo
, 
uöfo
))

396  -
EFAULT
;

397 
	`£t_fs
(
KERNEL_DS
);

398 
ªt
 = 
	`sys_π_sigqueueöfo
(
pid
, 
sig
, (
sigöfo_t
 
__u£r
 *)&
öfo
);

399 
	`£t_fs
(
ﬁd_fs
);

400  
ªt
;

401 
	}
}

404 
asmlökage
 
	$sys32_¥ód
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

405 
u32
 
po¶o
, u32 
poshi
)

407  
	`sys_¥ód64
(
fd
, 
ubuf
, 
cou¡
,

408 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

409 
	}
}

411 
asmlökage
 
	$sys32_pwrôe
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

412 
u32
 
po¶o
, u32 
poshi
)

414  
	`sys_pwrôe64
(
fd
, 
ubuf
, 
cou¡
,

415 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

416 
	}
}

419 
asmlökage
 
	$sys32_≥rs⁄Æôy
(
≥rs⁄Æôy
)

421 
ªt
;

423 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
 &&

424 
≥rs⁄Æôy
 =
PER_LINUX
)

425 
≥rs⁄Æôy
 = 
PER_LINUX32
;

426 
ªt
 = 
	`sys_≥rs⁄Æôy
(
≥rs⁄Æôy
);

427 i‡(
ªt
 =
PER_LINUX32
)

428 
ªt
 = 
PER_LINUX
;

429  
ªt
;

430 
	}
}

432 
asmlökage
 
	$sys32_£ndfûe
(
out_fd
, 
ö_fd
,

433 
com∑t_off_t
 
__u£r
 *
off£t
, 
s32
 
cou¡
)

435 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

436 
ªt
;

437 
off_t
 
of
;

439 i‡(
off£t
 && 
	`gë_u£r
(
of
, offset))

440  -
EFAULT
;

442 
	`£t_fs
(
KERNEL_DS
);

443 
ªt
 = 
	`sys_£ndfûe
(
out_fd
, 
ö_fd
, 
off£t
 ? (
off_t
 
__u£r
 *)&
of
 : 
NULL
,

444 
cou¡
);

445 
	`£t_fs
(
ﬁd_fs
);

447 i‡(
off£t
 && 
	`put_u£r
(
of
, offset))

448  -
EFAULT
;

449  
ªt
;

450 
	}
}

452 
asmlökage
 
	$sys32_execve
(
__u£r
 *
«me
, 
com∑t_u±r_t
 __u£∏*
¨gv
,

453 
com∑t_u±r_t
 
__u£r
 *
ívp
, 
±_ªgs
 *
ªgs
)

455 
îr‹
;

456 *
fûíame
;

458 
fûíame
 = 
	`gë«me
(
«me
);

459 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

460 i‡(
	`IS_ERR
(
fûíame
))

461  
îr‹
;

462 
îr‹
 = 
	`com∑t_do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

463 
	`puäame
(
fûíame
);

464  
îr‹
;

465 
	}
}

467 
asmlökage
 
	$sys32_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

468 
±_ªgs
 *
ªgs
)

470 
__u£r
 *
∑ª¡_tid
 = (__u£∏*)
ªgs
->
dx
;

471 
__u£r
 *
chûd_tid
 = (__u£∏*)
ªgs
->
di
;

473 i‡(!
√w•
)

474 
√w•
 = 
ªgs
->
•
;

475  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

476 
	}
}

482 
	$sys32_l£ek
(
fd
, 
off£t
, 
whí˚
)

484  
	`sys_l£ek
(
fd
, 
off£t
, 
whí˚
);

485 
	}
}

487 
	$sys32_kûl
(
pid
, 
sig
)

489  
	`sys_kûl
(
pid
, 
sig
);

490 
	}
}

492 
	$sys32_Ádvi£64_64
(
fd
, 
__u32
 
off£t_low
, __u32 
off£t_high
,

493 
__u32
 
Àn_low
, __u32 
Àn_high
, 
advi˚
)

495  
	`sys_Ádvi£64_64
(
fd
,

496 (((
u64
)
off£t_high
)<<32Ë| 
off£t_low
,

497 (((
u64
)
Àn_high
)<<32Ë| 
Àn_low
,

498 
advi˚
);

499 
	}
}

501 
	$sys32_vm86_w¨nög
()

503 
èsk_°ru˘
 *
me
 = 
cuºít
;

504 
œ°comm
[(
me
->
comm
)];

506 i‡(
	`°∫cmp
(
œ°comm
, 
me
->
comm
, (lastcomm))) {

507 
	`com∑t_¥ötk
(
KERN_INFO


509 
me
->
comm
);

510 
	`°∫˝y
(
œ°comm
, 
me
->
comm
, (lastcomm));

512  -
ENOSYS
;

513 
	}
}

515 
	$sys32_lookup_dcookõ
(
u32
 
addr_low
, u32 
addr_high
,

516 
__u£r
 *
buf
, 
size_t
 
Àn
)

518  
	`sys_lookup_dcookõ
(((
u64
)
addr_high
 << 32Ë| 
addr_low
, 
buf
, 
Àn
);

519 
	}
}

521 
asmlökage
 
ssize_t
 
	$sys32_ªadahód
(
fd
, 
off_lo
, 
off_hi
,

522 
size_t
 
cou¡
)

524  
	`sys_ªadahód
(
fd
, ((
u64
)
off_hi
 << 32Ë| 
off_lo
, 
cou¡
);

525 
	}
}

527 
asmlökage
 
	$sys32_sync_fûe_ønge
(
fd
, 
off_low
, 
off_hi
,

528 
n_low
, 
n_hi
, 
Êags
)

530  
	`sys_sync_fûe_ønge
(
fd
,

531 ((
u64
)
off_hi
 << 32Ë| 
off_low
,

532 ((
u64
)
n_hi
 << 32Ë| 
n_low
, 
Êags
);

533 
	}
}

535 
asmlökage
 
	$sys32_Ádvi£64
(
fd
, 
off£t_lo
, 
off£t_hi
,

536 
size_t
 
Àn
, 
advi˚
)

538  
	`sys_Ádvi£64_64
(
fd
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

539 
Àn
, 
advi˚
);

540 
	}
}

542 
asmlökage
 
	$sys32_ÁŒoˇã
(
fd
, 
mode
, 
off£t_lo
,

543 
off£t_hi
, 
Àn_lo
,

544 
Àn_hi
)

546  
	`sys_ÁŒoˇã
(
fd
, 
mode
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

547 ((
u64
)
Àn_hi
 << 32Ë| 
Àn_lo
);

548 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<löux/öô.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/a˝i_pmtmr.h
>

29 
	~<löux/efi.h
>

30 
	~<löux/˝umask.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/dmi.h
>

33 
	~<löux/úq.h
>

34 
	~<löux/¶ab.h
>

35 
	~<löux/boŸmem.h
>

36 
	~<löux/i›‹t.h
>

37 
	~<löux/pci.h
>

39 
	~<asm/pci_x86.h
>

40 
	~<asm/pgèbÀ.h
>

41 
	~<asm/io_≠ic.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/io.h
>

44 
	~<asm/mp•ec.h
>

45 
	~<asm/smp.h
>

47 
__öôd©a
 
	ga˝i_f‹˚
 = 0;

48 
u32
 
	ga˝i_rsdt_f‹˚d
;

49 
	ga˝i_dißbÀd
;

50 
EXPORT_SYMBOL
(
a˝i_dißbÀd
);

52 #ifdef 
CONFIG_X86_64


53 
	~<asm/¥Ÿo.h
>

54 
	~<asm/numa_64.h
>

57 
	#BAD_MADT_ENTRY
(
íåy
, 
íd
) ( \

58 (!
íåy
Ë|| (Î¡ry + (*íåyË> 
íd
 || \

59 ((
a˝i_subèbÀ_hódî
 *)
íåy
)->
Àngth
 < (*íåy))

	)

61 
	#PREFIX
 "ACPI: "

	)

63 
	ga˝i_noúq
;

64 
	ga˝i_pci_dißbÀd
;

65 
EXPORT_SYMBOL
(
a˝i_pci_dißbÀd
);

66 
a˝i_ht
 
	g__öôd©a
 = 1;

68 
	ga˝i_œpic
;

69 
	ga˝i_iﬂpic
;

70 
	ga˝i_°ri˘
;

72 
u8
 
a˝i_sci_Êags
 
	g__öôd©a
;

73 
a˝i_sci_ovîride_gsi
 
	g__öôd©a
;

74 
a˝i_skù_timî_ovîride
 
	g__öôd©a
;

75 
a˝i_u£_timî_ovîride
 
	g__öôd©a
;

77 #ifde‡
CONFIG_X86_LOCAL_APIC


78 
u64
 
a˝i_œpic_addr
 
	g__öôd©a
 = 
APIC_DEFAULT_PHYS_BASE
;

81 #i‚de‡
__HAVE_ARCH_CMPXCHG


82 #w¨nög 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
™d
 
œãr
 
h¨dw¨e


93 
a˝i_úq_modñ_id
 
	ga˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_PIC
;

108 *
__öô
 
	$__a˝i_m≠_èbÀ
(
phys
, 
size
)

111 i‡(!
phys
 || !
size
)

112  
NULL
;

114  
	`óæy_i‹em≠
(
phys
, 
size
);

115 
	}
}

116 
__öô
 
	$__a˝i_unm≠_èbÀ
(*
m≠
, 
size
)

118 i‡(!
m≠
 || !
size
)

121 
	`óæy_iounm≠
(
m≠
, 
size
);

122 
	}
}

124 #ifde‡
CONFIG_X86_LOCAL_APIC


125 
__öô
 
	$a˝i_∑r£_madt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

127 
a˝i_èbÀ_madt
 *
madt
 = 
NULL
;

129 i‡(!
˝u_has_≠ic
)

130  -
EINVAL
;

132 
madt
 = (
a˝i_èbÀ_madt
 *)
èbÀ
;

133 i‡(!
madt
) {

134 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map MADT\n");

135  -
ENODEV
;

138 i‡(
madt
->
addªss
) {

139 
a˝i_œpic_addr
 = (
u64
Ë
madt
->
addªss
;

141 
	`¥ötk
(
KERN_DEBUG
 
PREFIX
 "Local APICáddress 0x%08x\n",

142 
madt
->
addªss
);

145 
	`deÁu…_a˝i_madt_€m_check
(
madt
->
hódî
.
€m_id
,

146 
madt
->
hódî
.
€m_èbÀ_id
);

149 
	}
}

151 
__˝uöô
 
	$a˝i_ªgi°î_œpic
(
id
, 
u8
 
íabÀd
)

153 
vî
 = 0;

155 i‡(!
íabÀd
) {

156 ++
dißbÀd_˝us
;

160 i‡(
boŸ_˝u_physiˇl_≠icid
 != -1U)

161 
vî
 = 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
];

163 
	`gíîic_¥o˚ss‹_öfo
(
id
, 
vî
);

164 
	}
}

166 
__öô


167 
	$a˝i_∑r£_x2≠ic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

169 
a˝i_madt_loˇl_x2≠ic
 *
¥o˚ss‹
 = 
NULL
;

171 
¥o˚ss‹
 = (
a˝i_madt_loˇl_x2≠ic
 *)
hódî
;

173 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

174  -
EINVAL
;

176 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

178 #ifde‡
CONFIG_X86_X2APIC


186 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
loˇl_≠ic_id
,

187 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

189 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "x2apicÉntry ignored\n");

193 
	}
}

195 
__öô


196 
	$a˝i_∑r£_œpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

198 
a˝i_madt_loˇl_≠ic
 *
¥o˚ss‹
 = 
NULL
;

200 
¥o˚ss‹
 = (
a˝i_madt_loˇl_≠ic
 *)
hódî
;

202 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

203  -
EINVAL
;

205 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

214 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
id
,

215 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

218 
	}
}

220 
__öô


221 
	$a˝i_∑r£_ßpic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

223 
a˝i_madt_loˇl_ßpic
 *
¥o˚ss‹
 = 
NULL
;

225 
¥o˚ss‹
 = (
a˝i_madt_loˇl_ßpic
 *)
hódî
;

227 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

228  -
EINVAL
;

230 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

232 
	`a˝i_ªgi°î_œpic
((
¥o˚ss‹
->
id
 << 8Ë|Öro˚ss‹->
eid
,

233 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

236 
	}
}

238 
__öô


239 
	$a˝i_∑r£_œpic_addr_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

240 c⁄° 
íd
)

242 
a˝i_madt_loˇl_≠ic_ovîride
 *
œpic_addr_ovr
 = 
NULL
;

244 
œpic_addr_ovr
 = (
a˝i_madt_loˇl_≠ic_ovîride
 *)
hódî
;

246 i‡(
	`BAD_MADT_ENTRY
(
œpic_addr_ovr
, 
íd
))

247  -
EINVAL
;

249 
a˝i_œpic_addr
 = 
œpic_addr_ovr
->
addªss
;

252 
	}
}

254 
__öô


255 
	$a˝i_∑r£_x2≠ic_nmi
(
a˝i_subèbÀ_hódî
 *
hódî
,

256 c⁄° 
íd
)

258 
a˝i_madt_loˇl_x2≠ic_nmi
 *
x2≠ic_nmi
 = 
NULL
;

260 
x2≠ic_nmi
 = (
a˝i_madt_loˇl_x2≠ic_nmi
 *)
hódî
;

262 i‡(
	`BAD_MADT_ENTRY
(
x2≠ic_nmi
, 
íd
))

263  -
EINVAL
;

265 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

267 i‡(
x2≠ic_nmi
->
löt
 != 1)

268 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

271 
	}
}

273 
__öô


274 
	$a˝i_∑r£_œpic_nmi
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

276 
a˝i_madt_loˇl_≠ic_nmi
 *
œpic_nmi
 = 
NULL
;

278 
œpic_nmi
 = (
a˝i_madt_loˇl_≠ic_nmi
 *)
hódî
;

280 i‡(
	`BAD_MADT_ENTRY
(
œpic_nmi
, 
íd
))

281  -
EINVAL
;

283 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

285 i‡(
œpic_nmi
->
löt
 != 1)

286 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

289 
	}
}

293 #ifde‡
CONFIG_X86_IO_APIC


295 
__öô


296 
	$a˝i_∑r£_iﬂpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

298 
a˝i_madt_io_≠ic
 *
iﬂpic
 = 
NULL
;

300 
iﬂpic
 = (
a˝i_madt_io_≠ic
 *)
hódî
;

302 i‡(
	`BAD_MADT_ENTRY
(
iﬂpic
, 
íd
))

303  -
EINVAL
;

305 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

307 
	`mp_ªgi°î_iﬂpic
(
iﬂpic
->
id
,

308 
iﬂpic
->
addªss
, iﬂpic->
globÆ_úq_ba£
);

311 
	}
}

316 
__öô
 
	$a˝i_sci_iﬂpic_£tup
(
u32
 
gsi
, 
u16
 
pﬁ¨ôy
, u16 
åiggî
)

318 i‡(
åiggî
 == 0)

319 
åiggî
 = 3;

321 i‡(
pﬁ¨ôy
 == 0)

322 
pﬁ¨ôy
 = 3;

325 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
)

326 
åiggî
 = (
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

328 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
)

329 
pﬁ¨ôy
 = 
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
;

336 
	`mp_ovîride_Àgacy_úq
(
gsi
, 
pﬁ¨ôy
, 
åiggî
, gsi);

342 
a˝i_sci_ovîride_gsi
 = 
gsi
;

344 
	}
}

346 
__öô


347 
	$a˝i_∑r£_öt_§c_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

348 c⁄° 
íd
)

350 
a˝i_madt_öãºu±_ovîride
 *
öt§c
 = 
NULL
;

352 
öt§c
 = (
a˝i_madt_öãºu±_ovîride
 *)
hódî
;

354 i‡(
	`BAD_MADT_ENTRY
(
öt§c
, 
íd
))

355  -
EINVAL
;

357 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

359 i‡(
öt§c
->
sour˚_úq
 =
a˝i_gbl_FADT
.
sci_öãºu±
) {

360 
	`a˝i_sci_iﬂpic_£tup
(
öt§c
->
globÆ_úq
,

361 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

362 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

366 i‡(
a˝i_skù_timî_ovîride
 &&

367 
öt§c
->
sour˚_úq
 =0 && i¡§c->
globÆ_úq
 == 2) {

368 
	`¥ötk
(
PREFIX
 "BIOS IRQ0Öin2 override ignored.\n");

372 
	`mp_ovîride_Àgacy_úq
(
öt§c
->
sour˚_úq
,

373 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

374 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

375 
öt§c
->
globÆ_úq
);

378 
	}
}

380 
__öô


381 
	$a˝i_∑r£_nmi_§c
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

383 
a˝i_madt_nmi_sour˚
 *
nmi_§c
 = 
NULL
;

385 
nmi_§c
 = (
a˝i_madt_nmi_sour˚
 *)
hódî
;

387 i‡(
	`BAD_MADT_ENTRY
(
nmi_§c
, 
íd
))

388  -
EINVAL
;

390 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

395 
	}
}

413 
__öô
 
	$a˝i_pic_sci_£t_åiggî
(
úq
, 
u16
 
åiggî
)

415 
mask
 = 1 << 
úq
;

416 
ﬁd
, 
√w
;

419 
ﬁd
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

426 
√w
 = 
a˝i_noúq
 ? 
ﬁd
 : 0;

432 
åiggî
) {

434 
√w
 &~
mask
;

437 
√w
 |
mask
;

441 i‡(
ﬁd
 =
√w
)

444 
	`¥ötk
(
PREFIX
 "£âög ELCRÅÿ%04x (‰om %04x)\n", 
√w
, 
ﬁd
);

445 
	`outb
(
√w
, 0x4d0);

446 
	`outb
(
√w
 >> 8, 0x4d1);

447 
	}
}

449 
	$a˝i_gsi_to_úq
(
u32
 
gsi
, *
úq
)

451 *
úq
 = 
gsi
;

453 #ifde‡
CONFIG_X86_IO_APIC


454 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
)

455 
	`£tup_IO_APIC_úq_exåa
(
gsi
);

459 
	}
}

465 
	$a˝i_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

467 
úq
;

468 
∂©_gsi
 = 
gsi
;

470 #ifde‡
CONFIG_PCI


474 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_PIC
) {

475 i‡(
åiggî
 =
ACPI_LEVEL_SENSITIVE
)

476 
	`eiß_£t_Àvñ_úq
(
gsi
);

480 #ifde‡
CONFIG_X86_IO_APIC


481 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
) {

482 
∂©_gsi
 = 
	`mp_ªgi°î_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

485 
úq
 = 
∂©_gsi
;

487  
úq
;

488 
	}
}

493 #ifde‡
CONFIG_ACPI_HOTPLUG_CPU


494 
	~<a˝i/¥o˚ss‹.h
>

496 
	$a˝i_m≠_˝u2node
(
a˝i_h™dÀ
 
h™dÀ
, 
˝u
, 
physid
)

498 #ifde‡
CONFIG_ACPI_NUMA


499 
nid
;

501 
nid
 = 
	`a˝i_gë_node
(
h™dÀ
);

502 i‡(
nid
 =-1 || !
	`node_⁄löe
(nid))

504 #ifde‡
CONFIG_X86_64


505 
≠icid_to_node
[
physid
] = 
nid
;

506 
	`numa_£t_node
(
˝u
, 
nid
);

508 
≠icid_2_node
[
physid
] = 
nid
;

509 
˝u_to_node_m≠
[
˝u
] = 
nid
;

513 
	}
}

515 
__˝uöô
 
	$_a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

517 
a˝i_buf„r
 
buf„r
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

518 
a˝i_obje˘
 *
obj
;

519 
a˝i_madt_loˇl_≠ic
 *
œpic
;

520 
˝umask_v¨_t
 
tmp_m≠
, 
√w_m≠
;

521 
u8
 
physid
;

522 
˝u
;

523 
ªtvÆ
 = -
ENOMEM
;

525 i‡(
	`ACPI_FAILURE
(
	`a˝i_evÆu©e_obje˘
(
h™dÀ
, "_MAT", 
NULL
, &
buf„r
)))

526  -
EINVAL
;

528 i‡(!
buf„r
.
Àngth
 || !buf„r.
poöãr
)

529  -
EINVAL
;

531 
obj
 = 
buf„r
.
poöãr
;

532 i‡(
obj
->
ty≥
 !
ACPI_TYPE_BUFFER
 ||

533 
obj
->
buf„r
.
Àngth
 < (*
œpic
)) {

534 
	`k‰ì
(
buf„r
.
poöãr
);

535  -
EINVAL
;

538 
œpic
 = (
a˝i_madt_loˇl_≠ic
 *)
obj
->
buf„r
.
poöãr
;

540 i‡(
œpic
->
hódî
.
ty≥
 !
ACPI_MADT_TYPE_LOCAL_APIC
 ||

541 !(
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
)) {

542 
	`k‰ì
(
buf„r
.
poöãr
);

543  -
EINVAL
;

546 
physid
 = 
œpic
->
id
;

548 
	`k‰ì
(
buf„r
.
poöãr
);

549 
buf„r
.
Àngth
 = 
ACPI_ALLOCATE_BUFFER
;

550 
buf„r
.
poöãr
 = 
NULL
;

552 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_m≠
, 
GFP_KERNEL
))

553 
out
;

555 i‡(!
	`Æloc_˝umask_v¨
(&
√w_m≠
, 
GFP_KERNEL
))

556 
‰ì_tmp_m≠
;

558 
	`˝umask_c›y
(
tmp_m≠
, 
˝u_¥e£¡_mask
);

559 
	`a˝i_ªgi°î_œpic
(
physid
, 
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

565 
	`˝umask_™dnŸ
(
√w_m≠
, 
˝u_¥e£¡_mask
, 
tmp_m≠
);

566 i‡(
	`˝umask_em±y
(
√w_m≠
)) {

567 
	`¥ötk
 ("UnableÅo mapÜapicÅoÜogical cpuÇumber\n");

568 
ªtvÆ
 = -
EINVAL
;

569 
‰ì_√w_m≠
;

572 
	`a˝i_¥o˚ss‹_£t_pdc
(
h™dÀ
);

574 
˝u
 = 
	`˝umask_fú°
(
√w_m≠
);

575 
	`a˝i_m≠_˝u2node
(
h™dÀ
, 
˝u
, 
physid
);

577 *
p˝u
 = 
˝u
;

578 
ªtvÆ
 = 0;

580 
‰ì_√w_m≠
:

581 
	`‰ì_˝umask_v¨
(
√w_m≠
);

582 
‰ì_tmp_m≠
:

583 
	`‰ì_˝umask_v¨
(
tmp_m≠
);

584 
out
:

585  
ªtvÆ
;

586 
	}
}

589 
__ªf
 
	$a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

591  
	`_a˝i_m≠_lßpic
(
h™dÀ
, 
p˝u
);

592 
	}
}

593 
EXPORT_SYMBOL
(
a˝i_m≠_lßpic
);

595 
	$a˝i_unm≠_lßpic
(
˝u
)

597 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) = -1;

598 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

599 
num_¥o˚ss‹s
--;

602 
	}
}

604 
EXPORT_SYMBOL
(
a˝i_unm≠_lßpic
);

607 
	$a˝i_ªgi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

610  -
EINVAL
;

611 
	}
}

613 
EXPORT_SYMBOL
(
a˝i_ªgi°î_iﬂpic
);

615 
	$a˝i_uƒegi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u32
 
gsi_ba£
)

618  -
EINVAL
;

619 
	}
}

621 
EXPORT_SYMBOL
(
a˝i_uƒegi°î_iﬂpic
);

623 
__öô
 
	$a˝i_∑r£_sbf
(
a˝i_èbÀ_hódî
 *
èbÀ
)

625 
a˝i_èbÀ_boŸ
 *
sb
;

627 
sb
 = (
a˝i_èbÀ_boŸ
 *)
èbÀ
;

628 i‡(!
sb
) {

629 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map SBF\n");

630  -
ENODEV
;

633 
sbf_p‹t
 = 
sb
->
cmos_ödex
;

636 
	}
}

638 #ifde‡
CONFIG_HPET_TIMER


639 
	~<asm/h≥t.h
>

641 
__öôd©a
 
ªsour˚
 *
	gh≥t_ªs
;

643 
__öô
 
	$a˝i_∑r£_h≥t
(
a˝i_èbÀ_hódî
 *
èbÀ
)

645 
a˝i_èbÀ_h≥t
 *
h≥t_tbl
;

647 
h≥t_tbl
 = (
a˝i_èbÀ_h≥t
 *)
èbÀ
;

648 i‡(!
h≥t_tbl
) {

649 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map HPET\n");

650  -
ENODEV
;

653 i‡(
h≥t_tbl
->
addªss
.
•a˚_id
 !
ACPI_SPACE_MEM
) {

654 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPETÅimers must beÜocated in "

659 
h≥t_addªss
 = 
h≥t_tbl
->
addªss
.address;

660 
h≥t_blockid
 = 
h≥t_tbl
->
£quí˚
;

666 i‡(!
h≥t_addªss
) {

667 
	`¥ötk
(
KERN_WARNING
 
PREFIX


669 
h≥t_tbl
->
id
, 
h≥t_addªss
);

672 #ifde‡
CONFIG_X86_64


678 i‡(
h≥t_addªss
 == 0xfed0000000000000UL) {

679 i‡(!
h≥t_f‹˚_u£r
) {

680 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

683 "fix iàu∞tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

684 
h≥t_addªss
 = 0;

687 
	`¥ötk
(
KERN_WARNING
 
PREFIX


689 "tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

690 
h≥t_addªss
 >>= 32;

693 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

694 
h≥t_tbl
->
id
, 
h≥t_addªss
);

700 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

701 
h≥t_ªs
 = 
	`Æloc_boŸmem
((*h≥t_ªsË+ 
HPET_RESOURCE_NAME_SIZE
);

703 
h≥t_ªs
->
«me
 = (*)&hpet_res[1];

704 
h≥t_ªs
->
Êags
 = 
IORESOURCE_MEM
;

705 
	`¢¥ötf
((*)
h≥t_ªs
->
«me
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

706 
h≥t_tbl
->
£quí˚
);

708 
h≥t_ªs
->
°¨t
 = 
h≥t_addªss
;

709 
h≥t_ªs
->
íd
 = 
h≥t_addªss
 + (1 * 1024) - 1;

712 
	}
}

718 
__öô
 
	$h≥t_ö£π_ªsour˚
()

720 i‡(!
h≥t_ªs
)

723  
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
h≥t_ªs
);

724 
	}
}

726 
œã_öôˇŒ
(
h≥t_ö£π_ªsour˚
);

729 
	#a˝i_∑r£_h≥t
 
NULL


	)

732 
__öô
 
	$a˝i_∑r£_Ádt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

735 #ifde‡
CONFIG_X86_PM_TIMER


737 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
) {

739 i‡(
a˝i_gbl_FADT
.
xpm_timî_block
.
•a˚_id
 !=

740 
ACPI_ADR_SPACE_SYSTEM_IO
)

743 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
xpm_timî_block
.
addªss
;

749 i‡(!
pmtmr_i›‹t
)

750 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

753 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

755 i‡(
pmtmr_i›‹t
)

756 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

757 
pmtmr_i›‹t
);

760 
	}
}

762 #ifdef 
CONFIG_X86_LOCAL_APIC


768 
__öô
 
	$a˝i_ªgi°î_œpic_addªss
(
addªss
)

770 
mp_œpic_addr
 = 
addªss
;

772 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
addªss
);

773 i‡(
boŸ_˝u_physiˇl_≠icid
 == -1U) {

774 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

775 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
] =

776 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

778 
	}
}

780 
__öô
 
	$óæy_a˝i_∑r£_madt_œpic_addr_ovr
()

782 
cou¡
;

784 i‡(!
˝u_has_≠ic
)

785  -
ENODEV
;

792 
cou¡
 =

793 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

794 
a˝i_∑r£_œpic_addr_ovr
, 0);

795 i‡(
cou¡
 < 0) {

796 
	`¥ötk
(
KERN_ERR
 
PREFIX


798  
cou¡
;

801 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

803  
cou¡
;

804 
	}
}

806 
__öô
 
	$a˝i_∑r£_madt_œpic_íåõs
()

808 
cou¡
;

809 
x2cou¡
 = 0;

811 i‡(!
˝u_has_≠ic
)

812  -
ENODEV
;

819 
cou¡
 =

820 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

821 
a˝i_∑r£_œpic_addr_ovr
, 0);

822 i‡(
cou¡
 < 0) {

823 
	`¥ötk
(
KERN_ERR
 
PREFIX


825  
cou¡
;

828 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

830 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

831 
a˝i_∑r£_ßpic
, 
MAX_APICS
);

833 i‡(!
cou¡
) {

834 
x2cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

835 
a˝i_∑r£_x2≠ic
, 
MAX_APICS
);

836 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

837 
a˝i_∑r£_œpic
, 
MAX_APICS
);

839 i‡(!
cou¡
 && !
x2cou¡
) {

840 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No LAPICÉntriesÖresent\n");

842  -
ENODEV
;

843 } i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

844 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPICÉntry\n");

846  
cou¡
;

849 
x2cou¡
 =

850 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

851 
a˝i_∑r£_x2≠ic_nmi
, 0);

852 
cou¡
 =

853 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
a˝i_∑r£_œpic_nmi
, 0);

854 i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

855 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPIC NMIÉntry\n");

857  
cou¡
;

860 
	}
}

863 #ifdef 
CONFIG_X86_IO_APIC


864 
	#MP_ISA_BUS
 0

	)

866 #ifde‡
CONFIG_X86_ES7000


867 
es7000_∂©
;

870 
__öô
 
	$a˝i_¥obe_gsi
()

872 
idx
;

873 
gsi
;

874 
max_gsi
 = 0;

876 i‡(
a˝i_dißbÀd
)

879 i‡(!
a˝i_iﬂpic
)

882 
max_gsi
 = 0;

883 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++) {

884 
gsi
 = 
mp_gsi_routög
[
idx
].
gsi_íd
;

886 i‡(
gsi
 > 
max_gsi
)

887 
max_gsi
 = 
gsi
;

890  
max_gsi
 + 1;

891 
	}
}

893 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

894 
mpc_öt§c
 *
mp_úq
)

896 
	`mem˝y
(
mp_úq
, 
m
, (
mpc_öt§c
));

897 
	}
}

899 
	$mp_úq_cmp
(
mpc_öt§c
 *
mp_úq
,

900 
mpc_öt§c
 *
m
)

902  
	`memcmp
(
mp_úq
, 
m
, (
mpc_öt§c
));

903 
	}
}

905 
	$ßve_mp_úq
(
mpc_öt§c
 *
m
)

907 
i
;

909 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

910 i‡(!
	`mp_úq_cmp
(&
mp_úqs
[
i
], 
m
))

914 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

915 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

916 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

917 
	}
}

919 
__öô
 
	$mp_ovîride_Àgacy_úq
(
u8
 
bus_úq
, u8 
pﬁ¨ôy
, u8 
åiggî
, 
u32
 
gsi
)

921 
iﬂpic
;

922 
pö
;

923 
mpc_öt§c
 
mp_úq
;

928 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

929 i‡(
iﬂpic
 < 0)

931 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

938 i‡((
bus_úq
 =0Ë&& (
åiggî
 == 3))

939 
åiggî
 = 1;

941 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

942 
mp_úq
.
úqty≥
 = 
mp_INT
;

943 
mp_úq
.
úqÊag
 = (
åiggî
 << 2Ë| 
pﬁ¨ôy
;

944 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

945 
mp_úq
.
§cbusúq
 = 
bus_úq
;

946 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

947 
mp_úq
.
d°úq
 = 
pö
;

949 
	`ßve_mp_úq
(&
mp_úq
);

950 
	}
}

952 
__öô
 
	$mp_c⁄fig_a˝i_Àgacy_úqs
()

954 
i
;

955 
iﬂpic
;

956 
d°≠ic
;

957 
mpc_öt§c
 
mp_úq
;

959 #i‡
	`deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

963 
mp_bus_id_to_ty≥
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

965 
	`£t_bô
(
MP_ISA_BUS
, 
mp_bus_nŸ_pci
);

966 
	`¥_debug
("Bu†#%d i†ISA\n", 
MP_ISA_BUS
);

968 #ifde‡
CONFIG_X86_ES7000


972 i‡(
es7000_∂©
 == 1)

979 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

980 i‡(
iﬂpic
 < 0)

982 
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

988 
i
 = 0; i < 16; i++) {

989 
idx
;

991 
idx
 = 0; idx < 
mp_úq_íåõs
; idx++) {

992 
mpc_öt§c
 *
úq
 = 
mp_úqs
 + 
idx
;

995 i‡(
úq
->
§cbus
 =
MP_ISA_BUS
 && irq->
§cbusúq
 =
i
)

999 i‡(
úq
->
d°≠ic
 =d°≠i¯&& irq->
d°úq
 =
i
)

1003 i‡(
idx
 !
mp_úq_íåõs
) {

1004 
	`¥ötk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ovîride.\n", 
i
);

1008 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1009 
mp_úq
.
úqÊag
 = 0;

1010 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

1011 
mp_úq
.
d°≠ic
 = dstapic;

1012 
mp_úq
.
úqty≥
 = 
mp_INT
;

1013 
mp_úq
.
§cbusúq
 = 
i
;

1014 
mp_úq
.
d°úq
 = 
i
;

1016 
	`ßve_mp_úq
(&
mp_úq
);

1018 
	}
}

1020 
	$mp_c⁄fig_a˝i_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
,

1021 
pﬁ¨ôy
)

1023 #ifde‡
CONFIG_X86_MPPARSE


1024 
mpc_öt§c
 
mp_úq
;

1025 
pci_dev
 *
pdev
;

1026 
numbî
;

1027 
dev‚
;

1028 
iﬂpic
;

1029 
u8
 
pö
;

1031 i‡(!
a˝i_iﬂpic
)

1033 i‡(!
dev
)

1035 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1038 
pdev
 = 
	`to_pci_dev
(
dev
);

1039 
numbî
 = 
pdev
->
bus
->number;

1040 
dev‚
 = 
pdev
->devfn;

1041 
pö
 = 
pdev
->pin;

1043 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1044 
mp_úq
.
úqty≥
 = 
mp_INT
;

1045 
mp_úq
.
úqÊag
 = (
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1046 (
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1047 
mp_úq
.
§cbus
 = 
numbî
;

1048 
mp_úq
.
§cbusúq
 = (((
dev‚
 >> 3Ë& 0x1fË<< 2Ë| ((
pö
 - 1) & 3);

1049 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1050 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1051 
mp_úq
.
d°úq
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1053 
	`ßve_mp_úq
(&
mp_úq
);

1056 
	}
}

1058 
	$mp_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

1060 
iﬂpic
;

1061 
iﬂpic_pö
;

1062 
io_≠ic_úq_©å
 
úq_©å
;

1064 i‡(
a˝i_úq_modñ
 !
ACPI_IRQ_MODEL_IOAPIC
)

1065  
gsi
;

1068 i‡(
a˝i_gbl_FADT
.
sci_öãºu±
 =
gsi
)

1069  
gsi
;

1071 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1072 i‡(
iﬂpic
 < 0) {

1073 
	`¥ötk
(
KERN_WARNING
 "NÿIOAPIC f‹ GSI %u\n", 
gsi
);

1074  
gsi
;

1077 
iﬂpic_pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1079 #ifde‡
CONFIG_X86_32


1080 i‡(
iﬂpic_ªnumbî_úq
)

1081 
gsi
 = 
	`iﬂpic_ªnumbî_úq
(
iﬂpic
, gsi);

1084 i‡(
iﬂpic_pö
 > 
MP_MAX_IOAPIC_PIN
) {

1085 
	`¥ötk
(
KERN_ERR
 "InvalidÑeferenceÅo IOAPICÖin "

1086 "%d-%d\n", 
mp_iﬂpics
[
iﬂpic
].
≠icid
,

1087 
iﬂpic_pö
);

1088  
gsi
;

1091 i‡(
íabÀ_upd©e_m±abÀ
)

1092 
	`mp_c⁄fig_a˝i_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

1094 
	`£t_io_≠ic_úq_©å
(&
úq_©å
, 
iﬂpic
, 
iﬂpic_pö
,

1095 
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1096 
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1097 
	`io_≠ic_£t_pci_routög
(
dev
, 
gsi
, &
úq_©å
);

1099  
gsi
;

1100 
	}
}

1106 
__öô
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1108 
cou¡
;

1116 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
)

1117  -
ENODEV
;

1119 i‡(!
˝u_has_≠ic
)

1120  -
ENODEV
;

1125 i‡(
skù_iﬂpic_£tup
) {

1126 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPICÖrobe "

1128  -
ENODEV
;

1131 
cou¡
 =

1132 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
a˝i_∑r£_iﬂpic
,

1133 
MAX_IO_APICS
);

1134 i‡(!
cou¡
) {

1135 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No IOAPICÉntriesÖresent\n");

1136  -
ENODEV
;

1137 } i‡(
cou¡
 < 0) {

1138 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing IOAPICÉntry\n");

1139  
cou¡
;

1142 
cou¡
 =

1143 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
a˝i_∑r£_öt_§c_ovr
,

1144 
ƒ_úqs
);

1145 i‡(
cou¡
 < 0) {

1146 
	`¥ötk
(
KERN_ERR
 
PREFIX


1149  
cou¡
;

1156 i‡(!
a˝i_sci_ovîride_gsi
)

1157 
	`a˝i_sci_iﬂpic_£tup
(
a˝i_gbl_FADT
.
sci_öãºu±
, 0, 0);

1160 
	`mp_c⁄fig_a˝i_Àgacy_úqs
();

1162 
cou¡
 =

1163 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
a˝i_∑r£_nmi_§c
,

1164 
ƒ_úqs
);

1165 i‡(
cou¡
 < 0) {

1166 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing NMI SRCÉntry\n");

1168  
cou¡
;

1172 
	}
}

1174 
ölöe
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1177 
	}
}

1180 
__öô
 
	$óæy_a˝i_¥o˚ss_madt
()

1182 #ifde‡
CONFIG_X86_LOCAL_APIC


1183 
îr‹
;

1185 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1190 
îr‹
 = 
	`óæy_a˝i_∑r£_madt_œpic_addr_ovr
();

1191 i‡(!
îr‹
) {

1192 
a˝i_œpic
 = 1;

1193 
smp_found_c⁄fig
 = 1;

1195 i‡(
îr‹
 =-
EINVAL
) {

1199 
	`¥ötk
(
KERN_ERR
 
PREFIX


1201 
	`dißbÀ_a˝i
();

1205 
	}
}

1207 
__öô
 
	$a˝i_¥o˚ss_madt
()

1209 #ifde‡
CONFIG_X86_LOCAL_APIC


1210 
îr‹
;

1212 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1217 
îr‹
 = 
	`a˝i_∑r£_madt_œpic_íåõs
();

1218 i‡(!
îr‹
) {

1219 
a˝i_œpic
 = 1;

1224 
îr‹
 = 
	`a˝i_∑r£_madt_iﬂpic_íåõs
();

1225 i‡(!
îr‹
) {

1226 
a˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1227 
a˝i_iﬂpic
 = 1;

1229 
smp_found_c⁄fig
 = 1;

1232 i‡(
îr‹
 =-
EINVAL
) {

1236 
	`¥ötk
(
KERN_ERR
 
PREFIX


1238 
	`dißbÀ_a˝i
();

1246 i‡(
smp_found_c⁄fig
) {

1247 
	`¥ötk
(
KERN_WARNING
 
PREFIX


1249 
smp_found_c⁄fig
 = 0;

1257 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

1258 
	`¥ötk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1260 i‡(
a˝i_œpic
)

1261 
	`¥ötk
(
KERN_INFO
 "Using ACPI forÖrocessor (LAPIC) "

1265 
	}
}

1267 
__öô
 
	$dißbÀ_a˝i_úq
(c⁄° 
dmi_sy°em_id
 *
d
)

1269 i‡(!
a˝i_f‹˚
) {

1270 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=noirq\n",

1271 
d
->
idít
);

1272 
	`a˝i_noúq_£t
();

1275 
	}
}

1277 
__öô
 
	$dißbÀ_a˝i_pci
(c⁄° 
dmi_sy°em_id
 *
d
)

1279 i‡(!
a˝i_f‹˚
) {

1280 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofÖci=noacpi\n",

1281 
d
->
idít
);

1282 
	`a˝i_dißbÀ_pci
();

1285 
	}
}

1287 
__öô
 
	$dmi_dißbÀ_a˝i
(c⁄° 
dmi_sy°em_id
 *
d
)

1289 i‡(!
a˝i_f‹˚
) {

1290 
	`¥ötk
(
KERN_NOTICE
 "%†dëe˘ed:á˝òoff\n", 
d
->
idít
);

1291 
	`dißbÀ_a˝i
();

1293 
	`¥ötk
(
KERN_NOTICE


1297 
	}
}

1302 
__öô
 
	$dmi_ign‹e_úq0_timî_ovîride
(c⁄° 
dmi_sy°em_id
 *
d
)

1308 i‡(!
a˝i_skù_timî_ovîride
) {

1309 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirkÇot complete.\n");

1310 
	`¥_nŸi˚
("%s detected: Ignoring BIOS IRQ0Öin2 override\n",

1311 
d
->
idít
);

1312 
a˝i_skù_timî_ovîride
 = 1;

1315 
	}
}

1321 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ
[] = {

1326 .
ˇŒback
 = 
dmi_dißbÀ_a˝i
,

1327 .
	gidít
 = "IBM Thinkpad",

1328 .
	gm©ches
 = {

1329 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1330 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1338 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1339 .
	gidít
 = "ASUS A7V",

1340 .
	gm©ches
 = {

1341 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1342 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1344 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1355 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1356 .
	gidít
 = "IBM Thinkpad 600 Series 2645",

1357 .
	gm©ches
 = {

1358 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1359 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1363 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1364 .
	gidít
 = "IBM Thinkpad 600 Series 2646",

1365 .
	gm©ches
 = {

1366 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1367 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1374 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1375 .
	gidít
 = "ASUS PR-DLS",

1376 .
	gm©ches
 = {

1377 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1378 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1379 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1381 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1385 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1386 .
	gidít
 = "Acer TravelMate 36x Laptop",

1387 .
	gm©ches
 = {

1388 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1389 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1396 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ_œã
[] = {

1408 .
ˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1409 .
	gidít
 = "HPÇx6115Üaptop",

1410 .
	gm©ches
 = {

1411 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1412 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6115"),

1416 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1417 .
	gidít
 = "HP NX6125Üaptop",

1418 .
	gm©ches
 = {

1419 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1420 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6125"),

1424 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1425 .
	gidít
 = "HP NX6325Üaptop",

1426 .
	gm©ches
 = {

1427 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1428 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6325"),

1432 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1433 .
	gidít
 = "HP 6715bÜaptop",

1434 .
	gm©ches
 = {

1435 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1436 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1461 
__öô
 
	$a˝i_boŸ_èbÀ_öô
()

1463 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ
);

1469 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1475 i‡(
	`a˝i_èbÀ_öô
()) {

1476 
	`dißbÀ_a˝i
();

1480 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1485 i‡(
	`a˝i_bœckli°ed
()) {

1486 i‡(
a˝i_f‹˚
) {

1487 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1489 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1490 
	`dißbÀ_a˝i
();

1494 
	}
}

1496 
__öô
 
	$óæy_a˝i_boŸ_öô
()

1502 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1508 
	`óæy_a˝i_¥o˚ss_madt
();

1511 
	}
}

1513 
__öô
 
	$a˝i_boŸ_öô
()

1516 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ_œã
);

1522 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1525 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1530 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_FADT
, 
a˝i_∑r£_Ádt
);

1535 
	`a˝i_¥o˚ss_madt
();

1537 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
a˝i_∑r£_h≥t
);

1539 i‡(!
a˝i_noúq
)

1540 
x86_öô
.
pci
.
öô
 = 
pci_a˝i_öô
;

1543 
	}
}

1545 
__öô
 
	$∑r£_a˝i
(*
¨g
)

1547 i‡(!
¨g
)

1548  -
EINVAL
;

1551 i‡(
	`°rcmp
(
¨g
, "off") == 0) {

1552 
	`dißbÀ_a˝i
();

1555 i‡(
	`°rcmp
(
¨g
, "force") == 0) {

1556 
a˝i_f‹˚
 = 1;

1557 
a˝i_ht
 = 1;

1558 
a˝i_dißbÀd
 = 0;

1561 i‡(
	`°rcmp
(
¨g
, "strict") == 0) {

1562 
a˝i_°ri˘
 = 1;

1565 i‡(
	`°rcmp
(
¨g
, "ht") == 0) {

1566 i‡(!
a˝i_f‹˚
) {

1567 
	`¥ötk
(
KERN_WARNING
 "acpi=ht will beÑemoved in Linux-2.6.35\n");

1568 
	`dißbÀ_a˝i
();

1570 
a˝i_ht
 = 1;

1573 i‡(
	`°rcmp
(
¨g
, "rsdt") == 0) {

1574 
a˝i_rsdt_f‹˚d
 = 1;

1577 i‡(
	`°rcmp
(
¨g
, "noirq") == 0) {

1578 
	`a˝i_noúq_£t
();

1581  -
EINVAL
;

1584 
	}
}

1585 
óæy_∑øm
("a˝i", 
∑r£_a˝i
);

1588 
__öô
 
	$∑r£_pci
(*
¨g
)

1590 i‡(
¨g
 && 
	`°rcmp
(arg, "noacpi") == 0)

1591 
	`a˝i_dißbÀ_pci
();

1593 
	}
}

1594 
óæy_∑øm
("pci", 
∑r£_pci
);

1596 
__öô
 
	$a˝i_mps_check
()

1598 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& !deföed(
CONFIG_X86_MPPARSE
)

1600 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1601 
	`¥ötk
(
KERN_WARNING
 "MPS support code isÇot built-in.\n"

1608 
	}
}

1610 #ifde‡
CONFIG_X86_IO_APIC


1611 
__öô
 
	$∑r£_a˝i_skù_timî_ovîride
(*
¨g
)

1613 
a˝i_skù_timî_ovîride
 = 1;

1615 
	}
}

1616 
óæy_∑øm
("a˝i_skù_timî_ovîride", 
∑r£_a˝i_skù_timî_ovîride
);

1618 
__öô
 
	$∑r£_a˝i_u£_timî_ovîride
(*
¨g
)

1620 
a˝i_u£_timî_ovîride
 = 1;

1622 
	}
}

1623 
óæy_∑øm
("a˝i_u£_timî_ovîride", 
∑r£_a˝i_u£_timî_ovîride
);

1626 
__öô
 
	$£tup_a˝i_sci
(*
s
)

1628 i‡(!
s
)

1629  -
EINVAL
;

1630 i‡(!
	`°rcmp
(
s
, "edge"))

1631 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1632 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1633 i‡(!
	`°rcmp
(
s
, "level"))

1634 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1635 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1636 i‡(!
	`°rcmp
(
s
, "high"))

1637 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1638 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1639 i‡(!
	`°rcmp
(
s
, "low"))

1640 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1641 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1643  -
EINVAL
;

1645 
	}
}

1646 
óæy_∑øm
("a˝i_sci", 
£tup_a˝i_sci
);

1648 
	$__a˝i_acquúe_globÆ_lock
(*
lock
)

1650 
ﬁd
, 
√w
, 
vÆ
;

1652 
ﬁd
 = *
lock
;

1653 
√w
 = (((
ﬁd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1654 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1655 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1656  (
√w
 < 3) ? -1 : 0;

1657 
	}
}

1659 
	$__a˝i_ªÀa£_globÆ_lock
(*
lock
)

1661 
ﬁd
, 
√w
, 
vÆ
;

1663 
ﬁd
 = *
lock
;

1664 
√w
 = 
ﬁd
 & ~0x3;

1665 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1666 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1667  
ﬁd
 & 0x1;

1668 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/sched.h
>

14 
	~<a˝i/¥o˚ss‹.h
>

15 
	~<asm/a˝i.h
>

27 
	$a˝i_¥o˚ss‹_powî_öô_bm_check
(
a˝i_¥o˚ss‹_Êags
 *
Êags
,

28 
˝u
)

30 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

32 
Êags
->
bm_check
 = 0;

33 i‡(
	`num_⁄löe_˝us
() == 1)

34 
Êags
->
bm_check
 = 1;

35 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

41 
Êags
->
bm_check
 = 1;

50 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

51 (
c
->
x86
 > 0x‡|| (c->x86 =6 && c->
x86_modñ
 >= 0x0f)))

52 
Êags
->
bm_c⁄åﬁ
 = 0;

53 
	}
}

54 
EXPORT_SYMBOL
(
a˝i_¥o˚ss‹_powî_öô_bm_check
);

58 
	sc°©e_íåy
 {

60 
	móx
;

61 
	mecx
;

62 } 
	m°©es
[
ACPI_PROCESSOR_MAX_POWER
];

64 
c°©e_íåy
 *
	g˝u_c°©e_íåy
;

66 
	gmwaô_suµ‹ãd
[
ACPI_PROCESSOR_MAX_POWER
];

68 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

69 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

70 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

72 
	#CPUID_MWAIT_LEAF
 (5)

	)

73 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

74 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

76 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

78 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

80 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
(*
_cx
)

82 
a˝i_¥o˚ss‹_cx
 *
cx
 = 
_cx
;

83 
ªtvÆ
;

84 
óx
, 
ebx
, 
ecx
, 
edx
;

85 
edx_∑π
;

86 
c°©e_ty≥
;

87 
num_c°©e_subty≥
;

89 
	`˝uid
(
CPUID_MWAIT_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
c°©e_ty≥
 = ((
cx
->
addªss
 >> 
MWAIT_SUBSTATE_SIZE
) &

93 
MWAIT_CSTATE_MASK
) + 1;

94 
edx_∑π
 = 
edx
 >> (
c°©e_ty≥
 * 
MWAIT_SUBSTATE_SIZE
);

95 
num_c°©e_subty≥
 = 
edx_∑π
 & 
MWAIT_SUBSTATE_MASK
;

97 
ªtvÆ
 = 0;

98 i‡(
num_c°©e_subty≥
 < (
cx
->
addªss
 & 
MWAIT_SUBSTATE_MASK
)) {

99 
ªtvÆ
 = -1;

100 
out
;

104 i‡(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

105 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

106 
ªtvÆ
 = -1;

107 
out
;

110 i‡(!
mwaô_suµ‹ãd
[
c°©e_ty≥
]) {

111 
mwaô_suµ‹ãd
[
c°©e_ty≥
] = 1;

112 
	`¥ötk
(
KERN_DEBUG


114 "°©e\n", 
cx
->
ty≥
);

116 
	`¢¥ötf
(
cx
->
desc
,

117 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

118 
cx
->
addªss
);

119 
out
:

120  
ªtvÆ
;

121 
	}
}

123 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe
(
˝u
,

124 
a˝i_¥o˚ss‹_cx
 *
cx
, 
a˝i_powî_ªgi°î
 *
ªg
)

126 
c°©e_íåy
 *
≥r˝u_íåy
;

127 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

128 
ªtvÆ
;

130 i‡(!
˝u_c°©e_íåy
 || 
c
->
˝uid_Àvñ
 < 
CPUID_MWAIT_LEAF
)

133 i‡(
ªg
->
bô_off£t
 !
NATIVE_CSTATE_BEYOND_HALT
)

136 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

137 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = 0;

138 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 0;

142 
ªtvÆ
 = 
	`w‹k_⁄_˝u
(
˝u
, 
a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
, 
cx
);

143 i‡(
ªtvÆ
 == 0) {

145 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = cx->
addªss
;

146 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

148  
ªtvÆ
;

149 
	}
}

150 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_¥obe
);

152 
	$a˝i_¥o˚ss‹_ffh_c°©e_íãr
(
a˝i_¥o˚ss‹_cx
 *
cx
)

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
c°©e_íåy
 *
≥r˝u_íåy
;

157 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

158 
	`mwaô_idÀ_wôh_höts
(
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
,

159 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
);

160 
	}
}

161 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_íãr
);

163 
__öô
 
	$ffh_c°©e_öô
()

165 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

166 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
)

169 
˝u_c°©e_íåy
 = 
	`Æloc_≥r˝u
(
c°©e_íåy
);

171 
	}
}

173 
__exô
 
	$ffh_c°©e_exô
()

175 
	`‰ì_≥r˝u
(
˝u_c°©e_íåy
);

176 
˝u_c°©e_íåy
 = 
NULL
;

177 
	}
}

179 
¨ch_öôˇŒ
(
ffh_c°©e_öô
);

180 
__exôˇŒ
(
ffh_c°©e_exô
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c

1 
	~"../../../boŸ/ªgs.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boŸ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boŸ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boŸ/video-veß.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boŸ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boŸ.h
"

4 
	$udñay
(
lo›s
)

6 
lo›s
--)

7 
	`io_dñay
();

8 
	}
}

10 
	$bìp
(
hz
)

12 
u8
 
íabÀ
;

14 i‡(!
hz
) {

15 
íabÀ
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_dñay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_dñay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_dñay
();

26 
íabÀ
 = 0x03;

28 
	`öb
(0x61);

29 
	`io_dñay
();

30 
	`outb
(
íabÀ
, 0x61);

31 
	`io_dñay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_m‹£
(c⁄° *
∑âîn
)

41 
s
;

43 (
s
 = *
∑âîn
++)) {

44 
s
) {

46 
	`bìp
(
DOT_HZ
);

47 
	`udñay
(
US_PER_DOT
);

48 
	`bìp
(0);

49 
	`udñay
(
US_PER_DOT
);

52 
	`bìp
(
DASH_HZ
);

53 
	`udñay
(
US_PER_DOT
 * 3);

54 
	`bìp
(0);

55 
	`udñay
(
US_PER_DOT
);

58 
	`udñay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maö
()

67 i‡(
wakeup_hódî
.
ªÆ_magic
 != 0x12345678)

70 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 4)

71 
	`£nd_m‹£
("...-");

73 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 2) {

78 
	`¥obe_ˇrds
(0);

79 
	`£t_mode
(
wakeup_hódî
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<löux/a˝i.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/dmi.h
>

11 
	~<löux/˝umask.h
>

12 
	~<asm/£gmít.h
>

13 
	~<asm/desc.h
>

15 
	~"ªÆmode/wakeup.h
"

16 
	~"¶ìp.h
"

18 
	ga˝i_wakeup_addªss
;

19 
	ga˝i_ªÆmode_Êags
;

22 
	ga˝i_ªÆmode
;

24 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_64BIT
)

25 
	gãmp_°ack
[4096];

36 
	$a˝i_ßve_°©e_mem
()

38 
wakeup_hódî
 *
hódî
;

40 i‡(!
a˝i_ªÆmode
) {

41 
	`¥ötk
(
KERN_ERR
 "CouldÇotállocate memory during boot, "

43  -
ENOMEM
;

45 
	`mem˝y
((*)
a˝i_ªÆmode
, &
wakeup_code_°¨t
, 
WAKEUP_SIZE
);

47 
hódî
 = (
wakeup_hódî
 *)(
a˝i_ªÆmode
 + 
HEADER_OFFSET
);

48 i‡(
hódî
->
sig«tuª
 != 0x51ee1111) {

49 
	`¥ötk
(
KERN_ERR
 "wakeup header doesÇot match\n");

50  -
EINVAL
;

53 
hódî
->
video_mode
 = 
ßved_video_mode
;

55 
hódî
->
wakeup_jmp_£g
 = 
a˝i_wakeup_addªss
 >> 4;

66 
hódî
->
wakeup_gdt
[0] =

67 (
u64
)((
hódî
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
a˝i_wakeup_addªss
 +

69 ((*)&
hódî
->
wakeup_gdt
 - (*)
a˝i_ªÆmode
))

72 
hódî
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
a˝i_wakeup_addªss
, 0xfffff);

75 
hódî
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
a˝i_wakeup_addªss
, 0xfffff);

78 #i‚de‡
CONFIG_64BIT


79 
	`°‹e_gdt
((
desc_±r
 *)&
hódî
->
pmode_gdt
);

81 i‡(
	`rdm§_ß„
(
MSR_EFER
, &
hódî
->
pmode_e„r_low
,

82 &
hódî
->
pmode_e„r_high
))

83 
hódî
->
pmode_e„r_low
 = hódî->
pmode_e„r_high
 = 0;

86 
hódî
->
pmode_¸0
 = 
	`ªad_¸0
();

87 
hódî
->
pmode_¸4
 = 
	`ªad_¸4_ß„
();

88 
hódî
->
ªÆmode_Êags
 = 
a˝i_ªÆmode_Êags
;

89 
hódî
->
ªÆ_magic
 = 0x12345678;

91 #i‚de‡
CONFIG_64BIT


92 
hódî
->
pmode_íåy
 = (
u32
)&
wakeup_pmode_ªtu∫
;

93 
hódî
->
pmode_¸3
 = (
u32
)(
swsu•_pg_dú
 - 
__PAGE_OFFSET
);

94 
ßved_magic
 = 0x12345678;

96 
hódî
->
åampﬁöe_£gmít
 = 
	`£tup_åampﬁöe
() >> 4;

97 #ifde‡
CONFIG_SMP


98 
°ack_°¨t
.
•
 = 
ãmp_°ack
 + (temp_stack);

99 
óæy_gdt_des¸
.
addªss
 =

100 ()
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

101 
öôül_gs
 = 
	`≥r_˝u_off£t
(
	`smp_¥o˚ss‹_id
());

103 
öôül_code
 = ()
wakeup_l⁄g64
;

104 
ßved_magic
 = 0x123456789abcdef0L;

108 
	}
}

113 
	$a˝i_ª°‹e_°©e_mem
()

115 
	}
}

126 
__öô
 
	$a˝i_ª£rve_wakeup_mem‹y
()

128 
mem
;

130 i‡((&
wakeup_code_íd
 - &
wakeup_code_°¨t
Ë> 
WAKEUP_SIZE
) {

131 
	`¥ötk
(
KERN_ERR


136 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
WAKEUP_SIZE
, 
PAGE_SIZE
);

138 i‡(
mem
 == -1L) {

139 
	`¥ötk
(
KERN_ERR
 "ACPI: CannotállocateÜowmem, S3 disabled.\n");

142 
a˝i_ªÆmode
 = (Ë
	`phys_to_vút
(
mem
);

143 
a˝i_wakeup_addªss
 = 
mem
;

144 
	`ª£rve_óæy
(
mem
, mem + 
WAKEUP_SIZE
, "ACPI WAKEUP");

145 
	}
}

148 
__öô
 
	$a˝i_¶ìp_£tup
(*
°r
)

150 (
°r
 !
NULL
) && (*str != '\0')) {

151 i‡(
	`°∫cmp
(
°r
, "s3_bios", 7) == 0)

152 
a˝i_ªÆmode_Êags
 |= 1;

153 i‡(
	`°∫cmp
(
°r
, "s3_mode", 7) == 0)

154 
a˝i_ªÆmode_Êags
 |= 2;

155 i‡(
	`°∫cmp
(
°r
, "s3_beep", 7) == 0)

156 
a˝i_ªÆmode_Êags
 |= 4;

157 #ifde‡
CONFIG_HIBERNATION


158 i‡(
	`°∫cmp
(
°r
, "s4_nohwsig", 10) == 0)

159 
	`a˝i_no_s4_hw_sig«tuª
();

160 i‡(
	`°∫cmp
(
°r
, "s4_nonvs", 8) == 0)

161 
	`a˝i_s4_no_nvs
();

163 i‡(
	`°∫cmp
(
°r
, "old_ordering", 12) == 0)

164 
	`a˝i_ﬁd_su•íd_‹dîög
();

165 i‡(
	`°∫cmp
(
°r
, "sci_force_enable", 16) == 0)

166 
	`a˝i_£t_sci_í_⁄_ªsume
();

167 
°r
 = 
	`°rchr
(str, ',');

168 i‡(
°r
 !
NULL
)

169 
°r
 +
	`°r•n
(str, ", \t");

172 
	}
}

174 
__£tup
("a˝i_¶ìp=", 
a˝i_¶ìp_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/muãx.h
>

4 
	~<löux/li°.h
>

5 
	~<löux/°rögify.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/mm.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~<löux/mem‹y.h
>

10 
	~<löux/°›_machöe.h
>

11 
	~<löux/¶ab.h
>

12 
	~<asm/Æã∫©ive.h
>

13 
	~<asm/£˘i⁄s.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/nmi.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/ˇcheÊush.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/io.h
>

21 
	~<asm/fixm≠.h
>

23 
	#MAX_PATCH_LEN
 (255-1)

	)

25 #ifde‡
CONFIG_HOTPLUG_CPU


26 
	gsmp_Æt_⁄˚
;

28 
__öô
 
	$boŸ⁄ly
(*
°r
)

30 
smp_Æt_⁄˚
 = 1;

32 
	}
}

33 
__£tup
("smp-Æt-boŸ", 
boŸ⁄ly
);

35 
	#smp_Æt_⁄˚
 1

	)

38 
__öôd©a_‹_moduÀ
 
	gdebug_Æã∫©ive
;

40 
__öô
 
	$debug_Æt
(*
°r
)

42 
debug_Æã∫©ive
 = 1;

44 
	}
}

45 
__£tup
("debug-Æã∫©ive", 
debug_Æt
);

47 
	gn‹ïœ˚_smp
;

49 
__öô
 
	$£tup_n‹ïœ˚_smp
(*
°r
)

51 
n‹ïœ˚_smp
 = 1;

53 
	}
}

54 
__£tup
("n‹ïœ˚-smp", 
£tup_n‹ïœ˚_smp
);

56 #ifde‡
CONFIG_PARAVIRT


57 
__öôd©a_‹_moduÀ
 
	gn‹ïœ˚_∑øvút
 = 0;

59 
__öô
 
	$£tup_n‹ïœ˚_∑øvút
(*
°r
)

61 
n‹ïœ˚_∑øvút
 = 1;

63 
	}
}

64 
__£tup
("n‹ïœ˚-∑øvút", 
£tup_n‹ïœ˚_∑øvút
);

67 
	#DPRINTK
(
fmt
, 
¨gs
...Ëi‡(
debug_Æã∫©ive
) \

68 
	`¥ötk
(
KERN_DEBUG
 
fmt
, 
¨gs
)

	)

70 #i‡
deföed
(
GENERIC_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

74 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nintelnops: "

75 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


76 
GENERIC_NOP7
 
GENERIC_NOP8


78 c⁄° 
öã ›s
[];

79 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


80 
	göãl_n›s
[
ASM_NOP_MAX
+1] = {

81 
NULL
,

82 
öã ›s
,

83 
öã ›s
 + 1,

84 
öã ›s
 + 1 + 2,

85 
öã ›s
 + 1 + 2 + 3,

86 
öã ›s
 + 1 + 2 + 3 + 4,

87 
öã ›s
 + 1 + 2 + 3 + 4 + 5,

88 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6,

89 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

93 #ifde‡
K8_NOP1


94 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk8nops: "

95 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


96 
K8_NOP7
 
K8_NOP8


98 c⁄° 
k8n›s
[];

99 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


100 
	gk8_n›s
[
ASM_NOP_MAX
+1] = {

101 
NULL
,

102 
k8n›s
,

103 
k8n›s
 + 1,

104 
k8n›s
 + 1 + 2,

105 
k8n›s
 + 1 + 2 + 3,

106 
k8n›s
 + 1 + 2 + 3 + 4,

107 
k8n›s
 + 1 + 2 + 3 + 4 + 5,

108 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

109 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

113 #i‡
deföed
(
K7_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

114 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk7nops: "

115 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


116 
K7_NOP7
 
K7_NOP8


118 c⁄° 
k7n›s
[];

119 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


120 
	gk7_n›s
[
ASM_NOP_MAX
+1] = {

121 
NULL
,

122 
k7n›s
,

123 
k7n›s
 + 1,

124 
k7n›s
 + 1 + 2,

125 
k7n›s
 + 1 + 2 + 3,

126 
k7n›s
 + 1 + 2 + 3 + 4,

127 
k7n›s
 + 1 + 2 + 3 + 4 + 5,

128 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

129 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

133 #ifde‡
P6_NOP1


134 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\np6nops: "

135 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


136 
P6_NOP7
 
P6_NOP8


138 c⁄° 
p6n›s
[];

139 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


140 
	gp6_n›s
[
ASM_NOP_MAX
+1] = {

141 
NULL
,

142 
p6n›s
,

143 
p6n›s
 + 1,

144 
p6n›s
 + 1 + 2,

145 
p6n›s
 + 1 + 2 + 3,

146 
p6n›s
 + 1 + 2 + 3 + 4,

147 
p6n›s
 + 1 + 2 + 3 + 4 + 5,

148 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

149 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

153 #ifde‡
CONFIG_X86_64


155 
__vsysˇŒ_0
;

156 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

158 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

159 
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

160  
p6_n›s
;

162  
k8_n›s
;

163 
	}
}

167 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

169 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K8
))

170  
k8_n›s
;

171 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K7
))

172  
k7_n›s
;

173 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

174  
p6_n›s
;

176  
öãl_n›s
;

177 
	}
}

182 
__öô_‹_moduÀ
 
	$add_n›s
(*
ö¢s
, 
Àn
)

184 c⁄° *c⁄° *
n›èbÀ
 = 
	`föd_n›_èbÀ
();

186 
Àn
 > 0) {

187 
n›Àn
 = 
Àn
;

188 i‡(
n›Àn
 > 
ASM_NOP_MAX
)

189 
n›Àn
 = 
ASM_NOP_MAX
;

190 
	`mem˝y
(
ö¢s
, 
n›èbÀ
[
n›Àn
],Çoplen);

191 
ö¢s
 +
n›Àn
;

192 
Àn
 -
n›Àn
;

194 
	}
}

196 
Æt_ö°r
 
__Æt_ö°ru˘i⁄s
[], 
__Æt_ö°ru˘i⁄s_íd
[];

197 
u8
 *
__smp_locks
[], *
__smp_locks_íd
[];

198 *
ãxt_poke_óæy
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
);

206 
__öô_‹_moduÀ
 
	$≠∂y_Æã∫©ives
(
Æt_ö°r
 *
°¨t
,

207 
Æt_ö°r
 *
íd
)

209 
Æt_ö°r
 *
a
;

210 
u8
 
ö¢buf
[
MAX_PATCH_LEN
];

212 
	`DPRINTK
("%s:á…ÅabÀ %∞-> %p\n", 
__func__
, 
°¨t
, 
íd
);

213 
a
 = 
°¨t
;á < 
íd
;á++) {

214 
u8
 *
ö°r
 = 
a
->instr;

215 
	`BUG_ON
(
a
->
ª∂a˚míéí
 >á->
ö°æí
);

216 
	`BUG_ON
(
a
->
ö°æí
 > (
ö¢buf
));

217 i‡(!
	`boŸ_˝u_has
(
a
->
˝uid
))

219 #ifde‡
CONFIG_X86_64


221 i‡(
ö°r
 >(
u8
 *)
VSYSCALL_START
 && in°∏< (u8*)
VSYSCALL_END
) {

222 
ö°r
 = 
	`__va
(ö°∏- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__∑_symbﬁ
(&
__vsysˇŒ_0
));

223 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

224 
__func__
, 
a
->
ö°r
, instr);

227 
	`mem˝y
(
ö¢buf
, 
a
->
ª∂a˚mít
,á->
ª∂a˚míéí
);

228 i‡(*
ö¢buf
 =0xe8 && 
a
->
ª∂a˚míéí
 == 5)

229 *(
s32
 *)(
ö¢buf
 + 1Ë+
a
->
ª∂a˚mít
 -á->
ö°r
;

230 
	`add_n›s
(
ö¢buf
 + 
a
->
ª∂a˚míéí
,

231 
a
->
ö°æí
 -á->
ª∂a˚míéí
);

232 
	`ãxt_poke_óæy
(
ö°r
, 
ö¢buf
, 
a
->
ö°æí
);

234 
	}
}

236 #ifde‡
CONFIG_SMP


238 
	$Æã∫©ives_smp_lock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

240 
u8
 **
±r
;

242 
	`muãx_lock
(&
ãxt_muãx
);

243 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

244 i‡(*
±r
 < 
ãxt
)

246 i‡(*
±r
 > 
ãxt_íd
)

249 
	`ãxt_poke
(*
±r
, (([]){0xf0}), 1);

251 
	`muãx_u∆ock
(&
ãxt_muãx
);

252 
	}
}

254 
	$Æã∫©ives_smp_u∆ock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

256 
u8
 **
±r
;

258 i‡(
n‹ïœ˚_smp
)

261 
	`muãx_lock
(&
ãxt_muãx
);

262 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

263 i‡(*
±r
 < 
ãxt
)

265 i‡(*
±r
 > 
ãxt_íd
)

268 
	`ãxt_poke
(*
±r
, (([]){0x3E}), 1);

270 
	`muãx_u∆ock
(&
ãxt_muãx
);

271 
	}
}

273 
	ssmp_Æt_moduÀ
 {

275 
moduÀ
 *
	mmod
;

276 *
	m«me
;

279 
u8
 **
	mlocks
;

280 
u8
 **
	mlocks_íd
;

283 
u8
 *
	mãxt
;

284 
u8
 *
	mãxt_íd
;

286 
li°_hód
 
	m√xt
;

288 
LIST_HEAD
(
smp_Æt_moduÀs
);

289 
DEFINE_MUTEX
(
smp_Æt
);

290 
	gsmp_mode
 = 1;

292 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_add
(
moduÀ
 *
mod
,

293 *
«me
,

294 *
locks
, *
locks_íd
,

295 *
ãxt
, *
ãxt_íd
)

297 
smp_Æt_moduÀ
 *
smp
;

299 i‡(
n‹ïœ˚_smp
)

302 i‡(
smp_Æt_⁄˚
) {

303 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

304 
	`Æã∫©ives_smp_u∆ock
(
locks
, 
locks_íd
,

305 
ãxt
, 
ãxt_íd
);

309 
smp
 = 
	`kzÆloc
((*smp), 
GFP_KERNEL
);

310 i‡(
NULL
 =
smp
)

313 
smp
->
mod
 = mod;

314 
smp
->
«me
 =Çame;

315 
smp
->
locks
 =Üocks;

316 
smp
->
locks_íd
 =Üocks_end;

317 
smp
->
ãxt
 =Åext;

318 
smp
->
ãxt_íd
 =Åext_end;

319 
	`DPRINTK
("%s:Üocks %p -> %p,Åext %p -> %p,Çame %s\n",

320 
__func__
, 
smp
->
locks
, smp->
locks_íd
,

321 
smp
->
ãxt
, smp->
ãxt_íd
, smp->
«me
);

323 
	`muãx_lock
(&
smp_Æt
);

324 
	`li°_add_èû
(&
smp
->
√xt
, &
smp_Æt_moduÀs
);

325 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

326 
	`Æã∫©ives_smp_u∆ock
(
smp
->
locks
, smp->
locks_íd
,

327 
smp
->
ãxt
, smp->
ãxt_íd
);

328 
	`muãx_u∆ock
(&
smp_Æt
);

329 
	}
}

331 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_dñ
(
moduÀ
 *
mod
)

333 
smp_Æt_moduÀ
 *
ôem
;

335 i‡(
smp_Æt_⁄˚
 || 
n‹ïœ˚_smp
)

338 
	`muãx_lock
(&
smp_Æt
);

339 
	`li°_f‹_óch_íåy
(
ôem
, &
smp_Æt_moduÀs
, 
√xt
) {

340 i‡(
mod
 !
ôem
->mod)

342 
	`li°_dñ
(&
ôem
->
√xt
);

343 
	`muãx_u∆ock
(&
smp_Æt
);

344 
	`DPRINTK
("%s: %s\n", 
__func__
, 
ôem
->
«me
);

345 
	`k‰ì
(
ôem
);

348 
	`muãx_u∆ock
(&
smp_Æt
);

349 
	}
}

351 
	$Æã∫©ives_smp_swôch
(
smp
)

353 
smp_Æt_moduÀ
 *
mod
;

355 #ifde‡
CONFIG_LOCKDEP


363 
	`¥ötk
("lockdep: fixing upálternatives.\n");

366 i‡(
n‹ïœ˚_smp
 || 
smp_Æt_⁄˚
)

368 
	`BUG_ON
(!
smp
 && (
	`num_⁄löe_˝us
() > 1));

370 
	`muãx_lock
(&
smp_Æt
);

376 i‡(
smp
 =
smp_mode
) {

378 } i‡(
smp
) {

379 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo SMP code\n");

380 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

381 
	`˛ór_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

382 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

383 
	`Æã∫©ives_smp_lock
(
mod
->
locks
, mod->
locks_íd
,

384 
mod
->
ãxt
, mod->
ãxt_íd
);

386 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

387 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

388 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

389 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

390 
	`Æã∫©ives_smp_u∆ock
(
mod
->
locks
, mod->
locks_íd
,

391 
mod
->
ãxt
, mod->
ãxt_íd
);

393 
smp_mode
 = 
smp
;

394 
	`muãx_u∆ock
(&
smp_Æt
);

395 
	}
}

398 
	$Æã∫©ives_ãxt_ª£rved
(*
°¨t
, *
íd
)

400 
smp_Æt_moduÀ
 *
mod
;

401 
u8
 **
±r
;

402 
u8
 *
ãxt_°¨t
 = 
°¨t
;

403 
u8
 *
ãxt_íd
 = 
íd
;

405 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
) {

406 i‡(
mod
->
ãxt
 > 
ãxt_íd
 || mod->ãxt_íd < 
ãxt_°¨t
)

408 
±r
 = 
mod
->
locks
;Öå < mod->
locks_íd
;Ötr++)

409 i‡(
ãxt_°¨t
 <*
±r
 && 
ãxt_íd
 >= *ptr)

414 
	}
}

417 #ifde‡
CONFIG_PARAVIRT


418 
__öô_‹_moduÀ
 
	$≠∂y_∑øvút
(
∑øvút_∑tch_sôe
 *
°¨t
,

419 
∑øvút_∑tch_sôe
 *
íd
)

421 
∑øvút_∑tch_sôe
 *
p
;

422 
ö¢buf
[
MAX_PATCH_LEN
];

424 i‡(
n‹ïœ˚_∑øvút
)

427 
p
 = 
°¨t
;Ö < 
íd
;Ö++) {

428 
u£d
;

430 
	`BUG_ON
(
p
->
Àn
 > 
MAX_PATCH_LEN
);

432 
	`mem˝y
(
ö¢buf
, 
p
->
ö°r
,Ö->
Àn
);

433 
u£d
 = 
pv_öô_›s
.
	`∑tch
(
p
->
ö°πy≥
,Ö->
˛obbîs
, 
ö¢buf
,

434 ()
p
->
ö°r
,Ö->
Àn
);

436 
	`BUG_ON
(
u£d
 > 
p
->
Àn
);

439 
	`add_n›s
(
ö¢buf
 + 
u£d
, 
p
->
Àn
 - used);

440 
	`ãxt_poke_óæy
(
p
->
ö°r
, 
ö¢buf
,Ö->
Àn
);

442 
	}
}

443 
∑øvút_∑tch_sôe
 
__°¨t_∑øö°ru˘i⁄s
[],

444 
__°›_∑øö°ru˘i⁄s
[];

447 
__öô
 
	$Æã∫©ive_ö°ru˘i⁄s
()

452 
	`°›_nmi
();

465 
	`≠∂y_Æã∫©ives
(
__Æt_ö°ru˘i⁄s
, 
__Æt_ö°ru˘i⁄s_íd
);

470 #ifde‡
CONFIG_HOTPLUG_CPU


471 i‡(
	`num_possibÀ_˝us
() < 2)

472 
smp_Æt_⁄˚
 = 1;

475 #ifde‡
CONFIG_SMP


476 i‡(
smp_Æt_⁄˚
) {

477 i‡(1 =
	`num_possibÀ_˝us
()) {

478 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

479 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

480 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

482 
	`Æã∫©ives_smp_u∆ock
(
__smp_locks
, 
__smp_locks_íd
,

483 
_ãxt
, 
_ëext
);

486 
	`Æã∫©ives_smp_moduÀ_add
(
NULL
, "core kernel",

487 
__smp_locks
, 
__smp_locks_íd
,

488 
_ãxt
, 
_ëext
);

491 i‡(
	`num_¥e£¡_˝us
(Ë=1 || 
£tup_max_˝us
 <= 1)

492 
	`Æã∫©ives_smp_swôch
(0);

495 
	`≠∂y_∑øvút
(
__∑øö°ru˘i⁄s
, 
__∑øö°ru˘i⁄s_íd
);

497 i‡(
smp_Æt_⁄˚
)

498 
	`‰ì_öô_∑ges
("SMPálternatives",

499 ()
__smp_locks
,

500 ()
__smp_locks_íd
);

502 
	`ª°¨t_nmi
();

503 
	}
}

517 *
__öô_‹_moduÀ
 
	$ãxt_poke_óæy
(*
addr
, c⁄° *
›code
,

518 
size_t
 
Àn
)

520 
Êags
;

521 
	`loˇl_úq_ßve
(
Êags
);

522 
	`mem˝y
(
addr
, 
›code
, 
Àn
);

523 
	`sync_c‹e
();

524 
	`loˇl_úq_ª°‹e
(
Êags
);

527  
addr
;

528 
	}
}

543 *
__k¥obes
 
	$ãxt_poke
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

545 
Êags
;

546 *
vaddr
;

547 
∑ge
 *
∑ges
[2];

548 
i
;

550 i‡(!
	`c‹e_kî√l_ãxt
(()
addr
)) {

551 
∑ges
[0] = 
	`vmÆloc_to_∑ge
(
addr
);

552 
∑ges
[1] = 
	`vmÆloc_to_∑ge
(
addr
 + 
PAGE_SIZE
);

554 
∑ges
[0] = 
	`vút_to_∑ge
(
addr
);

555 
	`WARN_ON
(!
	`PageRe£rved
(
∑ges
[0]));

556 
∑ges
[1] = 
	`vút_to_∑ge
(
addr
 + 
PAGE_SIZE
);

558 
	`BUG_ON
(!
∑ges
[0]);

559 
	`loˇl_úq_ßve
(
Êags
);

560 
	`£t_fixm≠
(
FIX_TEXT_POKE0
, 
	`∑ge_to_phys
(
∑ges
[0]));

561 i‡(
∑ges
[1])

562 
	`£t_fixm≠
(
FIX_TEXT_POKE1
, 
	`∑ge_to_phys
(
∑ges
[1]));

563 
vaddr
 = (*)
	`fix_to_vút
(
FIX_TEXT_POKE0
);

564 
	`mem˝y
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
›code
, 
Àn
);

565 
	`˛ór_fixm≠
(
FIX_TEXT_POKE0
);

566 i‡(
∑ges
[1])

567 
	`˛ór_fixm≠
(
FIX_TEXT_POKE1
);

568 
	`loˇl_Êush_éb
();

569 
	`sync_c‹e
();

572 
i
 = 0; i < 
Àn
; i++)

573 
	`BUG_ON
(((*)
addr
)[
i
] !((*)
›code
)[i]);

574 
	`loˇl_úq_ª°‹e
(
Êags
);

575  
addr
;

576 
	}
}

582 
©omic_t
 
	g°›_machöe_fú°
;

583 
	gwrŸe_ãxt
;

585 
	sãxt_poke_∑øms
 {

586 *
	maddr
;

587 c⁄° *
	m›code
;

588 
size_t
 
	mÀn
;

591 
__k¥obes
 
	$°›_machöe_ãxt_poke
(*
d©a
)

593 
ãxt_poke_∑øms
 *
çp
 = 
d©a
;

595 i‡(
	`©omic_dec_™d_ã°
(&
°›_machöe_fú°
)) {

596 
	`ãxt_poke
(
çp
->
addr
,Åµ->
›code
,Åµ->
Àn
);

597 
	`smp_wmb
();

598 
wrŸe_ãxt
 = 1;

600 !
wrŸe_ãxt
)

601 
	`˝u_ªœx
();

602 
	`smp_mb
();

605 
	`Êush_iˇche_ønge
(()
çp
->
addr
,

606 ()
çp
->
addr
 +Åµ->
Àn
);

608 
	}
}

623 *
__k¥obes
 
	$ãxt_poke_smp
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

625 
ãxt_poke_∑øms
 
çp
;

627 
çp
.
addr
 =áddr;

628 
çp
.
›code
 = opcode;

629 
çp
.
Àn
 =Üen;

630 
	`©omic_£t
(&
°›_machöe_fú°
, 1);

631 
wrŸe_ãxt
 = 0;

632 
	`°›_machöe
(
°›_machöe_ãxt_poke
, (*)&
çp
, 
NULL
);

633  
addr
;

634 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<löux/pci.h
>

21 
	~<löux/bôm≠.h
>

22 
	~<löux/¶ab.h
>

23 
	~<löux/debugfs.h
>

24 
	~<löux/sˇâîli°.h
>

25 
	~<löux/dma-m≠pög.h
>

26 
	~<löux/iommu-hñ≥r.h
>

27 
	~<löux/iommu.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¨t.h
>

31 
	~<asm/amd_iommu_¥Ÿo.h
>

32 
	~<asm/amd_iommu_ty≥s.h
>

33 
	~<asm/amd_iommu.h
>

35 
	#CMD_SET_TYPE
(
cmd
, 
t
Ë((cmd)->
d©a
[1] |(—Ë<< 28))

	)

37 
	#EXIT_LOOP_COUNT
 10000000

	)

39 
DEFINE_RWLOCK
(
amd_iommu_devèbÀ_lock
);

42 
LIST_HEAD
(
iommu_pd_li°
);

43 
DEFINE_SPINLOCK
(
iommu_pd_li°_lock
);

49 
¥Ÿe˘i⁄_domaö
 *
	g±_domaö
;

51 
iommu_›s
 
	gamd_iommu_›s
;

56 
	siommu_cmd
 {

57 
u32
 
	md©a
[4];

60 
ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
);

61 
upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
);

69 
ölöe
 
u16
 
	$gë_devi˚_id
(
devi˚
 *
dev
)

71 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

73  
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

74 
	}
}

76 
iommu_dev_d©a
 *
	$gë_dev_d©a
(
devi˚
 *
dev
)

78  
dev
->
¨chd©a
.
iommu
;

79 
	}
}

85 
dma_›s_domaö
 *
	$föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
)

87 
dma_›s_domaö
 *
íåy
, *
ªt
 = 
NULL
;

88 
Êags
;

89 
u16
 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

91 i‡(
	`li°_em±y
(&
iommu_pd_li°
))

92  
NULL
;

94 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

96 
	`li°_f‹_óch_íåy
(
íåy
, &
iommu_pd_li°
, 
li°
) {

97 i‡(
íåy
->
èrgë_dev
 =
devid
 ||

98 
íåy
->
èrgë_dev
 =
Æüs
) {

99 
ªt
 = 
íåy
;

104 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

106  
ªt
;

107 
	}
}

113 
boﬁ
 
	$check_devi˚
(
devi˚
 *
dev
)

115 
u16
 
devid
;

117 i‡(!
dev
 || !dev->
dma_mask
)

118  
Ál£
;

121 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

122  
Ál£
;

124 
devid
 = 
	`gë_devi˚_id
(
dev
);

127 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

128  
Ál£
;

130 i‡(
amd_iommu_æookup_èbÀ
[
devid
] =
NULL
)

131  
Ál£
;

133  
åue
;

134 
	}
}

136 
	$iommu_öô_devi˚
(
devi˚
 *
dev
)

138 
iommu_dev_d©a
 *
dev_d©a
;

139 
pci_dev
 *
pdev
;

140 
u16
 
devid
, 
Æüs
;

142 i‡(
dev
->
¨chd©a
.
iommu
)

145 
dev_d©a
 = 
	`kzÆloc
((*dev_d©a), 
GFP_KERNEL
);

146 i‡(!
dev_d©a
)

147  -
ENOMEM
;

149 
dev_d©a
->
dev
 = dev;

151 
devid
 = 
	`gë_devi˚_id
(
dev
);

152 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

153 
pdev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
Æüs
),álias & 0xff);

154 i‡(
pdev
)

155 
dev_d©a
->
Æüs
 = &
pdev
->
dev
;

157 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

159 
dev
->
¨chd©a
.
iommu
 = 
dev_d©a
;

163 
	}
}

165 
	$iommu_unöô_devi˚
(
devi˚
 *
dev
)

167 
	`k‰ì
(
dev
->
¨chd©a
.
iommu
);

168 
	}
}

170 
__öô
 
	$amd_iommu_unöô_devi˚s
()

172 
pci_dev
 *
pdev
 = 
NULL
;

174 
	`f‹_óch_pci_dev
(
pdev
) {

176 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

179 
	`iommu_unöô_devi˚
(&
pdev
->
dev
);

181 
	}
}

183 
__öô
 
	$amd_iommu_öô_devi˚s
()

185 
pci_dev
 *
pdev
 = 
NULL
;

186 
ªt
 = 0;

188 
	`f‹_óch_pci_dev
(
pdev
) {

190 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

193 
ªt
 = 
	`iommu_öô_devi˚
(&
pdev
->
dev
);

194 i‡(
ªt
)

195 
out_‰ì
;

200 
out_‰ì
:

202 
	`amd_iommu_unöô_devi˚s
();

204  
ªt
;

205 
	}
}

206 #ifde‡
CONFIG_AMD_IOMMU_STATS


212 
DECLARE_STATS_COUNTER
(
com∂_waô
);

213 
DECLARE_STATS_COUNTER
(
˙t_m≠_sögÀ
);

214 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

215 
DECLARE_STATS_COUNTER
(
˙t_m≠_sg
);

216 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sg
);

217 
DECLARE_STATS_COUNTER
(
˙t_Æloc_cohîít
);

218 
DECLARE_STATS_COUNTER
(
˙t_‰ì_cohîít
);

219 
DECLARE_STATS_COUNTER
(
¸oss_∑ge
);

220 
DECLARE_STATS_COUNTER
(
domaö_Êush_sögÀ
);

221 
DECLARE_STATS_COUNTER
(
domaö_Êush_Æl
);

222 
DECLARE_STATS_COUNTER
(
Ælo˚d_io_mem
);

223 
DECLARE_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

225 
díåy
 *
	g°©s_dú
;

226 
díåy
 *
	gde_fÊush
;

228 
	$amd_iommu_°©s_add
(
__iommu_cou¡î
 *
˙t
)

230 i‡(
°©s_dú
 =
NULL
)

233 
˙t
->
dít
 = 
	`debugfs_¸óã_u64
(˙t->
«me
, 0444, 
°©s_dú
,

234 &
˙t
->
vÆue
);

235 
	}
}

237 
	$amd_iommu_°©s_öô
()

239 
°©s_dú
 = 
	`debugfs_¸óã_dú
("amd-iommu", 
NULL
);

240 i‡(
°©s_dú
 =
NULL
)

243 
de_fÊush
 = 
	`debugfs_¸óã_boﬁ
("fuŒÊush", 0444, 
°©s_dú
,

244 (
u32
 *)&
amd_iommu_unm≠_Êush
);

246 
	`amd_iommu_°©s_add
(&
com∂_waô
);

247 
	`amd_iommu_°©s_add
(&
˙t_m≠_sögÀ
);

248 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sögÀ
);

249 
	`amd_iommu_°©s_add
(&
˙t_m≠_sg
);

250 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sg
);

251 
	`amd_iommu_°©s_add
(&
˙t_Æloc_cohîít
);

252 
	`amd_iommu_°©s_add
(&
˙t_‰ì_cohîít
);

253 
	`amd_iommu_°©s_add
(&
¸oss_∑ge
);

254 
	`amd_iommu_°©s_add
(&
domaö_Êush_sögÀ
);

255 
	`amd_iommu_°©s_add
(&
domaö_Êush_Æl
);

256 
	`amd_iommu_°©s_add
(&
Ælo˚d_io_mem
);

257 
	`amd_iommu_°©s_add
(&
tŸÆ_m≠_ªque°s
);

258 
	}
}

268 
	$dump_dã_íåy
(
u16
 
devid
)

270 
i
;

272 
i
 = 0; i < 8; ++i)

273 
	`¥_îr
("AMD-Vi: DTE[%d]: %08x\n", 
i
,

274 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
]);

275 
	}
}

277 
	$dump_comm™d
(
phys_addr
)

279 
iommu_cmd
 *
cmd
 = 
	`phys_to_vút
(
phys_addr
);

280 
i
;

282 
i
 = 0; i < 4; ++i)

283 
	`¥_îr
("AMD-Vi: CMD[%d]: %08x\n", 
i
, 
cmd
->
d©a
[i]);

284 
	}
}

286 
	$iommu_¥öt_evít
(
amd_iommu
 *
iommu
, *
__evt
)

288 
u32
 *
evít
 = 
__evt
;

289 
ty≥
 = (
evít
[1] >> 
EVENT_TYPE_SHIFT
Ë& 
EVENT_TYPE_MASK
;

290 
devid
 = (
evít
[0] >> 
EVENT_DEVID_SHIFT
Ë& 
EVENT_DEVID_MASK
;

291 
domid
 = (
evít
[1] >> 
EVENT_DOMID_SHIFT
Ë& 
EVENT_DOMID_MASK
;

292 
Êags
 = (
evít
[1] >> 
EVENT_FLAGS_SHIFT
Ë& 
EVENT_FLAGS_MASK
;

293 
u64
 
addªss
 = (u64)(((u64)
evít
[3]) << 32) |Évent[2];

295 
	`¥ötk
(
KERN_ERR
 "AMD-Vi: EventÜogged [");

297 
ty≥
) {

298 
EVENT_TYPE_ILL_DEV
:

299 
	`¥ötk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

301 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

302 
addªss
, 
Êags
);

303 
	`dump_dã_íåy
(
devid
);

305 
EVENT_TYPE_IO_FAULT
:

306 
	`¥ötk
("IO_PAGE_FAULT device=%02x:%02x.%x "

308 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

309 
domid
, 
addªss
, 
Êags
);

311 
EVENT_TYPE_DEV_TAB_ERR
:

312 
	`¥ötk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

314 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

315 
addªss
, 
Êags
);

317 
EVENT_TYPE_PAGE_TAB_ERR
:

318 
	`¥ötk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

320 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

321 
domid
, 
addªss
, 
Êags
);

323 
EVENT_TYPE_ILL_CMD
:

324 
	`¥ötk
("ILLEGAL_COMMAND_ERRORáddªss=0x%016Œx]\n", 
addªss
);

325 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

326 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

327 
	`dump_comm™d
(
addªss
);

329 
EVENT_TYPE_CMD_HARD_ERR
:

330 
	`¥ötk
("COMMAND_HARDWARE_ERRORáddress=0x%016llx "

331 "Êags=0x%04x]\n", 
addªss
, 
Êags
);

333 
EVENT_TYPE_IOTLB_INV_TO
:

334 
	`¥ötk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

336 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

337 
addªss
);

339 
EVENT_TYPE_INV_DEV_REQ
:

340 
	`¥ötk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

342 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

343 
addªss
, 
Êags
);

346 
	`¥ötk
(
KERN_ERR
 "UNKNOWNÅy≥=0x%02x]\n", 
ty≥
);

348 
	}
}

350 
	$iommu_pﬁl_evíts
(
amd_iommu
 *
iommu
)

352 
u32
 
hód
, 
èû
;

353 
Êags
;

355 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

357 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

358 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

360 
hód
 !
èû
) {

361 
	`iommu_¥öt_evít
(
iommu
, iommu->
evt_buf
 + 
hód
);

362 
hód
 = (hód + 
EVENT_ENTRY_SIZE
Ë% 
iommu
->
evt_buf_size
;

365 
	`wrôñ
(
hód
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

367 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

368 
	}
}

370 
úqªtu∫_t
 
	$amd_iommu_öt_h™dÀr
(
úq
, *
d©a
)

372 
amd_iommu
 *
iommu
;

374 
	`f‹_óch_iommu
(
iommu
)

375 
	`iommu_pﬁl_evíts
(
iommu
);

377  
IRQ_HANDLED
;

378 
	}
}

390 
	$__iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

392 
u32
 
èû
, 
hód
;

393 
u8
 *
èrgë
;

395 
	`WARN_ON
(
iommu
->
cmd_buf_size
 & 
CMD_BUFFER_UNINITIALIZED
);

396 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

397 
èrgë
 = 
iommu
->
cmd_buf
 + 
èû
;

398 
	`mem˝y_toio
(
èrgë
, 
cmd
, (*cmd));

399 
èû
 = (èû + (*
cmd
)Ë% 
iommu
->
cmd_buf_size
;

400 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

401 i‡(
èû
 =
hód
)

402  -
ENOMEM
;

403 
	`wrôñ
(
èû
, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

406 
	}
}

412 
	$iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

414 
Êags
;

415 
ªt
;

417 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

418 
ªt
 = 
	`__iommu_queue_comm™d
(
iommu
, 
cmd
);

419 i‡(!
ªt
)

420 
iommu
->
√ed_sync
 = 
åue
;

421 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

423  
ªt
;

424 
	}
}

430 
	$__iommu_waô_f‹_com∂ëi⁄
(
amd_iommu
 *
iommu
)

432 
ªady
 = 0;

433 
°©us
 = 0;

434 
i
 = 0;

436 
	`INC_STATS_COUNTER
(
com∂_waô
);

438 !
ªady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

439 ++
i
;

441 
°©us
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

442 
ªady
 = 
°©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

446 
°©us
 &~
MMIO_STATUS_COM_WAIT_INT_MASK
;

447 
	`wrôñ
(
°©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

449 i‡(
	`u∆ikñy
(
i
 =
EXIT_LOOP_COUNT
))

450 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

451 
	}
}

457 
	$__iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

459 
iommu_cmd
 
cmd
;

461 
	`mem£t
(&
cmd
, 0, (cmd));

462 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

463 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

465  
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

466 
	}
}

475 
	$iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

477 
ªt
 = 0;

478 
Êags
;

480 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

482 i‡(!
iommu
->
√ed_sync
)

483 
out
;

485 
ªt
 = 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

487 
iommu
->
√ed_sync
 = 
Ál£
;

489 i‡(
ªt
)

490 
out
;

492 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

494 
out
:

495 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

497 i‡(
iommu
->
ª£t_ö_¥ogªss
)

498 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

501 
	}
}

503 
	$iommu_Êush_com∂ëe
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

505 
i
;

507 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

508 i‡(!
domaö
->
dev_iommu
[
i
])

515 
	`iommu_com∂ëi⁄_waô
(
amd_iommus
[
i
]);

517 
	}
}

522 
	$iommu_Êush_devi˚
(
devi˚
 *
dev
)

524 
amd_iommu
 *
iommu
;

525 
iommu_cmd
 
cmd
;

526 
u16
 
devid
;

528 
devid
 = 
	`gë_devi˚_id
(
dev
);

529 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

532 
	`mem£t
(&
cmd
, 0, (cmd));

533 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

534 
cmd
.
d©a
[0] = 
devid
;

536  
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

537 
	}
}

539 
	$__iommu_buûd_öv_iommu_∑ges
(
iommu_cmd
 *
cmd
, 
u64
 
addªss
,

540 
u16
 
domid
, 
pde
, 
s
)

542 
	`mem£t
(
cmd
, 0, (*cmd));

543 
addªss
 &
PAGE_MASK
;

544 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

545 
cmd
->
d©a
[1] |
domid
;

546 
cmd
->
d©a
[2] = 
	`lowî_32_bôs
(
addªss
);

547 
cmd
->
d©a
[3] = 
	`uµî_32_bôs
(
addªss
);

548 i‡(
s
)

549 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

550 i‡(
pde
)

551 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_PDE_MASK
;

552 
	}
}

557 
	$iommu_queue_öv_iommu_∑ges
(
amd_iommu
 *
iommu
,

558 
u64
 
addªss
, 
u16
 
domid
, 
pde
, 
s
)

560 
iommu_cmd
 
cmd
;

561 
ªt
;

563 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
addªss
, 
domid
, 
pde
, 
s
);

565 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

567  
ªt
;

568 
	}
}

575 
	$__iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

576 
u64
 
addªss
, 
size_t
 
size
, 
pde
)

578 
s
 = 0, 
i
;

579 
∑ges
 = 
	`iommu_num_∑ges
(
addªss
, 
size
, 
PAGE_SIZE
);

581 
addªss
 &
PAGE_MASK
;

583 i‡(
∑ges
 > 1) {

588 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

589 
s
 = 1;

593 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

594 i‡(!
domaö
->
dev_iommu
[
i
])

601 
	`iommu_queue_öv_iommu_∑ges
(
amd_iommus
[
i
], 
addªss
,

602 
domaö
->
id
, 
pde
, 
s
);

606 
	}
}

608 
	$iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

609 
u64
 
addªss
, 
size_t
 
size
)

611 
	`__iommu_Êush_∑ges
(
domaö
, 
addªss
, 
size
, 0);

612 
	}
}

615 
	$iommu_Êush_éb
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

617 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 0);

618 
	}
}

621 
	$iommu_Êush_éb_pde
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

623 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 1);

624 
	}
}

630 
	$iommu_Êush_domaö_devi˚s
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

632 
iommu_dev_d©a
 *
dev_d©a
;

633 
Êags
;

635 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

637 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
)

638 
	`iommu_Êush_devi˚
(
dev_d©a
->
dev
);

640 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

641 
	}
}

643 
	$iommu_Êush_Æl_domaö_devi˚s
()

645 
¥Ÿe˘i⁄_domaö
 *
domaö
;

646 
Êags
;

648 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

650 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

651 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

652 
	`iommu_Êush_com∂ëe
(
domaö
);

655 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

656 
	}
}

658 
	$amd_iommu_Êush_Æl_devi˚s
()

660 
	`iommu_Êush_Æl_domaö_devi˚s
();

661 
	}
}

667 
	$amd_iommu_Êush_Æl_domaös
()

669 
¥Ÿe˘i⁄_domaö
 *
domaö
;

670 
Êags
;

672 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

674 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

675 
	`•ö_lock
(&
domaö
->
lock
);

676 
	`iommu_Êush_éb_pde
(
domaö
);

677 
	`iommu_Êush_com∂ëe
(
domaö
);

678 
	`•ö_u∆ock
(&
domaö
->
lock
);

681 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

682 
	}
}

684 
	$ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
)

686 
	`¥_îr
("AMD-Vi: Resetting IOMMU command buffer\n");

688 i‡(
iommu
->
ª£t_ö_¥ogªss
)

689 
	`∑nic
("AMD-Vi: ILLEGAL_COMMAND_ERROR whileÑesetting command buffer\n");

691 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

692 
	`amd_iommu_Êush_Æl_devi˚s
();

693 
	`amd_iommu_Êush_Æl_domaös
();

695 
iommu
->
ª£t_ö_¥ogªss
 = 
Ál£
;

696 
	}
}

710 
boﬁ
 
	$ö¸ó£_addªss_•a˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

711 
gÂ_t
 
gÂ
)

713 
u64
 *
±e
;

715 i‡(
domaö
->
mode
 =
PAGE_MODE_6_LEVEL
)

717  
Ál£
;

719 
±e
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

720 i‡(!
±e
)

721  
Ál£
;

723 *
±e
 = 
	`PM_LEVEL_PDE
(
domaö
->
mode
,

724 
	`vút_to_phys
(
domaö
->
±_roŸ
));

725 
domaö
->
±_roŸ
 = 
±e
;

726 
domaö
->
mode
 += 1;

727 
domaö
->
upd©ed
 = 
åue
;

729  
åue
;

730 
	}
}

732 
u64
 *
	$Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

733 
addªss
,

734 
íd_lvl
,

735 
u64
 **
±e_∑ge
,

736 
gÂ_t
 
gÂ
)

738 
u64
 *
±e
, *
∑ge
;

739 
Àvñ
;

741 
addªss
 > 
	`PM_LEVEL_SIZE
(
domaö
->
mode
))

742 
	`ö¸ó£_addªss_•a˚
(
domaö
, 
gÂ
);

744 
Àvñ
 = 
domaö
->
mode
 - 1;

745 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

747 
Àvñ
 > 
íd_lvl
) {

748 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

749 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

750 i‡(!
∑ge
)

751  
NULL
;

752 *
±e
 = 
	`PM_LEVEL_PDE
(
Àvñ
, 
	`vút_to_phys
(
∑ge
));

755 
Àvñ
 -= 1;

757 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

759 i‡(
±e_∑ge
 && 
Àvñ
 =
íd_lvl
)

760 *
±e_∑ge
 = 
±e
;

762 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

765  
±e
;

766 
	}
}

772 
u64
 *
	$„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

773 
addªss
, 
m≠_size
)

775 
Àvñ
;

776 
u64
 *
±e
;

778 
Àvñ
 = 
domaö
->
mode
 - 1;

779 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

781 
Àvñ
 > 
m≠_size
) {

782 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

783  
NULL
;

785 
Àvñ
 -= 1;

787 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

788 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

790 i‡((
	`PM_PTE_LEVEL
(*
±e
Ë=0Ë&& 
Àvñ
 !
m≠_size
) {

791 
±e
 = 
NULL
;

796  
±e
;

797 
	}
}

806 
	$iommu_m≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

807 
bus_addr
,

808 
phys_addr
,

809 
¥Ÿ
,

810 
m≠_size
)

812 
u64
 
__±e
, *
±e
;

814 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

815 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

817 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
bus_addr
));

818 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
phys_addr
));

820 i‡(!(
¥Ÿ
 & 
IOMMU_PROT_MASK
))

821  -
EINVAL
;

823 
±e
 = 
	`Æloc_±e
(
dom
, 
bus_addr
, 
m≠_size
, 
NULL
, 
GFP_KERNEL
);

825 i‡(
	`IOMMU_PTE_PRESENT
(*
±e
))

826  -
EBUSY
;

828 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
;

829 i‡(
¥Ÿ
 & 
IOMMU_PROT_IR
)

830 
__±e
 |
IOMMU_PTE_IR
;

831 i‡(
¥Ÿ
 & 
IOMMU_PROT_IW
)

832 
__±e
 |
IOMMU_PTE_IW
;

834 *
±e
 = 
__±e
;

836 
	`upd©e_domaö
(
dom
);

839 
	}
}

841 
	$iommu_unm≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

842 
bus_addr
, 
m≠_size
)

844 
u64
 *
±e
 = 
	`„tch_±e
(
dom
, 
bus_addr
, 
m≠_size
);

846 i‡(
±e
)

847 *
±e
 = 0;

848 
	}
}

854 
	$iommu_f‹_unôy_m≠
(
amd_iommu
 *
iommu
,

855 
unôy_m≠_íåy
 *
íåy
)

857 
u16
 
bdf
, 
i
;

859 
i
 = 
íåy
->
devid_°¨t
; i <íåy->
devid_íd
; ++i) {

860 
bdf
 = 
amd_iommu_Æüs_èbÀ
[
i
];

861 i‡(
amd_iommu_æookup_èbÀ
[
bdf
] =
iommu
)

866 
	}
}

872 
	$dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

873 
unôy_m≠_íåy
 *
e
)

875 
u64
 
addr
;

876 
ªt
;

878 
addr
 = 
e
->
addªss_°¨t
;ádd∏<É->
addªss_íd
;

879 
addr
 +
PAGE_SIZE
) {

880 
ªt
 = 
	`iommu_m≠_∑ge
(&
dma_dom
->
domaö
, 
addr
,áddr, 
e
->
¥Ÿ
,

881 
PM_MAP_4k
);

882 i‡(
ªt
)

883  
ªt
;

888 i‡(
addr
 < 
dma_dom
->
≠îtuª_size
)

889 
	`__£t_bô
(
addr
 >> 
PAGE_SHIFT
,

890 
dma_dom
->
≠îtuª
[0]->
bôm≠
);

894 
	}
}

902 
	$iommu_öô_unôy_m≠pögs
(
amd_iommu
 *
iommu
)

904 
unôy_m≠_íåy
 *
íåy
;

905 
ªt
;

907 
	`li°_f‹_óch_íåy
(
íåy
, &
amd_iommu_unôy_m≠
, 
li°
) {

908 i‡(!
	`iommu_f‹_unôy_m≠
(
iommu
, 
íåy
))

910 
ªt
 = 
	`dma_›s_unôy_m≠
(
iommu
->
deÁu…_dom
, 
íåy
);

911 i‡(
ªt
)

912  
ªt
;

916 
	}
}

921 
	$öô_unôy_m≠pögs_f‹_devi˚
(
dma_›s_domaö
 *
dma_dom
,

922 
u16
 
devid
)

924 
unôy_m≠_íåy
 *
e
;

925 
ªt
;

927 
	`li°_f‹_óch_íåy
(
e
, &
amd_iommu_unôy_m≠
, 
li°
) {

928 i‡(!(
devid
 >
e
->
devid_°¨t
 && devid <e->
devid_íd
))

930 
ªt
 = 
	`dma_›s_unôy_m≠
(
dma_dom
, 
e
);

931 i‡(
ªt
)

932  
ªt
;

936 
	}
}

958 
	$dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

959 
°¨t_∑ge
,

960 
∑ges
)

962 
i
, 
œ°_∑ge
 = 
dom
->
≠îtuª_size
 >> 
PAGE_SHIFT
;

964 i‡(
°¨t_∑ge
 + 
∑ges
 > 
œ°_∑ge
)

965 
∑ges
 = 
œ°_∑ge
 - 
°¨t_∑ge
;

967 
i
 = 
°¨t_∑ge
; i < sèπ_∑gê+ 
∑ges
; ++i) {

968 
ödex
 = 
i
 / 
APERTURE_RANGE_PAGES
;

969 
∑ge
 = 
i
 % 
APERTURE_RANGE_PAGES
;

970 
	`__£t_bô
(
∑ge
, 
dom
->
≠îtuª
[
ödex
]->
bôm≠
);

972 
	}
}

979 
	$Æloc_√w_ønge
(
dma_›s_domaö
 *
dma_dom
,

980 
boﬁ
 
p›uœã
, 
gÂ_t
 
gÂ
)

982 
ödex
 = 
dma_dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

983 
amd_iommu
 *
iommu
;

984 
i
;

986 #ifde‡
CONFIG_IOMMU_STRESS


987 
p›uœã
 = 
Ál£
;

990 i‡(
ödex
 >
APERTURE_MAX_RANGES
)

991  -
ENOMEM
;

993 
dma_dom
->
≠îtuª
[
ödex
] = 
	`kzÆloc
((
≠îtuª_ønge
), 
gÂ
);

994 i‡(!
dma_dom
->
≠îtuª
[
ödex
])

995  -
ENOMEM
;

997 
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

998 i‡(!
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
)

999 
out_‰ì
;

1001 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 = dma_dom->
≠îtuª_size
;

1003 i‡(
p›uœã
) {

1004 
addªss
 = 
dma_dom
->
≠îtuª_size
;

1005 
i
, 
num_±es
 = 
APERTURE_RANGE_PAGES
 / 512;

1006 
u64
 *
±e
, *
±e_∑ge
;

1008 
i
 = 0; i < 
num_±es
; ++i) {

1009 
±e
 = 
	`Æloc_±e
(&
dma_dom
->
domaö
, 
addªss
, 
PM_MAP_4k
,

1010 &
±e_∑ge
, 
gÂ
);

1011 i‡(!
±e
)

1012 
out_‰ì
;

1014 
dma_dom
->
≠îtuª
[
ödex
]->
±e_∑ges
[
i
] = 
±e_∑ge
;

1016 
addªss
 +
APERTURE_RANGE_SIZE
 / 64;

1020 
dma_dom
->
≠îtuª_size
 +
APERTURE_RANGE_SIZE
;

1023 
	`f‹_óch_iommu
(
iommu
) {

1024 i‡(
iommu
->
ex˛usi⁄_°¨t
 &&

1025 
iommu
->
ex˛usi⁄_°¨t
 >
dma_dom
->
≠îtuª
[
ödex
]->
off£t


1026 && 
iommu
->
ex˛usi⁄_°¨t
 < 
dma_dom
->
≠îtuª_size
) {

1027 
°¨çage
;

1028 
∑ges
 = 
	`iommu_num_∑ges
(
iommu
->
ex˛usi⁄_°¨t
,

1029 
iommu
->
ex˛usi⁄_Àngth
,

1030 
PAGE_SIZE
);

1031 
°¨çage
 = 
iommu
->
ex˛usi⁄_°¨t
 >> 
PAGE_SHIFT
;

1032 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
°¨çage
, 
∑ges
);

1042 
i
 = 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
;

1043 
i
 < 
dma_dom
->
≠îtuª_size
;

1044 
i
 +
PAGE_SIZE
) {

1045 
u64
 *
±e
 = 
	`„tch_±e
(&
dma_dom
->
domaö
, 
i
, 
PM_MAP_4k
);

1046 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

1049 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
i
 << 
PAGE_SHIFT
, 1);

1052 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1056 
out_‰ì
:

1057 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1059 
	`‰ì_∑ge
(()
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
);

1061 
	`k‰ì
(
dma_dom
->
≠îtuª
[
ödex
]);

1062 
dma_dom
->
≠îtuª
[
ödex
] = 
NULL
;

1064  -
ENOMEM
;

1065 
	}
}

1067 
	$dma_›s_¨ó_Æloc
(
devi˚
 *
dev
,

1068 
dma_›s_domaö
 *
dom
,

1069 
∑ges
,

1070 
Æign_mask
,

1071 
u64
 
dma_mask
,

1072 
°¨t
)

1074 
√xt_bô
 = 
dom
->
√xt_addªss
 % 
APERTURE_RANGE_SIZE
;

1075 
max_ödex
 = 
dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

1076 
i
 = 
°¨t
 >> 
APERTURE_RANGE_SHIFT
;

1077 
bound¨y_size
;

1078 
addªss
 = -1;

1079 
limô
;

1081 
√xt_bô
 >>
PAGE_SHIFT
;

1083 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

1084 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

1086 ;
i
 < 
max_ödex
; ++i) {

1087 
off£t
 = 
dom
->
≠îtuª
[
i
]->off£à>> 
PAGE_SHIFT
;

1089 i‡(
dom
->
≠îtuª
[
i
]->
off£t
 >
dma_mask
)

1092 
limô
 = 
	`iommu_devi˚_max_ödex
(
APERTURE_RANGE_PAGES
, 
off£t
,

1093 
dma_mask
 >> 
PAGE_SHIFT
);

1095 
addªss
 = 
	`iommu_¨ó_Æloc
(
dom
->
≠îtuª
[
i
]->
bôm≠
,

1096 
limô
, 
√xt_bô
, 
∑ges
, 0,

1097 
bound¨y_size
, 
Æign_mask
);

1098 i‡(
addªss
 != -1) {

1099 
addªss
 = 
dom
->
≠îtuª
[
i
]->
off£t
 +

1100 (
addªss
 << 
PAGE_SHIFT
);

1101 
dom
->
√xt_addªss
 = 
addªss
 + (
∑ges
 << 
PAGE_SHIFT
);

1105 
√xt_bô
 = 0;

1108  
addªss
;

1109 
	}
}

1111 
	$dma_›s_Æloc_addªs£s
(
devi˚
 *
dev
,

1112 
dma_›s_domaö
 *
dom
,

1113 
∑ges
,

1114 
Æign_mask
,

1115 
u64
 
dma_mask
)

1117 
addªss
;

1119 #ifde‡
CONFIG_IOMMU_STRESS


1120 
dom
->
√xt_addªss
 = 0;

1121 
dom
->
√ed_Êush
 = 
åue
;

1124 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1125 
dma_mask
, 
dom
->
√xt_addªss
);

1127 i‡(
addªss
 == -1) {

1128 
dom
->
√xt_addªss
 = 0;

1129 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1130 
dma_mask
, 0);

1131 
dom
->
√ed_Êush
 = 
åue
;

1134 i‡(
	`u∆ikñy
(
addªss
 == -1))

1135 
addªss
 = 
DMA_ERROR_CODE
;

1137 
	`WARN_ON
((
addªss
 + (
PAGE_SIZE
*
∑ges
)Ë> 
dom
->
≠îtuª_size
);

1139  
addªss
;

1140 
	}
}

1147 
	$dma_›s_‰ì_addªs£s
(
dma_›s_domaö
 *
dom
,

1148 
addªss
,

1149 
∑ges
)

1151 
i
 = 
addªss
 >> 
APERTURE_RANGE_SHIFT
;

1152 
≠îtuª_ønge
 *
ønge
 = 
dom
->
≠îtuª
[
i
];

1154 
	`BUG_ON
(
i
 >
APERTURE_MAX_RANGES
 || 
ønge
 =
NULL
);

1156 #ifde‡
CONFIG_IOMMU_STRESS


1157 i‡(
i
 < 4)

1161 i‡(
addªss
 >
dom
->
√xt_addªss
)

1162 
dom
->
√ed_Êush
 = 
åue
;

1164 
addªss
 = (addªs†% 
APERTURE_RANGE_SIZE
Ë>> 
PAGE_SHIFT
;

1166 
	`bôm≠_˛ór
(
ønge
->
bôm≠
, 
addªss
, 
∑ges
);

1168 
	}
}

1183 
	$add_domaö_to_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1185 
Êags
;

1187 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1188 
	`li°_add
(&
domaö
->
li°
, &
amd_iommu_pd_li°
);

1189 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1190 
	}
}

1196 
	$dñ_domaö_‰om_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1198 
Êags
;

1200 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1201 
	`li°_dñ
(&
domaö
->
li°
);

1202 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1203 
	}
}

1205 
u16
 
	$domaö_id_Æloc
()

1207 
Êags
;

1208 
id
;

1210 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1211 
id
 = 
	`föd_fú°_zîo_bô
(
amd_iommu_pd_Æloc_bôm≠
, 
MAX_DOMAIN_ID
);

1212 
	`BUG_ON
(
id
 == 0);

1213 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1214 
	`__£t_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1216 
id
 = 0;

1217 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1219  
id
;

1220 
	}
}

1222 
	$domaö_id_‰ì
(
id
)

1224 
Êags
;

1226 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1227 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1228 
	`__˛ór_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1229 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1230 
	}
}

1232 
	$‰ì_∑gëabÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1234 
i
, 
j
;

1235 
u64
 *
p1
, *
p2
, *
p3
;

1237 
p1
 = 
domaö
->
±_roŸ
;

1239 i‡(!
p1
)

1242 
i
 = 0; i < 512; ++i) {

1243 i‡(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

1246 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

1247 
j
 = 0; j < 512; ++j) {

1248 i‡(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

1250 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

1251 
	`‰ì_∑ge
(()
p3
);

1254 
	`‰ì_∑ge
(()
p2
);

1257 
	`‰ì_∑ge
(()
p1
);

1259 
domaö
->
±_roŸ
 = 
NULL
;

1260 
	}
}

1266 
	$dma_›s_domaö_‰ì
(
dma_›s_domaö
 *
dom
)

1268 
i
;

1270 i‡(!
dom
)

1273 
	`dñ_domaö_‰om_li°
(&
dom
->
domaö
);

1275 
	`‰ì_∑gëabÀ
(&
dom
->
domaö
);

1277 
i
 = 0; i < 
APERTURE_MAX_RANGES
; ++i) {

1278 i‡(!
dom
->
≠îtuª
[
i
])

1280 
	`‰ì_∑ge
(()
dom
->
≠îtuª
[
i
]->
bôm≠
);

1281 
	`k‰ì
(
dom
->
≠îtuª
[
i
]);

1284 
	`k‰ì
(
dom
);

1285 
	}
}

1292 
dma_›s_domaö
 *
	$dma_›s_domaö_Æloc
()

1294 
dma_›s_domaö
 *
dma_dom
;

1296 
dma_dom
 = 
	`kzÆloc
((
dma_›s_domaö
), 
GFP_KERNEL
);

1297 i‡(!
dma_dom
)

1298  
NULL
;

1300 
	`•ö_lock_öô
(&
dma_dom
->
domaö
.
lock
);

1302 
dma_dom
->
domaö
.
id
 = 
	`domaö_id_Æloc
();

1303 i‡(
dma_dom
->
domaö
.
id
 == 0)

1304 
‰ì_dma_dom
;

1305 
	`INIT_LIST_HEAD
(&
dma_dom
->
domaö
.
dev_li°
);

1306 
dma_dom
->
domaö
.
mode
 = 
PAGE_MODE_2_LEVEL
;

1307 
dma_dom
->
domaö
.
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1308 
dma_dom
->
domaö
.
Êags
 = 
PD_DMA_OPS_MASK
;

1309 
dma_dom
->
domaö
.
¥iv
 = dma_dom;

1310 i‡(!
dma_dom
->
domaö
.
±_roŸ
)

1311 
‰ì_dma_dom
;

1313 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1314 
dma_dom
->
èrgë_dev
 = 0xffff;

1316 
	`add_domaö_to_li°
(&
dma_dom
->
domaö
);

1318 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
åue
, 
GFP_KERNEL
))

1319 
‰ì_dma_dom
;

1325 
dma_dom
->
≠îtuª
[0]->
bôm≠
[0] = 1;

1326 
dma_dom
->
√xt_addªss
 = 0;

1329  
dma_dom
;

1331 
‰ì_dma_dom
:

1332 
	`dma_›s_domaö_‰ì
(
dma_dom
);

1334  
NULL
;

1335 
	}
}

1341 
boﬁ
 
	$dma_›s_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1343  
domaö
->
Êags
 & 
PD_DMA_OPS_MASK
;

1344 
	}
}

1346 
	$£t_dã_íåy
(
u16
 
devid
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1348 
u64
 
±e_roŸ
 = 
	`vút_to_phys
(
domaö
->
±_roŸ
);

1350 
±e_roŸ
 |(
domaö
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

1351 << 
DEV_ENTRY_MODE_SHIFT
;

1352 
±e_roŸ
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1354 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 
domaö
->
id
;

1355 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 
	`uµî_32_bôs
(
±e_roŸ
);

1356 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
	`lowî_32_bôs
(
±e_roŸ
);

1357 
	}
}

1359 
	$˛ór_dã_íåy
(
u16
 
devid
)

1362 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1363 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 0;

1364 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 0;

1366 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

1367 
	}
}

1369 
	$do_©èch
(
devi˚
 *
dev
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1371 
iommu_dev_d©a
 *
dev_d©a
;

1372 
amd_iommu
 *
iommu
;

1373 
u16
 
devid
;

1375 
devid
 = 
	`gë_devi˚_id
(
dev
);

1376 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1377 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1380 
dev_d©a
->
domaö
 = domain;

1381 
	`li°_add
(&
dev_d©a
->
li°
, &
domaö
->
dev_li°
);

1382 
	`£t_dã_íåy
(
devid
, 
domaö
);

1385 
domaö
->
dev_iommu
[
iommu
->
ödex
] += 1;

1386 
domaö
->
dev_˙t
 += 1;

1389 
	`iommu_Êush_devi˚
(
dev
);

1390 
	}
}

1392 
	$do_dëach
(
devi˚
 *
dev
)

1394 
iommu_dev_d©a
 *
dev_d©a
;

1395 
amd_iommu
 *
iommu
;

1396 
u16
 
devid
;

1398 
devid
 = 
	`gë_devi˚_id
(
dev
);

1399 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1400 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1403 
dev_d©a
->
domaö
->
dev_iommu
[
iommu
->
ödex
] -= 1;

1404 
dev_d©a
->
domaö
->
dev_˙t
 -= 1;

1407 
dev_d©a
->
domaö
 = 
NULL
;

1408 
	`li°_dñ
(&
dev_d©a
->
li°
);

1409 
	`˛ór_dã_íåy
(
devid
);

1412 
	`iommu_Êush_devi˚
(
dev
);

1413 
	}
}

1419 
	$__©èch_devi˚
(
devi˚
 *
dev
,

1420 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1422 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1424 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1425 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1427 i‡(!
Æüs_d©a
)

1428  -
EINVAL
;

1431 
	`•ö_lock
(&
domaö
->
lock
);

1434 i‡(
Æüs_d©a
->
domaö
 !
NULL
 &&

1435 
Æüs_d©a
->
domaö
 != domain)

1436  -
EBUSY
;

1438 i‡(
dev_d©a
->
domaö
 !
NULL
 &&

1439 
dev_d©a
->
domaö
 != domain)

1440  -
EBUSY
;

1443 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1444 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1445 i‡(
Æüs_d©a
->
domaö
 =
NULL
)

1446 
	`do_©èch
(
dev_d©a
->
Æüs
, 
domaö
);

1448 
	`©omic_öc
(&
Æüs_d©a
->
böd
);

1451 i‡(
dev_d©a
->
domaö
 =
NULL
)

1452 
	`do_©èch
(
dev
, 
domaö
);

1454 
	`©omic_öc
(&
dev_d©a
->
böd
);

1457 
	`•ö_u∆ock
(&
domaö
->
lock
);

1460 
	}
}

1466 
	$©èch_devi˚
(
devi˚
 *
dev
,

1467 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1469 
Êags
;

1470 
ªt
;

1472 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1473 
ªt
 = 
	`__©èch_devi˚
(
dev
, 
domaö
);

1474 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1481 
	`iommu_Êush_éb_pde
(
domaö
);

1483  
ªt
;

1484 
	}
}

1489 
	$__dëach_devi˚
(
devi˚
 *
dev
)

1491 
iommu_dev_d©a
 *
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1492 
iommu_dev_d©a
 *
Æüs_d©a
;

1493 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1494 
Êags
;

1496 
	`BUG_ON
(!
dev_d©a
->
domaö
);

1498 
domaö
 = 
dev_d©a
->domain;

1500 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1502 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1503 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1504 i‡(
	`©omic_dec_™d_ã°
(&
Æüs_d©a
->
böd
))

1505 
	`do_dëach
(
dev_d©a
->
Æüs
);

1508 i‡(
	`©omic_dec_™d_ã°
(&
dev_d©a
->
böd
))

1509 
	`do_dëach
(
dev
);

1511 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1518 i‡(
iommu_∑ss_through
 &&

1519 (
dev_d©a
->
domaö
 =
NULL
 && domaö !
±_domaö
))

1520 
	`__©èch_devi˚
(
dev
, 
±_domaö
);

1521 
	}
}

1526 
	$dëach_devi˚
(
devi˚
 *
dev
)

1528 
Êags
;

1531 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1532 
	`__dëach_devi˚
(
dev
);

1533 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1534 
	}
}

1540 
¥Ÿe˘i⁄_domaö
 *
	$domaö_f‹_devi˚
(
devi˚
 *
dev
)

1542 
¥Ÿe˘i⁄_domaö
 *
dom
;

1543 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1544 
Êags
;

1545 
u16
 
devid
, 
Æüs
;

1547 
devid
 = 
	`gë_devi˚_id
(
dev
);

1548 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

1549 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1550 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1551 i‡(!
Æüs_d©a
)

1552  
NULL
;

1554 
	`ªad_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1555 
dom
 = 
dev_d©a
->
domaö
;

1556 i‡(
dom
 =
NULL
 &&

1557 
Æüs_d©a
->
domaö
 !
NULL
) {

1558 
	`__©èch_devi˚
(
dev
, 
Æüs_d©a
->
domaö
);

1559 
dom
 = 
Æüs_d©a
->
domaö
;

1562 
	`ªad_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1564  
dom
;

1565 
	}
}

1567 
	$devi˚_ch™ge_nŸifõr
(
nŸifõr_block
 *
nb
,

1568 
a˘i⁄
, *
d©a
)

1570 
devi˚
 *
dev
 = 
d©a
;

1571 
u16
 
devid
;

1572 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1573 
dma_›s_domaö
 *
dma_domaö
;

1574 
amd_iommu
 *
iommu
;

1575 
Êags
;

1577 i‡(!
	`check_devi˚
(
dev
))

1580 
devid
 = 
	`gë_devi˚_id
(
dev
);

1581 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1583 
a˘i⁄
) {

1584 
BUS_NOTIFY_UNBOUND_DRIVER
:

1586 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1588 i‡(!
domaö
)

1589 
out
;

1590 i‡(
iommu_∑ss_through
)

1592 
	`dëach_devi˚
(
dev
);

1594 
BUS_NOTIFY_ADD_DEVICE
:

1596 
	`iommu_öô_devi˚
(
dev
);

1598 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1601 
dma_domaö
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1602 i‡(
dma_domaö
)

1603 
out
;

1604 
dma_domaö
 = 
	`dma_›s_domaö_Æloc
();

1605 i‡(!
dma_domaö
)

1606 
out
;

1607 
dma_domaö
->
èrgë_dev
 = 
devid
;

1609 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1610 
	`li°_add_èû
(&
dma_domaö
->
li°
, &
iommu_pd_li°
);

1611 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1614 
BUS_NOTIFY_DEL_DEVICE
:

1616 
	`iommu_unöô_devi˚
(
dev
);

1619 
out
;

1622 
	`iommu_Êush_devi˚
(
dev
);

1623 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1625 
out
:

1627 
	}
}

1629 
nŸifõr_block
 
	gdevi˚_nb
 = {

1630 .
nŸifõr_ˇŒ
 = 
devi˚_ch™ge_nŸifõr
,

1633 
	$amd_iommu_öô_nŸifõr
()

1635 
	`bus_ªgi°î_nŸifõr
(&
pci_bus_ty≥
, &
devi˚_nb
);

1636 
	}
}

1651 
¥Ÿe˘i⁄_domaö
 *
	$gë_domaö
(
devi˚
 *
dev
)

1653 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1654 
dma_›s_domaö
 *
dma_dom
;

1655 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev
);

1657 i‡(!
	`check_devi˚
(
dev
))

1658  
	`ERR_PTR
(-
EINVAL
);

1660 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1661 i‡(
domaö
 !
NULL
 && !
	`dma_›s_domaö
(domain))

1662  
	`ERR_PTR
(-
EBUSY
);

1664 i‡(
domaö
 !
NULL
)

1665  
domaö
;

1668 
dma_dom
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1669 i‡(!
dma_dom
)

1670 
dma_dom
 = 
amd_iommu_æookup_èbÀ
[
devid
]->
deÁu…_dom
;

1671 
	`©èch_devi˚
(
dev
, &
dma_dom
->
domaö
);

1672 
	`DUMP_¥ötk
("UsingÖrotection domain %d for device %s\n",

1673 
dma_dom
->
domaö
.
id
, 
	`dev_«me
(
dev
));

1675  &
dma_dom
->
domaö
;

1676 
	}
}

1678 
	$upd©e_devi˚_èbÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1680 
iommu_dev_d©a
 *
dev_d©a
;

1682 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
) {

1683 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev_d©a
->
dev
);

1684 
	`£t_dã_íåy
(
devid
, 
domaö
);

1686 
	}
}

1688 
	$upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1690 i‡(!
domaö
->
upd©ed
)

1693 
	`upd©e_devi˚_èbÀ
(
domaö
);

1694 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

1695 
	`iommu_Êush_éb_pde
(
domaö
);

1697 
domaö
->
upd©ed
 = 
Ál£
;

1698 
	}
}

1703 
u64
* 
	$dma_›s_gë_±e
(
dma_›s_domaö
 *
dom
,

1704 
addªss
)

1706 
≠îtuª_ønge
 *
≠îtuª
;

1707 
u64
 *
±e
, *
±e_∑ge
;

1709 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1710 i‡(!
≠îtuª
)

1711  
NULL
;

1713 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1714 i‡(!
±e
) {

1715 
±e
 = 
	`Æloc_±e
(&
dom
->
domaö
, 
addªss
, 
PM_MAP_4k
, &
±e_∑ge
,

1716 
GFP_ATOMIC
);

1717 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)] = 
±e_∑ge
;

1719 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1721 
	`upd©e_domaö
(&
dom
->
domaö
);

1723  
±e
;

1724 
	}
}

1730 
dma_addr_t
 
	$dma_›s_domaö_m≠
(
dma_›s_domaö
 *
dom
,

1731 
addªss
,

1732 
phys_addr_t
 
∑ddr
,

1733 
dúe˘i⁄
)

1735 
u64
 *
±e
, 
__±e
;

1737 
	`WARN_ON
(
addªss
 > 
dom
->
≠îtuª_size
);

1739 
∑ddr
 &
PAGE_MASK
;

1741 
±e
 = 
	`dma_›s_gë_±e
(
dom
, 
addªss
);

1742 i‡(!
±e
)

1743  
DMA_ERROR_CODE
;

1745 
__±e
 = 
∑ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1747 i‡(
dúe˘i⁄
 =
DMA_TO_DEVICE
)

1748 
__±e
 |
IOMMU_PTE_IR
;

1749 i‡(
dúe˘i⁄
 =
DMA_FROM_DEVICE
)

1750 
__±e
 |
IOMMU_PTE_IW
;

1751 i‡(
dúe˘i⁄
 =
DMA_BIDIRECTIONAL
)

1752 
__±e
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1754 
	`WARN_ON
(*
±e
);

1756 *
±e
 = 
__±e
;

1758  (
dma_addr_t
)
addªss
;

1759 
	}
}

1764 
	$dma_›s_domaö_unm≠
(
dma_›s_domaö
 *
dom
,

1765 
addªss
)

1767 
≠îtuª_ønge
 *
≠îtuª
;

1768 
u64
 *
±e
;

1770 i‡(
addªss
 >
dom
->
≠îtuª_size
)

1773 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1774 i‡(!
≠îtuª
)

1777 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1778 i‡(!
±e
)

1781 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1783 
	`WARN_ON
(!*
±e
);

1785 *
±e
 = 0ULL;

1786 
	}
}

1794 
dma_addr_t
 
	$__m≠_sögÀ
(
devi˚
 *
dev
,

1795 
dma_›s_domaö
 *
dma_dom
,

1796 
phys_addr_t
 
∑ddr
,

1797 
size_t
 
size
,

1798 
dú
,

1799 
boﬁ
 
Æign
,

1800 
u64
 
dma_mask
)

1802 
dma_addr_t
 
off£t
 = 
∑ddr
 & ~
PAGE_MASK
;

1803 
dma_addr_t
 
addªss
, 
°¨t
, 
ªt
;

1804 
∑ges
;

1805 
Æign_mask
 = 0;

1806 
i
;

1808 
∑ges
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

1809 
∑ddr
 &
PAGE_MASK
;

1811 
	`INC_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

1813 i‡(
∑ges
 > 1)

1814 
	`INC_STATS_COUNTER
(
¸oss_∑ge
);

1816 i‡(
Æign
)

1817 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

1819 
ªåy
:

1820 
addªss
 = 
	`dma_›s_Æloc_addªs£s
(
dev
, 
dma_dom
, 
∑ges
, 
Æign_mask
,

1821 
dma_mask
);

1822 i‡(
	`u∆ikñy
(
addªss
 =
DMA_ERROR_CODE
)) {

1828 
dma_dom
->
√xt_addªss
 = dma_dom->
≠îtuª_size
;

1830 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
Ál£
, 
GFP_ATOMIC
))

1831 
out
;

1837 
ªåy
;

1840 
°¨t
 = 
addªss
;

1841 
i
 = 0; i < 
∑ges
; ++i) {

1842 
ªt
 = 
	`dma_›s_domaö_m≠
(
dma_dom
, 
°¨t
, 
∑ddr
, 
dú
);

1843 i‡(
ªt
 =
DMA_ERROR_CODE
)

1844 
out_unm≠
;

1846 
∑ddr
 +
PAGE_SIZE
;

1847 
°¨t
 +
PAGE_SIZE
;

1849 
addªss
 +
off£t
;

1851 
	`ADD_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1853 i‡(
	`u∆ikñy
(
dma_dom
->
√ed_Êush
 && !
amd_iommu_unm≠_Êush
)) {

1854 
	`iommu_Êush_éb
(&
dma_dom
->
domaö
);

1855 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1856 } i‡(
	`u∆ikñy
(
amd_iommu_≈_ˇche
))

1857 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
addªss
, 
size
);

1859 
out
:

1860  
addªss
;

1862 
out_unm≠
:

1864 --
i
; i >= 0; --i) {

1865 
°¨t
 -
PAGE_SIZE
;

1866 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1869 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
addªss
, 
∑ges
);

1871  
DMA_ERROR_CODE
;

1872 
	}
}

1878 
	$__unm≠_sögÀ
(
dma_›s_domaö
 *
dma_dom
,

1879 
dma_addr_t
 
dma_addr
,

1880 
size_t
 
size
,

1881 
dú
)

1883 
dma_addr_t
 
i
, 
°¨t
;

1884 
∑ges
;

1886 i‡((
dma_addr
 =
DMA_ERROR_CODE
) ||

1887 (
dma_addr
 + 
size
 > 
dma_dom
->
≠îtuª_size
))

1890 
∑ges
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1891 
dma_addr
 &
PAGE_MASK
;

1892 
°¨t
 = 
dma_addr
;

1894 
i
 = 0; i < 
∑ges
; ++i) {

1895 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1896 
°¨t
 +
PAGE_SIZE
;

1899 
	`SUB_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1901 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
dma_addr
, 
∑ges
);

1903 i‡(
amd_iommu_unm≠_Êush
 || 
dma_dom
->
√ed_Êush
) {

1904 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
dma_addr
, 
size
);

1905 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1907 
	}
}

1912 
dma_addr_t
 
	$m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

1913 
off£t
, 
size_t
 
size
,

1914 
dma_d©a_dúe˘i⁄
 
dú
,

1915 
dma_©ås
 *
©ås
)

1917 
Êags
;

1918 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1919 
dma_addr_t
 
addr
;

1920 
u64
 
dma_mask
;

1921 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

1923 
	`INC_STATS_COUNTER
(
˙t_m≠_sögÀ
);

1925 
domaö
 = 
	`gë_domaö
(
dev
);

1926 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

1927  (
dma_addr_t
)
∑ddr
;

1928 i‡(
	`IS_ERR
(
domaö
))

1929  
DMA_ERROR_CODE
;

1931 
dma_mask
 = *
dev
->dma_mask;

1933 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1935 
addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
, 
size
, 
dú
, 
Ál£
,

1936 
dma_mask
);

1937 i‡(
addr
 =
DMA_ERROR_CODE
)

1938 
out
;

1940 
	`iommu_Êush_com∂ëe
(
domaö
);

1942 
out
:

1943 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1945  
addr
;

1946 
	}
}

1951 
	$unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

1952 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

1954 
Êags
;

1955 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1957 
	`INC_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

1959 
domaö
 = 
	`gë_domaö
(
dev
);

1960 i‡(
	`IS_ERR
(
domaö
))

1963 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1965 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
dú
);

1967 
	`iommu_Êush_com∂ëe
(
domaö
);

1969 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1970 
	}
}

1976 
	$m≠_sg_no_iommu
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1977 
√Àms
, 
dú
)

1979 
sˇâîli°
 *
s
;

1980 
i
;

1982 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1983 
s
->
dma_addªss
 = (
dma_addr_t
)
	`sg_phys
(s);

1984 
s
->
dma_Àngth
 = s->
Àngth
;

1987  
√Àms
;

1988 
	}
}

1994 
	$m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1995 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1996 
dma_©ås
 *
©ås
)

1998 
Êags
;

1999 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2000 
i
;

2001 
sˇâîli°
 *
s
;

2002 
phys_addr_t
 
∑ddr
;

2003 
m≠≥d_ñems
 = 0;

2004 
u64
 
dma_mask
;

2006 
	`INC_STATS_COUNTER
(
˙t_m≠_sg
);

2008 
domaö
 = 
	`gë_domaö
(
dev
);

2009 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

2010  
	`m≠_sg_no_iommu
(
dev
, 
sgli°
, 
√Àms
, 
dú
);

2011 i‡(
	`IS_ERR
(
domaö
))

2014 
dma_mask
 = *
dev
->dma_mask;

2016 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2018 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2019 
∑ddr
 = 
	`sg_phys
(
s
);

2021 
s
->
dma_addªss
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
,

2022 
∑ddr
, 
s
->
Àngth
, 
dú
, 
Ál£
,

2023 
dma_mask
);

2025 i‡(
s
->
dma_addªss
) {

2026 
s
->
dma_Àngth
 = s->
Àngth
;

2027 
m≠≥d_ñems
++;

2029 
unm≠
;

2032 
	`iommu_Êush_com∂ëe
(
domaö
);

2034 
out
:

2035 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2037  
m≠≥d_ñems
;

2038 
unm≠
:

2039 
	`f‹_óch_sg
(
sgli°
, 
s
, 
m≠≥d_ñems
, 
i
) {

2040 i‡(
s
->
dma_addªss
)

2041 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2042 
s
->
dma_Àngth
, 
dú
);

2043 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2046 
m≠≥d_ñems
 = 0;

2048 
out
;

2049 
	}
}

2055 
	$unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

2056 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

2057 
dma_©ås
 *
©ås
)

2059 
Êags
;

2060 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2061 
sˇâîli°
 *
s
;

2062 
i
;

2064 
	`INC_STATS_COUNTER
(
˙t_unm≠_sg
);

2066 
domaö
 = 
	`gë_domaö
(
dev
);

2067 i‡(
	`IS_ERR
(
domaö
))

2070 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2072 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2073 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2074 
s
->
dma_Àngth
, 
dú
);

2075 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2078 
	`iommu_Êush_com∂ëe
(
domaö
);

2080 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2081 
	}
}

2086 *
	$Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2087 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

2089 
Êags
;

2090 *
vút_addr
;

2091 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2092 
phys_addr_t
 
∑ddr
;

2093 
u64
 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2095 
	`INC_STATS_COUNTER
(
˙t_Æloc_cohîít
);

2097 
domaö
 = 
	`gë_domaö
(
dev
);

2098 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
) {

2099 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2100 *
dma_addr
 = 
	`__∑
(
vút_addr
);

2101  
vút_addr
;

2102 } i‡(
	`IS_ERR
(
domaö
))

2103  
NULL
;

2105 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2106 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

2107 
Êag
 |
__GFP_ZERO
;

2109 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2110 i‡(!
vút_addr
)

2111  
NULL
;

2113 
∑ddr
 = 
	`vút_to_phys
(
vút_addr
);

2115 i‡(!
dma_mask
)

2116 
dma_mask
 = *
dev
->dma_mask;

2118 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2120 *
dma_addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
,

2121 
size
, 
DMA_BIDIRECTIONAL
, 
åue
, 
dma_mask
);

2123 i‡(*
dma_addr
 =
DMA_ERROR_CODE
) {

2124 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2125 
out_‰ì
;

2128 
	`iommu_Êush_com∂ëe
(
domaö
);

2130 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2132  
vút_addr
;

2134 
out_‰ì
:

2136 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2138  
NULL
;

2139 
	}
}

2144 
	$‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2145 *
vút_addr
, 
dma_addr_t
 
dma_addr
)

2147 
Êags
;

2148 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2150 
	`INC_STATS_COUNTER
(
˙t_‰ì_cohîít
);

2152 
domaö
 = 
	`gë_domaö
(
dev
);

2153 i‡(
	`IS_ERR
(
domaö
))

2154 
‰ì_mem
;

2156 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2158 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

2160 
	`iommu_Êush_com∂ëe
(
domaö
);

2162 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2164 
‰ì_mem
:

2165 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2166 
	}
}

2172 
	$amd_iommu_dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

2174  
	`check_devi˚
(
dev
);

2175 
	}
}

2184 
	$¥óŒoc_¥Ÿe˘i⁄_domaös
()

2186 
pci_dev
 *
dev
 = 
NULL
;

2187 
dma_›s_domaö
 *
dma_dom
;

2188 
u16
 
devid
;

2190 
	`f‹_óch_pci_dev
(
dev
) {

2193 i‡(!
	`check_devi˚
(&
dev
->dev))

2197 i‡(
	`domaö_f‹_devi˚
(&
dev
->dev))

2200 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2202 
dma_dom
 = 
	`dma_›s_domaö_Æloc
();

2203 i‡(!
dma_dom
)

2205 
	`öô_unôy_m≠pögs_f‹_devi˚
(
dma_dom
, 
devid
);

2206 
dma_dom
->
èrgë_dev
 = 
devid
;

2208 
	`©èch_devi˚
(&
dev
->dev, &
dma_dom
->
domaö
);

2210 
	`li°_add_èû
(&
dma_dom
->
li°
, &
iommu_pd_li°
);

2212 
	}
}

2214 
dma_m≠_›s
 
	gamd_iommu_dma_›s
 = {

2215 .
Æloc_cohîít
 =álloc_coherent,

2216 .
	g‰ì_cohîít
 = 
‰ì_cohîít
,

2217 .
	gm≠_∑ge
 = 
m≠_∑ge
,

2218 .
	gunm≠_∑ge
 = 
unm≠_∑ge
,

2219 .
	gm≠_sg
 = 
m≠_sg
,

2220 .
	gunm≠_sg
 = 
unm≠_sg
,

2221 .
	gdma_suµ‹ãd
 = 
amd_iommu_dma_suµ‹ãd
,

2228 
__öô
 
	$amd_iommu_öô_≠i
()

2230 
	`ªgi°î_iommu
(&
amd_iommu_›s
);

2231 
	}
}

2233 
__öô
 
	$amd_iommu_öô_dma_›s
()

2235 
amd_iommu
 *
iommu
;

2236 
ªt
;

2243 
	`f‹_óch_iommu
(
iommu
) {

2244 
iommu
->
deÁu…_dom
 = 
	`dma_›s_domaö_Æloc
();

2245 i‡(
iommu
->
deÁu…_dom
 =
NULL
)

2246  -
ENOMEM
;

2247 
iommu
->
deÁu…_dom
->
domaö
.
Êags
 |
PD_DEFAULT_MASK
;

2248 
ªt
 = 
	`iommu_öô_unôy_m≠pögs
(
iommu
);

2249 i‡(
ªt
)

2250 
‰ì_domaös
;

2256 
	`¥óŒoc_¥Ÿe˘i⁄_domaös
();

2258 
iommu_dëe˘ed
 = 1;

2259 
swiŸlb
 = 0;

2260 #ifde‡
CONFIG_GART_IOMMU


2261 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

2262 
g¨t_iommu_≠îtuª
 = 0;

2266 
dma_›s
 = &
amd_iommu_dma_›s
;

2268 
	`amd_iommu_°©s_öô
();

2272 
‰ì_domaös
:

2274 
	`f‹_óch_iommu
(
iommu
) {

2275 i‡(
iommu
->
deÁu…_dom
)

2276 
	`dma_›s_domaö_‰ì
(
iommu
->
deÁu…_dom
);

2279  
ªt
;

2280 
	}
}

2292 
	$˛ónup_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2294 
iommu_dev_d©a
 *
dev_d©a
, *
√xt
;

2295 
Êags
;

2297 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2299 
	`li°_f‹_óch_íåy_ß„
(
dev_d©a
, 
√xt
, &
domaö
->
dev_li°
, 
li°
) {

2300 
devi˚
 *
dev
 = 
dev_d©a
->dev;

2302 
	`__dëach_devi˚
(
dev
);

2303 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

2306 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2307 
	}
}

2309 
	$¥Ÿe˘i⁄_domaö_‰ì
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2311 i‡(!
domaö
)

2314 
	`dñ_domaö_‰om_li°
(
domaö
);

2316 i‡(
domaö
->
id
)

2317 
	`domaö_id_‰ì
(
domaö
->
id
);

2319 
	`k‰ì
(
domaö
);

2320 
	}
}

2322 
¥Ÿe˘i⁄_domaö
 *
	$¥Ÿe˘i⁄_domaö_Æloc
()

2324 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2326 
domaö
 = 
	`kzÆloc
((*domaö), 
GFP_KERNEL
);

2327 i‡(!
domaö
)

2328  
NULL
;

2330 
	`•ö_lock_öô
(&
domaö
->
lock
);

2331 
	`muãx_öô
(&
domaö
->
≠i_lock
);

2332 
domaö
->
id
 = 
	`domaö_id_Æloc
();

2333 i‡(!
domaö
->
id
)

2334 
out_îr
;

2335 
	`INIT_LIST_HEAD
(&
domaö
->
dev_li°
);

2337 
	`add_domaö_to_li°
(
domaö
);

2339  
domaö
;

2341 
out_îr
:

2342 
	`k‰ì
(
domaö
);

2344  
NULL
;

2345 
	}
}

2347 
	$amd_iommu_domaö_öô
(
iommu_domaö
 *
dom
)

2349 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2351 
domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2352 i‡(!
domaö
)

2353 
out_‰ì
;

2355 
domaö
->
mode
 = 
PAGE_MODE_3_LEVEL
;

2356 
domaö
->
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

2357 i‡(!
domaö
->
±_roŸ
)

2358 
out_‰ì
;

2360 
dom
->
¥iv
 = 
domaö
;

2364 
out_‰ì
:

2365 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2367  -
ENOMEM
;

2368 
	}
}

2370 
	$amd_iommu_domaö_de°roy
(
iommu_domaö
 *
dom
)

2372 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2374 i‡(!
domaö
)

2377 i‡(
domaö
->
dev_˙t
 > 0)

2378 
	`˛ónup_domaö
(
domaö
);

2380 
	`BUG_ON
(
domaö
->
dev_˙t
 != 0);

2382 
	`‰ì_∑gëabÀ
(
domaö
);

2384 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2386 
dom
->
¥iv
 = 
NULL
;

2387 
	}
}

2389 
	$amd_iommu_dëach_devi˚
(
iommu_domaö
 *
dom
,

2390 
devi˚
 *
dev
)

2392 
iommu_dev_d©a
 *
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2393 
amd_iommu
 *
iommu
;

2394 
u16
 
devid
;

2396 i‡(!
	`check_devi˚
(
dev
))

2399 
devid
 = 
	`gë_devi˚_id
(
dev
);

2401 i‡(
dev_d©a
->
domaö
 !
NULL
)

2402 
	`dëach_devi˚
(
dev
);

2404 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2405 i‡(!
iommu
)

2408 
	`iommu_Êush_devi˚
(
dev
);

2409 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2410 
	}
}

2412 
	$amd_iommu_©èch_devi˚
(
iommu_domaö
 *
dom
,

2413 
devi˚
 *
dev
)

2415 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2416 
iommu_dev_d©a
 *
dev_d©a
;

2417 
amd_iommu
 *
iommu
;

2418 
ªt
;

2419 
u16
 
devid
;

2421 i‡(!
	`check_devi˚
(
dev
))

2422  -
EINVAL
;

2424 
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2426 
devid
 = 
	`gë_devi˚_id
(
dev
);

2428 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2429 i‡(!
iommu
)

2430  -
EINVAL
;

2432 i‡(
dev_d©a
->
domaö
)

2433 
	`dëach_devi˚
(
dev
);

2435 
ªt
 = 
	`©èch_devi˚
(
dev
, 
domaö
);

2437 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2439  
ªt
;

2440 
	}
}

2442 
	$amd_iommu_m≠_ønge
(
iommu_domaö
 *
dom
,

2443 
iova
, 
phys_addr_t
 
∑ddr
,

2444 
size_t
 
size
, 
iommu_¥Ÿ
)

2446 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2447 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

2448 
¥Ÿ
 = 0;

2449 
ªt
;

2451 i‡(
iommu_¥Ÿ
 & 
IOMMU_READ
)

2452 
¥Ÿ
 |
IOMMU_PROT_IR
;

2453 i‡(
iommu_¥Ÿ
 & 
IOMMU_WRITE
)

2454 
¥Ÿ
 |
IOMMU_PROT_IW
;

2456 
iova
 &
PAGE_MASK
;

2457 
∑ddr
 &
PAGE_MASK
;

2459 
	`muãx_lock
(&
domaö
->
≠i_lock
);

2461 
i
 = 0; i < 
≈ages
; ++i) {

2462 
ªt
 = 
	`iommu_m≠_∑ge
(
domaö
, 
iova
, 
∑ddr
, 
¥Ÿ
, 
PM_MAP_4k
);

2463 i‡(
ªt
)

2464  
ªt
;

2466 
iova
 +
PAGE_SIZE
;

2467 
∑ddr
 +
PAGE_SIZE
;

2470 
	`muãx_u∆ock
(&
domaö
->
≠i_lock
);

2473 
	}
}

2475 
	$amd_iommu_unm≠_ønge
(
iommu_domaö
 *
dom
,

2476 
iova
, 
size_t
 
size
)

2479 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2480 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
iova
, 
size
, 
PAGE_SIZE
);

2482 
iova
 &
PAGE_MASK
;

2484 
	`muãx_lock
(&
domaö
->
≠i_lock
);

2486 
i
 = 0; i < 
≈ages
; ++i) {

2487 
	`iommu_unm≠_∑ge
(
domaö
, 
iova
, 
PM_MAP_4k
);

2488 
iova
 +
PAGE_SIZE
;

2491 
	`iommu_Êush_éb_pde
(
domaö
);

2493 
	`muãx_u∆ock
(&
domaö
->
≠i_lock
);

2494 
	}
}

2496 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaö
 *
dom
,

2497 
iova
)

2499 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2500 
off£t
 = 
iova
 & ~
PAGE_MASK
;

2501 
phys_addr_t
 
∑ddr
;

2502 
u64
 *
±e
;

2504 
±e
 = 
	`„tch_±e
(
domaö
, 
iova
, 
PM_MAP_4k
);

2506 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

2509 
∑ddr
 = *
±e
 & 
IOMMU_PAGE_MASK
;

2510 
∑ddr
 |
off£t
;

2512  
∑ddr
;

2513 
	}
}

2515 
	$amd_iommu_domaö_has_ˇp
(
iommu_domaö
 *
domaö
,

2516 
ˇp
)

2519 
	}
}

2521 
iommu_›s
 
	gamd_iommu_›s
 = {

2522 .
domaö_öô
 = 
amd_iommu_domaö_öô
,

2523 .
	gdomaö_de°roy
 = 
amd_iommu_domaö_de°roy
,

2524 .
	g©èch_dev
 = 
amd_iommu_©èch_devi˚
,

2525 .
	gdëach_dev
 = 
amd_iommu_dëach_devi˚
,

2526 .
	gm≠
 = 
amd_iommu_m≠_ønge
,

2527 .
	gunm≠
 = 
amd_iommu_unm≠_ønge
,

2528 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

2529 .
	gdomaö_has_ˇp
 = 
amd_iommu_domaö_has_ˇp
,

2542 
__öô
 
	$amd_iommu_öô_∑s°hrough
()

2544 
amd_iommu
 *
iommu
;

2545 
pci_dev
 *
dev
 = 
NULL
;

2546 
u16
 
devid
;

2549 
±_domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2550 i‡(!
±_domaö
)

2551  -
ENOMEM
;

2553 
±_domaö
->
mode
 |
PAGE_MODE_NONE
;

2555 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2557 i‡(!
	`check_devi˚
(&
dev
->dev))

2560 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2562 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2563 i‡(!
iommu
)

2566 
	`©èch_devi˚
(&
dev
->dev, 
±_domaö
);

2569 
	`¥_öfo
("AMD-Vi: Initialized for Passthrough Mode\n");

2572 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<löux/pci.h
>

21 
	~<löux/a˝i.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/msi.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/amd_iommu_¥Ÿo.h
>

29 
	~<asm/amd_iommu_ty≥s.h
>

30 
	~<asm/amd_iommu.h
>

31 
	~<asm/iommu.h
>

32 
	~<asm/g¨t.h
>

33 
	~<asm/x86_öô.h
>

38 
	#IVRS_HEADER_LENGTH
 48

	)

40 
	#ACPI_IVHD_TYPE
 0x10

	)

41 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

42 
	#ACPI_IVMD_TYPE
 0x21

	)

43 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

45 
	#IVHD_DEV_ALL
 0x01

	)

46 
	#IVHD_DEV_SELECT
 0x02

	)

47 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

48 
	#IVHD_DEV_RANGE_END
 0x04

	)

49 
	#IVHD_DEV_ALIAS
 0x42

	)

50 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

51 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

52 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

54 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

55 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

56 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

57 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

59 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

60 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

62 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

63 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

64 
	#ACPI_DEVFLAG_NMI
 0x04

	)

65 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

66 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

67 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

68 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

69 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

82 
	sivhd_hódî
 {

83 
u8
 
	mty≥
;

84 
u8
 
	mÊags
;

85 
u16
 
	mÀngth
;

86 
u16
 
	mdevid
;

87 
u16
 
	mˇp_±r
;

88 
u64
 
	mmmio_phys
;

89 
u16
 
	mpci_£g
;

90 
u16
 
	möfo
;

91 
u32
 
	mª£rved
;

92 } 
__©åibuã__
((
∑cked
));

98 
	sivhd_íåy
 {

99 
u8
 
	mty≥
;

100 
u16
 
	mdevid
;

101 
u8
 
	mÊags
;

102 
u32
 
	mext
;

103 } 
__©åibuã__
((
∑cked
));

109 
	sivmd_hódî
 {

110 
u8
 
	mty≥
;

111 
u8
 
	mÊags
;

112 
u16
 
	mÀngth
;

113 
u16
 
	mdevid
;

114 
u16
 
	maux
;

115 
u64
 
	mªsv
;

116 
u64
 
	mønge_°¨t
;

117 
u64
 
	mønge_Àngth
;

118 } 
__©åibuã__
((
∑cked
));

120 
boﬁ
 
	gamd_iommu_dump
;

122 
__öôd©a
 
	gamd_iommu_dëe˘ed
;

124 
u16
 
	gamd_iommu_œ°_bdf
;

126 
LIST_HEAD
(
amd_iommu_unôy_m≠
);

128 
boﬁ
 
	gamd_iommu_unm≠_Êush
;

130 
LIST_HEAD
(
amd_iommu_li°
);

134 
amd_iommu
 *
	gamd_iommus
[
MAX_IOMMUS
];

135 
	gamd_iommus_¥e£¡
;

138 
boﬁ
 
amd_iommu_≈_ˇche
 
	g__ªad_mo°ly
;

143 
__öôd©a
 
	gamd_iommu_öô_îr
;

148 
LIST_HEAD
(
amd_iommu_pd_li°
);

149 
•ölock_t
 
	gamd_iommu_pd_lock
;

157 
dev_èbÀ_íåy
 *
	gamd_iommu_dev_èbÀ
;

164 
u16
 *
	gamd_iommu_Æüs_èbÀ
;

170 
amd_iommu
 **
	gamd_iommu_æookup_èbÀ
;

176 *
	gamd_iommu_pd_Æloc_bôm≠
;

178 
u32
 
	gdev_èbÀ_size
;

179 
u32
 
	gÆüs_èbÀ_size
;

180 
u32
 
	gæookup_èbÀ_size
;

182 
ölöe
 
	$upd©e_œ°_devid
(
u16
 
devid
)

184 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

185 
amd_iommu_œ°_bdf
 = 
devid
;

186 
	}
}

188 
ölöe
 
	$tbl_size
(
íåy_size
)

190 
shi·
 = 
PAGE_SHIFT
 +

191 
	`gë_‹dî
((()
amd_iommu_œ°_bdf
 + 1Ë* 
íåy_size
);

193  1UL << 
shi·
;

194 
	}
}

209 
	$iommu_£t_ex˛usi⁄_ønge
(
amd_iommu
 *
iommu
)

211 
u64
 
°¨t
 = 
iommu
->
ex˛usi⁄_°¨t
 & 
PAGE_MASK
;

212 
u64
 
limô
 = (
°¨t
 + 
iommu
->
ex˛usi⁄_Àngth
Ë& 
PAGE_MASK
;

213 
u64
 
íåy
;

215 i‡(!
iommu
->
ex˛usi⁄_°¨t
)

218 
íåy
 = 
°¨t
 | 
MMIO_EXCL_ENABLE_MASK
;

219 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

220 &
íåy
, (entry));

222 
íåy
 = 
limô
;

223 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

224 &
íåy
, (entry));

225 
	}
}

228 
__öô
 
	$iommu_£t_devi˚_èbÀ
(
amd_iommu
 *
iommu
)

230 
u64
 
íåy
;

232 
	`BUG_ON
(
iommu
->
mmio_ba£
 =
NULL
);

234 
íåy
 = 
	`vút_to_phys
(
amd_iommu_dev_èbÀ
);

235 
íåy
 |(
dev_èbÀ_size
 >> 12) - 1;

236 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

237 &
íåy
, (entry));

238 
	}
}

241 
	$iommu_„©uª_íabÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

243 
u32
 
˘æ
;

245 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

246 
˘æ
 |(1 << 
bô
);

247 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

248 
	}
}

250 
	$iommu_„©uª_dißbÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

252 
u32
 
˘æ
;

254 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

255 
˘æ
 &~(1 << 
bô
);

256 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

257 
	}
}

260 
	$iommu_íabÀ
(
amd_iommu
 *
iommu
)

262 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Enabling IOMMUát %s cap 0x%hx\n",

263 
	`dev_«me
(&
iommu
->
dev
->dev), iommu->
ˇp_±r
);

265 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

266 
	}
}

268 
	$iommu_dißbÀ
(
amd_iommu
 *
iommu
)

271 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

274 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

275 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

278 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

279 
	}
}

285 
u8
 * 
__öô
 
	$iommu_m≠_mmio_•a˚
(
u64
 
addªss
)

287 
u8
 *
ªt
;

289 i‡(!
	`ªque°_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
, "amd_iommu"))

290  
NULL
;

292 
ªt
 = 
	`i‹em≠_noˇche
(
addªss
, 
MMIO_REGION_LENGTH
);

293 i‡(
ªt
 !
NULL
)

294  
ªt
;

296 
	`ªÀa£_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
);

298  
NULL
;

299 
	}
}

301 
__öô
 
	$iommu_unm≠_mmio_•a˚
(
amd_iommu
 *
iommu
)

303 i‡(
iommu
->
mmio_ba£
)

304 
	`iounm≠
(
iommu
->
mmio_ba£
);

305 
	`ªÀa£_mem_ªgi⁄
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

306 
	}
}

320 
ölöe
 
	$ivhd_íåy_Àngth
(
u8
 *
ivhd
)

322  0x04 << (*
ivhd
 >> 6);

323 
	}
}

329 
__öô
 
	$föd_œ°_devid_⁄_pci
(
bus
, 
dev
, 
‚
, 
ˇp_±r
)

331 
u32
 
ˇp
;

333 
ˇp
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 
‚
, 
ˇp_±r
+
MMIO_RANGE_OFFSET
);

334 
	`upd©e_œ°_devid
(
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ˇp
), 
	`MMIO_GET_LD
(cap)));

337 
	}
}

343 
__öô
 
	$föd_œ°_devid_‰om_ivhd
(
ivhd_hódî
 *
h
)

345 
u8
 *
p
 = (*)
h
, *
íd
 = (*)h;

346 
ivhd_íåy
 *
dev
;

348 
p
 +(*
h
);

349 
íd
 +
h
->
Àngth
;

351 
	`föd_œ°_devid_⁄_pci
(
	`PCI_BUS
(
h
->
devid
),

352 
	`PCI_SLOT
(
h
->
devid
),

353 
	`PCI_FUNC
(
h
->
devid
),

354 
h
->
ˇp_±r
);

356 
p
 < 
íd
) {

357 
dev
 = (
ivhd_íåy
 *)
p
;

358 
dev
->
ty≥
) {

359 
IVHD_DEV_SELECT
:

360 
IVHD_DEV_RANGE_END
:

361 
IVHD_DEV_ALIAS
:

362 
IVHD_DEV_EXT_SELECT
:

364 
	`upd©e_œ°_devid
(
dev
->
devid
);

369 
p
 +
	`ivhd_íåy_Àngth
(p);

372 
	`WARN_ON
(
p
 !
íd
);

375 
	}
}

382 
__öô
 
	$föd_œ°_devid_a˝i
(
a˝i_èbÀ_hódî
 *
èbÀ
)

384 
i
;

385 
u8
 
checksum
 = 0, *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

386 
ivhd_hódî
 *
h
;

392 
i
 = 0; i < 
èbÀ
->
Àngth
; ++i)

393 
checksum
 +
p
[
i
];

394 i‡(
checksum
 != 0) {

396 
amd_iommu_öô_îr
 = -
ENODEV
;

400 
p
 +
IVRS_HEADER_LENGTH
;

402 
íd
 +
èbÀ
->
Àngth
;

403 
p
 < 
íd
) {

404 
h
 = (
ivhd_hódî
 *)
p
;

405 
h
->
ty≥
) {

406 
ACPI_IVHD_TYPE
:

407 
	`föd_œ°_devid_‰om_ivhd
(
h
);

412 
p
 +
h
->
Àngth
;

414 
	`WARN_ON
(
p
 !
íd
);

417 
	}
}

433 
u8
 * 
__öô
 
	$Æloc_comm™d_buf„r
(
amd_iommu
 *
iommu
)

435 
u8
 *
cmd_buf
 = (u8 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

436 
	`gë_‹dî
(
CMD_BUFFER_SIZE
));

438 i‡(
cmd_buf
 =
NULL
)

439  
NULL
;

441 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
 | 
CMD_BUFFER_UNINITIALIZED
;

443  
cmd_buf
;

444 
	}
}

450 
	$amd_iommu_ª£t_cmd_buf„r
(
amd_iommu
 *
iommu
)

452 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

454 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

455 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

457 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

458 
	}
}

464 
	$iommu_íabÀ_comm™d_buf„r
(
amd_iommu
 *
iommu
)

466 
u64
 
íåy
;

468 
	`BUG_ON
(
iommu
->
cmd_buf
 =
NULL
);

470 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
cmd_buf
);

471 
íåy
 |
MMIO_CMD_SIZE_512
;

473 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

474 &
íåy
, (entry));

476 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

477 
iommu
->
cmd_buf_size
 &~(
CMD_BUFFER_UNINITIALIZED
);

478 
	}
}

480 
__öô
 
	$‰ì_comm™d_buf„r
(
amd_iommu
 *
iommu
)

482 
	`‰ì_∑ges
(()
iommu
->
cmd_buf
,

483 
	`gë_‹dî
(
iommu
->
cmd_buf_size
 & ~(
CMD_BUFFER_UNINITIALIZED
)));

484 
	}
}

487 
u8
 * 
__öô
 
	$Æloc_evít_buf„r
(
amd_iommu
 *
iommu
)

489 
iommu
->
evt_buf
 = (
u8
 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

490 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

492 i‡(
iommu
->
evt_buf
 =
NULL
)

493  
NULL
;

495 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

497  
iommu
->
evt_buf
;

498 
	}
}

500 
	$iommu_íabÀ_evít_buf„r
(
amd_iommu
 *
iommu
)

502 
u64
 
íåy
;

504 
	`BUG_ON
(
iommu
->
evt_buf
 =
NULL
);

506 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
evt_buf
Ë| 
EVT_LEN_MASK
;

508 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

509 &
íåy
, (entry));

512 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

513 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

515 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

516 
	}
}

518 
__öô
 
	$‰ì_evít_buf„r
(
amd_iommu
 *
iommu
)

520 
	`‰ì_∑ges
(()
iommu
->
evt_buf
, 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

521 
	}
}

524 
	$£t_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

526 
i
 = (
bô
 >> 5) & 0x07;

527 
_bô
 = 
bô
 & 0x1f;

529 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] |(1 << 
_bô
);

530 
	}
}

532 
	$gë_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

534 
i
 = (
bô
 >> 5) & 0x07;

535 
_bô
 = 
bô
 & 0x1f;

537  (
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] & (1 << 
_bô
)) >> _bit;

538 
	}
}

541 
	$amd_iommu_≠∂y_îøtum_63
(
u16
 
devid
)

543 
sysmgt
;

545 
sysmgt
 = 
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
) |

546 (
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
) << 1);

548 i‡(
sysmgt
 == 0x01)

549 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_IW
);

550 
	}
}

553 
__öô
 
	$£t_iommu_f‹_devi˚
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

555 
amd_iommu_æookup_èbÀ
[
devid
] = 
iommu
;

556 
	}
}

562 
__öô
 
	$£t_dev_íåy_‰om_a˝i
(
amd_iommu
 *
iommu
,

563 
u16
 
devid
, 
u32
 
Êags
, u32 
ext_Êags
)

565 i‡(
Êags
 & 
ACPI_DEVFLAG_INITPASS
)

566 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_INIT_PASS
);

567 i‡(
Êags
 & 
ACPI_DEVFLAG_EXTINT
)

568 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_EINT_PASS
);

569 i‡(
Êags
 & 
ACPI_DEVFLAG_NMI
)

570 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_NMI_PASS
);

571 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT1
)

572 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
);

573 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT2
)

574 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
);

575 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT0
)

576 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

577 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT1
)

578 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

580 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

582 
	`£t_iommu_f‹_devi˚
(
iommu
, 
devid
);

583 
	}
}

589 
__öô
 
	$£t_devi˚_ex˛usi⁄_ønge
(
u16
 
devid
, 
ivmd_hódî
 *
m
)

591 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

593 i‡(!(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
))

596 i‡(
iommu
) {

602 
	`£t_dev_íåy_bô
(
m
->
devid
, 
DEV_ENTRY_EX
);

603 
iommu
->
ex˛usi⁄_°¨t
 = 
m
->
ønge_°¨t
;

604 
iommu
->
ex˛usi⁄_Àngth
 = 
m
->
ønge_Àngth
;

606 
	}
}

613 
__öô
 
	$öô_iommu_‰om_pci
(
amd_iommu
 *
iommu
)

615 
ˇp_±r
 = 
iommu
->cap_ptr;

616 
u32
 
ønge
, 
misc
;

618 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

619 &
iommu
->
ˇp
);

620 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_RANGE_OFFSET
,

621 &
ønge
);

622 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_MISC_OFFSET
,

623 &
misc
);

625 
iommu
->
fú°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

626 
	`MMIO_GET_FD
(
ønge
));

627 
iommu
->
œ°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

628 
	`MMIO_GET_LD
(
ønge
));

629 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

630 
	}
}

636 
__öô
 
	$öô_iommu_‰om_a˝i
(
amd_iommu
 *
iommu
,

637 
ivhd_hódî
 *
h
)

639 
u8
 *
p
 = (u8 *)
h
;

640 
u8
 *
íd
 = 
p
, 
Êags
 = 0;

641 
u16
 
dev_i
, 
devid
 = 0, 
devid_°¨t
 = 0, 
devid_to
 = 0;

642 
u32
 
ext_Êags
 = 0;

643 
boﬁ
 
Æüs
 = 
Ál£
;

644 
ivhd_íåy
 *
e
;

650 
h
->
Êags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

651 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_HT_TUN_EN
) :

652 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_HT_TUN_EN
);

654 
h
->
Êags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

655 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_PASSPW_EN
) :

656 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_PASSPW_EN
);

658 
h
->
Êags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

659 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

660 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
);

662 
h
->
Êags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

663 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_ISOC_EN
) :

664 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_ISOC_EN
);

669 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_COHERENT_EN
);

674 
p
 +(
ivhd_hódî
);

675 
íd
 +
h
->
Àngth
;

678 
p
 < 
íd
) {

679 
e
 = (
ivhd_íåy
 *)
p
;

680 
e
->
ty≥
) {

681 
IVHD_DEV_ALL
:

683 
	`DUMP_¥ötk
(" DEV_ALL\t\t\t first devid: %02x:%02x.%x"

685 
	`PCI_BUS
(
iommu
->
fú°_devi˚
),

686 
	`PCI_SLOT
(
iommu
->
fú°_devi˚
),

687 
	`PCI_FUNC
(
iommu
->
fú°_devi˚
),

688 
	`PCI_BUS
(
iommu
->
œ°_devi˚
),

689 
	`PCI_SLOT
(
iommu
->
œ°_devi˚
),

690 
	`PCI_FUNC
(
iommu
->
œ°_devi˚
),

691 
e
->
Êags
);

693 
dev_i
 = 
iommu
->
fú°_devi˚
;

694 
dev_i
 <
iommu
->
œ°_devi˚
; ++dev_i)

695 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

696 
e
->
Êags
, 0);

698 
IVHD_DEV_SELECT
:

700 
	`DUMP_¥ötk
(" DEV_SELECT\t\t\t devid: %02x:%02x.%x "

702 
	`PCI_BUS
(
e
->
devid
),

703 
	`PCI_SLOT
(
e
->
devid
),

704 
	`PCI_FUNC
(
e
->
devid
),

705 
e
->
Êags
);

707 
devid
 = 
e
->devid;

708 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
, 0);

710 
IVHD_DEV_SELECT_RANGE_START
:

712 
	`DUMP_¥ötk
(" DEV_SELECT_RANGE_START\t "

714 
	`PCI_BUS
(
e
->
devid
),

715 
	`PCI_SLOT
(
e
->
devid
),

716 
	`PCI_FUNC
(
e
->
devid
),

717 
e
->
Êags
);

719 
devid_°¨t
 = 
e
->
devid
;

720 
Êags
 = 
e
->flags;

721 
ext_Êags
 = 0;

722 
Æüs
 = 
Ál£
;

724 
IVHD_DEV_ALIAS
:

726 
	`DUMP_¥ötk
(" DEV_ALIAS\t\t\t devid: %02x:%02x.%x "

728 
	`PCI_BUS
(
e
->
devid
),

729 
	`PCI_SLOT
(
e
->
devid
),

730 
	`PCI_FUNC
(
e
->
devid
),

731 
e
->
Êags
,

732 
	`PCI_BUS
(
e
->
ext
 >> 8),

733 
	`PCI_SLOT
(
e
->
ext
 >> 8),

734 
	`PCI_FUNC
(
e
->
ext
 >> 8));

736 
devid
 = 
e
->devid;

737 
devid_to
 = 
e
->
ext
 >> 8;

738 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
 , 
e
->
Êags
, 0);

739 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid_to
, 
e
->
Êags
, 0);

740 
amd_iommu_Æüs_èbÀ
[
devid
] = 
devid_to
;

742 
IVHD_DEV_ALIAS_RANGE
:

744 
	`DUMP_¥ötk
(" DEV_ALIAS_RANGE\t\t "

747 
	`PCI_BUS
(
e
->
devid
),

748 
	`PCI_SLOT
(
e
->
devid
),

749 
	`PCI_FUNC
(
e
->
devid
),

750 
e
->
Êags
,

751 
	`PCI_BUS
(
e
->
ext
 >> 8),

752 
	`PCI_SLOT
(
e
->
ext
 >> 8),

753 
	`PCI_FUNC
(
e
->
ext
 >> 8));

755 
devid_°¨t
 = 
e
->
devid
;

756 
Êags
 = 
e
->flags;

757 
devid_to
 = 
e
->
ext
 >> 8;

758 
ext_Êags
 = 0;

759 
Æüs
 = 
åue
;

761 
IVHD_DEV_EXT_SELECT
:

763 
	`DUMP_¥ötk
(" DEV_EXT_SELECT\t\t devid: %02x:%02x.%x "

765 
	`PCI_BUS
(
e
->
devid
),

766 
	`PCI_SLOT
(
e
->
devid
),

767 
	`PCI_FUNC
(
e
->
devid
),

768 
e
->
Êags
,É->
ext
);

770 
devid
 = 
e
->devid;

771 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
,

772 
e
->
ext
);

774 
IVHD_DEV_EXT_SELECT_RANGE
:

776 
	`DUMP_¥ötk
(" DEV_EXT_SELECT_RANGE\t devid: "

778 
	`PCI_BUS
(
e
->
devid
),

779 
	`PCI_SLOT
(
e
->
devid
),

780 
	`PCI_FUNC
(
e
->
devid
),

781 
e
->
Êags
,É->
ext
);

783 
devid_°¨t
 = 
e
->
devid
;

784 
Êags
 = 
e
->flags;

785 
ext_Êags
 = 
e
->
ext
;

786 
Æüs
 = 
Ál£
;

788 
IVHD_DEV_RANGE_END
:

790 
	`DUMP_¥ötk
(" DEV_RANGE_END\t\t devid: %02x:%02x.%x\n",

791 
	`PCI_BUS
(
e
->
devid
),

792 
	`PCI_SLOT
(
e
->
devid
),

793 
	`PCI_FUNC
(
e
->
devid
));

795 
devid
 = 
e
->devid;

796 
dev_i
 = 
devid_°¨t
; dev_ò<
devid
; ++dev_i) {

797 i‡(
Æüs
) {

798 
amd_iommu_Æüs_èbÀ
[
dev_i
] = 
devid_to
;

799 
	`£t_dev_íåy_‰om_a˝i
(
iommu
,

800 
devid_to
, 
Êags
, 
ext_Êags
);

802 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

803 
Êags
, 
ext_Êags
);

810 
p
 +
	`ivhd_íåy_Àngth
(p);

812 
	}
}

815 
__öô
 
	$öô_iommu_devi˚s
(
amd_iommu
 *
iommu
)

817 
u16
 
i
;

819 
i
 = 
iommu
->
fú°_devi˚
; i <iommu->
œ°_devi˚
; ++i)

820 
	`£t_iommu_f‹_devi˚
(
iommu
, 
i
);

823 
	}
}

825 
__öô
 
	$‰ì_iommu_⁄e
(
amd_iommu
 *
iommu
)

827 
	`‰ì_comm™d_buf„r
(
iommu
);

828 
	`‰ì_evít_buf„r
(
iommu
);

829 
	`iommu_unm≠_mmio_•a˚
(
iommu
);

830 
	}
}

832 
__öô
 
	$‰ì_iommu_Æl
()

834 
amd_iommu
 *
iommu
, *
√xt
;

836 
	`f‹_óch_iommu_ß„
(
iommu
, 
√xt
) {

837 
	`li°_dñ
(&
iommu
->
li°
);

838 
	`‰ì_iommu_⁄e
(
iommu
);

839 
	`k‰ì
(
iommu
);

841 
	}
}

848 
__öô
 
	$öô_iommu_⁄e
(
amd_iommu
 *
iommu
, 
ivhd_hódî
 *
h
)

850 
	`•ö_lock_öô
(&
iommu
->
lock
);

853 
	`li°_add_èû
(&
iommu
->
li°
, &
amd_iommu_li°
);

854 
iommu
->
ödex
 = 
amd_iommus_¥e£¡
++;

856 i‡(
	`u∆ikñy
(
iommu
->
ödex
 >
MAX_IOMMUS
)) {

857 
	`WARN
(1, "AMD-Vi: System has more IOMMUsÅhan supported byÅhis driver\n");

858  -
ENOSYS
;

862 
amd_iommus
[
iommu
->
ödex
] = iommu;

867 
iommu
->
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

868 i‡(!
iommu
->
dev
)

871 
iommu
->
ˇp_±r
 = 
h
->cap_ptr;

872 
iommu
->
pci_£g
 = 
h
->pci_seg;

873 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

874 
iommu
->
mmio_ba£
 = 
	`iommu_m≠_mmio_•a˚
(
h
->
mmio_phys
);

875 i‡(!
iommu
->
mmio_ba£
)

876  -
ENOMEM
;

878 
iommu
->
cmd_buf
 = 
	`Æloc_comm™d_buf„r
(iommu);

879 i‡(!
iommu
->
cmd_buf
)

880  -
ENOMEM
;

882 
iommu
->
evt_buf
 = 
	`Æloc_evít_buf„r
(iommu);

883 i‡(!
iommu
->
evt_buf
)

884  -
ENOMEM
;

886 
iommu
->
öt_íabÀd
 = 
Ál£
;

888 
	`öô_iommu_‰om_pci
(
iommu
);

889 
	`öô_iommu_‰om_a˝i
(
iommu
, 
h
);

890 
	`öô_iommu_devi˚s
(
iommu
);

892 i‡(
iommu
->
ˇp
 & (1UL << 
IOMMU_CAP_NPCACHE
))

893 
amd_iommu_≈_ˇche
 = 
åue
;

895  
	`pci_íabÀ_devi˚
(
iommu
->
dev
);

896 
	}
}

902 
__öô
 
	$öô_iommu_Æl
(
a˝i_èbÀ_hódî
 *
èbÀ
)

904 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

905 
ivhd_hódî
 *
h
;

906 
amd_iommu
 *
iommu
;

907 
ªt
;

909 
íd
 +
èbÀ
->
Àngth
;

910 
p
 +
IVRS_HEADER_LENGTH
;

912 
p
 < 
íd
) {

913 
h
 = (
ivhd_hódî
 *)
p
;

914 *
p
) {

915 
ACPI_IVHD_TYPE
:

917 
	`DUMP_¥ötk
("device: %02x:%02x.%01x cap: %04x "

919 
	`PCI_BUS
(
h
->
devid
), 
	`PCI_SLOT
(h->devid),

920 
	`PCI_FUNC
(
h
->
devid
), h->
ˇp_±r
,

921 
h
->
pci_£g
, h->
Êags
, h->
öfo
);

922 
	`DUMP_¥ötk
(" mmio-addr: %016llx\n",

923 
h
->
mmio_phys
);

925 
iommu
 = 
	`kzÆloc
((
amd_iommu
), 
GFP_KERNEL
);

926 i‡(
iommu
 =
NULL
) {

927 
amd_iommu_öô_îr
 = -
ENOMEM
;

931 
ªt
 = 
	`öô_iommu_⁄e
(
iommu
, 
h
);

932 i‡(
ªt
) {

933 
amd_iommu_öô_îr
 = 
ªt
;

940 
p
 +
h
->
Àngth
;

943 
	`WARN_ON
(
p
 !
íd
);

946 
	}
}

957 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

959 
r
;

961 i‡(
	`pci_íabÀ_msi
(
iommu
->
dev
))

964 
r
 = 
	`ªque°_úq
(
iommu
->
dev
->
úq
, 
amd_iommu_öt_h™dÀr
,

965 
IRQF_SAMPLE_RANDOM
,

967 
NULL
);

969 i‡(
r
) {

970 
	`pci_dißbÀ_msi
(
iommu
->
dev
);

974 
iommu
->
öt_íabÀd
 = 
åue
;

975 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

978 
	}
}

980 
	$iommu_öô_msi
(
amd_iommu
 *
iommu
)

982 i‡(
iommu
->
öt_íabÀd
)

985 i‡(
	`pci_föd_ˇ∑bûôy
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

986  
	`iommu_£tup_msi
(
iommu
);

989 
	}
}

999 
__öô
 
	$‰ì_unôy_m≠s
()

1001 
unôy_m≠_íåy
 *
íåy
, *
√xt
;

1003 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, &
amd_iommu_unôy_m≠
, 
li°
) {

1004 
	`li°_dñ
(&
íåy
->
li°
);

1005 
	`k‰ì
(
íåy
);

1007 
	}
}

1010 
__öô
 
	$öô_ex˛usi⁄_ønge
(
ivmd_hódî
 *
m
)

1012 
i
;

1014 
m
->
ty≥
) {

1015 
ACPI_IVMD_TYPE
:

1016 
	`£t_devi˚_ex˛usi⁄_ønge
(
m
->
devid
, m);

1018 
ACPI_IVMD_TYPE_ALL
:

1019 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1020 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1022 
ACPI_IVMD_TYPE_RANGE
:

1023 
i
 = 
m
->
devid
; i <m->
aux
; ++i)

1024 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1031 
	}
}

1034 
__öô
 
	$öô_unôy_m≠_ønge
(
ivmd_hódî
 *
m
)

1036 
unôy_m≠_íåy
 *
e
 = 0;

1037 *
s
;

1039 
e
 = 
	`kzÆloc
((*e), 
GFP_KERNEL
);

1040 i‡(
e
 =
NULL
)

1041  -
ENOMEM
;

1043 
m
->
ty≥
) {

1045 
	`k‰ì
(
e
);

1047 
ACPI_IVMD_TYPE
:

1048 
s
 = "IVMD_TYPEi\t\t\t";

1049 
e
->
devid_°¨t
 =É->
devid_íd
 = 
m
->
devid
;

1051 
ACPI_IVMD_TYPE_ALL
:

1052 
s
 = "IVMD_TYPE_ALL\t\t";

1053 
e
->
devid_°¨t
 = 0;

1054 
e
->
devid_íd
 = 
amd_iommu_œ°_bdf
;

1056 
ACPI_IVMD_TYPE_RANGE
:

1057 
s
 = "IVMD_TYPE_RANGE\t\t";

1058 
e
->
devid_°¨t
 = 
m
->
devid
;

1059 
e
->
devid_íd
 = 
m
->
aux
;

1062 
e
->
addªss_°¨t
 = 
	`PAGE_ALIGN
(
m
->
ønge_°¨t
);

1063 
e
->
addªss_íd
 =É->
addªss_°¨t
 + 
	`PAGE_ALIGN
(
m
->
ønge_Àngth
);

1064 
e
->
¥Ÿ
 = 
m
->
Êags
 >> 1;

1066 
	`DUMP_¥ötk
("%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x"

1067 "Ñ™ge_°¨t: %016ŒxÑ™ge_íd: %016Œx fœgs: %x\n", 
s
,

1068 
	`PCI_BUS
(
e
->
devid_°¨t
), 
	`PCI_SLOT
(e->devid_start),

1069 
	`PCI_FUNC
(
e
->
devid_°¨t
), 
	`PCI_BUS
”->
devid_íd
),

1070 
	`PCI_SLOT
(
e
->
devid_íd
), 
	`PCI_FUNC
(e->devid_end),

1071 
e
->
addªss_°¨t
,É->
addªss_íd
, 
m
->
Êags
);

1073 
	`li°_add_èû
(&
e
->
li°
, &
amd_iommu_unôy_m≠
);

1076 
	}
}

1079 
__öô
 
	$öô_mem‹y_deföôi⁄s
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1081 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

1082 
ivmd_hódî
 *
m
;

1084 
íd
 +
èbÀ
->
Àngth
;

1085 
p
 +
IVRS_HEADER_LENGTH
;

1087 
p
 < 
íd
) {

1088 
m
 = (
ivmd_hódî
 *)
p
;

1089 i‡(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
)

1090 
	`öô_ex˛usi⁄_ønge
(
m
);

1091 i‡(
m
->
Êags
 & 
IVMD_FLAG_UNITY_MAP
)

1092 
	`öô_unôy_m≠_ønge
(
m
);

1094 
p
 +
m
->
Àngth
;

1098 
	}
}

1104 
	$öô_devi˚_èbÀ
()

1106 
u16
 
devid
;

1108 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid) {

1109 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_VALID
);

1110 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_TRANSLATION
);

1112 
	}
}

1118 
	$íabÀ_iommus
()

1120 
amd_iommu
 *
iommu
;

1122 
	`f‹_óch_iommu
(
iommu
) {

1123 
	`iommu_dißbÀ
(
iommu
);

1124 
	`iommu_£t_devi˚_èbÀ
(
iommu
);

1125 
	`iommu_íabÀ_comm™d_buf„r
(
iommu
);

1126 
	`iommu_íabÀ_evít_buf„r
(
iommu
);

1127 
	`iommu_£t_ex˛usi⁄_ønge
(
iommu
);

1128 
	`iommu_öô_msi
(
iommu
);

1129 
	`iommu_íabÀ
(
iommu
);

1131 
	}
}

1133 
	$dißbÀ_iommus
()

1135 
amd_iommu
 *
iommu
;

1137 
	`f‹_óch_iommu
(
iommu
)

1138 
	`iommu_dißbÀ
(
iommu
);

1139 
	}
}

1146 
	$amd_iommu_ªsume
(
sys_devi˚
 *
dev
)

1149 
	`íabÀ_iommus
();

1155 
	`amd_iommu_Êush_Æl_devi˚s
();

1156 
	`amd_iommu_Êush_Æl_domaös
();

1159 
	}
}

1161 
	$amd_iommu_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1164 
	`dißbÀ_iommus
();

1167 
	}
}

1169 
sysdev_˛ass
 
	gamd_iommu_sysdev_˛ass
 = {

1170 .
«me
 = "amd_iommu",

1171 .
	gsu•íd
 = 
amd_iommu_su•íd
,

1172 .
	gªsume
 = 
amd_iommu_ªsume
,

1175 
sys_devi˚
 
	gdevi˚_amd_iommu
 = {

1176 .
id
 = 0,

1177 .
	g˛s
 = &
amd_iommu_sysdev_˛ass
,

1208 
__öô
 
	$amd_iommu_öô
()

1210 
i
, 
ªt
 = 0;

1217 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
föd_œ°_devid_a˝i
) != 0)

1218  -
ENODEV
;

1220 
ªt
 = 
amd_iommu_öô_îr
;

1221 i‡(
ªt
)

1222 
out
;

1224 
dev_èbÀ_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1225 
Æüs_èbÀ_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1226 
æookup_èbÀ_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1228 
ªt
 = -
ENOMEM
;

1231 
amd_iommu_dev_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1232 
	`gë_‹dî
(
dev_èbÀ_size
));

1233 i‡(
amd_iommu_dev_èbÀ
 =
NULL
)

1234 
out
;

1240 
amd_iommu_Æüs_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1241 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1242 i‡(
amd_iommu_Æüs_èbÀ
 =
NULL
)

1243 
‰ì
;

1246 
amd_iommu_æookup_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(

1247 
GFP_KERNEL
 | 
__GFP_ZERO
,

1248 
	`gë_‹dî
(
æookup_èbÀ_size
));

1249 i‡(
amd_iommu_æookup_èbÀ
 =
NULL
)

1250 
‰ì
;

1252 
amd_iommu_pd_Æloc_bôm≠
 = (*)
	`__gë_‰ì_∑ges
(

1253 
GFP_KERNEL
 | 
__GFP_ZERO
,

1254 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1255 i‡(
amd_iommu_pd_Æloc_bôm≠
 =
NULL
)

1256 
‰ì
;

1259 
	`öô_devi˚_èbÀ
();

1264 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1265 
amd_iommu_Æüs_èbÀ
[
i
] = i;

1271 
amd_iommu_pd_Æloc_bôm≠
[0] = 1;

1273 
	`•ö_lock_öô
(&
amd_iommu_pd_lock
);

1279 
ªt
 = -
ENODEV
;

1280 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_iommu_Æl
) != 0)

1281 
‰ì
;

1283 i‡(
amd_iommu_öô_îr
) {

1284 
ªt
 = 
amd_iommu_öô_îr
;

1285 
‰ì
;

1288 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_mem‹y_deföôi⁄s
) != 0)

1289 
‰ì
;

1291 i‡(
amd_iommu_öô_îr
) {

1292 
ªt
 = 
amd_iommu_öô_îr
;

1293 
‰ì
;

1296 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
amd_iommu_sysdev_˛ass
);

1297 i‡(
ªt
)

1298 
‰ì
;

1300 
ªt
 = 
	`sysdev_ªgi°î
(&
devi˚_amd_iommu
);

1301 i‡(
ªt
)

1302 
‰ì
;

1304 
ªt
 = 
	`amd_iommu_öô_devi˚s
();

1305 i‡(
ªt
)

1306 
‰ì
;

1308 
	`íabÀ_iommus
();

1310 i‡(
iommu_∑ss_through
)

1311 
ªt
 = 
	`amd_iommu_öô_∑s°hrough
();

1313 
ªt
 = 
	`amd_iommu_öô_dma_›s
();

1315 i‡(
ªt
)

1316 
‰ì
;

1318 
	`amd_iommu_öô_≠i
();

1320 
	`amd_iommu_öô_nŸifõr
();

1322 i‡(
iommu_∑ss_through
)

1323 
out
;

1325 i‡(
amd_iommu_unm≠_Êush
)

1326 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: IO/TLB flush on unmapÉnabled\n");

1328 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Lazy IO/TLB flushingÉnabled\n");

1330 
x86_∂©f‹m
.
iommu_shutdown
 = 
dißbÀ_iommus
;

1331 
out
:

1332  
ªt
;

1334 
‰ì
:

1335 
	`dißbÀ_iommus
();

1337 
	`amd_iommu_unöô_devi˚s
();

1339 
	`‰ì_∑ges
(()
amd_iommu_pd_Æloc_bôm≠
,

1340 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1342 
	`‰ì_∑ges
(()
amd_iommu_æookup_èbÀ
,

1343 
	`gë_‹dî
(
æookup_èbÀ_size
));

1345 
	`‰ì_∑ges
(()
amd_iommu_Æüs_èbÀ
,

1346 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1348 
	`‰ì_∑ges
(()
amd_iommu_dev_èbÀ
,

1349 
	`gë_‹dî
(
dev_èbÀ_size
));

1351 
	`‰ì_iommu_Æl
();

1353 
	`‰ì_unôy_m≠s
();

1355 
out
;

1356 
	}
}

1365 
__öô
 
	$óæy_amd_iommu_dëe˘
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1368 
	}
}

1370 
__öô
 
	$amd_iommu_dëe˘
()

1372 i‡(
no_iommu
 || (
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
))

1375 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
óæy_amd_iommu_dëe˘
) == 0) {

1376 
iommu_dëe˘ed
 = 1;

1377 
amd_iommu_dëe˘ed
 = 1;

1378 
x86_öô
.
iommu
.
iommu_öô
 = 
amd_iommu_öô
;

1381 
	`pci_ªque°_acs
();

1383 
	}
}

1392 
__öô
 
	$∑r£_amd_iommu_dump
(*
°r
)

1394 
amd_iommu_dump
 = 
åue
;

1397 
	}
}

1399 
__öô
 
	$∑r£_amd_iommu_›ti⁄s
(*
°r
)

1401 ; *
°r
; ++str) {

1402 i‡(
	`°∫cmp
(
°r
, "fullflush", 9) == 0)

1403 
amd_iommu_unm≠_Êush
 = 
åue
;

1407 
	}
}

1409 
__£tup
("amd_iommu_dump", 
∑r£_amd_iommu_dump
);

1410 
__£tup
("amd_iommu=", 
∑r£_amd_iommu_›ti⁄s
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/boŸmem.h
>

17 
	~<löux/mmz⁄e.h
>

18 
	~<löux/pci_ids.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/su•íd.h
>

23 
	~<löux/kmemÀak.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/io.h
>

26 
	~<asm/iommu.h
>

27 
	~<asm/g¨t.h
>

28 
	~<asm/pci-dúe˘.h
>

29 
	~<asm/dma.h
>

30 
	~<asm/k8.h
>

31 
	~<asm/x86_öô.h
>

33 
	gg¨t_iommu_≠îtuª
;

34 
g¨t_iommu_≠îtuª_dißbÀd
 
	g__öôd©a
;

35 
g¨t_iommu_≠îtuª_Ælowed
 
	g__öôd©a
;

37 
ÁŒback_≠î_‹dî
 
	g__öôd©a
 = 1;

38 
ÁŒback_≠î_f‹˚
 
	g__öôd©a
;

40 
fix_≠îtuª
 
	g__öôd©a
 = 1;

42 
	sbus_dev_ønge
 {

43 
	mbus
;

44 
	mdev_ba£
;

45 
	mdev_limô
;

48 
bus_dev_ønge
 
	gbus_dev_ønges
[] 
	g__öôd©a
 = {

54 
ªsour˚
 
	gg¨t_ªsour˚
 = {

55 .
«me
 = "GART",

56 .
	gÊags
 = 
IORESOURCE_MEM
,

59 
__öô
 
	$ö£π_≠îtuª_ªsour˚
(
u32
 
≠î_ba£
, u32 
≠î_size
)

61 
g¨t_ªsour˚
.
°¨t
 = 
≠î_ba£
;

62 
g¨t_ªsour˚
.
íd
 = 
≠î_ba£
 + 
≠î_size
 - 1;

63 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
g¨t_ªsour˚
);

64 
	}
}

69 
u32
 
__öô
 
	$Æloˇã_≠îtuª
()

71 
u32
 
≠î_size
;

72 *
p
;

75 i‡(
ÁŒback_≠î_‹dî
 > 5)

76 
ÁŒback_≠î_‹dî
 = 5;

77 
≠î_size
 = (32 * 1024 * 1024Ë<< 
ÁŒback_≠î_‹dî
;

98 
p
 = 
	`__Æloc_boŸmem_n›™ic
(
≠î_size
,áper_size, 512ULL<<20);

103 
	`kmemÀak_ign‹e
(
p
);

104 i‡(!
p
 || 
	`__∑
’)+
≠î_size
 > 0xffffffff) {

105 
	`¥ötk
(
KERN_ERR


107 
p
, 
≠î_size
>>10);

108 i‡(
p
)

109 
	`‰ì_boŸmem
(
	`__∑
(
p
), 
≠î_size
);

112 
	`¥ötk
(
KERN_INFO
 "Mappingáperture over %d KB of RAM @ %lx\n",

113 
≠î_size
 >> 10, 
	`__∑
(
p
));

114 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
	`__∑
(
p
), 
≠î_size
);

115 
	`ªgi°î_noßve_ªgi⁄
((
u32
)
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

116 (
u32
)
	`__∑
(
p
+
≠î_size
Ë>> 
PAGE_SHIFT
);

118  (
u32
)
	`__∑
(
p
);

119 
	}
}

123 
u32
 
__öô
 
	$föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
)

125 
byãs
;

126 
u8
 
pos
;

128 i‡(!(
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

129 
PCI_STATUS_CAP_LIST
))

132 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

133 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

134 
u8
 
id
;

136 
pos
 &= ~3;

137 
id
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

138 i‡(
id
 == 0xff)

140 i‡(
id
 =
ˇp
)

141  
pos
;

142 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

143 
pos
+
PCI_CAP_LIST_NEXT
);

146 
	}
}

149 
u32
 
__öô
 
	$ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
, 
u32
 *
‹dî
)

151 
u32
 
≠size
;

152 
u32
 
≠sizîeg
;

153 
nbôs
;

154 
u32
 
≠î_low
, 
≠î_hi
;

155 
u64
 
≠î
;

156 
u32
 
ﬁd_‹dî
;

158 
	`¥ötk
(
KERN_INFO
 "AGP bridgê© %02x:%02x:%02x\n", 
bus
, 
¶Ÿ
, 
func
);

159 
≠sizîeg
 = 
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
 + 0x14);

160 i‡(
≠sizîeg
 == 0xffffffff) {

161 
	`¥ötk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

166 
ﬁd_‹dî
 = *
‹dî
;

168 
≠size
 = 
≠sizîeg
 & 0xfff;

170 i‡(
≠size
 & 0xff)

171 
≠size
 |= 0xf00;

172 
nbôs
 = 
	`hweight16
(
≠size
);

173 *
‹dî
 = 7 - 
nbôs
;

174 i‡(()*
‹dî
 < 0)

175 *
‹dî
 = 0;

177 
≠î_low
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x10);

178 
≠î_hi
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x14);

179 
≠î
 = (
≠î_low
 & ~((1<<22)-1)Ë| ((
u64
)
≠î_hi
 << 32);

185 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

186 
≠î
, 32 << 
ﬁd_‹dî
);

187 i‡(
≠î
 + (32ULL<<(20 + *
‹dî
)) > 0x100000000ULL) {

188 
	`¥ötk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) isÇotÑight, using settings from NB\n",

189 32 << *
‹dî
, 
≠sizîeg
);

190 *
‹dî
 = 
ﬁd_‹dî
;

193 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

194 
≠î
, 32 << *
‹dî
, 
≠sizîeg
);

196 i‡(!
	`≠îtuª_vÆid
(
≠î
, (32*1024*1024Ë<< *
‹dî
, 32<<20))

198  (
u32
)
≠î
;

199 
	}
}

214 
u32
 
__öô
 
	$£¨ch_agp_bridge
(
u32
 *
‹dî
, *
vÆid_agp
)

216 
bus
, 
¶Ÿ
, 
func
;

219 
bus
 = 0; bus < 256; bus++) {

220 
¶Ÿ
 = 0; slot < 32; slot++) {

221 
func
 = 0; func < 8; func++) {

222 
u32
 
˛ass
, 
ˇp
;

223 
u8
 
ty≥
;

224 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
,

225 
PCI_CLASS_REVISION
);

226 i‡(
˛ass
 == 0xffffffff)

229 
˛ass
 >> 16) {

230 
PCI_CLASS_BRIDGE_HOST
:

231 
PCI_CLASS_BRIDGE_OTHER
:

233 
ˇp
 = 
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
,

234 
PCI_CAP_ID_AGP
);

235 i‡(!
ˇp
)

237 *
vÆid_agp
 = 1;

238  
	`ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
,

239 
‹dî
);

243 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

244 
PCI_HEADER_TYPE
);

245 i‡(!(
ty≥
 & 0x80))

250 
	`¥ötk
(
KERN_INFO
 "No AGP bridge found\n");

253 
	}
}

255 
g¨t_fix_e820
 
	g__öôd©a
 = 1;

257 
__öô
 
	$∑r£_g¨t_mem
(*
p
)

259 i‡(!
p
)

260  -
EINVAL
;

262 i‡(!
	`°∫cmp
(
p
, "off", 3))

263 
g¨t_fix_e820
 = 0;

264 i‡(!
	`°∫cmp
(
p
, "on", 2))

265 
g¨t_fix_e820
 = 1;

268 
	}
}

269 
óæy_∑øm
("g¨t_fix_e820", 
∑r£_g¨t_mem
);

271 
__öô
 
	$óæy_g¨t_iommu_check
()

283 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

284 
i
, 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

285 
u32
 
˘l
;

286 
u32
 
≠î_size
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

287 
u64
 
≠î_ba£
 = 0, 
œ°_≠î_ba£
 = 0;

288 
≠î_íabÀd
 = 0, 
œ°_≠î_íabÀd
 = 0, 
œ°_vÆid
 = 0;

290 i‡(!
	`óæy_pci_Ælowed
())

294 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

296 
fix
 = 0;

297 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

298 
bus
;

299 
dev_ba£
, 
dev_limô
;

301 
bus
 = 
bus_dev_ønges
[
i
].bus;

302 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

303 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

305 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

306 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

309 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

310 
≠î_íabÀd
 = 
˘l
 & 
AMD64_GARTEN
;

311 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

312 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

313 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

314 
≠î_ba£
 <<= 25;

316 i‡(
œ°_vÆid
) {

317 i‡((
≠î_‹dî
 !
œ°_≠î_‹dî
) ||

318 (
≠î_ba£
 !
œ°_≠î_ba£
) ||

319 (
≠î_íabÀd
 !
œ°_≠î_íabÀd
)) {

320 
fix
 = 1;

325 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

326 
œ°_≠î_ba£
 = 
≠î_ba£
;

327 
œ°_≠î_íabÀd
 = 
≠î_íabÀd
;

328 
œ°_vÆid
 = 1;

332 i‡(!
fix
 && !
≠î_íabÀd
)

335 i‡(!
≠î_ba£
 || !
≠î_size
 ||áper_base +áper_size > 0x100000000UL)

336 
fix
 = 1;

338 i‡(
g¨t_fix_e820
 && !
fix
 && 
≠î_íabÀd
) {

339 i‡(
	`e820_™y_m≠≥d
(
≠î_ba£
,á≥r_ba£ + 
≠î_size
,

340 
E820_RAM
)) {

342 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for GART\n");

343 
	`e820_add_ªgi⁄
(
≠î_ba£
, 
≠î_size
, 
E820_RESERVED
);

344 
	`upd©e_e820
();

348 i‡(
vÆid_agp
)

352 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

353 
bus
;

354 
dev_ba£
, 
dev_limô
;

356 
bus
 = 
bus_dev_ønges
[
i
].bus;

357 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

358 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

360 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

361 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

364 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

365 
˘l
 &~
AMD64_GARTEN
;

366 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

370 
	}
}

372 
__öôd©a
 
	g¥öãd_g¨t_size_msg
;

374 
__öô
 
	$g¨t_iommu_hﬁe_öô
()

376 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

377 
u32
 
≠î_size
, 
≠î_Æloc
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

378 
u64
 
≠î_ba£
, 
œ°_≠î_ba£
 = 0;

379 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

380 
i
, 
node
;

382 i‡(
g¨t_iommu_≠îtuª_dißbÀd
 || !
fix_≠îtuª
 ||

383 !
	`óæy_pci_Ælowed
())

386 
	`¥ötk
(
KERN_INFO
 "Checkingáperture...\n");

388 i‡(!
ÁŒback_≠î_f‹˚
)

389 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

391 
fix
 = 0;

392 
node
 = 0;

393 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

394 
bus
;

395 
dev_ba£
, 
dev_limô
;

396 
u32
 
˘l
;

398 
bus
 = 
bus_dev_ønges
[
i
].bus;

399 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

400 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

402 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

403 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

406 
iommu_dëe˘ed
 = 1;

407 
g¨t_iommu_≠îtuª
 = 1;

408 
x86_öô
.
iommu
.
iommu_öô
 = 
g¨t_iommu_öô
;

410 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3,

411 
AMD64_GARTAPERTURECTL
);

419 
˘l
 &~
GARTEN
;

420 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

422 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

423 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

424 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

425 
≠î_ba£
 <<= 25;

427 
	`¥ötk
(
KERN_INFO
 "Node %d:áperture @ %Lx size %u MB\n",

428 
node
, 
≠î_ba£
, 
≠î_size
 >> 20);

429 
node
++;

431 i‡(!
	`≠îtuª_vÆid
(
≠î_ba£
, 
≠î_size
, 64<<20)) {

432 i‡(
vÆid_agp
 && 
agp_≠î_ba£
 &&

433 
agp_≠î_ba£
 =
≠î_ba£
 &&

434 
agp_≠î_‹dî
 =
≠î_‹dî
) {

436 i‡(!
no_iommu
 &&

437 
max_p‚
 > 
MAX_DMA32_PFN
 &&

438 !
¥öãd_g¨t_size_msg
) {

439 
	`¥ötk
(
KERN_ERR
 "youáre using iommu withágp, but GART size isÜessÅhan 64M\n");

440 
	`¥ötk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

441 
	`¥ötk
(
KERN_ERR
 "if BIOS doesn't haveÅhat option, contact your HW vendor!\n");

442 
¥öãd_g¨t_size_msg
 = 1;

445 
fix
 = 1;

446 
out
;

450 i‡((
œ°_≠î_‹dî
 && 
≠î_‹dî
 !=Üast_aper_order) ||

451 (
œ°_≠î_ba£
 && 
≠î_ba£
 !=Üast_aper_base)) {

452 
fix
 = 1;

453 
out
;

455 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

456 
œ°_≠î_ba£
 = 
≠î_ba£
;

460 
out
:

461 i‡(!
fix
 && !
ÁŒback_≠î_f‹˚
) {

462 i‡(
œ°_≠î_ba£
) {

463 
n
 = (32 * 1024 * 1024Ë<< 
œ°_≠î_‹dî
;

465 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
œ°_≠î_ba£
, 
n
);

470 i‡(!
ÁŒback_≠î_f‹˚
) {

471 
≠î_Æloc
 = 
agp_≠î_ba£
;

472 
≠î_‹dî
 = 
agp_≠î_‹dî
;

475 i‡(
≠î_Æloc
) {

477 } i‡((!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

478 
f‹˚_iommu
 ||

479 
vÆid_agp
 ||

480 
ÁŒback_≠î_f‹˚
) {

481 
	`¥ötk
(
KERN_INFO


483 
	`¥ötk
(
KERN_INFO


485 
	`¥ötk
(
KERN_INFO


487 32 << 
ÁŒback_≠î_‹dî
);

489 
≠î_‹dî
 = 
ÁŒback_≠î_‹dî
;

490 
≠î_Æloc
 = 
	`Æloˇã_≠îtuª
();

491 i‡(!
≠î_Æloc
) {

500 
	`∑nic
("NotÉnough memory foráperture");

507 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

508 
bus
;

509 
dev_ba£
, 
dev_limô
;

511 
bus
 = 
bus_dev_ønges
[
i
].bus;

512 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

513 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

514 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

515 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

521 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
≠î_‹dî
 << 1);

522 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
, 
≠î_Æloc
 >> 25);

526 
	`£t_up_g¨t_ªsume
(
≠î_‹dî
, 
≠î_Æloc
);

527 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<löux/≥rf_evít.h
>

18 
	~<löux/kî√l_°©.h
>

19 
	~<löux/mc146818πc.h
>

20 
	~<löux/a˝i_pmtmr.h
>

21 
	~<löux/˛ockchùs.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/·ø˚.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/moduÀ.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/dñay.h
>

29 
	~<löux/timex.h
>

30 
	~<löux/dm¨.h
>

31 
	~<löux/öô.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/dmi.h
>

34 
	~<löux/nmi.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/≥rf_evít.h
>

39 
	~<asm/x86_öô.h
>

40 
	~<asm/pgÆloc.h
>

41 
	~<asm/©omic.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/i8253.h
>

44 
	~<asm/i8259.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/≠ic.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/h≥t.h
>

49 
	~<asm/idÀ.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/smp.h
>

52 
	~<asm/m˚.h
>

53 
	~<asm/kvm_∑ø.h
>

55 
	gnum_¥o˚ss‹s
;

57 
dißbÀd_˝us
 
	g__˝uöôd©a
;

60 
	gboŸ_˝u_physiˇl_≠icid
 = -1U;

65 
	gmax_physiˇl_≠icid
;

70 
physid_mask_t
 
	gphys_˝u_¥e£¡_m≠
;

75 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_˝u_to_≠icid
, 
BAD_APICID
);

76 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_˝u_≠icid
, 
BAD_APICID
);

77 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_≠icid
);

78 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_˝u_≠icid
);

80 #ifde‡
CONFIG_X86_32


86 
	gf‹˚_íabÀ_loˇl_≠ic
;

90 
__öô
 
	$∑r£_œpic
(*
¨g
)

92 
f‹˚_íabÀ_loˇl_≠ic
 = 1;

94 
	}
}

95 
óæy_∑øm
("œpic", 
∑r£_œpic
);

97 
	gíabÀd_vü_≠icba£
;

107 
ölöe
 
	$im¸_pic_to_≠ic
()

110 
	`outb
(0x70, 0x22);

112 
	`outb
(0x01, 0x23);

113 
	}
}

115 
ölöe
 
	$im¸_≠ic_to_pic
()

118 
	`outb
(0x70, 0x22);

120 
	`outb
(0x00, 0x23);

121 
	}
}

124 #ifde‡
CONFIG_X86_64


125 
≠ic_ˇlibøã_pmtmr
 
	g__öôd©a
;

126 
__öô
 
	$£tup_≠i˝mtimî
(*
s
)

128 
≠ic_ˇlibøã_pmtmr
 = 1;

129 
	`nŸsc_£tup
(
NULL
);

131 
	}
}

132 
__£tup
("≠i˝mtimî", 
£tup_≠i˝mtimî
);

135 
	gx2≠ic_mode
;

136 #ifde‡
CONFIG_X86_X2APIC


138 
	gx2≠ic_¥ì«bÀd
;

139 
__öô
 
	$£tup_nox2≠ic
(*
°r
)

141 i‡(
	`x2≠ic_íabÀd
()) {

142 
	`¥_w¨nög
("BiosálreadyÉnabled x2apic, "

147 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_X2APIC
);

149 
	}
}

150 
óæy_∑øm
("nox2≠ic", 
£tup_nox2≠ic
);

153 
	gmp_œpic_addr
;

154 
	gdißbÀ_≠ic
;

156 
dißbÀ_≠ic_timî
 
	g__˝uöôd©a
;

158 
	gloˇl_≠ic_timî_c2_ok
;

159 
EXPORT_SYMBOL_GPL
(
loˇl_≠ic_timî_c2_ok
);

161 
	gfú°_sy°em_ve˘‹
 = 0xfe;

166 
	g≠ic_vîbosôy
;

168 
	gpic_mode
;

171 
	gsmp_found_c⁄fig
;

173 
ªsour˚
 
	gœpic_ªsour˚
 = {

174 .
«me
 = "Local APIC",

175 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

178 
	gˇlibøti⁄_ªsu…
;

180 
œpic_√xt_evít
(
dñè
,

181 
˛ock_evít_devi˚
 *
evt
);

182 
œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

183 
˛ock_evít_devi˚
 *
evt
);

184 
œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
);

185 
≠ic_pm_a˘iv©e
();

190 
˛ock_evít_devi˚
 
	gœpic_˛ockevít
 = {

191 .
«me
 = "lapic",

192 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


193 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

194 .
	gshi·
 = 32,

195 .
	g£t_mode
 = 
œpic_timî_£tup
,

196 .
	g£t_√xt_evít
 = 
œpic_√xt_evít
,

197 .
	gbrﬂdˇ°
 = 
œpic_timî_brﬂdˇ°
,

198 .
	gøtög
 = 100,

199 .
	gúq
 = -1,

201 
DEFINE_PER_CPU
(
˛ock_evít_devi˚
, 
œpic_evíts
);

203 
	g≠ic_phys
;

208 
ölöe
 
	$œpic_gë_vîsi⁄
()

210  
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

211 
	}
}

216 
ölöe
 
	$œpic_is_öãgøãd
()

218 #ifde‡
CONFIG_X86_64


221  
	`APIC_INTEGRATED
(
	`œpic_gë_vîsi⁄
());

223 
	}
}

228 
	$modîn_≠ic
()

231 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
 &&

232 
boŸ_˝u_d©a
.
x86
 >= 0xf)

234  
	`œpic_gë_vîsi⁄
() >= 0x14;

235 
	}
}

241 
	$≠ic_dißbÀ
()

243 
	`¥_öfo
("APIC: switchedÅoápic NOOP\n");

244 
≠ic
 = &
≠ic_no›
;

245 
	}
}

247 
	$«tive_≠ic_waô_i¸_idÀ
()

249 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
)

250 
	`˝u_ªœx
();

251 
	}
}

253 
u32
 
	$«tive_ß„_≠ic_waô_i¸_idÀ
()

255 
u32
 
£nd_°©us
;

256 
timeout
;

258 
timeout
 = 0;

260 
£nd_°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
;

261 i‡(!
£nd_°©us
)

263 
	`udñay
(100);

264 } 
timeout
++ < 1000);

266  
£nd_°©us
;

267 
	}
}

269 
	$«tive_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
)

271 
	`≠ic_wrôe
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

272 
	`≠ic_wrôe
(
APIC_ICR
, 
low
);

273 
	}
}

275 
u64
 
	$«tive_≠ic_i¸_ªad
()

277 
u32
 
i¸1
, 
i¸2
;

279 
i¸2
 = 
	`≠ic_ªad
(
APIC_ICR2
);

280 
i¸1
 = 
	`≠ic_ªad
(
APIC_ICR
);

282  
i¸1
 | ((
u64
)
i¸2
 << 32);

283 
	}
}

288 
__˝uöô
 
	$íabÀ_NMI_through_LVT0
()

290 
v
;

293 
v
 = 
APIC_DM_NMI
;

296 i‡(!
	`œpic_is_öãgøãd
())

297 
v
 |
APIC_LVT_LEVEL_TRIGGER
;

299 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
);

300 
	}
}

302 #ifde‡
CONFIG_X86_32


306 
	$gë_physiˇl_brﬂdˇ°
()

308  
	`modîn_≠ic
() ? 0xff : 0xf;

309 
	}
}

315 
	$œpic_gë_maxlvt
()

317 
v
;

319 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

324  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)Ë? 
	`GET_APIC_MAXLVT
(v) : 2;

325 
	}
}

332 
	#APIC_DIVISOR
 16

	)

344 
	$__£tup_APIC_LVTT
(
˛ocks
, 
⁄eshŸ
, 
úqí
)

346 
lvâ_vÆue
, 
tmp_vÆue
;

348 
lvâ_vÆue
 = 
LOCAL_TIMER_VECTOR
;

349 i‡(!
⁄eshŸ
)

350 
lvâ_vÆue
 |
APIC_LVT_TIMER_PERIODIC
;

351 i‡(!
	`œpic_is_öãgøãd
())

352 
lvâ_vÆue
 |
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

354 i‡(!
úqí
)

355 
lvâ_vÆue
 |
APIC_LVT_MASKED
;

357 
	`≠ic_wrôe
(
APIC_LVTT
, 
lvâ_vÆue
);

362 
tmp_vÆue
 = 
	`≠ic_ªad
(
APIC_TDCR
);

363 
	`≠ic_wrôe
(
APIC_TDCR
,

364 (
tmp_vÆue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

365 
APIC_TDR_DIV_16
);

367 i‡(!
⁄eshŸ
)

368 
	`≠ic_wrôe
(
APIC_TMICT
, 
˛ocks
 / 
APIC_DIVISOR
);

369 
	}
}

381 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

382 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

384 
	$£tup_APIC_eûvt
(
u8
 
lvt_off
, u8 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

386 
ªg
 = (
lvt_off
 << 4Ë+ 
	`APIC_EILVTn
(0);

387 
v
 = (
mask
 << 16Ë| (
msg_ty≥
 << 8Ë| 
ve˘‹
;

389 
	`≠ic_wrôe
(
ªg
, 
v
);

390 
	}
}

392 
u8
 
	$£tup_APIC_eûvt_m˚
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

394 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_MCE
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

395  
APIC_EILVT_LVTOFF_MCE
;

396 
	}
}

398 
u8
 
	$£tup_APIC_eûvt_ibs
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

400 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_IBS
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

401  
APIC_EILVT_LVTOFF_IBS
;

402 
	}
}

403 
EXPORT_SYMBOL_GPL
(
£tup_APIC_eûvt_ibs
);

408 
	$œpic_√xt_evít
(
dñè
,

409 
˛ock_evít_devi˚
 *
evt
)

411 
	`≠ic_wrôe
(
APIC_TMICT
, 
dñè
);

413 
	}
}

418 
	$œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

419 
˛ock_evít_devi˚
 *
evt
)

421 
Êags
;

422 
v
;

425 i‡(
evt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
)

428 
	`loˇl_úq_ßve
(
Êags
);

430 
mode
) {

431 
CLOCK_EVT_MODE_PERIODIC
:

432 
CLOCK_EVT_MODE_ONESHOT
:

433 
	`__£tup_APIC_LVTT
(
ˇlibøti⁄_ªsu…
,

434 
mode
 !
CLOCK_EVT_MODE_PERIODIC
, 1);

436 
CLOCK_EVT_MODE_UNUSED
:

437 
CLOCK_EVT_MODE_SHUTDOWN
:

438 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

439 
v
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

440 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
);

441 
	`≠ic_wrôe
(
APIC_TMICT
, 0);

443 
CLOCK_EVT_MODE_RESUME
:

448 
	`loˇl_úq_ª°‹e
(
Êags
);

449 
	}
}

454 
	$œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
)

456 #ifde‡
CONFIG_SMP


457 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

459 
	}
}

465 
__˝uöô
 
	$£tup_APIC_timî
()

467 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

469 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_ARAT
)) {

470 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_C3STOP
;

472 
œpic_˛ockevít
.
øtög
 = 150;

475 
	`mem˝y
(
Àvt
, &
œpic_˛ockevít
, (*levt));

476 
Àvt
->
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

478 
	`˛ockevíts_ªgi°î_devi˚
(
Àvt
);

479 
	}
}

502 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

504 
__öôd©a
 
	gœpic_ˇl_lo›s
 = -1;

505 
__öôd©a
 
	gœpic_ˇl_t1
, 
	gœpic_ˇl_t2
;

506 
__öôd©a
 
	gœpic_ˇl_tsc1
, 
	gœpic_ˇl_tsc2
;

507 
__öôd©a
 
	gœpic_ˇl_pm1
, 
	gœpic_ˇl_pm2
;

508 
__öôd©a
 
	gœpic_ˇl_j1
, 
	gœpic_ˇl_j2
;

513 
__öô
 
	$œpic_ˇl_h™dÀr
(
˛ock_evít_devi˚
 *
dev
)

515 
tsc
 = 0;

516 
èpic
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

517 
pm
 = 
	`a˝i_pm_ªad_óæy
();

519 i‡(
˝u_has_tsc
)

520 
	`rdts˛l
(
tsc
);

522 
œpic_ˇl_lo›s
++) {

524 
œpic_ˇl_t1
 = 
èpic
;

525 
œpic_ˇl_tsc1
 = 
tsc
;

526 
œpic_ˇl_pm1
 = 
pm
;

527 
œpic_ˇl_j1
 = 
jiffõs
;

530 
LAPIC_CAL_LOOPS
:

531 
œpic_ˇl_t2
 = 
èpic
;

532 
œpic_ˇl_tsc2
 = 
tsc
;

533 i‡(
pm
 < 
œpic_ˇl_pm1
)

534 
pm
 +
ACPI_PM_OVRRUN
;

535 
œpic_ˇl_pm2
 = 
pm
;

536 
œpic_ˇl_j2
 = 
jiffõs
;

539 
	}
}

541 
__öô


542 
	$ˇlibøã_by_pmtimî
(
dñèpm
, *
dñè
, *
dñètsc
)

544 c⁄° 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

545 c⁄° 
pm_thªsh
 = 
pm_100ms
 / 100;

546 
mu…
;

547 
u64
 
ªs
;

549 #i‚de‡
CONFIG_X86_PM_TIMER


553 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-Timî dñè = %ld\n", 
dñèpm
);

556 i‡(!
dñèpm
)

559 
mu…
 = 
	`˛ocksour˚_hz2mu…
(
PMTMR_TICKS_PER_SEC
, 22);

561 i‡(
dñèpm
 > (
pm_100ms
 - 
pm_thªsh
) &&

562 
dñèpm
 < (
pm_100ms
 + 
pm_thªsh
)) {

563 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-TimerÑesult ok\n");

567 
ªs
 = (((
u64
)
dñèpm
Ë* 
mu…
) >> 22;

568 
	`do_div
(
ªs
, 1000000);

569 
	`¥_w¨nög
("APIC calibrationÇot consistent "

570 "wôh PM-Timî: %ldm†ö°ód o‡100ms\n",()
ªs
);

573 
ªs
 = (((
u64
)(*
dñè
)Ë* 
pm_100ms
);

574 
	`do_div
(
ªs
, 
dñèpm
);

575 
	`¥_öfo
("APIC deltaádjustedÅo PM-Timer: "

576 "%lu (%ld)\n", ()
ªs
, *
dñè
);

577 *
dñè
 = ()
ªs
;

580 i‡(
˝u_has_tsc
) {

581 
ªs
 = (((
u64
)(*
dñètsc
)Ë* 
pm_100ms
);

582 
	`do_div
(
ªs
, 
dñèpm
);

583 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "TSC deltaádjustedÅo "

585 ()
ªs
, *
dñètsc
);

586 *
dñètsc
 = ()
ªs
;

590 
	}
}

592 
__öô
 
	$ˇlibøã_APIC_˛ock
()

594 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

595 (*
ªÆ_h™dÀr
)(
˛ock_evít_devi˚
 *
dev
);

596 
dñèj
;

597 
dñè
, 
dñètsc
;

598 
pm_ª„ªn˚d
 = 0;

600 
	`loˇl_úq_dißbÀ
();

603 
ªÆ_h™dÀr
 = 
globÆ_˛ock_evít
->
evít_h™dÀr
;

604 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

610 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

613 
	`loˇl_úq_íabÀ
();

615 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

616 
	`˝u_ªœx
();

618 
	`loˇl_úq_dißbÀ
();

621 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
ªÆ_h™dÀr
;

624 
dñè
 = 
œpic_ˇl_t1
 - 
œpic_ˇl_t2
;

625 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "...Ü≠i¯dñè = %ld\n", 
dñè
);

627 
dñètsc
 = ()(
œpic_ˇl_tsc2
 - 
œpic_ˇl_tsc1
);

630 
pm_ª„ªn˚d
 = !
	`ˇlibøã_by_pmtimî
(
œpic_ˇl_pm2
 - 
œpic_ˇl_pm1
,

631 &
dñè
, &
dñètsc
);

634 
œpic_˛ockevít
.
mu…
 = 
	`div_sc
(
dñè
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

635 
œpic_˛ockevít
.
shi·
);

636 
œpic_˛ockevít
.
max_dñè_ns
 =

637 
	`˛ockevít_dñè2ns
(0x7FFFFF, &
œpic_˛ockevít
);

638 
œpic_˛ockevít
.
mö_dñè_ns
 =

639 
	`˛ockevít_dñè2ns
(0xF, &
œpic_˛ockevít
);

641 
ˇlibøti⁄_ªsu…
 = (
dñè
 * 
APIC_DIVISOR
Ë/ 
LAPIC_CAL_LOOPS
;

643 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... dñè %ld\n", 
dñè
);

644 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... mu…: %u\n", 
œpic_˛ockevít
.
mu…
);

645 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... calibrationÑesult: %u\n",

646 
ˇlibøti⁄_ªsu…
);

648 i‡(
˝u_has_tsc
) {

649 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... CPU clock speed is "

651 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë/ (1000000 / 
HZ
),

652 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë% (1000000 / 
HZ
));

655 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... host bus clock speed is "

657 
ˇlibøti⁄_ªsu…
 / (1000000 / 
HZ
),

658 
ˇlibøti⁄_ªsu…
 % (1000000 / 
HZ
));

663 i‡(
ˇlibøti⁄_ªsu…
 < (1000000 / 
HZ
)) {

664 
	`loˇl_úq_íabÀ
();

665 
	`¥_w¨nög
("APIC frequencyÅoo slow, disablingápicÅimer\n");

669 
Àvt
->
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

675 i‡(!
pm_ª„ªn˚d
) {

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... verify APICÅimer\n");

681 
Àvt
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

682 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Àvt
);

683 
œpic_ˇl_lo›s
 = -1;

686 
	`loˇl_úq_íabÀ
();

688 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

689 
	`˝u_ªœx
();

692 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Àvt
);

695 
dñèj
 = 
œpic_ˇl_j2
 - 
œpic_ˇl_j1
;

696 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffõ†dñè = %lu\n", 
dñèj
);

699 i‡(
dñèj
 >
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

700 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffiesÑesult ok\n");

702 
Àvt
->
„©uªs
 |
CLOCK_EVT_FEAT_DUMMY
;

704 
	`loˇl_úq_íabÀ
();

706 i‡(
Àvt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
) {

707 
	`¥_w¨nög
("APICÅimer disabled dueÅo verification failure\n");

712 
	}
}

719 
__öô
 
	$£tup_boŸ_APIC_˛ock
()

727 i‡(
dißbÀ_≠ic_timî
) {

728 
	`¥_öfo
("Disabling APICÅimer\n");

730 i‡(
	`num_possibÀ_˝us
() > 1) {

731 
œpic_˛ockevít
.
mu…
 = 1;

732 
	`£tup_APIC_timî
();

737 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "UsingÜocal APICÅimer interrupts.\n"

740 i‡(
	`ˇlibøã_APIC_˛ock
()) {

742 i‡(
	`num_possibÀ_˝us
() > 1)

743 
	`£tup_APIC_timî
();

752 i‡(
nmi_w©chdog
 !
NMI_IO_APIC
)

753 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

755 
	`¥_w¨nög
("APICÅimerÑegisteredás dummy,"

756 " duêtÿnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

759 
	`£tup_APIC_timî
();

760 
	}
}

762 
__˝uöô
 
	$£tup_£c⁄d¨y_APIC_˛ock
()

764 
	`£tup_APIC_timî
();

765 
	}
}

770 
	$loˇl_≠ic_timî_öãºu±
()

772 
˝u
 = 
	`smp_¥o˚ss‹_id
();

773 
˛ock_evít_devi˚
 *
evt
 = &
	`≥r_˝u
(
œpic_evíts
, 
˝u
);

786 i‡(!
evt
->
evít_h™dÀr
) {

787 
	`¥_w¨nög
("Spuriou†LAPICÅimî i¡îru± o¿˝u %d\n", 
˝u
);

789 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

796 
	`öc_úq_°©
(
≠ic_timî_úqs
);

798 
evt
->
	`evít_h™dÀr
(evt);

799 
	}
}

809 
__úq_íåy
 
	$smp_≠ic_timî_öãºu±
(
±_ªgs
 *
ªgs
)

811 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

817 
	`ack_APIC_úq
();

823 
	`exô_idÀ
();

824 
	`úq_íãr
();

825 
	`loˇl_≠ic_timî_öãºu±
();

826 
	`úq_exô
();

828 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

829 
	}
}

831 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

833  -
EINVAL
;

834 
	}
}

847 
	$˛ór_loˇl_APIC
()

849 
maxlvt
;

850 
u32
 
v
;

853 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

856 
maxlvt
 = 
	`œpic_gë_maxlvt
();

861 i‡(
maxlvt
 >= 3) {

862 
v
 = 
ERROR_APIC_VECTOR
;

863 
	`≠ic_wrôe
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

869 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

870 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

871 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

872 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

873 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

874 
	`≠ic_wrôe
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

875 i‡(
maxlvt
 >= 4) {

876 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

877 
	`≠ic_wrôe
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

881 #ifde‡
CONFIG_X86_THERMAL_VECTOR


882 i‡(
maxlvt
 >= 5) {

883 
v
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

884 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

887 #ifde‡
CONFIG_X86_MCE_INTEL


888 i‡(
maxlvt
 >= 6) {

889 
v
 = 
	`≠ic_ªad
(
APIC_LVTCMCI
);

890 i‡(!(
v
 & 
APIC_LVT_MASKED
))

891 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

898 
	`≠ic_wrôe
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

899 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

900 
	`≠ic_wrôe
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

901 i‡(
maxlvt
 >= 3)

902 
	`≠ic_wrôe
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

903 i‡(
maxlvt
 >= 4)

904 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

907 i‡(
	`œpic_is_öãgøãd
()) {

908 i‡(
maxlvt
 > 3)

910 
	`≠ic_wrôe
(
APIC_ESR
, 0);

911 
	`≠ic_ªad
(
APIC_ESR
);

913 
	}
}

918 
	$dißbÀ_loˇl_APIC
()

920 
vÆue
;

923 i‡(!
≠ic_phys
)

926 
	`˛ór_loˇl_APIC
();

932 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

933 
vÆue
 &~
APIC_SPIV_APIC_ENABLED
;

934 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

936 #ifde‡
CONFIG_X86_32


941 i‡(
íabÀd_vü_≠icba£
) {

942 
l
, 
h
;

944 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

945 
l
 &~
MSR_IA32_APICBASE_ENABLE
;

946 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

949 
	}
}

957 
	$œpic_shutdown
()

959 
Êags
;

961 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

964 
	`loˇl_úq_ßve
(
Êags
);

966 #ifde‡
CONFIG_X86_32


967 i‡(!
íabÀd_vü_≠icba£
)

968 
	`˛ór_loˇl_APIC
();

971 
	`dißbÀ_loˇl_APIC
();

974 
	`loˇl_úq_ª°‹e
(
Êags
);

975 
	}
}

982 
__öô
 
	$vîify_loˇl_APIC
()

984 
ªg0
, 
ªg1
;

989 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVR
);

990 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg0
);

991 
	`≠ic_wrôe
(
APIC_LVR
, 
ªg0
 ^ 
APIC_LVR_MASK
);

992 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVR
);

993 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg1
);

1000 i‡(
ªg1
 !
ªg0
)

1006 
ªg1
 = 
	`GET_APIC_VERSION
(
ªg0
);

1007 i‡(
ªg1
 == 0x00 ||Ñeg1 == 0xff)

1009 
ªg1
 = 
	`œpic_gë_maxlvt
();

1010 i‡(
ªg1
 < 0x02 ||Ñeg1 == 0xff)

1016 
ªg0
 = 
	`≠ic_ªad
(
APIC_ID
);

1017 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg0
);

1018 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
 ^ 
≠ic
->
≠ic_id_mask
);

1019 
ªg1
 = 
	`≠ic_ªad
(
APIC_ID
);

1020 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg1
);

1021 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
);

1022 i‡(
ªg1
 !(
ªg0
 ^ 
≠ic
->
≠ic_id_mask
))

1030 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1031 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT0: %x\n", 
ªg0
);

1032 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1033 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT1: %x\n", 
ªg1
);

1036 
	}
}

1041 
__öô
 
	$sync_Arb_IDs
()

1047 i‡(
	`modîn_≠ic
(Ë|| 
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
)

1053 
	`≠ic_waô_i¸_idÀ
();

1055 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1056 
	`≠ic_wrôe
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1057 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1058 
	}
}

1063 
__öô
 
	$öô_b•_APIC
()

1065 
vÆue
;

1071 i‡(
smp_found_c⁄fig
 || !
˝u_has_≠ic
)

1077 
	`˛ór_loˇl_APIC
();

1082 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1083 
vÆue
 &~
APIC_VECTOR_MASK
;

1084 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1086 #ifde‡
CONFIG_X86_32


1088 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

1089 (
boŸ_˝u_d©a
.
x86
 == 15))

1090 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1093 
vÆue
 |
APIC_SPIV_FOCUS_DISABLED
;

1094 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1095 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1100 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1101 
vÆue
 = 
APIC_DM_NMI
;

1102 i‡(!
	`œpic_is_öãgøãd
())

1103 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1104 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1105 
	}
}

1107 
__˝uöô
 
	$œpic_£tup_e§
()

1109 
ﬁdvÆue
, 
vÆue
, 
maxlvt
;

1111 i‡(!
	`œpic_is_öãgøãd
()) {

1112 
	`¥_öfo
("No ESR for 82489DX.\n");

1116 i‡(
≠ic
->
dißbÀ_e§
) {

1123 
	`¥_öfo
("Leaving ESR disabled.\n");

1127 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1128 i‡(
maxlvt
 > 3)

1129 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1130 
ﬁdvÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1133 
vÆue
 = 
ERROR_APIC_VECTOR
;

1134 
	`≠ic_wrôe
(
APIC_LVTERR
, 
vÆue
);

1139 i‡(
maxlvt
 > 3)

1140 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1141 
vÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1142 i‡(
vÆue
 !
ﬁdvÆue
)

1143 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ESR value beforeÉnabling "

1145 
ﬁdvÆue
, 
vÆue
);

1146 
	}
}

1152 
__˝uöô
 
	$£tup_loˇl_APIC
()

1154 
vÆue
;

1155 
i
, 
j
;

1157 i‡(
dißbÀ_≠ic
) {

1158 
	`¨ch_dißbÀ_smp_suµ‹t
();

1162 #ifde‡
CONFIG_X86_32


1164 i‡(
	`œpic_is_öãgøãd
(Ë&& 
≠ic
->
dißbÀ_e§
) {

1165 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1166 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1167 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1168 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1171 
	`≥rf_evíts_œpic_öô
();

1173 
	`¥ìm±_dißbÀ
();

1179 
	`BUG_ON
(!
≠ic
->
	`≠ic_id_ªgi°îed
());

1186 
≠ic
->
	`öô_≠ic_ldr
();

1192 
vÆue
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1193 
vÆue
 &~
APIC_TPRI_MASK
;

1194 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
vÆue
);

1207 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1208 
vÆue
 = 
	`≠ic_ªad
(
APIC_ISR
 + 
i
*0x10);

1209 
j
 = 31; j >= 0; j--) {

1210 i‡(
vÆue
 & (1<<
j
))

1211 
	`ack_APIC_úq
();

1218 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1219 
vÆue
 &~
APIC_VECTOR_MASK
;

1223 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1225 #ifde‡
CONFIG_X86_32


1251 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1257 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1258 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1270 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
Ë& 
APIC_LVT_MASKED
;

1271 i‡(!
	`smp_¥o˚ss‹_id
(Ë&& (
pic_mode
 || !
vÆue
)) {

1272 
vÆue
 = 
APIC_DM_EXTINT
;

1273 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1274 
	`smp_¥o˚ss‹_id
());

1276 
vÆue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1277 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1278 
	`smp_¥o˚ss‹_id
());

1280 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1285 i‡(!
	`smp_¥o˚ss‹_id
())

1286 
vÆue
 = 
APIC_DM_NMI
;

1288 
vÆue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1289 i‡(!
	`œpic_is_öãgøãd
())

1290 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1291 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1293 
	`¥ìm±_íabÀ
();

1295 #ifde‡
CONFIG_X86_MCE_INTEL


1297 i‡(
	`smp_¥o˚ss‹_id
() == 0)

1298 
	`cmci_ªcheck
();

1300 
	}
}

1302 
__˝uöô
 
	$íd_loˇl_APIC_£tup
()

1304 
	`œpic_£tup_e§
();

1306 #ifde‡
CONFIG_X86_32


1308 
vÆue
;

1310 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1311 
vÆue
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1312 
	`≠ic_wrôe
(
APIC_LVTT
, 
vÆue
);

1316 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

1317 
	`≠ic_pm_a˘iv©e
();

1318 
	}
}

1320 #ifde‡
CONFIG_X86_X2APIC


1321 
	$check_x2≠ic
()

1323 i‡(
	`x2≠ic_íabÀd
()) {

1324 
	`¥_öfo
("x2apicÉnabled by BIOS, switchingÅo x2apic ops\n");

1325 
x2≠ic_¥ì«bÀd
 = 
x2≠ic_mode
 = 1;

1327 
	}
}

1329 
	$íabÀ_x2≠ic
()

1331 
m§
, 
m§2
;

1333 i‡(!
x2≠ic_mode
)

1336 
	`rdm§
(
MSR_IA32_APICBASE
, 
m§
, 
m§2
);

1337 i‡(!(
m§
 & 
X2APIC_ENABLE
)) {

1338 
	`¥ötk_⁄˚
(
KERN_INFO
 "Enabling x2apic\n");

1339 
	`wrm§
(
MSR_IA32_APICBASE
, 
m§
 | 
X2APIC_ENABLE
, 0);

1341 
	}
}

1344 
__öô
 
	$íabÀ_IR
()

1346 #ifde‡
CONFIG_INTR_REMAP


1347 i‡(!
	`öå_ªm≠pög_suµ‹ãd
()) {

1348 
	`¥_debug
("intr-remappingÇot supported\n");

1352 i‡(!
x2≠ic_¥ì«bÀd
 && 
skù_iﬂpic_£tup
) {

1353 
	`¥_öfo
("SkippedÉnabling intr-remap because of skipping "

1358 i‡(
	`íabÀ_öå_ªm≠pög
(
	`x2≠ic_suµ‹ãd
()))

1361 
	`¥_öfo
("Enabled Interrupt-remapping\n");

1367 
	}
}

1369 
__öô
 
	$íabÀ_IR_x2≠ic
()

1371 
Êags
;

1372 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

1373 
ªt
, 
x2≠ic_íabÀd
 = 0;

1374 
dm¨_èbÀ_öô_ªt
;

1376 
dm¨_èbÀ_öô_ªt
 = 
	`dm¨_èbÀ_öô
();

1377 i‡(
dm¨_èbÀ_öô_ªt
 && !
	`x2≠ic_suµ‹ãd
())

1380 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

1381 i‡(!
iﬂpic_íåõs
) {

1382 
	`¥_îr
("Allocate ioapic_entries failed\n");

1383 
out
;

1386 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

1387 i‡(
ªt
) {

1388 
	`¥_öfo
("Savög IO-APIC sèã faûed: %d\n", 
ªt
);

1389 
out
;

1392 
	`loˇl_úq_ßve
(
Êags
);

1393 
Àgacy_pic
->
	`mask_Æl
();

1394 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

1396 i‡(
dm¨_èbÀ_öô_ªt
)

1397 
ªt
 = 0;

1399 
ªt
 = 
	`íabÀ_IR
();

1401 i‡(!
ªt
) {

1405 i‡(
max_physiˇl_≠icid
 > 255 || !
	`kvm_∑ø_avaûabÀ
())

1406 
nox2≠ic
;

1411 
	`x2≠ic_f‹˚_phys
();

1414 
x2≠ic_íabÀd
 = 1;

1416 i‡(
	`x2≠ic_suµ‹ãd
(Ë&& !
x2≠ic_mode
) {

1417 
x2≠ic_mode
 = 1;

1418 
	`íabÀ_x2≠ic
();

1419 
	`¥_öfo
("Enabled x2apic\n");

1422 
nox2≠ic
:

1423 i‡(!
ªt
)

1424 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

1425 
Àgacy_pic
->
	`ª°‹e_mask
();

1426 
	`loˇl_úq_ª°‹e
(
Êags
);

1428 
out
:

1429 i‡(
iﬂpic_íåõs
)

1430 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

1432 i‡(
x2≠ic_íabÀd
)

1435 i‡(
x2≠ic_¥ì«bÀd
)

1436 
	`∑nic
("x2apic:Énabled by BIOS but kernel init failed.");

1437 i‡(
˝u_has_x2≠ic
)

1438 
	`¥_öfo
("NotÉnabling x2apic, Intr-remapping init failed.\n");

1439 
	}
}

1441 #ifde‡
CONFIG_X86_64


1448 
__öô
 
	$dëe˘_öô_APIC
()

1450 i‡(!
˝u_has_≠ic
) {

1451 
	`¥_öfo
("NoÜocal APICÖresent\n");

1455 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1457 
	}
}

1462 
__öô
 
	$dëe˘_öô_APIC
()

1464 
u32
 
h
, 
l
, 
„©uªs
;

1467 i‡(
dißbÀ_≠ic
)

1470 
boŸ_˝u_d©a
.
x86_víd‹
) {

1471 
X86_VENDOR_AMD
:

1472 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 > 1) ||

1473 (
boŸ_˝u_d©a
.
x86
 >= 15))

1475 
no_≠ic
;

1476 
X86_VENDOR_INTEL
:

1477 i‡(
boŸ_˝u_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1478 (
boŸ_˝u_d©a
.
x86
 =5 && 
˝u_has_≠ic
))

1480 
no_≠ic
;

1482 
no_≠ic
;

1485 i‡(!
˝u_has_≠ic
) {

1490 i‡(!
f‹˚_íabÀ_loˇl_≠ic
) {

1491 
	`¥_öfo
("Local APIC disabled by BIOS -- "

1500 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1501 i‡(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1502 
	`¥_öfo
("Local APIC disabled by BIOS --Ñeenabling.\n");

1503 
l
 &~
MSR_IA32_APICBASE_BASE
;

1504 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1505 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1506 
íabÀd_vü_≠icba£
 = 1;

1513 
„©uªs
 = 
	`˝uid_edx
(1);

1514 i‡(!(
„©uªs
 & (1 << 
X86_FEATURE_APIC
))) {

1515 
	`¥_w¨nög
("CouldÇotÉnable APIC!\n");

1518 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1519 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1522 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1523 i‡(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1524 
mp_œpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1526 
	`¥_öfo
("FoundándÉnabledÜocal APIC!\n");

1528 
	`≠ic_pm_a˘iv©e
();

1532 
no_≠ic
:

1533 
	`¥_öfo
("NoÜocal APICÖresent or hardware disabled\n");

1535 
	}
}

1538 #ifde‡
CONFIG_X86_64


1539 
__öô
 
	$óæy_öô_œpic_m≠pög
()

1545 i‡(!
smp_found_c⁄fig
)

1548 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
mp_œpic_addr
);

1549 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %16lx (%16lx)\n",

1550 
APIC_BASE
, 
mp_œpic_addr
);

1556 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1557 
	}
}

1563 
__öô
 
	$öô_≠ic_m≠pögs
()

1565 
√w_≠icid
;

1567 i‡(
x2≠ic_mode
) {

1568 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1573 i‡(!
smp_found_c⁄fig
 && 
	`dëe˘_öô_APIC
()) {

1575 
	`¥_öfo
("APIC: disableápic facility\n");

1576 
	`≠ic_dißbÀ
();

1578 
≠ic_phys
 = 
mp_œpic_addr
;

1584 i‡(!
a˝i_œpic
)

1585 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
≠ic_phys
);

1587 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %08lx (%08lx)\n",

1588 
APIC_BASE
, 
≠ic_phys
);

1595 
√w_≠icid
 = 
	`ªad_≠ic_id
();

1596 i‡(
boŸ_˝u_physiˇl_≠icid
 !
√w_≠icid
) {

1597 
boŸ_˝u_physiˇl_≠icid
 = 
√w_≠icid
;

1605 
≠ic_vîsi⁄
[
√w_≠icid
] =

1606 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

1608 
	}
}

1614 
	g≠ic_vîsi⁄
[
MAX_APICS
];

1616 
__öô
 
	$APIC_öô_unùro˚ss‹
()

1618 i‡(
dißbÀ_≠ic
) {

1619 
	`¥_öfo
("Apic disabled\n");

1622 #ifde‡
CONFIG_X86_64


1623 i‡(!
˝u_has_≠ic
) {

1624 
dißbÀ_≠ic
 = 1;

1625 
	`¥_öfo
("Apic disabled by BIOS\n");

1629 i‡(!
smp_found_c⁄fig
 && !
˝u_has_≠ic
)

1635 i‡(!
˝u_has_≠ic
 &&

1636 
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

1637 
	`¥_îr
("BIOS bug,Üocal APIC 0x%xÇot detected!...\n",

1638 
boŸ_˝u_physiˇl_≠icid
);

1643 #i‚de‡
CONFIG_SMP


1644 
	`íabÀ_IR_x2≠ic
();

1645 
	`deÁu…_£tup_≠ic_routög
();

1648 
	`vîify_loˇl_APIC
();

1649 
	`c⁄√˘_b•_APIC
();

1651 #ifde‡
CONFIG_X86_64


1652 
	`≠ic_wrôe
(
APIC_ID
, 
	`SET_APIC_ID
(
boŸ_˝u_physiˇl_≠icid
));

1659 #ifde‡
CONFIG_CRASH_DUMP


1660 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1663 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

1664 
	`£tup_loˇl_APIC
();

1666 #ifde‡
CONFIG_X86_IO_APIC


1671 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1672 
	`íabÀ_IO_APIC
();

1675 
	`íd_loˇl_APIC_£tup
();

1677 #ifde‡
CONFIG_X86_IO_APIC


1678 i‡(
smp_found_c⁄fig
 && !
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1679 
	`£tup_IO_APIC
();

1681 
ƒ_iﬂpics
 = 0;

1682 
	`loˇli£_nmi_w©chdog
();

1685 
	`loˇli£_nmi_w©chdog
();

1688 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1689 #ifde‡
CONFIG_X86_64


1690 
	`check_nmi_w©chdog
();

1694 
	}
}

1703 
	$smp_•urious_öãºu±
(
±_ªgs
 *
ªgs
)

1705 
u32
 
v
;

1707 
	`exô_idÀ
();

1708 
	`úq_íãr
();

1714 
v
 = 
	`≠ic_ªad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1715 i‡(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1716 
	`ack_APIC_úq
();

1718 
	`öc_úq_°©
(
úq_•urious_cou¡
);

1721 
	`¥_öfo
("spurious APIC interrupt on CPU#%d, "

1722 "shouldÇevî h≠≥n.\n", 
	`smp_¥o˚ss‹_id
());

1723 
	`úq_exô
();

1724 
	}
}

1729 
	$smp_îr‹_öãºu±
(
±_ªgs
 *
ªgs
)

1731 
u32
 
v
, 
v1
;

1733 
	`exô_idÀ
();

1734 
	`úq_íãr
();

1736 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1737 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1738 
v1
 = 
	`≠ic_ªad
(
APIC_ESR
);

1739 
	`ack_APIC_úq
();

1740 
	`©omic_öc
(&
úq_îr_cou¡
);

1753 
	`¥_debug
("APICÉrror on CPU%d: %02x(%02x)\n",

1754 
	`smp_¥o˚ss‹_id
(), 
v
 , 
v1
);

1755 
	`úq_exô
();

1756 
	}
}

1761 
__öô
 
	$c⁄√˘_b•_APIC
()

1763 #ifde‡
CONFIG_X86_32


1764 i‡(
pic_mode
) {

1768 
	`˛ór_loˇl_APIC
();

1773 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "leaving PIC mode, "

1775 
	`im¸_pic_to_≠ic
();

1778 i‡(
≠ic
->
íabÀ_≠ic_mode
)

1779 
≠ic
->
	`íabÀ_≠ic_mode
();

1780 
	}
}

1789 
	$disc⁄√˘_b•_APIC
(
vút_wúe_£tup
)

1791 
vÆue
;

1793 #ifde‡
CONFIG_X86_32


1794 i‡(
pic_mode
) {

1801 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "disabling APIC mode, "

1803 
	`im¸_≠ic_to_pic
();

1811 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1812 
vÆue
 &~
APIC_VECTOR_MASK
;

1813 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1814 
vÆue
 |= 0xf;

1815 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1817 i‡(!
vút_wúe_£tup
) {

1822 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1823 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1824 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1825 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1826 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1827 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_EXTINT
);

1828 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1831 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1838 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1839 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1840 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1841 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1842 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1843 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_NMI
);

1844 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1845 
	}
}

1847 
__˝uöô
 
	$gíîic_¥o˚ss‹_öfo
(
≠icid
, 
vîsi⁄
)

1849 
˝u
;

1854 i‡(
vîsi⁄
 == 0x0) {

1855 
	`¥_w¨nög
("BIOS bug, APIC version is 0 for CPU#%d! "

1857 
vîsi⁄
);

1858 
vîsi⁄
 = 0x10;

1860 
≠ic_vîsi⁄
[
≠icid
] = 
vîsi⁄
;

1862 i‡(
num_¥o˚ss‹s
 >
ƒ_˝u_ids
) {

1863 
max
 = 
ƒ_˝u_ids
;

1864 
this˝u
 = 
max
 + 
dißbÀd_˝us
;

1866 
	`¥_w¨nög
(

1868 " Pro˚ss‹ %d/0x%x ign‹ed.\n", 
max
, 
this˝u
, 
≠icid
);

1870 
dißbÀd_˝us
++;

1874 
num_¥o˚ss‹s
++;

1875 
˝u
 = 
	`˝umask_√xt_zîo
(-1, 
˝u_¥e£¡_mask
);

1877 i‡(
vîsi⁄
 !
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])

1878 
	`WARN_ONCE
(1,

1880 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
], 
˝u
, 
vîsi⁄
);

1882 
	`physid_£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
);

1883 i‡(
≠icid
 =
boŸ_˝u_physiˇl_≠icid
) {

1889 
˝u
 = 0;

1891 i‡(
≠icid
 > 
max_physiˇl_≠icid
)

1892 
max_physiˇl_≠icid
 = 
≠icid
;

1894 #i‡
	`deföed
(
CONFIG_SMP
Ë|| deföed(
CONFIG_X86_64
)

1895 
	`óæy_≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
≠icid
;

1896 
	`óæy_≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
Ë
≠icid
;

1899 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

1900 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

1901 
	}
}

1903 
	$h¨d_smp_¥o˚ss‹_id
()

1905  
	`ªad_≠ic_id
();

1906 
	}
}

1908 
	$deÁu…_öô_≠ic_ldr
()

1910 
vÆ
;

1912 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1913 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

1914 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_¥o˚ss‹_id
());

1915 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

1916 
	}
}

1918 #ifde‡
CONFIG_X86_32


1919 
	$deÁu…_≠icid_to_node
(
logiˇl_≠icid
)

1921 #ifde‡
CONFIG_SMP


1922  
≠icid_2_node
[
	`h¨d_smp_¥o˚ss‹_id
()];

1926 
	}
}

1932 #ifde‡
CONFIG_PM


1940 
	ma˘ive
;

1942 
	m≠ic_id
;

1943 
	m≠ic_èsk¥i
;

1944 
	m≠ic_ldr
;

1945 
	m≠ic_d‰
;

1946 
	m≠ic_•iv
;

1947 
	m≠ic_lvâ
;

1948 
	m≠ic_lvçc
;

1949 
	m≠ic_lvt0
;

1950 
	m≠ic_lvt1
;

1951 
	m≠ic_lvãº
;

1952 
	m≠ic_tmi˘
;

1953 
	m≠ic_td¸
;

1954 
	m≠ic_thmr
;

1955 } 
	g≠ic_pm_°©e
;

1957 
	$œpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1959 
Êags
;

1960 
maxlvt
;

1962 i‡(!
≠ic_pm_°©e
.
a˘ive
)

1965 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1967 
≠ic_pm_°©e
.
≠ic_id
 = 
	`≠ic_ªad
(
APIC_ID
);

1968 
≠ic_pm_°©e
.
≠ic_èsk¥i
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1969 
≠ic_pm_°©e
.
≠ic_ldr
 = 
	`≠ic_ªad
(
APIC_LDR
);

1970 
≠ic_pm_°©e
.
≠ic_d‰
 = 
	`≠ic_ªad
(
APIC_DFR
);

1971 
≠ic_pm_°©e
.
≠ic_•iv
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1972 
≠ic_pm_°©e
.
≠ic_lvâ
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1973 i‡(
maxlvt
 >= 4)

1974 
≠ic_pm_°©e
.
≠ic_lvçc
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1975 
≠ic_pm_°©e
.
≠ic_lvt0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1976 
≠ic_pm_°©e
.
≠ic_lvt1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1977 
≠ic_pm_°©e
.
≠ic_lvãº
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1978 
≠ic_pm_°©e
.
≠ic_tmi˘
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1979 
≠ic_pm_°©e
.
≠ic_td¸
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1980 #ifde‡
CONFIG_X86_THERMAL_VECTOR


1981 i‡(
maxlvt
 >= 5)

1982 
≠ic_pm_°©e
.
≠ic_thmr
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

1985 
	`loˇl_úq_ßve
(
Êags
);

1986 
	`dißbÀ_loˇl_APIC
();

1988 i‡(
öå_ªm≠pög_íabÀd
)

1989 
	`dißbÀ_öå_ªm≠pög
();

1991 
	`loˇl_úq_ª°‹e
(
Êags
);

1993 
	}
}

1995 
	$œpic_ªsume
(
sys_devi˚
 *
dev
)

1997 
l
, 
h
;

1998 
Êags
;

1999 
maxlvt
;

2000 
ªt
 = 0;

2001 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

2003 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2006 
	`loˇl_úq_ßve
(
Êags
);

2007 i‡(
öå_ªm≠pög_íabÀd
) {

2008 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

2009 i‡(!
iﬂpic_íåõs
) {

2010 
	`WARN
(1, "Alloc ioapic_entries inÜapicÑesume failed.");

2011 
ªt
 = -
ENOMEM
;

2012 
ª°‹e
;

2015 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

2016 i‡(
ªt
) {

2017 
	`WARN
(1, "Savög IO-APIC sèã faûed: %d\n", 
ªt
);

2018 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2019 
ª°‹e
;

2022 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

2023 
Àgacy_pic
->
	`mask_Æl
();

2026 i‡(
x2≠ic_mode
)

2027 
	`íabÀ_x2≠ic
();

2035 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2036 
l
 &~
MSR_IA32_APICBASE_BASE
;

2037 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
mp_œpic_addr
;

2038 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2041 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2042 
	`≠ic_wrôe
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2043 
	`≠ic_wrôe
(
APIC_ID
, 
≠ic_pm_°©e
.
≠ic_id
);

2044 
	`≠ic_wrôe
(
APIC_DFR
, 
≠ic_pm_°©e
.
≠ic_d‰
);

2045 
	`≠ic_wrôe
(
APIC_LDR
, 
≠ic_pm_°©e
.
≠ic_ldr
);

2046 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
≠ic_pm_°©e
.
≠ic_èsk¥i
);

2047 
	`≠ic_wrôe
(
APIC_SPIV
, 
≠ic_pm_°©e
.
≠ic_•iv
);

2048 
	`≠ic_wrôe
(
APIC_LVT0
, 
≠ic_pm_°©e
.
≠ic_lvt0
);

2049 
	`≠ic_wrôe
(
APIC_LVT1
, 
≠ic_pm_°©e
.
≠ic_lvt1
);

2050 #i‡
	`deföed
(
CONFIG_X86_MCE_P4THERMAL
Ë|| deföed(
CONFIG_X86_MCE_INTEL
)

2051 i‡(
maxlvt
 >= 5)

2052 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
≠ic_pm_°©e
.
≠ic_thmr
);

2054 i‡(
maxlvt
 >= 4)

2055 
	`≠ic_wrôe
(
APIC_LVTPC
, 
≠ic_pm_°©e
.
≠ic_lvçc
);

2056 
	`≠ic_wrôe
(
APIC_LVTT
, 
≠ic_pm_°©e
.
≠ic_lvâ
);

2057 
	`≠ic_wrôe
(
APIC_TDCR
, 
≠ic_pm_°©e
.
≠ic_td¸
);

2058 
	`≠ic_wrôe
(
APIC_TMICT
, 
≠ic_pm_°©e
.
≠ic_tmi˘
);

2059 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2060 
	`≠ic_ªad
(
APIC_ESR
);

2061 
	`≠ic_wrôe
(
APIC_LVTERR
, 
≠ic_pm_°©e
.
≠ic_lvãº
);

2062 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2063 
	`≠ic_ªad
(
APIC_ESR
);

2065 i‡(
öå_ªm≠pög_íabÀd
) {

2066 
	`ªíabÀ_öå_ªm≠pög
(
x2≠ic_mode
);

2067 
Àgacy_pic
->
	`ª°‹e_mask
();

2068 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

2069 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2071 
ª°‹e
:

2072 
	`loˇl_úq_ª°‹e
(
Êags
);

2074  
ªt
;

2075 
	}
}

2082 
sysdev_˛ass
 
	gœpic_sys˛ass
 = {

2083 .
«me
 = "lapic",

2084 .
	gªsume
 = 
œpic_ªsume
,

2085 .
	gsu•íd
 = 
œpic_su•íd
,

2088 
sys_devi˚
 
	gdevi˚_œpic
 = {

2089 .
id
 = 0,

2090 .
	g˛s
 = &
œpic_sys˛ass
,

2093 
__˝uöô
 
	$≠ic_pm_a˘iv©e
()

2095 
≠ic_pm_°©e
.
a˘ive
 = 1;

2096 
	}
}

2098 
__öô
 
	$öô_œpic_sysfs
()

2100 
îr‹
;

2102 i‡(!
˝u_has_≠ic
)

2106 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
œpic_sys˛ass
);

2107 i‡(!
îr‹
)

2108 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic
);

2109  
îr‹
;

2110 
	}
}

2113 
c‹e_öôˇŒ
(
öô_œpic_sysfs
);

2117 
	$≠ic_pm_a˘iv©e
(Ë{ 
	}
}

2121 #ifde‡
CONFIG_X86_64


2123 
__˝uöô
 
	$≠ic_˛u°î_num
()

2125 
i
, 
˛u°îs
, 
zîos
;

2126 
id
;

2127 
u16
 *
bios_˝u_≠icid
;

2128 
	`DECLARE_BITMAP
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2130 
bios_˝u_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
);

2131 
	`bôm≠_zîo
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2133 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

2135 i‡(
bios_˝u_≠icid
) {

2136 
id
 = 
bios_˝u_≠icid
[
i
];

2137 } i‡(
i
 < 
ƒ_˝u_ids
) {

2138 i‡(
	`˝u_¥e£¡
(
i
))

2139 
id
 = 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
i
);

2145 i‡(
id
 !
BAD_APICID
)

2146 
	`__£t_bô
(
	`APIC_CLUSTERID
(
id
), 
˛u°îm≠
);

2155 
˛u°îs
 = 0;

2156 
zîos
 = 0;

2157 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2158 i‡(
	`ã°_bô
(
i
, 
˛u°îm≠
)) {

2159 
˛u°îs
 +1 + 
zîos
;

2160 
zîos
 = 0;

2162 ++
zîos
;

2165  
˛u°îs
;

2166 
	}
}

2168 
__˝uöôd©a
 
	gmu…i_checked
;

2169 
__˝uöôd©a
 
	gmu…i
;

2171 
__˝uöô
 
	$£t_mu…i
(c⁄° 
dmi_sy°em_id
 *
d
)

2173 i‡(
mu…i
)

2175 
	`¥_öfo
("APIC: %†dëe˘ed, Mu…òChassis\n", 
d
->
idít
);

2176 
mu…i
 = 1;

2178 
	}
}

2180 c⁄° 
__˝uöôc⁄°
 
dmi_sy°em_id
 
	gmu…i_dmi_èbÀ
[] = {

2182 .
ˇŒback
 = 
£t_mu…i
,

2183 .
	gidít
 = "IBM System Summit2",

2184 .
	gm©ches
 = {

2185 
DMI_MATCH
(
DMI_SYS_VENDOR
, "IBM"),

2186 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Summit2"),

2192 
__˝uöô
 
	$dmi_check_mu…i
()

2194 i‡(
mu…i_checked
)

2197 
	`dmi_check_sy°em
(
mu…i_dmi_èbÀ
);

2198 
mu…i_checked
 = 1;

2199 
	}
}

2209 
__˝uöô
 
	$≠ic_is_˛u°îed_box
()

2211 
	`dmi_check_mu…i
();

2212 i‡(
mu…i
)

2215 i‡(!
	`is_vsmp_box
())

2222 i‡(
	`≠ic_˛u°î_num
() > 1)

2226 
	}
}

2232 
__öô
 
	$£tup_dißbÀ≠ic
(*
¨g
)

2234 
dißbÀ_≠ic
 = 1;

2235 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

2237 
	}
}

2238 
óæy_∑øm
("dißbÀ≠ic", 
£tup_dißbÀ≠ic
);

2241 
__öô
 
	$£tup_nﬁ≠ic
(*
¨g
)

2243  
	`£tup_dißbÀ≠ic
(
¨g
);

2244 
	}
}

2245 
óæy_∑øm
("nﬁ≠ic", 
£tup_nﬁ≠ic
);

2247 
__öô
 
	$∑r£_œpic_timî_c2_ok
(*
¨g
)

2249 
loˇl_≠ic_timî_c2_ok
 = 1;

2251 
	}
}

2252 
óæy_∑øm
("œpic_timî_c2_ok", 
∑r£_œpic_timî_c2_ok
);

2254 
__öô
 
	$∑r£_dißbÀ_≠ic_timî
(*
¨g
)

2256 
dißbÀ_≠ic_timî
 = 1;

2258 
	}
}

2259 
óæy_∑øm
("nﬂpi˘imî", 
∑r£_dißbÀ_≠ic_timî
);

2261 
__öô
 
	$∑r£_nﬁ≠ic_timî
(*
¨g
)

2263 
dißbÀ_≠ic_timî
 = 1;

2265 
	}
}

2266 
óæy_∑øm
("nﬁ≠ic_timî", 
∑r£_nﬁ≠ic_timî
);

2268 
__öô
 
	$≠ic_£t_vîbosôy
(*
¨g
)

2270 i‡(!
¨g
) {

2271 #ifde‡
CONFIG_X86_64


2272 
skù_iﬂpic_£tup
 = 0;

2275  -
EINVAL
;

2278 i‡(
	`°rcmp
("debug", 
¨g
) == 0)

2279 
≠ic_vîbosôy
 = 
APIC_DEBUG
;

2280 i‡(
	`°rcmp
("vîbo£", 
¨g
) == 0)

2281 
≠ic_vîbosôy
 = 
APIC_VERBOSE
;

2283 
	`¥_w¨nög
("APIC VerbosityÜevel %sÇotÑecognised"

2284 " u£ápic=vîbo£ o∏≠ic=debug\n", 
¨g
);

2285  -
EINVAL
;

2289 
	}
}

2290 
óæy_∑øm
("≠ic", 
≠ic_£t_vîbosôy
);

2292 
__öô
 
	$œpic_ö£π_ªsour˚
()

2294 i‡(!
≠ic_phys
)

2298 
œpic_ªsour˚
.
°¨t
 = 
≠ic_phys
;

2299 
œpic_ªsour˚
.
íd
 =Ü≠ic_ªsour˚.
°¨t
 + 
PAGE_SIZE
 - 1;

2300 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
œpic_ªsour˚
);

2303 
	}
}

2309 
œã_öôˇŒ
(
œpic_ö£π_ªsour˚
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/≠ic.h
>

21 
	~<asm/ùi.h
>

23 #ifde‡
CONFIG_ACPI


24 
	~<a˝i/a˝i_bus.h
>

27 
	$Ê©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

30 
	}
}

32 c⁄° 
˝umask
 *
	$Ê©_èrgë_˝us
()

34  
˝u_⁄löe_mask
;

35 
	}
}

37 
	$Ê©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

47 
	`˝umask_˛ór
(
ªtmask
);

48 
	`˝umask_bôs
(
ªtmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$Ê©_öô_≠ic_ldr
()

60 
vÆ
;

61 
num
, 
id
;

63 
num
 = 
	`smp_¥o˚ss‹_id
();

64 
id
 = 1UL << 
num
;

65 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

67 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

69 
	}
}

71 
ölöe
 
	$_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
)

73 
Êags
;

75 
	`loˇl_úq_ßve
(
Êags
);

76 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

77 
	`loˇl_úq_ª°‹e
(
Êags
);

78 
	}
}

80 
	$Ê©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

82 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

84 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

85 
	}
}

88 
	$Ê©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

90 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

91 
˝u
 = 
	`smp_¥o˚ss‹_id
();

93 i‡(
˝u
 < 
BITS_PER_LONG
)

94 
	`˛ór_bô
(
˝u
, &
mask
);

96 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

97 
	}
}

99 
	$Ê©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

101 
˝u
 = 
	`smp_¥o˚ss‹_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hŸ∂ug
 = 1;

105 
hŸ∂ug
 = 0;

107 i‡(
hŸ∂ug
 || 
ve˘‹
 =
NMI_VECTOR
) {

108 i‡(!
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
	`˝umask_of
(
˝u
))) {

109 
mask
 = 
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0];

111 i‡(
˝u
 < 
BITS_PER_LONG
)

112 
	`˛ór_bô
(
˝u
, &
mask
);

114 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

116 } i‡(
	`num_⁄löe_˝us
() > 1) {

117 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLBUT
,

118 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

120 
	}
}

122 
	$Ê©_£nd_IPI_Æl
(
ve˘‹
)

124 i‡(
ve˘‹
 =
NMI_VECTOR
) {

125 
	`Ê©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

127 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLINC
,

128 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

130 
	}
}

132 
	$Ê©_gë_≠ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_≠ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$ªad_x≠ic_id
()

151 
id
;

153 
id
 = 
	`Ê©_gë_≠ic_id
(
	`≠ic_ªad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$Ê©_≠ic_id_ªgi°îed
()

159  
	`physid_is£t
(
	`ªad_x≠ic_id
(), 
phys_˝u_¥e£¡_m≠
);

160 
	}
}

162 
	$Ê©_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

164  
öôül_≠ic_id
 >> 
ödex_msb
;

165 
	}
}

167 
≠ic
 
	g≠ic_Ê©
 = {

168 .
«me
 = "flat",

169 .
	g¥obe
 = 
NULL
,

170 .
	ga˝i_madt_€m_check
 = 
Ê©_a˝i_madt_€m_check
,

171 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

173 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

174 .
	gúq_de°_mode
 = 1,

176 .
	gèrgë_˝us
 = 
Ê©_èrgë_˝us
,

177 .
	gdißbÀ_e§
 = 0,

178 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_≠icid_u£d
 = 
NULL
,

180 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

182 .
	gve˘‹_Æloˇti⁄_domaö
 = 
Ê©_ve˘‹_Æloˇti⁄_domaö
,

183 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

185 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

186 .
	g£tup_≠ic_routög
 = 
NULL
,

187 .
	gmu…i_timî_check
 = 
NULL
,

188 .
	g≠icid_to_node
 = 
NULL
,

189 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

190 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

191 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

192 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

193 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

194 .
	gíabÀ_≠ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

196 .
	gmps_€m_check
 = 
NULL
,

198 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

199 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

200 .
	g≠ic_id_mask
 = 0xFFu << 24,

202 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

203 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

205 .
	g£nd_IPI_mask
 = 
Ê©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_Ælbut£lf
 = 
Ê©_£nd_IPI_mask_Ælbut£lf
,

207 .
	g£nd_IPI_Ælbut£lf
 = 
Ê©_£nd_IPI_Ælbut£lf
,

208 .
	g£nd_IPI_Æl
 = 
Ê©_£nd_IPI_Æl
,

209 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

211 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

214 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

215 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

217 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

218 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

219 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

220 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

221 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

222 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

230 
	$physÊ©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

232 #ifde‡
CONFIG_ACPI


238 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

239 (
a˝i_gbl_FADT
.
Êags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`¥ötk
(
KERN_DEBUG
 "system APIC only can useÖhysical flat");

244 i‡(!
	`°∫cmp
(
€m_id
, "IBM", 3Ë&& !°∫cmp(
€m_èbÀ_id
, "EXA", 3)) {

245 
	`¥ötk
(
KERN_DEBUG
 "IBM Summit detected, will useápicÖhysical");

251 
	}
}

253 c⁄° 
˝umask
 *
	$physÊ©_èrgë_˝us
()

255  
˝u_⁄löe_mask
;

256 
	}
}

258 
	$physÊ©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

260 
	`˝umask_˛ór
(
ªtmask
);

261 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

262 
	}
}

264 
	$physÊ©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

266 
	`deÁu…_£nd_IPI_mask_£quí˚_phys
(
˝umask
, 
ve˘‹
);

267 
	}
}

269 
	$physÊ©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *cpumask,

270 
ve˘‹
)

272 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝umask
, 
ve˘‹
);

273 
	}
}

275 
	$physÊ©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

277 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝u_⁄löe_mask
, 
ve˘‹
);

278 
	}
}

280 
	$physÊ©_£nd_IPI_Æl
(
ve˘‹
)

282 
	`physÊ©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

283 
	}
}

285 
	$physÊ©_˝u_mask_to_≠icid
(c⁄° 
˝umask
 *cpumask)

287 
˝u
;

293 
˝u
 = 
	`˝umask_fú°
(
˝umask
);

294 i‡(()
˝u
 < 
ƒ_˝u_ids
)

295  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

297  
BAD_APICID
;

298 
	}
}

301 
	$physÊ©_˝u_mask_to_≠icid_™d
(c⁄° 
˝umask
 *cpumask,

302 c⁄° 
˝umask
 *
™dmask
)

304 
˝u
;

310 
	`f‹_óch_˝u_™d
(
˝u
, 
˝umask
, 
™dmask
) {

311 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_⁄löe_mask
))

314  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

315 
	}
}

317 
≠ic
 
	g≠ic_physÊ©
 = {

319 .
«me
 = "physical flat",

320 .
	g¥obe
 = 
NULL
,

321 .
	ga˝i_madt_€m_check
 = 
physÊ©_a˝i_madt_€m_check
,

322 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

324 .
	gúq_dñivîy_mode
 = 
de°_Fixed
,

325 .
	gúq_de°_mode
 = 0,

327 .
	gèrgë_˝us
 = 
physÊ©_èrgë_˝us
,

328 .
	gdißbÀ_e§
 = 0,

329 .
	gde°_logiˇl
 = 0,

330 .
	gcheck_≠icid_u£d
 = 
NULL
,

331 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

333 .
	gve˘‹_Æloˇti⁄_domaö
 = 
physÊ©_ve˘‹_Æloˇti⁄_domaö
,

335 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

337 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

338 .
	g£tup_≠ic_routög
 = 
NULL
,

339 .
	gmu…i_timî_check
 = 
NULL
,

340 .
	g≠icid_to_node
 = 
NULL
,

341 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

342 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

343 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

344 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

345 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

346 .
	gíabÀ_≠ic_mode
 = 
NULL
,

347 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

348 .
	gmps_€m_check
 = 
NULL
,

350 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

351 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

352 .
	g≠ic_id_mask
 = 0xFFu << 24,

354 .
	g˝u_mask_to_≠icid
 = 
physÊ©_˝u_mask_to_≠icid
,

355 .
	g˝u_mask_to_≠icid_™d
 = 
physÊ©_˝u_mask_to_≠icid_™d
,

357 .
	g£nd_IPI_mask
 = 
physÊ©_£nd_IPI_mask
,

358 .
	g£nd_IPI_mask_Ælbut£lf
 = 
physÊ©_£nd_IPI_mask_Ælbut£lf
,

359 .
	g£nd_IPI_Ælbut£lf
 = 
physÊ©_£nd_IPI_Ælbut£lf
,

360 .
	g£nd_IPI_Æl
 = 
physÊ©_£nd_IPI_Æl
,

361 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

363 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

364 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

365 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

366 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

367 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

369 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

370 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

371 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

372 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

373 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

374 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/˘y≥.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/î∫o.h
>

20 
	~<asm/fixm≠.h
>

21 
	~<asm/mp•ec.h
>

22 
	~<asm/≠icdef.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/£tup.h
>

26 
	~<löux/smp.h
>

27 
	~<asm/ùi.h
>

29 
	~<löux/öãºu±.h
>

30 
	~<asm/a˝i.h
>

31 
	~<asm/e820.h
>

33 
	$no›_öô_≠ic_ldr
(Ë{ 
	}
}

34 
	$no›_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

35 
	$no›_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

36 
	$no›_£nd_IPI_Ælbut£lf
(
ve˘‹
Ë{ 
	}
}

37 
	$no›_£nd_IPI_Æl
(
ve˘‹
Ë{ 
	}
}

38 
	$no›_£nd_IPI_£lf
(
ve˘‹
Ë{ 
	}
}

39 
	$no›_≠ic_waô_i¸_idÀ
(Ë{ 
	}
}

40 
	$no›_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
Ë{ 
	}
}

42 
	$no›_wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_eù
)

45 
	}
}

47 
u32
 
	$no›_ß„_≠ic_waô_i¸_idÀ
()

50 
	}
}

52 
u64
 
	$no›_≠ic_i¸_ªad
()

55 
	}
}

57 
	$no›_˝u_to_logiˇl_≠icid
(
˝u
)

60 
	}
}

62 
	$no›_phys_pkg_id
(
˝uid_≠ic
, 
ödex_msb
)

65 
	}
}

67 
	$no›_gë_≠ic_id
(
x
)

70 
	}
}

72 
	$no›_¥obe
()

79 
	}
}

81 
	$no›_≠ic_id_ªgi°îed
()

89  
	`physid_is£t
(0, 
phys_˝u_¥e£¡_m≠
);

90 
	}
}

92 c⁄° 
˝umask
 *
	$no›_èrgë_˝us
()

95  
	`˝umask_of
(0);

96 
	}
}

98 
	$no›_check_≠icid_u£d
(
physid_mask_t
 *
m≠
, 
≠icid
)

100  
	`physid_is£t
(
≠icid
, *
m≠
);

101 
	}
}

103 
	$no›_check_≠icid_¥e£¡
(
bô
)

105  
	`physid_is£t
(
bô
, 
phys_˝u_¥e£¡_m≠
);

106 
	}
}

108 
	$no›_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

110 i‡(
˝u
 != 0)

111 
	`¥_w¨nög
("APIC: Vectorállocated forÇon-BSP cpu\n");

112 
	`˝umask_˛ór
(
ªtmask
);

113 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

114 
	}
}

116 
	$no›_≠icid_to_node
(
logiˇl_≠icid
)

120 
	}
}

122 
u32
 
	$no›_≠ic_ªad
(
u32
 
ªg
)

124 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 && !
dißbÀ_≠ic
));

126 
	}
}

128 
	$no›_≠ic_wrôe
(
u32
 
ªg
, u32 
v
)

130 
	`WARN_ON_ONCE
(
˝u_has_≠ic
 && !
dißbÀ_≠ic
);

131 
	}
}

133 
≠ic
 
	g≠ic_no›
 = {

134 .
«me
 = "noop",

135 .
	g¥obe
 = 
no›_¥obe
,

136 .
	ga˝i_madt_€m_check
 = 
NULL
,

138 .
	g≠ic_id_ªgi°îed
 = 
no›_≠ic_id_ªgi°îed
,

140 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

142 .
	gúq_de°_mode
 = 1,

144 .
	gèrgë_˝us
 = 
no›_èrgë_˝us
,

145 .
	gdißbÀ_e§
 = 0,

146 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

147 .
	gcheck_≠icid_u£d
 = 
no›_check_≠icid_u£d
,

148 .
	gcheck_≠icid_¥e£¡
 = 
no›_check_≠icid_¥e£¡
,

150 .
	gve˘‹_Æloˇti⁄_domaö
 = 
no›_ve˘‹_Æloˇti⁄_domaö
,

151 .
	göô_≠ic_ldr
 = 
no›_öô_≠ic_ldr
,

153 .
	giﬂpic_phys_id_m≠
 = 
deÁu…_iﬂpic_phys_id_m≠
,

154 .
	g£tup_≠ic_routög
 = 
NULL
,

155 .
	gmu…i_timî_check
 = 
NULL
,

156 .
	g≠icid_to_node
 = 
no›_≠icid_to_node
,

158 .
	g˝u_to_logiˇl_≠icid
 = 
no›_˝u_to_logiˇl_≠icid
,

159 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

160 .
	g≠icid_to_˝u_¥e£¡
 = 
physid_£t_mask_of_physid
,

162 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

163 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

164 .
	gíabÀ_≠ic_mode
 = 
NULL
,

166 .
	gphys_pkg_id
 = 
no›_phys_pkg_id
,

168 .
	gmps_€m_check
 = 
NULL
,

170 .
	ggë_≠ic_id
 = 
no›_gë_≠ic_id
,

171 .
	g£t_≠ic_id
 = 
NULL
,

172 .
	g≠ic_id_mask
 = 0x0F << 24,

174 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

175 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

177 .
	g£nd_IPI_mask
 = 
no›_£nd_IPI_mask
,

178 .
	g£nd_IPI_mask_Ælbut£lf
 = 
no›_£nd_IPI_mask_Ælbut£lf
,

179 .
	g£nd_IPI_Ælbut£lf
 = 
no›_£nd_IPI_Ælbut£lf
,

180 .
	g£nd_IPI_Æl
 = 
no›_£nd_IPI_Æl
,

181 .
	g£nd_IPI_£lf
 = 
no›_£nd_IPI_£lf
,

183 .
	gwakeup_£c⁄d¨y_˝u
 = 
no›_wakeup_£c⁄d¨y_˝u
,

186 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

187 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

189 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

191 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

192 .
	göquúe_ªmŸe_≠ic
 = 
NULL
,

194 .
	gªad
 = 
no›_≠ic_ªad
,

195 .
	gwrôe
 = 
no›_≠ic_wrôe
,

196 .
	gi¸_ªad
 = 
no›_≠ic_i¸_ªad
,

197 .
	gi¸_wrôe
 = 
no›_≠ic_i¸_wrôe
,

198 .
	gwaô_i¸_idÀ
 = 
no›_≠ic_waô_i¸_idÀ
,

199 .
	gß„_waô_i¸_idÀ
 = 
no›_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<löux/mm.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/sched.h
>

28 
	~<löux/pci.h
>

29 
	~<löux/mc146818πc.h
>

30 
	~<löux/compûî.h
>

31 
	~<löux/a˝i.h
>

32 
	~<löux/moduÀ.h
>

33 
	~<löux/sysdev.h
>

34 
	~<löux/msi.h
>

35 
	~<löux/htúq.h
>

36 
	~<löux/‰ìzî.h
>

37 
	~<löux/kthªad.h
>

38 
	~<löux/jiffõs.h
>

39 
	~<löux/¶ab.h
>

40 #ifde‡
CONFIG_ACPI


41 
	~<a˝i/a˝i_bus.h
>

43 
	~<löux/boŸmem.h
>

44 
	~<löux/dm¨.h
>

45 
	~<löux/h≥t.h
>

47 
	~<asm/idÀ.h
>

48 
	~<asm/io.h
>

49 
	~<asm/smp.h
>

50 
	~<asm/˝u.h
>

51 
	~<asm/desc.h
>

52 
	~<asm/¥Ÿo.h
>

53 
	~<asm/a˝i.h
>

54 
	~<asm/dma.h
>

55 
	~<asm/timî.h
>

56 
	~<asm/i8259.h
>

57 
	~<asm/nmi.h
>

58 
	~<asm/msidef.h
>

59 
	~<asm/hy≥πøn•‹t.h
>

60 
	~<asm/£tup.h
>

61 
	~<asm/úq_ªm≠pög.h
>

62 
	~<asm/h≥t.h
>

63 
	~<asm/hw_úq.h
>

65 
	~<asm/≠ic.h
>

67 
	#__≠icdebugöô
(
ty≥
Ëty≥ 
__öô


	)

68 
	#f‹_óch_úq_pö
(
íåy
, 
hód
) \

69 
íåy
 = 
hód
;É¡ry;É¡ry =É¡ry->
√xt
)

	)

75 
	gsis_≠ic_bug
 = -1;

77 
DEFINE_RAW_SPINLOCK
(
iﬂpic_lock
);

78 
DEFINE_RAW_SPINLOCK
(
ve˘‹_lock
);

83 
	gƒ_iﬂpic_ªgi°îs
[
MAX_IO_APICS
];

86 
mpc_iﬂpic
 
	gmp_iﬂpics
[
MAX_IO_APICS
];

87 
	gƒ_iﬂpics
;

90 
mp_iﬂpic_gsi
 
	gmp_gsi_routög
[
MAX_IO_APICS
];

93 
mpc_öt§c
 
	gmp_úqs
[
MAX_IRQ_SOURCES
];

96 
	gmp_úq_íåõs
;

99 
	gƒ_úqs_gsi
 = 
NR_IRQS_LEGACY
;

101 #i‡
deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

102 
	gmp_bus_id_to_ty≥
[
MAX_MP_BUSSES
];

105 
DECLARE_BITMAP
(
mp_bus_nŸ_pci
, 
MAX_MP_BUSSES
);

107 
	gskù_iﬂpic_£tup
;

109 
	$¨ch_dißbÀ_smp_suµ‹t
()

111 #ifde‡
CONFIG_PCI


112 
noiﬂpicquúk
 = 1;

113 
noiﬂpi¸îouã
 = -1;

115 
skù_iﬂpic_£tup
 = 1;

116 
	}
}

118 
__öô
 
	$∑r£_nﬂpic
(*
°r
)

121 
	`¨ch_dißbÀ_smp_suµ‹t
();

123 
	}
}

124 
óæy_∑øm
("nﬂpic", 
∑r£_nﬂpic
);

126 
	súq_pö_li°
 {

127 
	m≠ic
, 
	mpö
;

128 
úq_pö_li°
 *
	m√xt
;

131 
úq_pö_li°
 *
	$gë_⁄e_‰ì_úq_2_pö
(
node
)

133 
úq_pö_li°
 *
pö
;

135 
pö
 = 
	`kzÆloc_node
((*pö), 
GFP_ATOMIC
, 
node
);

137  
pö
;

138 
	}
}

141 #ifde‡
CONFIG_SPARSE_IRQ


142 
úq_cfg
 
	gúq_cfgx
[
NR_IRQS_LEGACY
];

144 
úq_cfg
 
	gúq_cfgx
[
NR_IRQS
];

147 
__öô
 
	$¨ch_óæy_úq_öô
()

149 
úq_cfg
 *
cfg
;

150 
úq_desc
 *
desc
;

151 
cou¡
;

152 
node
;

153 
i
;

155 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

156 
ƒ_úqs_gsi
 = 0;

157 
io_≠ic_úqs
 = ~0UL;

160 
cfg
 = 
úq_cfgx
;

161 
cou¡
 = 
	`ARRAY_SIZE
(
úq_cfgx
);

162 
node

	`˝u_to_node
(
boŸ_˝u_id
);

164 
i
 = 0; i < 
cou¡
; i++) {

165 
desc
 = 
	`úq_to_desc
(
i
);

166 
desc
->
chù_d©a
 = &
cfg
[
i
];

167 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
domaö
, 
GFP_NOWAIT
, 
node
);

168 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
ﬁd_domaö
, 
GFP_NOWAIT
, 
node
);

173 i‡(
i
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

174 
cfg
[
i
].
ve˘‹
 = 
IRQ0_VECTOR
 + i;

175 
	`˝umask_£t_˝u
(0, 
cfg
[
i
].
domaö
);

180 
	}
}

182 #ifde‡
CONFIG_SPARSE_IRQ


183 
úq_cfg
 *
	$úq_cfg
(
úq
)

185 
úq_cfg
 *
cfg
 = 
NULL
;

186 
úq_desc
 *
desc
;

188 
desc
 = 
	`úq_to_desc
(
úq
);

189 i‡(
desc
)

190 
cfg
 = 
desc
->
chù_d©a
;

192  
cfg
;

193 
	}
}

195 
úq_cfg
 *
	$gë_⁄e_‰ì_úq_cfg
(
node
)

197 
úq_cfg
 *
cfg
;

199 
cfg
 = 
	`kzÆloc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

200 i‡(
cfg
) {

201 i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
domaö
, 
GFP_ATOMIC
, 
node
)) {

202 
	`k‰ì
(
cfg
);

203 
cfg
 = 
NULL
;

204 } i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
ﬁd_domaö
,

205 
GFP_ATOMIC
, 
node
)) {

206 
	`‰ì_˝umask_v¨
(
cfg
->
domaö
);

207 
	`k‰ì
(
cfg
);

208 
cfg
 = 
NULL
;

212  
cfg
;

213 
	}
}

215 
	$¨ch_öô_chù_d©a
(
úq_desc
 *
desc
, 
node
)

217 
úq_cfg
 *
cfg
;

219 
cfg
 = 
desc
->
chù_d©a
;

220 i‡(!
cfg
) {

221 
desc
->
chù_d©a
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

222 i‡(!
desc
->
chù_d©a
) {

223 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_cfg\n");

224 
	`BUG_ON
(1);

229 
	}
}

233 
	$öô_c›y_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
, 
node
)

235 
úq_pö_li°
 *
ﬁd_íåy
, *
hód
, *
èû
, *
íåy
;

237 
cfg
->
úq_2_pö
 = 
NULL
;

238 
ﬁd_íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

239 i‡(!
ﬁd_íåy
)

242 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

243 i‡(!
íåy
)

246 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

247 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

248 
hód
 = 
íåy
;

249 
èû
 = 
íåy
;

250 
ﬁd_íåy
 = old_íåy->
√xt
;

251 
ﬁd_íåy
) {

252 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

253 i‡(!
íåy
) {

254 
íåy
 = 
hód
;

255 
íåy
) {

256 
hód
 = 
íåy
->
√xt
;

257 
	`k‰ì
(
íåy
);

258 
íåy
 = 
hód
;

263 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

264 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

265 
èû
->
√xt
 = 
íåy
;

266 
èû
 = 
íåy
;

267 
ﬁd_íåy
 = old_íåy->
√xt
;

270 
èû
->
√xt
 = 
NULL
;

271 
cfg
->
úq_2_pö
 = 
hód
;

272 
	}
}

274 
	$‰ì_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
)

276 
úq_pö_li°
 *
íåy
, *
√xt
;

278 i‡(
ﬁd_cfg
->
úq_2_pö
 =
cfg
->irq_2_pin)

281 
íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

283 
íåy
) {

284 
√xt
 = 
íåy
->next;

285 
	`k‰ì
(
íåy
);

286 
íåy
 = 
√xt
;

288 
ﬁd_cfg
->
úq_2_pö
 = 
NULL
;

289 
	}
}

291 
	$¨ch_öô_c›y_chù_d©a
(
úq_desc
 *
ﬁd_desc
,

292 
úq_desc
 *
desc
, 
node
)

294 
úq_cfg
 *
cfg
;

295 
úq_cfg
 *
ﬁd_cfg
;

297 
cfg
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

299 i‡(!
cfg
)

302 
desc
->
chù_d©a
 = 
cfg
;

304 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

306 
	`mem˝y
(
cfg
, 
ﬁd_cfg
, (
úq_cfg
));

308 
	`öô_c›y_úq_2_pö
(
ﬁd_cfg
, 
cfg
, 
node
);

309 
	}
}

311 
	$‰ì_úq_cfg
(
úq_cfg
 *
ﬁd_cfg
)

313 
	`k‰ì
(
ﬁd_cfg
);

314 
	}
}

316 
	$¨ch_‰ì_chù_d©a
(
úq_desc
 *
ﬁd_desc
, úq_des¯*
desc
)

318 
úq_cfg
 *
ﬁd_cfg
, *
cfg
;

320 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

321 
cfg
 = 
desc
->
chù_d©a
;

323 i‡(
ﬁd_cfg
 =
cfg
)

326 i‡(
ﬁd_cfg
) {

327 
	`‰ì_úq_2_pö
(
ﬁd_cfg
, 
cfg
);

328 
	`‰ì_úq_cfg
(
ﬁd_cfg
);

329 
ﬁd_desc
->
chù_d©a
 = 
NULL
;

331 
	}
}

335 
úq_cfg
 *
	$úq_cfg
(
úq
)

337  
úq
 < 
ƒ_úqs
 ? 
úq_cfgx
 + irq : 
NULL
;

338 
	}
}

342 
	sio_≠ic
 {

343 
	mödex
;

344 
	munu£d
[3];

345 
	md©a
;

346 
	munu£d2
[11];

347 
	meoi
;

350 
__©åibuã_c⁄°__
 
io_≠ic
 
__iomem
 *
	$io_≠ic_ba£
(
idx
)

352  (
__iomem
 *Ë
	`__fix_to_vút
(
FIX_IO_APIC_BASE_0
 + 
idx
)

353 + (
mp_iﬂpics
[
idx
].
≠iˇddr
 & ~
PAGE_MASK
);

354 
	}
}

356 
ölöe
 
	$io_≠ic_eoi
(
≠ic
, 
ve˘‹
)

358 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

359 
	`wrôñ
(
ve˘‹
, &
io_≠ic
->
eoi
);

360 
	}
}

362 
ölöe
 
	$io_≠ic_ªad
(
≠ic
, 
ªg
)

364 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

365 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

366  
	`ªadl
(&
io_≠ic
->
d©a
);

367 
	}
}

369 
ölöe
 
	$io_≠ic_wrôe
(
≠ic
, 
ªg
, 
vÆue
)

371 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

372 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

373 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

374 
	}
}

382 
ölöe
 
	$io_≠ic_modify
(
≠ic
, 
ªg
, 
vÆue
)

384 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

386 i‡(
sis_≠ic_bug
)

387 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

388 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

389 
	}
}

391 
boﬁ
 
	$io_≠ic_Àvñ_ack_≥ndög
(
úq_cfg
 *
cfg
)

393 
úq_pö_li°
 *
íåy
;

394 
Êags
;

396 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

397 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

398 
ªg
;

399 
pö
;

401 
pö
 = 
íåy
->pin;

402 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
*2);

404 i‡(
ªg
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

405 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

406  
åue
;

409 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

411  
Ál£
;

412 
	}
}

414 
	uíåy_uni⁄
 {

415 °ru˘ { 
u32
 
	mw1
, 
	mw2
; };

416 
IO_APIC_rouã_íåy
 
	míåy
;

419 
IO_APIC_rouã_íåy
 
	$iﬂpic_ªad_íåy
(
≠ic
, 
pö
)

421 
íåy_uni⁄
 
eu
;

422 
Êags
;

423 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

424 
eu
.
w1
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 2 * 
pö
);

425 
eu
.
w2
 = 
	`io_≠ic_ªad
(
≠ic
, 0x11 + 2 * 
pö
);

426 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

427  
eu
.
íåy
;

428 
	}
}

437 
	$__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

439 
íåy_uni⁄
 
eu
 = {{0, 0}};

441 
eu
.
íåy
 = 
e
;

442 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

443 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

444 
	}
}

446 
	$iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

448 
Êags
;

449 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

450 
	`__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
e
);

451 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

452 
	}
}

459 
	$iﬂpic_mask_íåy
(
≠ic
, 
pö
)

461 
Êags
;

462 
íåy_uni⁄
 
eu
 = { .
íåy
.
mask
 = 1 };

464 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

465 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

466 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

467 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

468 
	}
}

476 
	$add_pö_to_úq_node_n›™ic
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

478 
úq_pö_li°
 **
œ°
, *
íåy
;

481 
œ°
 = &
cfg
->
úq_2_pö
;

482 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

483 i‡(
íåy
->
≠ic
 =≠i¯&&É¡ry->
pö
 ==Öin)

485 
œ°
 = &
íåy
->
√xt
;

488 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

489 i‡(!
íåy
) {

490 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_pin_list (%d,%d,%d)\n",

491 
node
, 
≠ic
, 
pö
);

492  -
ENOMEM
;

494 
íåy
->
≠ic
 =ápic;

495 
íåy
->
pö
 =Öin;

497 *
œ°
 = 
íåy
;

499 
	}
}

501 
	$add_pö_to_úq_node
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

503 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
≠ic
, 
pö
))

504 
	`∑nic
("IO-APIC: failedÅoádd irq-pin. CanÇotÖroceed\n");

505 
	}
}

510 
__öô
 
	$ª∂a˚_pö_©_úq_node
(
úq_cfg
 *
cfg
, 
node
,

511 
ﬁd≠ic
, 
ﬁdpö
,

512 
√w≠ic
, 
√wpö
)

514 
úq_pö_li°
 *
íåy
;

516 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

517 i‡(
íåy
->
≠ic
 =
ﬁd≠ic
 &&É¡ry->
pö
 =
ﬁdpö
) {

518 
íåy
->
≠ic
 = 
√w≠ic
;

519 
íåy
->
pö
 = 
√wpö
;

526 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
√w≠ic
, 
√wpö
);

527 
	}
}

529 
__io_≠ic_modify_úq
(
úq_pö_li°
 *
íåy
,

530 
mask_™d
, 
mask_‹
,

531 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

533 
ªg
, 
pö
;

535 
pö
 = 
íåy
->pin;

536 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2);

537 
ªg
 &
mask_™d
;

538 
ªg
 |
mask_‹
;

539 
	`io_≠ic_modify
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2, 
ªg
);

540 i‡(
föÆ
)

541 
	`föÆ
(
íåy
);

542 
	}
}

544 
io_≠ic_modify_úq
(
úq_cfg
 *
cfg
,

545 
mask_™d
, 
mask_‹
,

546 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

548 
úq_pö_li°
 *
íåy
;

550 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

551 
	`__io_≠ic_modify_úq
(
íåy
, 
mask_™d
, 
mask_‹
, 
föÆ
);

552 
	}
}

554 
	$__mask_™d_edge_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

556 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

557 
IO_APIC_REDIR_MASKED
, 
NULL
);

558 
	}
}

560 
	$__unmask_™d_Àvñ_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

562 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_MASKED
,

563 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

564 
	}
}

566 
	$__unmask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

568 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

569 
	}
}

571 
	$io_≠ic_sync
(
úq_pö_li°
 *
íåy
)

577 
io_≠ic
 
__iomem
 *io_apic;

578 
io_≠ic
 = 
	`io_≠ic_ba£
(
íåy
->
≠ic
);

579 
	`ªadl
(&
io_≠ic
->
d©a
);

580 
	}
}

582 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

584 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_≠ic_sync
);

585 
	}
}

587 
	$mask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

589 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

590 
Êags
;

592 
	`BUG_ON
(!
cfg
);

594 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

595 
	`__mask_IO_APIC_úq
(
cfg
);

596 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

597 
	}
}

599 
	$unmask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

601 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

602 
Êags
;

604 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

605 
	`__unmask_IO_APIC_úq
(
cfg
);

606 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

607 
	}
}

609 
	$mask_IO_APIC_úq
(
úq
)

611 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

613 
	`mask_IO_APIC_úq_desc
(
desc
);

614 
	}
}

615 
	$unmask_IO_APIC_úq
(
úq
)

617 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

619 
	`unmask_IO_APIC_úq_desc
(
desc
);

620 
	}
}

622 
	$˛ór_IO_APIC_pö
(
≠ic
, 
pö
)

624 
IO_APIC_rouã_íåy
 
íåy
;

627 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

628 i‡(
íåy
.
dñivîy_mode
 =
de°_SMI
)

633 
	`iﬂpic_mask_íåy
(
≠ic
, 
pö
);

634 
	}
}

636 
	$˛ór_IO_APIC
 ()

638 
≠ic
, 
pö
;

640 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

641 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

642 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

643 
	}
}

645 #ifde‡
CONFIG_X86_32


651 
	#MAX_PIRQS
 8

	)

652 
	gpúq_íåõs
[
MAX_PIRQS
] = {

653 [0 ... 
MAX_PIRQS
 - 1] = -1

656 
__öô
 
	$iﬂpic_púq_£tup
(*
°r
)

658 
i
, 
max
;

659 
öts
[
MAX_PIRQS
+1];

661 
	`gë_›ti⁄s
(
°r
, 
	`ARRAY_SIZE
(
öts
), ints);

663 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


665 
max
 = 
MAX_PIRQS
;

666 i‡(
öts
[0] < 
MAX_PIRQS
)

667 
max
 = 
öts
[0];

669 
i
 = 0; i < 
max
; i++) {

670 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


671 "... PIRQ%d -> IRQ %d\n", 
i
, 
öts
[i+1]);

675 
púq_íåõs
[
MAX_PIRQS
-
i
-1] = 
öts
[i+1];

678 
	}
}

680 
__£tup
("púq=", 
iﬂpic_púq_£tup
);

683 
IO_APIC_rouã_íåy
 **
	$Æloc_iﬂpic_íåõs
()

685 
≠ic
;

686 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
;

688 
iﬂpic_íåõs
 = 
	`kzÆloc
((*iﬂpic_íåõsË* 
ƒ_iﬂpics
,

689 
GFP_ATOMIC
);

690 i‡(!
iﬂpic_íåõs
)

693 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

694 
iﬂpic_íåõs
[
≠ic
] =

695 
	`kzÆloc
((
IO_APIC_rouã_íåy
) *

696 
ƒ_iﬂpic_ªgi°îs
[
≠ic
], 
GFP_ATOMIC
);

697 i‡(!
iﬂpic_íåõs
[
≠ic
])

698 
nomem
;

701  
iﬂpic_íåõs
;

703 
nomem
:

704 --
≠ic
 >= 0)

705 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

706 
	`k‰ì
(
iﬂpic_íåõs
);

709 
	}
}

714 
	$ßve_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

716 
≠ic
, 
pö
;

718 i‡(!
iﬂpic_íåõs
)

719  -
ENOMEM
;

721 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

722 i‡(!
iﬂpic_íåõs
[
≠ic
])

723  -
ENOMEM
;

725 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

726 
iﬂpic_íåõs
[
≠ic
][
pö
] =

727 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

731 
	}
}

736 
	$mask_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

738 
≠ic
, 
pö
;

740 i‡(!
iﬂpic_íåõs
)

743 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

744 i‡(!
iﬂpic_íåõs
[
≠ic
])

747 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

748 
IO_APIC_rouã_íåy
 
íåy
;

750 
íåy
 = 
iﬂpic_íåõs
[
≠ic
][
pö
];

751 i‡(!
íåy
.
mask
) {

752 
íåy
.
mask
 = 1;

753 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy
);

757 
	}
}

762 
	$ª°‹e_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

764 
≠ic
, 
pö
;

766 i‡(!
iﬂpic_íåõs
)

767  -
ENOMEM
;

769 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

770 i‡(!
iﬂpic_íåõs
[
≠ic
])

771  -
ENOMEM
;

773 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

774 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
,

775 
iﬂpic_íåõs
[
≠ic
][
pö
]);

778 
	}
}

780 
	$‰ì_iﬂpic_íåõs
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

782 
≠ic
;

784 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

785 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

787 
	`k‰ì
(
iﬂpic_íåõs
);

788 
	}
}

793 
	$föd_úq_íåy
(
≠ic
, 
pö
, 
ty≥
)

795 
i
;

797 
i
 = 0; i < 
mp_úq_íåõs
; i++)

798 i‡(
mp_úqs
[
i
].
úqty≥
 =
ty≥
 &&

799 (
mp_úqs
[
i
].
d°≠ic
 =
mp_iﬂpics
[
≠ic
].
≠icid
 ||

800 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
) &&

801 
mp_úqs
[
i
].
d°úq
 =
pö
)

802  
i
;

805 
	}
}

810 
__öô
 
	$föd_iß_úq_pö
(
úq
, 
ty≥
)

812 
i
;

814 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

815 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

817 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

818 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

819 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

821  
mp_úqs
[
i
].
d°úq
;

824 
	}
}

826 
__öô
 
	$föd_iß_úq_≠ic
(
úq
, 
ty≥
)

828 
i
;

830 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

831 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

833 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

834 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

835 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

838 i‡(
i
 < 
mp_úq_íåõs
) {

839 
≠ic
;

840 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

841 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
)

842  
≠ic
;

847 
	}
}

849 #i‡
deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

853 
	$EISA_ELCR
(
úq
)

855 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

856 
p‹t
 = 0x4d0 + (
úq
 >> 3);

857  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

859 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


860 "Brokí MPèbÀÑï‹t†ISA irq %d\n", 
úq
);

862 
	}
}

869 
	#deÁu…_ISA_åiggî
(
idx
Ë(0)

	)

870 
	#deÁu…_ISA_pﬁ¨ôy
(
idx
Ë(0)

	)

877 
	#deÁu…_EISA_åiggî
(
idx
Ë(
	`EISA_ELCR
(
mp_úqs
[idx].
§cbusúq
))

	)

878 
	#deÁu…_EISA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

883 
	#deÁu…_PCI_åiggî
(
idx
Ë(1)

	)

884 
	#deÁu…_PCI_pﬁ¨ôy
(
idx
Ë(1)

	)

889 
	#deÁu…_MCA_åiggî
(
idx
Ë(1)

	)

890 
	#deÁu…_MCA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

892 
	$MPBIOS_pﬁ¨ôy
(
idx
)

894 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

895 
pﬁ¨ôy
;

900 
mp_úqs
[
idx
].
úqÊag
 & 3)

903 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

904 
pﬁ¨ôy
 = 
	`deÁu…_ISA_pﬁ¨ôy
(
idx
);

906 
pﬁ¨ôy
 = 
	`deÁu…_PCI_pﬁ¨ôy
(
idx
);

910 
pﬁ¨ôy
 = 0;

915 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

916 
pﬁ¨ôy
 = 1;

921 
pﬁ¨ôy
 = 1;

926 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

927 
pﬁ¨ôy
 = 1;

931  
pﬁ¨ôy
;

932 
	}
}

934 
	$MPBIOS_åiggî
(
idx
)

936 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

937 
åiggî
;

942 (
mp_úqs
[
idx
].
úqÊag
>>2) & 3)

945 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

946 
åiggî
 = 
	`deÁu…_ISA_åiggî
(
idx
);

948 
åiggî
 = 
	`deÁu…_PCI_åiggî
(
idx
);

949 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

950 
mp_bus_id_to_ty≥
[
bus
]) {

951 
MP_BUS_ISA
:

956 
MP_BUS_EISA
:

958 
åiggî
 = 
	`deÁu…_EISA_åiggî
(
idx
);

961 
MP_BUS_PCI
:

966 
MP_BUS_MCA
:

968 
åiggî
 = 
	`deÁu…_MCA_åiggî
(
idx
);

973 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

974 
åiggî
 = 1;

982 
åiggî
 = 0;

987 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

988 
åiggî
 = 1;

993 
åiggî
 = 1;

998 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

999 
åiggî
 = 0;

1003  
åiggî
;

1004 
	}
}

1006 
ölöe
 
	$úq_pﬁ¨ôy
(
idx
)

1008  
	`MPBIOS_pﬁ¨ôy
(
idx
);

1009 
	}
}

1011 
ölöe
 
	$úq_åiggî
(
idx
)

1013  
	`MPBIOS_åiggî
(
idx
);

1014 
	}
}

1016 (*
iﬂpic_ªnumbî_úq
)(
iﬂpic
, 
úq
);

1017 
	$pö_2_úq
(
idx
, 
≠ic
, 
pö
)

1019 
úq
, 
i
;

1020 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

1025 i‡(
mp_úqs
[
idx
].
d°úq
 !
pö
)

1026 
	`¥ötk
(
KERN_ERR
 "broken BIOS or MPTABLEÖarser,áyiee!!\n");

1028 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1029 
úq
 = 
mp_úqs
[
idx
].
§cbusúq
;

1034 
i
 = 
úq
 = 0;

1035 
i
 < 
≠ic
)

1036 
úq
 +
ƒ_iﬂpic_ªgi°îs
[
i
++];

1037 
úq
 +
pö
;

1041 i‡(
iﬂpic_ªnumbî_úq
)

1042 
úq
 = 
	`iﬂpic_ªnumbî_úq
(
≠ic
, irq);

1045 #ifde‡
CONFIG_X86_32


1049 i‡((
pö
 >= 16) && (pin <= 23)) {

1050 i‡(
púq_íåõs
[
pö
-16] != -1) {

1051 i‡(!
púq_íåõs
[
pö
-16]) {

1052 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1053 "dißblög PIRQ%d\n", 
pö
-16);

1055 
úq
 = 
púq_íåõs
[
pö
-16];

1056 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1058 
pö
-16, 
úq
);

1064  
úq
;

1065 
	}
}

1071 
	$IO_APIC_gë_PCI_úq_ve˘‹
(
bus
, 
¶Ÿ
, 
pö
,

1072 
io_≠ic_úq_©å
 *
úq_©å
)

1074 
≠ic
, 
i
, 
be°_guess
 = -1;

1076 
	`≠ic_¥ötk
(
APIC_DEBUG
,

1078 
bus
, 
¶Ÿ
, 
pö
);

1079 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1080 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1081 "PCI BIOSÖas£dÇ⁄exi°íàPCI bu†%d!\n", 
bus
);

1084 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

1085 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

1087 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

1088 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
 ||

1089 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
)

1092 i‡(!
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

1093 !
mp_úqs
[
i
].
úqty≥
 &&

1094 (
bus
 =
lbus
) &&

1095 (
¶Ÿ
 =((
mp_úqs
[
i
].
§cbusúq
 >> 2) & 0x1f))) {

1096 
úq
 = 
	`pö_2_úq
(
i
, 
≠ic
, 
mp_úqs
[i].
d°úq
);

1098 i‡(!(
≠ic
 || 
	`IO_APIC_IRQ
(
úq
)))

1101 i‡(
pö
 =(
mp_úqs
[
i
].
§cbusúq
 & 3)) {

1102 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1103 
mp_úqs
[
i
].
d°úq
,

1104 
	`úq_åiggî
(
i
),

1105 
	`úq_pﬁ¨ôy
(
i
));

1106  
úq
;

1112 i‡(
be°_guess
 < 0) {

1113 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1114 
mp_úqs
[
i
].
d°úq
,

1115 
	`úq_åiggî
(
i
),

1116 
	`úq_pﬁ¨ôy
(
i
));

1117 
be°_guess
 = 
úq
;

1121  
be°_guess
;

1122 
	}
}

1123 
EXPORT_SYMBOL
(
IO_APIC_gë_PCI_úq_ve˘‹
);

1125 
	$lock_ve˘‹_lock
()

1130 
	`øw_•ö_lock
(&
ve˘‹_lock
);

1131 
	}
}

1133 
	$u∆ock_ve˘‹_lock
()

1135 
	`øw_•ö_u∆ock
(&
ve˘‹_lock
);

1136 
	}
}

1139 
	$__assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1152 
cuºít_ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
 + 
VECTOR_OFFSET_START
;

1153 
cuºít_off£t
 = 
VECTOR_OFFSET_START
 % 8;

1154 
ﬁd_ve˘‹
;

1155 
˝u
, 
îr
;

1156 
˝umask_v¨_t
 
tmp_mask
;

1158 i‡(
cfg
->
move_ö_¥ogªss
)

1159  -
EBUSY
;

1161 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_mask
, 
GFP_ATOMIC
))

1162  -
ENOMEM
;

1164 
ﬁd_ve˘‹
 = 
cfg
->
ve˘‹
;

1165 i‡(
ﬁd_ve˘‹
) {

1166 
	`˝umask_™d
(
tmp_mask
, 
mask
, 
˝u_⁄löe_mask
);

1167 
	`˝umask_™d
(
tmp_mask
, 
cfg
->
domaö
,Åmp_mask);

1168 i‡(!
	`˝umask_em±y
(
tmp_mask
)) {

1169 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1175 
îr
 = -
ENOSPC
;

1176 
	`f‹_óch_˝u_™d
(
˝u
, 
mask
, 
˝u_⁄löe_mask
) {

1177 
√w_˝u
;

1178 
ve˘‹
, 
off£t
;

1180 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
tmp_mask
);

1182 
ve˘‹
 = 
cuºít_ve˘‹
;

1183 
off£t
 = 
cuºít_off£t
;

1184 
√xt
:

1185 
ve˘‹
 += 8;

1186 i‡(
ve˘‹
 >
fú°_sy°em_ve˘‹
) {

1188 
off£t
 = (offset + 1) % 8;

1189 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
 + 
off£t
;

1191 i‡(
	`u∆ikñy
(
cuºít_ve˘‹
 =
ve˘‹
))

1194 i‡(
	`ã°_bô
(
ve˘‹
, 
u£d_ve˘‹s
))

1195 
√xt
;

1197 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1198 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] != -1)

1199 
√xt
;

1201 
cuºít_ve˘‹
 = 
ve˘‹
;

1202 
cuºít_off£t
 = 
off£t
;

1203 i‡(
ﬁd_ve˘‹
) {

1204 
cfg
->
move_ö_¥ogªss
 = 1;

1205 
	`˝umask_c›y
(
cfg
->
ﬁd_domaö
, cfg->
domaö
);

1207 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1208 
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] = 
úq
;

1209 
cfg
->
ve˘‹
 = vector;

1210 
	`˝umask_c›y
(
cfg
->
domaö
, 
tmp_mask
);

1211 
îr
 = 0;

1214 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1215  
îr
;

1216 
	}
}

1218 
	$assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1220 
îr
;

1221 
Êags
;

1223 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

1224 
îr
 = 
	`__assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
);

1225 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

1226  
îr
;

1227 
	}
}

1229 
	$__˛ór_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
)

1231 
˝u
, 
ve˘‹
;

1233 
	`BUG_ON
(!
cfg
->
ve˘‹
);

1235 
ve˘‹
 = 
cfg
->vector;

1236 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
domaö
, 
˝u_⁄löe_mask
)

1237 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1239 
cfg
->
ve˘‹
 = 0;

1240 
	`˝umask_˛ór
(
cfg
->
domaö
);

1242 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

1244 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
) {

1245 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
;

1246 
ve˘‹
++) {

1247 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] !
úq
)

1249 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1253 
cfg
->
move_ö_¥ogªss
 = 0;

1254 
	}
}

1256 
	$__£tup_ve˘‹_úq
(
˝u
)

1259 
úq
, 
ve˘‹
;

1260 
úq_cfg
 *
cfg
;

1261 
úq_desc
 *
desc
;

1268 
	`øw_•ö_lock
(&
ve˘‹_lock
);

1270 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1271 
cfg
 = 
desc
->
chù_d©a
;

1277 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
 && !
	`IO_APIC_IRQ
(irq))

1278 
	`˝umask_£t_˝u
(
˝u
, 
cfg
->
domaö
);

1280 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1282 
ve˘‹
 = 
cfg
->vector;

1283 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = 
úq
;

1286 
ve˘‹
 = 0; ve˘‹ < 
NR_VECTORS
; ++vector) {

1287 
úq
 = 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
];

1288 i‡(
úq
 < 0)

1291 
cfg
 = 
	`úq_cfg
(
úq
);

1292 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1293 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1295 
	`øw_•ö_u∆ock
(&
ve˘‹_lock
);

1296 
	}
}

1298 
úq_chù
 
	giﬂpic_chù
;

1299 
úq_chù
 
	gú_iﬂpic_chù
;

1301 
	#IOAPIC_AUTO
 -1

	)

1302 
	#IOAPIC_EDGE
 0

	)

1303 
	#IOAPIC_LEVEL
 1

	)

1305 #ifde‡
CONFIG_X86_32


1306 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1308 
≠ic
, 
idx
, 
pö
;

1310 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1311 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1312 
idx
 = 
	`föd_úq_íåy
(
≠ic
, 
pö
, 
mp_INT
);

1313 i‡((
idx
 !-1Ë&& (
úq
 =
	`pö_2_úq
(idx, 
≠ic
, 
pö
)))

1314  
	`úq_åiggî
(
idx
);

1321 
	}
}

1323 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1326 
	}
}

1329 
	$iﬂpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
, 
åiggî
)

1332 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1333 
åiggî
 =
IOAPIC_LEVEL
)

1334 
desc
->
°©us
 |
IRQ_LEVEL
;

1336 
desc
->
°©us
 &~
IRQ_LEVEL
;

1338 i‡(
	`úq_ªm≠≥d
(
úq
)) {

1339 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

1340 i‡(
åiggî
)

1341 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1342 
h™dÀ_Á°eoi_úq
,

1345 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1346 
h™dÀ_edge_úq
, "edge");

1350 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1351 
åiggî
 =
IOAPIC_LEVEL
)

1352 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1353 
h™dÀ_Á°eoi_úq
,

1356 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1357 
h™dÀ_edge_úq
, "edge");

1358 
	}
}

1360 
	$£tup_iﬂpic_íåy
(
≠ic_id
, 
úq
,

1361 
IO_APIC_rouã_íåy
 *
íåy
,

1362 
de°ö©i⁄
, 
åiggî
,

1363 
pﬁ¨ôy
, 
ve˘‹
, 
pö
)

1368 
	`mem£t
(
íåy
,0,(*entry));

1370 i‡(
öå_ªm≠pög_íabÀd
) {

1371 
öãl_iommu
 *
iommu
 = 
	`m≠_iﬂpic_to_ú
(
≠ic_id
);

1372 
úã
 irte;

1373 
IR_IO_APIC_rouã_íåy
 *
ú_íåy
 =

1374 (
IR_IO_APIC_rouã_íåy
 *Ë
íåy
;

1375 
ödex
;

1377 i‡(!
iommu
)

1378 
	`∑nic
("Nÿm≠pög iommu f‹ iﬂpi¯%d\n", 
≠ic_id
);

1380 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

1381 i‡(
ödex
 < 0)

1382 
	`∑nic
("FaûedÅÿÆloˇã IRTE f‹ iﬂpi¯%d\n", 
≠ic_id
);

1384 
	`mem£t
(&
úã
, 0, (irte));

1386 
úã
.
¥e£¡
 = 1;

1387 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

1395 
úã
.
åiggî_mode
 = 0;

1396 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1397 
úã
.
ve˘‹
 = vector;

1398 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°ö©i⁄
);

1401 
	`£t_iﬂpic_sid
(&
úã
, 
≠ic_id
);

1403 
	`modify_úã
(
úq
, &
úã
);

1405 
ú_íåy
->
ödex2
 = (
ödex
 >> 15) & 0x1;

1406 
ú_íåy
->
zîo
 = 0;

1407 
ú_íåy
->
f‹m©
 = 1;

1408 
ú_íåy
->
ödex
 = (index & 0x7fff);

1413 
ú_íåy
->
ve˘‹
 = 
pö
;

1415 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1416 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1417 
íåy
->
de°
 = 
de°ö©i⁄
;

1418 
íåy
->
ve˘‹
 = vector;

1421 
íåy
->
mask
 = 0;

1422 
íåy
->
åiggî
 =Årigger;

1423 
íåy
->
pﬁ¨ôy
 =Öolarity;

1428 i‡(
åiggî
)

1429 
íåy
->
mask
 = 1;

1431 
	}
}

1433 
	$£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
úq_desc
 *
desc
,

1434 
åiggî
, 
pﬁ¨ôy
)

1436 
úq_cfg
 *
cfg
;

1437 
IO_APIC_rouã_íåy
 
íåy
;

1438 
de°
;

1440 i‡(!
	`IO_APIC_IRQ
(
úq
))

1443 
cfg
 = 
desc
->
chù_d©a
;

1450 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
 && 
	`˝umask_ã°_˝u
(0, 
cfg
->
domaö
))

1451 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(0, 
cfg
->
domaö
);

1453 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
()))

1456 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

1458 
	`≠ic_¥ötk
(
APIC_VERBOSE
,
KERN_DEBUG


1461 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
, 
pö
, 
cfg
->
ve˘‹
,

1462 
úq
, 
åiggî
, 
pﬁ¨ôy
);

1465 i‡(
	`£tup_iﬂpic_íåy
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
úq
, &
íåy
,

1466 
de°
, 
åiggî
, 
pﬁ¨ôy
, 
cfg
->
ve˘‹
, 
pö
)) {

1467 
	`¥ötk
("FailedÅo setup ioapicÉntry for ioapic %d,Öin %d\n",

1468 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1469 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

1473 
	`iﬂpic_ªgi°î_öå
(
úq
, 
desc
, 
åiggî
);

1474 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1475 
Àgacy_pic
->
chù
->
	`mask
(
úq
);

1477 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1478 
	}
}

1481 
DECLARE_BITMAP
(
pö_¥ogømmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

1482 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

1484 
__öô
 
	$£tup_IO_APIC_úqs
()

1486 
≠ic_id
, 
pö
, 
idx
, 
úq
;

1487 
nŸc⁄
 = 0;

1488 
úq_desc
 *
desc
;

1489 
úq_cfg
 *
cfg
;

1490 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1492 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1494 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++)

1495 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic_id
];Öin++) {

1496 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1497 i‡(
idx
 == -1) {

1498 i‡(!
nŸc⁄
) {

1499 
nŸc⁄
 = 1;

1500 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1501 
KERN_DEBUG
 " %d-%d",

1502 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1504 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " %d-%d",

1505 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1508 i‡(
nŸc⁄
) {

1509 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1511 
nŸc⁄
 = 0;

1514 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1516 i‡((
≠ic_id
 > 0Ë&& (
úq
 > 16))

1523 i‡(
≠ic
->
mu…i_timî_check
 &&

1524 
≠ic
->
	`mu…i_timî_check
(
≠ic_id
, 
úq
))

1527 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1528 i‡(!
desc
) {

1529 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1532 
cfg
 = 
desc
->
chù_d©a
;

1533 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1538 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1539 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1542 i‡(
nŸc⁄
)

1543 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1545 
	}
}

1552 
	$£tup_IO_APIC_úq_exåa
(
u32
 
gsi
)

1554 
≠ic_id
 = 0, 
pö
, 
idx
, 
úq
;

1555 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1556 
úq_desc
 *
desc
;

1557 
úq_cfg
 *
cfg
;

1562 
≠ic_id
 = 
	`mp_föd_iﬂpic
(
gsi
);

1563 i‡(
≠ic_id
 < 0)

1566 
pö
 = 
	`mp_föd_iﬂpic_pö
(
≠ic_id
, 
gsi
);

1567 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1568 i‡(
idx
 == -1)

1571 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1572 #ifde‡
CONFIG_SPARSE_IRQ


1573 
desc
 = 
	`úq_to_desc
(
úq
);

1574 i‡(
desc
)

1577 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1578 i‡(!
desc
) {

1579 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1583 
cfg
 = 
desc
->
chù_d©a
;

1584 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1586 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
≠ic_id
].
pö_¥ogømmed
)) {

1587 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

1588 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1591 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
≠ic_id
].
pö_¥ogømmed
);

1593 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1594 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1595 
	}
}

1600 
__öô
 
	$£tup_timî_IRQ0_pö
(
≠ic_id
, 
pö
,

1601 
ve˘‹
)

1603 
IO_APIC_rouã_íåy
 
íåy
;

1605 i‡(
öå_ªm≠pög_íabÀd
)

1608 
	`mem£t
(&
íåy
, 0, (entry));

1614 
íåy
.
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1615 
íåy
.
mask
 = 0;

1616 
íåy
.
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
◊pic->
	`èrgë_˝us
());

1617 
íåy
.
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1618 
íåy
.
pﬁ¨ôy
 = 0;

1619 
íåy
.
åiggî
 = 0;

1620 
íåy
.
ve˘‹
 = vector;

1626 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

1631 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1632 
	}
}

1635 
	$__≠icdebugöô
(Ë
	$¥öt_IO_APIC
()

1637 
≠ic
, 
i
;

1638 
IO_APIC_ªg_00
 
ªg_00
;

1639 
IO_APIC_ªg_01
 
ªg_01
;

1640 
IO_APIC_ªg_02
 
ªg_02
;

1641 
IO_APIC_ªg_03
 
ªg_03
;

1642 
Êags
;

1643 
úq_cfg
 *
cfg
;

1644 
úq_desc
 *
desc
;

1645 
úq
;

1647 
	`¥ötk
(
KERN_DEBUG
 "numbî o‡MP IRQ sour˚s: %d.\n", 
mp_úq_íåõs
);

1648 
i
 = 0; i < 
ƒ_iﬂpics
; i++)

1649 
	`¥ötk
(
KERN_DEBUG
 "number of IO-APIC #%dÑegisters: %d.\n",

1650 
mp_iﬂpics
[
i
].
≠icid
, 
ƒ_iﬂpic_ªgi°îs
[i]);

1656 
	`¥ötk
(
KERN_INFO
 "testingÅhe IO APIC.......................\n");

1658 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1660 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1661 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 0);

1662 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1663 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x10)

1664 
ªg_02
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 2);

1665 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x20)

1666 
ªg_03
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 3);

1667 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1669 
	`¥ötk
("\n");

1670 
	`¥ötk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_iﬂpics
[
≠ic
].
≠icid
);

1671 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #00: %08X\n", 
ªg_00
.
øw
);

1672 
	`¥ötk
(
KERN_DEBUG
 "....... :Öhysiˇ»APIC id: %02X\n", 
ªg_00
.
bôs
.
ID
);

1673 
	`¥ötk
(
KERN_DEBUG
 "....... : Dñivîy Ty≥: %X\n", 
ªg_00
.
bôs
.
dñivîy_ty≥
);

1674 
	`¥ötk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
ªg_00
.
bôs
.
LTS
);

1676 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #01: %08X\n", *(*)&
ªg_01
);

1677 
	`¥ötk
(
KERN_DEBUG
 "....... : maxÑedúe˘i⁄É¡rõs: %04X\n", 
ªg_01
.
bôs
.
íåõs
);

1679 
	`¥ötk
(
KERN_DEBUG
 "....... : PRQ im∂emíãd: %X\n", 
ªg_01
.
bôs
.
PRQ
);

1680 
	`¥ötk
(
KERN_DEBUG
 "....... : IO APIC vîsi⁄: %04X\n", 
ªg_01
.
bôs
.
vîsi⁄
);

1687 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x10 && 
ªg_02
.
øw
 !=Ñeg_01.raw) {

1688 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #02: %08X\n", 
ªg_02
.
øw
);

1689 
	`¥ötk
(
KERN_DEBUG
 "....... :árbôøti⁄: %02X\n", 
ªg_02
.
bôs
.
¨bôøti⁄
);

1697 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x20 && 
ªg_03
.
øw
 !
ªg_02
.raw &&

1698 
ªg_03
.
øw
 !
ªg_01
.raw) {

1699 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #03: %08X\n", 
ªg_03
.
øw
);

1700 
	`¥ötk
(
KERN_DEBUG
 "....... : BoŸ DT : %X\n", 
ªg_03
.
bôs
.
boŸ_DT
);

1703 
	`¥ötk
(
KERN_DEBUG
 ".... IRQÑedirectionÅable:\n");

1705 
	`¥ötk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1708 
i
 = 0; i <
ªg_01
.
bôs
.
íåõs
; i++) {

1709 
IO_APIC_rouã_íåy
 
íåy
;

1711 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
i
);

1713 
	`¥ötk
(
KERN_DEBUG
 " %02x %03X ",

1714 
i
,

1715 
íåy
.
de°


1718 
	`¥ötk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1719 
íåy
.
mask
,

1720 
íåy
.
åiggî
,

1721 
íåy
.
úr
,

1722 
íåy
.
pﬁ¨ôy
,

1723 
íåy
.
dñivîy_°©us
,

1724 
íåy
.
de°_mode
,

1725 
íåy
.
dñivîy_mode
,

1726 
íåy
.
ve˘‹


1730 
	`¥ötk
(
KERN_DEBUG
 "IRQÅoÖin mappings:\n");

1731 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1732 
úq_pö_li°
 *
íåy
;

1734 
cfg
 = 
desc
->
chù_d©a
;

1735 
íåy
 = 
cfg
->
úq_2_pö
;

1736 i‡(!
íåy
)

1738 
	`¥ötk
(
KERN_DEBUG
 "IRQ%d ", 
úq
);

1739 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

1740 
	`¥ötk
("-> %d:%d", 
íåy
->
≠ic
,É¡ry->
pö
);

1741 
	`¥ötk
("\n");

1744 
	`¥ötk
(
KERN_INFO
 ".................................... done.\n");

1747 
	}
}

1749 
	$__≠icdebugöô
(Ë
	$¥öt_APIC_fõld
(
ba£
)

1751 
i
;

1753 
	`¥ötk
(
KERN_DEBUG
);

1755 
i
 = 0; i < 8; i++)

1756 
	`¥ötk
(
KERN_CONT
 "%08x", 
	`≠ic_ªad
(
ba£
 + 
i
*0x10));

1758 
	`¥ötk
(
KERN_CONT
 "\n");

1759 
	}
}

1761 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APIC
(*
dummy
)

1763 
i
, 
v
, 
vî
, 
maxlvt
;

1764 
u64
 
i¸
;

1766 
	`¥ötk
(
KERN_DEBUG
 "printingÜocal APIC contents on CPU#%d/%d:\n",

1767 
	`smp_¥o˚ss‹_id
(), 
	`h¨d_smp_¥o˚ss‹_id
());

1768 
v
 = 
	`≠ic_ªad
(
APIC_ID
);

1769 
	`¥ötk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`ªad_≠ic_id
());

1770 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

1771 
	`¥ötk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1772 
vî
 = 
	`GET_APIC_VERSION
(
v
);

1773 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1775 
v
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1776 
	`¥ötk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1778 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1779 i‡(!
	`APIC_XAPIC
(
vî
)) {

1780 
v
 = 
	`≠ic_ªad
(
APIC_ARBPRI
);

1781 
	`¥ötk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1782 
v
 & 
APIC_ARBPRI_MASK
);

1784 
v
 = 
	`≠ic_ªad
(
APIC_PROCPRI
);

1785 
	`¥ötk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1792 i‡(!
	`APIC_INTEGRATED
(
vî
Ë|| 
maxlvt
 == 3) {

1793 
v
 = 
	`≠ic_ªad
(
APIC_RRR
);

1794 
	`¥ötk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1797 
v
 = 
	`≠ic_ªad
(
APIC_LDR
);

1798 
	`¥ötk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1799 i‡(!
	`x2≠ic_íabÀd
()) {

1800 
v
 = 
	`≠ic_ªad
(
APIC_DFR
);

1801 
	`¥ötk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1803 
v
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1804 
	`¥ötk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1806 
	`¥ötk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1807 
	`¥öt_APIC_fõld
(
APIC_ISR
);

1808 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1809 
	`¥öt_APIC_fõld
(
APIC_TMR
);

1810 
	`¥ötk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1811 
	`¥öt_APIC_fõld
(
APIC_IRR
);

1813 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1814 i‡(
maxlvt
 > 3)

1815 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1817 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1818 
	`¥ötk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1821 
i¸
 = 
	`≠ic_i¸_ªad
();

1822 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
i¸
);

1823 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
i¸
 >> 32));

1825 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1826 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1828 i‡(
maxlvt
 > 3) {

1829 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1830 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1832 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1833 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1834 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1835 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1837 i‡(
maxlvt
 > 2) {

1838 
v
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1839 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1842 
v
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1843 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1844 
v
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

1845 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1846 
v
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1847 
	`¥ötk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1849 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_EXTAPIC
)) {

1850 
v
 = 
	`≠ic_ªad
(
APIC_EFEAT
);

1851 
maxlvt
 = (
v
 >> 16) & 0xff;

1852 
	`¥ötk
(
KERN_DEBUG
 "... APIC EFEAT: %08x\n", 
v
);

1853 
v
 = 
	`≠ic_ªad
(
APIC_ECTRL
);

1854 
	`¥ötk
(
KERN_DEBUG
 "... APIC ECTRL: %08x\n", 
v
);

1855 
i
 = 0; i < 
maxlvt
; i++) {

1856 
v
 = 
	`≠ic_ªad
(
	`APIC_EILVTn
(
i
));

1857 
	`¥ötk
(
KERN_DEBUG
 "... APIC EILVT%d: %08x\n", 
i
, 
v
);

1860 
	`¥ötk
("\n");

1861 
	}
}

1863 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APICs
(
max˝u
)

1865 
˝u
;

1867 i‡(!
max˝u
)

1870 
	`¥ìm±_dißbÀ
();

1871 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1872 i‡(
˝u
 >
max˝u
)

1874 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
¥öt_loˇl_APIC
, 
NULL
, 1);

1876 
	`¥ìm±_íabÀ
();

1877 
	}
}

1879 
	$__≠icdebugöô
(Ë
	$¥öt_PIC
()

1881 
v
;

1882 
Êags
;

1884 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1887 
	`¥ötk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1889 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

1891 
v
 = 
	`öb
(0xa1) << 8 | inb(0x21);

1892 
	`¥ötk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1894 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1895 
	`¥ötk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1897 
	`outb
(0x0b,0xa0);

1898 
	`outb
(0x0b,0x20);

1899 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1900 
	`outb
(0x0a,0xa0);

1901 
	`outb
(0x0a,0x20);

1903 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

1905 
	`¥ötk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1907 
v
 = 
	`öb
(0x4d1) << 8 | inb(0x4d0);

1908 
	`¥ötk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1909 
	}
}

1911 
__öôd©a
 
	gshow_œpic
 = 1;

1912 
__öô
 
	$£tup_show_œpic
(*
¨g
)

1914 
num
 = -1;

1916 i‡(
	`°rcmp
(
¨g
, "all") == 0) {

1917 
show_œpic
 = 
CONFIG_NR_CPUS
;

1919 
	`gë_›ti⁄
(&
¨g
, &
num
);

1920 i‡(
num
 >= 0)

1921 
show_œpic
 = 
num
;

1925 
	}
}

1926 
__£tup
("show_œpic=", 
£tup_show_œpic
);

1928 
	$__≠icdebugöô
(Ë
	$¥öt_ICs
()

1930 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1933 
	`¥öt_PIC
();

1936 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

1939 
	`¥öt_loˇl_APICs
(
show_œpic
);

1940 
	`¥öt_IO_APIC
();

1943 
	}
}

1945 
fs_öôˇŒ
(
¥öt_ICs
);

1949 °ru˘ { 
	mpö
, 
	m≠ic
; } 
	giﬂpic_i8259
 = { -1, -1 };

1951 
__öô
 
	$íabÀ_IO_APIC
()

1953 
IO_APIC_ªg_01
 
ªg_01
;

1954 
i8259_≠ic
, 
i8259_pö
;

1955 
≠ic
;

1956 
Êags
;

1961 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1962 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1963 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1964 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1965 
ƒ_iﬂpic_ªgi°îs
[
≠ic
] = 
ªg_01
.
bôs
.
íåõs
+1;

1968 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1971 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1972 
pö
;

1974 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1975 
IO_APIC_rouã_íåy
 
íåy
;

1976 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

1981 i‡((
íåy
.
mask
 =0Ë&& (íåy.
dñivîy_mode
 =
de°_ExtINT
)) {

1982 
iﬂpic_i8259
.
≠ic
 =ápic;

1983 
iﬂpic_i8259
.
pö
 =Öin;

1984 
found_i8259
;

1988 
found_i8259
:

1994 
i8259_pö
 = 
	`föd_iß_úq_pö
(0, 
mp_ExtINT
);

1995 
i8259_≠ic
 = 
	`föd_iß_úq_≠ic
(0, 
mp_ExtINT
);

1997 i‡((
iﬂpic_i8259
.
pö
 =-1Ë&& (
i8259_pö
 >= 0)) {

1998 
	`¥ötk
(
KERN_WARNING
 "ExtINTÇot setup in hardware butÑeported by MPÅable\n");

1999 
iﬂpic_i8259
.
pö
 = 
i8259_pö
;

2000 
iﬂpic_i8259
.
≠ic
 = 
i8259_≠ic
;

2003 i‡(((
iﬂpic_i8259
.
≠ic
 !
i8259_≠ic
Ë|| (iﬂpic_i8259.
pö
 !
i8259_pö
)) &&

2004 (
i8259_pö
 >0Ë&& (
iﬂpic_i8259
.
pö
 >= 0))

2006 
	`¥ötk
(
KERN_WARNING
 "ExtINT in hardwareánd MPÅable differ\n");

2012 
	`˛ór_IO_APIC
();

2013 
	}
}

2018 
	$dißbÀ_IO_APIC
()

2023 
	`˛ór_IO_APIC
();

2025 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

2038 i‡(
iﬂpic_i8259
.
pö
 !-1 && !
öå_ªm≠pög_íabÀd
) {

2039 
IO_APIC_rouã_íåy
 
íåy
;

2041 
	`mem£t
(&
íåy
, 0, (entry));

2042 
íåy
.
mask
 = 0;

2043 
íåy
.
åiggî
 = 0;

2044 
íåy
.
úr
 = 0;

2045 
íåy
.
pﬁ¨ôy
 = 0;

2046 
íåy
.
dñivîy_°©us
 = 0;

2047 
íåy
.
de°_mode
 = 0;

2048 
íåy
.
dñivîy_mode
 = 
de°_ExtINT
;

2049 
íåy
.
ve˘‹
 = 0;

2050 
íåy
.
de°
 = 
	`ªad_≠ic_id
();

2055 
	`iﬂpic_wrôe_íåy
(
iﬂpic_i8259
.
≠ic
, iﬂpic_i8259.
pö
, 
íåy
);

2061 i‡(
˝u_has_≠ic
 || 
	`≠ic_‰om_smp_c⁄fig
())

2062 
	`disc⁄√˘_b•_APIC
(!
öå_ªm≠pög_íabÀd
 &&

2063 
iﬂpic_i8259
.
pö
 != -1);

2064 
	}
}

2066 #ifde‡
CONFIG_X86_32


2074 
__öô
 
	$£tup_iﬂpic_ids_‰om_mpc
()

2076 
IO_APIC_ªg_00
 
ªg_00
;

2077 
physid_mask_t
 
phys_id_¥e£¡_m≠
;

2078 
≠ic_id
;

2079 
i
;

2080 
ﬁd_id
;

2081 
Êags
;

2083 i‡(
a˝i_iﬂpic
)

2089 i‡(!(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
)

2090 || 
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

2096 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
phys_id_¥e£¡_m≠
);

2101 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++) {

2104 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2105 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2106 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2108 
ﬁd_id
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2110 i‡(
mp_iﬂpics
[
≠ic_id
].
≠icid
 >
	`gë_physiˇl_brﬂdˇ°
()) {

2111 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inÅhe MPCÅable!...\n",

2112 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2113 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2114 
ªg_00
.
bôs
.
ID
);

2115 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
ªg_00
.
bôs
.
ID
;

2123 i‡(
≠ic
->
	`check_≠icid_u£d
(&
phys_id_¥e£¡_m≠
,

2124 
mp_iﬂpics
[
≠ic_id
].
≠icid
)) {

2125 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d isálready used!...\n",

2126 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2127 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++)

2128 i‡(!
	`physid_is£t
(
i
, 
phys_id_¥e£¡_m≠
))

2130 i‡(
i
 >
	`gë_physiˇl_brﬂdˇ°
())

2131 
	`∑nic
("Max APIC IDÉxceeded!\n");

2132 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2133 
i
);

2134 
	`physid_£t
(
i
, 
phys_id_¥e£¡_m≠
);

2135 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
i
;

2137 
physid_mask_t
 
tmp
;

2138 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, &
tmp
);

2139 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Setting %d inÅhe "

2141 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2142 
	`physids_‹
(
phys_id_¥e£¡_m≠
,Öhys_id_¥e£¡_m≠, 
tmp
);

2150 i‡(
ﬁd_id
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2151 
i
 = 0; i < 
mp_úq_íåõs
; i++)

2152 i‡(
mp_úqs
[
i
].
d°≠ic
 =
ﬁd_id
)

2153 
mp_úqs
[
i
].
d°≠ic


2154 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2160 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


2162 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2164 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2165 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2166 
	`io_≠ic_wrôe
(
≠ic_id
, 0, 
ªg_00
.
øw
);

2167 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2172 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2173 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2174 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2175 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2176 
	`¥ötk
("couldÇot set ID!\n");

2178 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " ok.\n");

2180 
	}
}

2183 
no_timî_check
 
	g__öôd©a
;

2185 
__öô
 
	$nŸimîcheck
(*
s
)

2187 
no_timî_check
 = 1;

2189 
	}
}

2190 
__£tup
("no_timî_check", 
nŸimîcheck
);

2200 
__öô
 
	$timî_úq_w‹ks
()

2202 
t1
 = 
jiffõs
;

2203 
Êags
;

2205 i‡(
no_timî_check
)

2208 
	`loˇl_ßve_Êags
(
Êags
);

2209 
	`loˇl_úq_íabÀ
();

2211 
	`mdñay
((10 * 1000Ë/ 
HZ
);

2212 
	`loˇl_úq_ª°‹e
(
Êags
);

2223 i‡(
	`time_a·î
(
jiffõs
, 
t1
 + 4))

2226 
	}
}

2251 
	$°¨tup_iﬂpic_úq
(
úq
)

2253 
was_≥ndög
 = 0;

2254 
Êags
;

2255 
úq_cfg
 *
cfg
;

2257 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2258 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

2259 
Àgacy_pic
->
chù
->
	`mask
(
úq
);

2260 i‡(
Àgacy_pic
->
	`úq_≥ndög
(
úq
))

2261 
was_≥ndög
 = 1;

2263 
cfg
 = 
	`úq_cfg
(
úq
);

2264 
	`__unmask_IO_APIC_úq
(
cfg
);

2265 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2267  
was_≥ndög
;

2268 
	}
}

2270 
	$iﬂpic_ªåiggî_úq
(
úq
)

2273 
úq_cfg
 *
cfg
 = 
	`úq_cfg
(
úq
);

2274 
Êags
;

2276 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

2277 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
	`˝umask_fú°
(
cfg
->
domaö
)), cfg->
ve˘‹
);

2278 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

2281 
	}
}

2292 #ifde‡
CONFIG_SMP


2293 
	$£nd_˛ónup_ve˘‹
(
úq_cfg
 *
cfg
)

2295 
˝umask_v¨_t
 
˛ónup_mask
;

2297 i‡(
	`u∆ikñy
(!
	`Æloc_˝umask_v¨
(&
˛ónup_mask
, 
GFP_ATOMIC
))) {

2298 
i
;

2299 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2300 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

2302 
	`˝umask_™d
(
˛ónup_mask
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
);

2303 
≠ic
->
	`£nd_IPI_mask
(
˛ónup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

2304 
	`‰ì_˝umask_v¨
(
˛ónup_mask
);

2306 
cfg
->
move_ö_¥ogªss
 = 0;

2307 
	}
}

2309 
	$__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
úq_cfg
 *
cfg
)

2311 
≠ic
, 
pö
;

2312 
úq_pö_li°
 *
íåy
;

2313 
u8
 
ve˘‹
 = 
cfg
->vector;

2315 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2316 
ªg
;

2318 
≠ic
 = 
íåy
->apic;

2319 
pö
 = 
íåy
->pin;

2324 i‡(!
	`úq_ªm≠≥d
(
úq
))

2325 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 
pö
*2, 
de°
);

2326 
ªg
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 
pö
*2);

2327 
ªg
 &~
IO_APIC_REDIR_VECTOR_MASK
;

2328 
ªg
 |
ve˘‹
;

2329 
	`io_≠ic_modify
(
≠ic
, 0x10 + 
pö
*2, 
ªg
);

2331 
	}
}

2339 
	$£t_desc_afföôy
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
,

2340 *
de°_id
)

2342 
úq_cfg
 *
cfg
;

2343 
úq
;

2345 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2348 
úq
 = 
desc
->irq;

2349 
cfg
 = 
desc
->
chù_d©a
;

2350 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2353 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2355 *
de°_id
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
desc
->
afföôy
, 
cfg
->
domaö
);

2357 
	}
}

2360 
	$£t_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2362 
úq_cfg
 *
cfg
;

2363 
Êags
;

2364 
de°
;

2365 
úq
;

2366 
ªt
 = -1;

2368 
úq
 = 
desc
->irq;

2369 
cfg
 = 
desc
->
chù_d©a
;

2371 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2372 
ªt
 = 
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
);

2373 i‡(!
ªt
) {

2375 
de°
 = 
	`SET_APIC_LOGICAL_ID
(dest);

2376 
	`__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
cfg
);

2378 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2380  
ªt
;

2381 
	}
}

2384 
	$£t_iﬂpic_afföôy_úq
(
úq
, c⁄° 
˝umask
 *
mask
)

2386 
úq_desc
 *
desc
;

2388 
desc
 = 
	`úq_to_desc
(
úq
);

2390  
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2391 
	}
}

2393 #ifde‡
CONFIG_INTR_REMAP


2407 
	$migøã_iﬂpic_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2409 
úq_cfg
 *
cfg
;

2410 
úã
 irte;

2411 
de°
;

2412 
úq
;

2413 
ªt
 = -1;

2415 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2416  
ªt
;

2418 
úq
 = 
desc
->irq;

2419 i‡(
	`gë_úã
(
úq
, &
úã
))

2420  
ªt
;

2422 
cfg
 = 
desc
->
chù_d©a
;

2423 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2424  
ªt
;

2426 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
, 
mask
);

2428 
úã
.
ve˘‹
 = 
cfg
->vector;

2429 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

2434 
	`modify_úã
(
úq
, &
úã
);

2436 i‡(
cfg
->
move_ö_¥ogªss
)

2437 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2439 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2442 
	}
}

2447 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2448 c⁄° 
˝umask
 *
mask
)

2450  
	`migøã_iﬂpic_úq_desc
(
desc
, 
mask
);

2451 
	}
}

2452 
	$£t_ú_iﬂpic_afföôy_úq
(
úq
,

2453 c⁄° 
˝umask
 *
mask
)

2455 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2457  
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2458 
	}
}

2460 
ölöe
 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2461 c⁄° 
˝umask
 *
mask
)

2464 
	}
}

2467 
asmlökage
 
	$smp_úq_move_˛ónup_öãºu±
()

2469 
ve˘‹
, 
me
;

2471 
	`ack_APIC_úq
();

2472 
	`exô_idÀ
();

2473 
	`úq_íãr
();

2475 
me
 = 
	`smp_¥o˚ss‹_id
();

2476 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

2477 
úq
;

2478 
úr
;

2479 
úq_desc
 *
desc
;

2480 
úq_cfg
 *
cfg
;

2481 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

2483 i‡(
úq
 == -1)

2486 
desc
 = 
	`úq_to_desc
(
úq
);

2487 i‡(!
desc
)

2490 
cfg
 = 
	`úq_cfg
(
úq
);

2491 
	`øw_•ö_lock
(&
desc
->
lock
);

2497 i‡(
cfg
->
move_ö_¥ogªss
)

2498 
u∆ock
;

2500 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2501 
u∆ock
;

2503 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

2511 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

2512 
≠ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2513 
u∆ock
;

2515 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] = -1;

2516 
u∆ock
:

2517 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

2520 
	`úq_exô
();

2521 
	}
}

2523 
	$__úq_com∂ëe_move
(
úq_desc
 **
des˝
, 
ve˘‹
)

2525 
úq_desc
 *
desc
 = *
des˝
;

2526 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2527 
me
;

2529 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

2532 
me
 = 
	`smp_¥o˚ss‹_id
();

2534 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2535 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2536 
	}
}

2538 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
)

2540 
	`__úq_com∂ëe_move
(
des˝
, ~
	`gë_úq_ªgs
()->
‹ig_ax
);

2541 
	}
}

2543 
	$úq_f‹˚_com∂ëe_move
(
úq
)

2545 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2546 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2548 i‡(!
cfg
)

2551 
	`__úq_com∂ëe_move
(&
desc
, 
cfg
->
ve˘‹
);

2552 
	}
}

2554 
ölöe
 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
Ë{
	}
}

2557 
	$ack_≠ic_edge
(
úq
)

2559 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2561 
	`úq_com∂ëe_move
(&
desc
);

2562 
	`move_«tive_úq
(
úq
);

2563 
	`ack_APIC_úq
();

2564 
	}
}

2566 
©omic_t
 
	gúq_mis_cou¡
;

2584 
	$__eoi_iﬂpic_úq
(
úq
, 
úq_cfg
 *
cfg
)

2586 
úq_pö_li°
 *
íåy
;

2588 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2589 i‡(
mp_iﬂpics
[
íåy
->
≠ic
].
≠icvî
 >= 0x20) {

2596 i‡(
	`úq_ªm≠≥d
(
úq
))

2597 
	`io_≠ic_eoi
(
íåy
->
≠ic
,É¡ry->
pö
);

2599 
	`io_≠ic_eoi
(
íåy
->
≠ic
, 
cfg
->
ve˘‹
);

2601 
	`__mask_™d_edge_IO_APIC_úq
(
íåy
);

2602 
	`__unmask_™d_Àvñ_IO_APIC_úq
(
íåy
);

2605 
	}
}

2607 
	$eoi_iﬂpic_úq
(
úq_desc
 *
desc
)

2609 
úq_cfg
 *
cfg
;

2610 
Êags
;

2611 
úq
;

2613 
úq
 = 
desc
->irq;

2614 
cfg
 = 
desc
->
chù_d©a
;

2616 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2617 
	`__eoi_iﬂpic_úq
(
úq
, 
cfg
);

2618 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2619 
	}
}

2621 
	$ack_≠ic_Àvñ
(
úq
)

2623 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2624 
v
;

2625 
i
;

2626 
úq_cfg
 *
cfg
;

2627 
do_unmask_úq
 = 0;

2629 
	`úq_com∂ëe_move
(&
desc
);

2630 #ifde‡
CONFIG_GENERIC_PENDING_IRQ


2632 i‡(
	`u∆ikñy
(
desc
->
°©us
 & 
IRQ_MOVE_PENDING
)) {

2633 
do_unmask_úq
 = 1;

2634 
	`mask_IO_APIC_úq_desc
(
desc
);

2670 
cfg
 = 
desc
->
chù_d©a
;

2671 
i
 = 
cfg
->
ve˘‹
;

2672 
v
 = 
	`≠ic_ªad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2678 
	`ack_APIC_úq
();

2687 i‡(!(
v
 & (1 << (
i
 & 0x1f)))) {

2688 
	`©omic_öc
(&
úq_mis_cou¡
);

2690 
	`eoi_iﬂpic_úq
(
desc
);

2694 i‡(
	`u∆ikñy
(
do_unmask_úq
)) {

2721 
cfg
 = 
desc
->
chù_d©a
;

2722 i‡(!
	`io_≠ic_Àvñ_ack_≥ndög
(
cfg
))

2723 
	`move_masked_úq
(
úq
);

2724 
	`unmask_IO_APIC_úq_desc
(
desc
);

2726 
	}
}

2728 #ifde‡
CONFIG_INTR_REMAP


2729 
	$ú_ack_≠ic_edge
(
úq
)

2731 
	`ack_APIC_úq
();

2732 
	}
}

2734 
	$ú_ack_≠ic_Àvñ
(
úq
)

2736 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2738 
	`ack_APIC_úq
();

2739 
	`eoi_iﬂpic_úq
(
desc
);

2740 
	}
}

2743 
úq_chù
 
iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2744 .
«me
 = "IO-APIC",

2745 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2746 .
	gmask
 = 
mask_IO_APIC_úq
,

2747 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2748 .
	gack
 = 
ack_≠ic_edge
,

2749 .
	geoi
 = 
ack_≠ic_Àvñ
,

2750 #ifde‡
CONFIG_SMP


2751 .
	g£t_afföôy
 = 
£t_iﬂpic_afföôy_úq
,

2753 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2756 
úq_chù
 
ú_iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2757 .
«me
 = "IR-IO-APIC",

2758 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2759 .
	gmask
 = 
mask_IO_APIC_úq
,

2760 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2761 #ifde‡
CONFIG_INTR_REMAP


2762 .
	gack
 = 
ú_ack_≠ic_edge
,

2763 .
	geoi
 = 
ú_ack_≠ic_Àvñ
,

2764 #ifde‡
CONFIG_SMP


2765 .
	g£t_afföôy
 = 
£t_ú_iﬂpic_afföôy_úq
,

2768 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2771 
ölöe
 
	$öô_IO_APIC_å≠s
()

2773 
úq
;

2774 
úq_desc
 *
desc
;

2775 
úq_cfg
 *
cfg
;

2788 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

2789 
cfg
 = 
desc
->
chù_d©a
;

2790 i‡(
	`IO_APIC_IRQ
(
úq
Ë&& 
cfg
 && !cfg->
ve˘‹
) {

2796 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
)

2797 
Àgacy_pic
->
	`make_úq
(
úq
);

2800 
desc
->
chù
 = &
no_úq_chù
;

2803 
	}
}

2809 
	$mask_œpic_úq
(
úq
)

2811 
v
;

2813 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2814 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2815 
	}
}

2817 
	$unmask_œpic_úq
(
úq
)

2819 
v
;

2821 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2822 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2823 
	}
}

2825 
	$ack_œpic_úq
(
úq
)

2827 
	`ack_APIC_úq
();

2828 
	}
}

2830 
úq_chù
 
œpic_chù
 
	g__ªad_mo°ly
 = {

2831 .
«me
 = "local-APIC",

2832 .
	gmask
 = 
mask_œpic_úq
,

2833 .
	gunmask
 = 
unmask_œpic_úq
,

2834 .
	gack
 = 
ack_œpic_úq
,

2837 
	$œpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
)

2839 
desc
->
°©us
 &~
IRQ_LEVEL
;

2840 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
œpic_chù
, 
h™dÀ_edge_úq
,

2842 
	}
}

2844 
__öô
 
	$£tup_nmi
()

2855 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2857 
	`íabÀ_NMI_through_LVT0
();

2859 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " done.\n");

2860 
	}
}

2869 
ölöe
 
__öô
 
	$u∆ock_ExtINT_logic
()

2871 
≠ic
, 
pö
, 
i
;

2872 
IO_APIC_rouã_íåy
 
íåy0
, 
íåy1
;

2873 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

2875 
pö
 = 
	`föd_iß_úq_pö
(8, 
mp_INT
);

2876 i‡(
pö
 == -1) {

2877 
	`WARN_ON_ONCE
(1);

2880 
≠ic
 = 
	`föd_iß_úq_≠ic
(8, 
mp_INT
);

2881 i‡(
≠ic
 == -1) {

2882 
	`WARN_ON_ONCE
(1);

2886 
íåy0
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

2887 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2889 
	`mem£t
(&
íåy1
, 0, (entry1));

2891 
íåy1
.
de°_mode
 = 0;

2892 
íåy1
.
mask
 = 0;

2893 
íåy1
.
de°
 = 
	`h¨d_smp_¥o˚ss‹_id
();

2894 
íåy1
.
dñivîy_mode
 = 
de°_ExtINT
;

2895 
íåy1
.
pﬁ¨ôy
 = 
íåy0
.polarity;

2896 
íåy1
.
åiggî
 = 0;

2897 
íåy1
.
ve˘‹
 = 0;

2899 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy1
);

2901 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2902 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2903 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
 & ~
RTC_RATE_SELECT
) | 0x6,

2904 
RTC_FREQ_SELECT
);

2905 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2907 
i
 = 100;

2908 
i
-- > 0) {

2909 
	`mdñay
(10);

2910 i‡((
	`CMOS_READ
(
RTC_INTR_FLAGS
Ë& 
RTC_PF
) == RTC_PF)

2911 
i
 -= 10;

2914 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

2915 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

2916 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2918 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy0
);

2919 
	}
}

2921 
dißbÀ_timî_pö_1
 
	g__öôd©a
;

2923 
__öô
 
	$dißbÀ_timî_pö_£tup
(*
¨g
)

2925 
dißbÀ_timî_pö_1
 = 1;

2927 
	}
}

2928 
óæy_∑øm
("dißbÀ_timî_pö_1", 
dißbÀ_timî_pö_£tup
);

2930 
timî_through_8259
 
	g__öôd©a
;

2940 
ölöe
 
__öô
 
	$check_timî
()

2942 
úq_desc
 *
desc
 = 
	`úq_to_desc
(0);

2943 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2944 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

2945 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
;

2946 
Êags
;

2947 
no_pö1
 = 0;

2949 
	`loˇl_úq_ßve
(
Êags
);

2954 
Àgacy_pic
->
chù
->
	`mask
(0);

2955 
	`assign_úq_ve˘‹
(0, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

2966 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2967 
Àgacy_pic
->
	`öô
(1);

2968 #ifde‡
CONFIG_X86_32


2970 
vî
;

2972 
vî
 = 
	`≠ic_ªad
(
APIC_LVR
);

2973 
vî
 = 
	`GET_APIC_VERSION
(ver);

2974 
timî_ack
 = (
nmi_w©chdog
 =
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
vî
));

2978 
pö1
 = 
	`föd_iß_úq_pö
(0, 
mp_INT
);

2979 
≠ic1
 = 
	`föd_iß_úq_≠ic
(0, 
mp_INT
);

2980 
pö2
 = 
iﬂpic_i8259
.
pö
;

2981 
≠ic2
 = 
iﬂpic_i8259
.
≠ic
;

2983 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2985 
cfg
->
ve˘‹
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2994 i‡(
pö1
 == -1) {

2995 i‡(
öå_ªm≠pög_íabÀd
)

2996 
	`∑nic
("BIOS bug:ÅimerÇot connectedÅo IO-APIC");

2997 
pö1
 = 
pö2
;

2998 
≠ic1
 = 
≠ic2
;

2999 
no_pö1
 = 1;

3000 } i‡(
pö2
 == -1) {

3001 
pö2
 = 
pö1
;

3002 
≠ic2
 = 
≠ic1
;

3005 i‡(
pö1
 != -1) {

3009 i‡(
no_pö1
) {

3010 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
);

3011 
	`£tup_timî_IRQ0_pö
(
≠ic1
, 
pö1
, 
cfg
->
ve˘‹
);

3018 
idx
;

3019 
idx
 = 
	`föd_úq_íåy
(
≠ic1
, 
pö1
, 
mp_INT
);

3020 i‡(
idx
 !-1 && 
	`úq_åiggî
(idx))

3021 
	`unmask_IO_APIC_úq_desc
(
desc
);

3023 i‡(
	`timî_úq_w‹ks
()) {

3024 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3025 
	`£tup_nmi
();

3026 
Àgacy_pic
->
chù
->
	`unmask
(0);

3028 i‡(
dißbÀ_timî_pö_1
 > 0)

3029 
	`˛ór_IO_APIC_pö
(0, 
pö1
);

3030 
out
;

3032 i‡(
öå_ªm≠pög_íabÀd
)

3033 
	`∑nic
("timer doesn't workÅhrough Interrupt-remapped IO-APIC");

3034 
	`loˇl_úq_dißbÀ
();

3035 
	`˛ór_IO_APIC_pö
(
≠ic1
, 
pö1
);

3036 i‡(!
no_pö1
)

3037 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

3040 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingÅo set upÅimer "

3042 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3043 "..... (foundápi¯%dÖö %dË...\n", 
≠ic2
, 
pö2
);

3047 
	`ª∂a˚_pö_©_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

3048 
	`£tup_timî_IRQ0_pö
(
≠ic2
, 
pö2
, 
cfg
->
ve˘‹
);

3049 
Àgacy_pic
->
chù
->
	`unmask
(0);

3050 i‡(
	`timî_úq_w‹ks
()) {

3051 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

3052 
timî_through_8259
 = 1;

3053 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3054 
Àgacy_pic
->
chù
->
	`mask
(0);

3055 
	`£tup_nmi
();

3056 
Àgacy_pic
->
chù
->
	`unmask
(0);

3058 
out
;

3063 
	`loˇl_úq_dißbÀ
();

3064 
Àgacy_pic
->
chù
->
	`mask
(0);

3065 
	`˛ór_IO_APIC_pö
(
≠ic2
, 
pö2
);

3066 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

3069 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3070 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

3072 
nmi_w©chdog
 = 
NMI_NONE
;

3074 #ifde‡
CONFIG_X86_32


3075 
timî_ack
 = 0;

3078 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3081 
	`œpic_ªgi°î_öå
(0, 
desc
);

3082 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3083 
Àgacy_pic
->
chù
->
	`unmask
(0);

3085 i‡(
	`timî_úq_w‹ks
()) {

3086 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3087 
out
;

3089 
	`loˇl_úq_dißbÀ
();

3090 
Àgacy_pic
->
chù
->
	`mask
(0);

3091 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3092 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

3094 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3097 
Àgacy_pic
->
	`öô
(0);

3098 
Àgacy_pic
->
	`make_úq
(0);

3099 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

3101 
	`u∆ock_ExtINT_logic
();

3103 i‡(
	`timî_úq_w‹ks
()) {

3104 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3105 
out
;

3107 
	`loˇl_úq_dißbÀ
();

3108 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

3109 
	`∑nic
("IO-APIC +Åimer doesn't work! Boot withápic=debugánd sendá "

3111 
out
:

3112 
	`loˇl_úq_ª°‹e
(
Êags
);

3113 
	}
}

3132 
	#PIC_IRQS
 (1UL << 
PIC_CASCADE_IR
)

	)

3134 
__öô
 
	$£tup_IO_APIC
()

3140 
io_≠ic_úqs
 = 
Àgacy_pic
->
ƒ_Àgacy_úqs
 ? ~
PIC_IRQS
 : ~0UL;

3142 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3146 
x86_öô
.
mµ¨£
.
	`£tup_iﬂpic_ids
();

3148 
	`sync_Arb_IDs
();

3149 
	`£tup_IO_APIC_úqs
();

3150 
	`öô_IO_APIC_å≠s
();

3151 i‡(
Àgacy_pic
->
ƒ_Àgacy_úqs
)

3152 
	`check_timî
();

3153 
	}
}

3160 
__öô
 
	$io_≠ic_bug_föÆize
()

3162 i‡(
sis_≠ic_bug
 == -1)

3163 
sis_≠ic_bug
 = 0;

3165 
	}
}

3167 
œã_öôˇŒ
(
io_≠ic_bug_föÆize
);

3169 
	ssysfs_iﬂpic_d©a
 {

3170 
sys_devi˚
 
	mdev
;

3171 
IO_APIC_rouã_íåy
 
	míåy
[0];

3173 
sysfs_iﬂpic_d©a
 * 
	gmp_iﬂpic_d©a
[
MAX_IO_APICS
];

3175 
	$iﬂpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

3177 
IO_APIC_rouã_íåy
 *
íåy
;

3178 
sysfs_iﬂpic_d©a
 *
d©a
;

3179 
i
;

3181 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3182 
íåy
 = 
d©a
->entry;

3183 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i ++, 
íåy
 ++ )

3184 *
íåy
 = 
	`iﬂpic_ªad_íåy
(
dev
->
id
, 
i
);

3187 
	}
}

3189 
	$iﬂpic_ªsume
(
sys_devi˚
 *
dev
)

3191 
IO_APIC_rouã_íåy
 *
íåy
;

3192 
sysfs_iﬂpic_d©a
 *
d©a
;

3193 
Êags
;

3194 
IO_APIC_ªg_00
 
ªg_00
;

3195 
i
;

3197 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3198 
íåy
 = 
d©a
->entry;

3200 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3201 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
dev
->
id
, 0);

3202 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
dev
->
id
].
≠icid
) {

3203 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
dev
->
id
].
≠icid
;

3204 
	`io_≠ic_wrôe
(
dev
->
id
, 0, 
ªg_00
.
øw
);

3206 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3207 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i++)

3208 
	`iﬂpic_wrôe_íåy
(
dev
->
id
, 
i
, 
íåy
[i]);

3211 
	}
}

3213 
sysdev_˛ass
 
	giﬂpic_sysdev_˛ass
 = {

3214 .
«me
 = "ioapic",

3215 .
	gsu•íd
 = 
iﬂpic_su•íd
,

3216 .
	gªsume
 = 
iﬂpic_ªsume
,

3219 
__öô
 
	$iﬂpic_öô_sysfs
()

3221 
sys_devi˚
 * 
dev
;

3222 
i
, 
size
, 
îr‹
;

3224 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
iﬂpic_sysdev_˛ass
);

3225 i‡(
îr‹
)

3226  
îr‹
;

3228 
i
 = 0; i < 
ƒ_iﬂpics
; i++ ) {

3229 
size
 = (
sys_devi˚
Ë+ 
ƒ_iﬂpic_ªgi°îs
[
i
]

3230 * (
IO_APIC_rouã_íåy
);

3231 
mp_iﬂpic_d©a
[
i
] = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3232 i‡(!
mp_iﬂpic_d©a
[
i
]) {

3233 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3236 
dev
 = &
mp_iﬂpic_d©a
[
i
]->dev;

3237 
dev
->
id
 = 
i
;

3238 
dev
->
˛s
 = &
iﬂpic_sysdev_˛ass
;

3239 
îr‹
 = 
	`sysdev_ªgi°î
(
dev
);

3240 i‡(
îr‹
) {

3241 
	`k‰ì
(
mp_iﬂpic_d©a
[
i
]);

3242 
mp_iﬂpic_d©a
[
i
] = 
NULL
;

3243 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3249 
	}
}

3251 
devi˚_öôˇŒ
(
iﬂpic_öô_sysfs
);

3256 
	$¸óã_úq_ƒ
(
úq_w™t
, 
node
)

3259 
úq
;

3260 
√w
;

3261 
Êags
;

3262 
úq_cfg
 *
cfg_√w
 = 
NULL
;

3263 
úq_desc
 *
desc_√w
 = 
NULL
;

3265 
úq
 = 0;

3266 i‡(
úq_w™t
 < 
ƒ_úqs_gsi
)

3267 
úq_w™t
 = 
ƒ_úqs_gsi
;

3269 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3270 
√w
 = 
úq_w™t
;Çew < 
ƒ_úqs
;Çew++) {

3271 
desc_√w
 = 
	`úq_to_desc_Æloc_node
(
√w
, 
node
);

3272 i‡(!
desc_√w
) {

3273 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
√w
);

3276 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3278 i‡(
cfg_√w
->
ve˘‹
 != 0)

3281 
desc_√w
 = 
	`move_úq_desc
(desc_√w, 
node
);

3282 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3284 i‡(
	`__assign_úq_ve˘‹
(
√w
, 
cfg_√w
, 
≠ic
->
	`èrgë_˝us
()) == 0)

3285 
úq
 = 
√w
;

3288 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3290 i‡(
úq
 > 0)

3291 
	`dy«mic_úq_öô_kìp_chù_d©a
(
úq
);

3293  
úq
;

3294 
	}
}

3296 
	$¸óã_úq
()

3298 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3299 
úq_w™t
;

3300 
úq
;

3302 
úq_w™t
 = 
ƒ_úqs_gsi
;

3303 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3305 i‡(
úq
 == 0)

3306 
úq
 = -1;

3308  
úq
;

3309 
	}
}

3311 
	$de°roy_úq
(
úq
)

3313 
Êags
;

3315 
	`dy«mic_úq_˛ónup_kìp_chù_d©a
(
úq
);

3317 
	`‰ì_úã
(
úq
);

3318 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3319 
	`__˛ór_úq_ve˘‹
(
úq
, 
	`gë_úq_chù_d©a
(irq));

3320 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3321 
	}
}

3326 #ifde‡
CONFIG_PCI_MSI


3327 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
úq
,

3328 
msi_msg
 *
msg
, 
u8
 
h≥t_id
)

3330 
úq_cfg
 *
cfg
;

3331 
îr
;

3332 
de°
;

3334 i‡(
dißbÀ_≠ic
)

3335  -
ENXIO
;

3337 
cfg
 = 
	`úq_cfg
(
úq
);

3338 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3339 i‡(
îr
)

3340  
îr
;

3342 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

3344 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3345 
úã
 irte;

3346 
ú_ödex
;

3347 
u16
 
sub_h™dÀ
;

3349 
ú_ödex
 = 
	`m≠_úq_to_úã_h™dÀ
(
úq
, &
sub_h™dÀ
);

3350 
	`BUG_ON
(
ú_ödex
 == -1);

3352 
	`mem£t
 (&
úã
, 0, (irte));

3354 
úã
.
¥e£¡
 = 1;

3355 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

3356 
úã
.
åiggî_mode
 = 0;

3357 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3358 
úã
.
ve˘‹
 = 
cfg
->vector;

3359 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3362 i‡(
pdev
)

3363 
	`£t_msi_sid
(&
úã
, 
pdev
);

3365 
	`£t_h≥t_sid
(&
úã
, 
h≥t_id
);

3367 
	`modify_úã
(
úq
, &
úã
);

3369 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3370 
msg
->
d©a
 = 
sub_h™dÀ
;

3371 
msg
->
addªss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3372 
MSI_ADDR_IR_SHV
 |

3373 
	`MSI_ADDR_IR_INDEX1
(
ú_ödex
) |

3374 
	`MSI_ADDR_IR_INDEX2
(
ú_ödex
);

3376 i‡(
	`x2≠ic_íabÀd
())

3377 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
 |

3378 
	`MSI_ADDR_EXT_DEST_ID
(
de°
);

3380 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3382 
msg
->
addªss_lo
 =

3383 
MSI_ADDR_BASE_LO
 |

3384 ((
≠ic
->
úq_de°_mode
 == 0) ?

3385 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3386 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3387 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3388 
MSI_ADDR_REDIRECTION_CPU
:

3389 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3390 
	`MSI_ADDR_DEST_ID
(
de°
);

3392 
msg
->
d©a
 =

3393 
MSI_DATA_TRIGGER_EDGE
 |

3394 
MSI_DATA_LEVEL_ASSERT
 |

3395 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3396 
MSI_DATA_DELIVERY_FIXED
:

3397 
MSI_DATA_DELIVERY_LOWPRI
) |

3398 
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3400  
îr
;

3401 
	}
}

3403 #ifde‡
CONFIG_SMP


3404 
	$£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3406 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3407 
úq_cfg
 *
cfg
;

3408 
msi_msg
 
msg
;

3409 
de°
;

3411 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3414 
cfg
 = 
desc
->
chù_d©a
;

3416 
	`ªad_msi_msg_desc
(
desc
, &
msg
);

3418 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3419 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3420 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3421 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3423 
	`wrôe_msi_msg_desc
(
desc
, &
msg
);

3426 
	}
}

3427 #ifde‡
CONFIG_INTR_REMAP


3433 
	$ú_£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3435 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3436 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

3437 
de°
;

3438 
úã
 irte;

3440 i‡(
	`gë_úã
(
úq
, &
úã
))

3443 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3446 
úã
.
ve˘‹
 = 
cfg
->vector;

3447 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3452 
	`modify_úã
(
úq
, &
úã
);

3459 i‡(
cfg
->
move_ö_¥ogªss
)

3460 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3463 
	}
}

3472 
úq_chù
 
	gmsi_chù
 = {

3473 .
«me
 = "PCI-MSI",

3474 .
	gunmask
 = 
unmask_msi_úq
,

3475 .
	gmask
 = 
mask_msi_úq
,

3476 .
	gack
 = 
ack_≠ic_edge
,

3477 #ifde‡
CONFIG_SMP


3478 .
	g£t_afföôy
 = 
£t_msi_úq_afföôy
,

3480 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3483 
úq_chù
 
	gmsi_ú_chù
 = {

3484 .
«me
 = "IR-PCI-MSI",

3485 .
	gunmask
 = 
unmask_msi_úq
,

3486 .
	gmask
 = 
mask_msi_úq
,

3487 #ifde‡
CONFIG_INTR_REMAP


3488 .
	gack
 = 
ú_ack_≠ic_edge
,

3489 #ifde‡
CONFIG_SMP


3490 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3493 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3501 
	$msi_Æloc_úã
(
pci_dev
 *
dev
, 
úq
, 
nvec
)

3503 
öãl_iommu
 *
iommu
;

3504 
ödex
;

3506 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3507 i‡(!
iommu
) {

3508 
	`¥ötk
(
KERN_ERR


3509 "U«bÀÅÿm≠ PCI %†tÿiommu\n", 
	`pci_«me
(
dev
));

3510  -
ENOENT
;

3513 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 
nvec
);

3514 i‡(
ödex
 < 0) {

3515 
	`¥ötk
(
KERN_ERR


3516 "U«bÀÅÿÆloˇã %d IRTE f‹ PCI %s\n", 
nvec
,

3517 
	`pci_«me
(
dev
));

3518  -
ENOSPC
;

3520  
ödex
;

3521 
	}
}

3523 
	$£tup_msi_úq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
úq
)

3525 
ªt
;

3526 
msi_msg
 
msg
;

3528 
ªt
 = 
	`msi_compo£_msg
(
dev
, 
úq
, &
msg
, -1);

3529 i‡(
ªt
 < 0)

3530  
ªt
;

3532 
	`£t_úq_msi
(
úq
, 
msidesc
);

3533 
	`wrôe_msi_msg
(
úq
, &
msg
);

3535 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3536 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3540 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3541 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_ú_chù
, 
h™dÀ_edge_úq
, "edge");

3543 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_chù
, 
h™dÀ_edge_úq
, "edge");

3545 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ MSI/MSI-X\n", 
úq
);

3548 
	}
}

3550 
	$¨ch_£tup_msi_úqs
(
pci_dev
 *
dev
, 
nvec
, 
ty≥
)

3552 
úq
;

3553 
ªt
, 
sub_h™dÀ
;

3554 
msi_desc
 *
msidesc
;

3555 
úq_w™t
;

3556 
öãl_iommu
 *
iommu
 = 
NULL
;

3557 
ödex
 = 0;

3558 
node
;

3561 i‡(
ty≥
 =
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3564 
node
 = 
	`dev_to_node
(&
dev
->dev);

3565 
úq_w™t
 = 
ƒ_úqs_gsi
;

3566 
sub_h™dÀ
 = 0;

3567 
	`li°_f‹_óch_íåy
(
msidesc
, &
dev
->
msi_li°
, 
li°
) {

3568 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3569 i‡(
úq
 == 0)

3571 
úq_w™t
 = 
úq
 + 1;

3572 i‡(!
öå_ªm≠pög_íabÀd
)

3573 
no_ú
;

3575 i‡(!
sub_h™dÀ
) {

3580 
ödex
 = 
	`msi_Æloc_úã
(
dev
, 
úq
, 
nvec
);

3581 i‡(
ödex
 < 0) {

3582 
ªt
 = 
ödex
;

3583 
îr‹
;

3586 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3587 i‡(!
iommu
) {

3588 
ªt
 = -
ENOENT
;

3589 
îr‹
;

3596 
	`£t_úã_úq
(
úq
, 
iommu
, 
ödex
, 
sub_h™dÀ
);

3598 
no_ú
:

3599 
ªt
 = 
	`£tup_msi_úq
(
dev
, 
msidesc
, 
úq
);

3600 i‡(
ªt
 < 0)

3601 
îr‹
;

3602 
sub_h™dÀ
++;

3606 
îr‹
:

3607 
	`de°roy_úq
(
úq
);

3608  
ªt
;

3609 
	}
}

3611 
	$¨ch_ã¨down_msi_úq
(
úq
)

3613 
	`de°roy_úq
(
úq
);

3614 
	}
}

3616 #i‡
deföed
 (
CONFIG_DMAR
Ë|| deföed (
CONFIG_INTR_REMAP
)

3617 #ifde‡
CONFIG_SMP


3618 
	$dm¨_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3620 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3621 
úq_cfg
 *
cfg
;

3622 
msi_msg
 
msg
;

3623 
de°
;

3625 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3628 
cfg
 = 
desc
->
chù_d©a
;

3630 
	`dm¨_msi_ªad
(
úq
, &
msg
);

3632 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3633 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3634 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3635 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3637 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3640 
	}
}

3644 
úq_chù
 
	gdm¨_msi_ty≥
 = {

3645 .
«me
 = "DMAR_MSI",

3646 .
	gunmask
 = 
dm¨_msi_unmask
,

3647 .
	gmask
 = 
dm¨_msi_mask
,

3648 .
	gack
 = 
ack_≠ic_edge
,

3649 #ifde‡
CONFIG_SMP


3650 .
	g£t_afföôy
 = 
dm¨_msi_£t_afföôy
,

3652 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3655 
	$¨ch_£tup_dm¨_msi
(
úq
)

3657 
ªt
;

3658 
msi_msg
 
msg
;

3660 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, -1);

3661 i‡(
ªt
 < 0)

3662  
ªt
;

3663 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3664 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
dm¨_msi_ty≥
, 
h™dÀ_edge_úq
,

3667 
	}
}

3670 #ifde‡
CONFIG_HPET_TIMER


3672 #ifde‡
CONFIG_SMP


3673 
	$h≥t_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3675 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3676 
úq_cfg
 *
cfg
;

3677 
msi_msg
 
msg
;

3678 
de°
;

3680 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3683 
cfg
 = 
desc
->
chù_d©a
;

3685 
	`h≥t_msi_ªad
(
úq
, &
msg
);

3687 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3688 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3689 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3690 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3692 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3695 
	}
}

3699 
úq_chù
 
	gú_h≥t_msi_ty≥
 = {

3700 .
«me
 = "IR-HPET_MSI",

3701 .
	gunmask
 = 
h≥t_msi_unmask
,

3702 .
	gmask
 = 
h≥t_msi_mask
,

3703 #ifde‡
CONFIG_INTR_REMAP


3704 .
	gack
 = 
ú_ack_≠ic_edge
,

3705 #ifde‡
CONFIG_SMP


3706 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3709 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3712 
úq_chù
 
	gh≥t_msi_ty≥
 = {

3713 .
«me
 = "HPET_MSI",

3714 .
	gunmask
 = 
h≥t_msi_unmask
,

3715 .
	gmask
 = 
h≥t_msi_mask
,

3716 .
	gack
 = 
ack_≠ic_edge
,

3717 #ifde‡
CONFIG_SMP


3718 .
	g£t_afföôy
 = 
h≥t_msi_£t_afföôy
,

3720 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3723 
	$¨ch_£tup_h≥t_msi
(
úq
, 
id
)

3725 
ªt
;

3726 
msi_msg
 
msg
;

3727 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3729 i‡(
öå_ªm≠pög_íabÀd
) {

3730 
öãl_iommu
 *
iommu
 = 
	`m≠_h≥t_to_ú
(
id
);

3731 
ödex
;

3733 i‡(!
iommu
)

3736 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

3737 i‡(
ödex
 < 0)

3741 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, 
id
);

3742 i‡(
ªt
 < 0)

3743  
ªt
;

3745 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3746 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3747 i‡(
	`úq_ªm≠≥d
(
úq
))

3748 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_h≥t_msi_ty≥
,

3749 
h™dÀ_edge_úq
, "edge");

3751 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
h≥t_msi_ty≥
,

3752 
h™dÀ_edge_úq
, "edge");

3755 
	}
}

3762 #ifde‡
CONFIG_HT_IRQ


3764 #ifde‡
CONFIG_SMP


3766 
	$èrgë_ht_úq
(
úq
, 
de°
, 
u8
 
ve˘‹
)

3768 
ht_úq_msg
 
msg
;

3769 
	`„tch_ht_úq_msg
(
úq
, &
msg
);

3771 
msg
.
addªss_lo
 &~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3772 
msg
.
addªss_hi
 &~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3774 
msg
.
addªss_lo
 |
	`HT_IRQ_LOW_VECTOR
(
ve˘‹
Ë| 
	`HT_IRQ_LOW_DEST_ID
(
de°
);

3775 
msg
.
addªss_hi
 |
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3777 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3778 
	}
}

3780 
	$£t_ht_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3782 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3783 
úq_cfg
 *
cfg
;

3784 
de°
;

3786 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3789 
cfg
 = 
desc
->
chù_d©a
;

3791 
	`èrgë_ht_úq
(
úq
, 
de°
, 
cfg
->
ve˘‹
);

3794 
	}
}

3798 
úq_chù
 
	ght_úq_chù
 = {

3799 .
«me
 = "PCI-HT",

3800 .
	gmask
 = 
mask_ht_úq
,

3801 .
	gunmask
 = 
unmask_ht_úq
,

3802 .
	gack
 = 
ack_≠ic_edge
,

3803 #ifde‡
CONFIG_SMP


3804 .
	g£t_afföôy
 = 
£t_ht_úq_afföôy
,

3806 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3809 
	$¨ch_£tup_ht_úq
(
úq
, 
pci_dev
 *
dev
)

3811 
úq_cfg
 *
cfg
;

3812 
îr
;

3814 i‡(
dißbÀ_≠ic
)

3815  -
ENXIO
;

3817 
cfg
 = 
	`úq_cfg
(
úq
);

3818 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3819 i‡(!
îr
) {

3820 
ht_úq_msg
 
msg
;

3821 
de°
;

3823 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,

3824 
≠ic
->
	`èrgë_˝us
());

3826 
msg
.
addªss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3828 
msg
.
addªss_lo
 =

3829 
HT_IRQ_LOW_BASE
 |

3830 
	`HT_IRQ_LOW_DEST_ID
(
de°
) |

3831 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
ve˘‹
) |

3832 ((
≠ic
->
úq_de°_mode
 == 0) ?

3833 
HT_IRQ_LOW_DM_PHYSICAL
 :

3834 
HT_IRQ_LOW_DM_LOGICAL
) |

3835 
HT_IRQ_LOW_RQEOI_EDGE
 |

3836 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3837 
HT_IRQ_LOW_MT_FIXED
 :

3838 
HT_IRQ_LOW_MT_ARBITRATED
) |

3839 
HT_IRQ_LOW_IRQ_MASKED
;

3841 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3843 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ht_úq_chù
,

3844 
h™dÀ_edge_úq
, "edge");

3846 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ HT\n", 
úq
);

3848  
îr
;

3849 
	}
}

3852 
__öô
 
	$io_≠ic_gë_ªdú_íåõs
 (
iﬂpic
)

3854 
IO_APIC_ªg_01
 
ªg_01
;

3855 
Êags
;

3857 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3858 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

3859 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3861  
ªg_01
.
bôs
.
íåõs
;

3862 
	}
}

3864 
__öô
 
	$¥obe_ƒ_úqs_gsi
()

3866 
ƒ
 = 0;

3868 
ƒ
 = 
	`a˝i_¥obe_gsi
();

3869 i‡(
ƒ
 > 
ƒ_úqs_gsi
) {

3870 
ƒ_úqs_gsi
 = 
ƒ
;

3873 
idx
;

3875 
ƒ
 = 0;

3876 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++)

3877 
ƒ
 +
	`io_≠ic_gë_ªdú_íåõs
(
idx
) + 1;

3879 i‡(
ƒ
 > 
ƒ_úqs_gsi
)

3880 
ƒ_úqs_gsi
 = 
ƒ
;

3883 
	`¥ötk
(
KERN_DEBUG
 "ƒ_úqs_gsi: %d\n", 
ƒ_úqs_gsi
);

3884 
	}
}

3886 #ifde‡
CONFIG_SPARSE_IRQ


3887 
__öô
 
	$¨ch_¥obe_ƒ_úqs
()

3889 
ƒ
;

3891 i‡(
ƒ_úqs
 > (
NR_VECTORS
 * 
ƒ_˝u_ids
))

3892 
ƒ_úqs
 = 
NR_VECTORS
 * 
ƒ_˝u_ids
;

3894 
ƒ
 = 
ƒ_úqs_gsi
 + 8 * 
ƒ_˝u_ids
;

3895 #i‡
	`deföed
(
CONFIG_PCI_MSI
Ë|| deföed(
CONFIG_HT_IRQ
)

3899 
ƒ
 +
ƒ_úqs_gsi
 * 16;

3901 i‡(
ƒ
 < 
ƒ_úqs
)

3902 
ƒ_úqs
 = 
ƒ
;

3905 
	}
}

3908 
	$__io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3909 
io_≠ic_úq_©å
 *
úq_©å
)

3911 
úq_desc
 *
desc
;

3912 
úq_cfg
 *
cfg
;

3913 
node
;

3914 
iﬂpic
, 
pö
;

3915 
åiggî
, 
pﬁ¨ôy
;

3917 
iﬂpic
 = 
úq_©å
->ioapic;

3918 i‡(!
	`IO_APIC_IRQ
(
úq
)) {

3919 
	`≠ic_¥ötk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: InvalidÑeferenceÅo IRQ 0\n",

3920 
iﬂpic
);

3921  -
EINVAL
;

3924 i‡(
dev
)

3925 
node
 = 
	`dev_to_node
(
dev
);

3927 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3929 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

3930 i‡(!
desc
) {

3931 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯%d\n", 
úq
);

3935 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3936 
åiggî
 = 
úq_©å
->trigger;

3937 
pﬁ¨ôy
 = 
úq_©å
->polarity;

3942 i‡(
úq
 >
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

3943 
cfg
 = 
desc
->
chù_d©a
;

3944 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
iﬂpic
, 
pö
)) {

3945 
	`¥ötk
(
KERN_INFO
 "canÇotáddÖin %d for irq %d\n",

3946 
pö
, 
úq
);

3951 
	`£tup_IO_APIC_úq
(
iﬂpic
, 
pö
, 
úq
, 
desc
, 
åiggî
, 
pﬁ¨ôy
);

3954 
	}
}

3956 
	$io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3957 
io_≠ic_úq_©å
 *
úq_©å
)

3959 
iﬂpic
, 
pö
;

3965 
iﬂpic
 = 
úq_©å
->ioapic;

3966 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3967 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
)) {

3968 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

3969 
mp_iﬂpics
[
iﬂpic
].
≠icid
, 
pö
);

3972 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
);

3974  
	`__io_≠ic_£t_pci_routög
(
dev
, 
úq
, 
úq_©å
);

3975 
	}
}

3977 
u8
 
__öô
 
	$io_≠ic_unique_id
(
u8
 
id
)

3979 #ifde‡
CONFIG_X86_32


3980 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

3981 !
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

3982  
	`io_≠ic_gë_unique_id
(
ƒ_iﬂpics
, 
id
);

3984  
id
;

3986 
i
;

3987 
	`DECLARE_BITMAP
(
u£d
, 256);

3989 
	`bôm≠_zîo
(
u£d
, 256);

3990 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

3991 
mpc_iﬂpic
 *
ü
 = &
mp_iﬂpics
[
i
];

3992 
	`__£t_bô
(
ü
->
≠icid
, 
u£d
);

3994 i‡(!
	`ã°_bô
(
id
, 
u£d
))

3995  
id
;

3996  
	`föd_fú°_zîo_bô
(
u£d
, 256);

3998 
	}
}

4000 #ifde‡
CONFIG_X86_32


4001 
__öô
 
	$io_≠ic_gë_unique_id
(
iﬂpic
, 
≠ic_id
)

4003 
IO_APIC_ªg_00
 
ªg_00
;

4004 
physid_mask_t
 
≠ic_id_m≠
 = 
PHYSID_MASK_NONE
;

4005 
physid_mask_t
 
tmp
;

4006 
Êags
;

4007 
i
 = 0;

4018 i‡(
	`physids_em±y
(
≠ic_id_m≠
))

4019 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
≠ic_id_m≠
);

4021 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4022 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4023 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4025 i‡(
≠ic_id
 >
	`gë_physiˇl_brﬂdˇ°
()) {

4026 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]: Invalidápic_id %d,Årying "

4027 "%d\n", 
iﬂpic
, 
≠ic_id
, 
ªg_00
.
bôs
.
ID
);

4028 
≠ic_id
 = 
ªg_00
.
bôs
.
ID
;

4035 i‡(
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
≠ic_id
)) {

4037 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++) {

4038 i‡(!
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
i
))

4042 i‡(
i
 =
	`gë_physiˇl_brﬂdˇ°
())

4043 
	`∑nic
("Maxápic_idÉxceeded!\n");

4045 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]:ápic_id %dálready used, "

4046 "åyög %d\n", 
iﬂpic
, 
≠ic_id
, 
i
);

4048 
≠ic_id
 = 
i
;

4051 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
≠ic_id
, &
tmp
);

4052 
	`physids_‹
(
≠ic_id_m≠
,ápic_id_m≠, 
tmp
);

4054 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4055 
ªg_00
.
bôs
.
ID
 = 
≠ic_id
;

4057 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4058 
	`io_≠ic_wrôe
(
iﬂpic
, 0, 
ªg_00
.
øw
);

4059 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4060 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4063 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4064 
	`¥ötk
("IOAPIC[%d]: U«bÀÅÿch™gê≠ic_id!\n", 
iﬂpic
);

4069 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


4070 "IOAPIC[%d]: Assig√dápic_id %d\n", 
iﬂpic
, 
≠ic_id
);

4072  
≠ic_id
;

4073 
	}
}

4076 
__öô
 
	$io_≠ic_gë_vîsi⁄
(
iﬂpic
)

4078 
IO_APIC_ªg_01
 
ªg_01
;

4079 
Êags
;

4081 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4082 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

4083 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4085  
ªg_01
.
bôs
.
vîsi⁄
;

4086 
	}
}

4088 
	$a˝i_gë_ovîride_úq
(
bus_úq
, *
åiggî
, *
pﬁ¨ôy
)

4090 
i
;

4092 i‡(
skù_iﬂpic_£tup
)

4095 
i
 = 0; i < 
mp_úq_íåõs
; i++)

4096 i‡(
mp_úqs
[
i
].
úqty≥
 =
mp_INT
 &&

4097 
mp_úqs
[
i
].
§cbusúq
 =
bus_úq
)

4099 i‡(
i
 >
mp_úq_íåõs
)

4102 *
åiggî
 = 
	`úq_åiggî
(
i
);

4103 *
pﬁ¨ôy
 = 
	`úq_pﬁ¨ôy
(
i
);

4105 
	}
}

4112 #ifde‡
CONFIG_SMP


4113 
__öô
 
	$£tup_iﬂpic_de°
()

4115 
pö
, 
iﬂpic
, 
úq
, 
úq_íåy
;

4116 
úq_desc
 *
desc
;

4117 c⁄° 
˝umask
 *
mask
;

4119 i‡(
skù_iﬂpic_£tup
 == 1)

4122 
iﬂpic
 = 0; iﬂpi¯< 
ƒ_iﬂpics
; ioapic++)

4123 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
iﬂpic
];Öin++) {

4124 
úq_íåy
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4125 i‡(
úq_íåy
 == -1)

4127 
úq
 = 
	`pö_2_úq
(
úq_íåy
, 
iﬂpic
, 
pö
);

4129 i‡((
iﬂpic
 > 0Ë&& (
úq
 > 16))

4132 
desc
 = 
	`úq_to_desc
(
úq
);

4137 i‡(
desc
->
°©us
 &

4138 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4139 
mask
 = 
desc
->
afföôy
;

4141 
mask
 = 
≠ic
->
	`èrgë_˝us
();

4143 i‡(
öå_ªm≠pög_íabÀd
)

4144 
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4146 
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4149 
	}
}

4152 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4154 
ªsour˚
 *
	giﬂpic_ªsour˚s
;

4156 
ªsour˚
 * 
__öô
 
	$iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
)

4158 
n
;

4159 
ªsour˚
 *
ªs
;

4160 *
mem
;

4161 
i
;

4163 i‡(
ƒ_iﬂpics
 <= 0)

4164  
NULL
;

4166 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
ªsour˚
);

4167 
n
 *
ƒ_iﬂpics
;

4169 
mem
 = 
	`Æloc_boŸmem
(
n
);

4170 
ªs
 = (*)
mem
;

4172 
mem
 +(
ªsour˚
Ë* 
ƒ_iﬂpics
;

4174 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4175 
ªs
[
i
].
«me
 = 
mem
;

4176 
ªs
[
i
].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4177 
	`¢¥ötf
(
mem
, 
IOAPIC_RESOURCE_NAME_SIZE
, "IOAPIC %u", 
i
);

4178 
mem
 +
IOAPIC_RESOURCE_NAME_SIZE
;

4181 
iﬂpic_ªsour˚s
 = 
ªs
;

4183  
ªs
;

4184 
	}
}

4186 
__öô
 
	$iﬂpic_öô_m≠pögs
()

4188 
iﬂpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4189 
ªsour˚
 *
iﬂpic_ªs
;

4190 
i
;

4192 
iﬂpic_ªs
 = 
	`iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
);

4193 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4194 i‡(
smp_found_c⁄fig
) {

4195 
iﬂpic_phys
 = 
mp_iﬂpics
[
i
].
≠iˇddr
;

4196 #ifde‡
CONFIG_X86_32


4197 i‡(!
iﬂpic_phys
) {

4198 
	`¥ötk
(
KERN_ERR


4202 
smp_found_c⁄fig
 = 0;

4203 
skù_iﬂpic_£tup
 = 1;

4204 
Áke_iﬂpic_∑ge
;

4208 #ifde‡
CONFIG_X86_32


4209 
Áke_iﬂpic_∑ge
:

4211 
iﬂpic_phys
 = ()
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

4212 
iﬂpic_phys
 = 
	`__∑
(ioapic_phys);

4214 
	`£t_fixm≠_noˇche
(
idx
, 
iﬂpic_phys
);

4215 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped IOAPICÅo %08lx (%08lx)\n",

4216 
	`__fix_to_vút
(
idx
Ë+ (
iﬂpic_phys
 & ~
PAGE_MASK
),

4217 
iﬂpic_phys
);

4218 
idx
++;

4220 
iﬂpic_ªs
->
°¨t
 = 
iﬂpic_phys
;

4221 
iﬂpic_ªs
->
íd
 = 
iﬂpic_phys
 + 
IO_APIC_SLOT_SIZE
 - 1;

4222 
iﬂpic_ªs
++;

4224 
	}
}

4226 
__öô
 
	$iﬂpic_ö£π_ªsour˚s
()

4228 
i
;

4229 
ªsour˚
 *
r
 = 
iﬂpic_ªsour˚s
;

4231 i‡(!
r
) {

4232 i‡(
ƒ_iﬂpics
 > 0)

4233 
	`¥ötk
(
KERN_ERR


4238 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4239 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
r
);

4240 
r
++;

4242 
	}
}

4244 
	$mp_föd_iﬂpic
(
gsi
)

4246 
i
 = 0;

4249 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4250 i‡((
gsi
 >
mp_gsi_routög
[
i
].
gsi_ba£
)

4251 && (
gsi
 <
mp_gsi_routög
[
i
].
gsi_íd
))

4252  
i
;

4255 
	`¥ötk
(
KERN_ERR
 "ERROR: U«bÀÅÿloˇã IOAPIC f‹ GSI %d\n", 
gsi
);

4257 
	}
}

4259 
	$mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
)

4261 i‡(
	`WARN_ON
(
iﬂpic
 == -1))

4263 i‡(
	`WARN_ON
(
gsi
 > 
mp_gsi_routög
[
iﬂpic
].
gsi_íd
))

4266  
gsi
 - 
mp_gsi_routög
[
iﬂpic
].
gsi_ba£
;

4267 
	}
}

4269 
	$bad_iﬂpic
(
addªss
)

4271 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

4272 
	`¥ötk
(
KERN_WARNING
 "WARING: Max # of I/O APICs (%d)Éxceeded "

4273 "(found %d), skùpög\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

4276 i‡(!
addªss
) {

4277 
	`¥ötk
(
KERN_WARNING
 "WARNING: Bogus (zero) I/O APICáddress"

4282 
	}
}

4284 
__öô
 
	$mp_ªgi°î_iﬂpic
(
id
, 
u32
 
addªss
, u32 
gsi_ba£
)

4286 
idx
 = 0;

4288 i‡(
	`bad_iﬂpic
(
addªss
))

4291 
idx
 = 
ƒ_iﬂpics
;

4293 
mp_iﬂpics
[
idx
].
ty≥
 = 
MP_IOAPIC
;

4294 
mp_iﬂpics
[
idx
].
Êags
 = 
MPC_APIC_USABLE
;

4295 
mp_iﬂpics
[
idx
].
≠iˇddr
 = 
addªss
;

4297 
	`£t_fixm≠_noˇche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
addªss
);

4298 
mp_iﬂpics
[
idx
].
≠icid
 = 
	`io_≠ic_unique_id
(
id
);

4299 
mp_iﬂpics
[
idx
].
≠icvî
 = 
	`io_≠ic_gë_vîsi⁄
(idx);

4305 
mp_gsi_routög
[
idx
].
gsi_ba£
 = gsi_base;

4306 
mp_gsi_routög
[
idx
].
gsi_íd
 = 
gsi_ba£
 +

4307 
	`io_≠ic_gë_ªdú_íåõs
(
idx
);

4309 
	`¥ötk
(
KERN_INFO
 "IOAPIC[%d]:ápic_id %d, version %d,áddress 0x%x, "

4310 "GSI %d-%d\n", 
idx
, 
mp_iﬂpics
[idx].
≠icid
,

4311 
mp_iﬂpics
[
idx
].
≠icvî
, mp_iﬂpics[idx].
≠iˇddr
,

4312 
mp_gsi_routög
[
idx
].
gsi_ba£
, mp_gsi_routög[idx].
gsi_íd
);

4314 
ƒ_iﬂpics
++;

4315 
	}
}

4318 
__öô
 
	$¥e_öô_≠ic_IRQ0
()

4320 
úq_cfg
 *
cfg
;

4321 
úq_desc
 *
desc
;

4323 
	`¥ötk
(
KERN_INFO
 "Early APIC setup for systemÅimer0\n");

4324 #i‚de‡
CONFIG_SMP


4325 
phys_˝u_¥e£¡_m≠
 = 
	`physid_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
);

4327 
desc
 = 
	`úq_to_desc_Æloc_node
(0, 0);

4329 
	`£tup_loˇl_APIC
();

4331 
cfg
 = 
	`úq_cfg
(0);

4332 
	`add_pö_to_úq_node
(
cfg
, 0, 0, 0);

4333 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

4335 
	`£tup_IO_APIC_úq
(0, 0, 0, 
desc
, 0, 0);

4336 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<löux/˝umask.h
>

2 
	~<löux/öãºu±.h
>

3 
	~<löux/öô.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/mc146818πc.h
>

10 
	~<löux/ˇche.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/moduÀ.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mår.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/ùi.h
>

22 
	$deÁu…_£nd_IPI_mask_£quí˚_phys
(c⁄° 
˝umask
 *
mask
, 
ve˘‹
)

24 
quîy_˝u
;

25 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

33 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

34 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

35 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

40 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(c⁄° 
˝umask
 *
mask
,

41 
ve˘‹
)

43 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

44 
quîy_˝u
;

45 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

50 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

51 i‡(
quîy_˝u
 =
this_˝u
)

53 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

54 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
	$deÁu…_£nd_IPI_mask_£quí˚_logiˇl
(c⁄° 
˝umask
 *
mask
,

60 
ve˘‹
)

62 
Êags
;

63 
quîy_˝u
;

71 
	`loˇl_úq_ßve
(
Êags
);

72 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
)

73 
	`__deÁu…_£nd_IPI_de°_fõld
(

74 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

75 
≠ic
->
de°_logiˇl
);

76 
	`loˇl_úq_ª°‹e
(
Êags
);

77 
	}
}

79 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_logiˇl
(c⁄° 
˝umask
 *
mask
,

80 
ve˘‹
)

82 
Êags
;

83 
quîy_˝u
;

84 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

88 
	`loˇl_úq_ßve
(
Êags
);

89 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

90 i‡(
quîy_˝u
 =
this_˝u
)

92 
	`__deÁu…_£nd_IPI_de°_fõld
(

93 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

94 
≠ic
->
de°_logiˇl
);

96 
	`loˇl_úq_ª°‹e
(
Êags
);

97 
	}
}

99 #ifde‡
CONFIG_X86_32


104 
	$deÁu…_£nd_IPI_mask_logiˇl
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

106 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

107 
Êags
;

109 i‡(
	`WARN_ONCE
(!
mask
, "empty IPI mask"))

112 
	`loˇl_úq_ßve
(
Êags
);

113 
	`WARN_ON
(
mask
 & ~
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0]);

114 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

118 
	$deÁu…_£nd_IPI_Ælbut£lf
(
ve˘‹
)

124 i‡(!(
	`num_⁄löe_˝us
() > 1))

127 
	`__deÁu…_loˇl_£nd_IPI_Ælbut£lf
(
ve˘‹
);

128 
	}
}

130 
	$deÁu…_£nd_IPI_Æl
(
ve˘‹
)

132 
	`__deÁu…_loˇl_£nd_IPI_Æl
(
ve˘‹
);

133 
	}
}

135 
	$deÁu…_£nd_IPI_£lf
(
ve˘‹
)

137 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

138 
	}
}

141 
	$c⁄vît_≠icid_to_˝u
(
≠ic_id
)

143 
i
;

145 
	`f‹_óch_possibÀ_˝u
(
i
) {

146 i‡(
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
i
Ë=
≠ic_id
)

147  
i
;

150 
	}
}

152 
	$ß„_smp_¥o˚ss‹_id
()

154 
≠icid
, 
˝uid
;

156 i‡(!
˝u_has_≠ic
)

159 
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

160 i‡(
≠icid
 =
BAD_APICID
)

163 
˝uid
 = 
	`c⁄vît_≠icid_to_˝u
(
≠icid
);

165  
˝uid
 >= 0 ? cpuid : 0;

166 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/≠ic.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/sysdev.h
>

23 
	~<löux/sys˘l.h
>

24 
	~<löux/≥r˝u.h
>

25 
	~<löux/k¥obes.h
>

26 
	~<löux/˝umask.h
>

27 
	~<löux/kî√l_°©.h
>

28 
	~<löux/kdebug.h
>

29 
	~<löux/smp.h
>

31 
	~<asm/i8259.h
>

32 
	~<asm/io_≠ic.h
>

33 
	~<asm/¥Ÿo.h
>

34 
	~<asm/timî.h
>

36 
	~<asm/m˚.h
>

38 
	~<asm/mach_å≠s.h
>

40 
	gunknown_nmi_∑nic
;

41 
	gnmi_w©chdog_íabÀd
;

44 
	$DECLARE_BITMAP
(
backåa˚_mask
, 
NR_CPUS
Ë
__ªad_mo°ly
;

52 
©omic_t
 
nmi_a˘ive
 = 
	`ATOMIC_INIT
(0);

53 
	`EXPORT_SYMBOL
(
nmi_a˘ive
);

55 
nmi_w©chdog
 = 
NMI_NONE
;

56 
	`EXPORT_SYMBOL
(
nmi_w©chdog
);

58 
∑nic_⁄_timeout
;

60 
nmi_hz
 = 
HZ
;

61 
	`DEFINE_PER_CPU
(, 
wd_íabÀd
);

62 
ídÊag
 
__öôd©a
;

64 
ölöe
 
	$gë_nmi_cou¡
(
˝u
)

66  
	`≥r_˝u
(
úq_°©
, 
˝u
).
__nmi_cou¡
;

67 
	}
}

69 
ölöe
 
	$m˚_ö_¥ogªss
()

71 #i‡
	`deföed
(
CONFIG_X86_MCE
)

72  
	`©omic_ªad
(&
m˚_íåy
) > 0;

75 
	}
}

81 
ölöe
 
	$gë_timî_úqs
(
˝u
)

83  
	`≥r_˝u
(
úq_°©
, 
˝u
).
≠ic_timî_úqs
 +

84 
	`≥r_˝u
(
úq_°©
, 
˝u
).
úq0_úqs
;

85 
	}
}

87 #ifde‡
CONFIG_SMP


93 
__öô
 
	$nmi_˝u_busy
(*
d©a
)

95 
	`loˇl_úq_íabÀ_ö_h¨dúq
();

104 
ídÊag
 == 0)

105 
	`mb
();

106 
	}
}

109 
	$ªp‹t_brokí_nmi
(
˝u
, *
¥ev_nmi_cou¡
)

111 
	`¥ötk
(
KERN_CONT
 "\n");

113 
	`¥ötk
(
KERN_WARNING


115 
˝u
, 
¥ev_nmi_cou¡
[˝u], 
	`gë_nmi_cou¡
(cpu));

117 
	`¥ötk
(
KERN_WARNING


119 
	`¥ötk
(
KERN_WARNING


122 
	`≥r_˝u
(
wd_íabÀd
, 
˝u
) = 0;

123 
	`©omic_dec
(&
nmi_a˘ive
);

124 
	}
}

126 
	$__a˝i_nmi_dißbÀ
(*
__unu£d
)

128 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

129 
	}
}

131 
__öô
 
	$check_nmi_w©chdog
()

133 *
¥ev_nmi_cou¡
;

134 
˝u
;

136 i‡(!
	`nmi_w©chdog_a˘ive
(Ë|| !
	`©omic_ªad
(&
nmi_a˘ive
))

139 
¥ev_nmi_cou¡
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

140 i‡(!
¥ev_nmi_cou¡
)

141 
îr‹
;

143 
	`¥ötk
(
KERN_INFO
 "Testing NMI watchdog ... ");

145 #ifde‡
CONFIG_SMP


146 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

147 
	`smp_ˇŒ_fun˘i⁄
(
nmi_˝u_busy
, (*)&
ídÊag
, 0);

150 
	`f‹_óch_possibÀ_˝u
(
˝u
)

151 
¥ev_nmi_cou¡
[
˝u
] = 
	`gë_nmi_cou¡
(cpu);

152 
	`loˇl_úq_íabÀ
();

153 
	`mdñay
((20 * 1000Ë/ 
nmi_hz
);

155 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

156 i‡(!
	`≥r_˝u
(
wd_íabÀd
, 
˝u
))

158 i‡(
	`gë_nmi_cou¡
(
˝u
Ë- 
¥ev_nmi_cou¡
[cpu] <= 5)

159 
	`ªp‹t_brokí_nmi
(
˝u
, 
¥ev_nmi_cou¡
);

161 
ídÊag
 = 1;

162 i‡(!
	`©omic_ªad
(&
nmi_a˘ive
)) {

163 
	`k‰ì
(
¥ev_nmi_cou¡
);

164 
	`©omic_£t
(&
nmi_a˘ive
, -1);

165 
îr‹
;

167 
	`¥ötk
("OK.\n");

173 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

174 
nmi_hz
 = 
	`œpic_adju°_nmi_hz
(1);

176 
	`k‰ì
(
¥ev_nmi_cou¡
);

178 
îr‹
:

179 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

180 i‡(!
timî_through_8259
)

181 
Àgacy_pic
->
chù
->
	`mask
(0);

182 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

185 #ifde‡
CONFIG_X86_32


186 
timî_ack
 = 0;

189 
	}
}

191 
__öô
 
	$£tup_nmi_w©chdog
(*
°r
)

193 
nmi
;

195 i‡(!
	`°∫cmp
(
°r
, "panic", 5)) {

196 
∑nic_⁄_timeout
 = 1;

197 
°r
 = 
	`°rchr
(str, ',');

198 i‡(!
°r
)

200 ++
°r
;

203 i‡(!
	`°∫cmp
(
°r
, "lapic", 5))

204 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

205 i‡(!
	`°∫cmp
(
°r
, "ioapic", 6))

206 
nmi_w©chdog
 = 
NMI_IO_APIC
;

208 
	`gë_›ti⁄
(&
°r
, &
nmi
);

209 i‡(
nmi
 >
NMI_INVALID
)

211 
nmi_w©chdog
 = 
nmi
;

215 
	}
}

216 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

221 #ifde‡
CONFIG_PM


223 
	gnmi_pm_a˘ive
;

225 
	$œpic_nmi_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

228 
nmi_pm_a˘ive
 = 
	`©omic_ªad
(&
nmi_a˘ive
);

229 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

230 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

232 
	}
}

234 
	$œpic_nmi_ªsume
(
sys_devi˚
 *
dev
)

237 i‡(
nmi_pm_a˘ive
 > 0) {

238 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

239 
	`touch_nmi_w©chdog
();

242 
	}
}

244 
sysdev_˛ass
 
	gnmi_sys˛ass
 = {

245 .
«me
 = "lapic_nmi",

246 .
	gªsume
 = 
œpic_nmi_ªsume
,

247 .
	gsu•íd
 = 
œpic_nmi_su•íd
,

250 
sys_devi˚
 
	gdevi˚_œpic_nmi
 = {

251 .
id
 = 0,

252 .
	g˛s
 = &
nmi_sys˛ass
,

255 
__öô
 
	$öô_œpic_nmi_sysfs
()

257 
îr‹
;

263 i‡(
nmi_w©chdog
 !
NMI_LOCAL_APIC
)

266 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) < 0)

269 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
nmi_sys˛ass
);

270 i‡(!
îr‹
)

271 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic_nmi
);

272  
îr‹
;

273 
	}
}

276 
œã_öôˇŒ
(
öô_œpic_nmi_sysfs
);

280 
	$__a˝i_nmi_íabÀ
(*
__unu£d
)

282 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
);

283 
	}
}

288 
	$a˝i_nmi_íabÀ
()

290 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

291 
	`⁄_óch_˝u
(
__a˝i_nmi_íabÀ
, 
NULL
, 1);

292 
	}
}

297 
	$a˝i_nmi_dißbÀ
()

299 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

300 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

301 
	}
}

307 
	$˝u_nmi_£t_wd_íabÀd
()

309 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

310 
	}
}

312 
	$£tup_≠ic_nmi_w©chdog
(*
unu£d
)

314 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
))

319 i‡(
	`smp_¥o˚ss‹_id
(Ë!0 && 
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

322 
nmi_w©chdog
) {

323 
NMI_LOCAL_APIC
:

324 i‡(
	`œpic_w©chdog_öô
(
nmi_hz
) < 0) {

325 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

329 
NMI_IO_APIC
:

330 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

331 
	`©omic_öc
(&
nmi_a˘ive
);

333 
	}
}

335 
	$°›_≠ic_nmi_w©chdog
(*
unu£d
)

338 i‡(!
	`nmi_w©chdog_a˘ive
())

340 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
) == 0)

342 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

343 
	`œpic_w©chdog_°›
();

345 
	`__a˝i_nmi_dißbÀ
(
NULL
);

346 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

347 
	`©omic_dec
(&
nmi_a˘ive
);

348 
	}
}

364 
DEFINE_PER_CPU
(, 
œ°_úq_sum
);

365 
DEFINE_PER_CPU
(, 
Æît_cou¡î
);

366 
DEFINE_PER_CPU
(, 
nmi_touch
);

368 
	$touch_nmi_w©chdog
()

370 i‡(
	`nmi_w©chdog_a˘ive
()) {

371 
˝u
;

378 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

379 i‡(
	`≥r_˝u
(
nmi_touch
, 
˝u
) != 1)

380 
	`≥r_˝u
(
nmi_touch
, 
˝u
) = 1;

387 
	`touch_so·lockup_w©chdog
();

388 
	}
}

389 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

391 
nŸø˚
 
__k¥obes
 

392 
	$nmi_w©chdog_tick
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

399 
sum
;

400 
touched
 = 0;

401 
˝u
 = 
	`smp_¥o˚ss‹_id
();

402 
rc
 = 0;

405 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

406 =
NOTIFY_STOP
) {

407 
rc
 = 1;

408 
touched
 = 1;

411 
sum
 = 
	`gë_timî_úqs
(
˝u
);

413 i‡(
	`__gë_˝u_v¨
(
nmi_touch
)) {

414 
	`__gë_˝u_v¨
(
nmi_touch
) = 0;

415 
touched
 = 1;

419 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
))) {

420 
	`DEFINE_RAW_SPINLOCK
(
lock
);

422 
	`øw_•ö_lock
(&
lock
);

423 
	`¥ötk
(
KERN_WARNING
 "NMI backåa˚ f‹ cpu %d\n", 
˝u
);

424 
	`show_ªgs
(
ªgs
);

425 
	`dump_°ack
();

426 
	`øw_•ö_u∆ock
(&
lock
);

427 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
));

429 
rc
 = 1;

433 i‡(
	`m˚_ö_¥ogªss
())

434 
touched
 = 1;

437 i‡(!
touched
 && 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë=
sum
) {

442 
	`__this_˝u_öc
(
Æît_cou¡î
);

443 i‡(
	`__this_˝u_ªad
(
Æît_cou¡î
Ë=5 * 
nmi_hz
)

447 
	`dõ_nmi
("BUG: NMI Watchdog detected LOCKUP",

448 
ªgs
, 
∑nic_⁄_timeout
);

450 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë
sum
;

451 
	`__this_˝u_wrôe
(
Æît_cou¡î
, 0);

455 i‡(!
	`__gë_˝u_v¨
(
wd_íabÀd
))

456  
rc
;

457 
nmi_w©chdog
) {

458 
NMI_LOCAL_APIC
:

459 
rc
 |
	`œpic_wd_evít
(
nmi_hz
);

461 
NMI_IO_APIC
:

467 
rc
 = 1;

470  
rc
;

471 
	}
}

473 #ifde‡
CONFIG_SYSCTL


475 
	$íabÀ_iﬂpic_nmi_w©chdog_sögÀ
(*
unu£d
)

477 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

478 
	`©omic_öc
(&
nmi_a˘ive
);

479 
	`__a˝i_nmi_íabÀ
(
NULL
);

480 
	}
}

482 
	$íabÀ_iﬂpic_nmi_w©chdog
()

484 
	`⁄_óch_˝u
(
íabÀ_iﬂpic_nmi_w©chdog_sögÀ
, 
NULL
, 1);

485 
	`touch_nmi_w©chdog
();

486 
	}
}

488 
	$dißbÀ_iﬂpic_nmi_w©chdog
()

490 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

491 
	}
}

493 
__öô
 
	$£tup_unknown_nmi_∑nic
(*
°r
)

495 
unknown_nmi_∑nic
 = 1;

497 
	}
}

498 
__£tup
("unknown_nmi_∑nic", 
£tup_unknown_nmi_∑nic
);

500 
	$unknown_nmi_∑nic_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

502 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

503 
buf
[64];

505 
	`•rötf
(
buf
, "NMIÑe˚ived f‹ unknow¿ªas⁄ %02x\n", 
ªas⁄
);

506 
	`dõ_nmi
(
buf
, 
ªgs
, 1);

508 
	}
}

513 
	$¥oc_nmi_íabÀd
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

514 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

516 
ﬁd_°©e
;

518 
nmi_w©chdog_íabÀd
 = (
	`©omic_ªad
(&
nmi_a˘ive
) > 0) ? 1 : 0;

519 
ﬁd_°©e
 = 
nmi_w©chdog_íabÀd
;

520 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
buf„r
, 
Àngth
, 
µos
);

521 i‡(!!
ﬁd_°©e
 =!!
nmi_w©chdog_íabÀd
)

524 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë< 0 || !
	`nmi_w©chdog_a˘ive
()) {

525 
	`¥ötk
(
KERN_WARNING


527  -
EIO
;

530 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
) {

531 i‡(
nmi_w©chdog_íabÀd
)

532 
	`íabÀ_œpic_nmi_w©chdog
();

534 
	`dißbÀ_œpic_nmi_w©chdog
();

535 } i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

536 i‡(
nmi_w©chdog_íabÀd
)

537 
	`íabÀ_iﬂpic_nmi_w©chdog
();

539 
	`dißbÀ_iﬂpic_nmi_w©chdog
();

541 
	`¥ötk
(
KERN_WARNING


543  -
EIO
;

546 
	}
}

550 
	$do_nmi_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

552 #ifde‡
CONFIG_SYSCTL


553 i‡(
unknown_nmi_∑nic
)

554  
	`unknown_nmi_∑nic_ˇŒback
(
ªgs
, 
˝u
);

557 
	}
}

559 
	$¨ch_åiggî_Æl_˝u_backåa˚
()

561 
i
;

563 
	`˝umask_c›y
(
	`to_˝umask
(
backåa˚_mask
), 
˝u_⁄löe_mask
);

565 
	`¥ötk
(
KERN_INFO
 "sending NMIÅoáll CPUs:\n");

566 
≠ic
->
	`£nd_IPI_Æl
(
NMI_VECTOR
);

569 
i
 = 0; i < 10 * 1000; i++) {

570 i‡(
	`˝umask_em±y
(
	`to_˝umask
(
backåa˚_mask
)))

572 
	`mdñay
(1);

574 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<löux/thªads.h
>

12 
	~<löux/˝umask.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/dm¨.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/ùi.h
>

24 
	~<asm/£tup.h
>

26 
≠ic
 
≠ic_Ê©
;

27 
≠ic
 
≠ic_physÊ©
;

28 
≠ic
 
≠ic_x2xpic_uv_x
;

29 
≠ic
 
≠ic_x2≠ic_phys
;

30 
≠ic
 
≠ic_x2≠ic_˛u°î
;

32 
≠ic
 
__ªad_mo°ly
 *
	g≠ic
 = &
≠ic_Ê©
;

33 
EXPORT_SYMBOL_GPL
(
≠ic
);

35 
≠ic
 *
	g≠ic_¥obe
[] 
	g__öôd©a
 = {

36 #ifde‡
CONFIG_X86_UV


37 &
≠ic_x2≠ic_uv_x
,

39 #ifde‡
CONFIG_X86_X2APIC


40 &
≠ic_x2≠ic_phys
,

41 &
≠ic_x2≠ic_˛u°î
,

43 &
≠ic_physÊ©
,

44 
NULL
,

47 
	$≠icid_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

49  
	`h¨d_smp_¥o˚ss‹_id
(Ë>> 
ödex_msb
;

50 
	}
}

55 
__öô
 
	$deÁu…_£tup_≠ic_routög
()

57 #ifde‡
CONFIG_X86_X2APIC


58 i‡(
x2≠ic_mode


59 #ifde‡
CONFIG_X86_UV


60 && 
≠ic
 !&
≠ic_x2≠ic_uv_x


63 i‡(
x2≠ic_phys
)

64 
≠ic
 = &
≠ic_x2≠ic_phys
;

66 
≠ic
 = &
≠ic_x2≠ic_˛u°î
;

70 i‡(
≠ic
 =&
≠ic_Ê©
 && 
	`num_possibÀ_˝us
() > 8)

71 
≠ic
 = &
≠ic_physÊ©
;

73 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

75 i‡(
	`is_vsmp_box
()) {

77 
≠ic
->
phys_pkg_id
 = 
≠icid_phys_pkg_id
;

84 i‡(
öå_ªm≠pög_íabÀd
)

85 
	`íabÀ_drhd_Áu…_h™dlög
();

86 
	}
}

90 
	$≠ic_£nd_IPI_£lf
(
ve˘‹
)

92 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

93 
	}
}

95 
__öô
 
	$deÁu…_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

97 
i
;

99 
i
 = 0; 
≠ic_¥obe
[i]; ++i) {

100 i‡(
≠ic_¥obe
[
i
]->
	`a˝i_madt_€m_check
(
€m_id
, 
€m_èbÀ_id
)) {

101 
≠ic
 = 
≠ic_¥obe
[
i
];

102 
	`¥ötk
(
KERN_INFO
 "Setting APICÑoutingÅo %s.\n",

103 
≠ic
->
«me
);

108 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<löux/öô.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/audô.h
>

4 
	~<asm/uni°d.h
>

6 
	gdú_˛ass
[] = {

7 
	~<asm-gíîic/audô_dú_wrôe.h
>

11 
	gªad_˛ass
[] = {

12 
	~<asm-gíîic/audô_ªad.h
>

16 
	gwrôe_˛ass
[] = {

17 
	~<asm-gíîic/audô_wrôe.h
>

21 
	gch©å_˛ass
[] = {

22 
	~<asm-gíîic/audô_ch™ge_©å.h
>

26 
	gsig«l_˛ass
[] = {

27 
	~<asm-gíîic/audô_sig«l.h
>

31 
	$audô_˛assify_¨ch
(
¨ch
)

33 #ifde‡
CONFIG_IA32_EMULATION


34 i‡(
¨ch
 =
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$audô_˛assify_sysˇŒ
(
abi
, 
sysˇŒ
)

42 #ifde‡
CONFIG_IA32_EMULATION


43 
	`ü32_˛assify_sysˇŒ
();

44 i‡(
abi
 =
AUDIT_ARCH_I386
)

45  
	`ü32_˛assify_sysˇŒ
(
sysˇŒ
);

47 
sysˇŒ
) {

48 
__NR_›í
:

50 
__NR_›í©
:

52 
__NR_execve
:

57 
	}
}

59 
__öô
 
	$audô_˛as£s_öô
()

61 #ifde‡
CONFIG_IA32_EMULATION


62 
__u32
 
ü32_dú_˛ass
[];

63 
__u32
 
ü32_wrôe_˛ass
[];

64 
__u32
 
ü32_ªad_˛ass
[];

65 
__u32
 
ü32_ch©å_˛ass
[];

66 
__u32
 
ü32_sig«l_˛ass
[];

67 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE_32
, 
ü32_wrôe_˛ass
);

68 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ_32
, 
ü32_ªad_˛ass
);

69 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE_32
, 
ü32_dú_˛ass
);

70 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR_32
, 
ü32_ch©å_˛ass
);

71 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL_32
, 
ü32_sig«l_˛ass
);

73 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE
, 
wrôe_˛ass
);

74 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ
, 
ªad_˛ass
);

75 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE
, 
dú_˛ass
);

76 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR
, 
ch©å_˛ass
);

77 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL
, 
sig«l_˛ass
);

79 
	}
}

81 
__öôˇŒ
(
audô_˛as£s_öô
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<löux/ty≥s.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/•ölock.h
>

9 
	~<löux/a˝i.h
>

10 
	~<asm/io.h
>

12 
	~<löux/mc146818πc.h
>

14 
	#SBF_RESERVED
 (0x78)

	)

15 
	#SBF_PNPOS
 (1<<0)

	)

16 
	#SBF_BOOTING
 (1<<1)

	)

17 
	#SBF_DIAG
 (1<<2)

	)

18 
	#SBF_PARITY
 (1<<7)

	)

20 
sbf_p‹t
 
	g__öôd©a
 = -1;

22 
__öô
 
	$∑rôy
(
u8
 
v
)

24 
x
 = 0;

25 
i
;

27 
i
 = 0; i < 8; i++) {

28 
x
 ^(
v
 & 1);

29 
v
 >>= 1;

32  
x
;

33 
	}
}

35 
__öô
 
	$sbf_wrôe
(
u8
 
v
)

37 
Êags
;

39 i‡(
sbf_p‹t
 != -1) {

40 
v
 &~
SBF_PARITY
;

41 i‡(!
	`∑rôy
(
v
))

42 
v
 |
SBF_PARITY
;

44 
	`¥ötk
(
KERN_INFO
 "Simple Boot Flagát 0x%x setÅo 0x%x\n",

45 
sbf_p‹t
, 
v
);

47 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

48 
	`CMOS_WRITE
(
v
, 
sbf_p‹t
);

49 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

51 
	}
}

53 
u8
 
__öô
 
	$sbf_ªad
()

55 
Êags
;

56 
u8
 
v
;

58 i‡(
sbf_p‹t
 == -1)

61 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

62 
v
 = 
	`CMOS_READ
(
sbf_p‹t
);

63 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

65  
v
;

66 
	}
}

68 
__öô
 
	$sbf_vÆue_vÆid
(
u8
 
v
)

70 i‡(
v
 & 
SBF_RESERVED
)

72 i‡(!
	`∑rôy
(
v
))

76 
	}
}

78 
__öô
 
	$sbf_öô
()

80 
u8
 
v
;

82 i‡(
sbf_p‹t
 == -1)

85 
v
 = 
	`sbf_ªad
();

86 i‡(!
	`sbf_vÆue_vÆid
(
v
)) {

87 
	`¥ötk
(
KERN_WARNING
 "Simple Boot Flag value 0x%xÑead from "

88 "CMOS RAM wa†övÆid\n", 
v
);

91 
v
 &~
SBF_RESERVED
;

92 
v
 &~
SBF_BOOTING
;

93 
v
 &~
SBF_DIAG
;

94 #i‡
	`deföed
(
CONFIG_ISAPNP
)

95 
v
 |
SBF_PNPOS
;

97 
	`sbf_wrôe
(
v
);

100 
	}
}

101 
moduÀ_öô
(
sbf_öô
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/kthªad.h
>

4 
	~<löux/w‹kqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/¥Ÿo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__ªad_mo°ly
 
	gmem‹y_c‹ru±i⁄_check
 = -1;

18 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_size
 = 64*1024;

19 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_≥riod
 = 60;

21 
e820íåy
 
	gsˇn_¨ós
[
MAX_SCAN_AREAS
];

22 
	gnum_sˇn_¨ós
;

25 
__öô
 
	$£t_c‹ru±i⁄_check
(*
¨g
)

27 *
íd
;

29 
mem‹y_c‹ru±i⁄_check
 = 
	`sim∂e_°πﬁ
(
¨g
, &
íd
, 10);

31  (*
íd
 =0Ë? 0 : -
EINVAL
;

32 
	}
}

33 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check", 
£t_c‹ru±i⁄_check
);

35 
__öô
 
	$£t_c‹ru±i⁄_check_≥riod
(*
¨g
)

37 *
íd
;

39 
c‹ru±i⁄_check_≥riod
 = 
	`sim∂e_°πoul
(
¨g
, &
íd
, 10);

41  (*
íd
 =0Ë? 0 : -
EINVAL
;

42 
	}
}

43 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_≥riod", 
£t_c‹ru±i⁄_check_≥riod
);

45 
__öô
 
	$£t_c‹ru±i⁄_check_size
(*
¨g
)

47 *
íd
;

48 
size
;

50 
size
 = 
	`mem∑r£
(
¨g
, &
íd
);

52 i‡(*
íd
 == '\0')

53 
c‹ru±i⁄_check_size
 = 
size
;

55  (
size
 =
c‹ru±i⁄_check_size
Ë? 0 : -
EINVAL
;

56 
	}
}

57 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_size", 
£t_c‹ru±i⁄_check_size
);

60 
__öô
 
	$£tup_bios_c‹ru±i⁄_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 i‡(
mem‹y_c‹ru±i⁄_check
 == -1) {

65 
mem‹y_c‹ru±i⁄_check
 =

66 #ifde‡
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 i‡(
c‹ru±i⁄_check_size
 == 0)

75 
mem‹y_c‹ru±i⁄_check
 = 0;

77 i‡(!
mem‹y_c‹ru±i⁄_check
)

80 
c‹ru±i⁄_check_size
 = 
	`round_up
(c‹ru±i⁄_check_size, 
PAGE_SIZE
);

82 
addr
 < 
c‹ru±i⁄_check_size
 && 
num_sˇn_¨ós
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`föd_e820_¨ó_size
◊ddr, &
size
, 
PAGE_SIZE
);

86 i‡(!(
addr
 + 1))

89 i‡(
addr
 >
c‹ru±i⁄_check_size
)

92 i‡((
addr
 + 
size
Ë> 
c‹ru±i⁄_check_size
)

93 
size
 = 
c‹ru±i⁄_check_size
 - 
addr
;

95 
	`e820_upd©e_ønge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sˇn_¨ós
[
num_sˇn_¨ós
].
addr
 =áddr;

97 
sˇn_¨ós
[
num_sˇn_¨ós
].
size
 = size;

98 
num_sˇn_¨ós
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +
size
;

106 
	`¥ötk
(
KERN_INFO
 "Scanning %dáreas forÜow memory corruption\n",

107 
num_sˇn_¨ós
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_f‹_bios_c‹ru±i⁄
()

114 
i
;

115 
c‹ru±i⁄
 = 0;

117 i‡(!
mem‹y_c‹ru±i⁄_check
)

120 
i
 = 0; i < 
num_sˇn_¨ós
; i++) {

121 *
addr
 = 
	`__va
(
sˇn_¨ós
[
i
].addr);

122 
size
 = 
sˇn_¨ós
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 i‡(!*
addr
)

127 
	`¥ötk
(
KERN_ERR
 "CorruptedÜow memoryát %p (%lxÖhys) = %08lx\n",

128 
addr
, 
	`__∑
(addr), *addr);

129 
c‹ru±i⁄
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
c‹ru±i⁄
, 
KERN_ERR
 "Memory corruption detected inÜow memory\n");

135 
	}
}

137 
check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_w‹k
, 
check_c‹ru±i⁄
);

140 
	$check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
)

142 
	`check_f‹_bios_c‹ru±i⁄
();

143 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
,

144 
	`round_jiffõs_ªœtive
(
c‹ru±i⁄_check_≥riod
*
HZ
));

145 
	}
}

147 
	$°¨t_≥riodic_check_f‹_c‹ru±i⁄
()

149 i‡(!
mem‹y_c‹ru±i⁄_check
 || 
c‹ru±i⁄_check_≥riod
 == 0)

152 
	`¥ötk
(
KERN_INFO
 "Scanning forÜow memory corruptionÉvery %d seconds\n",

153 
c‹ru±i⁄_check_≥riod
);

156 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
, 0);

158 
	}
}

160 
moduÀ_öô
(
°¨t_≥riodic_check_f‹_c‹ru±i⁄
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<löux/˝u.h
>

7 
	~<asm/∑t.h
>

8 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/≠ic.h
>

12 
	s˝uid_bô
 {

13 
u16
 
	m„©uª
;

14 
u8
 
	mªg
;

15 
u8
 
	mbô
;

16 
u32
 
	mÀvñ
;

19 
	e˝uid_ªgs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__˝uöô
 
	$öô_sˇâîed_˝uid_„©uªs
(
˝uöfo_x86
 *
c
)

28 
u32
 
max_Àvñ
;

29 
u32
 
ªgs
[4];

30 c⁄° 
˝uid_bô
 *
cb
;

32 c⁄° 
˝uid_bô
 
__˝uöôc⁄°
 
˝uid_bôs
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

35 { 
X86_FEATURE_NPT
, 
CR_EDX
, 0, 0x8000000a },

36 { 
X86_FEATURE_LBRV
, 
CR_EDX
, 1, 0x8000000a },

37 { 
X86_FEATURE_SVML
, 
CR_EDX
, 2, 0x8000000a },

38 { 
X86_FEATURE_NRIPS
, 
CR_EDX
, 3, 0x8000000a },

42 
cb
 = 
˝uid_bôs
; cb->
„©uª
; cb++) {

45 
max_Àvñ
 = 
	`˝uid_óx
(
cb
->
Àvñ
 & 0xffff0000);

46 i‡(
max_Àvñ
 < 
cb
->
Àvñ
 ||

47 
max_Àvñ
 > (
cb
->
Àvñ
 | 0xffff))

50 
	`˝uid
(
cb
->
Àvñ
, &
ªgs
[
CR_EAX
], &ªgs[
CR_EBX
],

51 &
ªgs
[
CR_ECX
], &ªgs[
CR_EDX
]);

53 i‡(
ªgs
[
cb
->
ªg
] & (1 << cb->
bô
))

54 
	`£t_˝u_ˇp
(
c
, 
cb
->
„©uª
);

56 
	}
}

59 
	#SMT_LEVEL
 0

	)

62 
	#INVALID_TYPE
 0

	)

63 
	#SMT_TYPE
 1

	)

64 
	#CORE_TYPE
 2

	)

66 
	#LEAFB_SUBTYPE
(
ecx
Ë((”cxË>> 8Ë& 0xff)

	)

67 
	#BITS_SHIFT_NEXT_LEVEL
(
óx
Ë(”axË& 0x1f)

	)

68 
	#LEVEL_MAX_SIBLINGS
(
ebx
Ë(”bxË& 0xffff)

	)

75 
__˝uöô
 
	$dëe˘_exãnded_t›ﬁogy
(
˝uöfo_x86
 *
c
)

77 #ifde‡
CONFIG_SMP


78 
óx
, 
ebx
, 
ecx
, 
edx
, 
sub_ödex
;

79 
ht_mask_width
, 
c‹e_∂us_mask_width
;

80 
c‹e_£À˘_mask
, 
c‹e_Àvñ_siblögs
;

81 
boﬁ
 
¥öãd
;

83 i‡(
c
->
˝uid_Àvñ
 < 0xb)

86 
	`˝uid_cou¡
(0xb, 
SMT_LEVEL
, &
óx
, &
ebx
, &
ecx
, &
edx
);

91 i‡(
ebx
 =0 || (
	`LEAFB_SUBTYPE
(
ecx
Ë!
SMT_TYPE
))

94 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

99 
c
->
öôül_≠icid
 = 
edx
;

104 
c‹e_Àvñ_siblögs
 = 
smp_num_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

105 
c‹e_∂us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

107 
sub_ödex
 = 1;

109 
	`˝uid_cou¡
(0xb, 
sub_ödex
, &
óx
, &
ebx
, &
ecx
, &
edx
);

114 i‡(
	`LEAFB_SUBTYPE
(
ecx
Ë=
CORE_TYPE
) {

115 
c‹e_Àvñ_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

116 
c‹e_∂us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

120 
sub_ödex
++;

121 } 
	`LEAFB_SUBTYPE
(
ecx
Ë!
INVALID_TYPE
);

123 
c‹e_£À˘_mask
 = (~(-1 << 
c‹e_∂us_mask_width
)Ë>> 
ht_mask_width
;

125 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ht_mask_width
)

126 & 
c‹e_£À˘_mask
;

127 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
c‹e_∂us_mask_width
);

131 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

133 
c
->
x86_max_c‹es
 = (
c‹e_Àvñ_siblögs
 / 
smp_num_siblögs
);

135 i‡(!
¥öãd
) {

136 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

137 
c
->
phys_¥oc_id
);

138 i‡(
c
->
x86_max_c‹es
 > 1)

139 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

140 
c
->
˝u_c‹e_id
);

141 
¥öãd
 = 1;

145 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<löux/öô.h
>

2 
	~<löux/bô›s.h
>

3 
	~<löux/mm.h
>

5 
	~<löux/io.h
>

6 
	~<asm/¥o˚ss‹.h
>

7 
	~<asm/≠ic.h
>

8 
	~<asm/˝u.h
>

9 
	~<asm/pci-dúe˘.h
>

11 #ifde‡
CONFIG_X86_64


12 
	~<asm/numa_64.h
>

13 
	~<asm/mmc⁄fig.h
>

14 
	~<asm/ˇcheÊush.h
>

17 
	~"˝u.h
"

19 #ifde‡
CONFIG_X86_32


33 
vide
();

34 
__asm__
(".align 4\nvide:Ñet");

36 
__˝uöô
 
	$öô_amd_k5
(
˝uöfo_x86
 *
c
)

44 
	#CBAR
 (0xfffcË

	)

45 
	#CBAR_ENB
 (0x80000000)

	)

46 
	#CBAR_KEY
 (0X000000CB)

	)

47 i‡(
c
->
x86_modñ
 == 9 || c->x86_model == 10) {

48 i‡(
	`öl
(
CBAR
Ë& 
CBAR_ENB
)

49 
	`oué
(0 | 
CBAR_KEY
, 
CBAR
);

51 
	}
}

54 
__˝uöô
 
	$öô_amd_k6
(
˝uöfo_x86
 *
c
)

56 
u32
 
l
, 
h
;

57 
mbyãs
 = 
num_phy•ages
 >> (20-
PAGE_SHIFT
);

59 i‡(
c
->
x86_modñ
 < 6) {

61 i‡(
c
->
x86_modñ
 == 0) {

62 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_APIC
);

63 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PGE
);

68 i‡(
c
->
x86_modñ
 =6 && c->
x86_mask
 == 1) {

69 c⁄° 
K6_BUG_LOOP
 = 1000000;

70 
n
;

71 (*
f_vide
)();

72 
d
, 
d2
;

74 
	`¥ötk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

81 
n
 = 
K6_BUG_LOOP
;

82 
f_vide
 = 
vide
;

83 
	`rdts˛
(
d
);

84 
n
--)

85 
	`f_vide
();

86 
	`rdts˛
(
d2
);

87 
d
 = 
d2
-d;

89 i‡(
d
 > 20*
K6_BUG_LOOP
)

90 
	`¥ötk
(
KERN_CONT


93 
	`¥ötk
(
KERN_CONT
 "probably OK (after B9730xxxx).\n");

94 
	`¥ötk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

98 i‡(
c
->
x86_modñ
 < 8 ||

99 (
c
->
x86_modñ
 =8 && c->
x86_mask
 < 8)) {

101 i‡(
mbyãs
 > 508)

102 
mbyãs
 = 508;

104 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

105 i‡((
l
&0x0000FFFF) == 0) {

106 
Êags
;

107 
l
 = (1<<0)|((
mbyãs
/4)<<1);

108 
	`loˇl_úq_ßve
(
Êags
);

109 
	`wbövd
();

110 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

111 
	`loˇl_úq_ª°‹e
(
Êags
);

112 
	`¥ötk
(
KERN_INFO
 "Enabling old style K6 writeállocation for %d Mb\n",

113 
mbyãs
);

118 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 > 7) ||

119 
c
->
x86_modñ
 == 9 || c->x86_model == 13) {

122 i‡(
mbyãs
 > 4092)

123 
mbyãs
 = 4092;

125 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

126 i‡((
l
&0xFFFF0000) == 0) {

127 
Êags
;

128 
l
 = ((
mbyãs
>>2)<<22)|(1<<16);

129 
	`loˇl_úq_ßve
(
Êags
);

130 
	`wbövd
();

131 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

132 
	`loˇl_úq_ª°‹e
(
Êags
);

133 
	`¥ötk
(
KERN_INFO
 "EnablingÇew style K6 writeállocation for %d Mb\n",

134 
mbyãs
);

140 i‡(
c
->
x86_modñ
 == 10) {

145 
	}
}

147 
__˝uöô
 
	$amd_k7_smp_check
(
˝uöfo_x86
 *
c
)

149 #ifde‡
CONFIG_SMP


151 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

159 i‡((
c
->
x86_modñ
 =6Ë&& ((c->
x86_mask
 == 0) ||

160 (
c
->
x86_mask
 == 1)))

161 
vÆid_k7
;

164 i‡((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 == 0))

165 
vÆid_k7
;

174 i‡(((
c
->
x86_modñ
 =6Ë&& (c->
x86_mask
 >= 2)) ||

175 ((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 >= 1)) ||

176 (
c
->
x86_modñ
 > 7))

177 i‡(
˝u_has_mp
)

178 
vÆid_k7
;

186 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

188 i‡(!
	`ã°_èöt
(
TAINT_UNSAFE_SMP
))

189 
	`add_èöt
(
TAINT_UNSAFE_SMP
);

191 
vÆid_k7
:

194 
	}
}

196 
__˝uöô
 
	$öô_amd_k7
(
˝uöfo_x86
 *
c
)

198 
u32
 
l
, 
h
;

205 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 10) {

206 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XMM
)) {

207 
	`¥ötk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

208 
	`rdm§
(
MSR_K7_HWCR
, 
l
, 
h
);

209 
l
 &= ~0x00008000;

210 
	`wrm§
(
MSR_K7_HWCR
, 
l
, 
h
);

211 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XMM
);

220 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

221 
	`rdm§
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

222 i‡((
l
 & 0xfff00000) != 0x20000000) {

223 
	`¥ötk
(
KERN_INFO


225 
l
, ((l & 0x000fffff)|0x20000000));

226 
	`wrm§
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

230 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K7
);

232 
	`amd_k7_smp_check
(
c
);

233 
	}
}

236 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

237 
__˝uöô
 
	$√¨by_node
(
≠icid
)

239 
i
, 
node
;

241 
i
 = 
≠icid
 - 1; i >= 0; i--) {

242 
node
 = 
≠icid_to_node
[
i
];

243 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

244  
node
;

246 
i
 = 
≠icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

247 
node
 = 
≠icid_to_node
[
i
];

248 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

249  
node
;

251  
	`fú°_node
(
node_⁄löe_m≠
);

252 
	}
}

259 #ifde‡
CONFIG_X86_HT


260 
__˝uöô
 
	$amd_fixup_dcm
(
˝uöfo_x86
 *
c
)

262 
vÆue
;

263 
u32
 
nodes
, 
c‹es_≥r_node
;

264 
˝u
 = 
	`smp_¥o˚ss‹_id
();

266 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_NODEID_MSR
))

270 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
))

273 
	`rdm§l
(
MSR_FAM10H_NODE_ID
, 
vÆue
);

275 
nodes
 = ((
vÆue
 >> 3) & 7) + 1;

276 i‡(
nodes
 == 1)

279 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_AMD_DCM
);

280 
c‹es_≥r_node
 = 
c
->
x86_max_c‹es
 / 
nodes
;

283 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
vÆue
 & 7;

286 
c
->
˝u_c‹e_id
 = c->˝u_c‹e_id % 
c‹es_≥r_node
;

287 
	}
}

294 
__˝uöô
 
	$amd_dëe˘_cmp
(
˝uöfo_x86
 *
c
)

296 #ifde‡
CONFIG_X86_HT


297 
bôs
;

298 
˝u
 = 
	`smp_¥o˚ss‹_id
();

300 
bôs
 = 
c
->
x86_c‹eid_bôs
;

302 
c
->
˝u_c‹e_id
 = c->
öôül_≠icid
 & ((1 << 
bôs
)-1);

304 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
 >> 
bôs
;

306 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
c
->
phys_¥oc_id
;

308 i‡((
c
->
x86
 =0x10Ë&& (c->
x86_modñ
 == 9))

309 
	`amd_fixup_dcm
(
c
);

311 
	}
}

313 
	$amd_gë_nb_id
(
˝u
)

315 
id
 = 0;

316 #ifde‡
CONFIG_SMP


317 
id
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

319  
id
;

320 
	}
}

321 
EXPORT_SYMBOL_GPL
(
amd_gë_nb_id
);

323 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

325 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

326 
˝u
 = 
	`smp_¥o˚ss‹_id
();

327 
node
;

328 
≠icid
 = 
c
->apicid;

330 
node
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

332 i‡(
≠icid_to_node
[
≠icid
] !
NUMA_NO_NODE
)

333 
node
 = 
≠icid_to_node
[
≠icid
];

334 i‡(!
	`node_⁄löe
(
node
)) {

345 
ht_nodeid
 = 
c
->
öôül_≠icid
;

347 i‡(
ht_nodeid
 >= 0 &&

348 
≠icid_to_node
[
ht_nodeid
] !
NUMA_NO_NODE
)

349 
node
 = 
≠icid_to_node
[
ht_nodeid
];

351 i‡(!
	`node_⁄löe
(
node
))

352 
node
 = 
	`√¨by_node
(
≠icid
);

354 
	`numa_£t_node
(
˝u
, 
node
);

356 
	}
}

358 
__˝uöô
 
	$óæy_öô_amd_mc
(
˝uöfo_x86
 *
c
)

360 #ifde‡
CONFIG_X86_HT


361 
bôs
, 
ecx
;

364 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000008)

367 
ecx
 = 
	`˝uid_ecx
(0x80000008);

369 
c
->
x86_max_c‹es
 = (
ecx
 & 0xff) + 1;

372 
bôs
 = (
ecx
 >> 12) & 0xF;

375 i‡(
bôs
 == 0) {

376 (1 << 
bôs
Ë< 
c
->
x86_max_c‹es
)

377 
bôs
++;

380 
c
->
x86_c‹eid_bôs
 = 
bôs
;

382 
	}
}

384 
__˝uöô
 
	$óæy_öô_amd
(
˝uöfo_x86
 *
c
)

386 
	`óæy_öô_amd_mc
(
c
);

392 i‡(
c
->
x86_powî
 & (1 << 8)) {

393 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

394 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

397 #ifde‡
CONFIG_X86_64


398 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSCALL32
);

401 i‡(
c
->
x86
 == 5)

402 i‡(
c
->
x86_modñ
 == 13 || c->x86_model == 9 ||

403 (
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 8))

404 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K6_MTRR
);

406 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_PCI
)

408 i‡(
˝u_has_≠ic
 && 
c
->
x86
 >= 0xf) {

409 
vÆ
;

410 
vÆ
 = 
	`ªad_pci_c⁄fig
(0, 24, 0, 0x68);

411 i‡((
vÆ
 & ((1 << 17) | (1 << 18))) == ((1 << 17) | (1 << 18)))

412 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EXTD_APICID
);

415 
	}
}

417 
__˝uöô
 
	$öô_amd
(
˝uöfo_x86
 *
c
)

419 #ifde‡
CONFIG_SMP


420 
vÆue
;

429 i‡(
c
->
x86
 == 0xf) {

430 
	`rdm§l
(
MSR_K7_HWCR
, 
vÆue
);

431 
vÆue
 |= 1 << 6;

432 
	`wrm§l
(
MSR_K7_HWCR
, 
vÆue
);

436 
	`óæy_öô_amd
(
c
);

442 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

444 #ifde‡
CONFIG_X86_64


446 i‡(
c
->
x86
 == 0xf) {

447 
u32
 
Àvñ
;

449 
Àvñ
 = 
	`˝uid_óx
(1);

450 i‡((
Àvñ
 >= 0x0f48 &&Üevel < 0x0f50) ||Üevel >= 0x0f58)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

458 i‡(
c
->
x86_modñ
 < 0x14 && 
	`˝u_has
(c, 
X86_FEATURE_LAHF_LM
)) {

459 
u64
 
vÆ
;

461 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_LAHF_LM
);

462 i‡(!
	`rdm§l_amd_ß„
(0xc001100d, &
vÆ
)) {

463 
vÆ
 &= ~(1ULL << 32);

464 
	`wrm§l_amd_ß„
(0xc001100d, 
vÆ
);

469 i‡(
c
->
x86
 == 0x10 || c->x86 == 0x11)

470 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

473 
c
->
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

482 
c
->
x86
) {

484 
	`öô_amd_k5
(
c
);

487 
	`öô_amd_k6
(
c
);

490 
	`öô_amd_k7
(
c
);

495 i‡(
c
->
x86
 < 6)

496 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_MCE
);

500 i‡(
c
->
x86
 >= 6)

501 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

503 i‡(!
c
->
x86_modñ_id
[0]) {

504 
c
->
x86
) {

508 
	`°r˝y
(
c
->
x86_modñ_id
, "Hammer");

513 
	`˝u_dëe˘_ˇche_sizes
(
c
);

516 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

517 
	`amd_dëe˘_cmp
(
c
);

518 
	`§©_dëe˘_node
(
c
);

521 #ifde‡
CONFIG_X86_32


522 
	`dëe˘_ht
(
c
);

525 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000006) {

526 i‡((
c
->
x86
 >0x0fË&& (
	`˝uid_edx
(0x80000006) & 0xf000))

527 
num_ˇche_Àaves
 = 4;

529 
num_ˇche_Àaves
 = 3;

532 i‡(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

533 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K8
);

535 i‡(
˝u_has_xmm2
) {

537 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

540 #ifde‡
CONFIG_X86_64


541 i‡(
c
->
x86
 == 0x10) {

543 i‡(
c
 =&
boŸ_˝u_d©a
)

544 
	`check_íabÀ_amd_mmc⁄f_dmi
();

546 
	`Ám10h_check_íabÀ_mmcfg
();

549 i‡(
c
 =&
boŸ_˝u_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

550 
t£g
;

557 i‡(!
	`rdm§l_ß„
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

558 
	`¥ötk
(
KERN_DEBUG
 "t£g: %010Œx\n", 
t£g
);

559 i‡((
t£g
>>
PMD_SHIFT
) <

560 (
max_low_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

561 ((
t£g
>>
PMD_SHIFT
) <

562 (
max_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

563 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

564 
	`£t_mem‹y_4k
(()
	`__va
(
t£g
), 1);

568 
	}
}

570 #ifde‡
CONFIG_X86_32


571 
__˝uöô
 
	$amd_size_ˇche
(
˝uöfo_x86
 *
c
,

572 
size
)

575 i‡((
c
->
x86
 == 6)) {

577 i‡(
c
->
x86_modñ
 =3 && c->
x86_mask
 == 0)

578 
size
 = 64;

580 i‡(
c
->
x86_modñ
 == 4 &&

581 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

582 
size
 = 256;

584  
size
;

585 
	}
}

588 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gamd_˝u_dev
 = {

589 .
c_víd‹
 = "AMD",

590 .
	gc_idít
 = { "AuthenticAMD" },

591 #ifde‡
CONFIG_X86_32


592 .
	gc_modñs
 = {

593 { .
víd‹
 = 
X86_VENDOR_AMD
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

604 .
	gc_size_ˇche
 = 
amd_size_ˇche
,

606 .
	gc_óæy_öô
 = 
óæy_öô_amd
,

607 .
	gc_öô
 = 
öô_amd
,

608 .
	gc_x86_víd‹
 = 
X86_VENDOR_AMD
,

611 
˝u_dev_ªgi°î
(
amd_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

8 
	~<asm/Æã∫©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/mår.h
>

12 
	~<asm/ˇcheÊush.h
>

14 
__öô
 
	$check_bugs
()

16 
	`idítify_boŸ_˝u
();

17 #i‡!
	`deföed
(
CONFIG_SMP
)

18 
	`¥ötk
(
KERN_INFO
 "CPU: ");

19 
	`¥öt_˝u_öfo
(&
boŸ_˝u_d©a
);

21 
	`Æã∫©ive_ö°ru˘i⁄s
();

31 i‡(!
dúe˘_gb∑ges
)

32 
	`£t_mem‹y_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/˝u„©uª.h
>

3 c⁄° * c⁄° 
	gx86_ˇp_Êags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_EXTD_APICID
] = "extd_apicid",

63 [
X86_FEATURE_AMD_DCM
] = "amd_dcm",

64 [
X86_FEATURE_APERFMPERF
] = "aperfmperf",

65 [
X86_FEATURE_XMM3
] = "pni",

66 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

67 [
X86_FEATURE_DTES64
] = "dtes64",

68 [
X86_FEATURE_MWAIT
] = "monitor",

69 [
X86_FEATURE_DSCPL
] = "ds_cpl",

70 [
X86_FEATURE_VMX
] = "vmx",

71 [
X86_FEATURE_SMX
] = "smx",

72 [
X86_FEATURE_EST
] = "est",

73 [
X86_FEATURE_TM2
] = "tm2",

74 [
X86_FEATURE_SSSE3
] = "ssse3",

75 [
X86_FEATURE_CID
] = "cid",

76 [
X86_FEATURE_FMA
] = "fma",

77 [
X86_FEATURE_CX16
] = "cx16",

78 [
X86_FEATURE_XTPR
] = "xtpr",

79 [
X86_FEATURE_PDCM
] = "pdcm",

80 [
X86_FEATURE_DCA
] = "dca",

81 [
X86_FEATURE_XMM4_1
] = "sse4_1",

82 [
X86_FEATURE_XMM4_2
] = "sse4_2",

83 [
X86_FEATURE_X2APIC
] = "x2apic",

84 [
X86_FEATURE_MOVBE
] = "movbe",

85 [
X86_FEATURE_POPCNT
] = "popcnt",

86 [
X86_FEATURE_AES
] = "aes",

87 [
X86_FEATURE_XSAVE
] = "xsave",

88 [
X86_FEATURE_AVX
] = "avx",

89 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

90 [
X86_FEATURE_XSTORE
] = "rng",

91 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

92 [
X86_FEATURE_XCRYPT
] = "ace",

93 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

94 [
X86_FEATURE_ACE2
] = "ace2",

95 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

96 [
X86_FEATURE_PHE
] = "phe",

97 [
X86_FEATURE_PHE_EN
] = "phe_en",

98 [
X86_FEATURE_PMM
] = "pmm",

99 [
X86_FEATURE_PMM_EN
] = "pmm_en",

100 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

101 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

102 [
X86_FEATURE_SVM
] = "svm",

103 [
X86_FEATURE_EXTAPIC
] = "extapic",

104 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

105 [
X86_FEATURE_ABM
] = "abm",

106 [
X86_FEATURE_SSE4A
] = "sse4a",

107 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

108 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

109 [
X86_FEATURE_OSVW
] = "osvw",

110 [
X86_FEATURE_IBS
] = "ibs",

111 [
X86_FEATURE_SSE5
] = "sse5",

112 [
X86_FEATURE_SKINIT
] = "skinit",

113 [
X86_FEATURE_WDT
] = "wdt",

114 [
X86_FEATURE_NODEID_MSR
] = "nodeid_msr",

115 [
X86_FEATURE_IDA
] = "ida",

116 [
X86_FEATURE_ARAT
] = "arat",

117 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

118 [
X86_FEATURE_VNMI
] = "vnmi",

119 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

120 [
X86_FEATURE_EPT
] = "ept",

121 [
X86_FEATURE_VPID
] = "vpid",

122 [
X86_FEATURE_NPT
] = "npt",

123 [
X86_FEATURE_LBRV
] = "lbrv",

124 [
X86_FEATURE_SVML
] = "svm_lock",

125 [
X86_FEATURE_NRIPS
] = "nrip_save",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<löux/bô›s.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/¥o˚ss‹.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"˝u.h
"

12 #ifde‡
CONFIG_X86_OOSTORE


14 
u32
 
__˝uöô
 
	$powî2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__˝uöô
 
	$˚¡aur_m¸_ö£π
(
ªg
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |
key
;

36 
	`wrm§
(
ªg
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mår_˚¡aur_ªp‹t_m¸
(
ªg
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__˝uöô
 
	$ømt›
()

47 
u32
 
˛ù
 = 0xFFFFFFFFUL;

48 
u32
 
t›
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 
°¨t
, 
íd
;

54 i‡(
e820
.
m≠
[
i
].
addr
 > 0xFFFFFFFFUL)

60 i‡(
e820
.
m≠
[
i
].
ty≥
 =
E820_RESERVED
) {

61 i‡(
e820
.
m≠
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m≠
[
i
].
addr
 < 
˛ù
)

63 
˛ù
 = 
e820
.
m≠
[
i
].
addr
;

66 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

67 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
;

68 i‡(
°¨t
 >
íd
)

70 i‡(
íd
 > 
t›
)

71 
t›
 = 
íd
;

85 i‡(
t›
 > 
˛ù
)

86 
t›
 = 
˛ù
;

88  
t›
;

89 
	}
}

94 
__˝uöô
 
	$˚¡aur_m¸_compuã
(
ƒ
, 
key
)

96 
u32
 
mem
 = 
	`ømt›
();

97 
u32
 
roŸ
 = 
	`powî2
(
mem
);

98 
u32
 
ba£
 = 
roŸ
;

99 
u32
 
t›
 = 
roŸ
;

100 
u32
 
Êo‹
 = 0;

101 
˘
 = 0;

103 
˘
 < 
ƒ
) {

104 
u32
 
f•a˚
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`powî2
(
mem
-
t›
);

116 
low
 = 
ba£
/2;

122 i‡(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 i‡(
Êo‹
 == 0)

131 
f•a˚
 = 512*1024;

132 i‡(
Êo‹
 == 512*1024)

133 
f•a˚
 = 128*1024;

140 i‡(
f•a˚
 > 
high
 && f•a˚ > 
low
) {

141 
	`˚¡aur_m¸_ö£π
(
˘
, 
Êo‹
, 
f•a˚
, 
key
);

142 
Êo‹
 +
f•a˚
;

143 } i‡(
high
 > 
low
) {

144 
	`˚¡aur_m¸_ö£π
(
˘
, 
t›
, 
high
, 
key
);

145 
t›
 +
high
;

146 } i‡(
low
 > 0) {

147 
ba£
 -
low
;

148 
	`˚¡aur_m¸_ö£π
(
˘
, 
ba£
, 
low
, 
key
);

151 
˘
++;

157  
˘
;

158 
	}
}

160 
__˝uöô
 
	$˚¡aur_¸óã_›timÆ_m¸
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__˝uöô
 
	$wöchù2_¸óã_›timÆ_m¸
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 25);

204 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |1<<(9+
i
);

207 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__˝uöô
 
	$wöchù2_u≈rŸe˘_m¸
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |
key
<<6;

229 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__˝uöô
 
	$wöchù2_¥Ÿe˘_m¸
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28Ë

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6Ë

	)

250 
__˝uöô
 
	$öô_c3
(
˝uöfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 i‡(
	`˝uid_óx
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`˝uid_edx
(0xC0000001);

259 i‡((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |
ACE_FCR
;

262 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 i‡((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |
RNG_ENABLE
;

270 
	`wrm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ˇ∑bûôy
[5] = 
	`˝uid_edx
(0xC0000001);

279 #ifde‡
CONFIG_X86_32


281 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 9) {

282 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

289 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model < 9)

290 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

292 i‡(
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0xf) {

293 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

294 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`˝u_dëe˘_ˇche_sizes
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__˝uöô
 
	$óæy_öô_˚¡aur
(
˝uöfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifde‡
CONFIG_X86_32


327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 i‡(
c
->
x86_modñ
 >= 0xf)

332 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifde‡
CONFIG_X86_64


336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__˝uöô
 
	$öô_˚¡aur
(
˝uöfo_x86
 *
c
)

342 #ifde‡
CONFIG_X86_32


343 *
«me
;

344 
u32
 
f¸_£t
 = 0;

345 
u32
 
f¸_˛r
 = 0;

346 
u32
 
lo
, 
hi
, 
√wlo
;

347 
u32
 
Ø
, 
bb
, 
cc
, 
dd
;

353 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

355 
	`óæy_öô_˚¡aur
(
c
);

356 
c
->
x86
) {

357 #ifde‡
CONFIG_X86_32


359 
c
->
x86_modñ
) {

361 
«me
 = "C6";

362 
f¸_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
f¸_˛r
 = 
DPDC
;

364 
	`¥ötk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TSC
);

366 #ifde‡
CONFIG_X86_OOSTORE


367 
	`˚¡aur_¸óã_›timÆ_m¸
();

378 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
«me
 = "2";

387 
«me
 = "2A";

390 
«me
 = "2B";

393 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
f¸_˛r
 = 
DPDC
;

396 #ifde‡
CONFIG_X86_OOSTORE


397 
	`wöchù2_u≈rŸe˘_m¸
();

398 
	`wöchù2_¸óã_›timÆ_m¸
();

399 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wöchù2_¥Ÿe˘_m¸
();

412 
«me
 = "3";

413 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
f¸_˛r
 = 
DPDC
;

416 #ifde‡
CONFIG_X86_OOSTORE


417 
	`wöchù2_u≈rŸe˘_m¸
();

418 
	`wöchù2_¸óã_›timÆ_m¸
();

419 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wöchù2_¥Ÿe˘_m¸
();

432 
«me
 = "??";

435 
	`rdm§
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
√wlo
 = (
lo
|
f¸_£t
Ë& (~
f¸_˛r
);

438 i‡(
√wlo
 !
lo
) {

439 
	`¥ötk
(
KERN_INFO
 "Centaur FCR was 0x%XÇow 0x%X\n",

440 
lo
, 
√wlo
);

441 
	`wrm§
(
MSR_IDT_FCR1
, 
√wlo
, 
hi
);

443 
	`¥ötk
(
KERN_INFO
 "Cíèu∏FCR i†0x%X\n", 
lo
);

446 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

450 i‡(
c
->
x86_modñ
 >= 8)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

453 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000005) {

455 
	`˝uid
(0x80000005, &
Ø
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ˇche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`•rötf
(
c
->
x86_modñ_id
, "WöChù %s", 
«me
);

463 
	`öô_c3
(
c
);

466 #ifde‡
CONFIG_X86_64


467 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__˝uöô


472 
	$˚¡aur_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

474 #ifde‡
CONFIG_X86_32


476 i‡((
c
->
x86
 =6Ë&& ((c->
x86_modñ
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 == 9) &&

485 (
c
->
x86_mask
 =1Ë&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	g˚¡aur_˝u_dev
 = {

492 .
c_víd‹
 = "Centaur",

493 .
	gc_idít
 = { "CentaurHauls" },

494 .
	gc_óæy_öô
 = 
óæy_öô_˚¡aur
,

495 .
	gc_öô
 = 
öô_˚¡aur
,

496 .
	gc_size_ˇche
 = 
˚¡aur_size_ˇche
,

497 .
	gc_x86_víd‹
 = 
X86_VENDOR_CENTAUR
,

500 
˝u_dev_ªgi°î
(
˚¡aur_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<löux/boŸmem.h
>

2 
	~<löux/lökage.h
>

3 
	~<löux/bô›s.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/≥r˝u.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kgdb.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/io.h
>

15 
	~<asm/°ack¥Ÿe˘‹.h
>

16 
	~<asm/≥rf_evít.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/hy≥rvis‹.h
>

19 
	~<asm/¥o˚ss‹.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<löux/t›ﬁogy.h
>

22 
	~<löux/˝umask.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/≠ic.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/mår.h
>

31 
	~<löux/numa.h
>

32 
	~<asm/asm.h
>

33 
	~<asm/˝u.h
>

34 
	~<asm/m˚.h
>

35 
	~<asm/m§.h
>

36 
	~<asm/∑t.h
>

38 #ifde‡
CONFIG_X86_LOCAL_APIC


39 
	~<asm/uv/uv.h
>

42 
	~"˝u.h
"

45 
˝umask_v¨_t
 
	g˝u_öôülized_mask
;

46 
˝umask_v¨_t
 
	g˝u_ˇŒout_mask
;

47 
˝umask_v¨_t
 
	g˝u_ˇŒö_mask
;

50 
˝umask_v¨_t
 
	g˝u_siblög_£tup_mask
;

53 
__öô
 
	$£tup_˝u_loˇl_masks
()

55 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_öôülized_mask
);

56 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒö_mask
);

57 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒout_mask
);

58 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_siblög_£tup_mask
);

59 
	}
}

61 
__˝uöô
 
	$deÁu…_öô
(
˝uöfo_x86
 *
c
)

63 #ifde‡
CONFIG_X86_64


64 
	`˝u_dëe˘_ˇche_sizes
(
c
);

68 i‡(
c
->
˝uid_Àvñ
 == -1) {

70 i‡(
c
->
x86
 == 4)

71 
	`°r˝y
(
c
->
x86_modñ_id
, "486");

72 i‡(
c
->
x86
 == 3)

73 
	`°r˝y
(
c
->
x86_modñ_id
, "386");

76 
	}
}

78 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gdeÁu…_˝u
 = {

79 .
c_öô
 = 
deÁu…_öô
,

80 .
	gc_víd‹
 = "Unknown",

81 .
	gc_x86_víd‹
 = 
X86_VENDOR_UNKNOWN
,

84 c⁄° 
˝u_dev
 *
this_˝u
 
	g__˝uöôd©a
 = &
deÁu…_˝u
;

86 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_∑ge
, gdt_∑geË{ .
gdt
 = {

87 #ifde‡
CONFIG_X86_64


96 [
GDT_ENTRY_KERNEL32_CS
] = 
GDT_ENTRY_INIT
(0xc09b, 0, 0xfffff),

97 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xa09b, 0, 0xfffff),

98 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc093, 0, 0xfffff),

99 [
GDT_ENTRY_DEFAULT_USER32_CS
] = 
GDT_ENTRY_INIT
(0xc0fb, 0, 0xfffff),

100 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f3, 0, 0xfffff),

101 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xa0fb, 0, 0xfffff),

103 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xc09a, 0, 0xfffff),

104 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

105 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xc0fa, 0, 0xfffff),

106 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f2, 0, 0xfffff),

113 [
GDT_ENTRY_PNPBIOS_CS32
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

115 [
GDT_ENTRY_PNPBIOS_CS16
] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

117 [
GDT_ENTRY_PNPBIOS_DS
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0xffff),

119 [
GDT_ENTRY_PNPBIOS_TS1
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

121 [
GDT_ENTRY_PNPBIOS_TS2
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

127 [
GDT_ENTRY_APMBIOS_BASE
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

129 [
GDT_ENTRY_APMBIOS_BASE
+1] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

131 [
GDT_ENTRY_APMBIOS_BASE
+2] = 
GDT_ENTRY_INIT
(0x4092, 0, 0xffff),

133 [
GDT_ENTRY_ESPFIX_SS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

134 [
GDT_ENTRY_PERCPU
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

135 
	gGDT_STACK_CANARY_INIT


138 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_∑ge
);

140 
__öô
 
	$x86_xßve_£tup
(*
s
)

142 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XSAVE
);

144 
	}
}

145 
__£tup
("noxßve", 
x86_xßve_£tup
);

147 #ifde‡
CONFIG_X86_32


148 
ˇchesize_ovîride
 
	g__˝uöôd©a
 = -1;

149 
dißbÀ_x86_£rül_ƒ
 
	g__˝uöôd©a
 = 1;

151 
__öô
 
	$ˇchesize_£tup
(*
°r
)

153 
	`gë_›ti⁄
(&
°r
, &
ˇchesize_ovîride
);

155 
	}
}

156 
__£tup
("ˇchesize=", 
ˇchesize_£tup
);

158 
__öô
 
	$x86_fx§_£tup
(*
s
)

160 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_FXSR
);

161 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XMM
);

163 
	}
}

164 
__£tup
("nofx§", 
x86_fx§_£tup
);

166 
__öô
 
	$x86_£p_£tup
(*
s
)

168 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_SEP
);

170 
	}
}

171 
__£tup
("no£p", 
x86_£p_£tup
);

174 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

176 
u32
 
f1
, 
f2
;

185 
asm
 volatile ("pushfl \n\t"

196 : "=&r" (
f1
), "=&r" (
f2
)

197 : "ú" (
Êag
));

199  ((
f1
^
f2
Ë& 
Êag
) != 0;

200 
	}
}

203 
__˝uöô
 
	$have_˝uid_p
()

205  
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_ID
);

206 
	}
}

208 
__˝uöô
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

210 
lo
, 
hi
;

212 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_PN
Ë|| !
dißbÀ_x86_£rül_ƒ
)

217 
	`rdm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

218 
lo
 |= 0x200000;

219 
	`wrm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

221 
	`¥ötk
(
KERN_NOTICE
 "CPU serialÇumber disabled.\n");

222 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PN
);

225 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

226 
	}
}

228 
__öô
 
	$x86_£rül_ƒ_£tup
(*
s
)

230 
dißbÀ_x86_£rül_ƒ
 = 0;

232 
	}
}

233 
__£tup
("£rü umbî", 
x86_£rül_ƒ_£tup
);

235 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

238 
	}
}

240 
ölöe
 
	$have_˝uid_p
()

243 
	}
}

244 
ölöe
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

246 
	}
}

254 
	s˝uid_dïídít_„©uª
 {

255 
u32
 
	m„©uª
;

256 
u32
 
	mÀvñ
;

259 c⁄° 
˝uid_dïídít_„©uª
 
__˝uöôc⁄°


260 
	g˝uid_dïídít_„©uªs
[] = {

261 { 
X86_FEATURE_MWAIT
, 0x00000005 },

262 { 
X86_FEATURE_DCA
, 0x00000009 },

263 { 
X86_FEATURE_XSAVE
, 0x0000000d },

267 
__˝uöô
 
	$fûãr_˝uid_„©uªs
(
˝uöfo_x86
 *
c
, 
boﬁ
 
w¨n
)

269 c⁄° 
˝uid_dïídít_„©uª
 *
df
;

271 
df
 = 
˝uid_dïídít_„©uªs
; df->
„©uª
; df++) {

273 i‡(!
	`˝u_has
(
c
, 
df
->
„©uª
))

282 i‡(!((
s32
)
df
->
Àvñ
 < 0 ?

283 (
u32
)
df
->
Àvñ
 > (u32)
c
->
exãnded_˝uid_Àvñ
 :

284 (
s32
)
df
->
Àvñ
 > (s32)
c
->
˝uid_Àvñ
))

287 
	`˛ór_˝u_ˇp
(
c
, 
df
->
„©uª
);

288 i‡(!
w¨n
)

291 
	`¥ötk
(
KERN_WARNING


293 
x86_ˇp_Êags
[
df
->
„©uª
], df->
Àvñ
);

295 
	}
}

305 c⁄° *
__˝uöô
 
	$èbÀ_lookup_modñ
(
˝uöfo_x86
 *
c
)

307 c⁄° 
˝u_modñ_öfo
 *
öfo
;

309 i‡(
c
->
x86_modñ
 >= 16)

310  
NULL
;

312 i‡(!
this_˝u
)

313  
NULL
;

315 
öfo
 = 
this_˝u
->
c_modñs
;

317 
öfo
 && info->
Ámûy
) {

318 i‡(
öfo
->
Ámûy
 =
c
->
x86
)

319  
öfo
->
modñ_«mes
[
c
->
x86_modñ
];

320 
öfo
++;

322  
NULL
;

323 
	}
}

325 
__u32
 
	g˝u_ˇps_˛óªd
[
NCAPINTS
] 
	g__˝uöôd©a
;

326 
__u32
 
	g˝u_ˇps_£t
[
NCAPINTS
] 
	g__˝uöôd©a
;

328 
	$lﬂd_≥r˝u_£gmít
(
˝u
)

330 #ifde‡
CONFIG_X86_32


331 
	`lﬂd£gmít
(
fs
, 
__KERNEL_PERCPU
);

333 
	`lﬂd£gmít
(
gs
, 0);

334 
	`wrm§l
(
MSR_GS_BASE
, ()
	`≥r_˝u
(
úq_°ack_uni⁄
.
gs_ba£
, 
˝u
));

336 
	`lﬂd_°ack_ˇ«ry_£gmít
();

337 
	}
}

343 
	$swôch_to_√w_gdt
(
˝u
)

345 
desc_±r
 
gdt_des¸
;

347 
gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

348 
gdt_des¸
.
size
 = 
GDT_SIZE
 - 1;

349 
	`lﬂd_gdt
(&
gdt_des¸
);

352 
	`lﬂd_≥r˝u_£gmít
(
˝u
);

353 
	}
}

355 c⁄° 
˝u_dev
 *
__˝uöôd©a
 
	g˝u_devs
[
X86_VENDOR_NUM
] = {};

357 
__˝uöô
 
	$gë_modñ_«me
(
˝uöfo_x86
 *
c
)

359 *
v
;

360 *
p
, *
q
;

362 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000004)

365 
v
 = (*)
c
->
x86_modñ_id
;

366 
	`˝uid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

367 
	`˝uid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

368 
	`˝uid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

369 
c
->
x86_modñ_id
[48] = 0;

375 
p
 = 
q
 = &
c
->
x86_modñ_id
[0];

376 *
p
 == ' ')

377 
p
++;

378 i‡(
p
 !
q
) {

379 *
p
)

380 *
q
++ = *
p
++;

381 
q
 <&
c
->
x86_modñ_id
[48])

382 *
q
++ = '\0';

384 
	}
}

386 
__˝uöô
 
	$˝u_dëe˘_ˇche_sizes
(
˝uöfo_x86
 *
c
)

388 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

390 
n
 = 
c
->
exãnded_˝uid_Àvñ
;

392 i‡(
n
 >= 0x80000005) {

393 
	`˝uid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

394 
c
->
x86_ˇche_size
 = (
ecx
>>24Ë+ (
edx
>>24);

395 #ifde‡
CONFIG_X86_64


397 
c
->
x86_ébsize
 = 0;

401 i‡(
n
 < 0x80000006)

404 
	`˝uid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

405 
l2size
 = 
ecx
 >> 16;

407 #ifde‡
CONFIG_X86_64


408 
c
->
x86_ébsize
 +((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

411 i‡(
this_˝u
->
c_size_ˇche
)

412 
l2size
 = 
this_˝u
->
	`c_size_ˇche
(
c
,Ü2size);

415 i‡(
ˇchesize_ovîride
 != -1)

416 
l2size
 = 
ˇchesize_ovîride
;

418 i‡(
l2size
 == 0)

422 
c
->
x86_ˇche_size
 = 
l2size
;

423 
	}
}

425 
__˝uöô
 
	$dëe˘_ht
(
˝uöfo_x86
 *
c
)

427 #ifde‡
CONFIG_X86_HT


428 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

429 
ödex_msb
, 
c‹e_bôs
;

430 
boﬁ
 
¥öãd
;

432 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_HT
))

435 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

436 
out
;

438 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

441 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
edx
);

443 
smp_num_siblögs
 = (
ebx
 & 0xff0000) >> 16;

445 i‡(
smp_num_siblögs
 == 1) {

446 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Hyper-Threading is disabled\n");

447 
out
;

450 i‡(
smp_num_siblögs
 <= 1)

451 
out
;

453 i‡(
smp_num_siblögs
 > 
ƒ_˝u_ids
) {

454 
	`¥_w¨nög
("CPU: UnsupportedÇumber of siblings %d",

455 
smp_num_siblögs
);

456 
smp_num_siblögs
 = 1;

460 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

461 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
);

463 
smp_num_siblögs
 = smp_num_siblög†/ 
c
->
x86_max_c‹es
;

465 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

467 
c‹e_bôs
 = 
	`gë_cou¡_‹dî
(
c
->
x86_max_c‹es
);

469 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
) &

470 ((1 << 
c‹e_bôs
) - 1);

472 
out
:

473 i‡(!
¥öãd
 && (
c
->
x86_max_c‹es
 * 
smp_num_siblögs
) > 1) {

474 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

475 
c
->
phys_¥oc_id
);

476 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

477 
c
->
˝u_c‹e_id
);

478 
¥öãd
 = 1;

481 
	}
}

483 
__˝uöô
 
	$gë_˝u_víd‹
(
˝uöfo_x86
 *
c
)

485 *
v
 = 
c
->
x86_víd‹_id
;

486 
i
;

488 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

489 i‡(!
˝u_devs
[
i
])

492 i‡(!
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[0]) ||

493 (
˝u_devs
[
i
]->
c_idít
[1] &&

494 !
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[1]))) {

496 
this_˝u
 = 
˝u_devs
[
i
];

497 
c
->
x86_víd‹
 = 
this_˝u
->
c_x86_víd‹
;

502 
	`¥ötk_⁄˚
(
KERN_ERR


504 "CPU: You∏sy°em may bêun°abÀ.\n", 
v
);

506 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

507 
this_˝u
 = &
deÁu…_˝u
;

508 
	}
}

510 
__˝uöô
 
	$˝u_dëe˘
(
˝uöfo_x86
 *
c
)

513 
	`˝uid
(0x00000000, (*)&
c
->
˝uid_Àvñ
,

514 (*)&
c
->
x86_víd‹_id
[0],

515 (*)&
c
->
x86_víd‹_id
[8],

516 (*)&
c
->
x86_víd‹_id
[4]);

518 
c
->
x86
 = 4;

520 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

521 
u32
 
junk
, 
tfms
, 
ˇp0
, 
misc
;

523 
	`˝uid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ˇp0
);

524 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

525 
c
->
x86_modñ
 = (
tfms
 >> 4) & 0xf;

526 
c
->
x86_mask
 = 
tfms
 & 0xf;

528 i‡(
c
->
x86
 == 0xf)

529 
c
->
x86
 +(
tfms
 >> 20) & 0xff;

530 i‡(
c
->
x86
 >= 0x6)

531 
c
->
x86_modñ
 +((
tfms
 >> 16) & 0xf) << 4;

533 i‡(
ˇp0
 & (1<<19)) {

534 
c
->
x86_˛Êush_size
 = ((
misc
 >> 8) & 0xff) * 8;

535 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

538 
	}
}

540 
__˝uöô
 
	$gë_˝u_ˇp
(
˝uöfo_x86
 *
c
)

542 
u32
 
tfms
, 
xlvl
;

543 
u32
 
ebx
;

546 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

547 
u32
 
ˇ∑bûôy
, 
exˇp
;

549 
	`˝uid
(0x00000001, &
tfms
, &
ebx
, &
exˇp
, &
ˇ∑bûôy
);

550 
c
->
x86_ˇ∑bûôy
[0] = 
ˇ∑bûôy
;

551 
c
->
x86_ˇ∑bûôy
[4] = 
exˇp
;

555 
xlvl
 = 
	`˝uid_óx
(0x80000000);

556 
c
->
exãnded_˝uid_Àvñ
 = 
xlvl
;

558 i‡((
xlvl
 & 0xffff0000) == 0x80000000) {

559 i‡(
xlvl
 >= 0x80000001) {

560 
c
->
x86_ˇ∑bûôy
[1] = 
	`˝uid_edx
(0x80000001);

561 
c
->
x86_ˇ∑bûôy
[6] = 
	`˝uid_ecx
(0x80000001);

565 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

566 
u32
 
óx
 = 
	`˝uid_óx
(0x80000008);

568 
c
->
x86_vút_bôs
 = (
óx
 >> 8) & 0xff;

569 
c
->
x86_phys_bôs
 = 
óx
 & 0xff;

571 #ifde‡
CONFIG_X86_32


572 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_PAE
Ë|| cpu_has(c, 
X86_FEATURE_PSE36
))

573 
c
->
x86_phys_bôs
 = 36;

576 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000007)

577 
c
->
x86_powî
 = 
	`˝uid_edx
(0x80000007);

579 
	}
}

581 
__˝uöô
 
	$idítify_˝u_wôhout_˝uid
(
˝uöfo_x86
 *
c
)

583 #ifde‡
CONFIG_X86_32


584 
i
;

590 i‡(
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_AC
))

591 
c
->
x86
 = 4;

593 
c
->
x86
 = 3;

595 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

596 i‡(
˝u_devs
[
i
] && cpu_devs[i]->
c_idítify
) {

597 
c
->
x86_víd‹_id
[0] = 0;

598 
˝u_devs
[
i
]->
	`c_idítify
(
c
);

599 i‡(
c
->
x86_víd‹_id
[0]) {

600 
	`gë_˝u_víd‹
(
c
);

605 
	}
}

616 
__öô
 
	$óæy_idítify_˝u
(
˝uöfo_x86
 *
c
)

618 #ifde‡
CONFIG_X86_64


619 
c
->
x86_˛Êush_size
 = 64;

620 
c
->
x86_phys_bôs
 = 36;

621 
c
->
x86_vút_bôs
 = 48;

623 
c
->
x86_˛Êush_size
 = 32;

624 
c
->
x86_phys_bôs
 = 32;

625 
c
->
x86_vút_bôs
 = 32;

627 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

629 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

630 
c
->
exãnded_˝uid_Àvñ
 = 0;

632 i‡(!
	`have_˝uid_p
())

633 
	`idítify_˝u_wôhout_˝uid
(
c
);

636 i‡(!
	`have_˝uid_p
())

639 
	`˝u_dëe˘
(
c
);

641 
	`gë_˝u_víd‹
(
c
);

643 
	`gë_˝u_ˇp
(
c
);

645 i‡(
this_˝u
->
c_óæy_öô
)

646 
this_˝u
->
	`c_óæy_öô
(
c
);

648 #ifde‡
CONFIG_SMP


649 
c
->
˝u_ödex
 = 
boŸ_˝u_id
;

651 
	`fûãr_˝uid_„©uªs
(
c
, 
Ál£
);

652 
	}
}

654 
__öô
 
	$óæy_˝u_öô
()

656 c⁄° 
˝u_dev
 *c⁄° *
cdev
;

657 
cou¡
 = 0;

659 #ifde‡
PROCESSOR_SELECT


660 
	`¥ötk
(
KERN_INFO
 "KERNEL supported cpus:\n");

663 
cdev
 = 
__x86_˝u_dev_°¨t
; cdev < 
__x86_˝u_dev_íd
; cdev++) {

664 c⁄° 
˝u_dev
 *
˝udev
 = *
cdev
;

666 i‡(
cou¡
 >
X86_VENDOR_NUM
)

668 
˝u_devs
[
cou¡
] = 
˝udev
;

669 
cou¡
++;

671 #ifde‡
PROCESSOR_SELECT


673 
j
;

675 
j
 = 0; j < 2; j++) {

676 i‡(!
˝udev
->
c_idít
[
j
])

678 
	`¥ötk
(
KERN_INFO
 " %†%s\n", 
˝udev
->
c_víd‹
,

679 
˝udev
->
c_idít
[
j
]);

684 
	`óæy_idítify_˝u
(&
boŸ_˝u_d©a
);

685 
	}
}

695 
__˝uöô
 
	$dëe˘_n›l
(
˝uöfo_x86
 *
c
)

697 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_NOPL
);

698 
	}
}

700 
__˝uöô
 
	$gíîic_idítify
(
˝uöfo_x86
 *
c
)

702 
c
->
exãnded_˝uid_Àvñ
 = 0;

704 i‡(!
	`have_˝uid_p
())

705 
	`idítify_˝u_wôhout_˝uid
(
c
);

708 i‡(!
	`have_˝uid_p
())

711 
	`˝u_dëe˘
(
c
);

713 
	`gë_˝u_víd‹
(
c
);

715 
	`gë_˝u_ˇp
(
c
);

717 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

718 
c
->
öôül_≠icid
 = (
	`˝uid_ebx
(1) >> 24) & 0xFF;

719 #ifde‡
CONFIG_X86_32


720 #ifde‡
CONFIG_X86_HT


721 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

723 
c
->
≠icid
 = c->
öôül_≠icid
;

727 #ifde‡
CONFIG_X86_HT


728 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
;

732 
	`gë_modñ_«me
(
c
);

734 
	`öô_sˇâîed_˝uid_„©uªs
(
c
);

735 
	`dëe˘_n›l
(
c
);

736 
	}
}

741 
__˝uöô
 
	$idítify_˝u
(
˝uöfo_x86
 *
c
)

743 
i
;

745 
c
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

746 
c
->
x86_ˇche_size
 = -1;

747 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

748 
c
->
x86_modñ
 = c->
x86_mask
 = 0;

749 
c
->
x86_víd‹_id
[0] = '\0';

750 
c
->
x86_modñ_id
[0] = '\0';

751 
c
->
x86_max_c‹es
 = 1;

752 
c
->
x86_c‹eid_bôs
 = 0;

753 #ifde‡
CONFIG_X86_64


754 
c
->
x86_˛Êush_size
 = 64;

755 
c
->
x86_phys_bôs
 = 36;

756 
c
->
x86_vút_bôs
 = 48;

758 
c
->
˝uid_Àvñ
 = -1;

759 
c
->
x86_˛Êush_size
 = 32;

760 
c
->
x86_phys_bôs
 = 32;

761 
c
->
x86_vút_bôs
 = 32;

763 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

764 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

766 
	`gíîic_idítify
(
c
);

768 i‡(
this_˝u
->
c_idítify
)

769 
this_˝u
->
	`c_idítify
(
c
);

772 
i
 = 0; i < 
NCAPINTS
; i++) {

773 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

774 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

777 #ifde‡
CONFIG_X86_64


778 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

791 i‡(
this_˝u
->
c_öô
)

792 
this_˝u
->
	`c_öô
(
c
);

795 
	`squash_the_°upid_£rül_numbî
(
c
);

803 
	`fûãr_˝uid_„©uªs
(
c
, 
åue
);

806 i‡(!
c
->
x86_modñ_id
[0]) {

807 c⁄° *
p
;

808 
p
 = 
	`èbÀ_lookup_modñ
(
c
);

809 i‡(
p
)

810 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

813 
	`•rötf
(
c
->
x86_modñ_id
, "%02x/%02x",

814 
c
->
x86
, c->
x86_modñ
);

817 #ifde‡
CONFIG_X86_64


818 
	`dëe˘_ht
(
c
);

821 
	`öô_hy≥rvis‹
(
c
);

827 
i
 = 0; i < 
NCAPINTS
; i++) {

828 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

829 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

838 i‡(
c
 !&
boŸ_˝u_d©a
) {

840 
i
 = 0; i < 
NCAPINTS
; i++)

841 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[
i
] &
c
->x86_capability[i];

845 
	`mcheck_˝u_öô
(
c
);

847 
	`£À˘_idÀ_routöe
(
c
);

849 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

850 
	`numa_add_˝u
(
	`smp_¥o˚ss‹_id
());

852 
	}
}

854 #ifde‡
CONFIG_X86_64


855 
	$vgë˝u_£t_mode
()

857 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_RDTSCP
))

858 
vgë˝u_mode
 = 
VGETCPU_RDTSCP
;

860 
vgë˝u_mode
 = 
VGETCPU_LSL
;

861 
	}
}

864 
__öô
 
	$idítify_boŸ_˝u
()

866 
	`idítify_˝u
(&
boŸ_˝u_d©a
);

867 
	`öô_c1e_mask
();

868 #ifde‡
CONFIG_X86_32


869 
	`sy£¡î_£tup
();

870 
	`íabÀ_£p_˝u
();

872 
	`vgë˝u_£t_mode
();

874 
	`öô_hw_≥rf_evíts
();

875 
	}
}

877 
__˝uöô
 
	$idítify_£c⁄d¨y_˝u
(
˝uöfo_x86
 *
c
)

879 
	`BUG_ON
(
c
 =&
boŸ_˝u_d©a
);

880 
	`idítify_˝u
(
c
);

881 #ifde‡
CONFIG_X86_32


882 
	`íabÀ_£p_˝u
();

884 
	`mår_≠_öô
();

885 
	}
}

887 
	sm§_ønge
 {

888 
	mmö
;

889 
	mmax
;

892 c⁄° 
m§_ønge
 
	gm§_ønge_¨øy
[] 
	g__˝uöôc⁄°
 = {

899 
__˝uöô
 
	$¥öt_˝u_m§
()

901 
ödex_mö
, 
ödex_max
;

902 
ödex
;

903 
u64
 
vÆ
;

904 
i
;

906 
i
 = 0; i < 
	`ARRAY_SIZE
(
m§_ønge_¨øy
); i++) {

907 
ödex_mö
 = 
m§_ønge_¨øy
[
i
].
mö
;

908 
ödex_max
 = 
m§_ønge_¨øy
[
i
].
max
;

910 
ödex
 = 
ödex_mö
; index < 
ödex_max
; index++) {

911 i‡(
	`rdm§l_amd_ß„
(
ödex
, &
vÆ
))

913 
	`¥ötk
(
KERN_INFO
 " MSR%08x: %016Œx\n", 
ödex
, 
vÆ
);

916 
	}
}

918 
show_m§
 
	g__˝uöôd©a
;

920 
__öô
 
	$£tup_show_m§
(*
¨g
)

922 
num
;

924 
	`gë_›ti⁄
(&
¨g
, &
num
);

926 i‡(
num
 > 0)

927 
show_m§
 = 
num
;

929 
	}
}

930 
__£tup
("show_m§=", 
£tup_show_m§
);

932 
__öô
 
	$£tup_no˛Êush
(*
¨g
)

934 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_CLFLSH
);

936 
	}
}

937 
__£tup
("no˛Êush", 
£tup_no˛Êush
);

939 
__˝uöô
 
	$¥öt_˝u_öfo
(
˝uöfo_x86
 *
c
)

941 c⁄° *
víd‹
 = 
NULL
;

943 i‡(
c
->
x86_víd‹
 < 
X86_VENDOR_NUM
) {

944 
víd‹
 = 
this_˝u
->
c_víd‹
;

946 i‡(
c
->
˝uid_Àvñ
 >= 0)

947 
víd‹
 = 
c
->
x86_víd‹_id
;

950 i‡(
víd‹
 && !
	`°r°r
(
c
->
x86_modñ_id
, vendor))

951 
	`¥ötk
(
KERN_CONT
 "%†", 
víd‹
);

953 i‡(
c
->
x86_modñ_id
[0])

954 
	`¥ötk
(
KERN_CONT
 "%s", 
c
->
x86_modñ_id
);

956 
	`¥ötk
(
KERN_CONT
 "%d86", 
c
->
x86
);

958 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

959 
	`¥ötk
(
KERN_CONT
 " sãµög %02x\n", 
c
->
x86_mask
);

961 
	`¥ötk
(
KERN_CONT
 "\n");

963 #ifde‡
CONFIG_SMP


964 i‡(
c
->
˝u_ödex
 < 
show_m§
)

965 
	`¥öt_˝u_m§
();

967 i‡(
show_m§
)

968 
	`¥öt_˝u_m§
();

970 
	}
}

972 
__öô
 
	$£tup_dißbÀ˝uid
(*
¨g
)

974 
bô
;

976 i‡(
	`gë_›ti⁄
(&
¨g
, &
bô
Ë&& bô < 
NCAPINTS
*32)

977 
	`£tup_˛ór_˝u_ˇp
(
bô
);

982 
	}
}

983 
__£tup
("˛ór˝uid=", 
£tup_dißbÀ˝uid
);

985 #ifde‡
CONFIG_X86_64


986 
desc_±r
 
	gidt_des¸
 = { 
NR_VECTORS
 * 16 - 1, (Ë
idt_èbÀ
 };

988 
	$DEFINE_PER_CPU_FIRST
(
úq_°ack_uni⁄
,

989 
úq_°ack_uni⁄
Ë
	`__Æig√d
(
PAGE_SIZE
);

995 
	$DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë
____ˇchñöe_Æig√d
 =

996 &
öô_èsk
;

997 
	`EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

999 
	`DEFINE_PER_CPU
(, 
kî√l_°ack
) =

1000 ()&
öô_thªad_uni⁄
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

1001 
	`EXPORT_PER_CPU_SYMBOL
(
kî√l_°ack
);

1003 
	`DEFINE_PER_CPU
(*, 
úq_°ack_±r
) =

1004 
	`öô_≥r_˝u_v¨
(
úq_°ack_uni⁄
.
úq_°ack
Ë+ 
IRQ_STACK_SIZE
 - 64;

1006 
	`DEFINE_PER_CPU
(, 
úq_cou¡
) = -1;

1014 c⁄° 
ex˚±i⁄_°ack_sizes
[
N_EXCEPTION_STACKS
] = {

1015 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

1016 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


1017 
	}
};

1019 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
ex˚±i⁄_°acks


1020 [(
N_EXCEPTION_STACKS
 - 1Ë* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
]);

1023 
	$sysˇŒ_öô
()

1030 
	`wrm§l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1031 
	`wrm§l
(
MSR_LSTAR
, 
sy°em_ˇŒ
);

1032 
	`wrm§l
(
MSR_CSTAR
, 
ign‹e_sy§ë
);

1034 #ifde‡
CONFIG_IA32_EMULATION


1035 
	`sysˇŒ32_˝u_öô
();

1039 
	`wrm§l
(
MSR_SYSCALL_MASK
,

1040 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1041 
	}
}

1043 
	gkî√l_eÊags
;

1049 
DEFINE_PER_CPU
(
‹ig_i°
, orig_ist);

1053 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë&
öô_èsk
;

1054 
EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

1056 #ifde‡
CONFIG_CC_STACKPROTECTOR


1057 
DEFINE_PER_CPU_ALIGNED
(
°ack_ˇ«ry
, stack_canary);

1061 
±_ªgs
 * 
__˝uöô
 
	$idÀ_ªgs
(
±_ªgs
 *
ªgs
)

1063 
	`mem£t
(
ªgs
, 0, (
±_ªgs
));

1064 
ªgs
->
fs
 = 
__KERNEL_PERCPU
;

1065 
ªgs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1067  
ªgs
;

1068 
	}
}

1074 
	$˛ór_Æl_debug_ªgs
()

1076 
i
;

1078 
i
 = 0; i < 8; i++) {

1080 i‡((
i
 == 4) || (i == 5))

1083 
	`£t_debugªg
(0, 
i
);

1085 
	}
}

1094 #ifde‡
CONFIG_X86_64


1096 
__˝uöô
 
	$˝u_öô
()

1098 
‹ig_i°
 *
oi°
;

1099 
èsk_°ru˘
 *
me
;

1100 
tss_°ru˘
 *
t
;

1101 
v
;

1102 
˝u
;

1103 
i
;

1105 
˝u
 = 
	`°ack_smp_¥o˚ss‹_id
();

1106 
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1107 
oi°
 = &
	`≥r_˝u
(
‹ig_i°
, 
˝u
);

1109 #ifde‡
CONFIG_NUMA


1110 i‡(
˝u
 !0 && 
	`≥r˝u_ªad
(
node_numbî
) == 0 &&

1111 
	`˝u_to_node
(
˝u
Ë!
NUMA_NO_NODE
)

1112 
	`≥r˝u_wrôe
(
node_numbî
, 
	`˝u_to_node
(
˝u
));

1115 
me
 = 
cuºít
;

1117 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
))

1118 
	`∑nic
("CPU#%dáÃódy inôülized!\n", 
˝u
);

1120 
	`¥_debug
("Inôülizög CPU#%d\n", 
˝u
);

1122 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1129 
	`swôch_to_√w_gdt
(
˝u
);

1130 
	`lﬂd£gmít
(
fs
, 0);

1132 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

1134 
	`mem£t
(
me
->
thªad
.
és_¨øy
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1135 
	`sysˇŒ_öô
();

1137 
	`wrm§l
(
MSR_FS_BASE
, 0);

1138 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 0);

1139 
	`b¨rõr
();

1141 
	`x86_c⁄figuª_nx
();

1142 i‡(
˝u
 != 0)

1143 
	`íabÀ_x2≠ic
();

1148 i‡(!
oi°
->
i°
[0]) {

1149 *
e°acks
 = 
	`≥r_˝u
(
ex˚±i⁄_°acks
, 
˝u
);

1151 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1152 
e°acks
 +
ex˚±i⁄_°ack_sizes
[
v
];

1153 
oi°
->
i°
[
v
] = 
t
->
x86_tss
.ist[v] =

1154 ()
e°acks
;

1158 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1164 
i
 = 0; i <
IO_BITMAP_LONGS
; i++)

1165 
t
->
io_bôm≠
[
i
] = ~0UL;

1167 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1168 
me
->
a˘ive_mm
 = &
öô_mm
;

1169 
	`BUG_ON
(
me
->
mm
);

1170 
	`íãr_œzy_éb
(&
öô_mm
, 
me
);

1172 
	`lﬂd_•0
(
t
, &
cuºít
->
thªad
);

1173 
	`£t_tss_desc
(
˝u
, 
t
);

1174 
	`lﬂd_TR_desc
();

1175 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1177 #ifde‡
CONFIG_KGDB


1184 i‡(
kgdb_c⁄√˘ed
 && 
¨ch_kgdb_›s
.
c‹ª˘_hw_bªak
)

1185 
¨ch_kgdb_›s
.
	`c‹ª˘_hw_bªak
();

1188 
	`˛ór_Æl_debug_ªgs
();

1190 
	`Âu_öô
();

1192 
	`øw_loˇl_ßve_Êags
(
kî√l_eÊags
);

1194 i‡(
	`is_uv_sy°em
())

1195 
	`uv_˝u_öô
();

1196 
	}
}

1200 
__˝uöô
 
	$˝u_öô
()

1202 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1203 
èsk_°ru˘
 *
cuº
 = 
cuºít
;

1204 
tss_°ru˘
 *
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1205 
thªad_°ru˘
 *
thªad
 = &
cuº
->thread;

1207 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
)) {

1208 
	`¥ötk
(
KERN_WARNING
 "CPU#%dáÃódy inôülized!\n", 
˝u
);

1210 
	`loˇl_úq_íabÀ
();

1213 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1215 i‡(
˝u_has_vme
 || 
˝u_has_tsc
 || 
˝u_has_de
)

1216 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1218 
	`lﬂd_idt
(&
idt_des¸
);

1219 
	`swôch_to_√w_gdt
(
˝u
);

1224 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1225 
cuº
->
a˘ive_mm
 = &
öô_mm
;

1226 
	`BUG_ON
(
cuº
->
mm
);

1227 
	`íãr_œzy_éb
(&
öô_mm
, 
cuº
);

1229 
	`lﬂd_•0
(
t
, 
thªad
);

1230 
	`£t_tss_desc
(
˝u
, 
t
);

1231 
	`lﬂd_TR_desc
();

1232 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1234 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1236 #ifde‡
CONFIG_DOUBLEFAULT


1238 
	`__£t_tss_desc
(
˝u
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubÀÁu…_tss
);

1241 
	`˛ór_Æl_debug_ªgs
();

1246 i‡(
˝u_has_xßve
)

1247 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

1249 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

1250 
	`˛ór_u£d_m©h
();

1251 
	`mxc§_„©uª_mask_öô
();

1256 i‡(
	`smp_¥o˚ss‹_id
(Ë=
boŸ_˝u_id
)

1257 
	`öô_thªad_x°©e
();

1259 
	`xßve_öô
();

1260 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<löux/kî√l.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/˝u‰eq.h
>

34 
	~<löux/compûî.h
>

35 
	~<löux/dmi.h
>

36 
	~<löux/¶ab.h
>

37 
	~<åa˚/evíts/powî.h
>

39 
	~<löux/a˝i.h
>

40 
	~<löux/io.h
>

41 
	~<löux/dñay.h
>

42 
	~<löux/uac˚ss.h
>

44 
	~<a˝i/¥o˚ss‹.h
>

46 
	~<asm/m§.h
>

47 
	~<asm/¥o˚ss‹.h
>

48 
	~<asm/˝u„©uª.h
>

50 
	#d¥ötk
(
msg
...Ë
	`˝u‰eq_debug_¥ötk
(
CPUFREQ_DEBUG_DRIVER
, \

51 "a˝i-˝u‰eq", 
msg
)

	)

53 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

54 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

55 
MODULE_LICENSE
("GPL");

58 
	mUNDEFINED_CAPABLE
 = 0,

59 
	mSYSTEM_INTEL_MSR_CAPABLE
,

60 
	mSYSTEM_IO_CAPABLE
,

63 
	#INTEL_MSR_RANGE
 (0xffff)

	)

65 
	sa˝i_˝u‰eq_d©a
 {

66 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ma˝i_d©a
;

67 
˝u‰eq_‰equícy_èbÀ
 *
	m‰eq_èbÀ
;

68 
	mªsume
;

69 
	m˝u_„©uª
;

72 
DEFINE_PER_CPU
(
a˝i_˝u‰eq_d©a
 *, 
ac‰eq_d©a
);

74 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ac‰eq_ﬁd_≥rf
);

77 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ga˝i_≥rf_d©a
;

79 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
;

81 
	ga˝i_p°©e_°ri˘
;

83 
	$check_e°_˝u
(
˝uid
)

85 
˝uöfo_x86
 *
˝u
 = &
	`˝u_d©a
(
˝uid
);

87  
	`˝u_has
(
˝u
, 
X86_FEATURE_EST
);

88 
	}
}

90 
	$exåa˘_io
(
u32
 
vÆue
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

92 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

93 
i
;

95 
≥rf
 = 
d©a
->
a˝i_d©a
;

97 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

98 i‡(
vÆue
 =
≥rf
->
°©es
[
i
].
°©us
)

99  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

102 
	}
}

104 
	$exåa˘_m§
(
u32
 
m§
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

106 
i
;

107 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

109 
m§
 &
INTEL_MSR_RANGE
;

110 
≥rf
 = 
d©a
->
a˝i_d©a
;

112 
i
 = 0; 
d©a
->
‰eq_èbÀ
[i].
‰equícy
 !
CPUFREQ_TABLE_END
; i++) {

113 i‡(
m§
 =
≥rf
->
°©es
[
d©a
->
‰eq_èbÀ
[
i
].
ödex
].
°©us
)

114  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

116  
d©a
->
‰eq_èbÀ
[0].
‰equícy
;

117 
	}
}

119 
	$exåa˘_‰eq
(
u32
 
vÆ
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

121 
d©a
->
˝u_„©uª
) {

122 
SYSTEM_INTEL_MSR_CAPABLE
:

123  
	`exåa˘_m§
(
vÆ
, 
d©a
);

124 
SYSTEM_IO_CAPABLE
:

125  
	`exåa˘_io
(
vÆ
, 
d©a
);

129 
	}
}

131 
	sm§_addr
 {

132 
u32
 
	mªg
;

135 
	sio_addr
 {

136 
u16
 
	mp‹t
;

137 
u8
 
	mbô_width
;

140 
	sdrv_cmd
 {

141 
	mty≥
;

142 c⁄° 
˝umask
 *
	mmask
;

144 
m§_addr
 
	mm§
;

145 
io_addr
 
	mio
;

146 } 
	maddr
;

147 
u32
 
	mvÆ
;

151 
	$do_drv_ªad
(*
_cmd
)

153 
drv_cmd
 *
cmd
 = 
_cmd
;

154 
u32
 
h
;

156 
cmd
->
ty≥
) {

157 
SYSTEM_INTEL_MSR_CAPABLE
:

158 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, cmd->
vÆ
, 
h
);

160 
SYSTEM_IO_CAPABLE
:

161 
	`a˝i_os_ªad_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

162 &
cmd
->
vÆ
,

163 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

168 
	}
}

171 
	$do_drv_wrôe
(*
_cmd
)

173 
drv_cmd
 *
cmd
 = 
_cmd
;

174 
u32
 
lo
, 
hi
;

176 
cmd
->
ty≥
) {

177 
SYSTEM_INTEL_MSR_CAPABLE
:

178 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

179 
lo
 = (lÿ& ~
INTEL_MSR_RANGE
Ë| (
cmd
->
vÆ
 & INTEL_MSR_RANGE);

180 
	`wrm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

182 
SYSTEM_IO_CAPABLE
:

183 
	`a˝i_os_wrôe_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

184 
cmd
->
vÆ
,

185 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

190 
	}
}

192 
	$drv_ªad
(
drv_cmd
 *
cmd
)

194 
îr
;

195 
cmd
->
vÆ
 = 0;

197 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_™y
(
cmd
->
mask
, 
do_drv_ªad
, cmd, 1);

198 
	`WARN_ON_ONCE
(
îr
);

199 
	}
}

201 
	$drv_wrôe
(
drv_cmd
 *
cmd
)

203 
this_˝u
;

205 
this_˝u
 = 
	`gë_˝u
();

206 i‡(
	`˝umask_ã°_˝u
(
this_˝u
, 
cmd
->
mask
))

207 
	`do_drv_wrôe
(
cmd
);

208 
	`smp_ˇŒ_fun˘i⁄_m™y
(
cmd
->
mask
, 
do_drv_wrôe
, cmd, 1);

209 
	`put_˝u
();

210 
	}
}

212 
u32
 
	$gë_cur_vÆ
(c⁄° 
˝umask
 *
mask
)

214 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

215 
drv_cmd
 
cmd
;

217 i‡(
	`u∆ikñy
(
	`˝umask_em±y
(
mask
)))

220 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
˝u_„©uª
) {

221 
SYSTEM_INTEL_MSR_CAPABLE
:

222 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

223 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_STATUS
;

225 
SYSTEM_IO_CAPABLE
:

226 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

227 
≥rf
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
a˝i_d©a
;

228 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

229 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

235 
cmd
.
mask
 = mask;

236 
	`drv_ªad
(&
cmd
);

238 
	`d¥ötk
("gë_cur_vÆ = %u\n", 
cmd
.
vÆ
);

240  
cmd
.
vÆ
;

241 
	}
}

244 
	$ªad_mósuªd_≥rf_˘rs
(*
_cur
)

246 
≠îfm≥rf
 *
am
 = 
_cur
;

248 
	`gë_≠îfm≥rf
(
am
);

249 
	}
}

264 
	$gë_mósuªd_≥rf
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

265 
˝u
)

267 
≠îfm≥rf
 
≥rf
;

268 
øtio
;

269 
ªtvÆ
;

271 i‡(
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
ªad_mósuªd_≥rf_˘rs
, &
≥rf
, 1))

274 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(&
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
), &
≥rf
);

275 
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
Ë
≥rf
;

277 
ªtvÆ
 = (
pﬁicy
->
˝uöfo
.
max_‰eq
 * 
øtio
Ë>> 
APERFMPERF_SHIFT
;

279  
ªtvÆ
;

280 
	}
}

282 
	$gë_cur_‰eq_⁄_˝u
(
˝u
)

284 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
);

285 
‰eq
;

286 
ˇched_‰eq
;

288 
	`d¥ötk
("gë_cur_‰eq_⁄_˝u (%d)\n", 
˝u
);

290 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

291 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

295 
ˇched_‰eq
 = 
d©a
->
‰eq_èbÀ
[d©a->
a˝i_d©a
->
°©e
].
‰equícy
;

296 
‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
	`˝umask_of
(
˝u
)), 
d©a
);

297 i‡(
‰eq
 !
ˇched_‰eq
) {

302 
d©a
->
ªsume
 = 1;

305 
	`d¥ötk
("cu∏‰eq = %u\n", 
‰eq
);

307  
‰eq
;

308 
	}
}

310 
	$check_‰eqs
(c⁄° 
˝umask
 *
mask
, 
‰eq
,

311 
a˝i_˝u‰eq_d©a
 *
d©a
)

313 
cur_‰eq
;

314 
i
;

316 
i
 = 0; i < 100; i++) {

317 
cur_‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
mask
), 
d©a
);

318 i‡(
cur_‰eq
 =
‰eq
)

320 
	`udñay
(10);

323 
	}
}

325 
	$a˝i_˝u‰eq_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

326 
èrgë_‰eq
, 
ªœti⁄
)

328 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

329 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

330 
˝u‰eq_‰eqs
 
‰eqs
;

331 
drv_cmd
 
cmd
;

332 
√xt_°©e
 = 0;

333 
√xt_≥rf_°©e
 = 0;

334 
i
;

335 
ªsu…
 = 0;

337 
	`d¥ötk
("a˝i_˝u‰eq_èrgë %d (%d)\n", 
èrgë_‰eq
, 
pﬁicy
->
˝u
);

339 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

340 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

341  -
ENODEV
;

344 
≥rf
 = 
d©a
->
a˝i_d©a
;

345 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_èrgë
(
pﬁicy
,

346 
d©a
->
‰eq_èbÀ
,

347 
èrgë_‰eq
,

348 
ªœti⁄
, &
√xt_°©e
);

349 i‡(
	`u∆ikñy
(
ªsu…
)) {

350 
ªsu…
 = -
ENODEV
;

351 
out
;

354 
√xt_≥rf_°©e
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
ödex
;

355 i‡(
≥rf
->
°©e
 =
√xt_≥rf_°©e
) {

356 i‡(
	`u∆ikñy
(
d©a
->
ªsume
)) {

357 
	`d¥ötk
("CalledáfterÑesume,ÑesettingÅo P%d\n",

358 
√xt_≥rf_°©e
);

359 
d©a
->
ªsume
 = 0;

361 
	`d¥ötk
("AlreadyátÅarget state (P%d)\n",

362 
√xt_≥rf_°©e
);

363 
out
;

367 
	`åa˚_powî_‰equícy
(
POWER_PSTATE
, 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
);

369 
d©a
->
˝u_„©uª
) {

370 
SYSTEM_INTEL_MSR_CAPABLE
:

371 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

372 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_CTL
;

373 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

375 
SYSTEM_IO_CAPABLE
:

376 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

377 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

378 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

379 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

382 
ªsu…
 = -
ENODEV
;

383 
out
;

387 i‡(
pﬁicy
->
sh¨ed_ty≥
 !
CPUFREQ_SHARED_TYPE_ANY
)

388 
cmd
.
mask
 = 
pﬁicy
->
˝us
;

390 
cmd
.
mask
 = 
	`˝umask_of
(
pﬁicy
->
˝u
);

392 
‰eqs
.
ﬁd
 = 
≥rf
->
°©es
[≥rf->
°©e
].
c‹e_‰equícy
 * 1000;

393 
‰eqs
.
√w
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
;

394 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

395 
‰eqs
.
˝u
 = 
i
;

396 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

399 
	`drv_wrôe
(&
cmd
);

401 i‡(
a˝i_p°©e_°ri˘
) {

402 i‡(!
	`check_‰eqs
(
cmd
.
mask
, 
‰eqs
.
√w
, 
d©a
)) {

403 
	`d¥ötk
("acpi_cpufreq_target failed (%d)\n",

404 
pﬁicy
->
˝u
);

405 
ªsu…
 = -
EAGAIN
;

406 
out
;

410 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

411 
‰eqs
.
˝u
 = 
i
;

412 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

414 
≥rf
->
°©e
 = 
√xt_≥rf_°©e
;

416 
out
:

417  
ªsu…
;

418 
	}
}

420 
	$a˝i_˝u‰eq_vîify
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

422 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

424 
	`d¥ötk
("acpi_cpufreq_verify\n");

426  
	`˝u‰eq_‰equícy_èbÀ_vîify
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

427 
	}
}

430 
	$a˝i_˝u‰eq_guess_‰eq
(
a˝i_˝u‰eq_d©a
 *
d©a
, 
˝u
)

432 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
 = 
d©a
->
a˝i_d©a
;

434 i‡(
˝u_khz
) {

436 
i
;

437 
‰eq
;

438 
‰eqn
 = 
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

440 
i
 = 0; i < (
≥rf
->
°©e_cou¡
-1); i++) {

441 
‰eq
 = 
‰eqn
;

442 
‰eqn
 = 
≥rf
->
°©es
[
i
+1].
c‹e_‰equícy
 * 1000;

443 i‡((2 * 
˝u_khz
Ë> (
‰eqn
 + 
‰eq
)) {

444 
≥rf
->
°©e
 = 
i
;

445  
‰eq
;

448 
≥rf
->
°©e
 =Öîf->
°©e_cou¡
-1;

449  
‰eqn
;

452 
≥rf
->
°©e
 = 0;

453  
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

455 
	}
}

457 
	$‰ì_a˝i_≥rf_d©a
()

459 
i
;

462 
	`f‹_óch_possibÀ_˝u
(
i
)

463 
	`‰ì_˝umask_v¨
(
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)

464 ->
sh¨ed_˝u_m≠
);

465 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

466 
	}
}

476 
__öô
 
	$a˝i_˝u‰eq_óæy_öô
()

478 
i
;

479 
	`d¥ötk
("acpi_cpufreq_early_init\n");

481 
a˝i_≥rf_d©a
 = 
	`Æloc_≥r˝u
(
a˝i_¥o˚ss‹_≥rf‹m™˚
);

482 i‡(!
a˝i_≥rf_d©a
) {

483 
	`d¥ötk
("MemoryállocationÉrror forácpi_perf_data.\n");

484  -
ENOMEM
;

486 
	`f‹_óch_possibÀ_˝u
(
i
) {

487 i‡(!
	`zÆloc_˝umask_v¨_node
(

488 &
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)->
sh¨ed_˝u_m≠
,

489 
GFP_KERNEL
, 
	`˝u_to_node
(
i
))) {

492 
	`‰ì_a˝i_≥rf_d©a
();

493  -
ENOMEM
;

498 
	`a˝i_¥o˚ss‹_¥îegi°î_≥rf‹m™˚
(
a˝i_≥rf_d©a
);

500 
	}
}

502 #ifde‡
CONFIG_SMP


509 
	gbios_wôh_sw_™y_bug
;

511 
	$sw_™y_bug_found
(c⁄° 
dmi_sy°em_id
 *
d
)

513 
bios_wôh_sw_™y_bug
 = 1;

515 
	}
}

517 c⁄° 
dmi_sy°em_id
 
	gsw_™y_bug_dmi_èbÀ
[] = {

519 .
ˇŒback
 = 
sw_™y_bug_found
,

520 .
	gidít
 = "Supermicro Server X6DLP",

521 .
	gm©ches
 = {

522 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

523 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

524 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

530 
	$a˝i_˝u‰eq_bœckli°
(
˝uöfo_x86
 *
c
)

537 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

538 i‡((
c
->
x86
 == 15) &&

539 (
c
->
x86_modñ
 == 6) &&

540 (
c
->
x86_mask
 == 8)) {

541 
	`¥ötk
(
KERN_INFO
 "acpi-cpufreq: Intel(R) "

545  -
ENODEV
;

549 
	}
}

552 
	$a˝i_˝u‰eq_˝u_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

554 
i
;

555 
vÆid_°©es
 = 0;

556 
˝u
 = 
pﬁicy
->cpu;

557 
a˝i_˝u‰eq_d©a
 *
d©a
;

558 
ªsu…
 = 0;

559 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
pﬁicy
->
˝u
);

560 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

561 #ifde‡
CONFIG_SMP


562 
bœckli°ed
;

565 
	`d¥ötk
("acpi_cpufreq_cpu_init\n");

567 #ifde‡
CONFIG_SMP


568 i‡(
bœckli°ed
)

569  
bœckli°ed
;

570 
bœckli°ed
 = 
	`a˝i_˝u‰eq_bœckli°
(
c
);

571 i‡(
bœckli°ed
)

572  
bœckli°ed
;

575 
d©a
 = 
	`kzÆloc
((
a˝i_˝u‰eq_d©a
), 
GFP_KERNEL
);

576 i‡(!
d©a
)

577  -
ENOMEM
;

579 
d©a
->
a˝i_d©a
 = 
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
˝u
);

580 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
d©a
;

582 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

583 
a˝i_˝u‰eq_drivî
.
Êags
 |
CPUFREQ_CONST_LOOPS
;

585 
ªsu…
 = 
	`a˝i_¥o˚ss‹_ªgi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
, 
˝u
);

586 i‡(
ªsu…
)

587 
îr_‰ì
;

589 
≥rf
 = 
d©a
->
a˝i_d©a
;

590 
pﬁicy
->
sh¨ed_ty≥
 = 
≥rf
->shared_type;

596 i‡(
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ALL
 ||

597 
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ANY
) {

598 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

600 
	`˝umask_c›y
(
pﬁicy
->
ªœãd_˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

602 #ifde‡
CONFIG_SMP


603 
	`dmi_check_sy°em
(
sw_™y_bug_dmi_èbÀ
);

604 i‡(
bios_wôh_sw_™y_bug
 && 
	`˝umask_weight
(
pﬁicy
->
˝us
) == 1) {

605 
pﬁicy
->
sh¨ed_ty≥
 = 
CPUFREQ_SHARED_TYPE_ALL
;

606 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

611 i‡(
≥rf
->
°©e_cou¡
 <= 1) {

612 
	`d¥ötk
("No P-States\n");

613 
ªsu…
 = -
ENODEV
;

614 
îr_uƒeg
;

617 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 !≥rf->
°©us_ªgi°î
.space_id) {

618 
ªsu…
 = -
ENODEV
;

619 
îr_uƒeg
;

622 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

623 
ACPI_ADR_SPACE_SYSTEM_IO
:

624 
	`d¥ötk
("SYSTEM IOáddr space\n");

625 
d©a
->
˝u_„©uª
 = 
SYSTEM_IO_CAPABLE
;

627 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

628 
	`d¥ötk
("HARDWAREáddr space\n");

629 i‡(!
	`check_e°_˝u
(
˝u
)) {

630 
ªsu…
 = -
ENODEV
;

631 
îr_uƒeg
;

633 
d©a
->
˝u_„©uª
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

636 
	`d¥ötk
("Unknownáddr space %d\n",

637 (
u32
Ë(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
));

638 
ªsu…
 = -
ENODEV
;

639 
îr_uƒeg
;

642 
d©a
->
‰eq_èbÀ
 = 
	`kmÆloc
((
˝u‰eq_‰equícy_èbÀ
) *

643 (
≥rf
->
°©e_cou¡
+1), 
GFP_KERNEL
);

644 i‡(!
d©a
->
‰eq_èbÀ
) {

645 
ªsu…
 = -
ENOMEM
;

646 
îr_uƒeg
;

650 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 0;

651 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

652 i‡((
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000) >

653 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
)

654 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 =

655 
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000;

659 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 =
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

660 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 > 20 * 1000) {

661 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 20 * 1000;

662 
	`¥ötk_⁄˚
(
KERN_INFO


667 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

668 i‡(
i
 > 0 && 
≥rf
->
°©es
[i].
c‹e_‰equícy
 >=

669 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
-1].
‰equícy
 / 1000)

672 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
ödex
 = 
i
;

673 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 =

674 
≥rf
->
°©es
[
i
].
c‹e_‰equícy
 * 1000;

675 
vÆid_°©es
++;

677 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 = 
CPUFREQ_TABLE_END
;

678 
≥rf
->
°©e
 = 0;

680 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_˝uöfo
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

681 i‡(
ªsu…
)

682 
îr_‰eq‰ì
;

684 i‡(
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000 !
pﬁicy
->
˝uöfo
.
max_‰eq
)

685 
	`¥ötk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 isÇot max freq\n");

687 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

688 
ACPI_ADR_SPACE_SYSTEM_IO
:

690 
pﬁicy
->
cur
 = 
	`a˝i_˝u‰eq_guess_‰eq
(
d©a
,Öﬁicy->
˝u
);

692 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

693 
a˝i_˝u‰eq_drivî
.
gë
 = 
gë_cur_‰eq_⁄_˝u
;

694 
pﬁicy
->
cur
 = 
	`gë_cur_‰eq_⁄_˝u
(
˝u
);

701 
	`a˝i_¥o˚ss‹_nŸify_smm
(
THIS_MODULE
);

704 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_APERFMPERF
))

705 
a˝i_˝u‰eq_drivî
.
gëavg
 = 
gë_mósuªd_≥rf
;

707 
	`d¥ötk
("CPU%u - ACPIÖîf‹m™˚ m™agemíàa˘iv©ed.\n", 
˝u
);

708 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++)

709 
	`d¥ötk
(" %cP%d: %d MHz, %d mW, %d uS\n",

710 (
i
 =
≥rf
->
°©e
 ? '*' : ' '), i,

711 (
u32
Ë
≥rf
->
°©es
[
i
].
c‹e_‰equícy
,

712 (
u32
Ë
≥rf
->
°©es
[
i
].
powî
,

713 (
u32
Ë
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
);

715 
	`˝u‰eq_‰equícy_èbÀ_gë_©å
(
d©a
->
‰eq_èbÀ
, 
pﬁicy
->
˝u
);

721 
d©a
->
ªsume
 = 1;

723  
ªsu…
;

725 
îr_‰eq‰ì
:

726 
	`k‰ì
(
d©a
->
‰eq_èbÀ
);

727 
îr_uƒeg
:

728 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
≥rf
, 
˝u
);

729 
îr_‰ì
:

730 
	`k‰ì
(
d©a
);

731 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
NULL
;

733  
ªsu…
;

734 
	}
}

736 
	$a˝i_˝u‰eq_˝u_exô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

738 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

740 
	`d¥ötk
("acpi_cpufreq_cpu_exit\n");

742 i‡(
d©a
) {

743 
	`˝u‰eq_‰equícy_èbÀ_put_©å
(
pﬁicy
->
˝u
);

744 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
Ë
NULL
;

745 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
,

746 
pﬁicy
->
˝u
);

747 
	`k‰ì
(
d©a
);

751 
	}
}

753 
	$a˝i_˝u‰eq_ªsume
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

755 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

757 
	`d¥ötk
("acpi_cpufreq_resume\n");

759 
d©a
->
ªsume
 = 1;

762 
	}
}

764 
‰eq_©å
 *
	ga˝i_˝u‰eq_©å
[] = {

765 &
˝u‰eq_‰eq_©å_sˇlög_avaûabÀ_‰eqs
,

766 
NULL
,

769 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
 = {

770 .
vîify
 = 
a˝i_˝u‰eq_vîify
,

771 .
	gèrgë
 = 
a˝i_˝u‰eq_èrgë
,

772 .
	gbios_limô
 = 
a˝i_¥o˚ss‹_gë_bios_limô
,

773 .
	göô
 = 
a˝i_˝u‰eq_˝u_öô
,

774 .
	gexô
 = 
a˝i_˝u‰eq_˝u_exô
,

775 .
	gªsume
 = 
a˝i_˝u‰eq_ªsume
,

776 .
	g«me
 = "acpi-cpufreq",

777 .
	gow√r
 = 
THIS_MODULE
,

778 .
	g©å
 = 
a˝i_˝u‰eq_©å
,

781 
__öô
 
	$a˝i_˝u‰eq_öô
()

783 
ªt
;

785 i‡(
a˝i_dißbÀd
)

788 
	`d¥ötk
("acpi_cpufreq_init\n");

790 
ªt
 = 
	`a˝i_˝u‰eq_óæy_öô
();

791 i‡(
ªt
)

792  
ªt
;

794 
ªt
 = 
	`˝u‰eq_ªgi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

795 i‡(
ªt
)

796 
	`‰ì_a˝i_≥rf_d©a
();

798  
ªt
;

799 
	}
}

801 
__exô
 
	$a˝i_˝u‰eq_exô
()

803 
	`d¥ötk
("acpi_cpufreq_exit\n");

805 
	`˝u‰eq_uƒegi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

807 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

808 
	}
}

810 
moduÀ_∑øm
(
a˝i_p°©e_°ri˘
, 
uöt
, 0644);

811 
MODULE_PARM_DESC
(
a˝i_p°©e_°ri˘
,

815 
œã_öôˇŒ
(
a˝i_˝u‰eq_öô
);

816 
moduÀ_exô
(
a˝i_˝u‰eq_exô
);

818 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/vmw¨e.h
>

26 
	~<asm/hy≥rvis‹.h
>

28 
ölöe
 
__˝uöô


29 
	$dëe˘_hy≥rvis‹_víd‹
(
˝uöfo_x86
 *
c
)

31 i‡(
	`vmw¨e_∂©f‹m
())

32 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_VMWARE
;

34 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_NONE
;

35 
	}
}

37 
ölöe
 
__˝uöô


38 
	$hy≥rvis‹_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

40 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
) {

41 
	`vmw¨e_£t_„©uª_bôs
(
c
);

44 
	}
}

46 
__˝uöô
 
	$öô_hy≥rvis‹
(
˝uöfo_x86
 *
c
)

48 
	`dëe˘_hy≥rvis‹_víd‹
(
c
);

49 
	`hy≥rvis‹_£t_„©uª_bôs
(
c
);

50 
	}
}

52 
__öô
 
	$öô_hy≥rvis‹_∂©f‹m
()

54 
	`öô_hy≥rvis‹
(&
boŸ_˝u_d©a
);

55 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
)

56 
	`vmw¨e_∂©f‹m_£tup
();

57 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<löux/öô.h
>

2 
	~<löux/kî√l.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/bô›s.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/thªad_öfo.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/uac˚ss.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/pgèbÀ.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/ds.h
>

16 
	~<asm/bugs.h
>

17 
	~<asm/˝u.h
>

19 #ifde‡
CONFIG_X86_64


20 
	~<löux/t›ﬁogy.h
>

21 
	~<asm/numa_64.h
>

24 
	~"˝u.h
"

26 #ifde‡
CONFIG_X86_LOCAL_APIC


27 
	~<asm/mp•ec.h
>

28 
	~<asm/≠ic.h
>

31 
__˝uöô
 
	$óæy_öô_öãl
(
˝uöfo_x86
 *
c
)

34 i‡(
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xd)) {

35 
u64
 
misc_íabÀ
;

37 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

39 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

40 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

41 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

42 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

46 i‡((
c
->
x86
 =0x‡&& c->
x86_modñ
 >= 0x03) ||

47 (
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0x0e))

48 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

58 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =0x1¯&& c->
x86_mask
 <= 2) {

59 
u32
 
ucode
, 
junk
;

61 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

62 
	`sync_c‹e
();

63 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
junk
, 
ucode
);

65 i‡(
ucode
 < 0x20e) {

66 
	`¥ötk
(
KERN_WARNING
 "Atom PSEÉrratum detected, BIOS microcode updateÑecommended\n");

67 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PSE
);

71 #ifde‡
CONFIG_X86_64


72 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

75 i‡(
c
->
x86
 =15 && c->
x86_ˇche_Æignmít
 == 64)

76 
c
->
x86_ˇche_Æignmít
 = 128;

80 i‡(
c
->
x86
 =0xF && c->
x86_modñ
 == 0x3

81 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

82 
c
->
x86_phys_bôs
 = 36;

91 i‡(
c
->
x86_powî
 & (1 << 8)) {

92 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

93 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

94 i‡(!
	`check_tsc_un°abÀ
())

95 
sched_˛ock_°abÀ
 = 1;

108 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 15)

109 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PAT
);

111 #ifde‡
CONFIG_KMEMCHECK


120 i‡(
c
->
x86
 == 15) {

121 
u64
 
misc_íabÀ
;

123 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

125 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_FAST_STRING
) {

126 
	`¥ötk
(
KERN_INFO
 "kmemcheck: Disabling fast string operations\n");

128 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_FAST_STRING
;

129 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

133 
	}
}

135 #ifde‡
CONFIG_X86_32


142 
__˝uöô
 
	$µro_wôh_øm_bug
()

145 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

146 
boŸ_˝u_d©a
.
x86
 == 6 &&

147 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

148 
boŸ_˝u_d©a
.
x86_mask
 < 8) {

149 
	`¥ötk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. TakingÉvasiveáction.\n");

153 
	}
}

155 #ifde‡
CONFIG_X86_F00F_BUG


156 
__˝uöô
 
	$å≠_öô_f00f_bug
()

158 
	`__£t_fixm≠
(
FIX_F00F_IDT
, 
	`__∑
(&
idt_èbÀ
), 
PAGE_KERNEL_RO
);

164 
idt_des¸
.
addªss
 = 
	`fix_to_vút
(
FIX_F00F_IDT
);

165 
	`lﬂd_idt
(&
idt_des¸
);

166 
	}
}

169 
__˝uöô
 
	$öãl_smp_check
(
˝uöfo_x86
 *
c
)

171 #ifde‡
CONFIG_SMP


173 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

179 i‡(
c
->
x86
 == 5 &&

180 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

181 
c
->
x86_modñ
 <= 3) {

185 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

189 
	}
}

191 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

193 
lo
, 
hi
;

195 #ifde‡
CONFIG_X86_F00F_BUG


202 
c
->
f00f_bug
 = 0;

203 i‡(!
	`∑øvút_íabÀd
(Ë&& 
c
->
x86
 == 5) {

204 
f00f_w‹k¨ound_íabÀd
;

206 
c
->
f00f_bug
 = 1;

207 i‡(!
f00f_w‹k¨ound_íabÀd
) {

208 
	`å≠_öô_f00f_bug
();

209 
	`¥ötk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundÉnabled.\n");

210 
f00f_w‹k¨ound_íabÀd
 = 1;

219 i‡((
c
->
x86
<<8 | c->
x86_modñ
<<4 | c->
x86_mask
) < 0x633)

220 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_SEP
);

226 i‡((
c
->
x86
 =15Ë&& (c->
x86_modñ
 =1Ë&& (c->
x86_mask
 == 1)) {

227 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

228 i‡((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

229 
	`¥ötk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

230 
	`¥ötk
 (
KERN_INFO
 "CPU: Disabling hardwareÖrefetching (Errata 037)\n");

231 
lo
 |
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

232 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

242 i‡(
˝u_has_≠ic
 && (
c
->
x86
<<8 | c->
x86_modñ
<<4) == 0x520 &&

243 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

244 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_11AP
);

247 #ifde‡
CONFIG_X86_INTEL_USERCOPY


251 
c
->
x86
) {

257 
mov¶_mask
.
mask
 = 7;

260 
mov¶_mask
.
mask
 = 7;

265 #ifde‡
CONFIG_X86_NUMAQ


266 
	`numaq_tsc_dißbÀ
();

269 
	`öãl_smp_check
(
c
);

270 
	}
}

272 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

274 
	}
}

277 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

279 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

280 
node
;

281 
˝u
 = 
	`smp_¥o˚ss‹_id
();

282 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

286 
node
 = 
≠icid_to_node
[
≠icid
];

287 i‡(
node
 =
NUMA_NO_NODE
)

288 
node
 = 
	`fú°_node
(
node_⁄löe_m≠
);

289 i‡(!
	`node_⁄löe
(
node
)) {

291 
node
 = 
	`˝u_to_node
(
˝u
);

293 
	`numa_£t_node
(
˝u
, 
node
);

295 
	}
}

300 
__˝uöô
 
	$öãl_num_˝u_c‹es
(
˝uöfo_x86
 *
c
)

302 
óx
, 
ebx
, 
ecx
, 
edx
;

304 i‡(
c
->
˝uid_Àvñ
 < 4)

308 
	`˝uid_cou¡
(4, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

309 i‡(
óx
 & 0x1f)

310  (
óx
 >> 26) + 1;

313 
	}
}

315 
__˝uöô
 
	$dëe˘_vmx_vútˇp
(
˝uöfo_x86
 *
c
)

318 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

319 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

320 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

321 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

322 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

323 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

325 
u32
 
vmx_m§_low
, 
vmx_m§_high
, 
m§_˘l
, 
m§_˘l2
;

327 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

328 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

329 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

330 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

331 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

333 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m§_low
, 
vmx_m§_high
);

334 
m§_˘l
 = 
vmx_m§_high
 | 
vmx_m§_low
;

335 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

337 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

338 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

339 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

340 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

341 
vmx_m§_low
, 
vmx_m§_high
);

342 
m§_˘l2
 = 
vmx_m§_high
 | 
vmx_m§_low
;

343 i‡((
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

344 (
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

345 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

346 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

347 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

348 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

349 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

351 
	}
}

353 
__˝uöô
 
	$öô_öãl
(
˝uöfo_x86
 *
c
)

355 
l2
 = 0;

357 
	`óæy_öô_öãl
(
c
);

359 
	`öãl_w‹k¨ounds
(
c
);

366 
	`dëe˘_exãnded_t›ﬁogy
(
c
);

368 
l2
 = 
	`öô_öãl_ˇcheöfo
(
c
);

369 i‡(
c
->
˝uid_Àvñ
 > 9) {

370 
óx
 = 
	`˝uid_óx
(10);

372 i‡((
óx
 & 0xff) && (((eax>>8) & 0xff) > 1))

373 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

376 i‡(
c
->
˝uid_Àvñ
 > 6) {

377 
ecx
 = 
	`˝uid_ecx
(6);

378 i‡(
ecx
 & 0x01)

379 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_APERFMPERF
);

382 i‡(
˝u_has_xmm2
)

383 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

384 i‡(
˝u_has_ds
) {

385 
l1
;

386 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

387 i‡(!(
l1
 & (1<<11)))

388 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_BTS
);

389 i‡(!(
l1
 & (1<<12)))

390 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PEBS
);

391 
	`ds_öô_öãl
(
c
);

394 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =29 && 
˝u_has_˛Êush
)

395 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

397 #ifde‡
CONFIG_X86_64


398 i‡(
c
->
x86
 == 15)

399 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

400 i‡(
c
->
x86
 == 6)

401 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

408 i‡(
c
->
x86
 == 6) {

409 *
p
 = 
NULL
;

411 
c
->
x86_modñ
) {

413 i‡(
c
->
x86_mask
 == 0) {

414 i‡(
l2
 == 0)

415 
p
 = "Celeron (Covington)";

416 i‡(
l2
 == 256)

417 
p
 = "Mobile Pentium II (Dixon)";

422 i‡(
l2
 == 128)

423 
p
 = "Celeron (Mendocino)";

424 i‡(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

425 
p
 = "Celeron-A";

429 i‡(
l2
 == 128)

430 
p
 = "Celeron (Coppermine)";

434 i‡(
p
)

435 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

438 i‡(
c
->
x86
 == 15)

439 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P4
);

440 i‡(
c
->
x86
 == 6)

441 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P3
);

444 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

449 
c
->
x86_max_c‹es
 = 
	`öãl_num_˝u_c‹es
(c);

450 #ifde‡
CONFIG_X86_32


451 
	`dëe˘_ht
(
c
);

456 
	`§©_dëe˘_node
(
c
);

458 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_VMX
))

459 
	`dëe˘_vmx_vútˇp
(
c
);

460 
	}
}

462 #ifde‡
CONFIG_X86_32


463 
__˝uöô
 
	$öãl_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

471 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 =11Ë&& (
size
 == 0))

472 
size
 = 256;

473  
size
;

474 
	}
}

477 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	göãl_˝u_dev
 = {

478 .
c_víd‹
 = "Intel",

479 .
	gc_idít
 = { "GenuineIntel" },

480 #ifde‡
CONFIG_X86_32


481 .
	gc_modñs
 = {

482 { .
víd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

495 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 5, .
	gmodñ_«mes
 =

506 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 6, .
	gmodñ_«mes
 =

520 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 15, .
	gmodñ_«mes
 =

530 .
	gc_size_ˇche
 = 
öãl_size_ˇche
,

532 .
	gc_óæy_öô
 = 
óæy_öô_öãl
,

533 .
	gc_öô
 = 
öô_öãl
,

534 .
	gc_x86_víd‹
 = 
X86_VENDOR_INTEL
,

537 
˝u_dev_ªgi°î
(
öãl_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<löux/öô.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/˝u.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<löux/smp.h
>

20 
	~<asm/k8.h
>

21 
	~<asm/smp.h
>

23 
	#LVL_1_INST
 1

	)

24 
	#LVL_1_DATA
 2

	)

25 
	#LVL_2
 3

	)

26 
	#LVL_3
 4

	)

27 
	#LVL_TRACE
 5

	)

29 
	s_ˇche_èbÀ
 {

30 
	mdes¸ùt‹
;

31 
	mˇche_ty≥
;

32 
	msize
;

35 
	#MB
(
x
Ë((xË* 1024)

	)

40 c⁄° 
_ˇche_èbÀ
 
__˝uöôc⁄°
 
	gˇche_èbÀ
[] =

42 { 0x06, 
LVL_1_INST
, 8 },

43 { 0x08, 
LVL_1_INST
, 16 },

44 { 0x09, 
LVL_1_INST
, 32 },

45 { 0x0a, 
LVL_1_DATA
, 8 },

46 { 0x0c, 
LVL_1_DATA
, 16 },

47 { 0x0d, 
LVL_1_DATA
, 16 },

48 { 0x21, 
LVL_2
, 256 },

49 { 0x22, 
LVL_3
, 512 },

50 { 0x23, 
LVL_3
, 
MB
(1) },

51 { 0x25, 
LVL_3
, 
MB
(2) },

52 { 0x29, 
LVL_3
, 
MB
(4) },

53 { 0x2c, 
LVL_1_DATA
, 32 },

54 { 0x30, 
LVL_1_INST
, 32 },

55 { 0x39, 
LVL_2
, 128 },

56 { 0x3a, 
LVL_2
, 192 },

57 { 0x3b, 
LVL_2
, 128 },

58 { 0x3c, 
LVL_2
, 256 },

59 { 0x3d, 
LVL_2
, 384 },

60 { 0x3e, 
LVL_2
, 512 },

61 { 0x3f, 
LVL_2
, 256 },

62 { 0x41, 
LVL_2
, 128 },

63 { 0x42, 
LVL_2
, 256 },

64 { 0x43, 
LVL_2
, 512 },

65 { 0x44, 
LVL_2
, 
MB
(1) },

66 { 0x45, 
LVL_2
, 
MB
(2) },

67 { 0x46, 
LVL_3
, 
MB
(4) },

68 { 0x47, 
LVL_3
, 
MB
(8) },

69 { 0x49, 
LVL_3
, 
MB
(4) },

70 { 0x4a, 
LVL_3
, 
MB
(6) },

71 { 0x4b, 
LVL_3
, 
MB
(8) },

72 { 0x4c, 
LVL_3
, 
MB
(12) },

73 { 0x4d, 
LVL_3
, 
MB
(16) },

74 { 0x4e, 
LVL_2
, 
MB
(6) },

75 { 0x60, 
LVL_1_DATA
, 16 },

76 { 0x66, 
LVL_1_DATA
, 8 },

77 { 0x67, 
LVL_1_DATA
, 16 },

78 { 0x68, 
LVL_1_DATA
, 32 },

79 { 0x70, 
LVL_TRACE
, 12 },

80 { 0x71, 
LVL_TRACE
, 16 },

81 { 0x72, 
LVL_TRACE
, 32 },

82 { 0x73, 
LVL_TRACE
, 64 },

83 { 0x78, 
LVL_2
, 
MB
(1) },

84 { 0x79, 
LVL_2
, 128 },

85 { 0x7a, 
LVL_2
, 256 },

86 { 0x7b, 
LVL_2
, 512 },

87 { 0x7c, 
LVL_2
, 
MB
(1) },

88 { 0x7d, 
LVL_2
, 
MB
(2) },

89 { 0x7f, 
LVL_2
, 512 },

90 { 0x82, 
LVL_2
, 256 },

91 { 0x83, 
LVL_2
, 512 },

92 { 0x84, 
LVL_2
, 
MB
(1) },

93 { 0x85, 
LVL_2
, 
MB
(2) },

94 { 0x86, 
LVL_2
, 512 },

95 { 0x87, 
LVL_2
, 
MB
(1) },

96 { 0xd0, 
LVL_3
, 512 },

97 { 0xd1, 
LVL_3
, 
MB
(1) },

98 { 0xd2, 
LVL_3
, 
MB
(2) },

99 { 0xd6, 
LVL_3
, 
MB
(1) },

100 { 0xd7, 
LVL_3
, 
MB
(2) },

101 { 0xd8, 
LVL_3
, 
MB
(4) },

102 { 0xdc, 
LVL_3
, 
MB
(2) },

103 { 0xdd, 
LVL_3
, 
MB
(4) },

104 { 0xde, 
LVL_3
, 
MB
(8) },

105 { 0xe2, 
LVL_3
, 
MB
(2) },

106 { 0xe3, 
LVL_3
, 
MB
(4) },

107 { 0xe4, 
LVL_3
, 
MB
(8) },

108 { 0xó, 
LVL_3
, 
MB
(12) },

109 { 0xeb, 
LVL_3
, 
MB
(18) },

110 { 0xec, 
LVL_3
, 
MB
(24) },

115 
	e_ˇche_ty≥
 {

116 
	mCACHE_TYPE_NULL
 = 0,

117 
	mCACHE_TYPE_DATA
 = 1,

118 
	mCACHE_TYPE_INST
 = 2,

119 
	mCACHE_TYPE_UNIFIED
 = 3

122 
	u_˝uid4_Àaf_óx
 {

124 
_ˇche_ty≥
 
	mty≥
:5;

125 
	mÀvñ
:3;

126 
	mis_£lf_öôülizög
:1;

127 
	mis_fuŒy_assocütive
:1;

128 
	mª£rved
:4;

129 
	mnum_thªads_sh¨ög
:12;

130 
	mnum_c‹es_⁄_dõ
:6;

131 } 
	m•lô
;

132 
u32
 
	mfuŒ
;

135 
	u_˝uid4_Àaf_ebx
 {

137 
	mcohîícy_löe_size
:12;

138 
	mphysiˇl_löe_∑πôi⁄
:10;

139 
	mways_of_assocütivôy
:10;

140 } 
	m•lô
;

141 
u32
 
	mfuŒ
;

144 
	u_˝uid4_Àaf_ecx
 {

146 
	mnumbî_of_£ts
:32;

147 } 
	m•lô
;

148 
u32
 
	mfuŒ
;

151 
	s_˝uid4_öfo
 {

152 
_˝uid4_Àaf_óx
 
	móx
;

153 
_˝uid4_Àaf_ebx
 
	mebx
;

154 
_˝uid4_Àaf_ecx
 
	mecx
;

155 
	msize
;

156 
boﬁ
 
	mˇn_dißbÀ
;

157 
	ml3_ödi˚s
;

158 
DECLARE_BITMAP
(
sh¨ed_˝u_m≠
, 
NR_CPUS
);

162 
	s_˝uid4_öfo_ªgs
 {

163 
_˝uid4_Àaf_óx
 
	móx
;

164 
_˝uid4_Àaf_ebx
 
	mebx
;

165 
_˝uid4_Àaf_ecx
 
	mecx
;

166 
	msize
;

167 
boﬁ
 
	mˇn_dißbÀ
;

168 
	ml3_ödi˚s
;

171 
	gnum_ˇche_Àaves
;

179 
	ul1_ˇche
 {

181 
	mlöe_size
:8;

182 
	mlöes_≥r_èg
:8;

183 
	massoc
:8;

184 
	msize_ö_kb
:8;

186 
	mvÆ
;

189 
	ul2_ˇche
 {

191 
	mlöe_size
:8;

192 
	mlöes_≥r_èg
:4;

193 
	massoc
:4;

194 
	msize_ö_kb
:16;

196 
	mvÆ
;

199 
	ul3_ˇche
 {

201 
	mlöe_size
:8;

202 
	mlöes_≥r_èg
:4;

203 
	massoc
:4;

204 
	mªs
:2;

205 
	msize_ícoded
:14;

207 
	mvÆ
;

210 c⁄° 
__˝uöôc⁄°
 
	gassocs
[] = {

224 c⁄° 
__˝uöôc⁄°
 
	gÀvñs
[] = { 1, 1, 2, 3 };

225 c⁄° 
__˝uöôc⁄°
 
	gty≥s
[] = { 1, 2, 3, 3 };

227 
__˝uöô


228 
	$amd_˝uid4
(
Àaf
, 
_˝uid4_Àaf_óx
 *
óx
,

229 
_˝uid4_Àaf_ebx
 *
ebx
,

230 
_˝uid4_Àaf_ecx
 *
ecx
)

232 
dummy
;

233 
löe_size
, 
löes_≥r_èg
, 
assoc
, 
size_ö_kb
;

234 
l1_ˇche
 
l1i
, 
l1d
;

235 
l2_ˇche
 
l2
;

236 
l3_ˇche
 
l3
;

237 
l1_ˇche
 *
l1
 = &
l1d
;

239 
óx
->
fuŒ
 = 0;

240 
ebx
->
fuŒ
 = 0;

241 
ecx
->
fuŒ
 = 0;

243 
	`˝uid
(0x80000005, &
dummy
, &dummy, &
l1d
.
vÆ
, &
l1i
.val);

244 
	`˝uid
(0x80000006, &
dummy
, &dummy, &
l2
.
vÆ
, &
l3
.val);

246 
Àaf
) {

248 
l1
 = &
l1i
;

250 i‡(!
l1
->
vÆ
)

252 
assoc
 = 
assocs
[
l1
->assoc];

253 
löe_size
 = 
l1
->line_size;

254 
löes_≥r_èg
 = 
l1
->lines_per_tag;

255 
size_ö_kb
 = 
l1
->size_in_kb;

258 i‡(!
l2
.
vÆ
)

260 
assoc
 = 
assocs
[
l2
.assoc];

261 
löe_size
 = 
l2
.line_size;

262 
löes_≥r_èg
 = 
l2
.lines_per_tag;

264 
size_ö_kb
 = 
cuºít_˝u_d©a
.
x86_ˇche_size
;

267 i‡(!
l3
.
vÆ
)

269 
assoc
 = 
assocs
[
l3
.assoc];

270 
löe_size
 = 
l3
.line_size;

271 
löes_≥r_èg
 = 
l3
.lines_per_tag;

272 
size_ö_kb
 = 
l3
.
size_ícoded
 * 512;

273 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_AMD_DCM
)) {

274 
size_ö_kb
 = size_in_kb >> 1;

275 
assoc
 =ássoc >> 1;

282 
óx
->
•lô
.
is_£lf_öôülizög
 = 1;

283 
óx
->
•lô
.
ty≥
 = 
ty≥s
[
Àaf
];

284 
óx
->
•lô
.
Àvñ
 = 
Àvñs
[
Àaf
];

285 
óx
->
•lô
.
num_thªads_sh¨ög
 = 0;

286 
óx
->
•lô
.
num_c‹es_⁄_dõ
 = 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

289 i‡(
assoc
 == 0xffff)

290 
óx
->
•lô
.
is_fuŒy_assocütive
 = 1;

291 
ebx
->
•lô
.
cohîícy_löe_size
 = 
löe_size
 - 1;

292 
ebx
->
•lô
.
ways_of_assocütivôy
 = 
assoc
 - 1;

293 
ebx
->
•lô
.
physiˇl_löe_∑πôi⁄
 = 
löes_≥r_èg
 - 1;

294 
ecx
->
•lô
.
numbî_of_£ts
 = (
size_ö_kb
 * 1024Ë/ 
löe_size
 /

295 (
ebx
->
•lô
.
ways_of_assocütivôy
 + 1) - 1;

296 
	}
}

298 
	s_ˇche_©å
 {

299 
©åibuã
 
	m©å
;

300 
ssize_t
 (*
show
)(
	m_˝uid4_öfo
 *, *);

301 
ssize_t
 (*
°‹e
)(
	m_˝uid4_öfo
 *, c⁄° *, 
size_t
 
	mcou¡
);

304 #ifde‡
CONFIG_CPU_SUP_AMD


305 
__˝uöô
 
	$amd_ˇlc_l3_ödi˚s
()

311 
˝u
 = 
	`smp_¥o˚ss‹_id
();

312 
node
 = 
	`˝u_to_node
(
˝u
);

313 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

314 
sc0
, 
sc1
, 
sc2
, 
sc3
;

315 
u32
 
vÆ
 = 0;

317 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1C4, &
vÆ
);

320 
sc0
 = !(
vÆ
 & 
	`BIT
(0));

321 
sc1
 = !(
vÆ
 & 
	`BIT
(4));

322 
sc2
 = !(
vÆ
 & 
	`BIT
(8)) + !(val & BIT(9));

323 
sc3
 = !(
vÆ
 & 
	`BIT
(12)) + !(val & BIT(13));

325  (
	`max
(max(max(
sc0
, 
sc1
), 
sc2
), 
sc3
) << 10) - 1;

326 
	}
}

328 
__˝uöô


329 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

331 i‡(
ödex
 < 3)

334 i‡(
boŸ_˝u_d©a
.
x86
 == 0x11)

338 i‡((
boŸ_˝u_d©a
.
x86
 == 0x10) &&

339 ((
boŸ_˝u_d©a
.
x86_modñ
 < 0x8) ||

340 (
boŸ_˝u_d©a
.
x86_mask
 < 0x1)))

344 i‡(
num_k8_n‹thbridges
 == 0)

347 
this_Àaf
->
ˇn_dißbÀ
 = 
åue
;

348 
this_Àaf
->
l3_ödi˚s
 = 
	`amd_ˇlc_l3_ödi˚s
();

349 
	}
}

351 
ssize_t
 
	$show_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
,

352 
ödex
)

354 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

355 
node
 = 
	`amd_gë_nb_id
(
˝u
);

356 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

357 
ªg
 = 0;

359 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

360  -
EINVAL
;

362 i‡(!
dev
)

363  -
EINVAL
;

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, &
ªg
);

366  
	`•rötf
(
buf
, "0x%08x\n", 
ªg
);

367 
	}
}

369 
	#SHOW_CACHE_DISABLE
(
ödex
) \

370 
ssize_t
 \

371 
show_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

373  
	`show_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
ödex
); \

374 }

	)

375 
	$SHOW_CACHE_DISABLE
(0)

376 
	$SHOW_CACHE_DISABLE
(1)

378 
ssize_t
 
	$°‹e_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
,

379 c⁄° *
buf
, 
size_t
 
cou¡
, 
ödex
)

381 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

382 
node
 = 
	`amd_gë_nb_id
(
˝u
);

383 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

384 
vÆ
 = 0;

386 
	#SUBCACHE_MASK
 (3UL << 20)

	)

387 
	#SUBCACHE_INDEX
 0xfff

	)

389 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

390  -
EINVAL
;

392 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

393  -
EPERM
;

395 i‡(!
dev
)

396  -
EINVAL
;

398 i‡(
	`°ri˘_°πoul
(
buf
, 10, &
vÆ
) < 0)

399  -
EINVAL
;

402 i‡((
vÆ
 & ~(
SUBCACHE_MASK
 | 
SUBCACHE_INDEX
)) ||

403 ((
vÆ
 & 
SUBCACHE_INDEX
Ë> 
this_Àaf
->
l3_ödi˚s
))

404  -
EINVAL
;

406 
vÆ
 |
	`BIT
(30);

407 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
);

412 
	`wbövd_⁄_˝u
(
˝u
);

413 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
 | 
	`BIT
(31));

414  
cou¡
;

415 
	}
}

417 
	#STORE_CACHE_DISABLE
(
ödex
) \

418 
ssize_t
 \

419 
°‹e_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, \

420 c⁄° *
buf
, 
size_t
 
cou¡
) \

422  
	`°‹e_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
cou¡
, 
ödex
); \

423 }

	)

424 
	$STORE_CACHE_DISABLE
(0)

425 
	$STORE_CACHE_DISABLE
(1)

427 
_ˇche_©å
 
ˇche_dißbÀ_0
 = 
	`__ATTR
(cache_disable_0, 0644,

428 
show_ˇche_dißbÀ_0
, 
°‹e_ˇche_dißbÀ_0
);

429 
_ˇche_©å
 
ˇche_dißbÀ_1
 = 
	`__ATTR
(cache_disable_1, 0644,

430 
show_ˇche_dißbÀ_1
, 
°‹e_ˇche_dißbÀ_1
);

433 
__˝uöô


434 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

436 
	}
};

440 
__˝uöô
 
	$˝uid4_ˇche_lookup_ªgs
(
ödex
,

441 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

443 
_˝uid4_Àaf_óx
 
óx
;

444 
_˝uid4_Àaf_ebx
 
ebx
;

445 
_˝uid4_Àaf_ecx
 
ecx
;

446 
edx
;

448 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) {

449 
	`amd_˝uid4
(
ödex
, &
óx
, &
ebx
, &
ecx
);

450 i‡(
boŸ_˝u_d©a
.
x86
 >= 0x10)

451 
	`amd_check_l3_dißbÀ
(
ödex
, 
this_Àaf
);

453 
	`˝uid_cou¡
(4, 
ödex
, &
óx
.
fuŒ
, &
ebx
.fuŒ, &
ecx
.fuŒ, &
edx
);

456 i‡(
óx
.
•lô
.
ty≥
 =
CACHE_TYPE_NULL
)

457  -
EIO
;

459 
this_Àaf
->
óx
 =Éax;

460 
this_Àaf
->
ebx
 =Ébx;

461 
this_Àaf
->
ecx
 =Écx;

462 
this_Àaf
->
size
 = (
ecx
.
•lô
.
numbî_of_£ts
 + 1) *

463 (
ebx
.
•lô
.
cohîícy_löe_size
 + 1) *

464 (
ebx
.
•lô
.
physiˇl_löe_∑πôi⁄
 + 1) *

465 (
ebx
.
•lô
.
ways_of_assocütivôy
 + 1);

467 
	}
}

469 
__˝uöô
 
	$föd_num_ˇche_Àaves
()

471 
óx
, 
ebx
, 
ecx
, 
edx
;

472 
_˝uid4_Àaf_óx
 
ˇche_óx
;

473 
i
 = -1;

476 ++
i
;

478 
	`˝uid_cou¡
(4, 
i
, &
óx
, &
ebx
, &
ecx
, &
edx
);

479 
ˇche_óx
.
fuŒ
 = 
óx
;

480 } 
ˇche_óx
.
•lô
.
ty≥
 !
CACHE_TYPE_NULL
);

481  
i
;

482 
	}
}

484 
__˝uöô
 
	$öô_öãl_ˇcheöfo
(
˝uöfo_x86
 *
c
)

487 
åa˚
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

488 
√w_l1d
 = 0, 
√w_l1i
 = 0;

489 
√w_l2
 = 0, 
√w_l3
 = 0, 
i
;

490 
l2_id
 = 0, 
l3_id
 = 0, 
num_thªads_sh¨ög
, 
ödex_msb
;

491 #ifde‡
CONFIG_X86_HT


492 
˝u
 = 
c
->
˝u_ödex
;

495 i‡(
c
->
˝uid_Àvñ
 > 3) {

496 
is_öôülized
;

498 i‡(
is_öôülized
 == 0) {

500 
num_ˇche_Àaves
 = 
	`föd_num_ˇche_Àaves
();

501 
is_öôülized
++;

508 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

509 
_˝uid4_öfo_ªgs
 
this_Àaf
;

510 
ªtvÆ
;

512 
ªtvÆ
 = 
	`˝uid4_ˇche_lookup_ªgs
(
i
, &
this_Àaf
);

513 i‡(
ªtvÆ
 >= 0) {

514 
this_Àaf
.
óx
.
•lô
.
Àvñ
) {

516 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

517 
CACHE_TYPE_DATA
)

518 
√w_l1d
 = 
this_Àaf
.
size
/1024;

519 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

520 
CACHE_TYPE_INST
)

521 
√w_l1i
 = 
this_Àaf
.
size
/1024;

524 
√w_l2
 = 
this_Àaf
.
size
/1024;

525 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

526 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

527 
l2_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

530 
√w_l3
 = 
this_Àaf
.
size
/1024;

531 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

532 
ödex_msb
 = 
	`gë_cou¡_‹dî
(

533 
num_thªads_sh¨ög
);

534 
l3_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

546 i‡((
num_ˇche_Àaves
 =0 || 
c
->
x86
 =15Ë&& c->
˝uid_Àvñ
 > 1) {

548 
j
, 
n
;

549 
ªgs
[4];

550 *
dp
 = (*)
ªgs
;

551 
⁄ly_åa˚
 = 0;

553 i‡(
num_ˇche_Àaves
 !0 && 
c
->
x86
 == 15)

554 
⁄ly_åa˚
 = 1;

557 
n
 = 
	`˝uid_óx
(2) & 0xFF;

559 
i
 = 0 ; i < 
n
 ; i++) {

560 
	`˝uid
(2, &
ªgs
[0], &regs[1], &regs[2], &regs[3]);

563 
j
 = 0 ; j < 3 ; j++)

564 i‡(
ªgs
[
j
] & (1 << 31))

565 
ªgs
[
j
] = 0;

568 
j
 = 1 ; j < 16 ; j++) {

569 
des
 = 
dp
[
j
];

570 
k
 = 0;

573 
ˇche_èbÀ
[
k
].
des¸ùt‹
 != 0) {

574 i‡(
ˇche_èbÀ
[
k
].
des¸ùt‹
 =
des
) {

575 i‡(
⁄ly_åa˚
 && 
ˇche_èbÀ
[
k
].
ˇche_ty≥
 !
LVL_TRACE
)

577 
ˇche_èbÀ
[
k
].
ˇche_ty≥
) {

578 
LVL_1_INST
:

579 
l1i
 +
ˇche_èbÀ
[
k
].
size
;

581 
LVL_1_DATA
:

582 
l1d
 +
ˇche_èbÀ
[
k
].
size
;

584 
LVL_2
:

585 
l2
 +
ˇche_èbÀ
[
k
].
size
;

587 
LVL_3
:

588 
l3
 +
ˇche_èbÀ
[
k
].
size
;

590 
LVL_TRACE
:

591 
åa˚
 +
ˇche_èbÀ
[
k
].
size
;

598 
k
++;

604 i‡(
√w_l1d
)

605 
l1d
 = 
√w_l1d
;

607 i‡(
√w_l1i
)

608 
l1i
 = 
√w_l1i
;

610 i‡(
√w_l2
) {

611 
l2
 = 
√w_l2
;

612 #ifde‡
CONFIG_X86_HT


613 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l2_id
;

617 i‡(
√w_l3
) {

618 
l3
 = 
√w_l3
;

619 #ifde‡
CONFIG_X86_HT


620 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l3_id
;

624 
c
->
x86_ˇche_size
 = 
l3
 ?Ü3 : (
l2
 ?Ü2 : (
l1i
+
l1d
));

626  
l2
;

627 
	}
}

629 #ifde‡
CONFIG_SYSFS


632 
DEFINE_PER_CPU
(
_˝uid4_öfo
 *, 
ici_˝uid4_öfo
);

633 
	#CPUID4_INFO_IDX
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_˝uid4_öfo
, x))[y]))

	)

635 #ifde‡
CONFIG_SMP


636 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

638 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

639 
num_thªads_sh¨ög
;

640 
ödex_msb
, 
i
, 
siblög
;

641 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

643 i‡((
ödex
 =3Ë&& (
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)) {

644 
	`f‹_óch_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
) {

645 i‡(!
	`≥r_˝u
(
ici_˝uid4_öfo
, 
i
))

647 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

648 
	`f‹_óch_˝u
(
siblög
, 
c
->
Œc_sh¨ed_m≠
) {

649 i‡(!
	`˝u_⁄löe
(
siblög
))

651 
	`£t_bô
(
siblög
, 
this_Àaf
->
sh¨ed_˝u_m≠
);

656 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

657 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
->
óx
.
•lô
.num_threads_sharing;

659 i‡(
num_thªads_sh¨ög
 == 1)

660 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

662 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

664 
	`f‹_óch_⁄löe_˝u
(
i
) {

665 i‡(
	`˝u_d©a
(
i
).
≠icid
 >> 
ödex_msb
 ==

666 
c
->
≠icid
 >> 
ödex_msb
) {

667 
	`˝umask_£t_˝u
(
i
,

668 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

669 i‡(
i
 !
˝u
 && 
	`≥r_˝u
(
ici_˝uid4_öfo
, i)) {

670 
siblög_Àaf
 =

671 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

672 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(

673 
siblög_Àaf
->
sh¨ed_˝u_m≠
));

678 
	}
}

679 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

681 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

682 
siblög
;

684 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

685 
	`f‹_óch_˝u
(
siblög
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
)) {

686 
siblög_Àaf
 = 
	`CPUID4_INFO_IDX
(
siblög
, 
ödex
);

687 
	`˝umask_˛ór_˝u
(
˝u
,

688 
	`to_˝umask
(
siblög_Àaf
->
sh¨ed_˝u_m≠
));

690 
	}
}

692 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

694 
	}
}

696 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

698 
	}
}

701 
__˝uöô
 
	$‰ì_ˇche_©åibuãs
(
˝u
)

703 
i
;

705 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

706 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

708 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

709 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

710 
	}
}

713 
__˝uöô
 
	$˝uid4_ˇche_lookup
(
ödex
, 
_˝uid4_öfo
 *
this_Àaf
)

715 
_˝uid4_öfo_ªgs
 *
Àaf_ªgs
 =

716 (
_˝uid4_öfo_ªgs
 *)
this_Àaf
;

718  
	`˝uid4_ˇche_lookup_ªgs
(
ödex
, 
Àaf_ªgs
);

719 
	}
}

721 
__˝uöô
 
	$gë_˝u_Àaves
(*
_ªtvÆ
)

723 
j
, *
ªtvÆ
 = 
_ªtvÆ
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

726 
j
 = 0; j < 
num_ˇche_Àaves
; j++) {

727 
_˝uid4_öfo
 *
this_Àaf
;

728 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
j
);

729 *
ªtvÆ
 = 
	`˝uid4_ˇche_lookup
(
j
, 
this_Àaf
);

730 i‡(
	`u∆ikñy
(*
ªtvÆ
 < 0)) {

731 
i
;

733 
i
 = 0; i < 
j
; i++)

734 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

737 
	`ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
j
);

739 
	}
}

741 
__˝uöô
 
	$dëe˘_ˇche_©åibuãs
(
˝u
)

743 
ªtvÆ
;

745 i‡(
num_ˇche_Àaves
 == 0)

746  -
ENOENT
;

748 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
	`kzÆloc
(

749 (
_˝uid4_öfo
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

750 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

751  -
ENOMEM
;

753 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
gë_˝u_Àaves
, &
ªtvÆ
, 
åue
);

754 i‡(
ªtvÆ
) {

755 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

756 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

759  
ªtvÆ
;

760 
	}
}

762 
	~<löux/kobje˘.h
>

763 
	~<löux/sysfs.h
>

765 
sysdev_˛ass
 
˝u_sysdev_˛ass
;

768 
DEFINE_PER_CPU
(
kobje˘
 *, 
ici_ˇche_kobje˘
);

770 
	s_ödex_kobje˘
 {

771 
kobje˘
 
	mkobj
;

772 
	m˝u
;

773 
	mödex
;

777 
DEFINE_PER_CPU
(
_ödex_kobje˘
 *, 
ici_ödex_kobje˘
);

778 
	#INDEX_KOBJECT_PTR
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_ödex_kobje˘
, x))[y]))

	)

780 
	#show_⁄e_∂us
(
fûe_«me
, 
obje˘
, 
vÆ
) \

781 
ssize_t
 
show_
##
fûe_«me
 \

782 (
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

784  
	`•rötf
(
buf
, "%lu\n", ()
this_Àaf
->
obje˘
 + 
vÆ
); \

785 }

	)

787 
show_⁄e_∂us
(
Àvñ
, 
óx
.
•lô
.level, 0);

788 
show_⁄e_∂us
(
cohîícy_löe_size
, 
ebx
.
•lô
.coherency_line_size, 1);

789 
show_⁄e_∂us
(
physiˇl_löe_∑πôi⁄
, 
ebx
.
•lô
.physical_line_partition, 1);

790 
show_⁄e_∂us
(
ways_of_assocütivôy
, 
ebx
.
•lô
.ways_of_associativity, 1);

791 
show_⁄e_∂us
(
numbî_of_£ts
, 
ecx
.
•lô
.number_of_sets, 1);

793 
ssize_t
 
	$show_size
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

795  
	`•rötf
(
buf
, "%luK\n", 
this_Àaf
->
size
 / 1024);

796 
	}
}

798 
ssize_t
 
	$show_sh¨ed_˝u_m≠_func
(
_˝uid4_öfo
 *
this_Àaf
,

799 
ty≥
, *
buf
)

801 
±rdiff_t
 
Àn
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

802 
n
 = 0;

804 i‡(
Àn
 > 1) {

805 c⁄° 
˝umask
 *
mask
;

807 
mask
 = 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
);

808 
n
 = 
ty≥
 ?

809 
	`˝uli°_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
) :

810 
	`˝umask_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
);

811 
buf
[
n
++] = '\n';

812 
buf
[
n
] = '\0';

814  
n
;

815 
	}
}

817 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_m≠
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

819  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 0, 
buf
);

820 
	}
}

822 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_li°
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

824  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 1, 
buf
);

825 
	}
}

827 
ssize_t
 
	$show_ty≥
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

829 
this_Àaf
->
óx
.
•lô
.
ty≥
) {

830 
CACHE_TYPE_DATA
:

831  
	`•rötf
(
buf
, "Data\n");

832 
CACHE_TYPE_INST
:

833  
	`•rötf
(
buf
, "Instruction\n");

834 
CACHE_TYPE_UNIFIED
:

835  
	`•rötf
(
buf
, "Unified\n");

837  
	`•rötf
(
buf
, "Unknown\n");

839 
	}
}

841 
	#to_obje˘
(
k
Ë
	`c⁄èöî_of
(k, 
_ödex_kobje˘
, 
kobj
)

	)

842 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
_ˇche_©å
, 
©å
)

	)

844 
	#deföe_⁄e_ro
(
_«me
) \

845 
_ˇche_©å
 
_«me
 = \

846 
	`__ATTR
(
_«me
, 0444, 
show_
##_«me, 
NULL
)

	)

848 
deföe_⁄e_ro
(
Àvñ
);

849 
deföe_⁄e_ro
(
ty≥
);

850 
deföe_⁄e_ro
(
cohîícy_löe_size
);

851 
deföe_⁄e_ro
(
physiˇl_löe_∑πôi⁄
);

852 
deföe_⁄e_ro
(
ways_of_assocütivôy
);

853 
deföe_⁄e_ro
(
numbî_of_£ts
);

854 
deföe_⁄e_ro
(
size
);

855 
deföe_⁄e_ro
(
sh¨ed_˝u_m≠
);

856 
deföe_⁄e_ro
(
sh¨ed_˝u_li°
);

858 
	#DEFAULT_SYSFS_CACHE_ATTRS
 \

859 &
ty≥
.
©å
, \

860 &
Àvñ
.
©å
, \

861 &
cohîícy_löe_size
.
©å
, \

862 &
physiˇl_löe_∑πôi⁄
.
©å
, \

863 &
ways_of_assocütivôy
.
©å
, \

864 &
numbî_of_£ts
.
©å
, \

865 &
size
.
©å
, \

866 &
sh¨ed_˝u_m≠
.
©å
, \

867 &
sh¨ed_˝u_li°
.
©å


	)

869 
©åibuã
 *
	gdeÁu…_©ås
[] = {

870 
DEFAULT_SYSFS_CACHE_ATTRS
,

871 
NULL


874 
©åibuã
 *
	gdeÁu…_l3_©ås
[] = {

875 
DEFAULT_SYSFS_CACHE_ATTRS
,

876 #ifde‡
CONFIG_CPU_SUP_AMD


877 &
ˇche_dißbÀ_0
.
©å
,

878 &
ˇche_dißbÀ_1
.
©å
,

880 
NULL


883 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

885 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

886 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

887 
ssize_t
 
ªt
;

889 
ªt
 = 
Áâr
->
show
 ?

890 
Áâr
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

891 
buf
) :

893  
ªt
;

894 
	}
}

896 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

897 c⁄° *
buf
, 
size_t
 
cou¡
)

899 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

900 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

901 
ssize_t
 
ªt
;

903 
ªt
 = 
Áâr
->
°‹e
 ?

904 
Áâr
->
	`°‹e
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

905 
buf
, 
cou¡
) :

907  
ªt
;

908 
	}
}

910 c⁄° 
sysfs_›s
 
	gsysfs_›s
 = {

911 .
show
 = show,

912 .
	g°‹e
 = 
°‹e
,

915 
kobj_ty≥
 
	gkty≥_ˇche
 = {

916 .
sysfs_›s
 = &sysfs_ops,

917 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

920 
kobj_ty≥
 
	gkty≥_≥r˝u_íåy
 = {

921 .
sysfs_›s
 = &sysfs_ops,

924 
__˝uöô
 
	$˝uid4_ˇche_sysfs_exô
(
˝u
)

926 
	`k‰ì
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

927 
	`k‰ì
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
));

928 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë
NULL
;

929 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
NULL
;

930 
	`‰ì_ˇche_©åibuãs
(
˝u
);

931 
	}
}

933 
__˝uöô
 
	$˝uid4_ˇche_sysfs_öô
(
˝u
)

935 
îr
;

937 i‡(
num_ˇche_Àaves
 == 0)

938  -
ENOENT
;

940 
îr
 = 
	`dëe˘_ˇche_©åibuãs
(
˝u
);

941 i‡(
îr
)

942  
îr
;

945 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
) =

946 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

947 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë=
NULL
))

948 
îr_out
;

950 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
	`kzÆloc
(

951 (
_ödex_kobje˘
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

952 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë=
NULL
))

953 
îr_out
;

957 
îr_out
:

958 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

959  -
ENOMEM
;

960 
	}
}

962 
DECLARE_BITMAP
(
ˇche_dev_m≠
, 
NR_CPUS
);

965 
__˝uöô
 
	$ˇche_add_dev
(
sys_devi˚
 * 
sys_dev
)

967 
˝u
 = 
sys_dev
->
id
;

968 
i
, 
j
;

969 
_ödex_kobje˘
 *
this_obje˘
;

970 
_˝uid4_öfo
 *
this_Àaf
;

971 
ªtvÆ
;

973 
ªtvÆ
 = 
	`˝uid4_ˇche_sysfs_öô
(
˝u
);

974 i‡(
	`u∆ikñy
(
ªtvÆ
 < 0))

975  
ªtvÆ
;

977 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

978 &
kty≥_≥r˝u_íåy
,

979 &
sys_dev
->
kobj
, "%s", "cache");

980 i‡(
ªtvÆ
 < 0) {

981 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

982  
ªtvÆ
;

985 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

986 
this_obje˘
 = 
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
);

987 
this_obje˘
->
˝u
 = cpu;

988 
this_obje˘
->
ödex
 = 
i
;

990 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
i
);

992 i‡(
this_Àaf
->
ˇn_dißbÀ
)

993 
kty≥_ˇche
.
deÁu…_©ås
 = 
deÁu…_l3_©ås
;

995 
kty≥_ˇche
.
deÁu…_©ås
 = default_attrs;

997 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(&(
this_obje˘
->
kobj
),

998 &
kty≥_ˇche
,

999 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

1000 "ödex%1lu", 
i
);

1001 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

1002 
j
 = 0; j < 
i
; j++)

1003 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
j
)->
kobj
));

1004 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

1005 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1006  
ªtvÆ
;

1008 
	`kobje˘_uevít
(&(
this_obje˘
->
kobj
), 
KOBJ_ADD
);

1010 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

1012 
	`kobje˘_uevít
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
), 
KOBJ_ADD
);

1014 
	}
}

1016 
__˝uöô
 
	$ˇche_ªmove_dev
(
sys_devi˚
 * 
sys_dev
)

1018 
˝u
 = 
sys_dev
->
id
;

1019 
i
;

1021 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

1023 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
)))

1025 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

1027 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

1028 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
)->
kobj
));

1029 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

1030 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1031 
	}
}

1033 
__˝uöô
 
	$ˇcheöfo_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

1034 
a˘i⁄
, *
h˝u
)

1036 
˝u
 = ()
h˝u
;

1037 
sys_devi˚
 *
sys_dev
;

1039 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

1040 
a˘i⁄
) {

1041 
CPU_ONLINE
:

1042 
CPU_ONLINE_FROZEN
:

1043 
	`ˇche_add_dev
(
sys_dev
);

1045 
CPU_DEAD
:

1046 
CPU_DEAD_FROZEN
:

1047 
	`ˇche_ªmove_dev
(
sys_dev
);

1050  
NOTIFY_OK
;

1051 
	}
}

1053 
nŸifõr_block
 
__˝uöôd©a
 
	gˇcheöfo_˝u_nŸifõr
 = {

1054 .
nŸifõr_ˇŒ
 = 
ˇcheöfo_˝u_ˇŒback
,

1057 
__˝uöô
 
	$ˇche_sysfs_öô
()

1059 
i
;

1061 i‡(
num_ˇche_Àaves
 == 0)

1064 
	`f‹_óch_⁄löe_˝u
(
i
) {

1065 
îr
;

1066 
sys_devi˚
 *
sys_dev
 = 
	`gë_˝u_sysdev
(
i
);

1068 
îr
 = 
	`ˇche_add_dev
(
sys_dev
);

1069 i‡(
îr
)

1070  
îr
;

1072 
	`ªgi°î_hŸ˝u_nŸifõr
(&
ˇcheöfo_˝u_nŸifõr
);

1074 
	}
}

1076 
devi˚_öôˇŒ
(
ˇche_sysfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/debugfs.h
>

16 
	~<asm/m˚.h
>

18 
	~"m˚-öã∫Æ.h
"

32 
	ec⁄ãxt
 { 
	mIN_KERNEL
 = 1, 
	mIN_USER
 = 2 };

33 
	e£r
 { 
	mSER_REQUIRED
 = 1, 
	mNO_SER
 = 2 };

35 
	s£vîôy
 {

36 
u64
 
	mmask
;

37 
u64
 
	mªsu…
;

38 
	m£v
;

39 
	mmcgmask
;

40 
	mmcgªs
;

41 
	m£r
;

42 
	mc⁄ãxt
;

43 
	mcovîed
;

44 *
	mmsg
;

45 } 
	g£vîôõs
[] = {

46 
	#KERNEL
 .
c⁄ãxt
 = 
IN_KERNEL


	)

47 
	#USER
 .
c⁄ãxt
 = 
IN_USER


	)

48 
	#SER
 .
£r
 = 
SER_REQUIRED


	)

49 
	#NOSER
 .
£r
 = 
NO_SER


	)

50 
	#SEV
(
s
Ë.
£v
 = 
MCE_
 ## s ## 
_SEVERITY


	)

51 
	#BITCLR
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = 0, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

52 
	#BITSET
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = x, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

53 
	#MCGMASK
(
x
, 
ªs
, 
s
, 
m
, 
r
...) \

54 { .
mcgmask
 = 
x
, .
mcgªs
 = 
ªs
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

55 
	#MASK
(
x
, 
y
, 
s
, 
m
, 
r
...) \

56 { .
mask
 = 
x
, .
ªsu…
 = 
y
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

57 
	#MCI_UC_S
 (
MCI_STATUS_UC
|
MCI_STATUS_S
)

	)

58 
	#MCI_UC_SAR
 (
MCI_STATUS_UC
|
MCI_STATUS_S
|
MCI_STATUS_AR
)

	)

59 
	#MCACOD
 0xffff

	)

61 
BITCLR
(
MCI_STATUS_VAL
, 
NO
, "Invalid"),

62 
BITCLR
(
MCI_STATUS_EN
, 
NO
, "NotÉnabled"),

63 
BITSET
(
MCI_STATUS_PCC
, 
PANIC
, "Processor context corrupt"),

65 
MCGMASK
(
MCG_STATUS_MCIP
, 0, 
PANIC
, "MCIPÇot set in MCA handler"),

67 
MCGMASK
(
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
, 0, 
PANIC
,

69 
MCGMASK
(
MCG_STATUS_RIPV
, 0, 
PANIC
, "In kernelándÇoÑestart IP",

70 
KERNEL
),

71 
BITCLR
(
MCI_STATUS_UC
, 
KEEP
, "C‹ª˘edÉº‹", 
NOSER
),

72 
MASK
(
MCI_STATUS_OVER
|
MCI_STATUS_UC
|
MCI_STATUS_EN
, MCI_STATUS_UC, 
SOME
,

73 "Spuriou†nŸÉ«bÀd", 
SER
),

76 
MASK
(
MCI_UC_SAR
, 
MCI_STATUS_UC
, 
KEEP
,

77 "Unc‹ª˘edÇÿa˘i⁄Ñequúed", 
SER
),

78 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_STATUS_UC
|
MCI_STATUS_AR
, 
PANIC
,

79 "IŒegÆ combö©i⁄ (UCNA wôh AR=1)", 
SER
),

80 
MASK
(
MCI_STATUS_S
, 0, 
KEEP
, "N⁄ sig«Œed machöêcheck", 
SER
),

83 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, MCI_STATUS_OVER|MCI_UC_SAR, 
PANIC
,

84 "A˘i⁄Ñequúed wôhÜo°Évíts", 
SER
),

85 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
|
MCACOD
, MCI_UC_SAR, 
PANIC
,

86 "A˘i⁄Ñequúed; unknow¿MCACOD", 
SER
),

89 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|0xfff0, 
MCI_UC_S
|0xc0, 
AO
,

90 "A˘i⁄ o±i⁄Æ: mem‹y s¸ubbögÉº‹", 
SER
),

91 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|
MCACOD
, 
MCI_UC_S
|0x17a, 
AO
,

92 "A˘i⁄ o±i⁄Æ:Üa°Üevñ cachêwrôebackÉº‹", 
SER
),

94 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
, 
SOME
,

95 "A˘i⁄ o±i⁄Æ unknow¿MCACOD", 
SER
),

96 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
|MCI_STATUS_OVER, 
SOME
,

97 "A˘i⁄ o±i⁄Æ wôhÜo°Évíts", 
SER
),

98 
BITSET
(
MCI_STATUS_UC
|
MCI_STATUS_OVER
, 
PANIC
, "Overflowed uncorrected"),

99 
BITSET
(
MCI_STATUS_UC
, 
UC
, "Uncorrected"),

100 
BITSET
(0, 
SOME
, "No match")

107 
	$îr‹_c⁄ãxt
(
m˚
 *
m
)

109 i‡(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
)

110  (
m
->
ù
 && (m->
cs
 & 3Ë=3Ë? 
IN_USER
 : 
IN_KERNEL
;

112  
IN_KERNEL
;

113 
	}
}

115 
	$m˚_£vîôy
(
m˚
 *
a
, 
tﬁî™t
, **
msg
)

117 
c⁄ãxt
 
˘x
 = 
	`îr‹_c⁄ãxt
(
a
);

118 
£vîôy
 *
s
;

120 
s
 = 
£vîôõs
;; s++) {

121 i‡((
a
->
°©us
 & 
s
->
mask
Ë!s->
ªsu…
)

123 i‡((
a
->
mcg°©us
 & 
s
->
mcgmask
Ë!s->
mcgªs
)

125 i‡(
s
->
£r
 =
SER_REQUIRED
 && !
m˚_£r
)

127 i‡(
s
->
£r
 =
NO_SER
 && 
m˚_£r
)

129 i‡(
s
->
c⁄ãxt
 && 
˘x
 != s->context)

131 i‡(
msg
)

132 *
msg
 = 
s
->msg;

133 
s
->
covîed
 = 1;

134 i‡(
s
->
£v
 >
MCE_UC_SEVERITY
 && 
˘x
 =
IN_KERNEL
) {

135 i‡(
∑nic_⁄_o›s
 || 
tﬁî™t
 < 1)

136  
MCE_PANIC_SEVERITY
;

138  
s
->
£v
;

140 
	}
}

142 #ifde‡
CONFIG_DEBUG_FS


143 *
	$s_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

145 i‡(*
pos
 >
	`ARRAY_SIZE
(
£vîôõs
))

146  
NULL
;

147  &
£vîôõs
[*
pos
];

148 
	}
}

150 *
	$s_√xt
(
£q_fûe
 *
f
, *
d©a
, 
loff_t
 *
pos
)

152 i‡(++(*
pos
Ë>
	`ARRAY_SIZE
(
£vîôõs
))

153  
NULL
;

154  &
£vîôõs
[*
pos
];

155 
	}
}

157 
	$s_°›
(
£q_fûe
 *
f
, *
d©a
)

159 
	}
}

161 
	$s_show
(
£q_fûe
 *
f
, *
d©a
)

163 
£vîôy
 *
£r
 = 
d©a
;

164 
	`£q_¥ötf
(
f
, "%d\t%s\n", 
£r
->
covîed
, sî->
msg
);

166 
	}
}

168 c⁄° 
£q_›î©i⁄s
 
	g£vîôõs_£q_›s
 = {

169 .
°¨t
 = 
s_°¨t
,

170 .
	g√xt
 = 
s_√xt
,

171 .
	g°›
 = 
s_°›
,

172 .
	gshow
 = 
s_show
,

175 
	$£vîôõs_covîage_›í
(
öode
 *öode, 
fûe
 *file)

177  
	`£q_›í
(
fûe
, &
£vîôõs_£q_›s
);

178 
	}
}

180 
ssize_t
 
	$£vîôõs_covîage_wrôe
(
fûe
 *file,

181 c⁄° 
__u£r
 *
ubuf
,

182 
size_t
 
cou¡
, 
loff_t
 *
µos
)

184 
i
;

185 
i
 = 0; i < 
	`ARRAY_SIZE
(
£vîôõs
); i++)

186 
£vîôõs
[
i
].
covîed
 = 0;

187  
cou¡
;

188 
	}
}

190 c⁄° 
fûe_›î©i⁄s
 
	g£vîôõs_covîage_f›s
 = {

191 .
›í
 = 
£vîôõs_covîage_›í
,

192 .
	gªÀa£
 = 
£q_ªÀa£
,

193 .
	gªad
 = 
£q_ªad
,

194 .
	gwrôe
 = 
£vîôõs_covîage_wrôe
,

197 
__öô
 
	$£vîôõs_debugfs_öô
()

199 
díåy
 *
dm˚
 = 
NULL
, *
f£vîôõs_covîage
 = NULL;

201 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

202 i‡(
dm˚
 =
NULL
)

203 
îr_out
;

204 
f£vîôõs_covîage
 = 
	`debugfs_¸óã_fûe
("severities-coverage",

205 0444, 
dm˚
, 
NULL
,

206 &
£vîôõs_covîage_f›s
);

207 i‡(
f£vîôõs_covîage
 =
NULL
)

208 
îr_out
;

212 
îr_out
:

213  -
ENOMEM
;

214 
	}
}

215 
œã_öôˇŒ
(
£vîôõs_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c

10 
	~<löux/thªad_öfo.h
>

11 
	~<löux/ˇ∑bûôy.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/kÆlsyms.h
>

16 
	~<löux/rcupd©e.h
>

17 
	~<löux/kobje˘.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≥r˝u.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/sysdev.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/˘y≥.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/sysfs.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/¶ab.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/kmod.h
>

32 
	~<löux/pﬁl.h
>

33 
	~<löux/nmi.h
>

34 
	~<löux/˝u.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/fs.h
>

37 
	~<löux/mm.h
>

38 
	~<löux/debugfs.h
>

40 
	~<asm/¥o˚ss‹.h
>

41 
	~<asm/hw_úq.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/idÀ.h
>

44 
	~<asm/ùi.h
>

45 
	~<asm/m˚.h
>

46 
	~<asm/m§.h
>

48 
	~"m˚-öã∫Æ.h
"

50 
DEFINE_MUTEX
(
m˚_ªad_muãx
);

52 
	#rcu_dîe„ªn˚_check_m˚
(
p
) \

53 
	`rcu_dîe„ªn˚_check
((
p
), \

54 
	`rcu_ªad_lock_sched_hñd
() || \

55 
	`lockdï_is_hñd
(&
m˚_ªad_muãx
))

	)

57 
	#CREATE_TRACE_POINTS


	)

58 
	~<åa˚/evíts/m˚.h
>

60 
m˚_dißbÀd
 
	g__ªad_mo°ly
;

62 
	#MISC_MCELOG_MINOR
 227

	)

64 
	#SPINUNIT
 100

	)

66 
©omic_t
 
	gm˚_íåy
;

68 
DEFINE_PER_CPU
(, 
m˚_ex˚±i⁄_cou¡
);

77 
tﬁî™t
 
	g__ªad_mo°ly
 = 1;

78 
b™ks
 
	g__ªad_mo°ly
;

79 
rù_m§
 
	g__ªad_mo°ly
;

80 
m˚_boŸlog
 
	g__ªad_mo°ly
 = -1;

81 
m⁄¨ch_timeout
 
	g__ªad_mo°ly
 = -1;

82 
m˚_∑nic_timeout
 
	g__ªad_mo°ly
;

83 
m˚_d⁄t_log_˚
 
	g__ªad_mo°ly
;

84 
m˚_cmci_dißbÀd
 
	g__ªad_mo°ly
;

85 
m˚_ign‹e_˚
 
	g__ªad_mo°ly
;

86 
m˚_£r
 
	g__ªad_mo°ly
;

88 
m˚_b™k
 *
m˚_b™ks
 
	g__ªad_mo°ly
;

91 
	gm˚_√ed_nŸify
;

92 
	gm˚_hñ≥r
[128];

93 *
	gm˚_hñ≥r_¨gv
[2] = { 
m˚_hñ≥r
, 
NULL
 };

95 
DECLARE_WAIT_QUEUE_HEAD
(
m˚_waô
);

96 
DEFINE_PER_CPU
(
m˚
, 
m˚s_£í
);

97 
	g˝u_missög
;

103 
ATOMIC_NOTIFIER_HEAD
(
x86_m˚_decodî_chaö
);

104 
EXPORT_SYMBOL_GPL
(
x86_m˚_decodî_chaö
);

106 
	$deÁu…_decode_m˚
(
nŸifõr_block
 *
nb
, 
vÆ
,

107 *
d©a
)

109 
	`¥_emîg
("No humanÑeadable MCE decoding support onÅhis CPUÅype.\n");

110 
	`¥_emîg
("RunÅhe messageÅhrough 'mcelog --ascii'Åo decode.\n");

112  
NOTIFY_STOP
;

113 
	}
}

115 
nŸifõr_block
 
	gm˚_dec_nb
 = {

116 .
nŸifõr_ˇŒ
 = 
deÁu…_decode_m˚
,

117 .
	g¥i‹ôy
 = -1,

121 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_pﬁl_b™ks
) = {

122 [0 ... 
BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

125 
DEFINE_PER_CPU
(
w‹k_°ru˘
, 
m˚_w‹k
);

128 
	$m˚_£tup
(
m˚
 *
m
)

130 
	`mem£t
(
m
, 0, (
m˚
));

131 
m
->
˝u
 = m->
ext˝u
 = 
	`smp_¥o˚ss‹_id
();

132 
	`rdts˛l
(
m
->
tsc
);

134 
m
->
time
 = 
	`gë_£c⁄ds
();

135 
m
->
˝uvíd‹
 = 
boŸ_˝u_d©a
.
x86_víd‹
;

136 
m
->
˝uid
 = 
	`˝uid_óx
(1);

137 #ifde‡
CONFIG_SMP


138 
m
->
sockëid
 = 
	`˝u_d©a
(m->
ext˝u
).
phys_¥oc_id
;

140 
m
->
≠icid
 = 
	`˝u_d©a
(m->
ext˝u
).
öôül_≠icid
;

141 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
m
->
mcgˇp
);

142 
	}
}

144 
DEFINE_PER_CPU
(
m˚
, 
öje˘m
);

145 
EXPORT_PER_CPU_SYMBOL_GPL
(
öje˘m
);

153 
m˚_log
 
	gm˚log
 = {

154 .
sig«tuª
 = 
MCE_LOG_SIGNATURE
,

155 .
	gÀn
 = 
MCE_LOG_LEN
,

156 .
	gªc‹dÀn
 = (
m˚
),

159 
	$m˚_log
(
m˚
 *mce)

161 
√xt
, 
íåy
;

164 
	`åa˚_m˚_ªc‹d
(
m˚
);

166 
m˚
->
föished
 = 0;

167 
	`wmb
();

169 
íåy
 = 
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.
√xt
);

176 i‡(
íåy
 >
MCE_LOG_LEN
) {

177 
	`£t_bô
(
MCE_OVERFLOW
,

178 (*)&
m˚log
.
Êags
);

182 i‡(
m˚log
.
íåy
[íåy].
föished
) {

183 
íåy
++;

188 
	`smp_rmb
();

189 
√xt
 = 
íåy
 + 1;

190 i‡(
	`cmpxchg
(&
m˚log
.
√xt
, 
íåy
,Çext) ==Éntry)

193 
	`mem˝y
(
m˚log
.
íåy
 +É¡ry, 
m˚
, (mce));

194 
	`wmb
();

195 
m˚log
.
íåy
[íåy].
föished
 = 1;

196 
	`wmb
();

198 
m˚
->
föished
 = 1;

199 
	`£t_bô
(0, &
m˚_√ed_nŸify
);

200 
	}
}

202 
	$¥öt_m˚
(
m˚
 *
m
)

204 
	`¥_emîg
("CPU %d: Machine Check Exception: %16Lx Bank %d: %016Lx\n",

205 
m
->
ext˝u
, m->
mcg°©us
, m->
b™k
, m->
°©us
);

207 i‡(
m
->
ù
) {

208 
	`¥_emîg
("RIP%s %02x:<%016Lx> ",

209 !(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

210 
m
->
cs
, m->
ù
);

212 i‡(
m
->
cs
 =
__KERNEL_CS
)

213 
	`¥öt_symbﬁ
("{%s}", 
m
->
ù
);

214 
	`¥_c⁄t
("\n");

217 
	`¥_emîg
("TSC %Œx ", 
m
->
tsc
);

218 i‡(
m
->
addr
)

219 
	`¥_c⁄t
("ADDR %Œx ", 
m
->
addr
);

220 i‡(
m
->
misc
)

221 
	`¥_c⁄t
("MISC %Œx ", 
m
->
misc
);

223 
	`¥_c⁄t
("\n");

224 
	`¥_emîg
("PROCESSOR %u:%x TIME %llu SOCKET %u APIC %x\n",

225 
m
->
˝uvíd‹
, m->
˝uid
, m->
time
, m->
sockëid
, m->
≠icid
);

231 
	`©omic_nŸifõr_ˇŒ_chaö
(&
x86_m˚_decodî_chaö
, 0, 
m
);

232 
	}
}

234 
	$¥öt_m˚_hód
()

236 
	`¥_emîg
("\nHARDWARE ERROR\n");

237 
	}
}

239 
	$¥öt_m˚_èû
()

241 
	`¥_emîg
("This isÇotá softwareÖroblem!\n");

242 
	}
}

244 
	#PANIC_TIMEOUT
 5

	)

246 
©omic_t
 
	gm˚_∑ni˚d
;

248 
	gÁke_∑nic
;

249 
©omic_t
 
	gm˚_Áke_∑ni˚d
;

252 
	$waô_f‹_∑nic
()

254 
timeout
 = 
PANIC_TIMEOUT
*
USEC_PER_SEC
;

256 
	`¥ìm±_dißbÀ
();

257 
	`loˇl_úq_íabÀ
();

258 
timeout
-- > 0)

259 
	`udñay
(1);

260 i‡(
∑nic_timeout
 == 0)

261 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

262 
	`∑nic
("Panicing machine check CPU died");

263 
	}
}

265 
	$m˚_∑nic
(*
msg
, 
m˚
 *
föÆ
, *
exp
)

267 
i
;

269 i‡(!
Áke_∑nic
) {

273 i‡(
	`©omic_öc_ªtu∫
(&
m˚_∑ni˚d
) > 1)

274 
	`waô_f‹_∑nic
();

275 
	`b¨rõr
();

277 
	`bu°_•ölocks
(1);

278 
	`c⁄sﬁe_vîbo£
();

281 i‡(
	`©omic_öc_ªtu∫
(&
m˚_Áke_∑ni˚d
) > 1)

284 
	`¥öt_m˚_hód
();

286 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

287 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

288 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

290 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

291 
	`¥öt_m˚
(
m
);

294 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

295 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

296 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

298 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

300 i‡(!
föÆ
 || 
	`memcmp
(
m
, föÆ, (
m˚
)))

301 
	`¥öt_m˚
(
m
);

303 i‡(
föÆ
)

304 
	`¥öt_m˚
(
föÆ
);

305 i‡(
˝u_missög
)

306 
	`¥ötk
(
KERN_EMERG
 "Some CPUs didn'tánswer in synchronization\n");

307 
	`¥öt_m˚_èû
();

308 i‡(
exp
)

309 
	`¥ötk
(
KERN_EMERG
 "Machöêcheck: %s\n", 
exp
);

310 i‡(!
Áke_∑nic
) {

311 i‡(
∑nic_timeout
 == 0)

312 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

313 
	`∑nic
(
msg
);

315 
	`¥ötk
(
KERN_EMERG
 "Fakêkî√»∑nic: %s\n", 
msg
);

316 
	}
}

320 
	$m§_to_off£t
(
u32
 
m§
)

322 
b™k
 = 
	`__gë_˝u_v¨
(
öje˘m
.bank);

324 i‡(
m§
 =
rù_m§
)

325  
	`off£tof
(
m˚
, 
ù
);

326 i‡(
m§
 =
	`MSR_IA32_MCx_STATUS
(
b™k
))

327  
	`off£tof
(
m˚
, 
°©us
);

328 i‡(
m§
 =
	`MSR_IA32_MCx_ADDR
(
b™k
))

329  
	`off£tof
(
m˚
, 
addr
);

330 i‡(
m§
 =
	`MSR_IA32_MCx_MISC
(
b™k
))

331  
	`off£tof
(
m˚
, 
misc
);

332 i‡(
m§
 =
MSR_IA32_MCG_STATUS
)

333  
	`off£tof
(
m˚
, 
mcg°©us
);

335 
	}
}

338 
u64
 
	$m˚_rdm§l
(
u32
 
m§
)

340 
u64
 
v
;

342 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

343 
off£t
 = 
	`m§_to_off£t
(
m§
);

345 i‡(
off£t
 < 0)

347  *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
);

350 i‡(
	`rdm§l_ß„
(
m§
, &
v
)) {

351 
	`WARN_ONCE
(1, "m˚: U«bÀÅÿªad m§ %d!\n", 
m§
);

357 
v
 = 0;

360  
v
;

361 
	}
}

363 
	$m˚_wrm§l
(
u32
 
m§
, 
u64
 
v
)

365 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

366 
off£t
 = 
	`m§_to_off£t
(
m§
);

368 i‡(
off£t
 >= 0)

369 *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
Ë
v
;

372 
	`wrm§l
(
m§
, 
v
);

373 
	}
}

380 
	#MCE_RING_SIZE
 16

	)

382 
	sm˚_rög
 {

383 
	m°¨t
;

384 
	míd
;

385 
	mrög
[
MCE_RING_SIZE
];

387 
DEFINE_PER_CPU
(
m˚_rög
, mce_ring);

390 
	$m˚_rög_em±y
()

392 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

394  
r
->
°¨t
 =r->
íd
;

395 
	}
}

397 
	$m˚_rög_gë
(*
p‚
)

399 
m˚_rög
 *
r
;

400 
ªt
 = 0;

402 *
p‚
 = 0;

403 
	`gë_˝u
();

404 
r
 = &
	`__gë_˝u_v¨
(
m˚_rög
);

405 i‡(
r
->
°¨t
 =r->
íd
)

406 
out
;

407 *
p‚
 = 
r
->
rög
[r->
°¨t
];

408 
r
->
°¨t
 = (r->°¨à+ 1Ë% 
MCE_RING_SIZE
;

409 
ªt
 = 1;

410 
out
:

411 
	`put_˝u
();

412  
ªt
;

413 
	}
}

416 
	$m˚_rög_add
(
p‚
)

418 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

419 
√xt
;

421 
√xt
 = (
r
->
íd
 + 1Ë% 
MCE_RING_SIZE
;

422 i‡(
√xt
 =
r
->
°¨t
)

424 
r
->
rög
[r->
íd
] = 
p‚
;

425 
	`wmb
();

426 
r
->
íd
 = 
√xt
;

428 
	}
}

430 
	$m˚_avaûabÀ
(
˝uöfo_x86
 *
c
)

432 i‡(
m˚_dißbÀd
)

434  
	`˝u_has
(
c
, 
X86_FEATURE_MCE
Ë&& cpu_has(c, 
X86_FEATURE_MCA
);

435 
	}
}

437 
	$m˚_scheduÀ_w‹k
()

439 i‡(!
	`m˚_rög_em±y
()) {

440 
w‹k_°ru˘
 *
w‹k
 = &
	`__gë_˝u_v¨
(
m˚_w‹k
);

441 i‡(!
	`w‹k_≥ndög
(
w‹k
))

442 
	`scheduÀ_w‹k
(
w‹k
);

444 
	}
}

450 
ölöe
 
	$m˚_gë_rù
(
m˚
 *
m
, 
±_ªgs
 *
ªgs
)

453 i‡(
ªgs
 && (
m
->
mcg°©us
 & (
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
))) {

454 
m
->
ù
 = 
ªgs
->ip;

455 
m
->
cs
 = 
ªgs
->cs;

457 
m
->
ù
 = 0;

458 
m
->
cs
 = 0;

460 i‡(
rù_m§
)

461 
m
->
ù
 = 
	`m˚_rdm§l
(
rù_m§
);

462 
	}
}

464 #ifde‡
CONFIG_X86_LOCAL_APIC


470 
asmlökage
 
	$smp_m˚_£lf_öãºu±
(
±_ªgs
 *
ªgs
)

472 
	`ack_APIC_úq
();

473 
	`exô_idÀ
();

474 
	`úq_íãr
();

475 
	`m˚_nŸify_úq
();

476 
	`m˚_scheduÀ_w‹k
();

477 
	`úq_exô
();

478 
	}
}

481 
	$m˚_ªp‹t_evít
(
±_ªgs
 *
ªgs
)

483 i‡(
ªgs
->
Êags
 & (
X86_VM_MASK
|
X86_EFLAGS_IF
)) {

484 
	`m˚_nŸify_úq
();

491 
	`m˚_scheduÀ_w‹k
();

495 #ifde‡
CONFIG_X86_LOCAL_APIC


500 i‡(!
˝u_has_≠ic
)

509 
≠ic
->
	`£nd_IPI_£lf
(
MCE_SELF_VECTOR
);

516 
	`≠ic_waô_i¸_idÀ
();

518 
	}
}

520 
DEFINE_PER_CPU
(, 
m˚_pﬁl_cou¡
);

537 
	$machöe_check_pﬁl
(
m˝_Êags
 
Êags
, 
m˚_b™ks_t
 *
b
)

539 
m˚
 
m
;

540 
i
;

542 
	`__gë_˝u_v¨
(
m˚_pﬁl_cou¡
)++;

544 
	`m˚_£tup
(&
m
);

546 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

547 
i
 = 0; i < 
b™ks
; i++) {

548 i‡(!
m˚_b™ks
[
i
].
˘l
 || !
	`ã°_bô
(i, *
b
))

551 
m
.
misc
 = 0;

552 
m
.
addr
 = 0;

553 
m
.
b™k
 = 
i
;

554 
m
.
tsc
 = 0;

556 
	`b¨rõr
();

557 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

558 i‡(!(
m
.
°©us
 & 
MCI_STATUS_VAL
))

567 i‡(!(
Êags
 & 
MCP_UC
) &&

568 (
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)))

571 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

572 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

573 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

574 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

576 i‡(!(
Êags
 & 
MCP_TIMESTAMP
))

577 
m
.
tsc
 = 0;

582 i‡(!(
Êags
 & 
MCP_DONTLOG
Ë&& !
m˚_d⁄t_log_˚
) {

583 
	`m˚_log
(&
m
);

584 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

590 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

598 
	`sync_c‹e
();

599 
	}
}

600 
EXPORT_SYMBOL_GPL
(
machöe_check_pﬁl
);

606 
	$m˚_no_way_out
(
m˚
 *
m
, **
msg
)

608 
i
;

610 
i
 = 0; i < 
b™ks
; i++) {

611 
m
->
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

612 i‡(
	`m˚_£vîôy
(
m
, 
tﬁî™t
, 
msg
Ë>
MCE_PANIC_SEVERITY
)

616 
	}
}

622 
©omic_t
 
	gm˚_executög
;

627 
©omic_t
 
	gm˚_ˇŒö
;

632 
	$m˚_timed_out
(
u64
 *
t
)

640 
	`rmb
();

641 i‡(
	`©omic_ªad
(&
m˚_∑ni˚d
))

642 
	`waô_f‹_∑nic
();

643 i‡(!
m⁄¨ch_timeout
)

644 
out
;

645 i‡((
s64
)*
t
 < 
SPINUNIT
) {

647 i‡(
tﬁî™t
 < 1)

648 
	`m˚_∑nic
("Timeout synchronizing machine check over CPUs",

649 
NULL
, NULL);

650 
˝u_missög
 = 1;

653 *
t
 -
SPINUNIT
;

654 
out
:

655 
	`touch_nmi_w©chdog
();

657 
	}
}

683 
	$m˚_ªign
()

685 
˝u
;

686 
m˚
 *
m
 = 
NULL
;

687 
globÆ_w‹°
 = 0;

688 *
msg
 = 
NULL
;

689 *
nmsg
 = 
NULL
;

696 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

697 
£vîôy
 = 
	`m˚_£vîôy
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 
tﬁî™t
,

698 &
nmsg
);

699 i‡(
£vîôy
 > 
globÆ_w‹°
) {

700 
msg
 = 
nmsg
;

701 
globÆ_w‹°
 = 
£vîôy
;

702 
m
 = &
	`≥r_˝u
(
m˚s_£í
, 
˝u
);

711 i‡(
m
 && 
globÆ_w‹°
 >
MCE_PANIC_SEVERITY
 && 
tﬁî™t
 < 3)

712 
	`m˚_∑nic
("F©Æ Machöêcheck", 
m
, 
msg
);

724 i‡(
globÆ_w‹°
 <
MCE_KEEP_SEVERITY
 && 
tﬁî™t
 < 3)

725 
	`m˚_∑nic
("Machöêcheck from unknow¿sour˚", 
NULL
, NULL);

731 
	`f‹_óch_possibÀ_˝u
(
˝u
)

732 
	`mem£t
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 0, (
m˚
));

733 
	}
}

735 
©omic_t
 
	gglobÆ_nwo
;

744 
	$m˚_°¨t
(*
no_way_out
)

746 
‹dî
;

747 
˝us
 = 
	`num_⁄löe_˝us
();

748 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

750 i‡(!
timeout
)

753 
	`©omic_add
(*
no_way_out
, &
globÆ_nwo
);

757 
	`smp_wmb
();

758 
‹dî
 = 
	`©omic_öc_ªtu∫
(&
m˚_ˇŒö
);

763 
	`©omic_ªad
(&
m˚_ˇŒö
Ë!
˝us
) {

764 i‡(
	`m˚_timed_out
(&
timeout
)) {

765 
	`©omic_£t
(&
globÆ_nwo
, 0);

768 
	`ndñay
(
SPINUNIT
);

774 
	`smp_rmb
();

776 i‡(
‹dî
 == 1) {

780 
	`©omic_£t
(&
m˚_executög
, 1);

788 
	`©omic_ªad
(&
m˚_executög
Ë< 
‹dî
) {

789 i‡(
	`m˚_timed_out
(&
timeout
)) {

790 
	`©omic_£t
(&
globÆ_nwo
, 0);

793 
	`ndñay
(
SPINUNIT
);

800 *
no_way_out
 = 
	`©omic_ªad
(&
globÆ_nwo
);

802  
‹dî
;

803 
	}
}

809 
	$m˚_íd
(
‹dî
)

811 
ªt
 = -1;

812 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

814 i‡(!
timeout
)

815 
ª£t
;

816 i‡(
‹dî
 < 0)

817 
ª£t
;

822 
	`©omic_öc
(&
m˚_executög
);

824 i‡(
‹dî
 == 1) {

826 
˝us
 = 
	`num_⁄löe_˝us
();

832 
	`©omic_ªad
(&
m˚_executög
Ë<
˝us
) {

833 i‡(
	`m˚_timed_out
(&
timeout
))

834 
ª£t
;

835 
	`ndñay
(
SPINUNIT
);

838 
	`m˚_ªign
();

839 
	`b¨rõr
();

840 
ªt
 = 0;

845 
	`©omic_ªad
(&
m˚_executög
) != 0) {

846 i‡(
	`m˚_timed_out
(&
timeout
))

847 
ª£t
;

848 
	`ndñay
(
SPINUNIT
);

860 
ª£t
:

861 
	`©omic_£t
(&
globÆ_nwo
, 0);

862 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

863 
	`b¨rõr
();

868 
	`©omic_£t
(&
m˚_executög
, 0);

869  
ªt
;

870 
	}
}

878 
	$m˚_ußbÀ_addªss
(
m˚
 *
m
)

880 i‡(!(
m
->
°©us
 & 
MCI_STATUS_MISCV
Ë|| !(m->°©u†& 
MCI_STATUS_ADDRV
))

882 i‡((
m
->
misc
 & 0x3fË> 
PAGE_SHIFT
)

884 i‡(((
m
->
misc
 >> 6Ë& 7Ë!
MCM_ADDR_PHYS
)

887 
	}
}

889 
	$m˚_˛ór_°©e
(*
to˛ór
)

891 
i
;

893 
i
 = 0; i < 
b™ks
; i++) {

894 i‡(
	`ã°_bô
(
i
, 
to˛ór
))

895 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

897 
	}
}

911 
	$do_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

913 
m˚
 
m
, *
föÆ
;

914 
i
;

915 
w‹°
 = 0;

916 
£vîôy
;

921 
‹dî
;

926 
no_way_out
 = 0;

931 
kûl_ô
 = 0;

932 
	`DECLARE_BITMAP
(
to˛ór
, 
MAX_NR_BANKS
);

933 *
msg
 = "Unknown";

935 
	`©omic_öc
(&
m˚_íåy
);

937 
	`__gë_˝u_v¨
(
m˚_ex˚±i⁄_cou¡
)++;

939 i‡(
	`nŸify_dõ
(
DIE_NMI
, "machöêcheck", 
ªgs
, 
îr‹_code
,

940 18, 
SIGKILL
Ë=
NOTIFY_STOP
)

941 
out
;

942 i‡(!
b™ks
)

943 
out
;

945 
	`m˚_£tup
(&
m
);

947 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

948 
föÆ
 = &
	`__gë_˝u_v¨
(
m˚s_£í
);

949 *
föÆ
 = 
m
;

951 
no_way_out
 = 
	`m˚_no_way_out
(&
m
, &
msg
);

953 
	`b¨rõr
();

958 i‡(!(
m
.
mcg°©us
 & 
MCG_STATUS_RIPV
))

959 
kûl_ô
 = 1;

966 
‹dî
 = 
	`m˚_°¨t
(&
no_way_out
);

967 
i
 = 0; i < 
b™ks
; i++) {

968 
	`__˛ór_bô
(
i
, 
to˛ór
);

969 i‡(!
m˚_b™ks
[
i
].
˘l
)

972 
m
.
misc
 = 0;

973 
m
.
addr
 = 0;

974 
m
.
b™k
 = 
i
;

976 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

977 i‡((
m
.
°©us
 & 
MCI_STATUS_VAL
) == 0)

984 i‡(!(
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)) &&

985 !
no_way_out
)

991 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

993 
£vîôy
 = 
	`m˚_£vîôy
(&
m
, 
tﬁî™t
, 
NULL
);

999 i‡(
£vîôy
 =
MCE_KEEP_SEVERITY
 && !
no_way_out
)

1001 
	`__£t_bô
(
i
, 
to˛ór
);

1002 i‡(
£vîôy
 =
MCE_NO_SEVERITY
) {

1013 i‡(
£vîôy
 =
MCE_AR_SEVERITY
)

1014 
kûl_ô
 = 1;

1016 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

1017 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

1018 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

1019 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

1028 i‡(
£vîôy
 =
MCE_AO_SEVERITY
 && 
	`m˚_ußbÀ_addªss
(&
m
))

1029 
	`m˚_rög_add
(
m
.
addr
 >> 
PAGE_SHIFT
);

1031 
	`m˚_gë_rù
(&
m
, 
ªgs
);

1032 
	`m˚_log
(&
m
);

1034 i‡(
£vîôy
 > 
w‹°
) {

1035 *
föÆ
 = 
m
;

1036 
w‹°
 = 
£vîôy
;

1040 i‡(!
no_way_out
)

1041 
	`m˚_˛ór_°©e
(
to˛ór
);

1047 i‡(
	`m˚_íd
(
‹dî
) < 0)

1048 
no_way_out
 = 
w‹°
 >
MCE_PANIC_SEVERITY
;

1057 i‡(
no_way_out
 && 
tﬁî™t
 < 3)

1058 
	`m˚_∑nic
("F©Æ machöêcheck o¿cuºíàCPU", 
föÆ
, 
msg
);

1067 i‡(
kûl_ô
 && 
tﬁî™t
 < 3)

1068 
	`f‹˚_sig
(
SIGBUS
, 
cuºít
);

1071 
	`£t_thªad_Êag
(
TIF_MCE_NOTIFY
);

1073 i‡(
w‹°
 > 0)

1074 
	`m˚_ªp‹t_evít
(
ªgs
);

1075 
	`m˚_wrm§l
(
MSR_IA32_MCG_STATUS
, 0);

1076 
out
:

1077 
	`©omic_dec
(&
m˚_íåy
);

1078 
	`sync_c‹e
();

1079 
	}
}

1080 
EXPORT_SYMBOL_GPL
(
do_machöe_check
);

1083 
__©åibuã__
((
wók
)Ë
	$mem‹y_Áûuª
(
p‚
, 
ve˘‹
)

1085 
	`¥ötk
(
KERN_ERR
 "A˘i⁄ o±i⁄Æ mem‹y faûuªáà%lx ign‹ed\n", 
p‚
);

1086 
	}
}

1099 
	$m˚_nŸify_¥o˚ss
()

1101 
p‚
;

1102 
	`m˚_nŸify_úq
();

1103 
	`m˚_rög_gë
(&
p‚
))

1104 
	`mem‹y_Áûuª
(
p‚
, 
MCE_VECTOR
);

1105 
	}
}

1107 
	$m˚_¥o˚ss_w‹k
(
w‹k_°ru˘
 *
dummy
)

1109 
	`m˚_nŸify_¥o˚ss
();

1110 
	}
}

1112 #ifde‡
CONFIG_X86_MCE_INTEL


1126 
	$m˚_log_thîm_thrŸ_evít
(
__u64
 
°©us
)

1128 
m˚
 
m
;

1130 
	`m˚_£tup
(&
m
);

1131 
m
.
b™k
 = 
MCE_THERMAL_BANK
;

1132 
m
.
°©us
 = status;

1133 
	`m˚_log
(&
m
);

1134 
	}
}

1142 
	gcheck_öãrvÆ
 = 5 * 60;

1144 
DEFINE_PER_CPU
(, 
m˚_√xt_öãrvÆ
);

1145 
DEFINE_PER_CPU
(
timî_li°
, 
m˚_timî
);

1147 
	$m˚_°¨t_timî
(
d©a
)

1149 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
d©a
);

1150 *
n
;

1152 
	`WARN_ON
(
	`smp_¥o˚ss‹_id
(Ë!
d©a
);

1154 i‡(
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
)) {

1155 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

1156 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

1163 
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1164 i‡(
	`m˚_nŸify_úq
())

1165 *
n
 = 
	`max
(*n/2, 
HZ
/100);

1167 *
n
 = 
	`mö
(*n*2, ()
	`round_jiffõs_ªœtive
(
check_öãrvÆ
*
HZ
));

1169 
t
->
expúes
 = 
jiffõs
 + *
n
;

1170 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1171 
	}
}

1173 
	$m˚_do_åiggî
(
w‹k_°ru˘
 *
w‹k
)

1175 
	`ˇŒ_u£rmodehñ≥r
(
m˚_hñ≥r
, 
m˚_hñ≥r_¨gv
, 
NULL
, 
UMH_NO_WAIT
);

1176 
	}
}

1178 
DECLARE_WORK
(
m˚_åiggî_w‹k
, 
m˚_do_åiggî
);

1185 
	$m˚_nŸify_úq
()

1188 
	`DEFINE_RATELIMIT_STATE
(
øãlimô
, 60*
HZ
, 2);

1190 
	`˛ór_thªad_Êag
(
TIF_MCE_NOTIFY
);

1192 i‡(
	`ã°_™d_˛ór_bô
(0, &
m˚_√ed_nŸify
)) {

1193 
	`wake_up_öãºu±ibÀ
(&
m˚_waô
);

1200 i‡(
m˚_hñ≥r
[0] && !
	`w‹k_≥ndög
(&
m˚_åiggî_w‹k
))

1201 
	`scheduÀ_w‹k
(&
m˚_åiggî_w‹k
);

1203 i‡(
	`__øãlimô
(&
øãlimô
))

1204 
	`¥ötk
(
KERN_INFO
 "Machine checkÉventsÜogged\n");

1209 
	}
}

1210 
EXPORT_SYMBOL_GPL
(
m˚_nŸify_úq
);

1212 
__˝uöô
 
	$__mcheck_˝u_m˚_b™ks_öô
()

1214 
i
;

1216 
m˚_b™ks
 = 
	`kzÆloc
(
b™ks
 * (
m˚_b™k
), 
GFP_KERNEL
);

1217 i‡(!
m˚_b™ks
)

1218  -
ENOMEM
;

1219 
i
 = 0; i < 
b™ks
; i++) {

1220 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1222 
b
->
˘l
 = -1ULL;

1223 
b
->
öô
 = 1;

1226 
	}
}

1231 
__˝uöô
 
	$__mcheck_˝u_ˇp_öô
()

1233 
b
;

1234 
u64
 
ˇp
;

1236 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1238 
b
 = 
ˇp
 & 
MCG_BANKCNT_MASK
;

1239 i‡(!
b™ks
)

1240 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
b
);

1242 i‡(
b
 > 
MAX_NR_BANKS
) {

1243 
	`¥ötk
(
KERN_WARNING


1245 
MAX_NR_BANKS
, 
b
);

1246 
b
 = 
MAX_NR_BANKS
;

1250 
	`WARN_ON
(
b™ks
 !0 && 
b
 != banks);

1251 
b™ks
 = 
b
;

1252 i‡(!
m˚_b™ks
) {

1253 
îr
 = 
	`__mcheck_˝u_m˚_b™ks_öô
();

1255 i‡(
îr
)

1256  
îr
;

1260 i‡((
ˇp
 & 
MCG_EXT_P
Ë&& 
	`MCG_EXT_CNT
(cap) >= 9)

1261 
rù_m§
 = 
MSR_IA32_MCG_EIP
;

1263 i‡(
ˇp
 & 
MCG_SER_P
)

1264 
m˚_£r
 = 1;

1267 
	}
}

1269 
	$__mcheck_˝u_öô_gíîic
()

1271 
m˚_b™ks_t
 
Æl_b™ks
;

1272 
u64
 
ˇp
;

1273 
i
;

1278 
	`bôm≠_fûl
(
Æl_b™ks
, 
MAX_NR_BANKS
);

1279 
	`machöe_check_pﬁl
(
MCP_UC
|(!
m˚_boŸlog
 ? 
MCP_DONTLOG
 : 0), &
Æl_b™ks
);

1281 
	`£t_ö_¸4
(
X86_CR4_MCE
);

1283 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1284 i‡(
ˇp
 & 
MCG_CTL_P
)

1285 
	`wrm§
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

1287 
i
 = 0; i < 
b™ks
; i++) {

1288 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1290 i‡(!
b
->
öô
)

1292 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1293 
	`wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

1295 
	}
}

1298 
__˝uöô
 
	$__mcheck_˝u_≠∂y_quúks
(
˝uöfo_x86
 *
c
)

1300 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_UNKNOWN
) {

1301 
	`¥_öfo
("MCE: unknown CPUÅype -ÇotÉnabling MCE support.\n");

1302  -
EOPNOTSUPP
;

1306 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
) {

1307 i‡(
c
->
x86
 =15 && 
b™ks
 > 4) {

1313 
	`˛ór_bô
(10, (*)&
m˚_b™ks
[4].
˘l
);

1315 i‡(
c
->
x86
 <17 && 
m˚_boŸlog
 < 0) {

1320 
m˚_boŸlog
 = 0;

1326 i‡(
c
->
x86
 =6 && 
b™ks
 > 0)

1327 
m˚_b™ks
[0].
˘l
 = 0;

1330 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

1340 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 0x1A && 
b™ks
 > 0)

1341 
m˚_b™ks
[0].
öô
 = 0;

1347 i‡((
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xe)) &&

1348 
m⁄¨ch_timeout
 < 0)

1349 
m⁄¨ch_timeout
 = 
USEC_PER_SEC
;

1355 i‡(
c
->
x86
 =6 && c->
x86_modñ
 <13 && 
m˚_boŸlog
 < 0)

1356 
m˚_boŸlog
 = 0;

1358 i‡(
m⁄¨ch_timeout
 < 0)

1359 
m⁄¨ch_timeout
 = 0;

1360 i‡(
m˚_boŸlog
 != 0)

1361 
m˚_∑nic_timeout
 = 30;

1364 
	}
}

1366 
__˝uöô
 
	$__mcheck_˝u_™cõ¡_öô
(
˝uöfo_x86
 *
c
)

1368 i‡(
c
->
x86
 != 5)

1370 
c
->
x86_víd‹
) {

1371 
X86_VENDOR_INTEL
:

1372 
	`öãl_p5_mcheck_öô
(
c
);

1374 
X86_VENDOR_CENTAUR
:

1375 
	`wöchù_mcheck_öô
(
c
);

1378 
	}
}

1380 
	$__mcheck_˝u_öô_víd‹
(
˝uöfo_x86
 *
c
)

1382 
c
->
x86_víd‹
) {

1383 
X86_VENDOR_INTEL
:

1384 
	`m˚_öãl_„©uª_öô
(
c
);

1386 
X86_VENDOR_AMD
:

1387 
	`m˚_amd_„©uª_öô
(
c
);

1392 
	}
}

1394 
	$__mcheck_˝u_öô_timî
()

1396 
timî_li°
 *
t
 = &
	`__gë_˝u_v¨
(
m˚_timî
);

1397 *
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1399 
	`£tup_timî
(
t
, 
m˚_°¨t_timî
, 
	`smp_¥o˚ss‹_id
());

1401 i‡(
m˚_ign‹e_˚
)

1404 *
n
 = 
check_öãrvÆ
 * 
HZ
;

1405 i‡(!*
n
)

1407 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 + *
n
);

1408 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1409 
	}
}

1412 
	$u√x≥˘ed_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

1414 
	`¥ötk
(
KERN_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

1415 
	`smp_¥o˚ss‹_id
());

1416 
	}
}

1419 (*
machöe_check_ve˘‹
)(
±_ªgs
 *, 
îr‹_code
) =

1420 
u√x≥˘ed_machöe_check
;

1426 
__˝uöô
 
	$mcheck_˝u_öô
(
˝uöfo_x86
 *
c
)

1428 i‡(
m˚_dißbÀd
)

1431 
	`__mcheck_˝u_™cõ¡_öô
(
c
);

1433 i‡(!
	`m˚_avaûabÀ
(
c
))

1436 i‡(
	`__mcheck_˝u_ˇp_öô
(Ë< 0 || 
	`__mcheck_˝u_≠∂y_quúks
(
c
) < 0) {

1437 
m˚_dißbÀd
 = 1;

1441 
machöe_check_ve˘‹
 = 
do_machöe_check
;

1443 
	`__mcheck_˝u_öô_gíîic
();

1444 
	`__mcheck_˝u_öô_víd‹
(
c
);

1445 
	`__mcheck_˝u_öô_timî
();

1446 
	`INIT_WORK
(&
	`__gë_˝u_v¨
(
m˚_w‹k
), 
m˚_¥o˚ss_w‹k
);

1448 
	}
}

1454 
DEFINE_SPINLOCK
(
m˚_°©e_lock
);

1455 
	g›í_cou¡
;

1456 
	g›í_ex˛u
;

1458 
	$m˚_›í
(
öode
 *öode, 
fûe
 *file)

1460 
	`•ö_lock
(&
m˚_°©e_lock
);

1462 i‡(
›í_ex˛u
 || (
›í_cou¡
 && (
fûe
->
f_Êags
 & 
O_EXCL
))) {

1463 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1465  -
EBUSY
;

1468 i‡(
fûe
->
f_Êags
 & 
O_EXCL
)

1469 
›í_ex˛u
 = 1;

1470 
›í_cou¡
++;

1472 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1474  
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
);

1475 
	}
}

1477 
	$m˚_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1479 
	`•ö_lock
(&
m˚_°©e_lock
);

1481 
›í_cou¡
--;

1482 
›í_ex˛u
 = 0;

1484 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1487 
	}
}

1489 
	$cﬁÀ˘_tscs
(*
d©a
)

1491 *
˝u_tsc
 = (*)
d©a
;

1493 
	`rdts˛l
(
˝u_tsc
[
	`smp_¥o˚ss‹_id
()]);

1494 
	}
}

1496 
ssize_t
 
	$m˚_ªad
(
fûe
 *
fûp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

1497 
loff_t
 *
off
)

1499 
__u£r
 *
buf
 = 
ubuf
;

1500 *
˝u_tsc
;

1501 
¥ev
, 
√xt
;

1502 
i
, 
îr
;

1504 
˝u_tsc
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

1505 i‡(!
˝u_tsc
)

1506  -
ENOMEM
;

1508 
	`muãx_lock
(&
m˚_ªad_muãx
);

1509 
√xt
 = 
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.next);

1512 i‡(*
off
 !0 || 
usize
 < 
MCE_LOG_LEN
*(
m˚
)) {

1513 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1514 
	`k‰ì
(
˝u_tsc
);

1516  -
EINVAL
;

1519 
îr
 = 0;

1520 
¥ev
 = 0;

1522 
i
 = 
¥ev
; i < 
√xt
; i++) {

1523 
°¨t
 = 
jiffõs
;

1525 !
m˚log
.
íåy
[
i
].
föished
) {

1526 i‡(
	`time_a·î_eq
(
jiffõs
, 
°¨t
 + 2)) {

1527 
	`mem£t
(
m˚log
.
íåy
 + 
i
, 0,

1528 (
m˚
));

1529 
timeout
;

1531 
	`˝u_ªœx
();

1533 
	`smp_rmb
();

1534 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
 + 
i
,

1535 (
m˚
));

1536 
buf
 +(
m˚
);

1537 
timeout
:

1541 
	`mem£t
(
m˚log
.
íåy
 + 
¥ev
, 0,

1542 (
√xt
 - 
¥ev
Ë* (
m˚
));

1543 
¥ev
 = 
√xt
;

1544 
√xt
 = 
	`cmpxchg
(&
m˚log
.√xt, 
¥ev
, 0);

1545 } 
√xt
 !
¥ev
);

1547 
	`synchr⁄ize_sched
();

1553 
	`⁄_óch_˝u
(
cﬁÀ˘_tscs
, 
˝u_tsc
, 1);

1555 
i
 = 
√xt
; i < 
MCE_LOG_LEN
; i++) {

1556 i‡(
m˚log
.
íåy
[
i
].
föished
 &&

1557 
m˚log
.
íåy
[
i
].
tsc
 < 
˝u_tsc
[m˚log.íåy[i].
˝u
]) {

1558 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
+
i
,

1559 (
m˚
));

1560 
	`smp_rmb
();

1561 
buf
 +(
m˚
);

1562 
	`mem£t
(&
m˚log
.
íåy
[
i
], 0, (
m˚
));

1565 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1566 
	`k‰ì
(
˝u_tsc
);

1568  
îr
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

1569 
	}
}

1571 
	$m˚_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

1573 
	`pﬁl_waô
(
fûe
, &
m˚_waô
, 
waô
);

1574 i‡(
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.
√xt
))

1575  
POLLIN
 | 
POLLRDNORM
;

1577 
	}
}

1579 
	$m˚_io˘l
(
fûe
 *
f
, 
cmd
, 
¨g
)

1581 
__u£r
 *
p
 = (__u£∏*)
¨g
;

1583 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1584  -
EPERM
;

1586 
cmd
) {

1587 
MCE_GET_RECORD_LEN
:

1588  
	`put_u£r
((
m˚
), 
p
);

1589 
MCE_GET_LOG_LEN
:

1590  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

1591 
MCE_GETCLEAR_FLAGS
: {

1592 
Êags
;

1595 
Êags
 = 
m˚log
.flags;

1596 } 
	`cmpxchg
(&
m˚log
.
Êags
, flags, 0) != flags);

1598  
	`put_u£r
(
Êags
, 
p
);

1601  -
ENOTTY
;

1603 
	}
}

1606 
fûe_›î©i⁄s
 
	gm˚_chrdev_›s
 = {

1607 .
›í
 = 
m˚_›í
,

1608 .
	gªÀa£
 = 
m˚_ªÀa£
,

1609 .
	gªad
 = 
m˚_ªad
,

1610 .
	gpﬁl
 = 
m˚_pﬁl
,

1611 .
	gu∆ocked_io˘l
 = 
m˚_io˘l
,

1613 
EXPORT_SYMBOL_GPL
(
m˚_chrdev_›s
);

1615 
miscdevi˚
 
	gm˚_log_devi˚
 = {

1616 
MISC_MCELOG_MINOR
,

1618 &
m˚_chrdev_›s
,

1632 
__öô
 
	$mcheck_íabÀ
(*
°r
)

1634 i‡(*
°r
 == 0) {

1635 
	`íabÀ_p5_m˚
();

1638 i‡(*
°r
 == '=')

1639 
°r
++;

1640 i‡(!
	`°rcmp
(
°r
, "off"))

1641 
m˚_dißbÀd
 = 1;

1642 i‡(!
	`°rcmp
(
°r
, "no_cmci"))

1643 
m˚_cmci_dißbÀd
 = 1;

1644 i‡(!
	`°rcmp
(
°r
, "dont_log_ce"))

1645 
m˚_d⁄t_log_˚
 = 1;

1646 i‡(!
	`°rcmp
(
°r
, "ignore_ce"))

1647 
m˚_ign‹e_˚
 = 1;

1648 i‡(!
	`°rcmp
(
°r
, "bootlog") || !strcmp(str, "nobootlog"))

1649 
m˚_boŸlog
 = (
°r
[0] == 'b');

1650 i‡(
	`isdigô
(
°r
[0])) {

1651 
	`gë_›ti⁄
(&
°r
, &
tﬁî™t
);

1652 i‡(*
°r
 == ',') {

1653 ++
°r
;

1654 
	`gë_›ti⁄
(&
°r
, &
m⁄¨ch_timeout
);

1657 
	`¥ötk
(
KERN_INFO
 "mceárgument %s ignored. Please use /sys\n",

1658 
°r
);

1662 
	}
}

1663 
__£tup
("m˚", 
mcheck_íabÀ
);

1665 
__öô
 
	$mcheck_öô
()

1667 
	`©omic_nŸifõr_chaö_ªgi°î
(&
x86_m˚_decodî_chaö
, &
m˚_dec_nb
);

1669 
	`mcheck_öãl_thîm_öô
();

1672 
	}
}

1682 
	$m˚_dißbÀ_îr‹_ªp‹tög
()

1684 
i
;

1686 
i
 = 0; i < 
b™ks
; i++) {

1687 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1689 i‡(
b
->
öô
)

1690 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1693 
	}
}

1695 
	$m˚_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1697  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1698 
	}
}

1700 
	$m˚_shutdown
(
sys_devi˚
 *
dev
)

1702  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1703 
	}
}

1710 
	$m˚_ªsume
(
sys_devi˚
 *
dev
)

1712 
	`__mcheck_˝u_öô_gíîic
();

1713 
	`__mcheck_˝u_öô_víd‹
(&
cuºít_˝u_d©a
);

1716 
	}
}

1718 
	$m˚_˝u_ª°¨t
(*
d©a
)

1720 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1721 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1723 
	`__mcheck_˝u_öô_gíîic
();

1724 
	`__mcheck_˝u_öô_timî
();

1725 
	}
}

1728 
	$m˚_ª°¨t
()

1730 
	`⁄_óch_˝u
(
m˚_˝u_ª°¨t
, 
NULL
, 1);

1731 
	}
}

1734 
	$m˚_dißbÀ_˚
(*
Æl
)

1736 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1738 i‡(
Æl
)

1739 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1740 
	`cmci_˛ór
();

1741 
	}
}

1743 
	$m˚_íabÀ_˚
(*
Æl
)

1745 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1747 
	`cmci_ªíabÀ
();

1748 
	`cmci_ªcheck
();

1749 i‡(
Æl
)

1750 
	`__mcheck_˝u_öô_timî
();

1751 
	}
}

1753 
sysdev_˛ass
 
	gm˚_sys˛ass
 = {

1754 .
su•íd
 = 
m˚_su•íd
,

1755 .
	gshutdown
 = 
m˚_shutdown
,

1756 .
	gªsume
 = 
m˚_ªsume
,

1757 .
	g«me
 = "machinecheck",

1760 
DEFINE_PER_CPU
(
sys_devi˚
, 
m˚_dev
);

1762 
__˝uöôd©a


1763 (*
thªshﬁd_˝u_ˇŒback
)(
a˘i⁄
, 
˝u
);

1765 
ölöe
 
m˚_b™k
 *
	$©å_to_b™k
(
sysdev_©åibuã
 *
©å
)

1767  
	`c⁄èöî_of
(
©å
, 
m˚_b™k
,áttr);

1768 
	}
}

1770 
ssize_t
 
	$show_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1771 *
buf
)

1773  
	`•rötf
(
buf
, "%Œx\n", 
	`©å_to_b™k
(
©å
)->
˘l
);

1774 
	}
}

1776 
ssize_t
 
	$£t_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1777 c⁄° *
buf
, 
size_t
 
size
)

1779 
u64
 
√w
;

1781 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1782  -
EINVAL
;

1784 
	`©å_to_b™k
(
©å
)->
˘l
 = 
√w
;

1785 
	`m˚_ª°¨t
();

1787  
size
;

1788 
	}
}

1790 
ssize_t


1791 
	$show_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
, *
buf
)

1793 
	`°r˝y
(
buf
, 
m˚_hñ≥r
);

1794 
	`°rˇt
(
buf
, "\n");

1795  
	`°æí
(
m˚_hñ≥r
) + 1;

1796 
	}
}

1798 
ssize_t
 
	$£t_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1799 c⁄° *
buf
, 
size_t
 
siz
)

1801 *
p
;

1803 
	`°∫˝y
(
m˚_hñ≥r
, 
buf
, (mce_helper));

1804 
m˚_hñ≥r
[(mce_helper)-1] = 0;

1805 
p
 = 
	`°rchr
(
m˚_hñ≥r
, '\n');

1807 i‡(
p
)

1808 *
p
 = 0;

1810  
	`°æí
(
m˚_hñ≥r
Ë+ !!
p
;

1811 
	}
}

1813 
ssize_t
 
	$£t_ign‹e_˚
(
sys_devi˚
 *
s
,

1814 
sysdev_©åibuã
 *
©å
,

1815 c⁄° *
buf
, 
size_t
 
size
)

1817 
u64
 
√w
;

1819 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1820  -
EINVAL
;

1822 i‡(
m˚_ign‹e_˚
 ^ !!
√w
) {

1823 i‡(
√w
) {

1825 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, (*)1, 1);

1826 
m˚_ign‹e_˚
 = 1;

1829 
m˚_ign‹e_˚
 = 0;

1830 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, (*)1, 1);

1833  
size
;

1834 
	}
}

1836 
ssize_t
 
	$£t_cmci_dißbÀd
(
sys_devi˚
 *
s
,

1837 
sysdev_©åibuã
 *
©å
,

1838 c⁄° *
buf
, 
size_t
 
size
)

1840 
u64
 
√w
;

1842 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1843  -
EINVAL
;

1845 i‡(
m˚_cmci_dißbÀd
 ^ !!
√w
) {

1846 i‡(
√w
) {

1848 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, 
NULL
, 1);

1849 
m˚_cmci_dißbÀd
 = 1;

1852 
m˚_cmci_dißbÀd
 = 0;

1853 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, 
NULL
, 1);

1856  
size
;

1857 
	}
}

1859 
ssize_t
 
	$°‹e_öt_wôh_ª°¨t
(
sys_devi˚
 *
s
,

1860 
sysdev_©åibuã
 *
©å
,

1861 c⁄° *
buf
, 
size_t
 
size
)

1863 
ssize_t
 
ªt
 = 
	`sysdev_°‹e_öt
(
s
, 
©å
, 
buf
, 
size
);

1864 
	`m˚_ª°¨t
();

1865  
ªt
;

1866 
	}
}

1868 
SYSDEV_ATTR
(
åiggî
, 0644, 
show_åiggî
, 
£t_åiggî
);

1869 
SYSDEV_INT_ATTR
(
tﬁî™t
, 0644,Åolerant);

1870 
SYSDEV_INT_ATTR
(
m⁄¨ch_timeout
, 0644, monarch_timeout);

1871 
SYSDEV_INT_ATTR
(
d⁄t_log_˚
, 0644, 
m˚_d⁄t_log_˚
);

1873 
sysdev_ext_©åibuã
 
	g©å_check_öãrvÆ
 = {

1874 
_SYSDEV_ATTR
(
check_öãrvÆ
, 0644, 
sysdev_show_öt
,

1875 
°‹e_öt_wôh_ª°¨t
),

1876 &
check_öãrvÆ


1879 
sysdev_ext_©åibuã
 
	g©å_ign‹e_˚
 = {

1880 
_SYSDEV_ATTR
(
ign‹e_˚
, 0644, 
sysdev_show_öt
, 
£t_ign‹e_˚
),

1881 &
m˚_ign‹e_˚


1884 
sysdev_ext_©åibuã
 
	g©å_cmci_dißbÀd
 = {

1885 
_SYSDEV_ATTR
(
cmci_dißbÀd
, 0644, 
sysdev_show_öt
, 
£t_cmci_dißbÀd
),

1886 &
m˚_cmci_dißbÀd


1889 
sysdev_©åibuã
 *
	gm˚_©ås
[] = {

1890 &
©å_tﬁî™t
.
©å
,

1891 &
©å_check_öãrvÆ
.
©å
,

1892 &
©å_åiggî
,

1893 &
©å_m⁄¨ch_timeout
.
©å
,

1894 &
©å_d⁄t_log_˚
.
©å
,

1895 &
©å_ign‹e_˚
.
©å
,

1896 &
©å_cmci_dißbÀd
.
©å
,

1897 
NULL


1900 
˝umask_v¨_t
 
	gm˚_dev_öôülized
;

1903 
__˝uöô
 
	$m˚_¸óã_devi˚
(
˝u
)

1905 
îr
;

1906 
i
, 
j
;

1908 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1909  -
EIO
;

1911 
	`mem£t
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 0, (
kobje˘
));

1912 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
id
 = cpu;

1913 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
˛s
 = &
m˚_sys˛ass
;

1915 
îr
 = 
	`sysdev_ªgi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1916 i‡(
îr
)

1917  
îr
;

1919 
i
 = 0; 
m˚_©ås
[i]; i++) {

1920 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1921 i‡(
îr
)

1922 
îr‹
;

1924 
j
 = 0; j < 
b™ks
; j++) {

1925 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
),

1926 &
m˚_b™ks
[
j
].
©å
);

1927 i‡(
îr
)

1928 
îr‹2
;

1930 
	`˝umask_£t_˝u
(
˝u
, 
m˚_dev_öôülized
);

1933 
îr‹2
:

1934 --
j
 >= 0)

1935 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
j
].
©å
);

1936 
îr‹
:

1937 --
i
 >= 0)

1938 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1940 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1942  
îr
;

1943 
	}
}

1945 
__˝uöô
 
	$m˚_ªmove_devi˚
(
˝u
)

1947 
i
;

1949 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
m˚_dev_öôülized
))

1952 
i
 = 0; 
m˚_©ås
[i]; i++)

1953 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1955 
i
 = 0; i < 
b™ks
; i++)

1956 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
i
].
©å
);

1958 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1959 
	`˝umask_˛ór_˝u
(
˝u
, 
m˚_dev_öôülized
);

1960 
	}
}

1963 
__˝uöô
 
	$m˚_dißbÀ_˝u
(*
h
)

1965 
a˘i⁄
 = *(*)
h
;

1966 
i
;

1968 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1971 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1972 
	`cmci_˛ór
();

1973 
i
 = 0; i < 
b™ks
; i++) {

1974 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1976 i‡(
b
->
öô
)

1977 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1979 
	}
}

1981 
__˝uöô
 
	$m˚_ªíabÀ_˝u
(*
h
)

1983 
a˘i⁄
 = *(*)
h
;

1984 
i
;

1986 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1989 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1990 
	`cmci_ªíabÀ
();

1991 
i
 = 0; i < 
b™ks
; i++) {

1992 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1994 i‡(
b
->
öô
)

1995 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1997 
	}
}

2000 
__˝uöô


2001 
	$m˚_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
, *
h˝u
)

2003 
˝u
 = ()
h˝u
;

2004 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
˝u
);

2006 
a˘i⁄
) {

2007 
CPU_ONLINE
:

2008 
CPU_ONLINE_FROZEN
:

2009 
	`m˚_¸óã_devi˚
(
˝u
);

2010 i‡(
thªshﬁd_˝u_ˇŒback
)

2011 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2013 
CPU_DEAD
:

2014 
CPU_DEAD_FROZEN
:

2015 i‡(
thªshﬁd_˝u_ˇŒback
)

2016 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2017 
	`m˚_ªmove_devi˚
(
˝u
);

2019 
CPU_DOWN_PREPARE
:

2020 
CPU_DOWN_PREPARE_FROZEN
:

2021 
	`dñ_timî_sync
(
t
);

2022 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_dißbÀ_˝u
, &
a˘i⁄
, 1);

2024 
CPU_DOWN_FAILED
:

2025 
CPU_DOWN_FAILED_FROZEN
:

2026 i‡(!
m˚_ign‹e_˚
 && 
check_öãrvÆ
) {

2027 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 +

2028 
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
));

2029 
	`add_timî_⁄
(
t
, 
˝u
);

2031 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_ªíabÀ_˝u
, &
a˘i⁄
, 1);

2033 
CPU_POST_DEAD
:

2035 
	`cmci_ªdiscovî
(
˝u
);

2038  
NOTIFY_OK
;

2039 
	}
}

2041 
nŸifõr_block
 
m˚_˝u_nŸifõr
 
	g__˝uöôd©a
 = {

2042 .
nŸifõr_ˇŒ
 = 
m˚_˝u_ˇŒback
,

2045 
__öô
 
	$m˚_öô_b™ks
()

2047 
i
;

2049 
i
 = 0; i < 
b™ks
; i++) {

2050 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2051 
sysdev_©åibuã
 *
a
 = &
b
->
©å
;

2053 
	`sysfs_©å_öô
(&
a
->
©å
);

2054 
a
->
©å
.
«me
 = 
b
->
©å«me
;

2055 
	`¢¥ötf
(
b
->
©å«me
, 
ATTR_LEN
, "b™k%d", 
i
);

2057 
a
->
©å
.
mode
 = 0644;

2058 
a
->
show
 = 
show_b™k
;

2059 
a
->
°‹e
 = 
£t_b™k
;

2061 
	}
}

2063 
__öô
 
	$mcheck_öô_devi˚
()

2065 
îr
;

2066 
i
 = 0;

2068 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

2069  -
EIO
;

2071 
	`zÆloc_˝umask_v¨
(&
m˚_dev_öôülized
, 
GFP_KERNEL
);

2073 
	`m˚_öô_b™ks
();

2075 
îr
 = 
	`sysdev_˛ass_ªgi°î
(&
m˚_sys˛ass
);

2076 i‡(
îr
)

2077  
îr
;

2079 
	`f‹_óch_⁄löe_˝u
(
i
) {

2080 
îr
 = 
	`m˚_¸óã_devi˚
(
i
);

2081 i‡(
îr
)

2082  
îr
;

2085 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m˚_˝u_nŸifõr
);

2086 
	`misc_ªgi°î
(&
m˚_log_devi˚
);

2088  
îr
;

2089 
	}
}

2091 
devi˚_öôˇŒ
(
mcheck_öô_devi˚
);

2096 
__öô
 
	$mcheck_dißbÀ
(*
°r
)

2098 
m˚_dißbÀd
 = 1;

2100 
	}
}

2101 
__£tup
("nom˚", 
mcheck_dißbÀ
);

2103 #ifde‡
CONFIG_DEBUG_FS


2104 
díåy
 *
	$m˚_gë_debugfs_dú
()

2106 
díåy
 *
dm˚
;

2108 i‡(!
dm˚
)

2109 
dm˚
 = 
	`debugfs_¸óã_dú
("m˚", 
NULL
);

2111  
dm˚
;

2112 
	}
}

2114 
	$m˚_ª£t
()

2116 
˝u_missög
 = 0;

2117 
	`©omic_£t
(&
m˚_Áke_∑ni˚d
, 0);

2118 
	`©omic_£t
(&
m˚_executög
, 0);

2119 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

2120 
	`©omic_£t
(&
globÆ_nwo
, 0);

2121 
	}
}

2123 
	$Áke_∑nic_gë
(*
d©a
, 
u64
 *
vÆ
)

2125 *
vÆ
 = 
Áke_∑nic
;

2127 
	}
}

2129 
	$Áke_∑nic_£t
(*
d©a
, 
u64
 
vÆ
)

2131 
	`m˚_ª£t
();

2132 
Áke_∑nic
 = 
vÆ
;

2134 
	}
}

2136 
DEFINE_SIMPLE_ATTRIBUTE
(
Áke_∑nic_f›s
, 
Áke_∑nic_gë
,

2137 
Áke_∑nic_£t
, "%llu\n");

2139 
__öô
 
	$mcheck_debugfs_öô
()

2141 
díåy
 *
dm˚
, *
fÁke_∑nic
;

2143 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

2144 i‡(!
dm˚
)

2145  -
ENOMEM
;

2146 
fÁke_∑nic
 = 
	`debugfs_¸óã_fûe
("Áke_∑nic", 0444, 
dm˚
, 
NULL
,

2147 &
Áke_∑nic_f›s
);

2148 i‡(!
fÁke_∑nic
)

2149  -
ENOMEM
;

2152 
	}
}

2153 
œã_öôˇŒ
(
mcheck_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/kobje˘.h
>

19 
	~<löux/≥r˝u.h
>

20 
	~<löux/sysdev.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/sysfs.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/˝u.h
>

27 
	~<löux/smp.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

34 
	#PFX
 "m˚_thªshﬁd: "

	)

35 
	#VERSION
 "vîsi⁄ 1.1.1"

	)

36 
	#NR_BANKS
 6

	)

37 
	#NR_BLOCKS
 9

	)

38 
	#THRESHOLD_MAX
 0xFFF

	)

39 
	#INT_TYPE_APIC
 0x00020000

	)

40 
	#MASK_VALID_HI
 0x80000000

	)

41 
	#MASK_CNTP_HI
 0x40000000

	)

42 
	#MASK_LOCKED_HI
 0x20000000

	)

43 
	#MASK_LVTOFF_HI
 0x00F00000

	)

44 
	#MASK_COUNT_EN_HI
 0x00080000

	)

45 
	#MASK_INT_TYPE_HI
 0x00060000

	)

46 
	#MASK_OVERFLOW_HI
 0x00010000

	)

47 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

48 
	#MASK_BLKPTR_LO
 0xFF000000

	)

49 
	#MCG_XBLK_ADDR
 0xC0000400

	)

51 
	sthªshﬁd_block
 {

52 
	mblock
;

53 
	mb™k
;

54 
	m˝u
;

55 
u32
 
	maddªss
;

56 
u16
 
	möãºu±_íabÀ
;

57 
u16
 
	mthªshﬁd_limô
;

58 
kobje˘
 
	mkobj
;

59 
li°_hód
 
	mmiscj
;

63 
thªshﬁd_block
 
	gthªshﬁd_deÁu…s
 = {

64 .
öãºu±_íabÀ
 = 0,

65 .
	gthªshﬁd_limô
 = 
THRESHOLD_MAX
,

68 
	sthªshﬁd_b™k
 {

69 
kobje˘
 *
	mkobj
;

70 
thªshﬁd_block
 *
	mblocks
;

71 
˝umask_v¨_t
 
	m˝us
;

73 
DEFINE_PER_CPU
(
thªshﬁd_b™k
 * [
NR_BANKS
], 
thªshﬁd_b™ks
);

75 #ifde‡
CONFIG_SMP


76 
	gsh¨ed_b™k
[
NR_BANKS
] = {

81 
DEFINE_PER_CPU
(, 
b™k_m≠
);

83 
amd_thªshﬁd_öãºu±
();

89 
	sthªsh_ª°¨t
 {

90 
thªshﬁd_block
 *
	mb
;

91 
	mª£t
;

92 
u16
 
	mﬁd_limô
;

97 
	$thªshﬁd_ª°¨t_b™k
(*
_å
)

99 
thªsh_ª°¨t
 *
å
 = 
_å
;

100 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

102 
	`rdm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

104 i‡(
å
->
b
->
thªshﬁd_limô
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

105 
å
->
ª£t
 = 1;

107 i‡(
å
->
ª£t
) {

108 
mci_misc_hi
 =

109 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

110 (
THRESHOLD_MAX
 - 
å
->
b
->
thªshﬁd_limô
);

111 } i‡(
å
->
ﬁd_limô
) {

112 
√w_cou¡
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

113 (
å
->
ﬁd_limô
 -År->
b
->
thªshﬁd_limô
);

115 
mci_misc_hi
 = (mci_misc_hò& ~
MASK_ERR_COUNT_HI
) |

116 (
√w_cou¡
 & 
THRESHOLD_MAX
);

119 
å
->
b
->
öãºu±_íabÀ
 ?

120 (
mci_misc_hi
 = (mci_misc_hò& ~
MASK_INT_TYPE_HI
Ë| 
INT_TYPE_APIC
) :

121 (
mci_misc_hi
 &~
MASK_INT_TYPE_HI
);

123 
mci_misc_hi
 |
MASK_COUNT_EN_HI
;

124 
	`wrm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

125 
	}
}

128 
	$m˚_amd_„©uª_öô
(
˝uöfo_x86
 *
c
)

130 
˝u
 = 
	`smp_¥o˚ss‹_id
();

131 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

132 
b™k
, 
block
;

133 
thªsh_ª°¨t
 
å
;

134 
u8
 
lvt_off
;

136 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

137 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

138 i‡(
block
 == 0)

139 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

140 i‡(
block
 == 1) {

141 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

142 i‡(!
addªss
)

144 
addªss
 +
MCG_XBLK_ADDR
;

146 ++
addªss
;

148 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

151 i‡(!(
high
 & 
MASK_VALID_HI
)) {

152 i‡(
block
)

158 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

159 (
high
 & 
MASK_LOCKED_HI
))

162 i‡(!
block
)

163 
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë|(1 << 
b™k
);

164 #ifde‡
CONFIG_SMP


165 i‡(
sh¨ed_b™k
[
b™k
] && 
c
->
˝u_c‹e_id
)

168 
lvt_off
 = 
	`£tup_APIC_eûvt_m˚
(
THRESHOLD_APIC_VECTOR
,

169 
APIC_EILVT_MSG_FIX
, 0);

171 
high
 &~
MASK_LVTOFF_HI
;

172 
high
 |
lvt_off
 << 20;

173 
	`wrm§
(
addªss
, 
low
, 
high
);

175 
thªshﬁd_deÁu…s
.
addªss
 =áddress;

176 
å
.
b
 = &
thªshﬁd_deÁu…s
;

177 
å
.
ª£t
 = 0;

178 
å
.
ﬁd_limô
 = 0;

179 
	`thªshﬁd_ª°¨t_b™k
(&
å
);

181 
m˚_thªshﬁd_ve˘‹
 = 
amd_thªshﬁd_öãºu±
;

184 
	}
}

195 
	$amd_thªshﬁd_öãºu±
()

197 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

198 
b™k
, 
block
;

199 
m˚
 
m
;

201 
	`m˚_£tup
(&
m
);

204 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

205 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
m
.
˝u
Ë& (1 << 
b™k
)))

207 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

208 i‡(
block
 == 0) {

209 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

210 } i‡(
block
 == 1) {

211 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

212 i‡(!
addªss
)

214 
addªss
 +
MCG_XBLK_ADDR
;

216 ++
addªss
;

219 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

222 i‡(!(
high
 & 
MASK_VALID_HI
)) {

223 i‡(
block
)

229 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

230 (
high
 & 
MASK_LOCKED_HI
))

237 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

238 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

240 i‡(
high
 & 
MASK_OVERFLOW_HI
) {

241 
	`rdm§l
(
addªss
, 
m
.
misc
);

242 
	`rdm§l
(
MSR_IA32_MC0_STATUS
 + 
b™k
 * 4,

243 
m
.
°©us
);

244 
m
.
b™k
 = 
K8_MCE_THRESHOLD_BASE


245 + 
b™k
 * 
NR_BLOCKS


246 + 
block
;

247 
	`m˚_log
(&
m
);

252 
	}
}

258 
	sthªshﬁd_©å
 {

259 
©åibuã
 
	m©å
;

260 
ssize_t
 (*
show
Ë(
	mthªshﬁd_block
 *, *);

261 
ssize_t
 (*
°‹e
Ë(
	mthªshﬁd_block
 *, c⁄° *, 
size_t
 
	mcou¡
);

264 
	#SHOW_FIELDS
(
«me
) \

265 
ssize_t
 
show_
 ## 
	`«me
(
thªshﬁd_block
 *
b
, *
buf
) \

267  
	`•rötf
(
buf
, "%lx\n", (Ë
b
->
«me
); \

268 }

	)

269 
	$SHOW_FIELDS
(
öãºu±_íabÀ
)

270 
	$SHOW_FIELDS
(
thªshﬁd_limô
)

272 
ssize_t


273 
	$°‹e_öãºu±_íabÀ
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

275 
thªsh_ª°¨t
 
å
;

276 
√w
;

278 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

279  -
EINVAL
;

281 
b
->
öãºu±_íabÀ
 = !!
√w
;

283 
å
.
b
 = b;

284 
å
.
ª£t
 = 0;

285 
å
.
ﬁd_limô
 = 0;

287 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

289  
size
;

290 
	}
}

292 
ssize_t


293 
	$°‹e_thªshﬁd_limô
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

295 
thªsh_ª°¨t
 
å
;

296 
√w
;

298 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

299  -
EINVAL
;

301 i‡(
√w
 > 
THRESHOLD_MAX
)

302 
√w
 = 
THRESHOLD_MAX
;

303 i‡(
√w
 < 1)

304 
√w
 = 1;

306 
å
.
ﬁd_limô
 = 
b
->
thªshﬁd_limô
;

307 
b
->
thªshﬁd_limô
 = 
√w
;

308 
å
.
b
 = b;

309 
å
.
ª£t
 = 0;

311 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

313  
size
;

314 
	}
}

316 
	sthªshﬁd_block_¸oss_˝u
 {

317 
thªshﬁd_block
 *
	mtb
;

318 
	mªtvÆ
;

321 
	$loˇl_îr‹_cou¡_h™dÀr
(*
_tbcc
)

323 
thªshﬁd_block_¸oss_˝u
 *
tbcc
 = 
_tbcc
;

324 
thªshﬁd_block
 *
b
 = 
tbcc
->
tb
;

325 
u32
 
low
, 
high
;

327 
	`rdm§
(
b
->
addªss
, 
low
, 
high
);

328 
tbcc
->
ªtvÆ
 = (
high
 & 0xFFFË- (
THRESHOLD_MAX
 - 
b
->
thªshﬁd_limô
);

329 
	}
}

331 
ssize_t
 
	$show_îr‹_cou¡
(
thªshﬁd_block
 *
b
, *
buf
)

333 
thªshﬁd_block_¸oss_˝u
 
tbcc
 = { .
tb
 = 
b
, };

335 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
loˇl_îr‹_cou¡_h™dÀr
, &
tbcc
, 1);

336  
	`•rötf
(
buf
, "%lx\n", 
tbcc
.
ªtvÆ
);

337 
	}
}

339 
ssize_t
 
	$°‹e_îr‹_cou¡
(
thªshﬁd_block
 *
b
,

340 c⁄° *
buf
, 
size_t
 
cou¡
)

342 
thªsh_ª°¨t
 
å
 = { .
b
 = b, .
ª£t
 = 1, .
ﬁd_limô
 = 0 };

344 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

346 
	}
}

348 
	#RW_ATTR
(
vÆ
) \

349 
thªshﬁd_©å
 
vÆ
 = { \

350 .
©å
 = {.
«me
 = 
	`__°rögify
(
vÆ
), .
mode
 = 0644 }, \

351 .
show
 = 
show_
## 
vÆ
, \

352 .
°‹e
 = 
°‹e_
## 
vÆ
, \

353 };

	)

355 
RW_ATTR
(
öãºu±_íabÀ
);

356 
RW_ATTR
(
thªshﬁd_limô
);

357 
RW_ATTR
(
îr‹_cou¡
);

359 
©åibuã
 *
	gdeÁu…_©ås
[] = {

360 &
öãºu±_íabÀ
.
©å
,

361 &
thªshﬁd_limô
.
©å
,

362 &
îr‹_cou¡
.
©å
,

363 
NULL


366 
	#to_block
(
k
Ë
	`c⁄èöî_of
(k, 
thªshﬁd_block
, 
kobj
)

	)

367 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
thªshﬁd_©å
, 
©å
)

	)

369 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

371 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

372 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

373 
ssize_t
 
ªt
;

375 
ªt
 = 
a
->
show
 ?á->
	`show
(
b
, 
buf
Ë: -
EIO
;

377  
ªt
;

378 
	}
}

380 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

381 c⁄° *
buf
, 
size_t
 
cou¡
)

383 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

384 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

385 
ssize_t
 
ªt
;

387 
ªt
 = 
a
->
°‹e
 ?á->
	`°‹e
(
b
, 
buf
, 
cou¡
Ë: -
EIO
;

389  
ªt
;

390 
	}
}

392 c⁄° 
sysfs_›s
 
	gthªshﬁd_›s
 = {

393 .
show
 = show,

394 .
	g°‹e
 = 
°‹e
,

397 
kobj_ty≥
 
	gthªshﬁd_kty≥
 = {

398 .
sysfs_›s
 = &
thªshﬁd_›s
,

399 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

402 
__˝uöô
 
	$Æloˇã_thªshﬁd_blocks
(
˝u
,

403 
b™k
,

404 
block
,

405 
u32
 
addªss
)

407 
thªshﬁd_block
 *
b
 = 
NULL
;

408 
u32
 
low
, 
high
;

409 
îr
;

411 i‡((
b™k
 >
NR_BANKS
Ë|| (
block
 >
NR_BLOCKS
))

414 i‡(
	`rdm§_ß„_⁄_˝u
(
˝u
, 
addªss
, &
low
, &
high
))

417 i‡(!(
high
 & 
MASK_VALID_HI
)) {

418 i‡(
block
)

419 
ªcur£
;

424 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

425 (
high
 & 
MASK_LOCKED_HI
))

426 
ªcur£
;

428 
b
 = 
	`kzÆloc
((
thªshﬁd_block
), 
GFP_KERNEL
);

429 i‡(!
b
)

430  -
ENOMEM
;

432 
b
->
block
 = block;

433 
b
->
b™k
 = bank;

434 
b
->
˝u
 = cpu;

435 
b
->
addªss
 =áddress;

436 
b
->
öãºu±_íabÀ
 = 0;

437 
b
->
thªshﬁd_limô
 = 
THRESHOLD_MAX
;

439 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

441 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
) {

442 
	`li°_add
(&
b
->
miscj
,

443 &
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
->
miscj
);

445 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
b
;

448 
îr
 = 
	`kobje˘_öô_™d_add
(&
b
->
kobj
, &
thªshﬁd_kty≥
,

449 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
kobj
,

450 "misc%i", 
block
);

451 i‡(
îr
)

452 
out_‰ì
;

453 
ªcur£
:

454 i‡(!
block
) {

455 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

456 i‡(!
addªss
)

458 
addªss
 +
MCG_XBLK_ADDR
;

460 ++
addªss
;

463 
îr
 = 
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, ++
block
, 
addªss
);

464 i‡(
îr
)

465 
out_‰ì
;

467 i‡(
b
)

468 
	`kobje˘_uevít
(&
b
->
kobj
, 
KOBJ_ADD
);

470  
îr
;

472 
out_‰ì
:

473 i‡(
b
) {

474 
	`kobje˘_put
(&
b
->
kobj
);

475 
	`k‰ì
(
b
);

477  
îr
;

478 
	}
}

480 
__˝uöô
 

481 
	$loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
)

483  
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, 0,

484 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4);

485 
	}
}

488 
__˝uöô
 
	$thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
)

490 
i
, 
îr
 = 0;

491 
thªshﬁd_b™k
 *
b
 = 
NULL
;

492 
«me
[32];

493 #ifde‡
CONFIG_SMP


494 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

497 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

499 #ifde‡
CONFIG_SMP


500 i‡(
	`˝u_d©a
(
˝u
).
˝u_c‹e_id
 && 
sh¨ed_b™k
[
b™k
]) {

501 
i
 = 
	`˝umask_fú°
(
c
->
Œc_sh¨ed_m≠
);

504 i‡(
	`˝u_d©a
(
i
).
˝u_c‹e_id
)

505 
out
;

508 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
])

509 
out
;

511 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
];

513 i‡(!
b
)

514 
out
;

516 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
,

517 
b
->
kobj
, 
«me
);

518 i‡(
îr
)

519 
out
;

521 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

522 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

524 
out
;

528 
b
 = 
	`kzÆloc
((
thªshﬁd_b™k
), 
GFP_KERNEL
);

529 i‡(!
b
) {

530 
îr
 = -
ENOMEM
;

531 
out
;

533 i‡(!
	`Æloc_˝umask_v¨
(&
b
->
˝us
, 
GFP_KERNEL
)) {

534 
	`k‰ì
(
b
);

535 
îr
 = -
ENOMEM
;

536 
out
;

539 
b
->
kobj
 = 
	`kobje˘_¸óã_™d_add
(
«me
, &
	`≥r_˝u
(
m˚_dev
, 
˝u
).kobj);

540 i‡(!
b
->
kobj
)

541 
out_‰ì
;

543 #i‚de‡
CONFIG_SMP


544 
	`˝umask_£èŒ
(
b
->
˝us
);

546 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

549 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

551 
îr
 = 
	`loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
);

552 i‡(
îr
)

553 
out_‰ì
;

555 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

556 i‡(
i
 =
˝u
)

559 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
,

560 
b
->
kobj
, 
«me
);

561 i‡(
îr
)

562 
out
;

564 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
b
;

567 
out
;

569 
out_‰ì
:

570 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

571 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

572 
	`k‰ì
(
b
);

573 
out
:

574  
îr
;

575 
	}
}

578 
__˝uöô
 
	$thªshﬁd_¸óã_devi˚
(
˝u
)

580 
b™k
;

581 
îr
 = 0;

583 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

584 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

586 
îr
 = 
	`thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
);

587 i‡(
îr
)

588 
out
;

590 
out
:

591  
îr
;

592 
	}
}

600 
	$dóŒoˇã_thªshﬁd_block
(
˝u
,

601 
b™k
)

603 
thªshﬁd_block
 *
pos
 = 
NULL
;

604 
thªshﬁd_block
 *
tmp
 = 
NULL
;

605 
thªshﬁd_b™k
 *
hód
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

607 i‡(!
hód
)

610 
	`li°_f‹_óch_íåy_ß„
(
pos
, 
tmp
, &
hód
->
blocks
->
miscj
, miscj) {

611 
	`kobje˘_put
(&
pos
->
kobj
);

612 
	`li°_dñ
(&
pos
->
miscj
);

613 
	`k‰ì
(
pos
);

616 
	`k‰ì
(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
);

617 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
NULL
;

618 
	}
}

620 
	$thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
)

622 
thªshﬁd_b™k
 *
b
;

623 
«me
[32];

624 
i
 = 0;

626 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

627 i‡(!
b
)

629 i‡(!
b
->
blocks
)

630 
‰ì_out
;

632 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

634 #ifde‡
CONFIG_SMP


636 i‡(
sh¨ed_b™k
[
b™k
] && 
b
->
blocks
->
˝u
 != cpu) {

637 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 
«me
);

638 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

645 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

646 i‡(
i
 =
˝u
)

649 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
, 
«me
);

650 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
NULL
;

653 
	`dóŒoˇã_thªshﬁd_block
(
˝u
, 
b™k
);

655 
‰ì_out
:

656 
	`kobje˘_dñ
(
b
->
kobj
);

657 
	`kobje˘_put
(
b
->
kobj
);

658 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

659 
	`k‰ì
(
b
);

660 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

661 
	}
}

663 
	$thªshﬁd_ªmove_devi˚
(
˝u
)

665 
b™k
;

667 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

668 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

670 
	`thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
);

672 
	}
}

675 
__˝uöô


676 
	$amd_64_thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
)

678 
a˘i⁄
) {

679 
CPU_ONLINE
:

680 
CPU_ONLINE_FROZEN
:

681 
	`thªshﬁd_¸óã_devi˚
(
˝u
);

683 
CPU_DEAD
:

684 
CPU_DEAD_FROZEN
:

685 
	`thªshﬁd_ªmove_devi˚
(
˝u
);

690 
	}
}

692 
__öô
 
	$thªshﬁd_öô_devi˚
()

694 
l˝u
 = 0;

697 
	`f‹_óch_⁄löe_˝u
(
l˝u
) {

698 
îr
 = 
	`thªshﬁd_¸óã_devi˚
(
l˝u
);

700 i‡(
îr
)

701  
îr
;

703 
thªshﬁd_˝u_ˇŒback
 = 
amd_64_thªshﬁd_˝u_ˇŒback
;

706 
	}
}

707 
devi˚_öôˇŒ
(
thªshﬁd_öô_devi˚
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c

8 
	~<löux/gÂ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/öãºu±.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/sched.h
>

13 
	~<asm/≠ic.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/m§.h
>

16 
	~<asm/m˚.h
>

25 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_b™ks_ow√d
);

31 
DEFINE_SPINLOCK
(
cmci_discovî_lock
);

33 
	#CMCI_THRESHOLD
 1

	)

35 
	$cmci_suµ‹ãd
(*
b™ks
)

37 
u64
 
ˇp
;

39 i‡(
m˚_cmci_dißbÀd
 || 
m˚_ign‹e_˚
)

47 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
)

49 i‡(!
˝u_has_≠ic
 || 
	`œpic_gë_maxlvt
() < 6)

51 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

52 *
b™ks
 = 
	`mö_t
(, 
MAX_NR_BANKS
, 
ˇp
 & 0xff);

53  !!(
ˇp
 & 
MCG_CMCI_P
);

54 
	}
}

62 
	$öãl_thªshﬁd_öãºu±
()

64 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

65 
	`m˚_nŸify_úq
();

66 
	}
}

68 
	$¥öt_upd©e
(*
ty≥
, *
hdr
, 
num
)

70 i‡(*
hdr
 == 0)

71 
	`¥ötk
(
KERN_INFO
 "CPU %d MCA b™ks", 
	`smp_¥o˚ss‹_id
());

72 *
hdr
 = 1;

73 
	`¥ötk
(
KERN_CONT
 " %s:%d", 
ty≥
, 
num
);

74 
	}
}

81 
	$cmci_discovî
(
b™ks
, 
boŸ
)

83 *
ow√d
 = (*)&
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
);

84 
Êags
;

85 
hdr
 = 0;

86 
i
;

88 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

89 
i
 = 0; i < 
b™ks
; i++) {

90 
u64
 
vÆ
;

92 i‡(
	`ã°_bô
(
i
, 
ow√d
))

95 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

98 i‡(
vÆ
 & 
CMCI_EN
) {

99 i‡(
	`ã°_™d_˛ór_bô
(
i
, 
ow√d
Ë&& !
boŸ
)

100 
	`¥öt_upd©e
("SHD", &
hdr
, 
i
);

101 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

105 
vÆ
 |
CMCI_EN
 | 
CMCI_THRESHOLD
;

106 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

107 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

110 i‡(
vÆ
 & 
CMCI_EN
) {

111 i‡(!
	`ã°_™d_£t_bô
(
i
, 
ow√d
Ë&& !
boŸ
)

112 
	`¥öt_upd©e
("CMCI", &
hdr
, 
i
);

113 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

115 
	`WARN_ON
(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
)));

118 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

119 i‡(
hdr
)

120 
	`¥ötk
(
KERN_CONT
 "\n");

121 
	}
}

127 
	$cmci_ªcheck
()

129 
Êags
;

130 
b™ks
;

132 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
Ë|| !
	`cmci_suµ‹ãd
(&
b™ks
))

134 
	`loˇl_úq_ßve
(
Êags
);

135 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

136 
	`loˇl_úq_ª°‹e
(
Êags
);

137 
	}
}

143 
	$cmci_˛ór
()

145 
Êags
;

146 
i
;

147 
b™ks
;

148 
u64
 
vÆ
;

150 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

152 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

153 
i
 = 0; i < 
b™ks
; i++) {

154 i‡(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
)))

157 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

158 
vÆ
 &~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

159 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

160 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

162 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

163 
	}
}

169 
	$cmci_ªdiscovî
(
dyög
)

171 
b™ks
;

172 
˝u
;

173 
˝umask_v¨_t
 
ﬁd
;

175 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

177 i‡(!
	`Æloc_˝umask_v¨
(&
ﬁd
, 
GFP_KERNEL
))

179 
	`˝umask_c›y
(
ﬁd
, &
cuºít
->
˝us_Ælowed
);

181 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

182 i‡(
˝u
 =
dyög
)

184 i‡(
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
˝u
)))

187 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

188 
	`cmci_discovî
(
b™ks
, 0);

191 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
ﬁd
);

192 
	`‰ì_˝umask_v¨
(
ﬁd
);

193 
	}
}

198 
	$cmci_ªíabÀ
()

200 
b™ks
;

201 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

202 
	`cmci_discovî
(
b™ks
, 0);

203 
	}
}

205 
	$öãl_öô_cmci
()

207 
b™ks
;

209 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

212 
m˚_thªshﬁd_ve˘‹
 = 
öãl_thªshﬁd_öãºu±
;

213 
	`cmci_discovî
(
b™ks
, 1);

220 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

221 
	`cmci_ªcheck
();

222 
	}
}

224 
	$m˚_öãl_„©uª_öô
(
˝uöfo_x86
 *
c
)

226 
	`öãl_öô_thîmÆ
(
c
);

227 
	`öãl_öô_cmci
();

228 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/jiffõs.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/≥r˝u.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/˝u.h
>

27 
	~<asm/¥o˚ss‹.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

35 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

40 
	sthîmÆ_°©e
 {

41 
boﬁ
 
	mis_thrŸéed
;

43 
u64
 
	m√xt_check
;

44 
	mthrŸée_cou¡
;

45 
	mœ°_thrŸée_cou¡
;

48 
DEFINE_PER_CPU
(
thîmÆ_°©e
,Åhermal_state);

50 
©omic_t
 
	gthîm_thrŸ_í
 = 
ATOMIC_INIT
(0);

52 
u32
 
lvâhmr_öô
 
	g__ªad_mo°ly
;

54 #ifde‡
CONFIG_SYSFS


55 
	#deföe_thîm_thrŸ_sysdev_⁄e_ro
(
_«me
) \

56 
	`SYSDEV_ATTR
(
_«me
, 0444, 
thîm_thrŸ_sysdev_show_
##_«me, 
NULL
)

	)

58 
	#deföe_thîm_thrŸ_sysdev_show_func
(
«me
) \

60 
ssize_t
 
thîm_thrŸ_sysdev_show_
##
	`«me
( \

61 
sys_devi˚
 *
dev
, \

62 
sysdev_©åibuã
 *
©å
, \

63 *
buf
) \

65 
˝u
 = 
dev
->
id
; \

66 
ssize_t
 
ªt
; \

68 
	`¥ìm±_dißbÀ
(); \

69 i‡(
	`˝u_⁄löe
(
˝u
)) \

70 
ªt
 = 
	`•rötf
(
buf
, "%lu\n", \

71 
	`≥r_˝u
(
thîmÆ_°©e
, 
˝u
).
«me
); \

73 
ªt
 = 0; \

74 
	`¥ìm±_íabÀ
(); \

76  
ªt
; \

77 }

	)

79 
deföe_thîm_thrŸ_sysdev_show_func
(
thrŸée_cou¡
);

80 
deföe_thîm_thrŸ_sysdev_⁄e_ro
(
thrŸée_cou¡
);

82 
©åibuã
 *
	gthîmÆ_thrŸée_©ås
[] = {

83 &
©å_thrŸée_cou¡
.
©å
,

84 
NULL


87 
©åibuã_group
 
	gthîmÆ_thrŸée_©å_group
 = {

88 .
©ås
 = 
thîmÆ_thrŸée_©ås
,

89 .
	g«me
 = "thermal_throttle"

109 
	$thîm_thrŸ_¥o˚ss
(
boﬁ
 
is_thrŸéed
)

111 
thîmÆ_°©e
 *
°©e
;

112 
this_˝u
;

113 
boﬁ
 
was_thrŸéed
;

114 
u64
 
now
;

116 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

117 
now
 = 
	`gë_jiffõs_64
();

118 
°©e
 = &
	`≥r_˝u
(
thîmÆ_°©e
, 
this_˝u
);

120 
was_thrŸéed
 = 
°©e
->
is_thrŸéed
;

121 
°©e
->
is_thrŸéed
 = is_throttled;

123 i‡(
is_thrŸéed
)

124 
°©e
->
thrŸée_cou¡
++;

126 i‡(
	`time_bef‹e64
(
now
, 
°©e
->
√xt_check
) &&

127 
°©e
->
thrŸée_cou¡
 !°©e->
œ°_thrŸée_cou¡
)

130 
°©e
->
√xt_check
 = 
now
 + 
CHECK_INTERVAL
;

131 
°©e
->
œ°_thrŸée_cou¡
 = sèã->
thrŸée_cou¡
;

134 i‡(
is_thrŸéed
) {

135 
	`¥ötk
(
KERN_CRIT
 "CPU%d: Tem≥øtuªábovêthªshﬁd, cpu clockÅhrŸéed (tŸÆÉvít†%lu)\n", 
this_˝u
, 
°©e
->
thrŸée_cou¡
);

137 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

140 i‡(
was_thrŸéed
) {

141 
	`¥ötk
(
KERN_INFO
 "CPU%d: Tem≥øtuª/•ìdÇ‹mÆ\n", 
this_˝u
);

146 
	}
}

148 #ifde‡
CONFIG_SYSFS


150 
__˝uöô
 
	$thîmÆ_thrŸée_add_dev
(
sys_devi˚
 *
sys_dev
)

152  
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
,

153 &
thîmÆ_thrŸée_©å_group
);

154 
	}
}

156 
__˝uöô
 
	$thîmÆ_thrŸée_ªmove_dev
(
sys_devi˚
 *
sys_dev
)

158 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
thîmÆ_thrŸée_©å_group
);

159 
	}
}

162 
DEFINE_MUTEX
(
thîm_˝u_lock
);

165 
__˝uöô
 

166 
	$thîmÆ_thrŸée_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

167 
a˘i⁄
,

168 *
h˝u
)

170 
˝u
 = ()
h˝u
;

171 
sys_devi˚
 *
sys_dev
;

172 
îr
 = 0;

174 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

176 
a˘i⁄
) {

177 
CPU_UP_PREPARE
:

178 
CPU_UP_PREPARE_FROZEN
:

179 
	`muãx_lock
(&
thîm_˝u_lock
);

180 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
sys_dev
);

181 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

182 
	`WARN_ON
(
îr
);

184 
CPU_UP_CANCELED
:

185 
CPU_UP_CANCELED_FROZEN
:

186 
CPU_DEAD
:

187 
CPU_DEAD_FROZEN
:

188 
	`muãx_lock
(&
thîm_˝u_lock
);

189 
	`thîmÆ_thrŸée_ªmove_dev
(
sys_dev
);

190 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

193  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

194 
	}
}

196 
nŸifõr_block
 
thîmÆ_thrŸée_˝u_nŸifõr
 
	g__˝uöôd©a
 =

198 .
nŸifõr_ˇŒ
 = 
thîmÆ_thrŸée_˝u_ˇŒback
,

201 
__öô
 
	$thîmÆ_thrŸée_öô_devi˚
()

203 
˝u
 = 0;

204 
îr
;

206 i‡(!
	`©omic_ªad
(&
thîm_thrŸ_í
))

209 
	`ªgi°î_hŸ˝u_nŸifõr
(&
thîmÆ_thrŸée_˝u_nŸifõr
);

211 #ifde‡
CONFIG_HOTPLUG_CPU


212 
	`muãx_lock
(&
thîm_˝u_lock
);

215 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

216 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
	`gë_˝u_sysdev
(
˝u
));

217 
	`WARN_ON
(
îr
);

219 #ifde‡
CONFIG_HOTPLUG_CPU


220 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

224 
	}
}

225 
devi˚_öôˇŒ
(
thîmÆ_thrŸée_öô_devi˚
);

230 
	$öãl_thîmÆ_öãºu±
()

232 
__u64
 
m§_vÆ
;

234 
	`rdm§l
(
MSR_IA32_THERM_STATUS
, 
m§_vÆ
);

235 i‡(
	`thîm_thrŸ_¥o˚ss
((
m§_vÆ
 & 
THERM_STATUS_PROCHOT
) != 0))

236 
	`m˚_log_thîm_thrŸ_evít
(
m§_vÆ
);

237 
	}
}

239 
	$u√x≥˘ed_thîmÆ_öãºu±
()

241 
	`¥ötk
(
KERN_ERR
 "CPU%d: Unexpected LVT TMR interrupt!\n",

242 
	`smp_¥o˚ss‹_id
());

243 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

244 
	}
}

246 (*
smp_thîmÆ_ve˘‹
)(Ë
u√x≥˘ed_thîmÆ_öãºu±
;

248 
asmlökage
 
	$smp_thîmÆ_öãºu±
(
±_ªgs
 *
ªgs
)

250 
	`exô_idÀ
();

251 
	`úq_íãr
();

252 
	`öc_úq_°©
(
úq_thîmÆ_cou¡
);

253 
	`smp_thîmÆ_ve˘‹
();

254 
	`úq_exô
();

256 
	`ack_APIC_úq
();

257 
	}
}

260 
	$öãl_thîmÆ_suµ‹ãd
(
˝uöfo_x86
 *
c
)

262 i‡(!
˝u_has_≠ic
)

264 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
Ë|| !˝u_has(c, 
X86_FEATURE_ACC
))

267 
	}
}

269 
__öô
 
	$mcheck_öãl_thîm_öô
()

276 i‡(
	`öãl_thîmÆ_suµ‹ãd
(&
boŸ_˝u_d©a
))

277 
lvâhmr_öô
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

278 
	}
}

280 
	$öãl_öô_thîmÆ
(
˝uöfo_x86
 *
c
)

282 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
tm2
 = 0;

284 
u32
 
l
, 
h
;

286 i‡(!
	`öãl_thîmÆ_suµ‹ãd
(
c
))

294 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

305 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
lvâhmr_öô
);

307 
h
 = 
lvâhmr_öô
;

309 i‡((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
Ë&& (
h
 & 
APIC_DM_SMI
)) {

310 
	`¥ötk
(
KERN_DEBUG


311 "CPU%d: ThîmÆ m⁄ô‹ög h™dÀd by SMI\n", 
˝u
);

316 i‡(
h
 & 
APIC_VECTOR_MASK
) {

317 
	`¥ötk
(
KERN_DEBUG


319 
˝u
, (
h
 & 
APIC_VECTOR_MASK
));

324 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TM2
)) {

325 i‡(
c
->
x86
 =6 && (c->
x86_modñ
 == 9 || c->x86_model == 13)) {

326 
	`rdm§
(
MSR_THERM2_CTL
, 
l
, 
h
);

327 i‡(
l
 & 
MSR_THERM2_CTL_TM_SELECT
)

328 
tm2
 = 1;

329 } i‡(
l
 & 
MSR_IA32_MISC_ENABLE_TM2
)

330 
tm2
 = 1;

334 
h
 = 
THERMAL_APIC_VECTOR
 | 
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
;

335 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
h
);

337 
	`rdm§
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

338 
	`wrm§
(
MSR_IA32_THERM_INTERRUPT
,

339 
l
 | (
THERM_INT_LOW_ENABLE
 | 
THERM_INT_HIGH_ENABLE
), 
h
);

341 
smp_thîmÆ_ve˘‹
 = 
öãl_thîmÆ_öãºu±
;

343 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

344 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

347 
l
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

348 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

350 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Thermal monitoringÉnabled (%s)\n",

351 
tm2
 ? "TM2" : "TM1");

354 
	`©omic_£t
(&
thîm_thrŸ_í
, 1);

355 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<löux/öãºu±.h
>

5 
	~<löux/kî√l.h
>

7 
	~<asm/úq_ve˘‹s.h
>

8 
	~<asm/≠ic.h
>

9 
	~<asm/idÀ.h
>

10 
	~<asm/m˚.h
>

12 
	$deÁu…_thªshﬁd_öãºu±
()

14 
	`¥ötk
(
KERN_ERR
 "UnexpectedÅhreshold interruptát vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
m˚_thªshﬁd_ve˘‹
)(Ë
deÁu…_thªshﬁd_öãºu±
;

20 
asmlökage
 
	$smp_thªshﬁd_öãºu±
()

22 
	`exô_idÀ
();

23 
	`úq_íãr
();

24 
	`öc_úq_°©
(
úq_thªshﬁd_cou¡
);

25 
	`m˚_thªshﬁd_ve˘‹
();

26 
	`úq_exô
();

28 
	`ack_APIC_úq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/˝u.h
>

25 
	~<löux/muãx.h
>

26 
	~<löux/uac˚ss.h
>

27 
	~<löux/kvm_∑ø.h
>

28 
	~<löux/ønge.h
>

30 
	~<asm/¥o˚ss‹.h
>

31 
	~<asm/e820.h
>

32 
	~<asm/mår.h
>

33 
	~<asm/m§.h
>

35 
	~"mår.h
"

37 
	sv¨_mår_ønge_°©e
 {

38 
	mba£_p‚
;

39 
	msize_p‚
;

40 
mår_ty≥
 
	mty≥
;

43 
	sv¨_mår_°©e
 {

44 
	mønge_°¨tk
;

45 
	mønge_sizek
;

46 
	mchunk_sizek
;

47 
	mgøn_sizek
;

48 
	mªg
;

52 
	#RANGE_NUM
 256

	)

54 
ønge
 
__öôd©a
 
	gønge
[
RANGE_NUM
];

55 
__öôd©a
 
	gƒ_ønge
;

57 
v¨_mår_ønge_°©e
 
__öôd©a
 
	gønge_°©e
[
RANGE_NUM
];

59 
__öôd©a
 
	gdebug_¥öt
;

60 
	#D¥ötk
(
x
...Ëdÿ{ i‡(
debug_¥öt
Ë
	`¥ötk
(
KERN_DEBUG
 x); } 0)

	)

62 
	#BIOS_BUG_MSG
 
KERN_WARNING
 \

63 "WARNING: BIOS bug: VAR MTRR %d c⁄èö†°øngêUCÉ¡ry undî 1M, check wôh you∏sy°em víd‹!\n"

	)

65 
__öô


66 
	$x86_gë_mår_mem_ønge
(
ønge
 *ønge, 
ƒ_ønge
,

67 
exåa_ªmove_ba£
,

68 
exåa_ªmove_size
)

70 
ba£
, 
size
;

71 
mår_ty≥
 
ty≥
;

72 
i
;

74 
i
 = 0; i < 
num_v¨_ønges
; i++) {

75 
ty≥
 = 
ønge_°©e
[
i
].type;

76 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

78 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

79 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

80 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
, 
RANGE_NUM
,Çr_range,

81 
ba£
, ba£ + 
size
);

83 i‡(
debug_¥öt
) {

84 
	`¥ötk
(
KERN_DEBUG
 "After WB checking\n");

85 
i
 = 0; i < 
ƒ_ønge
; i++)

86 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

87 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

91 
i
 = 0; i < 
num_v¨_ønges
; i++) {

92 
ty≥
 = 
ønge_°©e
[
i
].type;

93 i‡(
ty≥
 !
MTRR_TYPE_UNCACHABLE
 &&

94 
ty≥
 !
MTRR_TYPE_WRPROT
)

96 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

97 i‡(!
size
)

99 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

100 i‡(
ba£
 < (1<<(20-
PAGE_SHIFT
)Ë&& 
mår_°©e
.
have_fixed
 &&

101 (
mår_°©e
.
íabÀd
 & 1)) {

103 
	`¥ötk
(
BIOS_BUG_MSG
, 
i
);

104 i‡(
ba£
 + 
size
 <(1<<(20-
PAGE_SHIFT
)))

106 
size
 -(1<<(20-
PAGE_SHIFT
)Ë- 
ba£
;

107 
ba£
 = 1<<(20-
PAGE_SHIFT
);

109 
	`subåa˘_ønge
(
ønge
, 
RANGE_NUM
, 
ba£
, ba£ + 
size
);

111 i‡(
exåa_ªmove_size
)

112 
	`subåa˘_ønge
(
ønge
, 
RANGE_NUM
, 
exåa_ªmove_ba£
,

113 
exåa_ªmove_ba£
 + 
exåa_ªmove_size
);

115 i‡(
debug_¥öt
) {

116 
	`¥ötk
(
KERN_DEBUG
 "After UC checking\n");

117 
i
 = 0; i < 
RANGE_NUM
; i++) {

118 i‡(!
ønge
[
i
].
íd
)

120 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

121 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

126 
ƒ_ønge
 = 
	`˛ón_s‹t_ønge
(
ønge
, 
RANGE_NUM
);

127 i‡(
debug_¥öt
) {

128 
	`¥ötk
(
KERN_DEBUG
 "After sorting\n");

129 
i
 = 0; i < 
ƒ_ønge
; i++)

130 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

131 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

134  
ƒ_ønge
;

135 
	}
}

137 #ifde‡
CONFIG_MTRR_SANITIZER


139 
__öô
 
	$sum_ønges
(
ønge
 *ønge, 
ƒ_ønge
)

141 
sum
 = 0;

142 
i
;

144 
i
 = 0; i < 
ƒ_ønge
; i++)

145 
sum
 +
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
;

147  
sum
;

148 
	}
}

150 
íabÀ_mår_˛ónup
 
	g__öôd©a
 =

151 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

153 
__öô
 
	$dißbÀ_mår_˛ónup_£tup
(*
°r
)

155 
íabÀ_mår_˛ónup
 = 0;

157 
	}
}

158 
óæy_∑øm
("dißbÀ_mår_˛ónup", 
dißbÀ_mår_˛ónup_£tup
);

160 
__öô
 
	$íabÀ_mår_˛ónup_£tup
(*
°r
)

162 
íabÀ_mår_˛ónup
 = 1;

164 
	}
}

165 
óæy_∑øm
("íabÀ_mår_˛ónup", 
íabÀ_mår_˛ónup_£tup
);

167 
__öô
 
	$mår_˛ónup_debug_£tup
(*
°r
)

169 
debug_¥öt
 = 1;

171 
	}
}

172 
óæy_∑øm
("mår_˛ónup_debug", 
mår_˛ónup_debug_£tup
);

174 
__öô


175 
	$£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

176 
ty≥
, 
addªss_bôs
)

178 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

179 
u64
 
ba£
, 
mask
;

181 i‡(!
sizek
) {

182 
	`fûl_mår_v¨_ønge
(
ªg
, 0, 0, 0, 0);

186 
mask
 = (1ULL << 
addªss_bôs
) - 1;

187 
mask
 &~((((
u64
)
sizek
) << 10) - 1);

189 
ba£
 = ((
u64
)
ba£k
) << 10;

191 
ba£
 |
ty≥
;

192 
mask
 |= 0x800;

194 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

195 
ba£_hi
 = 
ba£
 >> 32;

197 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

198 
mask_hi
 = 
mask
 >> 32;

200 
	`fûl_mår_v¨_ønge
(
ªg
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

201 
	}
}

203 
__öô


204 
	$ßve_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

205 
ty≥
)

207 
ønge_°©e
[
ªg
].
ba£_p‚
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

208 
ønge_°©e
[
ªg
].
size_p‚
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

209 
ønge_°©e
[
ªg
].
ty≥
 =Åype;

210 
	}
}

212 
__öô
 
	$£t_v¨_mår_Æl
(
addªss_bôs
)

214 
ba£k
, 
sizek
;

215 
ty≥
;

216 
ªg
;

218 
ªg
 = 0;Ñeg < 
num_v¨_ønges
;Ñeg++) {

219 
ba£k
 = 
ønge_°©e
[
ªg
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

220 
sizek
 = 
ønge_°©e
[
ªg
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

221 
ty≥
 = 
ønge_°©e
[
ªg
].type;

223 
	`£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
, 
ty≥
, 
addªss_bôs
);

225 
	}
}

227 
	$to_size_Á˘‹
(
sizek
, *
Á˘‹p
)

229 
ba£
 = 
sizek
;

230 
Á˘‹
;

232 i‡(
ba£
 & ((1<<10) - 1)) {

234 
Á˘‹
 = 'K';

235 } i‡(
ba£
 & ((1<<20) - 1)) {

236 
Á˘‹
 = 'M';

237 
ba£
 >>= 10;

239 
Á˘‹
 = 'G';

240 
ba£
 >>= 20;

243 *
Á˘‹p
 = 
Á˘‹
;

245  
ba£
;

246 
	}
}

248 
__öô


249 
	$ønge_to_mår
(
ªg
, 
ønge_°¨tk
,

250 
ønge_sizek
, 
ty≥
)

252 i‡(!
ønge_sizek
 || (
ªg
 >
num_v¨_ønges
))

253  
ªg
;

255 
ønge_sizek
) {

256 
max_Æign
, 
Æign
;

257 
sizek
;

260 i‡(
ønge_°¨tk
)

261 
max_Æign
 = 
	`ffs
(
ønge_°¨tk
) - 1;

263 
max_Æign
 = 32;

265 
Æign
 = 
	`Ês
(
ønge_sizek
) - 1;

266 i‡(
Æign
 > 
max_Æign
)

267 
Æign
 = 
max_Æign
;

269 
sizek
 = 1 << 
Æign
;

270 i‡(
debug_¥öt
) {

271 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

272 
°¨t_ba£
, 
size_ba£
;

274 
°¨t_ba£
 = 
	`to_size_Á˘‹
(
ønge_°¨tk
, &
°¨t_Á˘‹
);

275 
size_ba£
 = 
	`to_size_Á˘‹
(
sizek
, &
size_Á˘‹
);

277 
	`D¥ötk
("Setting variable MTRR %d, "

279 
ªg
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

280 
size_ba£
, 
size_Á˘‹
,

281 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

282 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

285 
	`ßve_v¨_mår
(
ªg
++, 
ønge_°¨tk
, 
sizek
, 
ty≥
);

286 
ønge_°¨tk
 +
sizek
;

287 
ønge_sizek
 -
sizek
;

288 i‡(
ªg
 >
num_v¨_ønges
)

291  
ªg
;

292 
	}
}

294 
__öô


295 
	$ønge_to_mår_wôh_hﬁe
(
v¨_mår_°©e
 *
°©e
, 
ba£k
,

296 
sizek
)

298 
hﬁe_ba£k
, 
hﬁe_sizek
;

299 
£c⁄d_ba£k
, 
£c⁄d_sizek
;

300 
ønge0_ba£k
, 
ønge0_sizek
;

301 
ønge_ba£k
, 
ønge_sizek
;

302 
chunk_sizek
;

303 
gøn_sizek
;

305 
hﬁe_ba£k
 = 0;

306 
hﬁe_sizek
 = 0;

307 
£c⁄d_ba£k
 = 0;

308 
£c⁄d_sizek
 = 0;

309 
chunk_sizek
 = 
°©e
->chunk_sizek;

310 
gøn_sizek
 = 
°©e
->gran_sizek;

313 
ønge_ba£k
 = 
	`ALIGN
(
°©e
->
ønge_°¨tk
, 
gøn_sizek
);

314 i‡((
ønge_ba£k
 > 
ba£k
) && basek)

315  
£c⁄d_sizek
;

317 
°©e
->
ønge_sizek
 -(
ønge_ba£k
 - sèã->
ønge_°¨tk
);

318 
ønge_sizek
 = 
	`ALIGN
(
°©e
->ønge_sizek, 
gøn_sizek
);

320 
ønge_sizek
 > 
°©e
->range_sizek) {

321 
ønge_sizek
 -
gøn_sizek
;

322 i‡(!
ønge_sizek
)

325 
°©e
->
ønge_sizek
 =Ñange_sizek;

328 
ønge0_ba£k
 = 
°©e
->
ønge_°¨tk
;

329 
ønge0_sizek
 = 
	`ALIGN
(
°©e
->
ønge_sizek
, 
chunk_sizek
);

332 i‡(
ønge0_sizek
 =
°©e
->
ønge_sizek
) {

333 
	`D¥ötk
("rangeX: %016lx - %016lx\n",

334 
ønge0_ba£k
<<10,

335 (
ønge0_ba£k
 + 
°©e
->
ønge_sizek
)<<10);

336 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

337 
°©e
->
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

342 i‡(
sizek
) {

343 
ønge0_ba£k
 + 
ønge0_sizek
 > (
ba£k
 + 
sizek
)) {

344 i‡(
ønge0_sizek
 >
chunk_sizek
)

345 
ønge0_sizek
 -
chunk_sizek
;

347 
ønge0_sizek
 = 0;

349 i‡(!
ønge0_sizek
)

354 
£c⁄d_åy
:

355 
ønge_ba£k
 = 
ønge0_ba£k
 + 
ønge0_sizek
;

358 i‡(
ønge_ba£k
 > 
ba£k
 &&Ñ™ge_ba£k <(ba£k + 
sizek
))

359 
£c⁄d_sizek
 = 
ønge_ba£k
 - 
ba£k
;

361 i‡(
ønge0_sizek
 > 
°©e
->
ønge_sizek
) {

364 
hﬁe_sizek
 = 
ønge0_sizek
 - 
°©e
->
ønge_sizek
 - 
£c⁄d_sizek
;

367 i‡(
hﬁe_sizek
 >(
ønge0_sizek
 >> 1) &&

368 
ønge0_sizek
 >
chunk_sizek
) {

369 
ønge0_sizek
 -
chunk_sizek
;

370 
£c⁄d_sizek
 = 0;

371 
hﬁe_sizek
 = 0;

373 
£c⁄d_åy
;

377 i‡(
ønge0_sizek
) {

378 
	`D¥ötk
("range0: %016lx - %016lx\n",

379 
ønge0_ba£k
<<10,

380 (
ønge0_ba£k
 + 
ønge0_sizek
)<<10);

381 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

382 
ønge0_sizek
, 
MTRR_TYPE_WRBACK
);

385 i‡(
ønge0_sizek
 < 
°©e
->
ønge_sizek
) {

387 
ønge_sizek
 = 
°©e
->ønge_sizek - 
ønge0_sizek
;

389 
	`D¥ötk
("range: %016lx - %016lx\n",

390 
ønge_ba£k
<<10,

391 (
ønge_ba£k
 + 
ønge_sizek
)<<10);

393 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge_ba£k
,

394 
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

397 i‡(
hﬁe_sizek
) {

398 
hﬁe_ba£k
 = 
ønge_ba£k
 - 
hﬁe_sizek
 - 
£c⁄d_sizek
;

399 
	`D¥ötk
("hole: %016lx - %016lx\n",

400 
hﬁe_ba£k
<<10,

401 (
hﬁe_ba£k
 + 
hﬁe_sizek
)<<10);

402 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
hﬁe_ba£k
,

403 
hﬁe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

406  
£c⁄d_sizek
;

407 
	}
}

409 
__öô


410 
	$£t_v¨_mår_ønge
(
v¨_mår_°©e
 *
°©e
, 
ba£_p‚
,

411 
size_p‚
)

413 
ba£k
, 
sizek
;

414 
£c⁄d_sizek
 = 0;

416 i‡(
°©e
->
ªg
 >
num_v¨_ønges
)

419 
ba£k
 = 
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

420 
sizek
 = 
size_p‚
 << (
PAGE_SHIFT
 - 10);

423 i‡((
ba£k
 <= 1024) ||

424 (
°©e
->
ønge_°¨tk
 + sèã->
ønge_sizek
 =
ba£k
)) {

425 
ídk
 = 
ba£k
 + 
sizek
;

426 
°©e
->
ønge_sizek
 = 
ídk
 - sèã->
ønge_°¨tk
;

430 i‡(
°©e
->
ønge_sizek
 != 0)

431 
£c⁄d_sizek
 = 
	`ønge_to_mår_wôh_hﬁe
(
°©e
, 
ba£k
, 
sizek
);

434 
°©e
->
ønge_°¨tk
 = 
ba£k
 + 
£c⁄d_sizek
;

435 
°©e
->
ønge_sizek
 = 
sizek
 - 
£c⁄d_sizek
;

436 
	}
}

439 
u64
 
mår_chunk_size
 
	g__öôd©a
 = (256ULL<<20);

441 
__öô
 
	$∑r£_mår_chunk_size_›t
(*
p
)

443 i‡(!
p
)

444  -
EINVAL
;

445 
mår_chunk_size
 = 
	`mem∑r£
(
p
, &p);

447 
	}
}

448 
óæy_∑øm
("mår_chunk_size", 
∑r£_mår_chunk_size_›t
);

451 
u64
 
mår_gøn_size
 
	g__öôd©a
;

453 
__öô
 
	$∑r£_mår_gøn_size_›t
(*
p
)

455 i‡(!
p
)

456  -
EINVAL
;

457 
mår_gøn_size
 = 
	`mem∑r£
(
p
, &p);

459 
	}
}

460 
óæy_∑øm
("mår_gøn_size", 
∑r£_mår_gøn_size_›t
);

462 
ƒ_mår_•¨e_ªg
 
	g__öôd©a
 =

463 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

465 
__öô
 
	$∑r£_mår_•¨e_ªg
(*
¨g
)

467 i‡(
¨g
)

468 
ƒ_mår_•¨e_ªg
 = 
	`sim∂e_°πoul
(
¨g
, 
NULL
, 0);

470 
	}
}

471 
óæy_∑øm
("mår_•¨e_ªg_ƒ", 
∑r£_mår_•¨e_ªg
);

473 
__öô


474 
	$x86_£tup_v¨_mårs
(
ønge
 *ønge, 
ƒ_ønge
,

475 
u64
 
chunk_size
, u64 
gøn_size
)

477 
v¨_mår_°©e
 
v¨_°©e
;

478 
num_ªg
;

479 
i
;

481 
v¨_°©e
.
ønge_°¨tk
 = 0;

482 
v¨_°©e
.
ønge_sizek
 = 0;

483 
v¨_°©e
.
ªg
 = 0;

484 
v¨_°©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

485 
v¨_°©e
.
gøn_sizek
 = 
gøn_size
 >> 10;

487 
	`mem£t
(
ønge_°©e
, 0, (range_state));

490 
i
 = 0; i < 
ƒ_ønge
; i++) {

491 
	`£t_v¨_mår_ønge
(&
v¨_°©e
, 
ønge
[
i
].
°¨t
,

492 
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
);

496 i‡(
v¨_°©e
.
ønge_sizek
 != 0)

497 
	`ønge_to_mår_wôh_hﬁe
(&
v¨_°©e
, 0, 0);

499 
num_ªg
 = 
v¨_°©e
.
ªg
;

501 
v¨_°©e
.
ªg
 < 
num_v¨_ønges
) {

502 
	`ßve_v¨_mår
(
v¨_°©e
.
ªg
, 0, 0, 0);

503 
v¨_°©e
.
ªg
++;

506  
num_ªg
;

507 
	}
}

509 
	smår_˛ónup_ªsu…
 {

510 
	mgøn_sizek
;

511 
	mchunk_sizek
;

512 
	mlo£_covî_sizek
;

513 
	mnum_ªg
;

514 
	mbad
;

522 
	#NUM_RESULT
 136

	)

523 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

525 
mår_˛ónup_ªsu…
 
__öôd©a
 
	gªsu…
[
NUM_RESULT
];

526 
__öôd©a
 
	gmö_loss_p‚
[
RANGE_NUM
];

528 
__öô
 
	$¥öt_out_mår_ønge_°©e
()

530 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

531 
°¨t_ba£
, 
size_ba£
;

532 
mår_ty≥
 
ty≥
;

533 
i
;

535 
i
 = 0; i < 
num_v¨_ønges
; i++) {

537 
size_ba£
 = 
ønge_°©e
[
i
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

538 i‡(!
size_ba£
)

541 
size_ba£
 = 
	`to_size_Á˘‹
(size_ba£, &
size_Á˘‹
),

542 
°¨t_ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

543 
°¨t_ba£
 = 
	`to_size_Á˘‹
(°¨t_ba£, &
°¨t_Á˘‹
),

544 
ty≥
 = 
ønge_°©e
[
i
].type;

546 
	`¥ötk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,Ñange: %ld%cB,Åype %s\n",

547 
i
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

548 
size_ba£
, 
size_Á˘‹
,

549 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

550 ((
ty≥
 =
MTRR_TYPE_WRPROT
) ? "WP" :

551 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

554 
	}
}

556 
__öô
 
	$mår_√ed_˛ónup
()

558 
i
;

559 
mår_ty≥
 
ty≥
;

560 
size
;

562 
num
[
MTRR_NUM_TYPES
 + 1];

565 
	`mem£t
(
num
, 0, (num));

566 
i
 = 0; i < 
num_v¨_ønges
; i++) {

567 
ty≥
 = 
ønge_°©e
[
i
].type;

568 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

569 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

571 i‡(!
size
)

572 
ty≥
 = 
MTRR_NUM_TYPES
;

573 
num
[
ty≥
]++;

577 i‡(!
num
[
MTRR_TYPE_UNCACHABLE
])

581 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

582 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

586 
	}
}

588 
__öôd©a
 
	gønge_sums
;

590 
__öô


591 
	$mår_ˇlc_ønge_°©e
(
u64
 
chunk_size
, u64 
gøn_size
,

592 
x_ªmove_ba£
,

593 
x_ªmove_size
, 
i
)

595 
ønge
 
ønge_√w
[
RANGE_NUM
];

596 
ønge_sums_√w
;

597 
ƒ_ønge_√w
;

598 
num_ªg
;

601 
num_ªg
 = 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

604 
	`mem£t
(
ønge_√w
, 0, (range_new));

605 
ƒ_ønge_√w
 = 
	`x86_gë_mår_mem_ønge
(
ønge_√w
, 0,

606 
x_ªmove_ba£
, 
x_ªmove_size
);

607 
ønge_sums_√w
 = 
	`sum_ønges
(
ønge_√w
, 
ƒ_ønge_√w
);

609 
ªsu…
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

610 
ªsu…
[
i
].
gøn_sizek
 = 
gøn_size
 >> 10;

611 
ªsu…
[
i
].
num_ªg
 =Çum_reg;

613 i‡(
ønge_sums
 < 
ønge_sums_√w
) {

614 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums_√w
 - 
ønge_sums
Ë<< 
PSHIFT
;

615 
ªsu…
[
i
].
bad
 = 1;

617 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums
 - 
ønge_sums_√w
Ë<< 
PSHIFT
;

621 i‡(!
ªsu…
[
i
].
bad
 && !ªsu…[i].
lo£_covî_sizek
) {

622 i‡(
ƒ_ønge_√w
 !
ƒ_ønge
 || 
	`memcmp
(
ønge
, 
ønge_√w
, (range)))

623 
ªsu…
[
i
].
bad
 = 1;

626 i‡(!
ªsu…
[
i
].
bad
 && (
ønge_sums
 - 
ønge_sums_√w
 < 
mö_loss_p‚
[
num_ªg
]))

627 
mö_loss_p‚
[
num_ªg
] = 
ønge_sums
 - 
ønge_sums_√w
;

628 
	}
}

630 
__öô
 
	$mår_¥öt_out_⁄e_ªsu…
(
i
)

632 
gøn_ba£
, 
chunk_ba£
, 
lo£_ba£
;

633 
gøn_Á˘‹
, 
chunk_Á˘‹
, 
lo£_Á˘‹
;

635 
gøn_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
gøn_sizek
, &
gøn_Á˘‹
),

636 
chunk_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
chunk_sizek
, &
chunk_Á˘‹
),

637 
lo£_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
lo£_covî_sizek
, &
lo£_Á˘‹
),

639 
	`¥_öfo
("%sgran_size: %ld%c \tchunk_size: %ld%c \t",

640 
ªsu…
[
i
].
bad
 ? "*BAD*" : " ",

641 
gøn_ba£
, 
gøn_Á˘‹
, 
chunk_ba£
, 
chunk_Á˘‹
);

642 
	`¥_c⁄t
("num_reg: %d \tlose cover RAM: %s%ld%c\n",

643 
ªsu…
[
i
].
num_ªg
,Ñesu…[i].
bad
 ? "-" : "",

644 
lo£_ba£
, 
lo£_Á˘‹
);

645 
	}
}

647 
__öô
 
	$mår_£¨ch_›timÆ_ödex
()

649 
num_ªg_good
;

650 
ödex_good
;

651 
i
;

653 i‡(
ƒ_mår_•¨e_ªg
 >
num_v¨_ønges
)

654 
ƒ_mår_•¨e_ªg
 = 
num_v¨_ønges
 - 1;

656 
num_ªg_good
 = -1;

657 
i
 = 
num_v¨_ønges
 - 
ƒ_mår_•¨e_ªg
; i > 0; i--) {

658 i‡(!
mö_loss_p‚
[
i
])

659 
num_ªg_good
 = 
i
;

662 
ödex_good
 = -1;

663 i‡(
num_ªg_good
 != -1) {

664 
i
 = 0; i < 
NUM_RESULT
; i++) {

665 i‡(!
ªsu…
[
i
].
bad
 &&

666 
ªsu…
[
i
].
num_ªg
 =
num_ªg_good
 &&

667 !
ªsu…
[
i
].
lo£_covî_sizek
) {

668 
ödex_good
 = 
i
;

674  
ödex_good
;

675 
	}
}

677 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

679 
x_ªmove_ba£
, 
x_ªmove_size
;

680 
ba£
, 
size
, 
def
, 
dummy
;

681 
u64
 
chunk_size
, 
gøn_size
;

682 
mår_ty≥
 
ty≥
;

683 
ödex_good
;

684 
i
;

686 i‡(!
	`is_˝u
(
INTEL
Ë|| 
íabÀ_mår_˛ónup
 < 1)

689 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

690 
def
 &= 0xff;

691 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

695 
	`mem£t
(
ønge_°©e
, 0, (range_state));

696 
i
 = 0; i < 
num_v¨_ønges
; i++) {

697 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

698 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

699 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

700 
ønge_°©e
[
i
].
ty≥
 =Åype;

704 i‡(!
	`mår_√ed_˛ónup
())

708 
	`¥ötk
(
KERN_DEBUG
 "original variable MTRRs\n");

709 
	`¥öt_out_mår_ønge_°©e
();

711 
	`mem£t
(
ønge
, 0, (range));

712 
x_ªmove_size
 = 0;

713 
x_ªmove_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

714 i‡(
mår_tom2
)

715 
x_ªmove_size
 = (
mår_tom2
 >> 
PAGE_SHIFT
Ë- 
x_ªmove_ba£
;

717 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
, 0, 
x_ªmove_ba£
, 
x_ªmove_size
);

722 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
, 
RANGE_NUM
,Çr_range, 0,

723 1ULL<<(20 - 
PAGE_SHIFT
));

725 
	`s‹t_ønge
(
ønge
, 
ƒ_ønge
);

727 
ønge_sums
 = 
	`sum_ønges
(
ønge
, 
ƒ_ønge
);

728 
	`¥ötk
(
KERN_INFO
 "total RAM covered: %ldM\n",

729 
ønge_sums
 >> (20 - 
PAGE_SHIFT
));

731 i‡(
mår_chunk_size
 && 
mår_gøn_size
) {

732 
i
 = 0;

733 
	`mår_ˇlc_ønge_°©e
(
mår_chunk_size
, 
mår_gøn_size
,

734 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

736 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

738 i‡(!
ªsu…
[
i
].
bad
) {

739 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

740 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

741 
	`¥öt_out_mår_ønge_°©e
();

744 
	`¥ötk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

748 
i
 = 0;

749 
	`mem£t
(
mö_loss_p‚
, 0xff, (min_loss_pfn));

750 
	`mem£t
(
ªsu…
, 0, (result));

751 
gøn_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

753 
chunk_size
 = 
gøn_size
; chunk_size < (1ULL<<32);

754 
chunk_size
 <<= 1) {

756 i‡(
i
 >
NUM_RESULT
)

759 
	`mår_ˇlc_ønge_°©e
(
chunk_size
, 
gøn_size
,

760 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

761 i‡(
debug_¥öt
) {

762 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

763 
	`¥ötk
(
KERN_INFO
 "\n");

766 
i
++;

771 
ödex_good
 = 
	`mår_£¨ch_›timÆ_ödex
();

773 i‡(
ödex_good
 != -1) {

774 
	`¥ötk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

775 
i
 = 
ödex_good
;

776 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

779 
chunk_size
 = 
ªsu…
[
i
].
chunk_sizek
;

780 
chunk_size
 <<= 10;

781 
gøn_size
 = 
ªsu…
[
i
].
gøn_sizek
;

782 
gøn_size
 <<= 10;

783 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

784 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

785 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

786 
	`¥öt_out_mår_ønge_°©e
();

790 
i
 = 0; i < 
NUM_RESULT
; i++)

791 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

794 
	`¥ötk
(
KERN_INFO
 "mtrr_cleanup: canÇot find optimal value\n");

795 
	`¥ötk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

798 
	}
}

800 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

803 
	}
}

806 
	gdißbÀ_mår_åim
;

808 
__öô
 
	$dißbÀ_mår_åim_£tup
(*
°r
)

810 
dißbÀ_mår_åim
 = 1;

812 
	}
}

813 
óæy_∑øm
("dißbÀ_mår_åim", 
dißbÀ_mår_åim_£tup
);

821 
	#Tom2E«bÀd
 (1U << 21)

	)

822 
	#Tom2F‹˚MemTy≥WB
 (1U << 22)

	)

824 
__öô
 
	$amd_•ecül_deÁu…_mår
()

826 
u32
 
l
, 
h
;

828 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_AMD
)

830 i‡(
boŸ_˝u_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

833 i‡(
	`rdm§_ß„
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

839 i‡((
l
 & (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
)) ==

840 (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
))

843 
	}
}

845 
u64
 
__öô


846 
	$ªÆ_åim_mem‹y
(
°¨t_p‚
, 
limô_p‚
)

848 
u64
 
åim_°¨t
, 
åim_size
;

850 
åim_°¨t
 = 
°¨t_p‚
;

851 
åim_°¨t
 <<
PAGE_SHIFT
;

853 
åim_size
 = 
limô_p‚
;

854 
åim_size
 <<
PAGE_SHIFT
;

855 
åim_size
 -
åim_°¨t
;

857  
	`e820_upd©e_ønge
(
åim_°¨t
, 
åim_size
, 
E820_RAM
, 
E820_RESERVED
);

858 
	}
}

871 
__öô
 
	$mår_åim_unˇched_mem‹y
(
íd_p‚
)

873 
i
, 
ba£
, 
size
, 
highe°_p‚
 = 0, 
def
, 
dummy
;

874 
mår_ty≥
 
ty≥
;

875 
u64
 
tŸÆ_åim_size
;

877 
num
[
MTRR_NUM_TYPES
 + 1];

883 i‡(!
	`is_˝u
(
INTEL
Ë|| 
dißbÀ_mår_åim
)

886 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

887 
def
 &= 0xff;

888 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

892 
	`mem£t
(
ønge_°©e
, 0, (range_state));

893 
i
 = 0; i < 
num_v¨_ønges
; i++) {

894 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

895 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

896 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

897 
ønge_°©e
[
i
].
ty≥
 =Åype;

901 
i
 = 0; i < 
num_v¨_ønges
; i++) {

902 
ty≥
 = 
ønge_°©e
[
i
].type;

903 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

905 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

906 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

907 i‡(
highe°_p‚
 < 
ba£
 + 
size
)

908 
highe°_p‚
 = 
ba£
 + 
size
;

912 i‡(!
highe°_p‚
) {

913 
	`¥ötk
(
KERN_INFO
 "CPU MTRRsáll blank - virtualized system.\n");

918 
	`mem£t
(
num
, 0, (num));

919 
i
 = 0; i < 
num_v¨_ønges
; i++) {

920 
ty≥
 = 
ønge_°©e
[
i
].type;

921 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

923 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

924 i‡(!
size
)

925 
ty≥
 = 
MTRR_NUM_TYPES
;

926 
num
[
ty≥
]++;

930 i‡(!
num
[
MTRR_TYPE_WRBACK
])

934 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

935 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

938 
	`mem£t
(
ønge
, 0, (range));

939 
ƒ_ønge
 = 0;

940 i‡(
mår_tom2
) {

941 
ønge
[
ƒ_ønge
].
°¨t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

942 
ønge
[
ƒ_ønge
].
íd
 = 
mår_tom2
 >> 
PAGE_SHIFT
;

943 i‡(
highe°_p‚
 < 
ønge
[
ƒ_ønge
].
íd
)

944 
highe°_p‚
 = 
ønge
[
ƒ_ønge
].
íd
;

945 
ƒ_ønge
++;

947 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
,Çr_range, 0, 0);

950 
tŸÆ_åim_size
 = 0;

951 i‡(
ønge
[0].
°¨t
)

952 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(0, 
ønge
[0].
°¨t
);

955 
i
 = 0; i < 
ƒ_ønge
 - 1; i++) {

956 i‡(
ønge
[
i
].
íd
 <Ñ™ge[i+1].
°¨t
)

957 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
,

958 
ønge
[
i
+1].
°¨t
);

962 
i
 = 
ƒ_ønge
 - 1;

963 i‡(
ønge
[
i
].
íd
 < 
íd_p‚
)

964 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
,

965 
íd_p‚
);

967 i‡(
tŸÆ_åim_size
) {

968 
	`¥_w¨nög
("WARNING: BIOS bug: CPU MTRR†d⁄'àcovîáŒ o‡mem‹y,Üosög %ŒuMB o‡RAM.\n", 
tŸÆ_åim_size
 >> 20);

970 i‡(!
ch™ged_by_mår_˛ónup
)

971 
	`WARN_ON
(1);

973 
	`¥_öfo
("updateÉ820 for mtrr\n");

974 
	`upd©e_e820
();

980 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

5 
	#DEBUG


	)

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/io.h
>

10 
	~<löux/mm.h
>

12 
	~<asm/¥o˚ss‹-Êags.h
>

13 
	~<asm/˝u„©uª.h
>

14 
	~<asm/ébÊush.h
>

15 
	~<asm/sy°em.h
>

16 
	~<asm/mår.h
>

17 
	~<asm/m§.h
>

18 
	~<asm/∑t.h
>

20 
	~"mår.h
"

22 
	sfixed_ønge_block
 {

23 
	mba£_m§
;

24 
	mønges
;

27 
fixed_ønge_block
 
	gfixed_ønge_blocks
[] = {

28 { 
MSR_MTRRfix64K_00000
, 1 },

29 { 
MSR_MTRRfix16K_80000
, 2 },

30 { 
MSR_MTRRfix4K_C0000
, 8 },

34 
	gsmp_ch™ges_mask
;

35 
	gmår_°©e_£t
;

36 
u64
 
	gmår_tom2
;

38 
mår_°©e_ty≥
 
	gmår_°©e
;

39 
EXPORT_SYMBOL_GPL
(
mår_°©e
);

49 
ölöe
 
	$k8_check_syscfg_døm_mod_í
()

51 
u32
 
lo
, 
hi
;

53 i‡(!((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) &&

54 (
boŸ_˝u_d©a
.
x86
 >= 0x0f)))

57 
	`rdm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

58 i‡(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

59 
	`¥ötk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

61 
	`smp_¥o˚ss‹_id
());

62 
lo
 &~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

63 
	`mår_wrm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

65 
	}
}

73 
u8
 
	$mår_ty≥_lookup
(
u64
 
°¨t
, u64 
íd
)

75 
i
;

76 
u64
 
ba£
, 
mask
;

77 
u8
 
¥ev_m©ch
, 
cuº_m©ch
;

79 i‡(!
mår_°©e_£t
)

82 i‡(!
mår_°©e
.
íabÀd
)

86 
íd
--;

89 i‡(
mår_°©e
.
have_fixed
 && (
°¨t
 < 0x100000)) {

90 
idx
;

92 i‡(
°¨t
 < 0x80000) {

93 
idx
 = 0;

94 
idx
 +(
°¨t
 >> 16);

95  
mår_°©e
.
fixed_ønges
[
idx
];

96 } i‡(
°¨t
 < 0xC0000) {

97 
idx
 = 1 * 8;

98 
idx
 +((
°¨t
 - 0x80000) >> 14);

99  
mår_°©e
.
fixed_ønges
[
idx
];

100 } i‡(
°¨t
 < 0x1000000) {

101 
idx
 = 3 * 8;

102 
idx
 +((
°¨t
 - 0xC0000) >> 12);

103  
mår_°©e
.
fixed_ønges
[
idx
];

112 i‡(!(
mår_°©e
.
íabÀd
 & 2))

113  
mår_°©e
.
def_ty≥
;

115 
¥ev_m©ch
 = 0xFF;

116 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

117 
°¨t_°©e
, 
íd_°©e
;

119 i‡(!(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11)))

122 
ba£
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
) << 32) +

123 (
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

124 
mask
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
) << 32) +

125 (
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & 
PAGE_MASK
);

127 
°¨t_°©e
 = ((
°¨t
 & 
mask
Ë=(
ba£
 & mask));

128 
íd_°©e
 = ((
íd
 & 
mask
Ë=(
ba£
 & mask));

129 i‡(
°¨t_°©e
 !
íd_°©e
)

132 i‡((
°¨t
 & 
mask
Ë!(
ba£
 & mask))

135 
cuº_m©ch
 = 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff;

136 i‡(
¥ev_m©ch
 == 0xFF) {

137 
¥ev_m©ch
 = 
cuº_m©ch
;

141 i‡(
¥ev_m©ch
 =
MTRR_TYPE_UNCACHABLE
 ||

142 
cuº_m©ch
 =
MTRR_TYPE_UNCACHABLE
) {

143  
MTRR_TYPE_UNCACHABLE
;

146 i‡((
¥ev_m©ch
 =
MTRR_TYPE_WRBACK
 &&

147 
cuº_m©ch
 =
MTRR_TYPE_WRTHROUGH
) ||

148 (
¥ev_m©ch
 =
MTRR_TYPE_WRTHROUGH
 &&

149 
cuº_m©ch
 =
MTRR_TYPE_WRBACK
)) {

150 
¥ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

151 
cuº_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

154 i‡(
¥ev_m©ch
 !
cuº_m©ch
)

155  
MTRR_TYPE_UNCACHABLE
;

158 i‡(
mår_tom2
) {

159 i‡(
°¨t
 >(1ULL<<32Ë&& (
íd
 < 
mår_tom2
))

160  
MTRR_TYPE_WRBACK
;

163 i‡(
¥ev_m©ch
 != 0xFF)

164  
¥ev_m©ch
;

166  
mår_°©e
.
def_ty≥
;

167 
	}
}

171 
	$gë_mår_v¨_ønge
(
ödex
, 
mår_v¨_ønge
 *
vr
)

173 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

174 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

175 
	}
}

178 
	$fûl_mår_v¨_ønge
(
ödex
,

179 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

181 
mår_v¨_ønge
 *
vr
;

183 
vr
 = 
mår_°©e
.
v¨_ønges
;

185 
vr
[
ödex
].
ba£_lo
 = base_lo;

186 
vr
[
ödex
].
ba£_hi
 = base_hi;

187 
vr
[
ödex
].
mask_lo
 = mask_lo;

188 
vr
[
ödex
].
mask_hi
 = mask_hi;

189 
	}
}

191 
	$gë_fixed_ønges
(
mår_ty≥
 *
‰s
)

193 *
p
 = (*)
‰s
;

194 
i
;

196 
	`k8_check_syscfg_døm_mod_í
();

198 
	`rdm§
(
MSR_MTRRfix64K_00000
, 
p
[0],Ö[1]);

200 
i
 = 0; i < 2; i++)

201 
	`rdm§
(
MSR_MTRRfix16K_80000
 + 
i
, 
p
[2 + i * 2],Ö[3 + i * 2]);

202 
i
 = 0; i < 8; i++)

203 
	`rdm§
(
MSR_MTRRfix4K_C0000
 + 
i
, 
p
[6 + i * 2],Ö[7 + i * 2]);

204 
	}
}

206 
	$mår_ßve_fixed_ønges
(*
öfo
)

208 i‡(
˝u_has_mår
)

209 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

210 
	}
}

212 
__öôd©a
 
	gœ°_fixed_°¨t
;

213 
__öôd©a
 
	gœ°_fixed_íd
;

214 
mår_ty≥
 
__öôd©a
 
	gœ°_fixed_ty≥
;

216 
__öô
 
	$¥öt_fixed_œ°
()

218 i‡(!
œ°_fixed_íd
)

221 
	`¥_debug
(" %05X-%05X %s\n", 
œ°_fixed_°¨t
,

222 
œ°_fixed_íd
 - 1, 
	`mår_©åib_to_°r
(
œ°_fixed_ty≥
));

224 
œ°_fixed_íd
 = 0;

225 
	}
}

227 
__öô
 
	$upd©e_fixed_œ°
(
ba£
, 
íd
,

228 
mår_ty≥
 
ty≥
)

230 
œ°_fixed_°¨t
 = 
ba£
;

231 
œ°_fixed_íd
 = 
íd
;

232 
œ°_fixed_ty≥
 = 
ty≥
;

233 
	}
}

235 
__öô


236 
	$¥öt_fixed
(
ba£
, 
°ï
, c⁄° 
mår_ty≥
 *
ty≥s
)

238 
i
;

240 
i
 = 0; i < 8; ++i, ++
ty≥s
, 
ba£
 +
°ï
) {

241 i‡(
œ°_fixed_íd
 == 0) {

242 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

245 i‡(
œ°_fixed_íd
 =
ba£
 && 
œ°_fixed_ty≥
 =*
ty≥s
) {

246 
œ°_fixed_íd
 = 
ba£
 + 
°ï
;

250 
	`¥öt_fixed_œ°
();

251 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

253 
	}
}

255 
¥ï¨e_£t
();

256 
po°_£t
();

258 
__öô
 
	$¥öt_mår_°©e
()

260 
i
;

261 
high_width
;

263 
	`¥_debug
("MTRR defaultÅype: %s\n",

264 
	`mår_©åib_to_°r
(
mår_°©e
.
def_ty≥
));

265 i‡(
mår_°©e
.
have_fixed
) {

266 
	`¥_debug
("MTRR fixedÑanges %sabled:\n",

267 
mår_°©e
.
íabÀd
 & 1 ? "en" : "dis");

268 
	`¥öt_fixed
(0x00000, 0x10000, 
mår_°©e
.
fixed_ønges
 + 0);

269 
i
 = 0; i < 2; ++i)

270 
	`¥öt_fixed
(0x80000 + 
i
 * 0x20000, 0x04000,

271 
mår_°©e
.
fixed_ønges
 + (
i
 + 1) * 8);

272 
i
 = 0; i < 8; ++i)

273 
	`¥öt_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000,

274 
mår_°©e
.
fixed_ønges
 + (
i
 + 3) * 8);

277 
	`¥öt_fixed_œ°
();

279 
	`¥_debug
("MTRR variableÑanges %sabled:\n",

280 
mår_°©e
.
íabÀd
 & 2 ? "en" : "dis");

281 i‡(
size_‹_mask
 & 0xffffffffUL)

282 
high_width
 = 
	`ffs
(
size_‹_mask
 & 0xffffffffUL) - 1;

284 
high_width
 = 
	`ffs
(
size_‹_mask
>>32) + 32 - 1;

285 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

287 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

288 i‡(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11))

289 
	`¥_debug
(" %u base %0*X%05X000 mask %0*X%05X000 %s\n",

290 
i
,

291 
high_width
,

292 
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
,

293 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 >> 12,

294 
high_width
,

295 
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
,

296 
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 >> 12,

297 
	`mår_©åib_to_°r
(
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff));

299 
	`¥_debug
(" %u dißbÀd\n", 
i
);

301 i‡(
mår_tom2
)

302 
	`¥_debug
("TOM2: %016Œxák®%ŒdM\n", 
mår_tom2
, mtrr_tom2>>20);

303 
	}
}

306 
__öô
 
	$gë_mår_°©e
()

308 
mår_v¨_ønge
 *
vrs
;

309 
Êags
;

310 
lo
, 
dummy
;

311 
i
;

313 
vrs
 = 
mår_°©e
.
v¨_ønges
;

315 
	`rdm§
(
MSR_MTRRˇp
, 
lo
, 
dummy
);

316 
mår_°©e
.
have_fixed
 = (
lo
 >> 8) & 1;

318 
i
 = 0; i < 
num_v¨_ønges
; i++)

319 
	`gë_mår_v¨_ønge
(
i
, &
vrs
[i]);

320 i‡(
mår_°©e
.
have_fixed
)

321 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

323 
	`rdm§
(
MSR_MTRRdefTy≥
, 
lo
, 
dummy
);

324 
mår_°©e
.
def_ty≥
 = (
lo
 & 0xff);

325 
mår_°©e
.
íabÀd
 = (
lo
 & 0xc00) >> 10;

327 i‡(
	`amd_•ecül_deÁu…_mår
()) {

328 
low
, 
high
;

331 
	`rdm§
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

332 
mår_tom2
 = 
high
;

333 
mår_tom2
 <<= 32;

334 
mår_tom2
 |
low
;

335 
mår_tom2
 &= 0xffffff800000ULL;

338 
	`¥öt_mår_°©e
();

340 
mår_°©e_£t
 = 1;

343 
	`loˇl_úq_ßve
(
Êags
);

344 
	`¥ï¨e_£t
();

346 
	`∑t_öô
();

348 
	`po°_£t
();

349 
	`loˇl_úq_ª°‹e
(
Êags
);

350 
	}
}

353 
__öô
 
	$mår_°©e_w¨n
()

355 
mask
 = 
smp_ch™ges_mask
;

357 i‡(!
mask
)

359 i‡(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

360 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent fixed MTRR settings\n");

361 i‡(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

362 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent variable MTRR settings\n");

363 i‡(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

364 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent MTRRdefType settings\n");

366 
	`¥ötk
(
KERN_INFO
 "mtrr:Örobably your BIOS doesÇot setupáll CPUs.\n");

367 
	`¥ötk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

368 
	}
}

375 
	$mår_wrm§
(
m§
, 
a
, 
b
)

377 i‡(
	`wrm§_ß„
(
m§
, 
a
, 
b
) < 0) {

378 
	`¥ötk
(
KERN_ERR


380 
	`smp_¥o˚ss‹_id
(), 
m§
, 
a
, 
b
);

382 
	}
}

391 
	$£t_fixed_ønge
(
m§
, 
boﬁ
 *
ch™ged
, *
m§w‹ds
)

393 
lo
, 
hi
;

395 
	`rdm§
(
m§
, 
lo
, 
hi
);

397 i‡(
lo
 !
m§w‹ds
[0] || 
hi
 != msrwords[1]) {

398 
	`mår_wrm§
(
m§
, 
m§w‹ds
[0], msrwords[1]);

399 *
ch™ged
 = 
åue
;

401 
	}
}

412 
	$gíîic_gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚_ªg
)

414 
lba£
, 
lsize
;

415 
mår_ty≥
 
…y≥
;

416 
i
, 
max
;

418 
max
 = 
num_v¨_ønges
;

419 i‡(
ª∂a˚_ªg
 >0 &&Ñïœ˚_ªg < 
max
)

420  
ª∂a˚_ªg
;

422 
i
 = 0; i < 
max
; ++i) {

423 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

424 i‡(
lsize
 == 0)

425  
i
;

428  -
ENOSPC
;

429 
	}
}

431 
	$gíîic_gë_mår
(
ªg
, *
ba£
,

432 *
size
, 
mår_ty≥
 *
ty≥
)

434 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

435 
tmp
, 
hi
;

436 
˝u
;

442 
˝u
 = 
	`gë_˝u
();

444 
	`rdm§
(
	`MTRRphysMask_MSR
(
ªg
), 
mask_lo
, 
mask_hi
);

446 i‡((
mask_lo
 & 0x800) == 0) {

448 *
ba£
 = 0;

449 *
size
 = 0;

450 *
ty≥
 = 0;

451 
out_put_˝u
;

454 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
ba£_lo
, 
ba£_hi
);

457 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
Ë| 
mask_lo
 >> PAGE_SHIFT;

458 
mask_lo
 = 
size_‹_mask
 | 
tmp
;

461 
hi
 = 
	`Ês
(
tmp
);

462 i‡(
hi
 > 0) {

463 
tmp
 |~((1<<(
hi
 - 1)) - 1);

465 i‡(
tmp
 !
mask_lo
) {

466 
	`¥ötk
(
KERN_WARNING
 "mtrr: your BIOS has configuredán incorrect mask, fixing it.\n");

467 
mask_lo
 = 
tmp
;

475 *
size
 = -
mask_lo
;

476 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
Ë| 
ba£_lo
 >> PAGE_SHIFT;

477 *
ty≥
 = 
ba£_lo
 & 0xff;

479 
out_put_˝u
:

480 
	`put_˝u
();

481 
	}
}

488 
	$£t_fixed_ønges
(
mår_ty≥
 *
‰s
)

490 *
ßved
 = (*)
‰s
;

491 
boﬁ
 
ch™ged
 = 
Ál£
;

492 
block
 = -1, 
ønge
;

494 
	`k8_check_syscfg_døm_mod_í
();

496 
fixed_ønge_blocks
[++
block
].
ønges
) {

497 
ønge
 = 0;Ñ™gê< 
fixed_ønge_blocks
[
block
].
ønges
;Ñange++)

498 
	`£t_fixed_ønge
(
fixed_ønge_blocks
[
block
].
ba£_m§
 + 
ønge
,

499 &
ch™ged
, (*)
ßved
++);

502  
ch™ged
;

503 
	}
}

509 
boﬁ
 
	$£t_mår_v¨_ønges
(
ödex
, 
mår_v¨_ønge
 *
vr
)

511 
lo
, 
hi
;

512 
boﬁ
 
ch™ged
 = 
Ál£
;

514 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
lo
, 
hi
);

515 i‡((
vr
->
ba£_lo
 & 0xfffff0ffULË!(
lo
 & 0xfffff0ffUL)

516 || (
vr
->
ba£_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

517 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

519 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

520 
ch™ged
 = 
åue
;

523 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
lo
, 
hi
);

525 i‡((
vr
->
mask_lo
 & 0xfffff800ULË!(
lo
 & 0xfffff800UL)

526 || (
vr
->
mask_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

527 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

528 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

529 
ch™ged
 = 
åue
;

531  
ch™ged
;

532 
	}
}

534 
u32
 
	gde·y≥_lo
, 
	gde·y≥_hi
;

542 
	$£t_mår_°©e
()

544 
ch™ge_mask
 = 0;

545 
i
;

547 
i
 = 0; i < 
num_v¨_ønges
; i++) {

548 i‡(
	`£t_mår_v¨_ønges
(
i
, &
mår_°©e
.
v¨_ønges
[i]))

549 
ch™ge_mask
 |
MTRR_CHANGE_MASK_VARIABLE
;

552 i‡(
mår_°©e
.
have_fixed
 && 
	`£t_fixed_ønges
(mår_°©e.
fixed_ønges
))

553 
ch™ge_mask
 |
MTRR_CHANGE_MASK_FIXED
;

559 i‡((
de·y≥_lo
 & 0xffË!
mår_°©e
.
def_ty≥


560 || ((
de·y≥_lo
 & 0xc00Ë>> 10Ë!
mår_°©e
.
íabÀd
) {

562 
de·y≥_lo
 = (de·y≥_lÿ& ~0xcffË| 
mår_°©e
.
def_ty≥
 |

563 (
mår_°©e
.
íabÀd
 << 10);

564 
ch™ge_mask
 |
MTRR_CHANGE_MASK_DEFTYPE
;

567  
ch™ge_mask
;

568 
	}
}

571 
	g¸4
;

572 
DEFINE_RAW_SPINLOCK
(
£t_©omicôy_lock
);

581 
	$¥ï¨e_£t
(Ë
	$__acquúes
(
£t_©omicôy_lock
)

583 
¸0
;

592 
	`øw_•ö_lock
(&
£t_©omicôy_lock
);

595 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

596 
	`wrôe_¸0
(
¸0
);

597 
	`wbövd
();

600 i‡(
˝u_has_pge
) {

601 
¸4
 = 
	`ªad_¸4
();

602 
	`wrôe_¸4
(
¸4
 & ~
X86_CR4_PGE
);

606 
	`__Êush_éb
();

609 
	`rdm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

612 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
 & ~0xcff, 
de·y≥_hi
);

613 
	}
}

615 
	$po°_£t
(Ë
	$__ªÀa£s
(
£t_©omicôy_lock
)

618 
	`__Êush_éb
();

621 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

624 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

627 i‡(
˝u_has_pge
)

628 
	`wrôe_¸4
(
¸4
);

629 
	`øw_•ö_u∆ock
(&
£t_©omicôy_lock
);

630 
	}
}

632 
	$gíîic_£t_Æl
()

634 
mask
, 
cou¡
;

635 
Êags
;

637 
	`loˇl_úq_ßve
(
Êags
);

638 
	`¥ï¨e_£t
();

641 
mask
 = 
	`£t_mår_°©e
();

644 
	`∑t_öô
();

646 
	`po°_£t
();

647 
	`loˇl_úq_ª°‹e
(
Êags
);

650 
cou¡
 = 0; cou¡ <  
mask
 * 8; ++count) {

651 i‡(
mask
 & 0x01)

652 
	`£t_bô
(
cou¡
, &
smp_ch™ges_mask
);

653 
mask
 >>= 1;

656 
	}
}

668 
	$gíîic_£t_mår
(
ªg
, 
ba£
,

669 
size
, 
mår_ty≥
 
ty≥
)

671 
Êags
;

672 
mår_v¨_ønge
 *
vr
;

674 
vr
 = &
mår_°©e
.
v¨_ønges
[
ªg
];

676 
	`loˇl_úq_ßve
(
Êags
);

677 
	`¥ï¨e_£t
();

679 i‡(
size
 == 0) {

684 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 0, 0);

685 
	`mem£t
(
vr
, 0, (
mår_v¨_ønge
));

687 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty≥
;

688 
vr
->
ba£_hi
 = (
ba£
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

689 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

690 
vr
->
mask_hi
 = (-
size
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

692 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

693 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 
vr
->
mask_lo
, vr->
mask_hi
);

696 
	`po°_£t
();

697 
	`loˇl_úq_ª°‹e
(
Êags
);

698 
	}
}

700 
	$gíîic_vÆid©e_add_∑ge
(
ba£
, 
size
,

701 
ty≥
)

703 
lba£
, 
œ°
;

709 i‡(
	`is_˝u
(
INTEL
Ë&& 
boŸ_˝u_d©a
.
x86
 == 6 &&

710 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

711 
boŸ_˝u_d©a
.
x86_mask
 <= 7) {

712 i‡(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

713 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸ 4 MiBálig√d\n", 
ba£
);

714  -
EINVAL
;

716 i‡(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

717 (
ty≥
 =
MTRR_TYPE_WRCOMB


718 || 
ty≥
 =
MTRR_TYPE_WRBACK
)) {

719 
	`¥_w¨nög
("mtrr: writable mtrr between 0x70000000ánd 0x7003FFFF may hangÅhe CPU.\n");

720  -
EINVAL
;

728 
œ°
 = 
ba£
 + 
size
 - 1;

729 
lba£
 = 
ba£
; !÷ba£ & 1Ë&& (
œ°
 & 1);

730 
lba£
 =Üba£ >> 1, 
œ°
 =Üast >> 1)

732 i‡(
lba£
 !
œ°
) {

733 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸálig√d o¿®size(0x%lx000Ëbound¨y\n", 
ba£
, 
size
);

734  -
EINVAL
;

737 
	}
}

739 
	$gíîic_have_wrcomb
()

741 
c⁄fig
, 
dummy
;

742 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

743  
c⁄fig
 & (1 << 10);

744 
	}
}

746 
	$posôive_have_wrcomb
()

749 
	}
}

754 c⁄° 
mår_›s
 
	ggíîic_mår_›s
 = {

755 .
u£_öãl_if
 = 1,

756 .
	g£t_Æl
 = 
gíîic_£t_Æl
,

757 .
	ggë
 = 
gíîic_gë_mår
,

758 .
	ggë_‰ì_ªgi⁄
 = 
gíîic_gë_‰ì_ªgi⁄
,

759 .
	g£t
 = 
gíîic_£t_mår
,

760 .
	gvÆid©e_add_∑ge
 = 
gíîic_vÆid©e_add_∑ge
,

761 .
	ghave_wrcomb
 = 
gíîic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<löux/ˇ∑bûôy.h
>

2 
	~<löux/£q_fûe.h
>

3 
	~<löux/uac˚ss.h
>

4 
	~<löux/¥oc_fs.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/˘y≥.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/öô.h
>

11 
	#LINE_SIZE
 80

	)

13 
	~<asm/mår.h
>

15 
	~"mår.h
"

17 
	#FILE_FCOUNT
(
f
Ë(((
£q_fûe
 *)((f)->
¥iv©e_d©a
))->
¥iv©e
)

	)

19 c⁄° *c⁄° 
	gmår_°rögs
[
MTRR_NUM_TYPES
] =

30 c⁄° *
	$mår_©åib_to_°r
(
x
)

32  (
x
 <6Ë? 
mår_°rögs
[x] : "?";

33 
	}
}

35 #ifde‡
CONFIG_PROC_FS


38 
	$mår_fûe_add
(
ba£
, 
size
,

39 
ty≥
, 
boﬁ
 
ö¸emít
, 
fûe
 *fûe, 
∑ge
)

41 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

42 
ªg
, 
max
;

44 
max
 = 
num_v¨_ønges
;

45 i‡(
fcou¡
 =
NULL
) {

46 
fcou¡
 = 
	`kzÆloc
(
max
 *  *fcou¡, 
GFP_KERNEL
);

47 i‡(!
fcou¡
)

48  -
ENOMEM
;

49 
	`FILE_FCOUNT
(
fûe
Ë
fcou¡
;

51 i‡(!
∑ge
) {

52 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

53  -
EINVAL
;

54 
ba£
 >>
PAGE_SHIFT
;

55 
size
 >>
PAGE_SHIFT
;

57 
ªg
 = 
	`mår_add_∑ge
(
ba£
, 
size
, 
ty≥
, 
åue
);

58 i‡(
ªg
 >= 0)

59 ++
fcou¡
[
ªg
];

60  
ªg
;

61 
	}
}

64 
	$mår_fûe_dñ
(
ba£
, 
size
,

65 
fûe
 *fûe, 
∑ge
)

67 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

68 
ªg
;

70 i‡(!
∑ge
) {

71 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

72  -
EINVAL
;

73 
ba£
 >>
PAGE_SHIFT
;

74 
size
 >>
PAGE_SHIFT
;

76 
ªg
 = 
	`mår_dñ_∑ge
(-1, 
ba£
, 
size
);

77 i‡(
ªg
 < 0)

78  
ªg
;

79 i‡(
fcou¡
 =
NULL
)

80  
ªg
;

81 i‡(
fcou¡
[
ªg
] < 1)

82  -
EINVAL
;

83 --
fcou¡
[
ªg
];

84  
ªg
;

85 
	}
}

93 
ssize_t


94 
	$mår_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 * 
µos
)

96 
i
, 
îr
;

97 
ªg
;

98 
ba£
, 
size
;

99 *
±r
;

100 
löe
[
LINE_SIZE
];

101 
Àngth
;

102 
size_t
 
löñí
;

104 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

105  -
EPERM
;

107 
	`mem£t
(
löe
, 0, 
LINE_SIZE
);

109 
Àngth
 = 
Àn
;

110 
Àngth
--;

112 i‡(
Àngth
 > 
LINE_SIZE
 - 1)

113 
Àngth
 = 
LINE_SIZE
 - 1;

115 i‡(
Àngth
 < 0)

116  -
EINVAL
;

118 i‡(
	`c›y_‰om_u£r
(
löe
, 
buf
, 
Àngth
))

119  -
EFAULT
;

121 
löñí
 = 
	`°æí
(
löe
);

122 
±r
 = 
löe
 + 
löñí
 - 1;

123 i‡(
löñí
 && *
±r
 == '\n')

124 *
±r
 = '\0';

126 i‡(!
	`°∫cmp
(
löe
, "disable=", 8)) {

127 
ªg
 = 
	`sim∂e_°πoul
(
löe
 + 8, &
±r
, 0);

128 
îr
 = 
	`mår_dñ_∑ge
(
ªg
, 0, 0);

129 i‡(
îr
 < 0)

130  
îr
;

131  
Àn
;

134 i‡(
	`°∫cmp
(
löe
, "base=", 5))

135  -
EINVAL
;

137 
ba£
 = 
	`sim∂e_°πouŒ
(
löe
 + 5, &
±r
, 0);

138 
±r
 = 
	`skù_•a˚s
(ptr);

140 i‡(
	`°∫cmp
(
±r
, "size=", 5))

141  -
EINVAL
;

143 
size
 = 
	`sim∂e_°πouŒ
(
±r
 + 5, &ptr, 0);

144 i‡((
ba£
 & 0xfffË|| (
size
 & 0xfff))

145  -
EINVAL
;

146 
±r
 = 
	`skù_•a˚s
(ptr);

148 i‡(
	`°∫cmp
(
±r
, "type=", 5))

149  -
EINVAL
;

150 
±r
 = 
	`skù_•a˚s
(ptr + 5);

152 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

153 i‡(
	`°rcmp
(
±r
, 
mår_°rögs
[
i
]))

155 
ba£
 >>
PAGE_SHIFT
;

156 
size
 >>
PAGE_SHIFT
;

157 
îr
 = 
	`mår_add_∑ge
(()
ba£
, ()
size
, 
i
, 
åue
);

158 i‡(
îr
 < 0)

159  
îr
;

160  
Àn
;

162  -
EINVAL
;

163 
	}
}

166 
	$mår_io˘l
(
fûe
 *fûe, 
cmd
, 
__¨g
)

168 
îr
 = 0;

169 
mår_ty≥
 
ty≥
;

170 
size
;

171 
mår_£¡ry
 
£¡ry
;

172 
mår_gíåy
 
gíåy
;

173 
__u£r
 *
¨g
 = (__u£∏*Ë
__¨g
;

175 
cmd
) {

176 
MTRRIOC_ADD_ENTRY
:

177 
MTRRIOC_SET_ENTRY
:

178 
MTRRIOC_DEL_ENTRY
:

179 
MTRRIOC_KILL_ENTRY
:

180 
MTRRIOC_ADD_PAGE_ENTRY
:

181 
MTRRIOC_SET_PAGE_ENTRY
:

182 
MTRRIOC_DEL_PAGE_ENTRY
:

183 
MTRRIOC_KILL_PAGE_ENTRY
:

184 i‡(
	`c›y_‰om_u£r
(&
£¡ry
, 
¨g
,  sentry))

185  -
EFAULT
;

187 
MTRRIOC_GET_ENTRY
:

188 
MTRRIOC_GET_PAGE_ENTRY
:

189 i‡(
	`c›y_‰om_u£r
(&
gíåy
, 
¨g
,  gentry))

190  -
EFAULT
;

192 #ifde‡
CONFIG_COMPAT


193 
MTRRIOC32_ADD_ENTRY
:

194 
MTRRIOC32_SET_ENTRY
:

195 
MTRRIOC32_DEL_ENTRY
:

196 
MTRRIOC32_KILL_ENTRY
:

197 
MTRRIOC32_ADD_PAGE_ENTRY
:

198 
MTRRIOC32_SET_PAGE_ENTRY
:

199 
MTRRIOC32_DEL_PAGE_ENTRY
:

200 
MTRRIOC32_KILL_PAGE_ENTRY
: {

201 
mår_£¡ry32
 
__u£r
 *
s32
;

203 
s32
 = (
mår_£¡ry32
 
__u£r
 *)
__¨g
;

204 
îr
 = 
	`gë_u£r
(
£¡ry
.
ba£
, &
s32
->base);

205 
îr
 |
	`gë_u£r
(
£¡ry
.
size
, &
s32
->size);

206 
îr
 |
	`gë_u£r
(
£¡ry
.
ty≥
, &
s32
->type);

207 i‡(
îr
)

208  
îr
;

211 
MTRRIOC32_GET_ENTRY
:

212 
MTRRIOC32_GET_PAGE_ENTRY
: {

213 
mår_gíåy32
 
__u£r
 *
g32
;

215 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

216 
îr
 = 
	`gë_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

217 
îr
 |
	`gë_u£r
(
gíåy
.
ba£
, &
g32
->base);

218 
îr
 |
	`gë_u£r
(
gíåy
.
size
, &
g32
->size);

219 
îr
 |
	`gë_u£r
(
gíåy
.
ty≥
, &
g32
->type);

220 i‡(
îr
)

221  
îr
;

227 
cmd
) {

229  -
ENOTTY
;

230 
MTRRIOC_ADD_ENTRY
:

231 #ifde‡
CONFIG_COMPAT


232 
MTRRIOC32_ADD_ENTRY
:

234 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

235  -
EPERM
;

236 
îr
 =

237 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

238 
fûe
, 0);

240 
MTRRIOC_SET_ENTRY
:

241 #ifde‡
CONFIG_COMPAT


242 
MTRRIOC32_SET_ENTRY
:

244 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

245  -
EPERM
;

246 
îr
 = 
	`mår_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

248 
MTRRIOC_DEL_ENTRY
:

249 #ifde‡
CONFIG_COMPAT


250 
MTRRIOC32_DEL_ENTRY
:

252 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

253  -
EPERM
;

254 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 0);

256 
MTRRIOC_KILL_ENTRY
:

257 #ifde‡
CONFIG_COMPAT


258 
MTRRIOC32_KILL_ENTRY
:

260 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

261  -
EPERM
;

262 
îr
 = 
	`mår_dñ
(-1, 
£¡ry
.
ba£
, síåy.
size
);

264 
MTRRIOC_GET_ENTRY
:

265 #ifde‡
CONFIG_COMPAT


266 
MTRRIOC32_GET_ENTRY
:

268 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

269  -
EINVAL
;

270 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

273 i‡(
gíåy
.
ba£
 + 
size
 - 1 >(1UL << (8 * (gíåy.sizeË- 
PAGE_SHIFT
))

274 || 
size
 >(1UL << (8 * (
gíåy
.sizeË- 
PAGE_SHIFT
)))

275 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

277 
gíåy
.
ba£
 <<
PAGE_SHIFT
;

278 
gíåy
.
size
 = sizê<< 
PAGE_SHIFT
;

279 
gíåy
.
ty≥
 =Åype;

283 
MTRRIOC_ADD_PAGE_ENTRY
:

284 #ifde‡
CONFIG_COMPAT


285 
MTRRIOC32_ADD_PAGE_ENTRY
:

287 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

288  -
EPERM
;

289 
îr
 =

290 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

291 
fûe
, 1);

293 
MTRRIOC_SET_PAGE_ENTRY
:

294 #ifde‡
CONFIG_COMPAT


295 
MTRRIOC32_SET_PAGE_ENTRY
:

297 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

298  -
EPERM
;

299 
îr
 =

300 
	`mår_add_∑ge
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

302 
MTRRIOC_DEL_PAGE_ENTRY
:

303 #ifde‡
CONFIG_COMPAT


304 
MTRRIOC32_DEL_PAGE_ENTRY
:

306 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

307  -
EPERM
;

308 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 1);

310 
MTRRIOC_KILL_PAGE_ENTRY
:

311 #ifde‡
CONFIG_COMPAT


312 
MTRRIOC32_KILL_PAGE_ENTRY
:

314 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

315  -
EPERM
;

316 
îr
 = 
	`mår_dñ_∑ge
(-1, 
£¡ry
.
ba£
, síåy.
size
);

318 
MTRRIOC_GET_PAGE_ENTRY
:

319 #ifde‡
CONFIG_COMPAT


320 
MTRRIOC32_GET_PAGE_ENTRY
:

322 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

323  -
EINVAL
;

324 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

326 i‡(
size
 !(
	`__ty≥of__
(
gíåy
.size))size)

327 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

329 
gíåy
.
size
 = size;

330 
gíåy
.
ty≥
 =Åype;

335 i‡(
îr
)

336  
îr
;

338 
cmd
) {

339 
MTRRIOC_GET_ENTRY
:

340 
MTRRIOC_GET_PAGE_ENTRY
:

341 i‡(
	`c›y_to_u£r
(
¨g
, &
gíåy
,  gentry))

342 
îr
 = -
EFAULT
;

344 #ifde‡
CONFIG_COMPAT


345 
MTRRIOC32_GET_ENTRY
:

346 
MTRRIOC32_GET_PAGE_ENTRY
: {

347 
mår_gíåy32
 
__u£r
 *
g32
;

349 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

350 
îr
 = 
	`put_u£r
(
gíåy
.
ba£
, &
g32
->base);

351 
îr
 |
	`put_u£r
(
gíåy
.
size
, &
g32
->size);

352 
îr
 |
	`put_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

353 
îr
 |
	`put_u£r
(
gíåy
.
ty≥
, &
g32
->type);

358  
îr
;

359 
	}
}

361 
	$mår_˛o£
(
öode
 *
öo
, 
fûe
 *file)

363 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

364 
i
, 
max
;

366 i‡(
fcou¡
 !
NULL
) {

367 
max
 = 
num_v¨_ønges
;

368 
i
 = 0; i < 
max
; ++i) {

369 
fcou¡
[
i
] > 0) {

370 
	`mår_dñ
(
i
, 0, 0);

371 --
fcou¡
[
i
];

374 
	`k‰ì
(
fcou¡
);

375 
	`FILE_FCOUNT
(
fûe
Ë
NULL
;

377  
	`sögÀ_ªÀa£
(
öo
, 
fûe
);

378 
	}
}

380 
mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
);

382 
	$mår_›í
(
öode
 *öode, 
fûe
 *file)

384 i‡(!
mår_if
)

385  -
EIO
;

386 i‡(!
mår_if
->
gë
)

387  -
ENXIO
;

388  
	`sögÀ_›í
(
fûe
, 
mår_£q_show
, 
NULL
);

389 
	}
}

391 c⁄° 
fûe_›î©i⁄s
 
	gmår_f›s
 = {

392 .
ow√r
 = 
THIS_MODULE
,

393 .
	g›í
 = 
mår_›í
,

394 .
	gªad
 = 
£q_ªad
,

395 .
	gŒ£ek
 = 
£q_l£ek
,

396 .
	gwrôe
 = 
mår_wrôe
,

397 .
	gu∆ocked_io˘l
 = 
mår_io˘l
,

398 .
	gcom∑t_io˘l
 = 
mår_io˘l
,

399 .
	gªÀa£
 = 
mår_˛o£
,

402 
	$mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
)

404 
Á˘‹
;

405 
i
, 
max
, 
Àn
;

406 
mår_ty≥
 
ty≥
;

407 
ba£
, 
size
;

409 
Àn
 = 0;

410 
max
 = 
num_v¨_ønges
;

411 
i
 = 0; i < 
max
; i++) {

412 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

413 i‡(
size
 == 0) {

414 
mår_ußge_èbÀ
[
i
] = 0;

417 i‡(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

419 
Á˘‹
 = 'K';

420 
size
 <<
PAGE_SHIFT
 - 10;

422 
Á˘‹
 = 'M';

423 
size
 >>20 - 
PAGE_SHIFT
;

426 
Àn
 +
	`£q_¥ötf
(
£q
, "reg%02i: base=0x%06lx000 "

428 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
,

429 
Á˘‹
, 
mår_ußge_èbÀ
[
i
],

430 
	`mår_©åib_to_°r
(
ty≥
));

433 
	}
}

435 
__öô
 
	$mår_if_öô
()

437 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

439 i‡((!
	`˝u_has
(
c
, 
X86_FEATURE_MTRR
)) &&

440 (!
	`˝u_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

441 (!
	`˝u_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

442 (!
	`˝u_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

443  -
ENODEV
;

445 
	`¥oc_¸óã
("mår", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mår_f›s
);

447 
	}
}

448 
¨ch_öôˇŒ
(
mår_if_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	#DEBUG


	)

36 
	~<löux/ty≥s.h
>

38 
	~<löux/kvm_∑ø.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/moduÀ.h
>

41 
	~<löux/muãx.h
>

42 
	~<löux/öô.h
>

43 
	~<löux/s‹t.h
>

44 
	~<löux/˝u.h
>

45 
	~<löux/pci.h
>

46 
	~<löux/smp.h
>

48 
	~<asm/¥o˚ss‹.h
>

49 
	~<asm/e820.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/m§.h
>

53 
	~"mår.h
"

55 
u32
 
	gnum_v¨_ønges
;

57 
	gmår_ußge_èbÀ
[
MTRR_MAX_VAR_RANGES
];

58 
DEFINE_MUTEX
(
mår_muãx
);

60 
u64
 
	gsize_‹_mask
, 
	gsize_™d_mask
;

61 
boﬁ
 
	gmår_≠s_dñayed_öô
;

63 c⁄° 
mår_›s
 *
	gmår_›s
[
X86_VENDOR_NUM
];

65 c⁄° 
mår_›s
 *
	gmår_if
;

67 
£t_mår
(
ªg
, 
ba£
,

68 
size
, 
mår_ty≥
 
ty≥
);

70 
	$£t_mår_›s
(c⁄° 
mår_›s
 *
›s
)

72 i‡(
›s
->
víd‹
 && ops->víd‹ < 
X86_VENDOR_NUM
)

73 
mår_›s
[
›s
->
víd‹
] = ops;

74 
	}
}

77 
	$have_wrcomb
()

79 
pci_dev
 *
dev
;

80 
u8
 
ªv
;

82 
dev
 = 
	`pci_gë_˛ass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
);

83 i‡(
dev
 !
NULL
) {

89 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_SERVERWORKS
 &&

90 
dev
->
devi˚
 =
PCI_DEVICE_ID_SERVERWORKS_LE
) {

91 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

92 i‡(
ªv
 <= 5) {

93 
	`¥_öfo
("mtrr: Serverworks LEÑev < 6 detected. Write-combining disabled.\n");

94 
	`pci_dev_put
(
dev
);

102 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_INTEL
 &&

103 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTEL_82451NX
) {

104 
	`¥_öfo
("mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

105 
	`pci_dev_put
(
dev
);

108 
	`pci_dev_put
(
dev
);

110  
mår_if
->
have_wrcomb
 ? mår_if->
	`have_wrcomb
() : 0;

111 
	}
}

114 
__öô
 
	$£t_num_v¨_ønges
()

116 
c⁄fig
 = 0, 
dummy
;

118 i‡(
	`u£_öãl
())

119 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

120 i‡(
	`is_˝u
(
AMD
))

121 
c⁄fig
 = 2;

122 i‡(
	`is_˝u
(
CYRIX
Ë|| is_˝u(
CENTAUR
))

123 
c⁄fig
 = 8;

125 
num_v¨_ønges
 = 
c⁄fig
 & 0xff;

126 
	}
}

128 
__öô
 
	$öô_èbÀ
()

130 
i
, 
max
;

132 
max
 = 
num_v¨_ønges
;

133 
i
 = 0; i < 
max
; i++)

134 
mår_ußge_èbÀ
[
i
] = 1;

135 
	}
}

137 
	s£t_mår_d©a
 {

138 
©omic_t
 
	mcou¡
;

139 
©omic_t
 
	mg©e
;

140 
	msmp_ba£
;

141 
	msmp_size
;

142 
	msmp_ªg
;

143 
mår_ty≥
 
	msmp_ty≥
;

152 
	$ùi_h™dÀr
(*
öfo
)

154 #ifde‡
CONFIG_SMP


155 
£t_mår_d©a
 *
d©a
 = 
öfo
;

156 
Êags
;

158 
	`loˇl_úq_ßve
(
Êags
);

160 
	`©omic_dec
(&
d©a
->
cou¡
);

161 !
	`©omic_ªad
(&
d©a
->
g©e
))

162 
	`˝u_ªœx
();

165 i‡(
d©a
->
smp_ªg
 != ~0U) {

166 
mår_if
->
	`£t
(
d©a
->
smp_ªg
, d©a->
smp_ba£
,

167 
d©a
->
smp_size
, d©a->
smp_ty≥
);

168 } i‡(
mår_≠s_dñayed_öô
) {

172 
mår_if
->
	`£t_Æl
();

175 
	`©omic_dec
(&
d©a
->
cou¡
);

176 
	`©omic_ªad
(&
d©a
->
g©e
))

177 
	`˝u_ªœx
();

179 
	`©omic_dec
(&
d©a
->
cou¡
);

180 
	`loˇl_úq_ª°‹e
(
Êags
);

182 
	}
}

184 
ölöe
 
	$ty≥s_com∑tibÀ
(
mår_ty≥
 
ty≥1
, mår_ty≥ 
ty≥2
)

186  
ty≥1
 =
MTRR_TYPE_UNCACHABLE
 ||

187 
ty≥2
 =
MTRR_TYPE_UNCACHABLE
 ||

188 (
ty≥1
 =
MTRR_TYPE_WRTHROUGH
 && 
ty≥2
 =
MTRR_TYPE_WRBACK
) ||

189 (
ty≥1
 =
MTRR_TYPE_WRBACK
 && 
ty≥2
 =
MTRR_TYPE_WRTHROUGH
);

190 
	}
}

233 
	$£t_mår
(
ªg
, 
ba£
, 
size
, 
mår_ty≥
 
ty≥
)

235 
£t_mår_d©a
 
d©a
;

236 
Êags
;

238 
d©a
.
smp_ªg
 = 
ªg
;

239 
d©a
.
smp_ba£
 = 
ba£
;

240 
d©a
.
smp_size
 = 
size
;

241 
d©a
.
smp_ty≥
 = 
ty≥
;

242 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

245 
	`smp_wmb
();

246 
	`©omic_£t
(&
d©a
.
g©e
, 0);

249 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_h™dÀr
, &
d©a
, 0) != 0)

250 
	`∑nic
("mtrr:Åimed out waiting for other CPUs\n");

252 
	`loˇl_úq_ßve
(
Êags
);

254 
	`©omic_ªad
(&
d©a
.
cou¡
))

255 
	`˝u_ªœx
();

258 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

259 
	`smp_wmb
();

260 
	`©omic_£t
(&
d©a
.
g©e
, 1);

271 i‡(
ªg
 != ~0U)

272 
mår_if
->
	`£t
(
ªg
, 
ba£
, 
size
, 
ty≥
);

273 i‡(!
mår_≠s_dñayed_öô
)

274 
mår_if
->
	`£t_Æl
();

277 
	`©omic_ªad
(&
d©a
.
cou¡
))

278 
	`˝u_ªœx
();

280 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

281 
	`smp_wmb
();

282 
	`©omic_£t
(&
d©a
.
g©e
, 0);

288 
	`©omic_ªad
(&
d©a
.
cou¡
))

289 
	`˝u_ªœx
();

291 
	`loˇl_úq_ª°‹e
(
Êags
);

292 
	}
}

329 
	$mår_add_∑ge
(
ba£
, 
size
,

330 
ty≥
, 
boﬁ
 
ö¸emít
)

332 
lba£
, 
lsize
;

333 
i
, 
ª∂a˚
, 
îr‹
;

334 
mår_ty≥
 
…y≥
;

336 i‡(!
mår_if
)

337  -
ENXIO
;

339 
îr‹
 = 
mår_if
->
	`vÆid©e_add_∑ge
(
ba£
, 
size
, 
ty≥
);

340 i‡(
îr‹
)

341  
îr‹
;

343 i‡(
ty≥
 >
MTRR_NUM_TYPES
) {

344 
	`¥_w¨nög
("mår:Åy≥: %u invÆid\n", 
ty≥
);

345  -
EINVAL
;

349 i‡((
ty≥
 =
MTRR_TYPE_WRCOMB
Ë&& !
	`have_wrcomb
()) {

350 
	`¥_w¨nög
("mtrr: yourÖrocessor doesn't support write-combining\n");

351  -
ENOSYS
;

354 i‡(!
size
) {

355 
	`¥_w¨nög
("mtrr: zero sizedÑequest\n");

356  -
EINVAL
;

359 i‡(
ba£
 & 
size_‹_mask
 || 
size
 & size_or_mask) {

360 
	`¥_w¨nög
("mtrr: base or sizeÉxceedsÅhe MTRR width\n");

361  -
EINVAL
;

364 
îr‹
 = -
EINVAL
;

365 
ª∂a˚
 = -1;

368 
	`gë_⁄löe_˝us
();

371 
	`muãx_lock
(&
mår_muãx
);

372 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

373 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

374 i‡(!
lsize
 || 
ba£
 > 
lba£
 +Üsize - 1 ||

375 
ba£
 + 
size
 - 1 < 
lba£
)

381 i‡(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >Üba£ + 
lsize
 - 1) {

382 i‡(
ba£
 <
lba£
 &&

383 
ba£
 + 
size
 - 1 >
lba£
 + 
lsize
 - 1) {

385 i‡(
ty≥
 =
…y≥
) {

386 
ª∂a˚
 =Ñïœ˚ =-1 ? 
i
 : -2;

388 } i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

391 
	`¥_w¨nög
("mtrr: 0x%lx000,0x%lx000 overlapsÉxisting"

392 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

393 
lsize
);

394 
out
;

397 i‡(
…y≥
 !
ty≥
) {

398 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

400 
	`¥_w¨nög
("mtrr:Åype mismatch for %lx000,%lx000 old: %sÇew: %s\n",

401 
ba£
, 
size
, 
	`mår_©åib_to_°r
(
…y≥
),

402 
	`mår_©åib_to_°r
(
ty≥
));

403 
out
;

405 i‡(
ö¸emít
)

406 ++
mår_ußge_èbÀ
[
i
];

407 
îr‹
 = 
i
;

408 
out
;

411 
i
 = 
mår_if
->
	`gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚
);

412 i‡(
i
 >= 0) {

413 
	`£t_mår
(
i
, 
ba£
, 
size
, 
ty≥
);

414 i‡(
	`likñy
(
ª∂a˚
 < 0)) {

415 
mår_ußge_èbÀ
[
i
] = 1;

417 
mår_ußge_èbÀ
[
i
] = mår_ußge_èbÀ[
ª∂a˚
];

418 i‡(
ö¸emít
)

419 
mår_ußge_èbÀ
[
i
]++;

420 i‡(
	`u∆ikñy
(
ª∂a˚
 !
i
)) {

421 
	`£t_mår
(
ª∂a˚
, 0, 0, 0);

422 
mår_ußge_èbÀ
[
ª∂a˚
] = 0;

426 
	`¥_öfo
("mtrr:Ço more MTRRsávailable\n");

428 
îr‹
 = 
i
;

429 
out
:

430 
	`muãx_u∆ock
(&
mår_muãx
);

431 
	`put_⁄löe_˝us
();

432  
îr‹
;

433 
	}
}

435 
	$mår_check
(
ba£
, 
size
)

437 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1))) {

438 
	`¥_w¨nög
("mtrr: sizeánd base must be multiples of 4 kiB\n");

439 
	`¥_debug
("mår: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

440 
	`dump_°ack
();

444 
	}
}

481 
	$mår_add
(
ba£
, 
size
, 
ty≥
,

482 
boﬁ
 
ö¸emít
)

484 i‡(
	`mår_check
(
ba£
, 
size
))

485  -
EINVAL
;

486  
	`mår_add_∑ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty≥
,

487 
ö¸emít
);

488 
	}
}

489 
EXPORT_SYMBOL
(
mår_add
);

505 
	$mår_dñ_∑ge
(
ªg
, 
ba£
, 
size
)

507 
i
, 
max
;

508 
mår_ty≥
 
…y≥
;

509 
lba£
, 
lsize
;

510 
îr‹
 = -
EINVAL
;

512 i‡(!
mår_if
)

513  -
ENXIO
;

515 
max
 = 
num_v¨_ønges
;

517 
	`gë_⁄löe_˝us
();

518 
	`muãx_lock
(&
mår_muãx
);

519 i‡(
ªg
 < 0) {

521 
i
 = 0; i < 
max
; ++i) {

522 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

523 i‡(
lba£
 =
ba£
 && 
lsize
 =
size
) {

524 
ªg
 = 
i
;

528 i‡(
ªg
 < 0) {

529 
	`¥_debug
("mtrr:Ço MTRR for %lx000,%lx000 found\n",

530 
ba£
, 
size
);

531 
out
;

534 i‡(
ªg
 >
max
) {

535 
	`¥_w¨nög
("mår:Ñegi°î: %dÅoÿbig\n", 
ªg
);

536 
out
;

538 
mår_if
->
	`gë
(
ªg
, &
lba£
, &
lsize
, &
…y≥
);

539 i‡(
lsize
 < 1) {

540 
	`¥_w¨nög
("mår: MTRR %dÇŸ u£d\n", 
ªg
);

541 
out
;

543 i‡(
mår_ußge_èbÀ
[
ªg
] < 1) {

544 
	`¥_w¨nög
("mår:Ñeg: %d ha†cou¡=0\n", 
ªg
);

545 
out
;

547 i‡(--
mår_ußge_èbÀ
[
ªg
] < 1)

548 
	`£t_mår
(
ªg
, 0, 0, 0);

549 
îr‹
 = 
ªg
;

550 
out
:

551 
	`muãx_u∆ock
(&
mår_muãx
);

552 
	`put_⁄löe_˝us
();

553  
îr‹
;

554 
	}
}

570 
	$mår_dñ
(
ªg
, 
ba£
, 
size
)

572 i‡(
	`mår_check
(
ba£
, 
size
))

573  -
EINVAL
;

574  
	`mår_dñ_∑ge
(
ªg
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

575 
	}
}

576 
EXPORT_SYMBOL
(
mår_dñ
);

583 
__öô
 
	$öô_ifs
()

585 #i‚de‡
CONFIG_X86_64


586 
	`amd_öô_mår
();

587 
	`cyrix_öô_mår
();

588 
	`˚¡aur_öô_mår
();

590 
	}
}

595 
	smår_vÆue
 {

596 
mår_ty≥
 
	m…y≥
;

597 
	mlba£
;

598 
	mlsize
;

601 
mår_vÆue
 
	gmår_vÆue
[
MTRR_MAX_VAR_RANGES
];

603 
	$mår_ßve
(
sys_devi˚
 *
sysdev
, 
pm_mesßge_t
 
°©e
)

605 
i
;

607 
i
 = 0; i < 
num_v¨_ønges
; i++) {

608 
mår_if
->
	`gë
(
i
, &
mår_vÆue
[i].
lba£
,

609 &
mår_vÆue
[
i
].
lsize
,

610 &
mår_vÆue
[
i
].
…y≥
);

613 
	}
}

615 
	$mår_ª°‹e
(
sys_devi˚
 *
sysdev
)

617 
i
;

619 
i
 = 0; i < 
num_v¨_ønges
; i++) {

620 i‡(
mår_vÆue
[
i
].
lsize
) {

621 
	`£t_mår
(
i
, 
mår_vÆue
[i].
lba£
,

622 
mår_vÆue
[
i
].
lsize
,

623 
mår_vÆue
[
i
].
…y≥
);

627 
	}
}

631 
sysdev_drivî
 
	gmår_sysdev_drivî
 = {

632 .
su•íd
 = 
mår_ßve
,

633 .
	gªsume
 = 
mår_ª°‹e
,

636 
__öôd©a
 
	gch™ged_by_mår_˛ónup
;

645 
__öô
 
	$mår_bp_öô
()

647 
u32
 
phys_addr
;

649 
	`öô_ifs
();

651 
phys_addr
 = 32;

653 i‡(
˝u_has_mår
) {

654 
mår_if
 = &
gíîic_mår_›s
;

655 
size_‹_mask
 = 0xff000000;

656 
size_™d_mask
 = 0x00f00000;

657 
phys_addr
 = 36;

664 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000008) {

665 
phys_addr
 = 
	`˝uid_óx
(0x80000008) & 0xff;

667 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

668 
boŸ_˝u_d©a
.
x86
 == 0xF &&

669 
boŸ_˝u_d©a
.
x86_modñ
 == 0x3 &&

670 (
boŸ_˝u_d©a
.
x86_mask
 == 0x3 ||

671 
boŸ_˝u_d©a
.
x86_mask
 == 0x4))

672 
phys_addr
 = 36;

674 
size_‹_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

675 
size_™d_mask
 = ~
size_‹_mask
 & 0xfffff00000ULL;

676 } i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_CENTAUR
 &&

677 
boŸ_˝u_d©a
.
x86
 == 6) {

682 
size_‹_mask
 = 0xfff00000;

683 
size_™d_mask
 = 0;

684 
phys_addr
 = 32;

687 
boŸ_˝u_d©a
.
x86_víd‹
) {

688 
X86_VENDOR_AMD
:

689 i‡(
˝u_has_k6_mår
) {

691 
mår_if
 = 
mår_›s
[
X86_VENDOR_AMD
];

692 
size_‹_mask
 = 0xfff00000;

693 
size_™d_mask
 = 0;

696 
X86_VENDOR_CENTAUR
:

697 i‡(
˝u_has_˚¡aur_m¸
) {

698 
mår_if
 = 
mår_›s
[
X86_VENDOR_CENTAUR
];

699 
size_‹_mask
 = 0xfff00000;

700 
size_™d_mask
 = 0;

703 
X86_VENDOR_CYRIX
:

704 i‡(
˝u_has_cyrix_¨r
) {

705 
mår_if
 = 
mår_›s
[
X86_VENDOR_CYRIX
];

706 
size_‹_mask
 = 0xfff00000;

707 
size_™d_mask
 = 0;

715 i‡(
mår_if
) {

716 
	`£t_num_v¨_ønges
();

717 
	`öô_èbÀ
();

718 i‡(
	`u£_öãl
()) {

719 
	`gë_mår_°©e
();

721 i‡(
	`mår_˛ónup
(
phys_addr
)) {

722 
ch™ged_by_mår_˛ónup
 = 1;

723 
mår_if
->
	`£t_Æl
();

727 
	}
}

729 
	$mår_≠_öô
()

731 i‡(!
	`u£_öãl
(Ë|| 
mår_≠s_dñayed_öô
)

746 
	`£t_mår
(~0U, 0, 0, 0);

747 
	}
}

752 
	$mår_ßve_°©e
()

754 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(0, 
mår_ßve_fixed_ønges
, 
NULL
, 1);

755 
	}
}

757 
	$£t_mår_≠s_dñayed_öô
()

759 i‡(!
	`u£_öãl
())

762 
mår_≠s_dñayed_öô
 = 
åue
;

763 
	}
}

768 
	$mår_≠s_öô
()

770 i‡(!
	`u£_öãl
())

773 
	`£t_mår
(~0U, 0, 0, 0);

774 
mår_≠s_dñayed_öô
 = 
Ál£
;

775 
	}
}

777 
	$mår_bp_ª°‹e
()

779 i‡(!
	`u£_öãl
())

782 
mår_if
->
	`£t_Æl
();

783 
	}
}

785 
__öô
 
	$mår_öô_föülize
()

787 i‡(!
mår_if
)

790 i‡(
	`u£_öãl
()) {

791 i‡(!
ch™ged_by_mår_˛ónup
)

792 
	`mår_°©e_w¨n
();

804 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mår_sysdev_drivî
);

807 
	}
}

808 
subsys_öôˇŒ
(
mår_öô_föülize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c

15 
	~<löux/≥rf_evít.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/k¥obes.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/kdebug.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/uac˚ss.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/highmem.h
>

26 
	~<löux/˝u.h
>

27 
	~<löux/bô›s.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/°ackåa˚.h
>

31 
	~<asm/nmi.h
>

32 
	~<asm/com∑t.h
>

34 
u64
 
≥rf_evít_mask
 
	g__ªad_mo°ly
;

37 
	#MAX_PEBS_EVENTS
 4

	)

40 
	#BTS_RECORD_SIZE
 24

	)

43 
	#BTS_BUFFER_SIZE
 (
BTS_RECORD_SIZE
 * 2048)

	)

46 
	#BTS_OVFL_TH
 (
BTS_RECORD_SIZE
 * 128)

	)

52 
	#X86_DEBUGCTL_TR
 (1 << 6)

	)

53 
	#X86_DEBUGCTL_BTS
 (1 << 7)

	)

54 
	#X86_DEBUGCTL_BTINT
 (1 << 8)

	)

55 
	#X86_DEBUGCTL_BTS_OFF_OS
 (1 << 9)

	)

56 
	#X86_DEBUGCTL_BTS_OFF_USR
 (1 << 10)

	)

63 
	sdebug_°‹e
 {

64 
u64
 
	mbts_buf„r_ba£
;

65 
u64
 
	mbts_ödex
;

66 
u64
 
	mbts_absﬁuã_maximum
;

67 
u64
 
	mbts_öãºu±_thªshﬁd
;

68 
u64
 
	m≥bs_buf„r_ba£
;

69 
u64
 
	m≥bs_ödex
;

70 
u64
 
	m≥bs_absﬁuã_maximum
;

71 
u64
 
	m≥bs_öãºu±_thªshﬁd
;

72 
u64
 
	m≥bs_evít_ª£t
[
MAX_PEBS_EVENTS
];

75 
	sevít_c⁄°øöt
 {

77 
	midxmsk
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

78 
u64
 
	midxmsk64
;

80 
u64
 
	mcode
;

81 
u64
 
	mcmask
;

82 
	mweight
;

85 
	samd_nb
 {

86 
	mnb_id
;

87 
	mªf˙t
;

88 
≥rf_evít
 *
	mow√rs
[
X86_PMC_IDX_MAX
];

89 
evít_c⁄°øöt
 
	mevít_c⁄°øöts
[
X86_PMC_IDX_MAX
];

92 
	s˝u_hw_evíts
 {

93 
≥rf_evít
 *
	mevíts
[
X86_PMC_IDX_MAX
];

94 
	ma˘ive_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

95 
	möãºu±s
;

96 
	míabÀd
;

97 
debug_°‹e
 *
	mds
;

99 
	mn_evíts
;

100 
	mn_added
;

101 
	massign
[
X86_PMC_IDX_MAX
];

102 
u64
 
	mègs
[
X86_PMC_IDX_MAX
];

103 
≥rf_evít
 *
	mevít_li°
[
X86_PMC_IDX_MAX
];

104 
amd_nb
 *
	mamd_nb
;

107 
	#__EVENT_CONSTRAINT
(
c
, 
n
, 
m
, 
w
) {\

108 { .
idxmsk64
 = (
n
) }, \

109 .
code
 = (
c
), \

110 .
cmask
 = (
m
), \

111 .
weight
 = (
w
), \

112 }

	)

114 
	#EVENT_CONSTRAINT
(
c
, 
n
, 
m
) \

115 
	`__EVENT_CONSTRAINT
(
c
, 
n
, 
m
, 
	`HWEIGHT
“))

	)

117 
	#INTEL_EVENT_CONSTRAINT
(
c
, 
n
) \

118 
	`EVENT_CONSTRAINT
(
c
, 
n
, 
INTEL_ARCH_EVTSEL_MASK
)

	)

120 
	#FIXED_EVENT_CONSTRAINT
(
c
, 
n
) \

121 
	`EVENT_CONSTRAINT
(
c
, (1ULL << (32+
n
)), 
INTEL_ARCH_FIXED_MASK
)

	)

123 
	#EVENT_CONSTRAINT_END
 \

124 
	`EVENT_CONSTRAINT
(0, 0, 0)

	)

126 
	#f‹_óch_evít_c⁄°øöt
(
e
, 
c
) \

127 (
e
Ë(
c
); (e)->
cmask
; (e)++)

	)

132 
	sx86_pmu
 {

133 c⁄° *
	m«me
;

134 
	mvîsi⁄
;

135 (*
	mh™dÀ_úq
)(
	m±_ªgs
 *);

136 (*
	mdißbÀ_Æl
)();

137 (*
	míabÀ_Æl
)();

138 (*
	míabÀ
)(
	m≥rf_evít
 *);

139 (*
	mdißbÀ
)(
	m≥rf_evít
 *);

140 
	mevít£l
;

141 
	m≥rf˘r
;

142 
u64
 (*
evít_m≠
)();

143 
u64
 (*
øw_evít
)(
	mu64
);

144 
	mmax_evíts
;

145 
	mnum_evíts
;

146 
	mnum_evíts_fixed
;

147 
	mevít_bôs
;

148 
u64
 
	mevít_mask
;

149 
	m≠ic
;

150 
u64
 
	mmax_≥riod
;

151 
u64
 
	möãl_˘æ
;

152 (*
	míabÀ_bts
)(
u64
 
	mc⁄fig
);

153 (*
	mdißbÀ_bts
)();

155 
	mevít_c⁄°øöt
 *

156 (*
	mgë_evít_c⁄°øöts
)(
˝u_hw_evíts
 *
	m˝uc
,

157 
≥rf_evít
 *
	mevít
);

159 (*
	mput_evít_c⁄°øöts
)(
˝u_hw_evíts
 *
	m˝uc
,

160 
≥rf_evít
 *
	mevít
);

161 
evít_c⁄°øöt
 *
	mevít_c⁄°øöts
;

163 (*
	m˝u_¥ï¨e
)(
	m˝u
);

164 (*
	m˝u_°¨tög
)(
	m˝u
);

165 (*
	m˝u_dyög
)(
	m˝u
);

166 (*
	m˝u_dód
)(
	m˝u
);

169 
x86_pmu
 x86_pmu 
	g__ªad_mo°ly
;

171 
DEFINE_PER_CPU
(
˝u_hw_evíts
, cpu_hw_events) = {

172 .
íabÀd
 = 1,

175 
x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
);

185 
	#C
(
x
Ë
PERF_COUNT_HW_CACHE_
##
	)
x

187 
u64
 
__ªad_mo°ly
 
	ghw_ˇche_evít_ids


188 [
PERF_COUNT_HW_CACHE_MAX
]

189 [
PERF_COUNT_HW_CACHE_OP_MAX
]

190 [
PERF_COUNT_HW_CACHE_RESULT_MAX
];

197 
u64


198 
	$x86_≥rf_evít_upd©e
(
≥rf_evít
 *
evít
)

200 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

201 
shi·
 = 64 - 
x86_pmu
.
evít_bôs
;

202 
u64
 
¥ev_øw_cou¡
, 
√w_øw_cou¡
;

203 
idx
 = 
hwc
->idx;

204 
s64
 
dñè
;

206 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

216 
agaö
:

217 
¥ev_øw_cou¡
 = 
	`©omic64_ªad
(&
hwc
->
¥ev_cou¡
);

218 
	`rdm§l
(
hwc
->
evít_ba£
 + 
idx
, 
√w_øw_cou¡
);

220 i‡(
	`©omic64_cmpxchg
(&
hwc
->
¥ev_cou¡
, 
¥ev_øw_cou¡
,

221 
√w_øw_cou¡
Ë!
¥ev_øw_cou¡
)

222 
agaö
;

232 
dñè
 = (
√w_øw_cou¡
 << 
shi·
Ë- (
¥ev_øw_cou¡
 << shift);

233 
dñè
 >>
shi·
;

235 
	`©omic64_add
(
dñè
, &
evít
->
cou¡
);

236 
	`©omic64_sub
(
dñè
, &
hwc
->
≥riod_À·
);

238  
√w_øw_cou¡
;

239 
	}
}

241 
©omic_t
 
	ga˘ive_evíts
;

242 
DEFINE_MUTEX
(
pmc_ª£rve_muãx
);

244 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
()

246 #ifde‡
CONFIG_X86_LOCAL_APIC


247 
i
;

249 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

250 
	`dißbÀ_œpic_nmi_w©chdog
();

252 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

253 i‡(!
	`ª£rve_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
))

254 
≥rf˘r_Áû
;

257 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

258 i‡(!
	`ª£rve_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
))

259 
evít£l_Áû
;

263  
åue
;

265 #ifde‡
CONFIG_X86_LOCAL_APIC


266 
evít£l_Áû
:

267 
i
--; i >= 0; i--)

268 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

270 
i
 = 
x86_pmu
.
num_evíts
;

272 
≥rf˘r_Áû
:

273 
i
--; i >= 0; i--)

274 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

276 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

277 
	`íabÀ_œpic_nmi_w©chdog
();

279  
Ál£
;

281 
	}
}

283 
	$ªÀa£_pmc_h¨dw¨e
()

285 #ifde‡
CONFIG_X86_LOCAL_APIC


286 
i
;

288 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

289 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

290 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

293 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

294 
	`íabÀ_œpic_nmi_w©chdog
();

296 
	}
}

298 
ölöe
 
boﬁ
 
	$bts_avaûabÀ
()

300  
x86_pmu
.
íabÀ_bts
 !
NULL
;

301 
	}
}

303 
	$öô_debug_°‹e_⁄_˝u
(
˝u
)

305 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

307 i‡(!
ds
)

310 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
,

311 (
u32
)((
u64
)()
ds
),

312 (
u32
)((
u64
)()
ds
 >> 32));

313 
	}
}

315 
	$föi_debug_°‹e_⁄_˝u
(
˝u
)

317 i‡(!
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
)

320 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
, 0, 0);

321 
	}
}

323 
	$ªÀa£_bts_h¨dw¨e
()

325 
˝u
;

327 i‡(!
	`bts_avaûabÀ
())

330 
	`gë_⁄löe_˝us
();

332 
	`f‹_óch_⁄löe_˝u
(
˝u
)

333 
	`föi_debug_°‹e_⁄_˝u
(
˝u
);

335 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

336 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

338 i‡(!
ds
)

341 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = 
NULL
;

343 
	`k‰ì
((*)()
ds
->
bts_buf„r_ba£
);

344 
	`k‰ì
(
ds
);

347 
	`put_⁄löe_˝us
();

348 
	}
}

350 
	$ª£rve_bts_h¨dw¨e
()

352 
˝u
, 
îr
 = 0;

354 i‡(!
	`bts_avaûabÀ
())

357 
	`gë_⁄löe_˝us
();

359 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

360 
debug_°‹e
 *
ds
;

361 *
buf„r
;

363 
îr
 = -
ENOMEM
;

364 
buf„r
 = 
	`kzÆloc
(
BTS_BUFFER_SIZE
, 
GFP_KERNEL
);

365 i‡(
	`u∆ikñy
(!
buf„r
))

368 
ds
 = 
	`kzÆloc
((*ds), 
GFP_KERNEL
);

369 i‡(
	`u∆ikñy
(!
ds
)) {

370 
	`k‰ì
(
buf„r
);

374 
ds
->
bts_buf„r_ba£
 = (
u64
)()
buf„r
;

375 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

376 
ds
->
bts_absﬁuã_maximum
 =

377 
ds
->
bts_buf„r_ba£
 + 
BTS_BUFFER_SIZE
;

378 
ds
->
bts_öãºu±_thªshﬁd
 =

379 
ds
->
bts_absﬁuã_maximum
 - 
BTS_OVFL_TH
;

381 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = ds;

382 
îr
 = 0;

385 i‡(
îr
)

386 
	`ªÀa£_bts_h¨dw¨e
();

388 
	`f‹_óch_⁄löe_˝u
(
˝u
)

389 
	`öô_debug_°‹e_⁄_˝u
(
˝u
);

392 
	`put_⁄löe_˝us
();

394  
îr
;

395 
	}
}

397 
	$hw_≥rf_evít_de°roy
(
≥rf_evít
 *
evít
)

399 i‡(
	`©omic_dec_™d_muãx_lock
(&
a˘ive_evíts
, &
pmc_ª£rve_muãx
)) {

400 
	`ªÀa£_pmc_h¨dw¨e
();

401 
	`ªÀa£_bts_h¨dw¨e
();

402 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

404 
	}
}

406 
ölöe
 
	$x86_pmu_öôülized
()

408  
x86_pmu
.
h™dÀ_úq
 !
NULL
;

409 
	}
}

411 
ölöe
 

412 
	$£t_ext_hw_©å
(
hw_≥rf_evít
 *
hwc
, 
≥rf_evít_©å
 *
©å
)

414 
ˇche_ty≥
, 
ˇche_›
, 
ˇche_ªsu…
;

415 
u64
 
c⁄fig
, 
vÆ
;

417 
c⁄fig
 = 
©å
->config;

419 
ˇche_ty≥
 = (
c⁄fig
 >> 0) & 0xff;

420 i‡(
ˇche_ty≥
 >
PERF_COUNT_HW_CACHE_MAX
)

421  -
EINVAL
;

423 
ˇche_›
 = (
c⁄fig
 >> 8) & 0xff;

424 i‡(
ˇche_›
 >
PERF_COUNT_HW_CACHE_OP_MAX
)

425  -
EINVAL
;

427 
ˇche_ªsu…
 = (
c⁄fig
 >> 16) & 0xff;

428 i‡(
ˇche_ªsu…
 >
PERF_COUNT_HW_CACHE_RESULT_MAX
)

429  -
EINVAL
;

431 
vÆ
 = 
hw_ˇche_evít_ids
[
ˇche_ty≥
][
ˇche_›
][
ˇche_ªsu…
];

433 i‡(
vÆ
 == 0)

434  -
ENOENT
;

436 i‡(
vÆ
 == -1)

437  -
EINVAL
;

439 
hwc
->
c⁄fig
 |
vÆ
;

442 
	}
}

447 
	$__hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

449 
≥rf_evít_©å
 *
©å
 = &
evít
->attr;

450 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

451 
u64
 
c⁄fig
;

452 
îr
;

454 i‡(!
	`x86_pmu_öôülized
())

455  -
ENODEV
;

457 
îr
 = 0;

458 i‡(!
	`©omic_öc_nŸ_zîo
(&
a˘ive_evíts
)) {

459 
	`muãx_lock
(&
pmc_ª£rve_muãx
);

460 i‡(
	`©omic_ªad
(&
a˘ive_evíts
) == 0) {

461 i‡(!
	`ª£rve_pmc_h¨dw¨e
())

462 
îr
 = -
EBUSY
;

464 
îr
 = 
	`ª£rve_bts_h¨dw¨e
();

466 i‡(!
îr
)

467 
	`©omic_öc
(&
a˘ive_evíts
);

468 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

470 i‡(
îr
)

471  
îr
;

473 
evít
->
de°roy
 = 
hw_≥rf_evít_de°roy
;

479 
hwc
->
c⁄fig
 = 
ARCH_PERFMON_EVENTSEL_INT
;

481 
hwc
->
idx
 = -1;

482 
hwc
->
œ°_˝u
 = -1;

483 
hwc
->
œ°_èg
 = ~0ULL;

488 i‡(!
©å
->
ex˛ude_u£r
)

489 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_USR
;

490 i‡(!
©å
->
ex˛ude_kî√l
)

491 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_OS
;

493 i‡(!
hwc
->
ßm∂e_≥riod
) {

494 
hwc
->
ßm∂e_≥riod
 = 
x86_pmu
.
max_≥riod
;

495 
hwc
->
œ°_≥riod
 = hwc->
ßm∂e_≥riod
;

496 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, hwc->
ßm∂e_≥riod
);

504 i‡(!
x86_pmu
.
≠ic
)

505  -
EOPNOTSUPP
;

511 i‡(
©å
->
ty≥
 =
PERF_TYPE_RAW
) {

512 
hwc
->
c⁄fig
 |
x86_pmu
.
	`øw_evít
(
©å
->config);

513 i‡((
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_ANY
) &&

514 
	`≥rf_∑ønoid_˝u
(Ë&& !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

515  -
EACCES
;

519 i‡(
©å
->
ty≥
 =
PERF_TYPE_HW_CACHE
)

520  
	`£t_ext_hw_©å
(
hwc
, 
©å
);

522 i‡(
©å
->
c⁄fig
 >
x86_pmu
.
max_evíts
)

523  -
EINVAL
;

528 
c⁄fig
 = 
x86_pmu
.
	`evít_m≠
(
©å
->config);

530 i‡(
c⁄fig
 == 0)

531  -
ENOENT
;

533 i‡(
c⁄fig
 == -1LL)

534  -
EINVAL
;

539 i‡((
©å
->
c⁄fig
 =
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
) &&

540 (
hwc
->
ßm∂e_≥riod
 == 1)) {

542 i‡(!
	`bts_avaûabÀ
())

543  -
EOPNOTSUPP
;

546 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

547  -
EOPNOTSUPP
;

550 
hwc
->
c⁄fig
 |= config;

553 
	}
}

555 
	$x86_pmu_dißbÀ_Æl
()

557 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

558 
idx
;

560 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

561 
u64
 
vÆ
;

563 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

565 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

566 i‡(!(
vÆ
 & 
ARCH_PERFMON_EVENTSEL_ENABLE
))

568 
vÆ
 &~
ARCH_PERFMON_EVENTSEL_ENABLE
;

569 
	`wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

571 
	}
}

573 
	$hw_≥rf_dißbÀ
()

575 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

577 i‡(!
	`x86_pmu_öôülized
())

580 i‡(!
˝uc
->
íabÀd
)

583 
˝uc
->
n_added
 = 0;

584 
˝uc
->
íabÀd
 = 0;

585 
	`b¨rõr
();

587 
x86_pmu
.
	`dißbÀ_Æl
();

588 
	}
}

590 
	$x86_pmu_íabÀ_Æl
()

592 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

593 
idx
;

595 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

596 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
idx
];

597 
u64
 
vÆ
;

599 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

602 
vÆ
 = 
evít
->
hw
.
c⁄fig
;

603 
vÆ
 |
ARCH_PERFMON_EVENTSEL_ENABLE
;

604 
	`wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

606 
	}
}

608 c⁄° 
pmu
 
	gpmu
;

610 
ölöe
 
	$is_x86_evít
(
≥rf_evít
 *
evít
)

612  
evít
->
pmu
 == &pmu;

613 
	}
}

615 
	$x86_scheduÀ_evíts
(
˝u_hw_evíts
 *
˝uc
, 
n
, *
assign
)

617 
evít_c⁄°øöt
 *
c
, *
c⁄°øöts
[
X86_PMC_IDX_MAX
];

618 
u£d_mask
[
	`BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

619 
i
, 
j
, 
w
, 
wmax
, 
num
 = 0;

620 
hw_≥rf_evít
 *
hwc
;

622 
	`bôm≠_zîo
(
u£d_mask
, 
X86_PMC_IDX_MAX
);

624 
i
 = 0; i < 
n
; i++) {

625 
c
 = 
x86_pmu
.
	`gë_evít_c⁄°øöts
(
˝uc
, cpuc->
evít_li°
[
i
]);

626 
c⁄°øöts
[
i
] = 
c
;

632 
i
 = 0; i < 
n
; i++) {

633 
hwc
 = &
˝uc
->
evít_li°
[
i
]->
hw
;

634 
c
 = 
c⁄°øöts
[
i
];

637 i‡(
hwc
->
idx
 == -1)

641 i‡(!
	`ã°_bô
(
hwc
->
idx
, 
c
->
idxmsk
))

645 i‡(
	`ã°_bô
(
hwc
->
idx
, 
u£d_mask
))

648 
	`__£t_bô
(
hwc
->
idx
, 
u£d_mask
);

649 i‡(
assign
)

650 
assign
[
i
] = 
hwc
->
idx
;

652 i‡(
i
 =
n
)

653 
d⁄e
;

659 
	`bôm≠_zîo
(
u£d_mask
, 
X86_PMC_IDX_MAX
);

670 
wmax
 = 
x86_pmu
.
num_evíts
;

677 i‡(
x86_pmu
.
num_evíts_fixed
)

678 
wmax
++;

680 
w
 = 1, 
num
 = 
n
;Çum && w <
wmax
; w++) {

682 
i
 = 0; 
num
 && i < 
n
; i++) {

683 
c
 = 
c⁄°øöts
[
i
];

684 
hwc
 = &
˝uc
->
evít_li°
[
i
]->
hw
;

686 i‡(
c
->
weight
 !
w
)

689 
	`f‹_óch_£t_bô
(
j
, 
c
->
idxmsk
, 
X86_PMC_IDX_MAX
) {

690 i‡(!
	`ã°_bô
(
j
, 
u£d_mask
))

694 i‡(
j
 =
X86_PMC_IDX_MAX
)

697 
	`__£t_bô
(
j
, 
u£d_mask
);

699 i‡(
assign
)

700 
assign
[
i
] = 
j
;

701 
num
--;

704 
d⁄e
:

709 i‡(!
assign
 || 
num
) {

710 
i
 = 0; i < 
n
; i++) {

711 i‡(
x86_pmu
.
put_evít_c⁄°øöts
)

712 
x86_pmu
.
	`put_evít_c⁄°øöts
(
˝uc
, cpuc->
evít_li°
[
i
]);

715  
num
 ? -
ENOSPC
 : 0;

716 
	}
}

722 
	$cﬁÀ˘_evíts
(
˝u_hw_evíts
 *
˝uc
, 
≥rf_evít
 *
Àadî
, 
boﬁ
 
dogΩ
)

724 
≥rf_evít
 *
evít
;

725 
n
, 
max_cou¡
;

727 
max_cou¡
 = 
x86_pmu
.
num_evíts
 + x86_pmu.
num_evíts_fixed
;

730 
n
 = 
˝uc
->
n_evíts
;

732 i‡(
	`is_x86_evít
(
Àadî
)) {

733 i‡(
n
 >
max_cou¡
)

734  -
ENOSPC
;

735 
˝uc
->
evít_li°
[
n
] = 
Àadî
;

736 
n
++;

738 i‡(!
dogΩ
)

739  
n
;

741 
	`li°_f‹_óch_íåy
(
evít
, &
Àadî
->
siblög_li°
, 
group_íåy
) {

742 i‡(!
	`is_x86_evít
(
evít
) ||

743 
evít
->
°©e
 <
PERF_EVENT_STATE_OFF
)

746 i‡(
n
 >
max_cou¡
)

747  -
ENOSPC
;

749 
˝uc
->
evít_li°
[
n
] = 
evít
;

750 
n
++;

752  
n
;

753 
	}
}

755 
ölöe
 
	$x86_assign_hw_evít
(
≥rf_evít
 *
evít
,

756 
˝u_hw_evíts
 *
˝uc
, 
i
)

758 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

760 
hwc
->
idx
 = 
˝uc
->
assign
[
i
];

761 
hwc
->
œ°_˝u
 = 
	`smp_¥o˚ss‹_id
();

762 
hwc
->
œ°_èg
 = ++
˝uc
->
ègs
[
i
];

764 i‡(
hwc
->
idx
 =
X86_PMC_IDX_FIXED_BTS
) {

765 
hwc
->
c⁄fig_ba£
 = 0;

766 
hwc
->
evít_ba£
 = 0;

767 } i‡(
hwc
->
idx
 >
X86_PMC_IDX_FIXED
) {

768 
hwc
->
c⁄fig_ba£
 = 
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
;

773 
hwc
->
evít_ba£
 =

774 
MSR_ARCH_PERFMON_FIXED_CTR0
 - 
X86_PMC_IDX_FIXED
;

776 
hwc
->
c⁄fig_ba£
 = 
x86_pmu
.
evít£l
;

777 
hwc
->
evít_ba£
 = 
x86_pmu
.
≥rf˘r
;

779 
	}
}

781 
ölöe
 
	$m©ch_¥ev_assignmít
(
hw_≥rf_evít
 *
hwc
,

782 
˝u_hw_evíts
 *
˝uc
,

783 
i
)

785  
hwc
->
idx
 =
˝uc
->
assign
[
i
] &&

786 
hwc
->
œ°_˝u
 =
	`smp_¥o˚ss‹_id
() &&

787 
hwc
->
œ°_èg
 =
˝uc
->
ègs
[
i
];

788 
	}
}

790 
x86_pmu_°¨t
(
≥rf_evít
 *
evít
);

791 
x86_pmu_°›
(
≥rf_evít
 *
evít
);

793 
	$hw_≥rf_íabÀ
()

795 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

796 
≥rf_evít
 *
evít
;

797 
hw_≥rf_evít
 *
hwc
;

798 
i
;

800 i‡(!
	`x86_pmu_öôülized
())

803 i‡(
˝uc
->
íabÀd
)

806 i‡(
˝uc
->
n_added
) {

807 
n_ru¬ög
 = 
˝uc
->
n_evíts
 - cpuc->
n_added
;

815 
i
 = 0; i < 
n_ru¬ög
; i++) {

816 
evít
 = 
˝uc
->
evít_li°
[
i
];

817 
hwc
 = &
evít
->
hw
;

825 i‡(
hwc
->
idx
 == -1 ||

826 
	`m©ch_¥ev_assignmít
(
hwc
, 
˝uc
, 
i
))

829 
	`x86_pmu_°›
(
evít
);

832 
i
 = 0; i < 
˝uc
->
n_evíts
; i++) {

833 
evít
 = 
˝uc
->
evít_li°
[
i
];

834 
hwc
 = &
evít
->
hw
;

836 i‡(!
	`m©ch_¥ev_assignmít
(
hwc
, 
˝uc
, 
i
))

837 
	`x86_assign_hw_evít
(
evít
, 
˝uc
, 
i
);

838 i‡(
i
 < 
n_ru¬ög
)

841 
	`x86_pmu_°¨t
(
evít
);

843 
˝uc
->
n_added
 = 0;

844 
	`≥rf_evíts_œpic_öô
();

847 
˝uc
->
íabÀd
 = 1;

848 
	`b¨rõr
();

850 
x86_pmu
.
	`íabÀ_Æl
();

851 
	}
}

853 
ölöe
 
	$__x86_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
)

855 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + hwc->
idx
,

856 
hwc
->
c⁄fig
 | 
ARCH_PERFMON_EVENTSEL_ENABLE
);

857 
	}
}

859 
ölöe
 
	$x86_pmu_dißbÀ_evít
(
≥rf_evít
 *
evít
)

861 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

862 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + hwc->
idx
, hwc->
c⁄fig
);

863 
	}
}

865 
DEFINE_PER_CPU
(
u64
 [
X86_PMC_IDX_MAX
], 
pmc_¥ev_À·
);

872 
	$x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
)

874 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

875 
s64
 
À·
 = 
	`©omic64_ªad
(&
hwc
->
≥riod_À·
);

876 
s64
 
≥riod
 = 
hwc
->
ßm∂e_≥riod
;

877 
îr
, 
ªt
 = 0, 
idx
 = 
hwc
->idx;

879 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

885 i‡(
	`u∆ikñy
(
À·
 <-
≥riod
)) {

886 
À·
 = 
≥riod
;

887 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

888 
hwc
->
œ°_≥riod
 = 
≥riod
;

889 
ªt
 = 1;

892 i‡(
	`u∆ikñy
(
À·
 <= 0)) {

893 
À·
 +
≥riod
;

894 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

895 
hwc
->
œ°_≥riod
 = 
≥riod
;

896 
ªt
 = 1;

901 i‡(
	`u∆ikñy
(
À·
 < 2))

902 
À·
 = 2;

904 i‡(
À·
 > 
x86_pmu
.
max_≥riod
)

905 
À·
 = 
x86_pmu
.
max_≥riod
;

907 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
	`smp_¥o˚ss‹_id
()Ë
À·
;

913 
	`©omic64_£t
(&
hwc
->
¥ev_cou¡
, (
u64
)-
À·
);

915 
îr
 = 
	`checkög_wrm§l
(
hwc
->
evít_ba£
 + 
idx
,

916 (
u64
)(-
À·
Ë& 
x86_pmu
.
evít_mask
);

918 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

920  
ªt
;

921 
	}
}

923 
	$x86_pmu_íabÀ_evít
(
≥rf_evít
 *
evít
)

925 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

926 i‡(
˝uc
->
íabÀd
)

927 
	`__x86_pmu_íabÀ_evít
(&
evít
->
hw
);

928 
	}
}

939 
	$x86_pmu_íabÀ
(
≥rf_evít
 *
evít
)

941 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

942 
hw_≥rf_evít
 *
hwc
;

943 
assign
[
X86_PMC_IDX_MAX
];

944 
n
, 
n0
, 
ªt
;

946 
hwc
 = &
evít
->
hw
;

948 
n0
 = 
˝uc
->
n_evíts
;

949 
n
 = 
	`cﬁÀ˘_evíts
(
˝uc
, 
evít
, 
Ál£
);

950 i‡(
n
 < 0)

951  
n
;

953 
ªt
 = 
	`x86_scheduÀ_evíts
(
˝uc
, 
n
, 
assign
);

954 i‡(
ªt
)

955  
ªt
;

960 
	`mem˝y
(
˝uc
->
assign
,ássign, 
n
*());

962 
˝uc
->
n_evíts
 = 
n
;

963 
˝uc
->
n_added
 +
n
 - 
n0
;

966 
	}
}

968 
	$x86_pmu_°¨t
(
≥rf_evít
 *
evít
)

970 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

971 
idx
 = 
evít
->
hw
.idx;

973 i‡(
idx
 == -1)

974  -
EAGAIN
;

976 
	`x86_≥rf_evít_£t_≥riod
(
evít
);

977 
˝uc
->
evíts
[
idx
] = 
evít
;

978 
	`__£t_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

979 
x86_pmu
.
	`íabÀ
(
evít
);

980 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

983 
	}
}

985 
	$x86_pmu_u¡hrŸée
(
≥rf_evít
 *
evít
)

987 
ªt
 = 
	`x86_pmu_°¨t
(
evít
);

988 
	`WARN_ON_ONCE
(
ªt
);

989 
	}
}

991 
	$≥rf_evít_¥öt_debug
()

993 
u64
 
˘æ
, 
°©us
, 
ovîÊow
, 
pmc_˘æ
, 
pmc_cou¡
, 
¥ev_À·
, 
fixed
;

994 
˝u_hw_evíts
 *
˝uc
;

995 
Êags
;

996 
˝u
, 
idx
;

998 i‡(!
x86_pmu
.
num_evíts
)

1001 
	`loˇl_úq_ßve
(
Êags
);

1003 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1004 
˝uc
 = &
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
);

1006 i‡(
x86_pmu
.
vîsi⁄
 >= 2) {

1007 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
˘æ
);

1008 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1009 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ovîÊow
);

1010 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
, 
fixed
);

1012 
	`¥_öfo
("\n");

1013 
	`¥_öfo
("CPU#%d: cål: %016Œx\n", 
˝u
, 
˘æ
);

1014 
	`¥_öfo
("CPU#%d: sètus: %016Œx\n", 
˝u
, 
°©us
);

1015 
	`¥_öfo
("CPU#%d: ovîÊow: %016Œx\n", 
˝u
, 
ovîÊow
);

1016 
	`¥_öfo
("CPU#%d: fixed: %016Œx\n", 
˝u
, 
fixed
);

1018 
	`¥_öfo
("CPU#%d:á˘ive: %016Œx\n", 
˝u
, *(
u64
 *)
˝uc
->
a˘ive_mask
);

1020 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1021 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
pmc_˘æ
);

1022 
	`rdm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 
pmc_cou¡
);

1024 
¥ev_À·
 = 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
˝u
);

1026 
	`¥_öfo
("CPU#%d: gen-PMC%d ctrl: %016llx\n",

1027 
˝u
, 
idx
, 
pmc_˘æ
);

1028 
	`¥_öfo
("CPU#%d: gen-PMC%d count: %016llx\n",

1029 
˝u
, 
idx
, 
pmc_cou¡
);

1030 
	`¥_öfo
("CPU#%d: gen-PMC%dÜeft: %016llx\n",

1031 
˝u
, 
idx
, 
¥ev_À·
);

1033 
idx
 = 0; idx < 
x86_pmu
.
num_evíts_fixed
; idx++) {

1034 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 
pmc_cou¡
);

1036 
	`¥_öfo
("CPU#%d: fixed-PMC%d count: %016llx\n",

1037 
˝u
, 
idx
, 
pmc_cou¡
);

1039 
	`loˇl_úq_ª°‹e
(
Êags
);

1040 
	}
}

1042 
	$x86_pmu_°›
(
≥rf_evít
 *
evít
)

1044 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1045 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1046 
idx
 = 
hwc
->idx;

1048 i‡(!
	`__ã°_™d_˛ór_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1051 
x86_pmu
.
	`dißbÀ
(
evít
);

1057 
	`x86_≥rf_evít_upd©e
(
evít
);

1059 
˝uc
->
evíts
[
idx
] = 
NULL
;

1060 
	}
}

1062 
	$x86_pmu_dißbÀ
(
≥rf_evít
 *
evít
)

1064 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1065 
i
;

1067 
	`x86_pmu_°›
(
evít
);

1069 
i
 = 0; i < 
˝uc
->
n_evíts
; i++) {

1070 i‡(
evít
 =
˝uc
->
evít_li°
[
i
]) {

1072 i‡(
x86_pmu
.
put_evít_c⁄°øöts
)

1073 
x86_pmu
.
	`put_evít_c⁄°øöts
(
˝uc
, 
evít
);

1075 ++
i
 < 
˝uc
->
n_evíts
)

1076 
˝uc
->
evít_li°
[
i
-1] = cpuc->event_list[i];

1078 --
˝uc
->
n_evíts
;

1082 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1083 
	}
}

1085 
	$x86_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1087 
≥rf_ßm∂e_d©a
 
d©a
;

1088 
˝u_hw_evíts
 *
˝uc
;

1089 
≥rf_evít
 *
evít
;

1090 
hw_≥rf_evít
 *
hwc
;

1091 
idx
, 
h™dÀd
 = 0;

1092 
u64
 
vÆ
;

1094 
	`≥rf_ßm∂e_d©a_öô
(&
d©a
, 0);

1096 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1098 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1099 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1102 
evít
 = 
˝uc
->
evíts
[
idx
];

1103 
hwc
 = &
evít
->
hw
;

1105 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
);

1106 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
evít_bôs
 - 1)))

1112 
h™dÀd
 = 1;

1113 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1115 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
))

1118 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1119 
	`x86_pmu_°›
(
evít
);

1122 i‡(
h™dÀd
)

1123 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1125  
h™dÀd
;

1126 
	}
}

1128 
	$smp_≥rf_≥ndög_öãºu±
(
±_ªgs
 *
ªgs
)

1130 
	`úq_íãr
();

1131 
	`ack_APIC_úq
();

1132 
	`öc_úq_°©
(
≠ic_≥ndög_úqs
);

1133 
	`≥rf_evít_do_≥ndög
();

1134 
	`úq_exô
();

1135 
	}
}

1137 
	$£t_≥rf_evít_≥ndög
()

1139 #ifde‡
CONFIG_X86_LOCAL_APIC


1140 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1143 
≠ic
->
	`£nd_IPI_£lf
(
LOCAL_PENDING_VECTOR
);

1145 
	}
}

1147 
	$≥rf_evíts_œpic_öô
()

1149 #ifde‡
CONFIG_X86_LOCAL_APIC


1150 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1156 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1158 
	}
}

1160 
__k¥obes


1161 
	$≥rf_evít_nmi_h™dÀr
(
nŸifõr_block
 *
£lf
,

1162 
cmd
, *
__¨gs
)

1164 
dõ_¨gs
 *
¨gs
 = 
__¨gs
;

1165 
±_ªgs
 *
ªgs
;

1167 i‡(!
	`©omic_ªad
(&
a˘ive_evíts
))

1168  
NOTIFY_DONE
;

1170 
cmd
) {

1171 
DIE_NMI
:

1172 
DIE_NMI_IPI
:

1176  
NOTIFY_DONE
;

1179 
ªgs
 = 
¨gs
->regs;

1181 #ifde‡
CONFIG_X86_LOCAL_APIC


1182 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1191 
x86_pmu
.
	`h™dÀ_úq
(
ªgs
);

1193  
NOTIFY_STOP
;

1194 
	}
}

1196 
__ªad_mo°ly
 
nŸifõr_block
 
	g≥rf_evít_nmi_nŸifõr
 = {

1197 .
nŸifõr_ˇŒ
 = 
≥rf_evít_nmi_h™dÀr
,

1198 .
	g√xt
 = 
NULL
,

1199 .
	g¥i‹ôy
 = 1

1202 
evít_c⁄°øöt
 
	gunc⁄°øöed
;

1203 
evít_c⁄°øöt
 
	gem±yc⁄°øöt
;

1205 
evít_c⁄°øöt
 *

1206 
	$x86_gë_evít_c⁄°øöts
(
˝u_hw_evíts
 *
˝uc
, 
≥rf_evít
 *
evít
)

1208 
evít_c⁄°øöt
 *
c
;

1210 i‡(
x86_pmu
.
evít_c⁄°øöts
) {

1211 
	`f‹_óch_evít_c⁄°øöt
(
c
, 
x86_pmu
.
evít_c⁄°øöts
) {

1212 i‡((
evít
->
hw
.
c⁄fig
 & 
c
->
cmask
Ë=c->
code
)

1213  
c
;

1217  &
unc⁄°øöed
;

1218 
	}
}

1220 
	$x86_evít_sched_ö
(
≥rf_evít
 *
evít
,

1221 
≥rf_˝u_c⁄ãxt
 *
˝u˘x
)

1223 
ªt
 = 0;

1225 
evít
->
°©e
 = 
PERF_EVENT_STATE_ACTIVE
;

1226 
evít
->
⁄˝u
 = 
	`smp_¥o˚ss‹_id
();

1227 
evít
->
t°amp_ru¬ög
 +evít->
˘x
->
time
 -Évít->
t°amp_°›≥d
;

1229 i‡(!
	`is_x86_evít
(
evít
))

1230 
ªt
 = 
evít
->
pmu
->
	`íabÀ
(event);

1232 i‡(!
ªt
 && !
	`is_so·w¨e_evít
(
evít
))

1233 
˝u˘x
->
a˘ive_⁄˝u
++;

1235 i‡(!
ªt
 && 
evít
->
©å
.
ex˛usive
)

1236 
˝u˘x
->
ex˛usive
 = 1;

1238  
ªt
;

1239 
	}
}

1241 
	$x86_evít_sched_out
(
≥rf_evít
 *
evít
,

1242 
≥rf_˝u_c⁄ãxt
 *
˝u˘x
)

1244 
evít
->
°©e
 = 
PERF_EVENT_STATE_INACTIVE
;

1245 
evít
->
⁄˝u
 = -1;

1247 i‡(!
	`is_x86_evít
(
evít
))

1248 
evít
->
pmu
->
	`dißbÀ
(event);

1250 
evít
->
t°amp_ru¬ög
 -evít->
˘x
->
time
 -Évít->
t°amp_°›≥d
;

1252 i‡(!
	`is_so·w¨e_evít
(
evít
))

1253 
˝u˘x
->
a˘ive_⁄˝u
--;

1255 i‡(
evít
->
©å
.
ex˛usive
 || !
˝u˘x
->
a˘ive_⁄˝u
)

1256 
˝u˘x
->
ex˛usive
 = 0;

1257 
	}
}

1268 
	$hw_≥rf_group_sched_ö
(
≥rf_evít
 *
Àadî
,

1269 
≥rf_˝u_c⁄ãxt
 *
˝u˘x
,

1270 
≥rf_evít_c⁄ãxt
 *
˘x
)

1272 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1273 
≥rf_evít
 *
sub
;

1274 
assign
[
X86_PMC_IDX_MAX
];

1275 
n0
, 
n1
, 
ªt
;

1278 
n0
 = 
	`cﬁÀ˘_evíts
(
˝uc
, 
Àadî
, 
åue
);

1279 i‡(
n0
 < 0)

1280  
n0
;

1282 
ªt
 = 
	`x86_scheduÀ_evíts
(
˝uc
, 
n0
, 
assign
);

1283 i‡(
ªt
)

1284  
ªt
;

1286 
ªt
 = 
	`x86_evít_sched_ö
(
Àadî
, 
˝u˘x
);

1287 i‡(
ªt
)

1288  
ªt
;

1290 
n1
 = 1;

1291 
	`li°_f‹_óch_íåy
(
sub
, &
Àadî
->
siblög_li°
, 
group_íåy
) {

1292 i‡(
sub
->
°©e
 > 
PERF_EVENT_STATE_OFF
) {

1293 
ªt
 = 
	`x86_evít_sched_ö
(
sub
, 
˝u˘x
);

1294 i‡(
ªt
)

1295 
undo
;

1296 ++
n1
;

1303 
	`mem˝y
(
˝uc
->
assign
,ássign, 
n0
*());

1305 
˝uc
->
n_evíts
 = 
n0
;

1306 
˝uc
->
n_added
 +
n1
;

1307 
˘x
->
ƒ_a˘ive
 +
n1
;

1317 
undo
:

1318 
	`x86_evít_sched_out
(
Àadî
, 
˝u˘x
);

1319 
n0
 = 1;

1320 
	`li°_f‹_óch_íåy
(
sub
, &
Àadî
->
siblög_li°
, 
group_íåy
) {

1321 i‡(
sub
->
°©e
 =
PERF_EVENT_STATE_ACTIVE
) {

1322 
	`x86_evít_sched_out
(
sub
, 
˝u˘x
);

1323 i‡(++
n0
 =
n1
)

1327  
ªt
;

1328 
	}
}

1330 
	~"≥rf_evít_amd.c
"

1331 
	~"≥rf_evít_p6.c
"

1332 
	~"≥rf_evít_öãl.c
"

1334 
__˝uöô


1335 
	$x86_pmu_nŸifõr
(
nŸifõr_block
 *
£lf
, 
a˘i⁄
, *
h˝u
)

1337 
˝u
 = ()
h˝u
;

1338 
ªt
 = 
NOTIFY_OK
;

1340 
a˘i⁄
 & ~
CPU_TASKS_FROZEN
) {

1341 
CPU_UP_PREPARE
:

1342 i‡(
x86_pmu
.
˝u_¥ï¨e
)

1343 
ªt
 = 
x86_pmu
.
	`˝u_¥ï¨e
(
˝u
);

1346 
CPU_STARTING
:

1347 i‡(
x86_pmu
.
˝u_°¨tög
)

1348 
x86_pmu
.
	`˝u_°¨tög
(
˝u
);

1351 
CPU_DYING
:

1352 i‡(
x86_pmu
.
˝u_dyög
)

1353 
x86_pmu
.
	`˝u_dyög
(
˝u
);

1356 
CPU_UP_CANCELED
:

1357 
CPU_DEAD
:

1358 i‡(
x86_pmu
.
˝u_dód
)

1359 
x86_pmu
.
	`˝u_dód
(
˝u
);

1366  
ªt
;

1367 
	}
}

1369 
__öô
 
	$pmu_check_≠ic
()

1371 i‡(
˝u_has_≠ic
)

1374 
x86_pmu
.
≠ic
 = 0;

1375 
	`¥_öfo
("no APIC, boot withÅhe \"lapic\" bootÖarameterÅo force-enable it.\n");

1376 
	`¥_öfo
("no hardware sampling interruptávailable.\n");

1377 
	}
}

1379 
__öô
 
	$öô_hw_≥rf_evíts
()

1381 
evít_c⁄°øöt
 *
c
;

1382 
îr
;

1384 
	`¥_öfo
("Performance Events: ");

1386 
boŸ_˝u_d©a
.
x86_víd‹
) {

1387 
X86_VENDOR_INTEL
:

1388 
îr
 = 
	`öãl_pmu_öô
();

1390 
X86_VENDOR_AMD
:

1391 
îr
 = 
	`amd_pmu_öô
();

1396 i‡(
îr
 != 0) {

1397 
	`¥_c⁄t
("no PMU driver, softwareÉvents only.\n");

1401 
	`pmu_check_≠ic
();

1403 
	`¥_c⁄t
("%†PMU drivî.\n", 
x86_pmu
.
«me
);

1405 i‡(
x86_pmu
.
num_evíts
 > 
X86_PMC_MAX_GENERIC
) {

1406 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents %d > max(%d), clipping!",

1407 
x86_pmu
.
num_evíts
, 
X86_PMC_MAX_GENERIC
);

1408 
x86_pmu
.
num_evíts
 = 
X86_PMC_MAX_GENERIC
;

1410 
≥rf_evít_mask
 = (1 << 
x86_pmu
.
num_evíts
) - 1;

1411 
≥rf_max_evíts
 = 
x86_pmu
.
num_evíts
;

1413 i‡(
x86_pmu
.
num_evíts_fixed
 > 
X86_PMC_MAX_FIXED
) {

1414 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents fixed %d > max(%d), clipping!",

1415 
x86_pmu
.
num_evíts_fixed
, 
X86_PMC_MAX_FIXED
);

1416 
x86_pmu
.
num_evíts_fixed
 = 
X86_PMC_MAX_FIXED
;

1419 
≥rf_evít_mask
 |=

1420 ((1LL << 
x86_pmu
.
num_evíts_fixed
)-1Ë<< 
X86_PMC_IDX_FIXED
;

1421 
x86_pmu
.
öãl_˘æ
 = 
≥rf_evít_mask
;

1423 
	`≥rf_evíts_œpic_öô
();

1424 
	`ªgi°î_dõ_nŸifõr
(&
≥rf_evít_nmi_nŸifõr
);

1426 
unc⁄°øöed
 = (
evít_c⁄°øöt
)

1427 
	`__EVENT_CONSTRAINT
(0, (1ULL << 
x86_pmu
.
num_evíts
) - 1,

1428 0, 
x86_pmu
.
num_evíts
);

1430 i‡(
x86_pmu
.
evít_c⁄°øöts
) {

1431 
	`f‹_óch_evít_c⁄°øöt
(
c
, 
x86_pmu
.
evít_c⁄°øöts
) {

1432 i‡(
c
->
cmask
 !
INTEL_ARCH_FIXED_MASK
)

1435 
c
->
idxmsk64
 |(1ULL << 
x86_pmu
.
num_evíts
) - 1;

1436 
c
->
weight
 +
x86_pmu
.
num_evíts
;

1440 
	`¥_öfo
("... vîsi⁄: %d\n", 
x86_pmu
.
vîsi⁄
);

1441 
	`¥_öfo
("... bô width: %d\n", 
x86_pmu
.
evít_bôs
);

1442 
	`¥_öfo
("... gíîi¯ªgi°îs: %d\n", 
x86_pmu
.
num_evíts
);

1443 
	`¥_öfo
("... vÆuêmask: %016Lx\n", 
x86_pmu
.
evít_mask
);

1444 
	`¥_öfo
("... maxÖîiod: %016Lx\n", 
x86_pmu
.
max_≥riod
);

1445 
	`¥_öfo
("... fixed-puΩo£Évíts: %d\n", 
x86_pmu
.
num_evíts_fixed
);

1446 
	`¥_öfo
("...Évíàmask: %016Lx\n", 
≥rf_evít_mask
);

1448 
	`≥rf_˝u_nŸifõr
(
x86_pmu_nŸifõr
);

1449 
	}
}

1451 
ölöe
 
	$x86_pmu_ªad
(
≥rf_evít
 *
evít
)

1453 
	`x86_≥rf_evít_upd©e
(
evít
);

1454 
	}
}

1456 c⁄° 
pmu
 
	gpmu
 = {

1457 .
íabÀ
 = 
x86_pmu_íabÀ
,

1458 .
	gdißbÀ
 = 
x86_pmu_dißbÀ
,

1459 .
	g°¨t
 = 
x86_pmu_°¨t
,

1460 .
	g°›
 = 
x86_pmu_°›
,

1461 .
	gªad
 = 
x86_pmu_ªad
,

1462 .
	gu¡hrŸée
 = 
x86_pmu_u¡hrŸée
,

1476 
	$vÆid©e_group
(
≥rf_evít
 *
evít
)

1478 
≥rf_evít
 *
Àadî
 = 
evít
->
group_Àadî
;

1479 
˝u_hw_evíts
 *
Áke_˝uc
;

1480 
ªt
, 
n
;

1482 
ªt
 = -
ENOMEM
;

1483 
Áke_˝uc
 = 
	`kmÆloc
((*Áke_˝uc), 
GFP_KERNEL
 | 
__GFP_ZERO
);

1484 i‡(!
Áke_˝uc
)

1485 
out
;

1493 
ªt
 = -
ENOSPC
;

1494 
n
 = 
	`cﬁÀ˘_evíts
(
Áke_˝uc
, 
Àadî
, 
åue
);

1495 i‡(
n
 < 0)

1496 
out_‰ì
;

1498 
Áke_˝uc
->
n_evíts
 = 
n
;

1499 
n
 = 
	`cﬁÀ˘_evíts
(
Áke_˝uc
, 
evít
, 
Ál£
);

1500 i‡(
n
 < 0)

1501 
out_‰ì
;

1503 
Áke_˝uc
->
n_evíts
 = 
n
;

1505 
ªt
 = 
	`x86_scheduÀ_evíts
(
Áke_˝uc
, 
n
, 
NULL
);

1507 
out_‰ì
:

1508 
	`k‰ì
(
Áke_˝uc
);

1509 
out
:

1510  
ªt
;

1511 
	}
}

1513 c⁄° 
pmu
 *
	$hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

1515 c⁄° 
pmu
 *
tmp
;

1516 
îr
;

1518 
îr
 = 
	`__hw_≥rf_evít_öô
(
evít
);

1519 i‡(!
îr
) {

1525 
tmp
 = 
evít
->
pmu
;

1526 
evít
->
pmu
 = &pmu;

1528 i‡(
evít
->
group_Àadî
 !=Évent)

1529 
îr
 = 
	`vÆid©e_group
(
evít
);

1531 
evít
->
pmu
 = 
tmp
;

1533 i‡(
îr
) {

1534 i‡(
evít
->
de°roy
)

1535 
evít
->
	`de°roy
(event);

1536  
	`ERR_PTR
(
îr
);

1539  &
pmu
;

1540 
	}
}

1546 
ölöe


1547 
	$ˇŒchaö_°‹e
(
≥rf_ˇŒchaö_íåy
 *
íåy
, 
u64
 
ù
)

1549 i‡(
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
)

1550 
íåy
->
ù
[íåy->
ƒ
++] = ip;

1551 
	}
}

1553 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_úq_íåy
);

1554 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_nmi_íåy
);

1558 
	$backåa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

1561 
	}
}

1563 
	$backåa˚_w¨nög
(*
d©a
, *
msg
)

1566 
	}
}

1568 
	$backåa˚_°ack
(*
d©a
, *
«me
)

1571 
	}
}

1573 
	$backåa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

1575 
≥rf_ˇŒchaö_íåy
 *
íåy
 = 
d©a
;

1577 i‡(
ªlübÀ
)

1578 
	`ˇŒchaö_°‹e
(
íåy
, 
addr
);

1579 
	}
}

1581 c⁄° 
°ackåa˚_›s
 
	gbackåa˚_›s
 = {

1582 .
w¨nög
 = 
backåa˚_w¨nög
,

1583 .
	gw¨nög_symbﬁ
 = 
backåa˚_w¨nög_symbﬁ
,

1584 .
	g°ack
 = 
backåa˚_°ack
,

1585 .
	gaddªss
 = 
backåa˚_addªss
,

1586 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack_bp
,

1589 
	~"../dump°ack.h
"

1592 
	$≥rf_ˇŒchaö_kî√l
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1594 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_KERNEL
);

1595 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1597 
	`dump_åa˚
(
NULL
, 
ªgs
, NULL,Ñegs->
bp
, &
backåa˚_›s
, 
íåy
);

1598 
	}
}

1604 
	$c›y_‰om_u£r_nmi
(*
to
, c⁄° 
__u£r
 *
‰om
, 
n
)

1606 
off£t
, 
addr
 = ()
‰om
;

1607 
ty≥
 = 
	`ö_nmi
(Ë? 
KM_NMI
 : 
KM_IRQ0
;

1608 
size
, 
Àn
 = 0;

1609 
∑ge
 *page;

1610 *
m≠
;

1611 
ªt
;

1614 
ªt
 = 
	`__gë_u£r_∑ges_Á°
(
addr
, 1, 0, &
∑ge
);

1615 i‡(!
ªt
)

1618 
off£t
 = 
addr
 & (
PAGE_SIZE
 - 1);

1619 
size
 = 
	`mö
(
PAGE_SIZE
 - 
off£t
, 
n
 - 
Àn
);

1621 
m≠
 = 
	`km≠_©omic
(
∑ge
, 
ty≥
);

1622 
	`mem˝y
(
to
, 
m≠
+
off£t
, 
size
);

1623 
	`kunm≠_©omic
(
m≠
, 
ty≥
);

1624 
	`put_∑ge
(
∑ge
);

1626 
Àn
 +
size
;

1627 
to
 +
size
;

1628 
addr
 +
size
;

1630 } 
Àn
 < 
n
);

1632  
Àn
;

1633 
	}
}

1635 #ifde‡
CONFIG_COMPAT


1636 
ölöe
 

1637 
	$≥rf_ˇŒchaö_u£r32
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1640 
°ack_‰ame_ü32
 
‰ame
;

1641 c⁄° 
__u£r
 *
Â
;

1643 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
))

1646 
Â
 = 
	`com∑t_±r
(
ªgs
->
bp
);

1647 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

1648 
byãs
;

1649 
‰ame
.
√xt_‰ame
 = 0;

1650 
‰ame
.
ªtu∫_addªss
 = 0;

1652 
byãs
 = 
	`c›y_‰om_u£r_nmi
(&
‰ame
, 
Â
, (frame));

1653 i‡(
byãs
 !(
‰ame
))

1656 i‡(
Â
 < 
	`com∑t_±r
(
ªgs
->
•
))

1659 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

1660 
Â
 = 
	`com∑t_±r
(
‰ame
.
√xt_‰ame
);

1663 
	}
}

1665 
ölöe
 

1666 
	$≥rf_ˇŒchaö_u£r32
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1669 
	}
}

1673 
	$≥rf_ˇŒchaö_u£r
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1675 
°ack_‰ame
 
‰ame
;

1676 c⁄° 
__u£r
 *
Â
;

1678 i‡(!
	`u£r_mode
(
ªgs
))

1679 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

1681 
Â
 = (
__u£r
 *)
ªgs
->
bp
;

1683 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_USER
);

1684 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1686 i‡(
	`≥rf_ˇŒchaö_u£r32
(
ªgs
, 
íåy
))

1689 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

1690 
byãs
;

1691 
‰ame
.
√xt_‰ame
 = 
NULL
;

1692 
‰ame
.
ªtu∫_addªss
 = 0;

1694 
byãs
 = 
	`c›y_‰om_u£r_nmi
(&
‰ame
, 
Â
, (frame));

1695 i‡(
byãs
 !(
‰ame
))

1698 i‡(()
Â
 < 
ªgs
->
•
)

1701 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

1702 
Â
 = 
‰ame
.
√xt_‰ame
;

1704 
	}
}

1707 
	$≥rf_do_ˇŒchaö
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1709 
is_u£r
;

1711 i‡(!
ªgs
)

1714 
is_u£r
 = 
	`u£r_mode
(
ªgs
);

1716 i‡(
is_u£r
 && 
cuºít
->
°©e
 !
TASK_RUNNING
)

1719 i‡(!
is_u£r
)

1720 
	`≥rf_ˇŒchaö_kî√l
(
ªgs
, 
íåy
);

1722 i‡(
cuºít
->
mm
)

1723 
	`≥rf_ˇŒchaö_u£r
(
ªgs
, 
íåy
);

1724 
	}
}

1726 
≥rf_ˇŒchaö_íåy
 *
	$≥rf_ˇŒchaö
(
±_ªgs
 *
ªgs
)

1728 
≥rf_ˇŒchaö_íåy
 *
íåy
;

1730 i‡(
	`ö_nmi
())

1731 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_nmi_íåy
);

1733 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_úq_íåy
);

1735 
íåy
->
ƒ
 = 0;

1737 
	`≥rf_do_ˇŒchaö
(
ªgs
, 
íåy
);

1739  
íåy
;

1740 
	}
}

1742 
	$≥rf_¨ch_„tch_ˇŒî_ªgs
(
±_ªgs
 *
ªgs
, 
ù
, 
skù
)

1744 
ªgs
->
ù
 = ip;

1749 
ªgs
->
bp
 = 
	`ªwöd_‰ame_poöãr
(
skù
 + 1);

1750 
ªgs
->
cs
 = 
__KERNEL_CS
;

1751 
	`loˇl_ßve_Êags
(
ªgs
->
Êags
);

1752 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/bô›s.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/nmi.h
>

20 
	~<löux/k¥obes.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/≥rf_evít.h
>

25 
	snmi_w©chdog_˘lblk
 {

26 
	mcc¸_m§
;

27 
	m≥rf˘r_m§
;

28 
	mev¡£l_m§
;

32 
	swd_›s
 {

33 (*
	mª£rve
)();

34 (*
	muƒe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	mª¨m
)(
nmi_w©chdog_˘lblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m°›
)();

38 
	m≥rf˘r
;

39 
	mev¡£l
;

40 
u64
 
	mcheckbô
;

43 c⁄° 
wd_›s
 *
	gwd_›s
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
≥rf˘r_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
ev¡£l_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_˘lblk
,Çmi_watchdog_ctlblk);

66 
ölöe
 
	$nmi_≥rf˘r_m§_to_bô
(
m§
)

69 
boŸ_˝u_d©a
.
x86_víd‹
) {

70 
X86_VENDOR_AMD
:

71  
m§
 - 
MSR_K7_PERFCTR0
;

72 
X86_VENDOR_INTEL
:

73 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  
m§
 - 
MSR_ARCH_PERFMON_PERFCTR0
;

76 
boŸ_˝u_d©a
.
x86
) {

78  
m§
 - 
MSR_P6_PERFCTR0
;

80  
m§
 - 
MSR_P4_BPU_PERFCTR0
;

84 
	}
}

90 
ölöe
 
	$nmi_ev¡£l_m§_to_bô
(
m§
)

93 
boŸ_˝u_d©a
.
x86_víd‹
) {

94 
X86_VENDOR_AMD
:

95  
m§
 - 
MSR_K7_EVNTSEL0
;

96 
X86_VENDOR_INTEL
:

97 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  
m§
 - 
MSR_ARCH_PERFMON_EVENTSEL0
;

100 
boŸ_˝u_d©a
.
x86
) {

102  
m§
 - 
MSR_P6_EVNTSEL0
;

104  
m§
 - 
MSR_P4_BSU_ESCR0
;

109 
	}
}

112 
	$avaû_to_ª§v_≥rf˘r_nmi_bô
(
cou¡î
)

114 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

116  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

117 
	}
}

118 
EXPORT_SYMBOL
(
avaû_to_ª§v_≥rf˘r_nmi_bô
);

120 
	$ª£rve_≥rf˘r_nmi
(
m§
)

122 
cou¡î
;

124 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

126 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

129 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
))

132 
	}
}

133 
EXPORT_SYMBOL
(
ª£rve_≥rf˘r_nmi
);

135 
	$ªÀa£_≥rf˘r_nmi
(
m§
)

137 
cou¡î
;

139 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

141 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

144 
	`˛ór_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

145 
	}
}

146 
EXPORT_SYMBOL
(
ªÀa£_≥rf˘r_nmi
);

148 
	$ª£rve_ev¡£l_nmi
(
m§
)

150 
cou¡î
;

152 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

154 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

157 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
))

160 
	}
}

161 
EXPORT_SYMBOL
(
ª£rve_ev¡£l_nmi
);

163 
	$ªÀa£_ev¡£l_nmi
(
m§
)

165 
cou¡î
;

167 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

169 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

172 
	`˛ór_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
);

173 
	}
}

174 
EXPORT_SYMBOL
(
ªÀa£_ev¡£l_nmi
);

176 
	$dißbÀ_œpic_nmi_w©chdog
()

178 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

180 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

183 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

185 i‡(
wd_›s
)

186 
wd_›s
->
	`uƒe£rve
();

188 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

189 
	}
}

191 
	$íabÀ_œpic_nmi_w©chdog
()

193 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

196 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) != 0)

200 i‡(!
wd_›s
)

202 i‡(!
wd_›s
->
	`ª£rve
()) {

203 
	`¥ötk
(
KERN_ERR
 "NMI watchdog: cannotÑeserveÖerfctrs\n");

207 
	`⁄_óch_˝u
(
£tup_≠ic_nmi_w©chdog
, 
NULL
, 1);

208 
	`touch_nmi_w©chdog
();

209 
	}
}

215 
	$adju°_f‹_32bô_˘r
(
hz
)

217 
u64
 
cou¡î_vÆ
;

218 
ªtvÆ
 = 
hz
;

227 
cou¡î_vÆ
 = (
u64
)
˝u_khz
 * 1000;

228 
	`do_div
(
cou¡î_vÆ
, 
ªtvÆ
);

229 i‡(
cou¡î_vÆ
 > 0x7fffffffULL) {

230 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

231 
	`do_div
(
cou¡
, 0x7fffffffUL);

232 
ªtvÆ
 = 
cou¡
 + 1;

234  
ªtvÆ
;

235 
	}
}

237 
	$wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
,

238 c⁄° *
des¸
, 
nmi_hz
)

240 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

242 
	`do_div
(
cou¡
, 
nmi_hz
);

243 i‡(
des¸
)

244 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

245 
	`wrm§l
(
≥rf˘r_m§
, 0 - 
cou¡
);

246 
	}
}

248 
	$wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
,

249 c⁄° *
des¸
, 
nmi_hz
)

251 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

253 
	`do_div
(
cou¡
, 
nmi_hz
);

254 i‡(
des¸
)

255 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

256 
	`wrm§
(
≥rf˘r_m§
, (
u32
)(-
cou¡
), 0);

257 
	}
}

263 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

264 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

265 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

266 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

267 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

268 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

270 
	$£tup_k7_w©chdog
(
nmi_hz
)

272 
≥rf˘r_m§
, 
ev¡£l_m§
;

273 
ev¡£l
;

274 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

276 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

277 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

279 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

281 
ev¡£l
 = 
K7_EVNTSEL_INT


282 | 
K7_EVNTSEL_OS


283 | 
K7_EVNTSEL_USR


284 | 
K7_NMI_EVENT
;

287 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

288 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "K7_PERFCTR0", 
nmi_hz
);

291 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

292 
wd
->
ev¡£l_m§
 =Évntsel_msr;

293 
wd
->
cc¸_m§
 = 0;

296 
	`˝u_nmi_£t_wd_íabÀd
();

298 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

299 
ev¡£l
 |
K7_EVNTSEL_ENABLE
;

300 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

303 
	}
}

305 
	$sögÀ_m§_°›_w©chdog
()

307 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

309 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

310 
	}
}

312 
	$sögÀ_m§_ª£rve
()

314 i‡(!
	`ª£rve_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
))

317 i‡(!
	`ª£rve_ev¡£l_nmi
(
wd_›s
->
ev¡£l
)) {

318 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

322 
	}
}

324 
	$sögÀ_m§_uƒe£rve
()

326 
	`ªÀa£_ev¡£l_nmi
(
wd_›s
->
ev¡£l
);

327 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

328 
	}
}

330 
__k¥obes


331 
	$sögÀ_m§_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

334 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

335 
	}
}

337 c⁄° 
wd_›s
 
	gk7_wd_›s
 = {

338 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

339 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

340 .
	g£tup
 = 
£tup_k7_w©chdog
,

341 .
	gª¨m
 = 
sögÀ_m§_ª¨m
,

342 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

343 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

344 .
	gev¡£l
 = 
MSR_K7_EVNTSEL0
,

345 .
	gcheckbô
 = 1ULL << 47,

351 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

352 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

353 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

354 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

355 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

356 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

358 
	$£tup_p6_w©chdog
(
nmi_hz
)

360 
≥rf˘r_m§
, 
ev¡£l_m§
;

361 
ev¡£l
;

362 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

364 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

365 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

368 i‡(
	`wrm§_ß„
(
≥rf˘r_m§
, 0, 0) < 0)

371 
ev¡£l
 = 
P6_EVNTSEL_INT


372 | 
P6_EVNTSEL_OS


373 | 
P6_EVNTSEL_USR


374 | 
P6_NMI_EVENT
;

377 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

378 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

379 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "P6_PERFCTR0", 
nmi_hz
);

382 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

383 
wd
->
ev¡£l_m§
 =Évntsel_msr;

384 
wd
->
cc¸_m§
 = 0;

387 
	`˝u_nmi_£t_wd_íabÀd
();

389 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

390 
ev¡£l
 |
P6_EVNTSEL0_ENABLE
;

391 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

394 
	}
}

396 
__k¥obes
 
	$p6_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

404 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

407 
	`wrôe_w©chdog_cou¡î32
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

408 
	}
}

410 c⁄° 
wd_›s
 
	gp6_wd_›s
 = {

411 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

412 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

413 .
	g£tup
 = 
£tup_p6_w©chdog
,

414 .
	gª¨m
 = 
p6_ª¨m
,

415 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

416 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

417 .
	gev¡£l
 = 
MSR_P6_EVNTSEL0
,

418 .
	gcheckbô
 = 1ULL << 39,

425 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

426 
	#P4_ESCR_EVENT_SELECT
(
N
Ë((NË<< 25)

	)

427 
	#P4_ESCR_OS
 (1 << 3)

	)

428 
	#P4_ESCR_USR
 (1 << 2)

	)

429 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

430 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

431 
	#P4_CCCR_THRESHOLD
(
N
Ë((NË<< 20)

	)

432 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

433 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

434 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

435 
	#P4_CCCR_ESCR_SELECT
(
N
Ë((NË<< 13)

	)

436 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

437 
	#P4_CCCR_OVF
 (1 << 31)

	)

439 
	#P4_CONTROLS
 18

	)

440 
	gp4_c⁄åﬁs
[18] = {

441 
MSR_P4_BPU_CCCR0
,

442 
MSR_P4_BPU_CCCR1
,

443 
MSR_P4_BPU_CCCR2
,

444 
MSR_P4_BPU_CCCR3
,

445 
MSR_P4_MS_CCCR0
,

446 
MSR_P4_MS_CCCR1
,

447 
MSR_P4_MS_CCCR2
,

448 
MSR_P4_MS_CCCR3
,

449 
MSR_P4_FLAME_CCCR0
,

450 
MSR_P4_FLAME_CCCR1
,

451 
MSR_P4_FLAME_CCCR2
,

452 
MSR_P4_FLAME_CCCR3
,

453 
MSR_P4_IQ_CCCR0
,

454 
MSR_P4_IQ_CCCR1
,

455 
MSR_P4_IQ_CCCR2
,

456 
MSR_P4_IQ_CCCR3
,

457 
MSR_P4_IQ_CCCR4
,

458 
MSR_P4_IQ_CCCR5
,

465 
	$£tup_p4_w©chdog
(
nmi_hz
)

467 
≥rf˘r_m§
, 
ev¡£l_m§
, 
cc¸_m§
;

468 
ev¡£l
, 
cc¸_vÆ
;

469 
misc_íabÀ
, 
dummy
;

470 
ht_num
;

471 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

473 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
, 
dummy
);

474 i‡(!(
misc_íabÀ
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

477 #ifde‡
CONFIG_SMP


479 i‡(
smp_num_siblögs
 == 2) {

480 
ebx
, 
≠icid
;

482 
ebx
 = 
	`˝uid_ebx
(1);

483 
≠icid
 = (
ebx
 >> 24) & 0xff;

484 
ht_num
 = 
≠icid
 & 1;

487 
ht_num
 = 0;

495 i‡(!
ht_num
) {

497 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR0
;

498 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

499 
cc¸_m§
 = 
MSR_P4_IQ_CCCR0
;

500 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

511 i‡(
ª£t_devi˚s
) {

512 
low
, 
high
;

513 
i
;

515 
i
 = 0; i < 
P4_CONTROLS
; i++) {

516 
	`rdm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

517 
low
 &~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

518 
	`wrm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

523 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR1
;

524 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

525 
cc¸_m§
 = 
MSR_P4_IQ_CCCR1
;

528 i‡(
boŸ_˝u_d©a
.
x86_modñ
 =4 && boŸ_˝u_d©a.
x86_mask
 == 4)

529 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
;

531 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI1
;

532 
cc¸_vÆ
 |
	`P4_CCCR_ESCR_SELECT
(4);

535 
ev¡£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

536 | 
P4_ESCR_OS


537 | 
P4_ESCR_USR
;

539 
cc¸_vÆ
 |
	`P4_CCCR_THRESHOLD
(15)

540 | 
P4_CCCR_COMPLEMENT


541 | 
P4_CCCR_COMPARE


542 | 
P4_CCCR_REQUIRED
;

544 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

545 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

546 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "P4_IQ_COUNTER0", 
nmi_hz
);

548 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

549 
wd
->
ev¡£l_m§
 =Évntsel_msr;

550 
wd
->
cc¸_m§
 = cccr_msr;

553 
	`˝u_nmi_£t_wd_íabÀd
();

555 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

556 
cc¸_vÆ
 |
P4_CCCR_ENABLE
;

557 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

559 
	}
}

561 
	$°›_p4_w©chdog
()

563 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

564 
	`wrm§
(
wd
->
cc¸_m§
, 0, 0);

565 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

566 
	}
}

568 
	$p4_ª£rve
()

570 i‡(!
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
))

572 #ifde‡
CONFIG_SMP


573 i‡(
smp_num_siblögs
 > 1 && !
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
))

574 
Áû1
;

576 i‡(!
	`ª£rve_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
))

577 
Áû2
;

580 
Áû2
:

581 #ifde‡
CONFIG_SMP


582 i‡(
smp_num_siblögs
 > 1)

583 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

584 
Áû1
:

586 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

588 
	}
}

590 
	$p4_uƒe£rve
()

592 #ifde‡
CONFIG_SMP


593 i‡(
smp_num_siblögs
 > 1)

594 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

596 
	`ªÀa£_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
);

597 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

598 
	}
}

600 
__k¥obes
 
	$p4_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

602 
dummy
;

610 
	`rdm§l
(
wd
->
cc¸_m§
, 
dummy
);

611 
dummy
 &~
P4_CCCR_OVF
;

612 
	`wrm§l
(
wd
->
cc¸_m§
, 
dummy
);

613 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

615 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

616 
	}
}

618 c⁄° 
wd_›s
 
	gp4_wd_›s
 = {

619 .
ª£rve
 = 
p4_ª£rve
,

620 .
	guƒe£rve
 = 
p4_uƒe£rve
,

621 .
	g£tup
 = 
£tup_p4_w©chdog
,

622 .
	gª¨m
 = 
p4_ª¨m
,

623 .
	g°›
 = 
°›_p4_w©chdog
,

625 .
	g≥rf˘r
 = 
MSR_P4_BPU_PERFCTR0
,

626 .
	gev¡£l
 = 
MSR_P4_BSU_ESCR0
,

627 .
	gcheckbô
 = 1ULL << 39,

634 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

635 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

637 
wd_›s
 
	göãl_¨ch_wd_›s
;

639 
	$£tup_öãl_¨ch_w©chdog
(
nmi_hz
)

641 
ebx
;

642 
˝uid10_óx
 
óx
;

643 
unu£d
;

644 
≥rf˘r_m§
, 
ev¡£l_m§
;

645 
ev¡£l
;

646 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

653 
	`˝uid
(10, &(
óx
.
fuŒ
), &
ebx
, &
unu£d
, &unused);

654 i‡((
óx
.
•lô
.
mask_Àngth
 <

655 (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

656 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

659 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

660 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

662 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

664 
ev¡£l
 = 
ARCH_PERFMON_EVENTSEL_INT


665 | 
ARCH_PERFMON_EVENTSEL_OS


666 | 
ARCH_PERFMON_EVENTSEL_USR


667 | 
ARCH_PERFMON_NMI_EVENT_SEL


668 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

671 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

672 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

673 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

675 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

676 
wd
->
ev¡£l_m§
 =Évntsel_msr;

677 
wd
->
cc¸_m§
 = 0;

680 
	`˝u_nmi_£t_wd_íabÀd
();

682 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

683 
ev¡£l
 |
ARCH_PERFMON_EVENTSEL_ENABLE
;

684 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

685 
öãl_¨ch_wd_›s
.
checkbô
 = 1ULL << (
óx
.
•lô
.
bô_width
 - 1);

687 
	}
}

689 
wd_›s
 
öãl_¨ch_wd_›s
 
	g__ªad_mo°ly
 = {

690 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

691 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

692 .
	g£tup
 = 
£tup_öãl_¨ch_w©chdog
,

693 .
	gª¨m
 = 
p6_ª¨m
,

694 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

695 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

696 .
	gev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

699 
	$¥obe_nmi_w©chdog
()

701 
boŸ_˝u_d©a
.
x86_víd‹
) {

702 
X86_VENDOR_AMD
:

703 i‡(
boŸ_˝u_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

704 
boŸ_˝u_d©a
.
x86
 != 16 && boot_cpu_data.x86 != 17)

706 
wd_›s
 = &
k7_wd_›s
;

708 
X86_VENDOR_INTEL
:

715 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 14) ||

716 ((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 15 &&

717 
boŸ_˝u_d©a
.
x86_mask
 == 4))) {

718 
öãl_¨ch_wd_›s
.
≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

719 
öãl_¨ch_wd_›s
.
ev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

721 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

722 
wd_›s
 = &
öãl_¨ch_wd_›s
;

725 
boŸ_˝u_d©a
.
x86
) {

727 i‡(
boŸ_˝u_d©a
.
x86_modñ
 > 13)

730 
wd_›s
 = &
p6_wd_›s
;

733 
wd_›s
 = &
p4_wd_›s
;

740 
	}
}

744 
	$œpic_w©chdog_öô
(
nmi_hz
)

746 i‡(!
wd_›s
) {

747 
	`¥obe_nmi_w©chdog
();

748 i‡(!
wd_›s
) {

749 
	`¥ötk
(
KERN_INFO
 "NMI watchdog: CPUÇot supported\n");

753 i‡(!
wd_›s
->
	`ª£rve
()) {

754 
	`¥ötk
(
KERN_ERR


760 i‡(!(
wd_›s
->
	`£tup
(
nmi_hz
))) {

761 
	`¥ötk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

762 
	`øw_smp_¥o˚ss‹_id
());

767 
	}
}

769 
	$œpic_w©chdog_°›
()

771 i‡(
wd_›s
)

772 
wd_›s
->
	`°›
();

773 
	}
}

775 
	$œpic_adju°_nmi_hz
(
hz
)

777 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

778 i‡(
wd
->
≥rf˘r_m§
 =
MSR_P6_PERFCTR0
 ||

779 
wd
->
≥rf˘r_m§
 =
MSR_ARCH_PERFMON_PERFCTR1
)

780 
hz
 = 
	`adju°_f‹_32bô_˘r
(hz);

781  
hz
;

782 
	}
}

784 
__k¥obes
 
	$œpic_wd_evít
(
nmi_hz
)

786 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

787 
u64
 
˘r
;

789 
	`rdm§l
(
wd
->
≥rf˘r_m§
, 
˘r
);

790 i‡(
˘r
 & 
wd_›s
->
checkbô
)

793 
wd_›s
->
	`ª¨m
(
wd
, 
nmi_hz
);

795 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/˝u„©uª.h
>

9 c⁄° *c⁄° 
	gx86_powî_Êags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<löux/smp.h
>

2 
	~<löux/timex.h
>

3 
	~<löux/°rög.h
>

4 
	~<löux/£q_fûe.h
>

5 
	~<löux/˝u‰eq.h
>

10 
	$show_˝uöfo_c‹e
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
,

11 
˝u
)

13 #ifde‡
CONFIG_SMP


14 i‡(
c
->
x86_max_c‹es
 * 
smp_num_siblögs
 > 1) {

15 
	`£q_¥ötf
(
m
, "physiˇ»id\t: %d\n", 
c
->
phys_¥oc_id
);

16 
	`£q_¥ötf
(
m
, "siblings\t: %d\n",

17 
	`˝umask_weight
(
	`˝u_c‹e_mask
(
˝u
)));

18 
	`£q_¥ötf
(
m
, "c‹êid\t\t: %d\n", 
c
->
˝u_c‹e_id
);

19 
	`£q_¥ötf
(
m
, "˝u c‹es\t: %d\n", 
c
->
boŸed_c‹es
);

20 
	`£q_¥ötf
(
m
, "≠icid\t\t: %d\n", 
c
->
≠icid
);

21 
	`£q_¥ötf
(
m
, "öôü»≠icid\t: %d\n", 
c
->
öôül_≠icid
);

24 
	}
}

26 #ifde‡
CONFIG_X86_32


27 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

33 
Âu_ex˚±i⁄
 = 
c
->
h¨d_m©h
 && (
ign‹e_Âu_úq
 || 
˝u_has_Âu
);

34 
	`£q_¥ötf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
h…_w‹ks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¨d_m©h
 ? "yes" : "no",

48 
Âu_ex˚±i⁄
 ? "yes" : "no",

49 
c
->
˝uid_Àvñ
,

50 
c
->
wp_w‹ks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

55 
	`£q_¥ötf
(
m
,

60 
c
->
˝uid_Àvñ
);

61 
	}
}

64 
	$show_˝uöfo
(
£q_fûe
 *
m
, *
v
)

66 
˝uöfo_x86
 *
c
 = 
v
;

67 
˝u
 = 0;

68 
i
;

70 #ifde‡
CONFIG_SMP


71 
˝u
 = 
c
->
˝u_ödex
;

73 
	`£q_¥ötf
(
m
, "processor\t: %u\n"

78 
˝u
,

79 
c
->
x86_víd‹_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_modñ
,

82 
c
->
x86_modñ_id
[0] ? c->x86_model_id : "unknown");

84 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

85 
	`£q_¥ötf
(
m
, "°ïpög\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_¥ötf
(
m
, "stepping\t: unknown\n");

89 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
‰eq
 = 
	`˝u‰eq_quick_gë
(
˝u
);

92 i‡(!
‰eq
)

93 
‰eq
 = 
˝u_khz
;

94 
	`£q_¥ötf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
‰eq
 / 1000, (freq % 1000));

99 i‡(
c
->
x86_ˇche_size
 >= 0)

100 
	`£q_¥ötf
(
m
, "ˇchêsize\t: %d KB\n", 
c
->
x86_ˇche_size
);

102 
	`show_˝uöfo_c‹e
(
m
, 
c
, 
˝u
);

103 
	`show_˝uöfo_misc
(
m
, 
c
);

105 
	`£q_¥ötf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 i‡(
	`˝u_has
(
c
, 
i
Ë&& 
x86_ˇp_Êags
[i] !
NULL
)

108 
	`£q_¥ötf
(
m
, " %s", 
x86_ˇp_Êags
[
i
]);

110 
	`£q_¥ötf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
lo›s_≥r_jiffy
/(500000/
HZ
),

112 (
c
->
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100);

114 #ifde‡
CONFIG_X86_64


115 i‡(
c
->
x86_ébsize
 > 0)

116 
	`£q_¥ötf
(
m
, "TLB size\t: %d 4KÖages\n", 
c
->
x86_ébsize
);

118 
	`£q_¥ötf
(
m
, "˛Êush size\t: %u\n", 
c
->
x86_˛Êush_size
);

119 
	`£q_¥ötf
(
m
, "ˇche_Æignmít\t: %d\n", 
c
->
x86_ˇche_Æignmít
);

120 
	`£q_¥ötf
(
m
, "address sizes\t: %u bitsÖhysical, %u bits virtual\n",

121 
c
->
x86_phys_bôs
, c->
x86_vút_bôs
);

123 
	`£q_¥ötf
(
m
, "power management:");

124 
i
 = 0; i < 32; i++) {

125 i‡(
c
->
x86_powî
 & (1 << 
i
)) {

126 i‡(
i
 < 
	`ARRAY_SIZE
(
x86_powî_Êags
) &&

127 
x86_powî_Êags
[
i
])

128 
	`£q_¥ötf
(
m
, "%s%s",

129 
x86_powî_Êags
[
i
][0] ? " " : "",

130 
x86_powî_Êags
[
i
]);

132 
	`£q_¥ötf
(
m
, " [%d]", 
i
);

136 
	`£q_¥ötf
(
m
, "\n\n");

139 
	}
}

141 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

143 i‡(*
pos
 == 0)

144 *
pos
 = 
	`˝umask_fú°
(
˝u_⁄löe_mask
);

146 *
pos
 = 
	`˝umask_√xt
(*po†- 1, 
˝u_⁄löe_mask
);

147 i‡((*
pos
Ë< 
ƒ_˝u_ids
)

148  &
	`˝u_d©a
(*
pos
);

149  
NULL
;

150 
	}
}

152 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

154 (*
pos
)++;

155  
	`c_°¨t
(
m
, 
pos
);

156 
	}
}

158 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

160 
	}
}

162 c⁄° 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

163 .
°¨t
 = 
c_°¨t
,

164 .
	g√xt
 = 
c_√xt
,

165 .
	g°›
 = 
c_°›
,

166 .
	gshow
 = 
show_˝uöfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/sched.c

1 
	~<löux/sched.h
>

2 
	~<löux/m©h64.h
>

3 
	~<löux/≥r˝u.h
>

4 
	~<löux/úqÊags.h
>

6 
	~<asm/˝u„©uª.h
>

7 
	~<asm/¥o˚ss‹.h
>

9 #ifde‡
CONFIG_SMP


11 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ﬁd_≥rf_sched
);

13 
	$sˇÀ_≠îfm≥rf
()

15 
≠îfm≥rf
 
vÆ
, *
ﬁd
 = &
	`__gë_˝u_v¨
(
ﬁd_≥rf_sched
);

16 
øtio
, 
Êags
;

18 
	`loˇl_úq_ßve
(
Êags
);

19 
	`gë_≠îfm≥rf
(&
vÆ
);

20 
	`loˇl_úq_ª°‹e
(
Êags
);

22 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(
ﬁd
, &
vÆ
);

23 *
ﬁd
 = 
vÆ
;

25  
øtio
;

26 
	}
}

28 
	$¨ch_sˇÀ_‰eq_powî
(
sched_domaö
 *
sd
, 
˝u
)

34 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

35  
	`sˇÀ_≠îfm≥rf
();

41  
	`deÁu…_sˇÀ_‰eq_powî
(
sd
, 
˝u
);

42 
	}
}

44 
	$¨ch_sˇÀ_smt_powî
(
sched_domaö
 *
sd
, 
˝u
)

49 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

50  
SCHED_LOAD_SCALE
;

52  
	`deÁu…_sˇÀ_smt_powî
(
sd
, 
˝u
);

53 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<löux/dmi.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<asm/div64.h
>

27 
	~<asm/vmw¨e.h
>

28 
	~<asm/x86_öô.h
>

30 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

31 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

32 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

34 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

35 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

37 
	#VMWARE_PORT
(
cmd
, 
óx
, 
ebx
, 
ecx
, 
edx
) \

38 
	`__asm__
("inl (%%dx)" : \

39 "˜"(
óx
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

40 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

41 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

42 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

43 "mem‹y");

	)

45 
ölöe
 
	$__vmw¨e_∂©f‹m
()

47 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

48 
	`VMWARE_PORT
(
GETVERSION
, 
óx
, 
ebx
, 
ecx
, 
edx
);

49  
óx
 !(
uöt32_t
)-1 && 
ebx
 =
VMWARE_HYPERVISOR_MAGIC
;

50 
	}
}

52 
	$vmw¨e_gë_tsc_khz
()

54 
uöt64_t
 
tsc_hz
;

55 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

57 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

59 
tsc_hz
 = 
óx
 | (((
uöt64_t
)
ebx
) << 32);

60 
	`do_div
(
tsc_hz
, 1000);

61 
	`BUG_ON
(
tsc_hz
 >> 32);

62 
	`¥ötk
(
KERN_INFO
 "TSC freqÑead from hypervisor : %lu.%03lu MHz\n",

63 (Ë
tsc_hz
 / 1000,

64 (Ë
tsc_hz
 % 1000);

65  
tsc_hz
;

66 
	}
}

68 
__öô
 
	$vmw¨e_∂©f‹m_£tup
()

70 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

72 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

74 i‡(
ebx
 !
UINT_MAX
)

75 
x86_∂©f‹m
.
ˇlibøã_tsc
 = 
vmw¨e_gë_tsc_khz
;

77 
	`¥ötk
(
KERN_WARNING


79 
	}
}

86 
	$vmw¨e_∂©f‹m
()

88 i‡(
˝u_has_hy≥rvis‹
) {

89 
óx
, 
ebx
, 
ecx
, 
edx
;

90 
hy≥r_víd‹_id
[13];

92 
	`˝uid
(
CPUID_VMWARE_INFO_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

93 
	`mem˝y
(
hy≥r_víd‹_id
 + 0, &
ebx
, 4);

94 
	`mem˝y
(
hy≥r_víd‹_id
 + 4, &
ecx
, 4);

95 
	`mem˝y
(
hy≥r_víd‹_id
 + 8, &
edx
, 4);

96 
hy≥r_víd‹_id
[12] = '\0';

97 i‡(!
	`°rcmp
(
hy≥r_víd‹_id
, "VMwareVMware"))

99 } i‡(
dmi_avaûabÀ
 && 
	`dmi_«me_ö_£rül
("VMware") &&

100 
	`__vmw¨e_∂©f‹m
())

104 
	}
}

105 
EXPORT_SYMBOL
(
vmw¨e_∂©f‹m
);

119 
__˝uöô
 
	$vmw¨e_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

121 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

122 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<löux/moduÀ.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/î∫o.h
>

32 
	~<löux/f˙é.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/smp_lock.h
>

37 
	~<löux/maj‹.h
>

38 
	~<löux/fs.h
>

39 
	~<löux/devi˚.h
>

40 
	~<löux/˝u.h
>

41 
	~<löux/nŸifõr.h
>

42 
	~<löux/uac˚ss.h
>

43 
	~<löux/gÂ.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/m§.h
>

47 
	~<asm/sy°em.h
>

49 
˛ass
 *
	g˝uid_˛ass
;

51 
	s˝uid_ªgs
 {

52 
u32
 
	móx
, 
	mebx
, 
	mecx
, 
	medx
;

55 
	$˝uid_smp_˝uid
(*
cmd_block
)

57 
˝uid_ªgs
 *
cmd
 = (˝uid_ªg†*)
cmd_block
;

59 
	`˝uid_cou¡
(
cmd
->
óx
, cmd->
ecx
,

60 &
cmd
->
óx
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

61 
	}
}

63 
loff_t
 
	$˝uid_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

65 
loff_t
 
ªt
;

66 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

68 
	`muãx_lock
(&
öode
->
i_muãx
);

69 
‹ig
) {

71 
fûe
->
f_pos
 = 
off£t
;

72 
ªt
 = 
fûe
->
f_pos
;

75 
fûe
->
f_pos
 +
off£t
;

76 
ªt
 = 
fûe
->
f_pos
;

79 
ªt
 = -
EINVAL
;

81 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

82  
ªt
;

83 
	}
}

85 
ssize_t
 
	$˝uid_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

86 
size_t
 
cou¡
, 
loff_t
 *
µos
)

88 
__u£r
 *
tmp
 = 
buf
;

89 
˝uid_ªgs
 
cmd
;

90 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

91 
u64
 
pos
 = *
µos
;

92 
ssize_t
 
byãs
 = 0;

93 
îr
 = 0;

95 i‡(
cou¡
 % 16)

96  -
EINVAL
;

98 ; 
cou¡
; count -= 16) {

99 
cmd
.
óx
 = 
pos
;

100 
cmd
.
ecx
 = 
pos
 >> 32;

101 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝uid_smp_˝uid
, &
cmd
, 1);

102 i‡(
îr
)

104 i‡(
	`c›y_to_u£r
(
tmp
, &
cmd
, 16)) {

105 
îr
 = -
EFAULT
;

108 
tmp
 += 16;

109 
byãs
 += 16;

110 *
µos
 = ++
pos
;

113  
byãs
 ? byã†: 
îr
;

114 
	}
}

116 
	$˝uid_›í
(
öode
 *öode, 
fûe
 *file)

118 
˝u
;

119 
˝uöfo_x86
 *
c
;

121 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

122 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

123  -
ENXIO
;

125 
c
 = &
	`˝u_d©a
(
˝u
);

126 i‡(
c
->
˝uid_Àvñ
 < 0)

127  -
EIO
;

130 
	}
}

135 c⁄° 
fûe_›î©i⁄s
 
	g˝uid_f›s
 = {

136 .
ow√r
 = 
THIS_MODULE
,

137 .
	gŒ£ek
 = 
˝uid_£ek
,

138 .
	gªad
 = 
˝uid_ªad
,

139 .
	g›í
 = 
˝uid_›í
,

142 
__˝uöô
 
	$˝uid_devi˚_¸óã
(
˝u
)

144 
devi˚
 *
dev
;

146 
dev
 = 
	`devi˚_¸óã
(
˝uid_˛ass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
), NULL,

147 "˝u%d", 
˝u
);

148  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

149 
	}
}

151 
	$˝uid_devi˚_de°roy
(
˝u
)

153 
	`devi˚_de°roy
(
˝uid_˛ass
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
));

154 
	}
}

156 
__˝uöô
 
	$˝uid_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

157 
a˘i⁄
,

158 *
h˝u
)

160 
˝u
 = ()
h˝u
;

161 
îr
 = 0;

163 
a˘i⁄
) {

164 
CPU_UP_PREPARE
:

165 
îr
 = 
	`˝uid_devi˚_¸óã
(
˝u
);

167 
CPU_UP_CANCELED
:

168 
CPU_UP_CANCELED_FROZEN
:

169 
CPU_DEAD
:

170 
	`˝uid_devi˚_de°roy
(
˝u
);

173  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

174 
	}
}

176 
nŸifõr_block
 
__ªfd©a
 
	g˝uid_˛ass_˝u_nŸifõr
 =

178 .
nŸifõr_ˇŒ
 = 
˝uid_˛ass_˝u_ˇŒback
,

181 *
	$˝uid_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

183  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/˝uid", 
	`MINOR
(
dev
->
devt
));

184 
	}
}

186 
__öô
 
	$˝uid_öô
()

188 
i
, 
îr
 = 0;

189 
i
 = 0;

191 i‡(
	`__ªgi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
,

192 "˝u/˝uid", &
˝uid_f›s
)) {

193 
	`¥ötk
(
KERN_ERR
 "cpuid: unableÅo get major %d for cpuid\n",

194 
CPUID_MAJOR
);

195 
îr
 = -
EBUSY
;

196 
out
;

198 
˝uid_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "cpuid");

199 i‡(
	`IS_ERR
(
˝uid_˛ass
)) {

200 
îr
 = 
	`PTR_ERR
(
˝uid_˛ass
);

201 
out_chrdev
;

203 
˝uid_˛ass
->
devnode
 = 
˝uid_devnode
;

204 
	`f‹_óch_⁄löe_˝u
(
i
) {

205 
îr
 = 
	`˝uid_devi˚_¸óã
(
i
);

206 i‡(
îr
 != 0)

207 
out_˛ass
;

209 
	`ªgi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

211 
îr
 = 0;

212 
out
;

214 
out_˛ass
:

215 
i
 = 0;

216 
	`f‹_óch_⁄löe_˝u
(
i
) {

217 
	`˝uid_devi˚_de°roy
(
i
);

219 
	`˛ass_de°roy
(
˝uid_˛ass
);

220 
out_chrdev
:

221 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

222 
out
:

223  
îr
;

224 
	}
}

226 
__exô
 
	$˝uid_exô
()

228 
˝u
 = 0;

230 
	`f‹_óch_⁄löe_˝u
(
˝u
)

231 
	`˝uid_devi˚_de°roy
(
˝u
);

232 
	`˛ass_de°roy
(
˝uid_˛ass
);

233 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

234 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

235 
	}
}

237 
moduÀ_öô
(
˝uid_öô
);

238 
moduÀ_exô
(
˝uid_exô
);

240 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

241 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

242 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<löux/öô.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/ªboŸ.h
>

15 
	~<löux/kexec.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/ñfc‹e.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/h¨dúq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_úq.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/h≥t.h
>

26 
	~<löux/kdebug.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ªboŸ.h
>

29 
	~<asm/vúãxt.h
>

31 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

33 
	$kdump_nmi_ˇŒback
(
˝u
, 
dõ_¨gs
 *
¨gs
)

35 
±_ªgs
 *
ªgs
;

36 #ifde‡
CONFIG_X86_32


37 
±_ªgs
 
fixed_ªgs
;

40 
ªgs
 = 
¨gs
->regs;

42 #ifde‡
CONFIG_X86_32


43 i‡(!
	`u£r_mode_vm
(
ªgs
)) {

44 
	`¸ash_fixup_ss_e•
(&
fixed_ªgs
, 
ªgs
);

45 
ªgs
 = &
fixed_ªgs
;

48 
	`¸ash_ßve_˝u
(
ªgs
, 
˝u
);

56 
	`˝u_emîgícy_vmxoff
();

57 
	`˝u_emîgícy_svm_dißbÀ
();

59 
	`dißbÀ_loˇl_APIC
();

60 
	}
}

62 
	$kdump_nmi_shoŸdown_˝us
()

64 
	`nmi_shoŸdown_˝us
(
kdump_nmi_ˇŒback
);

66 
	`dißbÀ_loˇl_APIC
();

67 
	}
}

70 
	$kdump_nmi_shoŸdown_˝us
()

73 
	}
}

76 
	$«tive_machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

87 
	`loˇl_úq_dißbÀ
();

89 
	`kdump_nmi_shoŸdown_˝us
();

95 
	`˝u_emîgícy_vmxoff
();

96 
	`˝u_emîgícy_svm_dißbÀ
();

98 
	`œpic_shutdown
();

99 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

100 
	`dißbÀ_IO_APIC
();

102 #ifde‡
CONFIG_HPET_TIMER


103 
	`h≥t_dißbÀ
();

105 
	`¸ash_ßve_˝u
(
ªgs
, 
	`ß„_smp_¥o˚ss‹_id
());

106 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/io.h
>

14 
	gñfc‹ehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$c›y_ﬁdmem_∑ge
(
p‚
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 i‡(!
csize
)

37 
vaddr
 = 
	`i‹em≠
(
p‚
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 i‡(!
vaddr
)

39  -
ENOMEM
;

41 i‡(
u£rbuf
) {

42 i‡(
	`c›y_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm≠
(
vaddr
);

44  -
EFAULT
;

47 
	`mem˝y
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm≠
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/·ø˚.h
>

14 
	~<löux/kexec.h
>

15 
	~<löux/bug.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/sysfs.h
>

19 
	~<asm/°ackåa˚.h
>

21 
	~"dump°ack.h
"

23 
	g∑nic_⁄_uƒecovîed_nmi
;

24 
	g∑nic_⁄_io_nmi
;

25 
	gcode_byãs
 = 64;

26 
	gk°ack_dïth_to_¥öt
 = 3 * 
STACKSLOTS_PER_LINE
;

27 
	gdõ_cou¡î
;

29 
	$¥ötk_addªss
(
addªss
, 
ªlübÀ
)

31 
	`¥ötk
(" [<%p>] %s%pS\n", (*Ë
addªss
,

32 
ªlübÀ
 ? "" : "? ", (*Ë
addªss
);

33 
	}
}

35 #ifde‡
CONFIG_FUNCTION_GRAPH_TRACER


37 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

38 c⁄° 
°ackåa˚_›s
 *
›s
,

39 
thªad_öfo
 *
töfo
, *
gøph
)

41 
èsk_°ru˘
 *
èsk
 = 
töfo
->task;

42 
ªt_addr
;

43 
ödex
 = 
èsk
->
cuº_ªt_°ack
;

45 i‡(
addr
 !()
ªtu∫_to_h™dÀr
)

48 i‡(!
èsk
->
ªt_°ack
 || 
ödex
 < *
gøph
)

51 
ödex
 -*
gøph
;

52 
ªt_addr
 = 
èsk
->
ªt_°ack
[
ödex
].
ªt
;

54 
›s
->
	`addªss
(
d©a
, 
ªt_addr
, 1);

56 (*
gøph
)++;

57 
	}
}

59 
ölöe
 

60 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

61 c⁄° 
°ackåa˚_›s
 *
›s
,

62 
thªad_öfo
 *
töfo
, *
gøph
)

63 { 
	}
}

73 
ölöe
 
	$vÆid_°ack_±r
(
thªad_öfo
 *
töfo
,

74 *
p
, 
size
, *
íd
)

76 *
t
 = 
töfo
;

77 i‡(
íd
) {

78 i‡(
p
 < 
íd
 &&Ö >”nd-
THREAD_SIZE
))

83  
p
 > 
t
 &&Ö <Å + 
THREAD_SIZE
 - 
size
;

84 
	}
}

87 
	$¥öt_c⁄ãxt_°ack
(
thªad_öfo
 *
töfo
,

88 *
°ack
, 
bp
,

89 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

90 *
íd
, *
gøph
)

92 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

94 
	`vÆid_°ack_±r
(
töfo
, 
°ack
, (*°ack), 
íd
)) {

95 
addr
;

97 
addr
 = *
°ack
;

98 i‡(
	`__kî√l_ãxt_addªss
(
addr
)) {

99 i‡((Ë
°ack
 =
bp
 + ()) {

100 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

101 
‰ame
 = føme->
√xt_‰ame
;

102 
bp
 = (Ë
‰ame
;

104 
›s
->
	`addªss
(
d©a
, 
addr
, 0);

106 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

108 
°ack
++;

110  
bp
;

111 
	}
}

112 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack
);

115 
	$¥öt_c⁄ãxt_°ack_bp
(
thªad_öfo
 *
töfo
,

116 *
°ack
, 
bp
,

117 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

118 *
íd
, *
gøph
)

120 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

121 *
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

123 
	`vÆid_°ack_±r
(
töfo
, 
ªt_addr
, (*ªt_addr), 
íd
)) {

124 
addr
 = *
ªt_addr
;

126 i‡(!
	`__kî√l_ãxt_addªss
(
addr
))

129 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

130 
‰ame
 = føme->
√xt_‰ame
;

131 
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

132 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

135  ()
‰ame
;

136 
	}
}

137 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack_bp
);

141 
	$¥öt_åa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

143 
	`¥ötk
(
d©a
);

144 
	`¥öt_symbﬁ
(
msg
, 
symbﬁ
);

145 
	`¥ötk
("\n");

146 
	}
}

148 
	$¥öt_åa˚_w¨nög
(*
d©a
, *
msg
)

150 
	`¥ötk
("%s%s\n", (*)
d©a
, 
msg
);

151 
	}
}

153 
	$¥öt_åa˚_°ack
(*
d©a
, *
«me
)

155 
	`¥ötk
("%†<%s> ", (*)
d©a
, 
«me
);

157 
	}
}

162 
	$¥öt_åa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

164 
	`touch_nmi_w©chdog
();

165 
	`¥ötk
(
d©a
);

166 
	`¥ötk_addªss
(
addr
, 
ªlübÀ
);

167 
	}
}

169 c⁄° 
°ackåa˚_›s
 
	g¥öt_åa˚_›s
 = {

170 .
w¨nög
 = 
¥öt_åa˚_w¨nög
,

171 .
	gw¨nög_symbﬁ
 = 
¥öt_åa˚_w¨nög_symbﬁ
,

172 .
	g°ack
 = 
¥öt_åa˚_°ack
,

173 .
	gaddªss
 = 
¥öt_åa˚_addªss
,

174 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

178 
	$show_åa˚_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

179 *
°ack
, 
bp
, *
log_lvl
)

181 
	`¥ötk
("%sCÆ»Tø˚:\n", 
log_lvl
);

182 
	`dump_åa˚
(
èsk
, 
ªgs
, 
°ack
, 
bp
, &
¥öt_åa˚_›s
, 
log_lvl
);

183 
	}
}

185 
	$show_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

186 *
°ack
, 
bp
)

188 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
°ack
, 
bp
, "");

189 
	}
}

191 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

193 
	`show_°ack_log_lvl
(
èsk
, 
NULL
, 
•
, 0, "");

194 
	}
}

199 
	$dump_°ack
()

201 
bp
 = 0;

202 
°ack
;

204 #ifde‡
CONFIG_FRAME_POINTER


205 i‡(!
bp
)

206 
	`gë_bp
(
bp
);

209 
	`¥ötk
("Pid: %d, comm: %.20s %s %s %.*s\n",

210 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

211 
	`öô_ut¢ame
()->
ªÀa£
,

212 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

213 
	`öô_ut¢ame
()->
vîsi⁄
);

214 
	`show_åa˚
(
NULL
, NULL, &
°ack
, 
bp
);

215 
	}
}

216 
EXPORT_SYMBOL
(
dump_°ack
);

218 
¨ch_•ölock_t
 
	gdõ_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

219 
	gdõ_ow√r
 = -1;

220 
	gdõ_√°_cou¡
;

222 
__k¥obes
 
	$o›s_begö
()

224 
˝u
;

225 
Êags
;

230 
	`åa˚_hw_bønch_o›s
();

232 
	`o›s_íãr
();

235 
	`øw_loˇl_úq_ßve
(
Êags
);

236 
˝u
 = 
	`smp_¥o˚ss‹_id
();

237 i‡(!
	`¨ch_•ö_åylock
(&
dõ_lock
)) {

238 i‡(
˝u
 =
dõ_ow√r
)

241 
	`¨ch_•ö_lock
(&
dõ_lock
);

243 
dõ_√°_cou¡
++;

244 
dõ_ow√r
 = 
˝u
;

245 
	`c⁄sﬁe_vîbo£
();

246 
	`bu°_•ölocks
(1);

247  
Êags
;

248 
	}
}

250 
__k¥obes
 
	$o›s_íd
(
Êags
, 
±_ªgs
 *
ªgs
, 
sigƒ
)

252 i‡(
ªgs
 && 
	`kexec_should_¸ash
(
cuºít
))

253 
	`¸ash_kexec
(
ªgs
);

255 
	`bu°_•ölocks
(0);

256 
dõ_ow√r
 = -1;

257 
	`add_èöt
(
TAINT_DIE
);

258 
dõ_√°_cou¡
--;

259 i‡(!
dõ_√°_cou¡
)

261 
	`¨ch_•ö_u∆ock
(&
dõ_lock
);

262 
	`øw_loˇl_úq_ª°‹e
(
Êags
);

263 
	`o›s_exô
();

265 i‡(!
sigƒ
)

267 i‡(
	`ö_öãºu±
())

268 
	`∑nic
("FatalÉxception in interrupt");

269 i‡(
∑nic_⁄_o›s
)

270 
	`∑nic
("FatalÉxception");

271 
	`do_exô
(
sigƒ
);

272 
	}
}

274 
__k¥obes
 
	$__dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

276 #ifde‡
CONFIG_X86_32


277 
ss
;

278 
•
;

280 
	`¥ötk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
°r
, 
îr
 & 0xffff, ++
dõ_cou¡î
);

281 #ifde‡
CONFIG_PREEMPT


282 
	`¥ötk
("PREEMPT ");

284 #ifde‡
CONFIG_SMP


285 
	`¥ötk
("SMP ");

287 #ifde‡
CONFIG_DEBUG_PAGEALLOC


288 
	`¥ötk
("DEBUG_PAGEALLOC");

290 
	`¥ötk
("\n");

291 
	`sysfs_¥ötk_œ°_fûe
();

292 i‡(
	`nŸify_dõ
(
DIE_OOPS
, 
°r
, 
ªgs
, 
îr
,

293 
cuºít
->
thªad
.
å≠_no
, 
SIGSEGV
Ë=
NOTIFY_STOP
)

296 
	`show_ªgi°îs
(
ªgs
);

297 #ifde‡
CONFIG_X86_32


298 i‡(
	`u£r_mode_vm
(
ªgs
)) {

299 
•
 = 
ªgs
->sp;

300 
ss
 = 
ªgs
->ss & 0xffff;

302 
•
 = 
	`kî√l_°ack_poöãr
(
ªgs
);

303 
	`ßve£gmít
(
ss
, ss);

305 
	`¥ötk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
ªgs
->
ù
);

306 
	`¥öt_symbﬁ
("%s", 
ªgs
->
ù
);

307 
	`¥ötk
(" SS:ESP %04x:%08lx\n", 
ss
, 
•
);

310 
	`¥ötk
(
KERN_ALERT
 "RIP ");

311 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

312 
	`¥ötk
(" RSP <%016lx>\n", 
ªgs
->
•
);

315 
	}
}

321 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

323 
Êags
 = 
	`o›s_begö
();

324 
sig
 = 
SIGSEGV
;

326 i‡(!
	`u£r_mode_vm
(
ªgs
))

327 
	`ªp‹t_bug
(
ªgs
->
ù
,Ñegs);

329 i‡(
	`__dõ
(
°r
, 
ªgs
, 
îr
))

330 
sig
 = 0;

331 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

332 
	}
}

334 
nŸø˚
 
__k¥obes


335 
	$dõ_nmi
(*
°r
, 
±_ªgs
 *
ªgs
, 
do_∑nic
)

337 
Êags
;

339 i‡(
	`nŸify_dõ
(
DIE_NMIWATCHDOG
, 
°r
, 
ªgs
, 0, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

346 
Êags
 = 
	`o›s_begö
();

347 
	`¥ötk
(
KERN_EMERG
 "%s", 
°r
);

348 
	`¥ötk
(" on CPU%d, ip %08lx,Ñegisters:\n",

349 
	`smp_¥o˚ss‹_id
(), 
ªgs
->
ù
);

350 
	`show_ªgi°îs
(
ªgs
);

351 
	`o›s_íd
(
Êags
, 
ªgs
, 0);

352 i‡(
do_∑nic
 || 
∑nic_⁄_o›s
)

353 
	`∑nic
("Non maskable interrupt");

354 
	`nmi_exô
();

355 
	`loˇl_úq_íabÀ
();

356 
	`do_exô
(
SIGBUS
);

357 
	}
}

359 
__öô
 
	$o›s_£tup
(*
s
)

361 i‡(!
s
)

362  -
EINVAL
;

363 i‡(!
	`°rcmp
(
s
, "panic"))

364 
∑nic_⁄_o›s
 = 1;

366 
	}
}

367 
óæy_∑øm
("o›s", 
o›s_£tup
);

369 
__öô
 
	$k°ack_£tup
(*
s
)

371 i‡(!
s
)

372  -
EINVAL
;

373 
k°ack_dïth_to_¥öt
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

375 
	}
}

376 
óæy_∑øm
("k°ack", 
k°ack_£tup
);

378 
__öô
 
	$code_byãs_£tup
(*
s
)

380 
code_byãs
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

381 i‡(
code_byãs
 > 8192)

382 
code_byãs
 = 8192;

385 
	}
}

386 
__£tup
("code_byãs=", 
code_byãs_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/h¨dúq.h
>

9 
	~<löux/kdebug.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/±ø˚.h
>

12 
	~<löux/kexec.h
>

13 
	~<löux/sysfs.h
>

14 
	~<löux/bug.h
>

15 
	~<löux/nmi.h
>

17 
	~<asm/°ackåa˚.h
>

19 
	~"dump°ack.h
"

21 
	#N_EXCEPTION_STACKS_END
 \

22 (
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
/
EXCEPTION_STKSZ
 - 2)

	)

24 
	gx86_°ack_ids
[][8] = {

25 [ 
DEBUG_STACK
-1 ] = "#DB",

26 [ 
NMI_STACK
-1 ] = "NMI",

27 [ 
DOUBLEFAULT_STACK
-1 ] = "#DF",

28 [ 
STACKFAULT_STACK
-1 ] = "#SS",

29 [ 
MCE_STACK
-1 ] = "#MC",

30 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


31 [ 
N_EXCEPTION_STACKS
 ...

32 
N_EXCEPTION_STACKS_END
 ] = "#DB[?]"

36 *
	$ö_ex˚±i⁄_°ack
(
˝u
, 
°ack
,

37 *
u£dp
, **
idp
)

39 
k
;

45 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

46 
íd
 = 
	`≥r_˝u
(
‹ig_i°
, 
˝u
).
i°
[
k
];

51 i‡(
°ack
 >
íd
)

57 i‡(
°ack
 >
íd
 - 
EXCEPTION_STKSZ
) {

64 i‡(*
u£dp
 & (1U << 
k
))

66 *
u£dp
 |1U << 
k
;

67 *
idp
 = 
x86_°ack_ids
[
k
];

68  (*)
íd
;

75 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


76 i‡(
k
 =
DEBUG_STACK
 - 1 && 
°ack
 >
íd
 - 
DEBUG_STKSZ
) {

77 
j
 = 
N_EXCEPTION_STACKS
 - 1;

85 ++
j
;

86 
íd
 -
EXCEPTION_STKSZ
;

87 
x86_°ack_ids
[
j
][4] = '1' +

88 (
j
 - 
N_EXCEPTION_STACKS
);

89 } 
°ack
 < 
íd
 - 
EXCEPTION_STKSZ
);

90 i‡(*
u£dp
 & (1U << 
j
))

92 *
u£dp
 |1U << 
j
;

93 *
idp
 = 
x86_°ack_ids
[
j
];

94  (*)
íd
;

98  
NULL
;

99 
	}
}

101 
ölöe
 

102 
	$ö_úq_°ack
(*
°ack
, *
úq_°ack
,

103 *
úq_°ack_íd
)

105  (
°ack
 >
úq_°ack
 && sèck < 
úq_°ack_íd
);

106 
	}
}

117 
ölöe
 

118 
	$fixup_bp_úq_lök
(
bp
, *
°ack
,

119 *
úq_°ack
, *
úq_°ack_íd
)

121 #ifde‡
CONFIG_FRAME_POINTER


122 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

123 
√xt
;

125 i‡(!
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
)) {

126 i‡(!
	`¥obe_kî√l_addªss
(&
‰ame
->
√xt_‰ame
, 
√xt
))

127  
√xt
;

129 
	`WARN_ONCE
(1, "Perf: bad frameÖointer = %p in "

130 "ˇŒchaö\n", &
‰ame
->
√xt_‰ame
);

133  
bp
;

134 
	}
}

143 
	$dump_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

144 *
°ack
, 
bp
,

145 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
)

147 c⁄° 
˝u
 = 
	`gë_˝u
();

148 *
úq_°ack_íd
 =

149 (*)
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
);

150 
u£d
 = 0;

151 
thªad_öfo
 *
töfo
;

152 
gøph
 = 0;

154 i‡(!
èsk
)

155 
èsk
 = 
cuºít
;

157 i‡(!
°ack
) {

158 
dummy
;

159 
°ack
 = &
dummy
;

160 i‡(
èsk
 &&Åask !
cuºít
)

161 
°ack
 = (*)
èsk
->
thªad
.
•
;

164 #ifde‡
CONFIG_FRAME_POINTER


165 i‡(!
bp
) {

166 i‡(
èsk
 =
cuºít
) {

168 
	`gë_bp
(
bp
);

171 
bp
 = *(*Ë
èsk
->
thªad
.
•
;

181 
töfo
 = 
	`èsk_thªad_öfo
(
èsk
);

183 *
id
;

184 *
e°ack_íd
;

185 
e°ack_íd
 = 
	`ö_ex˚±i⁄_°ack
(
˝u
, ()
°ack
,

186 &
u£d
, &
id
);

188 i‡(
e°ack_íd
) {

189 i‡(
›s
->
	`°ack
(
d©a
, 
id
) < 0)

192 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp, ops,

193 
d©a
, 
e°ack_íd
, &
gøph
);

194 
›s
->
	`°ack
(
d©a
, "<EOE>");

200 
°ack
 = (*Ë
e°ack_íd
[-2];

203 i‡(
úq_°ack_íd
) {

204 *
úq_°ack
;

205 
úq_°ack
 = 
úq_°ack_íd
 -

206 (
IRQ_STACK_SIZE
 - 64Ë/ (*
úq_°ack
);

208 i‡(
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
)) {

209 i‡(
›s
->
	`°ack
(
d©a
, "IRQ") < 0)

211 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp,

212 
›s
, 
d©a
, 
úq_°ack_íd
, &
gøph
);

218 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

219 
bp
 = 
	`fixup_bp_úq_lök
(bp, 
°ack
, 
úq_°ack
,

220 
úq_°ack_íd
);

221 
úq_°ack_íd
 = 
NULL
;

222 
›s
->
	`°ack
(
d©a
, "EOI");

232 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp, ops, 
d©a
, 
NULL
, &
gøph
);

233 
	`put_˝u
();

234 
	}
}

235 
EXPORT_SYMBOL
(
dump_åa˚
);

238 
	$show_°ack_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

239 *
•
, 
bp
, *
log_lvl
)

241 *
úq_°ack_íd
;

242 *
úq_°ack
;

243 *
°ack
;

244 
˝u
;

245 
i
;

247 
	`¥ìm±_dißbÀ
();

248 
˝u
 = 
	`smp_¥o˚ss‹_id
();

250 
úq_°ack_íd
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
));

251 
úq_°ack
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
Ë- 
IRQ_STACK_SIZE
);

257 i‡(
•
 =
NULL
) {

258 i‡(
èsk
)

259 
•
 = (*)
èsk
->
thªad
.sp;

261 
•
 = (*)&sp;

264 
°ack
 = 
•
;

265 
i
 = 0; i < 
k°ack_dïth_to_¥öt
; i++) {

266 i‡(
°ack
 >
úq_°ack
 && sèck <
úq_°ack_íd
) {

267 i‡(
°ack
 =
úq_°ack_íd
) {

268 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

269 
	`¥ötk
(" <EOI> ");

272 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

275 i‡(
i
 && ((ò% 
STACKSLOTS_PER_LINE
) == 0))

276 
	`¥ötk
("\n%s", 
log_lvl
);

277 
	`¥ötk
(" %016lx", *
°ack
++);

278 
	`touch_nmi_w©chdog
();

280 
	`¥ìm±_íabÀ
();

282 
	`¥ötk
("\n");

283 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
•
, 
bp
, 
log_lvl
);

284 
	}
}

286 
	$show_ªgi°îs
(
±_ªgs
 *
ªgs
)

288 
i
;

289 
•
;

290 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

291 
èsk_°ru˘
 *
cur
 = 
cuºít
;

293 
•
 = 
ªgs
->sp;

294 
	`¥ötk
("CPU %d ", 
˝u
);

295 
	`¥öt_moduÀs
();

296 
	`__show_ªgs
(
ªgs
, 1);

297 
	`¥ötk
("Process %s (pid: %d,Åhreadinfo %p,Åask %p)\n",

298 
cur
->
comm
, cur->
pid
, 
	`èsk_thªad_öfo
(cur), cur);

304 i‡(!
	`u£r_mode
(
ªgs
)) {

305 
code_¥ﬁogue
 = 
code_byãs
 * 43 / 64;

306 
code_Àn
 = 
code_byãs
;

307 
c
;

308 
u8
 *
ù
;

310 
	`¥ötk
(
KERN_EMERG
 "Stack:\n");

311 
	`show_°ack_log_lvl
(
NULL
, 
ªgs
, (*)
•
,

312 
ªgs
->
bp
, 
KERN_EMERG
);

314 
	`¥ötk
(
KERN_EMERG
 "Code: ");

316 
ù
 = (
u8
 *)
ªgs
->ù - 
code_¥ﬁogue
;

317 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 || 
	`¥obe_kî√l_addªss
(ù, 
c
)) {

319 
ù
 = (
u8
 *)
ªgs
->ip;

320 
code_Àn
 = code_À¿- 
code_¥ﬁogue
 + 1;

322 
i
 = 0; i < 
code_Àn
; i++, 
ù
++) {

323 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 ||

324 
	`¥obe_kî√l_addªss
(
ù
, 
c
)) {

325 
	`¥ötk
(" Bad RIP value.");

328 i‡(
ù
 =(
u8
 *)
ªgs
->ip)

329 
	`¥ötk
("<%02x> ", 
c
);

331 
	`¥ötk
("%02x ", 
c
);

334 
	`¥ötk
("\n");

335 
	}
}

337 
	$is_vÆid_bugaddr
(
ù
)

339 
ud2
;

341 i‡(
	`__c›y_‰om_u£r
(&
ud2
, (c⁄° 
__u£r
 *Ë
ù
, (ud2)))

344  
ud2
 == 0x0b0f;

345 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/boŸmem.h
>

15 
	~<löux/p‚.h
>

16 
	~<löux/su•íd.h
>

17 
	~<löux/fúmw¨e-m≠.h
>

19 
	~<asm/e820.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/£tup.h
>

37 
e820m≠
 
	ge820
;

38 
e820m≠
 
	ge820_ßved
;

41 
	gpci_mem_°¨t
 = 0xaeedbabe;

42 #ifde‡
CONFIG_PCI


43 
EXPORT_SYMBOL
(
pci_mem_°¨t
);

51 
	$e820_™y_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

53 
i
;

55 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

56 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

58 i‡(
ty≥
 && 
ei
->type !=Åype)

60 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

65 
	}
}

66 
EXPORT_SYMBOL_GPL
(
e820_™y_m≠≥d
);

74 
__öô
 
	$e820_Æl_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

76 
i
;

78 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

79 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

81 i‡(
ty≥
 && 
ei
->type !=Åype)

84 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

90 i‡(
ei
->
addr
 <
°¨t
)

91 
°¨t
 = 
ei
->
addr
 +Éi->
size
;

96 i‡(
°¨t
 >
íd
)

100 
	}
}

105 
__öô
 
	$__e820_add_ªgi⁄
(
e820m≠
 *
e820x
, 
u64
 
°¨t
, u64 
size
,

106 
ty≥
)

108 
x
 = 
e820x
->
ƒ_m≠
;

110 i‡(
x
 >
	`ARRAY_SIZE
(
e820x
->
m≠
)) {

111 
	`¥ötk
(
KERN_ERR
 "Ooops! Too manyÉntries inÅhe memory map!\n");

115 
e820x
->
m≠
[
x
].
addr
 = 
°¨t
;

116 
e820x
->
m≠
[
x
].
size
 = size;

117 
e820x
->
m≠
[
x
].
ty≥
 =Åype;

118 
e820x
->
ƒ_m≠
++;

119 
	}
}

121 
__öô
 
	$e820_add_ªgi⁄
(
u64
 
°¨t
, u64 
size
, 
ty≥
)

123 
	`__e820_add_ªgi⁄
(&
e820
, 
°¨t
, 
size
, 
ty≥
);

124 
	}
}

126 
__öô
 
	$e820_¥öt_ty≥
(
u32
 
ty≥
)

128 
ty≥
) {

129 
E820_RAM
:

130 
E820_RESERVED_KERN
:

131 
	`¥ötk
(
KERN_CONT
 "(usable)");

133 
E820_RESERVED
:

134 
	`¥ötk
(
KERN_CONT
 "(reserved)");

136 
E820_ACPI
:

137 
	`¥ötk
(
KERN_CONT
 "(ACPI data)");

139 
E820_NVS
:

140 
	`¥ötk
(
KERN_CONT
 "(ACPI NVS)");

142 
E820_UNUSABLE
:

143 
	`¥ötk
(
KERN_CONT
 "(unusable)");

146 
	`¥ötk
(
KERN_CONT
 "ty≥ %u", 
ty≥
);

149 
	}
}

151 
__öô
 
	$e820_¥öt_m≠
(*
who
)

153 
i
;

155 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

156 
	`¥ötk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

157 (Ë
e820
.
m≠
[
i
].
addr
,

159 (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
));

160 
	`e820_¥öt_ty≥
(
e820
.
m≠
[
i
].
ty≥
);

161 
	`¥ötk
(
KERN_CONT
 "\n");

163 
	}
}

227 
__öô
 
	$ßnôize_e820_m≠
(
e820íåy
 *
biosm≠
, 
max_ƒ_m≠
,

228 
u32
 *
≤r_m≠
)

230 
	sch™ge_membî
 {

231 
e820íåy
 *
pbios
;

232 
addr
;

234 
ch™ge_membî
 
ch™ge_poöt_li°
[2*
E820_X_MAX
] 
__öôd©a
;

235 
ch™ge_membî
 *
ch™ge_poöt
[2*
E820_X_MAX
] 
__öôd©a
;

236 
e820íåy
 *
ovîœp_li°
[
E820_X_MAX
] 
__öôd©a
;

237 
e820íåy
 
√w_bios
[
E820_X_MAX
] 
__öôd©a
;

238 
ch™ge_membî
 *
ch™ge_tmp
;

239 
cuºít_ty≥
, 
œ°_ty≥
;

240 
œ°_addr
;

241 
chgidx
, 
°ûl_ch™gög
;

242 
ovîœp_íåõs
;

243 
√w_bios_íåy
;

244 
ﬁd_ƒ
, 
√w_ƒ
, 
chg_ƒ
;

245 
i
;

248 i‡(*
≤r_m≠
 < 2)

251 
ﬁd_ƒ
 = *
≤r_m≠
;

252 
	`BUG_ON
(
ﬁd_ƒ
 > 
max_ƒ_m≠
);

255 
i
 = 0; i < 
ﬁd_ƒ
; i++)

256 i‡(
biosm≠
[
i
].
addr
 + biosm≠[i].
size
 < biosmap[i].addr)

260 
i
 = 0; i < 2 * 
ﬁd_ƒ
; i++)

261 
ch™ge_poöt
[
i
] = &
ch™ge_poöt_li°
[i];

265 
chgidx
 = 0;

266 
i
 = 0; i < 
ﬁd_ƒ
; i++) {

267 i‡(
biosm≠
[
i
].
size
 != 0) {

268 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr;

269 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

270 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr +

271 
biosm≠
[
i
].
size
;

272 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

275 
chg_ƒ
 = 
chgidx
;

278 
°ûl_ch™gög
 = 1;

279 
°ûl_ch™gög
) {

280 
°ûl_ch™gög
 = 0;

281 
i
 = 1; i < 
chg_ƒ
; i++) {

282 
cuøddr
, 
œ°addr
;

283 
cuΩbaddr
, 
œ°pbaddr
;

285 
cuøddr
 = 
ch™ge_poöt
[
i
]->
addr
;

286 
œ°addr
 = 
ch™ge_poöt
[
i
 - 1]->
addr
;

287 
cuΩbaddr
 = 
ch™ge_poöt
[
i
]->
pbios
->
addr
;

288 
œ°pbaddr
 = 
ch™ge_poöt
[
i
 - 1]->
pbios
->
addr
;

297 i‡(
cuøddr
 < 
œ°addr
 ||

298 (
cuøddr
 =
œ°addr
 && cuødd∏=
cuΩbaddr
 &&

299 
œ°addr
 !
œ°pbaddr
)) {

300 
ch™ge_tmp
 = 
ch™ge_poöt
[
i
];

301 
ch™ge_poöt
[
i
] = change_point[i-1];

302 
ch™ge_poöt
[
i
-1] = 
ch™ge_tmp
;

303 
°ûl_ch™gög
 = 1;

309 
ovîœp_íåõs
 = 0;

310 
√w_bios_íåy
 = 0;

311 
œ°_ty≥
 = 0;

312 
œ°_addr
 = 0;

315 
chgidx
 = 0; chgidx < 
chg_ƒ
; chgidx++) {

317 i‡(
ch™ge_poöt
[
chgidx
]->
addr
 ==

318 
ch™ge_poöt
[
chgidx
]->
pbios
->
addr
) {

323 
ovîœp_li°
[
ovîœp_íåõs
++] =

324 
ch™ge_poöt
[
chgidx
]->
pbios
;

330 
i
 = 0; i < 
ovîœp_íåõs
; i++) {

331 i‡(
ovîœp_li°
[
i
] ==

332 
ch™ge_poöt
[
chgidx
]->
pbios
)

333 
ovîœp_li°
[
i
] =

334 
ovîœp_li°
[
ovîœp_íåõs
-1];

336 
ovîœp_íåõs
--;

343 
cuºít_ty≥
 = 0;

344 
i
 = 0; i < 
ovîœp_íåõs
; i++)

345 i‡(
ovîœp_li°
[
i
]->
ty≥
 > 
cuºít_ty≥
)

346 
cuºít_ty≥
 = 
ovîœp_li°
[
i
]->
ty≥
;

351 i‡(
cuºít_ty≥
 !
œ°_ty≥
) {

352 i‡(
œ°_ty≥
 != 0) {

353 
√w_bios
[
√w_bios_íåy
].
size
 =

354 
ch™ge_poöt
[
chgidx
]->
addr
 - 
œ°_addr
;

359 i‡(
√w_bios
[
√w_bios_íåy
].
size
 != 0)

364 i‡(++
√w_bios_íåy
 >
max_ƒ_m≠
)

367 i‡(
cuºít_ty≥
 != 0) {

368 
√w_bios
[
√w_bios_íåy
].
addr
 =

369 
ch™ge_poöt
[
chgidx
]->
addr
;

370 
√w_bios
[
√w_bios_íåy
].
ty≥
 = 
cuºít_ty≥
;

371 
œ°_addr
 = 
ch™ge_poöt
[
chgidx
]->
addr
;

373 
œ°_ty≥
 = 
cuºít_ty≥
;

377 
√w_ƒ
 = 
√w_bios_íåy
;

380 
	`mem˝y
(
biosm≠
, 
√w_bios
, 
√w_ƒ
 * (
e820íåy
));

381 *
≤r_m≠
 = 
√w_ƒ
;

384 
	}
}

386 
__öô
 
	$__≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

388 
ƒ_m≠
) {

389 
u64
 
°¨t
 = 
biosm≠
->
addr
;

390 
u64
 
size
 = 
biosm≠
->size;

391 
u64
 
íd
 = 
°¨t
 + 
size
;

392 
u32
 
ty≥
 = 
biosm≠
->type;

395 i‡(
°¨t
 > 
íd
)

398 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
ty≥
);

400 
biosm≠
++;

401 
ƒ_m≠
--;

404 
	}
}

415 
__öô
 
	$≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

418 i‡(
ƒ_m≠
 < 2)

421  
	`__≠≥nd_e820_m≠
(
biosm≠
, 
ƒ_m≠
);

422 
	}
}

424 
u64
 
__öô
 
	$__e820_upd©e_ønge
(
e820m≠
 *
e820x
, 
u64
 
°¨t
,

425 
u64
 
size
, 
ﬁd_ty≥
,

426 
√w_ty≥
)

428 
u64
 
íd
;

429 
i
;

430 
u64
 
ªÆ_upd©ed_size
 = 0;

432 
	`BUG_ON
(
ﬁd_ty≥
 =
√w_ty≥
);

434 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

435 
size
 = 
ULLONG_MAX
 - 
°¨t
;

437 
íd
 = 
°¨t
 + 
size
;

438 
	`¥ötk
(
KERN_DEBUG
 "e820 updateÑange: %016Lx - %016Lx ",

439 (Ë
°¨t
,

440 (Ë
íd
);

441 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

442 
	`¥ötk
(
KERN_CONT
 " ==> ");

443 
	`e820_¥öt_ty≥
(
√w_ty≥
);

444 
	`¥ötk
(
KERN_CONT
 "\n");

446 
i
 = 0; i < 
e820x
->
ƒ_m≠
; i++) {

447 
e820íåy
 *
ei
 = &
e820x
->
m≠
[
i
];

448 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

449 
u64
 
ei_íd
;

451 i‡(
ei
->
ty≥
 !
ﬁd_ty≥
)

454 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

456 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

457 
ei
->
ty≥
 = 
√w_ty≥
;

458 
ªÆ_upd©ed_size
 +
ei
->
size
;

463 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

464 
	`__e820_add_ªgi⁄
(
e820x
, 
°¨t
, 
size
, 
√w_ty≥
);

465 
	`__e820_add_ªgi⁄
(
e820x
, 
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

466 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

467 
ªÆ_upd©ed_size
 +
size
;

472 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

473 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

474 i‡(
föÆ_°¨t
 >
föÆ_íd
)

477 
	`__e820_add_ªgi⁄
(
e820x
, 
föÆ_°¨t
, 
föÆ_íd
 - final_start,

478 
√w_ty≥
);

480 
ªÆ_upd©ed_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

486 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

487 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

489 
ei
->
addr
 = 
föÆ_íd
;

491  
ªÆ_upd©ed_size
;

492 
	}
}

494 
u64
 
__öô
 
	$e820_upd©e_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

495 
√w_ty≥
)

497  
	`__e820_upd©e_ønge
(&
e820
, 
°¨t
, 
size
, 
ﬁd_ty≥
, 
√w_ty≥
);

498 
	}
}

500 
u64
 
__öô
 
	$e820_upd©e_ønge_ßved
(
u64
 
°¨t
, u64 
size
,

501 
ﬁd_ty≥
, 
√w_ty≥
)

503  
	`__e820_upd©e_ønge
(&
e820_ßved
, 
°¨t
, 
size
, 
ﬁd_ty≥
,

504 
√w_ty≥
);

505 
	}
}

508 
u64
 
__öô
 
	$e820_ªmove_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

509 
checkty≥
)

511 
i
;

512 
u64
 
íd
;

513 
u64
 
ªÆ_ªmoved_size
 = 0;

515 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

516 
size
 = 
ULLONG_MAX
 - 
°¨t
;

518 
íd
 = 
°¨t
 + 
size
;

519 
	`¥ötk
(
KERN_DEBUG
 "e820ÑemoveÑange: %016Lx - %016Lx ",

520 (Ë
°¨t
,

521 (Ë
íd
);

522 i‡(
checkty≥
)

523 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

524 
	`¥ötk
(
KERN_CONT
 "\n");

526 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

527 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

528 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

529 
u64
 
ei_íd
;

531 i‡(
checkty≥
 && 
ei
->
ty≥
 !
ﬁd_ty≥
)

534 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

536 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

537 
ªÆ_ªmoved_size
 +
ei
->
size
;

538 
	`mem£t
(
ei
, 0, (
e820íåy
));

543 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

544 
	`e820_add_ªgi⁄
(
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

545 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

546 
ªÆ_ªmoved_size
 +
size
;

551 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

552 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

553 i‡(
föÆ_°¨t
 >
föÆ_íd
)

555 
ªÆ_ªmoved_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

561 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

562 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

564 
ei
->
addr
 = 
föÆ_íd
;

566  
ªÆ_ªmoved_size
;

567 
	}
}

569 
__öô
 
	$upd©e_e820
()

571 
u32
 
ƒ_m≠
;

573 
ƒ_m≠
 = 
e820
.nr_map;

574 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ_m≠
))

576 
e820
.
ƒ_m≠
 =Çr_map;

577 
	`¥ötk
(
KERN_INFO
 "modifiedÖhysical RAM map:\n");

578 
	`e820_¥öt_m≠
("modified");

579 
	}
}

580 
__öô
 
	$upd©e_e820_ßved
()

582 
u32
 
ƒ_m≠
;

584 
ƒ_m≠
 = 
e820_ßved
.nr_map;

585 i‡(
	`ßnôize_e820_m≠
(
e820_ßved
.
m≠
, 
	`ARRAY_SIZE
”820_ßved.m≠), &
ƒ_m≠
))

587 
e820_ßved
.
ƒ_m≠
 =Çr_map;

588 
	}
}

589 
	#MAX_GAP_END
 0x100000000uŒ

	)

593 
__öô
 
	$e820_£¨ch_g≠
(*
g≠°¨t
, *
g≠size
,

594 
°¨t_addr
, 
íd_addr
)

596 
œ°
;

597 
i
 = 
e820
.
ƒ_m≠
;

598 
found
 = 0;

600 
œ°
 = (
íd_addr
 &&Énd_add∏< 
MAX_GAP_END
) ?Énd_addr : MAX_GAP_END;

602 --
i
 >= 0) {

603 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

604 
íd
 = 
°¨t
 + 
e820
.
m≠
[
i
].
size
;

606 i‡(
íd
 < 
°¨t_addr
)

613 i‡(
œ°
 > 
íd
) {

614 
g≠
 = 
œ°
 - 
íd
;

616 i‡(
g≠
 >*
g≠size
) {

617 *
g≠size
 = 
g≠
;

618 *
g≠°¨t
 = 
íd
;

619 
found
 = 1;

622 i‡(
°¨t
 < 
œ°
)

623 
œ°
 = 
°¨t
;

625  
found
;

626 
	}
}

634 
__öô
 
	$e820_£tup_g≠
()

636 
g≠°¨t
, 
g≠size
;

637 
found
;

639 
g≠°¨t
 = 0x10000000;

640 
g≠size
 = 0x400000;

641 
found
 = 
	`e820_£¨ch_g≠
(&
g≠°¨t
, &
g≠size
, 0, 
MAX_GAP_END
);

643 #ifde‡
CONFIG_X86_64


644 i‡(!
found
) {

645 
g≠°¨t
 = (
max_p‚
 << 
PAGE_SHIFT
) + 1024*1024;

646 
	`¥ötk
(
KERN_ERR


655 
pci_mem_°¨t
 = 
g≠°¨t
;

657 
	`¥ötk
(
KERN_INFO


659 
pci_mem_°¨t
, 
g≠°¨t
, 
g≠size
);

660 
	}
}

668 
__öô
 
	$∑r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
∑_d©a
)

670 
u32
 
m≠_Àn
;

671 
íåõs
;

672 
e820íåy
 *
extm≠
;

674 
íåõs
 = 
sd©a
->
Àn
 / (
e820íåy
);

675 
m≠_Àn
 = 
sd©a
->
Àn
 + (
£tup_d©a
);

676 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

677 
sd©a
 = 
	`óæy_i‹em≠
(
∑_d©a
, 
m≠_Àn
);

678 
extm≠
 = (
e820íåy
 *)(
sd©a
->
d©a
);

679 
	`__≠≥nd_e820_m≠
(
extm≠
, 
íåõs
);

680 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

681 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

682 
	`óæy_iounm≠
(
sd©a
, 
m≠_Àn
);

683 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

684 
	`e820_¥öt_m≠
("extended");

685 
	}
}

687 #i‡
deföed
(
CONFIG_X86_64
) || \

688 (
deföed
(
CONFIG_X86_32
Ë&& 
	$deföed
(
CONFIG_HIBERNATION
))

697 
__öô
 
	$e820_m¨k_noßve_ªgi⁄s
(
limô_p‚
)

699 
i
;

700 
p‚
;

702 
p‚
 = 
	`PFN_DOWN
(
e820
.
m≠
[0].
addr
 +É820.m≠[0].
size
);

703 
i
 = 1; i < 
e820
.
ƒ_m≠
; i++) {

704 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

706 i‡(
p‚
 < 
	`PFN_UP
(
ei
->
addr
))

707 
	`ªgi°î_noßve_ªgi⁄
(
p‚
, 
	`PFN_UP
(
ei
->
addr
));

709 
p‚
 = 
	`PFN_DOWN
(
ei
->
addr
 +Éi->
size
);

710 i‡(
ei
->
ty≥
 !
E820_RAM
 &&Éi->ty≥ !
E820_RESERVED_KERN
)

711 
	`ªgi°î_noßve_ªgi⁄
(
	`PFN_UP
(
ei
->
addr
), 
p‚
);

713 i‡(
p‚
 >
limô_p‚
)

716 
	}
}

719 #ifde‡
CONFIG_HIBERNATION


724 
__öô
 
	$e820_m¨k_nvs_mem‹y
()

726 
i
;

728 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

729 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

731 i‡(
ei
->
ty≥
 =
E820_NVS
)

732 
	`hibî«ã_nvs_ªgi°î
(
ei
->
addr
,Éi->
size
);

736 
	}
}

737 
c‹e_öôˇŒ
(
e820_m¨k_nvs_mem‹y
);

743 
u64
 
__öô
 
	$föd_e820_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

745 
i
;

747 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

748 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

749 
u64
 
addr
;

750 
u64
 
ei_°¨t
, 
ei_œ°
;

752 i‡(
ei
->
ty≥
 !
E820_RAM
)

755 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

756 
ei_°¨t
 = 
ei
->
addr
;

757 
addr
 = 
	`föd_óæy_¨ó
(
ei_°¨t
, 
ei_œ°
, 
°¨t
, 
íd
,

758 
size
, 
Æign
);

760 i‡(
addr
 != -1ULL)

761  
addr
;

764 
	}
}

766 
u64
 
__öô
 
	$föd_fw_memm≠_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

768  
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

769 
	}
}

771 
u64
 
__öô
 
	$gë_max_m≠≥d
()

773 
u64
 
íd
 = 
max_p‚_m≠≥d
;

775 
íd
 <<
PAGE_SHIFT
;

777  
íd
;

778 
	}
}

782 
u64
 
__öô
 
	$föd_e820_¨ó_size
(
u64
 
°¨t
, u64 *
sizï
, u64 
Æign
)

784 
i
;

786 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

787 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

788 
u64
 
addr
;

789 
u64
 
ei_°¨t
, 
ei_œ°
;

791 i‡(
ei
->
ty≥
 !
E820_RAM
)

794 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

795 
ei_°¨t
 = 
ei
->
addr
;

796 
addr
 = 
	`föd_óæy_¨ó_size
(
ei_°¨t
, 
ei_œ°
, 
°¨t
,

797 
sizï
, 
Æign
);

799 i‡(
addr
 != -1ULL)

800  
addr
;

804 
	}
}

809 
u64
 
__öô
 
	$óæy_ª£rve_e820
(
u64
 
°¨â
, u64 
sizë
, u64 
Æign
)

811 
u64
 
size
 = 0;

812 
u64
 
addr
;

813 
u64
 
°¨t
;

815 
°¨t
 = 
°¨â
; ; sèπ +
size
) {

816 
°¨t
 = 
	`föd_e820_¨ó_size
(°¨t, &
size
, 
Æign
);

817 i‡(!(
°¨t
 + 1))

819 i‡(
size
 >
sizë
)

823 #ifde‡
CONFIG_X86_32


824 i‡(
°¨t
 >
MAXMEM
)

826 i‡(
°¨t
 + 
size
 > 
MAXMEM
)

827 
size
 = 
MAXMEM
 - 
°¨t
;

830 
addr
 = 
	`round_down
(
°¨t
 + 
size
 - 
sizë
, 
Æign
);

831 i‡(
addr
 < 
°¨t
)

833 
	`e820_upd©e_ønge
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

834 
	`e820_upd©e_ønge_ßved
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

835 
	`¥ötk
(
KERN_INFO
 "updateÉ820 forÉarly_reserve_e820\n");

836 
	`upd©e_e820
();

837 
	`upd©e_e820_ßved
();

839  
addr
;

840 
	}
}

842 #ifde‡
CONFIG_X86_32


843 #ifde‡
CONFIG_X86_PAE


844 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

846 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

849 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

855 
__öô
 
	$e820_íd_p‚
(
limô_p‚
, 
ty≥
)

857 
i
;

858 
œ°_p‚
 = 0;

859 
max_¨ch_p‚
 = 
MAX_ARCH_PFN
;

861 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

862 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

863 
°¨t_p‚
;

864 
íd_p‚
;

866 i‡(
ei
->
ty≥
 !=Åype)

869 
°¨t_p‚
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

870 
íd_p‚
 = (
ei
->
addr
 +Éi->
size
Ë>> 
PAGE_SHIFT
;

872 i‡(
°¨t_p‚
 >
limô_p‚
)

874 i‡(
íd_p‚
 > 
limô_p‚
) {

875 
œ°_p‚
 = 
limô_p‚
;

878 i‡(
íd_p‚
 > 
œ°_p‚
)

879 
œ°_p‚
 = 
íd_p‚
;

882 i‡(
œ°_p‚
 > 
max_¨ch_p‚
)

883 
œ°_p‚
 = 
max_¨ch_p‚
;

885 
	`¥ötk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

886 
œ°_p‚
, 
max_¨ch_p‚
);

887  
œ°_p‚
;

888 
	}
}

889 
__öô
 
	$e820_íd_of_øm_p‚
()

891  
	`e820_íd_p‚
(
MAX_ARCH_PFN
, 
E820_RAM
);

892 
	}
}

894 
__öô
 
	$e820_íd_of_low_øm_p‚
()

896  
	`e820_íd_p‚
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

897 
	}
}

902 
__öô
 
	$e820_föd_a˘ive_ªgi⁄
(c⁄° 
e820íåy
 *
ei
,

903 
°¨t_p‚
,

904 
œ°_p‚
,

905 *
ei_°¨ç‚
,

906 *
ei_ídp‚
)

908 
u64
 
Æign
 = 
PAGE_SIZE
;

910 *
ei_°¨ç‚
 = 
	`round_up
(
ei
->
addr
, 
Æign
Ë>> 
PAGE_SHIFT
;

911 *
ei_ídp‚
 = 
	`round_down
(
ei
->
addr
 +Éi->
size
, 
Æign
Ë>> 
PAGE_SHIFT
;

914 i‡(*
ei_°¨ç‚
 >*
ei_ídp‚
)

918 i‡(
ei
->
ty≥
 !
E820_RAM
 || *
ei_ídp‚
 <
°¨t_p‚
 ||

919 *
ei_°¨ç‚
 >
œ°_p‚
)

923 i‡(*
ei_°¨ç‚
 < 
°¨t_p‚
)

924 *
ei_°¨ç‚
 = 
°¨t_p‚
;

925 i‡(*
ei_ídp‚
 > 
œ°_p‚
)

926 *
ei_ídp‚
 = 
œ°_p‚
;

929 
	}
}

932 
__öô
 
	$e820_ªgi°î_a˘ive_ªgi⁄s
(
nid
, 
°¨t_p‚
,

933 
œ°_p‚
)

935 
ei_°¨ç‚
;

936 
ei_ídp‚
;

937 
i
;

939 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++)

940 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

941 
°¨t_p‚
, 
œ°_p‚
,

942 &
ei_°¨ç‚
, &
ei_ídp‚
))

943 
	`add_a˘ive_ønge
(
nid
, 
ei_°¨ç‚
, 
ei_ídp‚
);

944 
	}
}

951 
u64
 
__öô
 
	$e820_hﬁe_size
(
u64
 
°¨t
, u64 
íd
)

953 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

954 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

955 
ei_°¨ç‚
, 
ei_ídp‚
, 
øm
 = 0;

956 
i
;

958 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

959 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

960 
°¨t_p‚
, 
œ°_p‚
,

961 &
ei_°¨ç‚
, &
ei_ídp‚
))

962 
øm
 +
ei_ídp‚
 - 
ei_°¨ç‚
;

964  
íd
 - 
°¨t
 - ((
u64
)
øm
 << 
PAGE_SHIFT
);

965 
	}
}

967 
	$óæy_∑nic
(*
msg
)

969 
	`óæy_¥ötk
(
msg
);

970 
	`∑nic
(
msg
);

971 
	}
}

973 
u£rdef
 
	g__öôd©a
;

976 
__öô
 
	$∑r£_mem›t
(*
p
)

978 
u64
 
mem_size
;

980 i‡(!
p
)

981  -
EINVAL
;

983 #ifde‡
CONFIG_X86_32


984 i‡(!
	`°rcmp
(
p
, "nopentium")) {

985 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_PSE
);

990 
u£rdef
 = 1;

991 
mem_size
 = 
	`mem∑r£
(
p
, &p);

992 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

995 
	}
}

996 
óæy_∑øm
("mem", 
∑r£_mem›t
);

998 
__öô
 
	$∑r£_memm≠_›t
(*
p
)

1000 *
ﬁdp
;

1001 
u64
 
°¨t_©
, 
mem_size
;

1003 i‡(!
p
)

1004  -
EINVAL
;

1006 i‡(!
	`°∫cmp
(
p
, "exactmap", 8)) {

1007 #ifde‡
CONFIG_CRASH_DUMP


1013 
ßved_max_p‚
 = 
	`e820_íd_of_øm_p‚
();

1015 
e820
.
ƒ_m≠
 = 0;

1016 
u£rdef
 = 1;

1020 
ﬁdp
 = 
p
;

1021 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1022 i‡(
p
 =
ﬁdp
)

1023  -
EINVAL
;

1025 
u£rdef
 = 1;

1026 i‡(*
p
 == '@') {

1027 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1028 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RAM
);

1029 } i‡(*
p
 == '#') {

1030 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1031 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_ACPI
);

1032 } i‡(*
p
 == '$') {

1033 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1034 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RESERVED
);

1036 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1038  *
p
 ='\0' ? 0 : -
EINVAL
;

1039 
	}
}

1040 
óæy_∑øm
("memm≠", 
∑r£_memm≠_›t
);

1042 
__öô
 
	$föish_e820_∑rsög
()

1044 i‡(
u£rdef
) {

1045 
u32
 
ƒ
 = 
e820
.
ƒ_m≠
;

1047 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ
) < 0)

1048 
	`óæy_∑nic
("Invalid user supplied memory map");

1049 
e820
.
ƒ_m≠
 = 
ƒ
;

1051 
	`¥ötk
(
KERN_INFO
 "user-definedÖhysical RAM map:\n");

1052 
	`e820_¥öt_m≠
("user");

1054 
	}
}

1056 
ölöe
 c⁄° *
	$e820_ty≥_to_°rög
(
e820_ty≥
)

1058 
e820_ty≥
) {

1059 
E820_RESERVED_KERN
:

1060 
E820_RAM
:  "System RAM";

1061 
E820_ACPI
:  "ACPI Tables";

1062 
E820_NVS
:  "ACPI Non-volatile Storage";

1063 
E820_UNUSABLE
:  "Unusable memory";

1066 
	}
}

1071 
ªsour˚
 
__öôd©a
 *
	ge820_ªs
;

1072 
__öô
 
	$e820_ª£rve_ªsour˚s
()

1074 
i
;

1075 
ªsour˚
 *
ªs
;

1076 
u64
 
íd
;

1078 
ªs
 = 
	`Æloc_boŸmem
((
ªsour˚
Ë* 
e820
.
ƒ_m≠
);

1079 
e820_ªs
 = 
ªs
;

1080 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1081 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
 - 1;

1082 i‡(
íd
 !(
ªsour˚_size_t
)end) {

1083 
ªs
++;

1086 
ªs
->
«me
 = 
	`e820_ty≥_to_°rög
(
e820
.
m≠
[
i
].
ty≥
);

1087 
ªs
->
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

1088 
ªs
->
íd
 =Énd;

1090 
ªs
->
Êags
 = 
IORESOURCE_MEM
;

1097 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RESERVED
 || 
ªs
->
°¨t
 < (1ULL<<20)) {

1098 
ªs
->
Êags
 |
IORESOURCE_BUSY
;

1099 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

1101 
ªs
++;

1104 
i
 = 0; i < 
e820_ßved
.
ƒ_m≠
; i++) {

1105 
e820íåy
 *
íåy
 = &
e820_ßved
.
m≠
[
i
];

1106 
	`fúmw¨e_m≠_add_óæy
(
íåy
->
addr
,

1107 
íåy
->
addr
 +É¡ry->
size
 - 1,

1108 
	`e820_ty≥_to_°rög
(
íåy
->
ty≥
));

1110 
	}
}

1113 
	$øm_Æignmít
(
ªsour˚_size_t
 
pos
)

1115 
mb
 = 
pos
 >> 20;

1118 i‡(!
mb
)

1122 i‡(
mb
 < 16)

1127 
	}
}

1129 
	#MAX_RESOURCE_SIZE
 ((
ªsour˚_size_t
)-1)

	)

1131 
__öô
 
	$e820_ª£rve_ªsour˚s_œã
()

1133 
i
;

1134 
ªsour˚
 *
ªs
;

1136 
ªs
 = 
e820_ªs
;

1137 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1138 i‡(!
ªs
->
∑ª¡
 &&Ñes->
íd
)

1139 
	`ö£π_ªsour˚_ex∑nd_to_fô
(&
iomem_ªsour˚
, 
ªs
);

1140 
ªs
++;

1147 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1148 
e820íåy
 *
íåy
 = &
e820
.
m≠
[
i
];

1149 
u64
 
°¨t
, 
íd
;

1151 i‡(
íåy
->
ty≥
 !
E820_RAM
)

1153 
°¨t
 = 
íåy
->
addr
 +É¡ry->
size
;

1154 
íd
 = 
	`round_up
(
°¨t
, 
	`øm_Æignmít
(start)) - 1;

1155 i‡(
íd
 > 
MAX_RESOURCE_SIZE
)

1156 
íd
 = 
MAX_RESOURCE_SIZE
;

1157 i‡(
°¨t
 >
íd
)

1159 
	`¥ötk
(
KERN_DEBUG
 "reserve RAM buffer: %016llx - %016llx ",

1160 
°¨t
, 
íd
);

1161 
	`ª£rve_ªgi⁄_wôh_•lô
(&
iomem_ªsour˚
, 
°¨t
, 
íd
,

1164 
	}
}

1166 *
__öô
 
	$deÁu…_machöe_•ecific_mem‹y_£tup
()

1168 *
who
 = "BIOS-e820";

1169 
u32
 
√w_ƒ
;

1176 
√w_ƒ
 = 
boŸ_∑øms
.
e820_íåõs
;

1177 
	`ßnôize_e820_m≠
(
boŸ_∑øms
.
e820_m≠
,

1178 
	`ARRAY_SIZE
(
boŸ_∑øms
.
e820_m≠
),

1179 &
√w_ƒ
);

1180 
boŸ_∑øms
.
e820_íåõs
 = 
√w_ƒ
;

1181 i‡(
	`≠≥nd_e820_m≠
(
boŸ_∑øms
.
e820_m≠
, boŸ_∑øms.
e820_íåõs
)

1183 
u64
 
mem_size
;

1186 i‡(
boŸ_∑øms
.
Æt_mem_k


1187 < 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
) {

1188 
mem_size
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
;

1189 
who
 = "BIOS-88";

1191 
mem_size
 = 
boŸ_∑øms
.
Æt_mem_k
;

1192 
who
 = "BIOS-e801";

1195 
e820
.
ƒ_m≠
 = 0;

1196 
	`e820_add_ªgi⁄
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1197 
	`e820_add_ªgi⁄
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1201  
who
;

1202 
	}
}

1204 
__öô
 
	$£tup_mem‹y_m≠
()

1206 *
who
;

1208 
who
 = 
x86_öô
.
ªsour˚s
.
	`mem‹y_£tup
();

1209 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

1210 
	`¥ötk
(
KERN_INFO
 "BIOS-providedÖhysical RAM map:\n");

1211 
	`e820_¥öt_m≠
(
who
);

1212 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<löux/pci.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/pci_ids.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_≠ic.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¨t.h
>

22 
__öô
 
	$fix_hy≥πøn•‹t_c⁄fig
(
num
, 
¶Ÿ
, 
func
)

24 
u32
 
htcfg
;

31 
htcfg
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68);

32 i‡(
htcfg
 & (1 << 18)) {

33 
	`¥ötk
(
KERN_INFO
 "Detected use ofÉxtendedápic ids "

35 i‡((
htcfg
 & (1 << 17)) == 0) {

36 
	`¥ötk
(
KERN_INFO
 "Enabling hypertransportÉxtended "

38 
	`¥ötk
(
KERN_INFO
 "NoteÅhis isá bios bug, "

40 
htcfg
 |= (1 << 17);

41 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68, 
htcfg
);

46 
	}
}

48 
__öô
 
	$vü_bugs
(
num
, 
¶Ÿ
, 
func
)

50 #ifde‡
CONFIG_GART_IOMMU


51 i‡((
max_p‚
 > 
MAX_DMA32_PFN
 || 
f‹˚_iommu
) &&

52 !
g¨t_iommu_≠îtuª_Ælowed
) {

53 
	`¥ötk
(
KERN_INFO


56 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

59 
	}
}

61 #ifde‡
CONFIG_ACPI


62 #ifde‡
CONFIG_X86_IO_APIC


64 
__öô
 
	$nvidü_h≥t_check
(
a˝i_èbÀ_hódî
 *
hódî
)

67 
	}
}

71 
__öô
 
	$nvidü_bugs
(
num
, 
¶Ÿ
, 
func
)

73 #ifde‡
CONFIG_ACPI


74 #ifde‡
CONFIG_X86_IO_APIC


82 i‡(
a˝i_u£_timî_ovîride
)

85 i‡(
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
nvidü_h≥t_check
)) {

86 
a˝i_skù_timî_ovîride
 = 1;

87 
	`¥ötk
(
KERN_INFO
 "Nvidia board "

90 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

97 
	}
}

99 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

100 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

101 
u32
 
__öô
 
	$©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
)

103 
u32
 
d
;

104 
u8
 
b
;

106 
b
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac);

107 
b
 &= ~(1<<5);

108 
	`wrôe_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac, 
b
);

110 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

111 
d
 |= 1<<8;

112 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

114 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

115 
d
 &= 0xff;

116  
d
;

117 
	}
}

120 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

122 
u32
 
d
;

123 
u8
 
b
;

125 i‡(
a˝i_u£_timî_ovîride
)

128 
d
 = 
	`©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
);

129 i‡(
d
 < 0x82)

130 
a˝i_skù_timî_ovîride
 = 1;

133 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

134 i‡(!(
b
 & 0x2))

135 
a˝i_skù_timî_ovîride
 = 1;

138 i‡(
a˝i_skù_timî_ovîride
) {

139 
	`¥ötk
(
KERN_INFO
 "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

140 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

141 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

144 
	}
}

146 
u32
 
__öô
 
	$©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
)

148 
u32
 
ﬁd
, 
d
;

150 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

151 
ﬁd
 = 
d
;

152 
d
 &= ~(1<<8);

153 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

154 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

155 
d
 &= 0xff;

156 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
ﬁd
);

158  
d
;

159 
	}
}

161 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

163 
u32
 
d
, 
ªv
;

165 i‡(
a˝i_u£_timî_ovîride
)

168 
ªv
 = 
	`©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
);

169 i‡(
ªv
 > 0x13)

173 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x64);

174 i‡(!(
d
 & (1<<14)))

175 
a˝i_skù_timî_ovîride
 = 1;

177 i‡(
a˝i_skù_timî_ovîride
) {

178 
	`¥ötk
(
KERN_INFO
 "SB600Ñevisi⁄ 0x%x\n", 
ªv
);

179 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

180 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

183 
	}
}

185 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

187 
	}
}

189 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

191 
	}
}

194 
	#QFLAG_APPLY_ONCE
 0x1

	)

195 
	#QFLAG_APPLIED
 0x2

	)

196 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

197 
	schù£t
 {

198 
u32
 
	mvíd‹
;

199 
u32
 
	mdevi˚
;

200 
u32
 
	m˛ass
;

201 
u32
 
	m˛ass_mask
;

202 
u32
 
	mÊags
;

203 (*
	mf
)(
	mnum
, 
	m¶Ÿ
, 
	mfunc
);

212 
chù£t
 
	góæy_qrk
[] 
	g__öôd©a
 = {

213 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

214 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidü_bugs
 },

215 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

216 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vü_bugs
 },

217 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

218 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy≥πøn•‹t_c⁄fig
 },

219 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

220 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

221 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

222 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_c⁄td
 },

237 
__öô
 
	$check_dev_quúk
(
num
, 
¶Ÿ
, 
func
)

239 
u16
 
˛ass
;

240 
u16
 
víd‹
;

241 
u16
 
devi˚
;

242 
u8
 
ty≥
;

243 
i
;

245 
˛ass
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_CLASS_DEVICE
);

247 i‡(
˛ass
 == 0xffff)

250 
víd‹
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_VENDOR_ID
);

252 
devi˚
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_DEVICE_ID
);

254 
i
 = 0; 
óæy_qrk
[i].
f
 !
NULL
; i++) {

255 i‡(((
óæy_qrk
[
i
].
víd‹
 =
PCI_ANY_ID
) ||

256 (
óæy_qrk
[
i
].
víd‹
 == vendor)) &&

257 ((
óæy_qrk
[
i
].
devi˚
 =
PCI_ANY_ID
) ||

258 (
óæy_qrk
[
i
].
devi˚
 == device)) &&

259 (!((
óæy_qrk
[
i
].
˛ass
 ^ class) &

260 
óæy_qrk
[
i
].
˛ass_mask
))) {

261 i‡((
óæy_qrk
[
i
].
Êags
 &

262 
QFLAG_DONE
) != QFLAG_DONE)

263 
óæy_qrk
[
i
].
	`f
(
num
, 
¶Ÿ
, 
func
);

264 
óæy_qrk
[
i
].
Êags
 |
QFLAG_APPLIED
;

268 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

269 
PCI_HEADER_TYPE
);

270 i‡(!(
ty≥
 & 0x80))

274 
	}
}

276 
__öô
 
	$óæy_quúks
()

278 
¶Ÿ
, 
func
;

280 i‡(!
	`óæy_pci_Ælowed
())

285 
¶Ÿ
 = 0; slot < 32; slot++)

286 
func
 = 0; func < 8; func++) {

288 i‡(
	`check_dev_quúk
(0, 
¶Ÿ
, 
func
))

291 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<löux/c⁄sﬁe.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/s¸ìn_öfo.h
>

6 
	~<löux/usb/ch9.h
>

7 
	~<löux/pci_ªgs.h
>

8 
	~<löux/pci_ids.h
>

9 
	~<löux/î∫o.h
>

10 
	~<asm/io.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/f˙é.h
>

13 
	~<asm/£tup.h
>

14 
	~<xí/hvc-c⁄sﬁe.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/fixm≠.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<löux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcuºít_ypos
 = 25, 
	gcuºít_xpos
;

26 
	$óæy_vga_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
°r
++Ë!'\0' && 
n
-- > 0) {

32 i‡(
cuºít_ypos
 >
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wrôew
(
	`ªadw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wrôew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cuºít_ypos
 = 
max_ypos
-1;

44 i‡(
c
 == '\n') {

45 
cuºít_xpos
 = 0;

46 
cuºít_ypos
++;

47 } i‡(
c
 != '\r') {

48 
	`wrôew
(((0x7 << 8Ë| (Ë
c
),

49 
VGABASE
 + 2*(
max_xpos
*
cuºít_ypos
 +

50 
cuºít_xpos
++));

51 i‡(
cuºít_xpos
 >
max_xpos
) {

52 
cuºít_xpos
 = 0;

53 
cuºít_ypos
++;

57 
	}
}

59 
c⁄sﬁe
 
	góæy_vga_c⁄sﬁe
 = {

60 .
«me
 = "earlyvga",

61 .
	gwrôe
 = 
óæy_vga_wrôe
,

62 .
	gÊags
 = 
CON_PRINTBUFFER
,

63 .
	gödex
 = -1,

68 
	góæy_£rül_ba£
 = 0x3f8;

70 
	#XMTRDY
 0x20

	)

72 
	#DLAB
 0x80

	)

74 
	#TXR
 0

	)

75 
	#RXR
 0

	)

76 
	#IER
 1

	)

77 
	#IIR
 2

	)

78 
	#FCR
 2

	)

79 
	#LCR
 3

	)

80 
	#MCR
 4

	)

81 
	#LSR
 5

	)

82 
	#MSR
 6

	)

83 
	#DLL
 0

	)

84 
	#DLH
 1

	)

86 
	$óæy_£rül_putc
(
ch
)

88 
timeout
 = 0xffff;

90 (
	`öb
(
óæy_£rül_ba£
 + 
LSR
Ë& 
XMTRDY
Ë=0 && --
timeout
)

91 
	`˝u_ªœx
();

92 
	`outb
(
ch
, 
óæy_£rül_ba£
 + 
TXR
);

93  
timeout
 ? 0 : -1;

94 
	}
}

96 
	$óæy_£rül_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
s
, 
n
)

98 *
s
 && 
n
-- > 0) {

99 i‡(*
s
 == '\n')

100 
	`óæy_£rül_putc
('\r');

101 
	`óæy_£rül_putc
(*
s
);

102 
s
++;

104 
	}
}

106 
	#DEFAULT_BAUD
 9600

	)

108 
__öô
 
	$óæy_£rül_öô
(*
s
)

110 
c
;

111 
divis‹
;

112 
baud
 = 
DEFAULT_BAUD
;

113 *
e
;

115 i‡(*
s
 == ',')

116 ++
s
;

118 i‡(*
s
) {

119 
p‹t
;

120 i‡(!
	`°∫cmp
(
s
, "0x", 2)) {

121 
óæy_£rül_ba£
 = 
	`sim∂e_°πoul
(
s
, &
e
, 16);

123 c⁄° 
__öôc⁄°
 
ba£s
[] = { 0x3f8, 0x2f8 };

125 i‡(!
	`°∫cmp
(
s
, "ttyS", 4))

126 
s
 += 4;

127 
p‹t
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

128 i‡(
p‹t
 > 1 || 
s
 =
e
)

129 
p‹t
 = 0;

130 
óæy_£rül_ba£
 = 
ba£s
[
p‹t
];

132 
s
 +
	`°rc•n
(s, ",");

133 i‡(*
s
 == ',')

134 
s
++;

137 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
LCR
);

138 
	`outb
(0, 
óæy_£rül_ba£
 + 
IER
);

139 
	`outb
(0, 
óæy_£rül_ba£
 + 
FCR
);

140 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
MCR
);

142 i‡(*
s
) {

143 
baud
 = 
	`sim∂e_°πoul
(
s
, &
e
, 0);

144 i‡(
baud
 =0 || 
s
 =
e
)

145 
baud
 = 
DEFAULT_BAUD
;

148 
divis‹
 = 115200 / 
baud
;

149 
c
 = 
	`öb
(
óæy_£rül_ba£
 + 
LCR
);

150 
	`outb
(
c
 | 
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

151 
	`outb
(
divis‹
 & 0xff, 
óæy_£rül_ba£
 + 
DLL
);

152 
	`outb
((
divis‹
 >> 8Ë& 0xff, 
óæy_£rül_ba£
 + 
DLH
);

153 
	`outb
(
c
 & ~
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

154 
	}
}

156 
c⁄sﬁe
 
	góæy_£rül_c⁄sﬁe
 = {

157 .
«me
 = "earlyser",

158 .
	gwrôe
 = 
óæy_£rül_wrôe
,

159 .
	gÊags
 = 
CON_PRINTBUFFER
,

160 .
	gödex
 = -1,

164 
c⁄sﬁe
 *
	góæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

165 
__öôd©a
 
	góæy_c⁄sﬁe_öôülized
;

167 
asmlökage
 
	$óæy_¥ötk
(c⁄° *
fmt
, ...)

169 
buf
[512];

170 
n
;

171 
va_li°
 
≠
;

173 
	`va_°¨t
(
≠
, 
fmt
);

174 
n
 = 
	`vs˙¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

175 
óæy_c⁄sﬁe
->
	`wrôe
”¨ly_c⁄sﬁe, 
buf
, 
n
);

176 
	`va_íd
(
≠
);

177 
	}
}

179 
ölöe
 
	$óæy_c⁄sﬁe_ªgi°î
(
c⁄sﬁe
 *
c⁄
, 
kìp_óæy
)

181 i‡(
óæy_c⁄sﬁe
->
ödex
 != -1) {

182 
	`¥ötk
(
KERN_CRIT
 "ERROR:Éarlyprintk= %sálready used\n",

183 
c⁄
->
«me
);

186 
óæy_c⁄sﬁe
 = 
c⁄
;

187 i‡(
kìp_óæy
)

188 
óæy_c⁄sﬁe
->
Êags
 &~
CON_BOOT
;

190 
óæy_c⁄sﬁe
->
Êags
 |
CON_BOOT
;

191 
	`ªgi°î_c⁄sﬁe
(
óæy_c⁄sﬁe
);

192 
	}
}

194 
__öô
 
	$£tup_óæy_¥ötk
(*
buf
)

196 
kìp
;

198 i‡(!
buf
)

201 i‡(
óæy_c⁄sﬁe_öôülized
)

203 
óæy_c⁄sﬁe_öôülized
 = 1;

205 
kìp
 = (
	`°r°r
(
buf
, "kìp"Ë!
NULL
);

207 *
buf
 != '\0') {

208 i‡(!
	`°∫cmp
(
buf
, "serial", 6)) {

209 
buf
 += 6;

210 
	`óæy_£rül_öô
(
buf
);

211 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

212 i‡(!
	`°∫cmp
(
buf
, ",ttyS", 5))

213 
buf
 += 5;

215 i‡(!
	`°∫cmp
(
buf
, "ttyS", 4)) {

216 
	`óæy_£rül_öô
(
buf
 + 4);

217 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

219 i‡(!
	`°∫cmp
(
buf
, "vga", 3) &&

220 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_isVGA
 == 1) {

221 
max_xpos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_cﬁs
;

222 
max_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_löes
;

223 
cuºít_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_y
;

224 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_vga_c⁄sﬁe
, 
kìp
);

226 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


227 i‡(!
	`°∫cmp
(
buf
, "dbgp", 4Ë&& !
	`óæy_dbgp_öô
(buf + 4))

228 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_dbgp_c⁄sﬁe
, 
kìp
);

230 #ifde‡
CONFIG_HVC_XEN


231 i‡(!
	`°∫cmp
(
buf
, "xen", 3))

232 
	`óæy_c⁄sﬁe_ªgi°î
(&
xíboŸ_c⁄sﬁe
, 
kìp
);

234 
buf
++;

237 
	}
}

239 
óæy_∑øm
("óæy¥ötk", 
£tup_óæy_¥ötk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/efi.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/•ölock.h
>

34 
	~<löux/uac˚ss.h
>

35 
	~<löux/time.h
>

36 
	~<löux/io.h
>

37 
	~<löux/ªboŸ.h
>

38 
	~<löux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ˇcheÊush.h
>

44 
	~<asm/ébÊush.h
>

45 
	~<asm/x86_öô.h
>

47 
	#EFI_DEBUG
 1

	)

48 
	#PFX
 "EFI: "

	)

50 
	gefi_íabÀd
;

51 
EXPORT_SYMBOL
(
efi_íabÀd
);

53 
efi
 
	gefi
;

54 
EXPORT_SYMBOL
(
efi
);

56 
efi_mem‹y_m≠
 
	gmemm≠
;

58 
efi
 
efi_phys
 
	g__öôd©a
;

59 
efi_sy°em_èbÀ_t
 
efi_sy°ab
 
	g__öôd©a
;

61 
__öô
 
	$£tup_n€fi
(*
¨g
)

63 
efi_íabÀd
 = 0;

65 
	}
}

66 
óæy_∑øm
("n€fi", 
£tup_n€fi
);

68 
	gadd_efi_memm≠
;

69 
EXPORT_SYMBOL
(
add_efi_memm≠
);

71 
__öô
 
	$£tup_add_efi_memm≠
(*
¨g
)

73 
add_efi_memm≠
 = 1;

75 
	}
}

76 
óæy_∑øm
("add_efi_memm≠", 
£tup_add_efi_memm≠
);

79 
efi_°©us_t
 
	$vút_efi_gë_time
(
efi_time_t
 *
tm
, 
efi_time_ˇp_t
 *
tc
)

81  
	`efi_ˇŒ_vút2
(
gë_time
, 
tm
, 
tc
);

82 
	}
}

84 
efi_°©us_t
 
	$vút_efi_£t_time
(
efi_time_t
 *
tm
)

86  
	`efi_ˇŒ_vút1
(
£t_time
, 
tm
);

87 
	}
}

89 
efi_°©us_t
 
	$vút_efi_gë_wakeup_time
(
efi_boﬁ_t
 *
íabÀd
,

90 
efi_boﬁ_t
 *
≥ndög
,

91 
efi_time_t
 *
tm
)

93  
	`efi_ˇŒ_vút3
(
gë_wakeup_time
,

94 
íabÀd
, 
≥ndög
, 
tm
);

95 
	}
}

97 
efi_°©us_t
 
	$vút_efi_£t_wakeup_time
(
efi_boﬁ_t
 
íabÀd
, 
efi_time_t
 *
tm
)

99  
	`efi_ˇŒ_vút2
(
£t_wakeup_time
,

100 
íabÀd
, 
tm
);

101 
	}
}

103 
efi_°©us_t
 
	$vút_efi_gë_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

104 
efi_guid_t
 *
víd‹
,

105 
u32
 *
©å
,

106 *
d©a_size
,

107 *
d©a
)

109  
	`efi_ˇŒ_vút5
(
gë_v¨übÀ
,

110 
«me
, 
víd‹
, 
©å
,

111 
d©a_size
, 
d©a
);

112 
	}
}

114 
efi_°©us_t
 
	$vút_efi_gë_√xt_v¨übÀ
(*
«me_size
,

115 
efi_ch¨16_t
 *
«me
,

116 
efi_guid_t
 *
víd‹
)

118  
	`efi_ˇŒ_vút3
(
gë_√xt_v¨übÀ
,

119 
«me_size
, 
«me
, 
víd‹
);

120 
	}
}

122 
efi_°©us_t
 
	$vút_efi_£t_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

123 
efi_guid_t
 *
víd‹
,

124 
©å
,

125 
d©a_size
,

126 *
d©a
)

128  
	`efi_ˇŒ_vút5
(
£t_v¨übÀ
,

129 
«me
, 
víd‹
, 
©å
,

130 
d©a_size
, 
d©a
);

131 
	}
}

133 
efi_°©us_t
 
	$vút_efi_gë_√xt_high_m⁄o_cou¡
(
u32
 *
cou¡
)

135  
	`efi_ˇŒ_vút1
(
gë_√xt_high_m⁄o_cou¡
, 
cou¡
);

136 
	}
}

138 
	$vút_efi_ª£t_sy°em
(
ª£t_ty≥
,

139 
efi_°©us_t
 
°©us
,

140 
d©a_size
,

141 
efi_ch¨16_t
 *
d©a
)

143 
	`efi_ˇŒ_vút4
(
ª£t_sy°em
, 
ª£t_ty≥
, 
°©us
,

144 
d©a_size
, 
d©a
);

145 
	}
}

147 
efi_°©us_t
 
	$vút_efi_£t_vútuÆ_addªss_m≠
(

148 
mem‹y_m≠_size
,

149 
des¸ùt‹_size
,

150 
u32
 
des¸ùt‹_vîsi⁄
,

151 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

153  
	`efi_ˇŒ_vút4
(
£t_vútuÆ_addªss_m≠
,

154 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

155 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

156 
	}
}

158 
efi_°©us_t
 
__öô
 
	$phys_efi_£t_vútuÆ_addªss_m≠
(

159 
mem‹y_m≠_size
,

160 
des¸ùt‹_size
,

161 
u32
 
des¸ùt‹_vîsi⁄
,

162 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

164 
efi_°©us_t
 
°©us
;

166 
	`efi_ˇŒ_phys_¥ñog
();

167 
°©us
 = 
	`efi_ˇŒ_phys4
(
efi_phys
.
£t_vútuÆ_addªss_m≠
,

168 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

169 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

170 
	`efi_ˇŒ_phys_ïûog
();

171  
°©us
;

172 
	}
}

174 
efi_°©us_t
 
__öô
 
	$phys_efi_gë_time
(
efi_time_t
 *
tm
,

175 
efi_time_ˇp_t
 *
tc
)

177 
efi_°©us_t
 
°©us
;

179 
	`efi_ˇŒ_phys_¥ñog
();

180 
°©us
 = 
	`efi_ˇŒ_phys2
(
efi_phys
.
gë_time
, 
tm
, 
tc
);

181 
	`efi_ˇŒ_phys_ïûog
();

182  
°©us
;

183 
	}
}

185 
	$efi_£t_πc_mmss
(
nowtime
)

187 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
;

188 
efi_°©us_t
 
°©us
;

189 
efi_time_t
 
e·
;

190 
efi_time_ˇp_t
 
ˇp
;

192 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

193 i‡(
°©us
 !
EFI_SUCCESS
) {

194 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

198 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

199 
ªÆ_möuãs
 = 
nowtime
 / 60;

200 i‡(((
	`abs
(
ªÆ_möuãs
 - 
e·
.
möuã
) + 15)/30) & 1)

201 
ªÆ_möuãs
 += 30;

202 
ªÆ_möuãs
 %= 60;

203 
e·
.
möuã
 = 
ªÆ_möuãs
;

204 
e·
.
£c⁄d
 = 
ªÆ_£c⁄ds
;

206 
°©us
 = 
efi
.
	`£t_time
(&
e·
);

207 i‡(
°©us
 !
EFI_SUCCESS
) {

208 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can't writeÅime!\n");

212 
	}
}

214 
	$efi_gë_time
()

216 
efi_°©us_t
 
°©us
;

217 
efi_time_t
 
e·
;

218 
efi_time_ˇp_t
 
ˇp
;

220 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

221 i‡(
°©us
 !
EFI_SUCCESS
)

222 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

224  
	`mktime
(
e·
.
yór
,É·.
m⁄th
,É·.
day
,É·.
hour
,

225 
e·
.
möuã
,É·.
£c⁄d
);

226 
	}
}

234 
__öô
 
	$do_add_efi_memm≠
()

236 *
p
;

238 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

239 
efi_mem‹y_desc_t
 *
md
 = 
p
;

240 
°¨t
 = 
md
->
phys_addr
;

241 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

242 
e820_ty≥
;

244 
md
->
ty≥
) {

245 
EFI_LOADER_CODE
:

246 
EFI_LOADER_DATA
:

247 
EFI_BOOT_SERVICES_CODE
:

248 
EFI_BOOT_SERVICES_DATA
:

249 
EFI_CONVENTIONAL_MEMORY
:

250 i‡(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)

251 
e820_ty≥
 = 
E820_RAM
;

253 
e820_ty≥
 = 
E820_RESERVED
;

255 
EFI_ACPI_RECLAIM_MEMORY
:

256 
e820_ty≥
 = 
E820_ACPI
;

258 
EFI_ACPI_MEMORY_NVS
:

259 
e820_ty≥
 = 
E820_NVS
;

261 
EFI_UNUSABLE_MEMORY
:

262 
e820_ty≥
 = 
E820_UNUSABLE
;

270 
e820_ty≥
 = 
E820_RESERVED
;

273 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
e820_ty≥
);

275 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

276 
	}
}

278 
__öô
 
	$efi_ª£rve_óæy
()

280 
pm≠
;

282 #ifde‡
CONFIG_X86_32


283 
pm≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
;

285 
pm≠
 = (
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
 |

286 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_hi
<<32));

288 
memm≠
.
phys_m≠
 = (*)
pm≠
;

289 
memm≠
.
ƒ_m≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_size
 /

290 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

291 
memm≠
.
desc_vîsi⁄
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_vîsi⁄
;

292 
memm≠
.
desc_size
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

293 
	`ª£rve_óæy
(
pm≠
,Öm≠ + 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
,

295 
	}
}

297 #i‡
EFI_DEBUG


298 
__öô
 
	$¥öt_efi_memm≠
()

300 
efi_mem‹y_desc_t
 *
md
;

301 *
p
;

302 
i
;

304 
p
 = 
memm≠
.
m≠
, 
i
 = 0;

305 
p
 < 
memm≠
.
m≠_íd
;

306 
p
 +
memm≠
.
desc_size
, 
i
++) {

307 
md
 = 
p
;

308 
	`¥ötk
(
KERN_INFO
 
PFX
 "mem%02u:Åype=%u,áttr=0x%llx, "

310 
i
, 
md
->
ty≥
, md->
©åibuã
, md->
phys_addr
,

311 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
),

312 (
md
->
num_∑ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

314 
	}
}

317 
__öô
 
	$efi_öô
()

319 
efi_c⁄fig_èbÀ_t
 *
c⁄fig_èbÀs
;

320 
efi_ru¡ime_£rvi˚s_t
 *
ru¡ime
;

321 
efi_ch¨16_t
 *
c16
;

322 
víd‹
[100] = "unknown";

323 
i
 = 0;

324 *
tmp
;

326 #ifde‡
CONFIG_X86_32


327 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
;

329 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)

330 (
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
 |

331 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab_hi
<<32));

334 
efi
.
sy°ab
 = 
	`óæy_i‹em≠
(()
efi_phys
.systab,

335 (
efi_sy°em_èbÀ_t
));

336 i‡(
efi
.
sy°ab
 =
NULL
)

337 
	`¥ötk
(
KERN_ERR
 "Couldn't mapÅhe EFI systemÅable!\n");

338 
	`mem˝y
(&
efi_sy°ab
, 
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

339 
	`óæy_iounm≠
(
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

340 
efi
.
sy°ab
 = &
efi_sy°ab
;

345 i‡(
efi
.
sy°ab
->
hdr
.
sig«tuª
 !
EFI_SYSTEM_TABLE_SIGNATURE
)

346 
	`¥ötk
(
KERN_ERR
 "EFI systemÅable signature incorrect!\n");

347 i‡((
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16) == 0)

348 
	`¥ötk
(
KERN_ERR
 "Warning: EFI systemÅable version "

350 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

351 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff);

356 
c16
 = 
tmp
 = 
	`óæy_i‹em≠
(
efi
.
sy°ab
->
fw_víd‹
, 2);

357 i‡(
c16
) {

358 
i
 = 0; i < (
víd‹
Ë- 1 && *
c16
; ++i)

359 
víd‹
[
i
] = *
c16
++;

360 
víd‹
[
i
] = '\0';

362 
	`¥ötk
(
KERN_ERR
 
PFX
 "CouldÇot mapÅhe firmware vendor!\n");

363 
	`óæy_iounm≠
(
tmp
, 2);

365 
	`¥ötk
(
KERN_INFO
 "EFI v%u.%.02u by %s\n",

366 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

367 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff, 
víd‹
);

372 
c⁄fig_èbÀs
 = 
	`óæy_i‹em≠
(

373 
efi
.
sy°ab
->
èbÀs
,

374 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

375 i‡(
c⁄fig_èbÀs
 =
NULL
)

376 
	`¥ötk
(
KERN_ERR
 "CouldÇot map EFI Configuration Table!\n");

378 
	`¥ötk
(
KERN_INFO
);

379 
i
 = 0; i < 
efi
.
sy°ab
->
ƒ_èbÀs
; i++) {

380 i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

381 
efi
.
mps
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

382 
	`¥ötk
(" MPS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

383 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

384 
ACPI_20_TABLE_GUID
)) {

385 
efi
.
a˝i20
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

386 
	`¥ötk
(" ACPI 2.0=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

387 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

388 
ACPI_TABLE_GUID
)) {

389 
efi
.
a˝i
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

390 
	`¥ötk
(" ACPI=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

391 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

392 
SMBIOS_TABLE_GUID
)) {

393 
efi
.
smbios
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

394 
	`¥ötk
(" SMBIOS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

395 #ifde‡
CONFIG_X86_UV


396 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

397 
UV_SYSTEM_TABLE_GUID
)) {

398 
efi
.
uv_sy°ab
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

399 
	`¥ötk
(" UVsy°ab=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

401 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

402 
HCDP_TABLE_GUID
)) {

403 
efi
.
hcdp
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

404 
	`¥ötk
(" HCDP=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

405 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

406 
UGA_IO_PROTOCOL_GUID
)) {

407 
efi
.
uga
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

408 
	`¥ötk
(" UGA=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

411 
	`¥ötk
("\n");

412 
	`óæy_iounm≠
(
c⁄fig_èbÀs
,

413 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

421 
ru¡ime
 = 
	`óæy_i‹em≠
(()
efi
.
sy°ab
->runtime,

422 (
efi_ru¡ime_£rvi˚s_t
));

423 i‡(
ru¡ime
 !
NULL
) {

429 
efi_phys
.
gë_time
 = (
efi_gë_time_t
 *)
ru¡ime
->get_time;

430 
efi_phys
.
£t_vútuÆ_addªss_m≠
 =

431 (
efi_£t_vútuÆ_addªss_m≠_t
 *)

432 
ru¡ime
->
£t_vútuÆ_addªss_m≠
;

437 
efi
.
gë_time
 = 
phys_efi_gë_time
;

439 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFIÑuntime service "

441 
	`óæy_iounm≠
(
ru¡ime
, (
efi_ru¡ime_£rvi˚s_t
));

444 
memm≠
.
m≠
 = 
	`óæy_i‹em≠
(()memm≠.
phys_m≠
,

445 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
);

446 i‡(
memm≠
.
m≠
 =
NULL
)

447 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFI memory map!\n");

448 
memm≠
.
m≠_íd
 = memm≠.
m≠
 + (memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

450 i‡(
memm≠
.
desc_size
 !(
efi_mem‹y_desc_t
))

451 
	`¥ötk
(
KERN_WARNING


454 i‡(
add_efi_memm≠
)

455 
	`do_add_efi_memm≠
();

457 #ifde‡
CONFIG_X86_32


458 
x86_∂©f‹m
.
gë_wÆl˛ock
 = 
efi_gë_time
;

459 
x86_∂©f‹m
.
£t_wÆl˛ock
 = 
efi_£t_πc_mmss
;

463 
ªboŸ_ty≥
 = 
BOOT_EFI
;

465 #i‡
EFI_DEBUG


466 
	`¥öt_efi_memm≠
();

468 
	}
}

470 
__öô
 
	$ru¡ime_code_∑ge_mkexec
()

472 
efi_mem‹y_desc_t
 *
md
;

473 *
p
;

474 
u64
 
addr
, 
≈ages
;

477 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

478 
md
 = 
p
;

480 i‡(
md
->
ty≥
 !
EFI_RUNTIME_SERVICES_CODE
)

483 
addr
 = 
md
->
vút_addr
;

484 
≈ages
 = 
md
->
num_∑ges
;

485 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

486 
	`£t_mem‹y_x
(
addr
, 
≈ages
);

488 
	}
}

498 
__öô
 
	$efi_íãr_vútuÆ_mode
()

500 
efi_mem‹y_desc_t
 *
md
;

501 
efi_°©us_t
 
°©us
;

502 
size
;

503 
u64
 
íd
, 
sy°ab
, 
addr
, 
≈ages
, 
íd_p‚
;

504 *
p
, *
va
;

506 
efi
.
sy°ab
 = 
NULL
;

507 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

508 
md
 = 
p
;

509 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_RUNTIME
))

512 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

513 
íd
 = 
md
->
phys_addr
 + 
size
;

515 
íd_p‚
 = 
	`PFN_UP
(
íd
);

516 i‡(
íd_p‚
 <
max_low_p‚_m≠≥d


517 || (
íd_p‚
 > (1UL << (32 - 
PAGE_SHIFT
))

518 && 
íd_p‚
 <
max_p‚_m≠≥d
))

519 
va
 = 
	`__va
(
md
->
phys_addr
);

521 
va
 = 
	`efi_i‹em≠
(
md
->
phys_addr
, 
size
, md->
ty≥
);

523 
md
->
vút_addr
 = (
u64
Ë(Ë
va
;

525 i‡(!
va
) {

526 
	`¥ötk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

527 ()
md
->
phys_addr
);

531 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)) {

532 
addr
 = 
md
->
vút_addr
;

533 
≈ages
 = 
md
->
num_∑ges
;

534 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

535 
	`£t_mem‹y_uc
(
addr
, 
≈ages
);

538 
sy°ab
 = (
u64
Ë(Ë
efi_phys
.systab;

539 i‡(
md
->
phys_addr
 <
sy°ab
 && sy°ab < 
íd
) {

540 
sy°ab
 +
md
->
vút_addr
 - md->
phys_addr
;

541 
efi
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *) () systab;

545 
	`BUG_ON
(!
efi
.
sy°ab
);

547 
°©us
 = 
	`phys_efi_£t_vútuÆ_addªss_m≠
(

548 
memm≠
.
desc_size
 * memm≠.
ƒ_m≠
,

549 
memm≠
.
desc_size
,

550 
memm≠
.
desc_vîsi⁄
,

551 
memm≠
.
phys_m≠
);

553 i‡(
°©us
 !
EFI_SUCCESS
) {

554 
	`¥ötk
(
KERN_ALERT
 "UnableÅo switch EFI into virtual mode "

555 "(°©us=%lx)!\n", 
°©us
);

556 
	`∑nic
("EFI callÅo SetVirtualAddressMap() failed!");

565 
efi
.
gë_time
 = 
vút_efi_gë_time
;

566 
efi
.
£t_time
 = 
vút_efi_£t_time
;

567 
efi
.
gë_wakeup_time
 = 
vút_efi_gë_wakeup_time
;

568 
efi
.
£t_wakeup_time
 = 
vút_efi_£t_wakeup_time
;

569 
efi
.
gë_v¨übÀ
 = 
vút_efi_gë_v¨übÀ
;

570 
efi
.
gë_√xt_v¨übÀ
 = 
vút_efi_gë_√xt_v¨übÀ
;

571 
efi
.
£t_v¨übÀ
 = 
vút_efi_£t_v¨übÀ
;

572 
efi
.
gë_√xt_high_m⁄o_cou¡
 = 
vút_efi_gë_√xt_high_m⁄o_cou¡
;

573 
efi
.
ª£t_sy°em
 = 
vút_efi_ª£t_sy°em
;

574 
efi
.
£t_vútuÆ_addªss_m≠
 = 
vút_efi_£t_vútuÆ_addªss_m≠
;

575 i‡(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
)

576 
	`ru¡ime_code_∑ge_mkexec
();

577 
	`óæy_iounm≠
(
memm≠
.
m≠
, memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

578 
memm≠
.
m≠
 = 
NULL
;

579 
	}
}

584 
u32
 
	$efi_mem_ty≥
(
phys_addr
)

586 
efi_mem‹y_desc_t
 *
md
;

587 *
p
;

589 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

590 
md
 = 
p
;

591 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

592 (
phys_addr
 < (
md
->phys_addr +

593 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

594  
md
->
ty≥
;

597 
	}
}

599 
u64
 
	$efi_mem_©åibuãs
(
phys_addr
)

601 
efi_mem‹y_desc_t
 *
md
;

602 *
p
;

604 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

605 
md
 = 
p
;

606 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

607 (
phys_addr
 < (
md
->phys_addr +

608 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

609  
md
->
©åibuã
;

612 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/efi.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/ªboŸ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/fixm≠.h
>

41 
pgd_t
 
ßve_pgd
 
	g__öôd©a
;

42 
efi_Êags
 
	g__öôd©a
;

44 
__öô
 
	$óæy_m≠pög_£t_exec
(
°¨t
,

45 
íd
,

46 
execuèbÀ
)

48 
num_∑ges
;

50 
°¨t
 &
PMD_MASK
;

51 
íd
 = (íd + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

52 
num_∑ges
 = (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

53 i‡(
execuèbÀ
)

54 
	`£t_mem‹y_x
(()
	`__va
(
°¨t
), 
num_∑ges
);

56 
	`£t_mem‹y_nx
(()
	`__va
(
°¨t
), 
num_∑ges
);

57 
	}
}

59 
__öô
 
	$óæy_ru¡ime_code_m≠pög_£t_exec
(
execuèbÀ
)

61 
efi_mem‹y_desc_t
 *
md
;

62 *
p
;

64 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

69 
md
 = 
p
;

70 i‡(
md
->
ty≥
 =
EFI_RUNTIME_SERVICES_CODE
) {

71 
íd
;

72 
íd
 = 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
);

73 
	`óæy_m≠pög_£t_exec
(
md
->
phys_addr
, 
íd
, 
execuèbÀ
);

76 
	}
}

78 
__öô
 
	$efi_ˇŒ_phys_¥ñog
()

80 
vaddªss
;

82 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(1);

83 
	`loˇl_úq_ßve
(
efi_Êags
);

84 
vaddªss
 = ()
	`__va
(0x0UL);

85 
ßve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vaddªss
));

87 
	`__Êush_éb_Æl
();

88 
	}
}

90 
__öô
 
	$efi_ˇŒ_phys_ïûog
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
ßve_pgd
);

96 
	`__Êush_éb_Æl
();

97 
	`loˇl_úq_ª°‹e
(
efi_Êags
);

98 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__öô
 
	$efi_i‹em≠
(
phys_addr
, 
size
,

102 
u32
 
ty≥
)

104 
œ°_m≠_p‚
;

106 i‡(
ty≥
 =
EFI_MEMORY_MAPPED_IO
)

107  
	`i‹em≠
(
phys_addr
, 
size
);

109 
œ°_m≠_p‚
 = 
	`öô_mem‹y_m≠pög
(
phys_addr
,Öhys_add∏+ 
size
);

110 i‡((
œ°_m≠_p‚
 << 
PAGE_SHIFT
Ë< 
phys_addr
 + 
size
)

111  
NULL
;

113  (
__iomem
 *)
	`__va
(
phys_addr
);

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/öô.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__öô
 
	$ª£rve_ebda_ªgi⁄
()

21 
lowmem
, 
ebda_addr
;

29 i‡(
	`∑øvút_íabÀd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`gë_bios_ebda
();

41 i‡((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 i‡((
ebda_addr
 =0Ë&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 i‡((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`ª£rve_óæy_ovîœp_ok
(
lowmem
, 0x100000, "BIOSÑeserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<löux/öô.h
>

8 
	~<löux/lökage.h
>

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/≥r˝u.h
>

13 
	~<löux/°¨t_kî√l.h
>

14 
	~<löux/io.h
>

16 
	~<asm/¥o˚ss‹.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/£˘i⁄s.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/åampﬁöe.h
>

27 
	~<asm/bios_ebda.h
>

29 
__öô
 
	$z≠_idítôy_m≠pögs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_˛ór
(
pgd
);

33 
	`__Êush_éb_Æl
();

34 
	}
}

38 
__öô
 
	$˛ór_bss
()

40 
	`mem£t
(
__bss_°¨t
, 0,

41 (Ë
__bss_°›
 - (Ë
__bss_°¨t
);

42 
	}
}

44 
__öô
 
	$c›y_boŸd©a
(*
ªÆ_mode_d©a
)

46 * 
comm™d_löe
;

48 
	`mem˝y
(&
boŸ_∑øms
, 
ªÆ_mode_d©a
,  boot_params);

49 i‡(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
) {

50 
comm™d_löe
 = 
	`__va
(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
);

51 
	`mem˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__öô
 
	$x86_64_°¨t_kî√l
(* 
ªÆ_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1Ë& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vút
(
__íd_of_fixed_addªs£s
Ë<
MODULES_END
);

74 
	`˛ór_bss
();

77 
	`z≠_idítôy_m≠pögs
();

80 
	`˛ónup_highm≠
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifde‡
CONFIG_EARLY_PRINTK


84 
	`£t_öå_g©e
(
i
, &
óæy_idt_h™dÀrs
[i]);

86 
	`£t_öå_g©e
(
i
, 
óæy_idt_h™dÀr
);

89 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

91 i‡(
c⁄sﬁe_logÀvñ
 == 10)

92 
	`óæy_¥ötk
("Kernelálive\n");

94 
	`x86_64_°¨t_ª£rv©i⁄s
(
ªÆ_mode_d©a
);

95 
	}
}

97 
__öô
 
	$x86_64_°¨t_ª£rv©i⁄s
(*
ªÆ_mode_d©a
)

99 
	`c›y_boŸd©a
(
	`__va
(
ªÆ_mode_d©a
));

101 
	`ª£rve_óæy
(
	`__∑_symbﬁ
(&
_ãxt
), __∑_symbﬁ(&
__bss_°›
), "TEXT DATA BSS");

103 #ifde‡
CONFIG_BLK_DEV_INITRD


105 i‡(
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 && boŸ_∑øms.hdr.
ømdisk_image
) {

107 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

108 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

109 
ømdisk_íd
 = 
	`PAGE_ALIGN
(
ømdisk_image
 + 
ømdisk_size
);

110 
	`ª£rve_óæy
(
ømdisk_image
, 
ømdisk_íd
, "RAMDISK");

114 
	`ª£rve_ebda_ªgi⁄
();

122 
	`°¨t_kî√l
();

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<löux/˛ocksour˚.h
>

2 
	~<löux/˛ockchùs.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/sysdev.h
>

5 
	~<löux/dñay.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/h≥t.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/˝u.h
>

11 
	~<löux/pm.h
>

12 
	~<löux/io.h
>

14 
	~<asm/fixm≠.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

18 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

19 
	#HPET_SHIFT
 22

	)

23 
	#FSEC_PER_NSEC
 1000000L

	)

25 
	#HPET_DEV_USED_BIT
 2

	)

26 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

27 
	#HPET_DEV_VALID
 0x8

	)

28 
	#HPET_DEV_FSB_CAP
 0x1000

	)

29 
	#HPET_DEV_PERI_CAP
 0x2000

	)

31 
	#EVT_TO_HPET_DEV
(
evt
Ë
	`c⁄èöî_of
”vt, 
h≥t_dev
,Évt)

	)

36 
	gh≥t_addªss
;

37 
u8
 
	gh≥t_blockid
;

38 
u8
 
	gh≥t_msi_dißbÀ
;

40 #ifde‡
CONFIG_PCI_MSI


41 
	gh≥t_num_timîs
;

43 
__iomem
 *
	gh≥t_vút_addªss
;

45 
	sh≥t_dev
 {

46 
˛ock_evít_devi˚
 
	mevt
;

47 
	mnum
;

48 
	m˝u
;

49 
	múq
;

50 
	mÊags
;

51 
	m«me
[10];

54 
ölöe
 
	$h≥t_ªadl
(
a
)

56  
	`ªadl
(
h≥t_vút_addªss
 + 
a
);

57 
	}
}

59 
ölöe
 
	$h≥t_wrôñ
(
d
, 
a
)

61 
	`wrôñ
(
d
, 
h≥t_vút_addªss
 + 
a
);

62 
	}
}

64 #ifde‡
CONFIG_X86_64


65 
	~<asm/pgèbÀ.h
>

68 
ölöe
 
	$h≥t_£t_m≠pög
()

70 
h≥t_vút_addªss
 = 
	`i‹em≠_noˇche
(
h≥t_addªss
, 
HPET_MMAP_SIZE
);

71 #ifde‡
CONFIG_X86_64


72 
	`__£t_fixm≠
(
VSYSCALL_HPET
, 
h≥t_addªss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

74 
	}
}

76 
ölöe
 
	$h≥t_˛ór_m≠pög
()

78 
	`iounm≠
(
h≥t_vút_addªss
);

79 
h≥t_vút_addªss
 = 
NULL
;

80 
	}
}

85 
	gboŸ_h≥t_dißbÀ
;

86 
	gh≥t_f‹˚_u£r
;

87 
	gh≥t_vîbo£
;

89 
__öô
 
	$h≥t_£tup
(*
°r
)

91 i‡(
°r
) {

92 i‡(!
	`°∫cmp
("dißbÀ", 
°r
, 7))

93 
boŸ_h≥t_dißbÀ
 = 1;

94 i‡(!
	`°∫cmp
("f‹˚", 
°r
, 5))

95 
h≥t_f‹˚_u£r
 = 1;

96 i‡(!
	`°∫cmp
("vîbo£", 
°r
, 7))

97 
h≥t_vîbo£
 = 1;

100 
	}
}

101 
__£tup
("h≥t=", 
h≥t_£tup
);

103 
__öô
 
	$dißbÀ_h≥t
(*
°r
)

105 
boŸ_h≥t_dißbÀ
 = 1;

107 
	}
}

108 
__£tup
("noh≥t", 
dißbÀ_h≥t
);

110 
ölöe
 
	$is_h≥t_ˇ∑bÀ
()

112  !
boŸ_h≥t_dißbÀ
 && 
h≥t_addªss
;

113 
	}
}

118 
	gh≥t_Àgacy_öt_íabÀd
;

123 
	$is_h≥t_íabÀd
()

125  
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_Àgacy_öt_íabÀd
;

126 
	}
}

127 
EXPORT_SYMBOL_GPL
(
is_h≥t_íabÀd
);

129 
	$_h≥t_¥öt_c⁄fig
(c⁄° *
fun˘i⁄
, 
löe
)

131 
u32
 
i
, 
timîs
, 
l
, 
h
;

132 
	`¥ötk
(
KERN_INFO
 "h≥t: %s(%d):\n", 
fun˘i⁄
, 
löe
);

133 
l
 = 
	`h≥t_ªadl
(
HPET_ID
);

134 
h
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

135 
timîs
 = ((
l
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

136 
	`¥ötk
(
KERN_INFO
 "h≥t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

137 
l
 = 
	`h≥t_ªadl
(
HPET_CFG
);

138 
h
 = 
	`h≥t_ªadl
(
HPET_STATUS
);

139 
	`¥ötk
(
KERN_INFO
 "h≥t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

140 
l
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

141 
h
 = 
	`h≥t_ªadl
(
HPET_COUNTER
+4);

142 
	`¥ötk
(
KERN_INFO
 "h≥t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

144 
i
 = 0; i < 
timîs
; i++) {

145 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

146 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
)+4);

147 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

148 
i
, 
l
, 
h
);

149 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
));

150 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
)+4);

151 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

152 
i
, 
l
, 
h
);

153 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
));

154 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
)+4);

155 
	`¥ötk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

156 
i
, 
l
, 
h
);

158 
	}
}

160 
	#h≥t_¥öt_c⁄fig
() \

162 i‡(
h≥t_vîbo£
) \

163 
	`_h≥t_¥öt_c⁄fig
(
__FUNCTION__
, 
__LINE__
); \

164 } 0)

	)

170 #ifde‡
CONFIG_HPET


172 
h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
);

174 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
)

176 
h≥t
 
__iomem
 *h≥à
h≥t_vút_addªss
;

177 
h≥t_timî
 
__iomem
 *
timî
 = &
h≥t
->
h≥t_timîs
[2];

178 
ƒtimîs
, 
i
;

179 
h≥t_d©a
 
hd
;

181 
ƒtimîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

183 
	`mem£t
(&
hd
, 0, (hd));

184 
hd
.
hd_phys_addªss
 = 
h≥t_addªss
;

185 
hd
.
hd_addªss
 = 
h≥t
;

186 
hd
.
hd_núqs
 = 
ƒtimîs
;

187 
	`h≥t_ª£rve_timî
(&
hd
, 0);

189 #ifde‡
CONFIG_HPET_EMULATE_RTC


190 
	`h≥t_ª£rve_timî
(&
hd
, 1);

198 
hd
.
hd_úq
[0] = 
HPET_LEGACY_8254
;

199 
hd
.
hd_úq
[1] = 
HPET_LEGACY_RTC
;

201 
i
 = 2; i < 
ƒtimîs
; 
timî
++, i++) {

202 
hd
.
hd_úq
[
i
] = (
	`ªadl
(&
timî
->
h≥t_c⁄fig
) &

203 
Tn_INT_ROUTE_CNF_MASK
Ë>> 
Tn_INT_ROUTE_CNF_SHIFT
;

206 
	`h≥t_ª£rve_msi_timîs
(&
hd
);

208 
	`h≥t_Æloc
(&
hd
);

210 
	}
}

212 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
Ë{ 
	}
}

218 
	gh≥t_≥riod
;

220 
h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

221 
˛ock_evít_devi˚
 *
evt
);

222 
h≥t_Àgacy_√xt_evít
(
dñè
,

223 
˛ock_evít_devi˚
 *
evt
);

228 
˛ock_evít_devi˚
 
	gh≥t_˛ockevít
 = {

229 .
«me
 = "hpet",

230 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

231 .
	g£t_mode
 = 
h≥t_Àgacy_£t_mode
,

232 .
	g£t_√xt_evít
 = 
h≥t_Àgacy_√xt_evít
,

233 .
	gshi·
 = 32,

234 .
	gúq
 = 0,

235 .
	gøtög
 = 50,

238 
	$h≥t_°›_cou¡î
()

240 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

241 
cfg
 &~
HPET_CFG_ENABLE
;

242 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

243 
	}
}

245 
	$h≥t_ª£t_cou¡î
()

247 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
);

248 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
 + 4);

249 
	}
}

251 
	$h≥t_°¨t_cou¡î
()

253 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

254 
cfg
 |
HPET_CFG_ENABLE
;

255 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

256 
	}
}

258 
	$h≥t_ª°¨t_cou¡î
()

260 
	`h≥t_°›_cou¡î
();

261 
	`h≥t_ª£t_cou¡î
();

262 
	`h≥t_°¨t_cou¡î
();

263 
	}
}

265 
	$h≥t_ªsume_devi˚
()

267 
	`f‹˚_h≥t_ªsume
();

268 
	}
}

270 
	$h≥t_ªsume_cou¡î
(
˛ocksour˚
 *
cs
)

272 
	`h≥t_ªsume_devi˚
();

273 
	`h≥t_ª°¨t_cou¡î
();

274 
	}
}

276 
	$h≥t_íabÀ_Àgacy_öt
()

278 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

280 
cfg
 |
HPET_CFG_LEGACY
;

281 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

282 
h≥t_Àgacy_öt_íabÀd
 = 1;

283 
	}
}

285 
	$h≥t_Àgacy_˛ockevít_ªgi°î
()

288 
	`h≥t_íabÀ_Àgacy_öt
();

298 
h≥t_˛ockevít
.
mu…
 = 
	`div_sc
((Ë
FSEC_PER_NSEC
,

299 
h≥t_≥riod
, 
h≥t_˛ockevít
.
shi·
);

301 
h≥t_˛ockevít
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,

302 &
h≥t_˛ockevít
);

304 
h≥t_˛ockevít
.
mö_dñè_ns
 = 5000;

310 
h≥t_˛ockevít
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

311 
	`˛ockevíts_ªgi°î_devi˚
(&
h≥t_˛ockevít
);

312 
globÆ_˛ock_evít
 = &
h≥t_˛ockevít
;

313 
	`¥ötk
(
KERN_DEBUG
 "hpet clockeventÑegistered\n");

314 
	}
}

316 
h≥t_£tup_msi_úq
(
úq
);

318 
	$h≥t_£t_mode
(
˛ock_evít_mode
 
mode
,

319 
˛ock_evít_devi˚
 *
evt
, 
timî
)

321 
cfg
, 
cmp
, 
now
;

322 
uöt64_t
 
dñè
;

324 
mode
) {

325 
CLOCK_EVT_MODE_PERIODIC
:

326 
	`h≥t_°›_cou¡î
();

327 
dñè
 = ((
uöt64_t
)(
NSEC_PER_SEC
/
HZ
)Ë* 
evt
->
mu…
;

328 
dñè
 >>
evt
->
shi·
;

329 
now
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

330 
cmp
 = 
now
 + (Ë
dñè
;

331 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

333 
cfg
 &~
HPET_TN_LEVEL
;

334 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

335 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

336 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

337 
	`h≥t_wrôñ
(
cmp
, 
	`HPET_Tn_CMP
(
timî
));

338 
	`udñay
(1);

346 
	`h≥t_wrôñ
((Ë
dñè
, 
	`HPET_Tn_CMP
(
timî
));

347 
	`h≥t_°¨t_cou¡î
();

348 
	`h≥t_¥öt_c⁄fig
();

351 
CLOCK_EVT_MODE_ONESHOT
:

352 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

353 
cfg
 &~
HPET_TN_PERIODIC
;

354 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

355 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

358 
CLOCK_EVT_MODE_UNUSED
:

359 
CLOCK_EVT_MODE_SHUTDOWN
:

360 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

361 
cfg
 &~
HPET_TN_ENABLE
;

362 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

365 
CLOCK_EVT_MODE_RESUME
:

366 i‡(
timî
 == 0) {

367 
	`h≥t_íabÀ_Àgacy_öt
();

369 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

370 
	`h≥t_£tup_msi_úq
(
hdev
->
úq
);

371 
	`dißbÀ_úq
(
hdev
->
úq
);

372 
	`úq_£t_afföôy
(
hdev
->
úq
, 
	`˝umask_of
(hdev->
˝u
));

373 
	`íabÀ_úq
(
hdev
->
úq
);

375 
	`h≥t_¥öt_c⁄fig
();

378 
	}
}

380 
	$h≥t_√xt_evít
(
dñè
,

381 
˛ock_evít_devi˚
 *
evt
, 
timî
)

383 
u32
 
˙t
;

385 
˙t
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

386 
˙t
 +(
u32
Ë
dñè
;

387 
	`h≥t_wrôñ
(
˙t
, 
	`HPET_Tn_CMP
(
timî
));

408 i‡(
	`u∆ikñy
((
u32
)
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
)Ë!
˙t
)) {

409 
	`WARN_ONCE
(
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
)Ë!
˙t
,

410 
KERN_WARNING
 "hpet: compareÑegisterÑead back failed.\n");

413  (
s32
)(
	`h≥t_ªadl
(
HPET_COUNTER
Ë- 
˙t
Ë>0 ? -
ETIME
 : 0;

414 
	}
}

416 
	$h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

417 
˛ock_evít_devi˚
 *
evt
)

419 
	`h≥t_£t_mode
(
mode
, 
evt
, 0);

420 
	}
}

422 
	$h≥t_Àgacy_√xt_evít
(
dñè
,

423 
˛ock_evít_devi˚
 *
evt
)

425  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 0);

426 
	}
}

431 #ifde‡
CONFIG_PCI_MSI


433 
DEFINE_PER_CPU
(
h≥t_dev
 *, 
˝u_h≥t_dev
);

434 
h≥t_dev
 *
	gh≥t_devs
;

436 
	$h≥t_msi_unmask
(
úq
)

438 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

439 
cfg
;

442 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

443 
cfg
 |
HPET_TN_FSB
;

444 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

445 
	}
}

447 
	$h≥t_msi_mask
(
úq
)

449 
cfg
;

450 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

453 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

454 
cfg
 &~
HPET_TN_FSB
;

455 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

456 
	}
}

458 
	$h≥t_msi_wrôe
(
úq
, 
msi_msg
 *
msg
)

460 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

462 
	`h≥t_wrôñ
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

463 
	`h≥t_wrôñ
(
msg
->
addªss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

464 
	}
}

466 
	$h≥t_msi_ªad
(
úq
, 
msi_msg
 *
msg
)

468 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

470 
msg
->
d©a
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

471 
msg
->
addªss_lo
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

472 
msg
->
addªss_hi
 = 0;

473 
	}
}

475 
	$h≥t_msi_£t_mode
(
˛ock_evít_mode
 
mode
,

476 
˛ock_evít_devi˚
 *
evt
)

478 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

479 
	`h≥t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

480 
	}
}

482 
	$h≥t_msi_√xt_evít
(
dñè
,

483 
˛ock_evít_devi˚
 *
evt
)

485 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

486  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 
hdev
->
num
);

487 
	}
}

489 
	$h≥t_£tup_msi_úq
(
úq
)

491 i‡(
	`¨ch_£tup_h≥t_msi
(
úq
, 
h≥t_blockid
)) {

492 
	`de°roy_úq
(
úq
);

493  -
EINVAL
;

496 
	}
}

498 
	$h≥t_assign_úq
(
h≥t_dev
 *
dev
)

500 
úq
;

502 
úq
 = 
	`¸óã_úq
();

503 i‡(!
úq
)

504  -
EINVAL
;

506 
	`£t_úq_d©a
(
úq
, 
dev
);

508 i‡(
	`h≥t_£tup_msi_úq
(
úq
))

509  -
EINVAL
;

511 
dev
->
úq
 = irq;

513 
	}
}

515 
úqªtu∫_t
 
	$h≥t_öãºu±_h™dÀr
(
úq
, *
d©a
)

517 
h≥t_dev
 *
dev
 = (h≥t_dev *)
d©a
;

518 
˛ock_evít_devi˚
 *
hevt
 = &
dev
->
evt
;

520 i‡(!
hevt
->
evít_h™dÀr
) {

521 
	`¥ötk
(
KERN_INFO
 "Spurious HPETÅimer interrupt on HPETÅimer %d\n",

522 
dev
->
num
);

523  
IRQ_HANDLED
;

526 
hevt
->
	`evít_h™dÀr
(hevt);

527  
IRQ_HANDLED
;

528 
	}
}

530 
	$h≥t_£tup_úq
(
h≥t_dev
 *
dev
)

533 i‡(
	`ªque°_úq
(
dev
->
úq
, 
h≥t_öãºu±_h™dÀr
,

534 
IRQF_TIMER
 | 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
,

535 
dev
->
«me
, dev))

538 
	`dißbÀ_úq
(
dev
->
úq
);

539 
	`úq_£t_afföôy
(
dev
->
úq
, 
	`˝umask_of
(dev->
˝u
));

540 
	`íabÀ_úq
(
dev
->
úq
);

542 
	`¥ötk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

543 
dev
->
«me
, dev->
úq
);

546 
	}
}

549 
	$öô_⁄e_h≥t_msi_˛ockevít
(
h≥t_dev
 *
hdev
, 
˝u
)

551 
˛ock_evít_devi˚
 *
evt
 = &
hdev
->evt;

552 
uöt64_t
 
h≥t_‰eq
;

554 
	`WARN_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

555 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

558 i‡(
	`h≥t_£tup_msi_úq
(
hdev
->
úq
))

561 
hdev
->
˝u
 = cpu;

562 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
hdev
;

563 
evt
->
«me
 = 
hdev
->name;

564 
	`h≥t_£tup_úq
(
hdev
);

565 
evt
->
úq
 = 
hdev
->irq;

567 
evt
->
øtög
 = 110;

568 
evt
->
„©uªs
 = 
CLOCK_EVT_FEAT_ONESHOT
;

569 i‡(
hdev
->
Êags
 & 
HPET_DEV_PERI_CAP
)

570 
evt
->
„©uªs
 |
CLOCK_EVT_FEAT_PERIODIC
;

572 
evt
->
£t_mode
 = 
h≥t_msi_£t_mode
;

573 
evt
->
£t_√xt_evít
 = 
h≥t_msi_√xt_evít
;

574 
evt
->
shi·
 = 32;

581 
h≥t_‰eq
 = 1000000000000000ULL;

582 
	`do_div
(
h≥t_‰eq
, 
h≥t_≥riod
);

583 
evt
->
mu…
 = 
	`div_sc
((Ë
h≥t_‰eq
,

584 
NSEC_PER_SEC
, 
evt
->
shi·
);

586 
evt
->
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,Évt);

588 
evt
->
mö_dñè_ns
 = 5000;

590 
evt
->
˝umask
 = 
	`˝umask_of
(
hdev
->
˝u
);

591 
	`˛ockevíts_ªgi°î_devi˚
(
evt
);

592 
	}
}

594 #ifde‡
CONFIG_HPET


596 
	#RESERVE_TIMERS
 1

	)

598 
	#RESERVE_TIMERS
 0

	)

601 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

603 
id
;

604 
num_timîs
;

605 
num_timîs_u£d
 = 0;

606 
i
;

608 i‡(
h≥t_msi_dißbÀ
)

611 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

613 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

615 
num_timîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
);

616 
num_timîs
++;

617 
	`h≥t_¥öt_c⁄fig
();

619 
h≥t_devs
 = 
	`kzÆloc
((
h≥t_dev
Ë* 
num_timîs
, 
GFP_KERNEL
);

620 i‡(!
h≥t_devs
)

623 
h≥t_num_timîs
 = 
num_timîs
;

625 
i
 = 
°¨t_timî
; i < 
num_timîs
 - 
RESERVE_TIMERS
; i++) {

626 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
num_timîs_u£d
];

627 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

630 i‡(!(
cfg
 & 
HPET_TN_FSB_CAP
))

633 
hdev
->
Êags
 = 0;

634 i‡(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

635 
hdev
->
Êags
 |
HPET_DEV_PERI_CAP
;

636 
hdev
->
num
 = 
i
;

638 
	`•rötf
(
hdev
->
«me
, "h≥t%d", 
i
);

639 i‡(
	`h≥t_assign_úq
(
hdev
))

642 
hdev
->
Êags
 |
HPET_DEV_FSB_CAP
;

643 
hdev
->
Êags
 |
HPET_DEV_VALID
;

644 
num_timîs_u£d
++;

645 i‡(
num_timîs_u£d
 =
	`num_possibÀ_˝us
())

649 
	`¥ötk
(
KERN_INFO
 "HPET: %dÅimers inÅotal, %dÅimers will be used forÖer-cpuÅimer\n",

650 
num_timîs
, 
num_timîs_u£d
);

651 
	}
}

653 #ifde‡
CONFIG_HPET


654 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

656 
i
;

658 i‡(!
h≥t_devs
)

661 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

662 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

664 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

667 
hd
->
hd_úq
[
hdev
->
num
] = hdev->
úq
;

668 
	`h≥t_ª£rve_timî
(
hd
, 
hdev
->
num
);

670 
	}
}

673 
h≥t_dev
 *
	$h≥t_gë_unu£d_timî
()

675 
i
;

677 i‡(!
h≥t_devs
)

678  
NULL
;

680 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

681 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

683 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

685 i‡(
	`ã°_™d_£t_bô
(
HPET_DEV_USED_BIT
,

686 (*)&
hdev
->
Êags
))

688  
hdev
;

690  
NULL
;

691 
	}
}

693 
	sh≥t_w‹k_°ru˘
 {

694 
dñayed_w‹k
 
	mw‹k
;

695 
com∂ëi⁄
 
	mcom∂ëe
;

698 
	$h≥t_w‹k
(
w‹k_°ru˘
 *
w
)

700 
h≥t_dev
 *
hdev
;

701 
˝u
 = 
	`smp_¥o˚ss‹_id
();

702 
h≥t_w‹k_°ru˘
 *
h≥t_w‹k
;

704 
h≥t_w‹k
 = 
	`c⁄èöî_of
(
w
, 
h≥t_w‹k_°ru˘
, 
w‹k
.work);

706 
hdev
 = 
	`h≥t_gë_unu£d_timî
();

707 i‡(
hdev
)

708 
	`öô_⁄e_h≥t_msi_˛ockevít
(
hdev
, 
˝u
);

710 
	`com∂ëe
(&
h≥t_w‹k
->
com∂ëe
);

711 
	}
}

713 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

714 
a˘i⁄
, *
h˝u
)

716 
˝u
 = ()
h˝u
;

717 
h≥t_w‹k_°ru˘
 
w‹k
;

718 
h≥t_dev
 *
hdev
 = 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
);

720 
a˘i⁄
 & 0xf) {

721 
CPU_ONLINE
:

722 
	`INIT_DELAYED_WORK_ON_STACK
(&
w‹k
.w‹k, 
h≥t_w‹k
);

723 
	`öô_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

725 
	`scheduÀ_dñayed_w‹k_⁄
(
˝u
, &
w‹k
.work, 0);

726 
	`waô_f‹_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

727 
	`de°roy_timî_⁄_°ack
(&
w‹k
.w‹k.
timî
);

729 
CPU_DEAD
:

730 i‡(
hdev
) {

731 
	`‰ì_úq
(
hdev
->
úq
, hdev);

732 
hdev
->
Êags
 &~
HPET_DEV_USED
;

733 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
NULL
;

737  
NOTIFY_OK
;

738 
	}
}

741 
	$h≥t_£tup_msi_úq
(
úq
)

744 
	}
}

745 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

748 
	}
}

750 #ifde‡
CONFIG_HPET


751 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

754 
	}
}

757 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

758 
a˘i⁄
, *
h˝u
)

760  
NOTIFY_OK
;

761 
	}
}

768 
cy˛e_t
 
	$ªad_h≥t
(
˛ocksour˚
 *
cs
)

770  (
cy˛e_t
)
	`h≥t_ªadl
(
HPET_COUNTER
);

771 
	}
}

773 #ifde‡
CONFIG_X86_64


774 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_h≥t
()

776  
	`ªadl
((c⁄° 
__iomem
 *)
	`fix_to_vút
(
VSYSCALL_HPET
) + 0xf0);

777 
	}
}

780 
˛ocksour˚
 
	g˛ocksour˚_h≥t
 = {

781 .
«me
 = "hpet",

782 .
	gøtög
 = 250,

783 .
	gªad
 = 
ªad_h≥t
,

784 .
	gmask
 = 
HPET_MASK
,

785 .
	gshi·
 = 
HPET_SHIFT
,

786 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

787 .
	gªsume
 = 
h≥t_ªsume_cou¡î
,

788 #ifde‡
CONFIG_X86_64


789 .
	gvªad
 = 
vªad_h≥t
,

793 
	$h≥t_˛ocksour˚_ªgi°î
()

795 
u64
 
°¨t
, 
now
;

796 
cy˛e_t
 
t1
;

799 
	`h≥t_ª°¨t_cou¡î
();

802 
t1
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

803 
	`rdts˛l
(
°¨t
);

812 
	`ªp_n›
();

813 
	`rdts˛l
(
now
);

814 } (
now
 - 
°¨t
) < 200000UL);

816 i‡(
t1
 =
	`h≥t_ªadl
(
HPET_COUNTER
)) {

817 
	`¥ötk
(
KERN_WARNING


819  -
ENODEV
;

830 
˛ocksour˚_h≥t
.
mu…
 = 
	`div_sc
(
h≥t_≥riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

832 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_h≥t
);

835 
	}
}

840 
__öô
 
	$h≥t_íabÀ
()

842 
id
;

843 
i
;

845 i‡(!
	`is_h≥t_ˇ∑bÀ
())

848 
	`h≥t_£t_m≠pög
();

853 
h≥t_≥riod
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

868 
i
 = 0; 
	`h≥t_ªadl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

869 i‡(
i
 == 1000) {

870 
	`¥ötk
(
KERN_WARNING


873 
out_noh≥t
;

877 i‡(
h≥t_≥riod
 < 
HPET_MIN_PERIOD
 || h≥t_≥riod > 
HPET_MAX_PERIOD
)

878 
out_noh≥t
;

884 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

885 
	`h≥t_¥öt_c⁄fig
();

887 #ifde‡
CONFIG_HPET_EMULATE_RTC


892 i‡(!(
id
 & 
HPET_ID_NUMBER
))

893 
out_noh≥t
;

896 i‡(
	`h≥t_˛ocksour˚_ªgi°î
())

897 
out_noh≥t
;

899 i‡(
id
 & 
HPET_ID_LEGSUP
) {

900 
	`h≥t_Àgacy_˛ockevít_ªgi°î
();

905 
out_noh≥t
:

906 
	`h≥t_˛ór_m≠pög
();

907 
h≥t_addªss
 = 0;

909 
	}
}

917 
__öô
 
	$h≥t_œã_öô
()

919 
˝u
;

921 i‡(
boŸ_h≥t_dißbÀ
)

922  -
ENODEV
;

924 i‡(!
h≥t_addªss
) {

925 i‡(!
f‹˚_h≥t_addªss
)

926  -
ENODEV
;

928 
h≥t_addªss
 = 
f‹˚_h≥t_addªss
;

929 
	`h≥t_íabÀ
();

932 i‡(!
h≥t_vút_addªss
)

933  -
ENODEV
;

935 i‡(
	`h≥t_ªadl
(
HPET_ID
Ë& 
HPET_ID_LEGSUP
)

936 
	`h≥t_msi_ˇ∑bûôy_lookup
(2);

938 
	`h≥t_msi_ˇ∑bûôy_lookup
(0);

940 
	`h≥t_ª£rve_∂©f‹m_timîs
(
	`h≥t_ªadl
(
HPET_ID
));

941 
	`h≥t_¥öt_c⁄fig
();

943 i‡(
h≥t_msi_dißbÀ
)

946 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

949 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

950 
	`h≥t_˝uhp_nŸify
(
NULL
, 
CPU_ONLINE
, (*)()
˝u
);

954 
	`hŸ˝u_nŸifõr
(
h≥t_˝uhp_nŸify
, -20);

957 
	}
}

958 
fs_öôˇŒ
(
h≥t_œã_öô
);

960 
	$h≥t_dißbÀ
()

962 i‡(
	`is_h≥t_ˇ∑bÀ
()) {

963 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

965 i‡(
h≥t_Àgacy_öt_íabÀd
) {

966 
cfg
 &~
HPET_CFG_LEGACY
;

967 
h≥t_Àgacy_öt_íabÀd
 = 0;

969 
cfg
 &~
HPET_CFG_ENABLE
;

970 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

972 
	}
}

974 #ifde‡
CONFIG_HPET_EMULATE_RTC


990 
	~<löux/mc146818πc.h
>

991 
	~<löux/πc.h
>

992 
	~<asm/πc.h
>

994 
	#DEFAULT_RTC_INT_FREQ
 64

	)

995 
	#DEFAULT_RTC_SHIFT
 6

	)

996 
	#RTC_NUM_INTS
 1

	)

998 
	gh≥t_πc_Êags
;

999 
	gh≥t_¥ev_upd©e_£c
;

1000 
πc_time
 
	gh≥t_Æ¨m_time
;

1001 
	gh≥t_põ_cou¡
;

1002 
u32
 
	gh≥t_t1_cmp
;

1003 
u32
 
	gh≥t_deÁu…_dñè
;

1004 
u32
 
	gh≥t_põ_dñè
;

1005 
	gh≥t_põ_limô
;

1007 
πc_úq_h™dÀr
 
	gúq_h™dÀr
;

1012 
ölöe
 
	$h≥t_˙t_ahód
(
u32
 
c1
, u32 
c2
)

1014  (
s32
)(
c2
 - 
c1
) < 0;

1015 
	}
}

1020 
	$h≥t_ªgi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1022 i‡(!
	`is_h≥t_íabÀd
())

1023  -
ENODEV
;

1024 i‡(
úq_h™dÀr
)

1025  -
EBUSY
;

1027 
úq_h™dÀr
 = 
h™dÀr
;

1030 
	}
}

1031 
EXPORT_SYMBOL_GPL
(
h≥t_ªgi°î_úq_h™dÀr
);

1037 
	$h≥t_uƒegi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1039 i‡(!
	`is_h≥t_íabÀd
())

1042 
úq_h™dÀr
 = 
NULL
;

1043 
h≥t_πc_Êags
 = 0;

1044 
	}
}

1045 
EXPORT_SYMBOL_GPL
(
h≥t_uƒegi°î_úq_h™dÀr
);

1053 
	$h≥t_πc_timî_öô
()

1055 
cfg
, 
˙t
, 
dñè
;

1056 
Êags
;

1058 i‡(!
	`is_h≥t_íabÀd
())

1061 i‡(!
h≥t_deÁu…_dñè
) {

1062 
uöt64_t
 
˛c
;

1064 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1065 
˛c
 >>
h≥t_˛ockevít
.
shi·
 + 
DEFAULT_RTC_SHIFT
;

1066 
h≥t_deÁu…_dñè
 = 
˛c
;

1069 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1070 
dñè
 = 
h≥t_deÁu…_dñè
;

1072 
dñè
 = 
h≥t_põ_dñè
;

1074 
	`loˇl_úq_ßve
(
Êags
);

1076 
˙t
 = 
dñè
 + 
	`h≥t_ªadl
(
HPET_COUNTER
);

1077 
	`h≥t_wrôñ
(
˙t
, 
HPET_T1_CMP
);

1078 
h≥t_t1_cmp
 = 
˙t
;

1080 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1081 
cfg
 &~
HPET_TN_PERIODIC
;

1082 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1083 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1085 
	`loˇl_úq_ª°‹e
(
Êags
);

1088 
	}
}

1089 
EXPORT_SYMBOL_GPL
(
h≥t_πc_timî_öô
);

1096 
	$h≥t_mask_πc_úq_bô
(
bô_mask
)

1098 i‡(!
	`is_h≥t_íabÀd
())

1101 
h≥t_πc_Êags
 &~
bô_mask
;

1103 
	}
}

1104 
EXPORT_SYMBOL_GPL
(
h≥t_mask_πc_úq_bô
);

1106 
	$h≥t_£t_πc_úq_bô
(
bô_mask
)

1108 
ﬁdbôs
 = 
h≥t_πc_Êags
;

1110 i‡(!
	`is_h≥t_íabÀd
())

1113 
h≥t_πc_Êags
 |
bô_mask
;

1115 i‡((
bô_mask
 & 
RTC_UIE
Ë&& !(
ﬁdbôs
 & RTC_UIE))

1116 
h≥t_¥ev_upd©e_£c
 = -1;

1118 i‡(!
ﬁdbôs
)

1119 
	`h≥t_πc_timî_öô
();

1122 
	}
}

1123 
EXPORT_SYMBOL_GPL
(
h≥t_£t_πc_úq_bô
);

1125 
	$h≥t_£t_Æ¨m_time
(
hrs
, 
mö
,

1126 
£c
)

1128 i‡(!
	`is_h≥t_íabÀd
())

1131 
h≥t_Æ¨m_time
.
tm_hour
 = 
hrs
;

1132 
h≥t_Æ¨m_time
.
tm_mö
 = 
mö
;

1133 
h≥t_Æ¨m_time
.
tm_£c
 = 
£c
;

1136 
	}
}

1137 
EXPORT_SYMBOL_GPL
(
h≥t_£t_Æ¨m_time
);

1139 
	$h≥t_£t_≥riodic_‰eq
(
‰eq
)

1141 
uöt64_t
 
˛c
;

1143 i‡(!
	`is_h≥t_íabÀd
())

1146 i‡(
‰eq
 <
DEFAULT_RTC_INT_FREQ
)

1147 
h≥t_põ_limô
 = 
DEFAULT_RTC_INT_FREQ
 / 
‰eq
;

1149 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1150 
	`do_div
(
˛c
, 
‰eq
);

1151 
˛c
 >>
h≥t_˛ockevít
.
shi·
;

1152 
h≥t_põ_dñè
 = 
˛c
;

1153 
h≥t_põ_limô
 = 0;

1156 
	}
}

1157 
EXPORT_SYMBOL_GPL
(
h≥t_£t_≥riodic_‰eq
);

1159 
	$h≥t_πc_dr›≥d_úq
()

1161  
	`is_h≥t_íabÀd
();

1162 
	}
}

1163 
EXPORT_SYMBOL_GPL
(
h≥t_πc_dr›≥d_úq
);

1165 
	$h≥t_πc_timî_ªöô
()

1167 
cfg
, 
dñè
;

1168 
lo°_öts
 = -1;

1170 i‡(
	`u∆ikñy
(!
h≥t_πc_Êags
)) {

1171 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1172 
cfg
 &~
HPET_TN_ENABLE
;

1173 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1177 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1178 
dñè
 = 
h≥t_deÁu…_dñè
;

1180 
dñè
 = 
h≥t_põ_dñè
;

1187 
h≥t_t1_cmp
 +
dñè
;

1188 
	`h≥t_wrôñ
(
h≥t_t1_cmp
, 
HPET_T1_CMP
);

1189 
lo°_öts
++;

1190 } !
	`h≥t_˙t_ahód
(
h≥t_t1_cmp
, 
	`h≥t_ªadl
(
HPET_COUNTER
)));

1192 i‡(
lo°_öts
) {

1193 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
)

1194 
h≥t_põ_cou¡
 +
lo°_öts
;

1195 i‡(
	`¥ötk_øãlimô
())

1196 
	`¥ötk
(
KERN_WARNING
 "hpet1:Üost %dÑtc interrupts\n",

1197 
lo°_öts
);

1199 
	}
}

1201 
úqªtu∫_t
 
	$h≥t_πc_öãºu±
(
úq
, *
dev_id
)

1203 
πc_time
 
cuº_time
;

1204 
πc_öt_Êag
 = 0;

1206 
	`h≥t_πc_timî_ªöô
();

1207 
	`mem£t
(&
cuº_time
, 0, (
πc_time
));

1209 i‡(
h≥t_πc_Êags
 & (
RTC_UIE
 | 
RTC_AIE
))

1210 
	`gë_πc_time
(&
cuº_time
);

1212 i‡(
h≥t_πc_Êags
 & 
RTC_UIE
 &&

1213 
cuº_time
.
tm_£c
 !
h≥t_¥ev_upd©e_£c
) {

1214 i‡(
h≥t_¥ev_upd©e_£c
 >= 0)

1215 
πc_öt_Êag
 = 
RTC_UF
;

1216 
h≥t_¥ev_upd©e_£c
 = 
cuº_time
.
tm_£c
;

1219 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
 &&

1220 ++
h≥t_põ_cou¡
 >
h≥t_põ_limô
) {

1221 
πc_öt_Êag
 |
RTC_PF
;

1222 
h≥t_põ_cou¡
 = 0;

1225 i‡(
h≥t_πc_Êags
 & 
RTC_AIE
 &&

1226 (
cuº_time
.
tm_£c
 =
h≥t_Æ¨m_time
.tm_sec) &&

1227 (
cuº_time
.
tm_mö
 =
h≥t_Æ¨m_time
.tm_min) &&

1228 (
cuº_time
.
tm_hour
 =
h≥t_Æ¨m_time
.tm_hour))

1229 
πc_öt_Êag
 |
RTC_AF
;

1231 i‡(
πc_öt_Êag
) {

1232 
πc_öt_Êag
 |(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1233 i‡(
úq_h™dÀr
)

1234 
	`úq_h™dÀr
(
πc_öt_Êag
, 
dev_id
);

1236  
IRQ_HANDLED
;

1237 
	}
}

1238 
EXPORT_SYMBOL_GPL
(
h≥t_πc_öãºu±
);

	@/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c

30 
	~<löux/≥rf_evít.h
>

31 
	~<löux/hw_bªakpoöt.h
>

32 
	~<löux/úqÊags.h
>

33 
	~<löux/nŸifõr.h
>

34 
	~<löux/kÆlsyms.h
>

35 
	~<löux/k¥obes.h
>

36 
	~<löux/≥r˝u.h
>

37 
	~<löux/kdebug.h
>

38 
	~<löux/kî√l.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/sched.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/smp.h
>

44 
	~<asm/hw_bªakpoöt.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/debugªg.h
>

49 
DEFINE_PER_CPU
(, 
˝u_dr7
);

50 
EXPORT_PER_CPU_SYMBOL
(
˝u_dr7
);

53 
DEFINE_PER_CPU
(, 
˝u_debugªg
[
HBP_NUM
]);

59 
DEFINE_PER_CPU
(
≥rf_evít
 *, 
bp_≥r_ªg
[
HBP_NUM
]);

62 
ölöe
 

63 
	$__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

65 
bp_öfo
;

67 
bp_öfo
 = (
Àn
 | 
ty≥
) & 0xf;

68 
bp_öfo
 <<(
DR_CONTROL_SHIFT
 + 
d∫um
 * 
DR_CONTROL_SIZE
);

69 
bp_öfo
 |(
DR_GLOBAL_ENABLE
 << (
d∫um
 * 
DR_ENABLE_SIZE
));

71  
bp_öfo
;

72 
	}
}

78 
	$ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

80  
	`__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
Ë| 
DR_GLOBAL_SLOWDOWN
;

81 
	}
}

87 
	$decode_dr7
(
dr7
, 
b≤um
, *
Àn
, *
ty≥
)

89 
bp_öfo
 = 
dr7
 >> (
DR_CONTROL_SHIFT
 + 
b≤um
 * 
DR_CONTROL_SIZE
);

91 *
Àn
 = (
bp_öfo
 & 0xc) | 0x40;

92 *
ty≥
 = (
bp_öfo
 & 0x3) | 0x80;

94  (
dr7
 >> (
b≤um
 * 
DR_ENABLE_SIZE
)) & 0x3;

95 
	}
}

106 
	$¨ch_ö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

108 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

109 *
dr7
;

110 
i
;

112 
i
 = 0; i < 
HBP_NUM
; i++) {

113 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

115 i‡(!*
¶Ÿ
) {

116 *
¶Ÿ
 = 
bp
;

121 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

122  -
EBUSY
;

124 
	`£t_debugªg
(
öfo
->
addªss
, 
i
);

125 
	`__gë_˝u_v¨
(
˝u_debugªg
[
i
]Ë
öfo
->
addªss
;

127 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

128 *
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

130 
	`£t_debugªg
(*
dr7
, 7);

133 
	}
}

144 
	$¨ch_unö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

146 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

147 *
dr7
;

148 
i
;

150 
i
 = 0; i < 
HBP_NUM
; i++) {

151 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

153 i‡(*
¶Ÿ
 =
bp
) {

154 *
¶Ÿ
 = 
NULL
;

159 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

162 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

163 *
dr7
 &~
	`__ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

165 
	`£t_debugªg
(*
dr7
, 7);

166 
	}
}

168 
	$gë_hbp_Àn
(
u8
 
hbp_Àn
)

170 
Àn_ö_byãs
 = 0;

172 
hbp_Àn
) {

173 
X86_BREAKPOINT_LEN_1
:

174 
Àn_ö_byãs
 = 1;

176 
X86_BREAKPOINT_LEN_2
:

177 
Àn_ö_byãs
 = 2;

179 
X86_BREAKPOINT_LEN_4
:

180 
Àn_ö_byãs
 = 4;

182 #ifde‡
CONFIG_X86_64


183 
X86_BREAKPOINT_LEN_8
:

184 
Àn_ö_byãs
 = 8;

188  
Àn_ö_byãs
;

189 
	}
}

194 
	$¨ch_check_va_ö_u£r•a˚
(
va
, 
u8
 
hbp_Àn
)

196 
Àn
;

198 
Àn
 = 
	`gë_hbp_Àn
(
hbp_Àn
);

200  (
va
 <
TASK_SIZE
 - 
Àn
);

201 
	}
}

206 
	$¨ch_check_va_ö_kî√l•a˚
(
va
, 
u8
 
hbp_Àn
)

208 
Àn
;

210 
Àn
 = 
	`gë_hbp_Àn
(
hbp_Àn
);

212  (
va
 >
TASK_SIZE
Ë&& ((v®+ 
Àn
 - 1) >= TASK_SIZE);

213 
	}
}

215 
	$¨ch_bp_gíîic_fõlds
(
x86_Àn
, 
x86_ty≥
,

216 *
gí_Àn
, *
gí_ty≥
)

219 
x86_Àn
) {

220 
X86_BREAKPOINT_LEN_1
:

221 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_1
;

223 
X86_BREAKPOINT_LEN_2
:

224 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_2
;

226 
X86_BREAKPOINT_LEN_4
:

227 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_4
;

229 #ifde‡
CONFIG_X86_64


230 
X86_BREAKPOINT_LEN_8
:

231 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_8
;

235  -
EINVAL
;

239 
x86_ty≥
) {

240 
X86_BREAKPOINT_EXECUTE
:

241 *
gí_ty≥
 = 
HW_BREAKPOINT_X
;

243 
X86_BREAKPOINT_WRITE
:

244 *
gí_ty≥
 = 
HW_BREAKPOINT_W
;

246 
X86_BREAKPOINT_RW
:

247 *
gí_ty≥
 = 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
;

250  -
EINVAL
;

254 
	}
}

257 
	$¨ch_buûd_bp_öfo
(
≥rf_evít
 *
bp
)

259 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

261 
öfo
->
addªss
 = 
bp
->
©å
.
bp_addr
;

264 
bp
->
©å
.
bp_Àn
) {

265 
HW_BREAKPOINT_LEN_1
:

266 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_1
;

268 
HW_BREAKPOINT_LEN_2
:

269 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_2
;

271 
HW_BREAKPOINT_LEN_4
:

272 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_4
;

274 #ifde‡
CONFIG_X86_64


275 
HW_BREAKPOINT_LEN_8
:

276 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_8
;

280  -
EINVAL
;

284 
bp
->
©å
.
bp_ty≥
) {

285 
HW_BREAKPOINT_W
:

286 
öfo
->
ty≥
 = 
X86_BREAKPOINT_WRITE
;

288 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
:

289 
öfo
->
ty≥
 = 
X86_BREAKPOINT_RW
;

291 
HW_BREAKPOINT_X
:

292 
öfo
->
ty≥
 = 
X86_BREAKPOINT_EXECUTE
;

295  -
EINVAL
;

299 
	}
}

303 
	$¨ch_vÆid©e_hwbk±_£âögs
(
≥rf_evít
 *
bp
,

304 
èsk_°ru˘
 *
tsk
)

306 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

307 
Æign
;

308 
ªt
;

311 
ªt
 = 
	`¨ch_buûd_bp_öfo
(
bp
);

312 i‡(
ªt
)

313  
ªt
;

315 
ªt
 = -
EINVAL
;

317 i‡(
öfo
->
ty≥
 =
X86_BREAKPOINT_EXECUTE
)

323 i‡((!
	`¨ch_check_va_ö_u£r•a˚
(
öfo
->
addªss
, info->
Àn
)) &&

324 
öfo
->
Àn
 !
X86_BREAKPOINT_EXECUTE
)

325  
ªt
;

327 
öfo
->
Àn
) {

328 
X86_BREAKPOINT_LEN_1
:

329 
Æign
 = 0;

331 
X86_BREAKPOINT_LEN_2
:

332 
Æign
 = 1;

334 
X86_BREAKPOINT_LEN_4
:

335 
Æign
 = 3;

337 #ifde‡
CONFIG_X86_64


338 
X86_BREAKPOINT_LEN_8
:

339 
Æign
 = 7;

343  
ªt
;

350 i‡(
öfo
->
addªss
 & 
Æign
)

351  -
EINVAL
;

354 i‡(
tsk
) {

355 i‡(!
	`¨ch_check_va_ö_u£r•a˚
(
öfo
->
addªss
, info->
Àn
))

356  -
EFAULT
;

358 i‡(!
	`¨ch_check_va_ö_kî√l•a˚
(
öfo
->
addªss
, info->
Àn
))

359  -
EFAULT
;

363 
	}
}

373 
	$aout_dump_debugªgs
(
u£r
 *
dump
)

375 
i
;

376 
dr7
 = 0;

377 
≥rf_evít
 *
bp
;

378 
¨ch_hw_bªakpoöt
 *
öfo
;

379 
thªad_°ru˘
 *
thªad
 = &
cuºít
->thread;

381 
i
 = 0; i < 
HBP_NUM
; i++) {

382 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

384 i‡(
bp
 && !bp->
©å
.
dißbÀd
) {

385 
dump
->
u_debugªg
[
i
] = 
bp
->
©å
.
bp_addr
;

386 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

387 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

389 
dump
->
u_debugªg
[
i
] = 0;

393 
dump
->
u_debugªg
[4] = 0;

394 
dump
->
u_debugªg
[5] = 0;

395 
dump
->
u_debugªg
[6] = 
cuºít
->
thªad
.
debugªg6
;

397 
dump
->
u_debugªg
[7] = 
dr7
;

398 
	}
}

399 
EXPORT_SYMBOL_GPL
(
aout_dump_debugªgs
);

404 
	$Êush_±ø˚_hw_bªakpoöt
(
èsk_°ru˘
 *
tsk
)

406 
i
;

407 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

409 
i
 = 0; i < 
HBP_NUM
; i++) {

410 
	`uƒegi°î_hw_bªakpoöt
(
t
->
±ø˚_bps
[
i
]);

411 
t
->
±ø˚_bps
[
i
] = 
NULL
;

413 
	}
}

415 
	$hw_bªakpoöt_ª°‹e
()

417 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[0]), 0);

418 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[1]), 1);

419 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[2]), 2);

420 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[3]), 3);

421 
	`£t_debugªg
(
cuºít
->
thªad
.
debugªg6
, 6);

422 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_dr7
), 7);

423 
	}
}

424 
EXPORT_SYMBOL_GPL
(
hw_bªakpoöt_ª°‹e
);

442 
__k¥obes
 
	$hw_bªakpoöt_h™dÀr
(
dõ_¨gs
 *
¨gs
)

444 
i
, 
˝u
, 
rc
 = 
NOTIFY_STOP
;

445 
≥rf_evít
 *
bp
;

446 
dr7
, 
dr6
;

447 *
dr6_p
;

450 
dr6_p
 = (*)
	`ERR_PTR
(
¨gs
->
îr
);

451 
dr6
 = *
dr6_p
;

454 i‡((
dr6
 & 
DR_TRAP_BITS
) == 0)

455  
NOTIFY_DONE
;

457 
	`gë_debugªg
(
dr7
, 7);

459 
	`£t_debugªg
(0UL, 7);

465 
cuºít
->
thªad
.
debugªg6
 &~
DR_TRAP_BITS
;

466 
˝u
 = 
	`gë_˝u
();

469 
i
 = 0; i < 
HBP_NUM
; ++i) {

470 i‡(
	`likñy
(!(
dr6
 & (
DR_TRAP0
 << 
i
))))

479 
	`rcu_ªad_lock
();

481 
bp
 = 
	`≥r_˝u
(
bp_≥r_ªg
[
i
], 
˝u
);

486 (*
dr6_p
Ë&~(
DR_TRAP0
 << 
i
);

491 i‡(!
bp
) {

492 
	`rcu_ªad_u∆ock
();

496 
	`≥rf_bp_evít
(
bp
, 
¨gs
->
ªgs
);

498 
	`rcu_ªad_u∆ock
();

505 i‡((
cuºít
->
thªad
.
debugªg6
 & 
DR_TRAP_BITS
) ||

506 (
dr6
 & (~
DR_TRAP_BITS
)))

507 
rc
 = 
NOTIFY_DONE
;

509 
	`£t_debugªg
(
dr7
, 7);

510 
	`put_˝u
();

512  
rc
;

513 
	}
}

518 
__k¥obes
 
	$hw_bªakpoöt_ex˚±i⁄s_nŸify
(

519 
nŸifõr_block
 *
unu£d
, 
vÆ
, *
d©a
)

521 i‡(
vÆ
 !
DIE_DEBUG
)

522  
NOTIFY_DONE
;

524  
	`hw_bªakpoöt_h™dÀr
(
d©a
);

525 
	}
}

527 
	$hw_bªakpoöt_pmu_ªad
(
≥rf_evít
 *
bp
)

530 
	}
}

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/ªg£t.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/¶ab.h
>

13 
	~<asm/sigc⁄ãxt.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/m©h_emu.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/±ø˚.h
>

18 
	~<asm/i387.h
>

19 
	~<asm/u£r.h
>

21 #ifde‡
CONFIG_X86_64


22 
	~<asm/sigc⁄ãxt32.h
>

23 
	~<asm/u£r32.h
>

25 
	#ßve_i387_x°©e_ü32
 
ßve_i387_x°©e


	)

26 
	#ª°‹e_i387_x°©e_ü32
 
ª°‹e_i387_x°©e


	)

27 
	#_Â°©e_ü32
 
_Â°©e


	)

28 
	#_x°©e_ü32
 
_x°©e


	)

29 
	#sig_x°©e_ü32_size
 
sig_x°©e_size


	)

30 
	#fx_sw_ª£rved_ü32
 
fx_sw_ª£rved


	)

31 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

32 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

35 #ifde‡
CONFIG_MATH_EMULATION


36 
	#HAVE_HWFP
 (
boŸ_˝u_d©a
.
h¨d_m©h
)

	)

38 
	#HAVE_HWFP
 1

	)

41 
mxc§_„©uª_mask
 
	g__ªad_mo°ly
 = 0xffffffffu;

42 
	gx°©e_size
;

43 
	gsig_x°©e_ü32_size
 = (
_Â°©e_ü32
);

44 
i387_fxßve_°ru˘
 
fx_s¸©ch
 
	g__˝uöôd©a
;

46 
__˝uöô
 
	$mxc§_„©uª_mask_öô
()

48 
mask
 = 0;

50 
	`˛ts
();

51 i‡(
˝u_has_fx§
) {

52 
	`mem£t
(&
fx_s¸©ch
, 0, (
i387_fxßve_°ru˘
));

53 
asm
 vﬁ©ûe("fxßvê%0" : : "m" (
fx_s¸©ch
));

54 
mask
 = 
fx_s¸©ch
.
mxc§_mask
;

55 i‡(
mask
 == 0)

56 
mask
 = 0x0000ffbf;

58 
mxc§_„©uª_mask
 &
mask
;

59 
	`°ts
();

60 
	}
}

62 
__˝uöô
 
	$öô_thªad_x°©e
()

64 i‡(!
HAVE_HWFP
) {

65 
x°©e_size
 = (
i387_so·_°ru˘
);

69 i‡(
˝u_has_xßve
) {

70 
	`xßve_˙txt_öô
();

74 i‡(
˝u_has_fx§
)

75 
x°©e_size
 = (
i387_fxßve_°ru˘
);

76 #ifde‡
CONFIG_X86_32


78 
x°©e_size
 = (
i387_fßve_°ru˘
);

80 
	}
}

82 #ifde‡
CONFIG_X86_64


87 
__˝uöô
 
	$Âu_öô
()

89 
ﬁd¸0
 = 
	`ªad_¸0
();

91 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

92 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

94 
	`wrôe_¸0
(
ﬁd¸0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

99 i‡(!
	`smp_¥o˚ss‹_id
())

100 
	`öô_thªad_x°©e
();

101 
	`xßve_öô
();

103 
	`mxc§_„©uª_mask_öô
();

105 i‡(
˝u_has_xßve
)

106 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

108 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

109 
	`˛ór_u£d_m©h
();

110 
	}
}

119 
	$öô_Âu
(
èsk_°ru˘
 *
tsk
)

121 i‡(
	`tsk_u£d_m©h
(
tsk
)) {

122 i‡(
HAVE_HWFP
 && 
tsk
 =
cuºít
)

123 
	`u∆azy_Âu
(
tsk
);

130 i‡(!
tsk
->
thªad
.
x°©e
) {

131 
tsk
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

132 
GFP_KERNEL
);

133 i‡(!
tsk
->
thªad
.
x°©e
)

134  -
ENOMEM
;

137 #ifde‡
CONFIG_X86_32


138 i‡(!
HAVE_HWFP
) {

139 
	`mem£t
(
tsk
->
thªad
.
x°©e
, 0, 
x°©e_size
);

140 
	`föô_èsk
(
tsk
);

141 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

146 i‡(
˝u_has_fx§
) {

147 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

149 
	`mem£t
(
fx
, 0, 
x°©e_size
);

150 
fx
->
cwd
 = 0x37f;

151 i‡(
˝u_has_xmm
)

152 
fx
->
mxc§
 = 
MXCSR_DEFAULT
;

154 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

155 
	`mem£t
(
Â
, 0, 
x°©e_size
);

156 
Â
->
cwd
 = 0xffff037fu;

157 
Â
->
swd
 = 0xffff0000u;

158 
Â
->
twd
 = 0xffffffffu;

159 
Â
->
fos
 = 0xffff0000u;

164 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

166 
	}
}

173 
	$Âªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

175  
	`tsk_u£d_m©h
(
èrgë
Ë? 
ªg£t
->
n
 : 0;

176 
	}
}

178 
	$xÂªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

180  (
˝u_has_fx§
 && 
	`tsk_u£d_m©h
(
èrgë
)Ë? 
ªg£t
->
n
 : 0;

181 
	}
}

183 
	$xÂªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

184 
pos
, 
cou¡
,

185 *
kbuf
, 
__u£r
 *
ubuf
)

187 
ªt
;

189 i‡(!
˝u_has_fx§
)

190  -
ENODEV
;

192 
ªt
 = 
	`öô_Âu
(
èrgë
);

193 i‡(
ªt
)

194  
ªt
;

196  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

197 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

198 
	}
}

200 
	$xÂªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

201 
pos
, 
cou¡
,

202 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

204 
ªt
;

206 i‡(!
˝u_has_fx§
)

207  -
ENODEV
;

209 
ªt
 = 
	`öô_Âu
(
èrgë
);

210 i‡(
ªt
)

211  
ªt
;

213 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

214 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

219 
èrgë
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

225 i‡(
˝u_has_xßve
)

226 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

228  
ªt
;

229 
	}
}

231 
	$x°©îegs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

232 
pos
, 
cou¡
,

233 *
kbuf
, 
__u£r
 *
ubuf
)

235 
ªt
;

237 i‡(!
˝u_has_xßve
)

238  -
ENODEV
;

240 
ªt
 = 
	`öô_Âu
(
èrgë
);

241 i‡(
ªt
)

242  
ªt
;

249 
	`mem˝y
(&
èrgë
->
thªad
.
x°©e
->
fxßve
.
sw_ª£rved
,

250 
x°©e_fx_sw_byãs
, (xstate_fx_sw_bytes));

255 
ªt
 = 
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

256 &
èrgë
->
thªad
.
x°©e
->
xßve
, 0, -1);

257  
ªt
;

258 
	}
}

260 
	$x°©îegs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

261 
pos
, 
cou¡
,

262 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

264 
ªt
;

265 
xßve_hdr_°ru˘
 *
xßve_hdr
;

267 i‡(!
˝u_has_xßve
)

268  -
ENODEV
;

270 
ªt
 = 
	`öô_Âu
(
èrgë
);

271 i‡(
ªt
)

272  
ªt
;

274 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

275 &
èrgë
->
thªad
.
x°©e
->
xßve
, 0, -1);

280 
èrgë
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

282 
xßve_hdr
 = &
èrgë
->
thªad
.
x°©e
->
xßve
.xsave_hdr;

284 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

288 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

290  
ªt
;

291 
	}
}

293 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


299 
ölöe
 
	$twd_i387_to_fx§
(
twd
)

301 
tmp
;

304 
tmp
 = ~
twd
;

305 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

307 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

308 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

309 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

311  
tmp
;

312 
	}
}

314 
	#FPREG_ADDR
(
f
, 
n
Ë((*)&(f)->
°_•a˚
 + (nË* 16);

	)

315 
	#FP_EXP_TAG_VALID
 0

	)

316 
	#FP_EXP_TAG_ZERO
 1

	)

317 
	#FP_EXP_TAG_SPECIAL
 2

	)

318 
	#FP_EXP_TAG_EMPTY
 3

	)

320 
ölöe
 
u32
 
	$twd_fx§_to_i387
(
i387_fxßve_°ru˘
 *
fxßve
)

322 
_Âxªg
 *
°
;

323 
u32
 
tos
 = (
fxßve
->
swd
 >> 11) & 7;

324 
u32
 
twd
 = (Ë
fxßve
->twd;

325 
u32
 
èg
;

326 
u32
 
ªt
 = 0xffff0000u;

327 
i
;

329 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

330 i‡(
twd
 & 0x1) {

331 
°
 = 
	`FPREG_ADDR
(
fxßve
, (
i
 - 
tos
) & 7);

333 
°
->
exp⁄ít
 & 0x7fff) {

335 
èg
 = 
FP_EXP_TAG_SPECIAL
;

338 i‡(!
°
->
signifiˇnd
[0] &&

339 !
°
->
signifiˇnd
[1] &&

340 !
°
->
signifiˇnd
[2] &&

341 !
°
->
signifiˇnd
[3])

342 
èg
 = 
FP_EXP_TAG_ZERO
;

344 
èg
 = 
FP_EXP_TAG_SPECIAL
;

347 i‡(
°
->
signifiˇnd
[3] & 0x8000)

348 
èg
 = 
FP_EXP_TAG_VALID
;

350 
èg
 = 
FP_EXP_TAG_SPECIAL
;

354 
èg
 = 
FP_EXP_TAG_EMPTY
;

356 
ªt
 |
èg
 << (2 * 
i
);

358  
ªt
;

359 
	}
}

366 
	$c⁄vît_‰om_fx§
(
u£r_i387_ü32_°ru˘
 *
ív
, 
èsk_°ru˘
 *
tsk
)

368 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

369 
_Âªg
 *
to
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

370 
_Âxªg
 *
‰om
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

371 
i
;

373 
ív
->
cwd
 = 
fxßve
->cwd | 0xffff0000u;

374 
ív
->
swd
 = 
fxßve
->swd | 0xffff0000u;

375 
ív
->
twd
 = 
	`twd_fx§_to_i387
(
fxßve
);

377 #ifde‡
CONFIG_X86_64


378 
ív
->
fù
 = 
fxßve
->
rù
;

379 
ív
->
foo
 = 
fxßve
->
rdp
;

380 i‡(
tsk
 =
cuºít
) {

385 
	`asm
("mov %%ds, %[fos]" : [
fos
] "Ù" (
ív
->fos));

386 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "Ù" (
ív
->fcs));

388 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

390 
ív
->
fos
 = 0xffff0000 | 
tsk
->
thªad
.
ds
;

391 
ív
->
fcs
 = 
ªgs
->
cs
;

394 
ív
->
fù
 = 
fxßve
->fip;

395 
ív
->
fcs
 = (
u16
Ë
fxßve
->fc†| ((
u32
Ëfxßve->
f›
 << 16);

396 
ív
->
foo
 = 
fxßve
->foo;

397 
ív
->
fos
 = 
fxßve
->fos;

400 
i
 = 0; i < 8; ++i)

401 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (to[0]));

402 
	}
}

404 
	$c⁄vît_to_fx§
(
èsk_°ru˘
 *
tsk
,

405 c⁄° 
u£r_i387_ü32_°ru˘
 *
ív
)

408 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

409 
_Âªg
 *
‰om
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

410 
_Âxªg
 *
to
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

411 
i
;

413 
fxßve
->
cwd
 = 
ív
->cwd;

414 
fxßve
->
swd
 = 
ív
->swd;

415 
fxßve
->
twd
 = 
	`twd_i387_to_fx§
(
ív
->twd);

416 
fxßve
->
f›
 = (
u16
Ë((
u32
Ë
ív
->
fcs
 >> 16);

417 #ifde‡
CONFIG_X86_64


418 
fxßve
->
rù
 = 
ív
->
fù
;

419 
fxßve
->
rdp
 = 
ív
->
foo
;

422 
fxßve
->
fù
 = 
ív
->fip;

423 
fxßve
->
fcs
 = (
ív
->fcs & 0xffff);

424 
fxßve
->
foo
 = 
ív
->foo;

425 
fxßve
->
fos
 = 
ív
->fos;

428 
i
 = 0; i < 8; ++i)

429 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (from[0]));

430 
	}
}

432 
	$Âªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

433 
pos
, 
cou¡
,

434 *
kbuf
, 
__u£r
 *
ubuf
)

436 
u£r_i387_ü32_°ru˘
 
ív
;

437 
ªt
;

439 
ªt
 = 
	`öô_Âu
(
èrgë
);

440 i‡(
ªt
)

441  
ªt
;

443 i‡(!
HAVE_HWFP
)

444  
	`Âªgs_so·_gë
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

446 i‡(!
˝u_has_fx§
) {

447  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

448 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0,

452 i‡(
kbuf
 && 
pos
 =0 && 
cou¡
 =(
ív
)) {

453 
	`c⁄vît_‰om_fx§
(
kbuf
, 
èrgë
);

457 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

459  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

460 
	}
}

462 
	$Âªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

463 
pos
, 
cou¡
,

464 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

466 
u£r_i387_ü32_°ru˘
 
ív
;

467 
ªt
;

469 
ªt
 = 
	`öô_Âu
(
èrgë
);

470 i‡(
ªt
)

471  
ªt
;

473 i‡(!
HAVE_HWFP
)

474  
	`Âªgs_so·_£t
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

476 i‡(!
˝u_has_fx§
) {

477  
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

478 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0, -1);

481 i‡(
pos
 > 0 || 
cou¡
 < (
ív
))

482 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

484 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

485 i‡(!
ªt
)

486 
	`c⁄vît_to_fx§
(
èrgë
, &
ív
);

492 i‡(
˝u_has_xßve
)

493 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FP
;

494  
ªt
;

495 
	}
}

501 
ölöe
 
	$ßve_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

503 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

504 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

506 
Â
->
°©us
 = fp->
swd
;

507 i‡(
	`__c›y_to_u£r
(
buf
, 
Â
, (
i387_fßve_°ru˘
)))

510 
	}
}

512 
	$ßve_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

514 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

515 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

516 
u£r_i387_ü32_°ru˘
 
ív
;

517 
îr
 = 0;

519 
	`c⁄vît_‰om_fx§
(&
ív
, 
tsk
);

520 i‡(
	`__c›y_to_u£r
(
buf
, &
ív
, (env)))

523 
îr
 |
	`__put_u£r
(
fx
->
swd
, &
buf
->
°©us
);

524 
îr
 |
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

525 i‡(
îr
)

528 i‡(
	`__c›y_to_u£r
(&
buf
->
_fx§_ív
[0], 
fx
, 
x°©e_size
))

531 
	}
}

533 
	$ßve_i387_xßve
(
__u£r
 *
buf
)

535 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

536 
_Â°©e_ü32
 
__u£r
 *
fx
 = 
buf
;

537 
îr
 = 0;

550 
tsk
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

552 i‡(
	`ßve_i387_fxßve
(
fx
) < 0)

555 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved_ü32
,

556 (
_Âx_sw_byãs
));

557 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

558 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_ü32_size


559 - 
FP_XSTATE_MAGIC2_SIZE
));

560 i‡(
îr
)

564 
	}
}

566 
	$ßve_i387_x°©e_ü32
(
__u£r
 *
buf
)

568 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

569 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

571 i‡(!
	`u£d_m©h
())

574 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_ü32_size
))

575  -
EACCES
;

580 
	`˛ór_u£d_m©h
();

582 i‡(!
HAVE_HWFP
) {

583  
	`Âªgs_so·_gë
(
cuºít
, 
NULL
,

584 0, (
u£r_i387_ü32_°ru˘
),

585 
NULL
, 
Â
) ? -1 : 1;

588 
	`u∆azy_Âu
(
tsk
);

590 i‡(
˝u_has_xßve
)

591  
	`ßve_i387_xßve
(
Â
);

592 i‡(
˝u_has_fx§
)

593  
	`ßve_i387_fxßve
(
Â
);

595  
	`ßve_i387_fßve
(
Â
);

596 
	}
}

598 
ölöe
 
	$ª°‹e_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

600 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

602  
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fßve
, 
buf
,

603 (
i387_fßve_°ru˘
));

604 
	}
}

606 
	$ª°‹e_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
,

607 
size
)

609 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

610 
u£r_i387_ü32_°ru˘
 
ív
;

611 
îr
;

613 
îr
 = 
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fxßve
, &
buf
->
_fx§_ív
[0],

614 
size
);

616 
tsk
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

617 i‡(
îr
 || 
	`__c›y_‰om_u£r
(&
ív
, 
buf
, (env)))

619 
	`c⁄vît_to_fx§
(
tsk
, &
ív
);

622 
	}
}

624 
	$ª°‹e_i387_xßve
(
__u£r
 *
buf
)

626 
_Âx_sw_byãs
 
fx_sw_u£r
;

627 
_Â°©e_ü32
 
__u£r
 *
fx_u£r
 =

628 ((
_Â°©e_ü32
 
__u£r
 *Ë
buf
);

629 
i387_fxßve_°ru˘
 
__u£r
 *
fx
 =

630 (
i387_fxßve_°ru˘
 
__u£r
 *Ë&
fx_u£r
->
_fx§_ív
[0];

631 
xßve_hdr_°ru˘
 *
xßve_hdr
 =

632 &
cuºít
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
;

633 
u64
 
mask
;

634 
îr
;

636 i‡(
	`check_f‹_x°©e
(
fx
, 
buf
, &
fx_sw_u£r
))

637 
fx_⁄ly
;

639 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

641 
îr
 = 
	`ª°‹e_i387_fxßve
(
buf
, 
fx_sw_u£r
.
x°©e_size
);

643 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

647 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

653 
mask
 = ~(
p˙txt_mask
 & ~mask);

654 
xßve_hdr
->
x°©e_bv
 &
mask
;

656  
îr
;

657 
fx_⁄ly
:

663 
xßve_hdr
->
x°©e_bv
 = 
XSTATE_FPSSE
;

664  
	`ª°‹e_i387_fxßve
(
buf
, (
i387_fxßve_°ru˘
));

665 
	}
}

667 
	$ª°‹e_i387_x°©e_ü32
(
__u£r
 *
buf
)

669 
îr
;

670 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

671 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

673 i‡(
HAVE_HWFP
)

674 
	`˛ór_Âu
(
tsk
);

676 i‡(!
buf
) {

677 i‡(
	`u£d_m©h
()) {

678 
	`˛ór_Âu
(
tsk
);

679 
	`˛ór_u£d_m©h
();

684 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_ü32_size
))

685  -
EACCES
;

687 i‡(!
	`u£d_m©h
()) {

688 
îr
 = 
	`öô_Âu
(
tsk
);

689 i‡(
îr
)

690  
îr
;

693 i‡(
HAVE_HWFP
) {

694 i‡(
˝u_has_xßve
)

695 
îr
 = 
	`ª°‹e_i387_xßve
(
buf
);

696 i‡(
˝u_has_fx§
)

697 
îr
 = 
	`ª°‹e_i387_fxßve
(
Â
, (

698 
i387_fxßve_°ru˘
));

700 
îr
 = 
	`ª°‹e_i387_fßve
(
Â
);

702 
îr
 = 
	`Âªgs_so·_£t
(
cuºít
, 
NULL
,

703 0, (
u£r_i387_ü32_°ru˘
),

704 
NULL
, 
Â
) != 0;

706 
	`£t_u£d_m©h
();

708  
îr
;

709 
	}
}

718 
	$dump_Âu
(
±_ªgs
 *
ªgs
, 
u£r_i387_°ru˘
 *
Âu
)

720 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

721 
ÂvÆid
;

723 
ÂvÆid
 = !!
	`u£d_m©h
();

724 i‡(
ÂvÆid
)

725 
ÂvÆid
 = !
	`Âªgs_gë
(
tsk
, 
NULL
,

726 0, (
u£r_i387_ü32_°ru˘
),

727 
Âu
, 
NULL
);

729  
ÂvÆid
;

730 
	}
}

731 
EXPORT_SYMBOL
(
dump_Âu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<löux/öô.h
>

13 
	~<löux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_ªsume
(
sys_devi˚
 *
dev
)

26 
Êags
;

27 
i
;

29 
Êags
 = 
	`˛aim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_cou¡
(
i
, 1);

41 
	`íabÀ_dma
(4);

43 
	`ªÀa£_dma_lock
(
Êags
);

46 
	}
}

48 
	$i8237A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

51 
	}
}

53 
sysdev_˛ass
 
	gi8237_sysdev_˛ass
 = {

54 .
«me
 = "i8237",

55 .
	gsu•íd
 = 
i8237A_su•íd
,

56 .
	gªsume
 = 
i8237A_ªsume
,

59 
sys_devi˚
 
	gdevi˚_i8237A
 = {

60 .
id
 = 0,

61 .
	g˛s
 = &
i8237_sysdev_˛ass
,

64 
__öô
 
	$i8237A_öô_sysfs
()

66 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8237_sysdev_˛ass
);

67 i‡(!
îr‹
)

68 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8237A
);

69  
îr‹
;

70 
	}
}

71 
devi˚_öôˇŒ
(
i8237A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<löux/˛ockchùs.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/jiffõs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/io.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

17 
	~<asm/smp.h
>

19 
DEFINE_SPINLOCK
(
i8253_lock
);

20 
EXPORT_SYMBOL
(
i8253_lock
);

26 
˛ock_evít_devi˚
 *
	gglobÆ_˛ock_evít
;

33 
	$öô_pô_timî
(
˛ock_evít_mode
 
mode
,

34 
˛ock_evít_devi˚
 *
evt
)

36 
	`•ö_lock
(&
i8253_lock
);

38 
mode
) {

39 
CLOCK_EVT_MODE_PERIODIC
:

41 
	`outb_pô
(0x34, 
PIT_MODE
);

42 
	`outb_pô
(
LATCH
 & 0xf‡, 
PIT_CH0
);

43 
	`outb_pô
(
LATCH
 >> 8 , 
PIT_CH0
);

46 
CLOCK_EVT_MODE_SHUTDOWN
:

47 
CLOCK_EVT_MODE_UNUSED
:

48 i‡(
evt
->
mode
 =
CLOCK_EVT_MODE_PERIODIC
 ||

49 
evt
->
mode
 =
CLOCK_EVT_MODE_ONESHOT
) {

50 
	`outb_pô
(0x30, 
PIT_MODE
);

51 
	`outb_pô
(0, 
PIT_CH0
);

52 
	`outb_pô
(0, 
PIT_CH0
);

56 
CLOCK_EVT_MODE_ONESHOT
:

58 
	`outb_pô
(0x38, 
PIT_MODE
);

61 
CLOCK_EVT_MODE_RESUME
:

65 
	`•ö_u∆ock
(&
i8253_lock
);

66 
	}
}

73 
	$pô_√xt_evít
(
dñè
, 
˛ock_evít_devi˚
 *
evt
)

75 
	`•ö_lock
(&
i8253_lock
);

76 
	`outb_pô
(
dñè
 & 0xf‡, 
PIT_CH0
);

77 
	`outb_pô
(
dñè
 >> 8 , 
PIT_CH0
);

78 
	`•ö_u∆ock
(&
i8253_lock
);

81 
	}
}

91 
˛ock_evít_devi˚
 
	gpô_˚
 = {

92 .
«me
 = "pit",

93 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

94 .
	g£t_mode
 = 
öô_pô_timî
,

95 .
	g£t_√xt_evít
 = 
pô_√xt_evít
,

96 .
	gshi·
 = 32,

97 .
	gúq
 = 0,

104 
__öô
 
	$£tup_pô_timî
()

110 
pô_˚
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

111 
pô_˚
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,Öô_˚.
shi·
);

112 
pô_˚
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFF, &pit_ce);

113 
pô_˚
.
mö_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0xF, &pit_ce);

115 
	`˛ockevíts_ªgi°î_devi˚
(&
pô_˚
);

116 
globÆ_˛ock_evít
 = &
pô_˚
;

117 
	}
}

119 #i‚de‡
CONFIG_X86_64


125 
cy˛e_t
 
	$pô_ªad
(
˛ocksour˚
 *
cs
)

127 
ﬁd_cou¡
;

128 
u32
 
ﬁd_jifs
;

129 
Êags
;

130 
cou¡
;

131 
u32
 
jifs
;

133 
	`•ö_lock_úqßve
(&
i8253_lock
, 
Êags
);

147 
jifs
 = 
jiffõs
;

148 
	`outb_pô
(0x00, 
PIT_MODE
);

149 
cou¡
 = 
	`öb_pô
(
PIT_CH0
);

150 
cou¡
 |
	`öb_pô
(
PIT_CH0
) << 8;

153 i‡(
cou¡
 > 
LATCH
) {

154 
	`outb_pô
(0x34, 
PIT_MODE
);

155 
	`outb_pô
(
LATCH
 & 0xff, 
PIT_CH0
);

156 
	`outb_pô
(
LATCH
 >> 8, 
PIT_CH0
);

157 
cou¡
 = 
LATCH
 - 1;

173 i‡(
cou¡
 > 
ﬁd_cou¡
 && 
jifs
 =
ﬁd_jifs
)

174 
cou¡
 = 
ﬁd_cou¡
;

176 
ﬁd_cou¡
 = 
cou¡
;

177 
ﬁd_jifs
 = 
jifs
;

179 
	`•ö_u∆ock_úqª°‹e
(&
i8253_lock
, 
Êags
);

181 
cou¡
 = (
LATCH
 - 1) - count;

183  (
cy˛e_t
)(
jifs
 * 
LATCH
Ë+ 
cou¡
;

184 
	}
}

186 
˛ocksour˚
 
	gpô_cs
 = {

187 .
«me
 = "pit",

188 .
	gøtög
 = 110,

189 .
	gªad
 = 
pô_ªad
,

190 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

191 .
	gmu…
 = 0,

192 .
	gshi·
 = 20,

195 
__öô
 
	$öô_pô_˛ocksour˚
()

204 i‡(
	`num_possibÀ_˝us
(Ë> 1 || 
	`is_h≥t_íabÀd
() ||

205 
pô_˚
.
mode
 !
CLOCK_EVT_MODE_PERIODIC
)

208 
pô_cs
.
mu…
 = 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
,Öô_cs.
shi·
);

210  
	`˛ocksour˚_ªgi°î
(&
pô_cs
);

211 
	}
}

212 
¨ch_öôˇŒ
(
öô_pô_˛ocksour˚
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/øndom.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/kî√l_°©.h
>

11 
	~<löux/sysdev.h
>

12 
	~<löux/bô›s.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/io.h
>

15 
	~<löux/dñay.h
>

17 
	~<asm/©omic.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/timî.h
>

20 
	~<asm/hw_úq.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/desc.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/i8259.h
>

33 
	gi8259A_auto_eoi
;

34 
DEFINE_RAW_SPINLOCK
(
i8259A_lock
);

35 
mask_™d_ack_8259A
();

36 
mask_8259A
();

37 
unmask_8259A
();

38 
dißbÀ_8259A_úq
(
úq
);

39 
íabÀ_8259A_úq
(
úq
);

40 
öô_8259A
(
auto_eoi
);

41 
i8259A_úq_≥ndög
(
úq
);

43 
úq_chù
 
	gi8259A_chù
 = {

44 .
«me
 = "XT-PIC",

45 .
	gmask
 = 
dißbÀ_8259A_úq
,

46 .
	gdißbÀ
 = 
dißbÀ_8259A_úq
,

47 .
	gunmask
 = 
íabÀ_8259A_úq
,

48 .
	gmask_ack
 = 
mask_™d_ack_8259A
,

58 
	gˇched_úq_mask
 = 0xffff;

69 
	gio_≠ic_úqs
;

71 
	$dißbÀ_8259A_úq
(
úq
)

73 
mask
 = 1 << 
úq
;

74 
Êags
;

76 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

77 
ˇched_úq_mask
 |
mask
;

78 i‡(
úq
 & 8)

79 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

81 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

82 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

83 
	}
}

85 
	$íabÀ_8259A_úq
(
úq
)

87 
mask
 = ~(1 << 
úq
);

88 
Êags
;

90 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

91 
ˇched_úq_mask
 &
mask
;

92 i‡(
úq
 & 8)

93 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

95 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

96 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

97 
	}
}

99 
	$i8259A_úq_≥ndög
(
úq
)

101 
mask
 = 1<<
úq
;

102 
Êags
;

103 
ªt
;

105 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

106 i‡(
úq
 < 8)

107 
ªt
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
mask
;

109 
ªt
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
mask
 >> 8);

110 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

112  
ªt
;

113 
	}
}

115 
	$make_8259A_úq
(
úq
)

117 
	`dißbÀ_úq_nosync
(
úq
);

118 
io_≠ic_úqs
 &~(1<<
úq
);

119 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
i8259A_chù
, 
h™dÀ_Àvñ_úq
,

121 
	`íabÀ_úq
(
úq
);

122 
	}
}

130 
ölöe
 
	$i8259A_úq_ªÆ
(
úq
)

132 
vÆue
;

133 
úqmask
 = 1<<
úq
;

135 i‡(
úq
 < 8) {

136 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

137 
vÆue
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
úqmask
;

138 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

139  
vÆue
;

141 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

142 
vÆue
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
úqmask
 >> 8);

143 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

144  
vÆue
;

145 
	}
}

153 
	$mask_™d_ack_8259A
(
úq
)

155 
úqmask
 = 1 << 
úq
;

156 
Êags
;

158 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

174 i‡(
ˇched_úq_mask
 & 
úqmask
)

175 
•urious_8259A_úq
;

176 
ˇched_úq_mask
 |
úqmask
;

178 
h™dÀ_ªÆ_úq
:

179 i‡(
úq
 & 8) {

180 
	`öb
(
PIC_SLAVE_IMR
);

181 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

183 
	`outb
(0x60+(
úq
&7), 
PIC_SLAVE_CMD
);

185 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

187 
	`öb
(
PIC_MASTER_IMR
);

188 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

189 
	`outb
(0x60+
úq
, 
PIC_MASTER_CMD
);

191 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

194 
•urious_8259A_úq
:

198 i‡(
	`i8259A_úq_ªÆ
(
úq
))

203 
h™dÀ_ªÆ_úq
;

206 
•urious_úq_mask
;

211 i‡(!(
•urious_úq_mask
 & 
úqmask
)) {

212 
	`¥ötk
(
KERN_DEBUG


213 "•uriou†8259A i¡îru±: IRQ%d.\n", 
úq
);

214 
•urious_úq_mask
 |
úqmask
;

216 
	`©omic_öc
(&
úq_îr_cou¡
);

222 
h™dÀ_ªÆ_úq
;

224 
	}
}

226 
	gúq_åiggî
[2];

230 
	$ª°‹e_ELCR
(*
åiggî
)

232 
	`outb
(
åiggî
[0], 0x4d0);

233 
	`outb
(
åiggî
[1], 0x4d1);

234 
	}
}

236 
	$ßve_ELCR
(*
åiggî
)

239 
åiggî
[0] = 
	`öb
(0x4d0) & 0xF8;

240 
åiggî
[1] = 
	`öb
(0x4d1) & 0xDE;

241 
	}
}

243 
	$i8259A_ªsume
(
sys_devi˚
 *
dev
)

245 
	`öô_8259A
(
i8259A_auto_eoi
);

246 
	`ª°‹e_ELCR
(
úq_åiggî
);

248 
	}
}

250 
	$i8259A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

252 
	`ßve_ELCR
(
úq_åiggî
);

254 
	}
}

256 
	$i8259A_shutdown
(
sys_devi˚
 *
dev
)

262 
	`outb
(0xff, 
PIC_MASTER_IMR
);

263 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

265 
	}
}

267 
sysdev_˛ass
 
	gi8259_sysdev_˛ass
 = {

268 .
«me
 = "i8259",

269 .
	gsu•íd
 = 
i8259A_su•íd
,

270 .
	gªsume
 = 
i8259A_ªsume
,

271 .
	gshutdown
 = 
i8259A_shutdown
,

274 
sys_devi˚
 
	gdevi˚_i8259A
 = {

275 .
id
 = 0,

276 .
	g˛s
 = &
i8259_sysdev_˛ass
,

279 
__öô
 
	$i8259A_öô_sysfs
()

281 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8259_sysdev_˛ass
);

282 i‡(!
îr‹
)

283 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8259A
);

284  
îr‹
;

285 
	}
}

287 
devi˚_öôˇŒ
(
i8259A_öô_sysfs
);

289 
	$mask_8259A
()

291 
Êags
;

293 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

295 
	`outb
(0xff, 
PIC_MASTER_IMR
);

296 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

298 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

299 
	}
}

301 
	$unmask_8259A
()

303 
Êags
;

305 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

307 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

308 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

310 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

311 
	}
}

313 
	$öô_8259A
(
auto_eoi
)

315 
Êags
;

317 
i8259A_auto_eoi
 = 
auto_eoi
;

319 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

321 
	`outb
(0xff, 
PIC_MASTER_IMR
);

322 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

327 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

331 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

334 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

336 i‡(
auto_eoi
)

337 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

339 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

341 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

344 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

346 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

348 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

350 i‡(
auto_eoi
)

355 
i8259A_chù
.
mask_ack
 = 
dißbÀ_8259A_úq
;

357 
i8259A_chù
.
mask_ack
 = 
mask_™d_ack_8259A
;

359 
	`udñay
(100);

361 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

362 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

364 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

365 
	}
}

373 
	$Àgacy_pic_no›
(Ë{ 
	}
};

374 
	$Àgacy_pic_uöt_no›
(
unu£d
Ë{ 
	}
};

375 
	$Àgacy_pic_öt_no›
(
unu£d
Ë{ 
	}
};

377 
úq_chù
 
	gdummy_pic_chù
 = {

378 .
«me
 = "dummyÖic",

379 .
	gmask
 = 
Àgacy_pic_uöt_no›
,

380 .
	gunmask
 = 
Àgacy_pic_uöt_no›
,

381 .
	gdißbÀ
 = 
Àgacy_pic_uöt_no›
,

382 .
	gmask_ack
 = 
Àgacy_pic_uöt_no›
,

384 
	$Àgacy_pic_úq_≥ndög_no›
(
úq
)

387 
	}
}

389 
Àgacy_pic
 
	gnuŒ_Àgacy_pic
 = {

390 .
ƒ_Àgacy_úqs
 = 0,

391 .
	gchù
 = &
dummy_pic_chù
,

392 .
	gmask_Æl
 = 
Àgacy_pic_no›
,

393 .
	gª°‹e_mask
 = 
Àgacy_pic_no›
,

394 .
	göô
 = 
Àgacy_pic_öt_no›
,

395 .
	gúq_≥ndög
 = 
Àgacy_pic_úq_≥ndög_no›
,

396 .
	gmake_úq
 = 
Àgacy_pic_uöt_no›
,

399 
Àgacy_pic
 
	gdeÁu…_Àgacy_pic
 = {

400 .
ƒ_Àgacy_úqs
 = 
NR_IRQS_LEGACY
,

401 .
	gchù
 = &
i8259A_chù
,

402 .
	gmask_Æl
 = 
mask_8259A
,

403 .
	gª°‹e_mask
 = 
unmask_8259A
,

404 .
	göô
 = 
öô_8259A
,

405 .
	gúq_≥ndög
 = 
i8259A_úq_≥ndög
,

406 .
	gmake_úq
 = 
make_8259A_úq
,

409 
Àgacy_pic
 *
	gÀgacy_pic
 = &
deÁu…_Àgacy_pic
;

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

9 
	~<asm/uac˚ss.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/desc.h
>

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

23 
thªad_uni⁄
 
öô_thªad_uni⁄
 
	g__öô_èsk_d©a
 =

24 { 
INIT_THREAD_INFO
(
öô_èsk
) };

31 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

32 
EXPORT_SYMBOL
(
öô_èsk
);

41 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_°ru˘
, 
öô_tss
Ë
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/io.h
>

15 
io_dñay_ty≥
 
	g__ªad_mo°ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__öôd©a
 
	gio_dñay_ovîride
;

22 
	$«tive_io_dñay
()

24 
io_dñay_ty≥
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`udñay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
«tive_io_dñay
);

47 
__öô
 
	$dmi_io_dñay_0xed_p‹t
(c⁄° 
dmi_sy°em_id
 *
id
)

49 i‡(
io_dñay_ty≥
 =
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`¥_nŸi˚
("%s: usög 0xed I/O dñayÖ‹t\n", 
id
->
idít
);

51 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy°em_id
 
__öôd©a
 
	gio_dñay_0xed_p‹t_dmi_èbÀ
[] = {

63 .
ˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

64 .
	gidít
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

72 .
	gidít
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

80 .
	gidít
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

88 .
	gidít
 = "HP PavilionÅx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

96 .
	gidít
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__öô
 
	$io_dñay_öô
()

107 i‡(!
io_dñay_ovîride
)

108 
	`dmi_check_sy°em
(
io_dñay_0xed_p‹t_dmi_èbÀ
);

109 
	}
}

111 
__öô
 
	$io_dñay_∑øm
(*
s
)

113 i‡(!
s
)

114  -
EINVAL
;

116 i‡(!
	`°rcmp
(
s
, "0x80"))

117 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 i‡(!
	`°rcmp
(
s
, "0xed"))

119 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 i‡(!
	`°rcmp
(
s
, "udelay"))

121 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 i‡(!
	`°rcmp
(
s
, "none"))

123 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_dñay_ovîride
 = 1;

129 
	}
}

131 
óæy_∑øm
("io_dñay", 
io_dñay_∑øm
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<löux/sched.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/ˇ∑bûôy.h
>

9 
	~<löux/î∫o.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/i›‹t.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/°ddef.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/thªad_öfo.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<asm/sysˇŒs.h
>

20 
	$£t_bôm≠
(*
bôm≠
, 
ba£
,

21 
exã¡
, 
√w_vÆue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
exã¡
; i++) {

26 i‡(
√w_vÆue
)

27 
	`__£t_bô
(
i
, 
bôm≠
);

29 
	`__˛ór_bô
(
i
, 
bôm≠
);

31 
	}
}

36 
asmlökage
 
	$sys_i›îm
(
‰om
, 
num
, 
tu∫_⁄
)

38 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

39 
tss_°ru˘
 *
tss
;

40 
i
, 
max_l⁄g
, 
byãs
, 
byãs_upd©ed
;

42 i‡((
‰om
 + 
num
 <‰omË|| (‰om +Çum > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 i‡(
tu∫_⁄
 && !
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 i‡(!
t
->
io_bôm≠_±r
) {

53 *
bôm≠
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 i‡(!
bôm≠
)

56  -
ENOMEM
;

58 
	`mem£t
(
bôm≠
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_bôm≠_±r
 = 
bôm≠
;

60 
	`£t_thªad_Êag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

72 
	`£t_bôm≠
(
t
->
io_bôm≠_±r
, 
‰om
, 
num
, !
tu∫_⁄
);

78 
max_l⁄g
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 i‡(
t
->
io_bôm≠_±r
[
i
] != ~0UL)

81 
max_l⁄g
 = 
i
;

83 
byãs
 = (
max_l⁄g
 + 1) * ();

84 
byãs_upd©ed
 = 
	`max
(
byãs
, 
t
->
io_bôm≠_max
);

86 
t
->
io_bôm≠_max
 = 
byãs
;

89 
	`mem˝y
(
tss
->
io_bôm≠
, 
t
->
io_bôm≠_±r
, 
byãs_upd©ed
);

91 
	`put_˝u
();

94 
	}
}

106 
	$sys_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

108 
ﬁd
 = (
ªgs
->
Êags
 >> 12) & 3;

109 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

111 i‡(
Àvñ
 > 3)

112  -
EINVAL
;

114 i‡(
Àvñ
 > 
ﬁd
) {

115 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

116  -
EPERM
;

118 
ªgs
->
Êags
 = (ªgs->Êag†& ~
X86_EFLAGS_IOPL
Ë| (
Àvñ
 << 12);

119 
t
->
i›l
 = 
Àvñ
 << 12;

120 
	`£t_i›l_mask
(
t
->
i›l
);

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<löux/˝u.h
>

5 
	~<löux/öãºu±.h
>

6 
	~<löux/kî√l_°©.h
>

7 
	~<löux/£q_fûe.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/·ø˚.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/io_≠ic.h
>

13 
	~<asm/úq.h
>

14 
	~<asm/idÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/hw_úq.h
>

18 
©omic_t
 
	gúq_îr_cou¡
;

21 (*
x86_∂©f‹m_ùi_ˇŒback
)(Ë
NULL
;

27 
	$ack_bad_úq
(
úq
)

29 i‡(
	`¥ötk_øãlimô
())

30 
	`¥_îr
("u√x≥˘ed IRQÅø∞© ve˘‹ %02x\n", 
úq
);

41 
	`ack_APIC_úq
();

42 
	}
}

44 
	#úq_°©s
(
x
Ë(&
	`≥r_˝u
(
úq_°©
, x))

	)

48 
	$show_Ÿhî_öãºu±s
(
£q_fûe
 *
p
, 
¥ec
)

50 
j
;

52 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "NMI");

53 
	`f‹_óch_⁄löe_˝u
(
j
)

54 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
__nmi_cou¡
);

55 
	`£q_¥ötf
(
p
, " Non-maskable interrupts\n");

56 #ifde‡
CONFIG_X86_LOCAL_APIC


57 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "LOC");

58 
	`f‹_óch_⁄löe_˝u
(
j
)

59 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_timî_úqs
);

60 
	`£q_¥ötf
(
p
, " LocalÅimer interrupts\n");

62 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "SPU");

63 
	`f‹_óch_⁄löe_˝u
(
j
)

64 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_•urious_cou¡
);

65 
	`£q_¥ötf
(
p
, " Spurious interrupts\n");

66 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PMI");

67 
	`f‹_óch_⁄löe_˝u
(
j
)

68 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥rf_úqs
);

69 
	`£q_¥ötf
(
p
, " Performance monitoring interrupts\n");

70 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PND");

71 
	`f‹_óch_⁄löe_˝u
(
j
)

72 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥ndög_úqs
);

73 
	`£q_¥ötf
(
p
, " PerformanceÖending work\n");

75 i‡(
x86_∂©f‹m_ùi_ˇŒback
) {

76 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PLT");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
x86_∂©f‹m_ùis
);

79 
	`£q_¥ötf
(
p
, " Platform interrupts\n");

81 #ifde‡
CONFIG_SMP


82 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "RES");

83 
	`f‹_óch_⁄löe_˝u
(
j
)

84 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ªsched_cou¡
);

85 
	`£q_¥ötf
(
p
, " Rescheduling interrupts\n");

86 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CAL");

87 
	`f‹_óch_⁄löe_˝u
(
j
)

88 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ˇŒ_cou¡
);

89 
	`£q_¥ötf
(
p
, " Function call interrupts\n");

90 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TLB");

91 
	`f‹_óch_⁄löe_˝u
(
j
)

92 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_éb_cou¡
);

93 
	`£q_¥ötf
(
p
, " TLB shootdowns\n");

95 #ifde‡
CONFIG_X86_THERMAL_VECTOR


96 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TRM");

97 
	`f‹_óch_⁄löe_˝u
(
j
)

98 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thîmÆ_cou¡
);

99 
	`£q_¥ötf
(
p
, " ThermalÉvent interrupts\n");

101 #ifde‡
CONFIG_X86_MCE_THRESHOLD


102 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "THR");

103 
	`f‹_óch_⁄löe_˝u
(
j
)

104 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thªshﬁd_cou¡
);

105 
	`£q_¥ötf
(
p
, " Threshold APIC interrupts\n");

107 #ifde‡
CONFIG_X86_MCE


108 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCE");

109 
	`f‹_óch_⁄löe_˝u
(
j
)

110 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
j
));

111 
	`£q_¥ötf
(
p
, " Machine checkÉxceptions\n");

112 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCP");

113 
	`f‹_óch_⁄löe_˝u
(
j
)

114 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
j
));

115 
	`£q_¥ötf
(
p
, " Machine checkÖolls\n");

117 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "ERR", 
	`©omic_ªad
(&
úq_îr_cou¡
));

118 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

119 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "MIS", 
	`©omic_ªad
(&
úq_mis_cou¡
));

122 
	}
}

124 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

126 
Êags
, 
™y_cou¡
 = 0;

127 
i
 = *(
loff_t
 *Ë
v
, 
j
, 
¥ec
;

128 
úqa˘i⁄
 *
a˘i⁄
;

129 
úq_desc
 *
desc
;

131 i‡(
i
 > 
ƒ_úqs
)

134 
¥ec
 = 3, 
j
 = 1000;Öª¯< 10 && j <
ƒ_úqs
; ++prec)

135 
j
 *= 10;

137 i‡(
i
 =
ƒ_úqs
)

138  
	`show_Ÿhî_öãºu±s
(
p
, 
¥ec
);

141 i‡(
i
 == 0) {

142 
	`£q_¥ötf
(
p
, "%*s", 
¥ec
 + 8, "");

143 
	`f‹_óch_⁄löe_˝u
(
j
)

144 
	`£q_¥ötf
(
p
, "CPU%-8d", 
j
);

145 
	`£q_putc
(
p
, '\n');

148 
desc
 = 
	`úq_to_desc
(
i
);

149 i‡(!
desc
)

152 
	`øw_•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

153 
	`f‹_óch_⁄löe_˝u
(
j
)

154 
™y_cou¡
 |
	`k°©_úqs_˝u
(
i
, 
j
);

155 
a˘i⁄
 = 
desc
->action;

156 i‡(!
a˘i⁄
 && !
™y_cou¡
)

157 
out
;

159 
	`£q_¥ötf
(
p
, "%*d: ", 
¥ec
, 
i
);

160 
	`f‹_óch_⁄löe_˝u
(
j
)

161 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs_˝u
(
i
, 
j
));

162 
	`£q_¥ötf
(
p
, " %8s", 
desc
->
chù
->
«me
);

163 
	`£q_¥ötf
(
p
, "-%-8s", 
desc
->
«me
);

165 i‡(
a˘i⁄
) {

166 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

167 (
a˘i⁄
 =á˘i⁄->
√xt
Ë!
NULL
)

168 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

171 
	`£q_putc
(
p
, '\n');

172 
out
:

173 
	`øw_•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

175 
	}
}

180 
u64
 
	$¨ch_úq_°©_˝u
(
˝u
)

182 
u64
 
sum
 = 
	`úq_°©s
(
˝u
)->
__nmi_cou¡
;

184 #ifde‡
CONFIG_X86_LOCAL_APIC


185 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_timî_úqs
;

186 
sum
 +
	`úq_°©s
(
˝u
)->
úq_•urious_cou¡
;

187 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥rf_úqs
;

188 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥ndög_úqs
;

190 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

191 
sum
 +
	`úq_°©s
(
˝u
)->
x86_∂©f‹m_ùis
;

192 #ifde‡
CONFIG_SMP


193 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ªsched_cou¡
;

194 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ˇŒ_cou¡
;

195 
sum
 +
	`úq_°©s
(
˝u
)->
úq_éb_cou¡
;

197 #ifde‡
CONFIG_X86_THERMAL_VECTOR


198 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thîmÆ_cou¡
;

200 #ifde‡
CONFIG_X86_MCE_THRESHOLD


201 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thªshﬁd_cou¡
;

203 #ifde‡
CONFIG_X86_MCE


204 
sum
 +
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
˝u
);

205 
sum
 +
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
˝u
);

207  
sum
;

208 
	}
}

210 
u64
 
	$¨ch_úq_°©
()

212 
u64
 
sum
 = 
	`©omic_ªad
(&
úq_îr_cou¡
);

214 #ifde‡
CONFIG_X86_IO_APIC


215 
sum
 +
	`©omic_ªad
(&
úq_mis_cou¡
);

217  
sum
;

218 
	}
}

226 
__úq_íåy
 
	$do_IRQ
(
±_ªgs
 *
ªgs
)

228 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

231 
ve˘‹
 = ~
ªgs
->
‹ig_ax
;

232 
úq
;

234 
	`exô_idÀ
();

235 
	`úq_íãr
();

237 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

239 i‡(!
	`h™dÀ_úq
(
úq
, 
ªgs
)) {

240 
	`ack_APIC_úq
();

242 i‡(
	`¥ötk_øãlimô
())

243 
	`¥_emîg
("%s: %d.%d No irq handler for vector (irq %d)\n",

244 
__func__
, 
	`smp_¥o˚ss‹_id
(), 
ve˘‹
, 
úq
);

247 
	`úq_exô
();

249 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

251 
	}
}

256 
	$smp_x86_∂©f‹m_ùi
(
±_ªgs
 *
ªgs
)

258 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

260 
	`ack_APIC_úq
();

262 
	`exô_idÀ
();

264 
	`úq_íãr
();

266 
	`öc_úq_°©
(
x86_∂©f‹m_ùis
);

268 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

269 
	`x86_∂©f‹m_ùi_ˇŒback
();

271 
	`úq_exô
();

273 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

274 
	}
}

276 
EXPORT_SYMBOL_GPL
(
ve˘‹_u£d_by_≥r˝u_úq
);

278 #ifde‡
CONFIG_HOTPLUG_CPU


280 
	$fixup_úqs
()

282 
úq
, 
ve˘‹
;

283 
w¨√d
;

284 
úq_desc
 *
desc
;

286 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

287 
bªak_afföôy
 = 0;

288 
£t_afföôy
 = 1;

289 c⁄° 
˝umask
 *
afföôy
;

291 i‡(!
desc
)

293 i‡(
úq
 == 2)

297 
	`øw_•ö_lock
(&
desc
->
lock
);

299 
afföôy
 = 
desc
->affinity;

300 i‡(!
	`úq_has_a˘i⁄
(
úq
) ||

301 
	`˝umask_equÆ
(
afföôy
, 
˝u_⁄löe_mask
)) {

302 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

311 
	`úq_f‹˚_com∂ëe_move
(
úq
);

313 i‡(
	`˝umask_™y_™d
(
afföôy
, 
˝u_⁄löe_mask
Ë>
ƒ_˝u_ids
) {

314 
bªak_afföôy
 = 1;

315 
afföôy
 = 
˝u_Æl_mask
;

318 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
mask
)

319 
desc
->
chù
->
	`mask
(
úq
);

321 i‡(
desc
->
chù
->
£t_afföôy
)

322 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
afföôy
);

323 i‡(!(
w¨√d
++))

324 
£t_afföôy
 = 0;

326 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
unmask
)

327 
desc
->
chù
->
	`unmask
(
úq
);

329 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

331 i‡(
bªak_afföôy
 && 
£t_afföôy
)

332 
	`¥ötk
("Brokêafföôy f‹ irq %i\n", 
úq
);

333 i‡(!
£t_afföôy
)

334 
	`¥ötk
("C™nŸ sëáfföôy f‹ irq %i\n", 
úq
);

346 
	`mdñay
(1);

348 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

349 
úr
;

351 i‡(
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] < 0)

354 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

355 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

356 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

358 
desc
 = 
	`úq_to_desc
(
úq
);

359 
	`øw_•ö_lock
(&
desc
->
lock
);

360 i‡(
desc
->
chù
->
ªåiggî
)

361 
desc
->
chù
->
	`ªåiggî
(
úq
);

362 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

365 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/·ø˚.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/smp.h
>

19 
	~<asm/io_≠ic.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/≠ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
úq_˝u°©_t
, 
úq_°©
);

24 
EXPORT_PER_CPU_SYMBOL
(
úq_°©
);

26 
DEFINE_PER_CPU
(
±_ªgs
 *, 
úq_ªgs
);

27 
EXPORT_PER_CPU_SYMBOL
(
úq_ªgs
);

36 
ölöe
 
	$°ack_ovîÊow_check
(
±_ªgs
 *
ªgs
)

38 #ifde‡
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`èsk_°ack_∑ge
(
cuºít
);

41 
	`WARN_ONCE
(
ªgs
->
•
 >
curba£
 &&

42 
ªgs
->
•
 <
curba£
 + 
THREAD_SIZE
 &&

43 
ªgs
->
•
 < 
curba£
 + (
thªad_öfo
) +

44 (
±_ªgs
) + 128,

47 
cuºít
->
comm
, 
curba£
, 
ªgs
->
•
);

49 
	}
}

51 
boﬁ
 
	$h™dÀ_úq
(
úq
, 
±_ªgs
 *
ªgs
)

53 
úq_desc
 *
desc
;

55 
	`°ack_ovîÊow_check
(
ªgs
);

57 
desc
 = 
	`úq_to_desc
(
úq
);

58 i‡(
	`u∆ikñy
(!
desc
))

59  
Ál£
;

61 
	`gíîic_h™dÀ_úq_desc
(
úq
, 
desc
);

62  
åue
;

63 
	}
}

66 
ˇŒ_so·úq
();

68 
asmlökage
 
	$do_so·úq
()

70 
__u32
 
≥ndög
;

71 
Êags
;

73 i‡(
	`ö_öãºu±
())

76 
	`loˇl_úq_ßve
(
Êags
);

77 
≥ndög
 = 
	`loˇl_so·úq_≥ndög
();

79 i‡(
≥ndög
) {

80 
	`ˇŒ_so·úq
();

81 
	`WARN_ON_ONCE
(
	`so·úq_cou¡
());

83 
	`loˇl_úq_ª°‹e
(
Êags
);

84 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/øndom.h
>

9 
	~<löux/k¥obes.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/sysdev.h
>

13 
	~<löux/bô›s.h
>

14 
	~<löux/a˝i.h
>

15 
	~<löux/io.h
>

16 
	~<löux/dñay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/timî.h
>

21 
	~<asm/hw_úq.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/i8259.h
>

27 
	~<asm/å≠s.h
>

45 #ifde‡
CONFIG_X86_32


58 
úqªtu∫_t
 
	$m©h_îr‹_úq
(
˝l
, *
dev_id
)

60 
	`outb
(0, 0xF0);

61 i‡(
ign‹e_Âu_úq
 || !
boŸ_˝u_d©a
.
h¨d_m©h
)

62  
IRQ_NONE
;

63 
	`m©h_îr‹
((
__u£r
 *)
	`gë_úq_ªgs
()->
ù
);

64  
IRQ_HANDLED
;

65 
	}
}

71 
úqa˘i⁄
 
	gÂu_úq
 = {

72 .
h™dÀr
 = 
m©h_îr‹_úq
,

73 .
	g«me
 = "fpu",

80 
úqa˘i⁄
 
	gúq2
 = {

81 .
h™dÀr
 = 
no_a˘i⁄
,

82 .
	g«me
 = "cascade",

85 
DEFINE_PER_CPU
(
ve˘‹_úq_t
, 
ve˘‹_úq
) = {

86 [0 ... 
NR_VECTORS
 - 1] = -1,

89 
	$ve˘‹_u£d_by_≥r˝u_úq
(
ve˘‹
)

91 
˝u
;

93 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

94 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] != -1)

99 
	}
}

101 
__öô
 
	$öô_ISA_úqs
()

103 
i
;

105 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

106 
	`öô_b•_APIC
();

108 
Àgacy_pic
->
	`öô
(0);

113 
i
 = 0; i < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; i++) {

114 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
i
);

116 
desc
->
°©us
 = 
IRQ_DISABLED
;

117 
desc
->
a˘i⁄
 = 
NULL
;

118 
desc
->
dïth
 = 1;

120 
	`£t_úq_chù_™d_h™dÀr_«me
(
i
, &
i8259A_chù
,

121 
h™dÀ_Àvñ_úq
, "XT");

123 
	}
}

125 
__öô
 
	$öô_IRQ
()

127 
i
;

137 
i
 = 0; i < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; i++)

138 
	`≥r_˝u
(
ve˘‹_úq
, 0)[
IRQ0_VECTOR
 + 
i
] = i;

140 
x86_öô
.
úqs
.
	`öå_öô
();

141 
	}
}

146 
	$£tup_ve˘‹_úq
(
˝u
)

148 #i‚de‡
CONFIG_X86_IO_APIC


149 
úq
;

158 
úq
 = 0; irq < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; irq++)

159 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
IRQ0_VECTOR
 + 
úq
] = irq;

162 
	`__£tup_ve˘‹_úq
(
˝u
);

163 
	}
}

165 
__öô
 
	$smp_öå_öô
()

167 #ifde‡
CONFIG_SMP


168 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

173 
	`Æloc_öå_g©e
(
RESCHEDULE_VECTOR
, 
ªscheduÀ_öãºu±
);

176 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
övÆid©e_öãºu±0
);

177 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
övÆid©e_öãºu±1
);

178 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
övÆid©e_öãºu±2
);

179 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
övÆid©e_öãºu±3
);

180 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
övÆid©e_öãºu±4
);

181 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
övÆid©e_öãºu±5
);

182 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
övÆid©e_öãºu±6
);

183 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
övÆid©e_öãºu±7
);

186 
	`Æloc_öå_g©e
(
CALL_FUNCTION_VECTOR
, 
ˇŒ_fun˘i⁄_öãºu±
);

189 
	`Æloc_öå_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

190 
ˇŒ_fun˘i⁄_sögÀ_öãºu±
);

193 
	`£t_öå_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
úq_move_˛ónup_öãºu±
);

194 
	`£t_bô
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_ve˘‹s
);

197 
	`Æloc_öå_g©e
(
REBOOT_VECTOR
, 
ªboŸ_öãºu±
);

200 
	}
}

202 
__öô
 
	$≠ic_öå_öô
()

204 
	`smp_öå_öô
();

206 #ifde‡
CONFIG_X86_THERMAL_VECTOR


207 
	`Æloc_öå_g©e
(
THERMAL_APIC_VECTOR
, 
thîmÆ_öãºu±
);

209 #ifde‡
CONFIG_X86_MCE_THRESHOLD


210 
	`Æloc_öå_g©e
(
THRESHOLD_APIC_VECTOR
, 
thªshﬁd_öãºu±
);

212 #i‡
	`deföed
(
CONFIG_X86_MCE
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

213 
	`Æloc_öå_g©e
(
MCE_SELF_VECTOR
, 
m˚_£lf_öãºu±
);

216 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

218 
	`Æloc_öå_g©e
(
LOCAL_TIMER_VECTOR
, 
≠ic_timî_öãºu±
);

221 
	`Æloc_öå_g©e
(
X86_PLATFORM_IPI_VECTOR
, 
x86_∂©f‹m_ùi
);

224 
	`Æloc_öå_g©e
(
SPURIOUS_APIC_VECTOR
, 
•urious_öãºu±
);

225 
	`Æloc_öå_g©e
(
ERROR_APIC_VECTOR
, 
îr‹_öãºu±
);

228 #ifde‡
CONFIG_PERF_EVENTS


229 
	`Æloc_öå_g©e
(
LOCAL_PENDING_VECTOR
, 
≥rf_≥ndög_öãºu±
);

233 
	}
}

235 
__öô
 
	$«tive_öô_IRQ
()

237 
i
;

240 
x86_öô
.
úqs
.
	`¥e_ve˘‹_öô
();

242 
	`≠ic_öå_öô
();

249 
i
 = 
FIRST_EXTERNAL_VECTOR
; i < 
NR_VECTORS
; i++) {

251 i‡(!
	`ã°_bô
(
i
, 
u£d_ve˘‹s
))

252 
	`£t_öå_g©e
(
i
, 
öãºu±
[i-
FIRST_EXTERNAL_VECTOR
]);

255 i‡(!
a˝i_iﬂpic
)

256 
	`£tup_úq
(2, &
úq2
);

258 #ifde‡
CONFIG_X86_32


263 i‡(
boŸ_˝u_d©a
.
h¨d_m©h
 && !
˝u_has_Âu
)

264 
	`£tup_úq
(
FPU_IRQ
, &
Âu_úq
);

266 
	`úq_˘x_öô
(
	`smp_¥o˚ss‹_id
());

268 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/öô.h
>

8 
	~<löux/î∫o.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/•ölock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_n‹thbridges
;

14 
EXPORT_SYMBOL
(
num_k8_n‹thbridges
);

16 
u32
 *
	gÊush_w‹ds
;

18 
pci_devi˚_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_n‹thbridges
;

26 
EXPORT_SYMBOL
(
k8_n‹thbridges
);

28 
pci_dev
 *
	$√xt_k8_n‹thbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 i‡(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ˇche_k8_n‹thbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 i‡(
num_k8_n‹thbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
)

48 
num_k8_n‹thbridges
++;

50 
k8_n‹thbridges
 = 
	`kmÆloc
((
num_k8_n‹thbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 i‡(!
k8_n‹thbridges
)

53  -
ENOMEM
;

55 i‡(!
num_k8_n‹thbridges
) {

56 
k8_n‹thbridges
[0] = 
NULL
;

60 
Êush_w‹ds
 = 
	`kmÆloc
(
num_k8_n‹thbridges
 * (
u32
), 
GFP_KERNEL
);

61 i‡(!
Êush_w‹ds
) {

62 
	`k‰ì
(
k8_n‹thbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
) {

69 
k8_n‹thbridges
[
i
] = 
dev
;

70 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x9c, &
Êush_w‹ds
[
i
++]);

72 
k8_n‹thbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ˇche_k8_n‹thbridges
);

79 
__öô
 
	$óæy_is_k8_nb
(
u32
 
devi˚
)

81 
pci_devi˚_id
 *
id
;

82 
u32
 
víd‹
 = 
devi˚
 & 0xffff;

83 
devi˚
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
víd‹
; id++)

85 i‡(
víd‹
 =
id
->víd‹ && 
devi˚
 == id->device)

88 
	}
}

90 
	$k8_Êush_g¨ts
()

92 
Êushed
, 
i
;

93 
Êags
;

94 
	`DEFINE_SPINLOCK
(
g¨t_lock
);

100 
	`•ö_lock_úqßve
(&
g¨t_lock
, 
Êags
);

101 
Êushed
 = 0;

102 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

103 
	`pci_wrôe_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
], 0x9c,

104 
Êush_w‹ds
[
i
]|1);

105 
Êushed
++;

107 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_ªad_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
],

112 0x9c, &
w
);

113 i‡(!(
w
 & 1))

115 
	`˝u_ªœx
();

118 
	`•ö_u∆ock_úqª°‹e
(&
g¨t_lock
, 
Êags
);

119 i‡(!
Êushed
)

120 
	`¥ötk
("nothingÅo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_Êush_g¨ts
);

124 
__öô
 
	$öô_k8_nbs
()

126 
îr
 = 0;

128 
îr
 = 
	`ˇche_k8_n‹thbridges
();

130 i‡(
îr
 < 0)

131 
	`¥ötk
(
KERN_NOTICE
 "K8 NB: CannotÉnumerate AMDÇorthbridges.\n");

133  
îr
;

134 
	}
}

137 
fs_öôˇŒ
(
öô_k8_nbs
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<löux/debugfs.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/°©.h
>

15 
	~<löux/io.h
>

16 
	~<löux/mm.h
>

18 
	~<asm/£tup.h
>

20 
díåy
 *
	g¨ch_debugfs_dú
;

21 
EXPORT_SYMBOL
(
¨ch_debugfs_dú
);

23 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


24 
	s£tup_d©a_node
 {

25 
u64
 
	m∑ddr
;

26 
u32
 
	mty≥
;

27 
u32
 
	mÀn
;

30 
ssize_t
 
	$£tup_d©a_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

31 
size_t
 
cou¡
, 
loff_t
 *
µos
)

33 
£tup_d©a_node
 *
node
 = 
fûe
->
¥iv©e_d©a
;

34 
ªmaö
;

35 
loff_t
 
pos
 = *
µos
;

36 
∑ge
 *
pg
;

37 *
p
;

38 
u64
 
∑
;

40 i‡(
pos
 < 0)

41  -
EINVAL
;

43 i‡(
pos
 >
node
->
Àn
)

46 i‡(
cou¡
 > 
node
->
Àn
 - 
pos
)

47 
cou¡
 = 
node
->
Àn
 - 
pos
;

49 
∑
 = 
node
->
∑ddr
 + (
£tup_d©a
Ë+ 
pos
;

50 
pg
 = 
	`p‚_to_∑ge
((
∑
 + 
cou¡
 - 1Ë>> 
PAGE_SHIFT
);

51 i‡(
	`PageHighMem
(
pg
)) {

52 
p
 = 
	`i‹em≠_ˇche
(
∑
, 
cou¡
);

53 i‡(!
p
)

54  -
ENXIO
;

56 
p
 = 
	`__va
(
∑
);

58 
ªmaö
 = 
	`c›y_to_u£r
(
u£r_buf
, 
p
, 
cou¡
);

60 i‡(
	`PageHighMem
(
pg
))

61 
	`iounm≠
(
p
);

63 i‡(
ªmaö
)

64  -
EFAULT
;

66 *
µos
 = 
pos
 + 
cou¡
;

68  
cou¡
;

69 
	}
}

71 
	$£tup_d©a_›í
(
öode
 *öode, 
fûe
 *file)

73 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

76 
	}
}

78 c⁄° 
fûe_›î©i⁄s
 
	gf›s_£tup_d©a
 = {

79 .
ªad
 = 
£tup_d©a_ªad
,

80 .
	g›í
 = 
£tup_d©a_›í
,

83 
__öô


84 
	$¸óã_£tup_d©a_node
(
díåy
 *
∑ª¡
, 
no
,

85 
£tup_d©a_node
 *
node
)

87 
díåy
 *
d
, *
ty≥
, *
d©a
;

88 
buf
[16];

90 
	`•rötf
(
buf
, "%d", 
no
);

91 
d
 = 
	`debugfs_¸óã_dú
(
buf
, 
∑ª¡
);

92 i‡(!
d
)

93  -
ENOMEM
;

95 
ty≥
 = 
	`debugfs_¸óã_x32
("ty≥", 
S_IRUGO
, 
d
, &
node
->type);

96 i‡(!
ty≥
)

97 
îr_dú
;

99 
d©a
 = 
	`debugfs_¸óã_fûe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
f›s_£tup_d©a
);

100 i‡(!
d©a
)

101 
îr_ty≥
;

105 
îr_ty≥
:

106 
	`debugfs_ªmove
(
ty≥
);

107 
îr_dú
:

108 
	`debugfs_ªmove
(
d
);

109  -
ENOMEM
;

110 
	}
}

112 
__öô
 
	$¸óã_£tup_d©a_nodes
(
díåy
 *
∑ª¡
)

114 
£tup_d©a_node
 *
node
;

115 
£tup_d©a
 *
d©a
;

116 
îr‹
 = -
ENOMEM
;

117 
díåy
 *
d
;

118 
∑ge
 *
pg
;

119 
u64
 
∑_d©a
;

120 
no
 = 0;

122 
d
 = 
	`debugfs_¸óã_dú
("£tup_d©a", 
∑ª¡
);

123 i‡(!
d
)

124  -
ENOMEM
;

126 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

128 
∑_d©a
) {

129 
node
 = 
	`kmÆloc
((*node), 
GFP_KERNEL
);

130 i‡(!
node
)

131 
îr_dú
;

133 
pg
 = 
	`p‚_to_∑ge
((
∑_d©a
+(*
d©a
)-1Ë>> 
PAGE_SHIFT
);

134 i‡(
	`PageHighMem
(
pg
)) {

135 
d©a
 = 
	`i‹em≠_ˇche
(
∑_d©a
, (*data));

136 i‡(!
d©a
) {

137 
	`k‰ì
(
node
);

138 
îr‹
 = -
ENXIO
;

139 
îr_dú
;

142 
d©a
 = 
	`__va
(
∑_d©a
);

144 
node
->
∑ddr
 = 
∑_d©a
;

145 
node
->
ty≥
 = 
d©a
->type;

146 
node
->
Àn
 = 
d©a
->len;

147 
îr‹
 = 
	`¸óã_£tup_d©a_node
(
d
, 
no
, 
node
);

148 
∑_d©a
 = 
d©a
->
√xt
;

150 i‡(
	`PageHighMem
(
pg
))

151 
	`iounm≠
(
d©a
);

152 i‡(
îr‹
)

153 
îr_dú
;

154 
no
++;

159 
îr_dú
:

160 
	`debugfs_ªmove
(
d
);

161  
îr‹
;

162 
	}
}

164 
debugfs_blob_wøµî
 
	gboŸ_∑øms_blob
 = {

165 .
d©a
 = &
boŸ_∑øms
,

166 .
	gsize
 = (
boŸ_∑øms
),

169 
__öô
 
	$boŸ_∑øms_kdebugfs_öô
()

171 
díåy
 *
dbp
, *
vîsi⁄
, *
d©a
;

172 
îr‹
 = -
ENOMEM
;

174 
dbp
 = 
	`debugfs_¸óã_dú
("boŸ_∑øms", 
NULL
);

175 i‡(!
dbp
)

176  -
ENOMEM
;

178 
vîsi⁄
 = 
	`debugfs_¸óã_x16
("vîsi⁄", 
S_IRUGO
, 
dbp
,

179 &
boŸ_∑øms
.
hdr
.
vîsi⁄
);

180 i‡(!
vîsi⁄
)

181 
îr_dú
;

183 
d©a
 = 
	`debugfs_¸óã_blob
("d©a", 
S_IRUGO
, 
dbp
,

184 &
boŸ_∑øms_blob
);

185 i‡(!
d©a
)

186 
îr_vîsi⁄
;

188 
îr‹
 = 
	`¸óã_£tup_d©a_nodes
(
dbp
);

189 i‡(
îr‹
)

190 
îr_d©a
;

194 
îr_d©a
:

195 
	`debugfs_ªmove
(
d©a
);

196 
îr_vîsi⁄
:

197 
	`debugfs_ªmove
(
vîsi⁄
);

198 
îr_dú
:

199 
	`debugfs_ªmove
(
dbp
);

200  
îr‹
;

201 
	}
}

204 
__öô
 
	$¨ch_kdebugfs_öô
()

206 
îr‹
 = 0;

208 
¨ch_debugfs_dú
 = 
	`debugfs_¸óã_dú
("x86", 
NULL
);

209 i‡(!
¨ch_debugfs_dú
)

210  -
ENOMEM
;

212 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


213 
îr‹
 = 
	`boŸ_∑øms_kdebugfs_öô
();

216  
îr‹
;

217 
	}
}

218 
¨ch_öôˇŒ
(
¨ch_kdebugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<löux/k¥obes.h
>

44 
	~<löux/±ø˚.h
>

45 
	~<löux/°rög.h
>

46 
	~<löux/¶ab.h
>

47 
	~<löux/h¨dúq.h
>

48 
	~<löux/¥ìm±.h
>

49 
	~<löux/moduÀ.h
>

50 
	~<löux/kdebug.h
>

51 
	~<löux/kÆlsyms.h
>

52 
	~<löux/·ø˚.h
>

54 
	~<asm/ˇcheÊush.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/pgèbÀ.h
>

57 
	~<asm/uac˚ss.h
>

58 
	~<asm/Æã∫©ive.h
>

59 
	~<asm/ö¢.h
>

60 
	~<asm/debugªg.h
>

62 
j¥obe_ªtu∫_íd
();

64 
DEFINE_PER_CPU
(
k¥obe
 *, 
cuºít_k¥obe
Ë
NULL
;

65 
DEFINE_PER_CPU
(
k¥obe_˘lblk
, kprobe_ctlblk);

67 
	#°ack_addr
(
ªgs
Ë((*)
	`kî√l_°ack_poöãr
‘egs))

	)

69 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

70 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

71 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

72 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

73 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

74 << (
row
 % 32))

	)

79 c⁄° 
u32
 
	gtwobyã_is_boo°abÀ
[256 / 32] = {

82 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

83 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

84 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

85 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

86 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

87 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

88 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

89 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

90 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

91 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

92 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

93 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

94 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

95 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

96 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

97 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

101 #unde‡
W


103 
kªçrobe_bœckpoöt
 
	gkªçrobe_bœckli°
[] = {

106 {
NULL
, NULL}

108 c⁄° 
	gkªçrobe_bœckli°_size
 = 
ARRAY_SIZE
(
kªçrobe_bœckli°
);

110 
__k¥obes
 
	$__sy¡hesize_ªœtive_ö¢
(*
‰om
, *
to
, 
u8
 
›
)

112 
	s__¨ch_ªœtive_ö¢
 {

113 
u8
 
›
;

114 
s32
 
øddr
;

115 } 
	`__©åibuã__
((
∑cked
)Ë*
ö¢
;

117 
ö¢
 = (
__¨ch_ªœtive_ö¢
 *)
‰om
;

118 
ö¢
->
øddr
 = (
s32
)(()(
to
Ë- (()(
‰om
) + 5));

119 
ö¢
->
›
 = op;

120 
	}
}

123 
__k¥obes
 
	$sy¡hesize_ªljump
(*
‰om
, *
to
)

125 
	`__sy¡hesize_ªœtive_ö¢
(
‰om
, 
to
, 
RELATIVEJUMP_OPCODE
);

126 
	}
}

132 
__k¥obes
 
	$is_REX_¥efix
(
k¥obe_›code_t
 *
ö¢
)

134 #ifde‡
CONFIG_X86_64


135 i‡((*
ö¢
 & 0xf0) == 0x40)

139 
	}
}

145 
__k¥obes
 
	$ˇn_boo°
(
k¥obe_›code_t
 *
›codes
)

147 
k¥obe_›code_t
 
›code
;

148 
k¥obe_›code_t
 *
‹ig_›codes
 = 
›codes
;

150 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(()
›codes
))

153 
ªåy
:

154 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

156 
›code
 = *(
›codes
++);

159 i‡(
›code
 == 0x0f) {

160 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

162  
	`ã°_bô
(*
›codes
,

163 (*)
twobyã_is_boo°abÀ
);

166 
›code
 & 0xf0) {

167 #ifde‡
CONFIG_X86_64


169 
ªåy
;

172 i‡(0x63 < 
›code
 && opcode < 0x67)

173 
ªåy
;

175  (
›code
 != 0x62 && opcode != 0x67);

180  (0xc1 < 
›code
 && opcode < 0xcc) || opcode == 0xcf;

183  (
›code
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

186  ((
›code
 & 0x04) || opcode == 0xea);

188 i‡((
›code
 & 0x0c) == 0 && opcode != 0xf1)

189 
ªåy
;

191  (
›code
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

194 i‡(
›code
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

195 
ªåy
;

197  (
›code
 != 0x2e && opcode != 0x9a);

199 
	}
}

202 
	$ªcovî_¥obed_ö°ru˘i⁄
(
k¥obe_›code_t
 *
buf
, 
addr
)

204 
k¥obe
 *
kp
;

205 
kp
 = 
	`gë_k¥obe
((*)
addr
);

206 i‡(!
kp
)

207  -
EINVAL
;

222 
	`mem˝y
(
buf
, 
kp
->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

223 
buf
[0] = 
kp
->
›code
;

225 
	}
}

228 
	g__dummy_buf
[
KSYM_NAME_LEN
];

231 
__k¥obes
 
	$ˇn_¥obe
(
∑ddr
)

233 
ªt
;

234 
addr
, 
off£t
 = 0;

235 
ö¢
 insn;

236 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

238 i‡(!
	`kÆlsyms_lookup
(
∑ddr
, 
NULL
, &
off£t
, NULL, 
__dummy_buf
))

242 
addr
 = 
∑ddr
 - 
off£t
;

243 
addr
 < 
∑ddr
) {

244 
	`kî√l_ö¢_öô
(&
ö¢
, (*)
addr
);

245 
	`ö¢_gë_›code
(&
ö¢
);

252 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

253 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
, 
addr
);

254 i‡(
ªt
)

261 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

263 
	`ö¢_gë_Àngth
(&
ö¢
);

264 
addr
 +
ö¢
.
Àngth
;

267  (
addr
 =
∑ddr
);

268 
	}
}

273 
__k¥obes
 
	$is_IF_modifõr
(
k¥obe_›code_t
 *
ö¢
)

275 *
ö¢
) {

287 i‡(
	`is_REX_¥efix
(
ö¢
))

288  
	`is_IF_modifõr
(++
ö¢
);

291 
	}
}

300 
__k¥obes
 
	$__c›y_ö°ru˘i⁄
(
u8
 *
de°
, u8 *
§c
, 
ªcovî
)

302 
ö¢
 insn;

303 
ªt
;

304 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

306 
	`kî√l_ö¢_öô
(&
ö¢
, 
§c
);

307 i‡(
ªcovî
) {

308 
	`ö¢_gë_›code
(&
ö¢
);

309 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

310 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
,

311 ()
§c
);

312 i‡(
ªt
)

314 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

317 
	`ö¢_gë_Àngth
(&
ö¢
);

318 
	`mem˝y
(
de°
, 
ö¢
.
kaddr
, in¢.
Àngth
);

320 #ifde‡
CONFIG_X86_64


321 i‡(
	`ö¢_rù_ªœtive
(&
ö¢
)) {

322 
s64
 
√wdi•
;

323 
u8
 *
di•
;

324 
	`kî√l_ö¢_öô
(&
ö¢
, 
de°
);

325 
	`ö¢_gë_di•œ˚mít
(&
ö¢
);

338 
√wdi•
 = (
u8
 *Ë
§c
 + (
s64
Ë
ö¢
.
di•œ˚mít
.
vÆue
 -

339 (
u8
 *Ë
de°
;

340 
	`BUG_ON
((
s64
Ë(
s32
Ë
√wdi•
 !=Çewdisp);

341 
di•
 = (
u8
 *Ë
de°
 + 
	`ö¢_off£t_di•œ˚mít
(&
ö¢
);

342 *(
s32
 *Ë
di•
 = (s32Ë
√wdi•
;

345  
ö¢
.
Àngth
;

346 
	}
}

348 
__k¥obes
 
	$¨ch_c›y_k¥obe
(
k¥obe
 *
p
)

354 
	`__c›y_ö°ru˘i⁄
(
p
->
aö¢
.
ö¢
,Ö->
addr
, 0);

356 i‡(
	`ˇn_boo°
(
p
->
addr
))

357 
p
->
aö¢
.
boo°abÀ
 = 0;

359 
p
->
aö¢
.
boo°abÀ
 = -1;

361 
p
->
›code
 = *p->
addr
;

362 
	}
}

364 
__k¥obes
 
	$¨ch_¥ï¨e_k¥obe
(
k¥obe
 *
p
)

366 i‡(
	`Æã∫©ives_ãxt_ª£rved
(
p
->
addr
,Ö->addr))

367  -
EINVAL
;

369 i‡(!
	`ˇn_¥obe
(()
p
->
addr
))

370  -
EILSEQ
;

372 
p
->
aö¢
.
ö¢
 = 
	`gë_ö¢_¶Ÿ
();

373 i‡(!
p
->
aö¢
.
ö¢
)

374  -
ENOMEM
;

375 
	`¨ch_c›y_k¥obe
(
p
);

377 
	}
}

379 
__k¥obes
 
	$¨ch_¨m_k¥obe
(
k¥obe
 *
p
)

381 
	`ãxt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

382 
	}
}

384 
__k¥obes
 
	$¨ch_dißrm_k¥obe
(
k¥obe
 *
p
)

386 
	`ãxt_poke
(
p
->
addr
, &p->
›code
, 1);

387 
	}
}

389 
__k¥obes
 
	$¨ch_ªmove_k¥obe
(
k¥obe
 *
p
)

391 i‡(
p
->
aö¢
.
ö¢
) {

392 
	`‰ì_ö¢_¶Ÿ
(
p
->
aö¢
.
ö¢
, (p->aö¢.
boo°abÀ
 == 1));

393 
p
->
aö¢
.
ö¢
 = 
NULL
;

395 
	}
}

397 
__k¥obes
 
	$ßve_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

399 
kcb
->
¥ev_k¥obe
.
kp
 = 
	`k¥obe_ru¬ög
();

400 
kcb
->
¥ev_k¥obe
.
°©us
 = kcb->
k¥obe_°©us
;

401 
kcb
->
¥ev_k¥obe
.
ﬁd_Êags
 = kcb->
k¥obe_ﬁd_Êags
;

402 
kcb
->
¥ev_k¥obe
.
ßved_Êags
 = kcb->
k¥obe_ßved_Êags
;

403 
	}
}

405 
__k¥obes
 
	$ª°‹e_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

407 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
kcb
->
¥ev_k¥obe
.
kp
;

408 
kcb
->
k¥obe_°©us
 = kcb->
¥ev_k¥obe
.
°©us
;

409 
kcb
->
k¥obe_ﬁd_Êags
 = kcb->
¥ev_k¥obe
.
ﬁd_Êags
;

410 
kcb
->
k¥obe_ßved_Êags
 = kcb->
¥ev_k¥obe
.
ßved_Êags
;

411 
	}
}

413 
__k¥obes
 
	$£t_cuºít_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

414 
k¥obe_˘lblk
 *
kcb
)

416 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
p
;

417 
kcb
->
k¥obe_ßved_Êags
 = kcb->
k¥obe_ﬁd_Êags


418 (
ªgs
->
Êags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

419 i‡(
	`is_IF_modifõr
(
p
->
aö¢
.
ö¢
))

420 
kcb
->
k¥obe_ßved_Êags
 &~
X86_EFLAGS_IF
;

421 
	}
}

423 
__k¥obes
 
	$˛ór_btf
()

425 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

426 
	`upd©e_debug˘lm§
(0);

427 
	}
}

429 
__k¥obes
 
	$ª°‹e_btf
()

431 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

432 
	`upd©e_debug˘lm§
(
cuºít
->
thªad
.
debug˘lm§
);

433 
	}
}

435 
__k¥obes
 
	$¨ch_¥ï¨e_kªçrobe
(
kªçrobe_ö°™˚
 *
ri
,

436 
±_ªgs
 *
ªgs
)

438 *
ßø
 = 
	`°ack_addr
(
ªgs
);

440 
ri
->
ªt_addr
 = (
k¥obe_›code_t
 *Ë*
ßø
;

443 *
ßø
 = (Ë&
kªçrobe_åampﬁöe
;

444 
	}
}

446 #ifde‡
CONFIG_OPTPROBES


447 
__k¥obes
 
£tup_dëour_executi⁄
(
k¥obe
 *
p
,

448 
±_ªgs
 *
ªgs
,

449 
ªíãr
);

451 
	#£tup_dëour_executi⁄
(
p
, 
ªgs
, 
ªíãr
Ë(0)

	)

454 
__k¥obes
 
	$£tup_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

455 
k¥obe_˘lblk
 *
kcb
, 
ªíãr
)

457 i‡(
	`£tup_dëour_executi⁄
(
p
, 
ªgs
, 
ªíãr
))

460 #i‡!
	`deföed
(
CONFIG_PREEMPT
)

461 i‡(
p
->
aö¢
.
boo°abÀ
 =1 && !p->
po°_h™dÀr
) {

463 i‡(!
ªíãr
)

464 
	`ª£t_cuºít_k¥obe
();

470 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

471 
	`¥ìm±_íabÀ_no_ªsched
();

475 i‡(
ªíãr
) {

476 
	`ßve_¥evious_k¥obe
(
kcb
);

477 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

478 
kcb
->
k¥obe_°©us
 = 
KPROBE_REENTER
;

480 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SS
;

482 
	`˛ór_btf
();

483 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

484 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

486 i‡(
p
->
›code
 =
BREAKPOINT_INSTRUCTION
)

487 
ªgs
->
ù
 = ()
p
->
addr
;

489 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

490 
	}
}

497 
__k¥obes
 
	$ªíãr_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

498 
k¥obe_˘lblk
 *
kcb
)

500 
kcb
->
k¥obe_°©us
) {

501 
KPROBE_HIT_SSDONE
:

502 
KPROBE_HIT_ACTIVE
:

503 
	`k¥obes_öc_nmis£d_cou¡
(
p
);

504 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 1);

506 
KPROBE_HIT_SS
:

513 
	`¥ötk
(
KERN_WARNING
 "Unrecoverable kprobe detectedát %p.\n",

514 
p
->
addr
);

515 
	`dump_k¥obe
(
p
);

516 
	`BUG
();

519 
	`WARN_ON
(1);

524 
	}
}

530 
__k¥obes
 
	$k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

532 
k¥obe_›code_t
 *
addr
;

533 
k¥obe
 *
p
;

534 
k¥obe_˘lblk
 *
kcb
;

536 
addr
 = (
k¥obe_›code_t
 *)(
ªgs
->
ù
 - (kprobe_opcode_t));

543 
	`¥ìm±_dißbÀ
();

545 
kcb
 = 
	`gë_k¥obe_˘lblk
();

546 
p
 = 
	`gë_k¥obe
(
addr
);

548 i‡(
p
) {

549 i‡(
	`k¥obe_ru¬ög
()) {

550 i‡(
	`ªíãr_k¥obe
(
p
, 
ªgs
, 
kcb
))

553 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

554 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

564 i‡(!
p
->
¥e_h™dÀr
 || !p->
	`¥e_h™dÀr
’, 
ªgs
))

565 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 0);

568 } i‡(*
addr
 !
BREAKPOINT_INSTRUCTION
) {

578 
ªgs
->
ù
 = ()
addr
;

579 
	`¥ìm±_íabÀ_no_ªsched
();

581 } i‡(
	`k¥obe_ru¬ög
()) {

582 
p
 = 
	`__gë_˝u_v¨
(
cuºít_k¥obe
);

583 i‡(
p
->
bªak_h™dÀr
 &&Ö->
	`bªak_h™dÀr
’, 
ªgs
)) {

584 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 0);

589 
	`¥ìm±_íabÀ_no_ªsched
();

591 
	}
}

593 #ifde‡
CONFIG_X86_64


594 
	#SAVE_REGS_STRING
 \

611 "Öushq %r15\n"

	)

612 
	#RESTORE_REGS_STRING
 \

629 "áddq $24, %r•\n"

	)

631 
	#SAVE_REGS_STRING
 \

643 "Öush»%ebx\n"

	)

644 
	#RESTORE_REGS_STRING
 \

653 "ádd»$24, %e•\n"

	)

660 
__u£d
 
__k¥obes
 
	$kªçrobe_åampﬁöe_hﬁdî
()

662 
asm
 volatile (

665 #ifde‡
CONFIG_X86_64


669 
SAVE_REGS_STRING


674 
RESTORE_REGS_STRING


678 
SAVE_REGS_STRING


686 
RESTORE_REGS_STRING


690 
	}
}

695 
__u£d
 
__k¥obes
 *
	$åampﬁöe_h™dÀr
(
±_ªgs
 *
ªgs
)

697 
kªçrobe_ö°™˚
 *
ri
 = 
NULL
;

698 
hli°_hód
 *
hód
, 
em±y_Ω
;

699 
hli°_node
 *
node
, *
tmp
;

700 
Êags
, 
‹ig_ªt_addªss
 = 0;

701 
åampﬁöe_addªss
 = ()&
kªçrobe_åampﬁöe
;

703 
	`INIT_HLIST_HEAD
(&
em±y_Ω
);

704 
	`kªçrobe_hash_lock
(
cuºít
, &
hód
, &
Êags
);

706 #ifde‡
CONFIG_X86_64


707 
ªgs
->
cs
 = 
__KERNEL_CS
;

709 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

710 
ªgs
->
gs
 = 0;

712 
ªgs
->
ù
 = 
åampﬁöe_addªss
;

713 
ªgs
->
‹ig_ax
 = ~0UL;

728 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, 
hód
, 
hli°
) {

729 i‡(
ri
->
èsk
 !
cuºít
)

733 i‡(
ri
->
Ω
 &&Ñi->Ω->
h™dÀr
) {

734 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
ri
->
Ω
->
kp
;

735 
	`gë_k¥obe_˘lblk
()->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

736 
ri
->
Ω
->
	`h™dÀr
‘i, 
ªgs
);

737 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

740 
‹ig_ªt_addªss
 = ()
ri
->
ªt_addr
;

741 
	`ªcy˛e_Ω_ö°
(
ri
, &
em±y_Ω
);

743 i‡(
‹ig_ªt_addªss
 !
åampﬁöe_addªss
)

752 
	`kªçrobe_as£π
(
ri
, 
‹ig_ªt_addªss
, 
åampﬁöe_addªss
);

754 
	`kªçrobe_hash_u∆ock
(
cuºít
, &
Êags
);

756 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, &
em±y_Ω
, 
hli°
) {

757 
	`hli°_dñ
(&
ri
->
hli°
);

758 
	`k‰ì
(
ri
);

760  (*)
‹ig_ªt_addªss
;

761 
	}
}

790 
__k¥obes
 
	$ªsume_executi⁄
(
k¥obe
 *
p
,

791 
±_ªgs
 *
ªgs
, 
k¥obe_˘lblk
 *
kcb
)

793 *
tos
 = 
	`°ack_addr
(
ªgs
);

794 
c›y_ù
 = ()
p
->
aö¢
.
ö¢
;

795 
‹ig_ù
 = ()
p
->
addr
;

796 
k¥obe_›code_t
 *
ö¢
 = 
p
->
aö¢
.insn;

799 i‡(
	`is_REX_¥efix
(
ö¢
))

800 
ö¢
++;

802 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

803 *
ö¢
) {

805 *
tos
 &~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

806 *
tos
 |
kcb
->
k¥obe_ﬁd_Êags
;

815 
p
->
aö¢
.
boo°abÀ
 = 1;

816 
no_ch™ge
;

818 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

820 #ifde‡
CONFIG_X86_32


822 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

823 
no_ch™ge
;

826 i‡((
ö¢
[1] & 0x30) == 0x10) {

832 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

833 
no_ch™ge
;

834 } i‡(((
ö¢
[1] & 0x31) == 0x20) ||

835 ((
ö¢
[1] & 0x31) == 0x21)) {

840 
p
->
aö¢
.
boo°abÀ
 = 1;

841 
no_ch™ge
;

847 i‡(
p
->
aö¢
.
boo°abÀ
 == 0) {

848 i‡((
ªgs
->
ù
 > 
c›y_ù
) &&

849 (
ªgs
->
ù
 - 
c›y_ù
Ë+ 5 < 
MAX_INSN_SIZE
) {

854 
	`sy¡hesize_ªljump
((*)
ªgs
->
ù
,

855 (*)
‹ig_ù
 + (
ªgs
->
ù
 - 
c›y_ù
));

856 
p
->
aö¢
.
boo°abÀ
 = 1;

858 
p
->
aö¢
.
boo°abÀ
 = -1;

862 
ªgs
->
ù
 +
‹ig_ù
 - 
c›y_ù
;

864 
no_ch™ge
:

865 
	`ª°‹e_btf
();

866 
	}
}

872 
__k¥obes
 
	$po°_k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

874 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

875 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

877 i‡(!
cur
)

880 
	`ªsume_executi⁄
(
cur
, 
ªgs
, 
kcb
);

881 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

883 i‡((
kcb
->
k¥obe_°©us
 !
KPROBE_REENTER
Ë&& 
cur
->
po°_h™dÀr
) {

884 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SSDONE
;

885 
cur
->
	`po°_h™dÀr
(cur, 
ªgs
, 0);

889 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
) {

890 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

891 
out
;

893 
	`ª£t_cuºít_k¥obe
();

894 
out
:

895 
	`¥ìm±_íabÀ_no_ªsched
();

902 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
)

906 
	}
}

908 
__k¥obes
 
	$k¥obe_Áu…_h™dÀr
(
±_ªgs
 *
ªgs
, 
å≠ƒ
)

910 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

911 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

913 
kcb
->
k¥obe_°©us
) {

914 
KPROBE_HIT_SS
:

915 
KPROBE_REENTER
:

923 
ªgs
->
ù
 = ()
cur
->
addr
;

924 
ªgs
->
Êags
 |
kcb
->
k¥obe_ﬁd_Êags
;

925 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
)

926 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

928 
	`ª£t_cuºít_k¥obe
();

929 
	`¥ìm±_íabÀ_no_ªsched
();

931 
KPROBE_HIT_ACTIVE
:

932 
KPROBE_HIT_SSDONE
:

938 
	`k¥obes_öc_nmis£d_cou¡
(
cur
);

947 i‡(
cur
->
Áu…_h™dÀr
 && cur->
	`Áu…_h™dÀr
(cur, 
ªgs
, 
å≠ƒ
))

954 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

966 
	}
}

971 
__k¥obes
 
	$k¥obe_ex˚±i⁄s_nŸify
(
nŸifõr_block
 *
£lf
,

972 
vÆ
, *
d©a
)

974 
dõ_¨gs
 *
¨gs
 = 
d©a
;

975 
ªt
 = 
NOTIFY_DONE
;

977 i‡(
¨gs
->
ªgs
 && 
	`u£r_mode_vm
(args->regs))

978  
ªt
;

980 
vÆ
) {

981 
DIE_INT3
:

982 i‡(
	`k¥obe_h™dÀr
(
¨gs
->
ªgs
))

983 
ªt
 = 
NOTIFY_STOP
;

985 
DIE_DEBUG
:

986 i‡(
	`po°_k¥obe_h™dÀr
(
¨gs
->
ªgs
)) {

991 (*(*)
	`ERR_PTR
(
¨gs
->
îr
)Ë&~
DR_STEP
;

992 
ªt
 = 
NOTIFY_STOP
;

995 
DIE_GPF
:

1001 i‡(!
	`¥ìm±ibÀ
(Ë&& 
	`k¥obe_ru¬ög
() &&

1002 
	`k¥obe_Áu…_h™dÀr
(
¨gs
->
ªgs
,árgs->
å≠ƒ
))

1003 
ªt
 = 
NOTIFY_STOP
;

1008  
ªt
;

1009 
	}
}

1011 
__k¥obes
 
	$£tjmp_¥e_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1013 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1014 
addr
;

1015 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1017 
kcb
->
j¥obe_ßved_ªgs
 = *
ªgs
;

1018 
kcb
->
j¥obe_ßved_•
 = 
	`°ack_addr
(
ªgs
);

1019 
addr
 = ()(
kcb
->
j¥obe_ßved_•
);

1028 
	`mem˝y
(
kcb
->
j¥obes_°ack
, (
k¥obe_›code_t
 *)
addr
,

1029 
	`MIN_STACK_SIZE
(
addr
));

1030 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

1031 
	`åa˚_h¨dúqs_off
();

1032 
ªgs
->
ù
 = ()(
jp
->
íåy
);

1034 
	}
}

1036 
__k¥obes
 
	$j¥obe_ªtu∫
()

1038 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1040 
asm
 volatile (

1041 #ifde‡
CONFIG_X86_64


1050 (
kcb
->
j¥obe_ßved_•
):"memory");

1051 
	}
}

1053 
__k¥obes
 
	$l⁄gjmp_bªak_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1055 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1056 
u8
 *
addr
 = (u8 *Ë(
ªgs
->
ù
 - 1);

1057 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1059 i‡((
addr
 > (
u8
 *Ë
j¥obe_ªtu∫
) &&

1060 (
addr
 < (
u8
 *Ë
j¥obe_ªtu∫_íd
)) {

1061 i‡(
	`°ack_addr
(
ªgs
Ë!
kcb
->
j¥obe_ßved_•
) {

1062 
±_ªgs
 *
ßved_ªgs
 = &
kcb
->
j¥obe_ßved_ªgs
;

1063 
	`¥ötk
(
KERN_ERR


1065 
	`°ack_addr
(
ªgs
), 
kcb
->
j¥obe_ßved_•
);

1066 
	`¥ötk
(
KERN_ERR
 "SavedÑegi°î†f‹ j¥obê%p\n", 
jp
);

1067 
	`show_ªgi°îs
(
ßved_ªgs
);

1068 
	`¥ötk
(
KERN_ERR
 "CurrentÑegisters\n");

1069 
	`show_ªgi°îs
(
ªgs
);

1070 
	`BUG
();

1072 *
ªgs
 = 
kcb
->
j¥obe_ßved_ªgs
;

1073 
	`mem˝y
((
k¥obe_›code_t
 *)(
kcb
->
j¥obe_ßved_•
),

1074 
kcb
->
j¥obes_°ack
,

1075 
	`MIN_STACK_SIZE
(
kcb
->
j¥obe_ßved_•
));

1076 
	`¥ìm±_íabÀ_no_ªsched
();

1080 
	}
}

1083 #ifde‡
CONFIG_OPTPROBES


1086 
__k¥obes
 
	$sy¡hesize_ªlˇŒ
(*
‰om
, *
to
)

1088 
	`__sy¡hesize_ªœtive_ö¢
(
‰om
, 
to
, 
RELATIVECALL_OPCODE
);

1089 
	}
}

1092 
__k¥obes
 
	$sy¡hesize_£t_¨g1
(
k¥obe_›code_t
 *
addr
,

1093 
vÆ
)

1095 #ifde‡
CONFIG_X86_64


1096 *
addr
++ = 0x48;

1097 *
addr
++ = 0xbf;

1099 *
addr
++ = 0xb8;

1101 *(*)
addr
 = 
vÆ
;

1102 
	}
}

1104 
__k¥obes
 
	$k¥obes_›tö¢_ãm∂©e_hﬁdî
()

1106 
asm
 volatile (

1109 #ifde‡
CONFIG_X86_64


1113 
SAVE_REGS_STRING


1117 
ASM_NOP5


1118 
ASM_NOP5


1121 
ASM_NOP5


1125 
RESTORE_REGS_STRING


1131 
SAVE_REGS_STRING


1135 
ASM_NOP5


1138 
ASM_NOP5


1139 
RESTORE_REGS_STRING


1145 
	}
}

1147 
	#TMPL_MOVE_IDX
 \

1148 (()&
›çrobe_ãm∂©e_vÆ
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1149 
	#TMPL_CALL_IDX
 \

1150 (()&
›çrobe_ãm∂©e_ˇŒ
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1151 
	#TMPL_END_IDX
 \

1152 (()&
›çrobe_ãm∂©e_íd
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1154 
	#INT3_SIZE
 (
k¥obe_›code_t
)

	)

1157 
__k¥obes
 
	$›timized_ˇŒback
(
›timized_k¥obe
 *
›
,

1158 
±_ªgs
 *
ªgs
)

1160 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1162 
	`¥ìm±_dißbÀ
();

1163 i‡(
	`k¥obe_ru¬ög
()) {

1164 
	`k¥obes_öc_nmis£d_cou¡
(&
›
->
kp
);

1167 #ifde‡
CONFIG_X86_64


1168 
ªgs
->
cs
 = 
__KERNEL_CS
;

1170 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

1171 
ªgs
->
gs
 = 0;

1173 
ªgs
->
ù
 = ()
›
->
kp
.
addr
 + 
INT3_SIZE
;

1174 
ªgs
->
‹ig_ax
 = ~0UL;

1176 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
›
->
kp
;

1177 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

1178 
	`›t_¥e_h™dÀr
(&
›
->
kp
, 
ªgs
);

1179 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

1181 
	`¥ìm±_íabÀ_no_ªsched
();

1182 
	}
}

1184 
__k¥obes
 
	$c›y_›timized_ö°ru˘i⁄s
(
u8
 *
de°
, u8 *
§c
)

1186 
Àn
 = 0, 
ªt
;

1188 
Àn
 < 
RELATIVEJUMP_SIZE
) {

1189 
ªt
 = 
	`__c›y_ö°ru˘i⁄
(
de°
 + 
Àn
, 
§c
 +Üen, 1);

1190 i‡(!
ªt
 || !
	`ˇn_boo°
(
de°
 + 
Àn
))

1191  -
EINVAL
;

1192 
Àn
 +
ªt
;

1195 i‡(
	`·ø˚_ãxt_ª£rved
(
§c
, sr¯+ 
Àn
 - 1) ||

1196 
	`Æã∫©ives_ãxt_ª£rved
(
§c
, sr¯+ 
Àn
 - 1))

1197  -
EBUSY
;

1199  
Àn
;

1200 
	}
}

1203 
__k¥obes
 
	$ö¢_is_ödúe˘_jump
(
ö¢
 *insn)

1205  ((
ö¢
->
›code
.
byãs
[0] == 0xff &&

1206 (
	`X86_MODRM_REG
(
ö¢
->
modrm
.
vÆue
) & 6) == 4) ||

1207 
ö¢
->
›code
.
byãs
[0] == 0xea);

1208 
	}
}

1211 
	$ö¢_jump_öto_ønge
(
ö¢
 *ö¢, 
°¨t
, 
Àn
)

1213 
èrgë
 = 0;

1215 
ö¢
->
›code
.
byãs
[0]) {

1224 i‡((
ö¢
->
›code
.
byãs
[1] & 0xf0) == 0x80)

1228 i‡((
ö¢
->
›code
.
byãs
[0] & 0xf0) == 0x70)

1232 
èrgë
 = ()
ö¢
->
√xt_byã
 + in¢->
immedüã
.
vÆue
;

1234  (
°¨t
 <
èrgë
 &&Å¨gë <°¨à+ 
Àn
);

1235 
	}
}

1238 
__k¥obes
 
	$ˇn_›timize
(
∑ddr
)

1240 
ªt
;

1241 
addr
, 
size
 = 0, 
off£t
 = 0;

1242 
ö¢
 insn;

1243 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

1245 
__dummy_buf
[
KSYM_NAME_LEN
];

1248 i‡(!
	`kÆlsyms_lookup
(
∑ddr
, &
size
, &
off£t
, 
NULL
, 
__dummy_buf
))

1252 i‡(
size
 - 
off£t
 < 
RELATIVEJUMP_SIZE
)

1256 
addr
 = 
∑ddr
 - 
off£t
;

1257 
addr
 < 
∑ddr
 - 
off£t
 + 
size
) {

1258 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(
addr
))

1264 
	`kî√l_ö¢_öô
(&
ö¢
, (*)
addr
);

1265 
	`ö¢_gë_›code
(&
ö¢
);

1266 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

1267 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
, 
addr
);

1268 i‡(
ªt
)

1270 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

1272 
	`ö¢_gë_Àngth
(&
ö¢
);

1274 
ö¢
.
kaddr
 = (*)
addr
;

1275 
ö¢
.
√xt_byã
 = (*)(
addr
 + in¢.
Àngth
);

1277 i‡(
	`ö¢_is_ödúe˘_jump
(&
ö¢
) ||

1278 
	`ö¢_jump_öto_ønge
(&
ö¢
, 
∑ddr
 + 
INT3_SIZE
,

1279 
RELATIVE_ADDR_SIZE
))

1281 
addr
 +
ö¢
.
Àngth
;

1285 
	}
}

1288 
__k¥obes
 
	$¨ch_check_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1290 
i
;

1291 
k¥obe
 *
p
;

1293 
i
 = 1; i < 
›
->
›tö¢
.
size
; i++) {

1294 
p
 = 
	`gë_k¥obe
(
›
->
kp
.
addr
 + 
i
);

1295 i‡(
p
 && !
	`k¥obe_dißbÀd
(p))

1296  -
EEXIST
;

1300 
	}
}

1303 
__k¥obes
 
	$¨ch_wôhö_›timized_k¥obe
(
›timized_k¥obe
 *
›
,

1304 
addr
)

1306  (()
›
->
kp
.
addr
 <=áddr &&

1307 ()
›
->
kp
.
addr
 + op->
›tö¢
.
size
 >áddr);

1308 
	}
}

1311 
__k¥obes


1312 
	$__¨ch_ªmove_›timized_k¥obe
(
›timized_k¥obe
 *
›
, 
dúty
)

1314 i‡(
›
->
›tö¢
.
ö¢
) {

1315 
	`‰ì_›tö¢_¶Ÿ
(
›
->
›tö¢
.
ö¢
, 
dúty
);

1316 
›
->
›tö¢
.
ö¢
 = 
NULL
;

1317 
›
->
›tö¢
.
size
 = 0;

1319 
	}
}

1321 
__k¥obes
 
	$¨ch_ªmove_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1323 
	`__¨ch_ªmove_›timized_k¥obe
(
›
, 1);

1324 
	}
}

1330 
__k¥obes
 
	$¨ch_¥ï¨e_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1332 
u8
 *
buf
;

1333 
ªt
;

1334 
ªl
;

1336 i‡(!
	`ˇn_›timize
(()
›
->
kp
.
addr
))

1337  -
EILSEQ
;

1339 
›
->
›tö¢
.
ö¢
 = 
	`gë_›tö¢_¶Ÿ
();

1340 i‡(!
›
->
›tö¢
.
ö¢
)

1341  -
ENOMEM
;

1347 
ªl
 = ()
›
->
›tö¢
.
ö¢
 - ()›->
kp
.
addr
 + 
RELATIVEJUMP_SIZE
;

1348 i‡(
	`abs
(
ªl
) > 0x7fffffff)

1349  -
ERANGE
;

1351 
buf
 = (
u8
 *)
›
->
›tö¢
.
ö¢
;

1354 
ªt
 = 
	`c›y_›timized_ö°ru˘i⁄s
(
buf
 + 
TMPL_END_IDX
, 
›
->
kp
.
addr
);

1355 i‡(
ªt
 < 0) {

1356 
	`__¨ch_ªmove_›timized_k¥obe
(
›
, 0);

1357  
ªt
;

1359 
›
->
›tö¢
.
size
 = 
ªt
;

1362 
	`mem˝y
(
buf
, &
›çrobe_ãm∂©e_íåy
, 
TMPL_END_IDX
);

1365 
	`sy¡hesize_£t_¨g1
(
buf
 + 
TMPL_MOVE_IDX
, ()
›
);

1368 
	`sy¡hesize_ªlˇŒ
(
buf
 + 
TMPL_CALL_IDX
, 
›timized_ˇŒback
);

1371 
	`sy¡hesize_ªljump
(
buf
 + 
TMPL_END_IDX
 + 
›
->
›tö¢
.
size
,

1372 (
u8
 *)
›
->
kp
.
addr
 + op->
›tö¢
.
size
);

1374 
	`Êush_iˇche_ønge
((Ë
buf
,

1375 (Ë
buf
 + 
TMPL_END_IDX
 +

1376 
›
->
›tö¢
.
size
 + 
RELATIVEJUMP_SIZE
);

1378 
	}
}

1381 
__k¥obes
 
	$¨ch_›timize_k¥obe
(
›timized_k¥obe
 *
›
)

1383 
jmp_code
[
RELATIVEJUMP_SIZE
];

1384 
s32
 
ªl
 = (s32)(()
›
->
›tö¢
.
ö¢
 -

1385 (()
›
->
kp
.
addr
 + 
RELATIVEJUMP_SIZE
));

1388 
	`mem˝y
(
›
->
›tö¢
.
c›õd_ö¢
, op->
kp
.
addr
 + 
INT3_SIZE
,

1389 
RELATIVE_ADDR_SIZE
);

1391 
jmp_code
[0] = 
RELATIVEJUMP_OPCODE
;

1392 *(
s32
 *)(&
jmp_code
[1]Ë
ªl
;

1399 
	`ãxt_poke_smp
(
›
->
kp
.
addr
, 
jmp_code
, 
RELATIVEJUMP_SIZE
);

1401 
	}
}

1404 
__k¥obes
 
	$¨ch_un›timize_k¥obe
(
›timized_k¥obe
 *
›
)

1406 
u8
 
buf
[
RELATIVEJUMP_SIZE
];

1409 
buf
[0] = 
BREAKPOINT_INSTRUCTION
;

1410 
	`mem˝y
(
buf
 + 1, 
›
->
›tö¢
.
c›õd_ö¢
, 
RELATIVE_ADDR_SIZE
);

1411 
	`ãxt_poke_smp
(
›
->
kp
.
addr
, 
buf
, 
RELATIVEJUMP_SIZE
);

1412 
	}
}

1414 
__k¥obes
 
	$£tup_dëour_executi⁄
(
k¥obe
 *
p
,

1415 
±_ªgs
 *
ªgs
,

1416 
ªíãr
)

1418 
›timized_k¥obe
 *
›
;

1420 i‡(
p
->
Êags
 & 
KPROBE_FLAG_OPTIMIZED
) {

1422 
›
 = 
	`c⁄èöî_of
(
p
, 
›timized_k¥obe
, 
kp
);

1424 
ªgs
->
ù
 = ()
›
->
›tö¢
.
ö¢
 + 
TMPL_END_IDX
;

1425 i‡(!
ªíãr
)

1426 
	`ª£t_cuºít_k¥obe
();

1427 
	`¥ìm±_íabÀ_no_ªsched
();

1431 
	}
}

1434 
__öô
 
	$¨ch_öô_k¥obes
()

1437 
	}
}

1439 
__k¥obes
 
	$¨ch_åampﬁöe_k¥obe
(
k¥obe
 *
p
)

1442 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<löux/î∫o.h
>

10 
	~<löux/gÂ.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/°rög.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/smp.h
>

15 
	~<löux/vmÆloc.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/ldt.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/mmu_c⁄ãxt.h
>

22 
	~<asm/sysˇŒs.h
>

24 #ifde‡
CONFIG_SMP


25 
	$Êush_ldt
(*
cuºít_mm
)

27 i‡(
cuºít
->
a˘ive_mm
 =
cuºít_mm
)

28 
	`lﬂd_LDT
(&
cuºít
->
a˘ive_mm
->
c⁄ãxt
);

29 
	}
}

32 
	$Æloc_ldt
(
mm_c⁄ãxt_t
 *
pc
, 
möcou¡
, 
ªlﬂd
)

34 *
ﬁdldt
, *
√wldt
;

35 
ﬁdsize
;

37 i‡(
möcou¡
 <
pc
->
size
)

39 
ﬁdsize
 = 
pc
->
size
;

40 
möcou¡
 = (möcou¡ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

41 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

42 i‡(
möcou¡
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

43 
√wldt
 = 
	`vmÆloc
(
möcou¡
 * 
LDT_ENTRY_SIZE
);

45 
√wldt
 = (*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
);

47 i‡(!
√wldt
)

48  -
ENOMEM
;

50 i‡(
ﬁdsize
)

51 
	`mem˝y
(
√wldt
, 
pc
->
ldt
, 
ﬁdsize
 * 
LDT_ENTRY_SIZE
);

52 
ﬁdldt
 = 
pc
->
ldt
;

53 
	`mem£t
(
√wldt
 + 
ﬁdsize
 * 
LDT_ENTRY_SIZE
, 0,

54 (
möcou¡
 - 
ﬁdsize
Ë* 
LDT_ENTRY_SIZE
);

56 
	`∑øvút_Æloc_ldt
(
√wldt
, 
möcou¡
);

58 #ifde‡
CONFIG_X86_64


60 
	`wmb
();

62 
pc
->
ldt
 = 
√wldt
;

63 
	`wmb
();

64 
pc
->
size
 = 
möcou¡
;

65 
	`wmb
();

67 i‡(
ªlﬂd
) {

68 #ifde‡
CONFIG_SMP


69 
	`¥ìm±_dißbÀ
();

70 
	`lﬂd_LDT
(
pc
);

71 i‡(!
	`˝umask_equÆ
(
	`mm_˝umask
(
cuºít
->
mm
),

72 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
())))

73 
	`smp_ˇŒ_fun˘i⁄
(
Êush_ldt
, 
cuºít
->
mm
, 1);

74 
	`¥ìm±_íabÀ
();

76 
	`lﬂd_LDT
(
pc
);

79 i‡(
ﬁdsize
) {

80 
	`∑øvút_‰ì_ldt
(
ﬁdldt
, 
ﬁdsize
);

81 i‡(
ﬁdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

82 
	`v‰ì
(
ﬁdldt
);

84 
	`put_∑ge
(
	`vút_to_∑ge
(
ﬁdldt
));

87 
	}
}

89 
ölöe
 
	$c›y_ldt
(
mm_c⁄ãxt_t
 *
√w
, mm_c⁄ãxt_à*
ﬁd
)

91 
îr
 = 
	`Æloc_ldt
(
√w
, 
ﬁd
->
size
, 0);

92 
i
;

94 i‡(
îr
 < 0)

95  
îr
;

97 
i
 = 0; i < 
ﬁd
->
size
; i++)

98 
	`wrôe_ldt_íåy
(
√w
->
ldt
, 
i
, 
ﬁd
->ldà+ i * 
LDT_ENTRY_SIZE
);

100 
	}
}

106 
	$öô_√w_c⁄ãxt
(
èsk_°ru˘
 *
tsk
, 
mm_°ru˘
 *
mm
)

108 
mm_°ru˘
 *
ﬁd_mm
;

109 
ªtvÆ
 = 0;

111 
	`muãx_öô
(&
mm
->
c⁄ãxt
.
lock
);

112 
mm
->
c⁄ãxt
.
size
 = 0;

113 
ﬁd_mm
 = 
cuºít
->
mm
;

114 i‡(
ﬁd_mm
 && old_mm->
c⁄ãxt
.
size
 > 0) {

115 
	`muãx_lock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

116 
ªtvÆ
 = 
	`c›y_ldt
(&
mm
->
c⁄ãxt
, &
ﬁd_mm
->context);

117 
	`muãx_u∆ock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

119  
ªtvÆ
;

120 
	}
}

127 
	$de°roy_c⁄ãxt
(
mm_°ru˘
 *
mm
)

129 i‡(
mm
->
c⁄ãxt
.
size
) {

130 #ifde‡
CONFIG_X86_32


132 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

133 
	`˛ór_LDT
();

135 
	`∑øvút_‰ì_ldt
(
mm
->
c⁄ãxt
.
ldt
, mm->c⁄ãxt.
size
);

136 i‡(
mm
->
c⁄ãxt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

137 
	`v‰ì
(
mm
->
c⁄ãxt
.
ldt
);

139 
	`put_∑ge
(
	`vút_to_∑ge
(
mm
->
c⁄ãxt
.
ldt
));

140 
mm
->
c⁄ãxt
.
size
 = 0;

142 
	}
}

144 
	$ªad_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

146 
îr
;

147 
size
;

148 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

150 i‡(!
mm
->
c⁄ãxt
.
size
)

152 i‡(
byãcou¡
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

153 
byãcou¡
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

155 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

156 
size
 = 
mm
->
c⁄ãxt
.sizê* 
LDT_ENTRY_SIZE
;

157 i‡(
size
 > 
byãcou¡
)

158 
size
 = 
byãcou¡
;

160 
îr
 = 0;

161 i‡(
	`c›y_to_u£r
(
±r
, 
mm
->
c⁄ãxt
.
ldt
, 
size
))

162 
îr
 = -
EFAULT
;

163 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

164 i‡(
îr
 < 0)

165 
îr‹_ªtu∫
;

166 i‡(
size
 !
byãcou¡
) {

168 i‡(
	`˛ór_u£r
(
±r
 + 
size
, 
byãcou¡
 - size) != 0) {

169 
îr
 = -
EFAULT
;

170 
îr‹_ªtu∫
;

173  
byãcou¡
;

174 
îr‹_ªtu∫
:

175  
îr
;

176 
	}
}

178 
	$ªad_deÁu…_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

181 #ifde‡
CONFIG_X86_32


182 
size
 = 5 * (
desc_°ru˘
);

184 
size
 = 128;

186 i‡(
byãcou¡
 > 
size
)

187 
byãcou¡
 = 
size
;

188 i‡(
	`˛ór_u£r
(
±r
, 
byãcou¡
))

189  -
EFAULT
;

190  
byãcou¡
;

191 
	}
}

193 
	$wrôe_ldt
(
__u£r
 *
±r
, 
byãcou¡
, 
ﬁdmode
)

195 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

196 
desc_°ru˘
 
ldt
;

197 
îr‹
;

198 
u£r_desc
 
ldt_öfo
;

200 
îr‹
 = -
EINVAL
;

201 i‡(
byãcou¡
 !(
ldt_öfo
))

202 
out
;

203 
îr‹
 = -
EFAULT
;

204 i‡(
	`c›y_‰om_u£r
(&
ldt_öfo
, 
±r
, (ldt_info)))

205 
out
;

207 
îr‹
 = -
EINVAL
;

208 i‡(
ldt_öfo
.
íåy_numbî
 >
LDT_ENTRIES
)

209 
out
;

210 i‡(
ldt_öfo
.
c⁄ã¡s
 == 3) {

211 i‡(
ﬁdmode
)

212 
out
;

213 i‡(
ldt_öfo
.
£g_nŸ_¥e£¡
 == 0)

214 
out
;

217 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

218 i‡(
ldt_öfo
.
íåy_numbî
 >
mm
->
c⁄ãxt
.
size
) {

219 
îr‹
 = 
	`Æloc_ldt
(&
cuºít
->
mm
->
c⁄ãxt
,

220 
ldt_öfo
.
íåy_numbî
 + 1, 1);

221 i‡(
îr‹
 < 0)

222 
out_u∆ock
;

226 i‡(
ldt_öfo
.
ba£_addr
 =0 &&Üdt_öfo.
limô
 == 0) {

227 i‡(
ﬁdmode
 || 
	`LDT_em±y
(&
ldt_öfo
)) {

228 
	`mem£t
(&
ldt
, 0, (ldt));

229 
ö°Æl
;

233 
	`fûl_ldt
(&
ldt
, &
ldt_öfo
);

234 i‡(
ﬁdmode
)

235 
ldt
.
avl
 = 0;

238 
ö°Æl
:

239 
	`wrôe_ldt_íåy
(
mm
->
c⁄ãxt
.
ldt
, 
ldt_öfo
.
íåy_numbî
, &ldt);

240 
îr‹
 = 0;

242 
out_u∆ock
:

243 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

244 
out
:

245  
îr‹
;

246 
	}
}

248 
asmlökage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

249 
byãcou¡
)

251 
ªt
 = -
ENOSYS
;

253 
func
) {

255 
ªt
 = 
	`ªad_ldt
(
±r
, 
byãcou¡
);

258 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 1);

261 
ªt
 = 
	`ªad_deÁu…_ldt
(
±r
, 
byãcou¡
);

264 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 0);

267  
ªt
;

268 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<löux/mm.h
>

10 
	~<löux/kexec.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/gÂ.h
>

13 
	~<löux/ªboŸ.h
>

14 
	~<löux/numa.h
>

15 
	~<löux/·ø˚.h
>

16 
	~<löux/io.h
>

17 
	~<löux/su•íd.h
>

19 
	~<asm/pgèbÀ.h
>

20 
	~<asm/ébÊush.h
>

21 
	~<asm/mmu_c⁄ãxt.h
>

22 
	~<asm/debugªg.h
>

24 
	$öô_⁄e_Àvñ2_∑ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

25 
addr
)

27 
pud_t
 *
pud
;

28 
pmd_t
 *
pmd
;

29 
∑ge
 *page;

30 
ªsu…
 = -
ENOMEM
;

32 
addr
 &
PMD_MASK
;

33 
pgd
 +
	`pgd_ödex
(
addr
);

34 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

35 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

36 i‡(!
∑ge
)

37 
out
;

38 
pud
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

39 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

40 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

42 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

43 i‡(!
	`pud_¥e£¡
(*
pud
)) {

44 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

45 i‡(!
∑ge
)

46 
out
;

47 
pmd
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

48 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

49 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

51 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

52 i‡(!
	`pmd_¥e£¡
(*
pmd
))

53 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

54 
ªsu…
 = 0;

55 
out
:

56  
ªsu…
;

57 
	}
}

59 
	$öô_Àvñ2_∑ge
(
pmd_t
 *
Àvñ2p
, 
addr
)

61 
íd_addr
;

63 
addr
 &
PAGE_MASK
;

64 
íd_addr
 = 
addr
 + 
PUD_SIZE
;

65 
addr
 < 
íd_addr
) {

66 
	`£t_pmd
(
Àvñ2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

67 
addr
 +
PMD_SIZE
;

69 
	}
}

71 
	$öô_Àvñ3_∑ge
(
kimage
 *
image
, 
pud_t
 *
Àvñ3p
,

72 
addr
, 
œ°_addr
)

74 
íd_addr
;

75 
ªsu…
;

77 
ªsu…
 = 0;

78 
addr
 &
PAGE_MASK
;

79 
íd_addr
 = 
addr
 + 
PGDIR_SIZE
;

80 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

81 
∑ge
 *page;

82 
pmd_t
 *
Àvñ2p
;

84 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

85 i‡(!
∑ge
) {

86 
ªsu…
 = -
ENOMEM
;

87 
out
;

89 
Àvñ2p
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

90 
	`öô_Àvñ2_∑ge
(
Àvñ2p
, 
addr
);

91 
	`£t_pud
(
Àvñ3p
++, 
	`__pud
(
	`__∑
(
Àvñ2p
Ë| 
_KERNPG_TABLE
));

92 
addr
 +
PUD_SIZE
;

95 
addr
 < 
íd_addr
) {

96 
	`pud_˛ór
(
Àvñ3p
++);

97 
addr
 +
PUD_SIZE
;

99 
out
:

100  
ªsu…
;

101 
	}
}

104 
	$öô_Àvñ4_∑ge
(
kimage
 *
image
, 
pgd_t
 *
Àvñ4p
,

105 
addr
, 
œ°_addr
)

107 
íd_addr
;

108 
ªsu…
;

110 
ªsu…
 = 0;

111 
addr
 &
PAGE_MASK
;

112 
íd_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

113 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

114 
∑ge
 *page;

115 
pud_t
 *
Àvñ3p
;

117 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

118 i‡(!
∑ge
) {

119 
ªsu…
 = -
ENOMEM
;

120 
out
;

122 
Àvñ3p
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

123 
ªsu…
 = 
	`öô_Àvñ3_∑ge
(
image
, 
Àvñ3p
, 
addr
, 
œ°_addr
);

124 i‡(
ªsu…
)

125 
out
;

126 
	`£t_pgd
(
Àvñ4p
++, 
	`__pgd
(
	`__∑
(
Àvñ3p
Ë| 
_KERNPG_TABLE
));

127 
addr
 +
PGDIR_SIZE
;

130 
addr
 < 
íd_addr
) {

131 
	`pgd_˛ór
(
Àvñ4p
++);

132 
addr
 +
PGDIR_SIZE
;

134 
out
:

135  
ªsu…
;

136 
	}
}

138 
	$‰ì_å™sôi⁄_pgèbÀ
(
kimage
 *
image
)

140 
	`‰ì_∑ge
(()
image
->
¨ch
.
pud
);

141 
	`‰ì_∑ge
(()
image
->
¨ch
.
pmd
);

142 
	`‰ì_∑ge
(()
image
->
¨ch
.
±e
);

143 
	}
}

145 
	$öô_å™sôi⁄_pgèbÀ
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

147 
pud_t
 *
pud
;

148 
pmd_t
 *
pmd
;

149 
±e_t
 *
±e
;

150 
vaddr
, 
∑ddr
;

151 
ªsu…
 = -
ENOMEM
;

153 
vaddr
 = ()
ªloˇã_kî√l
;

154 
∑ddr
 = 
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
)+
PAGE_SIZE
);

155 
pgd
 +
	`pgd_ödex
(
vaddr
);

156 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

157 
pud
 = (
pud_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

158 i‡(!
pud
)

159 
îr
;

160 
image
->
¨ch
.
pud
 =Öud;

161 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

163 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

164 i‡(!
	`pud_¥e£¡
(*
pud
)) {

165 
pmd
 = (
pmd_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

166 i‡(!
pmd
)

167 
îr
;

168 
image
->
¨ch
.
pmd
 =Ömd;

169 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

171 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

172 i‡(!
	`pmd_¥e£¡
(*
pmd
)) {

173 
±e
 = (
±e_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

174 i‡(!
±e
)

175 
îr
;

176 
image
->
¨ch
.
±e
 =Öte;

177 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__∑
(
±e
Ë| 
_KERNPG_TABLE
));

179 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

180 
	`£t_±e
(
±e
, 
	`p‚_±e
(
∑ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

182 
îr
:

183 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

184  
ªsu…
;

185 
	}
}

188 
	$öô_pgèbÀ
(
kimage
 *
image
, 
°¨t_pgèbÀ
)

190 
pgd_t
 *
Àvñ4p
;

191 
ªsu…
;

192 
Àvñ4p
 = (
pgd_t
 *)
	`__va
(
°¨t_pgèbÀ
);

193 
ªsu…
 = 
	`öô_Àvñ4_∑ge
(
image
, 
Àvñ4p
, 0, 
max_p‚
 << 
PAGE_SHIFT
);

194 i‡(
ªsu…
)

195  
ªsu…
;

200 
ªsu…
 = 
	`öô_⁄e_Àvñ2_∑ge
(
image
, 
Àvñ4p
, image->
°¨t
);

201 i‡(
ªsu…
)

202  
ªsu…
;

203  
	`öô_å™sôi⁄_pgèbÀ
(
image
, 
Àvñ4p
);

204 
	}
}

206 
	$£t_idt
(*
√widt
, 
u16
 
limô
)

208 
desc_±r
 
curidt
;

211 
curidt
.
size
 = 
limô
;

212 
curidt
.
addªss
 = ()
√widt
;

214 
__asm__
 
	`__vﬁ©ûe__
 (

216 : : "m" (
curidt
)

218 
	}
};

221 
	$£t_gdt
(*
√wgdt
, 
u16
 
limô
)

223 
desc_±r
 
curgdt
;

226 
curgdt
.
size
 = 
limô
;

227 
curgdt
.
addªss
 = ()
√wgdt
;

229 
__asm__
 
	`__vﬁ©ûe__
 (

231 : : "m" (
curgdt
)

233 
	}
};

235 
	$lﬂd_£gmíts
()

237 
__asm__
 
	`__vﬁ©ûe__
 (

243 : : "a" (
__KERNEL_DS
) : "memory"

245 
	}
}

247 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

249 
°¨t_pgèbÀ
;

250 
ªsu…
;

253 
°¨t_pgèbÀ
 = 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

256 
ªsu…
 = 
	`öô_pgèbÀ
(
image
, 
°¨t_pgèbÀ
);

257 i‡(
ªsu…
)

258  
ªsu…
;

261 
	}
}

263 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

265 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

266 
	}
}

272 
	$machöe_kexec
(
kimage
 *
image
)

274 
∑ge_li°
[
PAGES_NR
];

275 *
c⁄åﬁ_∑ge
;

276 
ßve_·ø˚_íabÀd
;

278 #ifde‡
CONFIG_KEXEC_JUMP


279 i‡(
image
->
¥e£rve_c⁄ãxt
)

280 
	`ßve_¥o˚ss‹_°©e
();

283 
ßve_·ø˚_íabÀd
 = 
	`__·ø˚_íabÀd_ßve
();

286 
	`loˇl_úq_dißbÀ
();

287 
	`hw_bªakpoöt_dißbÀ
();

289 i‡(
image
->
¥e£rve_c⁄ãxt
) {

290 #ifde‡
CONFIG_X86_IO_APIC


298 
	`dißbÀ_IO_APIC
();

302 
c⁄åﬁ_∑ge
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
Ë+ 
PAGE_SIZE
;

303 
	`mem˝y
(
c⁄åﬁ_∑ge
, 
ªloˇã_kî√l
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

305 
∑ge_li°
[
PA_CONTROL_PAGE
] = 
	`vút_to_phys
(
c⁄åﬁ_∑ge
);

306 
∑ge_li°
[
VA_CONTROL_PAGE
] = ()
c⁄åﬁ_∑ge
;

307 
∑ge_li°
[
PA_TABLE_PAGE
] =

308 ()
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
));

310 i‡(
image
->
ty≥
 =
KEXEC_TYPE_DEFAULT
)

311 
∑ge_li°
[
PA_SWAP_PAGE
] = (
	`∑ge_to_p‚
(
image
->
sw≠_∑ge
)

312 << 
PAGE_SHIFT
);

324 
	`lﬂd_£gmíts
();

329 
	`£t_gdt
(
	`phys_to_vút
(0), 0);

330 
	`£t_idt
(
	`phys_to_vút
(0), 0);

333 
image
->
°¨t
 = 
	`ªloˇã_kî√l
(()image->
hód
,

334 ()
∑ge_li°
,

335 
image
->
°¨t
,

336 
image
->
¥e£rve_c⁄ãxt
);

338 #ifde‡
CONFIG_KEXEC_JUMP


339 i‡(
image
->
¥e£rve_c⁄ãxt
)

340 
	`ª°‹e_¥o˚ss‹_°©e
();

343 
	`__·ø˚_íabÀd_ª°‹e
(
ßve_·ø˚_íabÀd
);

344 
	}
}

346 
	$¨ch_¸ash_ßve_vmc‹eöfo
()

348 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

349 
	`VMCOREINFO_SYMBOL
(
öô_Àvñ4_pgt
);

351 #ifde‡
CONFIG_NUMA


352 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

353 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

355 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

17 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

19 
	~<löux/fúmw¨e.h
>

20 
	~<löux/pci_ids.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/vmÆloc.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/pci.h
>

27 
	~<asm/mi¸ocode.h
>

28 
	~<asm/¥o˚ss‹.h
>

29 
	~<asm/m§.h
>

31 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

32 
MODULE_AUTHOR
("Peter Oruba");

33 
MODULE_LICENSE
("GPL v2");

35 
	#UCODE_MAGIC
 0x00414d44

	)

36 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

37 
	#UCODE_UCODE_TYPE
 0x00000001

	)

39 
	sequiv_˝u_íåy
 {

40 
u32
 
	mö°ÆÀd_˝u
;

41 
u32
 
	mfixed_îøè_mask
;

42 
u32
 
	mfixed_îøè_com∑ª
;

43 
u16
 
	mequiv_˝u
;

44 
u16
 
	mªs
;

45 } 
__©åibuã__
((
∑cked
));

47 
	smi¸ocode_hódî_amd
 {

48 
u32
 
	md©a_code
;

49 
u32
 
	m∑tch_id
;

50 
u16
 
	mmc_∑tch_d©a_id
;

51 
u8
 
	mmc_∑tch_d©a_Àn
;

52 
u8
 
	möô_Êag
;

53 
u32
 
	mmc_∑tch_d©a_checksum
;

54 
u32
 
	mnb_dev_id
;

55 
u32
 
	msb_dev_id
;

56 
u16
 
	m¥o˚ss‹_ªv_id
;

57 
u8
 
	mnb_ªv_id
;

58 
u8
 
	msb_ªv_id
;

59 
u8
 
	mbios_≠i_ªv
;

60 
u8
 
	mª£rved1
[3];

61 
u32
 
	mm©ch_ªg
[8];

62 } 
__©åibuã__
((
∑cked
));

64 
	smi¸ocode_amd
 {

65 
mi¸ocode_hódî_amd
 
	mhdr
;

66 
	mmpb
[0];

69 
	#UCODE_MAX_SIZE
 2048

	)

70 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

71 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

73 
equiv_˝u_íåy
 *
	gequiv_˝u_èbÀ
;

75 
	$cﬁÀ˘_˝u_öfo_amd
(
˝u
, 
˝u_sig«tuª
 *
csig
)

77 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

78 
u32
 
dummy
;

80 
	`mem£t
(
csig
, 0, (*csig));

81 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

82 
	`¥_w¨nög
("microcode: CPU%d: AMD CPU family 0x%xÇot "

83 "suµ‹ãd\n", 
˝u
, 
c
->
x86
);

86 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
ªv
, 
dummy
);

87 
	`¥_öfo
("CPU%d:Ö©ch_Àvñ=0x%x\n", 
˝u
, 
csig
->
ªv
);

89 
	}
}

91 
	$gë_m©chög_mi¸ocode
(
˝u
, *
mc
, 
ªv
)

93 
mi¸ocode_hódî_amd
 *
mc_hódî
 = 
mc
;

94 
cuºít_˝u_id
;

95 
u16
 
equiv_˝u_id
 = 0;

96 
i
 = 0;

98 
	`BUG_ON
(
equiv_˝u_èbÀ
 =
NULL
);

99 
cuºít_˝u_id
 = 
	`˝uid_óx
(0x00000001);

101 
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
 != 0) {

102 i‡(
cuºít_˝u_id
 =
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
) {

103 
equiv_˝u_id
 = 
equiv_˝u_èbÀ
[
i
].
equiv_˝u
;

106 
i
++;

109 i‡(!
equiv_˝u_id
)

112 i‡(
mc_hódî
->
¥o˚ss‹_ªv_id
 !
equiv_˝u_id
)

116 i‡(
mc_hódî
->
nb_dev_id
 || mc_hódî->
sb_dev_id
) {

117 
	`¥_îr
("CPU%d:Üoading of chipset specific codeÇot yet supported\n",

118 
˝u
);

122 i‡(
mc_hódî
->
∑tch_id
 <
ªv
)

126 
	}
}

128 
	$≠∂y_mi¸ocode_amd
(
˝u
)

130 
u32
 
ªv
, 
dummy
;

131 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

132 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u_num
;

133 
mi¸ocode_amd
 *
mc_amd
 = 
uci
->
mc
;

136 
	`BUG_ON
(
˝u_num
 !
˝u
);

138 i‡(
mc_amd
 =
NULL
)

141 
	`wrm§l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

143 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
ªv
, 
dummy
);

146 i‡(
ªv
 !
mc_amd
->
hdr
.
∑tch_id
) {

147 
	`¥_îr
("CPU%d: update failed (forÖatch_level=0x%x)\n",

148 
˝u
, 
mc_amd
->
hdr
.
∑tch_id
);

152 
	`¥_öfo
("CPU%d: upd©ed (√wÖ©ch_Àvñ=0x%x)\n", 
˝u
, 
ªv
);

153 
uci
->
˝u_sig
.
ªv
 =Ñev;

156 
	}
}

158 
	$gë_ucode_d©a
(*
to
, c⁄° 
u8
 *
‰om
, 
size_t
 
n
)

160 
	`mem˝y
(
to
, 
‰om
, 
n
);

162 
	}
}

165 
	$gë_√xt_ucode
(c⁄° 
u8
 *
buf
, 
size
, *
mc_size
)

167 
tŸÆ_size
;

168 
u8
 
£˘i⁄_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

169 *
mc
;

171 i‡(
	`gë_ucode_d©a
(
£˘i⁄_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

172  
NULL
;

174 i‡(
£˘i⁄_hdr
[0] !
UCODE_UCODE_TYPE
) {

175 
	`¥_îr
("error: invalidÅype field in container file section header\n");

176  
NULL
;

179 
tŸÆ_size
 = (Ë(
£˘i⁄_hdr
[4] + (section_hdr[5] << 8));

181 i‡(
tŸÆ_size
 > 
size
 ||ÅŸÆ_sizê> 
UCODE_MAX_SIZE
) {

182 
	`¥_îr
("error: size mismatch\n");

183  
NULL
;

186 
mc
 = 
	`vmÆloc
(
UCODE_MAX_SIZE
);

187 i‡(
mc
) {

188 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

189 i‡(
	`gë_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

190 
tŸÆ_size
)) {

191 
	`v‰ì
(
mc
);

192 
mc
 = 
NULL
;

194 *
mc_size
 = 
tŸÆ_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

196  
mc
;

197 
	}
}

199 
	$ö°Æl_equiv_˝u_èbÀ
(c⁄° 
u8
 *
buf
)

201 
u8
 *
c⁄èöî_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

202 *
buf_pos
 = (*)
c⁄èöî_hdr
;

203 
size
;

205 i‡(
	`gë_ucode_d©a
(&
c⁄èöî_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

208 
size
 = 
buf_pos
[2];

210 i‡(
buf_pos
[1] !
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

211 
	`¥_îr
("error: invalidÅype field in container file section header\n");

215 
equiv_˝u_èbÀ
 = (
equiv_˝u_íåy
 *Ë
	`vmÆloc
(
size
);

216 i‡(!
equiv_˝u_èbÀ
) {

217 
	`¥_îr
("failedÅoállocateÉquivalent CPUÅable\n");

221 
buf
 +
UCODE_CONTAINER_HEADER_SIZE
;

222 i‡(
	`gë_ucode_d©a
(
equiv_˝u_èbÀ
, 
buf
, 
size
)) {

223 
	`v‰ì
(
equiv_˝u_èbÀ
);

227  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

228 
	}
}

230 
	$‰ì_equiv_˝u_èbÀ
()

232 
	`v‰ì
(
equiv_˝u_èbÀ
);

233 
equiv_˝u_èbÀ
 = 
NULL
;

234 
	}
}

236 
ucode_°©e


237 
	$gíîic_lﬂd_mi¸ocode
(
˝u
, c⁄° 
u8
 *
d©a
, 
size_t
 
size
)

239 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

240 c⁄° 
u8
 *
ucode_±r
 = 
d©a
;

241 *
√w_mc
 = 
NULL
;

242 *
mc
;

243 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

244 
À·ovî
;

245 
off£t
;

246 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

248 
off£t
 = 
	`ö°Æl_equiv_˝u_èbÀ
(
ucode_±r
);

249 i‡(!
off£t
) {

250 
	`¥_îr
("failedÅo createÉquivalent cpuÅable\n");

251  
UCODE_ERROR
;

254 
ucode_±r
 +
off£t
;

255 
À·ovî
 = 
size
 - 
off£t
;

257 
À·ovî
) {

258 
	`unöôülized_v¨
(
mc_size
);

259 
mi¸ocode_hódî_amd
 *
mc_hódî
;

261 
mc
 = 
	`gë_√xt_ucode
(
ucode_±r
, 
À·ovî
, &
mc_size
);

262 i‡(!
mc
)

265 
mc_hódî
 = (
mi¸ocode_hódî_amd
 *)
mc
;

266 i‡(
	`gë_m©chög_mi¸ocode
(
˝u
, 
mc
, 
√w_ªv
)) {

267 
	`v‰ì
(
√w_mc
);

268 
√w_ªv
 = 
mc_hódî
->
∑tch_id
;

269 
√w_mc
 = 
mc
;

271 
	`v‰ì
(
mc
);

273 
ucode_±r
 +
mc_size
;

274 
À·ovî
 -
mc_size
;

277 i‡(
√w_mc
) {

278 i‡(!
À·ovî
) {

279 
	`v‰ì
(
uci
->
mc
);

280 
uci
->
mc
 = 
√w_mc
;

281 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

282 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

284 
	`v‰ì
(
√w_mc
);

285 
°©e
 = 
UCODE_ERROR
;

288 
°©e
 = 
UCODE_NFOUND
;

290 
	`‰ì_equiv_˝u_èbÀ
();

292  
°©e
;

293 
	}
}

295 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

297 c⁄° *
fw_«me
 = "amd-ucode/microcode_amd.bin";

298 c⁄° 
fúmw¨e
 *firmware;

299 
ucode_°©e
 
ªt
;

301 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
fw_«me
, 
devi˚
)) {

302 
	`¥ötk
(
KERN_ERR
 "mi¸ocode: faûedÅÿlﬂd fûê%s\n", 
fw_«me
);

303  
UCODE_NFOUND
;

306 i‡(*(
u32
 *)
fúmw¨e
->
d©a
 !
UCODE_MAGIC
) {

307 
	`¥_îr
("invalid UCODE_MAGIC (0x%08x)\n",

308 *(
u32
 *)
fúmw¨e
->
d©a
);

309  
UCODE_ERROR
;

312 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, 
fúmw¨e
->
d©a
, fúmw¨e->
size
);

314 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

316  
ªt
;

317 
	}
}

319 
ucode_°©e


320 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

322 
	`¥_öfo
("AMD microcode update via /dev/cpu/microcodeÇot supported\n");

323  
UCODE_ERROR
;

324 
	}
}

326 
	$mi¸ocode_föi_˝u_amd
(
˝u
)

328 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

330 
	`v‰ì
(
uci
->
mc
);

331 
uci
->
mc
 = 
NULL
;

332 
	}
}

334 
mi¸ocode_›s
 
	gmi¸ocode_amd_›s
 = {

335 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

336 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

337 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo_amd
,

338 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode_amd
,

339 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u_amd
,

342 
mi¸ocode_›s
 * 
__öô
 
	$öô_amd_mi¸ocode
()

344  &
mi¸ocode_amd_›s
;

345 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/∂©f‹m_devi˚.h
>

77 
	~<löux/miscdevi˚.h
>

78 
	~<löux/ˇ∑bûôy.h
>

79 
	~<löux/kî√l.h
>

80 
	~<löux/moduÀ.h
>

81 
	~<löux/muãx.h
>

82 
	~<löux/˝u.h
>

83 
	~<löux/fs.h
>

84 
	~<löux/mm.h
>

86 
	~<asm/mi¸ocode.h
>

87 
	~<asm/¥o˚ss‹.h
>

89 
MODULE_DESCRIPTION
("Microcode Update Driver");

90 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

91 
MODULE_LICENSE
("GPL");

93 
	#MICROCODE_VERSION
 "2.00"

	)

95 
mi¸ocode_›s
 *
	gmi¸ocode_›s
;

109 
DEFINE_MUTEX
(
mi¸ocode_muãx
);

111 
ucode_˝u_öfo
 
	gucode_˝u_öfo
[
NR_CPUS
];

112 
EXPORT_SYMBOL_GPL
(
ucode_˝u_öfo
);

118 
	s˝u_öfo_˘x
 {

119 
˝u_sig«tuª
 *
	m˝u_sig
;

120 
	mîr
;

123 
	$cﬁÀ˘_˝u_öfo_loˇl
(*
¨g
)

125 
˝u_öfo_˘x
 *
˘x
 = 
¨g
;

127 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`cﬁÀ˘_˝u_öfo
(
	`smp_¥o˚ss‹_id
(),

128 
˘x
->
˝u_sig
);

129 
	}
}

131 
	$cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, 
˝u_sig«tuª
 *
˝u_sig
)

133 
˝u_öfo_˘x
 
˘x
 = { .
˝u_sig
 = cpu_sig, .
îr
 = 0 };

134 
ªt
;

136 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
cﬁÀ˘_˝u_öfo_loˇl
, &
˘x
, 1);

137 i‡(!
ªt
)

138 
ªt
 = 
˘x
.
îr
;

140  
ªt
;

141 
	}
}

143 
	$cﬁÀ˘_˝u_öfo
(
˝u
)

145 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

146 
ªt
;

148 
	`mem£t
(
uci
, 0, (*uci));

150 
ªt
 = 
	`cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, &
uci
->
˝u_sig
);

151 i‡(!
ªt
)

152 
uci
->
vÆid
 = 1;

154  
ªt
;

155 
	}
}

157 
	s≠∂y_mi¸ocode_˘x
 {

158 
	mîr
;

161 
	$≠∂y_mi¸ocode_loˇl
(*
¨g
)

163 
≠∂y_mi¸ocode_˘x
 *
˘x
 = 
¨g
;

165 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
	`smp_¥o˚ss‹_id
());

166 
	}
}

168 
	$≠∂y_mi¸ocode_⁄_èrgë
(
˝u
)

170 
≠∂y_mi¸ocode_˘x
 
˘x
 = { .
îr
 = 0 };

171 
ªt
;

173 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
≠∂y_mi¸ocode_loˇl
, &
˘x
, 1);

174 i‡(!
ªt
)

175 
ªt
 = 
˘x
.
îr
;

177  
ªt
;

178 
	}
}

180 #ifde‡
CONFIG_MICROCODE_OLD_INTERFACE


181 
	$do_mi¸ocode_upd©e
(c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

183 
îr‹
 = 0;

184 
˝u
;

186 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

187 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

188 
ucode_°©e
 
u°©e
;

190 i‡(!
uci
->
vÆid
)

193 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_u£r
(
˝u
, 
buf
, 
size
);

194 i‡(
u°©e
 =
UCODE_ERROR
) {

195 
îr‹
 = -1;

197 } i‡(
u°©e
 =
UCODE_OK
)

198 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

201  
îr‹
;

202 
	}
}

204 
	$mi¸ocode_›í
(
öode
 *
unu£d1
, 
fûe
 *
unu£d2
)

206  
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
Ë? 0 : -
EPERM
;

207 
	}
}

209 
ssize_t
 
	$mi¸ocode_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

210 
size_t
 
Àn
, 
loff_t
 *
µos
)

212 
ssize_t
 
ªt
 = -
EINVAL
;

214 i‡((
Àn
 >> 
PAGE_SHIFT
Ë> 
tŸÆøm_∑ges
) {

215 
	`¥_îr
("toÿmuch d©®(max %ldÖages)\n", 
tŸÆøm_∑ges
);

216  
ªt
;

219 
	`gë_⁄löe_˝us
();

220 
	`muãx_lock
(&
mi¸ocode_muãx
);

222 i‡(
	`do_mi¸ocode_upd©e
(
buf
, 
Àn
) == 0)

223 
ªt
 = (
ssize_t
)
Àn
;

225 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

226 
	`put_⁄löe_˝us
();

228  
ªt
;

229 
	}
}

231 c⁄° 
fûe_›î©i⁄s
 
	gmi¸ocode_f›s
 = {

232 .
ow√r
 = 
THIS_MODULE
,

233 .
	gwrôe
 = 
mi¸ocode_wrôe
,

234 .
	g›í
 = 
mi¸ocode_›í
,

237 
miscdevi˚
 
	gmi¸ocode_dev
 = {

238 .
mö‹
 = 
MICROCODE_MINOR
,

239 .
	g«me
 = "microcode",

240 .
	gnodíame
 = "cpu/microcode",

241 .
	gf›s
 = &
mi¸ocode_f›s
,

244 
__öô
 
	$mi¸ocode_dev_öô
()

246 
îr‹
;

248 
îr‹
 = 
	`misc_ªgi°î
(&
mi¸ocode_dev
);

249 i‡(
îr‹
) {

250 
	`¥_îr
("ˇn'àmisc_ªgi°î o¿mö‹=%d\n", 
MICROCODE_MINOR
);

251  
îr‹
;

255 
	}
}

257 
	$mi¸ocode_dev_exô
()

259 
	`misc_dîegi°î
(&
mi¸ocode_dev
);

260 
	}
}

262 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

264 
	#mi¸ocode_dev_öô
(Ë0

	)

265 
	#mi¸ocode_dev_exô
(Ëdÿ{ } 0)

	)

269 
∂©f‹m_devi˚
 *
	gmi¸ocode_pdev
;

271 
	$ªlﬂd_f‹_˝u
(
˝u
)

273 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

274 
îr
 = 0;

276 
	`muãx_lock
(&
mi¸ocode_muãx
);

277 i‡(
uci
->
vÆid
) {

278 
ucode_°©e
 
u°©e
;

280 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

281 i‡(
u°©e
 =
UCODE_OK
)

282 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

284 i‡(
u°©e
 =
UCODE_ERROR
)

285 
îr
 = -
EINVAL
;

287 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

289  
îr
;

290 
	}
}

292 
ssize_t
 
	$ªlﬂd_°‹e
(
sys_devi˚
 *
dev
,

293 
sysdev_©åibuã
 *
©å
,

294 c⁄° *
buf
, 
size_t
 
size
)

296 
vÆ
;

297 
˝u
 = 
dev
->
id
;

298 
ªt
 = 0;

299 *
íd
;

301 
vÆ
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

302 i‡(
íd
 =
buf
)

303  -
EINVAL
;

305 i‡(
vÆ
 == 1) {

306 
	`gë_⁄löe_˝us
();

307 i‡(
	`˝u_⁄löe
(
˝u
))

308 
ªt
 = 
	`ªlﬂd_f‹_˝u
(
˝u
);

309 
	`put_⁄löe_˝us
();

312 i‡(!
ªt
)

313 
ªt
 = 
size
;

315  
ªt
;

316 
	}
}

318 
ssize_t
 
	$vîsi⁄_show
(
sys_devi˚
 *
dev
,

319 
sysdev_©åibuã
 *
©å
, *
buf
)

321 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

323  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
ªv
);

324 
	}
}

326 
ssize_t
 
	$pf_show
(
sys_devi˚
 *
dev
,

327 
sysdev_©åibuã
 *
©å
, *
buf
)

329 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

331  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
pf
);

332 
	}
}

334 
SYSDEV_ATTR
(
ªlﬂd
, 0200, 
NULL
, 
ªlﬂd_°‹e
);

335 
SYSDEV_ATTR
(
vîsi⁄
, 0400, 
vîsi⁄_show
, 
NULL
);

336 
SYSDEV_ATTR
(
¥o˚ss‹_Êags
, 0400, 
pf_show
, 
NULL
);

338 
©åibuã
 *
	gmc_deÁu…_©ås
[] = {

339 &
©å_ªlﬂd
.
©å
,

340 &
©å_vîsi⁄
.
©å
,

341 &
©å_¥o˚ss‹_Êags
.
©å
,

342 
NULL


345 
©åibuã_group
 
	gmc_©å_group
 = {

346 .
©ås
 = 
mc_deÁu…_©ås
,

347 .
	g«me
 = "microcode",

350 
	$mi¸ocode_föi_˝u
(
˝u
)

352 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

354 
mi¸ocode_›s
->
	`mi¸ocode_föi_˝u
(
˝u
);

355 
uci
->
vÆid
 = 0;

356 
	}
}

358 
ucode_°©e
 
	$mi¸ocode_ªsume_˝u
(
˝u
)

360 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

362 i‡(!
uci
->
mc
)

363  
UCODE_NFOUND
;

365 
	`¥_debug
("CPU%d upd©ed up⁄Ñesume\n", 
˝u
);

366 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

368  
UCODE_OK
;

369 
	}
}

371 
ucode_°©e
 
	$mi¸ocode_öô_˝u
(
˝u
)

373 
ucode_°©e
 
u°©e
;

375 i‡(
	`cﬁÀ˘_˝u_öfo
(
˝u
))

376  
UCODE_ERROR
;

379 i‡(
sy°em_°©e
 !
SYSTEM_RUNNING
)

380  
UCODE_NFOUND
;

382 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

384 i‡(
u°©e
 =
UCODE_OK
) {

385 
	`¥_debug
("CPU%d upd©ed up⁄ inô\n", 
˝u
);

386 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

389  
u°©e
;

390 
	}
}

392 
ucode_°©e
 
	$mi¸ocode_upd©e_˝u
(
˝u
)

394 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

395 
ucode_°©e
 
u°©e
;

397 i‡(
uci
->
vÆid
)

398 
u°©e
 = 
	`mi¸ocode_ªsume_˝u
(
˝u
);

400 
u°©e
 = 
	`mi¸ocode_öô_˝u
(
˝u
);

402  
u°©e
;

403 
	}
}

405 
	$mc_sysdev_add
(
sys_devi˚
 *
sys_dev
)

407 
îr
, 
˝u
 = 
sys_dev
->
id
;

409 i‡(!
	`˝u_⁄löe
(
˝u
))

412 
	`¥_debug
("CPU%dádded\n", 
˝u
);

414 
îr
 = 
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

415 i‡(
îr
)

416  
îr
;

418 i‡(
	`mi¸ocode_öô_˝u
(
˝u
Ë=
UCODE_ERROR
)

419 
îr
 = -
EINVAL
;

421  
îr
;

422 
	}
}

424 
	$mc_sysdev_ªmove
(
sys_devi˚
 *
sys_dev
)

426 
˝u
 = 
sys_dev
->
id
;

428 i‡(!
	`˝u_⁄löe
(
˝u
))

431 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

432 
	`mi¸ocode_föi_˝u
(
˝u
);

433 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

435 
	}
}

437 
	$mc_sysdev_ªsume
(
sys_devi˚
 *
dev
)

439 
˝u
 = 
dev
->
id
;

440 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

442 i‡(!
	`˝u_⁄löe
(
˝u
))

452 
	`WARN_ON
(
˝u
 != 0);

454 i‡(
uci
->
vÆid
 && uci->
mc
)

455 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
˝u
);

458 
	}
}

460 
sysdev_drivî
 
	gmc_sysdev_drivî
 = {

461 .
add
 = 
mc_sysdev_add
,

462 .
	gªmove
 = 
mc_sysdev_ªmove
,

463 .
	gªsume
 = 
mc_sysdev_ªsume
,

466 
__˝uöô
 

467 
	$mc_˝u_ˇŒback
(
nŸifõr_block
 *
nb
, 
a˘i⁄
, *
h˝u
)

469 
˝u
 = ()
h˝u
;

470 
sys_devi˚
 *
sys_dev
;

472 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

473 
a˘i⁄
) {

474 
CPU_ONLINE
:

475 
CPU_ONLINE_FROZEN
:

476 
	`mi¸ocode_upd©e_˝u
(
˝u
);

477 
CPU_DOWN_FAILED
:

478 
CPU_DOWN_FAILED_FROZEN
:

479 
	`¥_debug
("CPU%dádded\n", 
˝u
);

480 i‡(
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
))

481 
	`¥_îr
("FaûedÅÿ¸óã grou∞f‹ CPU%d\n", 
˝u
);

483 
CPU_DOWN_PREPARE
:

484 
CPU_DOWN_PREPARE_FROZEN
:

486 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

487 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

489 
CPU_DEAD
:

490 
CPU_UP_CANCELED_FROZEN
:

492 
	`mi¸ocode_föi_˝u
(
˝u
);

495  
NOTIFY_OK
;

496 
	}
}

498 
nŸifõr_block
 
__ªfd©a
 
	gmc_˝u_nŸifõr
 = {

499 .
nŸifõr_ˇŒ
 = 
mc_˝u_ˇŒback
,

502 
__öô
 
	$mi¸ocode_öô
()

504 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(0);

505 
îr‹
;

507 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

508 
mi¸ocode_›s
 = 
	`öô_öãl_mi¸ocode
();

509 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)

510 
mi¸ocode_›s
 = 
	`öô_amd_mi¸ocode
();

512 i‡(!
mi¸ocode_›s
) {

513 
	`¥_îr
("no support forÅhis CPU vendor\n");

514  -
ENODEV
;

517 
mi¸ocode_pdev
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("microcode", -1,

518 
NULL
, 0);

519 i‡(
	`IS_ERR
(
mi¸ocode_pdev
)) {

520 
	`mi¸ocode_dev_exô
();

521  
	`PTR_ERR
(
mi¸ocode_pdev
);

524 
	`gë_⁄löe_˝us
();

525 
	`muãx_lock
(&
mi¸ocode_muãx
);

527 
îr‹
 = 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

529 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

530 
	`put_⁄löe_˝us
();

532 i‡(
îr‹
) {

533 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

534  
îr‹
;

537 
îr‹
 = 
	`mi¸ocode_dev_öô
();

538 i‡(
îr‹
)

539  
îr‹
;

541 
	`ªgi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

543 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION


547 
	}
}

548 
moduÀ_öô
(
mi¸ocode_öô
);

550 
__exô
 
	$mi¸ocode_exô
()

552 
	`mi¸ocode_dev_exô
();

554 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

556 
	`gë_⁄löe_˝us
();

557 
	`muãx_lock
(&
mi¸ocode_muãx
);

559 
	`sysdev_drivî_uƒegi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

561 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

562 
	`put_⁄löe_˝us
();

564 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

566 
mi¸ocode_›s
 = 
NULL
;

568 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION
 "Ñemoved.\n");

569 
	}
}

570 
moduÀ_exô
(
mi¸ocode_exô
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/fúmw¨e.h
>

77 
	~<löux/uac˚ss.h
>

78 
	~<löux/kî√l.h
>

79 
	~<löux/moduÀ.h
>

80 
	~<löux/vmÆloc.h
>

82 
	~<asm/mi¸ocode.h
>

83 
	~<asm/¥o˚ss‹.h
>

84 
	~<asm/m§.h
>

86 
MODULE_DESCRIPTION
("Microcode Update Driver");

87 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

88 
MODULE_LICENSE
("GPL");

90 
	smi¸ocode_hódî_öãl
 {

91 
	mhdrvî
;

92 
	mªv
;

93 
	md©e
;

94 
	msig
;

95 
	mcksum
;

96 
	mldrvî
;

97 
	mpf
;

98 
	md©asize
;

99 
	mtŸÆsize
;

100 
	mª£rved
[3];

103 
	smi¸ocode_öãl
 {

104 
mi¸ocode_hódî_öãl
 
	mhdr
;

105 
	mbôs
[0];

109 
	sexãnded_sig«tuª
 {

110 
	msig
;

111 
	mpf
;

112 
	mcksum
;

115 
	sexãnded_sigèbÀ
 {

116 
	mcou¡
;

117 
	mcksum
;

118 
	mª£rved
[3];

119 
exãnded_sig«tuª
 
	msigs
[0];

122 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

123 
	#MC_HEADER_SIZE
 ((
mi¸ocode_hódî_öãl
))

	)

124 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

125 
	#EXT_HEADER_SIZE
 ((
exãnded_sigèbÀ
))

	)

126 
	#EXT_SIGNATURE_SIZE
 ((
exãnded_sig«tuª
))

	)

127 
	#DWSIZE
 ((
u32
))

	)

129 
	#gë_tŸÆsize
(
mc
) \

130 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 ? \

131 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 : \

132 
DEFAULT_UCODE_TOTALSIZE
)

	)

134 
	#gë_d©asize
(
mc
) \

135 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 ? \

136 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

138 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

139 (((
s1
Ë=(
s2
)Ë&& (((
p1
Ë& (
p2
)Ë|| ((’1Ë=0Ë&& (’2Ë=0))))

	)

141 
	#exâabÀ_size
(
ë
Ë(”t)->
cou¡
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

143 
	$cﬁÀ˘_˝u_öfo
(
˝u_num
, 
˝u_sig«tuª
 *
csig
)

145 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u_num
);

146 
vÆ
[2];

148 
	`mem£t
(
csig
, 0, (*csig));

150 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

151 
	`˝u_has
(
c
, 
X86_FEATURE_IA64
)) {

152 
	`¥_îr
("CPU%dÇŸá c≠abÀ I¡ñÖro˚ss‹\n", 
˝u_num
);

156 
csig
->
sig
 = 
	`˝uid_óx
(0x00000001);

158 i‡((
c
->
x86_modñ
 >5Ë|| (c->
x86
 > 6)) {

160 
	`rdm§
(
MSR_IA32_PLATFORM_ID
, 
vÆ
[0], val[1]);

161 
csig
->
pf
 = 1 << ((
vÆ
[1] >> 18) & 7);

164 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

166 
	`sync_c‹e
();

168 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], 
csig
->
ªv
);

170 
	`¥_öfo
("CPU%d sig=0x%x,Öf=0x%x,Ñevision=0x%x\n",

171 
˝u_num
, 
csig
->
sig
, csig->
pf
, csig->
ªv
);

174 
	}
}

176 
ölöe
 
	$upd©e_m©ch_˝u
(
˝u_sig«tuª
 *
csig
, 
sig
, 
pf
)

178  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

179 
	}
}

181 
ölöe
 

182 
	$upd©e_m©ch_ªvisi⁄
(
mi¸ocode_hódî_öãl
 *
mc_hódî
, 
ªv
)

184  (
mc_hódî
->
ªv
 <=Ñev) ? 0 : 1;

185 
	}
}

187 
	$mi¸ocode_ßnôy_check
(*
mc
)

189 
tŸÆ_size
, 
d©a_size
, 
ext_èbÀ_size
;

190 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

191 
exãnded_sigèbÀ
 *
ext_hódî
 = 
NULL
;

192 
sum
, 
‹ig_sum
, 
ext_sigcou¡
 = 0, 
i
;

193 
exãnded_sig«tuª
 *
ext_sig
;

195 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

196 
d©a_size
 = 
	`gë_d©asize
(
mc_hódî
);

198 i‡(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tŸÆ_size
) {

199 
	`¥_îr
("error! Bad data size in microcode data file\n");

200  -
EINVAL
;

203 i‡(
mc_hódî
->
ldrvî
 !1 || mc_hódî->
hdrvî
 != 1) {

204 
	`¥_îr
("error! Unknown microcode update format\n");

205  -
EINVAL
;

207 
ext_èbÀ_size
 = 
tŸÆ_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

208 i‡(
ext_èbÀ_size
) {

209 i‡((
ext_èbÀ_size
 < 
EXT_HEADER_SIZE
)

210 || ((
ext_èbÀ_size
 - 
EXT_HEADER_SIZE
Ë% 
EXT_SIGNATURE_SIZE
)) {

211 
	`¥_îr
("error! SmallÉxttable size in microcode data file\n");

212  -
EINVAL
;

214 
ext_hódî
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

215 i‡(
ext_èbÀ_size
 !
	`exâabÀ_size
(
ext_hódî
)) {

216 
	`¥_îr
("error! BadÉxttable size in microcode data file\n");

217  -
EFAULT
;

219 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

223 i‡(
ext_èbÀ_size
) {

224 
ext_èbÀ_sum
 = 0;

225 *
ext_èbÀp
 = (*)
ext_hódî
;

227 
i
 = 
ext_èbÀ_size
 / 
DWSIZE
;

228 
i
--)

229 
ext_èbÀ_sum
 +
ext_èbÀp
[
i
];

230 i‡(
ext_èbÀ_sum
) {

231 
	`¥_w¨nög
("aborting, badÉxtended signatureÅable checksum\n");

232  -
EINVAL
;

237 
‹ig_sum
 = 0;

238 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
Ë/ 
DWSIZE
;

239 
i
--)

240 
‹ig_sum
 +((*)
mc
)[
i
];

241 i‡(
‹ig_sum
) {

242 
	`¥_îr
("aborting, bad checksum\n");

243  -
EINVAL
;

245 i‡(!
ext_èbÀ_size
)

248 
i
 = 0; i < 
ext_sigcou¡
; i++) {

249 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
 +

250 
EXT_SIGNATURE_SIZE
 * 
i
;

251 
sum
 = 
‹ig_sum


252 - (
mc_hódî
->
sig
 + mc_hódî->
pf
 + mc_hódî->
cksum
)

253 + (
ext_sig
->
sig
 +Éxt_sig->
pf
 +Éxt_sig->
cksum
);

254 i‡(
sum
) {

255 
	`¥_îr
("aborting, bad checksum\n");

256  -
EINVAL
;

260 
	}
}

267 
	$gë_m©chög_mi¸ocode
(
˝u_sig«tuª
 *
˝u_sig
, *
mc
, 
ªv
)

269 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

270 
exãnded_sigèbÀ
 *
ext_hódî
;

271 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

272 
ext_sigcou¡
, 
i
;

273 
exãnded_sig«tuª
 *
ext_sig
;

275 i‡(!
	`upd©e_m©ch_ªvisi⁄
(
mc_hódî
, 
ªv
))

278 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
mc_hódî
->
sig
, mc_hódî->
pf
))

282 i‡(
tŸÆ_size
 <
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
)

285 
ext_hódî
 = 
mc
 + 
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
;

286 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

287 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
;

289 
i
 = 0; i < 
ext_sigcou¡
; i++) {

290 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
ext_sig
->
sig
,Éxt_sig->
pf
))

292 
ext_sig
++;

295 
	}
}

297 
	$≠∂y_mi¸ocode
(
˝u
)

299 
mi¸ocode_öãl
 *
mc_öãl
;

300 
ucode_˝u_öfo
 *
uci
;

301 
vÆ
[2];

302 
˝u_num
;

304 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

305 
uci
 = 
ucode_˝u_öfo
 + 
˝u
;

306 
mc_öãl
 = 
uci
->
mc
;

309 
	`BUG_ON
(
˝u_num
 !
˝u
);

311 i‡(
mc_öãl
 =
NULL
)

315 
	`wrm§
(
MSR_IA32_UCODE_WRITE
,

316 (Ë
mc_öãl
->
bôs
,

317 (Ë
mc_öãl
->
bôs
 >> 16 >> 16);

318 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

321 
	`sync_c‹e
();

324 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], val[1]);

326 i‡(
vÆ
[1] !
mc_öãl
->
hdr
.
ªv
) {

327 
	`¥_îr
("CPU%d updateÅoÑevision 0x%x failed\n",

328 
˝u_num
, 
mc_öãl
->
hdr
.
ªv
);

331 
	`¥_öfo
("CPU%d updatedÅoÑevision 0x%x, date = %04x-%02x-%02x\n",

332 
˝u_num
, 
vÆ
[1],

333 
mc_öãl
->
hdr
.
d©e
 & 0xffff,

334 
mc_öãl
->
hdr
.
d©e
 >> 24,

335 (
mc_öãl
->
hdr
.
d©e
 >> 16) & 0xff);

337 
uci
->
˝u_sig
.
ªv
 = 
vÆ
[1];

340 
	}
}

342 
ucode_°©e
 
gíîic_lﬂd_mi¸ocode
(
˝u
, *
d©a
, 
size_t
 
size
,

343 (*
gë_ucode_d©a
)(*, c⁄° *, 
size_t
))

345 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

346 
u8
 *
ucode_±r
 = 
d©a
, *
√w_mc
 = 
NULL
, *
mc
;

347 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

348 
À·ovî
 = 
size
;

349 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

351 
À·ovî
) {

352 
mi¸ocode_hódî_öãl
 
mc_hódî
;

353 
mc_size
;

355 i‡(
	`gë_ucode_d©a
(&
mc_hódî
, 
ucode_±r
, (mc_header)))

358 
mc_size
 = 
	`gë_tŸÆsize
(&
mc_hódî
);

359 i‡(!
mc_size
 || mc_sizê> 
À·ovî
) {

360 
	`¥_îr
("error! Bad data in microcode data file\n");

364 
mc
 = 
	`vmÆloc
(
mc_size
);

365 i‡(!
mc
)

368 i‡(
	`gë_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

369 
	`mi¸ocode_ßnôy_check
(
mc
) < 0) {

370 
	`v‰ì
(
mc
);

374 i‡(
	`gë_m©chög_mi¸ocode
(&
uci
->
˝u_sig
, 
mc
, 
√w_ªv
)) {

375 i‡(
√w_mc
)

376 
	`v‰ì
(
√w_mc
);

377 
√w_ªv
 = 
mc_hódî
.
ªv
;

378 
√w_mc
 = 
mc
;

380 
	`v‰ì
(
mc
);

382 
ucode_±r
 +
mc_size
;

383 
À·ovî
 -
mc_size
;

386 i‡(
À·ovî
) {

387 i‡(
√w_mc
)

388 
	`v‰ì
(
√w_mc
);

389 
°©e
 = 
UCODE_ERROR
;

390 
out
;

393 i‡(!
√w_mc
) {

394 
°©e
 = 
UCODE_NFOUND
;

395 
out
;

398 i‡(
uci
->
mc
)

399 
	`v‰ì
(
uci
->
mc
);

400 
uci
->
mc
 = (
mi¸ocode_öãl
 *)
√w_mc
;

402 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

403 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

404 
out
:

405  
°©e
;

406 
	}
}

408 
	$gë_ucode_fw
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

410 
	`mem˝y
(
to
, 
‰om
, 
n
);

412 
	}
}

414 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

416 
«me
[30];

417 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

418 c⁄° 
fúmw¨e
 *firmware;

419 
ucode_°©e
 
ªt
;

421 
	`•rötf
(
«me
, "intel-ucode/%02x-%02x-%02x",

422 
c
->
x86
, c->
x86_modñ
, c->
x86_mask
);

424 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
«me
, 
devi˚
)) {

425 
	`¥_debug
("d©®fûê%†lﬂd faûed\n", 
«me
);

426  
UCODE_NFOUND
;

429 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
fúmw¨e
->
d©a
,

430 
fúmw¨e
->
size
, &
gë_ucode_fw
);

432 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

434  
ªt
;

435 
	}
}

437 
	$gë_ucode_u£r
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

439  
	`c›y_‰om_u£r
(
to
, 
‰om
, 
n
);

440 
	}
}

442 
ucode_°©e


443 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

445  
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
buf
, 
size
, &
gë_ucode_u£r
);

446 
	}
}

448 
	$mi¸ocode_föi_˝u
(
˝u
)

450 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

452 
	`v‰ì
(
uci
->
mc
);

453 
uci
->
mc
 = 
NULL
;

454 
	}
}

456 
mi¸ocode_›s
 
	gmi¸ocode_öãl_›s
 = {

457 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

458 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

459 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo
,

460 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode
,

461 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u
,

464 
mi¸ocode_›s
 * 
__öô
 
	$öô_öãl_mi¸ocode
()

466  &
mi¸ocode_öãl_›s
;

467 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/dmi.h
>

10 
	~<löux/ønge.h
>

12 
	~<asm/pci-dúe˘.h
>

13 
	~<löux/s‹t.h
>

14 
	~<asm/io.h
>

15 
	~<asm/m§.h
>

16 
	~<asm/a˝i.h
>

17 
	~<asm/mmc⁄fig.h
>

18 
	~<asm/pci_x86.h
>

20 
	spci_ho°bridge_¥obe
 {

21 
u32
 
	mbus
;

22 
u32
 
	m¶Ÿ
;

23 
u32
 
	mvíd‹
;

24 
u32
 
	mdevi˚
;

27 
u64
 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£
;

28 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£_°©us
;

30 
pci_ho°bridge_¥obe
 
	gpci_¥obes
[] 
	g__˝uöôd©a
 = {

31 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

32 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

35 
__˝uöô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

37 c⁄° 
ønge
 *
r1
 = 
x1
;

38 c⁄° 
ønge
 *
r2
 = 
x2
;

39 
°¨t1
, 
°¨t2
;

41 
°¨t1
 = 
r1
->
°¨t
 >> 32;

42 
°¨t2
 = 
r2
->
°¨t
 >> 32;

44  
°¨t1
 - 
°¨t2
;

45 
	}
}

49 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

50 
	#BASE_VALID
(
b
Ë((b !(0xfdULL << 32)Ë&& (b !(0x„ULL << 32)))

	)

51 
__˝uöô
 
	$gë_Ám10h_pci_mmc⁄f_ba£
()

53 
i
;

54 
bus
;

55 
¶Ÿ
;

56 
found
;

58 
u64
 
vÆ
;

59 
u32
 
addªss
;

60 
u64
 
tom2
;

61 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

63 
hi_mmio_num
;

64 
ønge
Ñange[8];

68 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
)

71 i‡(!
	`óæy_pci_Ælowed
())

72 
Áû
;

74 
found
 = 0;

75 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_¥obes
); i++) {

76 
u32
 
id
;

77 
u16
 
devi˚
;

78 
u16
 
víd‹
;

80 
bus
 = 
pci_¥obes
[
i
].bus;

81 
¶Ÿ
 = 
pci_¥obes
[
i
].slot;

82 
id
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 0, 
PCI_VENDOR_ID
);

84 
víd‹
 = 
id
 & 0xffff;

85 
devi˚
 = (
id
>>16) & 0xffff;

86 i‡(
pci_¥obes
[
i
].
víd‹
 == vendor &&

87 
pci_¥obes
[
i
].
devi˚
 == device) {

88 
found
 = 1;

93 i‡(!
found
)

94 
Áû
;

97 
addªss
 = 
MSR_K8_SYSCFG
;

98 
	`rdm§l
(
addªss
, 
vÆ
);

101 i‡(!(
vÆ
 & (1<<21))) {

102 
tom2
 = 0;

105 
addªss
 = 
MSR_K8_TOP_MEM2
;

106 
	`rdm§l
(
addªss
, 
vÆ
);

107 
tom2
 = 
vÆ
 & (0xffffULL<<32);

110 i‡(
ba£
 <
tom2
)

111 
ba£
 = 
tom2
 + (1ULL<<32);

117 
hi_mmio_num
 = 0;

118 
i
 = 0; i < 8; i++) {

119 
u32
 
ªg
;

120 
u64
 
°¨t
;

121 
u64
 
íd
;

122 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x80 + (
i
 << 3));

123 i‡(!(
ªg
 & 3))

126 
°¨t
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

127 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x84 + (
i
 << 3));

128 
íd
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

130 i‡(!
íd
)

133 
ønge
[
hi_mmio_num
].
°¨t
 = start;

134 
ønge
[
hi_mmio_num
].
íd
 =Énd;

135 
hi_mmio_num
++;

138 i‡(!
hi_mmio_num
)

139 
out
;

142 
	`s‹t
(
ønge
, 
hi_mmio_num
, (ønge), 
cmp_ønge
, 
NULL
);

144 i‡(
ønge
[
hi_mmio_num
 - 1].
íd
 < 
ba£
)

145 
out
;

146 i‡(
ønge
[0].
°¨t
 > 
ba£
)

147 
out
;

150 
ba£
 = 
ønge
[0].
°¨t
 - (1ULL << 32);

151 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

152 
out
;

153 
ba£
 = 
ønge
[
hi_mmio_num
 - 1].
íd
 + (1ULL << 32);

154 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

155 
out
;

157 i‡(
hi_mmio_num
 > 1)

158 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

159 i‡(
ønge
[
i
 + 1].
°¨t
 > (ønge[i].
íd
 + (1ULL << 32))) {

160 
ba£
 = 
ønge
[
i
].
íd
 + (1ULL << 32);

161 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

162 
out
;

166 
Áû
:

167 
Ám10h_pci_mmc⁄f_ba£_°©us
 = -1;

169 
out
:

170 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

171 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

172 
	}
}

174 
__˝uöô
 
	$Ám10h_check_íabÀ_mmcfg
()

176 
u64
 
vÆ
;

177 
u32
 
addªss
;

179 i‡(!(
pci_¥obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

182 
addªss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

183 
	`rdm§l
(
addªss
, 
vÆ
);

186 i‡(
vÆ
 & 
FAM10H_MMIO_CONF_ENABLE
) {

187 
bu¢bôs
;

188 
bu¢bôs
 = (
vÆ
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

189 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

192 i‡(!
a˝i_pci_dißbÀd
 || 
bu¢bôs
 >= 8) {

193 
u64
 
ba£
;

194 
ba£
 = 
vÆ
 & (0xffffULL << 32);

195 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0) {

196 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

197 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

199 } i‡(
Ám10h_pci_mmc⁄f_ba£
 =
ba£
)

208 
	`gë_Ám10h_pci_mmc⁄f_ba£
();

209 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0)

212 
	`¥ötk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

213 
vÆ
 &~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

214 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

215 
vÆ
 |
Ám10h_pci_mmc⁄f_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

216 
FAM10H_MMIO_CONF_ENABLE
;

217 
	`wrm§l
(
addªss
, 
vÆ
);

218 
	}
}

220 
__devöô
 
	$£t_check_íabÀ_amd_mmc⁄f
(c⁄° 
dmi_sy°em_id
 *
d
)

222 
pci_¥obe
 |
PCI_CHECK_ENABLE_AMD_MMCONF
;

224 
	}
}

226 c⁄° 
dmi_sy°em_id
 
__˝uöôc⁄°
 
	gmmc⁄f_dmi_èbÀ
[] = {

228 .
ˇŒback
 = 
£t_check_íabÀ_amd_mmc⁄f
,

229 .
	gidít
 = "Sun Microsystems Machine",

230 .
	gm©ches
 = {

231 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

237 
__˝uöô
 
	$check_íabÀ_amd_mmc⁄f_dmi
()

239 
	`dmi_check_sy°em
(
mmc⁄f_dmi_èbÀ
);

240 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/bug.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/gÂ.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/pgèbÀ.h
>

33 
	#DEBUGP
 
¥ötk


	)

35 
	#DEBUGP
(
fmt
...)

	)

38 *
	$moduÀ_Æloc
(
size
)

40 
vm_°ru˘
 *
¨ó
;

42 i‡(!
size
)

43  
NULL
;

44 
size
 = 
	`PAGE_ALIGN
(size);

45 i‡(
size
 > 
MODULES_LEN
)

46  
NULL
;

48 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

49 i‡(!
¨ó
)

50  
NULL
;

52  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
,

53 
PAGE_KERNEL_EXEC
);

54 
	}
}

57 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

59 
	`v‰ì
(
moduÀ_ªgi⁄
);

60 
	}
}

63 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

64 
Elf_Shdr
 *
£chdrs
,

65 *
£c°rögs
,

66 
moduÀ
 *
mod
)

69 
	}
}

71 #ifde‡
CONFIG_X86_32


72 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
,

73 c⁄° *
°πab
,

74 
symödex
,

75 
ªl£c
,

76 
moduÀ
 *
me
)

78 
i
;

79 
Elf32_Rñ
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

80 
Elf32_Sym
 *
sym
;

81 
uöt32_t
 *
loˇti⁄
;

83 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

84 
£chdrs
[
ªl£c
].
sh_öfo
);

85 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

87 
loˇti⁄
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


88 + 
ªl
[
i
].
r_off£t
;

91 
sym
 = (
Elf32_Sym
 *)
£chdrs
[
symödex
].
sh_addr


92 + 
	`ELF32_R_SYM
(
ªl
[
i
].
r_öfo
);

94 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

95 
R_386_32
:

97 *
loˇti⁄
 +
sym
->
°_vÆue
;

99 
R_386_PC32
:

101 *
loˇti⁄
 +
sym
->
°_vÆue
 - (
uöt32_t
)location;

104 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %u\n",

105 
me
->
«me
, 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
));

106  -
ENOEXEC
;

110 
	}
}

112 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
,

113 c⁄° *
°πab
,

114 
symödex
,

115 
ªl£c
,

116 
moduÀ
 *
me
)

118 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

119 
me
->
«me
);

120  -
ENOEXEC
;

121 
	}
}

123 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
,

124 c⁄° *
°πab
,

125 
symödex
,

126 
ªl£c
,

127 
moduÀ
 *
me
)

129 
i
;

130 
Elf64_Rña
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

131 
Elf64_Sym
 *
sym
;

132 *
loc
;

133 
u64
 
vÆ
;

135 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

136 
£chdrs
[
ªl£c
].
sh_öfo
);

137 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

139 
loc
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


140 + 
ªl
[
i
].
r_off£t
;

144 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr


145 + 
	`ELF64_R_SYM
(
ªl
[
i
].
r_öfo
);

147 
	`DEBUGP
("type %d st_value %LxÑ_addend %LxÜoc %Lx\n",

148 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
),

149 
sym
->
°_vÆue
, 
ªl
[
i
].
r_addíd
, (
u64
)
loc
);

151 
vÆ
 = 
sym
->
°_vÆue
 + 
ªl
[
i
].
r_addíd
;

153 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

154 
R_X86_64_NONE
:

156 
R_X86_64_64
:

157 *(
u64
 *)
loc
 = 
vÆ
;

159 
R_X86_64_32
:

160 *(
u32
 *)
loc
 = 
vÆ
;

161 i‡(
vÆ
 !*(
u32
 *)
loc
)

162 
ovîÊow
;

164 
R_X86_64_32S
:

165 *(
s32
 *)
loc
 = 
vÆ
;

166 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

167 
ovîÊow
;

169 
R_X86_64_PC32
:

170 
vÆ
 -(
u64
)
loc
;

171 *(
u32
 *)
loc
 = 
vÆ
;

173 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

174 
ovîÊow
;

178 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelaÑelocation: %llu\n",

179 
me
->
«me
, 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
));

180  -
ENOEXEC
;

185 
ovîÊow
:

186 
	`¥ötk
(
KERN_ERR
 "overflow inÑelocationÅype %d val %Lx\n",

187 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
), 
vÆ
);

188 
	`¥ötk
(
KERN_ERR
 "`%s'ÜikelyÇot compiled with -mcmodel=kernel\n",

189 
me
->
«me
);

190  -
ENOEXEC
;

191 
	}
}

193 
	$≠∂y_ªloˇã
(
Elf_Shdr
 *
£chdrs
,

194 c⁄° *
°πab
,

195 
symödex
,

196 
ªl£c
,

197 
moduÀ
 *
me
)

199 
	`¥ötk
(
KERN_ERR
 "nonáddÑelocationÇot supported\n");

200  -
ENOSYS
;

201 
	}
}

205 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
,

206 c⁄° 
Elf_Shdr
 *
£chdrs
,

207 
moduÀ
 *
me
)

209 c⁄° 
Elf_Shdr
 *
s
, *
ãxt
 = 
NULL
, *
Æt
 = NULL, *
locks
 = NULL,

210 *
∑ø
 = 
NULL
;

211 *
£c°rögs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh°∫dx
].
sh_off£t
;

213 
s
 = 
£chdrs
; s < sechdr†+ 
hdr
->
e_shnum
; s++) {

214 i‡(!
	`°rcmp
(".ãxt", 
£c°rögs
 + 
s
->
sh_«me
))

215 
ãxt
 = 
s
;

216 i‡(!
	`°rcmp
(".Ætö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

217 
Æt
 = 
s
;

218 i‡(!
	`°rcmp
(".smp_locks", 
£c°rögs
 + 
s
->
sh_«me
))

219 
locks
 = 
s
;

220 i‡(!
	`°rcmp
(".∑øö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

221 
∑ø
 = 
s
;

224 i‡(
Æt
) {

226 *
a£g
 = (*)
Æt
->
sh_addr
;

227 
	`≠∂y_Æã∫©ives
(
a£g
,á£g + 
Æt
->
sh_size
);

229 i‡(
locks
 && 
ãxt
) {

230 *
l£g
 = (*)
locks
->
sh_addr
;

231 *
t£g
 = (*)
ãxt
->
sh_addr
;

232 
	`Æã∫©ives_smp_moduÀ_add
(
me
, me->
«me
,

233 
l£g
,Ü£g + 
locks
->
sh_size
,

234 
t£g
,Å£g + 
ãxt
->
sh_size
);

237 i‡(
∑ø
) {

238 *
p£g
 = (*)
∑ø
->
sh_addr
;

239 
	`≠∂y_∑øvút
(
p£g
,Ö£g + 
∑ø
->
sh_size
);

242  
	`moduÀ_bug_föÆize
(
hdr
, 
£chdrs
, 
me
);

243 
	}
}

245 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

247 
	`Æã∫©ives_smp_moduÀ_dñ
(
mod
);

248 
	`moduÀ_bug_˛ónup
(
mod
);

249 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<löux/mm.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dñay.h
>

13 
	~<löux/boŸmem.h
>

14 
	~<löux/kî√l_°©.h
>

15 
	~<löux/mc146818πc.h
>

16 
	~<löux/bô›s.h
>

17 
	~<löux/a˝i.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/pci.h
>

22 
	~<asm/mår.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/pgÆloc.h
>

25 
	~<asm/io_≠ic.h
>

26 
	~<asm/¥Ÿo.h
>

27 
	~<asm/bios_ebda.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/åampﬁöe.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/smp.h
>

33 
	~<asm/≠ic.h
>

38 
__öô
 
	$mpf_checksum
(*
mp
, 
Àn
)

40 
sum
 = 0;

42 
Àn
--)

43 
sum
 +*
mp
++;

45  
sum
 & 0xFF;

46 
	}
}

48 
__öô
 
	$deÁu…_mpc_≠ic_id
(
mpc_˝u
 *
m
)

50  
m
->
≠icid
;

51 
	}
}

53 
__öô
 
	$MP_¥o˚ss‹_öfo
(
mpc_˝u
 *
m
)

55 
≠icid
;

56 *
boŸup_˝u
 = "";

58 i‡(!(
m
->
˝uÊag
 & 
CPU_ENABLED
)) {

59 
dißbÀd_˝us
++;

63 
≠icid
 = 
x86_öô
.
mµ¨£
.
	`mpc_≠ic_id
(
m
);

65 i‡(
m
->
˝uÊag
 & 
CPU_BOOTPROCESSOR
) {

66 
boŸup_˝u
 = " (Bootup-CPU)";

67 
boŸ_˝u_physiˇl_≠icid
 = 
m
->
≠icid
;

70 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹ #%d%s\n", 
m
->
≠icid
, 
boŸup_˝u
);

71 
	`gíîic_¥o˚ss‹_öfo
(
≠icid
, 
m
->
≠icvî
);

72 
	}
}

74 #ifde‡
CONFIG_X86_IO_APIC


75 
__öô
 
	$deÁu…_mpc_€m_bus_öfo
(
mpc_bus
 *
m
, *
°r
)

77 
	`mem˝y
(
°r
, 
m
->
bu°y≥
, 6);

78 
°r
[6] = 0;

79 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Bu†#%d i†%s\n", 
m
->
busid
, 
°r
);

80 
	}
}

82 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
)

84 
°r
[7];

86 
x86_öô
.
mµ¨£
.
	`mpc_€m_bus_öfo
(
m
, 
°r
);

88 #i‡
MAX_MP_BUSSES
 < 256

89 i‡(
m
->
busid
 >
MAX_MP_BUSSES
) {

90 
	`¥ötk
(
KERN_WARNING
 "MPÅable busid value (%d) for bustype %s "

92 
m
->
busid
, 
°r
, 
MAX_MP_BUSSES
 - 1);

97 i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

98 
	`£t_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

99 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

100 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_ISA
;

102 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

103 i‡(
x86_öô
.
mµ¨£
.
mpc_€m_pci_bus
)

104 
x86_öô
.
mµ¨£
.
	`mpc_€m_pci_bus
(
m
);

106 
	`˛ór_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

107 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

108 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_PCI
;

109 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

110 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_EISA
;

111 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

112 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_MCA
;

115 
	`¥ötk
(
KERN_WARNING
 "Unknow¿bu°y≥ %†- ign‹ög\n", 
°r
);

116 
	}
}

118 
	$bad_iﬂpic
(
addªss
)

120 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

121 
	`¥ötk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)Éxceeded "

122 "(found %d)\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

123 
	`∑nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

125 i‡(!
addªss
) {

126 
	`¥ötk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APICáddress"

131 
	}
}

133 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
)

135 i‡(!(
m
->
Êags
 & 
MPC_APIC_USABLE
))

138 
	`¥ötk
(
KERN_INFO
 "I/O APIC #%d Version %dát 0x%X.\n",

139 
m
->
≠icid
, m->
≠icvî
, m->
≠iˇddr
);

141 i‡(
	`bad_iﬂpic
(
m
->
≠iˇddr
))

144 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠iˇddr
 = 
m
->apicaddr;

145 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icid
 = 
m
->apicid;

146 
mp_iﬂpics
[
ƒ_iﬂpics
].
ty≥
 = 
m
->type;

147 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icvî
 = 
m
->apicver;

148 
mp_iﬂpics
[
ƒ_iﬂpics
].
Êags
 = 
m
->flags;

149 
ƒ_iﬂpics
++;

150 
	}
}

152 
	$¥öt_MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

154 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

156 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbus
,

157 
m
->
§cbusúq
, m->
d°≠ic
, m->
d°úq
);

158 
	}
}

160 
__öô
 
	$¥öt_mp_úq_öfo
(
mpc_öt§c
 *
mp_úq
)

162 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

164 
mp_úq
->
úqty≥
, mp_úq->
úqÊag
 & 3,

165 (
mp_úq
->
úqÊag
 >> 2Ë& 3, mp_úq->
§cbus
,

166 
mp_úq
->
§cbusúq
, mp_úq->
d°≠ic
, mp_úq->
d°úq
);

167 
	}
}

169 
__öô
 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

170 
mpc_öt§c
 *
mp_úq
)

172 
mp_úq
->
d°≠ic
 = 
m
->dstapic;

173 
mp_úq
->
ty≥
 = 
m
->type;

174 
mp_úq
->
úqty≥
 = 
m
->irqtype;

175 
mp_úq
->
úqÊag
 = 
m
->irqflag;

176 
mp_úq
->
§cbus
 = 
m
->srcbus;

177 
mp_úq
->
§cbusúq
 = 
m
->srcbusirq;

178 
mp_úq
->
d°úq
 = 
m
->dstirq;

179 
	}
}

181 
__öô
 
	$assign_to_mpc_öt§c
(
mpc_öt§c
 *
mp_úq
,

182 
mpc_öt§c
 *
m
)

184 
m
->
d°≠ic
 = 
mp_úq
->dstapic;

185 
m
->
ty≥
 = 
mp_úq
->type;

186 
m
->
úqty≥
 = 
mp_úq
->irqtype;

187 
m
->
úqÊag
 = 
mp_úq
->irqflag;

188 
m
->
§cbus
 = 
mp_úq
->srcbus;

189 
m
->
§cbusúq
 = 
mp_úq
->srcbusirq;

190 
m
->
d°úq
 = 
mp_úq
->dstirq;

191 
	}
}

193 
__öô
 
	$mp_úq_mpc_öt§c_cmp
(
mpc_öt§c
 *
mp_úq
,

194 
mpc_öt§c
 *
m
)

196 i‡(
mp_úq
->
d°≠ic
 !
m
->dstapic)

198 i‡(
mp_úq
->
ty≥
 !
m
->type)

200 i‡(
mp_úq
->
úqty≥
 !
m
->irqtype)

202 i‡(
mp_úq
->
úqÊag
 !
m
->irqflag)

204 i‡(
mp_úq
->
§cbus
 !
m
->srcbus)

206 i‡(
mp_úq
->
§cbusúq
 !
m
->srcbusirq)

208 i‡(
mp_úq
->
d°úq
 !
m
->dstirq)

212 
	}
}

214 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

216 
i
;

218 
	`¥öt_MP_öt§c_öfo
(
m
);

220 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

221 i‡(!
	`mp_úq_mpc_öt§c_cmp
(&
mp_úqs
[
i
], 
m
))

225 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

226 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

227 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

228 
	}
}

230 
ölöe
 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
Ë{
	}
}

231 
ölöe
 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
Ë{
	}
}

232 
ölöe
 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
Ë{
	}
}

236 
__öô
 
	$MP_löt§c_öfo
(
mpc_löt§c
 *
m
)

238 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Lint:Åype %d,Öol %d,Årig %d, bus %02x,"

240 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbusid
,

241 
m
->
§cbusúq
, m->
de°≠ic
, m->
de°≠i˛öt
);

242 
	}
}

248 
__öô
 
	$smp_check_mpc
(
mpc_èbÀ
 *
mpc
, *
€m
, *
°r
)

251 i‡(
	`memcmp
(
mpc
->
sig«tuª
, 
MPC_SIGNATURE
, 4)) {

252 
	`¥ötk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

253 
mpc
->
sig«tuª
[0], mpc->signature[1],

254 
mpc
->
sig«tuª
[2], mpc->signature[3]);

257 i‡(
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
)) {

258 
	`¥ötk
(
KERN_ERR
 "MPTABLE: checksumÉrror!\n");

261 i‡(
mpc
->
•ec
 != 0x01 && mpc->spec != 0x04) {

262 
	`¥ötk
(
KERN_ERR
 "MPTABLE: badÅable version (%d)!!\n",

263 
mpc
->
•ec
);

266 i‡(!
mpc
->
œpic
) {

267 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇullÜocal APICáddress!\n");

270 
	`mem˝y
(
€m
, 
mpc
->oem, 8);

271 
€m
[8] = 0;

272 
	`¥ötk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
€m
);

274 
	`mem˝y
(
°r
, 
mpc
->
¥odu˘id
, 12);

275 
°r
[12] = 0;

277 
	`¥ötk
(
KERN_INFO
 "MPTABLE: Produ˘ ID: %s\n", 
°r
);

279 
	`¥ötk
(
KERN_INFO
 "MPTABLE: APICát: 0x%X\n", 
mpc
->
œpic
);

282 
	}
}

284 
	$skù_íåy
(**
±r
, *
cou¡
, 
size
)

286 *
±r
 +
size
;

287 *
cou¡
 +
size
;

288 
	}
}

290 
__öô
 
	$smp_dump_m±abÀ
(
mpc_èbÀ
 *
mpc
, *
m±
)

292 
	`¥ötk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

293 "ty≥ %x\n", *
m±
);

294 
	`¥öt_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

295 1, 
mpc
, mpc->
Àngth
, 1);

296 
	}
}

298 
__öô
 
	$deÁu…_smp_ªad_mpc_€m
(
mpc_èbÀ
 *
mpc
Ë{ 
	}
}

300 
__öô
 
	$smp_ªad_mpc
(
mpc_èbÀ
 *
mpc
, 
óæy
)

302 
°r
[16];

303 
€m
[10];

305 
cou¡
 = (*
mpc
);

306 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

308 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

311 #ifde‡
CONFIG_X86_32


312 
	`gíîic_mps_€m_check
(
mpc
, 
€m
, 
°r
);

315 i‡(!
a˝i_œpic
)

316 
mp_œpic_addr
 = 
mpc
->
œpic
;

318 i‡(
óæy
)

321 i‡(
mpc
->
€m±r
)

322 
x86_öô
.
mµ¨£
.
	`smp_ªad_mpc_€m
(
mpc
);

327 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(0);

329 
cou¡
 < 
mpc
->
Àngth
) {

330 *
m±
) {

331 
MP_PROCESSOR
:

333 i‡(!
a˝i_œpic
)

334 
	`MP_¥o˚ss‹_öfo
((
mpc_˝u
 *)
m±
);

335 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

337 
MP_BUS
:

338 
	`MP_bus_öfo
((
mpc_bus
 *)
m±
);

339 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

341 
MP_IOAPIC
:

342 
	`MP_iﬂpic_öfo
((
mpc_iﬂpic
 *)
m±
);

343 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

345 
MP_INTSRC
:

346 
	`MP_öt§c_öfo
((
mpc_öt§c
 *)
m±
);

347 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

349 
MP_LINTSRC
:

350 
	`MP_löt§c_öfo
((
mpc_löt§c
 *)
m±
);

351 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

355 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

356 
cou¡
 = 
mpc
->
Àngth
;

359 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(1);

362 i‡(!
num_¥o˚ss‹s
)

363 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇoÖrocessorsÑegistered!\n");

364  
num_¥o˚ss‹s
;

365 
	}
}

367 #ifde‡
CONFIG_X86_IO_APIC


369 
__öô
 
	$ELCR_åiggî
(
úq
)

371 
p‹t
;

373 
p‹t
 = 0x4d0 + (
úq
 >> 3);

374  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

375 
	}
}

377 
__öô
 
	$c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
)

379 
mpc_öt§c
 
öt§c
;

380 
i
;

381 
ELCR_ÁŒback
 = 0;

383 
öt§c
.
ty≥
 = 
MP_INTSRC
;

384 
öt§c
.
úqÊag
 = 0;

385 
öt§c
.
§cbus
 = 0;

386 
öt§c
.
d°≠ic
 = 
mp_iﬂpics
[0].
≠icid
;

388 
öt§c
.
úqty≥
 = 
mp_INT
;

398 i‡(
mpc_deÁu…_ty≥
 == 5) {

399 
	`¥ötk
(
KERN_INFO
 "ISA/PCI busÅype withÇo IRQ information... "

402 i‡(
	`ELCR_åiggî
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

403 
	`ELCR_åiggî
(13))

404 
	`¥ötk
(
KERN_ERR
 "ELCR contains invalid data... "

407 
	`¥ötk
(
KERN_INFO


409 
ELCR_ÁŒback
 = 1;

413 
i
 = 0; i < 16; i++) {

414 
mpc_deÁu…_ty≥
) {

416 i‡(
i
 == 0 || i == 13)

420 i‡(
i
 == 2)

424 i‡(
ELCR_ÁŒback
) {

430 i‡(
	`ELCR_åiggî
(
i
))

431 
öt§c
.
úqÊag
 = 13;

433 
öt§c
.
úqÊag
 = 0;

436 
öt§c
.
§cbusúq
 = 
i
;

437 
öt§c
.
d°úq
 = 
i
 ? i : 2;

438 
	`MP_öt§c_öfo
(&
öt§c
);

441 
öt§c
.
úqty≥
 = 
mp_ExtINT
;

442 
öt§c
.
§cbusúq
 = 0;

443 
öt§c
.
d°úq
 = 0;

444 
	`MP_öt§c_öfo
(&
öt§c
);

445 
	}
}

448 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
)

450 
mpc_iﬂpic
 
iﬂpic
;

451 
mpc_bus
 
bus
;

453 
bus
.
ty≥
 = 
MP_BUS
;

454 
bus
.
busid
 = 0;

455 
mpc_deÁu…_ty≥
) {

457 
	`¥ötk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

458 
mpc_deÁu…_ty≥
);

462 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

467 
	`mem˝y
(
bus
.
bu°y≥
, "EISA ", 6);

471 
	`mem˝y
(
bus
.
bu°y≥
, "MCA ", 6);

473 
	`MP_bus_öfo
(&
bus
);

474 i‡(
mpc_deÁu…_ty≥
 > 4) {

475 
bus
.
busid
 = 1;

476 
	`mem˝y
(
bus
.
bu°y≥
, "PCI ", 6);

477 
	`MP_bus_öfo
(&
bus
);

480 
iﬂpic
.
ty≥
 = 
MP_IOAPIC
;

481 
iﬂpic
.
≠icid
 = 2;

482 
iﬂpic
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

483 
iﬂpic
.
Êags
 = 
MPC_APIC_USABLE
;

484 
iﬂpic
.
≠iˇddr
 = 
IO_APIC_DEFAULT_PHYS_BASE
;

485 
	`MP_iﬂpic_öfo
(&
iﬂpic
);

490 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
);

491 
	}
}

493 
ölöe
 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
Ë{ 
	}
}

496 
ölöe
 
__öô
 
	$c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpc_deÁu…_ty≥
)

498 
mpc_˝u
 
¥o˚ss‹
;

499 
mpc_löt§c
 
löt§c
;

500 
löây≥s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

501 
i
;

506 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

511 
¥o˚ss‹
.
ty≥
 = 
MP_PROCESSOR
;

513 
¥o˚ss‹
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

514 
¥o˚ss‹
.
˝uÊag
 = 
CPU_ENABLED
;

515 
¥o˚ss‹
.
˝u„©uª
 = (
boŸ_˝u_d©a
.
x86
 << 8) |

516 (
boŸ_˝u_d©a
.
x86_modñ
 << 4Ë| boŸ_˝u_d©a.
x86_mask
;

517 
¥o˚ss‹
.
„©uªÊag
 = 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[0];

518 
¥o˚ss‹
.
ª£rved
[0] = 0;

519 
¥o˚ss‹
.
ª£rved
[1] = 0;

520 
i
 = 0; i < 2; i++) {

521 
¥o˚ss‹
.
≠icid
 = 
i
;

522 
	`MP_¥o˚ss‹_öfo
(&
¥o˚ss‹
);

525 
	`c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
);

527 
löt§c
.
ty≥
 = 
MP_LINTSRC
;

528 
löt§c
.
úqÊag
 = 0;

529 
löt§c
.
§cbusid
 = 0;

530 
löt§c
.
§cbusúq
 = 0;

531 
löt§c
.
de°≠ic
 = 
MP_APIC_ALL
;

532 
i
 = 0; i < 2; i++) {

533 
löt§c
.
úqty≥
 = 
löây≥s
[
i
];

534 
löt§c
.
de°≠i˛öt
 = 
i
;

535 
	`MP_löt§c_öfo
(&
löt§c
);

537 
	}
}

539 
mpf_öãl
 *
	gmpf_found
;

541 
__öô
 
	$gë_mpc_size
(
phy•å
)

543 
mpc_èbÀ
 *
mpc
;

544 
size
;

546 
mpc
 = 
	`óæy_i‹em≠
(
phy•å
, 
PAGE_SIZE
);

547 
size
 = 
mpc
->
Àngth
;

548 
	`óæy_iounm≠
(
mpc
, 
PAGE_SIZE
);

549 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy•å
,Öhy•å + 
size
);

551  
size
;

552 
	}
}

554 
__öô
 
	$check_phy•å
(
mpf_öãl
 *
mpf
, 
óæy
)

556 
mpc_èbÀ
 *
mpc
;

557 
size
;

559 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

560 
mpc
 = 
	`óæy_i‹em≠
(
mpf
->
phy•å
, 
size
);

565 i‡(!
	`smp_ªad_mpc
(
mpc
, 
óæy
)) {

566 #ifde‡
CONFIG_X86_LOCAL_APIC


567 
smp_found_c⁄fig
 = 0;

569 
	`¥ötk
(
KERN_ERR
 "BIOS bug, MPÅableÉrrors detected!...\n"

571 
	`óæy_iounm≠
(
mpc
, 
size
);

574 
	`óæy_iounm≠
(
mpc
, 
size
);

576 i‡(
óæy
)

579 #ifde‡
CONFIG_X86_IO_APIC


585 i‡(!
mp_úq_íåõs
) {

586 
mpc_bus
 
bus
;

588 
	`¥ötk
(
KERN_ERR
 "BIOS bug,ÇoÉxplicit IRQÉntries, "

591 
bus
.
ty≥
 = 
MP_BUS
;

592 
bus
.
busid
 = 0;

593 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

594 
	`MP_bus_öfo
(&
bus
);

596 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(0);

601 
	}
}

606 
__öô
 
	$deÁu…_gë_smp_c⁄fig
(
óæy
)

608 
mpf_öãl
 *
mpf
 = 
mpf_found
;

610 i‡(!
mpf
)

613 i‡(
a˝i_œpic
 && 
óæy
)

620 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

623 
	`¥ötk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

624 
mpf
->
•ecifiˇti⁄
);

625 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_X86_32
)

626 i‡(
mpf
->
„©uª2
 & (1 << 7)) {

627 
	`¥ötk
(
KERN_INFO
 " IMCRánd PIC compatibility mode.\n");

628 
pic_mode
 = 1;

630 
	`¥ötk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

631 
pic_mode
 = 0;

637 i‡(
mpf
->
„©uª1
 != 0) {

638 i‡(
óæy
) {

642 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

646 
	`¥ötk
(
KERN_INFO
 "Default MP configuration #%d\n",

647 
mpf
->
„©uª1
);

648 
	`c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpf
->
„©uª1
);

650 } i‡(
mpf
->
phy•å
) {

651 i‡(
	`check_phy•å
(
mpf
, 
óæy
))

654 
	`BUG
();

656 i‡(!
óæy
)

657 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹s: %d\n", 
num_¥o˚ss‹s
);

661 
	}
}

663 
__öô
 
	$smp_ª£rve_mem‹y
(
mpf_öãl
 *
mpf
)

665 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

667 
	`ª£rve_óæy_ovîœp_ok
(
mpf
->
phy•å
, mpf->phy•å+
size
, "MP-table mpc");

668 
	}
}

670 
__öô
 
	$smp_sˇn_c⁄fig
(
ba£
, 
Àngth
)

672 *
bp
 = 
	`phys_to_vút
(
ba£
);

673 
mpf_öãl
 *
mpf
;

674 
mem
;

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

677 
bp
, 
Àngth
);

678 
	`BUILD_BUG_ON
((*
mpf
) != 16);

680 
Àngth
 > 0) {

681 
mpf
 = (
mpf_öãl
 *)
bp
;

682 i‡((*
bp
 =
SMP_MAGIC_IDENT
) &&

683 (
mpf
->
Àngth
 == 1) &&

684 !
	`mpf_checksum
((*)
bp
, 16) &&

685 ((
mpf
->
•ecifiˇti⁄
 == 1)

686 || (
mpf
->
•ecifiˇti⁄
 == 4))) {

687 #ifde‡
CONFIG_X86_LOCAL_APIC


688 
smp_found_c⁄fig
 = 1;

690 
mpf_found
 = 
mpf
;

692 
	`¥ötk
(
KERN_INFO
 "found SMP MP-tableát [%p] %llx\n",

693 
mpf
, (
u64
)
	`vút_to_phys
(mpf));

695 
mem
 = 
	`vút_to_phys
(
mpf
);

696 
	`ª£rve_óæy_ovîœp_ok
(
mem
, mem + (*
mpf
), "MP-table mpf");

697 i‡(
mpf
->
phy•å
)

698 
	`smp_ª£rve_mem‹y
(
mpf
);

702 
bp
 += 4;

703 
Àngth
 -= 16;

706 
	}
}

708 
__öô
 
	$deÁu…_föd_smp_c⁄fig
()

710 
addªss
;

720 i‡(
	`smp_sˇn_c⁄fig
(0x0, 0x400) ||

721 
	`smp_sˇn_c⁄fig
(639 * 0x400, 0x400) ||

722 
	`smp_sˇn_c⁄fig
(0xF0000, 0x10000))

741 
addªss
 = 
	`gë_bios_ebda
();

742 i‡(
addªss
)

743 
	`smp_sˇn_c⁄fig
(
addªss
, 0x400);

744 
	}
}

746 #ifde‡
CONFIG_X86_IO_APIC


747 
u8
 
__öôd©a
 
	gúq_u£d
[
MAX_IRQ_SOURCES
];

749 
__öô
 
	$gë_MP_öt§c_ödex
(
mpc_öt§c
 *
m
)

751 
i
;

753 i‡(
m
->
úqty≥
 !
mp_INT
)

756 i‡(
m
->
úqÊag
 != 0x0f)

761 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

762 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

765 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

768 i‡(
mp_úqs
[
i
].
§cbus
 !
m
->srcbus)

770 i‡(
mp_úqs
[
i
].
§cbusúq
 !
m
->srcbusirq)

772 i‡(
úq_u£d
[
i
]) {

776 
úq_u£d
[
i
] = 1;

777  
i
;

782 
	}
}

784 
	#SPARE_SLOT_NUM
 20

	)

786 
mpc_öt§c
 
__öôd©a
 *
	gm_•¨e
[
SPARE_SLOT_NUM
];

788 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
)

790 
i
;

792 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "OLD ");

793 
	`¥öt_MP_öt§c_öfo
(
m
);

795 
i
 = 
	`gë_MP_öt§c_ödex
(
m
);

796 i‡(
i
 > 0) {

797 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

798 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "NEW ");

799 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

802 i‡(!
i
) {

806 i‡(*
ƒ_m_•¨e
 < 
SPARE_SLOT_NUM
) {

811 
m_•¨e
[*
ƒ_m_•¨e
] = 
m
;

812 *
ƒ_m_•¨e
 += 1;

814 
	}
}

817 
ölöe
 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
Ë{
	}
}

821 
	$check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
)

823 
ªt
 = 0;

825 i‡(!
mpc_√w_phys
 || 
cou¡
 <
mpc_√w_Àngth
) {

826 
	`WARN
(1, "upd©e_m±abÀ: Nÿ•¨ê¶Ÿ†÷ígth: %x)\n", 
cou¡
);

830  
ªt
;

831 
	}
}

833 
__öô
 
	$ª∂a˚_öt§c_Æl
(
mpc_èbÀ
 *
mpc
,

834 
mpc_√w_phys
,

835 
mpc_√w_Àngth
)

837 #ifde‡
CONFIG_X86_IO_APIC


838 
i
;

840 
cou¡
 = (*
mpc
);

841 
ƒ_m_•¨e
 = 0;

842 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

844 
	`¥ötk
(
KERN_INFO
 "mpc_Àngth %x\n", 
mpc
->
Àngth
);

845 
cou¡
 < 
mpc
->
Àngth
) {

846 *
m±
) {

847 
MP_PROCESSOR
:

848 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

850 
MP_BUS
:

851 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

853 
MP_IOAPIC
:

854 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

856 
MP_INTSRC
:

857 
	`check_úq_§c
((
mpc_öt§c
 *)
m±
, &
ƒ_m_•¨e
);

858 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

860 
MP_LINTSRC
:

861 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

865 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

866 
out
;

870 #ifde‡
CONFIG_X86_IO_APIC


871 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

872 i‡(
úq_u£d
[
i
])

875 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

878 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

881 i‡(
ƒ_m_•¨e
 > 0) {

882 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "*NEW* found\n");

883 
ƒ_m_•¨e
--;

884 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m_•¨e
[
ƒ_m_•¨e
]);

885 
m_•¨e
[
ƒ_m_•¨e
] = 
NULL
;

887 
mpc_öt§c
 *
m
 = (mpc_öt§¯*)
m±
;

888 
cou¡
 +(
mpc_öt§c
);

889 i‡(
	`check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
) < 0)

890 
out
;

891 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

892 
mpc
->
Àngth
 = 
cou¡
;

893 
m±
 +(
mpc_öt§c
);

895 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

898 
out
:

900 
mpc
->
checksum
 = 0;

901 
mpc
->
checksum
 -
	`mpf_checksum
((*)mpc, mpc->
Àngth
);

904 
	}
}

906 
	gíabÀ_upd©e_m±abÀ
;

908 
__öô
 
	$upd©e_m±abÀ_£tup
(*
°r
)

910 
íabÀ_upd©e_m±abÀ
 = 1;

911 #ifde‡
CONFIG_PCI


912 
pci_rouãúq
 = 1;

915 
	}
}

916 
óæy_∑øm
("upd©e_m±abÀ", 
upd©e_m±abÀ_£tup
);

918 
__öôd©a
 
	gmpc_√w_phys
;

919 
mpc_√w_Àngth
 
	g__öôd©a
 = 4096;

922 
__öôd©a
 
	gÆloc_m±abÀ
;

923 
__öô
 
	$∑r£_Æloc_m±abÀ_›t
(*
p
)

925 
íabÀ_upd©e_m±abÀ
 = 1;

926 #ifde‡
CONFIG_PCI


927 
pci_rouãúq
 = 1;

929 
Æloc_m±abÀ
 = 1;

930 i‡(!
p
)

932 
mpc_√w_Àngth
 = 
	`mem∑r£
(
p
, &p);

934 
	}
}

935 
óæy_∑øm
("Æloc_m±abÀ", 
∑r£_Æloc_m±abÀ_›t
);

937 
__öô
 
	$óæy_ª£rve_e820_mpc_√w
()

939 i‡(
íabÀ_upd©e_m±abÀ
 && 
Æloc_m±abÀ
) {

940 
u64
 
°¨â
 = 0;

941 
mpc_√w_phys
 = 
	`óæy_ª£rve_e820
(
°¨â
, 
mpc_√w_Àngth
, 4);

943 
	}
}

945 
__öô
 
	$upd©e_mp_èbÀ
()

947 
°r
[16];

948 
€m
[10];

949 
mpf_öãl
 *
mpf
;

950 
mpc_èbÀ
 *
mpc
, *
mpc_√w
;

952 i‡(!
íabÀ_upd©e_m±abÀ
)

955 
mpf
 = 
mpf_found
;

956 i‡(!
mpf
)

962 i‡(
mpf
->
„©uª1
 != 0)

965 i‡(!
mpf
->
phy•å
)

968 
mpc
 = 
	`phys_to_vút
(
mpf
->
phy•å
);

970 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

973 
	`¥ötk
(
KERN_INFO
 "mpf: %Œx\n", (
u64
)
	`vút_to_phys
(
mpf
));

974 
	`¥ötk
(
KERN_INFO
 "phy•å: %x\n", 
mpf
->
phy•å
);

976 i‡(
mpc_√w_phys
 && 
mpc
->
Àngth
 > 
mpc_√w_Àngth
) {

977 
mpc_√w_phys
 = 0;

978 
	`¥ötk
(
KERN_INFO
 "mpc_new_length is %ld,Ölease useálloc_mptable=8k\n",

979 
mpc_√w_Àngth
);

982 i‡(!
mpc_√w_phys
) {

983 
ﬁd
, 
√w
;

985 
mpc
->
checksum
 = 0;

986 
ﬁd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

987 
mpc
->
checksum
 = 0xff;

988 
√w
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

989 i‡(
ﬁd
 =
√w
) {

990 
	`¥ötk
(
KERN_INFO
 "mpc isÑeadonly,ÖleaseÅryálloc_mptable instead\n");

993 
	`¥ötk
(
KERN_INFO
 "use in-positonÑeplacing\n");

995 
mpf
->
phy•å
 = 
mpc_√w_phys
;

996 
mpc_√w
 = 
	`phys_to_vút
(
mpc_√w_phys
);

997 
	`mem˝y
(
mpc_√w
, 
mpc
, mpc->
Àngth
);

998 
mpc
 = 
mpc_√w
;

1000 i‡(
mpc_√w_phys
 - 
mpf
->
phy•å
) {

1001 
mpf_öãl
 *
mpf_√w
;

1003 
	`¥ötk
(
KERN_INFO
 "mpfÇew: %x\n", 0x400 - 16);

1004 
mpf_√w
 = 
	`phys_to_vút
(0x400 - 16);

1005 
	`mem˝y
(
mpf_√w
, 
mpf
, 16);

1006 
mpf
 = 
mpf_√w
;

1007 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1009 
mpf
->
checksum
 = 0;

1010 
mpf
->
checksum
 -
	`mpf_checksum
((*)mpf, 16);

1011 
	`¥ötk
(
KERN_INFO
 "phy•åÇew: %x\n", 
mpf
->
phy•å
);

1020 
	`ª∂a˚_öt§c_Æl
(
mpc
, 
mpc_√w_phys
, 
mpc_√w_Àngth
);

1023 
	}
}

1025 
œã_öôˇŒ
(
upd©e_mp_èbÀ
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

25 
	~<löux/moduÀ.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/î∫o.h
>

29 
	~<löux/f˙é.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/smp_lock.h
>

34 
	~<löux/maj‹.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/devi˚.h
>

37 
	~<löux/˝u.h
>

38 
	~<löux/nŸifõr.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/gÂ.h
>

42 
	~<asm/¥o˚ss‹.h
>

43 
	~<asm/m§.h
>

44 
	~<asm/sy°em.h
>

46 
˛ass
 *
	gm§_˛ass
;

48 
loff_t
 
	$m§_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

50 
loff_t
 
ªt
;

51 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

53 
	`muãx_lock
(&
öode
->
i_muãx
);

54 
‹ig
) {

56 
fûe
->
f_pos
 = 
off£t
;

57 
ªt
 = 
fûe
->
f_pos
;

60 
fûe
->
f_pos
 +
off£t
;

61 
ªt
 = 
fûe
->
f_pos
;

64 
ªt
 = -
EINVAL
;

66 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

67  
ªt
;

68 
	}
}

70 
ssize_t
 
	$m§_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

71 
size_t
 
cou¡
, 
loff_t
 *
µos
)

73 
u32
 
__u£r
 *
tmp
 = (u32 __u£∏*Ë
buf
;

74 
u32
 
d©a
[2];

75 
u32
 
ªg
 = *
µos
;

76 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

77 
îr
 = 0;

78 
ssize_t
 
byãs
 = 0;

80 i‡(
cou¡
 % 8)

81  -
EINVAL
;

83 ; 
cou¡
; count -= 8) {

84 
îr
 = 
	`rdm§_ß„_⁄_˝u
(
˝u
, 
ªg
, &
d©a
[0], &data[1]);

85 i‡(
îr
)

87 i‡(
	`c›y_to_u£r
(
tmp
, &
d©a
, 8)) {

88 
îr
 = -
EFAULT
;

91 
tmp
 += 2;

92 
byãs
 += 8;

95  
byãs
 ? byã†: 
îr
;

96 
	}
}

98 
ssize_t
 
	$m§_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

99 
size_t
 
cou¡
, 
loff_t
 *
µos
)

101 c⁄° 
u32
 
__u£r
 *
tmp
 = (c⁄° u32 __u£∏*)
buf
;

102 
u32
 
d©a
[2];

103 
u32
 
ªg
 = *
µos
;

104 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

105 
îr
 = 0;

106 
ssize_t
 
byãs
 = 0;

108 i‡(
cou¡
 % 8)

109  -
EINVAL
;

111 ; 
cou¡
; count -= 8) {

112 i‡(
	`c›y_‰om_u£r
(&
d©a
, 
tmp
, 8)) {

113 
îr
 = -
EFAULT
;

116 
îr
 = 
	`wrm§_ß„_⁄_˝u
(
˝u
, 
ªg
, 
d©a
[0], data[1]);

117 i‡(
îr
)

119 
tmp
 += 2;

120 
byãs
 += 8;

123  
byãs
 ? byã†: 
îr
;

124 
	}
}

126 
	$m§_io˘l
(
fûe
 *fûe, 
ioc
, 
¨g
)

128 
u32
 
__u£r
 *
uªgs
 = (u32 __u£∏*)
¨g
;

129 
u32
 
ªgs
[8];

130 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

131 
îr
;

133 
ioc
) {

134 
X86_IOC_RDMSR_REGS
:

135 i‡(!(
fûe
->
f_mode
 & 
FMODE_READ
)) {

136 
îr
 = -
EBADF
;

139 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

140 
îr
 = -
EFAULT
;

143 
îr
 = 
	`rdm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

144 i‡(
îr
)

146 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

147 
îr
 = -
EFAULT
;

150 
X86_IOC_WRMSR_REGS
:

151 i‡(!(
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

152 
îr
 = -
EBADF
;

155 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

156 
îr
 = -
EFAULT
;

159 
îr
 = 
	`wrm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

160 i‡(
îr
)

162 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

163 
îr
 = -
EFAULT
;

167 
îr
 = -
ENOTTY
;

171  
îr
;

172 
	}
}

174 
	$m§_›í
(
öode
 *öode, 
fûe
 *file)

176 
˝u
;

177 
˝uöfo_x86
 *
c
;

179 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

180 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

181  -
ENXIO
;

183 
c
 = &
	`˝u_d©a
(
˝u
);

184 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MSR
))

185  -
EIO
;

188 
	}
}

193 c⁄° 
fûe_›î©i⁄s
 
	gm§_f›s
 = {

194 .
ow√r
 = 
THIS_MODULE
,

195 .
	gŒ£ek
 = 
m§_£ek
,

196 .
	gªad
 = 
m§_ªad
,

197 .
	gwrôe
 = 
m§_wrôe
,

198 .
	g›í
 = 
m§_›í
,

199 .
	gu∆ocked_io˘l
 = 
m§_io˘l
,

200 .
	gcom∑t_io˘l
 = 
m§_io˘l
,

203 
__˝uöô
 
	$m§_devi˚_¸óã
(
˝u
)

205 
devi˚
 *
dev
;

207 
dev
 = 
	`devi˚_¸óã
(
m§_˛ass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
), NULL,

208 "m§%d", 
˝u
);

209  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

210 
	}
}

212 
	$m§_devi˚_de°roy
(
˝u
)

214 
	`devi˚_de°roy
(
m§_˛ass
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
));

215 
	}
}

217 
__˝uöô
 
	$m§_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

218 
a˘i⁄
, *
h˝u
)

220 
˝u
 = ()
h˝u
;

221 
îr
 = 0;

223 
a˘i⁄
) {

224 
CPU_UP_PREPARE
:

225 
îr
 = 
	`m§_devi˚_¸óã
(
˝u
);

227 
CPU_UP_CANCELED
:

228 
CPU_UP_CANCELED_FROZEN
:

229 
CPU_DEAD
:

230 
	`m§_devi˚_de°roy
(
˝u
);

233  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

234 
	}
}

236 
nŸifõr_block
 
__ªfd©a
 
	gm§_˛ass_˝u_nŸifõr
 = {

237 .
nŸifõr_ˇŒ
 = 
m§_˛ass_˝u_ˇŒback
,

240 *
	$m§_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

242  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/m§", 
	`MINOR
(
dev
->
devt
));

243 
	}
}

245 
__öô
 
	$m§_öô
()

247 
i
, 
îr
 = 0;

248 
i
 = 0;

250 i‡(
	`__ªgi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "˝u/m§", &
m§_f›s
)) {

251 
	`¥ötk
(
KERN_ERR
 "msr: unableÅo get major %d for msr\n",

252 
MSR_MAJOR
);

253 
îr
 = -
EBUSY
;

254 
out
;

256 
m§_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "msr");

257 i‡(
	`IS_ERR
(
m§_˛ass
)) {

258 
îr
 = 
	`PTR_ERR
(
m§_˛ass
);

259 
out_chrdev
;

261 
m§_˛ass
->
devnode
 = 
m§_devnode
;

262 
	`f‹_óch_⁄löe_˝u
(
i
) {

263 
îr
 = 
	`m§_devi˚_¸óã
(
i
);

264 i‡(
îr
 != 0)

265 
out_˛ass
;

267 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

269 
îr
 = 0;

270 
out
;

272 
out_˛ass
:

273 
i
 = 0;

274 
	`f‹_óch_⁄löe_˝u
(
i
)

275 
	`m§_devi˚_de°roy
(
i
);

276 
	`˛ass_de°roy
(
m§_˛ass
);

277 
out_chrdev
:

278 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

279 
out
:

280  
îr
;

281 
	}
}

283 
__exô
 
	$m§_exô
()

285 
˝u
 = 0;

286 
	`f‹_óch_⁄löe_˝u
(
˝u
)

287 
	`m§_devi˚_de°roy
(
˝u
);

288 
	`˛ass_de°roy
(
m§_˛ass
);

289 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

290 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

291 
	}
}

293 
moduÀ_öô
(
m§_öô
);

294 
	$moduÀ_exô
(
m§_exô
)

296 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

297 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

298 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<löux/kî√l.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/•ölock.h
>

31 
	~<löux/°rög.h
>

32 
	~<löux/¸ash_dump.h
>

33 
	~<löux/dma-m≠pög.h
>

34 
	~<löux/bôm≠.h
>

35 
	~<löux/pci_ids.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/sˇâîli°.h
>

39 
	~<löux/iommu-hñ≥r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ˇlg¨y.h
>

43 
	~<asm/t˚.h
>

44 
	~<asm/pci-dúe˘.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

49 
	~<asm/x86_öô.h
>

51 #ifde‡
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


52 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 1;

54 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 0;

57 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

58 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

61 
	#CALGARY_CONFIG_REG
 0x0108

	)

62 
	#PHB_CSR_OFFSET
 0x0110

	)

63 
	#PHB_PLSSR_OFFSET
 0x0120

	)

64 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

65 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

66 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

67 
	#PHB_MEM_1_LOW
 0x0190

	)

68 
	#PHB_MEM_1_HIGH
 0x01A0

	)

69 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

70 
	#PHB_MEM_1_SIZE
 0x01C0

	)

71 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

72 
	#PHB_AER_OFFSET
 0x0200

	)

73 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

74 
	#PHB_CONFIG_0_LOW
 0x0230

	)

75 
	#PHB_CONFIG_0_END
 0x0240

	)

76 
	#PHB_MEM_2_LOW
 0x02B0

	)

77 
	#PHB_MEM_2_HIGH
 0x02C0

	)

78 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

79 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

80 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

83 
	#PHB_SAVIOR_L2
 0x0DB0

	)

84 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

85 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

86 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

89 
	#PHB_TCE_ENABLE
 0x20000000

	)

90 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

91 
	#PHB_DAC_DISABLE
 0x01000000

	)

92 
	#PHB_MEM2_ENABLE
 0x00400000

	)

93 
	#PHB_MCSR_ENABLE
 0x00100000

	)

95 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

96 
	#TAR_VALID
 0x0000000000000008UL

	)

98 
	#CSR_AGENT_MASK
 0xf„0ffff

	)

100 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

102 
	#PMR_SOFTSTOP
 0x80000000

	)

103 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

104 
	#PMR_HARDSTOP
 0x20000000

	)

106 
	#MAX_NUM_OF_PHBS
 8

	)

107 
	#MAX_NUM_CHASSIS
 8

	)

109 
	#MAX_PHB_BUS_NUM
 (
MAX_NUM_OF_PHBS
 * 
MAX_NUM_CHASSIS
 * 2)

	)

110 
	#PHBS_PER_CALGARY
 4

	)

113 c⁄° 
	gèr_off£ts
[] = {

120 c⁄° 
	g•lô_queue_off£ts
[] = {

127 c⁄° 
	gphb_off£ts
[] = {

136 c⁄° 
	gphb_debug_off£ts
[] = {

148 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

150 
	#EMERGENCY_PAGES
 32

	)

152 
	g•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

153 
å™¶©e_em±y_¶Ÿs
 
	g__ªad_mo°ly
 = 0;

154 
ˇlg¨y_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

156 
rio_èbÀ_hdr
 *rio_èbÀ_hd∏
	g__öôd©a
;

157 
sˇl_dëaû
 *
	gsˇl_devs
[
MAX_NUMNODES
] 
	g__öôd©a
;

158 
rio_dëaû
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__öôd©a
;

160 
	sˇlg¨y_bus_öfo
 {

161 *
	mt˚_•a˚
;

162 
	må™¶©i⁄_dißbÀd
;

163 sig√d 
	mphbid
;

164 
__iomem
 *
	mbb¨
;

167 
ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

168 
ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

169 
ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

170 
ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

171 
ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

172 
ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

173 
ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
);

174 
gë_t˚_•a˚_‰om_èr
();

176 
ˇl_chù£t_›s
 
	gˇlg¨y_chù_›s
 = {

177 .
h™dÀ_quúks
 = 
ˇlg¨y_h™dÀ_quúks
,

178 .
	gt˚_ˇche_bœ°
 = 
ˇlg¨y_t˚_ˇche_bœ°
,

179 .
	gdump_îr‹_ªgs
 = 
ˇlg¨y_dump_îr‹_ªgs


182 
ˇl_chù£t_›s
 
	gˇlioc2_chù_›s
 = {

183 .
h™dÀ_quúks
 = 
ˇlioc2_h™dÀ_quúks
,

184 .
	gt˚_ˇche_bœ°
 = 
ˇlioc2_t˚_ˇche_bœ°
,

185 .
	gdump_îr‹_ªgs
 = 
ˇlioc2_dump_îr‹_ªgs


188 
ˇlg¨y_bus_öfo
 
	gbus_öfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

190 
ölöe
 
	$å™¶©i⁄_íabÀd
(
iommu_èbÀ
 *
tbl
)

193  (
tbl
 !
NULL
);

194 
	}
}

196 
	$iommu_ønge_ª£rve
(
iommu_èbÀ
 *
tbl
,

197 
°¨t_addr
, 
≈ages
)

199 
ödex
;

200 
íd
;

201 
Êags
;

203 
ödex
 = 
°¨t_addr
 >> 
PAGE_SHIFT
;

206 i‡(
ödex
 >
tbl
->
ô_size
)

209 
íd
 = 
ödex
 + 
≈ages
;

210 i‡(
íd
 > 
tbl
->
ô_size
)

211 
íd
 = 
tbl
->
ô_size
;

213 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

215 
	`bôm≠_£t
(
tbl
->
ô_m≠
, 
ödex
, 
≈ages
);

217 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

218 
	}
}

220 
	$iommu_ønge_Æloc
(
devi˚
 *
dev
,

221 
iommu_èbÀ
 *
tbl
,

222 
≈ages
)

224 
Êags
;

225 
off£t
;

226 
bound¨y_size
;

228 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

229 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

231 
	`BUG_ON
(
≈ages
 == 0);

233 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

235 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
,Åbl->
ô_höt
,

236 
≈ages
, 0, 
bound¨y_size
, 0);

237 i‡(
off£t
 == ~0UL) {

238 
tbl
->
chù_›s
->
	`t˚_ˇche_bœ°
(tbl);

240 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
, 0,

241 
≈ages
, 0, 
bound¨y_size
, 0);

242 i‡(
off£t
 == ~0UL) {

243 
	`¥ötk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

244 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

245 i‡(
∑nic_⁄_ovîÊow
)

246 
	`∑nic
("Calgary: fixÅheállocator.\n");

248  
DMA_ERROR_CODE
;

252 
tbl
->
ô_höt
 = 
off£t
 + 
≈ages
;

253 
	`BUG_ON
(
tbl
->
ô_höt
 >Åbl->
ô_size
);

255 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

257  
off£t
;

258 
	}
}

260 
dma_addr_t
 
	$iommu_Æloc
(
devi˚
 *
dev
, 
iommu_èbÀ
 *
tbl
,

261 *
vaddr
, 
≈ages
, 
dúe˘i⁄
)

263 
íåy
;

264 
dma_addr_t
 
ªt
;

266 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

268 i‡(
	`u∆ikñy
(
íåy
 =
DMA_ERROR_CODE
)) {

269 
	`¥ötk
(
KERN_WARNING
 "Calgary: failedÅoállocate %uÖages in "

270 "iommu %p\n", 
≈ages
, 
tbl
);

271  
DMA_ERROR_CODE
;

275 
ªt
 = (
íåy
 << 
PAGE_SHIFT
Ë| (()
vaddr
 & ~
PAGE_MASK
);

278 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, ()
vaddr
 & 
PAGE_MASK
,

279 
dúe˘i⁄
);

280  
ªt
;

281 
	}
}

283 
	$iommu_‰ì
(
iommu_èbÀ
 *
tbl
, 
dma_addr_t
 
dma_addr
,

284 
≈ages
)

286 
íåy
;

287 
badíd
;

288 
Êags
;

291 
badíd
 = 
DMA_ERROR_CODE
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

292 i‡(
	`u∆ikñy
((
dma_addr
 >
DMA_ERROR_CODE
Ë&& (dma_add∏< 
badíd
))) {

293 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverÅried unmapping bad DMA "

294 "addªs†0x%Lx\n", 
dma_addr
);

298 
íåy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

300 
	`BUG_ON
(
íåy
 + 
≈ages
 > 
tbl
->
ô_size
);

302 
	`t˚_‰ì
(
tbl
, 
íåy
, 
≈ages
);

304 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

306 
	`bôm≠_˛ór
(
tbl
->
ô_m≠
, 
íåy
, 
≈ages
);

308 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

309 
	}
}

311 
ölöe
 
iommu_èbÀ
 *
	$föd_iommu_èbÀ
(
devi˚
 *
dev
)

313 
pci_dev
 *
pdev
;

314 
pci_bus
 *
pbus
;

315 
iommu_èbÀ
 *
tbl
;

317 
pdev
 = 
	`to_pci_dev
(
dev
);

320 
pbus
 = 
pdev
->
bus
;

322 
tbl
 = 
	`pci_iommu
(
pbus
);

323 i‡(
tbl
 &&Åbl->
ô_bu¢o
 =
pbus
->
numbî
)

325 
tbl
 = 
NULL
;

326 
pbus
 =Öbus->
∑ª¡
;

327 } 
pbus
);

329 
	`BUG_ON
(
tbl
 && (tbl->
ô_bu¢o
 !
pbus
->
numbî
));

331  
tbl
;

332 
	}
}

334 
	$ˇlg¨y_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

335 
√Àms
,
dma_d©a_dúe˘i⁄
 
dú
,

336 
dma_©ås
 *
©ås
)

338 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

339 
sˇâîli°
 *
s
;

340 
i
;

342 i‡(!
	`å™¶©i⁄_íabÀd
(
tbl
))

345 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

346 
≈ages
;

347 
dma_addr_t
 
dma
 = 
s
->
dma_addªss
;

348 
dmÆí
 = 
s
->
dma_Àngth
;

350 i‡(
dmÆí
 == 0)

353 
≈ages
 = 
	`iommu_num_∑ges
(
dma
, 
dmÆí
, 
PAGE_SIZE
);

354 
	`iommu_‰ì
(
tbl
, 
dma
, 
≈ages
);

356 
	}
}

358 
	$ˇlg¨y_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

359 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

360 
dma_©ås
 *
©ås
)

362 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

363 
sˇâîli°
 *
s
;

364 
vaddr
;

365 
≈ages
;

366 
íåy
;

367 
i
;

369 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

370 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

372 
vaddr
 = (Ë
	`sg_vút
(
s
);

373 
≈ages
 = 
	`iommu_num_∑ges
(
vaddr
, 
s
->
Àngth
, 
PAGE_SIZE
);

375 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

376 i‡(
íåy
 =
DMA_ERROR_CODE
) {

378 
s
->
dma_Àngth
 = 0;

379 
îr‹
;

382 
s
->
dma_addªss
 = (
íåy
 << 
PAGE_SHIFT
Ë| s->
off£t
;

385 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, 
vaddr
 & 
PAGE_MASK
, 
dú
);

387 
s
->
dma_Àngth
 = s->
Àngth
;

390  
√Àms
;

391 
îr‹
:

392 
	`ˇlg¨y_unm≠_sg
(
dev
, 
sg
, 
√Àms
, 
dú
, 
NULL
);

393 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

394 
sg
->
dma_addªss
 = 
DMA_ERROR_CODE
;

395 
sg
->
dma_Àngth
 = 0;

398 
	}
}

400 
dma_addr_t
 
	$ˇlg¨y_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

401 
off£t
, 
size_t
 
size
,

402 
dma_d©a_dúe˘i⁄
 
dú
,

403 
dma_©ås
 *
©ås
)

405 *
vaddr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

406 
uaddr
;

407 
≈ages
;

408 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

410 
uaddr
 = ()
vaddr
;

411 
≈ages
 = 
	`iommu_num_∑ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

413  
	`iommu_Æloc
(
dev
, 
tbl
, 
vaddr
, 
≈ages
, 
dú
);

414 
	}
}

416 
	$ˇlg¨y_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

417 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

418 
dma_©ås
 *
©ås
)

420 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

421 
≈ages
;

423 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

424 
	`iommu_‰ì
(
tbl
, 
dma_addr
, 
≈ages
);

425 
	}
}

427 * 
	$ˇlg¨y_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

428 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êag
)

430 *
ªt
 = 
NULL
;

431 
dma_addr_t
 
m≠pög
;

432 
≈ages
, 
‹dî
;

433 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

435 
size
 = 
	`PAGE_ALIGN
(size);

436 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

437 
‹dî
 = 
	`gë_‹dî
(
size
);

439 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

442 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
‹dî
);

443 i‡(!
ªt
)

444 
îr‹
;

445 
	`mem£t
(
ªt
, 0, 
size
);

448 
m≠pög
 = 
	`iommu_Æloc
(
dev
, 
tbl
, 
ªt
, 
≈ages
, 
DMA_BIDIRECTIONAL
);

449 i‡(
m≠pög
 =
DMA_ERROR_CODE
)

450 
‰ì
;

451 *
dma_h™dÀ
 = 
m≠pög
;

452  
ªt
;

453 
‰ì
:

454 
	`‰ì_∑ges
(()
ªt
, 
	`gë_‹dî
(
size
));

455 
ªt
 = 
NULL
;

456 
îr‹
:

457  
ªt
;

458 
	}
}

460 
	$ˇlg¨y_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

461 *
vaddr
, 
dma_addr_t
 
dma_h™dÀ
)

463 
≈ages
;

464 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

466 
size
 = 
	`PAGE_ALIGN
(size);

467 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

469 
	`iommu_‰ì
(
tbl
, 
dma_h™dÀ
, 
≈ages
);

470 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

471 
	}
}

473 
dma_m≠_›s
 
	gˇlg¨y_dma_›s
 = {

474 .
Æloc_cohîít
 = 
ˇlg¨y_Æloc_cohîít
,

475 .
	g‰ì_cohîít
 = 
ˇlg¨y_‰ì_cohîít
,

476 .
	gm≠_sg
 = 
ˇlg¨y_m≠_sg
,

477 .
	gunm≠_sg
 = 
ˇlg¨y_unm≠_sg
,

478 .
	gm≠_∑ge
 = 
ˇlg¨y_m≠_∑ge
,

479 .
	gunm≠_∑ge
 = 
ˇlg¨y_unm≠_∑ge
,

482 
ölöe
 
__iomem
 * 
	$bu¢o_to_bb¨
(
num
)

484  
bus_öfo
[
num
].
bb¨
;

485 
	}
}

487 
ölöe
 
	$bu¢o_to_phbid
(
num
)

489  
bus_öfo
[
num
].
phbid
;

490 
	}
}

492 
ölöe
 
	$•lô_queue_off£t
(
num
)

494 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

496  
•lô_queue_off£ts
[
idx
];

497 
	}
}

499 
ölöe
 
	$èr_off£t
(
num
)

501 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

503  
èr_off£ts
[
idx
];

504 
	}
}

506 
ölöe
 
	$phb_off£t
(
num
)

508 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

510  
phb_off£ts
[
idx
];

511 
	}
}

513 
ölöe
 
__iomem
* 
	$ˇlg¨y_ªg
(
__iomem
 *
b¨
, 
off£t
)

515 
èrgë
 = (()
b¨
Ë| 
off£t
;

516  (
__iomem
*)
èrgë
;

517 
	}
}

519 
ölöe
 
	$is_ˇlioc2
(
devi˚
)

521  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALIOC2
);

522 
	}
}

524 
ölöe
 
	$is_ˇlg¨y
(
devi˚
)

526  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
);

527 
	}
}

529 
ölöe
 
	$is_ˇl_pci_dev
(
devi˚
)

531  (
	`is_ˇlg¨y
(
devi˚
Ë|| 
	`is_ˇlioc2
(device));

532 
	}
}

534 
	$ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

536 
u64
 
vÆ
;

537 
u32
 
´r
;

538 
i
 = 0;

539 
__iomem
 *
bb¨
 = 
tbl
->bbar;

540 
__iomem
 *
èrgë
;

543 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

544 
´r
 = 
	`ªadl
(
èrgë
);

545 
	`wrôñ
(0, 
èrgë
);

548 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

549 
vÆ
 = 
	`ªadl
(
èrgë
);

552 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
tbl
->
ô_bu¢o
));

554 
vÆ
 = 
	`ªadq
(
èrgë
);

555 
i
++;

556 } (
vÆ
 & 0xffË!0xf‡&& 
i
 < 100);

557 i‡(
i
 == 100)

558 
	`¥ötk
(
KERN_WARNING
 "Calgary: PCI busÇot quiesced, "

562 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
tbl
->
ô_bu¢o
));

563 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

566 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

567 
	`wrôñ
(
´r
, 
èrgë
);

568 ()
	`ªadl
(
èrgë
);

569 
	}
}

571 
	$ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

573 
__iomem
 *
bb¨
 = 
tbl
->bbar;

574 
__iomem
 *
èrgë
;

575 
u64
 
vÆ64
;

576 
u32
 
vÆ
;

577 
i
 = 0;

578 
cou¡
 = 1;

579 
bus
 = 
tbl
->
ô_bu¢o
;

581 
begö
:

582 
	`¥ötk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xÉnteringÅce cache blast "

583 "£quí˚ - cou¡ %d\n", 
bus
, 
cou¡
);

586 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

587 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

588 
	`¥ötk
(
KERN_DEBUG
 "1a.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

589 
vÆ
 |
PMR_SOFTSTOP
;

590 
	`¥ötk
(
KERN_DEBUG
 "1b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

591 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

594 
	`¥ötk
(
KERN_DEBUG
 "2a. startingÅoÖoll split queues\n");

595 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
bus
));

597 
vÆ64
 = 
	`ªadq
(
èrgë
);

598 
i
++;

599 } (
vÆ64
 & 0xffË!0xf‡&& 
i
 < 100);

600 i‡(
i
 == 100)

601 
	`¥ötk
(
KERN_WARNING
 "CalIOC2: PCI busÇot quiesced, "

605 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

606 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

607 
	`¥ötk
(
KERN_DEBUG
 "3.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

610 i‡(
vÆ
 & 
PMR_SOFTSTOPFAULT
) {

611 i‡(++
cou¡
 < 100)

612 
begö
;

614 
	`¥ötk
(
KERN_WARNING
 "CalIOC2:Åoo many SoftStopFaults, "

621 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

622 
	`¥ötk
(
KERN_DEBUG
 "5a. sœmmög i¡ÿH¨dSt› byÑódög %p\n", 
èrgë
);

623 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

624 
	`¥ötk
(
KERN_DEBUG
 "5b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

625 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

626 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

627 
	`¥ötk
(
KERN_DEBUG
 "5c.Ñód 0x%x [LE] from %∞(debug)\n", 
vÆ
, 
èrgë
);

630 
	`¥ötk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

631 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
bus
));

632 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

635 
	`¥ötk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

636 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

637 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

638 
	`¥ötk
(
KERN_DEBUG
 "7b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

641 
	`¥ötk
(
KERN_DEBUG
 "8a.Ñemoving HardStop from PMCR\n");

642 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

643 
vÆ
 = 0;

644 
	`¥ötk
(
KERN_DEBUG
 "8b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

645 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

646 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

647 
	`¥ötk
(
KERN_DEBUG
 "8c.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

648 
	}
}

650 
__öô
 
	$ˇlg¨y_ª£rve_mem_ªgi⁄
(
pci_dev
 *
dev
, 
u64
 
°¨t
,

651 
u64
 
limô
)

653 
num∑ges
;

655 
limô
 =Üimit | 0xfffff;

656 
limô
++;

658 
num∑ges
 = ((
limô
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

659 
	`iommu_ønge_ª£rve
(
	`pci_iommu
(
dev
->
bus
), 
°¨t
, 
num∑ges
);

660 
	}
}

662 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
pci_dev
 *
dev
)

664 
__iomem
 *
èrgë
;

665 
u64
 
low
, 
high
, 
sizñow
;

666 
u64
 
°¨t
, 
limô
;

667 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

668 
bu¢um
 = 
dev
->
bus
->
numbî
;

669 
__iomem
 *
bb¨
 = 
tbl
->bbar;

672 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_LOW
);

673 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

674 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_HIGH
);

675 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

676 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_SIZE
);

677 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

679 
°¨t
 = (
high
 << 32Ë| 
low
;

680 
limô
 = 
sizñow
;

682 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

683 
	}
}

685 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
pci_dev
 *
dev
)

687 
__iomem
 *
èrgë
;

688 
u32
 
vÆ32
;

689 
u64
 
low
, 
high
, 
sizñow
, 
sizehigh
;

690 
u64
 
°¨t
, 
limô
;

691 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

692 
bu¢um
 = 
dev
->
bus
->
numbî
;

693 
__iomem
 *
bb¨
 = 
tbl
->bbar;

696 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

697 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

698 i‡(!(
vÆ32
 & 
PHB_MEM2_ENABLE
))

701 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_LOW
);

702 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

703 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_HIGH
);

704 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

705 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_LOW
);

706 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

707 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_HIGH
);

708 
sizehigh
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

710 
°¨t
 = (
high
 << 32Ë| 
low
;

711 
limô
 = (
sizehigh
 << 32Ë| 
sizñow
;

713 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

714 
	}
}

723 
__öô
 
	$ˇlg¨y_ª£rve_ªgi⁄s
(
pci_dev
 *
dev
)

725 
≈ages
;

726 
u64
 
°¨t
;

727 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

730 
	`iommu_ønge_ª£rve
(
tbl
, 
DMA_ERROR_CODE
, 
EMERGENCY_PAGES
);

734 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
)) {

735 
°¨t
 = (640 * 1024);

736 
≈ages
 = ((1024 - 640Ë* 1024Ë>> 
PAGE_SHIFT
;

738 
°¨t
 = 0;

739 
≈ages
 = (1 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

741 
	`iommu_ønge_ª£rve
(
tbl
, 
°¨t
, 
≈ages
);

744 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
dev
);

745 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
dev
);

746 
	}
}

748 
__öô
 
	$ˇlg¨y_£tup_èr
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

750 
u64
 
vÆ64
;

751 
u64
 
èbÀ_phys
;

752 
__iomem
 *
èrgë
;

753 
ªt
;

754 
iommu_èbÀ
 *
tbl
;

757 
ªt
 = 
	`buûd_t˚_èbÀ
(
dev
, 
bb¨
);

758 i‡(
ªt
)

759  
ªt
;

761 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

762 
tbl
->
ô_ba£
 = ()
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
;

764 i‡(
	`is_kdump_kî√l
())

765 
	`ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
tbl
);

767 
	`t˚_‰ì
(
tbl
, 0,Åbl->
ô_size
);

769 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
))

770 
tbl
->
chù_›s
 = &
ˇlg¨y_chù_›s
;

771 i‡(
	`is_ˇlioc2
(
dev
->
devi˚
))

772 
tbl
->
chù_›s
 = &
ˇlioc2_chù_›s
;

774 
	`BUG
();

776 
	`ˇlg¨y_ª£rve_ªgi⁄s
(
dev
);

779 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

780 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

783 
vÆ64
 &~
TAR_SW_BITS
;

784 
èbÀ_phys
 = (
u64
)
	`__∑
(
tbl
->
ô_ba£
);

786 
vÆ64
 |
èbÀ_phys
;

788 
	`BUG_ON
(
•ecifõd_èbÀ_size
 > 
TCE_TABLE_SIZE_8M
);

789 
vÆ64
 |(
u64
Ë
•ecifõd_èbÀ_size
;

791 
tbl
->
èr_vÆ
 = 
	`˝u_to_be64
(
vÆ64
);

793 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

794 
	`ªadq
(
èrgë
);

797 
	}
}

799 
__öô
 
	$ˇlg¨y_‰ì_bus
(
pci_dev
 *
dev
)

801 
u64
 
vÆ64
;

802 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

803 
__iomem
 *
èrgë
;

804 
bôm≠sz
;

806 
èrgë
 = 
	`ˇlg¨y_ªg
(
tbl
->
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

807 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

808 
vÆ64
 &~
TAR_SW_BITS
;

809 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

810 
	`ªadq
(
èrgë
);

812 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

813 
	`‰ì_∑ges
(()
tbl
->
ô_m≠
, 
	`gë_‹dî
(
bôm≠sz
));

814 
tbl
->
ô_m≠
 = 
NULL
;

816 
	`k‰ì
(
tbl
);

818 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

821 
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
 = 
NULL
;

822 
	}
}

824 
	$ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

826 
__iomem
 *
bb¨
 = 
tbl
->bbar;

827 
__iomem
 *
èrgë
;

828 
u32
 
c§
, 
∂s§
;

830 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

831 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

833 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

834 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

837 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on Calgary PHB 0x%x, "

838 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
ô_bu¢o
, 
c§
, 
∂s§
);

839 
	}
}

841 
	$ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

843 
__iomem
 *
bb¨
 = 
tbl
->bbar;

844 
u32
 
c§
, 
csmr
, 
∂s§
, 
mck
, 
rc°©
;

845 
__iomem
 *
èrgë
;

846 
phboff
 = 
	`phb_off£t
(
tbl
->
ô_bu¢o
);

847 
îroff
;

848 
u32
 
îºegs
[7];

849 
i
;

852 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_CSR_OFFSET
);

853 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

855 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

856 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

858 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x290);

859 
csmr
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

861 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x800);

862 
mck
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

864 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on CalIOC2 PHB 0x%x\n",

865 
tbl
->
ô_bu¢o
);

867 
	`¥ötk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

868 
c§
, 
∂s§
, 
csmr
, 
mck
);

871 
	`¥ötk
(
KERN_EMERG
 "Calgary: ");

872 
i
 = 0; i < 
	`ARRAY_SIZE
(
îºegs
); i++) {

874 
îroff
 = (0x810 + (
i
 * 0x10));

875 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
îroff
);

876 
îºegs
[
i
] = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

877 
	`¥ötk
("0x%08x@0x%lx ", 
îºegs
[
i
], 
îroff
);

879 
	`¥ötk
("\n");

882 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

883 
rc°©
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

884 
	`¥ötk
(
KERN_EMERG
 "CÆg¨y: 0x%08x@0x%x\n", 
rc°©
,

885 
PHB_ROOT_COMPLEX_STATUS
);

886 
	}
}

888 
	$ˇlg¨y_w©chdog
(
d©a
)

890 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

891 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

892 
__iomem
 *
bb¨
 = 
tbl
->bbar;

893 
u32
 
vÆ32
;

894 
__iomem
 *
èrgë
;

896 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

897 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

900 i‡(
vÆ32
 & 
CSR_AGENT_MASK
) {

901 
tbl
->
chù_›s
->
	`dump_îr‹_ªgs
(tbl);

904 
	`wrôñ
(0, 
èrgë
);

907 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
) |

908 
PHB_CONFIG_RW_OFFSET
);

909 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

910 
vÆ32
 |
PHB_SLOT_DISABLE
;

911 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

912 
	`ªadl
(
èrgë
);

915 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
 + 2 * 
HZ
);

917 
	}
}

919 
__öô
 
	$ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
__iomem
 *
bb¨
,

920 
bu¢um
, 
timeout
)

922 
u64
 
vÆ64
;

923 
__iomem
 *
èrgë
;

924 
phb_shi·
 = ~0;

925 
u64
 
mask
;

927 
	`bu¢o_to_phbid
(
bu¢um
)) {

928 0: 
phb_shi·
 = (63 - 19);

930 1: 
phb_shi·
 = (63 - 23);

932 2: 
phb_shi·
 = (63 - 27);

934 3: 
phb_shi·
 = (63 - 35);

937 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

940 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
CALGARY_CONFIG_REG
);

941 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

944 
mask
 = ~(0xFUL << 
phb_shi·
);

945 
vÆ64
 &
mask
;

946 
vÆ64
 |(
timeout
 << 
phb_shi·
);

947 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

948 
	`ªadq
(
èrgë
);

949 
	}
}

951 
__öô
 
	$ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

953 
bu¢um
 = 
dev
->
bus
->
numbî
;

954 
__iomem
 *
bb¨
 = 
tbl
->bbar;

955 
__iomem
 *
èrgë
;

956 
u32
 
vÆ
;

961 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_SAVIOR_L2
);

962 
vÆ
 = 
	`˝u_to_be32
(
	`ªadl
(
èrgë
));

963 
vÆ
 |= 0x00800000;

964 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

965 
	}
}

967 
__öô
 
	$ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

969 
bu¢um
 = 
dev
->
bus
->
numbî
;

975 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
Ë&& (
bu¢um
 == 1))

976 
	`ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
tbl
->
bb¨
, 
bu¢um
,

977 
CCR_2SEC_TIMEOUT
);

978 
	}
}

980 
__öô
 
	$ˇlg¨y_íabÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

982 
u32
 
vÆ32
;

983 
bu¢um
;

984 
__iomem
 *
èrgë
;

985 
__iomem
 *
bb¨
;

986 
iommu_èbÀ
 *
tbl
;

988 
bu¢um
 = 
dev
->
bus
->
numbî
;

989 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

990 
bb¨
 = 
tbl
->bbar;

993 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

994 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

995 
vÆ32
 |
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

997 
	`¥ötk
(
KERN_INFO
 "Calgary:ÉnablingÅranslation on %s PHB %#x\n",

998 (
dev
->
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
) ?

999 "CÆg¨y" : "CÆIOC2", 
bu¢um
);

1000 
	`¥ötk
(
KERN_INFO
 "Calgary:Érrant DMAs willÇow beÖrevented onÅhis "

1003 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1004 
	`ªadl
(
èrgë
);

1006 
	`öô_timî
(&
tbl
->
w©chdog_timî
);

1007 
tbl
->
w©chdog_timî
.
fun˘i⁄
 = &
ˇlg¨y_w©chdog
;

1008 
tbl
->
w©chdog_timî
.
d©a
 = ()
dev
;

1009 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
);

1010 
	}
}

1012 
__öô
 
	$ˇlg¨y_dißbÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

1014 
u32
 
vÆ32
;

1015 
bu¢um
;

1016 
__iomem
 *
èrgë
;

1017 
__iomem
 *
bb¨
;

1018 
iommu_èbÀ
 *
tbl
;

1020 
bu¢um
 = 
dev
->
bus
->
numbî
;

1021 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1022 
bb¨
 = 
tbl
->bbar;

1025 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

1026 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1027 
vÆ32
 &~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1029 
	`¥ötk
(
KERN_INFO
 "CÆg¨y: dißblögÅøn¶©i⁄ o¿PHB %#x!\n", 
bu¢um
);

1030 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1031 
	`ªadl
(
èrgë
);

1033 
	`dñ_timî_sync
(&
tbl
->
w©chdog_timî
);

1034 
	}
}

1036 
__öô
 
	$ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
pci_dev
 *
dev
)

1038 
	`pci_dev_gë
(
dev
);

1039 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1042 i‡(
dev
->
bus
->
∑ª¡
)

1043 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1045 
dev
->
bus
->
£lf
 = dev;

1046 
	}
}

1048 
__öô
 
	$ˇlg¨y_öô_⁄e
(
pci_dev
 *
dev
)

1050 
__iomem
 *
bb¨
;

1051 
iommu_èbÀ
 *
tbl
;

1052 
ªt
;

1054 
	`BUG_ON
(
dev
->
bus
->
numbî
 >
MAX_PHB_BUS_NUM
);

1056 
bb¨
 = 
	`bu¢o_to_bb¨
(
dev
->
bus
->
numbî
);

1057 
ªt
 = 
	`ˇlg¨y_£tup_èr
(
dev
, 
bb¨
);

1058 i‡(
ªt
)

1059 
d⁄e
;

1061 
	`pci_dev_gë
(
dev
);

1063 i‡(
dev
->
bus
->
∑ª¡
) {

1064 i‡(
dev
->
bus
->
∑ª¡
->
£lf
)

1065 
	`¥ötk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1066 "bus->∑ª¡->£lf!\n", 
dev
);

1067 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1069 
dev
->
bus
->
£lf
 = dev;

1071 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1072 
tbl
->
chù_›s
->
	`h™dÀ_quúks
—bl, 
dev
);

1074 
	`ˇlg¨y_íabÀ_å™¶©i⁄
(
dev
);

1078 
d⁄e
:

1079  
ªt
;

1080 
	}
}

1082 
__öô
 
	$ˇlg¨y_loˇã_bb¨s
()

1084 
ªt
;

1085 
rioidx
, 
phb
, 
bus
;

1086 
__iomem
 *
bb¨
;

1087 
__iomem
 *
èrgë
;

1088 
off£t
;

1089 
u8
 
°¨t_bus
, 
íd_bus
;

1090 
u32
 
vÆ
;

1092 
ªt
 = -
ENODATA
;

1093 
rioidx
 = 0;Ñioidx < 
rio_èbÀ_hdr
->
num_rio_dev
;Ñioidx++) {

1094 
rio_dëaû
 *
rio
 = 
rio_devs
[
rioidx
];

1096 i‡((
rio
->
ty≥
 !
COMPAT_CALGARY
Ë&& (rio->ty≥ !
ALT_CALGARY
))

1100 
bb¨
 = 
	`i‹em≠_noˇche
(
rio
->
BBAR
, 1024 * 1024);

1101 i‡(!
bb¨
)

1102 
îr‹
;

1104 
phb
 = 0;Öhb < 
PHBS_PER_CALGARY
;Öhb++) {

1105 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1106 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
off£t
);

1108 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1110 
°¨t_bus
 = (
u8
)((
vÆ
 & 0x00FF0000) >> 16);

1111 
íd_bus
 = (
u8
)((
vÆ
 & 0x0000FF00) >> 8);

1113 i‡(
íd_bus
) {

1114 
bus
 = 
°¨t_bus
; bu†<
íd_bus
; bus++) {

1115 
bus_öfo
[
bus
].
bb¨
 = bbar;

1116 
bus_öfo
[
bus
].
phbid
 = 
phb
;

1119 
bus_öfo
[
°¨t_bus
].
bb¨
 = bbar;

1120 
bus_öfo
[
°¨t_bus
].
phbid
 = 
phb
;

1127 
îr‹
:

1129 
bus
 = 0; bu†< 
	`ARRAY_SIZE
(
bus_öfo
); bus++)

1130 i‡(
bus_öfo
[
bus
].
bb¨
)

1131 
	`iounm≠
(
bus_öfo
[
bus
].
bb¨
);

1133  
ªt
;

1134 
	}
}

1136 
__öô
 
	$ˇlg¨y_öô
()

1138 
ªt
;

1139 
pci_dev
 *
dev
 = 
NULL
;

1140 
ˇlg¨y_bus_öfo
 *
öfo
;

1142 
ªt
 = 
	`ˇlg¨y_loˇã_bb¨s
();

1143 i‡(
ªt
)

1144  
ªt
;

1147 i‡(
	`is_kdump_kî√l
())

1148 
	`gë_t˚_•a˚_‰om_èr
();

1151 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1152 i‡(!
dev
)

1154 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1157 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1158 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1159 
	`ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
dev
);

1163 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1166 
ªt
 = 
	`ˇlg¨y_öô_⁄e
(
dev
);

1167 i‡(
ªt
)

1168 
îr‹
;

1171 
dev
 = 
NULL
;

1172 
	`f‹_óch_pci_dev
(
dev
) {

1173 
iommu_èbÀ
 *
tbl
;

1175 
tbl
 = 
	`föd_iommu_èbÀ
(&
dev
->dev);

1177 i‡(
	`å™¶©i⁄_íabÀd
(
tbl
))

1178 
dev
->dev.
¨chd©a
.
dma_›s
 = &
ˇlg¨y_dma_›s
;

1181  
ªt
;

1183 
îr‹
:

1185 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1186 i‡(!
dev
)

1188 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1191 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1192 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1193 
	`pci_dev_put
(
dev
);

1196 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1199 
	`ˇlg¨y_dißbÀ_å™¶©i⁄
(
dev
);

1200 
	`ˇlg¨y_‰ì_bus
(
dev
);

1201 
	`pci_dev_put
(
dev
);

1202 
dev
->dev.
¨chd©a
.
dma_›s
 = 
NULL
;

1205  
ªt
;

1206 
	}
}

1208 
ölöe
 
__öô
 
	$dëîmöe_t˚_èbÀ_size
(
u64
 
øm
)

1210 
ªt
;

1212 i‡(
•ecifõd_èbÀ_size
 !
TCE_TABLE_SIZE_UNSPECIFIED
)

1213  
•ecifõd_èbÀ_size
;

1222 
ªt
 = 
	`gë_‹dî
(
øm
 >> 13);

1223 i‡(
ªt
 > 
TCE_TABLE_SIZE_8M
)

1224 
ªt
 = 
TCE_TABLE_SIZE_8M
;

1226  
ªt
;

1227 
	}
}

1229 
__öô
 
	$buûd_dëaû_¨øys
()

1231 
±r
;

1232 
numnodes
, 
i
;

1233 
sˇl_dëaû_size
, 
rio_dëaû_size
;

1235 
numnodes
 = 
rio_èbÀ_hdr
->
num_sˇl_dev
;

1236 i‡(
numnodes
 > 
MAX_NUMNODES
){

1237 
	`¥ötk
(
KERN_WARNING


1240 
MAX_NUMNODES
, 
numnodes
);

1241  -
ENODEV
;

1244 
rio_èbÀ_hdr
->
vîsi⁄
){

1246 
sˇl_dëaû_size
 = 11;

1247 
rio_dëaû_size
 = 13;

1250 
sˇl_dëaû_size
 = 12;

1251 
rio_dëaû_size
 = 15;

1254 
	`¥ötk
(
KERN_WARNING


1256 
rio_èbÀ_hdr
->
vîsi⁄
);

1257  -
EPROTO
;

1260 
±r
 = (()
rio_èbÀ_hdr
) + 3;

1261 
i
 = 0; i < 
numnodes
; i++, 
±r
 +
sˇl_dëaû_size
)

1262 
sˇl_devs
[
i
] = (
sˇl_dëaû
 *)
±r
;

1264 
i
 = 0; i < 
rio_èbÀ_hdr
->
num_rio_dev
;

1265 
i
++, 
±r
 +
rio_dëaû_size
)

1266 
rio_devs
[
i
] = (
rio_dëaû
 *)
±r
;

1269 
	}
}

1271 
__öô
 
	$ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_dev
)

1273 
dev
;

1274 
u32
 
vÆ
;

1276 i‡(
pci_dev
 =
PCI_DEVICE_ID_IBM_CALIOC2
) {

1284 
dev
 = 1; dev < 8; dev++) {

1285 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 0, 0);

1286 i‡(
vÆ
 != 0xffffffff)

1289  (
vÆ
 != 0xffffffff);

1290 
	}
}

1297 
	$ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
)

1299 
u64
 *
ç
;

1300 
ödex
;

1301 
ç
 = ((
u64
 *)
tbl
->
ô_ba£
);

1302 
ödex
 = 0 ; index < 
tbl
->
ô_size
; index++) {

1303 i‡(*
ç
 != 0x0)

1304 
	`£t_bô
(
ödex
, 
tbl
->
ô_m≠
);

1305 
ç
++;

1307 
	}
}

1314 
__öô
 
	$gë_t˚_•a˚_‰om_èr
()

1316 
bus
;

1317 
__iomem
 *
èrgë
;

1318 
t˚_•a˚
;

1320 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1321 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1322 
pci_devi˚
;

1323 
u32
 
vÆ
;

1325 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1326 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1328 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1330 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1333 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1334 
å™¶©e_em±y_¶Ÿs
) {

1335 
èrgë
 = 
	`ˇlg¨y_ªg
(
bus_öfo
[
bus
].
bb¨
,

1336 
	`èr_off£t
(
bus
));

1337 
t˚_•a˚
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

1338 
t˚_•a˚
 =Å˚_•a˚ & 
TAR_SW_BITS
;

1340 
t˚_•a˚
 =Å˚_•a˚ & (~
•ecifõd_èbÀ_size
);

1341 
öfo
->
t˚_•a˚
 = (
u64
 *)
	`__va
(tce_space);

1345 
	}
}

1347 
__öô
 
	$ˇlg¨y_iommu_öô
()

1349 
ªt
;

1352 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1354 
ªt
 = 
	`ˇlg¨y_öô
();

1355 i‡(
ªt
) {

1356 
	`¥ötk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1357 "ÁŒög backÅÿno_iommu\n", 
ªt
);

1358  
ªt
;

1362 
	}
}

1364 
__öô
 
	$dëe˘_ˇlg¨y
()

1366 
bus
;

1367 *
tbl
;

1368 
ˇlg¨y_found
 = 0;

1369 
±r
;

1370 
off£t
, 
¥ev_off£t
;

1371 
ªt
;

1377 i‡(
no_iommu
 || 
iommu_dëe˘ed
)

1380 i‡(!
u£_ˇlg¨y
)

1383 i‡(!
	`óæy_pci_Ælowed
())

1386 
	`¥ötk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDAárea\n");

1388 
±r
 = ()
	`phys_to_vút
(
	`gë_bios_ebda
());

1390 
rio_èbÀ_hdr
 = 
NULL
;

1391 
¥ev_off£t
 = 0;

1392 
off£t
 = 0x180;

1397 
off£t
 > 
¥ev_off£t
) {

1399 i‡(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1401 
rio_èbÀ_hdr
 = (rio_èbÀ_hd∏*)(
±r
 + 
off£t
 + 4);

1404 
¥ev_off£t
 = 
off£t
;

1405 
off£t
 = *((*)(
±r
 + offset));

1407 i‡(!
rio_èbÀ_hdr
) {

1408 
	`¥ötk
(
KERN_DEBUG
 "Calgary: UnableÅoÜocate Rio GrandeÅable "

1413 
ªt
 = 
	`buûd_dëaû_¨øys
();

1414 i‡(
ªt
) {

1415 
	`¥ötk
(
KERN_DEBUG
 "CÆg¨y: buûd_dëaû_¨øy†ªà%d\n", 
ªt
);

1419 
•ecifõd_èbÀ_size
 = 
	`dëîmöe_t˚_èbÀ_size
((
	`is_kdump_kî√l
() ?

1420 
ßved_max_p‚
 : 
max_p‚
Ë* 
PAGE_SIZE
);

1422 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1423 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1424 
pci_devi˚
;

1425 
u32
 
vÆ
;

1427 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1428 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1430 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1433 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1436 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1437 
å™¶©e_em±y_¶Ÿs
) {

1442 i‡(!
	`is_kdump_kî√l
()) {

1443 
tbl
 = 
	`Æloc_t˚_èbÀ
();

1444 i‡(!
tbl
)

1445 
˛ónup
;

1446 
öfo
->
t˚_•a˚
 = 
tbl
;

1448 
ˇlg¨y_found
 = 1;

1452 
	`¥ötk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1453 
ˇlg¨y_found
 ? "found" : "not found");

1455 i‡(
ˇlg¨y_found
) {

1456 
iommu_dëe˘ed
 = 1;

1457 
ˇlg¨y_dëe˘ed
 = 1;

1458 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1459 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary TCEÅable spec is %d\n",

1460 
•ecifõd_èbÀ_size
);

1462 
x86_öô
.
iommu
.
iommu_öô
 = 
ˇlg¨y_iommu_öô
;

1466 
˛ónup
:

1467 --
bus
; bus >= 0; --bus) {

1468 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1470 i‡(
öfo
->
t˚_•a˚
)

1471 
	`‰ì_t˚_èbÀ
(
öfo
->
t˚_•a˚
);

1473 
	}
}

1475 
__öô
 
	$ˇlg¨y_∑r£_›ti⁄s
(*
p
)

1477 
bridge
;

1478 
size_t
 
Àn
;

1479 * 
ídp
;

1481 *
p
) {

1482 i‡(!
	`°∫cmp
(
p
, "64k", 3))

1483 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_64K
;

1484 i‡(!
	`°∫cmp
(
p
, "128k", 4))

1485 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_128K
;

1486 i‡(!
	`°∫cmp
(
p
, "256k", 4))

1487 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_256K
;

1488 i‡(!
	`°∫cmp
(
p
, "512k", 4))

1489 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_512K
;

1490 i‡(!
	`°∫cmp
(
p
, "1M", 2))

1491 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_1M
;

1492 i‡(!
	`°∫cmp
(
p
, "2M", 2))

1493 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_2M
;

1494 i‡(!
	`°∫cmp
(
p
, "4M", 2))

1495 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_4M
;

1496 i‡(!
	`°∫cmp
(
p
, "8M", 2))

1497 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_8M
;

1499 
Àn
 = 
	`°æí
("translate_empty_slots");

1500 i‡(!
	`°∫cmp
(
p
, "å™¶©e_em±y_¶Ÿs", 
Àn
))

1501 
å™¶©e_em±y_¶Ÿs
 = 1;

1503 
Àn
 = 
	`°æí
("disable");

1504 i‡(!
	`°∫cmp
(
p
, "dißbÀ", 
Àn
)) {

1505 
p
 +
Àn
;

1506 i‡(*
p
 == '=')

1507 ++
p
;

1508 i‡(*
p
 == '\0')

1510 
bridge
 = 
	`sim∂e_°πoul
(
p
, &
ídp
, 0);

1511 i‡(
p
 =
ídp
)

1514 i‡(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1515 
	`¥ötk
(
KERN_INFO
 "Calgary: disabling "

1516 "å™¶©i⁄ f‹ PHB %#x\n", 
bridge
);

1517 
bus_öfo
[
bridge
].
å™¶©i⁄_dißbÀd
 = 1;

1521 
p
 = 
	`°Ωbrk
(p, ",");

1522 i‡(!
p
)

1525 
p
++;

1528 
	}
}

1529 
__£tup
("ˇlg¨y=", 
ˇlg¨y_∑r£_›ti⁄s
);

1531 
__öô
 
	$ˇlg¨y_fixup_⁄e_t˚_•a˚
(
pci_dev
 *
dev
)

1533 
iommu_èbÀ
 *
tbl
;

1534 
≈ages
;

1535 
i
;

1537 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1539 
i
 = 0; i < 4; i++) {

1540 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
PCI_BRIDGE_RESOURCES
 + 
i
];

1543 i‡(!(
r
->
Êags
 & 
IORESOURCE_MEM
))

1547 i‡(!
r
->
°¨t
)

1551 
≈ages
 = (
r
->
íd
 -Ñ->
°¨t
Ë>> 
PAGE_SHIFT
;

1552 
≈ages
++;

1554 
	`iommu_ønge_ª£rve
(
tbl
, 
r
->
°¨t
, 
≈ages
);

1556 
	}
}

1558 
__öô
 
	$ˇlg¨y_fixup_t˚_•a˚s
()

1560 
pci_dev
 *
dev
 = 
NULL
;

1561 
ˇlg¨y_bus_öfo
 *
öfo
;

1563 i‡(
no_iommu
 || 
swiŸlb
 || !
ˇlg¨y_dëe˘ed
)

1564  -
ENODEV
;

1566 
	`¥ötk
(
KERN_DEBUG
 "Calgary: fixing upÅce spaces\n");

1569 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1570 i‡(!
dev
)

1572 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1575 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1576 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1579 i‡(!
öfo
->
t˚_•a˚
)

1582 
	`ˇlg¨y_fixup_⁄e_t˚_•a˚
(
dev
);

1587 
	}
}

1593 
roŸfs_öôˇŒ
(
ˇlg¨y_fixup_t˚_•a˚s
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<löux/dma-m≠pög.h
>

2 
	~<löux/dma-debug.h
>

3 
	~<löux/dm¨.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/gÂ.h
>

6 
	~<löux/pci.h
>

7 
	~<löux/kmemÀak.h
>

9 
	~<asm/¥Ÿo.h
>

10 
	~<asm/dma.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/g¨t.h
>

13 
	~<asm/ˇlg¨y.h
>

14 
	~<asm/amd_iommu.h
>

15 
	~<asm/x86_öô.h
>

17 
f‹bid_dac
 
	g__ªad_mo°ly
;

19 
dma_m≠_›s
 *
	gdma_›s
 = &
nommu_dma_›s
;

20 
EXPORT_SYMBOL
(
dma_›s
);

22 
iommu_ßc_f‹˚
 
	g__ªad_mo°ly
;

24 #ifde‡
CONFIG_IOMMU_DEBUG


25 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 1;

26 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 1;

28 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 0;

29 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 0;

32 
iommu_mîge
 
	g__ªad_mo°ly
 = 0;

34 
no_iommu
 
	g__ªad_mo°ly
;

36 
iommu_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

45 
iommu_∑ss_through
 
	g__ªad_mo°ly
;

48 
devi˚
 
	gx86_dma_ÁŒback_dev
 = {

49 .
öô_«me
 = "fallback device",

50 .
	gcohîít_dma_mask
 = 
ISA_DMA_BIT_MASK
,

51 .
	gdma_mask
 = &
x86_dma_ÁŒback_dev
.
cohîít_dma_mask
,

53 
EXPORT_SYMBOL
(
x86_dma_ÁŒback_dev
);

56 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

58 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

60 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

61  -
EIO
;

63 *
dev
->
dma_mask
 = 
mask
;

66 
	}
}

67 
EXPORT_SYMBOL
(
dma_£t_mask
);

69 #i‡
deföed
(
CONFIG_X86_64
Ë&& !deföed(
CONFIG_NUMA
)

70 
__öôd©a
 *
	gdma32_boŸmem_±r
;

71 
dma32_boŸmem_size
 
	g__öôd©a
 = (128ULL<<20);

73 
__öô
 
	$∑r£_dma32_size_›t
(*
p
)

75 i‡(!
p
)

76  -
EINVAL
;

77 
dma32_boŸmem_size
 = 
	`mem∑r£
(
p
, &p);

79 
	}
}

80 
óæy_∑øm
("dma32_size", 
∑r£_dma32_size_›t
);

82 
__öô
 
	$dma32_ª£rve_boŸmem
()

84 
size
, 
Æign
;

85 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

92 
Æign
 = 64ULL<<20;

93 
size
 = 
	`roundup
(
dma32_boŸmem_size
, 
Æign
);

94 
dma32_boŸmem_±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
,

100 
	`kmemÀak_ign‹e
(
dma32_boŸmem_±r
);

101 i‡(
dma32_boŸmem_±r
)

102 
dma32_boŸmem_size
 = 
size
;

104 
dma32_boŸmem_size
 = 0;

105 
	}
}

106 
__öô
 
	$dma32_‰ì_boŸmem
()

109 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

112 i‡(!
dma32_boŸmem_±r
)

115 
	`‰ì_boŸmem
(
	`__∑
(
dma32_boŸmem_±r
), 
dma32_boŸmem_size
);

117 
dma32_boŸmem_±r
 = 
NULL
;

118 
dma32_boŸmem_size
 = 0;

119 
	}
}

121 
__öô
 
	$dma32_ª£rve_boŸmem
()

123 
	}
}

124 
__öô
 
	$dma32_‰ì_boŸmem
()

126 
	}
}

130 
__öô
 
	$pci_iommu_Æloc
()

133 
	`dma32_‰ì_boŸmem
();

135 i‡(
	`pci_swiŸlb_dëe˘
())

136 
out
;

138 
	`g¨t_iommu_hﬁe_öô
();

140 
	`dëe˘_ˇlg¨y
();

142 
	`dëe˘_öãl_iommu
();

145 
	`amd_iommu_dëe˘
();

146 
out
:

147 
	`pci_swiŸlb_öô
();

148 
	}
}

150 *
	$dma_gíîic_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

151 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

153 
dma_mask
;

154 
∑ge
 *page;

155 
dma_addr_t
 
addr
;

157 
dma_mask
 = 
	`dma_Æloc_cohîít_mask
(
dev
, 
Êag
);

159 
Êag
 |
__GFP_ZERO
;

160 
agaö
:

161 
∑ge
 = 
	`Æloc_∑ges_node
(
	`dev_to_node
(
dev
), 
Êag
, 
	`gë_‹dî
(
size
));

162 i‡(!
∑ge
)

163  
NULL
;

165 
addr
 = 
	`∑ge_to_phys
(
∑ge
);

166 i‡(
addr
 + 
size
 > 
dma_mask
) {

167 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

169 i‡(
dma_mask
 < 
	`DMA_BIT_MASK
(32Ë&& !(
Êag
 & 
GFP_DMA
)) {

170 
Êag
 = (Êag & ~
GFP_DMA32
Ë| 
GFP_DMA
;

171 
agaö
;

174  
NULL
;

177 *
dma_addr
 = 
addr
;

178  
	`∑ge_addªss
(
∑ge
);

179 
	}
}

185 
__öô
 
	$iommu_£tup
(*
p
)

187 
iommu_mîge
 = 1;

189 i‡(!
p
)

190  -
EINVAL
;

192 *
p
) {

193 i‡(!
	`°∫cmp
(
p
, "off", 3))

194 
no_iommu
 = 1;

196 i‡(!
	`°∫cmp
(
p
, "force", 5))

197 
f‹˚_iommu
 = 1;

198 i‡(!
	`°∫cmp
(
p
, "noforce", 7)) {

199 
iommu_mîge
 = 0;

200 
f‹˚_iommu
 = 0;

203 i‡(!
	`°∫cmp
(
p
, "biomerge", 8)) {

204 
iommu_mîge
 = 1;

205 
f‹˚_iommu
 = 1;

207 i‡(!
	`°∫cmp
(
p
, "panic", 5))

208 
∑nic_⁄_ovîÊow
 = 1;

209 i‡(!
	`°∫cmp
(
p
, "nopanic", 7))

210 
∑nic_⁄_ovîÊow
 = 0;

211 i‡(!
	`°∫cmp
(
p
, "merge", 5)) {

212 
iommu_mîge
 = 1;

213 
f‹˚_iommu
 = 1;

215 i‡(!
	`°∫cmp
(
p
, "nomerge", 7))

216 
iommu_mîge
 = 0;

217 i‡(!
	`°∫cmp
(
p
, "forcesac", 8))

218 
iommu_ßc_f‹˚
 = 1;

219 i‡(!
	`°∫cmp
(
p
, "allowdac", 8))

220 
f‹bid_dac
 = 0;

221 i‡(!
	`°∫cmp
(
p
, "nodac", 5))

222 
f‹bid_dac
 = 1;

223 i‡(!
	`°∫cmp
(
p
, "usedac", 6)) {

224 
f‹bid_dac
 = -1;

227 #ifde‡
CONFIG_SWIOTLB


228 i‡(!
	`°∫cmp
(
p
, "soft", 4))

229 
swiŸlb
 = 1;

231 i‡(!
	`°∫cmp
(
p
, "pt", 2))

232 
iommu_∑ss_through
 = 1;

234 
	`g¨t_∑r£_›ti⁄s
(
p
);

236 #ifde‡
CONFIG_CALGARY_IOMMU


237 i‡(!
	`°∫cmp
(
p
, "calgary", 7))

238 
u£_ˇlg¨y
 = 1;

241 
p
 +
	`°rc•n
(p, ",");

242 i‡(*
p
 == ',')

243 ++
p
;

246 
	}
}

247 
óæy_∑øm
("iommu", 
iommu_£tup
);

249 
	$dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

251 
dma_m≠_›s
 *
›s
 = 
	`gë_dma_›s
(
dev
);

253 #ifde‡
CONFIG_PCI


254 i‡(
mask
 > 0xfffffff‡&& 
f‹bid_dac
 > 0) {

255 
	`dev_öfo
(
dev
, "PCI: Disallowing DAC for device\n");

260 i‡(
›s
->
dma_suµ‹ãd
)

261  
›s
->
	`dma_suµ‹ãd
(
dev
, 
mask
);

266 i‡(
mask
 < 
	`DMA_BIT_MASK
(24))

281 i‡(
iommu_ßc_f‹˚
 && (
mask
 >
	`DMA_BIT_MASK
(40))) {

282 
	`dev_öfo
(
dev
, "F‹˚ SAC wôh mask %Lx\n", 
mask
);

287 
	}
}

288 
EXPORT_SYMBOL
(
dma_suµ‹ãd
);

290 
__öô
 
	$pci_iommu_öô
()

292 
	`dma_debug_öô
(
PREALLOC_DMA_DEBUG_ENTRIES
);

294 #ifde‡
CONFIG_PCI


295 
	`dma_debug_add_bus
(&
pci_bus_ty≥
);

297 
x86_öô
.
iommu
.
	`iommu_öô
();

299 i‡(
swiŸlb
) {

300 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: "

302 
	`swiŸlb_¥öt_öfo
();

304 
	`swiŸlb_‰ì
();

307 
	}
}

309 
roŸfs_öôˇŒ
(
pci_iommu_öô
);

311 #ifde‡
CONFIG_PCI


314 
__devöô
 
	$vü_no_dac
(
pci_dev
 *
dev
)

316 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
 && 
f‹bid_dac
 == 0) {

317 
	`dev_öfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

318 
f‹bid_dac
 = 1;

320 
	}
}

321 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vü_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<löux/ty≥s.h
>

15 
	~<löux/˘y≥.h
>

16 
	~<löux/agp_backíd.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/•ölock.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/t›ﬁogy.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bôm≠.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<löux/iommu-hñ≥r.h
>

30 
	~<löux/sysdev.h
>

31 
	~<löux/io.h
>

32 
	~<löux/gÂ.h
>

33 
	~<asm/©omic.h
>

34 
	~<asm/mår.h
>

35 
	~<asm/pgèbÀ.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/iommu.h
>

38 
	~<asm/g¨t.h
>

39 
	~<asm/ˇcheÊush.h
>

40 
	~<asm/swiŸlb.h
>

41 
	~<asm/dma.h
>

42 
	~<asm/k8.h
>

43 
	~<asm/x86_öô.h
>

45 
	giommu_bus_ba£
;

46 
	giommu_size
;

47 
	giommu_∑ges
;

49 
u32
 *
	giommu_g©t_ba£
;

51 
dma_addr_t
 
	gbad_dma_addr
;

60 
	giommu_fuŒÊush
 = 1;

63 
DEFINE_SPINLOCK
(
iommu_bôm≠_lock
);

65 *
	giommu_g¨t_bôm≠
;

67 
u32
 
	gg¨t_unm≠≥d_íåy
;

69 
	#GPTE_VALID
 1

	)

70 
	#GPTE_COHERENT
 2

	)

71 
	#GPTE_ENCODE
(
x
) \

72 (((
x
Ë& 0xfffff000Ë| (((xË>> 32Ë<< 4Ë| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

73 
	#GPTE_DECODE
(
x
Ë(((xË& 0xfffff000Ë| (((
u64
)(xË& 0xff0Ë<< 28))

	)

75 
	#EMERGENCY_PAGES
 32

	)

77 #ifde‡
CONFIG_AGP


78 
	#AGPEXTERN
 

	)

80 
	#AGPEXTERN


	)

84 
AGPEXTERN
 
agp_mem‹y_ª£rved
;

85 
AGPEXTERN
 
__u32
 *
	gagp_g©t_èbÀ
;

87 
	g√xt_bô
;

88 
boﬁ
 
	g√ed_Êush
;

90 
	$Æloc_iommu
(
devi˚
 *
dev
, 
size
,

91 
Æign_mask
)

93 
off£t
, 
Êags
;

94 
bound¨y_size
;

95 
ba£_ödex
;

97 
ba£_ödex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_gë_£g_bound¨y
(
dev
),

98 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

99 
bound¨y_size
 = 
	`ALIGN
((
u64
)
	`dma_gë_£g_bound¨y
(
dev
) + 1,

100 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

102 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

103 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 
√xt_bô
,

104 
size
, 
ba£_ödex
, 
bound¨y_size
, 
Æign_mask
);

105 i‡(
off£t
 == -1) {

106 
√ed_Êush
 = 
åue
;

107 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 0,

108 
size
, 
ba£_ödex
, 
bound¨y_size
,

109 
Æign_mask
);

111 i‡(
off£t
 != -1) {

112 
√xt_bô
 = 
off£t
+
size
;

113 i‡(
√xt_bô
 >
iommu_∑ges
) {

114 
√xt_bô
 = 0;

115 
√ed_Êush
 = 
åue
;

118 i‡(
iommu_fuŒÊush
)

119 
√ed_Êush
 = 
åue
;

120 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

122  
off£t
;

123 
	}
}

125 
	$‰ì_iommu
(
off£t
, 
size
)

127 
Êags
;

129 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

130 
	`bôm≠_˛ór
(
iommu_g¨t_bôm≠
, 
off£t
, 
size
);

131 i‡(
off£t
 >
√xt_bô
)

132 
√xt_bô
 = 
off£t
 + 
size
;

133 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

134 
	}
}

139 
	$Êush_g¨t
()

141 
Êags
;

143 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

144 i‡(
√ed_Êush
) {

145 
	`k8_Êush_g¨ts
();

146 
√ed_Êush
 = 
Ál£
;

148 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

149 
	}
}

151 #ifde‡
CONFIG_IOMMU_LEAK


153 
	gÀak_åa˚
;

154 
	giommu_Àak_∑ges
 = 20;

156 
	$dump_Àak
()

158 
dump
;

160 i‡(
dump
)

162 
dump
 = 1;

164 
	`show_°ack
(
NULL
, NULL);

165 
	`debug_dma_dump_m≠pögs
(
NULL
);

166 
	}
}

169 
	$iommu_fuŒ
(
devi˚
 *
dev
, 
size_t
 
size
, 
dú
)

181 
	`dev_îr
(
dev
, "PCI-DMA: Ouào‡IOMMU s∑˚ f‹ %lu byãs\n", 
size
);

183 i‡(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

184 i‡(
dú
 =
PCI_DMA_FROMDEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

185 
	`∑nic
("PCI-DMA: Memory would be corrupted\n");

186 i‡(
dú
 =
PCI_DMA_TODEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

187 
	`∑nic
(
KERN_ERR


190 #ifde‡
CONFIG_IOMMU_LEAK


191 
	`dump_Àak
();

193 
	}
}

195 
ölöe
 

196 
	$√ed_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

198  
f‹˚_iommu
 || !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

199 
	}
}

201 
ölöe
 

202 
	$n⁄f‹˚d_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

204  !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

205 
	}
}

210 
dma_addr_t
 
	$dma_m≠_¨ó
(
devi˚
 *
dev
, 
dma_addr_t
 
phys_mem
,

211 
size_t
 
size
, 
dú
, 
Æign_mask
)

213 
≈ages
 = 
	`iommu_num_∑ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

214 
iommu_∑ge
 = 
	`Æloc_iommu
(
dev
, 
≈ages
, 
Æign_mask
);

215 
i
;

217 i‡(
iommu_∑ge
 == -1) {

218 i‡(!
	`n⁄f‹˚d_iommu
(
dev
, 
phys_mem
, 
size
))

219  
phys_mem
;

220 i‡(
∑nic_⁄_ovîÊow
)

221 
	`∑nic
("dma_m≠_¨ó ovîÊow %lu byãs\n", 
size
);

222 
	`iommu_fuŒ
(
dev
, 
size
, 
dú
);

223  
bad_dma_addr
;

226 
i
 = 0; i < 
≈ages
; i++) {

227 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

228 
phys_mem
 +
PAGE_SIZE
;

230  
iommu_bus_ba£
 + 
iommu_∑ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

231 
	}
}

234 
dma_addr_t
 
	$g¨t_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

235 
off£t
, 
size_t
 
size
,

236 
dma_d©a_dúe˘i⁄
 
dú
,

237 
dma_©ås
 *
©ås
)

239 
bus
;

240 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

242 i‡(!
dev
)

243 
dev
 = &
x86_dma_ÁŒback_dev
;

245 i‡(!
	`√ed_iommu
(
dev
, 
∑ddr
, 
size
))

246  
∑ddr
;

248 
bus
 = 
	`dma_m≠_¨ó
(
dev
, 
∑ddr
, 
size
, 
dú
, 0);

249 
	`Êush_g¨t
();

251  
bus
;

252 
	}
}

257 
	$g¨t_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

258 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

259 
dma_©ås
 *
©ås
)

261 
iommu_∑ge
;

262 
≈ages
;

263 
i
;

265 i‡(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

266 
dma_addr
 >
iommu_bus_ba£
 + 
iommu_size
)

269 
iommu_∑ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

270 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

271 
i
 = 0; i < 
≈ages
; i++) {

272 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
g¨t_unm≠≥d_íåy
;

274 
	`‰ì_iommu
(
iommu_∑ge
, 
≈ages
);

275 
	}
}

280 
	$g¨t_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

281 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

283 
sˇâîli°
 *
s
;

284 
i
;

286 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

287 i‡(!
s
->
dma_Àngth
 || !s->
Àngth
)

289 
	`g¨t_unm≠_∑ge
(
dev
, 
s
->
dma_addªss
, s->
dma_Àngth
, 
dú
, 
NULL
);

291 
	}
}

294 
	$dma_m≠_sg_n⁄f‹˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

295 
√¡s
, 
dú
)

297 
sˇâîli°
 *
s
;

298 
i
;

300 #ifde‡
CONFIG_IOMMU_DEBUG


301 
	`¥_debug
("dma_map_sg overflow\n");

304 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

305 
addr
 = 
	`sg_phys
(
s
);

307 i‡(
	`n⁄f‹˚d_iommu
(
dev
, 
addr
, 
s
->
Àngth
)) {

308 
addr
 = 
	`dma_m≠_¨ó
(
dev
,áddr, 
s
->
Àngth
, 
dú
, 0);

309 i‡(
addr
 =
bad_dma_addr
) {

310 i‡(
i
 > 0)

311 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
i
, 
dú
, 
NULL
);

312 
√¡s
 = 0;

313 
sg
[0].
dma_Àngth
 = 0;

317 
s
->
dma_addªss
 = 
addr
;

318 
s
->
dma_Àngth
 = s->
Àngth
;

320 
	`Êush_g¨t
();

322  
√¡s
;

323 
	}
}

326 
	$__dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
,

327 
√Àms
, 
sˇâîli°
 *
sout
,

328 
∑ges
)

330 
iommu_°¨t
 = 
	`Æloc_iommu
(
dev
, 
∑ges
, 0);

331 
iommu_∑ge
 = 
iommu_°¨t
;

332 
sˇâîli°
 *
s
;

333 
i
;

335 i‡(
iommu_°¨t
 == -1)

338 
	`f‹_óch_sg
(
°¨t
, 
s
, 
√Àms
, 
i
) {

339 
∑ges
, 
addr
;

340 
phys_addr
 = 
s
->
dma_addªss
;

342 
	`BUG_ON
(
s
 !
°¨t
 && s->
off£t
);

343 i‡(
s
 =
°¨t
) {

344 
sout
->
dma_addªss
 = 
iommu_bus_ba£
;

345 
sout
->
dma_addªss
 +
iommu_∑ge
*
PAGE_SIZE
 + 
s
->
off£t
;

346 
sout
->
dma_Àngth
 = 
s
->
Àngth
;

348 
sout
->
dma_Àngth
 +
s
->
Àngth
;

351 
addr
 = 
phys_addr
;

352 
∑ges
 = 
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

353 
∑ges
--) {

354 
iommu_g©t_ba£
[
iommu_∑ge
] = 
	`GPTE_ENCODE
(
addr
);

355 
addr
 +
PAGE_SIZE
;

356 
iommu_∑ge
++;

359 
	`BUG_ON
(
iommu_∑ge
 - 
iommu_°¨t
 !
∑ges
);

362 
	}
}

364 
ölöe
 

365 
	$dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
, 
√Àms
,

366 
sˇâîli°
 *
sout
, 
∑ges
, 
√ed
)

368 i‡(!
√ed
) {

369 
	`BUG_ON
(
√Àms
 != 1);

370 
sout
->
dma_addªss
 = 
°¨t
->dma_address;

371 
sout
->
dma_Àngth
 = 
°¨t
->
Àngth
;

374  
	`__dma_m≠_c⁄t
(
dev
, 
°¨t
, 
√Àms
, 
sout
, 
∑ges
);

375 
	}
}

381 
	$g¨t_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

382 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

384 
sˇâîli°
 *
s
, *
ps
, *
°¨t_sg
, *
sgm≠
;

385 
√ed
 = 0, 
√xäìd
, 
i
, 
out
, 
°¨t
;

386 
∑ges
 = 0;

387 
£g_size
;

388 
max_£g_size
;

390 i‡(
√¡s
 == 0)

393 i‡(!
dev
)

394 
dev
 = &
x86_dma_ÁŒback_dev
;

396 
out
 = 0;

397 
°¨t
 = 0;

398 
°¨t_sg
 = 
sg
;

399 
sgm≠
 = 
sg
;

400 
£g_size
 = 0;

401 
max_£g_size
 = 
	`dma_gë_max_£g_size
(
dev
);

402 
ps
 = 
NULL
;

404 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

405 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

407 
s
->
dma_addªss
 = 
addr
;

408 
	`BUG_ON
(
s
->
Àngth
 == 0);

410 
√xäìd
 = 
	`√ed_iommu
(
dev
, 
addr
, 
s
->
Àngth
);

413 i‡(
i
 > 
°¨t
) {

419 i‡(!
iommu_mîge
 || !
√xäìd
 || !
√ed
 || 
s
->
off£t
 ||

420 (
s
->
Àngth
 + 
£g_size
 > 
max_£g_size
) ||

421 (
ps
->
off£t
 +Ös->
Àngth
Ë% 
PAGE_SIZE
) {

422 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
,

423 
sgm≠
, 
∑ges
, 
√ed
) < 0)

424 
îr‹
;

425 
out
++;

427 
£g_size
 = 0;

428 
sgm≠
 = 
	`sg_√xt
(sgmap);

429 
∑ges
 = 0;

430 
°¨t
 = 
i
;

431 
°¨t_sg
 = 
s
;

435 
£g_size
 +
s
->
Àngth
;

436 
√ed
 = 
√xäìd
;

437 
∑ges
 +
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

438 
ps
 = 
s
;

440 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
, 
sgm≠
, 
∑ges
, 
√ed
) < 0)

441 
îr‹
;

442 
out
++;

443 
	`Êush_g¨t
();

444 i‡(
out
 < 
√¡s
) {

445 
sgm≠
 = 
	`sg_√xt
(sgmap);

446 
sgm≠
->
dma_Àngth
 = 0;

448  
out
;

450 
îr‹
:

451 
	`Êush_g¨t
();

452 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
out
, 
dú
, 
NULL
);

455 i‡(
f‹˚_iommu
 || 
iommu_mîge
) {

456 
out
 = 
	`dma_m≠_sg_n⁄f‹˚
(
dev
, 
sg
, 
√¡s
, 
dú
);

457 i‡(
out
 > 0)

458  
out
;

460 i‡(
∑nic_⁄_ovîÊow
)

461 
	`∑nic
("dma_m≠_sg: ovîÊow o¿%luÖages\n", 
∑ges
);

463 
	`iommu_fuŒ
(
dev
, 
∑ges
 << 
PAGE_SHIFT
, 
dú
);

464 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
)

465 
s
->
dma_addªss
 = 
bad_dma_addr
;

467 
	}
}

471 
	$g¨t_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

472 
gÂ_t
 
Êag
)

474 
dma_addr_t
 
∑ddr
;

475 
Æign_mask
;

476 
∑ge
 *page;

478 i‡(
f‹˚_iommu
 && !(
Êag
 & 
GFP_DMA
)) {

479 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

480 
∑ge
 = 
	`Æloc_∑ges
(
Êag
 | 
__GFP_ZERO
, 
	`gë_‹dî
(
size
));

481 i‡(!
∑ge
)

482  
NULL
;

484 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

485 
∑ddr
 = 
	`dma_m≠_¨ó
(
dev
, 
	`∑ge_to_phys
(
∑ge
), 
size
,

486 
DMA_BIDIRECTIONAL
, 
Æign_mask
);

488 
	`Êush_g¨t
();

489 i‡(
∑ddr
 !
bad_dma_addr
) {

490 *
dma_addr
 = 
∑ddr
;

491  
	`∑ge_addªss
(
∑ge
);

493 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

495  
	`dma_gíîic_Æloc_cohîít
(
dev
, 
size
, 
dma_addr
, 
Êag
);

497  
NULL
;

498 
	}
}

502 
	$g¨t_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

503 
dma_addr_t
 
dma_addr
)

505 
	`g¨t_unm≠_∑ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

506 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

507 
	}
}

509 
	$g¨t_m≠pög_îr‹
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
)

511  (
dma_addr
 =
bad_dma_addr
);

512 
	}
}

514 
	gno_agp
;

516 
__öô
 
	$check_iommu_size
(
≠î
, 
u64
 
≠î_size
)

518 
a
;

520 i‡(!
iommu_size
) {

521 
iommu_size
 = 
≠î_size
;

522 i‡(!
no_agp
)

523 
iommu_size
 /= 2;

526 
a
 = 
≠î
 + 
iommu_size
;

527 
iommu_size
 -
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -á;

529 i‡(
iommu_size
 < 64*1024*1024) {

530 
	`¥_w¨nög
(

533 
iommu_size
 >> 20);

536  
iommu_size
;

537 
	}
}

539 
__öô
 
	$ªad_≠îtuª
(
pci_dev
 *
dev
, 
u32
 *
size
)

541 
≠î_size
 = 0, 
≠î_ba£_32
, 
≠î_‹dî
;

542 
u64
 
≠î_ba£
;

544 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
≠î_ba£_32
);

545 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
≠î_‹dî
);

546 
≠î_‹dî
 = (aper_order >> 1) & 7;

548 
≠î_ba£
 = 
≠î_ba£_32
 & 0x7fff;

549 
≠î_ba£
 <<= 25;

551 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

552 i‡(
≠î_ba£
 + 
≠î_size
 > 0x100000000UL || !aper_size)

553 
≠î_ba£
 = 0;

555 *
size
 = 
≠î_size
;

556  
≠î_ba£
;

557 
	}
}

559 
	$íabÀ_g¨t_å™¶©i⁄s
()

561 
i
;

563 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

564 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

566 
	`íabÀ_g¨t_å™¶©i⁄
(
dev
, 
	`__∑
(
agp_g©t_èbÀ
));

570 
	`k8_Êush_g¨ts
();

571 
	}
}

577 
boﬁ
 
	gfix_up_n‹th_bridges
;

578 
u32
 
	g≠îtuª_‹dî
;

579 
u32
 
	g≠îtuª_Æloc
;

581 
	$£t_up_g¨t_ªsume
(
u32
 
≠î_‹dî
, u32 
≠î_Æloc
)

583 
fix_up_n‹th_bridges
 = 
åue
;

584 
≠îtuª_‹dî
 = 
≠î_‹dî
;

585 
≠îtuª_Æloc
 = 
≠î_Æloc
;

586 
	}
}

588 
	$g¨t_fixup_n‹thbridges
(
sys_devi˚
 *
dev
)

590 
i
;

592 i‡(!
fix_up_n‹th_bridges
)

595 
	`¥_öfo
("PCI-DMA: Restoring GARTáperture settings\n");

597 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

598 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

604 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
≠îtuª_‹dî
 << 1);

605 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, 
≠îtuª_Æloc
 >> 25);

607 
	}
}

609 
	$g¨t_ªsume
(
sys_devi˚
 *
dev
)

611 
	`¥_öfo
("PCI-DMA: Resuming GART IOMMU\n");

613 
	`g¨t_fixup_n‹thbridges
(
dev
);

615 
	`íabÀ_g¨t_å™¶©i⁄s
();

618 
	}
}

620 
	$g¨t_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

623 
	}
}

625 
sysdev_˛ass
 
	gg¨t_sysdev_˛ass
 = {

626 .
«me
 = "gart",

627 .
	gsu•íd
 = 
g¨t_su•íd
,

628 .
	gªsume
 = 
g¨t_ªsume
,

632 
sys_devi˚
 
	gdevi˚_g¨t
 = {

633 .
˛s
 = &
g¨t_sysdev_˛ass
,

640 
__öô
 
	$öô_k8_g©t
(
agp_kîn_öfo
 *
öfo
)

642 
≠î_size
, 
g©t_size
, 
√w_≠î_size
;

643 
≠î_ba£
, 
√w_≠î_ba£
;

644 
pci_dev
 *
dev
;

645 *
g©t
;

646 
i
, 
îr‹
;

648 
	`¥_öfo
("PCI-DMA: Disabling AGP.\n");

650 
≠î_size
 = 
≠î_ba£
 = 
öfo
->aper_size = 0;

651 
dev
 = 
NULL
;

652 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

653 
dev
 = 
k8_n‹thbridges
[
i
];

654 
√w_≠î_ba£
 = 
	`ªad_≠îtuª
(
dev
, &
√w_≠î_size
);

655 i‡(!
√w_≠î_ba£
)

656 
nommu
;

658 i‡(!
≠î_ba£
) {

659 
≠î_size
 = 
√w_≠î_size
;

660 
≠î_ba£
 = 
√w_≠î_ba£
;

662 i‡(
≠î_size
 !
√w_≠î_size
 || 
≠î_ba£
 !
√w_≠î_ba£
)

663 
nommu
;

665 i‡(!
≠î_ba£
)

666 
nommu
;

668 
öfo
->
≠î_ba£
 =áper_base;

669 
öfo
->
≠î_size
 =áper_size >> 20;

671 
g©t_size
 = (
≠î_size
 >> 
PAGE_SHIFT
Ë* (
u32
);

672 
g©t
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

673 
	`gë_‹dî
(
g©t_size
));

674 i‡(!
g©t
)

675 
	`∑nic
("Cannotállocate GATTÅable");

676 i‡(
	`£t_mem‹y_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

677 
	`∑nic
("CouldÇot set GART PTEsÅo uncacheableÖages");

679 
agp_g©t_èbÀ
 = 
g©t
;

681 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
g¨t_sysdev_˛ass
);

682 i‡(!
îr‹
)

683 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_g¨t
);

684 i‡(
îr‹
)

685 
	`∑nic
("CouldÇotÑegister gart_sysdev -- "

688 
	`Êush_g¨t
();

690 
	`¥_öfo
("PCI-DMA:áperture base @ %x size %u KB\n",

691 
≠î_ba£
, 
≠î_size
>>10);

695 
nommu
:

697 
	`¥_w¨nög
("PCI-DMA: MoreÅhan 4GB of RAMándÇo IOMMU\n"

700 
	}
}

702 
dma_m≠_›s
 
	gg¨t_dma_›s
 = {

703 .
m≠_sg
 = 
g¨t_m≠_sg
,

704 .
	gunm≠_sg
 = 
g¨t_unm≠_sg
,

705 .
	gm≠_∑ge
 = 
g¨t_m≠_∑ge
,

706 .
	gunm≠_∑ge
 = 
g¨t_unm≠_∑ge
,

707 .
	gÆloc_cohîít
 = 
g¨t_Æloc_cohîít
,

708 .
	g‰ì_cohîít
 = 
g¨t_‰ì_cohîít
,

709 .
	gm≠pög_îr‹
 = 
g¨t_m≠pög_îr‹
,

712 
	$g¨t_iommu_shutdown
()

714 
pci_dev
 *
dev
;

715 
i
;

718 i‡(!
no_agp
)

721 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

722 
u32
 
˘l
;

724 
dev
 = 
k8_n‹thbridges
[
i
];

725 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
˘l
);

727 
˘l
 &~
GARTEN
;

729 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
˘l
);

731 
	}
}

733 
__öô
 
	$g¨t_iommu_öô
()

735 
agp_kîn_öfo
 
öfo
;

736 
iommu_°¨t
;

737 
≠î_ba£
, 
≠î_size
;

738 
°¨t_p‚
, 
íd_p‚
;

739 
s¸©ch
;

740 
i
;

742 i‡(
num_k8_n‹thbridges
 == 0)

745 #i‚de‡
CONFIG_AGP_AMD64


746 
no_agp
 = 1;

750 
no_agp
 =Ço_agp ||

751 (
	`agp_amd64_öô
() < 0) ||

752 (
	`agp_c›y_öfo
(
agp_bridge
, &
öfo
) < 0);

755 i‡(
no_iommu
 ||

756 (!
f‹˚_iommu
 && 
max_p‚
 <
MAX_DMA32_PFN
) ||

757 !
g¨t_iommu_≠îtuª
 ||

758 (
no_agp
 && 
	`öô_k8_g©t
(&
öfo
) < 0)) {

759 i‡(
max_p‚
 > 
MAX_DMA32_PFN
) {

760 
	`¥_w¨nög
("MoreÅhan 4GB of memory but GART IOMMUÇotávailable.\n");

761 
	`¥_w¨nög
("falling backÅo iommu=soft.\n");

767 
≠î_size
 = 
öfo
.aper_size << 20;

768 
≠î_ba£
 = 
öfo
.aper_base;

769 
íd_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
Ë+ (
≠î_size
>>PAGE_SHIFT);

771 i‡(
íd_p‚
 > 
max_low_p‚_m≠≥d
) {

772 
°¨t_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
);

773 
	`öô_mem‹y_m≠pög
(
°¨t_p‚
<<
PAGE_SHIFT
, 
íd_p‚
<<PAGE_SHIFT);

776 
	`¥_öfo
("PCI-DMA: using GART IOMMU.\n");

777 
iommu_size
 = 
	`check_iommu_size
(
öfo
.
≠î_ba£
, 
≠î_size
);

778 
iommu_∑ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

780 
iommu_g¨t_bôm≠
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

781 
	`gë_‹dî
(
iommu_∑ges
/8));

782 i‡(!
iommu_g¨t_bôm≠
)

783 
	`∑nic
("Cannotállocate iommu bitmap\n");

785 #ifde‡
CONFIG_IOMMU_LEAK


786 i‡(
Àak_åa˚
) {

787 
ªt
;

789 
ªt
 = 
	`dma_debug_ªsize_íåõs
(
iommu_∑ges
);

790 i‡(
ªt
)

791 
	`¥_debug
("PCI-DMA: CannotÅraceállÅheÉntries\n");

799 
	`bôm≠_£t
(
iommu_g¨t_bôm≠
, 0, 
EMERGENCY_PAGES
);

801 
	`¥_öfo
("PCI-DMA: Reserving %luMB of IOMMUárea inÅhe AGPáperture\n",

802 
iommu_size
 >> 20);

804 
agp_mem‹y_ª£rved
 = 
iommu_size
;

805 
iommu_°¨t
 = 
≠î_size
 - 
iommu_size
;

806 
iommu_bus_ba£
 = 
öfo
.
≠î_ba£
 + 
iommu_°¨t
;

807 
bad_dma_addr
 = 
iommu_bus_ba£
;

808 
iommu_g©t_ba£
 = 
agp_g©t_èbÀ
 + (
iommu_°¨t
>>
PAGE_SHIFT
);

819 
	`£t_mem‹y_≈
(()
	`__va
(
iommu_bus_ba£
),

820 
iommu_size
 >> 
PAGE_SHIFT
);

829 
	`wbövd
();

837 
	`íabÀ_g¨t_å™¶©i⁄s
();

845 
s¸©ch
 = 
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

846 i‡(!
s¸©ch
)

847 
	`∑nic
("Cannotállocate iommu scratchÖage");

848 
g¨t_unm≠≥d_íåy
 = 
	`GPTE_ENCODE
(
	`__∑
(
s¸©ch
));

849 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_∑ges
; i++)

850 
iommu_g©t_ba£
[
i
] = 
g¨t_unm≠≥d_íåy
;

852 
	`Êush_g¨t
();

853 
dma_›s
 = &
g¨t_dma_›s
;

854 
x86_∂©f‹m
.
iommu_shutdown
 = 
g¨t_iommu_shutdown
;

855 
swiŸlb
 = 0;

858 
	}
}

860 
__öô
 
	$g¨t_∑r£_›ti⁄s
(*
p
)

862 
¨g
;

864 #ifde‡
CONFIG_IOMMU_LEAK


865 i‡(!
	`°∫cmp
(
p
, "leak", 4)) {

866 
Àak_åa˚
 = 1;

867 
p
 += 4;

868 i‡(*
p
 == '=')

869 ++
p
;

870 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

871 
iommu_Àak_∑ges
 = 
¨g
;

874 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

875 
iommu_size
 = 
¨g
;

876 i‡(!
	`°∫cmp
(
p
, "fullflush", 9))

877 
iommu_fuŒÊush
 = 1;

878 i‡(!
	`°∫cmp
(
p
, "nofullflush", 11))

879 
iommu_fuŒÊush
 = 0;

880 i‡(!
	`°∫cmp
(
p
, "noagp", 5))

881 
no_agp
 = 1;

882 i‡(!
	`°∫cmp
(
p
, "noaperture", 10))

883 
fix_≠îtuª
 = 0;

885 i‡(!
	`°∫cmp
(
p
, "force", 5))

886 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

887 i‡(!
	`°∫cmp
(
p
, "allowed", 7))

888 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

889 i‡(!
	`°∫cmp
(
p
, "memaper", 7)) {

890 
ÁŒback_≠î_f‹˚
 = 1;

891 
p
 += 7;

892 i‡(*
p
 == '=') {

893 ++
p
;

894 i‡(
	`gë_›ti⁄
(&
p
, &
¨g
))

895 
ÁŒback_≠î_‹dî
 = 
¨g
;

898 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<löux/dma-m≠pög.h
>

4 
	~<löux/sˇâîli°.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/gÂ.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/mm.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/iommu.h
>

13 
	~<asm/dma.h
>

16 
	$check_addr
(*
«me
, 
devi˚
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

18 i‡(
hwdev
 && !
	`dma_ˇ∑bÀ
(hwdev, 
bus
, 
size
)) {

19 i‡(*
hwdev
->
dma_mask
 >
	`DMA_BIT_MASK
(32))

20 
	`¥ötk
(
KERN_ERR


22 
«me
, ()
bus
, 
size
,

23 ()*
hwdev
->
dma_mask
);

27 
	}
}

29 
dma_addr_t
 
	$nommu_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

30 
off£t
, 
size_t
 
size
,

31 
dma_d©a_dúe˘i⁄
 
dú
,

32 
dma_©ås
 *
©ås
)

34 
dma_addr_t
 
bus
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

35 
	`WARN_ON
(
size
 == 0);

36 i‡(!
	`check_addr
("m≠_sögÀ", 
dev
, 
bus
, 
size
))

37  
DMA_ERROR_CODE
;

38 
	`Êush_wrôe_buf„rs
();

39  
bus
;

40 
	}
}

57 
	$nommu_m≠_sg
(
devi˚
 *
hwdev
, 
sˇâîli°
 *
sg
,

58 
√¡s
, 
dma_d©a_dúe˘i⁄
 
dú
,

59 
dma_©ås
 *
©ås
)

61 
sˇâîli°
 *
s
;

62 
i
;

64 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

66 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

67 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

68 
s
->
dma_addªss
 = 
	`sg_phys
(s);

69 i‡(!
	`check_addr
("m≠_sg", 
hwdev
, 
s
->
dma_addªss
, s->
Àngth
))

71 
s
->
dma_Àngth
 = s->
Àngth
;

73 
	`Êush_wrôe_buf„rs
();

74  
√¡s
;

75 
	}
}

77 
	$nommu_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

78 
dma_addr_t
 
dma_addr
)

80 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

81 
	}
}

83 
	$nommu_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
,

84 
dma_addr_t
 
addr
, 
size_t
 
size
,

85 
dma_d©a_dúe˘i⁄
 
dú
)

87 
	`Êush_wrôe_buf„rs
();

88 
	}
}

91 
	$nommu_sync_sg_f‹_devi˚
(
devi˚
 *
dev
,

92 
sˇâîli°
 *
sg
, 
√Àms
,

93 
dma_d©a_dúe˘i⁄
 
dú
)

95 
	`Êush_wrôe_buf„rs
();

96 
	}
}

98 
dma_m≠_›s
 
	gnommu_dma_›s
 = {

99 .
Æloc_cohîít
 = 
dma_gíîic_Æloc_cohîít
,

100 .
	g‰ì_cohîít
 = 
nommu_‰ì_cohîít
,

101 .
	gm≠_sg
 = 
nommu_m≠_sg
,

102 .
	gm≠_∑ge
 = 
nommu_m≠_∑ge
,

103 .
	gsync_sögÀ_f‹_devi˚
 = 
nommu_sync_sögÀ_f‹_devi˚
,

104 .
	gsync_sg_f‹_devi˚
 = 
nommu_sync_sg_f‹_devi˚
,

105 .
	gis_phys
 = 1,

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<löux/pci.h
>

4 
	~<löux/ˇche.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/swiŸlb.h
>

7 
	~<löux/boŸmem.h
>

8 
	~<löux/dma-m≠pög.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiŸlb.h
>

12 
	~<asm/dma.h
>

14 
swiŸlb
 
	g__ªad_mo°ly
;

16 *
	$x86_swiŸlb_Æloc_cohîít
(
devi˚
 *
hwdev
, 
size_t
 
size
,

17 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êags
)

19 *
vaddr
;

21 
vaddr
 = 
	`dma_gíîic_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

22 i‡(
vaddr
)

23  
vaddr
;

25  
	`swiŸlb_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

26 
	}
}

28 
dma_m≠_›s
 
	gswiŸlb_dma_›s
 = {

29 .
m≠pög_îr‹
 = 
swiŸlb_dma_m≠pög_îr‹
,

30 .
	gÆloc_cohîít
 = 
x86_swiŸlb_Æloc_cohîít
,

31 .
	g‰ì_cohîít
 = 
swiŸlb_‰ì_cohîít
,

32 .
	gsync_sögÀ_f‹_˝u
 = 
swiŸlb_sync_sögÀ_f‹_˝u
,

33 .
	gsync_sögÀ_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_f‹_devi˚
,

34 .
	gsync_sögÀ_ønge_f‹_˝u
 = 
swiŸlb_sync_sögÀ_ønge_f‹_˝u
,

35 .
	gsync_sögÀ_ønge_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_ønge_f‹_devi˚
,

36 .
	gsync_sg_f‹_˝u
 = 
swiŸlb_sync_sg_f‹_˝u
,

37 .
	gsync_sg_f‹_devi˚
 = 
swiŸlb_sync_sg_f‹_devi˚
,

38 .
	gm≠_sg
 = 
swiŸlb_m≠_sg_©ås
,

39 .
	gunm≠_sg
 = 
swiŸlb_unm≠_sg_©ås
,

40 .
	gm≠_∑ge
 = 
swiŸlb_m≠_∑ge
,

41 .
	gunm≠_∑ge
 = 
swiŸlb_unm≠_∑ge
,

42 .
	gdma_suµ‹ãd
 = 
NULL
,

51 
__öô
 
	$pci_swiŸlb_dëe˘
()

53 
u£_swiŸlb
 = 
swiŸlb
 | 
swiŸlb_f‹˚
;

56 #ifde‡
CONFIG_X86_64


57 i‡(!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
)

58 
swiŸlb
 = 1;

60 i‡(
swiŸlb_f‹˚
)

61 
swiŸlb
 = 1;

63  
u£_swiŸlb
;

64 
	}
}

66 
__öô
 
	$pci_swiŸlb_öô
()

68 i‡(
swiŸlb
) {

69 
	`swiŸlb_öô
(0);

70 
dma_›s
 = &
swiŸlb_dma_›s
;

72 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<löux/∂©f‹m_devi˚.h
>

2 
	~<löux/îr.h
>

3 
	~<löux/öô.h
>

5 
__öô
 
	$add_pc•kr
()

7 
∂©f‹m_devi˚
 *
pd
;

9 
pd
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("pc•kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
Ë? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
devi˚_öôˇŒ
(
add_pc•kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<löux/jiffõs.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/time.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/˝umask.h
>

22 
	~<löux/a˝i_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/m§.h
>

27 
	~<asm/vsysˇŒ.h
>

29 
ölöe
 
u32
 
	$cyc2us
(
u32
 
cy˛es
)

38 
cy˛es
 *= 286;

39  (
cy˛es
 >> 10);

40 
	}
}

42 
	$pmtimî_waô_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
;

46 
a
 =
b
;

47 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
)

48 
	`˝u_ªœx
();

49  
b
;

50 
	}
}

53 
	$pmtimî_waô
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtimî_waô_tick
();

58 
b
 = 
	`öl
(
pmtmr_i›‹t
);

59 
	`˝u_ªœx
();

60 } 
	`cyc2us
(
b
 - 
a
Ë< 
us
);

61 
	}
}

63 
__öô
 
	$n›mtimî_£tup
(*
s
)

65 
pmtmr_i›‹t
 = 0;

67 
	}
}

69 
__£tup
("n›mtimî", 
n›mtimî_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/smp.h
>

5 
	~<löux/¥˘l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/pm.h
>

10 
	~<löux/˛ockchùs.h
>

11 
	~<löux/øndom.h
>

12 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

13 
	~<löux/dmi.h
>

14 
	~<löux/ut¢ame.h
>

15 
	~<åa˚/evíts/powî.h
>

16 
	~<löux/hw_bªakpoöt.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/sysˇŒs.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/i387.h
>

23 
	~<asm/ds.h
>

24 
	~<asm/debugªg.h
>

26 
	gidÀ_hÆt
;

27 
EXPORT_SYMBOL
(
idÀ_hÆt
);

28 
	gidÀ_nomwaô
;

29 
EXPORT_SYMBOL
(
idÀ_nomwaô
);

31 
kmem_ˇche
 *
	gèsk_x°©e_ˇchï
;

33 
	$¨ch_dup_èsk_°ru˘
(
èsk_°ru˘
 *
d°
, èsk_°ru˘ *
§c
)

35 *
d°
 = *
§c
;

36 i‡(
§c
->
thªad
.
x°©e
) {

37 
d°
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

38 
GFP_KERNEL
);

39 i‡(!
d°
->
thªad
.
x°©e
)

40  -
ENOMEM
;

41 
	`WARN_ON
(()
d°
->
thªad
.
x°©e
 & 15);

42 
	`mem˝y
(
d°
->
thªad
.
x°©e
, 
§c
->thªad.x°©e, 
x°©e_size
);

45 
	}
}

47 
	$‰ì_thªad_x°©e
(
èsk_°ru˘
 *
tsk
)

49 i‡(
tsk
->
thªad
.
x°©e
) {

50 
	`kmem_ˇche_‰ì
(
èsk_x°©e_ˇchï
, 
tsk
->
thªad
.
x°©e
);

51 
tsk
->
thªad
.
x°©e
 = 
NULL
;

54 
	`WARN
(
tsk
->
thªad
.
ds_˘x
, "leaking DS context\n");

55 
	}
}

57 
	$‰ì_thªad_öfo
(
thªad_öfo
 *
ti
)

59 
	`‰ì_thªad_x°©e
(
ti
->
èsk
);

60 
	`‰ì_∑ges
(()
ti
, 
	`gë_‹dî
(
THREAD_SIZE
));

61 
	}
}

63 
	$¨ch_èsk_ˇche_öô
()

65 
èsk_x°©e_ˇchï
 =

66 
	`kmem_ˇche_¸óã
("èsk_x°©e", 
x°©e_size
,

67 
	`__Æignof__
(
thªad_x°©e
),

68 
SLAB_PANIC
 | 
SLAB_NOTRACK
, 
NULL
);

69 
	}
}

74 
	$exô_thªad
()

76 
èsk_°ru˘
 *
me
 = 
cuºít
;

77 
thªad_°ru˘
 *
t
 = &
me
->
thªad
;

78 *
bp
 = 
t
->
io_bôm≠_±r
;

80 i‡(
bp
) {

81 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

83 
t
->
io_bôm≠_±r
 = 
NULL
;

84 
	`˛ór_thªad_Êag
(
TIF_IO_BITMAP
);

88 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
t
->
io_bôm≠_max
);

89 
t
->
io_bôm≠_max
 = 0;

90 
	`put_˝u
();

91 
	`k‰ì
(
bp
);

93 
	}
}

95 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

97 
	`show_ªgi°îs
(
ªgs
);

98 
	`show_åa˚
(
NULL
, 
ªgs
, (*)
	`kî√l_°ack_poöãr
(regs),

99 
ªgs
->
bp
);

100 
	}
}

102 
	$show_ªgs_comm⁄
()

104 c⁄° *
bﬂrd
, *
¥odu˘
;

106 
bﬂrd
 = 
	`dmi_gë_sy°em_öfo
(
DMI_BOARD_NAME
);

107 i‡(!
bﬂrd
)

108 
bﬂrd
 = "";

109 
¥odu˘
 = 
	`dmi_gë_sy°em_öfo
(
DMI_PRODUCT_NAME
);

110 i‡(!
¥odu˘
)

111 
¥odu˘
 = "";

113 
	`¥ötk
(
KERN_CONT
 "\n");

114 
	`¥ötk
(
KERN_DEFAULT
 "Pid: %d, comm: %.20s %s %s %.*s %s/%s\n",

115 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

116 
	`öô_ut¢ame
()->
ªÀa£
,

117 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

118 
	`öô_ut¢ame
()->
vîsi⁄
, 
bﬂrd
, 
¥odu˘
);

119 
	}
}

121 
	$Êush_thªad
()

123 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

125 
	`Êush_±ø˚_hw_bªakpoöt
(
tsk
);

126 
	`mem£t
(
tsk
->
thªad
.
és_¨øy
, 0, (tsk->thread.tls_array));

130 
tsk
->
Âu_cou¡î
 = 0;

131 
	`˛ór_Âu
(
tsk
);

132 
	`˛ór_u£d_m©h
();

133 
	}
}

135 
	$h¨d_dißbÀ_TSC
()

137 
	`wrôe_¸4
(
	`ªad_¸4
(Ë| 
X86_CR4_TSD
);

138 
	}
}

140 
	$dißbÀ_TSC
()

142 
	`¥ìm±_dißbÀ
();

143 i‡(!
	`ã°_™d_£t_thªad_Êag
(
TIF_NOTSC
))

148 
	`h¨d_dißbÀ_TSC
();

149 
	`¥ìm±_íabÀ
();

150 
	}
}

152 
	$h¨d_íabÀ_TSC
()

154 
	`wrôe_¸4
(
	`ªad_¸4
(Ë& ~
X86_CR4_TSD
);

155 
	}
}

157 
	$íabÀ_TSC
()

159 
	`¥ìm±_dißbÀ
();

160 i‡(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_NOTSC
))

165 
	`h¨d_íabÀ_TSC
();

166 
	`¥ìm±_íabÀ
();

167 
	}
}

169 
	$gë_tsc_mode
(
adr
)

171 
vÆ
;

173 i‡(
	`ã°_thªad_Êag
(
TIF_NOTSC
))

174 
vÆ
 = 
PR_TSC_SIGSEGV
;

176 
vÆ
 = 
PR_TSC_ENABLE
;

178  
	`put_u£r
(
vÆ
, (
__u£r
 *)
adr
);

179 
	}
}

181 
	$£t_tsc_mode
(
vÆ
)

183 i‡(
vÆ
 =
PR_TSC_SIGSEGV
)

184 
	`dißbÀ_TSC
();

185 i‡(
vÆ
 =
PR_TSC_ENABLE
)

186 
	`íabÀ_TSC
();

188  -
EINVAL
;

191 
	}
}

193 
	$__swôch_to_xåa
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
,

194 
tss_°ru˘
 *
tss
)

196 
thªad_°ru˘
 *
¥ev
, *
√xt
;

198 
¥ev
 = &
¥ev_p
->
thªad
;

199 
√xt
 = &
√xt_p
->
thªad
;

201 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DS_AREA_MSR
) ||

202 
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_DS_AREA_MSR
))

203 
	`ds_swôch_to
(
¥ev_p
, 
√xt_p
);

204 i‡(
√xt
->
debug˘lm§
 !
¥ev
->debugctlmsr)

205 
	`upd©e_debug˘lm§
(
√xt
->
debug˘lm§
);

207 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_NOTSC
) ^

208 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
)) {

210 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
))

211 
	`h¨d_dißbÀ_TSC
();

213 
	`h¨d_íabÀ_TSC
();

216 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_IO_BITMAP
)) {

221 
	`mem˝y
(
tss
->
io_bôm≠
, 
√xt
->
io_bôm≠_±r
,

222 
	`max
(
¥ev
->
io_bôm≠_max
, 
√xt
->io_bitmap_max));

223 } i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_IO_BITMAP
)) {

227 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
¥ev
->
io_bôm≠_max
);

229 
	`¥›ag©e_u£r_ªtu∫_nŸify
(
¥ev_p
, 
√xt_p
);

230 
	}
}

232 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

234  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0, 
NULL
, NULL);

235 
	}
}

247 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

249  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0,

250 
NULL
, NULL);

251 
	}
}

254 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

255 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
, 
±_ªgs
 *
ªgs
)

257 i‡(!
√w•
)

258 
√w•
 = 
ªgs
->
•
;

259  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

260 
	}
}

267 
kî√l_thªad_hñ≥r
();

272 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
Êags
)

274 
±_ªgs
 
ªgs
;

276 
	`mem£t
(&
ªgs
, 0, (regs));

278 
ªgs
.
si
 = (Ë
‚
;

279 
ªgs
.
di
 = (Ë
¨g
;

281 #ifde‡
CONFIG_X86_32


282 
ªgs
.
ds
 = 
__USER_DS
;

283 
ªgs
.
es
 = 
__USER_DS
;

284 
ªgs
.
fs
 = 
__KERNEL_PERCPU
;

285 
ªgs
.
gs
 = 
__KERNEL_STACK_CANARY
;

287 
ªgs
.
ss
 = 
__KERNEL_DS
;

290 
ªgs
.
‹ig_ax
 = -1;

291 
ªgs
.
ù
 = (Ë
kî√l_thªad_hñ≥r
;

292 
ªgs
.
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

293 
ªgs
.
Êags
 = 
X86_EFLAGS_IF
 | 0x2;

296  
	`do_f‹k
(
Êags
 | 
CLONE_VM
 | 
CLONE_UNTRACED
, 0, &
ªgs
, 0, 
NULL
, NULL);

297 
	}
}

298 
EXPORT_SYMBOL
(
kî√l_thªad
);

303 
	$sys_execve
(
__u£r
 *
«me
, __u£∏* __u£∏*
¨gv
,

304 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

306 
îr‹
;

307 *
fûíame
;

309 
fûíame
 = 
	`gë«me
(
«me
);

310 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

311 i‡(
	`IS_ERR
(
fûíame
))

312  
îr‹
;

313 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

315 #ifde‡
CONFIG_X86_32


316 i‡(
îr‹
 == 0) {

318 
	`£t_thªad_Êag
(
TIF_IRET
);

322 
	`puäame
(
fûíame
);

323  
îr‹
;

324 
	}
}

329 
	gboŸ_›ti⁄_idÀ_ovîride
 = 0;

330 
EXPORT_SYMBOL
(
boŸ_›ti⁄_idÀ_ovîride
);

335 (*
pm_idÀ
)();

336 
	`EXPORT_SYMBOL
(
pm_idÀ
);

338 #ifde‡
CONFIG_X86_32


343 
h…_cou¡î
;

344 
	$dißbÀ_h…
()

346 
h…_cou¡î
++;

347 
	}
}

348 
EXPORT_SYMBOL
(
dißbÀ_h…
);

350 
	$íabÀ_h…
()

352 
h…_cou¡î
--;

353 
	}
}

354 
EXPORT_SYMBOL
(
íabÀ_h…
);

356 
ölöe
 
	$h…_u£_hÆt
()

358  (!
h…_cou¡î
 && 
boŸ_˝u_d©a
.
h…_w‹ks_ok
);

359 
	}
}

361 
ölöe
 
	$h…_u£_hÆt
()

364 
	}
}

371 
	$deÁu…_idÀ
()

373 i‡(
	`h…_u£_hÆt
()) {

374 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

375 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_POLLING
;

380 
	`smp_mb
();

382 i‡(!
	`√ed_ªsched
())

383 
	`ß„_hÆt
();

385 
	`loˇl_úq_íabÀ
();

386 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

388 
	`loˇl_úq_íabÀ
();

390 
	`˝u_ªœx
();

392 
	}
}

393 #ifde‡
CONFIG_APM_MODULE


394 
EXPORT_SYMBOL
(
deÁu…_idÀ
);

397 
	$°›_this_˝u
(*
dummy
)

399 
	`loˇl_úq_dißbÀ
();

403 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
Ál£
);

404 
	`dißbÀ_loˇl_APIC
();

407 i‡(
	`h…_w‹ks
(
	`smp_¥o˚ss‹_id
()))

408 
	`hÆt
();

410 
	}
}

412 
	$do_nŸhög
(*
unu£d
)

414 
	}
}

424 
	$˝u_idÀ_waô
()

426 
	`smp_mb
();

428 
	`smp_ˇŒ_fun˘i⁄
(
do_nŸhög
, 
NULL
, 1);

429 
	}
}

430 
EXPORT_SYMBOL_GPL
(
˝u_idÀ_waô
);

442 
	$mwaô_idÀ_wôh_höts
(
ax
, 
cx
)

444 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, (
ax
>>4)+1);

445 i‡(!
	`√ed_ªsched
()) {

446 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

447 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

449 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

450 
	`smp_mb
();

451 i‡(!
	`√ed_ªsched
())

452 
	`__mwaô
(
ax
, 
cx
);

454 
	}
}

457 
	$mwaô_idÀ
()

459 i‡(!
	`√ed_ªsched
()) {

460 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

461 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

462 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

464 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

465 
	`smp_mb
();

466 i‡(!
	`√ed_ªsched
())

467 
	`__°i_mwaô
(0, 0);

469 
	`loˇl_úq_íabÀ
();

471 
	`loˇl_úq_íabÀ
();

472 
	}
}

479 
	$pﬁl_idÀ
()

481 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 0);

482 
	`loˇl_úq_íabÀ
();

483 !
	`√ed_ªsched
())

484 
	`˝u_ªœx
();

485 
	`åa˚_powî_íd
(0);

486 
	}
}

500 
__˝uöôd©a
 
	gf‹˚_mwaô
;

502 
	#MWAIT_INFO
 0x05

	)

503 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

504 
	#MWAIT_EDX_C1
 0xf0

	)

506 
__˝uöô
 
	$mwaô_ußbÀ
(c⁄° 
˝uöfo_x86
 *
c
)

508 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

510 i‡(
f‹˚_mwaô
)

513 i‡(
c
->
˝uid_Àvñ
 < 
MWAIT_INFO
)

516 
	`˝uid
(
MWAIT_INFO
, &
óx
, &
ebx
, &
ecx
, &
edx
);

518 i‡(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

525  (
edx
 & 
MWAIT_EDX_C1
);

526 
	}
}

534 
__˝uöô
 
	$check_c1e_idÀ
(c⁄° 
˝uöfo_x86
 *
c
)

536 
u64
 
vÆ
;

537 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
)

538 
no_c1e_idÀ
;

541 i‡(
c
->
x86
 =0x0F && c->
x86_modñ
 >= 0x40)

544 i‡(
c
->
x86
 == 0x10) {

549 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_OSVW
)) {

550 
	`rdm§l
(
MSR_AMD64_OSVW_ID_LENGTH
, 
vÆ
);

551 i‡(
vÆ
 >= 2) {

552 
	`rdm§l
(
MSR_AMD64_OSVW_STATUS
, 
vÆ
);

553 i‡(!(
vÆ
 & 
	`BIT
(1)))

554 
no_c1e_idÀ
;

560 
no_c1e_idÀ
:

562 
	}
}

564 
˝umask_v¨_t
 
	gc1e_mask
;

565 
	gc1e_dëe˘ed
;

567 
	$c1e_ªmove_˝u
(
˝u
)

569 i‡(
c1e_mask
 !
NULL
)

570 
	`˝umask_˛ór_˝u
(
˝u
, 
c1e_mask
);

571 
	}
}

578 
	$c1e_idÀ
()

580 i‡(
	`√ed_ªsched
())

583 i‡(!
c1e_dëe˘ed
) {

584 
u32
 
lo
, 
hi
;

586 
	`rdm§
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

587 i‡(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

588 
c1e_dëe˘ed
 = 1;

589 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_NONSTOP_TSC
))

590 
	`m¨k_tsc_un°abÀ
("TSC halt in AMD C1E");

591 
	`¥ötk
(
KERN_INFO
 "System has AMD C1EÉnabled\n");

592 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_AMDC1E
);

596 i‡(
c1e_dëe˘ed
) {

597 
˝u
 = 
	`smp_¥o˚ss‹_id
();

599 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
c1e_mask
)) {

600 
	`˝umask_£t_˝u
(
˝u
, 
c1e_mask
);

604 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

605 &
˝u
);

606 
	`¥ötk
(
KERN_INFO
 "SwitchÅo broadcast mode on CPU%d\n",

607 
˝u
);

609 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
˝u
);

611 
	`deÁu…_idÀ
();

617 
	`loˇl_úq_dißbÀ
();

618 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
˝u
);

619 
	`loˇl_úq_íabÀ
();

621 
	`deÁu…_idÀ
();

622 
	}
}

624 
__˝uöô
 
	$£À˘_idÀ_routöe
(c⁄° 
˝uöfo_x86
 *
c
)

626 #ifde‡
CONFIG_SMP


627 i‡(
pm_idÀ
 =
pﬁl_idÀ
 && 
smp_num_siblögs
 > 1) {

628 
	`¥ötk_⁄˚
(
KERN_WARNING
 "WARNING:Öolling idleánd HTÉnabled,"

632 i‡(
pm_idÀ
)

635 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
Ë&& 
	`mwaô_ußbÀ
(c)) {

639 
	`¥ötk
(
KERN_INFO
 "using mwait in idleÅhreads.\n");

640 
pm_idÀ
 = 
mwaô_idÀ
;

641 } i‡(
	`check_c1e_idÀ
(
c
)) {

642 
	`¥ötk
(
KERN_INFO
 "using C1Eáware idleÑoutine\n");

643 
pm_idÀ
 = 
c1e_idÀ
;

645 
pm_idÀ
 = 
deÁu…_idÀ
;

646 
	}
}

648 
__öô
 
	$öô_c1e_mask
()

651 i‡(
pm_idÀ
 =
c1e_idÀ
)

652 
	`zÆloc_˝umask_v¨
(&
c1e_mask
, 
GFP_KERNEL
);

653 
	}
}

655 
__öô
 
	$idÀ_£tup
(*
°r
)

657 i‡(!
°r
)

658  -
EINVAL
;

660 i‡(!
	`°rcmp
(
°r
, "poll")) {

661 
	`¥ötk
("usingÖolling idleÅhreads.\n");

662 
pm_idÀ
 = 
pﬁl_idÀ
;

663 } i‡(!
	`°rcmp
(
°r
, "mwait"))

664 
f‹˚_mwaô
 = 1;

665 i‡(!
	`°rcmp
(
°r
, "halt")) {

673 
pm_idÀ
 = 
deÁu…_idÀ
;

674 
idÀ_hÆt
 = 1;

676 } i‡(!
	`°rcmp
(
°r
, "nomwait")) {

683 
idÀ_nomwaô
 = 1;

688 
boŸ_›ti⁄_idÀ_ovîride
 = 1;

690 
	}
}

691 
óæy_∑øm
("idÀ", 
idÀ_£tup
);

693 
	$¨ch_Æign_°ack
(
•
)

695 i‡(!(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
Ë&& 
øndomize_va_•a˚
)

696 
•
 -
	`gë_øndom_öt
() % 8192;

697  
•
 & ~0xf;

698 
	}
}

700 
	$¨ch_øndomize_brk
(
mm_°ru˘
 *
mm
)

702 
ønge_íd
 = 
mm
->
brk
 + 0x02000000;

703  
	`øndomize_ønge
(
mm
->
brk
, 
ønge_íd
, 0) ? : mm->brk;

704 
	}
}

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/˝u.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/ñfc‹e.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/u£r.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/dñay.h
>

30 
	~<löux/moduÀ.h
>

31 
	~<löux/±ø˚.h
>

32 
	~<löux/nŸifõr.h
>

33 
	~<löux/k¥obes.h
>

34 
	~<löux/kdebug.h
>

35 
	~<löux/tick.h
>

36 
	~<löux/¥˘l.h
>

37 
	~<löux/uac˚ss.h
>

38 
	~<löux/io.h
>

39 
	~<löux/·ø˚.h
>

41 
	~<asm/pgèbÀ.h
>

42 
	~<asm/sy°em.h
>

43 
	~<asm/¥o˚ss‹.h
>

44 
	~<asm/i387.h
>

45 
	~<asm/mmu_c⁄ãxt.h
>

46 
	~<asm/¥˘l.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/¥Ÿo.h
>

49 
	~<asm/ü32.h
>

50 
	~<asm/idÀ.h
>

51 
	~<asm/sysˇŒs.h
>

52 
	~<asm/ds.h
>

53 
	~<asm/debugªg.h
>

55 
asmlökage
 
ªt_‰om_f‹k
();

57 
DEFINE_PER_CPU
(, 
ﬁd_r•
);

58 
DEFINE_PER_CPU
(, 
is_idÀ
);

60 
ATOMIC_NOTIFIER_HEAD
(
idÀ_nŸifõr
);

62 
	$idÀ_nŸifõr_ªgi°î
(
nŸifõr_block
 *
n
)

64 
	`©omic_nŸifõr_chaö_ªgi°î
(&
idÀ_nŸifõr
, 
n
);

65 
	}
}

66 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_ªgi°î
);

68 
	$idÀ_nŸifõr_uƒegi°î
(
nŸifõr_block
 *
n
)

70 
	`©omic_nŸifõr_chaö_uƒegi°î
(&
idÀ_nŸifõr
, 
n
);

71 
	}
}

72 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_uƒegi°î
);

74 
	$íãr_idÀ
()

76 
	`≥r˝u_wrôe
(
is_idÀ
, 1);

77 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_START
, 
NULL
);

78 
	}
}

80 
	$__exô_idÀ
()

82 i‡(
	`x86_ã°_™d_˛ór_bô_≥r˝u
(0, 
is_idÀ
) == 0)

84 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_END
, 
NULL
);

85 
	}
}

88 
	$exô_idÀ
()

91 i‡(
cuºít
->
pid
)

93 
	`__exô_idÀ
();

94 
	}
}

96 #i‚de‡
CONFIG_SMP


97 
ölöe
 
	$∂ay_dód
()

99 
	`BUG
();

100 
	}
}

109 
	$˝u_idÀ
()

111 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

120 
	`boŸ_öô_°ack_ˇ«ry
();

124 
	`tick_nohz_°›_sched_tick
(1);

125 !
	`√ed_ªsched
()) {

127 
	`rmb
();

129 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
()))

130 
	`∂ay_dód
();

136 
	`loˇl_úq_dißbÀ
();

137 
	`íãr_idÀ
();

139 
	`°›_¸ôiˇl_timögs
();

140 
	`pm_idÀ
();

141 
	`°¨t_¸ôiˇl_timögs
();

145 
	`__exô_idÀ
();

148 
	`tick_nohz_ª°¨t_sched_tick
();

149 
	`¥ìm±_íabÀ_no_ªsched
();

150 
	`scheduÀ
();

151 
	`¥ìm±_dißbÀ
();

153 
	}
}

156 
	$__show_ªgs
(
±_ªgs
 *
ªgs
, 
Æl
)

158 
¸0
 = 0L, 
¸2
 = 0L, 
¸3
 = 0L, 
¸4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

159 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

160 
fsödex
, 
gsödex
;

161 
ds
, 
cs
, 
es
;

163 
	`show_ªgs_comm⁄
();

164 
	`¥ötk
(
KERN_DEFAULT
 "RIP: %04lx:[<%016lx>] ", 
ªgs
->
cs
 & 0xffff,Ñegs->
ù
);

165 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

166 
	`¥ötk
(
KERN_DEFAULT
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
ªgs
->
ss
,

167 
ªgs
->
•
,Ñegs->
Êags
);

168 
	`¥ötk
(
KERN_DEFAULT
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

169 
ªgs
->
ax
,Ñegs->
bx
,Ñegs->
cx
);

170 
	`¥ötk
(
KERN_DEFAULT
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

171 
ªgs
->
dx
,Ñegs->
si
,Ñegs->
di
);

172 
	`¥ötk
(
KERN_DEFAULT
 "RBP: %016lx R08: %016lx R09: %016lx\n",

173 
ªgs
->
bp
,Ñegs->
r8
,Ñegs->
r9
);

174 
	`¥ötk
(
KERN_DEFAULT
 "R10: %016lx R11: %016lx R12: %016lx\n",

175 
ªgs
->
r10
,Ñegs->
r11
,Ñegs->
r12
);

176 
	`¥ötk
(
KERN_DEFAULT
 "R13: %016lx R14: %016lx R15: %016lx\n",

177 
ªgs
->
r13
,Ñegs->
r14
,Ñegs->
r15
);

179 
	`asm
("mov»%%ds,%0" : "Ù" (
ds
));

180 
	`asm
("mov»%%cs,%0" : "Ù" (
cs
));

181 
	`asm
("mov»%%es,%0" : "Ù" (
es
));

182 
	`asm
("mov»%%fs,%0" : "Ù" (
fsödex
));

183 
	`asm
("mov»%%gs,%0" : "Ù" (
gsödex
));

185 
	`rdm§l
(
MSR_FS_BASE
, 
fs
);

186 
	`rdm§l
(
MSR_GS_BASE
, 
gs
);

187 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

189 i‡(!
Æl
)

192 
¸0
 = 
	`ªad_¸0
();

193 
¸2
 = 
	`ªad_¸2
();

194 
¸3
 = 
	`ªad_¸3
();

195 
¸4
 = 
	`ªad_¸4
();

197 
	`¥ötk
(
KERN_DEFAULT
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

198 
fs
, 
fsödex
, 
gs
, 
gsödex
, 
shadowgs
);

199 
	`¥ötk
(
KERN_DEFAULT
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

200 
es
, 
¸0
);

201 
	`¥ötk
(
KERN_DEFAULT
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
¸2
, 
¸3
,

202 
¸4
);

204 
	`gë_debugªg
(
d0
, 0);

205 
	`gë_debugªg
(
d1
, 1);

206 
	`gë_debugªg
(
d2
, 2);

207 
	`¥ötk
(
KERN_DEFAULT
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

208 
	`gë_debugªg
(
d3
, 3);

209 
	`gë_debugªg
(
d6
, 6);

210 
	`gë_debugªg
(
d7
, 7);

211 
	`¥ötk
(
KERN_DEFAULT
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

212 
	}
}

214 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

216 i‡(
dód_èsk
->
mm
) {

217 i‡(
dód_èsk
->
mm
->
c⁄ãxt
.
size
) {

218 
	`¥ötk
("WARNING: deadÖrocess %8s still has LDT? <%p/%d>\n",

219 
dód_èsk
->
comm
,

220 
dód_èsk
->
mm
->
c⁄ãxt
.
ldt
,

221 
dód_èsk
->
mm
->
c⁄ãxt
.
size
);

222 
	`BUG
();

225 
	}
}

227 
ölöe
 
	$£t_32bô_és
(
èsk_°ru˘
 *
t
, 
és
, 
u32
 
addr
)

229 
u£r_desc
 
ud
 = {

230 .
ba£_addr
 = 
addr
,

231 .
limô
 = 0xfffff,

232 .
£g_32bô
 = 1,

233 .
limô_ö_∑ges
 = 1,

234 .
u£abÀ
 = 1,

236 
desc_°ru˘
 *
desc
 = 
t
->
thªad
.
és_¨øy
;

237 
desc
 +
és
;

238 
	`fûl_ldt
(
desc
, &
ud
);

239 
	}
}

241 
ölöe
 
u32
 
	$ªad_32bô_és
(
èsk_°ru˘
 *
t
, 
és
)

243  
	`gë_desc_ba£
(&
t
->
thªad
.
és_¨øy
[
és
]);

244 
	}
}

250 
	$¥ï¨e_to_c›y
(
èsk_°ru˘
 *
tsk
)

252 
	`u∆azy_Âu
(
tsk
);

253 
	}
}

255 
	$c›y_thªad
(
˛⁄e_Êags
, 
•
,

256 
unu£d
,

257 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

259 
îr
;

260 
±_ªgs
 *
chûdªgs
;

261 
èsk_°ru˘
 *
me
 = 
cuºít
;

263 
chûdªgs
 = ((
±_ªgs
 *)

264 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
p
))) - 1;

265 *
chûdªgs
 = *
ªgs
;

267 
chûdªgs
->
ax
 = 0;

268 i‡(
	`u£r_mode
(
ªgs
))

269 
chûdªgs
->
•
 = sp;

271 
chûdªgs
->
•
 = ()childregs;

273 
p
->
thªad
.
•
 = (Ë
chûdªgs
;

274 
p
->
thªad
.
•0
 = (Ë(
chûdªgs
+1);

275 
p
->
thªad
.
u£r•
 = 
me
->thread.usersp;

277 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_FORK
);

279 
p
->
thªad
.
io_bôm≠_±r
 = 
NULL
;

281 
	`ßve£gmít
(
gs
, 
p
->
thªad
.
gsödex
);

282 
p
->
thªad
.
gs
 =Ö->thªad.
gsödex
 ? 0 : 
me
->thread.gs;

283 
	`ßve£gmít
(
fs
, 
p
->
thªad
.
fsödex
);

284 
p
->
thªad
.
fs
 =Ö->thªad.
fsödex
 ? 0 : 
me
->thread.fs;

285 
	`ßve£gmít
(
es
, 
p
->
thªad
.es);

286 
	`ßve£gmít
(
ds
, 
p
->
thªad
.ds);

288 
îr
 = -
ENOMEM
;

289 
	`mem£t
(
p
->
thªad
.
±ø˚_bps
, 0, (p->thread.ptrace_bps));

291 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
me
, 
TIF_IO_BITMAP
))) {

292 
p
->
thªad
.
io_bôm≠_±r
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

293 i‡(!
p
->
thªad
.
io_bôm≠_±r
) {

294 
p
->
thªad
.
io_bôm≠_max
 = 0;

295  -
ENOMEM
;

297 
	`mem˝y
(
p
->
thªad
.
io_bôm≠_±r
, 
me
->thread.io_bitmap_ptr,

298 
IO_BITMAP_BYTES
);

299 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_IO_BITMAP
);

305 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
) {

306 #ifde‡
CONFIG_IA32_EMULATION


307 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

308 
îr
 = 
	`do_£t_thªad_¨ó
(
p
, -1,

309 (
u£r_desc
 
__u£r
 *)
chûdªgs
->
si
, 0);

312 
îr
 = 
	`do_¨ch_¥˘l
(
p
, 
ARCH_SET_FS
, 
chûdªgs
->
r8
);

313 i‡(
îr
)

314 
out
;

317 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DS_AREA_MSR
);

318 
p
->
thªad
.
ds_˘x
 = 
NULL
;

320 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DEBUGCTLMSR
);

321 
p
->
thªad
.
debug˘lm§
 = 0;

323 
îr
 = 0;

324 
out
:

325 i‡(
îr
 && 
p
->
thªad
.
io_bôm≠_±r
) {

326 
	`k‰ì
(
p
->
thªad
.
io_bôm≠_±r
);

327 
p
->
thªad
.
io_bôm≠_max
 = 0;

330  
îr
;

331 
	}
}

334 
	$°¨t_thªad_comm⁄
(
±_ªgs
 *
ªgs
, 
√w_ù
,

335 
√w_•
,

336 
_cs
, 
_ss
, 
_ds
)

338 
	`lﬂd£gmít
(
fs
, 0);

339 
	`lﬂd£gmít
(
es
, 
_ds
);

340 
	`lﬂd£gmít
(
ds
, 
_ds
);

341 
	`lﬂd_gs_ödex
(0);

342 
ªgs
->
ù
 = 
√w_ù
;

343 
ªgs
->
•
 = 
√w_•
;

344 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√w_•
);

345 
ªgs
->
cs
 = 
_cs
;

346 
ªgs
->
ss
 = 
_ss
;

347 
ªgs
->
Êags
 = 
X86_EFLAGS_IF
;

348 
	`£t_fs
(
USER_DS
);

352 
	`‰ì_thªad_x°©e
(
cuºít
);

353 
	}
}

356 
	$°¨t_thªad
(
±_ªgs
 *
ªgs
, 
√w_ù
, 
√w_•
)

358 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

359 
__USER_CS
, 
__USER_DS
, 0);

360 
	}
}

362 #ifde‡
CONFIG_IA32_EMULATION


363 
	$°¨t_thªad_ü32
(
±_ªgs
 *
ªgs
, 
u32
 
√w_ù
, u32 
√w_•
)

365 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

366 
__USER32_CS
, 
__USER32_DS
, __USER32_DS);

367 
	}
}

380 
__nŸø˚_funcgøph
 
èsk_°ru˘
 *

381 
	$__swôch_to
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
)

383 
thªad_°ru˘
 *
¥ev
 = &
¥ev_p
->
thªad
;

384 
thªad_°ru˘
 *
√xt
 = &
√xt_p
->
thªad
;

385 
˝u
 = 
	`smp_¥o˚ss‹_id
();

386 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

387 
fsödex
, 
gsödex
;

388 
boﬁ
 
¥ñﬂd_Âu
;

395 
¥ñﬂd_Âu
 = 
	`tsk_u£d_m©h
(
√xt_p
Ë&&Çext_p->
Âu_cou¡î
 > 5;

398 i‡(
¥ñﬂd_Âu
)

399 
	`¥e„tch
(
√xt
->
x°©e
);

404 
	`lﬂd_•0
(
tss
, 
√xt
);

410 
	`ßve£gmít
(
es
, 
¥ev
->es);

411 i‡(
	`u∆ikñy
(
√xt
->
es
 | 
¥ev
->es))

412 
	`lﬂd£gmít
(
es
, 
√xt
->es);

414 
	`ßve£gmít
(
ds
, 
¥ev
->ds);

415 i‡(
	`u∆ikñy
(
√xt
->
ds
 | 
¥ev
->ds))

416 
	`lﬂd£gmít
(
ds
, 
√xt
->ds);

424 
	`ßve£gmít
(
fs
, 
fsödex
);

425 
	`ßve£gmít
(
gs
, 
gsödex
);

427 
	`lﬂd_TLS
(
√xt
, 
˝u
);

430 
	`u∆azy_Âu
(
¥ev_p
);

433 i‡(
¥ñﬂd_Âu
)

434 
	`˛ts
();

443 
	`¨ch_íd_c⁄ãxt_swôch
(
√xt_p
);

452 i‡(
	`u∆ikñy
(
fsödex
 | 
√xt
->fsödex | 
¥ev
->
fs
)) {

453 
	`lﬂd£gmít
(
fs
, 
√xt
->
fsödex
);

459 i‡(
fsödex
)

460 
¥ev
->
fs
 = 0;

463 i‡(
√xt
->
fs
)

464 
	`wrm§l
(
MSR_FS_BASE
, 
√xt
->
fs
);

465 
¥ev
->
fsödex
 = fsindex;

467 i‡(
	`u∆ikñy
(
gsödex
 | 
√xt
->gsödex | 
¥ev
->
gs
)) {

468 
	`lﬂd_gs_ödex
(
√xt
->
gsödex
);

469 i‡(
gsödex
)

470 
¥ev
->
gs
 = 0;

472 i‡(
√xt
->
gs
)

473 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 
√xt
->
gs
);

474 
¥ev
->
gsödex
 = gsindex;

479 
¥ev
->
u£r•
 = 
	`≥r˝u_ªad
(
ﬁd_r•
);

480 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√xt
->
u£r•
);

481 
	`≥r˝u_wrôe
(
cuºít_èsk
, 
√xt_p
);

483 
	`≥r˝u_wrôe
(
kî√l_°ack
,

484 ()
	`èsk_°ack_∑ge
(
√xt_p
) +

485 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

490 i‡(
	`u∆ikñy
(
	`èsk_thªad_öfo
(
√xt_p
)->
Êags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

491 
	`èsk_thªad_öfo
(
¥ev_p
)->
Êags
 & 
_TIF_WORK_CTXSW_PREV
))

492 
	`__swôch_to_xåa
(
¥ev_p
, 
√xt_p
, 
tss
);

498 i‡(
¥ñﬂd_Âu
)

499 
	`__m©h_°©e_ª°‹e
();

501  
¥ev_p
;

502 
	}
}

504 
	$£t_≥rs⁄Æôy_64bô
()

509 
	`˛ór_thªad_Êag
(
TIF_IA32
);

515 
cuºít
->
≥rs⁄Æôy
 &~
READ_IMPLIES_EXEC
;

516 
	}
}

518 
	$£t_≥rs⁄Æôy_ü32
()

523 
	`£t_thªad_Êag
(
TIF_IA32
);

524 
cuºít
->
≥rs⁄Æôy
 |
f‹˚_≥rs⁄Æôy32
;

527 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_COMPAT
;

528 
	}
}

530 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

532 
°ack
;

533 
u64
 
Â
, 
ù
;

534 
cou¡
 = 0;

536 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

538 
°ack
 = ()
	`èsk_°ack_∑ge
(
p
);

539 i‡(
p
->
thªad
.
•
 < 
°ack
 ||Ö->thªad.• >°ack+
THREAD_SIZE
)

541 
Â
 = *(
u64
 *)(
p
->
thªad
.
•
);

543 i‡(
Â
 < ()
°ack
 ||

544 
Â
 >()
°ack
+
THREAD_SIZE
)

546 
ù
 = *(
u64
 *)(
Â
+8);

547 i‡(!
	`ö_sched_fun˘i⁄s
(
ù
))

548  
ù
;

549 
Â
 = *(
u64
 *)fp;

550 } 
cou¡
++ < 16);

552 
	}
}

554 
	$do_¨ch_¥˘l
(
èsk_°ru˘
 *
èsk
, 
code
, 
addr
)

556 
ªt
 = 0;

557 
doô
 = 
èsk
 =
cuºít
;

558 
˝u
;

560 
code
) {

561 
ARCH_SET_GS
:

562 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

563  -
EPERM
;

564 
˝u
 = 
	`gë_˝u
();

567 i‡(
addr
 <= 0xffffffff) {

568 
	`£t_32bô_és
(
èsk
, 
GS_TLS
, 
addr
);

569 i‡(
doô
) {

570 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

571 
	`lﬂd_gs_ödex
(
GS_TLS_SEL
);

573 
èsk
->
thªad
.
gsödex
 = 
GS_TLS_SEL
;

574 
èsk
->
thªad
.
gs
 = 0;

576 
èsk
->
thªad
.
gsödex
 = 0;

577 
èsk
->
thªad
.
gs
 = 
addr
;

578 i‡(
doô
) {

579 
	`lﬂd_gs_ödex
(0);

580 
ªt
 = 
	`checkög_wrm§l
(
MSR_KERNEL_GS_BASE
, 
addr
);

583 
	`put_˝u
();

585 
ARCH_SET_FS
:

588 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

589  -
EPERM
;

590 
˝u
 = 
	`gë_˝u
();

593 i‡(
addr
 <= 0xffffffff) {

594 
	`£t_32bô_és
(
èsk
, 
FS_TLS
, 
addr
);

595 i‡(
doô
) {

596 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

597 
	`lﬂd£gmít
(
fs
, 
FS_TLS_SEL
);

599 
èsk
->
thªad
.
fsödex
 = 
FS_TLS_SEL
;

600 
èsk
->
thªad
.
fs
 = 0;

602 
èsk
->
thªad
.
fsödex
 = 0;

603 
èsk
->
thªad
.
fs
 = 
addr
;

604 i‡(
doô
) {

607 
	`lﬂd£gmít
(
fs
, 0);

608 
ªt
 = 
	`checkög_wrm§l
(
MSR_FS_BASE
, 
addr
);

611 
	`put_˝u
();

613 
ARCH_GET_FS
: {

614 
ba£
;

615 i‡(
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
)

616 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
FS_TLS
);

617 i‡(
doô
)

618 
	`rdm§l
(
MSR_FS_BASE
, 
ba£
);

620 
ba£
 = 
èsk
->
thªad
.
fs
;

621 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

624 
ARCH_GET_GS
: {

625 
ba£
;

626 
gsödex
;

627 i‡(
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
)

628 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
GS_TLS
);

629 i‡(
doô
) {

630 
	`ßve£gmít
(
gs
, 
gsödex
);

631 i‡(
gsödex
)

632 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

634 
ba£
 = 
èsk
->
thªad
.
gs
;

636 
ba£
 = 
èsk
->
thªad
.
gs
;

637 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

642 
ªt
 = -
EINVAL
;

646  
ªt
;

647 
	}
}

649 
	$sys_¨ch_¥˘l
(
code
, 
addr
)

651  
	`do_¨ch_¥˘l
(
cuºít
, 
code
, 
addr
);

652 
	}
}

654 
	$KSTK_ESP
(
èsk_°ru˘
 *
èsk
)

656  (
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
)) ?

657 (
	`èsk_±_ªgs
(
èsk
)->
•
Ë: (—ask)->
thªad
.
u£r•
);

658 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/ªg£t.h
>

18 
	~<löux/åa˚hook.h
>

19 
	~<löux/u£r.h
>

20 
	~<löux/ñf.h
>

21 
	~<löux/£curôy.h
>

22 
	~<löux/audô.h
>

23 
	~<löux/£ccomp.h
>

24 
	~<löux/sig«l.h
>

25 
	~<löux/w‹kqueue.h
>

26 
	~<löux/≥rf_evít.h
>

27 
	~<löux/hw_bªakpoöt.h
>

29 
	~<asm/uac˚ss.h
>

30 
	~<asm/pgèbÀ.h
>

31 
	~<asm/sy°em.h
>

32 
	~<asm/¥o˚ss‹.h
>

33 
	~<asm/i387.h
>

34 
	~<asm/debugªg.h
>

35 
	~<asm/ldt.h
>

36 
	~<asm/desc.h
>

37 
	~<asm/¥˘l.h
>

38 
	~<asm/¥Ÿo.h
>

39 
	~<asm/ds.h
>

40 
	~<asm/hw_bªakpoöt.h
>

42 
	~"és.h
"

44 
	#CREATE_TRACE_POINTS


	)

45 
	~<åa˚/evíts/sysˇŒs.h
>

47 
	ex86_ªg£t
 {

48 
	mREGSET_GENERAL
,

49 
	mREGSET_FP
,

50 
	mREGSET_XFP
,

51 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

52 
	mREGSET_XSTATE
,

53 
	mREGSET_TLS
,

54 
	mREGSET_IOPERM32
,

57 
	s±_ªgs_off£t
 {

58 c⁄° *
	m«me
;

59 
	moff£t
;

62 
	#REG_OFFSET_NAME
(
r
Ë{.
«me
 = #r, .
off£t
 = 
	`off£tof
(
±_ªgs
,Ñ)}

	)

63 
	#REG_OFFSET_END
 {.
«me
 = 
NULL
, .
off£t
 = 0}

	)

65 c⁄° 
±_ªgs_off£t
 
	gªgoff£t_èbÀ
[] = {

66 #ifde‡
CONFIG_X86_64


67 
REG_OFFSET_NAME
(
r15
),

68 
REG_OFFSET_NAME
(
r14
),

69 
REG_OFFSET_NAME
(
r13
),

70 
REG_OFFSET_NAME
(
r12
),

71 
REG_OFFSET_NAME
(
r11
),

72 
REG_OFFSET_NAME
(
r10
),

73 
REG_OFFSET_NAME
(
r9
),

74 
REG_OFFSET_NAME
(
r8
),

76 
REG_OFFSET_NAME
(
bx
),

77 
REG_OFFSET_NAME
(
cx
),

78 
REG_OFFSET_NAME
(
dx
),

79 
REG_OFFSET_NAME
(
si
),

80 
REG_OFFSET_NAME
(
di
),

81 
REG_OFFSET_NAME
(
bp
),

82 
REG_OFFSET_NAME
(
ax
),

83 #ifde‡
CONFIG_X86_32


84 
REG_OFFSET_NAME
(
ds
),

85 
REG_OFFSET_NAME
(
es
),

86 
REG_OFFSET_NAME
(
fs
),

87 
REG_OFFSET_NAME
(
gs
),

89 
REG_OFFSET_NAME
(
‹ig_ax
),

90 
REG_OFFSET_NAME
(
ù
),

91 
REG_OFFSET_NAME
(
cs
),

92 
REG_OFFSET_NAME
(
Êags
),

93 
REG_OFFSET_NAME
(
•
),

94 
REG_OFFSET_NAME
(
ss
),

95 
REG_OFFSET_END
,

105 
	$ªgs_quîy_ªgi°î_off£t
(c⁄° *
«me
)

107 c⁄° 
±_ªgs_off£t
 *
roff
;

108 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

109 i‡(!
	`°rcmp
(
roff
->
«me
,Çame))

110  
roff
->
off£t
;

111  -
EINVAL
;

112 
	}
}

121 c⁄° *
	$ªgs_quîy_ªgi°î_«me
(
off£t
)

123 c⁄° 
±_ªgs_off£t
 *
roff
;

124 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

125 i‡(
roff
->
off£t
 == offset)

126  
roff
->
«me
;

127  
NULL
;

128 
	}
}

130 c⁄° 
	g¨g_offs_èbÀ
[] = {

131 #ifde‡
CONFIG_X86_32


132 [0] = 
off£tof
(
±_ªgs
, 
ax
),

133 [1] = 
off£tof
(
±_ªgs
, 
dx
),

134 [2] = 
off£tof
(
±_ªgs
, 
cx
)

136 [0] = 
off£tof
(
±_ªgs
, 
di
),

137 [1] = 
off£tof
(
±_ªgs
, 
si
),

138 [2] = 
off£tof
(
±_ªgs
, 
dx
),

139 [3] = 
off£tof
(
±_ªgs
, 
cx
),

140 [4] = 
off£tof
(
±_ªgs
, 
r8
),

141 [5] = 
off£tof
(
±_ªgs
, 
r9
)

153 
	#FLAG_MASK_32
 (() \

154 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

155 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

156 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

157 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

158 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

163 
ölöe
 
boﬁ
 
	$övÆid_£À˘‹
(
u16
 
vÆue
)

165  
	`u∆ikñy
(
vÆue
 !0 && (vÆuê& 
SEGMENT_RPL_MASK
Ë!
USER_RPL
);

166 
	}
}

168 #ifde‡
CONFIG_X86_32


170 
	#FLAG_MASK
 
FLAG_MASK_32


	)

172 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
ªgno
)

174 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
bx
) != 0);

175  &
ªgs
->
bx
 + (
ªgno
 >> 2);

176 
	}
}

178 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

183 
ªtvÆ
;

184 i‡(
off£t
 !
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
))

185 
ªtvÆ
 = *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

187 i‡(
èsk
 =
cuºít
)

188 
ªtvÆ
 = 
	`gë_u£r_gs
(
	`èsk_±_ªgs
(
èsk
));

190 
ªtvÆ
 = 
	`èsk_u£r_gs
(
èsk
);

192  
ªtvÆ
;

193 
	}
}

195 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

196 
off£t
, 
u16
 
vÆue
)

201 i‡(
	`övÆid_£À˘‹
(
vÆue
))

202  -
EIO
;

213 
off£t
) {

214 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

215 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

216 i‡(
	`u∆ikñy
(
vÆue
 == 0))

217  -
EIO
;

220 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
Ë
vÆue
;

223 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

224 i‡(
èsk
 =
cuºít
)

225 
	`£t_u£r_gs
(
	`èsk_±_ªgs
(
èsk
), 
vÆue
);

227 
	`èsk_u£r_gs
(
èsk
Ë
vÆue
;

231 
	}
}

235 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

237 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
off£t
)

239 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
r15
) != 0);

240  &
ªgs
->
r15
 + (
off£t
 / (regs->r15));

241 
	}
}

243 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

248 
£g
;

250 
off£t
) {

251 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

252 i‡(
èsk
 =
cuºít
) {

254 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

255  
£g
;

257  
èsk
->
thªad
.
fsödex
;

258 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

259 i‡(
èsk
 =
cuºít
) {

260 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

261  
£g
;

263  
èsk
->
thªad
.
gsödex
;

264 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

265 i‡(
èsk
 =
cuºít
) {

266 
	`asm
("mov»%%ds,%0" : "Ù" (
£g
));

267  
£g
;

269  
èsk
->
thªad
.
ds
;

270 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

271 i‡(
èsk
 =
cuºít
) {

272 
	`asm
("mov»%%es,%0" : "Ù" (
£g
));

273  
£g
;

275  
èsk
->
thªad
.
es
;

277 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

278 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

281  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

282 
	}
}

284 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

285 
off£t
, 
u16
 
vÆue
)

290 i‡(
	`övÆid_£À˘‹
(
vÆue
))

291  -
EIO
;

293 
off£t
) {

294 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs
):

299 i‡((
vÆue
 =
FS_TLS_SEL
 && 
èsk
->
thªad
.
fsödex
 == 0 &&

300 
èsk
->
thªad
.
fs
 != 0) ||

301 (
vÆue
 =0 && 
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
 &&

302 
èsk
->
thªad
.
fs
 == 0))

304 
èsk
->
thªad
.
fsödex
 = 
vÆue
;

305 i‡(
èsk
 =
cuºít
)

306 
	`lﬂd£gmít
(
fs
, 
èsk
->
thªad
.
fsödex
);

308 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs
):

313 i‡((
vÆue
 =
GS_TLS_SEL
 && 
èsk
->
thªad
.
gsödex
 == 0 &&

314 
èsk
->
thªad
.
gs
 != 0) ||

315 (
vÆue
 =0 && 
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
 &&

316 
èsk
->
thªad
.
gs
 == 0))

318 
èsk
->
thªad
.
gsödex
 = 
vÆue
;

319 i‡(
èsk
 =
cuºít
)

320 
	`lﬂd_gs_ödex
(
èsk
->
thªad
.
gsödex
);

322 
	`off£tof
(
u£r_ªgs_°ru˘
,
ds
):

323 
èsk
->
thªad
.
ds
 = 
vÆue
;

324 i‡(
èsk
 =
cuºít
)

325 
	`lﬂd£gmít
(
ds
, 
èsk
->
thªad
.ds);

327 
	`off£tof
(
u£r_ªgs_°ru˘
,
es
):

328 
èsk
->
thªad
.
es
 = 
vÆue
;

329 i‡(
èsk
 =
cuºít
)

330 
	`lﬂd£gmít
(
es
, 
èsk
->
thªad
.es);

336 
	`off£tof
(
u£r_ªgs_°ru˘
,
cs
):

337 i‡(
	`u∆ikñy
(
vÆue
 == 0))

338  -
EIO
;

339 #ifde‡
CONFIG_IA32_EMULATION


340 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

341 
	`èsk_±_ªgs
(
èsk
)->
cs
 = 
vÆue
;

344 
	`off£tof
(
u£r_ªgs_°ru˘
,
ss
):

345 i‡(
	`u∆ikñy
(
vÆue
 == 0))

346  -
EIO
;

347 #ifde‡
CONFIG_IA32_EMULATION


348 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

349 
	`èsk_±_ªgs
(
èsk
)->
ss
 = 
vÆue
;

355 
	}
}

359 
	$gë_Êags
(
èsk_°ru˘
 *
èsk
)

361 
ªtvÆ
 = 
	`èsk_±_ªgs
(
èsk
)->
Êags
;

366 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

367 
ªtvÆ
 &~
X86_EFLAGS_TF
;

369  
ªtvÆ
;

370 
	}
}

372 
	$£t_Êags
(
èsk_°ru˘
 *
èsk
, 
vÆue
)

374 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

381 i‡(
vÆue
 & 
X86_EFLAGS_TF
)

382 
	`˛ór_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
);

383 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

384 
vÆue
 |
X86_EFLAGS_TF
;

386 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FLAG_MASK
Ë| (
vÆue
 & FLAG_MASK);

389 
	}
}

391 
	$puåeg
(
èsk_°ru˘
 *
chûd
,

392 
off£t
, 
vÆue
)

394 
off£t
) {

395 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

396 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

397 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

398 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

399 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

400 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

401  
	`£t_£gmít_ªg
(
chûd
, 
off£t
, 
vÆue
);

403 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

404  
	`£t_Êags
(
chûd
, 
vÆue
);

406 #ifde‡
CONFIG_X86_64


407 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs_ba£
):

408 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

409  -
EIO
;

415 i‡(
chûd
->
thªad
.
fs
 !
vÆue
)

416  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_FS
, 
vÆue
);

418 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs_ba£
):

422 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

423  -
EIO
;

424 i‡(
chûd
->
thªad
.
gs
 !
vÆue
)

425  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_GS
, 
vÆue
);

430 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
chûd
), 
off£t
Ë
vÆue
;

432 
	}
}

434 
	$gëªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

436 
off£t
) {

437 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

438 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

439 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

440 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

441 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

442 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

443  
	`gë_£gmít_ªg
(
èsk
, 
off£t
);

445 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

446  
	`gë_Êags
(
èsk
);

448 #ifde‡
CONFIG_X86_64


449 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs_ba£
): {

455 
£g
 = 
èsk
->
thªad
.
fsödex
;

456 i‡(
èsk
->
thªad
.
fs
 != 0)

457  
èsk
->
thªad
.
fs
;

458 i‡(
èsk
 =
cuºít
)

459 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

460 i‡(
£g
 !
FS_TLS_SEL
)

462  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
FS_TLS
]);

464 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs_ba£
): {

468 
£g
 = 
èsk
->
thªad
.
gsödex
;

469 i‡(
èsk
->
thªad
.
gs
 != 0)

470  
èsk
->
thªad
.
gs
;

471 i‡(
èsk
 =
cuºít
)

472 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

473 i‡(
£g
 !
GS_TLS_SEL
)

475  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
GS_TLS
]);

480  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

481 
	}
}

483 
	$gíªgs_gë
(
èsk_°ru˘
 *
èrgë
,

484 c⁄° 
u£r_ªg£t
 *
ªg£t
,

485 
pos
, 
cou¡
,

486 *
kbuf
, 
__u£r
 *
ubuf
)

488 i‡(
kbuf
) {

489 *
k
 = 
kbuf
;

490 
cou¡
 >(*
k
)) {

491 *
k
++ = 
	`gëªg
(
èrgë
, 
pos
);

492 
cou¡
 -(*
k
);

493 
pos
 +(*
k
);

496 
__u£r
 *
u
 = 
ubuf
;

497 
cou¡
 >(*
u
)) {

498 i‡(
	`__put_u£r
(
	`gëªg
(
èrgë
, 
pos
), 
u
++))

499  -
EFAULT
;

500 
cou¡
 -(*
u
);

501 
pos
 +(*
u
);

506 
	}
}

508 
	$gíªgs_£t
(
èsk_°ru˘
 *
èrgë
,

509 c⁄° 
u£r_ªg£t
 *
ªg£t
,

510 
pos
, 
cou¡
,

511 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

513 
ªt
 = 0;

514 i‡(
kbuf
) {

515 c⁄° *
k
 = 
kbuf
;

516 
cou¡
 >(*
k
Ë&& !
ªt
) {

517 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, *
k
++);

518 
cou¡
 -(*
k
);

519 
pos
 +(*
k
);

522 c⁄° 
__u£r
 *
u
 = 
ubuf
;

523 
cou¡
 >(*
u
Ë&& !
ªt
) {

524 
w‹d
;

525 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

526 i‡(
ªt
)

528 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, 
w‹d
);

529 
cou¡
 -(*
u
);

530 
pos
 +(*
u
);

533  
ªt
;

534 
	}
}

536 
	$±ø˚_åiggîed
(
≥rf_evít
 *
bp
, 
nmi
,

537 
≥rf_ßm∂e_d©a
 *
d©a
,

538 
±_ªgs
 *
ªgs
)

540 
i
;

541 
thªad_°ru˘
 *
thªad
 = &(
cuºít
->thread);

547 
i
 = 0; i < 
HBP_NUM
; i++) {

548 i‡(
thªad
->
±ø˚_bps
[
i
] =
bp
)

552 
thªad
->
debugªg6
 |(
DR_TRAP0
 << 
i
);

553 
	}
}

560 
	$±ø˚_gë_dr7
(
≥rf_evít
 *
bp
[])

562 
i
;

563 
dr7
 = 0;

564 
¨ch_hw_bªakpoöt
 *
öfo
;

566 
i
 = 0; i < 
HBP_NUM
; i++) {

567 i‡(
bp
[
i
] && !bp[i]->
©å
.
dißbÀd
) {

568 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
[
i
]);

569 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

573  
dr7
;

574 
	}
}

577 
	$±ø˚_modify_bªakpoöt
(
≥rf_evít
 *
bp
, 
Àn
, 
ty≥
,

578 
èsk_°ru˘
 *
tsk
, 
dißbÀd
)

580 
îr
;

581 
gí_Àn
, 
gí_ty≥
;

582 
≥rf_evít_©å
 
©å
;

589 i‡(!
bp
)

590  -
EINVAL
;

592 
îr
 = 
	`¨ch_bp_gíîic_fõlds
(
Àn
, 
ty≥
, &
gí_Àn
, &
gí_ty≥
);

593 i‡(
îr
)

594  
îr
;

596 
©å
 = 
bp
->attr;

597 
©å
.
bp_Àn
 = 
gí_Àn
;

598 
©å
.
bp_ty≥
 = 
gí_ty≥
;

599 
©å
.
dißbÀd
 = disabled;

601  
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

602 
	}
}

607 
	$±ø˚_wrôe_dr7
(
èsk_°ru˘
 *
tsk
, 
d©a
)

609 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

610 
ﬁd_dr7
;

611 
i
, 
‹ig_ªt
 = 0, 
rc
 = 0;

612 
íabÀd
, 
£c⁄d_∑ss
 = 0;

613 
Àn
, 
ty≥
;

614 
≥rf_evít
 *
bp
;

616 
d©a
 &~
DR_CONTROL_RESERVED
;

617 
ﬁd_dr7
 = 
	`±ø˚_gë_dr7
(
thªad
->
±ø˚_bps
);

618 
ª°‹e
:

623 
i
 = 0; i < 
HBP_NUM
; i++) {

624 
íabÀd
 = 
	`decode_dr7
(
d©a
, 
i
, &
Àn
, &
ty≥
);

625 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

627 i‡(!
íabÀd
) {

628 i‡(
bp
) {

636 i‡(!
£c⁄d_∑ss
)

639 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
,

640 
tsk
, 1);

641 i‡(
rc
)

647 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
, 
tsk
, 0);

648 i‡(
rc
)

655 i‡(!
£c⁄d_∑ss
) {

656 
£c⁄d_∑ss
 = 1;

657 i‡(
rc
 < 0) {

658 
‹ig_ªt
 = 
rc
;

659 
d©a
 = 
ﬁd_dr7
;

661 
ª°‹e
;

663  ((
‹ig_ªt
 < 0Ë? orig_ªà: 
rc
);

664 
	}
}

669 
	$±ø˚_gë_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
)

671 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

672 
vÆ
 = 0;

674 i‡(
n
 < 
HBP_NUM
) {

675 
≥rf_evít
 *
bp
;

676 
bp
 = 
thªad
->
±ø˚_bps
[
n
];

677 i‡(!
bp
)

679 
vÆ
 = 
bp
->
hw
.
öfo
.
addªss
;

680 } i‡(
n
 == 6) {

681 
vÆ
 = 
thªad
->
debugªg6
;

682 } i‡(
n
 == 7) {

683 
vÆ
 = 
thªad
->
±ø˚_dr7
;

685  
vÆ
;

686 
	}
}

688 
	$±ø˚_£t_bªakpoöt_addr
(
èsk_°ru˘
 *
tsk
, 
ƒ
,

689 
addr
)

691 
≥rf_evít
 *
bp
;

692 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

693 
≥rf_evít_©å
 
©å
;

695 i‡(!
t
->
±ø˚_bps
[
ƒ
]) {

696 
	`hw_bªakpoöt_öô
(&
©å
);

701 
©å
.
bp_addr
 = 
addr
;

702 
©å
.
bp_Àn
 = 
HW_BREAKPOINT_LEN_1
;

703 
©å
.
bp_ty≥
 = 
HW_BREAKPOINT_W
;

704 
©å
.
dißbÀd
 = 1;

706 
bp
 = 
	`ªgi°î_u£r_hw_bªakpoöt
(&
©å
, 
±ø˚_åiggîed
, 
tsk
);

717 i‡(
	`IS_ERR
(
bp
))

718  
	`PTR_ERR
(
bp
);

720 
t
->
±ø˚_bps
[
ƒ
] = 
bp
;

722 
îr
;

724 
bp
 = 
t
->
±ø˚_bps
[
ƒ
];

726 
©å
 = 
bp
->attr;

727 
©å
.
bp_addr
 = 
addr
;

728 
îr
 = 
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

729 i‡(
îr
)

730  
îr
;

735 
	}
}

740 
	$±ø˚_£t_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
, 
vÆ
)

742 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

743 
rc
 = 0;

746 i‡(
n
 == 4 ||Ç == 5)

747  -
EIO
;

749 i‡(
n
 == 6) {

750 
thªad
->
debugªg6
 = 
vÆ
;

751 
ªt_∑th
;

753 i‡(
n
 < 
HBP_NUM
) {

754 
rc
 = 
	`±ø˚_£t_bªakpoöt_addr
(
tsk
, 
n
, 
vÆ
);

755 i‡(
rc
)

756  
rc
;

759 i‡(
n
 == 7) {

760 
rc
 = 
	`±ø˚_wrôe_dr7
(
tsk
, 
vÆ
);

761 i‡(!
rc
)

762 
thªad
->
±ø˚_dr7
 = 
vÆ
;

765 
ªt_∑th
:

766  
rc
;

767 
	}
}

773 
	$i›îm_a˘ive
(
èsk_°ru˘
 *
èrgë
,

774 c⁄° 
u£r_ªg£t
 *
ªg£t
)

776  
èrgë
->
thªad
.
io_bôm≠_max
 / 
ªg£t
->
size
;

777 
	}
}

779 
	$i›îm_gë
(
èsk_°ru˘
 *
èrgë
,

780 c⁄° 
u£r_ªg£t
 *
ªg£t
,

781 
pos
, 
cou¡
,

782 *
kbuf
, 
__u£r
 *
ubuf
)

784 i‡(!
èrgë
->
thªad
.
io_bôm≠_±r
)

785  -
ENXIO
;

787  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

788 
èrgë
->
thªad
.
io_bôm≠_±r
,

789 0, 
IO_BITMAP_BYTES
);

790 
	}
}

792 #ifde‡
CONFIG_X86_PTRACE_BTS


810 
	sbts_c⁄ãxt
 {

812 
bts_åa˚r
 *
	måa˚r
;

815 *
	mbuf„r
;

816 
	msize
;

819 
mm_°ru˘
 *
	mmm
;

822 
èsk_°ru˘
 *
	mèsk
;

825 
	mbts_ovÊ_sig«l
;

828 
w‹k_°ru˘
 
	mw‹k
;

831 
	$Æloc_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
, 
size
)

833 *
buf„r
 = 
NULL
;

834 
îr
 = -
ENOMEM
;

836 
îr
 = 
	`accou¡_locked_mem‹y
(
cuºít
->
mm
, cuºít->
sig«l
->
æim
, 
size
);

837 i‡(
îr
 < 0)

838  
îr
;

840 
buf„r
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

841 i‡(!
buf„r
)

842 
out_ªfund
;

844 
c⁄ãxt
->
buf„r
 = buffer;

845 
c⁄ãxt
->
size
 = size;

846 
c⁄ãxt
->
mm
 = 
	`gë_èsk_mm
(
cuºít
);

850 
out_ªfund
:

851 
	`ªfund_locked_mem‹y
(
cuºít
->
mm
, 
size
);

852  
îr
;

853 
	}
}

855 
ölöe
 
	$‰ì_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
)

857 i‡(!
c⁄ãxt
->
buf„r
)

860 
	`k‰ì
(
c⁄ãxt
->
buf„r
);

861 
c⁄ãxt
->
buf„r
 = 
NULL
;

863 
	`ªfund_locked_mem‹y
(
c⁄ãxt
->
mm
, c⁄ãxt->
size
);

864 
c⁄ãxt
->
size
 = 0;

866 
	`mmput
(
c⁄ãxt
->
mm
);

867 
c⁄ãxt
->
mm
 = 
NULL
;

868 
	}
}

870 
	$‰ì_bts_c⁄ãxt_w‹k
(
w‹k_°ru˘
 *
w
)

872 
bts_c⁄ãxt
 *
c⁄ãxt
;

874 
c⁄ãxt
 = 
	`c⁄èöî_of
(
w
, 
bts_c⁄ãxt
, 
w‹k
);

876 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

877 
	`put_èsk_°ru˘
(
c⁄ãxt
->
èsk
);

878 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

879 
	`k‰ì
(
c⁄ãxt
);

880 
	}
}

882 
ölöe
 
	$‰ì_bts_c⁄ãxt
(
bts_c⁄ãxt
 *
c⁄ãxt
)

884 
	`INIT_WORK
(&
c⁄ãxt
->
w‹k
, 
‰ì_bts_c⁄ãxt_w‹k
);

885 
	`scheduÀ_w‹k
(&
c⁄ãxt
->
w‹k
);

886 
	}
}

888 
ölöe
 
bts_c⁄ãxt
 *
	$Æloc_bts_c⁄ãxt
(
èsk_°ru˘
 *
èsk
)

890 
bts_c⁄ãxt
 *
c⁄ãxt
 = 
	`kzÆloc
((*c⁄ãxt), 
GFP_KERNEL
);

891 i‡(
c⁄ãxt
) {

892 
c⁄ãxt
->
èsk
 =Åask;

893 
èsk
->
bts
 = 
c⁄ãxt
;

895 
	`gë_èsk_°ru˘
(
èsk
);

898  
c⁄ãxt
;

899 
	}
}

901 
	$±ø˚_bts_ªad_ªc‹d
(
èsk_°ru˘
 *
chûd
, 
size_t
 
ödex
,

902 
bts_°ru˘
 
__u£r
 *
out
)

904 
bts_c⁄ãxt
 *
c⁄ãxt
;

905 c⁄° 
bts_åa˚
 *
åa˚
;

906 
bts_°ru˘
 
bts
;

907 c⁄° *
©
;

908 
îr‹
;

910 
c⁄ãxt
 = 
chûd
->
bts
;

911 i‡(!
c⁄ãxt
)

912  -
ESRCH
;

914 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

915 i‡(!
åa˚
)

916  -
ESRCH
;

918 
©
 = 
åa˚
->
ds
.
t›
 - ((
ödex
 + 1Ë*Åø˚->ds.
size
);

919 i‡((*)
©
 < 
åa˚
->
ds
.
begö
)

920 
©
 +(
åa˚
->
ds
.
n
 *Åø˚->ds.
size
);

922 i‡(!
åa˚
->
ªad
)

923  -
EOPNOTSUPP
;

925 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

926 i‡(
îr‹
 < 0)

927  
îr‹
;

929 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

930  -
EFAULT
;

932  (
bts
);

933 
	}
}

935 
	$±ø˚_bts_døö
(
èsk_°ru˘
 *
chûd
,

936 
size
,

937 
bts_°ru˘
 
__u£r
 *
out
)

939 
bts_c⁄ãxt
 *
c⁄ãxt
;

940 c⁄° 
bts_åa˚
 *
åa˚
;

941 c⁄° *
©
;

942 
îr‹
, 
døöed
 = 0;

944 
c⁄ãxt
 = 
chûd
->
bts
;

945 i‡(!
c⁄ãxt
)

946  -
ESRCH
;

948 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

949 i‡(!
åa˚
)

950  -
ESRCH
;

952 i‡(!
åa˚
->
ªad
)

953  -
EOPNOTSUPP
;

955 i‡(
size
 < (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
))

956  -
EIO
;

958 
©
 = 
åa˚
->
ds
.
begö
; (*Ôà<Åø˚->ds.
t›
;

959 
out
++, 
døöed
++, 
©
 +
åa˚
->
ds
.
size
) {

960 
bts_°ru˘
 
bts
;

962 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

963 i‡(
îr‹
 < 0)

964  
îr‹
;

966 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

967  -
EFAULT
;

970 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

972 
îr‹
 = 
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

973 i‡(
îr‹
 < 0)

974  
îr‹
;

976  
døöed
;

977 
	}
}

979 
	$±ø˚_bts_c⁄fig
(
èsk_°ru˘
 *
chûd
,

980 
cfg_size
,

981 c⁄° 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

983 
bts_c⁄ãxt
 *
c⁄ãxt
;

984 
±ø˚_bts_c⁄fig
 
cfg
;

985 
Êags
 = 0;

987 i‡(
cfg_size
 < (
cfg
))

988  -
EIO
;

990 i‡(
	`c›y_‰om_u£r
(&
cfg
, 
ucfg
, (cfg)))

991  -
EFAULT
;

993 
c⁄ãxt
 = 
chûd
->
bts
;

994 i‡(!
c⁄ãxt
)

995 
c⁄ãxt
 = 
	`Æloc_bts_c⁄ãxt
(
chûd
);

996 i‡(!
c⁄ãxt
)

997  -
ENOMEM
;

999 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SIGNAL
) {

1000 i‡(!
cfg
.
sig«l
)

1001  -
EINVAL
;

1003  -
EOPNOTSUPP
;

1004 
c⁄ãxt
->
bts_ovÊ_sig«l
 = 
cfg
.
sig«l
;

1007 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

1008 
c⁄ãxt
->
åa˚r
 = 
NULL
;

1010 i‡((
cfg
.
Êags
 & 
PTRACE_BTS_O_ALLOC
Ë&& (cfg.
size
 !
c⁄ãxt
->size)) {

1011 
îr
;

1013 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

1014 i‡(!
cfg
.
size
)

1017 
îr
 = 
	`Æloc_bts_buf„r
(
c⁄ãxt
, 
cfg
.
size
);

1018 i‡(
îr
 < 0)

1019  
îr
;

1022 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_TRACE
)

1023 
Êags
 |
BTS_USER
;

1025 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SCHED
)

1026 
Êags
 |
BTS_TIMESTAMPS
;

1028 
c⁄ãxt
->
åa˚r
 =

1029 
	`ds_ªque°_bts_èsk
(
chûd
, 
c⁄ãxt
->
buf„r
, c⁄ãxt->
size
,

1030 
NULL
, (
size_t
)-1, 
Êags
);

1031 i‡(
	`u∆ikñy
(
	`IS_ERR
(
c⁄ãxt
->
åa˚r
))) {

1032 
îr‹
 = 
	`PTR_ERR
(
c⁄ãxt
->
åa˚r
);

1034 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

1035 
c⁄ãxt
->
åa˚r
 = 
NULL
;

1036  
îr‹
;

1039  (
cfg
);

1040 
	}
}

1042 
	$±ø˚_bts_°©us
(
èsk_°ru˘
 *
chûd
,

1043 
cfg_size
,

1044 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

1046 
bts_c⁄ãxt
 *
c⁄ãxt
;

1047 c⁄° 
bts_åa˚
 *
åa˚
;

1048 
±ø˚_bts_c⁄fig
 
cfg
;

1050 
c⁄ãxt
 = 
chûd
->
bts
;

1051 i‡(!
c⁄ãxt
)

1052  -
ESRCH
;

1054 i‡(
cfg_size
 < (
cfg
))

1055  -
EIO
;

1057 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1058 i‡(!
åa˚
)

1059  -
ESRCH
;

1061 
	`mem£t
(&
cfg
, 0, (cfg));

1062 
cfg
.
size
 = 
åa˚
->
ds
.
íd
 -Åø˚->ds.
begö
;

1063 
cfg
.
sig«l
 = 
c⁄ãxt
->
bts_ovÊ_sig«l
;

1064 
cfg
.
bts_size
 = (
bts_°ru˘
);

1066 i‡(
cfg
.
sig«l
)

1067 
cfg
.
Êags
 |
PTRACE_BTS_O_SIGNAL
;

1069 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_USER
)

1070 
cfg
.
Êags
 |
PTRACE_BTS_O_TRACE
;

1072 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_TIMESTAMPS
)

1073 
cfg
.
Êags
 |
PTRACE_BTS_O_SCHED
;

1075 i‡(
	`c›y_to_u£r
(
ucfg
, &
cfg
, (cfg)))

1076  -
EFAULT
;

1078  (
cfg
);

1079 
	}
}

1081 
	$±ø˚_bts_˛ór
(
èsk_°ru˘
 *
chûd
)

1083 
bts_c⁄ãxt
 *
c⁄ãxt
;

1084 c⁄° 
bts_åa˚
 *
åa˚
;

1086 
c⁄ãxt
 = 
chûd
->
bts
;

1087 i‡(!
c⁄ãxt
)

1088  -
ESRCH
;

1090 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1091 i‡(!
åa˚
)

1092  -
ESRCH
;

1094 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

1096  
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

1097 
	}
}

1099 
	$±ø˚_bts_size
(
èsk_°ru˘
 *
chûd
)

1101 
bts_c⁄ãxt
 *
c⁄ãxt
;

1102 c⁄° 
bts_åa˚
 *
åa˚
;

1104 
c⁄ãxt
 = 
chûd
->
bts
;

1105 i‡(!
c⁄ãxt
)

1106  -
ESRCH
;

1108 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

1109 i‡(!
åa˚
)

1110  -
ESRCH
;

1112  (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
Ë/Åø˚->ds.
size
;

1113 
	}
}

1119 
	$±ø˚_bts_u¡ø˚
(
èsk_°ru˘
 *
chûd
)

1121 i‡(
	`u∆ikñy
(
chûd
->
bts
)) {

1122 
	`‰ì_bts_c⁄ãxt
(
chûd
->
bts
);

1123 
chûd
->
bts
 = 
NULL
;

1125 
	}
}

1133 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

1135 
	`u£r_dißbÀ_sögÀ_°ï
(
chûd
);

1136 #ifde‡
TIF_SYSCALL_EMU


1137 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_EMU
);

1139 
	}
}

1141 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1142 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
;

1145 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

1147 
ªt
;

1148 
__u£r
 *
d©≠
 = (__u£∏*)
d©a
;

1150 
ªque°
) {

1152 
PTRACE_PEEKUSR
: {

1153 
tmp
;

1155 
ªt
 = -
EIO
;

1156 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

1157 
addr
 >(
u£r
))

1160 
tmp
 = 0;

1161 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

1162 
tmp
 = 
	`gëªg
(
chûd
, 
addr
);

1163 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

1164 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

1165 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

1166 
tmp
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
addr
 / (
d©a
));

1168 
ªt
 = 
	`put_u£r
(
tmp
, 
d©≠
);

1172 
PTRACE_POKEUSR
:

1173 
ªt
 = -
EIO
;

1174 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

1175 
addr
 >(
u£r
))

1178 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

1179 
ªt
 = 
	`puåeg
(
chûd
, 
addr
, 
d©a
);

1180 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

1181 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

1182 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

1183 
ªt
 = 
	`±ø˚_£t_debugªg
(
chûd
,

1184 
addr
 / (
d©a
), data);

1188 
PTRACE_GETREGS
:

1189  
	`c›y_ªg£t_to_u£r
(
chûd
,

1190 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1191 
REGSET_GENERAL
,

1192 0, (
u£r_ªgs_°ru˘
),

1193 
d©≠
);

1195 
PTRACE_SETREGS
:

1196  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

1197 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1198 
REGSET_GENERAL
,

1199 0, (
u£r_ªgs_°ru˘
),

1200 
d©≠
);

1202 
PTRACE_GETFPREGS
:

1203  
	`c›y_ªg£t_to_u£r
(
chûd
,

1204 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1205 
REGSET_FP
,

1206 0, (
u£r_i387_°ru˘
),

1207 
d©≠
);

1209 
PTRACE_SETFPREGS
:

1210  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

1211 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1212 
REGSET_FP
,

1213 0, (
u£r_i387_°ru˘
),

1214 
d©≠
);

1216 #ifde‡
CONFIG_X86_32


1217 
PTRACE_GETFPXREGS
:

1218  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1219 
REGSET_XFP
,

1220 0, (
u£r_fx§_°ru˘
),

1221 
d©≠
Ë? -
EIO
 : 0;

1223 
PTRACE_SETFPXREGS
:

1224  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1225 
REGSET_XFP
,

1226 0, (
u£r_fx§_°ru˘
),

1227 
d©≠
Ë? -
EIO
 : 0;

1230 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1231 
PTRACE_GET_THREAD_AREA
:

1232 i‡(
addr
 < 0)

1233  -
EIO
;

1234 
ªt
 = 
	`do_gë_thªad_¨ó
(
chûd
, 
addr
,

1235 (
u£r_desc
 
__u£r
 *Ë
d©a
);

1238 
PTRACE_SET_THREAD_AREA
:

1239 i‡(
addr
 < 0)

1240  -
EIO
;

1241 
ªt
 = 
	`do_£t_thªad_¨ó
(
chûd
, 
addr
,

1242 (
u£r_desc
 
__u£r
 *Ë
d©a
, 0);

1246 #ifde‡
CONFIG_X86_64


1250 
PTRACE_ARCH_PRCTL
:

1251 
ªt
 = 
	`do_¨ch_¥˘l
(
chûd
, 
d©a
, 
addr
);

1258 #ifde‡
CONFIG_X86_PTRACE_BTS


1259 
PTRACE_BTS_CONFIG
:

1260 
ªt
 = 
±ø˚_bts_c⁄fig


1261 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1264 
PTRACE_BTS_STATUS
:

1265 
ªt
 = 
±ø˚_bts_°©us


1266 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1269 
PTRACE_BTS_SIZE
:

1270 
ªt
 = 
	`±ø˚_bts_size
(
chûd
);

1273 
PTRACE_BTS_GET
:

1274 
ªt
 = 
±ø˚_bts_ªad_ªc‹d


1275 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1278 
PTRACE_BTS_CLEAR
:

1279 
ªt
 = 
	`±ø˚_bts_˛ór
(
chûd
);

1282 
PTRACE_BTS_DRAIN
:

1283 
ªt
 = 
±ø˚_bts_døö


1284 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1289 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1293  
ªt
;

1294 
	}
}

1296 #ifde‡
CONFIG_IA32_EMULATION


1298 
	~<löux/com∑t.h
>

1299 
	~<löux/sysˇŒs.h
>

1300 
	~<asm/ü32.h
>

1301 
	~<asm/u£r32.h
>

1303 
	#R32
(
l
,
q
) \

1304 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1305 
ªgs
->
q
 = 
vÆue
; 

	)

1307 
	#SEG32
(
rs
) \

1308 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1309  
	`£t_£gmít_ªg
(
chûd
, \

1310 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
), \

1311 
vÆue
); \

1312 

	)

1314 
	$puåeg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 
vÆue
)

1316 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1318 
ªgno
) {

1320 
	`SEG32
(
cs
);

1321 
	`SEG32
(
ds
);

1322 
	`SEG32
(
es
);

1323 
	`SEG32
(
fs
);

1324 
	`SEG32
(
gs
);

1325 
	`SEG32
(
ss
);

1327 
	`R32
(
ebx
, 
bx
);

1328 
	`R32
(
ecx
, 
cx
);

1329 
	`R32
(
edx
, 
dx
);

1330 
	`R32
(
edi
, 
di
);

1331 
	`R32
(
esi
, 
si
);

1332 
	`R32
(
ebp
, 
bp
);

1333 
	`R32
(
óx
, 
ax
);

1334 
	`R32
(
eù
, 
ù
);

1335 
	`R32
(
e•
, 
•
);

1337 
	`off£tof
(
u£r32
, 
ªgs
.
‹ig_óx
):

1345 
ªgs
->
‹ig_ax
 = 
vÆue
;

1346 i‡(
	`sysˇŒ_gë_ƒ
(
chûd
, 
ªgs
) >= 0)

1347 
	`èsk_thªad_öfo
(
chûd
)->
°©us
 |
TS_COMPAT
;

1350 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1351  
	`£t_Êags
(
chûd
, 
vÆue
);

1353 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1354 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1355 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1356  
	`±ø˚_£t_debugªg
(
chûd
, 
ªgno
 / 4, 
vÆue
);

1359 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1360  -
EIO
;

1369 
	}
}

1371 #unde‡
R32


1372 #unde‡
SEG32


1374 
	#R32
(
l
,
q
) \

1375 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1376 *
vÆ
 = 
ªgs
->
q
; 

	)

1378 
	#SEG32
(
rs
) \

1379 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1380 *
vÆ
 = 
	`gë_£gmít_ªg
(
chûd
, \

1381 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
)); \

1382 

	)

1384 
	$gëªg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 *
vÆ
)

1386 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1388 
ªgno
) {

1390 
	`SEG32
(
ds
);

1391 
	`SEG32
(
es
);

1392 
	`SEG32
(
fs
);

1393 
	`SEG32
(
gs
);

1395 
	`R32
(
cs
, cs);

1396 
	`R32
(
ss
, ss);

1397 
	`R32
(
ebx
, 
bx
);

1398 
	`R32
(
ecx
, 
cx
);

1399 
	`R32
(
edx
, 
dx
);

1400 
	`R32
(
edi
, 
di
);

1401 
	`R32
(
esi
, 
si
);

1402 
	`R32
(
ebp
, 
bp
);

1403 
	`R32
(
óx
, 
ax
);

1404 
	`R32
(
‹ig_óx
, 
‹ig_ax
);

1405 
	`R32
(
eù
, 
ù
);

1406 
	`R32
(
e•
, 
•
);

1408 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1409 *
vÆ
 = 
	`gë_Êags
(
chûd
);

1412 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1413 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1414 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1415 *
vÆ
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
ªgno
 / 4);

1419 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1420  -
EIO
;

1426 *
vÆ
 = 0;

1430 
	}
}

1432 #unde‡
R32


1433 #unde‡
SEG32


1435 
	$gíªgs32_gë
(
èsk_°ru˘
 *
èrgë
,

1436 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1437 
pos
, 
cou¡
,

1438 *
kbuf
, 
__u£r
 *
ubuf
)

1440 i‡(
kbuf
) {

1441 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1442 
cou¡
 >(*
k
)) {

1443 
	`gëªg32
(
èrgë
, 
pos
, 
k
++);

1444 
cou¡
 -(*
k
);

1445 
pos
 +(*
k
);

1448 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1449 
cou¡
 >(*
u
)) {

1450 
com∑t_ul⁄g_t
 
w‹d
;

1451 
	`gëªg32
(
èrgë
, 
pos
, &
w‹d
);

1452 i‡(
	`__put_u£r
(
w‹d
, 
u
++))

1453  -
EFAULT
;

1454 
cou¡
 -(*
u
);

1455 
pos
 +(*
u
);

1460 
	}
}

1462 
	$gíªgs32_£t
(
èsk_°ru˘
 *
èrgë
,

1463 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1464 
pos
, 
cou¡
,

1465 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

1467 
ªt
 = 0;

1468 i‡(
kbuf
) {

1469 c⁄° 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1470 
cou¡
 >(*
k
Ë&& !
ªt
) {

1471 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, *
k
++);

1472 
cou¡
 -(*
k
);

1473 
pos
 +(*
k
);

1476 c⁄° 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1477 
cou¡
 >(*
u
Ë&& !
ªt
) {

1478 
com∑t_ul⁄g_t
 
w‹d
;

1479 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

1480 i‡(
ªt
)

1482 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, 
w‹d
);

1483 
cou¡
 -(*
u
);

1484 
pos
 +(*
u
);

1487  
ªt
;

1488 
	}
}

1490 
	$com∑t_¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
com∑t_l⁄g_t
 
ªque°
,

1491 
com∑t_ul⁄g_t
 
ˇddr
, com∑t_ul⁄g_à
cd©a
)

1493 
addr
 = 
ˇddr
;

1494 
d©a
 = 
cd©a
;

1495 
__u£r
 *
d©≠
 = 
	`com∑t_±r
(
d©a
);

1496 
ªt
;

1497 
__u32
 
vÆ
;

1499 
ªque°
) {

1500 
PTRACE_PEEKUSR
:

1501 
ªt
 = 
	`gëªg32
(
chûd
, 
addr
, &
vÆ
);

1502 i‡(
ªt
 == 0)

1503 
ªt
 = 
	`put_u£r
(
vÆ
, (
__u32
 
__u£r
 *)
d©≠
);

1506 
PTRACE_POKEUSR
:

1507 
ªt
 = 
	`puåeg32
(
chûd
, 
addr
, 
d©a
);

1510 
PTRACE_GETREGS
:

1511  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1512 
REGSET_GENERAL
,

1513 0, (
u£r_ªgs_°ru˘32
),

1514 
d©≠
);

1516 
PTRACE_SETREGS
:

1517  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1518 
REGSET_GENERAL
, 0,

1519 (
u£r_ªgs_°ru˘32
),

1520 
d©≠
);

1522 
PTRACE_GETFPREGS
:

1523  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1524 
REGSET_FP
, 0,

1525 (
u£r_i387_ü32_°ru˘
),

1526 
d©≠
);

1528 
PTRACE_SETFPREGS
:

1529  
	`c›y_ªg£t_‰om_u£r
(

1530 
chûd
, &
u£r_x86_32_võw
, 
REGSET_FP
,

1531 0, (
u£r_i387_ü32_°ru˘
), 
d©≠
);

1533 
PTRACE_GETFPXREGS
:

1534  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1535 
REGSET_XFP
, 0,

1536 (
u£r32_fx§_°ru˘
),

1537 
d©≠
);

1539 
PTRACE_SETFPXREGS
:

1540  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1541 
REGSET_XFP
, 0,

1542 (
u£r32_fx§_°ru˘
),

1543 
d©≠
);

1545 
PTRACE_GET_THREAD_AREA
:

1546 
PTRACE_SET_THREAD_AREA
:

1547 #ifde‡
CONFIG_X86_PTRACE_BTS


1548 
PTRACE_BTS_CONFIG
:

1549 
PTRACE_BTS_STATUS
:

1550 
PTRACE_BTS_SIZE
:

1551 
PTRACE_BTS_GET
:

1552 
PTRACE_BTS_CLEAR
:

1553 
PTRACE_BTS_DRAIN
:

1555  
	`¨ch_±ø˚
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1558  
	`com∑t_±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1561  
ªt
;

1562 
	}
}

1566 #ifde‡
CONFIG_X86_64


1568 
u£r_ªg£t
 
	gx86_64_ªg£ts
[] 
	g__ªad_mo°ly
 = {

1569 [
REGSET_GENERAL
] = {

1570 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1571 .
	gn
 = (
u£r_ªgs_°ru˘
) / (),

1572 .
	gsize
 = (), .
	gÆign
 = (),

1573 .
	ggë
 = 
gíªgs_gë
, .
	g£t
 = 
gíªgs_£t


1575 [
REGSET_FP
] = {

1576 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1577 .
	gn
 = (
u£r_i387_°ru˘
) / (),

1578 .
	gsize
 = (), .
	gÆign
 = (),

1579 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1581 [
REGSET_XSTATE
] = {

1582 .
c‹e_nŸe_ty≥
 = 
NT_X86_XSTATE
,

1583 .
	gsize
 = (
u64
), .
	gÆign
 = (u64),

1584 .
	ga˘ive
 = 
x°©îegs_a˘ive
, .
	ggë
 = 
x°©îegs_gë
,

1585 .
	g£t
 = 
x°©îegs_£t


1587 [
REGSET_IOPERM64
] = {

1588 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1589 .
	gn
 = 
IO_BITMAP_LONGS
,

1590 .
	gsize
 = (), .
	gÆign
 = (),

1591 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1595 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_64_võw
 = {

1596 .
«me
 = "x86_64", .
	ge_machöe
 = 
EM_X86_64
,

1597 .
	gªg£ts
 = 
x86_64_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1602 
	#u£r_ªgs_°ru˘32
 
u£r_ªgs_°ru˘


	)

1603 
	#gíªgs32_gë
 
gíªgs_gë


	)

1604 
	#gíªgs32_£t
 
gíªgs_£t


	)

1606 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

1607 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

1611 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1612 
u£r_ªg£t
 
	gx86_32_ªg£ts
[] 
	g__ªad_mo°ly
 = {

1613 [
REGSET_GENERAL
] = {

1614 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1615 .
	gn
 = (
u£r_ªgs_°ru˘32
Ë/ (
u32
),

1616 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1617 .
	ggë
 = 
gíªgs32_gë
, .
	g£t
 = 
gíªgs32_£t


1619 [
REGSET_FP
] = {

1620 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1621 .
	gn
 = (
u£r_i387_ü32_°ru˘
Ë/ (
u32
),

1622 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1623 .
	ga˘ive
 = 
Âªgs_a˘ive
, .
	ggë
 = 
Âªgs_gë
, .
	g£t
 = 
Âªgs_£t


1625 [
REGSET_XFP
] = {

1626 .
c‹e_nŸe_ty≥
 = 
NT_PRXFPREG
,

1627 .
	gn
 = (
u£r32_fx§_°ru˘
Ë/ (
u32
),

1628 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1629 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1631 [
REGSET_XSTATE
] = {

1632 .
c‹e_nŸe_ty≥
 = 
NT_X86_XSTATE
,

1633 .
	gsize
 = (
u64
), .
	gÆign
 = (u64),

1634 .
	ga˘ive
 = 
x°©îegs_a˘ive
, .
	ggë
 = 
x°©îegs_gë
,

1635 .
	g£t
 = 
x°©îegs_£t


1637 [
REGSET_TLS
] = {

1638 .
c‹e_nŸe_ty≥
 = 
NT_386_TLS
,

1639 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbüs
 = 
GDT_ENTRY_TLS_MIN
,

1640 .
	gsize
 = (
u£r_desc
),

1641 .
	gÆign
 = (
u£r_desc
),

1642 .
	ga˘ive
 = 
ªg£t_és_a˘ive
,

1643 .
	ggë
 = 
ªg£t_és_gë
, .
	g£t
 = 
ªg£t_és_£t


1645 [
REGSET_IOPERM32
] = {

1646 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1647 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1648 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1649 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1653 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
 = {

1654 .
«me
 = "i386", .
	ge_machöe
 = 
EM_386
,

1655 .
	gªg£ts
 = 
x86_32_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1663 
u64
 
	gx°©e_fx_sw_byãs
[
USER_XSTATE_FX_SW_WORDS
];

1665 
	$upd©e_ªg£t_x°©e_öfo
(
size
, 
u64
 
x°©e_mask
)

1667 #ifde‡
CONFIG_X86_64


1668 
x86_64_ªg£ts
[
REGSET_XSTATE
].
n
 = 
size
 / (
u64
);

1670 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1671 
x86_32_ªg£ts
[
REGSET_XSTATE
].
n
 = 
size
 / (
u64
);

1673 
x°©e_fx_sw_byãs
[
USER_XSTATE_XCR0_WORD
] = 
x°©e_mask
;

1674 
	}
}

1676 c⁄° 
u£r_ªg£t_võw
 *
	$èsk_u£r_ªg£t_võw
(
èsk_°ru˘
 *
èsk
)

1678 #ifde‡
CONFIG_IA32_EMULATION


1679 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

1681 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1682  &
u£r_x86_32_võw
;

1684 #ifde‡
CONFIG_X86_64


1685  &
u£r_x86_64_võw
;

1687 
	}
}

1689 
	$fûl_sigå≠_öfo
(
èsk_°ru˘
 *
tsk
,

1690 
±_ªgs
 *
ªgs
,

1691 
îr‹_code
, 
si_code
,

1692 
sigöfo
 *
öfo
)

1694 
tsk
->
thªad
.
å≠_no
 = 1;

1695 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

1697 
	`mem£t
(
öfo
, 0, (*info));

1698 
öfo
->
si_signo
 = 
SIGTRAP
;

1699 
öfo
->
si_code
 = si_code;

1700 
öfo
->
si_addr
 = 
	`u£r_mode_vm
(
ªgs
Ë? (
__u£r
 *Ïegs->
ù
 : 
NULL
;

1701 
	}
}

1703 
	$u£r_sögÀ_°ï_sigöfo
(
èsk_°ru˘
 *
tsk
,

1704 
±_ªgs
 *
ªgs
,

1705 
sigöfo
 *
öfo
)

1707 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 0, 
TRAP_BRKPT
, 
öfo
);

1708 
	}
}

1710 
	$£nd_sigå≠
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
,

1711 
îr‹_code
, 
si_code
)

1713 
sigöfo
 
öfo
;

1715 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
, &
öfo
);

1717 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

1718 
	}
}

1721 #ifde‡
CONFIG_X86_32


1722 
	#IS_IA32
 1

	)

1723 #ñi‡
deföed
 
CONFIG_IA32_EMULATION


1724 
	#IS_IA32
 
	`is_com∑t_èsk
()

	)

1726 
	#IS_IA32
 0

	)

1733 
asmªg∑rm
 
	$sysˇŒ_åa˚_íãr
(
±_ªgs
 *
ªgs
)

1735 
ªt
 = 0;

1744 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
))

1745 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

1748 
	`£cuª_computög
(
ªgs
->
‹ig_ax
);

1750 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1751 
ªt
 = -1L;

1753 i‡((
ªt
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
)) &&

1754 
	`åa˚hook_ªp‹t_sysˇŒ_íåy
(
ªgs
))

1755 
ªt
 = -1L;

1757 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1758 
	`åa˚_sys_íãr
(
ªgs
,Ñegs->
‹ig_ax
);

1760 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
)) {

1761 i‡(
IS_IA32
)

1762 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_I386
,

1763 
ªgs
->
‹ig_ax
,

1764 
ªgs
->
bx
,Ñegs->
cx
,

1765 
ªgs
->
dx
,Ñegs->
si
);

1766 #ifde‡
CONFIG_X86_64


1768 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_X86_64
,

1769 
ªgs
->
‹ig_ax
,

1770 
ªgs
->
di
,Ñegs->
si
,

1771 
ªgs
->
dx
,Ñegs->
r10
);

1775  
ªt
 ?: 
ªgs
->
‹ig_ax
;

1776 
	}
}

1778 
asmªg∑rm
 
	$sysˇŒ_åa˚_Àave
(
±_ªgs
 *
ªgs
)

1780 
boﬁ
 
°ï
;

1782 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
))

1783 
	`audô_sysˇŒ_exô
(
	`AUDITSC_RESULT
(
ªgs
->
ax
),Ñegs->ax);

1785 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1786 
	`åa˚_sys_exô
(
ªgs
,Ñegs->
ax
);

1794 
°ï
 = 
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
)) &&

1795 !
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
);

1796 i‡(
°ï
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

1797 
	`åa˚hook_ªp‹t_sysˇŒ_exô
(
ªgs
, 
°ï
);

1798 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<löux/pci.h
>

5 
	~<löux/úq.h
>

7 
	~<asm/h≥t.h
>

9 #i‡
deföed
(
CONFIG_X86_IO_APIC
Ë&& deföed(
CONFIG_SMP
Ë&& deföed(
CONFIG_PCI
)

11 
__devöô
 
	$quúk_öãl_úqbÆ™˚
(
pci_dev
 *
dev
)

13 
u8
 
c⁄fig
, 
ªv
;

14 
u16
 
w‹d
;

21 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

22 i‡(
ªv
 > 0x9)

26 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xf4, &
c⁄fig
);

27 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
|0x2);

33 
	`pci_bus_ªad_c⁄fig_w‹d
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
w‹d
);

35 i‡(!(
w‹d
 & (1 << 13))) {

36 
	`dev_öfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noúqdebug_£tup
("");

39 #ifde‡
CONFIG_PROC_FS


40 
no_úq_afföôy
 = 1;

45 i‡(!(
c⁄fig
 & 0x2))

46 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quúk_öãl_úqbÆ™˚
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quúk_öãl_úqbÆ™˚
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quúk_öãl_úqbÆ™˚
);

56 #i‡
deföed
(
CONFIG_HPET_TIMER
)

57 
	gf‹˚_h≥t_addªss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gf‹˚_h≥t_ªsume_ty≥
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_f‹˚_h≥t_ªsume
()

72 
u32
 
vÆ
;

74 i‡(!
f‹˚_h≥t_addªss
)

77 
	`BUG_ON
(
rcba_ba£
 =
NULL
);

80 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

81 i‡(!(
vÆ
 & 0x80)) {

83 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

87 i‡(!(
vÆ
 & 0x80))

88 
	`BUG
();

90 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

93 
	}
}

95 
	$ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

97 
u32
 
vÆ
;

98 
u32
 
	`unöôülized_v¨
(
rcba
);

99 
îr
 = 0;

101 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

104 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 i‡(
rcba
 == 0) {

107 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`i‹em≠_noˇche
(
rcba
, 0x4000);

114 i‡(
rcba_ba£
 =
NULL
) {

115 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

123 i‡(
vÆ
 & 0x80) {

125 
vÆ
 = val & 0x3;

126 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

127 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

128 "0x%lx\n", 
f‹˚_h≥t_addªss
);

129 
	`iounm≠
(
rcba_ba£
);

134 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

137 i‡(!(
vÆ
 & 0x80)) {

138 
îr
 = 1;

140 
vÆ
 = val & 0x3;

141 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

144 i‡(
îr
) {

145 
f‹˚_h≥t_addªss
 = 0;

146 
	`iounm≠
(
rcba_ba£
);

147 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev,

150 
f‹˚_h≥t_ªsume_ty≥
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

152 "0x%lx\n", 
f‹˚_h≥t_addªss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_f‹˚_íabÀ_h≥t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_f‹˚_íabÀ_h≥t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_f‹˚_íabÀ_h≥t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_f‹˚_íabÀ_h≥t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_f‹˚_íabÀ_h≥t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_f‹˚_íabÀ_h≥t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_f‹˚_íabÀ_h≥t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_f‹˚_íabÀ_h≥t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_f‹˚_íabÀ_h≥t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_f‹˚_íabÀ_h≥t
);

177 
pci_dev
 *
	gˇched_dev
;

179 
	$h≥t_¥öt_f‹˚_öfo
()

181 
	`¥ötk
(
KERN_INFO
 "HPETÇotÉnabled in BIOS. "

183 
	}
}

185 
	$ﬁd_ich_f‹˚_h≥t_ªsume
()

187 
u32
 
vÆ
;

188 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

190 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

193 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

194 
gí_˙é
 &= (~(0x7 << 15));

195 
gí_˙é
 |= (0x4 << 15);

197 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, 
gí_˙é
);

198 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

199 
vÆ
 = 
gí_˙é
 >> 15;

200 
vÆ
 &= 0x7;

201 i‡(
vÆ
 == 0x4)

202 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

204 
	`BUG
();

205 
	}
}

207 
	$ﬁd_ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

209 
u32
 
vÆ
;

210 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

212 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

215 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

220 
vÆ
 = 
gí_˙é
 >> 15;

221 
vÆ
 &= 0x7;

222 i‡(
vÆ
 & 0x4) {

223 
vÆ
 &= 0x3;

224 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

225 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

226 
f‹˚_h≥t_addªss
);

234 
gí_˙é
 &= (~(0x7 << 15));

235 
gí_˙é
 |= (0x4 << 15);

236 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0xD0, 
gí_˙é
);

238 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

240 
vÆ
 = 
gí_˙é
 >> 15;

241 
vÆ
 &= 0x7;

242 i‡(
vÆ
 & 0x4) {

244 
vÆ
 &= 0x3;

245 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

246 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

247 "0x%lx\n", 
f‹˚_h≥t_addªss
);

248 
ˇched_dev
 = 
dev
;

249 
f‹˚_h≥t_ªsume_ty≥
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

254 
	}
}

260 
	$ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
(
pci_dev
 *
dev
)

262 i‡(
h≥t_f‹˚_u£r
)

263 
	`ﬁd_ich_f‹˚_íabÀ_h≥t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

282 
	$vt8237_f‹˚_h≥t_ªsume
()

284 
u32
 
vÆ
;

286 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

289 
vÆ
 = 0xfed00000 | 0x80;

290 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, 
vÆ
);

292 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, &
vÆ
);

293 i‡(
vÆ
 & 0x80)

294 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

301 
u32
 
	`unöôülized_v¨
(
vÆ
);

303 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

306 i‡(!
h≥t_f‹˚_u£r
) {

307 
	`h≥t_¥öt_f‹˚_öfo
();

311 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

316 i‡(
vÆ
 & 0x80) {

317 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

318 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

319 
f‹˚_h≥t_addªss
);

327 
vÆ
 = 0xfed00000 | 0x80;

328 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x68, 
vÆ
);

330 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

331 i‡(
vÆ
 & 0x80) {

332 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

333 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

334 "0x%lx\n", 
f‹˚_h≥t_addªss
);

335 
ˇched_dev
 = 
dev
;

336 
f‹˚_h≥t_ªsume_ty≥
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_f‹˚_íabÀ_h≥t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_f‹˚_íabÀ_h≥t
);

348 
	$©i_f‹˚_h≥t_ªsume
()

350 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x14, 0xfed00000);

351 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_ªv
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xac, 
b
);

362 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x70, 
d
);

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
vÆ
;

374 
u8
 
b
;

376 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

379 i‡(!
h≥t_f‹˚_u£r
) {

380 
	`h≥t_¥öt_f‹˚_öfo
();

384 
d
 = 
	`©i_ixp4x0_ªv
(
dev
);

385 i‡(
d
 < 0x82)

389 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x14, 0xfed00000);

390 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x14, &
vÆ
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

397 i‡(!(
b
 & 0x1))

399 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x64, 
d
);

402 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

403 i‡(!(
d
 & (1<<10)))

406 
f‹˚_h≥t_addªss
 = 
vÆ
;

407 
f‹˚_h≥t_ªsume_ty≥
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

409 
f‹˚_h≥t_addªss
);

410 
ˇched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_f‹˚_íabÀ_h≥t
);

418 
	$nvidü_f‹˚_h≥t_ªsume
()

420 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x44, 0xfed00001);

421 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

422 
	}
}

424 
	$nvidü_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

426 
u32
 
	`unöôülized_v¨
(
vÆ
);

428 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

431 i‡(!
h≥t_f‹˚_u£r
) {

432 
	`h≥t_¥öt_f‹˚_öfo
();

436 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x44, 0xfed00001);

437 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x44, &
vÆ
);

438 
f‹˚_h≥t_addªss
 = 
vÆ
 & 0xfffffffe;

439 
f‹˚_h≥t_ªsume_ty≥
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

441 
f‹˚_h≥t_addªss
);

442 
ˇched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidü_f‹˚_íabÀ_h≥t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidü_f‹˚_íabÀ_h≥t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidü_f‹˚_íabÀ_h≥t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidü_f‹˚_íabÀ_h≥t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidü_f‹˚_íabÀ_h≥t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidü_f‹˚_íabÀ_h≥t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidü_f‹˚_íabÀ_h≥t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidü_f‹˚_íabÀ_h≥t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidü_f‹˚_íabÀ_h≥t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidü_f‹˚_íabÀ_h≥t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidü_f‹˚_íabÀ_h≥t
);

472 
	$f‹˚_h≥t_ªsume
()

474 
f‹˚_h≥t_ªsume_ty≥
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_f‹˚_h≥t_ªsume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`ﬁd_ich_f‹˚_h≥t_ªsume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_f‹˚_h≥t_ªsume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidü_f‹˚_h≥t_ªsume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_f‹˚_h≥t_ªsume
();

493 
	}
}

499 
	$f‹˚_dißbÀ_h≥t_msi
(
pci_dev
 *
unu£d
)

501 
h≥t_msi_dißbÀ
 = 1;

502 
	}
}

504 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

505 
f‹˚_dißbÀ_h≥t_msi
);

509 #i‡
deföed
(
CONFIG_PCI
Ë&& deföed(
CONFIG_NUMA
)

511 
__öô
 
	$quúk_amd_nb_node
(
pci_dev
 *
dev
)

513 
pci_dev
 *
nb_ht
;

514 
dev‚
;

515 
u32
 
node
;

516 
u32
 
vÆ
;

518 
dev‚
 = 
	`PCI_DEVFN
(
	`PCI_SLOT
(
dev
->devfn), 0);

519 
nb_ht
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, 
dev‚
);

520 i‡(!
nb_ht
)

523 
	`pci_ªad_c⁄fig_dw‹d
(
nb_ht
, 0x60, &
vÆ
);

524 
node
 = 
vÆ
 & 7;

529 i‡(
	`node_⁄löe
(
node
))

530 
	`£t_dev_node
(&
dev
->dev, 
node
);

531 
	`pci_dev_put
(
nb_ht
);

532 
	}
}

534 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

535 
quúk_amd_nb_node
);

536 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
,

537 
quúk_amd_nb_node
);

538 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
,

539 
quúk_amd_nb_node
);

540 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
,

541 
quúk_amd_nb_node
);

542 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_HT
,

543 
quúk_amd_nb_node
);

544 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MAP
,

545 
quúk_amd_nb_node
);

546 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_DRAM
,

547 
quúk_amd_nb_node
);

548 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
,

549 
quúk_amd_nb_node
);

550 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_LINK
,

551 
quúk_amd_nb_node
);

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ªboŸ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/pm.h
>

5 
	~<löux/efi.h
>

6 
	~<löux/dmi.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/tboŸ.h
>

9 
	~<a˝i/ªboŸ.h
>

10 
	~<asm/io.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/h≥t.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/ªboŸ_fixups.h
>

17 
	~<asm/ªboŸ.h
>

18 
	~<asm/pci_x86.h
>

19 
	~<asm/vúãxt.h
>

20 
	~<asm/˝u.h
>

22 #ifde‡
CONFIG_X86_32


23 
	~<löux/˘y≥.h
>

24 
	~<löux/mc146818πc.h
>

26 
	~<asm/x86_öô.h
>

32 (*
pm_powî_off
)();

33 
	`EXPORT_SYMBOL
(
pm_powî_off
);

35 c⁄° 
desc_±r
 
no_idt
 = {
	}
};

36 
	gªboŸ_mode
;

37 
ªboŸ_ty≥
 
	gªboŸ_ty≥
 = 
BOOT_KBD
;

38 
	gªboŸ_f‹˚
;

40 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_SMP
)

41 
	gªboŸ_˝u
 = -1;

48 
	gªboŸ_emîgícy
;

51 
boﬁ
 
	gp‹t_cf9_ß„
 = 
Ál£
;

65 
__öô
 
	$ªboŸ_£tup
(*
°r
)

68 *
°r
) {

70 
ªboŸ_mode
 = 0x1234;

74 
ªboŸ_mode
 = 0;

77 #ifde‡
CONFIG_X86_32


78 #ifde‡
CONFIG_SMP


80 i‡(
	`isdigô
(*(
°r
+1))) {

81 
ªboŸ_˝u
 = (Ë(*(
°r
+1) - '0');

82 i‡(
	`isdigô
(*(
°r
+2)))

83 
ªboŸ_˝u
 =ÑeboŸ_˝u*10 + ()(*(
°r
+2) - '0');

98 
ªboŸ_ty≥
 = *
°r
;

102 
ªboŸ_f‹˚
 = 1;

106 
°r
 = 
	`°rchr
(str, ',');

107 i‡(
°r
)

108 
°r
++;

113 
	}
}

115 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

118 #ifde‡
CONFIG_X86_32


128 
__öô
 
	$£t_bios_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

130 i‡(
ªboŸ_ty≥
 !
BOOT_BIOS
) {

131 
ªboŸ_ty≥
 = 
BOOT_BIOS
;

132 
	`¥ötk
(
KERN_INFO
 "%†£rõ†bﬂrd dëe˘ed. Sñe˘ög BIOS-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

135 
	}
}

137 
dmi_sy°em_id
 
__öôd©a
 
	gªboŸ_dmi_èbÀ
[] = {

139 .
ˇŒback
 = 
£t_bios_ªboŸ
,

140 .
	gidít
 = "Dell E520",

141 .
	gm©ches
 = {

142 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

143 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

147 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

148 .
	gidít
 = "Dell PowerEdge 1300",

149 .
	gm©ches
 = {

150 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

151 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

155 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

156 .
	gidít
 = "Dell PowerEdge 300",

157 .
	gm©ches
 = {

158 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

159 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

163 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

164 .
	gidít
 = "Dell OptiPlex 745",

165 .
	gm©ches
 = {

166 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

167 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

171 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

172 .
	gidít
 = "Dell OptiPlex 745",

173 .
	gm©ches
 = {

174 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

175 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

176 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

180 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

181 .
	gidít
 = "Dell OptiPlex 745",

182 .
	gm©ches
 = {

183 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

184 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

185 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

189 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

190 .
	gidít
 = "Dell OptiPlex 330",

191 .
	gm©ches
 = {

192 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

193 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

194 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

198 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

199 .
	gidít
 = "Dell OptiPlex 360",

200 .
	gm©ches
 = {

201 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

202 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 360"),

203 
DMI_MATCH
(
DMI_BOARD_NAME
, "0T656F"),

207 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

208 .
	gidít
 = "Dell OptiPlex 760",

209 .
	gm©ches
 = {

210 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

211 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 760"),

212 
DMI_MATCH
(
DMI_BOARD_NAME
, "0G919G"),

216 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

217 .
	gidít
 = "Dell PowerEdge 2400",

218 .
	gm©ches
 = {

219 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

220 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

224 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

225 .
	gidít
 = "Dell Precision T5400",

226 .
	gm©ches
 = {

227 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

228 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

232 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

233 .
	gidít
 = "HP Compaq Laptop",

234 .
	gm©ches
 = {

235 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

236 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

240 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

241 .
	gidít
 = "Dell XPS710",

242 .
	gm©ches
 = {

243 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

244 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

248 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

249 .
	gidít
 = "Dell DXP061",

250 .
	gm©ches
 = {

251 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

252 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

256 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

257 .
	gidít
 = "Sony VGN-Z540N",

258 .
	gm©ches
 = {

259 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

260 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

264 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

265 .
	gidít
 = "CompuLab SBC-FITPC2",

266 .
	gm©ches
 = {

267 
DMI_MATCH
(
DMI_SYS_VENDOR
, "CompuLab"),

268 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "SBC-FITPC2"),

272 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

273 .
	gidít
 = "ASUS P4S800",

274 .
	gm©ches
 = {

275 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

276 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4S800"),

282 
__öô
 
	$ªboŸ_öô
()

284 
	`dmi_check_sy°em
(
ªboŸ_dmi_èbÀ
);

286 
	}
}

287 
c‹e_öôˇŒ
(
ªboŸ_öô
);

296 
	gªÆ_mode_gdt_íåõs
 [3] =

303 c⁄° 
desc_±r


304 
	gªÆ_mode_gdt
 = {  (
ªÆ_mode_gdt_íåõs
) - 1, ()real_mode_gdt_entries },

305 
	gªÆ_mode_idt
 = { 0x3ff, 0 };

325 c⁄° 
	gªÆ_mode_swôch
 [] =

339 c⁄° 
	gjump_to_bios
 [] =

349 
	$machöe_ªÆ_ª°¨t
(c⁄° *
code
, 
Àngth
)

351 
	`loˇl_úq_dißbÀ
();

362 
	`•ö_lock
(&
πc_lock
);

363 
	`CMOS_WRITE
(0x00, 0x8f);

364 
	`•ö_u∆ock
(&
πc_lock
);

369 
	`mem˝y
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

370 (
sw≠≥r_pg_dú
 [0]Ë* 
KERNEL_PGD_PTRS
);

375 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

382 *((*)0x472Ë
ªboŸ_mode
;

389 
	`mem˝y
((*)(0x1000 - (
ªÆ_mode_swôch
) - 100),

390 
ªÆ_mode_swôch
,  (real_mode_switch));

391 
	`mem˝y
((*)(0x1000 - 100), 
code
, 
Àngth
);

394 
	`lﬂd_idt
(&
ªÆ_mode_idt
);

399 
	`lﬂd_gdt
(&
ªÆ_mode_gdt
);

406 
__asm__
 
	`__vﬁ©ûe__
 ("movl $0x0010,%%eax\n"

416 
__asm__
 
	`__vﬁ©ûe__
 ("ljmp $0x0008,%0"

418 : "i" ((*)(0x1000 -  (
ªÆ_mode_swôch
) - 100)));

419 
	}
}

420 #ifde‡
CONFIG_APM_MODULE


421 
EXPORT_SYMBOL
(
machöe_ªÆ_ª°¨t
);

429 
__öô
 
	$£t_pci_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

431 i‡(
ªboŸ_ty≥
 !
BOOT_CF9
) {

432 
ªboŸ_ty≥
 = 
BOOT_CF9
;

433 
	`¥ötk
(
KERN_INFO
 "%s series board detected. "

434 "Sñe˘ög PCI-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

437 
	}
}

439 
dmi_sy°em_id
 
__öôd©a
 
	gpci_ªboŸ_dmi_èbÀ
[] = {

441 .
ˇŒback
 = 
£t_pci_ªboŸ
,

442 .
	gidít
 = "Apple MacBook5",

443 .
	gm©ches
 = {

444 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

445 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBook5"),

449 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

450 .
	gidít
 = "Apple MacBookPro5",

451 .
	gm©ches
 = {

452 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

453 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBookPro5"),

457 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

458 .
	gidít
 = "Apple Macmini3,1",

459 .
	gm©ches
 = {

460 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

461 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Macmini3,1"),

465 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

466 .
	gidít
 = "Apple iMac9,1",

467 .
	gm©ches
 = {

468 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

469 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "iMac9,1"),

475 
__öô
 
	$pci_ªboŸ_öô
()

477 
	`dmi_check_sy°em
(
pci_ªboŸ_dmi_èbÀ
);

479 
	}
}

480 
c‹e_öôˇŒ
(
pci_ªboŸ_öô
);

482 
ölöe
 
	$kb_waô
()

484 
i
;

486 
i
 = 0; i < 0x10000; i++) {

487 i‡((
	`öb
(0x64) & 0x02) == 0)

489 
	`udñay
(2);

491 
	}
}

493 
	$vmxoff_nmi
(
˝u
, 
dõ_¨gs
 *
¨gs
)

495 
	`˝u_emîgícy_vmxoff
();

496 
	}
}

500 
	$emîgícy_vmx_dißbÀ_Æl
()

503 
	`loˇl_úq_dißbÀ
();

523 i‡(
	`˝u_has_vmx
(Ë&& 
	`˝u_vmx_íabÀd
()) {

526 
	`˝u_vmxoff
();

529 
	`nmi_shoŸdown_˝us
(
vmxoff_nmi
);

532 
	}
}

535 
__©åibuã__
((
wók
)Ë
	$mach_ªboŸ_fixups
()

537 
	}
}

539 
	$«tive_machöe_emîgícy_ª°¨t
()

541 
i
;

543 i‡(
ªboŸ_emîgícy
)

544 
	`emîgícy_vmx_dißbÀ_Æl
();

546 
	`tboŸ_shutdown
(
TB_SHUTDOWN_REBOOT
);

549 *((*)
	`__va
(0x472)Ë
ªboŸ_mode
;

553 
ªboŸ_ty≥
) {

554 
BOOT_KBD
:

555 
	`mach_ªboŸ_fixups
();

557 
i
 = 0; i < 10; i++) {

558 
	`kb_waô
();

559 
	`udñay
(50);

560 
	`outb
(0xfe, 0x64);

561 
	`udñay
(50);

564 
BOOT_TRIPLE
:

565 
	`lﬂd_idt
(&
no_idt
);

566 
__asm__
 
	`__vﬁ©ûe__
("int3");

568 
ªboŸ_ty≥
 = 
BOOT_KBD
;

571 #ifde‡
CONFIG_X86_32


572 
BOOT_BIOS
:

573 
	`machöe_ªÆ_ª°¨t
(
jump_to_bios
, (jump_to_bios));

575 
ªboŸ_ty≥
 = 
BOOT_KBD
;

579 
BOOT_ACPI
:

580 
	`a˝i_ªboŸ
();

581 
ªboŸ_ty≥
 = 
BOOT_KBD
;

584 
BOOT_EFI
:

585 i‡(
efi_íabÀd
)

586 
efi
.
	`ª£t_sy°em
(
ªboŸ_mode
 ?

587 
EFI_RESET_WARM
 :

588 
EFI_RESET_COLD
,

589 
EFI_SUCCESS
, 0, 
NULL
);

590 
ªboŸ_ty≥
 = 
BOOT_KBD
;

593 
BOOT_CF9
:

594 
p‹t_cf9_ß„
 = 
åue
;

597 
BOOT_CF9_COND
:

598 i‡(
p‹t_cf9_ß„
) {

599 
u8
 
cf9
 = 
	`öb
(0xcf9) & ~6;

600 
	`outb
(
cf9
|2, 0xcf9);

601 
	`udñay
(50);

602 
	`outb
(
cf9
|6, 0xcf9);

603 
	`udñay
(50);

605 
ªboŸ_ty≥
 = 
BOOT_KBD
;

609 
	}
}

611 
	$«tive_machöe_shutdown
()

614 #ifde‡
CONFIG_SMP


617 
ªboŸ_˝u_id
 = 0;

619 #ifde‡
CONFIG_X86_32


621 i‡((
ªboŸ_˝u
 !-1Ë&& (ªboŸ_˝u < 
ƒ_˝u_ids
) &&

622 
	`˝u_⁄löe
(
ªboŸ_˝u
))

623 
ªboŸ_˝u_id
 = 
ªboŸ_˝u
;

627 i‡(!
	`˝u_⁄löe
(
ªboŸ_˝u_id
))

628 
ªboŸ_˝u_id
 = 
	`smp_¥o˚ss‹_id
();

631 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
ªboŸ_˝u_id
));

636 
	`smp_£nd_°›
();

639 
	`œpic_shutdown
();

641 #ifde‡
CONFIG_X86_IO_APIC


642 
	`dißbÀ_IO_APIC
();

645 #ifde‡
CONFIG_HPET_TIMER


646 
	`h≥t_dißbÀ
();

649 #ifde‡
CONFIG_X86_64


650 
x86_∂©f‹m
.
	`iommu_shutdown
();

652 
	}
}

654 
	$__machöe_emîgícy_ª°¨t
(
emîgícy
)

656 
ªboŸ_emîgícy
 = 
emîgícy
;

657 
machöe_›s
.
	`emîgícy_ª°¨t
();

658 
	}
}

660 
	$«tive_machöe_ª°¨t
(*
__unu£d
)

662 
	`¥ötk
("machineÑestart\n");

664 i‡(!
ªboŸ_f‹˚
)

665 
	`machöe_shutdown
();

666 
	`__machöe_emîgícy_ª°¨t
(0);

667 
	}
}

669 
	$«tive_machöe_hÆt
()

672 
	`machöe_shutdown
();

674 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

677 
	`°›_this_˝u
(
NULL
);

678 
	}
}

680 
	$«tive_machöe_powî_off
()

682 i‡(
pm_powî_off
) {

683 i‡(!
ªboŸ_f‹˚
)

684 
	`machöe_shutdown
();

685 
	`pm_powî_off
();

688 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

689 
	}
}

691 
machöe_›s
 
	gmachöe_›s
 = {

692 .
powî_off
 = 
«tive_machöe_powî_off
,

693 .
	gshutdown
 = 
«tive_machöe_shutdown
,

694 .
	gemîgícy_ª°¨t
 = 
«tive_machöe_emîgícy_ª°¨t
,

695 .
	gª°¨t
 = 
«tive_machöe_ª°¨t
,

696 .
	ghÆt
 = 
«tive_machöe_hÆt
,

697 #ifde‡
CONFIG_KEXEC


698 .
	g¸ash_shutdown
 = 
«tive_machöe_¸ash_shutdown
,

702 
	$machöe_powî_off
()

704 
machöe_›s
.
	`powî_off
();

705 
	}
}

707 
	$machöe_shutdown
()

709 
machöe_›s
.
	`shutdown
();

710 
	}
}

712 
	$machöe_emîgícy_ª°¨t
()

714 
	`__machöe_emîgícy_ª°¨t
(1);

715 
	}
}

717 
	$machöe_ª°¨t
(*
cmd
)

719 
machöe_›s
.
	`ª°¨t
(
cmd
);

720 
	}
}

722 
	$machöe_hÆt
()

724 
machöe_›s
.
	`hÆt
();

725 
	}
}

727 #ifde‡
CONFIG_KEXEC


728 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

730 
machöe_›s
.
	`¸ash_shutdown
(
ªgs
);

731 
	}
}

735 #i‡
deföed
(
CONFIG_SMP
)

738 
	g¸ashög_˝u
;

739 
nmi_shoŸdown_cb
 
	gshoŸdown_ˇŒback
;

741 
©omic_t
 
	gwaôög_f‹_¸ash_ùi
;

743 
	$¸ash_nmi_ˇŒback
(
nŸifõr_block
 *
£lf
,

744 
vÆ
, *
d©a
)

746 
˝u
;

748 i‡(
vÆ
 !
DIE_NMI_IPI
)

749  
NOTIFY_OK
;

751 
˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

757 i‡(
˝u
 =
¸ashög_˝u
)

758  
NOTIFY_STOP
;

759 
	`loˇl_úq_dißbÀ
();

761 
	`shoŸdown_ˇŒback
(
˝u
, (
dõ_¨gs
 *)
d©a
);

763 
	`©omic_dec
(&
waôög_f‹_¸ash_ùi
);

765 
	`hÆt
();

767 
	`˝u_ªœx
();

770 
	}
}

772 
	$smp_£nd_nmi_Ælbut£lf
()

774 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
NMI_VECTOR
);

775 
	}
}

777 
nŸifõr_block
 
	g¸ash_nmi_nb
 = {

778 .
nŸifõr_ˇŒ
 = 
¸ash_nmi_ˇŒback
,

787 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

789 
m£cs
;

790 
	`loˇl_úq_dißbÀ
();

793 
¸ashög_˝u
 = 
	`ß„_smp_¥o˚ss‹_id
();

795 
shoŸdown_ˇŒback
 = 
ˇŒback
;

797 
	`©omic_£t
(&
waôög_f‹_¸ash_ùi
, 
	`num_⁄löe_˝us
() - 1);

799 i‡(
	`ªgi°î_dõ_nŸifõr
(&
¸ash_nmi_nb
))

804 
	`wmb
();

806 
	`smp_£nd_nmi_Ælbut£lf
();

808 
m£cs
 = 1000;

809 (
	`©omic_ªad
(&
waôög_f‹_¸ash_ùi
Ë> 0Ë&& 
m£cs
) {

810 
	`mdñay
(1);

811 
m£cs
--;

815 
	}
}

817 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

820 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<löux/∂©f‹m_devi˚.h
>

5 
	~<löux/mc146818πc.h
>

6 
	~<löux/a˝i.h
>

7 
	~<löux/bcd.h
>

8 
	~<löux/≤p.h
>

10 
	~<asm/vsysˇŒ.h
>

11 
	~<asm/x86_öô.h
>

12 
	~<asm/time.h
>

14 #ifde‡
CONFIG_X86_32


20 vﬁ©ûê
	gcmos_lock
;

21 
EXPORT_SYMBOL
(
cmos_lock
);

25 
	#CMOS_YEARS_OFFS
 2000

	)

27 
DEFINE_SPINLOCK
(
πc_lock
);

28 
EXPORT_SYMBOL
(
πc_lock
);

40 
	$mach_£t_πc_mmss
(
nowtime
)

42 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

43 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

44 
ªtvÆ
 = 0;

47 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

48 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

51 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

52 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

54 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

55 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

56 
cmos_möuãs
 = 
	`bcd2bö
(cmos_minutes);

64 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

65 
ªÆ_möuãs
 = 
nowtime
 / 60;

67 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

68 
ªÆ_möuãs
 += 30;

69 
ªÆ_möuãs
 %= 60;

71 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

72 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

73 
ªÆ_£c⁄ds
 = 
	`bö2bcd
(real_seconds);

74 
ªÆ_möuãs
 = 
	`bö2bcd
(real_minutes);

76 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
, 
RTC_SECONDS
);

77 
	`CMOS_WRITE
(
ªÆ_möuãs
, 
RTC_MINUTES
);

79 
	`¥ötk
(
KERN_WARNING


81 
cmos_möuãs
, 
ªÆ_möuãs
);

82 
ªtvÆ
 = -1;

92 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

93 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

95  
ªtvÆ
;

96 
	}
}

98 
	$mach_gë_cmos_time
()

100 
°©us
, 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
˚¡ury
 = 0;

108 (
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
))

109 
	`˝u_ªœx
();

111 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

112 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

113 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

114 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

115 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

116 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

118 #ifde‡
CONFIG_ACPI


119 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

120 
a˝i_gbl_FADT
.
˚¡ury
)

121 
˚¡ury
 = 
	`CMOS_READ
(
a˝i_gbl_FADT
.century);

124 
°©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

125 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
°©us
 & 
RTC_DM_BINARY
));

127 i‡(
RTC_ALWAYS_BCD
 || !(
°©us
 & 
RTC_DM_BINARY
)) {

128 
£c
 = 
	`bcd2bö
(sec);

129 
mö
 = 
	`bcd2bö
(min);

130 
hour
 = 
	`bcd2bö
(hour);

131 
day
 = 
	`bcd2bö
(day);

132 
m⁄
 = 
	`bcd2bö
(mon);

133 
yór
 = 
	`bcd2bö
(year);

136 i‡(
˚¡ury
) {

137 
˚¡ury
 = 
	`bcd2bö
(century);

138 
yór
 +
˚¡ury
 * 100;

139 
	`¥ötk
(
KERN_INFO
 "Exãnded CMOS yór: %d\n", 
˚¡ury
 * 100);

141 
yór
 +
CMOS_YEARS_OFFS
;

143  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

144 
	}
}

147 
	$πc_cmos_ªad
(
addr
)

149 
vÆ
;

151 
	`lock_cmos_¥efix
(
addr
);

152 
	`outb
(
addr
, 
	`RTC_PORT
(0));

153 
vÆ
 = 
	`öb
(
	`RTC_PORT
(1));

154 
	`lock_cmos_suffix
(
addr
);

156  
vÆ
;

157 
	}
}

158 
EXPORT_SYMBOL
(
πc_cmos_ªad
);

160 
	$πc_cmos_wrôe
(
vÆ
, 
addr
)

162 
	`lock_cmos_¥efix
(
addr
);

163 
	`outb
(
addr
, 
	`RTC_PORT
(0));

164 
	`outb
(
vÆ
, 
	`RTC_PORT
(1));

165 
	`lock_cmos_suffix
(
addr
);

166 
	}
}

167 
EXPORT_SYMBOL
(
πc_cmos_wrôe
);

169 
	$upd©e_≥rsi°ít_˛ock
(
time•ec
 
now
)

171 
Êags
;

172 
ªtvÆ
;

174 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

175 
ªtvÆ
 = 
x86_∂©f‹m
.
	`£t_wÆl˛ock
(
now
.
tv_£c
);

176 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

178  
ªtvÆ
;

179 
	}
}

182 
	$ªad_≥rsi°ít_˛ock
(
time•ec
 *
ts
)

184 
ªtvÆ
, 
Êags
;

186 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

187 
ªtvÆ
 = 
x86_∂©f‹m
.
	`gë_wÆl˛ock
();

188 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

190 
ts
->
tv_£c
 = 
ªtvÆ
;

191 
ts
->
tv_n£c
 = 0;

192 
	}
}

194 
	$«tive_ªad_tsc
()

196  
	`__«tive_ªad_tsc
();

197 
	}
}

198 
EXPORT_SYMBOL
(
«tive_ªad_tsc
);

201 
ªsour˚
 
	gπc_ªsour˚s
[] = {

203 .
°¨t
 = 
RTC_PORT
(0),

204 .
	gíd
 = 
RTC_PORT
(1),

205 .
	gÊags
 = 
IORESOURCE_IO
,

208 .
°¨t
 = 
RTC_IRQ
,

209 .
	gíd
 = 
RTC_IRQ
,

210 .
	gÊags
 = 
IORESOURCE_IRQ
,

214 
∂©f‹m_devi˚
 
	gπc_devi˚
 = {

215 .
«me
 = "rtc_cmos",

216 .
	gid
 = -1,

217 .
	gªsour˚
 = 
πc_ªsour˚s
,

218 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

221 
__öô
 
	$add_πc_cmos
()

223 #ifde‡
CONFIG_PNP


224 c⁄° *
ids
[] 
__öôc⁄°
 =

226 
≤p_dev
 *
dev
;

227 
≤p_id
 *
id
;

228 
i
;

230 
	`≤p_f‹_óch_dev
(
dev
) {

231 
id
 = 
dev
->id; id; id = id->
√xt
) {

232 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

233 i‡(
	`com∑ª_≤p_id
(
id
, 
ids
[
i
]) != 0)

240 
	`∂©f‹m_devi˚_ªgi°î
(&
πc_devi˚
);

241 
	`dev_öfo
(&
πc_devi˚
.
dev
,

245 
	}
}

246 
devi˚_öôˇŒ
(
add_πc_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<löux/sched.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/mmz⁄e.h
>

27 
	~<löux/s¸ìn_öfo.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/a˝i.h
>

30 
	~<löux/sfi.h
>

31 
	~<löux/≠m_bios.h
>

32 
	~<löux/öôrd.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/c⁄sﬁe.h
>

36 
	~<löux/mˇ.h
>

37 
	~<löux/roŸ_dev.h
>

38 
	~<löux/highmem.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/efi.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/edd.h
>

43 
	~<löux/iscsi_ib·.h
>

44 
	~<löux/nodemask.h
>

45 
	~<löux/kexec.h
>

46 
	~<löux/dmi.h
>

47 
	~<löux/p‚.h
>

48 
	~<löux/pci.h
>

49 
	~<asm/pci-dúe˘.h
>

50 
	~<löux/öô_ohci1394_dma.h
>

51 
	~<löux/kvm_∑ø.h
>

53 
	~<löux/î∫o.h
>

54 
	~<löux/kî√l.h
>

55 
	~<löux/°ddef.h
>

56 
	~<löux/uni°d.h
>

57 
	~<löux/±ø˚.h
>

58 
	~<löux/u£r.h
>

59 
	~<löux/dñay.h
>

61 
	~<löux/kÆlsyms.h
>

62 
	~<löux/˝u‰eq.h
>

63 
	~<löux/dma-m≠pög.h
>

64 
	~<löux/˘y≥.h
>

65 
	~<löux/uac˚ss.h
>

67 
	~<löux/≥r˝u.h
>

68 
	~<löux/¸ash_dump.h
>

69 
	~<löux/tboŸ.h
>

71 
	~<video/edid.h
>

73 
	~<asm/mår.h
>

74 
	~<asm/≠ic.h
>

75 
	~<asm/åampﬁöe.h
>

76 
	~<asm/e820.h
>

77 
	~<asm/mp•ec.h
>

78 
	~<asm/£tup.h
>

79 
	~<asm/efi.h
>

80 
	~<asm/timî.h
>

81 
	~<asm/i8259.h
>

82 
	~<asm/£˘i⁄s.h
>

83 
	~<asm/dmi.h
>

84 
	~<asm/io_≠ic.h
>

85 
	~<asm/i°.h
>

86 
	~<asm/vmi.h
>

87 
	~<asm/£tup_¨ch.h
>

88 
	~<asm/bios_ebda.h
>

89 
	~<asm/ˇcheÊush.h
>

90 
	~<asm/¥o˚ss‹.h
>

91 
	~<asm/bugs.h
>

93 
	~<asm/sy°em.h
>

94 
	~<asm/vsysˇŒ.h
>

95 
	~<asm/˝u.h
>

96 
	~<asm/desc.h
>

97 
	~<asm/dma.h
>

98 
	~<asm/iommu.h
>

99 
	~<asm/g¨t.h
>

100 
	~<asm/mmu_c⁄ãxt.h
>

101 
	~<asm/¥Ÿo.h
>

103 
	~<asm/∑øvút.h
>

104 
	~<asm/hy≥rvis‹.h
>

106 
	~<asm/≥r˝u.h
>

107 
	~<asm/t›ﬁogy.h
>

108 
	~<asm/≠icdef.h
>

109 
	~<asm/k8.h
>

110 #ifde‡
CONFIG_X86_64


111 
	~<asm/numa_64.h
>

113 
	~<asm/m˚.h
>

120 
	gmax_low_p‚_m≠≥d
;

121 
	gmax_p‚_m≠≥d
;

123 #ifde‡
CONFIG_DMI


124 
RESERVE_BRK
(
dmi_Æloc
, 65536);

127 
boŸ_˝u_id
 
	g__ªad_mo°ly
;

129 
__öôd©a
 
	g_brk_°¨t
 = ()
__brk_ba£
;

130 
	g_brk_íd
 = ()
__brk_ba£
;

132 #ifde‡
CONFIG_X86_64


133 
	$deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
)

135  
	`__deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
);

136 
	}
}

138 
	$deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
)

140  
	`__deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
);

141 
	}
}

144 #i‚de‡
CONFIG_DEBUG_BOOT_PARAMS


145 
boŸ_∑øms
 
__öôd©a
 
	gboŸ_∑øms
;

147 
boŸ_∑øms
 
	gboŸ_∑øms
;

153 
ªsour˚
 
	gd©a_ªsour˚
 = {

154 .
«me
 = "Kernel data",

155 .
	g°¨t
 = 0,

156 .
	gíd
 = 0,

157 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


160 
ªsour˚
 
	gcode_ªsour˚
 = {

161 .
«me
 = "Kernel code",

162 .
	g°¨t
 = 0,

163 .
	gíd
 = 0,

164 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


167 
ªsour˚
 
	gbss_ªsour˚
 = {

168 .
«me
 = "Kernel bss",

169 .
	g°¨t
 = 0,

170 .
	gíd
 = 0,

171 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


175 #ifde‡
CONFIG_X86_32


177 
˝uöfo_x86
 
√w_˝u_d©a
 
	g__˝uöôd©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

179 
˝uöfo_x86
 
boŸ_˝u_d©a
 
	g__ªad_mo°ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

180 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

181 
	$£t_mˇ_bus
(
x
)

183 #ifde‡
CONFIG_MCA


184 
MCA_bus
 = 
x
;

186 
	}
}

188 
	gdef_to_bigsmp
;

191 
	gmachöe_id
;

192 
	gmachöe_submodñ_id
;

193 
	gBIOS_ªvisi⁄
;

195 
≠m_öfo
 
	g≠m_öfo
;

196 
EXPORT_SYMBOL
(
≠m_öfo
);

198 #i‡
deföed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

199 
	$deföed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

200 
i°_öfo
 ist_info;

201 
	`EXPORT_SYMBOL
(
i°_öfo
);

203 
i°_öfo
 ist_info;

207 
˝uöfo_x86
 
boŸ_˝u_d©a
 
__ªad_mo°ly
 = {

208 .
x86_phys_bôs
 = 
MAX_PHYSMEM_BITS
,

209 
	}
};

210 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

214 #i‡!
deföed
(
CONFIG_X86_PAE
Ë|| deföed(
CONFIG_X86_64
)

215 
	gmmu_¸4_„©uªs
;

217 
	gmmu_¸4_„©uªs
 = 
X86_CR4_PAE
;

221 
	gboŸlﬂdî_ty≥
, 
	gboŸlﬂdî_vîsi⁄
;

226 
s¸ìn_öfo
 
	gs¸ìn_öfo
;

227 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

228 
edid_öfo
 
	gedid_öfo
;

229 
EXPORT_SYMBOL_GPL
(
edid_öfo
);

231 
roŸ_mou¡Êags
;

233 
	gßved_video_mode
;

235 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

236 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

237 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

239 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

240 #ifde‡
CONFIG_CMDLINE_BOOL


241 
__öôd©a
 
	gbuûtö_cmdlöe
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

244 #i‡
deföed
(
CONFIG_EDD
Ë|| deföed(
CONFIG_EDD_MODULE
)

245 
edd
 
	gedd
;

246 #ifde‡
CONFIG_EDD_MODULE


247 
EXPORT_SYMBOL
(
edd
);

254 
ölöe
 
__öô
 
	$c›y_edd
()

256 
	`mem˝y
(
edd
.
mbr_sig«tuª
, 
boŸ_∑øms
.
edd_mbr_sig_buf„r
,

257 (
edd
.
mbr_sig«tuª
));

258 
	`mem˝y
(
edd
.
edd_öfo
, 
boŸ_∑øms
.
eddbuf
, (edd.edd_info));

259 
edd
.
mbr_sig«tuª_ƒ
 = 
boŸ_∑øms
.
edd_mbr_sig_buf_íåõs
;

260 
edd
.
edd_öfo_ƒ
 = 
boŸ_∑øms
.
eddbuf_íåõs
;

261 
	}
}

263 
ölöe
 
__öô
 
	$c›y_edd
()

265 
	}
}

268 * 
__öô
 
	$exãnd_brk
(
size_t
 
size
, size_à
Æign
)

270 
size_t
 
mask
 = 
Æign
 - 1;

271 *
ªt
;

273 
	`BUG_ON
(
_brk_°¨t
 == 0);

274 
	`BUG_ON
(
Æign
 & 
mask
);

276 
_brk_íd
 = (_brk_íd + 
mask
) & ~mask;

277 
	`BUG_ON
((*)(
_brk_íd
 + 
size
Ë> 
__brk_limô
);

279 
ªt
 = (*)
_brk_íd
;

280 
_brk_íd
 +
size
;

282 
	`mem£t
(
ªt
, 0, 
size
);

284  
ªt
;

285 
	}
}

287 #ifde‡
CONFIG_X86_64


288 
__öô
 
	$öô_gb∑ges
()

290 i‡(
dúe˘_gb∑ges
 && 
˝u_has_gb∑ges
)

291 
	`¥ötk
(
KERN_INFO
 "Using GBÖages for direct mapping\n");

293 
dúe˘_gb∑ges
 = 0;

294 
	}
}

296 
ölöe
 
	$öô_gb∑ges
()

298 
	}
}

301 
__öô
 
	$ª£rve_brk
()

303 i‡(
_brk_íd
 > 
_brk_°¨t
)

304 
	`ª£rve_óæy
(
	`__∑
(
_brk_°¨t
), __∑(
_brk_íd
), "BRK");

308 
_brk_°¨t
 = 0;

309 
	}
}

311 #ifde‡
CONFIG_BLK_DEV_INITRD


313 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

314 
__öô
 
	$ªloˇã_öôrd
()

317 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

318 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

319 
u64
 
¨ó_size
 = 
	`PAGE_ALIGN
(
ømdisk_size
);

320 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

321 
u64
 
ømdisk_hîe
;

322 
¶›
, 
˛í
, 
m≠addr
;

323 *
p
, *
q
;

326 
ømdisk_hîe
 = 
	`föd_e820_¨ó
(0, 
íd_of_lowmem
, 
¨ó_size
,

327 
PAGE_SIZE
);

329 i‡(
ømdisk_hîe
 == -1ULL)

330 
	`∑nic
("Cannot findÖlace forÇew RAMDISK of size %lld\n",

331 
ømdisk_size
);

335 
	`ª£rve_óæy
(
ømdisk_hîe
,Ñamdisk_hîê+ 
¨ó_size
,

337 
öôrd_°¨t
 = 
ømdisk_hîe
 + 
PAGE_OFFSET
;

338 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

339 
	`¥ötk
(
KERN_INFO
 "AllocatedÇew RAMDISK: %08llx - %08llx\n",

340 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
);

342 
q
 = (*)
öôrd_°¨t
;

345 i‡(
ømdisk_image
 < 
íd_of_lowmem
) {

346 
˛í
 = 
íd_of_lowmem
 - 
ømdisk_image
;

347 
p
 = (*)
	`__va
(
ømdisk_image
);

348 
	`mem˝y
(
q
, 
p
, 
˛í
);

349 
q
 +
˛í
;

350 
ømdisk_image
 +
˛í
;

351 
ømdisk_size
 -
˛í
;

355 
ømdisk_size
) {

356 
¶›
 = 
ømdisk_image
 & ~
PAGE_MASK
;

357 
˛í
 = 
ømdisk_size
;

358 i‡(
˛í
 > 
MAX_MAP_CHUNK
-
¶›
)

359 
˛í
 = 
MAX_MAP_CHUNK
-
¶›
;

360 
m≠addr
 = 
ømdisk_image
 & 
PAGE_MASK
;

361 
p
 = 
	`óæy_memªm≠
(
m≠addr
, 
˛í
+
¶›
);

362 
	`mem˝y
(
q
, 
p
+
¶›
, 
˛í
);

363 
	`óæy_iounm≠
(
p
, 
˛í
+
¶›
);

364 
q
 +
˛í
;

365 
ømdisk_image
 +
˛í
;

366 
ømdisk_size
 -
˛í
;

369 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

370 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

371 
	`¥ötk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxÅo"

373 
ømdisk_image
,Ñamdisk_imagê+ 
ømdisk_size
 - 1,

374 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
 - 1);

375 
	}
}

377 
__öô
 
	$ª£rve_öôrd
()

380 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

381 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

382 
u64
 
ømdisk_íd
 = 
	`PAGE_ALIGN
(
ømdisk_image
 + 
ømdisk_size
);

383 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

385 i‡(!
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 ||

386 !
ømdisk_image
 || !
ømdisk_size
)

389 
öôrd_°¨t
 = 0;

391 i‡(
ømdisk_size
 >(
íd_of_lowmem
>>1)) {

392 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

393 
	`¥ötk
(
KERN_ERR
 "initrdÅooÜargeÅo handle, "

398 
	`¥ötk
(
KERN_INFO
 "RAMDISK: %08Œx - %08Œx\n", 
ømdisk_image
,

399 
ømdisk_íd
);

402 i‡(
ømdisk_íd
 <
íd_of_lowmem
) {

408 
öôrd_°¨t
 = 
ømdisk_image
 + 
PAGE_OFFSET
;

409 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

413 
	`ªloˇã_öôrd
();

415 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

416 
	}
}

418 
__öô
 
	$ª£rve_öôrd
()

420 
	}
}

423 
__öô
 
	$∑r£_£tup_d©a
()

425 
£tup_d©a
 *
d©a
;

426 
u64
 
∑_d©a
;

428 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

430 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

431 
∑_d©a
) {

432 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, 
PAGE_SIZE
);

433 
d©a
->
ty≥
) {

434 
SETUP_E820_EXT
:

435 
	`∑r£_e820_ext
(
d©a
, 
∑_d©a
);

440 
∑_d©a
 = 
d©a
->
√xt
;

441 
	`óæy_iounm≠
(
d©a
, 
PAGE_SIZE
);

443 
	}
}

445 
__öô
 
	$e820_ª£rve_£tup_d©a
()

447 
£tup_d©a
 *
d©a
;

448 
u64
 
∑_d©a
;

449 
found
 = 0;

451 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

453 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

454 
∑_d©a
) {

455 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

456 
	`e820_upd©e_ønge
(
∑_d©a
, (*
d©a
)+d©a->
Àn
,

457 
E820_RAM
, 
E820_RESERVED_KERN
);

458 
found
 = 1;

459 
∑_d©a
 = 
d©a
->
√xt
;

460 
	`óæy_iounm≠
(
d©a
, (*data));

462 i‡(!
found
)

465 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

466 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

467 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

468 
	`e820_¥öt_m≠
("reserve setup_data");

469 
	}
}

471 
__öô
 
	$ª£rve_óæy_£tup_d©a
()

473 
£tup_d©a
 *
d©a
;

474 
u64
 
∑_d©a
;

475 
buf
[32];

477 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

479 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

480 
∑_d©a
) {

481 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

482 
	`•rötf
(
buf
, "£tu∞d©®%x", 
d©a
->
ty≥
);

483 
	`ª£rve_óæy
(
∑_d©a
,Öa_d©a+(*
d©a
)+d©a->
Àn
, 
buf
);

484 
∑_d©a
 = 
d©a
->
√xt
;

485 
	`óæy_iounm≠
(
d©a
, (*data));

487 
	}
}

493 #ifde‡
CONFIG_KEXEC


495 
ölöe
 
	$gë_tŸÆ_mem
()

497 
tŸÆ
;

499 
tŸÆ
 = 
max_p‚
 - 
mö_low_p‚
;

501  
tŸÆ
 << 
PAGE_SHIFT
;

502 
	}
}

504 
__öô
 
	$ª£rve_¸ashkî√l
()

506 
tŸÆ_mem
;

507 
¸ash_size
, 
¸ash_ba£
;

508 
ªt
;

510 
tŸÆ_mem
 = 
	`gë_tŸÆ_mem
();

512 
ªt
 = 
	`∑r£_¸ashkî√l
(
boŸ_comm™d_löe
, 
tŸÆ_mem
,

513 &
¸ash_size
, &
¸ash_ba£
);

514 i‡(
ªt
 !0 || 
¸ash_size
 <= 0)

518 i‡(
¸ash_ba£
 <= 0) {

519 c⁄° 
Æignmít
 = 16<<20;

521 
¸ash_ba£
 = 
	`föd_e820_¨ó
(
Æignmít
, 
ULONG_MAX
, 
¸ash_size
,

522 
Æignmít
);

523 i‡(
¸ash_ba£
 == -1ULL) {

524 
	`¥_öfo
("crashkernelÑeservation failed - No suitableárea found.\n");

528 
°¨t
;

530 
°¨t
 = 
	`föd_e820_¨ó
(
¸ash_ba£
, 
ULONG_MAX
, 
¸ash_size
,

532 i‡(
°¨t
 !
¸ash_ba£
) {

533 
	`¥_öfo
("crashkernelÑeservation failed - memory is in use.\n");

537 
	`ª£rve_óæy
(
¸ash_ba£
, cøsh_ba£ + 
¸ash_size
, "CRASH KERNEL");

539 
	`¥ötk
(
KERN_INFO
 "Reserving %ldMB of memoryát %ldMB "

541 ()(
¸ash_size
 >> 20),

542 ()(
¸ash_ba£
 >> 20),

543 ()(
tŸÆ_mem
 >> 20));

545 
¸ashk_ªs
.
°¨t
 = 
¸ash_ba£
;

546 
¸ashk_ªs
.
íd
 = 
¸ash_ba£
 + 
¸ash_size
 - 1;

547 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
¸ashk_ªs
);

548 
	}
}

550 
__öô
 
	$ª£rve_¸ashkî√l
()

552 
	}
}

555 
ªsour˚
 
	g°™d¨d_io_ªsour˚s
[] = {

556 { .
«me
 = "dma1", .
	g°¨t
 = 0x00, .
	gíd
 = 0x1f,

557 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

558 { .
	g«me
 = "pic1", .
	g°¨t
 = 0x20, .
	gíd
 = 0x21,

559 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

560 { .
	g«me
 = "timî0", .
	g°¨t
 = 0x40, .
	gíd
 = 0x43,

561 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

562 { .
	g«me
 = "timî1", .
	g°¨t
 = 0x50, .
	gíd
 = 0x53,

563 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

564 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x60, .
	gíd
 = 0x60,

565 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

566 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x64, .
	gíd
 = 0x64,

567 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

568 { .
	g«me
 = "dm®∑gêªg", .
	g°¨t
 = 0x80, .
	gíd
 = 0x8f,

569 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

570 { .
	g«me
 = "pic2", .
	g°¨t
 = 0xa0, .
	gíd
 = 0xa1,

571 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

572 { .
	g«me
 = "dma2", .
	g°¨t
 = 0xc0, .
	gíd
 = 0xdf,

573 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

574 { .
	g«me
 = "Âu", .
	g°¨t
 = 0xf0, .
	gíd
 = 0xff,

575 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

578 
__öô
 
	$ª£rve_°™d¨d_io_ªsour˚s
()

580 
i
;

583 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); i++)

584 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
°™d¨d_io_ªsour˚s
[
i
]);

586 
	}
}

594 #ifde‡
CONFIG_CRASH_DUMP


599 
__öô
 
	$£tup_ñfc‹ehdr
(*
¨g
)

601 *
íd
;

602 i‡(!
¨g
)

603  -
EINVAL
;

604 
ñfc‹ehdr_addr
 = 
	`mem∑r£
(
¨g
, &
íd
);

605  
íd
 > 
¨g
 ? 0 : -
EINVAL
;

606 
	}
}

607 
óæy_∑øm
("ñfc‹ehdr", 
£tup_ñfc‹ehdr
);

610 
__öô
 
	$ª£rve_ib·_ªgi⁄
()

612 
addr
, 
size
 = 0;

614 
addr
 = 
	`föd_ib·_ªgi⁄
(&
size
);

616 i‡(
size
)

617 
	`ª£rve_óæy_ovîœp_ok
(
addr
,ádd∏+ 
size
, "ibft");

618 
	}
}

620 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


621 
__öô
 
	$dmi_low_mem‹y_c‹ru±i⁄
(c⁄° 
dmi_sy°em_id
 *
d
)

623 
	`¥ötk
(
KERN_NOTICE


625 
d
->
idít
);

627 
	`e820_upd©e_ønge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

628 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

631 
	}
}

635 
dmi_sy°em_id
 
__öôd©a
 
	gbad_bios_dmi_èbÀ
[] = {

636 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


638 .
ˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

639 .
	gidít
 = "AMI BIOS",

640 .
	gm©ches
 = {

641 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

645 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

646 .
	gidít
 = "Phoenix BIOS",

647 .
	gm©ches
 = {

648 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

652 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

653 .
	gidít
 = "Phoenix/MSC BIOS",

654 .
	gm©ches
 = {

655 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix/MSC"),

666 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

667 .
	gidít
 = "AMI BIOS",

668 .
	gm©ches
 = {

669 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45ID"),

673 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

674 .
	gidít
 = "AMI BIOS",

675 .
	gm©ches
 = {

676 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45FC"),

683 
__öô
 
	$åim_bios_ønge
()

690 
	`e820_upd©e_ønge
(0, 
PAGE_SIZE
, 
E820_RAM
, 
E820_RESERVED
);

696 
	`e820_ªmove_ønge
(
BIOS_BEGIN
, 
BIOS_END
 - BIOS_BEGIN, 
E820_RAM
, 1);

697 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

698 
	}
}

713 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

715 
a˝i
 = 0;

716 
k8
 = 0;

718 #ifde‡
CONFIG_X86_32


719 
	`mem˝y
(&
boŸ_˝u_d©a
, &
√w_˝u_d©a
, (new_cpu_data));

720 
	`visws_óæy_dëe˘
();

722 
	`¥ötk
(
KERN_INFO
 "Comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

726 
	`vmi_öô
();

728 
	`óæy_˝u_öô
();

729 
	`óæy_i‹em≠_öô
();

731 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
boŸ_∑øms
.
hdr
.
roŸ_dev
);

732 
s¸ìn_öfo
 = 
boŸ_∑øms
.screen_info;

733 
edid_öfo
 = 
boŸ_∑øms
.edid_info;

734 #ifde‡
CONFIG_X86_32


735 
≠m_öfo
.
bios
 = 
boŸ_∑øms
.
≠m_bios_öfo
;

736 
i°_öfo
 = 
boŸ_∑øms
.ist_info;

737 i‡(
boŸ_∑øms
.
sys_desc_èbÀ
.
Àngth
 != 0) {

738 
	`£t_mˇ_bus
(
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[3] & 0x2);

739 
machöe_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[0];

740 
machöe_submodñ_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[1];

741 
BIOS_ªvisi⁄
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[2];

744 
ßved_video_mode
 = 
boŸ_∑øms
.
hdr
.
vid_mode
;

745 
boŸlﬂdî_ty≥
 = 
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
;

746 i‡((
boŸlﬂdî_ty≥
 >> 4) == 0xe) {

747 
boŸlﬂdî_ty≥
 &= 0xf;

748 
boŸlﬂdî_ty≥
 |(
boŸ_∑øms
.
hdr
.
ext_lﬂdî_ty≥
+0x10) << 4;

750 
boŸlﬂdî_vîsi⁄
 = 
boŸlﬂdî_ty≥
 & 0xf;

751 
boŸlﬂdî_vîsi⁄
 |
boŸ_∑øms
.
hdr
.
ext_lﬂdî_vî
 << 4;

753 #ifde‡
CONFIG_BLK_DEV_RAM


754 
rd_image_°¨t
 = 
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_IMAGE_START_MASK
;

755 
rd_¥om±
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

756 
rd_dﬁﬂd
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

758 #ifde‡
CONFIG_EFI


759 i‡(!
	`°∫cmp
((*)&
boŸ_∑øms
.
efi_öfo
.
efi_lﬂdî_sig«tuª
,

760 #ifde‡
CONFIG_X86_32


766 
efi_íabÀd
 = 1;

767 
	`efi_ª£rve_óæy
();

771 
x86_öô
.
€m
.
	`¨ch_£tup
();

773 
	`£tup_mem‹y_m≠
();

774 
	`∑r£_£tup_d©a
();

776 
	`e820_ª£rve_£tup_d©a
();

778 
	`c›y_edd
();

780 i‡(!
boŸ_∑øms
.
hdr
.
roŸ_Êags
)

781 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

782 
öô_mm
.
°¨t_code
 = (Ë
_ãxt
;

783 
öô_mm
.
íd_code
 = (Ë
_ëext
;

784 
öô_mm
.
íd_d©a
 = (Ë
_ed©a
;

785 
öô_mm
.
brk
 = 
_brk_íd
;

787 
code_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ãxt
);

788 
code_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ëext
)-1;

789 
d©a_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ëext
);

790 
d©a_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ed©a
)-1;

791 
bss_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(&
__bss_°¨t
);

792 
bss_ªsour˚
.
íd
 = 
	`vút_to_phys
(&
__bss_°›
)-1;

794 #ifde‡
CONFIG_CMDLINE_BOOL


795 #ifde‡
CONFIG_CMDLINE_OVERRIDE


796 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

798 i‡(
buûtö_cmdlöe
[0]) {

800 
	`°æˇt
(
buûtö_cmdlöe
, " ", 
COMMAND_LINE_SIZE
);

801 
	`°æˇt
(
buûtö_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

802 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

807 
	`°æ˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

808 *
cmdlöe_p
 = 
comm™d_löe
;

817 
	`x86_c⁄figuª_nx
();

819 
	`∑r£_óæy_∑øm
();

821 
	`x86_ªp‹t_nx
();

824 
	`vmi_a˘iv©e
();

827 
	`ª£rve_óæy_£tup_d©a
();

829 i‡(
	`a˝i_mps_check
()) {

830 #ifde‡
CONFIG_X86_LOCAL_APIC


831 
dißbÀ_≠ic
 = 1;

833 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

836 #ifde‡
CONFIG_PCI


837 i‡(
pci_óæy_dump_ªgs
)

838 
	`óæy_dump_pci_devi˚s
();

841 
	`föish_e820_∑rsög
();

843 i‡(
efi_íabÀd
)

844 
	`efi_öô
();

846 
	`dmi_sˇn_machöe
();

848 
	`dmi_check_sy°em
(
bad_bios_dmi_èbÀ
);

854 
	`öô_hy≥rvis‹_∂©f‹m
();

856 
x86_öô
.
ªsour˚s
.
	`¥obe_roms
();

859 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
code_ªsour˚
);

860 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
d©a_ªsour˚
);

861 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
bss_ªsour˚
);

863 
	`åim_bios_ønge
();

864 #ifde‡
CONFIG_X86_32


865 i‡(
	`µro_wôh_øm_bug
()) {

866 
	`e820_upd©e_ønge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

867 
E820_RESERVED
);

868 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

869 
	`¥ötk
(
KERN_INFO
 "fixedÖhysical RAM map:\n");

870 
	`e820_¥öt_m≠
("bad_ppro");

873 
	`óæy_g¨t_iommu_check
();

880 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

883 
	`óæy_ª£rve_e820_mpc_√w
();

885 
	`mår_bp_öô
();

886 i‡(
	`mår_åim_unˇched_mem‹y
(
max_p‚
))

887 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

889 #ifde‡
CONFIG_X86_32


891 
	`föd_low_p‚_ønge
();

893 
num_phy•ages
 = 
max_p‚
;

895 
	`check_x2≠ic
();

899 i‡(
max_p‚
 > (1UL<<(32 - 
PAGE_SHIFT
)))

900 
max_low_p‚
 = 
	`e820_íd_of_low_øm_p‚
();

902 
max_low_p‚
 = 
max_p‚
;

904 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

905 
max_p‚_m≠≥d
 = 
KERNEL_IMAGE_SIZE
 >> 
PAGE_SHIFT
;

908 #ifde‡
CONFIG_X86_CHECK_BIOS_CORRUPTION


909 
	`£tup_bios_c‹ru±i⁄_check
();

912 
	`¥ötk
(
KERN_DEBUG
 "initial memory mapped : 0 - %08lx\n",

913 
max_p‚_m≠≥d
<<
PAGE_SHIFT
);

915 
	`ª£rve_brk
();

920 
	`föd_smp_c⁄fig
();

922 
	`ª£rve_ib·_ªgi⁄
();

924 
	`ª£rve_åampﬁöe_mem‹y
();

926 #ifde‡
CONFIG_ACPI_SLEEP


931 
	`a˝i_ª£rve_wakeup_mem‹y
();

933 
	`öô_gb∑ges
();

936 
max_low_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

937 
max_p‚_m≠≥d
 = 
max_low_p‚_m≠≥d
;

939 #ifde‡
CONFIG_X86_64


940 i‡(
max_p‚
 > 
max_low_p‚
) {

941 
max_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(1UL<<32,

942 
max_p‚
<<
PAGE_SHIFT
);

944 
max_low_p‚
 = 
max_p‚
;

952 #ifde‡
CONFIG_PROVIDE_OHCI1394_DMA_INIT


953 i‡(
öô_ohci1394_dma_óæy
)

954 
	`öô_ohci1394_dma_⁄_Æl_c⁄åﬁÀrs
();

957 
	`ª£rve_öôrd
();

959 
	`ª£rve_¸ashkî√l
();

961 
	`vsmp_öô
();

963 
	`io_dñay_öô
();

968 
	`a˝i_boŸ_èbÀ_öô
();

970 
	`óæy_a˝i_boŸ_öô
();

972 #ifde‡
CONFIG_ACPI_NUMA


976 
a˝i
 = 
	`a˝i_numa_öô
();

979 #ifde‡
CONFIG_K8_NUMA


980 i‡(!
a˝i
)

981 
k8
 = !
	`k8_numa_öô
(0, 
max_p‚
);

984 
	`öômem_öô
(0, 
max_p‚
, 
a˝i
, 
k8
);

985 #i‚de‡
CONFIG_NO_BOOTMEM


986 
	`óæy_ªs_to_boŸmem
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

989 
	`dma32_ª£rve_boŸmem
();

991 #ifde‡
CONFIG_KVM_CLOCK


992 
	`kvm˛ock_öô
();

995 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_°¨t
(
sw≠≥r_pg_dú
);

996 
	`∑gög_öô
();

997 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_d⁄e
(
sw≠≥r_pg_dú
);

999 
	`tboŸ_¥obe
();

1001 #ifde‡
CONFIG_X86_64


1002 
	`m≠_vsysˇŒ
();

1005 
	`gíîic_≠ic_¥obe
();

1007 
	`óæy_quúks
();

1012 
	`a˝i_boŸ_öô
();

1014 
	`sfi_öô
();

1019 i‡(
smp_found_c⁄fig
)

1020 
	`gë_smp_c⁄fig
();

1022 
	`¥efûl_possibÀ_m≠
();

1024 #ifde‡
CONFIG_X86_64


1025 
	`öô_˝u_to_node
();

1028 
	`öô_≠ic_m≠pögs
();

1029 
	`iﬂpic_öô_m≠pögs
();

1032 
	`¥obe_ƒ_úqs_gsi
();

1034 
	`kvm_gue°_öô
();

1036 
	`e820_ª£rve_ªsour˚s
();

1037 
	`e820_m¨k_noßve_ªgi⁄s
(
max_low_p‚
);

1039 
x86_öô
.
ªsour˚s
.
	`ª£rve_ªsour˚s
();

1041 
	`e820_£tup_g≠
();

1043 #ifde‡
CONFIG_VT


1044 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

1045 i‡(!
efi_íabÀd
 || (
	`efi_mem_ty≥
(0xa0000Ë!
EFI_CONVENTIONAL_MEMORY
))

1046 
c⁄swôchp
 = &
vga_c⁄
;

1047 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

1048 
c⁄swôchp
 = &
dummy_c⁄
;

1051 
x86_öô
.
€m
.
	`b™√r
();

1053 
	`mcheck_öô
();

1054 
	}
}

1056 #ifde‡
CONFIG_X86_32


1058 
ªsour˚
 
	gvideo_øm_ªsour˚
 = {

1059 .
«me
 = "Video RAMárea",

1060 .
	g°¨t
 = 0xa0000,

1061 .
	gíd
 = 0xbffff,

1062 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


1065 
__öô
 
	$i386_ª£rve_ªsour˚s
()

1067 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm_ªsour˚
);

1068 
	`ª£rve_°™d¨d_io_ªsour˚s
();

1069 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

3 
	~<löux/kî√l.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/öô.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/≥r˝u.h
>

8 
	~<löux/kexec.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/smp.h
>

11 
	~<löux/t›ﬁogy.h
>

12 
	~<löux/p‚.h
>

13 
	~<asm/£˘i⁄s.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/£tup.h
>

16 
	~<asm/mp•ec.h
>

17 
	~<asm/≠icdef.h
>

18 
	~<asm/highmem.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/˝umask.h
>

21 
	~<asm/˝u.h
>

22 
	~<asm/°ack¥Ÿe˘‹.h
>

24 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


25 
	#DBG
(
fmt
, ...Ë
	`¥_dbg
(fmt, ##
__VA_ARGS__
)

	)

27 
	#DBG
(
fmt
, ...Ëdÿ{ i‡(0Ë
	`¥_dbg
(fmt, ##
__VA_ARGS__
); } 0)

	)

30 
DEFINE_PER_CPU
(, 
˝u_numbî
);

31 
EXPORT_PER_CPU_SYMBOL
(
˝u_numbî
);

33 #ifde‡
CONFIG_X86_64


34 
	#BOOT_PERCPU_OFFSET
 (()
__≥r_˝u_lﬂd
)

	)

36 
	#BOOT_PERCPU_OFFSET
 0

	)

39 
DEFINE_PER_CPU
(, 
this_˝u_off
Ë
BOOT_PERCPU_OFFSET
;

40 
EXPORT_PER_CPU_SYMBOL
(
this_˝u_off
);

42 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
 = {

43 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

45 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

54 #ifde‡
CONFIG_X86_64


55 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

57 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

60 #ifde‡
CONFIG_X86_32


71 
boﬁ
 
__öô
 
	$p˝u_√ed_numa
()

73 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


74 
pg_d©a_t
 *
œ°
 = 
NULL
;

75 
˝u
;

77 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

78 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

80 i‡(
	`node_⁄löe
(
node
Ë&& 
	`NODE_DATA
(node) &&

81 
œ°
 &&Üa° !
	`NODE_DATA
(
node
))

82  
åue
;

84 
œ°
 = 
	`NODE_DATA
(
node
);

87  
Ál£
;

88 
	}
}

104 * 
__öô
 
	$p˝u_Æloc_boŸmem
(
˝u
, 
size
,

105 
Æign
)

107 c⁄° 
gﬂl
 = 
	`__∑
(
MAX_DMA_ADDRESS
);

108 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


109 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

110 *
±r
;

112 i‡(!
	`node_⁄löe
(
node
Ë|| !
	`NODE_DATA
(node)) {

113 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

114 
	`¥_öfo
("cpu %d hasÇoÇode %d orÇode-local memory\n",

115 
˝u
, 
node
);

116 
	`¥_debug
("per cpu data for cpu%d %lu bytesát %016lx\n",

117 
˝u
, 
size
, 
	`__∑
(
±r
));

119 
±r
 = 
	`__Æloc_boŸmem_node_n›™ic
(
	`NODE_DATA
(
node
),

120 
size
, 
Æign
, 
gﬂl
);

121 
	`¥_debug
("per cpu data for cpu%d %lu bytes onÇode%dát %016lx\n",

122 
˝u
, 
size
, 
node
, 
	`__∑
(
±r
));

124  
±r
;

126  
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

128 
	}
}

133 * 
__öô
 
	$p˝u_fc_Æloc
(
˝u
, 
size_t
 
size
, size_à
Æign
)

135  
	`p˝u_Æloc_boŸmem
(
˝u
, 
size
, 
Æign
);

136 
	}
}

138 
__öô
 
	$p˝u_fc_‰ì
(*
±r
, 
size_t
 
size
)

140 #ifde‡
CONFIG_NO_BOOTMEM


141 
u64
 
°¨t
 = 
	`__∑
(
±r
);

142 
u64
 
íd
 = 
°¨t
 + 
size
;

143 
	`‰ì_óæy_∑πül
(
°¨t
, 
íd
);

145 
	`‰ì_boŸmem
(
	`__∑
(
±r
), 
size
);

147 
	}
}

149 
__öô
 
	$p˝u_˝u_di°™˚
(
‰om
, 
to
)

151 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


152 i‡(
	`óæy_˝u_to_node
(
‰om
Ë=óæy_˝u_to_node(
to
))

153  
LOCAL_DISTANCE
;

155  
REMOTE_DISTANCE
;

157  
LOCAL_DISTANCE
;

159 
	}
}

161 
__öô
 
	$p˝up_p›uœã_±e
(
addr
)

163 
	`p›uœã_exåa_±e
(
addr
);

164 
	}
}

166 
ölöe
 
	$£tup_≥r˝u_£gmít
(
˝u
)

168 #ifde‡
CONFIG_X86_32


169 
desc_°ru˘
 
gdt
;

171 
	`∑ck_des¸ùt‹
(&
gdt
, 
	`≥r_˝u_off£t
(
˝u
), 0xFFFFF,

172 0x2 | 
DESCTYPE_S
, 0x8);

173 
gdt
.
s
 = 1;

174 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
),

175 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

177 
	}
}

179 
__öô
 
	$£tup_≥r_˝u_¨ós
()

181 
˝u
;

182 
dñè
;

183 
rc
;

185 
	`¥_öfo
("NR_CPUS:%dÇr_cpumask_bits:%dÇr_cpu_ids:%dÇr_node_ids:%d\n",

186 
NR_CPUS
, 
ƒ_˝umask_bôs
, 
ƒ_˝u_ids
, 
ƒ_node_ids
);

194 #ifde‡
CONFIG_X86_32


195 i‡(
p˝u_cho£n_fc
 =
PCPU_FC_AUTO
 && 
	`p˝u_√ed_numa
())

196 
p˝u_cho£n_fc
 = 
PCPU_FC_PAGE
;

198 
rc
 = -
EINVAL
;

199 i‡(
p˝u_cho£n_fc
 !
PCPU_FC_PAGE
) {

200 c⁄° 
size_t
 
©om_size
 = 
˝u_has_p£
 ? 
PMD_SIZE
 : 
PAGE_SIZE
;

201 c⁄° 
size_t
 
dyn_size
 = 
PERCPU_MODULE_RESERVE
 +

202 
PERCPU_DYNAMIC_RESERVE
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

204 
rc
 = 
	`p˝u_embed_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

205 
dyn_size
, 
©om_size
,

206 
p˝u_˝u_di°™˚
,

207 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
);

208 i‡(
rc
 < 0)

209 
	`¥_w¨nög
("%sállocator failed (%d), falling backÅoÖage size\n",

210 
p˝u_fc_«mes
[
p˝u_cho£n_fc
], 
rc
);

212 i‡(
rc
 < 0)

213 
rc
 = 
	`p˝u_∑ge_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

214 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
,

215 
p˝up_p›uœã_±e
);

216 i‡(
rc
 < 0)

217 
	`∑nic
("ˇ¬Ÿ inôülizê≥r˝uáª®”º=%d)", 
rc
);

220 
dñè
 = ()
p˝u_ba£_addr
 - ()
__≥r_˝u_°¨t
;

221 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

222 
	`≥r_˝u_off£t
(
˝u
Ë
dñè
 + 
p˝u_unô_off£ts
[cpu];

223 
	`≥r_˝u
(
this_˝u_off
, 
˝u
Ë
	`≥r_˝u_off£t
(cpu);

224 
	`≥r_˝u
(
˝u_numbî
, 
˝u
) = cpu;

225 
	`£tup_≥r˝u_£gmít
(
˝u
);

226 
	`£tup_°ack_ˇ«ry_£gmít
(
˝u
);

234 #ifde‡
CONFIG_X86_LOCAL_APIC


235 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) =

236 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_≠icid
, 
˝u
);

237 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
) =

238 
	`óæy_≥r_˝u_m≠
(
x86_bios_˝u_≠icid
, 
˝u
);

240 #ifde‡
CONFIG_X86_64


241 
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
) =

242 
	`≥r_˝u
(
úq_°ack_uni⁄
.
úq_°ack
, 
˝u
) +

243 
IRQ_STACK_SIZE
 - 64;

244 #ifde‡
CONFIG_NUMA


245 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
) =

246 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_node_m≠
, 
˝u
);

253 i‡(
˝u
 =
boŸ_˝u_id
)

254 
	`swôch_to_√w_gdt
(
˝u
);

258 #ifde‡
CONFIG_X86_LOCAL_APIC


259 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
Ë
NULL
;

260 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
Ë
NULL
;

262 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

263 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
Ë
NULL
;

266 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

271 
	`≥r_˝u
(
node_numbî
, 
boŸ_˝u_id
Ë
	`˝u_to_node
(boot_cpu_id);

275 
	`£tup_node_to_˝umask_m≠
();

278 
	`£tup_˝u_loˇl_masks
();

279 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/smp.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/sig«l.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/waô.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/≥rs⁄Æôy.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/uc⁄ãxt.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/vdso.h
>

28 
	~<asm/m˚.h
>

30 #ifde‡
CONFIG_X86_64


31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/ü32_uni°d.h
>

35 
	~<asm/sysˇŒ.h
>

36 
	~<asm/sysˇŒs.h
>

38 
	~<asm/sig‰ame.h
>

40 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

42 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

43 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

44 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

45 
X86_EFLAGS_CF
)

	)

47 #ifde‡
CONFIG_X86_32


48 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

50 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

53 
	#COPY
(
x
) do { \

54 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

55 } 0)

	)

57 
	#GET_SEG
(
£g
) ({ \

58 
tmp
; \

59 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

60 
tmp
; \

61 })

	)

63 
	#COPY_SEG
(
£g
) do { \

64 
ªgs
->
£g
 = 
	`GET_SEG
(seg); \

65 } 0)

	)

67 
	#COPY_SEG_CPL3
(
£g
) do { \

68 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

69 } 0)

	)

72 
	$ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
, 
sigc⁄ãxt
 
__u£r
 *
sc
,

73 *
∑x
)

75 
__u£r
 *
buf
;

76 
tmpÊags
;

77 
îr
 = 0;

80 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

82 
gë_u£r_åy
 {

84 #ifde‡
CONFIG_X86_32


85 
	`£t_u£r_gs
(
ªgs
, 
	`GET_SEG
(
gs
));

86 
	`COPY_SEG
(
fs
);

87 
	`COPY_SEG
(
es
);

88 
	`COPY_SEG
(
ds
);

91 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

92 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

94 #ifde‡
CONFIG_X86_64


95 
	`COPY
(
r8
);

96 
	`COPY
(
r9
);

97 
	`COPY
(
r10
);

98 
	`COPY
(
r11
);

99 
	`COPY
(
r12
);

100 
	`COPY
(
r13
);

101 
	`COPY
(
r14
);

102 
	`COPY
(
r15
);

105 #ifde‡
CONFIG_X86_32


106 
	`COPY_SEG_CPL3
(
cs
);

107 
	`COPY_SEG_CPL3
(
ss
);

112 
	`COPY_SEG_CPL3
(
cs
);

115 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

116 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

117 
ªgs
->
‹ig_ax
 = -1;

119 
	`gë_u£r_ex
(
buf
, &
sc
->
Â°©e
);

120 
îr
 |
	`ª°‹e_i387_x°©e
(
buf
);

122 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

129 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, __u£∏*
Â°©e
,

130 
±_ªgs
 *
ªgs
, 
mask
)

132 
îr
 = 0;

134 
put_u£r_åy
 {

136 #ifde‡
CONFIG_X86_32


137 
	`put_u£r_ex
(
	`gë_u£r_gs
(
ªgs
), (
__u£r
 *)&
sc
->
gs
);

138 
	`put_u£r_ex
(
ªgs
->
fs
, (
__u£r
 *)&
sc
->fs);

139 
	`put_u£r_ex
(
ªgs
->
es
, (
__u£r
 *)&
sc
->es);

140 
	`put_u£r_ex
(
ªgs
->
ds
, (
__u£r
 *)&
sc
->ds);

143 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

144 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

145 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

146 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

147 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

148 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

149 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

150 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

151 #ifde‡
CONFIG_X86_64


152 
	`put_u£r_ex
(
ªgs
->
r8
, &
sc
->r8);

153 
	`put_u£r_ex
(
ªgs
->
r9
, &
sc
->r9);

154 
	`put_u£r_ex
(
ªgs
->
r10
, &
sc
->r10);

155 
	`put_u£r_ex
(
ªgs
->
r11
, &
sc
->r11);

156 
	`put_u£r_ex
(
ªgs
->
r12
, &
sc
->r12);

157 
	`put_u£r_ex
(
ªgs
->
r13
, &
sc
->r13);

158 
	`put_u£r_ex
(
ªgs
->
r14
, &
sc
->r14);

159 
	`put_u£r_ex
(
ªgs
->
r15
, &
sc
->r15);

162 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

163 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

164 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

165 #ifde‡
CONFIG_X86_32


166 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

167 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

168 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

169 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

171 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

172 
	`put_u£r_ex
(
ªgs
->
cs
, &
sc
->cs);

173 
	`put_u£r_ex
(0, &
sc
->
gs
);

174 
	`put_u£r_ex
(0, &
sc
->
fs
);

177 
	`put_u£r_ex
(
Â°©e
, &
sc
->fpstate);

180 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

181 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

182 } 
	`put_u£r_ˇtch
(
îr
);

184  
îr
;

185 
	}
}

194 
	$Æign_sig‰ame
(
•
)

196 #ifde‡
CONFIG_X86_32


201 
•
 = ((sp + 4) & -16ul) - 4;

203 
•
 = 
	`round_down
(sp, 16) - 8;

205  
•
;

206 
	}
}

208 
ölöe
 
__u£r
 *

209 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
size_t
 
‰ame_size
,

210 
__u£r
 **
Â°©e
)

213 
•
 = 
ªgs
->sp;

214 
⁄sig°ack
 = 
	`⁄_sig_°ack
(
•
);

216 #ifde‡
CONFIG_X86_64


218 
•
 -= 128;

221 i‡(!
⁄sig°ack
) {

223 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

224 i‡(
cuºít
->
ßs_ss_size
)

225 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

227 #ifde‡
CONFIG_X86_32


229 i‡((
ªgs
->
ss
 & 0xffffË!
__USER_DS
 &&

230 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

231 
ka
->
ß
.
ß_ª°‹î
)

232 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

237 i‡(
	`u£d_m©h
()) {

238 
•
 -
sig_x°©e_size
;

239 #ifde‡
CONFIG_X86_64


240 
•
 = 
	`round_down
(sp, 64);

242 *
Â°©e
 = (
__u£r
 *)
•
;

245 
•
 = 
	`Æign_sig‰ame
(• - 
‰ame_size
);

251 i‡(
⁄sig°ack
 && !
	`likñy
(
	`⁄_sig_°ack
(
•
)))

252  (
__u£r
 *)-1L;

255 i‡(
	`u£d_m©h
(Ë&& 
	`ßve_i387_x°©e
(*
Â°©e
) < 0)

256  (
__u£r
 *)-1L;

258  (
__u£r
 *)
•
;

259 
	}
}

261 #ifde‡
CONFIG_X86_32


263 
u16
 
	mp›lmovl
;

264 
u32
 
	mvÆ
;

265 
u16
 
	möt80
;

266 } 
__©åibuã__
((
∑cked
)Ë
	gªtcode
 = {

268 
__NR_sigªtu∫
,

273 
u8
 
	mmovl
;

274 
u32
 
	mvÆ
;

275 
u16
 
	möt80
;

276 
u8
 
	m∑d
;

277 } 
__©åibuã__
((
∑cked
)Ë
	gπ_ªtcode
 = {

279 
__NR_π_sigªtu∫
,

285 
	$__£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

286 
±_ªgs
 *
ªgs
)

288 
sig‰ame
 
__u£r
 *
‰ame
;

289 
__u£r
 *
ª°‹î
;

290 
îr
 = 0;

291 
__u£r
 *
Â°©e
 = 
NULL
;

293 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

295 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

296  -
EFAULT
;

298 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

299  -
EFAULT
;

301 i‡(
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

302  -
EFAULT
;

304 i‡(
_NSIG_WORDS
 > 1) {

305 i‡(
	`__c›y_to_u£r
(&
‰ame
->
exåamask
, &
£t
->
sig
[1],

306 (
‰ame
->
exåamask
)))

307  -
EFAULT
;

310 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

311 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
sigªtu∫
);

313 
ª°‹î
 = &
‰ame
->
ªtcode
;

314 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

315 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

318 
îr
 |
	`__put_u£r
(
ª°‹î
, &
‰ame
->
¥ëcode
);

327 
îr
 |
	`__put_u£r
(*((
u64
 *)&
ªtcode
), (u64 *)
‰ame
->retcode);

329 i‡(
îr
)

330  -
EFAULT
;

333 
ªgs
->
•
 = ()
‰ame
;

334 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

335 
ªgs
->
ax
 = ()
sig
;

336 
ªgs
->
dx
 = 0;

337 
ªgs
->
cx
 = 0;

339 
ªgs
->
ds
 = 
__USER_DS
;

340 
ªgs
->
es
 = 
__USER_DS
;

341 
ªgs
->
ss
 = 
__USER_DS
;

342 
ªgs
->
cs
 = 
__USER_CS
;

345 
	}
}

347 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

348 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

350 
π_sig‰ame
 
__u£r
 *
‰ame
;

351 
__u£r
 *
ª°‹î
;

352 
îr
 = 0;

353 
__u£r
 *
Â°©e
 = 
NULL
;

355 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

357 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

358  -
EFAULT
;

360 
put_u£r_åy
 {

361 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

362 
	`put_u£r_ex
(&
‰ame
->
öfo
, &‰ame->
pöfo
);

363 
	`put_u£r_ex
(&
‰ame
->
uc
, &‰ame->
puc
);

364 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

367 i‡(
˝u_has_xßve
)

368 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

370 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

371 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

372 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

373 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

374 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

375 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

376 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

377 
ªgs
, 
£t
->
sig
[0]);

378 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

381 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
π_sigªtu∫
);

382 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

383 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

384 
	`put_u£r_ex
(
ª°‹î
, &
‰ame
->
¥ëcode
);

393 
	`put_u£r_ex
(*((
u64
 *)&
π_ªtcode
), (u64 *)
‰ame
->
ªtcode
);

394 } 
	`put_u£r_ˇtch
(
îr
);

396 i‡(
îr
)

397  -
EFAULT
;

400 
ªgs
->
•
 = ()
‰ame
;

401 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

402 
ªgs
->
ax
 = ()
sig
;

403 
ªgs
->
dx
 = ()&
‰ame
->
öfo
;

404 
ªgs
->
cx
 = ()&
‰ame
->
uc
;

406 
ªgs
->
ds
 = 
__USER_DS
;

407 
ªgs
->
es
 = 
__USER_DS
;

408 
ªgs
->
ss
 = 
__USER_DS
;

409 
ªgs
->
cs
 = 
__USER_CS
;

412 
	}
}

414 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

415 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

417 
π_sig‰ame
 
__u£r
 *
‰ame
;

418 
__u£r
 *
Â
 = 
NULL
;

419 
îr
 = 0;

420 
èsk_°ru˘
 *
me
 = 
cuºít
;

422 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (
π_sig‰ame
), &
Â
);

424 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

425  -
EFAULT
;

427 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
) {

428 i‡(
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info))

429  -
EFAULT
;

432 
put_u£r_åy
 {

434 i‡(
˝u_has_xßve
)

435 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

437 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

438 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

439 
	`put_u£r_ex
(
me
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

440 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

441 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

442 
	`put_u£r_ex
(
me
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

443 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â
, 
ªgs
, 
£t
->
sig
[0]);

444 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

449 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

450 
	`put_u£r_ex
(
ka
->
ß
.
ß_ª°‹î
, &
‰ame
->
¥ëcode
);

453 
îr
 |-
EFAULT
;

455 } 
	`put_u£r_ˇtch
(
îr
);

457 i‡(
îr
)

458  -
EFAULT
;

461 
ªgs
->
di
 = 
sig
;

463 
ªgs
->
ax
 = 0;

467 
ªgs
->
si
 = ()&
‰ame
->
öfo
;

468 
ªgs
->
dx
 = ()&
‰ame
->
uc
;

469 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

471 
ªgs
->
•
 = ()
‰ame
;

475 
ªgs
->
cs
 = 
__USER_CS
;

478 
	}
}

481 #ifde‡
CONFIG_X86_32


485 
asmlökage
 

486 
	$sys_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

488 
mask
 &
_BLOCKABLE
;

489 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

490 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

491 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

492 
	`ªˇlc_sig≥ndög
();

493 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

495 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

496 
	`scheduÀ
();

497 
	`£t_ª°‹e_sigmask
();

499  -
ERESTARTNOHAND
;

500 
	}
}

502 
asmlökage
 

503 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

504 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

506 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

507 
ªt
 = 0;

509 i‡(
a˘
) {

510 
ﬁd_sig£t_t
 
mask
;

512 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)))

513  -
EFAULT
;

515 
gë_u£r_åy
 {

516 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler);

517 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

518 
	`gë_u£r_ex
(
mask
, &
a˘
->
ß_mask
);

519 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer);

520 } 
	`gë_u£r_ˇtch
(
ªt
);

522 i‡(
ªt
)

523  -
EFAULT
;

524 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

527 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

529 i‡(!
ªt
 && 
ﬂ˘
) {

530 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)))

531  -
EFAULT
;

533 
put_u£r_åy
 {

534 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler);

535 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

536 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

537 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer);

538 } 
	`put_u£r_ˇtch
(
ªt
);

540 i‡(
ªt
)

541  -
EFAULT
;

544  
ªt
;

545 
	}
}

549 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
,

550 
±_ªgs
 *
ªgs
)

552  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

553 
	}
}

558 #ifde‡
CONFIG_X86_32


559 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

561 
sig‰ame
 
__u£r
 *
‰ame
;

562 
ax
;

563 
sig£t_t
 
£t
;

565 
‰ame
 = (
sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - 8);

567 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

568 
bad‰ame
;

569 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
Ë|| (
_NSIG_WORDS
 > 1

570 && 
	`__c›y_‰om_u£r
(&
£t
.
sig
[1], &
‰ame
->
exåamask
,

571 (
‰ame
->
exåamask
))))

572 
bad‰ame
;

574 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

575 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

576 
cuºít
->
blocked
 = 
£t
;

577 
	`ªˇlc_sig≥ndög
();

578 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

580 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

581 
bad‰ame
;

582  
ax
;

584 
bad‰ame
:

585 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "sigreturn");

588 
	}
}

591 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

593 
π_sig‰ame
 
__u£r
 *
‰ame
;

594 
ax
;

595 
sig£t_t
 
£t
;

597 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - ());

598 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

599 
bad‰ame
;

600 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

601 
bad‰ame
;

603 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

604 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

605 
cuºít
->
blocked
 = 
£t
;

606 
	`ªˇlc_sig≥ndög
();

607 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

609 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

610 
bad‰ame
;

612 i‡(
	`do_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
•
Ë=-
EFAULT
)

613 
bad‰ame
;

615  
ax
;

617 
bad‰ame
:

618 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "rt_sigreturn");

620 
	}
}

625 
	$sigƒ_c⁄vît
(
sig
)

627 #ifde‡
CONFIG_X86_32


628 
thªad_öfo
 *
öfo
 = 
	`cuºít_thªad_öfo
();

630 i‡(
öfo
->
exec_domaö
 && info->exec_domaö->
sig«l_övm≠
 && 
sig
 < 32)

631  
öfo
->
exec_domaö
->
sig«l_övm≠
[
sig
];

633  
sig
;

634 
	}
}

636 #ifde‡
CONFIG_X86_32


638 
	#is_ü32
 1

	)

639 
	#ü32_£tup_‰ame
 
__£tup_‰ame


	)

640 
	#ü32_£tup_π_‰ame
 
__£tup_π_‰ame


	)

644 #ifde‡
CONFIG_IA32_EMULATION


645 
	#is_ü32
 
	`ã°_thªad_Êag
(
TIF_IA32
)

	)

647 
	#is_ü32
 0

	)

650 
ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

651 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

652 
ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

653 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

658 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

659 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

661 
usig
 = 
	`sigƒ_c⁄vît
(
sig
);

662 
ªt
;

665 i‡(
is_ü32
) {

666 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

667 
ªt
 = 
	`ü32_£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

669 
ªt
 = 
	`ü32_£tup_‰ame
(
usig
, 
ka
, 
£t
, 
ªgs
);

671 
ªt
 = 
	`__£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

673 i‡(
ªt
) {

674 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

675  -
EFAULT
;

678  
ªt
;

679 
	}
}

682 
	$h™dÀ_sig«l
(
sig
, 
sigöfo_t
 *
öfo
, 
k_siga˘i⁄
 *
ka
,

683 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
)

685 
ªt
;

688 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

690 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

691 -
ERESTART_RESTARTBLOCK
:

692 -
ERESTARTNOHAND
:

693 
ªgs
->
ax
 = -
EINTR
;

696 -
ERESTARTSYS
:

697 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

698 
ªgs
->
ax
 = -
EINTR
;

702 -
ERESTARTNOINTR
:

703 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

704 
ªgs
->
ù
 -= 2;

713 i‡(
	`u∆ikñy
(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
) &&

714 
	`likñy
(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_FORCED_TF
)))

715 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

717 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

719 i‡(
ªt
)

720  
ªt
;

722 #ifde‡
CONFIG_X86_64


728 
	`£t_fs
(
USER_DS
);

734 
ªgs
->
Êags
 &~
X86_EFLAGS_DF
;

742 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

744 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

745 
	`sig‹£ts
(&
cuºít
->
blocked
, &cuºít->blocked, &
ka
->
ß
.
ß_mask
);

746 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

747 
	`sigadd£t
(&
cuºít
->
blocked
, 
sig
);

748 
	`ªˇlc_sig≥ndög
();

749 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

751 
	`åa˚hook_sig«l_h™dÀr
(
sig
, 
öfo
, 
ka
, 
ªgs
,

752 
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
));

755 
	}
}

757 #ifde‡
CONFIG_X86_32


758 
	#NR_ª°¨t_sysˇŒ
 
__NR_ª°¨t_sysˇŒ


	)

760 
	#NR_ª°¨t_sysˇŒ
 \

761 
	`ã°_thªad_Êag
(
TIF_IA32
Ë? 
__NR_ü32_ª°¨t_sysˇŒ
 : 
__NR_ª°¨t_sysˇŒ


	)

769 
	$do_sig«l
(
±_ªgs
 *
ªgs
)

771 
k_siga˘i⁄
 
ka
;

772 
sigöfo_t
 
öfo
;

773 
sigƒ
;

774 
sig£t_t
 *
ﬁd£t
;

783 i‡(!
	`u£r_mode
(
ªgs
))

786 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
)

787 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

789 
ﬁd£t
 = &
cuºít
->
blocked
;

791 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

792 i‡(
sigƒ
 > 0) {

794 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
öfo
, &
ka
, 
ﬁd£t
, 
ªgs
) == 0) {

801 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

807 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

809 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

810 -
ERESTARTNOHAND
:

811 -
ERESTARTSYS
:

812 -
ERESTARTNOINTR
:

813 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

814 
ªgs
->
ù
 -= 2;

817 -
ERESTART_RESTARTBLOCK
:

818 
ªgs
->
ax
 = 
NR_ª°¨t_sysˇŒ
;

819 
ªgs
->
ù
 -= 2;

828 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
) {

829 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

830 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

832 
	}
}

839 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, *
unu£d
, 
__u32
 
thªad_öfo_Êags
)

841 #ifde‡
CONFIG_X86_MCE


843 i‡(
thªad_öfo_Êags
 & 
_TIF_MCE_NOTIFY
)

844 
	`m˚_nŸify_¥o˚ss
();

848 i‡(
thªad_öfo_Êags
 & 
_TIF_SIGPENDING
)

849 
	`do_sig«l
(
ªgs
);

851 i‡(
thªad_öfo_Êags
 & 
_TIF_NOTIFY_RESUME
) {

852 
	`˛ór_thªad_Êag
(
TIF_NOTIFY_RESUME
);

853 
	`åa˚hook_nŸify_ªsume
(
ªgs
);

854 i‡(
cuºít
->
ª∂a˚mít_£ssi⁄_keyrög
)

855 
	`key_ª∂a˚_£ssi⁄_keyrög
();

857 i‡(
thªad_öfo_Êags
 & 
_TIF_USER_RETURN_NOTIFY
)

858 
	`fúe_u£r_ªtu∫_nŸifõrs
();

860 #ifde‡
CONFIG_X86_32


861 
	`˛ór_thªad_Êag
(
TIF_IRET
);

863 
	}
}

865 
	$sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
)

867 
èsk_°ru˘
 *
me
 = 
cuºít
;

869 i‡(
show_unh™dÀd_sig«ls
 && 
	`¥ötk_øãlimô
()) {

870 
	`¥ötk
("%s"

872 
	`èsk_pid_ƒ
(
cuºít
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

873 
me
->
comm
, me->
pid
, 
whîe
, 
‰ame
,

874 
ªgs
->
ù
,Ñegs->
•
,Ñegs->
‹ig_ax
);

875 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

876 
	`¥ötk
(
KERN_CONT
 "\n");

879 
	`f‹˚_sig
(
SIGSEGV
, 
me
);

880 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/mc146818πc.h
>

21 
	~<löux/ˇche.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/˝u.h
>

24 
	~<löux/gÂ.h
>

26 
	~<asm/mår.h
>

27 
	~<asm/ébÊush.h
>

28 
	~<asm/mmu_c⁄ãxt.h
>

29 
	~<asm/¥Ÿo.h
>

30 
	~<asm/≠ic.h
>

115 
	$«tive_smp_£nd_ªscheduÀ
(
˝u
)

117 i‡(
	`u∆ikñy
(
	`˝u_is_ofÊöe
(
˝u
))) {

118 
	`WARN_ON
(1);

121 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
RESCHEDULE_VECTOR
);

122 
	}
}

124 
	$«tive_£nd_ˇŒ_func_sögÀ_ùi
(
˝u
)

126 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
CALL_FUNCTION_SINGLE_VECTOR
);

127 
	}
}

129 
	$«tive_£nd_ˇŒ_func_ùi
(c⁄° 
˝umask
 *
mask
)

131 
˝umask_v¨_t
 
Ælbut£lf
;

133 i‡(!
	`Æloc_˝umask_v¨
(&
Ælbut£lf
, 
GFP_ATOMIC
)) {

134 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

138 
	`˝umask_c›y
(
Ælbut£lf
, 
˝u_⁄löe_mask
);

139 
	`˝umask_˛ór_˝u
(
	`smp_¥o˚ss‹_id
(), 
Ælbut£lf
);

141 i‡(
	`˝umask_equÆ
(
mask
, 
Ælbut£lf
) &&

142 
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
˝u_ˇŒout_mask
))

143 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
CALL_FUNCTION_VECTOR
);

145 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

147 
	`‰ì_˝umask_v¨
(
Ælbut£lf
);

148 
	}
}

154 
asmlökage
 
	$smp_ªboŸ_öãºu±
()

156 
	`ack_APIC_úq
();

157 
	`úq_íãr
();

158 
	`°›_this_˝u
(
NULL
);

159 
	`úq_exô
();

160 
	}
}

162 
	$«tive_smp_£nd_°›
()

164 
Êags
;

165 
waô
;

167 i‡(
ªboŸ_f‹˚
)

179 i‡(
	`num_⁄löe_˝us
() > 1) {

180 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
REBOOT_VECTOR
);

183 
waô
 = 
USEC_PER_SEC
;

184 
	`num_⁄löe_˝us
(Ë> 1 && 
waô
--)

185 
	`udñay
(1);

188 
	`loˇl_úq_ßve
(
Êags
);

189 
	`dißbÀ_loˇl_APIC
();

190 
	`loˇl_úq_ª°‹e
(
Êags
);

191 
	}
}

198 
	$smp_ªscheduÀ_öãºu±
(
±_ªgs
 *
ªgs
)

200 
	`ack_APIC_úq
();

201 
	`öc_úq_°©
(
úq_ªsched_cou¡
);

205 
	}
}

207 
	$smp_ˇŒ_fun˘i⁄_öãºu±
(
±_ªgs
 *
ªgs
)

209 
	`ack_APIC_úq
();

210 
	`úq_íãr
();

211 
	`gíîic_smp_ˇŒ_fun˘i⁄_öãºu±
();

212 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

213 
	`úq_exô
();

214 
	}
}

216 
	$smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
(
±_ªgs
 *
ªgs
)

218 
	`ack_APIC_úq
();

219 
	`úq_íãr
();

220 
	`gíîic_smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
();

221 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

222 
	`úq_exô
();

223 
	}
}

225 
smp_›s
 
	gsmp_›s
 = {

226 .
smp_¥ï¨e_boŸ_˝u
 = 
«tive_smp_¥ï¨e_boŸ_˝u
,

227 .
	gsmp_¥ï¨e_˝us
 = 
«tive_smp_¥ï¨e_˝us
,

228 .
	gsmp_˝us_d⁄e
 = 
«tive_smp_˝us_d⁄e
,

230 .
	gsmp_£nd_°›
 = 
«tive_smp_£nd_°›
,

231 .
	gsmp_£nd_ªscheduÀ
 = 
«tive_smp_£nd_ªscheduÀ
,

233 .
	g˝u_up
 = 
«tive_˝u_up
,

234 .
	g˝u_dõ
 = 
«tive_˝u_dõ
,

235 .
	g˝u_dißbÀ
 = 
«tive_˝u_dißbÀ
,

236 .
	g∂ay_dód
 = 
«tive_∂ay_dód
,

238 .
	g£nd_ˇŒ_func_ùi
 = 
«tive_£nd_ˇŒ_func_ùi
,

239 .
	g£nd_ˇŒ_func_sögÀ_ùi
 = 
«tive_£nd_ˇŒ_func_sögÀ_ùi
,

241 
EXPORT_SYMBOL_GPL
(
smp_›s
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<löux/öô.h
>

43 
	~<löux/smp.h
>

44 
	~<löux/moduÀ.h
>

45 
	~<löux/sched.h
>

46 
	~<löux/≥r˝u.h
>

47 
	~<löux/boŸmem.h
>

48 
	~<löux/îr.h
>

49 
	~<löux/nmi.h
>

50 
	~<löux/tboŸ.h
>

51 
	~<löux/°ack¥Ÿe˘‹.h
>

52 
	~<löux/gÂ.h
>

54 
	~<asm/a˝i.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/úq.h
>

58 
	~<asm/idÀ.h
>

59 
	~<asm/åampﬁöe.h
>

60 
	~<asm/˝u.h
>

61 
	~<asm/numa.h
>

62 
	~<asm/pgèbÀ.h
>

63 
	~<asm/ébÊush.h
>

64 
	~<asm/mår.h
>

65 
	~<asm/vmi.h
>

66 
	~<asm/≠ic.h
>

67 
	~<asm/£tup.h
>

68 
	~<asm/uv/uv.h
>

69 
	~<löux/mc146818πc.h
>

71 
	~<asm/smpboŸ_hooks.h
>

72 
	~<asm/i8259.h
>

74 #ifde‡
CONFIG_X86_32


75 
u8
 
	g≠icid_2_node
[
MAX_APICID
];

76 
	glow_m≠pögs
;

80 
DEFINE_PER_CPU
(, 
˝u_°©e
) = { 0 };

86 #ifde‡
CONFIG_HOTPLUG_CPU


91 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
idÀ_thªad_¨øy
);

92 
	#gë_idÀ_f‹_˝u
(
x
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, x))

	)

93 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, xË’))

	)

95 
èsk_°ru˘
 *
	gidÀ_thªad_¨øy
[
NR_CPUS
] 
	g__˝uöôd©a
 ;

96 
	#gë_idÀ_f‹_˝u
(
x
Ë(
idÀ_thªad_¨øy
[(x)])

	)

97 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
idÀ_thªad_¨øy
[(x)] = (p))

	)

101 
	gsmp_num_siblögs
 = 1;

102 
EXPORT_SYMBOL
(
smp_num_siblögs
);

105 
DEFINE_PER_CPU
(
u16
, 
˝u_Œc_id
Ë
BAD_APICID
;

108 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_siblög_m≠
);

109 
EXPORT_PER_CPU_SYMBOL
(
˝u_siblög_m≠
);

112 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_c‹e_m≠
);

113 
EXPORT_PER_CPU_SYMBOL
(
˝u_c‹e_m≠
);

116 
DEFINE_PER_CPU_SHARED_ALIGNED
(
˝uöfo_x86
, 
˝u_öfo
);

117 
EXPORT_PER_CPU_SYMBOL
(
˝u_öfo
);

119 
©omic_t
 
	göô_dós£πed
;

121 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_32
)

123 
	g˝u_to_node_m≠
[
NR_CPUS
] 
	g__ªad_mo°ly
 = { [0 ... NR_CPUS-1] = 0 };

124 
EXPORT_SYMBOL
(
˝u_to_node_m≠
);

127 
	$m≠_˝u_to_node
(
˝u
, 
node
)

129 
	`¥ötk
(
KERN_INFO
 "M≠pög cpu %dÅÿnodê%d\n", 
˝u
, 
node
);

130 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

131 
˝u_to_node_m≠
[
˝u
] = 
node
;

132 
	}
}

135 
	$unm≠_˝u_to_node
(
˝u
)

137 
node
;

139 
	`¥ötk
(
KERN_INFO
 "Unm≠pög cpu %d fromáŒÇodes\n", 
˝u
);

140 
node
 = 0;Çodê< 
MAX_NUMNODES
;Çode++)

141 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

142 
˝u_to_node_m≠
[
˝u
] = 0;

143 
	}
}

145 
	#m≠_˝u_to_node
(
˝u
, 
node
Ë({})

	)

146 
	#unm≠_˝u_to_node
(
˝u
Ë({})

	)

149 #ifde‡
CONFIG_X86_32


150 
	gboŸ_˝u_logiˇl_≠icid
;

152 
u8
 
	g˝u_2_logiˇl_≠icid
[
NR_CPUS
] 
	g__ªad_mo°ly
 =

153 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

155 
	$m≠_˝u_to_logiˇl_≠icid
()

157 
˝u
 = 
	`smp_¥o˚ss‹_id
();

158 
≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

159 
node
 = 
≠ic
->
	`≠icid_to_node
(
≠icid
);

161 i‡(!
	`node_⁄löe
(
node
))

162 
node
 = 
fú°_⁄löe_node
;

164 
˝u_2_logiˇl_≠icid
[
˝u
] = 
≠icid
;

165 
	`m≠_˝u_to_node
(
˝u
, 
node
);

166 
	}
}

168 
	$numa_ªmove_˝u
(
˝u
)

170 
˝u_2_logiˇl_≠icid
[
˝u
] = 
BAD_APICID
;

171 
	`unm≠_˝u_to_node
(
˝u
);

172 
	}
}

174 
	#m≠_˝u_to_logiˇl_≠icid
(Ëdÿ{} 0)

	)

181 
__˝uöô
 
	$smp_ˇŒö
()

183 
˝uid
, 
phys_id
;

184 
timeout
;

192 i‡(
≠ic
->
waô_f‹_öô_dós£π
)

193 
≠ic
->
	`waô_f‹_öô_dós£π
(&
öô_dós£πed
);

198 
phys_id
 = 
	`ªad_≠ic_id
();

199 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

200 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒö_mask
)) {

201 
	`∑nic
("%s:Öhy†CPU#%d, CPU#%dáÃódyÖª£¡??\n", 
__func__
,

202 
phys_id
, 
˝uid
);

204 
	`¥_debug
("CPU#%d (phy†ID: %dËwaôög f‹ CALLOUT\n", 
˝uid
, 
phys_id
);

217 
timeout
 = 
jiffõs
 + 2*
HZ
;

218 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

222 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒout_mask
))

224 
	`˝u_ªœx
();

227 i‡(!
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

228 
	`∑nic
("%s: CPU%d started up but didÇot getá callout!\n",

229 
__func__
, 
˝uid
);

239 
	`¥_debug
("CALLIN, before setup_local_APIC().\n");

240 i‡(
≠ic
->
smp_ˇŒö_˛ór_loˇl_≠ic
)

241 
≠ic
->
	`smp_ˇŒö_˛ór_loˇl_≠ic
();

242 
	`£tup_loˇl_APIC
();

243 
	`íd_loˇl_APIC_£tup
();

244 
	`m≠_˝u_to_logiˇl_≠icid
();

249 
	`£tup_ve˘‹_úq
(
	`smp_¥o˚ss‹_id
());

256 
	`loˇl_úq_íabÀ
();

257 
	`ˇlibøã_dñay
();

258 
	`loˇl_úq_dißbÀ
();

259 
	`¥_debug
("Sèckáàabouà%p\n", &
˝uid
);

264 
	`smp_°‹e_˝u_öfo
(
˝uid
);

266 
	`nŸify_˝u_°¨tög
(
˝uid
);

271 
	`˝umask_£t_˝u
(
˝uid
, 
˝u_ˇŒö_mask
);

272 
	}
}

277 
nŸø˚
 
__˝uöô
 
	$°¨t_£c⁄d¨y
(*
unu£d
)

284 
	`vmi_brögup
();

285 
	`˝u_öô
();

286 
	`¥ìm±_dißbÀ
();

287 
	`smp_ˇŒö
();

290 
	`b¨rõr
();

294 
	`check_tsc_sync_èrgë
();

296 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

297 
Àgacy_pic
->
chù
->
	`mask
(0);

298 
	`íabÀ_NMI_through_LVT0
();

299 
Àgacy_pic
->
chù
->
	`unmask
(0);

302 #ifde‡
CONFIG_X86_32


303 
low_m≠pögs
)

304 
	`˝u_ªœx
();

305 
	`__Êush_éb_Æl
();

309 
	`£t_˝u_siblög_m≠
(
	`øw_smp_¥o˚ss‹_id
());

310 
	`wmb
();

324 
	`ùi_ˇŒ_lock
();

325 
	`lock_ve˘‹_lock
();

326 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
åue
);

327 
	`u∆ock_ve˘‹_lock
();

328 
	`ùi_ˇŒ_u∆ock
();

329 
	`≥r_˝u
(
˝u_°©e
, 
	`smp_¥o˚ss‹_id
()Ë
CPU_ONLINE
;

330 
x86_∂©f‹m
.
	`nmi_öô
();

333 
	`loˇl_úq_íabÀ
();

336 
	`boŸ_öô_°ack_ˇ«ry
();

338 
x86_˝uöô
.
	`£tup_≥r˝u_˛ockev
();

340 
	`wmb
();

341 
	`˝u_idÀ
();

342 
	}
}

344 #ifde‡
CONFIG_CPUMASK_OFFSTACK


346 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

347 c⁄° 
˝uöfo_x86
 *
§c
)

349 
˝umask
 *
Œc
 = 
d°
->
Œc_sh¨ed_m≠
;

350 *
d°
 = *
§c
;

351 
d°
->
Œc_sh¨ed_m≠
 = 
Œc
;

352 
	}
}

354 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

355 c⁄° 
˝uöfo_x86
 *
§c
)

357 *
d°
 = *
§c
;

358 
	}
}

366 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
id
)

368 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
id
);

370 
	`c›y_˝uöfo_x86
(
c
, &
boŸ_˝u_d©a
);

371 
c
->
˝u_ödex
 = 
id
;

372 i‡(
id
 != 0)

373 
	`idítify_£c⁄d¨y_˝u
(
c
);

374 
	}
}

377 
__˝uöô
 
	$£t_˝u_siblög_m≠
(
˝u
)

379 
i
;

380 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

382 
	`˝umask_£t_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

384 i‡(
smp_num_siblögs
 > 1) {

385 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

386 
˝uöfo_x86
 *
o
 = &
	`˝u_d©a
(
i
);

388 i‡(
c
->
phys_¥oc_id
 =
o
->phys_proc_id &&

389 
c
->
˝u_c‹e_id
 =
o
->cpu_core_id) {

390 
	`˝umask_£t_˝u
(
i
, 
	`˝u_siblög_mask
(
˝u
));

391 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(
i
));

392 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

393 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

394 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

395 
	`˝umask_£t_˝u
(
˝u
, 
o
->
Œc_sh¨ed_m≠
);

399 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(cpu));

402 
	`˝umask_£t_˝u
(
˝u
, 
c
->
Œc_sh¨ed_m≠
);

404 i‡(
cuºít_˝u_d©a
.
x86_max_c‹es
 == 1) {

405 
	`˝umask_c›y
(
	`˝u_c‹e_mask
(
˝u
), 
	`˝u_siblög_mask
(cpu));

406 
c
->
boŸed_c‹es
 = 1;

410 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

411 i‡(
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë!
BAD_APICID
 &&

412 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë=≥r_˝u(˝u_Œc_id, 
i
)) {

413 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

414 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

416 i‡(
c
->
phys_¥oc_id
 =
	`˝u_d©a
(
i
).phys_proc_id) {

417 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

418 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

422 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1) {

427 i‡(
	`˝umask_fú°
(
	`˝u_siblög_mask
(
i
)) == i)

428 
c
->
boŸed_c‹es
++;

433 i‡(
i
 !
˝u
)

434 
	`˝u_d©a
(
i
).
boŸed_c‹es
++;

435 } i‡(
i
 !
˝u
 && !
c
->
boŸed_c‹es
)

436 
c
->
boŸed_c‹es
 = 
	`˝u_d©a
(
i
).booted_cores;

439 
	}
}

442 c⁄° 
˝umask
 *
	$˝u_c‹egroup_mask
(
˝u
)

444 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

449 i‡((
sched_mc_powî_ßvögs
 || 
sched_smt_powî_ßvögs
) &&

450 !(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
)))

451  
	`˝u_c‹e_mask
(
˝u
);

453  
c
->
Œc_sh¨ed_m≠
;

454 
	}
}

456 
	$im¥ess_‰õnds
()

458 
˝u
;

459 
bogosum
 = 0;

463 
	`¥_debug
("Before bogomips.\n");

464 
	`f‹_óch_possibÀ_˝u
(
˝u
)

465 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒout_mask
))

466 
bogosum
 +
	`˝u_d©a
(
˝u
).
lo›s_≥r_jiffy
;

467 
	`¥ötk
(
KERN_INFO


469 
	`num_⁄löe_˝us
(),

470 
bogosum
/(500000/
HZ
),

471 (
bogosum
/(5000/
HZ
))%100);

473 
	`¥_debug
("Before bogocount - settingáctivated=1.\n");

474 
	}
}

476 
	$__öquúe_ªmŸe_≠ic
(
≠icid
)

478 
i
, 
ªgs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

479 *
«mes
[] = { "ID", "VERSION", "SPIV" };

480 
timeout
;

481 
u32
 
°©us
;

483 
	`¥ötk
(
KERN_INFO
 "InquúögÑemŸêAPIC 0x%x...\n", 
≠icid
);

485 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªgs
); i++) {

486 
	`¥ötk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
≠icid
, 
«mes
[
i
]);

491 
°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

492 i‡(
°©us
)

493 
	`¥ötk
(
KERN_CONT


496 
	`≠ic_i¸_wrôe
(
APIC_DM_REMRD
 | 
ªgs
[
i
], 
≠icid
);

498 
timeout
 = 0;

500 
	`udñay
(100);

501 
°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_RR_MASK
;

502 } 
°©us
 =
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

504 
°©us
) {

505 
APIC_ICR_RR_VALID
:

506 
°©us
 = 
	`≠ic_ªad
(
APIC_RRR
);

507 
	`¥ötk
(
KERN_CONT
 "%08x\n", 
°©us
);

510 
	`¥ötk
(
KERN_CONT
 "failed\n");

513 
	}
}

520 
__˝uöô


521 
	$wakeup_£c⁄d¨y_˝u_vü_nmi
(
logiˇl_≠icid
, 
°¨t_eù
)

523 
£nd_°©us
, 
ac˚±_°©us
 = 0;

524 
maxlvt
;

529 
	`≠ic_i¸_wrôe
(
APIC_DM_NMI
 | 
≠ic
->
de°_logiˇl
, 
logiˇl_≠icid
);

531 
	`¥_debug
("Waiting for sendÅo finish...\n");

532 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

537 
	`udñay
(200);

538 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

539 
maxlvt
 = 
	`œpic_gë_maxlvt
();

540 i‡(
maxlvt
 > 3)

541 
	`≠ic_wrôe
(
APIC_ESR
, 0);

542 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

544 
	`¥_debug
("NMI sent.\n");

546 i‡(
£nd_°©us
)

547 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

548 i‡(
ac˚±_°©us
)

549 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

551  (
£nd_°©us
 | 
ac˚±_°©us
);

552 
	}
}

554 
__˝uöô


555 
	$wakeup_£c⁄d¨y_˝u_vü_öô
(
phys_≠icid
, 
°¨t_eù
)

557 
£nd_°©us
, 
ac˚±_°©us
 = 0;

558 
maxlvt
, 
num_°¨ts
, 
j
;

560 
maxlvt
 = 
	`œpic_gë_maxlvt
();

565 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
])) {

566 i‡(
maxlvt
 > 3)

567 
	`≠ic_wrôe
(
APIC_ESR
, 0);

568 
	`≠ic_ªad
(
APIC_ESR
);

571 
	`¥_debug
("Asserting INIT.\n");

579 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

580 
phys_≠icid
);

582 
	`¥_debug
("Waiting for sendÅo finish...\n");

583 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

585 
	`mdñay
(10);

587 
	`¥_debug
("Deasserting INIT.\n");

591 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_≠icid
);

593 
	`¥_debug
("Waiting for sendÅo finish...\n");

594 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

596 
	`mb
();

597 
	`©omic_£t
(&
öô_dós£πed
, 1);

605 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
]))

606 
num_°¨ts
 = 2;

608 
num_°¨ts
 = 0;

614 
	`°¨tup_ùi_hook
(
phys_≠icid
, (Ë
°¨t_£c⁄d¨y
,

615 ()
°ack_°¨t
.
•
);

620 
	`¥_debug
("#°¨tu∞lo›s: %d.\n", 
num_°¨ts
);

622 
j
 = 1; j <
num_°¨ts
; j++) {

623 
	`¥_debug
("Sídög STARTUP #%d.\n", 
j
);

624 i‡(
maxlvt
 > 3)

625 
	`≠ic_wrôe
(
APIC_ESR
, 0);

626 
	`≠ic_ªad
(
APIC_ESR
);

627 
	`¥_debug
("Afterápic_write.\n");

636 
	`≠ic_i¸_wrôe
(
APIC_DM_STARTUP
 | (
°¨t_eù
 >> 12),

637 
phys_≠icid
);

642 
	`udñay
(300);

644 
	`¥_debug
("StartupÖoint 1.\n");

646 
	`¥_debug
("Waiting for sendÅo finish...\n");

647 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

652 
	`udñay
(200);

653 i‡(
maxlvt
 > 3)

654 
	`≠ic_wrôe
(
APIC_ESR
, 0);

655 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

656 i‡(
£nd_°©us
 || 
ac˚±_°©us
)

659 
	`¥_debug
("After Startup.\n");

661 i‡(
£nd_°©us
)

662 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

663 i‡(
ac˚±_°©us
)

664 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

666  (
£nd_°©us
 | 
ac˚±_°©us
);

667 
	}
}

669 
	s¸óã_idÀ
 {

670 
w‹k_°ru˘
 
	mw‹k
;

671 
èsk_°ru˘
 *
	midÀ
;

672 
com∂ëi⁄
 
	md⁄e
;

673 
	m˝u
;

676 
__˝uöô
 
	$do_f‹k_idÀ
(
w‹k_°ru˘
 *
w‹k
)

678 
¸óã_idÀ
 *
c_idÀ
 =

679 
	`c⁄èöî_of
(
w‹k
, 
¸óã_idÀ
, work);

681 
c_idÀ
->
idÀ
 = 
	`f‹k_idÀ
(c_idÀ->
˝u
);

682 
	`com∂ëe
(&
c_idÀ
->
d⁄e
);

683 
	}
}

686 
__˝uöô
 
	$™noun˚_˝u
(
˝u
, 
≠icid
)

688 
cuºít_node
 = -1;

689 
node
 = 
	`˝u_to_node
(
˝u
);

691 i‡(
sy°em_°©e
 =
SYSTEM_BOOTING
) {

692 i‡(
node
 !
cuºít_node
) {

693 i‡(
cuºít_node
 > (-1))

694 
	`¥_c⁄t
(" Ok.\n");

695 
cuºít_node
 = 
node
;

696 
	`¥_öfo
("BoŸög Nodê%3d, Pro˚ss‹†", 
node
);

698 
	`¥_c⁄t
(" #%d%s", 
˝u
, cpu =(
ƒ_˝u_ids
 - 1) ? " Ok.\n" : "");

701 
	`¥_öfo
("Booting Node %d Processor %d APIC 0x%x\n",

702 
node
, 
˝u
, 
≠icid
);

703 
	}
}

711 
__˝uöô
 
	$do_boŸ_˝u
(
≠icid
, 
˝u
)

713 
boŸ_îr‹
 = 0;

714 
°¨t_ù
;

715 
timeout
;

716 
¸óã_idÀ
 
c_idÀ
 = {

717 .
˝u
 = cpu,

718 .
d⁄e
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idÀ
.done),

721 
	`INIT_WORK_ON_STACK
(&
c_idÀ
.
w‹k
, 
do_f‹k_idÀ
);

723 
	`Æã∫©ives_smp_swôch
(1);

725 
c_idÀ
.
idÀ
 = 
	`gë_idÀ_f‹_˝u
(
˝u
);

731 i‡(
c_idÀ
.
idÀ
) {

732 
c_idÀ
.
idÀ
->
thªad
.
•
 = (Ë(((
±_ªgs
 *)

733 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
))) - 1);

734 
	`öô_idÀ
(
c_idÀ
.
idÀ
, 
˝u
);

735 
do_ª°
;

738 i‡(!
	`kevítd_up
(Ë|| 
	`cuºít_is_kevítd
())

739 
c_idÀ
.
w‹k
.
	`func
(&c_idle.work);

741 
	`scheduÀ_w‹k
(&
c_idÀ
.
w‹k
);

742 
	`waô_f‹_com∂ëi⁄
(&
c_idÀ
.
d⁄e
);

745 i‡(
	`IS_ERR
(
c_idÀ
.
idÀ
)) {

746 
	`¥ötk
("Áûed f‹k f‹ CPU %d\n", 
˝u
);

747 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

748  
	`PTR_ERR
(
c_idÀ
.
idÀ
);

751 
	`£t_idÀ_f‹_˝u
(
˝u
, 
c_idÀ
.
idÀ
);

752 
do_ª°
:

753 
	`≥r_˝u
(
cuºít_èsk
, 
˝u
Ë
c_idÀ
.
idÀ
;

754 #ifde‡
CONFIG_X86_32


756 
	`úq_˘x_öô
(
˝u
);

758 
	`˛ór_tsk_thªad_Êag
(
c_idÀ
.
idÀ
, 
TIF_FORK
);

759 
öôül_gs
 = 
	`≥r_˝u_off£t
(
˝u
);

760 
	`≥r_˝u
(
kî√l_°ack
, 
˝u
) =

761 ()
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
) -

762 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

764 
óæy_gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

765 
öôül_code
 = ()
°¨t_£c⁄d¨y
;

766 
°ack_°¨t
.
•
 = (*Ë
c_idÀ
.
idÀ
->
thªad
.sp;

769 
°¨t_ù
 = 
	`£tup_åampﬁöe
();

772 
	`™noun˚_˝u
(
˝u
, 
≠icid
);

779 
	`©omic_£t
(&
öô_dós£πed
, 0);

781 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

783 
	`¥_debug
("Setting warmÑeset codeánd vector.\n");

785 
	`smpboŸ_£tup_w¨m_ª£t_ve˘‹
(
°¨t_ù
);

789 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

790 
	`≠ic_wrôe
(
APIC_ESR
, 0);

791 
	`≠ic_ªad
(
APIC_ESR
);

799 i‡(
≠ic
->
wakeup_£c⁄d¨y_˝u
)

800 
boŸ_îr‹
 = 
≠ic
->
	`wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_ù
);

802 
boŸ_îr‹
 = 
	`wakeup_£c⁄d¨y_˝u_vü_öô
(
≠icid
, 
°¨t_ù
);

804 i‡(!
boŸ_îr‹
) {

808 
	`¥_debug
("Bef‹êCÆlouà%d.\n", 
˝u
);

809 
	`˝umask_£t_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

810 
	`¥_debug
("A·î CÆlouà%d.\n", 
˝u
);

815 
timeout
 = 0;Åimeout < 50000;Åimeout++) {

816 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

818 
	`udñay
(100);

821 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

822 
	`¥_debug
("CPU%d: ha†boŸed.\n", 
˝u
);

824 
boŸ_îr‹
 = 1;

825 i‡(*((vﬁ©ûê*)
åampﬁöe_ba£
)

828 
	`¥_îr
("CPU%d: Stuck ??\n", 
˝u
);

831 
	`¥_îr
("CPU%d: NŸÑe•⁄dög.\n", 
˝u
);

832 i‡(
≠ic
->
öquúe_ªmŸe_≠ic
)

833 
≠ic
->
	`öquúe_ªmŸe_≠ic
(
≠icid
);

837 i‡(
boŸ_îr‹
) {

839 
	`numa_ªmove_˝u
(
˝u
);

842 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

845 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

847 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

848 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
BAD_APICID
;

852 *((vﬁ©ûê*)
åampﬁöe_ba£
) = 0;

854 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

858 
	`smpboŸ_ª°‹e_w¨m_ª£t_ve˘‹
();

861 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

862  
boŸ_îr‹
;

863 
	}
}

865 
__˝uöô
 
	$«tive_˝u_up
(
˝u
)

867 
≠icid
 = 
≠ic
->
	`˝u_¥e£¡_to_≠icid
(
˝u
);

868 
Êags
;

869 
îr
;

871 
	`WARN_ON
(
	`úqs_dißbÀd
());

873 
	`¥_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
˝u
);

875 i‡(
≠icid
 =
BAD_APICID
 ||ápicid =
boŸ_˝u_physiˇl_≠icid
 ||

876 !
	`physid_is£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
)) {

877 
	`¥ötk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
˝u
);

878  -
EINVAL
;

884 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

885 
	`¥_debug
("do_boŸ_˝u %d AÃódy sèπed\n", 
˝u
);

886  -
ENOSYS
;

893 
	`mår_ßve_°©e
();

895 
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë
CPU_UP_PREPARE
;

897 #ifde‡
CONFIG_X86_32


899 
	`˛⁄e_pgd_ønge
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

900 
	`mö_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

901 
	`Êush_éb_Æl
();

902 
low_m≠pögs
 = 1;

904 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

906 
	`z≠_low_m≠pögs
(
Ál£
);

907 
low_m≠pögs
 = 0;

909 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

911 i‡(
îr
) {

912 
	`¥_debug
("do_boŸ_˝u faûed %d\n", 
îr
);

913  -
EIO
;

920 
	`loˇl_úq_ßve
(
Êags
);

921 
	`check_tsc_sync_sour˚
(
˝u
);

922 
	`loˇl_úq_ª°‹e
(
Êags
);

924 !
	`˝u_⁄löe
(
˝u
)) {

925 
	`˝u_ªœx
();

926 
	`touch_nmi_w©chdog
();

930 
	}
}

937 
__öô
 
	$dißbÀ_smp
()

939 
	`öô_˝u_¥e£¡
(
	`˝umask_of
(0));

940 
	`öô_˝u_possibÀ
(
	`˝umask_of
(0));

941 
	`smpboŸ_˛ór_io_≠ic_úqs
();

943 i‡(
smp_found_c⁄fig
)

944 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

946 
	`physid_£t_mask_of_physid
(0, &
phys_˝u_¥e£¡_m≠
);

947 
	`m≠_˝u_to_logiˇl_≠icid
();

948 
	`˝umask_£t_˝u
(0, 
	`˝u_siblög_mask
(0));

949 
	`˝umask_£t_˝u
(0, 
	`˝u_c‹e_mask
(0));

950 
	}
}

955 
__öô
 
	$smp_ßnôy_check
(
max_˝us
)

957 
	`¥ìm±_dißbÀ
();

959 #i‡!
	`deföed
(
CONFIG_X86_BIGSMP
Ë&& deföed(
CONFIG_X86_32
)

960 i‡(
def_to_bigsmp
 && 
ƒ_˝u_ids
 > 8) {

961 
˝u
;

962 
ƒ
;

964 
	`¥ötk
(
KERN_WARNING


968 
ƒ
 = 0;

969 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

970 i‡(
ƒ
 >= 8)

971 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

972 
ƒ
++;

975 
ƒ
 = 0;

976 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

977 i‡(
ƒ
 >= 8)

978 
	`£t_˝u_possibÀ
(
˝u
, 
Ál£
);

979 
ƒ
++;

982 
ƒ_˝u_ids
 = 8;

986 i‡(!
	`physid_is£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
)) {

987 
	`¥ötk
(
KERN_WARNING


989 
	`h¨d_smp_¥o˚ss‹_id
());

991 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

998 i‡(!
smp_found_c⁄fig
 && !
a˝i_œpic
) {

999 
	`¥ìm±_íabÀ
();

1000 
	`¥ötk
(
KERN_NOTICE
 "SMP motherboardÇot detected.\n");

1001 
	`dißbÀ_smp
();

1002 i‡(
	`APIC_öô_unùro˚ss‹
())

1003 
	`¥ötk
(
KERN_NOTICE
 "Local APICÇot detected."

1012 i‡(!
≠ic
->
	`check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)) {

1013 
	`¥ötk
(
KERN_NOTICE


1015 
boŸ_˝u_physiˇl_≠icid
);

1016 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

1018 
	`¥ìm±_íabÀ
();

1023 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]) &&

1024 !
˝u_has_≠ic
) {

1025 i‡(!
dißbÀ_≠ic
) {

1026 
	`¥_îr
("BIOS bug,Üocal APIC #%dÇot detected!...\n",

1027 
boŸ_˝u_physiˇl_≠icid
);

1028 
	`¥_îr
("... forcing use of dummy APICÉmulation."

1031 
	`smpboŸ_˛ór_io_≠ic
();

1032 
	`¨ch_dißbÀ_smp_suµ‹t
();

1036 
	`vîify_loˇl_APIC
();

1041 i‡(!
max_˝us
) {

1042 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

1043 
	`smpboŸ_˛ór_io_≠ic
();

1045 
	`loˇli£_nmi_w©chdog
();

1047 
	`c⁄√˘_b•_APIC
();

1048 
	`£tup_loˇl_APIC
();

1049 
	`íd_loˇl_APIC_£tup
();

1054 
	}
}

1056 
__öô
 
	$smp_˝u_ödex_deÁu…
()

1058 
i
;

1059 
˝uöfo_x86
 *
c
;

1061 
	`f‹_óch_possibÀ_˝u
(
i
) {

1062 
c
 = &
	`˝u_d©a
(
i
);

1064 
c
->
˝u_ödex
 = 
ƒ_˝u_ids
;

1066 
	}
}

1072 
__öô
 
	$«tive_smp_¥ï¨e_˝us
(
max_˝us
)

1074 
i
;

1076 
	`¥ìm±_dißbÀ
();

1077 
	`smp_˝u_ödex_deÁu…
();

1078 
cuºít_˝u_d©a
 = 
boŸ_˝u_d©a
;

1079 
	`˝umask_c›y
(
˝u_ˇŒö_mask
, 
	`˝umask_of
(0));

1080 
	`mb
();

1084 
	`smp_°‹e_˝u_öfo
(0);

1085 #ifde‡
CONFIG_X86_32


1086 
boŸ_˝u_logiˇl_≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

1088 
	`cuºít_thªad_öfo
()->
˝u
 = 0;

1089 
	`f‹_óch_possibÀ_˝u
(
i
) {

1090 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
), 
GFP_KERNEL
);

1091 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
), 
GFP_KERNEL
);

1092 
	`zÆloc_˝umask_v¨
(&
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
, 
GFP_KERNEL
);

1094 
	`£t_˝u_siblög_m≠
(0);

1096 
	`íabÀ_IR_x2≠ic
();

1097 
	`deÁu…_£tup_≠ic_routög
();

1099 i‡(
	`smp_ßnôy_check
(
max_˝us
) < 0) {

1100 
	`¥ötk
(
KERN_INFO
 "SMP disabled\n");

1101 
	`dißbÀ_smp
();

1102 
out
;

1105 
	`¥ìm±_dißbÀ
();

1106 i‡(
	`ªad_≠ic_id
(Ë!
boŸ_˝u_physiˇl_≠icid
) {

1107 
	`∑nic
("Boot APIC ID inÜocal APIC unexpected (%d vs %d)",

1108 
	`ªad_≠ic_id
(), 
boŸ_˝u_physiˇl_≠icid
);

1111 
	`¥ìm±_íabÀ
();

1113 
	`c⁄√˘_b•_APIC
();

1118 
	`£tup_loˇl_APIC
();

1123 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1124 
	`íabÀ_IO_APIC
();

1126 
	`íd_loˇl_APIC_£tup
();

1128 
	`m≠_˝u_to_logiˇl_≠icid
();

1130 i‡(
≠ic
->
£tup_p‹tio_ªm≠
)

1131 
≠ic
->
	`£tup_p‹tio_ªm≠
();

1133 
	`smpboŸ_£tup_io_≠ic
();

1138 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 0);

1139 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(0));

1140 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1142 i‡(
	`is_uv_sy°em
())

1143 
	`uv_sy°em_öô
();

1145 
	`£t_mår_≠s_dñayed_öô
();

1146 
out
:

1147 
	`¥ìm±_íabÀ
();

1148 
	}
}

1150 
	$¨ch_íabÀ_n⁄boŸ_˝us_begö
()

1152 
	`£t_mår_≠s_dñayed_öô
();

1153 
	}
}

1155 
	$¨ch_íabÀ_n⁄boŸ_˝us_íd
()

1157 
	`mår_≠s_öô
();

1158 
	}
}

1163 
__öô
 
	$«tive_smp_¥ï¨e_boŸ_˝u
()

1165 
me
 = 
	`smp_¥o˚ss‹_id
();

1166 
	`swôch_to_√w_gdt
(
me
);

1168 
	`˝umask_£t_˝u
(
me
, 
˝u_ˇŒout_mask
);

1169 
	`≥r_˝u
(
˝u_°©e
, 
me
Ë
CPU_ONLINE
;

1170 
	}
}

1172 
__öô
 
	$«tive_smp_˝us_d⁄e
(
max_˝us
)

1174 
	`¥_debug
("Boot done.\n");

1176 
	`im¥ess_‰õnds
();

1177 #ifde‡
CONFIG_X86_IO_APIC


1178 
	`£tup_iﬂpic_de°
();

1180 
	`check_nmi_w©chdog
();

1181 
	`mår_≠s_öô
();

1182 
	}
}

1184 
__öôd©a
 
	g£tup_possibÀ_˝us
 = -1;

1185 
__öô
 
	$_£tup_possibÀ_˝us
(*
°r
)

1187 
	`gë_›ti⁄
(&
°r
, &
£tup_possibÀ_˝us
);

1189 
	}
}

1190 
óæy_∑øm
("possibÀ_˝us", 
_£tup_possibÀ_˝us
);

1210 
__öô
 
	$¥efûl_possibÀ_m≠
()

1212 
i
, 
possibÀ
;

1215 i‡(!
num_¥o˚ss‹s
)

1216 
num_¥o˚ss‹s
 = 1;

1218 i‡(
£tup_possibÀ_˝us
 == -1)

1219 
possibÀ
 = 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
;

1221 
possibÀ
 = 
£tup_possibÀ_˝us
;

1223 
tŸÆ_˝us
 = 
	`max_t
(, 
possibÀ
, 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
);

1226 i‡(
possibÀ
 > 
ƒ_˝u_ids
) {

1227 
	`¥ötk
(
KERN_WARNING


1229 
possibÀ
, 
ƒ_˝u_ids
);

1230 
possibÀ
 = 
ƒ_˝u_ids
;

1233 
	`¥ötk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1234 
possibÀ
, 
	`max_t
(,ÖossibÀ - 
num_¥o˚ss‹s
, 0));

1236 
i
 = 0; i < 
possibÀ
; i++)

1237 
	`£t_˝u_possibÀ
(
i
, 
åue
);

1239 
ƒ_˝u_ids
 = 
possibÀ
;

1240 
	}
}

1242 #ifde‡
CONFIG_HOTPLUG_CPU


1244 
	$ªmove_siblögöfo
(
˝u
)

1246 
siblög
;

1247 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

1249 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_c‹e_mask
(
˝u
)) {

1250 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
siblög
));

1254 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1)

1255 
	`˝u_d©a
(
siblög
).
boŸed_c‹es
--;

1258 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_siblög_mask
(
˝u
))

1259 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_siblög_mask
(
siblög
));

1260 
	`˝umask_˛ór
(
	`˝u_siblög_mask
(
˝u
));

1261 
	`˝umask_˛ór
(
	`˝u_c‹e_mask
(
˝u
));

1262 
c
->
phys_¥oc_id
 = 0;

1263 
c
->
˝u_c‹e_id
 = 0;

1264 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

1265 
	}
}

1267 
__ªf
 
	$ªmove_˝u_‰om_m≠s
(
˝u
)

1269 
	`£t_˝u_⁄löe
(
˝u
, 
Ál£
);

1270 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

1271 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒö_mask
);

1273 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

1274 
	`numa_ªmove_˝u
(
˝u
);

1275 
	}
}

1277 
	$˝u_dißbÀ_comm⁄
()

1279 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1281 
	`ªmove_siblögöfo
(
˝u
);

1284 
	`lock_ve˘‹_lock
();

1285 
	`ªmove_˝u_‰om_m≠s
(
˝u
);

1286 
	`u∆ock_ve˘‹_lock
();

1287 
	`fixup_úqs
();

1288 
	}
}

1290 
	$«tive_˝u_dißbÀ
()

1292 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1302 i‡(
˝u
 == 0)

1303  -
EBUSY
;

1305 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

1306 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

1307 
	`˛ór_loˇl_APIC
();

1309 
	`˝u_dißbÀ_comm⁄
();

1311 
	}
}

1313 
	$«tive_˝u_dõ
(
˝u
)

1316 
i
;

1318 
i
 = 0; i < 10; i++) {

1320 i‡(
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë=
CPU_DEAD
) {

1321 i‡(
sy°em_°©e
 =
SYSTEM_RUNNING
)

1322 
	`¥_öfo
("CPU %u i†now ofÊöe\n", 
˝u
);

1324 i‡(1 =
	`num_⁄löe_˝us
())

1325 
	`Æã∫©ives_smp_swôch
(0);

1328 
	`m¶ìp
(100);

1330 
	`¥_îr
("CPU %u didn'àdõ...\n", 
˝u
);

1331 
	}
}

1333 
	$∂ay_dód_comm⁄
()

1335 
	`idÀ_èsk_exô
();

1336 
	`ª£t_œzy_éb°©e
();

1337 
	`úq_˘x_exô
(
	`øw_smp_¥o˚ss‹_id
());

1338 
	`c1e_ªmove_˝u
(
	`øw_smp_¥o˚ss‹_id
());

1340 
	`mb
();

1342 
	`__gë_˝u_v¨
(
˝u_°©e
Ë
CPU_DEAD
;

1347 
	`loˇl_úq_dißbÀ
();

1348 
	}
}

1350 
	$«tive_∂ay_dód
()

1352 
	`∂ay_dód_comm⁄
();

1353 
	`tboŸ_shutdown
(
TB_SHUTDOWN_WFS
);

1354 
	`wbövd_hÆt
();

1355 
	}
}

1358 
	$«tive_˝u_dißbÀ
()

1360  -
ENOSYS
;

1361 
	}
}

1363 
	$«tive_˝u_dõ
(
˝u
)

1366 
	`BUG
();

1367 
	}
}

1369 
	$«tive_∂ay_dód
()

1371 
	`BUG
();

1372 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/uac˚ss.h
>

10 
	~<asm/°ackåa˚.h
>

12 
	$ßve_°ack_w¨nög
(*
d©a
, *
msg
)

14 
	}
}

17 
	$ßve_°ack_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

19 
	}
}

21 
	$ßve_°ack_°ack
(*
d©a
, *
«me
)

24 
	}
}

26 
	$ßve_°ack_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

28 
°ack_åa˚
 *
åa˚
 = 
d©a
;

29 i‡(!
ªlübÀ
)

31 i‡(
åa˚
->
skù
 > 0) {

32 
åa˚
->
skù
--;

35 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

36 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

37 
	}
}

40 
	$ßve_°ack_addªss_nosched
(*
d©a
, 
addr
, 
ªlübÀ
)

42 
°ack_åa˚
 *
åa˚
 = (°ack_åa˚ *)
d©a
;

43 i‡(!
ªlübÀ
)

45 i‡(
	`ö_sched_fun˘i⁄s
(
addr
))

47 i‡(
åa˚
->
skù
 > 0) {

48 
åa˚
->
skù
--;

51 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

53 
	}
}

55 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s
 = {

56 .
w¨nög
 = 
ßve_°ack_w¨nög
,

57 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

58 .
	g°ack
 = 
ßve_°ack_°ack
,

59 .
	gaddªss
 = 
ßve_°ack_addªss
,

60 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

63 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s_nosched
 = {

64 .
w¨nög
 = 
ßve_°ack_w¨nög
,

65 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

66 .
	g°ack
 = 
ßve_°ack_°ack
,

67 .
	gaddªss
 = 
ßve_°ack_addªss_nosched
,

68 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

74 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

76 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 0, &
ßve_°ack_›s
, 
åa˚
);

77 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

78 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

79 
	}
}

80 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚
);

82 
	$ßve_°ack_åa˚_bp
(
°ack_åa˚
 *
åa˚
, 
bp
)

84 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 
bp
, &
ßve_°ack_›s
, 
åa˚
);

85 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

86 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

87 
	}
}

89 
	$ßve_°ack_åa˚_tsk
(
èsk_°ru˘
 *
tsk
, 
°ack_åa˚
 *
åa˚
)

91 
	`dump_åa˚
(
tsk
, 
NULL
, NULL, 0, &
ßve_°ack_›s_nosched
, 
åa˚
);

92 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

93 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

94 
	}
}

95 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚_tsk
);

99 
	s°ack_‰ame
 {

100 c⁄° 
__u£r
 *
	m√xt_Â
;

101 
	mªt_addr
;

104 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

106 
ªt
;

108 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
Â
, (*
‰ame
)))

111 
ªt
 = 1;

112 
	`∑geÁu…_dißbÀ
();

113 i‡(
	`__c›y_‰om_u£r_ö©omic
(
‰ame
, 
Â
, (*frame)))

114 
ªt
 = 0;

115 
	`∑geÁu…_íabÀ
();

117  
ªt
;

118 
	}
}

120 
ölöe
 
	$__ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

122 c⁄° 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

123 c⁄° 
__u£r
 *
Â
 = (c⁄° __u£∏*)
ªgs
->
bp
;

125 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

126 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ªgs
->
ù
;

128 
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
) {

129 
°ack_‰ame
 
‰ame
;

131 
‰ame
.
√xt_Â
 = 
NULL
;

132 
‰ame
.
ªt_addr
 = 0;

133 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

135 i‡(()
Â
 < 
ªgs
->
•
)

137 i‡(
‰ame
.
ªt_addr
) {

138 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] =

139 
‰ame
.
ªt_addr
;

141 i‡(
Â
 =
‰ame
.
√xt_Â
)

143 
Â
 = 
‰ame
.
√xt_Â
;

145 
	}
}

147 
	$ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

152 i‡(
cuºít
->
mm
) {

153 
	`__ßve_°ack_åa˚_u£r
(
åa˚
);

155 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

156 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

157 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<löux/sched.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/±ø˚.h
>

7 
	~<asm/desc.h
>

9 
	$c⁄vît_ù_to_löór
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

11 
addr
, 
£g
;

13 
addr
 = 
ªgs
->
ù
;

14 
£g
 = 
ªgs
->
cs
 & 0xffff;

15 i‡(
	`v8086_mode
(
ªgs
)) {

16 
addr
 = (add∏& 0xffffË+ (
£g
 << 4);

17  
addr
;

26 i‡((
£g
 & 
SEGMENT_TI_MASK
Ë=
SEGMENT_LDT
) {

27 
desc_°ru˘
 *
desc
;

28 
ba£
;

30 
£g
 &= ~7UL;

32 
	`muãx_lock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

33 i‡(
	`u∆ikñy
((
£g
 >> 3Ë>
chûd
->
mm
->
c⁄ãxt
.
size
))

34 
addr
 = -1L;

36 
desc
 = 
chûd
->
mm
->
c⁄ãxt
.
ldt
 + 
£g
;

37 
ba£
 = 
	`gë_desc_ba£
(
desc
);

40 i‡(!
desc
->
d
)

41 
addr
 &= 0xffff;

42 
addr
 +
ba£
;

44 
	`muãx_u∆ock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

47  
addr
;

48 
	}
}

50 
	$is_£âög_å≠_Êag
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

52 
i
, 
c›õd
;

53 
›code
[15];

54 
addr
 = 
	`c⁄vît_ù_to_löór
(
chûd
, 
ªgs
);

56 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, 
›code
, (opcode), 0);

57 
i
 = 0; i < 
c›õd
; i++) {

58 
›code
[
i
]) {

75 #ifde‡
CONFIG_X86_64


77 i‡(
ªgs
->
cs
 !
__USER_CS
)

99 
	}
}

104 
	$íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

106 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

107 
oÊags
;

119 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
)))

120 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

127 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

129 
oÊags
 = 
ªgs
->
Êags
;

132 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

143 i‡(
	`is_£âög_å≠_Êag
(
chûd
, 
ªgs
)) {

144 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

152 i‡(
oÊags
 & 
X86_EFLAGS_TF
)

153  
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

155 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

158 
	}
}

163 
	$wrôe_debug˘lm§
(
èsk_°ru˘
 *
chûd
, 
vÆ
)

165 i‡(
chûd
->
thªad
.
debug˘lm§
 =
vÆ
)

168 
chûd
->
thªad
.
debug˘lm§
 = 
vÆ
;

170 i‡(
chûd
 !
cuºít
)

173 
	`upd©e_debug˘lm§
(
vÆ
);

174 
	}
}

179 
	$íabÀ_°ï
(
èsk_°ru˘
 *
chûd
, 
boﬁ
 
block
)

188 i‡(
	`íabÀ_sögÀ_°ï
(
chûd
Ë&& 
block
) {

189 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

190 
	`wrôe_debug˘lm§
(
chûd
,

191 
chûd
->
thªad
.
debug˘lm§
 | 
DEBUGCTLMSR_BTF
);

193 
	`wrôe_debug˘lm§
(
chûd
,

194 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

196 i‡(!
chûd
->
thªad
.
debug˘lm§
)

197 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

199 
	}
}

201 
	$u£r_íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

203 
	`íabÀ_°ï
(
chûd
, 0);

204 
	}
}

206 
	$u£r_íabÀ_block_°ï
(
èsk_°ru˘
 *
chûd
)

208 
	`íabÀ_°ï
(
chûd
, 1);

209 
	}
}

211 
	$u£r_dißbÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

216 
	`wrôe_debug˘lm§
(
chûd
,

217 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

219 i‡(!
chûd
->
thªad
.
debug˘lm§
)

220 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

223 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

226 i‡(
	`ã°_™d_˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
))

227 
	`èsk_±_ªgs
(
chûd
)->
Êags
 &~
X86_EFLAGS_TF
;

228 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/sysˇŒs.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/fs.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/£m.h
>

8 
	~<löux/msg.h
>

9 
	~<löux/shm.h
>

10 
	~<löux/°©.h
>

11 
	~<löux/mm™.h
>

12 
	~<löux/fûe.h
>

13 
	~<löux/ut¢ame.h
>

14 
	~<löux/≥rs⁄Æôy.h
>

15 
	~<löux/øndom.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/ü32.h
>

19 
	~<asm/sysˇŒs.h
>

21 
	$SYSCALL_DEFINE6
(
mm≠
, , 
addr
, , 
Àn
,

22 , 
¥Ÿ
, , 
Êags
,

23 , 
fd
, , 
off
)

25 
îr‹
;

26 
îr‹
 = -
EINVAL
;

27 i‡(
off
 & ~
PAGE_MASK
)

28 
out
;

30 
îr‹
 = 
	`sys_mm≠_pgoff
(
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
fd
, 
off
 >> 
PAGE_SHIFT
);

31 
out
:

32  
îr‹
;

33 
	}
}

35 
	$föd_°¨t_íd
(
Êags
, *
begö
,

36 *
íd
)

38 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
)) {

39 
√w_begö
;

47 *
begö
 = 0x40000000;

48 *
íd
 = 0x80000000;

49 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

50 
√w_begö
 = 
	`øndomize_ønge
(*
begö
, *begin + 0x02000000, 0);

51 i‡(
√w_begö
)

52 *
begö
 = 
√w_begö
;

55 *
begö
 = 
TASK_UNMAPPED_BASE
;

56 *
íd
 = 
TASK_SIZE
;

58 
	}
}

61 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

62 
Àn
, 
pgoff
, 
Êags
)

64 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

65 
vm_¨ó_°ru˘
 *
vma
;

66 
°¨t_addr
;

67 
begö
, 
íd
;

69 i‡(
Êags
 & 
MAP_FIXED
)

70  
addr
;

72 
	`föd_°¨t_íd
(
Êags
, &
begö
, &
íd
);

74 i‡(
Àn
 > 
íd
)

75  -
ENOMEM
;

77 i‡(
addr
) {

78 
addr
 = 
	`PAGE_ALIGN
(addr);

79 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

80 i‡(
íd
 - 
Àn
 >
addr
 &&

81 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

82  
addr
;

84 i‡(((
Êags
 & 
MAP_32BIT
Ë|| 
	`ã°_thªad_Êag
(
TIF_IA32
))

85 && 
Àn
 <
mm
->
ˇched_hﬁe_size
) {

86 
mm
->
ˇched_hﬁe_size
 = 0;

87 
mm
->
‰ì_¨ó_ˇche
 = 
begö
;

89 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

90 i‡(
addr
 < 
begö
)

91 
addr
 = 
begö
;

92 
°¨t_addr
 = 
addr
;

94 
fuŒ_£¨ch
:

95 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

97 i‡(
íd
 - 
Àn
 < 
addr
) {

102 i‡(
°¨t_addr
 !
begö
) {

103 
°¨t_addr
 = 
addr
 = 
begö
;

104 
mm
->
ˇched_hﬁe_size
 = 0;

105 
fuŒ_£¨ch
;

107  -
ENOMEM
;

109 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

113 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

114  
addr
;

116 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

117 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

119 
addr
 = 
vma
->
vm_íd
;

121 
	}
}

125 
	$¨ch_gë_unm≠≥d_¨ó_t›down
(
fûe
 *
fûp
, c⁄° 
addr0
,

126 c⁄° 
Àn
, c⁄° 
pgoff
,

127 c⁄° 
Êags
)

129 
vm_¨ó_°ru˘
 *
vma
;

130 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

131 
addr
 = 
addr0
;

134 i‡(
Àn
 > 
TASK_SIZE
)

135  -
ENOMEM
;

137 i‡(
Êags
 & 
MAP_FIXED
)

138  
addr
;

141 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
))

142 
bŸtomup
;

145 i‡(
addr
) {

146 
addr
 = 
	`PAGE_ALIGN
(addr);

147 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

148 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

149 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

150  
addr
;

154 i‡(
Àn
 <
mm
->
ˇched_hﬁe_size
) {

155 
mm
->
ˇched_hﬁe_size
 = 0;

156 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

160 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

163 i‡(
addr
 > 
Àn
) {

164 
vma
 = 
	`föd_vma
(
mm
, 
addr
-
Àn
);

165 i‡(!
vma
 || 
addr
 <vma->
vm_°¨t
)

167  
mm
->
‰ì_¨ó_ˇche
 = 
addr
-
Àn
;

170 i‡(
mm
->
mm≠_ba£
 < 
Àn
)

171 
bŸtomup
;

173 
addr
 = 
mm
->
mm≠_ba£
-
Àn
;

181 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

182 i‡(!
vma
 || 
addr
+
Àn
 <vma->
vm_°¨t
)

184  
mm
->
‰ì_¨ó_ˇche
 = 
addr
;

187 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

188 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

191 
addr
 = 
vma
->
vm_°¨t
-
Àn
;

192 } 
Àn
 < 
vma
->
vm_°¨t
);

194 
bŸtomup
:

201 
mm
->
ˇched_hﬁe_size
 = ~0UL;

202 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

203 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó
(
fûp
, 
addr0
, 
Àn
, 
pgoff
, 
Êags
);

207 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

208 
mm
->
ˇched_hﬁe_size
 = ~0UL;

210  
addr
;

211 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<löux/lökage.h
>

4 
	~<löux/sys.h
>

5 
	~<löux/ˇche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
ƒ
, 
sym
Ë
asmlökage
 
	`sym
(Ë;

	)

11 #unde‡
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni°d_64.h
>

14 #unde‡
__SYSCALL


15 
	#__SYSCALL
(
ƒ
, 
sym
Ë[ƒ] = sym,

	)

16 #unde‡
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ˇŒ_±r_t
)();

20 
	`sys_ni_sysˇŒ
();

22 c⁄° 
sys_ˇŒ_±r_t
 
sys_ˇŒ_èbÀ
[
__NR_sysˇŒ_max
+1] = {

27 [0 ... 
__NR_sysˇŒ_max
] = &
sys_ni_sysˇŒ
,

28 
	~<asm/uni°d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/•ölock.h
>

30 
	~<löux/°rög.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/dma-m≠pög.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<asm/t˚.h
>

35 
	~<asm/ˇlg¨y.h
>

36 
	~<asm/¥Ÿo.h
>

39 
ölöe
 
	$Êush_t˚
(* 
t˚addr
)

42 i‡(
˝u_has_˛Êush
)

43 
	`˛Êush
(
t˚addr
);

45 
	`wbövd
();

46 
	}
}

48 
	$t˚_buûd
(
iommu_èbÀ
 *
tbl
, 
ödex
,

49 
≈ages
, 
uaddr
, 
dúe˘i⁄
)

51 
u64
* 
ç
;

52 
u64
 
t
;

53 
u64
 
Ωn
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 i‡(
dúe˘i⁄
 !
DMA_TO_DEVICE
)

57 
t
 |(1 << 
TCE_WRITE_SHIFT
);

59 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

61 
≈ages
--) {

62 
Ωn
 = (
	`vút_to_bus
((*)
uaddr
)Ë>> 
PAGE_SHIFT
;

63 
t
 &~
TCE_RPN_MASK
;

64 
t
 |(
Ωn
 << 
TCE_RPN_SHIFT
);

66 *
ç
 = 
	`˝u_to_be64
(
t
);

67 
	`Êush_t˚
(
ç
);

69 
uaddr
 +
PAGE_SIZE
;

70 
ç
++;

72 
	}
}

74 
	$t˚_‰ì
(
iommu_èbÀ
 *
tbl
, 
ödex
, 
≈ages
)

76 
u64
* 
ç
;

78 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

80 
≈ages
--) {

81 *
ç
 = 
	`˝u_to_be64
(0);

82 
	`Êush_t˚
(
ç
);

83 
ç
++;

85 
	}
}

87 
ölöe
 
	$èbÀ_size_to_numbî_of_íåõs
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$t˚_èbÀ_£ç¨ms
(
pci_dev
 *
dev
, 
iommu_èbÀ
 *
tbl
)

99 
bôm≠sz
;

100 
bmµages
;

101 
ªt
;

103 
tbl
->
ô_bu¢o
 = 
dev
->
bus
->
numbî
;

106 
tbl
->
ô_size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

112 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
bôm≠sz
));

114 i‡(!
bmµages
) {

115 
	`¥ötk
(
KERN_ERR
 "Calgary: cannotállocate bitmap\n");

116 
ªt
 = -
ENOMEM
;

117 
d⁄e
;

120 
tbl
->
ô_m≠
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
ô_m≠
, 0, 
bôm≠sz
);

124 
tbl
->
ô_höt
 = 0;

126 
	`•ö_lock_öô
(&
tbl
->
ô_lock
);

130 
d⁄e
:

131  
ªt
;

132 
	}
}

134 
__öô
 
	$buûd_t˚_èbÀ
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

136 
iommu_èbÀ
 *
tbl
;

137 
ªt
;

139 i‡(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`¥ötk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kzÆloc
((
iommu_èbÀ
), 
GFP_KERNEL
);

146 i‡(!
tbl
) {

147 
	`¥ötk
(
KERN_ERR
 "Calgary:Érrorállocating iommu_table\n");

148 
ªt
 = -
ENOMEM
;

149 
d⁄e
;

152 
ªt
 = 
	`t˚_èbÀ_£ç¨ms
(
dev
, 
tbl
);

153 i‡(
ªt
)

154 
‰ì_tbl
;

156 
tbl
->
bb¨
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
‰ì_tbl
:

163 
	`k‰ì
(
tbl
);

164 
d⁄e
:

165  
ªt
;

166 
	}
}

168 * 
__öô
 
	$Æloc_t˚_èbÀ
()

170 
size
;

172 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

173 
size
 *
TCE_ENTRY_SIZE
;

175  
	`__Æloc_boŸmem_low
(
size
, size, 0);

176 
	}
}

178 
__öô
 
	$‰ì_t˚_èbÀ
(*
tbl
)

180 
size
;

182 i‡(!
tbl
)

185 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

186 
size
 *
TCE_ENTRY_SIZE
;

188 
	`‰ì_boŸmem
(
	`__∑
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/s‹t.h
>

14 
	~<löux/¶ab.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_ã°_d©a
;

45 
	$fudze_ex˚±i⁄_èbÀ
(*
m¨kî
, *
√w
)

47 
moduÀ
 *
mod
 = 
THIS_MODULE
;

48 
ex˚±i⁄_èbÀ_íåy
 *
exèbÀ
;

56 i‡(
mod
->
num_exíåõs
 > 1) {

57 
	`¥ötk
(
KERN_ERR
 "test_nx:Åoo manyÉxceptionÅableÉntries!\n");

58 
	`¥ötk
(
KERN_ERR
 "test_nx:ÅestÑesultsáreÇotÑeliable.\n");

61 
exèbÀ
 = (
ex˚±i⁄_èbÀ_íåy
 *)
mod
->extable;

62 
exèbÀ
[0].
ö¢
 = ()
√w
;

63 
	}
}

71 
foo_œbñ
();

80 
noölöe
 
	$ã°_addªss
(*
addªss
)

82 
ªsu…
;

85 
	`fudze_ex˚±i⁄_èbÀ
(&
foo_œbñ
, 
addªss
);

86 
ªsu…
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¶t
] "Ù" (
ªsu…
)

97 : [
Áke_code
] "r" (
addªss
), [
zîo
] "r" (0UL), "0" (
ªsu…
)

100 
	`fudze_ex˚±i⁄_èbÀ
(
addªss
, &
foo_œbñ
);

102 i‡(
ªsu…
)

103  -
ENODEV
;

105 
	}
}

107 
	gã°_d©a
 = 0xC3;

109 
	$ã°_NX
()

111 
ªt
 = 0;

113 
°ackcode
[] = {0xC3, 0x90, 0 };

114 *
hóp
;

116 
ã°_d©a
 = 0xC3;

118 
	`¥ötk
(
KERN_INFO
 "Testing NXÖrotection\n");

121 i‡(
	`ã°_addªss
(&
°ackcode
)) {

122 
	`¥ötk
(
KERN_ERR
 "test_nx: stack wasÉxecutable\n");

123 
ªt
 = -
ENODEV
;

128 
hóp
 = 
	`kmÆloc
(64, 
GFP_KERNEL
);

129 i‡(!
hóp
)

130  -
ENOMEM
;

131 
hóp
[0] = 0xC3;

133 i‡(
	`ã°_addªss
(
hóp
)) {

134 
	`¥ötk
(
KERN_ERR
 "test_nx: heap wasÉxecutable\n");

135 
ªt
 = -
ENODEV
;

137 
	`k‰ì
(
hóp
);

145 #ifde‡
CONFIG_DEBUG_RODATA


147 i‡(
rod©a_ã°_d©a
 != 0xC3) {

148 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
ªt
 = -
ENODEV
;

150 } i‡(
	`ã°_addªss
(&
rod©a_ã°_d©a
)) {

151 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata section isÉxecutable\n");

152 
ªt
 = -
ENODEV
;

158 i‡(
	`ã°_addªss
(&
ã°_d©a
)) {

159 
	`¥ötk
(
KERN_ERR
 "test_nx: .data section isÉxecutable\n");

160 
ªt
 = -
ENODEV
;

165 
	}
}

167 
	$ã°_exô
()

169 
	}
}

171 
moduÀ_öô
(
ã°_NX
);

172 
moduÀ_exô
(
ã°_exô
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forÅhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time.c

12 
	~<löux/˛ockchùs.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/time.h
>

15 
	~<löux/mˇ.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/x86_öô.h
>

19 
	~<asm/i8259.h
>

20 
	~<asm/i8253.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/time.h
>

25 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_X86_IO_APIC
)

26 
	gtimî_ack
;

29 #ifde‡
CONFIG_X86_64


30 vﬁ©ûê
__jiffõs
 
	g__£˘i⁄_jiffõs
 = 
INITIAL_JIFFIES
;

33 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

35 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

37 i‡(!
	`u£r_mode_vm
(
ªgs
Ë&& 
	`ö_lock_fun˘i⁄s
(
pc
)) {

38 #ifde‡
CONFIG_FRAME_POINTER


39  *(*)(
ªgs
->
bp
 + ());

41 *
•
 =

42 (*)
	`kî√l_°ack_poöãr
(
ªgs
);

48 i‡(
•
[0] >> 22)

49  
•
[0];

50 i‡(
•
[1] >> 22)

51  
•
[1];

54  
pc
;

55 
	}
}

56 
EXPORT_SYMBOL
(
¥ofûe_pc
);

61 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

64 
	`öc_úq_°©
(
úq0_úqs
);

67 i‡(
timî_ack
) {

73 
	`øw_•ö_lock
(&
i8259A_lock
);

74 
	`outb
(0x0c, 
PIC_MASTER_OCW3
);

76 
	`öb
(
PIC_MASTER_POLL
);

77 
	`øw_•ö_u∆ock
(&
i8259A_lock
);

80 
globÆ_˛ock_evít
->
	`evít_h™dÀr
(global_clock_event);

83 i‡(
MCA_bus
)

84 
	`outb_p
(
	`öb_p
(0x61)| 0x80, 0x61);

86  
IRQ_HANDLED
;

87 
	}
}

89 
úqa˘i⁄
 
	gúq0
 = {

90 .
h™dÀr
 = 
timî_öãºu±
,

91 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

92 .
	g«me
 = "timer"

95 
__öô
 
	$£tup_deÁu…_timî_úq
()

97 
	`£tup_úq
(0, &
úq0
);

98 
	}
}

101 
__öô
 
	$h≥t_time_öô
()

103 i‡(!
	`h≥t_íabÀ
())

104 
	`£tup_pô_timî
();

105 
	`£tup_deÁu…_timî_úq
();

106 
	}
}

108 
__öô
 
	$x86_œã_time_öô
()

110 
x86_öô
.
timîs
.
	`timî_öô
();

111 
	`tsc_öô
();

112 
	}
}

118 
__öô
 
	$time_öô
()

120 
œã_time_öô
 = 
x86_œã_time_öô
;

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/u£r.h
>

5 
	~<löux/ªg£t.h
>

7 
	~<asm/uac˚ss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy°em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/¥Ÿo.h
>

13 
	~<asm/sysˇŒs.h
>

15 
	~"és.h
"

20 
	$gë_‰ì_idx
()

22 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 i‡(
	`desc_em±y
(&
t
->
és_¨øy
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_és_desc
(
èsk_°ru˘
 *
p
, 
idx
,

32 c⁄° 
u£r_desc
 *
öfo
, 
n
)

34 
thªad_°ru˘
 *
t
 = &
p
->
thªad
;

35 
desc_°ru˘
 *
desc
 = &
t
->
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
˝u
;

41 
˝u
 = 
	`gë_˝u
();

43 
n
-- > 0) {

44 i‡(
	`LDT_em±y
(
öfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fûl_ldt
(
desc
, 
öfo
);

48 ++
öfo
;

49 ++
desc
;

52 i‡(
t
 =&
cuºít
->
thªad
)

53 
	`lﬂd_TLS
(
t
, 
˝u
);

55 
	`put_˝u
();

56 
	}
}

61 
	$do_£t_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_öfo
,

63 
ˇn_Æloˇã
)

65 
u£r_desc
 
öfo
;

67 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
u_öfo
, (info)))

68  -
EFAULT
;

70 i‡(
idx
 == -1)

71 
idx
 = 
öfo
.
íåy_numbî
;

77 i‡(
idx
 =-1 && 
ˇn_Æloˇã
) {

78 
idx
 = 
	`gë_‰ì_idx
();

79 i‡(
idx
 < 0)

80  
idx
;

81 i‡(
	`put_u£r
(
idx
, &
u_öfo
->
íåy_numbî
))

82  -
EFAULT
;

85 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_és_desc
(
p
, 
idx
, &
öfo
, 1);

91 
	}
}

93 
asmlökage
 
	$sys_£t_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

95 
ªt
 = 
	`do_£t_thªad_¨ó
(
cuºít
, -1, 
u_öfo
, 1);

96 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

97  
ªt
;

98 
	}
}

105 
	$fûl_u£r_desc
(
u£r_desc
 *
öfo
, 
idx
,

106 c⁄° 
desc_°ru˘
 *
desc
)

109 
	`mem£t
(
öfo
, 0, (*info));

110 
öfo
->
íåy_numbî
 = 
idx
;

111 
öfo
->
ba£_addr
 = 
	`gë_desc_ba£
(
desc
);

112 
öfo
->
limô
 = 
	`gë_desc_limô
(
desc
);

113 
öfo
->
£g_32bô
 = 
desc
->
d
;

114 
öfo
->
c⁄ã¡s
 = 
desc
->
ty≥
 >> 2;

115 
öfo
->
ªad_exec_⁄ly
 = !(
desc
->
ty≥
 & 2);

116 
öfo
->
limô_ö_∑ges
 = 
desc
->
g
;

117 
öfo
->
£g_nŸ_¥e£¡
 = !
desc
->
p
;

118 
öfo
->
u£abÀ
 = 
desc
->
avl
;

119 #ifde‡
CONFIG_X86_64


120 
öfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_gë_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_öfo
)

127 
u£r_desc
 
öfo
;

129 i‡(
idx
 =-1 && 
	`gë_u£r
(idx, &
u_öfo
->
íåy_numbî
))

130  -
EFAULT
;

132 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fûl_u£r_desc
(&
öfo
, 
idx
,

136 &
p
->
thªad
.
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 i‡(
	`c›y_to_u£r
(
u_öfo
, &
öfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlökage
 
	$sys_gë_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

145 
ªt
 = 
	`do_gë_thªad_¨ó
(
cuºít
, -1, 
u_öfo
);

146 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

147  
ªt
;

148 
	}
}

150 
	$ªg£t_és_a˘ive
(
èsk_°ru˘
 *
èrgë
,

151 c⁄° 
u£r_ªg£t
 *
ªg£t
)

153 
thªad_°ru˘
 *
t
 = &
èrgë
->
thªad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
és_¨øy
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$ªg£t_és_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

161 
pos
, 
cou¡
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 c⁄° 
desc_°ru˘
 *
és
;

166 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
cou¡
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /(
u£r_desc
);

172 
cou¡
 /(
u£r_desc
);

174 
és
 = &
èrgë
->
thªad
.
és_¨øy
[
pos
];

176 i‡(
kbuf
) {

177 
u£r_desc
 *
öfo
 = 
kbuf
;

178 
cou¡
-- > 0)

179 
	`fûl_u£r_desc
(
öfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
és
++);

182 
u£r_desc
 
__u£r
 *
u_öfo
 = 
ubuf
;

183 
cou¡
-- > 0) {

184 
u£r_desc
 
öfo
;

185 
	`fûl_u£r_desc
(&
öfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
és
++);

186 i‡(
	`__c›y_to_u£r
(
u_öfo
++, &
öfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$ªg£t_és_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
u£r_desc
 
öfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 c⁄° 
u£r_desc
 *
öfo
;

201 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
cou¡
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 i‡(
kbuf
)

207 
öfo
 = 
kbuf
;

208 i‡(
	`__c›y_‰om_u£r
(
öfobuf
, 
ubuf
, 
cou¡
))

209  -
EFAULT
;

211 
öfo
 = 
öfobuf
;

213 
	`£t_és_desc
(
èrgë
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
öfo
, 
cou¡
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<löux/nodemask.h
>

29 
	~<löux/mmz⁄e.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<asm/˝u.h
>

34 
DEFINE_PER_CPU
(
x86_˝u
, 
˝u_devi˚s
);

36 #ifde‡
CONFIG_HOTPLUG_CPU


37 
__ªf
 
	$¨ch_ªgi°î_˝u
(
num
)

48 i‡(
num
)

49 
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
.
hŸ∂uggabÀ
 = 1;

51  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

52 
	}
}

53 
EXPORT_SYMBOL
(
¨ch_ªgi°î_˝u
);

55 
	$¨ch_uƒegi°î_˝u
(
num
)

57 
	`uƒegi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¨ch_uƒegi°î_˝u
);

62 
__öô
 
	$¨ch_ªgi°î_˝u
(
num
)

64  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

65 
	}
}

68 
__öô
 
	$t›ﬁogy_öô
()

70 
i
;

72 #ifde‡
CONFIG_NUMA


73 
	`f‹_óch_⁄löe_node
(
i
)

74 
	`ªgi°î_⁄e_node
(
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
i
)

78 
	`¨ch_ªgi°î_˝u
(
i
);

81 
	}
}

82 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<löux/io.h
>

3 
	~<asm/åampﬁöe.h
>

4 
	~<asm/e820.h
>

6 #i‡
deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_ACPI_SLEEP
)

7 
	#__åampöô


	)

8 
	#__åampöôd©a


	)

10 
	#__åampöô
 
__˝uöô


	)

11 
	#__åampöôd©a
 
__˝uöôd©a


	)

15 *
__åampöôd©a
 
	gåampﬁöe_ba£
;

17 
__öô
 
	$ª£rve_åampﬁöe_mem‹y
()

19 
mem
;

22 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
TRAMPOLINE_SIZE
, 
PAGE_SIZE
);

23 i‡(
mem
 == -1L)

24 
	`∑nic
("CannotállocateÅrampoline\n");

26 
åampﬁöe_ba£
 = 
	`__va
(
mem
);

27 
	`ª£rve_óæy
(
mem
, mem + 
TRAMPOLINE_SIZE
, "TRAMPOLINE");

28 
	}
}

35 
__åampöô
 
	$£tup_åampﬁöe
()

37 
	`mem˝y
(
åampﬁöe_ba£
, 
åampﬁöe_d©a
, 
TRAMPOLINE_SIZE
);

38  
	`vút_to_phys
(
åampﬁöe_ba£
);

39 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<löux/öãºu±.h
>

13 
	~<löux/kÆlsyms.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/k¥obes.h
>

16 
	~<löux/uac˚ss.h
>

17 
	~<löux/kdebug.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/±ø˚.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/î∫o.h
>

24 
	~<löux/kexec.h
>

25 
	~<löux/sched.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/öô.h
>

28 
	~<löux/bug.h
>

29 
	~<löux/nmi.h
>

30 
	~<löux/mm.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/io.h
>

34 #ifde‡
CONFIG_EISA


35 
	~<löux/i›‹t.h
>

36 
	~<löux/eiß.h
>

39 #ifde‡
CONFIG_MCA


40 
	~<löux/mˇ.h
>

43 #i‡
deföed
(
CONFIG_EDAC
)

44 
	~<löux/edac.h
>

47 
	~<asm/kmemcheck.h
>

48 
	~<asm/°ackåa˚.h
>

49 
	~<asm/¥o˚ss‹.h
>

50 
	~<asm/debugªg.h
>

51 
	~<asm/©omic.h
>

52 
	~<asm/sy°em.h
>

53 
	~<asm/å≠s.h
>

54 
	~<asm/desc.h
>

55 
	~<asm/i387.h
>

56 
	~<asm/m˚.h
>

58 
	~<asm/mach_å≠s.h
>

60 #ifde‡
CONFIG_X86_64


61 
	~<asm/x86_öô.h
>

62 
	~<asm/pgÆloc.h
>

63 
	~<asm/¥Ÿo.h
>

65 
	~<asm/¥o˚ss‹-Êags.h
>

66 
	~<asm/£tup.h
>

68 
asmlökage
 
sy°em_ˇŒ
();

71 
	gign‹e_Âu_úq
;

77 
g©e_desc
 
	gidt_èbÀ
[
NR_VECTORS
] 
	g__∑ge_Æig√d_d©a
 = { { { { 0, 0 } } }, };

80 
DECLARE_BITMAP
(
u£d_ve˘‹s
, 
NR_VECTORS
);

81 
EXPORT_SYMBOL_GPL
(
u£d_ve˘‹s
);

83 
	gign‹e_nmis
;

85 
ölöe
 
	$c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

87 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

88 
	`loˇl_úq_íabÀ
();

89 
	}
}

91 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

93 
	`öc_¥ìm±_cou¡
();

94 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

95 
	`loˇl_úq_íabÀ
();

96 
	}
}

98 
ölöe
 
	$c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

100 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

101 
	`loˇl_úq_dißbÀ
();

102 
	}
}

104 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

106 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

107 
	`loˇl_úq_dißbÀ
();

108 
	`dec_¥ìm±_cou¡
();

109 
	}
}

111 #ifde‡
CONFIG_X86_32


112 
ölöe
 

113 
	$dõ_if_kî√l
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

115 i‡(!
	`u£r_mode_vm
(
ªgs
))

116 
	`dõ
(
°r
, 
ªgs
, 
îr
);

117 
	}
}

120 
__k¥obes


121 
	$do_å≠
(
å≠ƒ
, 
sigƒ
, *
°r
, 
±_ªgs
 *
ªgs
,

122 
îr‹_code
, 
sigöfo_t
 *
öfo
)

124 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

126 #ifde‡
CONFIG_X86_32


127 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

132 i‡(
å≠ƒ
 < 6)

133 
vm86_å≠
;

134 
å≠_sig«l
;

138 i‡(!
	`u£r_mode
(
ªgs
))

139 
kî√l_å≠
;

141 #ifde‡
CONFIG_X86_32


142 
å≠_sig«l
:

153 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

154 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

156 #ifde‡
CONFIG_X86_64


157 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
sigƒ
) &&

158 
	`¥ötk_øãlimô
()) {

159 
	`¥ötk
(
KERN_INFO


161 
tsk
->
comm
,Åsk->
pid
, 
°r
,

162 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

163 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

164 
	`¥ötk
("\n");

168 i‡(
öfo
)

169 
	`f‹˚_sig_öfo
(
sigƒ
, 
öfo
, 
tsk
);

171 
	`f‹˚_sig
(
sigƒ
, 
tsk
);

174 
kî√l_å≠
:

175 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

176 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

177 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

178 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

182 #ifde‡
CONFIG_X86_32


183 
vm86_å≠
:

184 i‡(
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

185 
îr‹_code
, 
å≠ƒ
))

186 
å≠_sig«l
;

189 
	}
}

191 
	#DO_ERROR
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
) \

192 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

194 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

195 =
NOTIFY_STOP
) \

197 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

198 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, 
NULL
); \

199 }

	)

201 
	#DO_ERROR_INFO
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
, 
sicode
, 
süddr
) \

202 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

204 
sigöfo_t
 
öfo
; \

205 
öfo
.
si_signo
 = 
sigƒ
; \

206 
öfo
.
si_î∫o
 = 0; \

207 
öfo
.
si_code
 = 
sicode
; \

208 
öfo
.
si_addr
 = (
__u£r
 *)
süddr
; \

209 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

210 =
NOTIFY_STOP
) \

212 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

213 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, &
öfo
); \

214 }

	)

216 
DO_ERROR_INFO
(0, 
SIGFPE
, "dividêîr‹", 
divide_îr‹
, 
FPE_INTDIV
, 
ªgs
->
ù
)

217 
DO_ERROR
(4, 
SIGSEGV
, "ovîÊow", 
ovîÊow
)

218 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

219 
DO_ERROR_INFO
(6, 
SIGILL
, "övÆid opcode", 
övÆid_›
, 
ILL_ILLOPN
, 
ªgs
->
ù
)

220 
DO_ERROR
(9, 
SIGFPE
, "c›ro˚ss‹ segmíàovîrun", 
c›ro˚ss‹_£gmít_ovîrun
)

221 
DO_ERROR
(10, 
SIGSEGV
, "övÆid TSS", 
övÆid_TSS
)

222 
DO_ERROR
(11, 
SIGBUS
, "£gmíànŸÖª£¡", 
£gmít_nŸ_¥e£¡
)

223 #ifde‡
CONFIG_X86_32


224 
DO_ERROR
(12, 
SIGBUS
, "°ack segmít", 
°ack_£gmít
)

226 
DO_ERROR_INFO
(17, 
SIGBUS
, "Æignmíàcheck", 
Æignmít_check
, 
BUS_ADRALN
, 0)

228 #ifde‡
CONFIG_X86_64


230 
dŸø∂ökage
 
	$do_°ack_£gmít
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

232 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "°ack segmít", 
ªgs
, 
îr‹_code
,

233 12, 
SIGBUS
Ë=
NOTIFY_STOP
)

235 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

236 
	`do_å≠
(12, 
SIGBUS
, "°ack segmít", 
ªgs
, 
îr‹_code
, 
NULL
);

237 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

238 
	}
}

240 
dŸø∂ökage
 
	$do_doubÀ_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

242 c⁄° 
°r
[] = "double fault";

243 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

246 
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 8, 
SIGSEGV
);

248 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

249 
tsk
->
thªad
.
å≠_no
 = 8;

256 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

257 
	}
}

260 
dŸø∂ökage
 
__k¥obes


261 
	$do_gíîÆ_¥Ÿe˘i⁄
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

263 
èsk_°ru˘
 *
tsk
;

265 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

267 #ifde‡
CONFIG_X86_32


268 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

269 
gp_ö_vm86
;

272 
tsk
 = 
cuºít
;

273 i‡(!
	`u£r_mode
(
ªgs
))

274 
gp_ö_kî√l
;

276 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

277 
tsk
->
thªad
.
å≠_no
 = 13;

279 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
) &&

280 
	`¥ötk_øãlimô
()) {

281 
	`¥ötk
(
KERN_INFO


283 
tsk
->
comm
, 
	`èsk_pid_ƒ
(tsk),

284 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

285 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

286 
	`¥ötk
("\n");

289 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

292 #ifde‡
CONFIG_X86_32


293 
gp_ö_vm86
:

294 
	`loˇl_úq_íabÀ
();

295 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
);

299 
gp_ö_kî√l
:

300 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

303 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

304 
tsk
->
thªad
.
å≠_no
 = 13;

305 i‡(
	`nŸify_dõ
(
DIE_GPF
, "gíîÆÖrŸe˘i⁄ fau…", 
ªgs
,

306 
îr‹_code
, 13, 
SIGSEGV
Ë=
NOTIFY_STOP
)

308 
	`dõ
("gíîÆÖrŸe˘i⁄ fau…", 
ªgs
, 
îr‹_code
);

309 
	}
}

311 
nŸø˚
 
__k¥obes
 

312 
	$mem_∑rôy_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

314 
	`¥ötk
(
KERN_EMERG


316 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

318 
	`¥ötk
(
KERN_EMERG


321 #i‡
	`deföed
(
CONFIG_EDAC
)

322 i‡(
	`edac_h™dÀr_£t
()) {

323 
	`edac_©omic_as£π_îr‹
();

328 i‡(
∑nic_⁄_uƒecovîed_nmi
)

329 
	`∑nic
("NMI: Not continuing");

331 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

334 
ªas⁄
 = (reason & 0xf) | 4;

335 
	`outb
(
ªas⁄
, 0x61);

336 
	}
}

338 
nŸø˚
 
__k¥obes
 

339 
	$io_check_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

341 
i
;

343 
	`¥ötk
(
KERN_EMERG
 "NMI: IOCKÉrror (debug interrupt?)\n");

344 
	`show_ªgi°îs
(
ªgs
);

346 i‡(
∑nic_⁄_io_nmi
)

347 
	`∑nic
("NMI IOCKÉrror: Not continuing");

350 
ªas⁄
 = (reason & 0xf) | 8;

351 
	`outb
(
ªas⁄
, 0x61);

353 
i
 = 2000;

354 --
i
)

355 
	`udñay
(1000);

357 
ªas⁄
 &= ~8;

358 
	`outb
(
ªas⁄
, 0x61);

359 
	}
}

361 
nŸø˚
 
__k¥obes
 

362 
	$unknown_nmi_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

364 i‡(
	`nŸify_dõ
(
DIE_NMIUNKNOWN
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
) ==

365 
NOTIFY_STOP
)

367 #ifde‡
CONFIG_MCA


372 i‡(
MCA_bus
) {

373 
	`mˇ_h™dÀ_nmi
();

377 
	`¥ötk
(
KERN_EMERG


379 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

381 
	`¥ötk
(
KERN_EMERG
 "Do you haveá strangeÖower saving modeÉnabled?\n");

382 i‡(
∑nic_⁄_uƒecovîed_nmi
)

383 
	`∑nic
("NMI: Not continuing");

385 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

386 
	}
}

388 
nŸø˚
 
__k¥obes
 
	$deÁu…_do_nmi
(
±_ªgs
 *
ªgs
)

390 
ªas⁄
 = 0;

391 
˝u
;

393 
˝u
 = 
	`smp_¥o˚ss‹_id
();

396 i‡(!
˝u
)

397 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

399 i‡(!(
ªas⁄
 & 0xc0)) {

400 i‡(
	`nŸify_dõ
(
DIE_NMI_IPI
, "nmi_ùi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

401 =
NOTIFY_STOP
)

403 #ifde‡
CONFIG_X86_LOCAL_APIC


408 i‡(
	`nmi_w©chdog_tick
(
ªgs
, 
ªas⁄
))

410 i‡(!
	`do_nmi_ˇŒback
(
ªgs
, 
˝u
))

411 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

413 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

418 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

422 i‡(
ªas⁄
 & 0x80)

423 
	`mem_∑rôy_îr‹
(
ªas⁄
, 
ªgs
);

424 i‡(
ªas⁄
 & 0x40)

425 
	`io_check_îr‹
(
ªas⁄
, 
ªgs
);

426 #ifde‡
CONFIG_X86_32


431 
	`ªas£π_nmi
();

433 
	}
}

435 
dŸø∂ökage
 
nŸø˚
 
__k¥obes
 

436 
	$do_nmi
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

438 
	`nmi_íãr
();

440 
	`öc_úq_°©
(
__nmi_cou¡
);

442 i‡(!
ign‹e_nmis
)

443 
	`deÁu…_do_nmi
(
ªgs
);

445 
	`nmi_exô
();

446 
	}
}

448 
	$°›_nmi
()

450 
	`a˝i_nmi_dißbÀ
();

451 
ign‹e_nmis
++;

452 
	}
}

454 
	$ª°¨t_nmi
()

456 
ign‹e_nmis
--;

457 
	`a˝i_nmi_íabÀ
();

458 
	}
}

461 
dŸø∂ökage
 
__k¥obes
 
	$do_öt3
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

463 #ifde‡
CONFIG_KPROBES


464 i‡(
	`nŸify_dõ
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

465 =
NOTIFY_STOP
)

468 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

469 =
NOTIFY_STOP
)

473 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

474 
	`do_å≠
(3, 
SIGTRAP
, "öt3", 
ªgs
, 
îr‹_code
, 
NULL
);

475 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

476 
	}
}

478 #ifde‡
CONFIG_X86_64


484 
asmlökage
 
__k¥obes
 
±_ªgs
 *
	$sync_ªgs
(
±_ªgs
 *
îegs
)

486 
±_ªgs
 *
ªgs
 = 
îegs
;

488 i‡(
îegs
 =(
±_ªgs
 *Îªgs->
•
)

491 i‡(
	`u£r_mode
(
îegs
))

492 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

497 i‡(
îegs
->
Êags
 & 
X86_EFLAGS_IF
)

498 
ªgs
 = (
±_ªgs
 *)(
îegs
->
•
 -= (pt_regs));

499 i‡(
îegs
 !
ªgs
)

500 *
ªgs
 = *
îegs
;

501  
ªgs
;

502 
	}
}

529 
dŸø∂ökage
 
__k¥obes
 
	$do_debug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

531 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

532 
dr6
;

533 
si_code
;

535 
	`gë_debugªg
(
dr6
, 6);

538 
dr6
 &~
DR6_RESERVED
;

541 i‡((
dr6
 & 
DR_STEP
Ë&& 
	`kmemcheck_å≠
(
ªgs
))

545 
	`£t_debugªg
(0, 6);

549 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUGCTLMSR
);

550 
tsk
->
thªad
.
debug˘lm§
 = 0;

553 
tsk
->
thªad
.
debugªg6
 = 
dr6
;

555 i‡(
	`nŸify_dõ
(
DIE_DEBUG
, "debug", 
ªgs
, 
	`PTR_ERR
(&
dr6
), 
îr‹_code
,

556 
SIGTRAP
Ë=
NOTIFY_STOP
)

560 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

562 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

563 
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

564 
îr‹_code
, 1);

575 i‡((
dr6
 & 
DR_STEP
Ë&& !
	`u£r_mode
(
ªgs
)) {

576 
tsk
->
thªad
.
debugªg6
 &~
DR_STEP
;

577 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_SINGLESTEP
);

578 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

580 
si_code
 = 
	`gë_si_code
(
tsk
->
thªad
.
debugªg6
);

581 i‡(
tsk
->
thªad
.
debugªg6
 & (
DR_STEP
 | 
DR_TRAP_BITS
))

582 
	`£nd_sigå≠
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
);

583 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

586 
	}
}

588 #ifde‡
CONFIG_X86_64


589 
	$kî√l_m©h_îr‹
(
±_ªgs
 *
ªgs
, c⁄° *
°r
, 
å≠ƒ
)

591 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

594 
	`nŸify_dõ
(
DIE_GPF
, 
°r
, 
ªgs
, 0, 
å≠ƒ
, 
SIGFPE
);

596 
cuºít
->
thªad
.
å≠_no
 = 
å≠ƒ
;

597 
	`dõ
(
°r
, 
ªgs
, 0);

599 
	}
}

607 
	$m©h_îr‹
(
__u£r
 *
ù
)

609 
èsk_°ru˘
 *
èsk
;

610 
sigöfo_t
 
öfo
;

611 
cwd
, 
swd
, 
îr
;

616 
èsk
 = 
cuºít
;

617 
	`ßve_öô_Âu
(
èsk
);

618 
èsk
->
thªad
.
å≠_no
 = 16;

619 
èsk
->
thªad
.
îr‹_code
 = 0;

620 
öfo
.
si_signo
 = 
SIGFPE
;

621 
öfo
.
si_î∫o
 = 0;

622 
öfo
.
si_addr
 = 
ù
;

633 
cwd
 = 
	`gë_Âu_cwd
(
èsk
);

634 
swd
 = 
	`gë_Âu_swd
(
èsk
);

636 
îr
 = 
swd
 & ~
cwd
;

638 i‡(
îr
 & 0x001) {

644 
öfo
.
si_code
 = 
FPE_FLTINV
;

645 } i‡(
îr
 & 0x004) {

646 
öfo
.
si_code
 = 
FPE_FLTDIV
;

647 } i‡(
îr
 & 0x008) {

648 
öfo
.
si_code
 = 
FPE_FLTOVF
;

649 } i‡(
îr
 & 0x012) {

650 
öfo
.
si_code
 = 
FPE_FLTUND
;

651 } i‡(
îr
 & 0x020) {

652 
öfo
.
si_code
 = 
FPE_FLTRES
;

660 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

661 
	}
}

663 
dŸø∂ökage
 
	$do_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

665 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

667 #ifde‡
CONFIG_X86_32


668 
ign‹e_Âu_úq
 = 1;

670 i‡(!
	`u£r_mode
(
ªgs
) &&

671 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel x87 mathÉrror", 16))

675 
	`m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

676 
	}
}

678 
	$simd_m©h_îr‹
(
__u£r
 *
ù
)

680 
èsk_°ru˘
 *
èsk
;

681 
sigöfo_t
 
öfo
;

682 
mxc§
;

687 
èsk
 = 
cuºít
;

688 
	`ßve_öô_Âu
(
èsk
);

689 
èsk
->
thªad
.
å≠_no
 = 19;

690 
èsk
->
thªad
.
îr‹_code
 = 0;

691 
öfo
.
si_signo
 = 
SIGFPE
;

692 
öfo
.
si_î∫o
 = 0;

693 
öfo
.
si_code
 = 
__SI_FAULT
;

694 
öfo
.
si_addr
 = 
ù
;

701 
mxc§
 = 
	`gë_Âu_mxc§
(
èsk
);

702 ~((
mxc§
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

707 
öfo
.
si_code
 = 
FPE_FLTINV
;

711 
öfo
.
si_code
 = 
FPE_FLTUND
;

714 
öfo
.
si_code
 = 
FPE_FLTDIV
;

717 
öfo
.
si_code
 = 
FPE_FLTOVF
;

720 
öfo
.
si_code
 = 
FPE_FLTRES
;

723 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

724 
	}
}

726 
dŸø∂ökage
 

727 
	$do_simd_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

729 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

731 #ifde‡
CONFIG_X86_32


732 i‡(
˝u_has_xmm
) {

734 
ign‹e_Âu_úq
 = 1;

735 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

742 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

743 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *)
ªgs
, 
îr‹_code
);

746 
cuºít
->
thªad
.
å≠_no
 = 19;

747 
cuºít
->
thªad
.
îr‹_code
 =Érror_code;

748 
	`dõ_if_kî√l
("ˇchêÊush díõd", 
ªgs
, 
îr‹_code
);

749 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

751 i‡(!
	`u£r_mode
(
ªgs
) &&

752 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel simd mathÉrror", 19))

754 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

756 
	}
}

758 
dŸø∂ökage
 

759 
	$do_•urious_öãºu±_bug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

761 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

764 
	`¥ötk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

766 
	}
}

768 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thîmÆ_öãºu±
()

770 
	}
}

772 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thªshﬁd_öãºu±
()

774 
	}
}

780 
	$__m©h_°©e_ª°‹e
()

782 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

783 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

788 i‡(
	`u∆ikñy
(
	`ª°‹e_Âu_checkög
(
tsk
))) {

789 
	`°ts
();

790 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

794 
thªad
->
°©us
 |
TS_USEDFPU
;

795 
tsk
->
Âu_cou¡î
++;

796 
	}
}

808 
asmlökage
 
	$m©h_°©e_ª°‹e
()

810 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

811 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

813 i‡(!
	`tsk_u£d_m©h
(
tsk
)) {

814 
	`loˇl_úq_íabÀ
();

818 i‡(
	`öô_Âu
(
tsk
)) {

822 
	`do_group_exô
(
SIGKILL
);

825 
	`loˇl_úq_dißbÀ
();

828 
	`˛ts
();

830 
	`__m©h_°©e_ª°‹e
();

831 
	}
}

832 
EXPORT_SYMBOL_GPL
(
m©h_°©e_ª°‹e
);

834 #i‚de‡
CONFIG_MATH_EMULATION


835 
	$m©h_emuœã
(
m©h_emu_öfo
 *
öfo
)

837 
	`¥ötk
(
KERN_EMERG


839 
	`¥ötk
(
KERN_EMERG
 "kûlög %s.\n", 
cuºít
->
comm
);

840 
	`f‹˚_sig
(
SIGFPE
, 
cuºít
);

841 
	`scheduÀ
();

842 
	}
}

845 
dŸø∂ökage
 
__k¥obes


846 
	$do_devi˚_nŸ_avaûabÀ
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

848 #ifde‡
CONFIG_X86_32


849 i‡(
	`ªad_¸0
(Ë& 
X86_CR0_EM
) {

850 
m©h_emu_öfo
 
öfo
 = { };

852 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

854 
öfo
.
ªgs
 =Ñegs;

855 
	`m©h_emuœã
(&
öfo
);

857 
	`m©h_°©e_ª°‹e
();

858 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

861 
	`m©h_°©e_ª°‹e
();

863 
	}
}

865 #ifde‡
CONFIG_X86_32


866 
dŸø∂ökage
 
	$do_úë_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

868 
sigöfo_t
 
öfo
;

869 
	`loˇl_úq_íabÀ
();

871 
öfo
.
si_signo
 = 
SIGILL
;

872 
öfo
.
si_î∫o
 = 0;

873 
öfo
.
si_code
 = 
ILL_BADSTK
;

874 
öfo
.
si_addr
 = 
NULL
;

875 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "iretÉxception",

876 
ªgs
, 
îr‹_code
, 32, 
SIGILL
Ë=
NOTIFY_STOP
)

878 
	`do_å≠
(32, 
SIGILL
, "úëÉx˚±i⁄", 
ªgs
, 
îr‹_code
, &
öfo
);

879 
	}
}

882 
__öô
 
	$å≠_öô
()

884 
i
;

886 #ifde‡
CONFIG_EISA


887 
__iomem
 *
p
 = 
	`óæy_i‹em≠
(0x0FFFD9, 4);

889 i‡(
	`ªadl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

890 
EISA_bus
 = 1;

891 
	`óæy_iounm≠
(
p
, 4);

894 
	`£t_öå_g©e
(0, &
divide_îr‹
);

895 
	`£t_öå_g©e_i°
(1, &
debug
, 
DEBUG_STACK
);

896 
	`£t_öå_g©e_i°
(2, &
nmi
, 
NMI_STACK
);

898 
	`£t_sy°em_öå_g©e_i°
(3, &
öt3
, 
DEBUG_STACK
);

900 
	`£t_sy°em_öå_g©e
(4, &
ovîÊow
);

901 
	`£t_öå_g©e
(5, &
bounds
);

902 
	`£t_öå_g©e
(6, &
övÆid_›
);

903 
	`£t_öå_g©e
(7, &
devi˚_nŸ_avaûabÀ
);

904 #ifde‡
CONFIG_X86_32


905 
	`£t_èsk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

907 
	`£t_öå_g©e_i°
(8, &
doubÀ_Áu…
, 
DOUBLEFAULT_STACK
);

909 
	`£t_öå_g©e
(9, &
c›ro˚ss‹_£gmít_ovîrun
);

910 
	`£t_öå_g©e
(10, &
övÆid_TSS
);

911 
	`£t_öå_g©e
(11, &
£gmít_nŸ_¥e£¡
);

912 
	`£t_öå_g©e_i°
(12, &
°ack_£gmít
, 
STACKFAULT_STACK
);

913 
	`£t_öå_g©e
(13, &
gíîÆ_¥Ÿe˘i⁄
);

914 
	`£t_öå_g©e
(14, &
∑ge_Áu…
);

915 
	`£t_öå_g©e
(15, &
•urious_öãºu±_bug
);

916 
	`£t_öå_g©e
(16, &
c›ro˚ss‹_îr‹
);

917 
	`£t_öå_g©e
(17, &
Æignmít_check
);

918 #ifde‡
CONFIG_X86_MCE


919 
	`£t_öå_g©e_i°
(18, &
machöe_check
, 
MCE_STACK
);

921 
	`£t_öå_g©e
(19, &
simd_c›ro˚ss‹_îr‹
);

924 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

925 
	`£t_bô
(
i
, 
u£d_ve˘‹s
);

927 #ifde‡
CONFIG_IA32_EMULATION


928 
	`£t_sy°em_öå_g©e
(
IA32_SYSCALL_VECTOR
, 
ü32_sysˇŒ
);

929 
	`£t_bô
(
IA32_SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

932 #ifde‡
CONFIG_X86_32


933 i‡(
˝u_has_fx§
) {

934 
	`¥ötk
(
KERN_INFO
 "Enabling fast FPU saveándÑestore... ");

935 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

936 
	`¥ötk
("done.\n");

938 i‡(
˝u_has_xmm
) {

939 
	`¥ötk
(
KERN_INFO


941 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

942 
	`¥ötk
("done.\n");

945 
	`£t_sy°em_å≠_g©e
(
SYSCALL_VECTOR
, &
sy°em_ˇŒ
);

946 
	`£t_bô
(
SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

952 
	`˝u_öô
();

954 
x86_öô
.
úqs
.
	`å≠_öô
();

955 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/timî.h
>

6 
	~<löux/a˝i_pmtmr.h
>

7 
	~<löux/˝u‰eq.h
>

8 
	~<löux/dmi.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/˛ocksour˚.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/timex.h
>

14 
	~<asm/h≥t.h
>

15 
	~<asm/timî.h
>

16 
	~<asm/vgtod.h
>

17 
	~<asm/time.h
>

18 
	~<asm/dñay.h
>

19 
	~<asm/hy≥rvis‹.h
>

20 
	~<asm/nmi.h
>

21 
	~<asm/x86_öô.h
>

23 
__ªad_mo°ly
 
	g˝u_khz
;

24 
EXPORT_SYMBOL
(
˝u_khz
);

26 
__ªad_mo°ly
 
	gtsc_khz
;

27 
EXPORT_SYMBOL
(
tsc_khz
);

32 
__ªad_mo°ly
 
	gtsc_un°abÀ
;

37 
__ªad_mo°ly
 
	gtsc_dißbÀd
 = -1;

39 
	gtsc_˛ocksour˚_ªlübÀ
;

43 
u64
 
	$«tive_sched_˛ock
()

45 
u64
 
this_off£t
;

55 i‡(
	`u∆ikñy
(
tsc_dißbÀd
)) {

57  (
jiffõs_64
 - 
INITIAL_JIFFIES
Ë* (1000000000 / 
HZ
);

61 
	`rdts˛l
(
this_off£t
);

64  
	`__cy˛es_2_ns
(
this_off£t
);

65 
	}
}

69 #ifde‡
CONFIG_PARAVIRT


70 
	$sched_˛ock
()

72  
	`∑øvút_sched_˛ock
();

73 
	}
}

76 
	$sched_˛ock
(Ë
	`__©åibuã__
((
	`Æüs
("native_sched_clock")));

79 
	$check_tsc_un°abÀ
()

81  
tsc_un°abÀ
;

82 
	}
}

83 
EXPORT_SYMBOL_GPL
(
check_tsc_un°abÀ
);

85 #ifde‡
CONFIG_X86_TSC


86 
__öô
 
	$nŸsc_£tup
(*
°r
)

88 
	`¥ötk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

90 
tsc_dißbÀd
 = 1;

92 
	}
}

98 
__öô
 
	$nŸsc_£tup
(*
°r
)

100 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_TSC
);

102 
	}
}

105 
__£tup
("nŸsc", 
nŸsc_£tup
);

107 
__öô
 
	$tsc_£tup
(*
°r
)

109 i‡(!
	`°rcmp
(
°r
, "reliable"))

110 
tsc_˛ocksour˚_ªlübÀ
 = 1;

112 
	}
}

114 
__£tup
("tsc=", 
tsc_£tup
);

116 
	#MAX_RETRIES
 5

	)

117 
	#SMI_TRESHOLD
 50000

	)

122 
u64
 
	$tsc_ªad_ªfs
(
u64
 *
p
, 
h≥t
)

124 
u64
 
t1
, 
t2
;

125 
i
;

127 
i
 = 0; i < 
MAX_RETRIES
; i++) {

128 
t1
 = 
	`gë_cy˛es
();

129 i‡(
h≥t
)

130 *
p
 = 
	`h≥t_ªadl
(
HPET_COUNTER
) & 0xFFFFFFFF;

132 *
p
 = 
	`a˝i_pm_ªad_óæy
();

133 
t2
 = 
	`gë_cy˛es
();

134 i‡((
t2
 - 
t1
Ë< 
SMI_TRESHOLD
)

135  
t2
;

137  
ULLONG_MAX
;

138 
	}
}

143 
	$ˇlc_h≥t_ªf
(
u64
 
dñètsc
, u64 
h≥t1
, u64 
h≥t2
)

145 
u64
 
tmp
;

147 i‡(
h≥t2
 < 
h≥t1
)

148 
h≥t2
 += 0x100000000ULL;

149 
h≥t2
 -
h≥t1
;

150 
tmp
 = ((
u64
)
h≥t2
 * 
	`h≥t_ªadl
(
HPET_PERIOD
));

151 
	`do_div
(
tmp
, 1000000);

152 
	`do_div
(
dñètsc
, 
tmp
);

154  (Ë
dñètsc
;

155 
	}
}

160 
	$ˇlc_pmtimî_ªf
(
u64
 
dñètsc
, u64 
pm1
, u64 
pm2
)

162 
u64
 
tmp
;

164 i‡(!
pm1
 && !
pm2
)

165  
ULONG_MAX
;

167 i‡(
pm2
 < 
pm1
)

168 
pm2
 +(
u64
)
ACPI_PM_OVRRUN
;

169 
pm2
 -
pm1
;

170 
tmp
 = 
pm2
 * 1000000000LL;

171 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

172 
	`do_div
(
dñètsc
, 
tmp
);

174  (Ë
dñètsc
;

175 
	}
}

177 
	#CAL_MS
 10

	)

178 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

179 
	#CAL_PIT_LOOPS
 1000

	)

181 
	#CAL2_MS
 50

	)

182 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

183 
	#CAL2_PIT_LOOPS
 5000

	)

193 
	$pô_ˇlibøã_tsc
(
u32
 
œtch
, 
ms
, 
lo›mö
)

195 
u64
 
tsc
, 
t1
, 
t2
, 
dñè
;

196 
tscmö
, 
tscmax
;

197 
pô˙t
;

200 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

207 
	`outb
(0xb0, 0x43);

208 
	`outb
(
œtch
 & 0xff, 0x42);

209 
	`outb
(
œtch
 >> 8, 0x42);

211 
tsc
 = 
t1
 = 
t2
 = 
	`gë_cy˛es
();

213 
pô˙t
 = 0;

214 
tscmax
 = 0;

215 
tscmö
 = 
ULONG_MAX
;

216 (
	`öb
(0x61) & 0x20) == 0) {

217 
t2
 = 
	`gë_cy˛es
();

218 
dñè
 = 
t2
 - 
tsc
;

219 
tsc
 = 
t2
;

220 i‡((Ë
dñè
 < 
tscmö
)

221 
tscmö
 = (Ë
dñè
;

222 i‡((Ë
dñè
 > 
tscmax
)

223 
tscmax
 = (Ë
dñè
;

224 
pô˙t
++;

236 i‡(
pô˙t
 < 
lo›mö
 || 
tscmax
 > 10 * 
tscmö
)

237  
ULONG_MAX
;

240 
dñè
 = 
t2
 - 
t1
;

241 
	`do_div
(
dñè
, 
ms
);

242  
dñè
;

243 
	}
}

280 
ölöe
 
	$pô_vîify_msb
(
vÆ
)

283 
	`öb
(0x42);

284  
	`öb
(0x42Ë=
vÆ
;

285 
	}
}

287 
ölöe
 
	$pô_ex≥˘_msb
(
vÆ
, 
u64
 *
ts˝
, *
dñèp
)

289 
cou¡
;

290 
u64
 
tsc
 = 0;

292 
cou¡
 = 0; count < 50000; count++) {

293 i‡(!
	`pô_vîify_msb
(
vÆ
))

295 
tsc
 = 
	`gë_cy˛es
();

297 *
dñèp
 = 
	`gë_cy˛es
(Ë- 
tsc
;

298 *
ts˝
 = 
tsc
;

304  
cou¡
 > 5;

305 
	}
}

313 
	#MAX_QUICK_PIT_MS
 25

	)

314 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

316 
	$quick_pô_ˇlibøã
()

318 
i
;

319 
u64
 
tsc
, 
dñè
;

320 
d1
, 
d2
;

323 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

334 
	`outb
(0xb0, 0x43);

337 
	`outb
(0xff, 0x42);

338 
	`outb
(0xff, 0x42);

346 
	`pô_vîify_msb
(0);

348 i‡(
	`pô_ex≥˘_msb
(0xff, &
tsc
, &
d1
)) {

349 
i
 = 1; i <
MAX_QUICK_PIT_ITERATIONS
; i++) {

350 i‡(!
	`pô_ex≥˘_msb
(0xff-
i
, &
dñè
, &
d2
))

356 
dñè
 -
tsc
;

357 i‡(
d1
+
d2
 >
dñè
 >> 11)

367 i‡(!
	`pô_vîify_msb
(0x„ - 
i
))

369 
suc˚ss
;

372 
	`¥ötk
("Fast TSC calibration failed\n");

375 
suc˚ss
:

391 
dñè
 +()(
d2
 - 
d1
)/2;

392 
dñè
 *
PIT_TICK_RATE
;

393 
	`do_div
(
dñè
, 
i
*256*1000);

394 
	`¥ötk
("Fast TSC calibration using PIT\n");

395  
dñè
;

396 
	}
}

401 
	$«tive_ˇlibøã_tsc
()

403 
u64
 
tsc1
, 
tsc2
, 
dñè
, 
ªf1
, 
ªf2
;

404 
tsc_pô_mö
 = 
ULONG_MAX
, 
tsc_ªf_mö
 = ULONG_MAX;

405 
Êags
, 
œtch
, 
ms
, 
Á°_ˇlibøã
;

406 
h≥t
 = 
	`is_h≥t_íabÀd
(), 
i
, 
lo›mö
;

408 
	`loˇl_úq_ßve
(
Êags
);

409 
Á°_ˇlibøã
 = 
	`quick_pô_ˇlibøã
();

410 
	`loˇl_úq_ª°‹e
(
Êags
);

411 i‡(
Á°_ˇlibøã
)

412  
Á°_ˇlibøã
;

440 
œtch
 = 
CAL_LATCH
;

441 
ms
 = 
CAL_MS
;

442 
lo›mö
 = 
CAL_PIT_LOOPS
;

444 
i
 = 0; i < 3; i++) {

445 
tsc_pô_khz
;

453 
	`loˇl_úq_ßve
(
Êags
);

454 
tsc1
 = 
	`tsc_ªad_ªfs
(&
ªf1
, 
h≥t
);

455 
tsc_pô_khz
 = 
	`pô_ˇlibøã_tsc
(
œtch
, 
ms
, 
lo›mö
);

456 
tsc2
 = 
	`tsc_ªad_ªfs
(&
ªf2
, 
h≥t
);

457 
	`loˇl_úq_ª°‹e
(
Êags
);

460 
tsc_pô_mö
 = 
	`mö
—sc_pô_mö, 
tsc_pô_khz
);

463 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
)

467 i‡(
tsc1
 =
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

470 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

471 i‡(
h≥t
)

472 
tsc2
 = 
	`ˇlc_h≥t_ªf
—sc2, 
ªf1
, 
ªf2
);

474 
tsc2
 = 
	`ˇlc_pmtimî_ªf
—sc2, 
ªf1
, 
ªf2
);

476 
tsc_ªf_mö
 = 
	`mö
—sc_ªf_mö, (Ë
tsc2
);

479 
dñè
 = ((
u64
Ë
tsc_pô_mö
) * 100;

480 
	`do_div
(
dñè
, 
tsc_ªf_mö
);

488 i‡(
dñè
 >= 90 && delta <= 110) {

489 
	`¥ötk
(
KERN_INFO


491 
h≥t
 ? "HPET" : "PMTIMER", 
i
 + 1);

492  
tsc_ªf_mö
;

501 i‡(
i
 =1 && 
tsc_pô_mö
 =
ULONG_MAX
) {

502 
œtch
 = 
CAL2_LATCH
;

503 
ms
 = 
CAL2_MS
;

504 
lo›mö
 = 
CAL2_PIT_LOOPS
;

511 i‡(
tsc_pô_mö
 =
ULONG_MAX
) {

513 
	`¥ötk
(
KERN_WARNING
 "TSC: UnableÅo calibrateágainst PIT\n");

516 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

517 
	`¥ötk
("TSC: NoÑeference (HPET/PMTIMER)ávailable\n");

522 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

523 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

529 
	`¥ötk
(
KERN_INFO
 "TSC: using %sÑeference calibration\n",

530 
h≥t
 ? "HPET" : "PMTIMER");

532  
tsc_ªf_mö
;

536 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

537 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

538  
tsc_pô_mö
;

542 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

543 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

545  
tsc_pô_mö
;

553 
	`¥ötk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

554 
h≥t
 ? "HPET" : "PMTIMER", 
tsc_pô_mö
, 
tsc_ªf_mö
);

555 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

556  
tsc_pô_mö
;

557 
	}
}

559 
	$ªˇlibøã_˝u_khz
()

561 #i‚de‡
CONFIG_SMP


562 
˝u_khz_ﬁd
 = 
˝u_khz
;

564 i‡(
˝u_has_tsc
) {

565 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

566 
˝u_khz
 = 
tsc_khz
;

567 
	`˝u_d©a
(0).
lo›s_≥r_jiffy
 =

568 
	`˝u‰eq_sˇÀ
(
	`˝u_d©a
(0).
lo›s_≥r_jiffy
,

569 
˝u_khz_ﬁd
, 
˝u_khz
);

572  -
ENODEV
;

574  -
ENODEV
;

576 
	}
}

578 
EXPORT_SYMBOL
(
ªˇlibøã_˝u_khz
);

603 
DEFINE_PER_CPU
(, 
cyc2ns
);

604 
DEFINE_PER_CPU
(, 
cyc2ns_off£t
);

606 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
)

608 
tsc_now
, 
ns_now
, *
off£t
;

609 
Êags
, *
sˇÀ
;

611 
	`loˇl_úq_ßve
(
Êags
);

612 
	`sched_˛ock_idÀ_¶ìp_evít
();

614 
sˇÀ
 = &
	`≥r_˝u
(
cyc2ns
, 
˝u
);

615 
off£t
 = &
	`≥r_˝u
(
cyc2ns_off£t
, 
˝u
);

617 
	`rdts˛l
(
tsc_now
);

618 
ns_now
 = 
	`__cy˛es_2_ns
(
tsc_now
);

620 i‡(
˝u_khz
) {

621 *
sˇÀ
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

622 *
off£t
 = 
ns_now
 - (
tsc_now
 * *
sˇÀ
 >> 
CYC2NS_SCALE_FACTOR
);

625 
	`sched_˛ock_idÀ_wakeup_evít
(0);

626 
	`loˇl_úq_ª°‹e
(
Êags
);

627 
	}
}

629 #ifde‡
CONFIG_CPU_FREQ


642 
	gªf_‰eq
;

643 
	glo›s_≥r_jiffy_ªf
;

644 
	gtsc_khz_ªf
;

646 
	$time_˝u‰eq_nŸifõr
(
nŸifõr_block
 *
nb
, 
vÆ
,

647 *
d©a
)

649 
˝u‰eq_‰eqs
 *
‰eq
 = 
d©a
;

650 *
Õj
;

652 i‡(
	`˝u_has
(&
	`˝u_d©a
(
‰eq
->
˝u
), 
X86_FEATURE_CONSTANT_TSC
))

655 
Õj
 = &
boŸ_˝u_d©a
.
lo›s_≥r_jiffy
;

656 #ifde‡
CONFIG_SMP


657 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

658 
Õj
 = &
	`˝u_d©a
(
‰eq
->
˝u
).
lo›s_≥r_jiffy
;

661 i‡(!
ªf_‰eq
) {

662 
ªf_‰eq
 = 
‰eq
->
ﬁd
;

663 
lo›s_≥r_jiffy_ªf
 = *
Õj
;

664 
tsc_khz_ªf
 = 
tsc_khz
;

666 i‡((
vÆ
 =
CPUFREQ_PRECHANGE
 && 
‰eq
->
ﬁd
 < fªq->
√w
) ||

667 (
vÆ
 =
CPUFREQ_POSTCHANGE
 && 
‰eq
->
ﬁd
 > fªq->
√w
) ||

668 (
vÆ
 =
CPUFREQ_RESUMECHANGE
)) {

669 *
Õj
 = 
	`˝u‰eq_sˇÀ
(
lo›s_≥r_jiffy_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

671 
tsc_khz
 = 
	`˝u‰eq_sˇÀ
(
tsc_khz_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

672 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

673 
	`m¨k_tsc_un°abÀ
("cpufreq changes");

676 
	`£t_cyc2ns_sˇÀ
(
tsc_khz
, 
‰eq
->
˝u
);

679 
	}
}

681 
nŸifõr_block
 
	gtime_˝u‰eq_nŸifõr_block
 = {

682 .
nŸifõr_ˇŒ
 = 
time_˝u‰eq_nŸifõr


685 
__öô
 
	$˝u‰eq_tsc
()

687 i‡(!
˝u_has_tsc
)

689 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

691 
	`˝u‰eq_ªgi°î_nŸifõr
(&
time_˝u‰eq_nŸifõr_block
,

692 
CPUFREQ_TRANSITION_NOTIFIER
);

694 
	}
}

696 
c‹e_öôˇŒ
(
˝u‰eq_tsc
);

702 
˛ocksour˚
 
	g˛ocksour˚_tsc
;

716 
cy˛e_t
 
	$ªad_tsc
(
˛ocksour˚
 *
cs
)

718 
cy˛e_t
 
ªt
 = (cy˛e_t)
	`gë_cy˛es
();

720  
ªt
 >
˛ocksour˚_tsc
.
cy˛e_œ°
 ?

721 
ªt
 : 
˛ocksour˚_tsc
.
cy˛e_œ°
;

722 
	}
}

724 #ifde‡
CONFIG_X86_64


725 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_tsc
()

727 
cy˛e_t
 
ªt
;

734 
	`rdtsc_b¨rõr
();

735 
ªt
 = (
cy˛e_t
)
	`vgë_cy˛es
();

736 
	`rdtsc_b¨rõr
();

738  
ªt
 >
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 ?

739 
ªt
 : 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

740 
	}
}

743 
	$ªsume_tsc
(
˛ocksour˚
 *
cs
)

745 
˛ocksour˚_tsc
.
cy˛e_œ°
 = 0;

746 
	}
}

748 
˛ocksour˚
 
	g˛ocksour˚_tsc
 = {

749 .
«me
 = "tsc",

750 .
	gøtög
 = 300,

751 .
	gªad
 = 
ªad_tsc
,

752 .
	gªsume
 = 
ªsume_tsc
,

753 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

754 .
	gshi·
 = 22,

755 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

756 
CLOCK_SOURCE_MUST_VERIFY
,

757 #ifde‡
CONFIG_X86_64


758 .
	gvªad
 = 
vªad_tsc
,

762 
	$m¨k_tsc_un°abÀ
(*
ªas⁄
)

764 i‡(!
tsc_un°abÀ
) {

765 
tsc_un°abÀ
 = 1;

766 
sched_˛ock_°abÀ
 = 0;

767 
	`¥ötk
(
KERN_INFO
 "M¨kög TSC un°abÀ duêtÿ%s\n", 
ªas⁄
);

769 i‡(
˛ocksour˚_tsc
.
mu…
)

770 
	`˛ocksour˚_m¨k_un°abÀ
(&
˛ocksour˚_tsc
);

772 
˛ocksour˚_tsc
.
Êags
 |
CLOCK_SOURCE_UNSTABLE
;

773 
˛ocksour˚_tsc
.
øtög
 = 0;

776 
	}
}

778 
EXPORT_SYMBOL_GPL
(
m¨k_tsc_un°abÀ
);

780 
__öô
 
	$dmi_m¨k_tsc_un°abÀ
(c⁄° 
dmi_sy°em_id
 *
d
)

782 
	`¥ötk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

783 
d
->
idít
);

784 
tsc_un°abÀ
 = 1;

786 
	}
}

789 
dmi_sy°em_id
 
__öôd©a
 
	gbad_tsc_dmi_èbÀ
[] = {

791 .
ˇŒback
 = 
dmi_m¨k_tsc_un°abÀ
,

792 .
	gidít
 = "IBM Thinkpad 380XD",

793 .
	gm©ches
 = {

794 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

795 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

801 
__öô
 
	$check_sy°em_tsc_ªlübÀ
()

803 #ifde‡
CONFIG_MGEODE_LX


805 
	#RTSC_SUSP
 0x100

	)

806 
ªs_low
, 
ªs_high
;

808 
	`rdm§_ß„
(
MSR_GEODE_BUSCONT_CONF0
, &
ªs_low
, &
ªs_high
);

810 i‡(
ªs_low
 & 
RTSC_SUSP
)

811 
tsc_˛ocksour˚_ªlübÀ
 = 1;

813 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

814 
tsc_˛ocksour˚_ªlübÀ
 = 1;

815 
	}
}

821 
__˝uöô
 
	$unsynchr⁄ized_tsc
()

823 i‡(!
˝u_has_tsc
 || 
tsc_un°abÀ
)

826 #ifde‡
CONFIG_SMP


827 i‡(
	`≠ic_is_˛u°îed_box
())

831 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

837 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
) {

839 i‡(
	`num_possibÀ_˝us
() > 1)

840 
tsc_un°abÀ
 = 1;

843  
tsc_un°abÀ
;

844 
	}
}

846 
__öô
 
	$öô_tsc_˛ocksour˚
()

848 
˛ocksour˚_tsc
.
mu…
 = 
	`˛ocksour˚_khz2mu…
(
tsc_khz
,

849 
˛ocksour˚_tsc
.
shi·
);

850 i‡(
tsc_˛ocksour˚_ªlübÀ
)

851 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_MUST_VERIFY
;

853 i‡(
	`check_tsc_un°abÀ
()) {

854 
˛ocksour˚_tsc
.
øtög
 = 0;

855 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_IS_CONTINUOUS
;

857 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_tsc
);

858 
	}
}

860 #ifde‡
CONFIG_X86_64


865 
	#TICK_COUNT
 100000000

	)

866 
__öô
 
	$ˇlibøã_˝u
()

868 
tsc_°¨t
, 
tsc_now
;

869 
i
, 
no_˘r_‰ì
;

870 
ev¡£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

871 
Êags
;

873 
i
 = 0; i < 4; i++)

874 i‡(
	`avaû_to_ª§v_≥rf˘r_nmi_bô
(
i
))

876 
no_˘r_‰ì
 = (
i
 == 4);

877 i‡(
no_˘r_‰ì
) {

878 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMDÖerfctrs busy ... "

880 
i
 = 3;

881 
	`rdm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

882 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

883 
	`rdm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

885 
	`ª£rve_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

886 
	`ª£rve_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

888 
	`loˇl_úq_ßve
(
Êags
);

890 
	`wrm§l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

891 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

892 
	`rdts˛
(
tsc_°¨t
);

894 
	`rdm§l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

895 
tsc_now
 = 
	`gë_cy˛es
();

896 } (
tsc_now
 - 
tsc_°¨t
Ë< 
TICK_COUNT
);

898 
	`loˇl_úq_ª°‹e
(
Êags
);

899 i‡(
no_˘r_‰ì
) {

900 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

901 
	`wrm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

902 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

904 
	`ªÀa£_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

905 
	`ªÀa£_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

908  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_°¨t
);

909 
	}
}

911 
ölöe
 
	$ˇlibøã_˝u
(Ë{  
˝u_khz
; 
	}
}

914 
__öô
 
	$tsc_öô
()

916 
u64
 
Õj
;

917 
˝u
;

919 
x86_öô
.
timîs
.
	`tsc_¥e_öô
();

921 i‡(!
˝u_has_tsc
)

924 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

925 
˝u_khz
 = 
tsc_khz
;

927 i‡(!
tsc_khz
) {

928 
	`m¨k_tsc_un°abÀ
("couldÇot calculate TSC khz");

932 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

933 (
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
))

934 
˝u_khz
 = 
	`ˇlibøã_˝u
();

936 
	`¥ötk
("Detected %lu.%03lu MHzÖrocessor.\n",

937 ()
˝u_khz
 / 1000,

938 ()
˝u_khz
 % 1000);

946 
	`f‹_óch_possibÀ_˝u
(
˝u
)

947 
	`£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
);

949 i‡(
tsc_dißbÀd
 > 0)

953 
tsc_dißbÀd
 = 0;

955 
Õj
 = ((
u64
)
tsc_khz
 * 1000);

956 
	`do_div
(
Õj
, 
HZ
);

957 
Õj_föe
 = 
Õj
;

959 
	`u£_tsc_dñay
();

961 
	`dmi_check_sy°em
(
bad_tsc_dmi_èbÀ
);

963 i‡(
	`unsynchr⁄ized_tsc
())

964 
	`m¨k_tsc_un°abÀ
("TSCs unsynchronized");

966 
	`check_sy°em_tsc_ªlübÀ
();

967 
	`öô_tsc_˛ocksour˚
();

968 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<löux/•ölock.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__˝uöôd©a
 
©omic_t
 
	g°¨t_cou¡
;

29 
__˝uöôd©a
 
©omic_t
 
	g°›_cou¡
;

36 
__˝uöôd©a
 
¨ch_•ölock_t
 
	gsync_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

38 
__˝uöôd©a
 
cy˛es_t
 
	gœ°_tsc
;

39 
__˝uöôd©a
 
cy˛es_t
 
	gmax_w¨p
;

40 
__˝uöôd©a
 
	gƒ_w¨ps
;

45 
__˝uöô
 
	$check_tsc_w¨p
()

47 
cy˛es_t
 
°¨t
, 
now
, 
¥ev
, 
íd
;

48 
i
;

50 
	`rdtsc_b¨rõr
();

51 
°¨t
 = 
	`gë_cy˛es
();

52 
	`rdtsc_b¨rõr
();

56 
íd
 = 
°¨t
 + 
tsc_khz
 * 20ULL;

57 
now
 = 
°¨t
;

59 
i
 = 0; ; i++) {

65 
	`¨ch_•ö_lock
(&
sync_lock
);

66 
¥ev
 = 
œ°_tsc
;

67 
	`rdtsc_b¨rõr
();

68 
now
 = 
	`gë_cy˛es
();

69 
	`rdtsc_b¨rõr
();

70 
œ°_tsc
 = 
now
;

71 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

79 i‡(
	`u∆ikñy
(!(
i
 & 7))) {

80 i‡(
now
 > 
íd
 || 
i
 > 10000000)

82 
	`˝u_ªœx
();

83 
	`touch_nmi_w©chdog
();

89 i‡(
	`u∆ikñy
(
¥ev
 > 
now
)) {

90 
	`¨ch_•ö_lock
(&
sync_lock
);

91 
max_w¨p
 = 
	`max
(max_w¨p, 
¥ev
 - 
now
);

92 
ƒ_w¨ps
++;

93 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

96 
	`WARN
(!(
now
-
°¨t
),

98 
now
-
°¨t
, 
íd
-start);

99 
	}
}

105 
__˝uöô
 
	$check_tsc_sync_sour˚
(
˝u
)

107 
˝us
 = 2;

113 i‡(
	`unsynchr⁄ized_tsc
())

116 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
)) {

117 i‡(
˝u
 =(
ƒ_˝u_ids
-1Ë|| 
sy°em_°©e
 !
SYSTEM_BOOTING
)

118 
	`¥_öfo
(

126 
	`©omic_£t
(&
°›_cou¡
, 0);

131 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
-1)

132 
	`˝u_ªœx
();

136 
	`©omic_öc
(&
°¨t_cou¡
);

138 
	`check_tsc_w¨p
();

140 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
-1)

141 
	`˝u_ªœx
();

143 i‡(
ƒ_w¨ps
) {

144 
	`¥_w¨nög
("TSC synchronization [CPU#%d -> CPU#%d]:\n",

145 
	`smp_¥o˚ss‹_id
(), 
˝u
);

146 
	`¥_w¨nög
("Measured %Ld cycles TSC warp between CPUs, "

147 "tu∫ög of‡TSC clock.\n", 
max_w¨p
);

148 
	`m¨k_tsc_un°abÀ
("check_tsc_sync_source failed");

150 
	`¥_debug
("TSC synchronization [CPU#%d -> CPU#%d]:Öassed\n",

151 
	`smp_¥o˚ss‹_id
(), 
˝u
);

157 
	`©omic_£t
(&
°¨t_cou¡
, 0);

158 
ƒ_w¨ps
 = 0;

159 
max_w¨p
 = 0;

160 
œ°_tsc
 = 0;

165 
	`©omic_öc
(&
°›_cou¡
);

166 
	}
}

171 
__˝uöô
 
	$check_tsc_sync_èrgë
()

173 
˝us
 = 2;

175 i‡(
	`unsynchr⁄ized_tsc
(Ë|| 
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

182 
	`©omic_öc
(&
°¨t_cou¡
);

183 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
)

184 
	`˝u_ªœx
();

186 
	`check_tsc_w¨p
();

191 
	`©omic_öc
(&
°›_cou¡
);

196 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
)

197 
	`˝u_ªœx
();

198 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<löux/öô.h
>

16 
	~<löux/pci_ids.h
>

17 
	~<löux/pci_ªgs.h
>

19 
	~<asm/≠ic.h
>

20 
	~<asm/pci-dúe˘.h
>

21 
	~<asm/io.h
>

22 
	~<asm/∑øvút.h
>

23 
	~<asm/£tup.h
>

25 #i‡
deföed
 
CONFIG_PCI
 && deföed 
CONFIG_PARAVIRT


32 
	$vsmp_ßve_Ê
()

34 
Êags
 = 
	`«tive_ßve_Ê
();

36 i‡(!(
Êags
 & 
X86_EFLAGS_IF
Ë|| (Êag†& 
X86_EFLAGS_AC
))

37 
Êags
 &~
X86_EFLAGS_IF
;

38  
Êags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ßve_Ê
);

42 
	$vsmp_ª°‹e_Ê
(
Êags
)

44 i‡(
Êags
 & 
X86_EFLAGS_IF
)

45 
Êags
 &~
X86_EFLAGS_AC
;

47 
Êags
 |
X86_EFLAGS_AC
;

48 
	`«tive_ª°‹e_Ê
(
Êags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ª°‹e_Ê
);

52 
	$vsmp_úq_dißbÀ
()

54 
Êags
 = 
	`«tive_ßve_Ê
();

56 
	`«tive_ª°‹e_Ê
((
Êags
 & ~
X86_EFLAGS_IF
Ë| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_dißbÀ
);

60 
	$vsmp_úq_íabÀ
()

62 
Êags
 = 
	`«tive_ßve_Ê
();

64 
	`«tive_ª°‹e_Ê
((
Êags
 | 
X86_EFLAGS_IF
Ë& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_íabÀ
);

68 
__öô_‹_moduÀ
 
	$vsmp_∑tch
(
u8
 
ty≥
, 
u16
 
˛obbîs
, *
ibuf
,

69 
addr
, 
Àn
)

71 
ty≥
) {

72 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_íabÀ
):

73 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_dißbÀ
):

74 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ßve_Ê
):

75 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ª°‹e_Ê
):

76  
	`∑øvút_∑tch_deÁu…
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

78  
	`«tive_∑tch
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

81 
	}
}

83 
__öô
 
	$£t_vsmp_pv_›s
()

85 
__iomem
 *
addªss
;

86 
ˇp
, 
˘l
, 
cfg
;

89 
cfg
 = 
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
addªss
 = 
	`óæy_i‹em≠
(
cfg
, 8);

91 
ˇp
 = 
	`ªadl
(
addªss
);

92 
˘l
 = 
	`ªadl
(
addªss
 + 4);

93 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ˇp
, 
˘l
);

95 i‡(
ˇp
 & 
˘l
 & (1 << 4)) {

97 
pv_úq_›s
.
úq_dißbÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_dißbÀ
);

98 
pv_úq_›s
.
úq_íabÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_íabÀ
);

99 
pv_úq_›s
.
ßve_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ßve_Ê
);

100 
pv_úq_›s
.
ª°‹e_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ª°‹e_Ê
);

101 
pv_öô_›s
.
∑tch
 = 
vsmp_∑tch
;

103 
˘l
 &= ~(1 << 4);

104 
	`wrôñ
(
˘l
, 
addªss
 + 4);

105 
˘l
 = 
	`ªadl
(
addªss
 + 4);

106 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: c⁄åﬁ sëÅo:0x%08x\n", 
˘l
);

109 
	`óæy_iounm≠
(
addªss
, 8);

110 
	}
}

112 
__öô
 
	$£t_vsmp_pv_›s
()

114 
	}
}

117 #ifde‡
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__öô
 
	$dëe˘_vsmp_box
()

122 
is_vsmp
 = 0;

124 i‡(!
	`óæy_pci_Ælowed
())

128 i‡(
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 i‡(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__öô
 
	$dëe˘_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__öô
 
	$vsmp_öô
()

154 
	`dëe˘_vsmp_box
();

155 i‡(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_›s
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<löux/time.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/jiffõs.h
>

29 
	~<löux/sys˘l.h
>

30 
	~<löux/˛ocksour˚.h
>

31 
	~<löux/gë˝u.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/smp.h
>

34 
	~<löux/nŸifõr.h
>

36 
	~<asm/vsysˇŒ.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/uni°d.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/î∫o.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gmít.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/t›ﬁogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysˇŒ
(
ƒ
) \

49 
	`__©åibuã__
 ((
unu£d
, 
	`__£˘i⁄__
(".vsysˇŒ_" #ƒ))Ë
nŸø˚


	)

50 
	#__sysˇŒ_˛obbî
 "r11","cx","mem‹y"

	)

58 
__vgë˝u_mode
 
	g__£˘i⁄_vgë˝u_mode
;

60 
vsysˇŒ_gtod_d©a
 
__vsysˇŒ_gtod_d©a
 
	g__£˘i⁄_vsysˇŒ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsys˘l_íabÀd
 = 1,

66 
	$upd©e_vsysˇŒ_tz
()

68 
Êags
;

70 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

72 
vsysˇŒ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

74 
	}
}

76 
	$upd©e_vsysˇŒ
(
time•ec
 *
wÆl_time
, 
˛ocksour˚
 *
˛ock
,

77 
u32
 
mu…
)

79 
Êags
;

81 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

83 
vsysˇŒ_gtod_d©a
.
˛ock
.
vªad
 = clock->vread;

84 
vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 = clock->cycle_last;

85 
vsysˇŒ_gtod_d©a
.
˛ock
.
mask
 = clock->mask;

86 
vsysˇŒ_gtod_d©a
.
˛ock
.
mu…
 = mult;

87 
vsysˇŒ_gtod_d©a
.
˛ock
.
shi·
 = clock->shift;

88 
vsysˇŒ_gtod_d©a
.
wÆl_time_£c
 = 
wÆl_time
->
tv_£c
;

89 
vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
 = 
wÆl_time
->
tv_n£c
;

90 
vsysˇŒ_gtod_d©a
.
wÆl_to_m⁄Ÿ⁄ic
 = wall_to_monotonic;

91 
vsysˇŒ_gtod_d©a
.
wÆl_time_cﬂr£
 = 
	`__cuºít_kî√l_time
();

92 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

93 
	}
}

98 
__Æways_ölöe
 
	$do_gë_tz
(
timez⁄e
 * 
tz
)

100 *
tz
 = 
__vsysˇŒ_gtod_d©a
.
sys_tz
;

101 
	}
}

103 
__Æways_ölöe
 
	$gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

105 
ªt
;

106 
asm
 volatile("syscall"

107 : "˜" (
ªt
)

108 : "0" (
__NR_gëtimeofday
),"D" (
tv
),"S" (
tz
)

109 : 
__sysˇŒ_˛obbî
 );

110  
ªt
;

111 
	}
}

113 
__Æways_ölöe
 
	$time_sysˇŒ
(*
t
)

115 
£cs
;

116 
asm
 volatile("syscall"

117 : "˜" (
£cs
)

118 : "0" (
__NR_time
),"D" (
t
Ë: 
__sysˇŒ_˛obbî
);

119  
£cs
;

120 
	}
}

122 
__Æways_ölöe
 
	$do_vgëtimeofday
(
timevÆ
 * 
tv
)

124 
cy˛e_t
 
now
, 
ba£
, 
mask
, 
cy˛e_dñè
;

125 
£q
;

126 
mu…
, 
shi·
, 
n£c
;

127 
	`cy˛e_t
 (*
vªad
)();

129 
£q
 = 
	`ªad_£qbegö
(&
__vsysˇŒ_gtod_d©a
.
lock
);

131 
vªad
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.vread;

132 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
 || !
vªad
)) {

133 
	`gëtimeofday
(
tv
,
NULL
);

137 
now
 = 
	`vªad
();

138 
ba£
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

139 
mask
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mask;

140 
mu…
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mult;

141 
shi·
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.shift;

143 
tv
->
tv_£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_£c
;

144 
n£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
;

145 } 
	`ªad_£qªåy
(&
__vsysˇŒ_gtod_d©a
.
lock
, 
£q
));

148 
cy˛e_dñè
 = (
now
 - 
ba£
Ë& 
mask
;

150 
n£c
 +(
cy˛e_dñè
 * 
mu…
Ë>> 
shi·
;

152 
n£c
 >
NSEC_PER_SEC
) {

153 
tv
->
tv_£c
 += 1;

154 
n£c
 -
NSEC_PER_SEC
;

156 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

157 
	}
}

159 
	$__vsysˇŒ
(0Ë
	$vgëtimeofday
(
timevÆ
 * 
tv
, 
timez⁄e
 * 
tz
)

161 i‡(
tv
)

162 
	`do_vgëtimeofday
(
tv
);

163 i‡(
tz
)

164 
	`do_gë_tz
(
tz
);

166 
	}
}

170 
time_t
 
	$__vsysˇŒ
(1Ë
	$vtime
(
time_t
 *
t
)

172 
timevÆ
 
tv
;

173 
time_t
 
ªsu…
;

174 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
))

175  
	`time_sysˇŒ
(
t
);

177 
	`vgëtimeofday
(&
tv
, 
NULL
);

178 
ªsu…
 = 
tv
.
tv_£c
;

179 i‡(
t
)

180 *
t
 = 
ªsu…
;

181  
ªsu…
;

182 
	}
}

192 
	$__vsysˇŒ
(2)

193 
	$vgë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

195 
p
;

196 
j
 = 0;

206 i‡(
tˇche
 &&Åˇche->
blob
[0] =(
j
 = 
__jiffõs
)) {

207 
p
 = 
tˇche
->
blob
[1];

208 } i‡(
__vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

210 
	`«tive_ªad_ts˝
(&
p
);

213 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

215 i‡(
tˇche
) {

216 
tˇche
->
blob
[0] = 
j
;

217 
tˇche
->
blob
[1] = 
p
;

219 i‡(
˝u
)

220 *
˝u
 = 
p
 & 0xfff;

221 i‡(
node
)

222 *
node
 = 
p
 >> 12;

224 
	}
}

226 
	$__vsysˇŒ
(3Ë
	$víosys_1
()

228  -
ENOSYS
;

229 
	}
}

231 #ifde‡
CONFIG_SYSCTL


232 
˘l_èbÀ
 
	gkî√l_èbÀ2
[] = {

233 { .
¥o˙ame
 = "vsyscall64",

234 .
	gd©a
 = &
vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
, .
	gmaxÀn
 = (),

235 .
	gmode
 = 0644,

236 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
 },

240 
˘l_èbÀ
 
	gkî√l_roŸ_èbÀ2
[] = {

241 { .
¥o˙ame
 = "kî√l", .
	gmode
 = 0555,

242 .
	gchûd
 = 
kî√l_èbÀ2
 },

249 
__˝uöô
 
	$vsysˇŒ_£t_˝u
(
˝u
)

251 
d
;

252 
node
 = 0;

253 #ifde‡
CONFIG_NUMA


254 
node
 = 
	`˝u_to_node
(
˝u
);

256 i‡(
	`˝u_has
(&
	`˝u_d©a
(
˝u
), 
X86_FEATURE_RDTSCP
))

257 
	`wrôe_rdts˝_aux
((
node
 << 12Ë| 
˝u
);

262 
d
 = 0x0f40000000000ULL;

263 
d
 |
˝u
;

264 
d
 |(
node
 & 0xf) << 12;

265 
d
 |(
node
 >> 4) << 48;

266 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

267 
	}
}

269 
__˝uöô
 
	$˝u_vsysˇŒ_öô
(*
¨g
)

272 
	`vsysˇŒ_£t_˝u
(
	`øw_smp_¥o˚ss‹_id
());

273 
	}
}

275 
__˝uöô


276 
	$˝u_vsysˇŒ_nŸifõr
(
nŸifõr_block
 *
n
, 
a˘i⁄
, *
¨g
)

278 
˝u
 = ()
¨g
;

279 i‡(
a˘i⁄
 =
CPU_ONLINE
 ||á˘i⁄ =
CPU_ONLINE_FROZEN
)

280 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝u_vsysˇŒ_öô
, 
NULL
, 1);

281  
NOTIFY_DONE
;

282 
	}
}

284 
__öô
 
	$m≠_vsysˇŒ
()

286 
__vsysˇŒ_0
;

287 
phyßddr_∑ge0
 = 
	`__∑_symbﬁ
(&
__vsysˇŒ_0
);

290 
	`__£t_fixm≠
(
VSYSCALL_FIRST_PAGE
, 
phyßddr_∑ge0
, 
PAGE_KERNEL_VSYSCALL
);

291 
	}
}

293 
__öô
 
	$vsysˇŒ_öô
()

295 
	`BUG_ON
(((Ë&
vgëtimeofday
 !=

296 
	`VSYSCALL_ADDR
(
__NR_vgëtimeofday
)));

297 
	`BUG_ON
((Ë&
vtime
 !
	`VSYSCALL_ADDR
(
__NR_vtime
));

298 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0Ë!
	`__fix_to_vút
(
VSYSCALL_FIRST_PAGE
)));

299 
	`BUG_ON
((Ë&
vgë˝u
 !
	`VSYSCALL_ADDR
(
__NR_vgë˝u
));

300 #ifde‡
CONFIG_SYSCTL


301 
	`ªgi°î_sys˘l_èbÀ
(
kî√l_roŸ_èbÀ2
);

303 
	`⁄_óch_˝u
(
˝u_vsysˇŒ_öô
, 
NULL
, 1);

305 
	`hŸ˝u_nŸifõr
(
˝u_vsysˇŒ_nŸifõr
, 30);

307 
	}
}

309 
__öôˇŒ
(
vsysˇŒ_öô
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/smp.h
>

7 
	~<√t/checksum.h
>

9 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/uac˚ss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/·ø˚.h
>

15 #ifde‡
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcou¡
);

20 
EXPORT_SYMBOL
(
__gë_u£r_1
);

21 
EXPORT_SYMBOL
(
__gë_u£r_2
);

22 
EXPORT_SYMBOL
(
__gë_u£r_4
);

23 
EXPORT_SYMBOL
(
__gë_u£r_8
);

24 
EXPORT_SYMBOL
(
__put_u£r_1
);

25 
EXPORT_SYMBOL
(
__put_u£r_2
);

26 
EXPORT_SYMBOL
(
__put_u£r_4
);

27 
EXPORT_SYMBOL
(
__put_u£r_8
);

29 
EXPORT_SYMBOL
(
c›y_u£r_gíîic_°rög
);

30 
EXPORT_SYMBOL
(
c›y_u£r_gíîic_uƒﬁÀd
);

31 
EXPORT_SYMBOL
(
__c›y_u£r_noˇche
);

32 
EXPORT_SYMBOL
(
_c›y_‰om_u£r
);

33 
EXPORT_SYMBOL
(
_c›y_to_u£r
);

35 
EXPORT_SYMBOL
(
c›y_∑ge
);

36 
EXPORT_SYMBOL
(
˛ór_∑ge
);

38 
EXPORT_SYMBOL
(
csum_∑πül
);

44 #unde‡
mem˝y


45 #unde‡
mem£t


46 #unde‡
memmove


48 *
mem£t
(*, , 
__kî√l_size_t
);

49 *
mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

50 *
__mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

52 
EXPORT_SYMBOL
(
mem£t
);

53 
EXPORT_SYMBOL
(
mem˝y
);

54 
EXPORT_SYMBOL
(
__mem˝y
);

56 
EXPORT_SYMBOL
(
em±y_zîo_∑ge
);

57 
EXPORT_SYMBOL
(
öô_Àvñ4_pgt
);

58 #i‚de‡
CONFIG_PARAVIRT


59 
EXPORT_SYMBOL
(
«tive_lﬂd_gs_ödex
);

	@/cmpt816/linux/arch/x86/kernel/x86_init.c

6 
	~<löux/öô.h
>

7 
	~<löux/i›‹t.h
>

9 
	~<asm/bios_ebda.h
>

10 
	~<asm/∑øvút.h
>

11 
	~<asm/pci_x86.h
>

12 
	~<asm/mp•ec.h
>

13 
	~<asm/£tup.h
>

14 
	~<asm/≠ic.h
>

15 
	~<asm/e820.h
>

16 
	~<asm/time.h
>

17 
	~<asm/úq.h
>

18 
	~<asm/∑t.h
>

19 
	~<asm/tsc.h
>

20 
	~<asm/iommu.h
>

22 
__˝uöô
 
	$x86_öô_no›
(Ë{ 
	}
}

23 
__öô
 
	$x86_öô_uöt_no›
(
unu£d
Ë{ 
	}
}

24 
__öô
 
	$x86_öô_pgd_no›
(
pgd_t
 *
unu£d
Ë{ 
	}
}

25 
__öô
 
	$iommu_öô_no›
(Ë{  0; 
	}
}

26 
	$iommu_shutdown_no›
(Ë{ 
	}
}

32 
x86_öô_›s
 
x86_öô
 
	g__öôd©a
 = {

34 .
ªsour˚s
 = {

35 .
¥obe_roms
 = 
x86_öô_no›
,

36 .
	gª£rve_ªsour˚s
 = 
ª£rve_°™d¨d_io_ªsour˚s
,

37 .
	gmem‹y_£tup
 = 
deÁu…_machöe_•ecific_mem‹y_£tup
,

40 .
	gmµ¨£
 = {

41 .
mpc_ªc‹d
 = 
x86_öô_uöt_no›
,

42 .
	g£tup_iﬂpic_ids
 = 
x86_öô_no›
,

43 .
	gmpc_≠ic_id
 = 
deÁu…_mpc_≠ic_id
,

44 .
	gsmp_ªad_mpc_€m
 = 
deÁu…_smp_ªad_mpc_€m
,

45 .
	gmpc_€m_bus_öfo
 = 
deÁu…_mpc_€m_bus_öfo
,

46 .
	gföd_smp_c⁄fig
 = 
deÁu…_föd_smp_c⁄fig
,

47 .
	ggë_smp_c⁄fig
 = 
deÁu…_gë_smp_c⁄fig
,

50 .
	gúqs
 = {

51 .
¥e_ve˘‹_öô
 = 
öô_ISA_úqs
,

52 .
	göå_öô
 = 
«tive_öô_IRQ
,

53 .
	gå≠_öô
 = 
x86_öô_no›
,

56 .
	g€m
 = {

57 .
¨ch_£tup
 = 
x86_öô_no›
,

58 .
	gb™√r
 = 
deÁu…_b™√r
,

61 .
	g∑gög
 = {

62 .
∑gëabÀ_£tup_°¨t
 = 
«tive_∑gëabÀ_£tup_°¨t
,

63 .
	g∑gëabÀ_£tup_d⁄e
 = 
«tive_∑gëabÀ_£tup_d⁄e
,

66 .
	gtimîs
 = {

67 .
£tup_≥r˝u_˛ockev
 = 
£tup_boŸ_APIC_˛ock
,

68 .
	gtsc_¥e_öô
 = 
x86_öô_no›
,

69 .
	gtimî_öô
 = 
h≥t_time_öô
,

72 .
	giommu
 = {

73 .
iommu_öô
 = 
iommu_öô_no›
,

76 .
	gpci
 = {

77 .
öô
 = 
x86_deÁu…_pci_öô
,

78 .
	göô_úq
 = 
x86_deÁu…_pci_öô_úq
,

79 .
	gfixup_úqs
 = 
x86_deÁu…_pci_fixup_úqs
,

83 
x86_˝uöô_›s
 
x86_˝uöô
 
	g__˝uöôd©a
 = {

84 .
£tup_≥r˝u_˛ockev
 = 
£tup_£c⁄d¨y_APIC_˛ock
,

87 
	$deÁu…_nmi_öô
(Ë{ 
	}
};

89 
x86_∂©f‹m_›s
 
	gx86_∂©f‹m
 = {

90 .
ˇlibøã_tsc
 = 
«tive_ˇlibøã_tsc
,

91 .
	ggë_wÆl˛ock
 = 
mach_gë_cmos_time
,

92 .
	g£t_wÆl˛ock
 = 
mach_£t_πc_mmss
,

93 .
	giommu_shutdown
 = 
iommu_shutdown_no›
,

94 .
	gis_u¡øcked_∑t_ønge
 = 
is_ISA_ønge
,

95 .
	gnmi_öô
 = 
deÁu…_nmi_öô


	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<löux/boŸmem.h
>

7 
	~<löux/com∑t.h
>

8 
	~<asm/i387.h
>

9 #ifde‡
CONFIG_IA32_EMULATION


10 
	~<asm/sigc⁄ãxt32.h
>

12 
	~<asm/x¸.h
>

17 
u64
 
	gp˙txt_mask
;

19 
_Âx_sw_byãs
 
	gfx_sw_ª£rved
;

20 #ifde‡
CONFIG_IA32_EMULATION


21 
_Âx_sw_byãs
 
	gfx_sw_ª£rved_ü32
;

28 
	$check_f‹_x°©e
(
i387_fxßve_°ru˘
 
__u£r
 *
buf
,

29 
__u£r
 *
Â°©e
,

30 
_Âx_sw_byãs
 *
fx_sw_u£r
)

32 
mö_x°©e_size
 = (
i387_fxßve_°ru˘
) +

33 (
xßve_hdr_°ru˘
);

34 
magic2
;

35 
îr
;

37 
îr
 = 
	`__c›y_‰om_u£r
(
fx_sw_u£r
, &
buf
->
sw_ª£rved
[0],

38 (
_Âx_sw_byãs
));

40 i‡(
îr
)

41  
îr
;

46 i‡(
fx_sw_u£r
->
magic1
 !
FP_XSTATE_MAGIC1
)

52 i‡(
fx_sw_u£r
->
x°©e_size
 < 
mö_x°©e_size
 ||

53 
fx_sw_u£r
->
x°©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x°©e_size
 > fx_sw_u£r->
exãnded_size
)

57 
îr
 = 
	`__gë_u£r
(
magic2
, (
__u32
 *Ë(((*)
Â°©e
) +

58 
fx_sw_u£r
->
exãnded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 i‡(
îr
 || 
magic2
 !
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifde‡
CONFIG_X86_64


77 
	$ßve_i387_x°©e
(
__u£r
 *
buf
)

79 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

80 
îr
 = 0;

82 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x°©e_size
 < 
x°©e_size
);

87 i‡(()
buf
 % 64)

88 
	`¥ötk
("ßve_i387_x°©e: bad fp°©ê%p\n", 
buf
);

90 i‡(!
	`u£d_m©h
())

93 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_USEDFPU
) {

98 
îr
 = 
	`__˛ór_u£r
(
buf
, 
sig_x°©e_size
);

99 i‡(
îr
)

100  
îr
;

102 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

103 
îr
 = 
	`xßve_u£r
(
buf
);

105 
îr
 = 
	`fxßve_u£r
(
buf
);

107 i‡(
îr
)

108  
îr
;

109 
	`èsk_thªad_öfo
(
tsk
)->
°©us
 &~
TS_USEDFPU
;

110 
	`°ts
();

112 i‡(
	`__c›y_to_u£r
(
buf
, &
tsk
->
thªad
.
x°©e
->
fxßve
,

113 
x°©e_size
))

117 
	`˛ór_u£d_m©h
();

119 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
) {

120 
_Â°©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x°©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x°©e_bv
;

124 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved
,

125 (
_Âx_sw_byãs
));

127 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
îr
 |
	`__gë_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

149 
x°©e_bv
 |
XSTATE_FPSSE
;

151 
îr
 |
	`__put_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

153 i‡(
îr
)

154  
îr
;

158 
	}
}

164 
	$ª°‹e_u£r_x°©e
(
__u£r
 *
buf
)

166 
_Âx_sw_byãs
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
îr
;

170 i‡((()
buf
 % 64) ||

171 
	`check_f‹_x°©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_⁄ly
;

174 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

179 
îr
 = 
	`xª°‹e_u£r
(
buf
, 
mask
);

180 i‡(
îr
)

181  
îr
;

186 
mask
 = 
p˙txt_mask
 & ~mask;

188 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
mask
);

192 
fx_⁄ly
:

198 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
p˙txt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)
buf
);

200 
	}
}

205 
	$ª°‹e_i387_x°©e
(
__u£r
 *
buf
)

207 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

208 
îr
 = 0;

210 i‡(!
buf
) {

211 i‡(
	`u£d_m©h
())

212 
˛ór
;

215 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_size
))

216  -
EACCES
;

218 i‡(!
	`u£d_m©h
()) {

219 
îr
 = 
	`öô_Âu
(
tsk
);

220 i‡(
îr
)

221  
îr
;

224 i‡(!(
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 & 
TS_USEDFPU
)) {

225 
	`˛ts
();

226 
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 |
TS_USEDFPU
;

228 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

229 
îr
 = 
	`ª°‹e_u£r_x°©e
(
buf
);

231 
îr
 = 
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)

232 
buf
);

233 i‡(
	`u∆ikñy
(
îr
)) {

238 
˛ór
:

239 
	`˛ór_Âu
(
tsk
);

240 
	`˛ór_u£d_m©h
();

242  
îr
;

243 
	}
}

253 
	$¥ï¨e_fx_sw_‰ame
()

255 
size_exãnded
 = (
x°©e_size
 - (
i387_fxßve_°ru˘
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x°©e_size
 = (
_Â°©e
Ë+ 
size_exãnded
;

260 #ifde‡
CONFIG_IA32_EMULATION


261 
sig_x°©e_ü32_size
 = (
_Â°©e_ü32
Ë+ 
size_exãnded
;

264 
	`mem£t
(&
fx_sw_ª£rved
, 0, (fx_sw_reserved));

266 
fx_sw_ª£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_ª£rved
.
exãnded_size
 = 
sig_x°©e_size
;

268 
fx_sw_ª£rved
.
x°©e_bv
 = 
p˙txt_mask
;

269 
fx_sw_ª£rved
.
x°©e_size
 = xstate_size;

270 #ifde‡
CONFIG_IA32_EMULATION


271 
	`mem˝y
(&
fx_sw_ª£rved_ü32
, &
fx_sw_ª£rved
,

272 (
_Âx_sw_byãs
));

273 
fx_sw_ª£rved_ü32
.
exãnded_size
 = 
sig_x°©e_ü32_size
;

275 
	}
}

280 
xßve_°ru˘
 *
	göô_x°©e_buf
;

282 #ifde‡
CONFIG_X86_64


283 
	gsig_x°©e_size
 = (
_Â°©e
);

289 
__˝uöô
 
	$xßve_öô
()

291 i‡(!
˝u_has_xßve
)

294 
	`£t_ö_¸4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
p˙txt_mask
);

301 
	}
}

306 
__öô
 
	$£tup_x°©e_öô
()

308 
öô_x°©e_buf
 = 
	`Æloc_boŸmem
(
x°©e_size
);

309 
öô_x°©e_buf
->
i387
.
mxc§
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__ªf
 
	$xßve_˙txt_öô
()

317 
óx
, 
ebx
, 
ecx
, 
edx
;

319 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

320 
p˙txt_mask
 = 
óx
 + ((
u64
)
edx
 << 32);

322 i‡((
p˙txt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`¥ötk
(
KERN_ERR
 "FP/SSEÇot shown under xsave features 0x%llx\n",

324 
p˙txt_mask
);

325 
	`BUG
();

331 
p˙txt_mask
 =Ö˙txt_mask & 
XCNTXT_MASK
;

332 
	`xßve_öô
();

337 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

338 
x°©e_size
 = 
ebx
;

340 
	`upd©e_ªg£t_x°©e_öfo
(
x°©e_size
, 
p˙txt_mask
);

341 
	`¥ï¨e_fx_sw_‰ame
();

343 
	`£tup_x°©e_öô
();

345 
	`¥ötk
(
KERN_INFO
 "xsave/xrstor:Énabled xstate_bv 0x%llx, "

347 
p˙txt_mask
, 
x°©e_size
);

348 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/•ölock.h
>

3 
	~<asm/uac˚ss.h
>

6 
	$fixup_ex˚±i⁄
(
±_ªgs
 *
ªgs
)

8 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

10 #ifde‡
CONFIG_PNPBIOS


11 i‡(
	`u∆ikñy
(
	`SEGMENT_IS_PNP_CODE
(
ªgs
->
cs
))) {

12 
u32
 
≤p_bios_Áu…_eù
, 
≤p_bios_Áu…_e•
;

13 
u32
 
≤p_bios_is_uâî_¸≠
;

14 
≤p_bios_is_uâî_¸≠
 = 1;

15 
	`¥ötk
(
KERN_CRIT
 "PNPBIOS fault..áttemptingÑecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
≤p_bios_Áu…_e•
), "g" (
≤p_bios_Áu…_eù
));

20 
	`∑nic
("do_trap: can't hitÅhis");

24 
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
);

25 i‡(
fixup
) {

27 i‡(
fixup
->fixup < 16) {

28 
	`cuºít_thªad_öfo
()->
uac˚ss_îr
 = -
EFAULT
;

29 
ªgs
->
ù
 +
fixup
->fixup;

32 
ªgs
->
ù
 = 
fixup
->fixup;

37 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<löux/magic.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/kdebug.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/boŸmem.h
>

11 
	~<löux/k¥obes.h
>

12 
	~<löux/mmiŸø˚.h
>

13 
	~<löux/≥rf_evít.h
>

15 
	~<asm/å≠s.h
>

16 
	~<asm/pgÆloc.h
>

17 
	~<asm/kmemcheck.h
>

28 
	ex86_pf_îr‹_code
 {

30 
	mPF_PROT
 = 1 << 0,

31 
	mPF_WRITE
 = 1 << 1,

32 
	mPF_USER
 = 1 << 2,

33 
	mPF_RSVD
 = 1 << 3,

34 
	mPF_INSTR
 = 1 << 4,

41 
ölöe
 
__k¥obes


42 
	$kmmio_Áu…
(
±_ªgs
 *
ªgs
, 
addr
)

44 i‡(
	`u∆ikñy
(
	`is_kmmio_a˘ive
()))

45 i‡(
	`kmmio_h™dÀr
(
ªgs
, 
addr
) == 1)

48 
	}
}

50 
ölöe
 
__k¥obes
 
	$nŸify_∑ge_Áu…
(
±_ªgs
 *
ªgs
)

52 
ªt
 = 0;

55 i‡(
	`k¥obes_buût_ö
(Ë&& !
	`u£r_mode_vm
(
ªgs
)) {

56 
	`¥ìm±_dißbÀ
();

57 i‡(
	`k¥obe_ru¬ög
(Ë&& 
	`k¥obe_Áu…_h™dÀr
(
ªgs
, 14))

58 
ªt
 = 1;

59 
	`¥ìm±_íabÀ
();

62  
ªt
;

63 
	}
}

80 
ölöe
 

81 
	$check_¥e„tch_›code
(
±_ªgs
 *
ªgs
, *
ö°r
,

82 
›code
, *
¥e„tch
)

84 
ö°r_hi
 = 
›code
 & 0xf0;

85 
ö°r_lo
 = 
›code
 & 0x0f;

87 
ö°r_hi
) {

96  ((
ö°r_lo
 & 7) == 0x6);

97 #ifde‡
CONFIG_X86_64


106  (!
	`u£r_mode
(
ªgs
)Ë|| (ªgs->
cs
 =
__USER_CS
);

110  (
ö°r_lo
 & 0xC) == 0x4;

113  !
ö°r_lo
 || (instr_lo>>1) == 1;

116 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

119 *
¥e„tch
 = (
ö°r_lo
 == 0xF) &&

120 (
›code
 == 0x0D || opcode == 0x18);

125 
	}
}

128 
	$is_¥e„tch
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addr
)

130 *
max_ö°r
;

131 *
ö°r
;

132 
¥e„tch
 = 0;

138 i‡(
îr‹_code
 & 
PF_INSTR
)

141 
ö°r
 = (*)
	`c⁄vît_ù_to_löór
(
cuºít
, 
ªgs
);

142 
max_ö°r
 = 
ö°r
 + 15;

144 i‡(
	`u£r_mode
(
ªgs
Ë&& 
ö°r
 >(*)
TASK_SIZE
)

147 
ö°r
 < 
max_ö°r
) {

148 
›code
;

150 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

153 
ö°r
++;

155 i‡(!
	`check_¥e„tch_›code
(
ªgs
, 
ö°r
, 
›code
, &
¥e„tch
))

158  
¥e„tch
;

159 
	}
}

162 
	$f‹˚_sig_öfo_Áu…
(
si_signo
, 
si_code
, 
addªss
,

163 
èsk_°ru˘
 *
tsk
)

165 
sigöfo_t
 
öfo
;

167 
öfo
.
si_signo
 = si_signo;

168 
öfo
.
si_î∫o
 = 0;

169 
öfo
.
si_code
 = si_code;

170 
öfo
.
si_addr
 = (
__u£r
 *)
addªss
;

171 
öfo
.
si_addr_lsb
 = 
si_code
 =
BUS_MCEERR_AR
 ? 
PAGE_SHIFT
 : 0;

173 
	`f‹˚_sig_öfo
(
si_signo
, &
öfo
, 
tsk
);

174 
	}
}

176 
DEFINE_SPINLOCK
(
pgd_lock
);

177 
LIST_HEAD
(
pgd_li°
);

179 #ifde‡
CONFIG_X86_32


180 
ölöe
 
pmd_t
 *
	$vmÆloc_sync_⁄e
(
pgd_t
 *
pgd
, 
addªss
)

182 
ödex
 = 
	`pgd_ödex
(
addªss
);

183 
pgd_t
 *
pgd_k
;

184 
pud_t
 *
pud
, *
pud_k
;

185 
pmd_t
 *
pmd
, *
pmd_k
;

187 
pgd
 +
ödex
;

188 
pgd_k
 = 
öô_mm
.
pgd
 + 
ödex
;

190 i‡(!
	`pgd_¥e£¡
(*
pgd_k
))

191  
NULL
;

198 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

199 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
addªss
);

200 i‡(!
	`pud_¥e£¡
(*
pud_k
))

201  
NULL
;

203 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

204 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
addªss
);

205 i‡(!
	`pmd_¥e£¡
(*
pmd_k
))

206  
NULL
;

208 i‡(!
	`pmd_¥e£¡
(*
pmd
))

209 
	`£t_pmd
(
pmd
, *
pmd_k
);

211 
	`BUG_ON
(
	`pmd_∑ge
(*
pmd
Ë!pmd_∑ge(*
pmd_k
));

213  
pmd_k
;

214 
	}
}

216 
	$vmÆloc_sync_Æl
()

218 
addªss
;

220 i‡(
SHARED_KERNEL_PMD
)

223 
addªss
 = 
VMALLOC_START
 & 
PMD_MASK
;

224 
addªss
 >
TASK_SIZE
 &&áddªs†< 
FIXADDR_TOP
;

225 
addªss
 +
PMD_SIZE
) {

227 
Êags
;

228 
∑ge
 *page;

230 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

231 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

232 i‡(!
	`vmÆloc_sync_⁄e
(
	`∑ge_addªss
(
∑ge
), 
addªss
))

235 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

237 
	}
}

244 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

246 
pgd_∑ddr
;

247 
pmd_t
 *
pmd_k
;

248 
±e_t
 *
±e_k
;

251 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

261 
pgd_∑ddr
 = 
	`ªad_¸3
();

262 
pmd_k
 = 
	`vmÆloc_sync_⁄e
(
	`__va
(
pgd_∑ddr
), 
addªss
);

263 i‡(!
pmd_k
)

266 
±e_k
 = 
	`±e_off£t_kî√l
(
pmd_k
, 
addªss
);

267 i‡(!
	`±e_¥e£¡
(*
±e_k
))

271 
	}
}

276 
ölöe
 

277 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

278 
èsk_°ru˘
 *
tsk
)

280 
bô
;

282 i‡(!
	`v8086_mode
(
ªgs
))

285 
bô
 = (
addªss
 - 0xA0000Ë>> 
PAGE_SHIFT
;

286 i‡(
bô
 < 32)

287 
tsk
->
thªad
.
s¸ìn_bôm≠
 |1 << 
bô
;

288 
	}
}

290 
boﬁ
 
	$low_p‚
(
p‚
)

292  
p‚
 < 
max_low_p‚
;

293 
	}
}

295 
	$dump_∑gëabÀ
(
addªss
)

297 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

298 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addªss
)];

299 
pmd_t
 *
pmd
;

300 
±e_t
 *
±e
;

302 #ifde‡
CONFIG_X86_PAE


303 
	`¥ötk
("*pd± = %016Lx ", 
	`pgd_vÆ
(*
pgd
));

304 i‡(!
	`low_p‚
(
	`pgd_vÆ
(*
pgd
Ë>> 
PAGE_SHIFT
Ë|| !
	`pgd_¥e£¡
(*pgd))

305 
out
;

307 
pmd
 = 
	`pmd_off£t
(
	`pud_off£t
(
pgd
, 
addªss
),áddress);

308 
	`¥ötk
(
KERN_CONT
 "*pdê%0*Lx ", (*
pmd
Ë* 2, (
u64
)
	`pmd_vÆ
(*pmd));

316 i‡(!
	`low_p‚
(
	`pmd_p‚
(*
pmd
)Ë|| !
	`pmd_¥e£¡
(*pmdË|| 
	`pmd_œrge
(*pmd))

317 
out
;

319 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

320 
	`¥ötk
("*±ê%0*Lx ", (*
±e
Ë* 2, (
u64
)
	`±e_vÆ
(*pte));

321 
out
:

322 
	`¥ötk
("\n");

323 
	}
}

327 
	$vmÆloc_sync_Æl
()

329 
addªss
;

331 
addªss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;áddªs†<
VMALLOC_END
;

332 
addªss
 +
PGDIR_SIZE
) {

334 c⁄° 
pgd_t
 *
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

335 
Êags
;

336 
∑ge
 *page;

338 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

341 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

342 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

343 
pgd_t
 *
pgd
;

344 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

345 i‡(
	`pgd_n⁄e
(*
pgd
))

346 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

348 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

350 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

352 
	}
}

361 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

363 
pgd_t
 *
pgd
, *
pgd_ªf
;

364 
pud_t
 *
pud
, *
pud_ªf
;

365 
pmd_t
 *
pmd
, *
pmd_ªf
;

366 
±e_t
 *
±e
, *
±e_ªf
;

369 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

377 
pgd
 = 
	`pgd_off£t
(
cuºít
->
a˘ive_mm
, 
addªss
);

378 
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

379 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

382 i‡(
	`pgd_n⁄e
(*
pgd
))

383 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

385 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

392 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

393 
pud_ªf
 = 
	`pud_off£t
(
pgd_ªf
, 
addªss
);

394 i‡(
	`pud_n⁄e
(*
pud_ªf
))

397 i‡(
	`pud_n⁄e
(*
pud
Ë|| 
	`pud_∑ge_vaddr
(*pudË!pud_∑ge_vaddr(*
pud_ªf
))

398 
	`BUG
();

400 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

401 
pmd_ªf
 = 
	`pmd_off£t
(
pud_ªf
, 
addªss
);

402 i‡(
	`pmd_n⁄e
(*
pmd_ªf
))

405 i‡(
	`pmd_n⁄e
(*
pmd
Ë|| 
	`pmd_∑ge
(*pmdË!pmd_∑ge(*
pmd_ªf
))

406 
	`BUG
();

408 
±e_ªf
 = 
	`±e_off£t_kî√l
(
pmd_ªf
, 
addªss
);

409 i‡(!
	`±e_¥e£¡
(*
±e_ªf
))

412 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

419 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| 
	`±e_p‚
(*±eË!±e_p‚(*
±e_ªf
))

420 
	`BUG
();

423 
	}
}

425 c⁄° 
	gîøè93_w¨nög
[] =

426 
KERN_ERR


435 
ölöe
 

436 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

437 
èsk_°ru˘
 *
tsk
)

439 
	}
}

441 
	$bad_addªss
(*
p
)

443 
dummy
;

445  
	`¥obe_kî√l_addªss
((*)
p
, 
dummy
);

446 
	}
}

448 
	$dump_∑gëabÀ
(
addªss
)

450 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
(Ë& 
PHYSICAL_PAGE_MASK
);

451 
pgd_t
 *
pgd
 = 
ba£
 + 
	`pgd_ödex
(
addªss
);

452 
pud_t
 *
pud
;

453 
pmd_t
 *
pmd
;

454 
±e_t
 *
±e
;

456 i‡(
	`bad_addªss
(
pgd
))

457 
bad
;

459 
	`¥ötk
("PGD %lx ", 
	`pgd_vÆ
(*
pgd
));

461 i‡(!
	`pgd_¥e£¡
(*
pgd
))

462 
out
;

464 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

465 i‡(
	`bad_addªss
(
pud
))

466 
bad
;

468 
	`¥ötk
("PUD %lx ", 
	`pud_vÆ
(*
pud
));

469 i‡(!
	`pud_¥e£¡
(*
pud
Ë|| 
	`pud_œrge
(*pud))

470 
out
;

472 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

473 i‡(
	`bad_addªss
(
pmd
))

474 
bad
;

476 
	`¥ötk
("PMD %lx ", 
	`pmd_vÆ
(*
pmd
));

477 i‡(!
	`pmd_¥e£¡
(*
pmd
Ë|| 
	`pmd_œrge
(*pmd))

478 
out
;

480 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

481 i‡(
	`bad_addªss
(
±e
))

482 
bad
;

484 
	`¥ötk
("PTE %lx", 
	`±e_vÆ
(*
±e
));

485 
out
:

486 
	`¥ötk
("\n");

488 
bad
:

489 
	`¥ötk
("BAD\n");

490 
	}
}

508 
	$is_îøè93
(
±_ªgs
 *
ªgs
, 
addªss
)

510 #ifde‡
CONFIG_X86_64


511 i‡(
addªss
 !
ªgs
->
ù
)

514 i‡((
addªss
 >> 32) != 0)

517 
addªss
 |= 0xffffffffUL << 32;

518 i‡((
addªss
 >(
u64
)
_°ext
 &&áddªs†<(u64)
_ëext
) ||

519 (
addªss
 >
MODULES_VADDR
 &&áddªs†<
MODULES_END
)) {

520 
	`¥ötk_⁄˚
(
îøè93_w¨nög
);

521 
ªgs
->
ù
 = 
addªss
;

526 
	}
}

536 
	$is_îøè100
(
±_ªgs
 *
ªgs
, 
addªss
)

538 #ifde‡
CONFIG_X86_64


539 i‡((
ªgs
->
cs
 =
__USER32_CS
 || (ªgs->c†& (1<<2))Ë&& (
addªss
 >> 32))

543 
	}
}

545 
	$is_f00f_bug
(
±_ªgs
 *
ªgs
, 
addªss
)

547 #ifde‡
CONFIG_X86_F00F_BUG


548 
ƒ
;

553 i‡(
boŸ_˝u_d©a
.
f00f_bug
) {

554 
ƒ
 = (
addªss
 - 
idt_des¸
.address) >> 3;

556 i‡(
ƒ
 == 6) {

557 
	`do_övÆid_›
(
ªgs
, 0);

563 
	}
}

565 c⁄° 
	gnx_w¨nög
[] = 
KERN_CRIT


569 
	$show_Áu…_o›s
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

570 
addªss
)

572 i‡(!
	`o›s_may_¥öt
())

575 i‡(
îr‹_code
 & 
PF_INSTR
) {

576 
Àvñ
;

578 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

580 i‡(
±e
 && 
	`±e_¥e£¡
(*±eË&& !
	`±e_exec
(*pte))

581 
	`¥ötk
(
nx_w¨nög
, 
	`cuºít_uid
());

584 
	`¥ötk
(
KERN_ALERT
 "BUG: unableÅo handle kernel ");

585 i‡(
addªss
 < 
PAGE_SIZE
)

586 
	`¥ötk
(
KERN_CONT
 "NULLÖointer dereference");

588 
	`¥ötk
(
KERN_CONT
 "pagingÑequest");

590 
	`¥ötk
(
KERN_CONT
 "áà%p\n", (*Ë
addªss
);

591 
	`¥ötk
(
KERN_ALERT
 "IP:");

592 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

594 
	`dump_∑gëabÀ
(
addªss
);

595 
	}
}

597 
noölöe
 

598 
	$pgèbÀ_bad
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

599 
addªss
)

601 
èsk_°ru˘
 *
tsk
;

602 
Êags
;

603 
sig
;

605 
Êags
 = 
	`o›s_begö
();

606 
tsk
 = 
cuºít
;

607 
sig
 = 
SIGKILL
;

609 
	`¥ötk
(
KERN_ALERT
 "%s: CorruptedÖageÅableátáddress %lx\n",

610 
tsk
->
comm
, 
addªss
);

611 
	`dump_∑gëabÀ
(
addªss
);

613 
tsk
->
thªad
.
¸2
 = 
addªss
;

614 
tsk
->
thªad
.
å≠_no
 = 14;

615 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

617 i‡(
	`__dõ
("BadÖagëabÀ", 
ªgs
, 
îr‹_code
))

618 
sig
 = 0;

620 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

621 
	}
}

623 
noölöe
 

624 
	$no_c⁄ãxt
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

625 
addªss
)

627 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

628 *
°ackíd
;

629 
Êags
;

630 
sig
;

633 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

647 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

650 i‡(
	`is_îøè93
(
ªgs
, 
addªss
))

657 
Êags
 = 
	`o›s_begö
();

659 
	`show_Áu…_o›s
(
ªgs
, 
îr‹_code
, 
addªss
);

661 
°ackíd
 = 
	`íd_of_°ack
(
tsk
);

662 i‡(
tsk
 !&
öô_èsk
 && *
°ackíd
 !
STACK_END_MAGIC
)

663 
	`¥ötk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

665 
tsk
->
thªad
.
¸2
 = 
addªss
;

666 
tsk
->
thªad
.
å≠_no
 = 14;

667 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

669 
sig
 = 
SIGKILL
;

670 i‡(
	`__dõ
("O›s", 
ªgs
, 
îr‹_code
))

671 
sig
 = 0;

674 
	`¥ötk
(
KERN_EMERG
 "CR2: %016lx\n", 
addªss
);

676 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

677 
	}
}

683 
ölöe
 

684 
	$show_sig«l_msg
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

685 
addªss
, 
èsk_°ru˘
 *
tsk
)

687 i‡(!
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
))

690 i‡(!
	`¥ötk_øãlimô
())

693 
	`¥ötk
("%s%s[%d]: segfaultát %lx ip %p sp %pÉrror %lx",

694 
	`èsk_pid_ƒ
(
tsk
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

695 
tsk
->
comm
, 
	`èsk_pid_ƒ
—sk), 
addªss
,

696 (*)
ªgs
->
ù
, (*Ïegs->
•
, 
îr‹_code
);

698 
	`¥öt_vma_addr
(
KERN_CONT
 " i¿", 
ªgs
->
ù
);

700 
	`¥ötk
(
KERN_CONT
 "\n");

701 
	}
}

704 
	$__bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

705 
addªss
, 
si_code
)

707 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

710 i‡(
îr‹_code
 & 
PF_USER
) {

714 
	`loˇl_úq_íabÀ
();

720 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

723 i‡(
	`is_îøè100
(
ªgs
, 
addªss
))

726 i‡(
	`u∆ikñy
(
show_unh™dÀd_sig«ls
))

727 
	`show_sig«l_msg
(
ªgs
, 
îr‹_code
, 
addªss
, 
tsk
);

730 
tsk
->
thªad
.
¸2
 = 
addªss
;

731 
tsk
->
thªad
.
îr‹_code
 =Éº‹_codê| (
addªss
 >
TASK_SIZE
);

732 
tsk
->
thªad
.
å≠_no
 = 14;

734 
	`f‹˚_sig_öfo_Áu…
(
SIGSEGV
, 
si_code
, 
addªss
, 
tsk
);

739 i‡(
	`is_f00f_bug
(
ªgs
, 
addªss
))

742 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

743 
	}
}

745 
noölöe
 

746 
	$bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

747 
addªss
)

749 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

750 
	}
}

753 
	$__bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

754 
addªss
, 
si_code
)

756 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

762 
	`up_ªad
(&
mm
->
mm≠_£m
);

764 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
si_code
);

765 
	}
}

767 
noölöe
 

768 
	$bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

770 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

771 
	}
}

773 
noölöe
 

774 
	$bad_¨ó_ac˚ss_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

775 
addªss
)

777 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_ACCERR
);

778 
	}
}

782 
	$out_of_mem‹y
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

783 
addªss
)

789 
	`up_ªad
(&
cuºít
->
mm
->
mm≠_£m
);

791 
	`∑geÁu…_out_of_mem‹y
();

792 
	}
}

795 
	$do_sigbus
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
,

796 
Áu…
)

798 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

799 
mm_°ru˘
 *
mm
 = 
tsk
->mm;

800 
code
 = 
BUS_ADRERR
;

802 
	`up_ªad
(&
mm
->
mm≠_£m
);

805 i‡(!(
îr‹_code
 & 
PF_USER
))

806 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

809 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

812 
tsk
->
thªad
.
¸2
 = 
addªss
;

813 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

814 
tsk
->
thªad
.
å≠_no
 = 14;

816 #ifde‡
CONFIG_MEMORY_FAILURE


817 i‡(
Áu…
 & 
VM_FAULT_HWPOISON
) {

818 
	`¥ötk
(
KERN_ERR


820 
tsk
->
comm
,Åsk->
pid
, 
addªss
);

821 
code
 = 
BUS_MCEERR_AR
;

824 
	`f‹˚_sig_öfo_Áu…
(
SIGBUS
, 
code
, 
addªss
, 
tsk
);

825 
	}
}

827 
noölöe
 

828 
	$mm_Áu…_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

829 
addªss
, 
Áu…
)

831 i‡(
Áu…
 & 
VM_FAULT_OOM
) {

832 
	`out_of_mem‹y
(
ªgs
, 
îr‹_code
, 
addªss
);

834 i‡(
Áu…
 & (
VM_FAULT_SIGBUS
|
VM_FAULT_HWPOISON
))

835 
	`do_sigbus
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

837 
	`BUG
();

839 
	}
}

841 
	$•urious_Áu…_check
(
îr‹_code
, 
±e_t
 *
±e
)

843 i‡((
îr‹_code
 & 
PF_WRITE
Ë&& !
	`±e_wrôe
(*
±e
))

846 i‡((
îr‹_code
 & 
PF_INSTR
Ë&& !
	`±e_exec
(*
±e
))

850 
	}
}

864 
noölöe
 
__k¥obes
 

865 
	$•urious_Áu…
(
îr‹_code
, 
addªss
)

867 
pgd_t
 *
pgd
;

868 
pud_t
 *
pud
;

869 
pmd_t
 *
pmd
;

870 
±e_t
 *
±e
;

871 
ªt
;

874 i‡(
îr‹_code
 & (
PF_USER
 | 
PF_RSVD
))

877 
pgd
 = 
öô_mm
.pgd + 
	`pgd_ödex
(
addªss
);

878 i‡(!
	`pgd_¥e£¡
(*
pgd
))

881 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

882 i‡(!
	`pud_¥e£¡
(*
pud
))

885 i‡(
	`pud_œrge
(*
pud
))

886  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pud
);

888 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

889 i‡(!
	`pmd_¥e£¡
(*
pmd
))

892 i‡(
	`pmd_œrge
(*
pmd
))

893  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

895 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

896 i‡(!
	`±e_¥e£¡
(*
±e
))

899 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, 
±e
);

900 i‡(!
ªt
)

907 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

908 
	`WARN_ONCE
(!
ªt
, "PMD has incorrectÖermission bits\n");

910  
ªt
;

911 
	}
}

913 
	gshow_unh™dÀd_sig«ls
 = 1;

915 
ölöe
 

916 
	$ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vm_¨ó_°ru˘
 *
vma
)

918 i‡(
wrôe
) {

920 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_WRITE
)))

926 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_PROT
))

930 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

934 
	}
}

936 
	$Áu…_ö_kî√l_•a˚
(
addªss
)

938  
addªss
 >
TASK_SIZE_MAX
;

939 
	}
}

946 
dŸø∂ökage
 
__k¥obes


947 
	$do_∑ge_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

949 
vm_¨ó_°ru˘
 *
vma
;

950 
èsk_°ru˘
 *
tsk
;

951 
addªss
;

952 
mm_°ru˘
 *
mm
;

953 
wrôe
;

954 
Áu…
;

956 
tsk
 = 
cuºít
;

957 
mm
 = 
tsk
->mm;

960 
addªss
 = 
	`ªad_¸2
();

966 i‡(
	`kmemcheck_a˘ive
(
ªgs
))

967 
	`kmemcheck_hide
(
ªgs
);

968 
	`¥e„tchw
(&
mm
->
mm≠_£m
);

970 i‡(
	`u∆ikñy
(
	`kmmio_Áu…
(
ªgs
, 
addªss
)))

986 i‡(
	`u∆ikñy
(
	`Áu…_ö_kî√l_•a˚
(
addªss
))) {

987 i‡(!(
îr‹_code
 & (
PF_RSVD
 | 
PF_USER
 | 
PF_PROT
))) {

988 i‡(
	`vmÆloc_Áu…
(
addªss
) >= 0)

991 i‡(
	`kmemcheck_Áu…
(
ªgs
, 
addªss
, 
îr‹_code
))

996 i‡(
	`•urious_Áu…
(
îr‹_code
, 
addªss
))

1000 i‡(
	`nŸify_∑ge_Áu…
(
ªgs
))

1006 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1012 i‡(
	`u∆ikñy
(
	`nŸify_∑ge_Áu…
(
ªgs
)))

1021 i‡(
	`u£r_mode_vm
(
ªgs
)) {

1022 
	`loˇl_úq_íabÀ
();

1023 
îr‹_code
 |
PF_USER
;

1025 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

1026 
	`loˇl_úq_íabÀ
();

1029 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_RSVD
))

1030 
	`pgèbÀ_bad
(
ªgs
, 
îr‹_code
, 
addªss
);

1032 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS
, 1, 0, 
ªgs
, 
addªss
);

1038 i‡(
	`u∆ikñy
(
	`ö_©omic
(Ë|| !
mm
)) {

1039 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1059 i‡(
	`u∆ikñy
(!
	`down_ªad_åylock
(&
mm
->
mm≠_£m
))) {

1060 i‡((
îr‹_code
 & 
PF_USER
) == 0 &&

1061 !
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
)) {

1062 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1065 
	`down_ªad
(&
mm
->
mm≠_£m
);

1072 
	`might_¶ìp
();

1075 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

1076 i‡(
	`u∆ikñy
(!
vma
)) {

1077 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1080 i‡(
	`likñy
(
vma
->
vm_°¨t
 <
addªss
))

1081 
good_¨ó
;

1082 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))) {

1083 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1086 i‡(
îr‹_code
 & 
PF_USER
) {

1093 i‡(
	`u∆ikñy
(
addªss
 + 65536 + 32 * (Ë< 
ªgs
->
•
)) {

1094 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1098 i‡(
	`u∆ikñy
(
	`ex∑nd_°ack
(
vma
, 
addªss
))) {

1099 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1107 
good_¨ó
:

1108 
wrôe
 = 
îr‹_code
 & 
PF_WRITE
;

1110 i‡(
	`u∆ikñy
(
	`ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vma
))) {

1111 
	`bad_¨ó_ac˚ss_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
);

1120 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
wrôe
 ? 
FAULT_FLAG_WRITE
 : 0);

1122 i‡(
	`u∆ikñy
(
Áu…
 & 
VM_FAULT_ERROR
)) {

1123 
	`mm_Áu…_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

1127 i‡(
Áu…
 & 
VM_FAULT_MAJOR
) {

1128 
tsk
->
maj_Êt
++;

1129 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MAJ
, 1, 0,

1130 
ªgs
, 
addªss
);

1132 
tsk
->
mö_Êt
++;

1133 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MIN
, 1, 0,

1134 
ªgs
, 
addªss
);

1137 
	`check_v8086_mode
(
ªgs
, 
addªss
, 
tsk
);

1139 
	`up_ªad
(&
mm
->
mm≠_£m
);

1140 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<löux/sched.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/vm°©.h
>

10 
	~<löux/highmem.h
>

12 
	~<asm/pgèbÀ.h
>

14 
ölöe
 
±e_t
 
	$gup_gë_±e
(
±e_t
 *
±ï
)

16 #i‚de‡
CONFIG_X86_PAE


17  
	`ACCESS_ONCE
(*
±ï
);

51 
±e_t
 
±e
;

53 
ªåy
:

54 
±e
.
±e_low
 = 
±ï
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±ï
->pte_high;

57 
	`smp_rmb
();

58 i‡(
	`u∆ikñy
(
±e
.
±e_low
 !
±ï
->pte_low))

59 
ªåy
;

61  
±e
;

63 
	}
}

70 
noölöe
 
	$gup_±e_ønge
(
pmd_t
 
pmd
, 
addr
,

71 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

73 
mask
;

74 
±e_t
 *
±ï
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 i‡(
wrôe
)

78 
mask
 |
_PAGE_RW
;

80 
±ï
 = 
	`±e_off£t_m≠
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_gë_±e
(
±ï
);

83 
∑ge
 *page;

85 i‡((
	`±e_Êags
(
±e
Ë& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm≠
(
±ï
);

89 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

90 
∑ge
 = 
	`±e_∑ge
(
±e
);

91 
	`gë_∑ge
(
∑ge
);

92 
∑ges
[*
ƒ
] = 
∑ge
;

93 (*
ƒ
)++;

95 } 
±ï
++, 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

96 
	`±e_unm≠
(
±ï
 - 1);

99 
	}
}

101 
ölöe
 
	$gë_hód_∑ge_mu…ùÀ
(
∑ge
 *∑ge, 
ƒ
)

103 
	`VM_BUG_ON
(
∑ge
 !
	`compound_hód
(page));

104 
	`VM_BUG_ON
(
	`∑ge_cou¡
(
∑ge
) == 0);

105 
	`©omic_add
(
ƒ
, &
∑ge
->
_cou¡
);

106 
	}
}

108 
noölöe
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

111 
mask
;

112 
±e_t
 
±e
 = *’ã_à*)&
pmd
;

113 
∑ge
 *
hód
, *page;

114 
ªfs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 i‡(
wrôe
)

118 
mask
 |
_PAGE_RW
;

119 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

125 
ªfs
 = 0;

126 
hód
 = 
	`±e_∑ge
(
±e
);

127 
∑ge
 = 
hód
 + ((
addr
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

130 
∑ges
[*
ƒ
] = 
∑ge
;

131 (*
ƒ
)++;

132 
∑ge
++;

133 
ªfs
++;

134 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

135 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

138 
	}
}

140 
	$gup_pmd_ønge
(
pud_t
 
pud
, 
addr
, 
íd
,

141 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

143 
√xt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

151 i‡(
	`pmd_n⁄e
(
pmd
))

153 i‡(
	`u∆ikñy
(
	`pmd_œrge
(
pmd
))) {

154 i‡(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

157 i‡(!
	`gup_±e_ønge
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

160 } 
pmdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

163 
	}
}

165 
noölöe
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

168 
mask
;

169 
±e_t
 
±e
 = *’ã_à*)&
pud
;

170 
∑ge
 *
hód
, *page;

171 
ªfs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 i‡(
wrôe
)

175 
mask
 |
_PAGE_RW
;

176 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

182 
ªfs
 = 0;

183 
hód
 = 
	`±e_∑ge
(
±e
);

184 
∑ge
 = 
hód
 + ((
addr
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

187 
∑ges
[*
ƒ
] = 
∑ge
;

188 (*
ƒ
)++;

189 
∑ge
++;

190 
ªfs
++;

191 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

192 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

195 
	}
}

197 
	$gup_pud_ønge
(
pgd_t
 
pgd
, 
addr
, 
íd
,

198 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

200 
√xt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
√xt
 = 
	`pud_addr_íd
(
addr
, 
íd
);

208 i‡(
	`pud_n⁄e
(
pud
))

210 i‡(
	`u∆ikñy
(
	`pud_œrge
(
pud
))) {

211 i‡(!
	`gup_huge_pud
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

214 i‡(!
	`gup_pmd_ønge
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

217 } 
pudp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

220 
	}
}

226 
	$__gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

227 
∑ge
 **
∑ges
)

229 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

230 
addr
, 
Àn
, 
íd
;

231 
√xt
;

232 
Êags
;

233 
pgd_t
 *
pgdp
;

234 
ƒ
 = 0;

236 
°¨t
 &
PAGE_MASK
;

237 
addr
 = 
°¨t
;

238 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

239 
íd
 = 
°¨t
 + 
Àn
;

240 i‡(
	`u∆ikñy
(!
	`ac˚ss_ok
(
wrôe
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

241 (
__u£r
 *)
°¨t
, 
Àn
)))

262 
	`loˇl_úq_ßve
(
Êags
);

263 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

265 
pgd_t
 
pgd
 = *
pgdp
;

267 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

268 i‡(
	`pgd_n⁄e
(
pgd
))

270 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

272 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

273 
	`loˇl_úq_ª°‹e
(
Êags
);

275  
ƒ
;

276 
	}
}

294 
	$gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

295 
∑ge
 **
∑ges
)

297 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

298 
addr
, 
Àn
, 
íd
;

299 
√xt
;

300 
pgd_t
 *
pgdp
;

301 
ƒ
 = 0;

303 
°¨t
 &
PAGE_MASK
;

304 
addr
 = 
°¨t
;

305 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

307 
íd
 = 
°¨t
 + 
Àn
;

308 i‡(
íd
 < 
°¨t
)

309 
¶ow_úq⁄
;

311 #ifde‡
CONFIG_X86_64


312 i‡(
íd
 >> 
__VIRTUAL_MASK_SHIFT
)

313 
¶ow_úq⁄
;

334 
	`loˇl_úq_dißbÀ
();

335 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

337 
pgd_t
 
pgd
 = *
pgdp
;

339 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

340 i‡(
	`pgd_n⁄e
(
pgd
))

341 
¶ow
;

342 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

343 
¶ow
;

344 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

345 
	`loˇl_úq_íabÀ
();

347 
	`VM_BUG_ON
(
ƒ
 !(
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

348  
ƒ
;

351 
ªt
;

353 
¶ow
:

354 
	`loˇl_úq_íabÀ
();

355 
¶ow_úq⁄
:

357 
°¨t
 +
ƒ
 << 
PAGE_SHIFT
;

358 
∑ges
 +
ƒ
;

360 
	`down_ªad
(&
mm
->
mm≠_£m
);

361 
ªt
 = 
	`gë_u£r_∑ges
(
cuºít
, 
mm
, 
°¨t
,

362 (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
, 
wrôe
, 0, 
∑ges
, 
NULL
);

363 
	`up_ªad
(&
mm
->
mm≠_£m
);

366 i‡(
ƒ
 > 0) {

367 i‡(
ªt
 < 0)

368 
ªt
 = 
ƒ
;

370 
ªt
 +
ƒ
;

373  
ªt
;

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<löux/öô.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/hugëlb.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/îr.h
>

13 
	~<löux/sys˘l.h
>

14 
	~<asm/mm™.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/pgÆloc.h
>

19 
	$∑ge_èbÀ_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
svma
,

20 
vm_¨ó_°ru˘
 *
vma
,

21 
addr
, 
pgoff_t
 
idx
)

23 
ßddr
 = ((
idx
 - 
svma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
) +

24 
svma
->
vm_°¨t
;

25 
sba£
 = 
ßddr
 & 
PUD_MASK
;

26 
s_íd
 = 
sba£
 + 
PUD_SIZE
;

29 
vm_Êags
 = 
vma
->vm_Êag†& ~
VM_LOCKED
;

30 
svm_Êags
 = 
svma
->
vm_Êags
 & ~
VM_LOCKED
;

36 i‡(
	`pmd_ödex
(
addr
Ë!pmd_ödex(
ßddr
) ||

37 
vm_Êags
 !
svm_Êags
 ||

38 
sba£
 < 
svma
->
vm_°¨t
 || svma->
vm_íd
 < 
s_íd
)

41  
ßddr
;

42 
	}
}

44 
	$vma_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

46 
ba£
 = 
addr
 & 
PUD_MASK
;

47 
íd
 = 
ba£
 + 
PUD_SIZE
;

52 i‡(
vma
->
vm_Êags
 & 
VM_MAYSHARE
 &&

53 
vma
->
vm_°¨t
 <
ba£
 && 
íd
 <vma->
vm_íd
)

56 
	}
}

61 
	$huge_pmd_sh¨e
(
mm_°ru˘
 *
mm
, 
addr
, 
pud_t
 *
pud
)

63 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

64 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

65 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_°¨t
Ë>> 
PAGE_SHIFT
) +

66 
vma
->
vm_pgoff
;

67 
¥io_åì_ôî
 
ôî
;

68 
vm_¨ó_°ru˘
 *
svma
;

69 
ßddr
;

70 
±e_t
 *
•ã
 = 
NULL
;

72 i‡(!
	`vma_sh¨óbÀ
(
vma
, 
addr
))

75 
	`•ö_lock
(&
m≠pög
->
i_mm≠_lock
);

76 
	`vma_¥io_åì_f‹óch
(
svma
, &
ôî
, &
m≠pög
->
i_mm≠
, 
idx
, idx) {

77 i‡(
svma
 =
vma
)

80 
ßddr
 = 
	`∑ge_èbÀ_sh¨óbÀ
(
svma
, 
vma
, 
addr
, 
idx
);

81 i‡(
ßddr
) {

82 
•ã
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
ßddr
);

83 i‡(
•ã
) {

84 
	`gë_∑ge
(
	`vút_to_∑ge
(
•ã
));

90 i‡(!
•ã
)

91 
out
;

93 
	`•ö_lock
(&
mm
->
∑ge_èbÀ_lock
);

94 i‡(
	`pud_n⁄e
(*
pud
))

95 
	`pud_p›uœã
(
mm
, 
pud
, (
pmd_t
 *)(()
•ã
 & 
PAGE_MASK
));

97 
	`put_∑ge
(
	`vút_to_∑ge
(
•ã
));

98 
	`•ö_u∆ock
(&
mm
->
∑ge_èbÀ_lock
);

99 
out
:

100 
	`•ö_u∆ock
(&
m≠pög
->
i_mm≠_lock
);

101 
	}
}

115 
	$huge_pmd_unsh¨e
(
mm_°ru˘
 *
mm
, *
addr
, 
±e_t
 *
±ï
)

117 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

118 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

120 
	`BUG_ON
(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 0);

121 i‡(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 1)

124 
	`pud_˛ór
(
pud
);

125 
	`put_∑ge
(
	`vút_to_∑ge
(
±ï
));

126 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

128 
	}
}

130 
±e_t
 *
	$huge_±e_Æloc
(
mm_°ru˘
 *
mm
,

131 
addr
, 
sz
)

133 
pgd_t
 *
pgd
;

134 
pud_t
 *
pud
;

135 
±e_t
 *
±e
 = 
NULL
;

137 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

138 
pud
 = 
	`pud_Æloc
(
mm
, 
pgd
, 
addr
);

139 i‡(
pud
) {

140 i‡(
sz
 =
PUD_SIZE
) {

141 
±e
 = (
±e_t
 *)
pud
;

143 
	`BUG_ON
(
sz
 !
PMD_SIZE
);

144 i‡(
	`pud_n⁄e
(*
pud
))

145 
	`huge_pmd_sh¨e
(
mm
, 
addr
, 
pud
);

146 
±e
 = (
±e_t
 *Ë
	`pmd_Æloc
(
mm
, 
pud
, 
addr
);

149 
	`BUG_ON
(
±e
 && !
	`±e_n⁄e
(*±eË&& !
	`±e_huge
(*pte));

151  
±e
;

152 
	}
}

154 
±e_t
 *
	$huge_±e_off£t
(
mm_°ru˘
 *
mm
, 
addr
)

156 
pgd_t
 *
pgd
;

157 
pud_t
 *
pud
;

158 
pmd_t
 *
pmd
 = 
NULL
;

160 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

161 i‡(
	`pgd_¥e£¡
(*
pgd
)) {

162 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

163 i‡(
	`pud_¥e£¡
(*
pud
)) {

164 i‡(
	`pud_œrge
(*
pud
))

165  (
±e_t
 *)
pud
;

166 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

169  (
±e_t
 *Ë
pmd
;

170 
	}
}

173 
∑ge
 *

174 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

176 
°¨t
 = 
addªss
;

177 
Àngth
 = 1;

178 
ƒ
;

179 
∑ge
 *page;

180 
vm_¨ó_°ru˘
 *
vma
;

182 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

183 i‡(!
vma
 || !
	`is_vm_hugëlb_∑ge
(vma))

184  
	`ERR_PTR
(-
EINVAL
);

186 
±e
 = 
	`huge_±e_off£t
(
mm
, 
addªss
);

189 
	`WARN_ON
(!
±e
 || 
	`±e_n⁄e
(*pte));

191 
∑ge
 = &
	`±e_∑ge
(*
±e
)[
vp‚
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

193 
	`WARN_ON
(!
	`PageHód
(
∑ge
));

195  
∑ge
;

196 
	}
}

198 
	$pmd_huge
(
pmd_t
 
pmd
)

201 
	}
}

203 
	$pud_huge
(
pud_t
 
pud
)

206 
	}
}

208 
∑ge
 *

209 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

210 
pmd_t
 *
pmd
, 
wrôe
)

212  
NULL
;

213 
	}
}

217 
∑ge
 *

218 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

220  
	`ERR_PTR
(-
EINVAL
);

221 
	}
}

223 
	$pmd_huge
(
pmd_t
 
pmd
)

225  !!(
	`pmd_vÆ
(
pmd
Ë& 
_PAGE_PSE
);

226 
	}
}

228 
	$pud_huge
(
pud_t
 
pud
)

230  !!(
	`pud_vÆ
(
pud
Ë& 
_PAGE_PSE
);

231 
	}
}

233 
∑ge
 *

234 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

235 
pmd_t
 *
pmd
, 
wrôe
)

237 
∑ge
 *page;

239 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pmd
);

240 i‡(
∑ge
)

241 
∑ge
 +((
addªss
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

242  
∑ge
;

243 
	}
}

245 
∑ge
 *

246 
	$fﬁlow_huge_pud
(
mm_°ru˘
 *
mm
, 
addªss
,

247 
pud_t
 *
pud
, 
wrôe
)

249 
∑ge
 *page;

251 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pud
);

252 i‡(
∑ge
)

253 
∑ge
 +((
addªss
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

254  
∑ge
;

255 
	}
}

261 #ifde‡
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


262 
	$hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
 *file,

263 
addr
, 
Àn
,

264 
pgoff
, 
Êags
)

266 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

267 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

268 
vm_¨ó_°ru˘
 *
vma
;

269 
°¨t_addr
;

271 i‡(
Àn
 > 
mm
->
ˇched_hﬁe_size
) {

272 
°¨t_addr
 = 
mm
->
‰ì_¨ó_ˇche
;

274 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

275 
mm
->
ˇched_hﬁe_size
 = 0;

278 
fuŒ_£¨ch
:

279 
addr
 = 
	`ALIGN
(
°¨t_addr
, 
	`huge_∑ge_size
(
h
));

281 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

283 i‡(
TASK_SIZE
 - 
Àn
 < 
addr
) {

288 i‡(
°¨t_addr
 !
TASK_UNMAPPED_BASE
) {

289 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

290 
mm
->
ˇched_hﬁe_size
 = 0;

291 
fuŒ_£¨ch
;

293  -
ENOMEM
;

295 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

296 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

297  
addr
;

299 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

300 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

301 
addr
 = 
	`ALIGN
(
vma
->
vm_íd
, 
	`huge_∑ge_size
(
h
));

303 
	}
}

305 
	$hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
 *file,

306 
addr0
, 
Àn
,

307 
pgoff
, 
Êags
)

309 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

310 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

311 
vm_¨ó_°ru˘
 *
vma
, *
¥ev_vma
;

312 
ba£
 = 
mm
->
mm≠_ba£
, 
addr
 = 
addr0
;

313 
œrge°_hﬁe
 = 
mm
->
ˇched_hﬁe_size
;

314 
fú°_time
 = 1;

317 i‡(
mm
->
‰ì_¨ó_ˇche
 > 
ba£
)

318 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

320 i‡(
Àn
 <
œrge°_hﬁe
) {

321 
œrge°_hﬁe
 = 0;

322 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

324 
åy_agaö
:

326 i‡(
mm
->
‰ì_¨ó_ˇche
 < 
Àn
)

327 
Áû
;

330 
addr
 = (
mm
->
‰ì_¨ó_ˇche
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

336 i‡(!(
vma
 = 
	`föd_vma_¥ev
(
mm
, 
addr
, &
¥ev_vma
)))

337  
addr
;

343 i‡(
addr
 + 
Àn
 <
vma
->
vm_°¨t
 &&

344 (!
¥ev_vma
 || (
addr
 >¥ev_vma->
vm_íd
))) {

346 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

347  (
mm
->
‰ì_¨ó_ˇche
 = 
addr
);

350 i‡(
mm
->
‰ì_¨ó_ˇche
 =
vma
->
vm_íd
) {

351 
mm
->
‰ì_¨ó_ˇche
 = 
vma
->
vm_°¨t
;

352 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

357 i‡(
addr
 + 
œrge°_hﬁe
 < 
vma
->
vm_°¨t
)

358 
œrge°_hﬁe
 = 
vma
->
vm_°¨t
 - 
addr
;

361 
addr
 = (
vma
->
vm_°¨t
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

362 } 
Àn
 <
vma
->
vm_°¨t
);

364 
Áû
:

369 i‡(
fú°_time
) {

370 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

371 
œrge°_hﬁe
 = 0;

372 
fú°_time
 = 0;

373 
åy_agaö
;

381 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

382 
mm
->
ˇched_hﬁe_size
 = ~0UL;

383 
addr
 = 
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr0
,

384 
Àn
, 
pgoff
, 
Êags
);

389 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

390 
mm
->
ˇched_hﬁe_size
 = ~0UL;

392  
addr
;

393 
	}
}

396 
	$hugëlb_gë_unm≠≥d_¨ó
(
fûe
 *fûe, 
addr
,

397 
Àn
, 
pgoff
, 
Êags
)

399 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

400 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

401 
vm_¨ó_°ru˘
 *
vma
;

403 i‡(
Àn
 & ~
	`huge_∑ge_mask
(
h
))

404  -
EINVAL
;

405 i‡(
Àn
 > 
TASK_SIZE
)

406  -
ENOMEM
;

408 i‡(
Êags
 & 
MAP_FIXED
) {

409 i‡(
	`¥ï¨e_hugïage_ønge
(
fûe
, 
addr
, 
Àn
))

410  -
EINVAL
;

411  
addr
;

414 i‡(
addr
) {

415 
addr
 = 
	`ALIGN
◊ddr, 
	`huge_∑ge_size
(
h
));

416 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

417 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

418 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

419  
addr
;

421 i‡(
mm
->
gë_unm≠≥d_¨ó
 =
¨ch_gë_unm≠≥d_¨ó
)

422  
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr
, 
Àn
,

423 
pgoff
, 
Êags
);

425  
	`hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
, 
addr
, 
Àn
,

426 
pgoff
, 
Êags
);

427 
	}
}

431 #ifde‡
CONFIG_X86_64


432 
__öô
 
	$£tup_hugïagesz
(*
›t
)

434 
ps
 = 
	`mem∑r£
(
›t
, &opt);

435 i‡(
ps
 =
PMD_SIZE
) {

436 
	`hugëlb_add_h°©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

437 } i‡(
ps
 =
PUD_SIZE
 && 
˝u_has_gb∑ges
) {

438 
	`hugëlb_add_h°©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

440 
	`¥ötk
(
KERN_ERR
 "hugepagesz: UnsupportedÖage size %lu M\n",

441 
ps
 >> 20);

445 
	}
}

446 
__£tup
("hugïagesz=", 
£tup_hugïagesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<löux/gÂ.h
>

2 
	~<löux/öôrd.h
>

3 
	~<löux/i›‹t.h
>

4 
	~<löux/sw≠.h
>

6 
	~<asm/ˇcheÊush.h
>

7 
	~<asm/e820.h
>

8 
	~<asm/öô.h
>

9 
	~<asm/∑ge.h
>

10 
	~<asm/∑ge_ty≥s.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/£tup.h
>

13 
	~<asm/sy°em.h
>

14 
	~<asm/ébÊush.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/¥Ÿo.h
>

18 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

20 
__öôd©a
 
	ge820_èbÀ_°¨t
;

21 
__memöôd©a
 
	ge820_èbÀ_íd
;

22 
__memöôd©a
 
	ge820_èbÀ_t›
;

24 
	ga·î_boŸmem
;

26 
	gdúe˘_gb∑ges


27 #ifde‡
CONFIG_DIRECT_GBPAGES


32 
__öô
 
	$föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
,

33 
u£_gb∑ges
)

35 
puds
, 
pmds
, 
±es
, 
èbÀs
, 
°¨t
;

37 
puds
 = (
íd
 + 
PUD_SIZE
 - 1Ë>> 
PUD_SHIFT
;

38 
èbÀs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

40 i‡(
u£_gb∑ges
) {

41 
exåa
;

43 
exåa
 = 
íd
 - (”nd>>
PUD_SHIFT
) << PUD_SHIFT);

44 
pmds
 = (
exåa
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

46 
pmds
 = (
íd
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

48 
èbÀs
 +
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

50 i‡(
u£_p£
) {

51 
exåa
;

53 
exåa
 = 
íd
 - (”nd>>
PMD_SHIFT
) << PMD_SHIFT);

54 #ifde‡
CONFIG_X86_32


55 
exåa
 +
PMD_SIZE
;

57 
±es
 = (
exåa
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

59 
±es
 = (
íd
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

61 
èbÀs
 +
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

63 #ifde‡
CONFIG_X86_32


65 
èbÀs
 +
	`roundup
(
__íd_of_fixed_addªs£s
 * (
±e_t
), 
PAGE_SIZE
);

73 #ifde‡
CONFIG_X86_32


74 
°¨t
 = 0x7000;

76 
°¨t
 = 0x8000;

78 
e820_èbÀ_°¨t
 = 
	`föd_e820_¨ó
(
°¨t
, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
,

79 
èbÀs
, 
PAGE_SIZE
);

80 i‡(
e820_èbÀ_°¨t
 == -1UL)

81 
	`∑nic
("Cannot find space forÅhe kernelÖageÅables");

83 
e820_èbÀ_°¨t
 >>
PAGE_SHIFT
;

84 
e820_èbÀ_íd
 = 
e820_èbÀ_°¨t
;

85 
e820_èbÀ_t›
 = 
e820_èbÀ_°¨t
 + (
èbÀs
 >> 
PAGE_SHIFT
);

87 
	`¥ötk
(
KERN_DEBUG
 "kernel direct mappingÅables upÅo %lx @ %lx-%lx\n",

88 
íd
, 
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
, 
e820_èbÀ_t›
 << PAGE_SHIFT);

89 
	}
}

91 
	sm≠_ønge
 {

92 
	m°¨t
;

93 
	míd
;

94 
	m∑ge_size_mask
;

97 #ifde‡
CONFIG_X86_32


98 
	#NR_RANGE_MR
 3

	)

100 
	#NR_RANGE_MR
 5

	)

103 
__memöô
 
	$ßve_mr
(
m≠_ønge
 *
mr
, 
ƒ_ønge
,

104 
°¨t_p‚
, 
íd_p‚
,

105 
∑ge_size_mask
)

107 i‡(
°¨t_p‚
 < 
íd_p‚
) {

108 i‡(
ƒ_ønge
 >
NR_RANGE_MR
)

109 
	`∑nic
("run out ofÑange for init_memory_mapping\n");

110 
mr
[
ƒ_ønge
].
°¨t
 = 
°¨t_p‚
<<
PAGE_SHIFT
;

111 
mr
[
ƒ_ønge
].
íd
 = 
íd_p‚
<<
PAGE_SHIFT
;

112 
mr
[
ƒ_ønge
].
∑ge_size_mask
 =Öage_size_mask;

113 
ƒ_ønge
++;

116  
ƒ_ønge
;

117 
	}
}

124 
__öô_ªfok
 
	$öô_mem‹y_m≠pög
(
°¨t
,

125 
íd
)

127 
∑ge_size_mask
 = 0;

128 
°¨t_p‚
, 
íd_p‚
;

129 
ªt
 = 0;

130 
pos
;

132 
m≠_ønge
 
mr
[
NR_RANGE_MR
];

133 
ƒ_ønge
, 
i
;

134 
u£_p£
, 
u£_gb∑ges
;

136 
	`¥ötk
(
KERN_INFO
 "öô_mem‹y_m≠pög: %016lx-%016lx\n", 
°¨t
, 
íd
);

138 #i‡
	`deföed
(
CONFIG_DEBUG_PAGEALLOC
Ë|| deföed(
CONFIG_KMEMCHECK
)

144 
u£_p£
 = 
u£_gb∑ges
 = 0;

146 
u£_p£
 = 
˝u_has_p£
;

147 
u£_gb∑ges
 = 
dúe˘_gb∑ges
;

151 i‡(
˝u_has_p£
)

152 
	`£t_ö_¸4
(
X86_CR4_PSE
);

155 i‡(
˝u_has_pge
) {

156 
	`£t_ö_¸4
(
X86_CR4_PGE
);

157 
__suµ‹ãd_±e_mask
 |
_PAGE_GLOBAL
;

160 i‡(
u£_gb∑ges
)

161 
∑ge_size_mask
 |1 << 
PG_LEVEL_1G
;

162 i‡(
u£_p£
)

163 
∑ge_size_mask
 |1 << 
PG_LEVEL_2M
;

165 
	`mem£t
(
mr
, 0, (mr));

166 
ƒ_ønge
 = 0;

169 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

170 
pos
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

171 #ifde‡
CONFIG_X86_32


178 i‡(
pos
 == 0)

179 
íd_p‚
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

181 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

182 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

184 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1)Ë>> 
PMD_SHIFT
)

185 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

187 i‡(
íd_p‚
 > (
íd
 >> 
PAGE_SHIFT
))

188 
íd_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

189 i‡(
°¨t_p‚
 < 
íd_p‚
) {

190 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

191 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

195 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

196 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

197 #ifde‡
CONFIG_X86_32


198 
íd_p‚
 = (
íd
>>
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

200 
íd_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

201 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

202 i‡(
íd_p‚
 > ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

203 
íd_p‚
 = ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

206 i‡(
°¨t_p‚
 < 
íd_p‚
) {

207 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

208 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

209 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

212 #ifde‡
CONFIG_X86_64


214 
°¨t_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

215 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

216 
íd_p‚
 = (
íd
 >> 
PUD_SHIFT
Ë<< (PUD_SHIFT - 
PAGE_SHIFT
);

217 i‡(
°¨t_p‚
 < 
íd_p‚
) {

218 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

219 
∑ge_size_mask
 &

220 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

221 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

225 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

226 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

227 
íd_p‚
 = (
íd
 >> 
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

228 i‡(
°¨t_p‚
 < 
íd_p‚
) {

229 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

230 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

231 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

236 
°¨t_p‚
 = 
pos
>>
PAGE_SHIFT
;

237 
íd_p‚
 = 
íd
>>
PAGE_SHIFT
;

238 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

241 
i
 = 0; 
ƒ_ønge
 > 1 && i <Çr_range - 1; i++) {

242 
ﬁd_°¨t
;

243 i‡(
mr
[
i
].
íd
 !mr[i+1].
°¨t
 ||

244 
mr
[
i
].
∑ge_size_mask
 != mr[i+1].page_size_mask)

247 
ﬁd_°¨t
 = 
mr
[
i
].
°¨t
;

248 
	`memmove
(&
mr
[
i
], &mr[i+1],

249 (
ƒ_ønge
 - 1 - 
i
Ë* (
m≠_ønge
));

250 
mr
[
i
--].
°¨t
 = 
ﬁd_°¨t
;

251 
ƒ_ønge
--;

254 
i
 = 0; i < 
ƒ_ønge
; i++)

255 
	`¥ötk
(
KERN_DEBUG
 " %010lx - %010lxÖage %s\n",

256 
mr
[
i
].
°¨t
, mr[i].
íd
,

257 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

258 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

267 i‡(!
a·î_boŸmem
)

268 
	`föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
, 
u£_gb∑ges
);

270 
i
 = 0; i < 
ƒ_ønge
; i++)

271 
ªt
 = 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

272 
mr
[
i
].
∑ge_size_mask
);

274 #ifde‡
CONFIG_X86_32


275 
	`óæy_i‹em≠_∑ge_èbÀ_ønge_öô
();

277 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

280 #ifde‡
CONFIG_X86_64


281 i‡(!
a·î_boŸmem
 && !
°¨t
) {

282 
pud_t
 *
pud
;

283 
pmd_t
 *
pmd
;

285 
mmu_¸4_„©uªs
 = 
	`ªad_¸4
();

293 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_íd
), _brk_end);

294 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_íd
 - 1);

295 ++
pmd
 <
	`pmd_off£t
(
pud
, ()
_íd
 - 1))

296 
	`pmd_˛ór
(
pmd
);

299 
	`__Êush_éb_Æl
();

301 i‡(!
a·î_boŸmem
 && 
e820_èbÀ_íd
 > 
e820_èbÀ_°¨t
)

302 
	`ª£rve_óæy
(
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
,

303 
e820_èbÀ_íd
 << 
PAGE_SHIFT
, "PGTABLE");

305 i‡(!
a·î_boŸmem
)

306 
	`óæy_memã°
(
°¨t
, 
íd
);

308  
ªt
 >> 
PAGE_SHIFT
;

309 
	}
}

322 
	$devmem_is_Ælowed
(
∑gír
)

324 i‡(
∑gír
 <= 256)

326 i‡(
	`iomem_is_ex˛usive
(
∑gír
 << 
PAGE_SHIFT
))

328 i‡(!
	`∑ge_is_øm
(
∑gír
))

331 
	}
}

333 
	$‰ì_öô_∑ges
(*
wh©
, 
begö
, 
íd
)

335 
addr
;

336 
begö_Æig√d
, 
íd_Æig√d
;

339 
begö_Æig√d
 = 
	`PAGE_ALIGN
(
begö
);

340 
íd_Æig√d
 = 
íd
 & 
PAGE_MASK
;

342 i‡(
	`WARN_ON
(
begö_Æig√d
 !
begö
 || 
íd_Æig√d
 !
íd
)) {

343 
begö
 = 
begö_Æig√d
;

344 
íd
 = 
íd_Æig√d
;

347 i‡(
begö
 >
íd
)

350 
addr
 = 
begö
;

357 #ifde‡
CONFIG_DEBUG_PAGEALLOC


358 
	`¥ötk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

359 
begö
, 
íd
);

360 
	`£t_mem‹y_≈
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

367 
	`£t_mem‹y_rw
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

369 
	`¥ötk
(
KERN_INFO
 "Fªeög %s: %luk fªed\n", 
wh©
, (
íd
 - 
begö
) >> 10);

371 ; 
addr
 < 
íd
;ádd∏+
PAGE_SIZE
) {

372 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
addr
));

373 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
addr
));

374 
	`mem£t
((*)
addr
, 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

375 
	`‰ì_∑ge
(
addr
);

376 
tŸÆøm_∑ges
++;

379 
	}
}

381 
	$‰ì_öômem
()

383 
	`‰ì_öô_∑ges
("unused kernel memory",

384 ()(&
__öô_begö
),

385 ()(&
__öô_íd
));

386 
	}
}

388 #ifde‡
CONFIG_BLK_DEV_INITRD


389 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

400 
	`‰ì_öô_∑ges
("öôrd mem‹y", 
°¨t
, 
	`PAGE_ALIGN
(
íd
));

401 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<löux/sig«l.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/mm™.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sw≠.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/∑gem≠.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/¥oc_fs.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/p‚.h
>

27 
	~<löux/pois⁄.h
>

28 
	~<löux/dma-m≠pög.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/mem‹y_hŸ∂ug.h
>

31 
	~<löux/nmi.h
>

32 
	~<löux/gÂ.h
>

34 
	~<asm/¥o˚ss‹.h
>

35 
	~<asm/bios_ebda.h
>

36 
	~<asm/sy°em.h
>

37 
	~<asm/uac˚ss.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/pgÆloc.h
>

40 
	~<asm/dma.h
>

41 
	~<asm/fixm≠.h
>

42 
	~<asm/e820.h
>

43 
	~<asm/≠ic.h
>

44 
	~<asm/éb.h
>

45 
	~<asm/mmu_c⁄ãxt.h
>

46 
	~<asm/¥Ÿo.h
>

47 
	~<asm/smp.h
>

48 
	~<asm/£˘i⁄s.h
>

49 
	~<asm/kdebug.h
>

50 
	~<asm/numa.h
>

51 
	~<asm/ˇcheÊush.h
>

52 
	~<asm/öô.h
>

53 
	~<löux/boŸmem.h
>

55 
dma_ª£rve
 
	g__öôd©a
;

57 
__öô
 
	$∑r£_dúe˘_gb∑ges_off
(*
¨g
)

59 
dúe˘_gb∑ges
 = 0;

61 
	}
}

62 
óæy_∑øm
("nogb∑ges", 
∑r£_dúe˘_gb∑ges_off
);

64 
__öô
 
	$∑r£_dúe˘_gb∑ges_⁄
(*
¨g
)

66 
dúe˘_gb∑ges
 = 1;

68 
	}
}

69 
óæy_∑øm
("gb∑ges", 
∑r£_dúe˘_gb∑ges_⁄
);

77 
±evÆ_t
 
__suµ‹ãd_±e_mask
 
	g__ªad_mo°ly
 = ~
_PAGE_IOMAP
;

78 
EXPORT_SYMBOL_GPL
(
__suµ‹ãd_±e_mask
);

80 
	gf‹˚_≥rs⁄Æôy32
;

90 
__öô
 
	$n⁄x32_£tup
(*
°r
)

92 i‡(!
	`°rcmp
(
°r
, "on"))

93 
f‹˚_≥rs⁄Æôy32
 &~
READ_IMPLIES_EXEC
;

94 i‡(!
	`°rcmp
(
°r
, "off"))

95 
f‹˚_≥rs⁄Æôy32
 |
READ_IMPLIES_EXEC
;

97 
	}
}

98 
__£tup
("n€xec32=", 
n⁄x32_£tup
);

104 
__ªf
 *
	$•p_gë∑ge
()

106 *
±r
;

108 i‡(
a·î_boŸmem
)

109 
±r
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

111 
±r
 = 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

113 i‡(!
±r
 || ((Ìå & ~
PAGE_MASK
)) {

114 
	`∑nic
("set_pte_phys: cannotállocateÖage data %s\n",

115 
a·î_boŸmem
 ? "after bootmem" : "");

118 
	`¥_debug
("•p_gë∑gê%p\n", 
±r
);

120  
±r
;

121 
	}
}

123 
pud_t
 *
	$fûl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

125 i‡(
	`pgd_n⁄e
(*
pgd
)) {

126 
pud_t
 *
pud
 = (pud_à*)
	`•p_gë∑ge
();

127 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
pud
);

128 i‡(
pud
 !
	`pud_off£t
(
pgd
, 0))

129 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

130 
pud
, 
	`pud_off£t
(
pgd
, 0));

132  
	`pud_off£t
(
pgd
, 
vaddr
);

133 
	}
}

135 
pmd_t
 *
	$fûl_pmd
(
pud_t
 *
pud
, 
vaddr
)

137 i‡(
	`pud_n⁄e
(*
pud
)) {

138 
pmd_t
 *
pmd
 = (pmd_à*Ë
	`•p_gë∑ge
();

139 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
pmd
);

140 i‡(
pmd
 !
	`pmd_off£t
(
pud
, 0))

141 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

142 
pmd
, 
	`pmd_off£t
(
pud
, 0));

144  
	`pmd_off£t
(
pud
, 
vaddr
);

145 
	}
}

147 
±e_t
 *
	$fûl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

149 i‡(
	`pmd_n⁄e
(*
pmd
)) {

150 
±e_t
 *
±e
 = (±e_à*Ë
	`•p_gë∑ge
();

151 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
±e
);

152 i‡(
±e
 !
	`±e_off£t_kî√l
(
pmd
, 0))

153 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

155  
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

156 
	}
}

158 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_∑ge
, 
vaddr
, 
±e_t
 
√w_±e
)

160 
pud_t
 *
pud
;

161 
pmd_t
 *
pmd
;

162 
±e_t
 *
±e
;

164 
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
vaddr
);

165 
pmd
 = 
	`fûl_pmd
(
pud
, 
vaddr
);

166 
±e
 = 
	`fûl_±e
(
pmd
, 
vaddr
);

168 
	`£t_±e
(
±e
, 
√w_±e
);

174 
	`__Êush_éb_⁄e
(
vaddr
);

175 
	}
}

177 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±evÆ
)

179 
pgd_t
 *
pgd
;

180 
pud_t
 *
pud_∑ge
;

182 
	`¥_debug
("£t_±e_vadd∏%lxÅÿ%lx\n", 
vaddr
, 
	`«tive_±e_vÆ
(
±evÆ
));

184 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

185 i‡(
	`pgd_n⁄e
(*
pgd
)) {

186 
	`¥ötk
(
KERN_ERR


190 
pud_∑ge
 = (
pud_t
*)
	`pgd_∑ge_vaddr
(*
pgd
);

191 
	`£t_±e_vaddr_pud
(
pud_∑ge
, 
vaddr
, 
±evÆ
);

192 
	}
}

194 
pmd_t
 * 
__öô
 
	$p›uœã_exåa_pmd
(
vaddr
)

196 
pgd_t
 *
pgd
;

197 
pud_t
 *
pud
;

199 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

200 
pud
 = 
	`fûl_pud
(
pgd
, 
vaddr
);

201  
	`fûl_pmd
(
pud
, 
vaddr
);

202 
	}
}

204 
±e_t
 * 
__öô
 
	$p›uœã_exåa_±e
(
vaddr
)

206 
pmd_t
 *
pmd
;

208 
pmd
 = 
	`p›uœã_exåa_pmd
(
vaddr
);

209  
	`fûl_±e
(
pmd
, 
vaddr
);

210 
	}
}

215 
__öô
 
	$__öô_exåa_m≠pög
(
phys
, 
size
,

216 
pg¥Ÿ_t
 
¥Ÿ
)

218 
pgd_t
 *
pgd
;

219 
pud_t
 *
pud
;

220 
pmd_t
 *
pmd
;

222 
	`BUG_ON
((
phys
 & ~
PMD_MASK
Ë|| (
size
 & ~PMD_MASK));

223 ; 
size
; 
phys
 +
PMD_SIZE
, size -= PMD_SIZE) {

224 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

225 i‡(
	`pgd_n⁄e
(*
pgd
)) {

226 
pud
 = (
pud_t
 *Ë
	`•p_gë∑ge
();

227 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
 |

228 
_PAGE_USER
));

230 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

231 i‡(
	`pud_n⁄e
(*
pud
)) {

232 
pmd
 = (
pmd_t
 *Ë
	`•p_gë∑ge
();

233 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
 |

234 
_PAGE_USER
));

236 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

237 
	`BUG_ON
(!
	`pmd_n⁄e
(*
pmd
));

238 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg¥Ÿ_vÆ
(
¥Ÿ
)));

240 
	}
}

242 
__öô
 
	$öô_exåa_m≠pög_wb
(
phys
, 
size
)

244 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

245 
	}
}

247 
__öô
 
	$öô_exåa_m≠pög_uc
(
phys
, 
size
)

249 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

250 
	}
}

265 
__öô
 
	$˛ónup_highm≠
()

267 
vaddr
 = 
__START_KERNEL_m≠
;

268 
íd
 = 
	`roundup
(()
_íd
, 
PMD_SIZE
) - 1;

269 
pmd_t
 *
pmd
 = 
Àvñ2_kî√l_pgt
;

270 
pmd_t
 *
œ°_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

272 ; 
pmd
 < 
œ°_pmd
;Ömd++, 
vaddr
 +
PMD_SIZE
) {

273 i‡(
	`pmd_n⁄e
(*
pmd
))

275 i‡(
vaddr
 < (Ë
_ãxt
 || vadd∏> 
íd
)

276 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

278 
	}
}

280 
__ªf
 *
	$Æloc_low_∑ge
(*
phys
)

282 
p‚
 = 
e820_èbÀ_íd
++;

283 *
adr
;

285 i‡(
a·î_boŸmem
) {

286 
adr
 = (*)
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

287 *
phys
 = 
	`__∑
(
adr
);

289  
adr
;

292 i‡(
p‚
 >
e820_èbÀ_t›
)

293 
	`∑nic
("alloc_low_page:Ñan out of memory");

295 
adr
 = 
	`óæy_memªm≠
(
p‚
 * 
PAGE_SIZE
, PAGE_SIZE);

296 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

297 *
phys
 = 
p‚
 * 
PAGE_SIZE
;

298  
adr
;

299 
	}
}

301 
__ªf
 
	$unm≠_low_∑ge
(*
adr
)

303 i‡(
a·î_boŸmem
)

306 
	`óæy_iounm≠
(
adr
, 
PAGE_SIZE
);

307 
	}
}

309 
__memöô


310 
	$phys_±e_öô
(
±e_t
 *
±e_∑ge
, 
addr
, 
íd
,

311 
pg¥Ÿ_t
 
¥Ÿ
)

313 
∑ges
 = 0;

314 
œ°_m≠_addr
 = 
íd
;

315 
i
;

317 
±e_t
 *
±e
 = 
±e_∑ge
 + 
	`±e_ödex
(
addr
);

319 
i
 = 
	`±e_ödex
(
addr
); i < 
PTRS_PER_PTE
; i++,ádd∏+
PAGE_SIZE
, 
±e
++) {

321 i‡(
addr
 >
íd
) {

322 i‡(!
a·î_boŸmem
) {

323 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

324 
	`£t_±e
(
±e
, 
	`__±e
(0));

335 i‡(
	`±e_vÆ
(*
±e
)) {

336 
∑ges
++;

341 
	`¥ötk
("Öte=%páddr=%lxÖte=%016lx\n",

342 
±e
, 
addr
, 
	`p‚_±e
◊dd∏>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

343 
∑ges
++;

344 
	`£t_±e
(
±e
, 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
¥Ÿ
));

345 
œ°_m≠_addr
 = (
addr
 & 
PAGE_MASK
Ë+ 
PAGE_SIZE
;

348 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_4K
, 
∑ges
);

350  
œ°_m≠_addr
;

351 
	}
}

353 
__memöô


354 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
addªss
, 
íd
,

355 
pg¥Ÿ_t
 
¥Ÿ
)

357 
±e_t
 *
±e
 = (±e_à*)
	`pmd_∑ge_vaddr
(*
pmd
);

359  
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
¥Ÿ
);

360 
	}
}

362 
__memöô


363 
	$phys_pmd_öô
(
pmd_t
 *
pmd_∑ge
, 
addªss
, 
íd
,

364 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

366 
∑ges
 = 0;

367 
œ°_m≠_addr
 = 
íd
;

369 
i
 = 
	`pmd_ödex
(
addªss
);

371 ; 
i
 < 
PTRS_PER_PMD
; i++, 
addªss
 +
PMD_SIZE
) {

372 
±e_phys
;

373 
pmd_t
 *
pmd
 = 
pmd_∑ge
 + 
	`pmd_ödex
(
addªss
);

374 
±e_t
 *
±e
;

375 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
¥Ÿ
;

377 i‡(
addªss
 >
íd
) {

378 i‡(!
a·î_boŸmem
) {

379 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

380 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

385 i‡(
	`pmd_vÆ
(*
pmd
)) {

386 i‡(!
	`pmd_œrge
(*
pmd
)) {

387 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

388 
œ°_m≠_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
addªss
,

389 
íd
, 
¥Ÿ
);

390 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

405 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

406 
∑ges
++;

409 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pmd
));

412 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

413 
∑ges
++;

414 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

415 
	`£t_±e
((
±e_t
 *)
pmd
,

416 
	`p‚_±e
(
addªss
 >> 
PAGE_SHIFT
,

417 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_PSE
)));

418 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

419 
œ°_m≠_addr
 = (
addªss
 & 
PMD_MASK
Ë+ 
PMD_SIZE
;

423 
±e
 = 
	`Æloc_low_∑ge
(&
±e_phys
);

424 
œ°_m≠_addr
 = 
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
√w_¥Ÿ
);

425 
	`unm≠_low_∑ge
(
±e
);

427 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

428 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
	`__va
(
±e_phys
));

429 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

431 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_2M
, 
∑ges
);

432  
œ°_m≠_addr
;

433 
	}
}

435 
__memöô


436 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
addªss
, 
íd
,

437 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

439 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

440 
œ°_m≠_addr
;

442 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addªss
, 
íd
, 
∑ge_size_mask
, 
¥Ÿ
);

443 
	`__Êush_éb_Æl
();

444  
œ°_m≠_addr
;

445 
	}
}

447 
__memöô


448 
	$phys_pud_öô
(
pud_t
 *
pud_∑ge
, 
addr
, 
íd
,

449 
∑ge_size_mask
)

451 
∑ges
 = 0;

452 
œ°_m≠_addr
 = 
íd
;

453 
i
 = 
	`pud_ödex
(
addr
);

455 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add∏& 
PUD_MASK
Ë+ 
PUD_SIZE
) {

456 
pmd_phys
;

457 
pud_t
 *
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
addr
);

458 
pmd_t
 *
pmd
;

459 
pg¥Ÿ_t
 
¥Ÿ
 = 
PAGE_KERNEL
;

461 i‡(
addr
 >
íd
)

464 i‡(!
a·î_boŸmem
 &&

465 !
	`e820_™y_m≠≥d
(
addr
,áddr+
PUD_SIZE
, 0)) {

466 
	`£t_pud
(
pud
, 
	`__pud
(0));

470 i‡(
	`pud_vÆ
(*
pud
)) {

471 i‡(!
	`pud_œrge
(*
pud
)) {

472 
œ°_m≠_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
íd
,

473 
∑ge_size_mask
, 
¥Ÿ
);

488 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

489 
∑ges
++;

492 
¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pud
));

495 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

496 
∑ges
++;

497 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

498 
	`£t_±e
((
±e_t
 *)
pud
,

499 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

500 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

501 
œ°_m≠_addr
 = (
addr
 & 
PUD_MASK
Ë+ 
PUD_SIZE
;

505 
pmd
 = 
	`Æloc_low_∑ge
(&
pmd_phys
);

506 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addr
, 
íd
, 
∑ge_size_mask
,

507 
¥Ÿ
);

508 
	`unm≠_low_∑ge
(
pmd
);

510 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

511 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
	`__va
(
pmd_phys
));

512 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

514 
	`__Êush_éb_Æl
();

516 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_1G
, 
∑ges
);

518  
œ°_m≠_addr
;

519 
	}
}

521 
__memöô


522 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
íd
,

523 
∑ge_size_mask
)

525 
pud_t
 *
pud
;

527 
pud
 = (
pud_t
 *)
	`pgd_∑ge_vaddr
(*
pgd
);

529  
	`phys_pud_öô
(
pud
, 
addr
, 
íd
, 
∑ge_size_mask
);

530 
	}
}

532 
__memöô


533 
	$kî√l_physiˇl_m≠pög_öô
(
°¨t
,

534 
íd
,

535 
∑ge_size_mask
)

538 
√xt
, 
œ°_m≠_addr
 = 
íd
;

540 
°¨t
 = ()
	`__va
(start);

541 
íd
 = ()
	`__va
(end);

543 ; 
°¨t
 < 
íd
; sèπ = 
√xt
) {

544 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
°¨t
);

545 
pud_phys
;

546 
pud_t
 *
pud
;

548 
√xt
 = (
°¨t
 + 
PGDIR_SIZE
Ë& 
PGDIR_MASK
;

549 i‡(
√xt
 > 
íd
)

550 
√xt
 = 
íd
;

552 i‡(
	`pgd_vÆ
(*
pgd
)) {

553 
œ°_m≠_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__∑
(
°¨t
),

554 
	`__∑
(
íd
), 
∑ge_size_mask
);

558 
pud
 = 
	`Æloc_low_∑ge
(&
pud_phys
);

559 
œ°_m≠_addr
 = 
	`phys_pud_öô
(
pud
, 
	`__∑
(
°¨t
), __∑(
√xt
),

560 
∑ge_size_mask
);

561 
	`unm≠_low_∑ge
(
pud
);

563 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

564 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
	`__va
(
pud_phys
));

565 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

567 
	`__Êush_éb_Æl
();

569  
œ°_m≠_addr
;

570 
	}
}

572 #i‚de‡
CONFIG_NUMA


573 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
íd_p‚
,

574 
a˝i
, 
k8
)

576 #i‚de‡
CONFIG_NO_BOOTMEM


577 
boŸm≠_size
, 
boŸm≠
;

579 
boŸm≠_size
 = 
	`boŸmem_boŸm≠_∑ges
(
íd_p‚
)<<
PAGE_SHIFT
;

580 
boŸm≠
 = 
	`föd_e820_¨ó
(0, 
íd_p‚
<<
PAGE_SHIFT
, 
boŸm≠_size
,

581 
PAGE_SIZE
);

582 i‡(
boŸm≠
 == -1L)

583 
	`∑nic
("C™nŸ föd boŸmem m≠ o‡sizê%ld\n", 
boŸm≠_size
);

584 
	`ª£rve_óæy
(
boŸm≠
, boŸm≠ + 
boŸm≠_size
, "BOOTMAP");

586 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(0), 
boŸm≠
 >> 
PAGE_SHIFT
,

587 0, 
íd_p‚
);

588 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

589 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(0, 
íd_p‚
);

591 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

593 
	}
}

596 
__öô
 
	$∑gög_öô
()

598 
max_z⁄e_p‚s
[
MAX_NR_ZONES
];

600 
	`mem£t
(
max_z⁄e_p‚s
, 0, (max_zone_pfns));

601 
max_z⁄e_p‚s
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

602 
max_z⁄e_p‚s
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

603 
max_z⁄e_p‚s
[
ZONE_NORMAL
] = 
max_p‚
;

605 
	`•¨£_mem‹y_¥e£¡_wôh_a˘ive_ªgi⁄s
(
MAX_NUMNODES
);

606 
	`•¨£_öô
();

614 
	`node_˛ór_°©e
(0, 
N_NORMAL_MEMORY
);

616 
	`‰ì_¨ó_öô_nodes
(
max_z⁄e_p‚s
);

617 
	}
}

622 #ifde‡
CONFIG_MEMORY_HOTPLUG


627 
	$upd©e_íd_of_mem‹y_v¨s
(
u64
 
°¨t
, u64 
size
)

629 
íd_p‚
 = 
	`PFN_UP
(
°¨t
 + 
size
);

631 i‡(
íd_p‚
 > 
max_p‚
) {

632 
max_p‚
 = 
íd_p‚
;

633 
max_low_p‚
 = 
íd_p‚
;

634 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

636 
	}
}

642 
	$¨ch_add_mem‹y
(
nid
, 
u64
 
°¨t
, u64 
size
)

644 
pgli°_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

645 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
ZONE_NORMAL
;

646 
œ°_m≠≥d_p‚
, 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

647 
ƒ_∑ges
 = 
size
 >> 
PAGE_SHIFT
;

648 
ªt
;

650 
œ°_m≠≥d_p‚
 = 
	`öô_mem‹y_m≠pög
(
°¨t
, sèπ + 
size
);

651 i‡(
œ°_m≠≥d_p‚
 > 
max_p‚_m≠≥d
)

652 
max_p‚_m≠≥d
 = 
œ°_m≠≥d_p‚
;

654 
ªt
 = 
	`__add_∑ges
(
nid
, 
z⁄e
, 
°¨t_p‚
, 
ƒ_∑ges
);

655 
	`WARN_ON_ONCE
(
ªt
);

658 
	`upd©e_íd_of_mem‹y_v¨s
(
°¨t
, 
size
);

660  
ªt
;

661 
	}
}

662 
EXPORT_SYMBOL_GPL
(
¨ch_add_mem‹y
);

664 #i‡!
deföed
(
CONFIG_ACPI_NUMA
Ë&& deföed(
CONFIG_NUMA
)

665 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

668 
	}
}

669 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

674 
kc‹e_li°
 
	gkc‹e_vsysˇŒ
;

676 
__öô
 
	$mem_öô
()

678 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
;

679 
ab£¡_∑ges
;

681 
	`pci_iommu_Æloc
();

685 
ª£rved∑ges
 = 0;

688 #ifde‡
CONFIG_NUMA


689 
tŸÆøm_∑ges
 = 
	`numa_‰ì_Æl_boŸmem
();

691 
tŸÆøm_∑ges
 = 
	`‰ì_Æl_boŸmem
();

694 
ab£¡_∑ges
 = 
	`ab£¡_∑ges_ö_ønge
(0, 
max_p‚
);

695 
ª£rved∑ges
 = 
max_p‚
 - 
tŸÆøm_∑ges
 - 
ab£¡_∑ges
;

696 
a·î_boŸmem
 = 1;

698 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

699 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_ëext
;

700 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

703 
	`k˛i°_add
(&
kc‹e_vsysˇŒ
, (*)
VSYSCALL_START
,

704 
VSYSCALL_END
 - 
VSYSCALL_START
, 
KCORE_OTHER
);

706 
	`¥ötk
(
KERN_INFO
 "Memory: %luk/%lukávailable (%ldk kernel code, "

708 
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

709 
max_p‚
 << (
PAGE_SHIFT
-10),

710 
codesize
 >> 10,

711 
ab£¡_∑ges
 << (
PAGE_SHIFT
-10),

712 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

713 
d©asize
 >> 10,

714 
öôsize
 >> 10);

715 
	}
}

717 #ifde‡
CONFIG_DEBUG_RODATA


718 c⁄° 
	grod©a_ã°_d©a
 = 0xC3;

719 
EXPORT_SYMBOL_GPL
(
rod©a_ã°_d©a
);

721 
	gkî√l_£t_to_ªad⁄ly
;

723 
	$£t_kî√l_ãxt_rw
()

725 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

726 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

728 i‡(!
kî√l_£t_to_ªad⁄ly
)

731 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead write\n",

732 
°¨t
, 
íd
);

739 
	`£t_mem‹y_rw
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

740 
	}
}

742 
	$£t_kî√l_ãxt_ro
()

744 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

745 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

747 i‡(!
kî√l_£t_to_ªad⁄ly
)

750 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead only\n",

751 
°¨t
, 
íd
);

756 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

757 
	}
}

759 
	$m¨k_rod©a_ro
()

761 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

762 
rod©a_°¨t
 =

763 (()
__°¨t_rod©a
 + 
PAGE_SIZE
 - 1Ë& 
PAGE_MASK
;

764 
íd
 = (Ë&
__íd_rod©a_h∑ge_Æign
;

765 
ãxt_íd
 = 
	`PAGE_ALIGN
((Ë&
__°›___ex_èbÀ
);

766 
rod©a_íd
 = 
	`PAGE_ALIGN
((Ë&
__íd_rod©a
);

767 
d©a_°¨t
 = (Ë&
_sd©a
;

769 
	`¥ötk
(
KERN_INFO
 "WriteÖrotectingÅhe kernelÑead-only data: %luk\n",

770 (
íd
 - 
°¨t
) >> 10);

771 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

773 
kî√l_£t_to_ªad⁄ly
 = 1;

779 
	`£t_mem‹y_nx
(
rod©a_°¨t
, (
íd
 -Ñod©a_°¨tË>> 
PAGE_SHIFT
);

781 
	`rod©a_ã°
();

783 #ifde‡
CONFIG_CPA_DEBUG


784 
	`¥ötk
(
KERN_INFO
 "Te°ög CPA: undÿ%lx-%lx\n", 
°¨t
, 
íd
);

785 
	`£t_mem‹y_rw
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

787 
	`¥ötk
(
KERN_INFO
 "Testing CPA:ágain\n");

788 
	`£t_mem‹y_ro
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

791 
	`‰ì_öô_∑ges
("unused kernel memory",

792 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
ãxt_íd
)),

794 
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_°¨t
)));

795 
	`‰ì_öô_∑ges
("unused kernel memory",

796 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_íd
)),

797 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
d©a_°¨t
)));

798 
	}
}

802 
__öô
 
	$ª£rve_boŸmem_gíîic
(
phys
, 
Àn
,

803 
Êags
)

805 #ifde‡
CONFIG_NUMA


806 
nid
, 
√xt_nid
;

807 
ªt
;

809 
p‚
 = 
phys
 >> 
PAGE_SHIFT
;

811 i‡(
p‚
 >
max_p‚
) {

816 i‡(
p‚
 < 
max_p‚_m≠≥d
)

817  -
EFAULT
;

819 
	`¥ötk
(
KERN_ERR
 "reserve_bootmem: illegalÑeserve %lx %lu\n",

820 
phys
, 
Àn
);

821  -
EFAULT
;

825 #ifde‡
CONFIG_NUMA


826 
nid
 = 
	`phys_to_nid
(
phys
);

827 
√xt_nid
 = 
	`phys_to_nid
(
phys
 + 
Àn
 - 1);

828 i‡(
nid
 =
√xt_nid
)

829 
ªt
 = 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Àn
, 
Êags
);

831 
ªt
 = 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

833 i‡(
ªt
 != 0)

834  
ªt
;

837 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

840 i‡(
phys
+
Àn
 <
MAX_DMA_PFN
*
PAGE_SIZE
) {

841 
dma_ª£rve
 +
Àn
 / 
PAGE_SIZE
;

842 
	`£t_dma_ª£rve
(
dma_ª£rve
);

846 
	}
}

848 
	$kîn_addr_vÆid
(
addr
)

850 
above
 = (()
addr
Ë>> 
__VIRTUAL_MASK_SHIFT
;

851 
pgd_t
 *
pgd
;

852 
pud_t
 *
pud
;

853 
pmd_t
 *
pmd
;

854 
±e_t
 *
±e
;

856 i‡(
above
 != 0 &&ábove != -1UL)

859 
pgd
 = 
	`pgd_off£t_k
(
addr
);

860 i‡(
	`pgd_n⁄e
(*
pgd
))

863 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

864 i‡(
	`pud_n⁄e
(*
pud
))

867 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

868 i‡(
	`pmd_n⁄e
(*
pmd
))

871 i‡(
	`pmd_œrge
(*
pmd
))

872  
	`p‚_vÆid
(
	`pmd_p‚
(*
pmd
));

874 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addr
);

875 i‡(
	`±e_n⁄e
(*
±e
))

878  
	`p‚_vÆid
(
	`±e_p‚
(*
±e
));

879 
	}
}

886 
vm_¨ó_°ru˘
 
	gg©e_vma
 = {

887 .
vm_°¨t
 = 
VSYSCALL_START
,

888 .
	gvm_íd
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

889 .
	gvm_∑ge_¥Ÿ
 = 
PAGE_READONLY_EXEC
,

890 .
	gvm_Êags
 = 
VM_READ
 | 
VM_EXEC


893 
vm_¨ó_°ru˘
 *
	$gë_g©e_vma
(
èsk_°ru˘
 *
tsk
)

895 #ifde‡
CONFIG_IA32_EMULATION


896 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
))

897  
NULL
;

899  &
g©e_vma
;

900 
	}
}

902 
	$ö_g©e_¨ó
(
èsk_°ru˘
 *
èsk
, 
addr
)

904 
vm_¨ó_°ru˘
 *
vma
 = 
	`gë_g©e_vma
(
èsk
);

906 i‡(!
vma
)

909  (
addr
 >
vma
->
vm_°¨t
Ë&& (add∏< vma->
vm_íd
);

910 
	}
}

917 
	$ö_g©e_¨ó_no_èsk
(
addr
)

919  (
addr
 >
VSYSCALL_START
Ë&& (add∏< 
VSYSCALL_END
);

920 
	}
}

922 c⁄° *
	$¨ch_vma_«me
(
vm_¨ó_°ru˘
 *
vma
)

924 i‡(
vma
->
vm_mm
 && vma->
vm_°¨t
 =()vma->vm_mm->
c⁄ãxt
.
vdso
)

926 i‡(
vma
 =&
g©e_vma
)

928  
NULL
;

929 
	}
}

931 #ifde‡
CONFIG_SPARSEMEM_VMEMMAP


935 
__memöôd©a
 
	gaddr_°¨t
, 
	gaddr_íd
;

936 
__memöôd©a
 *
	gp_°¨t
, *
	gp_íd
;

937 
__memöôd©a
 
	gnode_°¨t
;

939 
__memöô


940 
	$vmemm≠_p›uœã
(
∑ge
 *
°¨t_∑ge
, 
size
, 
node
)

942 
addr
 = ()
°¨t_∑ge
;

943 
íd
 = ()(
°¨t_∑ge
 + 
size
);

944 
√xt
;

945 
pgd_t
 *
pgd
;

946 
pud_t
 *
pud
;

947 
pmd_t
 *
pmd
;

949 ; 
addr
 < 
íd
;ádd∏
√xt
) {

950 *
p
 = 
NULL
;

952 
pgd
 = 
	`vmemm≠_pgd_p›uœã
(
addr
, 
node
);

953 i‡(!
pgd
)

954  -
ENOMEM
;

956 
pud
 = 
	`vmemm≠_pud_p›uœã
(
pgd
, 
addr
, 
node
);

957 i‡(!
pud
)

958  -
ENOMEM
;

960 i‡(!
˝u_has_p£
) {

961 
√xt
 = (
addr
 + 
PAGE_SIZE
Ë& 
PAGE_MASK
;

962 
pmd
 = 
	`vmemm≠_pmd_p›uœã
(
pud
, 
addr
, 
node
);

964 i‡(!
pmd
)

965  -
ENOMEM
;

967 
p
 = 
	`vmemm≠_±e_p›uœã
(
pmd
, 
addr
, 
node
);

969 i‡(!
p
)

970  -
ENOMEM
;

972 
addr_íd
 = 
addr
 + 
PAGE_SIZE
;

973 
p_íd
 = 
p
 + 
PAGE_SIZE
;

975 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

977 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

978 i‡(
	`pmd_n⁄e
(*
pmd
)) {

979 
±e_t
 
íåy
;

981 
p
 = 
	`vmemm≠_Æloc_block_buf
(
PMD_SIZE
, 
node
);

982 i‡(!
p
)

983  -
ENOMEM
;

985 
íåy
 = 
	`p‚_±e
(
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

986 
PAGE_KERNEL_LARGE
);

987 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_vÆ
(
íåy
)));

990 i‡(
p_íd
 !
p
 || 
node_°¨t
 !
node
) {

991 i‡(
p_°¨t
)

992 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

993 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

994 
addr_°¨t
 = 
addr
;

995 
node_°¨t
 = 
node
;

996 
p_°¨t
 = 
p
;

999 
addr_íd
 = 
addr
 + 
PMD_SIZE
;

1000 
p_íd
 = 
p
 + 
PMD_SIZE
;

1002 
	`vmemm≠_vîify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
√xt
);

1007 
	}
}

1009 
__memöô
 
	$vmemm≠_p›uœã_¥öt_œ°
()

1011 i‡(
p_°¨t
) {

1012 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

1013 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

1014 
p_°¨t
 = 
NULL
;

1015 
p_íd
 = 
NULL
;

1016 
node_°¨t
 = 0;

1018 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<löux/boŸmem.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/io.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/mmiŸø˚.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm≠.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/∑t.h
>

25 
	~"phyßddr.h
"

31 
	$i‹em≠_ch™ge_©å
(
vaddr
, 
size
,

32 
¥Ÿ_vÆ
)

34 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

35 
îr
;

37 
¥Ÿ_vÆ
) {

38 
_PAGE_CACHE_UC
:

40 
îr
 = 
	`_£t_mem‹y_uc
(
vaddr
, 
ƒ∑ges
);

42 
_PAGE_CACHE_WC
:

43 
îr
 = 
	`_£t_mem‹y_wc
(
vaddr
, 
ƒ∑ges
);

45 
_PAGE_CACHE_WB
:

46 
îr
 = 
	`_£t_mem‹y_wb
(
vaddr
, 
ƒ∑ges
);

50  
îr
;

51 
	}
}

62 
__iomem
 *
	$__i‹em≠_ˇŒî
(
ªsour˚_size_t
 
phys_addr
,

63 
size
, 
¥Ÿ_vÆ
, *
ˇŒî
)

65 
p‚
, 
off£t
, 
vaddr
;

66 
ªsour˚_size_t
 
œ°_addr
;

67 c⁄° 
ªsour˚_size_t
 
u«lig√d_phys_addr
 = 
phys_addr
;

68 c⁄° 
u«lig√d_size
 = 
size
;

69 
vm_°ru˘
 *
¨ó
;

70 
√w_¥Ÿ_vÆ
;

71 
pg¥Ÿ_t
 
¥Ÿ
;

72 
ªtvÆ
;

73 
__iomem
 *
ªt_addr
;

76 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

77 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
)

78  
NULL
;

80 i‡(!
	`phys_addr_vÆid
(
phys_addr
)) {

81 
	`¥ötk
(
KERN_WARNING
 "ioremap: invalidÖhysicaláddress %llx\n",

82 ()
phys_addr
);

83 
	`WARN_ON_ONCE
(1);

84  
NULL
;

90 i‡(
	`is_ISA_ønge
(
phys_addr
, 
œ°_addr
))

91  (
__f‹˚
 
__iomem
 *)
	`phys_to_vút
(
phys_addr
);

97 
	`WARN_ONCE
(
	`iomem_m≠_ßnôy_check
(
phys_addr
, 
size
),

98 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

103 
p‚
 = 
phys_addr
 >> 
PAGE_SHIFT
;

104 (
p‚
 << 
PAGE_SHIFT
Ë< (
œ°_addr
 & 
PAGE_MASK
);

105 
p‚
++) {

107 
is_øm
 = 
	`∑ge_is_øm
(
p‚
);

109 i‡(
is_øm
 && 
	`p‚_vÆid
(
p‚
Ë&& !
	`PageRe£rved
(
	`p‚_to_∑ge
(pfn)))

110  
NULL
;

111 
	`WARN_ON_ONCE
(
is_øm
);

117 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

118 
phys_addr
 &
PAGE_MASK
;

119 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
+1Ë- 
phys_addr
;

121 
ªtvÆ
 = 
	`ª£rve_memty≥
(
phys_addr
, (
u64
Ìhys_add∏+ 
size
,

122 
¥Ÿ_vÆ
, &
√w_¥Ÿ_vÆ
);

123 i‡(
ªtvÆ
) {

124 
	`¥ötk
(
KERN_ERR
 "i‹em≠Ñe£rve_memty≥ faûed %d\n", 
ªtvÆ
);

125  
NULL
;

128 i‡(
¥Ÿ_vÆ
 !
√w_¥Ÿ_vÆ
) {

129 i‡(!
	`is_√w_memty≥_Ælowed
(
phys_addr
, 
size
,

130 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
)) {

131 
	`¥ötk
(
KERN_ERR


133 ()
phys_addr
,

134 ()(
phys_addr
 + 
size
),

135 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
);

136 
îr_‰ì_memty≥
;

138 
¥Ÿ_vÆ
 = 
√w_¥Ÿ_vÆ
;

141 
¥Ÿ_vÆ
) {

142 
_PAGE_CACHE_UC
:

144 
¥Ÿ
 = 
PAGE_KERNEL_IO_NOCACHE
;

146 
_PAGE_CACHE_UC_MINUS
:

147 
¥Ÿ
 = 
PAGE_KERNEL_IO_UC_MINUS
;

149 
_PAGE_CACHE_WC
:

150 
¥Ÿ
 = 
PAGE_KERNEL_IO_WC
;

152 
_PAGE_CACHE_WB
:

153 
¥Ÿ
 = 
PAGE_KERNEL_IO
;

160 
¨ó
 = 
	`gë_vm_¨ó_ˇŒî
(
size
, 
VM_IOREMAP
, 
ˇŒî
);

161 i‡(!
¨ó
)

162 
îr_‰ì_memty≥
;

163 
¨ó
->
phys_addr
 =Öhys_addr;

164 
vaddr
 = (Ë
¨ó
->
addr
;

166 i‡(
	`kî√l_m≠_sync_memty≥
(
phys_addr
, 
size
, 
¥Ÿ_vÆ
))

167 
îr_‰ì_¨ó
;

169 i‡(
	`i‹em≠_∑ge_ønge
(
vaddr
, vadd∏+ 
size
, 
phys_addr
, 
¥Ÿ
))

170 
îr_‰ì_¨ó
;

172 
ªt_addr
 = (
__iomem
 *Ë(
vaddr
 + 
off£t
);

173 
	`mmiŸø˚_i‹em≠
(
u«lig√d_phys_addr
, 
u«lig√d_size
, 
ªt_addr
);

175  
ªt_addr
;

176 
îr_‰ì_¨ó
:

177 
	`‰ì_vm_¨ó
(
¨ó
);

178 
îr_‰ì_memty≥
:

179 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

180  
NULL
;

181 
	}
}

204 
__iomem
 *
	$i‹em≠_noˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

213 
vÆ
 = 
_PAGE_CACHE_UC_MINUS
;

215  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
vÆ
,

216 
	`__buûtö_ªtu∫_addªss
(0));

217 
	}
}

218 
EXPORT_SYMBOL
(
i‹em≠_noˇche
);

230 
__iomem
 *
	$i‹em≠_wc
(
ªsour˚_size_t
 
phys_addr
, 
size
)

232 i‡(
∑t_íabÀd
)

233  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

234 
	`__buûtö_ªtu∫_addªss
(0));

236  
	`i‹em≠_noˇche
(
phys_addr
, 
size
);

237 
	}
}

238 
EXPORT_SYMBOL
(
i‹em≠_wc
);

240 
__iomem
 *
	$i‹em≠_ˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

242  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

243 
	`__buûtö_ªtu∫_addªss
(0));

244 
	}
}

245 
EXPORT_SYMBOL
(
i‹em≠_ˇche
);

247 
__iomem
 *
	$i‹em≠_¥Ÿ
(
ªsour˚_size_t
 
phys_addr
, 
size
,

248 
¥Ÿ_vÆ
)

250  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, (
¥Ÿ_vÆ
 & 
_PAGE_CACHE_MASK
),

251 
	`__buûtö_ªtu∫_addªss
(0));

252 
	}
}

253 
EXPORT_SYMBOL
(
i‹em≠_¥Ÿ
);

261 
	$iounm≠
(vﬁ©ûê
__iomem
 *
addr
)

263 
vm_°ru˘
 *
p
, *
o
;

265 i‡((
__f‹˚
 *)
addr
 <
high_mem‹y
)

273 i‡((
__f‹˚
 *)
addr
 >
	`phys_to_vút
(
ISA_START_ADDRESS
) &&

274 (
__f‹˚
 *)
addr
 < 
	`phys_to_vút
(
ISA_END_ADDRESS
))

277 
addr
 = (vﬁ©ûê
__iomem
 *)

278 (
PAGE_MASK
 & (
__f‹˚
)
addr
);

280 
	`mmiŸø˚_iounm≠
(
addr
);

287 
	`ªad_lock
(&
vmli°_lock
);

288 
p
 = 
vmli°
;Ö;Ö =Ö->
√xt
) {

289 i‡(
p
->
addr
 =(
__f‹˚
 *)addr)

292 
	`ªad_u∆ock
(&
vmli°_lock
);

294 i‡(!
p
) {

295 
	`¥ötk
(
KERN_ERR
 "iounm≠: badáddªs†%p\n", 
addr
);

296 
	`dump_°ack
();

300 
	`‰ì_memty≥
(
p
->
phys_addr
,Ö->phys_add∏+ 
	`gë_vm_¨ó_size
(p));

303 
o
 = 
	`ªmove_vm_¨ó
((
__f‹˚
 *)
addr
);

304 
	`BUG_ON
(
p
 !
o
 || o =
NULL
);

305 
	`k‰ì
(
p
);

306 
	}
}

307 
EXPORT_SYMBOL
(
iounm≠
);

313 *
	$xœã_dev_mem_±r
(
phys
)

315 *
addr
;

316 
°¨t
 = 
phys
 & 
PAGE_MASK
;

319 i‡(
	`∑ge_is_øm
(
°¨t
 >> 
PAGE_SHIFT
))

320  
	`__va
(
phys
);

322 
addr
 = (
__f‹˚
 *)
	`i‹em≠_ˇche
(
°¨t
, 
PAGE_SIZE
);

323 i‡(
addr
)

324 
addr
 = (*)((Ôdd∏| (
phys
 & ~
PAGE_MASK
));

326  
addr
;

327 
	}
}

329 
	$unxœã_dev_mem_±r
(
phys
, *
addr
)

331 i‡(
	`∑ge_is_øm
(
phys
 >> 
PAGE_SHIFT
))

334 
	`iounm≠
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

336 
	}
}

338 
__öôd©a
 
	góæy_i‹em≠_debug
;

340 
__öô
 
	$óæy_i‹em≠_debug_£tup
(*
°r
)

342 
óæy_i‹em≠_debug
 = 1;

345 
	}
}

346 
óæy_∑øm
("óæy_i‹em≠_debug", 
óæy_i‹em≠_debug_£tup
);

348 
__öôd©a
 
	ga·î_∑gög_öô
;

349 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/’ã_t)] 
	g__∑ge_Æig√d_bss
;

351 
ölöe
 
pmd_t
 * 
__öô
 
	$óæy_i‹em≠_pmd
(
addr
)

354 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

355 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addr
)];

356 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

357 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

359  
pmd
;

360 
	}
}

362 
ölöe
 
±e_t
 * 
__öô
 
	$óæy_i‹em≠_±e
(
addr
)

364  &
bm_±e
[
	`±e_ödex
(
addr
)];

365 
	}
}

367 
	g¶Ÿ_vút
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

369 
__öô
 
	$óæy_i‹em≠_öô
()

371 
pmd_t
 *
pmd
;

372 
i
;

374 i‡(
óæy_i‹em≠_debug
)

375 
	`¥ötk
(
KERN_INFO
 "early_ioremap_init()\n");

377 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

378 
¶Ÿ_vút
[
i
] = 
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

380 
pmd
 = 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

381 
	`mem£t
(
bm_±e
, 0, (bm_pte));

382 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
bm_±e
);

388 
	#__FIXADDR_TOP
 (-
PAGE_SIZE
)

	)

389 
	`BUILD_BUG_ON
((
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
Ë>> 
PMD_SHIFT
)

390 !(
	`__fix_to_vút
(
FIX_BTMAP_END
Ë>> 
PMD_SHIFT
));

391 #unde‡
__FIXADDR_TOP


392 i‡(
pmd
 !
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
))) {

393 
	`WARN_ON
(1);

394 
	`¥ötk
(
KERN_WARNING
 "pmd %p != %p\n",

395 
pmd
, 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
)));

396 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

397 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

398 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

399 
	`fix_to_vút
(
FIX_BTMAP_END
));

401 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

402 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

403 
FIX_BTMAP_BEGIN
);

405 
	}
}

407 
__öô
 
	$óæy_i‹em≠_ª£t
()

409 
a·î_∑gög_öô
 = 1;

410 
	}
}

412 
__öô
 
	$__óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

413 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
Êags
)

415 
addr
 = 
	`__fix_to_vút
(
idx
);

416 
±e_t
 *
±e
;

418 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

419 
	`BUG
();

422 
±e
 = 
	`óæy_i‹em≠_±e
(
addr
);

424 i‡(
	`pg¥Ÿ_vÆ
(
Êags
))

425 
	`£t_±e
(
±e
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

427 
	`±e_˛ór
(&
öô_mm
, 
addr
, 
±e
);

428 
	`__Êush_éb_⁄e
(
addr
);

429 
	}
}

431 
ölöe
 
__öô
 
	$óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

432 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
¥Ÿ
)

434 i‡(
a·î_∑gög_öô
)

435 
	`__£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

437 
	`__óæy_£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

438 
	}
}

440 
ölöe
 
__öô
 
	$óæy_˛ór_fixm≠
(
fixed_addªs£s
 
idx
)

442 i‡(
a·î_∑gög_öô
)

443 
	`˛ór_fixm≠
(
idx
);

445 
	`__óæy_£t_fixm≠
(
idx
, 0, 
	`__pg¥Ÿ
(0));

446 
	}
}

448 
__iomem
 *
	g¥ev_m≠
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

449 
	g¥ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

451 
__öô
 
	$fixup_óæy_i‹em≠
()

453 
i
;

455 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

456 i‡(
¥ev_m≠
[
i
]) {

457 
	`WARN_ON
(1);

462 
	`óæy_i‹em≠_öô
();

463 
	}
}

465 
__öô
 
	$check_óæy_i‹em≠_Àak
()

467 
cou¡
 = 0;

468 
i
;

470 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

471 i‡(
¥ev_m≠
[
i
])

472 
cou¡
++;

474 i‡(!
cou¡
)

476 
	`WARN
(1, 
KERN_WARNING


478 
cou¡
);

479 
	`¥ötk
(
KERN_WARNING


483 
	}
}

484 
œã_öôˇŒ
(
check_óæy_i‹em≠_Àak
);

486 
__öô
 
__iomem
 *

487 
	$__óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
, 
pg¥Ÿ_t
 
¥Ÿ
)

489 
off£t
;

490 
ªsour˚_size_t
 
œ°_addr
;

491 
ƒ∑ges
;

492 
fixed_addªs£s
 
idx0
, 
idx
;

493 
i
, 
¶Ÿ
;

495 
	`WARN_ON
(
sy°em_°©e
 !
SYSTEM_BOOTING
);

497 
¶Ÿ
 = -1;

498 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

499 i‡(!
¥ev_m≠
[
i
]) {

500 
¶Ÿ
 = 
i
;

505 i‡(
¶Ÿ
 < 0) {

506 
	`¥ötk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)Çot found slot\n",

507 (
u64
)
phys_addr
, 
size
);

508 
	`WARN_ON
(1);

509  
NULL
;

512 i‡(
óæy_i‹em≠_debug
) {

513 
	`¥ötk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

514 (
u64
)
phys_addr
, 
size
, 
¶Ÿ
);

515 
	`dump_°ack
();

519 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

520 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
) {

521 
	`WARN_ON
(1);

522  
NULL
;

525 
¥ev_size
[
¶Ÿ
] = 
size
;

529 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

530 
phys_addr
 &
PAGE_MASK
;

531 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
 + 1Ë- 
phys_addr
;

536 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

537 i‡(
ƒ∑ges
 > 
NR_FIX_BTMAPS
) {

538 
	`WARN_ON
(1);

539  
NULL
;

545 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

546 
idx
 = 
idx0
;

547 
ƒ∑ges
 > 0) {

548 
	`óæy_£t_fixm≠
(
idx
, 
phys_addr
, 
¥Ÿ
);

549 
phys_addr
 +
PAGE_SIZE
;

550 --
idx
;

551 --
ƒ∑ges
;

553 i‡(
óæy_i‹em≠_debug
)

554 
	`¥ötk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¶Ÿ_vút
[
¶Ÿ
]);

556 
¥ev_m≠
[
¶Ÿ
] = (
__iomem
 *)(
off£t
 + 
¶Ÿ_vút
[slot]);

557  
¥ev_m≠
[
¶Ÿ
];

558 
	}
}

561 
__öô
 
__iomem
 *

562 
	$óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

564  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

565 
	}
}

568 
__öô
 
__iomem
 *

569 
	$óæy_memªm≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

571  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

572 
	}
}

574 
__öô
 
	$óæy_iounm≠
(
__iomem
 *
addr
, 
size
)

576 
vút_addr
;

577 
off£t
;

578 
ƒ∑ges
;

579 
fixed_addªs£s
 
idx
;

580 
i
, 
¶Ÿ
;

582 
¶Ÿ
 = -1;

583 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

584 i‡(
¥ev_m≠
[
i
] =
addr
) {

585 
¶Ÿ
 = 
i
;

590 i‡(
¶Ÿ
 < 0) {

591 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx)Çot found slot\n",

592 
addr
, 
size
);

593 
	`WARN_ON
(1);

597 i‡(
¥ev_size
[
¶Ÿ
] !
size
) {

598 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] sizeÇot consistent %08lx\n",

599 
addr
, 
size
, 
¶Ÿ
, 
¥ev_size
[slot]);

600 
	`WARN_ON
(1);

604 i‡(
óæy_i‹em≠_debug
) {

605 
	`¥ötk
(
KERN_INFO
 "óæy_iounm≠(%p, %08lxË[%d]\n", 
addr
,

606 
size
, 
¶Ÿ
);

607 
	`dump_°ack
();

610 
vút_addr
 = ()
addr
;

611 i‡(
vút_addr
 < 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
)) {

612 
	`WARN_ON
(1);

615 
off£t
 = 
vút_addr
 & ~
PAGE_MASK
;

616 
ƒ∑ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1Ë>> 
PAGE_SHIFT
;

618 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

619 
ƒ∑ges
 > 0) {

620 
	`óæy_˛ór_fixm≠
(
idx
);

621 --
idx
;

622 --
ƒ∑ges
;

624 
¥ev_m≠
[
¶Ÿ
] = 
NULL
;

625 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<löux/pci_ids.h
>

16 
	~<löux/a˝i.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/mmz⁄e.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dúe˘.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/k8.h
>

27 
boŸnode
 
__öôd©a
 
	gnodes
[8];

28 
nodemask_t
 
__öôd©a
 
	gnodes_∑r£d
 = 
NODE_MASK_NONE
;

30 
__öô
 
	$föd_n‹thbridge
()

32 
num
;

34 
num
 = 0;Çum < 32;Çum++) {

35 
u32
 
hódî
;

37 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 0, 0x00);

38 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

39 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

40 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

43 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 1, 0x00);

44 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

45 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

46 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

48  
num
;

52 
	}
}

54 
__öô
 
	$óæy_gë_boŸ_˝u_id
()

60 #ifde‡
CONFIG_X86_MPPARSE


64 i‡(
smp_found_c⁄fig
)

65 
	`óæy_gë_smp_c⁄fig
();

67 
	`óæy_öô_œpic_m≠pög
();

68 
	}
}

70 
__öô
 
	$k8_gë_nodes
(
boŸnode
 *
phy¢odes
)

72 
i
;

73 
ªt
 = 0;

75 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

76 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

77 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

78 
ªt
++;

80  
ªt
;

81 
	}
}

83 
__öô
 
	$k8_numa_öô
(
°¨t_p‚
, 
íd_p‚
)

85 
°¨t
 = 
	`PFN_PHYS
(
°¨t_p‚
);

86 
íd
 = 
	`PFN_PHYS
(
íd_p‚
);

87 
numnodes
;

88 
¥evba£
;

89 
i
, 
nb
, 
found
 = 0;

90 
u32
 
nodeid
, 
ªg
;

92 i‡(!
	`óæy_pci_Ælowed
())

95 
nb
 = 
	`föd_n‹thbridge
();

96 i‡(
nb
 < 0)

97  
nb
;

99 
	`¥_öfo
("Sˇ¬ög NUMAÅ›ﬁogy i¿N‹thbridgê%d\n", 
nb
);

101 
ªg
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 0, 0x60);

102 
numnodes
 = ((
ªg
 >> 4) & 0xF) + 1;

103 i‡(
numnodes
 <= 1)

106 
	`¥_öfo
("Numbî o‡physiˇ»node†%d\n", 
numnodes
);

108 
¥evba£
 = 0;

109 
i
 = 0; i < 8; i++) {

110 
ba£
, 
limô
;

112 
ba£
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x40 + 
i
*8);

113 
limô
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x44 + 
i
*8);

115 
nodeid
 = 
limô
 & 7;

116 i‡((
ba£
 & 3) == 0) {

117 i‡(
i
 < 
numnodes
)

118 
	`¥_öfo
("Skùpög dißbÀdÇodê%d\n", 
i
);

121 i‡(
nodeid
 >
numnodes
) {

122 
	`¥_öfo
("Ign‹ögÉx˚s†nodê%d (%lx:%lx)\n", 
nodeid
,

123 
ba£
, 
limô
);

127 i‡(!
limô
) {

128 
	`¥_öfo
("SkippingÇodeÉntry %d (base %lx)\n",

129 
i
, 
ba£
);

132 i‡((
ba£
 >> 8Ë& 3 || (
limô
 >> 8) & 3) {

133 
	`¥_îr
("Node %d using interleaving mode %lx/%lx\n",

134 
nodeid
, (
ba£
 >> 8Ë& 3, (
limô
 >> 8) & 3);

137 i‡(
	`node_is£t
(
nodeid
, 
nodes_∑r£d
)) {

138 
	`¥_öfo
("Node %dálreadyÖresent, skipping\n",

139 
nodeid
);

143 
limô
 >>= 16;

144 
limô
 <<= 24;

145 
limô
 |= (1<<24)-1;

146 
limô
++;

148 i‡(
limô
 > 
íd
)

149 
limô
 = 
íd
;

150 i‡(
limô
 <
ba£
)

153 
ba£
 >>= 16;

154 
ba£
 <<= 24;

156 i‡(
ba£
 < 
°¨t
)

157 
ba£
 = 
°¨t
;

158 i‡(
limô
 > 
íd
)

159 
limô
 = 
íd
;

160 i‡(
limô
 =
ba£
) {

161 
	`¥_îr
("Em±yÇodê%d\n", 
nodeid
);

164 i‡(
limô
 < 
ba£
) {

165 
	`¥_îr
("Node %d bogus settings %lx-%lx.\n",

166 
nodeid
, 
ba£
, 
limô
);

171 i‡(
¥evba£
 > 
ba£
) {

172 
	`¥_îr
("Node mapÇot sorted %lx,%lx\n",

173 
¥evba£
, 
ba£
);

177 
	`¥_öfo
("Node %d MemBase %016lx Limit %016lx\n",

178 
nodeid
, 
ba£
, 
limô
);

180 
found
++;

182 
nodes
[
nodeid
].
°¨t
 = 
ba£
;

183 
nodes
[
nodeid
].
íd
 = 
limô
;

185 
¥evba£
 = 
ba£
;

187 
	`node_£t
(
nodeid
, 
nodes_∑r£d
);

190 i‡(!
found
)

193 
	}
}

195 
__öô
 
	$k8_sˇn_nodes
()

197 
bôs
;

198 
c‹es
;

199 
≠icid_ba£
;

200 
i
;

202 
	`BUG_ON
(
	`nodes_em±y
(
nodes_∑r£d
));

203 
node_possibÀ_m≠
 = 
nodes_∑r£d
;

204 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 8, 
NULL
);

205 i‡(
memnode_shi·
 < 0) {

206 
	`¥_îr
("No NUMAÇode hash function found. Contact maintainer\n");

209 
	`¥_öfo
("UsögÇodêhash shi· o‡%d\n", 
memnode_shi·
);

212 
bôs
 = 
boŸ_˝u_d©a
.
x86_c‹eid_bôs
;

213 
c‹es
 = (1<<
bôs
);

214 
≠icid_ba£
 = 0;

216 
	`óæy_gë_boŸ_˝u_id
();

217 i‡(
boŸ_˝u_physiˇl_≠icid
 > 0) {

218 
	`¥_öfo
("BSP APIC ID: %02x\n", 
boŸ_˝u_physiˇl_≠icid
);

219 
≠icid_ba£
 = 
boŸ_˝u_physiˇl_≠icid
;

222 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

223 
j
;

225 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
,

226 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
,

227 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

228 
j
 = 
≠icid_ba£
; j < 
c‹es
 +ápicid_base; j++)

229 
≠icid_to_node
[(
i
 << 
bôs
Ë+ 
j
] = i;

230 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

233 
	`numa_öô_¨øy
();

235 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<löux/≥rs⁄Æôy.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/limôs.h
>

31 
	~<löux/sched.h
>

32 
	~<asm/ñf.h
>

34 
	$°ack_maxøndom_size
()

36 
max
 = 0;

37 i‡((
cuºít
->
Êags
 & 
PF_RANDOMIZE
) &&

38 !(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
)) {

39 
max
 = ((-1UË& 
STACK_RND_MASK
Ë<< 
PAGE_SHIFT
;

42  
max
;

43 
	}
}

51 
	#MIN_GAP
 (128*1024*1024UL + 
	`°ack_maxøndom_size
())

	)

52 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

57 
	$mm≠_is_ü32
()

59 #ifde‡
CONFIG_X86_32


62 #ifde‡
CONFIG_IA32_EMULATION


63 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

67 
	}
}

69 
	$mm≠_is_Àgacy
()

71 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_COMPAT_LAYOUT
)

74 i‡(
	`æimô
(
RLIMIT_STACK
Ë=
RLIM_INFINITY
)

77  
sys˘l_Àgacy_va_œyout
;

78 
	}
}

80 
	$mm≠_∫d
()

82 
∫d
 = 0;

88 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

89 i‡(
	`mm≠_is_ü32
())

90 
∫d
 = ()
	`gë_øndom_öt
() % (1<<8);

92 
∫d
 = ()(
	`gë_øndom_öt
() % (1<<28));

94  
∫d
 << 
PAGE_SHIFT
;

95 
	}
}

97 
	$mm≠_ba£
()

99 
g≠
 = 
	`æimô
(
RLIMIT_STACK
);

101 i‡(
g≠
 < 
MIN_GAP
)

102 
g≠
 = 
MIN_GAP
;

103 i‡(
g≠
 > 
MAX_GAP
)

104 
g≠
 = 
MAX_GAP
;

106  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g≠
 - 
	`mm≠_∫d
());

107 
	}
}

113 
	$mm≠_Àgacy_ba£
()

115 i‡(
	`mm≠_is_ü32
())

116  
TASK_UNMAPPED_BASE
;

118  
TASK_UNMAPPED_BASE
 + 
	`mm≠_∫d
();

119 
	}
}

125 
	$¨ch_pick_mm≠_œyout
(
mm_°ru˘
 *
mm
)

127 i‡(
	`mm≠_is_Àgacy
()) {

128 
mm
->
mm≠_ba£
 = 
	`mm≠_Àgacy_ba£
();

129 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó
;

130 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó
;

132 
mm
->
mm≠_ba£
 = 
	`mm≠_ba£
();

133 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó_t›down
;

134 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó_t›down
;

136 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<löux/t›ﬁogy.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/boŸmem.h
>

6 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


7 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

9 
	#DBG
(
x
...)

	)

15 
˝umask_v¨_t
 
	gnode_to_˝umask_m≠
[
MAX_NUMNODES
];

16 
EXPORT_SYMBOL
(
node_to_˝umask_m≠
);

25 
__öô
 
	$£tup_node_to_˝umask_m≠
()

27 
node
, 
num
 = 0;

30 i‡(
ƒ_node_ids
 =
MAX_NUMNODES
) {

31 
	`f‹_óch_node_mask
(
node
, 
node_possibÀ_m≠
)

32 
num
 = 
node
;

33 
ƒ_node_ids
 = 
num
 + 1;

37 
node
 = 0;Çodê< 
ƒ_node_ids
;Çode++)

38 
	`Æloc_boŸmem_˝umask_v¨
(&
node_to_˝umask_m≠
[
node
]);

41 
	`¥_debug
("Nodêtÿ˝umask m≠ f‹ %dÇodes\n", 
ƒ_node_ids
);

42 
	}
}

44 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


48 c⁄° 
˝umask
 *
	$˝umask_of_node
(
node
)

50 i‡(
node
 >
ƒ_node_ids
) {

51 
	`¥ötk
(
KERN_WARNING


53 
node
, 
ƒ_node_ids
);

54 
	`dump_°ack
();

55  
˝u_n⁄e_mask
;

57 i‡(
node_to_˝umask_m≠
[
node
] =
NULL
) {

58 
	`¥ötk
(
KERN_WARNING


60 
node
);

61 
	`dump_°ack
();

62  
˝u_⁄löe_mask
;

64  
node_to_˝umask_m≠
[
node
];

65 
	}
}

66 
EXPORT_SYMBOL
(
˝umask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/mmz⁄e.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/a˝i.h
>

21 
	~<asm/k8.h
>

23 
pgli°_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__ªad_mo°ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__˝uöôd©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__öôd©a
;

33 
__öôd©a
 
	gnodem≠_addr
;

34 
__öôd©a
 
	gnodem≠_size
;

36 
DEFINE_PER_CPU
(, 
node_numbî
) = 0;

37 
EXPORT_PER_CPU_SYMBOL
(
node_numbî
);

42 
DEFINE_EARLY_PER_CPU
(, 
x86_˝u_to_node_m≠
, 
NUMA_NO_NODE
);

43 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_node_m≠
);

52 
__öô
 
	$p›uœã_memnodem≠
(c⁄° 
boŸnode
 *
nodes
,

53 
numnodes
, 
shi·
, *
nodeids
)

55 
addr
, 
íd
;

56 
i
, 
ªs
 = -1;

58 
	`mem£t
(
memnodem≠
, 0xff, (
s16
)*
memnodem≠size
);

59 
i
 = 0; i < 
numnodes
; i++) {

60 
addr
 = 
nodes
[
i
].
°¨t
;

61 
íd
 = 
nodes
[
i
].end;

62 i‡(
addr
 >
íd
)

64 i‡((
íd
 >> 
shi·
Ë>
memnodem≠size
)

67 i‡(
memnodem≠
[
addr
 >> 
shi·
] !
NUMA_NO_NODE
)

70 i‡(!
nodeids
)

71 
memnodem≠
[
addr
 >> 
shi·
] = 
i
;

73 
memnodem≠
[
addr
 >> 
shi·
] = 
nodeids
[
i
];

75 
addr
 +(1UL << 
shi·
);

76 } 
addr
 < 
íd
);

77 
ªs
 = 1;

79  
ªs
;

80 
	}
}

82 
__öô
 
	$Æloˇã_ˇchólig√d_memnodem≠
()

84 
addr
;

86 
memnodem≠
 = 
memnode
.
embedded_m≠
;

87 i‡(
memnodem≠size
 <
	`ARRAY_SIZE
(
memnode
.
embedded_m≠
))

90 
addr
 = 0x8000;

91 
nodem≠_size
 = 
	`roundup
((
s16
Ë* 
memnodem≠size
, 
L1_CACHE_BYTES
);

92 
nodem≠_addr
 = 
	`föd_e820_¨ó
(
addr
, 
max_p‚
<<
PAGE_SHIFT
,

93 
nodem≠_size
, 
L1_CACHE_BYTES
);

94 i‡(
nodem≠_addr
 == -1UL) {

95 
	`¥ötk
(
KERN_ERR


97 
nodem≠_addr
 = 
nodem≠_size
 = 0;

100 
memnodem≠
 = 
	`phys_to_vút
(
nodem≠_addr
);

101 
	`ª£rve_óæy
(
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
, "MEMNODEMAP");

103 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

104 
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
);

106 
	}
}

112 
__öô
 
	$exåa˘_lsb_‰om_nodes
(c⁄° 
boŸnode
 *
nodes
,

113 
numnodes
)

115 
i
, 
nodes_u£d
 = 0;

116 
°¨t
, 
íd
;

117 
bôfõld
 = 0, 
memt›
 = 0;

119 
i
 = 0; i < 
numnodes
; i++) {

120 
°¨t
 = 
nodes
[
i
].start;

121 
íd
 = 
nodes
[
i
].end;

122 i‡(
°¨t
 >
íd
)

124 
bôfõld
 |
°¨t
;

125 
nodes_u£d
++;

126 i‡(
íd
 > 
memt›
)

127 
memt›
 = 
íd
;

129 i‡(
nodes_u£d
 <= 1)

130 
i
 = 63;

132 
i
 = 
	`föd_fú°_bô
(&
bôfõld
, ()*8);

133 
memnodem≠size
 = (
memt›
 >> 
i
)+1;

134  
i
;

135 
	}
}

137 
__öô
 
	$compuã_hash_shi·
(
boŸnode
 *
nodes
, 
numnodes
,

138 *
nodeids
)

140 
shi·
;

142 
shi·
 = 
	`exåa˘_lsb_‰om_nodes
(
nodes
, 
numnodes
);

143 i‡(
	`Æloˇã_ˇchólig√d_memnodem≠
())

145 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Using %d forÅhe hash shift.\n",

146 
shi·
);

148 i‡(
	`p›uœã_memnodem≠
(
nodes
, 
numnodes
, 
shi·
, 
nodeids
) != 1) {

149 
	`¥ötk
(
KERN_INFO
 "Your memory isÇotáligned youÇeedÅo "

151 "shi·=%d\n", 
shi·
);

154  
shi·
;

155 
	}
}

157 
__memöô
 
	$__óæy_p‚_to_nid
(
p‚
)

159  
	`phys_to_nid
(
p‚
 << 
PAGE_SHIFT
);

160 
	}
}

162 * 
__öô
 
	$óæy_node_mem
(
nodeid
, 
°¨t
,

163 
íd
, 
size
,

164 
Æign
)

166 
mem
;

172 i‡(
°¨t
 < (
MAX_DMA_PFN
<<
PAGE_SHIFT
))

173 
°¨t
 = 
MAX_DMA_PFN
<<
PAGE_SHIFT
;

174 i‡(
°¨t
 < (
MAX_DMA32_PFN
<<
PAGE_SHIFT
) &&

175 
íd
 > (
MAX_DMA32_PFN
<<
PAGE_SHIFT
))

176 
°¨t
 = 
MAX_DMA32_PFN
<<
PAGE_SHIFT
;

177 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

178 i‡(
mem
 != -1L)

179  
	`__va
(
mem
);

182 
íd
 = 
max_p‚_m≠≥d
 << 
PAGE_SHIFT
;

183 i‡(
íd
 > (
MAX_DMA32_PFN
<<
PAGE_SHIFT
))

184 
°¨t
 = 
MAX_DMA32_PFN
<<
PAGE_SHIFT
;

186 
°¨t
 = 
MAX_DMA_PFN
<<
PAGE_SHIFT
;

187 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

188 i‡(
mem
 != -1L)

189  
	`__va
(
mem
);

191 
	`¥ötk
(
KERN_ERR
 "Cannot find %lu bytes inÇode %d\n",

192 
size
, 
nodeid
);

194  
NULL
;

195 
	}
}

198 
__öô


199 
	$£tup_node_boŸmem
(
nodeid
, 
°¨t
, 
íd
)

201 
°¨t_p‚
, 
œ°_p‚
, 
noded©a_phys
;

202 c⁄° 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

203 
nid
;

204 #i‚de‡
CONFIG_NO_BOOTMEM


205 
boŸm≠_°¨t
, 
boŸm≠_∑ges
, 
boŸm≠_size
;

206 *
boŸm≠
;

209 i‡(!
íd
)

216 i‡(
íd
 && (íd - 
°¨t
Ë< 
NODE_MIN_SIZE
)

219 
°¨t
 = 
	`roundup
(°¨t, 
ZONE_ALIGN
);

221 
	`¥ötk
(
KERN_INFO
 "Inômem sëu∞nodê%d %016lx-%016lx\n", 
nodeid
,

222 
°¨t
, 
íd
);

224 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

225 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

227 
node_d©a
[
nodeid
] = 
	`óæy_node_mem
“odeid, 
°¨t
, 
íd
, 
pgd©_size
,

228 
SMP_CACHE_BYTES
);

229 i‡(
node_d©a
[
nodeid
] =
NULL
)

231 
noded©a_phys
 = 
	`__∑
(
node_d©a
[
nodeid
]);

232 
	`ª£rve_óæy
(
noded©a_phys
,Çoded©a_phy†+ 
pgd©_size
, "NODE_DATA");

233 
	`¥ötk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

234 
noded©a_phys
 + 
pgd©_size
 - 1);

235 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

236 i‡(
nid
 !
nodeid
)

237 
	`¥ötk
(
KERN_INFO
 " NODE_DATA(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

239 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

240 
	`NODE_DATA
(
nodeid
)->
node_id
 =Çodeid;

241 
	`NODE_DATA
(
nodeid
)->
node_°¨t_p‚
 = 
°¨t_p‚
;

242 
	`NODE_DATA
(
nodeid
)->
node_•™√d_∑ges
 = 
œ°_p‚
 - 
°¨t_p‚
;

244 #i‚de‡
CONFIG_NO_BOOTMEM


245 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boŸmem_node_d©a
[nodeid];

254 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
œ°_p‚
 - 
°¨t_p‚
);

255 
boŸm≠_°¨t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

260 
boŸm≠
 = 
	`óæy_node_mem
(
nodeid
, 
boŸm≠_°¨t
, 
íd
,

261 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

262 i‡(
boŸm≠
 =
NULL
) {

263 
	`‰ì_óæy
(
noded©a_phys
,Çoded©a_phy†+ 
pgd©_size
);

264 
node_d©a
[
nodeid
] = 
NULL
;

267 
boŸm≠_°¨t
 = 
	`__∑
(
boŸm≠
);

268 
	`ª£rve_óæy
(
boŸm≠_°¨t
, boŸm≠_°¨t+(
boŸm≠_∑ges
<<
PAGE_SHIFT
),

271 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nodeid
),

272 
boŸm≠_°¨t
 >> 
PAGE_SHIFT
,

273 
°¨t_p‚
, 
œ°_p‚
);

275 
	`¥ötk
(
KERN_INFO
 " bootmap [%016lx - %016lx]Öages %lx\n",

276 
boŸm≠_°¨t
, boŸm≠_°¨à+ 
boŸm≠_size
 - 1,

277 
boŸm≠_∑ges
);

278 
nid
 = 
	`phys_to_nid
(
boŸm≠_°¨t
);

279 i‡(
nid
 !
nodeid
)

280 
	`¥ötk
(
KERN_INFO
 " boŸm≠(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

282 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(
nodeid
, 
íd
);

285 
	`node_£t_⁄löe
(
nodeid
);

286 
	}
}

295 
__öô
 
	$numa_öô_¨øy
()

297 
º
, 
i
;

299 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

300 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

301 i‡(
	`óæy_˝u_to_node
(
i
Ë!
NUMA_NO_NODE
)

303 
	`numa_£t_node
(
i
, 
º
);

304 
º
 = 
	`√xt_node
‘r, 
node_⁄löe_m≠
);

305 i‡(
º
 =
MAX_NUMNODES
)

306 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

308 
	}
}

310 #ifde‡
CONFIG_NUMA_EMU


312 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

313 
boŸnode
 
	gphy¢odes
[
MAX_NUMNODES
] 
	g__öôd©a
;

314 *
cmdlöe
 
	g__öôd©a
;

316 
__öô
 
	$£tup_phy¢odes
(
°¨t
, 
íd
,

317 
a˝i
, 
k8
)

319 
ƒ_nodes
 = 0;

320 
ªt
 = 0;

321 
i
;

323 #ifde‡
CONFIG_ACPI_NUMA


324 i‡(
a˝i
)

325 
ƒ_nodes
 = 
	`a˝i_gë_nodes
(
phy¢odes
);

327 #ifde‡
CONFIG_K8_NUMA


328 i‡(
k8
)

329 
ƒ_nodes
 = 
	`k8_gë_nodes
(
phy¢odes
);

336 
i
 = 0; i < 
ƒ_nodes
; i++) {

337 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

339 i‡(
phy¢odes
[
i
].
°¨t
 > 
íd
) {

340 
phy¢odes
[
i
].
íd
 =Öhy¢odes[i].
°¨t
;

343 i‡(
phy¢odes
[
i
].
íd
 < 
°¨t
) {

344 
phy¢odes
[
i
].
°¨t
 =Öhy¢odes[i].
íd
;

347 i‡(
phy¢odes
[
i
].
°¨t
 < start)

348 
phy¢odes
[
i
].
°¨t
 = start;

349 i‡(
phy¢odes
[
i
].
íd
 >Énd)

350 
phy¢odes
[
i
].
íd
 =Énd;

357 
i
 = 0; i < 
ƒ_nodes
; i++) {

358 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

360 
phy¢odes
[
ªt
].
°¨t
 =Öhy¢odes[
i
].start;

361 
phy¢odes
[
ªt
].
íd
 =Öhy¢odes[
i
].end;

362 
ªt
++;

369 i‡(!
ªt
) {

370 
phy¢odes
[
ªt
].
°¨t
 = start;

371 
phy¢odes
[
ªt
].
íd
 =Énd;

372 
ªt
 = 1;

374  
ªt
;

375 
	}
}

384 
__öô
 
	$£tup_node_ønge
(
nid
, 
u64
 *
addr
, u64 
size
, u64 
max_addr
)

386 
ªt
 = 0;

387 
nodes
[
nid
].
°¨t
 = *
addr
;

388 *
addr
 +
size
;

389 i‡(*
addr
 >
max_addr
) {

390 *
addr
 = 
max_addr
;

391 
ªt
 = -1;

393 
nodes
[
nid
].
íd
 = *
addr
;

394 
	`node_£t
(
nid
, 
node_possibÀ_m≠
);

395 
	`¥ötk
(
KERN_INFO
 "FakögÇodê%dáà%016Lx-%016Lx (%LuMB)\n", 
nid
,

396 
nodes
[
nid
].
°¨t
,Çodes[nid].
íd
,

397 (
nodes
[
nid
].
íd
 -Çodes[nid].
°¨t
) >> 20);

398  
ªt
;

399 
	}
}

405 
__öô
 
	$•lô_nodes_öãæóve
(
u64
 
addr
, u64 
max_addr
,

406 
ƒ_phys_nodes
, 
ƒ_nodes
)

408 
nodemask_t
 
phy¢ode_mask
 = 
NODE_MASK_NONE
;

409 
u64
 
size
;

410 
big
;

411 
ªt
 = 0;

412 
i
;

414 i‡(
ƒ_nodes
 <= 0)

416 i‡(
ƒ_nodes
 > 
MAX_NUMNODES
) {

417 
	`¥_öfo
("numa=fake=%dÅooÜarge,ÑeducingÅo %d\n",

418 
ƒ_nodes
, 
MAX_NUMNODES
);

419 
ƒ_nodes
 = 
MAX_NUMNODES
;

422 
size
 = (
max_addr
 - 
addr
 - 
	`e820_hﬁe_size
◊ddr, max_addr)Ë/ 
ƒ_nodes
;

427 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë* 
ƒ_nodes
) /

428 
FAKE_NODE_MIN_SIZE
;

430 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

431 i‡(!
size
) {

432 
	`¥_îr
("NotÉnough memory forÉachÇode. "

437 
i
 = 0; i < 
ƒ_phys_nodes
; i++)

438 i‡(
phy¢odes
[
i
].
°¨t
 !phy¢odes[i].
íd
)

439 
	`node_£t
(
i
, 
phy¢ode_mask
);

445 
	`nodes_weight
(
phy¢ode_mask
)) {

446 
	`f‹_óch_node_mask
(
i
, 
phy¢ode_mask
) {

447 
u64
 
íd
 = 
phy¢odes
[
i
].
°¨t
 + 
size
;

448 
u64
 
dma32_íd
 = 
	`PFN_PHYS
(
MAX_DMA32_PFN
);

450 i‡(
ªt
 < 
big
)

451 
íd
 +
FAKE_NODE_MIN_SIZE
;

457 
íd
 - 
phy¢odes
[
i
].
°¨t
 -

458 
	`e820_hﬁe_size
(
phy¢odes
[
i
].
°¨t
, 
íd
Ë< 
size
) {

459 
íd
 +
FAKE_NODE_MIN_SIZE
;

460 i‡(
íd
 > 
phy¢odes
[
i
].end) {

461 
íd
 = 
phy¢odes
[
i
].end;

471 i‡(
íd
 < 
dma32_íd
 && dma32_end -Énd -

472 
	`e820_hﬁe_size
(
íd
, 
dma32_íd
Ë< 
FAKE_NODE_MIN_SIZE
)

473 
íd
 = 
dma32_íd
;

480 i‡(
phy¢odes
[
i
].
íd
 -Énd -

481 
	`e820_hﬁe_size
(
íd
, 
phy¢odes
[
i
].ídË< 
size
)

482 
íd
 = 
phy¢odes
[
i
].end;

489 i‡(
	`nodes_weight
(
phy¢ode_mask
Ë+ 
ªt
 >
ƒ_nodes
)

490 
íd
 = 
phy¢odes
[
i
].end;

492 i‡(
	`£tup_node_ønge
(
ªt
++, &
phy¢odes
[
i
].
°¨t
,

493 
íd
 - 
phy¢odes
[
i
].
°¨t
,

494 
phy¢odes
[
i
].
íd
) < 0)

495 
	`node_˛ór
(
i
, 
phy¢ode_mask
);

498  
ªt
;

499 
	}
}

505 
u64
 
__öô
 
	$föd_íd_of_node
(
u64
 
°¨t
, u64 
max_addr
, u64 
size
)

507 
u64
 
íd
 = 
°¨t
 + 
size
;

509 
íd
 - 
°¨t
 - 
	`e820_hﬁe_size
(°¨t,ÉndË< 
size
) {

510 
íd
 +
FAKE_NODE_MIN_SIZE
;

511 i‡(
íd
 > 
max_addr
) {

512 
íd
 = 
max_addr
;

516  
íd
;

517 
	}
}

523 
__öô
 
	$•lô_nodes_size_öãæóve
(
u64
 
addr
, u64 
max_addr
, u64 
size
)

525 
nodemask_t
 
phy¢ode_mask
 = 
NODE_MASK_NONE
;

526 
u64
 
mö_size
;

527 
ªt
 = 0;

528 
i
;

530 i‡(!
size
)

538 
mö_size
 = (
max_addr
 - 
addr
 - 
	`e820_hﬁe_size
(addr, max_addr)) /

539 
MAX_NUMNODES
;

540 
mö_size
 = 
	`max
(mö_size, 
FAKE_NODE_MIN_SIZE
);

541 i‡((
mö_size
 & 
FAKE_NODE_MIN_HASH_MASK
) < min_size)

542 
mö_size
 = (mö_sizê+ 
FAKE_NODE_MIN_SIZE
) &

543 
FAKE_NODE_MIN_HASH_MASK
;

544 i‡(
size
 < 
mö_size
) {

545 
	`¥_îr
("FakeÇode size %LuMBÅoo small, increasingÅo %LuMB\n",

546 
size
 >> 20, 
mö_size
 >> 20);

547 
size
 = 
mö_size
;

549 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

551 
i
 = 0; i < 
MAX_NUMNODES
; i++)

552 i‡(
phy¢odes
[
i
].
°¨t
 !phy¢odes[i].
íd
)

553 
	`node_£t
(
i
, 
phy¢ode_mask
);

558 
	`nodes_weight
(
phy¢ode_mask
)) {

559 
	`f‹_óch_node_mask
(
i
, 
phy¢ode_mask
) {

560 
u64
 
dma32_íd
 = 
MAX_DMA32_PFN
 << 
PAGE_SHIFT
;

561 
u64
 
íd
;

563 
íd
 = 
	`föd_íd_of_node
(
phy¢odes
[
i
].
°¨t
,

564 
phy¢odes
[
i
].
íd
, 
size
);

570 i‡(
íd
 < 
dma32_íd
 && dma32_end -Énd -

571 
	`e820_hﬁe_size
(
íd
, 
dma32_íd
Ë< 
FAKE_NODE_MIN_SIZE
)

572 
íd
 = 
dma32_íd
;

579 i‡(
phy¢odes
[
i
].
íd
 -Énd -

580 
	`e820_hﬁe_size
(
íd
, 
phy¢odes
[
i
].ídË< 
size
)

581 
íd
 = 
phy¢odes
[
i
].end;

588 i‡(
	`£tup_node_ønge
(
ªt
++, &
phy¢odes
[
i
].
°¨t
,

589 
íd
 - 
phy¢odes
[
i
].
°¨t
,

590 
phy¢odes
[
i
].
íd
) < 0)

591 
	`node_˛ór
(
i
, 
phy¢ode_mask
);

594  
ªt
;

595 
	}
}

601 
__öô
 
	$numa_emuœti⁄
(
°¨t_p‚
,

602 
œ°_p‚
, 
a˝i
, 
k8
)

604 
u64
 
addr
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

605 
u64
 
max_addr
 = 
œ°_p‚
 << 
PAGE_SHIFT
;

606 
num_phys_nodes
;

607 
num_nodes
;

608 
i
;

610 
num_phys_nodes
 = 
	`£tup_phy¢odes
(
addr
, 
max_addr
, 
a˝i
, 
k8
);

616 i‡(
	`°rchr
(
cmdlöe
, 'M') || strchr(cmdline, 'G')) {

617 
u64
 
size
;

619 
size
 = 
	`mem∑r£
(
cmdlöe
, &cmdline);

620 
num_nodes
 = 
	`•lô_nodes_size_öãæóve
(
addr
, 
max_addr
, 
size
);

622 
n
;

624 
n
 = 
	`sim∂e_°πoul
(
cmdlöe
, 
NULL
, 0);

625 
num_nodes
 = 
	`•lô_nodes_öãæóve
(
addr
, 
max_addr
, 
num_phys_nodes
, 
n
);

628 i‡(
num_nodes
 < 0)

629  
num_nodes
;

630 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 
num_nodes
, 
NULL
);

631 i‡(
memnode_shi·
 < 0) {

632 
memnode_shi·
 = 0;

633 
	`¥ötk
(
KERN_ERR
 "No NUMA hash function found. NUMAÉmulation "

642 
	`ªmove_Æl_a˘ive_ønges
();

643 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

644 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

645 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

646 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

648 
	`a˝i_Áke_nodes
(
nodes
, 
num_nodes
);

649 
	`numa_öô_¨øy
();

651 
	}
}

654 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
œ°_p‚
,

655 
a˝i
, 
k8
)

657 
i
;

659 
	`nodes_˛ór
(
node_possibÀ_m≠
);

660 
	`nodes_˛ór
(
node_⁄löe_m≠
);

662 #ifde‡
CONFIG_NUMA_EMU


663 i‡(
cmdlöe
 && !
	`numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
, 
a˝i
, 
k8
))

665 
	`nodes_˛ór
(
node_possibÀ_m≠
);

666 
	`nodes_˛ór
(
node_⁄löe_m≠
);

669 #ifde‡
CONFIG_ACPI_NUMA


670 i‡(!
numa_off
 && 
a˝i
 && !
	`a˝i_sˇn_nodes
(
°¨t_p‚
 << 
PAGE_SHIFT
,

671 
œ°_p‚
 << 
PAGE_SHIFT
))

673 
	`nodes_˛ór
(
node_possibÀ_m≠
);

674 
	`nodes_˛ór
(
node_⁄löe_m≠
);

677 #ifde‡
CONFIG_K8_NUMA


678 i‡(!
numa_off
 && 
k8
 && !
	`k8_sˇn_nodes
())

680 
	`nodes_˛ór
(
node_possibÀ_m≠
);

681 
	`nodes_˛ór
(
node_⁄löe_m≠
);

683 
	`¥ötk
(
KERN_INFO
 "%s\n",

684 
numa_off
 ? "NUMAÅurned off" : "No NUMA configuration found");

686 
	`¥ötk
(
KERN_INFO
 "FakingáÇodeát %016lx-%016lx\n",

687 
°¨t_p‚
 << 
PAGE_SHIFT
,

688 
œ°_p‚
 << 
PAGE_SHIFT
);

690 
memnode_shi·
 = 63;

691 
memnodem≠
 = 
memnode
.
embedded_m≠
;

692 
memnodem≠
[0] = 0;

693 
	`node_£t_⁄löe
(0);

694 
	`node_£t
(0, 
node_possibÀ_m≠
);

695 
i
 = 0; i < 
ƒ_˝u_ids
; i++)

696 
	`numa_£t_node
(
i
, 0);

697 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
œ°_p‚
);

698 
	`£tup_node_boŸmem
(0, 
°¨t_p‚
 << 
PAGE_SHIFT
, 
œ°_p‚
 << PAGE_SHIFT);

699 
	}
}

701 
__öô
 
	$numa_‰ì_Æl_boŸmem
()

703 
∑ges
 = 0;

704 
i
;

706 
	`f‹_óch_⁄löe_node
(
i
)

707 
∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
i
));

709 #ifde‡
CONFIG_NO_BOOTMEM


710 
∑ges
 +
	`‰ì_Æl_mem‹y_c‹e_óæy
(
MAX_NUMNODES
);

713  
∑ges
;

714 
	}
}

716 
__öô
 
	$numa_£tup
(*
›t
)

718 i‡(!
›t
)

719  -
EINVAL
;

720 i‡(!
	`°∫cmp
(
›t
, "off", 3))

721 
numa_off
 = 1;

722 #ifde‡
CONFIG_NUMA_EMU


723 i‡(!
	`°∫cmp
(
›t
, "fake=", 5))

724 
cmdlöe
 = 
›t
 + 5;

726 #ifde‡
CONFIG_ACPI_NUMA


727 i‡(!
	`°∫cmp
(
›t
, "noacpi", 6))

728 
a˝i_numa
 = -1;

731 
	}
}

732 
óæy_∑øm
("numa", 
numa_£tup
);

734 #ifde‡
CONFIG_NUMA


736 
__öô
 
	$föd_√¨_⁄löe_node
(
node
)

738 
n
, 
vÆ
;

739 
mö_vÆ
 = 
INT_MAX
;

740 
be°_node
 = -1;

742 
	`f‹_óch_⁄löe_node
(
n
) {

743 
vÆ
 = 
	`node_di°™˚
(
node
, 
n
);

745 i‡(
vÆ
 < 
mö_vÆ
) {

746 
mö_vÆ
 = 
vÆ
;

747 
be°_node
 = 
n
;

751  
be°_node
;

752 
	}
}

768 
__öô
 
	$öô_˝u_to_node
()

770 
˝u
;

771 
u16
 *
˝u_to_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
);

773 
	`BUG_ON
(
˝u_to_≠icid
 =
NULL
);

775 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

776 
node
;

777 
u16
 
≠icid
 = 
˝u_to_≠icid
[
˝u
];

779 i‡(
≠icid
 =
BAD_APICID
)

781 
node
 = 
≠icid_to_node
[
≠icid
];

782 i‡(
node
 =
NUMA_NO_NODE
)

784 i‡(!
	`node_⁄löe
(
node
))

785 
node
 = 
	`föd_√¨_⁄löe_node
(node);

786 
	`numa_£t_node
(
˝u
, 
node
);

788 
	}
}

792 
__˝uöô
 
	$numa_£t_node
(
˝u
, 
node
)

794 *
˝u_to_node_m≠
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
);

797 i‡(
˝u_to_node_m≠
) {

798 
˝u_to_node_m≠
[
˝u
] = 
node
;

802 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


803 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_possibÀ
(cpu)) {

804 
	`¥ötk
(
KERN_ERR
 "numa_£t_node: invÆid cpu# (%d)\n", 
˝u
);

805 
	`dump_°ack
();

809 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
Ë
node
;

811 i‡(
node
 !
NUMA_NO_NODE
)

812 
	`≥r_˝u
(
node_numbî
, 
˝u
Ë
node
;

813 
	}
}

815 
__˝uöô
 
	$numa_˛ór_node
(
˝u
)

817 
	`numa_£t_node
(
˝u
, 
NUMA_NO_NODE
);

818 
	}
}

820 #i‚de‡
CONFIG_DEBUG_PER_CPU_MAPS


822 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

824 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

825 
	}
}

827 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

829 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

830 
	}
}

837 
__˝uöô
 
	$numa_£t_˝umask
(
˝u
, 
íabÀ
)

839 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

840 
˝umask
 *
mask
;

841 
buf
[64];

843 
mask
 = 
node_to_˝umask_m≠
[
node
];

844 i‡(
mask
 =
NULL
) {

845 
	`¥ötk
(
KERN_ERR
 "node_to_˝umask_m≠[%i] NULL\n", 
node
);

846 
	`dump_°ack
();

850 i‡(
íabÀ
)

851 
	`˝umask_£t_˝u
(
˝u
, 
mask
);

853 
	`˝umask_˛ór_˝u
(
˝u
, 
mask
);

855 
	`˝uli°_s˙¥ötf
(
buf
, (buf), 
mask
);

856 
	`¥ötk
(
KERN_DEBUG
 "%s cpu %dÇode %d: maskÇow %s\n",

857 
íabÀ
 ? "numa_add_˝u" : "numa_ªmove_˝u", 
˝u
, 
node
, 
buf
);

858 
	}
}

860 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

862 
	`numa_£t_˝umask
(
˝u
, 1);

863 
	}
}

865 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

867 
	`numa_£t_˝umask
(
˝u
, 0);

868 
	}
}

870 
	$˝u_to_node
(
˝u
)

872 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)) {

873 
	`¥ötk
(
KERN_WARNING


874 "˝u_to_node(%d): ußgêtoÿóæy!\n", 
˝u
);

875 
	`dump_°ack
();

876  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

878  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

879 
	}
}

880 
EXPORT_SYMBOL
(
˝u_to_node
);

886 
	$óæy_˝u_to_node
(
˝u
)

888 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
))

889  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

891 i‡(!
	`˝u_possibÀ
(
˝u
)) {

892 
	`¥ötk
(
KERN_WARNING


893 "óæy_˝u_to_node(%d):Çÿ≥r_˝uáªa!\n", 
˝u
);

894 
	`dump_°ack
();

895  
NUMA_NO_NODE
;

897  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

898 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<löux/highmem.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/öãºu±.h
>

11 
	~<löux/£q_fûe.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/p‚.h
>

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/gÂ.h
>

17 
	~<asm/e820.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<asm/£tup.h
>

22 
	~<asm/uac˚ss.h
>

23 
	~<asm/pgÆloc.h
>

24 
	~<asm/¥Ÿo.h
>

25 
	~<asm/∑t.h
>

30 
	s˝a_d©a
 {

31 *
	mvaddr
;

32 
pg¥Ÿ_t
 
	mmask_£t
;

33 
pg¥Ÿ_t
 
	mmask_˛r
;

34 
	mnum∑ges
;

35 
	mÊags
;

36 
	mp‚
;

37 
	mf‹˚_•lô
 : 1;

38 
	mcuΩage
;

39 
∑ge
 **
	m∑ges
;

48 
DEFINE_SPINLOCK
(
˝a_lock
);

50 
	#CPA_FLUSHTLB
 1

	)

51 
	#CPA_ARRAY
 2

	)

52 
	#CPA_PAGES_ARRAY
 4

	)

54 #ifde‡
CONFIG_PROC_FS


55 
	gdúe˘_∑ges_cou¡
[
PG_LEVEL_NUM
];

57 
	$upd©e_∑ge_cou¡
(
Àvñ
, 
∑ges
)

59 
Êags
;

62 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

63 
dúe˘_∑ges_cou¡
[
Àvñ
] +
∑ges
;

64 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

65 
	}
}

67 
	$•lô_∑ge_cou¡
(
Àvñ
)

69 
dúe˘_∑ges_cou¡
[
Àvñ
]--;

70 
dúe˘_∑ges_cou¡
[
Àvñ
 - 1] +
PTRS_PER_PTE
;

71 
	}
}

73 
	$¨ch_ªp‹t_memöfo
(
£q_fûe
 *
m
)

75 
	`£q_¥ötf
(
m
, "DirectMap4k: %8lu kB\n",

76 
dúe˘_∑ges_cou¡
[
PG_LEVEL_4K
] << 2);

77 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

78 
	`£q_¥ötf
(
m
, "DirectMap2M: %8lu kB\n",

79 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 11);

81 
	`£q_¥ötf
(
m
, "DirectMap4M: %8lu kB\n",

82 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 12);

84 #ifde‡
CONFIG_X86_64


85 i‡(
dúe˘_gb∑ges
)

86 
	`£q_¥ötf
(
m
, "DirectMap1G: %8lu kB\n",

87 
dúe˘_∑ges_cou¡
[
PG_LEVEL_1G
] << 20);

89 
	}
}

91 
ölöe
 
	$•lô_∑ge_cou¡
(
Àvñ
Ë{ 
	}
}

94 #ifde‡
CONFIG_X86_64


96 
ölöe
 
	$highm≠_°¨t_p‚
()

98  
	`__∑
(
_ãxt
Ë>> 
PAGE_SHIFT
;

99 
	}
}

101 
ölöe
 
	$highm≠_íd_p‚
()

103  
	`__∑
(
	`roundup
(
_brk_íd
, 
PMD_SIZE
)Ë>> 
PAGE_SHIFT
;

104 
	}
}

108 #ifde‡
CONFIG_DEBUG_PAGEALLOC


109 
	#debug_∑góŒoc
 1

	)

111 
	#debug_∑góŒoc
 0

	)

114 
ölöe
 

115 
	$wôhö
(
addr
, 
°¨t
, 
íd
)

117  
addr
 >
°¨t
 &&ádd∏< 
íd
;

118 
	}
}

132 
	$˛Êush_ˇche_ønge
(*
vaddr
, 
size
)

134 *
víd
 = 
vaddr
 + 
size
 - 1;

136 
	`mb
();

138 ; 
vaddr
 < 
víd
; vadd∏+
boŸ_˝u_d©a
.
x86_˛Êush_size
)

139 
	`˛Êush
(
vaddr
);

143 
	`˛Êush
(
víd
);

145 
	`mb
();

146 
	}
}

147 
EXPORT_SYMBOL_GPL
(
˛Êush_ˇche_ønge
);

149 
	$__˝a_Êush_Æl
(*
¨g
)

151 
ˇche
 = ()
¨g
;

157 
	`__Êush_éb_Æl
();

159 i‡(
ˇche
 && 
boŸ_˝u_d©a
.
x86
 >= 4)

160 
	`wbövd
();

161 
	}
}

163 
	$˝a_Êush_Æl
(
ˇche
)

165 
	`BUG_ON
(
	`úqs_dißbÀd
());

167 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
ˇche
, 1);

168 
	}
}

170 
	$__˝a_Êush_ønge
(*
¨g
)

177 
	`__Êush_éb_Æl
();

178 
	}
}

180 
	$˝a_Êush_ønge
(
°¨t
, 
num∑ges
, 
ˇche
)

182 
i
, 
Àvñ
;

183 
addr
;

185 
	`BUG_ON
(
	`úqs_dißbÀd
());

186 
	`WARN_ON
(
	`PAGE_ALIGN
(
°¨t
) != start);

188 
	`⁄_óch_˝u
(
__˝a_Êush_ønge
, 
NULL
, 1);

190 i‡(!
ˇche
)

199 
i
 = 0, 
addr
 = 
°¨t
; i < 
num∑ges
; i++,ádd∏+
PAGE_SIZE
) {

200 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

205 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

206 
	`˛Êush_ˇche_ønge
((*Ë
addr
, 
PAGE_SIZE
);

208 
	}
}

210 
	$˝a_Êush_¨øy
(*
°¨t
, 
num∑ges
, 
ˇche
,

211 
ö_Êags
, 
∑ge
 **
∑ges
)

213 
i
, 
Àvñ
;

214 
do_wbövd
 = 
ˇche
 && 
num∑ges
 >= 1024;

216 
	`BUG_ON
(
	`úqs_dißbÀd
());

218 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
do_wbövd
, 1);

220 i‡(!
ˇche
 || 
do_wbövd
)

229 
i
 = 0; i < 
num∑ges
; i++) {

230 
addr
;

231 
±e_t
 *
±e
;

233 i‡(
ö_Êags
 & 
CPA_PAGES_ARRAY
)

234 
addr
 = ()
	`∑ge_addªss
(
∑ges
[
i
]);

236 
addr
 = 
°¨t
[
i
];

238 
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

243 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

244 
	`˛Êush_ˇche_ønge
((*)
addr
, 
PAGE_SIZE
);

246 
	}
}

254 
ölöe
 
pg¥Ÿ_t
 
	$°©ic_¥Ÿe˘i⁄s
(
pg¥Ÿ_t
 
¥Ÿ
, 
addªss
,

255 
p‚
)

257 
pg¥Ÿ_t
 
f‹biddí
 = 
	`__pg¥Ÿ
(0);

263 i‡(
	`wôhö
(
p‚
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

264 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

271 i‡(
	`wôhö
(
addªss
, ()
_ãxt
, ()
_ëext
))

272 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

278 i‡(
	`wôhö
(
p‚
, 
	`__∑
(()
__°¨t_rod©a
Ë>> 
PAGE_SHIFT
,

279 
	`__∑
(()
__íd_rod©a
Ë>> 
PAGE_SHIFT
))

280 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

282 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_DEBUG_RODATA
)

292 i‡(
kî√l_£t_to_ªad⁄ly
 &&

293 
	`wôhö
(
addªss
, ()
_ãxt
,

294 ()
__íd_rod©a_h∑ge_Æign
)) {

295 
Àvñ
;

314 i‡(
	`lookup_addªss
(
addªss
, &
Àvñ
Ë&& (Àvñ !
PG_LEVEL_4K
))

315 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

319 
¥Ÿ
 = 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
’rŸË& ~pg¥Ÿ_vÆ(
f‹biddí
));

321  
¥Ÿ
;

322 
	}
}

332 
±e_t
 *
	$lookup_addªss
(
addªss
, *
Àvñ
)

334 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
addªss
);

335 
pud_t
 *
pud
;

336 
pmd_t
 *
pmd
;

338 *
Àvñ
 = 
PG_LEVEL_NONE
;

340 i‡(
	`pgd_n⁄e
(*
pgd
))

341  
NULL
;

343 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

344 i‡(
	`pud_n⁄e
(*
pud
))

345  
NULL
;

347 *
Àvñ
 = 
PG_LEVEL_1G
;

348 i‡(
	`pud_œrge
(*
pud
Ë|| !
	`pud_¥e£¡
(*pud))

349  (
±e_t
 *)
pud
;

351 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

352 i‡(
	`pmd_n⁄e
(*
pmd
))

353  
NULL
;

355 *
Àvñ
 = 
PG_LEVEL_2M
;

356 i‡(
	`pmd_œrge
(*
pmd
Ë|| !
	`pmd_¥e£¡
(*pmd))

357  (
±e_t
 *)
pmd
;

359 *
Àvñ
 = 
PG_LEVEL_4K
;

361  
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

362 
	}
}

363 
EXPORT_SYMBOL_GPL
(
lookup_addªss
);

368 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
addªss
,Öã_à
±e
)

371 
	`£t_±e_©omic
(
k±e
, 
±e
);

372 #ifde‡
CONFIG_X86_32


373 i‡(!
SHARED_KERNEL_PMD
) {

374 
∑ge
 *page;

376 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

377 
pgd_t
 *
pgd
;

378 
pud_t
 *
pud
;

379 
pmd_t
 *
pmd
;

381 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

382 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

383 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

384 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

388 
	}
}

391 
	$åy_¥e£rve_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
,

392 
˝a_d©a
 *
˝a
)

394 
√xçage_addr
, 
num∑ges
, 
pmask
, 
psize
, 
Êags
, 
addr
, 
p‚
;

395 
±e_t
 
√w_±e
, 
ﬁd_±e
, *
tmp
;

396 
pg¥Ÿ_t
 
ﬁd_¥Ÿ
, 
√w_¥Ÿ
;

397 
i
, 
do_•lô
 = 1;

398 
Àvñ
;

400 i‡(
˝a
->
f‹˚_•lô
)

403 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

408 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

409 i‡(
tmp
 !
k±e
)

410 
out_u∆ock
;

412 
Àvñ
) {

413 
PG_LEVEL_2M
:

414 
psize
 = 
PMD_PAGE_SIZE
;

415 
pmask
 = 
PMD_PAGE_MASK
;

417 #ifde‡
CONFIG_X86_64


418 
PG_LEVEL_1G
:

419 
psize
 = 
PUD_PAGE_SIZE
;

420 
pmask
 = 
PUD_PAGE_MASK
;

424 
do_•lô
 = -
EINVAL
;

425 
out_u∆ock
;

432 
√xçage_addr
 = (
addªss
 + 
psize
Ë& 
pmask
;

433 
num∑ges
 = (
√xçage_addr
 - 
addªss
Ë>> 
PAGE_SHIFT
;

434 i‡(
num∑ges
 < 
˝a
->numpages)

435 
˝a
->
num∑ges
 =Çumpages;

440 
ﬁd_±e
 = *
k±e
;

441 
ﬁd_¥Ÿ
 = 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

443 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

444 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

450 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
Ë+ ((
addªss
 & (
psize
 - 1)Ë>> 
PAGE_SHIFT
);

451 
˝a
->
p‚
 =Öfn;

453 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

460 
addr
 = 
addªss
 + 
PAGE_SIZE
;

461 
p‚
++;

462 
i
 = 1; i < 
˝a
->
num∑ges
; i++, 
addr
 +
PAGE_SIZE
, 
p‚
++) {

463 
pg¥Ÿ_t
 
chk_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
(
√w_¥Ÿ
, 
addr
, 
p‚
);

465 i‡(
	`pg¥Ÿ_vÆ
(
chk_¥Ÿ
Ë!pg¥Ÿ_vÆ(
√w_¥Ÿ
))

466 
out_u∆ock
;

473 i‡(
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë=pg¥Ÿ_vÆ(
ﬁd_¥Ÿ
)) {

474 
do_•lô
 = 0;

475 
out_u∆ock
;

486 i‡(
addªss
 =(
√xçage_addr
 - 
psize
Ë&& 
˝a
->
num∑ges
 ==Çumpages) {

491 
√w_±e
 = 
	`p‚_±e
(
	`±e_p‚
(
ﬁd_±e
), 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

492 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
√w_±e
);

493 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

494 
do_•lô
 = 0;

497 
out_u∆ock
:

498 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

500  
do_•lô
;

501 
	}
}

503 
	$•lô_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
)

505 
Êags
, 
p‚
, 
p‚öc
 = 1;

506 
i
, 
Àvñ
;

507 
±e_t
 *
pba£
, *
tmp
;

508 
pg¥Ÿ_t
 
ªf_¥Ÿ
;

509 
∑ge
 *
ba£
;

511 i‡(!
debug_∑góŒoc
)

512 
	`•ö_u∆ock
(&
˝a_lock
);

513 
ba£
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_NOTRACK
, 0);

514 i‡(!
debug_∑góŒoc
)

515 
	`•ö_lock
(&
˝a_lock
);

516 i‡(!
ba£
)

517  -
ENOMEM
;

519 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

524 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

525 i‡(
tmp
 !
k±e
)

526 
out_u∆ock
;

528 
pba£
 = (
±e_t
 *)
	`∑ge_addªss
(
ba£
);

529 
	`∑øvút_Æloc_±e
(&
öô_mm
, 
	`∑ge_to_p‚
(
ba£
));

530 
ªf_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*
k±e
));

537 
	`WARN_ON_ONCE
(
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë& 
_PAGE_PAT_LARGE
);

539 #ifde‡
CONFIG_X86_64


540 i‡(
Àvñ
 =
PG_LEVEL_1G
) {

541 
p‚öc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

542 
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë|
_PAGE_PSE
;

549 
p‚
 = 
	`±e_p‚
(*
k±e
);

550 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
p‚
 +
p‚öc
)

551 
	`£t_±e
(&
pba£
[
i
], 
	`p‚_±e
(
p‚
, 
ªf_¥Ÿ
));

553 i‡(
addªss
 >()
	`__va
(0) &&

554 
addªss
 < ()
	`__va
(
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
))

555 
	`•lô_∑ge_cou¡
(
Àvñ
);

557 #ifde‡
CONFIG_X86_64


558 i‡(
addªss
 >()
	`__va
(1UL<<32) &&

559 
addªss
 < ()
	`__va
(
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))

560 
	`•lô_∑ge_cou¡
(
Àvñ
);

570 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
	`mk_±e
(
ba£
, 
	`__pg¥Ÿ
(
_KERNPG_TABLE
)));

580 
	`__Êush_éb_Æl
();

582 
ba£
 = 
NULL
;

584 
out_u∆ock
:

589 i‡(
ba£
)

590 
	`__‰ì_∑ge
(
ba£
);

591 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

594 
	}
}

596 
	$__˝a_¥o˚ss_Áu…
(
˝a_d©a
 *
˝a
, 
vaddr
,

597 
¥im¨y
)

602 i‡(!
¥im¨y
)

612 i‡(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

613 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))) {

614 
˝a
->
num∑ges
 = 1;

615 
˝a
->
p‚
 = 
	`__∑
(
vaddr
Ë>> 
PAGE_SHIFT
;

618 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zeroÖte. "

619 "vadd∏%lx c∑->vadd∏%lx\n", 
vaddr
,

620 *
˝a
->
vaddr
);

622  -
EFAULT
;

624 
	}
}

626 
	$__ch™ge_∑ge_©å
(
˝a_d©a
 *
˝a
, 
¥im¨y
)

628 
addªss
;

629 
do_•lô
, 
îr
;

630 
Àvñ
;

631 
±e_t
 *
k±e
, 
ﬁd_±e
;

633 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

634 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

635 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

637 
addªss
 = ()
	`∑ge_addªss
(
∑ge
);

638 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

639 
addªss
 = 
˝a
->
vaddr
[˝a->
cuΩage
];

641 
addªss
 = *
˝a
->
vaddr
;

642 
ª≥©
:

643 
k±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

644 i‡(!
k±e
)

645  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

647 
ﬁd_±e
 = *
k±e
;

648 i‡(!
	`±e_vÆ
(
ﬁd_±e
))

649  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

651 i‡(
Àvñ
 =
PG_LEVEL_4K
) {

652 
±e_t
 
√w_±e
;

653 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

654 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
);

656 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

657 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

659 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

666 
√w_±e
 = 
	`p‚_±e
(
p‚
, 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

667 
˝a
->
p‚
 =Öfn;

671 i‡(
	`±e_vÆ
(
ﬁd_±e
Ë!±e_vÆ(
√w_±e
)) {

672 
	`£t_±e_©omic
(
k±e
, 
√w_±e
);

673 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

675 
˝a
->
num∑ges
 = 1;

683 
do_•lô
 = 
	`åy_¥e£rve_œrge_∑ge
(
k±e
, 
addªss
, 
˝a
);

689 i‡(
do_•lô
 <= 0)

690  
do_•lô
;

695 
îr
 = 
	`•lô_œrge_∑ge
(
k±e
, 
addªss
);

696 i‡(!
îr
) {

715 
	`Êush_éb_Æl
();

716 
ª≥©
;

719  
îr
;

720 
	}
}

722 
__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
);

724 
	$˝a_¥o˚ss_Æüs
(
˝a_d©a
 *
˝a
)

726 
˝a_d©a
 
Æüs_˝a
;

727 
œddr
 = ()
	`__va
(
˝a
->
p‚
 << 
PAGE_SHIFT
);

728 
vaddr
;

729 
ªt
;

731 i‡(
˝a
->
p‚
 >
max_p‚_m≠≥d
)

734 #ifde‡
CONFIG_X86_64


735 i‡(
˝a
->
p‚
 >
max_low_p‚_m≠≥d
 && c∑->p‚ < (1UL<<(32-
PAGE_SHIFT
)))

742 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

743 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

744 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

746 
vaddr
 = ()
	`∑ge_addªss
(
∑ge
);

747 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

748 
vaddr
 = 
˝a
->vaddr[˝a->
cuΩage
];

750 
vaddr
 = *
˝a
->vaddr;

752 i‡(!(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

753 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
)))) {

755 
Æüs_˝a
 = *
˝a
;

756 
Æüs_˝a
.
vaddr
 = &
œddr
;

757 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

759 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

760 i‡(
ªt
)

761  
ªt
;

764 #ifde‡
CONFIG_X86_64


770 i‡(!
	`wôhö
(
vaddr
, ()
_ãxt
, 
_brk_íd
) &&

771 
	`wôhö
(
˝a
->
p‚
, 
	`highm≠_°¨t_p‚
(), 
	`highm≠_íd_p‚
())) {

772 
ãmp_˝a_vaddr
 = (
˝a
->
p‚
 << 
PAGE_SHIFT
) +

773 
__START_KERNEL_m≠
 - 
phys_ba£
;

774 
Æüs_˝a
 = *
˝a
;

775 
Æüs_˝a
.
vaddr
 = &
ãmp_˝a_vaddr
;

776 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

782 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

787 
	}
}

789 
	$__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
)

791 
ªt
, 
num∑ges
 = 
˝a
->numpages;

793 
num∑ges
) {

798 
˝a
->
num∑ges
 =Çumpages;

800 i‡(
˝a
->
Êags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

801 
˝a
->
num∑ges
 = 1;

803 i‡(!
debug_∑góŒoc
)

804 
	`•ö_lock
(&
˝a_lock
);

805 
ªt
 = 
	`__ch™ge_∑ge_©å
(
˝a
, 
checkÆüs
);

806 i‡(!
debug_∑góŒoc
)

807 
	`•ö_u∆ock
(&
˝a_lock
);

808 i‡(
ªt
)

809  
ªt
;

811 i‡(
checkÆüs
) {

812 
ªt
 = 
	`˝a_¥o˚ss_Æüs
(
˝a
);

813 i‡(
ªt
)

814  
ªt
;

822 
	`BUG_ON
(
˝a
->
num∑ges
 >Çumpages);

823 
num∑ges
 -
˝a
->numpages;

824 i‡(
˝a
->
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

825 
˝a
->
cuΩage
++;

827 *
˝a
->
vaddr
 +˝a->
num∑ges
 * 
PAGE_SIZE
;

831 
	}
}

833 
ölöe
 
	$ˇche_©å
(
pg¥Ÿ_t
 
©å
)

835  
	`pg¥Ÿ_vÆ
(
©å
) &

836 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

837 
	}
}

839 
	$ch™ge_∑ge_©å_£t_˛r
(*
addr
, 
num∑ges
,

840 
pg¥Ÿ_t
 
mask_£t
,Ög¥Ÿ_à
mask_˛r
,

841 
f‹˚_•lô
, 
ö_Êag
,

842 
∑ge
 **
∑ges
)

844 
˝a_d©a
 
˝a
;

845 
ªt
, 
ˇche
, 
checkÆüs
;

846 
baddr
 = 0;

852 
mask_£t
 = 
	`ˇn⁄_pg¥Ÿ
(mask_set);

853 
mask_˛r
 = 
	`ˇn⁄_pg¥Ÿ
(mask_clr);

854 i‡(!
	`pg¥Ÿ_vÆ
(
mask_£t
Ë&& !pg¥Ÿ_vÆ(
mask_˛r
Ë&& !
f‹˚_•lô
)

858 i‡(
ö_Êag
 & 
CPA_ARRAY
) {

859 
i
;

860 
i
 = 0; i < 
num∑ges
; i++) {

861 i‡(
addr
[
i
] & ~
PAGE_MASK
) {

862 
addr
[
i
] &
PAGE_MASK
;

863 
	`WARN_ON_ONCE
(1);

866 } i‡(!(
ö_Êag
 & 
CPA_PAGES_ARRAY
)) {

871 i‡(*
addr
 & ~
PAGE_MASK
) {

872 *
addr
 &
PAGE_MASK
;

876 
	`WARN_ON_ONCE
(1);

882 
baddr
 = *
addr
;

886 
	`km≠_Êush_unu£d
();

888 
	`vm_unm≠_Æü£s
();

890 
˝a
.
vaddr
 = 
addr
;

891 
˝a
.
∑ges
 =Öages;

892 
˝a
.
num∑ges
 =Çumpages;

893 
˝a
.
mask_£t
 = mask_set;

894 
˝a
.
mask_˛r
 = mask_clr;

895 
˝a
.
Êags
 = 0;

896 
˝a
.
cuΩage
 = 0;

897 
˝a
.
f‹˚_•lô
 = force_split;

899 i‡(
ö_Êag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

900 
˝a
.
Êags
 |
ö_Êag
;

903 
checkÆüs
 = (
	`pg¥Ÿ_vÆ
(
mask_£t
Ë|Ög¥Ÿ_vÆ(
mask_˛r
)Ë!
_PAGE_NX
;

905 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 
checkÆüs
);

910 i‡(!(
˝a
.
Êags
 & 
CPA_FLUSHTLB
))

911 
out
;

917 
ˇche
 = 
	`ˇche_©å
(
mask_£t
);

925 i‡(!
ªt
 && 
˝u_has_˛Êush
) {

926 i‡(
˝a
.
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

927 
	`˝a_Êush_¨øy
(
addr
, 
num∑ges
, 
ˇche
,

928 
˝a
.
Êags
, 
∑ges
);

930 
	`˝a_Êush_ønge
(
baddr
, 
num∑ges
, 
ˇche
);

932 
	`˝a_Êush_Æl
(
ˇche
);

934 
out
:

935  
ªt
;

936 
	}
}

938 
ölöe
 
	$ch™ge_∑ge_©å_£t
(*
addr
, 
num∑ges
,

939 
pg¥Ÿ_t
 
mask
, 
¨øy
)

941  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

942 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

943 
	}
}

945 
ölöe
 
	$ch™ge_∑ge_©å_˛ór
(*
addr
, 
num∑ges
,

946 
pg¥Ÿ_t
 
mask
, 
¨øy
)

948  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

949 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

950 
	}
}

952 
ölöe
 
	$˝a_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

953 
pg¥Ÿ_t
 
mask
)

955  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

956 
CPA_PAGES_ARRAY
, 
∑ges
);

957 
	}
}

959 
ölöe
 
	$˝a_˛ór_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

960 
pg¥Ÿ_t
 
mask
)

962  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

963 
CPA_PAGES_ARRAY
, 
∑ges
);

964 
	}
}

966 
	$_£t_mem‹y_uc
(
addr
, 
num∑ges
)

971  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

972 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

973 
	}
}

975 
	$£t_mem‹y_uc
(
addr
, 
num∑ges
)

977 
ªt
;

982 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

983 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

984 i‡(
ªt
)

985 
out_îr
;

987 
ªt
 = 
	`_£t_mem‹y_uc
(
addr
, 
num∑ges
);

988 i‡(
ªt
)

989 
out_‰ì
;

993 
out_‰ì
:

994 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

995 
out_îr
:

996  
ªt
;

997 
	}
}

998 
EXPORT_SYMBOL
(
£t_mem‹y_uc
);

1000 
	$£t_mem‹y_¨øy_uc
(*
addr
, 
addrö¨øy
)

1002 
i
, 
j
;

1003 
ªt
;

1008 
i
 = 0; i < 
addrö¨øy
; i++) {

1009 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
,

1010 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

1011 i‡(
ªt
)

1012 
out_‰ì
;

1015 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(
addr
, 
addrö¨øy
,

1016 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 1);

1017 i‡(
ªt
)

1018 
out_‰ì
;

1022 
out_‰ì
:

1023 
j
 = 0; j < 
i
; j++)

1024 
	`‰ì_memty≥
(
	`__∑
(
addr
[
j
]), __∑◊ddr[j]Ë+ 
PAGE_SIZE
);

1026  
ªt
;

1027 
	}
}

1028 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_uc
);

1030 
	$_£t_mem‹y_wc
(
addr
, 
num∑ges
)

1032 
ªt
;

1033 
addr_c›y
 = 
addr
;

1035 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

1036 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

1037 i‡(!
ªt
) {

1038 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(&
addr_c›y
, 
num∑ges
,

1039 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1040 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1041 0, 0, 
NULL
);

1043  
ªt
;

1044 
	}
}

1046 
	$£t_mem‹y_wc
(
addr
, 
num∑ges
)

1048 
ªt
;

1050 i‡(!
∑t_íabÀd
)

1051  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1053 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

1054 
_PAGE_CACHE_WC
, 
NULL
);

1055 i‡(
ªt
)

1056 
out_îr
;

1058 
ªt
 = 
	`_£t_mem‹y_wc
(
addr
, 
num∑ges
);

1059 i‡(
ªt
)

1060 
out_‰ì
;

1064 
out_‰ì
:

1065 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1066 
out_îr
:

1067  
ªt
;

1068 
	}
}

1069 
EXPORT_SYMBOL
(
£t_mem‹y_wc
);

1071 
	$_£t_mem‹y_wb
(
addr
, 
num∑ges
)

1073  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
,

1074 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 0);

1075 
	}
}

1077 
	$£t_mem‹y_wb
(
addr
, 
num∑ges
)

1079 
ªt
;

1081 
ªt
 = 
	`_£t_mem‹y_wb
(
addr
, 
num∑ges
);

1082 i‡(
ªt
)

1083  
ªt
;

1085 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1087 
	}
}

1088 
EXPORT_SYMBOL
(
£t_mem‹y_wb
);

1090 
	$£t_mem‹y_¨øy_wb
(*
addr
, 
addrö¨øy
)

1092 
i
;

1093 
ªt
;

1095 
ªt
 = 
	`ch™ge_∑ge_©å_˛ór
(
addr
, 
addrö¨øy
,

1096 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 1);

1097 i‡(
ªt
)

1098  
ªt
;

1100 
i
 = 0; i < 
addrö¨øy
; i++)

1101 
	`‰ì_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
);

1104 
	}
}

1105 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wb
);

1107 
	$£t_mem‹y_x
(
addr
, 
num∑ges
)

1109 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1112  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1113 
	}
}

1114 
EXPORT_SYMBOL
(
£t_mem‹y_x
);

1116 
	$£t_mem‹y_nx
(
addr
, 
num∑ges
)

1118 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1121  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1122 
	}
}

1123 
EXPORT_SYMBOL
(
£t_mem‹y_nx
);

1125 
	$£t_mem‹y_ro
(
addr
, 
num∑ges
)

1127  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1128 
	}
}

1129 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_ro
);

1131 
	$£t_mem‹y_rw
(
addr
, 
num∑ges
)

1133  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1134 
	}
}

1135 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_rw
);

1137 
	$£t_mem‹y_≈
(
addr
, 
num∑ges
)

1139  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_PRESENT
), 0);

1140 
	}
}

1142 
	$£t_mem‹y_4k
(
addr
, 
num∑ges
)

1144  
	`ch™ge_∑ge_©å_£t_˛r
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0),

1145 
	`__pg¥Ÿ
(0), 1, 0, 
NULL
);

1146 
	}
}

1148 
	$£t_∑ges_uc
(
∑ge
 *∑ge, 
num∑ges
)

1150 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1152  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1153 
	}
}

1154 
EXPORT_SYMBOL
(
£t_∑ges_uc
);

1156 
	$£t_∑ges_¨øy_uc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1158 
°¨t
;

1159 
íd
;

1160 
i
;

1161 
‰ì_idx
;

1163 
i
 = 0; i < 
addrö¨øy
; i++) {

1164 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1166 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1167 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1168 i‡(
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
_PAGE_CACHE_UC_MINUS
, 
NULL
))

1169 
îr_out
;

1172 i‡(
	`˝a_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1173 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
)) == 0) {

1176 
îr_out
:

1177 
‰ì_idx
 = 
i
;

1178 
i
 = 0; i < 
‰ì_idx
; i++) {

1179 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1181 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1182 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1183 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1185  -
EINVAL
;

1186 
	}
}

1187 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_uc
);

1189 
	$£t_∑ges_wb
(
∑ge
 *∑ge, 
num∑ges
)

1191 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1193  
	`£t_mem‹y_wb
(
addr
, 
num∑ges
);

1194 
	}
}

1195 
EXPORT_SYMBOL
(
£t_∑ges_wb
);

1197 
	$£t_∑ges_¨øy_wb
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1199 
ªtvÆ
;

1200 
°¨t
;

1201 
íd
;

1202 
i
;

1204 
ªtvÆ
 = 
	`˝a_˛ór_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1205 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
));

1206 i‡(
ªtvÆ
)

1207  
ªtvÆ
;

1209 
i
 = 0; i < 
addrö¨øy
; i++) {

1210 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1212 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1213 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1214 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1218 
	}
}

1219 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wb
);

1221 
	$£t_∑ges_x
(
∑ge
 *∑ge, 
num∑ges
)

1223 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1225  
	`£t_mem‹y_x
(
addr
, 
num∑ges
);

1226 
	}
}

1227 
EXPORT_SYMBOL
(
£t_∑ges_x
);

1229 
	$£t_∑ges_nx
(
∑ge
 *∑ge, 
num∑ges
)

1231 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1233  
	`£t_mem‹y_nx
(
addr
, 
num∑ges
);

1234 
	}
}

1235 
EXPORT_SYMBOL
(
£t_∑ges_nx
);

1237 
	$£t_∑ges_ro
(
∑ge
 *∑ge, 
num∑ges
)

1239 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1241  
	`£t_mem‹y_ro
(
addr
, 
num∑ges
);

1242 
	}
}

1244 
	$£t_∑ges_rw
(
∑ge
 *∑ge, 
num∑ges
)

1246 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1248  
	`£t_mem‹y_rw
(
addr
, 
num∑ges
);

1249 
	}
}

1251 #ifde‡
CONFIG_DEBUG_PAGEALLOC


1253 
	$__£t_∑ges_p
(
∑ge
 *∑ge, 
num∑ges
)

1255 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1256 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1257 .
num∑ges
 =Çumpages,

1258 .
mask_£t
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1259 .
mask_˛r
 = 
	`__pg¥Ÿ
(0),

1260 .
Êags
 = 0};

1268  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1269 
	}
}

1271 
	$__£t_∑ges_≈
(
∑ge
 *∑ge, 
num∑ges
)

1273 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1274 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1275 .
num∑ges
 =Çumpages,

1276 .
mask_£t
 = 
	`__pg¥Ÿ
(0),

1277 .
mask_˛r
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1278 .
Êags
 = 0};

1286  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1287 
	}
}

1289 
	$kî√l_m≠_∑ges
(
∑ge
 *∑ge, 
num∑ges
, 
íabÀ
)

1291 i‡(
	`PageHighMem
(
∑ge
))

1293 i‡(!
íabÀ
) {

1294 
	`debug_check_no_locks_‰ìd
(
	`∑ge_addªss
(
∑ge
),

1295 
num∑ges
 * 
PAGE_SIZE
);

1301 i‡(!
debug_∑góŒoc_íabÀd
)

1309 i‡(
íabÀ
)

1310 
	`__£t_∑ges_p
(
∑ge
, 
num∑ges
);

1312 
	`__£t_∑ges_≈
(
∑ge
, 
num∑ges
);

1318 
	`__Êush_éb_Æl
();

1319 
	}
}

1321 #ifde‡
CONFIG_HIBERNATION


1323 
boﬁ
 
	$kî√l_∑ge_¥e£¡
(
∑ge
 *page)

1325 
Àvñ
;

1326 
±e_t
 *
±e
;

1328 i‡(
	`PageHighMem
(
∑ge
))

1329  
Ál£
;

1331 
±e
 = 
	`lookup_addªss
(()
	`∑ge_addªss
(
∑ge
), &
Àvñ
);

1332  (
	`±e_vÆ
(*
±e
Ë& 
_PAGE_PRESENT
);

1333 
	}
}

1343 #ifde‡
CONFIG_CPA_DEBUG


1344 
	~"∑góâr-ã°.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<löux/£q_fûe.h
>

11 
	~<löux/boŸmem.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/rbåì.h
>

20 
	~<asm/ˇcheÊush.h
>

21 
	~<asm/¥o˚ss‹.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/x86_öô.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/f˙é.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/mår.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/m§.h
>

30 
	~<asm/∑t.h
>

31 
	~<asm/io.h
>

33 #ifde‡
CONFIG_X86_PAT


34 
__ªad_mo°ly
 
	g∑t_íabÀd
 = 1;

36 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

38 
∑t_íabÀd
 = 0;

39 
	`¥ötk
(
KERN_INFO
 "%s\n", 
ªas⁄
);

40 
	}
}

42 
__öô
 
	$n›©
(*
°r
)

44 
	`∑t_dißbÀ
("PAT support disabled.");

46 
	}
}

47 
óæy_∑øm
("n›©", 
n›©
);

49 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

51 ()
ªas⁄
;

52 
	}
}

56 
	gdebug_íabÀ
;

58 
__öô
 
	$∑t_debug_£tup
(*
°r
)

60 
debug_íabÀ
 = 1;

62 
	}
}

63 
__£tup
("debug∑t", 
∑t_debug_£tup
);

65 
	#d¥ötk
(
fmt
, 
¨g
...) \

66 dÿ{ i‡(
debug_íabÀ
Ë
	`¥ötk
(
KERN_INFO
 
fmt
, ##
¨g
); } 0)

	)

69 
u64
 
__ªad_mo°ly
 
	gboŸ_∑t_°©e
;

72 
	mPAT_UC
 = 0,

73 
	mPAT_WC
 = 1,

74 
	mPAT_WT
 = 4,

75 
	mPAT_WP
 = 5,

76 
	mPAT_WB
 = 6,

77 
	mPAT_UC_MINUS
 = 7,

80 
	#PAT
(
x
, 
y
Ë((
u64
)
PAT_
 ## y << ((x)*8))

	)

82 
	$∑t_öô
()

84 
u64
 
∑t
;

85 
boﬁ
 
boŸ_˝u
 = !
boŸ_∑t_°©e
;

87 i‡(!
∑t_íabÀd
)

90 i‡(!
˝u_has_∑t
) {

91 i‡(!
boŸ_∑t_°©e
) {

92 
	`∑t_dißbÀ
("PATÇot supported by CPU.");

100 
	`¥ötk
(
KERN_ERR
 "PATÉnabled, "

102 
	`BUG
();

119 
∑t
 = 
	`PAT
(0, 
WB
Ë| PAT(1, 
WC
Ë| PAT(2, 
UC_MINUS
Ë| PAT(3, 
UC
) |

120 
	`PAT
(4, 
WB
Ë| PAT(5, 
WC
Ë| PAT(6, 
UC_MINUS
Ë| PAT(7, 
UC
);

123 i‡(!
boŸ_∑t_°©e
)

124 
	`rdm§l
(
MSR_IA32_CR_PAT
, 
boŸ_∑t_°©e
);

126 
	`wrm§l
(
MSR_IA32_CR_PAT
, 
∑t
);

128 i‡(
boŸ_˝u
)

129 
	`¥ötk
(
KERN_INFO
 "x86 PATÉnabled: cpu %d, old 0x%Lx,Çew 0x%Lx\n",

130 
	`smp_¥o˚ss‹_id
(), 
boŸ_∑t_°©e
, 
∑t
);

131 
	}
}

133 #unde‡
PAT


135 *
	$ˇâr_«me
(
Êags
)

137 
Êags
 & 
_PAGE_CACHE_MASK
) {

138 
_PAGE_CACHE_UC
:  "uncached";

139 
_PAGE_CACHE_UC_MINUS
:  "uncached-minus";

140 
_PAGE_CACHE_WB
:  "write-back";

141 
_PAGE_CACHE_WC
:  "write-combining";

144 
	}
}

162 
	smemty≥
 {

163 
u64
 
	m°¨t
;

164 
u64
 
	míd
;

165 
	mty≥
;

166 
li°_hód
 
	mnd
;

167 
rb_node
 
	mrb
;

170 
rb_roŸ
 
	gmemty≥_rbroŸ
 = 
RB_ROOT
;

171 
LIST_HEAD
(
memty≥_li°
);

172 
DEFINE_SPINLOCK
(
memty≥_lock
);

174 
memty≥
 *
	$memty≥_rb_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
°¨t
)

176 
rb_node
 *
node
 = 
roŸ
->rb_node;

177 
memty≥
 *
œ°_lowî
 = 
NULL
;

179 
node
) {

180 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

182 i‡(
d©a
->
°¨t
 < start) {

183 
œ°_lowî
 = 
d©a
;

184 
node
 =Çode->
rb_right
;

185 } i‡(
d©a
->
°¨t
 > start) {

186 
node
 =Çode->
rb_À·
;

188  
d©a
;

192  
œ°_lowî
;

193 
	}
}

195 
	$memty≥_rb_ö£π
(
rb_roŸ
 *
roŸ
, 
memty≥
 *
d©a
)

197 
rb_node
 **
√w
 = &(
roŸ
->rb_node);

198 
rb_node
 *
∑ª¡
 = 
NULL
;

200 *
√w
) {

201 
memty≥
 *
this
 = 
	`c⁄èöî_of
(*
√w
, memty≥, 
rb
);

203 
∑ª¡
 = *
√w
;

204 i‡(
d©a
->
°¨t
 <
this
->start)

205 
√w
 = &((*√w)->
rb_À·
);

206 i‡(
d©a
->
°¨t
 > 
this
->start)

207 
√w
 = &((*√w)->
rb_right
);

210 
	`rb_lök_node
(&
d©a
->
rb
, 
∑ª¡
, 
√w
);

211 
	`rb_ö£π_cﬁ‹
(&
d©a
->
rb
, 
roŸ
);

212 
	}
}

221 
	$∑t_x_mår_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
)

227 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WB
) {

228 
u8
 
mår_ty≥
;

230 
mår_ty≥
 = 
	`mår_ty≥_lookup
(
°¨t
, 
íd
);

231 i‡(
mår_ty≥
 !
MTRR_TYPE_WRBACK
)

232  
_PAGE_CACHE_UC_MINUS
;

234  
_PAGE_CACHE_WB
;

237  
ªq_ty≥
;

238 
	}
}

241 
	$chk_c⁄Êi˘
(
memty≥
 *
√w
, memty≥ *
íåy
, *
ty≥
)

243 i‡(
√w
->
ty≥
 !
íåy
->type) {

244 i‡(
ty≥
) {

245 
√w
->
ty≥
 = 
íåy
->type;

246 *
ty≥
 = 
íåy
->type;

248 
c⁄Êi˘
;

252 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
, &
memty≥_li°
, 
nd
) {

253 i‡(
√w
->
íd
 <
íåy
->
°¨t
)

255 i‡(
√w
->
ty≥
 !
íåy
->type)

256 
c⁄Êi˘
;

260 
c⁄Êi˘
:

261 
	`¥ötk
(
KERN_INFO
 "%s:%d conflicting memoryÅypes "

262 "%Lx-%Lx %s<->%s\n", 
cuºít
->
comm
, cuºít->
pid
, 
√w
->
°¨t
,

263 
√w
->
íd
, 
	`ˇâr_«me
“ew->
ty≥
), c©å_«me(
íåy
->type));

264  -
EBUSY
;

265 
	}
}

267 
	$∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
)

269 
øm_∑ge
 = 0, 
nŸ_øm∑ge
 = 0;

270 
∑ge_ƒ
;

272 
∑ge_ƒ
 = (
°¨t
 >> 
PAGE_SHIFT
);Öage_ƒ < (
íd
 >> PAGE_SHIFT);

273 ++
∑ge_ƒ
) {

281 i‡(
∑ge_ƒ
 >(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

282 
	`∑ge_is_øm
(
∑ge_ƒ
))

283 
øm_∑ge
 = 1;

285 
nŸ_øm∑ge
 = 1;

287 i‡(
øm_∑ge
 =
nŸ_øm∑ge
)

291  
øm_∑ge
;

292 
	}
}

302 
	$ª£rve_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

303 *
√w_ty≥
)

305 
∑ge
 *page;

306 
u64
 
p‚
;

308 i‡(
ªq_ty≥
 =
_PAGE_CACHE_UC
) {

310 
	`WARN_ON_ONCE
(1);

311 
ªq_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

314 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

315 
ty≥
;

317 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

318 
ty≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

319 i‡(
ty≥
 != -1) {

320 
	`¥ötk
(
KERN_INFO
 "reserve_ram_pages_type failed "

322 
°¨t
, 
íd
, 
ty≥
, 
ªq_ty≥
);

323 i‡(
√w_ty≥
)

324 *
√w_ty≥
 = 
ty≥
;

326  -
EBUSY
;

330 i‡(
√w_ty≥
)

331 *
√w_ty≥
 = 
ªq_ty≥
;

333 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

334 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

335 
	`£t_∑ge_memty≥
(
∑ge
, 
ªq_ty≥
);

338 
	}
}

340 
	$‰ì_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
)

342 
∑ge
 *page;

343 
u64
 
p‚
;

345 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

346 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

347 
	`£t_∑ge_memty≥
(
∑ge
, -1);

350 
	}
}

364 
	$ª£rve_memty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

365 *
√w_ty≥
)

367 
memty≥
 *
√w
, *
íåy
;

368 
a˘uÆ_ty≥
;

369 
li°_hód
 *
whîe
;

370 
is_ønge_øm
;

371 
îr
 = 0;

373 
	`BUG_ON
(
°¨t
 >
íd
);

375 i‡(!
∑t_íabÀd
) {

377 i‡(
√w_ty≥
) {

378 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WC
)

379 *
√w_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

381 *
√w_ty≥
 = 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
;

387 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
)) {

388 i‡(
√w_ty≥
)

389 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

399 
a˘uÆ_ty≥
 = 
	`∑t_x_mår_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
);

401 i‡(
√w_ty≥
)

402 *
√w_ty≥
 = 
a˘uÆ_ty≥
;

404 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

405 i‡(
is_ønge_øm
 == 1) {

407 
	`•ö_lock
(&
memty≥_lock
);

408 
îr
 = 
	`ª£rve_øm_∑ges_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, 
√w_ty≥
);

409 
	`•ö_u∆ock
(&
memty≥_lock
);

411  
îr
;

412 } i‡(
is_ønge_øm
 < 0) {

413  -
EINVAL
;

416 
√w
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

417 i‡(!
√w
)

418  -
ENOMEM
;

420 
√w
->
°¨t
 = start;

421 
√w
->
íd
 =Énd;

422 
√w
->
ty≥
 = 
a˘uÆ_ty≥
;

424 
	`•ö_lock
(&
memty≥_lock
);

427 
whîe
 = 
NULL
;

428 
	`li°_f‹_óch_íåy
(
íåy
, &
memty≥_li°
, 
nd
) {

429 i‡(
íd
 <
íåy
->
°¨t
) {

430 
whîe
 = 
íåy
->
nd
.
¥ev
;

432 } i‡(
°¨t
 <
íåy
->start) {

433 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

434 i‡(!
îr
) {

435 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

436 
íåy
->
°¨t
,É¡ry->
íd
);

437 
whîe
 = 
íåy
->
nd
.
¥ev
;

440 } i‡(
°¨t
 < 
íåy
->
íd
) {

441 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

442 i‡(!
îr
) {

443 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

444 
íåy
->
°¨t
,É¡ry->
íd
);

450 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
,

451 &
memty≥_li°
, 
nd
) {

452 i‡(
°¨t
 <
íåy
->start) {

453 
whîe
 = 
íåy
->
nd
.
¥ev
;

462 i‡(
îr
) {

463 
	`¥ötk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

465 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
));

466 
	`k‰ì
(
√w
);

467 
	`•ö_u∆ock
(&
memty≥_lock
);

469  
îr
;

472 i‡(
whîe
)

473 
	`li°_add
(&
√w
->
nd
, 
whîe
);

475 
	`li°_add_èû
(&
√w
->
nd
, &
memty≥_li°
);

477 
	`memty≥_rb_ö£π
(&
memty≥_rbroŸ
, 
√w
);

479 
	`•ö_u∆ock
(&
memty≥_lock
);

481 
	`d¥ötk
("reserve_memtypeádded 0x%Lx-0x%Lx,Årack %s,Ñeq %s,Ñet %s\n",

482 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
),

483 
√w_ty≥
 ? 
	`ˇâr_«me
(*new_type) : "-");

485  
îr
;

486 
	}
}

488 
	$‰ì_memty≥
(
u64
 
°¨t
, u64 
íd
)

490 
memty≥
 *
íåy
, *
ßved_íåy
;

491 
îr
 = -
EINVAL
;

492 
is_ønge_øm
;

494 i‡(!
∑t_íabÀd
)

498 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
))

501 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

502 i‡(
is_ønge_øm
 == 1) {

504 
	`•ö_lock
(&
memty≥_lock
);

505 
îr
 = 
	`‰ì_øm_∑ges_ty≥
(
°¨t
, 
íd
);

506 
	`•ö_u∆ock
(&
memty≥_lock
);

508  
îr
;

509 } i‡(
is_ønge_øm
 < 0) {

510  -
EINVAL
;

513 
	`•ö_lock
(&
memty≥_lock
);

515 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
°¨t
);

516 i‡(
	`u∆ikñy
(
íåy
 =
NULL
))

517 
u∆ock_ªt
;

525 
ßved_íåy
 = 
íåy
;

526 
	`li°_f‹_óch_íåy_‰om
(
íåy
, &
memty≥_li°
, 
nd
) {

527 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

528 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

529 
	`li°_dñ
(&
íåy
->
nd
);

530 
	`k‰ì
(
íåy
);

531 
îr
 = 0;

533 } i‡(
íåy
->
°¨t
 > start) {

538 i‡(!
îr
)

539 
u∆ock_ªt
;

541 
íåy
 = 
ßved_íåy
;

542 
	`li°_f‹_óch_íåy_ªvî£
(
íåy
, &
memty≥_li°
, 
nd
) {

543 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

544 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

545 
	`li°_dñ
(&
íåy
->
nd
);

546 
	`k‰ì
(
íåy
);

547 
îr
 = 0;

549 } i‡(
íåy
->
°¨t
 < start) {

553 
u∆ock_ªt
:

554 
	`•ö_u∆ock
(&
memty≥_lock
);

556 i‡(
îr
) {

557 
	`¥ötk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

558 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
, 
íd
);

561 
	`d¥ötk
("‰ì_memty≥Ñeque° 0x%Lx-0x%Lx\n", 
°¨t
, 
íd
);

563  
îr
;

564 
	}
}

576 
	$lookup_memty≥
(
u64
 
∑ddr
)

578 
ªây≥
 = 
_PAGE_CACHE_WB
;

579 
memty≥
 *
íåy
;

581 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
))

582  
ªây≥
;

584 i‡(
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
)) {

585 
∑ge
 *page;

586 
	`•ö_lock
(&
memty≥_lock
);

587 
∑ge
 = 
	`p‚_to_∑ge
(
∑ddr
 >> 
PAGE_SHIFT
);

588 
ªây≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

589 
	`•ö_u∆ock
(&
memty≥_lock
);

594 i‡(
ªây≥
 == -1)

595 
ªây≥
 = 
_PAGE_CACHE_WB
;

597  
ªây≥
;

600 
	`•ö_lock
(&
memty≥_lock
);

602 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
∑ddr
);

603 i‡(
íåy
 !
NULL
)

604 
ªây≥
 = 
íåy
->
ty≥
;

606 
ªây≥
 = 
_PAGE_CACHE_UC_MINUS
;

608 
	`•ö_u∆ock
(&
memty≥_lock
);

609  
ªây≥
;

610 
	}
}

622 
	$io_ª£rve_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
,

623 *
ty≥
)

625 
ªsour˚_size_t
 
size
 = 
íd
 - 
°¨t
;

626 
ªq_ty≥
 = *
ty≥
;

627 
√w_ty≥
;

628 
ªt
;

630 
	`WARN_ON_ONCE
(
	`iomem_m≠_ßnôy_check
(
°¨t
, 
size
));

632 
ªt
 = 
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, &
√w_ty≥
);

633 i‡(
ªt
)

634 
out_îr
;

636 i‡(!
	`is_√w_memty≥_Ælowed
(
°¨t
, 
size
, 
ªq_ty≥
, 
√w_ty≥
))

637 
out_‰ì
;

639 i‡(
	`kî√l_m≠_sync_memty≥
(
°¨t
, 
size
, 
√w_ty≥
) < 0)

640 
out_‰ì
;

642 *
ty≥
 = 
√w_ty≥
;

645 
out_‰ì
:

646 
	`‰ì_memty≥
(
°¨t
, 
íd
);

647 
ªt
 = -
EBUSY
;

648 
out_îr
:

649  
ªt
;

650 
	}
}

657 
	$io_‰ì_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
)

659 
	`‰ì_memty≥
(
°¨t
, 
íd
);

660 
	}
}

662 
pg¥Ÿ_t
 
	$phys_mem_ac˚ss_¥Ÿ
(
fûe
 *fûe, 
p‚
,

663 
size
, 
pg¥Ÿ_t
 
vma_¥Ÿ
)

665  
vma_¥Ÿ
;

666 
	}
}

668 #ifde‡
CONFIG_STRICT_DEVMEM


670 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

673 
	}
}

676 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

678 
u64
 
‰om
 = ((u64)
p‚
Ë<< 
PAGE_SHIFT
;

679 
u64
 
to
 = 
‰om
 + 
size
;

680 
u64
 
curs‹
 = 
‰om
;

682 i‡(!
∑t_íabÀd
)

685 
curs‹
 < 
to
) {

686 i‡(!
	`devmem_is_Ælowed
(
p‚
)) {

687 
	`¥ötk
(
KERN_INFO


689 
cuºít
->
comm
, 
‰om
, 
to
);

692 
curs‹
 +
PAGE_SIZE
;

693 
p‚
++;

696 
	}
}

699 
	$phys_mem_ac˚ss_¥Ÿ_Ælowed
(
fûe
 *fûe, 
p‚
,

700 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
)

702 
Êags
 = 
_PAGE_CACHE_WB
;

704 i‡(!
	`ønge_is_Ælowed
(
p‚
, 
size
))

707 i‡(
fûe
->
f_Êags
 & 
O_DSYNC
)

708 
Êags
 = 
_PAGE_CACHE_UC_MINUS
;

710 #ifde‡
CONFIG_X86_32


719 i‡(!
∑t_íabÀd
 &&

720 !(
	`boŸ_˝u_has
(
X86_FEATURE_MTRR
) ||

721 
	`boŸ_˝u_has
(
X86_FEATURE_K6_MTRR
) ||

722 
	`boŸ_˝u_has
(
X86_FEATURE_CYRIX_ARR
) ||

723 
	`boŸ_˝u_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

724 (
p‚
 << 
PAGE_SHIFT
Ë>
	`__∑
(
high_mem‹y
)) {

725 
Êags
 = 
_PAGE_CACHE_UC
;

729 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_¥ŸË& ~
_PAGE_CACHE_MASK
) |

730 
Êags
);

732 
	}
}

738 
	$kî√l_m≠_sync_memty≥
(
u64
 
ba£
, 
size
, 
Êags
)

740 
id_sz
;

742 i‡(
ba£
 >
	`__∑
(
high_mem‹y
))

745 
id_sz
 = (
	`__∑
(
high_mem‹y
Ë< 
ba£
 + 
size
) ?

746 
	`__∑
(
high_mem‹y
Ë- 
ba£
 :

747 
size
;

749 i‡(
	`i‹em≠_ch™ge_©å
(()
	`__va
(
ba£
), 
id_sz
, 
Êags
) < 0) {

750 
	`¥ötk
(
KERN_INFO


753 
cuºít
->
comm
, cuºít->
pid
,

754 
	`ˇâr_«me
(
Êags
),

755 
ba£
, ()(ba£ + 
size
));

756  -
EINVAL
;

759 
	}
}

766 
	$ª£rve_p‚_ønge
(
u64
 
∑ddr
, 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
,

767 
°ri˘_¥Ÿ
)

769 
is_øm
 = 0;

770 
ªt
;

771 
w™t_Êags
 = (
	`pg¥Ÿ_vÆ
(*
vma_¥Ÿ
Ë& 
_PAGE_CACHE_MASK
);

772 
Êags
 = 
w™t_Êags
;

774 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

781 i‡(
is_øm
) {

782 i‡(!
∑t_íabÀd
)

785 
Êags
 = 
	`lookup_memty≥
(
∑ddr
);

786 i‡(
w™t_Êags
 !
Êags
) {

787 
	`¥ötk
(
KERN_WARNING


789 
cuºít
->
comm
, cuºít->
pid
,

790 
	`ˇâr_«me
(
w™t_Êags
),

791 ()
∑ddr
,

792 ()(
∑ddr
 + 
size
),

793 
	`ˇâr_«me
(
Êags
));

794 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

795 (~
_PAGE_CACHE_MASK
)) |

796 
Êags
);

801 
ªt
 = 
	`ª£rve_memty≥
(
∑ddr
,Öadd∏+ 
size
, 
w™t_Êags
, &
Êags
);

802 i‡(
ªt
)

803  
ªt
;

805 i‡(
Êags
 !
w™t_Êags
) {

806 i‡(
°ri˘_¥Ÿ
 ||

807 !
	`is_√w_memty≥_Ælowed
(
∑ddr
, 
size
, 
w™t_Êags
, 
Êags
)) {

808 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

809 
	`¥ötk
(
KERN_ERR
 "%s:%d mapÖfnÉxpected mappingÅype %s"

811 
cuºít
->
comm
, cuºít->
pid
,

812 
	`ˇâr_«me
(
w™t_Êags
),

813 ()
∑ddr
,

814 ()(
∑ddr
 + 
size
),

815 
	`ˇâr_«me
(
Êags
));

816  -
EINVAL
;

822 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

823 (~
_PAGE_CACHE_MASK
)) |

824 
Êags
);

827 i‡(
	`kî√l_m≠_sync_memty≥
(
∑ddr
, 
size
, 
Êags
) < 0) {

828 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

829  -
EINVAL
;

832 
	}
}

838 
	$‰ì_p‚_ønge
(
u64
 
∑ddr
, 
size
)

840 
is_øm
;

842 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

843 i‡(
is_øm
 == 0)

844 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

845 
	}
}

854 
	$åack_p‚_vma_c›y
(
vm_¨ó_°ru˘
 *
vma
)

856 
ªsour˚_size_t
 
∑ddr
;

857 
¥Ÿ
;

858 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

859 
pg¥Ÿ_t
 
pg¥Ÿ
;

861 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

866 i‡(
	`fﬁlow_phys
(
vma
, vma->
vm_°¨t
, 0, &
¥Ÿ
, &
∑ddr
)) {

867 
	`WARN_ON_ONCE
(1);

868  -
EINVAL
;

870 
pg¥Ÿ
 = 
	`__pg¥Ÿ
(
¥Ÿ
);

871  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, &
pg¥Ÿ
, 1);

875 
	}
}

885 
	$åack_p‚_vma_√w
(
vm_¨ó_°ru˘
 *
vma
, 
pg¥Ÿ_t
 *
¥Ÿ
,

886 
p‚
, 
size
)

888 
Êags
;

889 
ªsour˚_size_t
 
∑ddr
;

890 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

892 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

894 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

895  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, 
¥Ÿ
, 0);

898 i‡(!
∑t_íabÀd
)

902 
Êags
 = 
	`lookup_memty≥
(
p‚
 << 
PAGE_SHIFT
);

903 *
¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
Ë& (~
_PAGE_CACHE_MASK
)) |

904 
Êags
);

907 
	}
}

914 
	$u¡øck_p‚_vma
(
vm_¨ó_°ru˘
 *
vma
, 
p‚
,

915 
size
)

917 
ªsour˚_size_t
 
∑ddr
;

918 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

920 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

922 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

923 
	`‰ì_p‚_ønge
(
∑ddr
, 
vma_size
);

926 
	}
}

928 
pg¥Ÿ_t
 
	$pg¥Ÿ_wrôecomböe
(
pg¥Ÿ_t
 
¥Ÿ
)

930 i‡(
∑t_íabÀd
)

931  
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_CACHE_WC
);

933  
	`pg¥Ÿ_n⁄ˇched
(
¥Ÿ
);

934 
	}
}

935 
EXPORT_SYMBOL_GPL
(
pg¥Ÿ_wrôecomböe
);

937 #i‡
deföed
(
CONFIG_DEBUG_FS
Ë&& deföed(
CONFIG_X86_PAT
)

940 
memty≥
 *
	$memty≥_gë_idx
(
loff_t
 
pos
)

942 
memty≥
 *
li°_node
, *
¥öt_íåy
;

943 
i
 = 1;

945 
¥öt_íåy
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

946 i‡(!
¥öt_íåy
)

947  
NULL
;

949 
	`•ö_lock
(&
memty≥_lock
);

950 
	`li°_f‹_óch_íåy
(
li°_node
, &
memty≥_li°
, 
nd
) {

951 i‡(
pos
 =
i
) {

952 *
¥öt_íåy
 = *
li°_node
;

953 
	`•ö_u∆ock
(&
memty≥_lock
);

954  
¥öt_íåy
;

956 ++
i
;

958 
	`•ö_u∆ock
(&
memty≥_lock
);

959 
	`k‰ì
(
¥öt_íåy
);

961  
NULL
;

962 
	}
}

964 *
	$memty≥_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

966 i‡(*
pos
 == 0) {

967 ++*
pos
;

968 
	`£q_¥ötf
(
£q
, "PAT memtypeÜist:\n");

971  
	`memty≥_gë_idx
(*
pos
);

972 
	}
}

974 *
	$memty≥_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

976 ++*
pos
;

977  
	`memty≥_gë_idx
(*
pos
);

978 
	}
}

980 
	$memty≥_£q_°›
(
£q_fûe
 *
£q
, *
v
)

982 
	}
}

984 
	$memty≥_£q_show
(
£q_fûe
 *
£q
, *
v
)

986 
memty≥
 *
¥öt_íåy
 = (memty≥ *)
v
;

988 
	`£q_¥ötf
(
£q
, "%†@ 0x%Lx-0x%Lx\n", 
	`ˇâr_«me
(
¥öt_íåy
->
ty≥
),

989 
¥öt_íåy
->
°¨t
,Öröt_íåy->
íd
);

990 
	`k‰ì
(
¥öt_íåy
);

993 
	}
}

995 c⁄° 
£q_›î©i⁄s
 
	gmemty≥_£q_›s
 = {

996 .
°¨t
 = 
memty≥_£q_°¨t
,

997 .
	g√xt
 = 
memty≥_£q_√xt
,

998 .
	g°›
 = 
memty≥_£q_°›
,

999 .
	gshow
 = 
memty≥_£q_show
,

1002 
	$memty≥_£q_›í
(
öode
 *öode, 
fûe
 *file)

1004  
	`£q_›í
(
fûe
, &
memty≥_£q_›s
);

1005 
	}
}

1007 c⁄° 
fûe_›î©i⁄s
 
	gmemty≥_f›s
 = {

1008 .
›í
 = 
memty≥_£q_›í
,

1009 .
	gªad
 = 
£q_ªad
,

1010 .
	gŒ£ek
 = 
£q_l£ek
,

1011 .
	gªÀa£
 = 
£q_ªÀa£
,

1014 
__öô
 
	$∑t_memty≥_li°_öô
()

1016 i‡(
∑t_íabÀd
) {

1017 
	`debugfs_¸óã_fûe
("∑t_memty≥_li°", 
S_IRUSR
,

1018 
¨ch_debugfs_dú
, 
NULL
, &
memty≥_f›s
);

1021 
	}
}

1023 
œã_öôˇŒ
(
∑t_memty≥_li°_öô
);

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<löux/mm.h
>

2 
	~<löux/gÂ.h
>

3 
	~<asm/pgÆloc.h
>

4 
	~<asm/pgèbÀ.h
>

5 
	~<asm/éb.h
>

6 
	~<asm/fixm≠.h
>

8 
	#PGALLOC_GFP
 
GFP_KERNEL
 | 
__GFP_NOTRACK
 | 
__GFP_REPEAT
 | 
__GFP_ZERO


	)

10 #ifde‡
CONFIG_HIGHPTE


11 
	#PGALLOC_USER_GFP
 
__GFP_HIGHMEM


	)

13 
	#PGALLOC_USER_GFP
 0

	)

16 
gÂ_t
 
	g__u£Ωã_Æloc_gÂ
 = 
PGALLOC_GFP
 | 
PGALLOC_USER_GFP
;

18 
±e_t
 *
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

20  (
±e_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

21 
	}
}

23 
pgèbÀ_t
 
	$±e_Æloc_⁄e
(
mm_°ru˘
 *
mm
, 
addªss
)

25 
∑ge
 *
±e
;

27 
±e
 = 
	`Æloc_∑ges
(
__u£Ωã_Æloc_gÂ
, 0);

28 i‡(
±e
)

29 
	`pgèbÀ_∑ge_˘‹
(
±e
);

30  
±e
;

31 
	}
}

33 
__öô
 
	$£tup_u£Ωã
(*
¨g
)

35 i‡(!
¨g
)

36  -
EINVAL
;

42 i‡(
	`°rcmp
(
¨g
, "nohigh") == 0)

43 
__u£Ωã_Æloc_gÂ
 &~
__GFP_HIGHMEM
;

45  -
EINVAL
;

47 
	}
}

48 
óæy_∑øm
("u£Ωã", 
£tup_u£Ωã
);

50 
	$___±e_‰ì_éb
(
mmu_g©hî
 *
éb
, 
∑ge
 *
±e
)

52 
	`pgèbÀ_∑ge_dt‹
(
±e
);

53 
	`∑øvút_ªÀa£_±e
(
	`∑ge_to_p‚
(
±e
));

54 
	`éb_ªmove_∑ge
(
éb
, 
±e
);

55 
	}
}

57 #i‡
PAGETABLE_LEVELS
 > 2

58 
	$___pmd_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pmd_t
 *
pmd
)

60 
	`∑øvút_ªÀa£_pmd
(
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

61 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pmd
));

62 
	}
}

64 #i‡
PAGETABLE_LEVELS
 > 3

65 
	$___pud_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pud_t
 *
pud
)

67 
	`∑øvút_ªÀa£_pud
(
	`__∑
(
pud
Ë>> 
PAGE_SHIFT
);

68 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pud
));

69 
	}
}

73 
ölöe
 
	$pgd_li°_add
(
pgd_t
 *
pgd
)

75 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

77 
	`li°_add
(&
∑ge
->
Ãu
, &
pgd_li°
);

78 
	}
}

80 
ölöe
 
	$pgd_li°_dñ
(
pgd_t
 *
pgd
)

82 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

84 
	`li°_dñ
(&
∑ge
->
Ãu
);

85 
	}
}

87 
	#UNSHARED_PTRS_PER_PGD
 \

88 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

90 
	$pgd_˘‹
(
pgd_t
 *
pgd
)

95 i‡(
PAGETABLE_LEVELS
 == 2 ||

96 (
PAGETABLE_LEVELS
 =3 && 
SHARED_KERNEL_PMD
) ||

97 
PAGETABLE_LEVELS
 == 4) {

98 
	`˛⁄e_pgd_ønge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

99 
sw≠≥r_pg_dú
 + 
KERNEL_PGD_BOUNDARY
,

100 
KERNEL_PGD_PTRS
);

101 
	`∑øvút_Æloc_pmd_˛⁄e
(
	`__∑
(
pgd
Ë>> 
PAGE_SHIFT
,

102 
	`__∑
(
sw≠≥r_pg_dú
Ë>> 
PAGE_SHIFT
,

103 
KERNEL_PGD_BOUNDARY
,

104 
KERNEL_PGD_PTRS
);

108 i‡(!
SHARED_KERNEL_PMD
)

109 
	`pgd_li°_add
(
pgd
);

110 
	}
}

112 
	$pgd_dt‹
(
pgd_t
 *
pgd
)

114 
Êags
;

116 i‡(
SHARED_KERNEL_PMD
)

119 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

120 
	`pgd_li°_dñ
(
pgd
);

121 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

122 
	}
}

135 #ifde‡
CONFIG_X86_PAE


147 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

149 
	$pud_p›uœã
(
mm_°ru˘
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

151 
	`∑øvút_Æloc_pmd
(
mm
, 
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

155 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_PAGE_PRESENT
));

163 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

164 
	`wrôe_¸3
(
	`ªad_¸3
());

165 
	}
}

169 
	#PREALLOCATED_PMDS
 0

	)

173 
	$‰ì_pmds
(
pmd_t
 *
pmds
[])

175 
i
;

177 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

178 i‡(
pmds
[
i
])

179 
	`‰ì_∑ge
(()
pmds
[
i
]);

180 
	}
}

182 
	$¥óŒoˇã_pmds
(
pmd_t
 *
pmds
[])

184 
i
;

185 
boﬁ
 
Áûed
 = 
Ál£
;

187 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

188 
pmd_t
 *
pmd
 = (pmd_à*)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

189 i‡(
pmd
 =
NULL
)

190 
Áûed
 = 
åue
;

191 
pmds
[
i
] = 
pmd
;

194 i‡(
Áûed
) {

195 
	`‰ì_pmds
(
pmds
);

196  -
ENOMEM
;

200 
	}
}

208 
	$pgd_m›_up_pmds
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgdp
)

210 
i
;

212 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

213 
pgd_t
 
pgd
 = 
pgdp
[
i
];

215 i‡(
	`pgd_vÆ
(
pgd
) != 0) {

216 
pmd_t
 *
pmd
 = (pmd_à*)
	`pgd_∑ge_vaddr
(
pgd
);

218 
pgdp
[
i
] = 
	`«tive_make_pgd
(0);

220 
	`∑øvút_ªÀa£_pmd
(
	`pgd_vÆ
(
pgd
Ë>> 
PAGE_SHIFT
);

221 
	`pmd_‰ì
(
mm
, 
pmd
);

224 
	}
}

226 
	$pgd_¥ï›uœã_pmd
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

228 
pud_t
 *
pud
;

229 
addr
;

230 
i
;

232 i‡(
PREALLOCATED_PMDS
 == 0)

235 
pud
 = 
	`pud_off£t
(
pgd
, 0);

237 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

238 
i
++, 
pud
++, 
addr
 +
PUD_SIZE
) {

239 
pmd_t
 *
pmd
 = 
pmds
[
i
];

241 i‡(
i
 >
KERNEL_PGD_BOUNDARY
)

242 
	`mem˝y
(
pmd
, (
pmd_t
 *)
	`pgd_∑ge_vaddr
(
sw≠≥r_pg_dú
[
i
]),

243 (
pmd_t
Ë* 
PTRS_PER_PMD
);

245 
	`pud_p›uœã
(
mm
, 
pud
, 
pmd
);

247 
	}
}

249 
pgd_t
 *
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

251 
pgd_t
 *
pgd
;

252 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

253 
Êags
;

255 
pgd
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

257 i‡(
pgd
 =
NULL
)

258 
out
;

260 
mm
->
pgd
 =Ögd;

262 i‡(
	`¥óŒoˇã_pmds
(
pmds
) != 0)

263 
out_‰ì_pgd
;

265 i‡(
	`∑øvút_pgd_Æloc
(
mm
) != 0)

266 
out_‰ì_pmds
;

273 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

275 
	`pgd_˘‹
(
pgd
);

276 
	`pgd_¥ï›uœã_pmd
(
mm
, 
pgd
, 
pmds
);

278 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

280  
pgd
;

282 
out_‰ì_pmds
:

283 
	`‰ì_pmds
(
pmds
);

284 
out_‰ì_pgd
:

285 
	`‰ì_∑ge
(()
pgd
);

286 
out
:

287  
NULL
;

288 
	}
}

290 
	$pgd_‰ì
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
)

292 
	`pgd_m›_up_pmds
(
mm
, 
pgd
);

293 
	`pgd_dt‹
(
pgd
);

294 
	`∑øvút_pgd_‰ì
(
mm
, 
pgd
);

295 
	`‰ì_∑ge
(()
pgd
);

296 
	}
}

298 
	$±ï_£t_ac˚ss_Êags
(
vm_¨ó_°ru˘
 *
vma
,

299 
addªss
, 
±e_t
 *
±ï
,

300 
±e_t
 
íåy
, 
dúty
)

302 
ch™ged
 = !
	`±e_ßme
(*
±ï
, 
íåy
);

304 i‡(
ch™ged
 && 
dúty
) {

305 *
±ï
 = 
íåy
;

306 
	`±e_upd©e_de„r
(
vma
->
vm_mm
, 
addªss
, 
±ï
);

307 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

310  
ch™ged
;

311 
	}
}

313 
	$±ï_ã°_™d_˛ór_young
(
vm_¨ó_°ru˘
 *
vma
,

314 
addr
, 
±e_t
 *
±ï
)

316 
ªt
 = 0;

318 i‡(
	`±e_young
(*
±ï
))

319 
ªt
 = 
	`ã°_™d_˛ór_bô
(
_PAGE_BIT_ACCESSED
,

320 (*Ë&
±ï
->
±e
);

322 i‡(
ªt
)

323 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±ï
);

325  
ªt
;

326 
	}
}

328 
	$±ï_˛ór_Êush_young
(
vm_¨ó_°ru˘
 *
vma
,

329 
addªss
, 
±e_t
 *
±ï
)

331 
young
;

333 
young
 = 
	`±ï_ã°_™d_˛ór_young
(
vma
, 
addªss
, 
±ï
);

334 i‡(
young
)

335 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

337  
young
;

338 
	}
}

347 
__öô
 
	$ª£rve_t›_addªss
(
ª£rve
)

349 #ifde‡
CONFIG_X86_32


350 
	`BUG_ON
(
fixm≠s_£t
 > 0);

351 
	`¥ötk
(
KERN_INFO
 "Reserving virtualáddress spaceábove 0x%08x\n",

352 ()-
ª£rve
);

353 
__FIXADDR_TOP
 = -
ª£rve
 - 
PAGE_SIZE
;

355 
	}
}

357 
	gfixm≠s_£t
;

359 
	$__«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
±e_t
 
±e
)

361 
addªss
 = 
	`__fix_to_vút
(
idx
);

363 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

364 
	`BUG
();

367 
	`£t_±e_vaddr
(
addªss
, 
±e
);

368 
fixm≠s_£t
++;

369 
	}
}

371 
	$«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
phys_addr_t
 
phys
,

372 
pg¥Ÿ_t
 
Êags
)

374 
	`__«tive_£t_fixm≠
(
idx
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/physaddr.c

1 
	~<löux/mmdebug.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/∑ge.h
>

7 
	~"phyßddr.h
"

9 #ifde‡
CONFIG_X86_64


11 
	$__phys_addr
(
x
)

13 i‡(
x
 >
__START_KERNEL_m≠
) {

14 
x
 -
__START_KERNEL_m≠
;

15 
	`VIRTUAL_BUG_ON
(
x
 >
KERNEL_IMAGE_SIZE
);

16 
x
 +
phys_ba£
;

18 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

19 
x
 -
PAGE_OFFSET
;

20 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_vÆid
(
x
));

22  
x
;

23 
	}
}

24 
EXPORT_SYMBOL
(
__phys_addr
);

26 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

28 i‡(
x
 >
__START_KERNEL_m≠
) {

29 
x
 -
__START_KERNEL_m≠
;

30 i‡(
x
 >
KERNEL_IMAGE_SIZE
)

31  
Ál£
;

32 
x
 +
phys_ba£
;

34 i‡(
x
 < 
PAGE_OFFSET
)

35  
Ál£
;

36 
x
 -
PAGE_OFFSET
;

37 i‡(!
	`phys_addr_vÆid
(
x
))

38  
Ál£
;

41  
	`p‚_vÆid
(
x
 >> 
PAGE_SHIFT
);

42 
	}
}

43 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

47 #ifde‡
CONFIG_DEBUG_VIRTUAL


48 
	$__phys_addr
(
x
)

51 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

52 
	`VIRTUAL_BUG_ON
(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
));

53  
x
 - 
PAGE_OFFSET
;

54 
	}
}

55 
EXPORT_SYMBOL
(
__phys_addr
);

58 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

60 i‡(
x
 < 
PAGE_OFFSET
)

61  
Ál£
;

62 i‡(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
))

63  
Ál£
;

64 i‡(
x
 >
FIXADDR_START
)

65  
Ál£
;

66  
	`p‚_vÆid
((
x
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

	@/cmpt816/linux/arch/x86/mm/setup_nx.c

1 
	~<löux/•ölock.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/pgèbÀ.h
>

6 
	~<asm/¥Ÿo.h
>

8 
dißbÀ_nx
 
	g__˝uöôd©a
;

18 
__öô
 
	$n€xec_£tup
(*
°r
)

20 i‡(!
°r
)

21  -
EINVAL
;

22 i‡(!
	`°∫cmp
(
°r
, "on", 2)) {

23 
dißbÀ_nx
 = 0;

24 } i‡(!
	`°∫cmp
(
°r
, "off", 3)) {

25 
dißbÀ_nx
 = 1;

27 
	`x86_c⁄figuª_nx
();

29 
	}
}

30 
óæy_∑øm
("n€xec", 
n€xec_£tup
);

32 
__˝uöô
 
	$x86_c⁄figuª_nx
()

34 i‡(
˝u_has_nx
 && !
dißbÀ_nx
)

35 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

37 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

38 
	}
}

40 
__öô
 
	$x86_ªp‹t_nx
()

42 i‡(!
˝u_has_nx
) {

43 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

46 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

47 i‡(
dißbÀ_nx
) {

48 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

51 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

56 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

60 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/mmz⁄e.h
>

15 
	~<löux/bôm≠.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/t›ﬁogy.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/mm.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/uv/uv.h
>

26 
a˝i_numa
 
	g__öôd©a
;

28 
a˝i_èbÀ_¶ô
 *
	ga˝i_¶ô
;

30 
nodemask_t
 
nodes_∑r£d
 
	g__öôd©a
;

31 
nodemask_t
 
˝u_nodes_∑r£d
 
	g__öôd©a
;

32 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

33 
boŸnode
 
	gnodes_add
[
MAX_NUMNODES
];

35 
num_node_memblks
 
	g__öôd©a
;

36 
boŸnode
 
	gnode_memblk_ønge
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

37 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

39 
__öô
 
	$£tup_node
(
pxm
)

41  
	`a˝i_m≠_pxm_to_node
(
pxm
);

42 
	}
}

44 
__öô
 
	$c⁄Êi˘ög_memblks
(
°¨t
, 
íd
)

46 
i
;

47 
i
 = 0; i < 
num_node_memblks
; i++) {

48 
boŸnode
 *
nd
 = &
node_memblk_ønge
[
i
];

49 i‡(
nd
->
°¨t
 =nd->
íd
)

51 i‡(
nd
->
íd
 > 
°¨t
 &&Çd->start <Énd)

52  
memblk_nodeid
[
i
];

53 i‡(
nd
->
íd
 =íd &&Çd->
°¨t
 == start)

54  
memblk_nodeid
[
i
];

57 
	}
}

59 
__öô
 
	$cutoff_node
(
i
, 
°¨t
, 
íd
)

61 
boŸnode
 *
nd
 = &
nodes
[
i
];

63 i‡(
nd
->
°¨t
 < start) {

64 
nd
->
°¨t
 = start;

65 i‡(
nd
->
íd
 <Çd->
°¨t
)

66 
nd
->
°¨t
 =Çd->
íd
;

68 i‡(
nd
->
íd
 >Énd) {

69 
nd
->
íd
 =Énd;

70 i‡(
nd
->
°¨t
 >Çd->
íd
)

71 
nd
->
°¨t
 =Çd->
íd
;

73 
	}
}

75 
__öô
 
	$bad_§©
()

77 
i
;

78 
	`¥ötk
(
KERN_ERR
 "SRAT: SRATÇot used.\n");

79 
a˝i_numa
 = -1;

80 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

81 
≠icid_to_node
[
i
] = 
NUMA_NO_NODE
;

82 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

83 
nodes
[
i
].
°¨t
 =Çodes[i].
íd
 = 0;

84 
nodes_add
[
i
].
°¨t
 =Çodes_add[i].
íd
 = 0;

86 
	`ªmove_Æl_a˘ive_ønges
();

87 
	}
}

89 
__öô
 
ölöe
 
	$§©_dißbÀd
()

91  
numa_off
 || 
a˝i_numa
 < 0;

92 
	}
}

95 
__öô
 
	$a˝i_numa_¶ô_öô
(
a˝i_èbÀ_¶ô
 *
¶ô
)

97 
Àngth
;

98 
phys
;

100 
Àngth
 = 
¶ô
->
hódî
.length;

101 
phys
 = 
	`föd_e820_¨ó
(0, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
, 
Àngth
,

102 
PAGE_SIZE
);

104 i‡(
phys
 == -1L)

105 
	`∑nic
(" CanÇot save slit!\n");

107 
a˝i_¶ô
 = 
	`__va
(
phys
);

108 
	`mem˝y
(
a˝i_¶ô
, 
¶ô
, 
Àngth
);

109 
	`ª£rve_óæy
(
phys
,Öhy†+ 
Àngth
, "ACPI SLIT");

110 
	}
}

113 
__öô


114 
	$a˝i_numa_x2≠ic_afföôy_öô
(
a˝i_§©_x2≠ic_˝u_afföôy
 *
∑
)

116 
pxm
, 
node
;

117 
≠ic_id
;

119 i‡(
	`§©_dißbÀd
())

121 i‡(
∑
->
hódî
.
Àngth
 < (
a˝i_§©_x2≠ic_˝u_afföôy
)) {

122 
	`bad_§©
();

125 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

127 
pxm
 = 
∑
->
¥oximôy_domaö
;

128 
node
 = 
	`£tup_node
(
pxm
);

129 i‡(
node
 < 0) {

130 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

131 
	`bad_§©
();

135 
≠ic_id
 = 
∑
->apic_id;

136 
≠icid_to_node
[
≠ic_id
] = 
node
;

137 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

138 
a˝i_numa
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%04x -> Node %u\n",

140 
pxm
, 
≠ic_id
, 
node
);

141 
	}
}

144 
__öô


145 
	$a˝i_numa_¥o˚ss‹_afföôy_öô
(
a˝i_§©_˝u_afföôy
 *
∑
)

147 
pxm
, 
node
;

148 
≠ic_id
;

150 i‡(
	`§©_dißbÀd
())

152 i‡(
∑
->
hódî
.
Àngth
 !(
a˝i_§©_˝u_afföôy
)) {

153 
	`bad_§©
();

156 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

158 
pxm
 = 
∑
->
¥oximôy_domaö_lo
;

159 
node
 = 
	`£tup_node
(
pxm
);

160 i‡(
node
 < 0) {

161 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

162 
	`bad_§©
();

166 i‡(
	`gë_uv_sy°em_ty≥
(Ë>
UV_X2APIC
)

167 
≠ic_id
 = (
∑
->≠ic_id << 8Ë|Öa->
loˇl_ßpic_eid
;

169 
≠ic_id
 = 
∑
->apic_id;

170 
≠icid_to_node
[
≠ic_id
] = 
node
;

171 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

172 
a˝i_numa
 = 1;

173 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%02x -> Node %u\n",

174 
pxm
, 
≠ic_id
, 
node
);

175 
	}
}

177 #ifde‡
CONFIG_MEMORY_HOTPLUG_SPARSE


178 
ölöe
 
	$ßve_add_öfo
(Ë{ 1;
	}
}

180 
ölöe
 
	$ßve_add_öfo
(Ë{ 0;
	}
}

186 
__öô


187 
	$upd©e_nodes_add
(
node
, 
°¨t
, 
íd
)

189 
s_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

190 
e_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

191 
ch™ged
 = 0;

192 
boŸnode
 *
nd
 = &
nodes_add
[
node
];

200 i‡((sig√d )(
íd
 - 
°¨t
Ë< 
NODE_MIN_SIZE
) {

201 
	`¥ötk
(
KERN_ERR
 "SRAT: HotplugáreaÅoo small\n");

206 i‡(
	`ab£¡_∑ges_ö_ønge
(
s_p‚
, 
e_p‚
) !=É_pfn - s_pfn) {

207 
	`¥ötk
(
KERN_ERR


209 
s_p‚
, 
e_p‚
);

215 i‡(
nd
->
°¨t
 =nd->
íd
) {

216 
nd
->
°¨t
 = start;

217 
nd
->
íd
 =Énd;

218 
ch™ged
 = 1;

220 i‡(
nd
->
°¨t
 =
íd
) {

221 
nd
->
°¨t
 = start;

222 
ch™ged
 = 1;

224 i‡(
nd
->
íd
 =
°¨t
) {

225 
nd
->
íd
 =Énd;

226 
ch™ged
 = 1;

228 i‡(!
ch™ged
)

229 
	`¥ötk
(
KERN_ERR
 "SRAT: Hotplug zoneÇot continuous. Partly ignored\n");

232 i‡(
ch™ged
) {

233 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

234 
	`¥ötk
(
KERN_INFO
 "SRAT: hotÖlug zone found %Lx - %Lx\n",

235 
nd
->
°¨t
,Çd->
íd
);

237 
	}
}

240 
__öô


241 
	$a˝i_numa_mem‹y_afföôy_öô
(
a˝i_§©_mem_afföôy
 *
ma
)

243 
boŸnode
 *
nd
, 
ﬁdnode
;

244 
°¨t
, 
íd
;

245 
node
, 
pxm
;

246 
i
;

248 i‡(
	`§©_dißbÀd
())

250 i‡(
ma
->
hódî
.
Àngth
 !(
a˝i_§©_mem_afföôy
)) {

251 
	`bad_§©
();

254 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

257 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
Ë&& !
	`ßve_add_öfo
())

259 
°¨t
 = 
ma
->
ba£_addªss
;

260 
íd
 = 
°¨t
 + 
ma
->
Àngth
;

261 
pxm
 = 
ma
->
¥oximôy_domaö
;

262 
node
 = 
	`£tup_node
(
pxm
);

263 i‡(
node
 < 0) {

264 
	`¥ötk
(
KERN_ERR
 "SRAT: Too manyÖroximity domains.\n");

265 
	`bad_§©
();

268 
i
 = 
	`c⁄Êi˘ög_memblks
(
°¨t
, 
íd
);

269 i‡(
i
 =
node
) {

270 
	`¥ötk
(
KERN_WARNING


272 
pxm
, 
°¨t
, 
íd
, 
nodes
[
i
].start,Çodes[i].end);

273 } i‡(
i
 >= 0) {

274 
	`¥ötk
(
KERN_ERR


276 
pxm
, 
°¨t
, 
íd
, 
	`node_to_pxm
(
i
),

277 
nodes
[
i
].
°¨t
,Çodes[i].
íd
);

278 
	`bad_§©
();

281 
nd
 = &
nodes
[
node
];

282 
ﬁdnode
 = *
nd
;

283 i‡(!
	`node_ã°_™d_£t
(
node
, 
nodes_∑r£d
)) {

284 
nd
->
°¨t
 = start;

285 
nd
->
íd
 =Énd;

287 i‡(
°¨t
 < 
nd
->start)

288 
nd
->
°¨t
 = start;

289 i‡(
nd
->
íd
 <Énd)

290 
nd
->
íd
 =Énd;

293 
	`¥ötk
(
KERN_INFO
 "SRAT: Nodê%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

294 
°¨t
, 
íd
);

296 i‡(
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) {

297 
	`upd©e_nodes_add
(
node
, 
°¨t
, 
íd
);

299 *
nd
 = 
ﬁdnode
;

300 i‡((
nd
->
°¨t
 |Çd->
íd
) == 0)

301 
	`node_˛ór
(
node
, 
nodes_∑r£d
);

304 
node_memblk_ønge
[
num_node_memblks
].
°¨t
 = start;

305 
node_memblk_ønge
[
num_node_memblks
].
íd
 =Énd;

306 
memblk_nodeid
[
num_node_memblks
] = 
node
;

307 
num_node_memblks
++;

308 
	}
}

312 
__öô
 
	$nodes_covî_mem‹y
(c⁄° 
boŸnode
 *
nodes
)

314 
i
;

315 
pxmøm
, 
e820øm
;

317 
pxmøm
 = 0;

318 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

319 
s
 = 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
;

320 
e
 = 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
;

321 
pxmøm
 +
e
 - 
s
;

322 
pxmøm
 -
	`__ab£¡_∑ges_ö_ønge
(
i
, 
s
, 
e
);

323 i‡(()
pxmøm
 < 0)

324 
pxmøm
 = 0;

327 
e820øm
 = 
max_p‚
 - (
	`e820_hﬁe_size
(0, max_p‚<<
PAGE_SHIFT
)>>PAGE_SHIFT);

329 i‡(()(
e820øm
 - 
pxmøm
Ë>(1<<(20 - 
PAGE_SHIFT
))) {

330 
	`¥ötk
(
KERN_ERR


332 (
pxmøm
 << 
PAGE_SHIFT
) >> 20,

333 (
e820øm
 << 
PAGE_SHIFT
) >> 20);

337 
	}
}

339 
__öô
 
	$a˝i_numa_¨ch_fixup
(Ë{
	}
}

341 
__öô
 
	$a˝i_gë_nodes
(
boŸnode
 *
phy¢odes
)

343 
i
;

344 
ªt
 = 0;

346 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

347 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

348 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

349 
ªt
++;

351  
ªt
;

352 
	}
}

355 
__öô
 
	$a˝i_sˇn_nodes
(
°¨t
, 
íd
)

357 
i
;

359 i‡(
a˝i_numa
 <= 0)

363 
i
 = 0; i < 
MAX_NUMNODES
; i++)

364 
	`cutoff_node
(
i
, 
°¨t
, 
íd
);

366 
memnode_shi·
 = 
	`compuã_hash_shi·
(
node_memblk_ønge
, 
num_node_memblks
,

367 
memblk_nodeid
);

368 i‡(
memnode_shi·
 < 0) {

369 
	`¥ötk
(
KERN_ERR


371 
	`bad_§©
();

375 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
)

376 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

377 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

379 
	`s‹t_node_m≠
();

380 i‡(!
	`nodes_covî_mem‹y
(
nodes
)) {

381 
	`bad_§©
();

386 
	`nodes_‹
(
node_possibÀ_m≠
, 
nodes_∑r£d
, 
˝u_nodes_∑r£d
);

389 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

390 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

393 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

394 i‡(!
	`node_⁄löe
(
i
))

395 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

397 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

398 
node
 = 
	`óæy_˝u_to_node
(
i
);

400 i‡(
node
 =
NUMA_NO_NODE
)

402 i‡(!
	`node_⁄löe
(
node
))

403 
	`numa_˛ór_node
(
i
);

405 
	`numa_öô_¨øy
();

407 
	}
}

409 #ifde‡
CONFIG_NUMA_EMU


410 
	gÁke_node_to_pxm_m≠
[
MAX_NUMNODES
] 
	g__öôd©a
 = {

411 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


413 
s16
 
	gÁke_≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__öôd©a
 = {

414 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


416 
__öô
 
	$föd_node_by_addr
(
addr
)

418 
ªt
 = 
NUMA_NO_NODE
;

419 
i
;

421 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

427 i‡(
addr
 >
nodes
[
i
].
°¨t
 &&ádd∏<Çodes[i].
íd
) {

428 
ªt
 = 
i
;

432  
ªt
;

433 
	}
}

443 
__öô
 
	$a˝i_Áke_nodes
(c⁄° 
boŸnode
 *
Áke_nodes
, 
num_nodes
)

445 
i
, 
j
;

447 
	`¥ötk
(
KERN_INFO
 "Faking PXMáffinity for fakeÇodes onÑeal "

449 
i
 = 0; i < 
num_nodes
; i++) {

450 
nid
, 
pxm
;

452 
nid
 = 
	`föd_node_by_addr
(
Áke_nodes
[
i
].
°¨t
);

453 i‡(
nid
 =
NUMA_NO_NODE
)

455 
pxm
 = 
	`node_to_pxm
(
nid
);

456 i‡(
pxm
 =
PXM_INVAL
)

458 
Áke_node_to_pxm_m≠
[
i
] = 
pxm
;

463 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

464 i‡(
≠icid_to_node
[
j
] =
nid
 &&

465 
Áke_≠icid_to_node
[
j
] =
NUMA_NO_NODE
)

466 
Áke_≠icid_to_node
[
j
] = 
i
;

468 
i
 = 0; i < 
num_nodes
; i++)

469 
	`__a˝i_m≠_pxm_to_node
(
Áke_node_to_pxm_m≠
[
i
], i);

470 
	`mem˝y
(
≠icid_to_node
, 
Áke_≠icid_to_node
, (apicid_to_node));

472 
	`nodes_˛ór
(
nodes_∑r£d
);

473 
i
 = 0; i < 
num_nodes
; i++)

474 i‡(
Áke_nodes
[
i
].
°¨t
 !Áke_nodes[i].
íd
)

475 
	`node_£t
(
i
, 
nodes_∑r£d
);

476 
	}
}

478 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

480  
	`node_to_pxm
(
a
Ë=node_to_pxm(
b
);

481 
	}
}

483 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

485  
a
 =
b
;

486 
	}
}

489 
	$__node_di°™˚
(
a
, 
b
)

491 
ödex
;

493 i‡(!
a˝i_¶ô
)

494  
	`nuŒ_¶ô_node_com∑ª
(
a
, 
b
Ë? 
LOCAL_DISTANCE
 :

495 
REMOTE_DISTANCE
;

496 
ödex
 = 
a˝i_¶ô
->
loˇlôy_cou¡
 * 
	`node_to_pxm
(
a
);

497  
a˝i_¶ô
->
íåy
[
ödex
 + 
	`node_to_pxm
(
b
)];

498 
	}
}

500 
EXPORT_SYMBOL
(
__node_di°™˚
);

502 #i‡
deföed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
Ë|| deföed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

503 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

505 
i
, 
ªt
 = 0;

507 
	`f‹_óch_node
(
i
)

508 i‡(
nodes_add
[
i
].
°¨t
 <°¨à&&Çodes_add[i].
íd
 > start)

509 
ªt
 = 
i
;

511  
ªt
;

512 
	}
}

513 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<löux/öô.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/•ölock.h
>

5 
	~<löux/smp.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/moduÀ.h
>

9 
	~<asm/ébÊush.h
>

10 
	~<asm/mmu_c⁄ãxt.h
>

11 
	~<asm/ˇche.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/uv/uv.h
>

15 
DEFINE_PER_CPU_SHARED_ALIGNED
(
éb_°©e
, 
˝u_éb°©e
)

16 { &
öô_mm
, 0, };

40 
	usmp_Êush_°©e
 {

42 
mm_°ru˘
 *
	mÊush_mm
;

43 
	mÊush_va
;

44 
øw_•ölock_t
 
	méb°©e_lock
;

45 
DECLARE_BITMAP
(
Êush_˝umask
, 
NR_CPUS
);

47 
	m∑d
[
INTERNODE_CACHE_BYTES
];

48 } 
	g____ˇchñöe_öã∫odólig√d_ö_smp
;

53 
smp_Êush_°©e
 
	gÊush_°©e
[
NUM_INVALIDATE_TLB_VECTORS
];

59 
	$Àave_mm
(
˝u
)

61 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
)

62 
	`BUG
();

63 
	`˝umask_˛ór_˝u
(
˝u
,

64 
	`mm_˝umask
(
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)));

65 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

66 
	}
}

67 
EXPORT_SYMBOL_GPL
(
Àave_mm
);

124 #ifde‡
CONFIG_X86_64


125 
	gasmlökage


127 
	$smp_övÆid©e_öãºu±
(
±_ªgs
 *
ªgs
)

129 
˝u
;

130 
£ndî
;

131 
smp_Êush_°©e
 *
f
;

133 
˝u
 = 
	`smp_¥o˚ss‹_id
();

138 
£ndî
 = ~
ªgs
->
‹ig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

139 
f
 = &
Êush_°©e
[
£ndî
];

141 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
)))

142 
out
;

152 i‡(
f
->
Êush_mm
 =
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)) {

153 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
) {

154 i‡(
f
->
Êush_va
 =
TLB_FLUSH_ALL
)

155 
	`loˇl_Êush_éb
();

157 
	`__Êush_éb_⁄e
(
f
->
Êush_va
);

159 
	`Àave_mm
(
˝u
);

161 
out
:

162 
	`ack_APIC_úq
();

163 
	`smp_mb__bef‹e_˛ór_bô
();

164 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
));

165 
	`smp_mb__a·î_˛ór_bô
();

166 
	`öc_úq_°©
(
úq_éb_cou¡
);

167 
	}
}

169 
	$Êush_éb_Ÿhîs_ùi
(c⁄° 
˝umask
 *cpumask,

170 
mm_°ru˘
 *
mm
, 
va
)

172 
£ndî
;

173 
smp_Êush_°©e
 *
f
;

176 
£ndî
 = 
	`smp_¥o˚ss‹_id
(Ë% 
NUM_INVALIDATE_TLB_VECTORS
;

177 
f
 = &
Êush_°©e
[
£ndî
];

184 
	`øw_•ö_lock
(&
f
->
éb°©e_lock
);

186 
f
->
Êush_mm
 = 
mm
;

187 
f
->
Êush_va
 = 
va
;

188 i‡(
	`˝umask_™dnŸ
(
	`to_˝umask
(
f
->
Êush_˝umask
), 
˝umask
, 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
()))) {

193 
≠ic
->
	`£nd_IPI_mask
(
	`to_˝umask
(
f
->
Êush_˝umask
),

194 
INVALIDATE_TLB_VECTOR_START
 + 
£ndî
);

196 !
	`˝umask_em±y
(
	`to_˝umask
(
f
->
Êush_˝umask
)))

197 
	`˝u_ªœx
();

200 
f
->
Êush_mm
 = 
NULL
;

201 
f
->
Êush_va
 = 0;

202 
	`øw_•ö_u∆ock
(&
f
->
éb°©e_lock
);

203 
	}
}

205 
	$«tive_Êush_éb_Ÿhîs
(c⁄° 
˝umask
 *cpumask,

206 
mm_°ru˘
 *
mm
, 
va
)

208 i‡(
	`is_uv_sy°em
()) {

209 
˝u
;

211 
˝u
 = 
	`gë_˝u
();

212 
˝umask
 = 
	`uv_Êush_éb_Ÿhîs
(˝umask, 
mm
, 
va
, 
˝u
);

213 i‡(
˝umask
)

214 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

215 
	`put_˝u
();

218 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

219 
	}
}

221 
__˝uöô
 
	$öô_smp_Êush
()

223 
i
;

225 
i
 = 0; i < 
	`ARRAY_SIZE
(
Êush_°©e
); i++)

226 
	`øw_•ö_lock_öô
(&
Êush_°©e
[
i
].
éb°©e_lock
);

229 
	}
}

230 
c‹e_öôˇŒ
(
öô_smp_Êush
);

232 
	$Êush_éb_cuºít_èsk
()

234 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

236 
	`¥ìm±_dißbÀ
();

238 
	`loˇl_Êush_éb
();

239 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

240 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

241 
	`¥ìm±_íabÀ
();

242 
	}
}

244 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

246 
	`¥ìm±_dißbÀ
();

248 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

249 i‡(
cuºít
->
mm
)

250 
	`loˇl_Êush_éb
();

252 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

254 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

255 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

257 
	`¥ìm±_íabÀ
();

258 
	}
}

260 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
va
)

262 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

264 
	`¥ìm±_dißbÀ
();

266 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

267 i‡(
cuºít
->
mm
)

268 
	`__Êush_éb_⁄e
(
va
);

270 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

273 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

274 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
va
);

276 
	`¥ìm±_íabÀ
();

277 
	}
}

279 
	$do_Êush_éb_Æl
(*
öfo
)

281 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
	`__Êush_éb_Æl
();

284 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_LAZY
)

285 
	`Àave_mm
(
˝u
);

286 
	}
}

288 
	$Êush_éb_Æl
()

290 
	`⁄_óch_˝u
(
do_Êush_éb_Æl
, 
NULL
, 1);

291 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<löux/kî√l.h
>

16 
	~<löux/posix-timîs.h
>

17 
	~<löux/time.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/vsysˇŒ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/uni°d.h
>

24 
	~<asm/io.h
>

25 
	~"vexã∫.h
"

27 
	#gtod
 
vdso_vsysˇŒ_gtod_d©a


	)

29 
nŸø˚
 
	$vdso_ÁŒback_gëtime
(
˛ock
, 
time•ec
 *
ts
)

31 
ªt
;

32 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

33 "0" (
__NR_˛ock_gëtime
),"D" (
˛ock
), "S" (
ts
) : "memory");

34  
ªt
;

35 
	}
}

37 
nŸø˚
 
ölöe
 
	$vgëns
()

39 
v
;

40 
	`cy˛es_t
 (*
vªad
)();

41 
vªad
 = 
gtod
->
˛ock
.vread;

42 
v
 = (
	`vªad
(Ë- 
gtod
->
˛ock
.
cy˛e_œ°
Ë& gtod->˛ock.
mask
;

43  (
v
 * 
gtod
->
˛ock
.
mu…
Ë>> gtod->˛ock.
shi·
;

44 
	}
}

46 
nŸø˚
 
noölöe
 
	$do_ªÆtime
(
time•ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_n£c
;

53 
ns
 = 
	`vgëns
();

54 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

55 
	`time•ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nŸø˚
 

61 
	$v£t_n‹mÆized_time•ec
(
time•ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >
NSEC_PER_SEC
) {

64 
n£c
 -
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic
(
time•ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
wÆl_time_£c
;

81 
ns
 = 
gtod
->
wÆl_time_n£c
 + 
	`vgëns
();

82 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

83 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

84 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nŸø˚
 
noölöe
 
	$do_ªÆtime_cﬂr£
(
time•ec
 *
ts
)

91 
£q
;

93 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

94 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_sec;

95 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_nsec;

96 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

98 
	}
}

100 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic_cﬂr£
(
time•ec
 *
ts
)

102 
£q
, 
ns
, 
£cs
;

104 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

105 
£cs
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_£c
;

106 
ns
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_n£c
;

107 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

108 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

109 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

110 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

112 
	}
}

114 
nŸø˚
 
	$__vdso_˛ock_gëtime
(
˛ockid_t
 
˛ock
, 
time•ec
 *
ts
)

116 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
))

117 
˛ock
) {

118 
CLOCK_REALTIME
:

119 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

120  
	`do_ªÆtime
(
ts
);

122 
CLOCK_MONOTONIC
:

123 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

124  
	`do_m⁄Ÿ⁄ic
(
ts
);

126 
CLOCK_REALTIME_COARSE
:

127  
	`do_ªÆtime_cﬂr£
(
ts
);

128 
CLOCK_MONOTONIC_COARSE
:

129  
	`do_m⁄Ÿ⁄ic_cﬂr£
(
ts
);

131  
	`vdso_ÁŒback_gëtime
(
˛ock
, 
ts
);

132 
	}
}

133 
	$˛ock_gëtime
(
˛ockid_t
, 
time•ec
 *)

134 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_clock_gettime")));

136 
nŸø˚
 
	$__vdso_gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

138 
ªt
;

139 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
)) {

140 i‡(
	`likñy
(
tv
 !
NULL
)) {

141 
	`BUILD_BUG_ON
(
	`off£tof
(
timevÆ
, 
tv_u£c
) !=

142 
	`off£tof
(
time•ec
, 
tv_n£c
) ||

143 (*
tv
Ë!(
time•ec
));

144 
	`do_ªÆtime
((
time•ec
 *)
tv
);

145 
tv
->
tv_u£c
 /= 1000;

147 i‡(
	`u∆ikñy
(
tz
 !
NULL
)) {

149 
tz
->
tz_möuãswe°
 = 
gtod
->
sys_tz
.tz_minuteswest;

150 
tz
->
tz_d°time
 = 
gtod
->
sys_tz
.tz_dsttime;

154 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

155 "0" (
__NR_gëtimeofday
), "D" (
tv
), "S" (
tz
) : "memory");

156  
ªt
;

157 
	}
}

158 
	$gëtimeofday
(
timevÆ
 *, 
timez⁄e
 *)

159 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/gë˝u.h
>

10 
	~<löux/jiffõs.h
>

11 
	~<löux/time.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vexã∫.h
"

16 
nŸø˚
 

17 
	$__vdso_gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
unu£d
)

19 
p
;

21 i‡(*
vdso_vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

23 
	`«tive_ªad_ts˝
(&
p
);

26 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

28 i‡(
˝u
)

29 *
˝u
 = 
p
 & 0xfff;

30 i‡(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

36 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<löux/mm.h
>

7 
	~<löux/îr.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/øndom.h
>

12 
	~<löux/ñf.h
>

13 
	~<asm/vsysˇŒ.h
>

14 
	~<asm/vgtod.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/vdso.h
>

18 
	~"vexã∫.h
"

19 #unde‡
VEXTERN


21 
__ªad_mo°ly
 
	gvdso_íabÀd
 = 1;

23 
vdso_°¨t
[], 
vdso_íd
[];

24 
vdso_sync_˝uid
;

26 
∑ge
 **
	gvdso_∑ges
;

27 
	gvdso_size
;

29 
ölöe
 *
	$v¨_ªf
(*
p
, *
«me
)

31 i‡(*(**)
p
 !(*)
VMAGIC
) {

32 
	`¥ötk
("VDSO: v¨übÀ %†brokí\n", 
«me
);

33 
vdso_íabÀd
 = 0;

35  
p
;

36 
	}
}

38 
__öô
 
	$öô_vdso_v¨s
()

40 
≈ages
 = (
vdso_íd
 - 
vdso_°¨t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

41 
i
;

42 *
vba£
;

44 
vdso_size
 = 
≈ages
 << 
PAGE_SHIFT
;

45 
vdso_∑ges
 = 
	`kmÆloc
((
∑ge
 *Ë* 
≈ages
, 
GFP_KERNEL
);

46 i‡(!
vdso_∑ges
)

47 
oom
;

48 
i
 = 0; i < 
≈ages
; i++) {

49 
∑ge
 *
p
;

50 
p
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

51 i‡(!
p
)

52 
oom
;

53 
vdso_∑ges
[
i
] = 
p
;

54 
	`c›y_∑ge
(
	`∑ge_addªss
(
p
), 
vdso_°¨t
 + 
i
*
PAGE_SIZE
);

57 
vba£
 = 
	`vm≠
(
vdso_∑ges
, 
≈ages
, 0, 
PAGE_KERNEL
);

58 i‡(!
vba£
)

59 
oom
;

61 i‡(
	`memcmp
(
vba£
, "\177ELF", 4)) {

62 
	`¥ötk
("VDSO: I'm broken;Çot ELF\n");

63 
vdso_íabÀd
 = 0;

66 
	#VEXTERN
(
x
) \

67 *(
	`ty≥of
(
__
 ## 
x
Ë**Ë
	`v¨_ªf
(
	`VDSO64_SYMBOL
(
vba£
, x), #xË&__ ## x;

	)

68 
	~"vexã∫.h
"

69 #unde‡
VEXTERN


72 
oom
:

73 
	`¥ötk
("Cannotállocate vdso\n");

74 
vdso_íabÀd
 = 0;

75  -
ENOMEM
;

76 
	}
}

77 
__öôˇŒ
(
öô_vdso_v¨s
);

79 
	glöux_bö¥m
;

85 
	$vdso_addr
(
°¨t
, 
Àn
)

87 
addr
, 
íd
;

88 
off£t
;

89 
íd
 = (
°¨t
 + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

90 i‡(
íd
 >
TASK_SIZE_MAX
)

91 
íd
 = 
TASK_SIZE_MAX
;

92 
íd
 -
Àn
;

94 
off£t
 = 
	`gë_øndom_öt
(Ë& (
PTRS_PER_PTE
 - 1);

95 
addr
 = 
°¨t
 + (
off£t
 << 
PAGE_SHIFT
);

96 i‡(
addr
 >
íd
)

97 
addr
 = 
íd
;

98  
addr
;

99 
	}
}

103 
	$¨ch_£tup_addôi⁄Æ_∑ges
(
löux_bö¥m
 *
b¥m
, 
u£s_öãΩ
)

105 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

106 
addr
;

107 
ªt
;

109 i‡(!
vdso_íabÀd
)

112 
	`down_wrôe
(&
mm
->
mm≠_£m
);

113 
addr
 = 
	`vdso_addr
(
mm
->
°¨t_°ack
, 
vdso_size
);

114 
addr
 = 
	`gë_unm≠≥d_¨ó
(
NULL
,áddr, 
vdso_size
, 0, 0);

115 i‡(
	`IS_ERR_VALUE
(
addr
)) {

116 
ªt
 = 
addr
;

117 
up_Áû
;

120 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = (*)
addr
;

122 
ªt
 = 
	`ö°Æl_•ecül_m≠pög
(
mm
, 
addr
, 
vdso_size
,

123 
VM_READ
|
VM_EXEC
|

124 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

125 
VM_ALWAYSDUMP
,

126 
vdso_∑ges
);

127 i‡(
ªt
) {

128 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = 
NULL
;

129 
up_Áû
;

132 
up_Áû
:

133 
	`up_wrôe
(&
mm
->
mm≠_£m
);

134  
ªt
;

135 
	}
}

137 
__öô
 
	$vdso_£tup
(*
s
)

139 
vdso_íabÀd
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

141 
	}
}

142 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/time.h
>

7 
	~<asm/vsysˇŒ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
Ë
	`ty≥of
 (
__
 ## xË*c⁄° 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vexã∫.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<löux/jiffõs.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/smp.h
>

13 
	gÕj_föe
;

14 
	g¥e£t_Õj
;

15 
__öô
 
	$Õj_£tup
(*
°r
)

17 
¥e£t_Õj
 = 
	`sim∂e_°πoul
(
°r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Õj=", 
Õj_£tup
);

23 #ifde‡
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100Ë? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
()

35 
¥e_°¨t
, 
°¨t
, 
po°_°¨t
;

36 
¥e_íd
, 
íd
, 
po°_íd
;

37 
°¨t_jiffõs
;

38 
timî_øã_mö
, 
timî_øã_max
;

39 
good_timî_sum
 = 0;

40 
good_timî_cou¡
 = 0;

41 
i
;

43 i‡(
	`ªad_cuºít_timî
(&
¥e_°¨t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
¥e_°¨t
 = 0;

67 
	`ªad_cuºít_timî
(&
°¨t
);

68 
°¨t_jiffõs
 = 
jiffõs
;

69 
jiffõs
 <(
°¨t_jiffõs
 + 1)) {

70 
¥e_°¨t
 = 
°¨t
;

71 
	`ªad_cuºít_timî
(&
°¨t
);

73 
	`ªad_cuºít_timî
(&
po°_°¨t
);

75 
¥e_íd
 = 0;

76 
íd
 = 
po°_°¨t
;

77 
jiffõs
 <=

78 (
°¨t_jiffõs
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
¥e_íd
 = 
íd
;

80 
	`ªad_cuºít_timî
(&
íd
);

82 
	`ªad_cuºít_timî
(&
po°_íd
);

84 
timî_øã_max
 = (
po°_íd
 - 
¥e_°¨t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
timî_øã_mö
 = (
¥e_íd
 - 
po°_°¨t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 i‡(
¥e_°¨t
 !0 && 
¥e_íd
 != 0 &&

94 (
timî_øã_max
 - 
timî_øã_mö
) < (timer_rate_max >> 3)) {

95 
good_timî_cou¡
++;

96 
good_timî_sum
 +
timî_øã_max
;

100 i‡(
good_timî_cou¡
)

101  (
good_timî_sum
/
good_timî_cou¡
);

103 
	`¥ötk
(
KERN_WARNING
 "calibrate_delay_direct() failedÅo getá good "

106 
	}
}

108 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
(Ë{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__˝uöô
 
	$ˇlibøã_dñay
()

124 
ticks
, 
lo›bô
;

125 
Õs_¥ecisi⁄
 = 
LPS_PREC
;

126 
boﬁ
 
¥öãd
;

128 i‡(
¥e£t_Õj
) {

129 
lo›s_≥r_jiffy
 = 
¥e£t_Õj
;

130 i‡(!
¥öãd
)

131 
	`¥_öfo
("Calibrating delayÜoop (skipped) "

133 } i‡((!
¥öãd
Ë&& 
Õj_föe
) {

134 
lo›s_≥r_jiffy
 = 
Õj_föe
;

135 
	`¥_öfo
("Calibrating delayÜoop (skipped), "

137 } i‡((
lo›s_≥r_jiffy
 = 
	`ˇlibøã_dñay_dúe˘
()) != 0) {

138 i‡(!
¥öãd
)

139 
	`¥_öfo
("Calibrating delay usingÅimer "

142 
lo›s_≥r_jiffy
 = (1<<12);

144 i‡(!
¥öãd
)

145 
	`¥_öfo
("Calibrating delayÜoop... ");

146 (
lo›s_≥r_jiffy
 <<= 1) != 0) {

148 
ticks
 = 
jiffõs
;

149 
ticks
 =
jiffõs
)

152 
ticks
 = 
jiffõs
;

153 
	`__dñay
(
lo›s_≥r_jiffy
);

154 
ticks
 = 
jiffõs
 -Åicks;

155 i‡(
ticks
)

163 
lo›s_≥r_jiffy
 >>= 1;

164 
lo›bô
 = 
lo›s_≥r_jiffy
;

165 
Õs_¥ecisi⁄
-- && (
lo›bô
 >>= 1)) {

166 
lo›s_≥r_jiffy
 |
lo›bô
;

167 
ticks
 = 
jiffõs
;

168 
ticks
 =
jiffõs
)

170 
ticks
 = 
jiffõs
;

171 
	`__dñay
(
lo›s_≥r_jiffy
);

172 i‡(
jiffõs
 !
ticks
)

173 
lo›s_≥r_jiffy
 &~
lo›bô
;

176 i‡(!
¥öãd
)

177 
	`¥_c⁄t
("%lu.%02lu BogoMIPS (lpj=%lu)\n",

178 
lo›s_≥r_jiffy
/(500000/
HZ
),

179 (
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100,Üoops_per_jiffy);

181 
¥öãd
 = 
åue
;

182 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/˘y≥.h
>

4 
	~<löux/fd.h
>

5 
	~<löux/ây.h
>

6 
	~<löux/su•íd.h
>

7 
	~<löux/roŸ_dev.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/gíhd.h
>

11 
	~<löux/mou¡.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/öôrd.h
>

16 
	~<löux/async.h
>

17 
	~<löux/fs_°ru˘.h
>

18 
	~<löux/¶ab.h
>

20 
	~<löux/nfs_fs.h
>

21 
	~<löux/nfs_fs_sb.h
>

22 
	~<löux/nfs_mou¡.h
>

24 
	~"do_mou¡s.h
"

26 
__öôd©a
 
	grd_dﬁﬂd
;

28 
	groŸ_mou¡Êags
 = 
MS_RDONLY
 | 
MS_SILENT
;

29 * 
__öôd©a
 
	groŸ_devi˚_«me
;

30 
__öôd©a
 
	gßved_roŸ_«me
[64];

31 
__öôd©a
 
	groŸ_waô
;

33 
dev_t
 
	gROOT_DEV
;

35 
__öô
 
	$lﬂd_ømdisk
(*
°r
)

37 
rd_dﬁﬂd
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 3;

39 
	}
}

40 
__£tup
("lﬂd_ømdisk=", 
lﬂd_ømdisk
);

42 
__öô
 
	$ªad⁄ly
(*
°r
)

44 i‡(*
°r
)

46 
roŸ_mou¡Êags
 |
MS_RDONLY
;

48 
	}
}

50 
__öô
 
	$ªadwrôe
(*
°r
)

52 i‡(*
°r
)

54 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

56 
	}
}

58 
__£tup
("ro", 
ªad⁄ly
);

59 
__£tup
("rw", 
ªadwrôe
);

78 
dev_t
 
	$«me_to_dev_t
(*
«me
)

80 
s
[32];

81 *
p
;

82 
dev_t
 
ªs
 = 0;

83 
∑π
;

85 i‡(
	`°∫cmp
(
«me
, "/dev/", 5) != 0) {

86 
maj
, 
mö
;

88 i‡(
	`ssˇnf
(
«me
, "%u:%u", &
maj
, &
mö
) == 2) {

89 
ªs
 = 
	`MKDEV
(
maj
, 
mö
);

90 i‡(
maj
 !
	`MAJOR
(
ªs
Ë|| 
mö
 !
	`MINOR
(res))

91 
Áû
;

93 
ªs
 = 
	`√w_decode_dev
(
	`sim∂e_°πoul
(
«me
, &
p
, 16));

94 i‡(*
p
)

95 
Áû
;

97 
d⁄e
;

100 
«me
 += 5;

101 
ªs
 = 
RoŸ_NFS
;

102 i‡(
	`°rcmp
(
«me
, "nfs") == 0)

103 
d⁄e
;

104 
ªs
 = 
RoŸ_RAM0
;

105 i‡(
	`°rcmp
(
«me
, "ram") == 0)

106 
d⁄e
;

108 i‡(
	`°æí
(
«me
) > 31)

109 
Áû
;

110 
	`°r˝y
(
s
, 
«me
);

111 
p
 = 
s
; *p;Ö++)

112 i‡(*
p
 == '/')

113 *
p
 = '!';

114 
ªs
 = 
	`blk_lookup_devt
(
s
, 0);

115 i‡(
ªs
)

116 
d⁄e
;

122 
p
 > 
s
 && 
	`isdigô
(p[-1]))

123 
p
--;

124 i‡(
p
 =
s
 || !*p || *p == '0')

125 
Áû
;

128 
∑π
 = 
	`sim∂e_°πoul
(
p
, 
NULL
, 10);

129 *
p
 = '\0';

130 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

131 i‡(
ªs
)

132 
d⁄e
;

135 i‡(
p
 < 
s
 + 2 || !
	`isdigô
(p[-2]) ||Ö[-1] != 'p')

136 
Áû
;

137 
p
[-1] = '\0';

138 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

139 i‡(
ªs
)

140 
d⁄e
;

142 
Áû
:

144 
d⁄e
:

145  
ªs
;

146 
	}
}

148 
__öô
 
	$roŸ_dev_£tup
(*
löe
)

150 
	`°æ˝y
(
ßved_roŸ_«me
, 
löe
, (saved_root_name));

152 
	}
}

154 
__£tup
("roŸ=", 
roŸ_dev_£tup
);

156 
__öô
 
	$roŸwaô_£tup
(*
°r
)

158 i‡(*
°r
)

160 
roŸ_waô
 = 1;

162 
	}
}

164 
__£tup
("roŸwaô", 
roŸwaô_£tup
);

166 * 
__öôd©a
 
	groŸ_mou¡_d©a
;

167 
__öô
 
	$roŸ_d©a_£tup
(*
°r
)

169 
roŸ_mou¡_d©a
 = 
°r
;

171 
	}
}

173 * 
__öôd©a
 
	groŸ_fs_«mes
;

174 
__öô
 
	$fs_«mes_£tup
(*
°r
)

176 
roŸ_fs_«mes
 = 
°r
;

178 
	}
}

180 
__öôd©a
 
	groŸ_dñay
;

181 
__öô
 
	$roŸ_dñay_£tup
(*
°r
)

183 
roŸ_dñay
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 0);

185 
	}
}

187 
__£tup
("roŸÊags=", 
roŸ_d©a_£tup
);

188 
__£tup
("roŸf°y≥=", 
fs_«mes_£tup
);

189 
__£tup
("roŸdñay=", 
roŸ_dñay_£tup
);

191 
__öô
 
	$gë_fs_«mes
(*
∑ge
)

193 *
s
 = 
∑ge
;

195 i‡(
roŸ_fs_«mes
) {

196 
	`°r˝y
(
∑ge
, 
roŸ_fs_«mes
);

197 *
s
++) {

198 i‡(
s
[-1] == ',')

199 
s
[-1] = '\0';

202 
Àn
 = 
	`gë_fûesy°em_li°
(
∑ge
);

203 *
p
, *
√xt
;

205 
∑ge
[
Àn
] = '\0';

206 
p
 = 
∑ge
-1;Ö;Ö = 
√xt
) {

207 
√xt
 = 
	`°rchr
(++
p
, '\n');

208 i‡(*
p
++ != '\t')

210 (*
s
++ = *
p
++) != '\n')

212 
s
[-1] = '\0';

215 *
s
 = '\0';

216 
	}
}

218 
__öô
 
	$do_mou¡_roŸ
(*
«me
, *
fs
, 
Êags
, *
d©a
)

220 
îr
 = 
	`sys_mou¡
(
«me
, "/roŸ", 
fs
, 
Êags
, 
d©a
);

221 i‡(
îr
)

222  
îr
;

224 
	`sys_chdú
("/root");

225 
ROOT_DEV
 = 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_dev
;

226 
	`¥ötk
("VFS: MountedÑoot (%s filesystem)%s on device %u:%u.\n",

227 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_ty≥
->
«me
,

228 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_Êags
 & 
MS_RDONLY
 ?

229 "Ñód⁄ly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

231 
	}
}

233 
__öô
 
	$mou¡_block_roŸ
(*
«me
, 
Êags
)

235 *
fs_«mes
 = 
	`__gë«me_gÂ
(
GFP_KERNEL


236 | 
__GFP_NOTRACK_FALSE_POSITIVE
);

237 *
p
;

238 #ifde‡
CONFIG_BLOCK


239 
b
[
BDEVNAME_SIZE
];

241 c⁄° *
b
 = 
«me
;

244 
	`gë_fs_«mes
(
fs_«mes
);

245 
ªåy
:

246 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1) {

247 
îr
 = 
	`do_mou¡_roŸ
(
«me
, 
p
, 
Êags
, 
roŸ_mou¡_d©a
);

248 
îr
) {

250 
out
;

251 -
EACCES
:

252 
Êags
 |
MS_RDONLY
;

253 
ªåy
;

254 -
EINVAL
:

262 #ifde‡
CONFIG_BLOCK


263 
	`__bdev«me
(
ROOT_DEV
, 
b
);

265 
	`¥ötk
("VFS: Cannot openÑoot device \"%s\" or %s\n",

266 
roŸ_devi˚_«me
, 
b
);

267 
	`¥ötk
("Pleaseáppendá correct \"root=\" boot option; hereáreÅheávailableÖartitions:\n");

269 
	`¥ötk_Æl_∑πôi⁄s
();

270 #ifde‡
CONFIG_DEBUG_BLOCK_EXT_DEVT


271 
	`¥ötk
("DEBUG_BLOCK_EXT_DEVT isÉnabled, youÇeedÅo specify "

274 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

277 
	`¥ötk
("List ofállÖartitions:\n");

278 
	`¥ötk_Æl_∑πôi⁄s
();

279 
	`¥ötk
("No filesystem could mountÑoot,Åried: ");

280 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1)

281 
	`¥ötk
(" %s", 
p
);

282 
	`¥ötk
("\n");

283 #ifde‡
CONFIG_BLOCK


284 
	`__bdev«me
(
ROOT_DEV
, 
b
);

286 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

287 
out
:

288 
	`puäame
(
fs_«mes
);

289 
	}
}

291 #ifde‡
CONFIG_ROOT_NFS


292 
__öô
 
	$mou¡_nfs_roŸ
()

294 *
d©a
 = 
	`nfs_roŸ_d©a
();

296 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

297 i‡(
d©a
 &&

298 
	`do_mou¡_roŸ
("/dev/roŸ", "nfs", 
roŸ_mou¡Êags
, 
d©a
) == 0)

301 
	}
}

304 #i‡
deföed
(
CONFIG_BLK_DEV_RAM
Ë|| deföed(
CONFIG_BLK_DEV_FD
)

305 
__öô
 
	$ch™ge_Ê›py
(*
fmt
, ...)

307 
ãrmios
Åermios;

308 
buf
[80];

309 
c
;

310 
fd
;

311 
va_li°
 
¨gs
;

312 
	`va_°¨t
(
¨gs
, 
fmt
);

313 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

314 
	`va_íd
(
¨gs
);

315 
fd
 = 
	`sys_›í
("/dev/roŸ", 
O_RDWR
 | 
O_NDELAY
, 0);

316 i‡(
fd
 >= 0) {

317 
	`sys_io˘l
(
fd
, 
FDEJECT
, 0);

318 
	`sys_˛o£
(
fd
);

320 
	`¥ötk
(
KERN_NOTICE
 "VFS: In£π %†™dÖªs†ENTER\n", 
buf
);

321 
fd
 = 
	`sys_›í
("/dev/c⁄sﬁe", 
O_RDWR
, 0);

322 i‡(
fd
 >= 0) {

323 
	`sys_io˘l
(
fd
, 
TCGETS
, ()&
ãrmios
);

324 
ãrmios
.
c_lÊag
 &~
ICANON
;

325 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

326 
	`sys_ªad
(
fd
, &
c
, 1);

327 
ãrmios
.
c_lÊag
 |
ICANON
;

328 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

329 
	`sys_˛o£
(
fd
);

331 
	}
}

334 
__öô
 
	$mou¡_roŸ
()

336 #ifde‡
CONFIG_ROOT_NFS


337 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
UNNAMED_MAJOR
) {

338 i‡(
	`mou¡_nfs_roŸ
())

341 
	`¥ötk
(
KERN_ERR
 "VFS: UnableÅo mountÑoot fs via NFS,Årying floppy.\n");

342 
ROOT_DEV
 = 
RoŸ_FD0
;

345 #ifde‡
CONFIG_BLK_DEV_FD


346 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
) {

348 i‡(
rd_dﬁﬂd
==2) {

349 i‡(
	`rd_lﬂd_disk
(1)) {

350 
ROOT_DEV
 = 
RoŸ_RAM1
;

351 
roŸ_devi˚_«me
 = 
NULL
;

354 
	`ch™ge_Ê›py
("root floppy");

357 #ifde‡
CONFIG_BLOCK


358 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

359 
	`mou¡_block_roŸ
("/dev/roŸ", 
roŸ_mou¡Êags
);

361 
	}
}

366 
__öô
 
	$¥ï¨e_«me•a˚
()

368 
is_Ê›py
;

370 i‡(
roŸ_dñay
) {

371 
	`¥ötk
(
KERN_INFO
 "Waiting %dsec before mountingÑoot device...\n",

372 
roŸ_dñay
);

373 
	`s¶ìp
(
roŸ_dñay
);

383 
	`waô_f‹_devi˚_¥obe
();

385 
	`md_run_£tup
();

387 i‡(
ßved_roŸ_«me
[0]) {

388 
roŸ_devi˚_«me
 = 
ßved_roŸ_«me
;

389 i‡(!
	`°∫cmp
(
roŸ_devi˚_«me
, "mtd", 3) ||

390 !
	`°∫cmp
(
roŸ_devi˚_«me
, "ubi", 3)) {

391 
	`mou¡_block_roŸ
(
roŸ_devi˚_«me
, 
roŸ_mou¡Êags
);

392 
out
;

394 
ROOT_DEV
 = 
	`«me_to_dev_t
(
roŸ_devi˚_«me
);

395 i‡(
	`°∫cmp
(
roŸ_devi˚_«me
, "/dev/", 5) == 0)

396 
roŸ_devi˚_«me
 += 5;

399 i‡(
	`öôrd_lﬂd
())

400 
out
;

403 i‡((
ROOT_DEV
 =0Ë&& 
roŸ_waô
) {

404 
	`¥ötk
(
KERN_INFO
 "Waiting forÑoot device %s...\n",

405 
ßved_roŸ_«me
);

406 
	`drivî_¥obe_d⁄e
() != 0 ||

407 (
ROOT_DEV
 = 
	`«me_to_dev_t
(
ßved_roŸ_«me
)) == 0)

408 
	`m¶ìp
(100);

409 
	`async_synchr⁄ize_fuŒ
();

412 
is_Ê›py
 = 
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
;

414 i‡(
is_Ê›py
 && 
rd_dﬁﬂd
 && 
	`rd_lﬂd_disk
(0))

415 
ROOT_DEV
 = 
RoŸ_RAM0
;

417 
	`mou¡_roŸ
();

418 
out
:

419 
	`devtmpfs_mou¡
("dev");

420 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

421 
	`sys_chroŸ
(".");

422 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<löux/uni°d.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/öôrd.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/‰ìzî.h
>

11 
	~"do_mou¡s.h
"

13 
	göôrd_°¨t
, 
	göôrd_íd
;

14 
	göôrd_bñow_°¨t_ok
;

15 
	gªÆ_roŸ_dev
;

16 
__öôd©a
 
	gﬁd_fd
, 
	groŸ_fd
;

17 
__öôd©a
 
	gmou¡_öôrd
 = 1;

19 
__öô
 
	$no_öôrd
(*
°r
)

21 
mou¡_öôrd
 = 0;

23 
	}
}

25 
__£tup
("noöôrd", 
no_öôrd
);

27 
__öô
 
	$do_löuxrc
(* 
shñl
)

29 *
¨gv
[] = { "löuxrc", 
NULL
, };

30 * 
ívp_öô
[];

32 
	`sys_˛o£
(
ﬁd_fd
);sys_˛o£(
roŸ_fd
);

33 
	`sys_£tsid
();

34  
	`kî√l_execve
(
shñl
, 
¨gv
, 
ívp_öô
);

35 
	}
}

37 
__öô
 
	$h™dÀ_öôrd
()

39 
îr‹
;

40 
pid
;

42 
ªÆ_roŸ_dev
 = 
	`√w_ícode_dev
(
ROOT_DEV
);

43 
	`¸óã_dev
("/dev/roŸ.ﬁd", 
RoŸ_RAM0
);

45 
	`mou¡_block_roŸ
("/dev/roŸ.ﬁd", 
roŸ_mou¡Êags
 & ~
MS_RDONLY
);

46 
	`sys_mkdú
("/old", 0700);

47 
roŸ_fd
 = 
	`sys_›í
("/", 0, 0);

48 
ﬁd_fd
 = 
	`sys_›í
("/old", 0, 0);

50 
	`sys_chdú
("/root");

51 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

52 
	`sys_chroŸ
(".");

58 
cuºít
->
Êags
 |
PF_FREEZER_SKIP
;

60 
pid
 = 
	`kî√l_thªad
(
do_löuxrc
, "/löuxrc", 
SIGCHLD
);

61 i‡(
pid
 > 0)

62 
pid
 !
	`sys_waô4
(-1, 
NULL
, 0, NULL))

63 
	`yõld
();

65 
cuºít
->
Êags
 &~
PF_FREEZER_SKIP
;

68 
	`sys_fchdú
(
ﬁd_fd
);

69 
	`sys_mou¡
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

71 
	`sys_fchdú
(
roŸ_fd
);

72 
	`sys_chroŸ
(".");

73 
	`sys_˛o£
(
ﬁd_fd
);

74 
	`sys_˛o£
(
roŸ_fd
);

76 i‡(
	`√w_decode_dev
(
ªÆ_roŸ_dev
Ë=
RoŸ_RAM0
) {

77 
	`sys_chdú
("/old");

81 
ROOT_DEV
 = 
	`√w_decode_dev
(
ªÆ_roŸ_dev
);

82 
	`mou¡_roŸ
();

84 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo move oldÑootÅo /initrd ... ");

85 
îr‹
 = 
	`sys_mou¡
("/ﬁd", "/roŸ/öôrd", 
NULL
, 
MS_MOVE
, NULL);

86 i‡(!
îr‹
)

87 
	`¥ötk
("okay\n");

89 
fd
 = 
	`sys_›í
("/dev/roŸ.ﬁd", 
O_RDWR
, 0);

90 i‡(
îr‹
 =-
ENOENT
)

91 
	`¥ötk
("/initrd doesÇotÉxist. Ignored.\n");

93 
	`¥ötk
("failed\n");

94 
	`¥ötk
(
KERN_NOTICE
 "Unmounting oldÑoot\n");

95 
	`sys_umou¡
("/ﬁd", 
MNT_DETACH
);

96 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo freeÑamdisk memory ... ");

97 i‡(
fd
 < 0) {

98 
îr‹
 = 
fd
;

100 
îr‹
 = 
	`sys_io˘l
(
fd
, 
BLKFLSBUF
, 0);

101 
	`sys_˛o£
(
fd
);

103 
	`¥ötk
(!
îr‹
 ? "okay\n" : "failed\n");

105 
	}
}

107 
__öô
 
	$öôrd_lﬂd
()

109 i‡(
mou¡_öôrd
) {

110 
	`¸óã_dev
("/dev/øm", 
RoŸ_RAM0
);

117 i‡(
	`rd_lﬂd_image
("/öôrd.image"Ë&& 
ROOT_DEV
 !
RoŸ_RAM0
) {

118 
	`sys_u∆ök
("/initrd.image");

119 
	`h™dÀ_öôrd
();

123 
	`sys_u∆ök
("/initrd.image");

125 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<löux/dñay.h
>

2 
	~<löux/øid/md_u.h
>

3 
	~<löux/øid/md_p.h
>

5 
	~"do_mou¡s.h
"

16 #ifde‡
CONFIG_MD_AUTODETECT


17 
__öôd©a
 
	gøid_nﬂutodëe˘
;

19 
__öôd©a
 
	gøid_nﬂutodëe˘
=1;

21 
__öôd©a
 
	gøid_aut›¨t
;

24 
	mmö‹
;

25 
	m∑πôi⁄ed
;

26 
	mÀvñ
;

27 
	mchunk
;

28 *
	mdevi˚_«mes
;

29 } 
	gmd_£tup_¨gs
[256] 
	g__öôd©a
;

31 
md_£tup_íts
 
	g__öôd©a
;

53 
__öô
 
	$md_£tup
(*
°r
)

55 
mö‹
, 
Àvñ
, 
Á˘‹
, 
Áu…
, 
∑πôi⁄ed
 = 0;

56 *
≥∫ame
 = "";

57 *
°r1
;

58 
ít
;

60 i‡(*
°r
 == 'd') {

61 
∑πôi⁄ed
 = 1;

62 
°r
++;

64 i‡(
	`gë_›ti⁄
(&
°r
, &
mö‹
) != 2) {

65 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

68 
°r1
 = 
°r
;

69 
ít
=0 ;É¡< 
md_£tup_íts
 ;Ént++)

70 i‡(
md_£tup_¨gs
[
ít
].
mö‹
 == minor &&

71 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 ==Öartitioned) {

72 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d, Specified moreÅhan once. "

73 "RïœcögÖªviou†deföôi⁄.\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

76 i‡(
ít
 >
	`ARRAY_SIZE
(
md_£tup_¨gs
)) {

77 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d -Åoÿm™y md inôülißti⁄s\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

80 i‡(
ít
 >
md_£tup_íts
)

81 
md_£tup_íts
++;

82 
	`gë_›ti⁄
(&
°r
, &
Àvñ
)) {

84 i‡(
Àvñ
 =0 ||Üevñ =
LEVEL_LINEAR
) {

85 i‡(
	`gë_›ti⁄
(&
°r
, &
Á˘‹
) != 2 ||

86 
	`gë_›ti⁄
(&
°r
, &
Áu…
) != 2) {

87 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

90 
md_£tup_¨gs
[
ít
].
Àvñ
 =Üevel;

91 
md_£tup_¨gs
[
ít
].
chunk
 = 1 << (
Á˘‹
+12);

92 i‡(
Àvñ
 =
LEVEL_LINEAR
)

93 
≥∫ame
 = "linear";

95 
≥∫ame
 = "raid0";

100 
°r
 = 
°r1
;

103 
md_£tup_¨gs
[
ít
].
Àvñ
 = 
LEVEL_NONE
;

104 
≥∫ame
="super-block";

107 
	`¥ötk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mö‹
, 
≥∫ame
, 
°r
);

109 
md_£tup_¨gs
[
ít
].
devi˚_«mes
 = 
°r
;

110 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 =Öartitioned;

111 
md_£tup_¨gs
[
ít
].
mö‹
 = minor;

114 
	}
}

116 
__öô
 
	$md_£tup_drive
()

118 
mö‹
, 
i
, 
ít
, 
∑πôi⁄ed
;

119 
dev_t
 
dev
;

120 
dev_t
 
devi˚s
[
MD_SB_DISKS
+1];

122 
ít
 = 0;É¡ < 
md_£tup_íts
 ;Ént++) {

123 
fd
;

124 
îr
 = 0;

125 *
dev«me
;

126 
mdu_disk_öfo_t
 
döfo
;

127 
«me
[16];

129 
mö‹
 = 
md_£tup_¨gs
[
ít
].minor;

130 
∑πôi⁄ed
 = 
md_£tup_¨gs
[
ít
].partitioned;

131 
dev«me
 = 
md_£tup_¨gs
[
ít
].
devi˚_«mes
;

133 
	`•rötf
(
«me
, "/dev/md%s%d", 
∑πôi⁄ed
?"_d":"", 
mö‹
);

134 i‡(
∑πôi⁄ed
)

135 
dev
 = 
	`MKDEV
(
mdp_maj‹
, 
mö‹
 << 
MdpMö‹Shi·
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mö‹
);

138 
	`¸óã_dev
(
«me
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
dev«me
 !
NULL
; i++) {

140 *
p
;

141 
comp_«me
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`°rchr
(
dev«me
, ',');

145 i‡(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`«me_to_dev_t
(
dev«me
);

149 i‡(
	`°∫cmp
(
dev«me
, "/dev/", 5) == 0)

150 
dev«me
 += 5;

151 
	`¢¥ötf
(
comp_«me
, 63, "/dev/%s", 
dev«me
);

152 
rdev
 = 
	`b°©
(
comp_«me
);

153 i‡(
rdev
)

154 
dev
 = 
	`√w_decode_dev
(
rdev
);

155 i‡(!
dev
) {

156 
	`¥ötk
(
KERN_WARNING
 "md: Unknow¿devi˚Çame: %s\n", 
dev«me
);

160 
devi˚s
[
i
] = 
dev
;

162 
dev«me
 = 
p
;

164 
devi˚s
[
i
] = 0;

166 i‡(!
i
)

169 
	`¥ötk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
∑πôi⁄ed
 ? "_d" : "", 
mö‹
,

171 
md_£tup_¨gs
[
ít
].
devi˚_«mes
);

173 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

174 i‡(
fd
 < 0) {

175 
	`¥ötk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¨øy %s\n", 
«me
);

179 i‡(
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, 0Ë=-
EBUSY
) {

180 
	`¥ötk
(
KERN_WARNING


182 
mö‹
);

183 
	`sys_˛o£
(
fd
);

187 i‡(
md_£tup_¨gs
[
ít
].
Àvñ
 !
LEVEL_NONE
) {

189 
mdu_¨øy_öfo_t
 
aöfo
;

190 
aöfo
.
Àvñ
 = 
md_£tup_¨gs
[
ít
].level;

191 
aöfo
.
size
 = 0;

192 
aöfo
.
ƒ_disks
 =0;

193 
aöfo
.
øid_disks
 =0;

194 
devi˚s
[
aöfo
.
øid_disks
])

195 
aöfo
.
øid_disks
++;

196 
aöfo
.
md_mö‹
 =
mö‹
;

197 
aöfo
.
nŸ_≥rsi°ít
 = 1;

199 
aöfo
.
°©e
 = (1 << 
MD_SB_CLEAN
);

200 
aöfo
.
œyout
 = 0;

201 
aöfo
.
chunk_size
 = 
md_£tup_¨gs
[
ít
].
chunk
;

202 
îr
 = 
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, ()&
aöfo
);

203 
i
 = 0; !
îr
 && i <
MD_SB_DISKS
; i++) {

204 
dev
 = 
devi˚s
[
i
];

205 i‡(!
dev
)

207 
döfo
.
numbî
 = 
i
;

208 
döfo
.
øid_disk
 = 
i
;

209 
döfo
.
°©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

211 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

212 
îr
 = 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

216 
i
 = 0; i <
MD_SB_DISKS
; i++) {

217 
dev
 = 
devi˚s
[
i
];

218 i‡(!
dev
)

220 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

221 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

222 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

225 i‡(!
îr
)

226 
îr
 = 
	`sys_io˘l
(
fd
, 
RUN_ARRAY
, 0);

227 i‡(
îr
)

228 
	`¥ötk
(
KERN_WARNING
 "md: sèπög md%d faûed\n", 
mö‹
);

235 
	`sys_˛o£
(
fd
);

236 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

237 
	`sys_io˘l
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_˛o£
(
fd
);

241 
	}
}

243 
__öô
 
	$øid_£tup
(*
°r
)

245 
Àn
, 
pos
;

247 
Àn
 = 
	`°æí
(
°r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Àn
) {

251 *
comma
 = 
	`°rchr
(
°r
+
pos
, ',');

252 
wÀn
;

253 i‡(
comma
)

254 
wÀn
 = (
comma
-
°r
)-
pos
;

255 
wÀn
 = (
Àn
-1)-
pos
;

257 i‡(!
	`°∫cmp
(
°r
, "nﬂutodëe˘", 
wÀn
))

258 
øid_nﬂutodëe˘
 = 1;

259 i‡(!
	`°∫cmp
(
°r
, "autodëe˘", 
wÀn
))

260 
øid_nﬂutodëe˘
 = 0;

261 i‡(
	`°∫cmp
(
°r
, "∑πôi⁄abÀ", 
wÀn
)==0)

262 
øid_aut›¨t
 = 1;

263 i‡(
	`°∫cmp
(
°r
, "∑π", 
wÀn
)==0)

264 
øid_aut›¨t
 = 1;

265 
pos
 +
wÀn
+1;

268 
	}
}

270 
__£tup
("øid=", 
øid_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__öô
 
	$autodëe˘_øid
()

275 
fd
;

281 
	`¥ötk
(
KERN_INFO
 "md: Waiting foráll devicesÅo beávailable beforeáutodetect\n");

282 
	`¥ötk
(
KERN_INFO
 "md: If you don't useÑaid, useÑaid=noautodetect\n");

284 
	`waô_f‹_devi˚_¥obe
();

286 
fd
 = 
	`sys_›í
("/dev/md0", 0, 0);

287 i‡(
fd
 >= 0) {

288 
	`sys_io˘l
(
fd
, 
RAID_AUTORUN
, 
øid_aut›¨t
);

289 
	`sys_˛o£
(
fd
);

291 
	}
}

293 
__öô
 
	$md_run_£tup
()

295 
	`¸óã_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 i‡(
øid_nﬂutodëe˘
)

298 
	`¥ötk
(
KERN_INFO
 "md: Skippingáutodetection of RAIDárrays. (raid=autodetect will force)\n");

300 
	`autodëe˘_øid
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/¸amfs_fs.h
>

8 
	~<löux/öôrd.h
>

9 
	~<löux/°rög.h
>

10 
	~<löux/¶ab.h
>

12 
	~"do_mou¡s.h
"

13 
	~"../fs/squashfs/squashfs_fs.h
"

15 
	~<löux/decom¥ess/gíîic.h
>

18 
__öôd©a
 
	grd_¥om±
 = 1;

20 
__öô
 
	$¥om±_ømdisk
(*
°r
)

22 
rd_¥om±
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 1;

24 
	}
}

25 
__£tup
("¥om±_ømdisk=", 
¥om±_ømdisk
);

27 
__öôd©a
 
	grd_image_°¨t
;

29 
__öô
 
	$ømdisk_°¨t_£tup
(*
°r
)

31 
rd_image_°¨t
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0);

33 
	}
}

34 
__£tup
("ømdisk_°¨t=", 
ømdisk_°¨t_£tup
);

36 
__öô
 
¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
);

52 
__öô


53 
	$idítify_ømdisk_image
(
fd
, 
°¨t_block
, 
decom¥ess_‚
 *
decom¥ess‹
)

55 c⁄° 
size
 = 512;

56 
möix_su≥r_block
 *
möixsb
;

57 
ext2_su≥r_block
 *
ext2sb
;

58 
romfs_su≥r_block
 *
romfsb
;

59 
¸amfs_su≥r
 *
¸amfsb
;

60 
squashfs_su≥r_block
 *
squashfsb
;

61 
nblocks
 = -1;

62 *
buf
;

63 c⁄° *
com¥ess_«me
;

65 
buf
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

66 i‡(!
buf
)

69 
möixsb
 = (
möix_su≥r_block
 *Ë
buf
;

70 
ext2sb
 = (
ext2_su≥r_block
 *Ë
buf
;

71 
romfsb
 = (
romfs_su≥r_block
 *Ë
buf
;

72 
¸amfsb
 = (
¸amfs_su≥r
 *Ë
buf
;

73 
squashfsb
 = (
squashfs_su≥r_block
 *Ë
buf
;

74 
	`mem£t
(
buf
, 0xe5, 
size
);

79 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

80 
	`sys_ªad
(
fd
, 
buf
, 
size
);

82 *
decom¥ess‹
 = 
	`decom¥ess_mëhod
(
buf
, 
size
, &
com¥ess_«me
);

83 i‡(
com¥ess_«me
) {

84 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: %s image foundát block %d\n",

85 
com¥ess_«me
, 
°¨t_block
);

86 i‡(!*
decom¥ess‹
)

87 
	`¥ötk
(
KERN_EMERG


89 
com¥ess_«me
);

90 
nblocks
 = 0;

91 
d⁄e
;

95 i‡(
romfsb
->
w‹d0
 =
ROMSB_WORD0
 &&

96 
romfsb
->
w‹d1
 =
ROMSB_WORD1
) {

97 
	`¥ötk
(
KERN_NOTICE


99 
°¨t_block
);

100 
nblocks
 = (
	`¡ohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

101 
d⁄e
;

104 i‡(
¸amfsb
->
magic
 =
CRAMFS_MAGIC
) {

105 
	`¥ötk
(
KERN_NOTICE


107 
°¨t_block
);

108 
nblocks
 = (
¸amfsb
->
size
 + 
BLOCK_SIZE
 - 1Ë>> 
BLOCK_SIZE_BITS
;

109 
d⁄e
;

113 i‡(
	`À32_to_˝u
(
squashfsb
->
s_magic
Ë=
SQUASHFS_MAGIC
) {

114 
	`¥ötk
(
KERN_NOTICE


116 
°¨t_block
);

117 
nblocks
 = (
	`À64_to_˝u
(
squashfsb
->
byãs_u£d
Ë+ 
BLOCK_SIZE
 - 1)

118 >> 
BLOCK_SIZE_BITS
;

119 
d⁄e
;

125 
	`sys_l£ek
(
fd
, (
°¨t_block
+1Ë* 
BLOCK_SIZE
, 0);

126 
	`sys_ªad
(
fd
, 
buf
, 
size
);

129 i‡(
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC
 ||

130 
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC2
) {

131 
	`¥ötk
(
KERN_NOTICE


133 
°¨t_block
);

134 
nblocks
 = 
möixsb
->
s_nz⁄es
 << möixsb->
s_log_z⁄e_size
;

135 
d⁄e
;

139 i‡(
ext2sb
->
s_magic
 =
	`˝u_to_À16
(
EXT2_SUPER_MAGIC
)) {

140 
	`¥ötk
(
KERN_NOTICE


142 
°¨t_block
);

143 
nblocks
 = 
	`À32_to_˝u
(
ext2sb
->
s_blocks_cou¡
) <<

144 
	`À32_to_˝u
(
ext2sb
->
s_log_block_size
);

145 
d⁄e
;

148 
	`¥ötk
(
KERN_NOTICE


150 
°¨t_block
);

152 
d⁄e
:

153 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

154 
	`k‰ì
(
buf
);

155  
nblocks
;

156 
	}
}

158 
__öô
 
	$rd_lﬂd_image
(*
‰om
)

160 
ªs
 = 0;

161 
ö_fd
, 
out_fd
;

162 
rd_blocks
, 
devblocks
;

163 
nblocks
, 
i
, 
disk
;

164 *
buf
 = 
NULL
;

165 
rŸ©e
 = 0;

166 
decom¥ess_‚
 
decom¥ess‹
 = 
NULL
;

167 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

168 
rŸ©‹
[4] = { '|' , '/' , '-' , '\\' };

171 
out_fd
 = 
	`sys_›í
("/dev/øm", 
O_RDWR
, 0);

172 i‡(
out_fd
 < 0)

173 
out
;

175 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

176 i‡(
ö_fd
 < 0)

177 
no˛o£_öput
;

179 
nblocks
 = 
	`idítify_ømdisk_image
(
ö_fd
, 
rd_image_°¨t
, &
decom¥ess‹
);

180 i‡(
nblocks
 < 0)

181 
d⁄e
;

183 i‡(
nblocks
 == 0) {

184 i‡(
	`¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess‹
) == 0)

185 
suc˚ssful_lﬂd
;

186 
d⁄e
;

200 i‡(
	`sys_io˘l
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

201 
rd_blocks
 = 0;

203 
rd_blocks
 >>= 1;

205 i‡(
nblocks
 > 
rd_blocks
) {

206 
	`¥ötk
("RAMDISK: imageÅoo big! (%dKiB/%ldKiB)\n",

207 
nblocks
, 
rd_blocks
);

208 
d⁄e
;

214 i‡(
	`sys_io˘l
(
ö_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

215 
devblocks
 = 0;

217 
devblocks
 >>= 1;

219 i‡(
	`°rcmp
(
‰om
, "/initrd.image") == 0)

220 
devblocks
 = 
nblocks
;

222 i‡(
devblocks
 == 0) {

223 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇot determine device size\n");

224 
d⁄e
;

227 
buf
 = 
	`kmÆloc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

228 i‡(!
buf
) {

229 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇotállocate buffer\n");

230 
d⁄e
;

233 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] intoÑam disk... ",

234 
nblocks
, (“blocks-1)/
devblocks
)+1,Çblocks>devblocks ? "s" : "");

235 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

236 i‡(
i
 && (ò% 
devblocks
 == 0)) {

237 
	`¥ötk
("d⁄êdisk #%d.\n", 
disk
++);

238 
rŸ©e
 = 0;

239 i‡(
	`sys_˛o£
(
ö_fd
)) {

240 
	`¥ötk
("Error closingÅhe disk.\n");

241 
no˛o£_öput
;

243 
	`ch™ge_Ê›py
("disk #%d", 
disk
);

244 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

245 i‡(
ö_fd
 < 0) {

246 
	`¥ötk
("Error opening disk.\n");

247 
no˛o£_öput
;

249 
	`¥ötk
("Lﬂdög disk #%d... ", 
disk
);

251 
	`sys_ªad
(
ö_fd
, 
buf
, 
BLOCK_SIZE
);

252 
	`sys_wrôe
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

253 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

254 i‡(!(
i
 % 16)) {

255 
	`¥ötk
("%c\b", 
rŸ©‹
[
rŸ©e
 & 0x3]);

256 
rŸ©e
++;

260 
	`¥ötk
("done.\n");

262 
suc˚ssful_lﬂd
:

263 
ªs
 = 1;

264 
d⁄e
:

265 
	`sys_˛o£
(
ö_fd
);

266 
no˛o£_öput
:

267 
	`sys_˛o£
(
out_fd
);

268 
out
:

269 
	`k‰ì
(
buf
);

270 
	`sys_u∆ök
("/dev/ram");

271  
ªs
;

272 
	}
}

274 
__öô
 
	$rd_lﬂd_disk
(
n
)

276 i‡(
rd_¥om±
)

277 
	`ch™ge_Ê›py
("root floppy diskÅo beÜoaded into RAM disk");

278 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

279 
	`¸óã_dev
("/dev/øm", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

280  
	`rd_lﬂd_image
("/dev/root");

281 
	}
}

283 
	gexô_code
;

284 
	gdecom¥ess_îr‹
;

285 
	g¸d_öfd
, 
	g¸d_outfd
;

287 
__öô
 
	$com¥_fûl
(*
buf
, 
Àn
)

289 
r
 = 
	`sys_ªad
(
¸d_öfd
, 
buf
, 
Àn
);

290 i‡(
r
 < 0)

291 
	`¥ötk
(
KERN_ERR
 "RAMDISK:Érror whileÑeading compressed data");

292 i‡(
r
 == 0)

293 
	`¥ötk
(
KERN_ERR
 "RAMDISK: EOF whileÑeading compressed data");

294  
r
;

295 
	}
}

297 
__öô
 
	$com¥_Êush
(*
wödow
, 
out˙t
)

299 
wrôãn
 = 
	`sys_wrôe
(
¸d_outfd
, 
wödow
, 
out˙t
);

300 i‡(
wrôãn
 !
out˙t
) {

301 i‡(
decom¥ess_îr‹
 == 0)

302 
	`¥ötk
(
KERN_ERR


304 
wrôãn
, 
out˙t
);

305 
decom¥ess_îr‹
 = 1;

308  
out˙t
;

309 
	}
}

311 
__öô
 
	$îr‹
(*
x
)

313 
	`¥ötk
(
KERN_ERR
 "%s\n", 
x
);

314 
exô_code
 = 1;

315 
decom¥ess_îr‹
 = 1;

316 
	}
}

318 
__öô
 
	$¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
)

320 
ªsu…
;

321 
¸d_öfd
 = 
ö_fd
;

322 
¸d_outfd
 = 
out_fd
;

323 
ªsu…
 = 
	`deco
(
NULL
, 0, 
com¥_fûl
, 
com¥_Êush
, NULL, NULL, 
îr‹
);

324 i‡(
decom¥ess_îr‹
)

325 
ªsu…
 = 1;

326  
ªsu…
;

327 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<löux/öô.h
>

2 
	~<löux/fs.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/ty≥s.h
>

5 
	~<löux/f˙é.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dúít.h
>

9 
	~<löux/sysˇŒs.h
>

10 
	~<löux/utime.h
>

12 
__öôd©a
 *
	gmesßge
;

13 
__öô
 
	$îr‹
(*
x
)

15 i‡(!
mesßge
)

16 
mesßge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Àn
Ë(((÷íË+ 1Ë& ~3Ë+ 2)

	)

23 
__öôd©a
 
	shash
 {

24 
	möo
, 
	mmö‹
, 
	mmaj‹
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	m√xt
;

27 
	m«me
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	ghód
[32];

30 
ölöe
 
	$hash
(
maj‹
, 
mö‹
, 
öo
)

32 
tmp
 = 
öo
 + 
mö‹
 + (
maj‹
 << 3);

33 
tmp
 +=Åmp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__öô
 *
	$föd_lök
(
maj‹
, 
mö‹
, 
öo
,

38 
mode_t
 
mode
, *
«me
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
hód
 + 
	`hash
(
maj‹
, 
mö‹
, 
öo
); *p;Ö = &(*p)->
√xt
) {

42 i‡((*
p
)->
öo
 != ino)

44 i‡((*
p
)->
mö‹
 != minor)

46 i‡((*
p
)->
maj‹
 != major)

48 i‡(((*
p
)->
mode
 ^ modeË& 
S_IFMT
)

50  (*
p
)->
«me
;

52 
q
 = 
	`kmÆloc
((
hash
), 
GFP_KERNEL
);

53 i‡(!
q
)

54 
	`∑nic
("can'tállocateÜink hashÉntry");

55 
q
->
maj‹
 = major;

56 
q
->
mö‹
 = minor;

57 
q
->
öo
 = ino;

58 
q
->
mode
 = mode;

59 
	`°r˝y
(
q
->
«me
,Çame);

60 
q
->
√xt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__öô
 
	$‰ì_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
hód
;Ö < head + 32;Ö++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
√xt
;

72 
	`k‰ì
(
q
);

75 
	}
}

77 
__öô
 
	$do_utime
(
__u£r
 *
fûíame
, 
time_t
 
mtime
)

79 
time•ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__öôd©a
 
LIST_HEAD
(
dú_li°
);

90 
	sdú_íåy
 {

91 
li°_hód
 
	mli°
;

92 *
	m«me
;

93 
time_t
 
	mmtime
;

96 
__öô
 
	$dú_add
(c⁄° *
«me
, 
time_t
 
mtime
)

98 
dú_íåy
 *
de
 = 
	`kmÆloc
((dú_íåy), 
GFP_KERNEL
);

99 i‡(!
de
)

100 
	`∑nic
("can'tállocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li°
);

102 
de
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li°_add
(&
de
->
li°
, &
dú_li°
);

105 
	}
}

107 
__öô
 
	$dú_utime
()

109 
dú_íåy
 *
de
, *
tmp
;

110 
	`li°_f‹_óch_íåy_ß„
(
de
, 
tmp
, &
dú_li°
, 
li°
) {

111 
	`li°_dñ
(&
de
->
li°
);

112 
	`do_utime
(
de
->
«me
, de->
mtime
);

113 
	`k‰ì
(
de
->
«me
);

114 
	`k‰ì
(
de
);

116 
	}
}

118 
__öôd©a
 
time_t
 
	gmtime
;

122 
__öôd©a
 
	göo
, 
	gmaj‹
, 
	gmö‹
, 
	g∆ök
;

123 
__öôd©a
 
mode_t
 
	gmode
;

124 
__öôd©a
 
	gbody_Àn
, 
	g«me_Àn
;

125 
__öôd©a
 
uid_t
 
	guid
;

126 
__öôd©a
 
gid_t
 
	ggid
;

127 
__öôd©a
 
	grdev
;

129 
__öô
 
	$∑r£_hódî
(*
s
)

131 
∑r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`mem˝y
(
buf
, 
s
, 8);

138 
∑r£d
[
i
] = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 16);

140 
öo
 = 
∑r£d
[0];

141 
mode
 = 
∑r£d
[1];

142 
uid
 = 
∑r£d
[2];

143 
gid
 = 
∑r£d
[3];

144 
∆ök
 = 
∑r£d
[4];

145 
mtime
 = 
∑r£d
[5];

146 
body_Àn
 = 
∑r£d
[6];

147 
maj‹
 = 
∑r£d
[7];

148 
mö‹
 = 
∑r£d
[8];

149 
rdev
 = 
	`√w_ícode_dev
(
	`MKDEV
(
∑r£d
[9],Öarsed[10]));

150 
«me_Àn
 = 
∑r£d
[11];

151 
	}
}

155 
__öôd©a
 
	e°©e
 {

156 
	mSèπ
,

157 
	mCﬁÀ˘
,

158 
	mGŸHódî
,

159 
	mSkùIt
,

160 
	mGŸName
,

161 
	mC›yFûe
,

162 
	mGŸSymlök
,

163 
	mRe£t


164 } 
	g°©e
, 
	g√xt_°©e
;

166 
__öôd©a
 *
	gvi˘im
;

167 
__öôd©a
 
	gcou¡
;

168 
__öôd©a
 
loff_t
 
	gthis_hódî
, 
	g√xt_hódî
;

170 
ölöe
 
__öô
 
	$ót
(
n
)

172 
vi˘im
 +
n
;

173 
this_hódî
 +
n
;

174 
cou¡
 -
n
;

175 
	}
}

177 
__öôd©a
 *
	gvcﬁÀ˘ed
;

178 
__öôd©a
 *
	gcﬁÀ˘ed
;

179 
__öôd©a
 
	gªmaös
;

180 
__öôd©a
 *
	gcﬁÀ˘
;

182 
__öô
 
	$ªad_öto
(*
buf
, 
size
, 
°©e
 
√xt
)

184 i‡(
cou¡
 >
size
) {

185 
cﬁÀ˘ed
 = 
vi˘im
;

186 
	`ót
(
size
);

187 
°©e
 = 
√xt
;

189 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
buf
;

190 
ªmaös
 = 
size
;

191 
√xt_°©e
 = 
√xt
;

192 
°©e
 = 
CﬁÀ˘
;

194 
	}
}

196 
__öôd©a
 *
	ghódî_buf
, *
	gsymlök_buf
, *
	g«me_buf
;

198 
__öô
 
	$do_°¨t
()

200 
	`ªad_öto
(
hódî_buf
, 110, 
GŸHódî
);

202 
	}
}

204 
__öô
 
	$do_cﬁÀ˘
()

206 
n
 = 
ªmaös
;

207 i‡(
cou¡
 < 
n
)

208 
n
 = 
cou¡
;

209 
	`mem˝y
(
cﬁÀ˘
, 
vi˘im
, 
n
);

210 
	`ót
(
n
);

211 
cﬁÀ˘
 +
n
;

212 i‡((
ªmaös
 -
n
) != 0)

214 
°©e
 = 
√xt_°©e
;

216 
	}
}

218 
__öô
 
	$do_hódî
()

220 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070707", 6)==0) {

221 
	`îr‹
("incorrect cpio method used: use -HÇewc option");

224 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070701", 6)) {

225 
	`îr‹
("no cpio magic");

228 
	`∑r£_hódî
(
cﬁÀ˘ed
);

229 
√xt_hódî
 = 
this_hódî
 + 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

230 
√xt_hódî
 = (next_header + 3) & ~3;

231 
°©e
 = 
SkùIt
;

232 i‡(
«me_Àn
 <0 ||Çame_À¿> 
PATH_MAX
)

234 i‡(
	`S_ISLNK
(
mode
)) {

235 i‡(
body_Àn
 > 
PATH_MAX
)

237 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
symlök_buf
;

238 
ªmaös
 = 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

239 
√xt_°©e
 = 
GŸSymlök
;

240 
°©e
 = 
CﬁÀ˘
;

243 i‡(
	`S_ISREG
(
mode
Ë|| !
body_Àn
)

244 
	`ªad_öto
(
«me_buf
, 
	`N_ALIGN
(
«me_Àn
), 
GŸName
);

246 
	}
}

248 
__öô
 
	$do_skù
()

250 i‡(
this_hódî
 + 
cou¡
 < 
√xt_hódî
) {

251 
	`ót
(
cou¡
);

254 
	`ót
(
√xt_hódî
 - 
this_hódî
);

255 
°©e
 = 
√xt_°©e
;

258 
	}
}

260 
__öô
 
	$do_ª£t
()

262 
cou¡
 && *
vi˘im
 == '\0')

263 
	`ót
(1);

264 i‡(
cou¡
 && (
this_hódî
 & 3))

265 
	`îr‹
("brokenÖadding");

267 
	}
}

269 
__öô
 
	$maybe_lök
()

271 i‡(
∆ök
 >= 2) {

272 *
ﬁd
 = 
	`föd_lök
(
maj‹
, 
mö‹
, 
öo
, 
mode
, 
cﬁÀ˘ed
);

273 i‡(
ﬁd
)

274  (
	`sys_lök
(
ﬁd
, 
cﬁÀ˘ed
) < 0) ? -1 : 1;

277 
	}
}

279 
__öô
 
	$˛ón_∑th
(*
∑th
, 
mode_t
 
mode
)

281 
°©
 
°
;

283 i‡(!
	`sys_√wl°©
(
∑th
, &
°
Ë&& (°.
°_mode
^
mode
Ë& 
S_IFMT
) {

284 i‡(
	`S_ISDIR
(
°
.
°_mode
))

285 
	`sys_rmdú
(
∑th
);

287 
	`sys_u∆ök
(
∑th
);

289 
	}
}

291 
__öôd©a
 
	gwfd
;

293 
__öô
 
	$do_«me
()

295 
°©e
 = 
SkùIt
;

296 
√xt_°©e
 = 
Re£t
;

297 i‡(
	`°rcmp
(
cﬁÀ˘ed
, "TRAILER!!!") == 0) {

298 
	`‰ì_hash
();

301 
	`˛ón_∑th
(
cﬁÀ˘ed
, 
mode
);

302 i‡(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lök
();

304 i‡(
ml
 >= 0) {

305 
›íÊags
 = 
O_WRONLY
|
O_CREAT
;

306 i‡(
ml
 != 1)

307 
›íÊags
 |
O_TRUNC
;

308 
wfd
 = 
	`sys_›í
(
cﬁÀ˘ed
, 
›íÊags
, 
mode
);

310 i‡(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 i‡(
body_Àn
)

314 
	`sys_·runˇã
(
wfd
, 
body_Àn
);

315 
vcﬁÀ˘ed
 = 
	`k°rdup
(
cﬁÀ˘ed
, 
GFP_KERNEL
);

316 
°©e
 = 
C›yFûe
;

319 } i‡(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdú
(
cﬁÀ˘ed
, 
mode
);

321 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

323 
	`dú_add
(
cﬁÀ˘ed
, 
mtime
);

324 } i‡(
	`S_ISBLK
(
mode
Ë|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

326 i‡(
	`maybe_lök
() == 0) {

327 
	`sys_mknod
(
cﬁÀ˘ed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

330 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

334 
	}
}

336 
__öô
 
	$do_c›y
()

338 i‡(
cou¡
 >
body_Àn
) {

339 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
body_Àn
);

340 
	`sys_˛o£
(
wfd
);

341 
	`do_utime
(
vcﬁÀ˘ed
, 
mtime
);

342 
	`k‰ì
(
vcﬁÀ˘ed
);

343 
	`ót
(
body_Àn
);

344 
°©e
 = 
SkùIt
;

347 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
cou¡
);

348 
body_Àn
 -
cou¡
;

349 
	`ót
(
cou¡
);

352 
	}
}

354 
__öô
 
	$do_symlök
()

356 
cﬁÀ˘ed
[
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
] = '\0';

357 
	`˛ón_∑th
(
cﬁÀ˘ed
, 0);

358 
	`sys_symlök
(
cﬁÀ˘ed
 + 
	`N_ALIGN
(
«me_Àn
), collected);

359 
	`sys_lchown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

360 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

361 
°©e
 = 
SkùIt
;

362 
√xt_°©e
 = 
Re£t
;

364 
	}
}

366 
__öôd©a
 (*
a˘i⁄s
[])() = {

367 [
Sèπ
] = 
do_°¨t
,

368 [
CﬁÀ˘
] = 
do_cﬁÀ˘
,

369 [
GŸHódî
] = 
do_hódî
,

370 [
SkùIt
] = 
do_skù
,

371 [
GŸName
] = 
do_«me
,

372 [
C›yFûe
] = 
do_c›y
,

373 [
GŸSymlök
] = 
do_symlök
,

374 [
Re£t
] = 
do_ª£t
,

375 
	}
};

377 
__öô
 
	$wrôe_buf„r
(*
buf
, 
Àn
)

379 
cou¡
 = 
Àn
;

380 
vi˘im
 = 
buf
;

382 !
a˘i⁄s
[
°©e
]())

384  
Àn
 - 
cou¡
;

385 
	}
}

387 
__öô
 
	$Êush_buf„r
(*
bufv
, 
Àn
)

389 *
buf
 = (*Ë
bufv
;

390 
wrôãn
;

391 
‹igLí
 = 
Àn
;

392 i‡(
mesßge
)

394 (
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
)Ë<Üí && !
mesßge
) {

395 
c
 = 
buf
[
wrôãn
];

396 i‡(
c
 == '0') {

397 
buf
 +
wrôãn
;

398 
Àn
 -
wrôãn
;

399 
°©e
 = 
Sèπ
;

400 } i‡(
c
 == 0) {

401 
buf
 +
wrôãn
;

402 
Àn
 -
wrôãn
;

403 
°©e
 = 
Re£t
;

405 
	`îr‹
("junk in compressedárchive");

407  
‹igLí
;

408 
	}
}

410 
	gmy_ö±r
;

412 
	~<löux/decom¥ess/gíîic.h
>

414 * 
__öô
 
	$u≈ack_to_roŸfs
(*
buf
, 
Àn
)

416 
wrôãn
, 
ªs
;

417 
decom¥ess_‚
 
decom¥ess
;

418 c⁄° *
com¥ess_«me
;

419 
__öôd©a
 
msg_buf
[64];

421 
hódî_buf
 = 
	`kmÆloc
(110, 
GFP_KERNEL
);

422 
symlök_buf
 = 
	`kmÆloc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXË+ 1, 
GFP_KERNEL
);

423 
«me_buf
 = 
	`kmÆloc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 i‡(!
hódî_buf
 || !
symlök_buf
 || !
«me_buf
)

426 
	`∑nic
("can'tállocate buffers");

428 
°©e
 = 
Sèπ
;

429 
this_hódî
 = 0;

430 
mesßge
 = 
NULL
;

431 !
mesßge
 && 
Àn
) {

432 
loff_t
 
ßved_off£t
 = 
this_hódî
;

433 i‡(*
buf
 ='0' && !(
this_hódî
 & 3)) {

434 
°©e
 = 
Sèπ
;

435 
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
);

436 
buf
 +
wrôãn
;

437 
Àn
 -
wrôãn
;

440 i‡(!*
buf
) {

441 
buf
++;

442 
Àn
--;

443 
this_hódî
++;

446 
this_hódî
 = 0;

447 
decom¥ess
 = 
	`decom¥ess_mëhod
(
buf
, 
Àn
, &
com¥ess_«me
);

448 i‡(
decom¥ess
) {

449 
ªs
 = 
	`decom¥ess
(
buf
, 
Àn
, 
NULL
, 
Êush_buf„r
, NULL,

450 &
my_ö±r
, 
îr‹
);

451 i‡(
ªs
)

452 
	`îr‹
("decompressor failed");

453 } i‡(
com¥ess_«me
) {

454 i‡(!
mesßge
) {

455 
	`¢¥ötf
(
msg_buf
,  msg_buf,

457 
com¥ess_«me
);

458 
mesßge
 = 
msg_buf
;

461 
	`îr‹
("junk in compressedárchive");

462 i‡(
°©e
 !
Re£t
)

463 
	`îr‹
("junk in compressedárchive");

464 
this_hódî
 = 
ßved_off£t
 + 
my_ö±r
;

465 
buf
 +
my_ö±r
;

466 
Àn
 -
my_ö±r
;

468 
	`dú_utime
();

469 
	`k‰ì
(
«me_buf
);

470 
	`k‰ì
(
symlök_buf
);

471 
	`k‰ì
(
hódî_buf
);

472  
mesßge
;

473 
	}
}

475 
__öôd©a
 
	gdo_ªèö_öôrd
;

477 
__öô
 
	$ªèö_öôrd_∑øm
(*
°r
)

479 i‡(*
°r
)

481 
do_ªèö_öôrd
 = 1;

483 
	}
}

484 
__£tup
("ªèö_öôrd", 
ªèö_öôrd_∑øm
);

486 
__öôømfs_°¨t
[], 
__öôømfs_íd
[];

487 
	~<löux/öôrd.h
>

488 
	~<löux/kexec.h
>

490 
__öô
 
	$‰ì_öôrd
()

492 #ifde‡
CONFIG_KEXEC


493 
¸ashk_°¨t
 = ()
	`__va
(
¸ashk_ªs
.
°¨t
);

494 
¸ashk_íd
 = ()
	`__va
(
¸ashk_ªs
.
íd
);

496 i‡(
do_ªèö_öôrd
)

497 
skù
;

499 #ifde‡
CONFIG_KEXEC


504 i‡(
öôrd_°¨t
 < 
¸ashk_íd
 && 
öôrd_íd
 > 
¸ashk_°¨t
) {

509 
	`mem£t
((*)
öôrd_°¨t
, 0, 
öôrd_íd
 - initrd_start);

510 i‡(
öôrd_°¨t
 < 
¸ashk_°¨t
)

511 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
¸ashk_°¨t
);

512 i‡(
öôrd_íd
 > 
¸ashk_íd
)

513 
	`‰ì_öôrd_mem
(
¸ashk_íd
, 
öôrd_íd
);

516 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
öôrd_íd
);

517 
skù
:

518 
öôrd_°¨t
 = 0;

519 
öôrd_íd
 = 0;

520 
	}
}

522 #ifde‡
CONFIG_BLK_DEV_RAM


523 
	#BUF_SIZE
 1024

	)

524 
__öô
 
	$˛ón_roŸfs
()

526 
fd
;

527 *
buf
;

528 
löux_dúít64
 *
dúp
;

529 
num
;

531 
fd
 = 
	`sys_›í
("/", 
O_RDONLY
, 0);

532 
	`WARN_ON
(
fd
 < 0);

533 i‡(
fd
 < 0)

535 
buf
 = 
	`kzÆloc
(
BUF_SIZE
, 
GFP_KERNEL
);

536 
	`WARN_ON
(!
buf
);

537 i‡(!
buf
) {

538 
	`sys_˛o£
(
fd
);

542 
dúp
 = 
buf
;

543 
num
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

544 
num
 > 0) {

545 
num
 > 0) {

546 
°©
 
°
;

547 
ªt
;

549 
ªt
 = 
	`sys_√wl°©
(
dúp
->
d_«me
, &
°
);

550 
	`WARN_ON_ONCE
(
ªt
);

551 i‡(!
ªt
) {

552 i‡(
	`S_ISDIR
(
°
.
°_mode
))

553 
	`sys_rmdú
(
dúp
->
d_«me
);

555 
	`sys_u∆ök
(
dúp
->
d_«me
);

558 
num
 -
dúp
->
d_ª˛í
;

559 
dúp
 = (*)dú∞+ dúp->
d_ª˛í
;

561 
dúp
 = 
buf
;

562 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

563 
num
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

566 
	`sys_˛o£
(
fd
);

567 
	`k‰ì
(
buf
);

568 
	}
}

571 
__öô
 
	$p›uœã_roŸfs
()

573 *
îr
 = 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

574 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

575 i‡(
îr
)

576 
	`∑nic
(
îr
);

577 i‡(
öôrd_°¨t
) {

578 #ifde‡
CONFIG_BLK_DEV_RAM


579 
fd
;

580 
	`¥ötk
(
KERN_INFO
 "TryingÅo unpackÑootfs imageás initramfs...\n");

581 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

582 
öôrd_íd
 - 
öôrd_°¨t
);

583 i‡(!
îr
) {

584 
	`‰ì_öôrd
();

587 
	`˛ón_roŸfs
();

588 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

589 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

591 
	`¥ötk
(
KERN_INFO
 "rootfs image isÇot initramfs (%s)"

592 ";Üook†likê™ inôrd\n", 
îr
);

593 
fd
 = 
	`sys_›í
("/öôrd.image", 
O_WRONLY
|
O_CREAT
, 0700);

594 i‡(
fd
 >= 0) {

595 
	`sys_wrôe
(
fd
, (*)
öôrd_°¨t
,

596 
öôrd_íd
 - 
öôrd_°¨t
);

597 
	`sys_˛o£
(
fd
);

598 
	`‰ì_öôrd
();

601 
	`¥ötk
(
KERN_INFO
 "Unpacking initramfs...\n");

602 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

603 
öôrd_íd
 - 
öôrd_°¨t
);

604 i‡(
îr
)

605 
	`¥ötk
(
KERN_EMERG
 "Inôømf†u≈ackög faûed: %s\n", 
îr
);

606 
	`‰ì_öôrd
();

610 
	}
}

611 
roŸfs_öôˇŒ
(
p›uœã_roŸfs
);

	@/cmpt816/linux/init/main.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/˘y≥.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/smp_lock.h
>

24 
	~<löux/öôrd.h
>

25 
	~<löux/boŸmem.h
>

26 
	~<löux/a˝i.h
>

27 
	~<löux/ây.h
>

28 
	~<löux/≥r˝u.h
>

29 
	~<löux/kmod.h
>

30 
	~<löux/vmÆloc.h
>

31 
	~<löux/kî√l_°©.h
>

32 
	~<löux/°¨t_kî√l.h
>

33 
	~<löux/£curôy.h
>

34 
	~<löux/smp.h
>

35 
	~<löux/w‹kqueue.h
>

36 
	~<löux/¥ofûe.h
>

37 
	~<löux/rcupd©e.h
>

38 
	~<löux/moduÀ∑øm.h
>

39 
	~<löux/kÆlsyms.h
>

40 
	~<löux/wrôeback.h
>

41 
	~<löux/˝u.h
>

42 
	~<löux/˝u£t.h
>

43 
	~<löux/cgroup.h
>

44 
	~<löux/efi.h
>

45 
	~<löux/tick.h
>

46 
	~<löux/öãºu±.h
>

47 
	~<löux/èsk°©s_kîn.h
>

48 
	~<löux/dñayac˘.h
>

49 
	~<löux/uni°d.h
>

50 
	~<löux/rm≠.h
>

51 
	~<löux/mempﬁicy.h
>

52 
	~<löux/key.h
>

53 
	~<löux/buf„r_hód.h
>

54 
	~<löux/∑ge_cgroup.h
>

55 
	~<löux/debug_locks.h
>

56 
	~<löux/debugobje˘s.h
>

57 
	~<löux/lockdï.h
>

58 
	~<löux/kmemÀak.h
>

59 
	~<löux/pid_«me•a˚.h
>

60 
	~<löux/devi˚.h
>

61 
	~<löux/kthªad.h
>

62 
	~<löux/sched.h
>

63 
	~<löux/sig«l.h
>

64 
	~<löux/idr.h
>

65 
	~<löux/·ø˚.h
>

66 
	~<löux/async.h
>

67 
	~<löux/kmemcheck.h
>

68 
	~<löux/kmemåa˚.h
>

69 
	~<löux/sfi.h
>

70 
	~<löux/shmem_fs.h
>

71 
	~<löux/¶ab.h
>

72 
	~<åa˚/boŸ.h
>

74 
	~<asm/io.h
>

75 
	~<asm/bugs.h
>

76 
	~<asm/£tup.h
>

77 
	~<asm/£˘i⁄s.h
>

78 
	~<asm/ˇcheÊush.h
>

80 #ifde‡
CONFIG_X86_LOCAL_APIC


81 
	~<asm/smp.h
>

84 
kî√l_öô
(*);

86 
öô_IRQ
();

87 
f‹k_öô
();

88 
mˇ_öô
();

89 
sbus_öô
();

90 
¥io_åì_öô
();

91 
ødix_åì_öô
();

92 
‰ì_öômem
();

93 #i‚de‡
CONFIG_DEBUG_RODATA


94 
ölöe
 
	$m¨k_rod©a_ro
(Ë{ 
	}
}

97 #ifde‡
CONFIG_TC


98 
tc_öô
();

101 
sy°em_°©es
 
sy°em_°©e
 
	g__ªad_mo°ly
;

102 
EXPORT_SYMBOL
(
sy°em_°©e
);

107 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

108 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

110 
time_öô
();

112 (*
__öôd©a
 
œã_time_öô
)();

113 
	`so·úq_öô
();

116 
__öôd©a
 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
];

118 *
ßved_comm™d_löe
;

120 *
°©ic_comm™d_löe
;

122 *
execuã_comm™d
;

123 *
ømdisk_execuã_comm™d
;

125 #ifde‡
CONFIG_SMP


127 
__öôd©a
 
£tup_max_˝us
 = 
NR_CPUS
;

140 
__wók
 
	$¨ch_dißbÀ_smp_suµ‹t
(Ë{ 
	}
}

142 
__öô
 
	$nosmp
(*
°r
)

144 
£tup_max_˝us
 = 0;

145 
	`¨ch_dißbÀ_smp_suµ‹t
();

148 
	}
}

150 
óæy_∑øm
("nosmp", 
nosmp
);

153 
__öô
 
	$ƒ˝us
(*
°r
)

155 
ƒ_˝us
;

157 
	`gë_›ti⁄
(&
°r
, &
ƒ_˝us
);

158 i‡(
ƒ_˝us
 > 0 &&Çr_˝u†< 
ƒ_˝u_ids
)

159 
ƒ_˝u_ids
 = 
ƒ_˝us
;

162 
	}
}

164 
óæy_∑øm
("ƒ_˝us", 
ƒ˝us
);

166 
__öô
 
	$max˝us
(*
°r
)

168 
	`gë_›ti⁄
(&
°r
, &
£tup_max_˝us
);

169 i‡(
£tup_max_˝us
 == 0)

170 
	`¨ch_dißbÀ_smp_suµ‹t
();

173 
	}
}

175 
óæy_∑øm
("max˝us", 
max˝us
);

177 c⁄° 
	g£tup_max_˝us
 = 
NR_CPUS
;

189 
	gª£t_devi˚s
;

190 
EXPORT_SYMBOL
(
ª£t_devi˚s
);

192 
__öô
 
	$£t_ª£t_devi˚s
(*
°r
)

194 
ª£t_devi˚s
 = 1;

196 
	}
}

198 
__£tup
("ª£t_devi˚s", 
£t_ª£t_devi˚s
);

200 * 
	g¨gv_öô
[
MAX_INIT_ARGS
+2] = { "öô", 
NULL
, };

201 * 
	gívp_öô
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMˆöux", 
NULL
, };

202 c⁄° *
	g∑nic_œãr
, *
	g∑nic_∑øm
;

204 
obs_kî√l_∑øm
 
__£tup_°¨t
[], 
__£tup_íd
[];

206 
__öô
 
	$obsﬁëe_check£tup
(*
löe
)

208 
obs_kî√l_∑øm
 *
p
;

209 
had_óæy_∑øm
 = 0;

211 
p
 = 
__£tup_°¨t
;

213 
n
 = 
	`°æí
(
p
->
°r
);

214 i‡(!
	`°∫cmp
(
löe
, 
p
->
°r
, 
n
)) {

215 i‡(
p
->
óæy
) {

220 i‡(
löe
[
n
] == '\0' ||Üine[n] == '=')

221 
had_óæy_∑øm
 = 1;

222 } i‡(!
p
->
£tup_func
) {

223 
	`¥ötk
(
KERN_WARNING
 "Parameter %s is obsolete,"

224 " ign‹ed\n", 
p
->
°r
);

226 } i‡(
p
->
	`£tup_func
(
löe
 + 
n
))

229 
p
++;

230 } 
p
 < 
__£tup_íd
);

232  
had_óæy_∑øm
;

233 
	}
}

239 
	glo›s_≥r_jiffy
 = (1<<12);

241 
EXPORT_SYMBOL
(
lo›s_≥r_jiffy
);

243 
__öô
 
	$debug_kî√l
(*
°r
)

245 
c⁄sﬁe_logÀvñ
 = 10;

247 
	}
}

249 
__öô
 
	$quõt_kî√l
(*
°r
)

251 
c⁄sﬁe_logÀvñ
 = 4;

253 
	}
}

255 
óæy_∑øm
("debug", 
debug_kî√l
);

256 
óæy_∑øm
("quõt", 
quõt_kî√l
);

258 
__öô
 
	$logÀvñ
(*
°r
)

260 
	`gë_›ti⁄
(&
°r
, &
c⁄sﬁe_logÀvñ
);

262 
	}
}

264 
óæy_∑øm
("logÀvñ", 
logÀvñ
);

270 
__öô
 
	$unknown_boŸ›ti⁄
(*
∑øm
, *
vÆ
)

273 i‡(
vÆ
) {

275 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+1)

276 
vÆ
[-1] = '=';

277 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+2) {

278 
vÆ
[-2] = '=';

279 
	`memmove
(
vÆ
-1, vÆ, 
	`°æí
(val)+1);

280 
vÆ
--;

282 
	`BUG
();

286 i‡(
	`obsﬁëe_check£tup
(
∑øm
))

290 i‡(
	`°rchr
(
∑øm
, '.'Ë&& (!
vÆ
 || strchr(param, '.') < val))

293 i‡(
∑nic_œãr
)

296 i‡(
vÆ
) {

298 
i
;

299 
i
 = 0; 
ívp_öô
[i]; i++) {

300 i‡(
i
 =
MAX_INIT_ENVS
) {

301 
∑nic_œãr
 = "Too many bootÉnv varsát `%s'";

302 
∑nic_∑øm
 = 
∑øm
;

304 i‡(!
	`°∫cmp
(
∑øm
, 
ívp_öô
[
i
], 
vÆ
 -Öaram))

307 
ívp_öô
[
i
] = 
∑øm
;

310 
i
;

311 
i
 = 0; 
¨gv_öô
[i]; i++) {

312 i‡(
i
 =
MAX_INIT_ARGS
) {

313 
∑nic_œãr
 = "Too many boot init varsát `%s'";

314 
∑nic_∑øm
 = 
∑øm
;

317 
¨gv_öô
[
i
] = 
∑øm
;

320 
	}
}

322 #ifde‡
CONFIG_DEBUG_PAGEALLOC


323 
__ªad_mo°ly
 
	gdebug_∑góŒoc_íabÀd
 = 0;

326 
__öô
 
	$öô_£tup
(*
°r
)

328 
i
;

330 
execuã_comm™d
 = 
°r
;

337 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

338 
¨gv_öô
[
i
] = 
NULL
;

340 
	}
}

341 
__£tup
("öô=", 
öô_£tup
);

343 
__öô
 
	$rdöô_£tup
(*
°r
)

345 
i
;

347 
ømdisk_execuã_comm™d
 = 
°r
;

349 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

350 
¨gv_öô
[
i
] = 
NULL
;

352 
	}
}

353 
__£tup
("rdöô=", 
rdöô_£tup
);

355 #i‚de‡
CONFIG_SMP


357 #ifde‡
CONFIG_X86_LOCAL_APIC


358 
__öô
 
	$smp_öô
()

360 
	`APIC_öô_unùro˚ss‹
();

361 
	}
}

363 
	#smp_öô
(Ëdÿ{ } 0)

	)

366 
ölöe
 
	$£tup_ƒ_˝u_ids
(Ë{ 
	}
}

367 
ölöe
 
	$smp_¥ï¨e_˝us
(
max˝us
Ë{ 
	}
}

372 
ƒ_˝u_ids
 
	g__ªad_mo°ly
 = 
NR_CPUS
;

373 
EXPORT_SYMBOL
(
ƒ_˝u_ids
);

376 
__öô
 
	$£tup_ƒ_˝u_ids
()

378 
ƒ_˝u_ids
 = 
	`föd_œ°_bô
(
	`˝umask_bôs
(
˝u_possibÀ_mask
),
NR_CPUS
) + 1;

379 
	}
}

382 
__öô
 
	$smp_öô
()

384 
˝u
;

387 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

388 i‡(
	`num_⁄löe_˝us
(Ë>
£tup_max_˝us
)

390 i‡(!
	`˝u_⁄löe
(
˝u
))

391 
	`˝u_up
(
˝u
);

395 
	`¥ötk
(
KERN_INFO
 "Broughàu∞%ld CPUs\n", ()
	`num_⁄löe_˝us
());

396 
	`smp_˝us_d⁄e
(
£tup_max_˝us
);

397 
	}
}

407 
__öô
 
	$£tup_comm™d_löe
(*
comm™d_löe
)

409 
ßved_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
boŸ_comm™d_löe
)+1);

410 
°©ic_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
comm™d_löe
)+1);

411 
	`°r˝y
 (
ßved_comm™d_löe
, 
boŸ_comm™d_löe
);

412 
	`°r˝y
 (
°©ic_comm™d_löe
, 
comm™d_löe
);

413 
	}
}

424 
noölöe
 
__öô_ªfok
 
	$ª°_öô
()

425 
	$__ªÀa£s
(
kî√l_lock
)

427 
pid
;

429 
	`rcu_scheduÀr_°¨tög
();

430 
	`kî√l_thªad
(
kî√l_öô
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

431 
	`numa_deÁu…_pﬁicy
();

432 
pid
 = 
	`kî√l_thªad
(
kthªadd
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

433 
	`rcu_ªad_lock
();

434 
kthªadd_èsk
 = 
	`föd_èsk_by_pid_ns
(
pid
, &
öô_pid_ns
);

435 
	`rcu_ªad_u∆ock
();

436 
	`u∆ock_kî√l
();

442 
	`öô_idÀ_boŸup_èsk
(
cuºít
);

443 
	`¥ìm±_íabÀ_no_ªsched
();

444 
	`scheduÀ
();

445 
	`¥ìm±_dißbÀ
();

448 
	`˝u_idÀ
();

449 
	}
}

452 
__öô
 
	$do_óæy_∑øm
(*
∑øm
, *
vÆ
)

454 
obs_kî√l_∑øm
 *
p
;

456 
p
 = 
__£tup_°¨t
;Ö < 
__£tup_íd
;Ö++) {

457 i‡((
p
->
óæy
 && 
	`°rcmp
(
∑øm
,Ö->
°r
) == 0) ||

458 (
	`°rcmp
(
∑øm
, "console") == 0 &&

459 
	`°rcmp
(
p
->
°r
, "earlycon") == 0)

461 i‡(
p
->
	`£tup_func
(
vÆ
) != 0)

462 
	`¥ötk
(
KERN_WARNING


463 "MÆf‹medÉ¨ly o±i⁄ '%s'\n", 
∑øm
);

468 
	}
}

470 
__öô
 
	$∑r£_óæy_›ti⁄s
(*
cmdlöe
)

472 
	`∑r£_¨gs
("óæy o±i⁄s", 
cmdlöe
, 
NULL
, 0, 
do_óæy_∑øm
);

473 
	}
}

476 
__öô
 
	$∑r£_óæy_∑øm
()

478 
__öôd©a
 
d⁄e
 = 0;

479 
__öôd©a
 
tmp_cmdlöe
[
COMMAND_LINE_SIZE
];

481 i‡(
d⁄e
)

485 
	`°æ˝y
(
tmp_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

486 
	`∑r£_óæy_›ti⁄s
(
tmp_cmdlöe
);

487 
d⁄e
 = 1;

488 
	}
}

494 
__öô
 
	$boŸ_˝u_öô
()

496 
˝u
 = 
	`smp_¥o˚ss‹_id
();

498 
	`£t_˝u_⁄löe
(
˝u
, 
åue
);

499 
	`£t_˝u_a˘ive
(
˝u
, 
åue
);

500 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

501 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

502 
	}
}

504 
__öô
 
__wók
 
	$smp_£tup_¥o˚ss‹_id
()

506 
	}
}

508 
__öô
 
__wók
 
	$thªad_öfo_ˇche_öô
()

510 
	}
}

515 
__öô
 
	$mm_öô
()

521 
	`∑ge_cgroup_öô_Ê©mem
();

522 
	`mem_öô
();

523 
	`kmem_ˇche_öô
();

524 
	`pgèbÀ_ˇche_öô
();

525 
	`vmÆloc_öô
();

526 
	}
}

528 
asmlökage
 
__öô
 
	$°¨t_kî√l
()

530 * 
comm™d_löe
;

531 
kî√l_∑øm
 
__°¨t___∑øm
[], 
__°›___∑øm
[];

533 
	`smp_£tup_¥o˚ss‹_id
();

539 
	`lockdï_öô
();

540 
	`debug_obje˘s_óæy_öô
();

545 
	`boŸ_öô_°ack_ˇ«ry
();

547 
	`cgroup_öô_óæy
();

549 
	`loˇl_úq_dißbÀ
();

550 
	`óæy_boŸ_úqs_off
();

551 
	`óæy_öô_úq_lock_˛ass
();

557 
	`lock_kî√l
();

558 
	`tick_öô
();

559 
	`boŸ_˝u_öô
();

560 
	`∑ge_addªss_öô
();

561 
	`¥ötk
(
KERN_NOTICE
 "%s", 
löux_b™√r
);

562 
	`£tup_¨ch
(&
comm™d_löe
);

563 
	`mm_öô_ow√r
(&
öô_mm
, &
öô_èsk
);

564 
	`£tup_comm™d_löe
(
comm™d_löe
);

565 
	`£tup_ƒ_˝u_ids
();

566 
	`£tup_≥r_˝u_¨ós
();

567 
	`smp_¥ï¨e_boŸ_˝u
();

569 
	`buûd_Æl_z⁄ñi°s
();

570 
	`∑ge_Æloc_öô
();

572 
	`¥ötk
(
KERN_NOTICE
 "Kî√»comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

573 
	`∑r£_óæy_∑øm
();

574 
	`∑r£_¨gs
("BoŸög kî√l", 
°©ic_comm™d_löe
, 
__°¨t___∑øm
,

575 
__°›___∑øm
 - 
__°¨t___∑øm
,

576 &
unknown_boŸ›ti⁄
);

581 
	`pidhash_öô
();

582 
	`vfs_ˇches_öô_óæy
();

583 
	`s‹t_maö_exèbÀ
();

584 
	`å≠_öô
();

585 
	`mm_öô
();

591 
	`sched_öô
();

596 
	`¥ìm±_dißbÀ
();

597 i‡(!
	`úqs_dißbÀd
()) {

598 
	`¥ötk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

600 
	`loˇl_úq_dißbÀ
();

602 
	`rcu_öô
();

603 
	`ødix_åì_öô
();

605 
	`óæy_úq_öô
();

606 
	`öô_IRQ
();

607 
	`¥io_åì_öô
();

608 
	`öô_timîs
();

609 
	`hπimîs_öô
();

610 
	`so·úq_öô
();

611 
	`timekìpög_öô
();

612 
	`time_öô
();

613 
	`¥ofûe_öô
();

614 i‡(!
	`úqs_dißbÀd
())

615 
	`¥ötk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

617 
	`óæy_boŸ_úqs_⁄
();

618 
	`loˇl_úq_íabÀ
();

621 
gÂ_Ælowed_mask
 = 
__GFP_BITS_MASK
;

623 
	`kmem_ˇche_öô_œã
();

630 
	`c⁄sﬁe_öô
();

631 i‡(
∑nic_œãr
)

632 
	`∑nic
(
∑nic_œãr
, 
∑nic_∑øm
);

634 
	`lockdï_öfo
();

641 
	`lockög_£l·e°
();

643 #ifde‡
CONFIG_BLK_DEV_INITRD


644 i‡(
öôrd_°¨t
 && !
öôrd_bñow_°¨t_ok
 &&

645 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)Ë< 
mö_low_p‚
) {

646 
	`¥ötk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

648 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)),

649 
mö_low_p‚
);

650 
öôrd_°¨t
 = 0;

653 
	`∑ge_cgroup_öô
();

654 
	`íabÀ_debug_∑góŒoc
();

655 
	`kmemåa˚_öô
();

656 
	`kmemÀak_öô
();

657 
	`debug_obje˘s_mem_öô
();

658 
	`idr_öô_ˇche
();

659 
	`£tup_≥r_˝u_∑ge£t
();

660 
	`numa_pﬁicy_öô
();

661 i‡(
œã_time_öô
)

662 
	`œã_time_öô
();

663 
	`sched_˛ock_öô
();

664 
	`ˇlibøã_dñay
();

665 
	`pidm≠_öô
();

666 
	`™⁄_vma_öô
();

667 #ifde‡
CONFIG_X86


668 i‡(
efi_íabÀd
)

669 
	`efi_íãr_vútuÆ_mode
();

671 
	`thªad_öfo_ˇche_öô
();

672 
	`¸ed_öô
();

673 
	`f‹k_öô
(
tŸÆøm_∑ges
);

674 
	`¥oc_ˇches_öô
();

675 
	`buf„r_öô
();

676 
	`key_öô
();

677 
	`£curôy_öô
();

678 
	`vfs_ˇches_öô
(
tŸÆøm_∑ges
);

679 
	`sig«ls_öô
();

681 
	`∑ge_wrôeback_öô
();

682 #ifde‡
CONFIG_PROC_FS


683 
	`¥oc_roŸ_öô
();

685 
	`cgroup_öô
();

686 
	`˝u£t_öô
();

687 
	`èsk°©s_öô_óæy
();

688 
	`dñayac˘_öô
();

690 
	`check_bugs
();

692 
	`a˝i_óæy_öô
();

693 
	`sfi_öô_œã
();

695 
	`·ø˚_öô
();

698 
	`ª°_öô
();

699 
	}
}

702 
__öô
 
	$do_˘‹s
()

704 #ifde‡
CONFIG_CONSTRUCTORS


705 
˘‹_‚_t
 *
‚
 = (˘‹_‚_à*Ë
__˘‹s_°¨t
;

707 ; 
‚
 < (
˘‹_‚_t
 *Ë
__˘‹s_íd
; fn++)

708 (*
‚
)();

710 
	}
}

712 
	göôˇŒ_debug
;

713 
c‹e_∑øm
(
öôˇŒ_debug
, inôˇŒ_debug, 
boﬁ
, 0644);

715 
	gmsgbuf
[64];

716 
boŸ_åa˚_ˇŒ
 
	gˇŒ
;

717 
boŸ_åa˚_ªt
 
	gªt
;

719 
	$do_⁄e_öôˇŒ
(
öôˇŒ_t
 
‚
)

721 
cou¡
 = 
	`¥ìm±_cou¡
();

722 
ktime_t
 
ˇŒtime
, 
dñè
, 
ªâime
;

724 i‡(
öôˇŒ_debug
) {

725 
ˇŒ
.
ˇŒî
 = 
	`èsk_pid_ƒ
(
cuºít
);

726 
	`¥ötk
("ˇŒög %pF @ %i\n", 
‚
, 
ˇŒ
.
ˇŒî
);

727 
ˇŒtime
 = 
	`ktime_gë
();

728 
	`åa˚_boŸ_ˇŒ
(&
ˇŒ
, 
‚
);

729 
	`íabÀ_boŸ_åa˚
();

732 
ªt
.
ªsu…
 = 
	`‚
();

734 i‡(
öôˇŒ_debug
) {

735 
	`dißbÀ_boŸ_åa˚
();

736 
ªâime
 = 
	`ktime_gë
();

737 
dñè
 = 
	`ktime_sub
(
ªâime
, 
ˇŒtime
);

738 
ªt
.
duøti⁄
 = (Ë
	`ktime_to_ns
(
dñè
) >> 10;

739 
	`åa˚_boŸ_ªt
(&
ªt
, 
‚
);

740 
	`¥ötk
("öôˇŒ %pFÑëu∫ed %dá·î %Ld u£cs\n", 
‚
,

741 
ªt
.
ªsu…
,Ñë.
duøti⁄
);

744 
msgbuf
[0] = 0;

746 i‡(
ªt
.
ªsu…
 &&Ñë.ªsu… !-
ENODEV
 && 
öôˇŒ_debug
)

747 
	`•rötf
(
msgbuf
, "îr‹ codê%d ", 
ªt
.
ªsu…
);

749 i‡(
	`¥ìm±_cou¡
(Ë!
cou¡
) {

750 
	`°æˇt
(
msgbuf
, "preemption imbalance ", (msgbuf));

751 
	`¥ìm±_cou¡
(Ë
cou¡
;

753 i‡(
	`úqs_dißbÀd
()) {

754 
	`°æˇt
(
msgbuf
, "disabled interrupts ", (msgbuf));

755 
	`loˇl_úq_íabÀ
();

757 i‡(
msgbuf
[0]) {

758 
	`¥ötk
("öôˇŒ %pFÑëu∫ed wôh %s\n", 
‚
, 
msgbuf
);

761  
ªt
.
ªsu…
;

762 
	}
}

765 
öôˇŒ_t
 
__öôˇŒ_°¨t
[], 
__öôˇŒ_íd
[], 
__óæy_öôˇŒ_íd
[];

767 
__öô
 
	$do_öôˇŒs
()

769 
öôˇŒ_t
 *
‚
;

771 
‚
 = 
__óæy_öôˇŒ_íd
; f¿< 
__öôˇŒ_íd
; fn++)

772 
	`do_⁄e_öôˇŒ
(*
‚
);

775 
	`Êush_scheduÀd_w‹k
();

776 
	}
}

785 
__öô
 
	$do_basic_£tup
()

787 
	`öô_w‹kqueues
();

788 
	`˝u£t_öô_smp
();

789 
	`u£rmodehñ≥r_öô
();

790 
	`öô_tmpfs
();

791 
	`drivî_öô
();

792 
	`öô_úq_¥oc
();

793 
	`do_˘‹s
();

794 
	`do_öôˇŒs
();

795 
	}
}

797 
__öô
 
	$do_¥e_smp_öôˇŒs
()

799 
öôˇŒ_t
 *
‚
;

801 
‚
 = 
__öôˇŒ_°¨t
; f¿< 
__óæy_öôˇŒ_íd
; fn++)

802 
	`do_⁄e_öôˇŒ
(*
‚
);

803 
	}
}

805 
	$run_öô_¥o˚ss
(*
öô_fûíame
)

807 
¨gv_öô
[0] = 
öô_fûíame
;

808 
	`kî√l_execve
(
öô_fûíame
, 
¨gv_öô
, 
ívp_öô
);

809 
	}
}

814 
noölöe
 
	$öô_po°
()

815 
	$__ªÀa£s
(
kî√l_lock
)

818 
	`async_synchr⁄ize_fuŒ
();

819 
	`‰ì_öômem
();

820 
	`u∆ock_kî√l
();

821 
	`m¨k_rod©a_ro
();

822 
sy°em_°©e
 = 
SYSTEM_RUNNING
;

823 
	`numa_deÁu…_pﬁicy
();

826 
cuºít
->
sig«l
->
Êags
 |
SIGNAL_UNKILLABLE
;

828 i‡(
ømdisk_execuã_comm™d
) {

829 
	`run_öô_¥o˚ss
(
ømdisk_execuã_comm™d
);

830 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s\n",

831 
ømdisk_execuã_comm™d
);

840 i‡(
execuã_comm™d
) {

841 
	`run_öô_¥o˚ss
(
execuã_comm™d
);

842 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s. Attempting "

843 "deÁu…s...\n", 
execuã_comm™d
);

845 
	`run_öô_¥o˚ss
("/sbin/init");

846 
	`run_öô_¥o˚ss
("/etc/init");

847 
	`run_öô_¥o˚ss
("/bin/init");

848 
	`run_öô_¥o˚ss
("/bin/sh");

850 
	`∑nic
("No init found. TryÖassing init= optionÅo kernel. "

852 
	}
}

854 
__öô
 
	$kî√l_öô
(* 
unu£d
)

856 
	`lock_kî√l
();

861 
	`£t_mems_Ælowed
(
node_°©es
[
N_HIGH_MEMORY
]);

865 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
˝u_Æl_mask
);

874 
öô_pid_ns
.
chûd_ª≠î
 = 
cuºít
;

876 
ˇd_pid
 = 
	`èsk_pid
(
cuºít
);

878 
	`smp_¥ï¨e_˝us
(
£tup_max_˝us
);

880 
	`do_¥e_smp_öôˇŒs
();

881 
	`°¨t_boŸ_åa˚
();

883 
	`smp_öô
();

884 
	`sched_öô_smp
();

886 
	`do_basic_£tup
();

889 i‡(
	`sys_›í
((c⁄° 
__u£r
 *Ë"/dev/c⁄sﬁe", 
O_RDWR
, 0) < 0)

890 
	`¥ötk
(
KERN_WARNING
 "Warning: unableÅo openán initial console.\n");

892 (Ë
	`sys_dup
(0);

893 (Ë
	`sys_dup
(0);

899 i‡(!
ømdisk_execuã_comm™d
)

900 
ømdisk_execuã_comm™d
 = "/init";

902 i‡(
	`sys_ac˚ss
((c⁄° 
__u£r
 *Ë
ømdisk_execuã_comm™d
, 0) != 0) {

903 
ømdisk_execuã_comm™d
 = 
NULL
;

904 
	`¥ï¨e_«me•a˚
();

913 
	`öô_po°
();

915 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<gíî©ed/compûe.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/uts.h
>

12 
	~<löux/ut¢ame.h
>

13 
	~<gíî©ed/ut§ñó£.h
>

14 
	~<löux/vîsi⁄.h
>

16 #i‚de‡
CONFIG_KALLSYMS


17 
	#vîsi⁄
(
a
Ë
Vîsi⁄_
 ## 
	)
a

18 
	#vîsi⁄_°rög
(
a
Ë
	`vîsi⁄
◊)

	)

20 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

21 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

24 
uts_«me•a˚
 
	göô_uts_ns
 = {

25 .
kªf
 = {

26 .
ªfcou¡
 = 
ATOMIC_INIT
(2),

28 .
	g«me
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnodíame
 = 
UTS_NODENAME
,

31 .
	gªÀa£
 = 
UTS_RELEASE
,

32 .
	gvîsi⁄
 = 
UTS_VERSION
,

33 .
	gmachöe
 = 
UTS_MACHINE
,

34 .
	gdomaö«me
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
öô_uts_ns
);

40 c⁄° 
	glöux_b™√r
[] =

41 "Löux vîsi⁄ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "Ë(" 
LINUX_COMPILER
 "Ë" 
UTS_VERSION
 "\n";

44 c⁄° 
	glöux_¥oc_b™√r
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
156
6632
/cmpt816/linux/arch/x86/ia32/audit.c
/cmpt816/linux/arch/x86/ia32/ia32_signal.c
/cmpt816/linux/arch/x86/ia32/ipc32.c
/cmpt816/linux/arch/x86/ia32/sys_ia32.c
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/sched.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/x86_init.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/physaddr.c
/cmpt816/linux/arch/x86/mm/setup_nx.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
