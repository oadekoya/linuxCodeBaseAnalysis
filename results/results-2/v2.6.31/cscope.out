cscope 15 /cmpt816/data -q 0000010945 0001399647
	@/cmpt816/linux/arch/x86/ia32/audit.c

1 
	~<asm/uni°d_32.h
>

3 
	gü32_dú_˛ass
[] = {

4 
	~<asm-gíîic/audô_dú_wrôe.h
>

8 
	gü32_ch©å_˛ass
[] = {

9 
	~<asm-gíîic/audô_ch™ge_©å.h
>

13 
	gü32_wrôe_˛ass
[] = {

14 
	~<asm-gíîic/audô_wrôe.h
>

18 
	gü32_ªad_˛ass
[] = {

19 
	~<asm-gíîic/audô_ªad.h
>

23 
	gü32_sig«l_˛ass
[] = {

24 
	~<asm-gíîic/audô_sig«l.h
>

28 
	$ü32_˛assify_sysˇŒ
(
sysˇŒ
)

30 
sysˇŒ
) {

31 
__NR_›í
:

33 
__NR_›í©
:

35 
__NR_sockëˇŒ
:

37 
__NR_execve
:

42 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ia32_signal.c

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/uni°d.h
>

20 
	~<löux/°ddef.h
>

21 
	~<löux/≥rs⁄Æôy.h
>

22 
	~<löux/com∑t.h
>

23 
	~<löux/böfmts.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/±ø˚.h
>

28 
	~<asm/ü32_uni°d.h
>

29 
	~<asm/u£r32.h
>

30 
	~<asm/sigc⁄ãxt32.h
>

31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/vdso.h
>

33 
	~<asm/sig‰ame.h
>

34 
	~<asm/sys_ü32.h
>

36 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

38 
	#FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

39 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

40 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

41 
X86_EFLAGS_CF
)

	)

43 
sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
);

45 
	$c›y_sigöfo_to_u£r32
(
com∑t_sigöfo_t
 
__u£r
 *
to
, 
sigöfo_t
 *
‰om
)

47 
îr
 = 0;

49 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
to
, (
com∑t_sigöfo_t
)))

50  -
EFAULT
;

52 
put_u£r_åy
 {

58 
	`put_u£r_ex
(
‰om
->
si_signo
, &
to
->si_signo);

59 
	`put_u£r_ex
(
‰om
->
si_î∫o
, &
to
->si_errno);

60 
	`put_u£r_ex
(()
‰om
->
si_code
, &
to
->si_code);

62 i‡(
‰om
->
si_code
 < 0) {

63 
	`put_u£r_ex
(
‰om
->
si_pid
, &
to
->si_pid);

64 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

65 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
), &
to
->si_ptr);

71 
	`put_u£r_ex
(
‰om
->
_sifõlds
.
_∑d
[0],

72 &
to
->
_sifõlds
.
_∑d
[0]);

73 
‰om
->
si_code
 >> 16) {

74 
__SI_FAULT
 >> 16:

76 
__SI_CHLD
 >> 16:

77 
	`put_u£r_ex
(
‰om
->
si_utime
, &
to
->si_utime);

78 
	`put_u£r_ex
(
‰om
->
si_°ime
, &
to
->si_stime);

79 
	`put_u£r_ex
(
‰om
->
si_°©us
, &
to
->si_status);

82 
__SI_KILL
 >> 16:

83 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

85 
__SI_POLL
 >> 16:

86 
	`put_u£r_ex
(
‰om
->
si_fd
, &
to
->si_fd);

88 
__SI_TIMER
 >> 16:

89 
	`put_u£r_ex
(
‰om
->
si_ovîrun
, &
to
->si_overrun);

90 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
),

91 &
to
->
si_±r
);

94 
__SI_RT
 >> 16:

95 
__SI_MESGQ
 >> 16:

96 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

97 
	`put_u£r_ex
(
‰om
->
si_öt
, &
to
->si_int);

101 } 
	`put_u£r_ˇtch
(
îr
);

103  
îr
;

104 
	}
}

106 
	$c›y_sigöfo_‰om_u£r32
(
sigöfo_t
 *
to
, 
com∑t_sigöfo_t
 
__u£r
 *
‰om
)

108 
îr
 = 0;

109 
u32
 
±r32
;

111 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰om
, (
com∑t_sigöfo_t
)))

112  -
EFAULT
;

114 
gë_u£r_åy
 {

115 
	`gë_u£r_ex
(
to
->
si_signo
, &
‰om
->si_signo);

116 
	`gë_u£r_ex
(
to
->
si_î∫o
, &
‰om
->si_errno);

117 
	`gë_u£r_ex
(
to
->
si_code
, &
‰om
->si_code);

119 
	`gë_u£r_ex
(
to
->
si_pid
, &
‰om
->si_pid);

120 
	`gë_u£r_ex
(
to
->
si_uid
, &
‰om
->si_uid);

121 
	`gë_u£r_ex
(
±r32
, &
‰om
->
si_±r
);

122 
to
->
si_±r
 = 
	`com∑t_±r
(
±r32
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

128 
asmlökage
 
	$sys32_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

130 
mask
 &
_BLOCKABLE
;

131 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

132 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

133 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

134 
	`ªˇlc_sig≥ndög
();

135 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

137 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

138 
	`scheduÀ
();

139 
	`£t_ª°‹e_sigmask
();

140  -
ERESTARTNOHAND
;

141 
	}
}

143 
asmlökage
 
	$sys32_sigÆt°ack
(c⁄° 
°ack_ü32_t
 
__u£r
 *
uss_±r
,

144 
°ack_ü32_t
 
__u£r
 *
uoss_±r
,

145 
±_ªgs
 *
ªgs
)

147 
°ack_t
 
uss
, 
uoss
;

148 
ªt
, 
îr
 = 0;

149 
mm_£gmít_t
 
£g
;

151 i‡(
uss_±r
) {

152 
u32
 
±r
;

154 
	`mem£t
(&
uss
, 0, (
°ack_t
));

155 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
uss_±r
, (
°ack_ü32_t
)))

156  -
EFAULT
;

158 
gë_u£r_åy
 {

159 
	`gë_u£r_ex
(
±r
, &
uss_±r
->
ss_•
);

160 
	`gë_u£r_ex
(
uss
.
ss_Êags
, &
uss_±r
->ss_flags);

161 
	`gë_u£r_ex
(
uss
.
ss_size
, &
uss_±r
->ss_size);

162 } 
	`gë_u£r_ˇtch
(
îr
);

164 i‡(
îr
)

165  -
EFAULT
;

166 
uss
.
ss_•
 = 
	`com∑t_±r
(
±r
);

168 
£g
 = 
	`gë_fs
();

169 
	`£t_fs
(
KERNEL_DS
);

170 
ªt
 = 
	`do_sigÆt°ack
(
uss_±r
 ? &
uss
 : 
NULL
, &
uoss
, 
ªgs
->
•
);

171 
	`£t_fs
(
£g
);

172 i‡(
ªt
 >0 && 
uoss_±r
) {

173 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss_±r
, (
°ack_ü32_t
)))

174  -
EFAULT
;

176 
put_u£r_åy
 {

177 
	`put_u£r_ex
(
	`±r_to_com∑t
(
uoss
.
ss_•
), &
uoss_±r
->ss_sp);

178 
	`put_u£r_ex
(
uoss
.
ss_Êags
, &
uoss_±r
->ss_flags);

179 
	`put_u£r_ex
(
uoss
.
ss_size
, &
uoss_±r
->ss_size);

180 } 
	`put_u£r_ˇtch
(
îr
);

182 i‡(
îr
)

183 
ªt
 = -
EFAULT
;

185  
ªt
;

186 
	}
}

191 
	#lﬂd£gmít_gs
(
v
Ë
	`lﬂd_gs_ödex
(v)

	)

192 
	#lﬂd£gmít_fs
(
v
Ë
	`lﬂd£gmít
(
fs
, v)

	)

193 
	#lﬂd£gmít_ds
(
v
Ë
	`lﬂd£gmít
(
ds
, v)

	)

194 
	#lﬂd£gmít_es
(
v
Ë
	`lﬂd£gmít
(
es
, v)

	)

196 
	#gë_u£r_£g
(
£g
Ë({ 
v
; 
	`ßve£gmít
(£g, v); v; })

	)

197 
	#£t_u£r_£g
(
£g
, 
v
Ë
lﬂd£gmít_
##
	`£g
(v)

	)

199 
	#COPY
(
x
) { \

200 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

201 }

	)

203 
	#GET_SEG
(
£g
) ({ \

204 
tmp
; \

205 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

206 
tmp
; \

207 })

	)

209 
	#COPY_SEG_CPL3
(
£g
) do { \

210 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

211 } 0)

	)

213 
	#RELOAD_SEG
(
£g
) { \

214 
¥e
 = 
	`GET_SEG
(
£g
); \

215 
cur
 = 
	`gë_u£r_£g
(
£g
); \

216 
¥e
 |= 3; \

217 i‡(
¥e
 !
cur
) \

218 
	`£t_u£r_£g
(
£g
, 
¥e
); \

219 }

	)

221 
	$ü32_ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
,

222 
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

223 *
∑x
)

225 
tmpÊags
, 
îr
 = 0;

226 
__u£r
 *
buf
;

227 
u32
 
tmp
;

230 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

232 
gë_u£r_åy
 {

239 
	`RELOAD_SEG
(
gs
);

240 
	`RELOAD_SEG
(
fs
);

241 
	`RELOAD_SEG
(
ds
);

242 
	`RELOAD_SEG
(
es
);

244 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

245 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

248 
	`COPY_SEG_CPL3
(
cs
);

249 
	`COPY_SEG_CPL3
(
ss
);

251 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

252 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

254 
ªgs
->
‹ig_ax
 = -1;

256 
	`gë_u£r_ex
(
tmp
, &
sc
->
Â°©e
);

257 
buf
 = 
	`com∑t_±r
(
tmp
);

258 
îr
 |
	`ª°‹e_i387_x°©e_ü32
(
buf
);

260 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

261 } 
	`gë_u£r_ˇtch
(
îr
);

263  
îr
;

264 
	}
}

266 
asmlökage
 
	$sys32_sigªtu∫
(
±_ªgs
 *
ªgs
)

268 
sig‰ame_ü32
 
__u£r
 *
‰ame
 = (sig‰ame_ü32 __u£∏*)(
ªgs
->
•
-8);

269 
sig£t_t
 
£t
;

270 
ax
;

272 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

273 
bad‰ame
;

274 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
)

275 || (
_COMPAT_NSIG_WORDS
 > 1

276 && 
	`__c›y_‰om_u£r
((((*Ë&
£t
.
sig
) + 4),

277 &
‰ame
->
exåamask
,

278 (
‰ame
->
exåamask
))))

279 
bad‰ame
;

281 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

282 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

283 
cuºít
->
blocked
 = 
£t
;

284 
	`ªˇlc_sig≥ndög
();

285 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

287 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

288 
bad‰ame
;

289  
ax
;

291 
bad‰ame
:

292 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bit sigreturn");

294 
	}
}

296 
asmlökage
 
	$sys32_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

299 
sig£t_t
 
£t
;

300 
ax
;

301 
±_ªgs
 
åegs
;

303 
‰ame
 = (
π_sig‰ame_ü32
 
__u£r
 *)(
ªgs
->
•
 - 4);

305 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

306 
bad‰ame
;

307 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

308 
bad‰ame
;

310 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

311 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

312 
cuºít
->
blocked
 = 
£t
;

313 
	`ªˇlc_sig≥ndög
();

314 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

316 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

317 
bad‰ame
;

319 
åegs
 = *
ªgs
;

320 i‡(
	`sys32_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, &
åegs
Ë=-
EFAULT
)

321 
bad‰ame
;

323  
ax
;

325 
bad‰ame
:

326 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bitÑt sigreturn");

328 
	}
}

334 
	$ü32_£tup_sigc⁄ãxt
(
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

335 
__u£r
 *
Â°©e
,

336 
±_ªgs
 *
ªgs
, 
mask
)

338 
îr
 = 0;

340 
put_u£r_åy
 {

341 
	`put_u£r_ex
(
	`gë_u£r_£g
(
gs
), (
__u£r
 *)&
sc
->gs);

342 
	`put_u£r_ex
(
	`gë_u£r_£g
(
fs
), (
__u£r
 *)&
sc
->fs);

343 
	`put_u£r_ex
(
	`gë_u£r_£g
(
ds
), (
__u£r
 *)&
sc
->ds);

344 
	`put_u£r_ex
(
	`gë_u£r_£g
(
es
), (
__u£r
 *)&
sc
->es);

346 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

347 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

348 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

349 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

350 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

351 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

352 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

353 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

354 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

355 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

356 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

357 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

358 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

359 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

360 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

362 
	`put_u£r_ex
(
	`±r_to_com∑t
(
Â°©e
), &
sc
->fpstate);

365 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

366 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

367 } 
	`put_u£r_ˇtch
(
îr
);

369  
îr
;

370 
	}
}

375 
__u£r
 *
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
,

376 
size_t
 
‰ame_size
,

377 **
Â°©e
)

379 
•
;

382 
•
 = 
ªgs
->sp;

385 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

386 i‡(
	`ßs_ss_Êags
(
•
) == 0)

387 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

391 i‡((
ªgs
->
ss
 & 0xffffË!
__USER32_DS
 &&

392 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

393 
ka
->
ß
.
ß_ª°‹î
)

394 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

396 i‡(
	`u£d_m©h
()) {

397 
•
 = s∞- 
sig_x°©e_ü32_size
;

398 *
Â°©e
 = (
_Â°©e_ü32
 *Ë
•
;

399 i‡(
	`ßve_i387_x°©e_ü32
(*
Â°©e
) < 0)

400  (
__u£r
 *) -1L;

403 
•
 -
‰ame_size
;

406 
•
 = ((sp + 4) & -16ul) - 4;

407  (
__u£r
 *Ë
•
;

408 
	}
}

410 
	$ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

411 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

413 
sig‰ame_ü32
 
__u£r
 *
‰ame
;

414 
__u£r
 *
ª°‹î
;

415 
îr
 = 0;

416 
__u£r
 *
Â°©e
 = 
NULL
;

420 
u16
 
p›lmovl
;

421 
u32
 
vÆ
;

422 
u16
 
öt80
;

423 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

425 
__NR_ü32_sigªtu∫
,

429 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

431 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

432  -
EFAULT
;

434 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

435  -
EFAULT
;

437 i‡(
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

438  -
EFAULT
;

440 i‡(
_COMPAT_NSIG_WORDS
 > 1) {

441 i‡(
	`__c›y_to_u£r
(
‰ame
->
exåamask
, &
£t
->
sig
[1],

442 (
‰ame
->
exåamask
)))

443  -
EFAULT
;

446 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

447 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

450 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

451 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

452 
sigªtu∫
);

454 
ª°‹î
 = &
‰ame
->
ªtcode
;

457 
put_u£r_åy
 {

458 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

464 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

465 } 
	`put_u£r_ˇtch
(
îr
);

467 i‡(
îr
)

468  -
EFAULT
;

471 
ªgs
->
•
 = (Ë
‰ame
;

472 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

475 
ªgs
->
ax
 = 
sig
;

476 
ªgs
->
dx
 = 0;

477 
ªgs
->
cx
 = 0;

479 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

480 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

482 
ªgs
->
cs
 = 
__USER32_CS
;

483 
ªgs
->
ss
 = 
__USER32_DS
;

486 
	}
}

488 
	$ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

489 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

491 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

492 
__u£r
 *
ª°‹î
;

493 
îr
 = 0;

494 
__u£r
 *
Â°©e
 = 
NULL
;

498 
u8
 
movl
;

499 
u32
 
vÆ
;

500 
u16
 
öt80
;

501 
u8
 
∑d
;

502 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

504 
__NR_ü32_π_sigªtu∫
,

509 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

511 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

512  -
EFAULT
;

514 
put_u£r_åy
 {

515 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

516 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
öfo
), &‰ame->
pöfo
);

517 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
uc
), &‰ame->
puc
);

518 
îr
 |
	`c›y_sigöfo_to_u£r32
(&
‰ame
->
öfo
, info);

521 i‡(
˝u_has_xßve
)

522 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

524 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

525 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

526 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

527 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

528 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

529 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

530 
îr
 |
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

531 
ªgs
, 
£t
->
sig
[0]);

532 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

534 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

535 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

537 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

538 
π_sigªtu∫
);

539 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

545 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

546 } 
	`put_u£r_ˇtch
(
îr
);

548 i‡(
îr
)

549  -
EFAULT
;

552 
ªgs
->
•
 = (Ë
‰ame
;

553 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

556 
ªgs
->
ax
 = 
sig
;

557 
ªgs
->
dx
 = (Ë&
‰ame
->
öfo
;

558 
ªgs
->
cx
 = (Ë&
‰ame
->
uc
;

560 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

561 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

563 
ªgs
->
cs
 = 
__USER32_CS
;

564 
ªgs
->
ss
 = 
__USER32_DS
;

567 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ipc32.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/•ölock.h
>

3 
	~<löux/li°.h
>

4 
	~<löux/sysˇŒs.h
>

5 
	~<löux/time.h
>

6 
	~<löux/£m.h
>

7 
	~<löux/msg.h
>

8 
	~<löux/shm.h
>

9 
	~<löux/ùc.h
>

10 
	~<löux/com∑t.h
>

11 
	~<asm/sys_ü32.h
>

13 
asmlökage
 
	$sys32_ùc
(
u32
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

14 
com∑t_u±r_t
 
±r
, 
u32
 
fi·h
)

16 
vîsi⁄
;

18 
vîsi⁄
 = 
ˇŒ
 >> 16;

19 
ˇŒ
 &= 0xffff;

21 
ˇŒ
) {

22 
SEMOP
:

24  
	`sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
, 
NULL
);

25 
SEMTIMEDOP
:

26  
	`com∑t_sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
,

27 
	`com∑t_±r
(
fi·h
));

28 
SEMGET
:

29  
	`sys_£mgë
(
fú°
, 
£c⁄d
, 
thúd
);

30 
SEMCTL
:

31  
	`com∑t_sys_£m˘l
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

33 
MSGSND
:

34  
	`com∑t_sys_msg¢d
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

35 
MSGRCV
:

36  
	`com∑t_sys_msgrcv
(
fú°
, 
£c⁄d
, 
fi·h
, 
thúd
,

37 
vîsi⁄
, 
	`com∑t_±r
(
±r
));

38 
MSGGET
:

39  
	`sys_msggë
((
key_t
Ë
fú°
, 
£c⁄d
);

40 
MSGCTL
:

41  
	`com∑t_sys_msg˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

43 
SHMAT
:

44  
	`com∑t_sys_shm©
(
fú°
, 
£c⁄d
, 
thúd
, 
vîsi⁄
,

45 
	`com∑t_±r
(
±r
));

46 
SHMDT
:

47  
	`sys_shmdt
(
	`com∑t_±r
(
±r
));

48 
SHMGET
:

49  
	`sys_shmgë
(
fú°
, ()
£c⁄d
, 
thúd
);

50 
SHMCTL
:

51  
	`com∑t_sys_shm˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

53  -
ENOSYS
;

54 
	}
}

	@/cmpt816/linux/arch/x86/ia32/sys_ia32.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/sig«l.h
>

28 
	~<löux/sysˇŒs.h
>

29 
	~<löux/times.h
>

30 
	~<löux/ut¢ame.h
>

31 
	~<löux/smp_lock.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/uio.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/≥rs⁄Æôy.h
>

36 
	~<löux/°©.h
>

37 
	~<löux/rw£m.h
>

38 
	~<löux/com∑t.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/±ø˚.h
>

41 
	~<löux/highuid.h
>

42 
	~<löux/sys˘l.h
>

43 
	~<asm/mm™.h
>

44 
	~<asm/ty≥s.h
>

45 
	~<asm/uac˚ss.h
>

46 
	~<asm/©omic.h
>

47 
	~<asm/vgtod.h
>

48 
	~<asm/sys_ü32.h
>

50 
	#AA
(
__x
Ë(()(__x))

	)

53 
asmlökage
 
	$sys32_åunˇã64
(
__u£r
 *
fûíame
,

54 
off£t_low
,

55 
off£t_high
)

57  
	`sys_åunˇã
(
fûíame
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

58 
	}
}

60 
asmlökage
 
	$sys32_·runˇã64
(
fd
, 
off£t_low
,

61 
off£t_high
)

63  
	`sys_·runˇã
(
fd
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

64 
	}
}

70 
	$˝_°©64
(
°©64
 
__u£r
 *
ubuf
, 
k°©
 *
°©
)

72 
	`ty≥of
(
ubuf
->
°_uid
Ë
uid
 = 0;

73 
	`ty≥of
(
ubuf
->
°_gid
Ë
gid
 = 0;

74 
	`SET_UID
(
uid
, 
°©
->uid);

75 
	`SET_GID
(
gid
, 
°©
->gid);

76 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ubuf
, (
°©64
)) ||

77 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
dev
), &
ubuf
->
°_dev
) ||

78 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
__°_öo
) ||

79 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
°_öo
) ||

80 
	`__put_u£r
(
°©
->
mode
, &
ubuf
->
°_mode
) ||

81 
	`__put_u£r
(
°©
->
∆ök
, &
ubuf
->
°_∆ök
) ||

82 
	`__put_u£r
(
uid
, &
ubuf
->
°_uid
) ||

83 
	`__put_u£r
(
gid
, &
ubuf
->
°_gid
) ||

84 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
rdev
), &
ubuf
->
°_rdev
) ||

85 
	`__put_u£r
(
°©
->
size
, &
ubuf
->
°_size
) ||

86 
	`__put_u£r
(
°©
->
©ime
.
tv_£c
, &
ubuf
->
°_©ime
) ||

87 
	`__put_u£r
(
°©
->
©ime
.
tv_n£c
, &
ubuf
->
°_©ime_n£c
) ||

88 
	`__put_u£r
(
°©
->
mtime
.
tv_£c
, &
ubuf
->
°_mtime
) ||

89 
	`__put_u£r
(
°©
->
mtime
.
tv_n£c
, &
ubuf
->
°_mtime_n£c
) ||

90 
	`__put_u£r
(
°©
->
˘ime
.
tv_£c
, &
ubuf
->
°_˘ime
) ||

91 
	`__put_u£r
(
°©
->
˘ime
.
tv_n£c
, &
ubuf
->
°_˘ime_n£c
) ||

92 
	`__put_u£r
(
°©
->
blksize
, &
ubuf
->
°_blksize
) ||

93 
	`__put_u£r
(
°©
->
blocks
, &
ubuf
->
°_blocks
))

94  -
EFAULT
;

96 
	}
}

98 
asmlökage
 
	$sys32_°©64
(
__u£r
 *
fûíame
,

99 
°©64
 
__u£r
 *
°©buf
)

101 
k°©
 
°©
;

102 
ªt
 = 
	`vfs_°©
(
fûíame
, &
°©
);

104 i‡(!
ªt
)

105 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

106  
ªt
;

107 
	}
}

109 
asmlökage
 
	$sys32_l°©64
(
__u£r
 *
fûíame
,

110 
°©64
 
__u£r
 *
°©buf
)

112 
k°©
 
°©
;

113 
ªt
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

114 i‡(!
ªt
)

115 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

116  
ªt
;

117 
	}
}

119 
asmlökage
 
	$sys32_f°©64
(
fd
, 
°©64
 
__u£r
 *
°©buf
)

121 
k°©
 
°©
;

122 
ªt
 = 
	`vfs_f°©
(
fd
, &
°©
);

123 i‡(!
ªt
)

124 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

125  
ªt
;

126 
	}
}

128 
asmlökage
 
	$sys32_f°©©
(
dfd
, 
__u£r
 *
fûíame
,

129 
°©64
 
__u£r
 *
°©buf
, 
Êag
)

131 
k°©
 
°©
;

132 
îr‹
;

134 
îr‹
 = 
	`vfs_f°©©
(
dfd
, 
fûíame
, &
°©
, 
Êag
);

135 i‡(
îr‹
)

136  
îr‹
;

137  
	`˝_°©64
(
°©buf
, &
°©
);

138 
	}
}

146 
	smm≠_¨g_°ru˘
 {

147 
	maddr
;

148 
	mÀn
;

149 
	m¥Ÿ
;

150 
	mÊags
;

151 
	mfd
;

152 
	moff£t
;

155 
asmlökage
 
	$sys32_mm≠
(
mm≠_¨g_°ru˘
 
__u£r
 *
¨g
)

157 
mm≠_¨g_°ru˘
 
a
;

158 
fûe
 *fûê
NULL
;

159 
ªtvÆ
;

160 
mm_°ru˘
 *
mm
 ;

162 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

163  -
EFAULT
;

165 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

166  -
EINVAL
;

168 i‡(!(
a
.
Êags
 & 
MAP_ANONYMOUS
)) {

169 
fûe
 = 
	`fgë
(
a
.
fd
);

170 i‡(!
fûe
)

171  -
EBADF
;

174 
mm
 = 
cuºít
->mm;

175 
	`down_wrôe
(&
mm
->
mm≠_£m
);

176 
ªtvÆ
 = 
	`do_mm≠_pgoff
(
fûe
, 
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,

177 
a
.
off£t
>>
PAGE_SHIFT
);

178 i‡(
fûe
)

179 
	`Âut
(
fûe
);

181 
	`up_wrôe
(&
mm
->
mm≠_£m
);

183  
ªtvÆ
;

184 
	}
}

186 
asmlökage
 
	$sys32_m¥Ÿe˘
(
°¨t
, 
size_t
 
Àn
,

187 
¥Ÿ
)

189  
	`sys_m¥Ÿe˘
(
°¨t
, 
Àn
, 
¥Ÿ
);

190 
	}
}

192 
asmlökage
 
	$sys32_pùe
(
__u£r
 *
fd
)

194 
ªtvÆ
;

195 
fds
[2];

197 
ªtvÆ
 = 
	`do_pùe_Êags
(
fds
, 0);

198 i‡(
ªtvÆ
)

199 
out
;

200 i‡(
	`c›y_to_u£r
(
fd
, 
fds
, (fds)))

201 
ªtvÆ
 = -
EFAULT
;

202 
out
:

203  
ªtvÆ
;

204 
	}
}

206 
asmlökage
 
	$sys32_π_siga˘i⁄
(
sig
, 
siga˘i⁄32
 
__u£r
 *
a˘
,

207 
siga˘i⁄32
 
__u£r
 *
ﬂ˘
,

208 
sig£tsize
)

210 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

211 
ªt
;

212 
com∑t_sig£t_t
 
£t32
;

215 i‡(
sig£tsize
 !(
com∑t_sig£t_t
))

216  -
EINVAL
;

218 i‡(
a˘
) {

219 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

221 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

222 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

223 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

224 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

225 
	`__c›y_‰om_u£r
(&
£t32
, &
a˘
->
ß_mask
,

226 (
com∑t_sig£t_t
)))

227  -
EFAULT
;

228 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

229 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

235 
_NSIG_WORDS
) {

236 4: 
√w_ka
.
ß
.
ß_mask
.
sig
[3] = 
£t32
.sig[6]

237 | ((()
£t32
.
sig
[7]) << 32);

238 3: 
√w_ka
.
ß
.
ß_mask
.
sig
[2] = 
£t32
.sig[4]

239 | ((()
£t32
.
sig
[5]) << 32);

240 2: 
√w_ka
.
ß
.
ß_mask
.
sig
[1] = 
£t32
.sig[2]

241 | ((()
£t32
.
sig
[3]) << 32);

242 1: 
√w_ka
.
ß
.
ß_mask
.
sig
[0] = 
£t32
.sig[0]

243 | ((()
£t32
.
sig
[1]) << 32);

247 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

249 i‡(!
ªt
 && 
ﬂ˘
) {

254 
_NSIG_WORDS
) {

256 
£t32
.
sig
[7] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[3] >> 32);

257 
£t32
.
sig
[6] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[3];

259 
£t32
.
sig
[5] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[2] >> 32);

260 
£t32
.
sig
[4] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[2];

262 
£t32
.
sig
[3] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[1] >> 32);

263 
£t32
.
sig
[2] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[1];

265 
£t32
.
sig
[1] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[0] >> 32);

266 
£t32
.
sig
[0] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[0];

268 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

269 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

270 &
ﬂ˘
->
ß_h™dÀr
) ||

271 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

272 &
ﬂ˘
->
ß_ª°‹î
) ||

273 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

274 
	`__c›y_to_u£r
(&
ﬂ˘
->
ß_mask
, &
£t32
,

275 (
com∑t_sig£t_t
)))

276  -
EFAULT
;

279  
ªt
;

280 
	}
}

282 
asmlökage
 
	$sys32_siga˘i⁄
(
sig
, 
ﬁd_siga˘i⁄32
 
__u£r
 *
a˘
,

283 
ﬁd_siga˘i⁄32
 
__u£r
 *
ﬂ˘
)

285 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

286 
ªt
;

288 i‡(
a˘
) {

289 
com∑t_ﬁd_sig£t_t
 
mask
;

290 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

292 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

293 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

294 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

295 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

296 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
))

297  -
EFAULT
;

299 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

300 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

302 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

305 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

307 i‡(!
ªt
 && 
ﬂ˘
) {

308 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

309 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

310 &
ﬂ˘
->
ß_h™dÀr
) ||

311 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

312 &
ﬂ˘
->
ß_ª°‹î
) ||

313 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

314 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask))

315  -
EFAULT
;

318  
ªt
;

319 
	}
}

321 
asmlökage
 
	$sys32_π_sig¥ocmask
(
how
, 
com∑t_sig£t_t
 
__u£r
 *
£t
,

322 
com∑t_sig£t_t
 
__u£r
 *
o£t
,

323 
sig£tsize
)

325 
sig£t_t
 
s
;

326 
com∑t_sig£t_t
 
s32
;

327 
ªt
;

328 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

330 i‡(
£t
) {

331 i‡(
	`c›y_‰om_u£r
(&
s32
, 
£t
, (
com∑t_sig£t_t
)))

332  -
EFAULT
;

333 
_NSIG_WORDS
) {

334 4: 
s
.
sig
[3] = 
s32
.sig[6] | ((()s32.sig[7]) << 32);

335 3: 
s
.
sig
[2] = 
s32
.sig[4] | ((()s32.sig[5]) << 32);

336 2: 
s
.
sig
[1] = 
s32
.sig[2] | ((()s32.sig[3]) << 32);

337 1: 
s
.
sig
[0] = 
s32
.sig[0] | ((()s32.sig[1]) << 32);

340 
	`£t_fs
(
KERNEL_DS
);

341 
ªt
 = 
	`sys_π_sig¥ocmask
(
how
,

342 
£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

343 
o£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

344 
sig£tsize
);

345 
	`£t_fs
(
ﬁd_fs
);

346 i‡(
ªt
)

347  
ªt
;

348 i‡(
o£t
) {

349 
_NSIG_WORDS
) {

350 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

351 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

352 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

353 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

355 i‡(
	`c›y_to_u£r
(
o£t
, &
s32
, (
com∑t_sig£t_t
)))

356  -
EFAULT
;

359 
	}
}

361 
asmlökage
 
	$sys32_Æ¨m
(
£c⁄ds
)

363  
	`Æ¨m_£tôimî
(
£c⁄ds
);

364 
	}
}

366 
	s£l_¨g_°ru˘
 {

367 
	mn
;

368 
	möp
;

369 
	mouç
;

370 
	mexp
;

371 
	mtvp
;

374 
asmlökage
 
	$sys32_ﬁd_£À˘
(
£l_¨g_°ru˘
 
__u£r
 *
¨g
)

376 
£l_¨g_°ru˘
 
a
;

378 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

379  -
EFAULT
;

380  
	`com∑t_sys_£À˘
(
a
.
n
, 
	`com∑t_±r
◊.
öp
), com∑t_±r◊.
ouç
),

381 
	`com∑t_±r
(
a
.
exp
), com∑t_±r◊.
tvp
));

382 
	}
}

384 
asmlökage
 
	$sys32_waôpid
(
com∑t_pid_t
 
pid
, *
°©_addr
,

385 
›ti⁄s
)

387  
	`com∑t_sys_waô4
(
pid
, 
°©_addr
, 
›ti⁄s
, 
NULL
);

388 
	}
}

392 
asmlökage
 
	$sys32_sysfs
(
›ti⁄
, 
u32
 
¨g1
, u32 
¨g2
)

394  
	`sys_sysfs
(
›ti⁄
, 
¨g1
, 
¨g2
);

395 
	}
}

397 
asmlökage
 
	$sys32_sched_º_gë_öãrvÆ
(
com∑t_pid_t
 
pid
,

398 
com∑t_time•ec
 
__u£r
 *
öãrvÆ
)

400 
time•ec
 
t
;

401 
ªt
;

402 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

404 
	`£t_fs
(
KERNEL_DS
);

405 
ªt
 = 
	`sys_sched_º_gë_öãrvÆ
(
pid
, (
time•ec
 
__u£r
 *)&
t
);

406 
	`£t_fs
(
ﬁd_fs
);

407 i‡(
	`put_com∑t_time•ec
(&
t
, 
öãrvÆ
))

408  -
EFAULT
;

409  
ªt
;

410 
	}
}

412 
asmlökage
 
	$sys32_π_sig≥ndög
(
com∑t_sig£t_t
 
__u£r
 *
£t
,

413 
com∑t_size_t
 
sig£tsize
)

415 
sig£t_t
 
s
;

416 
com∑t_sig£t_t
 
s32
;

417 
ªt
;

418 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

420 
	`£t_fs
(
KERNEL_DS
);

421 
ªt
 = 
	`sys_π_sig≥ndög
((
sig£t_t
 
__u£r
 *)&
s
, 
sig£tsize
);

422 
	`£t_fs
(
ﬁd_fs
);

423 i‡(!
ªt
) {

424 
_NSIG_WORDS
) {

425 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

426 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

427 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

428 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

430 i‡(
	`c›y_to_u£r
(
£t
, &
s32
, (
com∑t_sig£t_t
)))

431  -
EFAULT
;

433  
ªt
;

434 
	}
}

436 
asmlökage
 
	$sys32_π_sigqueueöfo
(
pid
, 
sig
,

437 
com∑t_sigöfo_t
 
__u£r
 *
uöfo
)

439 
sigöfo_t
 
öfo
;

440 
ªt
;

441 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

443 i‡(
	`c›y_sigöfo_‰om_u£r32
(&
öfo
, 
uöfo
))

444  -
EFAULT
;

445 
	`£t_fs
(
KERNEL_DS
);

446 
ªt
 = 
	`sys_π_sigqueueöfo
(
pid
, 
sig
, (
sigöfo_t
 
__u£r
 *)&
öfo
);

447 
	`£t_fs
(
ﬁd_fs
);

448  
ªt
;

449 
	}
}

451 #ifde‡
CONFIG_SYSCTL_SYSCALL


452 
	ssys˘l_ü32
 {

453 
	m«me
;

454 
	m∆í
;

455 
	mﬁdvÆ
;

456 
	mﬁdÀ≈
;

457 
	m√wvÆ
;

458 
	m√wÀn
;

459 
	m__unu£d
[4];

463 
asmlökage
 
	$sys32_sys˘l
(
sys˘l_ü32
 
__u£r
 *
¨gs32
)

465 
sys˘l_ü32
 
a32
;

466 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

467 
__u£r
 *
ﬁdvÆp
, *
√wvÆp
;

468 
size_t
 
ﬁdÀn
;

469 
__u£r
 *
«mï
;

470 
ªt
;

472 i‡(
	`c›y_‰om_u£r
(&
a32
, 
¨gs32
, (a32)))

473  -
EFAULT
;

483 
«mï
 = 
	`com∑t_±r
(
a32
.
«me
);

484 
ﬁdvÆp
 = 
	`com∑t_±r
(
a32
.
ﬁdvÆ
);

485 
√wvÆp
 = 
	`com∑t_±r
(
a32
.
√wvÆ
);

487 i‡((
ﬁdvÆp
 && 
	`gë_u£r
(
ﬁdÀn
, (
__u£r
 *)
	`com∑t_±r
(
a32
.
ﬁdÀ≈
)))

488 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«mï
, 0)

489 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬁdvÆp
, 0)

490 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
√wvÆp
, 0))

491  -
EFAULT
;

493 
	`£t_fs
(
KERNEL_DS
);

494 
	`lock_kî√l
();

495 
ªt
 = 
	`do_sys˘l
(
«mï
, 
a32
.
∆í
, 
ﬁdvÆp
, (
size_t
 
__u£r
 *)&
ﬁdÀn
,

496 
√wvÆp
, (
size_t
Ë
a32
.
√wÀn
);

497 
	`u∆ock_kî√l
();

498 
	`£t_fs
(
ﬁd_fs
);

500 i‡(
ﬁdvÆp
 && 
	`put_u£r
(
ﬁdÀn
, (
__u£r
 *)
	`com∑t_±r
(
a32
.
ﬁdÀ≈
)))

501  -
EFAULT
;

503  
ªt
;

504 
	}
}

508 
asmlökage
 
	$sys32_¥ód
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

509 
u32
 
po¶o
, u32 
poshi
)

511  
	`sys_¥ód64
(
fd
, 
ubuf
, 
cou¡
,

512 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

513 
	}
}

515 
asmlökage
 
	$sys32_pwrôe
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

516 
u32
 
po¶o
, u32 
poshi
)

518  
	`sys_pwrôe64
(
fd
, 
ubuf
, 
cou¡
,

519 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

520 
	}
}

523 
asmlökage
 
	$sys32_≥rs⁄Æôy
(
≥rs⁄Æôy
)

525 
ªt
;

527 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
 &&

528 
≥rs⁄Æôy
 =
PER_LINUX
)

529 
≥rs⁄Æôy
 = 
PER_LINUX32
;

530 
ªt
 = 
	`sys_≥rs⁄Æôy
(
≥rs⁄Æôy
);

531 i‡(
ªt
 =
PER_LINUX32
)

532 
ªt
 = 
PER_LINUX
;

533  
ªt
;

534 
	}
}

536 
asmlökage
 
	$sys32_£ndfûe
(
out_fd
, 
ö_fd
,

537 
com∑t_off_t
 
__u£r
 *
off£t
, 
s32
 
cou¡
)

539 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

540 
ªt
;

541 
off_t
 
of
;

543 i‡(
off£t
 && 
	`gë_u£r
(
of
, offset))

544  -
EFAULT
;

546 
	`£t_fs
(
KERNEL_DS
);

547 
ªt
 = 
	`sys_£ndfûe
(
out_fd
, 
ö_fd
, 
off£t
 ? (
off_t
 
__u£r
 *)&
of
 : 
NULL
,

548 
cou¡
);

549 
	`£t_fs
(
ﬁd_fs
);

551 i‡(
off£t
 && 
	`put_u£r
(
of
, offset))

552  -
EFAULT
;

553  
ªt
;

554 
	}
}

556 
asmlökage
 
	$sys32_mm≠2
(
addr
, 
Àn
,

557 
¥Ÿ
, 
Êags
,

558 
fd
, 
pgoff
)

560 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

561 
îr‹
;

562 
fûe
 *fûê
NULL
;

564 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

565 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

566 
fûe
 = 
	`fgë
(
fd
);

567 i‡(!
fûe
)

568  -
EBADF
;

571 
	`down_wrôe
(&
mm
->
mm≠_£m
);

572 
îr‹
 = 
	`do_mm≠_pgoff
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
pgoff
);

573 
	`up_wrôe
(&
mm
->
mm≠_£m
);

575 i‡(
fûe
)

576 
	`Âut
(
fûe
);

577  
îr‹
;

578 
	}
}

580 
asmlökage
 
	$sys32_ﬁdu«me
(
ﬁdﬁd_ut¢ame
 
__u£r
 *
«me
)

582 *
¨ch
 = "x86_64";

583 
îr
;

585 i‡(!
«me
)

586  -
EFAULT
;

587 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«me
, (
ﬁdﬁd_ut¢ame
)))

588  -
EFAULT
;

590 
	`down_ªad
(&
uts_£m
);

592 
îr
 = 
	`__c›y_to_u£r
(&
«me
->
sy¢ame
, &
	`ut¢ame
()->sysname,

593 
__OLD_UTS_LEN
);

594 
îr
 |
	`__put_u£r
(0, 
«me
->
sy¢ame
+
__OLD_UTS_LEN
);

595 
îr
 |
	`__c›y_to_u£r
(&
«me
->
nodíame
, &
	`ut¢ame
()->nodename,

596 
__OLD_UTS_LEN
);

597 
îr
 |
	`__put_u£r
(0, 
«me
->
nodíame
+
__OLD_UTS_LEN
);

598 
îr
 |
	`__c›y_to_u£r
(&
«me
->
ªÀa£
, &
	`ut¢ame
()->release,

599 
__OLD_UTS_LEN
);

600 
îr
 |
	`__put_u£r
(0, 
«me
->
ªÀa£
+
__OLD_UTS_LEN
);

601 
îr
 |
	`__c›y_to_u£r
(&
«me
->
vîsi⁄
, &
	`ut¢ame
()->version,

602 
__OLD_UTS_LEN
);

603 
îr
 |
	`__put_u£r
(0, 
«me
->
vîsi⁄
+
__OLD_UTS_LEN
);

605 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

606 
¨ch
 = "i686";

608 
îr
 |
	`__c›y_to_u£r
(&
«me
->
machöe
, 
¨ch
, 
	`°æí
(arch) + 1);

610 
	`up_ªad
(&
uts_£m
);

612 
îr
 =Éº ? -
EFAULT
 : 0;

614  
îr
;

615 
	}
}

617 
	$sys32_u«me
(
ﬁd_ut¢ame
 
__u£r
 *
«me
)

619 
îr
;

621 i‡(!
«me
)

622  -
EFAULT
;

623 
	`down_ªad
(&
uts_£m
);

624 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

625 
	`up_ªad
(&
uts_£m
);

626 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

627 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

629  
îr
 ? -
EFAULT
 : 0;

630 
	}
}

632 
asmlökage
 
	$sys32_execve
(
__u£r
 *
«me
, 
com∑t_u±r_t
 __u£∏*
¨gv
,

633 
com∑t_u±r_t
 
__u£r
 *
ívp
, 
±_ªgs
 *
ªgs
)

635 
îr‹
;

636 *
fûíame
;

638 
fûíame
 = 
	`gë«me
(
«me
);

639 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

640 i‡(
	`IS_ERR
(
fûíame
))

641  
îr‹
;

642 
îr‹
 = 
	`com∑t_do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

643 
	`puäame
(
fûíame
);

644  
îr‹
;

645 
	}
}

647 
asmlökage
 
	$sys32_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

648 
±_ªgs
 *
ªgs
)

650 
__u£r
 *
∑ª¡_tid
 = (__u£∏*)
ªgs
->
dx
;

651 
__u£r
 *
chûd_tid
 = (__u£∏*)
ªgs
->
di
;

653 i‡(!
√w•
)

654 
√w•
 = 
ªgs
->
•
;

655  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

656 
	}
}

662 
	$sys32_l£ek
(
fd
, 
off£t
, 
whí˚
)

664  
	`sys_l£ek
(
fd
, 
off£t
, 
whí˚
);

665 
	}
}

667 
	$sys32_kûl
(
pid
, 
sig
)

669  
	`sys_kûl
(
pid
, 
sig
);

670 
	}
}

672 
	$sys32_Ádvi£64_64
(
fd
, 
__u32
 
off£t_low
, __u32 
off£t_high
,

673 
__u32
 
Àn_low
, __u32 
Àn_high
, 
advi˚
)

675  
	`sys_Ádvi£64_64
(
fd
,

676 (((
u64
)
off£t_high
)<<32Ë| 
off£t_low
,

677 (((
u64
)
Àn_high
)<<32Ë| 
Àn_low
,

678 
advi˚
);

679 
	}
}

681 
	$sys32_vm86_w¨nög
()

683 
èsk_°ru˘
 *
me
 = 
cuºít
;

684 
œ°comm
[(
me
->
comm
)];

686 i‡(
	`°∫cmp
(
œ°comm
, 
me
->
comm
, (lastcomm))) {

687 
	`com∑t_¥ötk
(
KERN_INFO


689 
me
->
comm
);

690 
	`°∫˝y
(
œ°comm
, 
me
->
comm
, (lastcomm));

692  -
ENOSYS
;

693 
	}
}

695 
	$sys32_lookup_dcookõ
(
u32
 
addr_low
, u32 
addr_high
,

696 
__u£r
 *
buf
, 
size_t
 
Àn
)

698  
	`sys_lookup_dcookõ
(((
u64
)
addr_high
 << 32Ë| 
addr_low
, 
buf
, 
Àn
);

699 
	}
}

701 
asmlökage
 
ssize_t
 
	$sys32_ªadahód
(
fd
, 
off_lo
, 
off_hi
,

702 
size_t
 
cou¡
)

704  
	`sys_ªadahód
(
fd
, ((
u64
)
off_hi
 << 32Ë| 
off_lo
, 
cou¡
);

705 
	}
}

707 
asmlökage
 
	$sys32_sync_fûe_ønge
(
fd
, 
off_low
, 
off_hi
,

708 
n_low
, 
n_hi
, 
Êags
)

710  
	`sys_sync_fûe_ønge
(
fd
,

711 ((
u64
)
off_hi
 << 32Ë| 
off_low
,

712 ((
u64
)
n_hi
 << 32Ë| 
n_low
, 
Êags
);

713 
	}
}

715 
asmlökage
 
	$sys32_Ádvi£64
(
fd
, 
off£t_lo
, 
off£t_hi
,

716 
size_t
 
Àn
, 
advi˚
)

718  
	`sys_Ádvi£64_64
(
fd
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

719 
Àn
, 
advi˚
);

720 
	}
}

722 
asmlökage
 
	$sys32_ÁŒoˇã
(
fd
, 
mode
, 
off£t_lo
,

723 
off£t_hi
, 
Àn_lo
,

724 
Àn_hi
)

726  
	`sys_ÁŒoˇã
(
fd
, 
mode
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

727 ((
u64
)
Àn_hi
 << 32Ë| 
Àn_lo
);

728 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<löux/öô.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/a˝i_pmtmr.h
>

29 
	~<löux/efi.h
>

30 
	~<löux/˝umask.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/dmi.h
>

33 
	~<löux/úq.h
>

34 
	~<löux/boŸmem.h
>

35 
	~<löux/i›‹t.h
>

36 
	~<löux/pci.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/io_≠ic.h
>

40 
	~<asm/≠ic.h
>

41 
	~<asm/io.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/smp.h
>

45 
__öôd©a
 
	ga˝i_f‹˚
 = 0;

46 
u32
 
	ga˝i_rsdt_f‹˚d
;

47 
	ga˝i_dißbÀd
;

48 
EXPORT_SYMBOL
(
a˝i_dißbÀd
);

50 #ifdef 
CONFIG_X86_64


51 
	~<asm/¥Ÿo.h
>

54 
	#BAD_MADT_ENTRY
(
íåy
, 
íd
) ( \

55 (!
íåy
Ë|| (Î¡ry + (*íåyË> 
íd
 || \

56 ((
a˝i_subèbÀ_hódî
 *)
íåy
)->
Àngth
 < (*íåy))

	)

58 
	#PREFIX
 "ACPI: "

	)

60 
	ga˝i_noúq
;

61 
	ga˝i_pci_dißbÀd
;

62 
EXPORT_SYMBOL
(
a˝i_pci_dißbÀd
);

63 
a˝i_ht
 
	g__öôd©a
 = 1;

65 
	ga˝i_œpic
;

66 
	ga˝i_iﬂpic
;

67 
	ga˝i_°ri˘
;

69 
u8
 
a˝i_sci_Êags
 
	g__öôd©a
;

70 
a˝i_sci_ovîride_gsi
 
	g__öôd©a
;

71 
a˝i_skù_timî_ovîride
 
	g__öôd©a
;

72 
a˝i_u£_timî_ovîride
 
	g__öôd©a
;

74 #ifde‡
CONFIG_X86_LOCAL_APIC


75 
u64
 
a˝i_œpic_addr
 
	g__öôd©a
 = 
APIC_DEFAULT_PHYS_BASE
;

78 #i‚de‡
__HAVE_ARCH_CMPXCHG


79 #w¨nög 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
™d
 
œãr
 
h¨dw¨e


90 
a˝i_úq_modñ_id
 
	ga˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_PIC
;

105 *
__öô
 
	$__a˝i_m≠_èbÀ
(
phys
, 
size
)

108 i‡(!
phys
 || !
size
)

109  
NULL
;

111  
	`óæy_i‹em≠
(
phys
, 
size
);

112 
	}
}

113 
__öô
 
	$__a˝i_unm≠_èbÀ
(*
m≠
, 
size
)

115 i‡(!
m≠
 || !
size
)

118 
	`óæy_iounm≠
(
m≠
, 
size
);

119 
	}
}

121 #ifde‡
CONFIG_X86_LOCAL_APIC


122 
__öô
 
	$a˝i_∑r£_madt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

124 
a˝i_èbÀ_madt
 *
madt
 = 
NULL
;

126 i‡(!
˝u_has_≠ic
)

127  -
EINVAL
;

129 
madt
 = (
a˝i_èbÀ_madt
 *)
èbÀ
;

130 i‡(!
madt
) {

131 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map MADT\n");

132  -
ENODEV
;

135 i‡(
madt
->
addªss
) {

136 
a˝i_œpic_addr
 = (
u64
Ë
madt
->
addªss
;

138 
	`¥ötk
(
KERN_DEBUG
 
PREFIX
 "Local APICáddress 0x%08x\n",

139 
madt
->
addªss
);

142 
	`deÁu…_a˝i_madt_€m_check
(
madt
->
hódî
.
€m_id
,

143 
madt
->
hódî
.
€m_èbÀ_id
);

146 
	}
}

148 
__˝uöô
 
	$a˝i_ªgi°î_œpic
(
id
, 
u8
 
íabÀd
)

150 
vî
 = 0;

152 i‡(!
íabÀd
) {

153 ++
dißbÀd_˝us
;

157 i‡(
boŸ_˝u_physiˇl_≠icid
 != -1U)

158 
vî
 = 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
];

160 
	`gíîic_¥o˚ss‹_öfo
(
id
, 
vî
);

161 
	}
}

163 
__öô


164 
	$a˝i_∑r£_x2≠ic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

166 
a˝i_madt_loˇl_x2≠ic
 *
¥o˚ss‹
 = 
NULL
;

168 
¥o˚ss‹
 = (
a˝i_madt_loˇl_x2≠ic
 *)
hódî
;

170 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

171  -
EINVAL
;

173 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

175 #ifde‡
CONFIG_X86_X2APIC


183 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
loˇl_≠ic_id
,

184 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

186 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "x2apicÉntry ignored\n");

190 
	}
}

192 
__öô


193 
	$a˝i_∑r£_œpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

195 
a˝i_madt_loˇl_≠ic
 *
¥o˚ss‹
 = 
NULL
;

197 
¥o˚ss‹
 = (
a˝i_madt_loˇl_≠ic
 *)
hódî
;

199 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

200  -
EINVAL
;

202 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

211 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
id
,

212 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

215 
	}
}

217 
__öô


218 
	$a˝i_∑r£_ßpic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

220 
a˝i_madt_loˇl_ßpic
 *
¥o˚ss‹
 = 
NULL
;

222 
¥o˚ss‹
 = (
a˝i_madt_loˇl_ßpic
 *)
hódî
;

224 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

225  -
EINVAL
;

227 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

229 
	`a˝i_ªgi°î_œpic
((
¥o˚ss‹
->
id
 << 8Ë|Öro˚ss‹->
eid
,

230 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

233 
	}
}

235 
__öô


236 
	$a˝i_∑r£_œpic_addr_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

237 c⁄° 
íd
)

239 
a˝i_madt_loˇl_≠ic_ovîride
 *
œpic_addr_ovr
 = 
NULL
;

241 
œpic_addr_ovr
 = (
a˝i_madt_loˇl_≠ic_ovîride
 *)
hódî
;

243 i‡(
	`BAD_MADT_ENTRY
(
œpic_addr_ovr
, 
íd
))

244  -
EINVAL
;

246 
a˝i_œpic_addr
 = 
œpic_addr_ovr
->
addªss
;

249 
	}
}

251 
__öô


252 
	$a˝i_∑r£_x2≠ic_nmi
(
a˝i_subèbÀ_hódî
 *
hódî
,

253 c⁄° 
íd
)

255 
a˝i_madt_loˇl_x2≠ic_nmi
 *
x2≠ic_nmi
 = 
NULL
;

257 
x2≠ic_nmi
 = (
a˝i_madt_loˇl_x2≠ic_nmi
 *)
hódî
;

259 i‡(
	`BAD_MADT_ENTRY
(
x2≠ic_nmi
, 
íd
))

260  -
EINVAL
;

262 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

264 i‡(
x2≠ic_nmi
->
löt
 != 1)

265 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

268 
	}
}

270 
__öô


271 
	$a˝i_∑r£_œpic_nmi
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

273 
a˝i_madt_loˇl_≠ic_nmi
 *
œpic_nmi
 = 
NULL
;

275 
œpic_nmi
 = (
a˝i_madt_loˇl_≠ic_nmi
 *)
hódî
;

277 i‡(
	`BAD_MADT_ENTRY
(
œpic_nmi
, 
íd
))

278  -
EINVAL
;

280 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

282 i‡(
œpic_nmi
->
löt
 != 1)

283 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

286 
	}
}

290 #ifde‡
CONFIG_X86_IO_APIC


292 
__öô


293 
	$a˝i_∑r£_iﬂpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

295 
a˝i_madt_io_≠ic
 *
iﬂpic
 = 
NULL
;

297 
iﬂpic
 = (
a˝i_madt_io_≠ic
 *)
hódî
;

299 i‡(
	`BAD_MADT_ENTRY
(
iﬂpic
, 
íd
))

300  -
EINVAL
;

302 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

304 
	`mp_ªgi°î_iﬂpic
(
iﬂpic
->
id
,

305 
iﬂpic
->
addªss
, iﬂpic->
globÆ_úq_ba£
);

308 
	}
}

313 
__öô
 
	$a˝i_sci_iﬂpic_£tup
(
u32
 
gsi
, 
u16
 
pﬁ¨ôy
, u16 
åiggî
)

315 i‡(
åiggî
 == 0)

316 
åiggî
 = 3;

318 i‡(
pﬁ¨ôy
 == 0)

319 
pﬁ¨ôy
 = 3;

322 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
)

323 
åiggî
 = (
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

325 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
)

326 
pﬁ¨ôy
 = 
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
;

333 
	`mp_ovîride_Àgacy_úq
(
gsi
, 
pﬁ¨ôy
, 
åiggî
, gsi);

339 
a˝i_sci_ovîride_gsi
 = 
gsi
;

341 
	}
}

343 
__öô


344 
	$a˝i_∑r£_öt_§c_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

345 c⁄° 
íd
)

347 
a˝i_madt_öãºu±_ovîride
 *
öt§c
 = 
NULL
;

349 
öt§c
 = (
a˝i_madt_öãºu±_ovîride
 *)
hódî
;

351 i‡(
	`BAD_MADT_ENTRY
(
öt§c
, 
íd
))

352  -
EINVAL
;

354 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

356 i‡(
öt§c
->
sour˚_úq
 =
a˝i_gbl_FADT
.
sci_öãºu±
) {

357 
	`a˝i_sci_iﬂpic_£tup
(
öt§c
->
globÆ_úq
,

358 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

359 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

363 i‡(
a˝i_skù_timî_ovîride
 &&

364 
öt§c
->
sour˚_úq
 =0 && i¡§c->
globÆ_úq
 == 2) {

365 
	`¥ötk
(
PREFIX
 "BIOS IRQ0Öin2 override ignored.\n");

369 
	`mp_ovîride_Àgacy_úq
(
öt§c
->
sour˚_úq
,

370 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

371 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

372 
öt§c
->
globÆ_úq
);

375 
	}
}

377 
__öô


378 
	$a˝i_∑r£_nmi_§c
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

380 
a˝i_madt_nmi_sour˚
 *
nmi_§c
 = 
NULL
;

382 
nmi_§c
 = (
a˝i_madt_nmi_sour˚
 *)
hódî
;

384 i‡(
	`BAD_MADT_ENTRY
(
nmi_§c
, 
íd
))

385  -
EINVAL
;

387 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

392 
	}
}

410 
__öô
 
	$a˝i_pic_sci_£t_åiggî
(
úq
, 
u16
 
åiggî
)

412 
mask
 = 1 << 
úq
;

413 
ﬁd
, 
√w
;

416 
ﬁd
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

423 
√w
 = 
a˝i_noúq
 ? 
ﬁd
 : 0;

429 
åiggî
) {

431 
√w
 &~
mask
;

434 
√w
 |
mask
;

438 i‡(
ﬁd
 =
√w
)

441 
	`¥ötk
(
PREFIX
 "£âög ELCRÅÿ%04x (‰om %04x)\n", 
√w
, 
ﬁd
);

442 
	`outb
(
√w
, 0x4d0);

443 
	`outb
(
√w
 >> 8, 0x4d1);

444 
	}
}

446 
	$a˝i_gsi_to_úq
(
u32
 
gsi
, *
úq
)

448 *
úq
 = 
gsi
;

450 
	}
}

456 
	$a˝i_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

458 
úq
;

459 
∂©_gsi
 = 
gsi
;

461 #ifde‡
CONFIG_PCI


465 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_PIC
) {

466 i‡(
åiggî
 =
ACPI_LEVEL_SENSITIVE
)

467 
	`eiß_£t_Àvñ_úq
(
gsi
);

471 #ifde‡
CONFIG_X86_IO_APIC


472 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
) {

473 
∂©_gsi
 = 
	`mp_ªgi°î_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

476 
	`a˝i_gsi_to_úq
(
∂©_gsi
, &
úq
);

477  
úq
;

478 
	}
}

483 #ifde‡
CONFIG_ACPI_HOTPLUG_CPU


485 
__˝uöô
 
	$_a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

487 
a˝i_buf„r
 
buf„r
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

488 
a˝i_obje˘
 *
obj
;

489 
a˝i_madt_loˇl_≠ic
 *
œpic
;

490 
˝umask_v¨_t
 
tmp_m≠
, 
√w_m≠
;

491 
u8
 
physid
;

492 
˝u
;

493 
ªtvÆ
 = -
ENOMEM
;

495 i‡(
	`ACPI_FAILURE
(
	`a˝i_evÆu©e_obje˘
(
h™dÀ
, "_MAT", 
NULL
, &
buf„r
)))

496  -
EINVAL
;

498 i‡(!
buf„r
.
Àngth
 || !buf„r.
poöãr
)

499  -
EINVAL
;

501 
obj
 = 
buf„r
.
poöãr
;

502 i‡(
obj
->
ty≥
 !
ACPI_TYPE_BUFFER
 ||

503 
obj
->
buf„r
.
Àngth
 < (*
œpic
)) {

504 
	`k‰ì
(
buf„r
.
poöãr
);

505  -
EINVAL
;

508 
œpic
 = (
a˝i_madt_loˇl_≠ic
 *)
obj
->
buf„r
.
poöãr
;

510 i‡(
œpic
->
hódî
.
ty≥
 !
ACPI_MADT_TYPE_LOCAL_APIC
 ||

511 !(
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
)) {

512 
	`k‰ì
(
buf„r
.
poöãr
);

513  -
EINVAL
;

516 
physid
 = 
œpic
->
id
;

518 
	`k‰ì
(
buf„r
.
poöãr
);

519 
buf„r
.
Àngth
 = 
ACPI_ALLOCATE_BUFFER
;

520 
buf„r
.
poöãr
 = 
NULL
;

522 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_m≠
, 
GFP_KERNEL
))

523 
out
;

525 i‡(!
	`Æloc_˝umask_v¨
(&
√w_m≠
, 
GFP_KERNEL
))

526 
‰ì_tmp_m≠
;

528 
	`˝umask_c›y
(
tmp_m≠
, 
˝u_¥e£¡_mask
);

529 
	`a˝i_ªgi°î_œpic
(
physid
, 
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

535 
	`˝umask_™dnŸ
(
√w_m≠
, 
˝u_¥e£¡_mask
, 
tmp_m≠
);

536 i‡(
	`˝umask_em±y
(
√w_m≠
)) {

537 
	`¥ötk
 ("UnableÅo mapÜapicÅoÜogical cpuÇumber\n");

538 
ªtvÆ
 = -
EINVAL
;

539 
‰ì_√w_m≠
;

542 
˝u
 = 
	`˝umask_fú°
(
√w_m≠
);

544 *
p˝u
 = 
˝u
;

545 
ªtvÆ
 = 0;

547 
‰ì_√w_m≠
:

548 
	`‰ì_˝umask_v¨
(
√w_m≠
);

549 
‰ì_tmp_m≠
:

550 
	`‰ì_˝umask_v¨
(
tmp_m≠
);

551 
out
:

552  
ªtvÆ
;

553 
	}
}

556 
__ªf
 
	$a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

558  
	`_a˝i_m≠_lßpic
(
h™dÀ
, 
p˝u
);

559 
	}
}

560 
EXPORT_SYMBOL
(
a˝i_m≠_lßpic
);

562 
	$a˝i_unm≠_lßpic
(
˝u
)

564 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) = -1;

565 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

566 
num_¥o˚ss‹s
--;

569 
	}
}

571 
EXPORT_SYMBOL
(
a˝i_unm≠_lßpic
);

574 
	$a˝i_ªgi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

577  -
EINVAL
;

578 
	}
}

580 
EXPORT_SYMBOL
(
a˝i_ªgi°î_iﬂpic
);

582 
	$a˝i_uƒegi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u32
 
gsi_ba£
)

585  -
EINVAL
;

586 
	}
}

588 
EXPORT_SYMBOL
(
a˝i_uƒegi°î_iﬂpic
);

590 
__öô
 
	$a˝i_∑r£_sbf
(
a˝i_èbÀ_hódî
 *
èbÀ
)

592 
a˝i_èbÀ_boŸ
 *
sb
;

594 
sb
 = (
a˝i_èbÀ_boŸ
 *)
èbÀ
;

595 i‡(!
sb
) {

596 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map SBF\n");

597  -
ENODEV
;

600 
sbf_p‹t
 = 
sb
->
cmos_ödex
;

603 
	}
}

605 #ifde‡
CONFIG_HPET_TIMER


606 
	~<asm/h≥t.h
>

608 
__öôd©a
 
ªsour˚
 *
	gh≥t_ªs
;

610 
__öô
 
	$a˝i_∑r£_h≥t
(
a˝i_èbÀ_hódî
 *
èbÀ
)

612 
a˝i_èbÀ_h≥t
 *
h≥t_tbl
;

614 
h≥t_tbl
 = (
a˝i_èbÀ_h≥t
 *)
èbÀ
;

615 i‡(!
h≥t_tbl
) {

616 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map HPET\n");

617  -
ENODEV
;

620 i‡(
h≥t_tbl
->
addªss
.
•a˚_id
 !
ACPI_SPACE_MEM
) {

621 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPETÅimers must beÜocated in "

626 
h≥t_addªss
 = 
h≥t_tbl
->
addªss
.address;

632 i‡(!
h≥t_addªss
) {

633 
	`¥ötk
(
KERN_WARNING
 
PREFIX


635 
h≥t_tbl
->
id
, 
h≥t_addªss
);

638 #ifde‡
CONFIG_X86_64


644 i‡(
h≥t_addªss
 == 0xfed0000000000000UL) {

645 i‡(!
h≥t_f‹˚_u£r
) {

646 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

649 "fix iàu∞tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

650 
h≥t_addªss
 = 0;

653 
	`¥ötk
(
KERN_WARNING
 
PREFIX


655 "tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

656 
h≥t_addªss
 >>= 32;

659 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

660 
h≥t_tbl
->
id
, 
h≥t_addªss
);

666 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

667 
h≥t_ªs
 = 
	`Æloc_boŸmem
((*h≥t_ªsË+ 
HPET_RESOURCE_NAME_SIZE
);

669 
h≥t_ªs
->
«me
 = (*)&hpet_res[1];

670 
h≥t_ªs
->
Êags
 = 
IORESOURCE_MEM
;

671 
	`¢¥ötf
((*)
h≥t_ªs
->
«me
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

672 
h≥t_tbl
->
£quí˚
);

674 
h≥t_ªs
->
°¨t
 = 
h≥t_addªss
;

675 
h≥t_ªs
->
íd
 = 
h≥t_addªss
 + (1 * 1024) - 1;

678 
	}
}

684 
__öô
 
	$h≥t_ö£π_ªsour˚
()

686 i‡(!
h≥t_ªs
)

689  
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
h≥t_ªs
);

690 
	}
}

692 
œã_öôˇŒ
(
h≥t_ö£π_ªsour˚
);

695 
	#a˝i_∑r£_h≥t
 
NULL


	)

698 
__öô
 
	$a˝i_∑r£_Ádt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

701 #ifde‡
CONFIG_X86_PM_TIMER


703 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
) {

705 i‡(
a˝i_gbl_FADT
.
xpm_timî_block
.
•a˚_id
 !=

706 
ACPI_ADR_SPACE_SYSTEM_IO
)

709 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
xpm_timî_block
.
addªss
;

715 i‡(!
pmtmr_i›‹t
)

716 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

719 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

721 i‡(
pmtmr_i›‹t
)

722 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

723 
pmtmr_i›‹t
);

726 
	}
}

728 #ifdef 
CONFIG_X86_LOCAL_APIC


734 
__öô
 
	$a˝i_ªgi°î_œpic_addªss
(
addªss
)

736 
mp_œpic_addr
 = 
addªss
;

738 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
addªss
);

739 i‡(
boŸ_˝u_physiˇl_≠icid
 == -1U) {

740 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

741 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
] =

742 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

744 
	}
}

746 
__öô
 
	$óæy_a˝i_∑r£_madt_œpic_addr_ovr
()

748 
cou¡
;

750 i‡(!
˝u_has_≠ic
)

751  -
ENODEV
;

758 
cou¡
 =

759 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

760 
a˝i_∑r£_œpic_addr_ovr
, 0);

761 i‡(
cou¡
 < 0) {

762 
	`¥ötk
(
KERN_ERR
 
PREFIX


764  
cou¡
;

767 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

769  
cou¡
;

770 
	}
}

772 
__öô
 
	$a˝i_∑r£_madt_œpic_íåõs
()

774 
cou¡
;

775 
x2cou¡
 = 0;

777 i‡(!
˝u_has_≠ic
)

778  -
ENODEV
;

785 
cou¡
 =

786 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

787 
a˝i_∑r£_œpic_addr_ovr
, 0);

788 i‡(
cou¡
 < 0) {

789 
	`¥ötk
(
KERN_ERR
 
PREFIX


791  
cou¡
;

794 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

796 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

797 
a˝i_∑r£_ßpic
, 
MAX_APICS
);

799 i‡(!
cou¡
) {

800 
x2cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

801 
a˝i_∑r£_x2≠ic
, 
MAX_APICS
);

802 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

803 
a˝i_∑r£_œpic
, 
MAX_APICS
);

805 i‡(!
cou¡
 && !
x2cou¡
) {

806 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No LAPICÉntriesÖresent\n");

808  -
ENODEV
;

809 } i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

810 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPICÉntry\n");

812  
cou¡
;

815 
x2cou¡
 =

816 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

817 
a˝i_∑r£_x2≠ic_nmi
, 0);

818 
cou¡
 =

819 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
a˝i_∑r£_œpic_nmi
, 0);

820 i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

821 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPIC NMIÉntry\n");

823  
cou¡
;

826 
	}
}

829 #ifdef 
CONFIG_X86_IO_APIC


830 
	#MP_ISA_BUS
 0

	)

832 #ifde‡
CONFIG_X86_ES7000


833 
es7000_∂©
;

837 
	mgsi_ba£
;

838 
	mgsi_íd
;

839 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

841 
	$mp_föd_iﬂpic
(
gsi
)

843 
i
 = 0;

846 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

847 i‡((
gsi
 >
mp_iﬂpic_routög
[
i
].
gsi_ba£
)

848 && (
gsi
 <
mp_iﬂpic_routög
[
i
].
gsi_íd
))

849  
i
;

852 
	`¥ötk
(
KERN_ERR
 "ERROR: U«bÀÅÿloˇã IOAPIC f‹ GSI %d\n", 
gsi
);

854 
	}
}

856 
	$mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
)

858 i‡(
	`WARN_ON
(
iﬂpic
 == -1))

860 i‡(
	`WARN_ON
(
gsi
 > 
mp_iﬂpic_routög
[
iﬂpic
].
gsi_íd
))

863  
gsi
 - 
mp_iﬂpic_routög
[
iﬂpic
].
gsi_ba£
;

864 
	}
}

866 
u8
 
__öô
 
	$uniq_iﬂpic_id
(
u8
 
id
)

868 #ifde‡
CONFIG_X86_32


869 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

870 !
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

871  
	`io_≠ic_gë_unique_id
(
ƒ_iﬂpics
, 
id
);

873  
id
;

875 
i
;

876 
	`DECLARE_BITMAP
(
u£d
, 256);

877 
	`bôm≠_zîo
(
u£d
, 256);

878 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

879 
mpc_iﬂpic
 *
ü
 = &
mp_iﬂpics
[
i
];

880 
	`__£t_bô
(
ü
->
≠icid
, 
u£d
);

882 i‡(!
	`ã°_bô
(
id
, 
u£d
))

883  
id
;

884  
	`föd_fú°_zîo_bô
(
u£d
, 256);

886 
	}
}

888 
	$bad_iﬂpic
(
addªss
)

890 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

891 
	`¥ötk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)Éxceeded "

892 "(found %d)\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

893 
	`∑nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

895 i‡(!
addªss
) {

896 
	`¥ötk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APICáddress"

901 
	}
}

903 
__öô
 
	$mp_ªgi°î_iﬂpic
(
id
, 
u32
 
addªss
, u32 
gsi_ba£
)

905 
idx
 = 0;

907 i‡(
	`bad_iﬂpic
(
addªss
))

910 
idx
 = 
ƒ_iﬂpics
;

912 
mp_iﬂpics
[
idx
].
ty≥
 = 
MP_IOAPIC
;

913 
mp_iﬂpics
[
idx
].
Êags
 = 
MPC_APIC_USABLE
;

914 
mp_iﬂpics
[
idx
].
≠iˇddr
 = 
addªss
;

916 
	`£t_fixm≠_noˇche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
addªss
);

917 
mp_iﬂpics
[
idx
].
≠icid
 = 
	`uniq_iﬂpic_id
(
id
);

918 
mp_iﬂpics
[
idx
].
≠icvî
 = 
	`io_≠ic_gë_vîsi⁄
(idx);

924 
mp_iﬂpic_routög
[
idx
].
gsi_ba£
 = gsi_base;

925 
mp_iﬂpic_routög
[
idx
].
gsi_íd
 = 
gsi_ba£
 +

926 
	`io_≠ic_gë_ªdú_íåõs
(
idx
);

928 
	`¥ötk
(
KERN_INFO
 "IOAPIC[%d]:ápic_id %d, version %d,áddress 0x%x, "

929 "GSI %d-%d\n", 
idx
, 
mp_iﬂpics
[idx].
≠icid
,

930 
mp_iﬂpics
[
idx
].
≠icvî
, mp_iﬂpics[idx].
≠iˇddr
,

931 
mp_iﬂpic_routög
[
idx
].
gsi_ba£
, mp_iﬂpic_routög[idx].
gsi_íd
);

933 
ƒ_iﬂpics
++;

934 
	}
}

936 
__öô
 
	$a˝i_¥obe_gsi
()

938 
idx
;

939 
gsi
;

940 
max_gsi
 = 0;

942 i‡(
a˝i_dißbÀd
)

945 i‡(!
a˝i_iﬂpic
)

948 
max_gsi
 = 0;

949 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++) {

950 
gsi
 = 
mp_iﬂpic_routög
[
idx
].
gsi_íd
;

952 i‡(
gsi
 > 
max_gsi
)

953 
max_gsi
 = 
gsi
;

956  
max_gsi
 + 1;

957 
	}
}

959 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

960 
mpc_öt§c
 *
mp_úq
)

962 
	`mem˝y
(
mp_úq
, 
m
, (
mpc_öt§c
));

963 
	}
}

965 
	$mp_úq_cmp
(
mpc_öt§c
 *
mp_úq
,

966 
mpc_öt§c
 *
m
)

968  
	`memcmp
(
mp_úq
, 
m
, (
mpc_öt§c
));

969 
	}
}

971 
	$ßve_mp_úq
(
mpc_öt§c
 *
m
)

973 
i
;

975 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

976 i‡(!
	`mp_úq_cmp
(&
mp_úqs
[
i
], 
m
))

980 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

981 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

982 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

983 
	}
}

985 
__öô
 
	$mp_ovîride_Àgacy_úq
(
u8
 
bus_úq
, u8 
pﬁ¨ôy
, u8 
åiggî
, 
u32
 
gsi
)

987 
iﬂpic
;

988 
pö
;

989 
mpc_öt§c
 
mp_úq
;

994 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

995 i‡(
iﬂpic
 < 0)

997 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1004 i‡((
bus_úq
 =0Ë&& (
åiggî
 == 3))

1005 
åiggî
 = 1;

1007 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1008 
mp_úq
.
úqty≥
 = 
mp_INT
;

1009 
mp_úq
.
úqÊag
 = (
åiggî
 << 2Ë| 
pﬁ¨ôy
;

1010 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

1011 
mp_úq
.
§cbusúq
 = 
bus_úq
;

1012 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1013 
mp_úq
.
d°úq
 = 
pö
;

1015 
	`ßve_mp_úq
(&
mp_úq
);

1016 
	}
}

1018 
__öô
 
	$mp_c⁄fig_a˝i_Àgacy_úqs
()

1020 
i
;

1021 
iﬂpic
;

1022 
d°≠ic
;

1023 
mpc_öt§c
 
mp_úq
;

1025 #i‡
	`deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

1029 
mp_bus_id_to_ty≥
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

1031 
	`£t_bô
(
MP_ISA_BUS
, 
mp_bus_nŸ_pci
);

1032 
	`¥_debug
("Bu†#%d i†ISA\n", 
MP_ISA_BUS
);

1034 #ifde‡
CONFIG_X86_ES7000


1038 i‡(
es7000_∂©
 == 1)

1045 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

1046 i‡(
iﬂpic
 < 0)

1048 
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1054 
i
 = 0; i < 16; i++) {

1055 
idx
;

1057 
idx
 = 0; idx < 
mp_úq_íåõs
; idx++) {

1058 
mpc_öt§c
 *
úq
 = 
mp_úqs
 + 
idx
;

1061 i‡(
úq
->
§cbus
 =
MP_ISA_BUS
 && irq->
§cbusúq
 =
i
)

1065 i‡(
úq
->
d°≠ic
 =d°≠i¯&& irq->
d°úq
 =
i
)

1069 i‡(
idx
 !
mp_úq_íåõs
) {

1070 
	`¥ötk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ovîride.\n", 
i
);

1074 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1075 
mp_úq
.
úqÊag
 = 0;

1076 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

1077 
mp_úq
.
d°≠ic
 = dstapic;

1078 
mp_úq
.
úqty≥
 = 
mp_INT
;

1079 
mp_úq
.
§cbusúq
 = 
i
;

1080 
mp_úq
.
d°úq
 = 
i
;

1082 
	`ßve_mp_úq
(&
mp_úq
);

1084 
	}
}

1086 
	$mp_c⁄fig_a˝i_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
,

1087 
pﬁ¨ôy
)

1089 #ifde‡
CONFIG_X86_MPPARSE


1090 
mpc_öt§c
 
mp_úq
;

1091 
pci_dev
 *
pdev
;

1092 
numbî
;

1093 
dev‚
;

1094 
iﬂpic
;

1095 
u8
 
pö
;

1097 i‡(!
a˝i_iﬂpic
)

1099 i‡(!
dev
)

1101 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1104 
pdev
 = 
	`to_pci_dev
(
dev
);

1105 
numbî
 = 
pdev
->
bus
->number;

1106 
dev‚
 = 
pdev
->devfn;

1107 
pö
 = 
pdev
->pin;

1109 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1110 
mp_úq
.
úqty≥
 = 
mp_INT
;

1111 
mp_úq
.
úqÊag
 = (
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1112 (
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1113 
mp_úq
.
§cbus
 = 
numbî
;

1114 
mp_úq
.
§cbusúq
 = (((
dev‚
 >> 3Ë& 0x1fË<< 2Ë| ((
pö
 - 1) & 3);

1115 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1116 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1117 
mp_úq
.
d°úq
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1119 
	`ßve_mp_úq
(&
mp_úq
);

1122 
	}
}

1124 
	$mp_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

1126 
iﬂpic
;

1127 
iﬂpic_pö
;

1128 
io_≠ic_úq_©å
 
úq_©å
;

1130 i‡(
a˝i_úq_modñ
 !
ACPI_IRQ_MODEL_IOAPIC
)

1131  
gsi
;

1134 i‡(
a˝i_gbl_FADT
.
sci_öãºu±
 =
gsi
)

1135  
gsi
;

1137 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1138 i‡(
iﬂpic
 < 0) {

1139 
	`¥ötk
(
KERN_WARNING
 "NÿIOAPIC f‹ GSI %u\n", 
gsi
);

1140  
gsi
;

1143 
iﬂpic_pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1145 #ifde‡
CONFIG_X86_32


1146 i‡(
iﬂpic_ªnumbî_úq
)

1147 
gsi
 = 
	`iﬂpic_ªnumbî_úq
(
iﬂpic
, gsi);

1150 i‡(
iﬂpic_pö
 > 
MP_MAX_IOAPIC_PIN
) {

1151 
	`¥ötk
(
KERN_ERR
 "InvalidÑeferenceÅo IOAPICÖin "

1152 "%d-%d\n", 
mp_iﬂpics
[
iﬂpic
].
≠icid
,

1153 
iﬂpic_pö
);

1154  
gsi
;

1157 i‡(
íabÀ_upd©e_m±abÀ
)

1158 
	`mp_c⁄fig_a˝i_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

1160 
	`£t_io_≠ic_úq_©å
(&
úq_©å
, 
iﬂpic
, 
iﬂpic_pö
,

1161 
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1162 
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1163 
	`io_≠ic_£t_pci_routög
(
dev
, 
gsi
, &
úq_©å
);

1165  
gsi
;

1166 
	}
}

1172 
__öô
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1174 
cou¡
;

1182 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1183  -
ENODEV
;

1186 i‡(!
˝u_has_≠ic
)

1187  -
ENODEV
;

1192 i‡(
skù_iﬂpic_£tup
) {

1193 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPICÖrobe "

1195  -
ENODEV
;

1198 
cou¡
 =

1199 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
a˝i_∑r£_iﬂpic
,

1200 
MAX_IO_APICS
);

1201 i‡(!
cou¡
) {

1202 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No IOAPICÉntriesÖresent\n");

1203  -
ENODEV
;

1204 } i‡(
cou¡
 < 0) {

1205 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing IOAPICÉntry\n");

1206  
cou¡
;

1209 
cou¡
 =

1210 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
a˝i_∑r£_öt_§c_ovr
,

1211 
ƒ_úqs
);

1212 i‡(
cou¡
 < 0) {

1213 
	`¥ötk
(
KERN_ERR
 
PREFIX


1216  
cou¡
;

1223 i‡(!
a˝i_sci_ovîride_gsi
)

1224 
	`a˝i_sci_iﬂpic_£tup
(
a˝i_gbl_FADT
.
sci_öãºu±
, 0, 0);

1227 
	`mp_c⁄fig_a˝i_Àgacy_úqs
();

1229 
cou¡
 =

1230 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
a˝i_∑r£_nmi_§c
,

1231 
ƒ_úqs
);

1232 i‡(
cou¡
 < 0) {

1233 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing NMI SRCÉntry\n");

1235  
cou¡
;

1239 
	}
}

1241 
ölöe
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1244 
	}
}

1247 
__öô
 
	$óæy_a˝i_¥o˚ss_madt
()

1249 #ifde‡
CONFIG_X86_LOCAL_APIC


1250 
îr‹
;

1252 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1257 
îr‹
 = 
	`óæy_a˝i_∑r£_madt_œpic_addr_ovr
();

1258 i‡(!
îr‹
) {

1259 
a˝i_œpic
 = 1;

1260 
smp_found_c⁄fig
 = 1;

1262 i‡(
îr‹
 =-
EINVAL
) {

1266 
	`¥ötk
(
KERN_ERR
 
PREFIX


1268 
	`dißbÀ_a˝i
();

1272 
	}
}

1274 
__öô
 
	$a˝i_¥o˚ss_madt
()

1276 #ifde‡
CONFIG_X86_LOCAL_APIC


1277 
îr‹
;

1279 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1284 
îr‹
 = 
	`a˝i_∑r£_madt_œpic_íåõs
();

1285 i‡(!
îr‹
) {

1286 
a˝i_œpic
 = 1;

1288 #ifde‡
CONFIG_X86_BIGSMP


1289 
	`gíîic_bigsmp_¥obe
();

1294 
îr‹
 = 
	`a˝i_∑r£_madt_iﬂpic_íåõs
();

1295 i‡(!
îr‹
) {

1296 
a˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1297 
a˝i_iﬂpic
 = 1;

1299 
smp_found_c⁄fig
 = 1;

1300 i‡(
≠ic
->
£tup_≠ic_routög
)

1301 
≠ic
->
	`£tup_≠ic_routög
();

1304 i‡(
îr‹
 =-
EINVAL
) {

1308 
	`¥ötk
(
KERN_ERR
 
PREFIX


1310 
	`dißbÀ_a˝i
();

1318 i‡(
smp_found_c⁄fig
) {

1319 
	`¥ötk
(
KERN_WARNING
 
PREFIX


1321 
smp_found_c⁄fig
 = 0;

1329 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

1330 
	`¥ötk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1332 i‡(
a˝i_œpic
)

1333 
	`¥ötk
(
KERN_INFO
 "Using ACPI forÖrocessor (LAPIC) "

1337 
	}
}

1339 
__öô
 
	$dißbÀ_a˝i_úq
(c⁄° 
dmi_sy°em_id
 *
d
)

1341 i‡(!
a˝i_f‹˚
) {

1342 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=noirq\n",

1343 
d
->
idít
);

1344 
	`a˝i_noúq_£t
();

1347 
	}
}

1349 
__öô
 
	$dißbÀ_a˝i_pci
(c⁄° 
dmi_sy°em_id
 *
d
)

1351 i‡(!
a˝i_f‹˚
) {

1352 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofÖci=noacpi\n",

1353 
d
->
idít
);

1354 
	`a˝i_dißbÀ_pci
();

1357 
	}
}

1359 
__öô
 
	$dmi_dißbÀ_a˝i
(c⁄° 
dmi_sy°em_id
 *
d
)

1361 i‡(!
a˝i_f‹˚
) {

1362 
	`¥ötk
(
KERN_NOTICE
 "%†dëe˘ed:á˝òoff\n", 
d
->
idít
);

1363 
	`dißbÀ_a˝i
();

1365 
	`¥ötk
(
KERN_NOTICE


1369 
	}
}

1374 
__öô
 
	$f‹˚_a˝i_ht
(c⁄° 
dmi_sy°em_id
 *
d
)

1376 i‡(!
a˝i_f‹˚
) {

1377 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=ht\n",

1378 
d
->
idít
);

1379 
	`dißbÀ_a˝i
();

1380 
a˝i_ht
 = 1;

1382 
	`¥ötk
(
KERN_NOTICE


1386 
	}
}

1391 
__öô
 
	$dmi_ign‹e_úq0_timî_ovîride
(c⁄° 
dmi_sy°em_id
 *
d
)

1397 i‡(!
a˝i_skù_timî_ovîride
) {

1398 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirkÇot complete.\n");

1399 
	`¥_nŸi˚
("%s detected: Ignoring BIOS IRQ0Öin2 override\n",

1400 
d
->
idít
);

1401 
a˝i_skù_timî_ovîride
 = 1;

1404 
	}
}

1410 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ
[] = {

1415 .
ˇŒback
 = 
dmi_dißbÀ_a˝i
,

1416 .
	gidít
 = "IBM Thinkpad",

1417 .
	gm©ches
 = {

1418 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1419 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1427 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1428 .
	gidít
 = "FSC Primergy T850",

1429 .
	gm©ches
 = {

1430 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

1431 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

1435 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1436 .
	gidít
 = "HP VISUALIZE NT Workstation",

1437 .
	gm©ches
 = {

1438 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

1439 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

1443 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1444 .
	gidít
 = "Compaq Workstation W8000",

1445 .
	gm©ches
 = {

1446 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

1447 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

1451 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1452 .
	gidít
 = "ASUS P2B-DS",

1453 .
	gm©ches
 = {

1454 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1455 
DMI_MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

1459 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1460 .
	gidít
 = "ASUS CUR-DLS",

1461 .
	gm©ches
 = {

1462 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1463 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

1467 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1468 .
	gidít
 = "ABIT i440BX-W83977",

1469 .
	gm©ches
 = {

1470 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

1471 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

1475 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1476 .
	gidít
 = "IBM Bladecenter",

1477 .
	gm©ches
 = {

1478 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1479 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMÉServer BladeCenter HS20"),

1483 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1484 .
	gidít
 = "IBMÉServer xSeries 360",

1485 .
	gm©ches
 = {

1486 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1487 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

1491 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1492 .
	gidít
 = "IBMÉserver xSeries 330",

1493 .
	gm©ches
 = {

1494 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1495 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

1499 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1500 .
	gidít
 = "IBMÉserver xSeries 440",

1501 .
	gm©ches
 = {

1502 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1503 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

1511 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1512 .
	gidít
 = "ASUS A7V",

1513 .
	gm©ches
 = {

1514 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1515 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1517 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1528 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1529 .
	gidít
 = "IBM Thinkpad 600 Series 2645",

1530 .
	gm©ches
 = {

1531 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1532 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1536 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1537 .
	gidít
 = "IBM Thinkpad 600 Series 2646",

1538 .
	gm©ches
 = {

1539 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1540 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1547 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1548 .
	gidít
 = "ASUS PR-DLS",

1549 .
	gm©ches
 = {

1550 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1551 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1552 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1554 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1558 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1559 .
	gidít
 = "Acer TravelMate 36x Laptop",

1560 .
	gm©ches
 = {

1561 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1562 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1569 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ_œã
[] = {

1581 .
ˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1582 .
	gidít
 = "HPÇx6115Üaptop",

1583 .
	gm©ches
 = {

1584 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1585 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6115"),

1589 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1590 .
	gidít
 = "HP NX6125Üaptop",

1591 .
	gm©ches
 = {

1592 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1593 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6125"),

1597 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1598 .
	gidít
 = "HP NX6325Üaptop",

1599 .
	gm©ches
 = {

1600 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1601 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6325"),

1605 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1606 .
	gidít
 = "HP 6715bÜaptop",

1607 .
	gm©ches
 = {

1608 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1609 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1638 
__öô
 
	$a˝i_boŸ_èbÀ_öô
()

1640 
îr‹
;

1642 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ
);

1648 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1654 
îr‹
 = 
	`a˝i_èbÀ_öô
();

1655 i‡(
îr‹
) {

1656 
	`dißbÀ_a˝i
();

1657  
îr‹
;

1660 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1665 
îr‹
 = 
	`a˝i_bœckli°ed
();

1666 i‡(
îr‹
) {

1667 i‡(
a˝i_f‹˚
) {

1668 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1670 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1671 
	`dißbÀ_a˝i
();

1672  
îr‹
;

1677 
	}
}

1679 
__öô
 
	$óæy_a˝i_boŸ_öô
()

1685 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1691 
	`óæy_a˝i_¥o˚ss_madt
();

1694 
	}
}

1696 
__öô
 
	$a˝i_boŸ_öô
()

1699 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ_œã
);

1705 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1708 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1713 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_FADT
, 
a˝i_∑r£_Ádt
);

1718 
	`a˝i_¥o˚ss_madt
();

1720 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
a˝i_∑r£_h≥t
);

1723 
	}
}

1725 
__öô
 
	$∑r£_a˝i
(*
¨g
)

1727 i‡(!
¨g
)

1728  -
EINVAL
;

1731 i‡(
	`°rcmp
(
¨g
, "off") == 0) {

1732 
	`dißbÀ_a˝i
();

1735 i‡(
	`°rcmp
(
¨g
, "force") == 0) {

1736 
a˝i_f‹˚
 = 1;

1737 
a˝i_ht
 = 1;

1738 
a˝i_dißbÀd
 = 0;

1741 i‡(
	`°rcmp
(
¨g
, "strict") == 0) {

1742 
a˝i_°ri˘
 = 1;

1745 i‡(
	`°rcmp
(
¨g
, "ht") == 0) {

1746 i‡(!
a˝i_f‹˚
)

1747 
	`dißbÀ_a˝i
();

1748 
a˝i_ht
 = 1;

1751 i‡(
	`°rcmp
(
¨g
, "rsdt") == 0) {

1752 
a˝i_rsdt_f‹˚d
 = 1;

1755 i‡(
	`°rcmp
(
¨g
, "noirq") == 0) {

1756 
	`a˝i_noúq_£t
();

1759  -
EINVAL
;

1762 
	}
}

1763 
óæy_∑øm
("a˝i", 
∑r£_a˝i
);

1766 
__öô
 
	$∑r£_pci
(*
¨g
)

1768 i‡(
¨g
 && 
	`°rcmp
(arg, "noacpi") == 0)

1769 
	`a˝i_dißbÀ_pci
();

1771 
	}
}

1772 
óæy_∑øm
("pci", 
∑r£_pci
);

1774 
__öô
 
	$a˝i_mps_check
()

1776 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& !deföed(
CONFIG_X86_MPPARSE
)

1778 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1779 
	`¥ötk
(
KERN_WARNING
 "MPS support code isÇot built-in.\n"

1786 
	}
}

1788 #ifde‡
CONFIG_X86_IO_APIC


1789 
__öô
 
	$∑r£_a˝i_skù_timî_ovîride
(*
¨g
)

1791 
a˝i_skù_timî_ovîride
 = 1;

1793 
	}
}

1794 
óæy_∑øm
("a˝i_skù_timî_ovîride", 
∑r£_a˝i_skù_timî_ovîride
);

1796 
__öô
 
	$∑r£_a˝i_u£_timî_ovîride
(*
¨g
)

1798 
a˝i_u£_timî_ovîride
 = 1;

1800 
	}
}

1801 
óæy_∑øm
("a˝i_u£_timî_ovîride", 
∑r£_a˝i_u£_timî_ovîride
);

1804 
__öô
 
	$£tup_a˝i_sci
(*
s
)

1806 i‡(!
s
)

1807  -
EINVAL
;

1808 i‡(!
	`°rcmp
(
s
, "edge"))

1809 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1810 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1811 i‡(!
	`°rcmp
(
s
, "level"))

1812 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1813 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1814 i‡(!
	`°rcmp
(
s
, "high"))

1815 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1816 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1817 i‡(!
	`°rcmp
(
s
, "low"))

1818 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1819 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1821  -
EINVAL
;

1823 
	}
}

1824 
óæy_∑øm
("a˝i_sci", 
£tup_a˝i_sci
);

1826 
	$__a˝i_acquúe_globÆ_lock
(*
lock
)

1828 
ﬁd
, 
√w
, 
vÆ
;

1830 
ﬁd
 = *
lock
;

1831 
√w
 = (((
ﬁd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1832 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1833 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1834  (
√w
 < 3) ? -1 : 0;

1835 
	}
}

1837 
	$__a˝i_ªÀa£_globÆ_lock
(*
lock
)

1839 
ﬁd
, 
√w
, 
vÆ
;

1841 
ﬁd
 = *
lock
;

1842 
√w
 = 
ﬁd
 & ~0x3;

1843 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1844 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1845  
ﬁd
 & 0x1;

1846 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/sched.h
>

14 
	~<a˝i/¥o˚ss‹.h
>

15 
	~<asm/a˝i.h
>

27 
	$a˝i_¥o˚ss‹_powî_öô_bm_check
(
a˝i_¥o˚ss‹_Êags
 *
Êags
,

28 
˝u
)

30 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

32 
Êags
->
bm_check
 = 0;

33 i‡(
	`num_⁄löe_˝us
() == 1)

34 
Êags
->
bm_check
 = 1;

35 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

41 
Êags
->
bm_check
 = 1;

50 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

51 (
c
->
x86
 > 0x6 || (c->x86 =6 && c->
x86_modñ
 >= 14)))

52 
Êags
->
bm_c⁄åﬁ
 = 0;

53 
	}
}

54 
EXPORT_SYMBOL
(
a˝i_¥o˚ss‹_powî_öô_bm_check
);

58 
	sc°©e_íåy
 {

60 
	móx
;

61 
	mecx
;

62 } 
	m°©es
[
ACPI_PROCESSOR_MAX_POWER
];

64 
c°©e_íåy
 *
	g˝u_c°©e_íåy
;

66 
	gmwaô_suµ‹ãd
[
ACPI_PROCESSOR_MAX_POWER
];

68 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

69 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

70 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

72 
	#CPUID_MWAIT_LEAF
 (5)

	)

73 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

74 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

76 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

78 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

80 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
(*
_cx
)

82 
a˝i_¥o˚ss‹_cx
 *
cx
 = 
_cx
;

83 
ªtvÆ
;

84 
óx
, 
ebx
, 
ecx
, 
edx
;

85 
edx_∑π
;

86 
c°©e_ty≥
;

87 
num_c°©e_subty≥
;

89 
	`˝uid
(
CPUID_MWAIT_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
c°©e_ty≥
 = ((
cx
->
addªss
 >> 
MWAIT_SUBSTATE_SIZE
) &

93 
MWAIT_CSTATE_MASK
) + 1;

94 
edx_∑π
 = 
edx
 >> (
c°©e_ty≥
 * 
MWAIT_SUBSTATE_SIZE
);

95 
num_c°©e_subty≥
 = 
edx_∑π
 & 
MWAIT_SUBSTATE_MASK
;

97 
ªtvÆ
 = 0;

98 i‡(
num_c°©e_subty≥
 < (
cx
->
addªss
 & 
MWAIT_SUBSTATE_MASK
)) {

99 
ªtvÆ
 = -1;

100 
out
;

104 i‡(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

105 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

106 
ªtvÆ
 = -1;

107 
out
;

110 i‡(!
mwaô_suµ‹ãd
[
c°©e_ty≥
]) {

111 
mwaô_suµ‹ãd
[
c°©e_ty≥
] = 1;

112 
	`¥ötk
(
KERN_DEBUG


114 "°©e\n", 
cx
->
ty≥
);

116 
	`¢¥ötf
(
cx
->
desc
,

117 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

118 
cx
->
addªss
);

119 
out
:

120  
ªtvÆ
;

121 
	}
}

123 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe
(
˝u
,

124 
a˝i_¥o˚ss‹_cx
 *
cx
, 
a˝i_powî_ªgi°î
 *
ªg
)

126 
c°©e_íåy
 *
≥r˝u_íåy
;

127 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

128 
ªtvÆ
;

130 i‡(!
˝u_c°©e_íåy
 || 
c
->
˝uid_Àvñ
 < 
CPUID_MWAIT_LEAF
)

133 i‡(
ªg
->
bô_off£t
 !
NATIVE_CSTATE_BEYOND_HALT
)

136 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

137 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = 0;

138 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 0;

142 
ªtvÆ
 = 
	`w‹k_⁄_˝u
(
˝u
, 
a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
, 
cx
);

143 i‡(
ªtvÆ
 == 0) {

145 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = cx->
addªss
;

146 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

148  
ªtvÆ
;

149 
	}
}

150 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_¥obe
);

152 
	$a˝i_¥o˚ss‹_ffh_c°©e_íãr
(
a˝i_¥o˚ss‹_cx
 *
cx
)

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
c°©e_íåy
 *
≥r˝u_íåy
;

157 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

158 
	`mwaô_idÀ_wôh_höts
(
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
,

159 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
);

160 
	}
}

161 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_íãr
);

163 
__öô
 
	$ffh_c°©e_öô
()

165 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

166 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
)

169 
˝u_c°©e_íåy
 = 
	`Æloc_≥r˝u
(
c°©e_íåy
);

171 
	}
}

173 
__exô
 
	$ffh_c°©e_exô
()

175 
	`‰ì_≥r˝u
(
˝u_c°©e_íåy
);

176 
˝u_c°©e_íåy
 = 
NULL
;

177 
	}
}

179 
¨ch_öôˇŒ
(
ffh_c°©e_öô
);

180 
__exôˇŒ
(
ffh_c°©e_exô
);

	@/cmpt816/linux/arch/x86/kernel/acpi/processor.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

12 
	~<a˝i/¥o˚ss‹.h
>

13 
	~<asm/a˝i.h
>

15 
	$öô_öãl_pdc
(
a˝i_¥o˚ss‹
 *
¥
, 
˝uöfo_x86
 *
c
)

17 
a˝i_obje˘_li°
 *
obj_li°
;

18 
a˝i_obje˘
 *
obj
;

19 
u32
 *
buf
;

22 
obj_li°
 = 
	`kmÆloc
((
a˝i_obje˘_li°
), 
GFP_KERNEL
);

23 i‡(!
obj_li°
) {

24 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

28 
obj
 = 
	`kmÆloc
((
a˝i_obje˘
), 
GFP_KERNEL
);

29 i‡(!
obj
) {

30 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

31 
	`k‰ì
(
obj_li°
);

35 
buf
 = 
	`kmÆloc
(12, 
GFP_KERNEL
);

36 i‡(!
buf
) {

37 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

38 
	`k‰ì
(
obj
);

39 
	`k‰ì
(
obj_li°
);

43 
buf
[0] = 
ACPI_PDC_REVISION_ID
;

44 
buf
[1] = 1;

45 
buf
[2] = 
ACPI_PDC_C_CAPABILITY_SMP
;

52 
buf
[2] |
ACPI_PDC_SMP_T_SWCOORD
;

53 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_EST
))

54 
buf
[2] |
ACPI_PDC_EST_CAPABILITY_SWSMP
;

56 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
))

57 
buf
[2] |
ACPI_PDC_T_FFH
;

62 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
))

63 
buf
[2] &~(
ACPI_PDC_C_C2C3_FFH
);

65 
obj
->
ty≥
 = 
ACPI_TYPE_BUFFER
;

66 
obj
->
buf„r
.
Àngth
 = 12;

67 
obj
->
buf„r
.
poöãr
 = (
u8
 *Ë
buf
;

68 
obj_li°
->
cou¡
 = 1;

69 
obj_li°
->
poöãr
 = 
obj
;

70 
¥
->
pdc
 = 
obj_li°
;

73 
	}
}

77 
	$¨ch_a˝i_¥o˚ss‹_öô_pdc
(
a˝i_¥o˚ss‹
 *
¥
)

79 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
¥
->
id
);

81 
¥
->
pdc
 = 
NULL
;

82 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

83 
	`öô_öãl_pdc
(
¥
, 
c
);

86 
	}
}

88 
EXPORT_SYMBOL
(
¨ch_a˝i_¥o˚ss‹_öô_pdc
);

90 
	$¨ch_a˝i_¥o˚ss‹_˛ónup_pdc
(
a˝i_¥o˚ss‹
 *
¥
)

92 i‡(
¥
->
pdc
) {

93 
	`k‰ì
(
¥
->
pdc
->
poöãr
->
buf„r
.pointer);

94 
	`k‰ì
(
¥
->
pdc
->
poöãr
);

95 
	`k‰ì
(
¥
->
pdc
);

96 
¥
->
pdc
 = 
NULL
;

98 
	}
}

100 
EXPORT_SYMBOL
(
¨ch_a˝i_¥o˚ss‹_˛ónup_pdc
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c

1 
	~"../../../boŸ/ªgs.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boŸ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boŸ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boŸ/video-veß.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boŸ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boŸ.h
"

4 
	$udñay
(
lo›s
)

6 
lo›s
--)

7 
	`io_dñay
();

8 
	}
}

10 
	$bìp
(
hz
)

12 
u8
 
íabÀ
;

14 i‡(!
hz
) {

15 
íabÀ
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_dñay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_dñay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_dñay
();

26 
íabÀ
 = 0x03;

28 
	`öb
(0x61);

29 
	`io_dñay
();

30 
	`outb
(
íabÀ
, 0x61);

31 
	`io_dñay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_m‹£
(c⁄° *
∑âîn
)

41 
s
;

43 (
s
 = *
∑âîn
++)) {

44 
s
) {

46 
	`bìp
(
DOT_HZ
);

47 
	`udñay
(
US_PER_DOT
);

48 
	`bìp
(0);

49 
	`udñay
(
US_PER_DOT
);

52 
	`bìp
(
DASH_HZ
);

53 
	`udñay
(
US_PER_DOT
 * 3);

54 
	`bìp
(0);

55 
	`udñay
(
US_PER_DOT
);

58 
	`udñay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maö
()

67 i‡(
wakeup_hódî
.
ªÆ_magic
 != 0x12345678)

70 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 4)

71 
	`£nd_m‹£
("...-");

73 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 2) {

78 
	`¥obe_ˇrds
(0);

79 
	`£t_mode
(
wakeup_hódî
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<löux/a˝i.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/dmi.h
>

11 
	~<löux/˝umask.h
>

12 
	~<asm/£gmít.h
>

13 
	~<asm/desc.h
>

15 
	~"ªÆmode/wakeup.h
"

16 
	~"¶ìp.h
"

18 
	ga˝i_wakeup_addªss
;

19 
	ga˝i_ªÆmode_Êags
;

22 
	ga˝i_ªÆmode
;

24 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_64BIT
)

25 
	gãmp_°ack
[4096];

36 
	$a˝i_ßve_°©e_mem
()

38 
wakeup_hódî
 *
hódî
;

40 i‡(!
a˝i_ªÆmode
) {

41 
	`¥ötk
(
KERN_ERR
 "CouldÇotállocate memory during boot, "

43  -
ENOMEM
;

45 
	`mem˝y
((*)
a˝i_ªÆmode
, &
wakeup_code_°¨t
, 
WAKEUP_SIZE
);

47 
hódî
 = (
wakeup_hódî
 *)(
a˝i_ªÆmode
 + 
HEADER_OFFSET
);

48 i‡(
hódî
->
sig«tuª
 != 0x51ee1111) {

49 
	`¥ötk
(
KERN_ERR
 "wakeup header doesÇot match\n");

50  -
EINVAL
;

53 
hódî
->
video_mode
 = 
ßved_video_mode
;

55 
hódî
->
wakeup_jmp_£g
 = 
a˝i_wakeup_addªss
 >> 4;

66 
hódî
->
wakeup_gdt
[0] =

67 (
u64
)((
hódî
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
a˝i_wakeup_addªss
 +

69 ((*)&
hódî
->
wakeup_gdt
 - (*)
a˝i_ªÆmode
))

72 
hódî
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
a˝i_wakeup_addªss
, 0xfffff);

75 
hódî
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
a˝i_wakeup_addªss
, 0xfffff);

78 #i‚de‡
CONFIG_64BIT


79 
	`°‹e_gdt
((
desc_±r
 *)&
hódî
->
pmode_gdt
);

81 
hódî
->
pmode_e„r_low
 = 
nx_íabÀd
;

82 i‡(
hódî
->
pmode_e„r_low
 & 1) {

84 
	`rdm§
(
MSR_EFER
, 
hódî
->
pmode_e„r_low
,

85 
hódî
->
pmode_e„r_high
);

89 
hódî
->
pmode_¸0
 = 
	`ªad_¸0
();

90 
hódî
->
pmode_¸4
 = 
	`ªad_¸4_ß„
();

91 
hódî
->
ªÆmode_Êags
 = 
a˝i_ªÆmode_Êags
;

92 
hódî
->
ªÆ_magic
 = 0x12345678;

94 #i‚de‡
CONFIG_64BIT


95 
hódî
->
pmode_íåy
 = (
u32
)&
wakeup_pmode_ªtu∫
;

96 
hódî
->
pmode_¸3
 = (
u32
)(
swsu•_pg_dú
 - 
__PAGE_OFFSET
);

97 
ßved_magic
 = 0x12345678;

99 
hódî
->
åampﬁöe_£gmít
 = 
	`£tup_åampﬁöe
() >> 4;

100 #ifde‡
CONFIG_SMP


101 
°ack_°¨t
.
•
 = 
ãmp_°ack
 + (temp_stack);

102 
óæy_gdt_des¸
.
addªss
 =

103 ()
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

104 
öôül_gs
 = 
	`≥r_˝u_off£t
(
	`smp_¥o˚ss‹_id
());

106 
öôül_code
 = ()
wakeup_l⁄g64
;

107 
ßved_magic
 = 0x123456789abcdef0L;

111 
	}
}

116 
	$a˝i_ª°‹e_°©e_mem
()

118 
	}
}

129 
__öô
 
	$a˝i_ª£rve_boŸmem
()

131 i‡((&
wakeup_code_íd
 - &
wakeup_code_°¨t
Ë> 
WAKEUP_SIZE
) {

132 
	`¥ötk
(
KERN_ERR


137 
a˝i_ªÆmode
 = ()
	`Æloc_boŸmem_low
(
WAKEUP_SIZE
);

139 i‡(!
a˝i_ªÆmode
) {

140 
	`¥ötk
(
KERN_ERR
 "ACPI: CannotállocateÜowmem, S3 disabled.\n");

144 
a˝i_wakeup_addªss
 = 
	`vút_to_phys
((*)
a˝i_ªÆmode
);

145 
	}
}

148 
__öô
 
	$a˝i_¶ìp_£tup
(*
°r
)

150 (
°r
 !
NULL
) && (*str != '\0')) {

151 i‡(
	`°∫cmp
(
°r
, "s3_bios", 7) == 0)

152 
a˝i_ªÆmode_Êags
 |= 1;

153 i‡(
	`°∫cmp
(
°r
, "s3_mode", 7) == 0)

154 
a˝i_ªÆmode_Êags
 |= 2;

155 i‡(
	`°∫cmp
(
°r
, "s3_beep", 7) == 0)

156 
a˝i_ªÆmode_Êags
 |= 4;

157 #ifde‡
CONFIG_HIBERNATION


158 i‡(
	`°∫cmp
(
°r
, "s4_nohwsig", 10) == 0)

159 
	`a˝i_no_s4_hw_sig«tuª
();

160 i‡(
	`°∫cmp
(
°r
, "s4_nonvs", 8) == 0)

161 
	`a˝i_s4_no_nvs
();

163 i‡(
	`°∫cmp
(
°r
, "old_ordering", 12) == 0)

164 
	`a˝i_ﬁd_su•íd_‹dîög
();

165 
°r
 = 
	`°rchr
(str, ',');

166 i‡(
°r
 !
NULL
)

167 
°r
 +
	`°r•n
(str, ", \t");

170 
	}
}

172 
__£tup
("a˝i_¶ìp=", 
a˝i_¶ìp_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/muãx.h
>

4 
	~<löux/li°.h
>

5 
	~<löux/k¥obes.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/vmÆloc.h
>

8 
	~<löux/mem‹y.h
>

9 
	~<asm/Æã∫©ive.h
>

10 
	~<asm/£˘i⁄s.h
>

11 
	~<asm/pgèbÀ.h
>

12 
	~<asm/m˚.h
>

13 
	~<asm/nmi.h
>

14 
	~<asm/vsysˇŒ.h
>

15 
	~<asm/ˇcheÊush.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/io.h
>

18 
	~<asm/fixm≠.h
>

20 
	#MAX_PATCH_LEN
 (255-1)

	)

22 #ifde‡
CONFIG_HOTPLUG_CPU


23 
	gsmp_Æt_⁄˚
;

25 
__öô
 
	$boŸ⁄ly
(*
°r
)

27 
smp_Æt_⁄˚
 = 1;

29 
	}
}

30 
__£tup
("smp-Æt-boŸ", 
boŸ⁄ly
);

32 
	#smp_Æt_⁄˚
 1

	)

35 
	gdebug_Æã∫©ive
;

37 
__öô
 
	$debug_Æt
(*
°r
)

39 
debug_Æã∫©ive
 = 1;

41 
	}
}

42 
__£tup
("debug-Æã∫©ive", 
debug_Æt
);

44 
	gn‹ïœ˚_smp
;

46 
__öô
 
	$£tup_n‹ïœ˚_smp
(*
°r
)

48 
n‹ïœ˚_smp
 = 1;

50 
	}
}

51 
__£tup
("n‹ïœ˚-smp", 
£tup_n‹ïœ˚_smp
);

53 #ifde‡
CONFIG_PARAVIRT


54 
	gn‹ïœ˚_∑øvút
 = 0;

56 
__öô
 
	$£tup_n‹ïœ˚_∑øvút
(*
°r
)

58 
n‹ïœ˚_∑øvút
 = 1;

60 
	}
}

61 
__£tup
("n‹ïœ˚-∑øvút", 
£tup_n‹ïœ˚_∑øvút
);

64 
	#DPRINTK
(
fmt
, 
¨gs
...Ëi‡(
debug_Æã∫©ive
) \

65 
	`¥ötk
(
KERN_DEBUG
 
fmt
, 
¨gs
)

	)

67 #ifde‡
GENERIC_NOP1


71 
asm
("\t.section .rodata, \"a\"\nintelnops: "

72 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


73 
GENERIC_NOP7
 
GENERIC_NOP8


75 c⁄° 
öã ›s
[];

76 c⁄° *c⁄° 
	göãl_n›s
[
ASM_NOP_MAX
+1] = {

77 
NULL
,

78 
öã ›s
,

79 
öã ›s
 + 1,

80 
öã ›s
 + 1 + 2,

81 
öã ›s
 + 1 + 2 + 3,

82 
öã ›s
 + 1 + 2 + 3 + 4,

83 
öã ›s
 + 1 + 2 + 3 + 4 + 5,

84 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6,

85 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

89 #ifde‡
K8_NOP1


90 
asm
("\t.section .rodata, \"a\"\nk8nops: "

91 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


92 
K8_NOP7
 
K8_NOP8


94 c⁄° 
k8n›s
[];

95 c⁄° *c⁄° 
	gk8_n›s
[
ASM_NOP_MAX
+1] = {

96 
NULL
,

97 
k8n›s
,

98 
k8n›s
 + 1,

99 
k8n›s
 + 1 + 2,

100 
k8n›s
 + 1 + 2 + 3,

101 
k8n›s
 + 1 + 2 + 3 + 4,

102 
k8n›s
 + 1 + 2 + 3 + 4 + 5,

103 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

104 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

108 #ifde‡
K7_NOP1


109 
asm
("\t.section .rodata, \"a\"\nk7nops: "

110 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


111 
K7_NOP7
 
K7_NOP8


113 c⁄° 
k7n›s
[];

114 c⁄° *c⁄° 
	gk7_n›s
[
ASM_NOP_MAX
+1] = {

115 
NULL
,

116 
k7n›s
,

117 
k7n›s
 + 1,

118 
k7n›s
 + 1 + 2,

119 
k7n›s
 + 1 + 2 + 3,

120 
k7n›s
 + 1 + 2 + 3 + 4,

121 
k7n›s
 + 1 + 2 + 3 + 4 + 5,

122 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

123 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

127 #ifde‡
P6_NOP1


128 
asm
("\t.section .rodata, \"a\"\np6nops: "

129 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


130 
P6_NOP7
 
P6_NOP8


132 c⁄° 
p6n›s
[];

133 c⁄° *c⁄° 
	gp6_n›s
[
ASM_NOP_MAX
+1] = {

134 
NULL
,

135 
p6n›s
,

136 
p6n›s
 + 1,

137 
p6n›s
 + 1 + 2,

138 
p6n›s
 + 1 + 2 + 3,

139 
p6n›s
 + 1 + 2 + 3 + 4,

140 
p6n›s
 + 1 + 2 + 3 + 4 + 5,

141 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

142 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

146 #ifde‡
CONFIG_X86_64


148 
__vsysˇŒ_0
;

149 c⁄° *c⁄° *
	$föd_n›_èbÀ
()

151 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

152 
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

153  
p6_n›s
;

155  
k8_n›s
;

156 
	}
}

160 c⁄° *c⁄° *
	$föd_n›_èbÀ
()

162 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K8
))

163  
k8_n›s
;

164 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K7
))

165  
k7_n›s
;

166 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

167  
p6_n›s
;

169  
öãl_n›s
;

170 
	}
}

175 
	$add_n›s
(*
ö¢s
, 
Àn
)

177 c⁄° *c⁄° *
n›èbÀ
 = 
	`föd_n›_èbÀ
();

179 
Àn
 > 0) {

180 
n›Àn
 = 
Àn
;

181 i‡(
n›Àn
 > 
ASM_NOP_MAX
)

182 
n›Àn
 = 
ASM_NOP_MAX
;

183 
	`mem˝y
(
ö¢s
, 
n›èbÀ
[
n›Àn
],Çoplen);

184 
ö¢s
 +
n›Àn
;

185 
Àn
 -
n›Àn
;

187 
	}
}

188 
EXPORT_SYMBOL_GPL
(
add_n›s
);

190 
Æt_ö°r
 
__Æt_ö°ru˘i⁄s
[], 
__Æt_ö°ru˘i⁄s_íd
[];

191 
u8
 *
__smp_locks
[], *
__smp_locks_íd
[];

199 
	$≠∂y_Æã∫©ives
(
Æt_ö°r
 *
°¨t
, Æt_ö°∏*
íd
)

201 
Æt_ö°r
 *
a
;

202 
ö¢buf
[
MAX_PATCH_LEN
];

204 
	`DPRINTK
("%s:á…ÅabÀ %∞-> %p\n", 
__func__
, 
°¨t
, 
íd
);

205 
a
 = 
°¨t
;á < 
íd
;á++) {

206 
u8
 *
ö°r
 = 
a
->instr;

207 
	`BUG_ON
(
a
->
ª∂a˚míéí
 >á->
ö°æí
);

208 
	`BUG_ON
(
a
->
ö°æí
 > (
ö¢buf
));

209 i‡(!
	`boŸ_˝u_has
(
a
->
˝uid
))

211 #ifde‡
CONFIG_X86_64


213 i‡(
ö°r
 >(
u8
 *)
VSYSCALL_START
 && in°∏< (u8*)
VSYSCALL_END
) {

214 
ö°r
 = 
	`__va
(ö°∏- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__∑_symbﬁ
(&
__vsysˇŒ_0
));

215 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

216 
__func__
, 
a
->
ö°r
, instr);

219 
	`mem˝y
(
ö¢buf
, 
a
->
ª∂a˚mít
,á->
ª∂a˚míéí
);

220 
	`add_n›s
(
ö¢buf
 + 
a
->
ª∂a˚míéí
,

221 
a
->
ö°æí
 -á->
ª∂a˚míéí
);

222 
	`ãxt_poke_óæy
(
ö°r
, 
ö¢buf
, 
a
->
ö°æí
);

224 
	}
}

226 #ifde‡
CONFIG_SMP


228 
	$Æã∫©ives_smp_lock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

230 
u8
 **
±r
;

232 
	`muãx_lock
(&
ãxt_muãx
);

233 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

234 i‡(*
±r
 < 
ãxt
)

236 i‡(*
±r
 > 
ãxt_íd
)

239 
	`ãxt_poke
(*
±r
, (([]){0xf0}), 1);

241 
	`muãx_u∆ock
(&
ãxt_muãx
);

242 
	}
}

244 
	$Æã∫©ives_smp_u∆ock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

246 
u8
 **
±r
;

248 i‡(
n‹ïœ˚_smp
)

251 
	`muãx_lock
(&
ãxt_muãx
);

252 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

253 i‡(*
±r
 < 
ãxt
)

255 i‡(*
±r
 > 
ãxt_íd
)

258 
	`ãxt_poke
(*
±r
, (([]){0x3E}), 1);

260 
	`muãx_u∆ock
(&
ãxt_muãx
);

261 
	}
}

263 
	ssmp_Æt_moduÀ
 {

265 
moduÀ
 *
	mmod
;

266 *
	m«me
;

269 
u8
 **
	mlocks
;

270 
u8
 **
	mlocks_íd
;

273 
u8
 *
	mãxt
;

274 
u8
 *
	mãxt_íd
;

276 
li°_hód
 
	m√xt
;

278 
LIST_HEAD
(
smp_Æt_moduÀs
);

279 
DEFINE_MUTEX
(
smp_Æt
);

280 
	gsmp_mode
 = 1;

282 
	$Æã∫©ives_smp_moduÀ_add
(
moduÀ
 *
mod
, *
«me
,

283 *
locks
, *
locks_íd
,

284 *
ãxt
, *
ãxt_íd
)

286 
smp_Æt_moduÀ
 *
smp
;

288 i‡(
n‹ïœ˚_smp
)

291 i‡(
smp_Æt_⁄˚
) {

292 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

293 
	`Æã∫©ives_smp_u∆ock
(
locks
, 
locks_íd
,

294 
ãxt
, 
ãxt_íd
);

298 
smp
 = 
	`kzÆloc
((*smp), 
GFP_KERNEL
);

299 i‡(
NULL
 =
smp
)

302 
smp
->
mod
 = mod;

303 
smp
->
«me
 =Çame;

304 
smp
->
locks
 =Üocks;

305 
smp
->
locks_íd
 =Üocks_end;

306 
smp
->
ãxt
 =Åext;

307 
smp
->
ãxt_íd
 =Åext_end;

308 
	`DPRINTK
("%s:Üocks %p -> %p,Åext %p -> %p,Çame %s\n",

309 
__func__
, 
smp
->
locks
, smp->
locks_íd
,

310 
smp
->
ãxt
, smp->
ãxt_íd
, smp->
«me
);

312 
	`muãx_lock
(&
smp_Æt
);

313 
	`li°_add_èû
(&
smp
->
√xt
, &
smp_Æt_moduÀs
);

314 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

315 
	`Æã∫©ives_smp_u∆ock
(
smp
->
locks
, smp->
locks_íd
,

316 
smp
->
ãxt
, smp->
ãxt_íd
);

317 
	`muãx_u∆ock
(&
smp_Æt
);

318 
	}
}

320 
	$Æã∫©ives_smp_moduÀ_dñ
(
moduÀ
 *
mod
)

322 
smp_Æt_moduÀ
 *
ôem
;

324 i‡(
smp_Æt_⁄˚
 || 
n‹ïœ˚_smp
)

327 
	`muãx_lock
(&
smp_Æt
);

328 
	`li°_f‹_óch_íåy
(
ôem
, &
smp_Æt_moduÀs
, 
√xt
) {

329 i‡(
mod
 !
ôem
->mod)

331 
	`li°_dñ
(&
ôem
->
√xt
);

332 
	`muãx_u∆ock
(&
smp_Æt
);

333 
	`DPRINTK
("%s: %s\n", 
__func__
, 
ôem
->
«me
);

334 
	`k‰ì
(
ôem
);

337 
	`muãx_u∆ock
(&
smp_Æt
);

338 
	}
}

340 
	$Æã∫©ives_smp_swôch
(
smp
)

342 
smp_Æt_moduÀ
 *
mod
;

344 #ifde‡
CONFIG_LOCKDEP


352 
	`¥ötk
("lockdep: fixing upálternatives.\n");

355 i‡(
n‹ïœ˚_smp
 || 
smp_Æt_⁄˚
)

357 
	`BUG_ON
(!
smp
 && (
	`num_⁄löe_˝us
() > 1));

359 
	`muãx_lock
(&
smp_Æt
);

365 i‡(
smp
 =
smp_mode
) {

367 } i‡(
smp
) {

368 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo SMP code\n");

369 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

370 
	`˛ór_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

371 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

372 
	`Æã∫©ives_smp_lock
(
mod
->
locks
, mod->
locks_íd
,

373 
mod
->
ãxt
, mod->
ãxt_íd
);

375 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

376 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

377 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

378 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

379 
	`Æã∫©ives_smp_u∆ock
(
mod
->
locks
, mod->
locks_íd
,

380 
mod
->
ãxt
, mod->
ãxt_íd
);

382 
smp_mode
 = 
smp
;

383 
	`muãx_u∆ock
(&
smp_Æt
);

384 
	}
}

388 #ifde‡
CONFIG_PARAVIRT


389 
	$≠∂y_∑øvút
(
∑øvút_∑tch_sôe
 *
°¨t
,

390 
∑øvút_∑tch_sôe
 *
íd
)

392 
∑øvút_∑tch_sôe
 *
p
;

393 
ö¢buf
[
MAX_PATCH_LEN
];

395 i‡(
n‹ïœ˚_∑øvút
)

398 
p
 = 
°¨t
;Ö < 
íd
;Ö++) {

399 
u£d
;

401 
	`BUG_ON
(
p
->
Àn
 > 
MAX_PATCH_LEN
);

403 
	`mem˝y
(
ö¢buf
, 
p
->
ö°r
,Ö->
Àn
);

404 
u£d
 = 
pv_öô_›s
.
	`∑tch
(
p
->
ö°πy≥
,Ö->
˛obbîs
, 
ö¢buf
,

405 ()
p
->
ö°r
,Ö->
Àn
);

407 
	`BUG_ON
(
u£d
 > 
p
->
Àn
);

410 
	`add_n›s
(
ö¢buf
 + 
u£d
, 
p
->
Àn
 - used);

411 
	`ãxt_poke_óæy
(
p
->
ö°r
, 
ö¢buf
,Ö->
Àn
);

413 
	}
}

414 
∑øvút_∑tch_sôe
 
__°¨t_∑øö°ru˘i⁄s
[],

415 
__°›_∑øö°ru˘i⁄s
[];

418 
__öô
 
	$Æã∫©ive_ö°ru˘i⁄s
()

423 
	`°›_nmi
();

436 
	`≠∂y_Æã∫©ives
(
__Æt_ö°ru˘i⁄s
, 
__Æt_ö°ru˘i⁄s_íd
);

441 #ifde‡
CONFIG_HOTPLUG_CPU


442 i‡(
	`num_possibÀ_˝us
() < 2)

443 
smp_Æt_⁄˚
 = 1;

446 #ifde‡
CONFIG_SMP


447 i‡(
smp_Æt_⁄˚
) {

448 i‡(1 =
	`num_possibÀ_˝us
()) {

449 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

450 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

451 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

453 
	`Æã∫©ives_smp_u∆ock
(
__smp_locks
, 
__smp_locks_íd
,

454 
_ãxt
, 
_ëext
);

457 
	`Æã∫©ives_smp_moduÀ_add
(
NULL
, "core kernel",

458 
__smp_locks
, 
__smp_locks_íd
,

459 
_ãxt
, 
_ëext
);

462 i‡(
	`num_¥e£¡_˝us
(Ë=1 || 
£tup_max_˝us
 <= 1)

463 
	`Æã∫©ives_smp_swôch
(0);

466 
	`≠∂y_∑øvút
(
__∑øö°ru˘i⁄s
, 
__∑øö°ru˘i⁄s_íd
);

468 i‡(
smp_Æt_⁄˚
)

469 
	`‰ì_öô_∑ges
("SMPálternatives",

470 ()
__smp_locks
,

471 ()
__smp_locks_íd
);

473 
	`ª°¨t_nmi
();

474 
	}
}

488 *
	$ãxt_poke_óæy
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

490 
Êags
;

491 
	`loˇl_úq_ßve
(
Êags
);

492 
	`mem˝y
(
addr
, 
›code
, 
Àn
);

493 
	`loˇl_úq_ª°‹e
(
Êags
);

494 
	`sync_c‹e
();

497  
addr
;

498 
	}
}

513 *
__k¥obes
 
	$ãxt_poke
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

515 
Êags
;

516 *
vaddr
;

517 
∑ge
 *
∑ges
[2];

518 
i
;

520 i‡(!
	`c‹e_kî√l_ãxt
(()
addr
)) {

521 
∑ges
[0] = 
	`vmÆloc_to_∑ge
(
addr
);

522 
∑ges
[1] = 
	`vmÆloc_to_∑ge
(
addr
 + 
PAGE_SIZE
);

524 
∑ges
[0] = 
	`vút_to_∑ge
(
addr
);

525 
	`WARN_ON
(!
	`PageRe£rved
(
∑ges
[0]));

526 
∑ges
[1] = 
	`vút_to_∑ge
(
addr
 + 
PAGE_SIZE
);

528 
	`BUG_ON
(!
∑ges
[0]);

529 
	`loˇl_úq_ßve
(
Êags
);

530 
	`£t_fixm≠
(
FIX_TEXT_POKE0
, 
	`∑ge_to_phys
(
∑ges
[0]));

531 i‡(
∑ges
[1])

532 
	`£t_fixm≠
(
FIX_TEXT_POKE1
, 
	`∑ge_to_phys
(
∑ges
[1]));

533 
vaddr
 = (*)
	`fix_to_vút
(
FIX_TEXT_POKE0
);

534 
	`mem˝y
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
›code
, 
Àn
);

535 
	`˛ór_fixm≠
(
FIX_TEXT_POKE0
);

536 i‡(
∑ges
[1])

537 
	`˛ór_fixm≠
(
FIX_TEXT_POKE1
);

538 
	`loˇl_Êush_éb
();

539 
	`sync_c‹e
();

542 
i
 = 0; i < 
Àn
; i++)

543 
	`BUG_ON
(((*)
addr
)[
i
] !((*)
›code
)[i]);

544 
	`loˇl_úq_ª°‹e
(
Êags
);

545  
addr
;

546 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<löux/pci.h
>

21 
	~<löux/gÂ.h
>

22 
	~<löux/bô›s.h
>

23 
	~<löux/debugfs.h
>

24 
	~<löux/sˇâîli°.h
>

25 
	~<löux/dma-m≠pög.h
>

26 
	~<löux/iommu-hñ≥r.h
>

27 
	~<löux/iommu.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¨t.h
>

31 
	~<asm/amd_iommu_ty≥s.h
>

32 
	~<asm/amd_iommu.h
>

34 
	#CMD_SET_TYPE
(
cmd
, 
t
Ë((cmd)->
d©a
[1] |(—Ë<< 28))

	)

36 
	#EXIT_LOOP_COUNT
 10000000

	)

38 
DEFINE_RWLOCK
(
amd_iommu_devèbÀ_lock
);

41 
LIST_HEAD
(
iommu_pd_li°
);

42 
DEFINE_SPINLOCK
(
iommu_pd_li°_lock
);

44 #ifde‡
CONFIG_IOMMU_API


45 
iommu_›s
 
	gamd_iommu_›s
;

51 
	siommu_cmd
 {

52 
u32
 
	md©a
[4];

55 
dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

56 
unôy_m≠_íåy
 *
e
);

57 
dma_›s_domaö
 *
föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
);

58 
u64
* 
Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
dom
,

59 
addªss
, 
u64


60 **
±e_∑ge
, 
gÂ_t
 
gÂ
);

61 
dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

62 
°¨t_∑ge
,

63 
∑ges
);

65 #i‚de‡
BUS_NOTIFY_UNBOUND_DRIVER


66 
	#BUS_NOTIFY_UNBOUND_DRIVER
 0x0005

	)

69 #ifde‡
CONFIG_AMD_IOMMU_STATS


75 
DECLARE_STATS_COUNTER
(
com∂_waô
);

76 
DECLARE_STATS_COUNTER
(
˙t_m≠_sögÀ
);

77 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

78 
DECLARE_STATS_COUNTER
(
˙t_m≠_sg
);

79 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sg
);

80 
DECLARE_STATS_COUNTER
(
˙t_Æloc_cohîít
);

81 
DECLARE_STATS_COUNTER
(
˙t_‰ì_cohîít
);

82 
DECLARE_STATS_COUNTER
(
¸oss_∑ge
);

83 
DECLARE_STATS_COUNTER
(
domaö_Êush_sögÀ
);

84 
DECLARE_STATS_COUNTER
(
domaö_Êush_Æl
);

85 
DECLARE_STATS_COUNTER
(
Ælo˚d_io_mem
);

86 
DECLARE_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

88 
díåy
 *
	g°©s_dú
;

89 
díåy
 *
	gde_isﬁ©e
;

90 
díåy
 *
	gde_fÊush
;

92 
	$amd_iommu_°©s_add
(
__iommu_cou¡î
 *
˙t
)

94 i‡(
°©s_dú
 =
NULL
)

97 
˙t
->
dít
 = 
	`debugfs_¸óã_u64
(˙t->
«me
, 0444, 
°©s_dú
,

98 &
˙t
->
vÆue
);

99 
	}
}

101 
	$amd_iommu_°©s_öô
()

103 
°©s_dú
 = 
	`debugfs_¸óã_dú
("amd-iommu", 
NULL
);

104 i‡(
°©s_dú
 =
NULL
)

107 
de_isﬁ©e
 = 
	`debugfs_¸óã_boﬁ
("isﬁ©i⁄", 0444, 
°©s_dú
,

108 (
u32
 *)&
amd_iommu_isﬁ©e
);

110 
de_fÊush
 = 
	`debugfs_¸óã_boﬁ
("fuŒÊush", 0444, 
°©s_dú
,

111 (
u32
 *)&
amd_iommu_unm≠_Êush
);

113 
	`amd_iommu_°©s_add
(&
com∂_waô
);

114 
	`amd_iommu_°©s_add
(&
˙t_m≠_sögÀ
);

115 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sögÀ
);

116 
	`amd_iommu_°©s_add
(&
˙t_m≠_sg
);

117 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sg
);

118 
	`amd_iommu_°©s_add
(&
˙t_Æloc_cohîít
);

119 
	`amd_iommu_°©s_add
(&
˙t_‰ì_cohîít
);

120 
	`amd_iommu_°©s_add
(&
¸oss_∑ge
);

121 
	`amd_iommu_°©s_add
(&
domaö_Êush_sögÀ
);

122 
	`amd_iommu_°©s_add
(&
domaö_Êush_Æl
);

123 
	`amd_iommu_°©s_add
(&
Ælo˚d_io_mem
);

124 
	`amd_iommu_°©s_add
(&
tŸÆ_m≠_ªque°s
);

125 
	}
}

130 
	$iommu_has_≈ˇche
(
amd_iommu
 *
iommu
)

132  
iommu
->
ˇp
 & (1UL << 
IOMMU_CAP_NPCACHE
);

133 
	}
}

141 
	$iommu_¥öt_evít
(*
__evt
)

143 
u32
 *
evít
 = 
__evt
;

144 
ty≥
 = (
evít
[1] >> 
EVENT_TYPE_SHIFT
Ë& 
EVENT_TYPE_MASK
;

145 
devid
 = (
evít
[0] >> 
EVENT_DEVID_SHIFT
Ë& 
EVENT_DEVID_MASK
;

146 
domid
 = (
evít
[1] >> 
EVENT_DOMID_SHIFT
Ë& 
EVENT_DOMID_MASK
;

147 
Êags
 = (
evít
[1] >> 
EVENT_FLAGS_SHIFT
Ë& 
EVENT_FLAGS_MASK
;

148 
u64
 
addªss
 = (u64)(((u64)
evít
[3]) << 32) |Évent[2];

150 
	`¥ötk
(
KERN_ERR
 "AMD IOMMU: EventÜogged [");

152 
ty≥
) {

153 
EVENT_TYPE_ILL_DEV
:

154 
	`¥ötk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

156 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

157 
addªss
, 
Êags
);

159 
EVENT_TYPE_IO_FAULT
:

160 
	`¥ötk
("IO_PAGE_FAULT device=%02x:%02x.%x "

162 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

163 
domid
, 
addªss
, 
Êags
);

165 
EVENT_TYPE_DEV_TAB_ERR
:

166 
	`¥ötk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

168 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

169 
addªss
, 
Êags
);

171 
EVENT_TYPE_PAGE_TAB_ERR
:

172 
	`¥ötk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

174 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

175 
domid
, 
addªss
, 
Êags
);

177 
EVENT_TYPE_ILL_CMD
:

178 
	`¥ötk
("ILLEGAL_COMMAND_ERRORáddªss=0x%016Œx]\n", 
addªss
);

180 
EVENT_TYPE_CMD_HARD_ERR
:

181 
	`¥ötk
("COMMAND_HARDWARE_ERRORáddress=0x%016llx "

182 "Êags=0x%04x]\n", 
addªss
, 
Êags
);

184 
EVENT_TYPE_IOTLB_INV_TO
:

185 
	`¥ötk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

187 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

188 
addªss
);

190 
EVENT_TYPE_INV_DEV_REQ
:

191 
	`¥ötk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

193 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

194 
addªss
, 
Êags
);

197 
	`¥ötk
(
KERN_ERR
 "UNKNOWNÅy≥=0x%02x]\n", 
ty≥
);

199 
	}
}

201 
	$iommu_pﬁl_evíts
(
amd_iommu
 *
iommu
)

203 
u32
 
hód
, 
èû
;

204 
Êags
;

206 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

208 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

209 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

211 
hód
 !
èû
) {

212 
	`iommu_¥öt_evít
(
iommu
->
evt_buf
 + 
hód
);

213 
hód
 = (hód + 
EVENT_ENTRY_SIZE
Ë% 
iommu
->
evt_buf_size
;

216 
	`wrôñ
(
hód
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

218 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

219 
	}
}

221 
úqªtu∫_t
 
	$amd_iommu_öt_h™dÀr
(
úq
, *
d©a
)

223 
amd_iommu
 *
iommu
;

225 
	`f‹_óch_iommu
(
iommu
)

226 
	`iommu_pﬁl_evíts
(
iommu
);

228  
IRQ_HANDLED
;

229 
	}
}

241 
	$__iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

243 
u32
 
èû
, 
hód
;

244 
u8
 *
èrgë
;

246 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

247 
èrgë
 = 
iommu
->
cmd_buf
 + 
èû
;

248 
	`mem˝y_toio
(
èrgë
, 
cmd
, (*cmd));

249 
èû
 = (èû + (*
cmd
)Ë% 
iommu
->
cmd_buf_size
;

250 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

251 i‡(
èû
 =
hód
)

252  -
ENOMEM
;

253 
	`wrôñ
(
èû
, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

256 
	}
}

262 
	$iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

264 
Êags
;

265 
ªt
;

267 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

268 
ªt
 = 
	`__iommu_queue_comm™d
(
iommu
, 
cmd
);

269 i‡(!
ªt
)

270 
iommu
->
√ed_sync
 = 
åue
;

271 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

273  
ªt
;

274 
	}
}

280 
	$__iommu_waô_f‹_com∂ëi⁄
(
amd_iommu
 *
iommu
)

282 
ªady
 = 0;

283 
°©us
 = 0;

284 
i
 = 0;

286 
	`INC_STATS_COUNTER
(
com∂_waô
);

288 !
ªady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

289 ++
i
;

291 
°©us
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

292 
ªady
 = 
°©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

296 
°©us
 &~
MMIO_STATUS_COM_WAIT_INT_MASK
;

297 
	`wrôñ
(
°©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

299 i‡(
	`u∆ikñy
(
i
 =
EXIT_LOOP_COUNT
))

300 
	`∑nic
("AMD IOMMU: Completion waitÜoop failed\n");

301 
	}
}

307 
	$__iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

309 
iommu_cmd
 
cmd
;

311 
	`mem£t
(&
cmd
, 0, (cmd));

312 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

313 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

315  
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

316 
	}
}

325 
	$iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

327 
ªt
 = 0;

328 
Êags
;

330 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

332 i‡(!
iommu
->
√ed_sync
)

333 
out
;

335 
ªt
 = 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

337 
iommu
->
√ed_sync
 = 
Ál£
;

339 i‡(
ªt
)

340 
out
;

342 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

344 
out
:

345 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

348 
	}
}

353 
	$iommu_queue_öv_dev_íåy
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

355 
iommu_cmd
 
cmd
;

356 
ªt
;

358 
	`BUG_ON
(
iommu
 =
NULL
);

360 
	`mem£t
(&
cmd
, 0, (cmd));

361 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

362 
cmd
.
d©a
[0] = 
devid
;

364 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

366  
ªt
;

367 
	}
}

369 
	$__iommu_buûd_öv_iommu_∑ges
(
iommu_cmd
 *
cmd
, 
u64
 
addªss
,

370 
u16
 
domid
, 
pde
, 
s
)

372 
	`mem£t
(
cmd
, 0, (*cmd));

373 
addªss
 &
PAGE_MASK
;

374 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

375 
cmd
->
d©a
[1] |
domid
;

376 
cmd
->
d©a
[2] = 
	`lowî_32_bôs
(
addªss
);

377 
cmd
->
d©a
[3] = 
	`uµî_32_bôs
(
addªss
);

378 i‡(
s
)

379 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

380 i‡(
pde
)

381 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_PDE_MASK
;

382 
	}
}

387 
	$iommu_queue_öv_iommu_∑ges
(
amd_iommu
 *
iommu
,

388 
u64
 
addªss
, 
u16
 
domid
, 
pde
, 
s
)

390 
iommu_cmd
 
cmd
;

391 
ªt
;

393 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
addªss
, 
domid
, 
pde
, 
s
);

395 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

397  
ªt
;

398 
	}
}

405 
	$iommu_Êush_∑ges
(
amd_iommu
 *
iommu
, 
u16
 
domid
,

406 
u64
 
addªss
, 
size_t
 
size
)

408 
s
 = 0;

409 
∑ges
 = 
	`iommu_num_∑ges
(
addªss
, 
size
, 
PAGE_SIZE
);

411 
addªss
 &
PAGE_MASK
;

413 i‡(
∑ges
 > 1) {

418 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

419 
s
 = 1;

422 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 0, 
s
);

425 
	}
}

428 
	$iommu_Êush_éb
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

430 
u64
 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

432 
	`INC_STATS_COUNTER
(
domaö_Êush_sögÀ
);

434 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 0, 1);

435 
	}
}

438 
	$iommu_Êush_éb_pde
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

440 
u64
 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

442 
	`INC_STATS_COUNTER
(
domaö_Êush_sögÀ
);

444 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 1, 1);

445 
	}
}

451 
	$iommu_Êush_domaö
(
u16
 
domid
)

453 
Êags
;

454 
amd_iommu
 *
iommu
;

455 
iommu_cmd
 
cmd
;

457 
	`INC_STATS_COUNTER
(
domaö_Êush_Æl
);

459 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
,

460 
domid
, 1, 1);

462 
	`f‹_óch_iommu
(
iommu
) {

463 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

464 
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

465 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

466 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

467 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

469 
	}
}

471 
	$amd_iommu_Êush_Æl_domaös
()

473 
i
;

475 
i
 = 1; i < 
MAX_DOMAIN_ID
; ++i) {

476 i‡(!
	`ã°_bô
(
i
, 
amd_iommu_pd_Æloc_bôm≠
))

478 
	`iommu_Êush_domaö
(
i
);

480 
	}
}

482 
	$amd_iommu_Êush_Æl_devi˚s
()

484 
amd_iommu
 *
iommu
;

485 
i
;

487 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i) {

488 i‡(
amd_iommu_pd_èbÀ
[
i
] =
NULL
)

491 
iommu
 = 
amd_iommu_æookup_èbÀ
[
i
];

492 i‡(!
iommu
)

495 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
i
);

496 
	`iommu_com∂ëi⁄_waô
(
iommu
);

498 
	}
}

514 
	$iommu_m≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

515 
bus_addr
,

516 
phys_addr
,

517 
¥Ÿ
)

519 
u64
 
__±e
, *
±e
;

521 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

522 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

525 i‡(
bus_addr
 > 
IOMMU_MAP_SIZE_L3
 || !(
¥Ÿ
 & 
IOMMU_PROT_MASK
))

526  -
EINVAL
;

528 
±e
 = 
	`Æloc_±e
(
dom
, 
bus_addr
, 
NULL
, 
GFP_KERNEL
);

530 i‡(
	`IOMMU_PTE_PRESENT
(*
±e
))

531  -
EBUSY
;

533 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
;

534 i‡(
¥Ÿ
 & 
IOMMU_PROT_IR
)

535 
__±e
 |
IOMMU_PTE_IR
;

536 i‡(
¥Ÿ
 & 
IOMMU_PROT_IW
)

537 
__±e
 |
IOMMU_PTE_IW
;

539 *
±e
 = 
__±e
;

542 
	}
}

544 
	$iommu_unm≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

545 
bus_addr
)

547 
u64
 *
±e
;

549 
±e
 = &
dom
->
±_roŸ
[
	`IOMMU_PTE_L2_INDEX
(
bus_addr
)];

551 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

554 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

555 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
bus_addr
)];

557 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

560 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

561 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
bus_addr
)];

563 *
±e
 = 0;

564 
	}
}

570 
	$iommu_f‹_unôy_m≠
(
amd_iommu
 *
iommu
,

571 
unôy_m≠_íåy
 *
íåy
)

573 
u16
 
bdf
, 
i
;

575 
i
 = 
íåy
->
devid_°¨t
; i <íåy->
devid_íd
; ++i) {

576 
bdf
 = 
amd_iommu_Æüs_èbÀ
[
i
];

577 i‡(
amd_iommu_æookup_èbÀ
[
bdf
] =
iommu
)

582 
	}
}

590 
	$iommu_öô_unôy_m≠pögs
(
amd_iommu
 *
iommu
)

592 
unôy_m≠_íåy
 *
íåy
;

593 
ªt
;

595 
	`li°_f‹_óch_íåy
(
íåy
, &
amd_iommu_unôy_m≠
, 
li°
) {

596 i‡(!
	`iommu_f‹_unôy_m≠
(
iommu
, 
íåy
))

598 
ªt
 = 
	`dma_›s_unôy_m≠
(
iommu
->
deÁu…_dom
, 
íåy
);

599 i‡(
ªt
)

600  
ªt
;

604 
	}
}

610 
	$dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

611 
unôy_m≠_íåy
 *
e
)

613 
u64
 
addr
;

614 
ªt
;

616 
addr
 = 
e
->
addªss_°¨t
;ádd∏<É->
addªss_íd
;

617 
addr
 +
PAGE_SIZE
) {

618 
ªt
 = 
	`iommu_m≠_∑ge
(&
dma_dom
->
domaö
, 
addr
,áddr, 
e
->
¥Ÿ
);

619 i‡(
ªt
)

620  
ªt
;

625 i‡(
addr
 < 
dma_dom
->
≠îtuª_size
)

626 
	`__£t_bô
(
addr
 >> 
PAGE_SHIFT
,

627 
dma_dom
->
≠îtuª
[0]->
bôm≠
);

631 
	}
}

636 
	$öô_unôy_m≠pögs_f‹_devi˚
(
dma_›s_domaö
 *
dma_dom
,

637 
u16
 
devid
)

639 
unôy_m≠_íåy
 *
e
;

640 
ªt
;

642 
	`li°_f‹_óch_íåy
(
e
, &
amd_iommu_unôy_m≠
, 
li°
) {

643 i‡(!(
devid
 >
e
->
devid_°¨t
 && devid <e->
devid_íd
))

645 
ªt
 = 
	`dma_›s_unôy_m≠
(
dma_dom
, 
e
);

646 i‡(
ªt
)

647  
ªt
;

651 
	}
}

673 
u64
* 
	$„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

674 
addªss
)

676 
u64
 *
±e
;

678 
±e
 = &
domaö
->
±_roŸ
[
	`IOMMU_PTE_L2_INDEX
(
addªss
)];

680 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

681  
NULL
;

683 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

684 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
addªss
)];

686 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

687  
NULL
;

689 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

690 
±e
 = &±e[
	`IOMMU_PTE_L0_INDEX
(
addªss
)];

692  
±e
;

693 
	}
}

700 
	$Æloc_√w_ønge
(
amd_iommu
 *
iommu
,

701 
dma_›s_domaö
 *
dma_dom
,

702 
boﬁ
 
p›uœã
, 
gÂ_t
 
gÂ
)

704 
ödex
 = 
dma_dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

705 
i
;

707 #ifde‡
CONFIG_IOMMU_STRESS


708 
p›uœã
 = 
Ál£
;

711 i‡(
ödex
 >
APERTURE_MAX_RANGES
)

712  -
ENOMEM
;

714 
dma_dom
->
≠îtuª
[
ödex
] = 
	`kzÆloc
((
≠îtuª_ønge
), 
gÂ
);

715 i‡(!
dma_dom
->
≠îtuª
[
ödex
])

716  -
ENOMEM
;

718 
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

719 i‡(!
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
)

720 
out_‰ì
;

722 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 = dma_dom->
≠îtuª_size
;

724 i‡(
p›uœã
) {

725 
addªss
 = 
dma_dom
->
≠îtuª_size
;

726 
i
, 
num_±es
 = 
APERTURE_RANGE_PAGES
 / 512;

727 
u64
 *
±e
, *
±e_∑ge
;

729 
i
 = 0; i < 
num_±es
; ++i) {

730 
±e
 = 
	`Æloc_±e
(&
dma_dom
->
domaö
, 
addªss
,

731 &
±e_∑ge
, 
gÂ
);

732 i‡(!
±e
)

733 
out_‰ì
;

735 
dma_dom
->
≠îtuª
[
ödex
]->
±e_∑ges
[
i
] = 
±e_∑ge
;

737 
addªss
 +
APERTURE_RANGE_SIZE
 / 64;

741 
dma_dom
->
≠îtuª_size
 +
APERTURE_RANGE_SIZE
;

744 i‡(
iommu
->
ex˛usi⁄_°¨t
 &&

745 
iommu
->
ex˛usi⁄_°¨t
 >
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 &&

746 
iommu
->
ex˛usi⁄_°¨t
 < 
dma_dom
->
≠îtuª_size
) {

747 
°¨çage
 = 
iommu
->
ex˛usi⁄_°¨t
 >> 
PAGE_SHIFT
;

748 
∑ges
 = 
	`iommu_num_∑ges
(
iommu
->
ex˛usi⁄_°¨t
,

749 
iommu
->
ex˛usi⁄_Àngth
,

750 
PAGE_SIZE
);

751 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
°¨çage
, 
∑ges
);

760 
i
 = 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
;

761 
i
 < 
dma_dom
->
≠îtuª_size
;

762 
i
 +
PAGE_SIZE
) {

763 
u64
 *
±e
 = 
	`„tch_±e
(&
dma_dom
->
domaö
, 
i
);

764 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

767 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
i
 << 
PAGE_SHIFT
, 1);

772 
out_‰ì
:

773 
	`‰ì_∑ge
(()
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
);

775 
	`k‰ì
(
dma_dom
->
≠îtuª
[
ödex
]);

776 
dma_dom
->
≠îtuª
[
ödex
] = 
NULL
;

778  -
ENOMEM
;

779 
	}
}

781 
	$dma_›s_¨ó_Æloc
(
devi˚
 *
dev
,

782 
dma_›s_domaö
 *
dom
,

783 
∑ges
,

784 
Æign_mask
,

785 
u64
 
dma_mask
,

786 
°¨t
)

788 
√xt_bô
 = 
dom
->
√xt_addªss
 % 
APERTURE_RANGE_SIZE
;

789 
max_ödex
 = 
dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

790 
i
 = 
°¨t
 >> 
APERTURE_RANGE_SHIFT
;

791 
bound¨y_size
;

792 
addªss
 = -1;

793 
limô
;

795 
√xt_bô
 >>
PAGE_SHIFT
;

797 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

798 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

800 ;
i
 < 
max_ödex
; ++i) {

801 
off£t
 = 
dom
->
≠îtuª
[
i
]->off£à>> 
PAGE_SHIFT
;

803 i‡(
dom
->
≠îtuª
[
i
]->
off£t
 >
dma_mask
)

806 
limô
 = 
	`iommu_devi˚_max_ödex
(
APERTURE_RANGE_PAGES
, 
off£t
,

807 
dma_mask
 >> 
PAGE_SHIFT
);

809 
addªss
 = 
	`iommu_¨ó_Æloc
(
dom
->
≠îtuª
[
i
]->
bôm≠
,

810 
limô
, 
√xt_bô
, 
∑ges
, 0,

811 
bound¨y_size
, 
Æign_mask
);

812 i‡(
addªss
 != -1) {

813 
addªss
 = 
dom
->
≠îtuª
[
i
]->
off£t
 +

814 (
addªss
 << 
PAGE_SHIFT
);

815 
dom
->
√xt_addªss
 = 
addªss
 + (
∑ges
 << 
PAGE_SHIFT
);

819 
√xt_bô
 = 0;

822  
addªss
;

823 
	}
}

825 
	$dma_›s_Æloc_addªs£s
(
devi˚
 *
dev
,

826 
dma_›s_domaö
 *
dom
,

827 
∑ges
,

828 
Æign_mask
,

829 
u64
 
dma_mask
)

831 
addªss
;

833 #ifde‡
CONFIG_IOMMU_STRESS


834 
dom
->
√xt_addªss
 = 0;

835 
dom
->
√ed_Êush
 = 
åue
;

838 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

839 
dma_mask
, 
dom
->
√xt_addªss
);

841 i‡(
addªss
 == -1) {

842 
dom
->
√xt_addªss
 = 0;

843 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

844 
dma_mask
, 0);

845 
dom
->
√ed_Êush
 = 
åue
;

848 i‡(
	`u∆ikñy
(
addªss
 == -1))

849 
addªss
 = 
bad_dma_addªss
;

851 
	`WARN_ON
((
addªss
 + (
PAGE_SIZE
*
∑ges
)Ë> 
dom
->
≠îtuª_size
);

853  
addªss
;

854 
	}
}

861 
	$dma_›s_‰ì_addªs£s
(
dma_›s_domaö
 *
dom
,

862 
addªss
,

863 
∑ges
)

865 
i
 = 
addªss
 >> 
APERTURE_RANGE_SHIFT
;

866 
≠îtuª_ønge
 *
ønge
 = 
dom
->
≠îtuª
[
i
];

868 
	`BUG_ON
(
i
 >
APERTURE_MAX_RANGES
 || 
ønge
 =
NULL
);

870 #ifde‡
CONFIG_IOMMU_STRESS


871 i‡(
i
 < 4)

875 i‡(
addªss
 >
dom
->
√xt_addªss
)

876 
dom
->
√ed_Êush
 = 
åue
;

878 
addªss
 = (addªs†% 
APERTURE_RANGE_SIZE
Ë>> 
PAGE_SHIFT
;

880 
	`iommu_¨ó_‰ì
(
ønge
->
bôm≠
, 
addªss
, 
∑ges
);

882 
	}
}

894 
u16
 
	$domaö_id_Æloc
()

896 
Êags
;

897 
id
;

899 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

900 
id
 = 
	`föd_fú°_zîo_bô
(
amd_iommu_pd_Æloc_bôm≠
, 
MAX_DOMAIN_ID
);

901 
	`BUG_ON
(
id
 == 0);

902 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

903 
	`__£t_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

905 
id
 = 0;

906 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

908  
id
;

909 
	}
}

911 
	$domaö_id_‰ì
(
id
)

913 
Êags
;

915 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

916 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

917 
	`__˛ór_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

918 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

919 
	}
}

925 
	$dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

926 
°¨t_∑ge
,

927 
∑ges
)

929 
i
, 
œ°_∑ge
 = 
dom
->
≠îtuª_size
 >> 
PAGE_SHIFT
;

931 i‡(
°¨t_∑ge
 + 
∑ges
 > 
œ°_∑ge
)

932 
∑ges
 = 
œ°_∑ge
 - 
°¨t_∑ge
;

934 
i
 = 
°¨t_∑ge
; i < sèπ_∑gê+ 
∑ges
; ++i) {

935 
ödex
 = 
i
 / 
APERTURE_RANGE_PAGES
;

936 
∑ge
 = 
i
 % 
APERTURE_RANGE_PAGES
;

937 
	`__£t_bô
(
∑ge
, 
dom
->
≠îtuª
[
ödex
]->
bôm≠
);

939 
	}
}

941 
	$‰ì_∑gëabÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

943 
i
, 
j
;

944 
u64
 *
p1
, *
p2
, *
p3
;

946 
p1
 = 
domaö
->
±_roŸ
;

948 i‡(!
p1
)

951 
i
 = 0; i < 512; ++i) {

952 i‡(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

955 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

956 
j
 = 0; j < 512; ++j) {

957 i‡(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

959 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

960 
	`‰ì_∑ge
(()
p3
);

963 
	`‰ì_∑ge
(()
p2
);

966 
	`‰ì_∑ge
(()
p1
);

968 
domaö
->
±_roŸ
 = 
NULL
;

969 
	}
}

975 
	$dma_›s_domaö_‰ì
(
dma_›s_domaö
 *
dom
)

977 
i
;

979 i‡(!
dom
)

982 
	`‰ì_∑gëabÀ
(&
dom
->
domaö
);

984 
i
 = 0; i < 
APERTURE_MAX_RANGES
; ++i) {

985 i‡(!
dom
->
≠îtuª
[
i
])

987 
	`‰ì_∑ge
(()
dom
->
≠îtuª
[
i
]->
bôm≠
);

988 
	`k‰ì
(
dom
->
≠îtuª
[
i
]);

991 
	`k‰ì
(
dom
);

992 
	}
}

999 
dma_›s_domaö
 *
	$dma_›s_domaö_Æloc
(
amd_iommu
 *
iommu
)

1001 
dma_›s_domaö
 *
dma_dom
;

1003 
dma_dom
 = 
	`kzÆloc
((
dma_›s_domaö
), 
GFP_KERNEL
);

1004 i‡(!
dma_dom
)

1005  
NULL
;

1007 
	`•ö_lock_öô
(&
dma_dom
->
domaö
.
lock
);

1009 
dma_dom
->
domaö
.
id
 = 
	`domaö_id_Æloc
();

1010 i‡(
dma_dom
->
domaö
.
id
 == 0)

1011 
‰ì_dma_dom
;

1012 
dma_dom
->
domaö
.
mode
 = 
PAGE_MODE_3_LEVEL
;

1013 
dma_dom
->
domaö
.
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1014 
dma_dom
->
domaö
.
Êags
 = 
PD_DMA_OPS_MASK
;

1015 
dma_dom
->
domaö
.
¥iv
 = dma_dom;

1016 i‡(!
dma_dom
->
domaö
.
±_roŸ
)

1017 
‰ì_dma_dom
;

1019 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1020 
dma_dom
->
èrgë_dev
 = 0xffff;

1022 i‡(
	`Æloc_√w_ønge
(
iommu
, 
dma_dom
, 
åue
, 
GFP_KERNEL
))

1023 
‰ì_dma_dom
;

1029 
dma_dom
->
≠îtuª
[0]->
bôm≠
[0] = 1;

1030 
dma_dom
->
√xt_addªss
 = 0;

1033  
dma_dom
;

1035 
‰ì_dma_dom
:

1036 
	`dma_›s_domaö_‰ì
(
dma_dom
);

1038  
NULL
;

1039 
	}
}

1045 
boﬁ
 
	$dma_›s_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1047  
domaö
->
Êags
 & 
PD_DMA_OPS_MASK
;

1048 
	}
}

1054 
¥Ÿe˘i⁄_domaö
 *
	$domaö_f‹_devi˚
(
u16
 
devid
)

1056 
¥Ÿe˘i⁄_domaö
 *
dom
;

1057 
Êags
;

1059 
	`ªad_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1060 
dom
 = 
amd_iommu_pd_èbÀ
[
devid
];

1061 
	`ªad_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1063  
dom
;

1064 
	}
}

1070 
	$©èch_devi˚
(
amd_iommu
 *
iommu
,

1071 
¥Ÿe˘i⁄_domaö
 *
domaö
,

1072 
u16
 
devid
)

1074 
Êags
;

1075 
u64
 
±e_roŸ
 = 
	`vút_to_phys
(
domaö
->
±_roŸ
);

1077 
domaö
->
dev_˙t
 += 1;

1079 
±e_roŸ
 |(
domaö
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

1080 << 
DEV_ENTRY_MODE_SHIFT
;

1081 
±e_roŸ
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1083 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1084 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
	`lowî_32_bôs
(
±e_roŸ
);

1085 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 
	`uµî_32_bôs
(
±e_roŸ
);

1086 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 
domaö
->
id
;

1088 
amd_iommu_pd_èbÀ
[
devid
] = 
domaö
;

1089 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1096 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

1097 
	`iommu_Êush_éb_pde
(
iommu
, 
domaö
->
id
);

1098 
	}
}

1103 
	$__dëach_devi˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
, 
u16
 
devid
)

1107 
	`•ö_lock
(&
domaö
->
lock
);

1110 
amd_iommu_pd_èbÀ
[
devid
] = 
NULL
;

1113 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1114 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 0;

1115 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 0;

1118 
domaö
->
dev_˙t
 -= 1;

1121 
	`•ö_u∆ock
(&
domaö
->
lock
);

1122 
	}
}

1127 
	$dëach_devi˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
, 
u16
 
devid
)

1129 
Êags
;

1132 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1133 
	`__dëach_devi˚
(
domaö
, 
devid
);

1134 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1135 
	}
}

1137 
	$devi˚_ch™ge_nŸifõr
(
nŸifõr_block
 *
nb
,

1138 
a˘i⁄
, *
d©a
)

1140 
devi˚
 *
dev
 = 
d©a
;

1141 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

1142 
u16
 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

1143 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1144 
dma_›s_domaö
 *
dma_domaö
;

1145 
amd_iommu
 *
iommu
;

1146 
Êags
;

1148 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

1149 
out
;

1151 
devid
 = 
amd_iommu_Æüs_èbÀ
[devid];

1153 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1154 i‡(
iommu
 =
NULL
)

1155 
out
;

1157 
domaö
 = 
	`domaö_f‹_devi˚
(
devid
);

1159 i‡(
domaö
 && !
	`dma_›s_domaö
(domain))

1160 
	`WARN_ONCE
(1, "AMD IOMMU WARNING: device %sálready bound "

1161 "tÿ®n⁄-dma-›†domaö\n", 
	`dev_«me
(
dev
));

1163 
a˘i⁄
) {

1164 
BUS_NOTIFY_UNBOUND_DRIVER
:

1165 i‡(!
domaö
)

1166 
out
;

1167 
	`dëach_devi˚
(
domaö
, 
devid
);

1169 
BUS_NOTIFY_ADD_DEVICE
:

1171 
dma_domaö
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1172 i‡(
dma_domaö
)

1173 
out
;

1174 
dma_domaö
 = 
	`dma_›s_domaö_Æloc
(
iommu
);

1175 i‡(!
dma_domaö
)

1176 
out
;

1177 
dma_domaö
->
èrgë_dev
 = 
devid
;

1179 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1180 
	`li°_add_èû
(&
dma_domaö
->
li°
, &
iommu_pd_li°
);

1181 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1185 
out
;

1188 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

1189 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1191 
out
:

1193 
	}
}

1195 
nŸifõr_block
 
	gdevi˚_nb
 = {

1196 .
nŸifõr_ˇŒ
 = 
devi˚_ch™ge_nŸifõr
,

1209 
boﬁ
 
	$check_devi˚
(
devi˚
 *
dev
)

1211 i‡(!
dev
 || !dev->
dma_mask
)

1212  
Ál£
;

1214  
åue
;

1215 
	}
}

1221 
dma_›s_domaö
 *
	$föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
)

1223 
dma_›s_domaö
 *
íåy
, *
ªt
 = 
NULL
;

1224 
Êags
;

1226 i‡(
	`li°_em±y
(&
iommu_pd_li°
))

1227  
NULL
;

1229 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1231 
	`li°_f‹_óch_íåy
(
íåy
, &
iommu_pd_li°
, 
li°
) {

1232 i‡(
íåy
->
èrgë_dev
 =
devid
) {

1233 
ªt
 = 
íåy
;

1238 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1240  
ªt
;

1241 
	}
}

1250 
	$gë_devi˚_ªsour˚s
(
devi˚
 *
dev
,

1251 
amd_iommu
 **
iommu
,

1252 
¥Ÿe˘i⁄_domaö
 **
domaö
,

1253 
u16
 *
bdf
)

1255 
dma_›s_domaö
 *
dma_dom
;

1256 
pci_dev
 *
pcidev
;

1257 
u16
 
_bdf
;

1259 *
iommu
 = 
NULL
;

1260 *
domaö
 = 
NULL
;

1261 *
bdf
 = 0xffff;

1263 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1266 
pcidev
 = 
	`to_pci_dev
(
dev
);

1267 
_bdf
 = 
	`ˇlc_devid
(
pcidev
->
bus
->
numbî
,Öcidev->
dev‚
);

1270 i‡(
_bdf
 > 
amd_iommu_œ°_bdf
)

1273 *
bdf
 = 
amd_iommu_Æüs_èbÀ
[
_bdf
];

1275 *
iommu
 = 
amd_iommu_æookup_èbÀ
[*
bdf
];

1276 i‡(*
iommu
 =
NULL
)

1278 *
domaö
 = 
	`domaö_f‹_devi˚
(*
bdf
);

1279 i‡(*
domaö
 =
NULL
) {

1280 
dma_dom
 = 
	`föd_¥Ÿe˘i⁄_domaö
(*
bdf
);

1281 i‡(!
dma_dom
)

1282 
dma_dom
 = (*
iommu
)->
deÁu…_dom
;

1283 *
domaö
 = &
dma_dom
->domain;

1284 
	`©èch_devi˚
(*
iommu
, *
domaö
, *
bdf
);

1285 
	`DUMP_¥ötk
("UsingÖrotection domain %d for device %s\n",

1286 (*
domaö
)->
id
, 
	`dev_«me
(
dev
));

1289 i‡(
	`domaö_f‹_devi˚
(
_bdf
Ë=
NULL
)

1290 
	`©èch_devi˚
(*
iommu
, *
domaö
, 
_bdf
);

1293 
	}
}

1298 
u64
* 
	$Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
dom
,

1299 
addªss
, 
u64
 **
±e_∑ge
, 
gÂ_t
 
gÂ
)

1301 
u64
 *
±e
, *
∑ge
;

1303 
±e
 = &
dom
->
±_roŸ
[
	`IOMMU_PTE_L2_INDEX
(
addªss
)];

1305 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

1306 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

1307 i‡(!
∑ge
)

1308  
NULL
;

1309 *
±e
 = 
	`IOMMU_L2_PDE
(
	`vút_to_phys
(
∑ge
));

1312 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

1313 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
addªss
)];

1315 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

1316 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

1317 i‡(!
∑ge
)

1318  
NULL
;

1319 *
±e
 = 
	`IOMMU_L1_PDE
(
	`vút_to_phys
(
∑ge
));

1322 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

1324 i‡(
±e_∑ge
)

1325 *
±e_∑ge
 = 
±e
;

1327 
±e
 = &±e[
	`IOMMU_PTE_L0_INDEX
(
addªss
)];

1329  
±e
;

1330 
	}
}

1335 
u64
* 
	$dma_›s_gë_±e
(
dma_›s_domaö
 *
dom
,

1336 
addªss
)

1338 
≠îtuª_ønge
 *
≠îtuª
;

1339 
u64
 *
±e
, *
±e_∑ge
;

1341 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1342 i‡(!
≠îtuª
)

1343  
NULL
;

1345 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1346 i‡(!
±e
) {

1347 
±e
 = 
	`Æloc_±e
(&
dom
->
domaö
, 
addªss
, &
±e_∑ge
, 
GFP_ATOMIC
);

1348 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)] = 
±e_∑ge
;

1350 
±e
 +
	`IOMMU_PTE_L0_INDEX
(
addªss
);

1352  
±e
;

1353 
	}
}

1359 
dma_addr_t
 
	$dma_›s_domaö_m≠
(
amd_iommu
 *
iommu
,

1360 
dma_›s_domaö
 *
dom
,

1361 
addªss
,

1362 
phys_addr_t
 
∑ddr
,

1363 
dúe˘i⁄
)

1365 
u64
 *
±e
, 
__±e
;

1367 
	`WARN_ON
(
addªss
 > 
dom
->
≠îtuª_size
);

1369 
∑ddr
 &
PAGE_MASK
;

1371 
±e
 = 
	`dma_›s_gë_±e
(
dom
, 
addªss
);

1372 i‡(!
±e
)

1373  
bad_dma_addªss
;

1375 
__±e
 = 
∑ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1377 i‡(
dúe˘i⁄
 =
DMA_TO_DEVICE
)

1378 
__±e
 |
IOMMU_PTE_IR
;

1379 i‡(
dúe˘i⁄
 =
DMA_FROM_DEVICE
)

1380 
__±e
 |
IOMMU_PTE_IW
;

1381 i‡(
dúe˘i⁄
 =
DMA_BIDIRECTIONAL
)

1382 
__±e
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1384 
	`WARN_ON
(*
±e
);

1386 *
±e
 = 
__±e
;

1388  (
dma_addr_t
)
addªss
;

1389 
	}
}

1394 
	$dma_›s_domaö_unm≠
(
amd_iommu
 *
iommu
,

1395 
dma_›s_domaö
 *
dom
,

1396 
addªss
)

1398 
≠îtuª_ønge
 *
≠îtuª
;

1399 
u64
 *
±e
;

1401 i‡(
addªss
 >
dom
->
≠îtuª_size
)

1404 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1405 i‡(!
≠îtuª
)

1408 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1409 i‡(!
±e
)

1412 
±e
 +
	`IOMMU_PTE_L0_INDEX
(
addªss
);

1414 
	`WARN_ON
(!*
±e
);

1416 *
±e
 = 0ULL;

1417 
	}
}

1425 
dma_addr_t
 
	$__m≠_sögÀ
(
devi˚
 *
dev
,

1426 
amd_iommu
 *
iommu
,

1427 
dma_›s_domaö
 *
dma_dom
,

1428 
phys_addr_t
 
∑ddr
,

1429 
size_t
 
size
,

1430 
dú
,

1431 
boﬁ
 
Æign
,

1432 
u64
 
dma_mask
)

1434 
dma_addr_t
 
off£t
 = 
∑ddr
 & ~
PAGE_MASK
;

1435 
dma_addr_t
 
addªss
, 
°¨t
, 
ªt
;

1436 
∑ges
;

1437 
Æign_mask
 = 0;

1438 
i
;

1440 
∑ges
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

1441 
∑ddr
 &
PAGE_MASK
;

1443 
	`INC_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

1445 i‡(
∑ges
 > 1)

1446 
	`INC_STATS_COUNTER
(
¸oss_∑ge
);

1448 i‡(
Æign
)

1449 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

1451 
ªåy
:

1452 
addªss
 = 
	`dma_›s_Æloc_addªs£s
(
dev
, 
dma_dom
, 
∑ges
, 
Æign_mask
,

1453 
dma_mask
);

1454 i‡(
	`u∆ikñy
(
addªss
 =
bad_dma_addªss
)) {

1460 
dma_dom
->
√xt_addªss
 = dma_dom->
≠îtuª_size
;

1462 i‡(
	`Æloc_√w_ønge
(
iommu
, 
dma_dom
, 
Ál£
, 
GFP_ATOMIC
))

1463 
out
;

1469 
ªåy
;

1472 
°¨t
 = 
addªss
;

1473 
i
 = 0; i < 
∑ges
; ++i) {

1474 
ªt
 = 
	`dma_›s_domaö_m≠
(
iommu
, 
dma_dom
, 
°¨t
, 
∑ddr
, 
dú
);

1475 i‡(
ªt
 =
bad_dma_addªss
)

1476 
out_unm≠
;

1478 
∑ddr
 +
PAGE_SIZE
;

1479 
°¨t
 +
PAGE_SIZE
;

1481 
addªss
 +
off£t
;

1483 
	`ADD_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1485 i‡(
	`u∆ikñy
(
dma_dom
->
√ed_Êush
 && !
amd_iommu_unm≠_Êush
)) {

1486 
	`iommu_Êush_éb
(
iommu
, 
dma_dom
->
domaö
.
id
);

1487 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1488 } i‡(
	`u∆ikñy
(
	`iommu_has_≈ˇche
(
iommu
)))

1489 
	`iommu_Êush_∑ges
(
iommu
, 
dma_dom
->
domaö
.
id
, 
addªss
, 
size
);

1491 
out
:

1492  
addªss
;

1494 
out_unm≠
:

1496 --
i
; i >= 0; --i) {

1497 
°¨t
 -
PAGE_SIZE
;

1498 
	`dma_›s_domaö_unm≠
(
iommu
, 
dma_dom
, 
°¨t
);

1501 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
addªss
, 
∑ges
);

1503  
bad_dma_addªss
;

1504 
	}
}

1510 
	$__unm≠_sögÀ
(
amd_iommu
 *
iommu
,

1511 
dma_›s_domaö
 *
dma_dom
,

1512 
dma_addr_t
 
dma_addr
,

1513 
size_t
 
size
,

1514 
dú
)

1516 
dma_addr_t
 
i
, 
°¨t
;

1517 
∑ges
;

1519 i‡((
dma_addr
 =
bad_dma_addªss
) ||

1520 (
dma_addr
 + 
size
 > 
dma_dom
->
≠îtuª_size
))

1523 
∑ges
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1524 
dma_addr
 &
PAGE_MASK
;

1525 
°¨t
 = 
dma_addr
;

1527 
i
 = 0; i < 
∑ges
; ++i) {

1528 
	`dma_›s_domaö_unm≠
(
iommu
, 
dma_dom
, 
°¨t
);

1529 
°¨t
 +
PAGE_SIZE
;

1532 
	`SUB_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1534 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
dma_addr
, 
∑ges
);

1536 i‡(
amd_iommu_unm≠_Êush
 || 
dma_dom
->
√ed_Êush
) {

1537 
	`iommu_Êush_∑ges
(
iommu
, 
dma_dom
->
domaö
.
id
, 
dma_addr
, 
size
);

1538 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1540 
	}
}

1545 
dma_addr_t
 
	$m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

1546 
off£t
, 
size_t
 
size
,

1547 
dma_d©a_dúe˘i⁄
 
dú
,

1548 
dma_©ås
 *
©ås
)

1550 
Êags
;

1551 
amd_iommu
 *
iommu
;

1552 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1553 
u16
 
devid
;

1554 
dma_addr_t
 
addr
;

1555 
u64
 
dma_mask
;

1556 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

1558 
	`INC_STATS_COUNTER
(
˙t_m≠_sögÀ
);

1560 i‡(!
	`check_devi˚
(
dev
))

1561  
bad_dma_addªss
;

1563 
dma_mask
 = *
dev
->dma_mask;

1565 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1567 i‡(
iommu
 =
NULL
 || 
domaö
 == NULL)

1569  (
dma_addr_t
)
∑ddr
;

1571 i‡(!
	`dma_›s_domaö
(
domaö
))

1572  
bad_dma_addªss
;

1574 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1575 
addr
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
, 
∑ddr
, 
size
, 
dú
, 
Ál£
,

1576 
dma_mask
);

1577 i‡(
addr
 =
bad_dma_addªss
)

1578 
out
;

1580 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1582 
out
:

1583 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1585  
addr
;

1586 
	}
}

1591 
	$unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

1592 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

1594 
Êags
;

1595 
amd_iommu
 *
iommu
;

1596 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1597 
u16
 
devid
;

1599 
	`INC_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

1601 i‡(!
	`check_devi˚
(
dev
) ||

1602 !
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1606 i‡(!
	`dma_›s_domaö
(
domaö
))

1609 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1611 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
dma_addr
, 
size
, 
dú
);

1613 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1615 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1616 
	}
}

1622 
	$m≠_sg_no_iommu
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1623 
√Àms
, 
dú
)

1625 
sˇâîli°
 *
s
;

1626 
i
;

1628 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1629 
s
->
dma_addªss
 = (
dma_addr_t
)
	`sg_phys
(s);

1630 
s
->
dma_Àngth
 = s->
Àngth
;

1633  
√Àms
;

1634 
	}
}

1640 
	$m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1641 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1642 
dma_©ås
 *
©ås
)

1644 
Êags
;

1645 
amd_iommu
 *
iommu
;

1646 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1647 
u16
 
devid
;

1648 
i
;

1649 
sˇâîli°
 *
s
;

1650 
phys_addr_t
 
∑ddr
;

1651 
m≠≥d_ñems
 = 0;

1652 
u64
 
dma_mask
;

1654 
	`INC_STATS_COUNTER
(
˙t_m≠_sg
);

1656 i‡(!
	`check_devi˚
(
dev
))

1659 
dma_mask
 = *
dev
->dma_mask;

1661 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1663 i‡(!
iommu
 || !
domaö
)

1664  
	`m≠_sg_no_iommu
(
dev
, 
sgli°
, 
√Àms
, 
dú
);

1666 i‡(!
	`dma_›s_domaö
(
domaö
))

1669 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1671 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1672 
∑ddr
 = 
	`sg_phys
(
s
);

1674 
s
->
dma_addªss
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
,

1675 
∑ddr
, 
s
->
Àngth
, 
dú
, 
Ál£
,

1676 
dma_mask
);

1678 i‡(
s
->
dma_addªss
) {

1679 
s
->
dma_Àngth
 = s->
Àngth
;

1680 
m≠≥d_ñems
++;

1682 
unm≠
;

1685 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1687 
out
:

1688 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1690  
m≠≥d_ñems
;

1691 
unm≠
:

1692 
	`f‹_óch_sg
(
sgli°
, 
s
, 
m≠≥d_ñems
, 
i
) {

1693 i‡(
s
->
dma_addªss
)

1694 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
s
->
dma_addªss
,

1695 
s
->
dma_Àngth
, 
dú
);

1696 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

1699 
m≠≥d_ñems
 = 0;

1701 
out
;

1702 
	}
}

1708 
	$unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1709 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1710 
dma_©ås
 *
©ås
)

1712 
Êags
;

1713 
amd_iommu
 *
iommu
;

1714 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1715 
sˇâîli°
 *
s
;

1716 
u16
 
devid
;

1717 
i
;

1719 
	`INC_STATS_COUNTER
(
˙t_unm≠_sg
);

1721 i‡(!
	`check_devi˚
(
dev
) ||

1722 !
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1725 i‡(!
	`dma_›s_domaö
(
domaö
))

1728 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1730 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1731 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
s
->
dma_addªss
,

1732 
s
->
dma_Àngth
, 
dú
);

1733 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

1736 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1738 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1739 
	}
}

1744 *
	$Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

1745 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

1747 
Êags
;

1748 *
vút_addr
;

1749 
amd_iommu
 *
iommu
;

1750 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1751 
u16
 
devid
;

1752 
phys_addr_t
 
∑ddr
;

1753 
u64
 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

1755 
	`INC_STATS_COUNTER
(
˙t_Æloc_cohîít
);

1757 i‡(!
	`check_devi˚
(
dev
))

1758  
NULL
;

1760 i‡(!
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1761 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

1763 
Êag
 |
__GFP_ZERO
;

1764 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

1765 i‡(!
vút_addr
)

1766  
NULL
;

1768 
∑ddr
 = 
	`vút_to_phys
(
vút_addr
);

1770 i‡(!
iommu
 || !
domaö
) {

1771 *
dma_addr
 = (
dma_addr_t
)
∑ddr
;

1772  
vút_addr
;

1775 i‡(!
	`dma_›s_domaö
(
domaö
))

1776 
out_‰ì
;

1778 i‡(!
dma_mask
)

1779 
dma_mask
 = *
dev
->dma_mask;

1781 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1783 *
dma_addr
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
, 
∑ddr
,

1784 
size
, 
DMA_BIDIRECTIONAL
, 
åue
, 
dma_mask
);

1786 i‡(*
dma_addr
 =
bad_dma_addªss
) {

1787 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1788 
out_‰ì
;

1791 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1793 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1795  
vút_addr
;

1797 
out_‰ì
:

1799 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

1801  
NULL
;

1802 
	}
}

1807 
	$‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

1808 *
vút_addr
, 
dma_addr_t
 
dma_addr
)

1810 
Êags
;

1811 
amd_iommu
 *
iommu
;

1812 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1813 
u16
 
devid
;

1815 
	`INC_STATS_COUNTER
(
˙t_‰ì_cohîít
);

1817 i‡(!
	`check_devi˚
(
dev
))

1820 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1822 i‡(!
iommu
 || !
domaö
)

1823 
‰ì_mem
;

1825 i‡(!
	`dma_›s_domaö
(
domaö
))

1826 
‰ì_mem
;

1828 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1830 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

1832 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1834 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1836 
‰ì_mem
:

1837 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

1838 
	}
}

1844 
	$amd_iommu_dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

1846 
u16
 
bdf
;

1847 
pci_dev
 *
pcidev
;

1850 i‡(!
dev
 || dev->
bus
 !&
pci_bus_ty≥
)

1853 
pcidev
 = 
	`to_pci_dev
(
dev
);

1855 
bdf
 = 
	`ˇlc_devid
(
pcidev
->
bus
->
numbî
,Öcidev->
dev‚
);

1858 i‡(
bdf
 > 
amd_iommu_œ°_bdf
)

1862 
	}
}

1871 
	$¥óŒoc_¥Ÿe˘i⁄_domaös
()

1873 
pci_dev
 *
dev
 = 
NULL
;

1874 
dma_›s_domaö
 *
dma_dom
;

1875 
amd_iommu
 *
iommu
;

1876 
u16
 
devid
;

1878 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

1879 
devid
 = 
	`ˇlc_devid
(
dev
->
bus
->
numbî
, dev->
dev‚
);

1880 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

1882 
devid
 = 
amd_iommu_Æüs_èbÀ
[devid];

1883 i‡(
	`domaö_f‹_devi˚
(
devid
))

1885 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1886 i‡(!
iommu
)

1888 
dma_dom
 = 
	`dma_›s_domaö_Æloc
(
iommu
);

1889 i‡(!
dma_dom
)

1891 
	`öô_unôy_m≠pögs_f‹_devi˚
(
dma_dom
, 
devid
);

1892 
dma_dom
->
èrgë_dev
 = 
devid
;

1894 
	`li°_add_èû
(&
dma_dom
->
li°
, &
iommu_pd_li°
);

1896 
	}
}

1898 
dma_m≠_›s
 
	gamd_iommu_dma_›s
 = {

1899 .
Æloc_cohîít
 =álloc_coherent,

1900 .
	g‰ì_cohîít
 = 
‰ì_cohîít
,

1901 .
	gm≠_∑ge
 = 
m≠_∑ge
,

1902 .
	gunm≠_∑ge
 = 
unm≠_∑ge
,

1903 .
	gm≠_sg
 = 
m≠_sg
,

1904 .
	gunm≠_sg
 = 
unm≠_sg
,

1905 .
	gdma_suµ‹ãd
 = 
amd_iommu_dma_suµ‹ãd
,

1911 
__öô
 
	$amd_iommu_öô_dma_›s
()

1913 
amd_iommu
 *
iommu
;

1914 
ªt
;

1921 
	`f‹_óch_iommu
(
iommu
) {

1922 
iommu
->
deÁu…_dom
 = 
	`dma_›s_domaö_Æloc
(iommu);

1923 i‡(
iommu
->
deÁu…_dom
 =
NULL
)

1924  -
ENOMEM
;

1925 
iommu
->
deÁu…_dom
->
domaö
.
Êags
 |
PD_DEFAULT_MASK
;

1926 
ªt
 = 
	`iommu_öô_unôy_m≠pögs
(
iommu
);

1927 i‡(
ªt
)

1928 
‰ì_domaös
;

1935 i‡(
amd_iommu_isﬁ©e
)

1936 
	`¥óŒoc_¥Ÿe˘i⁄_domaös
();

1938 
iommu_dëe˘ed
 = 1;

1939 
f‹˚_iommu
 = 1;

1940 
bad_dma_addªss
 = 0;

1941 #ifde‡
CONFIG_GART_IOMMU


1942 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

1943 
g¨t_iommu_≠îtuª
 = 0;

1947 
dma_›s
 = &
amd_iommu_dma_›s
;

1949 
	`ªgi°î_iommu
(&
amd_iommu_›s
);

1951 
	`bus_ªgi°î_nŸifõr
(&
pci_bus_ty≥
, &
devi˚_nb
);

1953 
	`amd_iommu_°©s_öô
();

1957 
‰ì_domaös
:

1959 
	`f‹_óch_iommu
(
iommu
) {

1960 i‡(
iommu
->
deÁu…_dom
)

1961 
	`dma_›s_domaö_‰ì
(
iommu
->
deÁu…_dom
);

1964  
ªt
;

1965 
	}
}

1977 
	$˛ónup_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1979 
Êags
;

1980 
u16
 
devid
;

1982 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1984 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid)

1985 i‡(
amd_iommu_pd_èbÀ
[
devid
] =
domaö
)

1986 
	`__dëach_devi˚
(
domaö
, 
devid
);

1988 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1989 
	}
}

1991 
	$amd_iommu_domaö_öô
(
iommu_domaö
 *
dom
)

1993 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1995 
domaö
 = 
	`kzÆloc
((*domaö), 
GFP_KERNEL
);

1996 i‡(!
domaö
)

1997  -
ENOMEM
;

1999 
	`•ö_lock_öô
(&
domaö
->
lock
);

2000 
domaö
->
mode
 = 
PAGE_MODE_3_LEVEL
;

2001 
domaö
->
id
 = 
	`domaö_id_Æloc
();

2002 i‡(!
domaö
->
id
)

2003 
out_‰ì
;

2004 
domaö
->
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

2005 i‡(!
domaö
->
±_roŸ
)

2006 
out_‰ì
;

2008 
dom
->
¥iv
 = 
domaö
;

2012 
out_‰ì
:

2013 
	`k‰ì
(
domaö
);

2015  -
ENOMEM
;

2016 
	}
}

2018 
	$amd_iommu_domaö_de°roy
(
iommu_domaö
 *
dom
)

2020 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2022 i‡(!
domaö
)

2025 i‡(
domaö
->
dev_˙t
 > 0)

2026 
	`˛ónup_domaö
(
domaö
);

2028 
	`BUG_ON
(
domaö
->
dev_˙t
 != 0);

2030 
	`‰ì_∑gëabÀ
(
domaö
);

2032 
	`domaö_id_‰ì
(
domaö
->
id
);

2034 
	`k‰ì
(
domaö
);

2036 
dom
->
¥iv
 = 
NULL
;

2037 
	}
}

2039 
	$amd_iommu_dëach_devi˚
(
iommu_domaö
 *
dom
,

2040 
devi˚
 *
dev
)

2042 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2043 
amd_iommu
 *
iommu
;

2044 
pci_dev
 *
pdev
;

2045 
u16
 
devid
;

2047 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

2050 
pdev
 = 
	`to_pci_dev
(
dev
);

2052 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

2054 i‡(
devid
 > 0)

2055 
	`dëach_devi˚
(
domaö
, 
devid
);

2057 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2058 i‡(!
iommu
)

2061 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

2062 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2063 
	}
}

2065 
	$amd_iommu_©èch_devi˚
(
iommu_domaö
 *
dom
,

2066 
devi˚
 *
dev
)

2068 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2069 
¥Ÿe˘i⁄_domaö
 *
ﬁd_domaö
;

2070 
amd_iommu
 *
iommu
;

2071 
pci_dev
 *
pdev
;

2072 
u16
 
devid
;

2074 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

2075  -
EINVAL
;

2077 
pdev
 = 
	`to_pci_dev
(
dev
);

2079 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

2081 i‡(
devid
 >
amd_iommu_œ°_bdf
 ||

2082 
devid
 !
amd_iommu_Æüs_èbÀ
[devid])

2083  -
EINVAL
;

2085 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2086 i‡(!
iommu
)

2087  -
EINVAL
;

2089 
ﬁd_domaö
 = 
	`domaö_f‹_devi˚
(
devid
);

2090 i‡(
ﬁd_domaö
)

2091 
	`dëach_devi˚
(
ﬁd_domaö
, 
devid
);

2093 
	`©èch_devi˚
(
iommu
, 
domaö
, 
devid
);

2095 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2098 
	}
}

2100 
	$amd_iommu_m≠_ønge
(
iommu_domaö
 *
dom
,

2101 
iova
, 
phys_addr_t
 
∑ddr
,

2102 
size_t
 
size
, 
iommu_¥Ÿ
)

2104 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2105 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

2106 
¥Ÿ
 = 0;

2107 
ªt
;

2109 i‡(
iommu_¥Ÿ
 & 
IOMMU_READ
)

2110 
¥Ÿ
 |
IOMMU_PROT_IR
;

2111 i‡(
iommu_¥Ÿ
 & 
IOMMU_WRITE
)

2112 
¥Ÿ
 |
IOMMU_PROT_IW
;

2114 
iova
 &
PAGE_MASK
;

2115 
∑ddr
 &
PAGE_MASK
;

2117 
i
 = 0; i < 
≈ages
; ++i) {

2118 
ªt
 = 
	`iommu_m≠_∑ge
(
domaö
, 
iova
, 
∑ddr
, 
¥Ÿ
);

2119 i‡(
ªt
)

2120  
ªt
;

2122 
iova
 +
PAGE_SIZE
;

2123 
∑ddr
 +
PAGE_SIZE
;

2127 
	}
}

2129 
	$amd_iommu_unm≠_ønge
(
iommu_domaö
 *
dom
,

2130 
iova
, 
size_t
 
size
)

2133 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2134 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
iova
, 
size
, 
PAGE_SIZE
);

2136 
iova
 &
PAGE_MASK
;

2138 
i
 = 0; i < 
≈ages
; ++i) {

2139 
	`iommu_unm≠_∑ge
(
domaö
, 
iova
);

2140 
iova
 +
PAGE_SIZE
;

2143 
	`iommu_Êush_domaö
(
domaö
->
id
);

2144 
	}
}

2146 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaö
 *
dom
,

2147 
iova
)

2149 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2150 
off£t
 = 
iova
 & ~
PAGE_MASK
;

2151 
phys_addr_t
 
∑ddr
;

2152 
u64
 *
±e
;

2154 
±e
 = &
domaö
->
±_roŸ
[
	`IOMMU_PTE_L2_INDEX
(
iova
)];

2156 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

2159 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

2160 
±e
 = &±e[
	`IOMMU_PTE_L1_INDEX
(
iova
)];

2162 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

2165 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

2166 
±e
 = &±e[
	`IOMMU_PTE_L0_INDEX
(
iova
)];

2168 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

2171 
∑ddr
 = *
±e
 & 
IOMMU_PAGE_MASK
;

2172 
∑ddr
 |
off£t
;

2174  
∑ddr
;

2175 
	}
}

2177 
	$amd_iommu_domaö_has_ˇp
(
iommu_domaö
 *
domaö
,

2178 
ˇp
)

2181 
	}
}

2183 
iommu_›s
 
	gamd_iommu_›s
 = {

2184 .
domaö_öô
 = 
amd_iommu_domaö_öô
,

2185 .
	gdomaö_de°roy
 = 
amd_iommu_domaö_de°roy
,

2186 .
	g©èch_dev
 = 
amd_iommu_©èch_devi˚
,

2187 .
	gdëach_dev
 = 
amd_iommu_dëach_devi˚
,

2188 .
	gm≠
 = 
amd_iommu_m≠_ønge
,

2189 .
	gunm≠
 = 
amd_iommu_unm≠_ønge
,

2190 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

2191 .
	gdomaö_has_ˇp
 = 
amd_iommu_domaö_has_ˇp
,

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<löux/pci.h
>

21 
	~<löux/a˝i.h
>

22 
	~<löux/gÂ.h
>

23 
	~<löux/li°.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/msi.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/amd_iommu_ty≥s.h
>

29 
	~<asm/amd_iommu.h
>

30 
	~<asm/iommu.h
>

31 
	~<asm/g¨t.h
>

36 
	#IVRS_HEADER_LENGTH
 48

	)

38 
	#ACPI_IVHD_TYPE
 0x10

	)

39 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

40 
	#ACPI_IVMD_TYPE
 0x21

	)

41 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

43 
	#IVHD_DEV_ALL
 0x01

	)

44 
	#IVHD_DEV_SELECT
 0x02

	)

45 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

46 
	#IVHD_DEV_RANGE_END
 0x04

	)

47 
	#IVHD_DEV_ALIAS
 0x42

	)

48 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

49 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

50 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

52 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

53 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

54 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

55 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

57 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

58 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

60 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

61 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

62 
	#ACPI_DEVFLAG_NMI
 0x04

	)

63 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

64 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

65 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

66 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

67 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

80 
	sivhd_hódî
 {

81 
u8
 
	mty≥
;

82 
u8
 
	mÊags
;

83 
u16
 
	mÀngth
;

84 
u16
 
	mdevid
;

85 
u16
 
	mˇp_±r
;

86 
u64
 
	mmmio_phys
;

87 
u16
 
	mpci_£g
;

88 
u16
 
	möfo
;

89 
u32
 
	mª£rved
;

90 } 
__©åibuã__
((
∑cked
));

96 
	sivhd_íåy
 {

97 
u8
 
	mty≥
;

98 
u16
 
	mdevid
;

99 
u8
 
	mÊags
;

100 
u32
 
	mext
;

101 } 
__©åibuã__
((
∑cked
));

107 
	sivmd_hódî
 {

108 
u8
 
	mty≥
;

109 
u8
 
	mÊags
;

110 
u16
 
	mÀngth
;

111 
u16
 
	mdevid
;

112 
u16
 
	maux
;

113 
u64
 
	mªsv
;

114 
u64
 
	mønge_°¨t
;

115 
u64
 
	mønge_Àngth
;

116 } 
__©åibuã__
((
∑cked
));

118 
boﬁ
 
	gamd_iommu_dump
;

120 
__öôd©a
 
	gamd_iommu_dëe˘ed
;

122 
u16
 
	gamd_iommu_œ°_bdf
;

124 
LIST_HEAD
(
amd_iommu_unôy_m≠
);

126 #ifde‡
CONFIG_IOMMU_STRESS


127 
boﬁ
 
	gamd_iommu_isﬁ©e
 = 
Ál£
;

129 
boﬁ
 
	gamd_iommu_isﬁ©e
 = 
åue
;

133 
boﬁ
 
	gamd_iommu_unm≠_Êush
;

135 
LIST_HEAD
(
amd_iommu_li°
);

144 
dev_èbÀ_íåy
 *
	gamd_iommu_dev_èbÀ
;

151 
u16
 *
	gamd_iommu_Æüs_èbÀ
;

157 
amd_iommu
 **
	gamd_iommu_æookup_èbÀ
;

163 
¥Ÿe˘i⁄_domaö
 **
	gamd_iommu_pd_èbÀ
;

169 *
	gamd_iommu_pd_Æloc_bôm≠
;

171 
u32
 
	gdev_èbÀ_size
;

172 
u32
 
	gÆüs_èbÀ_size
;

173 
u32
 
	gæookup_èbÀ_size
;

175 
ölöe
 
	$upd©e_œ°_devid
(
u16
 
devid
)

177 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

178 
amd_iommu_œ°_bdf
 = 
devid
;

179 
	}
}

181 
ölöe
 
	$tbl_size
(
íåy_size
)

183 
shi·
 = 
PAGE_SHIFT
 +

184 
	`gë_‹dî
((()
amd_iommu_œ°_bdf
 + 1Ë* 
íåy_size
);

186  1UL << 
shi·
;

187 
	}
}

202 
	$iommu_£t_ex˛usi⁄_ønge
(
amd_iommu
 *
iommu
)

204 
u64
 
°¨t
 = 
iommu
->
ex˛usi⁄_°¨t
 & 
PAGE_MASK
;

205 
u64
 
limô
 = (
°¨t
 + 
iommu
->
ex˛usi⁄_Àngth
Ë& 
PAGE_MASK
;

206 
u64
 
íåy
;

208 i‡(!
iommu
->
ex˛usi⁄_°¨t
)

211 
íåy
 = 
°¨t
 | 
MMIO_EXCL_ENABLE_MASK
;

212 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

213 &
íåy
, (entry));

215 
íåy
 = 
limô
;

216 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

217 &
íåy
, (entry));

218 
	}
}

221 
__öô
 
	$iommu_£t_devi˚_èbÀ
(
amd_iommu
 *
iommu
)

223 
u64
 
íåy
;

225 
	`BUG_ON
(
iommu
->
mmio_ba£
 =
NULL
);

227 
íåy
 = 
	`vút_to_phys
(
amd_iommu_dev_èbÀ
);

228 
íåy
 |(
dev_èbÀ_size
 >> 12) - 1;

229 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

230 &
íåy
, (entry));

231 
	}
}

234 
	$iommu_„©uª_íabÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

236 
u32
 
˘æ
;

238 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

239 
˘æ
 |(1 << 
bô
);

240 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

241 
	}
}

243 
__öô
 
	$iommu_„©uª_dißbÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

245 
u32
 
˘æ
;

247 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

248 
˘æ
 &~(1 << 
bô
);

249 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

250 
	}
}

253 
	$iommu_íabÀ
(
amd_iommu
 *
iommu
)

255 
	`¥ötk
(
KERN_INFO
 "AMD IOMMU: Enabling IOMMUát %s cap 0x%hx\n",

256 
	`dev_«me
(&
iommu
->
dev
->dev), iommu->
ˇp_±r
);

258 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

259 
	}
}

261 
	$iommu_dißbÀ
(
amd_iommu
 *
iommu
)

264 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

267 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

268 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

271 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

272 
	}
}

278 
u8
 * 
__öô
 
	$iommu_m≠_mmio_•a˚
(
u64
 
addªss
)

280 
u8
 *
ªt
;

282 i‡(!
	`ªque°_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
, "amd_iommu"))

283  
NULL
;

285 
ªt
 = 
	`i‹em≠_noˇche
(
addªss
, 
MMIO_REGION_LENGTH
);

286 i‡(
ªt
 !
NULL
)

287  
ªt
;

289 
	`ªÀa£_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
);

291  
NULL
;

292 
	}
}

294 
__öô
 
	$iommu_unm≠_mmio_•a˚
(
amd_iommu
 *
iommu
)

296 i‡(
iommu
->
mmio_ba£
)

297 
	`iounm≠
(
iommu
->
mmio_ba£
);

298 
	`ªÀa£_mem_ªgi⁄
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

299 
	}
}

313 
ölöe
 
	$ivhd_íåy_Àngth
(
u8
 *
ivhd
)

315  0x04 << (*
ivhd
 >> 6);

316 
	}
}

322 
__öô
 
	$föd_œ°_devid_⁄_pci
(
bus
, 
dev
, 
‚
, 
ˇp_±r
)

324 
u32
 
ˇp
;

326 
ˇp
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 
‚
, 
ˇp_±r
+
MMIO_RANGE_OFFSET
);

327 
	`upd©e_œ°_devid
(
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ˇp
), 
	`MMIO_GET_LD
(cap)));

330 
	}
}

336 
__öô
 
	$föd_œ°_devid_‰om_ivhd
(
ivhd_hódî
 *
h
)

338 
u8
 *
p
 = (*)
h
, *
íd
 = (*)h;

339 
ivhd_íåy
 *
dev
;

341 
p
 +(*
h
);

342 
íd
 +
h
->
Àngth
;

344 
	`föd_œ°_devid_⁄_pci
(
	`PCI_BUS
(
h
->
devid
),

345 
	`PCI_SLOT
(
h
->
devid
),

346 
	`PCI_FUNC
(
h
->
devid
),

347 
h
->
ˇp_±r
);

349 
p
 < 
íd
) {

350 
dev
 = (
ivhd_íåy
 *)
p
;

351 
dev
->
ty≥
) {

352 
IVHD_DEV_SELECT
:

353 
IVHD_DEV_RANGE_END
:

354 
IVHD_DEV_ALIAS
:

355 
IVHD_DEV_EXT_SELECT
:

357 
	`upd©e_œ°_devid
(
dev
->
devid
);

362 
p
 +
	`ivhd_íåy_Àngth
(p);

365 
	`WARN_ON
(
p
 !
íd
);

368 
	}
}

375 
__öô
 
	$föd_œ°_devid_a˝i
(
a˝i_èbÀ_hódî
 *
èbÀ
)

377 
i
;

378 
u8
 
checksum
 = 0, *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

379 
ivhd_hódî
 *
h
;

385 
i
 = 0; i < 
èbÀ
->
Àngth
; ++i)

386 
checksum
 +
p
[
i
];

387 i‡(
checksum
 != 0)

389  -
ENODEV
;

391 
p
 +
IVRS_HEADER_LENGTH
;

393 
íd
 +
èbÀ
->
Àngth
;

394 
p
 < 
íd
) {

395 
h
 = (
ivhd_hódî
 *)
p
;

396 
h
->
ty≥
) {

397 
ACPI_IVHD_TYPE
:

398 
	`föd_œ°_devid_‰om_ivhd
(
h
);

403 
p
 +
h
->
Àngth
;

405 
	`WARN_ON
(
p
 !
íd
);

408 
	}
}

424 
u8
 * 
__öô
 
	$Æloc_comm™d_buf„r
(
amd_iommu
 *
iommu
)

426 
u8
 *
cmd_buf
 = (u8 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

427 
	`gë_‹dî
(
CMD_BUFFER_SIZE
));

429 i‡(
cmd_buf
 =
NULL
)

430  
NULL
;

432 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
;

434  
cmd_buf
;

435 
	}
}

441 
	$iommu_íabÀ_comm™d_buf„r
(
amd_iommu
 *
iommu
)

443 
u64
 
íåy
;

445 
	`BUG_ON
(
iommu
->
cmd_buf
 =
NULL
);

447 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
cmd_buf
);

448 
íåy
 |
MMIO_CMD_SIZE_512
;

450 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

451 &
íåy
, (entry));

454 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

455 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

457 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

458 
	}
}

460 
__öô
 
	$‰ì_comm™d_buf„r
(
amd_iommu
 *
iommu
)

462 
	`‰ì_∑ges
(()
iommu
->
cmd_buf
,

463 
	`gë_‹dî
(
iommu
->
cmd_buf_size
));

464 
	}
}

467 
u8
 * 
__öô
 
	$Æloc_evít_buf„r
(
amd_iommu
 *
iommu
)

469 
iommu
->
evt_buf
 = (
u8
 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

470 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

472 i‡(
iommu
->
evt_buf
 =
NULL
)

473  
NULL
;

475 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

477  
iommu
->
evt_buf
;

478 
	}
}

480 
	$iommu_íabÀ_evít_buf„r
(
amd_iommu
 *
iommu
)

482 
u64
 
íåy
;

484 
	`BUG_ON
(
iommu
->
evt_buf
 =
NULL
);

486 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
evt_buf
Ë| 
EVT_LEN_MASK
;

488 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

489 &
íåy
, (entry));

492 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

493 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

495 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

496 
	}
}

498 
__öô
 
	$‰ì_evít_buf„r
(
amd_iommu
 *
iommu
)

500 
	`‰ì_∑ges
(()
iommu
->
evt_buf
, 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

501 
	}
}

504 
	$£t_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

506 
i
 = (
bô
 >> 5) & 0x07;

507 
_bô
 = 
bô
 & 0x1f;

509 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] |(1 << 
_bô
);

510 
	}
}

513 
__öô
 
	$£t_iommu_f‹_devi˚
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

515 
amd_iommu_æookup_èbÀ
[
devid
] = 
iommu
;

516 
	}
}

522 
__öô
 
	$£t_dev_íåy_‰om_a˝i
(
amd_iommu
 *
iommu
,

523 
u16
 
devid
, 
u32
 
Êags
, u32 
ext_Êags
)

525 i‡(
Êags
 & 
ACPI_DEVFLAG_INITPASS
)

526 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_INIT_PASS
);

527 i‡(
Êags
 & 
ACPI_DEVFLAG_EXTINT
)

528 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_EINT_PASS
);

529 i‡(
Êags
 & 
ACPI_DEVFLAG_NMI
)

530 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_NMI_PASS
);

531 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT1
)

532 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
);

533 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT2
)

534 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
);

535 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT0
)

536 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

537 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT1
)

538 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

540 
	`£t_iommu_f‹_devi˚
(
iommu
, 
devid
);

541 
	}
}

547 
__öô
 
	$£t_devi˚_ex˛usi⁄_ønge
(
u16
 
devid
, 
ivmd_hódî
 *
m
)

549 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

551 i‡(!(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
))

554 i‡(
iommu
) {

560 
	`£t_dev_íåy_bô
(
m
->
devid
, 
DEV_ENTRY_EX
);

561 
iommu
->
ex˛usi⁄_°¨t
 = 
m
->
ønge_°¨t
;

562 
iommu
->
ex˛usi⁄_Àngth
 = 
m
->
ønge_Àngth
;

564 
	}
}

571 
__öô
 
	$öô_iommu_‰om_pci
(
amd_iommu
 *
iommu
)

573 
ˇp_±r
 = 
iommu
->cap_ptr;

574 
u32
 
ønge
, 
misc
;

576 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

577 &
iommu
->
ˇp
);

578 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_RANGE_OFFSET
,

579 &
ønge
);

580 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_MISC_OFFSET
,

581 &
misc
);

583 
iommu
->
fú°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

584 
	`MMIO_GET_FD
(
ønge
));

585 
iommu
->
œ°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

586 
	`MMIO_GET_LD
(
ønge
));

587 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

588 
	}
}

594 
__öô
 
	$öô_iommu_‰om_a˝i
(
amd_iommu
 *
iommu
,

595 
ivhd_hódî
 *
h
)

597 
u8
 *
p
 = (u8 *)
h
;

598 
u8
 *
íd
 = 
p
, 
Êags
 = 0;

599 
u16
 
dev_i
, 
devid
 = 0, 
devid_°¨t
 = 0, 
devid_to
 = 0;

600 
u32
 
ext_Êags
 = 0;

601 
boﬁ
 
Æüs
 = 
Ál£
;

602 
ivhd_íåy
 *
e
;

608 
h
->
Êags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

609 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_HT_TUN_EN
) :

610 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_HT_TUN_EN
);

612 
h
->
Êags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

613 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_PASSPW_EN
) :

614 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_PASSPW_EN
);

616 
h
->
Êags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

617 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

618 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
);

620 
h
->
Êags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

621 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_ISOC_EN
) :

622 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_ISOC_EN
);

627 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_COHERENT_EN
);

632 
p
 +(
ivhd_hódî
);

633 
íd
 +
h
->
Àngth
;

636 
p
 < 
íd
) {

637 
e
 = (
ivhd_íåy
 *)
p
;

638 
e
->
ty≥
) {

639 
IVHD_DEV_ALL
:

641 
	`DUMP_¥ötk
(" DEV_ALL\t\t\t first devid: %02x:%02x.%x"

643 
	`PCI_BUS
(
iommu
->
fú°_devi˚
),

644 
	`PCI_SLOT
(
iommu
->
fú°_devi˚
),

645 
	`PCI_FUNC
(
iommu
->
fú°_devi˚
),

646 
	`PCI_BUS
(
iommu
->
œ°_devi˚
),

647 
	`PCI_SLOT
(
iommu
->
œ°_devi˚
),

648 
	`PCI_FUNC
(
iommu
->
œ°_devi˚
),

649 
e
->
Êags
);

651 
dev_i
 = 
iommu
->
fú°_devi˚
;

652 
dev_i
 <
iommu
->
œ°_devi˚
; ++dev_i)

653 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

654 
e
->
Êags
, 0);

656 
IVHD_DEV_SELECT
:

658 
	`DUMP_¥ötk
(" DEV_SELECT\t\t\t devid: %02x:%02x.%x "

660 
	`PCI_BUS
(
e
->
devid
),

661 
	`PCI_SLOT
(
e
->
devid
),

662 
	`PCI_FUNC
(
e
->
devid
),

663 
e
->
Êags
);

665 
devid
 = 
e
->devid;

666 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
, 0);

668 
IVHD_DEV_SELECT_RANGE_START
:

670 
	`DUMP_¥ötk
(" DEV_SELECT_RANGE_START\t "

672 
	`PCI_BUS
(
e
->
devid
),

673 
	`PCI_SLOT
(
e
->
devid
),

674 
	`PCI_FUNC
(
e
->
devid
),

675 
e
->
Êags
);

677 
devid_°¨t
 = 
e
->
devid
;

678 
Êags
 = 
e
->flags;

679 
ext_Êags
 = 0;

680 
Æüs
 = 
Ál£
;

682 
IVHD_DEV_ALIAS
:

684 
	`DUMP_¥ötk
(" DEV_ALIAS\t\t\t devid: %02x:%02x.%x "

686 
	`PCI_BUS
(
e
->
devid
),

687 
	`PCI_SLOT
(
e
->
devid
),

688 
	`PCI_FUNC
(
e
->
devid
),

689 
e
->
Êags
,

690 
	`PCI_BUS
(
e
->
ext
 >> 8),

691 
	`PCI_SLOT
(
e
->
ext
 >> 8),

692 
	`PCI_FUNC
(
e
->
ext
 >> 8));

694 
devid
 = 
e
->devid;

695 
devid_to
 = 
e
->
ext
 >> 8;

696 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
 , 
e
->
Êags
, 0);

697 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid_to
, 
e
->
Êags
, 0);

698 
amd_iommu_Æüs_èbÀ
[
devid
] = 
devid_to
;

700 
IVHD_DEV_ALIAS_RANGE
:

702 
	`DUMP_¥ötk
(" DEV_ALIAS_RANGE\t\t "

705 
	`PCI_BUS
(
e
->
devid
),

706 
	`PCI_SLOT
(
e
->
devid
),

707 
	`PCI_FUNC
(
e
->
devid
),

708 
e
->
Êags
,

709 
	`PCI_BUS
(
e
->
ext
 >> 8),

710 
	`PCI_SLOT
(
e
->
ext
 >> 8),

711 
	`PCI_FUNC
(
e
->
ext
 >> 8));

713 
devid_°¨t
 = 
e
->
devid
;

714 
Êags
 = 
e
->flags;

715 
devid_to
 = 
e
->
ext
 >> 8;

716 
ext_Êags
 = 0;

717 
Æüs
 = 
åue
;

719 
IVHD_DEV_EXT_SELECT
:

721 
	`DUMP_¥ötk
(" DEV_EXT_SELECT\t\t devid: %02x:%02x.%x "

723 
	`PCI_BUS
(
e
->
devid
),

724 
	`PCI_SLOT
(
e
->
devid
),

725 
	`PCI_FUNC
(
e
->
devid
),

726 
e
->
Êags
,É->
ext
);

728 
devid
 = 
e
->devid;

729 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
,

730 
e
->
ext
);

732 
IVHD_DEV_EXT_SELECT_RANGE
:

734 
	`DUMP_¥ötk
(" DEV_EXT_SELECT_RANGE\t devid: "

736 
	`PCI_BUS
(
e
->
devid
),

737 
	`PCI_SLOT
(
e
->
devid
),

738 
	`PCI_FUNC
(
e
->
devid
),

739 
e
->
Êags
,É->
ext
);

741 
devid_°¨t
 = 
e
->
devid
;

742 
Êags
 = 
e
->flags;

743 
ext_Êags
 = 
e
->
ext
;

744 
Æüs
 = 
Ál£
;

746 
IVHD_DEV_RANGE_END
:

748 
	`DUMP_¥ötk
(" DEV_RANGE_END\t\t devid: %02x:%02x.%x\n",

749 
	`PCI_BUS
(
e
->
devid
),

750 
	`PCI_SLOT
(
e
->
devid
),

751 
	`PCI_FUNC
(
e
->
devid
));

753 
devid
 = 
e
->devid;

754 
dev_i
 = 
devid_°¨t
; dev_ò<
devid
; ++dev_i) {

755 i‡(
Æüs
) {

756 
amd_iommu_Æüs_èbÀ
[
dev_i
] = 
devid_to
;

757 
	`£t_dev_íåy_‰om_a˝i
(
iommu
,

758 
devid_to
, 
Êags
, 
ext_Êags
);

760 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

761 
Êags
, 
ext_Êags
);

768 
p
 +
	`ivhd_íåy_Àngth
(p);

770 
	}
}

773 
__öô
 
	$öô_iommu_devi˚s
(
amd_iommu
 *
iommu
)

775 
u16
 
i
;

777 
i
 = 
iommu
->
fú°_devi˚
; i <iommu->
œ°_devi˚
; ++i)

778 
	`£t_iommu_f‹_devi˚
(
iommu
, 
i
);

781 
	}
}

783 
__öô
 
	$‰ì_iommu_⁄e
(
amd_iommu
 *
iommu
)

785 
	`‰ì_comm™d_buf„r
(
iommu
);

786 
	`‰ì_evít_buf„r
(
iommu
);

787 
	`iommu_unm≠_mmio_•a˚
(
iommu
);

788 
	}
}

790 
__öô
 
	$‰ì_iommu_Æl
()

792 
amd_iommu
 *
iommu
, *
√xt
;

794 
	`f‹_óch_iommu_ß„
(
iommu
, 
√xt
) {

795 
	`li°_dñ
(&
iommu
->
li°
);

796 
	`‰ì_iommu_⁄e
(
iommu
);

797 
	`k‰ì
(
iommu
);

799 
	}
}

806 
__öô
 
	$öô_iommu_⁄e
(
amd_iommu
 *
iommu
, 
ivhd_hódî
 *
h
)

808 
	`•ö_lock_öô
(&
iommu
->
lock
);

809 
	`li°_add_èû
(&
iommu
->
li°
, &
amd_iommu_li°
);

814 
iommu
->
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

815 i‡(!
iommu
->
dev
)

818 
iommu
->
ˇp_±r
 = 
h
->cap_ptr;

819 
iommu
->
pci_£g
 = 
h
->pci_seg;

820 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

821 
iommu
->
mmio_ba£
 = 
	`iommu_m≠_mmio_•a˚
(
h
->
mmio_phys
);

822 i‡(!
iommu
->
mmio_ba£
)

823  -
ENOMEM
;

825 
iommu
->
cmd_buf
 = 
	`Æloc_comm™d_buf„r
(iommu);

826 i‡(!
iommu
->
cmd_buf
)

827  -
ENOMEM
;

829 
iommu
->
evt_buf
 = 
	`Æloc_evít_buf„r
(iommu);

830 i‡(!
iommu
->
evt_buf
)

831  -
ENOMEM
;

833 
iommu
->
öt_íabÀd
 = 
Ál£
;

835 
	`öô_iommu_‰om_pci
(
iommu
);

836 
	`öô_iommu_‰om_a˝i
(
iommu
, 
h
);

837 
	`öô_iommu_devi˚s
(
iommu
);

839  
	`pci_íabÀ_devi˚
(
iommu
->
dev
);

840 
	}
}

846 
__öô
 
	$öô_iommu_Æl
(
a˝i_èbÀ_hódî
 *
èbÀ
)

848 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

849 
ivhd_hódî
 *
h
;

850 
amd_iommu
 *
iommu
;

851 
ªt
;

853 
íd
 +
èbÀ
->
Àngth
;

854 
p
 +
IVRS_HEADER_LENGTH
;

856 
p
 < 
íd
) {

857 
h
 = (
ivhd_hódî
 *)
p
;

858 *
p
) {

859 
ACPI_IVHD_TYPE
:

861 
	`DUMP_¥ötk
("IOMMU: device: %02x:%02x.%01x cap: %04x "

863 
	`PCI_BUS
(
h
->
devid
), 
	`PCI_SLOT
(h->devid),

864 
	`PCI_FUNC
(
h
->
devid
), h->
ˇp_±r
,

865 
h
->
pci_£g
, h->
Êags
, h->
öfo
);

866 
	`DUMP_¥ötk
(" mmio-addr: %016llx\n",

867 
h
->
mmio_phys
);

869 
iommu
 = 
	`kzÆloc
((
amd_iommu
), 
GFP_KERNEL
);

870 i‡(
iommu
 =
NULL
)

871  -
ENOMEM
;

872 
ªt
 = 
	`öô_iommu_⁄e
(
iommu
, 
h
);

873 i‡(
ªt
)

874  
ªt
;

879 
p
 +
h
->
Àngth
;

882 
	`WARN_ON
(
p
 !
íd
);

885 
	}
}

896 
__öô
 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

898 
r
;

900 i‡(
	`pci_íabÀ_msi
(
iommu
->
dev
))

903 
r
 = 
	`ªque°_úq
(
iommu
->
dev
->
úq
, 
amd_iommu_öt_h™dÀr
,

904 
IRQF_SAMPLE_RANDOM
,

906 
NULL
);

908 i‡(
r
) {

909 
	`pci_dißbÀ_msi
(
iommu
->
dev
);

913 
iommu
->
öt_íabÀd
 = 
åue
;

914 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

917 
	}
}

919 
	$iommu_öô_msi
(
amd_iommu
 *
iommu
)

921 i‡(
iommu
->
öt_íabÀd
)

924 i‡(
	`pci_föd_ˇ∑bûôy
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

925  
	`iommu_£tup_msi
(
iommu
);

928 
	}
}

938 
__öô
 
	$‰ì_unôy_m≠s
()

940 
unôy_m≠_íåy
 *
íåy
, *
√xt
;

942 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, &
amd_iommu_unôy_m≠
, 
li°
) {

943 
	`li°_dñ
(&
íåy
->
li°
);

944 
	`k‰ì
(
íåy
);

946 
	}
}

949 
__öô
 
	$öô_ex˛usi⁄_ønge
(
ivmd_hódî
 *
m
)

951 
i
;

953 
m
->
ty≥
) {

954 
ACPI_IVMD_TYPE
:

955 
	`£t_devi˚_ex˛usi⁄_ønge
(
m
->
devid
, m);

957 
ACPI_IVMD_TYPE_ALL
:

958 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

959 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

961 
ACPI_IVMD_TYPE_RANGE
:

962 
i
 = 
m
->
devid
; i <m->
aux
; ++i)

963 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

970 
	}
}

973 
__öô
 
	$öô_unôy_m≠_ønge
(
ivmd_hódî
 *
m
)

975 
unôy_m≠_íåy
 *
e
 = 0;

976 *
s
;

978 
e
 = 
	`kzÆloc
((*e), 
GFP_KERNEL
);

979 i‡(
e
 =
NULL
)

980  -
ENOMEM
;

982 
m
->
ty≥
) {

984 
	`k‰ì
(
e
);

986 
ACPI_IVMD_TYPE
:

987 
s
 = "IVMD_TYPEi\t\t\t";

988 
e
->
devid_°¨t
 =É->
devid_íd
 = 
m
->
devid
;

990 
ACPI_IVMD_TYPE_ALL
:

991 
s
 = "IVMD_TYPE_ALL\t\t";

992 
e
->
devid_°¨t
 = 0;

993 
e
->
devid_íd
 = 
amd_iommu_œ°_bdf
;

995 
ACPI_IVMD_TYPE_RANGE
:

996 
s
 = "IVMD_TYPE_RANGE\t\t";

997 
e
->
devid_°¨t
 = 
m
->
devid
;

998 
e
->
devid_íd
 = 
m
->
aux
;

1001 
e
->
addªss_°¨t
 = 
	`PAGE_ALIGN
(
m
->
ønge_°¨t
);

1002 
e
->
addªss_íd
 =É->
addªss_°¨t
 + 
	`PAGE_ALIGN
(
m
->
ønge_Àngth
);

1003 
e
->
¥Ÿ
 = 
m
->
Êags
 >> 1;

1005 
	`DUMP_¥ötk
("%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x"

1006 "Ñ™ge_°¨t: %016ŒxÑ™ge_íd: %016Œx fœgs: %x\n", 
s
,

1007 
	`PCI_BUS
(
e
->
devid_°¨t
), 
	`PCI_SLOT
(e->devid_start),

1008 
	`PCI_FUNC
(
e
->
devid_°¨t
), 
	`PCI_BUS
”->
devid_íd
),

1009 
	`PCI_SLOT
(
e
->
devid_íd
), 
	`PCI_FUNC
(e->devid_end),

1010 
e
->
addªss_°¨t
,É->
addªss_íd
, 
m
->
Êags
);

1012 
	`li°_add_èû
(&
e
->
li°
, &
amd_iommu_unôy_m≠
);

1015 
	}
}

1018 
__öô
 
	$öô_mem‹y_deföôi⁄s
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1020 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

1021 
ivmd_hódî
 *
m
;

1023 
íd
 +
èbÀ
->
Àngth
;

1024 
p
 +
IVRS_HEADER_LENGTH
;

1026 
p
 < 
íd
) {

1027 
m
 = (
ivmd_hódî
 *)
p
;

1028 i‡(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
)

1029 
	`öô_ex˛usi⁄_ønge
(
m
);

1030 i‡(
m
->
Êags
 & 
IVMD_FLAG_UNITY_MAP
)

1031 
	`öô_unôy_m≠_ønge
(
m
);

1033 
p
 +
m
->
Àngth
;

1037 
	}
}

1043 
	$öô_devi˚_èbÀ
()

1045 
u16
 
devid
;

1047 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid) {

1048 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_VALID
);

1049 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_TRANSLATION
);

1051 
	}
}

1057 
	$íabÀ_iommus
()

1059 
amd_iommu
 *
iommu
;

1061 
	`f‹_óch_iommu
(
iommu
) {

1062 
	`iommu_dißbÀ
(
iommu
);

1063 
	`iommu_£t_devi˚_èbÀ
(
iommu
);

1064 
	`iommu_íabÀ_comm™d_buf„r
(
iommu
);

1065 
	`iommu_íabÀ_evít_buf„r
(
iommu
);

1066 
	`iommu_£t_ex˛usi⁄_ønge
(
iommu
);

1067 
	`iommu_öô_msi
(
iommu
);

1068 
	`iommu_íabÀ
(
iommu
);

1070 
	}
}

1072 
	$dißbÀ_iommus
()

1074 
amd_iommu
 *
iommu
;

1076 
	`f‹_óch_iommu
(
iommu
)

1077 
	`iommu_dißbÀ
(
iommu
);

1078 
	}
}

1085 
	$amd_iommu_ªsume
(
sys_devi˚
 *
dev
)

1088 
	`íabÀ_iommus
();

1094 
	`amd_iommu_Êush_Æl_devi˚s
();

1095 
	`amd_iommu_Êush_Æl_domaös
();

1098 
	}
}

1100 
	$amd_iommu_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1103 
	`dißbÀ_iommus
();

1106 
	}
}

1108 
sysdev_˛ass
 
	gamd_iommu_sysdev_˛ass
 = {

1109 .
«me
 = "amd_iommu",

1110 .
	gsu•íd
 = 
amd_iommu_su•íd
,

1111 .
	gªsume
 = 
amd_iommu_ªsume
,

1114 
sys_devi˚
 
	gdevi˚_amd_iommu
 = {

1115 .
id
 = 0,

1116 .
	g˛s
 = &
amd_iommu_sysdev_˛ass
,

1147 
__öô
 
	$amd_iommu_öô
()

1149 
i
, 
ªt
 = 0;

1152 i‡(
no_iommu
) {

1153 
	`¥ötk
(
KERN_INFO
 "AMD IOMMU disabled by kernel commandÜine\n");

1157 i‡(!
amd_iommu_dëe˘ed
)

1158  -
ENODEV
;

1165 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
föd_œ°_devid_a˝i
) != 0)

1166  -
ENODEV
;

1168 
dev_èbÀ_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1169 
Æüs_èbÀ_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1170 
æookup_èbÀ_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1172 
ªt
 = -
ENOMEM
;

1175 
amd_iommu_dev_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1176 
	`gë_‹dî
(
dev_èbÀ_size
));

1177 i‡(
amd_iommu_dev_èbÀ
 =
NULL
)

1178 
out
;

1184 
amd_iommu_Æüs_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1185 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1186 i‡(
amd_iommu_Æüs_èbÀ
 =
NULL
)

1187 
‰ì
;

1190 
amd_iommu_æookup_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(

1191 
GFP_KERNEL
 | 
__GFP_ZERO
,

1192 
	`gë_‹dî
(
æookup_èbÀ_size
));

1193 i‡(
amd_iommu_æookup_èbÀ
 =
NULL
)

1194 
‰ì
;

1200 
amd_iommu_pd_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1201 
	`gë_‹dî
(
æookup_èbÀ_size
));

1202 i‡(
amd_iommu_pd_èbÀ
 =
NULL
)

1203 
‰ì
;

1205 
amd_iommu_pd_Æloc_bôm≠
 = (*)
	`__gë_‰ì_∑ges
(

1206 
GFP_KERNEL
 | 
__GFP_ZERO
,

1207 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1208 i‡(
amd_iommu_pd_Æloc_bôm≠
 =
NULL
)

1209 
‰ì
;

1212 
	`öô_devi˚_èbÀ
();

1217 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1218 
amd_iommu_Æüs_èbÀ
[
i
] = i;

1224 
amd_iommu_pd_Æloc_bôm≠
[0] = 1;

1230 
ªt
 = -
ENODEV
;

1231 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_iommu_Æl
) != 0)

1232 
‰ì
;

1234 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_mem‹y_deföôi⁄s
) != 0)

1235 
‰ì
;

1237 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
amd_iommu_sysdev_˛ass
);

1238 i‡(
ªt
)

1239 
‰ì
;

1241 
ªt
 = 
	`sysdev_ªgi°î
(&
devi˚_amd_iommu
);

1242 i‡(
ªt
)

1243 
‰ì
;

1245 
ªt
 = 
	`amd_iommu_öô_dma_›s
();

1246 i‡(
ªt
)

1247 
‰ì
;

1249 
	`íabÀ_iommus
();

1251 
	`¥ötk
(
KERN_INFO
 "AMD IOMMU: device isolation ");

1252 i‡(
amd_iommu_isﬁ©e
)

1253 
	`¥ötk
("enabled\n");

1255 
	`¥ötk
("disabled\n");

1257 i‡(
amd_iommu_unm≠_Êush
)

1258 
	`¥ötk
(
KERN_INFO
 "AMD IOMMU: IO/TLB flush on unmapÉnabled\n");

1260 
	`¥ötk
(
KERN_INFO
 "AMD IOMMU: Lazy IO/TLB flushingÉnabled\n");

1262 
out
:

1263  
ªt
;

1265 
‰ì
:

1266 
	`‰ì_∑ges
(()
amd_iommu_pd_Æloc_bôm≠
,

1267 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1269 
	`‰ì_∑ges
(()
amd_iommu_pd_èbÀ
,

1270 
	`gë_‹dî
(
æookup_èbÀ_size
));

1272 
	`‰ì_∑ges
(()
amd_iommu_æookup_èbÀ
,

1273 
	`gë_‹dî
(
æookup_èbÀ_size
));

1275 
	`‰ì_∑ges
(()
amd_iommu_Æüs_èbÀ
,

1276 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1278 
	`‰ì_∑ges
(()
amd_iommu_dev_èbÀ
,

1279 
	`gë_‹dî
(
dev_èbÀ_size
));

1281 
	`‰ì_iommu_Æl
();

1283 
	`‰ì_unôy_m≠s
();

1285 
out
;

1286 
	}
}

1288 
	$amd_iommu_shutdown
()

1290 
	`dißbÀ_iommus
();

1291 
	}
}

1300 
__öô
 
	$óæy_amd_iommu_dëe˘
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1303 
	}
}

1305 
__öô
 
	$amd_iommu_dëe˘
()

1307 i‡(
swiŸlb
 || 
no_iommu
 || (
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
))

1310 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
óæy_amd_iommu_dëe˘
) == 0) {

1311 
iommu_dëe˘ed
 = 1;

1312 
amd_iommu_dëe˘ed
 = 1;

1313 #ifde‡
CONFIG_GART_IOMMU


1314 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

1315 
g¨t_iommu_≠îtuª
 = 0;

1318 
	}
}

1327 
__öô
 
	$∑r£_amd_iommu_dump
(*
°r
)

1329 
amd_iommu_dump
 = 
åue
;

1332 
	}
}

1334 
__öô
 
	$∑r£_amd_iommu_›ti⁄s
(*
°r
)

1336 ; *
°r
; ++str) {

1337 i‡(
	`°∫cmp
(
°r
, "isolate", 7) == 0)

1338 
amd_iommu_isﬁ©e
 = 
åue
;

1339 i‡(
	`°∫cmp
(
°r
, "share", 5) == 0)

1340 
amd_iommu_isﬁ©e
 = 
Ál£
;

1341 i‡(
	`°∫cmp
(
°r
, "fullflush", 9) == 0)

1342 
amd_iommu_unm≠_Êush
 = 
åue
;

1346 
	}
}

1348 
__£tup
("amd_iommu_dump", 
∑r£_amd_iommu_dump
);

1349 
__£tup
("amd_iommu=", 
∑r£_amd_iommu_›ti⁄s
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/boŸmem.h
>

17 
	~<löux/mmz⁄e.h
>

18 
	~<löux/pci_ids.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/su•íd.h
>

23 
	~<asm/e820.h
>

24 
	~<asm/io.h
>

25 
	~<asm/iommu.h
>

26 
	~<asm/g¨t.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/dma.h
>

29 
	~<asm/k8.h
>

31 
	gg¨t_iommu_≠îtuª
;

32 
g¨t_iommu_≠îtuª_dißbÀd
 
	g__öôd©a
;

33 
g¨t_iommu_≠îtuª_Ælowed
 
	g__öôd©a
;

35 
ÁŒback_≠î_‹dî
 
	g__öôd©a
 = 1;

36 
ÁŒback_≠î_f‹˚
 
	g__öôd©a
;

38 
fix_≠îtuª
 
	g__öôd©a
 = 1;

40 
	sbus_dev_ønge
 {

41 
	mbus
;

42 
	mdev_ba£
;

43 
	mdev_limô
;

46 
bus_dev_ønge
 
	gbus_dev_ønges
[] 
	g__öôd©a
 = {

52 
ªsour˚
 
	gg¨t_ªsour˚
 = {

53 .
«me
 = "GART",

54 .
	gÊags
 = 
IORESOURCE_MEM
,

57 
__öô
 
	$ö£π_≠îtuª_ªsour˚
(
u32
 
≠î_ba£
, u32 
≠î_size
)

59 
g¨t_ªsour˚
.
°¨t
 = 
≠î_ba£
;

60 
g¨t_ªsour˚
.
íd
 = 
≠î_ba£
 + 
≠î_size
 - 1;

61 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
g¨t_ªsour˚
);

62 
	}
}

67 
u32
 
__öô
 
	$Æloˇã_≠îtuª
()

69 
u32
 
≠î_size
;

70 *
p
;

73 i‡(
ÁŒback_≠î_‹dî
 > 5)

74 
ÁŒback_≠î_‹dî
 = 5;

75 
≠î_size
 = (32 * 1024 * 1024Ë<< 
ÁŒback_≠î_‹dî
;

96 
p
 = 
	`__Æloc_boŸmem_n›™ic
(
≠î_size
,áper_size, 512ULL<<20);

97 i‡(!
p
 || 
	`__∑
’)+
≠î_size
 > 0xffffffff) {

98 
	`¥ötk
(
KERN_ERR


100 
p
, 
≠î_size
>>10);

101 i‡(
p
)

102 
	`‰ì_boŸmem
(
	`__∑
(
p
), 
≠î_size
);

105 
	`¥ötk
(
KERN_INFO
 "Mappingáperture over %d KB of RAM @ %lx\n",

106 
≠î_size
 >> 10, 
	`__∑
(
p
));

107 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
	`__∑
(
p
), 
≠î_size
);

108 
	`ªgi°î_noßve_ªgi⁄
((
u32
)
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

109 (
u32
)
	`__∑
(
p
+
≠î_size
Ë>> 
PAGE_SHIFT
);

111  (
u32
)
	`__∑
(
p
);

112 
	}
}

116 
u32
 
__öô
 
	$föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
)

118 
byãs
;

119 
u8
 
pos
;

121 i‡(!(
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

122 
PCI_STATUS_CAP_LIST
))

125 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

126 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

127 
u8
 
id
;

129 
pos
 &= ~3;

130 
id
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

131 i‡(
id
 == 0xff)

133 i‡(
id
 =
ˇp
)

134  
pos
;

135 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

136 
pos
+
PCI_CAP_LIST_NEXT
);

139 
	}
}

142 
u32
 
__öô
 
	$ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
, 
u32
 *
‹dî
)

144 
u32
 
≠size
;

145 
u32
 
≠sizîeg
;

146 
nbôs
;

147 
u32
 
≠î_low
, 
≠î_hi
;

148 
u64
 
≠î
;

149 
u32
 
ﬁd_‹dî
;

151 
	`¥ötk
(
KERN_INFO
 "AGP bridgê© %02x:%02x:%02x\n", 
bus
, 
¶Ÿ
, 
func
);

152 
≠sizîeg
 = 
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
 + 0x14);

153 i‡(
≠sizîeg
 == 0xffffffff) {

154 
	`¥ötk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

159 
ﬁd_‹dî
 = *
‹dî
;

161 
≠size
 = 
≠sizîeg
 & 0xfff;

163 i‡(
≠size
 & 0xff)

164 
≠size
 |= 0xf00;

165 
nbôs
 = 
	`hweight16
(
≠size
);

166 *
‹dî
 = 7 - 
nbôs
;

167 i‡(()*
‹dî
 < 0)

168 *
‹dî
 = 0;

170 
≠î_low
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x10);

171 
≠î_hi
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x14);

172 
≠î
 = (
≠î_low
 & ~((1<<22)-1)Ë| ((
u64
)
≠î_hi
 << 32);

178 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

179 
≠î
, 32 << 
ﬁd_‹dî
);

180 i‡(
≠î
 + (32ULL<<(20 + *
‹dî
)) > 0x100000000ULL) {

181 
	`¥ötk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) isÇotÑight, using settings from NB\n",

182 32 << *
‹dî
, 
≠sizîeg
);

183 *
‹dî
 = 
ﬁd_‹dî
;

186 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

187 
≠î
, 32 << *
‹dî
, 
≠sizîeg
);

189 i‡(!
	`≠îtuª_vÆid
(
≠î
, (32*1024*1024Ë<< *
‹dî
, 32<<20))

191  (
u32
)
≠î
;

192 
	}
}

207 
u32
 
__öô
 
	$£¨ch_agp_bridge
(
u32
 *
‹dî
, *
vÆid_agp
)

209 
bus
, 
¶Ÿ
, 
func
;

212 
bus
 = 0; bus < 256; bus++) {

213 
¶Ÿ
 = 0; slot < 32; slot++) {

214 
func
 = 0; func < 8; func++) {

215 
u32
 
˛ass
, 
ˇp
;

216 
u8
 
ty≥
;

217 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
,

218 
PCI_CLASS_REVISION
);

219 i‡(
˛ass
 == 0xffffffff)

222 
˛ass
 >> 16) {

223 
PCI_CLASS_BRIDGE_HOST
:

224 
PCI_CLASS_BRIDGE_OTHER
:

226 
ˇp
 = 
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
,

227 
PCI_CAP_ID_AGP
);

228 i‡(!
ˇp
)

230 *
vÆid_agp
 = 1;

231  
	`ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
,

232 
‹dî
);

236 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

237 
PCI_HEADER_TYPE
);

238 i‡(!(
ty≥
 & 0x80))

243 
	`¥ötk
(
KERN_INFO
 "No AGP bridge found\n");

246 
	}
}

248 
g¨t_fix_e820
 
	g__öôd©a
 = 1;

250 
__öô
 
	$∑r£_g¨t_mem
(*
p
)

252 i‡(!
p
)

253  -
EINVAL
;

255 i‡(!
	`°∫cmp
(
p
, "off", 3))

256 
g¨t_fix_e820
 = 0;

257 i‡(!
	`°∫cmp
(
p
, "on", 2))

258 
g¨t_fix_e820
 = 1;

261 
	}
}

262 
óæy_∑øm
("g¨t_fix_e820", 
∑r£_g¨t_mem
);

264 
__öô
 
	$óæy_g¨t_iommu_check
()

276 
i
, 
fix
, 
¶Ÿ
;

277 
u32
 
˘l
;

278 
u32
 
≠î_size
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

279 
u64
 
≠î_ba£
 = 0, 
œ°_≠î_ba£
 = 0;

280 
≠î_íabÀd
 = 0, 
œ°_≠î_íabÀd
 = 0, 
œ°_vÆid
 = 0;

282 i‡(!
	`óæy_pci_Ælowed
())

286 
fix
 = 0;

287 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

288 
bus
;

289 
dev_ba£
, 
dev_limô
;

291 
bus
 = 
bus_dev_ønges
[
i
].bus;

292 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

293 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

295 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

296 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

299 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

300 
≠î_íabÀd
 = 
˘l
 & 
AMD64_GARTEN
;

301 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

302 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

303 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

304 
≠î_ba£
 <<= 25;

306 i‡(
œ°_vÆid
) {

307 i‡((
≠î_‹dî
 !
œ°_≠î_‹dî
) ||

308 (
≠î_ba£
 !
œ°_≠î_ba£
) ||

309 (
≠î_íabÀd
 !
œ°_≠î_íabÀd
)) {

310 
fix
 = 1;

315 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

316 
œ°_≠î_ba£
 = 
≠î_ba£
;

317 
œ°_≠î_íabÀd
 = 
≠î_íabÀd
;

318 
œ°_vÆid
 = 1;

322 i‡(!
fix
 && !
≠î_íabÀd
)

325 i‡(!
≠î_ba£
 || !
≠î_size
 ||áper_base +áper_size > 0x100000000UL)

326 
fix
 = 1;

328 i‡(
g¨t_fix_e820
 && !
fix
 && 
≠î_íabÀd
) {

329 i‡(
	`e820_™y_m≠≥d
(
≠î_ba£
,á≥r_ba£ + 
≠î_size
,

330 
E820_RAM
)) {

332 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for GART\n");

333 
	`e820_add_ªgi⁄
(
≠î_ba£
, 
≠î_size
, 
E820_RESERVED
);

334 
	`upd©e_e820
();

338 i‡(!
fix
)

342 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

343 
bus
;

344 
dev_ba£
, 
dev_limô
;

346 
bus
 = 
bus_dev_ønges
[
i
].bus;

347 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

348 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

350 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

351 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

354 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

355 
˘l
 &~
AMD64_GARTEN
;

356 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

360 
	}
}

362 
__öôd©a
 
	g¥öãd_g¨t_size_msg
;

364 
__öô
 
	$g¨t_iommu_hﬁe_öô
()

366 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

367 
u32
 
≠î_size
, 
≠î_Æloc
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

368 
u64
 
≠î_ba£
, 
œ°_≠î_ba£
 = 0;

369 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

370 
i
, 
node
;

372 i‡(
g¨t_iommu_≠îtuª_dißbÀd
 || !
fix_≠îtuª
 ||

373 !
	`óæy_pci_Ælowed
())

376 
	`¥ötk
(
KERN_INFO
 "Checkingáperture...\n");

378 i‡(!
ÁŒback_≠î_f‹˚
)

379 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

381 
fix
 = 0;

382 
node
 = 0;

383 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

384 
bus
;

385 
dev_ba£
, 
dev_limô
;

387 
bus
 = 
bus_dev_ønges
[
i
].bus;

388 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

389 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

391 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

392 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

395 
iommu_dëe˘ed
 = 1;

396 
g¨t_iommu_≠îtuª
 = 1;

398 
≠î_‹dî
 = (
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
) >> 1) & 7;

399 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

400 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

401 
≠î_ba£
 <<= 25;

403 
	`¥ötk
(
KERN_INFO
 "Node %d:áperture @ %Lx size %u MB\n",

404 
node
, 
≠î_ba£
, 
≠î_size
 >> 20);

405 
node
++;

407 i‡(!
	`≠îtuª_vÆid
(
≠î_ba£
, 
≠î_size
, 64<<20)) {

408 i‡(
vÆid_agp
 && 
agp_≠î_ba£
 &&

409 
agp_≠î_ba£
 =
≠î_ba£
 &&

410 
agp_≠î_‹dî
 =
≠î_‹dî
) {

412 i‡(!
no_iommu
 &&

413 
max_p‚
 > 
MAX_DMA32_PFN
 &&

414 !
¥öãd_g¨t_size_msg
) {

415 
	`¥ötk
(
KERN_ERR
 "youáre using iommu withágp, but GART size isÜessÅhan 64M\n");

416 
	`¥ötk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

417 
	`¥ötk
(
KERN_ERR
 "if BIOS doesn't haveÅhat option, contact your HW vendor!\n");

418 
¥öãd_g¨t_size_msg
 = 1;

421 
fix
 = 1;

422 
out
;

426 i‡((
œ°_≠î_‹dî
 && 
≠î_‹dî
 !=Üast_aper_order) ||

427 (
œ°_≠î_ba£
 && 
≠î_ba£
 !=Üast_aper_base)) {

428 
fix
 = 1;

429 
out
;

431 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

432 
œ°_≠î_ba£
 = 
≠î_ba£
;

436 
out
:

437 i‡(!
fix
 && !
ÁŒback_≠î_f‹˚
) {

438 i‡(
œ°_≠î_ba£
) {

439 
n
 = (32 * 1024 * 1024Ë<< 
œ°_≠î_‹dî
;

441 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
œ°_≠î_ba£
, 
n
);

446 i‡(!
ÁŒback_≠î_f‹˚
) {

447 
≠î_Æloc
 = 
agp_≠î_ba£
;

448 
≠î_‹dî
 = 
agp_≠î_‹dî
;

451 i‡(
≠î_Æloc
) {

453 } i‡(
swiŸlb
 && !
vÆid_agp
) {

455 } i‡((!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

456 
f‹˚_iommu
 ||

457 
vÆid_agp
 ||

458 
ÁŒback_≠î_f‹˚
) {

459 
	`¥ötk
(
KERN_INFO


461 
	`¥ötk
(
KERN_INFO


463 
	`¥ötk
(
KERN_INFO


465 32 << 
ÁŒback_≠î_‹dî
);

467 
≠î_‹dî
 = 
ÁŒback_≠î_‹dî
;

468 
≠î_Æloc
 = 
	`Æloˇã_≠îtuª
();

469 i‡(!
≠î_Æloc
) {

478 
	`∑nic
("NotÉnough memory foráperture");

485 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

486 
bus
;

487 
dev_ba£
, 
dev_limô
;

489 
bus
 = 
bus_dev_ønges
[
i
].bus;

490 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

491 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

492 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

493 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

499 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
≠î_‹dî
 << 1);

500 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
, 
≠î_Æloc
 >> 25);

504 
	`£t_up_g¨t_ªsume
(
≠î_‹dî
, 
≠î_Æloc
);

505 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<löux/≥rf_cou¡î.h
>

18 
	~<löux/kî√l_°©.h
>

19 
	~<löux/mc146818πc.h
>

20 
	~<löux/a˝i_pmtmr.h
>

21 
	~<löux/˛ockchùs.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/·ø˚.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/moduÀ.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/dñay.h
>

29 
	~<löux/timex.h
>

30 
	~<löux/dm¨.h
>

31 
	~<löux/öô.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/dmi.h
>

34 
	~<löux/nmi.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/≥rf_cou¡î.h
>

39 
	~<asm/pgÆloc.h
>

40 
	~<asm/©omic.h
>

41 
	~<asm/mp•ec.h
>

42 
	~<asm/i8253.h
>

43 
	~<asm/i8259.h
>

44 
	~<asm/¥Ÿo.h
>

45 
	~<asm/≠ic.h
>

46 
	~<asm/desc.h
>

47 
	~<asm/h≥t.h
>

48 
	~<asm/idÀ.h
>

49 
	~<asm/mår.h
>

50 
	~<asm/smp.h
>

51 
	~<asm/m˚.h
>

53 
	gnum_¥o˚ss‹s
;

55 
dißbÀd_˝us
 
	g__˝uöôd©a
;

58 
	gboŸ_˝u_physiˇl_≠icid
 = -1U;

69 
	gmax_physiˇl_≠icid
;

74 
physid_mask_t
 
	gphys_˝u_¥e£¡_m≠
;

79 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_˝u_to_≠icid
, 
BAD_APICID
);

80 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_˝u_≠icid
, 
BAD_APICID
);

81 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_≠icid
);

82 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_˝u_≠icid
);

84 #ifde‡
CONFIG_X86_32


90 
	gf‹˚_íabÀ_loˇl_≠ic
;

94 
__öô
 
	$∑r£_œpic
(*
¨g
)

96 
f‹˚_íabÀ_loˇl_≠ic
 = 1;

98 
	}
}

99 
óæy_∑øm
("œpic", 
∑r£_œpic
);

101 
	gíabÀd_vü_≠icba£
;

111 
ölöe
 
	$im¸_pic_to_≠ic
()

114 
	`outb
(0x70, 0x22);

116 
	`outb
(0x01, 0x23);

117 
	}
}

119 
ölöe
 
	$im¸_≠ic_to_pic
()

122 
	`outb
(0x70, 0x22);

124 
	`outb
(0x00, 0x23);

125 
	}
}

128 #ifde‡
CONFIG_X86_64


129 
≠ic_ˇlibøã_pmtmr
 
	g__öôd©a
;

130 
__öô
 
	$£tup_≠i˝mtimî
(*
s
)

132 
≠ic_ˇlibøã_pmtmr
 = 1;

133 
	`nŸsc_£tup
(
NULL
);

135 
	}
}

136 
__£tup
("≠i˝mtimî", 
£tup_≠i˝mtimî
);

139 
	gx2≠ic_mode
;

140 #ifde‡
CONFIG_X86_X2APIC


142 
	gx2≠ic_¥ì«bÀd
;

143 
__öô
 
	$£tup_nox2≠ic
(*
°r
)

145 i‡(
	`x2≠ic_íabÀd
()) {

146 
	`¥_w¨nög
("BiosálreadyÉnabled x2apic, "

151 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_X2APIC
);

153 
	}
}

154 
óæy_∑øm
("nox2≠ic", 
£tup_nox2≠ic
);

157 
	gmp_œpic_addr
;

158 
	gdißbÀ_≠ic
;

160 
dißbÀ_≠ic_timî
 
	g__˝uöôd©a
;

162 
	gloˇl_≠ic_timî_c2_ok
;

163 
EXPORT_SYMBOL_GPL
(
loˇl_≠ic_timî_c2_ok
);

165 
	gfú°_sy°em_ve˘‹
 = 0xfe;

170 
	g≠ic_vîbosôy
;

172 
	gpic_mode
;

175 
	gsmp_found_c⁄fig
;

177 
ªsour˚
 
	gœpic_ªsour˚
 = {

178 .
«me
 = "Local APIC",

179 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

182 
	gˇlibøti⁄_ªsu…
;

184 
œpic_√xt_evít
(
dñè
,

185 
˛ock_evít_devi˚
 *
evt
);

186 
œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

187 
˛ock_evít_devi˚
 *
evt
);

188 
œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
);

189 
≠ic_pm_a˘iv©e
();

194 
˛ock_evít_devi˚
 
	gœpic_˛ockevít
 = {

195 .
«me
 = "lapic",

196 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


197 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

198 .
	gshi·
 = 32,

199 .
	g£t_mode
 = 
œpic_timî_£tup
,

200 .
	g£t_√xt_evít
 = 
œpic_√xt_evít
,

201 .
	gbrﬂdˇ°
 = 
œpic_timî_brﬂdˇ°
,

202 .
	gøtög
 = 100,

203 .
	gúq
 = -1,

205 
DEFINE_PER_CPU
(
˛ock_evít_devi˚
, 
œpic_evíts
);

207 
	g≠ic_phys
;

212 
ölöe
 
	$œpic_gë_vîsi⁄
()

214  
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

215 
	}
}

220 
ölöe
 
	$œpic_is_öãgøãd
()

222 #ifde‡
CONFIG_X86_64


225  
	`APIC_INTEGRATED
(
	`œpic_gë_vîsi⁄
());

227 
	}
}

232 
	$modîn_≠ic
()

235 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
 &&

236 
boŸ_˝u_d©a
.
x86
 >= 0xf)

238  
	`œpic_gë_vîsi⁄
() >= 0x14;

239 
	}
}

245 
	$«tive_≠ic_wrôe_dummy
(
u32
 
ªg
, u32 
v
)

247 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 || !
dißbÀ_≠ic
));

248 
	}
}

250 
u32
 
	$«tive_≠ic_ªad_dummy
(
u32
 
ªg
)

252 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 && !
dißbÀ_≠ic
));

254 
	}
}

260 
	$≠ic_dißbÀ
()

262 
≠ic
->
ªad
 = 
«tive_≠ic_ªad_dummy
;

263 
≠ic
->
wrôe
 = 
«tive_≠ic_wrôe_dummy
;

264 
	}
}

266 
	$«tive_≠ic_waô_i¸_idÀ
()

268 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
)

269 
	`˝u_ªœx
();

270 
	}
}

272 
u32
 
	$«tive_ß„_≠ic_waô_i¸_idÀ
()

274 
u32
 
£nd_°©us
;

275 
timeout
;

277 
timeout
 = 0;

279 
£nd_°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
;

280 i‡(!
£nd_°©us
)

282 
	`udñay
(100);

283 } 
timeout
++ < 1000);

285  
£nd_°©us
;

286 
	}
}

288 
	$«tive_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
)

290 
	`≠ic_wrôe
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

291 
	`≠ic_wrôe
(
APIC_ICR
, 
low
);

292 
	}
}

294 
u64
 
	$«tive_≠ic_i¸_ªad
()

296 
u32
 
i¸1
, 
i¸2
;

298 
i¸2
 = 
	`≠ic_ªad
(
APIC_ICR2
);

299 
i¸1
 = 
	`≠ic_ªad
(
APIC_ICR
);

301  
i¸1
 | ((
u64
)
i¸2
 << 32);

302 
	}
}

307 
__˝uöô
 
	$íabÀ_NMI_through_LVT0
()

309 
v
;

312 
v
 = 
APIC_DM_NMI
;

315 i‡(!
	`œpic_is_öãgøãd
())

316 
v
 |
APIC_LVT_LEVEL_TRIGGER
;

318 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
);

319 
	}
}

321 #ifde‡
CONFIG_X86_32


325 
	$gë_physiˇl_brﬂdˇ°
()

327  
	`modîn_≠ic
() ? 0xff : 0xf;

328 
	}
}

334 
	$œpic_gë_maxlvt
()

336 
v
;

338 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

343  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)Ë? 
	`GET_APIC_MAXLVT
(v) : 2;

344 
	}
}

351 
	#APIC_DIVISOR
 16

	)

363 
	$__£tup_APIC_LVTT
(
˛ocks
, 
⁄eshŸ
, 
úqí
)

365 
lvâ_vÆue
, 
tmp_vÆue
;

367 
lvâ_vÆue
 = 
LOCAL_TIMER_VECTOR
;

368 i‡(!
⁄eshŸ
)

369 
lvâ_vÆue
 |
APIC_LVT_TIMER_PERIODIC
;

370 i‡(!
	`œpic_is_öãgøãd
())

371 
lvâ_vÆue
 |
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

373 i‡(!
úqí
)

374 
lvâ_vÆue
 |
APIC_LVT_MASKED
;

376 
	`≠ic_wrôe
(
APIC_LVTT
, 
lvâ_vÆue
);

381 
tmp_vÆue
 = 
	`≠ic_ªad
(
APIC_TDCR
);

382 
	`≠ic_wrôe
(
APIC_TDCR
,

383 (
tmp_vÆue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

384 
APIC_TDR_DIV_16
);

386 i‡(!
⁄eshŸ
)

387 
	`≠ic_wrôe
(
APIC_TMICT
, 
˛ocks
 / 
APIC_DIVISOR
);

388 
	}
}

400 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

401 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

403 
	$£tup_APIC_eûvt
(
u8
 
lvt_off
, u8 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

405 
ªg
 = (
lvt_off
 << 4Ë+ 
	`APIC_EILVTn
(0);

406 
v
 = (
mask
 << 16Ë| (
msg_ty≥
 << 8Ë| 
ve˘‹
;

408 
	`≠ic_wrôe
(
ªg
, 
v
);

409 
	}
}

411 
u8
 
	$£tup_APIC_eûvt_m˚
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

413 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_MCE
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

414  
APIC_EILVT_LVTOFF_MCE
;

415 
	}
}

417 
u8
 
	$£tup_APIC_eûvt_ibs
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

419 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_IBS
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

420  
APIC_EILVT_LVTOFF_IBS
;

421 
	}
}

422 
EXPORT_SYMBOL_GPL
(
£tup_APIC_eûvt_ibs
);

427 
	$œpic_√xt_evít
(
dñè
,

428 
˛ock_evít_devi˚
 *
evt
)

430 
	`≠ic_wrôe
(
APIC_TMICT
, 
dñè
);

432 
	}
}

437 
	$œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

438 
˛ock_evít_devi˚
 *
evt
)

440 
Êags
;

441 
v
;

444 i‡(
evt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
)

447 
	`loˇl_úq_ßve
(
Êags
);

449 
mode
) {

450 
CLOCK_EVT_MODE_PERIODIC
:

451 
CLOCK_EVT_MODE_ONESHOT
:

452 
	`__£tup_APIC_LVTT
(
ˇlibøti⁄_ªsu…
,

453 
mode
 !
CLOCK_EVT_MODE_PERIODIC
, 1);

455 
CLOCK_EVT_MODE_UNUSED
:

456 
CLOCK_EVT_MODE_SHUTDOWN
:

457 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

458 
v
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

459 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
);

460 
	`≠ic_wrôe
(
APIC_TMICT
, 0xffffffff);

462 
CLOCK_EVT_MODE_RESUME
:

467 
	`loˇl_úq_ª°‹e
(
Êags
);

468 
	}
}

473 
	$œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
)

475 #ifde‡
CONFIG_SMP


476 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

478 
	}
}

484 
__˝uöô
 
	$£tup_APIC_timî
()

486 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

488 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_ARAT
)) {

489 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_C3STOP
;

491 
œpic_˛ockevít
.
øtög
 = 150;

494 
	`mem˝y
(
Àvt
, &
œpic_˛ockevít
, (*levt));

495 
Àvt
->
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

497 
	`˛ockevíts_ªgi°î_devi˚
(
Àvt
);

498 
	}
}

521 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

523 
__öôd©a
 
	gœpic_ˇl_lo›s
 = -1;

524 
__öôd©a
 
	gœpic_ˇl_t1
, 
	gœpic_ˇl_t2
;

525 
__öôd©a
 
	gœpic_ˇl_tsc1
, 
	gœpic_ˇl_tsc2
;

526 
__öôd©a
 
	gœpic_ˇl_pm1
, 
	gœpic_ˇl_pm2
;

527 
__öôd©a
 
	gœpic_ˇl_j1
, 
	gœpic_ˇl_j2
;

532 
__öô
 
	$œpic_ˇl_h™dÀr
(
˛ock_evít_devi˚
 *
dev
)

534 
tsc
 = 0;

535 
èpic
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

536 
pm
 = 
	`a˝i_pm_ªad_óæy
();

538 i‡(
˝u_has_tsc
)

539 
	`rdts˛l
(
tsc
);

541 
œpic_ˇl_lo›s
++) {

543 
œpic_ˇl_t1
 = 
èpic
;

544 
œpic_ˇl_tsc1
 = 
tsc
;

545 
œpic_ˇl_pm1
 = 
pm
;

546 
œpic_ˇl_j1
 = 
jiffõs
;

549 
LAPIC_CAL_LOOPS
:

550 
œpic_ˇl_t2
 = 
èpic
;

551 
œpic_ˇl_tsc2
 = 
tsc
;

552 i‡(
pm
 < 
œpic_ˇl_pm1
)

553 
pm
 +
ACPI_PM_OVRRUN
;

554 
œpic_ˇl_pm2
 = 
pm
;

555 
œpic_ˇl_j2
 = 
jiffõs
;

558 
	}
}

560 
__öô


561 
	$ˇlibøã_by_pmtimî
(
dñèpm
, *
dñè
, *
dñètsc
)

563 c⁄° 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

564 c⁄° 
pm_thªsh
 = 
pm_100ms
 / 100;

565 
mu…
;

566 
u64
 
ªs
;

568 #i‚de‡
CONFIG_X86_PM_TIMER


572 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-Timî dñè = %ld\n", 
dñèpm
);

575 i‡(!
dñèpm
)

578 
mu…
 = 
	`˛ocksour˚_hz2mu…
(
PMTMR_TICKS_PER_SEC
, 22);

580 i‡(
dñèpm
 > (
pm_100ms
 - 
pm_thªsh
) &&

581 
dñèpm
 < (
pm_100ms
 + 
pm_thªsh
)) {

582 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-TimerÑesult ok\n");

586 
ªs
 = (((
u64
)
dñèpm
Ë* 
mu…
) >> 22;

587 
	`do_div
(
ªs
, 1000000);

588 
	`¥_w¨nög
("APIC calibrationÇot consistent "

589 "wôh PM-Timî: %ldm†ö°ód o‡100ms\n",()
ªs
);

592 
ªs
 = (((
u64
)(*
dñè
)Ë* 
pm_100ms
);

593 
	`do_div
(
ªs
, 
dñèpm
);

594 
	`¥_öfo
("APIC deltaádjustedÅo PM-Timer: "

595 "%lu (%ld)\n", ()
ªs
, *
dñè
);

596 *
dñè
 = ()
ªs
;

599 i‡(
˝u_has_tsc
) {

600 
ªs
 = (((
u64
)(*
dñètsc
)Ë* 
pm_100ms
);

601 
	`do_div
(
ªs
, 
dñèpm
);

602 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "TSC deltaádjustedÅo "

604 ()
ªs
, *
dñètsc
);

605 *
dñètsc
 = ()
ªs
;

609 
	}
}

611 
__öô
 
	$ˇlibøã_APIC_˛ock
()

613 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

614 (*
ªÆ_h™dÀr
)(
˛ock_evít_devi˚
 *
dev
);

615 
dñèj
;

616 
dñè
, 
dñètsc
;

617 
pm_ª„ªn˚d
 = 0;

619 
	`loˇl_úq_dißbÀ
();

622 
ªÆ_h™dÀr
 = 
globÆ_˛ock_evít
->
evít_h™dÀr
;

623 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

629 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

632 
	`loˇl_úq_íabÀ
();

634 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

635 
	`˝u_ªœx
();

637 
	`loˇl_úq_dißbÀ
();

640 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
ªÆ_h™dÀr
;

643 
dñè
 = 
œpic_ˇl_t1
 - 
œpic_ˇl_t2
;

644 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "...Ü≠i¯dñè = %ld\n", 
dñè
);

646 
dñètsc
 = ()(
œpic_ˇl_tsc2
 - 
œpic_ˇl_tsc1
);

649 
pm_ª„ªn˚d
 = !
	`ˇlibøã_by_pmtimî
(
œpic_ˇl_pm2
 - 
œpic_ˇl_pm1
,

650 &
dñè
, &
dñètsc
);

653 
œpic_˛ockevít
.
mu…
 = 
	`div_sc
(
dñè
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

654 
œpic_˛ockevít
.
shi·
);

655 
œpic_˛ockevít
.
max_dñè_ns
 =

656 
	`˛ockevít_dñè2ns
(0x7FFFFF, &
œpic_˛ockevít
);

657 
œpic_˛ockevít
.
mö_dñè_ns
 =

658 
	`˛ockevít_dñè2ns
(0xF, &
œpic_˛ockevít
);

660 
ˇlibøti⁄_ªsu…
 = (
dñè
 * 
APIC_DIVISOR
Ë/ 
LAPIC_CAL_LOOPS
;

662 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... dñè %ld\n", 
dñè
);

663 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... mu…: %ld\n", 
œpic_˛ockevít
.
mu…
);

664 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... calibrationÑesult: %u\n",

665 
ˇlibøti⁄_ªsu…
);

667 i‡(
˝u_has_tsc
) {

668 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... CPU clock speed is "

670 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë/ (1000000 / 
HZ
),

671 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë% (1000000 / 
HZ
));

674 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... host bus clock speed is "

676 
ˇlibøti⁄_ªsu…
 / (1000000 / 
HZ
),

677 
ˇlibøti⁄_ªsu…
 % (1000000 / 
HZ
));

682 i‡(
ˇlibøti⁄_ªsu…
 < (1000000 / 
HZ
)) {

683 
	`loˇl_úq_íabÀ
();

684 
	`¥_w¨nög
("APIC frequencyÅoo slow, disablingápicÅimer\n");

688 
Àvt
->
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

694 i‡(!
pm_ª„ªn˚d
) {

695 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... verify APICÅimer\n");

700 
Àvt
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

701 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Àvt
);

702 
œpic_ˇl_lo›s
 = -1;

705 
	`loˇl_úq_íabÀ
();

707 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

708 
	`˝u_ªœx
();

711 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Àvt
);

714 
dñèj
 = 
œpic_ˇl_j2
 - 
œpic_ˇl_j1
;

715 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffõ†dñè = %lu\n", 
dñèj
);

718 i‡(
dñèj
 >
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

719 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffiesÑesult ok\n");

721 
Àvt
->
„©uªs
 |
CLOCK_EVT_FEAT_DUMMY
;

723 
	`loˇl_úq_íabÀ
();

725 i‡(
Àvt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
) {

726 
	`¥_w¨nög
("APICÅimer disabled dueÅo verification failure\n");

731 
	}
}

738 
__öô
 
	$£tup_boŸ_APIC_˛ock
()

746 i‡(
dißbÀ_≠ic_timî
) {

747 
	`¥_öfo
("Disabling APICÅimer\n");

749 i‡(
	`num_possibÀ_˝us
() > 1) {

750 
œpic_˛ockevít
.
mu…
 = 1;

751 
	`£tup_APIC_timî
();

756 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "UsingÜocal APICÅimer interrupts.\n"

759 i‡(
	`ˇlibøã_APIC_˛ock
()) {

761 i‡(
	`num_possibÀ_˝us
() > 1)

762 
	`£tup_APIC_timî
();

771 i‡(
nmi_w©chdog
 !
NMI_IO_APIC
)

772 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

774 
	`¥_w¨nög
("APICÅimerÑegisteredás dummy,"

775 " duêtÿnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

778 
	`£tup_APIC_timî
();

779 
	}
}

781 
__˝uöô
 
	$£tup_£c⁄d¨y_APIC_˛ock
()

783 
	`£tup_APIC_timî
();

784 
	}
}

789 
	$loˇl_≠ic_timî_öãºu±
()

791 
˝u
 = 
	`smp_¥o˚ss‹_id
();

792 
˛ock_evít_devi˚
 *
evt
 = &
	`≥r_˝u
(
œpic_evíts
, 
˝u
);

805 i‡(!
evt
->
evít_h™dÀr
) {

806 
	`¥_w¨nög
("Spuriou†LAPICÅimî i¡îru± o¿˝u %d\n", 
˝u
);

808 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

815 
	`öc_úq_°©
(
≠ic_timî_úqs
);

817 
evt
->
	`evít_h™dÀr
(evt);

818 
	}
}

828 
__úq_íåy
 
	$smp_≠ic_timî_öãºu±
(
±_ªgs
 *
ªgs
)

830 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

836 
	`ack_APIC_úq
();

842 
	`exô_idÀ
();

843 
	`úq_íãr
();

844 
	`loˇl_≠ic_timî_öãºu±
();

845 
	`úq_exô
();

847 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

848 
	}
}

850 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

852  -
EINVAL
;

853 
	}
}

866 
	$˛ór_loˇl_APIC
()

868 
maxlvt
;

869 
u32
 
v
;

872 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

875 
maxlvt
 = 
	`œpic_gë_maxlvt
();

880 i‡(
maxlvt
 >= 3) {

881 
v
 = 
ERROR_APIC_VECTOR
;

882 
	`≠ic_wrôe
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

888 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

889 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

890 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

891 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

892 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

893 
	`≠ic_wrôe
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

894 i‡(
maxlvt
 >= 4) {

895 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

896 
	`≠ic_wrôe
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

900 #ifde‡
CONFIG_X86_THERMAL_VECTOR


901 i‡(
maxlvt
 >= 5) {

902 
v
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

903 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

906 #ifde‡
CONFIG_X86_MCE_INTEL


907 i‡(
maxlvt
 >= 6) {

908 
v
 = 
	`≠ic_ªad
(
APIC_LVTCMCI
);

909 i‡(!(
v
 & 
APIC_LVT_MASKED
))

910 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

917 
	`≠ic_wrôe
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

918 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

919 
	`≠ic_wrôe
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

920 i‡(
maxlvt
 >= 3)

921 
	`≠ic_wrôe
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

922 i‡(
maxlvt
 >= 4)

923 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

926 i‡(
	`œpic_is_öãgøãd
()) {

927 i‡(
maxlvt
 > 3)

929 
	`≠ic_wrôe
(
APIC_ESR
, 0);

930 
	`≠ic_ªad
(
APIC_ESR
);

932 
	}
}

937 
	$dißbÀ_loˇl_APIC
()

939 
vÆue
;

942 i‡(!
≠ic_phys
)

945 
	`˛ór_loˇl_APIC
();

951 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

952 
vÆue
 &~
APIC_SPIV_APIC_ENABLED
;

953 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

955 #ifde‡
CONFIG_X86_32


960 i‡(
íabÀd_vü_≠icba£
) {

961 
l
, 
h
;

963 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

964 
l
 &~
MSR_IA32_APICBASE_ENABLE
;

965 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

968 
	}
}

976 
	$œpic_shutdown
()

978 
Êags
;

980 i‡(!
˝u_has_≠ic
)

983 
	`loˇl_úq_ßve
(
Êags
);

985 #ifde‡
CONFIG_X86_32


986 i‡(!
íabÀd_vü_≠icba£
)

987 
	`˛ór_loˇl_APIC
();

990 
	`dißbÀ_loˇl_APIC
();

993 
	`loˇl_úq_ª°‹e
(
Êags
);

994 
	}
}

1001 
__öô
 
	$vîify_loˇl_APIC
()

1003 
ªg0
, 
ªg1
;

1008 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVR
);

1009 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg0
);

1010 
	`≠ic_wrôe
(
APIC_LVR
, 
ªg0
 ^ 
APIC_LVR_MASK
);

1011 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVR
);

1012 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg1
);

1019 i‡(
ªg1
 !
ªg0
)

1025 
ªg1
 = 
	`GET_APIC_VERSION
(
ªg0
);

1026 i‡(
ªg1
 == 0x00 ||Ñeg1 == 0xff)

1028 
ªg1
 = 
	`œpic_gë_maxlvt
();

1029 i‡(
ªg1
 < 0x02 ||Ñeg1 == 0xff)

1035 
ªg0
 = 
	`≠ic_ªad
(
APIC_ID
);

1036 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg0
);

1037 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
 ^ 
≠ic
->
≠ic_id_mask
);

1038 
ªg1
 = 
	`≠ic_ªad
(
APIC_ID
);

1039 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg1
);

1040 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
);

1041 i‡(
ªg1
 !(
ªg0
 ^ 
≠ic
->
≠ic_id_mask
))

1049 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1050 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT0: %x\n", 
ªg0
);

1051 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1052 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT1: %x\n", 
ªg1
);

1055 
	}
}

1060 
__öô
 
	$sync_Arb_IDs
()

1066 i‡(
	`modîn_≠ic
(Ë|| 
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
)

1072 
	`≠ic_waô_i¸_idÀ
();

1074 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1075 
	`≠ic_wrôe
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1076 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1077 
	}
}

1082 
__öô
 
	$öô_b•_APIC
()

1084 
vÆue
;

1090 i‡(
smp_found_c⁄fig
 || !
˝u_has_≠ic
)

1096 
	`˛ór_loˇl_APIC
();

1101 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1102 
vÆue
 &~
APIC_VECTOR_MASK
;

1103 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1105 #ifde‡
CONFIG_X86_32


1107 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

1108 (
boŸ_˝u_d©a
.
x86
 == 15))

1109 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1112 
vÆue
 |
APIC_SPIV_FOCUS_DISABLED
;

1113 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1114 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1119 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1120 
vÆue
 = 
APIC_DM_NMI
;

1121 i‡(!
	`œpic_is_öãgøãd
())

1122 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1123 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1124 
	}
}

1126 
__˝uöô
 
	$œpic_£tup_e§
()

1128 
ﬁdvÆue
, 
vÆue
, 
maxlvt
;

1130 i‡(!
	`œpic_is_öãgøãd
()) {

1131 
	`¥_öfo
("No ESR for 82489DX.\n");

1135 i‡(
≠ic
->
dißbÀ_e§
) {

1142 
	`¥_öfo
("Leaving ESR disabled.\n");

1146 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1147 i‡(
maxlvt
 > 3)

1148 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1149 
ﬁdvÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1152 
vÆue
 = 
ERROR_APIC_VECTOR
;

1153 
	`≠ic_wrôe
(
APIC_LVTERR
, 
vÆue
);

1158 i‡(
maxlvt
 > 3)

1159 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1160 
vÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1161 i‡(
vÆue
 !
ﬁdvÆue
)

1162 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ESR value beforeÉnabling "

1164 
ﬁdvÆue
, 
vÆue
);

1165 
	}
}

1171 
__˝uöô
 
	$£tup_loˇl_APIC
()

1173 
vÆue
;

1174 
i
, 
j
;

1176 i‡(
dißbÀ_≠ic
) {

1177 
	`¨ch_dißbÀ_smp_suµ‹t
();

1181 #ifde‡
CONFIG_X86_32


1183 i‡(
	`œpic_is_öãgøãd
(Ë&& 
≠ic
->
dißbÀ_e§
) {

1184 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1185 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1186 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1187 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1190 
	`≥rf_cou¡îs_œpic_öô
();

1192 
	`¥ìm±_dißbÀ
();

1198 i‡(!
≠ic
->
	`≠ic_id_ªgi°îed
())

1199 
	`BUG
();

1206 
≠ic
->
	`öô_≠ic_ldr
();

1212 
vÆue
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1213 
vÆue
 &~
APIC_TPRI_MASK
;

1214 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
vÆue
);

1227 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1228 
vÆue
 = 
	`≠ic_ªad
(
APIC_ISR
 + 
i
*0x10);

1229 
j
 = 31; j >= 0; j--) {

1230 i‡(
vÆue
 & (1<<
j
))

1231 
	`ack_APIC_úq
();

1238 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1239 
vÆue
 &~
APIC_VECTOR_MASK
;

1243 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1245 #ifde‡
CONFIG_X86_32


1271 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1277 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1278 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1290 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
Ë& 
APIC_LVT_MASKED
;

1291 i‡(!
	`smp_¥o˚ss‹_id
(Ë&& (
pic_mode
 || !
vÆue
)) {

1292 
vÆue
 = 
APIC_DM_EXTINT
;

1293 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1294 
	`smp_¥o˚ss‹_id
());

1296 
vÆue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1297 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1298 
	`smp_¥o˚ss‹_id
());

1300 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1305 i‡(!
	`smp_¥o˚ss‹_id
())

1306 
vÆue
 = 
APIC_DM_NMI
;

1308 
vÆue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1309 i‡(!
	`œpic_is_öãgøãd
())

1310 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1311 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1313 
	`¥ìm±_íabÀ
();

1315 #ifde‡
CONFIG_X86_MCE_INTEL


1317 i‡(
	`smp_¥o˚ss‹_id
() == 0)

1318 
	`cmci_ªcheck
();

1320 
	}
}

1322 
__˝uöô
 
	$íd_loˇl_APIC_£tup
()

1324 
	`œpic_£tup_e§
();

1326 #ifde‡
CONFIG_X86_32


1328 
vÆue
;

1330 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1331 
vÆue
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1332 
	`≠ic_wrôe
(
APIC_LVTT
, 
vÆue
);

1336 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

1337 
	`≠ic_pm_a˘iv©e
();

1338 
	}
}

1340 #ifde‡
CONFIG_X86_X2APIC


1341 
	$check_x2≠ic
()

1343 i‡(
	`x2≠ic_íabÀd
()) {

1344 
	`¥_öfo
("x2apicÉnabled by BIOS, switchingÅo x2apic ops\n");

1345 
x2≠ic_¥ì«bÀd
 = 
x2≠ic_mode
 = 1;

1347 
	}
}

1349 
	$íabÀ_x2≠ic
()

1351 
m§
, 
m§2
;

1353 i‡(!
x2≠ic_mode
)

1356 
	`rdm§
(
MSR_IA32_APICBASE
, 
m§
, 
m§2
);

1357 i‡(!(
m§
 & 
X2APIC_ENABLE
)) {

1358 
	`¥_öfo
("Enabling x2apic\n");

1359 
	`wrm§
(
MSR_IA32_APICBASE
, 
m§
 | 
X2APIC_ENABLE
, 0);

1361 
	}
}

1364 
__öô
 
	$íabÀ_IR_x2≠ic
()

1366 #ifde‡
CONFIG_INTR_REMAP


1367 
ªt
;

1368 
Êags
;

1369 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

1371 
ªt
 = 
	`dm¨_èbÀ_öô
();

1372 i‡(
ªt
) {

1373 
	`¥_debug
("dm¨_èbÀ_öô(ËÁûed wôh %d:\n", 
ªt
);

1374 
ú_Áûed
;

1377 i‡(!
	`öå_ªm≠pög_suµ‹ãd
()) {

1378 
	`¥_debug
("intr-remappingÇot supported\n");

1379 
ú_Áûed
;

1383 i‡(!
x2≠ic_¥ì«bÀd
 && 
skù_iﬂpic_£tup
) {

1384 
	`¥_öfo
("SkippedÉnabling intr-remap because of skipping "

1389 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

1390 i‡(!
iﬂpic_íåõs
) {

1391 
	`¥_öfo
("AŒoˇã iﬂpic_íåõ†Áûed: %d\n", 
ªt
);

1392 
íd
;

1395 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

1396 i‡(
ªt
) {

1397 
	`¥_öfo
("Savög IO-APIC sèã faûed: %d\n", 
ªt
);

1398 
íd
;

1401 
	`loˇl_úq_ßve
(
Êags
);

1402 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

1403 
	`mask_8259A
();

1405 
ªt
 = 
	`íabÀ_öå_ªm≠pög
(
	`x2≠ic_suµ‹ãd
());

1406 i‡(
ªt
)

1407 
íd_ª°‹e
;

1409 
	`¥_öfo
("Enabled Interrupt-remapping\n");

1411 i‡(
	`x2≠ic_suµ‹ãd
(Ë&& !
x2≠ic_mode
) {

1412 
x2≠ic_mode
 = 1;

1413 
	`íabÀ_x2≠ic
();

1414 
	`¥_öfo
("Enabled x2apic\n");

1417 
íd_ª°‹e
:

1418 i‡(
ªt
)

1422 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

1424 
	`unmask_8259A
();

1425 
	`loˇl_úq_ª°‹e
(
Êags
);

1427 
íd
:

1428 i‡(
iﬂpic_íåõs
)

1429 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

1431 i‡(!
ªt
)

1434 
ú_Áûed
:

1435 i‡(
x2≠ic_¥ì«bÀd
)

1436 
	`∑nic
("x2apicÉnabled by bios. But IRÉnabling failed");

1437 i‡(
˝u_has_x2≠ic
)

1438 
	`¥_öfo
("NotÉnabling x2apic,Intr-remapping\n");

1440 i‡(!
˝u_has_x2≠ic
)

1443 i‡(
x2≠ic_¥ì«bÀd
)

1444 
	`∑nic
("x2apicÉnabledÖrior OS handover,"

1449 
	}
}

1452 #ifde‡
CONFIG_X86_64


1459 
__öô
 
	$dëe˘_öô_APIC
()

1461 i‡(!
˝u_has_≠ic
) {

1462 
	`¥_öfo
("NoÜocal APICÖresent\n");

1466 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1468 
	}
}

1473 
__öô
 
	$dëe˘_öô_APIC
()

1475 
u32
 
h
, 
l
, 
„©uªs
;

1478 i‡(
dißbÀ_≠ic
)

1481 
boŸ_˝u_d©a
.
x86_víd‹
) {

1482 
X86_VENDOR_AMD
:

1483 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 > 1) ||

1484 (
boŸ_˝u_d©a
.
x86
 >= 15))

1486 
no_≠ic
;

1487 
X86_VENDOR_INTEL
:

1488 i‡(
boŸ_˝u_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1489 (
boŸ_˝u_d©a
.
x86
 =5 && 
˝u_has_≠ic
))

1491 
no_≠ic
;

1493 
no_≠ic
;

1496 i‡(!
˝u_has_≠ic
) {

1501 i‡(!
f‹˚_íabÀ_loˇl_≠ic
) {

1502 
	`¥_öfo
("Local APIC disabled by BIOS -- "

1511 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1512 i‡(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1513 
	`¥_öfo
("Local APIC disabled by BIOS --Ñeenabling.\n");

1514 
l
 &~
MSR_IA32_APICBASE_BASE
;

1515 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1516 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1517 
íabÀd_vü_≠icba£
 = 1;

1524 
„©uªs
 = 
	`˝uid_edx
(1);

1525 i‡(!(
„©uªs
 & (1 << 
X86_FEATURE_APIC
))) {

1526 
	`¥_w¨nög
("CouldÇotÉnable APIC!\n");

1529 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1530 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1533 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1534 i‡(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1535 
mp_œpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1537 
	`¥_öfo
("FoundándÉnabledÜocal APIC!\n");

1539 
	`≠ic_pm_a˘iv©e
();

1543 
no_≠ic
:

1544 
	`¥_öfo
("NoÜocal APICÖresent or hardware disabled\n");

1546 
	}
}

1549 #ifde‡
CONFIG_X86_64


1550 
__öô
 
	$óæy_öô_œpic_m≠pög
()

1552 
phys_addr
;

1558 i‡(!
smp_found_c⁄fig
)

1561 
phys_addr
 = 
mp_œpic_addr
;

1563 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
phys_addr
);

1564 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %16lx (%16lx)\n",

1565 
APIC_BASE
, 
phys_addr
);

1571 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1572 
	}
}

1578 
__öô
 
	$öô_≠ic_m≠pögs
()

1580 
√w_≠icid
;

1582 i‡(
x2≠ic_mode
) {

1583 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1588 i‡(!
smp_found_c⁄fig
 && 
	`dëe˘_öô_APIC
()) {

1590 
	`¥_öfo
("APIC: disableápic facility\n");

1591 
	`≠ic_dißbÀ
();

1593 
≠ic_phys
 = 
mp_œpic_addr
;

1599 i‡(!
a˝i_œpic
)

1600 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
≠ic_phys
);

1602 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %08lx (%08lx)\n",

1603 
APIC_BASE
, 
≠ic_phys
);

1610 
√w_≠icid
 = 
	`ªad_≠ic_id
();

1611 i‡(
boŸ_˝u_physiˇl_≠icid
 !
√w_≠icid
) {

1612 
boŸ_˝u_physiˇl_≠icid
 = 
√w_≠icid
;

1620 
≠ic_vîsi⁄
[
√w_≠icid
] =

1621 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

1623 
	}
}

1629 
	g≠ic_vîsi⁄
[
MAX_APICS
];

1631 
__öô
 
	$APIC_öô_unùro˚ss‹
()

1633 i‡(
dißbÀ_≠ic
) {

1634 
	`¥_öfo
("Apic disabled\n");

1637 #ifde‡
CONFIG_X86_64


1638 i‡(!
˝u_has_≠ic
) {

1639 
dißbÀ_≠ic
 = 1;

1640 
	`¥_öfo
("Apic disabled by BIOS\n");

1644 i‡(!
smp_found_c⁄fig
 && !
˝u_has_≠ic
)

1650 i‡(!
˝u_has_≠ic
 &&

1651 
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

1652 
	`¥_îr
("BIOS bug,Üocal APIC 0x%xÇot detected!...\n",

1653 
boŸ_˝u_physiˇl_≠icid
);

1654 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1659 
	`íabÀ_IR_x2≠ic
();

1660 #ifde‡
CONFIG_X86_64


1661 
	`deÁu…_£tup_≠ic_routög
();

1664 
	`vîify_loˇl_APIC
();

1665 
	`c⁄√˘_b•_APIC
();

1667 #ifde‡
CONFIG_X86_64


1668 
	`≠ic_wrôe
(
APIC_ID
, 
	`SET_APIC_ID
(
boŸ_˝u_physiˇl_≠icid
));

1675 #ifde‡
CONFIG_CRASH_DUMP


1676 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1679 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

1680 
	`£tup_loˇl_APIC
();

1682 #ifde‡
CONFIG_X86_IO_APIC


1687 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1688 
	`íabÀ_IO_APIC
();

1691 
	`íd_loˇl_APIC_£tup
();

1693 #ifde‡
CONFIG_X86_IO_APIC


1694 i‡(
smp_found_c⁄fig
 && !
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1695 
	`£tup_IO_APIC
();

1697 
ƒ_iﬂpics
 = 0;

1698 
	`loˇli£_nmi_w©chdog
();

1701 
	`loˇli£_nmi_w©chdog
();

1704 
	`£tup_boŸ_˛ock
();

1705 #ifde‡
CONFIG_X86_64


1706 
	`check_nmi_w©chdog
();

1710 
	}
}

1719 
	$smp_•urious_öãºu±
(
±_ªgs
 *
ªgs
)

1721 
u32
 
v
;

1723 
	`exô_idÀ
();

1724 
	`úq_íãr
();

1730 
v
 = 
	`≠ic_ªad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1731 i‡(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1732 
	`ack_APIC_úq
();

1734 
	`öc_úq_°©
(
úq_•urious_cou¡
);

1737 
	`¥_öfo
("spurious APIC interrupt on CPU#%d, "

1738 "shouldÇevî h≠≥n.\n", 
	`smp_¥o˚ss‹_id
());

1739 
	`úq_exô
();

1740 
	}
}

1745 
	$smp_îr‹_öãºu±
(
±_ªgs
 *
ªgs
)

1747 
u32
 
v
, 
v1
;

1749 
	`exô_idÀ
();

1750 
	`úq_íãr
();

1752 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1753 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1754 
v1
 = 
	`≠ic_ªad
(
APIC_ESR
);

1755 
	`ack_APIC_úq
();

1756 
	`©omic_öc
(&
úq_îr_cou¡
);

1769 
	`¥_debug
("APICÉrror on CPU%d: %02x(%02x)\n",

1770 
	`smp_¥o˚ss‹_id
(), 
v
 , 
v1
);

1771 
	`úq_exô
();

1772 
	}
}

1777 
__öô
 
	$c⁄√˘_b•_APIC
()

1779 #ifde‡
CONFIG_X86_32


1780 i‡(
pic_mode
) {

1784 
	`˛ór_loˇl_APIC
();

1789 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "leaving PIC mode, "

1791 
	`im¸_pic_to_≠ic
();

1794 i‡(
≠ic
->
íabÀ_≠ic_mode
)

1795 
≠ic
->
	`íabÀ_≠ic_mode
();

1796 
	}
}

1805 
	$disc⁄√˘_b•_APIC
(
vút_wúe_£tup
)

1807 
vÆue
;

1809 #ifde‡
CONFIG_X86_32


1810 i‡(
pic_mode
) {

1817 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "disabling APIC mode, "

1819 
	`im¸_≠ic_to_pic
();

1827 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1828 
vÆue
 &~
APIC_VECTOR_MASK
;

1829 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1830 
vÆue
 |= 0xf;

1831 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1833 i‡(!
vút_wúe_£tup
) {

1838 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1839 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1840 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1841 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1842 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1843 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_EXTINT
);

1844 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1847 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1854 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1855 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1856 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1857 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1858 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1859 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_NMI
);

1860 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1861 
	}
}

1863 
__˝uöô
 
	$gíîic_¥o˚ss‹_öfo
(
≠icid
, 
vîsi⁄
)

1865 
˝u
;

1870 i‡(
vîsi⁄
 == 0x0) {

1871 
	`¥_w¨nög
("BIOS bug, APIC version is 0 for CPU#%d! "

1873 
vîsi⁄
);

1874 
vîsi⁄
 = 0x10;

1876 
≠ic_vîsi⁄
[
≠icid
] = 
vîsi⁄
;

1878 i‡(
num_¥o˚ss‹s
 >
ƒ_˝u_ids
) {

1879 
max
 = 
ƒ_˝u_ids
;

1880 
this˝u
 = 
max
 + 
dißbÀd_˝us
;

1882 
	`¥_w¨nög
(

1884 " Pro˚ss‹ %d/0x%x ign‹ed.\n", 
max
, 
this˝u
, 
≠icid
);

1886 
dißbÀd_˝us
++;

1890 
num_¥o˚ss‹s
++;

1891 
˝u
 = 
	`˝umask_√xt_zîo
(-1, 
˝u_¥e£¡_mask
);

1893 i‡(
vîsi⁄
 !
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])

1894 
	`WARN_ONCE
(1,

1896 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
], 
˝u
, 
vîsi⁄
);

1898 
	`physid_£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
);

1899 i‡(
≠icid
 =
boŸ_˝u_physiˇl_≠icid
) {

1905 
˝u
 = 0;

1907 i‡(
≠icid
 > 
max_physiˇl_≠icid
)

1908 
max_physiˇl_≠icid
 = 
≠icid
;

1910 #ifde‡
CONFIG_X86_32


1918 i‡(
max_physiˇl_≠icid
 >= 8) {

1919 
boŸ_˝u_d©a
.
x86_víd‹
) {

1920 
X86_VENDOR_INTEL
:

1921 i‡(!
	`APIC_XAPIC
(
vîsi⁄
)) {

1922 
def_to_bigsmp
 = 0;

1926 
X86_VENDOR_AMD
:

1927 
def_to_bigsmp
 = 1;

1932 #i‡
	`deföed
(
CONFIG_SMP
Ë|| deföed(
CONFIG_X86_64
)

1933 
	`óæy_≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
≠icid
;

1934 
	`óæy_≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
Ë
≠icid
;

1937 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

1938 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

1939 
	}
}

1941 
	$h¨d_smp_¥o˚ss‹_id
()

1943  
	`ªad_≠ic_id
();

1944 
	}
}

1946 
	$deÁu…_öô_≠ic_ldr
()

1948 
vÆ
;

1950 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1951 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

1952 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_¥o˚ss‹_id
());

1953 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

1954 
	}
}

1956 #ifde‡
CONFIG_X86_32


1957 
	$deÁu…_≠icid_to_node
(
logiˇl_≠icid
)

1959 #ifde‡
CONFIG_SMP


1960  
≠icid_2_node
[
	`h¨d_smp_¥o˚ss‹_id
()];

1964 
	}
}

1970 #ifde‡
CONFIG_PM


1978 
	ma˘ive
;

1980 
	m≠ic_id
;

1981 
	m≠ic_èsk¥i
;

1982 
	m≠ic_ldr
;

1983 
	m≠ic_d‰
;

1984 
	m≠ic_•iv
;

1985 
	m≠ic_lvâ
;

1986 
	m≠ic_lvçc
;

1987 
	m≠ic_lvt0
;

1988 
	m≠ic_lvt1
;

1989 
	m≠ic_lvãº
;

1990 
	m≠ic_tmi˘
;

1991 
	m≠ic_td¸
;

1992 
	m≠ic_thmr
;

1993 } 
	g≠ic_pm_°©e
;

1995 
	$œpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1997 
Êags
;

1998 
maxlvt
;

2000 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2003 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2005 
≠ic_pm_°©e
.
≠ic_id
 = 
	`≠ic_ªad
(
APIC_ID
);

2006 
≠ic_pm_°©e
.
≠ic_èsk¥i
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

2007 
≠ic_pm_°©e
.
≠ic_ldr
 = 
	`≠ic_ªad
(
APIC_LDR
);

2008 
≠ic_pm_°©e
.
≠ic_d‰
 = 
	`≠ic_ªad
(
APIC_DFR
);

2009 
≠ic_pm_°©e
.
≠ic_•iv
 = 
	`≠ic_ªad
(
APIC_SPIV
);

2010 
≠ic_pm_°©e
.
≠ic_lvâ
 = 
	`≠ic_ªad
(
APIC_LVTT
);

2011 i‡(
maxlvt
 >= 4)

2012 
≠ic_pm_°©e
.
≠ic_lvçc
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

2013 
≠ic_pm_°©e
.
≠ic_lvt0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2014 
≠ic_pm_°©e
.
≠ic_lvt1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

2015 
≠ic_pm_°©e
.
≠ic_lvãº
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

2016 
≠ic_pm_°©e
.
≠ic_tmi˘
 = 
	`≠ic_ªad
(
APIC_TMICT
);

2017 
≠ic_pm_°©e
.
≠ic_td¸
 = 
	`≠ic_ªad
(
APIC_TDCR
);

2018 #ifde‡
CONFIG_X86_THERMAL_VECTOR


2019 i‡(
maxlvt
 >= 5)

2020 
≠ic_pm_°©e
.
≠ic_thmr
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

2023 
	`loˇl_úq_ßve
(
Êags
);

2024 
	`dißbÀ_loˇl_APIC
();

2026 i‡(
öå_ªm≠pög_íabÀd
)

2027 
	`dißbÀ_öå_ªm≠pög
();

2029 
	`loˇl_úq_ª°‹e
(
Êags
);

2031 
	}
}

2033 
	$œpic_ªsume
(
sys_devi˚
 *
dev
)

2035 
l
, 
h
;

2036 
Êags
;

2037 
maxlvt
;

2038 
ªt
 = 0;

2039 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

2041 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2044 
	`loˇl_úq_ßve
(
Êags
);

2045 i‡(
öå_ªm≠pög_íabÀd
) {

2046 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

2047 i‡(!
iﬂpic_íåõs
) {

2048 
	`WARN
(1, "Alloc ioapic_entries inÜapicÑesume failed.");

2049 
ªt
 = -
ENOMEM
;

2050 
ª°‹e
;

2053 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

2054 i‡(
ªt
) {

2055 
	`WARN
(1, "Savög IO-APIC sèã faûed: %d\n", 
ªt
);

2056 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2057 
ª°‹e
;

2060 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

2061 
	`mask_8259A
();

2064 i‡(
x2≠ic_mode
)

2065 
	`íabÀ_x2≠ic
();

2073 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2074 
l
 &~
MSR_IA32_APICBASE_BASE
;

2075 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
mp_œpic_addr
;

2076 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2079 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2080 
	`≠ic_wrôe
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2081 
	`≠ic_wrôe
(
APIC_ID
, 
≠ic_pm_°©e
.
≠ic_id
);

2082 
	`≠ic_wrôe
(
APIC_DFR
, 
≠ic_pm_°©e
.
≠ic_d‰
);

2083 
	`≠ic_wrôe
(
APIC_LDR
, 
≠ic_pm_°©e
.
≠ic_ldr
);

2084 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
≠ic_pm_°©e
.
≠ic_èsk¥i
);

2085 
	`≠ic_wrôe
(
APIC_SPIV
, 
≠ic_pm_°©e
.
≠ic_•iv
);

2086 
	`≠ic_wrôe
(
APIC_LVT0
, 
≠ic_pm_°©e
.
≠ic_lvt0
);

2087 
	`≠ic_wrôe
(
APIC_LVT1
, 
≠ic_pm_°©e
.
≠ic_lvt1
);

2088 #i‡
	`deföed
(
CONFIG_X86_MCE_P4THERMAL
Ë|| deföed(
CONFIG_X86_MCE_INTEL
)

2089 i‡(
maxlvt
 >= 5)

2090 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
≠ic_pm_°©e
.
≠ic_thmr
);

2092 i‡(
maxlvt
 >= 4)

2093 
	`≠ic_wrôe
(
APIC_LVTPC
, 
≠ic_pm_°©e
.
≠ic_lvçc
);

2094 
	`≠ic_wrôe
(
APIC_LVTT
, 
≠ic_pm_°©e
.
≠ic_lvâ
);

2095 
	`≠ic_wrôe
(
APIC_TDCR
, 
≠ic_pm_°©e
.
≠ic_td¸
);

2096 
	`≠ic_wrôe
(
APIC_TMICT
, 
≠ic_pm_°©e
.
≠ic_tmi˘
);

2097 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2098 
	`≠ic_ªad
(
APIC_ESR
);

2099 
	`≠ic_wrôe
(
APIC_LVTERR
, 
≠ic_pm_°©e
.
≠ic_lvãº
);

2100 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2101 
	`≠ic_ªad
(
APIC_ESR
);

2103 i‡(
öå_ªm≠pög_íabÀd
) {

2104 
	`ªíabÀ_öå_ªm≠pög
(
x2≠ic_mode
);

2105 
	`unmask_8259A
();

2106 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

2107 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2109 
ª°‹e
:

2110 
	`loˇl_úq_ª°‹e
(
Êags
);

2112  
ªt
;

2113 
	}
}

2120 
sysdev_˛ass
 
	gœpic_sys˛ass
 = {

2121 .
«me
 = "lapic",

2122 .
	gªsume
 = 
œpic_ªsume
,

2123 .
	gsu•íd
 = 
œpic_su•íd
,

2126 
sys_devi˚
 
	gdevi˚_œpic
 = {

2127 .
id
 = 0,

2128 .
	g˛s
 = &
œpic_sys˛ass
,

2131 
__˝uöô
 
	$≠ic_pm_a˘iv©e
()

2133 
≠ic_pm_°©e
.
a˘ive
 = 1;

2134 
	}
}

2136 
__öô
 
	$öô_œpic_sysfs
()

2138 
îr‹
;

2140 i‡(!
˝u_has_≠ic
)

2144 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
œpic_sys˛ass
);

2145 i‡(!
îr‹
)

2146 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic
);

2147  
îr‹
;

2148 
	}
}

2151 
c‹e_öôˇŒ
(
öô_œpic_sysfs
);

2155 
	$≠ic_pm_a˘iv©e
(Ë{ 
	}
}

2159 #ifde‡
CONFIG_X86_64


2161 
__˝uöô
 
	$≠ic_˛u°î_num
()

2163 
i
, 
˛u°îs
, 
zîos
;

2164 
id
;

2165 
u16
 *
bios_˝u_≠icid
;

2166 
	`DECLARE_BITMAP
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2168 
bios_˝u_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
);

2169 
	`bôm≠_zîo
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2171 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

2173 i‡(
bios_˝u_≠icid
) {

2174 
id
 = 
bios_˝u_≠icid
[
i
];

2175 } i‡(
i
 < 
ƒ_˝u_ids
) {

2176 i‡(
	`˝u_¥e£¡
(
i
))

2177 
id
 = 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
i
);

2183 i‡(
id
 !
BAD_APICID
)

2184 
	`__£t_bô
(
	`APIC_CLUSTERID
(
id
), 
˛u°îm≠
);

2193 
˛u°îs
 = 0;

2194 
zîos
 = 0;

2195 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2196 i‡(
	`ã°_bô
(
i
, 
˛u°îm≠
)) {

2197 
˛u°îs
 +1 + 
zîos
;

2198 
zîos
 = 0;

2200 ++
zîos
;

2203  
˛u°îs
;

2204 
	}
}

2206 
__˝uöôd©a
 
	gmu…i_checked
;

2207 
__˝uöôd©a
 
	gmu…i
;

2209 
__˝uöô
 
	$£t_mu…i
(c⁄° 
dmi_sy°em_id
 *
d
)

2211 i‡(
mu…i
)

2213 
	`¥_öfo
("APIC: %†dëe˘ed, Mu…òChassis\n", 
d
->
idít
);

2214 
mu…i
 = 1;

2216 
	}
}

2218 c⁄° 
__˝uöôc⁄°
 
dmi_sy°em_id
 
	gmu…i_dmi_èbÀ
[] = {

2220 .
ˇŒback
 = 
£t_mu…i
,

2221 .
	gidít
 = "IBM System Summit2",

2222 .
	gm©ches
 = {

2223 
DMI_MATCH
(
DMI_SYS_VENDOR
, "IBM"),

2224 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Summit2"),

2230 
__˝uöô
 
	$dmi_check_mu…i
()

2232 i‡(
mu…i_checked
)

2235 
	`dmi_check_sy°em
(
mu…i_dmi_èbÀ
);

2236 
mu…i_checked
 = 1;

2237 
	}
}

2247 
__˝uöô
 
	$≠ic_is_˛u°îed_box
()

2249 
	`dmi_check_mu…i
();

2250 i‡(
mu…i
)

2253 i‡(!
	`is_vsmp_box
())

2260 i‡(
	`≠ic_˛u°î_num
() > 1)

2264 
	}
}

2270 
__öô
 
	$£tup_dißbÀ≠ic
(*
¨g
)

2272 
dißbÀ_≠ic
 = 1;

2273 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

2275 
	}
}

2276 
óæy_∑øm
("dißbÀ≠ic", 
£tup_dißbÀ≠ic
);

2279 
__öô
 
	$£tup_nﬁ≠ic
(*
¨g
)

2281  
	`£tup_dißbÀ≠ic
(
¨g
);

2282 
	}
}

2283 
óæy_∑øm
("nﬁ≠ic", 
£tup_nﬁ≠ic
);

2285 
__öô
 
	$∑r£_œpic_timî_c2_ok
(*
¨g
)

2287 
loˇl_≠ic_timî_c2_ok
 = 1;

2289 
	}
}

2290 
óæy_∑øm
("œpic_timî_c2_ok", 
∑r£_œpic_timî_c2_ok
);

2292 
__öô
 
	$∑r£_dißbÀ_≠ic_timî
(*
¨g
)

2294 
dißbÀ_≠ic_timî
 = 1;

2296 
	}
}

2297 
óæy_∑øm
("nﬂpi˘imî", 
∑r£_dißbÀ_≠ic_timî
);

2299 
__öô
 
	$∑r£_nﬁ≠ic_timî
(*
¨g
)

2301 
dißbÀ_≠ic_timî
 = 1;

2303 
	}
}

2304 
óæy_∑øm
("nﬁ≠ic_timî", 
∑r£_nﬁ≠ic_timî
);

2306 
__öô
 
	$≠ic_£t_vîbosôy
(*
¨g
)

2308 i‡(!
¨g
) {

2309 #ifde‡
CONFIG_X86_64


2310 
skù_iﬂpic_£tup
 = 0;

2313  -
EINVAL
;

2316 i‡(
	`°rcmp
("debug", 
¨g
) == 0)

2317 
≠ic_vîbosôy
 = 
APIC_DEBUG
;

2318 i‡(
	`°rcmp
("vîbo£", 
¨g
) == 0)

2319 
≠ic_vîbosôy
 = 
APIC_VERBOSE
;

2321 
	`¥_w¨nög
("APIC VerbosityÜevel %sÇotÑecognised"

2322 " u£ápic=vîbo£ o∏≠ic=debug\n", 
¨g
);

2323  -
EINVAL
;

2327 
	}
}

2328 
óæy_∑øm
("≠ic", 
≠ic_£t_vîbosôy
);

2330 
__öô
 
	$œpic_ö£π_ªsour˚
()

2332 i‡(!
≠ic_phys
)

2336 
œpic_ªsour˚
.
°¨t
 = 
≠ic_phys
;

2337 
œpic_ªsour˚
.
íd
 =Ü≠ic_ªsour˚.
°¨t
 + 
PAGE_SIZE
 - 1;

2338 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
œpic_ªsour˚
);

2341 
	}
}

2347 
œã_öôˇŒ
(
œpic_ö£π_ªsour˚
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/≠ic.h
>

21 
	~<asm/ùi.h
>

23 #ifde‡
CONFIG_ACPI


24 
	~<a˝i/a˝i_bus.h
>

27 
	$Ê©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

30 
	}
}

32 c⁄° 
˝umask
 *
	$Ê©_èrgë_˝us
()

34  
˝u_⁄löe_mask
;

35 
	}
}

37 
	$Ê©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

47 
	`˝umask_˛ór
(
ªtmask
);

48 
	`˝umask_bôs
(
ªtmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$Ê©_öô_≠ic_ldr
()

60 
vÆ
;

61 
num
, 
id
;

63 
num
 = 
	`smp_¥o˚ss‹_id
();

64 
id
 = 1UL << 
num
;

65 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

67 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

69 
	}
}

71 
ölöe
 
	$_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
)

73 
Êags
;

75 
	`loˇl_úq_ßve
(
Êags
);

76 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

77 
	`loˇl_úq_ª°‹e
(
Êags
);

78 
	}
}

80 
	$Ê©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

82 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

84 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

85 
	}
}

88 
	$Ê©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

90 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

91 
˝u
 = 
	`smp_¥o˚ss‹_id
();

93 i‡(
˝u
 < 
BITS_PER_LONG
)

94 
	`˛ór_bô
(
˝u
, &
mask
);

96 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

97 
	}
}

99 
	$Ê©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

101 
˝u
 = 
	`smp_¥o˚ss‹_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hŸ∂ug
 = 1;

105 
hŸ∂ug
 = 0;

107 i‡(
hŸ∂ug
 || 
ve˘‹
 =
NMI_VECTOR
) {

108 i‡(!
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
	`˝umask_of
(
˝u
))) {

109 
mask
 = 
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0];

111 i‡(
˝u
 < 
BITS_PER_LONG
)

112 
	`˛ór_bô
(
˝u
, &
mask
);

114 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

116 } i‡(
	`num_⁄löe_˝us
() > 1) {

117 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLBUT
,

118 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

120 
	}
}

122 
	$Ê©_£nd_IPI_Æl
(
ve˘‹
)

124 i‡(
ve˘‹
 =
NMI_VECTOR
) {

125 
	`Ê©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

127 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLINC
,

128 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

130 
	}
}

132 
	$Ê©_gë_≠ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_≠ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$ªad_x≠ic_id
()

151 
id
;

153 
id
 = 
	`Ê©_gë_≠ic_id
(
	`≠ic_ªad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$Ê©_≠ic_id_ªgi°îed
()

159  
	`physid_is£t
(
	`ªad_x≠ic_id
(), 
phys_˝u_¥e£¡_m≠
);

160 
	}
}

162 
	$Ê©_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

164  
öôül_≠ic_id
 >> 
ödex_msb
;

165 
	}
}

167 
≠ic
 
	g≠ic_Ê©
 = {

168 .
«me
 = "flat",

169 .
	g¥obe
 = 
NULL
,

170 .
	ga˝i_madt_€m_check
 = 
Ê©_a˝i_madt_€m_check
,

171 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

173 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

174 .
	gúq_de°_mode
 = 1,

176 .
	gèrgë_˝us
 = 
Ê©_èrgë_˝us
,

177 .
	gdißbÀ_e§
 = 0,

178 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_≠icid_u£d
 = 
NULL
,

180 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

182 .
	gve˘‹_Æloˇti⁄_domaö
 = 
Ê©_ve˘‹_Æloˇti⁄_domaö
,

183 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

185 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

186 .
	g£tup_≠ic_routög
 = 
NULL
,

187 .
	gmu…i_timî_check
 = 
NULL
,

188 .
	g≠icid_to_node
 = 
NULL
,

189 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

190 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

191 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

192 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

193 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

194 .
	gíabÀ_≠ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

196 .
	gmps_€m_check
 = 
NULL
,

198 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

199 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

200 .
	g≠ic_id_mask
 = 0xFFu << 24,

202 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

203 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

205 .
	g£nd_IPI_mask
 = 
Ê©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_Ælbut£lf
 = 
Ê©_£nd_IPI_mask_Ælbut£lf
,

207 .
	g£nd_IPI_Ælbut£lf
 = 
Ê©_£nd_IPI_Ælbut£lf
,

208 .
	g£nd_IPI_Æl
 = 
Ê©_£nd_IPI_Æl
,

209 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

211 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

214 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

215 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

217 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

218 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

219 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

220 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

221 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

222 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

230 
	$physÊ©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

232 #ifde‡
CONFIG_ACPI


238 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

239 (
a˝i_gbl_FADT
.
Êags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`¥ötk
(
KERN_DEBUG
 "system APIC only can useÖhysical flat");

246 
	}
}

248 c⁄° 
˝umask
 *
	$physÊ©_èrgë_˝us
()

250  
˝u_⁄löe_mask
;

251 
	}
}

253 
	$physÊ©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

255 
	`˝umask_˛ór
(
ªtmask
);

256 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

257 
	}
}

259 
	$physÊ©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

261 
	`deÁu…_£nd_IPI_mask_£quí˚_phys
(
˝umask
, 
ve˘‹
);

262 
	}
}

264 
	$physÊ©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *cpumask,

265 
ve˘‹
)

267 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝umask
, 
ve˘‹
);

268 
	}
}

270 
	$physÊ©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

272 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝u_⁄löe_mask
, 
ve˘‹
);

273 
	}
}

275 
	$physÊ©_£nd_IPI_Æl
(
ve˘‹
)

277 
	`physÊ©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

278 
	}
}

280 
	$physÊ©_˝u_mask_to_≠icid
(c⁄° 
˝umask
 *cpumask)

282 
˝u
;

288 
˝u
 = 
	`˝umask_fú°
(
˝umask
);

289 i‡(()
˝u
 < 
ƒ_˝u_ids
)

290  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

292  
BAD_APICID
;

293 
	}
}

296 
	$physÊ©_˝u_mask_to_≠icid_™d
(c⁄° 
˝umask
 *cpumask,

297 c⁄° 
˝umask
 *
™dmask
)

299 
˝u
;

305 
	`f‹_óch_˝u_™d
(
˝u
, 
˝umask
, 
™dmask
) {

306 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_⁄löe_mask
))

309 i‡(
˝u
 < 
ƒ_˝u_ids
)

310  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

312  
BAD_APICID
;

313 
	}
}

315 
≠ic
 
	g≠ic_physÊ©
 = {

317 .
«me
 = "physical flat",

318 .
	g¥obe
 = 
NULL
,

319 .
	ga˝i_madt_€m_check
 = 
physÊ©_a˝i_madt_€m_check
,

320 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

322 .
	gúq_dñivîy_mode
 = 
de°_Fixed
,

323 .
	gúq_de°_mode
 = 0,

325 .
	gèrgë_˝us
 = 
physÊ©_èrgë_˝us
,

326 .
	gdißbÀ_e§
 = 0,

327 .
	gde°_logiˇl
 = 0,

328 .
	gcheck_≠icid_u£d
 = 
NULL
,

329 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

331 .
	gve˘‹_Æloˇti⁄_domaö
 = 
physÊ©_ve˘‹_Æloˇti⁄_domaö
,

333 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

335 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

336 .
	g£tup_≠ic_routög
 = 
NULL
,

337 .
	gmu…i_timî_check
 = 
NULL
,

338 .
	g≠icid_to_node
 = 
NULL
,

339 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

340 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

341 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

342 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

343 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

344 .
	gíabÀ_≠ic_mode
 = 
NULL
,

345 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

346 .
	gmps_€m_check
 = 
NULL
,

348 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

349 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

350 .
	g≠ic_id_mask
 = 0xFFu << 24,

352 .
	g˝u_mask_to_≠icid
 = 
physÊ©_˝u_mask_to_≠icid
,

353 .
	g˝u_mask_to_≠icid_™d
 = 
physÊ©_˝u_mask_to_≠icid_™d
,

355 .
	g£nd_IPI_mask
 = 
physÊ©_£nd_IPI_mask
,

356 .
	g£nd_IPI_mask_Ælbut£lf
 = 
physÊ©_£nd_IPI_mask_Ælbut£lf
,

357 .
	g£nd_IPI_Ælbut£lf
 = 
physÊ©_£nd_IPI_Ælbut£lf
,

358 .
	g£nd_IPI_Æl
 = 
physÊ©_£nd_IPI_Æl
,

359 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

361 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

362 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

363 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

364 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

365 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

367 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

368 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

369 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

370 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

371 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

372 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<löux/mm.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/sched.h
>

28 
	~<löux/pci.h
>

29 
	~<löux/mc146818πc.h
>

30 
	~<löux/compûî.h
>

31 
	~<löux/a˝i.h
>

32 
	~<löux/moduÀ.h
>

33 
	~<löux/sysdev.h
>

34 
	~<löux/msi.h
>

35 
	~<löux/htúq.h
>

36 
	~<löux/‰ìzî.h
>

37 
	~<löux/kthªad.h
>

38 
	~<löux/jiffõs.h
>

39 #ifde‡
CONFIG_ACPI


40 
	~<a˝i/a˝i_bus.h
>

42 
	~<löux/boŸmem.h
>

43 
	~<löux/dm¨.h
>

44 
	~<löux/h≥t.h
>

46 
	~<asm/idÀ.h
>

47 
	~<asm/io.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/˝u.h
>

50 
	~<asm/desc.h
>

51 
	~<asm/¥Ÿo.h
>

52 
	~<asm/a˝i.h
>

53 
	~<asm/dma.h
>

54 
	~<asm/timî.h
>

55 
	~<asm/i8259.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/msidef.h
>

58 
	~<asm/hy≥πøn•‹t.h
>

59 
	~<asm/£tup.h
>

60 
	~<asm/úq_ªm≠pög.h
>

61 
	~<asm/h≥t.h
>

62 
	~<asm/hw_úq.h
>

63 
	~<asm/uv/uv_hub.h
>

64 
	~<asm/uv/uv_úq.h
>

66 
	~<asm/≠ic.h
>

68 
	#__≠icdebugöô
(
ty≥
Ëty≥ 
__öô


	)

74 
	gsis_≠ic_bug
 = -1;

76 
DEFINE_SPINLOCK
(
iﬂpic_lock
);

77 
DEFINE_SPINLOCK
(
ve˘‹_lock
);

82 
	gƒ_iﬂpic_ªgi°îs
[
MAX_IO_APICS
];

85 
mpc_iﬂpic
 
	gmp_iﬂpics
[
MAX_IO_APICS
];

86 
	gƒ_iﬂpics
;

89 
mpc_öt§c
 
	gmp_úqs
[
MAX_IRQ_SOURCES
];

92 
	gmp_úq_íåõs
;

94 #i‡
deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

95 
	gmp_bus_id_to_ty≥
[
MAX_MP_BUSSES
];

98 
DECLARE_BITMAP
(
mp_bus_nŸ_pci
, 
MAX_MP_BUSSES
);

100 
	gskù_iﬂpic_£tup
;

102 
	$¨ch_dißbÀ_smp_suµ‹t
()

104 #ifde‡
CONFIG_PCI


105 
noiﬂpicquúk
 = 1;

106 
noiﬂpi¸îouã
 = -1;

108 
skù_iﬂpic_£tup
 = 1;

109 
	}
}

111 
__öô
 
	$∑r£_nﬂpic
(*
°r
)

114 
	`¨ch_dißbÀ_smp_suµ‹t
();

116 
	}
}

117 
óæy_∑øm
("nﬂpic", 
∑r£_nﬂpic
);

119 
	gúq_pö_li°
;

128 
	súq_pö_li°
 {

129 
	m≠ic
, 
	mpö
;

130 
úq_pö_li°
 *
	m√xt
;

133 
úq_pö_li°
 *
	$gë_⁄e_‰ì_úq_2_pö
(
node
)

135 
úq_pö_li°
 *
pö
;

137 
pö
 = 
	`kzÆloc_node
((*pö), 
GFP_ATOMIC
, 
node
);

139  
pö
;

140 
	}
}

142 
	súq_cfg
 {

143 
úq_pö_li°
 *
	múq_2_pö
;

144 
˝umask_v¨_t
 
	mdomaö
;

145 
˝umask_v¨_t
 
	mﬁd_domaö
;

146 
	mmove_˛ónup_cou¡
;

147 
u8
 
	mve˘‹
;

148 
u8
 
	mmove_ö_¥ogªss
 : 1;

152 #ifde‡
CONFIG_SPARSE_IRQ


153 
úq_cfg
 
	gúq_cfgx
[] = {

155 
úq_cfg
 
úq_cfgx
[
NR_IRQS
] = {

157 [0] = { .
ve˘‹
 = 
IRQ0_VECTOR
, },

158 [1] = { .
ve˘‹
 = 
IRQ1_VECTOR
, },

159 [2] = { .
ve˘‹
 = 
IRQ2_VECTOR
, },

160 [3] = { .
ve˘‹
 = 
IRQ3_VECTOR
, },

161 [4] = { .
ve˘‹
 = 
IRQ4_VECTOR
, },

162 [5] = { .
ve˘‹
 = 
IRQ5_VECTOR
, },

163 [6] = { .
ve˘‹
 = 
IRQ6_VECTOR
, },

164 [7] = { .
ve˘‹
 = 
IRQ7_VECTOR
, },

165 [8] = { .
ve˘‹
 = 
IRQ8_VECTOR
, },

166 [9] = { .
ve˘‹
 = 
IRQ9_VECTOR
, },

167 [10] = { .
ve˘‹
 = 
IRQ10_VECTOR
, },

168 [11] = { .
ve˘‹
 = 
IRQ11_VECTOR
, },

169 [12] = { .
ve˘‹
 = 
IRQ12_VECTOR
, },

170 [13] = { .
ve˘‹
 = 
IRQ13_VECTOR
, },

171 [14] = { .
ve˘‹
 = 
IRQ14_VECTOR
, },

172 [15] = { .
ve˘‹
 = 
IRQ15_VECTOR
, },

175 
__öô
 
	$¨ch_óæy_úq_öô
()

177 
úq_cfg
 *
cfg
;

178 
úq_desc
 *
desc
;

179 
cou¡
;

180 
node
;

181 
i
;

183 
cfg
 = 
úq_cfgx
;

184 
cou¡
 = 
	`ARRAY_SIZE
(
úq_cfgx
);

185 
node

	`˝u_to_node
(
boŸ_˝u_id
);

187 
i
 = 0; i < 
cou¡
; i++) {

188 
desc
 = 
	`úq_to_desc
(
i
);

189 
desc
->
chù_d©a
 = &
cfg
[
i
];

190 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
domaö
, 
GFP_NOWAIT
, 
node
);

191 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
ﬁd_domaö
, 
GFP_NOWAIT
, 
node
);

192 i‡(
i
 < 
NR_IRQS_LEGACY
)

193 
	`˝umask_£èŒ
(
cfg
[
i
].
domaö
);

197 
	}
}

199 #ifde‡
CONFIG_SPARSE_IRQ


200 
úq_cfg
 *
	$úq_cfg
(
úq
)

202 
úq_cfg
 *
cfg
 = 
NULL
;

203 
úq_desc
 *
desc
;

205 
desc
 = 
	`úq_to_desc
(
úq
);

206 i‡(
desc
)

207 
cfg
 = 
desc
->
chù_d©a
;

209  
cfg
;

210 
	}
}

212 
úq_cfg
 *
	$gë_⁄e_‰ì_úq_cfg
(
node
)

214 
úq_cfg
 *
cfg
;

216 
cfg
 = 
	`kzÆloc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

217 i‡(
cfg
) {

218 i‡(!
	`Æloc_˝umask_v¨_node
(&
cfg
->
domaö
, 
GFP_ATOMIC
, 
node
)) {

219 
	`k‰ì
(
cfg
);

220 
cfg
 = 
NULL
;

221 } i‡(!
	`Æloc_˝umask_v¨_node
(&
cfg
->
ﬁd_domaö
,

222 
GFP_ATOMIC
, 
node
)) {

223 
	`‰ì_˝umask_v¨
(
cfg
->
domaö
);

224 
	`k‰ì
(
cfg
);

225 
cfg
 = 
NULL
;

227 
	`˝umask_˛ór
(
cfg
->
domaö
);

228 
	`˝umask_˛ór
(
cfg
->
ﬁd_domaö
);

232  
cfg
;

233 
	}
}

235 
	$¨ch_öô_chù_d©a
(
úq_desc
 *
desc
, 
node
)

237 
úq_cfg
 *
cfg
;

239 
cfg
 = 
desc
->
chù_d©a
;

240 i‡(!
cfg
) {

241 
desc
->
chù_d©a
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

242 i‡(!
desc
->
chù_d©a
) {

243 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_cfg\n");

244 
	`BUG_ON
(1);

249 
	}
}

253 
	$öô_c›y_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
, 
node
)

255 
úq_pö_li°
 *
ﬁd_íåy
, *
hód
, *
èû
, *
íåy
;

257 
cfg
->
úq_2_pö
 = 
NULL
;

258 
ﬁd_íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

259 i‡(!
ﬁd_íåy
)

262 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

263 i‡(!
íåy
)

266 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

267 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

268 
hód
 = 
íåy
;

269 
èû
 = 
íåy
;

270 
ﬁd_íåy
 = old_íåy->
√xt
;

271 
ﬁd_íåy
) {

272 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

273 i‡(!
íåy
) {

274 
íåy
 = 
hód
;

275 
íåy
) {

276 
hód
 = 
íåy
->
√xt
;

277 
	`k‰ì
(
íåy
);

278 
íåy
 = 
hód
;

283 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

284 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

285 
èû
->
√xt
 = 
íåy
;

286 
èû
 = 
íåy
;

287 
ﬁd_íåy
 = old_íåy->
√xt
;

290 
èû
->
√xt
 = 
NULL
;

291 
cfg
->
úq_2_pö
 = 
hód
;

292 
	}
}

294 
	$‰ì_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
)

296 
úq_pö_li°
 *
íåy
, *
√xt
;

298 i‡(
ﬁd_cfg
->
úq_2_pö
 =
cfg
->irq_2_pin)

301 
íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

303 
íåy
) {

304 
√xt
 = 
íåy
->next;

305 
	`k‰ì
(
íåy
);

306 
íåy
 = 
√xt
;

308 
ﬁd_cfg
->
úq_2_pö
 = 
NULL
;

309 
	}
}

311 
	$¨ch_öô_c›y_chù_d©a
(
úq_desc
 *
ﬁd_desc
,

312 
úq_desc
 *
desc
, 
node
)

314 
úq_cfg
 *
cfg
;

315 
úq_cfg
 *
ﬁd_cfg
;

317 
cfg
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

319 i‡(!
cfg
)

322 
desc
->
chù_d©a
 = 
cfg
;

324 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

326 
	`mem˝y
(
cfg
, 
ﬁd_cfg
, (
úq_cfg
));

328 
	`öô_c›y_úq_2_pö
(
ﬁd_cfg
, 
cfg
, 
node
);

329 
	}
}

331 
	$‰ì_úq_cfg
(
úq_cfg
 *
ﬁd_cfg
)

333 
	`k‰ì
(
ﬁd_cfg
);

334 
	}
}

336 
	$¨ch_‰ì_chù_d©a
(
úq_desc
 *
ﬁd_desc
, úq_des¯*
desc
)

338 
úq_cfg
 *
ﬁd_cfg
, *
cfg
;

340 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

341 
cfg
 = 
desc
->
chù_d©a
;

343 i‡(
ﬁd_cfg
 =
cfg
)

346 i‡(
ﬁd_cfg
) {

347 
	`‰ì_úq_2_pö
(
ﬁd_cfg
, 
cfg
);

348 
	`‰ì_úq_cfg
(
ﬁd_cfg
);

349 
ﬁd_desc
->
chù_d©a
 = 
NULL
;

351 
	}
}

355 
úq_cfg
 *
	$úq_cfg
(
úq
)

357  
úq
 < 
ƒ_úqs
 ? 
úq_cfgx
 + irq : 
NULL
;

358 
	}
}

362 
	sio_≠ic
 {

363 
	mödex
;

364 
	munu£d
[3];

365 
	md©a
;

366 
	munu£d2
[11];

367 
	meoi
;

370 
__©åibuã_c⁄°__
 
io_≠ic
 
__iomem
 *
	$io_≠ic_ba£
(
idx
)

372  (
__iomem
 *Ë
	`__fix_to_vút
(
FIX_IO_APIC_BASE_0
 + 
idx
)

373 + (
mp_iﬂpics
[
idx
].
≠iˇddr
 & ~
PAGE_MASK
);

374 
	}
}

376 
ölöe
 
	$io_≠ic_eoi
(
≠ic
, 
ve˘‹
)

378 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

379 
	`wrôñ
(
ve˘‹
, &
io_≠ic
->
eoi
);

380 
	}
}

382 
ölöe
 
	$io_≠ic_ªad
(
≠ic
, 
ªg
)

384 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

385 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

386  
	`ªadl
(&
io_≠ic
->
d©a
);

387 
	}
}

389 
ölöe
 
	$io_≠ic_wrôe
(
≠ic
, 
ªg
, 
vÆue
)

391 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

392 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

393 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

394 
	}
}

402 
ölöe
 
	$io_≠ic_modify
(
≠ic
, 
ªg
, 
vÆue
)

404 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

406 i‡(
sis_≠ic_bug
)

407 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

408 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

409 
	}
}

411 
boﬁ
 
	$io_≠ic_Àvñ_ack_≥ndög
(
úq_cfg
 *
cfg
)

413 
úq_pö_li°
 *
íåy
;

414 
Êags
;

416 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

417 
íåy
 = 
cfg
->
úq_2_pö
;

419 
ªg
;

420 
pö
;

422 i‡(!
íåy
)

424 
pö
 = 
íåy
->pin;

425 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
*2);

427 i‡(
ªg
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

428 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

429  
åue
;

431 i‡(!
íåy
->
√xt
)

433 
íåy
 =É¡ry->
√xt
;

435 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

437  
Ál£
;

438 
	}
}

440 
	uíåy_uni⁄
 {

441 °ru˘ { 
u32
 
	mw1
, 
	mw2
; };

442 
IO_APIC_rouã_íåy
 
	míåy
;

445 
IO_APIC_rouã_íåy
 
	$iﬂpic_ªad_íåy
(
≠ic
, 
pö
)

447 
íåy_uni⁄
 
eu
;

448 
Êags
;

449 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

450 
eu
.
w1
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 2 * 
pö
);

451 
eu
.
w2
 = 
	`io_≠ic_ªad
(
≠ic
, 0x11 + 2 * 
pö
);

452 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

453  
eu
.
íåy
;

454 
	}
}

463 
	$__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

465 
íåy_uni⁄
 
eu
 = {{0, 0}};

467 
eu
.
íåy
 = 
e
;

468 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

469 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

470 
	}
}

472 
	$iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

474 
Êags
;

475 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

476 
	`__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
e
);

477 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

478 
	}
}

485 
	$iﬂpic_mask_íåy
(
≠ic
, 
pö
)

487 
Êags
;

488 
íåy_uni⁄
 
eu
 = { .
íåy
.
mask
 = 1 };

490 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

491 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

492 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

493 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

494 
	}
}

501 
	$add_pö_to_úq_node
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

503 
úq_pö_li°
 *
íåy
;

505 
íåy
 = 
cfg
->
úq_2_pö
;

506 i‡(!
íåy
) {

507 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

508 i‡(!
íåy
) {

509 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_2_pinÅoádd %d - %d\n",

510 
≠ic
, 
pö
);

513 
cfg
->
úq_2_pö
 = 
íåy
;

514 
íåy
->
≠ic
 =ápic;

515 
íåy
->
pö
 =Öin;

519 
íåy
->
√xt
) {

521 i‡(
íåy
->
≠ic
 =≠i¯&&É¡ry->
pö
 ==Öin)

524 
íåy
 =É¡ry->
√xt
;

527 
íåy
->
√xt
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

528 
íåy
 =É¡ry->
√xt
;

529 
íåy
->
≠ic
 =ápic;

530 
íåy
->
pö
 =Öin;

531 
	}
}

536 
__öô
 
	$ª∂a˚_pö_©_úq_node
(
úq_cfg
 *
cfg
, 
node
,

537 
ﬁd≠ic
, 
ﬁdpö
,

538 
√w≠ic
, 
√wpö
)

540 
úq_pö_li°
 *
íåy
 = 
cfg
->
úq_2_pö
;

541 
ª∂a˚d
 = 0;

543 
íåy
) {

544 i‡(
íåy
->
≠ic
 =
ﬁd≠ic
 &&É¡ry->
pö
 =
ﬁdpö
) {

545 
íåy
->
≠ic
 = 
√w≠ic
;

546 
íåy
->
pö
 = 
√wpö
;

547 
ª∂a˚d
 = 1;

551 
íåy
 =É¡ry->
√xt
;

555 i‡(!
ª∂a˚d
)

556 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
√w≠ic
, 
√wpö
);

557 
	}
}

559 
ölöe
 
io_≠ic_modify_úq
(
úq_cfg
 *
cfg
,

560 
mask_™d
, 
mask_‹
,

561 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

563 
pö
;

564 
úq_pö_li°
 *
íåy
;

566 
íåy
 = 
cfg
->
úq_2_pö
;É¡ry !
NULL
;É¡ry =É¡ry->
√xt
) {

567 
ªg
;

568 
pö
 = 
íåy
->pin;

569 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2);

570 
ªg
 &
mask_™d
;

571 
ªg
 |
mask_‹
;

572 
	`io_≠ic_modify
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2, 
ªg
);

573 i‡(
föÆ
)

574 
	`föÆ
(
íåy
);

576 
	}
}

578 
	$__unmask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

580 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

581 
	}
}

583 #ifde‡
CONFIG_X86_64


584 
	$io_≠ic_sync
(
úq_pö_li°
 *
íåy
)

590 
io_≠ic
 
__iomem
 *io_apic;

591 
io_≠ic
 = 
	`io_≠ic_ba£
(
íåy
->
≠ic
);

592 
	`ªadl
(&
io_≠ic
->
d©a
);

593 
	}
}

595 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

597 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_≠ic_sync
);

598 
	}
}

600 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

602 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, 
NULL
);

603 
	}
}

605 
	$__mask_™d_edge_IO_APIC_úq
(
úq_cfg
 *
cfg
)

607 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

608 
IO_APIC_REDIR_MASKED
, 
NULL
);

609 
	}
}

611 
	$__unmask_™d_Àvñ_IO_APIC_úq
(
úq_cfg
 *
cfg
)

613 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
,

614 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

615 
	}
}

618 
	$mask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

620 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

621 
Êags
;

623 
	`BUG_ON
(!
cfg
);

625 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

626 
	`__mask_IO_APIC_úq
(
cfg
);

627 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

628 
	}
}

630 
	$unmask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

632 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

633 
Êags
;

635 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

636 
	`__unmask_IO_APIC_úq
(
cfg
);

637 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

638 
	}
}

640 
	$mask_IO_APIC_úq
(
úq
)

642 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

644 
	`mask_IO_APIC_úq_desc
(
desc
);

645 
	}
}

646 
	$unmask_IO_APIC_úq
(
úq
)

648 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

650 
	`unmask_IO_APIC_úq_desc
(
desc
);

651 
	}
}

653 
	$˛ór_IO_APIC_pö
(
≠ic
, 
pö
)

655 
IO_APIC_rouã_íåy
 
íåy
;

658 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

659 i‡(
íåy
.
dñivîy_mode
 =
de°_SMI
)

664 
	`iﬂpic_mask_íåy
(
≠ic
, 
pö
);

665 
	}
}

667 
	$˛ór_IO_APIC
 ()

669 
≠ic
, 
pö
;

671 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

672 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

673 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

674 
	}
}

676 #ifde‡
CONFIG_X86_32


682 
	#MAX_PIRQS
 8

	)

683 
	gpúq_íåõs
[
MAX_PIRQS
] = {

684 [0 ... 
MAX_PIRQS
 - 1] = -1

687 
__öô
 
	$iﬂpic_púq_£tup
(*
°r
)

689 
i
, 
max
;

690 
öts
[
MAX_PIRQS
+1];

692 
	`gë_›ti⁄s
(
°r
, 
	`ARRAY_SIZE
(
öts
), ints);

694 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


696 
max
 = 
MAX_PIRQS
;

697 i‡(
öts
[0] < 
MAX_PIRQS
)

698 
max
 = 
öts
[0];

700 
i
 = 0; i < 
max
; i++) {

701 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


702 "... PIRQ%d -> IRQ %d\n", 
i
, 
öts
[i+1]);

706 
púq_íåõs
[
MAX_PIRQS
-
i
-1] = 
öts
[i+1];

709 
	}
}

711 
__£tup
("púq=", 
iﬂpic_púq_£tup
);

714 
IO_APIC_rouã_íåy
 **
	$Æloc_iﬂpic_íåõs
()

716 
≠ic
;

717 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
;

719 
iﬂpic_íåõs
 = 
	`kzÆloc
((*iﬂpic_íåõsË* 
ƒ_iﬂpics
,

720 
GFP_ATOMIC
);

721 i‡(!
iﬂpic_íåõs
)

724 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

725 
iﬂpic_íåõs
[
≠ic
] =

726 
	`kzÆloc
((
IO_APIC_rouã_íåy
) *

727 
ƒ_iﬂpic_ªgi°îs
[
≠ic
], 
GFP_ATOMIC
);

728 i‡(!
iﬂpic_íåõs
[
≠ic
])

729 
nomem
;

732  
iﬂpic_íåõs
;

734 
nomem
:

735 --
≠ic
 >= 0)

736 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

737 
	`k‰ì
(
iﬂpic_íåõs
);

740 
	}
}

745 
	$ßve_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

747 
≠ic
, 
pö
;

749 i‡(!
iﬂpic_íåõs
)

750  -
ENOMEM
;

752 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

753 i‡(!
iﬂpic_íåõs
[
≠ic
])

754  -
ENOMEM
;

756 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

757 
iﬂpic_íåõs
[
≠ic
][
pö
] =

758 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

762 
	}
}

767 
	$mask_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

769 
≠ic
, 
pö
;

771 i‡(!
iﬂpic_íåõs
)

774 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

775 i‡(!
iﬂpic_íåõs
[
≠ic
])

778 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

779 
IO_APIC_rouã_íåy
 
íåy
;

781 
íåy
 = 
iﬂpic_íåõs
[
≠ic
][
pö
];

782 i‡(!
íåy
.
mask
) {

783 
íåy
.
mask
 = 1;

784 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy
);

788 
	}
}

793 
	$ª°‹e_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

795 
≠ic
, 
pö
;

797 i‡(!
iﬂpic_íåõs
)

798  -
ENOMEM
;

800 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

801 i‡(!
iﬂpic_íåõs
[
≠ic
])

802  -
ENOMEM
;

804 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

805 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
,

806 
iﬂpic_íåõs
[
≠ic
][
pö
]);

809 
	}
}

811 
	$‰ì_iﬂpic_íåõs
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

813 
≠ic
;

815 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

816 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

818 
	`k‰ì
(
iﬂpic_íåõs
);

819 
	}
}

824 
	$föd_úq_íåy
(
≠ic
, 
pö
, 
ty≥
)

826 
i
;

828 
i
 = 0; i < 
mp_úq_íåõs
; i++)

829 i‡(
mp_úqs
[
i
].
úqty≥
 =
ty≥
 &&

830 (
mp_úqs
[
i
].
d°≠ic
 =
mp_iﬂpics
[
≠ic
].
≠icid
 ||

831 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
) &&

832 
mp_úqs
[
i
].
d°úq
 =
pö
)

833  
i
;

836 
	}
}

841 
__öô
 
	$föd_iß_úq_pö
(
úq
, 
ty≥
)

843 
i
;

845 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

846 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

848 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

849 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

850 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

852  
mp_úqs
[
i
].
d°úq
;

855 
	}
}

857 
__öô
 
	$föd_iß_úq_≠ic
(
úq
, 
ty≥
)

859 
i
;

861 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

862 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

864 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

865 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

866 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

869 i‡(
i
 < 
mp_úq_íåõs
) {

870 
≠ic
;

871 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

872 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
)

873  
≠ic
;

878 
	}
}

880 #i‡
deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

884 
	$EISA_ELCR
(
úq
)

886 i‡(
úq
 < 
NR_IRQS_LEGACY
) {

887 
p‹t
 = 0x4d0 + (
úq
 >> 3);

888  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

890 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


891 "Brokí MPèbÀÑï‹t†ISA irq %d\n", 
úq
);

893 
	}
}

900 
	#deÁu…_ISA_åiggî
(
idx
Ë(0)

	)

901 
	#deÁu…_ISA_pﬁ¨ôy
(
idx
Ë(0)

	)

908 
	#deÁu…_EISA_åiggî
(
idx
Ë(
	`EISA_ELCR
(
mp_úqs
[idx].
§cbusúq
))

	)

909 
	#deÁu…_EISA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

914 
	#deÁu…_PCI_åiggî
(
idx
Ë(1)

	)

915 
	#deÁu…_PCI_pﬁ¨ôy
(
idx
Ë(1)

	)

920 
	#deÁu…_MCA_åiggî
(
idx
Ë(1)

	)

921 
	#deÁu…_MCA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

923 
	$MPBIOS_pﬁ¨ôy
(
idx
)

925 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

926 
pﬁ¨ôy
;

931 
mp_úqs
[
idx
].
úqÊag
 & 3)

934 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

935 
pﬁ¨ôy
 = 
	`deÁu…_ISA_pﬁ¨ôy
(
idx
);

937 
pﬁ¨ôy
 = 
	`deÁu…_PCI_pﬁ¨ôy
(
idx
);

941 
pﬁ¨ôy
 = 0;

946 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

947 
pﬁ¨ôy
 = 1;

952 
pﬁ¨ôy
 = 1;

957 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

958 
pﬁ¨ôy
 = 1;

962  
pﬁ¨ôy
;

963 
	}
}

965 
	$MPBIOS_åiggî
(
idx
)

967 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

968 
åiggî
;

973 (
mp_úqs
[
idx
].
úqÊag
>>2) & 3)

976 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

977 
åiggî
 = 
	`deÁu…_ISA_åiggî
(
idx
);

979 
åiggî
 = 
	`deÁu…_PCI_åiggî
(
idx
);

980 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

981 
mp_bus_id_to_ty≥
[
bus
]) {

982 
MP_BUS_ISA
:

987 
MP_BUS_EISA
:

989 
åiggî
 = 
	`deÁu…_EISA_åiggî
(
idx
);

992 
MP_BUS_PCI
:

997 
MP_BUS_MCA
:

999 
åiggî
 = 
	`deÁu…_MCA_åiggî
(
idx
);

1004 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1005 
åiggî
 = 1;

1013 
åiggî
 = 0;

1018 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1019 
åiggî
 = 1;

1024 
åiggî
 = 1;

1029 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1030 
åiggî
 = 0;

1034  
åiggî
;

1035 
	}
}

1037 
ölöe
 
	$úq_pﬁ¨ôy
(
idx
)

1039  
	`MPBIOS_pﬁ¨ôy
(
idx
);

1040 
	}
}

1042 
ölöe
 
	$úq_åiggî
(
idx
)

1044  
	`MPBIOS_åiggî
(
idx
);

1045 
	}
}

1047 (*
iﬂpic_ªnumbî_úq
)(
iﬂpic
, 
úq
);

1048 
	$pö_2_úq
(
idx
, 
≠ic
, 
pö
)

1050 
úq
, 
i
;

1051 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

1056 i‡(
mp_úqs
[
idx
].
d°úq
 !
pö
)

1057 
	`¥ötk
(
KERN_ERR
 "broken BIOS or MPTABLEÖarser,áyiee!!\n");

1059 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1060 
úq
 = 
mp_úqs
[
idx
].
§cbusúq
;

1065 
i
 = 
úq
 = 0;

1066 
i
 < 
≠ic
)

1067 
úq
 +
ƒ_iﬂpic_ªgi°îs
[
i
++];

1068 
úq
 +
pö
;

1072 i‡(
iﬂpic_ªnumbî_úq
)

1073 
úq
 = 
	`iﬂpic_ªnumbî_úq
(
≠ic
, irq);

1076 #ifde‡
CONFIG_X86_32


1080 i‡((
pö
 >= 16) && (pin <= 23)) {

1081 i‡(
púq_íåõs
[
pö
-16] != -1) {

1082 i‡(!
púq_íåõs
[
pö
-16]) {

1083 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1084 "dißblög PIRQ%d\n", 
pö
-16);

1086 
úq
 = 
púq_íåõs
[
pö
-16];

1087 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1089 
pö
-16, 
úq
);

1095  
úq
;

1096 
	}
}

1102 
	$IO_APIC_gë_PCI_úq_ve˘‹
(
bus
, 
¶Ÿ
, 
pö
,

1103 
io_≠ic_úq_©å
 *
úq_©å
)

1105 
≠ic
, 
i
, 
be°_guess
 = -1;

1107 
	`≠ic_¥ötk
(
APIC_DEBUG
,

1109 
bus
, 
¶Ÿ
, 
pö
);

1110 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1111 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1112 "PCI BIOSÖas£dÇ⁄exi°íàPCI bu†%d!\n", 
bus
);

1115 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

1116 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

1118 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

1119 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
 ||

1120 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
)

1123 i‡(!
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

1124 !
mp_úqs
[
i
].
úqty≥
 &&

1125 (
bus
 =
lbus
) &&

1126 (
¶Ÿ
 =((
mp_úqs
[
i
].
§cbusúq
 >> 2) & 0x1f))) {

1127 
úq
 = 
	`pö_2_úq
(
i
, 
≠ic
, 
mp_úqs
[i].
d°úq
);

1129 i‡(!(
≠ic
 || 
	`IO_APIC_IRQ
(
úq
)))

1132 i‡(
pö
 =(
mp_úqs
[
i
].
§cbusúq
 & 3)) {

1133 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1134 
mp_úqs
[
i
].
d°úq
,

1135 
	`úq_åiggî
(
i
),

1136 
	`úq_pﬁ¨ôy
(
i
));

1137  
úq
;

1143 i‡(
be°_guess
 < 0) {

1144 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1145 
mp_úqs
[
i
].
d°úq
,

1146 
	`úq_åiggî
(
i
),

1147 
	`úq_pﬁ¨ôy
(
i
));

1148 
be°_guess
 = 
úq
;

1152  
be°_guess
;

1153 
	}
}

1154 
EXPORT_SYMBOL
(
IO_APIC_gë_PCI_úq_ve˘‹
);

1156 
	$lock_ve˘‹_lock
()

1161 
	`•ö_lock
(&
ve˘‹_lock
);

1162 
	}
}

1164 
	$u∆ock_ve˘‹_lock
()

1166 
	`•ö_u∆ock
(&
ve˘‹_lock
);

1167 
	}
}

1170 
	$__assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1183 
cuºít_ve˘‹
 = 
FIRST_DEVICE_VECTOR
, 
cuºít_off£t
 = 0;

1184 
ﬁd_ve˘‹
;

1185 
˝u
, 
îr
;

1186 
˝umask_v¨_t
 
tmp_mask
;

1188 i‡((
cfg
->
move_ö_¥ogªss
Ë|| cfg->
move_˛ónup_cou¡
)

1189  -
EBUSY
;

1191 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_mask
, 
GFP_ATOMIC
))

1192  -
ENOMEM
;

1194 
ﬁd_ve˘‹
 = 
cfg
->
ve˘‹
;

1195 i‡(
ﬁd_ve˘‹
) {

1196 
	`˝umask_™d
(
tmp_mask
, 
mask
, 
˝u_⁄löe_mask
);

1197 
	`˝umask_™d
(
tmp_mask
, 
cfg
->
domaö
,Åmp_mask);

1198 i‡(!
	`˝umask_em±y
(
tmp_mask
)) {

1199 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1205 
îr
 = -
ENOSPC
;

1206 
	`f‹_óch_˝u_™d
(
˝u
, 
mask
, 
˝u_⁄löe_mask
) {

1207 
√w_˝u
;

1208 
ve˘‹
, 
off£t
;

1210 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
tmp_mask
);

1212 
ve˘‹
 = 
cuºít_ve˘‹
;

1213 
off£t
 = 
cuºít_off£t
;

1214 
√xt
:

1215 
ve˘‹
 += 8;

1216 i‡(
ve˘‹
 >
fú°_sy°em_ve˘‹
) {

1218 
off£t
 = (offset + 1) % 8;

1219 
ve˘‹
 = 
FIRST_DEVICE_VECTOR
 + 
off£t
;

1221 i‡(
	`u∆ikñy
(
cuºít_ve˘‹
 =
ve˘‹
))

1224 i‡(
	`ã°_bô
(
ve˘‹
, 
u£d_ve˘‹s
))

1225 
√xt
;

1227 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1228 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] != -1)

1229 
√xt
;

1231 
cuºít_ve˘‹
 = 
ve˘‹
;

1232 
cuºít_off£t
 = 
off£t
;

1233 i‡(
ﬁd_ve˘‹
) {

1234 
cfg
->
move_ö_¥ogªss
 = 1;

1235 
	`˝umask_c›y
(
cfg
->
ﬁd_domaö
, cfg->
domaö
);

1237 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1238 
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] = 
úq
;

1239 
cfg
->
ve˘‹
 = vector;

1240 
	`˝umask_c›y
(
cfg
->
domaö
, 
tmp_mask
);

1241 
îr
 = 0;

1244 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1245  
îr
;

1246 
	}
}

1249 
	$assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1251 
îr
;

1252 
Êags
;

1254 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

1255 
îr
 = 
	`__assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
);

1256 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

1257  
îr
;

1258 
	}
}

1260 
	$__˛ór_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
)

1262 
˝u
, 
ve˘‹
;

1264 
	`BUG_ON
(!
cfg
->
ve˘‹
);

1266 
ve˘‹
 = 
cfg
->vector;

1267 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
domaö
, 
˝u_⁄löe_mask
)

1268 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1270 
cfg
->
ve˘‹
 = 0;

1271 
	`˝umask_˛ór
(
cfg
->
domaö
);

1273 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

1275 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
) {

1276 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
;

1277 
ve˘‹
++) {

1278 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] !
úq
)

1280 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1284 
cfg
->
move_ö_¥ogªss
 = 0;

1285 
	}
}

1287 
	$__£tup_ve˘‹_úq
(
˝u
)

1291 
úq
, 
ve˘‹
;

1292 
úq_cfg
 *
cfg
;

1293 
úq_desc
 *
desc
;

1296 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1297 
cfg
 = 
desc
->
chù_d©a
;

1298 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1300 
ve˘‹
 = 
cfg
->vector;

1301 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = 
úq
;

1304 
ve˘‹
 = 0; ve˘‹ < 
NR_VECTORS
; ++vector) {

1305 
úq
 = 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
];

1306 i‡(
úq
 < 0)

1309 
cfg
 = 
	`úq_cfg
(
úq
);

1310 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1311 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1313 
	}
}

1315 
úq_chù
 
	giﬂpic_chù
;

1316 
úq_chù
 
	gú_iﬂpic_chù
;

1318 
	#IOAPIC_AUTO
 -1

	)

1319 
	#IOAPIC_EDGE
 0

	)

1320 
	#IOAPIC_LEVEL
 1

	)

1322 #ifde‡
CONFIG_X86_32


1323 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1325 
≠ic
, 
idx
, 
pö
;

1327 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1328 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1329 
idx
 = 
	`föd_úq_íåy
(
≠ic
, 
pö
, 
mp_INT
);

1330 i‡((
idx
 !-1Ë&& (
úq
 =
	`pö_2_úq
(idx, 
≠ic
, 
pö
)))

1331  
	`úq_åiggî
(
idx
);

1338 
	}
}

1340 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1343 
	}
}

1346 
	$iﬂpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
, 
åiggî
)

1349 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1350 
åiggî
 =
IOAPIC_LEVEL
)

1351 
desc
->
°©us
 |
IRQ_LEVEL
;

1353 
desc
->
°©us
 &~
IRQ_LEVEL
;

1355 i‡(
	`úq_ªm≠≥d
(
úq
)) {

1356 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

1357 i‡(
åiggî
)

1358 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1359 
h™dÀ_Á°eoi_úq
,

1362 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1363 
h™dÀ_edge_úq
, "edge");

1367 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1368 
åiggî
 =
IOAPIC_LEVEL
)

1369 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1370 
h™dÀ_Á°eoi_úq
,

1373 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1374 
h™dÀ_edge_úq
, "edge");

1375 
	}
}

1377 
	$£tup_iﬂpic_íåy
(
≠ic_id
, 
úq
,

1378 
IO_APIC_rouã_íåy
 *
íåy
,

1379 
de°ö©i⁄
, 
åiggî
,

1380 
pﬁ¨ôy
, 
ve˘‹
, 
pö
)

1385 
	`mem£t
(
íåy
,0,(*entry));

1387 i‡(
öå_ªm≠pög_íabÀd
) {

1388 
öãl_iommu
 *
iommu
 = 
	`m≠_iﬂpic_to_ú
(
≠ic_id
);

1389 
úã
 irte;

1390 
IR_IO_APIC_rouã_íåy
 *
ú_íåy
 =

1391 (
IR_IO_APIC_rouã_íåy
 *Ë
íåy
;

1392 
ödex
;

1394 i‡(!
iommu
)

1395 
	`∑nic
("Nÿm≠pög iommu f‹ iﬂpi¯%d\n", 
≠ic_id
);

1397 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

1398 i‡(
ödex
 < 0)

1399 
	`∑nic
("FaûedÅÿÆloˇã IRTE f‹ iﬂpi¯%d\n", 
≠ic_id
);

1401 
	`mem£t
(&
úã
, 0, (irte));

1403 
úã
.
¥e£¡
 = 1;

1404 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

1412 
úã
.
åiggî_mode
 = 0;

1413 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1414 
úã
.
ve˘‹
 = vector;

1415 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°ö©i⁄
);

1418 
	`£t_iﬂpic_sid
(&
úã
, 
≠ic_id
);

1420 
	`modify_úã
(
úq
, &
úã
);

1422 
ú_íåy
->
ödex2
 = (
ödex
 >> 15) & 0x1;

1423 
ú_íåy
->
zîo
 = 0;

1424 
ú_íåy
->
f‹m©
 = 1;

1425 
ú_íåy
->
ödex
 = (index & 0x7fff);

1430 
ú_íåy
->
ve˘‹
 = 
pö
;

1432 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1433 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1434 
íåy
->
de°
 = 
de°ö©i⁄
;

1435 
íåy
->
ve˘‹
 = vector;

1438 
íåy
->
mask
 = 0;

1439 
íåy
->
åiggî
 =Årigger;

1440 
íåy
->
pﬁ¨ôy
 =Öolarity;

1445 i‡(
åiggî
)

1446 
íåy
->
mask
 = 1;

1448 
	}
}

1450 
	$£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
úq_desc
 *
desc
,

1451 
åiggî
, 
pﬁ¨ôy
)

1453 
úq_cfg
 *
cfg
;

1454 
IO_APIC_rouã_íåy
 
íåy
;

1455 
de°
;

1457 i‡(!
	`IO_APIC_IRQ
(
úq
))

1460 
cfg
 = 
desc
->
chù_d©a
;

1462 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
()))

1465 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

1467 
	`≠ic_¥ötk
(
APIC_VERBOSE
,
KERN_DEBUG


1470 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
, 
pö
, 
cfg
->
ve˘‹
,

1471 
úq
, 
åiggî
, 
pﬁ¨ôy
);

1474 i‡(
	`£tup_iﬂpic_íåy
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
úq
, &
íåy
,

1475 
de°
, 
åiggî
, 
pﬁ¨ôy
, 
cfg
->
ve˘‹
, 
pö
)) {

1476 
	`¥ötk
("FailedÅo setup ioapicÉntry for ioapic %d,Öin %d\n",

1477 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1478 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

1482 
	`iﬂpic_ªgi°î_öå
(
úq
, 
desc
, 
åiggî
);

1483 i‡(
úq
 < 
NR_IRQS_LEGACY
)

1484 
	`dißbÀ_8259A_úq
(
úq
);

1486 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1487 
	}
}

1490 
DECLARE_BITMAP
(
pö_¥ogømmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

1491 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

1493 
__öô
 
	$£tup_IO_APIC_úqs
()

1495 
≠ic_id
 = 0, 
pö
, 
idx
, 
úq
;

1496 
nŸc⁄
 = 0;

1497 
úq_desc
 *
desc
;

1498 
úq_cfg
 *
cfg
;

1499 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1501 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1503 #ifde‡
CONFIG_ACPI


1504 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

1505 
≠ic_id
 = 
	`mp_föd_iﬂpic
(0);

1506 i‡(
≠ic_id
 < 0)

1507 
≠ic_id
 = 0;

1511 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic_id
];Öin++) {

1512 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1513 i‡(
idx
 == -1) {

1514 i‡(!
nŸc⁄
) {

1515 
nŸc⁄
 = 1;

1516 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1517 
KERN_DEBUG
 " %d-%d",

1518 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1520 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " %d-%d",

1521 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1524 i‡(
nŸc⁄
) {

1525 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1527 
nŸc⁄
 = 0;

1530 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1536 i‡(
≠ic
->
mu…i_timî_check
 &&

1537 
≠ic
->
	`mu…i_timî_check
(
≠ic_id
, 
úq
))

1540 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1541 i‡(!
desc
) {

1542 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1545 
cfg
 = 
desc
->
chù_d©a
;

1546 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1551 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1552 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1555 i‡(
nŸc⁄
)

1556 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1558 
	}
}

1563 
__öô
 
	$£tup_timî_IRQ0_pö
(
≠ic_id
, 
pö
,

1564 
ve˘‹
)

1566 
IO_APIC_rouã_íåy
 
íåy
;

1568 i‡(
öå_ªm≠pög_íabÀd
)

1571 
	`mem£t
(&
íåy
, 0, (entry));

1577 
íåy
.
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1578 
íåy
.
mask
 = 0;

1579 
íåy
.
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
◊pic->
	`èrgë_˝us
());

1580 
íåy
.
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1581 
íåy
.
pﬁ¨ôy
 = 0;

1582 
íåy
.
åiggî
 = 0;

1583 
íåy
.
ve˘‹
 = vector;

1589 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

1594 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1595 
	}
}

1598 
	$__≠icdebugöô
(Ë
	$¥öt_IO_APIC
()

1600 
≠ic
, 
i
;

1601 
IO_APIC_ªg_00
 
ªg_00
;

1602 
IO_APIC_ªg_01
 
ªg_01
;

1603 
IO_APIC_ªg_02
 
ªg_02
;

1604 
IO_APIC_ªg_03
 
ªg_03
;

1605 
Êags
;

1606 
úq_cfg
 *
cfg
;

1607 
úq_desc
 *
desc
;

1608 
úq
;

1610 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1613 
	`¥ötk
(
KERN_DEBUG
 "numbî o‡MP IRQ sour˚s: %d.\n", 
mp_úq_íåõs
);

1614 
i
 = 0; i < 
ƒ_iﬂpics
; i++)

1615 
	`¥ötk
(
KERN_DEBUG
 "number of IO-APIC #%dÑegisters: %d.\n",

1616 
mp_iﬂpics
[
i
].
≠icid
, 
ƒ_iﬂpic_ªgi°îs
[i]);

1622 
	`¥ötk
(
KERN_INFO
 "testingÅhe IO APIC.......................\n");

1624 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1626 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1627 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 0);

1628 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1629 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x10)

1630 
ªg_02
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 2);

1631 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x20)

1632 
ªg_03
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 3);

1633 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1635 
	`¥ötk
("\n");

1636 
	`¥ötk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_iﬂpics
[
≠ic
].
≠icid
);

1637 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #00: %08X\n", 
ªg_00
.
øw
);

1638 
	`¥ötk
(
KERN_DEBUG
 "....... :Öhysiˇ»APIC id: %02X\n", 
ªg_00
.
bôs
.
ID
);

1639 
	`¥ötk
(
KERN_DEBUG
 "....... : Dñivîy Ty≥: %X\n", 
ªg_00
.
bôs
.
dñivîy_ty≥
);

1640 
	`¥ötk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
ªg_00
.
bôs
.
LTS
);

1642 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #01: %08X\n", *(*)&
ªg_01
);

1643 
	`¥ötk
(
KERN_DEBUG
 "....... : maxÑedúe˘i⁄É¡rõs: %04X\n", 
ªg_01
.
bôs
.
íåõs
);

1645 
	`¥ötk
(
KERN_DEBUG
 "....... : PRQ im∂emíãd: %X\n", 
ªg_01
.
bôs
.
PRQ
);

1646 
	`¥ötk
(
KERN_DEBUG
 "....... : IO APIC vîsi⁄: %04X\n", 
ªg_01
.
bôs
.
vîsi⁄
);

1653 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x10 && 
ªg_02
.
øw
 !=Ñeg_01.raw) {

1654 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #02: %08X\n", 
ªg_02
.
øw
);

1655 
	`¥ötk
(
KERN_DEBUG
 "....... :árbôøti⁄: %02X\n", 
ªg_02
.
bôs
.
¨bôøti⁄
);

1663 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x20 && 
ªg_03
.
øw
 !
ªg_02
.raw &&

1664 
ªg_03
.
øw
 !
ªg_01
.raw) {

1665 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #03: %08X\n", 
ªg_03
.
øw
);

1666 
	`¥ötk
(
KERN_DEBUG
 "....... : BoŸ DT : %X\n", 
ªg_03
.
bôs
.
boŸ_DT
);

1669 
	`¥ötk
(
KERN_DEBUG
 ".... IRQÑedirectionÅable:\n");

1671 
	`¥ötk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1674 
i
 = 0; i <
ªg_01
.
bôs
.
íåõs
; i++) {

1675 
IO_APIC_rouã_íåy
 
íåy
;

1677 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
i
);

1679 
	`¥ötk
(
KERN_DEBUG
 " %02x %03X ",

1680 
i
,

1681 
íåy
.
de°


1684 
	`¥ötk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1685 
íåy
.
mask
,

1686 
íåy
.
åiggî
,

1687 
íåy
.
úr
,

1688 
íåy
.
pﬁ¨ôy
,

1689 
íåy
.
dñivîy_°©us
,

1690 
íåy
.
de°_mode
,

1691 
íåy
.
dñivîy_mode
,

1692 
íåy
.
ve˘‹


1696 
	`¥ötk
(
KERN_DEBUG
 "IRQÅoÖin mappings:\n");

1697 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1698 
úq_pö_li°
 *
íåy
;

1700 
cfg
 = 
desc
->
chù_d©a
;

1701 
íåy
 = 
cfg
->
úq_2_pö
;

1702 i‡(!
íåy
)

1704 
	`¥ötk
(
KERN_DEBUG
 "IRQ%d ", 
úq
);

1706 
	`¥ötk
("-> %d:%d", 
íåy
->
≠ic
,É¡ry->
pö
);

1707 i‡(!
íåy
->
√xt
)

1709 
íåy
 =É¡ry->
√xt
;

1711 
	`¥ötk
("\n");

1714 
	`¥ötk
(
KERN_INFO
 ".................................... done.\n");

1717 
	}
}

1719 
	$__≠icdebugöô
(Ë
	$¥öt_APIC_fõld
(
ba£
)

1721 
i
;

1723 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1726 
	`¥ötk
(
KERN_DEBUG
);

1728 
i
 = 0; i < 8; i++)

1729 
	`¥ötk
(
KERN_CONT
 "%08x", 
	`≠ic_ªad
(
ba£
 + 
i
*0x10));

1731 
	`¥ötk
(
KERN_CONT
 "\n");

1732 
	}
}

1734 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APIC
(*
dummy
)

1736 
i
, 
v
, 
vî
, 
maxlvt
;

1737 
u64
 
i¸
;

1739 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1742 
	`¥ötk
(
KERN_DEBUG
 "printingÜocal APIC contents on CPU#%d/%d:\n",

1743 
	`smp_¥o˚ss‹_id
(), 
	`h¨d_smp_¥o˚ss‹_id
());

1744 
v
 = 
	`≠ic_ªad
(
APIC_ID
);

1745 
	`¥ötk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`ªad_≠ic_id
());

1746 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

1747 
	`¥ötk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1748 
vî
 = 
	`GET_APIC_VERSION
(
v
);

1749 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1751 
v
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1752 
	`¥ötk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1754 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1755 i‡(!
	`APIC_XAPIC
(
vî
)) {

1756 
v
 = 
	`≠ic_ªad
(
APIC_ARBPRI
);

1757 
	`¥ötk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1758 
v
 & 
APIC_ARBPRI_MASK
);

1760 
v
 = 
	`≠ic_ªad
(
APIC_PROCPRI
);

1761 
	`¥ötk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1768 i‡(!
	`APIC_INTEGRATED
(
vî
Ë|| 
maxlvt
 == 3) {

1769 
v
 = 
	`≠ic_ªad
(
APIC_RRR
);

1770 
	`¥ötk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1773 
v
 = 
	`≠ic_ªad
(
APIC_LDR
);

1774 
	`¥ötk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1775 i‡(!
	`x2≠ic_íabÀd
()) {

1776 
v
 = 
	`≠ic_ªad
(
APIC_DFR
);

1777 
	`¥ötk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1779 
v
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1780 
	`¥ötk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1782 
	`¥ötk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1783 
	`¥öt_APIC_fõld
(
APIC_ISR
);

1784 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1785 
	`¥öt_APIC_fõld
(
APIC_TMR
);

1786 
	`¥ötk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1787 
	`¥öt_APIC_fõld
(
APIC_IRR
);

1789 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1790 i‡(
maxlvt
 > 3)

1791 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1793 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1794 
	`¥ötk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1797 
i¸
 = 
	`≠ic_i¸_ªad
();

1798 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
i¸
);

1799 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
i¸
 >> 32));

1801 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1802 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1804 i‡(
maxlvt
 > 3) {

1805 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1806 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1808 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1809 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1810 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1811 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1813 i‡(
maxlvt
 > 2) {

1814 
v
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1815 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1818 
v
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1819 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1820 
v
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

1821 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1822 
v
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1823 
	`¥ötk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1825 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_EXTAPIC
)) {

1826 
v
 = 
	`≠ic_ªad
(
APIC_EFEAT
);

1827 
maxlvt
 = (
v
 >> 16) & 0xff;

1828 
	`¥ötk
(
KERN_DEBUG
 "... APIC EFEAT: %08x\n", 
v
);

1829 
v
 = 
	`≠ic_ªad
(
APIC_ECTRL
);

1830 
	`¥ötk
(
KERN_DEBUG
 "... APIC ECTRL: %08x\n", 
v
);

1831 
i
 = 0; i < 
maxlvt
; i++) {

1832 
v
 = 
	`≠ic_ªad
(
	`APIC_EILVTn
(
i
));

1833 
	`¥ötk
(
KERN_DEBUG
 "... APIC EILVT%d: %08x\n", 
i
, 
v
);

1836 
	`¥ötk
("\n");

1837 
	}
}

1839 
	$__≠icdebugöô
(Ë
	$¥öt_Æl_loˇl_APICs
()

1841 
˝u
;

1843 
	`¥ìm±_dißbÀ
();

1844 
	`f‹_óch_⁄löe_˝u
(
˝u
)

1845 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
¥öt_loˇl_APIC
, 
NULL
, 1);

1846 
	`¥ìm±_íabÀ
();

1847 
	}
}

1849 
	$__≠icdebugöô
(Ë
	$¥öt_PIC
()

1851 
v
;

1852 
Êags
;

1854 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1857 
	`¥ötk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1859 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

1861 
v
 = 
	`öb
(0xa1) << 8 | inb(0x21);

1862 
	`¥ötk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1864 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1865 
	`¥ötk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1867 
	`outb
(0x0b,0xa0);

1868 
	`outb
(0x0b,0x20);

1869 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1870 
	`outb
(0x0a,0xa0);

1871 
	`outb
(0x0a,0x20);

1873 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

1875 
	`¥ötk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1877 
v
 = 
	`öb
(0x4d1) << 8 | inb(0x4d0);

1878 
	`¥ötk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1879 
	}
}

1881 
	$__≠icdebugöô
(Ë
	$¥öt_Æl_ICs
()

1883 
	`¥öt_PIC
();

1886 i‡(!
˝u_has_≠ic
 || 
dißbÀ_≠ic
)

1889 
	`¥öt_Æl_loˇl_APICs
();

1890 
	`¥öt_IO_APIC
();

1893 
	}
}

1895 
fs_öôˇŒ
(
¥öt_Æl_ICs
);

1899 °ru˘ { 
	mpö
, 
	m≠ic
; } 
	giﬂpic_i8259
 = { -1, -1 };

1901 
__öô
 
	$íabÀ_IO_APIC
()

1903 
IO_APIC_ªg_01
 
ªg_01
;

1904 
i8259_≠ic
, 
i8259_pö
;

1905 
≠ic
;

1906 
Êags
;

1911 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1912 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1913 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1914 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1915 
ƒ_iﬂpic_ªgi°îs
[
≠ic
] = 
ªg_01
.
bôs
.
íåõs
+1;

1917 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1918 
pö
;

1920 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1921 
IO_APIC_rouã_íåy
 
íåy
;

1922 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

1927 i‡((
íåy
.
mask
 =0Ë&& (íåy.
dñivîy_mode
 =
de°_ExtINT
)) {

1928 
iﬂpic_i8259
.
≠ic
 =ápic;

1929 
iﬂpic_i8259
.
pö
 =Öin;

1930 
found_i8259
;

1934 
found_i8259
:

1940 
i8259_pö
 = 
	`föd_iß_úq_pö
(0, 
mp_ExtINT
);

1941 
i8259_≠ic
 = 
	`föd_iß_úq_≠ic
(0, 
mp_ExtINT
);

1943 i‡((
iﬂpic_i8259
.
pö
 =-1Ë&& (
i8259_pö
 >= 0)) {

1944 
	`¥ötk
(
KERN_WARNING
 "ExtINTÇot setup in hardware butÑeported by MPÅable\n");

1945 
iﬂpic_i8259
.
pö
 = 
i8259_pö
;

1946 
iﬂpic_i8259
.
≠ic
 = 
i8259_≠ic
;

1949 i‡(((
iﬂpic_i8259
.
≠ic
 !
i8259_≠ic
Ë|| (iﬂpic_i8259.
pö
 !
i8259_pö
)) &&

1950 (
i8259_pö
 >0Ë&& (
iﬂpic_i8259
.
pö
 >= 0))

1952 
	`¥ötk
(
KERN_WARNING
 "ExtINT in hardwareánd MPÅable differ\n");

1958 
	`˛ór_IO_APIC
();

1959 
	}
}

1964 
	$dißbÀ_IO_APIC
()

1969 
	`˛ór_IO_APIC
();

1981 i‡(
iﬂpic_i8259
.
pö
 !-1 && !
öå_ªm≠pög_íabÀd
) {

1982 
IO_APIC_rouã_íåy
 
íåy
;

1984 
	`mem£t
(&
íåy
, 0, (entry));

1985 
íåy
.
mask
 = 0;

1986 
íåy
.
åiggî
 = 0;

1987 
íåy
.
úr
 = 0;

1988 
íåy
.
pﬁ¨ôy
 = 0;

1989 
íåy
.
dñivîy_°©us
 = 0;

1990 
íåy
.
de°_mode
 = 0;

1991 
íåy
.
dñivîy_mode
 = 
de°_ExtINT
;

1992 
íåy
.
ve˘‹
 = 0;

1993 
íåy
.
de°
 = 
	`ªad_≠ic_id
();

1998 
	`iﬂpic_wrôe_íåy
(
iﬂpic_i8259
.
≠ic
, iﬂpic_i8259.
pö
, 
íåy
);

2004 i‡(
˝u_has_≠ic
)

2005 
	`disc⁄√˘_b•_APIC
(!
öå_ªm≠pög_íabÀd
 &&

2006 
iﬂpic_i8259
.
pö
 != -1);

2007 
	}
}

2009 #ifde‡
CONFIG_X86_32


2017 
__öô
 
	$£tup_iﬂpic_ids_‰om_mpc
()

2019 
IO_APIC_ªg_00
 
ªg_00
;

2020 
physid_mask_t
 
phys_id_¥e£¡_m≠
;

2021 
≠ic_id
;

2022 
i
;

2023 
ﬁd_id
;

2024 
Êags
;

2026 i‡(
x86_quúks
->
£tup_iﬂpic_ids
 && x86_quúks->
	`£tup_iﬂpic_ids
())

2033 i‡(!(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
)

2034 || 
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

2040 
phys_id_¥e£¡_m≠
 = 
≠ic
->
	`iﬂpic_phys_id_m≠
(
phys_˝u_¥e£¡_m≠
);

2045 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++) {

2048 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2049 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2050 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2052 
ﬁd_id
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2054 i‡(
mp_iﬂpics
[
≠ic_id
].
≠icid
 >
	`gë_physiˇl_brﬂdˇ°
()) {

2055 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inÅhe MPCÅable!...\n",

2056 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2057 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2058 
ªg_00
.
bôs
.
ID
);

2059 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
ªg_00
.
bôs
.
ID
;

2067 i‡(
≠ic
->
	`check_≠icid_u£d
(
phys_id_¥e£¡_m≠
,

2068 
mp_iﬂpics
[
≠ic_id
].
≠icid
)) {

2069 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d isálready used!...\n",

2070 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2071 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++)

2072 i‡(!
	`physid_is£t
(
i
, 
phys_id_¥e£¡_m≠
))

2074 i‡(
i
 >
	`gë_physiˇl_brﬂdˇ°
())

2075 
	`∑nic
("Max APIC IDÉxceeded!\n");

2076 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2077 
i
);

2078 
	`physid_£t
(
i
, 
phys_id_¥e£¡_m≠
);

2079 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
i
;

2081 
physid_mask_t
 
tmp
;

2082 
tmp
 = 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2083 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Setting %d inÅhe "

2085 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2086 
	`physids_‹
(
phys_id_¥e£¡_m≠
,Öhys_id_¥e£¡_m≠, 
tmp
);

2094 i‡(
ﬁd_id
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2095 
i
 = 0; i < 
mp_úq_íåõs
; i++)

2096 i‡(
mp_úqs
[
i
].
d°≠ic
 =
ﬁd_id
)

2097 
mp_úqs
[
i
].
d°≠ic


2098 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2104 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


2106 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2108 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2109 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2110 
	`io_≠ic_wrôe
(
≠ic_id
, 0, 
ªg_00
.
øw
);

2111 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2116 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2117 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2118 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2119 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2120 
	`¥ötk
("couldÇot set ID!\n");

2122 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " ok.\n");

2124 
	}
}

2127 
no_timî_check
 
	g__öôd©a
;

2129 
__öô
 
	$nŸimîcheck
(*
s
)

2131 
no_timî_check
 = 1;

2133 
	}
}

2134 
__£tup
("no_timî_check", 
nŸimîcheck
);

2144 
__öô
 
	$timî_úq_w‹ks
()

2146 
t1
 = 
jiffõs
;

2147 
Êags
;

2149 i‡(
no_timî_check
)

2152 
	`loˇl_ßve_Êags
(
Êags
);

2153 
	`loˇl_úq_íabÀ
();

2155 
	`mdñay
((10 * 1000Ë/ 
HZ
);

2156 
	`loˇl_úq_ª°‹e
(
Êags
);

2167 i‡(
	`time_a·î
(
jiffõs
, 
t1
 + 4))

2170 
	}
}

2195 
	$°¨tup_iﬂpic_úq
(
úq
)

2197 
was_≥ndög
 = 0;

2198 
Êags
;

2199 
úq_cfg
 *
cfg
;

2201 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2202 i‡(
úq
 < 
NR_IRQS_LEGACY
) {

2203 
	`dißbÀ_8259A_úq
(
úq
);

2204 i‡(
	`i8259A_úq_≥ndög
(
úq
))

2205 
was_≥ndög
 = 1;

2207 
cfg
 = 
	`úq_cfg
(
úq
);

2208 
	`__unmask_IO_APIC_úq
(
cfg
);

2209 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2211  
was_≥ndög
;

2212 
	}
}

2214 #ifde‡
CONFIG_X86_64


2215 
	$iﬂpic_ªåiggî_úq
(
úq
)

2218 
úq_cfg
 *
cfg
 = 
	`úq_cfg
(
úq
);

2219 
Êags
;

2221 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

2222 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
	`˝umask_fú°
(
cfg
->
domaö
)), cfg->
ve˘‹
);

2223 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

2226 
	}
}

2228 
	$iﬂpic_ªåiggî_úq
(
úq
)

2230 
≠ic
->
	`£nd_IPI_£lf
(
	`úq_cfg
(
úq
)->
ve˘‹
);

2233 
	}
}

2245 #ifde‡
CONFIG_SMP


2246 
	$£nd_˛ónup_ve˘‹
(
úq_cfg
 *
cfg
)

2248 
˝umask_v¨_t
 
˛ónup_mask
;

2250 i‡(
	`u∆ikñy
(!
	`Æloc_˝umask_v¨
(&
˛ónup_mask
, 
GFP_ATOMIC
))) {

2251 
i
;

2252 
cfg
->
move_˛ónup_cou¡
 = 0;

2253 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2254 
cfg
->
move_˛ónup_cou¡
++;

2255 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2256 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

2258 
	`˝umask_™d
(
˛ónup_mask
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
);

2259 
cfg
->
move_˛ónup_cou¡
 = 
	`˝umask_weight
(
˛ónup_mask
);

2260 
≠ic
->
	`£nd_IPI_mask
(
˛ónup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

2261 
	`‰ì_˝umask_v¨
(
˛ónup_mask
);

2263 
cfg
->
move_ö_¥ogªss
 = 0;

2264 
	}
}

2266 
	$__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
úq_cfg
 *
cfg
)

2268 
≠ic
, 
pö
;

2269 
úq_pö_li°
 *
íåy
;

2270 
u8
 
ve˘‹
 = 
cfg
->vector;

2272 
íåy
 = 
cfg
->
úq_2_pö
;

2274 
ªg
;

2276 i‡(!
íåy
)

2279 
≠ic
 = 
íåy
->apic;

2280 
pö
 = 
íåy
->pin;

2285 i‡(!
	`úq_ªm≠≥d
(
úq
))

2286 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 
pö
*2, 
de°
);

2287 
ªg
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 
pö
*2);

2288 
ªg
 &~
IO_APIC_REDIR_VECTOR_MASK
;

2289 
ªg
 |
ve˘‹
;

2290 
	`io_≠ic_modify
(
≠ic
, 0x10 + 
pö
*2, 
ªg
);

2291 i‡(!
íåy
->
√xt
)

2293 
íåy
 =É¡ry->
√xt
;

2295 
	}
}

2298 
assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
);

2306 
	$£t_desc_afföôy
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2308 
úq_cfg
 *
cfg
;

2309 
úq
;

2311 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2312  
BAD_APICID
;

2314 
úq
 = 
desc
->irq;

2315 
cfg
 = 
desc
->
chù_d©a
;

2316 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2317  
BAD_APICID
;

2319 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2321  
≠ic
->
	`˝u_mask_to_≠icid_™d
(
desc
->
afföôy
, 
cfg
->
domaö
);

2322 
	}
}

2325 
	$£t_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2327 
úq_cfg
 *
cfg
;

2328 
Êags
;

2329 
de°
;

2330 
úq
;

2331 
ªt
 = -1;

2333 
úq
 = 
desc
->irq;

2334 
cfg
 = 
desc
->
chù_d©a
;

2336 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2337 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

2338 i‡(
de°
 !
BAD_APICID
) {

2340 
de°
 = 
	`SET_APIC_LOGICAL_ID
(dest);

2341 
	`__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
cfg
);

2342 
ªt
 = 0;

2344 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2346  
ªt
;

2347 
	}
}

2350 
	$£t_iﬂpic_afföôy_úq
(
úq
, c⁄° 
˝umask
 *
mask
)

2352 
úq_desc
 *
desc
;

2354 
desc
 = 
	`úq_to_desc
(
úq
);

2356  
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2357 
	}
}

2359 #ifde‡
CONFIG_INTR_REMAP


2373 
	$migøã_iﬂpic_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2375 
úq_cfg
 *
cfg
;

2376 
úã
 irte;

2377 
de°
;

2378 
úq
;

2379 
ªt
 = -1;

2381 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2382  
ªt
;

2384 
úq
 = 
desc
->irq;

2385 i‡(
	`gë_úã
(
úq
, &
úã
))

2386  
ªt
;

2388 
cfg
 = 
desc
->
chù_d©a
;

2389 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2390  
ªt
;

2392 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
, 
mask
);

2394 
úã
.
ve˘‹
 = 
cfg
->vector;

2395 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

2400 
	`modify_úã
(
úq
, &
úã
);

2402 i‡(
cfg
->
move_ö_¥ogªss
)

2403 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2405 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2408 
	}
}

2413 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2414 c⁄° 
˝umask
 *
mask
)

2416  
	`migøã_iﬂpic_úq_desc
(
desc
, 
mask
);

2417 
	}
}

2418 
	$£t_ú_iﬂpic_afföôy_úq
(
úq
,

2419 c⁄° 
˝umask
 *
mask
)

2421 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2423  
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2424 
	}
}

2426 
ölöe
 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2427 c⁄° 
˝umask
 *
mask
)

2430 
	}
}

2433 
asmlökage
 
	$smp_úq_move_˛ónup_öãºu±
()

2435 
ve˘‹
, 
me
;

2437 
	`ack_APIC_úq
();

2438 
	`exô_idÀ
();

2439 
	`úq_íãr
();

2441 
me
 = 
	`smp_¥o˚ss‹_id
();

2442 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

2443 
úq
;

2444 
úr
;

2445 
úq_desc
 *
desc
;

2446 
úq_cfg
 *
cfg
;

2447 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

2449 i‡(
úq
 == -1)

2452 
desc
 = 
	`úq_to_desc
(
úq
);

2453 i‡(!
desc
)

2456 
cfg
 = 
	`úq_cfg
(
úq
);

2457 
	`•ö_lock
(&
desc
->
lock
);

2458 i‡(!
cfg
->
move_˛ónup_cou¡
)

2459 
u∆ock
;

2461 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2462 
u∆ock
;

2464 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

2472 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

2473 
≠ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2474 
u∆ock
;

2476 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] = -1;

2477 
cfg
->
move_˛ónup_cou¡
--;

2478 
u∆ock
:

2479 
	`•ö_u∆ock
(&
desc
->
lock
);

2482 
	`úq_exô
();

2483 
	}
}

2485 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
)

2487 
úq_desc
 *
desc
 = *
des˝
;

2488 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2489 
ve˘‹
, 
me
;

2491 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

2494 
ve˘‹
 = ~
	`gë_úq_ªgs
()->
‹ig_ax
;

2495 
me
 = 
	`smp_¥o˚ss‹_id
();

2497 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2498 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2499 
	}
}

2501 
ölöe
 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
Ë{
	}
}

2504 
	$ack_≠ic_edge
(
úq
)

2506 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2508 
	`úq_com∂ëe_move
(&
desc
);

2509 
	`move_«tive_úq
(
úq
);

2510 
	`ack_APIC_úq
();

2511 
	}
}

2513 
©omic_t
 
	gúq_mis_cou¡
;

2515 
	$ack_≠ic_Àvñ
(
úq
)

2517 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2519 #ifde‡
CONFIG_X86_32


2520 
v
;

2521 
i
;

2523 
úq_cfg
 *
cfg
;

2524 
do_unmask_úq
 = 0;

2526 
	`úq_com∂ëe_move
(&
desc
);

2527 #ifde‡
CONFIG_GENERIC_PENDING_IRQ


2529 i‡(
	`u∆ikñy
(
desc
->
°©us
 & 
IRQ_MOVE_PENDING
)) {

2530 
do_unmask_úq
 = 1;

2531 
	`mask_IO_APIC_úq_desc
(
desc
);

2535 #ifde‡
CONFIG_X86_32


2555 
cfg
 = 
desc
->
chù_d©a
;

2556 
i
 = 
cfg
->
ve˘‹
;

2558 
v
 = 
	`≠ic_ªad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2565 
	`ack_APIC_úq
();

2568 i‡(
	`u∆ikñy
(
do_unmask_úq
)) {

2595 
cfg
 = 
desc
->
chù_d©a
;

2596 i‡(!
	`io_≠ic_Àvñ_ack_≥ndög
(
cfg
))

2597 
	`move_masked_úq
(
úq
);

2598 
	`unmask_IO_APIC_úq_desc
(
desc
);

2601 #ifde‡
CONFIG_X86_32


2602 i‡(!(
v
 & (1 << (
i
 & 0x1f)))) {

2603 
	`©omic_öc
(&
úq_mis_cou¡
);

2604 
	`•ö_lock
(&
iﬂpic_lock
);

2605 
	`__mask_™d_edge_IO_APIC_úq
(
cfg
);

2606 
	`__unmask_™d_Àvñ_IO_APIC_úq
(
cfg
);

2607 
	`•ö_u∆ock
(&
iﬂpic_lock
);

2610 
	}
}

2612 #ifde‡
CONFIG_INTR_REMAP


2613 
	$__eoi_iﬂpic_úq
(
úq
, 
úq_cfg
 *
cfg
)

2615 
≠ic
, 
pö
;

2616 
úq_pö_li°
 *
íåy
;

2618 
íåy
 = 
cfg
->
úq_2_pö
;

2621 i‡(!
íåy
)

2624 
≠ic
 = 
íåy
->apic;

2625 
pö
 = 
íåy
->pin;

2626 
	`io_≠ic_eoi
(
≠ic
, 
pö
);

2627 
íåy
 =É¡ry->
√xt
;

2629 
	}
}

2632 
	$eoi_iﬂpic_úq
(
úq_desc
 *
desc
)

2634 
úq_cfg
 *
cfg
;

2635 
Êags
;

2636 
úq
;

2638 
úq
 = 
desc
->irq;

2639 
cfg
 = 
desc
->
chù_d©a
;

2641 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2642 
	`__eoi_iﬂpic_úq
(
úq
, 
cfg
);

2643 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2644 
	}
}

2646 
	$ú_ack_≠ic_edge
(
úq
)

2648 
	`ack_APIC_úq
();

2649 
	}
}

2651 
	$ú_ack_≠ic_Àvñ
(
úq
)

2653 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2655 
	`ack_APIC_úq
();

2656 
	`eoi_iﬂpic_úq
(
desc
);

2657 
	}
}

2660 
úq_chù
 
iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2661 .
«me
 = "IO-APIC",

2662 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2663 .
	gmask
 = 
mask_IO_APIC_úq
,

2664 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2665 .
	gack
 = 
ack_≠ic_edge
,

2666 .
	geoi
 = 
ack_≠ic_Àvñ
,

2667 #ifde‡
CONFIG_SMP


2668 .
	g£t_afföôy
 = 
£t_iﬂpic_afföôy_úq
,

2670 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2673 
úq_chù
 
ú_iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2674 .
«me
 = "IR-IO-APIC",

2675 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2676 .
	gmask
 = 
mask_IO_APIC_úq
,

2677 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2678 #ifde‡
CONFIG_INTR_REMAP


2679 .
	gack
 = 
ú_ack_≠ic_edge
,

2680 .
	geoi
 = 
ú_ack_≠ic_Àvñ
,

2681 #ifde‡
CONFIG_SMP


2682 .
	g£t_afföôy
 = 
£t_ú_iﬂpic_afföôy_úq
,

2685 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2688 
ölöe
 
	$öô_IO_APIC_å≠s
()

2690 
úq
;

2691 
úq_desc
 *
desc
;

2692 
úq_cfg
 *
cfg
;

2705 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

2706 
cfg
 = 
desc
->
chù_d©a
;

2707 i‡(
	`IO_APIC_IRQ
(
úq
Ë&& 
cfg
 && !cfg->
ve˘‹
) {

2713 i‡(
úq
 < 
NR_IRQS_LEGACY
)

2714 
	`make_8259A_úq
(
úq
);

2717 
desc
->
chù
 = &
no_úq_chù
;

2720 
	}
}

2726 
	$mask_œpic_úq
(
úq
)

2728 
v
;

2730 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2731 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2732 
	}
}

2734 
	$unmask_œpic_úq
(
úq
)

2736 
v
;

2738 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2739 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2740 
	}
}

2742 
	$ack_œpic_úq
(
úq
)

2744 
	`ack_APIC_úq
();

2745 
	}
}

2747 
úq_chù
 
œpic_chù
 
	g__ªad_mo°ly
 = {

2748 .
«me
 = "local-APIC",

2749 .
	gmask
 = 
mask_œpic_úq
,

2750 .
	gunmask
 = 
unmask_œpic_úq
,

2751 .
	gack
 = 
ack_œpic_úq
,

2754 
	$œpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
)

2756 
desc
->
°©us
 &~
IRQ_LEVEL
;

2757 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
œpic_chù
, 
h™dÀ_edge_úq
,

2759 
	}
}

2761 
__öô
 
	$£tup_nmi
()

2772 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2774 
	`íabÀ_NMI_through_LVT0
();

2776 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " done.\n");

2777 
	}
}

2786 
ölöe
 
__öô
 
	$u∆ock_ExtINT_logic
()

2788 
≠ic
, 
pö
, 
i
;

2789 
IO_APIC_rouã_íåy
 
íåy0
, 
íåy1
;

2790 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

2792 
pö
 = 
	`föd_iß_úq_pö
(8, 
mp_INT
);

2793 i‡(
pö
 == -1) {

2794 
	`WARN_ON_ONCE
(1);

2797 
≠ic
 = 
	`föd_iß_úq_≠ic
(8, 
mp_INT
);

2798 i‡(
≠ic
 == -1) {

2799 
	`WARN_ON_ONCE
(1);

2803 
íåy0
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

2804 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2806 
	`mem£t
(&
íåy1
, 0, (entry1));

2808 
íåy1
.
de°_mode
 = 0;

2809 
íåy1
.
mask
 = 0;

2810 
íåy1
.
de°
 = 
	`h¨d_smp_¥o˚ss‹_id
();

2811 
íåy1
.
dñivîy_mode
 = 
de°_ExtINT
;

2812 
íåy1
.
pﬁ¨ôy
 = 
íåy0
.polarity;

2813 
íåy1
.
åiggî
 = 0;

2814 
íåy1
.
ve˘‹
 = 0;

2816 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy1
);

2818 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2819 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2820 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
 & ~
RTC_RATE_SELECT
) | 0x6,

2821 
RTC_FREQ_SELECT
);

2822 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2824 
i
 = 100;

2825 
i
-- > 0) {

2826 
	`mdñay
(10);

2827 i‡((
	`CMOS_READ
(
RTC_INTR_FLAGS
Ë& 
RTC_PF
) == RTC_PF)

2828 
i
 -= 10;

2831 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

2832 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

2833 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2835 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy0
);

2836 
	}
}

2838 
dißbÀ_timî_pö_1
 
	g__öôd©a
;

2840 
__öô
 
	$dißbÀ_timî_pö_£tup
(*
¨g
)

2842 
dißbÀ_timî_pö_1
 = 1;

2844 
	}
}

2845 
óæy_∑øm
("dißbÀ_timî_pö_1", 
dißbÀ_timî_pö_£tup
);

2847 
timî_through_8259
 
	g__öôd©a
;

2857 
ölöe
 
__öô
 
	$check_timî
()

2859 
úq_desc
 *
desc
 = 
	`úq_to_desc
(0);

2860 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2861 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

2862 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
;

2863 
Êags
;

2864 
no_pö1
 = 0;

2866 
	`loˇl_úq_ßve
(
Êags
);

2871 
	`dißbÀ_8259A_úq
(0);

2872 
	`assign_úq_ve˘‹
(0, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

2883 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2884 
	`öô_8259A
(1);

2885 #ifde‡
CONFIG_X86_32


2887 
vî
;

2889 
vî
 = 
	`≠ic_ªad
(
APIC_LVR
);

2890 
vî
 = 
	`GET_APIC_VERSION
(ver);

2891 
timî_ack
 = (
nmi_w©chdog
 =
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
vî
));

2895 
pö1
 = 
	`föd_iß_úq_pö
(0, 
mp_INT
);

2896 
≠ic1
 = 
	`föd_iß_úq_≠ic
(0, 
mp_INT
);

2897 
pö2
 = 
iﬂpic_i8259
.
pö
;

2898 
≠ic2
 = 
iﬂpic_i8259
.
≠ic
;

2900 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2902 
cfg
->
ve˘‹
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2911 i‡(
pö1
 == -1) {

2912 i‡(
öå_ªm≠pög_íabÀd
)

2913 
	`∑nic
("BIOS bug:ÅimerÇot connectedÅo IO-APIC");

2914 
pö1
 = 
pö2
;

2915 
≠ic1
 = 
≠ic2
;

2916 
no_pö1
 = 1;

2917 } i‡(
pö2
 == -1) {

2918 
pö2
 = 
pö1
;

2919 
≠ic2
 = 
≠ic1
;

2922 i‡(
pö1
 != -1) {

2926 i‡(
no_pö1
) {

2927 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
);

2928 
	`£tup_timî_IRQ0_pö
(
≠ic1
, 
pö1
, 
cfg
->
ve˘‹
);

2935 
idx
;

2936 
idx
 = 
	`föd_úq_íåy
(
≠ic1
, 
pö1
, 
mp_INT
);

2937 i‡(
idx
 !-1 && 
	`úq_åiggî
(idx))

2938 
	`unmask_IO_APIC_úq_desc
(
desc
);

2940 i‡(
	`timî_úq_w‹ks
()) {

2941 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2942 
	`£tup_nmi
();

2943 
	`íabÀ_8259A_úq
(0);

2945 i‡(
dißbÀ_timî_pö_1
 > 0)

2946 
	`˛ór_IO_APIC_pö
(0, 
pö1
);

2947 
out
;

2949 i‡(
öå_ªm≠pög_íabÀd
)

2950 
	`∑nic
("timer doesn't workÅhrough Interrupt-remapped IO-APIC");

2951 
	`loˇl_úq_dißbÀ
();

2952 
	`˛ór_IO_APIC_pö
(
≠ic1
, 
pö1
);

2953 i‡(!
no_pö1
)

2954 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

2957 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingÅo set upÅimer "

2959 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2960 "..... (foundápi¯%dÖö %dË...\n", 
≠ic2
, 
pö2
);

2964 
	`ª∂a˚_pö_©_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2965 
	`£tup_timî_IRQ0_pö
(
≠ic2
, 
pö2
, 
cfg
->
ve˘‹
);

2966 
	`íabÀ_8259A_úq
(0);

2967 i‡(
	`timî_úq_w‹ks
()) {

2968 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

2969 
timî_through_8259
 = 1;

2970 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2971 
	`dißbÀ_8259A_úq
(0);

2972 
	`£tup_nmi
();

2973 
	`íabÀ_8259A_úq
(0);

2975 
out
;

2980 
	`loˇl_úq_dißbÀ
();

2981 
	`dißbÀ_8259A_úq
(0);

2982 
	`˛ór_IO_APIC_pö
(
≠ic2
, 
pö2
);

2983 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

2986 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2987 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

2989 
nmi_w©chdog
 = 
NMI_NONE
;

2991 #ifde‡
CONFIG_X86_32


2992 
timî_ack
 = 0;

2995 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2998 
	`œpic_ªgi°î_öå
(0, 
desc
);

2999 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3000 
	`íabÀ_8259A_úq
(0);

3002 i‡(
	`timî_úq_w‹ks
()) {

3003 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3004 
out
;

3006 
	`loˇl_úq_dißbÀ
();

3007 
	`dißbÀ_8259A_úq
(0);

3008 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3009 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

3011 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3014 
	`öô_8259A
(0);

3015 
	`make_8259A_úq
(0);

3016 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

3018 
	`u∆ock_ExtINT_logic
();

3020 i‡(
	`timî_úq_w‹ks
()) {

3021 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3022 
out
;

3024 
	`loˇl_úq_dißbÀ
();

3025 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

3026 
	`∑nic
("IO-APIC +Åimer doesn't work! Boot withápic=debugánd sendá "

3028 
out
:

3029 
	`loˇl_úq_ª°‹e
(
Êags
);

3030 
	}
}

3049 
	#PIC_IRQS
 (1 << 
PIC_CASCADE_IR
)

	)

3051 
__öô
 
	$£tup_IO_APIC
()

3058 
io_≠ic_úqs
 = ~
PIC_IRQS
;

3060 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3064 #ifde‡
CONFIG_X86_32


3065 i‡(!
a˝i_iﬂpic
)

3066 
	`£tup_iﬂpic_ids_‰om_mpc
();

3068 
	`sync_Arb_IDs
();

3069 
	`£tup_IO_APIC_úqs
();

3070 
	`öô_IO_APIC_å≠s
();

3071 
	`check_timî
();

3072 
	}
}

3079 
__öô
 
	$io_≠ic_bug_föÆize
()

3081 i‡(
sis_≠ic_bug
 == -1)

3082 
sis_≠ic_bug
 = 0;

3084 
	}
}

3086 
œã_öôˇŒ
(
io_≠ic_bug_föÆize
);

3088 
	ssysfs_iﬂpic_d©a
 {

3089 
sys_devi˚
 
	mdev
;

3090 
IO_APIC_rouã_íåy
 
	míåy
[0];

3092 
sysfs_iﬂpic_d©a
 * 
	gmp_iﬂpic_d©a
[
MAX_IO_APICS
];

3094 
	$iﬂpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

3096 
IO_APIC_rouã_íåy
 *
íåy
;

3097 
sysfs_iﬂpic_d©a
 *
d©a
;

3098 
i
;

3100 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3101 
íåy
 = 
d©a
->entry;

3102 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i ++, 
íåy
 ++ )

3103 *
íåy
 = 
	`iﬂpic_ªad_íåy
(
dev
->
id
, 
i
);

3106 
	}
}

3108 
	$iﬂpic_ªsume
(
sys_devi˚
 *
dev
)

3110 
IO_APIC_rouã_íåy
 *
íåy
;

3111 
sysfs_iﬂpic_d©a
 *
d©a
;

3112 
Êags
;

3113 
IO_APIC_ªg_00
 
ªg_00
;

3114 
i
;

3116 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3117 
íåy
 = 
d©a
->entry;

3119 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3120 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
dev
->
id
, 0);

3121 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
dev
->
id
].
≠icid
) {

3122 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
dev
->
id
].
≠icid
;

3123 
	`io_≠ic_wrôe
(
dev
->
id
, 0, 
ªg_00
.
øw
);

3125 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3126 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i++)

3127 
	`iﬂpic_wrôe_íåy
(
dev
->
id
, 
i
, 
íåy
[i]);

3130 
	}
}

3132 
sysdev_˛ass
 
	giﬂpic_sysdev_˛ass
 = {

3133 .
«me
 = "ioapic",

3134 .
	gsu•íd
 = 
iﬂpic_su•íd
,

3135 .
	gªsume
 = 
iﬂpic_ªsume
,

3138 
__öô
 
	$iﬂpic_öô_sysfs
()

3140 
sys_devi˚
 * 
dev
;

3141 
i
, 
size
, 
îr‹
;

3143 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
iﬂpic_sysdev_˛ass
);

3144 i‡(
îr‹
)

3145  
îr‹
;

3147 
i
 = 0; i < 
ƒ_iﬂpics
; i++ ) {

3148 
size
 = (
sys_devi˚
Ë+ 
ƒ_iﬂpic_ªgi°îs
[
i
]

3149 * (
IO_APIC_rouã_íåy
);

3150 
mp_iﬂpic_d©a
[
i
] = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3151 i‡(!
mp_iﬂpic_d©a
[
i
]) {

3152 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3155 
dev
 = &
mp_iﬂpic_d©a
[
i
]->dev;

3156 
dev
->
id
 = 
i
;

3157 
dev
->
˛s
 = &
iﬂpic_sysdev_˛ass
;

3158 
îr‹
 = 
	`sysdev_ªgi°î
(
dev
);

3159 i‡(
îr‹
) {

3160 
	`k‰ì
(
mp_iﬂpic_d©a
[
i
]);

3161 
mp_iﬂpic_d©a
[
i
] = 
NULL
;

3162 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3168 
	}
}

3170 
devi˚_öôˇŒ
(
iﬂpic_öô_sysfs
);

3172 
	gƒ_úqs_gsi
 = 
NR_IRQS_LEGACY
;

3176 
	$¸óã_úq_ƒ
(
úq_w™t
, 
node
)

3179 
úq
;

3180 
√w
;

3181 
Êags
;

3182 
úq_cfg
 *
cfg_√w
 = 
NULL
;

3183 
úq_desc
 *
desc_√w
 = 
NULL
;

3185 
úq
 = 0;

3186 i‡(
úq_w™t
 < 
ƒ_úqs_gsi
)

3187 
úq_w™t
 = 
ƒ_úqs_gsi
;

3189 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3190 
√w
 = 
úq_w™t
;Çew < 
ƒ_úqs
;Çew++) {

3191 
desc_√w
 = 
	`úq_to_desc_Æloc_node
(
√w
, 
node
);

3192 i‡(!
desc_√w
) {

3193 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
√w
);

3196 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3198 i‡(
cfg_√w
->
ve˘‹
 != 0)

3201 
desc_√w
 = 
	`move_úq_desc
(desc_√w, 
node
);

3203 i‡(
	`__assign_úq_ve˘‹
(
√w
, 
cfg_√w
, 
≠ic
->
	`èrgë_˝us
()) == 0)

3204 
úq
 = 
√w
;

3207 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3209 i‡(
úq
 > 0) {

3210 
	`dy«mic_úq_öô
(
úq
);

3212 i‡(
desc_√w
)

3213 
desc_√w
->
chù_d©a
 = 
cfg_√w
;

3215  
úq
;

3216 
	}
}

3218 
	$¸óã_úq
()

3220 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3221 
úq_w™t
;

3222 
úq
;

3224 
úq_w™t
 = 
ƒ_úqs_gsi
;

3225 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3227 i‡(
úq
 == 0)

3228 
úq
 = -1;

3230  
úq
;

3231 
	}
}

3233 
	$de°roy_úq
(
úq
)

3235 
Êags
;

3236 
úq_cfg
 *
cfg
;

3237 
úq_desc
 *
desc
;

3240 
desc
 = 
	`úq_to_desc
(
úq
);

3241 
cfg
 = 
desc
->
chù_d©a
;

3242 
	`dy«mic_úq_˛ónup
(
úq
);

3244 i‡(
desc
)

3245 
desc
->
chù_d©a
 = 
cfg
;

3247 
	`‰ì_úã
(
úq
);

3248 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3249 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

3250 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3251 
	}
}

3256 #ifde‡
CONFIG_PCI_MSI


3257 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
úq
, 
msi_msg
 *
msg
)

3259 
úq_cfg
 *
cfg
;

3260 
îr
;

3261 
de°
;

3263 i‡(
dißbÀ_≠ic
)

3264  -
ENXIO
;

3266 
cfg
 = 
	`úq_cfg
(
úq
);

3267 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3268 i‡(
îr
)

3269  
îr
;

3271 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

3273 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3274 
úã
 irte;

3275 
ú_ödex
;

3276 
u16
 
sub_h™dÀ
;

3278 
ú_ödex
 = 
	`m≠_úq_to_úã_h™dÀ
(
úq
, &
sub_h™dÀ
);

3279 
	`BUG_ON
(
ú_ödex
 == -1);

3281 
	`mem£t
 (&
úã
, 0, (irte));

3283 
úã
.
¥e£¡
 = 1;

3284 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

3285 
úã
.
åiggî_mode
 = 0;

3286 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3287 
úã
.
ve˘‹
 = 
cfg
->vector;

3288 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3291 
	`£t_msi_sid
(&
úã
, 
pdev
);

3293 
	`modify_úã
(
úq
, &
úã
);

3295 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3296 
msg
->
d©a
 = 
sub_h™dÀ
;

3297 
msg
->
addªss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3298 
MSI_ADDR_IR_SHV
 |

3299 
	`MSI_ADDR_IR_INDEX1
(
ú_ödex
) |

3300 
	`MSI_ADDR_IR_INDEX2
(
ú_ödex
);

3302 i‡(
	`x2≠ic_íabÀd
())

3303 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
 |

3304 
	`MSI_ADDR_EXT_DEST_ID
(
de°
);

3306 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3308 
msg
->
addªss_lo
 =

3309 
MSI_ADDR_BASE_LO
 |

3310 ((
≠ic
->
úq_de°_mode
 == 0) ?

3311 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3312 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3313 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3314 
MSI_ADDR_REDIRECTION_CPU
:

3315 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3316 
	`MSI_ADDR_DEST_ID
(
de°
);

3318 
msg
->
d©a
 =

3319 
MSI_DATA_TRIGGER_EDGE
 |

3320 
MSI_DATA_LEVEL_ASSERT
 |

3321 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3322 
MSI_DATA_DELIVERY_FIXED
:

3323 
MSI_DATA_DELIVERY_LOWPRI
) |

3324 
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3326  
îr
;

3327 
	}
}

3329 #ifde‡
CONFIG_SMP


3330 
	$£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3332 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3333 
úq_cfg
 *
cfg
;

3334 
msi_msg
 
msg
;

3335 
de°
;

3337 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3338 i‡(
de°
 =
BAD_APICID
)

3341 
cfg
 = 
desc
->
chù_d©a
;

3343 
	`ªad_msi_msg_desc
(
desc
, &
msg
);

3345 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3346 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3347 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3348 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3350 
	`wrôe_msi_msg_desc
(
desc
, &
msg
);

3353 
	}
}

3354 #ifde‡
CONFIG_INTR_REMAP


3360 
	$ú_£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3362 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3363 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

3364 
de°
;

3365 
úã
 irte;

3367 i‡(
	`gë_úã
(
úq
, &
úã
))

3370 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3371 i‡(
de°
 =
BAD_APICID
)

3374 
úã
.
ve˘‹
 = 
cfg
->vector;

3375 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3380 
	`modify_úã
(
úq
, &
úã
);

3387 i‡(
cfg
->
move_ö_¥ogªss
)

3388 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3391 
	}
}

3400 
úq_chù
 
	gmsi_chù
 = {

3401 .
«me
 = "PCI-MSI",

3402 .
	gunmask
 = 
unmask_msi_úq
,

3403 .
	gmask
 = 
mask_msi_úq
,

3404 .
	gack
 = 
ack_≠ic_edge
,

3405 #ifde‡
CONFIG_SMP


3406 .
	g£t_afföôy
 = 
£t_msi_úq_afföôy
,

3408 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3411 
úq_chù
 
	gmsi_ú_chù
 = {

3412 .
«me
 = "IR-PCI-MSI",

3413 .
	gunmask
 = 
unmask_msi_úq
,

3414 .
	gmask
 = 
mask_msi_úq
,

3415 #ifde‡
CONFIG_INTR_REMAP


3416 .
	gack
 = 
ú_ack_≠ic_edge
,

3417 #ifde‡
CONFIG_SMP


3418 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3421 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3429 
	$msi_Æloc_úã
(
pci_dev
 *
dev
, 
úq
, 
nvec
)

3431 
öãl_iommu
 *
iommu
;

3432 
ödex
;

3434 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3435 i‡(!
iommu
) {

3436 
	`¥ötk
(
KERN_ERR


3437 "U«bÀÅÿm≠ PCI %†tÿiommu\n", 
	`pci_«me
(
dev
));

3438  -
ENOENT
;

3441 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 
nvec
);

3442 i‡(
ödex
 < 0) {

3443 
	`¥ötk
(
KERN_ERR


3444 "U«bÀÅÿÆloˇã %d IRTE f‹ PCI %s\n", 
nvec
,

3445 
	`pci_«me
(
dev
));

3446  -
ENOSPC
;

3448  
ödex
;

3449 
	}
}

3451 
	$£tup_msi_úq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
úq
)

3453 
ªt
;

3454 
msi_msg
 
msg
;

3456 
ªt
 = 
	`msi_compo£_msg
(
dev
, 
úq
, &
msg
);

3457 i‡(
ªt
 < 0)

3458  
ªt
;

3460 
	`£t_úq_msi
(
úq
, 
msidesc
);

3461 
	`wrôe_msi_msg
(
úq
, &
msg
);

3463 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3464 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3468 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3469 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_ú_chù
, 
h™dÀ_edge_úq
, "edge");

3471 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_chù
, 
h™dÀ_edge_úq
, "edge");

3473 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ MSI/MSI-X\n", 
úq
);

3476 
	}
}

3478 
	$¨ch_£tup_msi_úqs
(
pci_dev
 *
dev
, 
nvec
, 
ty≥
)

3480 
úq
;

3481 
ªt
, 
sub_h™dÀ
;

3482 
msi_desc
 *
msidesc
;

3483 
úq_w™t
;

3484 
öãl_iommu
 *
iommu
 = 
NULL
;

3485 
ödex
 = 0;

3486 
node
;

3489 i‡(
ty≥
 =
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3492 
node
 = 
	`dev_to_node
(&
dev
->dev);

3493 
úq_w™t
 = 
ƒ_úqs_gsi
;

3494 
sub_h™dÀ
 = 0;

3495 
	`li°_f‹_óch_íåy
(
msidesc
, &
dev
->
msi_li°
, 
li°
) {

3496 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3497 i‡(
úq
 == 0)

3499 
úq_w™t
 = 
úq
 + 1;

3500 i‡(!
öå_ªm≠pög_íabÀd
)

3501 
no_ú
;

3503 i‡(!
sub_h™dÀ
) {

3508 
ödex
 = 
	`msi_Æloc_úã
(
dev
, 
úq
, 
nvec
);

3509 i‡(
ödex
 < 0) {

3510 
ªt
 = 
ödex
;

3511 
îr‹
;

3514 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3515 i‡(!
iommu
) {

3516 
ªt
 = -
ENOENT
;

3517 
îr‹
;

3524 
	`£t_úã_úq
(
úq
, 
iommu
, 
ödex
, 
sub_h™dÀ
);

3526 
no_ú
:

3527 
ªt
 = 
	`£tup_msi_úq
(
dev
, 
msidesc
, 
úq
);

3528 i‡(
ªt
 < 0)

3529 
îr‹
;

3530 
sub_h™dÀ
++;

3534 
îr‹
:

3535 
	`de°roy_úq
(
úq
);

3536  
ªt
;

3537 
	}
}

3539 
	$¨ch_ã¨down_msi_úq
(
úq
)

3541 
	`de°roy_úq
(
úq
);

3542 
	}
}

3544 #i‡
deföed
 (
CONFIG_DMAR
Ë|| deföed (
CONFIG_INTR_REMAP
)

3545 #ifde‡
CONFIG_SMP


3546 
	$dm¨_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3548 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3549 
úq_cfg
 *
cfg
;

3550 
msi_msg
 
msg
;

3551 
de°
;

3553 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3554 i‡(
de°
 =
BAD_APICID
)

3557 
cfg
 = 
desc
->
chù_d©a
;

3559 
	`dm¨_msi_ªad
(
úq
, &
msg
);

3561 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3562 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3563 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3564 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3566 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3569 
	}
}

3573 
úq_chù
 
	gdm¨_msi_ty≥
 = {

3574 .
«me
 = "DMAR_MSI",

3575 .
	gunmask
 = 
dm¨_msi_unmask
,

3576 .
	gmask
 = 
dm¨_msi_mask
,

3577 .
	gack
 = 
ack_≠ic_edge
,

3578 #ifde‡
CONFIG_SMP


3579 .
	g£t_afföôy
 = 
dm¨_msi_£t_afföôy
,

3581 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3584 
	$¨ch_£tup_dm¨_msi
(
úq
)

3586 
ªt
;

3587 
msi_msg
 
msg
;

3589 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
);

3590 i‡(
ªt
 < 0)

3591  
ªt
;

3592 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3593 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
dm¨_msi_ty≥
, 
h™dÀ_edge_úq
,

3596 
	}
}

3599 #ifde‡
CONFIG_HPET_TIMER


3601 #ifde‡
CONFIG_SMP


3602 
	$h≥t_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3604 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3605 
úq_cfg
 *
cfg
;

3606 
msi_msg
 
msg
;

3607 
de°
;

3609 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3610 i‡(
de°
 =
BAD_APICID
)

3613 
cfg
 = 
desc
->
chù_d©a
;

3615 
	`h≥t_msi_ªad
(
úq
, &
msg
);

3617 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3618 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3619 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3620 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3622 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3625 
	}
}

3629 
úq_chù
 
	gh≥t_msi_ty≥
 = {

3630 .
«me
 = "HPET_MSI",

3631 .
	gunmask
 = 
h≥t_msi_unmask
,

3632 .
	gmask
 = 
h≥t_msi_mask
,

3633 .
	gack
 = 
ack_≠ic_edge
,

3634 #ifde‡
CONFIG_SMP


3635 .
	g£t_afföôy
 = 
h≥t_msi_£t_afföôy
,

3637 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3640 
	$¨ch_£tup_h≥t_msi
(
úq
)

3642 
ªt
;

3643 
msi_msg
 
msg
;

3644 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3646 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
);

3647 i‡(
ªt
 < 0)

3648  
ªt
;

3650 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3651 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3652 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
h≥t_msi_ty≥
, 
h™dÀ_edge_úq
,

3656 
	}
}

3663 #ifde‡
CONFIG_HT_IRQ


3665 #ifde‡
CONFIG_SMP


3667 
	$èrgë_ht_úq
(
úq
, 
de°
, 
u8
 
ve˘‹
)

3669 
ht_úq_msg
 
msg
;

3670 
	`„tch_ht_úq_msg
(
úq
, &
msg
);

3672 
msg
.
addªss_lo
 &~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3673 
msg
.
addªss_hi
 &~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3675 
msg
.
addªss_lo
 |
	`HT_IRQ_LOW_VECTOR
(
ve˘‹
Ë| 
	`HT_IRQ_LOW_DEST_ID
(
de°
);

3676 
msg
.
addªss_hi
 |
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3678 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3679 
	}
}

3681 
	$£t_ht_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3683 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3684 
úq_cfg
 *
cfg
;

3685 
de°
;

3687 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3688 i‡(
de°
 =
BAD_APICID
)

3691 
cfg
 = 
desc
->
chù_d©a
;

3693 
	`èrgë_ht_úq
(
úq
, 
de°
, 
cfg
->
ve˘‹
);

3696 
	}
}

3700 
úq_chù
 
	ght_úq_chù
 = {

3701 .
«me
 = "PCI-HT",

3702 .
	gmask
 = 
mask_ht_úq
,

3703 .
	gunmask
 = 
unmask_ht_úq
,

3704 .
	gack
 = 
ack_≠ic_edge
,

3705 #ifde‡
CONFIG_SMP


3706 .
	g£t_afföôy
 = 
£t_ht_úq_afföôy
,

3708 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3711 
	$¨ch_£tup_ht_úq
(
úq
, 
pci_dev
 *
dev
)

3713 
úq_cfg
 *
cfg
;

3714 
îr
;

3716 i‡(
dißbÀ_≠ic
)

3717  -
ENXIO
;

3719 
cfg
 = 
	`úq_cfg
(
úq
);

3720 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3721 i‡(!
îr
) {

3722 
ht_úq_msg
 
msg
;

3723 
de°
;

3725 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,

3726 
≠ic
->
	`èrgë_˝us
());

3728 
msg
.
addªss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3730 
msg
.
addªss_lo
 =

3731 
HT_IRQ_LOW_BASE
 |

3732 
	`HT_IRQ_LOW_DEST_ID
(
de°
) |

3733 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
ve˘‹
) |

3734 ((
≠ic
->
úq_de°_mode
 == 0) ?

3735 
HT_IRQ_LOW_DM_PHYSICAL
 :

3736 
HT_IRQ_LOW_DM_LOGICAL
) |

3737 
HT_IRQ_LOW_RQEOI_EDGE
 |

3738 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3739 
HT_IRQ_LOW_MT_FIXED
 :

3740 
HT_IRQ_LOW_MT_ARBITRATED
) |

3741 
HT_IRQ_LOW_IRQ_MASKED
;

3743 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3745 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ht_úq_chù
,

3746 
h™dÀ_edge_úq
, "edge");

3748 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ HT\n", 
úq
);

3750  
îr
;

3751 
	}
}

3754 #ifde‡
CONFIG_X86_UV


3759 
	$¨ch_íabÀ_uv_úq
(*
úq_«me
, 
úq
, 
˝u
, 
mmr_bœde
,

3760 
mmr_off£t
)

3762 c⁄° 
˝umask
 *
ñigibÀ_˝u
 = 
	`˝umask_of
(
˝u
);

3763 
úq_cfg
 *
cfg
;

3764 
mmr_≤ode
;

3765 
mmr_vÆue
;

3766 
uv_IO_APIC_rouã_íåy
 *
íåy
;

3767 
Êags
;

3768 
îr
;

3770 
	`BUILD_BUG_ON
((
uv_IO_APIC_rouã_íåy
) != ());

3772 
cfg
 = 
	`úq_cfg
(
úq
);

3774 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
ñigibÀ_˝u
);

3775 i‡(
îr
 != 0)

3776  
îr
;

3778 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3779 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
uv_úq_chù
, 
h™dÀ_≥r˝u_úq
,

3780 
úq_«me
);

3781 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3783 
mmr_vÆue
 = 0;

3784 
íåy
 = (
uv_IO_APIC_rouã_íåy
 *)&
mmr_vÆue
;

3785 
íåy
->
ve˘‹
 = 
cfg
->vector;

3786 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3787 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

3788 
íåy
->
pﬁ¨ôy
 = 0;

3789 
íåy
->
åiggî
 = 0;

3790 
íåy
->
mask
 = 0;

3791 
íåy
->
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
(
ñigibÀ_˝u
);

3793 
mmr_≤ode
 = 
	`uv_bœde_to_≤ode
(
mmr_bœde
);

3794 
	`uv_wrôe_globÆ_mmr64
(
mmr_≤ode
, 
mmr_off£t
, 
mmr_vÆue
);

3796 i‡(
cfg
->
move_ö_¥ogªss
)

3797 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3799  
úq
;

3800 
	}
}

3806 
	$¨ch_dißbÀ_uv_úq
(
mmr_bœde
, 
mmr_off£t
)

3808 
mmr_vÆue
;

3809 
uv_IO_APIC_rouã_íåy
 *
íåy
;

3810 
mmr_≤ode
;

3812 
	`BUILD_BUG_ON
((
uv_IO_APIC_rouã_íåy
) != ());

3814 
mmr_vÆue
 = 0;

3815 
íåy
 = (
uv_IO_APIC_rouã_íåy
 *)&
mmr_vÆue
;

3816 
íåy
->
mask
 = 1;

3818 
mmr_≤ode
 = 
	`uv_bœde_to_≤ode
(
mmr_bœde
);

3819 
	`uv_wrôe_globÆ_mmr64
(
mmr_≤ode
, 
mmr_off£t
, 
mmr_vÆue
);

3820 
	}
}

3823 
__öô
 
	$io_≠ic_gë_ªdú_íåõs
 (
iﬂpic
)

3825 
IO_APIC_ªg_01
 
ªg_01
;

3826 
Êags
;

3828 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3829 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

3830 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3832  
ªg_01
.
bôs
.
íåõs
;

3833 
	}
}

3835 
__öô
 
	$¥obe_ƒ_úqs_gsi
()

3837 
ƒ
 = 0;

3839 
ƒ
 = 
	`a˝i_¥obe_gsi
();

3840 i‡(
ƒ
 > 
ƒ_úqs_gsi
) {

3841 
ƒ_úqs_gsi
 = 
ƒ
;

3844 
idx
;

3846 
ƒ
 = 0;

3847 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++)

3848 
ƒ
 +
	`io_≠ic_gë_ªdú_íåõs
(
idx
) + 1;

3850 i‡(
ƒ
 > 
ƒ_úqs_gsi
)

3851 
ƒ_úqs_gsi
 = 
ƒ
;

3854 
	`¥ötk
(
KERN_DEBUG
 "ƒ_úqs_gsi: %d\n", 
ƒ_úqs_gsi
);

3855 
	}
}

3857 #ifde‡
CONFIG_SPARSE_IRQ


3858 
__öô
 
	$¨ch_¥obe_ƒ_úqs
()

3860 
ƒ
;

3862 i‡(
ƒ_úqs
 > (
NR_VECTORS
 * 
ƒ_˝u_ids
))

3863 
ƒ_úqs
 = 
NR_VECTORS
 * 
ƒ_˝u_ids
;

3865 
ƒ
 = 
ƒ_úqs_gsi
 + 8 * 
ƒ_˝u_ids
;

3866 #i‡
	`deföed
(
CONFIG_PCI_MSI
Ë|| deföed(
CONFIG_HT_IRQ
)

3870 
ƒ
 +
ƒ_úqs_gsi
 * 16;

3872 i‡(
ƒ
 < 
ƒ_úqs
)

3873 
ƒ_úqs
 = 
ƒ
;

3876 
	}
}

3879 
	$__io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3880 
io_≠ic_úq_©å
 *
úq_©å
)

3882 
úq_desc
 *
desc
;

3883 
úq_cfg
 *
cfg
;

3884 
node
;

3885 
iﬂpic
, 
pö
;

3886 
åiggî
, 
pﬁ¨ôy
;

3888 
iﬂpic
 = 
úq_©å
->ioapic;

3889 i‡(!
	`IO_APIC_IRQ
(
úq
)) {

3890 
	`≠ic_¥ötk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: InvalidÑeferenceÅo IRQ 0\n",

3891 
iﬂpic
);

3892  -
EINVAL
;

3895 i‡(
dev
)

3896 
node
 = 
	`dev_to_node
(
dev
);

3898 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3900 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

3901 i‡(!
desc
) {

3902 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯%d\n", 
úq
);

3906 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3907 
åiggî
 = 
úq_©å
->trigger;

3908 
pﬁ¨ôy
 = 
úq_©å
->polarity;

3913 i‡(
úq
 >
NR_IRQS_LEGACY
) {

3914 
cfg
 = 
desc
->
chù_d©a
;

3915 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
iﬂpic
, 
pö
);

3918 
	`£tup_IO_APIC_úq
(
iﬂpic
, 
pö
, 
úq
, 
desc
, 
åiggî
, 
pﬁ¨ôy
);

3921 
	}
}

3923 
	$io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3924 
io_≠ic_úq_©å
 *
úq_©å
)

3926 
iﬂpic
, 
pö
;

3932 
iﬂpic
 = 
úq_©å
->ioapic;

3933 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3934 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
)) {

3935 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

3936 
mp_iﬂpics
[
iﬂpic
].
≠icid
, 
pö
);

3939 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
);

3941  
	`__io_≠ic_£t_pci_routög
(
dev
, 
úq
, 
úq_©å
);

3942 
	}
}

3948 #ifde‡
CONFIG_ACPI


3950 #ifde‡
CONFIG_X86_32


3951 
__öô
 
	$io_≠ic_gë_unique_id
(
iﬂpic
, 
≠ic_id
)

3953 
IO_APIC_ªg_00
 
ªg_00
;

3954 
physid_mask_t
 
≠ic_id_m≠
 = 
PHYSID_MASK_NONE
;

3955 
physid_mask_t
 
tmp
;

3956 
Êags
;

3957 
i
 = 0;

3968 i‡(
	`physids_em±y
(
≠ic_id_m≠
))

3969 
≠ic_id_m≠
 = 
≠ic
->
	`iﬂpic_phys_id_m≠
(
phys_˝u_¥e£¡_m≠
);

3971 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3972 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

3973 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3975 i‡(
≠ic_id
 >
	`gë_physiˇl_brﬂdˇ°
()) {

3976 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]: Invalidápic_id %d,Årying "

3977 "%d\n", 
iﬂpic
, 
≠ic_id
, 
ªg_00
.
bôs
.
ID
);

3978 
≠ic_id
 = 
ªg_00
.
bôs
.
ID
;

3985 i‡(
≠ic
->
	`check_≠icid_u£d
(
≠ic_id_m≠
, 
≠ic_id
)) {

3987 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++) {

3988 i‡(!
≠ic
->
	`check_≠icid_u£d
(
≠ic_id_m≠
, 
i
))

3992 i‡(
i
 =
	`gë_physiˇl_brﬂdˇ°
())

3993 
	`∑nic
("Maxápic_idÉxceeded!\n");

3995 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]:ápic_id %dálready used, "

3996 "åyög %d\n", 
iﬂpic
, 
≠ic_id
, 
i
);

3998 
≠ic_id
 = 
i
;

4001 
tmp
 = 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
≠ic_id
);

4002 
	`physids_‹
(
≠ic_id_m≠
,ápic_id_m≠, 
tmp
);

4004 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4005 
ªg_00
.
bôs
.
ID
 = 
≠ic_id
;

4007 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4008 
	`io_≠ic_wrôe
(
iﬂpic
, 0, 
ªg_00
.
øw
);

4009 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4010 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4013 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4014 
	`¥ötk
("IOAPIC[%d]: U«bÀÅÿch™gê≠ic_id!\n", 
iﬂpic
);

4019 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


4020 "IOAPIC[%d]: Assig√dápic_id %d\n", 
iﬂpic
, 
≠ic_id
);

4022  
≠ic_id
;

4023 
	}
}

4026 
__öô
 
	$io_≠ic_gë_vîsi⁄
(
iﬂpic
)

4028 
IO_APIC_ªg_01
 
ªg_01
;

4029 
Êags
;

4031 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4032 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

4033 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4035  
ªg_01
.
bôs
.
vîsi⁄
;

4036 
	}
}

4038 
	$a˝i_gë_ovîride_úq
(
bus_úq
, *
åiggî
, *
pﬁ¨ôy
)

4040 
i
;

4042 i‡(
skù_iﬂpic_£tup
)

4045 
i
 = 0; i < 
mp_úq_íåõs
; i++)

4046 i‡(
mp_úqs
[
i
].
úqty≥
 =
mp_INT
 &&

4047 
mp_úqs
[
i
].
§cbusúq
 =
bus_úq
)

4049 i‡(
i
 >
mp_úq_íåõs
)

4052 *
åiggî
 = 
	`úq_åiggî
(
i
);

4053 *
pﬁ¨ôy
 = 
	`úq_pﬁ¨ôy
(
i
);

4055 
	}
}

4064 #ifde‡
CONFIG_SMP


4065 
__öô
 
	$£tup_iﬂpic_de°
()

4067 
pö
, 
iﬂpic
 = 0, 
úq
, 
úq_íåy
;

4068 
úq_desc
 *
desc
;

4069 c⁄° 
˝umask
 *
mask
;

4071 i‡(
skù_iﬂpic_£tup
 == 1)

4074 #ifde‡
CONFIG_ACPI


4075 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

4076 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

4077 i‡(
iﬂpic
 < 0)

4078 
iﬂpic
 = 0;

4082 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
iﬂpic
];Öin++) {

4083 
úq_íåy
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4084 i‡(
úq_íåy
 == -1)

4086 
úq
 = 
	`pö_2_úq
(
úq_íåy
, 
iﬂpic
, 
pö
);

4088 
desc
 = 
	`úq_to_desc
(
úq
);

4093 i‡(
desc
->
°©us
 &

4094 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4095 
mask
 = 
desc
->
afföôy
;

4097 
mask
 = 
≠ic
->
	`èrgë_˝us
();

4099 i‡(
öå_ªm≠pög_íabÀd
)

4100 
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4102 
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4105 
	}
}

4108 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4110 
ªsour˚
 *
	giﬂpic_ªsour˚s
;

4112 
ªsour˚
 * 
__öô
 
	$iﬂpic_£tup_ªsour˚s
()

4114 
n
;

4115 
ªsour˚
 *
ªs
;

4116 *
mem
;

4117 
i
;

4119 i‡(
ƒ_iﬂpics
 <= 0)

4120  
NULL
;

4122 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
ªsour˚
);

4123 
n
 *
ƒ_iﬂpics
;

4125 
mem
 = 
	`Æloc_boŸmem
(
n
);

4126 
ªs
 = (*)
mem
;

4128 i‡(
mem
 !
NULL
) {

4129 
mem
 +(
ªsour˚
Ë* 
ƒ_iﬂpics
;

4131 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4132 
ªs
[
i
].
«me
 = 
mem
;

4133 
ªs
[
i
].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4134 
	`•rötf
(
mem
, "IOAPIC %u", 
i
);

4135 
mem
 +
IOAPIC_RESOURCE_NAME_SIZE
;

4139 
iﬂpic_ªsour˚s
 = 
ªs
;

4141  
ªs
;

4142 
	}
}

4144 
__öô
 
	$iﬂpic_öô_m≠pögs
()

4146 
iﬂpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4147 
ªsour˚
 *
iﬂpic_ªs
;

4148 
i
;

4150 
iﬂpic_ªs
 = 
	`iﬂpic_£tup_ªsour˚s
();

4151 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4152 i‡(
smp_found_c⁄fig
) {

4153 
iﬂpic_phys
 = 
mp_iﬂpics
[
i
].
≠iˇddr
;

4154 #ifde‡
CONFIG_X86_32


4155 i‡(!
iﬂpic_phys
) {

4156 
	`¥ötk
(
KERN_ERR


4160 
smp_found_c⁄fig
 = 0;

4161 
skù_iﬂpic_£tup
 = 1;

4162 
Áke_iﬂpic_∑ge
;

4166 #ifde‡
CONFIG_X86_32


4167 
Áke_iﬂpic_∑ge
:

4169 
iﬂpic_phys
 = ()

4170 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

4171 
iﬂpic_phys
 = 
	`__∑
(ioapic_phys);

4173 
	`£t_fixm≠_noˇche
(
idx
, 
iﬂpic_phys
);

4174 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

4176 
	`__fix_to_vút
(
idx
), 
iﬂpic_phys
);

4177 
idx
++;

4179 i‡(
iﬂpic_ªs
 !
NULL
) {

4180 
iﬂpic_ªs
->
°¨t
 = 
iﬂpic_phys
;

4181 
iﬂpic_ªs
->
íd
 = 
iﬂpic_phys
 + (4 * 1024) - 1;

4182 
iﬂpic_ªs
++;

4185 
	}
}

4187 
__öô
 
	$iﬂpic_ö£π_ªsour˚s
()

4189 
i
;

4190 
ªsour˚
 *
r
 = 
iﬂpic_ªsour˚s
;

4192 i‡(!
r
) {

4193 i‡(
ƒ_iﬂpics
 > 0)

4194 
	`¥ötk
(
KERN_ERR


4199 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4200 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
r
);

4201 
r
++;

4203 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<löux/˝umask.h
>

2 
	~<löux/öãºu±.h
>

3 
	~<löux/öô.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/mc146818πc.h
>

10 
	~<löux/ˇche.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/moduÀ.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mår.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/ùi.h
>

22 
	$deÁu…_£nd_IPI_mask_£quí˚_phys
(c⁄° 
˝umask
 *
mask
, 
ve˘‹
)

24 
quîy_˝u
;

25 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

33 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

34 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

35 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

40 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(c⁄° 
˝umask
 *
mask
,

41 
ve˘‹
)

43 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

44 
quîy_˝u
;

45 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

50 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

51 i‡(
quîy_˝u
 =
this_˝u
)

53 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

54 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
	$deÁu…_£nd_IPI_mask_£quí˚_logiˇl
(c⁄° 
˝umask
 *
mask
,

60 
ve˘‹
)

62 
Êags
;

63 
quîy_˝u
;

71 
	`loˇl_úq_ßve
(
Êags
);

72 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
)

73 
	`__deÁu…_£nd_IPI_de°_fõld
(

74 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

75 
≠ic
->
de°_logiˇl
);

76 
	`loˇl_úq_ª°‹e
(
Êags
);

77 
	}
}

79 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_logiˇl
(c⁄° 
˝umask
 *
mask
,

80 
ve˘‹
)

82 
Êags
;

83 
quîy_˝u
;

84 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

88 
	`loˇl_úq_ßve
(
Êags
);

89 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

90 i‡(
quîy_˝u
 =
this_˝u
)

92 
	`__deÁu…_£nd_IPI_de°_fõld
(

93 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

94 
≠ic
->
de°_logiˇl
);

96 
	`loˇl_úq_ª°‹e
(
Êags
);

97 
	}
}

99 #ifde‡
CONFIG_X86_32


104 
	$deÁu…_£nd_IPI_mask_logiˇl
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

106 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

107 
Êags
;

109 i‡(
	`WARN_ONCE
(!
mask
, "empty IPI mask"))

112 
	`loˇl_úq_ßve
(
Êags
);

113 
	`WARN_ON
(
mask
 & ~
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0]);

114 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

118 
	$deÁu…_£nd_IPI_Ælbut£lf
(
ve˘‹
)

124 i‡(!(
	`num_⁄löe_˝us
() > 1))

127 
	`__deÁu…_loˇl_£nd_IPI_Ælbut£lf
(
ve˘‹
);

128 
	}
}

130 
	$deÁu…_£nd_IPI_Æl
(
ve˘‹
)

132 
	`__deÁu…_loˇl_£nd_IPI_Æl
(
ve˘‹
);

133 
	}
}

135 
	$deÁu…_£nd_IPI_£lf
(
ve˘‹
)

137 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

138 
	}
}

141 
	$c⁄vît_≠icid_to_˝u
(
≠ic_id
)

143 
i
;

145 
	`f‹_óch_possibÀ_˝u
(
i
) {

146 i‡(
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
i
Ë=
≠ic_id
)

147  
i
;

150 
	}
}

152 
	$ß„_smp_¥o˚ss‹_id
()

154 
≠icid
, 
˝uid
;

156 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_APIC
))

159 
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

160 i‡(
≠icid
 =
BAD_APICID
)

163 
˝uid
 = 
	`c⁄vît_≠icid_to_˝u
(
≠icid
);

165  
˝uid
 >= 0 ? cpuid : 0;

166 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/≠ic.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/sys˘l.h
>

23 
	~<löux/≥r˝u.h
>

24 
	~<löux/k¥obes.h
>

25 
	~<löux/˝umask.h
>

26 
	~<löux/kî√l_°©.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/smp.h
>

30 
	~<asm/i8259.h
>

31 
	~<asm/io_≠ic.h
>

32 
	~<asm/¥Ÿo.h
>

33 
	~<asm/timî.h
>

35 
	~<asm/m˚.h
>

37 
	~<asm/mach_å≠s.h
>

39 
	gunknown_nmi_∑nic
;

40 
	gnmi_w©chdog_íabÀd
;

42 
˝umask_v¨_t
 
	gbackåa˚_mask
;

50 
©omic_t
 
	gnmi_a˘ive
 = 
ATOMIC_INIT
(0);

51 
EXPORT_SYMBOL
(
nmi_a˘ive
);

53 
	gnmi_w©chdog
 = 
NMI_NONE
;

54 
EXPORT_SYMBOL
(
nmi_w©chdog
);

56 
	g∑nic_⁄_timeout
;

58 
	gnmi_hz
 = 
HZ
;

59 
DEFINE_PER_CPU
(, 
wd_íabÀd
);

60 
ídÊag
 
	g__öôd©a
;

62 
ölöe
 
	$gë_nmi_cou¡
(
˝u
)

64  
	`≥r_˝u
(
úq_°©
, 
˝u
).
__nmi_cou¡
;

65 
	}
}

67 
ölöe
 
	$m˚_ö_¥ogªss
()

69 #i‡
	`deföed
(
CONFIG_X86_NEW_MCE
)

70  
	`©omic_ªad
(&
m˚_íåy
) > 0;

73 
	}
}

79 
ölöe
 
	$gë_timî_úqs
(
˝u
)

81  
	`≥r_˝u
(
úq_°©
, 
˝u
).
≠ic_timî_úqs
 +

82 
	`≥r_˝u
(
úq_°©
, 
˝u
).
úq0_úqs
;

83 
	}
}

85 #ifde‡
CONFIG_SMP


91 
__öô
 
	$nmi_˝u_busy
(*
d©a
)

93 
	`loˇl_úq_íabÀ_ö_h¨dúq
();

102 
ídÊag
 == 0)

103 
	`mb
();

104 
	}
}

107 
	$ªp‹t_brokí_nmi
(
˝u
, *
¥ev_nmi_cou¡
)

109 
	`¥ötk
(
KERN_CONT
 "\n");

111 
	`¥ötk
(
KERN_WARNING


113 
˝u
, 
¥ev_nmi_cou¡
[˝u], 
	`gë_nmi_cou¡
(cpu));

115 
	`¥ötk
(
KERN_WARNING


117 
	`¥ötk
(
KERN_WARNING


120 
	`≥r_˝u
(
wd_íabÀd
, 
˝u
) = 0;

121 
	`©omic_dec
(&
nmi_a˘ive
);

122 
	}
}

124 
	$__a˝i_nmi_dißbÀ
(*
__unu£d
)

126 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

127 
	}
}

129 
__öô
 
	$check_nmi_w©chdog
()

131 *
¥ev_nmi_cou¡
;

132 
˝u
;

134 i‡(!
	`nmi_w©chdog_a˘ive
(Ë|| !
	`©omic_ªad
(&
nmi_a˘ive
))

137 
¥ev_nmi_cou¡
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

138 i‡(!
¥ev_nmi_cou¡
)

139 
îr‹
;

141 
	`Æloc_˝umask_v¨
(&
backåa˚_mask
, 
GFP_KERNEL
|
__GFP_ZERO
);

142 
	`¥ötk
(
KERN_INFO
 "Testing NMI watchdog ... ");

144 #ifde‡
CONFIG_SMP


145 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

146 
	`smp_ˇŒ_fun˘i⁄
(
nmi_˝u_busy
, (*)&
ídÊag
, 0);

149 
	`f‹_óch_possibÀ_˝u
(
˝u
)

150 
¥ev_nmi_cou¡
[
˝u
] = 
	`gë_nmi_cou¡
(cpu);

151 
	`loˇl_úq_íabÀ
();

152 
	`mdñay
((20 * 1000Ë/ 
nmi_hz
);

154 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

155 i‡(!
	`≥r_˝u
(
wd_íabÀd
, 
˝u
))

157 i‡(
	`gë_nmi_cou¡
(
˝u
Ë- 
¥ev_nmi_cou¡
[cpu] <= 5)

158 
	`ªp‹t_brokí_nmi
(
˝u
, 
¥ev_nmi_cou¡
);

160 
ídÊag
 = 1;

161 i‡(!
	`©omic_ªad
(&
nmi_a˘ive
)) {

162 
	`k‰ì
(
¥ev_nmi_cou¡
);

163 
	`©omic_£t
(&
nmi_a˘ive
, -1);

164 
îr‹
;

166 
	`¥ötk
("OK.\n");

172 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

173 
nmi_hz
 = 
	`œpic_adju°_nmi_hz
(1);

175 
	`k‰ì
(
¥ev_nmi_cou¡
);

177 
îr‹
:

178 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

179 i‡(!
timî_through_8259
)

180 
	`dißbÀ_8259A_úq
(0);

181 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

184 #ifde‡
CONFIG_X86_32


185 
timî_ack
 = 0;

188 
	}
}

190 
__öô
 
	$£tup_nmi_w©chdog
(*
°r
)

192 
nmi
;

194 i‡(!
	`°∫cmp
(
°r
, "panic", 5)) {

195 
∑nic_⁄_timeout
 = 1;

196 
°r
 = 
	`°rchr
(str, ',');

197 i‡(!
°r
)

199 ++
°r
;

202 i‡(!
	`°∫cmp
(
°r
, "lapic", 5))

203 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

204 i‡(!
	`°∫cmp
(
°r
, "ioapic", 6))

205 
nmi_w©chdog
 = 
NMI_IO_APIC
;

207 
	`gë_›ti⁄
(&
°r
, &
nmi
);

208 i‡(
nmi
 >
NMI_INVALID
)

210 
nmi_w©chdog
 = 
nmi
;

214 
	}
}

215 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

220 #ifde‡
CONFIG_PM


222 
	gnmi_pm_a˘ive
;

224 
	$œpic_nmi_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

227 
nmi_pm_a˘ive
 = 
	`©omic_ªad
(&
nmi_a˘ive
);

228 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

229 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

231 
	}
}

233 
	$œpic_nmi_ªsume
(
sys_devi˚
 *
dev
)

236 i‡(
nmi_pm_a˘ive
 > 0) {

237 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

238 
	`touch_nmi_w©chdog
();

241 
	}
}

243 
sysdev_˛ass
 
	gnmi_sys˛ass
 = {

244 .
«me
 = "lapic_nmi",

245 .
	gªsume
 = 
œpic_nmi_ªsume
,

246 .
	gsu•íd
 = 
œpic_nmi_su•íd
,

249 
sys_devi˚
 
	gdevi˚_œpic_nmi
 = {

250 .
id
 = 0,

251 .
	g˛s
 = &
nmi_sys˛ass
,

254 
__öô
 
	$öô_œpic_nmi_sysfs
()

256 
îr‹
;

262 i‡(
nmi_w©chdog
 !
NMI_LOCAL_APIC
)

265 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) < 0)

268 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
nmi_sys˛ass
);

269 i‡(!
îr‹
)

270 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic_nmi
);

271  
îr‹
;

272 
	}
}

275 
œã_öôˇŒ
(
öô_œpic_nmi_sysfs
);

279 
	$__a˝i_nmi_íabÀ
(*
__unu£d
)

281 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
);

282 
	}
}

287 
	$a˝i_nmi_íabÀ
()

289 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

290 
	`⁄_óch_˝u
(
__a˝i_nmi_íabÀ
, 
NULL
, 1);

291 
	}
}

296 
	$a˝i_nmi_dißbÀ
()

298 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

299 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

300 
	}
}

306 
	$˝u_nmi_£t_wd_íabÀd
()

308 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

309 
	}
}

311 
	$£tup_≠ic_nmi_w©chdog
(*
unu£d
)

313 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
))

318 i‡(
	`smp_¥o˚ss‹_id
(Ë!0 && 
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

321 
nmi_w©chdog
) {

322 
NMI_LOCAL_APIC
:

323 i‡(
	`œpic_w©chdog_öô
(
nmi_hz
) < 0) {

324 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

328 
NMI_IO_APIC
:

329 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

330 
	`©omic_öc
(&
nmi_a˘ive
);

332 
	}
}

334 
	$°›_≠ic_nmi_w©chdog
(*
unu£d
)

337 i‡(!
	`nmi_w©chdog_a˘ive
())

339 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
) == 0)

341 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

342 
	`œpic_w©chdog_°›
();

344 
	`__a˝i_nmi_dißbÀ
(
NULL
);

345 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

346 
	`©omic_dec
(&
nmi_a˘ive
);

347 
	}
}

363 
DEFINE_PER_CPU
(, 
œ°_úq_sum
);

364 
DEFINE_PER_CPU
(
loˇl_t
, 
Æît_cou¡î
);

365 
DEFINE_PER_CPU
(, 
nmi_touch
);

367 
	$touch_nmi_w©chdog
()

369 i‡(
	`nmi_w©chdog_a˘ive
()) {

370 
˝u
;

377 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

378 i‡(
	`≥r_˝u
(
nmi_touch
, 
˝u
) != 1)

379 
	`≥r_˝u
(
nmi_touch
, 
˝u
) = 1;

386 
	`touch_so·lockup_w©chdog
();

387 
	}
}

388 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

390 
nŸø˚
 
__k¥obes
 

391 
	$nmi_w©chdog_tick
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

398 
sum
;

399 
touched
 = 0;

400 
˝u
 = 
	`smp_¥o˚ss‹_id
();

401 
rc
 = 0;

404 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

405 =
NOTIFY_STOP
) {

406 
rc
 = 1;

407 
touched
 = 1;

410 
sum
 = 
	`gë_timî_úqs
(
˝u
);

412 i‡(
	`__gë_˝u_v¨
(
nmi_touch
)) {

413 
	`__gë_˝u_v¨
(
nmi_touch
) = 0;

414 
touched
 = 1;

418 i‡(
backåa˚_mask
 !
NULL
 && 
	`˝umask_ã°_˝u
(
˝u
, backtrace_mask)) {

419 
	`DEFINE_SPINLOCK
(
lock
);

421 
	`•ö_lock
(&
lock
);

422 
	`¥ötk
(
KERN_WARNING
 "NMI backåa˚ f‹ cpu %d\n", 
˝u
);

423 
	`dump_°ack
();

424 
	`•ö_u∆ock
(&
lock
);

425 
	`˝umask_˛ór_˝u
(
˝u
, 
backåa˚_mask
);

429 i‡(
	`m˚_ö_¥ogªss
())

430 
touched
 = 1;

433 i‡(!
touched
 && 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë=
sum
) {

438 
	`loˇl_öc
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
));

439 i‡(
	`loˇl_ªad
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
)Ë=5 * 
nmi_hz
)

443 
	`dõ_nmi
("BUG: NMI Watchdog detected LOCKUP",

444 
ªgs
, 
∑nic_⁄_timeout
);

446 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë
sum
;

447 
	`loˇl_£t
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
), 0);

451 i‡(!
	`__gë_˝u_v¨
(
wd_íabÀd
))

452  
rc
;

453 
nmi_w©chdog
) {

454 
NMI_LOCAL_APIC
:

455 
rc
 |
	`œpic_wd_evít
(
nmi_hz
);

457 
NMI_IO_APIC
:

463 
rc
 = 1;

466  
rc
;

467 
	}
}

469 #ifde‡
CONFIG_SYSCTL


471 
	$íabÀ_iﬂpic_nmi_w©chdog_sögÀ
(*
unu£d
)

473 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

474 
	`©omic_öc
(&
nmi_a˘ive
);

475 
	`__a˝i_nmi_íabÀ
(
NULL
);

476 
	}
}

478 
	$íabÀ_iﬂpic_nmi_w©chdog
()

480 
	`⁄_óch_˝u
(
íabÀ_iﬂpic_nmi_w©chdog_sögÀ
, 
NULL
, 1);

481 
	`touch_nmi_w©chdog
();

482 
	}
}

484 
	$dißbÀ_iﬂpic_nmi_w©chdog
()

486 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

487 
	}
}

489 
__öô
 
	$£tup_unknown_nmi_∑nic
(*
°r
)

491 
unknown_nmi_∑nic
 = 1;

493 
	}
}

494 
__£tup
("unknown_nmi_∑nic", 
£tup_unknown_nmi_∑nic
);

496 
	$unknown_nmi_∑nic_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

498 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

499 
buf
[64];

501 
	`•rötf
(
buf
, "NMIÑe˚ived f‹ unknow¿ªas⁄ %02x\n", 
ªas⁄
);

502 
	`dõ_nmi
(
buf
, 
ªgs
, 1);

504 
	}
}

509 
	$¥oc_nmi_íabÀd
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
, 
fûe
 *file,

510 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

512 
ﬁd_°©e
;

514 
nmi_w©chdog_íabÀd
 = (
	`©omic_ªad
(&
nmi_a˘ive
) > 0) ? 1 : 0;

515 
ﬁd_°©e
 = 
nmi_w©chdog_íabÀd
;

516 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
fûe
, 
buf„r
, 
Àngth
, 
µos
);

517 i‡(!!
ﬁd_°©e
 =!!
nmi_w©chdog_íabÀd
)

520 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë< 0 || !
	`nmi_w©chdog_a˘ive
()) {

521 
	`¥ötk
(
KERN_WARNING


523  -
EIO
;

526 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
) {

527 i‡(
nmi_w©chdog_íabÀd
)

528 
	`íabÀ_œpic_nmi_w©chdog
();

530 
	`dißbÀ_œpic_nmi_w©chdog
();

531 } i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

532 i‡(
nmi_w©chdog_íabÀd
)

533 
	`íabÀ_iﬂpic_nmi_w©chdog
();

535 
	`dißbÀ_iﬂpic_nmi_w©chdog
();

537 
	`¥ötk
(
KERN_WARNING


539  -
EIO
;

542 
	}
}

546 
	$do_nmi_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

548 #ifde‡
CONFIG_SYSCTL


549 i‡(
unknown_nmi_∑nic
)

550  
	`unknown_nmi_∑nic_ˇŒback
(
ªgs
, 
˝u
);

553 
	}
}

555 
	$__åiggî_Æl_˝u_backåa˚
()

557 
i
;

559 
	`˝umask_c›y
(
backåa˚_mask
, 
˝u_⁄löe_mask
);

561 
i
 = 0; i < 10 * 1000; i++) {

562 i‡(
	`˝umask_em±y
(
backåa˚_mask
))

564 
	`mdñay
(1);

566 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<löux/thªads.h
>

12 
	~<löux/˝umask.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/dm¨.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/ùi.h
>

24 
	~<asm/£tup.h
>

26 
≠ic
 
≠ic_Ê©
;

27 
≠ic
 
≠ic_physÊ©
;

28 
≠ic
 
≠ic_x2xpic_uv_x
;

29 
≠ic
 
≠ic_x2≠ic_phys
;

30 
≠ic
 
≠ic_x2≠ic_˛u°î
;

32 
≠ic
 
__ªad_mo°ly
 *
	g≠ic
 = &
≠ic_Ê©
;

33 
EXPORT_SYMBOL_GPL
(
≠ic
);

35 
≠ic
 *
	g≠ic_¥obe
[] 
	g__öôd©a
 = {

36 #ifde‡
CONFIG_X86_UV


37 &
≠ic_x2≠ic_uv_x
,

39 #ifde‡
CONFIG_X86_X2APIC


40 &
≠ic_x2≠ic_phys
,

41 &
≠ic_x2≠ic_˛u°î
,

43 &
≠ic_physÊ©
,

44 
NULL
,

47 
	$≠icid_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

49  
	`h¨d_smp_¥o˚ss‹_id
(Ë>> 
ödex_msb
;

50 
	}
}

55 
__öô
 
	$deÁu…_£tup_≠ic_routög
()

57 #ifde‡
CONFIG_X86_X2APIC


58 i‡(
x2≠ic_mode
 && (
≠ic
 !&
≠ic_x2≠ic_phys
 &&

59 #ifde‡
CONFIG_X86_UV


60 
≠ic
 !&
≠ic_x2≠ic_uv_x
 &&

62 
≠ic
 !&
≠ic_x2≠ic_˛u°î
)) {

63 i‡(
x2≠ic_phys
)

64 
≠ic
 = &
≠ic_x2≠ic_phys
;

66 
≠ic
 = &
≠ic_x2≠ic_˛u°î
;

67 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

71 i‡(
≠ic
 =&
≠ic_Ê©
) {

72 i‡(
max_physiˇl_≠icid
 >= 8)

73 
≠ic
 = &
≠ic_physÊ©
;

74 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

77 i‡(
	`is_vsmp_box
()) {

79 
≠ic
->
phys_pkg_id
 = 
≠icid_phys_pkg_id
;

86 i‡(
öå_ªm≠pög_íabÀd
)

87 
	`íabÀ_drhd_Áu…_h™dlög
();

88 
	}
}

92 
	$≠ic_£nd_IPI_£lf
(
ve˘‹
)

94 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

95 
	}
}

97 
__öô
 
	$deÁu…_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

99 
i
;

101 
i
 = 0; 
≠ic_¥obe
[i]; ++i) {

102 i‡(
≠ic_¥obe
[
i
]->
	`a˝i_madt_€m_check
(
€m_id
, 
€m_èbÀ_id
)) {

103 
≠ic
 = 
≠ic_¥obe
[
i
];

104 
	`¥ötk
(
KERN_INFO
 "Setting APICÑoutingÅo %s.\n",

105 
≠ic
->
«me
);

110 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<löux/öô.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/audô.h
>

4 
	~<asm/uni°d.h
>

6 
	gdú_˛ass
[] = {

7 
	~<asm-gíîic/audô_dú_wrôe.h
>

11 
	gªad_˛ass
[] = {

12 
	~<asm-gíîic/audô_ªad.h
>

16 
	gwrôe_˛ass
[] = {

17 
	~<asm-gíîic/audô_wrôe.h
>

21 
	gch©å_˛ass
[] = {

22 
	~<asm-gíîic/audô_ch™ge_©å.h
>

26 
	gsig«l_˛ass
[] = {

27 
	~<asm-gíîic/audô_sig«l.h
>

31 
	$audô_˛assify_¨ch
(
¨ch
)

33 #ifde‡
CONFIG_IA32_EMULATION


34 i‡(
¨ch
 =
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$audô_˛assify_sysˇŒ
(
abi
, 
sysˇŒ
)

42 #ifde‡
CONFIG_IA32_EMULATION


43 
	`ü32_˛assify_sysˇŒ
();

44 i‡(
abi
 =
AUDIT_ARCH_I386
)

45  
	`ü32_˛assify_sysˇŒ
(
sysˇŒ
);

47 
sysˇŒ
) {

48 
__NR_›í
:

50 
__NR_›í©
:

52 
__NR_execve
:

57 
	}
}

59 
__öô
 
	$audô_˛as£s_öô
()

61 #ifde‡
CONFIG_IA32_EMULATION


62 
__u32
 
ü32_dú_˛ass
[];

63 
__u32
 
ü32_wrôe_˛ass
[];

64 
__u32
 
ü32_ªad_˛ass
[];

65 
__u32
 
ü32_ch©å_˛ass
[];

66 
__u32
 
ü32_sig«l_˛ass
[];

67 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE_32
, 
ü32_wrôe_˛ass
);

68 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ_32
, 
ü32_ªad_˛ass
);

69 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE_32
, 
ü32_dú_˛ass
);

70 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR_32
, 
ü32_ch©å_˛ass
);

71 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL_32
, 
ü32_sig«l_˛ass
);

73 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE
, 
wrôe_˛ass
);

74 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ
, 
ªad_˛ass
);

75 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE
, 
dú_˛ass
);

76 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR
, 
ch©å_˛ass
);

77 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL
, 
sig«l_˛ass
);

79 
	}
}

81 
__öôˇŒ
(
audô_˛as£s_öô
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<löux/ty≥s.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/•ölock.h
>

10 
	~<löux/a˝i.h
>

11 
	~<asm/io.h
>

13 
	~<löux/mc146818πc.h
>

15 
	#SBF_RESERVED
 (0x78)

	)

16 
	#SBF_PNPOS
 (1<<0)

	)

17 
	#SBF_BOOTING
 (1<<1)

	)

18 
	#SBF_DIAG
 (1<<2)

	)

19 
	#SBF_PARITY
 (1<<7)

	)

21 
sbf_p‹t
 
	g__öôd©a
 = -1;

23 
__öô
 
	$∑rôy
(
u8
 
v
)

25 
x
 = 0;

26 
i
;

28 
i
 = 0; i < 8; i++) {

29 
x
 ^(
v
 & 1);

30 
v
 >>= 1;

33  
x
;

34 
	}
}

36 
__öô
 
	$sbf_wrôe
(
u8
 
v
)

38 
Êags
;

40 i‡(
sbf_p‹t
 != -1) {

41 
v
 &~
SBF_PARITY
;

42 i‡(!
	`∑rôy
(
v
))

43 
v
 |
SBF_PARITY
;

45 
	`¥ötk
(
KERN_INFO
 "Simple Boot Flagát 0x%x setÅo 0x%x\n",

46 
sbf_p‹t
, 
v
);

48 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

49 
	`CMOS_WRITE
(
v
, 
sbf_p‹t
);

50 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

52 
	}
}

54 
u8
 
__öô
 
	$sbf_ªad
()

56 
Êags
;

57 
u8
 
v
;

59 i‡(
sbf_p‹t
 == -1)

62 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

63 
v
 = 
	`CMOS_READ
(
sbf_p‹t
);

64 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

66  
v
;

67 
	}
}

69 
__öô
 
	$sbf_vÆue_vÆid
(
u8
 
v
)

71 i‡(
v
 & 
SBF_RESERVED
)

73 i‡(!
	`∑rôy
(
v
))

77 
	}
}

79 
__öô
 
	$sbf_öô
()

81 
u8
 
v
;

83 i‡(
sbf_p‹t
 == -1)

86 
v
 = 
	`sbf_ªad
();

87 i‡(!
	`sbf_vÆue_vÆid
(
v
)) {

88 
	`¥ötk
(
KERN_WARNING
 "Simple Boot Flag value 0x%xÑead from "

89 "CMOS RAM wa†övÆid\n", 
v
);

92 
v
 &~
SBF_RESERVED
;

93 
v
 &~
SBF_BOOTING
;

94 
v
 &~
SBF_DIAG
;

95 #i‡
	`deföed
(
CONFIG_ISAPNP
)

96 
v
 |
SBF_PNPOS
;

98 
	`sbf_wrôe
(
v
);

101 
	}
}

102 
moduÀ_öô
(
sbf_öô
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/kthªad.h
>

4 
	~<löux/w‹kqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/¥Ÿo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__ªad_mo°ly
 
	gmem‹y_c‹ru±i⁄_check
 = -1;

18 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_size
 = 64*1024;

19 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_≥riod
 = 60;

21 
e820íåy
 
	gsˇn_¨ós
[
MAX_SCAN_AREAS
];

22 
	gnum_sˇn_¨ós
;

25 
__öô
 
	$£t_c‹ru±i⁄_check
(*
¨g
)

27 *
íd
;

29 
mem‹y_c‹ru±i⁄_check
 = 
	`sim∂e_°πﬁ
(
¨g
, &
íd
, 10);

31  (*
íd
 =0Ë? 0 : -
EINVAL
;

32 
	}
}

33 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check", 
£t_c‹ru±i⁄_check
);

35 
__öô
 
	$£t_c‹ru±i⁄_check_≥riod
(*
¨g
)

37 *
íd
;

39 
c‹ru±i⁄_check_≥riod
 = 
	`sim∂e_°πoul
(
¨g
, &
íd
, 10);

41  (*
íd
 =0Ë? 0 : -
EINVAL
;

42 
	}
}

43 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_≥riod", 
£t_c‹ru±i⁄_check_≥riod
);

45 
__öô
 
	$£t_c‹ru±i⁄_check_size
(*
¨g
)

47 *
íd
;

48 
size
;

50 
size
 = 
	`mem∑r£
(
¨g
, &
íd
);

52 i‡(*
íd
 == '\0')

53 
c‹ru±i⁄_check_size
 = 
size
;

55  (
size
 =
c‹ru±i⁄_check_size
Ë? 0 : -
EINVAL
;

56 
	}
}

57 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_size", 
£t_c‹ru±i⁄_check_size
);

60 
__öô
 
	$£tup_bios_c‹ru±i⁄_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 i‡(
mem‹y_c‹ru±i⁄_check
 == -1) {

65 
mem‹y_c‹ru±i⁄_check
 =

66 #ifde‡
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 i‡(
c‹ru±i⁄_check_size
 == 0)

75 
mem‹y_c‹ru±i⁄_check
 = 0;

77 i‡(!
mem‹y_c‹ru±i⁄_check
)

80 
c‹ru±i⁄_check_size
 = 
	`round_up
(c‹ru±i⁄_check_size, 
PAGE_SIZE
);

82 
addr
 < 
c‹ru±i⁄_check_size
 && 
num_sˇn_¨ós
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`föd_e820_¨ó_size
◊ddr, &
size
, 
PAGE_SIZE
);

86 i‡(!(
addr
 + 1))

89 i‡(
addr
 >
c‹ru±i⁄_check_size
)

92 i‡((
addr
 + 
size
Ë> 
c‹ru±i⁄_check_size
)

93 
size
 = 
c‹ru±i⁄_check_size
 - 
addr
;

95 
	`e820_upd©e_ønge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sˇn_¨ós
[
num_sˇn_¨ós
].
addr
 =áddr;

97 
sˇn_¨ós
[
num_sˇn_¨ós
].
size
 = size;

98 
num_sˇn_¨ós
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +
size
;

106 
	`¥ötk
(
KERN_INFO
 "Scanning %dáreas forÜow memory corruption\n",

107 
num_sˇn_¨ós
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_f‹_bios_c‹ru±i⁄
()

114 
i
;

115 
c‹ru±i⁄
 = 0;

117 i‡(!
mem‹y_c‹ru±i⁄_check
)

120 
i
 = 0; i < 
num_sˇn_¨ós
; i++) {

121 *
addr
 = 
	`__va
(
sˇn_¨ós
[
i
].addr);

122 
size
 = 
sˇn_¨ós
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 i‡(!*
addr
)

127 
	`¥ötk
(
KERN_ERR
 "CorruptedÜow memoryát %p (%lxÖhys) = %08lx\n",

128 
addr
, 
	`__∑
(addr), *addr);

129 
c‹ru±i⁄
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
c‹ru±i⁄
, 
KERN_ERR
 "Memory corruption detected inÜow memory\n");

135 
	}
}

137 
check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_w‹k
, 
check_c‹ru±i⁄
);

140 
	$check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
)

142 
	`check_f‹_bios_c‹ru±i⁄
();

143 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
,

144 
	`round_jiffõs_ªœtive
(
c‹ru±i⁄_check_≥riod
*
HZ
));

145 
	}
}

147 
	$°¨t_≥riodic_check_f‹_c‹ru±i⁄
()

149 i‡(!
mem‹y_c‹ru±i⁄_check
 || 
c‹ru±i⁄_check_≥riod
 == 0)

152 
	`¥ötk
(
KERN_INFO
 "Scanning forÜow memory corruptionÉvery %d seconds\n",

153 
c‹ru±i⁄_check_≥riod
);

156 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
, 0);

158 
	}
}

160 
moduÀ_öô
(
°¨t_≥riodic_check_f‹_c‹ru±i⁄
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<löux/˝u.h
>

7 
	~<asm/∑t.h
>

8 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/≠ic.h
>

12 
	s˝uid_bô
 {

13 
u16
 
	m„©uª
;

14 
u8
 
	mªg
;

15 
u8
 
	mbô
;

16 
u32
 
	mÀvñ
;

19 
	e˝uid_ªgs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__˝uöô
 
	$öô_sˇâîed_˝uid_„©uªs
(
˝uöfo_x86
 *
c
)

28 
u32
 
max_Àvñ
;

29 
u32
 
ªgs
[4];

30 c⁄° 
˝uid_bô
 *
cb
;

32 c⁄° 
˝uid_bô
 
__˝uöôc⁄°
 
˝uid_bôs
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

38 
cb
 = 
˝uid_bôs
; cb->
„©uª
; cb++) {

41 
max_Àvñ
 = 
	`˝uid_óx
(
cb
->
Àvñ
 & 0xffff0000);

42 i‡(
max_Àvñ
 < 
cb
->
Àvñ
 ||

43 
max_Àvñ
 > (
cb
->
Àvñ
 | 0xffff))

46 
	`˝uid
(
cb
->
Àvñ
, &
ªgs
[
CR_EAX
], &ªgs[
CR_EBX
],

47 &
ªgs
[
CR_ECX
], &ªgs[
CR_EDX
]);

49 i‡(
ªgs
[
cb
->
ªg
] & (1 << cb->
bô
))

50 
	`£t_˝u_ˇp
(
c
, 
cb
->
„©uª
);

52 
	}
}

55 
	#SMT_LEVEL
 0

	)

58 
	#INVALID_TYPE
 0

	)

59 
	#SMT_TYPE
 1

	)

60 
	#CORE_TYPE
 2

	)

62 
	#LEAFB_SUBTYPE
(
ecx
Ë((”cxË>> 8Ë& 0xff)

	)

63 
	#BITS_SHIFT_NEXT_LEVEL
(
óx
Ë(”axË& 0x1f)

	)

64 
	#LEVEL_MAX_SIBLINGS
(
ebx
Ë(”bxË& 0xffff)

	)

71 
__˝uöô
 
	$dëe˘_exãnded_t›ﬁogy
(
˝uöfo_x86
 *
c
)

73 #ifde‡
CONFIG_SMP


74 
óx
, 
ebx
, 
ecx
, 
edx
, 
sub_ödex
;

75 
ht_mask_width
, 
c‹e_∂us_mask_width
;

76 
c‹e_£À˘_mask
, 
c‹e_Àvñ_siblögs
;

78 i‡(
c
->
˝uid_Àvñ
 < 0xb)

81 
	`˝uid_cou¡
(0xb, 
SMT_LEVEL
, &
óx
, &
ebx
, &
ecx
, &
edx
);

86 i‡(
ebx
 =0 || (
	`LEAFB_SUBTYPE
(
ecx
Ë!
SMT_TYPE
))

89 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

94 
c
->
öôül_≠icid
 = 
edx
;

99 
c‹e_Àvñ_siblögs
 = 
smp_num_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

100 
c‹e_∂us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

102 
sub_ödex
 = 1;

104 
	`˝uid_cou¡
(0xb, 
sub_ödex
, &
óx
, &
ebx
, &
ecx
, &
edx
);

109 i‡(
	`LEAFB_SUBTYPE
(
ecx
Ë=
CORE_TYPE
) {

110 
c‹e_Àvñ_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

111 
c‹e_∂us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

115 
sub_ödex
++;

116 } 
	`LEAFB_SUBTYPE
(
ecx
Ë!
INVALID_TYPE
);

118 
c‹e_£À˘_mask
 = (~(-1 << 
c‹e_∂us_mask_width
)Ë>> 
ht_mask_width
;

120 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ht_mask_width
)

121 & 
c‹e_£À˘_mask
;

122 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
c‹e_∂us_mask_width
);

126 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

128 
c
->
x86_max_c‹es
 = (
c‹e_Àvñ_siblögs
 / 
smp_num_siblögs
);

131 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

132 
c
->
phys_¥oc_id
);

133 i‡(
c
->
x86_max_c‹es
 > 1)

134 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

135 
c
->
˝u_c‹e_id
);

138 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<löux/öô.h
>

2 
	~<löux/bô›s.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/io.h
>

6 
	~<asm/¥o˚ss‹.h
>

7 
	~<asm/≠ic.h
>

8 
	~<asm/˝u.h
>

9 
	~<asm/pci-dúe˘.h
>

11 #ifde‡
CONFIG_X86_64


12 
	~<asm/numa_64.h
>

13 
	~<asm/mmc⁄fig.h
>

14 
	~<asm/ˇcheÊush.h
>

17 
	~"˝u.h
"

19 #ifde‡
CONFIG_X86_32


33 
vide
();

34 
__asm__
(".align 4\nvide:Ñet");

36 
__˝uöô
 
	$öô_amd_k5
(
˝uöfo_x86
 *
c
)

44 
	#CBAR
 (0xfffcË

	)

45 
	#CBAR_ENB
 (0x80000000)

	)

46 
	#CBAR_KEY
 (0X000000CB)

	)

47 i‡(
c
->
x86_modñ
 == 9 || c->x86_model == 10) {

48 i‡(
	`öl
 (
CBAR
Ë& 
CBAR_ENB
)

49 
	`oué
 (0 | 
CBAR_KEY
, 
CBAR
);

51 
	}
}

54 
__˝uöô
 
	$öô_amd_k6
(
˝uöfo_x86
 *
c
)

56 
u32
 
l
, 
h
;

57 
mbyãs
 = 
num_phy•ages
 >> (20-
PAGE_SHIFT
);

59 i‡(
c
->
x86_modñ
 < 6) {

61 i‡(
c
->
x86_modñ
 == 0) {

62 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_APIC
);

63 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PGE
);

68 i‡(
c
->
x86_modñ
 =6 && c->
x86_mask
 == 1) {

69 c⁄° 
K6_BUG_LOOP
 = 1000000;

70 
n
;

71 (*
f_vide
)();

72 
d
, 
d2
;

74 
	`¥ötk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

81 
n
 = 
K6_BUG_LOOP
;

82 
f_vide
 = 
vide
;

83 
	`rdts˛
(
d
);

84 
n
--)

85 
	`f_vide
();

86 
	`rdts˛
(
d2
);

87 
d
 = 
d2
-d;

89 i‡(
d
 > 20*
K6_BUG_LOOP
)

90 
	`¥ötk
("system stability may be impaired when moreÅhan 32 MBáre used.\n");

92 
	`¥ötk
("probably OK (after B9730xxxx).\n");

93 
	`¥ötk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

97 i‡(
c
->
x86_modñ
 < 8 ||

98 (
c
->
x86_modñ
 =8 && c->
x86_mask
 < 8)) {

100 i‡(
mbyãs
 > 508)

101 
mbyãs
 = 508;

103 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

104 i‡((
l
&0x0000FFFF) == 0) {

105 
Êags
;

106 
l
 = (1<<0)|((
mbyãs
/4)<<1);

107 
	`loˇl_úq_ßve
(
Êags
);

108 
	`wbövd
();

109 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

110 
	`loˇl_úq_ª°‹e
(
Êags
);

111 
	`¥ötk
(
KERN_INFO
 "Enabling old style K6 writeállocation for %d Mb\n",

112 
mbyãs
);

117 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 > 7) ||

118 
c
->
x86_modñ
 == 9 || c->x86_model == 13) {

121 i‡(
mbyãs
 > 4092)

122 
mbyãs
 = 4092;

124 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

125 i‡((
l
&0xFFFF0000) == 0) {

126 
Êags
;

127 
l
 = ((
mbyãs
>>2)<<22)|(1<<16);

128 
	`loˇl_úq_ßve
(
Êags
);

129 
	`wbövd
();

130 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

131 
	`loˇl_úq_ª°‹e
(
Êags
);

132 
	`¥ötk
(
KERN_INFO
 "EnablingÇew style K6 writeállocation for %d Mb\n",

133 
mbyãs
);

139 i‡(
c
->
x86_modñ
 == 10) {

144 
	}
}

146 
__˝uöô
 
	$amd_k7_smp_check
(
˝uöfo_x86
 *
c
)

148 #ifde‡
CONFIG_SMP


150 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

158 i‡((
c
->
x86_modñ
 =6Ë&& ((c->
x86_mask
 == 0) ||

159 (
c
->
x86_mask
 == 1)))

160 
vÆid_k7
;

163 i‡((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 == 0))

164 
vÆid_k7
;

173 i‡(((
c
->
x86_modñ
 =6Ë&& (c->
x86_mask
 >= 2)) ||

174 ((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 >= 1)) ||

175 (
c
->
x86_modñ
 > 7))

176 i‡(
˝u_has_mp
)

177 
vÆid_k7
;

185 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

187 i‡(!
	`ã°_èöt
(
TAINT_UNSAFE_SMP
))

188 
	`add_èöt
(
TAINT_UNSAFE_SMP
);

190 
vÆid_k7
:

193 
	}
}

195 
__˝uöô
 
	$öô_amd_k7
(
˝uöfo_x86
 *
c
)

197 
u32
 
l
, 
h
;

204 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 10) {

205 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XMM
)) {

206 
	`¥ötk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

207 
	`rdm§
(
MSR_K7_HWCR
, 
l
, 
h
);

208 
l
 &= ~0x00008000;

209 
	`wrm§
(
MSR_K7_HWCR
, 
l
, 
h
);

210 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XMM
);

219 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

220 
	`rdm§
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

221 i‡((
l
 & 0xfff00000) != 0x20000000) {

222 
	`¥ötk
 ("CPU: CLK_CTL MSR wa†%x. RïrogømmögÅÿ%x\n", 
l
,

223 ((
l
 & 0x000fffff)|0x20000000));

224 
	`wrm§
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

228 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K7
);

230 
	`amd_k7_smp_check
(
c
);

231 
	}
}

234 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

235 
__˝uöô
 
	$√¨by_node
(
≠icid
)

237 
i
, 
node
;

239 
i
 = 
≠icid
 - 1; i >= 0; i--) {

240 
node
 = 
≠icid_to_node
[
i
];

241 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

242  
node
;

244 
i
 = 
≠icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

245 
node
 = 
≠icid_to_node
[
i
];

246 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

247  
node
;

249  
	`fú°_node
(
node_⁄löe_m≠
);

250 
	}
}

257 
__˝uöô
 
	$amd_dëe˘_cmp
(
˝uöfo_x86
 *
c
)

259 #ifde‡
CONFIG_X86_HT


260 
bôs
;

261 
˝u
 = 
	`smp_¥o˚ss‹_id
();

263 
bôs
 = 
c
->
x86_c‹eid_bôs
;

265 
c
->
˝u_c‹e_id
 = c->
öôül_≠icid
 & ((1 << 
bôs
)-1);

267 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
 >> 
bôs
;

269 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
c
->
phys_¥oc_id
;

271 
	}
}

273 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

275 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

276 
˝u
 = 
	`smp_¥o˚ss‹_id
();

277 
node
;

278 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

280 
node
 = 
c
->
phys_¥oc_id
;

281 i‡(
≠icid_to_node
[
≠icid
] !
NUMA_NO_NODE
)

282 
node
 = 
≠icid_to_node
[
≠icid
];

283 i‡(!
	`node_⁄löe
(
node
)) {

294 
ht_nodeid
 = 
c
->
öôül_≠icid
;

296 i‡(
ht_nodeid
 >= 0 &&

297 
≠icid_to_node
[
ht_nodeid
] !
NUMA_NO_NODE
)

298 
node
 = 
≠icid_to_node
[
ht_nodeid
];

300 i‡(!
	`node_⁄löe
(
node
))

301 
node
 = 
	`√¨by_node
(
≠icid
);

303 
	`numa_£t_node
(
˝u
, 
node
);

305 
	`¥ötk
(
KERN_INFO
 "CPU %d/0x%x -> Nodê%d\n", 
˝u
, 
≠icid
, 
node
);

307 
	}
}

309 
__˝uöô
 
	$óæy_öô_amd_mc
(
˝uöfo_x86
 *
c
)

311 #ifde‡
CONFIG_X86_HT


312 
bôs
, 
ecx
;

315 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000008)

318 
ecx
 = 
	`˝uid_ecx
(0x80000008);

320 
c
->
x86_max_c‹es
 = (
ecx
 & 0xff) + 1;

323 
bôs
 = (
ecx
 >> 12) & 0xF;

326 i‡(
bôs
 == 0) {

327 (1 << 
bôs
Ë< 
c
->
x86_max_c‹es
)

328 
bôs
++;

331 
c
->
x86_c‹eid_bôs
 = 
bôs
;

333 
	}
}

335 
__˝uöô
 
	$óæy_öô_amd
(
˝uöfo_x86
 *
c
)

337 
	`óæy_öô_amd_mc
(
c
);

343 i‡(
c
->
x86_powî
 & (1 << 8)) {

344 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

345 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

348 #ifde‡
CONFIG_X86_64


349 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSCALL32
);

352 i‡(
c
->
x86
 == 5)

353 i‡(
c
->
x86_modñ
 == 13 || c->x86_model == 9 ||

354 (
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 8))

355 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K6_MTRR
);

357 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_PCI
)

359 i‡(
˝u_has_≠ic
 && 
c
->
x86
 >= 0xf) {

360 
vÆ
;

361 
vÆ
 = 
	`ªad_pci_c⁄fig
(0, 24, 0, 0x68);

362 i‡((
vÆ
 & ((1 << 17) | (1 << 18))) == ((1 << 17) | (1 << 18)))

363 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EXTD_APICID
);

366 
	}
}

368 
__˝uöô
 
	$öô_amd
(
˝uöfo_x86
 *
c
)

370 #ifde‡
CONFIG_SMP


371 
vÆue
;

380 i‡(
c
->
x86
 == 0xf) {

381 
	`rdm§l
(
MSR_K7_HWCR
, 
vÆue
);

382 
vÆue
 |= 1 << 6;

383 
	`wrm§l
(
MSR_K7_HWCR
, 
vÆue
);

387 
	`óæy_öô_amd
(
c
);

393 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

395 #ifde‡
CONFIG_X86_64


397 i‡(
c
->
x86
 == 0xf) {

398 
u32
 
Àvñ
;

400 
Àvñ
 = 
	`˝uid_óx
(1);

401 if((
Àvñ
 >= 0x0f48 &&Üevel < 0x0f50) ||Üevel >= 0x0f58)

402 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

408 i‡(
c
->
x86_modñ
 < 0x14)

409 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_LAHF_LM
);

411 i‡(
c
->
x86
 == 0x10 || c->x86 == 0x11)

412 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

421 
c
->
x86
) {

423 
	`öô_amd_k5
(
c
);

426 
	`öô_amd_k6
(
c
);

429 
	`öô_amd_k7
(
c
);

434 i‡(
c
->
x86
 < 6)

435 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_MCE
);

439 i‡(
c
->
x86
 >= 6)

440 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

442 i‡(!
c
->
x86_modñ_id
[0]) {

443 
c
->
x86
) {

447 
	`°r˝y
(
c
->
x86_modñ_id
, "Hammer");

452 
	`di•œy_ˇcheöfo
(
c
);

455 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

456 
	`amd_dëe˘_cmp
(
c
);

457 
	`§©_dëe˘_node
(
c
);

460 #ifde‡
CONFIG_X86_32


461 
	`dëe˘_ht
(
c
);

464 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000006) {

465 i‡((
c
->
x86
 >0x0fË&& (
	`˝uid_edx
(0x80000006) & 0xf000))

466 
num_ˇche_Àaves
 = 4;

468 
num_ˇche_Àaves
 = 3;

471 i‡(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

472 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K8
);

474 i‡(
˝u_has_xmm2
) {

476 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

479 #ifde‡
CONFIG_X86_64


480 i‡(
c
->
x86
 == 0x10) {

482 i‡(
c
 =&
boŸ_˝u_d©a
)

483 
	`check_íabÀ_amd_mmc⁄f_dmi
();

485 
	`Ám10h_check_íabÀ_mmcfg
();

488 i‡(
c
 =&
boŸ_˝u_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

489 
t£g
;

496 i‡(!
	`rdm§l_ß„
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

497 
	`¥ötk
(
KERN_DEBUG
 "t£g: %010Œx\n", 
t£g
);

498 i‡((
t£g
>>
PMD_SHIFT
) <

499 (
max_low_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

500 ((
t£g
>>
PMD_SHIFT
) <

501 (
max_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

502 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

503 
	`£t_mem‹y_4k
(()
	`__va
(
t£g
), 1);

507 
	}
}

509 #ifde‡
CONFIG_X86_32


510 
__˝uöô
 
	$amd_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

513 i‡((
c
->
x86
 == 6)) {

514 i‡(
c
->
x86_modñ
 =3 && c->
x86_mask
 == 0)

515 
size
 = 64;

516 i‡(
c
->
x86_modñ
 == 4 &&

517 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

518 
size
 = 256;

520  
size
;

521 
	}
}

524 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gamd_˝u_dev
 = {

525 .
c_víd‹
 = "AMD",

526 .
	gc_idít
 = { "AuthenticAMD" },

527 #ifde‡
CONFIG_X86_32


528 .
	gc_modñs
 = {

529 { .
víd‹
 = 
X86_VENDOR_AMD
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

540 .
	gc_size_ˇche
 = 
amd_size_ˇche
,

542 .
	gc_óæy_öô
 = 
óæy_öô_amd
,

543 .
	gc_öô
 = 
öô_amd
,

544 .
	gc_x86_víd‹
 = 
X86_VENDOR_AMD
,

547 
˝u_dev_ªgi°î
(
amd_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

8 
	~<asm/Æã∫©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/mår.h
>

12 
	~<asm/ˇcheÊush.h
>

14 
__öô
 
	$check_bugs
()

16 
	`idítify_boŸ_˝u
();

17 #i‡!
	`deföed
(
CONFIG_SMP
)

18 
	`¥ötk
("CPU: ");

19 
	`¥öt_˝u_öfo
(&
boŸ_˝u_d©a
);

21 
	`Æã∫©ive_ö°ru˘i⁄s
();

31 i‡(!
dúe˘_gb∑ges
)

32 
	`£t_mem‹y_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/˝u„©uª.h
>

3 c⁄° * c⁄° 
	gx86_ˇp_Êags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_EXTD_APICID
] = "extd_apicid",

63 [
X86_FEATURE_XMM3
] = "pni",

64 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

65 [
X86_FEATURE_DTES64
] = "dtes64",

66 [
X86_FEATURE_MWAIT
] = "monitor",

67 [
X86_FEATURE_DSCPL
] = "ds_cpl",

68 [
X86_FEATURE_VMX
] = "vmx",

69 [
X86_FEATURE_SMX
] = "smx",

70 [
X86_FEATURE_EST
] = "est",

71 [
X86_FEATURE_TM2
] = "tm2",

72 [
X86_FEATURE_SSSE3
] = "ssse3",

73 [
X86_FEATURE_CID
] = "cid",

74 [
X86_FEATURE_FMA
] = "fma",

75 [
X86_FEATURE_CX16
] = "cx16",

76 [
X86_FEATURE_XTPR
] = "xtpr",

77 [
X86_FEATURE_PDCM
] = "pdcm",

78 [
X86_FEATURE_DCA
] = "dca",

79 [
X86_FEATURE_XMM4_1
] = "sse4_1",

80 [
X86_FEATURE_XMM4_2
] = "sse4_2",

81 [
X86_FEATURE_X2APIC
] = "x2apic",

82 [
X86_FEATURE_MOVBE
] = "movbe",

83 [
X86_FEATURE_POPCNT
] = "popcnt",

84 [
X86_FEATURE_AES
] = "aes",

85 [
X86_FEATURE_XSAVE
] = "xsave",

86 [
X86_FEATURE_AVX
] = "avx",

87 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

88 [
X86_FEATURE_XSTORE
] = "rng",

89 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

90 [
X86_FEATURE_XCRYPT
] = "ace",

91 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

92 [
X86_FEATURE_ACE2
] = "ace2",

93 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

94 [
X86_FEATURE_PHE
] = "phe",

95 [
X86_FEATURE_PHE_EN
] = "phe_en",

96 [
X86_FEATURE_PMM
] = "pmm",

97 [
X86_FEATURE_PMM_EN
] = "pmm_en",

98 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

99 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

100 [
X86_FEATURE_SVM
] = "svm",

101 [
X86_FEATURE_EXTAPIC
] = "extapic",

102 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

103 [
X86_FEATURE_ABM
] = "abm",

104 [
X86_FEATURE_SSE4A
] = "sse4a",

105 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

106 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

107 [
X86_FEATURE_OSVW
] = "osvw",

108 [
X86_FEATURE_IBS
] = "ibs",

109 [
X86_FEATURE_SSE5
] = "sse5",

110 [
X86_FEATURE_SKINIT
] = "skinit",

111 [
X86_FEATURE_WDT
] = "wdt",

112 [
X86_FEATURE_IDA
] = "ida",

113 [
X86_FEATURE_ARAT
] = "arat",

114 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

115 [
X86_FEATURE_VNMI
] = "vnmi",

116 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

117 [
X86_FEATURE_EPT
] = "ept",

118 [
X86_FEATURE_VPID
] = "vpid",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<löux/bô›s.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/¥o˚ss‹.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"˝u.h
"

12 #ifde‡
CONFIG_X86_OOSTORE


14 
u32
 
__˝uöô
 
	$powî2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__˝uöô
 
	$˚¡aur_m¸_ö£π
(
ªg
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |
key
;

36 
	`wrm§
(
ªg
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mår_˚¡aur_ªp‹t_m¸
(
ªg
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__˝uöô
 
	$ømt›
()

47 
u32
 
˛ù
 = 0xFFFFFFFFUL;

48 
u32
 
t›
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 
°¨t
, 
íd
;

54 i‡(
e820
.
m≠
[
i
].
addr
 > 0xFFFFFFFFUL)

60 i‡(
e820
.
m≠
[
i
].
ty≥
 =
E820_RESERVED
) {

61 i‡(
e820
.
m≠
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m≠
[
i
].
addr
 < 
˛ù
)

63 
˛ù
 = 
e820
.
m≠
[
i
].
addr
;

66 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

67 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
;

68 i‡(
°¨t
 >
íd
)

70 i‡(
íd
 > 
t›
)

71 
t›
 = 
íd
;

85 i‡(
t›
 > 
˛ù
)

86 
t›
 = 
˛ù
;

88  
t›
;

89 
	}
}

94 
__˝uöô
 
	$˚¡aur_m¸_compuã
(
ƒ
, 
key
)

96 
u32
 
mem
 = 
	`ømt›
();

97 
u32
 
roŸ
 = 
	`powî2
(
mem
);

98 
u32
 
ba£
 = 
roŸ
;

99 
u32
 
t›
 = 
roŸ
;

100 
u32
 
Êo‹
 = 0;

101 
˘
 = 0;

103 
˘
 < 
ƒ
) {

104 
u32
 
f•a˚
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`powî2
(
mem
-
t›
);

116 
low
 = 
ba£
/2;

122 i‡(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 i‡(
Êo‹
 == 0)

131 
f•a˚
 = 512*1024;

132 i‡(
Êo‹
 == 512*1024)

133 
f•a˚
 = 128*1024;

140 i‡(
f•a˚
 > 
high
 && f•a˚ > 
low
) {

141 
	`˚¡aur_m¸_ö£π
(
˘
, 
Êo‹
, 
f•a˚
, 
key
);

142 
Êo‹
 +
f•a˚
;

143 } i‡(
high
 > 
low
) {

144 
	`˚¡aur_m¸_ö£π
(
˘
, 
t›
, 
high
, 
key
);

145 
t›
 +
high
;

146 } i‡(
low
 > 0) {

147 
ba£
 -
low
;

148 
	`˚¡aur_m¸_ö£π
(
˘
, 
ba£
, 
low
, 
key
);

151 
˘
++;

157  
˘
;

158 
	}
}

160 
__˝uöô
 
	$˚¡aur_¸óã_›timÆ_m¸
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__˝uöô
 
	$wöchù2_¸óã_›timÆ_m¸
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 25);

204 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |1<<(9+
i
);

207 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__˝uöô
 
	$wöchù2_u≈rŸe˘_m¸
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |
key
<<6;

229 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__˝uöô
 
	$wöchù2_¥Ÿe˘_m¸
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28Ë

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6Ë

	)

250 
__˝uöô
 
	$öô_c3
(
˝uöfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 i‡(
	`˝uid_óx
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`˝uid_edx
(0xC0000001);

259 i‡((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |
ACE_FCR
;

262 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 i‡((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |
RNG_ENABLE
;

270 
	`wrm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ˇ∑bûôy
[5] = 
	`˝uid_edx
(0xC0000001);

279 #ifde‡
CONFIG_X86_32


281 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 9) {

282 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

289 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model < 9)

290 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

292 i‡(
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0xf) {

293 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

294 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`di•œy_ˇcheöfo
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__˝uöô
 
	$óæy_öô_˚¡aur
(
˝uöfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifde‡
CONFIG_X86_32


327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 i‡(
c
->
x86_modñ
 >= 0xf)

332 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifde‡
CONFIG_X86_64


336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__˝uöô
 
	$öô_˚¡aur
(
˝uöfo_x86
 *
c
)

342 #ifde‡
CONFIG_X86_32


343 *
«me
;

344 
u32
 
f¸_£t
 = 0;

345 
u32
 
f¸_˛r
 = 0;

346 
u32
 
lo
, 
hi
, 
√wlo
;

347 
u32
 
Ø
, 
bb
, 
cc
, 
dd
;

353 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

355 
	`óæy_öô_˚¡aur
(
c
);

356 
c
->
x86
) {

357 #ifde‡
CONFIG_X86_32


359 
c
->
x86_modñ
) {

361 
«me
 = "C6";

362 
f¸_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
f¸_˛r
 = 
DPDC
;

364 
	`¥ötk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TSC
);

366 #ifde‡
CONFIG_X86_OOSTORE


367 
	`˚¡aur_¸óã_›timÆ_m¸
();

378 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
«me
 = "2";

387 
«me
 = "2A";

390 
«me
 = "2B";

393 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
f¸_˛r
 = 
DPDC
;

396 #ifde‡
CONFIG_X86_OOSTORE


397 
	`wöchù2_u≈rŸe˘_m¸
();

398 
	`wöchù2_¸óã_›timÆ_m¸
();

399 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wöchù2_¥Ÿe˘_m¸
();

412 
«me
 = "3";

413 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
f¸_˛r
 = 
DPDC
;

416 #ifde‡
CONFIG_X86_OOSTORE


417 
	`wöchù2_u≈rŸe˘_m¸
();

418 
	`wöchù2_¸óã_›timÆ_m¸
();

419 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wöchù2_¥Ÿe˘_m¸
();

432 
«me
 = "??";

435 
	`rdm§
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
√wlo
 = (
lo
|
f¸_£t
Ë& (~
f¸_˛r
);

438 i‡(
√wlo
 !
lo
) {

439 
	`¥ötk
(
KERN_INFO
 "Centaur FCR was 0x%XÇow 0x%X\n",

440 
lo
, 
√wlo
);

441 
	`wrm§
(
MSR_IDT_FCR1
, 
√wlo
, 
hi
);

443 
	`¥ötk
(
KERN_INFO
 "Cíèu∏FCR i†0x%X\n", 
lo
);

446 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

450 i‡(
c
->
x86_modñ
 >= 8)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

453 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000005) {

455 
	`˝uid
(0x80000005, &
Ø
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ˇche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`•rötf
(
c
->
x86_modñ_id
, "WöChù %s", 
«me
);

463 
	`öô_c3
(
c
);

466 #ifde‡
CONFIG_X86_64


467 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__˝uöô


472 
	$˚¡aur_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

474 #ifde‡
CONFIG_X86_32


476 i‡((
c
->
x86
 =6Ë&& ((c->
x86_modñ
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 == 9) &&

485 (
c
->
x86_mask
 =1Ë&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	g˚¡aur_˝u_dev
 = {

492 .
c_víd‹
 = "Centaur",

493 .
	gc_idít
 = { "CentaurHauls" },

494 .
	gc_óæy_öô
 = 
óæy_öô_˚¡aur
,

495 .
	gc_öô
 = 
öô_˚¡aur
,

496 .
	gc_size_ˇche
 = 
˚¡aur_size_ˇche
,

497 .
	gc_x86_víd‹
 = 
X86_VENDOR_CENTAUR
,

500 
˝u_dev_ªgi°î
(
˚¡aur_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<löux/boŸmem.h
>

2 
	~<löux/lökage.h
>

3 
	~<löux/bô›s.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/≥r˝u.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kgdb.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/io.h
>

15 
	~<asm/°ack¥Ÿe˘‹.h
>

16 
	~<asm/≥rf_cou¡î.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/hy≥rvis‹.h
>

19 
	~<asm/¥o˚ss‹.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<asm/t›ﬁogy.h
>

22 
	~<asm/˝umask.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/≠ic.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/mår.h
>

31 
	~<asm/numa.h
>

32 
	~<asm/asm.h
>

33 
	~<asm/˝u.h
>

34 
	~<asm/m˚.h
>

35 
	~<asm/m§.h
>

36 
	~<asm/∑t.h
>

37 
	~<asm/smp.h
>

39 #ifde‡
CONFIG_X86_LOCAL_APIC


40 
	~<asm/uv/uv.h
>

43 
	~"˝u.h
"

46 
˝umask_v¨_t
 
	g˝u_öôülized_mask
;

47 
˝umask_v¨_t
 
	g˝u_ˇŒout_mask
;

48 
˝umask_v¨_t
 
	g˝u_ˇŒö_mask
;

51 
˝umask_v¨_t
 
	g˝u_siblög_£tup_mask
;

54 
__öô
 
	$£tup_˝u_loˇl_masks
()

56 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_öôülized_mask
);

57 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒö_mask
);

58 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒout_mask
);

59 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_siblög_£tup_mask
);

60 
	}
}

62 
__˝uöô
 
	$deÁu…_öô
(
˝uöfo_x86
 *
c
)

64 #ifde‡
CONFIG_X86_64


65 
	`di•œy_ˇcheöfo
(
c
);

69 i‡(
c
->
˝uid_Àvñ
 == -1) {

71 i‡(
c
->
x86
 == 4)

72 
	`°r˝y
(
c
->
x86_modñ_id
, "486");

73 i‡(
c
->
x86
 == 3)

74 
	`°r˝y
(
c
->
x86_modñ_id
, "386");

77 
	}
}

79 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gdeÁu…_˝u
 = {

80 .
c_öô
 = 
deÁu…_öô
,

81 .
	gc_víd‹
 = "Unknown",

82 .
	gc_x86_víd‹
 = 
X86_VENDOR_UNKNOWN
,

85 c⁄° 
˝u_dev
 *
this_˝u
 
	g__˝uöôd©a
 = &
deÁu…_˝u
;

87 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_∑ge
, gdt_∑geË{ .
gdt
 = {

88 #ifde‡
CONFIG_X86_64


97 [
GDT_ENTRY_KERNEL32_CS
] = { { { 0x0000ffff, 0x00cf9b00 } } },

98 [
GDT_ENTRY_KERNEL_CS
] = { { { 0x0000ffff, 0x00af9b00 } } },

99 [
GDT_ENTRY_KERNEL_DS
] = { { { 0x0000ffff, 0x00cf9300 } } },

100 [
GDT_ENTRY_DEFAULT_USER32_CS
] = { { { 0x0000ffff, 0x00cffb00 } } },

101 [
GDT_ENTRY_DEFAULT_USER_DS
] = { { { 0x0000ffff, 0x00cff300 } } },

102 [
GDT_ENTRY_DEFAULT_USER_CS
] = { { { 0x0000ffff, 0x00affb00 } } },

104 [
GDT_ENTRY_KERNEL_CS
] = { { { 0x0000ffff, 0x00cf9a00 } } },

105 [
GDT_ENTRY_KERNEL_DS
] = { { { 0x0000ffff, 0x00cf9200 } } },

106 [
GDT_ENTRY_DEFAULT_USER_CS
] = { { { 0x0000ffff, 0x00cffa00 } } },

107 [
GDT_ENTRY_DEFAULT_USER_DS
] = { { { 0x0000ffff, 0x00cff200 } } },

114 [
GDT_ENTRY_PNPBIOS_CS32
] = { { { 0x0000ffff, 0x00409a00 } } },

116 [
GDT_ENTRY_PNPBIOS_CS16
] = { { { 0x0000ffff, 0x00009a00 } } },

118 [
GDT_ENTRY_PNPBIOS_DS
] = { { { 0x0000ffff, 0x00009200 } } },

120 [
GDT_ENTRY_PNPBIOS_TS1
] = { { { 0x00000000, 0x00009200 } } },

122 [
GDT_ENTRY_PNPBIOS_TS2
] = { { { 0x00000000, 0x00009200 } } },

128 [
GDT_ENTRY_APMBIOS_BASE
] = { { { 0x0000ffff, 0x00409a00 } } },

130 [
GDT_ENTRY_APMBIOS_BASE
+1] = { { { 0x0000ffff, 0x00009a00 } } },

132 [
GDT_ENTRY_APMBIOS_BASE
+2] = { { { 0x0000ffff, 0x00409200 } } },

134 [
GDT_ENTRY_ESPFIX_SS
] = { { { 0x0000ffff, 0x00cf9200 } } },

135 [
GDT_ENTRY_PERCPU
] = { { { 0x0000ffff, 0x00cf9200 } } },

136 
	gGDT_STACK_CANARY_INIT


139 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_∑ge
);

141 
__öô
 
	$x86_xßve_£tup
(*
s
)

143 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XSAVE
);

145 
	}
}

146 
__£tup
("noxßve", 
x86_xßve_£tup
);

148 #ifde‡
CONFIG_X86_32


149 
ˇchesize_ovîride
 
	g__˝uöôd©a
 = -1;

150 
dißbÀ_x86_£rül_ƒ
 
	g__˝uöôd©a
 = 1;

152 
__öô
 
	$ˇchesize_£tup
(*
°r
)

154 
	`gë_›ti⁄
(&
°r
, &
ˇchesize_ovîride
);

156 
	}
}

157 
__£tup
("ˇchesize=", 
ˇchesize_£tup
);

159 
__öô
 
	$x86_fx§_£tup
(*
s
)

161 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_FXSR
);

162 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XMM
);

164 
	}
}

165 
__£tup
("nofx§", 
x86_fx§_£tup
);

167 
__öô
 
	$x86_£p_£tup
(*
s
)

169 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_SEP
);

171 
	}
}

172 
__£tup
("no£p", 
x86_£p_£tup
);

175 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

177 
u32
 
f1
, 
f2
;

186 
asm
 volatile ("pushfl \n\t"

197 : "=&r" (
f1
), "=&r" (
f2
)

198 : "ú" (
Êag
));

200  ((
f1
^
f2
Ë& 
Êag
) != 0;

201 
	}
}

204 
__˝uöô
 
	$have_˝uid_p
()

206  
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_ID
);

207 
	}
}

209 
__˝uöô
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

211 
lo
, 
hi
;

213 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_PN
Ë|| !
dißbÀ_x86_£rül_ƒ
)

218 
	`rdm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

219 
lo
 |= 0x200000;

220 
	`wrm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

222 
	`¥ötk
(
KERN_NOTICE
 "CPU serialÇumber disabled.\n");

223 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PN
);

226 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

227 
	}
}

229 
__öô
 
	$x86_£rül_ƒ_£tup
(*
s
)

231 
dißbÀ_x86_£rül_ƒ
 = 0;

233 
	}
}

234 
__£tup
("£rü umbî", 
x86_£rül_ƒ_£tup
);

236 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

239 
	}
}

241 
ölöe
 
	$have_˝uid_p
()

244 
	}
}

245 
ölöe
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

247 
	}
}

255 
	s˝uid_dïídít_„©uª
 {

256 
u32
 
	m„©uª
;

257 
u32
 
	mÀvñ
;

260 c⁄° 
˝uid_dïídít_„©uª
 
__˝uöôc⁄°


261 
	g˝uid_dïídít_„©uªs
[] = {

262 { 
X86_FEATURE_MWAIT
, 0x00000005 },

263 { 
X86_FEATURE_DCA
, 0x00000009 },

264 { 
X86_FEATURE_XSAVE
, 0x0000000d },

268 
__˝uöô
 
	$fûãr_˝uid_„©uªs
(
˝uöfo_x86
 *
c
, 
boﬁ
 
w¨n
)

270 c⁄° 
˝uid_dïídít_„©uª
 *
df
;

272 
df
 = 
˝uid_dïídít_„©uªs
; df->
„©uª
; df++) {

274 i‡(!
	`˝u_has
(
c
, 
df
->
„©uª
))

283 i‡(!((
s32
)
df
->
Àvñ
 < 0 ?

284 (
u32
)
df
->
Àvñ
 > (u32)
c
->
exãnded_˝uid_Àvñ
 :

285 (
s32
)
df
->
Àvñ
 > (s32)
c
->
˝uid_Àvñ
))

288 
	`˛ór_˝u_ˇp
(
c
, 
df
->
„©uª
);

289 i‡(!
w¨n
)

292 
	`¥ötk
(
KERN_WARNING


294 
x86_ˇp_Êags
[
df
->
„©uª
], df->
Àvñ
);

296 
	}
}

306 c⁄° *
__˝uöô
 
	$èbÀ_lookup_modñ
(
˝uöfo_x86
 *
c
)

308 c⁄° 
˝u_modñ_öfo
 *
öfo
;

310 i‡(
c
->
x86_modñ
 >= 16)

311  
NULL
;

313 i‡(!
this_˝u
)

314  
NULL
;

316 
öfo
 = 
this_˝u
->
c_modñs
;

318 
öfo
 && info->
Ámûy
) {

319 i‡(
öfo
->
Ámûy
 =
c
->
x86
)

320  
öfo
->
modñ_«mes
[
c
->
x86_modñ
];

321 
öfo
++;

323  
NULL
;

324 
	}
}

326 
__u32
 
	g˝u_ˇps_˛óªd
[
NCAPINTS
] 
	g__˝uöôd©a
;

327 
__u32
 
	g˝u_ˇps_£t
[
NCAPINTS
] 
	g__˝uöôd©a
;

329 
	$lﬂd_≥r˝u_£gmít
(
˝u
)

331 #ifde‡
CONFIG_X86_32


332 
	`lﬂd£gmít
(
fs
, 
__KERNEL_PERCPU
);

334 
	`lﬂd£gmít
(
gs
, 0);

335 
	`wrm§l
(
MSR_GS_BASE
, ()
	`≥r_˝u
(
úq_°ack_uni⁄
.
gs_ba£
, 
˝u
));

337 
	`lﬂd_°ack_ˇ«ry_£gmít
();

338 
	}
}

344 
	$swôch_to_√w_gdt
(
˝u
)

346 
desc_±r
 
gdt_des¸
;

348 
gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

349 
gdt_des¸
.
size
 = 
GDT_SIZE
 - 1;

350 
	`lﬂd_gdt
(&
gdt_des¸
);

353 
	`lﬂd_≥r˝u_£gmít
(
˝u
);

354 
	}
}

356 c⁄° 
˝u_dev
 *
__˝uöôd©a
 
	g˝u_devs
[
X86_VENDOR_NUM
] = {};

358 
__˝uöô
 
	$gë_modñ_«me
(
˝uöfo_x86
 *
c
)

360 *
v
;

361 *
p
, *
q
;

363 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000004)

366 
v
 = (*)
c
->
x86_modñ_id
;

367 
	`˝uid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

368 
	`˝uid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

369 
	`˝uid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

370 
c
->
x86_modñ_id
[48] = 0;

376 
p
 = 
q
 = &
c
->
x86_modñ_id
[0];

377 *
p
 == ' ')

378 
p
++;

379 i‡(
p
 !
q
) {

380 *
p
)

381 *
q
++ = *
p
++;

382 
q
 <&
c
->
x86_modñ_id
[48])

383 *
q
++ = '\0';

385 
	}
}

387 
__˝uöô
 
	$di•œy_ˇcheöfo
(
˝uöfo_x86
 *
c
)

389 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

391 
n
 = 
c
->
exãnded_˝uid_Àvñ
;

393 i‡(
n
 >= 0x80000005) {

394 
	`˝uid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

395 
	`¥ötk
(
KERN_INFO
 "CPU: L1 I Cache: %dK (%d bytes/line), D cache %dK (%d bytes/line)\n",

396 
edx
>>24,Édx&0xFF, 
ecx
>>24,Écx&0xFF);

397 
c
->
x86_ˇche_size
 = (
ecx
>>24Ë+ (
edx
>>24);

398 #ifde‡
CONFIG_X86_64


400 
c
->
x86_ébsize
 = 0;

404 i‡(
n
 < 0x80000006)

407 
	`˝uid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

408 
l2size
 = 
ecx
 >> 16;

410 #ifde‡
CONFIG_X86_64


411 
c
->
x86_ébsize
 +((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

414 i‡(
this_˝u
->
c_size_ˇche
)

415 
l2size
 = 
this_˝u
->
	`c_size_ˇche
(
c
,Ü2size);

418 i‡(
ˇchesize_ovîride
 != -1)

419 
l2size
 = 
ˇchesize_ovîride
;

421 i‡(
l2size
 == 0)

425 
c
->
x86_ˇche_size
 = 
l2size
;

427 
	`¥ötk
(
KERN_INFO
 "CPU: L2 Cache: %dK (%d bytes/line)\n",

428 
l2size
, 
ecx
 & 0xFF);

429 
	}
}

431 
__˝uöô
 
	$dëe˘_ht
(
˝uöfo_x86
 *
c
)

433 #ifde‡
CONFIG_X86_HT


434 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

435 
ödex_msb
, 
c‹e_bôs
;

437 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_HT
))

440 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

441 
out
;

443 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

446 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
edx
);

448 
smp_num_siblögs
 = (
ebx
 & 0xff0000) >> 16;

450 i‡(
smp_num_siblögs
 == 1) {

451 
	`¥ötk
(
KERN_INFO
 "CPU: Hyper-Threading is disabled\n");

452 
out
;

455 i‡(
smp_num_siblögs
 <= 1)

456 
out
;

458 i‡(
smp_num_siblögs
 > 
ƒ_˝u_ids
) {

459 
	`¥_w¨nög
("CPU: UnsupportedÇumber of siblings %d",

460 
smp_num_siblögs
);

461 
smp_num_siblögs
 = 1;

465 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

466 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
);

468 
smp_num_siblögs
 = smp_num_siblög†/ 
c
->
x86_max_c‹es
;

470 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

472 
c‹e_bôs
 = 
	`gë_cou¡_‹dî
(
c
->
x86_max_c‹es
);

474 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
) &

475 ((1 << 
c‹e_bôs
) - 1);

477 
out
:

478 i‡((
c
->
x86_max_c‹es
 * 
smp_num_siblögs
) > 1) {

479 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

480 
c
->
phys_¥oc_id
);

481 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

482 
c
->
˝u_c‹e_id
);

485 
	}
}

487 
__˝uöô
 
	$gë_˝u_víd‹
(
˝uöfo_x86
 *
c
)

489 *
v
 = 
c
->
x86_víd‹_id
;

490 
i
;

492 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

493 i‡(!
˝u_devs
[
i
])

496 i‡(!
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[0]) ||

497 (
˝u_devs
[
i
]->
c_idít
[1] &&

498 !
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[1]))) {

500 
this_˝u
 = 
˝u_devs
[
i
];

501 
c
->
x86_víd‹
 = 
this_˝u
->
c_x86_víd‹
;

506 
	`¥ötk_⁄˚
(
KERN_ERR


508 "CPU: You∏sy°em may bêun°abÀ.\n", 
v
);

510 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

511 
this_˝u
 = &
deÁu…_˝u
;

512 
	}
}

514 
__˝uöô
 
	$˝u_dëe˘
(
˝uöfo_x86
 *
c
)

517 
	`˝uid
(0x00000000, (*)&
c
->
˝uid_Àvñ
,

518 (*)&
c
->
x86_víd‹_id
[0],

519 (*)&
c
->
x86_víd‹_id
[8],

520 (*)&
c
->
x86_víd‹_id
[4]);

522 
c
->
x86
 = 4;

524 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

525 
u32
 
junk
, 
tfms
, 
ˇp0
, 
misc
;

527 
	`˝uid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ˇp0
);

528 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

529 
c
->
x86_modñ
 = (
tfms
 >> 4) & 0xf;

530 
c
->
x86_mask
 = 
tfms
 & 0xf;

532 i‡(
c
->
x86
 == 0xf)

533 
c
->
x86
 +(
tfms
 >> 20) & 0xff;

534 i‡(
c
->
x86
 >= 0x6)

535 
c
->
x86_modñ
 +((
tfms
 >> 16) & 0xf) << 4;

537 i‡(
ˇp0
 & (1<<19)) {

538 
c
->
x86_˛Êush_size
 = ((
misc
 >> 8) & 0xff) * 8;

539 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

542 
	}
}

544 
__˝uöô
 
	$gë_˝u_ˇp
(
˝uöfo_x86
 *
c
)

546 
u32
 
tfms
, 
xlvl
;

547 
u32
 
ebx
;

550 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

551 
u32
 
ˇ∑bûôy
, 
exˇp
;

553 
	`˝uid
(0x00000001, &
tfms
, &
ebx
, &
exˇp
, &
ˇ∑bûôy
);

554 
c
->
x86_ˇ∑bûôy
[0] = 
ˇ∑bûôy
;

555 
c
->
x86_ˇ∑bûôy
[4] = 
exˇp
;

559 
xlvl
 = 
	`˝uid_óx
(0x80000000);

560 
c
->
exãnded_˝uid_Àvñ
 = 
xlvl
;

562 i‡((
xlvl
 & 0xffff0000) == 0x80000000) {

563 i‡(
xlvl
 >= 0x80000001) {

564 
c
->
x86_ˇ∑bûôy
[1] = 
	`˝uid_edx
(0x80000001);

565 
c
->
x86_ˇ∑bûôy
[6] = 
	`˝uid_ecx
(0x80000001);

569 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

570 
u32
 
óx
 = 
	`˝uid_óx
(0x80000008);

572 
c
->
x86_vút_bôs
 = (
óx
 >> 8) & 0xff;

573 
c
->
x86_phys_bôs
 = 
óx
 & 0xff;

575 #ifde‡
CONFIG_X86_32


576 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_PAE
Ë|| cpu_has(c, 
X86_FEATURE_PSE36
))

577 
c
->
x86_phys_bôs
 = 36;

580 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000007)

581 
c
->
x86_powî
 = 
	`˝uid_edx
(0x80000007);

583 
	}
}

585 
__˝uöô
 
	$idítify_˝u_wôhout_˝uid
(
˝uöfo_x86
 *
c
)

587 #ifde‡
CONFIG_X86_32


588 
i
;

594 i‡(
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_AC
))

595 
c
->
x86
 = 4;

597 
c
->
x86
 = 3;

599 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

600 i‡(
˝u_devs
[
i
] && cpu_devs[i]->
c_idítify
) {

601 
c
->
x86_víd‹_id
[0] = 0;

602 
˝u_devs
[
i
]->
	`c_idítify
(
c
);

603 i‡(
c
->
x86_víd‹_id
[0]) {

604 
	`gë_˝u_víd‹
(
c
);

609 
	}
}

620 
__öô
 
	$óæy_idítify_˝u
(
˝uöfo_x86
 *
c
)

622 #ifde‡
CONFIG_X86_64


623 
c
->
x86_˛Êush_size
 = 64;

624 
c
->
x86_phys_bôs
 = 36;

625 
c
->
x86_vút_bôs
 = 48;

627 
c
->
x86_˛Êush_size
 = 32;

628 
c
->
x86_phys_bôs
 = 32;

629 
c
->
x86_vút_bôs
 = 32;

631 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

633 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

634 
c
->
exãnded_˝uid_Àvñ
 = 0;

636 i‡(!
	`have_˝uid_p
())

637 
	`idítify_˝u_wôhout_˝uid
(
c
);

640 i‡(!
	`have_˝uid_p
())

643 
	`˝u_dëe˘
(
c
);

645 
	`gë_˝u_víd‹
(
c
);

647 
	`gë_˝u_ˇp
(
c
);

649 i‡(
this_˝u
->
c_óæy_öô
)

650 
this_˝u
->
	`c_óæy_öô
(
c
);

652 #ifde‡
CONFIG_SMP


653 
c
->
˝u_ödex
 = 
boŸ_˝u_id
;

655 
	`fûãr_˝uid_„©uªs
(
c
, 
Ál£
);

656 
	}
}

658 
__öô
 
	$óæy_˝u_öô
()

660 c⁄° 
˝u_dev
 *c⁄° *
cdev
;

661 
cou¡
 = 0;

663 
	`¥ötk
(
KERN_INFO
 "KERNEL supported cpus:\n");

664 
cdev
 = 
__x86_˝u_dev_°¨t
; cdev < 
__x86_˝u_dev_íd
; cdev++) {

665 c⁄° 
˝u_dev
 *
˝udev
 = *
cdev
;

666 
j
;

668 i‡(
cou¡
 >
X86_VENDOR_NUM
)

670 
˝u_devs
[
cou¡
] = 
˝udev
;

671 
cou¡
++;

673 
j
 = 0; j < 2; j++) {

674 i‡(!
˝udev
->
c_idít
[
j
])

676 
	`¥ötk
(
KERN_INFO
 " %†%s\n", 
˝udev
->
c_víd‹
,

677 
˝udev
->
c_idít
[
j
]);

681 
	`óæy_idítify_˝u
(&
boŸ_˝u_d©a
);

682 
	}
}

692 
__˝uöô
 
	$dëe˘_n›l
(
˝uöfo_x86
 *
c
)

694 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_NOPL
);

695 
	}
}

697 
__˝uöô
 
	$gíîic_idítify
(
˝uöfo_x86
 *
c
)

699 
c
->
exãnded_˝uid_Àvñ
 = 0;

701 i‡(!
	`have_˝uid_p
())

702 
	`idítify_˝u_wôhout_˝uid
(
c
);

705 i‡(!
	`have_˝uid_p
())

708 
	`˝u_dëe˘
(
c
);

710 
	`gë_˝u_víd‹
(
c
);

712 
	`gë_˝u_ˇp
(
c
);

714 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

715 
c
->
öôül_≠icid
 = (
	`˝uid_ebx
(1) >> 24) & 0xFF;

716 #ifde‡
CONFIG_X86_32


717 #ifde‡
CONFIG_X86_HT


718 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

720 
c
->
≠icid
 = c->
öôül_≠icid
;

724 #ifde‡
CONFIG_X86_HT


725 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
;

729 
	`gë_modñ_«me
(
c
);

731 
	`öô_sˇâîed_˝uid_„©uªs
(
c
);

732 
	`dëe˘_n›l
(
c
);

733 
	}
}

738 
__˝uöô
 
	$idítify_˝u
(
˝uöfo_x86
 *
c
)

740 
i
;

742 
c
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

743 
c
->
x86_ˇche_size
 = -1;

744 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

745 
c
->
x86_modñ
 = c->
x86_mask
 = 0;

746 
c
->
x86_víd‹_id
[0] = '\0';

747 
c
->
x86_modñ_id
[0] = '\0';

748 
c
->
x86_max_c‹es
 = 1;

749 
c
->
x86_c‹eid_bôs
 = 0;

750 #ifde‡
CONFIG_X86_64


751 
c
->
x86_˛Êush_size
 = 64;

752 
c
->
x86_phys_bôs
 = 36;

753 
c
->
x86_vút_bôs
 = 48;

755 
c
->
˝uid_Àvñ
 = -1;

756 
c
->
x86_˛Êush_size
 = 32;

757 
c
->
x86_phys_bôs
 = 32;

758 
c
->
x86_vút_bôs
 = 32;

760 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

761 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

763 
	`gíîic_idítify
(
c
);

765 i‡(
this_˝u
->
c_idítify
)

766 
this_˝u
->
	`c_idítify
(
c
);

769 
i
 = 0; i < 
NCAPINTS
; i++) {

770 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

771 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

774 #ifde‡
CONFIG_X86_64


775 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

788 i‡(
this_˝u
->
c_öô
)

789 
this_˝u
->
	`c_öô
(
c
);

792 
	`squash_the_°upid_£rül_numbî
(
c
);

800 
	`fûãr_˝uid_„©uªs
(
c
, 
åue
);

803 i‡(!
c
->
x86_modñ_id
[0]) {

804 c⁄° *
p
;

805 
p
 = 
	`èbÀ_lookup_modñ
(
c
);

806 i‡(
p
)

807 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

810 
	`•rötf
(
c
->
x86_modñ_id
, "%02x/%02x",

811 
c
->
x86
, c->
x86_modñ
);

814 #ifde‡
CONFIG_X86_64


815 
	`dëe˘_ht
(
c
);

818 
	`öô_hy≥rvis‹
(
c
);

824 
i
 = 0; i < 
NCAPINTS
; i++) {

825 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

826 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

835 i‡(
c
 !&
boŸ_˝u_d©a
) {

837 
i
 = 0; i < 
NCAPINTS
; i++)

838 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[
i
] &
c
->x86_capability[i];

841 #ifde‡
CONFIG_X86_MCE


843 
	`mcheck_öô
(
c
);

846 
	`£À˘_idÀ_routöe
(
c
);

848 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

849 
	`numa_add_˝u
(
	`smp_¥o˚ss‹_id
());

851 
	}
}

853 #ifde‡
CONFIG_X86_64


854 
	$vgë˝u_£t_mode
()

856 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_RDTSCP
))

857 
vgë˝u_mode
 = 
VGETCPU_RDTSCP
;

859 
vgë˝u_mode
 = 
VGETCPU_LSL
;

860 
	}
}

863 
__öô
 
	$idítify_boŸ_˝u
()

865 
	`idítify_˝u
(&
boŸ_˝u_d©a
);

866 
	`öô_c1e_mask
();

867 #ifde‡
CONFIG_X86_32


868 
	`sy£¡î_£tup
();

869 
	`íabÀ_£p_˝u
();

871 
	`vgë˝u_£t_mode
();

873 
	`öô_hw_≥rf_cou¡îs
();

874 
	}
}

876 
__˝uöô
 
	$idítify_£c⁄d¨y_˝u
(
˝uöfo_x86
 *
c
)

878 
	`BUG_ON
(
c
 =&
boŸ_˝u_d©a
);

879 
	`idítify_˝u
(
c
);

880 #ifde‡
CONFIG_X86_32


881 
	`íabÀ_£p_˝u
();

883 
	`mår_≠_öô
();

884 
	}
}

886 
	sm§_ønge
 {

887 
	mmö
;

888 
	mmax
;

891 c⁄° 
m§_ønge
 
	gm§_ønge_¨øy
[] 
	g__˝uöôc⁄°
 = {

898 
__˝uöô
 
	$¥öt_˝u_m§
()

900 
ödex_mö
, 
ödex_max
;

901 
ödex
;

902 
u64
 
vÆ
;

903 
i
;

905 
i
 = 0; i < 
	`ARRAY_SIZE
(
m§_ønge_¨øy
); i++) {

906 
ödex_mö
 = 
m§_ønge_¨øy
[
i
].
mö
;

907 
ödex_max
 = 
m§_ønge_¨øy
[
i
].
max
;

909 
ödex
 = 
ödex_mö
; index < 
ödex_max
; index++) {

910 i‡(
	`rdm§l_amd_ß„
(
ödex
, &
vÆ
))

912 
	`¥ötk
(
KERN_INFO
 " MSR%08x: %016Œx\n", 
ödex
, 
vÆ
);

915 
	}
}

917 
show_m§
 
	g__˝uöôd©a
;

919 
__öô
 
	$£tup_show_m§
(*
¨g
)

921 
num
;

923 
	`gë_›ti⁄
(&
¨g
, &
num
);

925 i‡(
num
 > 0)

926 
show_m§
 = 
num
;

928 
	}
}

929 
__£tup
("show_m§=", 
£tup_show_m§
);

931 
__öô
 
	$£tup_no˛Êush
(*
¨g
)

933 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_CLFLSH
);

935 
	}
}

936 
__£tup
("no˛Êush", 
£tup_no˛Êush
);

938 
__˝uöô
 
	$¥öt_˝u_öfo
(
˝uöfo_x86
 *
c
)

940 c⁄° *
víd‹
 = 
NULL
;

942 i‡(
c
->
x86_víd‹
 < 
X86_VENDOR_NUM
) {

943 
víd‹
 = 
this_˝u
->
c_víd‹
;

945 i‡(
c
->
˝uid_Àvñ
 >= 0)

946 
víd‹
 = 
c
->
x86_víd‹_id
;

949 i‡(
víd‹
 && !
	`°r°r
(
c
->
x86_modñ_id
, vendor))

950 
	`¥ötk
(
KERN_CONT
 "%†", 
víd‹
);

952 i‡(
c
->
x86_modñ_id
[0])

953 
	`¥ötk
(
KERN_CONT
 "%s", 
c
->
x86_modñ_id
);

955 
	`¥ötk
(
KERN_CONT
 "%d86", 
c
->
x86
);

957 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

958 
	`¥ötk
(
KERN_CONT
 " sãµög %02x\n", 
c
->
x86_mask
);

960 
	`¥ötk
(
KERN_CONT
 "\n");

962 #ifde‡
CONFIG_SMP


963 i‡(
c
->
˝u_ödex
 < 
show_m§
)

964 
	`¥öt_˝u_m§
();

966 i‡(
show_m§
)

967 
	`¥öt_˝u_m§
();

969 
	}
}

971 
__öô
 
	$£tup_dißbÀ˝uid
(*
¨g
)

973 
bô
;

975 i‡(
	`gë_›ti⁄
(&
¨g
, &
bô
Ë&& bô < 
NCAPINTS
*32)

976 
	`£tup_˛ór_˝u_ˇp
(
bô
);

981 
	}
}

982 
__£tup
("˛ór˝uid=", 
£tup_dißbÀ˝uid
);

984 #ifde‡
CONFIG_X86_64


985 
desc_±r
 
	gidt_des¸
 = { 256 * 16 - 1, (Ë
idt_èbÀ
 };

987 
	$DEFINE_PER_CPU_FIRST
(
úq_°ack_uni⁄
,

988 
úq_°ack_uni⁄
Ë
	`__Æig√d
(
PAGE_SIZE
);

990 
	`DEFINE_PER_CPU
(*, 
úq_°ack_±r
) =

991 
	`öô_≥r_˝u_v¨
(
úq_°ack_uni⁄
.
úq_°ack
Ë+ 
IRQ_STACK_SIZE
 - 64;

993 
	`DEFINE_PER_CPU
(, 
kî√l_°ack
) =

994 ()&
öô_thªad_uni⁄
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

995 
	`EXPORT_PER_CPU_SYMBOL
(
kî√l_°ack
);

997 
	`DEFINE_PER_CPU
(, 
úq_cou¡
) = -1;

1005 c⁄° 
ex˚±i⁄_°ack_sizes
[
N_EXCEPTION_STACKS
] = {

1006 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

1007 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


1008 
	}
};

1010 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
ex˚±i⁄_°acks


1011 [(
N_EXCEPTION_STACKS
 - 1Ë* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
])

1012 
__Æig√d
(
PAGE_SIZE
);

1015 
	$sysˇŒ_öô
()

1022 
	`wrm§l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1023 
	`wrm§l
(
MSR_LSTAR
, 
sy°em_ˇŒ
);

1024 
	`wrm§l
(
MSR_CSTAR
, 
ign‹e_sy§ë
);

1026 #ifde‡
CONFIG_IA32_EMULATION


1027 
	`sysˇŒ32_˝u_öô
();

1031 
	`wrm§l
(
MSR_SYSCALL_MASK
,

1032 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1033 
	}
}

1035 
	gkî√l_eÊags
;

1041 
DEFINE_PER_CPU
(
‹ig_i°
, orig_ist);

1045 #ifde‡
CONFIG_CC_STACKPROTECTOR


1046 
DEFINE_PER_CPU
(, 
°ack_ˇ«ry
);

1050 
±_ªgs
 * 
__˝uöô
 
	$idÀ_ªgs
(
±_ªgs
 *
ªgs
)

1052 
	`mem£t
(
ªgs
, 0, (
±_ªgs
));

1053 
ªgs
->
fs
 = 
__KERNEL_PERCPU
;

1054 
ªgs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1056  
ªgs
;

1057 
	}
}

1063 
	$˛ór_Æl_debug_ªgs
()

1065 
i
;

1067 
i
 = 0; i < 8; i++) {

1069 i‡((
i
 == 4) || (i == 5))

1072 
	`£t_debugªg
(0, 
i
);

1074 
	}
}

1083 #ifde‡
CONFIG_X86_64


1085 
__˝uöô
 
	$˝u_öô
()

1087 
‹ig_i°
 *orig_ist;

1088 
èsk_°ru˘
 *
me
;

1089 
tss_°ru˘
 *
t
;

1090 
v
;

1091 
˝u
;

1092 
i
;

1094 
˝u
 = 
	`°ack_smp_¥o˚ss‹_id
();

1095 
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1096 
‹ig_i°
 = &
	`≥r_˝u
(‹ig_i°, 
˝u
);

1098 #ifde‡
CONFIG_NUMA


1099 i‡(
˝u
 !0 && 
	`≥r˝u_ªad
(
node_numbî
) == 0 &&

1100 
	`˝u_to_node
(
˝u
Ë!
NUMA_NO_NODE
)

1101 
	`≥r˝u_wrôe
(
node_numbî
, 
	`˝u_to_node
(
˝u
));

1104 
me
 = 
cuºít
;

1106 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
))

1107 
	`∑nic
("CPU#%dáÃódy inôülized!\n", 
˝u
);

1109 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1111 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1118 
	`swôch_to_√w_gdt
(
˝u
);

1119 
	`lﬂd£gmít
(
fs
, 0);

1121 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

1123 
	`mem£t
(
me
->
thªad
.
és_¨øy
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1124 
	`sysˇŒ_öô
();

1126 
	`wrm§l
(
MSR_FS_BASE
, 0);

1127 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 0);

1128 
	`b¨rõr
();

1130 
	`check_e„r
();

1131 i‡(
˝u
 != 0)

1132 
	`íabÀ_x2≠ic
();

1137 i‡(!
‹ig_i°
->
i°
[0]) {

1138 *
e°acks
 = 
	`≥r_˝u
(
ex˚±i⁄_°acks
, 
˝u
);

1140 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1141 
e°acks
 +
ex˚±i⁄_°ack_sizes
[
v
];

1142 
‹ig_i°
->
i°
[
v
] = 
t
->
x86_tss
.ist[v] =

1143 ()
e°acks
;

1147 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1153 
i
 = 0; i <
IO_BITMAP_LONGS
; i++)

1154 
t
->
io_bôm≠
[
i
] = ~0UL;

1156 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1157 
me
->
a˘ive_mm
 = &
öô_mm
;

1158 
	`BUG_ON
(
me
->
mm
);

1159 
	`íãr_œzy_éb
(&
öô_mm
, 
me
);

1161 
	`lﬂd_•0
(
t
, &
cuºít
->
thªad
);

1162 
	`£t_tss_desc
(
˝u
, 
t
);

1163 
	`lﬂd_TR_desc
();

1164 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1166 #ifde‡
CONFIG_KGDB


1173 i‡(
kgdb_c⁄√˘ed
 && 
¨ch_kgdb_›s
.
c‹ª˘_hw_bªak
)

1174 
¨ch_kgdb_›s
.
	`c‹ª˘_hw_bªak
();

1177 
	`˛ór_Æl_debug_ªgs
();

1179 
	`Âu_öô
();

1181 
	`øw_loˇl_ßve_Êags
(
kî√l_eÊags
);

1183 i‡(
	`is_uv_sy°em
())

1184 
	`uv_˝u_öô
();

1185 
	}
}

1189 
__˝uöô
 
	$˝u_öô
()

1191 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1192 
èsk_°ru˘
 *
cuº
 = 
cuºít
;

1193 
tss_°ru˘
 *
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1194 
thªad_°ru˘
 *
thªad
 = &
cuº
->thread;

1196 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
)) {

1197 
	`¥ötk
(
KERN_WARNING
 "CPU#%dáÃódy inôülized!\n", 
˝u
);

1199 
	`loˇl_úq_íabÀ
();

1202 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1204 i‡(
˝u_has_vme
 || 
˝u_has_tsc
 || 
˝u_has_de
)

1205 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1207 
	`lﬂd_idt
(&
idt_des¸
);

1208 
	`swôch_to_√w_gdt
(
˝u
);

1213 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1214 
cuº
->
a˘ive_mm
 = &
öô_mm
;

1215 
	`BUG_ON
(
cuº
->
mm
);

1216 
	`íãr_œzy_éb
(&
öô_mm
, 
cuº
);

1218 
	`lﬂd_•0
(
t
, 
thªad
);

1219 
	`£t_tss_desc
(
˝u
, 
t
);

1220 
	`lﬂd_TR_desc
();

1221 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1223 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1225 #ifde‡
CONFIG_DOUBLEFAULT


1227 
	`__£t_tss_desc
(
˝u
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubÀÁu…_tss
);

1230 
	`˛ór_Æl_debug_ªgs
();

1235 i‡(
˝u_has_xßve
)

1236 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

1238 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

1239 
	`˛ór_u£d_m©h
();

1240 
	`mxc§_„©uª_mask_öô
();

1245 i‡(
	`smp_¥o˚ss‹_id
(Ë=
boŸ_˝u_id
)

1246 
	`öô_thªad_x°©e
();

1248 
	`xßve_öô
();

1249 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<löux/kî√l.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/˝u‰eq.h
>

34 
	~<löux/compûî.h
>

35 
	~<löux/dmi.h
>

36 
	~<åa˚/powî.h
>

38 
	~<löux/a˝i.h
>

39 
	~<löux/io.h
>

40 
	~<löux/dñay.h
>

41 
	~<löux/uac˚ss.h
>

43 
	~<a˝i/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/¥o˚ss‹.h
>

47 
	~<asm/˝u„©uª.h
>

49 
	#d¥ötk
(
msg
...Ë
	`˝u‰eq_debug_¥ötk
(
CPUFREQ_DEBUG_DRIVER
, \

50 "a˝i-˝u‰eq", 
msg
)

	)

52 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

53 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

54 
MODULE_LICENSE
("GPL");

57 
	mUNDEFINED_CAPABLE
 = 0,

58 
	mSYSTEM_INTEL_MSR_CAPABLE
,

59 
	mSYSTEM_IO_CAPABLE
,

62 
	#INTEL_MSR_RANGE
 (0xffff)

	)

63 
	#CPUID_6_ECX_APERFMPERF_CAPABILITY
 (0x1)

	)

65 
	sa˝i_˝u‰eq_d©a
 {

66 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ma˝i_d©a
;

67 
˝u‰eq_‰equícy_èbÀ
 *
	m‰eq_èbÀ
;

68 
	mªsume
;

69 
	m˝u_„©uª
;

72 
DEFINE_PER_CPU
(
a˝i_˝u‰eq_d©a
 *, 
drv_d©a
);

74 
	sa˝i_m§_d©a
 {

75 
u64
 
	mßved_≠îf
, 
	mßved_m≥rf
;

78 
DEFINE_PER_CPU
(
a˝i_m§_d©a
, 
m§_d©a
);

80 
DEFINE_TRACE
(
powî_m¨k
);

83 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ga˝i_≥rf_d©a
;

85 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
;

87 
	ga˝i_p°©e_°ri˘
;

89 
	$check_e°_˝u
(
˝uid
)

91 
˝uöfo_x86
 *
˝u
 = &
	`˝u_d©a
(
˝uid
);

93  
	`˝u_has
(
˝u
, 
X86_FEATURE_EST
);

94 
	}
}

96 
	$exåa˘_io
(
u32
 
vÆue
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

98 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

99 
i
;

101 
≥rf
 = 
d©a
->
a˝i_d©a
;

103 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

104 i‡(
vÆue
 =
≥rf
->
°©es
[
i
].
°©us
)

105  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

108 
	}
}

110 
	$exåa˘_m§
(
u32
 
m§
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

112 
i
;

113 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

115 
m§
 &
INTEL_MSR_RANGE
;

116 
≥rf
 = 
d©a
->
a˝i_d©a
;

118 
i
 = 0; 
d©a
->
‰eq_èbÀ
[i].
‰equícy
 !
CPUFREQ_TABLE_END
; i++) {

119 i‡(
m§
 =
≥rf
->
°©es
[
d©a
->
‰eq_èbÀ
[
i
].
ödex
].
°©us
)

120  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

122  
d©a
->
‰eq_èbÀ
[0].
‰equícy
;

123 
	}
}

125 
	$exåa˘_‰eq
(
u32
 
vÆ
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

127 
d©a
->
˝u_„©uª
) {

128 
SYSTEM_INTEL_MSR_CAPABLE
:

129  
	`exåa˘_m§
(
vÆ
, 
d©a
);

130 
SYSTEM_IO_CAPABLE
:

131  
	`exåa˘_io
(
vÆ
, 
d©a
);

135 
	}
}

137 
	sm§_addr
 {

138 
u32
 
	mªg
;

141 
	sio_addr
 {

142 
u16
 
	mp‹t
;

143 
u8
 
	mbô_width
;

146 
	sdrv_cmd
 {

147 
	mty≥
;

148 c⁄° 
˝umask
 *
	mmask
;

150 
m§_addr
 
	mm§
;

151 
io_addr
 
	mio
;

152 } 
	maddr
;

153 
u32
 
	mvÆ
;

157 
	$do_drv_ªad
(*
_cmd
)

159 
drv_cmd
 *
cmd
 = 
_cmd
;

160 
u32
 
h
;

162 
cmd
->
ty≥
) {

163 
SYSTEM_INTEL_MSR_CAPABLE
:

164 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, cmd->
vÆ
, 
h
);

166 
SYSTEM_IO_CAPABLE
:

167 
	`a˝i_os_ªad_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

168 &
cmd
->
vÆ
,

169 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

174 
	}
}

177 
	$do_drv_wrôe
(*
_cmd
)

179 
drv_cmd
 *
cmd
 = 
_cmd
;

180 
u32
 
lo
, 
hi
;

182 
cmd
->
ty≥
) {

183 
SYSTEM_INTEL_MSR_CAPABLE
:

184 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

185 
lo
 = (lÿ& ~
INTEL_MSR_RANGE
Ë| (
cmd
->
vÆ
 & INTEL_MSR_RANGE);

186 
	`wrm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

188 
SYSTEM_IO_CAPABLE
:

189 
	`a˝i_os_wrôe_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

190 
cmd
->
vÆ
,

191 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

196 
	}
}

198 
	$drv_ªad
(
drv_cmd
 *
cmd
)

200 
cmd
->
vÆ
 = 0;

202 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
	`˝umask_™y
(
cmd
->
mask
), 
do_drv_ªad
, cmd, 1);

203 
	}
}

205 
	$drv_wrôe
(
drv_cmd
 *
cmd
)

207 
this_˝u
;

209 
this_˝u
 = 
	`gë_˝u
();

210 i‡(
	`˝umask_ã°_˝u
(
this_˝u
, 
cmd
->
mask
))

211 
	`do_drv_wrôe
(
cmd
);

212 
	`smp_ˇŒ_fun˘i⁄_m™y
(
cmd
->
mask
, 
do_drv_wrôe
, cmd, 1);

213 
	`put_˝u
();

214 
	}
}

216 
u32
 
	$gë_cur_vÆ
(c⁄° 
˝umask
 *
mask
)

218 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

219 
drv_cmd
 
cmd
;

221 i‡(
	`u∆ikñy
(
	`˝umask_em±y
(
mask
)))

224 
	`≥r_˝u
(
drv_d©a
, 
	`˝umask_fú°
(
mask
))->
˝u_„©uª
) {

225 
SYSTEM_INTEL_MSR_CAPABLE
:

226 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

227 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_STATUS
;

229 
SYSTEM_IO_CAPABLE
:

230 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

231 
≥rf
 = 
	`≥r_˝u
(
drv_d©a
, 
	`˝umask_fú°
(
mask
))->
a˝i_d©a
;

232 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

233 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

239 
cmd
.
mask
 = mask;

240 
	`drv_ªad
(&
cmd
);

242 
	`d¥ötk
("gë_cur_vÆ = %u\n", 
cmd
.
vÆ
);

244  
cmd
.
vÆ
;

245 
	}
}

247 
	s≥rf_∑ú
 {

250 
u32
 
	mlo
;

251 
u32
 
	mhi
;

252 } 
	m•lô
;

253 
u64
 
	mwhﬁe
;

254 } 
	m≠îf
, 
	mm≥rf
;

258 
	$ªad_mósuªd_≥rf_˘rs
(*
_cur
)

260 
≥rf_∑ú
 *
cur
 = 
_cur
;

262 
	`rdm§
(
MSR_IA32_APERF
, 
cur
->
≠îf
.
•lô
.
lo
, cur->≠îf.•lô.
hi
);

263 
	`rdm§
(
MSR_IA32_MPERF
, 
cur
->
m≥rf
.
•lô
.
lo
, cur->m≥rf.•lô.
hi
);

264 
	}
}

279 
	$gë_mósuªd_≥rf
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

280 
˝u
)

282 
≥rf_∑ú
 
ªadö
, 
cur
;

283 
≥rf_≥r˚¡
;

284 
ªtvÆ
;

286 i‡(
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
ªad_mósuªd_≥rf_˘rs
, &
ªadö
, 1))

289 
cur
.
≠îf
.
whﬁe
 = 
ªadö
.aperf.whole -

290 
	`≥r_˝u
(
m§_d©a
, 
˝u
).
ßved_≠îf
;

291 
cur
.
m≥rf
.
whﬁe
 = 
ªadö
.mperf.whole -

292 
	`≥r_˝u
(
m§_d©a
, 
˝u
).
ßved_m≥rf
;

293 
	`≥r_˝u
(
m§_d©a
, 
˝u
).
ßved_≠îf
 = 
ªadö
.
≠îf
.
whﬁe
;

294 
	`≥r_˝u
(
m§_d©a
, 
˝u
).
ßved_m≥rf
 = 
ªadö
.
m≥rf
.
whﬁe
;

296 #ifde‡
__i386__


302 i‡(
	`u∆ikñy
(
cur
.
≠îf
.
•lô
.
hi
 || cur.
m≥rf
.split.hi)) {

303 
shi·_cou¡
;

304 
u32
 
h
;

306 
h
 = 
	`max_t
(
u32
, 
cur
.
≠îf
.
•lô
.
hi
, cur.
m≥rf
.split.hi);

307 
shi·_cou¡
 = 
	`Ês
(
h
);

309 
cur
.
≠îf
.
whﬁe
 >>
shi·_cou¡
;

310 
cur
.
m≥rf
.
whﬁe
 >>
shi·_cou¡
;

313 i‡((()(-1Ë/ 100Ë< 
cur
.
≠îf
.
•lô
.
lo
) {

314 
shi·_cou¡
 = 7;

315 
cur
.
≠îf
.
•lô
.
lo
 >>
shi·_cou¡
;

316 
cur
.
m≥rf
.
•lô
.
lo
 >>
shi·_cou¡
;

319 i‡(
cur
.
≠îf
.
•lô
.
lo
 && cur.
m≥rf
.split.lo)

320 
≥rf_≥r˚¡
 = (
cur
.
≠îf
.
•lô
.
lo
 * 100Ë/ cur.
m≥rf
.split.lo;

322 
≥rf_≥r˚¡
 = 0;

325 i‡(
	`u∆ikñy
((()(-1Ë/ 100Ë< 
cur
.
≠îf
.
whﬁe
)) {

326 
shi·_cou¡
 = 7;

327 
cur
.
≠îf
.
whﬁe
 >>
shi·_cou¡
;

328 
cur
.
m≥rf
.
whﬁe
 >>
shi·_cou¡
;

331 i‡(
cur
.
≠îf
.
whﬁe
 && cur.
m≥rf
.whole)

332 
≥rf_≥r˚¡
 = (
cur
.
≠îf
.
whﬁe
 * 100Ë/ cur.
m≥rf
.whole;

334 
≥rf_≥r˚¡
 = 0;

338 
ªtvÆ
 = (
pﬁicy
->
˝uöfo
.
max_‰eq
 * 
≥rf_≥r˚¡
) / 100;

340  
ªtvÆ
;

341 
	}
}

343 
	$gë_cur_‰eq_⁄_˝u
(
˝u
)

345 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
˝u
);

346 
‰eq
;

347 
ˇched_‰eq
;

349 
	`d¥ötk
("gë_cur_‰eq_⁄_˝u (%d)\n", 
˝u
);

351 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

352 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

356 
ˇched_‰eq
 = 
d©a
->
‰eq_èbÀ
[d©a->
a˝i_d©a
->
°©e
].
‰equícy
;

357 
‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
	`˝umask_of
(
˝u
)), 
d©a
);

358 i‡(
‰eq
 !
ˇched_‰eq
) {

363 
d©a
->
ªsume
 = 1;

366 
	`d¥ötk
("cu∏‰eq = %u\n", 
‰eq
);

368  
‰eq
;

369 
	}
}

371 
	$check_‰eqs
(c⁄° 
˝umask
 *
mask
, 
‰eq
,

372 
a˝i_˝u‰eq_d©a
 *
d©a
)

374 
cur_‰eq
;

375 
i
;

377 
i
 = 0; i < 100; i++) {

378 
cur_‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
mask
), 
d©a
);

379 i‡(
cur_‰eq
 =
‰eq
)

381 
	`udñay
(10);

384 
	}
}

386 
	$a˝i_˝u‰eq_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

387 
èrgë_‰eq
, 
ªœti⁄
)

389 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

390 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

391 
˝u‰eq_‰eqs
 
‰eqs
;

392 
drv_cmd
 
cmd
;

393 
√xt_°©e
 = 0;

394 
√xt_≥rf_°©e
 = 0;

395 
i
;

396 
ªsu…
 = 0;

397 
powî_åa˚
 
ô
;

399 
	`d¥ötk
("a˝i_˝u‰eq_èrgë %d (%d)\n", 
èrgë_‰eq
, 
pﬁicy
->
˝u
);

401 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

402 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

403  -
ENODEV
;

406 
≥rf
 = 
d©a
->
a˝i_d©a
;

407 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_èrgë
(
pﬁicy
,

408 
d©a
->
‰eq_èbÀ
,

409 
èrgë_‰eq
,

410 
ªœti⁄
, &
√xt_°©e
);

411 i‡(
	`u∆ikñy
(
ªsu…
)) {

412 
ªsu…
 = -
ENODEV
;

413 
out
;

416 
√xt_≥rf_°©e
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
ödex
;

417 i‡(
≥rf
->
°©e
 =
√xt_≥rf_°©e
) {

418 i‡(
	`u∆ikñy
(
d©a
->
ªsume
)) {

419 
	`d¥ötk
("CalledáfterÑesume,ÑesettingÅo P%d\n",

420 
√xt_≥rf_°©e
);

421 
d©a
->
ªsume
 = 0;

423 
	`d¥ötk
("AlreadyátÅarget state (P%d)\n",

424 
√xt_≥rf_°©e
);

425 
out
;

429 
	`åa˚_powî_m¨k
(&
ô
, 
POWER_PSTATE
, 
√xt_≥rf_°©e
);

431 
d©a
->
˝u_„©uª
) {

432 
SYSTEM_INTEL_MSR_CAPABLE
:

433 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

434 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_CTL
;

435 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

437 
SYSTEM_IO_CAPABLE
:

438 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

439 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

440 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

441 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

444 
ªsu…
 = -
ENODEV
;

445 
out
;

449 i‡(
pﬁicy
->
sh¨ed_ty≥
 !
CPUFREQ_SHARED_TYPE_ANY
)

450 
cmd
.
mask
 = 
pﬁicy
->
˝us
;

452 
cmd
.
mask
 = 
	`˝umask_of
(
pﬁicy
->
˝u
);

454 
‰eqs
.
ﬁd
 = 
≥rf
->
°©es
[≥rf->
°©e
].
c‹e_‰equícy
 * 1000;

455 
‰eqs
.
√w
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
;

456 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

457 
‰eqs
.
˝u
 = 
i
;

458 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

461 
	`drv_wrôe
(&
cmd
);

463 i‡(
a˝i_p°©e_°ri˘
) {

464 i‡(!
	`check_‰eqs
(
cmd
.
mask
, 
‰eqs
.
√w
, 
d©a
)) {

465 
	`d¥ötk
("acpi_cpufreq_target failed (%d)\n",

466 
pﬁicy
->
˝u
);

467 
ªsu…
 = -
EAGAIN
;

468 
out
;

472 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

473 
‰eqs
.
˝u
 = 
i
;

474 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

476 
≥rf
->
°©e
 = 
√xt_≥rf_°©e
;

478 
out
:

479  
ªsu…
;

480 
	}
}

482 
	$a˝i_˝u‰eq_vîify
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

484 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

486 
	`d¥ötk
("acpi_cpufreq_verify\n");

488  
	`˝u‰eq_‰equícy_èbÀ_vîify
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

489 
	}
}

492 
	$a˝i_˝u‰eq_guess_‰eq
(
a˝i_˝u‰eq_d©a
 *
d©a
, 
˝u
)

494 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
 = 
d©a
->
a˝i_d©a
;

496 i‡(
˝u_khz
) {

498 
i
;

499 
‰eq
;

500 
‰eqn
 = 
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

502 
i
 = 0; i < (
≥rf
->
°©e_cou¡
-1); i++) {

503 
‰eq
 = 
‰eqn
;

504 
‰eqn
 = 
≥rf
->
°©es
[
i
+1].
c‹e_‰equícy
 * 1000;

505 i‡((2 * 
˝u_khz
Ë> (
‰eqn
 + 
‰eq
)) {

506 
≥rf
->
°©e
 = 
i
;

507  
‰eq
;

510 
≥rf
->
°©e
 =Öîf->
°©e_cou¡
-1;

511  
‰eqn
;

514 
≥rf
->
°©e
 = 0;

515  
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

517 
	}
}

519 
	$‰ì_a˝i_≥rf_d©a
()

521 
i
;

524 
	`f‹_óch_possibÀ_˝u
(
i
)

525 
	`‰ì_˝umask_v¨
(
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)

526 ->
sh¨ed_˝u_m≠
);

527 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

528 
	}
}

538 
__öô
 
	$a˝i_˝u‰eq_óæy_öô
()

540 
i
;

541 
	`d¥ötk
("acpi_cpufreq_early_init\n");

543 
a˝i_≥rf_d©a
 = 
	`Æloc_≥r˝u
(
a˝i_¥o˚ss‹_≥rf‹m™˚
);

544 i‡(!
a˝i_≥rf_d©a
) {

545 
	`d¥ötk
("MemoryállocationÉrror forácpi_perf_data.\n");

546  -
ENOMEM
;

548 
	`f‹_óch_possibÀ_˝u
(
i
) {

549 i‡(!
	`zÆloc_˝umask_v¨_node
(

550 &
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)->
sh¨ed_˝u_m≠
,

551 
GFP_KERNEL
, 
	`˝u_to_node
(
i
))) {

554 
	`‰ì_a˝i_≥rf_d©a
();

555  -
ENOMEM
;

560 
	`a˝i_¥o˚ss‹_¥îegi°î_≥rf‹m™˚
(
a˝i_≥rf_d©a
);

562 
	}
}

564 #ifde‡
CONFIG_SMP


571 
	gbios_wôh_sw_™y_bug
;

573 
	$sw_™y_bug_found
(c⁄° 
dmi_sy°em_id
 *
d
)

575 
bios_wôh_sw_™y_bug
 = 1;

577 
	}
}

579 c⁄° 
dmi_sy°em_id
 
	gsw_™y_bug_dmi_èbÀ
[] = {

581 .
ˇŒback
 = 
sw_™y_bug_found
,

582 .
	gidít
 = "Supermicro Server X6DLP",

583 .
	gm©ches
 = {

584 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

585 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

586 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

593 
	$a˝i_˝u‰eq_˝u_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

595 
i
;

596 
vÆid_°©es
 = 0;

597 
˝u
 = 
pﬁicy
->cpu;

598 
a˝i_˝u‰eq_d©a
 *
d©a
;

599 
ªsu…
 = 0;

600 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
pﬁicy
->
˝u
);

601 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

603 
	`d¥ötk
("acpi_cpufreq_cpu_init\n");

605 
d©a
 = 
	`kzÆloc
((
a˝i_˝u‰eq_d©a
), 
GFP_KERNEL
);

606 i‡(!
d©a
)

607  -
ENOMEM
;

609 
d©a
->
a˝i_d©a
 = 
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
˝u
);

610 
	`≥r_˝u
(
drv_d©a
, 
˝u
Ë
d©a
;

612 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

613 
a˝i_˝u‰eq_drivî
.
Êags
 |
CPUFREQ_CONST_LOOPS
;

615 
ªsu…
 = 
	`a˝i_¥o˚ss‹_ªgi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
, 
˝u
);

616 i‡(
ªsu…
)

617 
îr_‰ì
;

619 
≥rf
 = 
d©a
->
a˝i_d©a
;

620 
pﬁicy
->
sh¨ed_ty≥
 = 
≥rf
->shared_type;

626 i‡(
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ALL
 ||

627 
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ANY
) {

628 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

630 
	`˝umask_c›y
(
pﬁicy
->
ªœãd_˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

632 #ifde‡
CONFIG_SMP


633 
	`dmi_check_sy°em
(
sw_™y_bug_dmi_èbÀ
);

634 i‡(
bios_wôh_sw_™y_bug
 && 
	`˝umask_weight
(
pﬁicy
->
˝us
) == 1) {

635 
pﬁicy
->
sh¨ed_ty≥
 = 
CPUFREQ_SHARED_TYPE_ALL
;

636 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

641 i‡(
≥rf
->
°©e_cou¡
 <= 1) {

642 
	`d¥ötk
("No P-States\n");

643 
ªsu…
 = -
ENODEV
;

644 
îr_uƒeg
;

647 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 !≥rf->
°©us_ªgi°î
.space_id) {

648 
ªsu…
 = -
ENODEV
;

649 
îr_uƒeg
;

652 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

653 
ACPI_ADR_SPACE_SYSTEM_IO
:

654 
	`d¥ötk
("SYSTEM IOáddr space\n");

655 
d©a
->
˝u_„©uª
 = 
SYSTEM_IO_CAPABLE
;

657 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

658 
	`d¥ötk
("HARDWAREáddr space\n");

659 i‡(!
	`check_e°_˝u
(
˝u
)) {

660 
ªsu…
 = -
ENODEV
;

661 
îr_uƒeg
;

663 
d©a
->
˝u_„©uª
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

666 
	`d¥ötk
("Unknownáddr space %d\n",

667 (
u32
Ë(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
));

668 
ªsu…
 = -
ENODEV
;

669 
îr_uƒeg
;

672 
d©a
->
‰eq_èbÀ
 = 
	`kmÆloc
((
˝u‰eq_‰equícy_èbÀ
) *

673 (
≥rf
->
°©e_cou¡
+1), 
GFP_KERNEL
);

674 i‡(!
d©a
->
‰eq_èbÀ
) {

675 
ªsu…
 = -
ENOMEM
;

676 
îr_uƒeg
;

680 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 0;

681 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

682 i‡((
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000) >

683 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
)

684 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 =

685 
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000;

689 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 =
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

690 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 > 20 * 1000) {

691 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 20 * 1000;

692 
	`¥ötk_⁄˚
(
KERN_INFO


697 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

698 i‡(
i
 > 0 && 
≥rf
->
°©es
[i].
c‹e_‰equícy
 >=

699 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
-1].
‰equícy
 / 1000)

702 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
ödex
 = 
i
;

703 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 =

704 
≥rf
->
°©es
[
i
].
c‹e_‰equícy
 * 1000;

705 
vÆid_°©es
++;

707 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 = 
CPUFREQ_TABLE_END
;

708 
≥rf
->
°©e
 = 0;

710 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_˝uöfo
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

711 i‡(
ªsu…
)

712 
îr_‰eq‰ì
;

714 i‡(
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000 !
pﬁicy
->
˝uöfo
.
max_‰eq
)

715 
	`¥ötk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 isÇot max freq\n");

717 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

718 
ACPI_ADR_SPACE_SYSTEM_IO
:

720 
pﬁicy
->
cur
 = 
	`a˝i_˝u‰eq_guess_‰eq
(
d©a
,Öﬁicy->
˝u
);

722 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

723 
a˝i_˝u‰eq_drivî
.
gë
 = 
gë_cur_‰eq_⁄_˝u
;

724 
pﬁicy
->
cur
 = 
	`gë_cur_‰eq_⁄_˝u
(
˝u
);

731 
	`a˝i_¥o˚ss‹_nŸify_smm
(
THIS_MODULE
);

734 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 && c->
˝uid_Àvñ
 >= 6) {

735 
ecx
;

736 
ecx
 = 
	`˝uid_ecx
(6);

737 i‡(
ecx
 & 
CPUID_6_ECX_APERFMPERF_CAPABILITY
)

738 
a˝i_˝u‰eq_drivî
.
gëavg
 = 
gë_mósuªd_≥rf
;

741 
	`d¥ötk
("CPU%u - ACPIÖîf‹m™˚ m™agemíàa˘iv©ed.\n", 
˝u
);

742 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++)

743 
	`d¥ötk
(" %cP%d: %d MHz, %d mW, %d uS\n",

744 (
i
 =
≥rf
->
°©e
 ? '*' : ' '), i,

745 (
u32
Ë
≥rf
->
°©es
[
i
].
c‹e_‰equícy
,

746 (
u32
Ë
≥rf
->
°©es
[
i
].
powî
,

747 (
u32
Ë
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
);

749 
	`˝u‰eq_‰equícy_èbÀ_gë_©å
(
d©a
->
‰eq_èbÀ
, 
pﬁicy
->
˝u
);

755 
d©a
->
ªsume
 = 1;

757  
ªsu…
;

759 
îr_‰eq‰ì
:

760 
	`k‰ì
(
d©a
->
‰eq_èbÀ
);

761 
îr_uƒeg
:

762 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
≥rf
, 
˝u
);

763 
îr_‰ì
:

764 
	`k‰ì
(
d©a
);

765 
	`≥r_˝u
(
drv_d©a
, 
˝u
Ë
NULL
;

767  
ªsu…
;

768 
	}
}

770 
	$a˝i_˝u‰eq_˝u_exô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

772 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

774 
	`d¥ötk
("acpi_cpufreq_cpu_exit\n");

776 i‡(
d©a
) {

777 
	`˝u‰eq_‰equícy_èbÀ_put_©å
(
pﬁicy
->
˝u
);

778 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
Ë
NULL
;

779 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
,

780 
pﬁicy
->
˝u
);

781 
	`k‰ì
(
d©a
);

785 
	}
}

787 
	$a˝i_˝u‰eq_ªsume
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

789 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

791 
	`d¥ötk
("acpi_cpufreq_resume\n");

793 
d©a
->
ªsume
 = 1;

796 
	}
}

798 
‰eq_©å
 *
	ga˝i_˝u‰eq_©å
[] = {

799 &
˝u‰eq_‰eq_©å_sˇlög_avaûabÀ_‰eqs
,

800 
NULL
,

803 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
 = {

804 .
vîify
 = 
a˝i_˝u‰eq_vîify
,

805 .
	gèrgë
 = 
a˝i_˝u‰eq_èrgë
,

806 .
	göô
 = 
a˝i_˝u‰eq_˝u_öô
,

807 .
	gexô
 = 
a˝i_˝u‰eq_˝u_exô
,

808 .
	gªsume
 = 
a˝i_˝u‰eq_ªsume
,

809 .
	g«me
 = "acpi-cpufreq",

810 .
	gow√r
 = 
THIS_MODULE
,

811 .
	g©å
 = 
a˝i_˝u‰eq_©å
,

814 
__öô
 
	$a˝i_˝u‰eq_öô
()

816 
ªt
;

818 i‡(
a˝i_dißbÀd
)

821 
	`d¥ötk
("acpi_cpufreq_init\n");

823 
ªt
 = 
	`a˝i_˝u‰eq_óæy_öô
();

824 i‡(
ªt
)

825  
ªt
;

827 
ªt
 = 
	`˝u‰eq_ªgi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

828 i‡(
ªt
)

829 
	`‰ì_a˝i_≥rf_d©a
();

831  
ªt
;

832 
	}
}

834 
__exô
 
	$a˝i_˝u‰eq_exô
()

836 
	`d¥ötk
("acpi_cpufreq_exit\n");

838 
	`˝u‰eq_uƒegi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

840 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

841 
	}
}

843 
moduÀ_∑øm
(
a˝i_p°©e_°ri˘
, 
uöt
, 0644);

844 
MODULE_PARM_DESC
(
a˝i_p°©e_°ri˘
,

848 
œã_öôˇŒ
(
a˝i_˝u‰eq_öô
);

849 
moduÀ_exô
(
a˝i_˝u‰eq_exô
);

851 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/vmw¨e.h
>

26 
	~<asm/hy≥rvis‹.h
>

28 
ölöe
 
__˝uöô


29 
	$dëe˘_hy≥rvis‹_víd‹
(
˝uöfo_x86
 *
c
)

31 i‡(
	`vmw¨e_∂©f‹m
()) {

32 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_VMWARE
;

34 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_NONE
;

36 
	}
}

38 
	$gë_hy≥rvis‹_tsc_‰eq
()

40 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
)

41  
	`vmw¨e_gë_tsc_khz
();

43 
	}
}

45 
ölöe
 
__˝uöô


46 
	$hy≥rvis‹_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

48 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
) {

49 
	`vmw¨e_£t_„©uª_bôs
(
c
);

52 
	}
}

54 
__˝uöô
 
	$öô_hy≥rvis‹
(
˝uöfo_x86
 *
c
)

56 
	`dëe˘_hy≥rvis‹_víd‹
(
c
);

57 
	`hy≥rvis‹_£t_„©uª_bôs
(
c
);

58 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<löux/öô.h
>

2 
	~<löux/kî√l.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/bô›s.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/thªad_öfo.h
>

9 
	~<löux/moduÀ.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/pgèbÀ.h
>

13 
	~<asm/m§.h
>

14 
	~<asm/uac˚ss.h
>

15 
	~<asm/ds.h
>

16 
	~<asm/bugs.h
>

17 
	~<asm/˝u.h
>

19 #ifde‡
CONFIG_X86_64


20 
	~<asm/t›ﬁogy.h
>

21 
	~<asm/numa_64.h
>

24 
	~"˝u.h
"

26 #ifde‡
CONFIG_X86_LOCAL_APIC


27 
	~<asm/mp•ec.h
>

28 
	~<asm/≠ic.h
>

31 
__˝uöô
 
	$óæy_öô_öãl
(
˝uöfo_x86
 *
c
)

34 i‡(
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xd)) {

35 
u64
 
misc_íabÀ
;

37 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

39 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

40 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

41 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

42 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

46 i‡((
c
->
x86
 =0x‡&& c->
x86_modñ
 >= 0x03) ||

47 (
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0x0e))

48 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

50 #ifde‡
CONFIG_X86_64


51 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

54 i‡(
c
->
x86
 =15 && c->
x86_ˇche_Æignmít
 == 64)

55 
c
->
x86_ˇche_Æignmít
 = 128;

59 i‡(
c
->
x86
 =0xF && c->
x86_modñ
 == 0x3

60 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

61 
c
->
x86_phys_bôs
 = 36;

70 i‡(
c
->
x86_powî
 & (1 << 8)) {

71 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

72 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

73 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

74 
sched_˛ock_°abÀ
 = 1;

87 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 15)

88 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PAT
);

90 #ifde‡
CONFIG_KMEMCHECK


99 i‡(
c
->
x86
 == 15) {

100 
u64
 
misc_íabÀ
;

102 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

104 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_FAST_STRING
) {

105 
	`¥ötk
(
KERN_INFO
 "kmemcheck: Disabling fast string operations\n");

107 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_FAST_STRING
;

108 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

112 
	}
}

114 #ifde‡
CONFIG_X86_32


121 
__˝uöô
 
	$µro_wôh_øm_bug
()

124 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

125 
boŸ_˝u_d©a
.
x86
 == 6 &&

126 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

127 
boŸ_˝u_d©a
.
x86_mask
 < 8) {

128 
	`¥ötk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. TakingÉvasiveáction.\n");

132 
	}
}

134 #ifde‡
CONFIG_X86_F00F_BUG


135 
__˝uöô
 
	$å≠_öô_f00f_bug
()

137 
	`__£t_fixm≠
(
FIX_F00F_IDT
, 
	`__∑
(&
idt_èbÀ
), 
PAGE_KERNEL_RO
);

143 
idt_des¸
.
addªss
 = 
	`fix_to_vút
(
FIX_F00F_IDT
);

144 
	`lﬂd_idt
(&
idt_des¸
);

145 
	}
}

148 
__˝uöô
 
	$öãl_smp_check
(
˝uöfo_x86
 *
c
)

150 #ifde‡
CONFIG_SMP


152 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

158 i‡(
c
->
x86
 == 5 &&

159 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

160 
c
->
x86_modñ
 <= 3) {

164 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

168 
	}
}

170 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

172 
lo
, 
hi
;

174 #ifde‡
CONFIG_X86_F00F_BUG


180 
c
->
f00f_bug
 = 0;

181 i‡(!
	`∑øvút_íabÀd
(Ë&& 
c
->
x86
 == 5) {

182 
f00f_w‹k¨ound_íabÀd
;

184 
c
->
f00f_bug
 = 1;

185 i‡(!
f00f_w‹k¨ound_íabÀd
) {

186 
	`å≠_öô_f00f_bug
();

187 
	`¥ötk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundÉnabled.\n");

188 
f00f_w‹k¨ound_íabÀd
 = 1;

197 i‡((
c
->
x86
<<8 | c->
x86_modñ
<<4 | c->
x86_mask
) < 0x633)

198 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_SEP
);

204 i‡((
c
->
x86
 =15Ë&& (c->
x86_modñ
 =1Ë&& (c->
x86_mask
 == 1)) {

205 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

206 i‡((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

207 
	`¥ötk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

208 
	`¥ötk
 (
KERN_INFO
 "CPU: Disabling hardwareÖrefetching (Errata 037)\n");

209 
lo
 |
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

210 
	`wrm§
 (
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

220 i‡(
˝u_has_≠ic
 && (
c
->
x86
<<8 | c->
x86_modñ
<<4) == 0x520 &&

221 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

222 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_11AP
);

225 #ifde‡
CONFIG_X86_INTEL_USERCOPY


229 
c
->
x86
) {

235 
mov¶_mask
.
mask
 = 7;

238 
mov¶_mask
.
mask
 = 7;

243 #ifde‡
CONFIG_X86_NUMAQ


244 
	`numaq_tsc_dißbÀ
();

247 
	`öãl_smp_check
(
c
);

248 
	}
}

250 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

252 
	}
}

255 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

257 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

258 
node
;

259 
˝u
 = 
	`smp_¥o˚ss‹_id
();

260 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

264 
node
 = 
≠icid_to_node
[
≠icid
];

265 i‡(
node
 =
NUMA_NO_NODE
 || !
	`node_⁄löe
(node))

266 
node
 = 
	`fú°_node
(
node_⁄löe_m≠
);

267 
	`numa_£t_node
(
˝u
, 
node
);

269 
	`¥ötk
(
KERN_INFO
 "CPU %d/0x%x -> Nodê%d\n", 
˝u
, 
≠icid
, 
node
);

271 
	}
}

276 
__˝uöô
 
	$öãl_num_˝u_c‹es
(
˝uöfo_x86
 *
c
)

278 
óx
, 
ebx
, 
ecx
, 
edx
;

280 i‡(
c
->
˝uid_Àvñ
 < 4)

284 
	`˝uid_cou¡
(4, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

285 i‡(
óx
 & 0x1f)

286  ((
óx
 >> 26) + 1);

289 
	}
}

291 
__˝uöô
 
	$dëe˘_vmx_vútˇp
(
˝uöfo_x86
 *
c
)

294 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

295 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

296 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

297 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

298 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

299 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

301 
u32
 
vmx_m§_low
, 
vmx_m§_high
, 
m§_˘l
, 
m§_˘l2
;

303 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

304 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

305 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

306 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

307 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

309 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m§_low
, 
vmx_m§_high
);

310 
m§_˘l
 = 
vmx_m§_high
 | 
vmx_m§_low
;

311 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

312 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

313 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

314 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

315 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

316 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

317 
vmx_m§_low
, 
vmx_m§_high
);

318 
m§_˘l2
 = 
vmx_m§_high
 | 
vmx_m§_low
;

319 i‡((
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

320 (
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

321 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

322 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

323 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

324 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

325 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

327 
	}
}

329 
__˝uöô
 
	$öô_öãl
(
˝uöfo_x86
 *
c
)

331 
l2
 = 0;

333 
	`óæy_öô_öãl
(
c
);

335 
	`öãl_w‹k¨ounds
(
c
);

342 
	`dëe˘_exãnded_t›ﬁogy
(
c
);

344 
l2
 = 
	`öô_öãl_ˇcheöfo
(
c
);

345 i‡(
c
->
˝uid_Àvñ
 > 9) {

346 
óx
 = 
	`˝uid_óx
(10);

348 i‡((
óx
 & 0xff) && (((eax>>8) & 0xff) > 1))

349 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

352 i‡(
˝u_has_xmm2
)

353 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

354 i‡(
˝u_has_ds
) {

355 
l1
;

356 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

357 i‡(!(
l1
 & (1<<11)))

358 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_BTS
);

359 i‡(!(
l1
 & (1<<12)))

360 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PEBS
);

361 
	`ds_öô_öãl
(
c
);

364 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =29 && 
˝u_has_˛Êush
)

365 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

367 #ifde‡
CONFIG_X86_64


368 i‡(
c
->
x86
 == 15)

369 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

370 i‡(
c
->
x86
 == 6)

371 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

378 i‡(
c
->
x86
 == 6) {

379 *
p
 = 
NULL
;

381 
c
->
x86_modñ
) {

383 i‡(
c
->
x86_mask
 == 0) {

384 i‡(
l2
 == 0)

385 
p
 = "Celeron (Covington)";

386 i‡(
l2
 == 256)

387 
p
 = "Mobile Pentium II (Dixon)";

392 i‡(
l2
 == 128)

393 
p
 = "Celeron (Mendocino)";

394 i‡(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

395 
p
 = "Celeron-A";

399 i‡(
l2
 == 128)

400 
p
 = "Celeron (Coppermine)";

404 i‡(
p
)

405 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

408 i‡(
c
->
x86
 == 15)

409 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P4
);

410 i‡(
c
->
x86
 == 6)

411 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P3
);

414 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

419 
c
->
x86_max_c‹es
 = 
	`öãl_num_˝u_c‹es
(c);

420 #ifde‡
CONFIG_X86_32


421 
	`dëe˘_ht
(
c
);

426 
	`§©_dëe˘_node
(
c
);

428 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_VMX
))

429 
	`dëe˘_vmx_vútˇp
(
c
);

430 
	}
}

432 #ifde‡
CONFIG_X86_32


433 
__˝uöô
 
	$öãl_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

441 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 =11Ë&& (
size
 == 0))

442 
size
 = 256;

443  
size
;

444 
	}
}

447 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	göãl_˝u_dev
 = {

448 .
c_víd‹
 = "Intel",

449 .
	gc_idít
 = { "GenuineIntel" },

450 #ifde‡
CONFIG_X86_32


451 .
	gc_modñs
 = {

452 { .
víd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

465 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 5, .
	gmodñ_«mes
 =

476 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 6, .
	gmodñ_«mes
 =

490 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 15, .
	gmodñ_«mes
 =

500 .
	gc_size_ˇche
 = 
öãl_size_ˇche
,

502 .
	gc_óæy_öô
 = 
óæy_öô_öãl
,

503 .
	gc_öô
 = 
öô_öãl
,

504 .
	gc_x86_víd‹
 = 
X86_VENDOR_INTEL
,

507 
˝u_dev_ªgi°î
(
öãl_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<löux/öô.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/˝u.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/k8.h
>

22 
	#LVL_1_INST
 1

	)

23 
	#LVL_1_DATA
 2

	)

24 
	#LVL_2
 3

	)

25 
	#LVL_3
 4

	)

26 
	#LVL_TRACE
 5

	)

28 
	s_ˇche_èbÀ


30 
	mdes¸ùt‹
;

31 
	mˇche_ty≥
;

32 
	msize
;

36 c⁄° 
_ˇche_èbÀ
 
__˝uöôc⁄°
 
	gˇche_èbÀ
[] =

38 { 0x06, 
LVL_1_INST
, 8 },

39 { 0x08, 
LVL_1_INST
, 16 },

40 { 0x09, 
LVL_1_INST
, 32 },

41 { 0x0a, 
LVL_1_DATA
, 8 },

42 { 0x0c, 
LVL_1_DATA
, 16 },

43 { 0x0d, 
LVL_1_DATA
, 16 },

44 { 0x21, 
LVL_2
, 256 },

45 { 0x22, 
LVL_3
, 512 },

46 { 0x23, 
LVL_3
, 1024 },

47 { 0x25, 
LVL_3
, 2048 },

48 { 0x29, 
LVL_3
, 4096 },

49 { 0x2c, 
LVL_1_DATA
, 32 },

50 { 0x30, 
LVL_1_INST
, 32 },

51 { 0x39, 
LVL_2
, 128 },

52 { 0x3a, 
LVL_2
, 192 },

53 { 0x3b, 
LVL_2
, 128 },

54 { 0x3c, 
LVL_2
, 256 },

55 { 0x3d, 
LVL_2
, 384 },

56 { 0x3e, 
LVL_2
, 512 },

57 { 0x3f, 
LVL_2
, 256 },

58 { 0x41, 
LVL_2
, 128 },

59 { 0x42, 
LVL_2
, 256 },

60 { 0x43, 
LVL_2
, 512 },

61 { 0x44, 
LVL_2
, 1024 },

62 { 0x45, 
LVL_2
, 2048 },

63 { 0x46, 
LVL_3
, 4096 },

64 { 0x47, 
LVL_3
, 8192 },

65 { 0x49, 
LVL_3
, 4096 },

66 { 0x4a, 
LVL_3
, 6144 },

67 { 0x4b, 
LVL_3
, 8192 },

68 { 0x4c, 
LVL_3
, 12288 },

69 { 0x4d, 
LVL_3
, 16384 },

70 { 0x4e, 
LVL_2
, 6144 },

71 { 0x60, 
LVL_1_DATA
, 16 },

72 { 0x66, 
LVL_1_DATA
, 8 },

73 { 0x67, 
LVL_1_DATA
, 16 },

74 { 0x68, 
LVL_1_DATA
, 32 },

75 { 0x70, 
LVL_TRACE
, 12 },

76 { 0x71, 
LVL_TRACE
, 16 },

77 { 0x72, 
LVL_TRACE
, 32 },

78 { 0x73, 
LVL_TRACE
, 64 },

79 { 0x78, 
LVL_2
, 1024 },

80 { 0x79, 
LVL_2
, 128 },

81 { 0x7a, 
LVL_2
, 256 },

82 { 0x7b, 
LVL_2
, 512 },

83 { 0x7c, 
LVL_2
, 1024 },

84 { 0x7d, 
LVL_2
, 2048 },

85 { 0x7f, 
LVL_2
, 512 },

86 { 0x82, 
LVL_2
, 256 },

87 { 0x83, 
LVL_2
, 512 },

88 { 0x84, 
LVL_2
, 1024 },

89 { 0x85, 
LVL_2
, 2048 },

90 { 0x86, 
LVL_2
, 512 },

91 { 0x87, 
LVL_2
, 1024 },

92 { 0xd0, 
LVL_3
, 512 },

93 { 0xd1, 
LVL_3
, 1024 },

94 { 0xd2, 
LVL_3
, 2048 },

95 { 0xd6, 
LVL_3
, 1024 },

96 { 0xd7, 
LVL_3
, 2038 },

97 { 0xd8, 
LVL_3
, 4096 },

98 { 0xdc, 
LVL_3
, 2048 },

99 { 0xdd, 
LVL_3
, 4096 },

100 { 0xde, 
LVL_3
, 8192 },

101 { 0xe2, 
LVL_3
, 2048 },

102 { 0xe3, 
LVL_3
, 4096 },

103 { 0xe4, 
LVL_3
, 8192 },

108 
	e_ˇche_ty≥


110 
	mCACHE_TYPE_NULL
 = 0,

111 
	mCACHE_TYPE_DATA
 = 1,

112 
	mCACHE_TYPE_INST
 = 2,

113 
	mCACHE_TYPE_UNIFIED
 = 3

116 
	u_˝uid4_Àaf_óx
 {

118 
_ˇche_ty≥
 
	mty≥
:5;

119 
	mÀvñ
:3;

120 
	mis_£lf_öôülizög
:1;

121 
	mis_fuŒy_assocütive
:1;

122 
	mª£rved
:4;

123 
	mnum_thªads_sh¨ög
:12;

124 
	mnum_c‹es_⁄_dõ
:6;

125 } 
	m•lô
;

126 
u32
 
	mfuŒ
;

129 
	u_˝uid4_Àaf_ebx
 {

131 
	mcohîícy_löe_size
:12;

132 
	mphysiˇl_löe_∑πôi⁄
:10;

133 
	mways_of_assocütivôy
:10;

134 } 
	m•lô
;

135 
u32
 
	mfuŒ
;

138 
	u_˝uid4_Àaf_ecx
 {

140 
	mnumbî_of_£ts
:32;

141 } 
	m•lô
;

142 
u32
 
	mfuŒ
;

145 
	s_˝uid4_öfo
 {

146 
_˝uid4_Àaf_óx
 
	móx
;

147 
_˝uid4_Àaf_ebx
 
	mebx
;

148 
_˝uid4_Àaf_ecx
 
	mecx
;

149 
	msize
;

150 
	mˇn_dißbÀ
;

151 
DECLARE_BITMAP
(
sh¨ed_˝u_m≠
, 
NR_CPUS
);

155 
	s_˝uid4_öfo_ªgs
 {

156 
_˝uid4_Àaf_óx
 
	móx
;

157 
_˝uid4_Àaf_ebx
 
	mebx
;

158 
_˝uid4_Àaf_ecx
 
	mecx
;

159 
	msize
;

160 
	mˇn_dißbÀ
;

163 
	gnum_ˇche_Àaves
;

171 
	ul1_ˇche
 {

173 
	mlöe_size
 : 8;

174 
	mlöes_≥r_èg
 : 8;

175 
	massoc
 : 8;

176 
	msize_ö_kb
 : 8;

178 
	mvÆ
;

181 
	ul2_ˇche
 {

183 
	mlöe_size
 : 8;

184 
	mlöes_≥r_èg
 : 4;

185 
	massoc
 : 4;

186 
	msize_ö_kb
 : 16;

188 
	mvÆ
;

191 
	ul3_ˇche
 {

193 
	mlöe_size
 : 8;

194 
	mlöes_≥r_èg
 : 4;

195 
	massoc
 : 4;

196 
	mªs
 : 2;

197 
	msize_ícoded
 : 14;

199 
	mvÆ
;

202 c⁄° 
__˝uöôc⁄°
 
	gassocs
[] = {

216 c⁄° 
__˝uöôc⁄°
 
	gÀvñs
[] = { 1, 1, 2, 3 };

217 c⁄° 
__˝uöôc⁄°
 
	gty≥s
[] = { 1, 2, 3, 3 };

219 
__˝uöô


220 
	$amd_˝uid4
(
Àaf
, 
_˝uid4_Àaf_óx
 *
óx
,

221 
_˝uid4_Àaf_ebx
 *
ebx
,

222 
_˝uid4_Àaf_ecx
 *
ecx
)

224 
dummy
;

225 
löe_size
, 
löes_≥r_èg
, 
assoc
, 
size_ö_kb
;

226 
l1_ˇche
 
l1i
, 
l1d
;

227 
l2_ˇche
 
l2
;

228 
l3_ˇche
 
l3
;

229 
l1_ˇche
 *
l1
 = &
l1d
;

231 
óx
->
fuŒ
 = 0;

232 
ebx
->
fuŒ
 = 0;

233 
ecx
->
fuŒ
 = 0;

235 
	`˝uid
(0x80000005, &
dummy
, &dummy, &
l1d
.
vÆ
, &
l1i
.val);

236 
	`˝uid
(0x80000006, &
dummy
, &dummy, &
l2
.
vÆ
, &
l3
.val);

238 
Àaf
) {

240 
l1
 = &
l1i
;

242 i‡(!
l1
->
vÆ
)

244 
assoc
 = 
l1
->assoc;

245 
löe_size
 = 
l1
->line_size;

246 
löes_≥r_èg
 = 
l1
->lines_per_tag;

247 
size_ö_kb
 = 
l1
->size_in_kb;

250 i‡(!
l2
.
vÆ
)

252 
assoc
 = 
l2
.assoc;

253 
löe_size
 = 
l2
.line_size;

254 
löes_≥r_èg
 = 
l2
.lines_per_tag;

256 
size_ö_kb
 = 
cuºít_˝u_d©a
.
x86_ˇche_size
;

259 i‡(!
l3
.
vÆ
)

261 
assoc
 = 
l3
.assoc;

262 
löe_size
 = 
l3
.line_size;

263 
löes_≥r_èg
 = 
l3
.lines_per_tag;

264 
size_ö_kb
 = 
l3
.
size_ícoded
 * 512;

270 
óx
->
•lô
.
is_£lf_öôülizög
 = 1;

271 
óx
->
•lô
.
ty≥
 = 
ty≥s
[
Àaf
];

272 
óx
->
•lô
.
Àvñ
 = 
Àvñs
[
Àaf
];

273 i‡(
Àaf
 == 3)

274 
óx
->
•lô
.
num_thªads_sh¨ög
 =

275 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

277 
óx
->
•lô
.
num_thªads_sh¨ög
 = 0;

278 
óx
->
•lô
.
num_c‹es_⁄_dõ
 = 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

281 i‡(
assoc
 == 0xf)

282 
óx
->
•lô
.
is_fuŒy_assocütive
 = 1;

283 
ebx
->
•lô
.
cohîícy_löe_size
 = 
löe_size
 - 1;

284 
ebx
->
•lô
.
ways_of_assocütivôy
 = 
assocs
[
assoc
] - 1;

285 
ebx
->
•lô
.
physiˇl_löe_∑πôi⁄
 = 
löes_≥r_èg
 - 1;

286 
ecx
->
•lô
.
numbî_of_£ts
 = (
size_ö_kb
 * 1024Ë/ 
löe_size
 /

287 (
ebx
->
•lô
.
ways_of_assocütivôy
 + 1) - 1;

288 
	}
}

290 
__˝uöô


291 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

293 i‡(
ödex
 < 3)

296 i‡(
boŸ_˝u_d©a
.
x86
 == 0x11)

300 i‡((
boŸ_˝u_d©a
.
x86
 =0x10Ë&& (boŸ_˝u_d©a.
x86_modñ
 < 0x8))

303 
this_Àaf
->
ˇn_dißbÀ
 = 1;

304 
	}
}

307 
__˝uöô
 
	$˝uid4_ˇche_lookup_ªgs
(
ödex
,

308 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

310 
_˝uid4_Àaf_óx
 
óx
;

311 
_˝uid4_Àaf_ebx
 
ebx
;

312 
_˝uid4_Àaf_ecx
 
ecx
;

313 
edx
;

315 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) {

316 
	`amd_˝uid4
(
ödex
, &
óx
, &
ebx
, &
ecx
);

317 i‡(
boŸ_˝u_d©a
.
x86
 >= 0x10)

318 
	`amd_check_l3_dißbÀ
(
ödex
, 
this_Àaf
);

320 
	`˝uid_cou¡
(4, 
ödex
, &
óx
.
fuŒ
, &
ebx
.fuŒ, &
ecx
.fuŒ, &
edx
);

323 i‡(
óx
.
•lô
.
ty≥
 =
CACHE_TYPE_NULL
)

324  -
EIO
;

326 
this_Àaf
->
óx
 =Éax;

327 
this_Àaf
->
ebx
 =Ébx;

328 
this_Àaf
->
ecx
 =Écx;

329 
this_Àaf
->
size
 = (
ecx
.
•lô
.
numbî_of_£ts
 + 1) *

330 (
ebx
.
•lô
.
cohîícy_löe_size
 + 1) *

331 (
ebx
.
•lô
.
physiˇl_löe_∑πôi⁄
 + 1) *

332 (
ebx
.
•lô
.
ways_of_assocütivôy
 + 1);

334 
	}
}

336 
__˝uöô
 
	$föd_num_ˇche_Àaves
()

338 
óx
, 
ebx
, 
ecx
, 
edx
;

339 
_˝uid4_Àaf_óx
 
ˇche_óx
;

340 
i
 = -1;

343 ++
i
;

345 
	`˝uid_cou¡
(4, 
i
, &
óx
, &
ebx
, &
ecx
, &
edx
);

346 
ˇche_óx
.
fuŒ
 = 
óx
;

347 } 
ˇche_óx
.
•lô
.
ty≥
 !
CACHE_TYPE_NULL
);

348  
i
;

349 
	}
}

351 
__˝uöô
 
	$öô_öãl_ˇcheöfo
(
˝uöfo_x86
 *
c
)

353 
åa˚
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

354 
√w_l1d
 = 0, 
√w_l1i
 = 0;

355 
√w_l2
 = 0, 
√w_l3
 = 0, 
i
;

356 
l2_id
 = 0, 
l3_id
 = 0, 
num_thªads_sh¨ög
, 
ödex_msb
;

357 #ifde‡
CONFIG_X86_HT


358 
˝u
 = 
c
->
˝u_ödex
;

361 i‡(
c
->
˝uid_Àvñ
 > 3) {

362 
is_öôülized
;

364 i‡(
is_öôülized
 == 0) {

366 
num_ˇche_Àaves
 = 
	`föd_num_ˇche_Àaves
();

367 
is_öôülized
++;

374 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

375 
_˝uid4_öfo_ªgs
 
this_Àaf
;

376 
ªtvÆ
;

378 
ªtvÆ
 = 
	`˝uid4_ˇche_lookup_ªgs
(
i
, &
this_Àaf
);

379 i‡(
ªtvÆ
 >= 0) {

380 
this_Àaf
.
óx
.
•lô
.
Àvñ
) {

382 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

383 
CACHE_TYPE_DATA
)

384 
√w_l1d
 = 
this_Àaf
.
size
/1024;

385 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

386 
CACHE_TYPE_INST
)

387 
√w_l1i
 = 
this_Àaf
.
size
/1024;

390 
√w_l2
 = 
this_Àaf
.
size
/1024;

391 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

392 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

393 
l2_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

396 
√w_l3
 = 
this_Àaf
.
size
/1024;

397 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

398 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

399 
l3_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

411 i‡((
num_ˇche_Àaves
 =0 || 
c
->
x86
 =15Ë&& c->
˝uid_Àvñ
 > 1) {

413 
j
, 
n
;

414 
ªgs
[4];

415 *
dp
 = (*)
ªgs
;

416 
⁄ly_åa˚
 = 0;

418 i‡(
num_ˇche_Àaves
 !0 && 
c
->
x86
 == 15)

419 
⁄ly_åa˚
 = 1;

422 
n
 = 
	`˝uid_óx
(2) & 0xFF;

424  
i
 = 0 ; i < 
n
 ; i++ ) {

425 
	`˝uid
(2, &
ªgs
[0], &regs[1], &regs[2], &regs[3]);

428  
j
 = 0 ; j < 3 ; j++ ) {

429 i‡(
ªgs
[
j
] & (1 << 31))Ñegs[j] = 0;

433  
j
 = 1 ; j < 16 ; j++ ) {

434 
des
 = 
dp
[
j
];

435 
k
 = 0;

438 
ˇche_èbÀ
[
k
].
des¸ùt‹
 != 0)

440 i‡(
ˇche_èbÀ
[
k
].
des¸ùt‹
 =
des
) {

441 i‡(
⁄ly_åa˚
 && 
ˇche_èbÀ
[
k
].
ˇche_ty≥
 !
LVL_TRACE
)

443 
ˇche_èbÀ
[
k
].
ˇche_ty≥
) {

444 
LVL_1_INST
:

445 
l1i
 +
ˇche_èbÀ
[
k
].
size
;

447 
LVL_1_DATA
:

448 
l1d
 +
ˇche_èbÀ
[
k
].
size
;

450 
LVL_2
:

451 
l2
 +
ˇche_èbÀ
[
k
].
size
;

453 
LVL_3
:

454 
l3
 +
ˇche_èbÀ
[
k
].
size
;

456 
LVL_TRACE
:

457 
åa˚
 +
ˇche_èbÀ
[
k
].
size
;

464 
k
++;

470 i‡(
√w_l1d
)

471 
l1d
 = 
√w_l1d
;

473 i‡(
√w_l1i
)

474 
l1i
 = 
√w_l1i
;

476 i‡(
√w_l2
) {

477 
l2
 = 
√w_l2
;

478 #ifde‡
CONFIG_X86_HT


479 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l2_id
;

483 i‡(
√w_l3
) {

484 
l3
 = 
√w_l3
;

485 #ifde‡
CONFIG_X86_HT


486 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l3_id
;

490 i‡(
åa˚
)

491 
	`¥ötk
 (
KERN_INFO
 "CPU: Tø˚ cache: %dK u›s", 
åa˚
);

492 i‡–
l1i
 )

493 
	`¥ötk
 (
KERN_INFO
 "CPU: L1 I cache: %dK", 
l1i
);

495 i‡(
l1d
)

496 
	`¥ötk
(", L1 D cache: %dK\n", 
l1d
);

498 
	`¥ötk
("\n");

500 i‡(
l2
)

501 
	`¥ötk
(
KERN_INFO
 "CPU: L2 cache: %dK\n", 
l2
);

503 i‡(
l3
)

504 
	`¥ötk
(
KERN_INFO
 "CPU: L3 cache: %dK\n", 
l3
);

506 
c
->
x86_ˇche_size
 = 
l3
 ?Ü3 : (
l2
 ?Ü2 : (
l1i
+
l1d
));

508  
l2
;

509 
	}
}

511 #ifde‡
CONFIG_SYSFS


514 
DEFINE_PER_CPU
(
_˝uid4_öfo
 *, 
˝uid4_öfo
);

515 
	#CPUID4_INFO_IDX
(
x
, 
y
Ë(&((
	`≥r_˝u
(
˝uid4_öfo
, x))[y]))

	)

517 #ifde‡
CONFIG_SMP


518 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

520 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

521 
num_thªads_sh¨ög
;

522 
ödex_msb
, 
i
;

523 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

525 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

526 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
->
óx
.
•lô
.num_threads_sharing;

528 i‡(
num_thªads_sh¨ög
 == 1)

529 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

531 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

533 
	`f‹_óch_⁄löe_˝u
(
i
) {

534 i‡(
	`˝u_d©a
(
i
).
≠icid
 >> 
ödex_msb
 ==

535 
c
->
≠icid
 >> 
ödex_msb
) {

536 
	`˝umask_£t_˝u
(
i
,

537 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

538 i‡(
i
 !
˝u
 && 
	`≥r_˝u
(
˝uid4_öfo
, i)) {

539 
siblög_Àaf
 =

540 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

541 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(

542 
siblög_Àaf
->
sh¨ed_˝u_m≠
));

547 
	}
}

548 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

550 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

551 
siblög
;

553 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

554 
	`f‹_óch_˝u
(
siblög
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
)) {

555 
siblög_Àaf
 = 
	`CPUID4_INFO_IDX
(
siblög
, 
ödex
);

556 
	`˝umask_˛ór_˝u
(
˝u
,

557 
	`to_˝umask
(
siblög_Àaf
->
sh¨ed_˝u_m≠
));

559 
	}
}

561 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
Ë{
	}
}

562 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
Ë{
	}
}

565 
__˝uöô
 
	$‰ì_ˇche_©åibuãs
(
˝u
)

567 
i
;

569 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

570 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

572 
	`k‰ì
(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
));

573 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
NULL
;

574 
	}
}

577 
__˝uöô
 
	$˝uid4_ˇche_lookup
(
ödex
, 
_˝uid4_öfo
 *
this_Àaf
)

579 
_˝uid4_öfo_ªgs
 *
Àaf_ªgs
 =

580 (
_˝uid4_öfo_ªgs
 *)
this_Àaf
;

582  
	`˝uid4_ˇche_lookup_ªgs
(
ödex
, 
Àaf_ªgs
);

583 
	}
}

585 
__˝uöô
 
	$gë_˝u_Àaves
(*
_ªtvÆ
)

587 
j
, *
ªtvÆ
 = 
_ªtvÆ
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

590 
j
 = 0; j < 
num_ˇche_Àaves
; j++) {

591 
_˝uid4_öfo
 *
this_Àaf
;

592 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
j
);

593 *
ªtvÆ
 = 
	`˝uid4_ˇche_lookup
(
j
, 
this_Àaf
);

594 i‡(
	`u∆ikñy
(*
ªtvÆ
 < 0)) {

595 
i
;

597 
i
 = 0; i < 
j
; i++)

598 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

601 
	`ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
j
);

603 
	}
}

605 
__˝uöô
 
	$dëe˘_ˇche_©åibuãs
(
˝u
)

607 
ªtvÆ
;

609 i‡(
num_ˇche_Àaves
 == 0)

610  -
ENOENT
;

612 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
	`kzÆloc
(

613 (
_˝uid4_öfo
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

614 i‡(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë=
NULL
)

615  -
ENOMEM
;

617 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
gë_˝u_Àaves
, &
ªtvÆ
, 
åue
);

618 i‡(
ªtvÆ
) {

619 
	`k‰ì
(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
));

620 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
NULL
;

623  
ªtvÆ
;

624 
	}
}

626 
	~<löux/kobje˘.h
>

627 
	~<löux/sysfs.h
>

629 
sysdev_˛ass
 
˝u_sysdev_˛ass
;

632 
DEFINE_PER_CPU
(
kobje˘
 *, 
ˇche_kobje˘
);

634 
	s_ödex_kobje˘
 {

635 
kobje˘
 
	mkobj
;

636 
	m˝u
;

637 
	mödex
;

641 
DEFINE_PER_CPU
(
_ödex_kobje˘
 *, 
ödex_kobje˘
);

642 
	#INDEX_KOBJECT_PTR
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ödex_kobje˘
, x))[y]))

	)

644 
	#show_⁄e_∂us
(
fûe_«me
, 
obje˘
, 
vÆ
) \

645 
ssize_t
 
show_
##
fûe_«me
 \

646 (
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

648  
	`•rötf
 (
buf
, "%lu\n", ()
this_Àaf
->
obje˘
 + 
vÆ
); \

649 }

	)

651 
show_⁄e_∂us
(
Àvñ
, 
óx
.
•lô
.level, 0);

652 
show_⁄e_∂us
(
cohîícy_löe_size
, 
ebx
.
•lô
.coherency_line_size, 1);

653 
show_⁄e_∂us
(
physiˇl_löe_∑πôi⁄
, 
ebx
.
•lô
.physical_line_partition, 1);

654 
show_⁄e_∂us
(
ways_of_assocütivôy
, 
ebx
.
•lô
.ways_of_associativity, 1);

655 
show_⁄e_∂us
(
numbî_of_£ts
, 
ecx
.
•lô
.number_of_sets, 1);

657 
ssize_t
 
	$show_size
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

659  
	`•rötf
 (
buf
, "%luK\n", 
this_Àaf
->
size
 / 1024);

660 
	}
}

662 
ssize_t
 
	$show_sh¨ed_˝u_m≠_func
(
_˝uid4_öfo
 *
this_Àaf
,

663 
ty≥
, *
buf
)

665 
±rdiff_t
 
Àn
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

666 
n
 = 0;

668 i‡(
Àn
 > 1) {

669 c⁄° 
˝umask
 *
mask
;

671 
mask
 = 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
);

672 
n
 = 
ty≥
?

673 
	`˝uli°_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
) :

674 
	`˝umask_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
);

675 
buf
[
n
++] = '\n';

676 
buf
[
n
] = '\0';

678  
n
;

679 
	}
}

681 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_m≠
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

683  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 0, 
buf
);

684 
	}
}

686 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_li°
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

688  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 1, 
buf
);

689 
	}
}

691 
ssize_t
 
	$show_ty≥
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

693 
this_Àaf
->
óx
.
•lô
.
ty≥
) {

694 
CACHE_TYPE_DATA
:

695  
	`•rötf
(
buf
, "Data\n");

696 
CACHE_TYPE_INST
:

697  
	`•rötf
(
buf
, "Instruction\n");

698 
CACHE_TYPE_UNIFIED
:

699  
	`•rötf
(
buf
, "Unified\n");

701  
	`•rötf
(
buf
, "Unknown\n");

703 
	}
}

705 
	#to_obje˘
(
k
Ë
	`c⁄èöî_of
(k, 
_ödex_kobje˘
, 
kobj
)

	)

706 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
_ˇche_©å
, 
©å
)

	)

708 
ssize_t
 
	$show_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
,

709 
ödex
)

711 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

712 
node
 = 
	`˝u_to_node
(
˝u
);

713 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

714 
ªg
 = 0;

716 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

717  -
EINVAL
;

719 i‡(!
dev
)

720  -
EINVAL
;

722 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, &
ªg
);

723  
	`•rötf
(
buf
, "%x\n", 
ªg
);

724 
	}
}

726 
	#SHOW_CACHE_DISABLE
(
ödex
) \

727 
ssize_t
 \

728 
show_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

730  
	`show_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
ödex
); \

731 }

	)

732 
	$SHOW_CACHE_DISABLE
(0)

733 
	$SHOW_CACHE_DISABLE
(1)

735 
ssize_t
 
	$°‹e_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
,

736 c⁄° *
buf
, 
size_t
 
cou¡
, 
ödex
)

738 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

739 
node
 = 
	`˝u_to_node
(
˝u
);

740 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

741 
vÆ
 = 0;

742 
s¸ubbî
 = 0;

744 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

745  -
EINVAL
;

747 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

748  -
EPERM
;

750 i‡(!
dev
)

751  -
EINVAL
;

753 i‡(
	`°ri˘_°πoul
(
buf
, 10, &
vÆ
) < 0)

754  -
EINVAL
;

756 
vÆ
 |= 0xc0000000;

758 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x58, &
s¸ubbî
);

759 
s¸ubbî
 &= ~0x1f000000;

760 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x58, 
s¸ubbî
);

762 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
 & ~0x40000000);

763 
	`wbövd
();

764 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
);

765  
cou¡
;

766 
	}
}

768 
	#STORE_CACHE_DISABLE
(
ödex
) \

769 
ssize_t
 \

770 
°‹e_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, \

771 c⁄° *
buf
, 
size_t
 
cou¡
) \

773  
	`°‹e_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
cou¡
, 
ödex
); \

774 }

	)

775 
	$STORE_CACHE_DISABLE
(0)

776 
	$STORE_CACHE_DISABLE
(1)

778 
	s_ˇche_©å
 {

779 
©åibuã
 
©å
;

780 
	`ssize_t
 (*
show
)(
_˝uid4_öfo
 *, *);

781 
	`ssize_t
 (*
°‹e
)(
_˝uid4_öfo
 *, c⁄° *, 
size_t
 
cou¡
);

784 
	#deföe_⁄e_ro
(
_«me
) \

785 
_ˇche_©å
 
_«me
 = \

786 
	`__ATTR
(
_«me
, 0444, 
show_
##_«me, 
NULL
)

	)

788 
	`deföe_⁄e_ro
(
Àvñ
);

789 
	`deföe_⁄e_ro
(
ty≥
);

790 
	`deföe_⁄e_ro
(
cohîícy_löe_size
);

791 
	`deföe_⁄e_ro
(
physiˇl_löe_∑πôi⁄
);

792 
	`deföe_⁄e_ro
(
ways_of_assocütivôy
);

793 
	`deföe_⁄e_ro
(
numbî_of_£ts
);

794 
	`deföe_⁄e_ro
(
size
);

795 
	`deföe_⁄e_ro
(
sh¨ed_˝u_m≠
);

796 
	`deföe_⁄e_ro
(
sh¨ed_˝u_li°
);

798 
_ˇche_©å
 
ˇche_dißbÀ_0
 = 
	`__ATTR
(cache_disable_0, 0644,

799 
show_ˇche_dißbÀ_0
, 
°‹e_ˇche_dißbÀ_0
);

800 
_ˇche_©å
 
ˇche_dißbÀ_1
 = 
	`__ATTR
(cache_disable_1, 0644,

801 
show_ˇche_dißbÀ_1
, 
°‹e_ˇche_dißbÀ_1
);

803 
©åibuã
 * 
deÁu…_©ås
[] = {

804 &
ty≥
.
©å
,

805 &
Àvñ
.
©å
,

806 &
cohîícy_löe_size
.
©å
,

807 &
physiˇl_löe_∑πôi⁄
.
©å
,

808 &
ways_of_assocütivôy
.
©å
,

809 &
numbî_of_£ts
.
©å
,

810 &
size
.
©å
,

811 &
sh¨ed_˝u_m≠
.
©å
,

812 &
sh¨ed_˝u_li°
.
©å
,

813 &
ˇche_dißbÀ_0
.
©å
,

814 &
ˇche_dißbÀ_1
.
©å
,

815 
NULL


816 
	}
};

818 
ssize_t
 
	$show
(
kobje˘
 * 
kobj
, 
©åibuã
 * 
©å
, * 
buf
)

820 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

821 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

822 
ssize_t
 
ªt
;

824 
ªt
 = 
Áâr
->
show
 ?

825 
Áâr
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

826 
buf
) :

828  
ªt
;

829 
	}
}

831 
ssize_t
 
	$°‹e
(
kobje˘
 * 
kobj
, 
©åibuã
 * 
©å
,

832 c⁄° * 
buf
, 
size_t
 
cou¡
)

834 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

835 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

836 
ssize_t
 
ªt
;

838 
ªt
 = 
Áâr
->
°‹e
 ?

839 
Áâr
->
	`°‹e
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

840 
buf
, 
cou¡
) :

842  
ªt
;

843 
	}
}

845 
sysfs_›s
 
	gsysfs_›s
 = {

846 .
show
 = show,

847 .
	g°‹e
 = 
°‹e
,

850 
kobj_ty≥
 
	gkty≥_ˇche
 = {

851 .
sysfs_›s
 = &sysfs_ops,

852 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

855 
kobj_ty≥
 
	gkty≥_≥r˝u_íåy
 = {

856 .
sysfs_›s
 = &sysfs_ops,

859 
__˝uöô
 
	$˝uid4_ˇche_sysfs_exô
(
˝u
)

861 
	`k‰ì
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

862 
	`k‰ì
(
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
));

863 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
Ë
NULL
;

864 
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë
NULL
;

865 
	`‰ì_ˇche_©åibuãs
(
˝u
);

866 
	}
}

868 
__˝uöô
 
	$˝uid4_ˇche_sysfs_öô
(
˝u
)

870 
îr
;

872 i‡(
num_ˇche_Àaves
 == 0)

873  -
ENOENT
;

875 
îr
 = 
	`dëe˘_ˇche_©åibuãs
(
˝u
);

876 i‡(
îr
)

877  
îr
;

880 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
) =

881 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

882 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
Ë=
NULL
))

883 
îr_out
;

885 
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë
	`kzÆloc
(

886 (
_ödex_kobje˘
 ) * 
num_ˇche_Àaves
, 
GFP_KERNEL
);

887 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë=
NULL
))

888 
îr_out
;

892 
îr_out
:

893 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

894  -
ENOMEM
;

895 
	}
}

897 
DECLARE_BITMAP
(
ˇche_dev_m≠
, 
NR_CPUS
);

900 
__˝uöô
 
	$ˇche_add_dev
(
sys_devi˚
 * 
sys_dev
)

902 
˝u
 = 
sys_dev
->
id
;

903 
i
, 
j
;

904 
_ödex_kobje˘
 *
this_obje˘
;

905 
ªtvÆ
;

907 
ªtvÆ
 = 
	`˝uid4_ˇche_sysfs_öô
(
˝u
);

908 i‡(
	`u∆ikñy
(
ªtvÆ
 < 0))

909  
ªtvÆ
;

911 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
),

912 &
kty≥_≥r˝u_íåy
,

913 &
sys_dev
->
kobj
, "%s", "cache");

914 i‡(
ªtvÆ
 < 0) {

915 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

916  
ªtvÆ
;

919 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

920 
this_obje˘
 = 
	`INDEX_KOBJECT_PTR
(
˝u
,
i
);

921 
this_obje˘
->
˝u
 = cpu;

922 
this_obje˘
->
ödex
 = 
i
;

923 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(&(
this_obje˘
->
kobj
),

924 &
kty≥_ˇche
,

925 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
),

926 "ödex%1lu", 
i
);

927 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

928 
j
 = 0; j < 
i
; j++) {

929 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
,
j
)->
kobj
));

931 
	`kobje˘_put
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

932 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

933  
ªtvÆ
;

935 
	`kobje˘_uevít
(&(
this_obje˘
->
kobj
), 
KOBJ_ADD
);

937 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

939 
	`kobje˘_uevít
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
), 
KOBJ_ADD
);

941 
	}
}

943 
__˝uöô
 
	$ˇche_ªmove_dev
(
sys_devi˚
 * 
sys_dev
)

945 
˝u
 = 
sys_dev
->
id
;

946 
i
;

948 i‡(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë=
NULL
)

950 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
)))

952 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

954 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

955 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
,
i
)->
kobj
));

956 
	`kobje˘_put
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

957 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

958 
	}
}

960 
__˝uöô
 
	$ˇcheöfo_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

961 
a˘i⁄
, *
h˝u
)

963 
˝u
 = ()
h˝u
;

964 
sys_devi˚
 *
sys_dev
;

966 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

967 
a˘i⁄
) {

968 
CPU_ONLINE
:

969 
CPU_ONLINE_FROZEN
:

970 
	`ˇche_add_dev
(
sys_dev
);

972 
CPU_DEAD
:

973 
CPU_DEAD_FROZEN
:

974 
	`ˇche_ªmove_dev
(
sys_dev
);

977  
NOTIFY_OK
;

978 
	}
}

980 
nŸifõr_block
 
__˝uöôd©a
 
	gˇcheöfo_˝u_nŸifõr
 =

982 .
nŸifõr_ˇŒ
 = 
ˇcheöfo_˝u_ˇŒback
,

985 
__˝uöô
 
	$ˇche_sysfs_öô
()

987 
i
;

989 i‡(
num_ˇche_Àaves
 == 0)

992 
	`f‹_óch_⁄löe_˝u
(
i
) {

993 
îr
;

994 
sys_devi˚
 *
sys_dev
 = 
	`gë_˝u_sysdev
(
i
);

996 
îr
 = 
	`ˇche_add_dev
(
sys_dev
);

997 i‡(
îr
)

998  
îr
;

1000 
	`ªgi°î_hŸ˝u_nŸifõr
(&
ˇcheöfo_˝u_nŸifõr
);

1002 
	}
}

1004 
devi˚_öôˇŒ
(
ˇche_sysfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/debugfs.h
>

16 
	~<asm/m˚.h
>

18 
	~"m˚-öã∫Æ.h
"

32 
	ec⁄ãxt
 { 
	mIN_KERNEL
 = 1, 
	mIN_USER
 = 2 };

33 
	e£r
 { 
	mSER_REQUIRED
 = 1, 
	mNO_SER
 = 2 };

35 
	s£vîôy
 {

36 
u64
 
	mmask
;

37 
u64
 
	mªsu…
;

38 
	m£v
;

39 
	mmcgmask
;

40 
	mmcgªs
;

41 
	m£r
;

42 
	mc⁄ãxt
;

43 
	mcovîed
;

44 *
	mmsg
;

45 } 
	g£vîôõs
[] = {

46 
	#KERNEL
 .
c⁄ãxt
 = 
IN_KERNEL


	)

47 
	#USER
 .
c⁄ãxt
 = 
IN_USER


	)

48 
	#SER
 .
£r
 = 
SER_REQUIRED


	)

49 
	#NOSER
 .
£r
 = 
NO_SER


	)

50 
	#SEV
(
s
Ë.
£v
 = 
MCE_
 ## s ## 
_SEVERITY


	)

51 
	#BITCLR
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = 0, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

52 
	#BITSET
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = x, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

53 
	#MCGMASK
(
x
, 
ªs
, 
s
, 
m
, 
r
...) \

54 { .
mcgmask
 = 
x
, .
mcgªs
 = 
ªs
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

55 
	#MASK
(
x
, 
y
, 
s
, 
m
, 
r
...) \

56 { .
mask
 = 
x
, .
ªsu…
 = 
y
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

57 
	#MCI_UC_S
 (
MCI_STATUS_UC
|
MCI_STATUS_S
)

	)

58 
	#MCI_UC_SAR
 (
MCI_STATUS_UC
|
MCI_STATUS_S
|
MCI_STATUS_AR
)

	)

59 
	#MCACOD
 0xffff

	)

61 
BITCLR
(
MCI_STATUS_VAL
, 
NO
, "Invalid"),

62 
BITCLR
(
MCI_STATUS_EN
, 
NO
, "NotÉnabled"),

63 
BITSET
(
MCI_STATUS_PCC
, 
PANIC
, "Processor context corrupt"),

65 
MCGMASK
(
MCG_STATUS_MCIP
, 0, 
PANIC
, "MCIPÇot set in MCA handler"),

67 
MCGMASK
(
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
, 0, 
PANIC
,

69 
MCGMASK
(
MCG_STATUS_RIPV
, 0, 
PANIC
, "In kernelándÇoÑestart IP",

70 
KERNEL
),

71 
BITCLR
(
MCI_STATUS_UC
, 
KEEP
, "C‹ª˘edÉº‹", 
NOSER
),

72 
MASK
(
MCI_STATUS_OVER
|
MCI_STATUS_UC
|
MCI_STATUS_EN
, MCI_STATUS_UC, 
SOME
,

73 "Spuriou†nŸÉ«bÀd", 
SER
),

76 
MASK
(
MCI_UC_SAR
, 
MCI_STATUS_UC
, 
KEEP
,

77 "Unc‹ª˘edÇÿa˘i⁄Ñequúed", 
SER
),

78 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_STATUS_UC
|
MCI_STATUS_AR
, 
PANIC
,

79 "IŒegÆ combö©i⁄ (UCNA wôh AR=1)", 
SER
),

80 
MASK
(
MCI_STATUS_S
, 0, 
KEEP
, "N⁄ sig«Œed machöêcheck", 
SER
),

83 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, MCI_STATUS_OVER|MCI_UC_SAR, 
PANIC
,

84 "A˘i⁄Ñequúed wôhÜo°Évíts", 
SER
),

85 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
|
MCACOD
, MCI_UC_SAR, 
PANIC
,

86 "A˘i⁄Ñequúed; unknow¿MCACOD", 
SER
),

89 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|0xfff0, 
MCI_UC_S
|0xc0, 
AO
,

90 "A˘i⁄ o±i⁄Æ: mem‹y s¸ubbögÉº‹", 
SER
),

91 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|
MCACOD
, 
MCI_UC_S
|0x17a, 
AO
,

92 "A˘i⁄ o±i⁄Æ:Üa°Üevñ cachêwrôebackÉº‹", 
SER
),

94 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
, 
SOME
,

95 "A˘i⁄ o±i⁄Æ unknow¿MCACOD", 
SER
),

96 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
|MCI_STATUS_OVER, 
SOME
,

97 "A˘i⁄ o±i⁄Æ wôhÜo°Évíts", 
SER
),

98 
BITSET
(
MCI_STATUS_UC
|
MCI_STATUS_OVER
, 
PANIC
, "Overflowed uncorrected"),

99 
BITSET
(
MCI_STATUS_UC
, 
UC
, "Uncorrected"),

100 
BITSET
(0, 
SOME
, "No match")

107 
	$îr‹_c⁄ãxt
(
m˚
 *
m
)

109 i‡(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
)

110  (
m
->
ù
 && (m->
cs
 & 3Ë=3Ë? 
IN_USER
 : 
IN_KERNEL
;

112  
IN_KERNEL
;

113 
	}
}

115 
	$m˚_£vîôy
(
m˚
 *
a
, 
tﬁî™t
, **
msg
)

117 
c⁄ãxt
 
˘x
 = 
	`îr‹_c⁄ãxt
(
a
);

118 
£vîôy
 *
s
;

120 
s
 = 
£vîôõs
;; s++) {

121 i‡((
a
->
°©us
 & 
s
->
mask
Ë!s->
ªsu…
)

123 i‡((
a
->
mcg°©us
 & 
s
->
mcgmask
Ë!s->
mcgªs
)

125 i‡(
s
->
£r
 =
SER_REQUIRED
 && !
m˚_£r
)

127 i‡(
s
->
£r
 =
NO_SER
 && 
m˚_£r
)

129 i‡(
s
->
c⁄ãxt
 && 
˘x
 != s->context)

131 i‡(
msg
)

132 *
msg
 = 
s
->msg;

133 
s
->
covîed
 = 1;

134 i‡(
s
->
£v
 >
MCE_UC_SEVERITY
 && 
˘x
 =
IN_KERNEL
) {

135 i‡(
∑nic_⁄_o›s
 || 
tﬁî™t
 < 1)

136  
MCE_PANIC_SEVERITY
;

138  
s
->
£v
;

140 
	}
}

142 *
	$s_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

144 i‡(*
pos
 >
	`ARRAY_SIZE
(
£vîôõs
))

145  
NULL
;

146  &
£vîôõs
[*
pos
];

147 
	}
}

149 *
	$s_√xt
(
£q_fûe
 *
f
, *
d©a
, 
loff_t
 *
pos
)

151 i‡(++(*
pos
Ë>
	`ARRAY_SIZE
(
£vîôõs
))

152  
NULL
;

153  &
£vîôõs
[*
pos
];

154 
	}
}

156 
	$s_°›
(
£q_fûe
 *
f
, *
d©a
)

158 
	}
}

160 
	$s_show
(
£q_fûe
 *
f
, *
d©a
)

162 
£vîôy
 *
£r
 = 
d©a
;

163 
	`£q_¥ötf
(
f
, "%d\t%s\n", 
£r
->
covîed
, sî->
msg
);

165 
	}
}

167 c⁄° 
£q_›î©i⁄s
 
	g£vîôõs_£q_›s
 = {

168 .
°¨t
 = 
s_°¨t
,

169 .
	g√xt
 = 
s_√xt
,

170 .
	g°›
 = 
s_°›
,

171 .
	gshow
 = 
s_show
,

174 
	$£vîôõs_covîage_›í
(
öode
 *öode, 
fûe
 *file)

176  
	`£q_›í
(
fûe
, &
£vîôõs_£q_›s
);

177 
	}
}

179 
ssize_t
 
	$£vîôõs_covîage_wrôe
(
fûe
 *file,

180 c⁄° 
__u£r
 *
ubuf
,

181 
size_t
 
cou¡
, 
loff_t
 *
µos
)

183 
i
;

184 
i
 = 0; i < 
	`ARRAY_SIZE
(
£vîôõs
); i++)

185 
£vîôõs
[
i
].
covîed
 = 0;

186  
cou¡
;

187 
	}
}

189 c⁄° 
fûe_›î©i⁄s
 
	g£vîôõs_covîage_f›s
 = {

190 .
›í
 = 
£vîôõs_covîage_›í
,

191 .
	gªÀa£
 = 
£q_ªÀa£
,

192 .
	gªad
 = 
£q_ªad
,

193 .
	gwrôe
 = 
£vîôõs_covîage_wrôe
,

196 
__öô
 
	$£vîôõs_debugfs_öô
()

198 
díåy
 *
dm˚
 = 
NULL
, *
f£vîôõs_covîage
 = NULL;

200 
dm˚
 = 
	`debugfs_¸óã_dú
("m˚", 
NULL
);

201 i‡(
dm˚
 =
NULL
)

202 
îr_out
;

203 
f£vîôõs_covîage
 = 
	`debugfs_¸óã_fûe
("severities-coverage",

204 0444, 
dm˚
, 
NULL
,

205 &
£vîôõs_covîage_f›s
);

206 i‡(
f£vîôõs_covîage
 =
NULL
)

207 
îr_out
;

211 
îr_out
:

212 i‡(
f£vîôõs_covîage
)

213 
	`debugfs_ªmove
(
f£vîôõs_covîage
);

214 i‡(
dm˚
)

215 
	`debugfs_ªmove
(
dm˚
);

216  -
ENOMEM
;

217 
	}
}

218 
œã_öôˇŒ
(
£vîôõs_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c

10 
	~<löux/thªad_öfo.h
>

11 
	~<löux/ˇ∑bûôy.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/kÆlsyms.h
>

16 
	~<löux/rcupd©e.h
>

17 
	~<löux/kobje˘.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≥r˝u.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/sysdev.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/˘y≥.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/sysfs.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/öô.h
>

30 
	~<löux/kmod.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/nmi.h
>

33 
	~<löux/˝u.h
>

34 
	~<löux/smp.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/¥o˚ss‹.h
>

39 
	~<asm/hw_úq.h
>

40 
	~<asm/≠ic.h
>

41 
	~<asm/idÀ.h
>

42 
	~<asm/ùi.h
>

43 
	~<asm/m˚.h
>

44 
	~<asm/m§.h
>

46 
	~"m˚-öã∫Æ.h
"

49 
	$u√x≥˘ed_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

51 
	`¥ötk
(
KERN_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

52 
	`smp_¥o˚ss‹_id
());

53 
	}
}

56 (*
machöe_check_ve˘‹
)(
±_ªgs
 *, 
îr‹_code
) =

57 
u√x≥˘ed_machöe_check
;

59 
m˚_dißbÀd
 
__ªad_mo°ly
;

61 #ifde‡
CONFIG_X86_NEW_MCE


63 
	#MISC_MCELOG_MINOR
 227

	)

65 
	#SPINUNIT
 100

	)

67 
©omic_t
 
m˚_íåy
;

69 
	`DEFINE_PER_CPU
(, 
m˚_ex˚±i⁄_cou¡
);

78 
tﬁî™t
 
__ªad_mo°ly
 = 1;

79 
b™ks
 
__ªad_mo°ly
;

80 
u64
 *
b™k
 
__ªad_mo°ly
;

81 
rù_m§
 
__ªad_mo°ly
;

82 
m˚_boŸlog
 
__ªad_mo°ly
 = -1;

83 
m⁄¨ch_timeout
 
__ªad_mo°ly
 = -1;

84 
m˚_∑nic_timeout
 
__ªad_mo°ly
;

85 
m˚_d⁄t_log_˚
 
__ªad_mo°ly
;

86 
m˚_cmci_dißbÀd
 
__ªad_mo°ly
;

87 
m˚_ign‹e_˚
 
__ªad_mo°ly
;

88 
m˚_£r
 
__ªad_mo°ly
;

91 
m˚_√ed_nŸify
;

92 
m˚_hñ≥r
[128];

93 *
m˚_hñ≥r_¨gv
[2] = { 
m˚_hñ≥r
, 
NULL
 
	}
};

95 
	gd⁄t_öô_b™ks
;

97 
DECLARE_WAIT_QUEUE_HEAD
(
m˚_waô
);

98 
DEFINE_PER_CPU
(
m˚
, 
m˚s_£í
);

99 
	g˝u_missög
;

103 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_pﬁl_b™ks
) = {

104 [0 ... 
BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

107 
ölöe
 
	$skù_b™k_öô
(
i
)

109  
i
 < 
BITS_PER_LONG
 && 
	`ã°_bô
(i, &
d⁄t_öô_b™ks
);

110 
	}
}

112 
DEFINE_PER_CPU
(
w‹k_°ru˘
, 
m˚_w‹k
);

115 
	$m˚_£tup
(
m˚
 *
m
)

117 
	`mem£t
(
m
, 0, (
m˚
));

118 
m
->
˝u
 = m->
ext˝u
 = 
	`smp_¥o˚ss‹_id
();

119 
	`rdts˛l
(
m
->
tsc
);

121 
m
->
time
 = 
	`gë_£c⁄ds
();

122 
m
->
˝uvíd‹
 = 
boŸ_˝u_d©a
.
x86_víd‹
;

123 
m
->
˝uid
 = 
	`˝uid_óx
(1);

124 #ifde‡
CONFIG_SMP


125 
m
->
sockëid
 = 
	`˝u_d©a
(m->
ext˝u
).
phys_¥oc_id
;

127 
m
->
≠icid
 = 
	`˝u_d©a
(m->
ext˝u
).
öôül_≠icid
;

128 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
m
->
mcgˇp
);

129 
	}
}

131 
DEFINE_PER_CPU
(
m˚
, 
öje˘m
);

132 
EXPORT_PER_CPU_SYMBOL_GPL
(
öje˘m
);

140 
m˚_log
 
	gm˚log
 = {

141 .
sig«tuª
 = 
MCE_LOG_SIGNATURE
,

142 .
	gÀn
 = 
MCE_LOG_LEN
,

143 .
	gªc‹dÀn
 = (
m˚
),

146 
	$m˚_log
(
m˚
 *mce)

148 
√xt
, 
íåy
;

150 
m˚
->
föished
 = 0;

151 
	`wmb
();

153 
íåy
 = 
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
);

160 i‡(
íåy
 >
MCE_LOG_LEN
) {

161 
	`£t_bô
(
MCE_OVERFLOW
,

162 (*)&
m˚log
.
Êags
);

166 i‡(
m˚log
.
íåy
[íåy].
föished
) {

167 
íåy
++;

172 
	`smp_rmb
();

173 
√xt
 = 
íåy
 + 1;

174 i‡(
	`cmpxchg
(&
m˚log
.
√xt
, 
íåy
,Çext) ==Éntry)

177 
	`mem˝y
(
m˚log
.
íåy
 +É¡ry, 
m˚
, (mce));

178 
	`wmb
();

179 
m˚log
.
íåy
[íåy].
föished
 = 1;

180 
	`wmb
();

182 
m˚
->
föished
 = 1;

183 
	`£t_bô
(0, &
m˚_√ed_nŸify
);

184 
	}
}

186 
	$¥öt_m˚
(
m˚
 *
m
)

188 
	`¥ötk
(
KERN_EMERG


190 
m
->
ext˝u
, m->
mcg°©us
, m->
b™k
, m->
°©us
);

191 i‡(
m
->
ù
) {

192 
	`¥ötk
(
KERN_EMERG
 "RIP%s %02x:<%016Lx> ",

193 !(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

194 
m
->
cs
, m->
ù
);

195 i‡(
m
->
cs
 =
__KERNEL_CS
)

196 
	`¥öt_symbﬁ
("{%s}", 
m
->
ù
);

197 
	`¥ötk
(
KERN_CONT
 "\n");

199 
	`¥ötk
(
KERN_EMERG
 "TSC %Œx ", 
m
->
tsc
);

200 i‡(
m
->
addr
)

201 
	`¥ötk
(
KERN_CONT
 "ADDR %Œx ", 
m
->
addr
);

202 i‡(
m
->
misc
)

203 
	`¥ötk
(
KERN_CONT
 "MISC %Œx ", 
m
->
misc
);

204 
	`¥ötk
(
KERN_CONT
 "\n");

205 
	`¥ötk
(
KERN_EMERG
 "PROCESSOR %u:%x TIME %llu SOCKET %u APIC %x\n",

206 
m
->
˝uvíd‹
, m->
˝uid
, m->
time
, m->
sockëid
,

207 
m
->
≠icid
);

208 
	}
}

210 
	$¥öt_m˚_hód
()

212 
	`¥ötk
(
KERN_EMERG
 "\nHARDWARE ERROR\n");

213 
	}
}

215 
	$¥öt_m˚_èû
()

217 
	`¥ötk
(
KERN_EMERG
 "This isÇotá softwareÖroblem!\n"

219 
	}
}

221 
	#PANIC_TIMEOUT
 5

	)

223 
©omic_t
 
	gm˚_∑ni˚d
;

226 
	$waô_f‹_∑nic
()

228 
timeout
 = 
PANIC_TIMEOUT
*
USEC_PER_SEC
;

229 
	`¥ìm±_dißbÀ
();

230 
	`loˇl_úq_íabÀ
();

231 
timeout
-- > 0)

232 
	`udñay
(1);

233 i‡(
∑nic_timeout
 == 0)

234 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

235 
	`∑nic
("Panicing machine check CPU died");

236 
	}
}

238 
	$m˚_∑nic
(*
msg
, 
m˚
 *
föÆ
, *
exp
)

240 
i
;

245 i‡(
	`©omic_add_ªtu∫
(1, &
m˚_∑ni˚d
) > 1)

246 
	`waô_f‹_∑nic
();

247 
	`b¨rõr
();

249 
	`bu°_•ölocks
(1);

250 
	`c⁄sﬁe_vîbo£
();

251 
	`¥öt_m˚_hód
();

253 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

254 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

255 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

257 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

258 
	`¥öt_m˚
(
m
);

261 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

262 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

263 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

265 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

267 i‡(!
föÆ
 || 
	`memcmp
(
m
, föÆ, (
m˚
)))

268 
	`¥öt_m˚
(
m
);

270 i‡(
föÆ
)

271 
	`¥öt_m˚
(
föÆ
);

272 i‡(
˝u_missög
)

273 
	`¥ötk
(
KERN_EMERG
 "Some CPUs didn'tánswer in synchronization\n");

274 
	`¥öt_m˚_èû
();

275 i‡(
exp
)

276 
	`¥ötk
(
KERN_EMERG
 "Machöêcheck: %s\n", 
exp
);

277 i‡(
∑nic_timeout
 == 0)

278 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

279 
	`∑nic
(
msg
);

280 
	}
}

284 
	$m§_to_off£t
(
u32
 
m§
)

286 
b™k
 = 
	`__gë_˝u_v¨
(
öje˘m
.bank);

287 i‡(
m§
 =
rù_m§
)

288  
	`off£tof
(
m˚
, 
ù
);

289 i‡(
m§
 =
MSR_IA32_MC0_STATUS
 + 
b™k
*4)

290  
	`off£tof
(
m˚
, 
°©us
);

291 i‡(
m§
 =
MSR_IA32_MC0_ADDR
 + 
b™k
*4)

292  
	`off£tof
(
m˚
, 
addr
);

293 i‡(
m§
 =
MSR_IA32_MC0_MISC
 + 
b™k
*4)

294  
	`off£tof
(
m˚
, 
misc
);

295 i‡(
m§
 =
MSR_IA32_MCG_STATUS
)

296  
	`off£tof
(
m˚
, 
mcg°©us
);

298 
	}
}

301 
u64
 
	$m˚_rdm§l
(
u32
 
m§
)

303 
u64
 
v
;

304 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

305 
off£t
 = 
	`m§_to_off£t
(
m§
);

306 i‡(
off£t
 < 0)

308  *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
);

310 
	`rdm§l
(
m§
, 
v
);

311  
v
;

312 
	}
}

314 
	$m˚_wrm§l
(
u32
 
m§
, 
u64
 
v
)

316 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

317 
off£t
 = 
	`m§_to_off£t
(
m§
);

318 i‡(
off£t
 >= 0)

319 *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
Ë
v
;

322 
	`wrm§l
(
m§
, 
v
);

323 
	}
}

330 
	#MCE_RING_SIZE
 16

	)

332 
	sm˚_rög
 {

333 
	m°¨t
;

334 
	míd
;

335 
	mrög
[
MCE_RING_SIZE
];

337 
DEFINE_PER_CPU
(
m˚_rög
, mce_ring);

340 
	$m˚_rög_em±y
()

342 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

344  
r
->
°¨t
 =r->
íd
;

345 
	}
}

347 
	$m˚_rög_gë
(*
p‚
)

349 
m˚_rög
 *
r
;

350 
ªt
 = 0;

352 *
p‚
 = 0;

353 
	`gë_˝u
();

354 
r
 = &
	`__gë_˝u_v¨
(
m˚_rög
);

355 i‡(
r
->
°¨t
 =r->
íd
)

356 
out
;

357 *
p‚
 = 
r
->
rög
[r->
°¨t
];

358 
r
->
°¨t
 = (r->°¨à+ 1Ë% 
MCE_RING_SIZE
;

359 
ªt
 = 1;

360 
out
:

361 
	`put_˝u
();

362  
ªt
;

363 
	}
}

366 
	$m˚_rög_add
(
p‚
)

368 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

369 
√xt
;

371 
√xt
 = (
r
->
íd
 + 1Ë% 
MCE_RING_SIZE
;

372 i‡(
√xt
 =
r
->
°¨t
)

374 
r
->
rög
[r->
íd
] = 
p‚
;

375 
	`wmb
();

376 
r
->
íd
 = 
√xt
;

378 
	}
}

380 
	$m˚_avaûabÀ
(
˝uöfo_x86
 *
c
)

382 i‡(
m˚_dißbÀd
)

384  
	`˝u_has
(
c
, 
X86_FEATURE_MCE
Ë&& cpu_has(c, 
X86_FEATURE_MCA
);

385 
	}
}

387 
	$m˚_scheduÀ_w‹k
()

389 i‡(!
	`m˚_rög_em±y
()) {

390 
w‹k_°ru˘
 *
w‹k
 = &
	`__gë_˝u_v¨
(
m˚_w‹k
);

391 i‡(!
	`w‹k_≥ndög
(
w‹k
))

392 
	`scheduÀ_w‹k
(
w‹k
);

394 
	}
}

400 
ölöe
 
	$m˚_gë_rù
(
m˚
 *
m
, 
±_ªgs
 *
ªgs
)

403 i‡(
ªgs
 && (
m
->
mcg°©us
 & (
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
))) {

404 
m
->
ù
 = 
ªgs
->ip;

405 
m
->
cs
 = 
ªgs
->cs;

407 
m
->
ù
 = 0;

408 
m
->
cs
 = 0;

410 i‡(
rù_m§
)

411 
m
->
ù
 = 
	`m˚_rdm§l
(
rù_m§
);

412 
	}
}

414 #ifde‡
CONFIG_X86_LOCAL_APIC


420 
asmlökage
 
	$smp_m˚_£lf_öãºu±
(
±_ªgs
 *
ªgs
)

422 
	`ack_APIC_úq
();

423 
	`exô_idÀ
();

424 
	`úq_íãr
();

425 
	`m˚_nŸify_úq
();

426 
	`m˚_scheduÀ_w‹k
();

427 
	`úq_exô
();

428 
	}
}

431 
	$m˚_ªp‹t_evít
(
±_ªgs
 *
ªgs
)

433 i‡(
ªgs
->
Êags
 & (
X86_VM_MASK
|
X86_EFLAGS_IF
)) {

434 
	`m˚_nŸify_úq
();

441 
	`m˚_scheduÀ_w‹k
();

445 #ifde‡
CONFIG_X86_LOCAL_APIC


450 i‡(!
˝u_has_≠ic
)

459 
≠ic
->
	`£nd_IPI_£lf
(
MCE_SELF_VECTOR
);

466 
	`≠ic_waô_i¸_idÀ
();

468 
	}
}

470 
DEFINE_PER_CPU
(, 
m˚_pﬁl_cou¡
);

487 
	$machöe_check_pﬁl
(
m˝_Êags
 
Êags
, 
m˚_b™ks_t
 *
b
)

489 
m˚
 
m
;

490 
i
;

492 
	`__gë_˝u_v¨
(
m˚_pﬁl_cou¡
)++;

494 
	`m˚_£tup
(&
m
);

496 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

497 
i
 = 0; i < 
b™ks
; i++) {

498 i‡(!
b™k
[
i
] || !
	`ã°_bô
(i, *
b
))

501 
m
.
misc
 = 0;

502 
m
.
addr
 = 0;

503 
m
.
b™k
 = 
i
;

504 
m
.
tsc
 = 0;

506 
	`b¨rõr
();

507 
m
.
°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_STATUS
 + 
i
*4);

508 i‡(!(
m
.
°©us
 & 
MCI_STATUS_VAL
))

517 i‡(!(
Êags
 & 
MCP_UC
) &&

518 (
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)))

521 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

522 
m
.
misc
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_MISC
 + 
i
*4);

523 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

524 
m
.
addr
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_ADDR
 + 
i
*4);

526 i‡(!(
Êags
 & 
MCP_TIMESTAMP
))

527 
m
.
tsc
 = 0;

532 i‡(!(
Êags
 & 
MCP_DONTLOG
Ë&& !
m˚_d⁄t_log_˚
) {

533 
	`m˚_log
(&
m
);

534 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

540 
	`m˚_wrm§l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

548 
	`sync_c‹e
();

549 
	}
}

550 
EXPORT_SYMBOL_GPL
(
machöe_check_pﬁl
);

556 
	$m˚_no_way_out
(
m˚
 *
m
, **
msg
)

558 
i
;

560 
i
 = 0; i < 
b™ks
; i++) {

561 
m
->
°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_STATUS
 + 
i
*4);

562 i‡(
	`m˚_£vîôy
(
m
, 
tﬁî™t
, 
msg
Ë>
MCE_PANIC_SEVERITY
)

566 
	}
}

572 
©omic_t
 
	gm˚_executög
;

577 
©omic_t
 
	gm˚_ˇŒö
;

582 
	$m˚_timed_out
(
u64
 *
t
)

590 
	`rmb
();

591 i‡(
	`©omic_ªad
(&
m˚_∑ni˚d
))

592 
	`waô_f‹_∑nic
();

593 i‡(!
m⁄¨ch_timeout
)

594 
out
;

595 i‡((
s64
)*
t
 < 
SPINUNIT
) {

597 i‡(
tﬁî™t
 < 1)

598 
	`m˚_∑nic
("Timeout synchronizing machine check over CPUs",

599 
NULL
, NULL);

600 
˝u_missög
 = 1;

603 *
t
 -
SPINUNIT
;

604 
out
:

605 
	`touch_nmi_w©chdog
();

607 
	}
}

633 
	$m˚_ªign
()

635 
˝u
;

636 
m˚
 *
m
 = 
NULL
;

637 
globÆ_w‹°
 = 0;

638 *
msg
 = 
NULL
;

639 *
nmsg
 = 
NULL
;

646 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

647 
£vîôy
 = 
	`m˚_£vîôy
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 
tﬁî™t
,

648 &
nmsg
);

649 i‡(
£vîôy
 > 
globÆ_w‹°
) {

650 
msg
 = 
nmsg
;

651 
globÆ_w‹°
 = 
£vîôy
;

652 
m
 = &
	`≥r_˝u
(
m˚s_£í
, 
˝u
);

661 i‡(
m
 && 
globÆ_w‹°
 >
MCE_PANIC_SEVERITY
 && 
tﬁî™t
 < 3)

662 
	`m˚_∑nic
("F©Æ Machöêcheck", 
m
, 
msg
);

674 i‡(!
m
 && 
tﬁî™t
 < 3)

675 
	`m˚_∑nic
("Machöêcheck from unknow¿sour˚", 
NULL
, NULL);

681 
	`f‹_óch_possibÀ_˝u
(
˝u
)

682 
	`mem£t
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 0, (
m˚
));

683 
	}
}

685 
©omic_t
 
	gglobÆ_nwo
;

694 
	$m˚_°¨t
(*
no_way_out
)

696 
‹dî
;

697 
˝us
 = 
	`num_⁄löe_˝us
();

698 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

700 i‡(!
timeout
)

703 
	`©omic_add
(*
no_way_out
, &
globÆ_nwo
);

707 
	`smp_wmb
();

708 
‹dî
 = 
	`©omic_add_ªtu∫
(1, &
m˚_ˇŒö
);

713 
	`©omic_ªad
(&
m˚_ˇŒö
Ë!
˝us
) {

714 i‡(
	`m˚_timed_out
(&
timeout
)) {

715 
	`©omic_£t
(&
globÆ_nwo
, 0);

718 
	`ndñay
(
SPINUNIT
);

724 
	`smp_rmb
();

726 i‡(
‹dî
 == 1) {

730 
	`©omic_£t
(&
m˚_executög
, 1);

738 
	`©omic_ªad
(&
m˚_executög
Ë< 
‹dî
) {

739 i‡(
	`m˚_timed_out
(&
timeout
)) {

740 
	`©omic_£t
(&
globÆ_nwo
, 0);

743 
	`ndñay
(
SPINUNIT
);

750 *
no_way_out
 = 
	`©omic_ªad
(&
globÆ_nwo
);

752  
‹dî
;

753 
	}
}

759 
	$m˚_íd
(
‹dî
)

761 
ªt
 = -1;

762 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

764 i‡(!
timeout
)

765 
ª£t
;

766 i‡(
‹dî
 < 0)

767 
ª£t
;

772 
	`©omic_öc
(&
m˚_executög
);

774 i‡(
‹dî
 == 1) {

776 
˝us
 = 
	`num_⁄löe_˝us
();

782 
	`©omic_ªad
(&
m˚_executög
Ë<
˝us
) {

783 i‡(
	`m˚_timed_out
(&
timeout
))

784 
ª£t
;

785 
	`ndñay
(
SPINUNIT
);

788 
	`m˚_ªign
();

789 
	`b¨rõr
();

790 
ªt
 = 0;

795 
	`©omic_ªad
(&
m˚_executög
) != 0) {

796 i‡(
	`m˚_timed_out
(&
timeout
))

797 
ª£t
;

798 
	`ndñay
(
SPINUNIT
);

810 
ª£t
:

811 
	`©omic_£t
(&
globÆ_nwo
, 0);

812 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

813 
	`b¨rõr
();

818 
	`©omic_£t
(&
m˚_executög
, 0);

819  
ªt
;

820 
	}
}

828 
	$m˚_ußbÀ_addªss
(
m˚
 *
m
)

830 i‡(!(
m
->
°©us
 & 
MCI_STATUS_MISCV
Ë|| !(m->°©u†& 
MCI_STATUS_ADDRV
))

832 i‡((
m
->
misc
 & 0x3fË> 
PAGE_SHIFT
)

834 i‡(((
m
->
misc
 >> 6Ë& 7Ë!
MCM_ADDR_PHYS
)

837 
	}
}

839 
	$m˚_˛ór_°©e
(*
to˛ór
)

841 
i
;

843 
i
 = 0; i < 
b™ks
; i++) {

844 i‡(
	`ã°_bô
(
i
, 
to˛ór
))

845 
	`m˚_wrm§l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

847 
	}
}

861 
	$do_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

863 
m˚
 
m
, *
föÆ
;

864 
i
;

865 
w‹°
 = 0;

866 
£vîôy
;

871 
‹dî
;

876 
no_way_out
 = 0;

881 
kûl_ô
 = 0;

882 
	`DECLARE_BITMAP
(
to˛ór
, 
MAX_NR_BANKS
);

883 *
msg
 = "Unknown";

885 
	`©omic_öc
(&
m˚_íåy
);

887 
	`__gë_˝u_v¨
(
m˚_ex˚±i⁄_cou¡
)++;

889 i‡(
	`nŸify_dõ
(
DIE_NMI
, "machöêcheck", 
ªgs
, 
îr‹_code
,

890 18, 
SIGKILL
Ë=
NOTIFY_STOP
)

891 
out
;

892 i‡(!
b™ks
)

893 
out
;

895 
	`m˚_£tup
(&
m
);

897 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

898 
no_way_out
 = 
	`m˚_no_way_out
(&
m
, &
msg
);

900 
föÆ
 = &
	`__gë_˝u_v¨
(
m˚s_£í
);

901 *
föÆ
 = 
m
;

903 
	`b¨rõr
();

908 i‡(!(
m
.
mcg°©us
 & 
MCG_STATUS_RIPV
))

909 
kûl_ô
 = 1;

916 
‹dî
 = 
	`m˚_°¨t
(&
no_way_out
);

917 
i
 = 0; i < 
b™ks
; i++) {

918 
	`__˛ór_bô
(
i
, 
to˛ór
);

919 i‡(!
b™k
[
i
])

922 
m
.
misc
 = 0;

923 
m
.
addr
 = 0;

924 
m
.
b™k
 = 
i
;

926 
m
.
°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_STATUS
 + 
i
*4);

927 i‡((
m
.
°©us
 & 
MCI_STATUS_VAL
) == 0)

934 i‡(!(
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)) &&

935 !
no_way_out
)

941 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

943 
£vîôy
 = 
	`m˚_£vîôy
(&
m
, 
tﬁî™t
, 
NULL
);

949 i‡(
£vîôy
 =
MCE_KEEP_SEVERITY
 && !
no_way_out
)

951 
	`__£t_bô
(
i
, 
to˛ór
);

952 i‡(
£vîôy
 =
MCE_NO_SEVERITY
) {

963 i‡(
£vîôy
 =
MCE_AR_SEVERITY
)

964 
kûl_ô
 = 1;

966 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

967 
m
.
misc
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_MISC
 + 
i
*4);

968 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

969 
m
.
addr
 = 
	`m˚_rdm§l
(
MSR_IA32_MC0_ADDR
 + 
i
*4);

978 i‡(
£vîôy
 =
MCE_AO_SEVERITY
 && 
	`m˚_ußbÀ_addªss
(&
m
))

979 
	`m˚_rög_add
(
m
.
addr
 >> 
PAGE_SHIFT
);

981 
	`m˚_gë_rù
(&
m
, 
ªgs
);

982 
	`m˚_log
(&
m
);

984 i‡(
£vîôy
 > 
w‹°
) {

985 *
föÆ
 = 
m
;

986 
w‹°
 = 
£vîôy
;

990 i‡(!
no_way_out
)

991 
	`m˚_˛ór_°©e
(
to˛ór
);

997 i‡(
	`m˚_íd
(
‹dî
) < 0)

998 
no_way_out
 = 
w‹°
 >
MCE_PANIC_SEVERITY
;

1007 i‡(
no_way_out
 && 
tﬁî™t
 < 3)

1008 
	`m˚_∑nic
("F©Æ machöêcheck o¿cuºíàCPU", 
föÆ
, 
msg
);

1017 i‡(
kûl_ô
 && 
tﬁî™t
 < 3)

1018 
	`f‹˚_sig
(
SIGBUS
, 
cuºít
);

1021 
	`£t_thªad_Êag
(
TIF_MCE_NOTIFY
);

1023 i‡(
w‹°
 > 0)

1024 
	`m˚_ªp‹t_evít
(
ªgs
);

1025 
	`m˚_wrm§l
(
MSR_IA32_MCG_STATUS
, 0);

1026 
out
:

1027 
	`©omic_dec
(&
m˚_íåy
);

1028 
	`sync_c‹e
();

1029 
	}
}

1030 
EXPORT_SYMBOL_GPL
(
do_machöe_check
);

1033 
__©åibuã__
((
wók
)Ë
	$mem‹y_Áûuª
(
p‚
, 
ve˘‹
)

1035 
	`¥ötk
(
KERN_ERR
 "A˘i⁄ o±i⁄Æ mem‹y faûuªáà%lx ign‹ed\n", 
p‚
);

1036 
	}
}

1049 
	$m˚_nŸify_¥o˚ss
()

1051 
p‚
;

1052 
	`m˚_nŸify_úq
();

1053 
	`m˚_rög_gë
(&
p‚
))

1054 
	`mem‹y_Áûuª
(
p‚
, 
MCE_VECTOR
);

1055 
	}
}

1057 
	$m˚_¥o˚ss_w‹k
(
w‹k_°ru˘
 *
dummy
)

1059 
	`m˚_nŸify_¥o˚ss
();

1060 
	}
}

1062 #ifde‡
CONFIG_X86_MCE_INTEL


1076 
	$m˚_log_thîm_thrŸ_evít
(
__u64
 
°©us
)

1078 
m˚
 
m
;

1080 
	`m˚_£tup
(&
m
);

1081 
m
.
b™k
 = 
MCE_THERMAL_BANK
;

1082 
m
.
°©us
 = status;

1083 
	`m˚_log
(&
m
);

1084 
	}
}

1092 
	gcheck_öãrvÆ
 = 5 * 60;

1094 
DEFINE_PER_CPU
(, 
√xt_öãrvÆ
);

1095 
DEFINE_PER_CPU
(
timî_li°
, 
m˚_timî
);

1097 
	$mcheck_timî
(
d©a
)

1099 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
d©a
);

1100 *
n
;

1102 
	`WARN_ON
(
	`smp_¥o˚ss‹_id
(Ë!
d©a
);

1104 i‡(
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
)) {

1105 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

1106 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

1113 
n
 = &
	`__gë_˝u_v¨
(
√xt_öãrvÆ
);

1114 i‡(
	`m˚_nŸify_úq
())

1115 *
n
 = 
	`max
(*n/2, 
HZ
/100);

1117 *
n
 = 
	`mö
(*n*2, ()
	`round_jiffõs_ªœtive
(
check_öãrvÆ
*
HZ
));

1119 
t
->
expúes
 = 
jiffõs
 + *
n
;

1120 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1121 
	}
}

1123 
	$m˚_do_åiggî
(
w‹k_°ru˘
 *
w‹k
)

1125 
	`ˇŒ_u£rmodehñ≥r
(
m˚_hñ≥r
, 
m˚_hñ≥r_¨gv
, 
NULL
, 
UMH_NO_WAIT
);

1126 
	}
}

1128 
DECLARE_WORK
(
m˚_åiggî_w‹k
, 
m˚_do_åiggî
);

1135 
	$m˚_nŸify_úq
()

1138 
	`DEFINE_RATELIMIT_STATE
(
øãlimô
, 60*
HZ
, 2);

1140 
	`˛ór_thªad_Êag
(
TIF_MCE_NOTIFY
);

1142 i‡(
	`ã°_™d_˛ór_bô
(0, &
m˚_√ed_nŸify
)) {

1143 
	`wake_up_öãºu±ibÀ
(&
m˚_waô
);

1150 i‡(
m˚_hñ≥r
[0] && !
	`w‹k_≥ndög
(&
m˚_åiggî_w‹k
))

1151 
	`scheduÀ_w‹k
(&
m˚_åiggî_w‹k
);

1153 i‡(
	`__øãlimô
(&
øãlimô
))

1154 
	`¥ötk
(
KERN_INFO
 "Machine checkÉventsÜogged\n");

1159 
	}
}

1160 
EXPORT_SYMBOL_GPL
(
m˚_nŸify_úq
);

1165 
	$m˚_ˇp_öô
()

1167 
b
;

1168 
u64
 
ˇp
;

1170 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1172 
b
 = 
ˇp
 & 
MCG_BANKCNT_MASK
;

1173 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
b
);

1175 i‡(
b
 > 
MAX_NR_BANKS
) {

1176 
	`¥ötk
(
KERN_WARNING


1178 
MAX_NR_BANKS
, 
b
);

1179 
b
 = 
MAX_NR_BANKS
;

1183 
	`WARN_ON
(
b™ks
 !0 && 
b
 != banks);

1184 
b™ks
 = 
b
;

1185 i‡(!
b™k
) {

1186 
b™k
 = 
	`kmÆloc
(
b™ks
 * (
u64
), 
GFP_KERNEL
);

1187 i‡(!
b™k
)

1188  -
ENOMEM
;

1189 
	`mem£t
(
b™k
, 0xff, 
b™ks
 * (
u64
));

1193 i‡((
ˇp
 & 
MCG_EXT_P
Ë&& 
	`MCG_EXT_CNT
(cap) >= 9)

1194 
rù_m§
 = 
MSR_IA32_MCG_EIP
;

1196 i‡(
ˇp
 & 
MCG_SER_P
)

1197 
m˚_£r
 = 1;

1200 
	}
}

1202 
	$m˚_öô
()

1204 
m˚_b™ks_t
 
Æl_b™ks
;

1205 
u64
 
ˇp
;

1206 
i
;

1211 
	`bôm≠_fûl
(
Æl_b™ks
, 
MAX_NR_BANKS
);

1212 
	`machöe_check_pﬁl
(
MCP_UC
|(!
m˚_boŸlog
 ? 
MCP_DONTLOG
 : 0), &
Æl_b™ks
);

1214 
	`£t_ö_¸4
(
X86_CR4_MCE
);

1216 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1217 i‡(
ˇp
 & 
MCG_CTL_P
)

1218 
	`wrm§
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

1220 
i
 = 0; i < 
b™ks
; i++) {

1221 i‡(
	`skù_b™k_öô
(
i
))

1223 
	`wrm§l
(
MSR_IA32_MC0_CTL
+4*
i
, 
b™k
[i]);

1224 
	`wrm§l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

1226 
	}
}

1229 
	$m˚_˝u_quúks
(
˝uöfo_x86
 *
c
)

1231 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_UNKNOWN
) {

1232 
	`¥_öfo
("MCE: unknown CPUÅype -ÇotÉnabling MCE support.\n");

1233  -
EOPNOTSUPP
;

1237 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
) {

1238 i‡(
c
->
x86
 =15 && 
b™ks
 > 4) {

1244 
	`˛ór_bô
(10, (*)&
b™k
[4]);

1246 i‡(
c
->
x86
 <17 && 
m˚_boŸlog
 < 0) {

1251 
m˚_boŸlog
 = 0;

1257 i‡(
c
->
x86
 =6 && 
b™ks
 > 0)

1258 
b™k
[0] = 0;

1261 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

1271 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 0x1A)

1272 
	`__£t_bô
(0, &
d⁄t_öô_b™ks
);

1278 i‡((
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xe)) &&

1279 
m⁄¨ch_timeout
 < 0)

1280 
m⁄¨ch_timeout
 = 
USEC_PER_SEC
;

1286 i‡(
c
->
x86
 =6 && c->
x86_modñ
 <13 && 
m˚_boŸlog
 < 0)

1287 
m˚_boŸlog
 = 0;

1289 i‡(
m⁄¨ch_timeout
 < 0)

1290 
m⁄¨ch_timeout
 = 0;

1291 i‡(
m˚_boŸlog
 != 0)

1292 
m˚_∑nic_timeout
 = 30;

1295 
	}
}

1297 
__˝uöô
 
	$m˚_™cõ¡_öô
(
˝uöfo_x86
 *
c
)

1299 i‡(
c
->
x86
 != 5)

1301 
c
->
x86_víd‹
) {

1302 
X86_VENDOR_INTEL
:

1303 
	`öãl_p5_mcheck_öô
(
c
);

1305 
X86_VENDOR_CENTAUR
:

1306 
	`wöchù_mcheck_öô
(
c
);

1309 
	}
}

1311 
	$m˚_˝u_„©uªs
(
˝uöfo_x86
 *
c
)

1313 
c
->
x86_víd‹
) {

1314 
X86_VENDOR_INTEL
:

1315 
	`m˚_öãl_„©uª_öô
(
c
);

1317 
X86_VENDOR_AMD
:

1318 
	`m˚_amd_„©uª_öô
(
c
);

1323 
	}
}

1325 
	$m˚_öô_timî
()

1327 
timî_li°
 *
t
 = &
	`__gë_˝u_v¨
(
m˚_timî
);

1328 *
n
 = &
	`__gë_˝u_v¨
(
√xt_öãrvÆ
);

1330 i‡(
m˚_ign‹e_˚
)

1333 *
n
 = 
check_öãrvÆ
 * 
HZ
;

1334 i‡(!*
n
)

1336 
	`£tup_timî
(
t
, 
mcheck_timî
, 
	`smp_¥o˚ss‹_id
());

1337 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 + *
n
);

1338 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1339 
	}
}

1345 
__˝uöô
 
	$mcheck_öô
(
˝uöfo_x86
 *
c
)

1347 i‡(
m˚_dißbÀd
)

1350 
	`m˚_™cõ¡_öô
(
c
);

1352 i‡(!
	`m˚_avaûabÀ
(
c
))

1355 i‡(
	`m˚_ˇp_öô
(Ë< 0 || 
	`m˚_˝u_quúks
(
c
) < 0) {

1356 
m˚_dißbÀd
 = 1;

1360 
machöe_check_ve˘‹
 = 
do_machöe_check
;

1362 
	`m˚_öô
();

1363 
	`m˚_˝u_„©uªs
(
c
);

1364 
	`m˚_öô_timî
();

1365 
	`INIT_WORK
(&
	`__gë_˝u_v¨
(
m˚_w‹k
), 
m˚_¥o˚ss_w‹k
);

1366 
	}
}

1372 
DEFINE_SPINLOCK
(
m˚_°©e_lock
);

1373 
	g›í_cou¡
;

1374 
	g›í_ex˛u
;

1376 
	$m˚_›í
(
öode
 *öode, 
fûe
 *file)

1378 
	`•ö_lock
(&
m˚_°©e_lock
);

1380 i‡(
›í_ex˛u
 || (
›í_cou¡
 && (
fûe
->
f_Êags
 & 
O_EXCL
))) {

1381 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1383  -
EBUSY
;

1386 i‡(
fûe
->
f_Êags
 & 
O_EXCL
)

1387 
›í_ex˛u
 = 1;

1388 
›í_cou¡
++;

1390 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1392  
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
);

1393 
	}
}

1395 
	$m˚_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1397 
	`•ö_lock
(&
m˚_°©e_lock
);

1399 
›í_cou¡
--;

1400 
›í_ex˛u
 = 0;

1402 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1405 
	}
}

1407 
	$cﬁÀ˘_tscs
(*
d©a
)

1409 *
˝u_tsc
 = (*)
d©a
;

1411 
	`rdts˛l
(
˝u_tsc
[
	`smp_¥o˚ss‹_id
()]);

1412 
	}
}

1414 
DEFINE_MUTEX
(
m˚_ªad_muãx
);

1416 
ssize_t
 
	$m˚_ªad
(
fûe
 *
fûp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

1417 
loff_t
 *
off
)

1419 
__u£r
 *
buf
 = 
ubuf
;

1420 *
˝u_tsc
;

1421 
¥ev
, 
√xt
;

1422 
i
, 
îr
;

1424 
˝u_tsc
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

1425 i‡(!
˝u_tsc
)

1426  -
ENOMEM
;

1428 
	`muãx_lock
(&
m˚_ªad_muãx
);

1429 
√xt
 = 
	`rcu_dîe„ªn˚
(
m˚log
.next);

1432 i‡(*
off
 !0 || 
usize
 < 
MCE_LOG_LEN
*(
m˚
)) {

1433 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1434 
	`k‰ì
(
˝u_tsc
);

1436  -
EINVAL
;

1439 
îr
 = 0;

1440 
¥ev
 = 0;

1442 
i
 = 
¥ev
; i < 
√xt
; i++) {

1443 
°¨t
 = 
jiffõs
;

1445 !
m˚log
.
íåy
[
i
].
föished
) {

1446 i‡(
	`time_a·î_eq
(
jiffõs
, 
°¨t
 + 2)) {

1447 
	`mem£t
(
m˚log
.
íåy
 + 
i
, 0,

1448 (
m˚
));

1449 
timeout
;

1451 
	`˝u_ªœx
();

1453 
	`smp_rmb
();

1454 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
 + 
i
,

1455 (
m˚
));

1456 
buf
 +(
m˚
);

1457 
timeout
:

1461 
	`mem£t
(
m˚log
.
íåy
 + 
¥ev
, 0,

1462 (
√xt
 - 
¥ev
Ë* (
m˚
));

1463 
¥ev
 = 
√xt
;

1464 
√xt
 = 
	`cmpxchg
(&
m˚log
.√xt, 
¥ev
, 0);

1465 } 
√xt
 !
¥ev
);

1467 
	`synchr⁄ize_sched
();

1473 
	`⁄_óch_˝u
(
cﬁÀ˘_tscs
, 
˝u_tsc
, 1);

1475 
i
 = 
√xt
; i < 
MCE_LOG_LEN
; i++) {

1476 i‡(
m˚log
.
íåy
[
i
].
föished
 &&

1477 
m˚log
.
íåy
[
i
].
tsc
 < 
˝u_tsc
[m˚log.íåy[i].
˝u
]) {

1478 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
+
i
,

1479 (
m˚
));

1480 
	`smp_rmb
();

1481 
buf
 +(
m˚
);

1482 
	`mem£t
(&
m˚log
.
íåy
[
i
], 0, (
m˚
));

1485 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1486 
	`k‰ì
(
˝u_tsc
);

1488  
îr
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

1489 
	}
}

1491 
	$m˚_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

1493 
	`pﬁl_waô
(
fûe
, &
m˚_waô
, 
waô
);

1494 i‡(
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
))

1495  
POLLIN
 | 
POLLRDNORM
;

1497 
	}
}

1499 
	$m˚_io˘l
(
fûe
 *
f
, 
cmd
, 
¨g
)

1501 
__u£r
 *
p
 = (__u£∏*)
¨g
;

1503 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1504  -
EPERM
;

1506 
cmd
) {

1507 
MCE_GET_RECORD_LEN
:

1508  
	`put_u£r
((
m˚
), 
p
);

1509 
MCE_GET_LOG_LEN
:

1510  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

1511 
MCE_GETCLEAR_FLAGS
: {

1512 
Êags
;

1515 
Êags
 = 
m˚log
.flags;

1516 } 
	`cmpxchg
(&
m˚log
.
Êags
, flags, 0) != flags);

1518  
	`put_u£r
(
Êags
, 
p
);

1521  -
ENOTTY
;

1523 
	}
}

1526 
fûe_›î©i⁄s
 
	gm˚_chrdev_›s
 = {

1527 .
›í
 = 
m˚_›í
,

1528 .
	gªÀa£
 = 
m˚_ªÀa£
,

1529 .
	gªad
 = 
m˚_ªad
,

1530 .
	gpﬁl
 = 
m˚_pﬁl
,

1531 .
	gu∆ocked_io˘l
 = 
m˚_io˘l
,

1533 
EXPORT_SYMBOL_GPL
(
m˚_chrdev_›s
);

1535 
miscdevi˚
 
	gm˚_log_devi˚
 = {

1536 
MISC_MCELOG_MINOR
,

1538 &
m˚_chrdev_›s
,

1552 
__öô
 
	$mcheck_íabÀ
(*
°r
)

1554 i‡(*
°r
 == 0)

1555 
	`íabÀ_p5_m˚
();

1556 i‡(*
°r
 == '=')

1557 
°r
++;

1558 i‡(!
	`°rcmp
(
°r
, "off"))

1559 
m˚_dißbÀd
 = 1;

1560 i‡(!
	`°rcmp
(
°r
, "no_cmci"))

1561 
m˚_cmci_dißbÀd
 = 1;

1562 i‡(!
	`°rcmp
(
°r
, "dont_log_ce"))

1563 
m˚_d⁄t_log_˚
 = 1;

1564 i‡(!
	`°rcmp
(
°r
, "ignore_ce"))

1565 
m˚_ign‹e_˚
 = 1;

1566 i‡(!
	`°rcmp
(
°r
, "bootlog") || !strcmp(str, "nobootlog"))

1567 
m˚_boŸlog
 = (
°r
[0] == 'b');

1568 i‡(
	`isdigô
(
°r
[0])) {

1569 
	`gë_›ti⁄
(&
°r
, &
tﬁî™t
);

1570 i‡(*
°r
 == ',') {

1571 ++
°r
;

1572 
	`gë_›ti⁄
(&
°r
, &
m⁄¨ch_timeout
);

1575 
	`¥ötk
(
KERN_INFO
 "mceárgument %s ignored. Please use /sys\n",

1576 
°r
);

1580 
	}
}

1581 
__£tup
("m˚", 
mcheck_íabÀ
);

1591 
	$m˚_dißbÀ
()

1593 
i
;

1595 
i
 = 0; i < 
b™ks
; i++) {

1596 i‡(!
	`skù_b™k_öô
(
i
))

1597 
	`wrm§l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 0);

1600 
	}
}

1602 
	$m˚_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1604  
	`m˚_dißbÀ
();

1605 
	}
}

1607 
	$m˚_shutdown
(
sys_devi˚
 *
dev
)

1609  
	`m˚_dißbÀ
();

1610 
	}
}

1617 
	$m˚_ªsume
(
sys_devi˚
 *
dev
)

1619 
	`m˚_öô
();

1620 
	`m˚_˝u_„©uªs
(&
cuºít_˝u_d©a
);

1623 
	}
}

1625 
	$m˚_˝u_ª°¨t
(*
d©a
)

1627 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1628 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1630 
	`m˚_öô
();

1631 
	`m˚_öô_timî
();

1632 
	}
}

1635 
	$m˚_ª°¨t
()

1637 
	`⁄_óch_˝u
(
m˚_˝u_ª°¨t
, 
NULL
, 1);

1638 
	}
}

1641 
	$m˚_dißbÀ_˚
(*
Æl
)

1643 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1645 i‡(
Æl
)

1646 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1647 
	`cmci_˛ór
();

1648 
	}
}

1650 
	$m˚_íabÀ_˚
(*
Æl
)

1652 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1654 
	`cmci_ªíabÀ
();

1655 
	`cmci_ªcheck
();

1656 i‡(
Æl
)

1657 
	`m˚_öô_timî
();

1658 
	}
}

1660 
sysdev_˛ass
 
	gm˚_sys˛ass
 = {

1661 .
su•íd
 = 
m˚_su•íd
,

1662 .
	gshutdown
 = 
m˚_shutdown
,

1663 .
	gªsume
 = 
m˚_ªsume
,

1664 .
	g«me
 = "machinecheck",

1667 
DEFINE_PER_CPU
(
sys_devi˚
, 
m˚_dev
);

1669 
__˝uöôd©a


1670 (*
thªshﬁd_˝u_ˇŒback
)(
a˘i⁄
, 
˝u
);

1672 
sysdev_©åibuã
 *
b™k_©ås
;

1674 
ssize_t
 
	$show_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1675 *
buf
)

1677 
u64
 
b
 = 
b™k
[
©å
 - 
b™k_©ås
];

1679  
	`•rötf
(
buf
, "%Œx\n", 
b
);

1680 
	}
}

1682 
ssize_t
 
	$£t_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1683 c⁄° *
buf
, 
size_t
 
size
)

1685 
u64
 
√w
;

1687 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1688  -
EINVAL
;

1690 
b™k
[
©å
 - 
b™k_©ås
] = 
√w
;

1691 
	`m˚_ª°¨t
();

1693  
size
;

1694 
	}
}

1696 
ssize_t


1697 
	$show_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
, *
buf
)

1699 
	`°r˝y
(
buf
, 
m˚_hñ≥r
);

1700 
	`°rˇt
(
buf
, "\n");

1701  
	`°æí
(
m˚_hñ≥r
) + 1;

1702 
	}
}

1704 
ssize_t
 
	$£t_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1705 c⁄° *
buf
, 
size_t
 
siz
)

1707 *
p
;

1709 
	`°∫˝y
(
m˚_hñ≥r
, 
buf
, (mce_helper));

1710 
m˚_hñ≥r
[(mce_helper)-1] = 0;

1711 
p
 = 
	`°rchr
(
m˚_hñ≥r
, '\n');

1713 i‡(
p
)

1714 *
p
 = 0;

1716  
	`°æí
(
m˚_hñ≥r
Ë+ !!
p
;

1717 
	}
}

1719 
ssize_t
 
	$£t_ign‹e_˚
(
sys_devi˚
 *
s
,

1720 
sysdev_©åibuã
 *
©å
,

1721 c⁄° *
buf
, 
size_t
 
size
)

1723 
u64
 
√w
;

1725 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1726  -
EINVAL
;

1728 i‡(
m˚_ign‹e_˚
 ^ !!
√w
) {

1729 i‡(
√w
) {

1731 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, (*)1, 1);

1732 
m˚_ign‹e_˚
 = 1;

1735 
m˚_ign‹e_˚
 = 0;

1736 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, (*)1, 1);

1739  
size
;

1740 
	}
}

1742 
ssize_t
 
	$£t_cmci_dißbÀd
(
sys_devi˚
 *
s
,

1743 
sysdev_©åibuã
 *
©å
,

1744 c⁄° *
buf
, 
size_t
 
size
)

1746 
u64
 
√w
;

1748 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1749  -
EINVAL
;

1751 i‡(
m˚_cmci_dißbÀd
 ^ !!
√w
) {

1752 i‡(
√w
) {

1754 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, 
NULL
, 1);

1755 
m˚_cmci_dißbÀd
 = 1;

1758 
m˚_cmci_dißbÀd
 = 0;

1759 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, 
NULL
, 1);

1762  
size
;

1763 
	}
}

1765 
ssize_t
 
	$°‹e_öt_wôh_ª°¨t
(
sys_devi˚
 *
s
,

1766 
sysdev_©åibuã
 *
©å
,

1767 c⁄° *
buf
, 
size_t
 
size
)

1769 
ssize_t
 
ªt
 = 
	`sysdev_°‹e_öt
(
s
, 
©å
, 
buf
, 
size
);

1770 
	`m˚_ª°¨t
();

1771  
ªt
;

1772 
	}
}

1774 
SYSDEV_ATTR
(
åiggî
, 0644, 
show_åiggî
, 
£t_åiggî
);

1775 
SYSDEV_INT_ATTR
(
tﬁî™t
, 0644,Åolerant);

1776 
SYSDEV_INT_ATTR
(
m⁄¨ch_timeout
, 0644, monarch_timeout);

1777 
SYSDEV_INT_ATTR
(
d⁄t_log_˚
, 0644, 
m˚_d⁄t_log_˚
);

1779 
sysdev_ext_©åibuã
 
	g©å_check_öãrvÆ
 = {

1780 
_SYSDEV_ATTR
(
check_öãrvÆ
, 0644, 
sysdev_show_öt
,

1781 
°‹e_öt_wôh_ª°¨t
),

1782 &
check_öãrvÆ


1785 
sysdev_ext_©åibuã
 
	g©å_ign‹e_˚
 = {

1786 
_SYSDEV_ATTR
(
ign‹e_˚
, 0644, 
sysdev_show_öt
, 
£t_ign‹e_˚
),

1787 &
m˚_ign‹e_˚


1790 
sysdev_ext_©åibuã
 
	g©å_cmci_dißbÀd
 = {

1791 
_SYSDEV_ATTR
(
cmci_dißbÀd
, 0644, 
sysdev_show_öt
, 
£t_cmci_dißbÀd
),

1792 &
m˚_cmci_dißbÀd


1795 
sysdev_©åibuã
 *
	gm˚_©ås
[] = {

1796 &
©å_tﬁî™t
.
©å
,

1797 &
©å_check_öãrvÆ
.
©å
,

1798 &
©å_åiggî
,

1799 &
©å_m⁄¨ch_timeout
.
©å
,

1800 &
©å_d⁄t_log_˚
.
©å
,

1801 &
©å_ign‹e_˚
.
©å
,

1802 &
©å_cmci_dißbÀd
.
©å
,

1803 
NULL


1806 
˝umask_v¨_t
 
	gm˚_dev_öôülized
;

1809 
__˝uöô
 
	$m˚_¸óã_devi˚
(
˝u
)

1811 
îr
;

1812 
i
, 
j
;

1814 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1815  -
EIO
;

1817 
	`mem£t
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 0, (
kobje˘
));

1818 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
id
 = cpu;

1819 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
˛s
 = &
m˚_sys˛ass
;

1821 
îr
 = 
	`sysdev_ªgi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1822 i‡(
îr
)

1823  
îr
;

1825 
i
 = 0; 
m˚_©ås
[i]; i++) {

1826 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1827 i‡(
îr
)

1828 
îr‹
;

1830 
j
 = 0; j < 
b™ks
; j++) {

1831 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
),

1832 &
b™k_©ås
[
j
]);

1833 i‡(
îr
)

1834 
îr‹2
;

1836 
	`˝umask_£t_˝u
(
˝u
, 
m˚_dev_öôülized
);

1839 
îr‹2
:

1840 --
j
 >= 0)

1841 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
b™k_©ås
[
j
]);

1842 
îr‹
:

1843 --
i
 >= 0)

1844 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1846 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1848  
îr
;

1849 
	}
}

1851 
__˝uöô
 
	$m˚_ªmove_devi˚
(
˝u
)

1853 
i
;

1855 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
m˚_dev_öôülized
))

1858 
i
 = 0; 
m˚_©ås
[i]; i++)

1859 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1861 
i
 = 0; i < 
b™ks
; i++)

1862 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
b™k_©ås
[
i
]);

1864 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1865 
	`˝umask_˛ór_˝u
(
˝u
, 
m˚_dev_öôülized
);

1866 
	}
}

1869 
	$m˚_dißbÀ_˝u
(*
h
)

1871 
a˘i⁄
 = *(*)
h
;

1872 
i
;

1874 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1876 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1877 
	`cmci_˛ór
();

1878 
i
 = 0; i < 
b™ks
; i++) {

1879 i‡(!
	`skù_b™k_öô
(
i
))

1880 
	`wrm§l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 0);

1882 
	}
}

1884 
	$m˚_ªíabÀ_˝u
(*
h
)

1886 
a˘i⁄
 = *(*)
h
;

1887 
i
;

1889 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1892 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1893 
	`cmci_ªíabÀ
();

1894 
i
 = 0; i < 
b™ks
; i++) {

1895 i‡(!
	`skù_b™k_öô
(
i
))

1896 
	`wrm§l
(
MSR_IA32_MC0_CTL
 + 
i
*4, 
b™k
[i]);

1898 
	}
}

1901 
__˝uöô


1902 
	$m˚_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
, *
h˝u
)

1904 
˝u
 = ()
h˝u
;

1905 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
˝u
);

1907 
a˘i⁄
) {

1908 
CPU_ONLINE
:

1909 
CPU_ONLINE_FROZEN
:

1910 
	`m˚_¸óã_devi˚
(
˝u
);

1911 i‡(
thªshﬁd_˝u_ˇŒback
)

1912 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

1914 
CPU_DEAD
:

1915 
CPU_DEAD_FROZEN
:

1916 i‡(
thªshﬁd_˝u_ˇŒback
)

1917 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

1918 
	`m˚_ªmove_devi˚
(
˝u
);

1920 
CPU_DOWN_PREPARE
:

1921 
CPU_DOWN_PREPARE_FROZEN
:

1922 
	`dñ_timî_sync
(
t
);

1923 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_dißbÀ_˝u
, &
a˘i⁄
, 1);

1925 
CPU_DOWN_FAILED
:

1926 
CPU_DOWN_FAILED_FROZEN
:

1927 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 +

1928 
	`__gë_˝u_v¨
(
√xt_öãrvÆ
));

1929 
	`add_timî_⁄
(
t
, 
˝u
);

1930 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_ªíabÀ_˝u
, &
a˘i⁄
, 1);

1932 
CPU_POST_DEAD
:

1934 
	`cmci_ªdiscovî
(
˝u
);

1937  
NOTIFY_OK
;

1938 
	}
}

1940 
nŸifõr_block
 
m˚_˝u_nŸifõr
 
	g__˝uöôd©a
 = {

1941 .
nŸifõr_ˇŒ
 = 
m˚_˝u_ˇŒback
,

1944 
__öô
 
	$m˚_öô_b™ks
()

1946 
i
;

1948 
b™k_©ås
 = 
	`kzÆloc
((
sysdev_©åibuã
Ë* 
b™ks
,

1949 
GFP_KERNEL
);

1950 i‡(!
b™k_©ås
)

1951  -
ENOMEM
;

1953 
i
 = 0; i < 
b™ks
; i++) {

1954 
sysdev_©åibuã
 *
a
 = &
b™k_©ås
[
i
];

1956 
a
->
©å
.
«me
 = 
	`ka•rötf
(
GFP_KERNEL
, "b™k%d", 
i
);

1957 i‡(!
a
->
©å
.
«me
)

1958 
nomem
;

1960 
a
->
©å
.
mode
 = 0644;

1961 
a
->
show
 = 
show_b™k
;

1962 
a
->
°‹e
 = 
£t_b™k
;

1966 
nomem
:

1967 --
i
 >= 0)

1968 
	`k‰ì
(
b™k_©ås
[
i
].
©å
.
«me
);

1969 
	`k‰ì
(
b™k_©ås
);

1970 
b™k_©ås
 = 
NULL
;

1972  -
ENOMEM
;

1973 
	}
}

1975 
__öô
 
	$m˚_öô_devi˚
()

1977 
îr
;

1978 
i
 = 0;

1980 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1981  -
EIO
;

1983 
	`zÆloc_˝umask_v¨
(&
m˚_dev_öôülized
, 
GFP_KERNEL
);

1985 
îr
 = 
	`m˚_öô_b™ks
();

1986 i‡(
îr
)

1987  
îr
;

1989 
îr
 = 
	`sysdev_˛ass_ªgi°î
(&
m˚_sys˛ass
);

1990 i‡(
îr
)

1991  
îr
;

1993 
	`f‹_óch_⁄löe_˝u
(
i
) {

1994 
îr
 = 
	`m˚_¸óã_devi˚
(
i
);

1995 i‡(
îr
)

1996  
îr
;

1999 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m˚_˝u_nŸifõr
);

2000 
	`misc_ªgi°î
(&
m˚_log_devi˚
);

2002  
îr
;

2003 
	}
}

2005 
devi˚_öôˇŒ
(
m˚_öô_devi˚
);

2009 
	gƒ_m˚_b™ks
;

2010 
EXPORT_SYMBOL_GPL
(
ƒ_m˚_b™ks
);

2013 
	$mcheck_öô
(
˝uöfo_x86
 *
c
)

2015 i‡(
m˚_dißbÀd
)

2018 
c
->
x86_víd‹
) {

2019 
X86_VENDOR_AMD
:

2020 
	`amd_mcheck_öô
(
c
);

2023 
X86_VENDOR_INTEL
:

2024 i‡(
c
->
x86
 == 5)

2025 
	`öãl_p5_mcheck_öô
(
c
);

2026 i‡(
c
->
x86
 == 6)

2027 
	`öãl_p6_mcheck_öô
(
c
);

2028 i‡(
c
->
x86
 == 15)

2029 
	`öãl_p4_mcheck_öô
(
c
);

2032 
X86_VENDOR_CENTAUR
:

2033 i‡(
c
->
x86
 == 5)

2034 
	`wöchù_mcheck_öô
(
c
);

2040 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
ƒ_m˚_b™ks
);

2041 
	}
}

2043 
__öô
 
	$mcheck_íabÀ
(*
°r
)

2045 
m˚_p5_íabÀd
 = 1;

2047 
	}
}

2048 
__£tup
("m˚", 
mcheck_íabÀ
);

2055 
__öô
 
	$mcheck_dißbÀ
(*
°r
)

2057 
m˚_dißbÀd
 = 1;

2059 
	}
}

2060 
__£tup
("nom˚", 
mcheck_dißbÀ
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/kobje˘.h
>

19 
	~<löux/≥r˝u.h
>

20 
	~<löux/sysdev.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/sysfs.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/˝u.h
>

26 
	~<löux/smp.h
>

28 
	~<asm/≠ic.h
>

29 
	~<asm/idÀ.h
>

30 
	~<asm/m˚.h
>

31 
	~<asm/m§.h
>

33 
	#PFX
 "m˚_thªshﬁd: "

	)

34 
	#VERSION
 "vîsi⁄ 1.1.1"

	)

35 
	#NR_BANKS
 6

	)

36 
	#NR_BLOCKS
 9

	)

37 
	#THRESHOLD_MAX
 0xFFF

	)

38 
	#INT_TYPE_APIC
 0x00020000

	)

39 
	#MASK_VALID_HI
 0x80000000

	)

40 
	#MASK_CNTP_HI
 0x40000000

	)

41 
	#MASK_LOCKED_HI
 0x20000000

	)

42 
	#MASK_LVTOFF_HI
 0x00F00000

	)

43 
	#MASK_COUNT_EN_HI
 0x00080000

	)

44 
	#MASK_INT_TYPE_HI
 0x00060000

	)

45 
	#MASK_OVERFLOW_HI
 0x00010000

	)

46 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

47 
	#MASK_BLKPTR_LO
 0xFF000000

	)

48 
	#MCG_XBLK_ADDR
 0xC0000400

	)

50 
	sthªshﬁd_block
 {

51 
	mblock
;

52 
	mb™k
;

53 
	m˝u
;

54 
u32
 
	maddªss
;

55 
u16
 
	möãºu±_íabÀ
;

56 
u16
 
	mthªshﬁd_limô
;

57 
kobje˘
 
	mkobj
;

58 
li°_hód
 
	mmiscj
;

62 
thªshﬁd_block
 
	gthªshﬁd_deÁu…s
 = {

63 .
öãºu±_íabÀ
 = 0,

64 .
	gthªshﬁd_limô
 = 
THRESHOLD_MAX
,

67 
	sthªshﬁd_b™k
 {

68 
kobje˘
 *
	mkobj
;

69 
thªshﬁd_block
 *
	mblocks
;

70 
˝umask_v¨_t
 
	m˝us
;

72 
DEFINE_PER_CPU
(
thªshﬁd_b™k
 *, 
thªshﬁd_b™ks
[
NR_BANKS
]);

74 #ifde‡
CONFIG_SMP


75 
	gsh¨ed_b™k
[
NR_BANKS
] = {

80 
DEFINE_PER_CPU
(, 
b™k_m≠
);

82 
amd_thªshﬁd_öãºu±
();

88 
	sthªsh_ª°¨t
 {

89 
thªshﬁd_block
 *
	mb
;

90 
	mª£t
;

91 
u16
 
	mﬁd_limô
;

96 
	$thªshﬁd_ª°¨t_b™k
(*
_å
)

98 
thªsh_ª°¨t
 *
å
 = 
_å
;

99 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

101 
	`rdm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

103 i‡(
å
->
b
->
thªshﬁd_limô
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

104 
å
->
ª£t
 = 1;

106 i‡(
å
->
ª£t
) {

107 
mci_misc_hi
 =

108 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

109 (
THRESHOLD_MAX
 - 
å
->
b
->
thªshﬁd_limô
);

110 } i‡(
å
->
ﬁd_limô
) {

111 
√w_cou¡
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

112 (
å
->
ﬁd_limô
 -År->
b
->
thªshﬁd_limô
);

114 
mci_misc_hi
 = (mci_misc_hò& ~
MASK_ERR_COUNT_HI
) |

115 (
√w_cou¡
 & 
THRESHOLD_MAX
);

118 
å
->
b
->
öãºu±_íabÀ
 ?

119 (
mci_misc_hi
 = (mci_misc_hò& ~
MASK_INT_TYPE_HI
Ë| 
INT_TYPE_APIC
) :

120 (
mci_misc_hi
 &~
MASK_INT_TYPE_HI
);

122 
mci_misc_hi
 |
MASK_COUNT_EN_HI
;

123 
	`wrm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

124 
	}
}

127 
	$m˚_amd_„©uª_öô
(
˝uöfo_x86
 *
c
)

129 
˝u
 = 
	`smp_¥o˚ss‹_id
();

130 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

131 
b™k
, 
block
;

132 
thªsh_ª°¨t
 
å
;

133 
u8
 
lvt_off
;

135 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

136 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

137 i‡(
block
 == 0)

138 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

139 i‡(
block
 == 1) {

140 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

141 i‡(!
addªss
)

143 
addªss
 +
MCG_XBLK_ADDR
;

145 ++
addªss
;

147 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

150 i‡(!(
high
 & 
MASK_VALID_HI
)) {

151 i‡(
block
)

157 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

158 (
high
 & 
MASK_LOCKED_HI
))

161 i‡(!
block
)

162 
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë|(1 << 
b™k
);

163 #ifde‡
CONFIG_SMP


164 i‡(
sh¨ed_b™k
[
b™k
] && 
c
->
˝u_c‹e_id
)

167 
lvt_off
 = 
	`£tup_APIC_eûvt_m˚
(
THRESHOLD_APIC_VECTOR
,

168 
APIC_EILVT_MSG_FIX
, 0);

170 
high
 &~
MASK_LVTOFF_HI
;

171 
high
 |
lvt_off
 << 20;

172 
	`wrm§
(
addªss
, 
low
, 
high
);

174 
thªshﬁd_deÁu…s
.
addªss
 =áddress;

175 
å
.
b
 = &
thªshﬁd_deÁu…s
;

176 
å
.
ª£t
 = 0;

177 
å
.
ﬁd_limô
 = 0;

178 
	`thªshﬁd_ª°¨t_b™k
(&
å
);

180 
m˚_thªshﬁd_ve˘‹
 = 
amd_thªshﬁd_öãºu±
;

183 
	}
}

194 
	$amd_thªshﬁd_öãºu±
()

196 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

197 
b™k
, 
block
;

198 
m˚
 
m
;

200 
	`m˚_£tup
(&
m
);

203 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

204 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
m
.
˝u
Ë& (1 << 
b™k
)))

206 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

207 i‡(
block
 == 0) {

208 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

209 } i‡(
block
 == 1) {

210 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

211 i‡(!
addªss
)

213 
addªss
 +
MCG_XBLK_ADDR
;

215 ++
addªss
;

218 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

221 i‡(!(
high
 & 
MASK_VALID_HI
)) {

222 i‡(
block
)

228 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

229 (
high
 & 
MASK_LOCKED_HI
))

236 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

237 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

239 i‡(
high
 & 
MASK_OVERFLOW_HI
) {

240 
	`rdm§l
(
addªss
, 
m
.
misc
);

241 
	`rdm§l
(
MSR_IA32_MC0_STATUS
 + 
b™k
 * 4,

242 
m
.
°©us
);

243 
m
.
b™k
 = 
K8_MCE_THRESHOLD_BASE


244 + 
b™k
 * 
NR_BLOCKS


245 + 
block
;

246 
	`m˚_log
(&
m
);

251 
	}
}

257 
	sthªshﬁd_©å
 {

258 
©åibuã
 
	m©å
;

259 
ssize_t
 (*
show
Ë(
	mthªshﬁd_block
 *, *);

260 
ssize_t
 (*
°‹e
Ë(
	mthªshﬁd_block
 *, c⁄° *, 
size_t
 
	mcou¡
);

263 
	#SHOW_FIELDS
(
«me
) \

264 
ssize_t
 
show_
 ## 
	`«me
(
thªshﬁd_block
 *
b
, *
buf
) \

266  
	`•rötf
(
buf
, "%lx\n", (Ë
b
->
«me
); \

267 }

	)

268 
	$SHOW_FIELDS
(
öãºu±_íabÀ
)

269 
	$SHOW_FIELDS
(
thªshﬁd_limô
)

271 
ssize_t


272 
	$°‹e_öãºu±_íabÀ
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

274 
thªsh_ª°¨t
 
å
;

275 
√w
;

277 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

278  -
EINVAL
;

280 
b
->
öãºu±_íabÀ
 = !!
√w
;

282 
å
.
b
 = b;

283 
å
.
ª£t
 = 0;

284 
å
.
ﬁd_limô
 = 0;

286 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

288  
size
;

289 
	}
}

291 
ssize_t


292 
	$°‹e_thªshﬁd_limô
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

294 
thªsh_ª°¨t
 
å
;

295 
√w
;

297 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

298  -
EINVAL
;

300 i‡(
√w
 > 
THRESHOLD_MAX
)

301 
√w
 = 
THRESHOLD_MAX
;

302 i‡(
√w
 < 1)

303 
√w
 = 1;

305 
å
.
ﬁd_limô
 = 
b
->
thªshﬁd_limô
;

306 
b
->
thªshﬁd_limô
 = 
√w
;

307 
å
.
b
 = b;

308 
å
.
ª£t
 = 0;

310 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

312  
size
;

313 
	}
}

315 
	sthªshﬁd_block_¸oss_˝u
 {

316 
thªshﬁd_block
 *
	mtb
;

317 
	mªtvÆ
;

320 
	$loˇl_îr‹_cou¡_h™dÀr
(*
_tbcc
)

322 
thªshﬁd_block_¸oss_˝u
 *
tbcc
 = 
_tbcc
;

323 
thªshﬁd_block
 *
b
 = 
tbcc
->
tb
;

324 
u32
 
low
, 
high
;

326 
	`rdm§
(
b
->
addªss
, 
low
, 
high
);

327 
tbcc
->
ªtvÆ
 = (
high
 & 0xFFFË- (
THRESHOLD_MAX
 - 
b
->
thªshﬁd_limô
);

328 
	}
}

330 
ssize_t
 
	$show_îr‹_cou¡
(
thªshﬁd_block
 *
b
, *
buf
)

332 
thªshﬁd_block_¸oss_˝u
 
tbcc
 = { .
tb
 = 
b
, };

334 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
loˇl_îr‹_cou¡_h™dÀr
, &
tbcc
, 1);

335  
	`•rötf
(
buf
, "%lx\n", 
tbcc
.
ªtvÆ
);

336 
	}
}

338 
ssize_t
 
	$°‹e_îr‹_cou¡
(
thªshﬁd_block
 *
b
,

339 c⁄° *
buf
, 
size_t
 
cou¡
)

341 
thªsh_ª°¨t
 
å
 = { .
b
 = b, .
ª£t
 = 1, .
ﬁd_limô
 = 0 };

343 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

345 
	}
}

347 
	#RW_ATTR
(
vÆ
) \

348 
thªshﬁd_©å
 
vÆ
 = { \

349 .
©å
 = {.
«me
 = 
	`__°rögify
(
vÆ
), .
mode
 = 0644 }, \

350 .
show
 = 
show_
## 
vÆ
, \

351 .
°‹e
 = 
°‹e_
## 
vÆ
, \

352 };

	)

354 
RW_ATTR
(
öãºu±_íabÀ
);

355 
RW_ATTR
(
thªshﬁd_limô
);

356 
RW_ATTR
(
îr‹_cou¡
);

358 
©åibuã
 *
	gdeÁu…_©ås
[] = {

359 &
öãºu±_íabÀ
.
©å
,

360 &
thªshﬁd_limô
.
©å
,

361 &
îr‹_cou¡
.
©å
,

362 
NULL


365 
	#to_block
(
k
Ë
	`c⁄èöî_of
(k, 
thªshﬁd_block
, 
kobj
)

	)

366 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
thªshﬁd_©å
, 
©å
)

	)

368 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

370 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

371 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

372 
ssize_t
 
ªt
;

374 
ªt
 = 
a
->
show
 ?á->
	`show
(
b
, 
buf
Ë: -
EIO
;

376  
ªt
;

377 
	}
}

379 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

380 c⁄° *
buf
, 
size_t
 
cou¡
)

382 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

383 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

384 
ssize_t
 
ªt
;

386 
ªt
 = 
a
->
°‹e
 ?á->
	`°‹e
(
b
, 
buf
, 
cou¡
Ë: -
EIO
;

388  
ªt
;

389 
	}
}

391 
sysfs_›s
 
	gthªshﬁd_›s
 = {

392 .
show
 = show,

393 .
	g°‹e
 = 
°‹e
,

396 
kobj_ty≥
 
	gthªshﬁd_kty≥
 = {

397 .
sysfs_›s
 = &
thªshﬁd_›s
,

398 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

401 
__˝uöô
 
	$Æloˇã_thªshﬁd_blocks
(
˝u
,

402 
b™k
,

403 
block
,

404 
u32
 
addªss
)

406 
thªshﬁd_block
 *
b
 = 
NULL
;

407 
u32
 
low
, 
high
;

408 
îr
;

410 i‡((
b™k
 >
NR_BANKS
Ë|| (
block
 >
NR_BLOCKS
))

413 i‡(
	`rdm§_ß„_⁄_˝u
(
˝u
, 
addªss
, &
low
, &
high
))

416 i‡(!(
high
 & 
MASK_VALID_HI
)) {

417 i‡(
block
)

418 
ªcur£
;

423 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

424 (
high
 & 
MASK_LOCKED_HI
))

425 
ªcur£
;

427 
b
 = 
	`kzÆloc
((
thªshﬁd_block
), 
GFP_KERNEL
);

428 i‡(!
b
)

429  -
ENOMEM
;

431 
b
->
block
 = block;

432 
b
->
b™k
 = bank;

433 
b
->
˝u
 = cpu;

434 
b
->
addªss
 =áddress;

435 
b
->
öãºu±_íabÀ
 = 0;

436 
b
->
thªshﬁd_limô
 = 
THRESHOLD_MAX
;

438 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

440 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
) {

441 
	`li°_add
(&
b
->
miscj
,

442 &
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
->
miscj
);

444 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
b
;

447 
îr
 = 
	`kobje˘_öô_™d_add
(&
b
->
kobj
, &
thªshﬁd_kty≥
,

448 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
kobj
,

449 "misc%i", 
block
);

450 i‡(
îr
)

451 
out_‰ì
;

452 
ªcur£
:

453 i‡(!
block
) {

454 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

455 i‡(!
addªss
)

457 
addªss
 +
MCG_XBLK_ADDR
;

459 ++
addªss
;

462 
îr
 = 
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, ++
block
, 
addªss
);

463 i‡(
îr
)

464 
out_‰ì
;

466 i‡(
b
)

467 
	`kobje˘_uevít
(&
b
->
kobj
, 
KOBJ_ADD
);

469  
îr
;

471 
out_‰ì
:

472 i‡(
b
) {

473 
	`kobje˘_put
(&
b
->
kobj
);

474 
	`k‰ì
(
b
);

476  
îr
;

477 
	}
}

479 
__˝uöô
 

480 
	$loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
)

482  
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, 0,

483 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4);

484 
	}
}

487 
__˝uöô
 
	$thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
)

489 
i
, 
îr
 = 0;

490 
thªshﬁd_b™k
 *
b
 = 
NULL
;

491 
«me
[32];

493 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

495 #ifde‡
CONFIG_SMP


496 i‡(
	`˝u_d©a
(
˝u
).
˝u_c‹e_id
 && 
sh¨ed_b™k
[
b™k
]) {

497 
i
 = 
	`˝umask_fú°
(
	`˝u_c‹e_mask
(
˝u
));

500 i‡(
	`˝u_d©a
(
i
).
˝u_c‹e_id
)

501 
out
;

504 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
])

505 
out
;

507 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
];

509 i‡(!
b
)

510 
out
;

512 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
,

513 
b
->
kobj
, 
«me
);

514 i‡(
îr
)

515 
out
;

517 
	`˝umask_c›y
(
b
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

518 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

520 
out
;

524 
b
 = 
	`kzÆloc
((
thªshﬁd_b™k
), 
GFP_KERNEL
);

525 i‡(!
b
) {

526 
îr
 = -
ENOMEM
;

527 
out
;

529 i‡(!
	`Æloc_˝umask_v¨
(&
b
->
˝us
, 
GFP_KERNEL
)) {

530 
	`k‰ì
(
b
);

531 
îr
 = -
ENOMEM
;

532 
out
;

535 
b
->
kobj
 = 
	`kobje˘_¸óã_™d_add
(
«me
, &
	`≥r_˝u
(
m˚_dev
, 
˝u
).kobj);

536 i‡(!
b
->
kobj
)

537 
out_‰ì
;

539 #i‚de‡
CONFIG_SMP


540 
	`˝umask_£èŒ
(
b
->
˝us
);

542 
	`˝umask_c›y
(
b
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

545 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

547 
îr
 = 
	`loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
);

548 i‡(
îr
)

549 
out_‰ì
;

551 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

552 i‡(
i
 =
˝u
)

555 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
,

556 
b
->
kobj
, 
«me
);

557 i‡(
îr
)

558 
out
;

560 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
b
;

563 
out
;

565 
out_‰ì
:

566 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

567 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

568 
	`k‰ì
(
b
);

569 
out
:

570  
îr
;

571 
	}
}

574 
__˝uöô
 
	$thªshﬁd_¸óã_devi˚
(
˝u
)

576 
b™k
;

577 
îr
 = 0;

579 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

580 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

582 
îr
 = 
	`thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
);

583 i‡(
îr
)

584 
out
;

586 
out
:

587  
îr
;

588 
	}
}

596 
	$dóŒoˇã_thªshﬁd_block
(
˝u
,

597 
b™k
)

599 
thªshﬁd_block
 *
pos
 = 
NULL
;

600 
thªshﬁd_block
 *
tmp
 = 
NULL
;

601 
thªshﬁd_b™k
 *
hód
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

603 i‡(!
hód
)

606 
	`li°_f‹_óch_íåy_ß„
(
pos
, 
tmp
, &
hód
->
blocks
->
miscj
, miscj) {

607 
	`kobje˘_put
(&
pos
->
kobj
);

608 
	`li°_dñ
(&
pos
->
miscj
);

609 
	`k‰ì
(
pos
);

612 
	`k‰ì
(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
);

613 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
NULL
;

614 
	}
}

616 
	$thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
)

618 
thªshﬁd_b™k
 *
b
;

619 
«me
[32];

620 
i
 = 0;

622 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

623 i‡(!
b
)

625 i‡(!
b
->
blocks
)

626 
‰ì_out
;

628 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

630 #ifde‡
CONFIG_SMP


632 i‡(
sh¨ed_b™k
[
b™k
] && 
b
->
blocks
->
˝u
 != cpu) {

633 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 
«me
);

634 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

641 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

642 i‡(
i
 =
˝u
)

645 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
, 
«me
);

646 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
NULL
;

649 
	`dóŒoˇã_thªshﬁd_block
(
˝u
, 
b™k
);

651 
‰ì_out
:

652 
	`kobje˘_dñ
(
b
->
kobj
);

653 
	`kobje˘_put
(
b
->
kobj
);

654 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

655 
	`k‰ì
(
b
);

656 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

657 
	}
}

659 
	$thªshﬁd_ªmove_devi˚
(
˝u
)

661 
b™k
;

663 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

664 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

666 
	`thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
);

668 
	}
}

671 
__˝uöô


672 
	$amd_64_thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
)

674 
a˘i⁄
) {

675 
CPU_ONLINE
:

676 
CPU_ONLINE_FROZEN
:

677 
	`thªshﬁd_¸óã_devi˚
(
˝u
);

679 
CPU_DEAD
:

680 
CPU_DEAD_FROZEN
:

681 
	`thªshﬁd_ªmove_devi˚
(
˝u
);

686 
	}
}

688 
__öô
 
	$thªshﬁd_öô_devi˚
()

690 
l˝u
 = 0;

693 
	`f‹_óch_⁄löe_˝u
(
l˝u
) {

694 
îr
 = 
	`thªshﬁd_¸óã_devi˚
(
l˝u
);

696 i‡(
îr
)

697  
îr
;

699 
thªshﬁd_˝u_ˇŒback
 = 
amd_64_thªshﬁd_˝u_ˇŒback
;

702 
	}
}

703 
devi˚_öôˇŒ
(
thªshﬁd_öô_devi˚
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c

8 
	~<löux/öô.h
>

9 
	~<löux/öãºu±.h
>

10 
	~<löux/≥r˝u.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/m§.h
>

14 
	~<asm/m˚.h
>

23 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_b™ks_ow√d
);

29 
DEFINE_SPINLOCK
(
cmci_discovî_lock
);

31 
	#CMCI_THRESHOLD
 1

	)

33 
	$cmci_suµ‹ãd
(*
b™ks
)

35 
u64
 
ˇp
;

37 i‡(
m˚_cmci_dißbÀd
 || 
m˚_ign‹e_˚
)

45 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
)

47 i‡(!
˝u_has_≠ic
 || 
	`œpic_gë_maxlvt
() < 6)

49 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

50 *
b™ks
 = 
	`mö_t
(, 
MAX_NR_BANKS
, 
ˇp
 & 0xff);

51  !!(
ˇp
 & 
MCG_CMCI_P
);

52 
	}
}

60 
	$öãl_thªshﬁd_öãºu±
()

62 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

63 
	`m˚_nŸify_úq
();

64 
	}
}

66 
	$¥öt_upd©e
(*
ty≥
, *
hdr
, 
num
)

68 i‡(*
hdr
 == 0)

69 
	`¥ötk
(
KERN_INFO
 "CPU %d MCA b™ks", 
	`smp_¥o˚ss‹_id
());

70 *
hdr
 = 1;

71 
	`¥ötk
(
KERN_CONT
 " %s:%d", 
ty≥
, 
num
);

72 
	}
}

79 
	$cmci_discovî
(
b™ks
, 
boŸ
)

81 *
ow√d
 = (*)&
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
);

82 
Êags
;

83 
hdr
 = 0;

84 
i
;

86 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

87 
i
 = 0; i < 
b™ks
; i++) {

88 
u64
 
vÆ
;

90 i‡(
	`ã°_bô
(
i
, 
ow√d
))

93 
	`rdm§l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
vÆ
);

96 i‡(
vÆ
 & 
CMCI_EN
) {

97 i‡(
	`ã°_™d_˛ór_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

98 
	`¥öt_upd©e
("SHD", &
hdr
, 
i
);

99 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

103 
vÆ
 |
CMCI_EN
 | 
CMCI_THRESHOLD
;

104 
	`wrm§l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
vÆ
);

105 
	`rdm§l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
vÆ
);

108 i‡(
vÆ
 & 
CMCI_EN
) {

109 i‡(!
	`ã°_™d_£t_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

110 
	`¥öt_upd©e
("CMCI", &
hdr
, 
i
);

111 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

113 
	`WARN_ON
(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
)));

116 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

117 i‡(
hdr
)

118 
	`¥ötk
(
KERN_CONT
 "\n");

119 
	}
}

125 
	$cmci_ªcheck
()

127 
Êags
;

128 
b™ks
;

130 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
Ë|| !
	`cmci_suµ‹ãd
(&
b™ks
))

132 
	`loˇl_úq_ßve
(
Êags
);

133 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

134 
	`loˇl_úq_ª°‹e
(
Êags
);

135 
	}
}

141 
	$cmci_˛ór
()

143 
Êags
;

144 
i
;

145 
b™ks
;

146 
u64
 
vÆ
;

148 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

150 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

151 
i
 = 0; i < 
b™ks
; i++) {

152 i‡(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
)))

155 
	`rdm§l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
vÆ
);

156 
vÆ
 &~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

157 
	`wrm§l
(
MSR_IA32_MC0_CTL2
 + 
i
, 
vÆ
);

158 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

160 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

161 
	}
}

167 
	$cmci_ªdiscovî
(
dyög
)

169 
b™ks
;

170 
˝u
;

171 
˝umask_v¨_t
 
ﬁd
;

173 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

175 i‡(!
	`Æloc_˝umask_v¨
(&
ﬁd
, 
GFP_KERNEL
))

177 
	`˝umask_c›y
(
ﬁd
, &
cuºít
->
˝us_Ælowed
);

179 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

180 i‡(
˝u
 =
dyög
)

182 i‡(
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
˝u
)))

185 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

186 
	`cmci_discovî
(
b™ks
, 0);

189 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
ﬁd
);

190 
	`‰ì_˝umask_v¨
(
ﬁd
);

191 
	}
}

196 
	$cmci_ªíabÀ
()

198 
b™ks
;

199 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

200 
	`cmci_discovî
(
b™ks
, 0);

201 
	}
}

203 
	$öãl_öô_cmci
()

205 
b™ks
;

207 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

210 
m˚_thªshﬁd_ve˘‹
 = 
öãl_thªshﬁd_öãºu±
;

211 
	`cmci_discovî
(
b™ks
, 1);

218 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

219 
	`cmci_ªcheck
();

220 
	}
}

222 
	$m˚_öãl_„©uª_öô
(
˝uöfo_x86
 *
c
)

224 
	`öãl_öô_thîmÆ
(
c
);

225 
	`öãl_öô_cmci
();

226 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/jiffõs.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/≥r˝u.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/˝u.h
>

27 
	~<asm/¥o˚ss‹.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

35 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

37 
DEFINE_PER_CPU
(
__u64
, 
√xt_check
Ë
INITIAL_JIFFIES
;

38 
DEFINE_PER_CPU
(, 
thîmÆ_thrŸée_cou¡
);

39 
DEFINE_PER_CPU
(
boﬁ
, 
thîmÆ_thrŸée_a˘ive
);

41 
©omic_t
 
	gthîm_thrŸ_í
 = 
ATOMIC_INIT
(0);

43 #ifde‡
CONFIG_SYSFS


44 
	#deföe_thîm_thrŸ_sysdev_⁄e_ro
(
_«me
) \

45 
	`SYSDEV_ATTR
(
_«me
, 0444, 
thîm_thrŸ_sysdev_show_
##_«me, 
NULL
)

	)

47 
	#deföe_thîm_thrŸ_sysdev_show_func
(
«me
) \

48 
ssize_t
 
thîm_thrŸ_sysdev_show_
##
	`«me
(
sys_devi˚
 *
dev
, \

49 
sysdev_©åibuã
 *
©å
, \

50 *
buf
) \

52 
˝u
 = 
dev
->
id
; \

53 
ssize_t
 
ªt
; \

55 
	`¥ìm±_dißbÀ
(); \

56 i‡(
	`˝u_⁄löe
(
˝u
)) \

57 
ªt
 = 
	`•rötf
(
buf
, "%lu\n", \

58 
	`≥r_˝u
(
thîmÆ_thrŸée_
##
«me
, 
˝u
)); \

60 
ªt
 = 0; \

61 
	`¥ìm±_íabÀ
(); \

63  
ªt
; \

64 }

	)

66 
deföe_thîm_thrŸ_sysdev_show_func
(
cou¡
);

67 
deföe_thîm_thrŸ_sysdev_⁄e_ro
(
cou¡
);

69 
©åibuã
 *
	gthîmÆ_thrŸée_©ås
[] = {

70 &
©å_cou¡
.
©å
,

71 
NULL


74 
©åibuã_group
 
	gthîmÆ_thrŸée_©å_group
 = {

75 .
©ås
 = 
thîmÆ_thrŸée_©ås
,

76 .
	g«me
 = "thermal_throttle"

96 
	$thîm_thrŸ_¥o˚ss
(
cuº
)

98 
˝u
 = 
	`smp_¥o˚ss‹_id
();

99 
__u64
 
tmp_jiffs
 = 
	`gë_jiffõs_64
();

100 
boﬁ
 
was_thrŸéed
 = 
	`__gë_˝u_v¨
(
thîmÆ_thrŸée_a˘ive
);

101 
boﬁ
 
is_thrŸéed
 = 
	`__gë_˝u_v¨
(
thîmÆ_thrŸée_a˘ive
Ë
cuº
;

103 i‡(
is_thrŸéed
)

104 
	`__gë_˝u_v¨
(
thîmÆ_thrŸée_cou¡
)++;

106 i‡(!(
was_thrŸéed
 ^ 
is_thrŸéed
) &&

107 
	`time_bef‹e64
(
tmp_jiffs
, 
	`__gë_˝u_v¨
(
√xt_check
)))

110 
	`__gë_˝u_v¨
(
√xt_check
Ë
tmp_jiffs
 + 
CHECK_INTERVAL
;

113 i‡(
is_thrŸéed
) {

114 
	`¥ötk
(
KERN_CRIT
 "CPU%d: TemperatureáboveÅhreshold, "

116 
˝u
, 
	`__gë_˝u_v¨
(
thîmÆ_thrŸée_cou¡
));

118 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

121 i‡(
was_thrŸéed
) {

122 
	`¥ötk
(
KERN_INFO
 "CPU%d: Tem≥øtuª/•ìdÇ‹mÆ\n", 
˝u
);

127 
	}
}

129 #ifde‡
CONFIG_SYSFS


131 
__˝uöô
 
	$thîmÆ_thrŸée_add_dev
(
sys_devi˚
 *
sys_dev
)

133  
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
,

134 &
thîmÆ_thrŸée_©å_group
);

135 
	}
}

137 
__˝uöô
 
	$thîmÆ_thrŸée_ªmove_dev
(
sys_devi˚
 *
sys_dev
)

139 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
thîmÆ_thrŸée_©å_group
);

140 
	}
}

143 
DEFINE_MUTEX
(
thîm_˝u_lock
);

146 
__˝uöô
 

147 
	$thîmÆ_thrŸée_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

148 
a˘i⁄
,

149 *
h˝u
)

151 
˝u
 = ()
h˝u
;

152 
sys_devi˚
 *
sys_dev
;

153 
îr
 = 0;

155 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

157 
a˘i⁄
) {

158 
CPU_UP_PREPARE
:

159 
CPU_UP_PREPARE_FROZEN
:

160 
	`muãx_lock
(&
thîm_˝u_lock
);

161 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
sys_dev
);

162 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

163 
	`WARN_ON
(
îr
);

165 
CPU_UP_CANCELED
:

166 
CPU_UP_CANCELED_FROZEN
:

167 
CPU_DEAD
:

168 
CPU_DEAD_FROZEN
:

169 
	`muãx_lock
(&
thîm_˝u_lock
);

170 
	`thîmÆ_thrŸée_ªmove_dev
(
sys_dev
);

171 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

174  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

175 
	}
}

177 
nŸifõr_block
 
thîmÆ_thrŸée_˝u_nŸifõr
 
	g__˝uöôd©a
 =

179 .
nŸifõr_ˇŒ
 = 
thîmÆ_thrŸée_˝u_ˇŒback
,

182 
__öô
 
	$thîmÆ_thrŸée_öô_devi˚
()

184 
˝u
 = 0;

185 
îr
;

187 i‡(!
	`©omic_ªad
(&
thîm_thrŸ_í
))

190 
	`ªgi°î_hŸ˝u_nŸifõr
(&
thîmÆ_thrŸée_˝u_nŸifõr
);

192 #ifde‡
CONFIG_HOTPLUG_CPU


193 
	`muãx_lock
(&
thîm_˝u_lock
);

196 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

197 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
	`gë_˝u_sysdev
(
˝u
));

198 
	`WARN_ON
(
îr
);

200 #ifde‡
CONFIG_HOTPLUG_CPU


201 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

205 
	}
}

206 
devi˚_öôˇŒ
(
thîmÆ_thrŸée_öô_devi˚
);

211 
	$öãl_thîmÆ_öãºu±
()

213 
__u64
 
m§_vÆ
;

215 
	`rdm§l
(
MSR_IA32_THERM_STATUS
, 
m§_vÆ
);

216 i‡(
	`thîm_thrŸ_¥o˚ss
(
m§_vÆ
 & 
THERM_STATUS_PROCHOT
))

217 
	`m˚_log_thîm_thrŸ_evít
(
m§_vÆ
);

218 
	}
}

220 
	$u√x≥˘ed_thîmÆ_öãºu±
()

222 
	`¥ötk
(
KERN_ERR
 "CPU%d: Unexpected LVT TMR interrupt!\n",

223 
	`smp_¥o˚ss‹_id
());

224 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

225 
	}
}

227 (*
smp_thîmÆ_ve˘‹
)(Ë
u√x≥˘ed_thîmÆ_öãºu±
;

229 
asmlökage
 
	$smp_thîmÆ_öãºu±
(
±_ªgs
 *
ªgs
)

231 
	`exô_idÀ
();

232 
	`úq_íãr
();

233 
	`öc_úq_°©
(
úq_thîmÆ_cou¡
);

234 
	`smp_thîmÆ_ve˘‹
();

235 
	`úq_exô
();

237 
	`ack_APIC_úq
();

238 
	}
}

240 
	$öãl_öô_thîmÆ
(
˝uöfo_x86
 *
c
)

242 
˝u
 = 
	`smp_¥o˚ss‹_id
();

243 
tm2
 = 0;

244 
u32
 
l
, 
h
;

247 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
Ë|| !˝u_has(c, 
X86_FEATURE_ACC
))

255 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

256 
h
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

257 i‡((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
Ë&& (
h
 & 
APIC_DM_SMI
)) {

258 
	`¥ötk
(
KERN_DEBUG


259 "CPU%d: ThîmÆ m⁄ô‹ög h™dÀd by SMI\n", 
˝u
);

263 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TM2
Ë&& (
l
 & 
MSR_IA32_MISC_ENABLE_TM2
))

264 
tm2
 = 1;

267 i‡(
h
 & 
APIC_VECTOR_MASK
) {

268 
	`¥ötk
(
KERN_DEBUG


270 
˝u
, (
h
 & 
APIC_VECTOR_MASK
));

275 
h
 = 
THERMAL_APIC_VECTOR
 | 
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
;

276 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
h
);

278 
	`rdm§
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

279 
	`wrm§
(
MSR_IA32_THERM_INTERRUPT
,

280 
l
 | (
THERM_INT_LOW_ENABLE
 | 
THERM_INT_HIGH_ENABLE
), 
h
);

282 
smp_thîmÆ_ve˘‹
 = 
öãl_thîmÆ_öãºu±
;

284 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

285 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

288 
l
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

289 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

291 
	`¥ötk
(
KERN_INFO
 "CPU%d: Thermal monitoringÉnabled (%s)\n",

292 
˝u
, 
tm2
 ? "TM2" : "TM1");

295 
	`©omic_£t
(&
thîm_thrŸ_í
, 1);

296 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<löux/öãºu±.h
>

5 
	~<löux/kî√l.h
>

7 
	~<asm/úq_ve˘‹s.h
>

8 
	~<asm/≠ic.h
>

9 
	~<asm/idÀ.h
>

10 
	~<asm/m˚.h
>

12 
	$deÁu…_thªshﬁd_öãºu±
()

14 
	`¥ötk
(
KERN_ERR
 "UnexpectedÅhreshold interruptát vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
m˚_thªshﬁd_ve˘‹
)(Ë
deÁu…_thªshﬁd_öãºu±
;

20 
asmlökage
 
	$smp_thªshﬁd_öãºu±
()

22 
	`exô_idÀ
();

23 
	`úq_íãr
();

24 
	`öc_úq_°©
(
úq_thªshﬁd_cou¡
);

25 
	`m˚_thªshﬁd_ve˘‹
();

26 
	`úq_exô
();

28 
	`ack_APIC_úq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/˝u.h
>

25 
	~<löux/muãx.h
>

26 
	~<löux/s‹t.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/mår.h
>

30 
	~<asm/uac˚ss.h
>

31 
	~<asm/¥o˚ss‹.h
>

32 
	~<asm/m§.h
>

33 
	~<asm/kvm_∑ø.h
>

34 
	~"mår.h
"

37 
	#RANGE_NUM
 256

	)

39 
	sªs_ønge
 {

40 
	m°¨t
;

41 
	míd
;

44 
__öô


45 
	$add_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
, 
°¨t
,

46 
íd
)

49 i‡(
ƒ_ønge
 >
RANGE_NUM
)

50  
ƒ_ønge
;

52 
ønge
[
ƒ_ønge
].
°¨t
 = start;

53 
ønge
[
ƒ_ønge
].
íd
 =Énd;

55 
ƒ_ønge
++;

57  
ƒ_ønge
;

58 
	}
}

60 
__öô


61 
	$add_ønge_wôh_mîge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
, 
°¨t
,

62 
íd
)

64 
i
;

67 
i
 = 0; i < 
ƒ_ønge
; i++) {

68 
föÆ_°¨t
, 
föÆ_íd
;

69 
comm⁄_°¨t
, 
comm⁄_íd
;

71 i‡(!
ønge
[
i
].
íd
)

74 
comm⁄_°¨t
 = 
	`max
(
ønge
[
i
].
°¨t
, start);

75 
comm⁄_íd
 = 
	`mö
(
ønge
[
i
].
íd
,Énd);

76 i‡(
comm⁄_°¨t
 > 
comm⁄_íd
 + 1)

79 
föÆ_°¨t
 = 
	`mö
(
ønge
[
i
].
°¨t
, start);

80 
föÆ_íd
 = 
	`max
(
ønge
[
i
].
íd
,Énd);

82 
ønge
[
i
].
°¨t
 = 
föÆ_°¨t
;

83 
ønge
[
i
].
íd
 = 
föÆ_íd
;

84  
ƒ_ønge
;

88  
	`add_ønge
(
ønge
, 
ƒ_ønge
, 
°¨t
, 
íd
);

89 
	}
}

91 
__öô


92 
	$subåa˘_ønge
(
ªs_ønge
 *
ønge
, 
°¨t
, 
íd
)

94 
i
, 
j
;

96 
j
 = 0; j < 
RANGE_NUM
; j++) {

97 i‡(!
ønge
[
j
].
íd
)

100 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end) {

101 
ønge
[
j
].
°¨t
 = 0;

102 
ønge
[
j
].
íd
 = 0;

106 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end &&

107 
ønge
[
j
].
°¨t
 < 
íd
 + 1) {

108 
ønge
[
j
].
°¨t
 = 
íd
 + 1;

113 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end &&

114 
ønge
[
j
].
íd
 > 
°¨t
 - 1) {

115 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

119 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end) {

121 
i
 = 0; i < 
RANGE_NUM
; i++) {

122 i‡(
ønge
[
i
].
íd
 == 0)

125 i‡(
i
 < 
RANGE_NUM
) {

126 
ønge
[
i
].
íd
 =Ñ™ge[
j
].end;

127 
ønge
[
i
].
°¨t
 = 
íd
 + 1;

129 
	`¥ötk
(
KERN_ERR
 "run of slot inÑanges\n");

131 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

135 
	}
}

137 
__öô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

139 c⁄° 
ªs_ønge
 *
r1
 = 
x1
;

140 c⁄° 
ªs_ønge
 *
r2
 = 
x2
;

141 
°¨t1
, 
°¨t2
;

143 
°¨t1
 = 
r1
->
°¨t
;

144 
°¨t2
 = 
r2
->
°¨t
;

146  
°¨t1
 - 
°¨t2
;

147 
	}
}

149 
	sv¨_mår_ønge_°©e
 {

150 
	mba£_p‚
;

151 
	msize_p‚
;

152 
mår_ty≥
 
	mty≥
;

155 
v¨_mår_ønge_°©e
 
__öôd©a
 
	gønge_°©e
[
RANGE_NUM
];

156 
__öôd©a
 
	gdebug_¥öt
;

158 
__öô


159 
	$x86_gë_mår_mem_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

160 
exåa_ªmove_ba£
,

161 
exåa_ªmove_size
)

163 
ba£
, 
size
;

164 
mår_ty≥
 
ty≥
;

165 
i
;

167 
i
 = 0; i < 
num_v¨_ønges
; i++) {

168 
ty≥
 = 
ønge_°©e
[
i
].type;

169 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

171 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

172 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

173 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_ønge, 
ba£
,

174 
ba£
 + 
size
 - 1);

176 i‡(
debug_¥öt
) {

177 
	`¥ötk
(
KERN_DEBUG
 "After WB checking\n");

178 
i
 = 0; i < 
ƒ_ønge
; i++)

179 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

180 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

184 
i
 = 0; i < 
num_v¨_ønges
; i++) {

185 
ty≥
 = 
ønge_°©e
[
i
].type;

186 i‡(
ty≥
 !
MTRR_TYPE_UNCACHABLE
 &&

187 
ty≥
 !
MTRR_TYPE_WRPROT
)

189 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

190 i‡(!
size
)

192 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

193 i‡(
ba£
 < (1<<(20-
PAGE_SHIFT
)Ë&& 
mår_°©e
.
have_fixed
 &&

194 (
mår_°©e
.
íabÀd
 & 1)) {

196 
	`¥ötk
(
KERN_WARNING
 "WARNING: BIOS bug: VAR MTRR %d "

198 "wôh you∏sy°em víd‹!\n", 
i
);

199 i‡(
ba£
 + 
size
 <(1<<(20-
PAGE_SHIFT
)))

201 
size
 -(1<<(20-
PAGE_SHIFT
)Ë- 
ba£
;

202 
ba£
 = 1<<(20-
PAGE_SHIFT
);

204 
	`subåa˘_ønge
(
ønge
, 
ba£
, ba£ + 
size
 - 1);

206 i‡(
exåa_ªmove_size
)

207 
	`subåa˘_ønge
(
ønge
, 
exåa_ªmove_ba£
,

208 
exåa_ªmove_ba£
 + 
exåa_ªmove_size
 - 1);

211 
ƒ_ønge
 = 0;

212 
i
 = 0; i < 
RANGE_NUM
; i++) {

213 i‡(!
ønge
[
i
].
íd
)

215 
ƒ_ønge
++;

217 i‡(
debug_¥öt
) {

218 
	`¥ötk
(
KERN_DEBUG
 "After UC checking\n");

219 
i
 = 0; i < 
ƒ_ønge
; i++)

220 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

221 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

225 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

226 i‡(
debug_¥öt
) {

227 
	`¥ötk
(
KERN_DEBUG
 "After sorting\n");

228 
i
 = 0; i < 
ƒ_ønge
; i++)

229 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

230 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

234 
i
 = 
ƒ_ønge
; i < 
RANGE_NUM
; i++)

235 
	`mem£t
(&
ønge
[
i
], 0, (range[i]));

237  
ƒ_ønge
;

238 
	}
}

240 
ªs_ønge
 
__öôd©a
 
	gønge
[
RANGE_NUM
];

241 
__öôd©a
 
	gƒ_ønge
;

243 #ifde‡
CONFIG_MTRR_SANITIZER


245 
__öô
 
	$sum_ønges
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
)

247 
sum
;

248 
i
;

250 
sum
 = 0;

251 
i
 = 0; i < 
ƒ_ønge
; i++)

252 
sum
 +
ønge
[
i
].
íd
 + 1 -Ñ™ge[i].
°¨t
;

254  
sum
;

255 
	}
}

257 
íabÀ_mår_˛ónup
 
	g__öôd©a
 =

258 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

260 
__öô
 
	$dißbÀ_mår_˛ónup_£tup
(*
°r
)

262 
íabÀ_mår_˛ónup
 = 0;

264 
	}
}

265 
óæy_∑øm
("dißbÀ_mår_˛ónup", 
dißbÀ_mår_˛ónup_£tup
);

267 
__öô
 
	$íabÀ_mår_˛ónup_£tup
(*
°r
)

269 
íabÀ_mår_˛ónup
 = 1;

271 
	}
}

272 
óæy_∑øm
("íabÀ_mår_˛ónup", 
íabÀ_mår_˛ónup_£tup
);

274 
__öô
 
	$mår_˛ónup_debug_£tup
(*
°r
)

276 
debug_¥öt
 = 1;

278 
	}
}

279 
óæy_∑øm
("mår_˛ónup_debug", 
mår_˛ónup_debug_£tup
);

281 
	sv¨_mår_°©e
 {

282 
	mønge_°¨tk
;

283 
	mønge_sizek
;

284 
	mchunk_sizek
;

285 
	mgøn_sizek
;

286 
	mªg
;

289 
__öô


290 
	$£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

291 
ty≥
, 
addªss_bôs
)

293 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

294 
u64
 
ba£
, 
mask
;

296 i‡(!
sizek
) {

297 
	`fûl_mår_v¨_ønge
(
ªg
, 0, 0, 0, 0);

301 
mask
 = (1ULL << 
addªss_bôs
) - 1;

302 
mask
 &~((((
u64
)
sizek
) << 10) - 1);

304 
ba£
 = ((
u64
)
ba£k
) << 10;

306 
ba£
 |
ty≥
;

307 
mask
 |= 0x800;

309 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

310 
ba£_hi
 = 
ba£
 >> 32;

312 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

313 
mask_hi
 = 
mask
 >> 32;

315 
	`fûl_mår_v¨_ønge
(
ªg
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

316 
	}
}

318 
__öô


319 
	$ßve_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

320 
ty≥
)

322 
ønge_°©e
[
ªg
].
ba£_p‚
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

323 
ønge_°©e
[
ªg
].
size_p‚
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

324 
ønge_°©e
[
ªg
].
ty≥
 =Åype;

325 
	}
}

327 
__öô


328 
	$£t_v¨_mår_Æl
(
addªss_bôs
)

330 
ba£k
, 
sizek
;

331 
ty≥
;

332 
ªg
;

334 
ªg
 = 0;Ñeg < 
num_v¨_ønges
;Ñeg++) {

335 
ba£k
 = 
ønge_°©e
[
ªg
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

336 
sizek
 = 
ønge_°©e
[
ªg
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

337 
ty≥
 = 
ønge_°©e
[
ªg
].type;

339 
	`£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
, 
ty≥
, 
addªss_bôs
);

341 
	}
}

343 
	$to_size_Á˘‹
(
sizek
, *
Á˘‹p
)

345 
Á˘‹
;

346 
ba£
 = 
sizek
;

348 i‡(
ba£
 & ((1<<10) - 1)) {

350 
Á˘‹
 = 'K';

351 } i‡(
ba£
 & ((1<<20) - 1)) {

352 
Á˘‹
 = 'M';

353 
ba£
 >>= 10;

355 
Á˘‹
 = 'G';

356 
ba£
 >>= 20;

359 *
Á˘‹p
 = 
Á˘‹
;

361  
ba£
;

362 
	}
}

364 
__öô


365 
	$ønge_to_mår
(
ªg
, 
ønge_°¨tk
,

366 
ønge_sizek
, 
ty≥
)

368 i‡(!
ønge_sizek
 || (
ªg
 >
num_v¨_ønges
))

369  
ªg
;

371 
ønge_sizek
) {

372 
max_Æign
, 
Æign
;

373 
sizek
;

376 i‡(
ønge_°¨tk
)

377 
max_Æign
 = 
	`ffs
(
ønge_°¨tk
) - 1;

379 
max_Æign
 = 32;

380 
Æign
 = 
	`Ês
(
ønge_sizek
) - 1;

381 i‡(
Æign
 > 
max_Æign
)

382 
Æign
 = 
max_Æign
;

384 
sizek
 = 1 << 
Æign
;

385 i‡(
debug_¥öt
) {

386 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

387 
°¨t_ba£
, 
size_ba£
;

389 
°¨t_ba£
 = 
	`to_size_Á˘‹
(
ønge_°¨tk
,

390 &
°¨t_Á˘‹
),

391 
size_ba£
 = 
	`to_size_Á˘‹
(
sizek
, &
size_Á˘‹
),

393 
	`¥ötk
(
KERN_DEBUG
 "Setting variable MTRR %d, "

395 
ªg
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

396 
size_ba£
, 
size_Á˘‹
,

397 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

398 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

401 
	`ßve_v¨_mår
(
ªg
++, 
ønge_°¨tk
, 
sizek
, 
ty≥
);

402 
ønge_°¨tk
 +
sizek
;

403 
ønge_sizek
 -
sizek
;

404 i‡(
ªg
 >
num_v¨_ønges
)

407  
ªg
;

408 
	}
}

410 
__öô


411 
	$ønge_to_mår_wôh_hﬁe
(
v¨_mår_°©e
 *
°©e
, 
ba£k
,

412 
sizek
)

414 
hﬁe_ba£k
, 
hﬁe_sizek
;

415 
£c⁄d_ba£k
, 
£c⁄d_sizek
;

416 
ønge0_ba£k
, 
ønge0_sizek
;

417 
ønge_ba£k
, 
ønge_sizek
;

418 
chunk_sizek
;

419 
gøn_sizek
;

421 
hﬁe_ba£k
 = 0;

422 
hﬁe_sizek
 = 0;

423 
£c⁄d_ba£k
 = 0;

424 
£c⁄d_sizek
 = 0;

425 
chunk_sizek
 = 
°©e
->chunk_sizek;

426 
gøn_sizek
 = 
°©e
->gran_sizek;

429 
ønge_ba£k
 = 
	`ALIGN
(
°©e
->
ønge_°¨tk
, 
gøn_sizek
);

430 i‡((
ønge_ba£k
 > 
ba£k
) && basek)

431  
£c⁄d_sizek
;

432 
°©e
->
ønge_sizek
 -(
ønge_ba£k
 - sèã->
ønge_°¨tk
);

433 
ønge_sizek
 = 
	`ALIGN
(
°©e
->ønge_sizek, 
gøn_sizek
);

435 
ønge_sizek
 > 
°©e
->range_sizek) {

436 
ønge_sizek
 -
gøn_sizek
;

437 i‡(!
ønge_sizek
)

440 
°©e
->
ønge_sizek
 =Ñange_sizek;

443 
ønge0_ba£k
 = 
°©e
->
ønge_°¨tk
;

444 
ønge0_sizek
 = 
	`ALIGN
(
°©e
->
ønge_sizek
, 
chunk_sizek
);

447 i‡(
ønge0_sizek
 =
°©e
->
ønge_sizek
) {

448 i‡(
debug_¥öt
)

449 
	`¥ötk
(
KERN_DEBUG
 "rangeX: %016lx - %016lx\n",

450 
ønge0_ba£k
<<10,

451 (
ønge0_ba£k
 + 
°©e
->
ønge_sizek
)<<10);

452 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

453 
°©e
->
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

458 i‡(
sizek
) {

459 
ønge0_ba£k
 + 
ønge0_sizek
 > (
ba£k
 + 
sizek
)) {

460 i‡(
ønge0_sizek
 >
chunk_sizek
)

461 
ønge0_sizek
 -
chunk_sizek
;

463 
ønge0_sizek
 = 0;

465 i‡(!
ønge0_sizek
)

470 
£c⁄d_åy
:

471 
ønge_ba£k
 = 
ønge0_ba£k
 + 
ønge0_sizek
;

474 i‡(
ønge_ba£k
 > 
ba£k
 &&Ñ™ge_ba£k <(ba£k + 
sizek
))

475 
£c⁄d_sizek
 = 
ønge_ba£k
 - 
ba£k
;

477 i‡(
ønge0_sizek
 > 
°©e
->
ønge_sizek
) {

480 
hﬁe_sizek
 = 
ønge0_sizek
 - 
°©e
->
ønge_sizek
 - 
£c⁄d_sizek
;

483 i‡(
hﬁe_sizek
 >(
ønge0_sizek
 >> 1) &&

484 
ønge0_sizek
 >
chunk_sizek
) {

485 
ønge0_sizek
 -
chunk_sizek
;

486 
£c⁄d_sizek
 = 0;

487 
hﬁe_sizek
 = 0;

489 
£c⁄d_åy
;

493 i‡(
ønge0_sizek
) {

494 i‡(
debug_¥öt
)

495 
	`¥ötk
(
KERN_DEBUG
 "range0: %016lx - %016lx\n",

496 
ønge0_ba£k
<<10,

497 (
ønge0_ba£k
 + 
ønge0_sizek
)<<10);

498 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

499 
ønge0_sizek
, 
MTRR_TYPE_WRBACK
);

502 i‡(
ønge0_sizek
 < 
°©e
->
ønge_sizek
) {

504 
ønge_sizek
 = 
°©e
->ønge_sizek - 
ønge0_sizek
;

506 i‡(
debug_¥öt
)

507 
	`¥ötk
(
KERN_DEBUG
 "range: %016lx - %016lx\n",

508 
ønge_ba£k
<<10,

509 (
ønge_ba£k
 + 
ønge_sizek
)<<10);

510 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge_ba£k
,

511 
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

514 i‡(
hﬁe_sizek
) {

515 
hﬁe_ba£k
 = 
ønge_ba£k
 - 
hﬁe_sizek
 - 
£c⁄d_sizek
;

516 i‡(
debug_¥öt
)

517 
	`¥ötk
(
KERN_DEBUG
 "hole: %016lx - %016lx\n",

518 
hﬁe_ba£k
<<10,

519 (
hﬁe_ba£k
 + 
hﬁe_sizek
)<<10);

520 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
hﬁe_ba£k
,

521 
hﬁe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

524  
£c⁄d_sizek
;

525 
	}
}

527 
__öô


528 
	$£t_v¨_mår_ønge
(
v¨_mår_°©e
 *
°©e
, 
ba£_p‚
,

529 
size_p‚
)

531 
ba£k
, 
sizek
;

532 
£c⁄d_sizek
 = 0;

534 i‡(
°©e
->
ªg
 >
num_v¨_ønges
)

537 
ba£k
 = 
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

538 
sizek
 = 
size_p‚
 << (
PAGE_SHIFT
 - 10);

541 i‡((
ba£k
 <= 1024) ||

542 (
°©e
->
ønge_°¨tk
 + sèã->
ønge_sizek
 =
ba£k
)) {

543 
ídk
 = 
ba£k
 + 
sizek
;

544 
°©e
->
ønge_sizek
 = 
ídk
 - sèã->
ønge_°¨tk
;

548 i‡(
°©e
->
ønge_sizek
 != 0)

549 
£c⁄d_sizek
 = 
	`ønge_to_mår_wôh_hﬁe
(
°©e
, 
ba£k
, 
sizek
);

552 
°©e
->
ønge_°¨tk
 = 
ba£k
 + 
£c⁄d_sizek
;

553 
°©e
->
ønge_sizek
 = 
sizek
 - 
£c⁄d_sizek
;

554 
	}
}

557 
u64
 
mår_chunk_size
 
	g__öôd©a
 = (256ULL<<20);

559 
__öô
 
	$∑r£_mår_chunk_size_›t
(*
p
)

561 i‡(!
p
)

562  -
EINVAL
;

563 
mår_chunk_size
 = 
	`mem∑r£
(
p
, &p);

565 
	}
}

566 
óæy_∑øm
("mår_chunk_size", 
∑r£_mår_chunk_size_›t
);

569 
u64
 
mår_gøn_size
 
	g__öôd©a
;

571 
__öô
 
	$∑r£_mår_gøn_size_›t
(*
p
)

573 i‡(!
p
)

574  -
EINVAL
;

575 
mår_gøn_size
 = 
	`mem∑r£
(
p
, &p);

577 
	}
}

578 
óæy_∑øm
("mår_gøn_size", 
∑r£_mår_gøn_size_›t
);

580 
ƒ_mår_•¨e_ªg
 
	g__öôd©a
 =

581 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

583 
__öô
 
	$∑r£_mår_•¨e_ªg
(*
¨g
)

585 i‡(
¨g
)

586 
ƒ_mår_•¨e_ªg
 = 
	`sim∂e_°πoul
(
¨g
, 
NULL
, 0);

588 
	}
}

590 
óæy_∑øm
("mår_•¨e_ªg_ƒ", 
∑r£_mår_•¨e_ªg
);

592 
__öô


593 
	$x86_£tup_v¨_mårs
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

594 
u64
 
chunk_size
, u64 
gøn_size
)

596 
v¨_mår_°©e
 
v¨_°©e
;

597 
i
;

598 
num_ªg
;

600 
v¨_°©e
.
ønge_°¨tk
 = 0;

601 
v¨_°©e
.
ønge_sizek
 = 0;

602 
v¨_°©e
.
ªg
 = 0;

603 
v¨_°©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

604 
v¨_°©e
.
gøn_sizek
 = 
gøn_size
 >> 10;

606 
	`mem£t
(
ønge_°©e
, 0, (range_state));

609 
i
 = 0; i < 
ƒ_ønge
; i++)

610 
	`£t_v¨_mår_ønge
(&
v¨_°©e
, 
ønge
[
i
].
°¨t
,

611 
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
 + 1);

614 i‡(
v¨_°©e
.
ønge_sizek
 != 0)

615 
	`ønge_to_mår_wôh_hﬁe
(&
v¨_°©e
, 0, 0);

617 
num_ªg
 = 
v¨_°©e
.
ªg
;

619 
v¨_°©e
.
ªg
 < 
num_v¨_ønges
) {

620 
	`ßve_v¨_mår
(
v¨_°©e
.
ªg
, 0, 0, 0);

621 
v¨_°©e
.
ªg
++;

624  
num_ªg
;

625 
	}
}

627 
	smår_˛ónup_ªsu…
 {

628 
	mgøn_sizek
;

629 
	mchunk_sizek
;

630 
	mlo£_covî_sizek
;

631 
	mnum_ªg
;

632 
	mbad
;

640 
	#NUM_RESULT
 136

	)

641 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

643 
mår_˛ónup_ªsu…
 
__öôd©a
 
	gªsu…
[
NUM_RESULT
];

644 
__öôd©a
 
	gmö_loss_p‚
[
RANGE_NUM
];

646 
__öô
 
	$¥öt_out_mår_ønge_°©e
()

648 
i
;

649 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

650 
°¨t_ba£
, 
size_ba£
;

651 
mår_ty≥
 
ty≥
;

653 
i
 = 0; i < 
num_v¨_ønges
; i++) {

655 
size_ba£
 = 
ønge_°©e
[
i
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

656 i‡(!
size_ba£
)

659 
size_ba£
 = 
	`to_size_Á˘‹
(size_ba£, &
size_Á˘‹
),

660 
°¨t_ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

661 
°¨t_ba£
 = 
	`to_size_Á˘‹
(°¨t_ba£, &
°¨t_Á˘‹
),

662 
ty≥
 = 
ønge_°©e
[
i
].type;

664 
	`¥ötk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,Ñange: %ld%cB,Åype %s\n",

665 
i
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

666 
size_ba£
, 
size_Á˘‹
,

667 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

668 ((
ty≥
 =
MTRR_TYPE_WRPROT
) ? "WP" :

669 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

672 
	}
}

674 
__öô
 
	$mår_√ed_˛ónup
()

676 
i
;

677 
mår_ty≥
 
ty≥
;

678 
size
;

680 
num
[
MTRR_NUM_TYPES
 + 1];

683 
	`mem£t
(
num
, 0, (num));

684 
i
 = 0; i < 
num_v¨_ønges
; i++) {

685 
ty≥
 = 
ønge_°©e
[
i
].type;

686 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

687 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

689 i‡(!
size
)

690 
ty≥
 = 
MTRR_NUM_TYPES
;

691 i‡(
ty≥
 =
MTRR_TYPE_WRPROT
)

692 
ty≥
 = 
MTRR_TYPE_UNCACHABLE
;

693 
num
[
ty≥
]++;

697 i‡(!
num
[
MTRR_TYPE_UNCACHABLE
])

701 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

702 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

706 
	}
}

708 
__öôd©a
 
	gønge_sums
;

709 
__öô
 
	$mår_ˇlc_ønge_°©e
(
u64
 
chunk_size
, u64 
gøn_size
,

710 
exåa_ªmove_ba£
,

711 
exåa_ªmove_size
,

712 
i
)

714 
num_ªg
;

715 
ªs_ønge
 
ønge_√w
[
RANGE_NUM
];

716 
ƒ_ønge_√w
;

717 
ønge_sums_√w
;

720 
num_ªg
 = 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
,

721 
chunk_size
, 
gøn_size
);

724 
	`mem£t
(
ønge_√w
, 0, (range_new));

725 
ƒ_ønge_√w
 = 
	`x86_gë_mår_mem_ønge
(
ønge_√w
, 0,

726 
exåa_ªmove_ba£
, 
exåa_ªmove_size
);

727 
ønge_sums_√w
 = 
	`sum_ønges
(
ønge_√w
, 
ƒ_ønge_√w
);

729 
ªsu…
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

730 
ªsu…
[
i
].
gøn_sizek
 = 
gøn_size
 >> 10;

731 
ªsu…
[
i
].
num_ªg
 =Çum_reg;

732 i‡(
ønge_sums
 < 
ønge_sums_√w
) {

733 
ªsu…
[
i
].
lo£_covî_sizek
 =

734 (
ønge_sums_√w
 - 
ønge_sums
Ë<< 
PSHIFT
;

735 
ªsu…
[
i
].
bad
 = 1;

737 
ªsu…
[
i
].
lo£_covî_sizek
 =

738 (
ønge_sums
 - 
ønge_sums_√w
Ë<< 
PSHIFT
;

741 i‡(!
ªsu…
[
i
].
bad
 && !ªsu…[i].
lo£_covî_sizek
) {

742 i‡(
ƒ_ønge_√w
 !
ƒ_ønge
 ||

743 
	`memcmp
(
ønge
, 
ønge_√w
, (range)))

744 
ªsu…
[
i
].
bad
 = 1;

747 i‡(!
ªsu…
[
i
].
bad
 && (
ønge_sums
 - 
ønge_sums_√w
 <

748 
mö_loss_p‚
[
num_ªg
])) {

749 
mö_loss_p‚
[
num_ªg
] =

750 
ønge_sums
 - 
ønge_sums_√w
;

752 
	}
}

754 
__öô
 
	$mår_¥öt_out_⁄e_ªsu…
(
i
)

756 
gøn_Á˘‹
, 
chunk_Á˘‹
, 
lo£_Á˘‹
;

757 
gøn_ba£
, 
chunk_ba£
, 
lo£_ba£
;

759 
gøn_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
gøn_sizek
, &
gøn_Á˘‹
),

760 
chunk_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
chunk_sizek
, &
chunk_Á˘‹
),

761 
lo£_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
lo£_covî_sizek
, &
lo£_Á˘‹
),

762 
	`¥ötk
(
KERN_INFO
 "%sgran_size: %ld%c \tchunk_size: %ld%c \t",

763 
ªsu…
[
i
].
bad
 ? "*BAD*" : " ",

764 
gøn_ba£
, 
gøn_Á˘‹
, 
chunk_ba£
, 
chunk_Á˘‹
);

765 
	`¥ötk
(
KERN_CONT
 "num_reg: %d \tlose cover RAM: %s%ld%c\n",

766 
ªsu…
[
i
].
num_ªg
,Ñesu…[i].
bad
 ? "-" : "",

767 
lo£_ba£
, 
lo£_Á˘‹
);

768 
	}
}

770 
__öô
 
	$mår_£¨ch_›timÆ_ödex
()

772 
i
;

773 
num_ªg_good
;

774 
ödex_good
;

776 i‡(
ƒ_mår_•¨e_ªg
 >
num_v¨_ønges
)

777 
ƒ_mår_•¨e_ªg
 = 
num_v¨_ønges
 - 1;

778 
num_ªg_good
 = -1;

779 
i
 = 
num_v¨_ønges
 - 
ƒ_mår_•¨e_ªg
; i > 0; i--) {

780 i‡(!
mö_loss_p‚
[
i
])

781 
num_ªg_good
 = 
i
;

784 
ödex_good
 = -1;

785 i‡(
num_ªg_good
 != -1) {

786 
i
 = 0; i < 
NUM_RESULT
; i++) {

787 i‡(!
ªsu…
[
i
].
bad
 &&

788 
ªsu…
[
i
].
num_ªg
 =
num_ªg_good
 &&

789 !
ªsu…
[
i
].
lo£_covî_sizek
) {

790 
ödex_good
 = 
i
;

796  
ödex_good
;

797 
	}
}

800 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

802 
exåa_ªmove_ba£
, 
exåa_ªmove_size
;

803 
ba£
, 
size
, 
def
, 
dummy
;

804 
mår_ty≥
 
ty≥
;

805 
u64
 
chunk_size
, 
gøn_size
;

806 
ödex_good
;

807 
i
;

809 i‡(!
	`is_˝u
(
INTEL
Ë|| 
íabÀ_mår_˛ónup
 < 1)

811 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

812 
def
 &= 0xff;

813 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

817 
	`mem£t
(
ønge_°©e
, 0, (range_state));

818 
i
 = 0; i < 
num_v¨_ønges
; i++) {

819 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

820 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

821 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

822 
ønge_°©e
[
i
].
ty≥
 =Åype;

826 i‡(!
	`mår_√ed_˛ónup
())

830 
	`¥ötk
(
KERN_DEBUG
 "original variable MTRRs\n");

831 
	`¥öt_out_mår_ønge_°©e
();

833 
	`mem£t
(
ønge
, 0, (range));

834 
exåa_ªmove_size
 = 0;

835 
exåa_ªmove_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

836 i‡(
mår_tom2
)

837 
exåa_ªmove_size
 =

838 (
mår_tom2
 >> 
PAGE_SHIFT
Ë- 
exåa_ªmove_ba£
;

839 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
, 0, 
exåa_ªmove_ba£
,

840 
exåa_ªmove_size
);

845 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_range, 0,

846 (1ULL<<(20 - 
PAGE_SHIFT
)) - 1);

848 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

850 
ønge_sums
 = 
	`sum_ønges
(
ønge
, 
ƒ_ønge
);

851 
	`¥ötk
(
KERN_INFO
 "total RAM coverred: %ldM\n",

852 
ønge_sums
 >> (20 - 
PAGE_SHIFT
));

854 i‡(
mår_chunk_size
 && 
mår_gøn_size
) {

855 
i
 = 0;

856 
	`mår_ˇlc_ønge_°©e
(
mår_chunk_size
, 
mår_gøn_size
,

857 
exåa_ªmove_ba£
, 
exåa_ªmove_size
, 
i
);

859 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

861 i‡(!
ªsu…
[
i
].
bad
) {

862 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

863 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

864 
	`¥öt_out_mår_ønge_°©e
();

867 
	`¥ötk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

871 
i
 = 0;

872 
	`mem£t
(
mö_loss_p‚
, 0xff, (min_loss_pfn));

873 
	`mem£t
(
ªsu…
, 0, (result));

874 
gøn_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

876 
chunk_size
 = 
gøn_size
; chunk_size < (1ULL<<32);

877 
chunk_size
 <<= 1) {

879 i‡(
i
 >
NUM_RESULT
)

882 
	`mår_ˇlc_ønge_°©e
(
chunk_size
, 
gøn_size
,

883 
exåa_ªmove_ba£
, 
exåa_ªmove_size
, 
i
);

884 i‡(
debug_¥öt
) {

885 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

886 
	`¥ötk
(
KERN_INFO
 "\n");

889 
i
++;

894 
ödex_good
 = 
	`mår_£¨ch_›timÆ_ödex
();

896 i‡(
ödex_good
 != -1) {

897 
	`¥ötk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

898 
i
 = 
ödex_good
;

899 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

902 
chunk_size
 = 
ªsu…
[
i
].
chunk_sizek
;

903 
chunk_size
 <<= 10;

904 
gøn_size
 = 
ªsu…
[
i
].
gøn_sizek
;

905 
gøn_size
 <<= 10;

906 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

907 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

908 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

909 
	`¥öt_out_mår_ønge_°©e
();

913 
i
 = 0; i < 
NUM_RESULT
; i++)

914 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

917 
	`¥ötk
(
KERN_INFO
 "mtrr_cleanup: canÇot find optimal value\n");

918 
	`¥ötk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

921 
	}
}

923 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

926 
	}
}

929 
	gdißbÀ_mår_åim
;

931 
__öô
 
	$dißbÀ_mår_åim_£tup
(*
°r
)

933 
dißbÀ_mår_åim
 = 1;

935 
	}
}

936 
óæy_∑øm
("dißbÀ_mår_åim", 
dißbÀ_mår_åim_£tup
);

944 
	#Tom2E«bÀd
 (1U << 21)

	)

945 
	#Tom2F‹˚MemTy≥WB
 (1U << 22)

	)

947 
__öô
 
	$amd_•ecül_deÁu…_mår
()

949 
u32
 
l
, 
h
;

951 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_AMD
)

953 i‡(
boŸ_˝u_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

956 i‡(
	`rdm§_ß„
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

962 i‡((
l
 & (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
)) ==

963 (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
))

966 
	}
}

968 
u64
 
__öô
 
	$ªÆ_åim_mem‹y
(
°¨t_p‚
,

969 
limô_p‚
)

971 
u64
 
åim_°¨t
, 
åim_size
;

972 
åim_°¨t
 = 
°¨t_p‚
;

973 
åim_°¨t
 <<
PAGE_SHIFT
;

974 
åim_size
 = 
limô_p‚
;

975 
åim_size
 <<
PAGE_SHIFT
;

976 
åim_size
 -
åim_°¨t
;

978  
	`e820_upd©e_ønge
(
åim_°¨t
, 
åim_size
, 
E820_RAM
,

979 
E820_RESERVED
);

980 
	}
}

992 
__öô
 
	$mår_åim_unˇched_mem‹y
(
íd_p‚
)

994 
i
, 
ba£
, 
size
, 
highe°_p‚
 = 0, 
def
, 
dummy
;

995 
mår_ty≥
 
ty≥
;

996 
u64
 
tŸÆ_åim_size
;

999 
num
[
MTRR_NUM_TYPES
 + 1];

1004 i‡(!
	`is_˝u
(
INTEL
Ë|| 
dißbÀ_mår_åim
)

1006 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

1007 
def
 &= 0xff;

1008 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

1012 
	`mem£t
(
ønge_°©e
, 0, (range_state));

1013 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1014 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

1015 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

1016 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

1017 
ønge_°©e
[
i
].
ty≥
 =Åype;

1021 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1022 
ty≥
 = 
ønge_°©e
[
i
].type;

1023 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

1025 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

1026 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1027 i‡(
highe°_p‚
 < 
ba£
 + 
size
)

1028 
highe°_p‚
 = 
ba£
 + 
size
;

1032 i‡(!
highe°_p‚
) {

1033 
	`¥ötk
(
KERN_INFO
 "CPU MTRRsáll blank - virtualized system.\n");

1038 
	`mem£t
(
num
, 0, (num));

1039 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1040 
ty≥
 = 
ønge_°©e
[
i
].type;

1041 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

1043 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1044 i‡(!
size
)

1045 
ty≥
 = 
MTRR_NUM_TYPES
;

1046 
num
[
ty≥
]++;

1050 i‡(!
num
[
MTRR_TYPE_WRBACK
])

1054 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

1055 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

1058 
	`mem£t
(
ønge
, 0, (range));

1059 
ƒ_ønge
 = 0;

1060 i‡(
mår_tom2
) {

1061 
ønge
[
ƒ_ønge
].
°¨t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

1062 
ønge
[
ƒ_ønge
].
íd
 = (
mår_tom2
 >> 
PAGE_SHIFT
) - 1;

1063 i‡(
highe°_p‚
 < 
ønge
[
ƒ_ønge
].
íd
 + 1)

1064 
highe°_p‚
 = 
ønge
[
ƒ_ønge
].
íd
 + 1;

1065 
ƒ_ønge
++;

1067 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
,Çr_range, 0, 0);

1069 
tŸÆ_åim_size
 = 0;

1071 i‡(
ønge
[0].
°¨t
)

1072 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(0, 
ønge
[0].
°¨t
);

1074 
i
 = 0; i < 
ƒ_ønge
 - 1; i++) {

1075 i‡(
ønge
[
i
].
íd
 + 1 <Ñ™ge[i+1].
°¨t
)

1076 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1077 
ønge
[
i
+1].
°¨t
);

1080 
i
 = 
ƒ_ønge
 - 1;

1081 i‡(
ønge
[
i
].
íd
 + 1 < 
íd_p‚
)

1082 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1083 
íd_p‚
);

1085 i‡(
tŸÆ_åim_size
) {

1086 
	`¥ötk
(
KERN_WARNING
 "WARNING: BIOS bug: CPU MTRRs don't cover"

1088 
tŸÆ_åim_size
 >> 20);

1090 i‡(!
ch™ged_by_mår_˛ónup
)

1091 
	`WARN_ON
(1);

1093 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for mtrr\n");

1094 
	`upd©e_e820
();

1100 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

3 
	~<löux/öô.h
>

4 
	~<löux/¶ab.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/moduÀ.h
>

7 
	~<asm/io.h
>

8 
	~<asm/mår.h
>

9 
	~<asm/m§.h
>

10 
	~<asm/sy°em.h
>

11 
	~<asm/˝u„©uª.h
>

12 
	~<asm/¥o˚ss‹-Êags.h
>

13 
	~<asm/ébÊush.h
>

14 
	~<asm/∑t.h
>

15 
	~"mår.h
"

17 
	sfixed_ønge_block
 {

18 
	mba£_m§
;

19 
	mønges
;

22 
fixed_ønge_block
 
	gfixed_ønge_blocks
[] = {

23 { 
MSR_MTRRfix64K_00000
, 1 },

24 { 
MSR_MTRRfix16K_80000
, 2 },

25 { 
MSR_MTRRfix4K_C0000
, 8 },

29 
	gsmp_ch™ges_mask
;

30 
	gmår_°©e_£t
;

31 
u64
 
	gmår_tom2
;

33 
mår_°©e_ty≥
 
	gmår_°©e
 = {};

34 
EXPORT_SYMBOL_GPL
(
mår_°©e
);

44 
ölöe
 
	$k8_check_syscfg_døm_mod_í
()

46 
u32
 
lo
, 
hi
;

48 i‡(!((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) &&

49 (
boŸ_˝u_d©a
.
x86
 >= 0x0f)))

52 
	`rdm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

53 i‡(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

54 
	`¥ötk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

56 
	`smp_¥o˚ss‹_id
());

57 
lo
 &~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

58 
	`mår_wrm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

60 
	}
}

68 
u8
 
	$mår_ty≥_lookup
(
u64
 
°¨t
, u64 
íd
)

70 
i
;

71 
u64
 
ba£
, 
mask
;

72 
u8
 
¥ev_m©ch
, 
cuº_m©ch
;

74 i‡(!
mår_°©e_£t
)

77 i‡(!
mår_°©e
.
íabÀd
)

81 
íd
--;

84 i‡(
mår_°©e
.
have_fixed
 && (
°¨t
 < 0x100000)) {

85 
idx
;

87 i‡(
°¨t
 < 0x80000) {

88 
idx
 = 0;

89 
idx
 +(
°¨t
 >> 16);

90  
mår_°©e
.
fixed_ønges
[
idx
];

91 } i‡(
°¨t
 < 0xC0000) {

92 
idx
 = 1 * 8;

93 
idx
 +((
°¨t
 - 0x80000) >> 14);

94  
mår_°©e
.
fixed_ønges
[
idx
];

95 } i‡(
°¨t
 < 0x1000000) {

96 
idx
 = 3 * 8;

97 
idx
 +((
°¨t
 - 0xC0000) >> 12);

98  
mår_°©e
.
fixed_ønges
[
idx
];

107 i‡(!(
mår_°©e
.
íabÀd
 & 2)) {

108  
mår_°©e
.
def_ty≥
;

111 
¥ev_m©ch
 = 0xFF;

112 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

113 
°¨t_°©e
, 
íd_°©e
;

115 i‡(!(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11)))

118 
ba£
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
) << 32) +

119 (
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

120 
mask
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
) << 32) +

121 (
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & 
PAGE_MASK
);

123 
°¨t_°©e
 = ((
°¨t
 & 
mask
Ë=(
ba£
 & mask));

124 
íd_°©e
 = ((
íd
 & 
mask
Ë=(
ba£
 & mask));

125 i‡(
°¨t_°©e
 !
íd_°©e
)

128 i‡((
°¨t
 & 
mask
Ë!(
ba£
 & mask)) {

132 
cuº_m©ch
 = 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff;

133 i‡(
¥ev_m©ch
 == 0xFF) {

134 
¥ev_m©ch
 = 
cuº_m©ch
;

138 i‡(
¥ev_m©ch
 =
MTRR_TYPE_UNCACHABLE
 ||

139 
cuº_m©ch
 =
MTRR_TYPE_UNCACHABLE
) {

140  
MTRR_TYPE_UNCACHABLE
;

143 i‡((
¥ev_m©ch
 =
MTRR_TYPE_WRBACK
 &&

144 
cuº_m©ch
 =
MTRR_TYPE_WRTHROUGH
) ||

145 (
¥ev_m©ch
 =
MTRR_TYPE_WRTHROUGH
 &&

146 
cuº_m©ch
 =
MTRR_TYPE_WRBACK
)) {

147 
¥ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

148 
cuº_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

151 i‡(
¥ev_m©ch
 !
cuº_m©ch
) {

152  
MTRR_TYPE_UNCACHABLE
;

156 i‡(
mår_tom2
) {

157 i‡(
°¨t
 >(1ULL<<32Ë&& (
íd
 < 
mår_tom2
))

158  
MTRR_TYPE_WRBACK
;

161 i‡(
¥ev_m©ch
 != 0xFF)

162  
¥ev_m©ch
;

164  
mår_°©e
.
def_ty≥
;

165 
	}
}

169 
	$gë_mår_v¨_ønge
(
ödex
, 
mår_v¨_ønge
 *
vr
)

171 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

172 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

173 
	}
}

176 
	$fûl_mår_v¨_ønge
(
ödex
,

177 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

179 
mår_v¨_ønge
 *
vr
;

181 
vr
 = 
mår_°©e
.
v¨_ønges
;

183 
vr
[
ödex
].
ba£_lo
 = base_lo;

184 
vr
[
ödex
].
ba£_hi
 = base_hi;

185 
vr
[
ödex
].
mask_lo
 = mask_lo;

186 
vr
[
ödex
].
mask_hi
 = mask_hi;

187 
	}
}

190 
	$gë_fixed_ønges
(
mår_ty≥
 * 
‰s
)

192 *
p
 = (*Ë
‰s
;

193 
i
;

195 
	`k8_check_syscfg_døm_mod_í
();

197 
	`rdm§
(
MSR_MTRRfix64K_00000
, 
p
[0],Ö[1]);

199 
i
 = 0; i < 2; i++)

200 
	`rdm§
(
MSR_MTRRfix16K_80000
 + 
i
, 
p
[2 + i * 2],Ö[3 + i * 2]);

201 
i
 = 0; i < 8; i++)

202 
	`rdm§
(
MSR_MTRRfix4K_C0000
 + 
i
, 
p
[6 + i * 2],Ö[7 + i * 2]);

203 
	}
}

205 
	$mår_ßve_fixed_ønges
(*
öfo
)

207 i‡(
˝u_has_mår
)

208 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

209 
	}
}

211 
__öôd©a
 
	gœ°_fixed_°¨t
;

212 
__öôd©a
 
	gœ°_fixed_íd
;

213 
mår_ty≥
 
__öôd©a
 
	gœ°_fixed_ty≥
;

215 
__öô
 
	$¥öt_fixed_œ°
()

217 i‡(!
œ°_fixed_íd
)

220 
	`¥ötk
(
KERN_DEBUG
 " %05X-%05X %s\n", 
œ°_fixed_°¨t
,

221 
œ°_fixed_íd
 - 1, 
	`mår_©åib_to_°r
(
œ°_fixed_ty≥
));

223 
œ°_fixed_íd
 = 0;

224 
	}
}

226 
__öô
 
	$upd©e_fixed_œ°
(
ba£
, 
íd
,

227 
mår_ty≥
 
ty≥
)

229 
œ°_fixed_°¨t
 = 
ba£
;

230 
œ°_fixed_íd
 = 
íd
;

231 
œ°_fixed_ty≥
 = 
ty≥
;

232 
	}
}

234 
__öô
 
	$¥öt_fixed
(
ba£
, 
°ï
,

235 c⁄° 
mår_ty≥
 *
ty≥s
)

237 
i
;

239 
i
 = 0; i < 8; ++i, ++
ty≥s
, 
ba£
 +
°ï
) {

240 i‡(
œ°_fixed_íd
 == 0) {

241 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

244 i‡(
œ°_fixed_íd
 =
ba£
 && 
œ°_fixed_ty≥
 =*
ty≥s
) {

245 
œ°_fixed_íd
 = 
ba£
 + 
°ï
;

249 
	`¥öt_fixed_œ°
();

250 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

252 
	}
}

254 
¥ï¨e_£t
();

255 
po°_£t
();

257 
__öô
 
	$¥öt_mår_°©e
()

259 
i
;

260 
high_width
;

262 
	`¥ötk
(
KERN_DEBUG
 "MTRR defaultÅype: %s\n",

263 
	`mår_©åib_to_°r
(
mår_°©e
.
def_ty≥
));

264 i‡(
mår_°©e
.
have_fixed
) {

265 
	`¥ötk
(
KERN_DEBUG
 "MTRR fixedÑanges %sabled:\n",

266 
mår_°©e
.
íabÀd
 & 1 ? "en" : "dis");

267 
	`¥öt_fixed
(0x00000, 0x10000, 
mår_°©e
.
fixed_ønges
 + 0);

268 
i
 = 0; i < 2; ++i)

269 
	`¥öt_fixed
(0x80000 + 
i
 * 0x20000, 0x04000, 
mår_°©e
.
fixed_ønges
 + (i + 1) * 8);

270 
i
 = 0; i < 8; ++i)

271 
	`¥öt_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000, 
mår_°©e
.
fixed_ønges
 + (i + 3) * 8);

274 
	`¥öt_fixed_œ°
();

276 
	`¥ötk
(
KERN_DEBUG
 "MTRR variableÑanges %sabled:\n",

277 
mår_°©e
.
íabÀd
 & 2 ? "en" : "dis");

278 i‡(
size_‹_mask
 & 0xffffffffUL)

279 
high_width
 = 
	`ffs
(
size_‹_mask
 & 0xffffffffUL) - 1;

281 
high_width
 = 
	`ffs
(
size_‹_mask
>>32) + 32 - 1;

282 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

283 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

284 i‡(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11))

285 
	`¥ötk
(
KERN_DEBUG
 " %u base %0*X%05X000 mask %0*X%05X000 %s\n",

286 
i
,

287 
high_width
,

288 
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
,

289 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 >> 12,

290 
high_width
,

291 
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
,

292 
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 >> 12,

293 
	`mår_©åib_to_°r
(
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff));

295 
	`¥ötk
(
KERN_DEBUG
 " %u dißbÀd\n", 
i
);

297 i‡(
mår_tom2
) {

298 
	`¥ötk
(
KERN_DEBUG
 "TOM2: %016llxáka %lldM\n",

299 
mår_tom2
, mtrr_tom2>>20);

301 
	}
}

304 
__öô
 
	$gë_mår_°©e
()

306 
i
;

307 
mår_v¨_ønge
 *
vrs
;

308 
lo
, 
dummy
;

309 
Êags
;

311 
vrs
 = 
mår_°©e
.
v¨_ønges
;

313 
	`rdm§
(
MSR_MTRRˇp
, 
lo
, 
dummy
);

314 
mår_°©e
.
have_fixed
 = (
lo
 >> 8) & 1;

316 
i
 = 0; i < 
num_v¨_ønges
; i++)

317 
	`gë_mår_v¨_ønge
(
i
, &
vrs
[i]);

318 i‡(
mår_°©e
.
have_fixed
)

319 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

321 
	`rdm§
(
MSR_MTRRdefTy≥
, 
lo
, 
dummy
);

322 
mår_°©e
.
def_ty≥
 = (
lo
 & 0xff);

323 
mår_°©e
.
íabÀd
 = (
lo
 & 0xc00) >> 10;

325 i‡(
	`amd_•ecül_deÁu…_mår
()) {

326 
low
, 
high
;

328 
	`rdm§
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

329 
mår_tom2
 = 
high
;

330 
mår_tom2
 <<= 32;

331 
mår_tom2
 |
low
;

332 
mår_tom2
 &= 0xffffff800000ULL;

335 
	`¥öt_mår_°©e
();

337 
mår_°©e_£t
 = 1;

340 
	`loˇl_úq_ßve
(
Êags
);

341 
	`¥ï¨e_£t
();

343 
	`∑t_öô
();

345 
	`po°_£t
();

346 
	`loˇl_úq_ª°‹e
(
Êags
);

348 
	}
}

351 
__öô
 
	$mår_°©e_w¨n
()

353 
mask
 = 
smp_ch™ges_mask
;

355 i‡(!
mask
)

357 i‡(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

358 
	`¥ötk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent fixed MTRR settings\n");

359 i‡(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

360 
	`¥ötk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent variable MTRR settings\n");

361 i‡(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

362 
	`¥ötk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent MTRRdefType settings\n");

363 
	`¥ötk
(
KERN_INFO
 "mtrr:Örobably your BIOS doesÇot setupáll CPUs.\n");

364 
	`¥ötk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

365 
	}
}

370 
	$mår_wrm§
(
m§
, 
a
, 
b
)

372 i‡(
	`wrm§_ß„
(
m§
, 
a
, 
b
) < 0)

373 
	`¥ötk
(
KERN_ERR


375 
	`smp_¥o˚ss‹_id
(), 
m§
, 
a
, 
b
);

376 
	}
}

384 
	$£t_fixed_ønge
(
m§
, 
boﬁ
 *
ch™ged
, *
m§w‹ds
)

386 
lo
, 
hi
;

388 
	`rdm§
(
m§
, 
lo
, 
hi
);

390 i‡(
lo
 !
m§w‹ds
[0] || 
hi
 != msrwords[1]) {

391 
	`mår_wrm§
(
m§
, 
m§w‹ds
[0], msrwords[1]);

392 *
ch™ged
 = 
åue
;

394 
	}
}

404 
	$gíîic_gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚_ªg
)

406 
i
, 
max
;

407 
mår_ty≥
 
…y≥
;

408 
lba£
, 
lsize
;

410 
max
 = 
num_v¨_ønges
;

411 i‡(
ª∂a˚_ªg
 >0 &&Ñïœ˚_ªg < 
max
)

412  
ª∂a˚_ªg
;

413 
i
 = 0; i < 
max
; ++i) {

414 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

415 i‡(
lsize
 == 0)

416  
i
;

418  -
ENOSPC
;

419 
	}
}

421 
	$gíîic_gë_mår
(
ªg
, *
ba£
,

422 *
size
, 
mår_ty≥
 *
ty≥
)

424 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

425 
tmp
, 
hi
;

426 
˝u
;

432 
˝u
 = 
	`gë_˝u
();

434 
	`rdm§
(
	`MTRRphysMask_MSR
(
ªg
), 
mask_lo
, 
mask_hi
);

436 i‡((
mask_lo
 & 0x800) == 0) {

438 *
ba£
 = 0;

439 *
size
 = 0;

440 *
ty≥
 = 0;

441 
out_put_˝u
;

444 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
ba£_lo
, 
ba£_hi
);

447 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
Ë| 
mask_lo
 >> PAGE_SHIFT;

448 
mask_lo
 = 
size_‹_mask
 | 
tmp
;

451 
hi
 = 
	`Ês
(
tmp
);

452 i‡(
hi
 > 0) {

453 
tmp
 |~((1<<(
hi
 - 1)) - 1);

455 i‡(
tmp
 !
mask_lo
) {

456 
	`WARN_ONCE
(1, 
KERN_INFO
 "mtrr: your BIOS has set upán incorrect mask, fixing it up.\n");

457 
mask_lo
 = 
tmp
;

465 *
size
 = -
mask_lo
;

466 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
Ë| 
ba£_lo
 >> PAGE_SHIFT;

467 *
ty≥
 = 
ba£_lo
 & 0xff;

469 
out_put_˝u
:

470 
	`put_˝u
();

471 
	}
}

477 
	$£t_fixed_ønges
(
mår_ty≥
 * 
‰s
)

479 *
ßved
 = (*Ë
‰s
;

480 
boﬁ
 
ch™ged
 = 
Ál£
;

481 
block
=-1, 
ønge
;

483 
	`k8_check_syscfg_døm_mod_í
();

485 
fixed_ønge_blocks
[++
block
].
ønges
)

486 
ønge
=0;Ñ™gê< 
fixed_ønge_blocks
[
block
].
ønges
;Ñange++)

487 
	`£t_fixed_ønge
(
fixed_ønge_blocks
[
block
].
ba£_m§
 + 
ønge
,

488 &
ch™ged
, (*Ë
ßved
++);

490  
ch™ged
;

491 
	}
}

495 
boﬁ
 
	$£t_mår_v¨_ønges
(
ödex
, 
mår_v¨_ønge
 *
vr
)

497 
lo
, 
hi
;

498 
boﬁ
 
ch™ged
 = 
Ál£
;

500 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
lo
, 
hi
);

501 i‡((
vr
->
ba£_lo
 & 0xfffff0ffULË!(
lo
 & 0xfffff0ffUL)

502 || (
vr
->
ba£_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

503 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

504 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

505 
ch™ged
 = 
åue
;

508 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
lo
, 
hi
);

510 i‡((
vr
->
mask_lo
 & 0xfffff800ULË!(
lo
 & 0xfffff800UL)

511 || (
vr
->
mask_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

512 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

513 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

514 
ch™ged
 = 
åue
;

516  
ch™ged
;

517 
	}
}

519 
u32
 
	gde·y≥_lo
, 
	gde·y≥_hi
;

527 
	$£t_mår_°©e
()

529 
i
;

530 
ch™ge_mask
 = 0;

532 
i
 = 0; i < 
num_v¨_ønges
; i++)

533 i‡(
	`£t_mår_v¨_ønges
(
i
, &
mår_°©e
.
v¨_ønges
[i]))

534 
ch™ge_mask
 |
MTRR_CHANGE_MASK_VARIABLE
;

536 i‡(
mår_°©e
.
have_fixed
 && 
	`£t_fixed_ønges
(mår_°©e.
fixed_ønges
))

537 
ch™ge_mask
 |
MTRR_CHANGE_MASK_FIXED
;

541 i‡((
de·y≥_lo
 & 0xffË!
mår_°©e
.
def_ty≥


542 || ((
de·y≥_lo
 & 0xc00Ë>> 10Ë!
mår_°©e
.
íabÀd
) {

543 
de·y≥_lo
 = (de·y≥_lÿ& ~0xcffË| 
mår_°©e
.
def_ty≥
 | (mår_°©e.
íabÀd
 << 10);

544 
ch™ge_mask
 |
MTRR_CHANGE_MASK_DEFTYPE
;

547  
ch™ge_mask
;

548 
	}
}

551 
	g¸4
 = 0;

552 
DEFINE_SPINLOCK
(
£t_©omicôy_lock
);

561 
	$¥ï¨e_£t
(Ë
	$__acquúes
(
£t_©omicôy_lock
)

563 
¸0
;

569 
	`•ö_lock
(&
£t_©omicôy_lock
);

572 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

573 
	`wrôe_¸0
(
¸0
);

574 
	`wbövd
();

577 i‡–
˝u_has_pge
 ) {

578 
¸4
 = 
	`ªad_¸4
();

579 
	`wrôe_¸4
(
¸4
 & ~
X86_CR4_PGE
);

583 
	`__Êush_éb
();

586 
	`rdm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

589 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
 & ~0xcff, 
de·y≥_hi
);

590 
	}
}

592 
	$po°_£t
(Ë
	$__ªÀa£s
(
£t_©omicôy_lock
)

595 
	`__Êush_éb
();

598 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

601 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

604 i‡–
˝u_has_pge
 )

605 
	`wrôe_¸4
(
¸4
);

606 
	`•ö_u∆ock
(&
£t_©omicôy_lock
);

607 
	}
}

609 
	$gíîic_£t_Æl
()

611 
mask
, 
cou¡
;

612 
Êags
;

614 
	`loˇl_úq_ßve
(
Êags
);

615 
	`¥ï¨e_£t
();

618 
mask
 = 
	`£t_mår_°©e
();

621 
	`∑t_öô
();

623 
	`po°_£t
();

624 
	`loˇl_úq_ª°‹e
(
Êags
);

627 
cou¡
 = 0; cou¡ <  
mask
 * 8; ++count) {

628 i‡(
mask
 & 0x01)

629 
	`£t_bô
(
cou¡
, &
smp_ch™ges_mask
);

630 
mask
 >>= 1;

633 
	}
}

635 
	$gíîic_£t_mår
(
ªg
, 
ba£
,

636 
size
, 
mår_ty≥
 
ty≥
)

645 
Êags
;

646 
mår_v¨_ønge
 *
vr
;

648 
vr
 = &
mår_°©e
.
v¨_ønges
[
ªg
];

650 
	`loˇl_úq_ßve
(
Êags
);

651 
	`¥ï¨e_£t
();

653 i‡(
size
 == 0) {

656 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 0, 0);

657 
	`mem£t
(
vr
, 0, (
mår_v¨_ønge
));

659 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty≥
;

660 
vr
->
ba£_hi
 = (
ba£
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

661 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

662 
vr
->
mask_hi
 = (-
size
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

664 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

665 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 
vr
->
mask_lo
, vr->
mask_hi
);

668 
	`po°_£t
();

669 
	`loˇl_úq_ª°‹e
(
Êags
);

670 
	}
}

672 
	$gíîic_vÆid©e_add_∑ge
(
ba£
, 
size
, 
ty≥
)

674 
lba£
, 
œ°
;

678 i‡(
	`is_˝u
(
INTEL
Ë&& 
boŸ_˝u_d©a
.
x86
 == 6 &&

679 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

680 
boŸ_˝u_d©a
.
x86_mask
 <= 7) {

681 i‡(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

682 
	`¥ötk
(
KERN_WARNING
 "mår: ba£(0x%lx000Ëi†nŸ 4 MiBálig√d\n", 
ba£
);

683  -
EINVAL
;

685 i‡(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

686 (
ty≥
 =
MTRR_TYPE_WRCOMB


687 || 
ty≥
 =
MTRR_TYPE_WRBACK
)) {

688 
	`¥ötk
(
KERN_WARNING
 "mtrr: writable mtrr between 0x70000000ánd 0x7003FFFF may hangÅhe CPU.\n");

689  -
EINVAL
;

695 
œ°
 = 
ba£
 + 
size
 - 1;

696 
lba£
 = 
ba£
; !÷ba£ & 1Ë&& (
œ°
 & 1);

697 
lba£
 =Üba£ >> 1, 
œ°
 =Üast >> 1) ;

698 i‡(
lba£
 !
œ°
) {

699 
	`¥ötk
(
KERN_WARNING
 "mtrr: base(0x%lx000) isÇotáligned oná size(0x%lx000) boundary\n",

700 
ba£
, 
size
);

701  -
EINVAL
;

704 
	}
}

707 
	$gíîic_have_wrcomb
()

709 
c⁄fig
, 
dummy
;

710 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

711  (
c⁄fig
 & (1 << 10));

712 
	}
}

714 
	$posôive_have_wrcomb
()

717 
	}
}

721 
mår_›s
 
	ggíîic_mår_›s
 = {

722 .
u£_öãl_if
 = 1,

723 .
	g£t_Æl
 = 
gíîic_£t_Æl
,

724 .
	ggë
 = 
gíîic_gë_mår
,

725 .
	ggë_‰ì_ªgi⁄
 = 
gíîic_gë_‰ì_ªgi⁄
,

726 .
	g£t
 = 
gíîic_£t_mår
,

727 .
	gvÆid©e_add_∑ge
 = 
gíîic_vÆid©e_add_∑ge
,

728 .
	ghave_wrcomb
 = 
gíîic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<löux/öô.h
>

2 
	~<löux/¥oc_fs.h
>

3 
	~<löux/ˇ∑bûôy.h
>

4 
	~<löux/˘y≥.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/£q_fûe.h
>

7 
	~<asm/uac˚ss.h
>

9 
	#LINE_SIZE
 80

	)

11 
	~<asm/mår.h
>

12 
	~"mår.h
"

14 
	#FILE_FCOUNT
(
f
Ë(((
£q_fûe
 *)((f)->
¥iv©e_d©a
))->
¥iv©e
)

	)

16 c⁄° *c⁄° 
	gmår_°rögs
[
MTRR_NUM_TYPES
] =

27 c⁄° *
	$mår_©åib_to_°r
(
x
)

29  (
x
 <6Ë? 
mår_°rögs
[x] : "?";

30 
	}
}

32 #ifde‡
CONFIG_PROC_FS


35 
	$mår_fûe_add
(
ba£
, 
size
,

36 
ty≥
, 
boﬁ
 
ö¸emít
, 
fûe
 *fûe, 
∑ge
)

38 
ªg
, 
max
;

39 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

41 
max
 = 
num_v¨_ønges
;

42 i‡(
fcou¡
 =
NULL
) {

43 
fcou¡
 = 
	`kzÆloc
(
max
 *  *fcou¡, 
GFP_KERNEL
);

44 i‡(!
fcou¡
)

45  -
ENOMEM
;

46 
	`FILE_FCOUNT
(
fûe
Ë
fcou¡
;

48 i‡(!
∑ge
) {

49 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

50  -
EINVAL
;

51 
ba£
 >>
PAGE_SHIFT
;

52 
size
 >>
PAGE_SHIFT
;

54 
ªg
 = 
	`mår_add_∑ge
(
ba£
, 
size
, 
ty≥
, 
åue
);

55 i‡(
ªg
 >= 0)

56 ++
fcou¡
[
ªg
];

57  
ªg
;

58 
	}
}

61 
	$mår_fûe_dñ
(
ba£
, 
size
,

62 
fûe
 *fûe, 
∑ge
)

64 
ªg
;

65 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

67 i‡(!
∑ge
) {

68 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

69  -
EINVAL
;

70 
ba£
 >>
PAGE_SHIFT
;

71 
size
 >>
PAGE_SHIFT
;

73 
ªg
 = 
	`mår_dñ_∑ge
(-1, 
ba£
, 
size
);

74 i‡(
ªg
 < 0)

75  
ªg
;

76 i‡(
fcou¡
 =
NULL
)

77  
ªg
;

78 i‡(
fcou¡
[
ªg
] < 1)

79  -
EINVAL
;

80 --
fcou¡
[
ªg
];

81  
ªg
;

82 
	}
}

85 
ssize_t


86 
	$mår_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 * 
µos
)

92 
i
, 
îr
;

93 
ªg
;

94 
ba£
, 
size
;

95 *
±r
;

96 
löe
[
LINE_SIZE
];

97 
size_t
 
löñí
;

99 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

100  -
EPERM
;

101 i‡(!
Àn
)

102  -
EINVAL
;

103 
	`mem£t
(
löe
, 0, 
LINE_SIZE
);

104 i‡(
Àn
 > 
LINE_SIZE
)

105 
Àn
 = 
LINE_SIZE
;

106 i‡(
	`c›y_‰om_u£r
(
löe
, 
buf
, 
Àn
 - 1))

107  -
EFAULT
;

108 
löñí
 = 
	`°æí
(
löe
);

109 
±r
 = 
löe
 + 
löñí
 - 1;

110 i‡(
löñí
 && *
±r
 == '\n')

111 *
±r
 = '\0';

112 i‡(!
	`°∫cmp
(
löe
, "disable=", 8)) {

113 
ªg
 = 
	`sim∂e_°πoul
(
löe
 + 8, &
±r
, 0);

114 
îr
 = 
	`mår_dñ_∑ge
(
ªg
, 0, 0);

115 i‡(
îr
 < 0)

116  
îr
;

117  
Àn
;

119 i‡(
	`°∫cmp
(
löe
, "base=", 5))

120  -
EINVAL
;

121 
ba£
 = 
	`sim∂e_°πouŒ
(
löe
 + 5, &
±r
, 0);

122 ; 
	`is•a˚
(*
±r
); ++ptr) ;

123 i‡(
	`°∫cmp
(
±r
, "size=", 5))

124  -
EINVAL
;

125 
size
 = 
	`sim∂e_°πouŒ
(
±r
 + 5, &ptr, 0);

126 i‡((
ba£
 & 0xfffË|| (
size
 & 0xfff))

127  -
EINVAL
;

128 ; 
	`is•a˚
(*
±r
); ++ptr) ;

129 i‡(
	`°∫cmp
(
±r
, "type=", 5))

130  -
EINVAL
;

131 
±r
 += 5;

132 ; 
	`is•a˚
(*
±r
); ++ptr) ;

133 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

134 i‡(
	`°rcmp
(
±r
, 
mår_°rögs
[
i
]))

136 
ba£
 >>
PAGE_SHIFT
;

137 
size
 >>
PAGE_SHIFT
;

138 
îr
 =

139 
	`mår_add_∑ge
((Ë
ba£
, (Ë
size
, 
i
,

140 
åue
);

141 i‡(
îr
 < 0)

142  
îr
;

143  
Àn
;

145  -
EINVAL
;

146 
	}
}

149 
	$mår_io˘l
(
fûe
 *fûe, 
cmd
, 
__¨g
)

151 
îr
 = 0;

152 
mår_ty≥
 
ty≥
;

153 
size
;

154 
mår_£¡ry
 
£¡ry
;

155 
mår_gíåy
 
gíåy
;

156 
__u£r
 *
¨g
 = (__u£∏*Ë
__¨g
;

158 
cmd
) {

159 
MTRRIOC_ADD_ENTRY
:

160 
MTRRIOC_SET_ENTRY
:

161 
MTRRIOC_DEL_ENTRY
:

162 
MTRRIOC_KILL_ENTRY
:

163 
MTRRIOC_ADD_PAGE_ENTRY
:

164 
MTRRIOC_SET_PAGE_ENTRY
:

165 
MTRRIOC_DEL_PAGE_ENTRY
:

166 
MTRRIOC_KILL_PAGE_ENTRY
:

167 i‡(
	`c›y_‰om_u£r
(&
£¡ry
, 
¨g
,  sentry))

168  -
EFAULT
;

170 
MTRRIOC_GET_ENTRY
:

171 
MTRRIOC_GET_PAGE_ENTRY
:

172 i‡(
	`c›y_‰om_u£r
(&
gíåy
, 
¨g
,  gentry))

173  -
EFAULT
;

175 #ifde‡
CONFIG_COMPAT


176 
MTRRIOC32_ADD_ENTRY
:

177 
MTRRIOC32_SET_ENTRY
:

178 
MTRRIOC32_DEL_ENTRY
:

179 
MTRRIOC32_KILL_ENTRY
:

180 
MTRRIOC32_ADD_PAGE_ENTRY
:

181 
MTRRIOC32_SET_PAGE_ENTRY
:

182 
MTRRIOC32_DEL_PAGE_ENTRY
:

183 
MTRRIOC32_KILL_PAGE_ENTRY
: {

184 
mår_£¡ry32
 
__u£r
 *
s32
 = (mår_£¡ry32 __u£∏*)
__¨g
;

185 
îr
 = 
	`gë_u£r
(
£¡ry
.
ba£
, &
s32
->base);

186 
îr
 |
	`gë_u£r
(
£¡ry
.
size
, &
s32
->size);

187 
îr
 |
	`gë_u£r
(
£¡ry
.
ty≥
, &
s32
->type);

188 i‡(
îr
)

189  
îr
;

192 
MTRRIOC32_GET_ENTRY
:

193 
MTRRIOC32_GET_PAGE_ENTRY
: {

194 
mår_gíåy32
 
__u£r
 *
g32
 = (mår_gíåy32 __u£∏*)
__¨g
;

195 
îr
 = 
	`gë_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

196 
îr
 |
	`gë_u£r
(
gíåy
.
ba£
, &
g32
->base);

197 
îr
 |
	`gë_u£r
(
gíåy
.
size
, &
g32
->size);

198 
îr
 |
	`gë_u£r
(
gíåy
.
ty≥
, &
g32
->type);

199 i‡(
îr
)

200  
îr
;

206 
cmd
) {

208  -
ENOTTY
;

209 
MTRRIOC_ADD_ENTRY
:

210 #ifde‡
CONFIG_COMPAT


211 
MTRRIOC32_ADD_ENTRY
:

213 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

214  -
EPERM
;

215 
îr
 =

216 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

217 
fûe
, 0);

219 
MTRRIOC_SET_ENTRY
:

220 #ifde‡
CONFIG_COMPAT


221 
MTRRIOC32_SET_ENTRY
:

223 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

224  -
EPERM
;

225 
îr
 = 
	`mår_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

227 
MTRRIOC_DEL_ENTRY
:

228 #ifde‡
CONFIG_COMPAT


229 
MTRRIOC32_DEL_ENTRY
:

231 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

232  -
EPERM
;

233 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 0);

235 
MTRRIOC_KILL_ENTRY
:

236 #ifde‡
CONFIG_COMPAT


237 
MTRRIOC32_KILL_ENTRY
:

239 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

240  -
EPERM
;

241 
îr
 = 
	`mår_dñ
(-1, 
£¡ry
.
ba£
, síåy.
size
);

243 
MTRRIOC_GET_ENTRY
:

244 #ifde‡
CONFIG_COMPAT


245 
MTRRIOC32_GET_ENTRY
:

247 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

248  -
EINVAL
;

249 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

252 i‡(
gíåy
.
ba£
 + 
size
 - 1 >(1UL << (8 * (gíåy.sizeË- 
PAGE_SHIFT
))

253 || 
size
 >(1UL << (8 * (
gíåy
.sizeË- 
PAGE_SHIFT
)))

254 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

256 
gíåy
.
ba£
 <<
PAGE_SHIFT
;

257 
gíåy
.
size
 = sizê<< 
PAGE_SHIFT
;

258 
gíåy
.
ty≥
 =Åype;

262 
MTRRIOC_ADD_PAGE_ENTRY
:

263 #ifde‡
CONFIG_COMPAT


264 
MTRRIOC32_ADD_PAGE_ENTRY
:

266 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

267  -
EPERM
;

268 
îr
 =

269 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

270 
fûe
, 1);

272 
MTRRIOC_SET_PAGE_ENTRY
:

273 #ifde‡
CONFIG_COMPAT


274 
MTRRIOC32_SET_PAGE_ENTRY
:

276 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

277  -
EPERM
;

278 
îr
 =

279 
	`mår_add_∑ge
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

281 
MTRRIOC_DEL_PAGE_ENTRY
:

282 #ifde‡
CONFIG_COMPAT


283 
MTRRIOC32_DEL_PAGE_ENTRY
:

285 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

286  -
EPERM
;

287 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 1);

289 
MTRRIOC_KILL_PAGE_ENTRY
:

290 #ifde‡
CONFIG_COMPAT


291 
MTRRIOC32_KILL_PAGE_ENTRY
:

293 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

294  -
EPERM
;

295 
îr
 = 
	`mår_dñ_∑ge
(-1, 
£¡ry
.
ba£
, síåy.
size
);

297 
MTRRIOC_GET_PAGE_ENTRY
:

298 #ifde‡
CONFIG_COMPAT


299 
MTRRIOC32_GET_PAGE_ENTRY
:

301 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

302  -
EINVAL
;

303 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

305 i‡(
size
 !(
	`__ty≥of__
(
gíåy
.size))size)

306 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

308 
gíåy
.
size
 = size;

309 
gíåy
.
ty≥
 =Åype;

314 i‡(
îr
)

315  
îr
;

317 
cmd
) {

318 
MTRRIOC_GET_ENTRY
:

319 
MTRRIOC_GET_PAGE_ENTRY
:

320 i‡(
	`c›y_to_u£r
(
¨g
, &
gíåy
,  gentry))

321 
îr
 = -
EFAULT
;

323 #ifde‡
CONFIG_COMPAT


324 
MTRRIOC32_GET_ENTRY
:

325 
MTRRIOC32_GET_PAGE_ENTRY
: {

326 
mår_gíåy32
 
__u£r
 *
g32
 = (mår_gíåy32 __u£∏*)
__¨g
;

327 
îr
 = 
	`put_u£r
(
gíåy
.
ba£
, &
g32
->base);

328 
îr
 |
	`put_u£r
(
gíåy
.
size
, &
g32
->size);

329 
îr
 |
	`put_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

330 
îr
 |
	`put_u£r
(
gíåy
.
ty≥
, &
g32
->type);

335  
îr
;

336 
	}
}

339 
	$mår_˛o£
(
öode
 *
öo
, 
fûe
 *file)

341 
i
, 
max
;

342 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

344 i‡(
fcou¡
 !
NULL
) {

345 
max
 = 
num_v¨_ønges
;

346 
i
 = 0; i < 
max
; ++i) {

347 
fcou¡
[
i
] > 0) {

348 
	`mår_dñ
(
i
, 0, 0);

349 --
fcou¡
[
i
];

352 
	`k‰ì
(
fcou¡
);

353 
	`FILE_FCOUNT
(
fûe
Ë
NULL
;

355  
	`sögÀ_ªÀa£
(
öo
, 
fûe
);

356 
	}
}

358 
mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
);

360 
	$mår_›í
(
öode
 *öode, 
fûe
 *file)

362 i‡(!
mår_if
)

363  -
EIO
;

364 i‡(!
mår_if
->
gë
)

365  -
ENXIO
;

366  
	`sögÀ_›í
(
fûe
, 
mår_£q_show
, 
NULL
);

367 
	}
}

369 c⁄° 
fûe_›î©i⁄s
 
	gmår_f›s
 = {

370 .
ow√r
 = 
THIS_MODULE
,

371 .
	g›í
 = 
mår_›í
,

372 .
	gªad
 = 
£q_ªad
,

373 .
	gŒ£ek
 = 
£q_l£ek
,

374 .
	gwrôe
 = 
mår_wrôe
,

375 .
	gu∆ocked_io˘l
 = 
mår_io˘l
,

376 .
	gcom∑t_io˘l
 = 
mår_io˘l
,

377 .
	gªÀa£
 = 
mår_˛o£
,

380 
	$mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
)

382 
Á˘‹
;

383 
i
, 
max
, 
Àn
;

384 
mår_ty≥
 
ty≥
;

385 
ba£
, 
size
;

387 
Àn
 = 0;

388 
max
 = 
num_v¨_ønges
;

389 
i
 = 0; i < 
max
; i++) {

390 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

391 i‡(
size
 == 0)

392 
mår_ußge_èbÀ
[
i
] = 0;

394 i‡(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

396 
Á˘‹
 = 'K';

397 
size
 <<
PAGE_SHIFT
 - 10;

399 
Á˘‹
 = 'M';

400 
size
 >>20 - 
PAGE_SHIFT
;

403 
Àn
 +
	`£q_¥ötf
(
£q
,

405 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
, 
Á˘‹
,

406 
mår_ußge_èbÀ
[
i
], 
	`mår_©åib_to_°r
(
ty≥
));

410 
	}
}

412 
__öô
 
	$mår_if_öô
()

414 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

416 i‡((!
	`˝u_has
(
c
, 
X86_FEATURE_MTRR
)) &&

417 (!
	`˝u_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

418 (!
	`˝u_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

419 (!
	`˝u_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

420  -
ENODEV
;

422 
	`¥oc_¸óã
("mår", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mår_f›s
);

424 
	}
}

426 
¨ch_öôˇŒ
(
mår_if_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	~<löux/moduÀ.h
>

35 
	~<löux/öô.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/smp.h
>

38 
	~<löux/˝u.h
>

39 
	~<löux/muãx.h
>

40 
	~<löux/s‹t.h
>

42 
	~<asm/e820.h
>

43 
	~<asm/mår.h
>

44 
	~<asm/uac˚ss.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/m§.h
>

47 
	~<asm/kvm_∑ø.h
>

48 
	~"mår.h
"

50 
u32
 
	gnum_v¨_ønges
 = 0;

52 
	gmår_ußge_èbÀ
[
MTRR_MAX_VAR_RANGES
];

53 
DEFINE_MUTEX
(
mår_muãx
);

55 
u64
 
	gsize_‹_mask
, 
	gsize_™d_mask
;

57 
mår_›s
 * 
	gmår_›s
[
X86_VENDOR_NUM
] = {};

59 
mår_›s
 * 
	gmår_if
 = 
NULL
;

61 
£t_mår
(
ªg
, 
ba£
,

62 
size
, 
mår_ty≥
 
ty≥
);

64 
	$£t_mår_›s
(
mår_›s
 * 
›s
)

66 i‡(
›s
->
víd‹
 && ops->víd‹ < 
X86_VENDOR_NUM
)

67 
mår_›s
[
›s
->
víd‹
] = ops;

68 
	}
}

71 
	$have_wrcomb
()

73 
pci_dev
 *
dev
;

74 
u8
 
ªv
;

76 i‡((
dev
 = 
	`pci_gë_˛ass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
)) != NULL) {

79 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_SERVERWORKS
 &&

80 
dev
->
devi˚
 =
PCI_DEVICE_ID_SERVERWORKS_LE
) {

81 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

82 i‡(
ªv
 <= 5) {

83 
	`¥ötk
(
KERN_INFO
 "mtrr: Serverworks LEÑev < 6 detected. Write-combining disabled.\n");

84 
	`pci_dev_put
(
dev
);

90 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_INTEL
 &&

91 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTEL_82451NX
) {

92 
	`¥ötk
(
KERN_INFO
 "mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

93 
	`pci_dev_put
(
dev
);

96 
	`pci_dev_put
(
dev
);

98  (
mår_if
->
have_wrcomb
 ? mår_if->
	`have_wrcomb
() : 0);

99 
	}
}

102 
__öô
 
	$£t_num_v¨_ønges
()

104 
c⁄fig
 = 0, 
dummy
;

106 i‡(
	`u£_öãl
()) {

107 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

108 } i‡(
	`is_˝u
(
AMD
))

109 
c⁄fig
 = 2;

110 i‡(
	`is_˝u
(
CYRIX
Ë|| is_˝u(
CENTAUR
))

111 
c⁄fig
 = 8;

112 
num_v¨_ønges
 = 
c⁄fig
 & 0xff;

113 
	}
}

115 
__öô
 
	$öô_èbÀ
()

117 
i
, 
max
;

119 
max
 = 
num_v¨_ønges
;

120 
i
 = 0; i < 
max
; i++)

121 
mår_ußge_èbÀ
[
i
] = 1;

122 
	}
}

124 
	s£t_mår_d©a
 {

125 
©omic_t
 
	mcou¡
;

126 
©omic_t
 
	mg©e
;

127 
	msmp_ba£
;

128 
	msmp_size
;

129 
	msmp_ªg
;

130 
mår_ty≥
 
	msmp_ty≥
;

133 
	$ùi_h™dÀr
(*
öfo
)

138 #ifde‡
CONFIG_SMP


139 
£t_mår_d©a
 *
d©a
 = 
öfo
;

140 
Êags
;

142 
	`loˇl_úq_ßve
(
Êags
);

144 
	`©omic_dec
(&
d©a
->
cou¡
);

145 !
	`©omic_ªad
(&
d©a
->
g©e
))

146 
	`˝u_ªœx
();

149 i‡(
d©a
->
smp_ªg
 != ~0U)

150 
mår_if
->
	`£t
(
d©a
->
smp_ªg
, d©a->
smp_ba£
,

151 
d©a
->
smp_size
, d©a->
smp_ty≥
);

153 
mår_if
->
	`£t_Æl
();

155 
	`©omic_dec
(&
d©a
->
cou¡
);

156 
	`©omic_ªad
(&
d©a
->
g©e
))

157 
	`˝u_ªœx
();

159 
	`©omic_dec
(&
d©a
->
cou¡
);

160 
	`loˇl_úq_ª°‹e
(
Êags
);

162 
	}
}

164 
ölöe
 
	$ty≥s_com∑tibÀ
(
mår_ty≥
 
ty≥1
, mår_ty≥ 
ty≥2
) {

165  
ty≥1
 =
MTRR_TYPE_UNCACHABLE
 ||

166 
ty≥2
 =
MTRR_TYPE_UNCACHABLE
 ||

167 (
ty≥1
 =
MTRR_TYPE_WRTHROUGH
 && 
ty≥2
 =
MTRR_TYPE_WRBACK
) ||

168 (
ty≥1
 =
MTRR_TYPE_WRBACK
 && 
ty≥2
 =
MTRR_TYPE_WRTHROUGH
);

169 
	}
}

210 
	$£t_mår
(
ªg
, 
ba£
,

211 
size
, 
mår_ty≥
 
ty≥
)

213 
£t_mår_d©a
 
d©a
;

214 
Êags
;

216 
d©a
.
smp_ªg
 = 
ªg
;

217 
d©a
.
smp_ba£
 = 
ba£
;

218 
d©a
.
smp_size
 = 
size
;

219 
d©a
.
smp_ty≥
 = 
ty≥
;

220 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

222 
	`smp_wmb
();

223 
	`©omic_£t
(&
d©a
.
g©e
,0);

226 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_h™dÀr
, &
d©a
, 0) != 0)

227 
	`∑nic
("mtrr:Åimed out waiting for other CPUs\n");

229 
	`loˇl_úq_ßve
(
Êags
);

231 
	`©omic_ªad
(&
d©a
.
cou¡
))

232 
	`˝u_ªœx
();

235 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

236 
	`smp_wmb
();

237 
	`©omic_£t
(&
d©a
.
g©e
,1);

247 i‡(
ªg
 != ~0U)

248 
mår_if
->
	`£t
(
ªg
,
ba£
,
size
,
ty≥
);

251 
	`©omic_ªad
(&
d©a
.
cou¡
))

252 
	`˝u_ªœx
();

254 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

255 
	`smp_wmb
();

256 
	`©omic_£t
(&
d©a
.
g©e
,0);

262 
	`©omic_ªad
(&
d©a
.
cou¡
))

263 
	`˝u_ªœx
();

265 
	`loˇl_úq_ª°‹e
(
Êags
);

266 
	}
}

304 
	$mår_add_∑ge
(
ba£
, 
size
,

305 
ty≥
, 
boﬁ
 
ö¸emít
)

307 
i
, 
ª∂a˚
, 
îr‹
;

308 
mår_ty≥
 
…y≥
;

309 
lba£
, 
lsize
;

311 i‡(!
mår_if
)

312  -
ENXIO
;

314 i‡((
îr‹
 = 
mår_if
->
	`vÆid©e_add_∑ge
(
ba£
,
size
,
ty≥
)))

315  
îr‹
;

317 i‡(
ty≥
 >
MTRR_NUM_TYPES
) {

318 
	`¥ötk
(
KERN_WARNING
 "mår:Åy≥: %u invÆid\n", 
ty≥
);

319  -
EINVAL
;

323 i‡((
ty≥
 =
MTRR_TYPE_WRCOMB
Ë&& !
	`have_wrcomb
()) {

324 
	`¥ötk
(
KERN_WARNING


326  -
ENOSYS
;

329 i‡(!
size
) {

330 
	`¥ötk
(
KERN_WARNING
 "mtrr: zero sizedÑequest\n");

331  -
EINVAL
;

334 i‡(
ba£
 & 
size_‹_mask
 || 
size
 & size_or_mask) {

335 
	`¥ötk
(
KERN_WARNING
 "mtrr: base or sizeÉxceedsÅhe MTRR width\n");

336  -
EINVAL
;

339 
îr‹
 = -
EINVAL
;

340 
ª∂a˚
 = -1;

343 
	`gë_⁄löe_˝us
();

345 
	`muãx_lock
(&
mår_muãx
);

346 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

347 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

348 i‡(!
lsize
 || 
ba£
 > 
lba£
 +Üsizê- 1 || ba£ + 
size
 - 1 <Übase)

351 i‡(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >Üba£ + 
lsize
 - 1) {

352 i‡(
ba£
 <
lba£
 && ba£ + 
size
 - 1 >lba£ + 
lsize
 - 1) {

354 i‡(
ty≥
 =
…y≥
) {

355 
ª∂a˚
 =Ñïœ˚ =-1 ? 
i
 : -2;

358 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

361 
	`¥ötk
(
KERN_WARNING


363 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

364 
lsize
);

365 
out
;

368 i‡(
…y≥
 !
ty≥
) {

369 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

371 
	`¥ötk
 (
KERN_WARNING
 "mtrr:Åype mismatch for %lx000,%lx000 old: %sÇew: %s\n",

372 
ba£
, 
size
, 
	`mår_©åib_to_°r
(
…y≥
),

373 
	`mår_©åib_to_°r
(
ty≥
));

374 
out
;

376 i‡(
ö¸emít
)

377 ++
mår_ußge_èbÀ
[
i
];

378 
îr‹
 = 
i
;

379 
out
;

382 
i
 = 
mår_if
->
	`gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚
);

383 i‡(
i
 >= 0) {

384 
	`£t_mår
(
i
, 
ba£
, 
size
, 
ty≥
);

385 i‡(
	`likñy
(
ª∂a˚
 < 0)) {

386 
mår_ußge_èbÀ
[
i
] = 1;

388 
mår_ußge_èbÀ
[
i
] = mår_ußge_èbÀ[
ª∂a˚
];

389 i‡(
ö¸emít
)

390 
mår_ußge_èbÀ
[
i
]++;

391 i‡(
	`u∆ikñy
(
ª∂a˚
 !
i
)) {

392 
	`£t_mår
(
ª∂a˚
, 0, 0, 0);

393 
mår_ußge_èbÀ
[
ª∂a˚
] = 0;

397 
	`¥ötk
(
KERN_INFO
 "mtrr:Ço more MTRRsávailable\n");

398 
îr‹
 = 
i
;

399 
out
:

400 
	`muãx_u∆ock
(&
mår_muãx
);

401 
	`put_⁄löe_˝us
();

402  
îr‹
;

403 
	}
}

405 
	$mår_check
(
ba£
, 
size
)

407 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1))) {

408 
	`¥ötk
(
KERN_WARNING


410 
	`¥ötk
(
KERN_DEBUG


411 "mår: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

412 
	`dump_°ack
();

416 
	}
}

455 
	$mår_add
(
ba£
, 
size
, 
ty≥
,

456 
boﬁ
 
ö¸emít
)

458 i‡(
	`mår_check
(
ba£
, 
size
))

459  -
EINVAL
;

460  
	`mår_add_∑ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty≥
,

461 
ö¸emít
);

462 
	}
}

479 
	$mår_dñ_∑ge
(
ªg
, 
ba£
, 
size
)

481 
i
, 
max
;

482 
mår_ty≥
 
…y≥
;

483 
lba£
, 
lsize
;

484 
îr‹
 = -
EINVAL
;

486 i‡(!
mår_if
)

487  -
ENXIO
;

489 
max
 = 
num_v¨_ønges
;

491 
	`gë_⁄löe_˝us
();

492 
	`muãx_lock
(&
mår_muãx
);

493 i‡(
ªg
 < 0) {

495 
i
 = 0; i < 
max
; ++i) {

496 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

497 i‡(
lba£
 =
ba£
 && 
lsize
 =
size
) {

498 
ªg
 = 
i
;

502 i‡(
ªg
 < 0) {

503 
	`¥ötk
(
KERN_DEBUG
 "mår:ÇÿMTRR f‹ %lx000,%lx000 found\n", 
ba£
,

504 
size
);

505 
out
;

508 i‡(
ªg
 >
max
) {

509 
	`¥ötk
(
KERN_WARNING
 "mår:Ñegi°î: %dÅoÿbig\n", 
ªg
);

510 
out
;

512 
mår_if
->
	`gë
(
ªg
, &
lba£
, &
lsize
, &
…y≥
);

513 i‡(
lsize
 < 1) {

514 
	`¥ötk
(
KERN_WARNING
 "mår: MTRR %dÇŸ u£d\n", 
ªg
);

515 
out
;

517 i‡(
mår_ußge_èbÀ
[
ªg
] < 1) {

518 
	`¥ötk
(
KERN_WARNING
 "mår:Ñeg: %d ha†cou¡=0\n", 
ªg
);

519 
out
;

521 i‡(--
mår_ußge_èbÀ
[
ªg
] < 1)

522 
	`£t_mår
(
ªg
, 0, 0, 0);

523 
îr‹
 = 
ªg
;

524 
out
:

525 
	`muãx_u∆ock
(&
mår_muãx
);

526 
	`put_⁄löe_˝us
();

527  
îr‹
;

528 
	}
}

545 
	$mår_dñ
(
ªg
, 
ba£
, 
size
)

547 i‡(
	`mår_check
(
ba£
, 
size
))

548  -
EINVAL
;

549  
	`mår_dñ_∑ge
(
ªg
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

550 
	}
}

552 
EXPORT_SYMBOL
(
mår_add
);

553 
EXPORT_SYMBOL
(
mår_dñ
);

559 
__öô
 
	$öô_ifs
()

561 #i‚de‡
CONFIG_X86_64


562 
	`amd_öô_mår
();

563 
	`cyrix_öô_mår
();

564 
	`˚¡aur_öô_mår
();

566 
	}
}

571 
	smår_vÆue
 {

572 
mår_ty≥
 
	m…y≥
;

573 
	mlba£
;

574 
	mlsize
;

577 
mår_vÆue
 
	gmår_vÆue
[
MTRR_MAX_VAR_RANGES
];

579 
	$mår_ßve
(
sys_devi˚
 * 
sysdev
, 
pm_mesßge_t
 
°©e
)

581 
i
;

583 
i
 = 0; i < 
num_v¨_ønges
; i++) {

584 
mår_if
->
	`gë
(
i
,

585 &
mår_vÆue
[
i
].
lba£
,

586 &
mår_vÆue
[
i
].
lsize
,

587 &
mår_vÆue
[
i
].
…y≥
);

590 
	}
}

592 
	$mår_ª°‹e
(
sys_devi˚
 * 
sysdev
)

594 
i
;

596 
i
 = 0; i < 
num_v¨_ønges
; i++) {

597 i‡(
mår_vÆue
[
i
].
lsize
)

598 
	`£t_mår
(
i
,

599 
mår_vÆue
[
i
].
lba£
,

600 
mår_vÆue
[
i
].
lsize
,

601 
mår_vÆue
[
i
].
…y≥
);

604 
	}
}

608 
sysdev_drivî
 
	gmår_sysdev_drivî
 = {

609 .
su•íd
 = 
mår_ßve
,

610 .
	gªsume
 = 
mår_ª°‹e
,

613 
__öôd©a
 
	gch™ged_by_mår_˛ónup
;

622 
__öô
 
	$mår_bp_öô
()

624 
u32
 
phys_addr
;

625 
	`öô_ifs
();

627 
phys_addr
 = 32;

629 i‡(
˝u_has_mår
) {

630 
mår_if
 = &
gíîic_mår_›s
;

631 
size_‹_mask
 = 0xff000000;

632 
size_™d_mask
 = 0x00f00000;

633 
phys_addr
 = 36;

638 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000008) {

639 
phys_addr
 = 
	`˝uid_óx
(0x80000008) & 0xff;

641 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

642 
boŸ_˝u_d©a
.
x86
 == 0xF &&

643 
boŸ_˝u_d©a
.
x86_modñ
 == 0x3 &&

644 (
boŸ_˝u_d©a
.
x86_mask
 == 0x3 ||

645 
boŸ_˝u_d©a
.
x86_mask
 == 0x4))

646 
phys_addr
 = 36;

648 
size_‹_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

649 
size_™d_mask
 = ~
size_‹_mask
 & 0xfffff00000ULL;

650 } i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_CENTAUR
 &&

651 
boŸ_˝u_d©a
.
x86
 == 6) {

654 
size_‹_mask
 = 0xfff00000;

655 
size_™d_mask
 = 0;

656 
phys_addr
 = 32;

659 
boŸ_˝u_d©a
.
x86_víd‹
) {

660 
X86_VENDOR_AMD
:

661 i‡(
˝u_has_k6_mår
) {

663 
mår_if
 = 
mår_›s
[
X86_VENDOR_AMD
];

664 
size_‹_mask
 = 0xfff00000;

665 
size_™d_mask
 = 0;

668 
X86_VENDOR_CENTAUR
:

669 i‡(
˝u_has_˚¡aur_m¸
) {

670 
mår_if
 = 
mår_›s
[
X86_VENDOR_CENTAUR
];

671 
size_‹_mask
 = 0xfff00000;

672 
size_™d_mask
 = 0;

675 
X86_VENDOR_CYRIX
:

676 i‡(
˝u_has_cyrix_¨r
) {

677 
mår_if
 = 
mår_›s
[
X86_VENDOR_CYRIX
];

678 
size_‹_mask
 = 0xfff00000;

679 
size_™d_mask
 = 0;

687 i‡(
mår_if
) {

688 
	`£t_num_v¨_ønges
();

689 
	`öô_èbÀ
();

690 i‡(
	`u£_öãl
()) {

691 
	`gë_mår_°©e
();

693 i‡(
	`mår_˛ónup
(
phys_addr
)) {

694 
ch™ged_by_mår_˛ónup
 = 1;

695 
mår_if
->
	`£t_Æl
();

700 
	}
}

702 
	$mår_≠_öô
()

704 
Êags
;

706 i‡(!
mår_if
 || !
	`u£_öãl
())

716 
	`loˇl_úq_ßve
(
Êags
);

718 
mår_if
->
	`£t_Æl
();

720 
	`loˇl_úq_ª°‹e
(
Êags
);

721 
	}
}

726 
	$mår_ßve_°©e
()

728 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(0, 
mår_ßve_fixed_ønges
, 
NULL
, 1);

729 
	}
}

731 
__öô
 
	$mår_öô_föülize
()

733 i‡(!
mår_if
)

735 i‡(
	`u£_öãl
()) {

736 i‡(!
ch™ged_by_mår_˛ónup
)

737 
	`mår_°©e_w¨n
();

745 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
,

746 &
mår_sysdev_drivî
);

749 
	}
}

750 
subsys_öôˇŒ
(
mår_öô_föülize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c

1 
	~<löux/mm.h
>

2 
	~<löux/öô.h
>

3 
	~<asm/io.h
>

4 
	~<asm/mår.h
>

5 
	~<asm/m§.h
>

6 
	~<asm/¥o˚ss‹-cyrix.h
>

7 
	~<asm/¥o˚ss‹-Êags.h
>

8 
	~"mår.h
"

12 
	$£t_mår_¥ï¨e_ßve
(
£t_mår_c⁄ãxt
 *
˘xt
)

14 
¸0
;

17 
	`loˇl_úq_ßve
(
˘xt
->
Êags
);

19 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

22 i‡(
˝u_has_pge
) {

23 
˘xt
->
¸4vÆ
 = 
	`ªad_¸4
();

24 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
 & ~
X86_CR4_PGE
);

31 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

32 
	`wbövd
();

33 
	`wrôe_¸0
(
¸0
);

34 
	`wbövd
();

36 i‡(
	`u£_öãl
())

38 
	`rdm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
, ctxt->
de·y≥_hi
);

41 
˘xt
->
c¸3
 = 
	`gëCx86
(
CX86_CCR3
);

43 
	}
}

45 
	$£t_mår_ˇche_dißbÀ
(
£t_mår_c⁄ãxt
 *
˘xt
)

47 i‡(
	`u£_öãl
())

49 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
 & 0xf300UL,

50 
˘xt
->
de·y≥_hi
);

51 i‡(
	`is_˝u
(
CYRIX
))

53 
	`£tCx86
(
CX86_CCR3
, (
˘xt
->
c¸3
 & 0x0f) | 0x10);

54 
	}
}

57 
	$£t_mår_d⁄e
(
£t_mår_c⁄ãxt
 *
˘xt
)

59 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

62 
	`wbövd
();

65 i‡(
	`u£_öãl
())

67 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
, ctxt->
de·y≥_hi
);

70 
	`£tCx86
(
CX86_CCR3
, 
˘xt
->
c¸3
);

73 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

76 i‡(
˝u_has_pge
)

77 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
);

80 
	`loˇl_úq_ª°‹e
(
˘xt
->
Êags
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perf_counter.c

13 
	~<löux/≥rf_cou¡î.h
>

14 
	~<löux/ˇ∑bûôy.h
>

15 
	~<löux/nŸifõr.h
>

16 
	~<löux/h¨dúq.h
>

17 
	~<löux/k¥obes.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/highmem.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/°ackåa˚.h
>

26 
	~<asm/nmi.h
>

28 
u64
 
≥rf_cou¡î_mask
 
	g__ªad_mo°ly
;

30 
	s˝u_hw_cou¡îs
 {

31 
≥rf_cou¡î
 *
	mcou¡îs
[
X86_PMC_IDX_MAX
];

32 
	mu£d_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

33 
	ma˘ive_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

34 
	möãºu±s
;

35 
	míabÀd
;

41 
	sx86_pmu
 {

42 c⁄° *
	m«me
;

43 
	mvîsi⁄
;

44 (*
	mh™dÀ_úq
)(
	m±_ªgs
 *);

45 (*
	mdißbÀ_Æl
)();

46 (*
	míabÀ_Æl
)();

47 (*
	míabÀ
)(
	mhw_≥rf_cou¡î
 *, );

48 (*
	mdißbÀ
)(
	mhw_≥rf_cou¡î
 *, );

49 
	mevít£l
;

50 
	m≥rf˘r
;

51 
u64
 (*
evít_m≠
)();

52 
u64
 (*
øw_evít
)(
	mu64
);

53 
	mmax_evíts
;

54 
	mnum_cou¡îs
;

55 
	mnum_cou¡îs_fixed
;

56 
	mcou¡î_bôs
;

57 
u64
 
	mcou¡î_mask
;

58 
	m≠ic
;

59 
u64
 
	mmax_≥riod
;

60 
u64
 
	möãl_˘æ
;

63 
x86_pmu
 x86_pmu 
	g__ªad_mo°ly
;

65 
DEFINE_PER_CPU
(
˝u_hw_cou¡îs
, cpu_hw_counters) = {

66 .
íabÀd
 = 1,

72 c⁄° 
u64
 
	gp6_≥rfm⁄_evít_m≠
[] =

74 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0079,

75 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

76 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0f2e,

77 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x012e,

78 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

79 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

80 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x0062,

83 
u64
 
	$p6_pmu_evít_m≠
(
evít
)

85  
p6_≥rfm⁄_evít_m≠
[
evít
];

86 
	}
}

94 
	#P6_NOP_COUNTER
 0x0000002EULL

	)

96 
u64
 
	$p6_pmu_øw_evít
(
u64
 
evít
)

98 
	#P6_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

99 
	#P6_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

100 
	#P6_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

101 
	#P6_EVNTSEL_INV_MASK
 0x00800000ULL

	)

102 
	#P6_EVNTSEL_COUNTER_MASK
 0xFF000000ULL

	)

104 
	#P6_EVNTSEL_MASK
 \

105 (
P6_EVNTSEL_EVENT_MASK
 | \

106 
P6_EVNTSEL_UNIT_MASK
 | \

107 
P6_EVNTSEL_EDGE_MASK
 | \

108 
P6_EVNTSEL_INV_MASK
 | \

109 
P6_EVNTSEL_COUNTER_MASK
)

	)

111  
evít
 & 
P6_EVNTSEL_MASK
;

112 
	}
}

118 c⁄° 
u64
 
	göãl_≥rfm⁄_evít_m≠
[] =

120 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x003c,

121 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

122 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x4f2e,

123 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x412e,

124 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

125 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

126 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x013c,

129 
u64
 
	$öãl_pmu_evít_m≠
(
evít
)

131  
öãl_≥rfm⁄_evít_m≠
[
evít
];

132 
	}
}

142 
	#C
(
x
Ë
PERF_COUNT_HW_CACHE_
##
	)
x

144 
u64
 
__ªad_mo°ly
 
	ghw_ˇche_evít_ids


145 [
PERF_COUNT_HW_CACHE_MAX
]

146 [
PERF_COUNT_HW_CACHE_OP_MAX
]

147 [
PERF_COUNT_HW_CACHE_RESULT_MAX
];

149 c⁄° 
u64
 
	g√hÆem_hw_ˇche_evít_ids


150 [
PERF_COUNT_HW_CACHE_MAX
]

151 [
PERF_COUNT_HW_CACHE_OP_MAX
]

152 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

154 [ 
C
(
L1D
) ] = {

155 [ 
C
(
OP_READ
) ] = {

156 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

157 [ 
C
(
RESULT_MISS
) ] = 0x0140,

159 [ 
C
(
OP_WRITE
) ] = {

160 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

161 [ 
C
(
RESULT_MISS
) ] = 0x0141,

163 [ 
C
(
OP_PREFETCH
) ] = {

164 [ 
C
(
RESULT_ACCESS
) ] = 0x014e,

165 [ 
C
(
RESULT_MISS
) ] = 0x024e,

168 [ 
C
(
L1I
 ) ] = {

169 [ 
C
(
OP_READ
) ] = {

170 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

171 [ 
C
(
RESULT_MISS
) ] = 0x0280,

173 [ 
C
(
OP_WRITE
) ] = {

174 [ 
C
(
RESULT_ACCESS
) ] = -1,

175 [ 
C
(
RESULT_MISS
) ] = -1,

177 [ 
C
(
OP_PREFETCH
) ] = {

178 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

179 [ 
C
(
RESULT_MISS
) ] = 0x0,

182 [ 
C
(
LL
 ) ] = {

183 [ 
C
(
OP_READ
) ] = {

184 [ 
C
(
RESULT_ACCESS
) ] = 0x0324,

185 [ 
C
(
RESULT_MISS
) ] = 0x0224,

187 [ 
C
(
OP_WRITE
) ] = {

188 [ 
C
(
RESULT_ACCESS
) ] = 0x0c24,

189 [ 
C
(
RESULT_MISS
) ] = 0x0824,

191 [ 
C
(
OP_PREFETCH
) ] = {

192 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2e,

193 [ 
C
(
RESULT_MISS
) ] = 0x412e,

196 [ 
C
(
DTLB
) ] = {

197 [ 
C
(
OP_READ
) ] = {

198 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

199 [ 
C
(
RESULT_MISS
) ] = 0x0108,

201 [ 
C
(
OP_WRITE
) ] = {

202 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

203 [ 
C
(
RESULT_MISS
) ] = 0x010c,

205 [ 
C
(
OP_PREFETCH
) ] = {

206 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

207 [ 
C
(
RESULT_MISS
) ] = 0x0,

210 [ 
C
(
ITLB
) ] = {

211 [ 
C
(
OP_READ
) ] = {

212 [ 
C
(
RESULT_ACCESS
) ] = 0x01c0,

213 [ 
C
(
RESULT_MISS
) ] = 0x20c8,

215 [ 
C
(
OP_WRITE
) ] = {

216 [ 
C
(
RESULT_ACCESS
) ] = -1,

217 [ 
C
(
RESULT_MISS
) ] = -1,

219 [ 
C
(
OP_PREFETCH
) ] = {

220 [ 
C
(
RESULT_ACCESS
) ] = -1,

221 [ 
C
(
RESULT_MISS
) ] = -1,

224 [ 
C
(
BPU
 ) ] = {

225 [ 
C
(
OP_READ
) ] = {

226 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

227 [ 
C
(
RESULT_MISS
) ] = 0x03e8,

229 [ 
C
(
OP_WRITE
) ] = {

230 [ 
C
(
RESULT_ACCESS
) ] = -1,

231 [ 
C
(
RESULT_MISS
) ] = -1,

233 [ 
C
(
OP_PREFETCH
) ] = {

234 [ 
C
(
RESULT_ACCESS
) ] = -1,

235 [ 
C
(
RESULT_MISS
) ] = -1,

240 c⁄° 
u64
 
	gc‹e2_hw_ˇche_evít_ids


241 [
PERF_COUNT_HW_CACHE_MAX
]

242 [
PERF_COUNT_HW_CACHE_OP_MAX
]

243 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

245 [ 
C
(
L1D
) ] = {

246 [ 
C
(
OP_READ
) ] = {

247 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

248 [ 
C
(
RESULT_MISS
) ] = 0x0140,

250 [ 
C
(
OP_WRITE
) ] = {

251 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

252 [ 
C
(
RESULT_MISS
) ] = 0x0141,

254 [ 
C
(
OP_PREFETCH
) ] = {

255 [ 
C
(
RESULT_ACCESS
) ] = 0x104e,

256 [ 
C
(
RESULT_MISS
) ] = 0,

259 [ 
C
(
L1I
 ) ] = {

260 [ 
C
(
OP_READ
) ] = {

261 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

262 [ 
C
(
RESULT_MISS
) ] = 0x0081,

264 [ 
C
(
OP_WRITE
) ] = {

265 [ 
C
(
RESULT_ACCESS
) ] = -1,

266 [ 
C
(
RESULT_MISS
) ] = -1,

268 [ 
C
(
OP_PREFETCH
) ] = {

269 [ 
C
(
RESULT_ACCESS
) ] = 0,

270 [ 
C
(
RESULT_MISS
) ] = 0,

273 [ 
C
(
LL
 ) ] = {

274 [ 
C
(
OP_READ
) ] = {

275 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

276 [ 
C
(
RESULT_MISS
) ] = 0x4129,

278 [ 
C
(
OP_WRITE
) ] = {

279 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

280 [ 
C
(
RESULT_MISS
) ] = 0x412A,

282 [ 
C
(
OP_PREFETCH
) ] = {

283 [ 
C
(
RESULT_ACCESS
) ] = 0,

284 [ 
C
(
RESULT_MISS
) ] = 0,

287 [ 
C
(
DTLB
) ] = {

288 [ 
C
(
OP_READ
) ] = {

289 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

290 [ 
C
(
RESULT_MISS
) ] = 0x0208,

292 [ 
C
(
OP_WRITE
) ] = {

293 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

294 [ 
C
(
RESULT_MISS
) ] = 0x0808,

296 [ 
C
(
OP_PREFETCH
) ] = {

297 [ 
C
(
RESULT_ACCESS
) ] = 0,

298 [ 
C
(
RESULT_MISS
) ] = 0,

301 [ 
C
(
ITLB
) ] = {

302 [ 
C
(
OP_READ
) ] = {

303 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

304 [ 
C
(
RESULT_MISS
) ] = 0x1282,

306 [ 
C
(
OP_WRITE
) ] = {

307 [ 
C
(
RESULT_ACCESS
) ] = -1,

308 [ 
C
(
RESULT_MISS
) ] = -1,

310 [ 
C
(
OP_PREFETCH
) ] = {

311 [ 
C
(
RESULT_ACCESS
) ] = -1,

312 [ 
C
(
RESULT_MISS
) ] = -1,

315 [ 
C
(
BPU
 ) ] = {

316 [ 
C
(
OP_READ
) ] = {

317 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

318 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

320 [ 
C
(
OP_WRITE
) ] = {

321 [ 
C
(
RESULT_ACCESS
) ] = -1,

322 [ 
C
(
RESULT_MISS
) ] = -1,

324 [ 
C
(
OP_PREFETCH
) ] = {

325 [ 
C
(
RESULT_ACCESS
) ] = -1,

326 [ 
C
(
RESULT_MISS
) ] = -1,

331 c⁄° 
u64
 
	g©om_hw_ˇche_evít_ids


332 [
PERF_COUNT_HW_CACHE_MAX
]

333 [
PERF_COUNT_HW_CACHE_OP_MAX
]

334 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

336 [ 
C
(
L1D
) ] = {

337 [ 
C
(
OP_READ
) ] = {

338 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

339 [ 
C
(
RESULT_MISS
) ] = 0,

341 [ 
C
(
OP_WRITE
) ] = {

342 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

343 [ 
C
(
RESULT_MISS
) ] = 0,

345 [ 
C
(
OP_PREFETCH
) ] = {

346 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

347 [ 
C
(
RESULT_MISS
) ] = 0,

350 [ 
C
(
L1I
 ) ] = {

351 [ 
C
(
OP_READ
) ] = {

352 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

353 [ 
C
(
RESULT_MISS
) ] = 0x0280,

355 [ 
C
(
OP_WRITE
) ] = {

356 [ 
C
(
RESULT_ACCESS
) ] = -1,

357 [ 
C
(
RESULT_MISS
) ] = -1,

359 [ 
C
(
OP_PREFETCH
) ] = {

360 [ 
C
(
RESULT_ACCESS
) ] = 0,

361 [ 
C
(
RESULT_MISS
) ] = 0,

364 [ 
C
(
LL
 ) ] = {

365 [ 
C
(
OP_READ
) ] = {

366 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

367 [ 
C
(
RESULT_MISS
) ] = 0x4129,

369 [ 
C
(
OP_WRITE
) ] = {

370 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

371 [ 
C
(
RESULT_MISS
) ] = 0x412A,

373 [ 
C
(
OP_PREFETCH
) ] = {

374 [ 
C
(
RESULT_ACCESS
) ] = 0,

375 [ 
C
(
RESULT_MISS
) ] = 0,

378 [ 
C
(
DTLB
) ] = {

379 [ 
C
(
OP_READ
) ] = {

380 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

381 [ 
C
(
RESULT_MISS
) ] = 0x0508,

383 [ 
C
(
OP_WRITE
) ] = {

384 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

385 [ 
C
(
RESULT_MISS
) ] = 0x0608,

387 [ 
C
(
OP_PREFETCH
) ] = {

388 [ 
C
(
RESULT_ACCESS
) ] = 0,

389 [ 
C
(
RESULT_MISS
) ] = 0,

392 [ 
C
(
ITLB
) ] = {

393 [ 
C
(
OP_READ
) ] = {

394 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

395 [ 
C
(
RESULT_MISS
) ] = 0x0282,

397 [ 
C
(
OP_WRITE
) ] = {

398 [ 
C
(
RESULT_ACCESS
) ] = -1,

399 [ 
C
(
RESULT_MISS
) ] = -1,

401 [ 
C
(
OP_PREFETCH
) ] = {

402 [ 
C
(
RESULT_ACCESS
) ] = -1,

403 [ 
C
(
RESULT_MISS
) ] = -1,

406 [ 
C
(
BPU
 ) ] = {

407 [ 
C
(
OP_READ
) ] = {

408 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

409 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

411 [ 
C
(
OP_WRITE
) ] = {

412 [ 
C
(
RESULT_ACCESS
) ] = -1,

413 [ 
C
(
RESULT_MISS
) ] = -1,

415 [ 
C
(
OP_PREFETCH
) ] = {

416 [ 
C
(
RESULT_ACCESS
) ] = -1,

417 [ 
C
(
RESULT_MISS
) ] = -1,

422 
u64
 
	$öãl_pmu_øw_evít
(
u64
 
evít
)

424 
	#CORE_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

425 
	#CORE_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

426 
	#CORE_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

427 
	#CORE_EVNTSEL_INV_MASK
 0x00800000ULL

	)

428 
	#CORE_EVNTSEL_COUNTER_MASK
 0xFF000000ULL

	)

430 
	#CORE_EVNTSEL_MASK
 \

431 (
CORE_EVNTSEL_EVENT_MASK
 | \

432 
CORE_EVNTSEL_UNIT_MASK
 | \

433 
CORE_EVNTSEL_EDGE_MASK
 | \

434 
CORE_EVNTSEL_INV_MASK
 | \

435 
CORE_EVNTSEL_COUNTER_MASK
)

	)

437  
evít
 & 
CORE_EVNTSEL_MASK
;

438 
	}
}

440 c⁄° 
u64
 
	gamd_hw_ˇche_evít_ids


441 [
PERF_COUNT_HW_CACHE_MAX
]

442 [
PERF_COUNT_HW_CACHE_OP_MAX
]

443 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

445 [ 
C
(
L1D
) ] = {

446 [ 
C
(
OP_READ
) ] = {

447 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

448 [ 
C
(
RESULT_MISS
) ] = 0x0041,

450 [ 
C
(
OP_WRITE
) ] = {

451 [ 
C
(
RESULT_ACCESS
) ] = 0x0142,

452 [ 
C
(
RESULT_MISS
) ] = 0,

454 [ 
C
(
OP_PREFETCH
) ] = {

455 [ 
C
(
RESULT_ACCESS
) ] = 0x0267,

456 [ 
C
(
RESULT_MISS
) ] = 0x0167,

459 [ 
C
(
L1I
 ) ] = {

460 [ 
C
(
OP_READ
) ] = {

461 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

462 [ 
C
(
RESULT_MISS
) ] = 0x0081,

464 [ 
C
(
OP_WRITE
) ] = {

465 [ 
C
(
RESULT_ACCESS
) ] = -1,

466 [ 
C
(
RESULT_MISS
) ] = -1,

468 [ 
C
(
OP_PREFETCH
) ] = {

469 [ 
C
(
RESULT_ACCESS
) ] = 0x014B,

470 [ 
C
(
RESULT_MISS
) ] = 0,

473 [ 
C
(
LL
 ) ] = {

474 [ 
C
(
OP_READ
) ] = {

475 [ 
C
(
RESULT_ACCESS
) ] = 0x037D,

476 [ 
C
(
RESULT_MISS
) ] = 0x037E,

478 [ 
C
(
OP_WRITE
) ] = {

479 [ 
C
(
RESULT_ACCESS
) ] = 0x017F,

480 [ 
C
(
RESULT_MISS
) ] = 0,

482 [ 
C
(
OP_PREFETCH
) ] = {

483 [ 
C
(
RESULT_ACCESS
) ] = 0,

484 [ 
C
(
RESULT_MISS
) ] = 0,

487 [ 
C
(
DTLB
) ] = {

488 [ 
C
(
OP_READ
) ] = {

489 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

490 [ 
C
(
RESULT_MISS
) ] = 0x0046,

492 [ 
C
(
OP_WRITE
) ] = {

493 [ 
C
(
RESULT_ACCESS
) ] = 0,

494 [ 
C
(
RESULT_MISS
) ] = 0,

496 [ 
C
(
OP_PREFETCH
) ] = {

497 [ 
C
(
RESULT_ACCESS
) ] = 0,

498 [ 
C
(
RESULT_MISS
) ] = 0,

501 [ 
C
(
ITLB
) ] = {

502 [ 
C
(
OP_READ
) ] = {

503 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

504 [ 
C
(
RESULT_MISS
) ] = 0x0085,

506 [ 
C
(
OP_WRITE
) ] = {

507 [ 
C
(
RESULT_ACCESS
) ] = -1,

508 [ 
C
(
RESULT_MISS
) ] = -1,

510 [ 
C
(
OP_PREFETCH
) ] = {

511 [ 
C
(
RESULT_ACCESS
) ] = -1,

512 [ 
C
(
RESULT_MISS
) ] = -1,

515 [ 
C
(
BPU
 ) ] = {

516 [ 
C
(
OP_READ
) ] = {

517 [ 
C
(
RESULT_ACCESS
) ] = 0x00c2,

518 [ 
C
(
RESULT_MISS
) ] = 0x00c3,

520 [ 
C
(
OP_WRITE
) ] = {

521 [ 
C
(
RESULT_ACCESS
) ] = -1,

522 [ 
C
(
RESULT_MISS
) ] = -1,

524 [ 
C
(
OP_PREFETCH
) ] = {

525 [ 
C
(
RESULT_ACCESS
) ] = -1,

526 [ 
C
(
RESULT_MISS
) ] = -1,

534 c⁄° 
u64
 
	gamd_≥rfm⁄_evít_m≠
[] =

536 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0076,

537 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

538 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0080,

539 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x0081,

540 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

541 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

544 
u64
 
	$amd_pmu_evít_m≠
(
evít
)

546  
amd_≥rfm⁄_evít_m≠
[
evít
];

547 
	}
}

549 
u64
 
	$amd_pmu_øw_evít
(
u64
 
evít
)

551 
	#K7_EVNTSEL_EVENT_MASK
 0x7000000FFULL

	)

552 
	#K7_EVNTSEL_UNIT_MASK
 0x00000FF00ULL

	)

553 
	#K7_EVNTSEL_EDGE_MASK
 0x000040000ULL

	)

554 
	#K7_EVNTSEL_INV_MASK
 0x000800000ULL

	)

555 
	#K7_EVNTSEL_COUNTER_MASK
 0x0FF000000ULL

	)

557 
	#K7_EVNTSEL_MASK
 \

558 (
K7_EVNTSEL_EVENT_MASK
 | \

559 
K7_EVNTSEL_UNIT_MASK
 | \

560 
K7_EVNTSEL_EDGE_MASK
 | \

561 
K7_EVNTSEL_INV_MASK
 | \

562 
K7_EVNTSEL_COUNTER_MASK
)

	)

564  
evít
 & 
K7_EVNTSEL_MASK
;

565 
	}
}

572 
u64


573 
	$x86_≥rf_cou¡î_upd©e
(
≥rf_cou¡î
 *
cou¡î
,

574 
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

576 
shi·
 = 64 - 
x86_pmu
.
cou¡î_bôs
;

577 
u64
 
¥ev_øw_cou¡
, 
√w_øw_cou¡
;

578 
s64
 
dñè
;

587 
agaö
:

588 
¥ev_øw_cou¡
 = 
	`©omic64_ªad
(&
hwc
->
¥ev_cou¡
);

589 
	`rdm§l
(
hwc
->
cou¡î_ba£
 + 
idx
, 
√w_øw_cou¡
);

591 i‡(
	`©omic64_cmpxchg
(&
hwc
->
¥ev_cou¡
, 
¥ev_øw_cou¡
,

592 
√w_øw_cou¡
Ë!
¥ev_øw_cou¡
)

593 
agaö
;

603 
dñè
 = (
√w_øw_cou¡
 << 
shi·
Ë- (
¥ev_øw_cou¡
 << shift);

604 
dñè
 >>
shi·
;

606 
	`©omic64_add
(
dñè
, &
cou¡î
->
cou¡
);

607 
	`©omic64_sub
(
dñè
, &
hwc
->
≥riod_À·
);

609  
√w_øw_cou¡
;

610 
	}
}

612 
©omic_t
 
	ga˘ive_cou¡îs
;

613 
DEFINE_MUTEX
(
pmc_ª£rve_muãx
);

615 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
()

617 #ifde‡
CONFIG_X86_LOCAL_APIC


618 
i
;

620 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

621 
	`dißbÀ_œpic_nmi_w©chdog
();

623 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

624 i‡(!
	`ª£rve_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
))

625 
≥rf˘r_Áû
;

628 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

629 i‡(!
	`ª£rve_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
))

630 
evít£l_Áû
;

634  
åue
;

636 #ifde‡
CONFIG_X86_LOCAL_APIC


637 
evít£l_Áû
:

638 
i
--; i >= 0; i--)

639 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

641 
i
 = 
x86_pmu
.
num_cou¡îs
;

643 
≥rf˘r_Áû
:

644 
i
--; i >= 0; i--)

645 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

647 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

648 
	`íabÀ_œpic_nmi_w©chdog
();

650  
Ál£
;

652 
	}
}

654 
	$ªÀa£_pmc_h¨dw¨e
()

656 #ifde‡
CONFIG_X86_LOCAL_APIC


657 
i
;

659 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

660 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

661 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

664 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

665 
	`íabÀ_œpic_nmi_w©chdog
();

667 
	}
}

669 
	$hw_≥rf_cou¡î_de°roy
(
≥rf_cou¡î
 *
cou¡î
)

671 i‡(
	`©omic_dec_™d_muãx_lock
(&
a˘ive_cou¡îs
, &
pmc_ª£rve_muãx
)) {

672 
	`ªÀa£_pmc_h¨dw¨e
();

673 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

675 
	}
}

677 
ölöe
 
	$x86_pmu_öôülized
()

679  
x86_pmu
.
h™dÀ_úq
 !
NULL
;

680 
	}
}

682 
ölöe
 

683 
	$£t_ext_hw_©å
(
hw_≥rf_cou¡î
 *
hwc
, 
≥rf_cou¡î_©å
 *
©å
)

685 
ˇche_ty≥
, 
ˇche_›
, 
ˇche_ªsu…
;

686 
u64
 
c⁄fig
, 
vÆ
;

688 
c⁄fig
 = 
©å
->config;

690 
ˇche_ty≥
 = (
c⁄fig
 >> 0) & 0xff;

691 i‡(
ˇche_ty≥
 >
PERF_COUNT_HW_CACHE_MAX
)

692  -
EINVAL
;

694 
ˇche_›
 = (
c⁄fig
 >> 8) & 0xff;

695 i‡(
ˇche_›
 >
PERF_COUNT_HW_CACHE_OP_MAX
)

696  -
EINVAL
;

698 
ˇche_ªsu…
 = (
c⁄fig
 >> 16) & 0xff;

699 i‡(
ˇche_ªsu…
 >
PERF_COUNT_HW_CACHE_RESULT_MAX
)

700  -
EINVAL
;

702 
vÆ
 = 
hw_ˇche_evít_ids
[
ˇche_ty≥
][
ˇche_›
][
ˇche_ªsu…
];

704 i‡(
vÆ
 == 0)

705  -
ENOENT
;

707 i‡(
vÆ
 == -1)

708  -
EINVAL
;

710 
hwc
->
c⁄fig
 |
vÆ
;

713 
	}
}

718 
	$__hw_≥rf_cou¡î_öô
(
≥rf_cou¡î
 *
cou¡î
)

720 
≥rf_cou¡î_©å
 *
©å
 = &
cou¡î
->attr;

721 
hw_≥rf_cou¡î
 *
hwc
 = &
cou¡î
->
hw
;

722 
u64
 
c⁄fig
;

723 
îr
;

725 i‡(!
	`x86_pmu_öôülized
())

726  -
ENODEV
;

728 
îr
 = 0;

729 i‡(!
	`©omic_öc_nŸ_zîo
(&
a˘ive_cou¡îs
)) {

730 
	`muãx_lock
(&
pmc_ª£rve_muãx
);

731 i‡(
	`©omic_ªad
(&
a˘ive_cou¡îs
Ë=0 && !
	`ª£rve_pmc_h¨dw¨e
())

732 
îr
 = -
EBUSY
;

734 
	`©omic_öc
(&
a˘ive_cou¡îs
);

735 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

737 i‡(
îr
)

738  
îr
;

744 
hwc
->
c⁄fig
 = 
ARCH_PERFMON_EVENTSEL_INT
;

749 i‡(!
©å
->
ex˛ude_u£r
)

750 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_USR
;

751 i‡(!
©å
->
ex˛ude_kî√l
)

752 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_OS
;

754 i‡(!
hwc
->
ßm∂e_≥riod
) {

755 
hwc
->
ßm∂e_≥riod
 = 
x86_pmu
.
max_≥riod
;

756 
hwc
->
œ°_≥riod
 = hwc->
ßm∂e_≥riod
;

757 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, hwc->
ßm∂e_≥riod
);

765 i‡(!
x86_pmu
.
≠ic
)

766  -
EOPNOTSUPP
;

769 
cou¡î
->
de°roy
 = 
hw_≥rf_cou¡î_de°roy
;

774 i‡(
©å
->
ty≥
 =
PERF_TYPE_RAW
) {

775 
hwc
->
c⁄fig
 |
x86_pmu
.
	`øw_evít
(
©å
->config);

779 i‡(
©å
->
ty≥
 =
PERF_TYPE_HW_CACHE
)

780  
	`£t_ext_hw_©å
(
hwc
, 
©å
);

782 i‡(
©å
->
c⁄fig
 >
x86_pmu
.
max_evíts
)

783  -
EINVAL
;

788 
c⁄fig
 = 
x86_pmu
.
	`evít_m≠
(
©å
->config);

790 i‡(
c⁄fig
 == 0)

791  -
ENOENT
;

793 i‡(
c⁄fig
 == -1LL)

794  -
EINVAL
;

796 
hwc
->
c⁄fig
 |= config;

799 
	}
}

801 
	$p6_pmu_dißbÀ_Æl
()

803 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

804 
u64
 
vÆ
;

806 i‡(!
˝uc
->
íabÀd
)

809 
˝uc
->
íabÀd
 = 0;

810 
	`b¨rõr
();

813 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

814 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

815 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

816 
	}
}

818 
	$öãl_pmu_dißbÀ_Æl
()

820 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 0);

821 
	}
}

823 
	$amd_pmu_dißbÀ_Æl
()

825 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

826 
idx
;

828 i‡(!
˝uc
->
íabÀd
)

831 
˝uc
->
íabÀd
 = 0;

837 
	`b¨rõr
();

839 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

840 
u64
 
vÆ
;

842 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

844 
	`rdm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

845 i‡(!(
vÆ
 & 
ARCH_PERFMON_EVENTSEL0_ENABLE
))

847 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

848 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

850 
	}
}

852 
	$hw_≥rf_dißbÀ
()

854 i‡(!
	`x86_pmu_öôülized
())

856  
x86_pmu
.
	`dißbÀ_Æl
();

857 
	}
}

859 
	$p6_pmu_íabÀ_Æl
()

861 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

862 
vÆ
;

864 i‡(
˝uc
->
íabÀd
)

867 
˝uc
->
íabÀd
 = 1;

868 
	`b¨rõr
();

871 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

872 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

873 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

874 
	}
}

876 
	$öãl_pmu_íabÀ_Æl
()

878 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
x86_pmu
.
öãl_˘æ
);

879 
	}
}

881 
	$amd_pmu_íabÀ_Æl
()

883 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

884 
idx
;

886 i‡(
˝uc
->
íabÀd
)

889 
˝uc
->
íabÀd
 = 1;

890 
	`b¨rõr
();

892 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

893 
≥rf_cou¡î
 *
cou¡î
 = 
˝uc
->
cou¡îs
[
idx
];

894 
u64
 
vÆ
;

896 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

899 
vÆ
 = 
cou¡î
->
hw
.
c⁄fig
;

900 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

901 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

903 
	}
}

905 
	$hw_≥rf_íabÀ
()

907 i‡(!
	`x86_pmu_öôülized
())

909 
x86_pmu
.
	`íabÀ_Æl
();

910 
	}
}

912 
ölöe
 
u64
 
	$öãl_pmu_gë_°©us
()

914 
u64
 
°©us
;

916 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

918  
°©us
;

919 
	}
}

921 
ölöe
 
	$öãl_pmu_ack_°©us
(
u64
 
ack
)

923 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ack
);

924 
	}
}

926 
ölöe
 
	$x86_pmu_íabÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

928 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
,

929 
hwc
->
c⁄fig
 | 
ARCH_PERFMON_EVENTSEL0_ENABLE
);

930 
	}
}

932 
ölöe
 
	$x86_pmu_dißbÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

934 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, hwc->
c⁄fig
);

935 
	}
}

937 
ölöe
 

938 
	$öãl_pmu_dißbÀ_fixed
(
hw_≥rf_cou¡î
 *
hwc
, 
__idx
)

940 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

941 
u64
 
˘æ_vÆ
, 
mask
;

943 
mask
 = 0xfULL << (
idx
 * 4);

945 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

946 
˘æ_vÆ
 &~
mask
;

947 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

948 
	}
}

950 
ölöe
 

951 
	$p6_pmu_dißbÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

953 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

954 
u64
 
vÆ
 = 
P6_NOP_COUNTER
;

956 i‡(
˝uc
->
íabÀd
)

957 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

959 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

960 
	}
}

962 
ölöe
 

963 
	$öãl_pmu_dißbÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

965 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

966 
	`öãl_pmu_dißbÀ_fixed
(
hwc
, 
idx
);

970 
	`x86_pmu_dißbÀ_cou¡î
(
hwc
, 
idx
);

971 
	}
}

973 
ölöe
 

974 
	$amd_pmu_dißbÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

976 
	`x86_pmu_dißbÀ_cou¡î
(
hwc
, 
idx
);

977 
	}
}

979 
DEFINE_PER_CPU
(
u64
, 
¥ev_À·
[
X86_PMC_IDX_MAX
]);

986 
	$x86_≥rf_cou¡î_£t_≥riod
(
≥rf_cou¡î
 *
cou¡î
,

987 
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

989 
s64
 
À·
 = 
	`©omic64_ªad
(&
hwc
->
≥riod_À·
);

990 
s64
 
≥riod
 = 
hwc
->
ßm∂e_≥riod
;

991 
îr
, 
ªt
 = 0;

996 i‡(
	`u∆ikñy
(
À·
 <-
≥riod
)) {

997 
À·
 = 
≥riod
;

998 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

999 
hwc
->
œ°_≥riod
 = 
≥riod
;

1000 
ªt
 = 1;

1003 i‡(
	`u∆ikñy
(
À·
 <= 0)) {

1004 
À·
 +
≥riod
;

1005 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

1006 
hwc
->
œ°_≥riod
 = 
≥riod
;

1007 
ªt
 = 1;

1012 i‡(
	`u∆ikñy
(
À·
 < 2))

1013 
À·
 = 2;

1015 i‡(
À·
 > 
x86_pmu
.
max_≥riod
)

1016 
À·
 = 
x86_pmu
.
max_≥riod
;

1018 
	`≥r_˝u
(
¥ev_À·
[
idx
], 
	`smp_¥o˚ss‹_id
()Ë
À·
;

1024 
	`©omic64_£t
(&
hwc
->
¥ev_cou¡
, (
u64
)-
À·
);

1026 
îr
 = 
	`checkög_wrm§l
(
hwc
->
cou¡î_ba£
 + 
idx
,

1027 (
u64
)(-
À·
Ë& 
x86_pmu
.
cou¡î_mask
);

1029 
	`≥rf_cou¡î_upd©e_u£Ωage
(
cou¡î
);

1031  
ªt
;

1032 
	}
}

1034 
ölöe
 

1035 
	$öãl_pmu_íabÀ_fixed
(
hw_≥rf_cou¡î
 *
hwc
, 
__idx
)

1037 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

1038 
u64
 
˘æ_vÆ
, 
bôs
, 
mask
;

1039 
îr
;

1046 
bôs
 = 0x8ULL;

1047 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_USR
)

1048 
bôs
 |= 0x2;

1049 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

1050 
bôs
 |= 0x1;

1051 
bôs
 <<(
idx
 * 4);

1052 
mask
 = 0xfULL << (
idx
 * 4);

1054 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1055 
˘æ_vÆ
 &~
mask
;

1056 
˘æ_vÆ
 |
bôs
;

1057 
îr
 = 
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1058 
	}
}

1060 
	$p6_pmu_íabÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

1062 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

1063 
u64
 
vÆ
;

1065 
vÆ
 = 
hwc
->
c⁄fig
;

1066 i‡(
˝uc
->
íabÀd
)

1067 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1069 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

1070 
	}
}

1073 
	$öãl_pmu_íabÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

1075 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

1076 
	`öãl_pmu_íabÀ_fixed
(
hwc
, 
idx
);

1080 
	`x86_pmu_íabÀ_cou¡î
(
hwc
, 
idx
);

1081 
	}
}

1083 
	$amd_pmu_íabÀ_cou¡î
(
hw_≥rf_cou¡î
 *
hwc
, 
idx
)

1085 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

1087 i‡(
˝uc
->
íabÀd
)

1088 
	`x86_pmu_íabÀ_cou¡î
(
hwc
, 
idx
);

1089 
	}
}

1092 
	$fixed_mode_idx
(
≥rf_cou¡î
 *
cou¡î
, 
hw_≥rf_cou¡î
 *
hwc
)

1094 
evít
;

1096 i‡(!
x86_pmu
.
num_cou¡îs_fixed
)

1099 
evít
 = 
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENT_MASK
;

1101 i‡(
	`u∆ikñy
(
evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_INSTRUCTIONS
)))

1102  
X86_PMC_IDX_FIXED_INSTRUCTIONS
;

1103 i‡(
	`u∆ikñy
(
evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_CPU_CYCLES
)))

1104  
X86_PMC_IDX_FIXED_CPU_CYCLES
;

1105 i‡(
	`u∆ikñy
(
evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_BUS_CYCLES
)))

1106  
X86_PMC_IDX_FIXED_BUS_CYCLES
;

1109 
	}
}

1114 
	$x86_pmu_íabÀ
(
≥rf_cou¡î
 *
cou¡î
)

1116 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

1117 
hw_≥rf_cou¡î
 *
hwc
 = &
cou¡î
->
hw
;

1118 
idx
;

1120 
idx
 = 
	`fixed_mode_idx
(
cou¡î
, 
hwc
);

1121 i‡(
idx
 >= 0) {

1126 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
))

1127 
åy_gíîic
;

1129 
hwc
->
c⁄fig_ba£
 = 
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
;

1134 
hwc
->
cou¡î_ba£
 =

1135 
MSR_ARCH_PERFMON_FIXED_CTR0
 - 
X86_PMC_IDX_FIXED
;

1136 
hwc
->
idx
 = idx;

1138 
idx
 = 
hwc
->idx;

1140 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
)) {

1141 
åy_gíîic
:

1142 
idx
 = 
	`föd_fú°_zîo_bô
(
˝uc
->
u£d_mask
,

1143 
x86_pmu
.
num_cou¡îs
);

1144 i‡(
idx
 =
x86_pmu
.
num_cou¡îs
)

1145  -
EAGAIN
;

1147 
	`£t_bô
(
idx
, 
˝uc
->
u£d_mask
);

1148 
hwc
->
idx
 = idx;

1150 
hwc
->
c⁄fig_ba£
 = 
x86_pmu
.
evít£l
;

1151 
hwc
->
cou¡î_ba£
 = 
x86_pmu
.
≥rf˘r
;

1154 
	`≥rf_cou¡îs_œpic_öô
();

1156 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1158 
˝uc
->
cou¡îs
[
idx
] = 
cou¡î
;

1159 
	`£t_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1161 
	`x86_≥rf_cou¡î_£t_≥riod
(
cou¡î
, 
hwc
, 
idx
);

1162 
x86_pmu
.
	`íabÀ
(
hwc
, 
idx
);

1164 
	`≥rf_cou¡î_upd©e_u£Ωage
(
cou¡î
);

1167 
	}
}

1169 
	$x86_pmu_u¡hrŸée
(
≥rf_cou¡î
 *
cou¡î
)

1171 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

1172 
hw_≥rf_cou¡î
 *
hwc
 = &
cou¡î
->
hw
;

1174 i‡(
	`WARN_ON_ONCE
(
hwc
->
idx
 >
X86_PMC_IDX_MAX
 ||

1175 
˝uc
->
cou¡îs
[
hwc
->
idx
] !
cou¡î
))

1178 
x86_pmu
.
	`íabÀ
(
hwc
, hwc->
idx
);

1179 
	}
}

1181 
	$≥rf_cou¡î_¥öt_debug
()

1183 
u64
 
˘æ
, 
°©us
, 
ovîÊow
, 
pmc_˘æ
, 
pmc_cou¡
, 
¥ev_À·
, 
fixed
;

1184 
˝u_hw_cou¡îs
 *
˝uc
;

1185 
Êags
;

1186 
˝u
, 
idx
;

1188 i‡(!
x86_pmu
.
num_cou¡îs
)

1191 
	`loˇl_úq_ßve
(
Êags
);

1193 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1194 
˝uc
 = &
	`≥r_˝u
(
˝u_hw_cou¡îs
, 
˝u
);

1196 i‡(
x86_pmu
.
vîsi⁄
 >= 2) {

1197 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
˘æ
);

1198 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1199 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ovîÊow
);

1200 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
, 
fixed
);

1202 
	`¥_öfo
("\n");

1203 
	`¥_öfo
("CPU#%d: cål: %016Œx\n", 
˝u
, 
˘æ
);

1204 
	`¥_öfo
("CPU#%d: sètus: %016Œx\n", 
˝u
, 
°©us
);

1205 
	`¥_öfo
("CPU#%d: ovîÊow: %016Œx\n", 
˝u
, 
ovîÊow
);

1206 
	`¥_öfo
("CPU#%d: fixed: %016Œx\n", 
˝u
, 
fixed
);

1208 
	`¥_öfo
("CPU#%d: u£d: %016Œx\n", 
˝u
, *(
u64
 *)
˝uc
->
u£d_mask
);

1210 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1211 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
pmc_˘æ
);

1212 
	`rdm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 
pmc_cou¡
);

1214 
¥ev_À·
 = 
	`≥r_˝u
’ªv_À·[
idx
], 
˝u
);

1216 
	`¥_öfo
("CPU#%d: gen-PMC%d ctrl: %016llx\n",

1217 
˝u
, 
idx
, 
pmc_˘æ
);

1218 
	`¥_öfo
("CPU#%d: gen-PMC%d count: %016llx\n",

1219 
˝u
, 
idx
, 
pmc_cou¡
);

1220 
	`¥_öfo
("CPU#%d: gen-PMC%dÜeft: %016llx\n",

1221 
˝u
, 
idx
, 
¥ev_À·
);

1223 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs_fixed
; idx++) {

1224 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 
pmc_cou¡
);

1226 
	`¥_öfo
("CPU#%d: fixed-PMC%d count: %016llx\n",

1227 
˝u
, 
idx
, 
pmc_cou¡
);

1229 
	`loˇl_úq_ª°‹e
(
Êags
);

1230 
	}
}

1232 
	$x86_pmu_dißbÀ
(
≥rf_cou¡î
 *
cou¡î
)

1234 
˝u_hw_cou¡îs
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_counters);

1235 
hw_≥rf_cou¡î
 *
hwc
 = &
cou¡î
->
hw
;

1236 
idx
 = 
hwc
->idx;

1242 
	`˛ór_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1243 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1249 
	`b¨rõr
();

1255 
	`x86_≥rf_cou¡î_upd©e
(
cou¡î
, 
hwc
, 
idx
);

1256 
˝uc
->
cou¡îs
[
idx
] = 
NULL
;

1257 
	`˛ór_bô
(
idx
, 
˝uc
->
u£d_mask
);

1259 
	`≥rf_cou¡î_upd©e_u£Ωage
(
cou¡î
);

1260 
	}
}

1266 
	$öãl_pmu_ßve_™d_ª°¨t
(
≥rf_cou¡î
 *
cou¡î
)

1268 
hw_≥rf_cou¡î
 *
hwc
 = &
cou¡î
->
hw
;

1269 
idx
 = 
hwc
->idx;

1270 
ªt
;

1272 
	`x86_≥rf_cou¡î_upd©e
(
cou¡î
, 
hwc
, 
idx
);

1273 
ªt
 = 
	`x86_≥rf_cou¡î_£t_≥riod
(
cou¡î
, 
hwc
, 
idx
);

1275 i‡(
cou¡î
->
°©e
 =
PERF_COUNTER_STATE_ACTIVE
)

1276 
	`öãl_pmu_íabÀ_cou¡î
(
hwc
, 
idx
);

1278  
ªt
;

1279 
	}
}

1281 
	$öãl_pmu_ª£t
()

1283 
Êags
;

1284 
idx
;

1286 i‡(!
x86_pmu
.
num_cou¡îs
)

1289 
	`loˇl_úq_ßve
(
Êags
);

1291 
	`¥ötk
("˛órög PMU sèã o¿CPU#%d\n", 
	`smp_¥o˚ss‹_id
());

1293 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1294 
	`checkög_wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 0ull);

1295 
	`checkög_wrm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 0ull);

1297 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs_fixed
; idx++) {

1298 
	`checkög_wrm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 0ull);

1301 
	`loˇl_úq_ª°‹e
(
Êags
);

1302 
	}
}

1304 
	$p6_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1306 
≥rf_ßm∂e_d©a
 
d©a
;

1307 
˝u_hw_cou¡îs
 *
˝uc
;

1308 
≥rf_cou¡î
 *
cou¡î
;

1309 
hw_≥rf_cou¡î
 *
hwc
;

1310 
idx
, 
h™dÀd
 = 0;

1311 
u64
 
vÆ
;

1313 
d©a
.
ªgs
 =Ñegs;

1314 
d©a
.
addr
 = 0;

1316 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_cou¡îs
);

1318 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1319 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1322 
cou¡î
 = 
˝uc
->
cou¡îs
[
idx
];

1323 
hwc
 = &
cou¡î
->
hw
;

1325 
vÆ
 = 
	`x86_≥rf_cou¡î_upd©e
(
cou¡î
, 
hwc
, 
idx
);

1326 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
cou¡î_bôs
 - 1)))

1332 
h™dÀd
 = 1;

1333 
d©a
.
≥riod
 = 
cou¡î
->
hw
.
œ°_≥riod
;

1335 i‡(!
	`x86_≥rf_cou¡î_£t_≥riod
(
cou¡î
, 
hwc
, 
idx
))

1338 i‡(
	`≥rf_cou¡î_ovîÊow
(
cou¡î
, 1, &
d©a
))

1339 
	`p6_pmu_dißbÀ_cou¡î
(
hwc
, 
idx
);

1342 i‡(
h™dÀd
)

1343 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1345  
h™dÀd
;

1346 
	}
}

1352 
	$öãl_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1354 
≥rf_ßm∂e_d©a
 
d©a
;

1355 
˝u_hw_cou¡îs
 *
˝uc
;

1356 
bô
, 
lo›s
;

1357 
u64
 
ack
, 
°©us
;

1359 
d©a
.
ªgs
 =Ñegs;

1360 
d©a
.
addr
 = 0;

1362 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_cou¡îs
);

1364 
	`≥rf_dißbÀ
();

1365 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1366 i‡(!
°©us
) {

1367 
	`≥rf_íabÀ
();

1371 
lo›s
 = 0;

1372 
agaö
:

1373 i‡(++
lo›s
 > 100) {

1374 
	`WARN_ONCE
(1, "perfcounters: irqÜoop stuck!\n");

1375 
	`≥rf_cou¡î_¥öt_debug
();

1376 
	`öãl_pmu_ª£t
();

1377 
	`≥rf_íabÀ
();

1381 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1382 
ack
 = 
°©us
;

1383 
	`f‹_óch_bô
(
bô
, (*)&
°©us
, 
X86_PMC_IDX_MAX
) {

1384 
≥rf_cou¡î
 *
cou¡î
 = 
˝uc
->
cou¡îs
[
bô
];

1386 
	`˛ór_bô
(
bô
, (*Ë&
°©us
);

1387 i‡(!
	`ã°_bô
(
bô
, 
˝uc
->
a˘ive_mask
))

1390 i‡(!
	`öãl_pmu_ßve_™d_ª°¨t
(
cou¡î
))

1393 
d©a
.
≥riod
 = 
cou¡î
->
hw
.
œ°_≥riod
;

1395 i‡(
	`≥rf_cou¡î_ovîÊow
(
cou¡î
, 1, &
d©a
))

1396 
	`öãl_pmu_dißbÀ_cou¡î
(&
cou¡î
->
hw
, 
bô
);

1399 
	`öãl_pmu_ack_°©us
(
ack
);

1404 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1405 i‡(
°©us
)

1406 
agaö
;

1408 
	`≥rf_íabÀ
();

1411 
	}
}

1413 
	$amd_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1415 
≥rf_ßm∂e_d©a
 
d©a
;

1416 
˝u_hw_cou¡îs
 *
˝uc
;

1417 
≥rf_cou¡î
 *
cou¡î
;

1418 
hw_≥rf_cou¡î
 *
hwc
;

1419 
idx
, 
h™dÀd
 = 0;

1420 
u64
 
vÆ
;

1422 
d©a
.
ªgs
 =Ñegs;

1423 
d©a
.
addr
 = 0;

1425 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_cou¡îs
);

1427 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1428 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1431 
cou¡î
 = 
˝uc
->
cou¡îs
[
idx
];

1432 
hwc
 = &
cou¡î
->
hw
;

1434 
vÆ
 = 
	`x86_≥rf_cou¡î_upd©e
(
cou¡î
, 
hwc
, 
idx
);

1435 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
cou¡î_bôs
 - 1)))

1441 
h™dÀd
 = 1;

1442 
d©a
.
≥riod
 = 
cou¡î
->
hw
.
œ°_≥riod
;

1444 i‡(!
	`x86_≥rf_cou¡î_£t_≥riod
(
cou¡î
, 
hwc
, 
idx
))

1447 i‡(
	`≥rf_cou¡î_ovîÊow
(
cou¡î
, 1, &
d©a
))

1448 
	`amd_pmu_dißbÀ_cou¡î
(
hwc
, 
idx
);

1451 i‡(
h™dÀd
)

1452 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1454  
h™dÀd
;

1455 
	}
}

1457 
	$smp_≥rf_≥ndög_öãºu±
(
±_ªgs
 *
ªgs
)

1459 
	`úq_íãr
();

1460 
	`ack_APIC_úq
();

1461 
	`öc_úq_°©
(
≠ic_≥ndög_úqs
);

1462 
	`≥rf_cou¡î_do_≥ndög
();

1463 
	`úq_exô
();

1464 
	}
}

1466 
	$£t_≥rf_cou¡î_≥ndög
()

1468 #ifde‡
CONFIG_X86_LOCAL_APIC


1469 
≠ic
->
	`£nd_IPI_£lf
(
LOCAL_PENDING_VECTOR
);

1471 
	}
}

1473 
	$≥rf_cou¡îs_œpic_öô
()

1475 #ifde‡
CONFIG_X86_LOCAL_APIC


1476 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1482 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1484 
	}
}

1486 
__k¥obes


1487 
	$≥rf_cou¡î_nmi_h™dÀr
(
nŸifõr_block
 *
£lf
,

1488 
cmd
, *
__¨gs
)

1490 
dõ_¨gs
 *
¨gs
 = 
__¨gs
;

1491 
±_ªgs
 *
ªgs
;

1493 i‡(!
	`©omic_ªad
(&
a˘ive_cou¡îs
))

1494  
NOTIFY_DONE
;

1496 
cmd
) {

1497 
DIE_NMI
:

1498 
DIE_NMI_IPI
:

1502  
NOTIFY_DONE
;

1505 
ªgs
 = 
¨gs
->regs;

1507 #ifde‡
CONFIG_X86_LOCAL_APIC


1508 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1517 
x86_pmu
.
	`h™dÀ_úq
(
ªgs
);

1519  
NOTIFY_STOP
;

1520 
	}
}

1522 
__ªad_mo°ly
 
nŸifõr_block
 
	g≥rf_cou¡î_nmi_nŸifõr
 = {

1523 .
nŸifõr_ˇŒ
 = 
≥rf_cou¡î_nmi_h™dÀr
,

1524 .
	g√xt
 = 
NULL
,

1525 .
	g¥i‹ôy
 = 1

1528 
x86_pmu
 
	gp6_pmu
 = {

1529 .
«me
 = "p6",

1530 .
	gh™dÀ_úq
 = 
p6_pmu_h™dÀ_úq
,

1531 .
	gdißbÀ_Æl
 = 
p6_pmu_dißbÀ_Æl
,

1532 .
	gíabÀ_Æl
 = 
p6_pmu_íabÀ_Æl
,

1533 .
	gíabÀ
 = 
p6_pmu_íabÀ_cou¡î
,

1534 .
	gdißbÀ
 = 
p6_pmu_dißbÀ_cou¡î
,

1535 .
	gevít£l
 = 
MSR_P6_EVNTSEL0
,

1536 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

1537 .
	gevít_m≠
 = 
p6_pmu_evít_m≠
,

1538 .
	gøw_evít
 = 
p6_pmu_øw_evít
,

1539 .
	gmax_evíts
 = 
ARRAY_SIZE
(
p6_≥rfm⁄_evít_m≠
),

1540 .
	g≠ic
 = 1,

1541 .
	gmax_≥riod
 = (1ULL << 31) - 1,

1542 .
	gvîsi⁄
 = 0,

1543 .
	gnum_cou¡îs
 = 2,

1551 .
	gcou¡î_bôs
 = 32,

1552 .
	gcou¡î_mask
 = (1ULL << 32) - 1,

1555 
x86_pmu
 
	göãl_pmu
 = {

1556 .
«me
 = "Intel",

1557 .
	gh™dÀ_úq
 = 
öãl_pmu_h™dÀ_úq
,

1558 .
	gdißbÀ_Æl
 = 
öãl_pmu_dißbÀ_Æl
,

1559 .
	gíabÀ_Æl
 = 
öãl_pmu_íabÀ_Æl
,

1560 .
	gíabÀ
 = 
öãl_pmu_íabÀ_cou¡î
,

1561 .
	gdißbÀ
 = 
öãl_pmu_dißbÀ_cou¡î
,

1562 .
	gevít£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
,

1563 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
,

1564 .
	gevít_m≠
 = 
öãl_pmu_evít_m≠
,

1565 .
	gøw_evít
 = 
öãl_pmu_øw_evít
,

1566 .
	gmax_evíts
 = 
ARRAY_SIZE
(
öãl_≥rfm⁄_evít_m≠
),

1567 .
	g≠ic
 = 1,

1573 .
	gmax_≥riod
 = (1ULL << 31) - 1,

1576 
x86_pmu
 
	gamd_pmu
 = {

1577 .
«me
 = "AMD",

1578 .
	gh™dÀ_úq
 = 
amd_pmu_h™dÀ_úq
,

1579 .
	gdißbÀ_Æl
 = 
amd_pmu_dißbÀ_Æl
,

1580 .
	gíabÀ_Æl
 = 
amd_pmu_íabÀ_Æl
,

1581 .
	gíabÀ
 = 
amd_pmu_íabÀ_cou¡î
,

1582 .
	gdißbÀ
 = 
amd_pmu_dißbÀ_cou¡î
,

1583 .
	gevít£l
 = 
MSR_K7_EVNTSEL0
,

1584 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

1585 .
	gevít_m≠
 = 
amd_pmu_evít_m≠
,

1586 .
	gøw_evít
 = 
amd_pmu_øw_evít
,

1587 .
	gmax_evíts
 = 
ARRAY_SIZE
(
amd_≥rfm⁄_evít_m≠
),

1588 .
	gnum_cou¡îs
 = 4,

1589 .
	gcou¡î_bôs
 = 48,

1590 .
	gcou¡î_mask
 = (1ULL << 48) - 1,

1591 .
	g≠ic
 = 1,

1593 .
	gmax_≥riod
 = (1ULL << 47) - 1,

1596 
	$p6_pmu_öô
()

1598 
boŸ_˝u_d©a
.
x86_modñ
) {

1612 
	`¥_c⁄t
("unsupportedÖ6 CPU model %d ",

1613 
boŸ_˝u_d©a
.
x86_modñ
);

1614  -
ENODEV
;

1617 
x86_pmu
 = 
p6_pmu
;

1619 i‡(!
˝u_has_≠ic
) {

1620 
	`¥_öfo
("no APIC, boot withÅhe \"lapic\" bootÖarameterÅo force-enable it.\n");

1621 
	`¥_öfo
("no hardware sampling interruptávailable.\n");

1622 
x86_pmu
.
≠ic
 = 0;

1626 
	}
}

1628 
	$öãl_pmu_öô
()

1630 
˝uid10_edx
 
edx
;

1631 
˝uid10_óx
 
óx
;

1632 
unu£d
;

1633 
ebx
;

1634 
vîsi⁄
;

1636 i‡(!
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

1638 i‡(
boŸ_˝u_d©a
.
x86
 == 6) {

1639  
	`p6_pmu_öô
();

1641  -
ENODEV
;

1649 
	`˝uid
(10, &
óx
.
fuŒ
, &
ebx
, &
unu£d
, &
edx
.full);

1650 i‡(
óx
.
•lô
.
mask_Àngth
 <
ARCH_PERFMON_BRANCH_MISSES_RETIRED
)

1651  -
ENODEV
;

1653 
vîsi⁄
 = 
óx
.
•lô
.
vîsi⁄_id
;

1654 i‡(
vîsi⁄
 < 2)

1655  -
ENODEV
;

1657 
x86_pmu
 = 
öãl_pmu
;

1658 
x86_pmu
.
vîsi⁄
 = version;

1659 
x86_pmu
.
num_cou¡îs
 = 
óx
.
•lô
.num_counters;

1660 
x86_pmu
.
cou¡î_bôs
 = 
óx
.
•lô
.
bô_width
;

1661 
x86_pmu
.
cou¡î_mask
 = (1ULL << 
óx
.
•lô
.
bô_width
) - 1;

1667 
x86_pmu
.
num_cou¡îs_fixed
 = 
	`max
(()
edx
.
•lô
.num_counters_fixed, 3);

1672 
boŸ_˝u_d©a
.
x86_modñ
) {

1677 
	`mem˝y
(
hw_ˇche_evít_ids
, 
c‹e2_hw_ˇche_evít_ids
,

1678 (
hw_ˇche_evít_ids
));

1680 
	`¥_c⁄t
("Core2Évents, ");

1684 
	`mem˝y
(
hw_ˇche_evít_ids
, 
√hÆem_hw_ˇche_evít_ids
,

1685 (
hw_ˇche_evít_ids
));

1687 
	`¥_c⁄t
("Nehalem/Corei7Évents, ");

1690 
	`mem˝y
(
hw_ˇche_evít_ids
, 
©om_hw_ˇche_evít_ids
,

1691 (
hw_ˇche_evít_ids
));

1693 
	`¥_c⁄t
("AtomÉvents, ");

1697 
	}
}

1699 
	$amd_pmu_öô
()

1702 i‡(
boŸ_˝u_d©a
.
x86
 < 6)

1703  -
ENODEV
;

1705 
x86_pmu
 = 
amd_pmu
;

1708 
	`mem˝y
(
hw_ˇche_evít_ids
, 
amd_hw_ˇche_evít_ids
,

1709 (
hw_ˇche_evít_ids
));

1712 
	}
}

1714 
__öô
 
	$öô_hw_≥rf_cou¡îs
()

1716 
îr
;

1718 
	`¥_öfo
("Performance Counters: ");

1720 
boŸ_˝u_d©a
.
x86_víd‹
) {

1721 
X86_VENDOR_INTEL
:

1722 
îr
 = 
	`öãl_pmu_öô
();

1724 
X86_VENDOR_AMD
:

1725 
îr
 = 
	`amd_pmu_öô
();

1730 i‡(
îr
 != 0) {

1731 
	`¥_c⁄t
("no PMU driver, software counters only.\n");

1735 
	`¥_c⁄t
("%†PMU drivî.\n", 
x86_pmu
.
«me
);

1737 i‡(
x86_pmu
.
num_cou¡îs
 > 
X86_PMC_MAX_GENERIC
) {

1738 
	`WARN
(1, 
KERN_ERR
 "hwÖerf counters %d > max(%d), clipping!",

1739 
x86_pmu
.
num_cou¡îs
, 
X86_PMC_MAX_GENERIC
);

1740 
x86_pmu
.
num_cou¡îs
 = 
X86_PMC_MAX_GENERIC
;

1742 
≥rf_cou¡î_mask
 = (1 << 
x86_pmu
.
num_cou¡îs
) - 1;

1743 
≥rf_max_cou¡îs
 = 
x86_pmu
.
num_cou¡îs
;

1745 i‡(
x86_pmu
.
num_cou¡îs_fixed
 > 
X86_PMC_MAX_FIXED
) {

1746 
	`WARN
(1, 
KERN_ERR
 "hwÖerf counters fixed %d > max(%d), clipping!",

1747 
x86_pmu
.
num_cou¡îs_fixed
, 
X86_PMC_MAX_FIXED
);

1748 
x86_pmu
.
num_cou¡îs_fixed
 = 
X86_PMC_MAX_FIXED
;

1751 
≥rf_cou¡î_mask
 |=

1752 ((1LL << 
x86_pmu
.
num_cou¡îs_fixed
)-1Ë<< 
X86_PMC_IDX_FIXED
;

1753 
x86_pmu
.
öãl_˘æ
 = 
≥rf_cou¡î_mask
;

1755 
	`≥rf_cou¡îs_œpic_öô
();

1756 
	`ªgi°î_dõ_nŸifõr
(&
≥rf_cou¡î_nmi_nŸifõr
);

1758 
	`¥_öfo
("... vîsi⁄: %d\n", 
x86_pmu
.
vîsi⁄
);

1759 
	`¥_öfo
("... bô width: %d\n", 
x86_pmu
.
cou¡î_bôs
);

1760 
	`¥_öfo
("... gíîi¯cou¡îs: %d\n", 
x86_pmu
.
num_cou¡îs
);

1761 
	`¥_öfo
("... vÆuêmask: %016Lx\n", 
x86_pmu
.
cou¡î_mask
);

1762 
	`¥_öfo
("... maxÖîiod: %016Lx\n", 
x86_pmu
.
max_≥riod
);

1763 
	`¥_öfo
("... fixed-puΩo£ cou¡îs: %d\n", 
x86_pmu
.
num_cou¡îs_fixed
);

1764 
	`¥_öfo
("... cou¡î mask: %016Lx\n", 
≥rf_cou¡î_mask
);

1765 
	}
}

1767 
ölöe
 
	$x86_pmu_ªad
(
≥rf_cou¡î
 *
cou¡î
)

1769 
	`x86_≥rf_cou¡î_upd©e
(
cou¡î
, &cou¡î->
hw
, cou¡î->hw.
idx
);

1770 
	}
}

1772 c⁄° 
pmu
 
	gpmu
 = {

1773 .
íabÀ
 = 
x86_pmu_íabÀ
,

1774 .
	gdißbÀ
 = 
x86_pmu_dißbÀ
,

1775 .
	gªad
 = 
x86_pmu_ªad
,

1776 .
	gu¡hrŸée
 = 
x86_pmu_u¡hrŸée
,

1779 c⁄° 
pmu
 *
	$hw_≥rf_cou¡î_öô
(
≥rf_cou¡î
 *
cou¡î
)

1781 
îr
;

1783 
îr
 = 
	`__hw_≥rf_cou¡î_öô
(
cou¡î
);

1784 i‡(
îr
)

1785  
	`ERR_PTR
(
îr
);

1787  &
pmu
;

1788 
	}
}

1794 
ölöe


1795 
	$ˇŒchaö_°‹e
(
≥rf_ˇŒchaö_íåy
 *
íåy
, 
u64
 
ù
)

1797 i‡(
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
)

1798 
íåy
->
ù
[íåy->
ƒ
++] = ip;

1799 
	}
}

1801 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
úq_íåy
);

1802 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
nmi_íåy
);

1803 
DEFINE_PER_CPU
(, 
ö_nmi_‰ame
);

1807 
	$backåa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

1810 
	}
}

1812 
	$backåa˚_w¨nög
(*
d©a
, *
msg
)

1815 
	}
}

1817 
	$backåa˚_°ack
(*
d©a
, *
«me
)

1819 
	`≥r_˝u
(
ö_nmi_‰ame
, 
	`smp_¥o˚ss‹_id
()) =

1820 
	`x86_is_°ack_id
(
NMI_STACK
, 
«me
);

1823 
	}
}

1825 
	$backåa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

1827 
≥rf_ˇŒchaö_íåy
 *
íåy
 = 
d©a
;

1829 i‡(
	`≥r_˝u
(
ö_nmi_‰ame
, 
	`smp_¥o˚ss‹_id
()))

1832 i‡(
ªlübÀ
)

1833 
	`ˇŒchaö_°‹e
(
íåy
, 
addr
);

1834 
	}
}

1836 c⁄° 
°ackåa˚_›s
 
	gbackåa˚_›s
 = {

1837 .
w¨nög
 = 
backåa˚_w¨nög
,

1838 .
	gw¨nög_symbﬁ
 = 
backåa˚_w¨nög_symbﬁ
,

1839 .
	g°ack
 = 
backåa˚_°ack
,

1840 .
	gaddªss
 = 
backåa˚_addªss
,

1843 
	~"../dump°ack.h
"

1846 
	$≥rf_ˇŒchaö_kî√l
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1848 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_KERNEL
);

1849 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1851 
	`dump_åa˚
(
NULL
, 
ªgs
, NULL, 0, &
backåa˚_›s
, 
íåy
);

1852 
	}
}

1858 
	$c›y_‰om_u£r_nmi
(*
to
, c⁄° 
__u£r
 *
‰om
, 
n
)

1860 
off£t
, 
addr
 = ()
‰om
;

1861 
ty≥
 = 
	`ö_nmi
(Ë? 
KM_NMI
 : 
KM_IRQ0
;

1862 
size
, 
Àn
 = 0;

1863 
∑ge
 *page;

1864 *
m≠
;

1865 
ªt
;

1868 
ªt
 = 
	`__gë_u£r_∑ges_Á°
(
addr
, 1, 0, &
∑ge
);

1869 i‡(!
ªt
)

1872 
off£t
 = 
addr
 & (
PAGE_SIZE
 - 1);

1873 
size
 = 
	`mö
(
PAGE_SIZE
 - 
off£t
, 
n
 - 
Àn
);

1875 
m≠
 = 
	`km≠_©omic
(
∑ge
, 
ty≥
);

1876 
	`mem˝y
(
to
, 
m≠
+
off£t
, 
size
);

1877 
	`kunm≠_©omic
(
m≠
, 
ty≥
);

1878 
	`put_∑ge
(
∑ge
);

1880 
Àn
 +
size
;

1881 
to
 +
size
;

1882 
addr
 +
size
;

1884 } 
Àn
 < 
n
);

1886  
Àn
;

1887 
	}
}

1889 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

1891 
byãs
;

1893 
byãs
 = 
	`c›y_‰om_u£r_nmi
(
‰ame
, 
Â
, (*frame));

1895  
byãs
 =(*
‰ame
);

1896 
	}
}

1899 
	$≥rf_ˇŒchaö_u£r
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1901 
°ack_‰ame
 
‰ame
;

1902 c⁄° 
__u£r
 *
Â
;

1904 i‡(!
	`u£r_mode
(
ªgs
))

1905 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

1907 
Â
 = (
__u£r
 *)
ªgs
->
bp
;

1909 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_USER
);

1910 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1912 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

1913 
‰ame
.
√xt_‰ame
 = 
NULL
;

1914 
‰ame
.
ªtu∫_addªss
 = 0;

1916 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

1919 i‡(()
Â
 < 
ªgs
->
•
)

1922 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

1923 
Â
 = 
‰ame
.
√xt_‰ame
;

1925 
	}
}

1928 
	$≥rf_do_ˇŒchaö
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1930 
is_u£r
;

1932 i‡(!
ªgs
)

1935 
is_u£r
 = 
	`u£r_mode
(
ªgs
);

1937 i‡(!
cuºít
 || cuºít->
pid
 == 0)

1940 i‡(
is_u£r
 && 
cuºít
->
°©e
 !
TASK_RUNNING
)

1943 i‡(!
is_u£r
)

1944 
	`≥rf_ˇŒchaö_kî√l
(
ªgs
, 
íåy
);

1946 i‡(
cuºít
->
mm
)

1947 
	`≥rf_ˇŒchaö_u£r
(
ªgs
, 
íåy
);

1948 
	}
}

1950 
≥rf_ˇŒchaö_íåy
 *
	$≥rf_ˇŒchaö
(
±_ªgs
 *
ªgs
)

1952 
≥rf_ˇŒchaö_íåy
 *
íåy
;

1954 i‡(
	`ö_nmi
())

1955 
íåy
 = &
	`__gë_˝u_v¨
(
nmi_íåy
);

1957 
íåy
 = &
	`__gë_˝u_v¨
(
úq_íåy
);

1959 
íåy
->
ƒ
 = 0;

1961 
	`≥rf_do_ˇŒchaö
(
ªgs
, 
íåy
);

1963  
íåy
;

1964 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/bô›s.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/nmi.h
>

20 
	~<löux/k¥obes.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/≥rf_cou¡î.h
>

25 
	snmi_w©chdog_˘lblk
 {

26 
	mcc¸_m§
;

27 
	m≥rf˘r_m§
;

28 
	mev¡£l_m§
;

32 
	swd_›s
 {

33 (*
	mª£rve
)();

34 (*
	muƒe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	mª¨m
)(
nmi_w©chdog_˘lblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m°›
)();

38 
	m≥rf˘r
;

39 
	mev¡£l
;

40 
u64
 
	mcheckbô
;

43 c⁄° 
wd_›s
 *
	gwd_›s
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
≥rf˘r_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
ev¡£l_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_˘lblk
,Çmi_watchdog_ctlblk);

66 
ölöe
 
	$nmi_≥rf˘r_m§_to_bô
(
m§
)

69 
boŸ_˝u_d©a
.
x86_víd‹
) {

70 
X86_VENDOR_AMD
:

71  (
m§
 - 
MSR_K7_PERFCTR0
);

72 
X86_VENDOR_INTEL
:

73 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  (
m§
 - 
MSR_ARCH_PERFMON_PERFCTR0
);

76 
boŸ_˝u_d©a
.
x86
) {

78  (
m§
 - 
MSR_P6_PERFCTR0
);

80  (
m§
 - 
MSR_P4_BPU_PERFCTR0
);

84 
	}
}

90 
ölöe
 
	$nmi_ev¡£l_m§_to_bô
(
m§
)

93 
boŸ_˝u_d©a
.
x86_víd‹
) {

94 
X86_VENDOR_AMD
:

95  (
m§
 - 
MSR_K7_EVNTSEL0
);

96 
X86_VENDOR_INTEL
:

97 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  (
m§
 - 
MSR_ARCH_PERFMON_EVENTSEL0
);

100 
boŸ_˝u_d©a
.
x86
) {

102  (
m§
 - 
MSR_P6_EVNTSEL0
);

104  (
m§
 - 
MSR_P4_BSU_ESCR0
);

109 
	}
}

112 
	$avaû_to_ª§v_≥rf˘r_nmi_bô
(
cou¡î
)

114 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

116  (!
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
));

117 
	}
}

120 
	$avaû_to_ª§v_≥rf˘r_nmi
(
m§
)

122 
cou¡î
;

124 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

125 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

127  (!
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
));

128 
	}
}

129 
EXPORT_SYMBOL
(
avaû_to_ª§v_≥rf˘r_nmi_bô
);

131 
	$ª£rve_≥rf˘r_nmi
(
m§
)

133 
cou¡î
;

135 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

137 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

140 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
))

143 
	}
}

144 
EXPORT_SYMBOL
(
ª£rve_≥rf˘r_nmi
);

146 
	$ªÀa£_≥rf˘r_nmi
(
m§
)

148 
cou¡î
;

150 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

152 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

155 
	`˛ór_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

156 
	}
}

157 
EXPORT_SYMBOL
(
ªÀa£_≥rf˘r_nmi
);

159 
	$ª£rve_ev¡£l_nmi
(
m§
)

161 
cou¡î
;

163 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

165 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

168 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
))

171 
	}
}

172 
EXPORT_SYMBOL
(
ª£rve_ev¡£l_nmi
);

174 
	$ªÀa£_ev¡£l_nmi
(
m§
)

176 
cou¡î
;

178 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

180 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

183 
	`˛ór_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
);

184 
	}
}

185 
EXPORT_SYMBOL
(
ªÀa£_ev¡£l_nmi
);

187 
	$dißbÀ_œpic_nmi_w©chdog
()

189 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

191 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

194 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

196 i‡(
wd_›s
)

197 
wd_›s
->
	`uƒe£rve
();

199 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

200 
	}
}

202 
	$íabÀ_œpic_nmi_w©chdog
()

204 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

207 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) != 0)

211 i‡(!
wd_›s
)

213 i‡(!
wd_›s
->
	`ª£rve
()) {

214 
	`¥ötk
(
KERN_ERR
 "NMI watchdog: cannotÑeserveÖerfctrs\n");

218 
	`⁄_óch_˝u
(
£tup_≠ic_nmi_w©chdog
, 
NULL
, 1);

219 
	`touch_nmi_w©chdog
();

220 
	}
}

226 
	$adju°_f‹_32bô_˘r
(
hz
)

228 
u64
 
cou¡î_vÆ
;

229 
ªtvÆ
 = 
hz
;

238 
cou¡î_vÆ
 = (
u64
)
˝u_khz
 * 1000;

239 
	`do_div
(
cou¡î_vÆ
, 
ªtvÆ
);

240 i‡(
cou¡î_vÆ
 > 0x7fffffffULL) {

241 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

242 
	`do_div
(
cou¡
, 0x7fffffffUL);

243 
ªtvÆ
 = 
cou¡
 + 1;

245  
ªtvÆ
;

246 
	}
}

248 
	$wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
,

249 c⁄° *
des¸
, 
nmi_hz
)

251 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

253 
	`do_div
(
cou¡
, 
nmi_hz
);

254 if(
des¸
)

255 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

256 
	`wrm§l
(
≥rf˘r_m§
, 0 - 
cou¡
);

257 
	}
}

259 
	$wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
,

260 c⁄° *
des¸
, 
nmi_hz
)

262 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

264 
	`do_div
(
cou¡
, 
nmi_hz
);

265 if(
des¸
)

266 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

267 
	`wrm§
(
≥rf˘r_m§
, (
u32
)(-
cou¡
), 0);

268 
	}
}

274 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

275 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

276 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

277 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

278 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

279 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

281 
	$£tup_k7_w©chdog
(
nmi_hz
)

283 
≥rf˘r_m§
, 
ev¡£l_m§
;

284 
ev¡£l
;

285 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

287 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

288 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

290 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

292 
ev¡£l
 = 
K7_EVNTSEL_INT


293 | 
K7_EVNTSEL_OS


294 | 
K7_EVNTSEL_USR


295 | 
K7_NMI_EVENT
;

298 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

299 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "K7_PERFCTR0",
nmi_hz
);

302 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

303 
wd
->
ev¡£l_m§
 =Évntsel_msr;

304 
wd
->
cc¸_m§
 = 0;

307 
	`˝u_nmi_£t_wd_íabÀd
();

309 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

310 
ev¡£l
 |
K7_EVNTSEL_ENABLE
;

311 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

314 
	}
}

316 
	$sögÀ_m§_°›_w©chdog
()

318 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

320 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

321 
	}
}

323 
	$sögÀ_m§_ª£rve
()

325 i‡(!
	`ª£rve_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
))

328 i‡(!
	`ª£rve_ev¡£l_nmi
(
wd_›s
->
ev¡£l
)) {

329 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

333 
	}
}

335 
	$sögÀ_m§_uƒe£rve
()

337 
	`ªÀa£_ev¡£l_nmi
(
wd_›s
->
ev¡£l
);

338 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

339 
	}
}

341 
__k¥obes


342 
	$sögÀ_m§_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

345 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

346 
	}
}

348 c⁄° 
wd_›s
 
	gk7_wd_›s
 = {

349 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

350 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

351 .
	g£tup
 = 
£tup_k7_w©chdog
,

352 .
	gª¨m
 = 
sögÀ_m§_ª¨m
,

353 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

354 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

355 .
	gev¡£l
 = 
MSR_K7_EVNTSEL0
,

356 .
	gcheckbô
 = 1ULL << 47,

362 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

363 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

364 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

365 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

366 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

367 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

369 
	$£tup_p6_w©chdog
(
nmi_hz
)

371 
≥rf˘r_m§
, 
ev¡£l_m§
;

372 
ev¡£l
;

373 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

375 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

376 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

379 i‡(
	`wrm§_ß„
(
≥rf˘r_m§
, 0, 0) < 0)

382 
ev¡£l
 = 
P6_EVNTSEL_INT


383 | 
P6_EVNTSEL_OS


384 | 
P6_EVNTSEL_USR


385 | 
P6_NMI_EVENT
;

388 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

389 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

390 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "P6_PERFCTR0",
nmi_hz
);

393 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

394 
wd
->
ev¡£l_m§
 =Évntsel_msr;

395 
wd
->
cc¸_m§
 = 0;

398 
	`˝u_nmi_£t_wd_íabÀd
();

400 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

401 
ev¡£l
 |
P6_EVNTSEL0_ENABLE
;

402 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

405 
	}
}

407 
__k¥obes
 
	$p6_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

415 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

418 
	`wrôe_w©chdog_cou¡î32
(
wd
->
≥rf˘r_m§
, 
NULL
,
nmi_hz
);

419 
	}
}

421 c⁄° 
wd_›s
 
	gp6_wd_›s
 = {

422 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

423 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

424 .
	g£tup
 = 
£tup_p6_w©chdog
,

425 .
	gª¨m
 = 
p6_ª¨m
,

426 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

427 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

428 .
	gev¡£l
 = 
MSR_P6_EVNTSEL0
,

429 .
	gcheckbô
 = 1ULL << 39,

436 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

437 
	#P4_ESCR_EVENT_SELECT
(
N
Ë((NË<< 25)

	)

438 
	#P4_ESCR_OS
 (1 << 3)

	)

439 
	#P4_ESCR_USR
 (1 << 2)

	)

440 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

441 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

442 
	#P4_CCCR_THRESHOLD
(
N
Ë((NË<< 20)

	)

443 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

444 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

445 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

446 
	#P4_CCCR_ESCR_SELECT
(
N
Ë((NË<< 13)

	)

447 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

448 
	#P4_CCCR_OVF
 (1 << 31)

	)

450 
	#P4_CONTROLS
 18

	)

451 
	gp4_c⁄åﬁs
[18] = {

452 
MSR_P4_BPU_CCCR0
,

453 
MSR_P4_BPU_CCCR1
,

454 
MSR_P4_BPU_CCCR2
,

455 
MSR_P4_BPU_CCCR3
,

456 
MSR_P4_MS_CCCR0
,

457 
MSR_P4_MS_CCCR1
,

458 
MSR_P4_MS_CCCR2
,

459 
MSR_P4_MS_CCCR3
,

460 
MSR_P4_FLAME_CCCR0
,

461 
MSR_P4_FLAME_CCCR1
,

462 
MSR_P4_FLAME_CCCR2
,

463 
MSR_P4_FLAME_CCCR3
,

464 
MSR_P4_IQ_CCCR0
,

465 
MSR_P4_IQ_CCCR1
,

466 
MSR_P4_IQ_CCCR2
,

467 
MSR_P4_IQ_CCCR3
,

468 
MSR_P4_IQ_CCCR4
,

469 
MSR_P4_IQ_CCCR5
,

476 
	$£tup_p4_w©chdog
(
nmi_hz
)

478 
≥rf˘r_m§
, 
ev¡£l_m§
, 
cc¸_m§
;

479 
ev¡£l
, 
cc¸_vÆ
;

480 
misc_íabÀ
, 
dummy
;

481 
ht_num
;

482 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

484 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
, 
dummy
);

485 i‡(!(
misc_íabÀ
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

488 #ifde‡
CONFIG_SMP


490 i‡(
smp_num_siblögs
 == 2) {

491 
ebx
, 
≠icid
;

493 
ebx
 = 
	`˝uid_ebx
(1);

494 
≠icid
 = (
ebx
 >> 24) & 0xff;

495 
ht_num
 = 
≠icid
 & 1;

498 
ht_num
 = 0;

506 i‡(!
ht_num
) {

508 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR0
;

509 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

510 
cc¸_m§
 = 
MSR_P4_IQ_CCCR0
;

511 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

522 i‡(
ª£t_devi˚s
) {

523 
low
, 
high
;

524 
i
;

526 
i
 = 0; i < 
P4_CONTROLS
; i++) {

527 
	`rdm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

528 
low
 &~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

529 
	`wrm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

534 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR1
;

535 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

536 
cc¸_m§
 = 
MSR_P4_IQ_CCCR1
;

539 i‡(
boŸ_˝u_d©a
.
x86_modñ
 =4 && boŸ_˝u_d©a.
x86_mask
 == 4)

540 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
;

542 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI1
;

543 
cc¸_vÆ
 |
	`P4_CCCR_ESCR_SELECT
(4);

546 
ev¡£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

547 | 
P4_ESCR_OS


548 | 
P4_ESCR_USR
;

550 
cc¸_vÆ
 |
	`P4_CCCR_THRESHOLD
(15)

551 | 
P4_CCCR_COMPLEMENT


552 | 
P4_CCCR_COMPARE


553 | 
P4_CCCR_REQUIRED
;

555 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

556 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

557 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "P4_IQ_COUNTER0", 
nmi_hz
);

559 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

560 
wd
->
ev¡£l_m§
 =Évntsel_msr;

561 
wd
->
cc¸_m§
 = cccr_msr;

564 
	`˝u_nmi_£t_wd_íabÀd
();

566 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

567 
cc¸_vÆ
 |
P4_CCCR_ENABLE
;

568 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

570 
	}
}

572 
	$°›_p4_w©chdog
()

574 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

575 
	`wrm§
(
wd
->
cc¸_m§
, 0, 0);

576 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

577 
	}
}

579 
	$p4_ª£rve
()

581 i‡(!
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
))

583 #ifde‡
CONFIG_SMP


584 i‡(
smp_num_siblögs
 > 1 && !
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
))

585 
Áû1
;

587 i‡(!
	`ª£rve_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
))

588 
Áû2
;

591 
Áû2
:

592 #ifde‡
CONFIG_SMP


593 i‡(
smp_num_siblögs
 > 1)

594 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

595 
Áû1
:

597 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

599 
	}
}

601 
	$p4_uƒe£rve
()

603 #ifde‡
CONFIG_SMP


604 i‡(
smp_num_siblögs
 > 1)

605 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

607 
	`ªÀa£_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
);

608 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

609 
	}
}

611 
__k¥obes
 
	$p4_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

613 
dummy
;

621 
	`rdm§l
(
wd
->
cc¸_m§
, 
dummy
);

622 
dummy
 &~
P4_CCCR_OVF
;

623 
	`wrm§l
(
wd
->
cc¸_m§
, 
dummy
);

624 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

626 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

627 
	}
}

629 c⁄° 
wd_›s
 
	gp4_wd_›s
 = {

630 .
ª£rve
 = 
p4_ª£rve
,

631 .
	guƒe£rve
 = 
p4_uƒe£rve
,

632 .
	g£tup
 = 
£tup_p4_w©chdog
,

633 .
	gª¨m
 = 
p4_ª¨m
,

634 .
	g°›
 = 
°›_p4_w©chdog
,

636 .
	g≥rf˘r
 = 
MSR_P4_BPU_PERFCTR0
,

637 .
	gev¡£l
 = 
MSR_P4_BSU_ESCR0
,

638 .
	gcheckbô
 = 1ULL << 39,

645 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

646 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

648 
wd_›s
 
	göãl_¨ch_wd_›s
;

650 
	$£tup_öãl_¨ch_w©chdog
(
nmi_hz
)

652 
ebx
;

653 
˝uid10_óx
 
óx
;

654 
unu£d
;

655 
≥rf˘r_m§
, 
ev¡£l_m§
;

656 
ev¡£l
;

657 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

664 
	`˝uid
(10, &(
óx
.
fuŒ
), &
ebx
, &
unu£d
, &unused);

665 i‡((
óx
.
•lô
.
mask_Àngth
 < (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

666 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

669 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

670 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

672 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

674 
ev¡£l
 = 
ARCH_PERFMON_EVENTSEL_INT


675 | 
ARCH_PERFMON_EVENTSEL_OS


676 | 
ARCH_PERFMON_EVENTSEL_USR


677 | 
ARCH_PERFMON_NMI_EVENT_SEL


678 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

681 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

682 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

683 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

685 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

686 
wd
->
ev¡£l_m§
 =Évntsel_msr;

687 
wd
->
cc¸_m§
 = 0;

690 
	`˝u_nmi_£t_wd_íabÀd
();

692 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

693 
ev¡£l
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

694 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

695 
öãl_¨ch_wd_›s
.
checkbô
 = 1ULL << (
óx
.
•lô
.
bô_width
 - 1);

697 
	}
}

699 
wd_›s
 
öãl_¨ch_wd_›s
 
	g__ªad_mo°ly
 = {

700 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

701 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

702 .
	g£tup
 = 
£tup_öãl_¨ch_w©chdog
,

703 .
	gª¨m
 = 
p6_ª¨m
,

704 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

705 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

706 .
	gev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

709 
	$¥obe_nmi_w©chdog
()

711 
boŸ_˝u_d©a
.
x86_víd‹
) {

712 
X86_VENDOR_AMD
:

713 i‡(
boŸ_˝u_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

714 
boŸ_˝u_d©a
.
x86
 != 16)

716 
wd_›s
 = &
k7_wd_›s
;

718 
X86_VENDOR_INTEL
:

725 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 14) ||

726 ((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 15 &&

727 
boŸ_˝u_d©a
.
x86_mask
 == 4))) {

728 
öãl_¨ch_wd_›s
.
≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

729 
öãl_¨ch_wd_›s
.
ev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

731 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

732 
wd_›s
 = &
öãl_¨ch_wd_›s
;

735 
boŸ_˝u_d©a
.
x86
) {

737 i‡(
boŸ_˝u_d©a
.
x86_modñ
 > 13)

740 
wd_›s
 = &
p6_wd_›s
;

743 
wd_›s
 = &
p4_wd_›s
;

750 
	}
}

754 
	$œpic_w©chdog_öô
(
nmi_hz
)

756 i‡(!
wd_›s
) {

757 
	`¥obe_nmi_w©chdog
();

758 i‡(!
wd_›s
) {

759 
	`¥ötk
(
KERN_INFO
 "NMI watchdog: CPUÇot supported\n");

763 i‡(!
wd_›s
->
	`ª£rve
()) {

764 
	`¥ötk
(
KERN_ERR


770 i‡(!(
wd_›s
->
	`£tup
(
nmi_hz
))) {

771 
	`¥ötk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

772 
	`øw_smp_¥o˚ss‹_id
());

777 
	}
}

779 
	$œpic_w©chdog_°›
()

781 i‡(
wd_›s
)

782 
wd_›s
->
	`°›
();

783 
	}
}

785 
	$œpic_adju°_nmi_hz
(
hz
)

787 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

788 i‡(
wd
->
≥rf˘r_m§
 =
MSR_P6_PERFCTR0
 ||

789 
wd
->
≥rf˘r_m§
 =
MSR_ARCH_PERFMON_PERFCTR1
)

790 
hz
 = 
	`adju°_f‹_32bô_˘r
(hz);

791  
hz
;

792 
	}
}

794 
__k¥obes
 
	$œpic_wd_evít
(
nmi_hz
)

796 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

797 
u64
 
˘r
;

799 
	`rdm§l
(
wd
->
≥rf˘r_m§
, 
˘r
);

800 i‡(
˘r
 & 
wd_›s
->
checkbô
)

803 
wd_›s
->
	`ª¨m
(
wd
, 
nmi_hz
);

805 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/˝u„©uª.h
>

9 c⁄° *c⁄° 
	gx86_powî_Êags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<löux/smp.h
>

2 
	~<löux/timex.h
>

3 
	~<löux/°rög.h
>

4 
	~<löux/£q_fûe.h
>

5 
	~<löux/˝u‰eq.h
>

10 
	$show_˝uöfo_c‹e
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
,

11 
˝u
)

13 #ifde‡
CONFIG_SMP


14 i‡(
c
->
x86_max_c‹es
 * 
smp_num_siblögs
 > 1) {

15 
	`£q_¥ötf
(
m
, "physiˇ»id\t: %d\n", 
c
->
phys_¥oc_id
);

16 
	`£q_¥ötf
(
m
, "siblings\t: %d\n",

17 
	`˝umask_weight
(
	`˝u_c‹e_mask
(
˝u
)));

18 
	`£q_¥ötf
(
m
, "c‹êid\t\t: %d\n", 
c
->
˝u_c‹e_id
);

19 
	`£q_¥ötf
(
m
, "˝u c‹es\t: %d\n", 
c
->
boŸed_c‹es
);

20 
	`£q_¥ötf
(
m
, "≠icid\t\t: %d\n", 
c
->
≠icid
);

21 
	`£q_¥ötf
(
m
, "öôü»≠icid\t: %d\n", 
c
->
öôül_≠icid
);

24 
	}
}

26 #ifde‡
CONFIG_X86_32


27 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

33 
Âu_ex˚±i⁄
 = 
c
->
h¨d_m©h
 && (
ign‹e_Âu_úq
 || 
˝u_has_Âu
);

34 
	`£q_¥ötf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
h…_w‹ks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¨d_m©h
 ? "yes" : "no",

48 
Âu_ex˚±i⁄
 ? "yes" : "no",

49 
c
->
˝uid_Àvñ
,

50 
c
->
wp_w‹ks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

55 
	`£q_¥ötf
(
m
,

60 
c
->
˝uid_Àvñ
);

61 
	}
}

64 
	$show_˝uöfo
(
£q_fûe
 *
m
, *
v
)

66 
˝uöfo_x86
 *
c
 = 
v
;

67 
˝u
 = 0;

68 
i
;

70 #ifde‡
CONFIG_SMP


71 
˝u
 = 
c
->
˝u_ödex
;

73 
	`£q_¥ötf
(
m
, "processor\t: %u\n"

78 
˝u
,

79 
c
->
x86_víd‹_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_modñ
,

82 
c
->
x86_modñ_id
[0] ? c->x86_model_id : "unknown");

84 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

85 
	`£q_¥ötf
(
m
, "°ïpög\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_¥ötf
(
m
, "stepping\t: unknown\n");

89 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
‰eq
 = 
	`˝u‰eq_quick_gë
(
˝u
);

92 i‡(!
‰eq
)

93 
‰eq
 = 
˝u_khz
;

94 
	`£q_¥ötf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
‰eq
 / 1000, (freq % 1000));

99 i‡(
c
->
x86_ˇche_size
 >= 0)

100 
	`£q_¥ötf
(
m
, "ˇchêsize\t: %d KB\n", 
c
->
x86_ˇche_size
);

102 
	`show_˝uöfo_c‹e
(
m
, 
c
, 
˝u
);

103 
	`show_˝uöfo_misc
(
m
, 
c
);

105 
	`£q_¥ötf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 i‡(
	`˝u_has
(
c
, 
i
Ë&& 
x86_ˇp_Êags
[i] !
NULL
)

108 
	`£q_¥ötf
(
m
, " %s", 
x86_ˇp_Êags
[
i
]);

110 
	`£q_¥ötf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
lo›s_≥r_jiffy
/(500000/
HZ
),

112 (
c
->
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100);

114 #ifde‡
CONFIG_X86_64


115 i‡(
c
->
x86_ébsize
 > 0)

116 
	`£q_¥ötf
(
m
, "TLB size\t: %d 4KÖages\n", 
c
->
x86_ébsize
);

118 
	`£q_¥ötf
(
m
, "˛Êush size\t: %u\n", 
c
->
x86_˛Êush_size
);

119 #ifde‡
CONFIG_X86_64


120 
	`£q_¥ötf
(
m
, "ˇche_Æignmít\t: %d\n", 
c
->
x86_ˇche_Æignmít
);

121 
	`£q_¥ötf
(
m
, "address sizes\t: %u bitsÖhysical, %u bits virtual\n",

122 
c
->
x86_phys_bôs
, c->
x86_vút_bôs
);

125 
	`£q_¥ötf
(
m
, "power management:");

126 
i
 = 0; i < 32; i++) {

127 i‡(
c
->
x86_powî
 & (1 << 
i
)) {

128 i‡(
i
 < 
	`ARRAY_SIZE
(
x86_powî_Êags
) &&

129 
x86_powî_Êags
[
i
])

130 
	`£q_¥ötf
(
m
, "%s%s",

131 
x86_powî_Êags
[
i
][0]?" ":"",

132 
x86_powî_Êags
[
i
]);

134 
	`£q_¥ötf
(
m
, " [%d]", 
i
);

138 
	`£q_¥ötf
(
m
, "\n\n");

141 
	}
}

143 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

145 i‡(*
pos
 == 0)

146 *
pos
 = 
	`˝umask_fú°
(
˝u_⁄löe_mask
);

148 *
pos
 = 
	`˝umask_√xt
(*po†- 1, 
˝u_⁄löe_mask
);

149 i‡((*
pos
Ë< 
ƒ_˝u_ids
)

150  &
	`˝u_d©a
(*
pos
);

151  
NULL
;

152 
	}
}

154 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

156 (*
pos
)++;

157  
	`c_°¨t
(
m
, 
pos
);

158 
	}
}

160 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

162 
	}
}

164 c⁄° 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

165 .
°¨t
 = 
c_°¨t
,

166 .
	g√xt
 = 
c_√xt
,

167 .
	g°›
 = 
c_°›
,

168 .
	gshow
 = 
show_˝uöfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<löux/dmi.h
>

25 
	~<asm/div64.h
>

26 
	~<asm/vmw¨e.h
>

28 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

29 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

30 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

32 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

33 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

35 
	#VMWARE_PORT
(
cmd
, 
óx
, 
ebx
, 
ecx
, 
edx
) \

36 
	`__asm__
("inl (%%dx)" : \

37 "˜"(
óx
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

38 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

39 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

40 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

41 "mem‹y");

	)

43 
ölöe
 
	$__vmw¨e_∂©f‹m
()

45 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

46 
	`VMWARE_PORT
(
GETVERSION
, 
óx
, 
ebx
, 
ecx
, 
edx
);

47  
óx
 !(
uöt32_t
)-1 && 
ebx
 =
VMWARE_HYPERVISOR_MAGIC
;

48 
	}
}

50 
	$__vmw¨e_gë_tsc_khz
()

52 
uöt64_t
 
tsc_hz
;

53 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

55 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

57 i‡(
ebx
 =
UINT_MAX
)

59 
tsc_hz
 = 
óx
 | (((
uöt64_t
)
ebx
) << 32);

60 
	`do_div
(
tsc_hz
, 1000);

61 
	`BUG_ON
(
tsc_hz
 >> 32);

62  
tsc_hz
;

63 
	}
}

70 
	$vmw¨e_∂©f‹m
()

72 i‡(
˝u_has_hy≥rvis‹
) {

73 
óx
, 
ebx
, 
ecx
, 
edx
;

74 
hy≥r_víd‹_id
[13];

76 
	`˝uid
(
CPUID_VMWARE_INFO_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

77 
	`mem˝y
(
hy≥r_víd‹_id
 + 0, &
ebx
, 4);

78 
	`mem˝y
(
hy≥r_víd‹_id
 + 4, &
ecx
, 4);

79 
	`mem˝y
(
hy≥r_víd‹_id
 + 8, &
edx
, 4);

80 
hy≥r_víd‹_id
[12] = '\0';

81 i‡(!
	`°rcmp
(
hy≥r_víd‹_id
, "VMwareVMware"))

83 } i‡(
dmi_avaûabÀ
 && 
	`dmi_«me_ö_£rül
("VMware") &&

84 
	`__vmw¨e_∂©f‹m
())

88 
	}
}

90 
	$vmw¨e_gë_tsc_khz
()

92 
	`BUG_ON
(!
	`vmw¨e_∂©f‹m
());

93  
	`__vmw¨e_gë_tsc_khz
();

94 
	}
}

108 
__˝uöô
 
	$vmw¨e_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

110 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

111 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

112 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<löux/moduÀ.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/î∫o.h
>

32 
	~<löux/f˙é.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/smp_lock.h
>

37 
	~<löux/maj‹.h
>

38 
	~<löux/fs.h
>

39 
	~<löux/devi˚.h
>

40 
	~<löux/˝u.h
>

41 
	~<löux/nŸifõr.h
>

42 
	~<löux/uac˚ss.h
>

44 
	~<asm/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/sy°em.h
>

48 
˛ass
 *
	g˝uid_˛ass
;

50 
	s˝uid_ªgs
 {

51 
u32
 
	móx
, 
	mebx
, 
	mecx
, 
	medx
;

54 
	$˝uid_smp_˝uid
(*
cmd_block
)

56 
˝uid_ªgs
 *
cmd
 = (˝uid_ªg†*)
cmd_block
;

58 
	`˝uid_cou¡
(
cmd
->
óx
, cmd->
ecx
,

59 &
cmd
->
óx
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

60 
	}
}

62 
loff_t
 
	$˝uid_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

64 
loff_t
 
ªt
;

65 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

67 
	`muãx_lock
(&
öode
->
i_muãx
);

68 
‹ig
) {

70 
fûe
->
f_pos
 = 
off£t
;

71 
ªt
 = 
fûe
->
f_pos
;

74 
fûe
->
f_pos
 +
off£t
;

75 
ªt
 = 
fûe
->
f_pos
;

78 
ªt
 = -
EINVAL
;

80 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

81  
ªt
;

82 
	}
}

84 
ssize_t
 
	$˝uid_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

85 
size_t
 
cou¡
, 
loff_t
 *
µos
)

87 
__u£r
 *
tmp
 = 
buf
;

88 
˝uid_ªgs
 
cmd
;

89 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

90 
u64
 
pos
 = *
µos
;

91 
ssize_t
 
byãs
 = 0;

92 
îr
 = 0;

94 i‡(
cou¡
 % 16)

95  -
EINVAL
;

97 ; 
cou¡
; count -= 16) {

98 
cmd
.
óx
 = 
pos
;

99 
cmd
.
ecx
 = 
pos
 >> 32;

100 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝uid_smp_˝uid
, &
cmd
, 1);

101 i‡(
îr
)

103 i‡(
	`c›y_to_u£r
(
tmp
, &
cmd
, 16)) {

104 
îr
 = -
EFAULT
;

107 
tmp
 += 16;

108 
byãs
 += 16;

109 *
µos
 = ++
pos
;

112  
byãs
 ? byã†: 
îr
;

113 
	}
}

115 
	$˝uid_›í
(
öode
 *öode, 
fûe
 *file)

117 
˝u
;

118 
˝uöfo_x86
 *
c
;

119 
ªt
 = 0;

121 
	`lock_kî√l
();

123 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

124 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu)) {

125 
ªt
 = -
ENXIO
;

126 
out
;

128 
c
 = &
	`˝u_d©a
(
˝u
);

129 i‡(
c
->
˝uid_Àvñ
 < 0)

130 
ªt
 = -
EIO
;

131 
out
:

132 
	`u∆ock_kî√l
();

133  
ªt
;

134 
	}
}

139 c⁄° 
fûe_›î©i⁄s
 
	g˝uid_f›s
 = {

140 .
ow√r
 = 
THIS_MODULE
,

141 .
	gŒ£ek
 = 
˝uid_£ek
,

142 .
	gªad
 = 
˝uid_ªad
,

143 .
	g›í
 = 
˝uid_›í
,

146 
__˝uöô
 
	$˝uid_devi˚_¸óã
(
˝u
)

148 
devi˚
 *
dev
;

150 
dev
 = 
	`devi˚_¸óã
(
˝uid_˛ass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
), NULL,

151 "˝u%d", 
˝u
);

152  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

153 
	}
}

155 
	$˝uid_devi˚_de°roy
(
˝u
)

157 
	`devi˚_de°roy
(
˝uid_˛ass
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
));

158 
	}
}

160 
__˝uöô
 
	$˝uid_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

161 
a˘i⁄
,

162 *
h˝u
)

164 
˝u
 = ()
h˝u
;

165 
îr
 = 0;

167 
a˘i⁄
) {

168 
CPU_UP_PREPARE
:

169 
îr
 = 
	`˝uid_devi˚_¸óã
(
˝u
);

171 
CPU_UP_CANCELED
:

172 
CPU_UP_CANCELED_FROZEN
:

173 
CPU_DEAD
:

174 
	`˝uid_devi˚_de°roy
(
˝u
);

177  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

178 
	}
}

180 
nŸifõr_block
 
__ªfd©a
 
	g˝uid_˛ass_˝u_nŸifõr
 =

182 .
nŸifõr_ˇŒ
 = 
˝uid_˛ass_˝u_ˇŒback
,

185 *
	$˝uid_nodíame
(
devi˚
 *
dev
)

187  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/˝uid", 
	`MINOR
(
dev
->
devt
));

188 
	}
}

190 
__öô
 
	$˝uid_öô
()

192 
i
, 
îr
 = 0;

193 
i
 = 0;

195 i‡(
	`ªgi°î_chrdev
(
CPUID_MAJOR
, "˝u/˝uid", &
˝uid_f›s
)) {

196 
	`¥ötk
(
KERN_ERR
 "cpuid: unableÅo get major %d for cpuid\n",

197 
CPUID_MAJOR
);

198 
îr
 = -
EBUSY
;

199 
out
;

201 
˝uid_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "cpuid");

202 i‡(
	`IS_ERR
(
˝uid_˛ass
)) {

203 
îr
 = 
	`PTR_ERR
(
˝uid_˛ass
);

204 
out_chrdev
;

206 
˝uid_˛ass
->
nodíame
 = 
˝uid_nodíame
;

207 
	`f‹_óch_⁄löe_˝u
(
i
) {

208 
îr
 = 
	`˝uid_devi˚_¸óã
(
i
);

209 i‡(
îr
 != 0)

210 
out_˛ass
;

212 
	`ªgi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

214 
îr
 = 0;

215 
out
;

217 
out_˛ass
:

218 
i
 = 0;

219 
	`f‹_óch_⁄löe_˝u
(
i
) {

220 
	`˝uid_devi˚_de°roy
(
i
);

222 
	`˛ass_de°roy
(
˝uid_˛ass
);

223 
out_chrdev
:

224 
	`uƒegi°î_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

225 
out
:

226  
îr
;

227 
	}
}

229 
__exô
 
	$˝uid_exô
()

231 
˝u
 = 0;

233 
	`f‹_óch_⁄löe_˝u
(
˝u
)

234 
	`˝uid_devi˚_de°roy
(
˝u
);

235 
	`˛ass_de°roy
(
˝uid_˛ass
);

236 
	`uƒegi°î_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

237 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

238 
	}
}

240 
moduÀ_öô
(
˝uid_öô
);

241 
moduÀ_exô
(
˝uid_exô
);

243 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

244 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

245 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<löux/öô.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/ªboŸ.h
>

15 
	~<löux/kexec.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/ñfc‹e.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/h¨dúq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_úq.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/h≥t.h
>

26 
	~<löux/kdebug.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ªboŸ.h
>

29 
	~<asm/vúãxt.h
>

30 
	~<asm/iommu.h
>

33 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

35 
	$kdump_nmi_ˇŒback
(
˝u
, 
dõ_¨gs
 *
¨gs
)

37 
±_ªgs
 *
ªgs
;

38 #ifde‡
CONFIG_X86_32


39 
±_ªgs
 
fixed_ªgs
;

42 
ªgs
 = 
¨gs
->regs;

44 #ifde‡
CONFIG_X86_32


45 i‡(!
	`u£r_mode_vm
(
ªgs
)) {

46 
	`¸ash_fixup_ss_e•
(&
fixed_ªgs
, 
ªgs
);

47 
ªgs
 = &
fixed_ªgs
;

50 
	`¸ash_ßve_˝u
(
ªgs
, 
˝u
);

58 
	`˝u_emîgícy_vmxoff
();

59 
	`˝u_emîgícy_svm_dißbÀ
();

61 
	`dißbÀ_loˇl_APIC
();

62 
	}
}

64 
	$kdump_nmi_shoŸdown_˝us
()

66 
	`nmi_shoŸdown_˝us
(
kdump_nmi_ˇŒback
);

68 
	`dißbÀ_loˇl_APIC
();

69 
	}
}

72 
	$kdump_nmi_shoŸdown_˝us
()

75 
	}
}

78 
	$«tive_machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

89 
	`loˇl_úq_dißbÀ
();

91 
	`kdump_nmi_shoŸdown_˝us
();

97 
	`˝u_emîgícy_vmxoff
();

98 
	`˝u_emîgícy_svm_dißbÀ
();

100 
	`œpic_shutdown
();

101 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

102 
	`dißbÀ_IO_APIC
();

104 #ifde‡
CONFIG_HPET_TIMER


105 
	`h≥t_dißbÀ
();

108 #ifde‡
CONFIG_X86_64


109 
	`pci_iommu_shutdown
();

112 
	`¸ash_ßve_˝u
(
ªgs
, 
	`ß„_smp_¥o˚ss‹_id
());

113 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/io.h
>

14 
	gñfc‹ehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$c›y_ﬁdmem_∑ge
(
p‚
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 i‡(!
csize
)

37 
vaddr
 = 
	`i‹em≠
(
p‚
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 i‡(!
vaddr
)

39  -
ENOMEM
;

41 i‡(
u£rbuf
) {

42 i‡(
	`c›y_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm≠
(
vaddr
);

44  -
EFAULT
;

47 
	`mem˝y
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm≠
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/·ø˚.h
>

14 
	~<löux/kexec.h
>

15 
	~<löux/bug.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/sysfs.h
>

18 
	~<löux/·ø˚.h
>

20 
	~<asm/°ackåa˚.h
>

22 
	~"dump°ack.h
"

24 
	g∑nic_⁄_uƒecovîed_nmi
;

25 
	g∑nic_⁄_io_nmi
;

26 
	gcode_byãs
 = 64;

27 
	gk°ack_dïth_to_¥öt
 = 3 * 
STACKSLOTS_PER_LINE
;

28 
	gdõ_cou¡î
;

30 
	$¥ötk_addªss
(
addªss
, 
ªlübÀ
)

32 
	`¥ötk
(" [<%p>] %s%pS\n", (*Ë
addªss
,

33 
ªlübÀ
 ? "" : "? ", (*Ë
addªss
);

34 
	}
}

36 #ifde‡
CONFIG_FUNCTION_GRAPH_TRACER


38 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

39 c⁄° 
°ackåa˚_›s
 *
›s
,

40 
thªad_öfo
 *
töfo
, *
gøph
)

42 
èsk_°ru˘
 *
èsk
 = 
töfo
->task;

43 
ªt_addr
;

44 
ödex
 = 
èsk
->
cuº_ªt_°ack
;

46 i‡(
addr
 !()
ªtu∫_to_h™dÀr
)

49 i‡(!
èsk
->
ªt_°ack
 || 
ödex
 < *
gøph
)

52 
ödex
 -*
gøph
;

53 
ªt_addr
 = 
èsk
->
ªt_°ack
[
ödex
].
ªt
;

55 
›s
->
	`addªss
(
d©a
, 
ªt_addr
, 1);

57 (*
gøph
)++;

58 
	}
}

60 
ölöe
 

61 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

62 c⁄° 
°ackåa˚_›s
 *
›s
,

63 
thªad_öfo
 *
töfo
, *
gøph
)

64 { 
	}
}

74 
ölöe
 
	$vÆid_°ack_±r
(
thªad_öfo
 *
töfo
,

75 *
p
, 
size
, *
íd
)

77 *
t
 = 
töfo
;

78 i‡(
íd
) {

79 i‡(
p
 < 
íd
 &&Ö >”nd-
THREAD_SIZE
))

84  
p
 > 
t
 &&Ö <Å + 
THREAD_SIZE
 - 
size
;

85 
	}
}

88 
	$¥öt_c⁄ãxt_°ack
(
thªad_öfo
 *
töfo
,

89 *
°ack
, 
bp
,

90 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

91 *
íd
, *
gøph
)

93 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

95 
	`vÆid_°ack_±r
(
töfo
, 
°ack
, (*°ack), 
íd
)) {

96 
addr
;

98 
addr
 = *
°ack
;

99 i‡(
	`__kî√l_ãxt_addªss
(
addr
)) {

100 i‡((Ë
°ack
 =
bp
 + ()) {

101 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

102 
‰ame
 = føme->
√xt_‰ame
;

103 
bp
 = (Ë
‰ame
;

105 
›s
->
	`addªss
(
d©a
, 
addr
, 0);

107 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

109 
°ack
++;

111  
bp
;

112 
	}
}

116 
	$¥öt_åa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

118 
	`¥ötk
(
d©a
);

119 
	`¥öt_symbﬁ
(
msg
, 
symbﬁ
);

120 
	`¥ötk
("\n");

121 
	}
}

123 
	$¥öt_åa˚_w¨nög
(*
d©a
, *
msg
)

125 
	`¥ötk
("%s%s\n", (*)
d©a
, 
msg
);

126 
	}
}

128 
	$¥öt_åa˚_°ack
(*
d©a
, *
«me
)

130 
	`¥ötk
("%†<%s> ", (*)
d©a
, 
«me
);

132 
	}
}

137 
	$¥öt_åa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

139 
	`touch_nmi_w©chdog
();

140 
	`¥ötk
(
d©a
);

141 
	`¥ötk_addªss
(
addr
, 
ªlübÀ
);

142 
	}
}

144 c⁄° 
°ackåa˚_›s
 
	g¥öt_åa˚_›s
 = {

145 .
w¨nög
 = 
¥öt_åa˚_w¨nög
,

146 .
	gw¨nög_symbﬁ
 = 
¥öt_åa˚_w¨nög_symbﬁ
,

147 .
	g°ack
 = 
¥öt_åa˚_°ack
,

148 .
	gaddªss
 = 
¥öt_åa˚_addªss
,

152 
	$show_åa˚_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

153 *
°ack
, 
bp
, *
log_lvl
)

155 
	`¥ötk
("%sCÆ»Tø˚:\n", 
log_lvl
);

156 
	`dump_åa˚
(
èsk
, 
ªgs
, 
°ack
, 
bp
, &
¥öt_åa˚_›s
, 
log_lvl
);

157 
	}
}

159 
	$show_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

160 *
°ack
, 
bp
)

162 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
°ack
, 
bp
, "");

163 
	}
}

165 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

167 
	`show_°ack_log_lvl
(
èsk
, 
NULL
, 
•
, 0, "");

168 
	}
}

173 
	$dump_°ack
()

175 
bp
 = 0;

176 
°ack
;

178 #ifde‡
CONFIG_FRAME_POINTER


179 i‡(!
bp
)

180 
	`gë_bp
(
bp
);

183 
	`¥ötk
("Pid: %d, comm: %.20s %s %s %.*s\n",

184 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

185 
	`öô_ut¢ame
()->
ªÀa£
,

186 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

187 
	`öô_ut¢ame
()->
vîsi⁄
);

188 
	`show_åa˚
(
NULL
, NULL, &
°ack
, 
bp
);

189 
	}
}

190 
EXPORT_SYMBOL
(
dump_°ack
);

192 
øw_•ölock_t
 
	gdõ_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

193 
	gdõ_ow√r
 = -1;

194 
	gdõ_√°_cou¡
;

196 
__k¥obes
 
	$o›s_begö
()

198 
˝u
;

199 
Êags
;

204 
	`åa˚_hw_bønch_o›s
();

206 
	`o›s_íãr
();

209 
	`øw_loˇl_úq_ßve
(
Êags
);

210 
˝u
 = 
	`smp_¥o˚ss‹_id
();

211 i‡(!
	`__øw_•ö_åylock
(&
dõ_lock
)) {

212 i‡(
˝u
 =
dõ_ow√r
)

215 
	`__øw_•ö_lock
(&
dõ_lock
);

217 
dõ_√°_cou¡
++;

218 
dõ_ow√r
 = 
˝u
;

219 
	`c⁄sﬁe_vîbo£
();

220 
	`bu°_•ölocks
(1);

221  
Êags
;

222 
	}
}

224 
__k¥obes
 
	$o›s_íd
(
Êags
, 
±_ªgs
 *
ªgs
, 
sigƒ
)

226 i‡(
ªgs
 && 
	`kexec_should_¸ash
(
cuºít
))

227 
	`¸ash_kexec
(
ªgs
);

229 
	`bu°_•ölocks
(0);

230 
dõ_ow√r
 = -1;

231 
	`add_èöt
(
TAINT_DIE
);

232 
dõ_√°_cou¡
--;

233 i‡(!
dõ_√°_cou¡
)

235 
	`__øw_•ö_u∆ock
(&
dõ_lock
);

236 
	`øw_loˇl_úq_ª°‹e
(
Êags
);

237 
	`o›s_exô
();

239 i‡(!
sigƒ
)

241 i‡(
	`ö_öãºu±
())

242 
	`∑nic
("FatalÉxception in interrupt");

243 i‡(
∑nic_⁄_o›s
)

244 
	`∑nic
("FatalÉxception");

245 
	`do_exô
(
sigƒ
);

246 
	}
}

248 
__k¥obes
 
	$__dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

250 #ifde‡
CONFIG_X86_32


251 
ss
;

252 
•
;

254 
	`¥ötk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
°r
, 
îr
 & 0xffff, ++
dõ_cou¡î
);

255 #ifde‡
CONFIG_PREEMPT


256 
	`¥ötk
("PREEMPT ");

258 #ifde‡
CONFIG_SMP


259 
	`¥ötk
("SMP ");

261 #ifde‡
CONFIG_DEBUG_PAGEALLOC


262 
	`¥ötk
("DEBUG_PAGEALLOC");

264 
	`¥ötk
("\n");

265 
	`sysfs_¥ötk_œ°_fûe
();

266 i‡(
	`nŸify_dõ
(
DIE_OOPS
, 
°r
, 
ªgs
, 
îr
,

267 
cuºít
->
thªad
.
å≠_no
, 
SIGSEGV
Ë=
NOTIFY_STOP
)

270 
	`show_ªgi°îs
(
ªgs
);

271 #ifde‡
CONFIG_X86_32


272 
•
 = (Ë(&
ªgs
->sp);

273 
	`ßve£gmít
(
ss
, ss);

274 i‡(
	`u£r_mode
(
ªgs
)) {

275 
•
 = 
ªgs
->sp;

276 
ss
 = 
ªgs
->ss & 0xffff;

278 
	`¥ötk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
ªgs
->
ù
);

279 
	`¥öt_symbﬁ
("%s", 
ªgs
->
ù
);

280 
	`¥ötk
(" SS:ESP %04x:%08lx\n", 
ss
, 
•
);

283 
	`¥ötk
(
KERN_ALERT
 "RIP ");

284 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

285 
	`¥ötk
(" RSP <%016lx>\n", 
ªgs
->
•
);

288 
	}
}

294 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

296 
Êags
 = 
	`o›s_begö
();

297 
sig
 = 
SIGSEGV
;

299 i‡(!
	`u£r_mode_vm
(
ªgs
))

300 
	`ªp‹t_bug
(
ªgs
->
ù
,Ñegs);

302 i‡(
	`__dõ
(
°r
, 
ªgs
, 
îr
))

303 
sig
 = 0;

304 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

305 
	}
}

307 
nŸø˚
 
__k¥obes


308 
	$dõ_nmi
(*
°r
, 
±_ªgs
 *
ªgs
, 
do_∑nic
)

310 
Êags
;

312 i‡(
	`nŸify_dõ
(
DIE_NMIWATCHDOG
, 
°r
, 
ªgs
, 0, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

319 
Êags
 = 
	`o›s_begö
();

320 
	`¥ötk
(
KERN_EMERG
 "%s", 
°r
);

321 
	`¥ötk
(" on CPU%d, ip %08lx,Ñegisters:\n",

322 
	`smp_¥o˚ss‹_id
(), 
ªgs
->
ù
);

323 
	`show_ªgi°îs
(
ªgs
);

324 
	`o›s_íd
(
Êags
, 
ªgs
, 0);

325 i‡(
do_∑nic
 || 
∑nic_⁄_o›s
)

326 
	`∑nic
("Non maskable interrupt");

327 
	`nmi_exô
();

328 
	`loˇl_úq_íabÀ
();

329 
	`do_exô
(
SIGBUS
);

330 
	}
}

332 
__öô
 
	$o›s_£tup
(*
s
)

334 i‡(!
s
)

335  -
EINVAL
;

336 i‡(!
	`°rcmp
(
s
, "panic"))

337 
∑nic_⁄_o›s
 = 1;

339 
	}
}

340 
óæy_∑øm
("o›s", 
o›s_£tup
);

342 
__öô
 
	$k°ack_£tup
(*
s
)

344 i‡(!
s
)

345  -
EINVAL
;

346 
k°ack_dïth_to_¥öt
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

348 
	}
}

349 
óæy_∑øm
("k°ack", 
k°ack_£tup
);

351 
__öô
 
	$code_byãs_£tup
(*
s
)

353 
code_byãs
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

354 i‡(
code_byãs
 > 8192)

355 
code_byãs
 = 8192;

358 
	}
}

359 
__£tup
("code_byãs=", 
code_byãs_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/kexec.h
>

14 
	~<löux/bug.h
>

15 
	~<löux/nmi.h
>

16 
	~<löux/sysfs.h
>

18 
	~<asm/°ackåa˚.h
>

20 
	~"dump°ack.h
"

23 
	gx86_°ack_ids
[][8] = {

24 [
DEBUG_STACK
 - 1] = "#DB",

25 [
NMI_STACK
 - 1] = "NMI",

26 [
DOUBLEFAULT_STACK
 - 1] = "#DF",

27 [
STACKFAULT_STACK
 - 1] = "#SS",

28 [
MCE_STACK
 - 1] = "#MC",

29 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


30 [
N_EXCEPTION_STACKS
 ...

31 
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
 / 
EXCEPTION_STKSZ
 - 2] = "#DB[?]"

35 
	$x86_is_°ack_id
(
id
, *
«me
)

37  
x86_°ack_ids
[
id
 - 1] =
«me
;

38 
	}
}

40 *
	$ö_ex˚±i⁄_°ack
(
˝u
, 
°ack
,

41 *
u£dp
, **
idp
)

43 
k
;

49 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

50 
íd
 = 
	`≥r_˝u
(
‹ig_i°
, 
˝u
).
i°
[
k
];

55 i‡(
°ack
 >
íd
)

61 i‡(
°ack
 >
íd
 - 
EXCEPTION_STKSZ
) {

68 i‡(*
u£dp
 & (1U << 
k
))

70 *
u£dp
 |1U << 
k
;

71 *
idp
 = 
x86_°ack_ids
[
k
];

72  (*)
íd
;

79 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


80 i‡(
k
 =
DEBUG_STACK
 - 1 && 
°ack
 >
íd
 - 
DEBUG_STKSZ
) {

81 
j
 = 
N_EXCEPTION_STACKS
 - 1;

89 ++
j
;

90 
íd
 -
EXCEPTION_STKSZ
;

91 
x86_°ack_ids
[
j
][4] = '1' +

92 (
j
 - 
N_EXCEPTION_STACKS
);

93 } 
°ack
 < 
íd
 - 
EXCEPTION_STKSZ
);

94 i‡(*
u£dp
 & (1U << 
j
))

96 *
u£dp
 |1U << 
j
;

97 *
idp
 = 
x86_°ack_ids
[
j
];

98  (*)
íd
;

102  
NULL
;

103 
	}
}

112 
	$dump_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

113 *
°ack
, 
bp
,

114 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
)

116 c⁄° 
˝u
 = 
	`gë_˝u
();

117 *
úq_°ack_íd
 =

118 (*)
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
);

119 
u£d
 = 0;

120 
thªad_öfo
 *
töfo
;

121 
gøph
 = 0;

123 i‡(!
èsk
)

124 
èsk
 = 
cuºít
;

126 i‡(!
°ack
) {

127 
dummy
;

128 
°ack
 = &
dummy
;

129 i‡(
èsk
 &&Åask !
cuºít
)

130 
°ack
 = (*)
èsk
->
thªad
.
•
;

133 #ifde‡
CONFIG_FRAME_POINTER


134 i‡(!
bp
) {

135 i‡(
èsk
 =
cuºít
) {

137 
	`gë_bp
(
bp
);

140 
bp
 = *(*Ë
èsk
->
thªad
.
•
;

150 
töfo
 = 
	`èsk_thªad_öfo
(
èsk
);

152 *
id
;

153 *
e°ack_íd
;

154 
e°ack_íd
 = 
	`ö_ex˚±i⁄_°ack
(
˝u
, ()
°ack
,

155 &
u£d
, &
id
);

157 i‡(
e°ack_íd
) {

158 i‡(
›s
->
	`°ack
(
d©a
, 
id
) < 0)

161 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp, 
›s
,

162 
d©a
, 
e°ack_íd
, &
gøph
);

163 
›s
->
	`°ack
(
d©a
, "<EOE>");

169 
°ack
 = (*Ë
e°ack_íd
[-2];

172 i‡(
úq_°ack_íd
) {

173 *
úq_°ack
;

174 
úq_°ack
 = 
úq_°ack_íd
 -

175 (
IRQ_STACK_SIZE
 - 64Ë/ (*
úq_°ack
);

177 i‡(
°ack
 >
úq_°ack
 && sèck < 
úq_°ack_íd
) {

178 i‡(
›s
->
	`°ack
(
d©a
, "IRQ") < 0)

180 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp,

181 
›s
, 
d©a
, 
úq_°ack_íd
, &
gøph
);

187 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

188 
úq_°ack_íd
 = 
NULL
;

189 
›s
->
	`°ack
(
d©a
, "EOI");

199 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp, 
›s
, 
d©a
, 
NULL
, &
gøph
);

200 
	`put_˝u
();

201 
	}
}

202 
EXPORT_SYMBOL
(
dump_åa˚
);

205 
	$show_°ack_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

206 *
•
, 
bp
, *
log_lvl
)

208 *
°ack
;

209 
i
;

210 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

211 *
úq_°ack_íd
 =

212 (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
));

213 *
úq_°ack
 =

214 (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
Ë- 
IRQ_STACK_SIZE
);

221 i‡(
•
 =
NULL
) {

222 i‡(
èsk
)

223 
•
 = (*)
èsk
->
thªad
.sp;

225 
•
 = (*)&sp;

228 
°ack
 = 
•
;

229 
i
 = 0; i < 
k°ack_dïth_to_¥öt
; i++) {

230 i‡(
°ack
 >
úq_°ack
 && sèck <
úq_°ack_íd
) {

231 i‡(
°ack
 =
úq_°ack_íd
) {

232 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

233 
	`¥ötk
(" <EOI> ");

236 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

239 i‡(
i
 && ((ò% 
STACKSLOTS_PER_LINE
) == 0))

240 
	`¥ötk
("\n%s", 
log_lvl
);

241 
	`¥ötk
(" %016lx", *
°ack
++);

242 
	`touch_nmi_w©chdog
();

244 
	`¥ötk
("\n");

245 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
•
, 
bp
, 
log_lvl
);

246 
	}
}

248 
	$show_ªgi°îs
(
±_ªgs
 *
ªgs
)

250 
i
;

251 
•
;

252 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

253 
èsk_°ru˘
 *
cur
 = 
cuºít
;

255 
•
 = 
ªgs
->sp;

256 
	`¥ötk
("CPU %d ", 
˝u
);

257 
	`__show_ªgs
(
ªgs
, 1);

258 
	`¥ötk
("Process %s (pid: %d,Åhreadinfo %p,Åask %p)\n",

259 
cur
->
comm
, cur->
pid
, 
	`èsk_thªad_öfo
(cur), cur);

265 i‡(!
	`u£r_mode
(
ªgs
)) {

266 
code_¥ﬁogue
 = 
code_byãs
 * 43 / 64;

267 
code_Àn
 = 
code_byãs
;

268 
c
;

269 
u8
 *
ù
;

271 
	`¥ötk
(
KERN_EMERG
 "Stack:\n");

272 
	`show_°ack_log_lvl
(
NULL
, 
ªgs
, (*)
•
,

273 
ªgs
->
bp
, 
KERN_EMERG
);

275 
	`¥ötk
(
KERN_EMERG
 "Code: ");

277 
ù
 = (
u8
 *)
ªgs
->ù - 
code_¥ﬁogue
;

278 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 || 
	`¥obe_kî√l_addªss
(ù, 
c
)) {

280 
ù
 = (
u8
 *)
ªgs
->ip;

281 
code_Àn
 = code_À¿- 
code_¥ﬁogue
 + 1;

283 
i
 = 0; i < 
code_Àn
; i++, 
ù
++) {

284 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 ||

285 
	`¥obe_kî√l_addªss
(
ù
, 
c
)) {

286 
	`¥ötk
(" Bad RIP value.");

289 i‡(
ù
 =(
u8
 *)
ªgs
->ip)

290 
	`¥ötk
("<%02x> ", 
c
);

292 
	`¥ötk
("%02x ", 
c
);

295 
	`¥ötk
("\n");

296 
	}
}

298 
	$is_vÆid_bugaddr
(
ù
)

300 
ud2
;

302 i‡(
	`__c›y_‰om_u£r
(&
ud2
, (c⁄° 
__u£r
 *Ë
ù
, (ud2)))

305  
ud2
 == 0x0b0f;

306 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/boŸmem.h
>

15 
	~<löux/i›‹t.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/kexec.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/p‚.h
>

21 
	~<löux/su•íd.h
>

22 
	~<löux/fúmw¨e-m≠.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/∑ge.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/¥Ÿo.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/åampﬁöe.h
>

45 
e820m≠
 
	ge820
;

46 
e820m≠
 
	ge820_ßved
;

49 
	gpci_mem_°¨t
 = 0xaeedbabe;

50 #ifde‡
CONFIG_PCI


51 
EXPORT_SYMBOL
(
pci_mem_°¨t
);

59 
	$e820_™y_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

61 
i
;

63 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

64 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

66 i‡(
ty≥
 && 
ei
->type !=Åype)

68 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

73 
	}
}

74 
EXPORT_SYMBOL_GPL
(
e820_™y_m≠≥d
);

82 
__öô
 
	$e820_Æl_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

84 
i
;

86 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

87 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

89 i‡(
ty≥
 && 
ei
->type !=Åype)

92 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

98 i‡(
ei
->
addr
 <
°¨t
)

99 
°¨t
 = 
ei
->
addr
 +Éi->
size
;

104 i‡(
°¨t
 >
íd
)

108 
	}
}

113 
__öô
 
	$__e820_add_ªgi⁄
(
e820m≠
 *
e820x
, 
u64
 
°¨t
, u64 
size
,

114 
ty≥
)

116 
x
 = 
e820x
->
ƒ_m≠
;

118 i‡(
x
 =
	`ARRAY_SIZE
(
e820x
->
m≠
)) {

119 
	`¥ötk
(
KERN_ERR
 "Ooops! Too manyÉntries inÅhe memory map!\n");

123 
e820x
->
m≠
[
x
].
addr
 = 
°¨t
;

124 
e820x
->
m≠
[
x
].
size
 = size;

125 
e820x
->
m≠
[
x
].
ty≥
 =Åype;

126 
e820x
->
ƒ_m≠
++;

127 
	}
}

129 
__öô
 
	$e820_add_ªgi⁄
(
u64
 
°¨t
, u64 
size
, 
ty≥
)

131 
	`__e820_add_ªgi⁄
(&
e820
, 
°¨t
, 
size
, 
ty≥
);

132 
	}
}

134 
__öô
 
	$e820_¥öt_ty≥
(
u32
 
ty≥
)

136 
ty≥
) {

137 
E820_RAM
:

138 
E820_RESERVED_KERN
:

139 
	`¥ötk
(
KERN_CONT
 "(usable)");

141 
E820_RESERVED
:

142 
	`¥ötk
(
KERN_CONT
 "(reserved)");

144 
E820_ACPI
:

145 
	`¥ötk
(
KERN_CONT
 "(ACPI data)");

147 
E820_NVS
:

148 
	`¥ötk
(
KERN_CONT
 "(ACPI NVS)");

150 
E820_UNUSABLE
:

151 
	`¥ötk
(
KERN_CONT
 "(unusable)");

154 
	`¥ötk
(
KERN_CONT
 "ty≥ %u", 
ty≥
);

157 
	}
}

159 
__öô
 
	$e820_¥öt_m≠
(*
who
)

161 
i
;

163 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

164 
	`¥ötk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

165 (Ë
e820
.
m≠
[
i
].
addr
,

167 (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
));

168 
	`e820_¥öt_ty≥
(
e820
.
m≠
[
i
].
ty≥
);

169 
	`¥ötk
(
KERN_CONT
 "\n");

171 
	}
}

235 
__öô
 
	$ßnôize_e820_m≠
(
e820íåy
 *
biosm≠
, 
max_ƒ_m≠
,

236 
u32
 *
≤r_m≠
)

238 
	sch™ge_membî
 {

239 
e820íåy
 *
pbios
;

240 
addr
;

242 
ch™ge_membî
 
ch™ge_poöt_li°
[2*
E820_X_MAX
] 
__öôd©a
;

243 
ch™ge_membî
 *
ch™ge_poöt
[2*
E820_X_MAX
] 
__öôd©a
;

244 
e820íåy
 *
ovîœp_li°
[
E820_X_MAX
] 
__öôd©a
;

245 
e820íåy
 
√w_bios
[
E820_X_MAX
] 
__öôd©a
;

246 
ch™ge_membî
 *
ch™ge_tmp
;

247 
cuºít_ty≥
, 
œ°_ty≥
;

248 
œ°_addr
;

249 
chgidx
, 
°ûl_ch™gög
;

250 
ovîœp_íåõs
;

251 
√w_bios_íåy
;

252 
ﬁd_ƒ
, 
√w_ƒ
, 
chg_ƒ
;

253 
i
;

256 i‡(*
≤r_m≠
 < 2)

259 
ﬁd_ƒ
 = *
≤r_m≠
;

260 
	`BUG_ON
(
ﬁd_ƒ
 > 
max_ƒ_m≠
);

263 
i
 = 0; i < 
ﬁd_ƒ
; i++)

264 i‡(
biosm≠
[
i
].
addr
 + biosm≠[i].
size
 < biosmap[i].addr)

268 
i
 = 0; i < 2 * 
ﬁd_ƒ
; i++)

269 
ch™ge_poöt
[
i
] = &
ch™ge_poöt_li°
[i];

273 
chgidx
 = 0;

274 
i
 = 0; i < 
ﬁd_ƒ
; i++) {

275 i‡(
biosm≠
[
i
].
size
 != 0) {

276 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr;

277 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

278 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr +

279 
biosm≠
[
i
].
size
;

280 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

283 
chg_ƒ
 = 
chgidx
;

286 
°ûl_ch™gög
 = 1;

287 
°ûl_ch™gög
) {

288 
°ûl_ch™gög
 = 0;

289 
i
 = 1; i < 
chg_ƒ
; i++) {

290 
cuøddr
, 
œ°addr
;

291 
cuΩbaddr
, 
œ°pbaddr
;

293 
cuøddr
 = 
ch™ge_poöt
[
i
]->
addr
;

294 
œ°addr
 = 
ch™ge_poöt
[
i
 - 1]->
addr
;

295 
cuΩbaddr
 = 
ch™ge_poöt
[
i
]->
pbios
->
addr
;

296 
œ°pbaddr
 = 
ch™ge_poöt
[
i
 - 1]->
pbios
->
addr
;

305 i‡(
cuøddr
 < 
œ°addr
 ||

306 (
cuøddr
 =
œ°addr
 && cuødd∏=
cuΩbaddr
 &&

307 
œ°addr
 !
œ°pbaddr
)) {

308 
ch™ge_tmp
 = 
ch™ge_poöt
[
i
];

309 
ch™ge_poöt
[
i
] = change_point[i-1];

310 
ch™ge_poöt
[
i
-1] = 
ch™ge_tmp
;

311 
°ûl_ch™gög
 = 1;

317 
ovîœp_íåõs
 = 0;

318 
√w_bios_íåy
 = 0;

319 
œ°_ty≥
 = 0;

320 
œ°_addr
 = 0;

323 
chgidx
 = 0; chgidx < 
chg_ƒ
; chgidx++) {

325 i‡(
ch™ge_poöt
[
chgidx
]->
addr
 ==

326 
ch™ge_poöt
[
chgidx
]->
pbios
->
addr
) {

331 
ovîœp_li°
[
ovîœp_íåõs
++] =

332 
ch™ge_poöt
[
chgidx
]->
pbios
;

338 
i
 = 0; i < 
ovîœp_íåõs
; i++) {

339 i‡(
ovîœp_li°
[
i
] ==

340 
ch™ge_poöt
[
chgidx
]->
pbios
)

341 
ovîœp_li°
[
i
] =

342 
ovîœp_li°
[
ovîœp_íåõs
-1];

344 
ovîœp_íåõs
--;

351 
cuºít_ty≥
 = 0;

352 
i
 = 0; i < 
ovîœp_íåõs
; i++)

353 i‡(
ovîœp_li°
[
i
]->
ty≥
 > 
cuºít_ty≥
)

354 
cuºít_ty≥
 = 
ovîœp_li°
[
i
]->
ty≥
;

359 i‡(
cuºít_ty≥
 !
œ°_ty≥
) {

360 i‡(
œ°_ty≥
 != 0) {

361 
√w_bios
[
√w_bios_íåy
].
size
 =

362 
ch™ge_poöt
[
chgidx
]->
addr
 - 
œ°_addr
;

367 i‡(
√w_bios
[
√w_bios_íåy
].
size
 != 0)

372 i‡(++
√w_bios_íåy
 >
max_ƒ_m≠
)

375 i‡(
cuºít_ty≥
 != 0) {

376 
√w_bios
[
√w_bios_íåy
].
addr
 =

377 
ch™ge_poöt
[
chgidx
]->
addr
;

378 
√w_bios
[
√w_bios_íåy
].
ty≥
 = 
cuºít_ty≥
;

379 
œ°_addr
 = 
ch™ge_poöt
[
chgidx
]->
addr
;

381 
œ°_ty≥
 = 
cuºít_ty≥
;

385 
√w_ƒ
 = 
√w_bios_íåy
;

388 
	`mem˝y
(
biosm≠
, 
√w_bios
, 
√w_ƒ
 * (
e820íåy
));

389 *
≤r_m≠
 = 
√w_ƒ
;

392 
	}
}

394 
__öô
 
	$__≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

396 
ƒ_m≠
) {

397 
u64
 
°¨t
 = 
biosm≠
->
addr
;

398 
u64
 
size
 = 
biosm≠
->size;

399 
u64
 
íd
 = 
°¨t
 + 
size
;

400 
u32
 
ty≥
 = 
biosm≠
->type;

403 i‡(
°¨t
 > 
íd
)

406 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
ty≥
);

408 
biosm≠
++;

409 
ƒ_m≠
--;

412 
	}
}

423 
__öô
 
	$≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

426 i‡(
ƒ_m≠
 < 2)

429  
	`__≠≥nd_e820_m≠
(
biosm≠
, 
ƒ_m≠
);

430 
	}
}

432 
u64
 
__öô
 
	$__e820_upd©e_ønge
(
e820m≠
 *
e820x
, 
u64
 
°¨t
,

433 
u64
 
size
, 
ﬁd_ty≥
,

434 
√w_ty≥
)

436 
u64
 
íd
;

437 
i
;

438 
u64
 
ªÆ_upd©ed_size
 = 0;

440 
	`BUG_ON
(
ﬁd_ty≥
 =
√w_ty≥
);

442 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

443 
size
 = 
ULLONG_MAX
 - 
°¨t
;

445 
íd
 = 
°¨t
 + 
size
;

446 
	`¥ötk
(
KERN_DEBUG
 "e820 updateÑange: %016Lx - %016Lx ",

447 (Ë
°¨t
,

448 (Ë
íd
);

449 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

450 
	`¥ötk
(
KERN_CONT
 " ==> ");

451 
	`e820_¥öt_ty≥
(
√w_ty≥
);

452 
	`¥ötk
(
KERN_CONT
 "\n");

454 
i
 = 0; i < 
e820x
->
ƒ_m≠
; i++) {

455 
e820íåy
 *
ei
 = &
e820x
->
m≠
[
i
];

456 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

457 
u64
 
ei_íd
;

459 i‡(
ei
->
ty≥
 !
ﬁd_ty≥
)

462 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

464 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

465 
ei
->
ty≥
 = 
√w_ty≥
;

466 
ªÆ_upd©ed_size
 +
ei
->
size
;

471 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

472 
	`__e820_add_ªgi⁄
(
e820x
, 
°¨t
, 
size
, 
√w_ty≥
);

473 
	`__e820_add_ªgi⁄
(
e820x
, 
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

474 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

475 
ªÆ_upd©ed_size
 +
size
;

480 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

481 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

482 i‡(
föÆ_°¨t
 >
föÆ_íd
)

485 
	`__e820_add_ªgi⁄
(
e820x
, 
föÆ_°¨t
, 
föÆ_íd
 - final_start,

486 
√w_ty≥
);

488 
ªÆ_upd©ed_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

494 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

495 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

497 
ei
->
addr
 = 
föÆ_íd
;

499  
ªÆ_upd©ed_size
;

500 
	}
}

502 
u64
 
__öô
 
	$e820_upd©e_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

503 
√w_ty≥
)

505  
	`__e820_upd©e_ønge
(&
e820
, 
°¨t
, 
size
, 
ﬁd_ty≥
, 
√w_ty≥
);

506 
	}
}

508 
u64
 
__öô
 
	$e820_upd©e_ønge_ßved
(
u64
 
°¨t
, u64 
size
,

509 
ﬁd_ty≥
, 
√w_ty≥
)

511  
	`__e820_upd©e_ønge
(&
e820_ßved
, 
°¨t
, 
size
, 
ﬁd_ty≥
,

512 
√w_ty≥
);

513 
	}
}

516 
u64
 
__öô
 
	$e820_ªmove_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

517 
checkty≥
)

519 
i
;

520 
u64
 
ªÆ_ªmoved_size
 = 0;

522 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

523 
size
 = 
ULLONG_MAX
 - 
°¨t
;

525 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

526 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

527 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

529 i‡(
checkty≥
 && 
ei
->
ty≥
 !
ﬁd_ty≥
)

532 i‡(
ei
->
addr
 >
°¨t
 &&

533 (
ei
->
addr
 +Éi->
size
Ë<(
°¨t
 + size)) {

534 
ªÆ_ªmoved_size
 +
ei
->
size
;

535 
	`mem£t
(
ei
, 0, (
e820íåy
));

539 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

540 
föÆ_íd
 = 
	`mö
(
°¨t
 + 
size
, 
ei
->
addr
 +Éi->size);

541 i‡(
föÆ_°¨t
 >
föÆ_íd
)

543 
ªÆ_ªmoved_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

545 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

546 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

548 
ei
->
addr
 = 
föÆ_íd
;

550  
ªÆ_ªmoved_size
;

551 
	}
}

553 
__öô
 
	$upd©e_e820
()

555 
u32
 
ƒ_m≠
;

557 
ƒ_m≠
 = 
e820
.nr_map;

558 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ_m≠
))

560 
e820
.
ƒ_m≠
 =Çr_map;

561 
	`¥ötk
(
KERN_INFO
 "modifiedÖhysical RAM map:\n");

562 
	`e820_¥öt_m≠
("modified");

563 
	}
}

564 
__öô
 
	$upd©e_e820_ßved
()

566 
u32
 
ƒ_m≠
;

568 
ƒ_m≠
 = 
e820_ßved
.nr_map;

569 i‡(
	`ßnôize_e820_m≠
(
e820_ßved
.
m≠
, 
	`ARRAY_SIZE
”820_ßved.m≠), &
ƒ_m≠
))

571 
e820_ßved
.
ƒ_m≠
 =Çr_map;

572 
	}
}

573 
	#MAX_GAP_END
 0x100000000uŒ

	)

577 
__öô
 
	$e820_£¨ch_g≠
(*
g≠°¨t
, *
g≠size
,

578 
°¨t_addr
, 
íd_addr
)

580 
œ°
;

581 
i
 = 
e820
.
ƒ_m≠
;

582 
found
 = 0;

584 
œ°
 = (
íd_addr
 &&Énd_add∏< 
MAX_GAP_END
) ?Énd_addr : MAX_GAP_END;

586 --
i
 >= 0) {

587 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

588 
íd
 = 
°¨t
 + 
e820
.
m≠
[
i
].
size
;

590 i‡(
íd
 < 
°¨t_addr
)

597 i‡(
œ°
 > 
íd
) {

598 
g≠
 = 
œ°
 - 
íd
;

600 i‡(
g≠
 >*
g≠size
) {

601 *
g≠size
 = 
g≠
;

602 *
g≠°¨t
 = 
íd
;

603 
found
 = 1;

606 i‡(
°¨t
 < 
œ°
)

607 
œ°
 = 
°¨t
;

609  
found
;

610 
	}
}

618 
__öô
 
	$e820_£tup_g≠
()

620 
g≠°¨t
, 
g≠size
;

621 
found
;

623 
g≠°¨t
 = 0x10000000;

624 
g≠size
 = 0x400000;

625 
found
 = 
	`e820_£¨ch_g≠
(&
g≠°¨t
, &
g≠size
, 0, 
MAX_GAP_END
);

627 #ifde‡
CONFIG_X86_64


628 i‡(!
found
) {

629 
g≠°¨t
 = (
max_p‚
 << 
PAGE_SHIFT
) + 1024*1024;

630 
	`¥ötk
(
KERN_ERR


639 
pci_mem_°¨t
 = 
g≠°¨t
;

641 
	`¥ötk
(
KERN_INFO


643 
pci_mem_°¨t
, 
g≠°¨t
, 
g≠size
);

644 
	}
}

652 
__öô
 
	$∑r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
∑_d©a
)

654 
u32
 
m≠_Àn
;

655 
íåõs
;

656 
e820íåy
 *
extm≠
;

658 
íåõs
 = 
sd©a
->
Àn
 / (
e820íåy
);

659 
m≠_Àn
 = 
sd©a
->
Àn
 + (
£tup_d©a
);

660 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

661 
sd©a
 = 
	`óæy_i‹em≠
(
∑_d©a
, 
m≠_Àn
);

662 
extm≠
 = (
e820íåy
 *)(
sd©a
->
d©a
);

663 
	`__≠≥nd_e820_m≠
(
extm≠
, 
íåõs
);

664 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

665 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

666 
	`óæy_iounm≠
(
sd©a
, 
m≠_Àn
);

667 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

668 
	`e820_¥öt_m≠
("extended");

669 
	}
}

671 #i‡
deföed
(
CONFIG_X86_64
) || \

672 (
deföed
(
CONFIG_X86_32
Ë&& 
	$deföed
(
CONFIG_HIBERNATION
))

681 
__öô
 
	$e820_m¨k_noßve_ªgi⁄s
(
limô_p‚
)

683 
i
;

684 
p‚
;

686 
p‚
 = 
	`PFN_DOWN
(
e820
.
m≠
[0].
addr
 +É820.m≠[0].
size
);

687 
i
 = 1; i < 
e820
.
ƒ_m≠
; i++) {

688 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

690 i‡(
p‚
 < 
	`PFN_UP
(
ei
->
addr
))

691 
	`ªgi°î_noßve_ªgi⁄
(
p‚
, 
	`PFN_UP
(
ei
->
addr
));

693 
p‚
 = 
	`PFN_DOWN
(
ei
->
addr
 +Éi->
size
);

694 i‡(
ei
->
ty≥
 !
E820_RAM
 &&Éi->ty≥ !
E820_RESERVED_KERN
)

695 
	`ªgi°î_noßve_ªgi⁄
(
	`PFN_UP
(
ei
->
addr
), 
p‚
);

697 i‡(
p‚
 >
limô_p‚
)

700 
	}
}

703 #ifde‡
CONFIG_HIBERNATION


708 
__öô
 
	$e820_m¨k_nvs_mem‹y
()

710 
i
;

712 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

713 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

715 i‡(
ei
->
ty≥
 =
E820_NVS
)

716 
	`hibî«ã_nvs_ªgi°î
(
ei
->
addr
,Éi->
size
);

720 
	}
}

721 
c‹e_öôˇŒ
(
e820_m¨k_nvs_mem‹y
);

727 
	#MAX_EARLY_RES
 20

	)

729 
	sóæy_ªs
 {

730 
u64
 
	m°¨t
, 
	míd
;

731 
	m«me
[16];

732 
	movîœp_ok
;

734 
óæy_ªs
 
	góæy_ªs
[
MAX_EARLY_RES
] 
	g__öôd©a
 = {

735 { 0, 
PAGE_SIZE
, "BIOS dataÖage" },

739 
__öô
 
	$föd_ovîœµed_óæy
(
u64
 
°¨t
, u64 
íd
)

741 
i
;

742 
óæy_ªs
 *
r
;

744 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

745 
r
 = &
óæy_ªs
[
i
];

746 i‡(
íd
 > 
r
->
°¨t
 && start <Ñ->end)

750  
i
;

751 
	}
}

758 
__öô
 
	$dr›_ønge
(
i
)

760 
j
;

762 
j
 = 
i
 + 1; j < 
MAX_EARLY_RES
 && 
óæy_ªs
[j].
íd
; j++)

765 
	`memmove
(&
óæy_ªs
[
i
], &early_res[i + 1],

766 (
j
 - 1 - 
i
Ë* (
óæy_ªs
));

768 
óæy_ªs
[
j
 - 1].
íd
 = 0;

769 
	}
}

781 
__öô
 
	$dr›_ovîœps_th©_¨e_ok
(
u64
 
°¨t
, u64 
íd
)

783 
i
;

784 
óæy_ªs
 *
r
;

785 
u64
 
lowî_°¨t
, 
lowî_íd
;

786 
u64
 
uµî_°¨t
, 
uµî_íd
;

787 
«me
[16];

789 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

790 
r
 = &
óæy_ªs
[
i
];

793 i‡(
íd
 <
r
->
°¨t
 || start >=Ñ->end)

801 i‡(!
r
->
ovîœp_ok
)

812 
	`°∫˝y
(
«me
, 
r
->name, (name) - 1);

814 
lowî_°¨t
 = 
lowî_íd
 = 0;

815 
uµî_°¨t
 = 
uµî_íd
 = 0;

816 i‡(
r
->
°¨t
 < start) {

817 
lowî_°¨t
 = 
r
->
°¨t
;

818 
lowî_íd
 = 
°¨t
;

820 i‡(
r
->
íd
 >Énd) {

821 
uµî_°¨t
 = 
íd
;

822 
uµî_íd
 = 
r
->
íd
;

826 
	`dr›_ønge
(
i
);

828 
i
--;

831 i‡(
lowî_íd
)

832 
	`ª£rve_óæy_ovîœp_ok
(
lowî_°¨t
, 
lowî_íd
, 
«me
);

833 i‡(
uµî_íd
)

834 
	`ª£rve_óæy_ovîœp_ok
(
uµî_°¨t
, 
uµî_íd
, 
«me
);

836 
	}
}

838 
__öô
 
	$__ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
,

839 
ovîœp_ok
)

841 
i
;

842 
óæy_ªs
 *
r
;

844 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

845 i‡(
i
 >
MAX_EARLY_RES
)

846 
	`∑nic
("Too manyÉarlyÑeservations");

847 
r
 = &
óæy_ªs
[
i
];

848 i‡(
r
->
íd
)

849 
	`∑nic
("OverlappingÉarlyÑeservations "

851 
°¨t
, 
íd
 - 1, 
«me
?«me:"", 
r
->start,

852 
r
->
íd
 - 1,Ñ->
«me
);

853 
r
->
°¨t
 = start;

854 
r
->
íd
 =Énd;

855 
r
->
ovîœp_ok
 = overlap_ok;

856 i‡(
«me
)

857 
	`°∫˝y
(
r
->
«me
,Çame, (r->name) - 1);

858 
	}
}

880 
__öô
 
	$ª£rve_óæy_ovîœp_ok
(
u64
 
°¨t
, u64 
íd
, *
«me
)

882 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

883 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 1);

884 
	}
}

894 
__öô
 
	$ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
)

896 i‡(
°¨t
 >
íd
)

899 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

900 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 0);

901 
	}
}

903 
__öô
 
	$‰ì_óæy
(
u64
 
°¨t
, u64 
íd
)

905 
óæy_ªs
 *
r
;

906 
i
;

908 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

909 
r
 = &
óæy_ªs
[
i
];

910 i‡(
i
 >
MAX_EARLY_RES
 || 
r
->
íd
 !íd ||Ñ->
°¨t
 != start)

911 
	`∑nic
("free_early onÇotÑeservedárea: %llx-%llx!",

912 
°¨t
, 
íd
 - 1);

914 
	`dr›_ønge
(
i
);

915 
	}
}

917 
__öô
 
	$óæy_ªs_to_boŸmem
(
u64
 
°¨t
, u64 
íd
)

919 
i
, 
cou¡
;

920 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

922 
cou¡
 = 0;

923 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++)

924 
cou¡
++;

926 
	`¥ötk
(
KERN_INFO
 "(%dÉarlyÑeservations) ==> bootmem [%010llx - %010llx]\n",

927 
cou¡
, 
°¨t
, 
íd
);

928 
i
 = 0; i < 
cou¡
; i++) {

929 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

930 
	`¥ötk
(
KERN_INFO
 " #%d [%010Œx - %010Œx] %16s", 
i
,

931 
r
->
°¨t
,Ñ->
íd
,Ñ->
«me
);

932 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
r
->start);

933 
föÆ_íd
 = 
	`mö
(
íd
, 
r
->end);

934 i‡(
föÆ_°¨t
 >
föÆ_íd
) {

935 
	`¥ötk
(
KERN_CONT
 "\n");

938 
	`¥ötk
(
KERN_CONT
 " ==> [%010llx - %010llx]\n",

939 
föÆ_°¨t
, 
föÆ_íd
);

940 
	`ª£rve_boŸmem_gíîic
(
föÆ_°¨t
, 
föÆ_íd
 - final_start,

941 
BOOTMEM_DEFAULT
);

943 
	}
}

946 
ölöe
 
__öô
 
	$bad_addr
(
u64
 *
addΩ
, u64 
size
, u64 
Æign
)

948 
i
;

949 
u64
 
addr
 = *
addΩ
;

950 
ch™ged
 = 0;

951 
óæy_ªs
 *
r
;

952 
agaö
:

953 
i
 = 
	`föd_ovîœµed_óæy
(
addr
,ádd∏+ 
size
);

954 
r
 = &
óæy_ªs
[
i
];

955 i‡(
i
 < 
MAX_EARLY_RES
 && 
r
->
íd
) {

956 *
addΩ
 = 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

957 
ch™ged
 = 1;

958 
agaö
;

960  
ch™ged
;

961 
	}
}

964 
ölöe
 
__öô
 
	$bad_addr_size
(
u64
 *
addΩ
, u64 *
sizï
, u64 
Æign
)

966 
i
;

967 
u64
 
addr
 = *
addΩ
, 
œ°
;

968 
u64
 
size
 = *
sizï
;

969 
ch™ged
 = 0;

970 
agaö
:

971 
œ°
 = 
addr
 + 
size
;

972 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

973 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

974 i‡(
œ°
 > 
r
->
°¨t
 && 
addr
 <Ñ->start) {

975 
size
 = 
r
->
°¨t
 - 
addr
;

976 
ch™ged
 = 1;

977 
agaö
;

979 i‡(
œ°
 > 
r
->
íd
 && 
addr
 <Ñ->end) {

980 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

981 
size
 = 
œ°
 - 
addr
;

982 
ch™ged
 = 1;

983 
agaö
;

985 i‡(
œ°
 <
r
->
íd
 && 
addr
 >r->
°¨t
) {

986 (*
sizï
)++;

990 i‡(
ch™ged
) {

991 *
addΩ
 = 
addr
;

992 *
sizï
 = 
size
;

994  
ch™ged
;

995 
	}
}

1000 
u64
 
__öô
 
	$föd_e820_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

1002 
i
;

1004 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1005 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1006 
u64
 
addr
, 
œ°
;

1007 
u64
 
ei_œ°
;

1009 i‡(
ei
->
ty≥
 !
E820_RAM
)

1011 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1012 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1013 i‡(
addr
 < 
°¨t
)

1014 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1015 i‡(
addr
 >
ei_œ°
)

1017 
	`bad_addr
(&
addr
, 
size
, 
Æign
Ë&&áddr+sizê<
ei_œ°
)

1019 
œ°
 = 
addr
 + 
size
;

1020 i‡(
œ°
 > 
ei_œ°
)

1022 i‡(
œ°
 > 
íd
)

1024  
addr
;

1027 
	}
}

1032 
u64
 
__öô
 
	$föd_e820_¨ó_size
(
u64
 
°¨t
, u64 *
sizï
, u64 
Æign
)

1034 
i
;

1036 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1037 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1038 
u64
 
addr
, 
œ°
;

1039 
u64
 
ei_œ°
;

1041 i‡(
ei
->
ty≥
 !
E820_RAM
)

1043 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1044 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1045 i‡(
addr
 < 
°¨t
)

1046 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1047 i‡(
addr
 >
ei_œ°
)

1049 *
sizï
 = 
ei_œ°
 - 
addr
;

1050 
	`bad_addr_size
(&
addr
, 
sizï
, 
Æign
) &&

1051 
addr
 + *
sizï
 <
ei_œ°
)

1053 
œ°
 = 
addr
 + *
sizï
;

1054 i‡(
œ°
 > 
ei_œ°
)

1056  
addr
;

1060 
	}
}

1065 
u64
 
__öô
 
	$óæy_ª£rve_e820
(
u64
 
°¨â
, u64 
sizë
, u64 
Æign
)

1067 
u64
 
size
 = 0;

1068 
u64
 
addr
;

1069 
u64
 
°¨t
;

1071 
°¨t
 = 
°¨â
; ; sèπ +
size
) {

1072 
°¨t
 = 
	`föd_e820_¨ó_size
(°¨t, &
size
, 
Æign
);

1073 i‡(!(
°¨t
 + 1))

1075 i‡(
size
 >
sizë
)

1079 #ifde‡
CONFIG_X86_32


1080 i‡(
°¨t
 >
MAXMEM
)

1082 i‡(
°¨t
 + 
size
 > 
MAXMEM
)

1083 
size
 = 
MAXMEM
 - 
°¨t
;

1086 
addr
 = 
	`round_down
(
°¨t
 + 
size
 - 
sizë
, 
Æign
);

1087 i‡(
addr
 < 
°¨t
)

1089 
	`e820_upd©e_ønge
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1090 
	`e820_upd©e_ønge_ßved
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1091 
	`¥ötk
(
KERN_INFO
 "updateÉ820 forÉarly_reserve_e820\n");

1092 
	`upd©e_e820
();

1093 
	`upd©e_e820_ßved
();

1095  
addr
;

1096 
	}
}

1098 #ifde‡
CONFIG_X86_32


1099 #ifde‡
CONFIG_X86_PAE


1100 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

1102 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

1105 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

1111 
__öô
 
	$e820_íd_p‚
(
limô_p‚
, 
ty≥
)

1113 
i
;

1114 
œ°_p‚
 = 0;

1115 
max_¨ch_p‚
 = 
MAX_ARCH_PFN
;

1117 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1118 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1119 
°¨t_p‚
;

1120 
íd_p‚
;

1122 i‡(
ei
->
ty≥
 !=Åype)

1125 
°¨t_p‚
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

1126 
íd_p‚
 = (
ei
->
addr
 +Éi->
size
Ë>> 
PAGE_SHIFT
;

1128 i‡(
°¨t_p‚
 >
limô_p‚
)

1130 i‡(
íd_p‚
 > 
limô_p‚
) {

1131 
œ°_p‚
 = 
limô_p‚
;

1134 i‡(
íd_p‚
 > 
œ°_p‚
)

1135 
œ°_p‚
 = 
íd_p‚
;

1138 i‡(
œ°_p‚
 > 
max_¨ch_p‚
)

1139 
œ°_p‚
 = 
max_¨ch_p‚
;

1141 
	`¥ötk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

1142 
œ°_p‚
, 
max_¨ch_p‚
);

1143  
œ°_p‚
;

1144 
	}
}

1145 
__öô
 
	$e820_íd_of_øm_p‚
()

1147  
	`e820_íd_p‚
(
MAX_ARCH_PFN
, 
E820_RAM
);

1148 
	}
}

1150 
__öô
 
	$e820_íd_of_low_øm_p‚
()

1152  
	`e820_íd_p‚
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

1153 
	}
}

1158 
__öô
 
	$e820_föd_a˘ive_ªgi⁄
(c⁄° 
e820íåy
 *
ei
,

1159 
°¨t_p‚
,

1160 
œ°_p‚
,

1161 *
ei_°¨ç‚
,

1162 *
ei_ídp‚
)

1164 
u64
 
Æign
 = 
PAGE_SIZE
;

1166 *
ei_°¨ç‚
 = 
	`round_up
(
ei
->
addr
, 
Æign
Ë>> 
PAGE_SHIFT
;

1167 *
ei_ídp‚
 = 
	`round_down
(
ei
->
addr
 +Éi->
size
, 
Æign
Ë>> 
PAGE_SHIFT
;

1170 i‡(*
ei_°¨ç‚
 >*
ei_ídp‚
)

1174 i‡(
ei
->
ty≥
 !
E820_RAM
 || *
ei_ídp‚
 <
°¨t_p‚
 ||

1175 *
ei_°¨ç‚
 >
œ°_p‚
)

1179 i‡(*
ei_°¨ç‚
 < 
°¨t_p‚
)

1180 *
ei_°¨ç‚
 = 
°¨t_p‚
;

1181 i‡(*
ei_ídp‚
 > 
œ°_p‚
)

1182 *
ei_ídp‚
 = 
œ°_p‚
;

1185 
	}
}

1188 
__öô
 
	$e820_ªgi°î_a˘ive_ªgi⁄s
(
nid
, 
°¨t_p‚
,

1189 
œ°_p‚
)

1191 
ei_°¨ç‚
;

1192 
ei_ídp‚
;

1193 
i
;

1195 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++)

1196 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1197 
°¨t_p‚
, 
œ°_p‚
,

1198 &
ei_°¨ç‚
, &
ei_ídp‚
))

1199 
	`add_a˘ive_ønge
(
nid
, 
ei_°¨ç‚
, 
ei_ídp‚
);

1200 
	}
}

1207 
u64
 
__öô
 
	$e820_hﬁe_size
(
u64
 
°¨t
, u64 
íd
)

1209 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

1210 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

1211 
ei_°¨ç‚
, 
ei_ídp‚
, 
øm
 = 0;

1212 
i
;

1214 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1215 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1216 
°¨t_p‚
, 
œ°_p‚
,

1217 &
ei_°¨ç‚
, &
ei_ídp‚
))

1218 
øm
 +
ei_ídp‚
 - 
ei_°¨ç‚
;

1220  
íd
 - 
°¨t
 - ((
u64
)
øm
 << 
PAGE_SHIFT
);

1221 
	}
}

1223 
	$óæy_∑nic
(*
msg
)

1225 
	`óæy_¥ötk
(
msg
);

1226 
	`∑nic
(
msg
);

1227 
	}
}

1229 
u£rdef
 
	g__öôd©a
;

1232 
__öô
 
	$∑r£_mem›t
(*
p
)

1234 
u64
 
mem_size
;

1236 i‡(!
p
)

1237  -
EINVAL
;

1239 #ifde‡
CONFIG_X86_32


1240 i‡(!
	`°rcmp
(
p
, "nopentium")) {

1241 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_PSE
);

1246 
u£rdef
 = 1;

1247 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1248 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1251 
	}
}

1252 
óæy_∑øm
("mem", 
∑r£_mem›t
);

1254 
__öô
 
	$∑r£_memm≠_›t
(*
p
)

1256 *
ﬁdp
;

1257 
u64
 
°¨t_©
, 
mem_size
;

1259 i‡(!
p
)

1260  -
EINVAL
;

1262 i‡(!
	`°∫cmp
(
p
, "exactmap", 8)) {

1263 #ifde‡
CONFIG_CRASH_DUMP


1269 
ßved_max_p‚
 = 
	`e820_íd_of_øm_p‚
();

1271 
e820
.
ƒ_m≠
 = 0;

1272 
u£rdef
 = 1;

1276 
ﬁdp
 = 
p
;

1277 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1278 i‡(
p
 =
ﬁdp
)

1279  -
EINVAL
;

1281 
u£rdef
 = 1;

1282 i‡(*
p
 == '@') {

1283 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1284 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RAM
);

1285 } i‡(*
p
 == '#') {

1286 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1287 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_ACPI
);

1288 } i‡(*
p
 == '$') {

1289 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1290 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RESERVED
);

1292 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1294  *
p
 ='\0' ? 0 : -
EINVAL
;

1295 
	}
}

1296 
óæy_∑øm
("memm≠", 
∑r£_memm≠_›t
);

1298 
__öô
 
	$föish_e820_∑rsög
()

1300 i‡(
u£rdef
) {

1301 
u32
 
ƒ
 = 
e820
.
ƒ_m≠
;

1303 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ
) < 0)

1304 
	`óæy_∑nic
("Invalid user supplied memory map");

1305 
e820
.
ƒ_m≠
 = 
ƒ
;

1307 
	`¥ötk
(
KERN_INFO
 "user-definedÖhysical RAM map:\n");

1308 
	`e820_¥öt_m≠
("user");

1310 
	}
}

1312 
ölöe
 c⁄° *
	$e820_ty≥_to_°rög
(
e820_ty≥
)

1314 
e820_ty≥
) {

1315 
E820_RESERVED_KERN
:

1316 
E820_RAM
:  "System RAM";

1317 
E820_ACPI
:  "ACPI Tables";

1318 
E820_NVS
:  "ACPI Non-volatile Storage";

1319 
E820_UNUSABLE
:  "Unusable memory";

1322 
	}
}

1327 
ªsour˚
 
__öôd©a
 *
	ge820_ªs
;

1328 
__öô
 
	$e820_ª£rve_ªsour˚s
()

1330 
i
;

1331 
ªsour˚
 *
ªs
;

1332 
u64
 
íd
;

1334 
ªs
 = 
	`Æloc_boŸmem_low
((
ªsour˚
Ë* 
e820
.
ƒ_m≠
);

1335 
e820_ªs
 = 
ªs
;

1336 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1337 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
 - 1;

1338 i‡(
íd
 !(
ªsour˚_size_t
)end) {

1339 
ªs
++;

1342 
ªs
->
«me
 = 
	`e820_ty≥_to_°rög
(
e820
.
m≠
[
i
].
ty≥
);

1343 
ªs
->
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

1344 
ªs
->
íd
 =Énd;

1346 
ªs
->
Êags
 = 
IORESOURCE_MEM
;

1353 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RESERVED
 || 
ªs
->
°¨t
 < (1ULL<<20)) {

1354 
ªs
->
Êags
 |
IORESOURCE_BUSY
;

1355 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

1357 
ªs
++;

1360 
i
 = 0; i < 
e820_ßved
.
ƒ_m≠
; i++) {

1361 
e820íåy
 *
íåy
 = &
e820_ßved
.
m≠
[
i
];

1362 
	`fúmw¨e_m≠_add_óæy
(
íåy
->
addr
,

1363 
íåy
->
addr
 +É¡ry->
size
 - 1,

1364 
	`e820_ty≥_to_°rög
(
íåy
->
ty≥
));

1366 
	}
}

1369 
	$øm_Æignmít
(
ªsour˚_size_t
 
pos
)

1371 
mb
 = 
pos
 >> 20;

1374 i‡(!
mb
)

1378 i‡(
mb
 < 16)

1383 
	}
}

1385 
	#MAX_RESOURCE_SIZE
 ((
ªsour˚_size_t
)-1)

	)

1387 
__öô
 
	$e820_ª£rve_ªsour˚s_œã
()

1389 
i
;

1390 
ªsour˚
 *
ªs
;

1392 
ªs
 = 
e820_ªs
;

1393 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1394 i‡(!
ªs
->
∑ª¡
 &&Ñes->
íd
)

1395 
	`ö£π_ªsour˚_ex∑nd_to_fô
(&
iomem_ªsour˚
, 
ªs
);

1396 
ªs
++;

1403 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1404 
e820íåy
 *
íåy
 = &
e820
.
m≠
[
i
];

1405 
u64
 
°¨t
, 
íd
;

1407 i‡(
íåy
->
ty≥
 !
E820_RAM
)

1409 
°¨t
 = 
íåy
->
addr
 +É¡ry->
size
;

1410 
íd
 = 
	`round_up
(
°¨t
, 
	`øm_Æignmít
(start)) - 1;

1411 i‡(
íd
 > 
MAX_RESOURCE_SIZE
)

1412 
íd
 = 
MAX_RESOURCE_SIZE
;

1413 i‡(
°¨t
 >
íd
)

1415 
	`ª£rve_ªgi⁄_wôh_•lô
(&
iomem_ªsour˚
, 
°¨t
, 
íd
,

1418 
	}
}

1420 *
__öô
 
	$deÁu…_machöe_•ecific_mem‹y_£tup
()

1422 *
who
 = "BIOS-e820";

1423 
u32
 
√w_ƒ
;

1430 
√w_ƒ
 = 
boŸ_∑øms
.
e820_íåõs
;

1431 
	`ßnôize_e820_m≠
(
boŸ_∑øms
.
e820_m≠
,

1432 
	`ARRAY_SIZE
(
boŸ_∑øms
.
e820_m≠
),

1433 &
√w_ƒ
);

1434 
boŸ_∑øms
.
e820_íåõs
 = 
√w_ƒ
;

1435 i‡(
	`≠≥nd_e820_m≠
(
boŸ_∑øms
.
e820_m≠
, boŸ_∑øms.
e820_íåõs
)

1437 
u64
 
mem_size
;

1440 i‡(
boŸ_∑øms
.
Æt_mem_k


1441 < 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
) {

1442 
mem_size
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
;

1443 
who
 = "BIOS-88";

1445 
mem_size
 = 
boŸ_∑øms
.
Æt_mem_k
;

1446 
who
 = "BIOS-e801";

1449 
e820
.
ƒ_m≠
 = 0;

1450 
	`e820_add_ªgi⁄
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1451 
	`e820_add_ªgi⁄
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1455  
who
;

1456 
	}
}

1458 *
__öô
 
__©åibuã__
((
wók
)Ë
	$machöe_•ecific_mem‹y_£tup
()

1460 i‡(
x86_quúks
->
¨ch_mem‹y_£tup
) {

1461 *
who
 = 
x86_quúks
->
	`¨ch_mem‹y_£tup
();

1463 i‡(
who
)

1464  
who
;

1466  
	`deÁu…_machöe_•ecific_mem‹y_£tup
();

1467 
	}
}

1470 * 
__öô
 
__©åibuã__
((
wók
)Ë
	$mem‹y_£tup
()

1472  
	`machöe_•ecific_mem‹y_£tup
();

1473 
	}
}

1475 
__öô
 
	$£tup_mem‹y_m≠
()

1477 *
who
;

1479 
who
 = 
	`mem‹y_£tup
();

1480 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

1481 
	`¥ötk
(
KERN_INFO
 "BIOS-providedÖhysical RAM map:\n");

1482 
	`e820_¥öt_m≠
(
who
);

1483 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<löux/pci.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/pci_ids.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_≠ic.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¨t.h
>

22 
__öô
 
	$fix_hy≥πøn•‹t_c⁄fig
(
num
, 
¶Ÿ
, 
func
)

24 
u32
 
htcfg
;

31 
htcfg
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68);

32 i‡(
htcfg
 & (1 << 18)) {

33 
	`¥ötk
(
KERN_INFO
 "Detected use ofÉxtendedápic ids "

35 i‡((
htcfg
 & (1 << 17)) == 0) {

36 
	`¥ötk
(
KERN_INFO
 "Enabling hypertransportÉxtended "

38 
	`¥ötk
(
KERN_INFO
 "NoteÅhis isá bios bug, "

40 
htcfg
 |= (1 << 17);

41 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68, 
htcfg
);

46 
	}
}

48 
__öô
 
	$vü_bugs
(
num
, 
¶Ÿ
, 
func
)

50 #ifde‡
CONFIG_GART_IOMMU


51 i‡((
max_p‚
 > 
MAX_DMA32_PFN
 || 
f‹˚_iommu
) &&

52 !
g¨t_iommu_≠îtuª_Ælowed
) {

53 
	`¥ötk
(
KERN_INFO


56 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

59 
	}
}

61 #ifde‡
CONFIG_ACPI


62 #ifde‡
CONFIG_X86_IO_APIC


64 
__öô
 
	$nvidü_h≥t_check
(
a˝i_èbÀ_hódî
 *
hódî
)

67 
	}
}

71 
__öô
 
	$nvidü_bugs
(
num
, 
¶Ÿ
, 
func
)

73 #ifde‡
CONFIG_ACPI


74 #ifde‡
CONFIG_X86_IO_APIC


82 i‡(
a˝i_u£_timî_ovîride
)

85 i‡(
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
nvidü_h≥t_check
)) {

86 
a˝i_skù_timî_ovîride
 = 1;

87 
	`¥ötk
(
KERN_INFO
 "Nvidia board "

90 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

97 
	}
}

99 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

100 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

101 
u32
 
__öô
 
	$©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
)

103 
u32
 
d
;

104 
u8
 
b
;

106 
b
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac);

107 
b
 &= ~(1<<5);

108 
	`wrôe_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac, 
b
);

110 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

111 
d
 |= 1<<8;

112 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

114 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

115 
d
 &= 0xff;

116  
d
;

117 
	}
}

120 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

122 
u32
 
d
;

123 
u8
 
b
;

125 i‡(
a˝i_u£_timî_ovîride
)

128 
d
 = 
	`©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
);

129 i‡(
d
 < 0x82)

130 
a˝i_skù_timî_ovîride
 = 1;

133 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

134 i‡(!(
b
 & 0x2))

135 
a˝i_skù_timî_ovîride
 = 1;

138 i‡(
a˝i_skù_timî_ovîride
) {

139 
	`¥ötk
(
KERN_INFO
 "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

140 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

141 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

144 
	}
}

146 
u32
 
__öô
 
	$©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
)

148 
u32
 
ﬁd
, 
d
;

150 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

151 
ﬁd
 = 
d
;

152 
d
 &= ~(1<<8);

153 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

154 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

155 
d
 &= 0xff;

156 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
ﬁd
);

158  
d
;

159 
	}
}

161 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

163 
u32
 
d
, 
ªv
;

165 i‡(
a˝i_u£_timî_ovîride
)

168 
ªv
 = 
	`©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
);

169 i‡(
ªv
 > 0x13)

173 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x64);

174 i‡(!(
d
 & (1<<14)))

175 
a˝i_skù_timî_ovîride
 = 1;

177 i‡(
a˝i_skù_timî_ovîride
) {

178 
	`¥ötk
(
KERN_INFO
 "SB600Ñevisi⁄ 0x%x\n", 
ªv
);

179 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

180 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

183 
	}
}

185 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

187 
	}
}

189 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

191 
	}
}

194 
	#QFLAG_APPLY_ONCE
 0x1

	)

195 
	#QFLAG_APPLIED
 0x2

	)

196 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

197 
	schù£t
 {

198 
u32
 
	mvíd‹
;

199 
u32
 
	mdevi˚
;

200 
u32
 
	m˛ass
;

201 
u32
 
	m˛ass_mask
;

202 
u32
 
	mÊags
;

203 (*
	mf
)(
	mnum
, 
	m¶Ÿ
, 
	mfunc
);

212 
chù£t
 
	góæy_qrk
[] 
	g__öôd©a
 = {

213 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

214 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidü_bugs
 },

215 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

216 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vü_bugs
 },

217 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

218 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy≥πøn•‹t_c⁄fig
 },

219 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

220 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

221 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

222 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_c⁄td
 },

237 
__öô
 
	$check_dev_quúk
(
num
, 
¶Ÿ
, 
func
)

239 
u16
 
˛ass
;

240 
u16
 
víd‹
;

241 
u16
 
devi˚
;

242 
u8
 
ty≥
;

243 
i
;

245 
˛ass
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_CLASS_DEVICE
);

247 i‡(
˛ass
 == 0xffff)

250 
víd‹
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_VENDOR_ID
);

252 
devi˚
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_DEVICE_ID
);

254 
i
 = 0; 
óæy_qrk
[i].
f
 !
NULL
; i++) {

255 i‡(((
óæy_qrk
[
i
].
víd‹
 =
PCI_ANY_ID
) ||

256 (
óæy_qrk
[
i
].
víd‹
 == vendor)) &&

257 ((
óæy_qrk
[
i
].
devi˚
 =
PCI_ANY_ID
) ||

258 (
óæy_qrk
[
i
].
devi˚
 == device)) &&

259 (!((
óæy_qrk
[
i
].
˛ass
 ^ class) &

260 
óæy_qrk
[
i
].
˛ass_mask
))) {

261 i‡((
óæy_qrk
[
i
].
Êags
 &

262 
QFLAG_DONE
) != QFLAG_DONE)

263 
óæy_qrk
[
i
].
	`f
(
num
, 
¶Ÿ
, 
func
);

264 
óæy_qrk
[
i
].
Êags
 |
QFLAG_APPLIED
;

268 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

269 
PCI_HEADER_TYPE
);

270 i‡(!(
ty≥
 & 0x80))

274 
	}
}

276 
__öô
 
	$óæy_quúks
()

278 
¶Ÿ
, 
func
;

280 i‡(!
	`óæy_pci_Ælowed
())

285 
¶Ÿ
 = 0; slot < 32; slot++)

286 
func
 = 0; func < 8; func++) {

288 i‡(
	`check_dev_quúk
(0, 
¶Ÿ
, 
func
))

291 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<löux/c⁄sﬁe.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/s¸ìn_öfo.h
>

6 
	~<löux/usb/ch9.h
>

7 
	~<löux/pci_ªgs.h
>

8 
	~<löux/pci_ids.h
>

9 
	~<löux/î∫o.h
>

10 
	~<asm/io.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/f˙é.h
>

13 
	~<asm/£tup.h
>

14 
	~<xí/hvc-c⁄sﬁe.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/fixm≠.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<löux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcuºít_ypos
 = 25, 
	gcuºít_xpos
;

26 
	$óæy_vga_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
°r
++Ë!'\0' && 
n
-- > 0) {

32 i‡(
cuºít_ypos
 >
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wrôew
(
	`ªadw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wrôew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cuºít_ypos
 = 
max_ypos
-1;

44 i‡(
c
 == '\n') {

45 
cuºít_xpos
 = 0;

46 
cuºít_ypos
++;

47 } i‡(
c
 != '\r') {

48 
	`wrôew
(((0x7 << 8Ë| (Ë
c
),

49 
VGABASE
 + 2*(
max_xpos
*
cuºít_ypos
 +

50 
cuºít_xpos
++));

51 i‡(
cuºít_xpos
 >
max_xpos
) {

52 
cuºít_xpos
 = 0;

53 
cuºít_ypos
++;

57 
	}
}

59 
c⁄sﬁe
 
	góæy_vga_c⁄sﬁe
 = {

60 .
«me
 = "earlyvga",

61 .
	gwrôe
 = 
óæy_vga_wrôe
,

62 .
	gÊags
 = 
CON_PRINTBUFFER
,

63 .
	gödex
 = -1,

68 
	góæy_£rül_ba£
 = 0x3f8;

70 
	#XMTRDY
 0x20

	)

72 
	#DLAB
 0x80

	)

74 
	#TXR
 0

	)

75 
	#RXR
 0

	)

76 
	#IER
 1

	)

77 
	#IIR
 2

	)

78 
	#FCR
 2

	)

79 
	#LCR
 3

	)

80 
	#MCR
 4

	)

81 
	#LSR
 5

	)

82 
	#MSR
 6

	)

83 
	#DLL
 0

	)

84 
	#DLH
 1

	)

86 
	$óæy_£rül_putc
(
ch
)

88 
timeout
 = 0xffff;

90 (
	`öb
(
óæy_£rül_ba£
 + 
LSR
Ë& 
XMTRDY
Ë=0 && --
timeout
)

91 
	`˝u_ªœx
();

92 
	`outb
(
ch
, 
óæy_£rül_ba£
 + 
TXR
);

93  
timeout
 ? 0 : -1;

94 
	}
}

96 
	$óæy_£rül_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
s
, 
n
)

98 *
s
 && 
n
-- > 0) {

99 i‡(*
s
 == '\n')

100 
	`óæy_£rül_putc
('\r');

101 
	`óæy_£rül_putc
(*
s
);

102 
s
++;

104 
	}
}

106 
	#DEFAULT_BAUD
 9600

	)

108 
__öô
 
	$óæy_£rül_öô
(*
s
)

110 
c
;

111 
divis‹
;

112 
baud
 = 
DEFAULT_BAUD
;

113 *
e
;

115 i‡(*
s
 == ',')

116 ++
s
;

118 i‡(*
s
) {

119 
p‹t
;

120 i‡(!
	`°∫cmp
(
s
, "0x", 2)) {

121 
óæy_£rül_ba£
 = 
	`sim∂e_°πoul
(
s
, &
e
, 16);

123 c⁄° 
__öôc⁄°
 
ba£s
[] = { 0x3f8, 0x2f8 };

125 i‡(!
	`°∫cmp
(
s
, "ttyS", 4))

126 
s
 += 4;

127 
p‹t
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

128 i‡(
p‹t
 > 1 || 
s
 =
e
)

129 
p‹t
 = 0;

130 
óæy_£rül_ba£
 = 
ba£s
[
p‹t
];

132 
s
 +
	`°rc•n
(s, ",");

133 i‡(*
s
 == ',')

134 
s
++;

137 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
LCR
);

138 
	`outb
(0, 
óæy_£rül_ba£
 + 
IER
);

139 
	`outb
(0, 
óæy_£rül_ba£
 + 
FCR
);

140 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
MCR
);

142 i‡(*
s
) {

143 
baud
 = 
	`sim∂e_°πoul
(
s
, &
e
, 0);

144 i‡(
baud
 =0 || 
s
 =
e
)

145 
baud
 = 
DEFAULT_BAUD
;

148 
divis‹
 = 115200 / 
baud
;

149 
c
 = 
	`öb
(
óæy_£rül_ba£
 + 
LCR
);

150 
	`outb
(
c
 | 
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

151 
	`outb
(
divis‹
 & 0xff, 
óæy_£rül_ba£
 + 
DLL
);

152 
	`outb
((
divis‹
 >> 8Ë& 0xff, 
óæy_£rül_ba£
 + 
DLH
);

153 
	`outb
(
c
 & ~
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

154 
	}
}

156 
c⁄sﬁe
 
	góæy_£rül_c⁄sﬁe
 = {

157 .
«me
 = "earlyser",

158 .
	gwrôe
 = 
óæy_£rül_wrôe
,

159 .
	gÊags
 = 
CON_PRINTBUFFER
,

160 .
	gödex
 = -1,

163 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


165 
ehci_ˇps
 
__iomem
 *
	gehci_ˇps
;

166 
ehci_ªgs
 
__iomem
 *
	gehci_ªgs
;

167 
ehci_dbg_p‹t
 
__iomem
 *
	gehci_debug
;

168 
	gdbgp_ídpoöt_out
;

170 
	sehci_dev
 {

171 
u32
 
	mbus
;

172 
u32
 
	m¶Ÿ
;

173 
u32
 
	mfunc
;

176 
ehci_dev
 
	gehci_dev
;

178 
	#USB_DEBUG_DEVNUM
 127

	)

180 
	#DBGP_DATA_TOGGLE
 0x8800

	)

182 
ölöe
 
u32
 
	$dbgp_pid_upd©e
(
u32
 
x
, u32 
tok
)

184  ((
x
 ^ 
DBGP_DATA_TOGGLE
Ë& 0xffff00Ë| (
tok
 & 0xff);

185 
	}
}

187 
ölöe
 
u32
 
	$dbgp_Àn_upd©e
(
u32
 
x
, u32 
Àn
)

189  (
x
 & ~0x0fË| (
Àn
 & 0x0f);

190 
	}
}

197 
	#USB_PID_OUT
 0xe1

	)

198 
	#USB_PID_IN
 0x69

	)

199 
	#USB_PID_SOF
 0xa5

	)

200 
	#USB_PID_SETUP
 0x2d

	)

202 
	#USB_PID_ACK
 0xd2

	)

203 
	#USB_PID_NAK
 0x5a

	)

204 
	#USB_PID_STALL
 0x1e

	)

205 
	#USB_PID_NYET
 0x96

	)

207 
	#USB_PID_DATA0
 0xc3

	)

208 
	#USB_PID_DATA1
 0x4b

	)

209 
	#USB_PID_DATA2
 0x87

	)

210 
	#USB_PID_MDATA
 0x0f

	)

212 
	#USB_PID_PREAMBLE
 0x3c

	)

213 
	#USB_PID_ERR
 0x3c

	)

214 
	#USB_PID_SPLIT
 0x78

	)

215 
	#USB_PID_PING
 0xb4

	)

216 
	#USB_PID_UNDEF_0
 0xf0

	)

218 
	#USB_PID_DATA_TOGGLE
 0x88

	)

219 
	#DBGP_CLAIM
 (
DBGP_OWNER
 | 
DBGP_ENABLED
 | 
DBGP_INUSE
)

	)

221 
	#PCI_CAP_ID_EHCI_DEBUG
 0xa

	)

223 
	#HUB_ROOT_RESET_TIME
 50

	)

224 
	#HUB_SHORT_RESET_TIME
 10

	)

225 
	#HUB_LONG_RESET_TIME
 200

	)

226 
	#HUB_RESET_TIMEOUT
 500

	)

228 
	#DBGP_MAX_PACKET
 8

	)

230 
	$dbgp_waô_u¡û_com∂ëe
()

232 
u32
 
˘æ
;

233 
lo›
 = 0x100000;

236 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

238 i‡(
˘æ
 & 
DBGP_DONE
)

240 } --
lo›
 > 0);

242 i‡(!
lo›
)

249 
	`wrôñ
(
˘æ
 | 
DBGP_DONE
, &
ehci_debug
->
c⁄åﬁ
);

250  (
˘æ
 & 
DBGP_ERROR
Ë? -
	`DBGP_ERRCODE
(˘æË: 
	`DBGP_LEN
(ctrl);

251 
	}
}

253 
__öô
 
	$dbgp_mdñay
(
ms
)

255 
i
;

257 
ms
--) {

258 
i
 = 0; i < 1000; i++)

259 
	`outb
(0x1, 0x80);

261 
	}
}

263 
	$dbgp_bª©h
()

266 
	}
}

268 
	$dbgp_waô_u¡û_d⁄e
(
˘æ
)

270 
u32
 
pids
, 
Õid
;

271 
ªt
;

272 
lo›
 = 3;

274 
ªåy
:

275 
	`wrôñ
(
˘æ
 | 
DBGP_GO
, &
ehci_debug
->
c⁄åﬁ
);

276 
ªt
 = 
	`dbgp_waô_u¡û_com∂ëe
();

277 
pids
 = 
	`ªadl
(&
ehci_debug
->pids);

278 
Õid
 = 
	`DBGP_PID_GET
(
pids
);

280 i‡(
ªt
 < 0)

281  
ªt
;

287 i‡((
Õid
 =
USB_PID_NAK
Ë|| (Õid =
USB_PID_NYET
))

288 
	`dbgp_bª©h
();

291 i‡(
Õid
 =
USB_PID_NAK
) {

292 i‡(--
lo›
 > 0)

293 
ªåy
;

296  
ªt
;

297 
	}
}

299 
	$dbgp_£t_d©a
(c⁄° *
buf
, 
size
)

301 c⁄° *
byãs
 = 
buf
;

302 
u32
 
lo
, 
hi
;

303 
i
;

305 
lo
 = 
hi
 = 0;

306 
i
 = 0; i < 4 && i < 
size
; i++)

307 
lo
 |
byãs
[
i
] << (8*i);

308 ; 
i
 < 8 && i < 
size
; i++)

309 
hi
 |
byãs
[
i
] << (8*(i - 4));

310 
	`wrôñ
(
lo
, &
ehci_debug
->
d©a03
);

311 
	`wrôñ
(
hi
, &
ehci_debug
->
d©a47
);

312 
	}
}

314 
__öô
 
	$dbgp_gë_d©a
(*
buf
, 
size
)

316 *
byãs
 = 
buf
;

317 
u32
 
lo
, 
hi
;

318 
i
;

320 
lo
 = 
	`ªadl
(&
ehci_debug
->
d©a03
);

321 
hi
 = 
	`ªadl
(&
ehci_debug
->
d©a47
);

322 
i
 = 0; i < 4 && i < 
size
; i++)

323 
byãs
[
i
] = (
lo
 >> (8*i)) & 0xff;

324 ; 
i
 < 8 && i < 
size
; i++)

325 
byãs
[
i
] = (
hi
 >> (8*(i - 4))) & 0xff;

326 
	}
}

328 
	$dbgp_bulk_wrôe
(
devnum
, 
ídpoöt
,

329 c⁄° *
byãs
, 
size
)

331 
u32
 
pids
, 
addr
, 
˘æ
;

332 
ªt
;

334 i‡(
size
 > 
DBGP_MAX_PACKET
)

337 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 
ídpoöt
);

339 
pids
 = 
	`ªadl
(&
ehci_debug
->pids);

340 
pids
 = 
	`dbgp_pid_upd©e
’ids, 
USB_PID_OUT
);

342 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

343 
˘æ
 = 
	`dbgp_Àn_upd©e
(˘æ, 
size
);

344 
˘æ
 |
DBGP_OUT
;

345 
˘æ
 |
DBGP_GO
;

347 
	`dbgp_£t_d©a
(
byãs
, 
size
);

348 
	`wrôñ
(
addr
, &
ehci_debug
->
addªss
);

349 
	`wrôñ
(
pids
, &
ehci_debug
->pids);

351 
ªt
 = 
	`dbgp_waô_u¡û_d⁄e
(
˘æ
);

352 i‡(
ªt
 < 0)

353  
ªt
;

355  
ªt
;

356 
	}
}

358 
__öô
 
	$dbgp_bulk_ªad
(
devnum
, 
ídpoöt
, *
d©a
,

359 
size
)

361 
u32
 
pids
, 
addr
, 
˘æ
;

362 
ªt
;

364 i‡(
size
 > 
DBGP_MAX_PACKET
)

367 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 
ídpoöt
);

369 
pids
 = 
	`ªadl
(&
ehci_debug
->pids);

370 
pids
 = 
	`dbgp_pid_upd©e
’ids, 
USB_PID_IN
);

372 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

373 
˘æ
 = 
	`dbgp_Àn_upd©e
(˘æ, 
size
);

374 
˘æ
 &~
DBGP_OUT
;

375 
˘æ
 |
DBGP_GO
;

377 
	`wrôñ
(
addr
, &
ehci_debug
->
addªss
);

378 
	`wrôñ
(
pids
, &
ehci_debug
->pids);

379 
ªt
 = 
	`dbgp_waô_u¡û_d⁄e
(
˘æ
);

380 i‡(
ªt
 < 0)

381  
ªt
;

383 i‡(
size
 > 
ªt
)

384 
size
 = 
ªt
;

385 
	`dbgp_gë_d©a
(
d©a
, 
size
);

386  
ªt
;

387 
	}
}

389 
__öô
 
	$dbgp_c⁄åﬁ_msg
(
devnum
, 
ªque°ty≥
,

390 
ªque°
, 
vÆue
, 
ödex
, *
d©a
, 
size
)

392 
u32
 
pids
, 
addr
, 
˘æ
;

393 
usb_˘æªque°
 
ªq
;

394 
ªad
;

395 
ªt
;

397 
ªad
 = (
ªque°ty≥
 & 
USB_DIR_IN
) != 0;

398 i‡(
size
 > (
ªad
 ? 
DBGP_MAX_PACKET
:0))

402 
ªq
.
bReque°Ty≥
 = 
ªque°ty≥
;

403 
ªq
.
bReque°
 = 
ªque°
;

404 
ªq
.
wVÆue
 = 
	`˝u_to_À16
(
vÆue
);

405 
ªq
.
wIndex
 = 
	`˝u_to_À16
(
ödex
);

406 
ªq
.
wLígth
 = 
	`˝u_to_À16
(
size
);

408 
pids
 = 
	`DBGP_PID_SET
(
USB_PID_DATA0
, 
USB_PID_SETUP
);

409 
addr
 = 
	`DBGP_EPADDR
(
devnum
, 0);

411 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

412 
˘æ
 = 
	`dbgp_Àn_upd©e
(˘æ, (
ªq
));

413 
˘æ
 |
DBGP_OUT
;

414 
˘æ
 |
DBGP_GO
;

417 
	`dbgp_£t_d©a
(&
ªq
, (req));

418 
	`wrôñ
(
addr
, &
ehci_debug
->
addªss
);

419 
	`wrôñ
(
pids
, &
ehci_debug
->pids);

420 
ªt
 = 
	`dbgp_waô_u¡û_d⁄e
(
˘æ
);

421 i‡(
ªt
 < 0)

422  
ªt
;

425  
	`dbgp_bulk_ªad
(
devnum
, 0, 
d©a
, 
size
);

426 
	}
}

430 
u32
 
__öô
 
	$föd_ˇp
(
u32
 
num
, u32 
¶Ÿ
, u32 
func
, 
ˇp
)

432 
u8
 
pos
;

433 
byãs
;

435 i‡(!(
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

436 
PCI_STATUS_CAP_LIST
))

439 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

440 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

441 
u8
 
id
;

443 
pos
 &= ~3;

444 
id
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

445 i‡(
id
 == 0xff)

447 i‡(
id
 =
ˇp
)

448  
pos
;

450 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

451 
pos
+
PCI_CAP_LIST_NEXT
);

454 
	}
}

456 
u32
 
__öô
 
	$__föd_dbgp
(
u32
 
bus
, u32 
¶Ÿ
, u32 
func
)

458 
u32
 
˛ass
;

460 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CLASS_REVISION
);

461 i‡((
˛ass
 >> 8Ë!
PCI_CLASS_SERIAL_USB_EHCI
)

464  
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAP_ID_EHCI_DEBUG
);

465 
	}
}

467 
u32
 
__öô
 
	$föd_dbgp
(
ehci_num
, 
u32
 *
rbus
, u32 *
r¶Ÿ
, u32 *
rfunc
)

469 
u32
 
bus
, 
¶Ÿ
, 
func
;

471 
bus
 = 0; bus < 256; bus++) {

472 
¶Ÿ
 = 0; slot < 32; slot++) {

473 
func
 = 0; func < 8; func++) {

474 
ˇp
;

476 
ˇp
 = 
	`__föd_dbgp
(
bus
, 
¶Ÿ
, 
func
);

478 i‡(!
ˇp
)

480 i‡(
ehci_num
-- != 0)

482 *
rbus
 = 
bus
;

483 *
r¶Ÿ
 = 
¶Ÿ
;

484 *
rfunc
 = 
func
;

485  
ˇp
;

490 
	}
}

492 
__öô
 
	$ehci_ª£t_p‹t
(
p‹t
)

494 
u32
 
p‹tsc
;

495 
u32
 
dñay_time
, 
dñay
;

496 
lo›
;

499 
p‹tsc
 = 
	`ªadl
(&
ehci_ªgs
->
p‹t_°©us
[
p‹t
 - 1]);

500 
p‹tsc
 &~
PORT_PE
;

501 
p‹tsc
 |
PORT_RESET
;

502 
	`wrôñ
(
p‹tsc
, &
ehci_ªgs
->
p‹t_°©us
[
p‹t
 - 1]);

504 
dñay
 = 
HUB_ROOT_RESET_TIME
;

505 
dñay_time
 = 0; dñay_timê< 
HUB_RESET_TIMEOUT
;

506 
dñay_time
 +
dñay
) {

507 
	`dbgp_mdñay
(
dñay
);

509 
p‹tsc
 = 
	`ªadl
(&
ehci_ªgs
->
p‹t_°©us
[
p‹t
 - 1]);

510 i‡(
p‹tsc
 & 
PORT_RESET
) {

512 
lo›
 = 2;

513 
	`wrôñ
(
p‹tsc
 & ~(
PORT_RWC_BITS
 | 
PORT_RESET
),

514 &
ehci_ªgs
->
p‹t_°©us
[
p‹t
 - 1]);

516 
p‹tsc
 = 
	`ªadl
(&
ehci_ªgs
->
p‹t_°©us
[
p‹t
-1]);

517 } (
p‹tsc
 & 
PORT_RESET
Ë&& (--
lo›
 > 0));

521 i‡(!(
p‹tsc
 & 
PORT_CONNECT
))

522  -
ENOTCONN
;

525 i‡((
p‹tsc
 & 
PORT_CSC
))

526  -
EINVAL
;

529 i‡(!(
p‹tsc
 & 
PORT_RESET
Ë&& (p‹ts¯& 
PORT_PE
))

532  -
EBUSY
;

533 
	}
}

535 
__öô
 
	$ehci_waô_f‹_p‹t
(
p‹t
)

537 
u32
 
°©us
;

538 
ªt
, 
ªps
;

540 
ªps
 = 0;Ñeps < 3;Ñeps++) {

541 
	`dbgp_mdñay
(100);

542 
°©us
 = 
	`ªadl
(&
ehci_ªgs
->status);

543 i‡(
°©us
 & 
STS_PCD
) {

544 
ªt
 = 
	`ehci_ª£t_p‹t
(
p‹t
);

545 i‡(
ªt
 == 0)

549  -
ENOTCONN
;

550 
	}
}

552 #ifde‡
DBGP_DEBUG


553 
	#dbgp_¥ötk
 
óæy_¥ötk


	)

555 
ölöe
 
	$dbgp_¥ötk
(c⁄° *
fmt
, ...Ë{ 
	}
}

558 (*
	t£t_debug_p‹t_t
)(
	tp‹t
);

560 
__öô
 
	$deÁu…_£t_debug_p‹t
(
p‹t
)

562 
	}
}

564 
£t_debug_p‹t_t
 
__öôd©a
 
	g£t_debug_p‹t
 = 
deÁu…_£t_debug_p‹t
;

566 
__öô
 
	$nvidü_£t_debug_p‹t
(
p‹t
)

568 
u32
 
dw‹d
;

569 
dw‹d
 = 
	`ªad_pci_c⁄fig
(
ehci_dev
.
bus
,Éhci_dev.
¶Ÿ
,Éhci_dev.
func
,

571 
dw‹d
 &= ~(0x0f<<12);

572 
dw‹d
 |((
p‹t
 & 0x0f)<<12);

573 
	`wrôe_pci_c⁄fig
(
ehci_dev
.
bus
,Éhci_dev.
¶Ÿ
,Éhci_dev.
func
, 0x74,

574 
dw‹d
);

575 
	`dbgp_¥ötk
("£àdebugÖ‹àtÿ%d\n", 
p‹t
);

576 
	}
}

578 
__öô
 
	$dëe˘_£t_debug_p‹t
()

580 
u32
 
víd‹id
;

582 
víd‹id
 = 
	`ªad_pci_c⁄fig
(
ehci_dev
.
bus
,Éhci_dev.
¶Ÿ
,Éhci_dev.
func
,

585 i‡((
víd‹id
 & 0xffff) == 0x10de) {

586 
	`dbgp_¥ötk
("usingÇvidia set_debug_port\n");

587 
£t_debug_p‹t
 = 
nvidü_£t_debug_p‹t
;

589 
	}
}

591 
__öô
 
	$ehci_£tup
()

593 
usb_debug_des¸ùt‹
 
dbgp_desc
;

594 
u32
 
cmd
, 
˘æ
, 
°©us
, 
p‹tsc
, 
hcs_∑øms
;

595 
u32
 
debug_p‹t
, 
√w_debug_p‹t
 = 0, 
n_p‹ts
;

596 
u32
 
devnum
;

597 
ªt
, 
i
;

598 
lo›
;

599 
p‹t_m≠_åõd
;

600 
∂aytimes
 = 3;

602 
åy_√xt_time
:

603 
p‹t_m≠_åõd
 = 0;

605 
åy_√xt_p‹t
:

607 
hcs_∑øms
 = 
	`ªadl
(&
ehci_ˇps
->hcs_params);

608 
debug_p‹t
 = 
	`HCS_DEBUG_PORT
(
hcs_∑øms
);

609 
n_p‹ts
 = 
	`HCS_N_PORTS
(
hcs_∑øms
);

611 
	`dbgp_¥ötk
("debug_p‹t: %d\n", 
debug_p‹t
);

612 
	`dbgp_¥ötk
("n_p‹ts: %d\n", 
n_p‹ts
);

614 
i
 = 1; i <
n_p‹ts
; i++) {

615 
p‹tsc
 = 
	`ªadl
(&
ehci_ªgs
->
p‹t_°©us
[
i
-1]);

616 
	`dbgp_¥ötk
("p‹t°©us%d: %08x\n", 
i
, 
p‹tsc
);

619 i‡(
p‹t_m≠_åõd
 && (
√w_debug_p‹t
 !
debug_p‹t
)) {

620 i‡(--
∂aytimes
) {

621 
	`£t_debug_p‹t
(
√w_debug_p‹t
);

622 
åy_√xt_time
;

627 
lo›
 = 10;

629 
cmd
 = 
	`ªadl
(&
ehci_ªgs
->
comm™d
);

630 
cmd
 |
CMD_RESET
;

631 
	`wrôñ
(
cmd
, &
ehci_ªgs
->
comm™d
);

633 
cmd
 = 
	`ªadl
(&
ehci_ªgs
->
comm™d
);

634 } (
cmd
 & 
CMD_RESET
Ë&& (--
lo›
 > 0));

636 i‡(!
lo›
) {

637 
	`dbgp_¥ötk
("canÇotÑesetÉhci\n");

640 
	`dbgp_¥ötk
("ehciÑeset done\n");

643 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

644 
˘æ
 |
DBGP_OWNER
;

645 
˘æ
 &~(
DBGP_ENABLED
 | 
DBGP_INUSE
);

646 
	`wrôñ
(
˘æ
, &
ehci_debug
->
c⁄åﬁ
);

649 
cmd
 = 
	`ªadl
(&
ehci_ªgs
->
comm™d
);

650 
cmd
 &~(
CMD_LRESET
 | 
CMD_IAAD
 | 
CMD_PSE
 | 
CMD_ASE
 | 
CMD_RESET
);

651 
cmd
 |
CMD_RUN
;

652 
	`wrôñ
(
cmd
, &
ehci_ªgs
->
comm™d
);

655 
	`wrôñ
(
FLAG_CF
, &
ehci_ªgs
->
c⁄figuªd_Êag
);

658 
lo›
 = 10;

660 
°©us
 = 
	`ªadl
(&
ehci_ªgs
->status);

661 } (
°©us
 & 
STS_HALT
Ë&& (--
lo›
 > 0));

663 i‡(!
lo›
) {

664 
	`dbgp_¥ötk
("ehci can be started\n");

667 
	`dbgp_¥ötk
("ehci started\n");

670 
ªt
 = 
	`ehci_waô_f‹_p‹t
(
debug_p‹t
);

671 i‡(
ªt
 < 0) {

672 
	`dbgp_¥ötk
("No device found in debugÖort\n");

673 
√xt_debug_p‹t
;

675 
	`dbgp_¥ötk
("ehci wait forÖort done\n");

678 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

679 
˘æ
 |
DBGP_CLAIM
;

680 
	`wrôñ
(
˘æ
, &
ehci_debug
->
c⁄åﬁ
);

681 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

682 i‡((
˘æ
 & 
DBGP_CLAIM
) != DBGP_CLAIM) {

683 
	`dbgp_¥ötk
("No device in debugÖort\n");

684 
	`wrôñ
(
˘æ
 & ~
DBGP_CLAIM
, &
ehci_debug
->
c⁄åﬁ
);

685 
îr
;

687 
	`dbgp_¥ötk
("debugÖortedÉnabled\n");

690 
p‹tsc
 = 
	`ªadl
(&
ehci_ªgs
->
p‹t_°©us
[
debug_p‹t
 - 1]);

691 
p‹tsc
 &~
PORT_PE
;

692 
	`wrôñ
(
p‹tsc
, &
ehci_ªgs
->
p‹t_°©us
[
debug_p‹t
 - 1]);

694 
	`dbgp_mdñay
(100);

697 
devnum
 = 0; devnum <= 127; devnum++) {

698 
ªt
 = 
	`dbgp_c⁄åﬁ_msg
(
devnum
,

699 
USB_DIR_IN
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

700 
USB_REQ_GET_DESCRIPTOR
, (
USB_DT_DEBUG
 << 8), 0,

701 &
dbgp_desc
, (dbgp_desc));

702 i‡(
ªt
 > 0)

705 i‡(
devnum
 > 127) {

706 
	`dbgp_¥ötk
("CouldÇot findáttached debug device\n");

707 
îr
;

709 i‡(
ªt
 < 0) {

710 
	`dbgp_¥ötk
("Attached device isÇotá debug device\n");

711 
îr
;

713 
dbgp_ídpoöt_out
 = 
dbgp_desc
.
bDebugOutEndpoöt
;

716 i‡(
devnum
 !
USB_DEBUG_DEVNUM
) {

717 
ªt
 = 
	`dbgp_c⁄åﬁ_msg
(
devnum
,

718 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

719 
USB_REQ_SET_ADDRESS
, 
USB_DEBUG_DEVNUM
, 0, 
NULL
, 0);

720 i‡(
ªt
 < 0) {

721 
	`dbgp_¥ötk
("CouldÇot moveáttached deviceÅo %d\n",

722 
USB_DEBUG_DEVNUM
);

723 
îr
;

725 
devnum
 = 
USB_DEBUG_DEVNUM
;

726 
	`dbgp_¥ötk
("debug deviceÑenamedÅo 127\n");

730 
ªt
 = 
	`dbgp_c⁄åﬁ_msg
(
USB_DEBUG_DEVNUM
,

731 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
,

732 
USB_REQ_SET_FEATURE
, 
USB_DEVICE_DEBUG_MODE
, 0, 
NULL
, 0);

733 i‡(
ªt
 < 0) {

734 
	`dbgp_¥ötk
(" CouldÇotÉnableÅhe debug device\n");

735 
îr
;

737 
	`dbgp_¥ötk
("debug interfaceÉnabled\n");

741 
ªt
 = 
	`dbgp_bulk_wrôe
(
USB_DEBUG_DEVNUM
, 
dbgp_ídpoöt_out
, " ", 1);

742 i‡(
ªt
 < 0) {

743 
	`dbgp_¥ötk
("dbgp_bulk_wrôêÁûed: %d\n", 
ªt
);

744 
îr
;

746 
	`dbgp_¥ötk
("small write doned\n");

749 
îr
:

751 
˘æ
 = 
	`ªadl
(&
ehci_debug
->
c⁄åﬁ
);

752 
˘æ
 &~(
DBGP_CLAIM
 | 
DBGP_OUT
);

753 
	`wrôñ
(
˘æ
, &
ehci_debug
->
c⁄åﬁ
);

756 
√xt_debug_p‹t
:

757 
p‹t_m≠_åõd
 |(1<<(
debug_p‹t
 - 1));

758 
√w_debug_p‹t
 = ((
debug_p‹t
-1+1)%
n_p‹ts
) + 1;

759 i‡(
p‹t_m≠_åõd
 !((1<<
n_p‹ts
) - 1)) {

760 
	`£t_debug_p‹t
(
√w_debug_p‹t
);

761 
åy_√xt_p‹t
;

763 i‡(--
∂aytimes
) {

764 
	`£t_debug_p‹t
(
√w_debug_p‹t
);

765 
åy_√xt_time
;

769 
	}
}

771 
__öô
 
	$óæy_dbgp_öô
(*
s
)

773 
u32
 
debug_p‹t
, 
b¨
, 
off£t
;

774 
u32
 
bus
, 
¶Ÿ
, 
func
, 
ˇp
;

775 
__iomem
 *
ehci_b¨
;

776 
u32
 
dbgp_num
;

777 
u32
 
b¨_vÆ
;

778 *
e
;

779 
ªt
;

780 
u8
 
byã
;

782 i‡(!
	`óæy_pci_Ælowed
())

785 
dbgp_num
 = 0;

786 i‡(*
s
)

787 
dbgp_num
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

788 
	`dbgp_¥ötk
("dbgp_num: %d\n", 
dbgp_num
);

790 
ˇp
 = 
	`föd_dbgp
(
dbgp_num
, &
bus
, &
¶Ÿ
, &
func
);

791 i‡(!
ˇp
)

794 
	`dbgp_¥ötk
("Found EHCI debugÖ‹à⁄ %02x:%02x.%1x\n", 
bus
, 
¶Ÿ
,

795 
func
);

797 
debug_p‹t
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
);

798 
b¨
 = (
debug_p‹t
 >> 29) & 0x7;

799 
b¨
 = (bar * 4) + 0xc;

800 
off£t
 = (
debug_p‹t
 >> 16) & 0xfff;

801 
	`dbgp_¥ötk
("b¨: %02x off£t: %03x\n", 
b¨
, 
off£t
);

802 i‡(
b¨
 !
PCI_BASE_ADDRESS_0
) {

803 
	`dbgp_¥ötk
("only debugÖorts on bar 1 handled.\n");

808 
b¨_vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 
PCI_BASE_ADDRESS_0
);

809 
	`dbgp_¥ötk
("b¨_vÆ: %02x off£t: %03x\n", 
b¨_vÆ
, 
off£t
);

810 i‡(
b¨_vÆ
 & ~
PCI_BASE_ADDRESS_MEM_MASK
) {

811 
	`dbgp_¥ötk
("only simple 32bit mmio bars supported\n");

817 
byã
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 0x04);

818 i‡(!(
byã
 & 0x2)) {

819 
byã
 |= 0x02;

820 
	`wrôe_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 0x04, 
byã
);

821 
	`dbgp_¥ötk
("mmio forÉhciÉnabled\n");

828 
	`£t_fixm≠_noˇche
(
FIX_DBGP_BASE
, 
b¨_vÆ
 & 
PAGE_MASK
);

829 
ehci_b¨
 = (
__iomem
 *)
	`__fix_to_vút
(
FIX_DBGP_BASE
);

830 
ehci_b¨
 +
b¨_vÆ
 & ~
PAGE_MASK
;

831 
	`dbgp_¥ötk
("ehci_b¨: %p\n", 
ehci_b¨
);

833 
ehci_ˇps
 = 
ehci_b¨
;

834 
ehci_ªgs
 = 
ehci_b¨
 + 
	`HC_LENGTH
(
	`ªadl
(&
ehci_ˇps
->
hc_ˇpba£
));

835 
ehci_debug
 = 
ehci_b¨
 + 
off£t
;

836 
ehci_dev
.
bus
 = bus;

837 
ehci_dev
.
¶Ÿ
 = slot;

838 
ehci_dev
.
func
 = func;

840 
	`dëe˘_£t_debug_p‹t
();

842 
ªt
 = 
	`ehci_£tup
();

843 i‡(
ªt
 < 0) {

844 
	`dbgp_¥ötk
("ehci_setup failed\n");

845 
ehci_debug
 = 
NULL
;

851 
	}
}

853 
	$óæy_dbgp_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
u32
 
n
)

855 
chunk
, 
ªt
;

857 i‡(!
ehci_debug
)

859 
n
 > 0) {

860 
chunk
 = 
n
;

861 i‡(
chunk
 > 
DBGP_MAX_PACKET
)

862 
chunk
 = 
DBGP_MAX_PACKET
;

863 
ªt
 = 
	`dbgp_bulk_wrôe
(
USB_DEBUG_DEVNUM
,

864 
dbgp_ídpoöt_out
, 
°r
, 
chunk
);

865 
°r
 +
chunk
;

866 
n
 -
chunk
;

868 
	}
}

870 
c⁄sﬁe
 
	góæy_dbgp_c⁄sﬁe
 = {

871 .
«me
 = "earlydbg",

872 .
	gwrôe
 = 
óæy_dbgp_wrôe
,

873 .
	gÊags
 = 
CON_PRINTBUFFER
,

874 .
	gödex
 = -1,

879 
c⁄sﬁe
 *
	góæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

880 
__öôd©a
 
	góæy_c⁄sﬁe_öôülized
;

882 
asmlökage
 
	$óæy_¥ötk
(c⁄° *
fmt
, ...)

884 
buf
[512];

885 
n
;

886 
va_li°
 
≠
;

888 
	`va_°¨t
(
≠
, 
fmt
);

889 
n
 = 
	`vs˙¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

890 
óæy_c⁄sﬁe
->
	`wrôe
”¨ly_c⁄sﬁe, 
buf
, 
n
);

891 
	`va_íd
(
≠
);

892 
	}
}

895 
__öô
 
	$£tup_óæy_¥ötk
(*
buf
)

897 
kìp_óæy
;

899 i‡(!
buf
)

902 i‡(
óæy_c⁄sﬁe_öôülized
)

904 
óæy_c⁄sﬁe_öôülized
 = 1;

906 
kìp_óæy
 = (
	`°r°r
(
buf
, "kìp"Ë!
NULL
);

908 i‡(!
	`°∫cmp
(
buf
, "serial", 6)) {

909 
	`óæy_£rül_öô
(
buf
 + 6);

910 
óæy_c⁄sﬁe
 = &
óæy_£rül_c⁄sﬁe
;

911 } i‡(!
	`°∫cmp
(
buf
, "ttyS", 4)) {

912 
	`óæy_£rül_öô
(
buf
);

913 
óæy_c⁄sﬁe
 = &
óæy_£rül_c⁄sﬁe
;

914 } i‡(!
	`°∫cmp
(
buf
, "vga", 3)

915 && 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_isVGA
 == 1) {

916 
max_xpos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_cﬁs
;

917 
max_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_löes
;

918 
cuºít_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_y
;

919 
óæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

920 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


921 } i‡(!
	`°∫cmp
(
buf
, "dbgp", 4)) {

922 i‡(
	`óæy_dbgp_öô
(
buf
+4) < 0)

924 
óæy_c⁄sﬁe
 = &
óæy_dbgp_c⁄sﬁe
;

929 
kìp_óæy
 = 0;

931 #ifde‡
CONFIG_HVC_XEN


932 } i‡(!
	`°∫cmp
(
buf
, "xen", 3)) {

933 
óæy_c⁄sﬁe
 = &
xíboŸ_c⁄sﬁe
;

937 i‡(
kìp_óæy
)

938 
óæy_c⁄sﬁe
->
Êags
 &~
CON_BOOT
;

940 
óæy_c⁄sﬁe
->
Êags
 |
CON_BOOT
;

941 
	`ªgi°î_c⁄sﬁe
(
óæy_c⁄sﬁe
);

943 
	}
}

945 
óæy_∑øm
("óæy¥ötk", 
£tup_óæy_¥ötk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/efi.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/•ölock.h
>

34 
	~<löux/uac˚ss.h
>

35 
	~<löux/time.h
>

36 
	~<löux/io.h
>

37 
	~<löux/ªboŸ.h
>

38 
	~<löux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ˇcheÊush.h
>

44 
	~<asm/ébÊush.h
>

46 
	#EFI_DEBUG
 1

	)

47 
	#PFX
 "EFI: "

	)

49 
	gefi_íabÀd
;

50 
EXPORT_SYMBOL
(
efi_íabÀd
);

52 
efi
 
	gefi
;

53 
EXPORT_SYMBOL
(
efi
);

55 
efi_mem‹y_m≠
 
	gmemm≠
;

57 
efi
 
efi_phys
 
	g__öôd©a
;

58 
efi_sy°em_èbÀ_t
 
efi_sy°ab
 
	g__öôd©a
;

60 
__öô
 
	$£tup_n€fi
(*
¨g
)

62 
efi_íabÀd
 = 0;

64 
	}
}

65 
óæy_∑øm
("n€fi", 
£tup_n€fi
);

67 
	gadd_efi_memm≠
;

68 
EXPORT_SYMBOL
(
add_efi_memm≠
);

70 
__öô
 
	$£tup_add_efi_memm≠
(*
¨g
)

72 
add_efi_memm≠
 = 1;

74 
	}
}

75 
óæy_∑øm
("add_efi_memm≠", 
£tup_add_efi_memm≠
);

78 
efi_°©us_t
 
	$vút_efi_gë_time
(
efi_time_t
 *
tm
, 
efi_time_ˇp_t
 *
tc
)

80  
	`efi_ˇŒ_vút2
(
gë_time
, 
tm
, 
tc
);

81 
	}
}

83 
efi_°©us_t
 
	$vút_efi_£t_time
(
efi_time_t
 *
tm
)

85  
	`efi_ˇŒ_vút1
(
£t_time
, 
tm
);

86 
	}
}

88 
efi_°©us_t
 
	$vút_efi_gë_wakeup_time
(
efi_boﬁ_t
 *
íabÀd
,

89 
efi_boﬁ_t
 *
≥ndög
,

90 
efi_time_t
 *
tm
)

92  
	`efi_ˇŒ_vút3
(
gë_wakeup_time
,

93 
íabÀd
, 
≥ndög
, 
tm
);

94 
	}
}

96 
efi_°©us_t
 
	$vút_efi_£t_wakeup_time
(
efi_boﬁ_t
 
íabÀd
, 
efi_time_t
 *
tm
)

98  
	`efi_ˇŒ_vút2
(
£t_wakeup_time
,

99 
íabÀd
, 
tm
);

100 
	}
}

102 
efi_°©us_t
 
	$vút_efi_gë_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

103 
efi_guid_t
 *
víd‹
,

104 
u32
 *
©å
,

105 *
d©a_size
,

106 *
d©a
)

108  
	`efi_ˇŒ_vút5
(
gë_v¨übÀ
,

109 
«me
, 
víd‹
, 
©å
,

110 
d©a_size
, 
d©a
);

111 
	}
}

113 
efi_°©us_t
 
	$vút_efi_gë_√xt_v¨übÀ
(*
«me_size
,

114 
efi_ch¨16_t
 *
«me
,

115 
efi_guid_t
 *
víd‹
)

117  
	`efi_ˇŒ_vút3
(
gë_√xt_v¨übÀ
,

118 
«me_size
, 
«me
, 
víd‹
);

119 
	}
}

121 
efi_°©us_t
 
	$vút_efi_£t_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

122 
efi_guid_t
 *
víd‹
,

123 
©å
,

124 
d©a_size
,

125 *
d©a
)

127  
	`efi_ˇŒ_vút5
(
£t_v¨übÀ
,

128 
«me
, 
víd‹
, 
©å
,

129 
d©a_size
, 
d©a
);

130 
	}
}

132 
efi_°©us_t
 
	$vút_efi_gë_√xt_high_m⁄o_cou¡
(
u32
 *
cou¡
)

134  
	`efi_ˇŒ_vút1
(
gë_√xt_high_m⁄o_cou¡
, 
cou¡
);

135 
	}
}

137 
	$vút_efi_ª£t_sy°em
(
ª£t_ty≥
,

138 
efi_°©us_t
 
°©us
,

139 
d©a_size
,

140 
efi_ch¨16_t
 *
d©a
)

142 
	`efi_ˇŒ_vút4
(
ª£t_sy°em
, 
ª£t_ty≥
, 
°©us
,

143 
d©a_size
, 
d©a
);

144 
	}
}

146 
efi_°©us_t
 
	$vút_efi_£t_vútuÆ_addªss_m≠
(

147 
mem‹y_m≠_size
,

148 
des¸ùt‹_size
,

149 
u32
 
des¸ùt‹_vîsi⁄
,

150 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

152  
	`efi_ˇŒ_vút4
(
£t_vútuÆ_addªss_m≠
,

153 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

154 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

155 
	}
}

157 
efi_°©us_t
 
__öô
 
	$phys_efi_£t_vútuÆ_addªss_m≠
(

158 
mem‹y_m≠_size
,

159 
des¸ùt‹_size
,

160 
u32
 
des¸ùt‹_vîsi⁄
,

161 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

163 
efi_°©us_t
 
°©us
;

165 
	`efi_ˇŒ_phys_¥ñog
();

166 
°©us
 = 
	`efi_ˇŒ_phys4
(
efi_phys
.
£t_vútuÆ_addªss_m≠
,

167 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

168 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

169 
	`efi_ˇŒ_phys_ïûog
();

170  
°©us
;

171 
	}
}

173 
efi_°©us_t
 
__öô
 
	$phys_efi_gë_time
(
efi_time_t
 *
tm
,

174 
efi_time_ˇp_t
 *
tc
)

176 
efi_°©us_t
 
°©us
;

178 
	`efi_ˇŒ_phys_¥ñog
();

179 
°©us
 = 
	`efi_ˇŒ_phys2
(
efi_phys
.
gë_time
, 
tm
, 
tc
);

180 
	`efi_ˇŒ_phys_ïûog
();

181  
°©us
;

182 
	}
}

184 
	$efi_£t_πc_mmss
(
nowtime
)

186 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
;

187 
efi_°©us_t
 
°©us
;

188 
efi_time_t
 
e·
;

189 
efi_time_ˇp_t
 
ˇp
;

191 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

192 i‡(
°©us
 !
EFI_SUCCESS
) {

193 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

197 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

198 
ªÆ_möuãs
 = 
nowtime
 / 60;

199 i‡(((
	`abs
(
ªÆ_möuãs
 - 
e·
.
möuã
) + 15)/30) & 1)

200 
ªÆ_möuãs
 += 30;

201 
ªÆ_möuãs
 %= 60;

202 
e·
.
möuã
 = 
ªÆ_möuãs
;

203 
e·
.
£c⁄d
 = 
ªÆ_£c⁄ds
;

205 
°©us
 = 
efi
.
	`£t_time
(&
e·
);

206 i‡(
°©us
 !
EFI_SUCCESS
) {

207 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can't writeÅime!\n");

211 
	}
}

213 
	$efi_gë_time
()

215 
efi_°©us_t
 
°©us
;

216 
efi_time_t
 
e·
;

217 
efi_time_ˇp_t
 
ˇp
;

219 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

220 i‡(
°©us
 !
EFI_SUCCESS
)

221 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

223  
	`mktime
(
e·
.
yór
,É·.
m⁄th
,É·.
day
,É·.
hour
,

224 
e·
.
möuã
,É·.
£c⁄d
);

225 
	}
}

233 
__öô
 
	$do_add_efi_memm≠
()

235 *
p
;

237 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

238 
efi_mem‹y_desc_t
 *
md
 = 
p
;

239 
°¨t
 = 
md
->
phys_addr
;

240 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

241 
e820_ty≥
;

243 
md
->
ty≥
) {

244 
EFI_LOADER_CODE
:

245 
EFI_LOADER_DATA
:

246 
EFI_BOOT_SERVICES_CODE
:

247 
EFI_BOOT_SERVICES_DATA
:

248 
EFI_CONVENTIONAL_MEMORY
:

249 i‡(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)

250 
e820_ty≥
 = 
E820_RAM
;

252 
e820_ty≥
 = 
E820_RESERVED
;

254 
EFI_ACPI_RECLAIM_MEMORY
:

255 
e820_ty≥
 = 
E820_ACPI
;

257 
EFI_ACPI_MEMORY_NVS
:

258 
e820_ty≥
 = 
E820_NVS
;

260 
EFI_UNUSABLE_MEMORY
:

261 
e820_ty≥
 = 
E820_UNUSABLE
;

269 
e820_ty≥
 = 
E820_RESERVED
;

272 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
e820_ty≥
);

274 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

275 
	}
}

277 
__öô
 
	$efi_ª£rve_óæy
()

279 
pm≠
;

281 #ifde‡
CONFIG_X86_32


282 
pm≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
;

284 
pm≠
 = (
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
 |

285 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_hi
<<32));

287 
memm≠
.
phys_m≠
 = (*)
pm≠
;

288 
memm≠
.
ƒ_m≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_size
 /

289 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

290 
memm≠
.
desc_vîsi⁄
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_vîsi⁄
;

291 
memm≠
.
desc_size
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

292 
	`ª£rve_óæy
(
pm≠
,Öm≠ + 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
,

294 
	}
}

296 #i‡
EFI_DEBUG


297 
__öô
 
	$¥öt_efi_memm≠
()

299 
efi_mem‹y_desc_t
 *
md
;

300 *
p
;

301 
i
;

303 
p
 = 
memm≠
.
m≠
, 
i
 = 0;

304 
p
 < 
memm≠
.
m≠_íd
;

305 
p
 +
memm≠
.
desc_size
, 
i
++) {

306 
md
 = 
p
;

307 
	`¥ötk
(
KERN_INFO
 
PFX
 "mem%02u:Åype=%u,áttr=0x%llx, "

309 
i
, 
md
->
ty≥
, md->
©åibuã
, md->
phys_addr
,

310 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
),

311 (
md
->
num_∑ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

313 
	}
}

316 
__öô
 
	$efi_öô
()

318 
efi_c⁄fig_èbÀ_t
 *
c⁄fig_èbÀs
;

319 
efi_ru¡ime_£rvi˚s_t
 *
ru¡ime
;

320 
efi_ch¨16_t
 *
c16
;

321 
víd‹
[100] = "unknown";

322 
i
 = 0;

323 *
tmp
;

325 #ifde‡
CONFIG_X86_32


326 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
;

328 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)

329 (
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
 |

330 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab_hi
<<32));

333 
efi
.
sy°ab
 = 
	`óæy_i‹em≠
(()
efi_phys
.systab,

334 (
efi_sy°em_èbÀ_t
));

335 i‡(
efi
.
sy°ab
 =
NULL
)

336 
	`¥ötk
(
KERN_ERR
 "Couldn't mapÅhe EFI systemÅable!\n");

337 
	`mem˝y
(&
efi_sy°ab
, 
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

338 
	`óæy_iounm≠
(
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

339 
efi
.
sy°ab
 = &
efi_sy°ab
;

344 i‡(
efi
.
sy°ab
->
hdr
.
sig«tuª
 !
EFI_SYSTEM_TABLE_SIGNATURE
)

345 
	`¥ötk
(
KERN_ERR
 "EFI systemÅable signature incorrect!\n");

346 i‡((
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16) == 0)

347 
	`¥ötk
(
KERN_ERR
 "Warning: EFI systemÅable version "

349 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

350 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff);

355 
c16
 = 
tmp
 = 
	`óæy_i‹em≠
(
efi
.
sy°ab
->
fw_víd‹
, 2);

356 i‡(
c16
) {

357 
i
 = 0; i < (
víd‹
Ë- 1 && *
c16
; ++i)

358 
víd‹
[
i
] = *
c16
++;

359 
víd‹
[
i
] = '\0';

361 
	`¥ötk
(
KERN_ERR
 
PFX
 "CouldÇot mapÅhe firmware vendor!\n");

362 
	`óæy_iounm≠
(
tmp
, 2);

364 
	`¥ötk
(
KERN_INFO
 "EFI v%u.%.02u by %s \n",

365 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

366 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff, 
víd‹
);

371 
c⁄fig_èbÀs
 = 
	`óæy_i‹em≠
(

372 
efi
.
sy°ab
->
èbÀs
,

373 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

374 i‡(
c⁄fig_èbÀs
 =
NULL
)

375 
	`¥ötk
(
KERN_ERR
 "CouldÇot map EFI Configuration Table!\n");

377 
	`¥ötk
(
KERN_INFO
);

378 
i
 = 0; i < 
efi
.
sy°ab
->
ƒ_èbÀs
; i++) {

379 i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

380 
efi
.
mps
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

381 
	`¥ötk
(" MPS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

382 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

383 
ACPI_20_TABLE_GUID
)) {

384 
efi
.
a˝i20
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

385 
	`¥ötk
(" ACPI 2.0=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

386 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

387 
ACPI_TABLE_GUID
)) {

388 
efi
.
a˝i
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

389 
	`¥ötk
(" ACPI=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

390 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

391 
SMBIOS_TABLE_GUID
)) {

392 
efi
.
smbios
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

393 
	`¥ötk
(" SMBIOS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

394 #ifde‡
CONFIG_X86_UV


395 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

396 
UV_SYSTEM_TABLE_GUID
)) {

397 
efi
.
uv_sy°ab
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

398 
	`¥ötk
(" UVsy°ab=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

400 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

401 
HCDP_TABLE_GUID
)) {

402 
efi
.
hcdp
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

403 
	`¥ötk
(" HCDP=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

404 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

405 
UGA_IO_PROTOCOL_GUID
)) {

406 
efi
.
uga
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

407 
	`¥ötk
(" UGA=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

410 
	`¥ötk
("\n");

411 
	`óæy_iounm≠
(
c⁄fig_èbÀs
,

412 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

420 
ru¡ime
 = 
	`óæy_i‹em≠
(()
efi
.
sy°ab
->runtime,

421 (
efi_ru¡ime_£rvi˚s_t
));

422 i‡(
ru¡ime
 !
NULL
) {

428 
efi_phys
.
gë_time
 = (
efi_gë_time_t
 *)
ru¡ime
->get_time;

429 
efi_phys
.
£t_vútuÆ_addªss_m≠
 =

430 (
efi_£t_vútuÆ_addªss_m≠_t
 *)

431 
ru¡ime
->
£t_vútuÆ_addªss_m≠
;

436 
efi
.
gë_time
 = 
phys_efi_gë_time
;

438 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFIÑuntime service "

440 
	`óæy_iounm≠
(
ru¡ime
, (
efi_ru¡ime_£rvi˚s_t
));

443 
memm≠
.
m≠
 = 
	`óæy_i‹em≠
(()memm≠.
phys_m≠
,

444 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
);

445 i‡(
memm≠
.
m≠
 =
NULL
)

446 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFI memory map!\n");

447 
memm≠
.
m≠_íd
 = memm≠.
m≠
 + (memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

449 i‡(
memm≠
.
desc_size
 !(
efi_mem‹y_desc_t
))

450 
	`¥ötk
(
KERN_WARNING


453 i‡(
add_efi_memm≠
)

454 
	`do_add_efi_memm≠
();

457 
ªboŸ_ty≥
 = 
BOOT_EFI
;

459 #i‡
EFI_DEBUG


460 
	`¥öt_efi_memm≠
();

462 
	}
}

464 
__öô
 
	$ru¡ime_code_∑ge_mkexec
()

466 
efi_mem‹y_desc_t
 *
md
;

467 *
p
;

468 
u64
 
addr
, 
≈ages
;

471 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

472 
md
 = 
p
;

474 i‡(
md
->
ty≥
 !
EFI_RUNTIME_SERVICES_CODE
)

477 
addr
 = 
md
->
vút_addr
;

478 
≈ages
 = 
md
->
num_∑ges
;

479 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

480 
	`£t_mem‹y_x
(
addr
, 
≈ages
);

482 
	}
}

492 
__öô
 
	$efi_íãr_vútuÆ_mode
()

494 
efi_mem‹y_desc_t
 *
md
;

495 
efi_°©us_t
 
°©us
;

496 
size
;

497 
u64
 
íd
, 
sy°ab
, 
addr
, 
≈ages
, 
íd_p‚
;

498 *
p
, *
va
;

500 
efi
.
sy°ab
 = 
NULL
;

501 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

502 
md
 = 
p
;

503 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_RUNTIME
))

506 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

507 
íd
 = 
md
->
phys_addr
 + 
size
;

509 
íd_p‚
 = 
	`PFN_UP
(
íd
);

510 i‡(
íd_p‚
 <
max_low_p‚_m≠≥d


511 || (
íd_p‚
 > (1UL << (32 - 
PAGE_SHIFT
))

512 && 
íd_p‚
 <
max_p‚_m≠≥d
))

513 
va
 = 
	`__va
(
md
->
phys_addr
);

515 
va
 = 
	`efi_i‹em≠
(
md
->
phys_addr
, 
size
, md->
ty≥
);

517 
md
->
vút_addr
 = (
u64
Ë(Ë
va
;

519 i‡(!
va
) {

520 
	`¥ötk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

521 ()
md
->
phys_addr
);

525 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)) {

526 
addr
 = 
md
->
vút_addr
;

527 
≈ages
 = 
md
->
num_∑ges
;

528 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

529 
	`£t_mem‹y_uc
(
addr
, 
≈ages
);

532 
sy°ab
 = (
u64
Ë(Ë
efi_phys
.systab;

533 i‡(
md
->
phys_addr
 <
sy°ab
 && sy°ab < 
íd
) {

534 
sy°ab
 +
md
->
vút_addr
 - md->
phys_addr
;

535 
efi
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *) () systab;

539 
	`BUG_ON
(!
efi
.
sy°ab
);

541 
°©us
 = 
	`phys_efi_£t_vútuÆ_addªss_m≠
(

542 
memm≠
.
desc_size
 * memm≠.
ƒ_m≠
,

543 
memm≠
.
desc_size
,

544 
memm≠
.
desc_vîsi⁄
,

545 
memm≠
.
phys_m≠
);

547 i‡(
°©us
 !
EFI_SUCCESS
) {

548 
	`¥ötk
(
KERN_ALERT
 "UnableÅo switch EFI into virtual mode "

549 "(°©us=%lx)!\n", 
°©us
);

550 
	`∑nic
("EFI callÅo SetVirtualAddressMap() failed!");

559 
efi
.
gë_time
 = 
vút_efi_gë_time
;

560 
efi
.
£t_time
 = 
vút_efi_£t_time
;

561 
efi
.
gë_wakeup_time
 = 
vút_efi_gë_wakeup_time
;

562 
efi
.
£t_wakeup_time
 = 
vút_efi_£t_wakeup_time
;

563 
efi
.
gë_v¨übÀ
 = 
vút_efi_gë_v¨übÀ
;

564 
efi
.
gë_√xt_v¨übÀ
 = 
vút_efi_gë_√xt_v¨übÀ
;

565 
efi
.
£t_v¨übÀ
 = 
vút_efi_£t_v¨übÀ
;

566 
efi
.
gë_√xt_high_m⁄o_cou¡
 = 
vút_efi_gë_√xt_high_m⁄o_cou¡
;

567 
efi
.
ª£t_sy°em
 = 
vút_efi_ª£t_sy°em
;

568 
efi
.
£t_vútuÆ_addªss_m≠
 = 
vút_efi_£t_vútuÆ_addªss_m≠
;

569 i‡(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
)

570 
	`ru¡ime_code_∑ge_mkexec
();

571 
	`óæy_iounm≠
(
memm≠
.
m≠
, memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

572 
memm≠
.
m≠
 = 
NULL
;

573 
	}
}

578 
u32
 
	$efi_mem_ty≥
(
phys_addr
)

580 
efi_mem‹y_desc_t
 *
md
;

581 *
p
;

583 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

584 
md
 = 
p
;

585 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

586 (
phys_addr
 < (
md
->phys_addr +

587 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

588  
md
->
ty≥
;

591 
	}
}

593 
u64
 
	$efi_mem_©åibuãs
(
phys_addr
)

595 
efi_mem‹y_desc_t
 *
md
;

596 *
p
;

598 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

599 
md
 = 
p
;

600 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

601 (
phys_addr
 < (
md
->phys_addr +

602 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

603  
md
->
©åibuã
;

606 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/efi.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/ªboŸ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/fixm≠.h
>

41 
pgd_t
 
ßve_pgd
 
	g__öôd©a
;

42 
efi_Êags
 
	g__öôd©a
;

44 
__öô
 
	$óæy_m≠pög_£t_exec
(
°¨t
,

45 
íd
,

46 
execuèbÀ
)

48 
num_∑ges
;

50 
°¨t
 &
PMD_MASK
;

51 
íd
 = (íd + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

52 
num_∑ges
 = (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

53 i‡(
execuèbÀ
)

54 
	`£t_mem‹y_x
(()
	`__va
(
°¨t
), 
num_∑ges
);

56 
	`£t_mem‹y_nx
(()
	`__va
(
°¨t
), 
num_∑ges
);

57 
	}
}

59 
__öô
 
	$óæy_ru¡ime_code_m≠pög_£t_exec
(
execuèbÀ
)

61 
efi_mem‹y_desc_t
 *
md
;

62 *
p
;

64 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

69 
md
 = 
p
;

70 i‡(
md
->
ty≥
 =
EFI_RUNTIME_SERVICES_CODE
) {

71 
íd
;

72 
íd
 = 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
);

73 
	`óæy_m≠pög_£t_exec
(
md
->
phys_addr
, 
íd
, 
execuèbÀ
);

76 
	}
}

78 
__öô
 
	$efi_ˇŒ_phys_¥ñog
()

80 
vaddªss
;

82 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(1);

83 
	`loˇl_úq_ßve
(
efi_Êags
);

84 
vaddªss
 = ()
	`__va
(0x0UL);

85 
ßve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vaddªss
));

87 
	`__Êush_éb_Æl
();

88 
	}
}

90 
__öô
 
	$efi_ˇŒ_phys_ïûog
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
ßve_pgd
);

96 
	`__Êush_éb_Æl
();

97 
	`loˇl_úq_ª°‹e
(
efi_Êags
);

98 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__öô
 
	$efi_i‹em≠
(
phys_addr
, 
size
,

102 
u32
 
ty≥
)

104 
œ°_m≠_p‚
;

106 i‡(
ty≥
 =
EFI_MEMORY_MAPPED_IO
)

107  
	`i‹em≠
(
phys_addr
, 
size
);

109 
œ°_m≠_p‚
 = 
	`öô_mem‹y_m≠pög
(
phys_addr
,Öhys_add∏+ 
size
);

110 i‡((
œ°_m≠_p‚
 << 
PAGE_SHIFT
Ë< 
phys_addr
 + 
size
)

111  
NULL
;

113  (
__iomem
 *)
	`__va
(
phys_addr
);

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/öô.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__öô
 
	$ª£rve_ebda_ªgi⁄
()

21 
lowmem
, 
ebda_addr
;

29 i‡(
	`∑øvút_íabÀd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`gë_bios_ebda
();

41 i‡((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 i‡((
ebda_addr
 =0Ë&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 i‡((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`ª£rve_óæy_ovîœp_ok
(
lowmem
, 0x100000, "BIOSÑeserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<löux/öô.h
>

8 
	~<löux/lökage.h
>

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/≥r˝u.h
>

13 
	~<löux/°¨t_kî√l.h
>

14 
	~<löux/io.h
>

16 
	~<asm/¥o˚ss‹.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/£˘i⁄s.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/bios_ebda.h
>

27 
	~<asm/åampﬁöe.h
>

29 
__öô
 
	$z≠_idítôy_m≠pögs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_˛ór
(
pgd
);

33 
	`__Êush_éb_Æl
();

34 
	}
}

38 
__öô
 
	$˛ór_bss
()

40 
	`mem£t
(
__bss_°¨t
, 0,

41 (Ë
__bss_°›
 - (Ë
__bss_°¨t
);

42 
	}
}

44 
__öô
 
	$c›y_boŸd©a
(*
ªÆ_mode_d©a
)

46 * 
comm™d_löe
;

48 
	`mem˝y
(&
boŸ_∑øms
, 
ªÆ_mode_d©a
,  boot_params);

49 i‡(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
) {

50 
comm™d_löe
 = 
	`__va
(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
);

51 
	`mem˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__öô
 
	$x86_64_°¨t_kî√l
(* 
ªÆ_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1Ë& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vút
(
__íd_of_fixed_addªs£s
Ë<
MODULES_END
);

74 
	`˛ór_bss
();

77 
	`z≠_idítôy_m≠pögs
();

80 
	`˛ónup_highm≠
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifde‡
CONFIG_EARLY_PRINTK


84 
	`£t_öå_g©e
(
i
, &
óæy_idt_h™dÀrs
[i]);

86 
	`£t_öå_g©e
(
i
, 
óæy_idt_h™dÀr
);

89 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

91 i‡(
c⁄sﬁe_logÀvñ
 == 10)

92 
	`óæy_¥ötk
("Kernelálive\n");

94 
	`x86_64_°¨t_ª£rv©i⁄s
(
ªÆ_mode_d©a
);

95 
	}
}

97 
__öô
 
	$x86_64_°¨t_ª£rv©i⁄s
(*
ªÆ_mode_d©a
)

99 
	`c›y_boŸd©a
(
	`__va
(
ªÆ_mode_d©a
));

101 
	`ª£rve_åampﬁöe_mem‹y
();

103 
	`ª£rve_óæy
(
	`__∑_symbﬁ
(&
_ãxt
), __∑_symbﬁ(&
__bss_°›
), "TEXT DATA BSS");

105 #ifde‡
CONFIG_BLK_DEV_INITRD


107 i‡(
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 && boŸ_∑øms.hdr.
ømdisk_image
) {

108 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

109 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

110 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

111 
	`ª£rve_óæy
(
ømdisk_image
, 
ømdisk_íd
, "RAMDISK");

115 
	`ª£rve_ebda_ªgi⁄
();

123 
	`°¨t_kî√l
();

124 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<löux/˛ocksour˚.h
>

2 
	~<löux/˛ockchùs.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/sysdev.h
>

5 
	~<löux/dñay.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/h≥t.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/˝u.h
>

10 
	~<löux/pm.h
>

11 
	~<löux/io.h
>

13 
	~<asm/fixm≠.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/h≥t.h
>

17 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

18 
	#HPET_SHIFT
 22

	)

22 
	#FSEC_PER_NSEC
 1000000L

	)

24 
	#HPET_DEV_USED_BIT
 2

	)

25 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

26 
	#HPET_DEV_VALID
 0x8

	)

27 
	#HPET_DEV_FSB_CAP
 0x1000

	)

28 
	#HPET_DEV_PERI_CAP
 0x2000

	)

30 
	#EVT_TO_HPET_DEV
(
evt
Ë
	`c⁄èöî_of
”vt, 
h≥t_dev
,Évt)

	)

35 
	gh≥t_addªss
;

36 #ifde‡
CONFIG_PCI_MSI


37 
	gh≥t_num_timîs
;

39 
__iomem
 *
	gh≥t_vút_addªss
;

41 
	sh≥t_dev
 {

42 
˛ock_evít_devi˚
 
	mevt
;

43 
	mnum
;

44 
	m˝u
;

45 
	múq
;

46 
	mÊags
;

47 
	m«me
[10];

50 
	$h≥t_ªadl
(
a
)

52  
	`ªadl
(
h≥t_vút_addªss
 + 
a
);

53 
	}
}

55 
ölöe
 
	$h≥t_wrôñ
(
d
, 
a
)

57 
	`wrôñ
(
d
, 
h≥t_vút_addªss
 + 
a
);

58 
	}
}

60 #ifde‡
CONFIG_X86_64


61 
	~<asm/pgèbÀ.h
>

64 
ölöe
 
	$h≥t_£t_m≠pög
()

66 
h≥t_vút_addªss
 = 
	`i‹em≠_noˇche
(
h≥t_addªss
, 
HPET_MMAP_SIZE
);

67 #ifde‡
CONFIG_X86_64


68 
	`__£t_fixm≠
(
VSYSCALL_HPET
, 
h≥t_addªss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

70 
	}
}

72 
ölöe
 
	$h≥t_˛ór_m≠pög
()

74 
	`iounm≠
(
h≥t_vút_addªss
);

75 
h≥t_vút_addªss
 = 
NULL
;

76 
	}
}

81 
	gboŸ_h≥t_dißbÀ
;

82 
	gh≥t_f‹˚_u£r
;

83 
	gh≥t_vîbo£
;

85 
__öô
 
	$h≥t_£tup
(*
°r
)

87 i‡(
°r
) {

88 i‡(!
	`°∫cmp
("dißbÀ", 
°r
, 7))

89 
boŸ_h≥t_dißbÀ
 = 1;

90 i‡(!
	`°∫cmp
("f‹˚", 
°r
, 5))

91 
h≥t_f‹˚_u£r
 = 1;

92 i‡(!
	`°∫cmp
("vîbo£", 
°r
, 7))

93 
h≥t_vîbo£
 = 1;

96 
	}
}

97 
__£tup
("h≥t=", 
h≥t_£tup
);

99 
__öô
 
	$dißbÀ_h≥t
(*
°r
)

101 
boŸ_h≥t_dißbÀ
 = 1;

103 
	}
}

104 
__£tup
("noh≥t", 
dißbÀ_h≥t
);

106 
ölöe
 
	$is_h≥t_ˇ∑bÀ
()

108  !
boŸ_h≥t_dißbÀ
 && 
h≥t_addªss
;

109 
	}
}

114 
	gh≥t_Àgacy_öt_íabÀd
;

119 
	$is_h≥t_íabÀd
()

121  
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_Àgacy_öt_íabÀd
;

122 
	}
}

123 
EXPORT_SYMBOL_GPL
(
is_h≥t_íabÀd
);

125 
	$_h≥t_¥öt_c⁄fig
(c⁄° *
fun˘i⁄
, 
löe
)

127 
u32
 
i
, 
timîs
, 
l
, 
h
;

128 
	`¥ötk
(
KERN_INFO
 "h≥t: %s(%d):\n", 
fun˘i⁄
, 
löe
);

129 
l
 = 
	`h≥t_ªadl
(
HPET_ID
);

130 
h
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

131 
timîs
 = ((
l
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

132 
	`¥ötk
(
KERN_INFO
 "h≥t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

133 
l
 = 
	`h≥t_ªadl
(
HPET_CFG
);

134 
h
 = 
	`h≥t_ªadl
(
HPET_STATUS
);

135 
	`¥ötk
(
KERN_INFO
 "h≥t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

136 
l
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

137 
h
 = 
	`h≥t_ªadl
(
HPET_COUNTER
+4);

138 
	`¥ötk
(
KERN_INFO
 "h≥t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

140 
i
 = 0; i < 
timîs
; i++) {

141 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

142 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
)+4);

143 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

144 
i
, 
l
, 
h
);

145 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
));

146 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
)+4);

147 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

148 
i
, 
l
, 
h
);

149 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
));

150 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
)+4);

151 
	`¥ötk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

152 
i
, 
l
, 
h
);

154 
	}
}

156 
	#h≥t_¥öt_c⁄fig
() \

158 i‡(
h≥t_vîbo£
) \

159 
	`_h≥t_¥öt_c⁄fig
(
__FUNCTION__
, 
__LINE__
); \

160 } 0)

	)

166 #ifde‡
CONFIG_HPET


168 
h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
);

170 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
)

172 
h≥t
 
__iomem
 *h≥à
h≥t_vút_addªss
;

173 
h≥t_timî
 
__iomem
 *
timî
 = &
h≥t
->
h≥t_timîs
[2];

174 
ƒtimîs
, 
i
;

175 
h≥t_d©a
 
hd
;

177 
ƒtimîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

179 
	`mem£t
(&
hd
, 0, (hd));

180 
hd
.
hd_phys_addªss
 = 
h≥t_addªss
;

181 
hd
.
hd_addªss
 = 
h≥t
;

182 
hd
.
hd_núqs
 = 
ƒtimîs
;

183 
	`h≥t_ª£rve_timî
(&
hd
, 0);

185 #ifde‡
CONFIG_HPET_EMULATE_RTC


186 
	`h≥t_ª£rve_timî
(&
hd
, 1);

194 
hd
.
hd_úq
[0] = 
HPET_LEGACY_8254
;

195 
hd
.
hd_úq
[1] = 
HPET_LEGACY_RTC
;

197 
i
 = 2; i < 
ƒtimîs
; 
timî
++, i++) {

198 
hd
.
hd_úq
[
i
] = (
	`ªadl
(&
timî
->
h≥t_c⁄fig
) &

199 
Tn_INT_ROUTE_CNF_MASK
Ë>> 
Tn_INT_ROUTE_CNF_SHIFT
;

202 
	`h≥t_ª£rve_msi_timîs
(&
hd
);

204 
	`h≥t_Æloc
(&
hd
);

206 
	}
}

208 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
Ë{ 
	}
}

214 
	gh≥t_≥riod
;

216 
h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

217 
˛ock_evít_devi˚
 *
evt
);

218 
h≥t_Àgacy_√xt_evít
(
dñè
,

219 
˛ock_evít_devi˚
 *
evt
);

224 
˛ock_evít_devi˚
 
	gh≥t_˛ockevít
 = {

225 .
«me
 = "hpet",

226 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

227 .
	g£t_mode
 = 
h≥t_Àgacy_£t_mode
,

228 .
	g£t_√xt_evít
 = 
h≥t_Àgacy_√xt_evít
,

229 .
	gshi·
 = 32,

230 .
	gúq
 = 0,

231 .
	gøtög
 = 50,

234 
	$h≥t_°›_cou¡î
()

236 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

237 
cfg
 &~
HPET_CFG_ENABLE
;

238 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

239 
	}
}

241 
	$h≥t_ª£t_cou¡î
()

243 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
);

244 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
 + 4);

245 
	}
}

247 
	$h≥t_°¨t_cou¡î
()

249 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

250 
cfg
 |
HPET_CFG_ENABLE
;

251 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

252 
	}
}

254 
	$h≥t_ª°¨t_cou¡î
()

256 
	`h≥t_°›_cou¡î
();

257 
	`h≥t_ª£t_cou¡î
();

258 
	`h≥t_°¨t_cou¡î
();

259 
	}
}

261 
	$h≥t_ªsume_devi˚
()

263 
	`f‹˚_h≥t_ªsume
();

264 
	}
}

266 
	$h≥t_ªsume_cou¡î
()

268 
	`h≥t_ªsume_devi˚
();

269 
	`h≥t_ª°¨t_cou¡î
();

270 
	}
}

272 
	$h≥t_íabÀ_Àgacy_öt
()

274 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

276 
cfg
 |
HPET_CFG_LEGACY
;

277 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

278 
h≥t_Àgacy_öt_íabÀd
 = 1;

279 
	}
}

281 
	$h≥t_Àgacy_˛ockevít_ªgi°î
()

284 
	`h≥t_íabÀ_Àgacy_öt
();

294 
h≥t_˛ockevít
.
mu…
 = 
	`div_sc
((Ë
FSEC_PER_NSEC
,

295 
h≥t_≥riod
, 
h≥t_˛ockevít
.
shi·
);

297 
h≥t_˛ockevít
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,

298 &
h≥t_˛ockevít
);

300 
h≥t_˛ockevít
.
mö_dñè_ns
 = 5000;

306 
h≥t_˛ockevít
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

307 
	`˛ockevíts_ªgi°î_devi˚
(&
h≥t_˛ockevít
);

308 
globÆ_˛ock_evít
 = &
h≥t_˛ockevít
;

309 
	`¥ötk
(
KERN_DEBUG
 "hpet clockeventÑegistered\n");

310 
	}
}

312 
h≥t_£tup_msi_úq
(
úq
);

314 
	$h≥t_£t_mode
(
˛ock_evít_mode
 
mode
,

315 
˛ock_evít_devi˚
 *
evt
, 
timî
)

317 
cfg
, 
cmp
, 
now
;

318 
uöt64_t
 
dñè
;

320 
mode
) {

321 
CLOCK_EVT_MODE_PERIODIC
:

322 
	`h≥t_°›_cou¡î
();

323 
dñè
 = ((
uöt64_t
)(
NSEC_PER_SEC
/
HZ
)Ë* 
evt
->
mu…
;

324 
dñè
 >>
evt
->
shi·
;

325 
now
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

326 
cmp
 = 
now
 + (Ë
dñè
;

327 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

329 
cfg
 &~
HPET_TN_LEVEL
;

330 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

331 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

332 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

333 
	`h≥t_wrôñ
(
cmp
, 
	`HPET_Tn_CMP
(
timî
));

334 
	`udñay
(1);

342 
	`h≥t_wrôñ
((Ë
dñè
, 
	`HPET_Tn_CMP
(
timî
));

343 
	`h≥t_°¨t_cou¡î
();

344 
	`h≥t_¥öt_c⁄fig
();

347 
CLOCK_EVT_MODE_ONESHOT
:

348 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

349 
cfg
 &~
HPET_TN_PERIODIC
;

350 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

351 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

354 
CLOCK_EVT_MODE_UNUSED
:

355 
CLOCK_EVT_MODE_SHUTDOWN
:

356 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

357 
cfg
 &~
HPET_TN_ENABLE
;

358 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

361 
CLOCK_EVT_MODE_RESUME
:

362 i‡(
timî
 == 0) {

363 
	`h≥t_íabÀ_Àgacy_öt
();

365 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

366 
	`h≥t_£tup_msi_úq
(
hdev
->
úq
);

367 
	`dißbÀ_úq
(
hdev
->
úq
);

368 
	`úq_£t_afföôy
(
hdev
->
úq
, 
	`˝umask_of
(hdev->
˝u
));

369 
	`íabÀ_úq
(
hdev
->
úq
);

371 
	`h≥t_¥öt_c⁄fig
();

374 
	}
}

376 
	$h≥t_√xt_evít
(
dñè
,

377 
˛ock_evít_devi˚
 *
evt
, 
timî
)

379 
u32
 
˙t
;

381 
˙t
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

382 
˙t
 +(
u32
Ë
dñè
;

383 
	`h≥t_wrôñ
(
˙t
, 
	`HPET_Tn_CMP
(
timî
));

390 
	`WARN_ON_ONCE
((
u32
)
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
)Ë!
˙t
);

392  (
s32
)((
u32
)
	`h≥t_ªadl
(
HPET_COUNTER
Ë- 
˙t
Ë>0 ? -
ETIME
 : 0;

393 
	}
}

395 
	$h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

396 
˛ock_evít_devi˚
 *
evt
)

398 
	`h≥t_£t_mode
(
mode
, 
evt
, 0);

399 
	}
}

401 
	$h≥t_Àgacy_√xt_evít
(
dñè
,

402 
˛ock_evít_devi˚
 *
evt
)

404  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 0);

405 
	}
}

410 #ifde‡
CONFIG_PCI_MSI


412 
DEFINE_PER_CPU
(
h≥t_dev
 *, 
˝u_h≥t_dev
);

413 
h≥t_dev
 *
	gh≥t_devs
;

415 
	$h≥t_msi_unmask
(
úq
)

417 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

418 
cfg
;

421 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

422 
cfg
 |
HPET_TN_FSB
;

423 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

424 
	}
}

426 
	$h≥t_msi_mask
(
úq
)

428 
cfg
;

429 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

432 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

433 
cfg
 &~
HPET_TN_FSB
;

434 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

435 
	}
}

437 
	$h≥t_msi_wrôe
(
úq
, 
msi_msg
 *
msg
)

439 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

441 
	`h≥t_wrôñ
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

442 
	`h≥t_wrôñ
(
msg
->
addªss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

443 
	}
}

445 
	$h≥t_msi_ªad
(
úq
, 
msi_msg
 *
msg
)

447 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

449 
msg
->
d©a
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

450 
msg
->
addªss_lo
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

451 
msg
->
addªss_hi
 = 0;

452 
	}
}

454 
	$h≥t_msi_£t_mode
(
˛ock_evít_mode
 
mode
,

455 
˛ock_evít_devi˚
 *
evt
)

457 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

458 
	`h≥t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

459 
	}
}

461 
	$h≥t_msi_√xt_evít
(
dñè
,

462 
˛ock_evít_devi˚
 *
evt
)

464 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

465  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 
hdev
->
num
);

466 
	}
}

468 
	$h≥t_£tup_msi_úq
(
úq
)

470 i‡(
	`¨ch_£tup_h≥t_msi
(
úq
)) {

471 
	`de°roy_úq
(
úq
);

472  -
EINVAL
;

475 
	}
}

477 
	$h≥t_assign_úq
(
h≥t_dev
 *
dev
)

479 
úq
;

481 
úq
 = 
	`¸óã_úq
();

482 i‡(!
úq
)

483  -
EINVAL
;

485 
	`£t_úq_d©a
(
úq
, 
dev
);

487 i‡(
	`h≥t_£tup_msi_úq
(
úq
))

488  -
EINVAL
;

490 
dev
->
úq
 = irq;

492 
	}
}

494 
úqªtu∫_t
 
	$h≥t_öãºu±_h™dÀr
(
úq
, *
d©a
)

496 
h≥t_dev
 *
dev
 = (h≥t_dev *)
d©a
;

497 
˛ock_evít_devi˚
 *
hevt
 = &
dev
->
evt
;

499 i‡(!
hevt
->
evít_h™dÀr
) {

500 
	`¥ötk
(
KERN_INFO
 "Spurious HPETÅimer interrupt on HPETÅimer %d\n",

501 
dev
->
num
);

502  
IRQ_HANDLED
;

505 
hevt
->
	`evít_h™dÀr
(hevt);

506  
IRQ_HANDLED
;

507 
	}
}

509 
	$h≥t_£tup_úq
(
h≥t_dev
 *
dev
)

512 i‡(
	`ªque°_úq
(
dev
->
úq
, 
h≥t_öãºu±_h™dÀr
,

513 
IRQF_TIMER
 | 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
,

514 
dev
->
«me
, dev))

517 
	`dißbÀ_úq
(
dev
->
úq
);

518 
	`úq_£t_afföôy
(
dev
->
úq
, 
	`˝umask_of
(dev->
˝u
));

519 
	`íabÀ_úq
(
dev
->
úq
);

521 
	`¥ötk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

522 
dev
->
«me
, dev->
úq
);

525 
	}
}

528 
	$öô_⁄e_h≥t_msi_˛ockevít
(
h≥t_dev
 *
hdev
, 
˝u
)

530 
˛ock_evít_devi˚
 *
evt
 = &
hdev
->evt;

531 
uöt64_t
 
h≥t_‰eq
;

533 
	`WARN_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

534 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

537 i‡(
	`h≥t_£tup_msi_úq
(
hdev
->
úq
))

540 
hdev
->
˝u
 = cpu;

541 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
hdev
;

542 
evt
->
«me
 = 
hdev
->name;

543 
	`h≥t_£tup_úq
(
hdev
);

544 
evt
->
úq
 = 
hdev
->irq;

546 
evt
->
øtög
 = 110;

547 
evt
->
„©uªs
 = 
CLOCK_EVT_FEAT_ONESHOT
;

548 i‡(
hdev
->
Êags
 & 
HPET_DEV_PERI_CAP
)

549 
evt
->
„©uªs
 |
CLOCK_EVT_FEAT_PERIODIC
;

551 
evt
->
£t_mode
 = 
h≥t_msi_£t_mode
;

552 
evt
->
£t_√xt_evít
 = 
h≥t_msi_√xt_evít
;

553 
evt
->
shi·
 = 32;

560 
h≥t_‰eq
 = 1000000000000000ULL;

561 
	`do_div
(
h≥t_‰eq
, 
h≥t_≥riod
);

562 
evt
->
mu…
 = 
	`div_sc
((Ë
h≥t_‰eq
,

563 
NSEC_PER_SEC
, 
evt
->
shi·
);

565 
evt
->
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,Évt);

567 
evt
->
mö_dñè_ns
 = 5000;

569 
evt
->
˝umask
 = 
	`˝umask_of
(
hdev
->
˝u
);

570 
	`˛ockevíts_ªgi°î_devi˚
(
evt
);

571 
	}
}

573 #ifde‡
CONFIG_HPET


575 
	#RESERVE_TIMERS
 1

	)

577 
	#RESERVE_TIMERS
 0

	)

580 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

582 
id
;

583 
num_timîs
;

584 
num_timîs_u£d
 = 0;

585 
i
;

587 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

589 
num_timîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
);

590 
num_timîs
++;

591 
	`h≥t_¥öt_c⁄fig
();

593 
h≥t_devs
 = 
	`kzÆloc
((
h≥t_dev
Ë* 
num_timîs
, 
GFP_KERNEL
);

594 i‡(!
h≥t_devs
)

597 
h≥t_num_timîs
 = 
num_timîs
;

599 
i
 = 
°¨t_timî
; i < 
num_timîs
 - 
RESERVE_TIMERS
; i++) {

600 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
num_timîs_u£d
];

601 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

604 i‡(!(
cfg
 & 
HPET_TN_FSB_CAP
))

607 
hdev
->
Êags
 = 0;

608 i‡(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

609 
hdev
->
Êags
 |
HPET_DEV_PERI_CAP
;

610 
hdev
->
num
 = 
i
;

612 
	`•rötf
(
hdev
->
«me
, "h≥t%d", 
i
);

613 i‡(
	`h≥t_assign_úq
(
hdev
))

616 
hdev
->
Êags
 |
HPET_DEV_FSB_CAP
;

617 
hdev
->
Êags
 |
HPET_DEV_VALID
;

618 
num_timîs_u£d
++;

619 i‡(
num_timîs_u£d
 =
	`num_possibÀ_˝us
())

623 
	`¥ötk
(
KERN_INFO
 "HPET: %dÅimers inÅotal, %dÅimers will be used forÖer-cpuÅimer\n",

624 
num_timîs
, 
num_timîs_u£d
);

625 
	}
}

627 #ifde‡
CONFIG_HPET


628 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

630 
i
;

632 i‡(!
h≥t_devs
)

635 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

636 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

638 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

641 
hd
->
hd_úq
[
hdev
->
num
] = hdev->
úq
;

642 
	`h≥t_ª£rve_timî
(
hd
, 
hdev
->
num
);

644 
	}
}

647 
h≥t_dev
 *
	$h≥t_gë_unu£d_timî
()

649 
i
;

651 i‡(!
h≥t_devs
)

652  
NULL
;

654 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

655 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

657 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

659 i‡(
	`ã°_™d_£t_bô
(
HPET_DEV_USED_BIT
,

660 (*)&
hdev
->
Êags
))

662  
hdev
;

664  
NULL
;

665 
	}
}

667 
	sh≥t_w‹k_°ru˘
 {

668 
dñayed_w‹k
 
	mw‹k
;

669 
com∂ëi⁄
 
	mcom∂ëe
;

672 
	$h≥t_w‹k
(
w‹k_°ru˘
 *
w
)

674 
h≥t_dev
 *
hdev
;

675 
˝u
 = 
	`smp_¥o˚ss‹_id
();

676 
h≥t_w‹k_°ru˘
 *
h≥t_w‹k
;

678 
h≥t_w‹k
 = 
	`c⁄èöî_of
(
w
, 
h≥t_w‹k_°ru˘
, 
w‹k
.work);

680 
hdev
 = 
	`h≥t_gë_unu£d_timî
();

681 i‡(
hdev
)

682 
	`öô_⁄e_h≥t_msi_˛ockevít
(
hdev
, 
˝u
);

684 
	`com∂ëe
(&
h≥t_w‹k
->
com∂ëe
);

685 
	}
}

687 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

688 
a˘i⁄
, *
h˝u
)

690 
˝u
 = ()
h˝u
;

691 
h≥t_w‹k_°ru˘
 
w‹k
;

692 
h≥t_dev
 *
hdev
 = 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
);

694 
a˘i⁄
 & 0xf) {

695 
CPU_ONLINE
:

696 
	`INIT_DELAYED_WORK_ON_STACK
(&
w‹k
.w‹k, 
h≥t_w‹k
);

697 
	`öô_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

699 
	`scheduÀ_dñayed_w‹k_⁄
(
˝u
, &
w‹k
.work, 0);

700 
	`waô_f‹_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

701 
	`de°roy_timî_⁄_°ack
(&
w‹k
.w‹k.
timî
);

703 
CPU_DEAD
:

704 i‡(
hdev
) {

705 
	`‰ì_úq
(
hdev
->
úq
, hdev);

706 
hdev
->
Êags
 &~
HPET_DEV_USED
;

707 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
NULL
;

711  
NOTIFY_OK
;

712 
	}
}

715 
	$h≥t_£tup_msi_úq
(
úq
)

718 
	}
}

719 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

722 
	}
}

724 #ifde‡
CONFIG_HPET


725 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

728 
	}
}

731 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

732 
a˘i⁄
, *
h˝u
)

734  
NOTIFY_OK
;

735 
	}
}

742 
cy˛e_t
 
	$ªad_h≥t
(
˛ocksour˚
 *
cs
)

744  (
cy˛e_t
)
	`h≥t_ªadl
(
HPET_COUNTER
);

745 
	}
}

747 #ifde‡
CONFIG_X86_64


748 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_h≥t
()

750  
	`ªadl
((c⁄° 
__iomem
 *)
	`fix_to_vút
(
VSYSCALL_HPET
) + 0xf0);

751 
	}
}

754 
˛ocksour˚
 
	g˛ocksour˚_h≥t
 = {

755 .
«me
 = "hpet",

756 .
	gøtög
 = 250,

757 .
	gªad
 = 
ªad_h≥t
,

758 .
	gmask
 = 
HPET_MASK
,

759 .
	gshi·
 = 
HPET_SHIFT
,

760 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

761 .
	gªsume
 = 
h≥t_ªsume_cou¡î
,

762 #ifde‡
CONFIG_X86_64


763 .
	gvªad
 = 
vªad_h≥t
,

767 
	$h≥t_˛ocksour˚_ªgi°î
()

769 
u64
 
°¨t
, 
now
;

770 
cy˛e_t
 
t1
;

773 
	`h≥t_ª°¨t_cou¡î
();

776 
t1
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

777 
	`rdts˛l
(
°¨t
);

786 
	`ªp_n›
();

787 
	`rdts˛l
(
now
);

788 } (
now
 - 
°¨t
) < 200000UL);

790 i‡(
t1
 =
	`h≥t_ªadl
(
HPET_COUNTER
)) {

791 
	`¥ötk
(
KERN_WARNING


793  -
ENODEV
;

804 
˛ocksour˚_h≥t
.
mu…
 = 
	`div_sc
(
h≥t_≥riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

806 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_h≥t
);

809 
	}
}

814 
__öô
 
	$h≥t_íabÀ
()

816 
id
;

817 
i
;

819 i‡(!
	`is_h≥t_ˇ∑bÀ
())

822 
	`h≥t_£t_m≠pög
();

827 
h≥t_≥riod
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

842 
i
 = 0; 
	`h≥t_ªadl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

843 i‡(
i
 == 1000) {

844 
	`¥ötk
(
KERN_WARNING


847 
out_noh≥t
;

851 i‡(
h≥t_≥riod
 < 
HPET_MIN_PERIOD
 || h≥t_≥riod > 
HPET_MAX_PERIOD
)

852 
out_noh≥t
;

858 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

859 
	`h≥t_¥öt_c⁄fig
();

861 #ifde‡
CONFIG_HPET_EMULATE_RTC


866 i‡(!(
id
 & 
HPET_ID_NUMBER
))

867 
out_noh≥t
;

870 i‡(
	`h≥t_˛ocksour˚_ªgi°î
())

871 
out_noh≥t
;

873 i‡(
id
 & 
HPET_ID_LEGSUP
) {

874 
	`h≥t_Àgacy_˛ockevít_ªgi°î
();

875 
	`h≥t_msi_ˇ∑bûôy_lookup
(2);

878 
	`h≥t_msi_ˇ∑bûôy_lookup
(0);

881 
out_noh≥t
:

882 
	`h≥t_˛ór_m≠pög
();

883 
h≥t_addªss
 = 0;

885 
	}
}

893 
__öô
 
	$h≥t_œã_öô
()

895 
˝u
;

897 i‡(
boŸ_h≥t_dißbÀ
)

898  -
ENODEV
;

900 i‡(!
h≥t_addªss
) {

901 i‡(!
f‹˚_h≥t_addªss
)

902  -
ENODEV
;

904 
h≥t_addªss
 = 
f‹˚_h≥t_addªss
;

905 
	`h≥t_íabÀ
();

908 i‡(!
h≥t_vút_addªss
)

909  -
ENODEV
;

911 
	`h≥t_ª£rve_∂©f‹m_timîs
(
	`h≥t_ªadl
(
HPET_ID
));

912 
	`h≥t_¥öt_c⁄fig
();

914 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

915 
	`h≥t_˝uhp_nŸify
(
NULL
, 
CPU_ONLINE
, (*)()
˝u
);

919 
	`hŸ˝u_nŸifõr
(
h≥t_˝uhp_nŸify
, -20);

922 
	}
}

923 
fs_öôˇŒ
(
h≥t_œã_öô
);

925 
	$h≥t_dißbÀ
()

927 i‡(
	`is_h≥t_ˇ∑bÀ
()) {

928 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

930 i‡(
h≥t_Àgacy_öt_íabÀd
) {

931 
cfg
 &~
HPET_CFG_LEGACY
;

932 
h≥t_Àgacy_öt_íabÀd
 = 0;

934 
cfg
 &~
HPET_CFG_ENABLE
;

935 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

937 
	}
}

939 #ifde‡
CONFIG_HPET_EMULATE_RTC


955 
	~<löux/mc146818πc.h
>

956 
	~<löux/πc.h
>

957 
	~<asm/πc.h
>

959 
	#DEFAULT_RTC_INT_FREQ
 64

	)

960 
	#DEFAULT_RTC_SHIFT
 6

	)

961 
	#RTC_NUM_INTS
 1

	)

963 
	gh≥t_πc_Êags
;

964 
	gh≥t_¥ev_upd©e_£c
;

965 
πc_time
 
	gh≥t_Æ¨m_time
;

966 
	gh≥t_põ_cou¡
;

967 
u32
 
	gh≥t_t1_cmp
;

968 
	gh≥t_deÁu…_dñè
;

969 
	gh≥t_põ_dñè
;

970 
	gh≥t_põ_limô
;

972 
πc_úq_h™dÀr
 
	gúq_h™dÀr
;

977 
ölöe
 
	$h≥t_˙t_ahód
(
u32
 
c1
, u32 
c2
)

979  (
s32
)(
c2
 - 
c1
) < 0;

980 
	}
}

985 
	$h≥t_ªgi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

987 i‡(!
	`is_h≥t_íabÀd
())

988  -
ENODEV
;

989 i‡(
úq_h™dÀr
)

990  -
EBUSY
;

992 
úq_h™dÀr
 = 
h™dÀr
;

995 
	}
}

996 
EXPORT_SYMBOL_GPL
(
h≥t_ªgi°î_úq_h™dÀr
);

1002 
	$h≥t_uƒegi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1004 i‡(!
	`is_h≥t_íabÀd
())

1007 
úq_h™dÀr
 = 
NULL
;

1008 
h≥t_πc_Êags
 = 0;

1009 
	}
}

1010 
EXPORT_SYMBOL_GPL
(
h≥t_uƒegi°î_úq_h™dÀr
);

1018 
	$h≥t_πc_timî_öô
()

1020 
cfg
, 
˙t
, 
dñè
, 
Êags
;

1022 i‡(!
	`is_h≥t_íabÀd
())

1025 i‡(!
h≥t_deÁu…_dñè
) {

1026 
uöt64_t
 
˛c
;

1028 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1029 
˛c
 >>
h≥t_˛ockevít
.
shi·
 + 
DEFAULT_RTC_SHIFT
;

1030 
h≥t_deÁu…_dñè
 = (Ë
˛c
;

1033 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1034 
dñè
 = 
h≥t_deÁu…_dñè
;

1036 
dñè
 = 
h≥t_põ_dñè
;

1038 
	`loˇl_úq_ßve
(
Êags
);

1040 
˙t
 = 
dñè
 + 
	`h≥t_ªadl
(
HPET_COUNTER
);

1041 
	`h≥t_wrôñ
(
˙t
, 
HPET_T1_CMP
);

1042 
h≥t_t1_cmp
 = 
˙t
;

1044 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1045 
cfg
 &~
HPET_TN_PERIODIC
;

1046 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1047 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1049 
	`loˇl_úq_ª°‹e
(
Êags
);

1052 
	}
}

1053 
EXPORT_SYMBOL_GPL
(
h≥t_πc_timî_öô
);

1060 
	$h≥t_mask_πc_úq_bô
(
bô_mask
)

1062 i‡(!
	`is_h≥t_íabÀd
())

1065 
h≥t_πc_Êags
 &~
bô_mask
;

1067 
	}
}

1068 
EXPORT_SYMBOL_GPL
(
h≥t_mask_πc_úq_bô
);

1070 
	$h≥t_£t_πc_úq_bô
(
bô_mask
)

1072 
ﬁdbôs
 = 
h≥t_πc_Êags
;

1074 i‡(!
	`is_h≥t_íabÀd
())

1077 
h≥t_πc_Êags
 |
bô_mask
;

1079 i‡((
bô_mask
 & 
RTC_UIE
Ë&& !(
ﬁdbôs
 & RTC_UIE))

1080 
h≥t_¥ev_upd©e_£c
 = -1;

1082 i‡(!
ﬁdbôs
)

1083 
	`h≥t_πc_timî_öô
();

1086 
	}
}

1087 
EXPORT_SYMBOL_GPL
(
h≥t_£t_πc_úq_bô
);

1089 
	$h≥t_£t_Æ¨m_time
(
hrs
, 
mö
,

1090 
£c
)

1092 i‡(!
	`is_h≥t_íabÀd
())

1095 
h≥t_Æ¨m_time
.
tm_hour
 = 
hrs
;

1096 
h≥t_Æ¨m_time
.
tm_mö
 = 
mö
;

1097 
h≥t_Æ¨m_time
.
tm_£c
 = 
£c
;

1100 
	}
}

1101 
EXPORT_SYMBOL_GPL
(
h≥t_£t_Æ¨m_time
);

1103 
	$h≥t_£t_≥riodic_‰eq
(
‰eq
)

1105 
uöt64_t
 
˛c
;

1107 i‡(!
	`is_h≥t_íabÀd
())

1110 i‡(
‰eq
 <
DEFAULT_RTC_INT_FREQ
)

1111 
h≥t_põ_limô
 = 
DEFAULT_RTC_INT_FREQ
 / 
‰eq
;

1113 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1114 
	`do_div
(
˛c
, 
‰eq
);

1115 
˛c
 >>
h≥t_˛ockevít
.
shi·
;

1116 
h≥t_põ_dñè
 = (Ë
˛c
;

1119 
	}
}

1120 
EXPORT_SYMBOL_GPL
(
h≥t_£t_≥riodic_‰eq
);

1122 
	$h≥t_πc_dr›≥d_úq
()

1124  
	`is_h≥t_íabÀd
();

1125 
	}
}

1126 
EXPORT_SYMBOL_GPL
(
h≥t_πc_dr›≥d_úq
);

1128 
	$h≥t_πc_timî_ªöô
()

1130 
cfg
, 
dñè
;

1131 
lo°_öts
 = -1;

1133 i‡(
	`u∆ikñy
(!
h≥t_πc_Êags
)) {

1134 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1135 
cfg
 &~
HPET_TN_ENABLE
;

1136 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1140 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1141 
dñè
 = 
h≥t_deÁu…_dñè
;

1143 
dñè
 = 
h≥t_põ_dñè
;

1150 
h≥t_t1_cmp
 +
dñè
;

1151 
	`h≥t_wrôñ
(
h≥t_t1_cmp
, 
HPET_T1_CMP
);

1152 
lo°_öts
++;

1153 } !
	`h≥t_˙t_ahód
(
h≥t_t1_cmp
, 
	`h≥t_ªadl
(
HPET_COUNTER
)));

1155 i‡(
lo°_öts
) {

1156 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
)

1157 
h≥t_põ_cou¡
 +
lo°_öts
;

1158 i‡(
	`¥ötk_øãlimô
())

1159 
	`¥ötk
(
KERN_WARNING
 "hpet1:Üost %dÑtc interrupts\n",

1160 
lo°_öts
);

1162 
	}
}

1164 
úqªtu∫_t
 
	$h≥t_πc_öãºu±
(
úq
, *
dev_id
)

1166 
πc_time
 
cuº_time
;

1167 
πc_öt_Êag
 = 0;

1169 
	`h≥t_πc_timî_ªöô
();

1170 
	`mem£t
(&
cuº_time
, 0, (
πc_time
));

1172 i‡(
h≥t_πc_Êags
 & (
RTC_UIE
 | 
RTC_AIE
))

1173 
	`gë_πc_time
(&
cuº_time
);

1175 i‡(
h≥t_πc_Êags
 & 
RTC_UIE
 &&

1176 
cuº_time
.
tm_£c
 !
h≥t_¥ev_upd©e_£c
) {

1177 i‡(
h≥t_¥ev_upd©e_£c
 >= 0)

1178 
πc_öt_Êag
 = 
RTC_UF
;

1179 
h≥t_¥ev_upd©e_£c
 = 
cuº_time
.
tm_£c
;

1182 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
 &&

1183 ++
h≥t_põ_cou¡
 >
h≥t_põ_limô
) {

1184 
πc_öt_Êag
 |
RTC_PF
;

1185 
h≥t_põ_cou¡
 = 0;

1188 i‡(
h≥t_πc_Êags
 & 
RTC_AIE
 &&

1189 (
cuº_time
.
tm_£c
 =
h≥t_Æ¨m_time
.tm_sec) &&

1190 (
cuº_time
.
tm_mö
 =
h≥t_Æ¨m_time
.tm_min) &&

1191 (
cuº_time
.
tm_hour
 =
h≥t_Æ¨m_time
.tm_hour))

1192 
πc_öt_Êag
 |
RTC_AF
;

1194 i‡(
πc_öt_Êag
) {

1195 
πc_öt_Êag
 |(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1196 i‡(
úq_h™dÀr
)

1197 
	`úq_h™dÀr
(
πc_öt_Êag
, 
dev_id
);

1199  
IRQ_HANDLED
;

1200 
	}
}

1201 
EXPORT_SYMBOL_GPL
(
h≥t_πc_öãºu±
);

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/ªg£t.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/sigc⁄ãxt.h
>

13 
	~<asm/¥o˚ss‹.h
>

14 
	~<asm/m©h_emu.h
>

15 
	~<asm/uac˚ss.h
>

16 
	~<asm/±ø˚.h
>

17 
	~<asm/i387.h
>

18 
	~<asm/u£r.h
>

20 #ifde‡
CONFIG_X86_64


21 
	~<asm/sigc⁄ãxt32.h
>

22 
	~<asm/u£r32.h
>

24 
	#ßve_i387_x°©e_ü32
 
ßve_i387_x°©e


	)

25 
	#ª°‹e_i387_x°©e_ü32
 
ª°‹e_i387_x°©e


	)

26 
	#_Â°©e_ü32
 
_Â°©e


	)

27 
	#_x°©e_ü32
 
_x°©e


	)

28 
	#sig_x°©e_ü32_size
 
sig_x°©e_size


	)

29 
	#fx_sw_ª£rved_ü32
 
fx_sw_ª£rved


	)

30 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

31 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

34 #ifde‡
CONFIG_MATH_EMULATION


35 
	#HAVE_HWFP
 (
boŸ_˝u_d©a
.
h¨d_m©h
)

	)

37 
	#HAVE_HWFP
 1

	)

40 
mxc§_„©uª_mask
 
	g__ªad_mo°ly
 = 0xffffffffu;

41 
	gx°©e_size
;

42 
	gsig_x°©e_ü32_size
 = (
_Â°©e_ü32
);

43 
i387_fxßve_°ru˘
 
fx_s¸©ch
 
	g__˝uöôd©a
;

45 
__˝uöô
 
	$mxc§_„©uª_mask_öô
()

47 
mask
 = 0;

49 
	`˛ts
();

50 i‡(
˝u_has_fx§
) {

51 
	`mem£t
(&
fx_s¸©ch
, 0, (
i387_fxßve_°ru˘
));

52 
asm
 vﬁ©ûe("fxßvê%0" : : "m" (
fx_s¸©ch
));

53 
mask
 = 
fx_s¸©ch
.
mxc§_mask
;

54 i‡(
mask
 == 0)

55 
mask
 = 0x0000ffbf;

57 
mxc§_„©uª_mask
 &
mask
;

58 
	`°ts
();

59 
	}
}

61 
__˝uöô
 
	$öô_thªad_x°©e
()

63 i‡(!
HAVE_HWFP
) {

64 
x°©e_size
 = (
i387_so·_°ru˘
);

68 i‡(
˝u_has_xßve
) {

69 
	`xßve_˙txt_öô
();

73 i‡(
˝u_has_fx§
)

74 
x°©e_size
 = (
i387_fxßve_°ru˘
);

75 #ifde‡
CONFIG_X86_32


77 
x°©e_size
 = (
i387_fßve_°ru˘
);

79 
	}
}

81 #ifde‡
CONFIG_X86_64


86 
__˝uöô
 
	$Âu_öô
()

88 
ﬁd¸0
 = 
	`ªad_¸0
();

90 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

91 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

93 
	`wrôe_¸0
(
ﬁd¸0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

98 i‡(!
	`smp_¥o˚ss‹_id
())

99 
	`öô_thªad_x°©e
();

100 
	`xßve_öô
();

102 
	`mxc§_„©uª_mask_öô
();

104 i‡(
˝u_has_xßve
)

105 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

107 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

108 
	`˛ór_u£d_m©h
();

109 
	}
}

118 
	$öô_Âu
(
èsk_°ru˘
 *
tsk
)

120 i‡(
	`tsk_u£d_m©h
(
tsk
)) {

121 i‡(
HAVE_HWFP
 && 
tsk
 =
cuºít
)

122 
	`u∆azy_Âu
(
tsk
);

129 i‡(!
tsk
->
thªad
.
x°©e
) {

130 
tsk
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

131 
GFP_KERNEL
);

132 i‡(!
tsk
->
thªad
.
x°©e
)

133  -
ENOMEM
;

136 #ifde‡
CONFIG_X86_32


137 i‡(!
HAVE_HWFP
) {

138 
	`mem£t
(
tsk
->
thªad
.
x°©e
, 0, 
x°©e_size
);

139 
	`föô_èsk
(
tsk
);

140 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

145 i‡(
˝u_has_fx§
) {

146 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

148 
	`mem£t
(
fx
, 0, 
x°©e_size
);

149 
fx
->
cwd
 = 0x37f;

150 i‡(
˝u_has_xmm
)

151 
fx
->
mxc§
 = 
MXCSR_DEFAULT
;

153 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

154 
	`mem£t
(
Â
, 0, 
x°©e_size
);

155 
Â
->
cwd
 = 0xffff037fu;

156 
Â
->
swd
 = 0xffff0000u;

157 
Â
->
twd
 = 0xffffffffu;

158 
Â
->
fos
 = 0xffff0000u;

163 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

165 
	}
}

167 
	$Âªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

169  
	`tsk_u£d_m©h
(
èrgë
Ë? 
ªg£t
->
n
 : 0;

170 
	}
}

172 
	$xÂªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

174  (
˝u_has_fx§
 && 
	`tsk_u£d_m©h
(
èrgë
)Ë? 
ªg£t
->
n
 : 0;

175 
	}
}

177 
	$xÂªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

178 
pos
, 
cou¡
,

179 *
kbuf
, 
__u£r
 *
ubuf
)

181 
ªt
;

183 i‡(!
˝u_has_fx§
)

184  -
ENODEV
;

186 
ªt
 = 
	`öô_Âu
(
èrgë
);

187 i‡(
ªt
)

188  
ªt
;

190  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

191 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

192 
	}
}

194 
	$xÂªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
ªt
;

200 i‡(!
˝u_has_fx§
)

201  -
ENODEV
;

203 
ªt
 = 
	`öô_Âu
(
èrgë
);

204 i‡(
ªt
)

205  
ªt
;

207 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

209 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

210 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

215 
èrgë
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

221 i‡(
˝u_has_xßve
)

222 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

224  
ªt
;

225 
	}
}

227 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


233 
ölöe
 
	$twd_i387_to_fx§
(
twd
)

235 
tmp
;

238 
tmp
 = ~
twd
;

239 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

241 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

242 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

243 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

245  
tmp
;

246 
	}
}

248 
	#FPREG_ADDR
(
f
, 
n
Ë((*)&(f)->
°_•a˚
 + (nË* 16);

	)

249 
	#FP_EXP_TAG_VALID
 0

	)

250 
	#FP_EXP_TAG_ZERO
 1

	)

251 
	#FP_EXP_TAG_SPECIAL
 2

	)

252 
	#FP_EXP_TAG_EMPTY
 3

	)

254 
ölöe
 
u32
 
	$twd_fx§_to_i387
(
i387_fxßve_°ru˘
 *
fxßve
)

256 
_Âxªg
 *
°
;

257 
u32
 
tos
 = (
fxßve
->
swd
 >> 11) & 7;

258 
u32
 
twd
 = (Ë
fxßve
->twd;

259 
u32
 
èg
;

260 
u32
 
ªt
 = 0xffff0000u;

261 
i
;

263 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

264 i‡(
twd
 & 0x1) {

265 
°
 = 
	`FPREG_ADDR
(
fxßve
, (
i
 - 
tos
) & 7);

267 
°
->
exp⁄ít
 & 0x7fff) {

269 
èg
 = 
FP_EXP_TAG_SPECIAL
;

272 i‡(!
°
->
signifiˇnd
[0] &&

273 !
°
->
signifiˇnd
[1] &&

274 !
°
->
signifiˇnd
[2] &&

275 !
°
->
signifiˇnd
[3])

276 
èg
 = 
FP_EXP_TAG_ZERO
;

278 
èg
 = 
FP_EXP_TAG_SPECIAL
;

281 i‡(
°
->
signifiˇnd
[3] & 0x8000)

282 
èg
 = 
FP_EXP_TAG_VALID
;

284 
èg
 = 
FP_EXP_TAG_SPECIAL
;

288 
èg
 = 
FP_EXP_TAG_EMPTY
;

290 
ªt
 |
èg
 << (2 * 
i
);

292  
ªt
;

293 
	}
}

300 
	$c⁄vît_‰om_fx§
(
u£r_i387_ü32_°ru˘
 *
ív
, 
èsk_°ru˘
 *
tsk
)

302 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

303 
_Âªg
 *
to
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

304 
_Âxªg
 *
‰om
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

305 
i
;

307 
ív
->
cwd
 = 
fxßve
->cwd | 0xffff0000u;

308 
ív
->
swd
 = 
fxßve
->swd | 0xffff0000u;

309 
ív
->
twd
 = 
	`twd_fx§_to_i387
(
fxßve
);

311 #ifde‡
CONFIG_X86_64


312 
ív
->
fù
 = 
fxßve
->
rù
;

313 
ív
->
foo
 = 
fxßve
->
rdp
;

314 i‡(
tsk
 =
cuºít
) {

319 
	`asm
("mov %%ds, %[fos]" : [
fos
] "Ù" (
ív
->fos));

320 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "Ù" (
ív
->fcs));

322 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

324 
ív
->
fos
 = 0xffff0000 | 
tsk
->
thªad
.
ds
;

325 
ív
->
fcs
 = 
ªgs
->
cs
;

328 
ív
->
fù
 = 
fxßve
->fip;

329 
ív
->
fcs
 = (
u16
Ë
fxßve
->fc†| ((
u32
Ëfxßve->
f›
 << 16);

330 
ív
->
foo
 = 
fxßve
->foo;

331 
ív
->
fos
 = 
fxßve
->fos;

334 
i
 = 0; i < 8; ++i)

335 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (to[0]));

336 
	}
}

338 
	$c⁄vît_to_fx§
(
èsk_°ru˘
 *
tsk
,

339 c⁄° 
u£r_i387_ü32_°ru˘
 *
ív
)

342 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

343 
_Âªg
 *
‰om
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

344 
_Âxªg
 *
to
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

345 
i
;

347 
fxßve
->
cwd
 = 
ív
->cwd;

348 
fxßve
->
swd
 = 
ív
->swd;

349 
fxßve
->
twd
 = 
	`twd_i387_to_fx§
(
ív
->twd);

350 
fxßve
->
f›
 = (
u16
Ë((
u32
Ë
ív
->
fcs
 >> 16);

351 #ifde‡
CONFIG_X86_64


352 
fxßve
->
rù
 = 
ív
->
fù
;

353 
fxßve
->
rdp
 = 
ív
->
foo
;

356 
fxßve
->
fù
 = 
ív
->fip;

357 
fxßve
->
fcs
 = (
ív
->fcs & 0xffff);

358 
fxßve
->
foo
 = 
ív
->foo;

359 
fxßve
->
fos
 = 
ív
->fos;

362 
i
 = 0; i < 8; ++i)

363 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (from[0]));

364 
	}
}

366 
	$Âªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

367 
pos
, 
cou¡
,

368 *
kbuf
, 
__u£r
 *
ubuf
)

370 
u£r_i387_ü32_°ru˘
 
ív
;

371 
ªt
;

373 
ªt
 = 
	`öô_Âu
(
èrgë
);

374 i‡(
ªt
)

375  
ªt
;

377 i‡(!
HAVE_HWFP
)

378  
	`Âªgs_so·_gë
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

380 i‡(!
˝u_has_fx§
) {

381  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

382 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0,

386 i‡(
kbuf
 && 
pos
 =0 && 
cou¡
 =(
ív
)) {

387 
	`c⁄vît_‰om_fx§
(
kbuf
, 
èrgë
);

391 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

393  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

394 
	}
}

396 
	$Âªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

397 
pos
, 
cou¡
,

398 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

400 
u£r_i387_ü32_°ru˘
 
ív
;

401 
ªt
;

403 
ªt
 = 
	`öô_Âu
(
èrgë
);

404 i‡(
ªt
)

405  
ªt
;

407 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

409 i‡(!
HAVE_HWFP
)

410  
	`Âªgs_so·_£t
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

412 i‡(!
˝u_has_fx§
) {

413  
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

414 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0, -1);

417 i‡(
pos
 > 0 || 
cou¡
 < (
ív
))

418 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

420 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

421 i‡(!
ªt
)

422 
	`c⁄vît_to_fx§
(
èrgë
, &
ív
);

428 i‡(
˝u_has_xßve
)

429 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FP
;

430  
ªt
;

431 
	}
}

437 
ölöe
 
	$ßve_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

439 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

440 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

442 
Â
->
°©us
 = fp->
swd
;

443 i‡(
	`__c›y_to_u£r
(
buf
, 
Â
, (
i387_fßve_°ru˘
)))

446 
	}
}

448 
	$ßve_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

450 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

451 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

452 
u£r_i387_ü32_°ru˘
 
ív
;

453 
îr
 = 0;

455 
	`c⁄vît_‰om_fx§
(&
ív
, 
tsk
);

456 i‡(
	`__c›y_to_u£r
(
buf
, &
ív
, (env)))

459 
îr
 |
	`__put_u£r
(
fx
->
swd
, &
buf
->
°©us
);

460 
îr
 |
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

461 i‡(
îr
)

464 i‡(
	`__c›y_to_u£r
(&
buf
->
_fx§_ív
[0], 
fx
, 
x°©e_size
))

467 
	}
}

469 
	$ßve_i387_xßve
(
__u£r
 *
buf
)

471 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

472 
_Â°©e_ü32
 
__u£r
 *
fx
 = 
buf
;

473 
îr
 = 0;

486 
tsk
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

488 i‡(
	`ßve_i387_fxßve
(
fx
) < 0)

491 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved_ü32
,

492 (
_Âx_sw_byãs
));

493 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

494 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_ü32_size


495 - 
FP_XSTATE_MAGIC2_SIZE
));

496 i‡(
îr
)

500 
	}
}

502 
	$ßve_i387_x°©e_ü32
(
__u£r
 *
buf
)

504 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

505 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

507 i‡(!
	`u£d_m©h
())

510 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_ü32_size
))

511  -
EACCES
;

516 
	`˛ór_u£d_m©h
();

518 i‡(!
HAVE_HWFP
) {

519  
	`Âªgs_so·_gë
(
cuºít
, 
NULL
,

520 0, (
u£r_i387_ü32_°ru˘
),

521 
NULL
, 
Â
) ? -1 : 1;

524 
	`u∆azy_Âu
(
tsk
);

526 i‡(
˝u_has_xßve
)

527  
	`ßve_i387_xßve
(
Â
);

528 i‡(
˝u_has_fx§
)

529  
	`ßve_i387_fxßve
(
Â
);

531  
	`ßve_i387_fßve
(
Â
);

532 
	}
}

534 
ölöe
 
	$ª°‹e_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

536 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

538  
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fßve
, 
buf
,

539 (
i387_fßve_°ru˘
));

540 
	}
}

542 
	$ª°‹e_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
,

543 
size
)

545 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

546 
u£r_i387_ü32_°ru˘
 
ív
;

547 
îr
;

549 
îr
 = 
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fxßve
, &
buf
->
_fx§_ív
[0],

550 
size
);

552 
tsk
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

553 i‡(
îr
 || 
	`__c›y_‰om_u£r
(&
ív
, 
buf
, (env)))

555 
	`c⁄vît_to_fx§
(
tsk
, &
ív
);

558 
	}
}

560 
	$ª°‹e_i387_xßve
(
__u£r
 *
buf
)

562 
_Âx_sw_byãs
 
fx_sw_u£r
;

563 
_Â°©e_ü32
 
__u£r
 *
fx_u£r
 =

564 ((
_Â°©e_ü32
 
__u£r
 *Ë
buf
);

565 
i387_fxßve_°ru˘
 
__u£r
 *
fx
 =

566 (
i387_fxßve_°ru˘
 
__u£r
 *Ë&
fx_u£r
->
_fx§_ív
[0];

567 
xßve_hdr_°ru˘
 *
xßve_hdr
 =

568 &
cuºít
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
;

569 
u64
 
mask
;

570 
îr
;

572 i‡(
	`check_f‹_x°©e
(
fx
, 
buf
, &
fx_sw_u£r
))

573 
fx_⁄ly
;

575 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

577 
îr
 = 
	`ª°‹e_i387_fxßve
(
buf
, 
fx_sw_u£r
.
x°©e_size
);

579 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

583 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

589 
mask
 = ~(
p˙txt_mask
 & ~mask);

590 
xßve_hdr
->
x°©e_bv
 &
mask
;

592  
îr
;

593 
fx_⁄ly
:

599 
xßve_hdr
->
x°©e_bv
 = 
XSTATE_FPSSE
;

600  
	`ª°‹e_i387_fxßve
(
buf
, (
i387_fxßve_°ru˘
));

601 
	}
}

603 
	$ª°‹e_i387_x°©e_ü32
(
__u£r
 *
buf
)

605 
îr
;

606 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

607 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

609 i‡(
HAVE_HWFP
)

610 
	`˛ór_Âu
(
tsk
);

612 i‡(!
buf
) {

613 i‡(
	`u£d_m©h
()) {

614 
	`˛ór_Âu
(
tsk
);

615 
	`˛ór_u£d_m©h
();

620 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_ü32_size
))

621  -
EACCES
;

623 i‡(!
	`u£d_m©h
()) {

624 
îr
 = 
	`öô_Âu
(
tsk
);

625 i‡(
îr
)

626  
îr
;

629 i‡(
HAVE_HWFP
) {

630 i‡(
˝u_has_xßve
)

631 
îr
 = 
	`ª°‹e_i387_xßve
(
buf
);

632 i‡(
˝u_has_fx§
)

633 
îr
 = 
	`ª°‹e_i387_fxßve
(
Â
, (

634 
i387_fxßve_°ru˘
));

636 
îr
 = 
	`ª°‹e_i387_fßve
(
Â
);

638 
îr
 = 
	`Âªgs_so·_£t
(
cuºít
, 
NULL
,

639 0, (
u£r_i387_ü32_°ru˘
),

640 
NULL
, 
Â
) != 0;

642 
	`£t_u£d_m©h
();

644  
îr
;

645 
	}
}

654 
	$dump_Âu
(
±_ªgs
 *
ªgs
, 
u£r_i387_°ru˘
 *
Âu
)

656 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

657 
ÂvÆid
;

659 
ÂvÆid
 = !!
	`u£d_m©h
();

660 i‡(
ÂvÆid
)

661 
ÂvÆid
 = !
	`Âªgs_gë
(
tsk
, 
NULL
,

662 0, (
u£r_i387_ü32_°ru˘
),

663 
Âu
, 
NULL
);

665  
ÂvÆid
;

666 
	}
}

667 
EXPORT_SYMBOL
(
dump_Âu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<löux/öô.h
>

13 
	~<löux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_ªsume
(
sys_devi˚
 *
dev
)

26 
Êags
;

27 
i
;

29 
Êags
 = 
	`˛aim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_cou¡
(
i
, 1);

41 
	`íabÀ_dma
(4);

43 
	`ªÀa£_dma_lock
(
Êags
);

46 
	}
}

48 
	$i8237A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

51 
	}
}

53 
sysdev_˛ass
 
	gi8237_sysdev_˛ass
 = {

54 .
«me
 = "i8237",

55 .
	gsu•íd
 = 
i8237A_su•íd
,

56 .
	gªsume
 = 
i8237A_ªsume
,

59 
sys_devi˚
 
	gdevi˚_i8237A
 = {

60 .
id
 = 0,

61 .
	g˛s
 = &
i8237_sysdev_˛ass
,

64 
__öô
 
	$i8237A_öô_sysfs
()

66 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8237_sysdev_˛ass
);

67 i‡(!
îr‹
)

68 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8237A
);

69  
îr‹
;

70 
	}
}

71 
devi˚_öôˇŒ
(
i8237A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<löux/˛ockchùs.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/jiffõs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/io.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

17 
	~<asm/smp.h
>

19 
DEFINE_SPINLOCK
(
i8253_lock
);

20 
EXPORT_SYMBOL
(
i8253_lock
);

22 #ifde‡
CONFIG_X86_32


23 
pô_dißbÀ_˛ocksour˚
();

25 
ölöe
 
	$pô_dißbÀ_˛ocksour˚
(Ë{ 
	}
}

32 
˛ock_evít_devi˚
 *
	gglobÆ_˛ock_evít
;

39 
	$öô_pô_timî
(
˛ock_evít_mode
 
mode
,

40 
˛ock_evít_devi˚
 *
evt
)

42 
	`•ö_lock
(&
i8253_lock
);

44 
mode
) {

45 
CLOCK_EVT_MODE_PERIODIC
:

47 
	`outb_pô
(0x34, 
PIT_MODE
);

48 
	`outb_pô
(
LATCH
 & 0xf‡, 
PIT_CH0
);

49 
	`outb_pô
(
LATCH
 >> 8 , 
PIT_CH0
);

52 
CLOCK_EVT_MODE_SHUTDOWN
:

53 
CLOCK_EVT_MODE_UNUSED
:

54 i‡(
evt
->
mode
 =
CLOCK_EVT_MODE_PERIODIC
 ||

55 
evt
->
mode
 =
CLOCK_EVT_MODE_ONESHOT
) {

56 
	`outb_pô
(0x30, 
PIT_MODE
);

57 
	`outb_pô
(0, 
PIT_CH0
);

58 
	`outb_pô
(0, 
PIT_CH0
);

60 
	`pô_dißbÀ_˛ocksour˚
();

63 
CLOCK_EVT_MODE_ONESHOT
:

65 
	`pô_dißbÀ_˛ocksour˚
();

66 
	`outb_pô
(0x38, 
PIT_MODE
);

69 
CLOCK_EVT_MODE_RESUME
:

73 
	`•ö_u∆ock
(&
i8253_lock
);

74 
	}
}

81 
	$pô_√xt_evít
(
dñè
, 
˛ock_evít_devi˚
 *
evt
)

83 
	`•ö_lock
(&
i8253_lock
);

84 
	`outb_pô
(
dñè
 & 0xf‡, 
PIT_CH0
);

85 
	`outb_pô
(
dñè
 >> 8 , 
PIT_CH0
);

86 
	`•ö_u∆ock
(&
i8253_lock
);

89 
	}
}

99 
˛ock_evít_devi˚
 
	gpô_˚
 = {

100 .
«me
 = "pit",

101 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

102 .
	g£t_mode
 = 
öô_pô_timî
,

103 .
	g£t_√xt_evít
 = 
pô_√xt_evít
,

104 .
	gshi·
 = 32,

105 .
	gúq
 = 0,

112 
__öô
 
	$£tup_pô_timî
()

118 
pô_˚
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

119 
pô_˚
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,Öô_˚.
shi·
);

120 
pô_˚
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFF, &pit_ce);

121 
pô_˚
.
mö_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0xF, &pit_ce);

123 
	`˛ockevíts_ªgi°î_devi˚
(&
pô_˚
);

124 
globÆ_˛ock_evít
 = &
pô_˚
;

125 
	}
}

127 #i‚de‡
CONFIG_X86_64


133 
cy˛e_t
 
	$pô_ªad
(
˛ocksour˚
 *
cs
)

135 
ﬁd_cou¡
;

136 
u32
 
ﬁd_jifs
;

137 
Êags
;

138 
cou¡
;

139 
u32
 
jifs
;

141 
	`•ö_lock_úqßve
(&
i8253_lock
, 
Êags
);

155 
jifs
 = 
jiffõs
;

156 
	`outb_pô
(0x00, 
PIT_MODE
);

157 
cou¡
 = 
	`öb_pô
(
PIT_CH0
);

158 
cou¡
 |
	`öb_pô
(
PIT_CH0
) << 8;

161 i‡(
cou¡
 > 
LATCH
) {

162 
	`outb_pô
(0x34, 
PIT_MODE
);

163 
	`outb_pô
(
LATCH
 & 0xff, 
PIT_CH0
);

164 
	`outb_pô
(
LATCH
 >> 8, 
PIT_CH0
);

165 
cou¡
 = 
LATCH
 - 1;

181 i‡(
cou¡
 > 
ﬁd_cou¡
 && 
jifs
 =
ﬁd_jifs
)

182 
cou¡
 = 
ﬁd_cou¡
;

184 
ﬁd_cou¡
 = 
cou¡
;

185 
ﬁd_jifs
 = 
jifs
;

187 
	`•ö_u∆ock_úqª°‹e
(&
i8253_lock
, 
Êags
);

189 
cou¡
 = (
LATCH
 - 1) - count;

191  (
cy˛e_t
)(
jifs
 * 
LATCH
Ë+ 
cou¡
;

192 
	}
}

194 
˛ocksour˚
 
	gpô_cs
 = {

195 .
«me
 = "pit",

196 .
	gøtög
 = 110,

197 .
	gªad
 = 
pô_ªad
,

198 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

199 .
	gmu…
 = 0,

200 .
	gshi·
 = 20,

203 
	$pô_dißbÀ_˛ocksour˚
()

208 i‡(
pô_cs
.
mu…
) {

209 
	`˛ocksour˚_uƒegi°î
(&
pô_cs
);

210 
pô_cs
.
mu…
 = 0;

212 
	}
}

214 
__öô
 
	$öô_pô_˛ocksour˚
()

223 i‡(
	`num_possibÀ_˝us
(Ë> 1 || 
	`is_h≥t_íabÀd
() ||

224 
pô_˚
.
mode
 !
CLOCK_EVT_MODE_PERIODIC
)

227 
pô_cs
.
mu…
 = 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
,Öô_cs.
shi·
);

229  
	`˛ocksour˚_ªgi°î
(&
pô_cs
);

230 
	}
}

231 
¨ch_öôˇŒ
(
öô_pô_˛ocksour˚
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/sysdev.h
>

13 
	~<löux/bô›s.h
>

14 
	~<löux/a˝i.h
>

15 
	~<löux/io.h
>

16 
	~<löux/dñay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/timî.h
>

21 
	~<asm/hw_úq.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/i8259.h
>

34 
	gi8259A_auto_eoi
;

35 
DEFINE_SPINLOCK
(
i8259A_lock
);

36 
mask_™d_ack_8259A
();

38 
úq_chù
 
	gi8259A_chù
 = {

39 .
«me
 = "XT-PIC",

40 .
	gmask
 = 
dißbÀ_8259A_úq
,

41 .
	gdißbÀ
 = 
dißbÀ_8259A_úq
,

42 .
	gunmask
 = 
íabÀ_8259A_úq
,

43 .
	gmask_ack
 = 
mask_™d_ack_8259A
,

53 
	gˇched_úq_mask
 = 0xffff;

64 
	gio_≠ic_úqs
;

66 
	$dißbÀ_8259A_úq
(
úq
)

68 
mask
 = 1 << 
úq
;

69 
Êags
;

71 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

72 
ˇched_úq_mask
 |
mask
;

73 i‡(
úq
 & 8)

74 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

76 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

77 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

78 
	}
}

80 
	$íabÀ_8259A_úq
(
úq
)

82 
mask
 = ~(1 << 
úq
);

83 
Êags
;

85 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

86 
ˇched_úq_mask
 &
mask
;

87 i‡(
úq
 & 8)

88 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

90 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

91 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

92 
	}
}

94 
	$i8259A_úq_≥ndög
(
úq
)

96 
mask
 = 1<<
úq
;

97 
Êags
;

98 
ªt
;

100 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

101 i‡(
úq
 < 8)

102 
ªt
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
mask
;

104 
ªt
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
mask
 >> 8);

105 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

107  
ªt
;

108 
	}
}

110 
	$make_8259A_úq
(
úq
)

112 
	`dißbÀ_úq_nosync
(
úq
);

113 
io_≠ic_úqs
 &~(1<<
úq
);

114 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
i8259A_chù
, 
h™dÀ_Àvñ_úq
,

116 
	`íabÀ_úq
(
úq
);

117 
	}
}

125 
ölöe
 
	$i8259A_úq_ªÆ
(
úq
)

127 
vÆue
;

128 
úqmask
 = 1<<
úq
;

130 i‡(
úq
 < 8) {

131 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

132 
vÆue
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
úqmask
;

133 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

134  
vÆue
;

136 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

137 
vÆue
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
úqmask
 >> 8);

138 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

139  
vÆue
;

140 
	}
}

148 
	$mask_™d_ack_8259A
(
úq
)

150 
úqmask
 = 1 << 
úq
;

151 
Êags
;

153 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

169 i‡(
ˇched_úq_mask
 & 
úqmask
)

170 
•urious_8259A_úq
;

171 
ˇched_úq_mask
 |
úqmask
;

173 
h™dÀ_ªÆ_úq
:

174 i‡(
úq
 & 8) {

175 
	`öb
(
PIC_SLAVE_IMR
);

176 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

178 
	`outb
(0x60+(
úq
&7), 
PIC_SLAVE_CMD
);

180 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

182 
	`öb
(
PIC_MASTER_IMR
);

183 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

184 
	`outb
(0x60+
úq
, 
PIC_MASTER_CMD
);

186 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

189 
•urious_8259A_úq
:

193 i‡(
	`i8259A_úq_ªÆ
(
úq
))

198 
h™dÀ_ªÆ_úq
;

201 
•urious_úq_mask
;

206 i‡(!(
•urious_úq_mask
 & 
úqmask
)) {

207 
	`¥ötk
(
KERN_DEBUG


208 "•uriou†8259A i¡îru±: IRQ%d.\n", 
úq
);

209 
•urious_úq_mask
 |
úqmask
;

211 
	`©omic_öc
(&
úq_îr_cou¡
);

217 
h™dÀ_ªÆ_úq
;

219 
	}
}

221 
	gúq_åiggî
[2];

225 
	$ª°‹e_ELCR
(*
åiggî
)

227 
	`outb
(
åiggî
[0], 0x4d0);

228 
	`outb
(
åiggî
[1], 0x4d1);

229 
	}
}

231 
	$ßve_ELCR
(*
åiggî
)

234 
åiggî
[0] = 
	`öb
(0x4d0) & 0xF8;

235 
åiggî
[1] = 
	`öb
(0x4d1) & 0xDE;

236 
	}
}

238 
	$i8259A_ªsume
(
sys_devi˚
 *
dev
)

240 
	`öô_8259A
(
i8259A_auto_eoi
);

241 
	`ª°‹e_ELCR
(
úq_åiggî
);

243 
	}
}

245 
	$i8259A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

247 
	`ßve_ELCR
(
úq_åiggî
);

249 
	}
}

251 
	$i8259A_shutdown
(
sys_devi˚
 *
dev
)

257 
	`outb
(0xff, 
PIC_MASTER_IMR
);

258 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

260 
	}
}

262 
sysdev_˛ass
 
	gi8259_sysdev_˛ass
 = {

263 .
«me
 = "i8259",

264 .
	gsu•íd
 = 
i8259A_su•íd
,

265 .
	gªsume
 = 
i8259A_ªsume
,

266 .
	gshutdown
 = 
i8259A_shutdown
,

269 
sys_devi˚
 
	gdevi˚_i8259A
 = {

270 .
id
 = 0,

271 .
	g˛s
 = &
i8259_sysdev_˛ass
,

274 
__öô
 
	$i8259A_öô_sysfs
()

276 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8259_sysdev_˛ass
);

277 i‡(!
îr‹
)

278 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8259A
);

279  
îr‹
;

280 
	}
}

282 
devi˚_öôˇŒ
(
i8259A_öô_sysfs
);

284 
	$mask_8259A
()

286 
Êags
;

288 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

290 
	`outb
(0xff, 
PIC_MASTER_IMR
);

291 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

293 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

294 
	}
}

296 
	$unmask_8259A
()

298 
Êags
;

300 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

302 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

303 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

305 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

306 
	}
}

308 
	$öô_8259A
(
auto_eoi
)

310 
Êags
;

312 
i8259A_auto_eoi
 = 
auto_eoi
;

314 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

316 
	`outb
(0xff, 
PIC_MASTER_IMR
);

317 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

322 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

326 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

329 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

331 i‡(
auto_eoi
)

332 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

334 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

336 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

339 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

341 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

343 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

345 i‡(
auto_eoi
)

350 
i8259A_chù
.
mask_ack
 = 
dißbÀ_8259A_úq
;

352 
i8259A_chù
.
mask_ack
 = 
mask_™d_ack_8259A
;

354 
	`udñay
(100);

356 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

357 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

359 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

9 
	~<asm/uac˚ss.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/desc.h
>

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

23 
thªad_uni⁄
 
öô_thªad_uni⁄


24 
__©åibuã__
((
__£˘i⁄__
(".data.init_task"))) =

25 { 
INIT_THREAD_INFO
(
öô_èsk
) };

32 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

33 
EXPORT_SYMBOL
(
öô_èsk
);

42 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_°ru˘
, 
öô_tss
Ë
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/io.h
>

15 
io_dñay_ty≥
 
	g__ªad_mo°ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__öôd©a
 
	gio_dñay_ovîride
;

22 
	$«tive_io_dñay
()

24 
io_dñay_ty≥
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`udñay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
«tive_io_dñay
);

47 
__öô
 
	$dmi_io_dñay_0xed_p‹t
(c⁄° 
dmi_sy°em_id
 *
id
)

49 i‡(
io_dñay_ty≥
 =
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`¥_nŸi˚
("%s: usög 0xed I/O dñayÖ‹t\n", 
id
->
idít
);

51 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy°em_id
 
__öôd©a
 
	gio_dñay_0xed_p‹t_dmi_èbÀ
[] = {

63 .
ˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

64 .
	gidít
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

72 .
	gidít
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

80 .
	gidít
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

88 .
	gidít
 = "HP PavilionÅx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

96 .
	gidít
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__öô
 
	$io_dñay_öô
()

107 i‡(!
io_dñay_ovîride
)

108 
	`dmi_check_sy°em
(
io_dñay_0xed_p‹t_dmi_èbÀ
);

109 
	}
}

111 
__öô
 
	$io_dñay_∑øm
(*
s
)

113 i‡(!
s
)

114  -
EINVAL
;

116 i‡(!
	`°rcmp
(
s
, "0x80"))

117 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 i‡(!
	`°rcmp
(
s
, "0xed"))

119 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 i‡(!
	`°rcmp
(
s
, "udelay"))

121 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 i‡(!
	`°rcmp
(
s
, "none"))

123 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_dñay_ovîride
 = 1;

129 
	}
}

131 
óæy_∑øm
("io_dñay", 
io_dñay_∑øm
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<löux/sched.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/ˇ∑bûôy.h
>

9 
	~<löux/î∫o.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/i›‹t.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/°ddef.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/thªad_öfo.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<asm/sysˇŒs.h
>

20 
	$£t_bôm≠
(*
bôm≠
, 
ba£
,

21 
exã¡
, 
√w_vÆue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
exã¡
; i++) {

26 i‡(
√w_vÆue
)

27 
	`__£t_bô
(
i
, 
bôm≠
);

29 
	`__˛ór_bô
(
i
, 
bôm≠
);

31 
	}
}

36 
asmlökage
 
	$sys_i›îm
(
‰om
, 
num
, 
tu∫_⁄
)

38 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

39 
tss_°ru˘
 *
tss
;

40 
i
, 
max_l⁄g
, 
byãs
, 
byãs_upd©ed
;

42 i‡((
‰om
 + 
num
 <‰omË|| (‰om +Çum > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 i‡(
tu∫_⁄
 && !
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 i‡(!
t
->
io_bôm≠_±r
) {

53 *
bôm≠
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 i‡(!
bôm≠
)

56  -
ENOMEM
;

58 
	`mem£t
(
bôm≠
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_bôm≠_±r
 = 
bôm≠
;

60 
	`£t_thªad_Êag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

72 
	`£t_bôm≠
(
t
->
io_bôm≠_±r
, 
‰om
, 
num
, !
tu∫_⁄
);

78 
max_l⁄g
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 i‡(
t
->
io_bôm≠_±r
[
i
] != ~0UL)

81 
max_l⁄g
 = 
i
;

83 
byãs
 = (
max_l⁄g
 + 1) * ();

84 
byãs_upd©ed
 = 
	`max
(
byãs
, 
t
->
io_bôm≠_max
);

86 
t
->
io_bôm≠_max
 = 
byãs
;

89 
	`mem˝y
(
tss
->
io_bôm≠
, 
t
->
io_bôm≠_±r
, 
byãs_upd©ed
);

91 
	`put_˝u
();

94 
	}
}

106 
	$do_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

108 
ﬁd
 = (
ªgs
->
Êags
 >> 12) & 3;

110 i‡(
Àvñ
 > 3)

111  -
EINVAL
;

113 i‡(
Àvñ
 > 
ﬁd
) {

114 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

115  -
EPERM
;

117 
ªgs
->
Êags
 = (ªgs->Êag†& ~
X86_EFLAGS_IOPL
Ë| (
Àvñ
 << 12);

120 
	}
}

122 #ifde‡
CONFIG_X86_32


123 
	$sys_i›l
(
±_ªgs
 *
ªgs
)

125 
Àvñ
 = 
ªgs
->
bx
;

126 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

127 
rc
;

129 
rc
 = 
	`do_i›l
(
Àvñ
, 
ªgs
);

130 i‡(
rc
 < 0)

131 
out
;

133 
t
->
i›l
 = 
Àvñ
 << 12;

134 
	`£t_i›l_mask
(
t
->
i›l
);

135 
out
:

136  
rc
;

137 
	}
}

139 
asmlökage
 
	$sys_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

141  
	`do_i›l
(
Àvñ
, 
ªgs
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<löux/˝u.h
>

5 
	~<löux/öãºu±.h
>

6 
	~<löux/kî√l_°©.h
>

7 
	~<löux/£q_fûe.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/·ø˚.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/io_≠ic.h
>

13 
	~<asm/úq.h
>

14 
	~<asm/idÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/hw_úq.h
>

18 
©omic_t
 
	gúq_îr_cou¡
;

21 (*
gíîic_öãºu±_exãnsi⁄
)(Ë
NULL
;

27 
	$ack_bad_úq
(
úq
)

29 i‡(
	`¥ötk_øãlimô
())

30 
	`¥_îr
("u√x≥˘ed IRQÅø∞© ve˘‹ %02x\n", 
úq
);

41 
	`ack_APIC_úq
();

42 
	}
}

44 
	#úq_°©s
(
x
Ë(&
	`≥r_˝u
(
úq_°©
, x))

	)

48 
	$show_Ÿhî_öãºu±s
(
£q_fûe
 *
p
, 
¥ec
)

50 
j
;

52 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "NMI");

53 
	`f‹_óch_⁄löe_˝u
(
j
)

54 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
__nmi_cou¡
);

55 
	`£q_¥ötf
(
p
, " Non-maskable interrupts\n");

56 #ifde‡
CONFIG_X86_LOCAL_APIC


57 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "LOC");

58 
	`f‹_óch_⁄löe_˝u
(
j
)

59 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_timî_úqs
);

60 
	`£q_¥ötf
(
p
, " LocalÅimer interrupts\n");

62 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "SPU");

63 
	`f‹_óch_⁄löe_˝u
(
j
)

64 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_•urious_cou¡
);

65 
	`£q_¥ötf
(
p
, " Spurious interrupts\n");

66 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CNT");

67 
	`f‹_óch_⁄löe_˝u
(
j
)

68 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥rf_úqs
);

69 
	`£q_¥ötf
(
p
, " Performance counter interrupts\n");

70 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PND");

71 
	`f‹_óch_⁄löe_˝u
(
j
)

72 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥ndög_úqs
);

73 
	`£q_¥ötf
(
p
, " PerformanceÖending work\n");

75 i‡(
gíîic_öãºu±_exãnsi⁄
) {

76 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PLT");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
gíîic_úqs
);

79 
	`£q_¥ötf
(
p
, " Platform interrupts\n");

81 #ifde‡
CONFIG_SMP


82 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "RES");

83 
	`f‹_óch_⁄löe_˝u
(
j
)

84 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ªsched_cou¡
);

85 
	`£q_¥ötf
(
p
, " Rescheduling interrupts\n");

86 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CAL");

87 
	`f‹_óch_⁄löe_˝u
(
j
)

88 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ˇŒ_cou¡
);

89 
	`£q_¥ötf
(
p
, " Function call interrupts\n");

90 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TLB");

91 
	`f‹_óch_⁄löe_˝u
(
j
)

92 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_éb_cou¡
);

93 
	`£q_¥ötf
(
p
, " TLB shootdowns\n");

95 #ifde‡
CONFIG_X86_MCE


96 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TRM");

97 
	`f‹_óch_⁄löe_˝u
(
j
)

98 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thîmÆ_cou¡
);

99 
	`£q_¥ötf
(
p
, " ThermalÉvent interrupts\n");

100 #ifde‡
CONFIG_X86_MCE_THRESHOLD


101 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "THR");

102 
	`f‹_óch_⁄löe_˝u
(
j
)

103 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thªshﬁd_cou¡
);

104 
	`£q_¥ötf
(
p
, " Threshold APIC interrupts\n");

107 #ifde‡
CONFIG_X86_NEW_MCE


108 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCE");

109 
	`f‹_óch_⁄löe_˝u
(
j
)

110 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
j
));

111 
	`£q_¥ötf
(
p
, " Machine checkÉxceptions\n");

112 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCP");

113 
	`f‹_óch_⁄löe_˝u
(
j
)

114 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
j
));

115 
	`£q_¥ötf
(
p
, " Machine checkÖolls\n");

117 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "ERR", 
	`©omic_ªad
(&
úq_îr_cou¡
));

118 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

119 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "MIS", 
	`©omic_ªad
(&
úq_mis_cou¡
));

122 
	}
}

124 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

126 
Êags
, 
™y_cou¡
 = 0;

127 
i
 = *(
loff_t
 *Ë
v
, 
j
, 
¥ec
;

128 
úqa˘i⁄
 *
a˘i⁄
;

129 
úq_desc
 *
desc
;

131 i‡(
i
 > 
ƒ_úqs
)

134 
¥ec
 = 3, 
j
 = 1000;Öª¯< 10 && j <
ƒ_úqs
; ++prec)

135 
j
 *= 10;

137 i‡(
i
 =
ƒ_úqs
)

138  
	`show_Ÿhî_öãºu±s
(
p
, 
¥ec
);

141 i‡(
i
 == 0) {

142 
	`£q_¥ötf
(
p
, "%*s", 
¥ec
 + 8, "");

143 
	`f‹_óch_⁄löe_˝u
(
j
)

144 
	`£q_¥ötf
(
p
, "CPU%-8d", 
j
);

145 
	`£q_putc
(
p
, '\n');

148 
desc
 = 
	`úq_to_desc
(
i
);

149 i‡(!
desc
)

152 
	`•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

153 
	`f‹_óch_⁄löe_˝u
(
j
)

154 
™y_cou¡
 |
	`k°©_úqs_˝u
(
i
, 
j
);

155 
a˘i⁄
 = 
desc
->action;

156 i‡(!
a˘i⁄
 && !
™y_cou¡
)

157 
out
;

159 
	`£q_¥ötf
(
p
, "%*d: ", 
¥ec
, 
i
);

160 
	`f‹_óch_⁄löe_˝u
(
j
)

161 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs_˝u
(
i
, 
j
));

162 
	`£q_¥ötf
(
p
, " %8s", 
desc
->
chù
->
«me
);

163 
	`£q_¥ötf
(
p
, "-%-8s", 
desc
->
«me
);

165 i‡(
a˘i⁄
) {

166 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

167 (
a˘i⁄
 =á˘i⁄->
√xt
Ë!
NULL
)

168 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

171 
	`£q_putc
(
p
, '\n');

172 
out
:

173 
	`•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

175 
	}
}

180 
u64
 
	$¨ch_úq_°©_˝u
(
˝u
)

182 
u64
 
sum
 = 
	`úq_°©s
(
˝u
)->
__nmi_cou¡
;

184 #ifde‡
CONFIG_X86_LOCAL_APIC


185 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_timî_úqs
;

186 
sum
 +
	`úq_°©s
(
˝u
)->
úq_•urious_cou¡
;

187 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥rf_úqs
;

188 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥ndög_úqs
;

190 i‡(
gíîic_öãºu±_exãnsi⁄
)

191 
sum
 +
	`úq_°©s
(
˝u
)->
gíîic_úqs
;

192 #ifde‡
CONFIG_SMP


193 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ªsched_cou¡
;

194 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ˇŒ_cou¡
;

195 
sum
 +
	`úq_°©s
(
˝u
)->
úq_éb_cou¡
;

197 #ifde‡
CONFIG_X86_MCE


198 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thîmÆ_cou¡
;

199 #ifde‡
CONFIG_X86_MCE_THRESHOLD


200 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thªshﬁd_cou¡
;

203 #ifde‡
CONFIG_X86_NEW_MCE


204 
sum
 +
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
˝u
);

205 
sum
 +
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
˝u
);

207  
sum
;

208 
	}
}

210 
u64
 
	$¨ch_úq_°©
()

212 
u64
 
sum
 = 
	`©omic_ªad
(&
úq_îr_cou¡
);

214 #ifde‡
CONFIG_X86_IO_APIC


215 
sum
 +
	`©omic_ªad
(&
úq_mis_cou¡
);

217  
sum
;

218 
	}
}

226 
__úq_íåy
 
	$do_IRQ
(
±_ªgs
 *
ªgs
)

228 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

231 
ve˘‹
 = ~
ªgs
->
‹ig_ax
;

232 
úq
;

234 
	`exô_idÀ
();

235 
	`úq_íãr
();

237 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

239 i‡(!
	`h™dÀ_úq
(
úq
, 
ªgs
)) {

240 
	`ack_APIC_úq
();

242 i‡(
	`¥ötk_øãlimô
())

243 
	`¥_emîg
("%s: %d.%d No irq handler for vector (irq %d)\n",

244 
__func__
, 
	`smp_¥o˚ss‹_id
(), 
ve˘‹
, 
úq
);

247 
	`úq_exô
();

249 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

251 
	}
}

256 
	$smp_gíîic_öãºu±
(
±_ªgs
 *
ªgs
)

258 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

260 
	`ack_APIC_úq
();

262 
	`exô_idÀ
();

264 
	`úq_íãr
();

266 
	`öc_úq_°©
(
gíîic_úqs
);

268 i‡(
gíîic_öãºu±_exãnsi⁄
)

269 
	`gíîic_öãºu±_exãnsi⁄
();

271 
	`úq_exô
();

273 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

274 
	}
}

276 
EXPORT_SYMBOL_GPL
(
ve˘‹_u£d_by_≥r˝u_úq
);

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/·ø˚.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/smp.h
>

19 
	~<asm/io_≠ic.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/≠ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
úq_˝u°©_t
, 
úq_°©
);

24 
EXPORT_PER_CPU_SYMBOL
(
úq_°©
);

26 
DEFINE_PER_CPU
(
±_ªgs
 *, 
úq_ªgs
);

27 
EXPORT_PER_CPU_SYMBOL
(
úq_ªgs
);

36 
ölöe
 
	$°ack_ovîÊow_check
(
±_ªgs
 *
ªgs
)

38 #ifde‡
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`èsk_°ack_∑ge
(
cuºít
);

41 
	`WARN_ONCE
(
ªgs
->
•
 >
curba£
 &&

42 
ªgs
->
•
 <
curba£
 + 
THREAD_SIZE
 &&

43 
ªgs
->
•
 < 
curba£
 + (
thªad_öfo
) +

44 (
±_ªgs
) + 128,

47 
cuºít
->
comm
, 
curba£
, 
ªgs
->
•
);

49 
	}
}

51 
boﬁ
 
	$h™dÀ_úq
(
úq
, 
±_ªgs
 *
ªgs
)

53 
úq_desc
 *
desc
;

55 
	`°ack_ovîÊow_check
(
ªgs
);

57 
desc
 = 
	`úq_to_desc
(
úq
);

58 i‡(
	`u∆ikñy
(!
desc
))

59  
Ál£
;

61 
	`gíîic_h™dÀ_úq_desc
(
úq
, 
desc
);

62  
åue
;

63 
	}
}

65 #ifde‡
CONFIG_HOTPLUG_CPU


67 
	$fixup_úqs
()

69 
úq
;

70 
w¨√d
;

71 
úq_desc
 *
desc
;

73 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

74 
bªak_afföôy
 = 0;

75 
£t_afföôy
 = 1;

76 c⁄° 
˝umask
 *
afföôy
;

78 i‡(!
desc
)

80 i‡(
úq
 == 2)

84 
	`•ö_lock
(&
desc
->
lock
);

86 
afföôy
 = 
desc
->affinity;

87 i‡(!
	`úq_has_a˘i⁄
(
úq
) ||

88 
	`˝umask_equÆ
(
afföôy
, 
˝u_⁄löe_mask
)) {

89 
	`•ö_u∆ock
(&
desc
->
lock
);

93 i‡(
	`˝umask_™y_™d
(
afföôy
, 
˝u_⁄löe_mask
Ë>
ƒ_˝u_ids
) {

94 
bªak_afföôy
 = 1;

95 
afföôy
 = 
˝u_Æl_mask
;

98 i‡(
desc
->
chù
->
mask
)

99 
desc
->
chù
->
	`mask
(
úq
);

101 i‡(
desc
->
chù
->
£t_afföôy
)

102 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
afföôy
);

103 i‡(!(
w¨√d
++))

104 
£t_afföôy
 = 0;

106 i‡(
desc
->
chù
->
unmask
)

107 
desc
->
chù
->
	`unmask
(
úq
);

109 
	`•ö_u∆ock
(&
desc
->
lock
);

111 i‡(
bªak_afföôy
 && 
£t_afföôy
)

112 
	`¥ötk
("Brokêafföôy f‹ irq %i\n", 
úq
);

113 i‡(!
£t_afföôy
)

114 
	`¥ötk
("C™nŸ sëáfföôy f‹ irq %i\n", 
úq
);

118 
	`loˇl_úq_íabÀ
();

119 
	`mdñay
(1);

120 
	`loˇl_úq_dißbÀ
();

121 
	}
}

124 
ˇŒ_so·úq
();

126 
asmlökage
 
	$do_so·úq
()

128 
__u32
 
≥ndög
;

129 
Êags
;

131 i‡(
	`ö_öãºu±
())

134 
	`loˇl_úq_ßve
(
Êags
);

135 
≥ndög
 = 
	`loˇl_so·úq_≥ndög
();

137 i‡(
≥ndög
) {

138 
	`ˇŒ_so·úq
();

139 
	`WARN_ON_ONCE
(
	`so·úq_cou¡
());

141 
	`loˇl_úq_ª°‹e
(
Êags
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/k¥obes.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/kî√l_°©.h
>

13 
	~<löux/sysdev.h
>

14 
	~<löux/bô›s.h
>

15 
	~<löux/a˝i.h
>

16 
	~<löux/io.h
>

17 
	~<löux/dñay.h
>

19 
	~<asm/©omic.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/hw_úq.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/desc.h
>

25 
	~<asm/≠ic.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/i8259.h
>

28 
	~<asm/å≠s.h
>

46 #ifde‡
CONFIG_X86_32


59 
úqªtu∫_t
 
	$m©h_îr‹_úq
(
˝l
, *
dev_id
)

61 
	`outb
(0, 0xF0);

62 i‡(
ign‹e_Âu_úq
 || !
boŸ_˝u_d©a
.
h¨d_m©h
)

63  
IRQ_NONE
;

64 
	`m©h_îr‹
((
__u£r
 *)
	`gë_úq_ªgs
()->
ù
);

65  
IRQ_HANDLED
;

66 
	}
}

72 
úqa˘i⁄
 
	gÂu_úq
 = {

73 .
h™dÀr
 = 
m©h_îr‹_úq
,

74 .
	g«me
 = "fpu",

81 
úqa˘i⁄
 
	gúq2
 = {

82 .
h™dÀr
 = 
no_a˘i⁄
,

83 .
	g«me
 = "cascade",

86 
DEFINE_PER_CPU
(
ve˘‹_úq_t
, 
ve˘‹_úq
) = {

87 [0 ... 
IRQ0_VECTOR
 - 1] = -1,

88 [
IRQ0_VECTOR
] = 0,

89 [
IRQ1_VECTOR
] = 1,

90 [
IRQ2_VECTOR
] = 2,

91 [
IRQ3_VECTOR
] = 3,

92 [
IRQ4_VECTOR
] = 4,

93 [
IRQ5_VECTOR
] = 5,

94 [
IRQ6_VECTOR
] = 6,

95 [
IRQ7_VECTOR
] = 7,

96 [
IRQ8_VECTOR
] = 8,

97 [
IRQ9_VECTOR
] = 9,

98 [
IRQ10_VECTOR
] = 10,

99 [
IRQ11_VECTOR
] = 11,

100 [
IRQ12_VECTOR
] = 12,

101 [
IRQ13_VECTOR
] = 13,

102 [
IRQ14_VECTOR
] = 14,

103 [
IRQ15_VECTOR
] = 15,

104 [
IRQ15_VECTOR
 + 1 ... 
NR_VECTORS
 - 1] = -1

107 
	$ve˘‹_u£d_by_≥r˝u_úq
(
ve˘‹
)

109 
˝u
;

111 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

112 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] != -1)

117 
	}
}

119 
__öô
 
	$öô_ISA_úqs
()

121 
i
;

123 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

124 
	`öô_b•_APIC
();

126 
	`öô_8259A
(0);

131 
i
 = 0; i < 
NR_IRQS_LEGACY
; i++) {

132 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
i
);

134 
desc
->
°©us
 = 
IRQ_DISABLED
;

135 
desc
->
a˘i⁄
 = 
NULL
;

136 
desc
->
dïth
 = 1;

138 
	`£t_úq_chù_™d_h™dÀr_«me
(
i
, &
i8259A_chù
,

139 
h™dÀ_Àvñ_úq
, "XT");

141 
	}
}

144 
	$öô_IRQ
(Ë
	`__©åibuã__
((
wók
, 
	`Æüs
("native_init_IRQ")));

146 
__öô
 
	$smp_öå_öô
()

148 #ifde‡
CONFIG_SMP


149 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

154 
	`Æloc_öå_g©e
(
RESCHEDULE_VECTOR
, 
ªscheduÀ_öãºu±
);

157 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
övÆid©e_öãºu±0
);

158 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
övÆid©e_öãºu±1
);

159 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
övÆid©e_öãºu±2
);

160 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
övÆid©e_öãºu±3
);

161 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
övÆid©e_öãºu±4
);

162 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
övÆid©e_öãºu±5
);

163 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
övÆid©e_öãºu±6
);

164 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
övÆid©e_öãºu±7
);

167 
	`Æloc_öå_g©e
(
CALL_FUNCTION_VECTOR
, 
ˇŒ_fun˘i⁄_öãºu±
);

170 
	`Æloc_öå_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

171 
ˇŒ_fun˘i⁄_sögÀ_öãºu±
);

174 
	`£t_öå_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
úq_move_˛ónup_öãºu±
);

175 
	`£t_bô
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_ve˘‹s
);

178 
	`Æloc_öå_g©e
(
REBOOT_VECTOR
, 
ªboŸ_öãºu±
);

181 
	}
}

183 
__öô
 
	$≠ic_öå_öô
()

185 
	`smp_öå_öô
();

187 #ifde‡
CONFIG_X86_THERMAL_VECTOR


188 
	`Æloc_öå_g©e
(
THERMAL_APIC_VECTOR
, 
thîmÆ_öãºu±
);

190 #ifde‡
CONFIG_X86_MCE_THRESHOLD


191 
	`Æloc_öå_g©e
(
THRESHOLD_APIC_VECTOR
, 
thªshﬁd_öãºu±
);

193 #i‡
	`deföed
(
CONFIG_X86_NEW_MCE
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

194 
	`Æloc_öå_g©e
(
MCE_SELF_VECTOR
, 
m˚_£lf_öãºu±
);

197 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

199 
	`Æloc_öå_g©e
(
LOCAL_TIMER_VECTOR
, 
≠ic_timî_öãºu±
);

202 
	`Æloc_öå_g©e
(
GENERIC_INTERRUPT_VECTOR
, 
gíîic_öãºu±
);

205 
	`Æloc_öå_g©e
(
SPURIOUS_APIC_VECTOR
, 
•urious_öãºu±
);

206 
	`Æloc_öå_g©e
(
ERROR_APIC_VECTOR
, 
îr‹_öãºu±
);

209 #ifde‡
CONFIG_PERF_COUNTERS


210 
	`Æloc_öå_g©e
(
LOCAL_PENDING_VECTOR
, 
≥rf_≥ndög_öãºu±
);

214 
	}
}

225 
__öô
 
	$x86_quúk_¥e_öå_öô
()

227 #ifde‡
CONFIG_X86_32


228 i‡(
x86_quúks
->
¨ch_¥e_öå_öô
) {

229 i‡(
x86_quúks
->
	`¨ch_¥e_öå_öô
())

233 
	`öô_ISA_úqs
();

234 
	}
}

236 
__öô
 
	$«tive_öô_IRQ
()

238 
i
;

241 
	`x86_quúk_¥e_öå_öô
();

243 
	`≠ic_öå_öô
();

250 
i
 = 
FIRST_EXTERNAL_VECTOR
; i < 
NR_VECTORS
; i++) {

252 i‡(!
	`ã°_bô
(
i
, 
u£d_ve˘‹s
))

253 
	`£t_öå_g©e
(
i
, 
öãºu±
[i-
FIRST_EXTERNAL_VECTOR
]);

256 i‡(!
a˝i_iﬂpic
)

257 
	`£tup_úq
(2, &
úq2
);

259 #ifde‡
CONFIG_X86_32


264 
	`x86_quúk_öå_öô
();

270 i‡(
boŸ_˝u_d©a
.
h¨d_m©h
 && !
˝u_has_Âu
)

271 
	`£tup_úq
(
FPU_IRQ
, &
Âu_úq
);

273 
	`úq_˘x_öô
(
	`smp_¥o˚ss‹_id
());

275 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<löux/gÂ.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<löux/öô.h
>

8 
	~<löux/î∫o.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/•ölock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_n‹thbridges
;

14 
EXPORT_SYMBOL
(
num_k8_n‹thbridges
);

16 
u32
 *
	gÊush_w‹ds
;

18 
pci_devi˚_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_n‹thbridges
;

26 
EXPORT_SYMBOL
(
k8_n‹thbridges
);

28 
pci_dev
 *
	$√xt_k8_n‹thbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 i‡(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ˇche_k8_n‹thbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 i‡(
num_k8_n‹thbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
)

48 
num_k8_n‹thbridges
++;

50 
k8_n‹thbridges
 = 
	`kmÆloc
((
num_k8_n‹thbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 i‡(!
k8_n‹thbridges
)

53  -
ENOMEM
;

55 i‡(!
num_k8_n‹thbridges
) {

56 
k8_n‹thbridges
[0] = 
NULL
;

60 
Êush_w‹ds
 = 
	`kmÆloc
(
num_k8_n‹thbridges
 * (
u32
), 
GFP_KERNEL
);

61 i‡(!
Êush_w‹ds
) {

62 
	`k‰ì
(
k8_n‹thbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
) {

69 
k8_n‹thbridges
[
i
] = 
dev
;

70 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x9c, &
Êush_w‹ds
[
i
++]);

72 
k8_n‹thbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ˇche_k8_n‹thbridges
);

79 
__öô
 
	$óæy_is_k8_nb
(
u32
 
devi˚
)

81 
pci_devi˚_id
 *
id
;

82 
u32
 
víd‹
 = 
devi˚
 & 0xffff;

83 
devi˚
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
víd‹
; id++)

85 i‡(
víd‹
 =
id
->víd‹ && 
devi˚
 == id->device)

88 
	}
}

90 
	$k8_Êush_g¨ts
()

92 
Êushed
, 
i
;

93 
Êags
;

94 
	`DEFINE_SPINLOCK
(
g¨t_lock
);

100 
	`•ö_lock_úqßve
(&
g¨t_lock
, 
Êags
);

101 
Êushed
 = 0;

102 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

103 
	`pci_wrôe_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
], 0x9c,

104 
Êush_w‹ds
[
i
]|1);

105 
Êushed
++;

107 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_ªad_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
],

112 0x9c, &
w
);

113 i‡(!(
w
 & 1))

115 
	`˝u_ªœx
();

118 
	`•ö_u∆ock_úqª°‹e
(&
g¨t_lock
, 
Êags
);

119 i‡(!
Êushed
)

120 
	`¥ötk
("nothingÅo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_Êush_g¨ts
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<löux/debugfs.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/°©.h
>

14 
	~<löux/io.h
>

15 
	~<löux/mm.h
>

17 
	~<asm/£tup.h
>

19 
díåy
 *
	g¨ch_debugfs_dú
;

20 
EXPORT_SYMBOL
(
¨ch_debugfs_dú
);

22 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


23 
	s£tup_d©a_node
 {

24 
u64
 
	m∑ddr
;

25 
u32
 
	mty≥
;

26 
u32
 
	mÀn
;

29 
ssize_t
 
	$£tup_d©a_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

30 
size_t
 
cou¡
, 
loff_t
 *
µos
)

32 
£tup_d©a_node
 *
node
 = 
fûe
->
¥iv©e_d©a
;

33 
ªmaö
;

34 
loff_t
 
pos
 = *
µos
;

35 
∑ge
 *
pg
;

36 *
p
;

37 
u64
 
∑
;

39 i‡(
pos
 < 0)

40  -
EINVAL
;

42 i‡(
pos
 >
node
->
Àn
)

45 i‡(
cou¡
 > 
node
->
Àn
 - 
pos
)

46 
cou¡
 = 
node
->
Àn
 - 
pos
;

48 
∑
 = 
node
->
∑ddr
 + (
£tup_d©a
Ë+ 
pos
;

49 
pg
 = 
	`p‚_to_∑ge
((
∑
 + 
cou¡
 - 1Ë>> 
PAGE_SHIFT
);

50 i‡(
	`PageHighMem
(
pg
)) {

51 
p
 = 
	`i‹em≠_ˇche
(
∑
, 
cou¡
);

52 i‡(!
p
)

53  -
ENXIO
;

55 
p
 = 
	`__va
(
∑
);

57 
ªmaö
 = 
	`c›y_to_u£r
(
u£r_buf
, 
p
, 
cou¡
);

59 i‡(
	`PageHighMem
(
pg
))

60 
	`iounm≠
(
p
);

62 i‡(
ªmaö
)

63  -
EFAULT
;

65 *
µos
 = 
pos
 + 
cou¡
;

67  
cou¡
;

68 
	}
}

70 
	$£tup_d©a_›í
(
öode
 *öode, 
fûe
 *file)

72 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

75 
	}
}

77 c⁄° 
fûe_›î©i⁄s
 
	gf›s_£tup_d©a
 = {

78 .
ªad
 = 
£tup_d©a_ªad
,

79 .
	g›í
 = 
£tup_d©a_›í
,

82 
__öô


83 
	$¸óã_£tup_d©a_node
(
díåy
 *
∑ª¡
, 
no
,

84 
£tup_d©a_node
 *
node
)

86 
díåy
 *
d
, *
ty≥
, *
d©a
;

87 
buf
[16];

89 
	`•rötf
(
buf
, "%d", 
no
);

90 
d
 = 
	`debugfs_¸óã_dú
(
buf
, 
∑ª¡
);

91 i‡(!
d
)

92  -
ENOMEM
;

94 
ty≥
 = 
	`debugfs_¸óã_x32
("ty≥", 
S_IRUGO
, 
d
, &
node
->type);

95 i‡(!
ty≥
)

96 
îr_dú
;

98 
d©a
 = 
	`debugfs_¸óã_fûe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
f›s_£tup_d©a
);

99 i‡(!
d©a
)

100 
îr_ty≥
;

104 
îr_ty≥
:

105 
	`debugfs_ªmove
(
ty≥
);

106 
îr_dú
:

107 
	`debugfs_ªmove
(
d
);

108  -
ENOMEM
;

109 
	}
}

111 
__öô
 
	$¸óã_£tup_d©a_nodes
(
díåy
 *
∑ª¡
)

113 
£tup_d©a_node
 *
node
;

114 
£tup_d©a
 *
d©a
;

115 
îr‹
 = -
ENOMEM
;

116 
díåy
 *
d
;

117 
∑ge
 *
pg
;

118 
u64
 
∑_d©a
;

119 
no
 = 0;

121 
d
 = 
	`debugfs_¸óã_dú
("£tup_d©a", 
∑ª¡
);

122 i‡(!
d
)

123  -
ENOMEM
;

125 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

127 
∑_d©a
) {

128 
node
 = 
	`kmÆloc
((*node), 
GFP_KERNEL
);

129 i‡(!
node
)

130 
îr_dú
;

132 
pg
 = 
	`p‚_to_∑ge
((
∑_d©a
+(*
d©a
)-1Ë>> 
PAGE_SHIFT
);

133 i‡(
	`PageHighMem
(
pg
)) {

134 
d©a
 = 
	`i‹em≠_ˇche
(
∑_d©a
, (*data));

135 i‡(!
d©a
) {

136 
	`k‰ì
(
node
);

137 
îr‹
 = -
ENXIO
;

138 
îr_dú
;

141 
d©a
 = 
	`__va
(
∑_d©a
);

143 
node
->
∑ddr
 = 
∑_d©a
;

144 
node
->
ty≥
 = 
d©a
->type;

145 
node
->
Àn
 = 
d©a
->len;

146 
îr‹
 = 
	`¸óã_£tup_d©a_node
(
d
, 
no
, 
node
);

147 
∑_d©a
 = 
d©a
->
√xt
;

149 i‡(
	`PageHighMem
(
pg
))

150 
	`iounm≠
(
d©a
);

151 i‡(
îr‹
)

152 
îr_dú
;

153 
no
++;

158 
îr_dú
:

159 
	`debugfs_ªmove
(
d
);

160  
îr‹
;

161 
	}
}

163 
debugfs_blob_wøµî
 
	gboŸ_∑øms_blob
 = {

164 .
d©a
 = &
boŸ_∑øms
,

165 .
	gsize
 = (
boŸ_∑øms
),

168 
__öô
 
	$boŸ_∑øms_kdebugfs_öô
()

170 
díåy
 *
dbp
, *
vîsi⁄
, *
d©a
;

171 
îr‹
 = -
ENOMEM
;

173 
dbp
 = 
	`debugfs_¸óã_dú
("boŸ_∑øms", 
NULL
);

174 i‡(!
dbp
)

175  -
ENOMEM
;

177 
vîsi⁄
 = 
	`debugfs_¸óã_x16
("vîsi⁄", 
S_IRUGO
, 
dbp
,

178 &
boŸ_∑øms
.
hdr
.
vîsi⁄
);

179 i‡(!
vîsi⁄
)

180 
îr_dú
;

182 
d©a
 = 
	`debugfs_¸óã_blob
("d©a", 
S_IRUGO
, 
dbp
,

183 &
boŸ_∑øms_blob
);

184 i‡(!
d©a
)

185 
îr_vîsi⁄
;

187 
îr‹
 = 
	`¸óã_£tup_d©a_nodes
(
dbp
);

188 i‡(
îr‹
)

189 
îr_d©a
;

193 
îr_d©a
:

194 
	`debugfs_ªmove
(
d©a
);

195 
îr_vîsi⁄
:

196 
	`debugfs_ªmove
(
vîsi⁄
);

197 
îr_dú
:

198 
	`debugfs_ªmove
(
dbp
);

199  
îr‹
;

200 
	}
}

203 
__öô
 
	$¨ch_kdebugfs_öô
()

205 
îr‹
 = 0;

207 
¨ch_debugfs_dú
 = 
	`debugfs_¸óã_dú
("x86", 
NULL
);

208 i‡(!
¨ch_debugfs_dú
)

209  -
ENOMEM
;

211 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


212 
îr‹
 = 
	`boŸ_∑øms_kdebugfs_öô
();

215  
îr‹
;

216 
	}
}

217 
¨ch_öôˇŒ
(
¨ch_kdebugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<löux/k¥obes.h
>

44 
	~<löux/±ø˚.h
>

45 
	~<löux/°rög.h
>

46 
	~<löux/¶ab.h
>

47 
	~<löux/h¨dúq.h
>

48 
	~<löux/¥ìm±.h
>

49 
	~<löux/moduÀ.h
>

50 
	~<löux/kdebug.h
>

52 
	~<asm/ˇcheÊush.h
>

53 
	~<asm/desc.h
>

54 
	~<asm/pgèbÀ.h
>

55 
	~<asm/uac˚ss.h
>

56 
	~<asm/Æã∫©ive.h
>

58 
j¥obe_ªtu∫_íd
();

60 
DEFINE_PER_CPU
(
k¥obe
 *, 
cuºít_k¥obe
Ë
NULL
;

61 
DEFINE_PER_CPU
(
k¥obe_˘lblk
, kprobe_ctlblk);

63 #ifde‡
CONFIG_X86_64


64 
	#°ack_addr
(
ªgs
Ë((*Ïegs->
•
)

	)

74 
	#°ack_addr
(
ªgs
Ë((*)&ªgs->
•
)

	)

77 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

78 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

79 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

80 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

81 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

82 << (
row
 % 32))

	)

87 c⁄° 
u32
 
	gtwobyã_is_boo°abÀ
[256 / 32] = {

90 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

91 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

92 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

93 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

94 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

95 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

96 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

97 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

98 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

99 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

100 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

101 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

102 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

103 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

104 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

105 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

109 c⁄° 
u32
 
	g⁄ebyã_has_modrm
[256 / 32] = {

112 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

113 
W
(0x10, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

114 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

115 
W
(0x30, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

116 
W
(0x40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

117 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

118 
W
(0x60, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0) |

119 
W
(0x70, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

120 
W
(0x80, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

121 
W
(0x90, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

122 
W
(0xa0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

123 
W
(0xb0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

124 
W
(0xc0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

125 
W
(0xd0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) ,

126 
W
(0xe0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

127 
W
(0xf0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1)

131 c⁄° 
u32
 
	gtwobyã_has_modrm
[256 / 32] = {

134 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1) |

135 
W
(0x10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0) ,

136 
W
(0x20, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

137 
W
(0x30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

138 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

139 
W
(0x50, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

140 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

141 
W
(0x70, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1) ,

142 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

143 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

144 
W
(0xa0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) |

145 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1) ,

146 
W
(0xc0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

147 
W
(0xd0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

148 
W
(0xe0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

149 
W
(0xf0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0)

153 #unde‡
W


155 
kªçrobe_bœckpoöt
 
	gkªçrobe_bœckli°
[] = {

158 {
NULL
, NULL}

160 c⁄° 
	gkªçrobe_bœckli°_size
 = 
ARRAY_SIZE
(
kªçrobe_bœckli°
);

163 
__k¥obes
 
	$£t_jmp_›
(*
‰om
, *
to
)

165 
	s__¨ch_jmp_›
 {

166 
›
;

167 
s32
 
øddr
;

168 } 
	`__©åibuã__
((
∑cked
)Ë* 
j›
;

169 
j›
 = (
__¨ch_jmp_›
 *)
‰om
;

170 
j›
->
øddr
 = (
s32
)(()(
to
Ë- (()(
‰om
) + 5));

171 
j›
->
›
 = 
RELATIVEJUMP_INSTRUCTION
;

172 
	}
}

178 
__k¥obes
 
	$is_REX_¥efix
(
k¥obe_›code_t
 *
ö¢
)

180 #ifde‡
CONFIG_X86_64


181 i‡((*
ö¢
 & 0xf0) == 0x40)

185 
	}
}

191 
__k¥obes
 
	$ˇn_boo°
(
k¥obe_›code_t
 *
›codes
)

193 
k¥obe_›code_t
 
›code
;

194 
k¥obe_›code_t
 *
‹ig_›codes
 = 
›codes
;

196 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(()
›codes
))

199 
ªåy
:

200 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

202 
›code
 = *(
›codes
++);

205 i‡(
›code
 == 0x0f) {

206 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

208  
	`ã°_bô
(*
›codes
,

209 (*)
twobyã_is_boo°abÀ
);

212 
›code
 & 0xf0) {

213 #ifde‡
CONFIG_X86_64


215 
ªåy
;

218 i‡(0x63 < 
›code
 && opcode < 0x67)

219 
ªåy
;

221  (
›code
 != 0x62 && opcode != 0x67);

226  (0xc1 < 
›code
 && opcode < 0xcc) || opcode == 0xcf;

229  (
›code
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

232  ((
›code
 & 0x04) || opcode == 0xea);

234 i‡((
›code
 & 0x0c) == 0 && opcode != 0xf1)

235 
ªåy
;

237  (
›code
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

240 i‡(
›code
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

241 
ªåy
;

243  (
›code
 != 0x2e && opcode != 0x9a);

245 
	}
}

250 
__k¥obes
 
	$is_IF_modifõr
(
k¥obe_›code_t
 *
ö¢
)

252 *
ö¢
) {

264 i‡(
	`is_REX_¥efix
(
ö¢
))

265  
	`is_IF_modifõr
(++
ö¢
);

268 
	}
}

277 
__k¥obes
 
	$fix_rùªl
(
k¥obe
 *
p
)

279 #ifde‡
CONFIG_X86_64


280 
u8
 *
ö¢
 = 
p
->
aö¢
.insn;

281 
s64
 
di•
;

282 
√ed_modrm
;

286 *
ö¢
) {

298 ++
ö¢
;

305 i‡(
	`is_REX_¥efix
(
ö¢
))

306 ++
ö¢
;

308 i‡(*
ö¢
 == 0x0f) {

310 ++
ö¢
;

311 
√ed_modrm
 = 
	`ã°_bô
(*
ö¢
,

312 (*)
twobyã_has_modrm
);

315 
√ed_modrm
 = 
	`ã°_bô
(*
ö¢
,

316 (*)
⁄ebyã_has_modrm
);

318 i‡(
√ed_modrm
) {

319 
u8
 
modrm
 = *++
ö¢
;

320 i‡((
modrm
 & 0xc7) == 0x05) {

323 ++
ö¢
;

337 
di•
 = (
u8
 *Ë
p
->
addr
 + *((
s32
 *Ë
ö¢
) -

338 (
u8
 *Ë
p
->
aö¢
.
ö¢
;

339 
	`BUG_ON
((
s64
Ë(
s32
Ë
di•
 != disp);

340 *(
s32
 *)
ö¢
 = (s32Ë
di•
;

344 
	}
}

346 
__k¥obes
 
	$¨ch_c›y_k¥obe
(
k¥obe
 *
p
)

348 
	`mem˝y
(
p
->
aö¢
.
ö¢
,Ö->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

350 
	`fix_rùªl
(
p
);

352 i‡(
	`ˇn_boo°
(
p
->
addr
))

353 
p
->
aö¢
.
boo°abÀ
 = 0;

355 
p
->
aö¢
.
boo°abÀ
 = -1;

357 
p
->
›code
 = *p->
addr
;

358 
	}
}

360 
__k¥obes
 
	$¨ch_¥ï¨e_k¥obe
(
k¥obe
 *
p
)

363 
p
->
aö¢
.
ö¢
 = 
	`gë_ö¢_¶Ÿ
();

364 i‡(!
p
->
aö¢
.
ö¢
)

365  -
ENOMEM
;

366 
	`¨ch_c›y_k¥obe
(
p
);

368 
	}
}

370 
__k¥obes
 
	$¨ch_¨m_k¥obe
(
k¥obe
 *
p
)

372 
	`ãxt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

373 
	}
}

375 
__k¥obes
 
	$¨ch_dißrm_k¥obe
(
k¥obe
 *
p
)

377 
	`ãxt_poke
(
p
->
addr
, &p->
›code
, 1);

378 
	}
}

380 
__k¥obes
 
	$¨ch_ªmove_k¥obe
(
k¥obe
 *
p
)

382 i‡(
p
->
aö¢
.
ö¢
) {

383 
	`‰ì_ö¢_¶Ÿ
(
p
->
aö¢
.
ö¢
, (p->aö¢.
boo°abÀ
 == 1));

384 
p
->
aö¢
.
ö¢
 = 
NULL
;

386 
	}
}

388 
__k¥obes
 
	$ßve_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

390 
kcb
->
¥ev_k¥obe
.
kp
 = 
	`k¥obe_ru¬ög
();

391 
kcb
->
¥ev_k¥obe
.
°©us
 = kcb->
k¥obe_°©us
;

392 
kcb
->
¥ev_k¥obe
.
ﬁd_Êags
 = kcb->
k¥obe_ﬁd_Êags
;

393 
kcb
->
¥ev_k¥obe
.
ßved_Êags
 = kcb->
k¥obe_ßved_Êags
;

394 
	}
}

396 
__k¥obes
 
	$ª°‹e_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

398 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
kcb
->
¥ev_k¥obe
.
kp
;

399 
kcb
->
k¥obe_°©us
 = kcb->
¥ev_k¥obe
.
°©us
;

400 
kcb
->
k¥obe_ﬁd_Êags
 = kcb->
¥ev_k¥obe
.
ﬁd_Êags
;

401 
kcb
->
k¥obe_ßved_Êags
 = kcb->
¥ev_k¥obe
.
ßved_Êags
;

402 
	}
}

404 
__k¥obes
 
	$£t_cuºít_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

405 
k¥obe_˘lblk
 *
kcb
)

407 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
p
;

408 
kcb
->
k¥obe_ßved_Êags
 = kcb->
k¥obe_ﬁd_Êags


409 (
ªgs
->
Êags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

410 i‡(
	`is_IF_modifõr
(
p
->
aö¢
.
ö¢
))

411 
kcb
->
k¥obe_ßved_Êags
 &~
X86_EFLAGS_IF
;

412 
	}
}

414 
__k¥obes
 
	$˛ór_btf
()

416 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

417 
	`upd©e_debug˘lm§
(0);

418 
	}
}

420 
__k¥obes
 
	$ª°‹e_btf
()

422 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

423 
	`upd©e_debug˘lm§
(
cuºít
->
thªad
.
debug˘lm§
);

424 
	}
}

426 
__k¥obes
 
	$¥ï¨e_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

428 
	`˛ór_btf
();

429 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

430 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

432 i‡(
p
->
›code
 =
BREAKPOINT_INSTRUCTION
)

433 
ªgs
->
ù
 = ()
p
->
addr
;

435 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

436 
	}
}

438 
__k¥obes
 
	$¨ch_¥ï¨e_kªçrobe
(
kªçrobe_ö°™˚
 *
ri
,

439 
±_ªgs
 *
ªgs
)

441 *
ßø
 = 
	`°ack_addr
(
ªgs
);

443 
ri
->
ªt_addr
 = (
k¥obe_›code_t
 *Ë*
ßø
;

446 *
ßø
 = (Ë&
kªçrobe_åampﬁöe
;

447 
	}
}

449 
__k¥obes
 
	$£tup_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

450 
k¥obe_˘lblk
 *
kcb
)

452 #i‡!
	`deföed
(
CONFIG_PREEMPT
Ë|| deföed(
CONFIG_FREEZER
)

453 i‡(
p
->
aö¢
.
boo°abÀ
 =1 && !p->
po°_h™dÀr
) {

455 
	`ª£t_cuºít_k¥obe
();

456 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

457 
	`¥ìm±_íabÀ_no_ªsched
();

461 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

462 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SS
;

463 
	}
}

470 
__k¥obes
 
	$ªíãr_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

471 
k¥obe_˘lblk
 *
kcb
)

473 
kcb
->
k¥obe_°©us
) {

474 
KPROBE_HIT_SSDONE
:

475 #ifde‡
CONFIG_X86_64


480 
	`¨ch_dißrm_k¥obe
(
p
);

481 
ªgs
->
ù
 = ()
p
->
addr
;

482 
	`ª£t_cuºít_k¥obe
();

483 
	`¥ìm±_íabÀ_no_ªsched
();

486 
KPROBE_HIT_ACTIVE
:

487 
	`ßve_¥evious_k¥obe
(
kcb
);

488 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

489 
	`k¥obes_öc_nmis£d_cou¡
(
p
);

490 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

491 
kcb
->
k¥obe_°©us
 = 
KPROBE_REENTER
;

493 
KPROBE_HIT_SS
:

494 i‡(
p
 =
	`k¥obe_ru¬ög
()) {

495 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

496 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

508 
	`WARN_ON
(1);

513 
	}
}

519 
__k¥obes
 
	$k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

521 
k¥obe_›code_t
 *
addr
;

522 
k¥obe
 *
p
;

523 
k¥obe_˘lblk
 *
kcb
;

525 
addr
 = (
k¥obe_›code_t
 *)(
ªgs
->
ù
 - (kprobe_opcode_t));

526 i‡(*
addr
 !
BREAKPOINT_INSTRUCTION
) {

536 
ªgs
->
ù
 = ()
addr
;

546 
	`¥ìm±_dißbÀ
();

548 
kcb
 = 
	`gë_k¥obe_˘lblk
();

549 
p
 = 
	`gë_k¥obe
(
addr
);

551 i‡(
p
) {

552 i‡(
	`k¥obe_ru¬ög
()) {

553 i‡(
	`ªíãr_k¥obe
(
p
, 
ªgs
, 
kcb
))

556 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

557 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

567 i‡(!
p
->
¥e_h™dÀr
 || !p->
	`¥e_h™dÀr
’, 
ªgs
))

568 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

571 } i‡(
	`k¥obe_ru¬ög
()) {

572 
p
 = 
	`__gë_˝u_v¨
(
cuºít_k¥obe
);

573 i‡(
p
->
bªak_h™dÀr
 &&Ö->
	`bªak_h™dÀr
’, 
ªgs
)) {

574 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

579 
	`¥ìm±_íabÀ_no_ªsched
();

581 
	}
}

587 
__u£d
 
__k¥obes
 
	$kªçrobe_åampﬁöe_hﬁdî
()

589 
asm
 volatile (

592 #ifde‡
CONFIG_X86_64


674 
	}
}

679 
__u£d
 
__k¥obes
 *
	$åampﬁöe_h™dÀr
(
±_ªgs
 *
ªgs
)

681 
kªçrobe_ö°™˚
 *
ri
 = 
NULL
;

682 
hli°_hód
 *
hód
, 
em±y_Ω
;

683 
hli°_node
 *
node
, *
tmp
;

684 
Êags
, 
‹ig_ªt_addªss
 = 0;

685 
åampﬁöe_addªss
 = ()&
kªçrobe_åampﬁöe
;

687 
	`INIT_HLIST_HEAD
(&
em±y_Ω
);

688 
	`kªçrobe_hash_lock
(
cuºít
, &
hód
, &
Êags
);

690 #ifde‡
CONFIG_X86_64


691 
ªgs
->
cs
 = 
__KERNEL_CS
;

693 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

694 
ªgs
->
gs
 = 0;

696 
ªgs
->
ù
 = 
åampﬁöe_addªss
;

697 
ªgs
->
‹ig_ax
 = ~0UL;

712 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, 
hód
, 
hli°
) {

713 i‡(
ri
->
èsk
 !
cuºít
)

717 i‡(
ri
->
Ω
 &&Ñi->Ω->
h™dÀr
) {

718 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
ri
->
Ω
->
kp
;

719 
	`gë_k¥obe_˘lblk
()->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

720 
ri
->
Ω
->
	`h™dÀr
‘i, 
ªgs
);

721 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

724 
‹ig_ªt_addªss
 = ()
ri
->
ªt_addr
;

725 
	`ªcy˛e_Ω_ö°
(
ri
, &
em±y_Ω
);

727 i‡(
‹ig_ªt_addªss
 !
åampﬁöe_addªss
)

736 
	`kªçrobe_as£π
(
ri
, 
‹ig_ªt_addªss
, 
åampﬁöe_addªss
);

738 
	`kªçrobe_hash_u∆ock
(
cuºít
, &
Êags
);

740 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, &
em±y_Ω
, 
hli°
) {

741 
	`hli°_dñ
(&
ri
->
hli°
);

742 
	`k‰ì
(
ri
);

744  (*)
‹ig_ªt_addªss
;

745 
	}
}

774 
__k¥obes
 
	$ªsume_executi⁄
(
k¥obe
 *
p
,

775 
±_ªgs
 *
ªgs
, 
k¥obe_˘lblk
 *
kcb
)

777 *
tos
 = 
	`°ack_addr
(
ªgs
);

778 
c›y_ù
 = ()
p
->
aö¢
.
ö¢
;

779 
‹ig_ù
 = ()
p
->
addr
;

780 
k¥obe_›code_t
 *
ö¢
 = 
p
->
aö¢
.insn;

783 i‡(
	`is_REX_¥efix
(
ö¢
))

784 
ö¢
++;

786 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

787 *
ö¢
) {

789 *
tos
 &~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

790 *
tos
 |
kcb
->
k¥obe_ﬁd_Êags
;

799 
p
->
aö¢
.
boo°abÀ
 = 1;

800 
no_ch™ge
;

802 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

804 #ifde‡
CONFIG_X86_32


806 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

807 
no_ch™ge
;

810 i‡((
ö¢
[1] & 0x30) == 0x10) {

816 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

817 
no_ch™ge
;

818 } i‡(((
ö¢
[1] & 0x31) == 0x20) ||

819 ((
ö¢
[1] & 0x31) == 0x21)) {

824 
p
->
aö¢
.
boo°abÀ
 = 1;

825 
no_ch™ge
;

831 i‡(
p
->
aö¢
.
boo°abÀ
 == 0) {

832 i‡((
ªgs
->
ù
 > 
c›y_ù
) &&

833 (
ªgs
->
ù
 - 
c›y_ù
Ë+ 5 < 
MAX_INSN_SIZE
) {

838 
	`£t_jmp_›
((*)
ªgs
->
ù
,

839 (*)
‹ig_ù
 + (
ªgs
->
ù
 - 
c›y_ù
));

840 
p
->
aö¢
.
boo°abÀ
 = 1;

842 
p
->
aö¢
.
boo°abÀ
 = -1;

846 
ªgs
->
ù
 +
‹ig_ù
 - 
c›y_ù
;

848 
no_ch™ge
:

849 
	`ª°‹e_btf
();

850 
	}
}

856 
__k¥obes
 
	$po°_k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

858 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

859 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

861 i‡(!
cur
)

864 
	`ªsume_executi⁄
(
cur
, 
ªgs
, 
kcb
);

865 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

867 i‡((
kcb
->
k¥obe_°©us
 !
KPROBE_REENTER
Ë&& 
cur
->
po°_h™dÀr
) {

868 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SSDONE
;

869 
cur
->
	`po°_h™dÀr
(cur, 
ªgs
, 0);

873 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
) {

874 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

875 
out
;

877 
	`ª£t_cuºít_k¥obe
();

878 
out
:

879 
	`¥ìm±_íabÀ_no_ªsched
();

886 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
)

890 
	}
}

892 
__k¥obes
 
	$k¥obe_Áu…_h™dÀr
(
±_ªgs
 *
ªgs
, 
å≠ƒ
)

894 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

895 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

897 
kcb
->
k¥obe_°©us
) {

898 
KPROBE_HIT_SS
:

899 
KPROBE_REENTER
:

907 
ªgs
->
ù
 = ()
cur
->
addr
;

908 
ªgs
->
Êags
 |
kcb
->
k¥obe_ﬁd_Êags
;

909 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
)

910 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

912 
	`ª£t_cuºít_k¥obe
();

913 
	`¥ìm±_íabÀ_no_ªsched
();

915 
KPROBE_HIT_ACTIVE
:

916 
KPROBE_HIT_SSDONE
:

922 
	`k¥obes_öc_nmis£d_cou¡
(
cur
);

931 i‡(
cur
->
Áu…_h™dÀr
 && cur->
	`Áu…_h™dÀr
(cur, 
ªgs
, 
å≠ƒ
))

938 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

950 
	}
}

955 
__k¥obes
 
	$k¥obe_ex˚±i⁄s_nŸify
(
nŸifõr_block
 *
£lf
,

956 
vÆ
, *
d©a
)

958 
dõ_¨gs
 *
¨gs
 = 
d©a
;

959 
ªt
 = 
NOTIFY_DONE
;

961 i‡(
¨gs
->
ªgs
 && 
	`u£r_mode_vm
(args->regs))

962  
ªt
;

964 
vÆ
) {

965 
DIE_INT3
:

966 i‡(
	`k¥obe_h™dÀr
(
¨gs
->
ªgs
))

967 
ªt
 = 
NOTIFY_STOP
;

969 
DIE_DEBUG
:

970 i‡(
	`po°_k¥obe_h™dÀr
(
¨gs
->
ªgs
))

971 
ªt
 = 
NOTIFY_STOP
;

973 
DIE_GPF
:

979 i‡(!
	`¥ìm±ibÀ
(Ë&& 
	`k¥obe_ru¬ög
() &&

980 
	`k¥obe_Áu…_h™dÀr
(
¨gs
->
ªgs
,árgs->
å≠ƒ
))

981 
ªt
 = 
NOTIFY_STOP
;

986  
ªt
;

987 
	}
}

989 
__k¥obes
 
	$£tjmp_¥e_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

991 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

992 
addr
;

993 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

995 
kcb
->
j¥obe_ßved_ªgs
 = *
ªgs
;

996 
kcb
->
j¥obe_ßved_•
 = 
	`°ack_addr
(
ªgs
);

997 
addr
 = ()(
kcb
->
j¥obe_ßved_•
);

1006 
	`mem˝y
(
kcb
->
j¥obes_°ack
, (
k¥obe_›code_t
 *)
addr
,

1007 
	`MIN_STACK_SIZE
(
addr
));

1008 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

1009 
	`åa˚_h¨dúqs_off
();

1010 
ªgs
->
ù
 = ()(
jp
->
íåy
);

1012 
	}
}

1014 
__k¥obes
 
	$j¥obe_ªtu∫
()

1016 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1018 
asm
 volatile (

1019 #ifde‡
CONFIG_X86_64


1028 (
kcb
->
j¥obe_ßved_•
):"memory");

1029 
	}
}

1031 
__k¥obes
 
	$l⁄gjmp_bªak_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1033 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1034 
u8
 *
addr
 = (u8 *Ë(
ªgs
->
ù
 - 1);

1035 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1037 i‡((
addr
 > (
u8
 *Ë
j¥obe_ªtu∫
) &&

1038 (
addr
 < (
u8
 *Ë
j¥obe_ªtu∫_íd
)) {

1039 i‡(
	`°ack_addr
(
ªgs
Ë!
kcb
->
j¥obe_ßved_•
) {

1040 
±_ªgs
 *
ßved_ªgs
 = &
kcb
->
j¥obe_ßved_ªgs
;

1041 
	`¥ötk
(
KERN_ERR


1043 
	`°ack_addr
(
ªgs
), 
kcb
->
j¥obe_ßved_•
);

1044 
	`¥ötk
(
KERN_ERR
 "SavedÑegi°î†f‹ j¥obê%p\n", 
jp
);

1045 
	`show_ªgi°îs
(
ßved_ªgs
);

1046 
	`¥ötk
(
KERN_ERR
 "CurrentÑegisters\n");

1047 
	`show_ªgi°îs
(
ªgs
);

1048 
	`BUG
();

1050 *
ªgs
 = 
kcb
->
j¥obe_ßved_ªgs
;

1051 
	`mem˝y
((
k¥obe_›code_t
 *)(
kcb
->
j¥obe_ßved_•
),

1052 
kcb
->
j¥obes_°ack
,

1053 
	`MIN_STACK_SIZE
(
kcb
->
j¥obe_ßved_•
));

1054 
	`¥ìm±_íabÀ_no_ªsched
();

1058 
	}
}

1060 
__öô
 
	$¨ch_öô_k¥obes
()

1063 
	}
}

1065 
__k¥obes
 
	$¨ch_åampﬁöe_k¥obe
(
k¥obe
 *
p
)

1068 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<löux/î∫o.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/uac˚ss.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/ldt.h
>

19 
	~<asm/desc.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

21 
	~<asm/sysˇŒs.h
>

23 #ifde‡
CONFIG_SMP


24 
	$Êush_ldt
(*
cuºít_mm
)

26 i‡(
cuºít
->
a˘ive_mm
 =
cuºít_mm
)

27 
	`lﬂd_LDT
(&
cuºít
->
a˘ive_mm
->
c⁄ãxt
);

28 
	}
}

31 
	$Æloc_ldt
(
mm_c⁄ãxt_t
 *
pc
, 
möcou¡
, 
ªlﬂd
)

33 *
ﬁdldt
, *
√wldt
;

34 
ﬁdsize
;

36 i‡(
möcou¡
 <
pc
->
size
)

38 
ﬁdsize
 = 
pc
->
size
;

39 
möcou¡
 = (möcou¡ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

40 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

41 i‡(
möcou¡
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

42 
√wldt
 = 
	`vmÆloc
(
möcou¡
 * 
LDT_ENTRY_SIZE
);

44 
√wldt
 = (*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
);

46 i‡(!
√wldt
)

47  -
ENOMEM
;

49 i‡(
ﬁdsize
)

50 
	`mem˝y
(
√wldt
, 
pc
->
ldt
, 
ﬁdsize
 * 
LDT_ENTRY_SIZE
);

51 
ﬁdldt
 = 
pc
->
ldt
;

52 
	`mem£t
(
√wldt
 + 
ﬁdsize
 * 
LDT_ENTRY_SIZE
, 0,

53 (
möcou¡
 - 
ﬁdsize
Ë* 
LDT_ENTRY_SIZE
);

55 
	`∑øvút_Æloc_ldt
(
√wldt
, 
möcou¡
);

57 #ifde‡
CONFIG_X86_64


59 
	`wmb
();

61 
pc
->
ldt
 = 
√wldt
;

62 
	`wmb
();

63 
pc
->
size
 = 
möcou¡
;

64 
	`wmb
();

66 i‡(
ªlﬂd
) {

67 #ifde‡
CONFIG_SMP


68 
	`¥ìm±_dißbÀ
();

69 
	`lﬂd_LDT
(
pc
);

70 i‡(!
	`˝us_equÆ
(
cuºít
->
mm
->
˝u_vm_mask
,

71 
	`˝umask_of_˝u
(
	`smp_¥o˚ss‹_id
())))

72 
	`smp_ˇŒ_fun˘i⁄
(
Êush_ldt
, 
cuºít
->
mm
, 1);

73 
	`¥ìm±_íabÀ
();

75 
	`lﬂd_LDT
(
pc
);

78 i‡(
ﬁdsize
) {

79 
	`∑øvút_‰ì_ldt
(
ﬁdldt
, 
ﬁdsize
);

80 i‡(
ﬁdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

81 
	`v‰ì
(
ﬁdldt
);

83 
	`put_∑ge
(
	`vút_to_∑ge
(
ﬁdldt
));

86 
	}
}

88 
ölöe
 
	$c›y_ldt
(
mm_c⁄ãxt_t
 *
√w
, mm_c⁄ãxt_à*
ﬁd
)

90 
îr
 = 
	`Æloc_ldt
(
√w
, 
ﬁd
->
size
, 0);

91 
i
;

93 i‡(
îr
 < 0)

94  
îr
;

96 
i
 = 0; i < 
ﬁd
->
size
; i++)

97 
	`wrôe_ldt_íåy
(
√w
->
ldt
, 
i
, 
ﬁd
->ldà+ i * 
LDT_ENTRY_SIZE
);

99 
	}
}

105 
	$öô_√w_c⁄ãxt
(
èsk_°ru˘
 *
tsk
, 
mm_°ru˘
 *
mm
)

107 
mm_°ru˘
 *
ﬁd_mm
;

108 
ªtvÆ
 = 0;

110 
	`muãx_öô
(&
mm
->
c⁄ãxt
.
lock
);

111 
mm
->
c⁄ãxt
.
size
 = 0;

112 
ﬁd_mm
 = 
cuºít
->
mm
;

113 i‡(
ﬁd_mm
 && old_mm->
c⁄ãxt
.
size
 > 0) {

114 
	`muãx_lock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

115 
ªtvÆ
 = 
	`c›y_ldt
(&
mm
->
c⁄ãxt
, &
ﬁd_mm
->context);

116 
	`muãx_u∆ock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

118  
ªtvÆ
;

119 
	}
}

126 
	$de°roy_c⁄ãxt
(
mm_°ru˘
 *
mm
)

128 i‡(
mm
->
c⁄ãxt
.
size
) {

129 #ifde‡
CONFIG_X86_32


131 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

132 
	`˛ór_LDT
();

134 
	`∑øvút_‰ì_ldt
(
mm
->
c⁄ãxt
.
ldt
, mm->c⁄ãxt.
size
);

135 i‡(
mm
->
c⁄ãxt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

136 
	`v‰ì
(
mm
->
c⁄ãxt
.
ldt
);

138 
	`put_∑ge
(
	`vút_to_∑ge
(
mm
->
c⁄ãxt
.
ldt
));

139 
mm
->
c⁄ãxt
.
size
 = 0;

141 
	}
}

143 
	$ªad_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

145 
îr
;

146 
size
;

147 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

149 i‡(!
mm
->
c⁄ãxt
.
size
)

151 i‡(
byãcou¡
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

152 
byãcou¡
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

154 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

155 
size
 = 
mm
->
c⁄ãxt
.sizê* 
LDT_ENTRY_SIZE
;

156 i‡(
size
 > 
byãcou¡
)

157 
size
 = 
byãcou¡
;

159 
îr
 = 0;

160 i‡(
	`c›y_to_u£r
(
±r
, 
mm
->
c⁄ãxt
.
ldt
, 
size
))

161 
îr
 = -
EFAULT
;

162 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

163 i‡(
îr
 < 0)

164 
îr‹_ªtu∫
;

165 i‡(
size
 !
byãcou¡
) {

167 i‡(
	`˛ór_u£r
(
±r
 + 
size
, 
byãcou¡
 - size) != 0) {

168 
îr
 = -
EFAULT
;

169 
îr‹_ªtu∫
;

172  
byãcou¡
;

173 
îr‹_ªtu∫
:

174  
îr
;

175 
	}
}

177 
	$ªad_deÁu…_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

180 #ifde‡
CONFIG_X86_32


181 
size
 = 5 * (
desc_°ru˘
);

183 
size
 = 128;

185 i‡(
byãcou¡
 > 
size
)

186 
byãcou¡
 = 
size
;

187 i‡(
	`˛ór_u£r
(
±r
, 
byãcou¡
))

188  -
EFAULT
;

189  
byãcou¡
;

190 
	}
}

192 
	$wrôe_ldt
(
__u£r
 *
±r
, 
byãcou¡
, 
ﬁdmode
)

194 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

195 
desc_°ru˘
 
ldt
;

196 
îr‹
;

197 
u£r_desc
 
ldt_öfo
;

199 
îr‹
 = -
EINVAL
;

200 i‡(
byãcou¡
 !(
ldt_öfo
))

201 
out
;

202 
îr‹
 = -
EFAULT
;

203 i‡(
	`c›y_‰om_u£r
(&
ldt_öfo
, 
±r
, (ldt_info)))

204 
out
;

206 
îr‹
 = -
EINVAL
;

207 i‡(
ldt_öfo
.
íåy_numbî
 >
LDT_ENTRIES
)

208 
out
;

209 i‡(
ldt_öfo
.
c⁄ã¡s
 == 3) {

210 i‡(
ﬁdmode
)

211 
out
;

212 i‡(
ldt_öfo
.
£g_nŸ_¥e£¡
 == 0)

213 
out
;

216 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

217 i‡(
ldt_öfo
.
íåy_numbî
 >
mm
->
c⁄ãxt
.
size
) {

218 
îr‹
 = 
	`Æloc_ldt
(&
cuºít
->
mm
->
c⁄ãxt
,

219 
ldt_öfo
.
íåy_numbî
 + 1, 1);

220 i‡(
îr‹
 < 0)

221 
out_u∆ock
;

225 i‡(
ldt_öfo
.
ba£_addr
 =0 &&Üdt_öfo.
limô
 == 0) {

226 i‡(
ﬁdmode
 || 
	`LDT_em±y
(&
ldt_öfo
)) {

227 
	`mem£t
(&
ldt
, 0, (ldt));

228 
ö°Æl
;

232 
	`fûl_ldt
(&
ldt
, &
ldt_öfo
);

233 i‡(
ﬁdmode
)

234 
ldt
.
avl
 = 0;

237 
ö°Æl
:

238 
	`wrôe_ldt_íåy
(
mm
->
c⁄ãxt
.
ldt
, 
ldt_öfo
.
íåy_numbî
, &ldt);

239 
îr‹
 = 0;

241 
out_u∆ock
:

242 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

243 
out
:

244  
îr‹
;

245 
	}
}

247 
asmlökage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

248 
byãcou¡
)

250 
ªt
 = -
ENOSYS
;

252 
func
) {

254 
ªt
 = 
	`ªad_ldt
(
±r
, 
byãcou¡
);

257 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 1);

260 
ªt
 = 
	`ªad_deÁu…_ldt
(
±r
, 
byãcou¡
);

263 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 0);

266  
ªt
;

267 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<löux/mm.h
>

10 
	~<löux/kexec.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/ªboŸ.h
>

13 
	~<löux/numa.h
>

14 
	~<löux/·ø˚.h
>

15 
	~<löux/io.h
>

16 
	~<löux/su•íd.h
>

18 
	~<asm/pgèbÀ.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

22 
	$öô_⁄e_Àvñ2_∑ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

23 
addr
)

25 
pud_t
 *
pud
;

26 
pmd_t
 *
pmd
;

27 
∑ge
 *page;

28 
ªsu…
 = -
ENOMEM
;

30 
addr
 &
PMD_MASK
;

31 
pgd
 +
	`pgd_ödex
(
addr
);

32 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

33 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

34 i‡(!
∑ge
)

35 
out
;

36 
pud
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

37 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

38 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

40 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

41 i‡(!
	`pud_¥e£¡
(*
pud
)) {

42 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

43 i‡(!
∑ge
)

44 
out
;

45 
pmd
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

46 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

47 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

49 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

50 i‡(!
	`pmd_¥e£¡
(*
pmd
))

51 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

52 
ªsu…
 = 0;

53 
out
:

54  
ªsu…
;

55 
	}
}

57 
	$öô_Àvñ2_∑ge
(
pmd_t
 *
Àvñ2p
, 
addr
)

59 
íd_addr
;

61 
addr
 &
PAGE_MASK
;

62 
íd_addr
 = 
addr
 + 
PUD_SIZE
;

63 
addr
 < 
íd_addr
) {

64 
	`£t_pmd
(
Àvñ2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

65 
addr
 +
PMD_SIZE
;

67 
	}
}

69 
	$öô_Àvñ3_∑ge
(
kimage
 *
image
, 
pud_t
 *
Àvñ3p
,

70 
addr
, 
œ°_addr
)

72 
íd_addr
;

73 
ªsu…
;

75 
ªsu…
 = 0;

76 
addr
 &
PAGE_MASK
;

77 
íd_addr
 = 
addr
 + 
PGDIR_SIZE
;

78 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

79 
∑ge
 *page;

80 
pmd_t
 *
Àvñ2p
;

82 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

83 i‡(!
∑ge
) {

84 
ªsu…
 = -
ENOMEM
;

85 
out
;

87 
Àvñ2p
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

88 
	`öô_Àvñ2_∑ge
(
Àvñ2p
, 
addr
);

89 
	`£t_pud
(
Àvñ3p
++, 
	`__pud
(
	`__∑
(
Àvñ2p
Ë| 
_KERNPG_TABLE
));

90 
addr
 +
PUD_SIZE
;

93 
addr
 < 
íd_addr
) {

94 
	`pud_˛ór
(
Àvñ3p
++);

95 
addr
 +
PUD_SIZE
;

97 
out
:

98  
ªsu…
;

99 
	}
}

102 
	$öô_Àvñ4_∑ge
(
kimage
 *
image
, 
pgd_t
 *
Àvñ4p
,

103 
addr
, 
œ°_addr
)

105 
íd_addr
;

106 
ªsu…
;

108 
ªsu…
 = 0;

109 
addr
 &
PAGE_MASK
;

110 
íd_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

111 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

112 
∑ge
 *page;

113 
pud_t
 *
Àvñ3p
;

115 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

116 i‡(!
∑ge
) {

117 
ªsu…
 = -
ENOMEM
;

118 
out
;

120 
Àvñ3p
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

121 
ªsu…
 = 
	`öô_Àvñ3_∑ge
(
image
, 
Àvñ3p
, 
addr
, 
œ°_addr
);

122 i‡(
ªsu…
)

123 
out
;

124 
	`£t_pgd
(
Àvñ4p
++, 
	`__pgd
(
	`__∑
(
Àvñ3p
Ë| 
_KERNPG_TABLE
));

125 
addr
 +
PGDIR_SIZE
;

128 
addr
 < 
íd_addr
) {

129 
	`pgd_˛ór
(
Àvñ4p
++);

130 
addr
 +
PGDIR_SIZE
;

132 
out
:

133  
ªsu…
;

134 
	}
}

136 
	$‰ì_å™sôi⁄_pgèbÀ
(
kimage
 *
image
)

138 
	`‰ì_∑ge
(()
image
->
¨ch
.
pud
);

139 
	`‰ì_∑ge
(()
image
->
¨ch
.
pmd
);

140 
	`‰ì_∑ge
(()
image
->
¨ch
.
±e
);

141 
	}
}

143 
	$öô_å™sôi⁄_pgèbÀ
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

145 
pud_t
 *
pud
;

146 
pmd_t
 *
pmd
;

147 
±e_t
 *
±e
;

148 
vaddr
, 
∑ddr
;

149 
ªsu…
 = -
ENOMEM
;

151 
vaddr
 = ()
ªloˇã_kî√l
;

152 
∑ddr
 = 
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
)+
PAGE_SIZE
);

153 
pgd
 +
	`pgd_ödex
(
vaddr
);

154 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

155 
pud
 = (
pud_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

156 i‡(!
pud
)

157 
îr
;

158 
image
->
¨ch
.
pud
 =Öud;

159 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

161 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

162 i‡(!
	`pud_¥e£¡
(*
pud
)) {

163 
pmd
 = (
pmd_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

164 i‡(!
pmd
)

165 
îr
;

166 
image
->
¨ch
.
pmd
 =Ömd;

167 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

169 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

170 i‡(!
	`pmd_¥e£¡
(*
pmd
)) {

171 
±e
 = (
±e_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

172 i‡(!
±e
)

173 
îr
;

174 
image
->
¨ch
.
±e
 =Öte;

175 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__∑
(
±e
Ë| 
_KERNPG_TABLE
));

177 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

178 
	`£t_±e
(
±e
, 
	`p‚_±e
(
∑ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

180 
îr
:

181 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

182  
ªsu…
;

183 
	}
}

186 
	$öô_pgèbÀ
(
kimage
 *
image
, 
°¨t_pgèbÀ
)

188 
pgd_t
 *
Àvñ4p
;

189 
ªsu…
;

190 
Àvñ4p
 = (
pgd_t
 *)
	`__va
(
°¨t_pgèbÀ
);

191 
ªsu…
 = 
	`öô_Àvñ4_∑ge
(
image
, 
Àvñ4p
, 0, 
max_p‚
 << 
PAGE_SHIFT
);

192 i‡(
ªsu…
)

193  
ªsu…
;

198 
ªsu…
 = 
	`öô_⁄e_Àvñ2_∑ge
(
image
, 
Àvñ4p
, image->
°¨t
);

199 i‡(
ªsu…
)

200  
ªsu…
;

201  
	`öô_å™sôi⁄_pgèbÀ
(
image
, 
Àvñ4p
);

202 
	}
}

204 
	$£t_idt
(*
√widt
, 
u16
 
limô
)

206 
desc_±r
 
curidt
;

209 
curidt
.
size
 = 
limô
;

210 
curidt
.
addªss
 = ()
√widt
;

212 
__asm__
 
	`__vﬁ©ûe__
 (

214 : : "m" (
curidt
)

216 
	}
};

219 
	$£t_gdt
(*
√wgdt
, 
u16
 
limô
)

221 
desc_±r
 
curgdt
;

224 
curgdt
.
size
 = 
limô
;

225 
curgdt
.
addªss
 = ()
√wgdt
;

227 
__asm__
 
	`__vﬁ©ûe__
 (

229 : : "m" (
curgdt
)

231 
	}
};

233 
	$lﬂd_£gmíts
()

235 
__asm__
 
	`__vﬁ©ûe__
 (

241 : : "a" (
__KERNEL_DS
) : "memory"

243 
	}
}

245 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

247 
°¨t_pgèbÀ
;

248 
ªsu…
;

251 
°¨t_pgèbÀ
 = 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

254 
ªsu…
 = 
	`öô_pgèbÀ
(
image
, 
°¨t_pgèbÀ
);

255 i‡(
ªsu…
)

256  
ªsu…
;

259 
	}
}

261 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

263 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

264 
	}
}

270 
	$machöe_kexec
(
kimage
 *
image
)

272 
∑ge_li°
[
PAGES_NR
];

273 *
c⁄åﬁ_∑ge
;

274 
ßve_·ø˚_íabÀd
;

276 #ifde‡
CONFIG_KEXEC_JUMP


277 i‡(
image
->
¥e£rve_c⁄ãxt
)

278 
	`ßve_¥o˚ss‹_°©e
();

281 
ßve_·ø˚_íabÀd
 = 
	`__·ø˚_íabÀd_ßve
();

284 
	`loˇl_úq_dißbÀ
();

286 i‡(
image
->
¥e£rve_c⁄ãxt
) {

287 #ifde‡
CONFIG_X86_IO_APIC


295 
	`dißbÀ_IO_APIC
();

299 
c⁄åﬁ_∑ge
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
Ë+ 
PAGE_SIZE
;

300 
	`mem˝y
(
c⁄åﬁ_∑ge
, 
ªloˇã_kî√l
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

302 
∑ge_li°
[
PA_CONTROL_PAGE
] = 
	`vút_to_phys
(
c⁄åﬁ_∑ge
);

303 
∑ge_li°
[
VA_CONTROL_PAGE
] = ()
c⁄åﬁ_∑ge
;

304 
∑ge_li°
[
PA_TABLE_PAGE
] =

305 ()
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
));

307 i‡(
image
->
ty≥
 =
KEXEC_TYPE_DEFAULT
)

308 
∑ge_li°
[
PA_SWAP_PAGE
] = (
	`∑ge_to_p‚
(
image
->
sw≠_∑ge
)

309 << 
PAGE_SHIFT
);

321 
	`lﬂd_£gmíts
();

326 
	`£t_gdt
(
	`phys_to_vút
(0), 0);

327 
	`£t_idt
(
	`phys_to_vút
(0), 0);

330 
image
->
°¨t
 = 
	`ªloˇã_kî√l
(()image->
hód
,

331 ()
∑ge_li°
,

332 
image
->
°¨t
,

333 
image
->
¥e£rve_c⁄ãxt
);

335 #ifde‡
CONFIG_KEXEC_JUMP


336 i‡(
image
->
¥e£rve_c⁄ãxt
)

337 
	`ª°‹e_¥o˚ss‹_°©e
();

340 
	`__·ø˚_íabÀd_ª°‹e
(
ßve_·ø˚_íabÀd
);

341 
	}
}

343 
	$¨ch_¸ash_ßve_vmc‹eöfo
()

345 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

346 
	`VMCOREINFO_SYMBOL
(
öô_Àvñ4_pgt
);

348 #ifde‡
CONFIG_NUMA


349 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

350 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

352 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

16 
	~<löux/fúmw¨e.h
>

17 
	~<löux/pci_ids.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/vmÆloc.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/pci.h
>

24 
	~<asm/mi¸ocode.h
>

25 
	~<asm/¥o˚ss‹.h
>

26 
	~<asm/m§.h
>

28 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

29 
MODULE_AUTHOR
("Peter Oruba");

30 
MODULE_LICENSE
("GPL v2");

32 
	#UCODE_MAGIC
 0x00414d44

	)

33 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

34 
	#UCODE_UCODE_TYPE
 0x00000001

	)

36 
	sequiv_˝u_íåy
 {

37 
u32
 
	mö°ÆÀd_˝u
;

38 
u32
 
	mfixed_îøè_mask
;

39 
u32
 
	mfixed_îøè_com∑ª
;

40 
u16
 
	mequiv_˝u
;

41 
u16
 
	mªs
;

42 } 
__©åibuã__
((
∑cked
));

44 
	smi¸ocode_hódî_amd
 {

45 
u32
 
	md©a_code
;

46 
u32
 
	m∑tch_id
;

47 
u16
 
	mmc_∑tch_d©a_id
;

48 
u8
 
	mmc_∑tch_d©a_Àn
;

49 
u8
 
	möô_Êag
;

50 
u32
 
	mmc_∑tch_d©a_checksum
;

51 
u32
 
	mnb_dev_id
;

52 
u32
 
	msb_dev_id
;

53 
u16
 
	m¥o˚ss‹_ªv_id
;

54 
u8
 
	mnb_ªv_id
;

55 
u8
 
	msb_ªv_id
;

56 
u8
 
	mbios_≠i_ªv
;

57 
u8
 
	mª£rved1
[3];

58 
u32
 
	mm©ch_ªg
[8];

59 } 
__©åibuã__
((
∑cked
));

61 
	smi¸ocode_amd
 {

62 
mi¸ocode_hódî_amd
 
	mhdr
;

63 
	mmpb
[0];

66 
	#UCODE_MAX_SIZE
 2048

	)

67 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

68 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

70 
equiv_˝u_íåy
 *
	gequiv_˝u_èbÀ
;

72 
	$cﬁÀ˘_˝u_öfo_amd
(
˝u
, 
˝u_sig«tuª
 *
csig
)

74 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

75 
u32
 
dummy
;

77 
	`mem£t
(
csig
, 0, (*csig));

78 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

79 
	`¥ötk
(
KERN_WARNING
 "microcode: CPU%d: AMD CPU family 0x%xÇot "

80 "suµ‹ãd\n", 
˝u
, 
c
->
x86
);

83 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
ªv
, 
dummy
);

84 
	`¥ötk
(
KERN_INFO
 "mi¸ocode: CPU%d:Ö©ch_Àvñ=0x%x\n", 
˝u
, 
csig
->
ªv
);

86 
	}
}

88 
	$gë_m©chög_mi¸ocode
(
˝u
, *
mc
, 
ªv
)

90 
mi¸ocode_hódî_amd
 *
mc_hódî
 = 
mc
;

91 
cuºít_˝u_id
;

92 
u16
 
equiv_˝u_id
 = 0;

93 
i
 = 0;

95 
	`BUG_ON
(
equiv_˝u_èbÀ
 =
NULL
);

96 
cuºít_˝u_id
 = 
	`˝uid_óx
(0x00000001);

98 
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
 != 0) {

99 i‡(
cuºít_˝u_id
 =
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
) {

100 
equiv_˝u_id
 = 
equiv_˝u_èbÀ
[
i
].
equiv_˝u
;

103 
i
++;

106 i‡(!
equiv_˝u_id
) {

107 
	`¥ötk
(
KERN_WARNING
 "microcode: CPU%d: cpuÑevision "

108 "nŸÜi°ed i¿equivÆíà˝uÅabÀ\n", 
˝u
);

112 i‡(
mc_hódî
->
¥o˚ss‹_ªv_id
 !
equiv_˝u_id
) {

113 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d:Öatch mismatch "

115 
˝u
, 
mc_hódî
->
¥o˚ss‹_ªv_id
, 
equiv_˝u_id
);

120 i‡(
mc_hódî
->
nb_dev_id
 || mc_hódî->
sb_dev_id
) {

121 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d:Üoading of chipset "

122 "•ecifi¯codênŸ yë suµ‹ãd\n", 
˝u
);

126 i‡(
mc_hódî
->
∑tch_id
 <
ªv
)

130 
	}
}

132 
	$≠∂y_mi¸ocode_amd
(
˝u
)

134 
u32
 
ªv
, 
dummy
;

135 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

136 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u_num
;

137 
mi¸ocode_amd
 *
mc_amd
 = 
uci
->
mc
;

140 
	`BUG_ON
(
˝u_num
 !
˝u
);

142 i‡(
mc_amd
 =
NULL
)

145 
	`wrm§l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

147 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
ªv
, 
dummy
);

150 i‡(
ªv
 !
mc_amd
->
hdr
.
∑tch_id
) {

151 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d: update failed "

152 "(f‹Ö©ch_Àvñ=0x%x)\n", 
˝u
, 
mc_amd
->
hdr
.
∑tch_id
);

156 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d: updated (newÖatch_level=0x%x)\n",

157 
˝u
, 
ªv
);

159 
uci
->
˝u_sig
.
ªv
 =Ñev;

162 
	}
}

164 
	$gë_ucode_d©a
(*
to
, c⁄° 
u8
 *
‰om
, 
size_t
 
n
)

166 
	`mem˝y
(
to
, 
‰om
, 
n
);

168 
	}
}

171 
	$gë_√xt_ucode
(c⁄° 
u8
 *
buf
, 
size
, *
mc_size
)

173 
tŸÆ_size
;

174 
u8
 
£˘i⁄_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

175 *
mc
;

177 i‡(
	`gë_ucode_d©a
(
£˘i⁄_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

178  
NULL
;

180 i‡(
£˘i⁄_hdr
[0] !
UCODE_UCODE_TYPE
) {

181 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: invalidÅype field in "

183  
NULL
;

186 
tŸÆ_size
 = (Ë(
£˘i⁄_hdr
[4] + (section_hdr[5] << 8));

188 
	`¥ötk
(
KERN_DEBUG
 "microcode: size %u,Åotal_size %u\n",

189 
size
, 
tŸÆ_size
);

191 i‡(
tŸÆ_size
 > 
size
 ||ÅŸÆ_sizê> 
UCODE_MAX_SIZE
) {

192 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: size mismatch\n");

193  
NULL
;

196 
mc
 = 
	`vmÆloc
(
UCODE_MAX_SIZE
);

197 i‡(
mc
) {

198 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

199 i‡(
	`gë_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

200 
tŸÆ_size
)) {

201 
	`v‰ì
(
mc
);

202 
mc
 = 
NULL
;

204 *
mc_size
 = 
tŸÆ_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

206  
mc
;

207 
	}
}

209 
	$ö°Æl_equiv_˝u_èbÀ
(c⁄° 
u8
 *
buf
)

211 
u8
 *
c⁄èöî_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

212 *
buf_pos
 = (*)
c⁄èöî_hdr
;

213 
size
;

215 i‡(
	`gë_ucode_d©a
(&
c⁄èöî_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

218 
size
 = 
buf_pos
[2];

220 i‡(
buf_pos
[1] !
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

221 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: invalidÅype field in "

226 
equiv_˝u_èbÀ
 = (
equiv_˝u_íåy
 *Ë
	`vmÆloc
(
size
);

227 i‡(!
equiv_˝u_èbÀ
) {

228 
	`¥ötk
(
KERN_ERR
 "microcode: failedÅoállocate "

233 
buf
 +
UCODE_CONTAINER_HEADER_SIZE
;

234 i‡(
	`gë_ucode_d©a
(
equiv_˝u_èbÀ
, 
buf
, 
size
)) {

235 
	`v‰ì
(
equiv_˝u_èbÀ
);

239  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

240 
	}
}

242 
	$‰ì_equiv_˝u_èbÀ
()

244 
	`v‰ì
(
equiv_˝u_èbÀ
);

245 
equiv_˝u_èbÀ
 = 
NULL
;

246 
	}
}

248 
ucode_°©e


249 
	$gíîic_lﬂd_mi¸ocode
(
˝u
, c⁄° 
u8
 *
d©a
, 
size_t
 
size
)

251 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

252 c⁄° 
u8
 *
ucode_±r
 = 
d©a
;

253 *
√w_mc
 = 
NULL
;

254 *
mc
;

255 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

256 
À·ovî
;

257 
off£t
;

258 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

260 
off£t
 = 
	`ö°Æl_equiv_˝u_èbÀ
(
ucode_±r
);

261 i‡(!
off£t
) {

262 
	`¥ötk
(
KERN_ERR
 "microcode: failedÅo create "

264  
UCODE_ERROR
;

267 
ucode_±r
 +
off£t
;

268 
À·ovî
 = 
size
 - 
off£t
;

270 
À·ovî
) {

271 
	`unöôülized_v¨
(
mc_size
);

272 
mi¸ocode_hódî_amd
 *
mc_hódî
;

274 
mc
 = 
	`gë_√xt_ucode
(
ucode_±r
, 
À·ovî
, &
mc_size
);

275 i‡(!
mc
)

278 
mc_hódî
 = (
mi¸ocode_hódî_amd
 *)
mc
;

279 i‡(
	`gë_m©chög_mi¸ocode
(
˝u
, 
mc
, 
√w_ªv
)) {

280 
	`v‰ì
(
√w_mc
);

281 
√w_ªv
 = 
mc_hódî
->
∑tch_id
;

282 
√w_mc
 = 
mc
;

284 
	`v‰ì
(
mc
);

286 
ucode_±r
 +
mc_size
;

287 
À·ovî
 -
mc_size
;

290 i‡(
√w_mc
) {

291 i‡(!
À·ovî
) {

292 
	`v‰ì
(
uci
->
mc
);

293 
uci
->
mc
 = 
√w_mc
;

294 
	`¥_debug
("microcode: CPU%d foundá matching microcode "

296 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

298 
	`v‰ì
(
√w_mc
);

299 
°©e
 = 
UCODE_ERROR
;

302 
°©e
 = 
UCODE_NFOUND
;

304 
	`‰ì_equiv_˝u_èbÀ
();

306  
°©e
;

307 
	}
}

309 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

311 c⁄° *
fw_«me
 = "amd-ucode/microcode_amd.bin";

312 c⁄° 
fúmw¨e
 *firmware;

313 
ucode_°©e
 
ªt
;

315 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
fw_«me
, 
devi˚
)) {

316 
	`¥ötk
(
KERN_ERR
 "mi¸ocode: faûedÅÿlﬂd fûê%s\n", 
fw_«me
);

317  
UCODE_NFOUND
;

320 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, 
fúmw¨e
->
d©a
, fúmw¨e->
size
);

322 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

324  
ªt
;

325 
	}
}

327 
ucode_°©e


328 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

330 
	`¥ötk
(
KERN_INFO
 "microcode: AMD microcode update via "

332  
UCODE_ERROR
;

333 
	}
}

335 
	$mi¸ocode_föi_˝u_amd
(
˝u
)

337 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

339 
	`v‰ì
(
uci
->
mc
);

340 
uci
->
mc
 = 
NULL
;

341 
	}
}

343 
mi¸ocode_›s
 
	gmi¸ocode_amd_›s
 = {

344 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

345 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

346 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo_amd
,

347 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode_amd
,

348 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u_amd
,

351 
mi¸ocode_›s
 * 
__öô
 
	$öô_amd_mi¸ocode
()

353  &
mi¸ocode_amd_›s
;

354 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

73 
	~<löux/∂©f‹m_devi˚.h
>

74 
	~<löux/miscdevi˚.h
>

75 
	~<löux/ˇ∑bûôy.h
>

76 
	~<löux/smp_lock.h
>

77 
	~<löux/kî√l.h
>

78 
	~<löux/moduÀ.h
>

79 
	~<löux/muãx.h
>

80 
	~<löux/˝u.h
>

81 
	~<löux/fs.h
>

82 
	~<löux/mm.h
>

84 
	~<asm/mi¸ocode.h
>

85 
	~<asm/¥o˚ss‹.h
>

87 
MODULE_DESCRIPTION
("Microcode Update Driver");

88 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

89 
MODULE_LICENSE
("GPL");

91 
	#MICROCODE_VERSION
 "2.00"

	)

93 
mi¸ocode_›s
 *
	gmi¸ocode_›s
;

107 
DEFINE_MUTEX
(
mi¸ocode_muãx
);

109 
ucode_˝u_öfo
 
	gucode_˝u_öfo
[
NR_CPUS
];

110 
EXPORT_SYMBOL_GPL
(
ucode_˝u_öfo
);

116 
	s˝u_öfo_˘x
 {

117 
˝u_sig«tuª
 *
	m˝u_sig
;

118 
	mîr
;

121 
	$cﬁÀ˘_˝u_öfo_loˇl
(*
¨g
)

123 
˝u_öfo_˘x
 *
˘x
 = 
¨g
;

125 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`cﬁÀ˘_˝u_öfo
(
	`smp_¥o˚ss‹_id
(),

126 
˘x
->
˝u_sig
);

127 
	}
}

129 
	$cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, 
˝u_sig«tuª
 *
˝u_sig
)

131 
˝u_öfo_˘x
 
˘x
 = { .
˝u_sig
 = cpu_sig, .
îr
 = 0 };

132 
ªt
;

134 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
cﬁÀ˘_˝u_öfo_loˇl
, &
˘x
, 1);

135 i‡(!
ªt
)

136 
ªt
 = 
˘x
.
îr
;

138  
ªt
;

139 
	}
}

141 
	$cﬁÀ˘_˝u_öfo
(
˝u
)

143 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

144 
ªt
;

146 
	`mem£t
(
uci
, 0, (*uci));

148 
ªt
 = 
	`cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, &
uci
->
˝u_sig
);

149 i‡(!
ªt
)

150 
uci
->
vÆid
 = 1;

152  
ªt
;

153 
	}
}

155 
	s≠∂y_mi¸ocode_˘x
 {

156 
	mîr
;

159 
	$≠∂y_mi¸ocode_loˇl
(*
¨g
)

161 
≠∂y_mi¸ocode_˘x
 *
˘x
 = 
¨g
;

163 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
	`smp_¥o˚ss‹_id
());

164 
	}
}

166 
	$≠∂y_mi¸ocode_⁄_èrgë
(
˝u
)

168 
≠∂y_mi¸ocode_˘x
 
˘x
 = { .
îr
 = 0 };

169 
ªt
;

171 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
≠∂y_mi¸ocode_loˇl
, &
˘x
, 1);

172 i‡(!
ªt
)

173 
ªt
 = 
˘x
.
îr
;

175  
ªt
;

176 
	}
}

178 #ifde‡
CONFIG_MICROCODE_OLD_INTERFACE


179 
	$do_mi¸ocode_upd©e
(c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

181 
îr‹
 = 0;

182 
˝u
;

184 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

185 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

186 
ucode_°©e
 
u°©e
;

188 i‡(!
uci
->
vÆid
)

191 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_u£r
(
˝u
, 
buf
, 
size
);

192 i‡(
u°©e
 =
UCODE_ERROR
) {

193 
îr‹
 = -1;

195 } i‡(
u°©e
 =
UCODE_OK
)

196 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

199  
îr‹
;

200 
	}
}

202 
	$mi¸ocode_›í
(
öode
 *
unu£d1
, 
fûe
 *
unu£d2
)

204 
	`cy˛e_kî√l_lock
();

205  
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
Ë? 0 : -
EPERM
;

206 
	}
}

208 
ssize_t
 
	$mi¸ocode_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

209 
size_t
 
Àn
, 
loff_t
 *
µos
)

211 
ssize_t
 
ªt
 = -
EINVAL
;

213 i‡((
Àn
 >> 
PAGE_SHIFT
Ë> 
num_phy•ages
) {

214 
	`¥_îr
("mi¸ocode:Åoÿmuch d©®(max %ldÖages)\n", 
num_phy•ages
);

215  
ªt
;

218 
	`gë_⁄löe_˝us
();

219 
	`muãx_lock
(&
mi¸ocode_muãx
);

221 i‡(
	`do_mi¸ocode_upd©e
(
buf
, 
Àn
) == 0)

222 
ªt
 = (
ssize_t
)
Àn
;

224 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

225 
	`put_⁄löe_˝us
();

227  
ªt
;

228 
	}
}

230 c⁄° 
fûe_›î©i⁄s
 
	gmi¸ocode_f›s
 = {

231 .
ow√r
 = 
THIS_MODULE
,

232 .
	gwrôe
 = 
mi¸ocode_wrôe
,

233 .
	g›í
 = 
mi¸ocode_›í
,

236 
miscdevi˚
 
	gmi¸ocode_dev
 = {

237 .
mö‹
 = 
MICROCODE_MINOR
,

238 .
	g«me
 = "microcode",

239 .
	gdevnode
 = "cpu/microcode",

240 .
	gf›s
 = &
mi¸ocode_f›s
,

243 
__öô
 
	$mi¸ocode_dev_öô
()

245 
îr‹
;

247 
îr‹
 = 
	`misc_ªgi°î
(&
mi¸ocode_dev
);

248 i‡(
îr‹
) {

249 
	`¥_îr
("mi¸ocode: c™'àmisc_ªgi°î o¿mö‹=%d\n", 
MICROCODE_MINOR
);

250  
îr‹
;

254 
	}
}

256 
	$mi¸ocode_dev_exô
()

258 
	`misc_dîegi°î
(&
mi¸ocode_dev
);

259 
	}
}

261 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

263 
	#mi¸ocode_dev_öô
(Ë0

	)

264 
	#mi¸ocode_dev_exô
(Ëdÿ{ } 0)

	)

268 
∂©f‹m_devi˚
 *
	gmi¸ocode_pdev
;

270 
	$ªlﬂd_f‹_˝u
(
˝u
)

272 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

273 
îr
 = 0;

275 
	`muãx_lock
(&
mi¸ocode_muãx
);

276 i‡(
uci
->
vÆid
) {

277 
ucode_°©e
 
u°©e
;

279 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

280 i‡(
u°©e
 =
UCODE_OK
)

281 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

283 i‡(
u°©e
 =
UCODE_ERROR
)

284 
îr
 = -
EINVAL
;

286 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

288  
îr
;

289 
	}
}

291 
ssize_t
 
	$ªlﬂd_°‹e
(
sys_devi˚
 *
dev
,

292 
sysdev_©åibuã
 *
©å
,

293 c⁄° *
buf
, 
size_t
 
size
)

295 
vÆ
;

296 
˝u
 = 
dev
->
id
;

297 
ªt
 = 0;

298 *
íd
;

300 
vÆ
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

301 i‡(
íd
 =
buf
)

302  -
EINVAL
;

304 i‡(
vÆ
 == 1) {

305 
	`gë_⁄löe_˝us
();

306 i‡(
	`˝u_⁄löe
(
˝u
))

307 
ªt
 = 
	`ªlﬂd_f‹_˝u
(
˝u
);

308 
	`put_⁄löe_˝us
();

311 i‡(!
ªt
)

312 
ªt
 = 
size
;

314  
ªt
;

315 
	}
}

317 
ssize_t
 
	$vîsi⁄_show
(
sys_devi˚
 *
dev
,

318 
sysdev_©åibuã
 *
©å
, *
buf
)

320 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

322  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
ªv
);

323 
	}
}

325 
ssize_t
 
	$pf_show
(
sys_devi˚
 *
dev
,

326 
sysdev_©åibuã
 *
©å
, *
buf
)

328 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

330  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
pf
);

331 
	}
}

333 
SYSDEV_ATTR
(
ªlﬂd
, 0200, 
NULL
, 
ªlﬂd_°‹e
);

334 
SYSDEV_ATTR
(
vîsi⁄
, 0400, 
vîsi⁄_show
, 
NULL
);

335 
SYSDEV_ATTR
(
¥o˚ss‹_Êags
, 0400, 
pf_show
, 
NULL
);

337 
©åibuã
 *
	gmc_deÁu…_©ås
[] = {

338 &
©å_ªlﬂd
.
©å
,

339 &
©å_vîsi⁄
.
©å
,

340 &
©å_¥o˚ss‹_Êags
.
©å
,

341 
NULL


344 
©åibuã_group
 
	gmc_©å_group
 = {

345 .
©ås
 = 
mc_deÁu…_©ås
,

346 .
	g«me
 = "microcode",

349 
	$mi¸ocode_föi_˝u
(
˝u
)

351 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

353 
mi¸ocode_›s
->
	`mi¸ocode_föi_˝u
(
˝u
);

354 
uci
->
vÆid
 = 0;

355 
	}
}

357 
ucode_°©e
 
	$mi¸ocode_ªsume_˝u
(
˝u
)

359 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

361 i‡(!
uci
->
mc
)

362  
UCODE_NFOUND
;

364 
	`¥_debug
("mi¸ocode: CPU%d upd©ed up⁄Ñesume\n", 
˝u
);

365 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

367  
UCODE_OK
;

368 
	}
}

370 
ucode_°©e
 
	$mi¸ocode_öô_˝u
(
˝u
)

372 
ucode_°©e
 
u°©e
;

374 i‡(
	`cﬁÀ˘_˝u_öfo
(
˝u
))

375  
UCODE_ERROR
;

378 i‡(
sy°em_°©e
 !
SYSTEM_RUNNING
)

379  
UCODE_NFOUND
;

381 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

383 i‡(
u°©e
 =
UCODE_OK
) {

384 
	`¥_debug
("mi¸ocode: CPU%d upd©ed up⁄ inô\n", 
˝u
);

385 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

388  
u°©e
;

389 
	}
}

391 
ucode_°©e
 
	$mi¸ocode_upd©e_˝u
(
˝u
)

393 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

394 
ucode_°©e
 
u°©e
;

396 i‡(
uci
->
vÆid
)

397 
u°©e
 = 
	`mi¸ocode_ªsume_˝u
(
˝u
);

399 
u°©e
 = 
	`mi¸ocode_öô_˝u
(
˝u
);

401  
u°©e
;

402 
	}
}

404 
	$mc_sysdev_add
(
sys_devi˚
 *
sys_dev
)

406 
îr
, 
˝u
 = 
sys_dev
->
id
;

408 i‡(!
	`˝u_⁄löe
(
˝u
))

411 
	`¥_debug
("mi¸ocode: CPU%dádded\n", 
˝u
);

413 
îr
 = 
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

414 i‡(
îr
)

415  
îr
;

417 i‡(
	`mi¸ocode_öô_˝u
(
˝u
Ë=
UCODE_ERROR
)

418 
îr
 = -
EINVAL
;

420  
îr
;

421 
	}
}

423 
	$mc_sysdev_ªmove
(
sys_devi˚
 *
sys_dev
)

425 
˝u
 = 
sys_dev
->
id
;

427 i‡(!
	`˝u_⁄löe
(
˝u
))

430 
	`¥_debug
("mi¸ocode: CPU%dÑemoved\n", 
˝u
);

431 
	`mi¸ocode_föi_˝u
(
˝u
);

432 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

434 
	}
}

436 
	$mc_sysdev_ªsume
(
sys_devi˚
 *
dev
)

438 
˝u
 = 
dev
->
id
;

439 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

441 i‡(!
	`˝u_⁄löe
(
˝u
))

451 
	`WARN_ON
(
˝u
 != 0);

453 i‡(
uci
->
vÆid
 && uci->
mc
)

454 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
˝u
);

457 
	}
}

459 
sysdev_drivî
 
	gmc_sysdev_drivî
 = {

460 .
add
 = 
mc_sysdev_add
,

461 .
	gªmove
 = 
mc_sysdev_ªmove
,

462 .
	gªsume
 = 
mc_sysdev_ªsume
,

465 
__˝uöô
 

466 
	$mc_˝u_ˇŒback
(
nŸifõr_block
 *
nb
, 
a˘i⁄
, *
h˝u
)

468 
˝u
 = ()
h˝u
;

469 
sys_devi˚
 *
sys_dev
;

471 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

472 
a˘i⁄
) {

473 
CPU_ONLINE
:

474 
CPU_ONLINE_FROZEN
:

475 
	`mi¸ocode_upd©e_˝u
(
˝u
);

476 
CPU_DOWN_FAILED
:

477 
CPU_DOWN_FAILED_FROZEN
:

478 
	`¥_debug
("mi¸ocode: CPU%dádded\n", 
˝u
);

479 i‡(
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
))

480 
	`¥_îr
("mi¸ocode: FaûedÅÿ¸óã grou∞f‹ CPU%d\n", 
˝u
);

482 
CPU_DOWN_PREPARE
:

483 
CPU_DOWN_PREPARE_FROZEN
:

485 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

486 
	`¥_debug
("mi¸ocode: CPU%dÑemoved\n", 
˝u
);

488 
CPU_DEAD
:

489 
CPU_UP_CANCELED_FROZEN
:

491 
	`mi¸ocode_föi_˝u
(
˝u
);

494  
NOTIFY_OK
;

495 
	}
}

497 
nŸifõr_block
 
__ªfd©a
 
	gmc_˝u_nŸifõr
 = {

498 .
nŸifõr_ˇŒ
 = 
mc_˝u_ˇŒback
,

501 
__öô
 
	$mi¸ocode_öô
()

503 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(0);

504 
îr‹
;

506 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

507 
mi¸ocode_›s
 = 
	`öô_öãl_mi¸ocode
();

508 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)

509 
mi¸ocode_›s
 = 
	`öô_amd_mi¸ocode
();

511 i‡(!
mi¸ocode_›s
) {

512 
	`¥_îr
("microcode:Ço support forÅhis CPU vendor\n");

513  -
ENODEV
;

516 
mi¸ocode_pdev
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("microcode", -1,

517 
NULL
, 0);

518 i‡(
	`IS_ERR
(
mi¸ocode_pdev
)) {

519 
	`mi¸ocode_dev_exô
();

520  
	`PTR_ERR
(
mi¸ocode_pdev
);

523 
	`gë_⁄löe_˝us
();

524 
	`muãx_lock
(&
mi¸ocode_muãx
);

526 
îr‹
 = 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

528 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

529 
	`put_⁄löe_˝us
();

531 i‡(
îr‹
) {

532 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

533  
îr‹
;

536 
îr‹
 = 
	`mi¸ocode_dev_öô
();

537 i‡(
îr‹
)

538  
îr‹
;

540 
	`ªgi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

542 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION


547 
	}
}

548 
moduÀ_öô
(
mi¸ocode_öô
);

550 
__exô
 
	$mi¸ocode_exô
()

552 
	`mi¸ocode_dev_exô
();

554 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

556 
	`gë_⁄löe_˝us
();

557 
	`muãx_lock
(&
mi¸ocode_muãx
);

559 
	`sysdev_drivî_uƒegi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

561 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

562 
	`put_⁄löe_˝us
();

564 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

566 
mi¸ocode_›s
 = 
NULL
;

568 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION
 "Ñemoved.\n");

569 
	}
}

570 
moduÀ_exô
(
mi¸ocode_exô
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

73 
	~<löux/fúmw¨e.h
>

74 
	~<löux/uac˚ss.h
>

75 
	~<löux/kî√l.h
>

76 
	~<löux/moduÀ.h
>

77 
	~<löux/vmÆloc.h
>

79 
	~<asm/mi¸ocode.h
>

80 
	~<asm/¥o˚ss‹.h
>

81 
	~<asm/m§.h
>

83 
MODULE_DESCRIPTION
("Microcode Update Driver");

84 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

85 
MODULE_LICENSE
("GPL");

87 
	smi¸ocode_hódî_öãl
 {

88 
	mhdrvî
;

89 
	mªv
;

90 
	md©e
;

91 
	msig
;

92 
	mcksum
;

93 
	mldrvî
;

94 
	mpf
;

95 
	md©asize
;

96 
	mtŸÆsize
;

97 
	mª£rved
[3];

100 
	smi¸ocode_öãl
 {

101 
mi¸ocode_hódî_öãl
 
	mhdr
;

102 
	mbôs
[0];

106 
	sexãnded_sig«tuª
 {

107 
	msig
;

108 
	mpf
;

109 
	mcksum
;

112 
	sexãnded_sigèbÀ
 {

113 
	mcou¡
;

114 
	mcksum
;

115 
	mª£rved
[3];

116 
exãnded_sig«tuª
 
	msigs
[0];

119 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

120 
	#MC_HEADER_SIZE
 ((
mi¸ocode_hódî_öãl
))

	)

121 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

122 
	#EXT_HEADER_SIZE
 ((
exãnded_sigèbÀ
))

	)

123 
	#EXT_SIGNATURE_SIZE
 ((
exãnded_sig«tuª
))

	)

124 
	#DWSIZE
 ((
u32
))

	)

126 
	#gë_tŸÆsize
(
mc
) \

127 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 ? \

128 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 : \

129 
DEFAULT_UCODE_TOTALSIZE
)

	)

131 
	#gë_d©asize
(
mc
) \

132 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 ? \

133 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

135 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

136 (((
s1
Ë=(
s2
)Ë&& (((
p1
Ë& (
p2
)Ë|| ((’1Ë=0Ë&& (’2Ë=0))))

	)

138 
	#exâabÀ_size
(
ë
Ë(”t)->
cou¡
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

140 
	$cﬁÀ˘_˝u_öfo
(
˝u_num
, 
˝u_sig«tuª
 *
csig
)

142 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u_num
);

143 
vÆ
[2];

145 
	`mem£t
(
csig
, 0, (*csig));

147 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

148 
	`˝u_has
(
c
, 
X86_FEATURE_IA64
)) {

149 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%dÇotá capable Intel "

150 "¥o˚ss‹\n", 
˝u_num
);

154 
csig
->
sig
 = 
	`˝uid_óx
(0x00000001);

156 i‡((
c
->
x86_modñ
 >5Ë|| (c->
x86
 > 6)) {

158 
	`rdm§
(
MSR_IA32_PLATFORM_ID
, 
vÆ
[0], val[1]);

159 
csig
->
pf
 = 1 << ((
vÆ
[1] >> 18) & 7);

162 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

164 
	`sync_c‹e
();

166 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], 
csig
->
ªv
);

168 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d sig=0x%x,Öf=0x%x,Ñevision=0x%x\n",

169 
˝u_num
, 
csig
->
sig
, csig->
pf
, csig->
ªv
);

172 
	}
}

174 
ölöe
 
	$upd©e_m©ch_˝u
(
˝u_sig«tuª
 *
csig
, 
sig
, 
pf
)

176  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

177 
	}
}

179 
ölöe
 

180 
	$upd©e_m©ch_ªvisi⁄
(
mi¸ocode_hódî_öãl
 *
mc_hódî
, 
ªv
)

182  (
mc_hódî
->
ªv
 <=Ñev) ? 0 : 1;

183 
	}
}

185 
	$mi¸ocode_ßnôy_check
(*
mc
)

187 
tŸÆ_size
, 
d©a_size
, 
ext_èbÀ_size
;

188 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

189 
exãnded_sigèbÀ
 *
ext_hódî
 = 
NULL
;

190 
sum
, 
‹ig_sum
, 
ext_sigcou¡
 = 0, 
i
;

191 
exãnded_sig«tuª
 *
ext_sig
;

193 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

194 
d©a_size
 = 
	`gë_d©asize
(
mc_hódî
);

196 i‡(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tŸÆ_size
) {

197 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

199  -
EINVAL
;

202 i‡(
mc_hódî
->
ldrvî
 !1 || mc_hódî->
hdrvî
 != 1) {

203 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

205  -
EINVAL
;

207 
ext_èbÀ_size
 = 
tŸÆ_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

208 i‡(
ext_èbÀ_size
) {

209 i‡((
ext_èbÀ_size
 < 
EXT_HEADER_SIZE
)

210 || ((
ext_èbÀ_size
 - 
EXT_HEADER_SIZE
Ë% 
EXT_SIGNATURE_SIZE
)) {

211 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

213  -
EINVAL
;

215 
ext_hódî
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

216 i‡(
ext_èbÀ_size
 !
	`exâabÀ_size
(
ext_hódî
)) {

217 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

219  -
EFAULT
;

221 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

225 i‡(
ext_èbÀ_size
) {

226 
ext_èbÀ_sum
 = 0;

227 *
ext_èbÀp
 = (*)
ext_hódî
;

229 
i
 = 
ext_èbÀ_size
 / 
DWSIZE
;

230 
i
--)

231 
ext_èbÀ_sum
 +
ext_èbÀp
[
i
];

232 i‡(
ext_èbÀ_sum
) {

233 
	`¥ötk
(
KERN_WARNING
 "microcode:áborting, "

235  -
EINVAL
;

240 
‹ig_sum
 = 0;

241 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
Ë/ 
DWSIZE
;

242 
i
--)

243 
‹ig_sum
 +((*)
mc
)[
i
];

244 i‡(
‹ig_sum
) {

245 
	`¥ötk
(
KERN_ERR
 "microcode:áborting, bad checksum\n");

246  -
EINVAL
;

248 i‡(!
ext_èbÀ_size
)

251 
i
 = 0; i < 
ext_sigcou¡
; i++) {

252 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
 +

253 
EXT_SIGNATURE_SIZE
 * 
i
;

254 
sum
 = 
‹ig_sum


255 - (
mc_hódî
->
sig
 + mc_hódî->
pf
 + mc_hódî->
cksum
)

256 + (
ext_sig
->
sig
 +Éxt_sig->
pf
 +Éxt_sig->
cksum
);

257 i‡(
sum
) {

258 
	`¥ötk
(
KERN_ERR
 "microcode:áborting, bad checksum\n");

259  -
EINVAL
;

263 
	}
}

270 
	$gë_m©chög_mi¸ocode
(
˝u_sig«tuª
 *
˝u_sig
, *
mc
, 
ªv
)

272 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

273 
exãnded_sigèbÀ
 *
ext_hódî
;

274 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

275 
ext_sigcou¡
, 
i
;

276 
exãnded_sig«tuª
 *
ext_sig
;

278 i‡(!
	`upd©e_m©ch_ªvisi⁄
(
mc_hódî
, 
ªv
))

281 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
mc_hódî
->
sig
, mc_hódî->
pf
))

285 i‡(
tŸÆ_size
 <
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
)

288 
ext_hódî
 = 
mc
 + 
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
;

289 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

290 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
;

292 
i
 = 0; i < 
ext_sigcou¡
; i++) {

293 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
ext_sig
->
sig
,Éxt_sig->
pf
))

295 
ext_sig
++;

298 
	}
}

300 
	$≠∂y_mi¸ocode
(
˝u
)

302 
mi¸ocode_öãl
 *
mc_öãl
;

303 
ucode_˝u_öfo
 *
uci
;

304 
vÆ
[2];

305 
˝u_num
;

307 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

308 
uci
 = 
ucode_˝u_öfo
 + 
˝u
;

309 
mc_öãl
 = 
uci
->
mc
;

312 
	`BUG_ON
(
˝u_num
 !
˝u
);

314 i‡(
mc_öãl
 =
NULL
)

318 
	`wrm§
(
MSR_IA32_UCODE_WRITE
,

319 (Ë
mc_öãl
->
bôs
,

320 (Ë
mc_öãl
->
bôs
 >> 16 >> 16);

321 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

324 
	`sync_c‹e
();

327 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], val[1]);

329 i‡(
vÆ
[1] !
mc_öãl
->
hdr
.
ªv
) {

330 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d update "

332 
˝u_num
, 
mc_öãl
->
hdr
.
ªv
);

335 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d updatedÅoÑevision "

337 
˝u_num
, 
vÆ
[1],

338 
mc_öãl
->
hdr
.
d©e
 & 0xffff,

339 
mc_öãl
->
hdr
.
d©e
 >> 24,

340 (
mc_öãl
->
hdr
.
d©e
 >> 16) & 0xff);

342 
uci
->
˝u_sig
.
ªv
 = 
vÆ
[1];

345 
	}
}

347 
ucode_°©e
 
gíîic_lﬂd_mi¸ocode
(
˝u
, *
d©a
, 
size_t
 
size
,

348 (*
gë_ucode_d©a
)(*, c⁄° *, 
size_t
))

350 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

351 
u8
 *
ucode_±r
 = 
d©a
, *
√w_mc
 = 
NULL
, *
mc
;

352 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

353 
À·ovî
 = 
size
;

354 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

356 
À·ovî
) {

357 
mi¸ocode_hódî_öãl
 
mc_hódî
;

358 
mc_size
;

360 i‡(
	`gë_ucode_d©a
(&
mc_hódî
, 
ucode_±r
, (mc_header)))

363 
mc_size
 = 
	`gë_tŸÆsize
(&
mc_hódî
);

364 i‡(!
mc_size
 || mc_sizê> 
À·ovî
) {

365 
	`¥ötk
(
KERN_ERR
 "microcode:Érror!"

370 
mc
 = 
	`vmÆloc
(
mc_size
);

371 i‡(!
mc
)

374 i‡(
	`gë_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

375 
	`mi¸ocode_ßnôy_check
(
mc
) < 0) {

376 
	`v‰ì
(
mc
);

380 i‡(
	`gë_m©chög_mi¸ocode
(&
uci
->
˝u_sig
, 
mc
, 
√w_ªv
)) {

381 i‡(
√w_mc
)

382 
	`v‰ì
(
√w_mc
);

383 
√w_ªv
 = 
mc_hódî
.
ªv
;

384 
√w_mc
 = 
mc
;

386 
	`v‰ì
(
mc
);

388 
ucode_±r
 +
mc_size
;

389 
À·ovî
 -
mc_size
;

392 i‡(
À·ovî
) {

393 i‡(
√w_mc
)

394 
	`v‰ì
(
√w_mc
);

395 
°©e
 = 
UCODE_ERROR
;

396 
out
;

399 i‡(!
√w_mc
) {

400 
°©e
 = 
UCODE_NFOUND
;

401 
out
;

404 i‡(
uci
->
mc
)

405 
	`v‰ì
(
uci
->
mc
);

406 
uci
->
mc
 = (
mi¸ocode_öãl
 *)
√w_mc
;

408 
	`¥_debug
("microcode: CPU%d foundá matching microcode update with"

410 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

411 
out
:

412  
°©e
;

413 
	}
}

415 
	$gë_ucode_fw
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

417 
	`mem˝y
(
to
, 
‰om
, 
n
);

419 
	}
}

421 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

423 
«me
[30];

424 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

425 c⁄° 
fúmw¨e
 *firmware;

426 
ucode_°©e
 
ªt
;

428 
	`•rötf
(
«me
, "intel-ucode/%02x-%02x-%02x",

429 
c
->
x86
, c->
x86_modñ
, c->
x86_mask
);

431 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
«me
, 
devi˚
)) {

432 
	`¥_debug
("mi¸ocode: d©®fûê%†lﬂd faûed\n", 
«me
);

433  
UCODE_NFOUND
;

436 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
fúmw¨e
->
d©a
,

437 
fúmw¨e
->
size
, &
gë_ucode_fw
);

439 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

441  
ªt
;

442 
	}
}

444 
	$gë_ucode_u£r
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

446  
	`c›y_‰om_u£r
(
to
, 
‰om
, 
n
);

447 
	}
}

449 
ucode_°©e


450 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

452  
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
buf
, 
size
, &
gë_ucode_u£r
);

453 
	}
}

455 
	$mi¸ocode_föi_˝u
(
˝u
)

457 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

459 
	`v‰ì
(
uci
->
mc
);

460 
uci
->
mc
 = 
NULL
;

461 
	}
}

463 
mi¸ocode_›s
 
	gmi¸ocode_öãl_›s
 = {

464 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

465 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

466 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo
,

467 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode
,

468 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u
,

471 
mi¸ocode_›s
 * 
__öô
 
	$öô_öãl_mi¸ocode
()

473  &
mi¸ocode_öãl_›s
;

474 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/dmi.h
>

10 
	~<asm/pci-dúe˘.h
>

11 
	~<löux/s‹t.h
>

12 
	~<asm/io.h
>

13 
	~<asm/m§.h
>

14 
	~<asm/a˝i.h
>

15 
	~<asm/mmc⁄fig.h
>

16 
	~<asm/pci_x86.h
>

18 
	spci_ho°bridge_¥obe
 {

19 
u32
 
	mbus
;

20 
u32
 
	m¶Ÿ
;

21 
u32
 
	mvíd‹
;

22 
u32
 
	mdevi˚
;

25 
u64
 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£
;

26 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£_°©us
;

28 
pci_ho°bridge_¥obe
 
	gpci_¥obes
[] 
	g__˝uöôd©a
 = {

29 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

30 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

33 
	sønge
 {

34 
u64
 
	m°¨t
;

35 
u64
 
	míd
;

38 
__˝uöô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

40 c⁄° 
ønge
 *
r1
 = 
x1
;

41 c⁄° 
ønge
 *
r2
 = 
x2
;

42 
°¨t1
, 
°¨t2
;

44 
°¨t1
 = 
r1
->
°¨t
 >> 32;

45 
°¨t2
 = 
r2
->
°¨t
 >> 32;

47  
°¨t1
 - 
°¨t2
;

48 
	}
}

52 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

53 
	#BASE_VALID
(
b
Ë((b !(0xfdULL << 32)Ë&& (b !(0x„ULL << 32)))

	)

54 
__˝uöô
 
	$gë_Ám10h_pci_mmc⁄f_ba£
()

56 
i
;

57 
bus
;

58 
¶Ÿ
;

59 
found
;

61 
u64
 
vÆ
;

62 
u32
 
addªss
;

63 
u64
 
tom2
;

64 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

66 
hi_mmio_num
;

67 
ønge
Ñange[8];

71 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
)

74 i‡(!
	`óæy_pci_Ælowed
())

75 
Áû
;

77 
found
 = 0;

78 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_¥obes
); i++) {

79 
u32
 
id
;

80 
u16
 
devi˚
;

81 
u16
 
víd‹
;

83 
bus
 = 
pci_¥obes
[
i
].bus;

84 
¶Ÿ
 = 
pci_¥obes
[
i
].slot;

85 
id
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 0, 
PCI_VENDOR_ID
);

87 
víd‹
 = 
id
 & 0xffff;

88 
devi˚
 = (
id
>>16) & 0xffff;

89 i‡(
pci_¥obes
[
i
].
víd‹
 == vendor &&

90 
pci_¥obes
[
i
].
devi˚
 == device) {

91 
found
 = 1;

96 i‡(!
found
)

97 
Áû
;

100 
addªss
 = 
MSR_K8_SYSCFG
;

101 
	`rdm§l
(
addªss
, 
vÆ
);

104 i‡(!(
vÆ
 & (1<<21))) {

105 
tom2
 = 0;

108 
addªss
 = 
MSR_K8_TOP_MEM2
;

109 
	`rdm§l
(
addªss
, 
vÆ
);

110 
tom2
 = 
vÆ
 & (0xffffULL<<32);

113 i‡(
ba£
 <
tom2
)

114 
ba£
 = 
tom2
 + (1ULL<<32);

120 
hi_mmio_num
 = 0;

121 
i
 = 0; i < 8; i++) {

122 
u32
 
ªg
;

123 
u64
 
°¨t
;

124 
u64
 
íd
;

125 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x80 + (
i
 << 3));

126 i‡(!(
ªg
 & 3))

129 
°¨t
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

130 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x84 + (
i
 << 3));

131 
íd
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

133 i‡(!
íd
)

136 
ønge
[
hi_mmio_num
].
°¨t
 = start;

137 
ønge
[
hi_mmio_num
].
íd
 =Énd;

138 
hi_mmio_num
++;

141 i‡(!
hi_mmio_num
)

142 
out
;

145 
	`s‹t
(
ønge
, 
hi_mmio_num
, (ønge), 
cmp_ønge
, 
NULL
);

147 i‡(
ønge
[
hi_mmio_num
 - 1].
íd
 < 
ba£
)

148 
out
;

149 i‡(
ønge
[0].
°¨t
 > 
ba£
)

150 
out
;

153 
ba£
 = 
ønge
[0].
°¨t
 - (1ULL << 32);

154 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

155 
out
;

156 
ba£
 = 
ønge
[
hi_mmio_num
 - 1].
íd
 + (1ULL << 32);

157 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

158 
out
;

160 i‡(
hi_mmio_num
 > 1)

161 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

162 i‡(
ønge
[
i
 + 1].
°¨t
 > (ønge[i].
íd
 + (1ULL << 32))) {

163 
ba£
 = 
ønge
[
i
].
íd
 + (1ULL << 32);

164 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

165 
out
;

169 
Áû
:

170 
Ám10h_pci_mmc⁄f_ba£_°©us
 = -1;

172 
out
:

173 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

174 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

175 
	}
}

177 
__˝uöô
 
	$Ám10h_check_íabÀ_mmcfg
()

179 
u64
 
vÆ
;

180 
u32
 
addªss
;

182 i‡(!(
pci_¥obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

185 
addªss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

186 
	`rdm§l
(
addªss
, 
vÆ
);

189 i‡(
vÆ
 & 
FAM10H_MMIO_CONF_ENABLE
) {

190 
bu¢bôs
;

191 
bu¢bôs
 = (
vÆ
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

192 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

195 i‡(!
a˝i_pci_dißbÀd
 || 
bu¢bôs
 >= 8) {

196 
u64
 
ba£
;

197 
ba£
 = 
vÆ
 & (0xffffULL << 32);

198 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0) {

199 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

200 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

202 } i‡(
Ám10h_pci_mmc⁄f_ba£
 =
ba£
)

211 
	`gë_Ám10h_pci_mmc⁄f_ba£
();

212 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0)

215 
	`¥ötk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

216 
vÆ
 &~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

217 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

218 
vÆ
 |
Ám10h_pci_mmc⁄f_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

219 
FAM10H_MMIO_CONF_ENABLE
;

220 
	`wrm§l
(
addªss
, 
vÆ
);

221 
	}
}

223 
__devöô
 
	$£t_check_íabÀ_amd_mmc⁄f
(c⁄° 
dmi_sy°em_id
 *
d
)

225 
pci_¥obe
 |
PCI_CHECK_ENABLE_AMD_MMCONF
;

227 
	}
}

229 c⁄° 
dmi_sy°em_id
 
__˝uöôc⁄°
 
	gmmc⁄f_dmi_èbÀ
[] = {

231 .
ˇŒback
 = 
£t_check_íabÀ_amd_mmc⁄f
,

232 .
	gidít
 = "Sun Microsystems Machine",

233 .
	gm©ches
 = {

234 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

240 
__˝uöô
 
	$check_íabÀ_amd_mmc⁄f_dmi
()

242 
	`dmi_check_sy°em
(
mmc⁄f_dmi_èbÀ
);

243 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/bug.h
>

25 
	~<löux/mm.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/pgèbÀ.h
>

32 
	#DEBUGP
 
¥ötk


	)

34 
	#DEBUGP
(
fmt
...)

	)

37 *
	$moduÀ_Æloc
(
size
)

39 
vm_°ru˘
 *
¨ó
;

41 i‡(!
size
)

42  
NULL
;

43 
size
 = 
	`PAGE_ALIGN
(size);

44 i‡(
size
 > 
MODULES_LEN
)

45  
NULL
;

47 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

48 i‡(!
¨ó
)

49  
NULL
;

51  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
,

52 
PAGE_KERNEL_EXEC
);

53 
	}
}

56 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

58 
	`v‰ì
(
moduÀ_ªgi⁄
);

59 
	}
}

62 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

63 
Elf_Shdr
 *
£chdrs
,

64 *
£c°rögs
,

65 
moduÀ
 *
mod
)

68 
	}
}

70 #ifde‡
CONFIG_X86_32


71 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
,

72 c⁄° *
°πab
,

73 
symödex
,

74 
ªl£c
,

75 
moduÀ
 *
me
)

77 
i
;

78 
Elf32_Rñ
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

79 
Elf32_Sym
 *
sym
;

80 
uöt32_t
 *
loˇti⁄
;

82 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

83 
£chdrs
[
ªl£c
].
sh_öfo
);

84 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

86 
loˇti⁄
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


87 + 
ªl
[
i
].
r_off£t
;

90 
sym
 = (
Elf32_Sym
 *)
£chdrs
[
symödex
].
sh_addr


91 + 
	`ELF32_R_SYM
(
ªl
[
i
].
r_öfo
);

93 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

94 
R_386_32
:

96 *
loˇti⁄
 +
sym
->
°_vÆue
;

98 
R_386_PC32
:

100 *
loˇti⁄
 +
sym
->
°_vÆue
 - (
uöt32_t
)location;

103 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %u\n",

104 
me
->
«me
, 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
));

105  -
ENOEXEC
;

109 
	}
}

111 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
,

112 c⁄° *
°πab
,

113 
symödex
,

114 
ªl£c
,

115 
moduÀ
 *
me
)

117 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

118 
me
->
«me
);

119  -
ENOEXEC
;

120 
	}
}

122 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
,

123 c⁄° *
°πab
,

124 
symödex
,

125 
ªl£c
,

126 
moduÀ
 *
me
)

128 
i
;

129 
Elf64_Rña
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

130 
Elf64_Sym
 *
sym
;

131 *
loc
;

132 
u64
 
vÆ
;

134 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

135 
£chdrs
[
ªl£c
].
sh_öfo
);

136 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

138 
loc
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


139 + 
ªl
[
i
].
r_off£t
;

143 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr


144 + 
	`ELF64_R_SYM
(
ªl
[
i
].
r_öfo
);

146 
	`DEBUGP
("type %d st_value %LxÑ_addend %LxÜoc %Lx\n",

147 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
),

148 
sym
->
°_vÆue
, 
ªl
[
i
].
r_addíd
, (
u64
)
loc
);

150 
vÆ
 = 
sym
->
°_vÆue
 + 
ªl
[
i
].
r_addíd
;

152 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

153 
R_X86_64_NONE
:

155 
R_X86_64_64
:

156 *(
u64
 *)
loc
 = 
vÆ
;

158 
R_X86_64_32
:

159 *(
u32
 *)
loc
 = 
vÆ
;

160 i‡(
vÆ
 !*(
u32
 *)
loc
)

161 
ovîÊow
;

163 
R_X86_64_32S
:

164 *(
s32
 *)
loc
 = 
vÆ
;

165 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

166 
ovîÊow
;

168 
R_X86_64_PC32
:

169 
vÆ
 -(
u64
)
loc
;

170 *(
u32
 *)
loc
 = 
vÆ
;

172 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

173 
ovîÊow
;

177 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelaÑelocation: %llu\n",

178 
me
->
«me
, 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
));

179  -
ENOEXEC
;

184 
ovîÊow
:

185 
	`¥ötk
(
KERN_ERR
 "overflow inÑelocationÅype %d val %Lx\n",

186 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
), 
vÆ
);

187 
	`¥ötk
(
KERN_ERR
 "`%s'ÜikelyÇot compiled with -mcmodel=kernel\n",

188 
me
->
«me
);

189  -
ENOEXEC
;

190 
	}
}

192 
	$≠∂y_ªloˇã
(
Elf_Shdr
 *
£chdrs
,

193 c⁄° *
°πab
,

194 
symödex
,

195 
ªl£c
,

196 
moduÀ
 *
me
)

198 
	`¥ötk
(
KERN_ERR
 "nonáddÑelocationÇot supported\n");

199  -
ENOSYS
;

200 
	}
}

204 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
,

205 c⁄° 
Elf_Shdr
 *
£chdrs
,

206 
moduÀ
 *
me
)

208 c⁄° 
Elf_Shdr
 *
s
, *
ãxt
 = 
NULL
, *
Æt
 = NULL, *
locks
 = NULL,

209 *
∑ø
 = 
NULL
;

210 *
£c°rögs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh°∫dx
].
sh_off£t
;

212 
s
 = 
£chdrs
; s < sechdr†+ 
hdr
->
e_shnum
; s++) {

213 i‡(!
	`°rcmp
(".ãxt", 
£c°rögs
 + 
s
->
sh_«me
))

214 
ãxt
 = 
s
;

215 i‡(!
	`°rcmp
(".Ætö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

216 
Æt
 = 
s
;

217 i‡(!
	`°rcmp
(".smp_locks", 
£c°rögs
 + 
s
->
sh_«me
))

218 
locks
 = 
s
;

219 i‡(!
	`°rcmp
(".∑øö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

220 
∑ø
 = 
s
;

223 i‡(
Æt
) {

225 *
a£g
 = (*)
Æt
->
sh_addr
;

226 
	`≠∂y_Æã∫©ives
(
a£g
,á£g + 
Æt
->
sh_size
);

228 i‡(
locks
 && 
ãxt
) {

229 *
l£g
 = (*)
locks
->
sh_addr
;

230 *
t£g
 = (*)
ãxt
->
sh_addr
;

231 
	`Æã∫©ives_smp_moduÀ_add
(
me
, me->
«me
,

232 
l£g
,Ü£g + 
locks
->
sh_size
,

233 
t£g
,Å£g + 
ãxt
->
sh_size
);

236 i‡(
∑ø
) {

237 *
p£g
 = (*)
∑ø
->
sh_addr
;

238 
	`≠∂y_∑øvút
(
p£g
,Ö£g + 
∑ø
->
sh_size
);

241  
	`moduÀ_bug_föÆize
(
hdr
, 
£chdrs
, 
me
);

242 
	}
}

244 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

246 
	`Æã∫©ives_smp_moduÀ_dñ
(
mod
);

247 
	`moduÀ_bug_˛ónup
(
mod
);

248 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<löux/mm.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dñay.h
>

13 
	~<löux/boŸmem.h
>

14 
	~<löux/kî√l_°©.h
>

15 
	~<löux/mc146818πc.h
>

16 
	~<löux/bô›s.h
>

17 
	~<löux/a˝i.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/pci.h
>

22 
	~<asm/mår.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/pgÆloc.h
>

25 
	~<asm/io_≠ic.h
>

26 
	~<asm/¥Ÿo.h
>

27 
	~<asm/bios_ebda.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/åampﬁöe.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/smp.h
>

33 
	~<asm/≠ic.h
>

38 
__öô
 
	$mpf_checksum
(*
mp
, 
Àn
)

40 
sum
 = 0;

42 
Àn
--)

43 
sum
 +*
mp
++;

45  
sum
 & 0xFF;

46 
	}
}

48 
__öô
 
	$MP_¥o˚ss‹_öfo
(
mpc_˝u
 *
m
)

50 
≠icid
;

51 *
boŸup_˝u
 = "";

53 i‡(!(
m
->
˝uÊag
 & 
CPU_ENABLED
)) {

54 
dißbÀd_˝us
++;

58 i‡(
x86_quúks
->
mpc_≠ic_id
)

59 
≠icid
 = 
x86_quúks
->
	`mpc_≠ic_id
(
m
);

61 
≠icid
 = 
m
->apicid;

63 i‡(
m
->
˝uÊag
 & 
CPU_BOOTPROCESSOR
) {

64 
boŸup_˝u
 = " (Bootup-CPU)";

65 
boŸ_˝u_physiˇl_≠icid
 = 
m
->
≠icid
;

68 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹ #%d%s\n", 
m
->
≠icid
, 
boŸup_˝u
);

69 
	`gíîic_¥o˚ss‹_öfo
(
≠icid
, 
m
->
≠icvî
);

70 
	}
}

72 #ifde‡
CONFIG_X86_IO_APIC


73 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
)

75 
°r
[7];

76 
	`mem˝y
(
°r
, 
m
->
bu°y≥
, 6);

77 
°r
[6] = 0;

79 i‡(
x86_quúks
->
mpc_€m_bus_öfo
)

80 
x86_quúks
->
	`mpc_€m_bus_öfo
(
m
, 
°r
);

82 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Bu†#%d i†%s\n", 
m
->
busid
, 
°r
);

84 #i‡
MAX_MP_BUSSES
 < 256

85 i‡(
m
->
busid
 >
MAX_MP_BUSSES
) {

86 
	`¥ötk
(
KERN_WARNING
 "MPÅable busid value (%d) for bustype %s "

88 
m
->
busid
, 
°r
, 
MAX_MP_BUSSES
 - 1);

93 i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

94 
	`£t_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

95 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

96 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_ISA
;

98 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

99 i‡(
x86_quúks
->
mpc_€m_pci_bus
)

100 
x86_quúks
->
	`mpc_€m_pci_bus
(
m
);

102 
	`˛ór_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

103 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

104 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_PCI
;

105 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

106 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_EISA
;

107 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

108 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_MCA
;

111 
	`¥ötk
(
KERN_WARNING
 "Unknow¿bu°y≥ %†- ign‹ög\n", 
°r
);

112 
	}
}

114 
	$bad_iﬂpic
(
addªss
)

116 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

117 
	`¥ötk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)Éxceeded "

118 "(found %d)\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

119 
	`∑nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

121 i‡(!
addªss
) {

122 
	`¥ötk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APICáddress"

127 
	}
}

129 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
)

131 i‡(!(
m
->
Êags
 & 
MPC_APIC_USABLE
))

134 
	`¥ötk
(
KERN_INFO
 "I/O APIC #%d Version %dát 0x%X.\n",

135 
m
->
≠icid
, m->
≠icvî
, m->
≠iˇddr
);

137 i‡(
	`bad_iﬂpic
(
m
->
≠iˇddr
))

140 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠iˇddr
 = 
m
->apicaddr;

141 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icid
 = 
m
->apicid;

142 
mp_iﬂpics
[
ƒ_iﬂpics
].
ty≥
 = 
m
->type;

143 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icvî
 = 
m
->apicver;

144 
mp_iﬂpics
[
ƒ_iﬂpics
].
Êags
 = 
m
->flags;

145 
ƒ_iﬂpics
++;

146 
	}
}

148 
	$¥öt_MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

150 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

152 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbus
,

153 
m
->
§cbusúq
, m->
d°≠ic
, m->
d°úq
);

154 
	}
}

156 
__öô
 
	$¥öt_mp_úq_öfo
(
mpc_öt§c
 *
mp_úq
)

158 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

160 
mp_úq
->
úqty≥
, mp_úq->
úqÊag
 & 3,

161 (
mp_úq
->
úqÊag
 >> 2Ë& 3, mp_úq->
§cbus
,

162 
mp_úq
->
§cbusúq
, mp_úq->
d°≠ic
, mp_úq->
d°úq
);

163 
	}
}

165 
__öô
 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

166 
mpc_öt§c
 *
mp_úq
)

168 
mp_úq
->
d°≠ic
 = 
m
->dstapic;

169 
mp_úq
->
ty≥
 = 
m
->type;

170 
mp_úq
->
úqty≥
 = 
m
->irqtype;

171 
mp_úq
->
úqÊag
 = 
m
->irqflag;

172 
mp_úq
->
§cbus
 = 
m
->srcbus;

173 
mp_úq
->
§cbusúq
 = 
m
->srcbusirq;

174 
mp_úq
->
d°úq
 = 
m
->dstirq;

175 
	}
}

177 
__öô
 
	$assign_to_mpc_öt§c
(
mpc_öt§c
 *
mp_úq
,

178 
mpc_öt§c
 *
m
)

180 
m
->
d°≠ic
 = 
mp_úq
->dstapic;

181 
m
->
ty≥
 = 
mp_úq
->type;

182 
m
->
úqty≥
 = 
mp_úq
->irqtype;

183 
m
->
úqÊag
 = 
mp_úq
->irqflag;

184 
m
->
§cbus
 = 
mp_úq
->srcbus;

185 
m
->
§cbusúq
 = 
mp_úq
->srcbusirq;

186 
m
->
d°úq
 = 
mp_úq
->dstirq;

187 
	}
}

189 
__öô
 
	$mp_úq_mpc_öt§c_cmp
(
mpc_öt§c
 *
mp_úq
,

190 
mpc_öt§c
 *
m
)

192 i‡(
mp_úq
->
d°≠ic
 !
m
->dstapic)

194 i‡(
mp_úq
->
ty≥
 !
m
->type)

196 i‡(
mp_úq
->
úqty≥
 !
m
->irqtype)

198 i‡(
mp_úq
->
úqÊag
 !
m
->irqflag)

200 i‡(
mp_úq
->
§cbus
 !
m
->srcbus)

202 i‡(
mp_úq
->
§cbusúq
 !
m
->srcbusirq)

204 i‡(
mp_úq
->
d°úq
 !
m
->dstirq)

208 
	}
}

210 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

212 
i
;

214 
	`¥öt_MP_öt§c_öfo
(
m
);

216 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

217 i‡(!
	`mp_úq_mpc_öt§c_cmp
(&
mp_úqs
[
i
], 
m
))

221 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

222 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

223 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

224 
	}
}

226 
ölöe
 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
Ë{
	}
}

227 
ölöe
 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
Ë{
	}
}

228 
ölöe
 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
Ë{
	}
}

232 
__öô
 
	$MP_löt§c_öfo
(
mpc_löt§c
 *
m
)

234 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Lint:Åype %d,Öol %d,Årig %d, bus %02x,"

236 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbusid
,

237 
m
->
§cbusúq
, m->
de°≠ic
, m->
de°≠i˛öt
);

238 
	}
}

244 
__öô
 
	$smp_check_mpc
(
mpc_èbÀ
 *
mpc
, *
€m
, *
°r
)

247 i‡(
	`memcmp
(
mpc
->
sig«tuª
, 
MPC_SIGNATURE
, 4)) {

248 
	`¥ötk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

249 
mpc
->
sig«tuª
[0], mpc->signature[1],

250 
mpc
->
sig«tuª
[2], mpc->signature[3]);

253 i‡(
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
)) {

254 
	`¥ötk
(
KERN_ERR
 "MPTABLE: checksumÉrror!\n");

257 i‡(
mpc
->
•ec
 != 0x01 && mpc->spec != 0x04) {

258 
	`¥ötk
(
KERN_ERR
 "MPTABLE: badÅable version (%d)!!\n",

259 
mpc
->
•ec
);

262 i‡(!
mpc
->
œpic
) {

263 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇullÜocal APICáddress!\n");

266 
	`mem˝y
(
€m
, 
mpc
->oem, 8);

267 
€m
[8] = 0;

268 
	`¥ötk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
€m
);

270 
	`mem˝y
(
°r
, 
mpc
->
¥odu˘id
, 12);

271 
°r
[12] = 0;

273 
	`¥ötk
(
KERN_INFO
 "MPTABLE: Produ˘ ID: %s\n", 
°r
);

275 
	`¥ötk
(
KERN_INFO
 "MPTABLE: APICát: 0x%X\n", 
mpc
->
œpic
);

278 
	}
}

280 
	$skù_íåy
(**
±r
, *
cou¡
, 
size
)

282 *
±r
 +
size
;

283 *
cou¡
 +
size
;

284 
	}
}

286 
__öô
 
	$smp_dump_m±abÀ
(
mpc_èbÀ
 *
mpc
, *
m±
)

288 
	`¥ötk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

289 "ty≥ %x\n", *
m±
);

290 
	`¥öt_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

291 1, 
mpc
, mpc->
Àngth
, 1);

292 
	}
}

294 
__öô
 
	$smp_ªad_mpc
(
mpc_èbÀ
 *
mpc
, 
óæy
)

296 
°r
[16];

297 
€m
[10];

299 
cou¡
 = (*
mpc
);

300 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

302 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

305 #ifde‡
CONFIG_X86_32


306 
	`gíîic_mps_€m_check
(
mpc
, 
€m
, 
°r
);

309 i‡(!
a˝i_œpic
)

310 
mp_œpic_addr
 = 
mpc
->
œpic
;

312 i‡(
óæy
)

315 i‡(
mpc
->
€m±r
 && 
x86_quúks
->
smp_ªad_mpc_€m
) {

316 
mpc_€mèbÀ
 *
€m_èbÀ
 = (*)()
mpc
->
€m±r
;

317 
x86_quúks
->
	`smp_ªad_mpc_€m
(
€m_èbÀ
, 
mpc
->
€msize
);

323 i‡(
x86_quúks
->
mpc_ªc‹d
)

324 *
x86_quúks
->
mpc_ªc‹d
 = 0;

326 
cou¡
 < 
mpc
->
Àngth
) {

327 *
m±
) {

328 
MP_PROCESSOR
:

330 i‡(!
a˝i_œpic
)

331 
	`MP_¥o˚ss‹_öfo
((
mpc_˝u
 *)
m±
);

332 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

334 
MP_BUS
:

335 
	`MP_bus_öfo
((
mpc_bus
 *)
m±
);

336 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

338 
MP_IOAPIC
:

339 
	`MP_iﬂpic_öfo
((
mpc_iﬂpic
 *)
m±
);

340 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

342 
MP_INTSRC
:

343 
	`MP_öt§c_öfo
((
mpc_öt§c
 *)
m±
);

344 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

346 
MP_LINTSRC
:

347 
	`MP_löt§c_öfo
((
mpc_löt§c
 *)
m±
);

348 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

352 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

353 
cou¡
 = 
mpc
->
Àngth
;

356 i‡(
x86_quúks
->
mpc_ªc‹d
)

357 (*
x86_quúks
->
mpc_ªc‹d
)++;

360 #ifde‡
CONFIG_X86_BIGSMP


361 
	`gíîic_bigsmp_¥obe
();

364 i‡(
≠ic
->
£tup_≠ic_routög
)

365 
≠ic
->
	`£tup_≠ic_routög
();

367 i‡(!
num_¥o˚ss‹s
)

368 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇoÖrocessorsÑegistered!\n");

369  
num_¥o˚ss‹s
;

370 
	}
}

372 #ifde‡
CONFIG_X86_IO_APIC


374 
__öô
 
	$ELCR_åiggî
(
úq
)

376 
p‹t
;

378 
p‹t
 = 0x4d0 + (
úq
 >> 3);

379  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

380 
	}
}

382 
__öô
 
	$c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
)

384 
mpc_öt§c
 
öt§c
;

385 
i
;

386 
ELCR_ÁŒback
 = 0;

388 
öt§c
.
ty≥
 = 
MP_INTSRC
;

389 
öt§c
.
úqÊag
 = 0;

390 
öt§c
.
§cbus
 = 0;

391 
öt§c
.
d°≠ic
 = 
mp_iﬂpics
[0].
≠icid
;

393 
öt§c
.
úqty≥
 = 
mp_INT
;

403 i‡(
mpc_deÁu…_ty≥
 == 5) {

404 
	`¥ötk
(
KERN_INFO
 "ISA/PCI busÅype withÇo IRQ information... "

407 i‡(
	`ELCR_åiggî
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

408 
	`ELCR_åiggî
(13))

409 
	`¥ötk
(
KERN_ERR
 "ELCR contains invalid data... "

412 
	`¥ötk
(
KERN_INFO


414 
ELCR_ÁŒback
 = 1;

418 
i
 = 0; i < 16; i++) {

419 
mpc_deÁu…_ty≥
) {

421 i‡(
i
 == 0 || i == 13)

425 i‡(
i
 == 2)

429 i‡(
ELCR_ÁŒback
) {

435 i‡(
	`ELCR_åiggî
(
i
))

436 
öt§c
.
úqÊag
 = 13;

438 
öt§c
.
úqÊag
 = 0;

441 
öt§c
.
§cbusúq
 = 
i
;

442 
öt§c
.
d°úq
 = 
i
 ? i : 2;

443 
	`MP_öt§c_öfo
(&
öt§c
);

446 
öt§c
.
úqty≥
 = 
mp_ExtINT
;

447 
öt§c
.
§cbusúq
 = 0;

448 
öt§c
.
d°úq
 = 0;

449 
	`MP_öt§c_öfo
(&
öt§c
);

450 
	}
}

453 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
)

455 
mpc_iﬂpic
 
iﬂpic
;

456 
mpc_bus
 
bus
;

458 
bus
.
ty≥
 = 
MP_BUS
;

459 
bus
.
busid
 = 0;

460 
mpc_deÁu…_ty≥
) {

462 
	`¥ötk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

463 
mpc_deÁu…_ty≥
);

467 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

472 
	`mem˝y
(
bus
.
bu°y≥
, "EISA ", 6);

476 
	`mem˝y
(
bus
.
bu°y≥
, "MCA ", 6);

478 
	`MP_bus_öfo
(&
bus
);

479 i‡(
mpc_deÁu…_ty≥
 > 4) {

480 
bus
.
busid
 = 1;

481 
	`mem˝y
(
bus
.
bu°y≥
, "PCI ", 6);

482 
	`MP_bus_öfo
(&
bus
);

485 
iﬂpic
.
ty≥
 = 
MP_IOAPIC
;

486 
iﬂpic
.
≠icid
 = 2;

487 
iﬂpic
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

488 
iﬂpic
.
Êags
 = 
MPC_APIC_USABLE
;

489 
iﬂpic
.
≠iˇddr
 = 0xFEC00000;

490 
	`MP_iﬂpic_öfo
(&
iﬂpic
);

495 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
);

496 
	}
}

498 
ölöe
 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
Ë{ 
	}
}

501 
ölöe
 
__öô
 
	$c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpc_deÁu…_ty≥
)

503 
mpc_˝u
 
¥o˚ss‹
;

504 
mpc_löt§c
 
löt§c
;

505 
löây≥s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

506 
i
;

511 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

516 
¥o˚ss‹
.
ty≥
 = 
MP_PROCESSOR
;

518 
¥o˚ss‹
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

519 
¥o˚ss‹
.
˝uÊag
 = 
CPU_ENABLED
;

520 
¥o˚ss‹
.
˝u„©uª
 = (
boŸ_˝u_d©a
.
x86
 << 8) |

521 (
boŸ_˝u_d©a
.
x86_modñ
 << 4Ë| boŸ_˝u_d©a.
x86_mask
;

522 
¥o˚ss‹
.
„©uªÊag
 = 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[0];

523 
¥o˚ss‹
.
ª£rved
[0] = 0;

524 
¥o˚ss‹
.
ª£rved
[1] = 0;

525 
i
 = 0; i < 2; i++) {

526 
¥o˚ss‹
.
≠icid
 = 
i
;

527 
	`MP_¥o˚ss‹_öfo
(&
¥o˚ss‹
);

530 
	`c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
);

532 
löt§c
.
ty≥
 = 
MP_LINTSRC
;

533 
löt§c
.
úqÊag
 = 0;

534 
löt§c
.
§cbusid
 = 0;

535 
löt§c
.
§cbusúq
 = 0;

536 
löt§c
.
de°≠ic
 = 
MP_APIC_ALL
;

537 
i
 = 0; i < 2; i++) {

538 
löt§c
.
úqty≥
 = 
löây≥s
[
i
];

539 
löt§c
.
de°≠i˛öt
 = 
i
;

540 
	`MP_löt§c_öfo
(&
löt§c
);

542 
	}
}

544 
mpf_öãl
 *
	gmpf_found
;

546 
__öô
 
	$gë_mpc_size
(
phy•å
)

548 
mpc_èbÀ
 *
mpc
;

549 
size
;

551 
mpc
 = 
	`óæy_i‹em≠
(
phy•å
, 
PAGE_SIZE
);

552 
size
 = 
mpc
->
Àngth
;

553 
	`óæy_iounm≠
(
mpc
, 
PAGE_SIZE
);

554 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy•å
,Öhy•å + 
size
);

556  
size
;

557 
	}
}

559 
__öô
 
	$check_phy•å
(
mpf_öãl
 *
mpf
, 
óæy
)

561 
mpc_èbÀ
 *
mpc
;

562 
size
;

564 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

565 
mpc
 = 
	`óæy_i‹em≠
(
mpf
->
phy•å
, 
size
);

570 i‡(!
	`smp_ªad_mpc
(
mpc
, 
óæy
)) {

571 #ifde‡
CONFIG_X86_LOCAL_APIC


572 
smp_found_c⁄fig
 = 0;

574 
	`¥ötk
(
KERN_ERR
 "BIOS bug, MPÅableÉrrors detected!...\n"

576 
	`óæy_iounm≠
(
mpc
, 
size
);

579 
	`óæy_iounm≠
(
mpc
, 
size
);

581 i‡(
óæy
)

584 #ifde‡
CONFIG_X86_IO_APIC


590 i‡(!
mp_úq_íåõs
) {

591 
mpc_bus
 
bus
;

593 
	`¥ötk
(
KERN_ERR
 "BIOS bug,ÇoÉxplicit IRQÉntries, "

596 
bus
.
ty≥
 = 
MP_BUS
;

597 
bus
.
busid
 = 0;

598 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

599 
	`MP_bus_öfo
(&
bus
);

601 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(0);

606 
	}
}

611 
__öô
 
	$__gë_smp_c⁄fig
(
óæy
)

613 
mpf_öãl
 *
mpf
 = 
mpf_found
;

615 i‡(!
mpf
)

618 i‡(
a˝i_œpic
 && 
óæy
)

625 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

628 i‡(
x86_quúks
->
mach_gë_smp_c⁄fig
) {

629 i‡(
x86_quúks
->
	`mach_gë_smp_c⁄fig
(
óæy
))

633 
	`¥ötk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

634 
mpf
->
•ecifiˇti⁄
);

635 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_X86_32
)

636 i‡(
mpf
->
„©uª2
 & (1 << 7)) {

637 
	`¥ötk
(
KERN_INFO
 " IMCRánd PIC compatibility mode.\n");

638 
pic_mode
 = 1;

640 
	`¥ötk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

641 
pic_mode
 = 0;

647 i‡(
mpf
->
„©uª1
 != 0) {

648 i‡(
óæy
) {

652 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

656 
	`¥ötk
(
KERN_INFO
 "Default MP configuration #%d\n",

657 
mpf
->
„©uª1
);

658 
	`c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpf
->
„©uª1
);

660 } i‡(
mpf
->
phy•å
) {

661 i‡(
	`check_phy•å
(
mpf
, 
óæy
))

664 
	`BUG
();

666 i‡(!
óæy
)

667 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹s: %d\n", 
num_¥o˚ss‹s
);

671 
	}
}

673 
__öô
 
	$óæy_gë_smp_c⁄fig
()

675 
	`__gë_smp_c⁄fig
(1);

676 
	}
}

678 
__öô
 
	$gë_smp_c⁄fig
()

680 
	`__gë_smp_c⁄fig
(0);

681 
	}
}

683 
__öô
 
	$smp_ª£rve_boŸmem
(
mpf_öãl
 *
mpf
)

685 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

686 #ifde‡
CONFIG_X86_32


696 
íd
 = 
max_low_p‚
 * 
PAGE_SIZE
;

698 i‡(
mpf
->
phy•å
 < 
íd
) {

699 i‡(
mpf
->
phy•å
 + 
size
 > 
íd
)

700 
size
 = 
íd
 - 
mpf
->
phy•å
;

701 
	`ª£rve_boŸmem_gíîic
(
mpf
->
phy•å
, 
size
, 
BOOTMEM_DEFAULT
);

704 
	`ª£rve_boŸmem_gíîic
(
mpf
->
phy•å
, 
size
, 
BOOTMEM_DEFAULT
);

706 
	}
}

708 
__öô
 
	$smp_sˇn_c⁄fig
(
ba£
, 
Àngth
,

709 
ª£rve
)

711 *
bp
 = 
	`phys_to_vút
(
ba£
);

712 
mpf_öãl
 *
mpf
;

714 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

715 
bp
, 
Àngth
);

716 
	`BUILD_BUG_ON
((*
mpf
) != 16);

718 
Àngth
 > 0) {

719 
mpf
 = (
mpf_öãl
 *)
bp
;

720 i‡((*
bp
 =
SMP_MAGIC_IDENT
) &&

721 (
mpf
->
Àngth
 == 1) &&

722 !
	`mpf_checksum
((*)
bp
, 16) &&

723 ((
mpf
->
•ecifiˇti⁄
 == 1)

724 || (
mpf
->
•ecifiˇti⁄
 == 4))) {

725 #ifde‡
CONFIG_X86_LOCAL_APIC


726 
smp_found_c⁄fig
 = 1;

728 
mpf_found
 = 
mpf
;

730 
	`¥ötk
(
KERN_INFO
 "found SMP MP-tableát [%p] %llx\n",

731 
mpf
, (
u64
)
	`vút_to_phys
(mpf));

733 i‡(!
ª£rve
)

735 
	`ª£rve_boŸmem_gíîic
(
	`vút_to_phys
(
mpf
), (*mpf),

736 
BOOTMEM_DEFAULT
);

737 i‡(
mpf
->
phy•å
)

738 
	`smp_ª£rve_boŸmem
(
mpf
);

742 
bp
 += 4;

743 
Àngth
 -= 16;

746 
	}
}

748 
__öô
 
	$__föd_smp_c⁄fig
(
ª£rve
)

750 
addªss
;

752 i‡(
x86_quúks
->
mach_föd_smp_c⁄fig
) {

753 i‡(
x86_quúks
->
	`mach_föd_smp_c⁄fig
(
ª£rve
))

764 i‡(
	`smp_sˇn_c⁄fig
(0x0, 0x400, 
ª£rve
) ||

765 
	`smp_sˇn_c⁄fig
(639 * 0x400, 0x400, 
ª£rve
) ||

766 
	`smp_sˇn_c⁄fig
(0xF0000, 0x10000, 
ª£rve
))

785 
addªss
 = 
	`gë_bios_ebda
();

786 i‡(
addªss
)

787 
	`smp_sˇn_c⁄fig
(
addªss
, 0x400, 
ª£rve
);

788 
	}
}

790 
__öô
 
	$óæy_föd_smp_c⁄fig
()

792 
	`__föd_smp_c⁄fig
(0);

793 
	}
}

795 
__öô
 
	$föd_smp_c⁄fig
()

797 
	`__föd_smp_c⁄fig
(1);

798 
	}
}

800 #ifde‡
CONFIG_X86_IO_APIC


801 
u8
 
__öôd©a
 
	gúq_u£d
[
MAX_IRQ_SOURCES
];

803 
__öô
 
	$gë_MP_öt§c_ödex
(
mpc_öt§c
 *
m
)

805 
i
;

807 i‡(
m
->
úqty≥
 !
mp_INT
)

810 i‡(
m
->
úqÊag
 != 0x0f)

815 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

816 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

819 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

822 i‡(
mp_úqs
[
i
].
§cbus
 !
m
->srcbus)

824 i‡(
mp_úqs
[
i
].
§cbusúq
 !
m
->srcbusirq)

826 i‡(
úq_u£d
[
i
]) {

830 
úq_u£d
[
i
] = 1;

831  
i
;

836 
	}
}

838 
	#SPARE_SLOT_NUM
 20

	)

840 
mpc_öt§c
 
__öôd©a
 *
	gm_•¨e
[
SPARE_SLOT_NUM
];

842 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
)

844 
i
;

846 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "OLD ");

847 
	`¥öt_MP_öt§c_öfo
(
m
);

849 
i
 = 
	`gë_MP_öt§c_ödex
(
m
);

850 i‡(
i
 > 0) {

851 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

852 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "NEW ");

853 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

856 i‡(!
i
) {

860 i‡(*
ƒ_m_•¨e
 < 
SPARE_SLOT_NUM
) {

865 
m_•¨e
[*
ƒ_m_•¨e
] = 
m
;

866 *
ƒ_m_•¨e
 += 1;

868 
	}
}

871 
ölöe
 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
Ë{
	}
}

875 
	$check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
)

877 
ªt
 = 0;

879 i‡(!
mpc_√w_phys
 || 
cou¡
 <
mpc_√w_Àngth
) {

880 
	`WARN
(1, "upd©e_m±abÀ: Nÿ•¨ê¶Ÿ†÷ígth: %x)\n", 
cou¡
);

884  
ªt
;

885 
	}
}

887 
__öô
 
	$ª∂a˚_öt§c_Æl
(
mpc_èbÀ
 *
mpc
,

888 
mpc_√w_phys
,

889 
mpc_√w_Àngth
)

891 #ifde‡
CONFIG_X86_IO_APIC


892 
i
;

894 
cou¡
 = (*
mpc
);

895 
ƒ_m_•¨e
 = 0;

896 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

898 
	`¥ötk
(
KERN_INFO
 "mpc_Àngth %x\n", 
mpc
->
Àngth
);

899 
cou¡
 < 
mpc
->
Àngth
) {

900 *
m±
) {

901 
MP_PROCESSOR
:

902 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

904 
MP_BUS
:

905 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

907 
MP_IOAPIC
:

908 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

910 
MP_INTSRC
:

911 
	`check_úq_§c
((
mpc_öt§c
 *)
m±
, &
ƒ_m_•¨e
);

912 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

914 
MP_LINTSRC
:

915 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

919 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

920 
out
;

924 #ifde‡
CONFIG_X86_IO_APIC


925 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

926 i‡(
úq_u£d
[
i
])

929 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

932 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

935 i‡(
ƒ_m_•¨e
 > 0) {

936 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "*NEW* found\n");

937 
ƒ_m_•¨e
--;

938 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m_•¨e
[
ƒ_m_•¨e
]);

939 
m_•¨e
[
ƒ_m_•¨e
] = 
NULL
;

941 
mpc_öt§c
 *
m
 = (mpc_öt§¯*)
m±
;

942 
cou¡
 +(
mpc_öt§c
);

943 i‡(
	`check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
) < 0)

944 
out
;

945 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

946 
mpc
->
Àngth
 = 
cou¡
;

947 
m±
 +(
mpc_öt§c
);

949 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

952 
out
:

954 
mpc
->
checksum
 = 0;

955 
mpc
->
checksum
 -
	`mpf_checksum
((*)mpc, mpc->
Àngth
);

958 
	}
}

960 
	gíabÀ_upd©e_m±abÀ
;

962 
__öô
 
	$upd©e_m±abÀ_£tup
(*
°r
)

964 
íabÀ_upd©e_m±abÀ
 = 1;

965 #ifde‡
CONFIG_PCI


966 
pci_rouãúq
 = 1;

969 
	}
}

970 
óæy_∑øm
("upd©e_m±abÀ", 
upd©e_m±abÀ_£tup
);

972 
__öôd©a
 
	gmpc_√w_phys
;

973 
mpc_√w_Àngth
 
	g__öôd©a
 = 4096;

976 
__öôd©a
 
	gÆloc_m±abÀ
;

977 
__öô
 
	$∑r£_Æloc_m±abÀ_›t
(*
p
)

979 
íabÀ_upd©e_m±abÀ
 = 1;

980 #ifde‡
CONFIG_PCI


981 
pci_rouãúq
 = 1;

983 
Æloc_m±abÀ
 = 1;

984 i‡(!
p
)

986 
mpc_√w_Àngth
 = 
	`mem∑r£
(
p
, &p);

988 
	}
}

989 
óæy_∑øm
("Æloc_m±abÀ", 
∑r£_Æloc_m±abÀ_›t
);

991 
__öô
 
	$óæy_ª£rve_e820_mpc_√w
()

993 i‡(
íabÀ_upd©e_m±abÀ
 && 
Æloc_m±abÀ
) {

994 
u64
 
°¨â
 = 0;

995 #ifde‡
CONFIG_X86_TRAMPOLINE


996 
°¨â
 = 
TRAMPOLINE_BASE
;

998 
mpc_√w_phys
 = 
	`óæy_ª£rve_e820
(
°¨â
, 
mpc_√w_Àngth
, 4);

1000 
	}
}

1002 
__öô
 
	$upd©e_mp_èbÀ
()

1004 
°r
[16];

1005 
€m
[10];

1006 
mpf_öãl
 *
mpf
;

1007 
mpc_èbÀ
 *
mpc
, *
mpc_√w
;

1009 i‡(!
íabÀ_upd©e_m±abÀ
)

1012 
mpf
 = 
mpf_found
;

1013 i‡(!
mpf
)

1019 i‡(
mpf
->
„©uª1
 != 0)

1022 i‡(!
mpf
->
phy•å
)

1025 
mpc
 = 
	`phys_to_vút
(
mpf
->
phy•å
);

1027 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

1030 
	`¥ötk
(
KERN_INFO
 "mpf: %Œx\n", (
u64
)
	`vút_to_phys
(
mpf
));

1031 
	`¥ötk
(
KERN_INFO
 "phy•å: %x\n", 
mpf
->
phy•å
);

1033 i‡(
mpc_√w_phys
 && 
mpc
->
Àngth
 > 
mpc_√w_Àngth
) {

1034 
mpc_√w_phys
 = 0;

1035 
	`¥ötk
(
KERN_INFO
 "mpc_new_length is %ld,Ölease useálloc_mptable=8k\n",

1036 
mpc_√w_Àngth
);

1039 i‡(!
mpc_√w_phys
) {

1040 
ﬁd
, 
√w
;

1042 
mpc
->
checksum
 = 0;

1043 
ﬁd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

1044 
mpc
->
checksum
 = 0xff;

1045 
√w
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

1046 i‡(
ﬁd
 =
√w
) {

1047 
	`¥ötk
(
KERN_INFO
 "mpc isÑeadonly,ÖleaseÅryálloc_mptable instead\n");

1050 
	`¥ötk
(
KERN_INFO
 "use in-positonÑeplacing\n");

1052 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1053 
mpc_√w
 = 
	`phys_to_vút
(
mpc_√w_phys
);

1054 
	`mem˝y
(
mpc_√w
, 
mpc
, mpc->
Àngth
);

1055 
mpc
 = 
mpc_√w
;

1057 i‡(
mpc_√w_phys
 - 
mpf
->
phy•å
) {

1058 
mpf_öãl
 *
mpf_√w
;

1060 
	`¥ötk
(
KERN_INFO
 "mpfÇew: %x\n", 0x400 - 16);

1061 
mpf_√w
 = 
	`phys_to_vút
(0x400 - 16);

1062 
	`mem˝y
(
mpf_√w
, 
mpf
, 16);

1063 
mpf
 = 
mpf_√w
;

1064 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1066 
mpf
->
checksum
 = 0;

1067 
mpf
->
checksum
 -
	`mpf_checksum
((*)mpf, 16);

1068 
	`¥ötk
(
KERN_INFO
 "phy•åÇew: %x\n", 
mpf
->
phy•å
);

1077 
	`ª∂a˚_öt§c_Æl
(
mpc
, 
mpc_√w_phys
, 
mpc_√w_Àngth
);

1080 
	}
}

1082 
œã_öôˇŒ
(
upd©e_mp_èbÀ
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

24 
	~<löux/moduÀ.h
>

26 
	~<löux/ty≥s.h
>

27 
	~<löux/î∫o.h
>

28 
	~<löux/f˙é.h
>

29 
	~<löux/öô.h
>

30 
	~<löux/pﬁl.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/smp_lock.h
>

33 
	~<löux/maj‹.h
>

34 
	~<löux/fs.h
>

35 
	~<löux/devi˚.h
>

36 
	~<löux/˝u.h
>

37 
	~<löux/nŸifõr.h
>

38 
	~<löux/uac˚ss.h
>

40 
	~<asm/¥o˚ss‹.h
>

41 
	~<asm/m§.h
>

42 
	~<asm/sy°em.h
>

44 
˛ass
 *
	gm§_˛ass
;

46 
loff_t
 
	$m§_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

48 
loff_t
 
ªt
;

49 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

51 
	`muãx_lock
(&
öode
->
i_muãx
);

52 
‹ig
) {

54 
fûe
->
f_pos
 = 
off£t
;

55 
ªt
 = 
fûe
->
f_pos
;

58 
fûe
->
f_pos
 +
off£t
;

59 
ªt
 = 
fûe
->
f_pos
;

62 
ªt
 = -
EINVAL
;

64 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

65  
ªt
;

66 
	}
}

68 
ssize_t
 
	$m§_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

69 
size_t
 
cou¡
, 
loff_t
 *
µos
)

71 
u32
 
__u£r
 *
tmp
 = (u32 __u£∏*Ë
buf
;

72 
u32
 
d©a
[2];

73 
u32
 
ªg
 = *
µos
;

74 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

75 
îr
 = 0;

76 
ssize_t
 
byãs
 = 0;

78 i‡(
cou¡
 % 8)

79  -
EINVAL
;

81 ; 
cou¡
; count -= 8) {

82 
îr
 = 
	`rdm§_ß„_⁄_˝u
(
˝u
, 
ªg
, &
d©a
[0], &data[1]);

83 i‡(
îr
) {

84 i‡(
îr
 =-
EFAULT
)

85 
îr
 = -
EIO
;

88 i‡(
	`c›y_to_u£r
(
tmp
, &
d©a
, 8)) {

89 
îr
 = -
EFAULT
;

92 
tmp
 += 2;

93 
byãs
 += 8;

96  
byãs
 ? byã†: 
îr
;

97 
	}
}

99 
ssize_t
 
	$m§_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

100 
size_t
 
cou¡
, 
loff_t
 *
µos
)

102 c⁄° 
u32
 
__u£r
 *
tmp
 = (c⁄° u32 __u£∏*)
buf
;

103 
u32
 
d©a
[2];

104 
u32
 
ªg
 = *
µos
;

105 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

106 
îr
 = 0;

107 
ssize_t
 
byãs
 = 0;

109 i‡(
cou¡
 % 8)

110  -
EINVAL
;

112 ; 
cou¡
; count -= 8) {

113 i‡(
	`c›y_‰om_u£r
(&
d©a
, 
tmp
, 8)) {

114 
îr
 = -
EFAULT
;

117 
îr
 = 
	`wrm§_ß„_⁄_˝u
(
˝u
, 
ªg
, 
d©a
[0], data[1]);

118 i‡(
îr
) {

119 i‡(
îr
 =-
EFAULT
)

120 
îr
 = -
EIO
;

123 
tmp
 += 2;

124 
byãs
 += 8;

127  
byãs
 ? byã†: 
îr
;

128 
	}
}

130 
	$m§_›í
(
öode
 *öode, 
fûe
 *file)

132 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

133 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

134 
ªt
 = 0;

136 
	`lock_kî√l
();

137 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

139 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu)) {

140 
ªt
 = -
ENXIO
;

141 
out
;

143 
c
 = &
	`˝u_d©a
(
˝u
);

144 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MSR
))

145 
ªt
 = -
EIO
;

146 
out
:

147 
	`u∆ock_kî√l
();

148  
ªt
;

149 
	}
}

154 c⁄° 
fûe_›î©i⁄s
 
	gm§_f›s
 = {

155 .
ow√r
 = 
THIS_MODULE
,

156 .
	gŒ£ek
 = 
m§_£ek
,

157 .
	gªad
 = 
m§_ªad
,

158 .
	gwrôe
 = 
m§_wrôe
,

159 .
	g›í
 = 
m§_›í
,

162 
__˝uöô
 
	$m§_devi˚_¸óã
(
˝u
)

164 
devi˚
 *
dev
;

166 
dev
 = 
	`devi˚_¸óã
(
m§_˛ass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
), NULL,

167 "m§%d", 
˝u
);

168  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

169 
	}
}

171 
	$m§_devi˚_de°roy
(
˝u
)

173 
	`devi˚_de°roy
(
m§_˛ass
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
));

174 
	}
}

176 
__˝uöô
 
	$m§_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

177 
a˘i⁄
, *
h˝u
)

179 
˝u
 = ()
h˝u
;

180 
îr
 = 0;

182 
a˘i⁄
) {

183 
CPU_UP_PREPARE
:

184 
îr
 = 
	`m§_devi˚_¸óã
(
˝u
);

186 
CPU_UP_CANCELED
:

187 
CPU_UP_CANCELED_FROZEN
:

188 
CPU_DEAD
:

189 
	`m§_devi˚_de°roy
(
˝u
);

192  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

193 
	}
}

195 
nŸifõr_block
 
__ªfd©a
 
	gm§_˛ass_˝u_nŸifõr
 = {

196 .
nŸifõr_ˇŒ
 = 
m§_˛ass_˝u_ˇŒback
,

199 *
	$m§_nodíame
(
devi˚
 *
dev
)

201  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/m§", 
	`MINOR
(
dev
->
devt
));

202 
	}
}

204 
__öô
 
	$m§_öô
()

206 
i
, 
îr
 = 0;

207 
i
 = 0;

209 i‡(
	`ªgi°î_chrdev
(
MSR_MAJOR
, "˝u/m§", &
m§_f›s
)) {

210 
	`¥ötk
(
KERN_ERR
 "msr: unableÅo get major %d for msr\n",

211 
MSR_MAJOR
);

212 
îr
 = -
EBUSY
;

213 
out
;

215 
m§_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "msr");

216 i‡(
	`IS_ERR
(
m§_˛ass
)) {

217 
îr
 = 
	`PTR_ERR
(
m§_˛ass
);

218 
out_chrdev
;

220 
m§_˛ass
->
nodíame
 = 
m§_nodíame
;

221 
	`f‹_óch_⁄löe_˝u
(
i
) {

222 
îr
 = 
	`m§_devi˚_¸óã
(
i
);

223 i‡(
îr
 != 0)

224 
out_˛ass
;

226 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

228 
îr
 = 0;

229 
out
;

231 
out_˛ass
:

232 
i
 = 0;

233 
	`f‹_óch_⁄löe_˝u
(
i
)

234 
	`m§_devi˚_de°roy
(
i
);

235 
	`˛ass_de°roy
(
m§_˛ass
);

236 
out_chrdev
:

237 
	`uƒegi°î_chrdev
(
MSR_MAJOR
, "cpu/msr");

238 
out
:

239  
îr
;

240 
	}
}

242 
__exô
 
	$m§_exô
()

244 
˝u
 = 0;

245 
	`f‹_óch_⁄löe_˝u
(
˝u
)

246 
	`m§_devi˚_de°roy
(
˝u
);

247 
	`˛ass_de°roy
(
m§_˛ass
);

248 
	`uƒegi°î_chrdev
(
MSR_MAJOR
, "cpu/msr");

249 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

250 
	}
}

252 
moduÀ_öô
(
m§_öô
);

253 
	$moduÀ_exô
(
m§_exô
)

255 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

256 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

257 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<löux/kî√l.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/•ölock.h
>

31 
	~<löux/°rög.h
>

32 
	~<löux/¸ash_dump.h
>

33 
	~<löux/dma-m≠pög.h
>

34 
	~<löux/bô›s.h
>

35 
	~<löux/pci_ids.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/sˇâîli°.h
>

39 
	~<löux/iommu-hñ≥r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ˇlg¨y.h
>

43 
	~<asm/t˚.h
>

44 
	~<asm/pci-dúe˘.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

50 #ifde‡
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


51 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 1;

53 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 0;

56 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

57 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

60 
	#CALGARY_CONFIG_REG
 0x0108

	)

61 
	#PHB_CSR_OFFSET
 0x0110

	)

62 
	#PHB_PLSSR_OFFSET
 0x0120

	)

63 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

64 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

65 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

66 
	#PHB_MEM_1_LOW
 0x0190

	)

67 
	#PHB_MEM_1_HIGH
 0x01A0

	)

68 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

69 
	#PHB_MEM_1_SIZE
 0x01C0

	)

70 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

71 
	#PHB_AER_OFFSET
 0x0200

	)

72 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

73 
	#PHB_CONFIG_0_LOW
 0x0230

	)

74 
	#PHB_CONFIG_0_END
 0x0240

	)

75 
	#PHB_MEM_2_LOW
 0x02B0

	)

76 
	#PHB_MEM_2_HIGH
 0x02C0

	)

77 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

78 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

79 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

82 
	#PHB_SAVIOR_L2
 0x0DB0

	)

83 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

84 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

85 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

88 
	#PHB_TCE_ENABLE
 0x20000000

	)

89 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

90 
	#PHB_DAC_DISABLE
 0x01000000

	)

91 
	#PHB_MEM2_ENABLE
 0x00400000

	)

92 
	#PHB_MCSR_ENABLE
 0x00100000

	)

94 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

95 
	#TAR_VALID
 0x0000000000000008UL

	)

97 
	#CSR_AGENT_MASK
 0xf„0ffff

	)

99 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

101 
	#PMR_SOFTSTOP
 0x80000000

	)

102 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

103 
	#PMR_HARDSTOP
 0x20000000

	)

105 
	#MAX_NUM_OF_PHBS
 8

	)

106 
	#MAX_NUM_CHASSIS
 8

	)

108 
	#MAX_PHB_BUS_NUM
 (
MAX_NUM_OF_PHBS
 * 
MAX_NUM_CHASSIS
 * 2)

	)

109 
	#PHBS_PER_CALGARY
 4

	)

112 c⁄° 
	gèr_off£ts
[] = {

119 c⁄° 
	g•lô_queue_off£ts
[] = {

126 c⁄° 
	gphb_off£ts
[] = {

135 c⁄° 
	gphb_debug_off£ts
[] = {

147 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

149 
	#EMERGENCY_PAGES
 32

	)

151 
	g•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

152 
å™¶©e_em±y_¶Ÿs
 
	g__ªad_mo°ly
 = 0;

153 
ˇlg¨y_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

155 
rio_èbÀ_hdr
 *rio_èbÀ_hd∏
	g__öôd©a
;

156 
sˇl_dëaû
 *
	gsˇl_devs
[
MAX_NUMNODES
] 
	g__öôd©a
;

157 
rio_dëaû
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__öôd©a
;

159 
	sˇlg¨y_bus_öfo
 {

160 *
	mt˚_•a˚
;

161 
	må™¶©i⁄_dißbÀd
;

162 sig√d 
	mphbid
;

163 
__iomem
 *
	mbb¨
;

166 
ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

167 
ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

168 
ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

169 
ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

170 
ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

171 
ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

172 
ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
);

173 
gë_t˚_•a˚_‰om_èr
();

175 
ˇl_chù£t_›s
 
	gˇlg¨y_chù_›s
 = {

176 .
h™dÀ_quúks
 = 
ˇlg¨y_h™dÀ_quúks
,

177 .
	gt˚_ˇche_bœ°
 = 
ˇlg¨y_t˚_ˇche_bœ°
,

178 .
	gdump_îr‹_ªgs
 = 
ˇlg¨y_dump_îr‹_ªgs


181 
ˇl_chù£t_›s
 
	gˇlioc2_chù_›s
 = {

182 .
h™dÀ_quúks
 = 
ˇlioc2_h™dÀ_quúks
,

183 .
	gt˚_ˇche_bœ°
 = 
ˇlioc2_t˚_ˇche_bœ°
,

184 .
	gdump_îr‹_ªgs
 = 
ˇlioc2_dump_îr‹_ªgs


187 
ˇlg¨y_bus_öfo
 
	gbus_öfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

189 
ölöe
 
	$å™¶©i⁄_íabÀd
(
iommu_èbÀ
 *
tbl
)

192  (
tbl
 !
NULL
);

193 
	}
}

195 
	$iommu_ønge_ª£rve
(
iommu_èbÀ
 *
tbl
,

196 
°¨t_addr
, 
≈ages
)

198 
ödex
;

199 
íd
;

200 
Êags
;

202 
ödex
 = 
°¨t_addr
 >> 
PAGE_SHIFT
;

205 i‡(
ödex
 >
tbl
->
ô_size
)

208 
íd
 = 
ödex
 + 
≈ages
;

209 i‡(
íd
 > 
tbl
->
ô_size
)

210 
íd
 = 
tbl
->
ô_size
;

212 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

214 
	`iommu_¨ó_ª£rve
(
tbl
->
ô_m≠
, 
ödex
, 
≈ages
);

216 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

217 
	}
}

219 
	$iommu_ønge_Æloc
(
devi˚
 *
dev
,

220 
iommu_èbÀ
 *
tbl
,

221 
≈ages
)

223 
Êags
;

224 
off£t
;

225 
bound¨y_size
;

227 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

228 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

230 
	`BUG_ON
(
≈ages
 == 0);

232 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

234 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
,Åbl->
ô_höt
,

235 
≈ages
, 0, 
bound¨y_size
, 0);

236 i‡(
off£t
 == ~0UL) {

237 
tbl
->
chù_›s
->
	`t˚_ˇche_bœ°
(tbl);

239 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
, 0,

240 
≈ages
, 0, 
bound¨y_size
, 0);

241 i‡(
off£t
 == ~0UL) {

242 
	`¥ötk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

243 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

244 i‡(
∑nic_⁄_ovîÊow
)

245 
	`∑nic
("Calgary: fixÅheállocator.\n");

247  
bad_dma_addªss
;

251 
tbl
->
ô_höt
 = 
off£t
 + 
≈ages
;

252 
	`BUG_ON
(
tbl
->
ô_höt
 >Åbl->
ô_size
);

254 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

256  
off£t
;

257 
	}
}

259 
dma_addr_t
 
	$iommu_Æloc
(
devi˚
 *
dev
, 
iommu_èbÀ
 *
tbl
,

260 *
vaddr
, 
≈ages
, 
dúe˘i⁄
)

262 
íåy
;

263 
dma_addr_t
 
ªt
 = 
bad_dma_addªss
;

265 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

267 i‡(
	`u∆ikñy
(
íåy
 =
bad_dma_addªss
))

268 
îr‹
;

271 
ªt
 = (
íåy
 << 
PAGE_SHIFT
Ë| (()
vaddr
 & ~
PAGE_MASK
);

274 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, ()
vaddr
 & 
PAGE_MASK
,

275 
dúe˘i⁄
);

277  
ªt
;

279 
îr‹
:

280 
	`¥ötk
(
KERN_WARNING
 "Calgary: failedÅoállocate %uÖages in "

281 "iommu %p\n", 
≈ages
, 
tbl
);

282  
bad_dma_addªss
;

283 
	}
}

285 
	$iommu_‰ì
(
iommu_èbÀ
 *
tbl
, 
dma_addr_t
 
dma_addr
,

286 
≈ages
)

288 
íåy
;

289 
badíd
;

290 
Êags
;

293 
badíd
 = 
bad_dma_addªss
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

294 i‡(
	`u∆ikñy
((
dma_addr
 >
bad_dma_addªss
Ë&& (dma_add∏< 
badíd
))) {

295 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverÅried unmapping bad DMA "

296 "addªs†0x%Lx\n", 
dma_addr
);

300 
íåy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

302 
	`BUG_ON
(
íåy
 + 
≈ages
 > 
tbl
->
ô_size
);

304 
	`t˚_‰ì
(
tbl
, 
íåy
, 
≈ages
);

306 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

308 
	`iommu_¨ó_‰ì
(
tbl
->
ô_m≠
, 
íåy
, 
≈ages
);

310 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

311 
	}
}

313 
ölöe
 
iommu_èbÀ
 *
	$föd_iommu_èbÀ
(
devi˚
 *
dev
)

315 
pci_dev
 *
pdev
;

316 
pci_bus
 *
pbus
;

317 
iommu_èbÀ
 *
tbl
;

319 
pdev
 = 
	`to_pci_dev
(
dev
);

321 
pbus
 = 
pdev
->
bus
;

324 
pbus
->
∑ª¡
)

325 
pbus
 =Öbus->
∑ª¡
;

327 
tbl
 = 
	`pci_iommu
(
pbus
);

329 
	`BUG_ON
(
tbl
 && (tbl->
ô_bu¢o
 !
pbus
->
numbî
));

331  
tbl
;

332 
	}
}

334 
	$ˇlg¨y_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

335 
√Àms
,
dma_d©a_dúe˘i⁄
 
dú
,

336 
dma_©ås
 *
©ås
)

338 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

339 
sˇâîli°
 *
s
;

340 
i
;

342 i‡(!
	`å™¶©i⁄_íabÀd
(
tbl
))

345 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

346 
≈ages
;

347 
dma_addr_t
 
dma
 = 
s
->
dma_addªss
;

348 
dmÆí
 = 
s
->
dma_Àngth
;

350 i‡(
dmÆí
 == 0)

353 
≈ages
 = 
	`iommu_num_∑ges
(
dma
, 
dmÆí
, 
PAGE_SIZE
);

354 
	`iommu_‰ì
(
tbl
, 
dma
, 
≈ages
);

356 
	}
}

358 
	$ˇlg¨y_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

359 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

360 
dma_©ås
 *
©ås
)

362 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

363 
sˇâîli°
 *
s
;

364 
vaddr
;

365 
≈ages
;

366 
íåy
;

367 
i
;

369 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

370 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

372 
vaddr
 = (Ë
	`sg_vút
(
s
);

373 
≈ages
 = 
	`iommu_num_∑ges
(
vaddr
, 
s
->
Àngth
, 
PAGE_SIZE
);

375 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

376 i‡(
íåy
 =
bad_dma_addªss
) {

378 
s
->
dma_Àngth
 = 0;

379 
îr‹
;

382 
s
->
dma_addªss
 = (
íåy
 << 
PAGE_SHIFT
Ë| s->
off£t
;

385 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, 
vaddr
 & 
PAGE_MASK
, 
dú
);

387 
s
->
dma_Àngth
 = s->
Àngth
;

390  
√Àms
;

391 
îr‹
:

392 
	`ˇlg¨y_unm≠_sg
(
dev
, 
sg
, 
√Àms
, 
dú
, 
NULL
);

393 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

394 
sg
->
dma_addªss
 = 
bad_dma_addªss
;

395 
sg
->
dma_Àngth
 = 0;

398 
	}
}

400 
dma_addr_t
 
	$ˇlg¨y_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

401 
off£t
, 
size_t
 
size
,

402 
dma_d©a_dúe˘i⁄
 
dú
,

403 
dma_©ås
 *
©ås
)

405 *
vaddr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

406 
uaddr
;

407 
≈ages
;

408 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

410 
uaddr
 = ()
vaddr
;

411 
≈ages
 = 
	`iommu_num_∑ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

413  
	`iommu_Æloc
(
dev
, 
tbl
, 
vaddr
, 
≈ages
, 
dú
);

414 
	}
}

416 
	$ˇlg¨y_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

417 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

418 
dma_©ås
 *
©ås
)

420 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

421 
≈ages
;

423 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

424 
	`iommu_‰ì
(
tbl
, 
dma_addr
, 
≈ages
);

425 
	}
}

427 * 
	$ˇlg¨y_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

428 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êag
)

430 *
ªt
 = 
NULL
;

431 
dma_addr_t
 
m≠pög
;

432 
≈ages
, 
‹dî
;

433 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

435 
size
 = 
	`PAGE_ALIGN
(size);

436 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

437 
‹dî
 = 
	`gë_‹dî
(
size
);

439 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

442 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
‹dî
);

443 i‡(!
ªt
)

444 
îr‹
;

445 
	`mem£t
(
ªt
, 0, 
size
);

448 
m≠pög
 = 
	`iommu_Æloc
(
dev
, 
tbl
, 
ªt
, 
≈ages
, 
DMA_BIDIRECTIONAL
);

449 i‡(
m≠pög
 =
bad_dma_addªss
)

450 
‰ì
;

451 *
dma_h™dÀ
 = 
m≠pög
;

452  
ªt
;

453 
‰ì
:

454 
	`‰ì_∑ges
(()
ªt
, 
	`gë_‹dî
(
size
));

455 
ªt
 = 
NULL
;

456 
îr‹
:

457  
ªt
;

458 
	}
}

460 
	$ˇlg¨y_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

461 *
vaddr
, 
dma_addr_t
 
dma_h™dÀ
)

463 
≈ages
;

464 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

466 
size
 = 
	`PAGE_ALIGN
(size);

467 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

469 
	`iommu_‰ì
(
tbl
, 
dma_h™dÀ
, 
≈ages
);

470 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

471 
	}
}

473 
dma_m≠_›s
 
	gˇlg¨y_dma_›s
 = {

474 .
Æloc_cohîít
 = 
ˇlg¨y_Æloc_cohîít
,

475 .
	g‰ì_cohîít
 = 
ˇlg¨y_‰ì_cohîít
,

476 .
	gm≠_sg
 = 
ˇlg¨y_m≠_sg
,

477 .
	gunm≠_sg
 = 
ˇlg¨y_unm≠_sg
,

478 .
	gm≠_∑ge
 = 
ˇlg¨y_m≠_∑ge
,

479 .
	gunm≠_∑ge
 = 
ˇlg¨y_unm≠_∑ge
,

482 
ölöe
 
__iomem
 * 
	$bu¢o_to_bb¨
(
num
)

484  
bus_öfo
[
num
].
bb¨
;

485 
	}
}

487 
ölöe
 
	$bu¢o_to_phbid
(
num
)

489  
bus_öfo
[
num
].
phbid
;

490 
	}
}

492 
ölöe
 
	$•lô_queue_off£t
(
num
)

494 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

496  
•lô_queue_off£ts
[
idx
];

497 
	}
}

499 
ölöe
 
	$èr_off£t
(
num
)

501 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

503  
èr_off£ts
[
idx
];

504 
	}
}

506 
ölöe
 
	$phb_off£t
(
num
)

508 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

510  
phb_off£ts
[
idx
];

511 
	}
}

513 
ölöe
 
__iomem
* 
	$ˇlg¨y_ªg
(
__iomem
 *
b¨
, 
off£t
)

515 
èrgë
 = (()
b¨
Ë| 
off£t
;

516  (
__iomem
*)
èrgë
;

517 
	}
}

519 
ölöe
 
	$is_ˇlioc2
(
devi˚
)

521  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALIOC2
);

522 
	}
}

524 
ölöe
 
	$is_ˇlg¨y
(
devi˚
)

526  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
);

527 
	}
}

529 
ölöe
 
	$is_ˇl_pci_dev
(
devi˚
)

531  (
	`is_ˇlg¨y
(
devi˚
Ë|| 
	`is_ˇlioc2
(device));

532 
	}
}

534 
	$ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

536 
u64
 
vÆ
;

537 
u32
 
´r
;

538 
i
 = 0;

539 
__iomem
 *
bb¨
 = 
tbl
->bbar;

540 
__iomem
 *
èrgë
;

543 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

544 
´r
 = 
	`ªadl
(
èrgë
);

545 
	`wrôñ
(0, 
èrgë
);

548 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

549 
vÆ
 = 
	`ªadl
(
èrgë
);

552 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
tbl
->
ô_bu¢o
));

554 
vÆ
 = 
	`ªadq
(
èrgë
);

555 
i
++;

556 } (
vÆ
 & 0xffË!0xf‡&& 
i
 < 100);

557 i‡(
i
 == 100)

558 
	`¥ötk
(
KERN_WARNING
 "Calgary: PCI busÇot quiesced, "

562 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
tbl
->
ô_bu¢o
));

563 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

566 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

567 
	`wrôñ
(
´r
, 
èrgë
);

568 ()
	`ªadl
(
èrgë
);

569 
	}
}

571 
	$ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

573 
__iomem
 *
bb¨
 = 
tbl
->bbar;

574 
__iomem
 *
èrgë
;

575 
u64
 
vÆ64
;

576 
u32
 
vÆ
;

577 
i
 = 0;

578 
cou¡
 = 1;

579 
bus
 = 
tbl
->
ô_bu¢o
;

581 
begö
:

582 
	`¥ötk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xÉnteringÅce cache blast "

583 "£quí˚ - cou¡ %d\n", 
bus
, 
cou¡
);

586 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

587 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

588 
	`¥ötk
(
KERN_DEBUG
 "1a.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

589 
vÆ
 |
PMR_SOFTSTOP
;

590 
	`¥ötk
(
KERN_DEBUG
 "1b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

591 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

594 
	`¥ötk
(
KERN_DEBUG
 "2a. startingÅoÖoll split queues\n");

595 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
bus
));

597 
vÆ64
 = 
	`ªadq
(
èrgë
);

598 
i
++;

599 } (
vÆ64
 & 0xffË!0xf‡&& 
i
 < 100);

600 i‡(
i
 == 100)

601 
	`¥ötk
(
KERN_WARNING
 "CalIOC2: PCI busÇot quiesced, "

605 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

606 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

607 
	`¥ötk
(
KERN_DEBUG
 "3.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

610 i‡(
vÆ
 & 
PMR_SOFTSTOPFAULT
) {

611 i‡(++
cou¡
 < 100)

612 
begö
;

614 
	`¥ötk
(
KERN_WARNING
 "CalIOC2:Åoo many SoftStopFaults, "

621 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

622 
	`¥ötk
(
KERN_DEBUG
 "5a. sœmmög i¡ÿH¨dSt› byÑódög %p\n", 
èrgë
);

623 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

624 
	`¥ötk
(
KERN_DEBUG
 "5b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

625 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

626 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

627 
	`¥ötk
(
KERN_DEBUG
 "5c.Ñód 0x%x [LE] from %∞(debug)\n", 
vÆ
, 
èrgë
);

630 
	`¥ötk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

631 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
bus
));

632 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

635 
	`¥ötk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

636 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

637 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

638 
	`¥ötk
(
KERN_DEBUG
 "7b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

641 
	`¥ötk
(
KERN_DEBUG
 "8a.Ñemoving HardStop from PMCR\n");

642 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

643 
vÆ
 = 0;

644 
	`¥ötk
(
KERN_DEBUG
 "8b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

645 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

646 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

647 
	`¥ötk
(
KERN_DEBUG
 "8c.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

648 
	}
}

650 
__öô
 
	$ˇlg¨y_ª£rve_mem_ªgi⁄
(
pci_dev
 *
dev
, 
u64
 
°¨t
,

651 
u64
 
limô
)

653 
num∑ges
;

655 
limô
 =Üimit | 0xfffff;

656 
limô
++;

658 
num∑ges
 = ((
limô
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

659 
	`iommu_ønge_ª£rve
(
	`pci_iommu
(
dev
->
bus
), 
°¨t
, 
num∑ges
);

660 
	}
}

662 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
pci_dev
 *
dev
)

664 
__iomem
 *
èrgë
;

665 
u64
 
low
, 
high
, 
sizñow
;

666 
u64
 
°¨t
, 
limô
;

667 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

668 
bu¢um
 = 
dev
->
bus
->
numbî
;

669 
__iomem
 *
bb¨
 = 
tbl
->bbar;

672 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_LOW
);

673 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

674 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_HIGH
);

675 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

676 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_SIZE
);

677 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

679 
°¨t
 = (
high
 << 32Ë| 
low
;

680 
limô
 = 
sizñow
;

682 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

683 
	}
}

685 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
pci_dev
 *
dev
)

687 
__iomem
 *
èrgë
;

688 
u32
 
vÆ32
;

689 
u64
 
low
, 
high
, 
sizñow
, 
sizehigh
;

690 
u64
 
°¨t
, 
limô
;

691 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

692 
bu¢um
 = 
dev
->
bus
->
numbî
;

693 
__iomem
 *
bb¨
 = 
tbl
->bbar;

696 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

697 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

698 i‡(!(
vÆ32
 & 
PHB_MEM2_ENABLE
))

701 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_LOW
);

702 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

703 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_HIGH
);

704 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

705 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_LOW
);

706 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

707 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_HIGH
);

708 
sizehigh
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

710 
°¨t
 = (
high
 << 32Ë| 
low
;

711 
limô
 = (
sizehigh
 << 32Ë| 
sizñow
;

713 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

714 
	}
}

723 
__öô
 
	$ˇlg¨y_ª£rve_ªgi⁄s
(
pci_dev
 *
dev
)

725 
≈ages
;

726 
u64
 
°¨t
;

727 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

730 
	`iommu_ønge_ª£rve
(
tbl
, 
bad_dma_addªss
, 
EMERGENCY_PAGES
);

734 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
)) {

735 
°¨t
 = (640 * 1024);

736 
≈ages
 = ((1024 - 640Ë* 1024Ë>> 
PAGE_SHIFT
;

738 
°¨t
 = 0;

739 
≈ages
 = (1 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

741 
	`iommu_ønge_ª£rve
(
tbl
, 
°¨t
, 
≈ages
);

744 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
dev
);

745 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
dev
);

746 
	}
}

748 
__öô
 
	$ˇlg¨y_£tup_èr
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

750 
u64
 
vÆ64
;

751 
u64
 
èbÀ_phys
;

752 
__iomem
 *
èrgë
;

753 
ªt
;

754 
iommu_èbÀ
 *
tbl
;

757 
ªt
 = 
	`buûd_t˚_èbÀ
(
dev
, 
bb¨
);

758 i‡(
ªt
)

759  
ªt
;

761 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

762 
tbl
->
ô_ba£
 = ()
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
;

764 i‡(
	`is_kdump_kî√l
())

765 
	`ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
tbl
);

767 
	`t˚_‰ì
(
tbl
, 0,Åbl->
ô_size
);

769 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
))

770 
tbl
->
chù_›s
 = &
ˇlg¨y_chù_›s
;

771 i‡(
	`is_ˇlioc2
(
dev
->
devi˚
))

772 
tbl
->
chù_›s
 = &
ˇlioc2_chù_›s
;

774 
	`BUG
();

776 
	`ˇlg¨y_ª£rve_ªgi⁄s
(
dev
);

779 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

780 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

783 
vÆ64
 &~
TAR_SW_BITS
;

784 
èbÀ_phys
 = (
u64
)
	`__∑
(
tbl
->
ô_ba£
);

786 
vÆ64
 |
èbÀ_phys
;

788 
	`BUG_ON
(
•ecifõd_èbÀ_size
 > 
TCE_TABLE_SIZE_8M
);

789 
vÆ64
 |(
u64
Ë
•ecifõd_èbÀ_size
;

791 
tbl
->
èr_vÆ
 = 
	`˝u_to_be64
(
vÆ64
);

793 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

794 
	`ªadq
(
èrgë
);

797 
	}
}

799 
__öô
 
	$ˇlg¨y_‰ì_bus
(
pci_dev
 *
dev
)

801 
u64
 
vÆ64
;

802 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

803 
__iomem
 *
èrgë
;

804 
bôm≠sz
;

806 
èrgë
 = 
	`ˇlg¨y_ªg
(
tbl
->
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

807 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

808 
vÆ64
 &~
TAR_SW_BITS
;

809 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

810 
	`ªadq
(
èrgë
);

812 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

813 
	`‰ì_∑ges
(()
tbl
->
ô_m≠
, 
	`gë_‹dî
(
bôm≠sz
));

814 
tbl
->
ô_m≠
 = 
NULL
;

816 
	`k‰ì
(
tbl
);

818 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

821 
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
 = 
NULL
;

822 
	}
}

824 
	$ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

826 
__iomem
 *
bb¨
 = 
tbl
->bbar;

827 
__iomem
 *
èrgë
;

828 
u32
 
c§
, 
∂s§
;

830 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

831 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

833 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

834 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

837 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on Calgary PHB 0x%x, "

838 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
ô_bu¢o
, 
c§
, 
∂s§
);

839 
	}
}

841 
	$ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

843 
__iomem
 *
bb¨
 = 
tbl
->bbar;

844 
u32
 
c§
, 
csmr
, 
∂s§
, 
mck
, 
rc°©
;

845 
__iomem
 *
èrgë
;

846 
phboff
 = 
	`phb_off£t
(
tbl
->
ô_bu¢o
);

847 
îroff
;

848 
u32
 
îºegs
[7];

849 
i
;

852 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_CSR_OFFSET
);

853 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

855 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

856 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

858 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x290);

859 
csmr
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

861 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x800);

862 
mck
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

864 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on CalIOC2 PHB 0x%x\n",

865 
tbl
->
ô_bu¢o
);

867 
	`¥ötk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

868 
c§
, 
∂s§
, 
csmr
, 
mck
);

871 
	`¥ötk
(
KERN_EMERG
 "Calgary: ");

872 
i
 = 0; i < 
	`ARRAY_SIZE
(
îºegs
); i++) {

874 
îroff
 = (0x810 + (
i
 * 0x10));

875 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
îroff
);

876 
îºegs
[
i
] = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

877 
	`¥ötk
("0x%08x@0x%lx ", 
îºegs
[
i
], 
îroff
);

879 
	`¥ötk
("\n");

882 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

883 
rc°©
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

884 
	`¥ötk
(
KERN_EMERG
 "CÆg¨y: 0x%08x@0x%x\n", 
rc°©
,

885 
PHB_ROOT_COMPLEX_STATUS
);

886 
	}
}

888 
	$ˇlg¨y_w©chdog
(
d©a
)

890 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

891 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

892 
__iomem
 *
bb¨
 = 
tbl
->bbar;

893 
u32
 
vÆ32
;

894 
__iomem
 *
èrgë
;

896 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

897 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

900 i‡(
vÆ32
 & 
CSR_AGENT_MASK
) {

901 
tbl
->
chù_›s
->
	`dump_îr‹_ªgs
(tbl);

904 
	`wrôñ
(0, 
èrgë
);

907 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
) |

908 
PHB_CONFIG_RW_OFFSET
);

909 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

910 
vÆ32
 |
PHB_SLOT_DISABLE
;

911 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

912 
	`ªadl
(
èrgë
);

915 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
 + 2 * 
HZ
);

917 
	}
}

919 
__öô
 
	$ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
__iomem
 *
bb¨
,

920 
bu¢um
, 
timeout
)

922 
u64
 
vÆ64
;

923 
__iomem
 *
èrgë
;

924 
phb_shi·
 = ~0;

925 
u64
 
mask
;

927 
	`bu¢o_to_phbid
(
bu¢um
)) {

928 0: 
phb_shi·
 = (63 - 19);

930 1: 
phb_shi·
 = (63 - 23);

932 2: 
phb_shi·
 = (63 - 27);

934 3: 
phb_shi·
 = (63 - 35);

937 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

940 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
CALGARY_CONFIG_REG
);

941 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

944 
mask
 = ~(0xFUL << 
phb_shi·
);

945 
vÆ64
 &
mask
;

946 
vÆ64
 |(
timeout
 << 
phb_shi·
);

947 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

948 
	`ªadq
(
èrgë
);

949 
	}
}

951 
__öô
 
	$ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

953 
bu¢um
 = 
dev
->
bus
->
numbî
;

954 
__iomem
 *
bb¨
 = 
tbl
->bbar;

955 
__iomem
 *
èrgë
;

956 
u32
 
vÆ
;

961 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_SAVIOR_L2
);

962 
vÆ
 = 
	`˝u_to_be32
(
	`ªadl
(
èrgë
));

963 
vÆ
 |= 0x00800000;

964 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

965 
	}
}

967 
__öô
 
	$ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

969 
bu¢um
 = 
dev
->
bus
->
numbî
;

975 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
Ë&& (
bu¢um
 == 1))

976 
	`ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
tbl
->
bb¨
, 
bu¢um
,

977 
CCR_2SEC_TIMEOUT
);

978 
	}
}

980 
__öô
 
	$ˇlg¨y_íabÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

982 
u32
 
vÆ32
;

983 
bu¢um
;

984 
__iomem
 *
èrgë
;

985 
__iomem
 *
bb¨
;

986 
iommu_èbÀ
 *
tbl
;

988 
bu¢um
 = 
dev
->
bus
->
numbî
;

989 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

990 
bb¨
 = 
tbl
->bbar;

993 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

994 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

995 
vÆ32
 |
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

997 
	`¥ötk
(
KERN_INFO
 "Calgary:ÉnablingÅranslation on %s PHB %#x\n",

998 (
dev
->
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
) ?

999 "CÆg¨y" : "CÆIOC2", 
bu¢um
);

1000 
	`¥ötk
(
KERN_INFO
 "Calgary:Érrant DMAs willÇow beÖrevented onÅhis "

1003 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1004 
	`ªadl
(
èrgë
);

1006 
	`öô_timî
(&
tbl
->
w©chdog_timî
);

1007 
tbl
->
w©chdog_timî
.
fun˘i⁄
 = &
ˇlg¨y_w©chdog
;

1008 
tbl
->
w©chdog_timî
.
d©a
 = ()
dev
;

1009 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
);

1010 
	}
}

1012 
__öô
 
	$ˇlg¨y_dißbÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

1014 
u32
 
vÆ32
;

1015 
bu¢um
;

1016 
__iomem
 *
èrgë
;

1017 
__iomem
 *
bb¨
;

1018 
iommu_èbÀ
 *
tbl
;

1020 
bu¢um
 = 
dev
->
bus
->
numbî
;

1021 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1022 
bb¨
 = 
tbl
->bbar;

1025 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

1026 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1027 
vÆ32
 &~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1029 
	`¥ötk
(
KERN_INFO
 "CÆg¨y: dißblögÅøn¶©i⁄ o¿PHB %#x!\n", 
bu¢um
);

1030 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1031 
	`ªadl
(
èrgë
);

1033 
	`dñ_timî_sync
(&
tbl
->
w©chdog_timî
);

1034 
	}
}

1036 
__öô
 
	$ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
pci_dev
 *
dev
)

1038 
	`pci_dev_gë
(
dev
);

1039 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1042 i‡(
dev
->
bus
->
∑ª¡
)

1043 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1045 
dev
->
bus
->
£lf
 = dev;

1046 
	}
}

1048 
__öô
 
	$ˇlg¨y_öô_⁄e
(
pci_dev
 *
dev
)

1050 
__iomem
 *
bb¨
;

1051 
iommu_èbÀ
 *
tbl
;

1052 
ªt
;

1054 
	`BUG_ON
(
dev
->
bus
->
numbî
 >
MAX_PHB_BUS_NUM
);

1056 
bb¨
 = 
	`bu¢o_to_bb¨
(
dev
->
bus
->
numbî
);

1057 
ªt
 = 
	`ˇlg¨y_£tup_èr
(
dev
, 
bb¨
);

1058 i‡(
ªt
)

1059 
d⁄e
;

1061 
	`pci_dev_gë
(
dev
);

1063 i‡(
dev
->
bus
->
∑ª¡
) {

1064 i‡(
dev
->
bus
->
∑ª¡
->
£lf
)

1065 
	`¥ötk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1066 "bus->∑ª¡->£lf!\n", 
dev
);

1067 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1069 
dev
->
bus
->
£lf
 = dev;

1071 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1072 
tbl
->
chù_›s
->
	`h™dÀ_quúks
—bl, 
dev
);

1074 
	`ˇlg¨y_íabÀ_å™¶©i⁄
(
dev
);

1078 
d⁄e
:

1079  
ªt
;

1080 
	}
}

1082 
__öô
 
	$ˇlg¨y_loˇã_bb¨s
()

1084 
ªt
;

1085 
rioidx
, 
phb
, 
bus
;

1086 
__iomem
 *
bb¨
;

1087 
__iomem
 *
èrgë
;

1088 
off£t
;

1089 
u8
 
°¨t_bus
, 
íd_bus
;

1090 
u32
 
vÆ
;

1092 
ªt
 = -
ENODATA
;

1093 
rioidx
 = 0;Ñioidx < 
rio_èbÀ_hdr
->
num_rio_dev
;Ñioidx++) {

1094 
rio_dëaû
 *
rio
 = 
rio_devs
[
rioidx
];

1096 i‡((
rio
->
ty≥
 !
COMPAT_CALGARY
Ë&& (rio->ty≥ !
ALT_CALGARY
))

1100 
bb¨
 = 
	`i‹em≠_noˇche
(
rio
->
BBAR
, 1024 * 1024);

1101 i‡(!
bb¨
)

1102 
îr‹
;

1104 
phb
 = 0;Öhb < 
PHBS_PER_CALGARY
;Öhb++) {

1105 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1106 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
off£t
);

1108 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1110 
°¨t_bus
 = (
u8
)((
vÆ
 & 0x00FF0000) >> 16);

1111 
íd_bus
 = (
u8
)((
vÆ
 & 0x0000FF00) >> 8);

1113 i‡(
íd_bus
) {

1114 
bus
 = 
°¨t_bus
; bu†<
íd_bus
; bus++) {

1115 
bus_öfo
[
bus
].
bb¨
 = bbar;

1116 
bus_öfo
[
bus
].
phbid
 = 
phb
;

1119 
bus_öfo
[
°¨t_bus
].
bb¨
 = bbar;

1120 
bus_öfo
[
°¨t_bus
].
phbid
 = 
phb
;

1127 
îr‹
:

1129 
bus
 = 0; bu†< 
	`ARRAY_SIZE
(
bus_öfo
); bus++)

1130 i‡(
bus_öfo
[
bus
].
bb¨
)

1131 
	`iounm≠
(
bus_öfo
[
bus
].
bb¨
);

1133  
ªt
;

1134 
	}
}

1136 
__öô
 
	$ˇlg¨y_öô
()

1138 
ªt
;

1139 
pci_dev
 *
dev
 = 
NULL
;

1140 
ˇlg¨y_bus_öfo
 *
öfo
;

1142 
ªt
 = 
	`ˇlg¨y_loˇã_bb¨s
();

1143 i‡(
ªt
)

1144  
ªt
;

1147 i‡(
	`is_kdump_kî√l
())

1148 
	`gë_t˚_•a˚_‰om_èr
();

1151 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1152 i‡(!
dev
)

1154 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1157 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1158 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1159 
	`ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
dev
);

1163 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1166 
ªt
 = 
	`ˇlg¨y_öô_⁄e
(
dev
);

1167 i‡(
ªt
)

1168 
îr‹
;

1171 
dev
 = 
NULL
;

1172 
	`f‹_óch_pci_dev
(
dev
) {

1173 
iommu_èbÀ
 *
tbl
;

1175 
tbl
 = 
	`föd_iommu_èbÀ
(&
dev
->dev);

1177 i‡(
	`å™¶©i⁄_íabÀd
(
tbl
))

1178 
dev
->dev.
¨chd©a
.
dma_›s
 = &
ˇlg¨y_dma_›s
;

1181  
ªt
;

1183 
îr‹
:

1185 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1186 i‡(!
dev
)

1188 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1191 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1192 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1193 
	`pci_dev_put
(
dev
);

1196 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1199 
	`ˇlg¨y_dißbÀ_å™¶©i⁄
(
dev
);

1200 
	`ˇlg¨y_‰ì_bus
(
dev
);

1201 
	`pci_dev_put
(
dev
);

1202 
dev
->dev.
¨chd©a
.
dma_›s
 = 
NULL
;

1205  
ªt
;

1206 
	}
}

1208 
ölöe
 
__öô
 
	$dëîmöe_t˚_èbÀ_size
(
u64
 
øm
)

1210 
ªt
;

1212 i‡(
•ecifõd_èbÀ_size
 !
TCE_TABLE_SIZE_UNSPECIFIED
)

1213  
•ecifõd_èbÀ_size
;

1222 
ªt
 = 
	`gë_‹dî
(
øm
 >> 13);

1223 i‡(
ªt
 > 
TCE_TABLE_SIZE_8M
)

1224 
ªt
 = 
TCE_TABLE_SIZE_8M
;

1226  
ªt
;

1227 
	}
}

1229 
__öô
 
	$buûd_dëaû_¨øys
()

1231 
±r
;

1232 
numnodes
, 
i
;

1233 
sˇl_dëaû_size
, 
rio_dëaû_size
;

1235 
numnodes
 = 
rio_èbÀ_hdr
->
num_sˇl_dev
;

1236 i‡(
numnodes
 > 
MAX_NUMNODES
){

1237 
	`¥ötk
(
KERN_WARNING


1240 
MAX_NUMNODES
, 
numnodes
);

1241  -
ENODEV
;

1244 
rio_èbÀ_hdr
->
vîsi⁄
){

1246 
sˇl_dëaû_size
 = 11;

1247 
rio_dëaû_size
 = 13;

1250 
sˇl_dëaû_size
 = 12;

1251 
rio_dëaû_size
 = 15;

1254 
	`¥ötk
(
KERN_WARNING


1256 
rio_èbÀ_hdr
->
vîsi⁄
);

1257  -
EPROTO
;

1260 
±r
 = (()
rio_èbÀ_hdr
) + 3;

1261 
i
 = 0; i < 
numnodes
; i++, 
±r
 +
sˇl_dëaû_size
)

1262 
sˇl_devs
[
i
] = (
sˇl_dëaû
 *)
±r
;

1264 
i
 = 0; i < 
rio_èbÀ_hdr
->
num_rio_dev
;

1265 
i
++, 
±r
 +
rio_dëaû_size
)

1266 
rio_devs
[
i
] = (
rio_dëaû
 *)
±r
;

1269 
	}
}

1271 
__öô
 
	$ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_dev
)

1273 
dev
;

1274 
u32
 
vÆ
;

1276 i‡(
pci_dev
 =
PCI_DEVICE_ID_IBM_CALIOC2
) {

1284 
dev
 = 1; dev < 8; dev++) {

1285 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 0, 0);

1286 i‡(
vÆ
 != 0xffffffff)

1289  (
vÆ
 != 0xffffffff);

1290 
	}
}

1297 
	$ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
)

1299 
u64
 *
ç
;

1300 
ödex
;

1301 
ç
 = ((
u64
 *)
tbl
->
ô_ba£
);

1302 
ödex
 = 0 ; index < 
tbl
->
ô_size
; index++) {

1303 i‡(*
ç
 != 0x0)

1304 
	`£t_bô
(
ödex
, 
tbl
->
ô_m≠
);

1305 
ç
++;

1307 
	}
}

1314 
__öô
 
	$gë_t˚_•a˚_‰om_èr
()

1316 
bus
;

1317 
__iomem
 *
èrgë
;

1318 
t˚_•a˚
;

1320 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1321 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1322 
pci_devi˚
;

1323 
u32
 
vÆ
;

1325 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1326 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1328 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1330 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1333 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1334 
å™¶©e_em±y_¶Ÿs
) {

1335 
èrgë
 = 
	`ˇlg¨y_ªg
(
bus_öfo
[
bus
].
bb¨
,

1336 
	`èr_off£t
(
bus
));

1337 
t˚_•a˚
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

1338 
t˚_•a˚
 =Å˚_•a˚ & 
TAR_SW_BITS
;

1340 
t˚_•a˚
 =Å˚_•a˚ & (~
•ecifõd_èbÀ_size
);

1341 
öfo
->
t˚_•a˚
 = (
u64
 *)
	`__va
(tce_space);

1345 
	}
}

1347 
__öô
 
	$dëe˘_ˇlg¨y
()

1349 
bus
;

1350 *
tbl
;

1351 
ˇlg¨y_found
 = 0;

1352 
±r
;

1353 
off£t
, 
¥ev_off£t
;

1354 
ªt
;

1360 i‡(
swiŸlb
 || 
no_iommu
 || 
iommu_dëe˘ed
)

1363 i‡(!
u£_ˇlg¨y
)

1366 i‡(!
	`óæy_pci_Ælowed
())

1369 
	`¥ötk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDAárea\n");

1371 
±r
 = ()
	`phys_to_vút
(
	`gë_bios_ebda
());

1373 
rio_èbÀ_hdr
 = 
NULL
;

1374 
¥ev_off£t
 = 0;

1375 
off£t
 = 0x180;

1380 
off£t
 > 
¥ev_off£t
) {

1382 i‡(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1384 
rio_èbÀ_hdr
 = (rio_èbÀ_hd∏*)(
±r
 + 
off£t
 + 4);

1387 
¥ev_off£t
 = 
off£t
;

1388 
off£t
 = *((*)(
±r
 + offset));

1390 i‡(!
rio_èbÀ_hdr
) {

1391 
	`¥ötk
(
KERN_DEBUG
 "Calgary: UnableÅoÜocate Rio GrandeÅable "

1396 
ªt
 = 
	`buûd_dëaû_¨øys
();

1397 i‡(
ªt
) {

1398 
	`¥ötk
(
KERN_DEBUG
 "CÆg¨y: buûd_dëaû_¨øy†ªà%d\n", 
ªt
);

1402 
•ecifõd_èbÀ_size
 = 
	`dëîmöe_t˚_èbÀ_size
((
	`is_kdump_kî√l
() ?

1403 
ßved_max_p‚
 : 
max_p‚
Ë* 
PAGE_SIZE
);

1405 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1406 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1407 
pci_devi˚
;

1408 
u32
 
vÆ
;

1410 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1411 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1413 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1416 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1419 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1420 
å™¶©e_em±y_¶Ÿs
) {

1425 i‡(!
	`is_kdump_kî√l
()) {

1426 
tbl
 = 
	`Æloc_t˚_èbÀ
();

1427 i‡(!
tbl
)

1428 
˛ónup
;

1429 
öfo
->
t˚_•a˚
 = 
tbl
;

1431 
ˇlg¨y_found
 = 1;

1435 
	`¥ötk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1436 
ˇlg¨y_found
 ? "found" : "not found");

1438 i‡(
ˇlg¨y_found
) {

1439 
iommu_dëe˘ed
 = 1;

1440 
ˇlg¨y_dëe˘ed
 = 1;

1441 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1442 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary TCEÅable spec is %d\n",

1443 
•ecifõd_èbÀ_size
);

1446 i‡(
max_p‚
 > 
MAX_DMA32_PFN
)

1447 
swiŸlb
 = 1;

1451 
˛ónup
:

1452 --
bus
; bus >= 0; --bus) {

1453 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1455 i‡(
öfo
->
t˚_•a˚
)

1456 
	`‰ì_t˚_èbÀ
(
öfo
->
t˚_•a˚
);

1458 
	}
}

1460 
__öô
 
	$ˇlg¨y_iommu_öô
()

1462 
ªt
;

1464 i‡(
no_iommu
 || (
swiŸlb
 && !
ˇlg¨y_dëe˘ed
))

1465  -
ENODEV
;

1467 i‡(!
ˇlg¨y_dëe˘ed
)

1468  -
ENODEV
;

1471 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1473 
ªt
 = 
	`ˇlg¨y_öô
();

1474 i‡(
ªt
) {

1475 
	`¥ötk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1476 "ÁŒög backÅÿno_iommu\n", 
ªt
);

1477  
ªt
;

1480 
f‹˚_iommu
 = 1;

1481 
bad_dma_addªss
 = 0x0;

1483 i‡(!
dma_›s
)

1484 
dma_›s
 = &
nommu_dma_›s
;

1487 
	}
}

1489 
__öô
 
	$ˇlg¨y_∑r£_›ti⁄s
(*
p
)

1491 
bridge
;

1492 
size_t
 
Àn
;

1493 * 
ídp
;

1495 *
p
) {

1496 i‡(!
	`°∫cmp
(
p
, "64k", 3))

1497 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_64K
;

1498 i‡(!
	`°∫cmp
(
p
, "128k", 4))

1499 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_128K
;

1500 i‡(!
	`°∫cmp
(
p
, "256k", 4))

1501 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_256K
;

1502 i‡(!
	`°∫cmp
(
p
, "512k", 4))

1503 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_512K
;

1504 i‡(!
	`°∫cmp
(
p
, "1M", 2))

1505 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_1M
;

1506 i‡(!
	`°∫cmp
(
p
, "2M", 2))

1507 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_2M
;

1508 i‡(!
	`°∫cmp
(
p
, "4M", 2))

1509 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_4M
;

1510 i‡(!
	`°∫cmp
(
p
, "8M", 2))

1511 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_8M
;

1513 
Àn
 = 
	`°æí
("translate_empty_slots");

1514 i‡(!
	`°∫cmp
(
p
, "å™¶©e_em±y_¶Ÿs", 
Àn
))

1515 
å™¶©e_em±y_¶Ÿs
 = 1;

1517 
Àn
 = 
	`°æí
("disable");

1518 i‡(!
	`°∫cmp
(
p
, "dißbÀ", 
Àn
)) {

1519 
p
 +
Àn
;

1520 i‡(*
p
 == '=')

1521 ++
p
;

1522 i‡(*
p
 == '\0')

1524 
bridge
 = 
	`sim∂e_°πoul
(
p
, &
ídp
, 0);

1525 i‡(
p
 =
ídp
)

1528 i‡(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1529 
	`¥ötk
(
KERN_INFO
 "Calgary: disabling "

1530 "å™¶©i⁄ f‹ PHB %#x\n", 
bridge
);

1531 
bus_öfo
[
bridge
].
å™¶©i⁄_dißbÀd
 = 1;

1535 
p
 = 
	`°Ωbrk
(p, ",");

1536 i‡(!
p
)

1539 
p
++;

1542 
	}
}

1543 
__£tup
("ˇlg¨y=", 
ˇlg¨y_∑r£_›ti⁄s
);

1545 
__öô
 
	$ˇlg¨y_fixup_⁄e_t˚_•a˚
(
pci_dev
 *
dev
)

1547 
iommu_èbÀ
 *
tbl
;

1548 
≈ages
;

1549 
i
;

1551 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1553 
i
 = 0; i < 4; i++) {

1554 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
PCI_BRIDGE_RESOURCES
 + 
i
];

1557 i‡(!(
r
->
Êags
 & 
IORESOURCE_MEM
))

1561 i‡(!
r
->
°¨t
)

1565 
≈ages
 = (
r
->
íd
 -Ñ->
°¨t
Ë>> 
PAGE_SHIFT
;

1566 
≈ages
++;

1568 
	`iommu_ønge_ª£rve
(
tbl
, 
r
->
°¨t
, 
≈ages
);

1570 
	}
}

1572 
__öô
 
	$ˇlg¨y_fixup_t˚_•a˚s
()

1574 
pci_dev
 *
dev
 = 
NULL
;

1575 
ˇlg¨y_bus_öfo
 *
öfo
;

1577 i‡(
no_iommu
 || 
swiŸlb
 || !
ˇlg¨y_dëe˘ed
)

1578  -
ENODEV
;

1580 
	`¥ötk
(
KERN_DEBUG
 "Calgary: fixing upÅce spaces\n");

1583 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1584 i‡(!
dev
)

1586 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1589 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1590 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1593 i‡(!
öfo
->
t˚_•a˚
)

1596 
	`ˇlg¨y_fixup_⁄e_t˚_•a˚
(
dev
);

1601 
	}
}

1607 
roŸfs_öôˇŒ
(
ˇlg¨y_fixup_t˚_•a˚s
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<löux/dma-m≠pög.h
>

2 
	~<löux/dma-debug.h
>

3 
	~<löux/dm¨.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/pci.h
>

7 
	~<asm/¥Ÿo.h
>

8 
	~<asm/dma.h
>

9 
	~<asm/iommu.h
>

10 
	~<asm/g¨t.h
>

11 
	~<asm/ˇlg¨y.h
>

12 
	~<asm/amd_iommu.h
>

14 
f‹bid_dac
 
	g__ªad_mo°ly
;

16 
dma_m≠_›s
 *
	gdma_›s
;

17 
EXPORT_SYMBOL
(
dma_›s
);

19 
iommu_ßc_f‹˚
 
	g__ªad_mo°ly
;

21 #ifde‡
CONFIG_IOMMU_DEBUG


22 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 1;

23 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 1;

25 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 0;

26 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 0;

29 
iommu_mîge
 
	g__ªad_mo°ly
 = 0;

31 
no_iommu
 
	g__ªad_mo°ly
;

33 
iommu_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

35 
	giommu_∑ss_through
;

37 
dma_addr_t
 
bad_dma_addªss
 
	g__ªad_mo°ly
 = 0;

38 
EXPORT_SYMBOL
(
bad_dma_addªss
);

43 
devi˚
 
	gx86_dma_ÁŒback_dev
 = {

44 .
öô_«me
 = "fallback device",

45 .
	gcohîít_dma_mask
 = 
DMA_BIT_MASK
(32),

46 .
	gdma_mask
 = &
x86_dma_ÁŒback_dev
.
cohîít_dma_mask
,

48 
EXPORT_SYMBOL
(
x86_dma_ÁŒback_dev
);

51 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

53 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

55 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

56  -
EIO
;

58 *
dev
->
dma_mask
 = 
mask
;

61 
	}
}

62 
EXPORT_SYMBOL
(
dma_£t_mask
);

64 #ifde‡
CONFIG_X86_64


65 
__öôd©a
 *
	gdma32_boŸmem_±r
;

66 
dma32_boŸmem_size
 
	g__öôd©a
 = (128ULL<<20);

68 
__öô
 
	$∑r£_dma32_size_›t
(*
p
)

70 i‡(!
p
)

71  -
EINVAL
;

72 
dma32_boŸmem_size
 = 
	`mem∑r£
(
p
, &p);

74 
	}
}

75 
óæy_∑øm
("dma32_size", 
∑r£_dma32_size_›t
);

77 
__öô
 
	$dma32_ª£rve_boŸmem
()

79 
size
, 
Æign
;

80 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

87 
Æign
 = 64ULL<<20;

88 
size
 = 
	`roundup
(
dma32_boŸmem_size
, 
Æign
);

89 
dma32_boŸmem_±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
,

91 i‡(
dma32_boŸmem_±r
)

92 
dma32_boŸmem_size
 = 
size
;

94 
dma32_boŸmem_size
 = 0;

95 
	}
}

96 
__öô
 
	$dma32_‰ì_boŸmem
()

99 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

102 i‡(!
dma32_boŸmem_±r
)

105 
	`‰ì_boŸmem
(
	`__∑
(
dma32_boŸmem_±r
), 
dma32_boŸmem_size
);

107 
dma32_boŸmem_±r
 = 
NULL
;

108 
dma32_boŸmem_size
 = 0;

109 
	}
}

112 
__öô
 
	$pci_iommu_Æloc
()

114 #ifde‡
CONFIG_X86_64


116 
	`dma32_‰ì_boŸmem
();

123 
	`g¨t_iommu_hﬁe_öô
();

125 
	`dëe˘_ˇlg¨y
();

127 
	`dëe˘_öãl_iommu
();

129 
	`amd_iommu_dëe˘
();

131 
	`pci_swiŸlb_öô
();

132 
	}
}

134 *
	$dma_gíîic_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

135 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

137 
dma_mask
;

138 
∑ge
 *page;

139 
dma_addr_t
 
addr
;

141 
dma_mask
 = 
	`dma_Æloc_cohîít_mask
(
dev
, 
Êag
);

143 
Êag
 |
__GFP_ZERO
;

144 
agaö
:

145 
∑ge
 = 
	`Æloc_∑ges_node
(
	`dev_to_node
(
dev
), 
Êag
, 
	`gë_‹dî
(
size
));

146 i‡(!
∑ge
)

147  
NULL
;

149 
addr
 = 
	`∑ge_to_phys
(
∑ge
);

150 i‡(!
	`is_buf„r_dma_ˇ∑bÀ
(
dma_mask
, 
addr
, 
size
)) {

151 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

153 i‡(
dma_mask
 < 
	`DMA_BIT_MASK
(32Ë&& !(
Êag
 & 
GFP_DMA
)) {

154 
Êag
 = (Êag & ~
GFP_DMA32
Ë| 
GFP_DMA
;

155 
agaö
;

158  
NULL
;

161 *
dma_addr
 = 
addr
;

162  
	`∑ge_addªss
(
∑ge
);

163 
	}
}

169 
__öô
 
	$iommu_£tup
(*
p
)

171 
iommu_mîge
 = 1;

173 i‡(!
p
)

174  -
EINVAL
;

176 *
p
) {

177 i‡(!
	`°∫cmp
(
p
, "off", 3))

178 
no_iommu
 = 1;

180 i‡(!
	`°∫cmp
(
p
, "force", 5))

181 
f‹˚_iommu
 = 1;

182 i‡(!
	`°∫cmp
(
p
, "noforce", 7)) {

183 
iommu_mîge
 = 0;

184 
f‹˚_iommu
 = 0;

187 i‡(!
	`°∫cmp
(
p
, "biomerge", 8)) {

188 
iommu_mîge
 = 1;

189 
f‹˚_iommu
 = 1;

191 i‡(!
	`°∫cmp
(
p
, "panic", 5))

192 
∑nic_⁄_ovîÊow
 = 1;

193 i‡(!
	`°∫cmp
(
p
, "nopanic", 7))

194 
∑nic_⁄_ovîÊow
 = 0;

195 i‡(!
	`°∫cmp
(
p
, "merge", 5)) {

196 
iommu_mîge
 = 1;

197 
f‹˚_iommu
 = 1;

199 i‡(!
	`°∫cmp
(
p
, "nomerge", 7))

200 
iommu_mîge
 = 0;

201 i‡(!
	`°∫cmp
(
p
, "forcesac", 8))

202 
iommu_ßc_f‹˚
 = 1;

203 i‡(!
	`°∫cmp
(
p
, "allowdac", 8))

204 
f‹bid_dac
 = 0;

205 i‡(!
	`°∫cmp
(
p
, "nodac", 5))

206 
f‹bid_dac
 = -1;

207 i‡(!
	`°∫cmp
(
p
, "usedac", 6)) {

208 
f‹bid_dac
 = -1;

211 #ifde‡
CONFIG_SWIOTLB


212 i‡(!
	`°∫cmp
(
p
, "soft", 4))

213 
swiŸlb
 = 1;

215 i‡(!
	`°∫cmp
(
p
, "pt", 2)) {

216 
iommu_∑ss_through
 = 1;

220 
	`g¨t_∑r£_›ti⁄s
(
p
);

222 #ifde‡
CONFIG_CALGARY_IOMMU


223 i‡(!
	`°∫cmp
(
p
, "calgary", 7))

224 
u£_ˇlg¨y
 = 1;

227 
p
 +
	`°rc•n
(p, ",");

228 i‡(*
p
 == ',')

229 ++
p
;

232 
	}
}

233 
óæy_∑øm
("iommu", 
iommu_£tup
);

235 
	$dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

237 
dma_m≠_›s
 *
›s
 = 
	`gë_dma_›s
(
dev
);

239 #ifde‡
CONFIG_PCI


240 i‡(
mask
 > 0xfffffff‡&& 
f‹bid_dac
 > 0) {

241 
	`dev_öfo
(
dev
, "PCI: Disallowing DAC for device\n");

246 i‡(
›s
->
dma_suµ‹ãd
)

247  
›s
->
	`dma_suµ‹ãd
(
dev
, 
mask
);

252 i‡(
mask
 < 
	`DMA_BIT_MASK
(24))

267 i‡(
iommu_ßc_f‹˚
 && (
mask
 >
	`DMA_BIT_MASK
(40))) {

268 
	`dev_öfo
(
dev
, "F‹˚ SAC wôh mask %Lx\n", 
mask
);

273 
	}
}

274 
EXPORT_SYMBOL
(
dma_suµ‹ãd
);

276 
__öô
 
	$pci_iommu_öô
()

278 
	`dma_debug_öô
(
PREALLOC_DMA_DEBUG_ENTRIES
);

280 #ifde‡
CONFIG_PCI


281 
	`dma_debug_add_bus
(&
pci_bus_ty≥
);

284 
	`ˇlg¨y_iommu_öô
();

286 
	`öãl_iommu_öô
();

288 
	`amd_iommu_öô
();

290 
	`g¨t_iommu_öô
();

292 
	`no_iommu_öô
();

294 
	}
}

296 
	$pci_iommu_shutdown
()

298 
	`g¨t_iommu_shutdown
();

300 
	`amd_iommu_shutdown
();

301 
	}
}

303 
fs_öôˇŒ
(
pci_iommu_öô
);

305 #ifde‡
CONFIG_PCI


308 
__devöô
 
	$vü_no_dac
(
pci_dev
 *
dev
)

310 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
 && 
f‹bid_dac
 == 0) {

311 
	`dev_öfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

312 
f‹bid_dac
 = 1;

314 
	}
}

315 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vü_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<löux/ty≥s.h
>

15 
	~<löux/˘y≥.h
>

16 
	~<löux/agp_backíd.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/•ölock.h
>

21 
	~<löux/pci.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/t›ﬁogy.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/bô›s.h
>

26 
	~<löux/kdebug.h
>

27 
	~<löux/sˇâîli°.h
>

28 
	~<löux/iommu-hñ≥r.h
>

29 
	~<löux/sysdev.h
>

30 
	~<löux/io.h
>

31 
	~<asm/©omic.h
>

32 
	~<asm/mår.h
>

33 
	~<asm/pgèbÀ.h
>

34 
	~<asm/¥Ÿo.h
>

35 
	~<asm/iommu.h
>

36 
	~<asm/g¨t.h
>

37 
	~<asm/ˇcheÊush.h
>

38 
	~<asm/swiŸlb.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/k8.h
>

42 
	giommu_bus_ba£
;

43 
	giommu_size
;

44 
	giommu_∑ges
;

46 
u32
 *
	giommu_g©t_ba£
;

55 
	giommu_fuŒÊush
 = 1;

58 
DEFINE_SPINLOCK
(
iommu_bôm≠_lock
);

60 *
	giommu_g¨t_bôm≠
;

62 
u32
 
	gg¨t_unm≠≥d_íåy
;

64 
	#GPTE_VALID
 1

	)

65 
	#GPTE_COHERENT
 2

	)

66 
	#GPTE_ENCODE
(
x
) \

67 (((
x
Ë& 0xfffff000Ë| (((xË>> 32Ë<< 4Ë| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

68 
	#GPTE_DECODE
(
x
Ë(((xË& 0xfffff000Ë| (((
u64
)(xË& 0xff0Ë<< 28))

	)

70 
	#EMERGENCY_PAGES
 32

	)

72 #ifde‡
CONFIG_AGP


73 
	#AGPEXTERN
 

	)

75 
	#AGPEXTERN


	)

79 
AGPEXTERN
 
agp_mem‹y_ª£rved
;

80 
AGPEXTERN
 
__u32
 *
	gagp_g©t_èbÀ
;

82 
	g√xt_bô
;

83 
boﬁ
 
	g√ed_Êush
;

85 
	$Æloc_iommu
(
devi˚
 *
dev
, 
size
,

86 
Æign_mask
)

88 
off£t
, 
Êags
;

89 
bound¨y_size
;

90 
ba£_ödex
;

92 
ba£_ödex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_gë_£g_bound¨y
(
dev
),

93 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

94 
bound¨y_size
 = 
	`ALIGN
(()
	`dma_gë_£g_bound¨y
(
dev
) + 1,

95 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

97 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

98 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 
√xt_bô
,

99 
size
, 
ba£_ödex
, 
bound¨y_size
, 
Æign_mask
);

100 i‡(
off£t
 == -1) {

101 
√ed_Êush
 = 
åue
;

102 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 0,

103 
size
, 
ba£_ödex
, 
bound¨y_size
,

104 
Æign_mask
);

106 i‡(
off£t
 != -1) {

107 
√xt_bô
 = 
off£t
+
size
;

108 i‡(
√xt_bô
 >
iommu_∑ges
) {

109 
√xt_bô
 = 0;

110 
√ed_Êush
 = 
åue
;

113 i‡(
iommu_fuŒÊush
)

114 
√ed_Êush
 = 
åue
;

115 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

117  
off£t
;

118 
	}
}

120 
	$‰ì_iommu
(
off£t
, 
size
)

122 
Êags
;

124 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

125 
	`iommu_¨ó_‰ì
(
iommu_g¨t_bôm≠
, 
off£t
, 
size
);

126 i‡(
off£t
 >
√xt_bô
)

127 
√xt_bô
 = 
off£t
 + 
size
;

128 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

129 
	}
}

134 
	$Êush_g¨t
()

136 
Êags
;

138 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

139 i‡(
√ed_Êush
) {

140 
	`k8_Êush_g¨ts
();

141 
√ed_Êush
 = 
Ál£
;

143 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

144 
	}
}

146 #ifde‡
CONFIG_IOMMU_LEAK


148 
	gÀak_åa˚
;

149 
	giommu_Àak_∑ges
 = 20;

151 
	$dump_Àak
()

153 
dump
;

155 i‡(
dump
)

157 
dump
 = 1;

159 
	`show_°ack
(
NULL
, NULL);

160 
	`debug_dma_dump_m≠pögs
(
NULL
);

161 
	}
}

164 
	$iommu_fuŒ
(
devi˚
 *
dev
, 
size_t
 
size
, 
dú
)

176 
	`dev_îr
(
dev
, "PCI-DMA: Ouào‡IOMMU s∑˚ f‹ %lu byãs\n", 
size
);

178 i‡(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

179 i‡(
dú
 =
PCI_DMA_FROMDEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

180 
	`∑nic
("PCI-DMA: Memory would be corrupted\n");

181 i‡(
dú
 =
PCI_DMA_TODEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

182 
	`∑nic
(
KERN_ERR


185 #ifde‡
CONFIG_IOMMU_LEAK


186 
	`dump_Àak
();

188 
	}
}

190 
ölöe
 

191 
	$√ed_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

193  
f‹˚_iommu
 ||

194 !
	`is_buf„r_dma_ˇ∑bÀ
(*
dev
->
dma_mask
, 
addr
, 
size
);

195 
	}
}

197 
ölöe
 

198 
	$n⁄f‹˚d_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

200  !
	`is_buf„r_dma_ˇ∑bÀ
(*
dev
->
dma_mask
, 
addr
, 
size
);

201 
	}
}

206 
dma_addr_t
 
	$dma_m≠_¨ó
(
devi˚
 *
dev
, 
dma_addr_t
 
phys_mem
,

207 
size_t
 
size
, 
dú
, 
Æign_mask
)

209 
≈ages
 = 
	`iommu_num_∑ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

210 
iommu_∑ge
 = 
	`Æloc_iommu
(
dev
, 
≈ages
, 
Æign_mask
);

211 
i
;

213 i‡(
iommu_∑ge
 == -1) {

214 i‡(!
	`n⁄f‹˚d_iommu
(
dev
, 
phys_mem
, 
size
))

215  
phys_mem
;

216 i‡(
∑nic_⁄_ovîÊow
)

217 
	`∑nic
("dma_m≠_¨ó ovîÊow %lu byãs\n", 
size
);

218 
	`iommu_fuŒ
(
dev
, 
size
, 
dú
);

219  
bad_dma_addªss
;

222 
i
 = 0; i < 
≈ages
; i++) {

223 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

224 
phys_mem
 +
PAGE_SIZE
;

226  
iommu_bus_ba£
 + 
iommu_∑ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

227 
	}
}

230 
dma_addr_t
 
	$g¨t_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

231 
off£t
, 
size_t
 
size
,

232 
dma_d©a_dúe˘i⁄
 
dú
,

233 
dma_©ås
 *
©ås
)

235 
bus
;

236 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

238 i‡(!
dev
)

239 
dev
 = &
x86_dma_ÁŒback_dev
;

241 i‡(!
	`√ed_iommu
(
dev
, 
∑ddr
, 
size
))

242  
∑ddr
;

244 
bus
 = 
	`dma_m≠_¨ó
(
dev
, 
∑ddr
, 
size
, 
dú
, 0);

245 
	`Êush_g¨t
();

247  
bus
;

248 
	}
}

253 
	$g¨t_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

254 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

255 
dma_©ås
 *
©ås
)

257 
iommu_∑ge
;

258 
≈ages
;

259 
i
;

261 i‡(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

262 
dma_addr
 >
iommu_bus_ba£
 + 
iommu_size
)

265 
iommu_∑ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

266 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

267 
i
 = 0; i < 
≈ages
; i++) {

268 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
g¨t_unm≠≥d_íåy
;

270 
	`‰ì_iommu
(
iommu_∑ge
, 
≈ages
);

271 
	}
}

276 
	$g¨t_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

277 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

279 
sˇâîli°
 *
s
;

280 
i
;

282 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

283 i‡(!
s
->
dma_Àngth
 || !s->
Àngth
)

285 
	`g¨t_unm≠_∑ge
(
dev
, 
s
->
dma_addªss
, s->
dma_Àngth
, 
dú
, 
NULL
);

287 
	}
}

290 
	$dma_m≠_sg_n⁄f‹˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

291 
√¡s
, 
dú
)

293 
sˇâîli°
 *
s
;

294 
i
;

296 #ifde‡
CONFIG_IOMMU_DEBUG


297 
	`¥ötk
(
KERN_DEBUG
 "dma_map_sg overflow\n");

300 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

301 
addr
 = 
	`sg_phys
(
s
);

303 i‡(
	`n⁄f‹˚d_iommu
(
dev
, 
addr
, 
s
->
Àngth
)) {

304 
addr
 = 
	`dma_m≠_¨ó
(
dev
,áddr, 
s
->
Àngth
, 
dú
, 0);

305 i‡(
addr
 =
bad_dma_addªss
) {

306 i‡(
i
 > 0)

307 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
i
, 
dú
, 
NULL
);

308 
√¡s
 = 0;

309 
sg
[0].
dma_Àngth
 = 0;

313 
s
->
dma_addªss
 = 
addr
;

314 
s
->
dma_Àngth
 = s->
Àngth
;

316 
	`Êush_g¨t
();

318  
√¡s
;

319 
	}
}

322 
	$__dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
,

323 
√Àms
, 
sˇâîli°
 *
sout
,

324 
∑ges
)

326 
iommu_°¨t
 = 
	`Æloc_iommu
(
dev
, 
∑ges
, 0);

327 
iommu_∑ge
 = 
iommu_°¨t
;

328 
sˇâîli°
 *
s
;

329 
i
;

331 i‡(
iommu_°¨t
 == -1)

334 
	`f‹_óch_sg
(
°¨t
, 
s
, 
√Àms
, 
i
) {

335 
∑ges
, 
addr
;

336 
phys_addr
 = 
s
->
dma_addªss
;

338 
	`BUG_ON
(
s
 !
°¨t
 && s->
off£t
);

339 i‡(
s
 =
°¨t
) {

340 
sout
->
dma_addªss
 = 
iommu_bus_ba£
;

341 
sout
->
dma_addªss
 +
iommu_∑ge
*
PAGE_SIZE
 + 
s
->
off£t
;

342 
sout
->
dma_Àngth
 = 
s
->
Àngth
;

344 
sout
->
dma_Àngth
 +
s
->
Àngth
;

347 
addr
 = 
phys_addr
;

348 
∑ges
 = 
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

349 
∑ges
--) {

350 
iommu_g©t_ba£
[
iommu_∑ge
] = 
	`GPTE_ENCODE
(
addr
);

351 
addr
 +
PAGE_SIZE
;

352 
iommu_∑ge
++;

355 
	`BUG_ON
(
iommu_∑ge
 - 
iommu_°¨t
 !
∑ges
);

358 
	}
}

360 
ölöe
 

361 
	$dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
, 
√Àms
,

362 
sˇâîli°
 *
sout
, 
∑ges
, 
√ed
)

364 i‡(!
√ed
) {

365 
	`BUG_ON
(
√Àms
 != 1);

366 
sout
->
dma_addªss
 = 
°¨t
->dma_address;

367 
sout
->
dma_Àngth
 = 
°¨t
->
Àngth
;

370  
	`__dma_m≠_c⁄t
(
dev
, 
°¨t
, 
√Àms
, 
sout
, 
∑ges
);

371 
	}
}

377 
	$g¨t_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

378 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

380 
sˇâîli°
 *
s
, *
ps
, *
°¨t_sg
, *
sgm≠
;

381 
√ed
 = 0, 
√xäìd
, 
i
, 
out
, 
°¨t
;

382 
∑ges
 = 0;

383 
£g_size
;

384 
max_£g_size
;

386 i‡(
√¡s
 == 0)

389 i‡(!
dev
)

390 
dev
 = &
x86_dma_ÁŒback_dev
;

392 
out
 = 0;

393 
°¨t
 = 0;

394 
°¨t_sg
 = 
sgm≠
 = 
sg
;

395 
£g_size
 = 0;

396 
max_£g_size
 = 
	`dma_gë_max_£g_size
(
dev
);

397 
ps
 = 
NULL
;

398 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

399 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

401 
s
->
dma_addªss
 = 
addr
;

402 
	`BUG_ON
(
s
->
Àngth
 == 0);

404 
√xäìd
 = 
	`√ed_iommu
(
dev
, 
addr
, 
s
->
Àngth
);

407 i‡(
i
 > 
°¨t
) {

413 i‡(!
iommu_mîge
 || !
√xäìd
 || !
√ed
 || 
s
->
off£t
 ||

414 (
s
->
Àngth
 + 
£g_size
 > 
max_£g_size
) ||

415 (
ps
->
off£t
 +Ös->
Àngth
Ë% 
PAGE_SIZE
) {

416 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
,

417 
sgm≠
, 
∑ges
, 
√ed
) < 0)

418 
îr‹
;

419 
out
++;

420 
£g_size
 = 0;

421 
sgm≠
 = 
	`sg_√xt
(sgmap);

422 
∑ges
 = 0;

423 
°¨t
 = 
i
;

424 
°¨t_sg
 = 
s
;

428 
£g_size
 +
s
->
Àngth
;

429 
√ed
 = 
√xäìd
;

430 
∑ges
 +
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

431 
ps
 = 
s
;

433 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
, 
sgm≠
, 
∑ges
, 
√ed
) < 0)

434 
îr‹
;

435 
out
++;

436 
	`Êush_g¨t
();

437 i‡(
out
 < 
√¡s
) {

438 
sgm≠
 = 
	`sg_√xt
(sgmap);

439 
sgm≠
->
dma_Àngth
 = 0;

441  
out
;

443 
îr‹
:

444 
	`Êush_g¨t
();

445 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
out
, 
dú
, 
NULL
);

448 i‡(
f‹˚_iommu
 || 
iommu_mîge
) {

449 
out
 = 
	`dma_m≠_sg_n⁄f‹˚
(
dev
, 
sg
, 
√¡s
, 
dú
);

450 i‡(
out
 > 0)

451  
out
;

453 i‡(
∑nic_⁄_ovîÊow
)

454 
	`∑nic
("dma_m≠_sg: ovîÊow o¿%luÖages\n", 
∑ges
);

456 
	`iommu_fuŒ
(
dev
, 
∑ges
 << 
PAGE_SHIFT
, 
dú
);

457 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
)

458 
s
->
dma_addªss
 = 
bad_dma_addªss
;

460 
	}
}

464 
	$g¨t_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

465 
gÂ_t
 
Êag
)

467 
dma_addr_t
 
∑ddr
;

468 
Æign_mask
;

469 
∑ge
 *page;

471 i‡(
f‹˚_iommu
 && !(
Êag
 & 
GFP_DMA
)) {

472 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

473 
∑ge
 = 
	`Æloc_∑ges
(
Êag
 | 
__GFP_ZERO
, 
	`gë_‹dî
(
size
));

474 i‡(!
∑ge
)

475  
NULL
;

477 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

478 
∑ddr
 = 
	`dma_m≠_¨ó
(
dev
, 
	`∑ge_to_phys
(
∑ge
), 
size
,

479 
DMA_BIDIRECTIONAL
, 
Æign_mask
);

481 
	`Êush_g¨t
();

482 i‡(
∑ddr
 !
bad_dma_addªss
) {

483 *
dma_addr
 = 
∑ddr
;

484  
	`∑ge_addªss
(
∑ge
);

486 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

488  
	`dma_gíîic_Æloc_cohîít
(
dev
, 
size
, 
dma_addr
, 
Êag
);

490  
NULL
;

491 
	}
}

495 
	$g¨t_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

496 
dma_addr_t
 
dma_addr
)

498 
	`g¨t_unm≠_∑ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

499 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

500 
	}
}

502 
	gno_agp
;

504 
__öô
 
	$check_iommu_size
(
≠î
, 
u64
 
≠î_size
)

506 
a
;

508 i‡(!
iommu_size
) {

509 
iommu_size
 = 
≠î_size
;

510 i‡(!
no_agp
)

511 
iommu_size
 /= 2;

514 
a
 = 
≠î
 + 
iommu_size
;

515 
iommu_size
 -
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -á;

517 i‡(
iommu_size
 < 64*1024*1024) {

518 
	`¥ötk
(
KERN_WARNING


521 
iommu_size
 >> 20);

524  
iommu_size
;

525 
	}
}

527 
__öô
 
	$ªad_≠îtuª
(
pci_dev
 *
dev
, 
u32
 *
size
)

529 
≠î_size
 = 0, 
≠î_ba£_32
, 
≠î_‹dî
;

530 
u64
 
≠î_ba£
;

532 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
≠î_ba£_32
);

533 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
≠î_‹dî
);

534 
≠î_‹dî
 = (aper_order >> 1) & 7;

536 
≠î_ba£
 = 
≠î_ba£_32
 & 0x7fff;

537 
≠î_ba£
 <<= 25;

539 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

540 i‡(
≠î_ba£
 + 
≠î_size
 > 0x100000000UL || !aper_size)

541 
≠î_ba£
 = 0;

543 *
size
 = 
≠î_size
;

544  
≠î_ba£
;

545 
	}
}

547 
	$íabÀ_g¨t_å™¶©i⁄s
()

549 
i
;

551 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

552 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

554 
	`íabÀ_g¨t_å™¶©i⁄
(
dev
, 
	`__∑
(
agp_g©t_èbÀ
));

556 
	}
}

562 
boﬁ
 
	gfix_up_n‹th_bridges
;

563 
u32
 
	g≠îtuª_‹dî
;

564 
u32
 
	g≠îtuª_Æloc
;

566 
	$£t_up_g¨t_ªsume
(
u32
 
≠î_‹dî
, u32 
≠î_Æloc
)

568 
fix_up_n‹th_bridges
 = 
åue
;

569 
≠îtuª_‹dî
 = 
≠î_‹dî
;

570 
≠îtuª_Æloc
 = 
≠î_Æloc
;

571 
	}
}

573 
	$g¨t_ªsume
(
sys_devi˚
 *
dev
)

575 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Resuming GART IOMMU\n");

577 i‡(
fix_up_n‹th_bridges
) {

578 
i
;

580 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Restoring GARTáperture settings\n");

582 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

583 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

589 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
,

590 
≠îtuª_‹dî
 << 1);

591 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
,

592 
≠îtuª_Æloc
 >> 25);

596 
	`íabÀ_g¨t_å™¶©i⁄s
();

599 
	}
}

601 
	$g¨t_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

604 
	}
}

606 
sysdev_˛ass
 
	gg¨t_sysdev_˛ass
 = {

607 .
«me
 = "gart",

608 .
	gsu•íd
 = 
g¨t_su•íd
,

609 .
	gªsume
 = 
g¨t_ªsume
,

613 
sys_devi˚
 
	gdevi˚_g¨t
 = {

614 .
id
 = 0,

615 .
	g˛s
 = &
g¨t_sysdev_˛ass
,

622 
__öô
 
	$öô_k8_g©t
(
agp_kîn_öfo
 *
öfo
)

624 
≠î_size
, 
g©t_size
, 
√w_≠î_size
;

625 
≠î_ba£
, 
√w_≠î_ba£
;

626 
pci_dev
 *
dev
;

627 *
g©t
;

628 
i
, 
îr‹
;

630 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Disabling AGP.\n");

631 
≠î_size
 = 
≠î_ba£
 = 
öfo
->aper_size = 0;

632 
dev
 = 
NULL
;

633 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

634 
dev
 = 
k8_n‹thbridges
[
i
];

635 
√w_≠î_ba£
 = 
	`ªad_≠îtuª
(
dev
, &
√w_≠î_size
);

636 i‡(!
√w_≠î_ba£
)

637 
nommu
;

639 i‡(!
≠î_ba£
) {

640 
≠î_size
 = 
√w_≠î_size
;

641 
≠î_ba£
 = 
√w_≠î_ba£
;

643 i‡(
≠î_size
 !
√w_≠î_size
 || 
≠î_ba£
 !
√w_≠î_ba£
)

644 
nommu
;

646 i‡(!
≠î_ba£
)

647 
nommu
;

648 
öfo
->
≠î_ba£
 =áper_base;

649 
öfo
->
≠î_size
 =áper_size >> 20;

651 
g©t_size
 = (
≠î_size
 >> 
PAGE_SHIFT
Ë* (
u32
);

652 
g©t
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

653 
	`gë_‹dî
(
g©t_size
));

654 i‡(!
g©t
)

655 
	`∑nic
("Cannotállocate GATTÅable");

656 i‡(
	`£t_mem‹y_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

657 
	`∑nic
("CouldÇot set GART PTEsÅo uncacheableÖages");

659 
agp_g©t_èbÀ
 = 
g©t
;

661 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
g¨t_sysdev_˛ass
);

662 i‡(!
îr‹
)

663 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_g¨t
);

664 i‡(
îr‹
)

665 
	`∑nic
("CouldÇotÑegister gart_sysdev -- "

668 
	`Êush_g¨t
();

670 
	`¥ötk
(
KERN_INFO
 "PCI-DMA:áperture base @ %x size %u KB\n",

671 
≠î_ba£
, 
≠î_size
>>10);

675 
nommu
:

677 
	`¥ötk
(
KERN_WARNING
 "PCI-DMA: MoreÅhan 4GB of RAMándÇo IOMMU\n"

680 
	}
}

682 
dma_m≠_›s
 
	gg¨t_dma_›s
 = {

683 .
m≠_sg
 = 
g¨t_m≠_sg
,

684 .
	gunm≠_sg
 = 
g¨t_unm≠_sg
,

685 .
	gm≠_∑ge
 = 
g¨t_m≠_∑ge
,

686 .
	gunm≠_∑ge
 = 
g¨t_unm≠_∑ge
,

687 .
	gÆloc_cohîít
 = 
g¨t_Æloc_cohîít
,

688 .
	g‰ì_cohîít
 = 
g¨t_‰ì_cohîít
,

691 
	$g¨t_iommu_shutdown
()

693 
pci_dev
 *
dev
;

694 
i
;

696 i‡(
no_agp
 && (
dma_›s
 !&
g¨t_dma_›s
))

699 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

700 
u32
 
˘l
;

702 
dev
 = 
k8_n‹thbridges
[
i
];

703 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
˘l
);

705 
˘l
 &~
GARTEN
;

707 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
˘l
);

709 
	}
}

711 
__öô
 
	$g¨t_iommu_öô
()

713 
agp_kîn_öfo
 
öfo
;

714 
iommu_°¨t
;

715 
≠î_ba£
, 
≠î_size
;

716 
°¨t_p‚
, 
íd_p‚
;

717 
s¸©ch
;

718 
i
;

720 i‡(
	`ˇche_k8_n‹thbridges
(Ë< 0 || 
num_k8_n‹thbridges
 == 0)

723 #i‚de‡
CONFIG_AGP_AMD64


724 
no_agp
 = 1;

728 
no_agp
 =Ço_agp ||

729 (
	`agp_amd64_öô
() < 0) ||

730 (
	`agp_c›y_öfo
(
agp_bridge
, &
öfo
) < 0);

733 i‡(
swiŸlb
)

737 i‡(
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
)

740 i‡(
no_iommu
 ||

741 (!
f‹˚_iommu
 && 
max_p‚
 <
MAX_DMA32_PFN
) ||

742 !
g¨t_iommu_≠îtuª
 ||

743 (
no_agp
 && 
	`öô_k8_g©t
(&
öfo
) < 0)) {

744 i‡(
max_p‚
 > 
MAX_DMA32_PFN
) {

745 
	`¥ötk
(
KERN_WARNING
 "MoreÅhan 4GB of memory "

747 
	`¥ötk
(
KERN_WARNING
 "falling backÅo iommu=soft.\n");

753 
≠î_size
 = 
öfo
.aper_size << 20;

754 
≠î_ba£
 = 
öfo
.aper_base;

755 
íd_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
Ë+ (
≠î_size
>>PAGE_SHIFT);

756 i‡(
íd_p‚
 > 
max_low_p‚_m≠≥d
) {

757 
°¨t_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
);

758 
	`öô_mem‹y_m≠pög
(
°¨t_p‚
<<
PAGE_SHIFT
, 
íd_p‚
<<PAGE_SHIFT);

761 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: using GART IOMMU.\n");

762 
iommu_size
 = 
	`check_iommu_size
(
öfo
.
≠î_ba£
, 
≠î_size
);

763 
iommu_∑ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

765 
iommu_g¨t_bôm≠
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

766 
	`gë_‹dî
(
iommu_∑ges
/8));

767 i‡(!
iommu_g¨t_bôm≠
)

768 
	`∑nic
("Cannotállocate iommu bitmap\n");

770 #ifde‡
CONFIG_IOMMU_LEAK


771 i‡(
Àak_åa˚
) {

772 
ªt
;

774 
ªt
 = 
	`dma_debug_ªsize_íåõs
(
iommu_∑ges
);

775 i‡(
ªt
)

776 
	`¥ötk
(
KERN_DEBUG


785 
	`iommu_¨ó_ª£rve
(
iommu_g¨t_bôm≠
, 0, 
EMERGENCY_PAGES
);

787 
agp_mem‹y_ª£rved
 = 
iommu_size
;

788 
	`¥ötk
(
KERN_INFO


790 
iommu_size
 >> 20);

792 
iommu_°¨t
 = 
≠î_size
 - 
iommu_size
;

793 
iommu_bus_ba£
 = 
öfo
.
≠î_ba£
 + 
iommu_°¨t
;

794 
bad_dma_addªss
 = 
iommu_bus_ba£
;

795 
iommu_g©t_ba£
 = 
agp_g©t_èbÀ
 + (
iommu_°¨t
>>
PAGE_SHIFT
);

806 
	`£t_mem‹y_≈
(()
	`__va
(
iommu_bus_ba£
),

807 
iommu_size
 >> 
PAGE_SHIFT
);

816 
	`wbövd
();

824 
	`íabÀ_g¨t_å™¶©i⁄s
();

832 
s¸©ch
 = 
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

833 i‡(!
s¸©ch
)

834 
	`∑nic
("Cannotállocate iommu scratchÖage");

835 
g¨t_unm≠≥d_íåy
 = 
	`GPTE_ENCODE
(
	`__∑
(
s¸©ch
));

836 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_∑ges
; i++)

837 
iommu_g©t_ba£
[
i
] = 
g¨t_unm≠≥d_íåy
;

839 
	`Êush_g¨t
();

840 
dma_›s
 = &
g¨t_dma_›s
;

841 
	}
}

843 
__öô
 
	$g¨t_∑r£_›ti⁄s
(*
p
)

845 
¨g
;

847 #ifde‡
CONFIG_IOMMU_LEAK


848 i‡(!
	`°∫cmp
(
p
, "leak", 4)) {

849 
Àak_åa˚
 = 1;

850 
p
 += 4;

851 i‡(*
p
 == '=')

852 ++
p
;

853 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

854 
iommu_Àak_∑ges
 = 
¨g
;

857 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

858 
iommu_size
 = 
¨g
;

859 i‡(!
	`°∫cmp
(
p
, "fullflush", 8))

860 
iommu_fuŒÊush
 = 1;

861 i‡(!
	`°∫cmp
(
p
, "nofullflush", 11))

862 
iommu_fuŒÊush
 = 0;

863 i‡(!
	`°∫cmp
(
p
, "noagp", 5))

864 
no_agp
 = 1;

865 i‡(!
	`°∫cmp
(
p
, "noaperture", 10))

866 
fix_≠îtuª
 = 0;

868 i‡(!
	`°∫cmp
(
p
, "force", 5))

869 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

870 i‡(!
	`°∫cmp
(
p
, "allowed", 7))

871 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

872 i‡(!
	`°∫cmp
(
p
, "memaper", 7)) {

873 
ÁŒback_≠î_f‹˚
 = 1;

874 
p
 += 7;

875 i‡(*
p
 == '=') {

876 ++
p
;

877 i‡(
	`gë_›ti⁄
(&
p
, &
¨g
))

878 
ÁŒback_≠î_‹dî
 = 
¨g
;

881 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<löux/dma-m≠pög.h
>

4 
	~<löux/sˇâîli°.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/pci.h
>

8 
	~<löux/mm.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/dma.h
>

15 
	$check_addr
(*
«me
, 
devi˚
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

17 i‡(
hwdev
 && !
	`is_buf„r_dma_ˇ∑bÀ
(*hwdev->
dma_mask
, 
bus
, 
size
)) {

18 i‡(*
hwdev
->
dma_mask
 >
	`DMA_BIT_MASK
(32))

19 
	`¥ötk
(
KERN_ERR


21 
«me
, ()
bus
, 
size
,

22 ()*
hwdev
->
dma_mask
);

26 
	}
}

28 
dma_addr_t
 
	$nommu_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

29 
off£t
, 
size_t
 
size
,

30 
dma_d©a_dúe˘i⁄
 
dú
,

31 
dma_©ås
 *
©ås
)

33 
dma_addr_t
 
bus
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

34 
	`WARN_ON
(
size
 == 0);

35 i‡(!
	`check_addr
("m≠_sögÀ", 
dev
, 
bus
, 
size
))

36  
bad_dma_addªss
;

37 
	`Êush_wrôe_buf„rs
();

38  
bus
;

39 
	}
}

56 
	$nommu_m≠_sg
(
devi˚
 *
hwdev
, 
sˇâîli°
 *
sg
,

57 
√¡s
, 
dma_d©a_dúe˘i⁄
 
dú
,

58 
dma_©ås
 *
©ås
)

60 
sˇâîli°
 *
s
;

61 
i
;

63 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

65 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

66 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

67 
s
->
dma_addªss
 = 
	`sg_phys
(s);

68 i‡(!
	`check_addr
("m≠_sg", 
hwdev
, 
s
->
dma_addªss
, s->
Àngth
))

70 
s
->
dma_Àngth
 = s->
Àngth
;

72 
	`Êush_wrôe_buf„rs
();

73  
√¡s
;

74 
	}
}

76 
	$nommu_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

77 
dma_addr_t
 
dma_addr
)

79 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

80 
	}
}

82 
dma_m≠_›s
 
	gnommu_dma_›s
 = {

83 .
Æloc_cohîít
 = 
dma_gíîic_Æloc_cohîít
,

84 .
	g‰ì_cohîít
 = 
nommu_‰ì_cohîít
,

85 .
	gm≠_sg
 = 
nommu_m≠_sg
,

86 .
	gm≠_∑ge
 = 
nommu_m≠_∑ge
,

87 .
	gis_phys
 = 1,

90 
__öô
 
	$no_iommu_öô
()

92 i‡(
dma_›s
)

95 
f‹˚_iommu
 = 0;

96 
dma_›s
 = &
nommu_dma_›s
;

97 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<löux/pci.h
>

4 
	~<löux/ˇche.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/swiŸlb.h
>

7 
	~<löux/boŸmem.h
>

8 
	~<löux/dma-m≠pög.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiŸlb.h
>

12 
	~<asm/dma.h
>

14 
swiŸlb
 
	g__ªad_mo°ly
;

16 * 
__öô
 
	$swiŸlb_Æloc_boŸ
(
size_t
 
size
, 
n¶abs
)

18  
	`Æloc_boŸmem_low_∑ges
(
size
);

19 
	}
}

21 *
	$swiŸlb_Æloc
(
‹dî
, 
n¶abs
)

23  (*)
	`__gë_‰ì_∑ges
(
GFP_DMA
 | 
__GFP_NOWARN
, 
‹dî
);

24 
	}
}

26 
dma_addr_t
 
	$swiŸlb_phys_to_bus
(
devi˚
 *
hwdev
, 
phys_addr_t
 
∑ddr
)

28  
∑ddr
;

29 
	}
}

31 
phys_addr_t
 
	$swiŸlb_bus_to_phys
(
devi˚
 *
hwdev
, 
dma_addr_t
 
baddr
)

33  
baddr
;

34 
	}
}

36 
__wók
 
	$swiŸlb_¨ch_ønge_√eds_m≠pög
(
phys_addr_t
 
∑ddr
, 
size_t
 
size
)

39 
	}
}

41 *
	$x86_swiŸlb_Æloc_cohîít
(
devi˚
 *
hwdev
, 
size_t
 
size
,

42 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êags
)

44 *
vaddr
;

46 
vaddr
 = 
	`dma_gíîic_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

47 i‡(
vaddr
)

48  
vaddr
;

50  
	`swiŸlb_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

51 
	}
}

53 
dma_m≠_›s
 
	gswiŸlb_dma_›s
 = {

54 .
m≠pög_îr‹
 = 
swiŸlb_dma_m≠pög_îr‹
,

55 .
	gÆloc_cohîít
 = 
x86_swiŸlb_Æloc_cohîít
,

56 .
	g‰ì_cohîít
 = 
swiŸlb_‰ì_cohîít
,

57 .
	gsync_sögÀ_f‹_˝u
 = 
swiŸlb_sync_sögÀ_f‹_˝u
,

58 .
	gsync_sögÀ_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_f‹_devi˚
,

59 .
	gsync_sögÀ_ønge_f‹_˝u
 = 
swiŸlb_sync_sögÀ_ønge_f‹_˝u
,

60 .
	gsync_sögÀ_ønge_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_ønge_f‹_devi˚
,

61 .
	gsync_sg_f‹_˝u
 = 
swiŸlb_sync_sg_f‹_˝u
,

62 .
	gsync_sg_f‹_devi˚
 = 
swiŸlb_sync_sg_f‹_devi˚
,

63 .
	gm≠_sg
 = 
swiŸlb_m≠_sg_©ås
,

64 .
	gunm≠_sg
 = 
swiŸlb_unm≠_sg_©ås
,

65 .
	gm≠_∑ge
 = 
swiŸlb_m≠_∑ge
,

66 .
	gunm≠_∑ge
 = 
swiŸlb_unm≠_∑ge
,

67 .
	gdma_suµ‹ãd
 = 
NULL
,

70 
__öô
 
	$pci_swiŸlb_öô
()

73 #ifde‡
CONFIG_X86_64


74 i‡((!
iommu_dëe˘ed
 && !
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

75 
iommu_∑ss_through
)

76 
swiŸlb
 = 1;

78 i‡(
swiŸlb_f‹˚
)

79 
swiŸlb
 = 1;

80 i‡(
swiŸlb
) {

81 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using software bounce buffering for IO (SWIOTLB)\n");

82 
	`swiŸlb_öô
();

83 
dma_›s
 = &
swiŸlb_dma_›s
;

85 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<löux/∂©f‹m_devi˚.h
>

2 
	~<löux/îr.h
>

3 
	~<löux/öô.h
>

5 
__öô
 
	$add_pc•kr
()

7 
∂©f‹m_devi˚
 *
pd
;

9 
pd
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("pc•kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
Ë? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
devi˚_öôˇŒ
(
add_pc•kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<löux/jiffõs.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/time.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/˝umask.h
>

22 
	~<löux/a˝i_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/m§.h
>

27 
	~<asm/vsysˇŒ.h
>

29 
ölöe
 
u32
 
	$cyc2us
(
u32
 
cy˛es
)

38 
cy˛es
 *= 286;

39  (
cy˛es
 >> 10);

40 
	}
}

42 
	$pmtimî_waô_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
;

46 
a
 =
b
;

47 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
)

48 
	`˝u_ªœx
();

49  
b
;

50 
	}
}

53 
	$pmtimî_waô
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtimî_waô_tick
();

58 
b
 = 
	`öl
(
pmtmr_i›‹t
);

59 
	`˝u_ªœx
();

60 } 
	`cyc2us
(
b
 - 
a
Ë< 
us
);

61 
	}
}

63 
__öô
 
	$n›mtimî_£tup
(*
s
)

65 
pmtmr_i›‹t
 = 0;

67 
	}
}

69 
__£tup
("n›mtimî", 
n›mtimî_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/smp.h
>

5 
	~<löux/¥˘l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/pm.h
>

10 
	~<löux/˛ockchùs.h
>

11 
	~<löux/øndom.h
>

12 
	~<åa˚/powî.h
>

13 
	~<asm/sy°em.h
>

14 
	~<asm/≠ic.h
>

15 
	~<asm/sysˇŒs.h
>

16 
	~<asm/idÀ.h
>

17 
	~<asm/uac˚ss.h
>

18 
	~<asm/i387.h
>

19 
	~<asm/ds.h
>

21 
	gidÀ_hÆt
;

22 
EXPORT_SYMBOL
(
idÀ_hÆt
);

23 
	gidÀ_nomwaô
;

24 
EXPORT_SYMBOL
(
idÀ_nomwaô
);

26 
kmem_ˇche
 *
	gèsk_x°©e_ˇchï
;

28 
DEFINE_TRACE
(
powî_°¨t
);

29 
DEFINE_TRACE
(
powî_íd
);

31 
	$¨ch_dup_èsk_°ru˘
(
èsk_°ru˘
 *
d°
, èsk_°ru˘ *
§c
)

33 *
d°
 = *
§c
;

34 i‡(
§c
->
thªad
.
x°©e
) {

35 
d°
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

36 
GFP_KERNEL
);

37 i‡(!
d°
->
thªad
.
x°©e
)

38  -
ENOMEM
;

39 
	`WARN_ON
(()
d°
->
thªad
.
x°©e
 & 15);

40 
	`mem˝y
(
d°
->
thªad
.
x°©e
, 
§c
->thªad.x°©e, 
x°©e_size
);

43 
	}
}

45 
	$‰ì_thªad_x°©e
(
èsk_°ru˘
 *
tsk
)

47 i‡(
tsk
->
thªad
.
x°©e
) {

48 
	`kmem_ˇche_‰ì
(
èsk_x°©e_ˇchï
, 
tsk
->
thªad
.
x°©e
);

49 
tsk
->
thªad
.
x°©e
 = 
NULL
;

52 
	`WARN
(
tsk
->
thªad
.
ds_˘x
, "leaking DS context\n");

53 
	}
}

55 
	$‰ì_thªad_öfo
(
thªad_öfo
 *
ti
)

57 
	`‰ì_thªad_x°©e
(
ti
->
èsk
);

58 
	`‰ì_∑ges
(()
ti
, 
	`gë_‹dî
(
THREAD_SIZE
));

59 
	}
}

61 
	$¨ch_èsk_ˇche_öô
()

63 
èsk_x°©e_ˇchï
 =

64 
	`kmem_ˇche_¸óã
("èsk_x°©e", 
x°©e_size
,

65 
	`__Æignof__
(
thªad_x°©e
),

66 
SLAB_PANIC
 | 
SLAB_NOTRACK
, 
NULL
);

67 
	}
}

72 
	$exô_thªad
()

74 
èsk_°ru˘
 *
me
 = 
cuºít
;

75 
thªad_°ru˘
 *
t
 = &
me
->
thªad
;

76 *
bp
 = 
t
->
io_bôm≠_±r
;

78 i‡(
bp
) {

79 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

81 
t
->
io_bôm≠_±r
 = 
NULL
;

82 
	`˛ór_thªad_Êag
(
TIF_IO_BITMAP
);

86 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
t
->
io_bôm≠_max
);

87 
t
->
io_bôm≠_max
 = 0;

88 
	`put_˝u
();

89 
	`k‰ì
(
bp
);

91 
	}
}

93 
	$Êush_thªad
()

95 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

97 #ifde‡
CONFIG_X86_64


98 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_ABI_PENDING
)) {

99 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_ABI_PENDING
);

100 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
)) {

101 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
);

103 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
);

104 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_COMPAT
;

109 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUG
);

111 
tsk
->
thªad
.
debugªg0
 = 0;

112 
tsk
->
thªad
.
debugªg1
 = 0;

113 
tsk
->
thªad
.
debugªg2
 = 0;

114 
tsk
->
thªad
.
debugªg3
 = 0;

115 
tsk
->
thªad
.
debugªg6
 = 0;

116 
tsk
->
thªad
.
debugªg7
 = 0;

117 
	`mem£t
(
tsk
->
thªad
.
és_¨øy
, 0, (tsk->thread.tls_array));

121 
tsk
->
Âu_cou¡î
 = 0;

122 
	`˛ór_Âu
(
tsk
);

123 
	`˛ór_u£d_m©h
();

124 
	}
}

126 
	$h¨d_dißbÀ_TSC
()

128 
	`wrôe_¸4
(
	`ªad_¸4
(Ë| 
X86_CR4_TSD
);

129 
	}
}

131 
	$dißbÀ_TSC
()

133 
	`¥ìm±_dißbÀ
();

134 i‡(!
	`ã°_™d_£t_thªad_Êag
(
TIF_NOTSC
))

139 
	`h¨d_dißbÀ_TSC
();

140 
	`¥ìm±_íabÀ
();

141 
	}
}

143 
	$h¨d_íabÀ_TSC
()

145 
	`wrôe_¸4
(
	`ªad_¸4
(Ë& ~
X86_CR4_TSD
);

146 
	}
}

148 
	$íabÀ_TSC
()

150 
	`¥ìm±_dißbÀ
();

151 i‡(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_NOTSC
))

156 
	`h¨d_íabÀ_TSC
();

157 
	`¥ìm±_íabÀ
();

158 
	}
}

160 
	$gë_tsc_mode
(
adr
)

162 
vÆ
;

164 i‡(
	`ã°_thªad_Êag
(
TIF_NOTSC
))

165 
vÆ
 = 
PR_TSC_SIGSEGV
;

167 
vÆ
 = 
PR_TSC_ENABLE
;

169  
	`put_u£r
(
vÆ
, (
__u£r
 *)
adr
);

170 
	}
}

172 
	$£t_tsc_mode
(
vÆ
)

174 i‡(
vÆ
 =
PR_TSC_SIGSEGV
)

175 
	`dißbÀ_TSC
();

176 i‡(
vÆ
 =
PR_TSC_ENABLE
)

177 
	`íabÀ_TSC
();

179  -
EINVAL
;

182 
	}
}

184 
	$__swôch_to_xåa
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
,

185 
tss_°ru˘
 *
tss
)

187 
thªad_°ru˘
 *
¥ev
, *
√xt
;

189 
¥ev
 = &
¥ev_p
->
thªad
;

190 
√xt
 = &
√xt_p
->
thªad
;

192 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DS_AREA_MSR
) ||

193 
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_DS_AREA_MSR
))

194 
	`ds_swôch_to
(
¥ev_p
, 
√xt_p
);

195 i‡(
√xt
->
debug˘lm§
 !
¥ev
->debugctlmsr)

196 
	`upd©e_debug˘lm§
(
√xt
->
debug˘lm§
);

198 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DEBUG
)) {

199 
	`£t_debugªg
(
√xt
->
debugªg0
, 0);

200 
	`£t_debugªg
(
√xt
->
debugªg1
, 1);

201 
	`£t_debugªg
(
√xt
->
debugªg2
, 2);

202 
	`£t_debugªg
(
√xt
->
debugªg3
, 3);

204 
	`£t_debugªg
(
√xt
->
debugªg6
, 6);

205 
	`£t_debugªg
(
√xt
->
debugªg7
, 7);

208 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_NOTSC
) ^

209 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
)) {

211 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
))

212 
	`h¨d_dißbÀ_TSC
();

214 
	`h¨d_íabÀ_TSC
();

217 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_IO_BITMAP
)) {

222 
	`mem˝y
(
tss
->
io_bôm≠
, 
√xt
->
io_bôm≠_±r
,

223 
	`max
(
¥ev
->
io_bôm≠_max
, 
√xt
->io_bitmap_max));

224 } i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_IO_BITMAP
)) {

228 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
¥ev
->
io_bôm≠_max
);

230 
	}
}

232 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

234  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0, 
NULL
, NULL);

235 
	}
}

247 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

249  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0,

250 
NULL
, NULL);

251 
	}
}

257 
	gboŸ_›ti⁄_idÀ_ovîride
 = 0;

258 
EXPORT_SYMBOL
(
boŸ_›ti⁄_idÀ_ovîride
);

263 (*
pm_idÀ
)();

264 
	`EXPORT_SYMBOL
(
pm_idÀ
);

266 #ifde‡
CONFIG_X86_32


271 
h…_cou¡î
;

272 
	$dißbÀ_h…
()

274 
h…_cou¡î
++;

275 
	}
}

276 
EXPORT_SYMBOL
(
dißbÀ_h…
);

278 
	$íabÀ_h…
()

280 
h…_cou¡î
--;

281 
	}
}

282 
EXPORT_SYMBOL
(
íabÀ_h…
);

284 
ölöe
 
	$h…_u£_hÆt
()

286  (!
h…_cou¡î
 && 
boŸ_˝u_d©a
.
h…_w‹ks_ok
);

287 
	}
}

289 
ölöe
 
	$h…_u£_hÆt
()

292 
	}
}

299 
	$deÁu…_idÀ
()

301 i‡(
	`h…_u£_hÆt
()) {

302 
powî_åa˚
 
ô
;

304 
	`åa˚_powî_°¨t
(&
ô
, 
POWER_CSTATE
, 1);

305 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_POLLING
;

310 
	`smp_mb
();

312 i‡(!
	`√ed_ªsched
())

313 
	`ß„_hÆt
();

315 
	`loˇl_úq_íabÀ
();

316 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

317 
	`åa˚_powî_íd
(&
ô
);

319 
	`loˇl_úq_íabÀ
();

321 
	`˝u_ªœx
();

323 
	}
}

324 #ifde‡
CONFIG_APM_MODULE


325 
EXPORT_SYMBOL
(
deÁu…_idÀ
);

328 
	$°›_this_˝u
(*
dummy
)

330 
	`loˇl_úq_dißbÀ
();

334 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
Ál£
);

335 
	`dißbÀ_loˇl_APIC
();

338 i‡(
	`h…_w‹ks
(
	`smp_¥o˚ss‹_id
()))

339 
	`hÆt
();

341 
	}
}

343 
	$do_nŸhög
(*
unu£d
)

345 
	}
}

355 
	$˝u_idÀ_waô
()

357 
	`smp_mb
();

359 
	`smp_ˇŒ_fun˘i⁄
(
do_nŸhög
, 
NULL
, 1);

360 
	}
}

361 
EXPORT_SYMBOL_GPL
(
˝u_idÀ_waô
);

373 
	$mwaô_idÀ_wôh_höts
(
ax
, 
cx
)

375 
powî_åa˚
 
ô
;

377 
	`åa˚_powî_°¨t
(&
ô
, 
POWER_CSTATE
, (
ax
>>4)+1);

378 i‡(!
	`√ed_ªsched
()) {

379 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

380 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

382 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

383 
	`smp_mb
();

384 i‡(!
	`√ed_ªsched
())

385 
	`__mwaô
(
ax
, 
cx
);

387 
	`åa˚_powî_íd
(&
ô
);

388 
	}
}

391 
	$mwaô_idÀ
()

393 
powî_åa˚
 
ô
;

394 i‡(!
	`√ed_ªsched
()) {

395 
	`åa˚_powî_°¨t
(&
ô
, 
POWER_CSTATE
, 1);

396 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

397 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

399 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

400 
	`smp_mb
();

401 i‡(!
	`√ed_ªsched
())

402 
	`__°i_mwaô
(0, 0);

404 
	`loˇl_úq_íabÀ
();

405 
	`åa˚_powî_íd
(&
ô
);

407 
	`loˇl_úq_íabÀ
();

408 
	}
}

415 
	$pﬁl_idÀ
()

417 
powî_åa˚
 
ô
;

419 
	`åa˚_powî_°¨t
(&
ô
, 
POWER_CSTATE
, 0);

420 
	`loˇl_úq_íabÀ
();

421 !
	`√ed_ªsched
())

422 
	`˝u_ªœx
();

423 
	`åa˚_powî_íd
(&
ô
);

424 
	}
}

438 
__˝uöôd©a
 
	gf‹˚_mwaô
;

440 
	#MWAIT_INFO
 0x05

	)

441 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

442 
	#MWAIT_EDX_C1
 0xf0

	)

444 
__˝uöô
 
	$mwaô_ußbÀ
(c⁄° 
˝uöfo_x86
 *
c
)

446 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

448 i‡(
f‹˚_mwaô
)

451 i‡(
c
->
˝uid_Àvñ
 < 
MWAIT_INFO
)

454 
	`˝uid
(
MWAIT_INFO
, &
óx
, &
ebx
, &
ecx
, &
edx
);

456 i‡(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

463  (
edx
 & 
MWAIT_EDX_C1
);

464 
	}
}

469 
__˝uöô
 
	$check_c1e_idÀ
(c⁄° 
˝uöfo_x86
 *
c
)

471 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
)

474 i‡(
c
->
x86
 < 0x0F)

478 i‡(
c
->
x86
 =0x0‡&& c->
x86_modñ
 < 0x40)

482 
	}
}

484 
˝umask_v¨_t
 
	gc1e_mask
;

485 
	gc1e_dëe˘ed
;

487 
	$c1e_ªmove_˝u
(
˝u
)

489 i‡(
c1e_mask
 !
NULL
)

490 
	`˝umask_˛ór_˝u
(
˝u
, 
c1e_mask
);

491 
	}
}

498 
	$c1e_idÀ
()

500 i‡(
	`√ed_ªsched
())

503 i‡(!
c1e_dëe˘ed
) {

504 
u32
 
lo
, 
hi
;

506 
	`rdm§
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

507 i‡(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

508 
c1e_dëe˘ed
 = 1;

509 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_NONSTOP_TSC
))

510 
	`m¨k_tsc_un°abÀ
("TSC halt in AMD C1E");

511 
	`¥ötk
(
KERN_INFO
 "System has AMD C1EÉnabled\n");

512 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_AMDC1E
);

516 i‡(
c1e_dëe˘ed
) {

517 
˝u
 = 
	`smp_¥o˚ss‹_id
();

519 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
c1e_mask
)) {

520 
	`˝umask_£t_˝u
(
˝u
, 
c1e_mask
);

524 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

525 &
˝u
);

526 
	`¥ötk
(
KERN_INFO
 "SwitchÅo broadcast mode on CPU%d\n",

527 
˝u
);

529 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
˝u
);

531 
	`deÁu…_idÀ
();

537 
	`loˇl_úq_dißbÀ
();

538 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
˝u
);

539 
	`loˇl_úq_íabÀ
();

541 
	`deÁu…_idÀ
();

542 
	}
}

544 
__˝uöô
 
	$£À˘_idÀ_routöe
(c⁄° 
˝uöfo_x86
 *
c
)

546 #ifde‡
CONFIG_SMP


547 i‡(
pm_idÀ
 =
pﬁl_idÀ
 && 
smp_num_siblögs
 > 1) {

548 
	`¥ötk
(
KERN_WARNING
 "WARNING:Öolling idleánd HTÉnabled,"

552 i‡(
pm_idÀ
)

555 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
Ë&& 
	`mwaô_ußbÀ
(c)) {

559 
	`¥ötk
(
KERN_INFO
 "using mwait in idleÅhreads.\n");

560 
pm_idÀ
 = 
mwaô_idÀ
;

561 } i‡(
	`check_c1e_idÀ
(
c
)) {

562 
	`¥ötk
(
KERN_INFO
 "using C1Eáware idleÑoutine\n");

563 
pm_idÀ
 = 
c1e_idÀ
;

565 
pm_idÀ
 = 
deÁu…_idÀ
;

566 
	}
}

568 
__öô
 
	$öô_c1e_mask
()

571 i‡(
pm_idÀ
 =
c1e_idÀ
) {

572 
	`Æloc_˝umask_v¨
(&
c1e_mask
, 
GFP_KERNEL
);

573 
	`˝umask_˛ór
(
c1e_mask
);

575 
	}
}

577 
__öô
 
	$idÀ_£tup
(*
°r
)

579 i‡(!
°r
)

580  -
EINVAL
;

582 i‡(!
	`°rcmp
(
°r
, "poll")) {

583 
	`¥ötk
("usingÖolling idleÅhreads.\n");

584 
pm_idÀ
 = 
pﬁl_idÀ
;

585 } i‡(!
	`°rcmp
(
°r
, "mwait"))

586 
f‹˚_mwaô
 = 1;

587 i‡(!
	`°rcmp
(
°r
, "halt")) {

595 
pm_idÀ
 = 
deÁu…_idÀ
;

596 
idÀ_hÆt
 = 1;

598 } i‡(!
	`°rcmp
(
°r
, "nomwait")) {

605 
idÀ_nomwaô
 = 1;

610 
boŸ_›ti⁄_idÀ_ovîride
 = 1;

612 
	}
}

613 
óæy_∑øm
("idÀ", 
idÀ_£tup
);

615 
	$¨ch_Æign_°ack
(
•
)

617 i‡(!(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
Ë&& 
øndomize_va_•a˚
)

618 
•
 -
	`gë_øndom_öt
() % 8192;

619  
•
 & ~0xf;

620 
	}
}

622 
	$¨ch_øndomize_brk
(
mm_°ru˘
 *
mm
)

624 
ønge_íd
 = 
mm
->
brk
 + 0x02000000;

625  
	`øndomize_ønge
(
mm
->
brk
, 
ønge_íd
, 0) ? : mm->brk;

626 
	}
}

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/˝u.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/ñfc‹e.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/u£r.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/ut¢ame.h
>

30 
	~<löux/dñay.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/±ø˚.h
>

33 
	~<löux/nŸifõr.h
>

34 
	~<löux/k¥obes.h
>

35 
	~<löux/kdebug.h
>

36 
	~<löux/tick.h
>

37 
	~<löux/¥˘l.h
>

38 
	~<löux/uac˚ss.h
>

39 
	~<löux/io.h
>

40 
	~<löux/·ø˚.h
>

41 
	~<löux/dmi.h
>

43 
	~<asm/pgèbÀ.h
>

44 
	~<asm/sy°em.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/i387.h
>

47 
	~<asm/mmu_c⁄ãxt.h
>

48 
	~<asm/¥˘l.h
>

49 
	~<asm/desc.h
>

50 
	~<asm/¥Ÿo.h
>

51 
	~<asm/ü32.h
>

52 
	~<asm/idÀ.h
>

53 
	~<asm/sysˇŒs.h
>

54 
	~<asm/ds.h
>

56 
asmlökage
 
ªt_‰om_f‹k
();

58 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë&
öô_èsk
;

59 
EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

61 
DEFINE_PER_CPU
(, 
ﬁd_r•
);

62 
DEFINE_PER_CPU
(, 
is_idÀ
);

64 
	gkî√l_thªad_Êags
 = 
CLONE_VM
 | 
CLONE_UNTRACED
;

66 
ATOMIC_NOTIFIER_HEAD
(
idÀ_nŸifõr
);

68 
	$idÀ_nŸifõr_ªgi°î
(
nŸifõr_block
 *
n
)

70 
	`©omic_nŸifõr_chaö_ªgi°î
(&
idÀ_nŸifõr
, 
n
);

71 
	}
}

72 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_ªgi°î
);

74 
	$idÀ_nŸifõr_uƒegi°î
(
nŸifõr_block
 *
n
)

76 
	`©omic_nŸifõr_chaö_uƒegi°î
(&
idÀ_nŸifõr
, 
n
);

77 
	}
}

78 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_uƒegi°î
);

80 
	$íãr_idÀ
()

82 
	`≥r˝u_wrôe
(
is_idÀ
, 1);

83 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_START
, 
NULL
);

84 
	}
}

86 
	$__exô_idÀ
()

88 i‡(
	`x86_ã°_™d_˛ór_bô_≥r˝u
(0, 
is_idÀ
) == 0)

90 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_END
, 
NULL
);

91 
	}
}

94 
	$exô_idÀ
()

97 i‡(
cuºít
->
pid
)

99 
	`__exô_idÀ
();

100 
	}
}

102 #i‚de‡
CONFIG_SMP


103 
ölöe
 
	$∂ay_dód
()

105 
	`BUG
();

106 
	}
}

115 
	$˝u_idÀ
()

117 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

126 
	`boŸ_öô_°ack_ˇ«ry
();

130 
	`tick_nohz_°›_sched_tick
(1);

131 !
	`√ed_ªsched
()) {

133 
	`rmb
();

135 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
()))

136 
	`∂ay_dód
();

142 
	`loˇl_úq_dißbÀ
();

143 
	`íãr_idÀ
();

145 
	`°›_¸ôiˇl_timögs
();

146 
	`pm_idÀ
();

147 
	`°¨t_¸ôiˇl_timögs
();

151 
	`__exô_idÀ
();

154 
	`tick_nohz_ª°¨t_sched_tick
();

155 
	`¥ìm±_íabÀ_no_ªsched
();

156 
	`scheduÀ
();

157 
	`¥ìm±_dißbÀ
();

159 
	}
}

162 
	$__show_ªgs
(
±_ªgs
 *
ªgs
, 
Æl
)

164 
¸0
 = 0L, 
¸2
 = 0L, 
¸3
 = 0L, 
¸4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

165 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

166 
fsödex
, 
gsödex
;

167 
ds
, 
cs
, 
es
;

168 c⁄° *
bﬂrd
;

170 
	`¥ötk
("\n");

171 
	`¥öt_moduÀs
();

172 
bﬂrd
 = 
	`dmi_gë_sy°em_öfo
(
DMI_PRODUCT_NAME
);

173 i‡(!
bﬂrd
)

174 
bﬂrd
 = "";

175 
	`¥ötk
(
KERN_INFO
 "Pid: %d, comm: %.20s %s %s %.*s %s\n",

176 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

177 
	`öô_ut¢ame
()->
ªÀa£
,

178 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

179 
	`öô_ut¢ame
()->
vîsi⁄
, 
bﬂrd
);

180 
	`¥ötk
(
KERN_INFO
 "RIP: %04lx:[<%016lx>] ", 
ªgs
->
cs
 & 0xffff,Ñegs->
ù
);

181 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

182 
	`¥ötk
(
KERN_INFO
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
ªgs
->
ss
,

183 
ªgs
->
•
,Ñegs->
Êags
);

184 
	`¥ötk
(
KERN_INFO
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

185 
ªgs
->
ax
,Ñegs->
bx
,Ñegs->
cx
);

186 
	`¥ötk
(
KERN_INFO
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

187 
ªgs
->
dx
,Ñegs->
si
,Ñegs->
di
);

188 
	`¥ötk
(
KERN_INFO
 "RBP: %016lx R08: %016lx R09: %016lx\n",

189 
ªgs
->
bp
,Ñegs->
r8
,Ñegs->
r9
);

190 
	`¥ötk
(
KERN_INFO
 "R10: %016lx R11: %016lx R12: %016lx\n",

191 
ªgs
->
r10
,Ñegs->
r11
,Ñegs->
r12
);

192 
	`¥ötk
(
KERN_INFO
 "R13: %016lx R14: %016lx R15: %016lx\n",

193 
ªgs
->
r13
,Ñegs->
r14
,Ñegs->
r15
);

195 
	`asm
("mov»%%ds,%0" : "Ù" (
ds
));

196 
	`asm
("mov»%%cs,%0" : "Ù" (
cs
));

197 
	`asm
("mov»%%es,%0" : "Ù" (
es
));

198 
	`asm
("mov»%%fs,%0" : "Ù" (
fsödex
));

199 
	`asm
("mov»%%gs,%0" : "Ù" (
gsödex
));

201 
	`rdm§l
(
MSR_FS_BASE
, 
fs
);

202 
	`rdm§l
(
MSR_GS_BASE
, 
gs
);

203 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

205 i‡(!
Æl
)

208 
¸0
 = 
	`ªad_¸0
();

209 
¸2
 = 
	`ªad_¸2
();

210 
¸3
 = 
	`ªad_¸3
();

211 
¸4
 = 
	`ªad_¸4
();

213 
	`¥ötk
(
KERN_INFO
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

214 
fs
, 
fsödex
, 
gs
, 
gsödex
, 
shadowgs
);

215 
	`¥ötk
(
KERN_INFO
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

216 
es
, 
¸0
);

217 
	`¥ötk
(
KERN_INFO
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
¸2
, 
¸3
,

218 
¸4
);

220 
	`gë_debugªg
(
d0
, 0);

221 
	`gë_debugªg
(
d1
, 1);

222 
	`gë_debugªg
(
d2
, 2);

223 
	`¥ötk
(
KERN_INFO
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

224 
	`gë_debugªg
(
d3
, 3);

225 
	`gë_debugªg
(
d6
, 6);

226 
	`gë_debugªg
(
d7
, 7);

227 
	`¥ötk
(
KERN_INFO
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

228 
	}
}

230 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

232 
	`¥ötk
(
KERN_INFO
 "CPU %d:", 
	`smp_¥o˚ss‹_id
());

233 
	`__show_ªgs
(
ªgs
, 1);

234 
	`show_åa˚
(
NULL
, 
ªgs
, (*)‘eg†+ 1),Ñegs->
bp
);

235 
	}
}

237 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

239 i‡(
dód_èsk
->
mm
) {

240 i‡(
dód_èsk
->
mm
->
c⁄ãxt
.
size
) {

241 
	`¥ötk
("WARNING: deadÖrocess %8s still has LDT? <%p/%d>\n",

242 
dód_èsk
->
comm
,

243 
dód_èsk
->
mm
->
c⁄ãxt
.
ldt
,

244 
dód_èsk
->
mm
->
c⁄ãxt
.
size
);

245 
	`BUG
();

248 
	}
}

250 
ölöe
 
	$£t_32bô_és
(
èsk_°ru˘
 *
t
, 
és
, 
u32
 
addr
)

252 
u£r_desc
 
ud
 = {

253 .
ba£_addr
 = 
addr
,

254 .
limô
 = 0xfffff,

255 .
£g_32bô
 = 1,

256 .
limô_ö_∑ges
 = 1,

257 .
u£abÀ
 = 1,

259 
desc_°ru˘
 *
desc
 = 
t
->
thªad
.
és_¨øy
;

260 
desc
 +
és
;

261 
	`fûl_ldt
(
desc
, &
ud
);

262 
	}
}

264 
ölöe
 
u32
 
	$ªad_32bô_és
(
èsk_°ru˘
 *
t
, 
és
)

266  
	`gë_desc_ba£
(&
t
->
thªad
.
és_¨øy
[
és
]);

267 
	}
}

273 
	$¥ï¨e_to_c›y
(
èsk_°ru˘
 *
tsk
)

275 
	`u∆azy_Âu
(
tsk
);

276 
	}
}

278 
	$c›y_thªad
(
˛⁄e_Êags
, 
•
,

279 
unu£d
,

280 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

282 
îr
;

283 
±_ªgs
 *
chûdªgs
;

284 
èsk_°ru˘
 *
me
 = 
cuºít
;

286 
chûdªgs
 = ((
±_ªgs
 *)

287 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
p
))) - 1;

288 *
chûdªgs
 = *
ªgs
;

290 
chûdªgs
->
ax
 = 0;

291 
chûdªgs
->
•
 = sp;

292 i‡(
•
 == ~0UL)

293 
chûdªgs
->
•
 = ()childregs;

295 
p
->
thªad
.
•
 = (Ë
chûdªgs
;

296 
p
->
thªad
.
•0
 = (Ë(
chûdªgs
+1);

297 
p
->
thªad
.
u£r•
 = 
me
->thread.usersp;

299 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_FORK
);

301 
p
->
thªad
.
fs
 = 
me
->thread.fs;

302 
p
->
thªad
.
gs
 = 
me
->thread.gs;

304 
	`ßve£gmít
(
gs
, 
p
->
thªad
.
gsödex
);

305 
	`ßve£gmít
(
fs
, 
p
->
thªad
.
fsödex
);

306 
	`ßve£gmít
(
es
, 
p
->
thªad
.es);

307 
	`ßve£gmít
(
ds
, 
p
->
thªad
.ds);

309 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
me
, 
TIF_IO_BITMAP
))) {

310 
p
->
thªad
.
io_bôm≠_±r
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

311 i‡(!
p
->
thªad
.
io_bôm≠_±r
) {

312 
p
->
thªad
.
io_bôm≠_max
 = 0;

313  -
ENOMEM
;

315 
	`mem˝y
(
p
->
thªad
.
io_bôm≠_±r
, 
me
->thread.io_bitmap_ptr,

316 
IO_BITMAP_BYTES
);

317 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_IO_BITMAP
);

323 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
) {

324 #ifde‡
CONFIG_IA32_EMULATION


325 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

326 
îr
 = 
	`do_£t_thªad_¨ó
(
p
, -1,

327 (
u£r_desc
 
__u£r
 *)
chûdªgs
->
si
, 0);

330 
îr
 = 
	`do_¨ch_¥˘l
(
p
, 
ARCH_SET_FS
, 
chûdªgs
->
r8
);

331 i‡(
îr
)

332 
out
;

335 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DS_AREA_MSR
);

336 
p
->
thªad
.
ds_˘x
 = 
NULL
;

338 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DEBUGCTLMSR
);

339 
p
->
thªad
.
debug˘lm§
 = 0;

341 
îr
 = 0;

342 
out
:

343 i‡(
îr
 && 
p
->
thªad
.
io_bôm≠_±r
) {

344 
	`k‰ì
(
p
->
thªad
.
io_bôm≠_±r
);

345 
p
->
thªad
.
io_bôm≠_max
 = 0;

347  
îr
;

348 
	}
}

351 
	$°¨t_thªad
(
±_ªgs
 *
ªgs
, 
√w_ù
, 
√w_•
)

353 
	`lﬂd£gmít
(
fs
, 0);

354 
	`lﬂd£gmít
(
es
, 0);

355 
	`lﬂd£gmít
(
ds
, 0);

356 
	`lﬂd_gs_ödex
(0);

357 
ªgs
->
ù
 = 
√w_ù
;

358 
ªgs
->
•
 = 
√w_•
;

359 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√w_•
);

360 
ªgs
->
cs
 = 
__USER_CS
;

361 
ªgs
->
ss
 = 
__USER_DS
;

362 
ªgs
->
Êags
 = 0x200;

363 
	`£t_fs
(
USER_DS
);

367 
	`‰ì_thªad_x°©e
(
cuºít
);

368 
	}
}

369 
EXPORT_SYMBOL_GPL
(
°¨t_thªad
);

381 
__nŸø˚_funcgøph
 
èsk_°ru˘
 *

382 
	$__swôch_to
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
)

384 
thªad_°ru˘
 *
¥ev
 = &
¥ev_p
->
thªad
;

385 
thªad_°ru˘
 *
√xt
 = &
√xt_p
->
thªad
;

386 
˝u
 = 
	`smp_¥o˚ss‹_id
();

387 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

388 
fsödex
, 
gsödex
;

391 i‡(
√xt_p
->
Âu_cou¡î
 > 5)

392 
	`¥e„tch
(
√xt
->
x°©e
);

397 
	`lﬂd_•0
(
tss
, 
√xt
);

403 
	`ßve£gmít
(
es
, 
¥ev
->es);

404 i‡(
	`u∆ikñy
(
√xt
->
es
 | 
¥ev
->es))

405 
	`lﬂd£gmít
(
es
, 
√xt
->es);

407 
	`ßve£gmít
(
ds
, 
¥ev
->ds);

408 i‡(
	`u∆ikñy
(
√xt
->
ds
 | 
¥ev
->ds))

409 
	`lﬂd£gmít
(
ds
, 
√xt
->ds);

417 
	`ßve£gmít
(
fs
, 
fsödex
);

418 
	`ßve£gmít
(
gs
, 
gsödex
);

420 
	`lﬂd_TLS
(
√xt
, 
˝u
);

429 
	`¨ch_íd_c⁄ãxt_swôch
(
√xt_p
);

438 i‡(
	`u∆ikñy
(
fsödex
 | 
√xt
->fsödex | 
¥ev
->
fs
)) {

439 
	`lﬂd£gmít
(
fs
, 
√xt
->
fsödex
);

445 i‡(
fsödex
)

446 
¥ev
->
fs
 = 0;

449 i‡(
√xt
->
fs
)

450 
	`wrm§l
(
MSR_FS_BASE
, 
√xt
->
fs
);

451 
¥ev
->
fsödex
 = fsindex;

453 i‡(
	`u∆ikñy
(
gsödex
 | 
√xt
->gsödex | 
¥ev
->
gs
)) {

454 
	`lﬂd_gs_ödex
(
√xt
->
gsödex
);

455 i‡(
gsödex
)

456 
¥ev
->
gs
 = 0;

458 i‡(
√xt
->
gs
)

459 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 
√xt
->
gs
);

460 
¥ev
->
gsödex
 = gsindex;

463 
	`u∆azy_Âu
(
¥ev_p
);

468 
¥ev
->
u£r•
 = 
	`≥r˝u_ªad
(
ﬁd_r•
);

469 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√xt
->
u£r•
);

470 
	`≥r˝u_wrôe
(
cuºít_èsk
, 
√xt_p
);

472 
	`≥r˝u_wrôe
(
kî√l_°ack
,

473 ()
	`èsk_°ack_∑ge
(
√xt_p
) +

474 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

479 i‡(
	`u∆ikñy
(
	`èsk_thªad_öfo
(
√xt_p
)->
Êags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

480 
	`èsk_thªad_öfo
(
¥ev_p
)->
Êags
 & 
_TIF_WORK_CTXSW_PREV
))

481 
	`__swôch_to_xåa
(
¥ev_p
, 
√xt_p
, 
tss
);

490 i‡(
	`tsk_u£d_m©h
(
√xt_p
Ë&&Çext_p->
Âu_cou¡î
 > 5)

491 
	`m©h_°©e_ª°‹e
();

492  
¥ev_p
;

493 
	}
}

498 
asmlökage


499 
	$sys_execve
(
__u£r
 *
«me
, __u£∏* __u£∏*
¨gv
,

500 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

502 
îr‹
;

503 *
fûíame
;

505 
fûíame
 = 
	`gë«me
(
«me
);

506 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

507 i‡(
	`IS_ERR
(
fûíame
))

508  
îr‹
;

509 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

510 
	`puäame
(
fûíame
);

511  
îr‹
;

512 
	}
}

514 
	$£t_≥rs⁄Æôy_64bô
()

519 
	`˛ór_thªad_Êag
(
TIF_IA32
);

525 
cuºít
->
≥rs⁄Æôy
 &~
READ_IMPLIES_EXEC
;

526 
	}
}

528 
asmlökage
 

529 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

530 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
, 
±_ªgs
 *
ªgs
)

532 i‡(!
√w•
)

533 
√w•
 = 
ªgs
->
•
;

534  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

535 
	}
}

537 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

539 
°ack
;

540 
u64
 
Â
, 
ù
;

541 
cou¡
 = 0;

543 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

545 
°ack
 = ()
	`èsk_°ack_∑ge
(
p
);

546 i‡(
p
->
thªad
.
•
 < 
°ack
 ||Ö->thªad.• >°ack+
THREAD_SIZE
)

548 
Â
 = *(
u64
 *)(
p
->
thªad
.
•
);

550 i‡(
Â
 < ()
°ack
 ||

551 
Â
 >()
°ack
+
THREAD_SIZE
)

553 
ù
 = *(
u64
 *)(
Â
+8);

554 i‡(!
	`ö_sched_fun˘i⁄s
(
ù
))

555  
ù
;

556 
Â
 = *(
u64
 *)fp;

557 } 
cou¡
++ < 16);

559 
	}
}

561 
	$do_¨ch_¥˘l
(
èsk_°ru˘
 *
èsk
, 
code
, 
addr
)

563 
ªt
 = 0;

564 
doô
 = 
èsk
 =
cuºít
;

565 
˝u
;

567 
code
) {

568 
ARCH_SET_GS
:

569 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

570  -
EPERM
;

571 
˝u
 = 
	`gë_˝u
();

574 i‡(
addr
 <= 0xffffffff) {

575 
	`£t_32bô_és
(
èsk
, 
GS_TLS
, 
addr
);

576 i‡(
doô
) {

577 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

578 
	`lﬂd_gs_ödex
(
GS_TLS_SEL
);

580 
èsk
->
thªad
.
gsödex
 = 
GS_TLS_SEL
;

581 
èsk
->
thªad
.
gs
 = 0;

583 
èsk
->
thªad
.
gsödex
 = 0;

584 
èsk
->
thªad
.
gs
 = 
addr
;

585 i‡(
doô
) {

586 
	`lﬂd_gs_ödex
(0);

587 
ªt
 = 
	`checkög_wrm§l
(
MSR_KERNEL_GS_BASE
, 
addr
);

590 
	`put_˝u
();

592 
ARCH_SET_FS
:

595 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

596  -
EPERM
;

597 
˝u
 = 
	`gë_˝u
();

600 i‡(
addr
 <= 0xffffffff) {

601 
	`£t_32bô_és
(
èsk
, 
FS_TLS
, 
addr
);

602 i‡(
doô
) {

603 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

604 
	`lﬂd£gmít
(
fs
, 
FS_TLS_SEL
);

606 
èsk
->
thªad
.
fsödex
 = 
FS_TLS_SEL
;

607 
èsk
->
thªad
.
fs
 = 0;

609 
èsk
->
thªad
.
fsödex
 = 0;

610 
èsk
->
thªad
.
fs
 = 
addr
;

611 i‡(
doô
) {

614 
	`lﬂd£gmít
(
fs
, 0);

615 
ªt
 = 
	`checkög_wrm§l
(
MSR_FS_BASE
, 
addr
);

618 
	`put_˝u
();

620 
ARCH_GET_FS
: {

621 
ba£
;

622 i‡(
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
)

623 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
FS_TLS
);

624 i‡(
doô
)

625 
	`rdm§l
(
MSR_FS_BASE
, 
ba£
);

627 
ba£
 = 
èsk
->
thªad
.
fs
;

628 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

631 
ARCH_GET_GS
: {

632 
ba£
;

633 
gsödex
;

634 i‡(
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
)

635 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
GS_TLS
);

636 i‡(
doô
) {

637 
	`ßve£gmít
(
gs
, 
gsödex
);

638 i‡(
gsödex
)

639 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

641 
ba£
 = 
èsk
->
thªad
.
gs
;

643 
ba£
 = 
èsk
->
thªad
.
gs
;

644 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

649 
ªt
 = -
EINVAL
;

653  
ªt
;

654 
	}
}

656 
	$sys_¨ch_¥˘l
(
code
, 
addr
)

658  
	`do_¨ch_¥˘l
(
cuºít
, 
code
, 
addr
);

659 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/ªg£t.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/u£r.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/£curôy.h
>

21 
	~<löux/audô.h
>

22 
	~<löux/£ccomp.h
>

23 
	~<löux/sig«l.h
>

24 
	~<löux/w‹kqueue.h
>

26 
	~<asm/uac˚ss.h
>

27 
	~<asm/pgèbÀ.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/¥o˚ss‹.h
>

30 
	~<asm/i387.h
>

31 
	~<asm/debugªg.h
>

32 
	~<asm/ldt.h
>

33 
	~<asm/desc.h
>

34 
	~<asm/¥˘l.h
>

35 
	~<asm/¥Ÿo.h
>

36 
	~<asm/ds.h
>

38 
	~<åa˚/sysˇŒ.h
>

40 
	~"és.h
"

42 
	ex86_ªg£t
 {

43 
	mREGSET_GENERAL
,

44 
	mREGSET_FP
,

45 
	mREGSET_XFP
,

46 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

47 
	mREGSET_TLS
,

48 
	mREGSET_IOPERM32
,

59 
	#FLAG_MASK_32
 (() \

60 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

61 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

62 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

63 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

64 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

69 
ölöe
 
boﬁ
 
	$övÆid_£À˘‹
(
u16
 
vÆue
)

71  
	`u∆ikñy
(
vÆue
 !0 && (vÆuê& 
SEGMENT_RPL_MASK
Ë!
USER_RPL
);

72 
	}
}

74 #ifde‡
CONFIG_X86_32


76 
	#FLAG_MASK
 
FLAG_MASK_32


	)

78 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
ªgno
)

80 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
bx
) != 0);

81  &
ªgs
->
bx
 + (
ªgno
 >> 2);

82 
	}
}

84 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

89 
ªtvÆ
;

90 i‡(
off£t
 !
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
))

91 
ªtvÆ
 = *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

93 i‡(
èsk
 =
cuºít
)

94 
ªtvÆ
 = 
	`gë_u£r_gs
(
	`èsk_±_ªgs
(
èsk
));

96 
ªtvÆ
 = 
	`èsk_u£r_gs
(
èsk
);

98  
ªtvÆ
;

99 
	}
}

101 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

102 
off£t
, 
u16
 
vÆue
)

107 i‡(
	`övÆid_£À˘‹
(
vÆue
))

108  -
EIO
;

119 
off£t
) {

120 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

121 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

122 i‡(
	`u∆ikñy
(
vÆue
 == 0))

123  -
EIO
;

126 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
Ë
vÆue
;

129 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

130 i‡(
èsk
 =
cuºít
)

131 
	`£t_u£r_gs
(
	`èsk_±_ªgs
(
èsk
), 
vÆue
);

133 
	`èsk_u£r_gs
(
èsk
Ë
vÆue
;

137 
	}
}

139 
	$debugªg_addr_limô
(
èsk_°ru˘
 *
èsk
)

141  
TASK_SIZE
 - 3;

142 
	}
}

146 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

148 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
off£t
)

150 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
r15
) != 0);

151  &
ªgs
->
r15
 + (
off£t
 / (regs->r15));

152 
	}
}

154 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

159 
£g
;

161 
off£t
) {

162 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

163 i‡(
èsk
 =
cuºít
) {

165 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

166  
£g
;

168  
èsk
->
thªad
.
fsödex
;

169 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

170 i‡(
èsk
 =
cuºít
) {

171 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

172  
£g
;

174  
èsk
->
thªad
.
gsödex
;

175 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

176 i‡(
èsk
 =
cuºít
) {

177 
	`asm
("mov»%%ds,%0" : "Ù" (
£g
));

178  
£g
;

180  
èsk
->
thªad
.
ds
;

181 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

182 i‡(
èsk
 =
cuºít
) {

183 
	`asm
("mov»%%es,%0" : "Ù" (
£g
));

184  
£g
;

186  
èsk
->
thªad
.
es
;

188 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

189 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

192  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

193 
	}
}

195 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

196 
off£t
, 
u16
 
vÆue
)

201 i‡(
	`övÆid_£À˘‹
(
vÆue
))

202  -
EIO
;

204 
off£t
) {

205 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs
):

210 i‡((
vÆue
 =
FS_TLS_SEL
 && 
èsk
->
thªad
.
fsödex
 == 0 &&

211 
èsk
->
thªad
.
fs
 != 0) ||

212 (
vÆue
 =0 && 
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
 &&

213 
èsk
->
thªad
.
fs
 == 0))

215 
èsk
->
thªad
.
fsödex
 = 
vÆue
;

216 i‡(
èsk
 =
cuºít
)

217 
	`lﬂd£gmít
(
fs
, 
èsk
->
thªad
.
fsödex
);

219 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs
):

224 i‡((
vÆue
 =
GS_TLS_SEL
 && 
èsk
->
thªad
.
gsödex
 == 0 &&

225 
èsk
->
thªad
.
gs
 != 0) ||

226 (
vÆue
 =0 && 
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
 &&

227 
èsk
->
thªad
.
gs
 == 0))

229 
èsk
->
thªad
.
gsödex
 = 
vÆue
;

230 i‡(
èsk
 =
cuºít
)

231 
	`lﬂd_gs_ödex
(
èsk
->
thªad
.
gsödex
);

233 
	`off£tof
(
u£r_ªgs_°ru˘
,
ds
):

234 
èsk
->
thªad
.
ds
 = 
vÆue
;

235 i‡(
èsk
 =
cuºít
)

236 
	`lﬂd£gmít
(
ds
, 
èsk
->
thªad
.ds);

238 
	`off£tof
(
u£r_ªgs_°ru˘
,
es
):

239 
èsk
->
thªad
.
es
 = 
vÆue
;

240 i‡(
èsk
 =
cuºít
)

241 
	`lﬂd£gmít
(
es
, 
èsk
->
thªad
.es);

247 
	`off£tof
(
u£r_ªgs_°ru˘
,
cs
):

248 i‡(
	`u∆ikñy
(
vÆue
 == 0))

249  -
EIO
;

250 #ifde‡
CONFIG_IA32_EMULATION


251 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

252 
	`èsk_±_ªgs
(
èsk
)->
cs
 = 
vÆue
;

255 
	`off£tof
(
u£r_ªgs_°ru˘
,
ss
):

256 i‡(
	`u∆ikñy
(
vÆue
 == 0))

257  -
EIO
;

258 #ifde‡
CONFIG_IA32_EMULATION


259 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

260 
	`èsk_±_ªgs
(
èsk
)->
ss
 = 
vÆue
;

266 
	}
}

268 
	$debugªg_addr_limô
(
èsk_°ru˘
 *
èsk
)

270 #ifde‡
CONFIG_IA32_EMULATION


271 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

272  
IA32_PAGE_OFFSET
 - 3;

274  
TASK_SIZE_MAX
 - 7;

275 
	}
}

279 
	$gë_Êags
(
èsk_°ru˘
 *
èsk
)

281 
ªtvÆ
 = 
	`èsk_±_ªgs
(
èsk
)->
Êags
;

286 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

287 
ªtvÆ
 &~
X86_EFLAGS_TF
;

289  
ªtvÆ
;

290 
	}
}

292 
	$£t_Êags
(
èsk_°ru˘
 *
èsk
, 
vÆue
)

294 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

301 i‡(
vÆue
 & 
X86_EFLAGS_TF
)

302 
	`˛ór_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
);

303 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

304 
vÆue
 |
X86_EFLAGS_TF
;

306 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FLAG_MASK
Ë| (
vÆue
 & FLAG_MASK);

309 
	}
}

311 
	$puåeg
(
èsk_°ru˘
 *
chûd
,

312 
off£t
, 
vÆue
)

314 
off£t
) {

315 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

316 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

317 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

318 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

319 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

320 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

321  
	`£t_£gmít_ªg
(
chûd
, 
off£t
, 
vÆue
);

323 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

324  
	`£t_Êags
(
chûd
, 
vÆue
);

326 #ifde‡
CONFIG_X86_64


333 
	`off£tof
(
u£r_ªgs_°ru˘
, 
‹ig_ax
):

334 
vÆue
 = (Ë(
s32
) value;

337 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs_ba£
):

338 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

339  -
EIO
;

345 i‡(
chûd
->
thªad
.
fs
 !
vÆue
)

346  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_FS
, 
vÆue
);

348 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs_ba£
):

352 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

353  -
EIO
;

354 i‡(
chûd
->
thªad
.
gs
 !
vÆue
)

355  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_GS
, 
vÆue
);

360 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
chûd
), 
off£t
Ë
vÆue
;

362 
	}
}

364 
	$gëªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

366 
off£t
) {

367 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

368 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

369 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

370 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

371 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

372 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

373  
	`gë_£gmít_ªg
(
èsk
, 
off£t
);

375 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

376  
	`gë_Êags
(
èsk
);

378 #ifde‡
CONFIG_X86_64


379 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs_ba£
): {

385 
£g
 = 
èsk
->
thªad
.
fsödex
;

386 i‡(
èsk
->
thªad
.
fs
 != 0)

387  
èsk
->
thªad
.
fs
;

388 i‡(
èsk
 =
cuºít
)

389 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

390 i‡(
£g
 !
FS_TLS_SEL
)

392  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
FS_TLS
]);

394 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs_ba£
): {

398 
£g
 = 
èsk
->
thªad
.
gsödex
;

399 i‡(
èsk
->
thªad
.
gs
 != 0)

400  
èsk
->
thªad
.
gs
;

401 i‡(
èsk
 =
cuºít
)

402 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

403 i‡(
£g
 !
GS_TLS_SEL
)

405  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
GS_TLS
]);

410  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

411 
	}
}

413 
	$gíªgs_gë
(
èsk_°ru˘
 *
èrgë
,

414 c⁄° 
u£r_ªg£t
 *
ªg£t
,

415 
pos
, 
cou¡
,

416 *
kbuf
, 
__u£r
 *
ubuf
)

418 i‡(
kbuf
) {

419 *
k
 = 
kbuf
;

420 
cou¡
 > 0) {

421 *
k
++ = 
	`gëªg
(
èrgë
, 
pos
);

422 
cou¡
 -(*
k
);

423 
pos
 +(*
k
);

426 
__u£r
 *
u
 = 
ubuf
;

427 
cou¡
 > 0) {

428 i‡(
	`__put_u£r
(
	`gëªg
(
èrgë
, 
pos
), 
u
++))

429  -
EFAULT
;

430 
cou¡
 -(*
u
);

431 
pos
 +(*
u
);

436 
	}
}

438 
	$gíªgs_£t
(
èsk_°ru˘
 *
èrgë
,

439 c⁄° 
u£r_ªg£t
 *
ªg£t
,

440 
pos
, 
cou¡
,

441 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

443 
ªt
 = 0;

444 i‡(
kbuf
) {

445 c⁄° *
k
 = 
kbuf
;

446 
cou¡
 > 0 && !
ªt
) {

447 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, *
k
++);

448 
cou¡
 -(*
k
);

449 
pos
 +(*
k
);

452 c⁄° 
__u£r
 *
u
 = 
ubuf
;

453 
cou¡
 > 0 && !
ªt
) {

454 
w‹d
;

455 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

456 i‡(
ªt
)

458 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, 
w‹d
);

459 
cou¡
 -(*
u
);

460 
pos
 +(*
u
);

463  
ªt
;

464 
	}
}

471 
	$±ø˚_gë_debugªg
(
èsk_°ru˘
 *
chûd
, 
n
)

473 
n
) {

474 0:  
chûd
->
thªad
.
debugªg0
;

475 1:  
chûd
->
thªad
.
debugªg1
;

476 2:  
chûd
->
thªad
.
debugªg2
;

477 3:  
chûd
->
thªad
.
debugªg3
;

478 6:  
chûd
->
thªad
.
debugªg6
;

479 7:  
chûd
->
thªad
.
debugªg7
;

482 
	}
}

484 
	$±ø˚_£t_debugªg
(
èsk_°ru˘
 *
chûd
,

485 
n
, 
d©a
)

487 
i
;

489 i‡(
	`u∆ikñy
(
n
 == 4 ||Ç == 5))

490  -
EIO
;

492 i‡(
n
 < 4 && 
	`u∆ikñy
(
d©a
 >
	`debugªg_addr_limô
(
chûd
)))

493  -
EIO
;

495 
n
) {

496 0: 
chûd
->
thªad
.
debugªg0
 = 
d©a
; ;

497 1: 
chûd
->
thªad
.
debugªg1
 = 
d©a
; ;

498 2: 
chûd
->
thªad
.
debugªg2
 = 
d©a
; ;

499 3: 
chûd
->
thªad
.
debugªg3
 = 
d©a
; ;

502 i‡((
d©a
 & ~0xffffffffUL) != 0)

503  -
EIO
;

504 
chûd
->
thªad
.
debugªg6
 = 
d©a
;

538 #ifde‡
CONFIG_X86_32


539 
	#DR7_MASK
 0x5f54

	)

541 
	#DR7_MASK
 0x5554

	)

543 
d©a
 &~
DR_CONTROL_RESERVED
;

544 
i
 = 0; i < 4; i++)

545 i‡((
DR7_MASK
 >> ((
d©a
 >> (16 + 4*
i
)) & 0xf)) & 1)

546  -
EIO
;

547 
chûd
->
thªad
.
debugªg7
 = 
d©a
;

548 i‡(
d©a
)

549 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUG
);

551 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUG
);

556 
	}
}

562 
	$i›îm_a˘ive
(
èsk_°ru˘
 *
èrgë
,

563 c⁄° 
u£r_ªg£t
 *
ªg£t
)

565  
èrgë
->
thªad
.
io_bôm≠_max
 / 
ªg£t
->
size
;

566 
	}
}

568 
	$i›îm_gë
(
èsk_°ru˘
 *
èrgë
,

569 c⁄° 
u£r_ªg£t
 *
ªg£t
,

570 
pos
, 
cou¡
,

571 *
kbuf
, 
__u£r
 *
ubuf
)

573 i‡(!
èrgë
->
thªad
.
io_bôm≠_±r
)

574  -
ENXIO
;

576  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

577 
èrgë
->
thªad
.
io_bôm≠_±r
,

578 0, 
IO_BITMAP_BYTES
);

579 
	}
}

581 #ifde‡
CONFIG_X86_PTRACE_BTS


599 
	sbts_c⁄ãxt
 {

601 
bts_åa˚r
 *
	måa˚r
;

604 *
	mbuf„r
;

605 
	msize
;

608 
mm_°ru˘
 *
	mmm
;

611 
èsk_°ru˘
 *
	mèsk
;

614 
	mbts_ovÊ_sig«l
;

617 
w‹k_°ru˘
 
	mw‹k
;

620 
	$Æloc_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
, 
size
)

622 *
buf„r
 = 
NULL
;

623 
îr
 = -
ENOMEM
;

625 
îr
 = 
	`accou¡_locked_mem‹y
(
cuºít
->
mm
, cuºít->
sig«l
->
æim
, 
size
);

626 i‡(
îr
 < 0)

627  
îr
;

629 
buf„r
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

630 i‡(!
buf„r
)

631 
out_ªfund
;

633 
c⁄ãxt
->
buf„r
 = buffer;

634 
c⁄ãxt
->
size
 = size;

635 
c⁄ãxt
->
mm
 = 
	`gë_èsk_mm
(
cuºít
);

639 
out_ªfund
:

640 
	`ªfund_locked_mem‹y
(
cuºít
->
mm
, 
size
);

641  
îr
;

642 
	}
}

644 
ölöe
 
	$‰ì_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
)

646 i‡(!
c⁄ãxt
->
buf„r
)

649 
	`k‰ì
(
c⁄ãxt
->
buf„r
);

650 
c⁄ãxt
->
buf„r
 = 
NULL
;

652 
	`ªfund_locked_mem‹y
(
c⁄ãxt
->
mm
, c⁄ãxt->
size
);

653 
c⁄ãxt
->
size
 = 0;

655 
	`mmput
(
c⁄ãxt
->
mm
);

656 
c⁄ãxt
->
mm
 = 
NULL
;

657 
	}
}

659 
	$‰ì_bts_c⁄ãxt_w‹k
(
w‹k_°ru˘
 *
w
)

661 
bts_c⁄ãxt
 *
c⁄ãxt
;

663 
c⁄ãxt
 = 
	`c⁄èöî_of
(
w
, 
bts_c⁄ãxt
, 
w‹k
);

665 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

666 
	`put_èsk_°ru˘
(
c⁄ãxt
->
èsk
);

667 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

668 
	`k‰ì
(
c⁄ãxt
);

669 
	}
}

671 
ölöe
 
	$‰ì_bts_c⁄ãxt
(
bts_c⁄ãxt
 *
c⁄ãxt
)

673 
	`INIT_WORK
(&
c⁄ãxt
->
w‹k
, 
‰ì_bts_c⁄ãxt_w‹k
);

674 
	`scheduÀ_w‹k
(&
c⁄ãxt
->
w‹k
);

675 
	}
}

677 
ölöe
 
bts_c⁄ãxt
 *
	$Æloc_bts_c⁄ãxt
(
èsk_°ru˘
 *
èsk
)

679 
bts_c⁄ãxt
 *
c⁄ãxt
 = 
	`kzÆloc
((*c⁄ãxt), 
GFP_KERNEL
);

680 i‡(
c⁄ãxt
) {

681 
c⁄ãxt
->
èsk
 =Åask;

682 
èsk
->
bts
 = 
c⁄ãxt
;

684 
	`gë_èsk_°ru˘
(
èsk
);

687  
c⁄ãxt
;

688 
	}
}

690 
	$±ø˚_bts_ªad_ªc‹d
(
èsk_°ru˘
 *
chûd
, 
size_t
 
ödex
,

691 
bts_°ru˘
 
__u£r
 *
out
)

693 
bts_c⁄ãxt
 *
c⁄ãxt
;

694 c⁄° 
bts_åa˚
 *
åa˚
;

695 
bts_°ru˘
 
bts
;

696 c⁄° *
©
;

697 
îr‹
;

699 
c⁄ãxt
 = 
chûd
->
bts
;

700 i‡(!
c⁄ãxt
)

701  -
ESRCH
;

703 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

704 i‡(!
åa˚
)

705  -
ESRCH
;

707 
©
 = 
åa˚
->
ds
.
t›
 - ((
ödex
 + 1Ë*Åø˚->ds.
size
);

708 i‡((*)
©
 < 
åa˚
->
ds
.
begö
)

709 
©
 +(
åa˚
->
ds
.
n
 *Åø˚->ds.
size
);

711 i‡(!
åa˚
->
ªad
)

712  -
EOPNOTSUPP
;

714 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

715 i‡(
îr‹
 < 0)

716  
îr‹
;

718 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

719  -
EFAULT
;

721  (
bts
);

722 
	}
}

724 
	$±ø˚_bts_døö
(
èsk_°ru˘
 *
chûd
,

725 
size
,

726 
bts_°ru˘
 
__u£r
 *
out
)

728 
bts_c⁄ãxt
 *
c⁄ãxt
;

729 c⁄° 
bts_åa˚
 *
åa˚
;

730 c⁄° *
©
;

731 
îr‹
, 
døöed
 = 0;

733 
c⁄ãxt
 = 
chûd
->
bts
;

734 i‡(!
c⁄ãxt
)

735  -
ESRCH
;

737 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

738 i‡(!
åa˚
)

739  -
ESRCH
;

741 i‡(!
åa˚
->
ªad
)

742  -
EOPNOTSUPP
;

744 i‡(
size
 < (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
))

745  -
EIO
;

747 
©
 = 
åa˚
->
ds
.
begö
; (*Ôà<Åø˚->ds.
t›
;

748 
out
++, 
døöed
++, 
©
 +
åa˚
->
ds
.
size
) {

749 
bts_°ru˘
 
bts
;

751 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

752 i‡(
îr‹
 < 0)

753  
îr‹
;

755 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

756  -
EFAULT
;

759 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

761 
îr‹
 = 
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

762 i‡(
îr‹
 < 0)

763  
îr‹
;

765  
døöed
;

766 
	}
}

768 
	$±ø˚_bts_c⁄fig
(
èsk_°ru˘
 *
chûd
,

769 
cfg_size
,

770 c⁄° 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

772 
bts_c⁄ãxt
 *
c⁄ãxt
;

773 
±ø˚_bts_c⁄fig
 
cfg
;

774 
Êags
 = 0;

776 i‡(
cfg_size
 < (
cfg
))

777  -
EIO
;

779 i‡(
	`c›y_‰om_u£r
(&
cfg
, 
ucfg
, (cfg)))

780  -
EFAULT
;

782 
c⁄ãxt
 = 
chûd
->
bts
;

783 i‡(!
c⁄ãxt
)

784 
c⁄ãxt
 = 
	`Æloc_bts_c⁄ãxt
(
chûd
);

785 i‡(!
c⁄ãxt
)

786  -
ENOMEM
;

788 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SIGNAL
) {

789 i‡(!
cfg
.
sig«l
)

790  -
EINVAL
;

792  -
EOPNOTSUPP
;

793 
c⁄ãxt
->
bts_ovÊ_sig«l
 = 
cfg
.
sig«l
;

796 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

797 
c⁄ãxt
->
åa˚r
 = 
NULL
;

799 i‡((
cfg
.
Êags
 & 
PTRACE_BTS_O_ALLOC
Ë&& (cfg.
size
 !
c⁄ãxt
->size)) {

800 
îr
;

802 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

803 i‡(!
cfg
.
size
)

806 
îr
 = 
	`Æloc_bts_buf„r
(
c⁄ãxt
, 
cfg
.
size
);

807 i‡(
îr
 < 0)

808  
îr
;

811 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_TRACE
)

812 
Êags
 |
BTS_USER
;

814 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SCHED
)

815 
Êags
 |
BTS_TIMESTAMPS
;

817 
c⁄ãxt
->
åa˚r
 =

818 
	`ds_ªque°_bts_èsk
(
chûd
, 
c⁄ãxt
->
buf„r
, c⁄ãxt->
size
,

819 
NULL
, (
size_t
)-1, 
Êags
);

820 i‡(
	`u∆ikñy
(
	`IS_ERR
(
c⁄ãxt
->
åa˚r
))) {

821 
îr‹
 = 
	`PTR_ERR
(
c⁄ãxt
->
åa˚r
);

823 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

824 
c⁄ãxt
->
åa˚r
 = 
NULL
;

825  
îr‹
;

828  (
cfg
);

829 
	}
}

831 
	$±ø˚_bts_°©us
(
èsk_°ru˘
 *
chûd
,

832 
cfg_size
,

833 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

835 
bts_c⁄ãxt
 *
c⁄ãxt
;

836 c⁄° 
bts_åa˚
 *
åa˚
;

837 
±ø˚_bts_c⁄fig
 
cfg
;

839 
c⁄ãxt
 = 
chûd
->
bts
;

840 i‡(!
c⁄ãxt
)

841  -
ESRCH
;

843 i‡(
cfg_size
 < (
cfg
))

844  -
EIO
;

846 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

847 i‡(!
åa˚
)

848  -
ESRCH
;

850 
	`mem£t
(&
cfg
, 0, (cfg));

851 
cfg
.
size
 = 
åa˚
->
ds
.
íd
 -Åø˚->ds.
begö
;

852 
cfg
.
sig«l
 = 
c⁄ãxt
->
bts_ovÊ_sig«l
;

853 
cfg
.
bts_size
 = (
bts_°ru˘
);

855 i‡(
cfg
.
sig«l
)

856 
cfg
.
Êags
 |
PTRACE_BTS_O_SIGNAL
;

858 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_USER
)

859 
cfg
.
Êags
 |
PTRACE_BTS_O_TRACE
;

861 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_TIMESTAMPS
)

862 
cfg
.
Êags
 |
PTRACE_BTS_O_SCHED
;

864 i‡(
	`c›y_to_u£r
(
ucfg
, &
cfg
, (cfg)))

865  -
EFAULT
;

867  (
cfg
);

868 
	}
}

870 
	$±ø˚_bts_˛ór
(
èsk_°ru˘
 *
chûd
)

872 
bts_c⁄ãxt
 *
c⁄ãxt
;

873 c⁄° 
bts_åa˚
 *
åa˚
;

875 
c⁄ãxt
 = 
chûd
->
bts
;

876 i‡(!
c⁄ãxt
)

877  -
ESRCH
;

879 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

880 i‡(!
åa˚
)

881  -
ESRCH
;

883 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

885  
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

886 
	}
}

888 
	$±ø˚_bts_size
(
èsk_°ru˘
 *
chûd
)

890 
bts_c⁄ãxt
 *
c⁄ãxt
;

891 c⁄° 
bts_åa˚
 *
åa˚
;

893 
c⁄ãxt
 = 
chûd
->
bts
;

894 i‡(!
c⁄ãxt
)

895  -
ESRCH
;

897 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

898 i‡(!
åa˚
)

899  -
ESRCH
;

901  (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
Ë/Åø˚->ds.
size
;

902 
	}
}

908 
	$±ø˚_bts_u¡ø˚
(
èsk_°ru˘
 *
chûd
)

910 i‡(
	`u∆ikñy
(
chûd
->
bts
)) {

911 
	`‰ì_bts_c⁄ãxt
(
chûd
->
bts
);

912 
chûd
->
bts
 = 
NULL
;

914 
	}
}

922 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

924 
	`u£r_dißbÀ_sögÀ_°ï
(
chûd
);

925 #ifde‡
TIF_SYSCALL_EMU


926 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_EMU
);

928 
	}
}

930 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


931 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
;

934 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

936 
ªt
;

937 
__u£r
 *
d©≠
 = (__u£∏*)
d©a
;

939 
ªque°
) {

941 
PTRACE_PEEKUSR
: {

942 
tmp
;

944 
ªt
 = -
EIO
;

945 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

946 
addr
 >(
u£r
))

949 
tmp
 = 0;

950 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

951 
tmp
 = 
	`gëªg
(
chûd
, 
addr
);

952 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

953 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

954 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

955 
tmp
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
addr
 / (
d©a
));

957 
ªt
 = 
	`put_u£r
(
tmp
, 
d©≠
);

961 
PTRACE_POKEUSR
:

962 
ªt
 = -
EIO
;

963 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

964 
addr
 >(
u£r
))

967 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

968 
ªt
 = 
	`puåeg
(
chûd
, 
addr
, 
d©a
);

969 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

970 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

971 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

972 
ªt
 = 
	`±ø˚_£t_debugªg
(
chûd
,

973 
addr
 / (
d©a
), data);

977 
PTRACE_GETREGS
:

978  
	`c›y_ªg£t_to_u£r
(
chûd
,

979 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

980 
REGSET_GENERAL
,

981 0, (
u£r_ªgs_°ru˘
),

982 
d©≠
);

984 
PTRACE_SETREGS
:

985  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

986 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

987 
REGSET_GENERAL
,

988 0, (
u£r_ªgs_°ru˘
),

989 
d©≠
);

991 
PTRACE_GETFPREGS
:

992  
	`c›y_ªg£t_to_u£r
(
chûd
,

993 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

994 
REGSET_FP
,

995 0, (
u£r_i387_°ru˘
),

996 
d©≠
);

998 
PTRACE_SETFPREGS
:

999  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

1000 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

1001 
REGSET_FP
,

1002 0, (
u£r_i387_°ru˘
),

1003 
d©≠
);

1005 #ifde‡
CONFIG_X86_32


1006 
PTRACE_GETFPXREGS
:

1007  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1008 
REGSET_XFP
,

1009 0, (
u£r_fx§_°ru˘
),

1010 
d©≠
Ë? -
EIO
 : 0;

1012 
PTRACE_SETFPXREGS
:

1013  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1014 
REGSET_XFP
,

1015 0, (
u£r_fx§_°ru˘
),

1016 
d©≠
Ë? -
EIO
 : 0;

1019 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1020 
PTRACE_GET_THREAD_AREA
:

1021 i‡(
addr
 < 0)

1022  -
EIO
;

1023 
ªt
 = 
	`do_gë_thªad_¨ó
(
chûd
, 
addr
,

1024 (
u£r_desc
 
__u£r
 *Ë
d©a
);

1027 
PTRACE_SET_THREAD_AREA
:

1028 i‡(
addr
 < 0)

1029  -
EIO
;

1030 
ªt
 = 
	`do_£t_thªad_¨ó
(
chûd
, 
addr
,

1031 (
u£r_desc
 
__u£r
 *Ë
d©a
, 0);

1035 #ifde‡
CONFIG_X86_64


1039 
PTRACE_ARCH_PRCTL
:

1040 
ªt
 = 
	`do_¨ch_¥˘l
(
chûd
, 
d©a
, 
addr
);

1047 #ifde‡
CONFIG_X86_PTRACE_BTS


1048 
PTRACE_BTS_CONFIG
:

1049 
ªt
 = 
±ø˚_bts_c⁄fig


1050 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1053 
PTRACE_BTS_STATUS
:

1054 
ªt
 = 
±ø˚_bts_°©us


1055 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1058 
PTRACE_BTS_SIZE
:

1059 
ªt
 = 
	`±ø˚_bts_size
(
chûd
);

1062 
PTRACE_BTS_GET
:

1063 
ªt
 = 
±ø˚_bts_ªad_ªc‹d


1064 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1067 
PTRACE_BTS_CLEAR
:

1068 
ªt
 = 
	`±ø˚_bts_˛ór
(
chûd
);

1071 
PTRACE_BTS_DRAIN
:

1072 
ªt
 = 
±ø˚_bts_døö


1073 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1078 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1082  
ªt
;

1083 
	}
}

1085 #ifde‡
CONFIG_IA32_EMULATION


1087 
	~<löux/com∑t.h
>

1088 
	~<löux/sysˇŒs.h
>

1089 
	~<asm/ü32.h
>

1090 
	~<asm/u£r32.h
>

1092 
	#R32
(
l
,
q
) \

1093 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1094 
ªgs
->
q
 = 
vÆue
; 

	)

1096 
	#SEG32
(
rs
) \

1097 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1098  
	`£t_£gmít_ªg
(
chûd
, \

1099 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
), \

1100 
vÆue
); \

1101 

	)

1103 
	$puåeg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 
vÆue
)

1105 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1107 
ªgno
) {

1109 
	`SEG32
(
cs
);

1110 
	`SEG32
(
ds
);

1111 
	`SEG32
(
es
);

1112 
	`SEG32
(
fs
);

1113 
	`SEG32
(
gs
);

1114 
	`SEG32
(
ss
);

1116 
	`R32
(
ebx
, 
bx
);

1117 
	`R32
(
ecx
, 
cx
);

1118 
	`R32
(
edx
, 
dx
);

1119 
	`R32
(
edi
, 
di
);

1120 
	`R32
(
esi
, 
si
);

1121 
	`R32
(
ebp
, 
bp
);

1122 
	`R32
(
óx
, 
ax
);

1123 
	`R32
(
eù
, 
ù
);

1124 
	`R32
(
e•
, 
•
);

1126 
	`off£tof
(
u£r32
, 
ªgs
.
‹ig_óx
):

1131 
ªgs
->
‹ig_ax
 = (Ë(
s32
Ë
vÆue
;

1134 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1135  
	`£t_Êags
(
chûd
, 
vÆue
);

1137 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1138 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1139 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1140  
	`±ø˚_£t_debugªg
(
chûd
, 
ªgno
 / 4, 
vÆue
);

1143 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1144  -
EIO
;

1153 
	}
}

1155 #unde‡
R32


1156 #unde‡
SEG32


1158 
	#R32
(
l
,
q
) \

1159 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1160 *
vÆ
 = 
ªgs
->
q
; 

	)

1162 
	#SEG32
(
rs
) \

1163 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1164 *
vÆ
 = 
	`gë_£gmít_ªg
(
chûd
, \

1165 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
)); \

1166 

	)

1168 
	$gëªg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 *
vÆ
)

1170 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1172 
ªgno
) {

1174 
	`SEG32
(
ds
);

1175 
	`SEG32
(
es
);

1176 
	`SEG32
(
fs
);

1177 
	`SEG32
(
gs
);

1179 
	`R32
(
cs
, cs);

1180 
	`R32
(
ss
, ss);

1181 
	`R32
(
ebx
, 
bx
);

1182 
	`R32
(
ecx
, 
cx
);

1183 
	`R32
(
edx
, 
dx
);

1184 
	`R32
(
edi
, 
di
);

1185 
	`R32
(
esi
, 
si
);

1186 
	`R32
(
ebp
, 
bp
);

1187 
	`R32
(
óx
, 
ax
);

1188 
	`R32
(
‹ig_óx
, 
‹ig_ax
);

1189 
	`R32
(
eù
, 
ù
);

1190 
	`R32
(
e•
, 
•
);

1192 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1193 *
vÆ
 = 
	`gë_Êags
(
chûd
);

1196 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1197 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1198 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1199 *
vÆ
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
ªgno
 / 4);

1203 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1204  -
EIO
;

1210 *
vÆ
 = 0;

1214 
	}
}

1216 #unde‡
R32


1217 #unde‡
SEG32


1219 
	$gíªgs32_gë
(
èsk_°ru˘
 *
èrgë
,

1220 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1221 
pos
, 
cou¡
,

1222 *
kbuf
, 
__u£r
 *
ubuf
)

1224 i‡(
kbuf
) {

1225 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1226 
cou¡
 > 0) {

1227 
	`gëªg32
(
èrgë
, 
pos
, 
k
++);

1228 
cou¡
 -(*
k
);

1229 
pos
 +(*
k
);

1232 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1233 
cou¡
 > 0) {

1234 
com∑t_ul⁄g_t
 
w‹d
;

1235 
	`gëªg32
(
èrgë
, 
pos
, &
w‹d
);

1236 i‡(
	`__put_u£r
(
w‹d
, 
u
++))

1237  -
EFAULT
;

1238 
cou¡
 -(*
u
);

1239 
pos
 +(*
u
);

1244 
	}
}

1246 
	$gíªgs32_£t
(
èsk_°ru˘
 *
èrgë
,

1247 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1248 
pos
, 
cou¡
,

1249 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

1251 
ªt
 = 0;

1252 i‡(
kbuf
) {

1253 c⁄° 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1254 
cou¡
 > 0 && !
ªt
) {

1255 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, *
k
++);

1256 
cou¡
 -(*
k
);

1257 
pos
 +(*
k
);

1260 c⁄° 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1261 
cou¡
 > 0 && !
ªt
) {

1262 
com∑t_ul⁄g_t
 
w‹d
;

1263 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

1264 i‡(
ªt
)

1266 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, 
w‹d
);

1267 
cou¡
 -(*
u
);

1268 
pos
 +(*
u
);

1271  
ªt
;

1272 
	}
}

1274 
	$com∑t_¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
com∑t_l⁄g_t
 
ªque°
,

1275 
com∑t_ul⁄g_t
 
ˇddr
, com∑t_ul⁄g_à
cd©a
)

1277 
addr
 = 
ˇddr
;

1278 
d©a
 = 
cd©a
;

1279 
__u£r
 *
d©≠
 = 
	`com∑t_±r
(
d©a
);

1280 
ªt
;

1281 
__u32
 
vÆ
;

1283 
ªque°
) {

1284 
PTRACE_PEEKUSR
:

1285 
ªt
 = 
	`gëªg32
(
chûd
, 
addr
, &
vÆ
);

1286 i‡(
ªt
 == 0)

1287 
ªt
 = 
	`put_u£r
(
vÆ
, (
__u32
 
__u£r
 *)
d©≠
);

1290 
PTRACE_POKEUSR
:

1291 
ªt
 = 
	`puåeg32
(
chûd
, 
addr
, 
d©a
);

1294 
PTRACE_GETREGS
:

1295  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1296 
REGSET_GENERAL
,

1297 0, (
u£r_ªgs_°ru˘32
),

1298 
d©≠
);

1300 
PTRACE_SETREGS
:

1301  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1302 
REGSET_GENERAL
, 0,

1303 (
u£r_ªgs_°ru˘32
),

1304 
d©≠
);

1306 
PTRACE_GETFPREGS
:

1307  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1308 
REGSET_FP
, 0,

1309 (
u£r_i387_ü32_°ru˘
),

1310 
d©≠
);

1312 
PTRACE_SETFPREGS
:

1313  
	`c›y_ªg£t_‰om_u£r
(

1314 
chûd
, &
u£r_x86_32_võw
, 
REGSET_FP
,

1315 0, (
u£r_i387_ü32_°ru˘
), 
d©≠
);

1317 
PTRACE_GETFPXREGS
:

1318  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1319 
REGSET_XFP
, 0,

1320 (
u£r32_fx§_°ru˘
),

1321 
d©≠
);

1323 
PTRACE_SETFPXREGS
:

1324  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1325 
REGSET_XFP
, 0,

1326 (
u£r32_fx§_°ru˘
),

1327 
d©≠
);

1329 
PTRACE_GET_THREAD_AREA
:

1330 
PTRACE_SET_THREAD_AREA
:

1331 #ifde‡
CONFIG_X86_PTRACE_BTS


1332 
PTRACE_BTS_CONFIG
:

1333 
PTRACE_BTS_STATUS
:

1334 
PTRACE_BTS_SIZE
:

1335 
PTRACE_BTS_GET
:

1336 
PTRACE_BTS_CLEAR
:

1337 
PTRACE_BTS_DRAIN
:

1339  
	`¨ch_±ø˚
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1342  
	`com∑t_±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1345  
ªt
;

1346 
	}
}

1350 #ifde‡
CONFIG_X86_64


1352 c⁄° 
u£r_ªg£t
 
	gx86_64_ªg£ts
[] = {

1353 [
REGSET_GENERAL
] = {

1354 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1355 .
	gn
 = (
u£r_ªgs_°ru˘
) / (),

1356 .
	gsize
 = (), .
	gÆign
 = (),

1357 .
	ggë
 = 
gíªgs_gë
, .
	g£t
 = 
gíªgs_£t


1359 [
REGSET_FP
] = {

1360 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1361 .
	gn
 = (
u£r_i387_°ru˘
) / (),

1362 .
	gsize
 = (), .
	gÆign
 = (),

1363 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1365 [
REGSET_IOPERM64
] = {

1366 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1367 .
	gn
 = 
IO_BITMAP_LONGS
,

1368 .
	gsize
 = (), .
	gÆign
 = (),

1369 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1373 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_64_võw
 = {

1374 .
«me
 = "x86_64", .
	ge_machöe
 = 
EM_X86_64
,

1375 .
	gªg£ts
 = 
x86_64_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1380 
	#u£r_ªgs_°ru˘32
 
u£r_ªgs_°ru˘


	)

1381 
	#gíªgs32_gë
 
gíªgs_gë


	)

1382 
	#gíªgs32_£t
 
gíªgs_£t


	)

1384 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

1385 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

1389 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1390 c⁄° 
u£r_ªg£t
 
	gx86_32_ªg£ts
[] = {

1391 [
REGSET_GENERAL
] = {

1392 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1393 .
	gn
 = (
u£r_ªgs_°ru˘32
Ë/ (
u32
),

1394 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1395 .
	ggë
 = 
gíªgs32_gë
, .
	g£t
 = 
gíªgs32_£t


1397 [
REGSET_FP
] = {

1398 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1399 .
	gn
 = (
u£r_i387_ü32_°ru˘
Ë/ (
u32
),

1400 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1401 .
	ga˘ive
 = 
Âªgs_a˘ive
, .
	ggë
 = 
Âªgs_gë
, .
	g£t
 = 
Âªgs_£t


1403 [
REGSET_XFP
] = {

1404 .
c‹e_nŸe_ty≥
 = 
NT_PRXFPREG
,

1405 .
	gn
 = (
u£r32_fx§_°ru˘
Ë/ (
u32
),

1406 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1407 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1409 [
REGSET_TLS
] = {

1410 .
c‹e_nŸe_ty≥
 = 
NT_386_TLS
,

1411 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbüs
 = 
GDT_ENTRY_TLS_MIN
,

1412 .
	gsize
 = (
u£r_desc
),

1413 .
	gÆign
 = (
u£r_desc
),

1414 .
	ga˘ive
 = 
ªg£t_és_a˘ive
,

1415 .
	ggë
 = 
ªg£t_és_gë
, .
	g£t
 = 
ªg£t_és_£t


1417 [
REGSET_IOPERM32
] = {

1418 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1419 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1420 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1421 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1425 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
 = {

1426 .
«me
 = "i386", .
	ge_machöe
 = 
EM_386
,

1427 .
	gªg£ts
 = 
x86_32_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1431 c⁄° 
u£r_ªg£t_võw
 *
	$èsk_u£r_ªg£t_võw
(
èsk_°ru˘
 *
èsk
)

1433 #ifde‡
CONFIG_IA32_EMULATION


1434 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

1436 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1437  &
u£r_x86_32_võw
;

1439 #ifde‡
CONFIG_X86_64


1440  &
u£r_x86_64_võw
;

1442 
	}
}

1444 
	$£nd_sigå≠
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
,

1445 
îr‹_code
, 
si_code
)

1447 
sigöfo
 
öfo
;

1449 
tsk
->
thªad
.
å≠_no
 = 1;

1450 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

1452 
	`mem£t
(&
öfo
, 0, (info));

1453 
öfo
.
si_signo
 = 
SIGTRAP
;

1454 
öfo
.
si_code
 = si_code;

1457 
öfo
.
si_addr
 = 
	`u£r_mode_vm
(
ªgs
Ë? (
__u£r
 *Ëªgs->
ù
 : 
NULL
;

1460 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

1461 
	}
}

1464 #ifde‡
CONFIG_X86_32


1465 
	#IS_IA32
 1

	)

1466 #ñi‡
deföed
 
CONFIG_IA32_EMULATION


1467 
	#IS_IA32
 
	`is_com∑t_èsk
()

	)

1469 
	#IS_IA32
 0

	)

1476 
asmªg∑rm
 
	$sysˇŒ_åa˚_íãr
(
±_ªgs
 *
ªgs
)

1478 
ªt
 = 0;

1487 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
))

1488 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

1491 
	`£cuª_computög
(
ªgs
->
‹ig_ax
);

1493 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1494 
ªt
 = -1L;

1496 i‡((
ªt
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
)) &&

1497 
	`åa˚hook_ªp‹t_sysˇŒ_íåy
(
ªgs
))

1498 
ªt
 = -1L;

1500 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_FTRACE
)))

1501 
	`·ø˚_sysˇŒ_íãr
(
ªgs
);

1503 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
)) {

1504 i‡(
IS_IA32
)

1505 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_I386
,

1506 
ªgs
->
‹ig_ax
,

1507 
ªgs
->
bx
,Ñegs->
cx
,

1508 
ªgs
->
dx
,Ñegs->
si
);

1509 #ifde‡
CONFIG_X86_64


1511 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_X86_64
,

1512 
ªgs
->
‹ig_ax
,

1513 
ªgs
->
di
,Ñegs->
si
,

1514 
ªgs
->
dx
,Ñegs->
r10
);

1518  
ªt
 ?: 
ªgs
->
‹ig_ax
;

1519 
	}
}

1521 
asmªg∑rm
 
	$sysˇŒ_åa˚_Àave
(
±_ªgs
 *
ªgs
)

1523 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
))

1524 
	`audô_sysˇŒ_exô
(
	`AUDITSC_RESULT
(
ªgs
->
ax
),Ñegs->ax);

1526 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_FTRACE
)))

1527 
	`·ø˚_sysˇŒ_exô
(
ªgs
);

1529 i‡(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

1530 
	`åa˚hook_ªp‹t_sysˇŒ_exô
(
ªgs
, 0);

1538 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1545 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
) &&

1546 
	`åa˚hook_c⁄sidî_Áèl_sig«l
(
cuºít
, 
SIGTRAP
))

1547 
	`£nd_sigå≠
(
cuºít
, 
ªgs
, 0, 
TRAP_BRKPT
);

1548 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<löux/pci.h
>

5 
	~<löux/úq.h
>

7 
	~<asm/h≥t.h
>

9 #i‡
deföed
(
CONFIG_X86_IO_APIC
Ë&& deföed(
CONFIG_SMP
Ë&& deföed(
CONFIG_PCI
)

11 
__devöô
 
	$quúk_öãl_úqbÆ™˚
(
pci_dev
 *
dev
)

13 
u8
 
c⁄fig
, 
ªv
;

14 
u16
 
w‹d
;

21 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

22 i‡(
ªv
 > 0x9)

26 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xf4, &
c⁄fig
);

27 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
|0x2);

33 
	`pci_bus_ªad_c⁄fig_w‹d
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
w‹d
);

35 i‡(!(
w‹d
 & (1 << 13))) {

36 
	`dev_öfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noúqdebug_£tup
("");

39 #ifde‡
CONFIG_PROC_FS


40 
no_úq_afföôy
 = 1;

45 i‡(!(
c⁄fig
 & 0x2))

46 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quúk_öãl_úqbÆ™˚
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quúk_öãl_úqbÆ™˚
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quúk_öãl_úqbÆ™˚
);

56 #i‡
deföed
(
CONFIG_HPET_TIMER
)

57 
	gf‹˚_h≥t_addªss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gf‹˚_h≥t_ªsume_ty≥
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_f‹˚_h≥t_ªsume
()

72 
u32
 
vÆ
;

74 i‡(!
f‹˚_h≥t_addªss
)

77 
	`BUG_ON
(
rcba_ba£
 =
NULL
);

80 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

81 i‡(!(
vÆ
 & 0x80)) {

83 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

87 i‡(!(
vÆ
 & 0x80))

88 
	`BUG
();

90 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

93 
	}
}

95 
	$ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

97 
u32
 
vÆ
;

98 
u32
 
	`unöôülized_v¨
(
rcba
);

99 
îr
 = 0;

101 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

104 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 i‡(
rcba
 == 0) {

107 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`i‹em≠_noˇche
(
rcba
, 0x4000);

114 i‡(
rcba_ba£
 =
NULL
) {

115 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

123 i‡(
vÆ
 & 0x80) {

125 
vÆ
 = val & 0x3;

126 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

127 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

128 "0x%lx\n", 
f‹˚_h≥t_addªss
);

129 
	`iounm≠
(
rcba_ba£
);

134 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

137 i‡(!(
vÆ
 & 0x80)) {

138 
îr
 = 1;

140 
vÆ
 = val & 0x3;

141 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

144 i‡(
îr
) {

145 
f‹˚_h≥t_addªss
 = 0;

146 
	`iounm≠
(
rcba_ba£
);

147 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev,

150 
f‹˚_h≥t_ªsume_ty≥
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

152 "0x%lx\n", 
f‹˚_h≥t_addªss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_f‹˚_íabÀ_h≥t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_f‹˚_íabÀ_h≥t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_f‹˚_íabÀ_h≥t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_f‹˚_íabÀ_h≥t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_f‹˚_íabÀ_h≥t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_f‹˚_íabÀ_h≥t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_f‹˚_íabÀ_h≥t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_f‹˚_íabÀ_h≥t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_f‹˚_íabÀ_h≥t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_f‹˚_íabÀ_h≥t
);

177 
pci_dev
 *
	gˇched_dev
;

179 
	$h≥t_¥öt_f‹˚_öfo
()

181 
	`¥ötk
(
KERN_INFO
 "HPETÇotÉnabled in BIOS. "

183 
	}
}

185 
	$ﬁd_ich_f‹˚_h≥t_ªsume
()

187 
u32
 
vÆ
;

188 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

190 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

193 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

194 
gí_˙é
 &= (~(0x7 << 15));

195 
gí_˙é
 |= (0x4 << 15);

197 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, 
gí_˙é
);

198 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

199 
vÆ
 = 
gí_˙é
 >> 15;

200 
vÆ
 &= 0x7;

201 i‡(
vÆ
 == 0x4)

202 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

204 
	`BUG
();

205 
	}
}

207 
	$ﬁd_ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

209 
u32
 
vÆ
;

210 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

212 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

215 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

220 
vÆ
 = 
gí_˙é
 >> 15;

221 
vÆ
 &= 0x7;

222 i‡(
vÆ
 & 0x4) {

223 
vÆ
 &= 0x3;

224 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

225 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

226 
f‹˚_h≥t_addªss
);

234 
gí_˙é
 &= (~(0x7 << 15));

235 
gí_˙é
 |= (0x4 << 15);

236 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0xD0, 
gí_˙é
);

238 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

240 
vÆ
 = 
gí_˙é
 >> 15;

241 
vÆ
 &= 0x7;

242 i‡(
vÆ
 & 0x4) {

244 
vÆ
 &= 0x3;

245 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

246 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

247 "0x%lx\n", 
f‹˚_h≥t_addªss
);

248 
ˇched_dev
 = 
dev
;

249 
f‹˚_h≥t_ªsume_ty≥
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

254 
	}
}

260 
	$ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
(
pci_dev
 *
dev
)

262 i‡(
h≥t_f‹˚_u£r
)

263 
	`ﬁd_ich_f‹˚_íabÀ_h≥t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

282 
	$vt8237_f‹˚_h≥t_ªsume
()

284 
u32
 
vÆ
;

286 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

289 
vÆ
 = 0xfed00000 | 0x80;

290 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, 
vÆ
);

292 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, &
vÆ
);

293 i‡(
vÆ
 & 0x80)

294 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

301 
u32
 
	`unöôülized_v¨
(
vÆ
);

303 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

306 i‡(!
h≥t_f‹˚_u£r
) {

307 
	`h≥t_¥öt_f‹˚_öfo
();

311 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

316 i‡(
vÆ
 & 0x80) {

317 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

318 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

319 
f‹˚_h≥t_addªss
);

327 
vÆ
 = 0xfed00000 | 0x80;

328 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x68, 
vÆ
);

330 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

331 i‡(
vÆ
 & 0x80) {

332 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

333 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

334 "0x%lx\n", 
f‹˚_h≥t_addªss
);

335 
ˇched_dev
 = 
dev
;

336 
f‹˚_h≥t_ªsume_ty≥
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_f‹˚_íabÀ_h≥t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_f‹˚_íabÀ_h≥t
);

348 
	$©i_f‹˚_h≥t_ªsume
()

350 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x14, 0xfed00000);

351 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_ªv
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xac, 
b
);

362 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x70, 
d
);

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
vÆ
;

374 
u8
 
b
;

376 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

379 i‡(!
h≥t_f‹˚_u£r
) {

380 
	`h≥t_¥öt_f‹˚_öfo
();

384 
d
 = 
	`©i_ixp4x0_ªv
(
dev
);

385 i‡(
d
 < 0x82)

389 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x14, 0xfed00000);

390 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x14, &
vÆ
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

397 i‡(!(
b
 & 0x1))

399 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x64, 
d
);

402 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

403 i‡(!(
d
 & (1<<10)))

406 
f‹˚_h≥t_addªss
 = 
vÆ
;

407 
f‹˚_h≥t_ªsume_ty≥
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

409 
f‹˚_h≥t_addªss
);

410 
ˇched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_f‹˚_íabÀ_h≥t
);

418 
	$nvidü_f‹˚_h≥t_ªsume
()

420 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x44, 0xfed00001);

421 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

422 
	}
}

424 
	$nvidü_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

426 
u32
 
	`unöôülized_v¨
(
vÆ
);

428 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

431 i‡(!
h≥t_f‹˚_u£r
) {

432 
	`h≥t_¥öt_f‹˚_öfo
();

436 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x44, 0xfed00001);

437 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x44, &
vÆ
);

438 
f‹˚_h≥t_addªss
 = 
vÆ
 & 0xfffffffe;

439 
f‹˚_h≥t_ªsume_ty≥
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

441 
f‹˚_h≥t_addªss
);

442 
ˇched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidü_f‹˚_íabÀ_h≥t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidü_f‹˚_íabÀ_h≥t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidü_f‹˚_íabÀ_h≥t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidü_f‹˚_íabÀ_h≥t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidü_f‹˚_íabÀ_h≥t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidü_f‹˚_íabÀ_h≥t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidü_f‹˚_íabÀ_h≥t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidü_f‹˚_íabÀ_h≥t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidü_f‹˚_íabÀ_h≥t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidü_f‹˚_íabÀ_h≥t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidü_f‹˚_íabÀ_h≥t
);

472 
	$f‹˚_h≥t_ªsume
()

474 
f‹˚_h≥t_ªsume_ty≥
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_f‹˚_h≥t_ªsume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`ﬁd_ich_f‹˚_h≥t_ªsume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_f‹˚_h≥t_ªsume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidü_f‹˚_h≥t_ªsume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_f‹˚_h≥t_ªsume
();

493 
	}
}

496 #i‡
deföed
(
CONFIG_PCI
Ë&& deföed(
CONFIG_NUMA
)

498 
__öô
 
	$quúk_amd_nb_node
(
pci_dev
 *
dev
)

500 
pci_dev
 *
nb_ht
;

501 
dev‚
;

502 
u32
 
vÆ
;

504 
dev‚
 = 
	`PCI_DEVFN
(
	`PCI_SLOT
(
dev
->devfn), 0);

505 
nb_ht
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, 
dev‚
);

506 i‡(!
nb_ht
)

509 
	`pci_ªad_c⁄fig_dw‹d
(
nb_ht
, 0x60, &
vÆ
);

510 
	`£t_dev_node
(&
dev
->dev, 
vÆ
 & 7);

511 
	`pci_dev_put
(
dev
);

512 
	}
}

514 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

515 
quúk_amd_nb_node
);

516 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
,

517 
quúk_amd_nb_node
);

518 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
,

519 
quúk_amd_nb_node
);

520 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
,

521 
quúk_amd_nb_node
);

522 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_HT
,

523 
quúk_amd_nb_node
);

524 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MAP
,

525 
quúk_amd_nb_node
);

526 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_DRAM
,

527 
quúk_amd_nb_node
);

528 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
,

529 
quúk_amd_nb_node
);

530 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_LINK
,

531 
quúk_amd_nb_node
);

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ªboŸ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/pm.h
>

5 
	~<löux/efi.h
>

6 
	~<löux/dmi.h
>

7 
	~<a˝i/ªboŸ.h
>

8 
	~<asm/io.h
>

9 
	~<asm/≠ic.h
>

10 
	~<asm/desc.h
>

11 
	~<asm/h≥t.h
>

12 
	~<asm/pgèbÀ.h
>

13 
	~<asm/¥Ÿo.h
>

14 
	~<asm/ªboŸ_fixups.h
>

15 
	~<asm/ªboŸ.h
>

16 
	~<asm/pci_x86.h
>

17 
	~<asm/vúãxt.h
>

18 
	~<asm/˝u.h
>

20 #ifde‡
CONFIG_X86_32


21 
	~<löux/˘y≥.h
>

22 
	~<löux/mc146818πc.h
>

24 
	~<asm/iommu.h
>

30 (*
pm_powî_off
)();

31 
	`EXPORT_SYMBOL
(
pm_powî_off
);

33 c⁄° 
desc_±r
 
no_idt
 = {
	}
};

34 
	gªboŸ_mode
;

35 
ªboŸ_ty≥
 
	gªboŸ_ty≥
 = 
BOOT_KBD
;

36 
	gªboŸ_f‹˚
;

38 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_SMP
)

39 
	gªboŸ_˝u
 = -1;

46 
	gªboŸ_emîgícy
;

49 
boﬁ
 
	gp‹t_cf9_ß„
 = 
Ál£
;

63 
__öô
 
	$ªboŸ_£tup
(*
°r
)

66 *
°r
) {

68 
ªboŸ_mode
 = 0x1234;

72 
ªboŸ_mode
 = 0;

75 #ifde‡
CONFIG_X86_32


76 #ifde‡
CONFIG_SMP


78 i‡(
	`isdigô
(*(
°r
+1))) {

79 
ªboŸ_˝u
 = (Ë(*(
°r
+1) - '0');

80 i‡(
	`isdigô
(*(
°r
+2)))

81 
ªboŸ_˝u
 =ÑeboŸ_˝u*10 + ()(*(
°r
+2) - '0');

96 
ªboŸ_ty≥
 = *
°r
;

100 
ªboŸ_f‹˚
 = 1;

104 
°r
 = 
	`°rchr
(str, ',');

105 i‡(
°r
)

106 
°r
++;

111 
	}
}

113 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

116 #ifde‡
CONFIG_X86_32


126 
__öô
 
	$£t_bios_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

128 i‡(
ªboŸ_ty≥
 !
BOOT_BIOS
) {

129 
ªboŸ_ty≥
 = 
BOOT_BIOS
;

130 
	`¥ötk
(
KERN_INFO
 "%†£rõ†bﬂrd dëe˘ed. Sñe˘ög BIOS-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

133 
	}
}

135 
dmi_sy°em_id
 
__öôd©a
 
	gªboŸ_dmi_èbÀ
[] = {

137 .
ˇŒback
 = 
£t_bios_ªboŸ
,

138 .
	gidít
 = "Dell E520",

139 .
	gm©ches
 = {

140 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

141 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

145 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

146 .
	gidít
 = "Dell PowerEdge 1300",

147 .
	gm©ches
 = {

148 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

149 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

153 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

154 .
	gidít
 = "Dell PowerEdge 300",

155 .
	gm©ches
 = {

156 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

157 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

161 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

162 .
	gidít
 = "Dell OptiPlex 745",

163 .
	gm©ches
 = {

164 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

165 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

169 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

170 .
	gidít
 = "Dell OptiPlex 745",

171 .
	gm©ches
 = {

172 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

173 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

174 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

178 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

179 .
	gidít
 = "Dell OptiPlex 745",

180 .
	gm©ches
 = {

181 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

182 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

183 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

187 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

188 .
	gidít
 = "Dell OptiPlex 330",

189 .
	gm©ches
 = {

190 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

191 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

192 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

196 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

197 .
	gidít
 = "Dell OptiPlex 360",

198 .
	gm©ches
 = {

199 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

200 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 360"),

201 
DMI_MATCH
(
DMI_BOARD_NAME
, "0T656F"),

205 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

206 .
	gidít
 = "Dell PowerEdge 2400",

207 .
	gm©ches
 = {

208 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

209 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

213 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

214 .
	gidít
 = "Dell Precision T5400",

215 .
	gm©ches
 = {

216 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

217 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

221 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

222 .
	gidít
 = "HP Compaq Laptop",

223 .
	gm©ches
 = {

224 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

225 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

229 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

230 .
	gidít
 = "Dell XPS710",

231 .
	gm©ches
 = {

232 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

233 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

237 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

238 .
	gidít
 = "Dell DXP061",

239 .
	gm©ches
 = {

240 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

241 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

245 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

246 .
	gidít
 = "Sony VGN-Z540N",

247 .
	gm©ches
 = {

248 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

249 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

253 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

254 .
	gidít
 = "CompuLab SBC-FITPC2",

255 .
	gm©ches
 = {

256 
DMI_MATCH
(
DMI_SYS_VENDOR
, "CompuLab"),

257 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "SBC-FITPC2"),

263 
__öô
 
	$ªboŸ_öô
()

265 
	`dmi_check_sy°em
(
ªboŸ_dmi_èbÀ
);

267 
	}
}

268 
c‹e_öôˇŒ
(
ªboŸ_öô
);

277 
	gªÆ_mode_gdt_íåõs
 [3] =

284 c⁄° 
desc_±r


285 
	gªÆ_mode_gdt
 = {  (
ªÆ_mode_gdt_íåõs
) - 1, ()real_mode_gdt_entries },

286 
	gªÆ_mode_idt
 = { 0x3ff, 0 };

306 c⁄° 
	gªÆ_mode_swôch
 [] =

320 c⁄° 
	gjump_to_bios
 [] =

330 
	$machöe_ªÆ_ª°¨t
(c⁄° *
code
, 
Àngth
)

332 
	`loˇl_úq_dißbÀ
();

343 
	`•ö_lock
(&
πc_lock
);

344 
	`CMOS_WRITE
(0x00, 0x8f);

345 
	`•ö_u∆ock
(&
πc_lock
);

350 
	`mem˝y
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

351 (
sw≠≥r_pg_dú
 [0]Ë* 
KERNEL_PGD_PTRS
);

356 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

363 *((*)0x472Ë
ªboŸ_mode
;

370 
	`mem˝y
((*)(0x1000 - (
ªÆ_mode_swôch
) - 100),

371 
ªÆ_mode_swôch
,  (real_mode_switch));

372 
	`mem˝y
((*)(0x1000 - 100), 
code
, 
Àngth
);

375 
	`lﬂd_idt
(&
ªÆ_mode_idt
);

380 
	`lﬂd_gdt
(&
ªÆ_mode_gdt
);

387 
__asm__
 
	`__vﬁ©ûe__
 ("movl $0x0010,%%eax\n"

397 
__asm__
 
	`__vﬁ©ûe__
 ("ljmp $0x0008,%0"

399 : "i" ((*)(0x1000 -  (
ªÆ_mode_swôch
) - 100)));

400 
	}
}

401 #ifde‡
CONFIG_APM_MODULE


402 
EXPORT_SYMBOL
(
machöe_ªÆ_ª°¨t
);

410 
__öô
 
	$£t_pci_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

412 i‡(
ªboŸ_ty≥
 !
BOOT_CF9
) {

413 
ªboŸ_ty≥
 = 
BOOT_CF9
;

414 
	`¥ötk
(
KERN_INFO
 "%s series board detected. "

415 "Sñe˘ög PCI-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

418 
	}
}

420 
dmi_sy°em_id
 
__öôd©a
 
	gpci_ªboŸ_dmi_èbÀ
[] = {

422 .
ˇŒback
 = 
£t_pci_ªboŸ
,

423 .
	gidít
 = "Apple MacBook5",

424 .
	gm©ches
 = {

425 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

426 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBook5"),

430 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

431 .
	gidít
 = "Apple MacBookPro5",

432 .
	gm©ches
 = {

433 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

434 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBookPro5"),

440 
__öô
 
	$pci_ªboŸ_öô
()

442 
	`dmi_check_sy°em
(
pci_ªboŸ_dmi_èbÀ
);

444 
	}
}

445 
c‹e_öôˇŒ
(
pci_ªboŸ_öô
);

447 
ölöe
 
	$kb_waô
()

449 
i
;

451 
i
 = 0; i < 0x10000; i++) {

452 i‡((
	`öb
(0x64) & 0x02) == 0)

454 
	`udñay
(2);

456 
	}
}

458 
	$vmxoff_nmi
(
˝u
, 
dõ_¨gs
 *
¨gs
)

460 
	`˝u_emîgícy_vmxoff
();

461 
	}
}

465 
	$emîgícy_vmx_dißbÀ_Æl
()

468 
	`loˇl_úq_dißbÀ
();

488 i‡(
	`˝u_has_vmx
(Ë&& 
	`˝u_vmx_íabÀd
()) {

491 
	`˝u_vmxoff
();

494 
	`nmi_shoŸdown_˝us
(
vmxoff_nmi
);

497 
	}
}

500 
__©åibuã__
((
wók
)Ë
	$mach_ªboŸ_fixups
()

502 
	}
}

504 
	$«tive_machöe_emîgícy_ª°¨t
()

506 
i
;

508 i‡(
ªboŸ_emîgícy
)

509 
	`emîgícy_vmx_dißbÀ_Æl
();

512 *((*)
	`__va
(0x472)Ë
ªboŸ_mode
;

516 
ªboŸ_ty≥
) {

517 
BOOT_KBD
:

518 
	`mach_ªboŸ_fixups
();

520 
i
 = 0; i < 10; i++) {

521 
	`kb_waô
();

522 
	`udñay
(50);

523 
	`outb
(0xfe, 0x64);

524 
	`udñay
(50);

527 
BOOT_TRIPLE
:

528 
	`lﬂd_idt
(&
no_idt
);

529 
__asm__
 
	`__vﬁ©ûe__
("int3");

531 
ªboŸ_ty≥
 = 
BOOT_KBD
;

534 #ifde‡
CONFIG_X86_32


535 
BOOT_BIOS
:

536 
	`machöe_ªÆ_ª°¨t
(
jump_to_bios
, (jump_to_bios));

538 
ªboŸ_ty≥
 = 
BOOT_KBD
;

542 
BOOT_ACPI
:

543 
	`a˝i_ªboŸ
();

544 
ªboŸ_ty≥
 = 
BOOT_KBD
;

547 
BOOT_EFI
:

548 i‡(
efi_íabÀd
)

549 
efi
.
	`ª£t_sy°em
(
ªboŸ_mode
 ?

550 
EFI_RESET_WARM
 :

551 
EFI_RESET_COLD
,

552 
EFI_SUCCESS
, 0, 
NULL
);

553 
ªboŸ_ty≥
 = 
BOOT_KBD
;

556 
BOOT_CF9
:

557 
p‹t_cf9_ß„
 = 
åue
;

560 
BOOT_CF9_COND
:

561 i‡(
p‹t_cf9_ß„
) {

562 
u8
 
cf9
 = 
	`öb
(0xcf9) & ~6;

563 
	`outb
(
cf9
|2, 0xcf9);

564 
	`udñay
(50);

565 
	`outb
(
cf9
|6, 0xcf9);

566 
	`udñay
(50);

568 
ªboŸ_ty≥
 = 
BOOT_KBD
;

572 
	}
}

574 
	$«tive_machöe_shutdown
()

577 #ifde‡
CONFIG_SMP


580 
ªboŸ_˝u_id
 = 0;

582 #ifde‡
CONFIG_X86_32


584 i‡((
ªboŸ_˝u
 !-1Ë&& (ªboŸ_˝u < 
ƒ_˝u_ids
) &&

585 
	`˝u_⁄löe
(
ªboŸ_˝u
))

586 
ªboŸ_˝u_id
 = 
ªboŸ_˝u
;

590 i‡(!
	`˝u_⁄löe
(
ªboŸ_˝u_id
))

591 
ªboŸ_˝u_id
 = 
	`smp_¥o˚ss‹_id
();

594 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
ªboŸ_˝u_id
));

599 
	`smp_£nd_°›
();

602 
	`œpic_shutdown
();

604 #ifde‡
CONFIG_X86_IO_APIC


605 
	`dißbÀ_IO_APIC
();

608 #ifde‡
CONFIG_HPET_TIMER


609 
	`h≥t_dißbÀ
();

612 #ifde‡
CONFIG_X86_64


613 
	`pci_iommu_shutdown
();

615 
	}
}

617 
	$__machöe_emîgícy_ª°¨t
(
emîgícy
)

619 
ªboŸ_emîgícy
 = 
emîgícy
;

620 
machöe_›s
.
	`emîgícy_ª°¨t
();

621 
	}
}

623 
	$«tive_machöe_ª°¨t
(*
__unu£d
)

625 
	`¥ötk
("machineÑestart\n");

627 i‡(!
ªboŸ_f‹˚
)

628 
	`machöe_shutdown
();

629 
	`__machöe_emîgícy_ª°¨t
(0);

630 
	}
}

632 
	$«tive_machöe_hÆt
()

635 
	`machöe_shutdown
();

638 
	`°›_this_˝u
(
NULL
);

639 
	}
}

641 
	$«tive_machöe_powî_off
()

643 i‡(
pm_powî_off
) {

644 i‡(!
ªboŸ_f‹˚
)

645 
	`machöe_shutdown
();

646 
	`pm_powî_off
();

648 
	}
}

650 
machöe_›s
 
	gmachöe_›s
 = {

651 .
powî_off
 = 
«tive_machöe_powî_off
,

652 .
	gshutdown
 = 
«tive_machöe_shutdown
,

653 .
	gemîgícy_ª°¨t
 = 
«tive_machöe_emîgícy_ª°¨t
,

654 .
	gª°¨t
 = 
«tive_machöe_ª°¨t
,

655 .
	ghÆt
 = 
«tive_machöe_hÆt
,

656 #ifde‡
CONFIG_KEXEC


657 .
	g¸ash_shutdown
 = 
«tive_machöe_¸ash_shutdown
,

661 
	$machöe_powî_off
()

663 
machöe_›s
.
	`powî_off
();

664 
	}
}

666 
	$machöe_shutdown
()

668 
machöe_›s
.
	`shutdown
();

669 
	}
}

671 
	$machöe_emîgícy_ª°¨t
()

673 
	`__machöe_emîgícy_ª°¨t
(1);

674 
	}
}

676 
	$machöe_ª°¨t
(*
cmd
)

678 
machöe_›s
.
	`ª°¨t
(
cmd
);

679 
	}
}

681 
	$machöe_hÆt
()

683 
machöe_›s
.
	`hÆt
();

684 
	}
}

686 #ifde‡
CONFIG_KEXEC


687 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

689 
machöe_›s
.
	`¸ash_shutdown
(
ªgs
);

690 
	}
}

694 #i‡
deföed
(
CONFIG_SMP
)

697 
	g¸ashög_˝u
;

698 
nmi_shoŸdown_cb
 
	gshoŸdown_ˇŒback
;

700 
©omic_t
 
	gwaôög_f‹_¸ash_ùi
;

702 
	$¸ash_nmi_ˇŒback
(
nŸifõr_block
 *
£lf
,

703 
vÆ
, *
d©a
)

705 
˝u
;

707 i‡(
vÆ
 !
DIE_NMI_IPI
)

708  
NOTIFY_OK
;

710 
˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

716 i‡(
˝u
 =
¸ashög_˝u
)

717  
NOTIFY_STOP
;

718 
	`loˇl_úq_dißbÀ
();

720 
	`shoŸdown_ˇŒback
(
˝u
, (
dõ_¨gs
 *)
d©a
);

722 
	`©omic_dec
(&
waôög_f‹_¸ash_ùi
);

724 
	`hÆt
();

726 
	`˝u_ªœx
();

729 
	}
}

731 
	$smp_£nd_nmi_Ælbut£lf
()

733 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
NMI_VECTOR
);

734 
	}
}

736 
nŸifõr_block
 
	g¸ash_nmi_nb
 = {

737 .
nŸifõr_ˇŒ
 = 
¸ash_nmi_ˇŒback
,

746 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

748 
m£cs
;

749 
	`loˇl_úq_dißbÀ
();

752 
¸ashög_˝u
 = 
	`ß„_smp_¥o˚ss‹_id
();

754 
shoŸdown_ˇŒback
 = 
ˇŒback
;

756 
	`©omic_£t
(&
waôög_f‹_¸ash_ùi
, 
	`num_⁄löe_˝us
() - 1);

758 i‡(
	`ªgi°î_dõ_nŸifõr
(&
¸ash_nmi_nb
))

763 
	`wmb
();

765 
	`smp_£nd_nmi_Ælbut£lf
();

767 
m£cs
 = 1000;

768 (
	`©omic_ªad
(&
waôög_f‹_¸ash_ùi
Ë> 0Ë&& 
m£cs
) {

769 
	`mdñay
(1);

770 
m£cs
--;

774 
	}
}

776 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

779 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<löux/∂©f‹m_devi˚.h
>

5 
	~<löux/mc146818πc.h
>

6 
	~<löux/a˝i.h
>

7 
	~<löux/bcd.h
>

8 
	~<löux/≤p.h
>

10 
	~<asm/vsysˇŒ.h
>

11 
	~<asm/time.h
>

13 #ifde‡
CONFIG_X86_32


19 vﬁ©ûê
	gcmos_lock
;

20 
EXPORT_SYMBOL
(
cmos_lock
);

24 
	#CMOS_YEARS_OFFS
 2000

	)

26 
DEFINE_SPINLOCK
(
πc_lock
);

27 
EXPORT_SYMBOL
(
πc_lock
);

39 
	$mach_£t_πc_mmss
(
nowtime
)

41 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

42 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

43 
ªtvÆ
 = 0;

46 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

47 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

50 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

51 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

53 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

54 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

55 
cmos_möuãs
 = 
	`bcd2bö
(cmos_minutes);

63 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

64 
ªÆ_möuãs
 = 
nowtime
 / 60;

66 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

67 
ªÆ_möuãs
 += 30;

68 
ªÆ_möuãs
 %= 60;

70 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

71 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

72 
ªÆ_£c⁄ds
 = 
	`bö2bcd
(real_seconds);

73 
ªÆ_möuãs
 = 
	`bö2bcd
(real_minutes);

75 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
, 
RTC_SECONDS
);

76 
	`CMOS_WRITE
(
ªÆ_möuãs
, 
RTC_MINUTES
);

78 
	`¥ötk
(
KERN_WARNING


80 
cmos_möuãs
, 
ªÆ_möuãs
);

81 
ªtvÆ
 = -1;

91 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

92 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

94  
ªtvÆ
;

95 
	}
}

97 
	$mach_gë_cmos_time
()

99 
°©us
, 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
˚¡ury
 = 0;

107 (
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
))

108 
	`˝u_ªœx
();

110 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

111 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

112 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

113 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

114 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

115 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

117 #ifde‡
CONFIG_ACPI


118 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

119 
a˝i_gbl_FADT
.
˚¡ury
)

120 
˚¡ury
 = 
	`CMOS_READ
(
a˝i_gbl_FADT
.century);

123 
°©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

124 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
°©us
 & 
RTC_DM_BINARY
));

126 i‡(
RTC_ALWAYS_BCD
 || !(
°©us
 & 
RTC_DM_BINARY
)) {

127 
£c
 = 
	`bcd2bö
(sec);

128 
mö
 = 
	`bcd2bö
(min);

129 
hour
 = 
	`bcd2bö
(hour);

130 
day
 = 
	`bcd2bö
(day);

131 
m⁄
 = 
	`bcd2bö
(mon);

132 
yór
 = 
	`bcd2bö
(year);

135 i‡(
˚¡ury
) {

136 
˚¡ury
 = 
	`bcd2bö
(century);

137 
yór
 +
˚¡ury
 * 100;

138 
	`¥ötk
(
KERN_INFO
 "Exãnded CMOS yór: %d\n", 
˚¡ury
 * 100);

140 
yór
 +
CMOS_YEARS_OFFS
;

142  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

143 
	}
}

146 
	$πc_cmos_ªad
(
addr
)

148 
vÆ
;

150 
	`lock_cmos_¥efix
(
addr
);

151 
	`outb
(
addr
, 
	`RTC_PORT
(0));

152 
vÆ
 = 
	`öb
(
	`RTC_PORT
(1));

153 
	`lock_cmos_suffix
(
addr
);

155  
vÆ
;

156 
	}
}

157 
EXPORT_SYMBOL
(
πc_cmos_ªad
);

159 
	$πc_cmos_wrôe
(
vÆ
, 
addr
)

161 
	`lock_cmos_¥efix
(
addr
);

162 
	`outb
(
addr
, 
	`RTC_PORT
(0));

163 
	`outb
(
vÆ
, 
	`RTC_PORT
(1));

164 
	`lock_cmos_suffix
(
addr
);

165 
	}
}

166 
EXPORT_SYMBOL
(
πc_cmos_wrôe
);

168 
	$£t_πc_mmss
(
nowtime
)

170 
Êags
;

171 
ªtvÆ
;

173 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

174 
ªtvÆ
 = 
	`£t_wÆl˛ock
(
nowtime
);

175 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

177  
ªtvÆ
;

178 
	}
}

181 
	$ªad_≥rsi°ít_˛ock
()

183 
ªtvÆ
, 
Êags
;

185 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

186 
ªtvÆ
 = 
	`gë_wÆl˛ock
();

187 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

189  
ªtvÆ
;

190 
	}
}

192 
	$upd©e_≥rsi°ít_˛ock
(
time•ec
 
now
)

194  
	`£t_πc_mmss
(
now
.
tv_£c
);

195 
	}
}

197 
	$«tive_ªad_tsc
()

199  
	`__«tive_ªad_tsc
();

200 
	}
}

201 
EXPORT_SYMBOL
(
«tive_ªad_tsc
);

204 
ªsour˚
 
	gπc_ªsour˚s
[] = {

206 .
°¨t
 = 
RTC_PORT
(0),

207 .
	gíd
 = 
RTC_PORT
(1),

208 .
	gÊags
 = 
IORESOURCE_IO
,

211 .
°¨t
 = 
RTC_IRQ
,

212 .
	gíd
 = 
RTC_IRQ
,

213 .
	gÊags
 = 
IORESOURCE_IRQ
,

217 
∂©f‹m_devi˚
 
	gπc_devi˚
 = {

218 .
«me
 = "rtc_cmos",

219 .
	gid
 = -1,

220 .
	gªsour˚
 = 
πc_ªsour˚s
,

221 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

224 
__öô
 
	$add_πc_cmos
()

226 #ifde‡
CONFIG_PNP


227 c⁄° *
ids
[] 
__öôc⁄°
 =

229 
≤p_dev
 *
dev
;

230 
≤p_id
 *
id
;

231 
i
;

233 
	`≤p_f‹_óch_dev
(
dev
) {

234 
id
 = 
dev
->id; id; id = id->
√xt
) {

235 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

236 i‡(
	`com∑ª_≤p_id
(
id
, 
ids
[
i
]) != 0)

243 
	`∂©f‹m_devi˚_ªgi°î
(&
πc_devi˚
);

244 
	`dev_öfo
(&
πc_devi˚
.
dev
,

248 
	}
}

249 
devi˚_öôˇŒ
(
add_πc_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<löux/sched.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/mmz⁄e.h
>

27 
	~<löux/s¸ìn_öfo.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/a˝i.h
>

30 
	~<löux/≠m_bios.h
>

31 
	~<löux/öôrd.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/£q_fûe.h
>

34 
	~<löux/c⁄sﬁe.h
>

35 
	~<löux/mˇ.h
>

36 
	~<löux/roŸ_dev.h
>

37 
	~<löux/highmem.h
>

38 
	~<löux/moduÀ.h
>

39 
	~<löux/efi.h
>

40 
	~<löux/öô.h
>

41 
	~<löux/edd.h
>

42 
	~<löux/iscsi_ib·.h
>

43 
	~<löux/nodemask.h
>

44 
	~<löux/kexec.h
>

45 
	~<löux/dmi.h
>

46 
	~<löux/p‚.h
>

47 
	~<löux/pci.h
>

48 
	~<asm/pci-dúe˘.h
>

49 
	~<löux/öô_ohci1394_dma.h
>

50 
	~<löux/kvm_∑ø.h
>

52 
	~<löux/î∫o.h
>

53 
	~<löux/kî√l.h
>

54 
	~<löux/°ddef.h
>

55 
	~<löux/uni°d.h
>

56 
	~<löux/±ø˚.h
>

57 
	~<löux/¶ab.h
>

58 
	~<löux/u£r.h
>

59 
	~<löux/dñay.h
>

61 
	~<löux/kÆlsyms.h
>

62 
	~<löux/˝u‰eq.h
>

63 
	~<löux/dma-m≠pög.h
>

64 
	~<löux/˘y≥.h
>

65 
	~<löux/uac˚ss.h
>

67 
	~<löux/≥r˝u.h
>

68 
	~<löux/¸ash_dump.h
>

70 
	~<video/edid.h
>

72 
	~<asm/mår.h
>

73 
	~<asm/≠ic.h
>

74 
	~<asm/e820.h
>

75 
	~<asm/mp•ec.h
>

76 
	~<asm/£tup.h
>

77 
	~<asm/efi.h
>

78 
	~<asm/timî.h
>

79 
	~<asm/i8259.h
>

80 
	~<asm/£˘i⁄s.h
>

81 
	~<asm/dmi.h
>

82 
	~<asm/io_≠ic.h
>

83 
	~<asm/i°.h
>

84 
	~<asm/vmi.h
>

85 
	~<asm/£tup_¨ch.h
>

86 
	~<asm/bios_ebda.h
>

87 
	~<asm/ˇcheÊush.h
>

88 
	~<asm/¥o˚ss‹.h
>

89 
	~<asm/bugs.h
>

91 
	~<asm/sy°em.h
>

92 
	~<asm/vsysˇŒ.h
>

93 
	~<asm/˝u.h
>

94 
	~<asm/desc.h
>

95 
	~<asm/dma.h
>

96 
	~<asm/iommu.h
>

97 
	~<asm/g¨t.h
>

98 
	~<asm/mmu_c⁄ãxt.h
>

99 
	~<asm/¥Ÿo.h
>

101 
	~<asm/∑øvút.h
>

102 
	~<asm/hy≥rvis‹.h
>

104 
	~<asm/≥r˝u.h
>

105 
	~<asm/t›ﬁogy.h
>

106 
	~<asm/≠icdef.h
>

107 #ifde‡
CONFIG_X86_64


108 
	~<asm/numa_64.h
>

111 #i‚de‡
ARCH_SETUP


112 
	#ARCH_SETUP


	)

120 
	gmax_low_p‚_m≠≥d
;

121 
	gmax_p‚_m≠≥d
;

123 
RESERVE_BRK
(
dmi_Æloc
, 65536);

125 
boŸ_˝u_id
 
	g__ªad_mo°ly
;

127 
__öôd©a
 
	g_brk_°¨t
 = ()
__brk_ba£
;

128 
	g_brk_íd
 = ()
__brk_ba£
;

130 #ifde‡
CONFIG_X86_64


131 
	$deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
)

133  
	`__deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
);

134 
	}
}

136 
	$deÁu…_check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)

138  
	`__deÁu…_check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
);

139 
	}
}

142 #i‚de‡
CONFIG_DEBUG_BOOT_PARAMS


143 
boŸ_∑øms
 
__öôd©a
 
	gboŸ_∑øms
;

145 
boŸ_∑øms
 
	gboŸ_∑øms
;

151 
ªsour˚
 
	gd©a_ªsour˚
 = {

152 .
«me
 = "Kernel data",

153 .
	g°¨t
 = 0,

154 .
	gíd
 = 0,

155 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


158 
ªsour˚
 
	gcode_ªsour˚
 = {

159 .
«me
 = "Kernel code",

160 .
	g°¨t
 = 0,

161 .
	gíd
 = 0,

162 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


165 
ªsour˚
 
	gbss_ªsour˚
 = {

166 .
«me
 = "Kernel bss",

167 .
	g°¨t
 = 0,

168 .
	gíd
 = 0,

169 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


173 #ifde‡
CONFIG_X86_32


174 
ªsour˚
 
	gvideo_øm_ªsour˚
 = {

175 .
«me
 = "Video RAMárea",

176 .
	g°¨t
 = 0xa0000,

177 .
	gíd
 = 0xbffff,

178 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


182 
˝uöfo_x86
 
√w_˝u_d©a
 
	g__˝uöôd©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

184 
˝uöfo_x86
 
boŸ_˝u_d©a
 
	g__ªad_mo°ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

185 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

186 
	$£t_mˇ_bus
(
x
)

188 #ifde‡
CONFIG_MCA


189 
MCA_bus
 = 
x
;

191 
	}
}

193 
	gdef_to_bigsmp
;

196 
	gmachöe_id
;

197 
	gmachöe_submodñ_id
;

198 
	gBIOS_ªvisi⁄
;

200 
≠m_öfo
 
	g≠m_öfo
;

201 
EXPORT_SYMBOL
(
≠m_öfo
);

203 #i‡
deföed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

204 
	$deföed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

205 
i°_öfo
 ist_info;

206 
	`EXPORT_SYMBOL
(
i°_öfo
);

208 
i°_öfo
 ist_info;

212 
˝uöfo_x86
 
boŸ_˝u_d©a
 
__ªad_mo°ly
 = {

213 .
x86_phys_bôs
 = 
MAX_PHYSMEM_BITS
,

214 
	}
};

215 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

219 #i‡!
deföed
(
CONFIG_X86_PAE
Ë|| deföed(
CONFIG_X86_64
)

220 
	gmmu_¸4_„©uªs
;

222 
	gmmu_¸4_„©uªs
 = 
X86_CR4_PAE
;

226 
	gboŸlﬂdî_ty≥
, 
	gboŸlﬂdî_vîsi⁄
;

231 
s¸ìn_öfo
 
	gs¸ìn_öfo
;

232 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

233 
edid_öfo
 
	gedid_öfo
;

234 
EXPORT_SYMBOL_GPL
(
edid_öfo
);

236 
roŸ_mou¡Êags
;

238 
	gßved_video_mode
;

240 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

241 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

242 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

244 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

245 #ifde‡
CONFIG_CMDLINE_BOOL


246 
__öôd©a
 
	gbuûtö_cmdlöe
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

249 #i‡
deföed
(
CONFIG_EDD
Ë|| deföed(
CONFIG_EDD_MODULE
)

250 
edd
 
	gedd
;

251 #ifde‡
CONFIG_EDD_MODULE


252 
EXPORT_SYMBOL
(
edd
);

259 
ölöe
 
	$c›y_edd
()

261 
	`mem˝y
(
edd
.
mbr_sig«tuª
, 
boŸ_∑øms
.
edd_mbr_sig_buf„r
,

262 (
edd
.
mbr_sig«tuª
));

263 
	`mem˝y
(
edd
.
edd_öfo
, 
boŸ_∑øms
.
eddbuf
, (edd.edd_info));

264 
edd
.
mbr_sig«tuª_ƒ
 = 
boŸ_∑øms
.
edd_mbr_sig_buf_íåõs
;

265 
edd
.
edd_öfo_ƒ
 = 
boŸ_∑øms
.
eddbuf_íåõs
;

266 
	}
}

268 
ölöe
 
	$c›y_edd
()

270 
	}
}

273 * 
__öô
 
	$exãnd_brk
(
size_t
 
size
, size_à
Æign
)

275 
size_t
 
mask
 = 
Æign
 - 1;

276 *
ªt
;

278 
	`BUG_ON
(
_brk_°¨t
 == 0);

279 
	`BUG_ON
(
Æign
 & 
mask
);

281 
_brk_íd
 = (_brk_íd + 
mask
) & ~mask;

282 
	`BUG_ON
((*)(
_brk_íd
 + 
size
Ë> 
__brk_limô
);

284 
ªt
 = (*)
_brk_íd
;

285 
_brk_íd
 +
size
;

287 
	`mem£t
(
ªt
, 0, 
size
);

289  
ªt
;

290 
	}
}

292 #ifde‡
CONFIG_X86_64


293 
__öô
 
	$öô_gb∑ges
()

295 i‡(
dúe˘_gb∑ges
 && 
˝u_has_gb∑ges
)

296 
	`¥ötk
(
KERN_INFO
 "Using GBÖages for direct mapping\n");

298 
dúe˘_gb∑ges
 = 0;

299 
	}
}

301 
ölöe
 
	$öô_gb∑ges
()

303 
	}
}

306 
__öô
 
	$ª£rve_brk
()

308 i‡(
_brk_íd
 > 
_brk_°¨t
)

309 
	`ª£rve_óæy
(
	`__∑
(
_brk_°¨t
), __∑(
_brk_íd
), "BRK");

313 
_brk_°¨t
 = 0;

314 
	}
}

316 #ifde‡
CONFIG_BLK_DEV_INITRD


318 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

319 
__öô
 
	$ªloˇã_öôrd
()

322 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

323 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

324 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

325 
u64
 
ømdisk_hîe
;

326 
¶›
, 
˛í
, 
m≠addr
;

327 *
p
, *
q
;

330 
ømdisk_hîe
 = 
	`föd_e820_¨ó
(0, 
íd_of_lowmem
, 
ømdisk_size
,

331 
PAGE_SIZE
);

333 i‡(
ømdisk_hîe
 == -1ULL)

334 
	`∑nic
("Cannot findÖlace forÇew RAMDISK of size %lld\n",

335 
ømdisk_size
);

339 
	`ª£rve_óæy
(
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
,

341 
öôrd_°¨t
 = 
ømdisk_hîe
 + 
PAGE_OFFSET
;

342 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

343 
	`¥ötk
(
KERN_INFO
 "AllocatedÇew RAMDISK: %08llx - %08llx\n",

344 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
);

346 
q
 = (*)
öôrd_°¨t
;

349 i‡(
ømdisk_image
 < 
íd_of_lowmem
) {

350 
˛í
 = 
íd_of_lowmem
 - 
ømdisk_image
;

351 
p
 = (*)
	`__va
(
ømdisk_image
);

352 
	`mem˝y
(
q
, 
p
, 
˛í
);

353 
q
 +
˛í
;

354 
ømdisk_image
 +
˛í
;

355 
ømdisk_size
 -
˛í
;

359 
ømdisk_size
) {

360 
¶›
 = 
ømdisk_image
 & ~
PAGE_MASK
;

361 
˛í
 = 
ømdisk_size
;

362 i‡(
˛í
 > 
MAX_MAP_CHUNK
-
¶›
)

363 
˛í
 = 
MAX_MAP_CHUNK
-
¶›
;

364 
m≠addr
 = 
ømdisk_image
 & 
PAGE_MASK
;

365 
p
 = 
	`óæy_memªm≠
(
m≠addr
, 
˛í
+
¶›
);

366 
	`mem˝y
(
q
, 
p
+
¶›
, 
˛í
);

367 
	`óæy_iounm≠
(
p
, 
˛í
+
¶›
);

368 
q
 +
˛í
;

369 
ømdisk_image
 +
˛í
;

370 
ømdisk_size
 -
˛í
;

373 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

374 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

375 
	`¥ötk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxÅo"

377 
ømdisk_image
,Ñamdisk_imagê+ 
ømdisk_size
 - 1,

378 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
 - 1);

379 
	}
}

381 
__öô
 
	$ª£rve_öôrd
()

383 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

384 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

385 
u64
 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

386 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

388 i‡(!
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 ||

389 !
ømdisk_image
 || !
ømdisk_size
)

392 
öôrd_°¨t
 = 0;

394 i‡(
ømdisk_size
 >(
íd_of_lowmem
>>1)) {

395 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

396 
	`¥ötk
(
KERN_ERR
 "initrdÅooÜargeÅo handle, "

401 
	`¥ötk
(
KERN_INFO
 "RAMDISK: %08Œx - %08Œx\n", 
ømdisk_image
,

402 
ømdisk_íd
);

405 i‡(
ømdisk_íd
 <
íd_of_lowmem
) {

411 
öôrd_°¨t
 = 
ømdisk_image
 + 
PAGE_OFFSET
;

412 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

416 
	`ªloˇã_öôrd
();

418 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

419 
	}
}

421 
__öô
 
	$ª£rve_öôrd
()

423 
	}
}

426 
__öô
 
	$∑r£_£tup_d©a
()

428 
£tup_d©a
 *
d©a
;

429 
u64
 
∑_d©a
;

431 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

433 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

434 
∑_d©a
) {

435 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, 
PAGE_SIZE
);

436 
d©a
->
ty≥
) {

437 
SETUP_E820_EXT
:

438 
	`∑r£_e820_ext
(
d©a
, 
∑_d©a
);

443 
∑_d©a
 = 
d©a
->
√xt
;

444 
	`óæy_iounm≠
(
d©a
, 
PAGE_SIZE
);

446 
	}
}

448 
__öô
 
	$e820_ª£rve_£tup_d©a
()

450 
£tup_d©a
 *
d©a
;

451 
u64
 
∑_d©a
;

452 
found
 = 0;

454 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

456 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

457 
∑_d©a
) {

458 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

459 
	`e820_upd©e_ønge
(
∑_d©a
, (*
d©a
)+d©a->
Àn
,

460 
E820_RAM
, 
E820_RESERVED_KERN
);

461 
found
 = 1;

462 
∑_d©a
 = 
d©a
->
√xt
;

463 
	`óæy_iounm≠
(
d©a
, (*data));

465 i‡(!
found
)

468 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

469 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

470 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

471 
	`e820_¥öt_m≠
("reserve setup_data");

472 
	}
}

474 
__öô
 
	$ª£rve_óæy_£tup_d©a
()

476 
£tup_d©a
 *
d©a
;

477 
u64
 
∑_d©a
;

478 
buf
[32];

480 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

482 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

483 
∑_d©a
) {

484 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

485 
	`•rötf
(
buf
, "£tu∞d©®%x", 
d©a
->
ty≥
);

486 
	`ª£rve_óæy
(
∑_d©a
,Öa_d©a+(*
d©a
)+d©a->
Àn
, 
buf
);

487 
∑_d©a
 = 
d©a
->
√xt
;

488 
	`óæy_iounm≠
(
d©a
, (*data));

490 
	}
}

496 #ifde‡
CONFIG_KEXEC


505 
__öô
 
	$föd_™d_ª£rve_¸ashkî√l
(
size
)

507 c⁄° 
Æignmít
 = 16<<20;

508 
°¨t
 = 0LL;

511 
ªt
;

513 
°¨t
 = 
	`föd_e820_¨ó
(°¨t, 
ULONG_MAX
, 
size
, 
Æignmít
);

514 i‡(
°¨t
 == -1ULL)

515  
°¨t
;

518 
ªt
 = 
	`ª£rve_boŸmem_gíîic
(
°¨t
, 
size
, 
BOOTMEM_EXCLUSIVE
);

519 i‡(
ªt
 >= 0)

520  
°¨t
;

522 
°¨t
 +
Æignmít
;

524 
	}
}

526 
ölöe
 
	$gë_tŸÆ_mem
()

528 
tŸÆ
;

530 
tŸÆ
 = 
max_low_p‚
 - 
mö_low_p‚
;

531 #ifde‡
CONFIG_HIGHMEM


532 
tŸÆ
 +
highíd_p‚
 - 
high°¨t_p‚
;

535  
tŸÆ
 << 
PAGE_SHIFT
;

536 
	}
}

538 
__öô
 
	$ª£rve_¸ashkî√l
()

540 
tŸÆ_mem
;

541 
¸ash_size
, 
¸ash_ba£
;

542 
ªt
;

544 
tŸÆ_mem
 = 
	`gë_tŸÆ_mem
();

546 
ªt
 = 
	`∑r£_¸ashkî√l
(
boŸ_comm™d_löe
, 
tŸÆ_mem
,

547 &
¸ash_size
, &
¸ash_ba£
);

548 i‡(
ªt
 !0 || 
¸ash_size
 <= 0)

552 i‡(
¸ash_ba£
 <= 0) {

553 
¸ash_ba£
 = 
	`föd_™d_ª£rve_¸ashkî√l
(
¸ash_size
);

554 i‡(
¸ash_ba£
 == -1ULL) {

555 
	`¥_öfo
("crashkernelÑeservation failed. "

560 
ªt
 = 
	`ª£rve_boŸmem_gíîic
(
¸ash_ba£
, 
¸ash_size
,

561 
BOOTMEM_EXCLUSIVE
);

562 i‡(
ªt
 < 0) {

563 
	`¥_öfo
("crashkernelÑeservation failed - "

569 
	`¥ötk
(
KERN_INFO
 "Reserving %ldMB of memoryát %ldMB "

571 ()(
¸ash_size
 >> 20),

572 ()(
¸ash_ba£
 >> 20),

573 ()(
tŸÆ_mem
 >> 20));

575 
¸ashk_ªs
.
°¨t
 = 
¸ash_ba£
;

576 
¸ashk_ªs
.
íd
 = 
¸ash_ba£
 + 
¸ash_size
 - 1;

577 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
¸ashk_ªs
);

578 
	}
}

580 
__öô
 
	$ª£rve_¸ashkî√l
()

582 
	}
}

585 
ªsour˚
 
	g°™d¨d_io_ªsour˚s
[] = {

586 { .
«me
 = "dma1", .
	g°¨t
 = 0x00, .
	gíd
 = 0x1f,

587 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

588 { .
	g«me
 = "pic1", .
	g°¨t
 = 0x20, .
	gíd
 = 0x21,

589 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

590 { .
	g«me
 = "timî0", .
	g°¨t
 = 0x40, .
	gíd
 = 0x43,

591 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

592 { .
	g«me
 = "timî1", .
	g°¨t
 = 0x50, .
	gíd
 = 0x53,

593 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

594 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x60, .
	gíd
 = 0x60,

595 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

596 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x64, .
	gíd
 = 0x64,

597 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

598 { .
	g«me
 = "dm®∑gêªg", .
	g°¨t
 = 0x80, .
	gíd
 = 0x8f,

599 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

600 { .
	g«me
 = "pic2", .
	g°¨t
 = 0xa0, .
	gíd
 = 0xa1,

601 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

602 { .
	g«me
 = "dma2", .
	g°¨t
 = 0xc0, .
	gíd
 = 0xdf,

603 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

604 { .
	g«me
 = "Âu", .
	g°¨t
 = 0xf0, .
	gíd
 = 0xff,

605 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

608 
__öô
 
	$ª£rve_°™d¨d_io_ªsour˚s
()

610 
i
;

613 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); i++)

614 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
°™d¨d_io_ªsour˚s
[
i
]);

616 
	}
}

624 #ifde‡
CONFIG_CRASH_DUMP


629 
__öô
 
	$£tup_ñfc‹ehdr
(*
¨g
)

631 *
íd
;

632 i‡(!
¨g
)

633  -
EINVAL
;

634 
ñfc‹ehdr_addr
 = 
	`mem∑r£
(
¨g
, &
íd
);

635  
íd
 > 
¨g
 ? 0 : -
EINVAL
;

636 
	}
}

637 
óæy_∑øm
("ñfc‹ehdr", 
£tup_ñfc‹ehdr
);

640 
x86_quúks
 
deÁu…_x86_quúks
 
	g__öôd©a
;

642 
x86_quúks
 *x86_quúk†
	g__öôd©a
 = &
deÁu…_x86_quúks
;

644 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


645 
__öô
 
	$dmi_low_mem‹y_c‹ru±i⁄
(c⁄° 
dmi_sy°em_id
 *
d
)

647 
	`¥ötk
(
KERN_NOTICE


649 
d
->
idít
);

651 
	`e820_upd©e_ønge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

652 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

655 
	}
}

659 
dmi_sy°em_id
 
__öôd©a
 
	gbad_bios_dmi_èbÀ
[] = {

660 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


662 .
ˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

663 .
	gidít
 = "AMI BIOS",

664 .
	gm©ches
 = {

665 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

669 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

670 .
	gidít
 = "Phoenix BIOS",

671 .
	gm©ches
 = {

672 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

682 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

683 .
	gidít
 = "AMI BIOS",

684 .
	gm©ches
 = {

685 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45ID"),

705 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

707 #ifde‡
CONFIG_X86_32


708 
	`mem˝y
(&
boŸ_˝u_d©a
, &
√w_˝u_d©a
, (new_cpu_data));

709 
	`visws_óæy_dëe˘
();

711 
	`¥ötk
(
KERN_INFO
 "Comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

715 
	`vmi_öô
();

717 
	`óæy_˝u_öô
();

718 
	`óæy_i‹em≠_öô
();

720 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
boŸ_∑øms
.
hdr
.
roŸ_dev
);

721 
s¸ìn_öfo
 = 
boŸ_∑øms
.screen_info;

722 
edid_öfo
 = 
boŸ_∑øms
.edid_info;

723 #ifde‡
CONFIG_X86_32


724 
≠m_öfo
.
bios
 = 
boŸ_∑øms
.
≠m_bios_öfo
;

725 
i°_öfo
 = 
boŸ_∑øms
.ist_info;

726 i‡(
boŸ_∑øms
.
sys_desc_èbÀ
.
Àngth
 != 0) {

727 
	`£t_mˇ_bus
(
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[3] & 0x2);

728 
machöe_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[0];

729 
machöe_submodñ_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[1];

730 
BIOS_ªvisi⁄
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[2];

733 
ßved_video_mode
 = 
boŸ_∑øms
.
hdr
.
vid_mode
;

734 
boŸlﬂdî_ty≥
 = 
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
;

735 i‡((
boŸlﬂdî_ty≥
 >> 4) == 0xe) {

736 
boŸlﬂdî_ty≥
 &= 0xf;

737 
boŸlﬂdî_ty≥
 |(
boŸ_∑øms
.
hdr
.
ext_lﬂdî_ty≥
+0x10) << 4;

739 
boŸlﬂdî_vîsi⁄
 = 
boŸlﬂdî_ty≥
 & 0xf;

740 
boŸlﬂdî_vîsi⁄
 |
boŸ_∑øms
.
hdr
.
ext_lﬂdî_vî
 << 4;

742 #ifde‡
CONFIG_BLK_DEV_RAM


743 
rd_image_°¨t
 = 
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_IMAGE_START_MASK
;

744 
rd_¥om±
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

745 
rd_dﬁﬂd
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

747 #ifde‡
CONFIG_EFI


748 i‡(!
	`°∫cmp
((*)&
boŸ_∑øms
.
efi_öfo
.
efi_lﬂdî_sig«tuª
,

749 #ifde‡
CONFIG_X86_32


755 
efi_íabÀd
 = 1;

756 
	`efi_ª£rve_óæy
();

760 
ARCH_SETUP


762 
	`£tup_mem‹y_m≠
();

763 
	`∑r£_£tup_d©a
();

765 
	`e820_ª£rve_£tup_d©a
();

767 
	`c›y_edd
();

769 i‡(!
boŸ_∑øms
.
hdr
.
roŸ_Êags
)

770 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

771 
öô_mm
.
°¨t_code
 = (Ë
_ãxt
;

772 
öô_mm
.
íd_code
 = (Ë
_ëext
;

773 
öô_mm
.
íd_d©a
 = (Ë
_ed©a
;

774 
öô_mm
.
brk
 = 
_brk_íd
;

776 
code_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ãxt
);

777 
code_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ëext
)-1;

778 
d©a_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ëext
);

779 
d©a_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ed©a
)-1;

780 
bss_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(&
__bss_°¨t
);

781 
bss_ªsour˚
.
íd
 = 
	`vút_to_phys
(&
__bss_°›
)-1;

783 #ifde‡
CONFIG_CMDLINE_BOOL


784 #ifde‡
CONFIG_CMDLINE_OVERRIDE


785 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

787 i‡(
buûtö_cmdlöe
[0]) {

789 
	`°æˇt
(
buûtö_cmdlöe
, " ", 
COMMAND_LINE_SIZE
);

790 
	`°æˇt
(
buûtö_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

791 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

796 
	`°æ˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

797 *
cmdlöe_p
 = 
comm™d_löe
;

799 
	`∑r£_óæy_∑øm
();

801 #ifde‡
CONFIG_X86_64


802 
	`check_e„r
();

806 
	`vmi_a˘iv©e
();

809 
	`ª£rve_óæy_£tup_d©a
();

811 i‡(
	`a˝i_mps_check
()) {

812 #ifde‡
CONFIG_X86_LOCAL_APIC


813 
dißbÀ_≠ic
 = 1;

815 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

818 #ifde‡
CONFIG_PCI


819 i‡(
pci_óæy_dump_ªgs
)

820 
	`óæy_dump_pci_devi˚s
();

823 
	`föish_e820_∑rsög
();

825 i‡(
efi_íabÀd
)

826 
	`efi_öô
();

828 
	`dmi_sˇn_machöe
();

830 
	`dmi_check_sy°em
(
bad_bios_dmi_èbÀ
);

836 
	`öô_hy≥rvis‹
(&
boŸ_˝u_d©a
);

838 #ifde‡
CONFIG_X86_32


839 
	`¥obe_roms
();

843 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
code_ªsour˚
);

844 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
d©a_ªsour˚
);

845 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
bss_ªsour˚
);

848 #ifde‡
CONFIG_X86_32


849 i‡(
	`µro_wôh_øm_bug
()) {

850 
	`e820_upd©e_ønge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

851 
E820_RESERVED
);

852 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

853 
	`¥ötk
(
KERN_INFO
 "fixedÖhysical RAM map:\n");

854 
	`e820_¥öt_m≠
("bad_ppro");

857 
	`óæy_g¨t_iommu_check
();

864 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

867 
	`óæy_ª£rve_e820_mpc_√w
();

869 
	`mår_bp_öô
();

870 i‡(
	`mår_åim_unˇched_mem‹y
(
max_p‚
))

871 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

873 #ifde‡
CONFIG_X86_32


875 
	`föd_low_p‚_ønge
();

877 
num_phy•ages
 = 
max_p‚
;

879 
	`check_x2≠ic
();

883 i‡(
max_p‚
 > (1UL<<(32 - 
PAGE_SHIFT
)))

884 
max_low_p‚
 = 
	`e820_íd_of_low_øm_p‚
();

886 
max_low_p‚
 = 
max_p‚
;

888 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

889 
max_p‚_m≠≥d
 = 
KERNEL_IMAGE_SIZE
 >> 
PAGE_SHIFT
;

892 #ifde‡
CONFIG_X86_CHECK_BIOS_CORRUPTION


893 
	`£tup_bios_c‹ru±i⁄_check
();

896 
	`¥ötk
(
KERN_DEBUG
 "initial memory mapped : 0 - %08lx\n",

897 
max_p‚_m≠≥d
<<
PAGE_SHIFT
);

899 
	`ª£rve_brk
();

901 
	`öô_gb∑ges
();

904 
max_low_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

905 
max_p‚_m≠≥d
 = 
max_low_p‚_m≠≥d
;

907 #ifde‡
CONFIG_X86_64


908 i‡(
max_p‚
 > 
max_low_p‚
) {

909 
max_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(1UL<<32,

910 
max_p‚
<<
PAGE_SHIFT
);

912 
max_low_p‚
 = 
max_p‚
;

920 #ifde‡
CONFIG_PROVIDE_OHCI1394_DMA_INIT


921 i‡(
öô_ohci1394_dma_óæy
)

922 
	`öô_ohci1394_dma_⁄_Æl_c⁄åﬁÀrs
();

925 
	`ª£rve_öôrd
();

927 
	`vsmp_öô
();

929 
	`io_dñay_öô
();

934 
	`a˝i_boŸ_èbÀ_öô
();

936 
	`óæy_a˝i_boŸ_öô
();

938 #ifde‡
CONFIG_ACPI_NUMA


942 
	`a˝i_numa_öô
();

945 
	`öômem_öô
(0, 
max_p‚
);

947 #ifde‡
CONFIG_ACPI_SLEEP


951 
	`a˝i_ª£rve_boŸmem
();

956 
	`föd_smp_c⁄fig
();

958 
	`ª£rve_¸ashkî√l
();

960 #ifde‡
CONFIG_X86_64


966 
	`dma32_ª£rve_boŸmem
();

969 
	`ª£rve_ib·_ªgi⁄
();

971 #ifde‡
CONFIG_KVM_CLOCK


972 
	`kvm˛ock_öô
();

975 
	`∑øvút_∑gëabÀ_£tup_°¨t
(
sw≠≥r_pg_dú
);

976 
	`∑gög_öô
();

977 
	`∑øvút_∑gëabÀ_£tup_d⁄e
(
sw≠≥r_pg_dú
);

978 
	`∑øvút_po°_Æloˇt‹_öô
();

980 #ifde‡
CONFIG_X86_64


981 
	`m≠_vsysˇŒ
();

984 
	`gíîic_≠ic_¥obe
();

986 
	`óæy_quúks
();

991 
	`a˝i_boŸ_öô
();

993 #i‡
	`deföed
(
CONFIG_X86_MPPARSE
Ë|| deföed(
CONFIG_X86_VISWS
)

997 i‡(
smp_found_c⁄fig
)

998 
	`gë_smp_c⁄fig
();

1001 
	`¥efûl_possibÀ_m≠
();

1003 #ifde‡
CONFIG_X86_64


1004 
	`öô_˝u_to_node
();

1007 
	`öô_≠ic_m≠pögs
();

1008 
	`iﬂpic_öô_m≠pögs
();

1011 
	`¥obe_ƒ_úqs_gsi
();

1013 
	`kvm_gue°_öô
();

1015 
	`e820_ª£rve_ªsour˚s
();

1016 
	`e820_m¨k_noßve_ªgi⁄s
(
max_low_p‚
);

1018 #ifde‡
CONFIG_X86_32


1019 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm_ªsour˚
);

1021 
	`ª£rve_°™d¨d_io_ªsour˚s
();

1023 
	`e820_£tup_g≠
();

1025 #ifde‡
CONFIG_VT


1026 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

1027 i‡(!
efi_íabÀd
 || (
	`efi_mem_ty≥
(0xa0000Ë!
EFI_CONVENTIONAL_MEMORY
))

1028 
c⁄swôchp
 = &
vga_c⁄
;

1029 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

1030 
c⁄swôchp
 = &
dummy_c⁄
;

1033 
	}
}

1035 #ifde‡
CONFIG_X86_32


1046 
__öô
 
	$x86_quúk_öå_öô
()

1048 i‡(
x86_quúks
->
¨ch_öå_öô
) {

1049 i‡(
x86_quúks
->
	`¨ch_öå_öô
())

1052 
	}
}

1061 
__öô
 
	$x86_quúk_å≠_öô
()

1063 i‡(
x86_quúks
->
¨ch_å≠_öô
) {

1064 i‡(
x86_quúks
->
	`¨ch_å≠_öô
())

1067 
	}
}

1069 
úqa˘i⁄
 
	gúq0
 = {

1070 .
h™dÀr
 = 
timî_öãºu±
,

1071 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

1072 .
	g«me
 = "timer"

1079 
__öô
 
	$x86_quúk_¥e_time_öô
()

1081 i‡(
x86_quúks
->
¨ch_¥e_time_öô
)

1082 
x86_quúks
->
	`¨ch_¥e_time_öô
();

1083 
	}
}

1092 
__öô
 
	$x86_quúk_time_öô
()

1094 i‡(
x86_quúks
->
¨ch_time_öô
) {

1100 i‡(
x86_quúks
->
	`¨ch_time_öô
())

1104 
úq0
.
mask
 = 
	`˝umask_of_˝u
(0);

1105 
	`£tup_úq
(0, &
úq0
);

1106 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/≥r˝u.h
>

6 
	~<löux/kexec.h
>

7 
	~<löux/¸ash_dump.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/t›ﬁogy.h
>

10 
	~<löux/p‚.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/£tup.h
>

14 
	~<asm/mp•ec.h
>

15 
	~<asm/≠icdef.h
>

16 
	~<asm/highmem.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/˝umask.h
>

19 
	~<asm/˝u.h
>

20 
	~<asm/°ack¥Ÿe˘‹.h
>

22 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


23 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

25 
	#DBG
(
x
...)

	)

28 
DEFINE_PER_CPU
(, 
˝u_numbî
);

29 
EXPORT_PER_CPU_SYMBOL
(
˝u_numbî
);

31 #ifde‡
CONFIG_X86_64


32 
	#BOOT_PERCPU_OFFSET
 (()
__≥r_˝u_lﬂd
)

	)

34 
	#BOOT_PERCPU_OFFSET
 0

	)

37 
DEFINE_PER_CPU
(, 
this_˝u_off
Ë
BOOT_PERCPU_OFFSET
;

38 
EXPORT_PER_CPU_SYMBOL
(
this_˝u_off
);

40 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
 = {

41 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

43 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

52 #ifde‡
CONFIG_X86_64


53 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

55 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

68 
boﬁ
 
__öô
 
	$p˝u_√ed_numa
()

70 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


71 
pg_d©a_t
 *
œ°
 = 
NULL
;

72 
˝u
;

74 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

75 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

77 i‡(
	`node_⁄löe
(
node
Ë&& 
	`NODE_DATA
(node) &&

78 
œ°
 &&Üa° !
	`NODE_DATA
(
node
))

79  
åue
;

81 
œ°
 = 
	`NODE_DATA
(
node
);

84  
Ál£
;

85 
	}
}

100 * 
__öô
 
	$p˝u_Æloc_boŸmem
(
˝u
, 
size
,

101 
Æign
)

103 c⁄° 
gﬂl
 = 
	`__∑
(
MAX_DMA_ADDRESS
);

104 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


105 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

106 *
±r
;

108 i‡(!
	`node_⁄löe
(
node
Ë|| !
	`NODE_DATA
(node)) {

109 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

110 
	`¥_öfo
("cpu %d hasÇoÇode %d orÇode-local memory\n",

111 
˝u
, 
node
);

112 
	`¥_debug
("per cpu data for cpu%d %lu bytesát %016lx\n",

113 
˝u
, 
size
, 
	`__∑
(
±r
));

115 
±r
 = 
	`__Æloc_boŸmem_node_n›™ic
(
	`NODE_DATA
(
node
),

116 
size
, 
Æign
, 
gﬂl
);

117 
	`¥_debug
("per cpu data for cpu%d %lu bytes onÇode%dát "

118 "%016lx\n", 
˝u
, 
size
, 
node
, 
	`__∑
(
±r
));

120  
±r
;

122  
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

124 
	}
}

139 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


140 
	sp˝ul_ít
 {

141 
	m˝u
;

142 *
	m±r
;

145 
size_t
 
	gp˝ul_size
;

146 
p˝ul_ít
 *
	gp˝ul_m≠
;

147 
vm_°ru˘
 
	gp˝ul_vm
;

149 
∑ge
 * 
__öô
 
	$p˝ul_gë_∑ge
(
˝u
, 
∑gío
)

151 
size_t
 
off
 = (size_t)
∑gío
 << 
PAGE_SHIFT
;

153 i‡(
off
 >
p˝ul_size
)

154  
NULL
;

156  
	`vút_to_∑ge
(
p˝ul_m≠
[
˝u
].
±r
 + 
off
);

157 
	}
}

159 
ssize_t
 
__öô
 
	$£tup_p˝u_Õage
(
size_t
 
°©ic_size
, 
boﬁ
 
cho£n
)

161 
size_t
 
m≠_size
, 
dyn_size
;

162 
˝u
;

163 
i
, 
j
;

164 
ssize_t
 
ªt
;

166 i‡(!
cho£n
) {

167 
size_t
 
vm_size
 = 
VMALLOC_END
 - 
VMALLOC_START
;

168 
size_t
 
tŸ_size
 = 
ƒ_˝u_ids
 * 
PMD_SIZE
;

171 i‡(!
	`p˝u_√ed_numa
())

172  -
EINVAL
;

175 i‡(
tŸ_size
 > 
vm_size
 / 5) {

176 
	`¥_öfo
("PERCPU:ÅooÜarge chunk size %zuMB for "

177 "œrgê∑gêªm≠\n", 
tŸ_size
 >> 20);

178  -
EINVAL
;

183 i‡(!
˝u_has_p£
) {

184 
	`¥_w¨nög
("PERCPU:ÜpageállocatorÑequires PSE\n");

185  -
EINVAL
;

192 
p˝ul_size
 = 
	`PFN_ALIGN
(
°©ic_size
 + 
PERCPU_MODULE_RESERVE
 +

193 
PERCPU_DYNAMIC_RESERVE
);

194 i‡(
p˝ul_size
 > 
PMD_SIZE
) {

195 
	`¥_w¨nög
("PERCPU: static data isÜargerÅhanÜargeÖage, "

197  -
EINVAL
;

199 
dyn_size
 = 
p˝ul_size
 - 
°©ic_size
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

202 
m≠_size
 = 
	`PFN_ALIGN
(
ƒ_˝u_ids
 * (
p˝ul_m≠
[0]));

203 
p˝ul_m≠
 = 
	`Æloc_boŸmem
(
m≠_size
);

205 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

206 
p˝ul_m≠
[
˝u
].cpu = cpu;

207 
p˝ul_m≠
[
˝u
].
±r
 = 
	`p˝u_Æloc_boŸmem
(˝u, 
PMD_SIZE
,

208 
PMD_SIZE
);

209 i‡(!
p˝ul_m≠
[
˝u
].
±r
) {

210 
	`¥_w¨nög
("PERCPU: failedÅoállocateÜargeÖage "

211 "f‹ cpu%u\n", 
˝u
);

212 
íomem
;

223 
	`‰ì_boŸmem
(
	`__∑
(
p˝ul_m≠
[
˝u
].
±r
 + 
p˝ul_size
),

224 
PMD_SIZE
 - 
p˝ul_size
);

226 
	`mem˝y
(
p˝ul_m≠
[
˝u
].
±r
, 
__≥r_˝u_lﬂd
, 
°©ic_size
);

230 
p˝ul_vm
.
Êags
 = 
VM_ALLOC
;

231 
p˝ul_vm
.
size
 = 
ƒ_˝u_ids
 * 
PMD_SIZE
;

232 
	`vm_¨ó_ªgi°î_óæy
(&
p˝ul_vm
, 
PMD_SIZE
);

234 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

235 
pmd_t
 *
pmd
, 
pmd_v
;

237 
pmd
 = 
	`p›uœã_exåa_pmd
(()
p˝ul_vm
.
addr
 +

238 
˝u
 * 
PMD_SIZE
);

239 
pmd_v
 = 
	`p‚_pmd
(
	`∑ge_to_p‚
(
	`vút_to_∑ge
(
p˝ul_m≠
[
˝u
].
±r
)),

240 
PAGE_KERNEL_LARGE
);

241 
	`£t_pmd
(
pmd
, 
pmd_v
);

245 
	`¥_öfo
("PERCPU: Remappedát %p withÜargeÖages, static data "

246 "%zu byãs\n", 
p˝ul_vm
.
addr
, 
°©ic_size
);

248 
ªt
 = 
	`p˝u_£tup_fú°_chunk
(
p˝ul_gë_∑ge
, 
°©ic_size
,

249 
PERCPU_FIRST_CHUNK_RESERVE
, 
dyn_size
,

250 
PMD_SIZE
, 
p˝ul_vm
.
addr
, 
NULL
);

253 
i
 = 0; i < 
ƒ_˝u_ids
 - 1; i++)

254 
j
 = 
i
 + 1; j < 
ƒ_˝u_ids
; j++)

255 i‡(
p˝ul_m≠
[
i
].
±r
 >Ö˝ul_m≠[
j
].ptr) {

256 
p˝ul_ít
 
tmp
 = 
p˝ul_m≠
[
i
];

257 
p˝ul_m≠
[
i
] =Ö˝ul_m≠[
j
];

258 
p˝ul_m≠
[
j
] = 
tmp
;

261  
ªt
;

263 
íomem
:

264 
	`f‹_óch_possibÀ_˝u
(
˝u
)

265 i‡(
p˝ul_m≠
[
˝u
].
±r
)

266 
	`‰ì_boŸmem
(
	`__∑
(
p˝ul_m≠
[
˝u
].
±r
), 
p˝ul_size
);

267 
	`‰ì_boŸmem
(
	`__∑
(
p˝ul_m≠
), 
m≠_size
);

268  -
ENOMEM
;

269 
	}
}

287 *
	$p˝u_Õage_ªm≠≥d
(*
kaddr
)

289 *
pmd_addr
 = (*)(()
kaddr
 & 
PMD_MASK
);

290 
off£t
 = ()
kaddr
 & ~
PMD_MASK
;

291 
À·
 = 0, 
right
 = 
ƒ_˝u_ids
 - 1;

292 
pos
;

295 i‡(!
p˝ul_m≠
)

296  
NULL
;

299 
À·
 <
right
) {

300 
pos
 = (
À·
 + 
right
) / 2;

302 i‡(
p˝ul_m≠
[
pos
].
±r
 < 
pmd_addr
)

303 
À·
 = 
pos
 + 1;

304 i‡(
p˝ul_m≠
[
pos
].
±r
 > 
pmd_addr
)

305 
right
 = 
pos
 - 1;

308 
	`WARN_ON
(
off£t
 < 
p˝ul_size
);

310  
p˝ul_vm
.
addr
 +

311 
p˝ul_m≠
[
pos
].
˝u
 * 
PMD_SIZE
 + 
off£t
;

315  
NULL
;

316 
	}
}

318 
ssize_t
 
__öô
 
	$£tup_p˝u_Õage
(
size_t
 
°©ic_size
, 
boﬁ
 
cho£n
)

320  -
EINVAL
;

321 
	}
}

332 
ssize_t
 
__öô
 
	$£tup_p˝u_embed
(
size_t
 
°©ic_size
, 
boﬁ
 
cho£n
)

334 
size_t
 
ª£rve
 = 
PERCPU_MODULE_RESERVE
 + 
PERCPU_DYNAMIC_RESERVE
;

341 i‡(!
cho£n
 && (!
˝u_has_p£
 || 
	`p˝u_√ed_numa
()))

342  -
EINVAL
;

344  
	`p˝u_embed_fú°_chunk
(
°©ic_size
, 
PERCPU_FIRST_CHUNK_RESERVE
,

345 
ª£rve
 - 
PERCPU_FIRST_CHUNK_RESERVE
, -1);

346 
	}
}

355 
∑ge
 **
p˝u4k_∑ges
 
	g__öôd©a
;

356 
p˝u4k_ƒ_°©ic_∑ges
 
	g__öôd©a
;

358 
∑ge
 * 
__öô
 
	$p˝u4k_gë_∑ge
(
˝u
, 
∑gío
)

360 i‡(
∑gío
 < 
p˝u4k_ƒ_°©ic_∑ges
)

361  
p˝u4k_∑ges
[
˝u
 * 
p˝u4k_ƒ_°©ic_∑ges
 + 
∑gío
];

362  
NULL
;

363 
	}
}

365 
__öô
 
	$p˝u4k_p›uœã_±e
(
addr
)

367 
	`p›uœã_exåa_±e
(
addr
);

368 
	}
}

370 
ssize_t
 
__öô
 
	$£tup_p˝u_4k
(
size_t
 
°©ic_size
)

372 
size_t
 
∑ges_size
;

373 
˝u
;

374 
i
, 
j
;

375 
ssize_t
 
ªt
;

377 
p˝u4k_ƒ_°©ic_∑ges
 = 
	`PFN_UP
(
°©ic_size
);

380 
∑ges_size
 = 
	`PFN_ALIGN
(
p˝u4k_ƒ_°©ic_∑ges
 * 
ƒ_˝u_ids


381 * (
p˝u4k_∑ges
[0]));

382 
p˝u4k_∑ges
 = 
	`Æloc_boŸmem
(
∑ges_size
);

385 
j
 = 0;

386 
	`f‹_óch_possibÀ_˝u
(
˝u
)

387 
i
 = 0; i < 
p˝u4k_ƒ_°©ic_∑ges
; i++) {

388 *
±r
;

390 
±r
 = 
	`p˝u_Æloc_boŸmem
(
˝u
, 
PAGE_SIZE
, PAGE_SIZE);

391 i‡(!
±r
) {

392 
	`¥_w¨nög
("PERCPU: failedÅoállocate "

393 "4kÖagêf‹ cpu%u\n", 
˝u
);

394 
íomem
;

397 
	`mem˝y
(
±r
, 
__≥r_˝u_lﬂd
 + 
i
 * 
PAGE_SIZE
, PAGE_SIZE);

398 
p˝u4k_∑ges
[
j
++] = 
	`vút_to_∑ge
(
±r
);

402 
	`¥_öfo
("PERCPU: Allocated %d 4kÖages, static data %zu bytes\n",

403 
p˝u4k_ƒ_°©ic_∑ges
, 
°©ic_size
);

405 
ªt
 = 
	`p˝u_£tup_fú°_chunk
(
p˝u4k_gë_∑ge
, 
°©ic_size
,

406 
PERCPU_FIRST_CHUNK_RESERVE
, -1,

407 -1, 
NULL
, 
p˝u4k_p›uœã_±e
);

408 
out_‰ì_¨
;

410 
íomem
:

411 --
j
 >= 0)

412 
	`‰ì_boŸmem
(
	`__∑
(
	`∑ge_addªss
(
p˝u4k_∑ges
[
j
])), 
PAGE_SIZE
);

413 
ªt
 = -
ENOMEM
;

414 
out_‰ì_¨
:

415 
	`‰ì_boŸmem
(
	`__∑
(
p˝u4k_∑ges
), 
∑ges_size
);

416  
ªt
;

417 
	}
}

420 
	gp˝u_cho£n_Æloc
[16] 
	g__öôd©a
;

422 
__öô
 
	$≥r˝u_Æloc_£tup
(*
°r
)

424 
	`°∫˝y
(
p˝u_cho£n_Æloc
, 
°r
, (pcpu_chosen_alloc) - 1);

426 
	}
}

427 
óæy_∑øm
("≥r˝u_Æloc", 
≥r˝u_Æloc_£tup
);

429 
ölöe
 
	$£tup_≥r˝u_£gmít
(
˝u
)

431 #ifde‡
CONFIG_X86_32


432 
desc_°ru˘
 
gdt
;

434 
	`∑ck_des¸ùt‹
(&
gdt
, 
	`≥r_˝u_off£t
(
˝u
), 0xFFFFF,

435 0x2 | 
DESCTYPE_S
, 0x8);

436 
gdt
.
s
 = 1;

437 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
),

438 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

440 
	}
}

442 
__öô
 
	$£tup_≥r_˝u_¨ós
()

444 
size_t
 
°©ic_size
 = 
__≥r_˝u_íd
 - 
__≥r_˝u_°¨t
;

445 
˝u
;

446 
dñè
;

447 
size_t
 
p˝u_unô_size
;

448 
ssize_t
 
ªt
;

450 
	`¥_öfo
("NR_CPUS:%dÇr_cpumask_bits:%dÇr_cpu_ids:%dÇr_node_ids:%d\n",

451 
NR_CPUS
, 
ƒ_˝umask_bôs
, 
ƒ_˝u_ids
, 
ƒ_node_ids
);

458 
ªt
 = -
EINVAL
;

459 i‡(
	`°æí
(
p˝u_cho£n_Æloc
)) {

460 i‡(
	`°rcmp
(
p˝u_cho£n_Æloc
, "4k")) {

461 i‡(!
	`°rcmp
(
p˝u_cho£n_Æloc
, "lpage"))

462 
ªt
 = 
	`£tup_p˝u_Õage
(
°©ic_size
, 
åue
);

463 i‡(!
	`°rcmp
(
p˝u_cho£n_Æloc
, "embed"))

464 
ªt
 = 
	`£tup_p˝u_embed
(
°©ic_size
, 
åue
);

466 
	`¥_w¨nög
("PERCPU: unknownállocator %s "

467 "•ecifõd\n", 
p˝u_cho£n_Æloc
);

468 i‡(
ªt
 < 0)

469 
	`¥_w¨nög
("PERCPU: %sállocator failed (%zd), "

471 
p˝u_cho£n_Æloc
, 
ªt
);

474 
ªt
 = 
	`£tup_p˝u_Õage
(
°©ic_size
, 
Ál£
);

475 i‡(
ªt
 < 0)

476 
ªt
 = 
	`£tup_p˝u_embed
(
°©ic_size
, 
Ál£
);

478 i‡(
ªt
 < 0)

479 
ªt
 = 
	`£tup_p˝u_4k
(
°©ic_size
);

480 i‡(
ªt
 < 0)

481 
	`∑nic
("cannotállocate staticÖercpuárea (%zu bytes,Érr=%zd)",

482 
°©ic_size
, 
ªt
);

484 
p˝u_unô_size
 = 
ªt
;

487 
dñè
 = ()
p˝u_ba£_addr
 - ()
__≥r_˝u_°¨t
;

488 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

489 
	`≥r_˝u_off£t
(
˝u
Ë
dñè
 + cpu * 
p˝u_unô_size
;

490 
	`≥r_˝u
(
this_˝u_off
, 
˝u
Ë
	`≥r_˝u_off£t
(cpu);

491 
	`≥r_˝u
(
˝u_numbî
, 
˝u
) = cpu;

492 
	`£tup_≥r˝u_£gmít
(
˝u
);

493 
	`£tup_°ack_ˇ«ry_£gmít
(
˝u
);

501 #ifde‡
CONFIG_X86_LOCAL_APIC


502 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) =

503 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_≠icid
, 
˝u
);

504 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
) =

505 
	`óæy_≥r_˝u_m≠
(
x86_bios_˝u_≠icid
, 
˝u
);

507 #ifde‡
CONFIG_X86_64


508 
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
) =

509 
	`≥r_˝u
(
úq_°ack_uni⁄
.
úq_°ack
, 
˝u
) +

510 
IRQ_STACK_SIZE
 - 64;

511 #ifde‡
CONFIG_NUMA


512 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
) =

513 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_node_m≠
, 
˝u
);

520 i‡(
˝u
 =
boŸ_˝u_id
)

521 
	`swôch_to_√w_gdt
(
˝u
);

525 #ifde‡
CONFIG_X86_LOCAL_APIC


526 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
Ë
NULL
;

527 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
Ë
NULL
;

529 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

530 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
Ë
NULL
;

533 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

538 
	`≥r_˝u
(
node_numbî
, 
boŸ_˝u_id
Ë
	`˝u_to_node
(boot_cpu_id);

542 
	`£tup_node_to_˝umask_m≠
();

545 
	`£tup_˝u_loˇl_masks
();

546 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/smp.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/sig«l.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/waô.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/≥rs⁄Æôy.h
>

21 
	~<löux/uac˚ss.h
>

23 
	~<asm/¥o˚ss‹.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/i387.h
>

26 
	~<asm/vdso.h
>

27 
	~<asm/m˚.h
>

29 #ifde‡
CONFIG_X86_64


30 
	~<asm/¥Ÿo.h
>

31 
	~<asm/ü32_uni°d.h
>

34 
	~<asm/sysˇŒ.h
>

35 
	~<asm/sysˇŒs.h
>

37 
	~<asm/sig‰ame.h
>

39 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

41 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

42 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

43 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

44 
X86_EFLAGS_CF
)

	)

46 #ifde‡
CONFIG_X86_32


47 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

49 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

52 
	#COPY
(
x
) do { \

53 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

54 } 0)

	)

56 
	#GET_SEG
(
£g
) ({ \

57 
tmp
; \

58 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

59 
tmp
; \

60 })

	)

62 
	#COPY_SEG
(
£g
) do { \

63 
ªgs
->
£g
 = 
	`GET_SEG
(seg); \

64 } 0)

	)

66 
	#COPY_SEG_CPL3
(
£g
) do { \

67 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

68 } 0)

	)

71 
	$ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
, 
sigc⁄ãxt
 
__u£r
 *
sc
,

72 *
∑x
)

74 
__u£r
 *
buf
;

75 
tmpÊags
;

76 
îr
 = 0;

79 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

81 
gë_u£r_åy
 {

83 #ifde‡
CONFIG_X86_32


84 
	`£t_u£r_gs
(
ªgs
, 
	`GET_SEG
(
gs
));

85 
	`COPY_SEG
(
fs
);

86 
	`COPY_SEG
(
es
);

87 
	`COPY_SEG
(
ds
);

90 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

91 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

93 #ifde‡
CONFIG_X86_64


94 
	`COPY
(
r8
);

95 
	`COPY
(
r9
);

96 
	`COPY
(
r10
);

97 
	`COPY
(
r11
);

98 
	`COPY
(
r12
);

99 
	`COPY
(
r13
);

100 
	`COPY
(
r14
);

101 
	`COPY
(
r15
);

104 #ifde‡
CONFIG_X86_32


105 
	`COPY_SEG_CPL3
(
cs
);

106 
	`COPY_SEG_CPL3
(
ss
);

111 
	`COPY_SEG_CPL3
(
cs
);

114 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

115 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

116 
ªgs
->
‹ig_ax
 = -1;

118 
	`gë_u£r_ex
(
buf
, &
sc
->
Â°©e
);

119 
îr
 |
	`ª°‹e_i387_x°©e
(
buf
);

121 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

122 } 
	`gë_u£r_ˇtch
(
îr
);

124  
îr
;

125 
	}
}

128 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, __u£∏*
Â°©e
,

129 
±_ªgs
 *
ªgs
, 
mask
)

131 
îr
 = 0;

133 
put_u£r_åy
 {

135 #ifde‡
CONFIG_X86_32


136 
	`put_u£r_ex
(
	`gë_u£r_gs
(
ªgs
), (
__u£r
 *)&
sc
->
gs
);

137 
	`put_u£r_ex
(
ªgs
->
fs
, (
__u£r
 *)&
sc
->fs);

138 
	`put_u£r_ex
(
ªgs
->
es
, (
__u£r
 *)&
sc
->es);

139 
	`put_u£r_ex
(
ªgs
->
ds
, (
__u£r
 *)&
sc
->ds);

142 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

143 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

144 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

145 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

146 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

147 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

148 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

149 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

150 #ifde‡
CONFIG_X86_64


151 
	`put_u£r_ex
(
ªgs
->
r8
, &
sc
->r8);

152 
	`put_u£r_ex
(
ªgs
->
r9
, &
sc
->r9);

153 
	`put_u£r_ex
(
ªgs
->
r10
, &
sc
->r10);

154 
	`put_u£r_ex
(
ªgs
->
r11
, &
sc
->r11);

155 
	`put_u£r_ex
(
ªgs
->
r12
, &
sc
->r12);

156 
	`put_u£r_ex
(
ªgs
->
r13
, &
sc
->r13);

157 
	`put_u£r_ex
(
ªgs
->
r14
, &
sc
->r14);

158 
	`put_u£r_ex
(
ªgs
->
r15
, &
sc
->r15);

161 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

162 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

163 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

164 #ifde‡
CONFIG_X86_32


165 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

166 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

167 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

168 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

170 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

171 
	`put_u£r_ex
(
ªgs
->
cs
, &
sc
->cs);

172 
	`put_u£r_ex
(0, &
sc
->
gs
);

173 
	`put_u£r_ex
(0, &
sc
->
fs
);

176 
	`put_u£r_ex
(
Â°©e
, &
sc
->fpstate);

179 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

180 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

181 } 
	`put_u£r_ˇtch
(
îr
);

183  
îr
;

184 
	}
}

193 
	$Æign_sig‰ame
(
•
)

195 #ifde‡
CONFIG_X86_32


200 
•
 = ((sp + 4) & -16ul) - 4;

202 
•
 = 
	`round_down
(sp, 16) - 8;

204  
•
;

205 
	}
}

207 
ölöe
 
__u£r
 *

208 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
size_t
 
‰ame_size
,

209 
__u£r
 **
Â°©e
)

212 
•
 = 
ªgs
->sp;

213 
⁄sig°ack
 = 
	`⁄_sig_°ack
(
•
);

215 #ifde‡
CONFIG_X86_64


217 
•
 -= 128;

220 i‡(!
⁄sig°ack
) {

222 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

223 i‡(
cuºít
->
ßs_ss_size
)

224 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

226 #ifde‡
CONFIG_X86_32


228 i‡((
ªgs
->
ss
 & 0xffffË!
__USER_DS
 &&

229 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

230 
ka
->
ß
.
ß_ª°‹î
)

231 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

236 i‡(
	`u£d_m©h
()) {

237 
•
 -
sig_x°©e_size
;

238 #ifde‡
CONFIG_X86_64


239 
•
 = 
	`round_down
(sp, 64);

241 *
Â°©e
 = (
__u£r
 *)
•
;

244 
•
 = 
	`Æign_sig‰ame
(• - 
‰ame_size
);

250 i‡(
⁄sig°ack
 && !
	`likñy
(
	`⁄_sig_°ack
(
•
)))

251  (
__u£r
 *)-1L;

254 i‡(
	`u£d_m©h
(Ë&& 
	`ßve_i387_x°©e
(*
Â°©e
) < 0)

255  (
__u£r
 *)-1L;

257  (
__u£r
 *)
•
;

258 
	}
}

260 #ifde‡
CONFIG_X86_32


262 
u16
 
	mp›lmovl
;

263 
u32
 
	mvÆ
;

264 
u16
 
	möt80
;

265 } 
__©åibuã__
((
∑cked
)Ë
	gªtcode
 = {

267 
__NR_sigªtu∫
,

272 
u8
 
	mmovl
;

273 
u32
 
	mvÆ
;

274 
u16
 
	möt80
;

275 
u8
 
	m∑d
;

276 } 
__©åibuã__
((
∑cked
)Ë
	gπ_ªtcode
 = {

278 
__NR_π_sigªtu∫
,

284 
	$__£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

285 
±_ªgs
 *
ªgs
)

287 
sig‰ame
 
__u£r
 *
‰ame
;

288 
__u£r
 *
ª°‹î
;

289 
îr
 = 0;

290 
__u£r
 *
Â°©e
 = 
NULL
;

292 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

294 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

295  -
EFAULT
;

297 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

298  -
EFAULT
;

300 i‡(
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

301  -
EFAULT
;

303 i‡(
_NSIG_WORDS
 > 1) {

304 i‡(
	`__c›y_to_u£r
(&
‰ame
->
exåamask
, &
£t
->
sig
[1],

305 (
‰ame
->
exåamask
)))

306  -
EFAULT
;

309 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

310 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
sigªtu∫
);

312 
ª°‹î
 = &
‰ame
->
ªtcode
;

313 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

314 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

317 
îr
 |
	`__put_u£r
(
ª°‹î
, &
‰ame
->
¥ëcode
);

326 
îr
 |
	`__put_u£r
(*((
u64
 *)&
ªtcode
), (u64 *)
‰ame
->retcode);

328 i‡(
îr
)

329  -
EFAULT
;

332 
ªgs
->
•
 = ()
‰ame
;

333 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

334 
ªgs
->
ax
 = ()
sig
;

335 
ªgs
->
dx
 = 0;

336 
ªgs
->
cx
 = 0;

338 
ªgs
->
ds
 = 
__USER_DS
;

339 
ªgs
->
es
 = 
__USER_DS
;

340 
ªgs
->
ss
 = 
__USER_DS
;

341 
ªgs
->
cs
 = 
__USER_CS
;

344 
	}
}

346 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

347 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

349 
π_sig‰ame
 
__u£r
 *
‰ame
;

350 
__u£r
 *
ª°‹î
;

351 
îr
 = 0;

352 
__u£r
 *
Â°©e
 = 
NULL
;

354 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

356 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

357  -
EFAULT
;

359 
put_u£r_åy
 {

360 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

361 
	`put_u£r_ex
(&
‰ame
->
öfo
, &‰ame->
pöfo
);

362 
	`put_u£r_ex
(&
‰ame
->
uc
, &‰ame->
puc
);

363 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

366 i‡(
˝u_has_xßve
)

367 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

369 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

370 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

371 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

372 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

373 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

374 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

375 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

376 
ªgs
, 
£t
->
sig
[0]);

377 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

380 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
π_sigªtu∫
);

381 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

382 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

383 
	`put_u£r_ex
(
ª°‹î
, &
‰ame
->
¥ëcode
);

392 
	`put_u£r_ex
(*((
u64
 *)&
π_ªtcode
), (u64 *)
‰ame
->
ªtcode
);

393 } 
	`put_u£r_ˇtch
(
îr
);

395 i‡(
îr
)

396  -
EFAULT
;

399 
ªgs
->
•
 = ()
‰ame
;

400 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

401 
ªgs
->
ax
 = ()
sig
;

402 
ªgs
->
dx
 = ()&
‰ame
->
öfo
;

403 
ªgs
->
cx
 = ()&
‰ame
->
uc
;

405 
ªgs
->
ds
 = 
__USER_DS
;

406 
ªgs
->
es
 = 
__USER_DS
;

407 
ªgs
->
ss
 = 
__USER_DS
;

408 
ªgs
->
cs
 = 
__USER_CS
;

411 
	}
}

413 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

414 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

416 
π_sig‰ame
 
__u£r
 *
‰ame
;

417 
__u£r
 *
Â
 = 
NULL
;

418 
îr
 = 0;

419 
èsk_°ru˘
 *
me
 = 
cuºít
;

421 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (
π_sig‰ame
), &
Â
);

423 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

424  -
EFAULT
;

426 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
) {

427 i‡(
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info))

428  -
EFAULT
;

431 
put_u£r_åy
 {

433 i‡(
˝u_has_xßve
)

434 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

436 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

437 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

438 
	`put_u£r_ex
(
me
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

439 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

440 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

441 
	`put_u£r_ex
(
me
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

442 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â
, 
ªgs
, 
£t
->
sig
[0]);

443 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

448 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

449 
	`put_u£r_ex
(
ka
->
ß
.
ß_ª°‹î
, &
‰ame
->
¥ëcode
);

452 
îr
 |-
EFAULT
;

454 } 
	`put_u£r_ˇtch
(
îr
);

456 i‡(
îr
)

457  -
EFAULT
;

460 
ªgs
->
di
 = 
sig
;

462 
ªgs
->
ax
 = 0;

466 
ªgs
->
si
 = ()&
‰ame
->
öfo
;

467 
ªgs
->
dx
 = ()&
‰ame
->
uc
;

468 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

470 
ªgs
->
•
 = ()
‰ame
;

474 
ªgs
->
cs
 = 
__USER_CS
;

477 
	}
}

480 #ifde‡
CONFIG_X86_32


484 
asmlökage
 

485 
	$sys_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

487 
mask
 &
_BLOCKABLE
;

488 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

489 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

490 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

491 
	`ªˇlc_sig≥ndög
();

492 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

494 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

495 
	`scheduÀ
();

496 
	`£t_ª°‹e_sigmask
();

498  -
ERESTARTNOHAND
;

499 
	}
}

501 
asmlökage
 

502 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

503 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

505 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

506 
ªt
 = 0;

508 i‡(
a˘
) {

509 
ﬁd_sig£t_t
 
mask
;

511 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)))

512  -
EFAULT
;

514 
gë_u£r_åy
 {

515 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler);

516 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

517 
	`gë_u£r_ex
(
mask
, &
a˘
->
ß_mask
);

518 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer);

519 } 
	`gë_u£r_ˇtch
(
ªt
);

521 i‡(
ªt
)

522  -
EFAULT
;

523 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

526 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

528 i‡(!
ªt
 && 
ﬂ˘
) {

529 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)))

530  -
EFAULT
;

532 
put_u£r_åy
 {

533 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler);

534 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

535 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

536 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer);

537 } 
	`put_u£r_ˇtch
(
ªt
);

539 i‡(
ªt
)

540  -
EFAULT
;

543  
ªt
;

544 
	}
}

547 #ifde‡
CONFIG_X86_32


548 
	$sys_sigÆt°ack
(
±_ªgs
 *
ªgs
)

550 c⁄° 
°ack_t
 
__u£r
 *
uss
 = (c⁄° sèck_à__u£∏*)
ªgs
->
bx
;

551 
°ack_t
 
__u£r
 *
uoss
 = (°ack_à__u£∏*)
ªgs
->
cx
;

553  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

554 
	}
}

556 
asmlökage
 

557 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
,

558 
±_ªgs
 *
ªgs
)

560  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

561 
	}
}

567 #ifde‡
CONFIG_X86_32


568 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

570 
sig‰ame
 
__u£r
 *
‰ame
;

571 
ax
;

572 
sig£t_t
 
£t
;

574 
‰ame
 = (
sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - 8);

576 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

577 
bad‰ame
;

578 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
Ë|| (
_NSIG_WORDS
 > 1

579 && 
	`__c›y_‰om_u£r
(&
£t
.
sig
[1], &
‰ame
->
exåamask
,

580 (
‰ame
->
exåamask
))))

581 
bad‰ame
;

583 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

584 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

585 
cuºít
->
blocked
 = 
£t
;

586 
	`ªˇlc_sig≥ndög
();

587 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

589 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

590 
bad‰ame
;

591  
ax
;

593 
bad‰ame
:

594 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "sigreturn");

597 
	}
}

600 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

602 
π_sig‰ame
 
__u£r
 *
‰ame
;

603 
ax
;

604 
sig£t_t
 
£t
;

606 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - ());

607 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

608 
bad‰ame
;

609 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

610 
bad‰ame
;

612 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

613 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

614 
cuºít
->
blocked
 = 
£t
;

615 
	`ªˇlc_sig≥ndög
();

616 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

618 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

619 
bad‰ame
;

621 i‡(
	`do_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
•
Ë=-
EFAULT
)

622 
bad‰ame
;

624  
ax
;

626 
bad‰ame
:

627 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "rt_sigreturn");

629 
	}
}

634 
	$sigƒ_c⁄vît
(
sig
)

636 #ifde‡
CONFIG_X86_32


637 
thªad_öfo
 *
öfo
 = 
	`cuºít_thªad_öfo
();

639 i‡(
öfo
->
exec_domaö
 && info->exec_domaö->
sig«l_övm≠
 && 
sig
 < 32)

640  
öfo
->
exec_domaö
->
sig«l_övm≠
[
sig
];

642  
sig
;

643 
	}
}

645 #ifde‡
CONFIG_X86_32


647 
	#is_ü32
 1

	)

648 
	#ü32_£tup_‰ame
 
__£tup_‰ame


	)

649 
	#ü32_£tup_π_‰ame
 
__£tup_π_‰ame


	)

653 #ifde‡
CONFIG_IA32_EMULATION


654 
	#is_ü32
 
	`ã°_thªad_Êag
(
TIF_IA32
)

	)

656 
	#is_ü32
 0

	)

659 
ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

660 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

661 
ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

662 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

667 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

668 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

670 
usig
 = 
	`sigƒ_c⁄vît
(
sig
);

671 
ªt
;

674 i‡(
is_ü32
) {

675 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

676 
ªt
 = 
	`ü32_£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

678 
ªt
 = 
	`ü32_£tup_‰ame
(
usig
, 
ka
, 
£t
, 
ªgs
);

680 
ªt
 = 
	`__£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

682 i‡(
ªt
) {

683 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

684  -
EFAULT
;

687  
ªt
;

688 
	}
}

691 
	$h™dÀ_sig«l
(
sig
, 
sigöfo_t
 *
öfo
, 
k_siga˘i⁄
 *
ka
,

692 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
)

694 
ªt
;

697 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

699 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

700 -
ERESTART_RESTARTBLOCK
:

701 -
ERESTARTNOHAND
:

702 
ªgs
->
ax
 = -
EINTR
;

705 -
ERESTARTSYS
:

706 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

707 
ªgs
->
ax
 = -
EINTR
;

711 -
ERESTARTNOINTR
:

712 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

713 
ªgs
->
ù
 -= 2;

722 i‡(
	`u∆ikñy
(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
) &&

723 
	`likñy
(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_FORCED_TF
)))

724 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

726 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

728 i‡(
ªt
)

729  
ªt
;

731 #ifde‡
CONFIG_X86_64


737 
	`£t_fs
(
USER_DS
);

743 
ªgs
->
Êags
 &~
X86_EFLAGS_DF
;

751 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

753 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

754 
	`sig‹£ts
(&
cuºít
->
blocked
, &cuºít->blocked, &
ka
->
ß
.
ß_mask
);

755 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

756 
	`sigadd£t
(&
cuºít
->
blocked
, 
sig
);

757 
	`ªˇlc_sig≥ndög
();

758 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

760 
	`åa˚hook_sig«l_h™dÀr
(
sig
, 
öfo
, 
ka
, 
ªgs
,

761 
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
));

764 
	}
}

766 #ifde‡
CONFIG_X86_32


767 
	#NR_ª°¨t_sysˇŒ
 
__NR_ª°¨t_sysˇŒ


	)

769 
	#NR_ª°¨t_sysˇŒ
 \

770 
	`ã°_thªad_Êag
(
TIF_IA32
Ë? 
__NR_ü32_ª°¨t_sysˇŒ
 : 
__NR_ª°¨t_sysˇŒ


	)

778 
	$do_sig«l
(
±_ªgs
 *
ªgs
)

780 
k_siga˘i⁄
 
ka
;

781 
sigöfo_t
 
öfo
;

782 
sigƒ
;

783 
sig£t_t
 *
ﬁd£t
;

792 i‡(!
	`u£r_mode
(
ªgs
))

795 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
)

796 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

798 
ﬁd£t
 = &
cuºít
->
blocked
;

800 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

801 i‡(
sigƒ
 > 0) {

808 i‡(
cuºít
->
thªad
.
debugªg7
)

809 
	`£t_debugªg
(
cuºít
->
thªad
.
debugªg7
, 7);

812 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
öfo
, &
ka
, 
ﬁd£t
, 
ªgs
) == 0) {

819 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

825 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

827 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

828 -
ERESTARTNOHAND
:

829 -
ERESTARTSYS
:

830 -
ERESTARTNOINTR
:

831 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

832 
ªgs
->
ù
 -= 2;

835 -
ERESTART_RESTARTBLOCK
:

836 
ªgs
->
ax
 = 
NR_ª°¨t_sysˇŒ
;

837 
ªgs
->
ù
 -= 2;

846 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
) {

847 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

848 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

850 
	}
}

857 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, *
unu£d
, 
__u32
 
thªad_öfo_Êags
)

859 #ifde‡
CONFIG_X86_NEW_MCE


861 i‡(
thªad_öfo_Êags
 & 
_TIF_MCE_NOTIFY
)

862 
	`m˚_nŸify_¥o˚ss
();

866 i‡(
thªad_öfo_Êags
 & 
_TIF_SIGPENDING
)

867 
	`do_sig«l
(
ªgs
);

869 i‡(
thªad_öfo_Êags
 & 
_TIF_NOTIFY_RESUME
) {

870 
	`˛ór_thªad_Êag
(
TIF_NOTIFY_RESUME
);

871 
	`åa˚hook_nŸify_ªsume
(
ªgs
);

874 #ifde‡
CONFIG_X86_32


875 
	`˛ór_thªad_Êag
(
TIF_IRET
);

877 
	}
}

879 
	$sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
)

881 
èsk_°ru˘
 *
me
 = 
cuºít
;

883 i‡(
show_unh™dÀd_sig«ls
 && 
	`¥ötk_øãlimô
()) {

884 
	`¥ötk
("%s"

886 
	`èsk_pid_ƒ
(
cuºít
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

887 
me
->
comm
, me->
pid
, 
whîe
, 
‰ame
,

888 
ªgs
->
ù
,Ñegs->
•
,Ñegs->
‹ig_ax
);

889 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

890 
	`¥ötk
(
KERN_CONT
 "\n");

893 
	`f‹˚_sig
(
SIGSEGV
, 
me
);

894 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/mc146818πc.h
>

21 
	~<löux/ˇche.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/˝u.h
>

25 
	~<asm/mår.h
>

26 
	~<asm/ébÊush.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/≠ic.h
>

114 
	$«tive_smp_£nd_ªscheduÀ
(
˝u
)

116 i‡(
	`u∆ikñy
(
	`˝u_is_ofÊöe
(
˝u
))) {

117 
	`WARN_ON
(1);

120 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
RESCHEDULE_VECTOR
);

121 
	}
}

123 
	$«tive_£nd_ˇŒ_func_sögÀ_ùi
(
˝u
)

125 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
CALL_FUNCTION_SINGLE_VECTOR
);

126 
	}
}

128 
	$«tive_£nd_ˇŒ_func_ùi
(c⁄° 
˝umask
 *
mask
)

130 
˝umask_v¨_t
 
Ælbut£lf
;

132 i‡(!
	`Æloc_˝umask_v¨
(&
Ælbut£lf
, 
GFP_ATOMIC
)) {

133 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

137 
	`˝umask_c›y
(
Ælbut£lf
, 
˝u_⁄löe_mask
);

138 
	`˝umask_˛ór_˝u
(
	`smp_¥o˚ss‹_id
(), 
Ælbut£lf
);

140 i‡(
	`˝umask_equÆ
(
mask
, 
Ælbut£lf
) &&

141 
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
˝u_ˇŒout_mask
))

142 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
CALL_FUNCTION_VECTOR
);

144 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

146 
	`‰ì_˝umask_v¨
(
Ælbut£lf
);

147 
	}
}

153 
asmlökage
 
	$smp_ªboŸ_öãºu±
()

155 
	`ack_APIC_úq
();

156 
	`úq_íãr
();

157 
	`°›_this_˝u
(
NULL
);

158 
	`úq_exô
();

159 
	}
}

161 
	$«tive_smp_£nd_°›
()

163 
Êags
;

164 
waô
;

166 i‡(
ªboŸ_f‹˚
)

178 i‡(
	`num_⁄löe_˝us
() > 1) {

179 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
REBOOT_VECTOR
);

182 
waô
 = 
USEC_PER_SEC
;

183 
	`num_⁄löe_˝us
(Ë> 1 && 
waô
--)

184 
	`udñay
(1);

187 
	`loˇl_úq_ßve
(
Êags
);

188 
	`dißbÀ_loˇl_APIC
();

189 
	`loˇl_úq_ª°‹e
(
Êags
);

190 
	}
}

197 
	$smp_ªscheduÀ_öãºu±
(
±_ªgs
 *
ªgs
)

199 
	`ack_APIC_úq
();

200 
	`öc_úq_°©
(
úq_ªsched_cou¡
);

204 
	}
}

206 
	$smp_ˇŒ_fun˘i⁄_öãºu±
(
±_ªgs
 *
ªgs
)

208 
	`ack_APIC_úq
();

209 
	`úq_íãr
();

210 
	`gíîic_smp_ˇŒ_fun˘i⁄_öãºu±
();

211 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

212 
	`úq_exô
();

213 
	}
}

215 
	$smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
(
±_ªgs
 *
ªgs
)

217 
	`ack_APIC_úq
();

218 
	`úq_íãr
();

219 
	`gíîic_smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
();

220 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

221 
	`úq_exô
();

222 
	}
}

224 
smp_›s
 
	gsmp_›s
 = {

225 .
smp_¥ï¨e_boŸ_˝u
 = 
«tive_smp_¥ï¨e_boŸ_˝u
,

226 .
	gsmp_¥ï¨e_˝us
 = 
«tive_smp_¥ï¨e_˝us
,

227 .
	gsmp_˝us_d⁄e
 = 
«tive_smp_˝us_d⁄e
,

229 .
	gsmp_£nd_°›
 = 
«tive_smp_£nd_°›
,

230 .
	gsmp_£nd_ªscheduÀ
 = 
«tive_smp_£nd_ªscheduÀ
,

232 .
	g˝u_up
 = 
«tive_˝u_up
,

233 .
	g˝u_dõ
 = 
«tive_˝u_dõ
,

234 .
	g˝u_dißbÀ
 = 
«tive_˝u_dißbÀ
,

235 .
	g∂ay_dód
 = 
«tive_∂ay_dód
,

237 .
	g£nd_ˇŒ_func_ùi
 = 
«tive_£nd_ˇŒ_func_ùi
,

238 .
	g£nd_ˇŒ_func_sögÀ_ùi
 = 
«tive_£nd_ˇŒ_func_sögÀ_ùi
,

240 
EXPORT_SYMBOL_GPL
(
smp_›s
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<löux/öô.h
>

43 
	~<löux/smp.h
>

44 
	~<löux/moduÀ.h
>

45 
	~<löux/sched.h
>

46 
	~<löux/≥r˝u.h
>

47 
	~<löux/boŸmem.h
>

48 
	~<löux/îr.h
>

49 
	~<löux/nmi.h
>

51 
	~<asm/a˝i.h
>

52 
	~<asm/desc.h
>

53 
	~<asm/nmi.h
>

54 
	~<asm/úq.h
>

55 
	~<asm/idÀ.h
>

56 
	~<asm/åampﬁöe.h
>

57 
	~<asm/˝u.h
>

58 
	~<asm/numa.h
>

59 
	~<asm/pgèbÀ.h
>

60 
	~<asm/ébÊush.h
>

61 
	~<asm/mår.h
>

62 
	~<asm/vmi.h
>

63 
	~<asm/≠ic.h
>

64 
	~<asm/£tup.h
>

65 
	~<asm/uv/uv.h
>

66 
	~<löux/mc146818πc.h
>

68 
	~<asm/smpboŸ_hooks.h
>

70 #ifde‡
CONFIG_X86_32


71 
u8
 
	g≠icid_2_node
[
MAX_APICID
];

72 
	glow_m≠pögs
;

76 
DEFINE_PER_CPU
(, 
˝u_°©e
) = { 0 };

82 #ifde‡
CONFIG_HOTPLUG_CPU


87 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
idÀ_thªad_¨øy
);

88 
	#gë_idÀ_f‹_˝u
(
x
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, x))

	)

89 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, xË’))

	)

91 
èsk_°ru˘
 *
	gidÀ_thªad_¨øy
[
NR_CPUS
] 
	g__˝uöôd©a
 ;

92 
	#gë_idÀ_f‹_˝u
(
x
Ë(
idÀ_thªad_¨øy
[(x)])

	)

93 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
idÀ_thªad_¨øy
[(x)] = (p))

	)

97 
	gsmp_num_siblögs
 = 1;

98 
EXPORT_SYMBOL
(
smp_num_siblögs
);

101 
DEFINE_PER_CPU
(
u16
, 
˝u_Œc_id
Ë
BAD_APICID
;

104 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_siblög_m≠
);

105 
EXPORT_PER_CPU_SYMBOL
(
˝u_siblög_m≠
);

108 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_c‹e_m≠
);

109 
EXPORT_PER_CPU_SYMBOL
(
˝u_c‹e_m≠
);

112 
DEFINE_PER_CPU_SHARED_ALIGNED
(
˝uöfo_x86
, 
˝u_öfo
);

113 
EXPORT_PER_CPU_SYMBOL
(
˝u_öfo
);

115 
©omic_t
 
	göô_dós£πed
;

117 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_32
)

119 
	g˝u_to_node_m≠
[
NR_CPUS
] 
	g__ªad_mo°ly
 = { [0 ... NR_CPUS-1] = 0 };

120 
EXPORT_SYMBOL
(
˝u_to_node_m≠
);

123 
	$m≠_˝u_to_node
(
˝u
, 
node
)

125 
	`¥ötk
(
KERN_INFO
 "M≠pög cpu %dÅÿnodê%d\n", 
˝u
, 
node
);

126 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

127 
˝u_to_node_m≠
[
˝u
] = 
node
;

128 
	}
}

131 
	$unm≠_˝u_to_node
(
˝u
)

133 
node
;

135 
	`¥ötk
(
KERN_INFO
 "Unm≠pög cpu %d fromáŒÇodes\n", 
˝u
);

136 
node
 = 0;Çodê< 
MAX_NUMNODES
;Çode++)

137 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

138 
˝u_to_node_m≠
[
˝u
] = 0;

139 
	}
}

141 
	#m≠_˝u_to_node
(
˝u
, 
node
Ë({})

	)

142 
	#unm≠_˝u_to_node
(
˝u
Ë({})

	)

145 #ifde‡
CONFIG_X86_32


146 
	gboŸ_˝u_logiˇl_≠icid
;

148 
u8
 
	g˝u_2_logiˇl_≠icid
[
NR_CPUS
] 
	g__ªad_mo°ly
 =

149 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

151 
	$m≠_˝u_to_logiˇl_≠icid
()

153 
˝u
 = 
	`smp_¥o˚ss‹_id
();

154 
≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

155 
node
 = 
≠ic
->
	`≠icid_to_node
(
≠icid
);

157 i‡(!
	`node_⁄löe
(
node
))

158 
node
 = 
fú°_⁄löe_node
;

160 
˝u_2_logiˇl_≠icid
[
˝u
] = 
≠icid
;

161 
	`m≠_˝u_to_node
(
˝u
, 
node
);

162 
	}
}

164 
	$numa_ªmove_˝u
(
˝u
)

166 
˝u_2_logiˇl_≠icid
[
˝u
] = 
BAD_APICID
;

167 
	`unm≠_˝u_to_node
(
˝u
);

168 
	}
}

170 
	#m≠_˝u_to_logiˇl_≠icid
(Ëdÿ{} 0)

	)

177 
__˝uöô
 
	$smp_ˇŒö
()

179 
˝uid
, 
phys_id
;

180 
timeout
;

188 i‡(
≠ic
->
waô_f‹_öô_dós£π
)

189 
≠ic
->
	`waô_f‹_öô_dós£π
(&
öô_dós£πed
);

194 
phys_id
 = 
	`ªad_≠ic_id
();

195 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

196 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒö_mask
)) {

197 
	`∑nic
("%s:Öhy†CPU#%d, CPU#%dáÃódyÖª£¡??\n", 
__func__
,

198 
phys_id
, 
˝uid
);

200 
	`¥_debug
("CPU#%d (phy†ID: %dËwaôög f‹ CALLOUT\n", 
˝uid
, 
phys_id
);

213 
timeout
 = 
jiffõs
 + 2*
HZ
;

214 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

218 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒout_mask
))

220 
	`˝u_ªœx
();

223 i‡(!
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

224 
	`∑nic
("%s: CPU%d started up but didÇot getá callout!\n",

225 
__func__
, 
˝uid
);

235 
	`¥_debug
("CALLIN, before setup_local_APIC().\n");

236 i‡(
≠ic
->
smp_ˇŒö_˛ór_loˇl_≠ic
)

237 
≠ic
->
	`smp_ˇŒö_˛ór_loˇl_≠ic
();

238 
	`£tup_loˇl_APIC
();

239 
	`íd_loˇl_APIC_£tup
();

240 
	`m≠_˝u_to_logiˇl_≠icid
();

242 
	`nŸify_˝u_°¨tög
(
˝uid
);

249 
	`loˇl_úq_íabÀ
();

250 
	`ˇlibøã_dñay
();

251 
	`loˇl_úq_dißbÀ
();

252 
	`¥_debug
("Sèckáàabouà%p\n", &
˝uid
);

257 
	`smp_°‹e_˝u_öfo
(
˝uid
);

262 
	`˝umask_£t_˝u
(
˝uid
, 
˝u_ˇŒö_mask
);

263 
	}
}

268 
nŸø˚
 
__˝uöô
 
	$°¨t_£c⁄d¨y
(*
unu£d
)

275 
	`vmi_brögup
();

276 
	`˝u_öô
();

277 
	`¥ìm±_dißbÀ
();

278 
	`smp_ˇŒö
();

281 
	`b¨rõr
();

285 
	`check_tsc_sync_èrgë
();

287 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

288 
	`dißbÀ_8259A_úq
(0);

289 
	`íabÀ_NMI_through_LVT0
();

290 
	`íabÀ_8259A_úq
(0);

293 #ifde‡
CONFIG_X86_32


294 
low_m≠pögs
)

295 
	`˝u_ªœx
();

296 
	`__Êush_éb_Æl
();

300 
	`£t_˝u_siblög_m≠
(
	`øw_smp_¥o˚ss‹_id
());

301 
	`wmb
();

315 
	`ùi_ˇŒ_lock
();

316 
	`lock_ve˘‹_lock
();

317 
	`__£tup_ve˘‹_úq
(
	`smp_¥o˚ss‹_id
());

318 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
åue
);

319 
	`u∆ock_ve˘‹_lock
();

320 
	`ùi_ˇŒ_u∆ock
();

321 
	`≥r_˝u
(
˝u_°©e
, 
	`smp_¥o˚ss‹_id
()Ë
CPU_ONLINE
;

324 
	`loˇl_úq_íabÀ
();

326 
	`£tup_£c⁄d¨y_˛ock
();

328 
	`wmb
();

329 
	`˝u_idÀ
();

330 
	}
}

332 #ifde‡
CONFIG_CPUMASK_OFFSTACK


334 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

335 c⁄° 
˝uöfo_x86
 *
§c
)

337 
˝umask
 *
Œc
 = 
d°
->
Œc_sh¨ed_m≠
;

338 *
d°
 = *
§c
;

339 
d°
->
Œc_sh¨ed_m≠
 = 
Œc
;

340 
	}
}

342 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

343 c⁄° 
˝uöfo_x86
 *
§c
)

345 *
d°
 = *
§c
;

346 
	}
}

354 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
id
)

356 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
id
);

358 
	`c›y_˝uöfo_x86
(
c
, &
boŸ_˝u_d©a
);

359 
c
->
˝u_ödex
 = 
id
;

360 i‡(
id
 != 0)

361 
	`idítify_£c⁄d¨y_˝u
(
c
);

362 
	}
}

365 
__˝uöô
 
	$£t_˝u_siblög_m≠
(
˝u
)

367 
i
;

368 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

370 
	`˝umask_£t_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

372 i‡(
smp_num_siblögs
 > 1) {

373 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

374 
˝uöfo_x86
 *
o
 = &
	`˝u_d©a
(
i
);

376 i‡(
c
->
phys_¥oc_id
 =
o
->phys_proc_id &&

377 
c
->
˝u_c‹e_id
 =
o
->cpu_core_id) {

378 
	`˝umask_£t_˝u
(
i
, 
	`˝u_siblög_mask
(
˝u
));

379 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(
i
));

380 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

381 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

382 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

383 
	`˝umask_£t_˝u
(
˝u
, 
o
->
Œc_sh¨ed_m≠
);

387 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(cpu));

390 
	`˝umask_£t_˝u
(
˝u
, 
c
->
Œc_sh¨ed_m≠
);

392 i‡(
cuºít_˝u_d©a
.
x86_max_c‹es
 == 1) {

393 
	`˝umask_c›y
(
	`˝u_c‹e_mask
(
˝u
), 
	`˝u_siblög_mask
(cpu));

394 
c
->
boŸed_c‹es
 = 1;

398 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

399 i‡(
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë!
BAD_APICID
 &&

400 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë=≥r_˝u(˝u_Œc_id, 
i
)) {

401 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

402 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

404 i‡(
c
->
phys_¥oc_id
 =
	`˝u_d©a
(
i
).phys_proc_id) {

405 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

406 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

410 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1) {

415 i‡(
	`˝umask_fú°
(
	`˝u_siblög_mask
(
i
)) == i)

416 
c
->
boŸed_c‹es
++;

421 i‡(
i
 !
˝u
)

422 
	`˝u_d©a
(
i
).
boŸed_c‹es
++;

423 } i‡(
i
 !
˝u
 && !
c
->
boŸed_c‹es
)

424 
c
->
boŸed_c‹es
 = 
	`˝u_d©a
(
i
).booted_cores;

427 
	}
}

430 c⁄° 
˝umask
 *
	$˝u_c‹egroup_mask
(
˝u
)

432 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

437 i‡(
sched_mc_powî_ßvögs
 || 
sched_smt_powî_ßvögs
)

438  
	`˝u_c‹e_mask
(
˝u
);

440  
c
->
Œc_sh¨ed_m≠
;

441 
	}
}

443 
	$im¥ess_‰õnds
()

445 
˝u
;

446 
bogosum
 = 0;

450 
	`¥_debug
("Before bogomips.\n");

451 
	`f‹_óch_possibÀ_˝u
(
˝u
)

452 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒout_mask
))

453 
bogosum
 +
	`˝u_d©a
(
˝u
).
lo›s_≥r_jiffy
;

454 
	`¥ötk
(
KERN_INFO


456 
	`num_⁄löe_˝us
(),

457 
bogosum
/(500000/
HZ
),

458 (
bogosum
/(5000/
HZ
))%100);

460 
	`¥_debug
("Before bogocount - settingáctivated=1.\n");

461 
	}
}

463 
	$__öquúe_ªmŸe_≠ic
(
≠icid
)

465 
i
, 
ªgs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

466 *
«mes
[] = { "ID", "VERSION", "SPIV" };

467 
timeout
;

468 
u32
 
°©us
;

470 
	`¥ötk
(
KERN_INFO
 "InquúögÑemŸêAPIC 0x%x...\n", 
≠icid
);

472 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªgs
); i++) {

473 
	`¥ötk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
≠icid
, 
«mes
[
i
]);

478 
°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

479 i‡(
°©us
)

480 
	`¥ötk
(
KERN_CONT


483 
	`≠ic_i¸_wrôe
(
APIC_DM_REMRD
 | 
ªgs
[
i
], 
≠icid
);

485 
timeout
 = 0;

487 
	`udñay
(100);

488 
°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_RR_MASK
;

489 } 
°©us
 =
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

491 
°©us
) {

492 
APIC_ICR_RR_VALID
:

493 
°©us
 = 
	`≠ic_ªad
(
APIC_RRR
);

494 
	`¥ötk
(
KERN_CONT
 "%08x\n", 
°©us
);

497 
	`¥ötk
(
KERN_CONT
 "failed\n");

500 
	}
}

507 
__˝uöô


508 
	$wakeup_£c⁄d¨y_˝u_vü_nmi
(
logiˇl_≠icid
, 
°¨t_eù
)

510 
£nd_°©us
, 
ac˚±_°©us
 = 0;

511 
maxlvt
;

516 
	`≠ic_i¸_wrôe
(
APIC_DM_NMI
 | 
≠ic
->
de°_logiˇl
, 
logiˇl_≠icid
);

518 
	`¥_debug
("Waiting for sendÅo finish...\n");

519 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

524 
	`udñay
(200);

525 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

526 
maxlvt
 = 
	`œpic_gë_maxlvt
();

527 i‡(
maxlvt
 > 3)

528 
	`≠ic_wrôe
(
APIC_ESR
, 0);

529 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

531 
	`¥_debug
("NMI sent.\n");

533 i‡(
£nd_°©us
)

534 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

535 i‡(
ac˚±_°©us
)

536 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

538  (
£nd_°©us
 | 
ac˚±_°©us
);

539 
	}
}

541 
__˝uöô


542 
	$wakeup_£c⁄d¨y_˝u_vü_öô
(
phys_≠icid
, 
°¨t_eù
)

544 
£nd_°©us
, 
ac˚±_°©us
 = 0;

545 
maxlvt
, 
num_°¨ts
, 
j
;

547 
maxlvt
 = 
	`œpic_gë_maxlvt
();

552 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
])) {

553 i‡(
maxlvt
 > 3)

554 
	`≠ic_wrôe
(
APIC_ESR
, 0);

555 
	`≠ic_ªad
(
APIC_ESR
);

558 
	`¥_debug
("Asserting INIT.\n");

566 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

567 
phys_≠icid
);

569 
	`¥_debug
("Waiting for sendÅo finish...\n");

570 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

572 
	`mdñay
(10);

574 
	`¥_debug
("Deasserting INIT.\n");

578 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_≠icid
);

580 
	`¥_debug
("Waiting for sendÅo finish...\n");

581 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

583 
	`mb
();

584 
	`©omic_£t
(&
öô_dós£πed
, 1);

592 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
]))

593 
num_°¨ts
 = 2;

595 
num_°¨ts
 = 0;

601 
	`°¨tup_ùi_hook
(
phys_≠icid
, (Ë
°¨t_£c⁄d¨y
,

602 ()
°ack_°¨t
.
•
);

607 
	`¥_debug
("#°¨tu∞lo›s: %d.\n", 
num_°¨ts
);

609 
j
 = 1; j <
num_°¨ts
; j++) {

610 
	`¥_debug
("Sídög STARTUP #%d.\n", 
j
);

611 i‡(
maxlvt
 > 3)

612 
	`≠ic_wrôe
(
APIC_ESR
, 0);

613 
	`≠ic_ªad
(
APIC_ESR
);

614 
	`¥_debug
("Afterápic_write.\n");

623 
	`≠ic_i¸_wrôe
(
APIC_DM_STARTUP
 | (
°¨t_eù
 >> 12),

624 
phys_≠icid
);

629 
	`udñay
(300);

631 
	`¥_debug
("StartupÖoint 1.\n");

633 
	`¥_debug
("Waiting for sendÅo finish...\n");

634 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

639 
	`udñay
(200);

640 i‡(
maxlvt
 > 3)

641 
	`≠ic_wrôe
(
APIC_ESR
, 0);

642 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

643 i‡(
£nd_°©us
 || 
ac˚±_°©us
)

646 
	`¥_debug
("After Startup.\n");

648 i‡(
£nd_°©us
)

649 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

650 i‡(
ac˚±_°©us
)

651 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

653  (
£nd_°©us
 | 
ac˚±_°©us
);

654 
	}
}

656 
	s¸óã_idÀ
 {

657 
w‹k_°ru˘
 
	mw‹k
;

658 
èsk_°ru˘
 *
	midÀ
;

659 
com∂ëi⁄
 
	md⁄e
;

660 
	m˝u
;

663 
__˝uöô
 
	$do_f‹k_idÀ
(
w‹k_°ru˘
 *
w‹k
)

665 
¸óã_idÀ
 *
c_idÀ
 =

666 
	`c⁄èöî_of
(
w‹k
, 
¸óã_idÀ
, work);

668 
c_idÀ
->
idÀ
 = 
	`f‹k_idÀ
(c_idÀ->
˝u
);

669 
	`com∂ëe
(&
c_idÀ
->
d⁄e
);

670 
	}
}

678 
__˝uöô
 
	$do_boŸ_˝u
(
≠icid
, 
˝u
)

680 
boŸ_îr‹
 = 0;

681 
°¨t_ù
;

682 
timeout
;

683 
¸óã_idÀ
 
c_idÀ
 = {

684 .
˝u
 = cpu,

685 .
d⁄e
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idÀ
.done),

688 
	`INIT_WORK
(&
c_idÀ
.
w‹k
, 
do_f‹k_idÀ
);

690 
	`Æã∫©ives_smp_swôch
(1);

692 
c_idÀ
.
idÀ
 = 
	`gë_idÀ_f‹_˝u
(
˝u
);

698 i‡(
c_idÀ
.
idÀ
) {

699 
c_idÀ
.
idÀ
->
thªad
.
•
 = (Ë(((
±_ªgs
 *)

700 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
))) - 1);

701 
	`öô_idÀ
(
c_idÀ
.
idÀ
, 
˝u
);

702 
do_ª°
;

705 i‡(!
	`kevítd_up
(Ë|| 
	`cuºít_is_kevítd
())

706 
c_idÀ
.
w‹k
.
	`func
(&c_idle.work);

708 
	`scheduÀ_w‹k
(&
c_idÀ
.
w‹k
);

709 
	`waô_f‹_com∂ëi⁄
(&
c_idÀ
.
d⁄e
);

712 i‡(
	`IS_ERR
(
c_idÀ
.
idÀ
)) {

713 
	`¥ötk
("Áûed f‹k f‹ CPU %d\n", 
˝u
);

714  
	`PTR_ERR
(
c_idÀ
.
idÀ
);

717 
	`£t_idÀ_f‹_˝u
(
˝u
, 
c_idÀ
.
idÀ
);

718 
do_ª°
:

719 
	`≥r_˝u
(
cuºít_èsk
, 
˝u
Ë
c_idÀ
.
idÀ
;

720 #ifde‡
CONFIG_X86_32


722 
	`úq_˘x_öô
(
˝u
);

724 
	`˛ór_tsk_thªad_Êag
(
c_idÀ
.
idÀ
, 
TIF_FORK
);

725 
öôül_gs
 = 
	`≥r_˝u_off£t
(
˝u
);

726 
	`≥r_˝u
(
kî√l_°ack
, 
˝u
) =

727 ()
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
) -

728 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

730 
óæy_gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

731 
öôül_code
 = ()
°¨t_£c⁄d¨y
;

732 
°ack_°¨t
.
•
 = (*Ë
c_idÀ
.
idÀ
->
thªad
.sp;

735 
°¨t_ù
 = 
	`£tup_åampﬁöe
();

738 
	`¥ötk
(
KERN_INFO
 "BootingÖrocessor %d APIC 0x%x ip 0x%lx\n",

739 
˝u
, 
≠icid
, 
°¨t_ù
);

746 
	`©omic_£t
(&
öô_dós£πed
, 0);

748 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

750 
	`¥_debug
("Setting warmÑeset codeánd vector.\n");

752 
	`smpboŸ_£tup_w¨m_ª£t_ve˘‹
(
°¨t_ù
);

756 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

757 
	`≠ic_wrôe
(
APIC_ESR
, 0);

758 
	`≠ic_ªad
(
APIC_ESR
);

766 i‡(
≠ic
->
wakeup_£c⁄d¨y_˝u
)

767 
boŸ_îr‹
 = 
≠ic
->
	`wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_ù
);

769 
boŸ_îr‹
 = 
	`wakeup_£c⁄d¨y_˝u_vü_öô
(
≠icid
, 
°¨t_ù
);

771 i‡(!
boŸ_îr‹
) {

775 
	`¥_debug
("Bef‹êCÆlouà%d.\n", 
˝u
);

776 
	`˝umask_£t_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

777 
	`¥_debug
("A·î CÆlouà%d.\n", 
˝u
);

782 
timeout
 = 0;Åimeout < 50000;Åimeout++) {

783 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

785 
	`udñay
(100);

788 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

790 
	`¥_debug
("OK.\n");

791 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 
˝u
);

792 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(
˝u
));

793 
	`¥_debug
("CPU has booted.\n");

795 
boŸ_îr‹
 = 1;

796 i‡(*((vﬁ©ûê*)
åampﬁöe_ba£
)

799 
	`¥ötk
(
KERN_ERR
 "Stuck ??\n");

802 
	`¥ötk
(
KERN_ERR
 "NotÑesponding.\n");

803 i‡(
≠ic
->
öquúe_ªmŸe_≠ic
)

804 
≠ic
->
	`öquúe_ªmŸe_≠ic
(
≠icid
);

808 i‡(
boŸ_îr‹
) {

810 
	`numa_ªmove_˝u
(
˝u
);

813 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

816 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

818 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

819 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
BAD_APICID
;

823 *((vﬁ©ûê*)
åampﬁöe_ba£
) = 0;

825 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

829 
	`smpboŸ_ª°‹e_w¨m_ª£t_ve˘‹
();

832  
boŸ_îr‹
;

833 
	}
}

835 
__˝uöô
 
	$«tive_˝u_up
(
˝u
)

837 
≠icid
 = 
≠ic
->
	`˝u_¥e£¡_to_≠icid
(
˝u
);

838 
Êags
;

839 
îr
;

841 
	`WARN_ON
(
	`úqs_dißbÀd
());

843 
	`¥_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
˝u
);

845 i‡(
≠icid
 =
BAD_APICID
 ||ápicid =
boŸ_˝u_physiˇl_≠icid
 ||

846 !
	`physid_is£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
)) {

847 
	`¥ötk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
˝u
);

848  -
EINVAL
;

854 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

855 
	`¥_debug
("do_boŸ_˝u %d AÃódy sèπed\n", 
˝u
);

856  -
ENOSYS
;

863 
	`mår_ßve_°©e
();

865 
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë
CPU_UP_PREPARE
;

867 #ifde‡
CONFIG_X86_32


869 
	`˛⁄e_pgd_ønge
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

870 
	`mö_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

871 
	`Êush_éb_Æl
();

872 
low_m≠pögs
 = 1;

874 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

876 
	`z≠_low_m≠pögs
(
Ál£
);

877 
low_m≠pögs
 = 0;

879 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

881 i‡(
îr
) {

882 
	`¥_debug
("do_boŸ_˝u faûed %d\n", 
îr
);

883  -
EIO
;

890 
	`loˇl_úq_ßve
(
Êags
);

891 
	`check_tsc_sync_sour˚
(
˝u
);

892 
	`loˇl_úq_ª°‹e
(
Êags
);

894 !
	`˝u_⁄löe
(
˝u
)) {

895 
	`˝u_ªœx
();

896 
	`touch_nmi_w©chdog
();

900 
	}
}

907 
__öô
 
	$dißbÀ_smp
()

909 
	`öô_˝u_¥e£¡
(
	`˝umask_of
(0));

910 
	`öô_˝u_possibÀ
(
	`˝umask_of
(0));

911 
	`smpboŸ_˛ór_io_≠ic_úqs
();

913 i‡(
smp_found_c⁄fig
)

914 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

916 
	`physid_£t_mask_of_physid
(0, &
phys_˝u_¥e£¡_m≠
);

917 
	`m≠_˝u_to_logiˇl_≠icid
();

918 
	`˝umask_£t_˝u
(0, 
	`˝u_siblög_mask
(0));

919 
	`˝umask_£t_˝u
(0, 
	`˝u_c‹e_mask
(0));

920 
	}
}

925 
__öô
 
	$smp_ßnôy_check
(
max_˝us
)

927 
	`¥ìm±_dißbÀ
();

929 #i‡!
	`deföed
(
CONFIG_X86_BIGSMP
Ë&& deföed(
CONFIG_X86_32
)

930 i‡(
def_to_bigsmp
 && 
ƒ_˝u_ids
 > 8) {

931 
˝u
;

932 
ƒ
;

934 
	`¥ötk
(
KERN_WARNING


938 
ƒ
 = 0;

939 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

940 i‡(
ƒ
 >= 8)

941 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

942 
ƒ
++;

945 
ƒ
 = 0;

946 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

947 i‡(
ƒ
 >= 8)

948 
	`£t_˝u_possibÀ
(
˝u
, 
Ál£
);

949 
ƒ
++;

952 
ƒ_˝u_ids
 = 8;

956 i‡(!
	`physid_is£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
)) {

957 
	`¥ötk
(
KERN_WARNING


959 
	`h¨d_smp_¥o˚ss‹_id
());

961 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

968 i‡(!
smp_found_c⁄fig
 && !
a˝i_œpic
) {

969 
	`¥ìm±_íabÀ
();

970 
	`¥ötk
(
KERN_NOTICE
 "SMP motherboardÇot detected.\n");

971 
	`dißbÀ_smp
();

972 i‡(
	`APIC_öô_unùro˚ss‹
())

973 
	`¥ötk
(
KERN_NOTICE
 "Local APICÇot detected."

982 i‡(!
≠ic
->
	`check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)) {

983 
	`¥ötk
(
KERN_NOTICE


985 
boŸ_˝u_physiˇl_≠icid
);

986 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

988 
	`¥ìm±_íabÀ
();

993 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]) &&

994 !
˝u_has_≠ic
) {

995 i‡(!
dißbÀ_≠ic
) {

996 
	`¥_îr
("BIOS bug,Üocal APIC #%dÇot detected!...\n",

997 
boŸ_˝u_physiˇl_≠icid
);

998 
	`¥_îr
("... forcing use of dummy APICÉmulation."

1001 
	`smpboŸ_˛ór_io_≠ic
();

1002 
	`¨ch_dißbÀ_smp_suµ‹t
();

1006 
	`vîify_loˇl_APIC
();

1011 i‡(!
max_˝us
) {

1012 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

1013 
	`smpboŸ_˛ór_io_≠ic
();

1015 
	`loˇli£_nmi_w©chdog
();

1017 
	`c⁄√˘_b•_APIC
();

1018 
	`£tup_loˇl_APIC
();

1019 
	`íd_loˇl_APIC_£tup
();

1024 
	}
}

1026 
__öô
 
	$smp_˝u_ödex_deÁu…
()

1028 
i
;

1029 
˝uöfo_x86
 *
c
;

1031 
	`f‹_óch_possibÀ_˝u
(
i
) {

1032 
c
 = &
	`˝u_d©a
(
i
);

1034 
c
->
˝u_ödex
 = 
ƒ_˝u_ids
;

1036 
	}
}

1042 
__öô
 
	$«tive_smp_¥ï¨e_˝us
(
max_˝us
)

1044 
i
;

1046 
	`¥ìm±_dißbÀ
();

1047 
	`smp_˝u_ödex_deÁu…
();

1048 
cuºít_˝u_d©a
 = 
boŸ_˝u_d©a
;

1049 
	`˝umask_c›y
(
˝u_ˇŒö_mask
, 
	`˝umask_of
(0));

1050 
	`mb
();

1054 
	`smp_°‹e_˝u_öfo
(0);

1055 #ifde‡
CONFIG_X86_32


1056 
boŸ_˝u_logiˇl_≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

1058 
	`cuºít_thªad_öfo
()->
˝u
 = 0;

1059 
	`f‹_óch_possibÀ_˝u
(
i
) {

1060 
	`Æloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
), 
GFP_KERNEL
);

1061 
	`Æloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
), 
GFP_KERNEL
);

1062 
	`Æloc_˝umask_v¨
(&
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
, 
GFP_KERNEL
);

1063 
	`˝umask_˛ór
(
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
));

1064 
	`˝umask_˛ór
(
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
));

1065 
	`˝umask_˛ór
(
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

1067 
	`£t_˝u_siblög_m≠
(0);

1069 
	`íabÀ_IR_x2≠ic
();

1070 #ifde‡
CONFIG_X86_64


1071 
	`deÁu…_£tup_≠ic_routög
();

1074 i‡(
	`smp_ßnôy_check
(
max_˝us
) < 0) {

1075 
	`¥ötk
(
KERN_INFO
 "SMP disabled\n");

1076 
	`dißbÀ_smp
();

1077 
out
;

1080 
	`¥ìm±_dißbÀ
();

1081 i‡(
	`ªad_≠ic_id
(Ë!
boŸ_˝u_physiˇl_≠icid
) {

1082 
	`∑nic
("Boot APIC ID inÜocal APIC unexpected (%d vs %d)",

1083 
	`ªad_≠ic_id
(), 
boŸ_˝u_physiˇl_≠icid
);

1086 
	`¥ìm±_íabÀ
();

1088 
	`c⁄√˘_b•_APIC
();

1093 
	`£tup_loˇl_APIC
();

1098 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1099 
	`íabÀ_IO_APIC
();

1101 
	`íd_loˇl_APIC_£tup
();

1103 
	`m≠_˝u_to_logiˇl_≠icid
();

1105 i‡(
≠ic
->
£tup_p‹tio_ªm≠
)

1106 
≠ic
->
	`£tup_p‹tio_ªm≠
();

1108 
	`smpboŸ_£tup_io_≠ic
();

1113 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 0);

1114 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(0));

1115 
	`£tup_boŸ_˛ock
();

1117 i‡(
	`is_uv_sy°em
())

1118 
	`uv_sy°em_öô
();

1119 
out
:

1120 
	`¥ìm±_íabÀ
();

1121 
	}
}

1125 
__öô
 
	$«tive_smp_¥ï¨e_boŸ_˝u
()

1127 
me
 = 
	`smp_¥o˚ss‹_id
();

1128 
	`swôch_to_√w_gdt
(
me
);

1130 
	`˝umask_£t_˝u
(
me
, 
˝u_ˇŒout_mask
);

1131 
	`≥r_˝u
(
˝u_°©e
, 
me
Ë
CPU_ONLINE
;

1132 
	}
}

1134 
__öô
 
	$«tive_smp_˝us_d⁄e
(
max_˝us
)

1136 
	`¥_debug
("Boot done.\n");

1138 
	`im¥ess_‰õnds
();

1139 #ifde‡
CONFIG_X86_IO_APIC


1140 
	`£tup_iﬂpic_de°
();

1142 
	`check_nmi_w©chdog
();

1143 
	}
}

1145 
__öôd©a
 
	g£tup_possibÀ_˝us
 = -1;

1146 
__öô
 
	$_£tup_possibÀ_˝us
(*
°r
)

1148 
	`gë_›ti⁄
(&
°r
, &
£tup_possibÀ_˝us
);

1150 
	}
}

1151 
óæy_∑øm
("possibÀ_˝us", 
_£tup_possibÀ_˝us
);

1171 
__öô
 
	$¥efûl_possibÀ_m≠
()

1173 
i
, 
possibÀ
;

1176 i‡(!
num_¥o˚ss‹s
)

1177 
num_¥o˚ss‹s
 = 1;

1179 i‡(
£tup_possibÀ_˝us
 == -1)

1180 
possibÀ
 = 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
;

1182 
possibÀ
 = 
£tup_possibÀ_˝us
;

1184 
tŸÆ_˝us
 = 
	`max_t
(, 
possibÀ
, 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
);

1186 i‡(
possibÀ
 > 
CONFIG_NR_CPUS
) {

1187 
	`¥ötk
(
KERN_WARNING


1189 
possibÀ
, 
CONFIG_NR_CPUS
);

1190 
possibÀ
 = 
CONFIG_NR_CPUS
;

1193 
	`¥ötk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1194 
possibÀ
, 
	`max_t
(,ÖossibÀ - 
num_¥o˚ss‹s
, 0));

1196 
i
 = 0; i < 
possibÀ
; i++)

1197 
	`£t_˝u_possibÀ
(
i
, 
åue
);

1199 
ƒ_˝u_ids
 = 
possibÀ
;

1200 
	}
}

1202 #ifde‡
CONFIG_HOTPLUG_CPU


1204 
	$ªmove_siblögöfo
(
˝u
)

1206 
siblög
;

1207 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

1209 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_c‹e_mask
(
˝u
)) {

1210 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
siblög
));

1214 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1)

1215 
	`˝u_d©a
(
siblög
).
boŸed_c‹es
--;

1218 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_siblög_mask
(
˝u
))

1219 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_siblög_mask
(
siblög
));

1220 
	`˝umask_˛ór
(
	`˝u_siblög_mask
(
˝u
));

1221 
	`˝umask_˛ór
(
	`˝u_c‹e_mask
(
˝u
));

1222 
c
->
phys_¥oc_id
 = 0;

1223 
c
->
˝u_c‹e_id
 = 0;

1224 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

1225 
	}
}

1227 
__ªf
 
	$ªmove_˝u_‰om_m≠s
(
˝u
)

1229 
	`£t_˝u_⁄löe
(
˝u
, 
Ál£
);

1230 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

1231 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒö_mask
);

1233 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

1234 
	`numa_ªmove_˝u
(
˝u
);

1235 
	}
}

1237 
	$˝u_dißbÀ_comm⁄
()

1239 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1246 
	`loˇl_úq_íabÀ
();

1247 
	`mdñay
(1);

1249 
	`loˇl_úq_dißbÀ
();

1250 
	`ªmove_siblögöfo
(
˝u
);

1253 
	`lock_ve˘‹_lock
();

1254 
	`ªmove_˝u_‰om_m≠s
(
˝u
);

1255 
	`u∆ock_ve˘‹_lock
();

1256 
	`fixup_úqs
();

1257 
	}
}

1259 
	$«tive_˝u_dißbÀ
()

1261 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1271 i‡(
˝u
 == 0)

1272  -
EBUSY
;

1274 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

1275 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

1276 
	`˛ór_loˇl_APIC
();

1278 
	`˝u_dißbÀ_comm⁄
();

1280 
	}
}

1282 
	$«tive_˝u_dõ
(
˝u
)

1285 
i
;

1287 
i
 = 0; i < 10; i++) {

1289 i‡(
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë=
CPU_DEAD
) {

1290 
	`¥ötk
(
KERN_INFO
 "CPU %d i†now ofÊöe\n", 
˝u
);

1291 i‡(1 =
	`num_⁄löe_˝us
())

1292 
	`Æã∫©ives_smp_swôch
(0);

1295 
	`m¶ìp
(100);

1297 
	`¥ötk
(
KERN_ERR
 "CPU %u didn'àdõ...\n", 
˝u
);

1298 
	}
}

1300 
	$∂ay_dód_comm⁄
()

1302 
	`idÀ_èsk_exô
();

1303 
	`ª£t_œzy_éb°©e
();

1304 
	`úq_˘x_exô
(
	`øw_smp_¥o˚ss‹_id
());

1305 
	`c1e_ªmove_˝u
(
	`øw_smp_¥o˚ss‹_id
());

1307 
	`mb
();

1309 
	`__gë_˝u_v¨
(
˝u_°©e
Ë
CPU_DEAD
;

1314 
	`loˇl_úq_dißbÀ
();

1315 
	}
}

1317 
	$«tive_∂ay_dód
()

1319 
	`∂ay_dód_comm⁄
();

1320 
	`wbövd_hÆt
();

1321 
	}
}

1324 
	$«tive_˝u_dißbÀ
()

1326  -
ENOSYS
;

1327 
	}
}

1329 
	$«tive_˝u_dõ
(
˝u
)

1332 
	`BUG
();

1333 
	}
}

1335 
	$«tive_∂ay_dód
()

1337 
	`BUG
();

1338 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/uac˚ss.h
>

10 
	~<asm/°ackåa˚.h
>

12 
	$ßve_°ack_w¨nög
(*
d©a
, *
msg
)

14 
	}
}

17 
	$ßve_°ack_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

19 
	}
}

21 
	$ßve_°ack_°ack
(*
d©a
, *
«me
)

24 
	}
}

26 
	$ßve_°ack_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

28 
°ack_åa˚
 *
åa˚
 = 
d©a
;

29 i‡(!
ªlübÀ
)

31 i‡(
åa˚
->
skù
 > 0) {

32 
åa˚
->
skù
--;

35 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

36 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

37 
	}
}

40 
	$ßve_°ack_addªss_nosched
(*
d©a
, 
addr
, 
ªlübÀ
)

42 
°ack_åa˚
 *
åa˚
 = (°ack_åa˚ *)
d©a
;

43 i‡(!
ªlübÀ
)

45 i‡(
	`ö_sched_fun˘i⁄s
(
addr
))

47 i‡(
åa˚
->
skù
 > 0) {

48 
åa˚
->
skù
--;

51 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

53 
	}
}

55 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s
 = {

56 .
w¨nög
 = 
ßve_°ack_w¨nög
,

57 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

58 .
	g°ack
 = 
ßve_°ack_°ack
,

59 .
	gaddªss
 = 
ßve_°ack_addªss
,

62 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s_nosched
 = {

63 .
w¨nög
 = 
ßve_°ack_w¨nög
,

64 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

65 .
	g°ack
 = 
ßve_°ack_°ack
,

66 .
	gaddªss
 = 
ßve_°ack_addªss_nosched
,

72 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

74 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 0, &
ßve_°ack_›s
, 
åa˚
);

75 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

76 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

77 
	}
}

78 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚
);

80 
	$ßve_°ack_åa˚_bp
(
°ack_åa˚
 *
åa˚
, 
bp
)

82 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 
bp
, &
ßve_°ack_›s
, 
åa˚
);

83 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

84 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

85 
	}
}

87 
	$ßve_°ack_åa˚_tsk
(
èsk_°ru˘
 *
tsk
, 
°ack_åa˚
 *
åa˚
)

89 
	`dump_åa˚
(
tsk
, 
NULL
, NULL, 0, &
ßve_°ack_›s_nosched
, 
åa˚
);

90 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

91 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

92 
	}
}

93 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚_tsk
);

97 
	s°ack_‰ame
 {

98 c⁄° 
__u£r
 *
	m√xt_Â
;

99 
	mªt_addr
;

102 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

104 
ªt
;

106 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
Â
, (*
‰ame
)))

109 
ªt
 = 1;

110 
	`∑geÁu…_dißbÀ
();

111 i‡(
	`__c›y_‰om_u£r_ö©omic
(
‰ame
, 
Â
, (*frame)))

112 
ªt
 = 0;

113 
	`∑geÁu…_íabÀ
();

115  
ªt
;

116 
	}
}

118 
ölöe
 
	$__ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

120 c⁄° 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

121 c⁄° 
__u£r
 *
Â
 = (c⁄° __u£∏*)
ªgs
->
bp
;

123 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

124 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ªgs
->
ù
;

126 
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
) {

127 
°ack_‰ame
 
‰ame
;

129 
‰ame
.
√xt_Â
 = 
NULL
;

130 
‰ame
.
ªt_addr
 = 0;

131 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

133 i‡(()
Â
 < 
ªgs
->
•
)

135 i‡(
‰ame
.
ªt_addr
) {

136 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] =

137 
‰ame
.
ªt_addr
;

139 i‡(
Â
 =
‰ame
.
√xt_Â
)

141 
Â
 = 
‰ame
.
√xt_Â
;

143 
	}
}

145 
	$ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

150 i‡(
cuºít
->
mm
) {

151 
	`__ßve_°ack_åa˚_u£r
(
åa˚
);

153 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

154 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

155 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<löux/sched.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/±ø˚.h
>

8 
	$c⁄vît_ù_to_löór
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

10 
addr
, 
£g
;

12 
addr
 = 
ªgs
->
ù
;

13 
£g
 = 
ªgs
->
cs
 & 0xffff;

14 i‡(
	`v8086_mode
(
ªgs
)) {

15 
addr
 = (add∏& 0xffffË+ (
£g
 << 4);

16  
addr
;

25 i‡((
£g
 & 
SEGMENT_TI_MASK
Ë=
SEGMENT_LDT
) {

26 
u32
 *
desc
;

27 
ba£
;

29 
£g
 &= ~7UL;

31 
	`muãx_lock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

32 i‡(
	`u∆ikñy
((
£g
 >> 3Ë>
chûd
->
mm
->
c⁄ãxt
.
size
))

33 
addr
 = -1L;

35 
desc
 = 
chûd
->
mm
->
c⁄ãxt
.
ldt
 + 
£g
;

36 
ba£
 = ((
desc
[0] >> 16) |

37 ((
desc
[1] & 0xff) << 16) |

38 (
desc
[1] & 0xff000000));

41 i‡(!((
desc
[1] >> 22) & 1))

42 
addr
 &= 0xffff;

43 
addr
 +
ba£
;

45 
	`muãx_u∆ock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

48  
addr
;

49 
	}
}

51 
	$is_£âög_å≠_Êag
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

53 
i
, 
c›õd
;

54 
›code
[15];

55 
addr
 = 
	`c⁄vît_ù_to_löór
(
chûd
, 
ªgs
);

57 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, 
›code
, (opcode), 0);

58 
i
 = 0; i < 
c›õd
; i++) {

59 
›code
[
i
]) {

76 #ifde‡
CONFIG_X86_64


78 i‡(
ªgs
->
cs
 !
__USER_CS
)

100 
	}
}

105 
	$íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

107 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

108 
oÊags
;

120 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
)))

121 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

128 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

130 
oÊags
 = 
ªgs
->
Êags
;

133 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

144 i‡(
	`is_£âög_å≠_Êag
(
chûd
, 
ªgs
)) {

145 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

153 i‡(
oÊags
 & 
X86_EFLAGS_TF
)

154  
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

156 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

159 
	}
}

164 
	$wrôe_debug˘lm§
(
èsk_°ru˘
 *
chûd
, 
vÆ
)

166 i‡(
chûd
->
thªad
.
debug˘lm§
 =
vÆ
)

169 
chûd
->
thªad
.
debug˘lm§
 = 
vÆ
;

171 i‡(
chûd
 !
cuºít
)

174 
	`upd©e_debug˘lm§
(
vÆ
);

175 
	}
}

180 
	$íabÀ_°ï
(
èsk_°ru˘
 *
chûd
, 
boﬁ
 
block
)

189 i‡(
	`íabÀ_sögÀ_°ï
(
chûd
Ë&& 
block
) {

190 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

191 
	`wrôe_debug˘lm§
(
chûd
,

192 
chûd
->
thªad
.
debug˘lm§
 | 
DEBUGCTLMSR_BTF
);

194 
	`wrôe_debug˘lm§
(
chûd
,

195 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

197 i‡(!
chûd
->
thªad
.
debug˘lm§
)

198 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

200 
	}
}

202 
	$u£r_íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

204 
	`íabÀ_°ï
(
chûd
, 0);

205 
	}
}

207 
	$u£r_íabÀ_block_°ï
(
èsk_°ru˘
 *
chûd
)

209 
	`íabÀ_°ï
(
chûd
, 1);

210 
	}
}

212 
	$u£r_dißbÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

217 
	`wrôe_debug˘lm§
(
chûd
,

218 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

220 i‡(!
chûd
->
thªad
.
debug˘lm§
)

221 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

224 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

227 i‡(
	`ã°_™d_˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
))

228 
	`èsk_±_ªgs
(
chûd
)->
Êags
 &~
X86_EFLAGS_TF
;

229 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/sysˇŒs.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/fs.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/£m.h
>

8 
	~<löux/msg.h
>

9 
	~<löux/shm.h
>

10 
	~<löux/°©.h
>

11 
	~<löux/mm™.h
>

12 
	~<löux/fûe.h
>

13 
	~<löux/ut¢ame.h
>

14 
	~<löux/≥rs⁄Æôy.h
>

15 
	~<löux/øndom.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/ü32.h
>

19 
	~<asm/sysˇŒs.h
>

21 
asmlökage
 
	$sys_mm≠
(
addr
, 
Àn
,

22 
¥Ÿ
, 
Êags
,

23 
fd
, 
off
)

25 
îr‹
;

26 
fûe
 *file;

28 
îr‹
 = -
EINVAL
;

29 i‡(
off
 & ~
PAGE_MASK
)

30 
out
;

32 
îr‹
 = -
EBADF
;

33 
fûe
 = 
NULL
;

34 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

35 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

36 
fûe
 = 
	`fgë
(
fd
);

37 i‡(!
fûe
)

38 
out
;

40 
	`down_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

41 
îr‹
 = 
	`do_mm≠_pgoff
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
off
 >> 
PAGE_SHIFT
);

42 
	`up_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

44 i‡(
fûe
)

45 
	`Âut
(
fûe
);

46 
out
:

47  
îr‹
;

48 
	}
}

50 
	$föd_°¨t_íd
(
Êags
, *
begö
,

51 *
íd
)

53 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
)) {

54 
√w_begö
;

62 *
begö
 = 0x40000000;

63 *
íd
 = 0x80000000;

64 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

65 
√w_begö
 = 
	`øndomize_ønge
(*
begö
, *begin + 0x02000000, 0);

66 i‡(
√w_begö
)

67 *
begö
 = 
√w_begö
;

70 *
begö
 = 
TASK_UNMAPPED_BASE
;

71 *
íd
 = 
TASK_SIZE
;

73 
	}
}

76 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

77 
Àn
, 
pgoff
, 
Êags
)

79 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

80 
vm_¨ó_°ru˘
 *
vma
;

81 
°¨t_addr
;

82 
begö
, 
íd
;

84 i‡(
Êags
 & 
MAP_FIXED
)

85  
addr
;

87 
	`föd_°¨t_íd
(
Êags
, &
begö
, &
íd
);

89 i‡(
Àn
 > 
íd
)

90  -
ENOMEM
;

92 i‡(
addr
) {

93 
addr
 = 
	`PAGE_ALIGN
(addr);

94 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

95 i‡(
íd
 - 
Àn
 >
addr
 &&

96 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

97  
addr
;

99 i‡(((
Êags
 & 
MAP_32BIT
Ë|| 
	`ã°_thªad_Êag
(
TIF_IA32
))

100 && 
Àn
 <
mm
->
ˇched_hﬁe_size
) {

101 
mm
->
ˇched_hﬁe_size
 = 0;

102 
mm
->
‰ì_¨ó_ˇche
 = 
begö
;

104 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

105 i‡(
addr
 < 
begö
)

106 
addr
 = 
begö
;

107 
°¨t_addr
 = 
addr
;

109 
fuŒ_£¨ch
:

110 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

112 i‡(
íd
 - 
Àn
 < 
addr
) {

117 i‡(
°¨t_addr
 !
begö
) {

118 
°¨t_addr
 = 
addr
 = 
begö
;

119 
mm
->
ˇched_hﬁe_size
 = 0;

120 
fuŒ_£¨ch
;

122  -
ENOMEM
;

124 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

128 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

129  
addr
;

131 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

132 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

134 
addr
 = 
vma
->
vm_íd
;

136 
	}
}

140 
	$¨ch_gë_unm≠≥d_¨ó_t›down
(
fûe
 *
fûp
, c⁄° 
addr0
,

141 c⁄° 
Àn
, c⁄° 
pgoff
,

142 c⁄° 
Êags
)

144 
vm_¨ó_°ru˘
 *
vma
;

145 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

146 
addr
 = 
addr0
;

149 i‡(
Àn
 > 
TASK_SIZE
)

150  -
ENOMEM
;

152 i‡(
Êags
 & 
MAP_FIXED
)

153  
addr
;

156 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
))

157 
bŸtomup
;

160 i‡(
addr
) {

161 
addr
 = 
	`PAGE_ALIGN
(addr);

162 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

163 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

164 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

165  
addr
;

169 i‡(
Àn
 <
mm
->
ˇched_hﬁe_size
) {

170 
mm
->
ˇched_hﬁe_size
 = 0;

171 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

175 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

178 i‡(
addr
 > 
Àn
) {

179 
vma
 = 
	`föd_vma
(
mm
, 
addr
-
Àn
);

180 i‡(!
vma
 || 
addr
 <vma->
vm_°¨t
)

182  
mm
->
‰ì_¨ó_ˇche
 = 
addr
-
Àn
;

185 i‡(
mm
->
mm≠_ba£
 < 
Àn
)

186 
bŸtomup
;

188 
addr
 = 
mm
->
mm≠_ba£
-
Àn
;

196 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

197 i‡(!
vma
 || 
addr
+
Àn
 <vma->
vm_°¨t
)

199  
mm
->
‰ì_¨ó_ˇche
 = 
addr
;

202 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

203 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

206 
addr
 = 
vma
->
vm_°¨t
-
Àn
;

207 } 
Àn
 < 
vma
->
vm_°¨t
);

209 
bŸtomup
:

216 
mm
->
ˇched_hﬁe_size
 = ~0UL;

217 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

218 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó
(
fûp
, 
addr0
, 
Àn
, 
pgoff
, 
Êags
);

222 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

223 
mm
->
ˇched_hﬁe_size
 = ~0UL;

225  
addr
;

226 
	}
}

229 
asmlökage
 
	$sys_u«me
(
√w_ut¢ame
 
__u£r
 *
«me
)

231 
îr
;

232 
	`down_ªad
(&
uts_£m
);

233 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

234 
	`up_ªad
(&
uts_£m
);

235 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

236 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

237  
îr
 ? -
EFAULT
 : 0;

238 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<löux/lökage.h
>

4 
	~<löux/sys.h
>

5 
	~<löux/ˇche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
ƒ
, 
sym
Ë
asmlökage
 
	`sym
(Ë;

	)

11 #unde‡
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni°d_64.h
>

14 #unde‡
__SYSCALL


15 
	#__SYSCALL
(
ƒ
, 
sym
Ë[ƒ] = sym,

	)

16 #unde‡
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ˇŒ_±r_t
)();

20 
	`sys_ni_sysˇŒ
();

22 c⁄° 
sys_ˇŒ_±r_t
 
sys_ˇŒ_èbÀ
[
__NR_sysˇŒ_max
+1] = {

27 [0 ... 
__NR_sysˇŒ_max
] = &
sys_ni_sysˇŒ
,

28 
	~<asm/uni°d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/•ölock.h
>

30 
	~<löux/°rög.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/dma-m≠pög.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<asm/t˚.h
>

35 
	~<asm/ˇlg¨y.h
>

36 
	~<asm/¥Ÿo.h
>

39 
ölöe
 
	$Êush_t˚
(* 
t˚addr
)

42 i‡(
˝u_has_˛Êush
)

43 
	`˛Êush
(
t˚addr
);

45 
	`wbövd
();

46 
	}
}

48 
	$t˚_buûd
(
iommu_èbÀ
 *
tbl
, 
ödex
,

49 
≈ages
, 
uaddr
, 
dúe˘i⁄
)

51 
u64
* 
ç
;

52 
u64
 
t
;

53 
u64
 
Ωn
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 i‡(
dúe˘i⁄
 !
DMA_TO_DEVICE
)

57 
t
 |(1 << 
TCE_WRITE_SHIFT
);

59 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

61 
≈ages
--) {

62 
Ωn
 = (
	`vút_to_bus
((*)
uaddr
)Ë>> 
PAGE_SHIFT
;

63 
t
 &~
TCE_RPN_MASK
;

64 
t
 |(
Ωn
 << 
TCE_RPN_SHIFT
);

66 *
ç
 = 
	`˝u_to_be64
(
t
);

67 
	`Êush_t˚
(
ç
);

69 
uaddr
 +
PAGE_SIZE
;

70 
ç
++;

72 
	}
}

74 
	$t˚_‰ì
(
iommu_èbÀ
 *
tbl
, 
ödex
, 
≈ages
)

76 
u64
* 
ç
;

78 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

80 
≈ages
--) {

81 *
ç
 = 
	`˝u_to_be64
(0);

82 
	`Êush_t˚
(
ç
);

83 
ç
++;

85 
	}
}

87 
ölöe
 
	$èbÀ_size_to_numbî_of_íåõs
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$t˚_èbÀ_£ç¨ms
(
pci_dev
 *
dev
, 
iommu_èbÀ
 *
tbl
)

99 
bôm≠sz
;

100 
bmµages
;

101 
ªt
;

103 
tbl
->
ô_bu¢o
 = 
dev
->
bus
->
numbî
;

106 
tbl
->
ô_size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

112 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
bôm≠sz
));

114 i‡(!
bmµages
) {

115 
	`¥ötk
(
KERN_ERR
 "Calgary: cannotállocate bitmap\n");

116 
ªt
 = -
ENOMEM
;

117 
d⁄e
;

120 
tbl
->
ô_m≠
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
ô_m≠
, 0, 
bôm≠sz
);

124 
tbl
->
ô_höt
 = 0;

126 
	`•ö_lock_öô
(&
tbl
->
ô_lock
);

130 
d⁄e
:

131  
ªt
;

132 
	}
}

134 
__öô
 
	$buûd_t˚_èbÀ
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

136 
iommu_èbÀ
 *
tbl
;

137 
ªt
;

139 i‡(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`¥ötk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kzÆloc
((
iommu_èbÀ
), 
GFP_KERNEL
);

146 i‡(!
tbl
) {

147 
	`¥ötk
(
KERN_ERR
 "Calgary:Érrorállocating iommu_table\n");

148 
ªt
 = -
ENOMEM
;

149 
d⁄e
;

152 
ªt
 = 
	`t˚_èbÀ_£ç¨ms
(
dev
, 
tbl
);

153 i‡(
ªt
)

154 
‰ì_tbl
;

156 
tbl
->
bb¨
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
‰ì_tbl
:

163 
	`k‰ì
(
tbl
);

164 
d⁄e
:

165  
ªt
;

166 
	}
}

168 * 
__öô
 
	$Æloc_t˚_èbÀ
()

170 
size
;

172 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

173 
size
 *
TCE_ENTRY_SIZE
;

175  
	`__Æloc_boŸmem_low
(
size
, size, 0);

176 
	}
}

178 
__öô
 
	$‰ì_t˚_èbÀ
(*
tbl
)

180 
size
;

182 i‡(!
tbl
)

185 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

186 
size
 *
TCE_ENTRY_SIZE
;

188 
	`‰ì_boŸmem
(
	`__∑
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/s‹t.h
>

14 
	~<löux/¶ab.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_ã°_d©a
;

45 
	$fudze_ex˚±i⁄_èbÀ
(*
m¨kî
, *
√w
)

47 
moduÀ
 *
mod
 = 
THIS_MODULE
;

48 
ex˚±i⁄_èbÀ_íåy
 *
exèbÀ
;

56 i‡(
mod
->
num_exíåõs
 > 1) {

57 
	`¥ötk
(
KERN_ERR
 "test_nx:Åoo manyÉxceptionÅableÉntries!\n");

58 
	`¥ötk
(
KERN_ERR
 "test_nx:ÅestÑesultsáreÇotÑeliable.\n");

61 
exèbÀ
 = (
ex˚±i⁄_èbÀ_íåy
 *)
mod
->extable;

62 
exèbÀ
[0].
ö¢
 = ()
√w
;

63 
	}
}

71 
foo_œbñ
();

80 
noölöe
 
	$ã°_addªss
(*
addªss
)

82 
ªsu…
;

85 
	`fudze_ex˚±i⁄_èbÀ
(&
foo_œbñ
, 
addªss
);

86 
ªsu…
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¶t
] "Ù" (
ªsu…
)

97 : [
Áke_code
] "r" (
addªss
), [
zîo
] "r" (0UL), "0" (
ªsu…
)

100 
	`fudze_ex˚±i⁄_èbÀ
(
addªss
, &
foo_œbñ
);

102 i‡(
ªsu…
)

103  -
ENODEV
;

105 
	}
}

107 
	gã°_d©a
 = 0xC3;

109 
	$ã°_NX
()

111 
ªt
 = 0;

113 
°ackcode
[] = {0xC3, 0x90, 0 };

114 *
hóp
;

116 
ã°_d©a
 = 0xC3;

118 
	`¥ötk
(
KERN_INFO
 "Testing NXÖrotection\n");

121 i‡(
	`ã°_addªss
(&
°ackcode
)) {

122 
	`¥ötk
(
KERN_ERR
 "test_nx: stack wasÉxecutable\n");

123 
ªt
 = -
ENODEV
;

128 
hóp
 = 
	`kmÆloc
(64, 
GFP_KERNEL
);

129 i‡(!
hóp
)

130  -
ENOMEM
;

131 
hóp
[0] = 0xC3;

133 i‡(
	`ã°_addªss
(
hóp
)) {

134 
	`¥ötk
(
KERN_ERR
 "test_nx: heap wasÉxecutable\n");

135 
ªt
 = -
ENODEV
;

137 
	`k‰ì
(
hóp
);

145 #ifde‡
CONFIG_DEBUG_RODATA


147 i‡(
rod©a_ã°_d©a
 != 0xC3) {

148 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
ªt
 = -
ENODEV
;

150 } i‡(
	`ã°_addªss
(&
rod©a_ã°_d©a
)) {

151 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata section isÉxecutable\n");

152 
ªt
 = -
ENODEV
;

158 i‡(
	`ã°_addªss
(&
ã°_d©a
)) {

159 
	`¥ötk
(
KERN_ERR
 "test_nx: .data section isÉxecutable\n");

160 
ªt
 = -
ENODEV
;

165 
	}
}

167 
	$ã°_exô
()

169 
	}
}

171 
moduÀ_öô
(
ã°_NX
);

172 
moduÀ_exô
(
ã°_exô
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forÅhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time_64.c

14 
	~<löux/˛ockchùs.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/öãºu±.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/time.h
>

19 
	~<löux/mˇ.h
>

20 
	~<löux/nmi.h
>

22 
	~<asm/i8253.h
>

23 
	~<asm/h≥t.h
>

24 
	~<asm/vgtod.h
>

25 
	~<asm/time.h
>

26 
	~<asm/timî.h
>

28 vﬁ©ûê
__jiffõs
 
	g__£˘i⁄_jiffõs
 = 
INITIAL_JIFFIES
;

30 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

32 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

37 i‡(!
	`u£r_mode_vm
(
ªgs
Ë&& 
	`ö_lock_fun˘i⁄s
(
pc
)) {

38 #ifde‡
CONFIG_FRAME_POINTER


39  *(*)(
ªgs
->
bp
 + ());

41 *
•
 = (*)
ªgs
->sp;

42 i‡(
•
[0] >> 22)

43  
•
[0];

44 i‡(
•
[1] >> 22)

45  
•
[1];

48  
pc
;

49 
	}
}

50 
EXPORT_SYMBOL
(
¥ofûe_pc
);

52 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

54 
	`öc_úq_°©
(
úq0_úqs
);

56 
globÆ_˛ock_evít
->
	`evít_h™dÀr
(global_clock_event);

58 #ifde‡
CONFIG_MCA


59 i‡(
MCA_bus
) {

60 
u8
 
úq_v
 = 
	`öb_p
(0x61);

61 
	`outb_p
(
úq_v
|0x80, 0x61);

65  
IRQ_HANDLED
;

66 
	}
}

70 
	#TICK_COUNT
 100000000

	)

71 
__öô
 
	$ˇlibøã_˝u
()

73 
tsc_°¨t
, 
tsc_now
;

74 
i
, 
no_˘r_‰ì
;

75 
ev¡£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

76 
Êags
;

78 
i
 = 0; i < 4; i++)

79 i‡(
	`avaû_to_ª§v_≥rf˘r_nmi_bô
(
i
))

81 
no_˘r_‰ì
 = (
i
 == 4);

82 i‡(
no_˘r_‰ì
) {

83 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMDÖerfctrs busy ... "

85 
i
 = 3;

86 
	`rdm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

87 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

88 
	`rdm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

90 
	`ª£rve_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

91 
	`ª£rve_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

93 
	`loˇl_úq_ßve
(
Êags
);

95 
	`wrm§l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

96 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

97 
	`rdts˛
(
tsc_°¨t
);

99 
	`rdm§l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

100 
tsc_now
 = 
	`gë_cy˛es
();

101 } (
tsc_now
 - 
tsc_°¨t
Ë< 
TICK_COUNT
);

103 
	`loˇl_úq_ª°‹e
(
Êags
);

104 i‡(
no_˘r_‰ì
) {

105 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

106 
	`wrm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

107 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

109 
	`ªÀa£_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

110 
	`ªÀa£_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

113  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_°¨t
);

114 
	}
}

116 
úqa˘i⁄
 
	gúq0
 = {

117 .
h™dÀr
 = 
timî_öãºu±
,

118 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_IRQPOLL
 | 
IRQF_NOBALANCING
 | 
IRQF_TIMER
,

119 .
	g«me
 = "timer"

122 
__öô
 
	$h≥t_time_öô
()

124 i‡(!
	`h≥t_íabÀ
())

125 
	`£tup_pô_timî
();

127 
	`£tup_úq
(0, &
úq0
);

128 
	}
}

130 
__öô
 
	$time_öô
()

132 
	`tsc_öô
();

134 
œã_time_öô
 = 
	`choo£_time_öô
();

135 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/u£r.h
>

5 
	~<löux/ªg£t.h
>

7 
	~<asm/uac˚ss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy°em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/¥Ÿo.h
>

13 
	~<asm/sysˇŒs.h
>

15 
	~"és.h
"

20 
	$gë_‰ì_idx
()

22 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 i‡(
	`desc_em±y
(&
t
->
és_¨øy
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_és_desc
(
èsk_°ru˘
 *
p
, 
idx
,

32 c⁄° 
u£r_desc
 *
öfo
, 
n
)

34 
thªad_°ru˘
 *
t
 = &
p
->
thªad
;

35 
desc_°ru˘
 *
desc
 = &
t
->
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
˝u
;

41 
˝u
 = 
	`gë_˝u
();

43 
n
-- > 0) {

44 i‡(
	`LDT_em±y
(
öfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fûl_ldt
(
desc
, 
öfo
);

48 ++
öfo
;

49 ++
desc
;

52 i‡(
t
 =&
cuºít
->
thªad
)

53 
	`lﬂd_TLS
(
t
, 
˝u
);

55 
	`put_˝u
();

56 
	}
}

61 
	$do_£t_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_öfo
,

63 
ˇn_Æloˇã
)

65 
u£r_desc
 
öfo
;

67 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
u_öfo
, (info)))

68  -
EFAULT
;

70 i‡(
idx
 == -1)

71 
idx
 = 
öfo
.
íåy_numbî
;

77 i‡(
idx
 =-1 && 
ˇn_Æloˇã
) {

78 
idx
 = 
	`gë_‰ì_idx
();

79 i‡(
idx
 < 0)

80  
idx
;

81 i‡(
	`put_u£r
(
idx
, &
u_öfo
->
íåy_numbî
))

82  -
EFAULT
;

85 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_és_desc
(
p
, 
idx
, &
öfo
, 1);

91 
	}
}

93 
asmlökage
 
	$sys_£t_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

95 
ªt
 = 
	`do_£t_thªad_¨ó
(
cuºít
, -1, 
u_öfo
, 1);

96 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

97  
ªt
;

98 
	}
}

105 
	$fûl_u£r_desc
(
u£r_desc
 *
öfo
, 
idx
,

106 c⁄° 
desc_°ru˘
 *
desc
)

109 
	`mem£t
(
öfo
, 0, (*info));

110 
öfo
->
íåy_numbî
 = 
idx
;

111 
öfo
->
ba£_addr
 = 
	`gë_desc_ba£
(
desc
);

112 
öfo
->
limô
 = 
	`gë_desc_limô
(
desc
);

113 
öfo
->
£g_32bô
 = 
desc
->
d
;

114 
öfo
->
c⁄ã¡s
 = 
desc
->
ty≥
 >> 2;

115 
öfo
->
ªad_exec_⁄ly
 = !(
desc
->
ty≥
 & 2);

116 
öfo
->
limô_ö_∑ges
 = 
desc
->
g
;

117 
öfo
->
£g_nŸ_¥e£¡
 = !
desc
->
p
;

118 
öfo
->
u£abÀ
 = 
desc
->
avl
;

119 #ifde‡
CONFIG_X86_64


120 
öfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_gë_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_öfo
)

127 
u£r_desc
 
öfo
;

129 i‡(
idx
 =-1 && 
	`gë_u£r
(idx, &
u_öfo
->
íåy_numbî
))

130  -
EFAULT
;

132 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fûl_u£r_desc
(&
öfo
, 
idx
,

136 &
p
->
thªad
.
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 i‡(
	`c›y_to_u£r
(
u_öfo
, &
öfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlökage
 
	$sys_gë_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

145 
ªt
 = 
	`do_gë_thªad_¨ó
(
cuºít
, -1, 
u_öfo
);

146 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

147  
ªt
;

148 
	}
}

150 
	$ªg£t_és_a˘ive
(
èsk_°ru˘
 *
èrgë
,

151 c⁄° 
u£r_ªg£t
 *
ªg£t
)

153 
thªad_°ru˘
 *
t
 = &
èrgë
->
thªad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
és_¨øy
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$ªg£t_és_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

161 
pos
, 
cou¡
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 c⁄° 
desc_°ru˘
 *
és
;

166 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
cou¡
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /(
u£r_desc
);

172 
cou¡
 /(
u£r_desc
);

174 
és
 = &
èrgë
->
thªad
.
és_¨øy
[
pos
];

176 i‡(
kbuf
) {

177 
u£r_desc
 *
öfo
 = 
kbuf
;

178 
cou¡
-- > 0)

179 
	`fûl_u£r_desc
(
öfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
és
++);

182 
u£r_desc
 
__u£r
 *
u_öfo
 = 
ubuf
;

183 
cou¡
-- > 0) {

184 
u£r_desc
 
öfo
;

185 
	`fûl_u£r_desc
(&
öfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
és
++);

186 i‡(
	`__c›y_to_u£r
(
u_öfo
++, &
öfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$ªg£t_és_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
u£r_desc
 
öfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 c⁄° 
u£r_desc
 *
öfo
;

201 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
cou¡
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 i‡(
kbuf
)

207 
öfo
 = 
kbuf
;

208 i‡(
	`__c›y_‰om_u£r
(
öfobuf
, 
ubuf
, 
cou¡
))

209  -
EFAULT
;

211 
öfo
 = 
öfobuf
;

213 
	`£t_és_desc
(
èrgë
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
öfo
, 
cou¡
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<löux/nodemask.h
>

29 
	~<löux/mmz⁄e.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<asm/˝u.h
>

34 
DEFINE_PER_CPU
(
x86_˝u
, 
˝u_devi˚s
);

36 #ifde‡
CONFIG_HOTPLUG_CPU


37 
__ªf
 
	$¨ch_ªgi°î_˝u
(
num
)

48 i‡(
num
)

49 
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
.
hŸ∂uggabÀ
 = 1;

51  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

52 
	}
}

53 
EXPORT_SYMBOL
(
¨ch_ªgi°î_˝u
);

55 
	$¨ch_uƒegi°î_˝u
(
num
)

57 
	`uƒegi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¨ch_uƒegi°î_˝u
);

62 
__öô
 
	$¨ch_ªgi°î_˝u
(
num
)

64  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

65 
	}
}

68 
__öô
 
	$t›ﬁogy_öô
()

70 
i
;

72 #ifde‡
CONFIG_NUMA


73 
	`f‹_óch_⁄löe_node
(
i
)

74 
	`ªgi°î_⁄e_node
(
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
i
)

78 
	`¨ch_ªgi°î_˝u
(
i
);

81 
	}
}

82 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<löux/io.h
>

3 
	~<asm/åampﬁöe.h
>

4 
	~<asm/e820.h
>

7 *
	gåampﬁöe_ba£
 = 
__va
(
TRAMPOLINE_BASE
);

9 
__öô
 
	$ª£rve_åampﬁöe_mem‹y
()

11 #ifde‡
CONFIG_X86_32


17 
	`ª£rve_óæy
(
PAGE_SIZE
, PAGE_SIZE + PAGE_SIZE, "EX TRAMPOLINE");

20 
	`ª£rve_óæy
(
TRAMPOLINE_BASE
, TRAMPOLINE_BASE + 
TRAMPOLINE_SIZE
,

22 
	}
}

29 
	$£tup_åampﬁöe
()

31 
	`mem˝y
(
åampﬁöe_ba£
, 
åampﬁöe_d©a
, 
TRAMPOLINE_SIZE
);

32  
	`vút_to_phys
(
åampﬁöe_ba£
);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<löux/öãºu±.h
>

13 
	~<löux/kÆlsyms.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/k¥obes.h
>

16 
	~<löux/uac˚ss.h
>

17 
	~<löux/ut¢ame.h
>

18 
	~<löux/kdebug.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/±ø˚.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/î∫o.h
>

25 
	~<löux/kexec.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/timî.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/bug.h
>

30 
	~<löux/nmi.h
>

31 
	~<löux/mm.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/io.h
>

35 #ifde‡
CONFIG_EISA


36 
	~<löux/i›‹t.h
>

37 
	~<löux/eiß.h
>

40 #ifde‡
CONFIG_MCA


41 
	~<löux/mˇ.h
>

44 #i‡
deföed
(
CONFIG_EDAC
)

45 
	~<löux/edac.h
>

48 
	~<asm/kmemcheck.h
>

49 
	~<asm/°ackåa˚.h
>

50 
	~<asm/¥o˚ss‹.h
>

51 
	~<asm/debugªg.h
>

52 
	~<asm/©omic.h
>

53 
	~<asm/sy°em.h
>

54 
	~<asm/å≠s.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/i387.h
>

57 
	~<asm/m˚.h
>

59 
	~<asm/mach_å≠s.h
>

61 #ifde‡
CONFIG_X86_64


62 
	~<asm/pgÆloc.h
>

63 
	~<asm/¥Ÿo.h
>

65 
	~<asm/¥o˚ss‹-Êags.h
>

66 
	~<asm/£tup.h
>

67 
	~<asm/å≠s.h
>

69 
asmlökage
 
sy°em_ˇŒ
();

72 
	gign‹e_Âu_úq
;

79 
g©e_desc
 
	gidt_èbÀ
[256]

80 
__©åibuã__
((
__£˘i⁄__
(".data.idt"))) = { { { { 0, 0 } } }, };

83 
DECLARE_BITMAP
(
u£d_ve˘‹s
, 
NR_VECTORS
);

84 
EXPORT_SYMBOL_GPL
(
u£d_ve˘‹s
);

86 
	gign‹e_nmis
;

88 
ölöe
 
	$c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

90 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

91 
	`loˇl_úq_íabÀ
();

92 
	}
}

94 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

96 
	`öc_¥ìm±_cou¡
();

97 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

98 
	`loˇl_úq_íabÀ
();

99 
	}
}

101 
ölöe
 
	$c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

103 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

104 
	`loˇl_úq_dißbÀ
();

105 
	}
}

107 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

109 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

110 
	`loˇl_úq_dißbÀ
();

111 
	`dec_¥ìm±_cou¡
();

112 
	}
}

114 #ifde‡
CONFIG_X86_32


115 
ölöe
 

116 
	$dõ_if_kî√l
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

118 i‡(!
	`u£r_mode_vm
(
ªgs
))

119 
	`dõ
(
°r
, 
ªgs
, 
îr
);

120 
	}
}

123 
__k¥obes


124 
	$do_å≠
(
å≠ƒ
, 
sigƒ
, *
°r
, 
±_ªgs
 *
ªgs
,

125 
îr‹_code
, 
sigöfo_t
 *
öfo
)

127 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

129 #ifde‡
CONFIG_X86_32


130 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

135 i‡(
å≠ƒ
 < 6)

136 
vm86_å≠
;

137 
å≠_sig«l
;

141 i‡(!
	`u£r_mode
(
ªgs
))

142 
kî√l_å≠
;

144 #ifde‡
CONFIG_X86_32


145 
å≠_sig«l
:

156 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

157 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

159 #ifde‡
CONFIG_X86_64


160 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
sigƒ
) &&

161 
	`¥ötk_øãlimô
()) {

162 
	`¥ötk
(
KERN_INFO


164 
tsk
->
comm
,Åsk->
pid
, 
°r
,

165 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

166 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

167 
	`¥ötk
("\n");

171 i‡(
öfo
)

172 
	`f‹˚_sig_öfo
(
sigƒ
, 
öfo
, 
tsk
);

174 
	`f‹˚_sig
(
sigƒ
, 
tsk
);

177 
kî√l_å≠
:

178 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

179 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

180 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

181 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

185 #ifde‡
CONFIG_X86_32


186 
vm86_å≠
:

187 i‡(
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

188 
îr‹_code
, 
å≠ƒ
))

189 
å≠_sig«l
;

192 
	}
}

194 
	#DO_ERROR
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
) \

195 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

197 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

198 =
NOTIFY_STOP
) \

200 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

201 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, 
NULL
); \

202 }

	)

204 
	#DO_ERROR_INFO
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
, 
sicode
, 
süddr
) \

205 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

207 
sigöfo_t
 
öfo
; \

208 
öfo
.
si_signo
 = 
sigƒ
; \

209 
öfo
.
si_î∫o
 = 0; \

210 
öfo
.
si_code
 = 
sicode
; \

211 
öfo
.
si_addr
 = (
__u£r
 *)
süddr
; \

212 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

213 =
NOTIFY_STOP
) \

215 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

216 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, &
öfo
); \

217 }

	)

219 
DO_ERROR_INFO
(0, 
SIGFPE
, "dividêîr‹", 
divide_îr‹
, 
FPE_INTDIV
, 
ªgs
->
ù
)

220 
DO_ERROR
(4, 
SIGSEGV
, "ovîÊow", 
ovîÊow
)

221 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

222 
DO_ERROR_INFO
(6, 
SIGILL
, "övÆid opcode", 
övÆid_›
, 
ILL_ILLOPN
, 
ªgs
->
ù
)

223 
DO_ERROR
(9, 
SIGFPE
, "c›ro˚ss‹ segmíàovîrun", 
c›ro˚ss‹_£gmít_ovîrun
)

224 
DO_ERROR
(10, 
SIGSEGV
, "övÆid TSS", 
övÆid_TSS
)

225 
DO_ERROR
(11, 
SIGBUS
, "£gmíànŸÖª£¡", 
£gmít_nŸ_¥e£¡
)

226 #ifde‡
CONFIG_X86_32


227 
DO_ERROR
(12, 
SIGBUS
, "°ack segmít", 
°ack_£gmít
)

229 
DO_ERROR_INFO
(17, 
SIGBUS
, "Æignmíàcheck", 
Æignmít_check
, 
BUS_ADRALN
, 0)

231 #ifde‡
CONFIG_X86_64


233 
dŸø∂ökage
 
	$do_°ack_£gmít
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

235 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "°ack segmít", 
ªgs
, 
îr‹_code
,

236 12, 
SIGBUS
Ë=
NOTIFY_STOP
)

238 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

239 
	`do_å≠
(12, 
SIGBUS
, "°ack segmít", 
ªgs
, 
îr‹_code
, 
NULL
);

240 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

241 
	}
}

243 
dŸø∂ökage
 
	$do_doubÀ_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

245 c⁄° 
°r
[] = "double fault";

246 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

249 
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 8, 
SIGSEGV
);

251 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

252 
tsk
->
thªad
.
å≠_no
 = 8;

259 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

260 
	}
}

263 
dŸø∂ökage
 
__k¥obes


264 
	$do_gíîÆ_¥Ÿe˘i⁄
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

266 
èsk_°ru˘
 *
tsk
;

268 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

270 #ifde‡
CONFIG_X86_32


271 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

272 
gp_ö_vm86
;

275 
tsk
 = 
cuºít
;

276 i‡(!
	`u£r_mode
(
ªgs
))

277 
gp_ö_kî√l
;

279 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

280 
tsk
->
thªad
.
å≠_no
 = 13;

282 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
) &&

283 
	`¥ötk_øãlimô
()) {

284 
	`¥ötk
(
KERN_INFO


286 
tsk
->
comm
, 
	`èsk_pid_ƒ
(tsk),

287 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

288 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

289 
	`¥ötk
("\n");

292 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

295 #ifde‡
CONFIG_X86_32


296 
gp_ö_vm86
:

297 
	`loˇl_úq_íabÀ
();

298 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
);

302 
gp_ö_kî√l
:

303 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

306 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

307 
tsk
->
thªad
.
å≠_no
 = 13;

308 i‡(
	`nŸify_dõ
(
DIE_GPF
, "gíîÆÖrŸe˘i⁄ fau…", 
ªgs
,

309 
îr‹_code
, 13, 
SIGSEGV
Ë=
NOTIFY_STOP
)

311 
	`dõ
("gíîÆÖrŸe˘i⁄ fau…", 
ªgs
, 
îr‹_code
);

312 
	}
}

314 
nŸø˚
 
__k¥obes
 

315 
	$mem_∑rôy_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

317 
	`¥ötk
(
KERN_EMERG


319 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

321 
	`¥ötk
(
KERN_EMERG


324 #i‡
	`deföed
(
CONFIG_EDAC
)

325 i‡(
	`edac_h™dÀr_£t
()) {

326 
	`edac_©omic_as£π_îr‹
();

331 i‡(
∑nic_⁄_uƒecovîed_nmi
)

332 
	`∑nic
("NMI: Not continuing");

334 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

337 
ªas⁄
 = (reason & 0xf) | 4;

338 
	`outb
(
ªas⁄
, 0x61);

339 
	}
}

341 
nŸø˚
 
__k¥obes
 

342 
	$io_check_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

344 
i
;

346 
	`¥ötk
(
KERN_EMERG
 "NMI: IOCKÉrror (debug interrupt?)\n");

347 
	`show_ªgi°îs
(
ªgs
);

349 i‡(
∑nic_⁄_io_nmi
)

350 
	`∑nic
("NMI IOCKÉrror: Not continuing");

353 
ªas⁄
 = (reason & 0xf) | 8;

354 
	`outb
(
ªas⁄
, 0x61);

356 
i
 = 2000;

357 --
i
)

358 
	`udñay
(1000);

360 
ªas⁄
 &= ~8;

361 
	`outb
(
ªas⁄
, 0x61);

362 
	}
}

364 
nŸø˚
 
__k¥obes
 

365 
	$unknown_nmi_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

367 i‡(
	`nŸify_dõ
(
DIE_NMIUNKNOWN
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
) ==

368 
NOTIFY_STOP
)

370 #ifde‡
CONFIG_MCA


375 i‡(
MCA_bus
) {

376 
	`mˇ_h™dÀ_nmi
();

380 
	`¥ötk
(
KERN_EMERG


382 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

384 
	`¥ötk
(
KERN_EMERG
 "Do you haveá strangeÖower saving modeÉnabled?\n");

385 i‡(
∑nic_⁄_uƒecovîed_nmi
)

386 
	`∑nic
("NMI: Not continuing");

388 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

389 
	}
}

391 
nŸø˚
 
__k¥obes
 
	$deÁu…_do_nmi
(
±_ªgs
 *
ªgs
)

393 
ªas⁄
 = 0;

394 
˝u
;

396 
˝u
 = 
	`smp_¥o˚ss‹_id
();

399 i‡(!
˝u
)

400 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

402 i‡(!(
ªas⁄
 & 0xc0)) {

403 i‡(
	`nŸify_dõ
(
DIE_NMI_IPI
, "nmi_ùi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

404 =
NOTIFY_STOP
)

406 #ifde‡
CONFIG_X86_LOCAL_APIC


411 i‡(
	`nmi_w©chdog_tick
(
ªgs
, 
ªas⁄
))

413 i‡(!
	`do_nmi_ˇŒback
(
ªgs
, 
˝u
))

414 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

416 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

421 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

425 i‡(
ªas⁄
 & 0x80)

426 
	`mem_∑rôy_îr‹
(
ªas⁄
, 
ªgs
);

427 i‡(
ªas⁄
 & 0x40)

428 
	`io_check_îr‹
(
ªas⁄
, 
ªgs
);

429 #ifde‡
CONFIG_X86_32


434 
	`ªas£π_nmi
();

436 
	}
}

438 
dŸø∂ökage
 
nŸø˚
 
__k¥obes
 

439 
	$do_nmi
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

441 
	`nmi_íãr
();

443 
	`öc_úq_°©
(
__nmi_cou¡
);

445 i‡(!
ign‹e_nmis
)

446 
	`deÁu…_do_nmi
(
ªgs
);

448 
	`nmi_exô
();

449 
	}
}

451 
	$°›_nmi
()

453 
	`a˝i_nmi_dißbÀ
();

454 
ign‹e_nmis
++;

455 
	}
}

457 
	$ª°¨t_nmi
()

459 
ign‹e_nmis
--;

460 
	`a˝i_nmi_íabÀ
();

461 
	}
}

464 
dŸø∂ökage
 
__k¥obes
 
	$do_öt3
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

466 #ifde‡
CONFIG_KPROBES


467 i‡(
	`nŸify_dõ
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

468 =
NOTIFY_STOP
)

471 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

472 =
NOTIFY_STOP
)

476 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

477 
	`do_å≠
(3, 
SIGTRAP
, "öt3", 
ªgs
, 
îr‹_code
, 
NULL
);

478 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

479 
	}
}

481 #ifde‡
CONFIG_X86_64


487 
asmlökage
 
__k¥obes
 
±_ªgs
 *
	$sync_ªgs
(
±_ªgs
 *
îegs
)

489 
±_ªgs
 *
ªgs
 = 
îegs
;

491 i‡(
îegs
 =(
±_ªgs
 *Îªgs->
•
)

494 i‡(
	`u£r_mode
(
îegs
))

495 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

500 i‡(
îegs
->
Êags
 & 
X86_EFLAGS_IF
)

501 
ªgs
 = (
±_ªgs
 *)(
îegs
->
•
 -= (pt_regs));

502 i‡(
îegs
 !
ªgs
)

503 *
ªgs
 = *
îegs
;

504  
ªgs
;

505 
	}
}

532 
dŸø∂ökage
 
__k¥obes
 
	$do_debug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

534 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

535 
c⁄dôi⁄
;

536 
si_code
;

538 
	`gë_debugªg
(
c⁄dôi⁄
, 6);

541 i‡(
c⁄dôi⁄
 & 
DR_STEP
 && 
	`kmemcheck_å≠
(
ªgs
))

547 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUGCTLMSR
);

548 
tsk
->
thªad
.
debug˘lm§
 = 0;

550 i‡(
	`nŸify_dõ
(
DIE_DEBUG
, "debug", 
ªgs
, 
c⁄dôi⁄
, 
îr‹_code
,

551 
SIGTRAP
Ë=
NOTIFY_STOP
)

555 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

558 i‡(
c⁄dôi⁄
 & (
DR_TRAP0
|
DR_TRAP1
|
DR_TRAP2
|
DR_TRAP3
)) {

559 i‡(!
tsk
->
thªad
.
debugªg7
)

560 
˛ór_dr7
;

563 #ifde‡
CONFIG_X86_32


564 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

565 
debug_vm86
;

569 
tsk
->
thªad
.
debugªg6
 = 
c⁄dôi⁄
;

575 i‡(
c⁄dôi⁄
 & 
DR_STEP
) {

576 i‡(!
	`u£r_mode
(
ªgs
))

577 
˛ór_TF_ªíabÀ
;

580 
si_code
 = 
	`gë_si_code
(
c⁄dôi⁄
);

582 
	`£nd_sigå≠
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
);

588 
˛ór_dr7
:

589 
	`£t_debugªg
(0, 7);

590 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

593 #ifde‡
CONFIG_X86_32


594 
debug_vm86
:

596 
	`dec_¥ìm±_cou¡
();

597 
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
, 1);

598 
	`c⁄dôi⁄Æ_˛i
(
ªgs
);

602 
˛ór_TF_ªíabÀ
:

603 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_SINGLESTEP
);

604 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

605 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

607 
	}
}

609 #ifde‡
CONFIG_X86_64


610 
	$kî√l_m©h_îr‹
(
±_ªgs
 *
ªgs
, c⁄° *
°r
, 
å≠ƒ
)

612 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

615 
	`nŸify_dõ
(
DIE_GPF
, 
°r
, 
ªgs
, 0, 
å≠ƒ
, 
SIGFPE
);

617 
cuºít
->
thªad
.
å≠_no
 = 
å≠ƒ
;

618 
	`dõ
(
°r
, 
ªgs
, 0);

620 
	}
}

628 
	$m©h_îr‹
(
__u£r
 *
ù
)

630 
èsk_°ru˘
 *
èsk
;

631 
sigöfo_t
 
öfo
;

632 
cwd
, 
swd
, 
îr
;

637 
èsk
 = 
cuºít
;

638 
	`ßve_öô_Âu
(
èsk
);

639 
èsk
->
thªad
.
å≠_no
 = 16;

640 
èsk
->
thªad
.
îr‹_code
 = 0;

641 
öfo
.
si_signo
 = 
SIGFPE
;

642 
öfo
.
si_î∫o
 = 0;

643 
öfo
.
si_addr
 = 
ù
;

654 
cwd
 = 
	`gë_Âu_cwd
(
èsk
);

655 
swd
 = 
	`gë_Âu_swd
(
èsk
);

657 
îr
 = 
swd
 & ~
cwd
;

659 i‡(
îr
 & 0x001) {

665 
öfo
.
si_code
 = 
FPE_FLTINV
;

666 } i‡(
îr
 & 0x004) {

667 
öfo
.
si_code
 = 
FPE_FLTDIV
;

668 } i‡(
îr
 & 0x008) {

669 
öfo
.
si_code
 = 
FPE_FLTOVF
;

670 } i‡(
îr
 & 0x012) {

671 
öfo
.
si_code
 = 
FPE_FLTUND
;

672 } i‡(
îr
 & 0x020) {

673 
öfo
.
si_code
 = 
FPE_FLTRES
;

681 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

682 
	}
}

684 
dŸø∂ökage
 
	$do_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

686 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

688 #ifde‡
CONFIG_X86_32


689 
ign‹e_Âu_úq
 = 1;

691 i‡(!
	`u£r_mode
(
ªgs
) &&

692 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel x87 mathÉrror", 16))

696 
	`m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

697 
	}
}

699 
	$simd_m©h_îr‹
(
__u£r
 *
ù
)

701 
èsk_°ru˘
 *
èsk
;

702 
sigöfo_t
 
öfo
;

703 
mxc§
;

708 
èsk
 = 
cuºít
;

709 
	`ßve_öô_Âu
(
èsk
);

710 
èsk
->
thªad
.
å≠_no
 = 19;

711 
èsk
->
thªad
.
îr‹_code
 = 0;

712 
öfo
.
si_signo
 = 
SIGFPE
;

713 
öfo
.
si_î∫o
 = 0;

714 
öfo
.
si_code
 = 
__SI_FAULT
;

715 
öfo
.
si_addr
 = 
ù
;

722 
mxc§
 = 
	`gë_Âu_mxc§
(
èsk
);

723 ~((
mxc§
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

728 
öfo
.
si_code
 = 
FPE_FLTINV
;

732 
öfo
.
si_code
 = 
FPE_FLTUND
;

735 
öfo
.
si_code
 = 
FPE_FLTDIV
;

738 
öfo
.
si_code
 = 
FPE_FLTOVF
;

741 
öfo
.
si_code
 = 
FPE_FLTRES
;

744 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

745 
	}
}

747 
dŸø∂ökage
 

748 
	$do_simd_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

750 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

752 #ifde‡
CONFIG_X86_32


753 i‡(
˝u_has_xmm
) {

755 
ign‹e_Âu_úq
 = 1;

756 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

763 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

764 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *)
ªgs
, 
îr‹_code
);

767 
cuºít
->
thªad
.
å≠_no
 = 19;

768 
cuºít
->
thªad
.
îr‹_code
 =Érror_code;

769 
	`dõ_if_kî√l
("ˇchêÊush díõd", 
ªgs
, 
îr‹_code
);

770 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

772 i‡(!
	`u£r_mode
(
ªgs
) &&

773 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel simd mathÉrror", 19))

775 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

777 
	}
}

779 
dŸø∂ökage
 

780 
	$do_•urious_öãºu±_bug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

782 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

785 
	`¥ötk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

787 
	}
}

789 #ifde‡
CONFIG_X86_32


790 
	$∑tch_e•fix_desc
(
ue•
, 
ke•
)

792 
desc_°ru˘
 *
gdt
 = 
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

793 
ba£
 = (
ke•
 - 
ue•
Ë& -
THREAD_SIZE
;

794 
√w_ke•
 = 
ke•
 - 
ba£
;

795 
lim_∑ges
 = (
√w_ke•
 | (
THREAD_SIZE
 - 1)Ë>> 
PAGE_SHIFT
;

796 
__u64
 
desc
 = *(__u64 *)&
gdt
[
GDT_ENTRY_ESPFIX_SS
];

799 
desc
 &= 0x00f0ff0000000000ULL;

800 
desc
 |((((
__u64
)
ba£
) << 16) & 0x000000ffffff0000ULL) |

801 ((((
__u64
)
ba£
) << 32) & 0xff00000000000000ULL) |

802 ((((
__u64
)
lim_∑ges
) << 32) & 0x000f000000000000ULL) |

803 (
lim_∑ges
 & 0xffff);

804 *(
__u64
 *)&
gdt
[
GDT_ENTRY_ESPFIX_SS
] = 
desc
;

806  
√w_ke•
;

807 
	}
}

810 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thîmÆ_öãºu±
()

812 
	}
}

814 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thªshﬁd_öãºu±
()

816 
	}
}

828 
asmlökage
 
	$m©h_°©e_ª°‹e
()

830 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

831 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

833 i‡(!
	`tsk_u£d_m©h
(
tsk
)) {

834 
	`loˇl_úq_íabÀ
();

838 i‡(
	`öô_Âu
(
tsk
)) {

842 
	`do_group_exô
(
SIGKILL
);

845 
	`loˇl_úq_dißbÀ
();

848 
	`˛ts
();

852 i‡(
	`u∆ikñy
(
	`ª°‹e_Âu_checkög
(
tsk
))) {

853 
	`°ts
();

854 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

858 
thªad
->
°©us
 |
TS_USEDFPU
;

859 
tsk
->
Âu_cou¡î
++;

860 
	}
}

861 
EXPORT_SYMBOL_GPL
(
m©h_°©e_ª°‹e
);

863 #i‚de‡
CONFIG_MATH_EMULATION


864 
	$m©h_emuœã
(
m©h_emu_öfo
 *
öfo
)

866 
	`¥ötk
(
KERN_EMERG


868 
	`¥ötk
(
KERN_EMERG
 "kûlög %s.\n", 
cuºít
->
comm
);

869 
	`f‹˚_sig
(
SIGFPE
, 
cuºít
);

870 
	`scheduÀ
();

871 
	}
}

874 
dŸø∂ökage
 
__k¥obes


875 
	$do_devi˚_nŸ_avaûabÀ
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

877 #ifde‡
CONFIG_X86_32


878 i‡(
	`ªad_¸0
(Ë& 
X86_CR0_EM
) {

879 
m©h_emu_öfo
 
öfo
 = { };

881 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

883 
öfo
.
ªgs
 =Ñegs;

884 
	`m©h_emuœã
(&
öfo
);

886 
	`m©h_°©e_ª°‹e
();

887 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

890 
	`m©h_°©e_ª°‹e
();

892 
	}
}

894 #ifde‡
CONFIG_X86_32


895 
dŸø∂ökage
 
	$do_úë_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

897 
sigöfo_t
 
öfo
;

898 
	`loˇl_úq_íabÀ
();

900 
öfo
.
si_signo
 = 
SIGILL
;

901 
öfo
.
si_î∫o
 = 0;

902 
öfo
.
si_code
 = 
ILL_BADSTK
;

903 
öfo
.
si_addr
 = 
NULL
;

904 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "iretÉxception",

905 
ªgs
, 
îr‹_code
, 32, 
SIGILL
Ë=
NOTIFY_STOP
)

907 
	`do_å≠
(32, 
SIGILL
, "úëÉx˚±i⁄", 
ªgs
, 
îr‹_code
, &
öfo
);

908 
	}
}

911 
__öô
 
	$å≠_öô
()

913 
i
;

915 #ifde‡
CONFIG_EISA


916 
__iomem
 *
p
 = 
	`óæy_i‹em≠
(0x0FFFD9, 4);

918 i‡(
	`ªadl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

919 
EISA_bus
 = 1;

920 
	`óæy_iounm≠
(
p
, 4);

923 
	`£t_öå_g©e
(0, &
divide_îr‹
);

924 
	`£t_öå_g©e_i°
(1, &
debug
, 
DEBUG_STACK
);

925 
	`£t_öå_g©e_i°
(2, &
nmi
, 
NMI_STACK
);

927 
	`£t_sy°em_öå_g©e_i°
(3, &
öt3
, 
DEBUG_STACK
);

929 
	`£t_sy°em_öå_g©e
(4, &
ovîÊow
);

930 
	`£t_öå_g©e
(5, &
bounds
);

931 
	`£t_öå_g©e
(6, &
övÆid_›
);

932 
	`£t_öå_g©e
(7, &
devi˚_nŸ_avaûabÀ
);

933 #ifde‡
CONFIG_X86_32


934 
	`£t_èsk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

936 
	`£t_öå_g©e_i°
(8, &
doubÀ_Áu…
, 
DOUBLEFAULT_STACK
);

938 
	`£t_öå_g©e
(9, &
c›ro˚ss‹_£gmít_ovîrun
);

939 
	`£t_öå_g©e
(10, &
övÆid_TSS
);

940 
	`£t_öå_g©e
(11, &
£gmít_nŸ_¥e£¡
);

941 
	`£t_öå_g©e_i°
(12, &
°ack_£gmít
, 
STACKFAULT_STACK
);

942 
	`£t_öå_g©e
(13, &
gíîÆ_¥Ÿe˘i⁄
);

943 
	`£t_öå_g©e
(14, &
∑ge_Áu…
);

944 
	`£t_öå_g©e
(15, &
•urious_öãºu±_bug
);

945 
	`£t_öå_g©e
(16, &
c›ro˚ss‹_îr‹
);

946 
	`£t_öå_g©e
(17, &
Æignmít_check
);

947 #ifde‡
CONFIG_X86_MCE


948 
	`£t_öå_g©e_i°
(18, &
machöe_check
, 
MCE_STACK
);

950 
	`£t_öå_g©e
(19, &
simd_c›ro˚ss‹_îr‹
);

953 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

954 
	`£t_bô
(
i
, 
u£d_ve˘‹s
);

956 #ifde‡
CONFIG_IA32_EMULATION


957 
	`£t_sy°em_öå_g©e
(
IA32_SYSCALL_VECTOR
, 
ü32_sysˇŒ
);

958 
	`£t_bô
(
IA32_SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

961 #ifde‡
CONFIG_X86_32


962 i‡(
˝u_has_fx§
) {

963 
	`¥ötk
(
KERN_INFO
 "Enabling fast FPU saveándÑestore... ");

964 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

965 
	`¥ötk
("done.\n");

967 i‡(
˝u_has_xmm
) {

968 
	`¥ötk
(
KERN_INFO


970 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

971 
	`¥ötk
("done.\n");

974 
	`£t_sy°em_å≠_g©e
(
SYSCALL_VECTOR
, &
sy°em_ˇŒ
);

975 
	`£t_bô
(
SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

981 
	`˝u_öô
();

983 #ifde‡
CONFIG_X86_32


984 
	`x86_quúk_å≠_öô
();

986 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/timî.h
>

6 
	~<löux/a˝i_pmtmr.h
>

7 
	~<löux/˝u‰eq.h
>

8 
	~<löux/dmi.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/˛ocksour˚.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/timex.h
>

14 
	~<asm/h≥t.h
>

15 
	~<asm/timî.h
>

16 
	~<asm/vgtod.h
>

17 
	~<asm/time.h
>

18 
	~<asm/dñay.h
>

19 
	~<asm/hy≥rvis‹.h
>

21 
__ªad_mo°ly
 
	g˝u_khz
;

22 
EXPORT_SYMBOL
(
˝u_khz
);

24 
__ªad_mo°ly
 
	gtsc_khz
;

25 
EXPORT_SYMBOL
(
tsc_khz
);

30 
__ªad_mo°ly
 
	gtsc_un°abÀ
;

35 
__ªad_mo°ly
 
	gtsc_dißbÀd
 = -1;

37 
	gtsc_˛ocksour˚_ªlübÀ
;

41 
u64
 
	$«tive_sched_˛ock
()

43 
u64
 
this_off£t
;

53 i‡(
	`u∆ikñy
(
tsc_dißbÀd
)) {

55  (
jiffõs_64
 - 
INITIAL_JIFFIES
Ë* (1000000000 / 
HZ
);

59 
	`rdts˛l
(
this_off£t
);

62  
	`__cy˛es_2_ns
(
this_off£t
);

63 
	}
}

67 #ifde‡
CONFIG_PARAVIRT


68 
	$sched_˛ock
()

70  
	`∑øvút_sched_˛ock
();

71 
	}
}

74 
	$sched_˛ock
(Ë
	`__©åibuã__
((
	`Æüs
("native_sched_clock")));

77 
	$check_tsc_un°abÀ
()

79  
tsc_un°abÀ
;

80 
	}
}

81 
EXPORT_SYMBOL_GPL
(
check_tsc_un°abÀ
);

83 #ifde‡
CONFIG_X86_TSC


84 
__öô
 
	$nŸsc_£tup
(*
°r
)

86 
	`¥ötk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

88 
tsc_dißbÀd
 = 1;

90 
	}
}

96 
__öô
 
	$nŸsc_£tup
(*
°r
)

98 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_TSC
);

100 
	}
}

103 
__£tup
("nŸsc", 
nŸsc_£tup
);

105 
__öô
 
	$tsc_£tup
(*
°r
)

107 i‡(!
	`°rcmp
(
°r
, "reliable"))

108 
tsc_˛ocksour˚_ªlübÀ
 = 1;

110 
	}
}

112 
__£tup
("tsc=", 
tsc_£tup
);

114 
	#MAX_RETRIES
 5

	)

115 
	#SMI_TRESHOLD
 50000

	)

120 
u64
 
	$tsc_ªad_ªfs
(
u64
 *
p
, 
h≥t
)

122 
u64
 
t1
, 
t2
;

123 
i
;

125 
i
 = 0; i < 
MAX_RETRIES
; i++) {

126 
t1
 = 
	`gë_cy˛es
();

127 i‡(
h≥t
)

128 *
p
 = 
	`h≥t_ªadl
(
HPET_COUNTER
) & 0xFFFFFFFF;

130 *
p
 = 
	`a˝i_pm_ªad_óæy
();

131 
t2
 = 
	`gë_cy˛es
();

132 i‡((
t2
 - 
t1
Ë< 
SMI_TRESHOLD
)

133  
t2
;

135  
ULLONG_MAX
;

136 
	}
}

141 
	$ˇlc_h≥t_ªf
(
u64
 
dñètsc
, u64 
h≥t1
, u64 
h≥t2
)

143 
u64
 
tmp
;

145 i‡(
h≥t2
 < 
h≥t1
)

146 
h≥t2
 += 0x100000000ULL;

147 
h≥t2
 -
h≥t1
;

148 
tmp
 = ((
u64
)
h≥t2
 * 
	`h≥t_ªadl
(
HPET_PERIOD
));

149 
	`do_div
(
tmp
, 1000000);

150 
	`do_div
(
dñètsc
, 
tmp
);

152  (Ë
dñètsc
;

153 
	}
}

158 
	$ˇlc_pmtimî_ªf
(
u64
 
dñètsc
, u64 
pm1
, u64 
pm2
)

160 
u64
 
tmp
;

162 i‡(!
pm1
 && !
pm2
)

163  
ULONG_MAX
;

165 i‡(
pm2
 < 
pm1
)

166 
pm2
 +(
u64
)
ACPI_PM_OVRRUN
;

167 
pm2
 -
pm1
;

168 
tmp
 = 
pm2
 * 1000000000LL;

169 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

170 
	`do_div
(
dñètsc
, 
tmp
);

172  (Ë
dñètsc
;

173 
	}
}

175 
	#CAL_MS
 10

	)

176 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

177 
	#CAL_PIT_LOOPS
 1000

	)

179 
	#CAL2_MS
 50

	)

180 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

181 
	#CAL2_PIT_LOOPS
 5000

	)

191 
	$pô_ˇlibøã_tsc
(
u32
 
œtch
, 
ms
, 
lo›mö
)

193 
u64
 
tsc
, 
t1
, 
t2
, 
dñè
;

194 
tscmö
, 
tscmax
;

195 
pô˙t
;

198 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

205 
	`outb
(0xb0, 0x43);

206 
	`outb
(
œtch
 & 0xff, 0x42);

207 
	`outb
(
œtch
 >> 8, 0x42);

209 
tsc
 = 
t1
 = 
t2
 = 
	`gë_cy˛es
();

211 
pô˙t
 = 0;

212 
tscmax
 = 0;

213 
tscmö
 = 
ULONG_MAX
;

214 (
	`öb
(0x61) & 0x20) == 0) {

215 
t2
 = 
	`gë_cy˛es
();

216 
dñè
 = 
t2
 - 
tsc
;

217 
tsc
 = 
t2
;

218 i‡((Ë
dñè
 < 
tscmö
)

219 
tscmö
 = (Ë
dñè
;

220 i‡((Ë
dñè
 > 
tscmax
)

221 
tscmax
 = (Ë
dñè
;

222 
pô˙t
++;

234 i‡(
pô˙t
 < 
lo›mö
 || 
tscmax
 > 10 * 
tscmö
)

235  
ULONG_MAX
;

238 
dñè
 = 
t2
 - 
t1
;

239 
	`do_div
(
dñè
, 
ms
);

240  
dñè
;

241 
	}
}

278 
ölöe
 
	$pô_vîify_msb
(
vÆ
)

281 
	`öb
(0x42);

282  
	`öb
(0x42Ë=
vÆ
;

283 
	}
}

285 
ölöe
 
	$pô_ex≥˘_msb
(
vÆ
, 
u64
 *
ts˝
, *
dñèp
)

287 
cou¡
;

288 
u64
 
tsc
 = 0;

290 
cou¡
 = 0; count < 50000; count++) {

291 i‡(!
	`pô_vîify_msb
(
vÆ
))

293 
tsc
 = 
	`gë_cy˛es
();

295 *
dñèp
 = 
	`gë_cy˛es
(Ë- 
tsc
;

296 *
ts˝
 = 
tsc
;

302  
cou¡
 > 5;

303 
	}
}

311 
	#MAX_QUICK_PIT_MS
 25

	)

312 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

314 
	$quick_pô_ˇlibøã
()

316 
i
;

317 
u64
 
tsc
, 
dñè
;

318 
d1
, 
d2
;

321 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

332 
	`outb
(0xb0, 0x43);

335 
	`outb
(0xff, 0x42);

336 
	`outb
(0xff, 0x42);

344 
	`pô_vîify_msb
(0);

346 i‡(
	`pô_ex≥˘_msb
(0xff, &
tsc
, &
d1
)) {

347 
i
 = 1; i <
MAX_QUICK_PIT_ITERATIONS
; i++) {

348 i‡(!
	`pô_ex≥˘_msb
(0xff-
i
, &
dñè
, &
d2
))

354 
dñè
 -
tsc
;

355 i‡(
d1
+
d2
 >
dñè
 >> 11)

365 i‡(!
	`pô_vîify_msb
(0x„ - 
i
))

367 
suc˚ss
;

370 
	`¥ötk
("Fast TSC calibration failed\n");

373 
suc˚ss
:

389 
dñè
 +()(
d2
 - 
d1
)/2;

390 
dñè
 *
PIT_TICK_RATE
;

391 
	`do_div
(
dñè
, 
i
*256*1000);

392 
	`¥ötk
("Fast TSC calibration using PIT\n");

393  
dñè
;

394 
	}
}

399 
	$«tive_ˇlibøã_tsc
()

401 
u64
 
tsc1
, 
tsc2
, 
dñè
, 
ªf1
, 
ªf2
;

402 
tsc_pô_mö
 = 
ULONG_MAX
, 
tsc_ªf_mö
 = ULONG_MAX;

403 
Êags
, 
œtch
, 
ms
, 
Á°_ˇlibøã
, 
hv_tsc_khz
;

404 
h≥t
 = 
	`is_h≥t_íabÀd
(), 
i
, 
lo›mö
;

406 
hv_tsc_khz
 = 
	`gë_hy≥rvis‹_tsc_‰eq
();

407 i‡(
hv_tsc_khz
) {

408 
	`¥ötk
(
KERN_INFO
 "TSC: FrequencyÑead fromÅhe hypervisor\n");

409  
hv_tsc_khz
;

412 
	`loˇl_úq_ßve
(
Êags
);

413 
Á°_ˇlibøã
 = 
	`quick_pô_ˇlibøã
();

414 
	`loˇl_úq_ª°‹e
(
Êags
);

415 i‡(
Á°_ˇlibøã
)

416  
Á°_ˇlibøã
;

444 
œtch
 = 
CAL_LATCH
;

445 
ms
 = 
CAL_MS
;

446 
lo›mö
 = 
CAL_PIT_LOOPS
;

448 
i
 = 0; i < 3; i++) {

449 
tsc_pô_khz
;

457 
	`loˇl_úq_ßve
(
Êags
);

458 
tsc1
 = 
	`tsc_ªad_ªfs
(&
ªf1
, 
h≥t
);

459 
tsc_pô_khz
 = 
	`pô_ˇlibøã_tsc
(
œtch
, 
ms
, 
lo›mö
);

460 
tsc2
 = 
	`tsc_ªad_ªfs
(&
ªf2
, 
h≥t
);

461 
	`loˇl_úq_ª°‹e
(
Êags
);

464 
tsc_pô_mö
 = 
	`mö
—sc_pô_mö, 
tsc_pô_khz
);

467 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
)

471 i‡(
tsc1
 =
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

474 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

475 i‡(
h≥t
)

476 
tsc2
 = 
	`ˇlc_h≥t_ªf
—sc2, 
ªf1
, 
ªf2
);

478 
tsc2
 = 
	`ˇlc_pmtimî_ªf
—sc2, 
ªf1
, 
ªf2
);

480 
tsc_ªf_mö
 = 
	`mö
—sc_ªf_mö, (Ë
tsc2
);

483 
dñè
 = ((
u64
Ë
tsc_pô_mö
) * 100;

484 
	`do_div
(
dñè
, 
tsc_ªf_mö
);

492 i‡(
dñè
 >= 90 && delta <= 110) {

493 
	`¥ötk
(
KERN_INFO


495 
h≥t
 ? "HPET" : "PMTIMER", 
i
 + 1);

496  
tsc_ªf_mö
;

505 i‡(
i
 =1 && 
tsc_pô_mö
 =
ULONG_MAX
) {

506 
œtch
 = 
CAL2_LATCH
;

507 
ms
 = 
CAL2_MS
;

508 
lo›mö
 = 
CAL2_PIT_LOOPS
;

515 i‡(
tsc_pô_mö
 =
ULONG_MAX
) {

517 
	`¥ötk
(
KERN_WARNING
 "TSC: UnableÅo calibrateágainst PIT\n");

520 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

521 
	`¥ötk
("TSC: NoÑeference (HPET/PMTIMER)ávailable\n");

526 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

527 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

533 
	`¥ötk
(
KERN_INFO
 "TSC: using %sÑeference calibration\n",

534 
h≥t
 ? "HPET" : "PMTIMER");

536  
tsc_ªf_mö
;

540 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

541 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

542  
tsc_pô_mö
;

546 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

547 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

549  
tsc_pô_mö
;

557 
	`¥ötk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

558 
h≥t
 ? "HPET" : "PMTIMER", 
tsc_pô_mö
, 
tsc_ªf_mö
);

559 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

560  
tsc_pô_mö
;

561 
	}
}

563 
	$ªˇlibøã_˝u_khz
()

565 #i‚de‡
CONFIG_SMP


566 
˝u_khz_ﬁd
 = 
˝u_khz
;

568 i‡(
˝u_has_tsc
) {

569 
tsc_khz
 = 
	`ˇlibøã_tsc
();

570 
˝u_khz
 = 
tsc_khz
;

571 
	`˝u_d©a
(0).
lo›s_≥r_jiffy
 =

572 
	`˝u‰eq_sˇÀ
(
	`˝u_d©a
(0).
lo›s_≥r_jiffy
,

573 
˝u_khz_ﬁd
, 
˝u_khz
);

576  -
ENODEV
;

578  -
ENODEV
;

580 
	}
}

582 
EXPORT_SYMBOL
(
ªˇlibøã_˝u_khz
);

607 
DEFINE_PER_CPU
(, 
cyc2ns
);

608 
DEFINE_PER_CPU
(, 
cyc2ns_off£t
);

610 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
)

612 
tsc_now
, 
ns_now
, *
off£t
;

613 
Êags
, *
sˇÀ
;

615 
	`loˇl_úq_ßve
(
Êags
);

616 
	`sched_˛ock_idÀ_¶ìp_evít
();

618 
sˇÀ
 = &
	`≥r_˝u
(
cyc2ns
, 
˝u
);

619 
off£t
 = &
	`≥r_˝u
(
cyc2ns_off£t
, 
˝u
);

621 
	`rdts˛l
(
tsc_now
);

622 
ns_now
 = 
	`__cy˛es_2_ns
(
tsc_now
);

624 i‡(
˝u_khz
) {

625 *
sˇÀ
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

626 *
off£t
 = 
ns_now
 - (
tsc_now
 * *
sˇÀ
 >> 
CYC2NS_SCALE_FACTOR
);

629 
	`sched_˛ock_idÀ_wakeup_evít
(0);

630 
	`loˇl_úq_ª°‹e
(
Êags
);

631 
	}
}

633 #ifde‡
CONFIG_CPU_FREQ


646 
	gªf_‰eq
;

647 
	glo›s_≥r_jiffy_ªf
;

648 
	gtsc_khz_ªf
;

650 
	$time_˝u‰eq_nŸifõr
(
nŸifõr_block
 *
nb
, 
vÆ
,

651 *
d©a
)

653 
˝u‰eq_‰eqs
 *
‰eq
 = 
d©a
;

654 *
Õj
;

656 i‡(
	`˝u_has
(&
	`˝u_d©a
(
‰eq
->
˝u
), 
X86_FEATURE_CONSTANT_TSC
))

659 
Õj
 = &
boŸ_˝u_d©a
.
lo›s_≥r_jiffy
;

660 #ifde‡
CONFIG_SMP


661 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

662 
Õj
 = &
	`˝u_d©a
(
‰eq
->
˝u
).
lo›s_≥r_jiffy
;

665 i‡(!
ªf_‰eq
) {

666 
ªf_‰eq
 = 
‰eq
->
ﬁd
;

667 
lo›s_≥r_jiffy_ªf
 = *
Õj
;

668 
tsc_khz_ªf
 = 
tsc_khz
;

670 i‡((
vÆ
 =
CPUFREQ_PRECHANGE
 && 
‰eq
->
ﬁd
 < fªq->
√w
) ||

671 (
vÆ
 =
CPUFREQ_POSTCHANGE
 && 
‰eq
->
ﬁd
 > fªq->
√w
) ||

672 (
vÆ
 =
CPUFREQ_RESUMECHANGE
)) {

673 *
Õj
 = 
	`˝u‰eq_sˇÀ
(
lo›s_≥r_jiffy_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

675 
tsc_khz
 = 
	`˝u‰eq_sˇÀ
(
tsc_khz_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

676 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

677 
	`m¨k_tsc_un°abÀ
("cpufreq changes");

680 
	`£t_cyc2ns_sˇÀ
(
tsc_khz
, 
‰eq
->
˝u
);

683 
	}
}

685 
nŸifõr_block
 
	gtime_˝u‰eq_nŸifõr_block
 = {

686 .
nŸifõr_ˇŒ
 = 
time_˝u‰eq_nŸifõr


689 
__öô
 
	$˝u‰eq_tsc
()

691 i‡(!
˝u_has_tsc
)

693 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

695 
	`˝u‰eq_ªgi°î_nŸifõr
(&
time_˝u‰eq_nŸifõr_block
,

696 
CPUFREQ_TRANSITION_NOTIFIER
);

698 
	}
}

700 
c‹e_öôˇŒ
(
˝u‰eq_tsc
);

706 
˛ocksour˚
 
	g˛ocksour˚_tsc
;

720 
cy˛e_t
 
	$ªad_tsc
(
˛ocksour˚
 *
cs
)

722 
cy˛e_t
 
ªt
 = (cy˛e_t)
	`gë_cy˛es
();

724  
ªt
 >
˛ocksour˚_tsc
.
cy˛e_œ°
 ?

725 
ªt
 : 
˛ocksour˚_tsc
.
cy˛e_œ°
;

726 
	}
}

728 #ifde‡
CONFIG_X86_64


729 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_tsc
()

731 
cy˛e_t
 
ªt
;

738 
	`rdtsc_b¨rõr
();

739 
ªt
 = (
cy˛e_t
)
	`vgë_cy˛es
();

740 
	`rdtsc_b¨rõr
();

742  
ªt
 >
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 ?

743 
ªt
 : 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

744 
	}
}

747 
˛ocksour˚
 
	g˛ocksour˚_tsc
 = {

748 .
«me
 = "tsc",

749 .
	gøtög
 = 300,

750 .
	gªad
 = 
ªad_tsc
,

751 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

752 .
	gshi·
 = 22,

753 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

754 
CLOCK_SOURCE_MUST_VERIFY
,

755 #ifde‡
CONFIG_X86_64


756 .
	gvªad
 = 
vªad_tsc
,

760 
	$m¨k_tsc_un°abÀ
(*
ªas⁄
)

762 i‡(!
tsc_un°abÀ
) {

763 
tsc_un°abÀ
 = 1;

764 
	`¥ötk
("M¨kög TSC un°abÀ duêtÿ%s\n", 
ªas⁄
);

766 i‡(
˛ocksour˚_tsc
.
mu…
)

767 
	`˛ocksour˚_ch™ge_øtög
(&
˛ocksour˚_tsc
, 0);

769 
˛ocksour˚_tsc
.
øtög
 = 0;

771 
	}
}

773 
EXPORT_SYMBOL_GPL
(
m¨k_tsc_un°abÀ
);

775 
__öô
 
	$dmi_m¨k_tsc_un°abÀ
(c⁄° 
dmi_sy°em_id
 *
d
)

777 
	`¥ötk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

778 
d
->
idít
);

779 
tsc_un°abÀ
 = 1;

781 
	}
}

784 
dmi_sy°em_id
 
__öôd©a
 
	gbad_tsc_dmi_èbÀ
[] = {

786 .
ˇŒback
 = 
dmi_m¨k_tsc_un°abÀ
,

787 .
	gidít
 = "IBM Thinkpad 380XD",

788 .
	gm©ches
 = {

789 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

790 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

796 
__öô
 
	$check_sy°em_tsc_ªlübÀ
()

798 #ifde‡
CONFIG_MGEODE_LX


800 
	#RTSC_SUSP
 0x100

	)

801 
ªs_low
, 
ªs_high
;

803 
	`rdm§_ß„
(
MSR_GEODE_BUSCONT_CONF0
, &
ªs_low
, &
ªs_high
);

805 i‡(
ªs_low
 & 
RTSC_SUSP
)

806 
tsc_˛ocksour˚_ªlübÀ
 = 1;

808 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

809 
tsc_˛ocksour˚_ªlübÀ
 = 1;

810 
	}
}

816 
__˝uöô
 
	$unsynchr⁄ized_tsc
()

818 i‡(!
˝u_has_tsc
 || 
tsc_un°abÀ
)

821 #ifde‡
CONFIG_SMP


822 i‡(
	`≠ic_is_˛u°îed_box
())

826 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

832 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
) {

834 i‡(
	`num_possibÀ_˝us
() > 1)

835 
tsc_un°abÀ
 = 1;

838  
tsc_un°abÀ
;

839 
	}
}

841 
__öô
 
	$öô_tsc_˛ocksour˚
()

843 
˛ocksour˚_tsc
.
mu…
 = 
	`˛ocksour˚_khz2mu…
(
tsc_khz
,

844 
˛ocksour˚_tsc
.
shi·
);

845 i‡(
tsc_˛ocksour˚_ªlübÀ
)

846 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_MUST_VERIFY
;

848 i‡(
	`check_tsc_un°abÀ
()) {

849 
˛ocksour˚_tsc
.
øtög
 = 0;

850 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_IS_CONTINUOUS
;

852 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_tsc
);

853 
	}
}

855 
__öô
 
	$tsc_öô
()

857 
u64
 
Õj
;

858 
˝u
;

860 i‡(!
˝u_has_tsc
)

863 
tsc_khz
 = 
	`ˇlibøã_tsc
();

864 
˝u_khz
 = 
tsc_khz
;

866 i‡(!
tsc_khz
) {

867 
	`m¨k_tsc_un°abÀ
("couldÇot calculate TSC khz");

871 #ifde‡
CONFIG_X86_64


872 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

873 (
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
))

874 
˝u_khz
 = 
	`ˇlibøã_˝u
();

877 
	`¥ötk
("Detected %lu.%03lu MHzÖrocessor.\n",

878 ()
˝u_khz
 / 1000,

879 ()
˝u_khz
 % 1000);

887 
	`f‹_óch_possibÀ_˝u
(
˝u
)

888 
	`£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
);

890 i‡(
tsc_dißbÀd
 > 0)

894 
tsc_dißbÀd
 = 0;

896 
Õj
 = ((
u64
)
tsc_khz
 * 1000);

897 
	`do_div
(
Õj
, 
HZ
);

898 
Õj_föe
 = 
Õj
;

900 
	`u£_tsc_dñay
();

902 
	`dmi_check_sy°em
(
bad_tsc_dmi_èbÀ
);

904 i‡(
	`unsynchr⁄ized_tsc
())

905 
	`m¨k_tsc_un°abÀ
("TSCs unsynchronized");

907 
	`check_sy°em_tsc_ªlübÀ
();

908 
	`öô_tsc_˛ocksour˚
();

909 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<löux/•ölock.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__˝uöôd©a
 
©omic_t
 
	g°¨t_cou¡
;

29 
__˝uöôd©a
 
©omic_t
 
	g°›_cou¡
;

36 
__˝uöôd©a
 
øw_•ölock_t
 
	gsync_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

38 
__˝uöôd©a
 
cy˛es_t
 
	gœ°_tsc
;

39 
__˝uöôd©a
 
cy˛es_t
 
	gmax_w¨p
;

40 
__˝uöôd©a
 
	gƒ_w¨ps
;

45 
__˝uöô
 
	$check_tsc_w¨p
()

47 
cy˛es_t
 
°¨t
, 
now
, 
¥ev
, 
íd
;

48 
i
;

50 
	`rdtsc_b¨rõr
();

51 
°¨t
 = 
	`gë_cy˛es
();

52 
	`rdtsc_b¨rõr
();

56 
íd
 = 
°¨t
 + 
tsc_khz
 * 20ULL;

57 
now
 = 
°¨t
;

59 
i
 = 0; ; i++) {

65 
	`__øw_•ö_lock
(&
sync_lock
);

66 
¥ev
 = 
œ°_tsc
;

67 
	`rdtsc_b¨rõr
();

68 
now
 = 
	`gë_cy˛es
();

69 
	`rdtsc_b¨rõr
();

70 
œ°_tsc
 = 
now
;

71 
	`__øw_•ö_u∆ock
(&
sync_lock
);

79 i‡(
	`u∆ikñy
(!(
i
 & 7))) {

80 i‡(
now
 > 
íd
 || 
i
 > 10000000)

82 
	`˝u_ªœx
();

83 
	`touch_nmi_w©chdog
();

89 i‡(
	`u∆ikñy
(
¥ev
 > 
now
)) {

90 
	`__øw_•ö_lock
(&
sync_lock
);

91 
max_w¨p
 = 
	`max
(max_w¨p, 
¥ev
 - 
now
);

92 
ƒ_w¨ps
++;

93 
	`__øw_•ö_u∆ock
(&
sync_lock
);

96 
	`WARN
(!(
now
-
°¨t
),

98 
now
-
°¨t
, 
íd
-start);

99 
	}
}

105 
__˝uöô
 
	$check_tsc_sync_sour˚
(
˝u
)

107 
˝us
 = 2;

113 i‡(
	`unsynchr⁄ized_tsc
())

116 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
)) {

117 
	`¥_öfo
("Skipping synchronization checksás TSC isÑeliable.\n");

121 
	`¥_öfo
("checking TSC synchronization [CPU#%d -> CPU#%d]:",

122 
	`smp_¥o˚ss‹_id
(), 
˝u
);

127 
	`©omic_£t
(&
°›_cou¡
, 0);

132 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
-1)

133 
	`˝u_ªœx
();

137 
	`©omic_öc
(&
°¨t_cou¡
);

139 
	`check_tsc_w¨p
();

141 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
-1)

142 
	`˝u_ªœx
();

144 i‡(
ƒ_w¨ps
) {

145 
	`¥ötk
("\n");

146 
	`¥_w¨nög
("Measured %Ld cycles TSC warp between CPUs, "

147 "tu∫ög of‡TSC clock.\n", 
max_w¨p
);

148 
	`m¨k_tsc_un°abÀ
("check_tsc_sync_source failed");

150 
	`¥ötk
("Öassed.\n");

156 
	`©omic_£t
(&
°¨t_cou¡
, 0);

157 
ƒ_w¨ps
 = 0;

158 
max_w¨p
 = 0;

159 
œ°_tsc
 = 0;

164 
	`©omic_öc
(&
°›_cou¡
);

165 
	}
}

170 
__˝uöô
 
	$check_tsc_sync_èrgë
()

172 
˝us
 = 2;

174 i‡(
	`unsynchr⁄ized_tsc
(Ë|| 
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

181 
	`©omic_öc
(&
°¨t_cou¡
);

182 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
)

183 
	`˝u_ªœx
();

185 
	`check_tsc_w¨p
();

190 
	`©omic_öc
(&
°›_cou¡
);

195 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
)

196 
	`˝u_ªœx
();

197 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<löux/öô.h
>

16 
	~<löux/pci_ids.h
>

17 
	~<löux/pci_ªgs.h
>

19 
	~<asm/≠ic.h
>

20 
	~<asm/pci-dúe˘.h
>

21 
	~<asm/io.h
>

22 
	~<asm/∑øvút.h
>

23 
	~<asm/£tup.h
>

25 #i‡
deföed
 
CONFIG_PCI
 && deföed 
CONFIG_PARAVIRT


32 
	$vsmp_ßve_Ê
()

34 
Êags
 = 
	`«tive_ßve_Ê
();

36 i‡(!(
Êags
 & 
X86_EFLAGS_IF
Ë|| (Êag†& 
X86_EFLAGS_AC
))

37 
Êags
 &~
X86_EFLAGS_IF
;

38  
Êags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ßve_Ê
);

42 
	$vsmp_ª°‹e_Ê
(
Êags
)

44 i‡(
Êags
 & 
X86_EFLAGS_IF
)

45 
Êags
 &~
X86_EFLAGS_AC
;

47 
Êags
 |
X86_EFLAGS_AC
;

48 
	`«tive_ª°‹e_Ê
(
Êags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ª°‹e_Ê
);

52 
	$vsmp_úq_dißbÀ
()

54 
Êags
 = 
	`«tive_ßve_Ê
();

56 
	`«tive_ª°‹e_Ê
((
Êags
 & ~
X86_EFLAGS_IF
Ë| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_dißbÀ
);

60 
	$vsmp_úq_íabÀ
()

62 
Êags
 = 
	`«tive_ßve_Ê
();

64 
	`«tive_ª°‹e_Ê
((
Êags
 | 
X86_EFLAGS_IF
Ë& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_íabÀ
);

68 
__öô_‹_moduÀ
 
	$vsmp_∑tch
(
u8
 
ty≥
, 
u16
 
˛obbîs
, *
ibuf
,

69 
addr
, 
Àn
)

71 
ty≥
) {

72 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_íabÀ
):

73 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_dißbÀ
):

74 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ßve_Ê
):

75 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ª°‹e_Ê
):

76  
	`∑øvút_∑tch_deÁu…
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

78  
	`«tive_∑tch
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

81 
	}
}

83 
__öô
 
	$£t_vsmp_pv_›s
()

85 
__iomem
 *
addªss
;

86 
ˇp
, 
˘l
, 
cfg
;

89 
cfg
 = 
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
addªss
 = 
	`óæy_i‹em≠
(
cfg
, 8);

91 
ˇp
 = 
	`ªadl
(
addªss
);

92 
˘l
 = 
	`ªadl
(
addªss
 + 4);

93 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ˇp
, 
˘l
);

95 i‡(
ˇp
 & 
˘l
 & (1 << 4)) {

97 
pv_úq_›s
.
úq_dißbÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_dißbÀ
);

98 
pv_úq_›s
.
úq_íabÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_íabÀ
);

99 
pv_úq_›s
.
ßve_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ßve_Ê
);

100 
pv_úq_›s
.
ª°‹e_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ª°‹e_Ê
);

101 
pv_öô_›s
.
∑tch
 = 
vsmp_∑tch
;

103 
˘l
 &= ~(1 << 4);

104 
	`wrôñ
(
˘l
, 
addªss
 + 4);

105 
˘l
 = 
	`ªadl
(
addªss
 + 4);

106 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: c⁄åﬁ sëÅo:0x%08x\n", 
˘l
);

109 
	`óæy_iounm≠
(
addªss
, 8);

110 
	}
}

112 
__öô
 
	$£t_vsmp_pv_›s
()

114 
	}
}

117 #ifde‡
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__öô
 
	$dëe˘_vsmp_box
()

122 
is_vsmp
 = 0;

124 i‡(!
	`óæy_pci_Ælowed
())

128 i‡(
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 i‡(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__öô
 
	$dëe˘_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__öô
 
	$vsmp_öô
()

154 
	`dëe˘_vsmp_box
();

155 i‡(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_›s
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<löux/time.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/jiffõs.h
>

29 
	~<löux/sys˘l.h
>

30 
	~<löux/˛ocksour˚.h
>

31 
	~<löux/gë˝u.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/smp.h
>

34 
	~<löux/nŸifõr.h
>

36 
	~<asm/vsysˇŒ.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/uni°d.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/î∫o.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gmít.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/t›ﬁogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysˇŒ
(
ƒ
) \

49 
	`__©åibuã__
 ((
unu£d
, 
	`__£˘i⁄__
(".vsysˇŒ_" #ƒ))Ë
nŸø˚


	)

50 
	#__sysˇŒ_˛obbî
 "r11","cx","mem‹y"

	)

58 
__vgë˝u_mode
 
	g__£˘i⁄_vgë˝u_mode
;

60 
vsysˇŒ_gtod_d©a
 
__vsysˇŒ_gtod_d©a
 
	g__£˘i⁄_vsysˇŒ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsys˘l_íabÀd
 = 1,

66 
	$upd©e_vsysˇŒ_tz
()

68 
Êags
;

70 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

72 
vsysˇŒ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

74 
	}
}

76 
	$upd©e_vsysˇŒ
(
time•ec
 *
wÆl_time
, 
˛ocksour˚
 *
˛ock
)

78 
Êags
;

80 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

82 
vsysˇŒ_gtod_d©a
.
˛ock
.
vªad
 = clock->vread;

83 
vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 = clock->cycle_last;

84 
vsysˇŒ_gtod_d©a
.
˛ock
.
mask
 = clock->mask;

85 
vsysˇŒ_gtod_d©a
.
˛ock
.
mu…
 = clock->mult;

86 
vsysˇŒ_gtod_d©a
.
˛ock
.
shi·
 = clock->shift;

87 
vsysˇŒ_gtod_d©a
.
wÆl_time_£c
 = 
wÆl_time
->
tv_£c
;

88 
vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
 = 
wÆl_time
->
tv_n£c
;

89 
vsysˇŒ_gtod_d©a
.
wÆl_to_m⁄Ÿ⁄ic
 = wall_to_monotonic;

90 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

91 
	}
}

96 
__Æways_ölöe
 
	$do_gë_tz
(
timez⁄e
 * 
tz
)

98 *
tz
 = 
__vsysˇŒ_gtod_d©a
.
sys_tz
;

99 
	}
}

101 
__Æways_ölöe
 
	$gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

103 
ªt
;

104 
asm
 volatile("syscall"

105 : "˜" (
ªt
)

106 : "0" (
__NR_gëtimeofday
),"D" (
tv
),"S" (
tz
)

107 : 
__sysˇŒ_˛obbî
 );

108  
ªt
;

109 
	}
}

111 
__Æways_ölöe
 
	$time_sysˇŒ
(*
t
)

113 
£cs
;

114 
asm
 volatile("syscall"

115 : "˜" (
£cs
)

116 : "0" (
__NR_time
),"D" (
t
Ë: 
__sysˇŒ_˛obbî
);

117  
£cs
;

118 
	}
}

120 
__Æways_ölöe
 
	$do_vgëtimeofday
(
timevÆ
 * 
tv
)

122 
cy˛e_t
 
now
, 
ba£
, 
mask
, 
cy˛e_dñè
;

123 
£q
;

124 
mu…
, 
shi·
, 
n£c
;

125 
	`cy˛e_t
 (*
vªad
)();

127 
£q
 = 
	`ªad_£qbegö
(&
__vsysˇŒ_gtod_d©a
.
lock
);

129 
vªad
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.vread;

130 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
 || !
vªad
)) {

131 
	`gëtimeofday
(
tv
,
NULL
);

135 
now
 = 
	`vªad
();

136 
ba£
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

137 
mask
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mask;

138 
mu…
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mult;

139 
shi·
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.shift;

141 
tv
->
tv_£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_£c
;

142 
n£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
;

143 } 
	`ªad_£qªåy
(&
__vsysˇŒ_gtod_d©a
.
lock
, 
£q
));

146 
cy˛e_dñè
 = (
now
 - 
ba£
Ë& 
mask
;

148 
n£c
 +(
cy˛e_dñè
 * 
mu…
Ë>> 
shi·
;

150 
n£c
 >
NSEC_PER_SEC
) {

151 
tv
->
tv_£c
 += 1;

152 
n£c
 -
NSEC_PER_SEC
;

154 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

155 
	}
}

157 
	$__vsysˇŒ
(0Ë
	$vgëtimeofday
(
timevÆ
 * 
tv
, 
timez⁄e
 * 
tz
)

159 i‡(
tv
)

160 
	`do_vgëtimeofday
(
tv
);

161 i‡(
tz
)

162 
	`do_gë_tz
(
tz
);

164 
	}
}

168 
time_t
 
	$__vsysˇŒ
(1Ë
	$vtime
(
time_t
 *
t
)

170 
timevÆ
 
tv
;

171 
time_t
 
ªsu…
;

172 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
))

173  
	`time_sysˇŒ
(
t
);

175 
	`vgëtimeofday
(&
tv
, 
NULL
);

176 
ªsu…
 = 
tv
.
tv_£c
;

177 i‡(
t
)

178 *
t
 = 
ªsu…
;

179  
ªsu…
;

180 
	}
}

190 
	$__vsysˇŒ
(2)

191 
	$vgë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

193 
p
;

194 
j
 = 0;

204 i‡(
tˇche
 &&Åˇche->
blob
[0] =(
j
 = 
__jiffõs
)) {

205 
p
 = 
tˇche
->
blob
[1];

206 } i‡(
__vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

208 
	`«tive_ªad_ts˝
(&
p
);

211 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

213 i‡(
tˇche
) {

214 
tˇche
->
blob
[0] = 
j
;

215 
tˇche
->
blob
[1] = 
p
;

217 i‡(
˝u
)

218 *
˝u
 = 
p
 & 0xfff;

219 i‡(
node
)

220 *
node
 = 
p
 >> 12;

222 
	}
}

224 
	$__vsysˇŒ
(3Ë
	$víosys_1
()

226  -
ENOSYS
;

227 
	}
}

229 #ifde‡
CONFIG_SYSCTL


232 
	$vsysˇŒ_sys˘l_ch™ge
(
˘l_èbÀ
 *
˘l
, 
wrôe
, 
fûe
 * 
fûp
,

233 
__u£r
 *
buf„r
, 
size_t
 *
À≈
, 
loff_t
 *
µos
)

235  
	`¥oc_doötvec
(
˘l
, 
wrôe
, 
fûp
, 
buf„r
, 
À≈
, 
µos
);

236 
	}
}

238 
˘l_èbÀ
 
	gkî√l_èbÀ2
[] = {

239 { .
¥o˙ame
 = "vsyscall64",

240 .
	gd©a
 = &
vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
, .
	gmaxÀn
 = (),

241 .
	gmode
 = 0644,

242 .
	g¥oc_h™dÀr
 = 
vsysˇŒ_sys˘l_ch™ge
 },

246 
˘l_èbÀ
 
	gkî√l_roŸ_èbÀ2
[] = {

247 { .
˘l_«me
 = 
CTL_KERN
, .
	g¥o˙ame
 = "kî√l", .
	gmode
 = 0555,

248 .
	gchûd
 = 
kî√l_èbÀ2
 },

255 
__˝uöô
 
	$vsysˇŒ_£t_˝u
(
˝u
)

257 
d
;

258 
node
 = 0;

259 #ifde‡
CONFIG_NUMA


260 
node
 = 
	`˝u_to_node
(
˝u
);

262 i‡(
	`˝u_has
(&
	`˝u_d©a
(
˝u
), 
X86_FEATURE_RDTSCP
))

263 
	`wrôe_rdts˝_aux
((
node
 << 12Ë| 
˝u
);

268 
d
 = 0x0f40000000000ULL;

269 
d
 |
˝u
;

270 
d
 |(
node
 & 0xf) << 12;

271 
d
 |(
node
 >> 4) << 48;

272 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

273 
	}
}

275 
__˝uöô
 
	$˝u_vsysˇŒ_öô
(*
¨g
)

278 
	`vsysˇŒ_£t_˝u
(
	`øw_smp_¥o˚ss‹_id
());

279 
	}
}

281 
__˝uöô


282 
	$˝u_vsysˇŒ_nŸifõr
(
nŸifõr_block
 *
n
, 
a˘i⁄
, *
¨g
)

284 
˝u
 = ()
¨g
;

285 i‡(
a˘i⁄
 =
CPU_ONLINE
 ||á˘i⁄ =
CPU_ONLINE_FROZEN
)

286 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝u_vsysˇŒ_öô
, 
NULL
, 1);

287  
NOTIFY_DONE
;

288 
	}
}

290 
__öô
 
	$m≠_vsysˇŒ
()

292 
__vsysˇŒ_0
;

293 
phyßddr_∑ge0
 = 
	`__∑_symbﬁ
(&
__vsysˇŒ_0
);

296 
	`__£t_fixm≠
(
VSYSCALL_FIRST_PAGE
, 
phyßddr_∑ge0
, 
PAGE_KERNEL_VSYSCALL
);

297 
	}
}

299 
__öô
 
	$vsysˇŒ_öô
()

301 
	`BUG_ON
(((Ë&
vgëtimeofday
 !=

302 
	`VSYSCALL_ADDR
(
__NR_vgëtimeofday
)));

303 
	`BUG_ON
((Ë&
vtime
 !
	`VSYSCALL_ADDR
(
__NR_vtime
));

304 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0Ë!
	`__fix_to_vút
(
VSYSCALL_FIRST_PAGE
)));

305 
	`BUG_ON
((Ë&
vgë˝u
 !
	`VSYSCALL_ADDR
(
__NR_vgë˝u
));

306 #ifde‡
CONFIG_SYSCTL


307 
	`ªgi°î_sys˘l_èbÀ
(
kî√l_roŸ_èbÀ2
);

309 
	`⁄_óch_˝u
(
˝u_vsysˇŒ_öô
, 
NULL
, 1);

310 
	`hŸ˝u_nŸifõr
(
˝u_vsysˇŒ_nŸifõr
, 0);

312 
	}
}

314 
__öôˇŒ
(
vsysˇŒ_öô
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/smp.h
>

7 
	~<√t/checksum.h
>

9 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/uac˚ss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/·ø˚.h
>

15 #ifde‡
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcou¡
);

20 
EXPORT_SYMBOL
(
kî√l_thªad
);

22 
EXPORT_SYMBOL
(
__gë_u£r_1
);

23 
EXPORT_SYMBOL
(
__gë_u£r_2
);

24 
EXPORT_SYMBOL
(
__gë_u£r_4
);

25 
EXPORT_SYMBOL
(
__gë_u£r_8
);

26 
EXPORT_SYMBOL
(
__put_u£r_1
);

27 
EXPORT_SYMBOL
(
__put_u£r_2
);

28 
EXPORT_SYMBOL
(
__put_u£r_4
);

29 
EXPORT_SYMBOL
(
__put_u£r_8
);

31 
EXPORT_SYMBOL
(
c›y_u£r_gíîic
);

32 
EXPORT_SYMBOL
(
__c›y_u£r_noˇche
);

33 
EXPORT_SYMBOL
(
c›y_‰om_u£r
);

34 
EXPORT_SYMBOL
(
c›y_to_u£r
);

35 
EXPORT_SYMBOL
(
__c›y_‰om_u£r_ö©omic
);

37 
EXPORT_SYMBOL
(
c›y_∑ge
);

38 
EXPORT_SYMBOL
(
˛ór_∑ge
);

40 
EXPORT_SYMBOL
(
csum_∑πül
);

46 #unde‡
mem˝y


47 #unde‡
mem£t


48 #unde‡
memmove


50 *
mem£t
(*, , 
__kî√l_size_t
);

51 *
mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

52 *
__mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

54 
EXPORT_SYMBOL
(
mem£t
);

55 
EXPORT_SYMBOL
(
mem˝y
);

56 
EXPORT_SYMBOL
(
__mem˝y
);

58 
EXPORT_SYMBOL
(
em±y_zîo_∑ge
);

59 
EXPORT_SYMBOL
(
öô_Àvñ4_pgt
);

60 
EXPORT_SYMBOL
(
lﬂd_gs_ödex
);

	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<löux/boŸmem.h
>

7 
	~<löux/com∑t.h
>

8 
	~<asm/i387.h
>

9 #ifde‡
CONFIG_IA32_EMULATION


10 
	~<asm/sigc⁄ãxt32.h
>

12 
	~<asm/x¸.h
>

17 
u64
 
	gp˙txt_mask
;

19 
_Âx_sw_byãs
 
	gfx_sw_ª£rved
;

20 #ifde‡
CONFIG_IA32_EMULATION


21 
_Âx_sw_byãs
 
	gfx_sw_ª£rved_ü32
;

28 
	$check_f‹_x°©e
(
i387_fxßve_°ru˘
 
__u£r
 *
buf
,

29 
__u£r
 *
Â°©e
,

30 
_Âx_sw_byãs
 *
fx_sw_u£r
)

32 
mö_x°©e_size
 = (
i387_fxßve_°ru˘
) +

33 (
xßve_hdr_°ru˘
);

34 
magic2
;

35 
îr
;

37 
îr
 = 
	`__c›y_‰om_u£r
(
fx_sw_u£r
, &
buf
->
sw_ª£rved
[0],

38 (
_Âx_sw_byãs
));

40 i‡(
îr
)

41  
îr
;

46 i‡(
fx_sw_u£r
->
magic1
 !
FP_XSTATE_MAGIC1
)

52 i‡(
fx_sw_u£r
->
x°©e_size
 < 
mö_x°©e_size
 ||

53 
fx_sw_u£r
->
x°©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x°©e_size
 > fx_sw_u£r->
exãnded_size
)

57 
îr
 = 
	`__gë_u£r
(
magic2
, (
__u32
 *Ë(((*)
Â°©e
) +

58 
fx_sw_u£r
->
exãnded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 i‡(
îr
 || 
magic2
 !
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifde‡
CONFIG_X86_64


77 
	$ßve_i387_x°©e
(
__u£r
 *
buf
)

79 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

80 
îr
 = 0;

82 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x°©e_size
 < 
x°©e_size
);

87 i‡(()
buf
 % 64)

88 
	`¥ötk
("ßve_i387_x°©e: bad fp°©ê%p\n", 
buf
);

90 i‡(!
	`u£d_m©h
())

93 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_USEDFPU
) {

98 
îr
 = 
	`__˛ór_u£r
(
buf
, 
sig_x°©e_size
);

99 i‡(
îr
)

100  
îr
;

102 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

103 
îr
 = 
	`xßve_u£r
(
buf
);

105 
îr
 = 
	`fxßve_u£r
(
buf
);

107 i‡(
îr
)

108  
îr
;

109 
	`èsk_thªad_öfo
(
tsk
)->
°©us
 &~
TS_USEDFPU
;

110 
	`°ts
();

112 i‡(
	`__c›y_to_u£r
(
buf
, &
tsk
->
thªad
.
x°©e
->
fxßve
,

113 
x°©e_size
))

117 
	`˛ór_u£d_m©h
();

119 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
) {

120 
_Â°©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x°©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x°©e_bv
;

124 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved
,

125 (
_Âx_sw_byãs
));

127 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
îr
 |
	`__gë_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

149 
x°©e_bv
 |
XSTATE_FPSSE
;

151 
îr
 |
	`__put_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

153 i‡(
îr
)

154  
îr
;

158 
	}
}

164 
	$ª°‹e_u£r_x°©e
(
__u£r
 *
buf
)

166 
_Âx_sw_byãs
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
îr
;

170 i‡((()
buf
 % 64) ||

171 
	`check_f‹_x°©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_⁄ly
;

174 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

179 
îr
 = 
	`xª°‹e_u£r
(
buf
, 
mask
);

180 i‡(
îr
)

181  
îr
;

186 
mask
 = 
p˙txt_mask
 & ~mask;

188 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
mask
);

192 
fx_⁄ly
:

198 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
p˙txt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)
buf
);

200 
	}
}

205 
	$ª°‹e_i387_x°©e
(
__u£r
 *
buf
)

207 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

208 
îr
 = 0;

210 i‡(!
buf
) {

211 i‡(
	`u£d_m©h
())

212 
˛ór
;

215 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_size
))

216  -
EACCES
;

218 i‡(!
	`u£d_m©h
()) {

219 
îr
 = 
	`öô_Âu
(
tsk
);

220 i‡(
îr
)

221  
îr
;

224 i‡(!(
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 & 
TS_USEDFPU
)) {

225 
	`˛ts
();

226 
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 |
TS_USEDFPU
;

228 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

229 
îr
 = 
	`ª°‹e_u£r_x°©e
(
buf
);

231 
îr
 = 
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)

232 
buf
);

233 i‡(
	`u∆ikñy
(
îr
)) {

238 
˛ór
:

239 
	`˛ór_Âu
(
tsk
);

240 
	`˛ór_u£d_m©h
();

242  
îr
;

243 
	}
}

253 
	$¥ï¨e_fx_sw_‰ame
()

255 
size_exãnded
 = (
x°©e_size
 - (
i387_fxßve_°ru˘
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x°©e_size
 = (
_Â°©e
Ë+ 
size_exãnded
;

260 #ifde‡
CONFIG_IA32_EMULATION


261 
sig_x°©e_ü32_size
 = (
_Â°©e_ü32
Ë+ 
size_exãnded
;

264 
	`mem£t
(&
fx_sw_ª£rved
, 0, (fx_sw_reserved));

266 
fx_sw_ª£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_ª£rved
.
exãnded_size
 = 
sig_x°©e_size
;

268 
fx_sw_ª£rved
.
x°©e_bv
 = 
p˙txt_mask
;

269 
fx_sw_ª£rved
.
x°©e_size
 = xstate_size;

270 #ifde‡
CONFIG_IA32_EMULATION


271 
	`mem˝y
(&
fx_sw_ª£rved_ü32
, &
fx_sw_ª£rved
,

272 (
_Âx_sw_byãs
));

273 
fx_sw_ª£rved_ü32
.
exãnded_size
 = 
sig_x°©e_ü32_size
;

275 
	}
}

280 
xßve_°ru˘
 *
	göô_x°©e_buf
;

282 #ifde‡
CONFIG_X86_64


283 
	gsig_x°©e_size
 = (
_Â°©e
);

289 
__˝uöô
 
	$xßve_öô
()

291 i‡(!
˝u_has_xßve
)

294 
	`£t_ö_¸4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
p˙txt_mask
);

301 
	}
}

306 
__öô
 
	$£tup_x°©e_öô
()

308 
öô_x°©e_buf
 = 
	`Æloc_boŸmem
(
x°©e_size
);

309 
öô_x°©e_buf
->
i387
.
mxc§
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__ªf
 
	$xßve_˙txt_öô
()

317 
óx
, 
ebx
, 
ecx
, 
edx
;

319 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

320 
p˙txt_mask
 = 
óx
 + ((
u64
)
edx
 << 32);

322 i‡((
p˙txt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`¥ötk
(
KERN_ERR
 "FP/SSEÇot shown under xsave features 0x%llx\n",

324 
p˙txt_mask
);

325 
	`BUG
();

331 
p˙txt_mask
 =Ö˙txt_mask & 
XCNTXT_MASK
;

332 
	`xßve_öô
();

337 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

338 
x°©e_size
 = 
ebx
;

340 
	`¥ï¨e_fx_sw_‰ame
();

342 
	`£tup_x°©e_öô
();

344 
	`¥ötk
(
KERN_INFO
 "xsave/xrstor:Énabled xstate_bv 0x%llx, "

346 
p˙txt_mask
, 
x°©e_size
);

347 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/•ölock.h
>

3 
	~<asm/uac˚ss.h
>

6 
	$fixup_ex˚±i⁄
(
±_ªgs
 *
ªgs
)

8 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

10 #ifde‡
CONFIG_PNPBIOS


11 i‡(
	`u∆ikñy
(
	`SEGMENT_IS_PNP_CODE
(
ªgs
->
cs
))) {

12 
u32
 
≤p_bios_Áu…_eù
, 
≤p_bios_Áu…_e•
;

13 
u32
 
≤p_bios_is_uâî_¸≠
;

14 
≤p_bios_is_uâî_¸≠
 = 1;

15 
	`¥ötk
(
KERN_CRIT
 "PNPBIOS fault..áttemptingÑecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
≤p_bios_Áu…_e•
), "g" (
≤p_bios_Áu…_eù
));

20 
	`∑nic
("do_trap: can't hitÅhis");

24 
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
);

25 i‡(
fixup
) {

27 i‡(
fixup
->fixup < 16) {

28 
	`cuºít_thªad_öfo
()->
uac˚ss_îr
 = -
EFAULT
;

29 
ªgs
->
ù
 +
fixup
->fixup;

32 
ªgs
->
ù
 = 
fixup
->fixup;

37 
	}
}

39 #ifde‡
CONFIG_X86_64


44 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *

45 
	$£¨ch_exèbÀ
(c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fú°
,

46 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
œ°
,

47 
vÆue
)

50 i‡((
vÆue
 >> 32) == 0)

51 
vÆue
 |= 0xffffffffUL << 32;

53 
fú°
 <
œ°
) {

54 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
mid
;

55 
diff
;

57 
mid
 = (
œ°
 - 
fú°
) / 2 + first;

58 
diff
 = 
mid
->
ö¢
 - 
vÆue
;

59 i‡(
diff
 == 0)

60  
mid
;

61 i‡(
diff
 < 0)

62 
fú°
 = 
mid
+1;

64 
œ°
 = 
mid
-1;

66  
NULL
;

67 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<löux/magic.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/kdebug.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/boŸmem.h
>

11 
	~<löux/k¥obes.h
>

12 
	~<löux/mmiŸø˚.h
>

13 
	~<löux/≥rf_cou¡î.h
>

15 
	~<asm/å≠s.h
>

16 
	~<asm/pgÆloc.h
>

17 
	~<asm/kmemcheck.h
>

28 
	ex86_pf_îr‹_code
 {

30 
	mPF_PROT
 = 1 << 0,

31 
	mPF_WRITE
 = 1 << 1,

32 
	mPF_USER
 = 1 << 2,

33 
	mPF_RSVD
 = 1 << 3,

34 
	mPF_INSTR
 = 1 << 4,

41 
ölöe
 
	$kmmio_Áu…
(
±_ªgs
 *
ªgs
, 
addr
)

43 i‡(
	`u∆ikñy
(
	`is_kmmio_a˘ive
()))

44 i‡(
	`kmmio_h™dÀr
(
ªgs
, 
addr
) == 1)

47 
	}
}

49 
ölöe
 
	$nŸify_∑ge_Áu…
(
±_ªgs
 *
ªgs
)

51 
ªt
 = 0;

54 i‡(
	`k¥obes_buût_ö
(Ë&& !
	`u£r_mode_vm
(
ªgs
)) {

55 
	`¥ìm±_dißbÀ
();

56 i‡(
	`k¥obe_ru¬ög
(Ë&& 
	`k¥obe_Áu…_h™dÀr
(
ªgs
, 14))

57 
ªt
 = 1;

58 
	`¥ìm±_íabÀ
();

61  
ªt
;

62 
	}
}

79 
ölöe
 

80 
	$check_¥e„tch_›code
(
±_ªgs
 *
ªgs
, *
ö°r
,

81 
›code
, *
¥e„tch
)

83 
ö°r_hi
 = 
›code
 & 0xf0;

84 
ö°r_lo
 = 
›code
 & 0x0f;

86 
ö°r_hi
) {

95  ((
ö°r_lo
 & 7) == 0x6);

96 #ifde‡
CONFIG_X86_64


105  (!
	`u£r_mode
(
ªgs
)Ë|| (ªgs->
cs
 =
__USER_CS
);

109  (
ö°r_lo
 & 0xC) == 0x4;

112  !
ö°r_lo
 || (instr_lo>>1) == 1;

115 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

118 *
¥e„tch
 = (
ö°r_lo
 == 0xF) &&

119 (
›code
 == 0x0D || opcode == 0x18);

124 
	}
}

127 
	$is_¥e„tch
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addr
)

129 *
max_ö°r
;

130 *
ö°r
;

131 
¥e„tch
 = 0;

137 i‡(
îr‹_code
 & 
PF_INSTR
)

140 
ö°r
 = (*)
	`c⁄vît_ù_to_löór
(
cuºít
, 
ªgs
);

141 
max_ö°r
 = 
ö°r
 + 15;

143 i‡(
	`u£r_mode
(
ªgs
Ë&& 
ö°r
 >(*)
TASK_SIZE
)

146 
ö°r
 < 
max_ö°r
) {

147 
›code
;

149 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

152 
ö°r
++;

154 i‡(!
	`check_¥e„tch_›code
(
ªgs
, 
ö°r
, 
›code
, &
¥e„tch
))

157  
¥e„tch
;

158 
	}
}

161 
	$f‹˚_sig_öfo_Áu…
(
si_signo
, 
si_code
, 
addªss
,

162 
èsk_°ru˘
 *
tsk
)

164 
sigöfo_t
 
öfo
;

166 
öfo
.
si_signo
 = si_signo;

167 
öfo
.
si_î∫o
 = 0;

168 
öfo
.
si_code
 = si_code;

169 
öfo
.
si_addr
 = (
__u£r
 *)
addªss
;

171 
	`f‹˚_sig_öfo
(
si_signo
, &
öfo
, 
tsk
);

172 
	}
}

174 
DEFINE_SPINLOCK
(
pgd_lock
);

175 
LIST_HEAD
(
pgd_li°
);

177 #ifde‡
CONFIG_X86_32


178 
ölöe
 
pmd_t
 *
	$vmÆloc_sync_⁄e
(
pgd_t
 *
pgd
, 
addªss
)

180 
ödex
 = 
	`pgd_ödex
(
addªss
);

181 
pgd_t
 *
pgd_k
;

182 
pud_t
 *
pud
, *
pud_k
;

183 
pmd_t
 *
pmd
, *
pmd_k
;

185 
pgd
 +
ödex
;

186 
pgd_k
 = 
öô_mm
.
pgd
 + 
ödex
;

188 i‡(!
	`pgd_¥e£¡
(*
pgd_k
))

189  
NULL
;

196 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

197 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
addªss
);

198 i‡(!
	`pud_¥e£¡
(*
pud_k
))

199  
NULL
;

201 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

202 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
addªss
);

203 i‡(!
	`pmd_¥e£¡
(*
pmd_k
))

204  
NULL
;

206 i‡(!
	`pmd_¥e£¡
(*
pmd
))

207 
	`£t_pmd
(
pmd
, *
pmd_k
);

209 
	`BUG_ON
(
	`pmd_∑ge
(*
pmd
Ë!pmd_∑ge(*
pmd_k
));

211  
pmd_k
;

212 
	}
}

214 
	$vmÆloc_sync_Æl
()

216 
addªss
;

218 i‡(
SHARED_KERNEL_PMD
)

221 
addªss
 = 
VMALLOC_START
 & 
PMD_MASK
;

222 
addªss
 >
TASK_SIZE
 &&áddªs†< 
FIXADDR_TOP
;

223 
addªss
 +
PMD_SIZE
) {

225 
Êags
;

226 
∑ge
 *page;

228 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

229 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

230 i‡(!
	`vmÆloc_sync_⁄e
(
	`∑ge_addªss
(
∑ge
), 
addªss
))

233 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

235 
	}
}

242 
noölöe
 
	$vmÆloc_Áu…
(
addªss
)

244 
pgd_∑ddr
;

245 
pmd_t
 *
pmd_k
;

246 
±e_t
 *
±e_k
;

249 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

259 
pgd_∑ddr
 = 
	`ªad_¸3
();

260 
pmd_k
 = 
	`vmÆloc_sync_⁄e
(
	`__va
(
pgd_∑ddr
), 
addªss
);

261 i‡(!
pmd_k
)

264 
±e_k
 = 
	`±e_off£t_kî√l
(
pmd_k
, 
addªss
);

265 i‡(!
	`±e_¥e£¡
(*
±e_k
))

269 
	}
}

274 
ölöe
 

275 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

276 
èsk_°ru˘
 *
tsk
)

278 
bô
;

280 i‡(!
	`v8086_mode
(
ªgs
))

283 
bô
 = (
addªss
 - 0xA0000Ë>> 
PAGE_SHIFT
;

284 i‡(
bô
 < 32)

285 
tsk
->
thªad
.
s¸ìn_bôm≠
 |1 << 
bô
;

286 
	}
}

288 
	$dump_∑gëabÀ
(
addªss
)

290 
	`__ty≥of__
(
	`±e_vÆ
(
	`__±e
(0))Ë
∑ge
;

292 
∑ge
 = 
	`ªad_¸3
();

293 
∑ge
 = ((
	`__ty≥of__
’ageË*Ë
	`__va
’age))[
addªss
 >> 
PGDIR_SHIFT
];

295 #ifde‡
CONFIG_X86_PAE


296 
	`¥ötk
("*pd± = %016Lx ", 
∑ge
);

297 i‡((
∑ge
 >> 
PAGE_SHIFT
Ë< 
max_low_p‚


298 && 
∑ge
 & 
_PAGE_PRESENT
) {

299 
∑ge
 &
PAGE_MASK
;

300 
∑ge
 = ((
	`__ty≥of__
’ageË*Ë
	`__va
’age))[(
addªss
 >> 
PMD_SHIFT
)

301 & (
PTRS_PER_PMD
 - 1)];

302 
	`¥ötk
(
KERN_CONT
 "*pdê%016Lx ", 
∑ge
);

303 
∑ge
 &~
_PAGE_NX
;

306 
	`¥ötk
("*pdê%08lx ", 
∑ge
);

315 i‡((
∑ge
 >> 
PAGE_SHIFT
Ë< 
max_low_p‚


316 && (
∑ge
 & 
_PAGE_PRESENT
)

317 && !(
∑ge
 & 
_PAGE_PSE
)) {

319 
∑ge
 &
PAGE_MASK
;

320 
∑ge
 = ((
	`__ty≥of__
’ageË*Ë
	`__va
’age))[(
addªss
 >> 
PAGE_SHIFT
)

321 & (
PTRS_PER_PTE
 - 1)];

322 
	`¥ötk
("*±ê%0*Lx ", (
∑ge
)*2, (
u64
)page);

325 
	`¥ötk
("\n");

326 
	}
}

330 
	$vmÆloc_sync_Æl
()

332 
addªss
;

334 
addªss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;áddªs†<
VMALLOC_END
;

335 
addªss
 +
PGDIR_SIZE
) {

337 c⁄° 
pgd_t
 *
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

338 
Êags
;

339 
∑ge
 *page;

341 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

344 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

345 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

346 
pgd_t
 *
pgd
;

347 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

348 i‡(
	`pgd_n⁄e
(*
pgd
))

349 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

351 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

353 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

355 
	}
}

364 
noölöe
 
	$vmÆloc_Áu…
(
addªss
)

366 
pgd_t
 *
pgd
, *
pgd_ªf
;

367 
pud_t
 *
pud
, *
pud_ªf
;

368 
pmd_t
 *
pmd
, *
pmd_ªf
;

369 
±e_t
 *
±e
, *
±e_ªf
;

372 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

380 
pgd
 = 
	`pgd_off£t
(
cuºít
->
a˘ive_mm
, 
addªss
);

381 
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

382 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

385 i‡(
	`pgd_n⁄e
(*
pgd
))

386 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

388 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

395 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

396 
pud_ªf
 = 
	`pud_off£t
(
pgd_ªf
, 
addªss
);

397 i‡(
	`pud_n⁄e
(*
pud_ªf
))

400 i‡(
	`pud_n⁄e
(*
pud
Ë|| 
	`pud_∑ge_vaddr
(*pudË!pud_∑ge_vaddr(*
pud_ªf
))

401 
	`BUG
();

403 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

404 
pmd_ªf
 = 
	`pmd_off£t
(
pud_ªf
, 
addªss
);

405 i‡(
	`pmd_n⁄e
(*
pmd_ªf
))

408 i‡(
	`pmd_n⁄e
(*
pmd
Ë|| 
	`pmd_∑ge
(*pmdË!pmd_∑ge(*
pmd_ªf
))

409 
	`BUG
();

411 
±e_ªf
 = 
	`±e_off£t_kî√l
(
pmd_ªf
, 
addªss
);

412 i‡(!
	`±e_¥e£¡
(*
±e_ªf
))

415 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

422 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| 
	`±e_p‚
(*±eË!±e_p‚(*
±e_ªf
))

423 
	`BUG
();

426 
	}
}

428 c⁄° 
	gîøè93_w¨nög
[] =

429 
KERN_ERR


438 
ölöe
 

439 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

440 
èsk_°ru˘
 *
tsk
)

442 
	}
}

444 
	$bad_addªss
(*
p
)

446 
dummy
;

448  
	`¥obe_kî√l_addªss
((*)
p
, 
dummy
);

449 
	}
}

451 
	$dump_∑gëabÀ
(
addªss
)

453 
pgd_t
 *
pgd
;

454 
pud_t
 *
pud
;

455 
pmd_t
 *
pmd
;

456 
±e_t
 *
±e
;

458 
pgd
 = (
pgd_t
 *)
	`ªad_¸3
();

460 
pgd
 = 
	`__va
((Ìgd & 
PHYSICAL_PAGE_MASK
);

462 
pgd
 +
	`pgd_ödex
(
addªss
);

463 i‡(
	`bad_addªss
(
pgd
))

464 
bad
;

466 
	`¥ötk
("PGD %lx ", 
	`pgd_vÆ
(*
pgd
));

468 i‡(!
	`pgd_¥e£¡
(*
pgd
))

469 
out
;

471 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

472 i‡(
	`bad_addªss
(
pud
))

473 
bad
;

475 
	`¥ötk
("PUD %lx ", 
	`pud_vÆ
(*
pud
));

476 i‡(!
	`pud_¥e£¡
(*
pud
Ë|| 
	`pud_œrge
(*pud))

477 
out
;

479 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

480 i‡(
	`bad_addªss
(
pmd
))

481 
bad
;

483 
	`¥ötk
("PMD %lx ", 
	`pmd_vÆ
(*
pmd
));

484 i‡(!
	`pmd_¥e£¡
(*
pmd
Ë|| 
	`pmd_œrge
(*pmd))

485 
out
;

487 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

488 i‡(
	`bad_addªss
(
±e
))

489 
bad
;

491 
	`¥ötk
("PTE %lx", 
	`±e_vÆ
(*
±e
));

492 
out
:

493 
	`¥ötk
("\n");

495 
bad
:

496 
	`¥ötk
("BAD\n");

497 
	}
}

515 
	$is_îøè93
(
±_ªgs
 *
ªgs
, 
addªss
)

517 #ifde‡
CONFIG_X86_64


518 i‡(
addªss
 !
ªgs
->
ù
)

521 i‡((
addªss
 >> 32) != 0)

524 
addªss
 |= 0xffffffffUL << 32;

525 i‡((
addªss
 >(
u64
)
_°ext
 &&áddªs†<(u64)
_ëext
) ||

526 (
addªss
 >
MODULES_VADDR
 &&áddªs†<
MODULES_END
)) {

527 
	`¥ötk_⁄˚
(
îøè93_w¨nög
);

528 
ªgs
->
ù
 = 
addªss
;

533 
	}
}

543 
	$is_îøè100
(
±_ªgs
 *
ªgs
, 
addªss
)

545 #ifde‡
CONFIG_X86_64


546 i‡((
ªgs
->
cs
 =
__USER32_CS
 || (ªgs->c†& (1<<2))Ë&& (
addªss
 >> 32))

550 
	}
}

552 
	$is_f00f_bug
(
±_ªgs
 *
ªgs
, 
addªss
)

554 #ifde‡
CONFIG_X86_F00F_BUG


555 
ƒ
;

560 i‡(
boŸ_˝u_d©a
.
f00f_bug
) {

561 
ƒ
 = (
addªss
 - 
idt_des¸
.address) >> 3;

563 i‡(
ƒ
 == 6) {

564 
	`do_övÆid_›
(
ªgs
, 0);

570 
	}
}

572 c⁄° 
	gnx_w¨nög
[] = 
KERN_CRIT


576 
	$show_Áu…_o›s
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

577 
addªss
)

579 i‡(!
	`o›s_may_¥öt
())

582 i‡(
îr‹_code
 & 
PF_INSTR
) {

583 
Àvñ
;

585 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

587 i‡(
±e
 && 
	`±e_¥e£¡
(*±eË&& !
	`±e_exec
(*pte))

588 
	`¥ötk
(
nx_w¨nög
, 
	`cuºít_uid
());

591 
	`¥ötk
(
KERN_ALERT
 "BUG: unableÅo handle kernel ");

592 i‡(
addªss
 < 
PAGE_SIZE
)

593 
	`¥ötk
(
KERN_CONT
 "NULLÖointer dereference");

595 
	`¥ötk
(
KERN_CONT
 "pagingÑequest");

597 
	`¥ötk
(
KERN_CONT
 "áà%p\n", (*Ë
addªss
);

598 
	`¥ötk
(
KERN_ALERT
 "IP:");

599 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

601 
	`dump_∑gëabÀ
(
addªss
);

602 
	}
}

604 
noölöe
 

605 
	$pgèbÀ_bad
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

606 
addªss
)

608 
èsk_°ru˘
 *
tsk
;

609 
Êags
;

610 
sig
;

612 
Êags
 = 
	`o›s_begö
();

613 
tsk
 = 
cuºít
;

614 
sig
 = 
SIGKILL
;

616 
	`¥ötk
(
KERN_ALERT
 "%s: CorruptedÖageÅableátáddress %lx\n",

617 
tsk
->
comm
, 
addªss
);

618 
	`dump_∑gëabÀ
(
addªss
);

620 
tsk
->
thªad
.
¸2
 = 
addªss
;

621 
tsk
->
thªad
.
å≠_no
 = 14;

622 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

624 i‡(
	`__dõ
("BadÖagëabÀ", 
ªgs
, 
îr‹_code
))

625 
sig
 = 0;

627 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

628 
	}
}

630 
noölöe
 

631 
	$no_c⁄ãxt
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

632 
addªss
)

634 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

635 *
°ackíd
;

636 
Êags
;

637 
sig
;

640 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

654 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

657 i‡(
	`is_îøè93
(
ªgs
, 
addªss
))

664 
Êags
 = 
	`o›s_begö
();

666 
	`show_Áu…_o›s
(
ªgs
, 
îr‹_code
, 
addªss
);

668 
°ackíd
 = 
	`íd_of_°ack
(
tsk
);

669 i‡(*
°ackíd
 !
STACK_END_MAGIC
)

670 
	`¥ötk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

672 
tsk
->
thªad
.
¸2
 = 
addªss
;

673 
tsk
->
thªad
.
å≠_no
 = 14;

674 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

676 
sig
 = 
SIGKILL
;

677 i‡(
	`__dõ
("O›s", 
ªgs
, 
îr‹_code
))

678 
sig
 = 0;

681 
	`¥ötk
(
KERN_EMERG
 "CR2: %016lx\n", 
addªss
);

683 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

684 
	}
}

690 
ölöe
 

691 
	$show_sig«l_msg
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

692 
addªss
, 
èsk_°ru˘
 *
tsk
)

694 i‡(!
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
))

697 i‡(!
	`¥ötk_øãlimô
())

700 
	`¥ötk
("%s%s[%d]: segfaultát %lx ip %p sp %pÉrror %lx",

701 
	`èsk_pid_ƒ
(
tsk
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

702 
tsk
->
comm
, 
	`èsk_pid_ƒ
—sk), 
addªss
,

703 (*)
ªgs
->
ù
, (*Ïegs->
•
, 
îr‹_code
);

705 
	`¥öt_vma_addr
(
KERN_CONT
 " i¿", 
ªgs
->
ù
);

707 
	`¥ötk
(
KERN_CONT
 "\n");

708 
	}
}

711 
	$__bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

712 
addªss
, 
si_code
)

714 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

717 i‡(
îr‹_code
 & 
PF_USER
) {

721 
	`loˇl_úq_íabÀ
();

727 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

730 i‡(
	`is_îøè100
(
ªgs
, 
addªss
))

733 i‡(
	`u∆ikñy
(
show_unh™dÀd_sig«ls
))

734 
	`show_sig«l_msg
(
ªgs
, 
îr‹_code
, 
addªss
, 
tsk
);

737 
tsk
->
thªad
.
¸2
 = 
addªss
;

738 
tsk
->
thªad
.
îr‹_code
 =Éº‹_codê| (
addªss
 >
TASK_SIZE
);

739 
tsk
->
thªad
.
å≠_no
 = 14;

741 
	`f‹˚_sig_öfo_Áu…
(
SIGSEGV
, 
si_code
, 
addªss
, 
tsk
);

746 i‡(
	`is_f00f_bug
(
ªgs
, 
addªss
))

749 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

750 
	}
}

752 
noölöe
 

753 
	$bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

754 
addªss
)

756 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

757 
	}
}

760 
	$__bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

761 
addªss
, 
si_code
)

763 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

769 
	`up_ªad
(&
mm
->
mm≠_£m
);

771 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
si_code
);

772 
	}
}

774 
noölöe
 

775 
	$bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

777 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

778 
	}
}

780 
noölöe
 

781 
	$bad_¨ó_ac˚ss_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

782 
addªss
)

784 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_ACCERR
);

785 
	}
}

789 
	$out_of_mem‹y
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

790 
addªss
)

796 
	`up_ªad
(&
cuºít
->
mm
->
mm≠_£m
);

798 
	`∑geÁu…_out_of_mem‹y
();

799 
	}
}

802 
	$do_sigbus
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

804 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

805 
mm_°ru˘
 *
mm
 = 
tsk
->mm;

807 
	`up_ªad
(&
mm
->
mm≠_£m
);

810 i‡(!(
îr‹_code
 & 
PF_USER
))

811 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

814 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

817 
tsk
->
thªad
.
¸2
 = 
addªss
;

818 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

819 
tsk
->
thªad
.
å≠_no
 = 14;

821 
	`f‹˚_sig_öfo_Áu…
(
SIGBUS
, 
BUS_ADRERR
, 
addªss
, 
tsk
);

822 
	}
}

824 
noölöe
 

825 
	$mm_Áu…_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

826 
addªss
, 
Áu…
)

828 i‡(
Áu…
 & 
VM_FAULT_OOM
) {

829 
	`out_of_mem‹y
(
ªgs
, 
îr‹_code
, 
addªss
);

831 i‡(
Áu…
 & 
VM_FAULT_SIGBUS
)

832 
	`do_sigbus
(
ªgs
, 
îr‹_code
, 
addªss
);

834 
	`BUG
();

836 
	}
}

838 
	$•urious_Áu…_check
(
îr‹_code
, 
±e_t
 *
±e
)

840 i‡((
îr‹_code
 & 
PF_WRITE
Ë&& !
	`±e_wrôe
(*
±e
))

843 i‡((
îr‹_code
 & 
PF_INSTR
Ë&& !
	`±e_exec
(*
±e
))

847 
	}
}

861 
noölöe
 

862 
	$•urious_Áu…
(
îr‹_code
, 
addªss
)

864 
pgd_t
 *
pgd
;

865 
pud_t
 *
pud
;

866 
pmd_t
 *
pmd
;

867 
±e_t
 *
±e
;

868 
ªt
;

871 i‡(
îr‹_code
 & (
PF_USER
 | 
PF_RSVD
))

874 
pgd
 = 
öô_mm
.pgd + 
	`pgd_ödex
(
addªss
);

875 i‡(!
	`pgd_¥e£¡
(*
pgd
))

878 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

879 i‡(!
	`pud_¥e£¡
(*
pud
))

882 i‡(
	`pud_œrge
(*
pud
))

883  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pud
);

885 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

886 i‡(!
	`pmd_¥e£¡
(*
pmd
))

889 i‡(
	`pmd_œrge
(*
pmd
))

890  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

892 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

893 i‡(!
	`±e_¥e£¡
(*
±e
))

896 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, 
±e
);

897 i‡(!
ªt
)

904 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

905 
	`WARN_ONCE
(!
ªt
, "PMD has incorrectÖermission bits\n");

907  
ªt
;

908 
	}
}

910 
	gshow_unh™dÀd_sig«ls
 = 1;

912 
ölöe
 

913 
	$ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vm_¨ó_°ru˘
 *
vma
)

915 i‡(
wrôe
) {

917 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_WRITE
)))

923 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_PROT
))

927 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

931 
	}
}

933 
	$Áu…_ö_kî√l_•a˚
(
addªss
)

935  
addªss
 >
TASK_SIZE_MAX
;

936 
	}
}

943 
dŸø∂ökage
 
__k¥obes


944 
	$do_∑ge_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

946 
vm_¨ó_°ru˘
 *
vma
;

947 
èsk_°ru˘
 *
tsk
;

948 
addªss
;

949 
mm_°ru˘
 *
mm
;

950 
wrôe
;

951 
Áu…
;

953 
tsk
 = 
cuºít
;

954 
mm
 = 
tsk
->mm;

957 
addªss
 = 
	`ªad_¸2
();

963 i‡(
	`kmemcheck_a˘ive
(
ªgs
))

964 
	`kmemcheck_hide
(
ªgs
);

965 
	`¥e„tchw
(&
mm
->
mm≠_£m
);

967 i‡(
	`u∆ikñy
(
	`kmmio_Áu…
(
ªgs
, 
addªss
)))

983 i‡(
	`u∆ikñy
(
	`Áu…_ö_kî√l_•a˚
(
addªss
))) {

984 i‡(!(
îr‹_code
 & (
PF_RSVD
 | 
PF_USER
 | 
PF_PROT
))) {

985 i‡(
	`vmÆloc_Áu…
(
addªss
) >= 0)

988 i‡(
	`kmemcheck_Áu…
(
ªgs
, 
addªss
, 
îr‹_code
))

993 i‡(
	`•urious_Áu…
(
îr‹_code
, 
addªss
))

997 i‡(
	`nŸify_∑ge_Áu…
(
ªgs
))

1003 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1009 i‡(
	`u∆ikñy
(
	`nŸify_∑ge_Áu…
(
ªgs
)))

1018 i‡(
	`u£r_mode_vm
(
ªgs
)) {

1019 
	`loˇl_úq_íabÀ
();

1020 
îr‹_code
 |
PF_USER
;

1022 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

1023 
	`loˇl_úq_íabÀ
();

1026 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_RSVD
))

1027 
	`pgèbÀ_bad
(
ªgs
, 
îr‹_code
, 
addªss
);

1029 
	`≥rf_swcou¡î_evít
(
PERF_COUNT_SW_PAGE_FAULTS
, 1, 0, 
ªgs
, 
addªss
);

1035 i‡(
	`u∆ikñy
(
	`ö_©omic
(Ë|| !
mm
)) {

1036 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1056 i‡(
	`u∆ikñy
(!
	`down_ªad_åylock
(&
mm
->
mm≠_£m
))) {

1057 i‡((
îr‹_code
 & 
PF_USER
) == 0 &&

1058 !
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
)) {

1059 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1062 
	`down_ªad
(&
mm
->
mm≠_£m
);

1069 
	`might_¶ìp
();

1072 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

1073 i‡(
	`u∆ikñy
(!
vma
)) {

1074 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1077 i‡(
	`likñy
(
vma
->
vm_°¨t
 <
addªss
))

1078 
good_¨ó
;

1079 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))) {

1080 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1083 i‡(
îr‹_code
 & 
PF_USER
) {

1090 i‡(
	`u∆ikñy
(
addªss
 + 65536 + 32 * (Ë< 
ªgs
->
•
)) {

1091 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1095 i‡(
	`u∆ikñy
(
	`ex∑nd_°ack
(
vma
, 
addªss
))) {

1096 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1104 
good_¨ó
:

1105 
wrôe
 = 
îr‹_code
 & 
PF_WRITE
;

1107 i‡(
	`u∆ikñy
(
	`ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vma
))) {

1108 
	`bad_¨ó_ac˚ss_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
);

1117 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
wrôe
 ? 
FAULT_FLAG_WRITE
 : 0);

1119 i‡(
	`u∆ikñy
(
Áu…
 & 
VM_FAULT_ERROR
)) {

1120 
	`mm_Áu…_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

1124 i‡(
Áu…
 & 
VM_FAULT_MAJOR
) {

1125 
tsk
->
maj_Êt
++;

1126 
	`≥rf_swcou¡î_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MAJ
, 1, 0,

1127 
ªgs
, 
addªss
);

1129 
tsk
->
mö_Êt
++;

1130 
	`≥rf_swcou¡î_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MIN
, 1, 0,

1131 
ªgs
, 
addªss
);

1134 
	`check_v8086_mode
(
ªgs
, 
addªss
, 
tsk
);

1136 
	`up_ªad
(&
mm
->
mm≠_£m
);

1137 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<löux/sched.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/vm°©.h
>

10 
	~<löux/highmem.h
>

12 
	~<asm/pgèbÀ.h
>

14 
ölöe
 
±e_t
 
	$gup_gë_±e
(
±e_t
 *
±ï
)

16 #i‚de‡
CONFIG_X86_PAE


17  
	`ACCESS_ONCE
(*
±ï
);

51 
±e_t
 
±e
;

53 
ªåy
:

54 
±e
.
±e_low
 = 
±ï
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±ï
->pte_high;

57 
	`smp_rmb
();

58 i‡(
	`u∆ikñy
(
±e
.
±e_low
 !
±ï
->pte_low))

59 
ªåy
;

61  
±e
;

63 
	}
}

70 
noölöe
 
	$gup_±e_ønge
(
pmd_t
 
pmd
, 
addr
,

71 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

73 
mask
;

74 
±e_t
 *
±ï
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 i‡(
wrôe
)

78 
mask
 |
_PAGE_RW
;

80 
±ï
 = 
	`±e_off£t_m≠
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_gë_±e
(
±ï
);

83 
∑ge
 *page;

85 i‡((
	`±e_Êags
(
±e
Ë& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm≠
(
±ï
);

89 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

90 
∑ge
 = 
	`±e_∑ge
(
±e
);

91 
	`gë_∑ge
(
∑ge
);

92 
∑ges
[*
ƒ
] = 
∑ge
;

93 (*
ƒ
)++;

95 } 
±ï
++, 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

96 
	`±e_unm≠
(
±ï
 - 1);

99 
	}
}

101 
ölöe
 
	$gë_hód_∑ge_mu…ùÀ
(
∑ge
 *∑ge, 
ƒ
)

103 
	`VM_BUG_ON
(
∑ge
 !
	`compound_hód
(page));

104 
	`VM_BUG_ON
(
	`∑ge_cou¡
(
∑ge
) == 0);

105 
	`©omic_add
(
ƒ
, &
∑ge
->
_cou¡
);

106 
	}
}

108 
noölöe
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

111 
mask
;

112 
±e_t
 
±e
 = *’ã_à*)&
pmd
;

113 
∑ge
 *
hód
, *page;

114 
ªfs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 i‡(
wrôe
)

118 
mask
 |
_PAGE_RW
;

119 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

125 
ªfs
 = 0;

126 
hód
 = 
	`±e_∑ge
(
±e
);

127 
∑ge
 = 
hód
 + ((
addr
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

130 
∑ges
[*
ƒ
] = 
∑ge
;

131 (*
ƒ
)++;

132 
∑ge
++;

133 
ªfs
++;

134 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

135 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

138 
	}
}

140 
	$gup_pmd_ønge
(
pud_t
 
pud
, 
addr
, 
íd
,

141 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

143 
√xt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

151 i‡(
	`pmd_n⁄e
(
pmd
))

153 i‡(
	`u∆ikñy
(
	`pmd_œrge
(
pmd
))) {

154 i‡(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

157 i‡(!
	`gup_±e_ønge
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

160 } 
pmdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

163 
	}
}

165 
noölöe
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

168 
mask
;

169 
±e_t
 
±e
 = *’ã_à*)&
pud
;

170 
∑ge
 *
hód
, *page;

171 
ªfs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 i‡(
wrôe
)

175 
mask
 |
_PAGE_RW
;

176 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

182 
ªfs
 = 0;

183 
hód
 = 
	`±e_∑ge
(
±e
);

184 
∑ge
 = 
hód
 + ((
addr
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

187 
∑ges
[*
ƒ
] = 
∑ge
;

188 (*
ƒ
)++;

189 
∑ge
++;

190 
ªfs
++;

191 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

192 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

195 
	}
}

197 
	$gup_pud_ønge
(
pgd_t
 
pgd
, 
addr
, 
íd
,

198 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

200 
√xt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
√xt
 = 
	`pud_addr_íd
(
addr
, 
íd
);

208 i‡(
	`pud_n⁄e
(
pud
))

210 i‡(
	`u∆ikñy
(
	`pud_œrge
(
pud
))) {

211 i‡(!
	`gup_huge_pud
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

214 i‡(!
	`gup_pmd_ønge
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

217 } 
pudp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

220 
	}
}

226 
	$__gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

227 
∑ge
 **
∑ges
)

229 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

230 
addr
, 
Àn
, 
íd
;

231 
√xt
;

232 
Êags
;

233 
pgd_t
 *
pgdp
;

234 
ƒ
 = 0;

236 
°¨t
 &
PAGE_MASK
;

237 
addr
 = 
°¨t
;

238 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

239 
íd
 = 
°¨t
 + 
Àn
;

240 i‡(
	`u∆ikñy
(!
	`ac˚ss_ok
(
wrôe
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

241 (
__u£r
 *)
°¨t
, 
Àn
)))

262 
	`loˇl_úq_ßve
(
Êags
);

263 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

265 
pgd_t
 
pgd
 = *
pgdp
;

267 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

268 i‡(
	`pgd_n⁄e
(
pgd
))

270 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

272 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

273 
	`loˇl_úq_ª°‹e
(
Êags
);

275  
ƒ
;

276 
	}
}

294 
	$gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

295 
∑ge
 **
∑ges
)

297 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

298 
addr
, 
Àn
, 
íd
;

299 
√xt
;

300 
pgd_t
 *
pgdp
;

301 
ƒ
 = 0;

303 
°¨t
 &
PAGE_MASK
;

304 
addr
 = 
°¨t
;

305 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

307 
íd
 = 
°¨t
 + 
Àn
;

308 i‡(
íd
 < 
°¨t
)

309 
¶ow_úq⁄
;

311 #ifde‡
CONFIG_X86_64


312 i‡(
íd
 >> 
__VIRTUAL_MASK_SHIFT
)

313 
¶ow_úq⁄
;

334 
	`loˇl_úq_dißbÀ
();

335 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

337 
pgd_t
 
pgd
 = *
pgdp
;

339 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

340 i‡(
	`pgd_n⁄e
(
pgd
))

341 
¶ow
;

342 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

343 
¶ow
;

344 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

345 
	`loˇl_úq_íabÀ
();

347 
	`VM_BUG_ON
(
ƒ
 !(
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

348  
ƒ
;

351 
ªt
;

353 
¶ow
:

354 
	`loˇl_úq_íabÀ
();

355 
¶ow_úq⁄
:

357 
°¨t
 +
ƒ
 << 
PAGE_SHIFT
;

358 
∑ges
 +
ƒ
;

360 
	`down_ªad
(&
mm
->
mm≠_£m
);

361 
ªt
 = 
	`gë_u£r_∑ges
(
cuºít
, 
mm
, 
°¨t
,

362 (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
, 
wrôe
, 0, 
∑ges
, 
NULL
);

363 
	`up_ªad
(&
mm
->
mm≠_£m
);

366 i‡(
ƒ
 > 0) {

367 i‡(
ªt
 < 0)

368 
ªt
 = 
ƒ
;

370 
ªt
 +
ƒ
;

373  
ªt
;

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<löux/öô.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/hugëlb.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/îr.h
>

14 
	~<löux/sys˘l.h
>

15 
	~<asm/mm™.h
>

16 
	~<asm/éb.h
>

17 
	~<asm/ébÊush.h
>

18 
	~<asm/pgÆloc.h
>

20 
	$∑ge_èbÀ_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
svma
,

21 
vm_¨ó_°ru˘
 *
vma
,

22 
addr
, 
pgoff_t
 
idx
)

24 
ßddr
 = ((
idx
 - 
svma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
) +

25 
svma
->
vm_°¨t
;

26 
sba£
 = 
ßddr
 & 
PUD_MASK
;

27 
s_íd
 = 
sba£
 + 
PUD_SIZE
;

30 
vm_Êags
 = 
vma
->vm_Êag†& ~
VM_LOCKED
;

31 
svm_Êags
 = 
svma
->
vm_Êags
 & ~
VM_LOCKED
;

37 i‡(
	`pmd_ödex
(
addr
Ë!pmd_ödex(
ßddr
) ||

38 
vm_Êags
 !
svm_Êags
 ||

39 
sba£
 < 
svma
->
vm_°¨t
 || svma->
vm_íd
 < 
s_íd
)

42  
ßddr
;

43 
	}
}

45 
	$vma_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

47 
ba£
 = 
addr
 & 
PUD_MASK
;

48 
íd
 = 
ba£
 + 
PUD_SIZE
;

53 i‡(
vma
->
vm_Êags
 & 
VM_MAYSHARE
 &&

54 
vma
->
vm_°¨t
 <
ba£
 && 
íd
 <vma->
vm_íd
)

57 
	}
}

62 
	$huge_pmd_sh¨e
(
mm_°ru˘
 *
mm
, 
addr
, 
pud_t
 *
pud
)

64 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

65 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

66 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_°¨t
Ë>> 
PAGE_SHIFT
) +

67 
vma
->
vm_pgoff
;

68 
¥io_åì_ôî
 
ôî
;

69 
vm_¨ó_°ru˘
 *
svma
;

70 
ßddr
;

71 
±e_t
 *
•ã
 = 
NULL
;

73 i‡(!
	`vma_sh¨óbÀ
(
vma
, 
addr
))

76 
	`•ö_lock
(&
m≠pög
->
i_mm≠_lock
);

77 
	`vma_¥io_åì_f‹óch
(
svma
, &
ôî
, &
m≠pög
->
i_mm≠
, 
idx
, idx) {

78 i‡(
svma
 =
vma
)

81 
ßddr
 = 
	`∑ge_èbÀ_sh¨óbÀ
(
svma
, 
vma
, 
addr
, 
idx
);

82 i‡(
ßddr
) {

83 
•ã
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
ßddr
);

84 i‡(
•ã
) {

85 
	`gë_∑ge
(
	`vút_to_∑ge
(
•ã
));

91 i‡(!
•ã
)

92 
out
;

94 
	`•ö_lock
(&
mm
->
∑ge_èbÀ_lock
);

95 i‡(
	`pud_n⁄e
(*
pud
))

96 
	`pud_p›uœã
(
mm
, 
pud
, (
pmd_t
 *)(()
•ã
 & 
PAGE_MASK
));

98 
	`put_∑ge
(
	`vút_to_∑ge
(
•ã
));

99 
	`•ö_u∆ock
(&
mm
->
∑ge_èbÀ_lock
);

100 
out
:

101 
	`•ö_u∆ock
(&
m≠pög
->
i_mm≠_lock
);

102 
	}
}

116 
	$huge_pmd_unsh¨e
(
mm_°ru˘
 *
mm
, *
addr
, 
±e_t
 *
±ï
)

118 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

119 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

121 
	`BUG_ON
(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 0);

122 i‡(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 1)

125 
	`pud_˛ór
(
pud
);

126 
	`put_∑ge
(
	`vút_to_∑ge
(
±ï
));

127 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

129 
	}
}

131 
±e_t
 *
	$huge_±e_Æloc
(
mm_°ru˘
 *
mm
,

132 
addr
, 
sz
)

134 
pgd_t
 *
pgd
;

135 
pud_t
 *
pud
;

136 
±e_t
 *
±e
 = 
NULL
;

138 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

139 
pud
 = 
	`pud_Æloc
(
mm
, 
pgd
, 
addr
);

140 i‡(
pud
) {

141 i‡(
sz
 =
PUD_SIZE
) {

142 
±e
 = (
±e_t
 *)
pud
;

144 
	`BUG_ON
(
sz
 !
PMD_SIZE
);

145 i‡(
	`pud_n⁄e
(*
pud
))

146 
	`huge_pmd_sh¨e
(
mm
, 
addr
, 
pud
);

147 
±e
 = (
±e_t
 *Ë
	`pmd_Æloc
(
mm
, 
pud
, 
addr
);

150 
	`BUG_ON
(
±e
 && !
	`±e_n⁄e
(*±eË&& !
	`±e_huge
(*pte));

152  
±e
;

153 
	}
}

155 
±e_t
 *
	$huge_±e_off£t
(
mm_°ru˘
 *
mm
, 
addr
)

157 
pgd_t
 *
pgd
;

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
 = 
NULL
;

161 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

162 i‡(
	`pgd_¥e£¡
(*
pgd
)) {

163 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

164 i‡(
	`pud_¥e£¡
(*
pud
)) {

165 i‡(
	`pud_œrge
(*
pud
))

166  (
±e_t
 *)
pud
;

167 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

170  (
±e_t
 *Ë
pmd
;

171 
	}
}

174 
∑ge
 *

175 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

177 
°¨t
 = 
addªss
;

178 
Àngth
 = 1;

179 
ƒ
;

180 
∑ge
 *page;

181 
vm_¨ó_°ru˘
 *
vma
;

183 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

184 i‡(!
vma
 || !
	`is_vm_hugëlb_∑ge
(vma))

185  
	`ERR_PTR
(-
EINVAL
);

187 
±e
 = 
	`huge_±e_off£t
(
mm
, 
addªss
);

190 
	`WARN_ON
(!
±e
 || 
	`±e_n⁄e
(*pte));

192 
∑ge
 = &
	`±e_∑ge
(*
±e
)[
vp‚
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

194 
	`WARN_ON
(!
	`PageHód
(
∑ge
));

196  
∑ge
;

197 
	}
}

199 
	$pmd_huge
(
pmd_t
 
pmd
)

202 
	}
}

204 
	$pud_huge
(
pud_t
 
pud
)

207 
	}
}

209 
∑ge
 *

210 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

211 
pmd_t
 *
pmd
, 
wrôe
)

213  
NULL
;

214 
	}
}

218 
∑ge
 *

219 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

221  
	`ERR_PTR
(-
EINVAL
);

222 
	}
}

224 
	$pmd_huge
(
pmd_t
 
pmd
)

226  !!(
	`pmd_vÆ
(
pmd
Ë& 
_PAGE_PSE
);

227 
	}
}

229 
	$pud_huge
(
pud_t
 
pud
)

231  !!(
	`pud_vÆ
(
pud
Ë& 
_PAGE_PSE
);

232 
	}
}

234 
∑ge
 *

235 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

236 
pmd_t
 *
pmd
, 
wrôe
)

238 
∑ge
 *page;

240 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pmd
);

241 i‡(
∑ge
)

242 
∑ge
 +((
addªss
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

243  
∑ge
;

244 
	}
}

246 
∑ge
 *

247 
	$fﬁlow_huge_pud
(
mm_°ru˘
 *
mm
, 
addªss
,

248 
pud_t
 *
pud
, 
wrôe
)

250 
∑ge
 *page;

252 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pud
);

253 i‡(
∑ge
)

254 
∑ge
 +((
addªss
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

255  
∑ge
;

256 
	}
}

262 #ifde‡
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


263 
	$hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
 *file,

264 
addr
, 
Àn
,

265 
pgoff
, 
Êags
)

267 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

268 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

269 
vm_¨ó_°ru˘
 *
vma
;

270 
°¨t_addr
;

272 i‡(
Àn
 > 
mm
->
ˇched_hﬁe_size
) {

273 
°¨t_addr
 = 
mm
->
‰ì_¨ó_ˇche
;

275 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

276 
mm
->
ˇched_hﬁe_size
 = 0;

279 
fuŒ_£¨ch
:

280 
addr
 = 
	`ALIGN
(
°¨t_addr
, 
	`huge_∑ge_size
(
h
));

282 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

284 i‡(
TASK_SIZE
 - 
Àn
 < 
addr
) {

289 i‡(
°¨t_addr
 !
TASK_UNMAPPED_BASE
) {

290 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

291 
mm
->
ˇched_hﬁe_size
 = 0;

292 
fuŒ_£¨ch
;

294  -
ENOMEM
;

296 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

297 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

298  
addr
;

300 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

301 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

302 
addr
 = 
	`ALIGN
(
vma
->
vm_íd
, 
	`huge_∑ge_size
(
h
));

304 
	}
}

306 
	$hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
 *file,

307 
addr0
, 
Àn
,

308 
pgoff
, 
Êags
)

310 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

311 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

312 
vm_¨ó_°ru˘
 *
vma
, *
¥ev_vma
;

313 
ba£
 = 
mm
->
mm≠_ba£
, 
addr
 = 
addr0
;

314 
œrge°_hﬁe
 = 
mm
->
ˇched_hﬁe_size
;

315 
fú°_time
 = 1;

318 i‡(
mm
->
‰ì_¨ó_ˇche
 > 
ba£
)

319 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

321 i‡(
Àn
 <
œrge°_hﬁe
) {

322 
œrge°_hﬁe
 = 0;

323 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

325 
åy_agaö
:

327 i‡(
mm
->
‰ì_¨ó_ˇche
 < 
Àn
)

328 
Áû
;

331 
addr
 = (
mm
->
‰ì_¨ó_ˇche
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

337 i‡(!(
vma
 = 
	`föd_vma_¥ev
(
mm
, 
addr
, &
¥ev_vma
)))

338  
addr
;

344 i‡(
addr
 + 
Àn
 <
vma
->
vm_°¨t
 &&

345 (!
¥ev_vma
 || (
addr
 >¥ev_vma->
vm_íd
))) {

347 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

348  (
mm
->
‰ì_¨ó_ˇche
 = 
addr
);

351 i‡(
mm
->
‰ì_¨ó_ˇche
 =
vma
->
vm_íd
) {

352 
mm
->
‰ì_¨ó_ˇche
 = 
vma
->
vm_°¨t
;

353 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

358 i‡(
addr
 + 
œrge°_hﬁe
 < 
vma
->
vm_°¨t
)

359 
œrge°_hﬁe
 = 
vma
->
vm_°¨t
 - 
addr
;

362 
addr
 = (
vma
->
vm_°¨t
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

363 } 
Àn
 <
vma
->
vm_°¨t
);

365 
Áû
:

370 i‡(
fú°_time
) {

371 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

372 
œrge°_hﬁe
 = 0;

373 
fú°_time
 = 0;

374 
åy_agaö
;

382 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

383 
mm
->
ˇched_hﬁe_size
 = ~0UL;

384 
addr
 = 
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr0
,

385 
Àn
, 
pgoff
, 
Êags
);

390 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

391 
mm
->
ˇched_hﬁe_size
 = ~0UL;

393  
addr
;

394 
	}
}

397 
	$hugëlb_gë_unm≠≥d_¨ó
(
fûe
 *fûe, 
addr
,

398 
Àn
, 
pgoff
, 
Êags
)

400 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

401 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

402 
vm_¨ó_°ru˘
 *
vma
;

404 i‡(
Àn
 & ~
	`huge_∑ge_mask
(
h
))

405  -
EINVAL
;

406 i‡(
Àn
 > 
TASK_SIZE
)

407  -
ENOMEM
;

409 i‡(
Êags
 & 
MAP_FIXED
) {

410 i‡(
	`¥ï¨e_hugïage_ønge
(
fûe
, 
addr
, 
Àn
))

411  -
EINVAL
;

412  
addr
;

415 i‡(
addr
) {

416 
addr
 = 
	`ALIGN
◊ddr, 
	`huge_∑ge_size
(
h
));

417 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

418 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

419 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

420  
addr
;

422 i‡(
mm
->
gë_unm≠≥d_¨ó
 =
¨ch_gë_unm≠≥d_¨ó
)

423  
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr
, 
Àn
,

424 
pgoff
, 
Êags
);

426  
	`hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
, 
addr
, 
Àn
,

427 
pgoff
, 
Êags
);

428 
	}
}

432 #ifde‡
CONFIG_X86_64


433 
__öô
 
	$£tup_hugïagesz
(*
›t
)

435 
ps
 = 
	`mem∑r£
(
›t
, &opt);

436 i‡(
ps
 =
PMD_SIZE
) {

437 
	`hugëlb_add_h°©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

438 } i‡(
ps
 =
PUD_SIZE
 && 
˝u_has_gb∑ges
) {

439 
	`hugëlb_add_h°©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

441 
	`¥ötk
(
KERN_ERR
 "hugepagesz: UnsupportedÖage size %lu M\n",

442 
ps
 >> 20);

446 
	}
}

447 
__£tup
("hugïagesz=", 
£tup_hugïagesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<löux/öôrd.h
>

2 
	~<löux/i›‹t.h
>

3 
	~<löux/sw≠.h
>

5 
	~<asm/ˇcheÊush.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/öô.h
>

8 
	~<asm/∑ge.h
>

9 
	~<asm/∑ge_ty≥s.h
>

10 
	~<asm/£˘i⁄s.h
>

11 
	~<asm/£tup.h
>

12 
	~<asm/sy°em.h
>

13 
	~<asm/ébÊush.h
>

14 
	~<asm/éb.h
>

15 
	~<asm/¥Ÿo.h
>

17 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

19 
__öôd©a
 
	ge820_èbÀ_°¨t
;

20 
__memöôd©a
 
	ge820_èbÀ_íd
;

21 
__memöôd©a
 
	ge820_èbÀ_t›
;

23 
	ga·î_boŸmem
;

25 
	gdúe˘_gb∑ges


26 #ifde‡
CONFIG_DIRECT_GBPAGES


31 
	gnx_íabÀd
;

33 #i‡
deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

34 
dißbÀ_nx
 
	g__˝uöôd©a
;

44 
__öô
 
	$n€xec_£tup
(*
°r
)

46 i‡(!
°r
)

47  -
EINVAL
;

48 i‡(!
	`°∫cmp
(
°r
, "on", 2)) {

49 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

50 
dißbÀ_nx
 = 0;

51 } i‡(!
	`°∫cmp
(
°r
, "off", 3)) {

52 
dißbÀ_nx
 = 1;

53 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

56 
	}
}

57 
óæy_∑øm
("n€xec", 
n€xec_£tup
);

60 #ifde‡
CONFIG_X86_PAE


61 
__öô
 
	$£t_nx
()

63 
v
[4], 
l
, 
h
;

65 i‡(
˝u_has_∑e
 && (
	`˝uid_óx
(0x80000000) > 0x80000001)) {

66 
	`˝uid
(0x80000001, &
v
[0], &v[1], &v[2], &v[3]);

68 i‡((
v
[3] & (1 << 20)Ë&& !
dißbÀ_nx
) {

69 
	`rdm§
(
MSR_EFER
, 
l
, 
h
);

70 
l
 |
EFER_NX
;

71 
	`wrm§
(
MSR_EFER
, 
l
, 
h
);

72 
nx_íabÀd
 = 1;

73 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

76 
	}
}

78 
ölöe
 
	$£t_nx
()

80 
	}
}

83 #ifde‡
CONFIG_X86_64


84 
__˝uöô
 
	$check_e„r
()

86 
e„r
;

88 
	`rdm§l
(
MSR_EFER
, 
e„r
);

89 i‡(!(
e„r
 & 
EFER_NX
Ë|| 
dißbÀ_nx
)

90 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

91 
	}
}

94 
__öô
 
	$föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
,

95 
u£_gb∑ges
)

97 
puds
, 
pmds
, 
±es
, 
èbÀs
, 
°¨t
;

99 
puds
 = (
íd
 + 
PUD_SIZE
 - 1Ë>> 
PUD_SHIFT
;

100 
èbÀs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

102 i‡(
u£_gb∑ges
) {

103 
exåa
;

105 
exåa
 = 
íd
 - (”nd>>
PUD_SHIFT
) << PUD_SHIFT);

106 
pmds
 = (
exåa
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

108 
pmds
 = (
íd
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

110 
èbÀs
 +
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

112 i‡(
u£_p£
) {

113 
exåa
;

115 
exåa
 = 
íd
 - (”nd>>
PMD_SHIFT
) << PMD_SHIFT);

116 #ifde‡
CONFIG_X86_32


117 
exåa
 +
PMD_SIZE
;

119 
±es
 = (
exåa
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

121 
±es
 = (
íd
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

123 
èbÀs
 +
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

125 #ifde‡
CONFIG_X86_32


127 
èbÀs
 +
	`roundup
(
__íd_of_fixed_addªs£s
 * (
±e_t
), 
PAGE_SIZE
);

135 #ifde‡
CONFIG_X86_32


136 
°¨t
 = 0x7000;

138 
°¨t
 = 0x8000;

140 
e820_èbÀ_°¨t
 = 
	`föd_e820_¨ó
(
°¨t
, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
,

141 
èbÀs
, 
PAGE_SIZE
);

142 i‡(
e820_èbÀ_°¨t
 == -1UL)

143 
	`∑nic
("Cannot find space forÅhe kernelÖageÅables");

145 
e820_èbÀ_°¨t
 >>
PAGE_SHIFT
;

146 
e820_èbÀ_íd
 = 
e820_èbÀ_°¨t
;

147 
e820_èbÀ_t›
 = 
e820_èbÀ_°¨t
 + (
èbÀs
 >> 
PAGE_SHIFT
);

149 
	`¥ötk
(
KERN_DEBUG
 "kernel direct mappingÅables upÅo %lx @ %lx-%lx\n",

150 
íd
, 
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
, 
e820_èbÀ_t›
 << PAGE_SHIFT);

151 
	}
}

153 
	sm≠_ønge
 {

154 
	m°¨t
;

155 
	míd
;

156 
	m∑ge_size_mask
;

159 #ifde‡
CONFIG_X86_32


160 
	#NR_RANGE_MR
 3

	)

162 
	#NR_RANGE_MR
 5

	)

165 
__memöô
 
	$ßve_mr
(
m≠_ønge
 *
mr
, 
ƒ_ønge
,

166 
°¨t_p‚
, 
íd_p‚
,

167 
∑ge_size_mask
)

169 i‡(
°¨t_p‚
 < 
íd_p‚
) {

170 i‡(
ƒ_ønge
 >
NR_RANGE_MR
)

171 
	`∑nic
("run out ofÑange for init_memory_mapping\n");

172 
mr
[
ƒ_ønge
].
°¨t
 = 
°¨t_p‚
<<
PAGE_SHIFT
;

173 
mr
[
ƒ_ønge
].
íd
 = 
íd_p‚
<<
PAGE_SHIFT
;

174 
mr
[
ƒ_ønge
].
∑ge_size_mask
 =Öage_size_mask;

175 
ƒ_ønge
++;

178  
ƒ_ønge
;

179 
	}
}

186 
__öô_ªfok
 
	$öô_mem‹y_m≠pög
(
°¨t
,

187 
íd
)

189 
∑ge_size_mask
 = 0;

190 
°¨t_p‚
, 
íd_p‚
;

191 
ªt
 = 0;

192 
pos
;

194 
m≠_ønge
 
mr
[
NR_RANGE_MR
];

195 
ƒ_ønge
, 
i
;

196 
u£_p£
, 
u£_gb∑ges
;

198 
	`¥ötk
(
KERN_INFO
 "öô_mem‹y_m≠pög: %016lx-%016lx\n", 
°¨t
, 
íd
);

200 #i‡
	`deföed
(
CONFIG_DEBUG_PAGEALLOC
Ë|| deföed(
CONFIG_KMEMCHECK
)

206 
u£_p£
 = 
u£_gb∑ges
 = 0;

208 
u£_p£
 = 
˝u_has_p£
;

209 
u£_gb∑ges
 = 
dúe˘_gb∑ges
;

212 
	`£t_nx
();

213 i‡(
nx_íabÀd
)

214 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection:áctive\n");

217 i‡(
˝u_has_p£
)

218 
	`£t_ö_¸4
(
X86_CR4_PSE
);

221 i‡(
˝u_has_pge
) {

222 
	`£t_ö_¸4
(
X86_CR4_PGE
);

223 
__suµ‹ãd_±e_mask
 |
_PAGE_GLOBAL
;

226 i‡(
u£_gb∑ges
)

227 
∑ge_size_mask
 |1 << 
PG_LEVEL_1G
;

228 i‡(
u£_p£
)

229 
∑ge_size_mask
 |1 << 
PG_LEVEL_2M
;

231 
	`mem£t
(
mr
, 0, (mr));

232 
ƒ_ønge
 = 0;

235 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

236 
pos
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

237 #ifde‡
CONFIG_X86_32


244 i‡(
pos
 == 0)

245 
íd_p‚
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

247 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

248 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

250 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1)Ë>> 
PMD_SHIFT
)

251 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

253 i‡(
íd_p‚
 > (
íd
 >> 
PAGE_SHIFT
))

254 
íd_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

255 i‡(
°¨t_p‚
 < 
íd_p‚
) {

256 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

257 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

261 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

262 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

263 #ifde‡
CONFIG_X86_32


264 
íd_p‚
 = (
íd
>>
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

266 
íd_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

267 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

268 i‡(
íd_p‚
 > ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

269 
íd_p‚
 = ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

272 i‡(
°¨t_p‚
 < 
íd_p‚
) {

273 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

274 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

275 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

278 #ifde‡
CONFIG_X86_64


280 
°¨t_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

281 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

282 
íd_p‚
 = (
íd
 >> 
PUD_SHIFT
Ë<< (PUD_SHIFT - 
PAGE_SHIFT
);

283 i‡(
°¨t_p‚
 < 
íd_p‚
) {

284 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

285 
∑ge_size_mask
 &

286 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

287 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

291 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

292 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

293 
íd_p‚
 = (
íd
 >> 
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

294 i‡(
°¨t_p‚
 < 
íd_p‚
) {

295 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

296 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

297 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

302 
°¨t_p‚
 = 
pos
>>
PAGE_SHIFT
;

303 
íd_p‚
 = 
íd
>>
PAGE_SHIFT
;

304 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

307 
i
 = 0; 
ƒ_ønge
 > 1 && i <Çr_range - 1; i++) {

308 
ﬁd_°¨t
;

309 i‡(
mr
[
i
].
íd
 !mr[i+1].
°¨t
 ||

310 
mr
[
i
].
∑ge_size_mask
 != mr[i+1].page_size_mask)

313 
ﬁd_°¨t
 = 
mr
[
i
].
°¨t
;

314 
	`memmove
(&
mr
[
i
], &mr[i+1],

315 (
ƒ_ønge
 - 1 - 
i
Ë* (
m≠_ønge
));

316 
mr
[
i
--].
°¨t
 = 
ﬁd_°¨t
;

317 
ƒ_ønge
--;

320 
i
 = 0; i < 
ƒ_ønge
; i++)

321 
	`¥ötk
(
KERN_DEBUG
 " %010lx - %010lxÖage %s\n",

322 
mr
[
i
].
°¨t
, mr[i].
íd
,

323 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

324 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

333 i‡(!
a·î_boŸmem
)

334 
	`föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
, 
u£_gb∑ges
);

336 #ifde‡
CONFIG_X86_32


337 
i
 = 0; i < 
ƒ_ønge
; i++)

338 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

339 
mr
[
i
].
∑ge_size_mask
);

340 
ªt
 = 
íd
;

342 
i
 = 0; i < 
ƒ_ønge
; i++)

343 
ªt
 = 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

344 
mr
[
i
].
∑ge_size_mask
);

347 #ifde‡
CONFIG_X86_32


348 
	`óæy_i‹em≠_∑ge_èbÀ_ønge_öô
();

350 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

353 #ifde‡
CONFIG_X86_64


354 i‡(!
a·î_boŸmem
 && !
°¨t
) {

355 
pud_t
 *
pud
;

356 
pmd_t
 *
pmd
;

358 
mmu_¸4_„©uªs
 = 
	`ªad_¸4
();

366 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_íd
), _brk_end);

367 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_íd
 - 1);

368 ++
pmd
 <
	`pmd_off£t
(
pud
, ()
_íd
 - 1))

369 
	`pmd_˛ór
(
pmd
);

372 
	`__Êush_éb_Æl
();

374 i‡(!
a·î_boŸmem
 && 
e820_èbÀ_íd
 > 
e820_èbÀ_°¨t
)

375 
	`ª£rve_óæy
(
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
,

376 
e820_èbÀ_íd
 << 
PAGE_SHIFT
, "PGTABLE");

378 i‡(!
a·î_boŸmem
)

379 
	`óæy_memã°
(
°¨t
, 
íd
);

381  
ªt
 >> 
PAGE_SHIFT
;

382 
	}
}

395 
	$devmem_is_Ælowed
(
∑gír
)

397 i‡(
∑gír
 <= 256)

399 i‡(
	`iomem_is_ex˛usive
(
∑gír
 << 
PAGE_SHIFT
))

401 i‡(!
	`∑ge_is_øm
(
∑gír
))

404 
	}
}

406 
	$‰ì_öô_∑ges
(*
wh©
, 
begö
, 
íd
)

408 
addr
 = 
begö
;

410 i‡(
addr
 >
íd
)

418 #ifde‡
CONFIG_DEBUG_PAGEALLOC


419 
	`¥ötk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

420 
begö
, 
	`PAGE_ALIGN
(
íd
));

421 
	`£t_mem‹y_≈
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

428 
	`£t_mem‹y_rw
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

430 
	`¥ötk
(
KERN_INFO
 "Fªeög %s: %luk fªed\n", 
wh©
, (
íd
 - 
begö
) >> 10);

432 ; 
addr
 < 
íd
;ádd∏+
PAGE_SIZE
) {

433 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
addr
));

434 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
addr
));

435 
	`mem£t
((*)(
addr
 & ~(
PAGE_SIZE
-1)),

436 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

437 
	`‰ì_∑ge
(
addr
);

438 
tŸÆøm_∑ges
++;

441 
	}
}

443 
	$‰ì_öômem
()

445 
	`‰ì_öô_∑ges
("unused kernel memory",

446 ()(&
__öô_begö
),

447 ()(&
__öô_íd
));

448 
	}
}

450 #ifde‡
CONFIG_BLK_DEV_INITRD


451 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

453 
	`‰ì_öô_∑ges
("öôrd mem‹y", 
°¨t
, 
íd
);

454 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<löux/sig«l.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/mm™.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sw≠.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/∑gem≠.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/¥oc_fs.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/p‚.h
>

27 
	~<löux/pois⁄.h
>

28 
	~<löux/dma-m≠pög.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/mem‹y_hŸ∂ug.h
>

31 
	~<löux/nmi.h
>

33 
	~<asm/¥o˚ss‹.h
>

34 
	~<asm/bios_ebda.h
>

35 
	~<asm/sy°em.h
>

36 
	~<asm/uac˚ss.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/pgÆloc.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/e820.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/éb.h
>

44 
	~<asm/mmu_c⁄ãxt.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/smp.h
>

47 
	~<asm/£˘i⁄s.h
>

48 
	~<asm/kdebug.h
>

49 
	~<asm/numa.h
>

50 
	~<asm/ˇcheÊush.h
>

51 
	~<asm/öô.h
>

53 
dma_ª£rve
 
	g__öôd©a
;

55 
__öô
 
	$∑r£_dúe˘_gb∑ges_off
(*
¨g
)

57 
dúe˘_gb∑ges
 = 0;

59 
	}
}

60 
óæy_∑øm
("nogb∑ges", 
∑r£_dúe˘_gb∑ges_off
);

62 
__öô
 
	$∑r£_dúe˘_gb∑ges_⁄
(*
¨g
)

64 
dúe˘_gb∑ges
 = 1;

66 
	}
}

67 
óæy_∑øm
("gb∑ges", 
∑r£_dúe˘_gb∑ges_⁄
);

75 
±evÆ_t
 
__suµ‹ãd_±e_mask
 
	g__ªad_mo°ly
 = ~
_PAGE_IOMAP
;

76 
EXPORT_SYMBOL_GPL
(
__suµ‹ãd_±e_mask
);

78 
	gf‹˚_≥rs⁄Æôy32
;

88 
__öô
 
	$n⁄x32_£tup
(*
°r
)

90 i‡(!
	`°rcmp
(
°r
, "on"))

91 
f‹˚_≥rs⁄Æôy32
 &~
READ_IMPLIES_EXEC
;

92 i‡(!
	`°rcmp
(
°r
, "off"))

93 
f‹˚_≥rs⁄Æôy32
 |
READ_IMPLIES_EXEC
;

95 
	}
}

96 
__£tup
("n€xec32=", 
n⁄x32_£tup
);

102 
__ªf
 *
	$•p_gë∑ge
()

104 *
±r
;

106 i‡(
a·î_boŸmem
)

107 
±r
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

109 
±r
 = 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

111 i‡(!
±r
 || ((Ìå & ~
PAGE_MASK
)) {

112 
	`∑nic
("set_pte_phys: cannotállocateÖage data %s\n",

113 
a·î_boŸmem
 ? "after bootmem" : "");

116 
	`¥_debug
("•p_gë∑gê%p\n", 
±r
);

118  
±r
;

119 
	}
}

121 
pud_t
 *
	$fûl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

123 i‡(
	`pgd_n⁄e
(*
pgd
)) {

124 
pud_t
 *
pud
 = (pud_à*)
	`•p_gë∑ge
();

125 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
pud
);

126 i‡(
pud
 !
	`pud_off£t
(
pgd
, 0))

127 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

128 
pud
, 
	`pud_off£t
(
pgd
, 0));

130  
	`pud_off£t
(
pgd
, 
vaddr
);

131 
	}
}

133 
pmd_t
 *
	$fûl_pmd
(
pud_t
 *
pud
, 
vaddr
)

135 i‡(
	`pud_n⁄e
(*
pud
)) {

136 
pmd_t
 *
pmd
 = (pmd_à*Ë
	`•p_gë∑ge
();

137 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
pmd
);

138 i‡(
pmd
 !
	`pmd_off£t
(
pud
, 0))

139 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

140 
pmd
, 
	`pmd_off£t
(
pud
, 0));

142  
	`pmd_off£t
(
pud
, 
vaddr
);

143 
	}
}

145 
±e_t
 *
	$fûl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

147 i‡(
	`pmd_n⁄e
(*
pmd
)) {

148 
±e_t
 *
±e
 = (±e_à*Ë
	`•p_gë∑ge
();

149 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
±e
);

150 i‡(
±e
 !
	`±e_off£t_kî√l
(
pmd
, 0))

151 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

153  
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

154 
	}
}

156 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_∑ge
, 
vaddr
, 
±e_t
 
√w_±e
)

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
;

160 
±e_t
 *
±e
;

162 
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
vaddr
);

163 
pmd
 = 
	`fûl_pmd
(
pud
, 
vaddr
);

164 
±e
 = 
	`fûl_±e
(
pmd
, 
vaddr
);

166 
	`£t_±e
(
±e
, 
√w_±e
);

172 
	`__Êush_éb_⁄e
(
vaddr
);

173 
	}
}

175 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±evÆ
)

177 
pgd_t
 *
pgd
;

178 
pud_t
 *
pud_∑ge
;

180 
	`¥_debug
("£t_±e_vadd∏%lxÅÿ%lx\n", 
vaddr
, 
	`«tive_±e_vÆ
(
±evÆ
));

182 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

183 i‡(
	`pgd_n⁄e
(*
pgd
)) {

184 
	`¥ötk
(
KERN_ERR


188 
pud_∑ge
 = (
pud_t
*)
	`pgd_∑ge_vaddr
(*
pgd
);

189 
	`£t_±e_vaddr_pud
(
pud_∑ge
, 
vaddr
, 
±evÆ
);

190 
	}
}

192 
pmd_t
 * 
__öô
 
	$p›uœã_exåa_pmd
(
vaddr
)

194 
pgd_t
 *
pgd
;

195 
pud_t
 *
pud
;

197 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

198 
pud
 = 
	`fûl_pud
(
pgd
, 
vaddr
);

199  
	`fûl_pmd
(
pud
, 
vaddr
);

200 
	}
}

202 
±e_t
 * 
__öô
 
	$p›uœã_exåa_±e
(
vaddr
)

204 
pmd_t
 *
pmd
;

206 
pmd
 = 
	`p›uœã_exåa_pmd
(
vaddr
);

207  
	`fûl_±e
(
pmd
, 
vaddr
);

208 
	}
}

213 
__öô
 
	$__öô_exåa_m≠pög
(
phys
, 
size
,

214 
pg¥Ÿ_t
 
¥Ÿ
)

216 
pgd_t
 *
pgd
;

217 
pud_t
 *
pud
;

218 
pmd_t
 *
pmd
;

220 
	`BUG_ON
((
phys
 & ~
PMD_MASK
Ë|| (
size
 & ~PMD_MASK));

221 ; 
size
; 
phys
 +
PMD_SIZE
, size -= PMD_SIZE) {

222 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

223 i‡(
	`pgd_n⁄e
(*
pgd
)) {

224 
pud
 = (
pud_t
 *Ë
	`•p_gë∑ge
();

225 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
 |

226 
_PAGE_USER
));

228 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

229 i‡(
	`pud_n⁄e
(*
pud
)) {

230 
pmd
 = (
pmd_t
 *Ë
	`•p_gë∑ge
();

231 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
 |

232 
_PAGE_USER
));

234 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

235 
	`BUG_ON
(!
	`pmd_n⁄e
(*
pmd
));

236 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg¥Ÿ_vÆ
(
¥Ÿ
)));

238 
	}
}

240 
__öô
 
	$öô_exåa_m≠pög_wb
(
phys
, 
size
)

242 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

243 
	}
}

245 
__öô
 
	$öô_exåa_m≠pög_uc
(
phys
, 
size
)

247 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

248 
	}
}

263 
__öô
 
	$˛ónup_highm≠
()

265 
vaddr
 = 
__START_KERNEL_m≠
;

266 
íd
 = 
	`roundup
(()
_íd
, 
PMD_SIZE
) - 1;

267 
pmd_t
 *
pmd
 = 
Àvñ2_kî√l_pgt
;

268 
pmd_t
 *
œ°_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

270 ; 
pmd
 < 
œ°_pmd
;Ömd++, 
vaddr
 +
PMD_SIZE
) {

271 i‡(
	`pmd_n⁄e
(*
pmd
))

273 i‡(
vaddr
 < (Ë
_ãxt
 || vadd∏> 
íd
)

274 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

276 
	}
}

278 
__ªf
 *
	$Æloc_low_∑ge
(*
phys
)

280 
p‚
 = 
e820_èbÀ_íd
++;

281 *
adr
;

283 i‡(
a·î_boŸmem
) {

284 
adr
 = (*)
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

285 *
phys
 = 
	`__∑
(
adr
);

287  
adr
;

290 i‡(
p‚
 >
e820_èbÀ_t›
)

291 
	`∑nic
("alloc_low_page:Ñan out of memory");

293 
adr
 = 
	`óæy_memªm≠
(
p‚
 * 
PAGE_SIZE
, PAGE_SIZE);

294 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

295 *
phys
 = 
p‚
 * 
PAGE_SIZE
;

296  
adr
;

297 
	}
}

299 
__ªf
 
	$unm≠_low_∑ge
(*
adr
)

301 i‡(
a·î_boŸmem
)

304 
	`óæy_iounm≠
(
adr
, 
PAGE_SIZE
);

305 
	}
}

307 
__memöô


308 
	$phys_±e_öô
(
±e_t
 *
±e_∑ge
, 
addr
, 
íd
,

309 
pg¥Ÿ_t
 
¥Ÿ
)

311 
∑ges
 = 0;

312 
œ°_m≠_addr
 = 
íd
;

313 
i
;

315 
±e_t
 *
±e
 = 
±e_∑ge
 + 
	`±e_ödex
(
addr
);

317 
i
 = 
	`±e_ödex
(
addr
); i < 
PTRS_PER_PTE
; i++,ádd∏+
PAGE_SIZE
, 
±e
++) {

319 i‡(
addr
 >
íd
) {

320 i‡(!
a·î_boŸmem
) {

321 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

322 
	`£t_±e
(
±e
, 
	`__±e
(0));

333 i‡(
	`±e_vÆ
(*
±e
)) {

334 
∑ges
++;

339 
	`¥ötk
("Öte=%páddr=%lxÖte=%016lx\n",

340 
±e
, 
addr
, 
	`p‚_±e
◊dd∏>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

341 
∑ges
++;

342 
	`£t_±e
(
±e
, 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
¥Ÿ
));

343 
œ°_m≠_addr
 = (
addr
 & 
PAGE_MASK
Ë+ 
PAGE_SIZE
;

346 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_4K
, 
∑ges
);

348  
œ°_m≠_addr
;

349 
	}
}

351 
__memöô


352 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
addªss
, 
íd
,

353 
pg¥Ÿ_t
 
¥Ÿ
)

355 
±e_t
 *
±e
 = (±e_à*)
	`pmd_∑ge_vaddr
(*
pmd
);

357  
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
¥Ÿ
);

358 
	}
}

360 
__memöô


361 
	$phys_pmd_öô
(
pmd_t
 *
pmd_∑ge
, 
addªss
, 
íd
,

362 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

364 
∑ges
 = 0;

365 
œ°_m≠_addr
 = 
íd
;

367 
i
 = 
	`pmd_ödex
(
addªss
);

369 ; 
i
 < 
PTRS_PER_PMD
; i++, 
addªss
 +
PMD_SIZE
) {

370 
±e_phys
;

371 
pmd_t
 *
pmd
 = 
pmd_∑ge
 + 
	`pmd_ödex
(
addªss
);

372 
±e_t
 *
±e
;

373 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
¥Ÿ
;

375 i‡(
addªss
 >
íd
) {

376 i‡(!
a·î_boŸmem
) {

377 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

378 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

383 i‡(
	`pmd_vÆ
(*
pmd
)) {

384 i‡(!
	`pmd_œrge
(*
pmd
)) {

385 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

386 
œ°_m≠_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
addªss
,

387 
íd
, 
¥Ÿ
);

388 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

403 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

404 
∑ges
++;

407 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pmd
));

410 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

411 
∑ges
++;

412 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

413 
	`£t_±e
((
±e_t
 *)
pmd
,

414 
	`p‚_±e
(
addªss
 >> 
PAGE_SHIFT
,

415 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_PSE
)));

416 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

417 
œ°_m≠_addr
 = (
addªss
 & 
PMD_MASK
Ë+ 
PMD_SIZE
;

421 
±e
 = 
	`Æloc_low_∑ge
(&
±e_phys
);

422 
œ°_m≠_addr
 = 
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
√w_¥Ÿ
);

423 
	`unm≠_low_∑ge
(
±e
);

425 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

426 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
	`__va
(
±e_phys
));

427 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

429 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_2M
, 
∑ges
);

430  
œ°_m≠_addr
;

431 
	}
}

433 
__memöô


434 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
addªss
, 
íd
,

435 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

437 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

438 
œ°_m≠_addr
;

440 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addªss
, 
íd
, 
∑ge_size_mask
, 
¥Ÿ
);

441 
	`__Êush_éb_Æl
();

442  
œ°_m≠_addr
;

443 
	}
}

445 
__memöô


446 
	$phys_pud_öô
(
pud_t
 *
pud_∑ge
, 
addr
, 
íd
,

447 
∑ge_size_mask
)

449 
∑ges
 = 0;

450 
œ°_m≠_addr
 = 
íd
;

451 
i
 = 
	`pud_ödex
(
addr
);

453 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add∏& 
PUD_MASK
Ë+ 
PUD_SIZE
) {

454 
pmd_phys
;

455 
pud_t
 *
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
addr
);

456 
pmd_t
 *
pmd
;

457 
pg¥Ÿ_t
 
¥Ÿ
 = 
PAGE_KERNEL
;

459 i‡(
addr
 >
íd
)

462 i‡(!
a·î_boŸmem
 &&

463 !
	`e820_™y_m≠≥d
(
addr
,áddr+
PUD_SIZE
, 0)) {

464 
	`£t_pud
(
pud
, 
	`__pud
(0));

468 i‡(
	`pud_vÆ
(*
pud
)) {

469 i‡(!
	`pud_œrge
(*
pud
)) {

470 
œ°_m≠_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
íd
,

471 
∑ge_size_mask
, 
¥Ÿ
);

486 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

487 
∑ges
++;

490 
¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pud
));

493 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

494 
∑ges
++;

495 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

496 
	`£t_±e
((
±e_t
 *)
pud
,

497 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

498 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

499 
œ°_m≠_addr
 = (
addr
 & 
PUD_MASK
Ë+ 
PUD_SIZE
;

503 
pmd
 = 
	`Æloc_low_∑ge
(&
pmd_phys
);

504 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addr
, 
íd
, 
∑ge_size_mask
,

505 
¥Ÿ
);

506 
	`unm≠_low_∑ge
(
pmd
);

508 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

509 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
	`__va
(
pmd_phys
));

510 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

512 
	`__Êush_éb_Æl
();

514 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_1G
, 
∑ges
);

516  
œ°_m≠_addr
;

517 
	}
}

519 
__memöô


520 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
íd
,

521 
∑ge_size_mask
)

523 
pud_t
 *
pud
;

525 
pud
 = (
pud_t
 *)
	`pgd_∑ge_vaddr
(*
pgd
);

527  
	`phys_pud_öô
(
pud
, 
addr
, 
íd
, 
∑ge_size_mask
);

528 
	}
}

530 
__memöô


531 
	$kî√l_physiˇl_m≠pög_öô
(
°¨t
,

532 
íd
,

533 
∑ge_size_mask
)

536 
√xt
, 
œ°_m≠_addr
 = 
íd
;

538 
°¨t
 = ()
	`__va
(start);

539 
íd
 = ()
	`__va
(end);

541 ; 
°¨t
 < 
íd
; sèπ = 
√xt
) {

542 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
°¨t
);

543 
pud_phys
;

544 
pud_t
 *
pud
;

546 
√xt
 = (
°¨t
 + 
PGDIR_SIZE
Ë& 
PGDIR_MASK
;

547 i‡(
√xt
 > 
íd
)

548 
√xt
 = 
íd
;

550 i‡(
	`pgd_vÆ
(*
pgd
)) {

551 
œ°_m≠_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__∑
(
°¨t
),

552 
	`__∑
(
íd
), 
∑ge_size_mask
);

556 
pud
 = 
	`Æloc_low_∑ge
(&
pud_phys
);

557 
œ°_m≠_addr
 = 
	`phys_pud_öô
(
pud
, 
	`__∑
(
°¨t
), __∑(
√xt
),

558 
∑ge_size_mask
);

559 
	`unm≠_low_∑ge
(
pud
);

561 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

562 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
	`__va
(
pud_phys
));

563 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

565 
	`__Êush_éb_Æl
();

567  
œ°_m≠_addr
;

568 
	}
}

570 #i‚de‡
CONFIG_NUMA


571 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
íd_p‚
)

573 
boŸm≠_size
, 
boŸm≠
;

575 
boŸm≠_size
 = 
	`boŸmem_boŸm≠_∑ges
(
íd_p‚
)<<
PAGE_SHIFT
;

576 
boŸm≠
 = 
	`föd_e820_¨ó
(0, 
íd_p‚
<<
PAGE_SHIFT
, 
boŸm≠_size
,

577 
PAGE_SIZE
);

578 i‡(
boŸm≠
 == -1L)

579 
	`∑nic
("C™nŸ föd boŸmem m≠ o‡sizê%ld\n", 
boŸm≠_size
);

581 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(0), 
boŸm≠
 >> 
PAGE_SHIFT
,

582 0, 
íd_p‚
);

583 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

584 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(0, 
íd_p‚
);

585 
	`óæy_ªs_to_boŸmem
(0, 
íd_p‚
<<
PAGE_SHIFT
);

586 
	`ª£rve_boŸmem
(
boŸm≠
, 
boŸm≠_size
, 
BOOTMEM_DEFAULT
);

587 
	}
}

590 
__öô
 
	$∑gög_öô
()

592 
max_z⁄e_p‚s
[
MAX_NR_ZONES
];

594 
	`mem£t
(
max_z⁄e_p‚s
, 0, (max_zone_pfns));

595 
max_z⁄e_p‚s
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

596 
max_z⁄e_p‚s
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

597 
max_z⁄e_p‚s
[
ZONE_NORMAL
] = 
max_p‚
;

599 
	`•¨£_mem‹y_¥e£¡_wôh_a˘ive_ªgi⁄s
(
MAX_NUMNODES
);

600 
	`•¨£_öô
();

608 
	`node_˛ór_°©e
(0, 
N_NORMAL_MEMORY
);

610 
	`‰ì_¨ó_öô_nodes
(
max_z⁄e_p‚s
);

611 
	}
}

616 #ifde‡
CONFIG_MEMORY_HOTPLUG


621 
	$¨ch_add_mem‹y
(
nid
, 
u64
 
°¨t
, u64 
size
)

623 
pgli°_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

624 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
ZONE_NORMAL
;

625 
œ°_m≠≥d_p‚
, 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

626 
ƒ_∑ges
 = 
size
 >> 
PAGE_SHIFT
;

627 
ªt
;

629 
œ°_m≠≥d_p‚
 = 
	`öô_mem‹y_m≠pög
(
°¨t
, sèπ + 
size
);

630 i‡(
œ°_m≠≥d_p‚
 > 
max_p‚_m≠≥d
)

631 
max_p‚_m≠≥d
 = 
œ°_m≠≥d_p‚
;

633 
ªt
 = 
	`__add_∑ges
(
nid
, 
z⁄e
, 
°¨t_p‚
, 
ƒ_∑ges
);

634 
	`WARN_ON_ONCE
(
ªt
);

636  
ªt
;

637 
	}
}

638 
EXPORT_SYMBOL_GPL
(
¨ch_add_mem‹y
);

640 #i‡!
deföed
(
CONFIG_ACPI_NUMA
Ë&& deföed(
CONFIG_NUMA
)

641 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

644 
	}
}

645 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

650 
kc‹e_li°
 
	gkc‹e_mem
, 
	gkc‹e_vmÆloc
, 
	gkc‹e_kî√l
,

651 
	gkc‹e_moduÀs
, 
	gkc‹e_vsysˇŒ
;

653 
__öô
 
	$mem_öô
()

655 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
;

656 
ab£¡_∑ges
;

658 
	`pci_iommu_Æloc
();

662 
ª£rved∑ges
 = 0;

665 #ifde‡
CONFIG_NUMA


666 
tŸÆøm_∑ges
 = 
	`numa_‰ì_Æl_boŸmem
();

668 
tŸÆøm_∑ges
 = 
	`‰ì_Æl_boŸmem
();

671 
ab£¡_∑ges
 = 
	`ab£¡_∑ges_ö_ønge
(0, 
max_p‚
);

672 
ª£rved∑ges
 = 
max_p‚
 - 
tŸÆøm_∑ges
 - 
ab£¡_∑ges
;

673 
a·î_boŸmem
 = 1;

675 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

676 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_ëext
;

677 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

680 
	`k˛i°_add
(&
kc‹e_mem
, 
	`__va
(0), 
max_low_p‚
 << 
PAGE_SHIFT
);

681 
	`k˛i°_add
(&
kc‹e_vmÆloc
, (*)
VMALLOC_START
,

682 
VMALLOC_END
-
VMALLOC_START
);

683 
	`k˛i°_add
(&
kc‹e_kî√l
, &
_°ext
, 
_íd
 - _stext);

684 
	`k˛i°_add
(&
kc‹e_moduÀs
, (*)
MODULES_VADDR
, 
MODULES_LEN
);

685 
	`k˛i°_add
(&
kc‹e_vsysˇŒ
, (*)
VSYSCALL_START
,

686 
VSYSCALL_END
 - 
VSYSCALL_START
);

688 
	`¥ötk
(
KERN_INFO
 "Memory: %luk/%lukávailable (%ldk kernel code, "

690 (Ë
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

691 
max_p‚
 << (
PAGE_SHIFT
-10),

692 
codesize
 >> 10,

693 
ab£¡_∑ges
 << (
PAGE_SHIFT
-10),

694 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

695 
d©asize
 >> 10,

696 
öôsize
 >> 10);

697 
	}
}

699 #ifde‡
CONFIG_DEBUG_RODATA


700 c⁄° 
	grod©a_ã°_d©a
 = 0xC3;

701 
EXPORT_SYMBOL_GPL
(
rod©a_ã°_d©a
);

703 
	gkî√l_£t_to_ªad⁄ly
;

705 
	$£t_kî√l_ãxt_rw
()

707 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
);

708 
íd
 = 
	`PFN_ALIGN
(
__°¨t_rod©a
);

710 i‡(!
kî√l_£t_to_ªad⁄ly
)

713 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead write\n",

714 
°¨t
, 
íd
);

716 
	`£t_mem‹y_rw
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

717 
	}
}

719 
	$£t_kî√l_ãxt_ro
()

721 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
);

722 
íd
 = 
	`PFN_ALIGN
(
__°¨t_rod©a
);

724 i‡(!
kî√l_£t_to_ªad⁄ly
)

727 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead only\n",

728 
°¨t
, 
íd
);

730 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

731 
	}
}

733 
	$m¨k_rod©a_ro
()

735 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
), 
íd
 = PFN_ALIGN(
__íd_rod©a
);

736 
rod©a_°¨t
 =

737 (()
__°¨t_rod©a
 + 
PAGE_SIZE
 - 1Ë& 
PAGE_MASK
;

739 
	`¥ötk
(
KERN_INFO
 "WriteÖrotectingÅhe kernelÑead-only data: %luk\n",

740 (
íd
 - 
°¨t
) >> 10);

741 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

743 
kî√l_£t_to_ªad⁄ly
 = 1;

749 
	`£t_mem‹y_nx
(
rod©a_°¨t
, (
íd
 -Ñod©a_°¨tË>> 
PAGE_SHIFT
);

751 
	`rod©a_ã°
();

753 #ifde‡
CONFIG_CPA_DEBUG


754 
	`¥ötk
(
KERN_INFO
 "Te°ög CPA: undÿ%lx-%lx\n", 
°¨t
, 
íd
);

755 
	`£t_mem‹y_rw
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

757 
	`¥ötk
(
KERN_INFO
 "Testing CPA:ágain\n");

758 
	`£t_mem‹y_ro
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

760 
	}
}

764 
__öô
 
	$ª£rve_boŸmem_gíîic
(
phys
, 
Àn
,

765 
Êags
)

767 #ifde‡
CONFIG_NUMA


768 
nid
, 
√xt_nid
;

769 
ªt
;

771 
p‚
 = 
phys
 >> 
PAGE_SHIFT
;

773 i‡(
p‚
 >
max_p‚
) {

778 i‡(
p‚
 < 
max_p‚_m≠≥d
)

779  -
EFAULT
;

781 
	`¥ötk
(
KERN_ERR
 "reserve_bootmem: illegalÑeserve %lx %lu\n",

782 
phys
, 
Àn
);

783  -
EFAULT
;

787 #ifde‡
CONFIG_NUMA


788 
nid
 = 
	`phys_to_nid
(
phys
);

789 
√xt_nid
 = 
	`phys_to_nid
(
phys
 + 
Àn
 - 1);

790 i‡(
nid
 =
√xt_nid
)

791 
ªt
 = 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Àn
, 
Êags
);

793 
ªt
 = 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

795 i‡(
ªt
 != 0)

796  
ªt
;

799 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

802 i‡(
phys
+
Àn
 <
MAX_DMA_PFN
*
PAGE_SIZE
) {

803 
dma_ª£rve
 +
Àn
 / 
PAGE_SIZE
;

804 
	`£t_dma_ª£rve
(
dma_ª£rve
);

808 
	}
}

810 
	$kîn_addr_vÆid
(
addr
)

812 
above
 = (()
addr
Ë>> 
__VIRTUAL_MASK_SHIFT
;

813 
pgd_t
 *
pgd
;

814 
pud_t
 *
pud
;

815 
pmd_t
 *
pmd
;

816 
±e_t
 *
±e
;

818 i‡(
above
 != 0 &&ábove != -1UL)

821 
pgd
 = 
	`pgd_off£t_k
(
addr
);

822 i‡(
	`pgd_n⁄e
(*
pgd
))

825 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

826 i‡(
	`pud_n⁄e
(*
pud
))

829 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

830 i‡(
	`pmd_n⁄e
(*
pmd
))

833 i‡(
	`pmd_œrge
(*
pmd
))

834  
	`p‚_vÆid
(
	`pmd_p‚
(*
pmd
));

836 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addr
);

837 i‡(
	`±e_n⁄e
(*
±e
))

840  
	`p‚_vÆid
(
	`±e_p‚
(*
±e
));

841 
	}
}

848 
vm_¨ó_°ru˘
 
	gg©e_vma
 = {

849 .
vm_°¨t
 = 
VSYSCALL_START
,

850 .
	gvm_íd
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

851 .
	gvm_∑ge_¥Ÿ
 = 
PAGE_READONLY_EXEC
,

852 .
	gvm_Êags
 = 
VM_READ
 | 
VM_EXEC


855 
vm_¨ó_°ru˘
 *
	$gë_g©e_vma
(
èsk_°ru˘
 *
tsk
)

857 #ifde‡
CONFIG_IA32_EMULATION


858 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
))

859  
NULL
;

861  &
g©e_vma
;

862 
	}
}

864 
	$ö_g©e_¨ó
(
èsk_°ru˘
 *
èsk
, 
addr
)

866 
vm_¨ó_°ru˘
 *
vma
 = 
	`gë_g©e_vma
(
èsk
);

868 i‡(!
vma
)

871  (
addr
 >
vma
->
vm_°¨t
Ë&& (add∏< vma->
vm_íd
);

872 
	}
}

879 
	$ö_g©e_¨ó_no_èsk
(
addr
)

881  (
addr
 >
VSYSCALL_START
Ë&& (add∏< 
VSYSCALL_END
);

882 
	}
}

884 c⁄° *
	$¨ch_vma_«me
(
vm_¨ó_°ru˘
 *
vma
)

886 i‡(
vma
->
vm_mm
 && vma->
vm_°¨t
 =()vma->vm_mm->
c⁄ãxt
.
vdso
)

888 i‡(
vma
 =&
g©e_vma
)

890  
NULL
;

891 
	}
}

893 #ifde‡
CONFIG_SPARSEMEM_VMEMMAP


897 
__memöôd©a
 
	gaddr_°¨t
, 
	gaddr_íd
;

898 
__memöôd©a
 *
	gp_°¨t
, *
	gp_íd
;

899 
__memöôd©a
 
	gnode_°¨t
;

901 
__memöô


902 
	$vmemm≠_p›uœã
(
∑ge
 *
°¨t_∑ge
, 
size
, 
node
)

904 
addr
 = ()
°¨t_∑ge
;

905 
íd
 = ()(
°¨t_∑ge
 + 
size
);

906 
√xt
;

907 
pgd_t
 *
pgd
;

908 
pud_t
 *
pud
;

909 
pmd_t
 *
pmd
;

911 ; 
addr
 < 
íd
;ádd∏
√xt
) {

912 *
p
 = 
NULL
;

914 
pgd
 = 
	`vmemm≠_pgd_p›uœã
(
addr
, 
node
);

915 i‡(!
pgd
)

916  -
ENOMEM
;

918 
pud
 = 
	`vmemm≠_pud_p›uœã
(
pgd
, 
addr
, 
node
);

919 i‡(!
pud
)

920  -
ENOMEM
;

922 i‡(!
˝u_has_p£
) {

923 
√xt
 = (
addr
 + 
PAGE_SIZE
Ë& 
PAGE_MASK
;

924 
pmd
 = 
	`vmemm≠_pmd_p›uœã
(
pud
, 
addr
, 
node
);

926 i‡(!
pmd
)

927  -
ENOMEM
;

929 
p
 = 
	`vmemm≠_±e_p›uœã
(
pmd
, 
addr
, 
node
);

931 i‡(!
p
)

932  -
ENOMEM
;

934 
addr_íd
 = 
addr
 + 
PAGE_SIZE
;

935 
p_íd
 = 
p
 + 
PAGE_SIZE
;

937 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

939 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

940 i‡(
	`pmd_n⁄e
(*
pmd
)) {

941 
±e_t
 
íåy
;

943 
p
 = 
	`vmemm≠_Æloc_block
(
PMD_SIZE
, 
node
);

944 i‡(!
p
)

945  -
ENOMEM
;

947 
íåy
 = 
	`p‚_±e
(
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

948 
PAGE_KERNEL_LARGE
);

949 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_vÆ
(
íåy
)));

952 i‡(
p_íd
 !
p
 || 
node_°¨t
 !
node
) {

953 i‡(
p_°¨t
)

954 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

955 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

956 
addr_°¨t
 = 
addr
;

957 
node_°¨t
 = 
node
;

958 
p_°¨t
 = 
p
;

961 
addr_íd
 = 
addr
 + 
PMD_SIZE
;

962 
p_íd
 = 
p
 + 
PMD_SIZE
;

964 
	`vmemm≠_vîify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
√xt
);

969 
	}
}

971 
__memöô
 
	$vmemm≠_p›uœã_¥öt_œ°
()

973 i‡(
p_°¨t
) {

974 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

975 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

976 
p_°¨t
 = 
NULL
;

977 
p_íd
 = 
NULL
;

978 
node_°¨t
 = 0;

980 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<löux/boŸmem.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/io.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/mmiŸø˚.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm≠.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/∑t.h
>

25 
ölöe
 
	$phys_addr_vÆid
(
ªsour˚_size_t
 
addr
)

27 #ifde‡
CONFIG_PHYS_ADDR_T_64BIT


28  !(
addr
 >> 
boŸ_˝u_d©a
.
x86_phys_bôs
);

32 
	}
}

34 #ifde‡
CONFIG_X86_64


36 
	$__phys_addr
(
x
)

38 i‡(
x
 >
__START_KERNEL_m≠
) {

39 
x
 -
__START_KERNEL_m≠
;

40 
	`VIRTUAL_BUG_ON
(
x
 >
KERNEL_IMAGE_SIZE
);

41 
x
 +
phys_ba£
;

43 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

44 
x
 -
PAGE_OFFSET
;

45 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_vÆid
(
x
));

47  
x
;

48 
	}
}

49 
EXPORT_SYMBOL
(
__phys_addr
);

51 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

53 i‡(
x
 >
__START_KERNEL_m≠
) {

54 
x
 -
__START_KERNEL_m≠
;

55 i‡(
x
 >
KERNEL_IMAGE_SIZE
)

56  
Ál£
;

57 
x
 +
phys_ba£
;

59 i‡(
x
 < 
PAGE_OFFSET
)

60  
Ál£
;

61 
x
 -
PAGE_OFFSET
;

62 i‡(!
	`phys_addr_vÆid
(
x
))

63  
Ál£
;

66  
	`p‚_vÆid
(
x
 >> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

72 #ifde‡
CONFIG_DEBUG_VIRTUAL


73 
	$__phys_addr
(
x
)

76 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

77 
	`VIRTUAL_BUG_ON
(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
));

78  
x
 - 
PAGE_OFFSET
;

79 
	}
}

80 
EXPORT_SYMBOL
(
__phys_addr
);

83 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

85 i‡(
x
 < 
PAGE_OFFSET
)

86  
Ál£
;

87 i‡(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
))

88  
Ál£
;

89 i‡(
x
 >
FIXADDR_START
)

90  
Ál£
;

91  
	`p‚_vÆid
((
x
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
);

92 
	}
}

93 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

97 
	$∑ge_is_øm
(
∑gír
)

99 
ªsour˚_size_t
 
addr
, 
íd
;

100 
i
;

107 i‡(
∑gír
 == 0)

114 i‡(
∑gír
 >(
BIOS_BEGIN
 >> 
PAGE_SHIFT
) &&

115 
∑gír
 < (
BIOS_END
 >> 
PAGE_SHIFT
))

118 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

122 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RAM
)

124 
addr
 = (
e820
.
m≠
[
i
].add∏+ 
PAGE_SIZE
-1Ë>> 
PAGE_SHIFT
;

125 
íd
 = (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
Ë>> 
PAGE_SHIFT
;

128 i‡((
∑gír
 >
addr
Ë&& (∑gí∏< 
íd
))

132 
	}
}

138 
	$i‹em≠_ch™ge_©å
(
vaddr
, 
size
,

139 
¥Ÿ_vÆ
)

141 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

142 
îr
;

144 
¥Ÿ_vÆ
) {

145 
_PAGE_CACHE_UC
:

147 
îr
 = 
	`_£t_mem‹y_uc
(
vaddr
, 
ƒ∑ges
);

149 
_PAGE_CACHE_WC
:

150 
îr
 = 
	`_£t_mem‹y_wc
(
vaddr
, 
ƒ∑ges
);

152 
_PAGE_CACHE_WB
:

153 
îr
 = 
	`_£t_mem‹y_wb
(
vaddr
, 
ƒ∑ges
);

157  
îr
;

158 
	}
}

169 
__iomem
 *
	$__i‹em≠_ˇŒî
(
ªsour˚_size_t
 
phys_addr
,

170 
size
, 
¥Ÿ_vÆ
, *
ˇŒî
)

172 
p‚
, 
off£t
, 
vaddr
;

173 
ªsour˚_size_t
 
œ°_addr
;

174 c⁄° 
ªsour˚_size_t
 
u«lig√d_phys_addr
 = 
phys_addr
;

175 c⁄° 
u«lig√d_size
 = 
size
;

176 
vm_°ru˘
 *
¨ó
;

177 
√w_¥Ÿ_vÆ
;

178 
pg¥Ÿ_t
 
¥Ÿ
;

179 
ªtvÆ
;

180 
__iomem
 *
ªt_addr
;

183 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

184 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
)

185  
NULL
;

187 i‡(!
	`phys_addr_vÆid
(
phys_addr
)) {

188 
	`¥ötk
(
KERN_WARNING
 "ioremap: invalidÖhysicaláddress %llx\n",

189 ()
phys_addr
);

190 
	`WARN_ON_ONCE
(1);

191  
NULL
;

197 i‡(
	`is_ISA_ønge
(
phys_addr
, 
œ°_addr
))

198  (
__f‹˚
 
__iomem
 *)
	`phys_to_vút
(
phys_addr
);

204 
	`WARN_ONCE
(
	`iomem_m≠_ßnôy_check
(
phys_addr
, 
size
),

205 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

210 
p‚
 = 
phys_addr
 >> 
PAGE_SHIFT
;

211 (
p‚
 << 
PAGE_SHIFT
Ë< (
œ°_addr
 & 
PAGE_MASK
);

212 
p‚
++) {

214 
is_øm
 = 
	`∑ge_is_øm
(
p‚
);

216 i‡(
is_øm
 && 
	`p‚_vÆid
(
p‚
Ë&& !
	`PageRe£rved
(
	`p‚_to_∑ge
(pfn)))

217  
NULL
;

218 
	`WARN_ON_ONCE
(
is_øm
);

224 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

225 
phys_addr
 &
PAGE_MASK
;

226 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
+1Ë- 
phys_addr
;

228 
ªtvÆ
 = 
	`ª£rve_memty≥
(
phys_addr
, (
u64
Ìhys_add∏+ 
size
,

229 
¥Ÿ_vÆ
, &
√w_¥Ÿ_vÆ
);

230 i‡(
ªtvÆ
) {

231 
	`¥_debug
("W¨nög:Ñe£rve_memty≥Ñëu∫ed %d\n", 
ªtvÆ
);

232  
NULL
;

235 i‡(
¥Ÿ_vÆ
 !
√w_¥Ÿ_vÆ
) {

243 i‡((
¥Ÿ_vÆ
 =
_PAGE_CACHE_UC_MINUS
 &&

244 (
√w_¥Ÿ_vÆ
 =
_PAGE_CACHE_WB
 ||

245 
√w_¥Ÿ_vÆ
 =
_PAGE_CACHE_WC
)) ||

246 (
¥Ÿ_vÆ
 =
_PAGE_CACHE_WC
 &&

247 
√w_¥Ÿ_vÆ
 =
_PAGE_CACHE_WB
)) {

248 
	`¥_debug
(

250 ()
phys_addr
,

251 ()(
phys_addr
 + 
size
),

252 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
);

253 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

254  
NULL
;

256 
¥Ÿ_vÆ
 = 
√w_¥Ÿ_vÆ
;

259 
¥Ÿ_vÆ
) {

260 
_PAGE_CACHE_UC
:

262 
¥Ÿ
 = 
PAGE_KERNEL_IO_NOCACHE
;

264 
_PAGE_CACHE_UC_MINUS
:

265 
¥Ÿ
 = 
PAGE_KERNEL_IO_UC_MINUS
;

267 
_PAGE_CACHE_WC
:

268 
¥Ÿ
 = 
PAGE_KERNEL_IO_WC
;

270 
_PAGE_CACHE_WB
:

271 
¥Ÿ
 = 
PAGE_KERNEL_IO
;

278 
¨ó
 = 
	`gë_vm_¨ó_ˇŒî
(
size
, 
VM_IOREMAP
, 
ˇŒî
);

279 i‡(!
¨ó
)

280  
NULL
;

281 
¨ó
->
phys_addr
 =Öhys_addr;

282 
vaddr
 = (Ë
¨ó
->
addr
;

284 i‡(
	`kî√l_m≠_sync_memty≥
(
phys_addr
, 
size
, 
¥Ÿ_vÆ
)) {

285 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

286 
	`‰ì_vm_¨ó
(
¨ó
);

287  
NULL
;

290 i‡(
	`i‹em≠_∑ge_ønge
(
vaddr
, vadd∏+ 
size
, 
phys_addr
, 
¥Ÿ
)) {

291 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

292 
	`‰ì_vm_¨ó
(
¨ó
);

293  
NULL
;

296 
ªt_addr
 = (
__iomem
 *Ë(
vaddr
 + 
off£t
);

297 
	`mmiŸø˚_i‹em≠
(
u«lig√d_phys_addr
, 
u«lig√d_size
, 
ªt_addr
);

299  
ªt_addr
;

300 
	}
}

323 
__iomem
 *
	$i‹em≠_noˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

332 
vÆ
 = 
_PAGE_CACHE_UC_MINUS
;

334  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
vÆ
,

335 
	`__buûtö_ªtu∫_addªss
(0));

336 
	}
}

337 
EXPORT_SYMBOL
(
i‹em≠_noˇche
);

349 
__iomem
 *
	$i‹em≠_wc
(
ªsour˚_size_t
 
phys_addr
, 
size
)

351 i‡(
∑t_íabÀd
)

352  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

353 
	`__buûtö_ªtu∫_addªss
(0));

355  
	`i‹em≠_noˇche
(
phys_addr
, 
size
);

356 
	}
}

357 
EXPORT_SYMBOL
(
i‹em≠_wc
);

359 
__iomem
 *
	$i‹em≠_ˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

361  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

362 
	`__buûtö_ªtu∫_addªss
(0));

363 
	}
}

364 
EXPORT_SYMBOL
(
i‹em≠_ˇche
);

366 
__iomem
 *
	$i‹em≠_deÁu…
(
ªsour˚_size_t
 
phys_addr
,

367 
size
)

369 
Êags
;

370 
__iomem
 *
ªt
;

371 
îr
;

378 
îr
 = 
	`ª£rve_memty≥
(
phys_addr
,Öhys_add∏+ 
size
,

379 
_PAGE_CACHE_WB
, &
Êags
);

380 i‡(
îr
 < 0)

381  
NULL
;

383 
ªt
 = 
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
Êags
,

384 
	`__buûtö_ªtu∫_addªss
(0));

386 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

387  
ªt
;

388 
	}
}

390 
__iomem
 *
	$i‹em≠_¥Ÿ
(
ªsour˚_size_t
 
phys_addr
, 
size
,

391 
¥Ÿ_vÆ
)

393  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, (
¥Ÿ_vÆ
 & 
_PAGE_CACHE_MASK
),

394 
	`__buûtö_ªtu∫_addªss
(0));

395 
	}
}

396 
EXPORT_SYMBOL
(
i‹em≠_¥Ÿ
);

404 
	$iounm≠
(vﬁ©ûê
__iomem
 *
addr
)

406 
vm_°ru˘
 *
p
, *
o
;

408 i‡((
__f‹˚
 *)
addr
 <
high_mem‹y
)

416 i‡((
__f‹˚
 *)
addr
 >
	`phys_to_vút
(
ISA_START_ADDRESS
) &&

417 (
__f‹˚
 *)
addr
 < 
	`phys_to_vút
(
ISA_END_ADDRESS
))

420 
addr
 = (vﬁ©ûê
__iomem
 *)

421 (
PAGE_MASK
 & (
__f‹˚
)
addr
);

423 
	`mmiŸø˚_iounm≠
(
addr
);

430 
	`ªad_lock
(&
vmli°_lock
);

431 
p
 = 
vmli°
;Ö;Ö =Ö->
√xt
) {

432 i‡(
p
->
addr
 =(
__f‹˚
 *)addr)

435 
	`ªad_u∆ock
(&
vmli°_lock
);

437 i‡(!
p
) {

438 
	`¥ötk
(
KERN_ERR
 "iounm≠: badáddªs†%p\n", 
addr
);

439 
	`dump_°ack
();

443 
	`‰ì_memty≥
(
p
->
phys_addr
,Ö->phys_add∏+ 
	`gë_vm_¨ó_size
(p));

446 
o
 = 
	`ªmove_vm_¨ó
((
__f‹˚
 *)
addr
);

447 
	`BUG_ON
(
p
 !
o
 || o =
NULL
);

448 
	`k‰ì
(
p
);

449 
	}
}

450 
EXPORT_SYMBOL
(
iounm≠
);

456 *
	$xœã_dev_mem_±r
(
phys
)

458 *
addr
;

459 
°¨t
 = 
phys
 & 
PAGE_MASK
;

462 i‡(
	`∑ge_is_øm
(
°¨t
 >> 
PAGE_SHIFT
))

463  
	`__va
(
phys
);

465 
addr
 = (
__f‹˚
 *)
	`i‹em≠_deÁu…
(
°¨t
, 
PAGE_SIZE
);

466 i‡(
addr
)

467 
addr
 = (*)((Ôdd∏| (
phys
 & ~
PAGE_MASK
));

469  
addr
;

470 
	}
}

472 
	$unxœã_dev_mem_±r
(
phys
, *
addr
)

474 i‡(
	`∑ge_is_øm
(
phys
 >> 
PAGE_SHIFT
))

477 
	`iounm≠
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

479 
	}
}

481 
__öôd©a
 
	góæy_i‹em≠_debug
;

483 
__öô
 
	$óæy_i‹em≠_debug_£tup
(*
°r
)

485 
óæy_i‹em≠_debug
 = 1;

488 
	}
}

489 
óæy_∑øm
("óæy_i‹em≠_debug", 
óæy_i‹em≠_debug_£tup
);

491 
__öôd©a
 
	ga·î_∑gög_öô
;

492 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/’ã_t)] 
	g__∑ge_Æig√d_bss
;

494 
ölöe
 
pmd_t
 * 
__öô
 
	$óæy_i‹em≠_pmd
(
addr
)

497 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

498 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addr
)];

499 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

500 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

502  
pmd
;

503 
	}
}

505 
ölöe
 
±e_t
 * 
__öô
 
	$óæy_i‹em≠_±e
(
addr
)

507  &
bm_±e
[
	`±e_ödex
(
addr
)];

508 
	}
}

510 
	g¶Ÿ_vút
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

512 
__öô
 
	$óæy_i‹em≠_öô
()

514 
pmd_t
 *
pmd
;

515 
i
;

517 i‡(
óæy_i‹em≠_debug
)

518 
	`¥ötk
(
KERN_INFO
 "early_ioremap_init()\n");

520 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

521 
¶Ÿ_vút
[
i
] = 
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

523 
pmd
 = 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

524 
	`mem£t
(
bm_±e
, 0, (bm_pte));

525 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
bm_±e
);

531 i‡(
pmd
 !
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
))) {

532 
	`WARN_ON
(1);

533 
	`¥ötk
(
KERN_WARNING
 "pmd %p != %p\n",

534 
pmd
, 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
)));

535 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

536 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

537 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

538 
	`fix_to_vút
(
FIX_BTMAP_END
));

540 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

541 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

542 
FIX_BTMAP_BEGIN
);

544 
	}
}

546 
__öô
 
	$óæy_i‹em≠_ª£t
()

548 
a·î_∑gög_öô
 = 1;

549 
	}
}

551 
__öô
 
	$__óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

552 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
Êags
)

554 
addr
 = 
	`__fix_to_vút
(
idx
);

555 
±e_t
 *
±e
;

557 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

558 
	`BUG
();

561 
±e
 = 
	`óæy_i‹em≠_±e
(
addr
);

563 i‡(
	`pg¥Ÿ_vÆ
(
Êags
))

564 
	`£t_±e
(
±e
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

566 
	`±e_˛ór
(&
öô_mm
, 
addr
, 
±e
);

567 
	`__Êush_éb_⁄e
(
addr
);

568 
	}
}

570 
ölöe
 
__öô
 
	$óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

571 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
¥Ÿ
)

573 i‡(
a·î_∑gög_öô
)

574 
	`__£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

576 
	`__óæy_£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

577 
	}
}

579 
ölöe
 
__öô
 
	$óæy_˛ór_fixm≠
(
fixed_addªs£s
 
idx
)

581 i‡(
a·î_∑gög_öô
)

582 
	`˛ór_fixm≠
(
idx
);

584 
	`__óæy_£t_fixm≠
(
idx
, 0, 
	`__pg¥Ÿ
(0));

585 
	}
}

587 
__iomem
 *
	g¥ev_m≠
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

588 
	g¥ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

590 
__öô
 
	$check_óæy_i‹em≠_Àak
()

592 
cou¡
 = 0;

593 
i
;

595 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

596 i‡(
¥ev_m≠
[
i
])

597 
cou¡
++;

599 i‡(!
cou¡
)

601 
	`WARN
(1, 
KERN_WARNING


603 
cou¡
);

604 
	`¥ötk
(
KERN_WARNING


608 
	}
}

609 
œã_öôˇŒ
(
check_óæy_i‹em≠_Àak
);

611 
__öô
 
__iomem
 *

612 
	$__óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
, 
pg¥Ÿ_t
 
¥Ÿ
)

614 
off£t
;

615 
ªsour˚_size_t
 
œ°_addr
;

616 
ƒ∑ges
;

617 
fixed_addªs£s
 
idx0
, 
idx
;

618 
i
, 
¶Ÿ
;

620 
	`WARN_ON
(
sy°em_°©e
 !
SYSTEM_BOOTING
);

622 
¶Ÿ
 = -1;

623 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

624 i‡(!
¥ev_m≠
[
i
]) {

625 
¶Ÿ
 = 
i
;

630 i‡(
¶Ÿ
 < 0) {

631 
	`¥ötk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)Çot found slot\n",

632 (
u64
)
phys_addr
, 
size
);

633 
	`WARN_ON
(1);

634  
NULL
;

637 i‡(
óæy_i‹em≠_debug
) {

638 
	`¥ötk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

639 (
u64
)
phys_addr
, 
size
, 
¶Ÿ
);

640 
	`dump_°ack
();

644 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

645 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
) {

646 
	`WARN_ON
(1);

647  
NULL
;

650 
¥ev_size
[
¶Ÿ
] = 
size
;

654 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

655 
phys_addr
 &
PAGE_MASK
;

656 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
 + 1Ë- 
phys_addr
;

661 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

662 i‡(
ƒ∑ges
 > 
NR_FIX_BTMAPS
) {

663 
	`WARN_ON
(1);

664  
NULL
;

670 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

671 
idx
 = 
idx0
;

672 
ƒ∑ges
 > 0) {

673 
	`óæy_£t_fixm≠
(
idx
, 
phys_addr
, 
¥Ÿ
);

674 
phys_addr
 +
PAGE_SIZE
;

675 --
idx
;

676 --
ƒ∑ges
;

678 i‡(
óæy_i‹em≠_debug
)

679 
	`¥ötk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¶Ÿ_vút
[
¶Ÿ
]);

681 
¥ev_m≠
[
¶Ÿ
] = (
__iomem
 *)(
off£t
 + 
¶Ÿ_vút
[slot]);

682  
¥ev_m≠
[
¶Ÿ
];

683 
	}
}

686 
__öô
 
__iomem
 *

687 
	$óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

689  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

690 
	}
}

693 
__öô
 
__iomem
 *

694 
	$óæy_memªm≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

696  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

697 
	}
}

699 
__öô
 
	$óæy_iounm≠
(
__iomem
 *
addr
, 
size
)

701 
vút_addr
;

702 
off£t
;

703 
ƒ∑ges
;

704 
fixed_addªs£s
 
idx
;

705 
i
, 
¶Ÿ
;

707 
¶Ÿ
 = -1;

708 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

709 i‡(
¥ev_m≠
[
i
] =
addr
) {

710 
¶Ÿ
 = 
i
;

715 i‡(
¶Ÿ
 < 0) {

716 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx)Çot found slot\n",

717 
addr
, 
size
);

718 
	`WARN_ON
(1);

722 i‡(
¥ev_size
[
¶Ÿ
] !
size
) {

723 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] sizeÇot consistent %08lx\n",

724 
addr
, 
size
, 
¶Ÿ
, 
¥ev_size
[slot]);

725 
	`WARN_ON
(1);

729 i‡(
óæy_i‹em≠_debug
) {

730 
	`¥ötk
(
KERN_INFO
 "óæy_iounm≠(%p, %08lxË[%d]\n", 
addr
,

731 
size
, 
¶Ÿ
);

732 
	`dump_°ack
();

735 
vút_addr
 = ()
addr
;

736 i‡(
vút_addr
 < 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
)) {

737 
	`WARN_ON
(1);

740 
off£t
 = 
vút_addr
 & ~
PAGE_MASK
;

741 
ƒ∑ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1Ë>> 
PAGE_SHIFT
;

743 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

744 
ƒ∑ges
 > 0) {

745 
	`óæy_˛ór_fixm≠
(
idx
);

746 --
idx
;

747 --
ƒ∑ges
;

749 
¥ev_m≠
[
¶Ÿ
] = 
NULL
;

750 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<löux/pci_ids.h
>

16 
	~<löux/a˝i.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/mmz⁄e.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dúe˘.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/k8.h
>

27 
__öô
 
	$föd_n‹thbridge
()

29 
num
;

31 
num
 = 0;Çum < 32;Çum++) {

32 
u32
 
hódî
;

34 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 0, 0x00);

35 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

36 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

37 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

40 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 1, 0x00);

41 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

42 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

43 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

45  
num
;

49 
	}
}

51 
__öô
 
	$óæy_gë_boŸ_˝u_id
()

60 #ifde‡
CONFIG_X86_MPPARSE


61 
	`óæy_föd_smp_c⁄fig
();

63 #ifde‡
CONFIG_ACPI


67 
	`óæy_a˝i_boŸ_öô
();

69 #ifde‡
CONFIG_X86_MPPARSE


73 i‡(
smp_found_c⁄fig
)

74 
	`óæy_gë_smp_c⁄fig
();

76 
	`óæy_öô_œpic_m≠pög
();

77 
	}
}

79 
__öô
 
	$k8_sˇn_nodes
(
°¨t
, 
íd
)

81 
numnodes
, 
c‹es
, 
bôs
, 
≠icid_ba£
;

82 
¥evba£
;

83 
boŸnode
 
nodes
[8];

84 
i
, 
j
, 
nb
, 
found
 = 0;

85 
u32
 
nodeid
, 
ªg
;

87 i‡(!
	`óæy_pci_Ælowed
())

90 
nb
 = 
	`föd_n‹thbridge
();

91 i‡(
nb
 < 0)

92  
nb
;

94 
	`¥ötk
(
KERN_INFO
 "Sˇ¬ög NUMAÅ›ﬁogy i¿N‹thbridgê%d\n", 
nb
);

96 
ªg
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 0, 0x60);

97 
numnodes
 = ((
ªg
 >> 4) & 0xF) + 1;

98 i‡(
numnodes
 <= 1)

101 
	`¥ötk
(
KERN_INFO
 "Numbî o‡node†%d\n", 
numnodes
);

103 
	`mem£t
(&
nodes
, 0, (nodes));

104 
¥evba£
 = 0;

105 
i
 = 0; i < 8; i++) {

106 
ba£
, 
limô
;

108 
ba£
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x40 + 
i
*8);

109 
limô
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x44 + 
i
*8);

111 
nodeid
 = 
limô
 & 7;

112 i‡((
ba£
 & 3) == 0) {

113 i‡(
i
 < 
numnodes
)

114 
	`¥ötk
("Skùpög dißbÀdÇodê%d\n", 
i
);

117 i‡(
nodeid
 >
numnodes
) {

118 
	`¥ötk
("Ign‹ögÉx˚s†nodê%d (%lx:%lx)\n", 
nodeid
,

119 
ba£
, 
limô
);

123 i‡(!
limô
) {

124 
	`¥ötk
(
KERN_INFO
 "SkippingÇodeÉntry %d (base %lx)\n",

125 
i
, 
ba£
);

128 i‡((
ba£
 >> 8Ë& 3 || (
limô
 >> 8) & 3) {

129 
	`¥ötk
(
KERN_ERR
 "Node %d using interleaving mode %lx/%lx\n",

130 
nodeid
, (
ba£
>>8)&3, (
limô
>>8) & 3);

133 i‡(
	`node_is£t
(
nodeid
, 
node_possibÀ_m≠
)) {

134 
	`¥ötk
(
KERN_INFO
 "Node %dálreadyÖresent. Skipping\n",

135 
nodeid
);

139 
limô
 >>= 16;

140 
limô
 <<= 24;

141 
limô
 |= (1<<24)-1;

142 
limô
++;

144 i‡(
limô
 > 
max_p‚
 << 
PAGE_SHIFT
)

145 
limô
 = 
max_p‚
 << 
PAGE_SHIFT
;

146 i‡(
limô
 <
ba£
)

149 
ba£
 >>= 16;

150 
ba£
 <<= 24;

152 i‡(
ba£
 < 
°¨t
)

153 
ba£
 = 
°¨t
;

154 i‡(
limô
 > 
íd
)

155 
limô
 = 
íd
;

156 i‡(
limô
 =
ba£
) {

157 
	`¥ötk
(
KERN_ERR
 "Em±yÇodê%d\n", 
nodeid
);

160 i‡(
limô
 < 
ba£
) {

161 
	`¥ötk
(
KERN_ERR
 "Node %d bogus settings %lx-%lx.\n",

162 
nodeid
, 
ba£
, 
limô
);

167 i‡(
¥evba£
 > 
ba£
) {

168 
	`¥ötk
(
KERN_ERR
 "Node mapÇot sorted %lx,%lx\n",

169 
¥evba£
, 
ba£
);

173 
	`¥ötk
(
KERN_INFO
 "Node %d MemBase %016lx Limit %016lx\n",

174 
nodeid
, 
ba£
, 
limô
);

176 
found
++;

178 
nodes
[
nodeid
].
°¨t
 = 
ba£
;

179 
nodes
[
nodeid
].
íd
 = 
limô
;

181 
¥evba£
 = 
ba£
;

183 
	`node_£t
(
nodeid
, 
node_possibÀ_m≠
);

186 i‡(!
found
)

189 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 8, 
NULL
);

190 i‡(
memnode_shi·
 < 0) {

191 
	`¥ötk
(
KERN_ERR
 "No NUMAÇode hash function found. Contact maintainer\n");

194 
	`¥ötk
(
KERN_INFO
 "UsögÇodêhash shi· o‡%d\n", 
memnode_shi·
);

197 
bôs
 = 
boŸ_˝u_d©a
.
x86_c‹eid_bôs
;

198 
c‹es
 = (1<<
bôs
);

199 
≠icid_ba£
 = 0;

201 
	`óæy_gë_boŸ_˝u_id
();

202 i‡(
boŸ_˝u_physiˇl_≠icid
 > 0) {

203 
	`¥ötk
(
KERN_INFO
 "BSP APIC ID: %02x\n",

204 
boŸ_˝u_physiˇl_≠icid
);

205 
≠icid_ba£
 = 
boŸ_˝u_physiˇl_≠icid
;

208 
i
 = 0; i < 8; i++) {

209 i‡(
nodes
[
i
].
°¨t
 =nodes[i].
íd
)

212 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
,

213 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
,

214 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

215 
j
 = 
≠icid_ba£
; j < 
c‹es
 +ápicid_base; j++)

216 
≠icid_to_node
[(
i
 << 
bôs
Ë+ 
j
] = i;

217 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

220 
	`numa_öô_¨øy
();

222 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<löux/≥rs⁄Æôy.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/limôs.h
>

31 
	~<löux/sched.h
>

38 
	#MIN_GAP
 (128*1024*1024)

	)

39 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

44 
	$mm≠_is_ü32
()

46 #ifde‡
CONFIG_X86_32


49 #ifde‡
CONFIG_IA32_EMULATION


50 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

54 
	}
}

56 
	$mm≠_is_Àgacy
()

58 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_COMPAT_LAYOUT
)

61 i‡(
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
 =
RLIM_INFINITY
)

64  
sys˘l_Àgacy_va_œyout
;

65 
	}
}

67 
	$mm≠_∫d
()

69 
∫d
 = 0;

75 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

76 i‡(
	`mm≠_is_ü32
())

77 
∫d
 = ()
	`gë_øndom_öt
() % (1<<8);

79 
∫d
 = ()(
	`gë_øndom_öt
() % (1<<28));

81  
∫d
 << 
PAGE_SHIFT
;

82 
	}
}

84 
	$mm≠_ba£
()

86 
g≠
 = 
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
;

88 i‡(
g≠
 < 
MIN_GAP
)

89 
g≠
 = 
MIN_GAP
;

90 i‡(
g≠
 > 
MAX_GAP
)

91 
g≠
 = 
MAX_GAP
;

93  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g≠
 - 
	`mm≠_∫d
());

94 
	}
}

100 
	$mm≠_Àgacy_ba£
()

102 i‡(
	`mm≠_is_ü32
())

103  
TASK_UNMAPPED_BASE
;

105  
TASK_UNMAPPED_BASE
 + 
	`mm≠_∫d
();

106 
	}
}

112 
	$¨ch_pick_mm≠_œyout
(
mm_°ru˘
 *
mm
)

114 i‡(
	`mm≠_is_Àgacy
()) {

115 
mm
->
mm≠_ba£
 = 
	`mm≠_Àgacy_ba£
();

116 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó
;

117 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó
;

119 
mm
->
mm≠_ba£
 = 
	`mm≠_ba£
();

120 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó_t›down
;

121 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó_t›down
;

123 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<löux/t›ﬁogy.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/boŸmem.h
>

6 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


7 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

9 
	#DBG
(
x
...)

	)

15 
˝umask_v¨_t
 
	gnode_to_˝umask_m≠
[
MAX_NUMNODES
];

16 
EXPORT_SYMBOL
(
node_to_˝umask_m≠
);

25 
__öô
 
	$£tup_node_to_˝umask_m≠
()

27 
node
, 
num
 = 0;

30 i‡(
ƒ_node_ids
 =
MAX_NUMNODES
) {

31 
	`f‹_óch_node_mask
(
node
, 
node_possibÀ_m≠
)

32 
num
 = 
node
;

33 
ƒ_node_ids
 = 
num
 + 1;

37 
node
 = 0;Çodê< 
ƒ_node_ids
;Çode++)

38 
	`Æloc_boŸmem_˝umask_v¨
(&
node_to_˝umask_m≠
[
node
]);

41 
	`¥_debug
("Nodêtÿ˝umask m≠ f‹ %dÇodes\n", 
ƒ_node_ids
);

42 
	}
}

44 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


48 c⁄° 
˝umask
 *
	$˝umask_of_node
(
node
)

50 i‡(
node
 >
ƒ_node_ids
) {

51 
	`¥ötk
(
KERN_WARNING


53 
node
, 
ƒ_node_ids
);

54 
	`dump_°ack
();

55  
˝u_n⁄e_mask
;

57 i‡(
node_to_˝umask_m≠
[
node
] =
NULL
) {

58 
	`¥ötk
(
KERN_WARNING


60 
node
);

61 
	`dump_°ack
();

62  
˝u_⁄löe_mask
;

64  
node_to_˝umask_m≠
[
node
];

65 
	}
}

66 
EXPORT_SYMBOL
(
˝umask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/mmz⁄e.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/a˝i.h
>

21 
	~<asm/k8.h
>

23 
pgli°_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__ªad_mo°ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__˝uöôd©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__öôd©a
;

33 
__öôd©a
 
	gnodem≠_addr
;

34 
__öôd©a
 
	gnodem≠_size
;

36 
DEFINE_PER_CPU
(, 
node_numbî
) = 0;

37 
EXPORT_PER_CPU_SYMBOL
(
node_numbî
);

42 
DEFINE_EARLY_PER_CPU
(, 
x86_˝u_to_node_m≠
, 
NUMA_NO_NODE
);

43 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_node_m≠
);

52 
__öô
 
	$p›uœã_memnodem≠
(c⁄° 
boŸnode
 *
nodes
,

53 
numnodes
, 
shi·
, *
nodeids
)

55 
addr
, 
íd
;

56 
i
, 
ªs
 = -1;

58 
	`mem£t
(
memnodem≠
, 0xff, (
s16
)*
memnodem≠size
);

59 
i
 = 0; i < 
numnodes
; i++) {

60 
addr
 = 
nodes
[
i
].
°¨t
;

61 
íd
 = 
nodes
[
i
].end;

62 i‡(
addr
 >
íd
)

64 i‡((
íd
 >> 
shi·
Ë>
memnodem≠size
)

67 i‡(
memnodem≠
[
addr
 >> 
shi·
] !
NUMA_NO_NODE
)

70 i‡(!
nodeids
)

71 
memnodem≠
[
addr
 >> 
shi·
] = 
i
;

73 
memnodem≠
[
addr
 >> 
shi·
] = 
nodeids
[
i
];

75 
addr
 +(1UL << 
shi·
);

76 } 
addr
 < 
íd
);

77 
ªs
 = 1;

79  
ªs
;

80 
	}
}

82 
__öô
 
	$Æloˇã_ˇchólig√d_memnodem≠
()

84 
addr
;

86 
memnodem≠
 = 
memnode
.
embedded_m≠
;

87 i‡(
memnodem≠size
 <
	`ARRAY_SIZE
(
memnode
.
embedded_m≠
))

90 
addr
 = 0x8000;

91 
nodem≠_size
 = 
	`roundup
((
s16
Ë* 
memnodem≠size
, 
L1_CACHE_BYTES
);

92 
nodem≠_addr
 = 
	`föd_e820_¨ó
(
addr
, 
max_p‚
<<
PAGE_SHIFT
,

93 
nodem≠_size
, 
L1_CACHE_BYTES
);

94 i‡(
nodem≠_addr
 == -1UL) {

95 
	`¥ötk
(
KERN_ERR


97 
nodem≠_addr
 = 
nodem≠_size
 = 0;

100 
memnodem≠
 = 
	`phys_to_vút
(
nodem≠_addr
);

101 
	`ª£rve_óæy
(
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
, "MEMNODEMAP");

103 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

104 
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
);

106 
	}
}

112 
__öô
 
	$exåa˘_lsb_‰om_nodes
(c⁄° 
boŸnode
 *
nodes
,

113 
numnodes
)

115 
i
, 
nodes_u£d
 = 0;

116 
°¨t
, 
íd
;

117 
bôfõld
 = 0, 
memt›
 = 0;

119 
i
 = 0; i < 
numnodes
; i++) {

120 
°¨t
 = 
nodes
[
i
].start;

121 
íd
 = 
nodes
[
i
].end;

122 i‡(
°¨t
 >
íd
)

124 
bôfõld
 |
°¨t
;

125 
nodes_u£d
++;

126 i‡(
íd
 > 
memt›
)

127 
memt›
 = 
íd
;

129 i‡(
nodes_u£d
 <= 1)

130 
i
 = 63;

132 
i
 = 
	`föd_fú°_bô
(&
bôfõld
, ()*8);

133 
memnodem≠size
 = (
memt›
 >> 
i
)+1;

134  
i
;

135 
	}
}

137 
__öô
 
	$compuã_hash_shi·
(
boŸnode
 *
nodes
, 
numnodes
,

138 *
nodeids
)

140 
shi·
;

142 
shi·
 = 
	`exåa˘_lsb_‰om_nodes
(
nodes
, 
numnodes
);

143 i‡(
	`Æloˇã_ˇchólig√d_memnodem≠
())

145 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Using %d forÅhe hash shift.\n",

146 
shi·
);

148 i‡(
	`p›uœã_memnodem≠
(
nodes
, 
numnodes
, 
shi·
, 
nodeids
) != 1) {

149 
	`¥ötk
(
KERN_INFO
 "Your memory isÇotáligned youÇeedÅo "

151 "shi·=%d\n", 
shi·
);

154  
shi·
;

155 
	}
}

157 
__memöô
 
	$__óæy_p‚_to_nid
(
p‚
)

159  
	`phys_to_nid
(
p‚
 << 
PAGE_SHIFT
);

160 
	}
}

162 * 
__öô
 
	$óæy_node_mem
(
nodeid
, 
°¨t
,

163 
íd
, 
size
,

164 
Æign
)

166 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

167 *
±r
;

169 i‡(
mem
 != -1L)

170  
	`__va
(
mem
);

172 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
	`__∑
(
MAX_DMA_ADDRESS
));

173 i‡(
±r
 =
NULL
) {

174 
	`¥ötk
(
KERN_ERR
 "Cannot find %lu bytes inÇode %d\n",

175 
size
, 
nodeid
);

176  
NULL
;

178  
±r
;

179 
	}
}

182 
__öô


183 
	$£tup_node_boŸmem
(
nodeid
, 
°¨t
, 
íd
)

185 
°¨t_p‚
, 
œ°_p‚
, 
boŸm≠_∑ges
, 
boŸm≠_size
;

186 c⁄° 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

187 
boŸm≠_°¨t
, 
noded©a_phys
;

188 *
boŸm≠
;

189 
nid
;

191 i‡(!
íd
)

198 i‡(
íd
 && (íd - 
°¨t
Ë< 
NODE_MIN_SIZE
)

201 
°¨t
 = 
	`roundup
(°¨t, 
ZONE_ALIGN
);

203 
	`¥ötk
(
KERN_INFO
 "BoŸmem sëu∞nodê%d %016lx-%016lx\n", 
nodeid
,

204 
°¨t
, 
íd
);

206 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

207 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

209 
node_d©a
[
nodeid
] = 
	`óæy_node_mem
“odeid, 
°¨t
, 
íd
, 
pgd©_size
,

210 
SMP_CACHE_BYTES
);

211 i‡(
node_d©a
[
nodeid
] =
NULL
)

213 
noded©a_phys
 = 
	`__∑
(
node_d©a
[
nodeid
]);

214 
	`¥ötk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

215 
noded©a_phys
 + 
pgd©_size
 - 1);

217 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

218 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boŸmem_node_d©a
[nodeid];

219 
	`NODE_DATA
(
nodeid
)->
node_°¨t_p‚
 = 
°¨t_p‚
;

220 
	`NODE_DATA
(
nodeid
)->
node_•™√d_∑ges
 = 
œ°_p‚
 - 
°¨t_p‚
;

229 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
œ°_p‚
 - 
°¨t_p‚
);

230 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

231 i‡(
nid
 =
nodeid
)

232 
boŸm≠_°¨t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

234 
boŸm≠_°¨t
 = 
	`roundup
(
°¨t
, 
PAGE_SIZE
);

239 
boŸm≠
 = 
	`óæy_node_mem
(
nodeid
, 
boŸm≠_°¨t
, 
íd
,

240 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

241 i‡(
boŸm≠
 =
NULL
) {

242 i‡(
noded©a_phys
 < 
°¨t
 ||Çoded©a_phy†>
íd
)

243 
	`‰ì_boŸmem
(
noded©a_phys
, 
pgd©_size
);

244 
node_d©a
[
nodeid
] = 
NULL
;

247 
boŸm≠_°¨t
 = 
	`__∑
(
boŸm≠
);

249 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nodeid
),

250 
boŸm≠_°¨t
 >> 
PAGE_SHIFT
,

251 
°¨t_p‚
, 
œ°_p‚
);

253 
	`¥ötk
(
KERN_INFO
 " bootmap [%016lx - %016lx]Öages %lx\n",

254 
boŸm≠_°¨t
, boŸm≠_°¨à+ 
boŸm≠_size
 - 1,

255 
boŸm≠_∑ges
);

257 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(
nodeid
, 
íd
);

264 
	`óæy_ªs_to_boŸmem
(
°¨t
, 
íd
);

270 i‡(
nid
 !
nodeid
)

271 
	`¥ötk
(
KERN_INFO
 " NODE_DATA(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

273 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
noded©a_phys
,

274 
pgd©_size
, 
BOOTMEM_DEFAULT
);

275 
nid
 = 
	`phys_to_nid
(
boŸm≠_°¨t
);

276 i‡(
nid
 !
nodeid
)

277 
	`¥ötk
(
KERN_INFO
 " boŸm≠(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

279 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
boŸm≠_°¨t
,

280 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
BOOTMEM_DEFAULT
);

282 
	`node_£t_⁄löe
(
nodeid
);

283 
	}
}

292 
__öô
 
	$numa_öô_¨øy
()

294 
º
, 
i
;

296 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

297 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

298 i‡(
	`óæy_˝u_to_node
(
i
Ë!
NUMA_NO_NODE
)

300 
	`numa_£t_node
(
i
, 
º
);

301 
º
 = 
	`√xt_node
‘r, 
node_⁄löe_m≠
);

302 i‡(
º
 =
MAX_NUMNODES
)

303 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

305 
	}
}

307 #ifde‡
CONFIG_NUMA_EMU


309 *
cmdlöe
 
	g__öôd©a
;

318 
__öô
 
	$£tup_node_ønge
(
nid
, 
boŸnode
 *
nodes
, 
u64
 *
addr
,

319 
u64
 
size
, u64 
max_addr
)

321 
ªt
 = 0;

323 
nodes
[
nid
].
°¨t
 = *
addr
;

324 *
addr
 +
size
;

325 i‡(*
addr
 >
max_addr
) {

326 *
addr
 = 
max_addr
;

327 
ªt
 = -1;

329 
nodes
[
nid
].
íd
 = *
addr
;

330 
	`node_£t
(
nid
, 
node_possibÀ_m≠
);

331 
	`¥ötk
(
KERN_INFO
 "FakögÇodê%dáà%016Lx-%016Lx (%LuMB)\n", 
nid
,

332 
nodes
[
nid
].
°¨t
,Çodes[nid].
íd
,

333 (
nodes
[
nid
].
íd
 -Çodes[nid].
°¨t
) >> 20);

334  
ªt
;

335 
	}
}

342 
__öô
 
	$•lô_nodes_equÆly
(
boŸnode
 *
nodes
, 
u64
 *
addr
,

343 
u64
 
max_addr
, 
node_°¨t
,

344 
num_nodes
)

346 
big
;

347 
u64
 
size
;

348 
i
;

350 i‡(
num_nodes
 <= 0)

352 i‡(
num_nodes
 > 
MAX_NUMNODES
)

353 
num_nodes
 = 
MAX_NUMNODES
;

354 
size
 = (
max_addr
 - *
addr
 - 
	`e820_hﬁe_size
(*addr, max_addr)) /

355 
num_nodes
;

360 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë* 
num_nodes
) /

361 
FAKE_NODE_MIN_SIZE
;

364 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

365 i‡(!
size
) {

366 
	`¥ötk
(
KERN_ERR
 "NotÉnough memory forÉachÇode. "

371 
i
 = 
node_°¨t
; i < 
num_nodes
 +Çode_start; i++) {

372 
u64
 
íd
 = *
addr
 + 
size
;

374 i‡(
i
 < 
big
)

375 
íd
 +
FAKE_NODE_MIN_SIZE
;

380 i‡(
i
 =
num_nodes
 + 
node_°¨t
 - 1)

381 
íd
 = 
max_addr
;

383 
íd
 - *
addr
 - 
	`e820_hﬁe_size
(*addr,Énd) <

384 
size
) {

385 
íd
 +
FAKE_NODE_MIN_SIZE
;

386 i‡(
íd
 > 
max_addr
) {

387 
íd
 = 
max_addr
;

391 i‡(
	`£tup_node_ønge
(
i
, 
nodes
, 
addr
, 
íd
 - *addr, 
max_addr
) < 0)

394  
i
 - 
node_°¨t
 + 1;

395 
	}
}

402 
__öô
 
	$•lô_nodes_by_size
(
boŸnode
 *
nodes
, 
u64
 *
addr
,

403 
u64
 
max_addr
, 
node_°¨t
, u64 
size
)

405 
i
 = 
node_°¨t
;

406 
size
 = (sizê<< 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

407 !
	`£tup_node_ønge
(
i
++, 
nodes
, 
addr
, 
size
, 
max_addr
))

409  
i
 - 
node_°¨t
;

410 
	}
}

416 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

418 
__öô
 
	$numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
)

420 
u64
 
size
, 
addr
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

421 
u64
 
max_addr
 = 
œ°_p‚
 << 
PAGE_SHIFT
;

422 
num_nodes
 = 0, 
num
 = 0, 
c€ff_Êag
, 
c€ff
 = -1, 
i
;

424 
	`mem£t
(&
nodes
, 0, (nodes));

429 i‡(!
	`°rchr
(
cmdlöe
, '*') && !strchr(cmdline, ',')) {

430 
n
 = 
	`sim∂e_°πﬁ
(
cmdlöe
, 
NULL
, 0);

432 
num_nodes
 = 
	`•lô_nodes_equÆly
(
nodes
, &
addr
, 
max_addr
, 0, 
n
);

433 i‡(
num_nodes
 < 0)

434  
num_nodes
;

435 
out
;

439 
c€ff_Êag
 = 0; ; 
cmdlöe
++) {

440 i‡(*
cmdlöe
 && 
	`isdigô
(*cmdline)) {

441 
num
 =Çum * 10 + *
cmdlöe
 - '0';

444 i‡(*
cmdlöe
 == '*') {

445 i‡(
num
 > 0)

446 
c€ff
 = 
num
;

447 
c€ff_Êag
 = 1;

449 i‡(!*
cmdlöe
 || *cmdline == ',') {

450 i‡(!
c€ff_Êag
)

451 
c€ff
 = 1;

456 
size
 = ((
u64
)
num
 << 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

457 i‡(
size
)

458 
i
 = 0; i < 
c€ff
; i++, 
num_nodes
++)

459 i‡(
	`£tup_node_ønge
(
num_nodes
, 
nodes
,

460 &
addr
, 
size
, 
max_addr
) < 0)

461 
d⁄e
;

462 i‡(!*
cmdlöe
)

464 
c€ff_Êag
 = 0;

465 
c€ff
 = -1;

467 
num
 = 0;

469 
d⁄e
:

470 i‡(!
num_nodes
)

473 i‡(
addr
 < 
max_addr
) {

474 i‡(
c€ff_Êag
 && 
c€ff
 < 0) {

476 
num_nodes
 +
	`•lô_nodes_by_size
(
nodes
, &
addr
, 
max_addr
,

477 
num_nodes
, 
num
);

478 
out
;

480 *(
cmdlöe
 - 1)) {

483 i‡(
c€ff
 <= 0)

485 
num_nodes
 +
	`•lô_nodes_equÆly
(
nodes
, &
addr
, 
max_addr
,

486 
num_nodes
, 
c€ff
);

493 
	`£tup_node_ønge
(
num_nodes
, 
nodes
, &
addr
,

494 
max_addr
 - 
addr
, max_addr);

495 
num_nodes
++;

498 
out
:

499 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 
num_nodes
, 
NULL
);

500 i‡(
memnode_shi·
 < 0) {

501 
memnode_shi·
 = 0;

502 
	`¥ötk
(
KERN_ERR
 "No NUMA hash function found. NUMAÉmulation "

512 
	`ªmove_Æl_a˘ive_ønges
();

513 #ifde‡
CONFIG_ACPI_NUMA


514 
a˝i_numa
 = -1;

516 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

517 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

518 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

519 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

521 
	`a˝i_Áke_nodes
(
nodes
, 
num_nodes
);

522 
	`numa_öô_¨øy
();

524 
	}
}

527 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
œ°_p‚
)

529 
i
;

531 
	`nodes_˛ór
(
node_possibÀ_m≠
);

532 
	`nodes_˛ór
(
node_⁄löe_m≠
);

534 #ifde‡
CONFIG_NUMA_EMU


535 i‡(
cmdlöe
 && !
	`numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
))

537 
	`nodes_˛ór
(
node_possibÀ_m≠
);

538 
	`nodes_˛ór
(
node_⁄löe_m≠
);

541 #ifde‡
CONFIG_ACPI_NUMA


542 i‡(!
numa_off
 && !
	`a˝i_sˇn_nodes
(
°¨t_p‚
 << 
PAGE_SHIFT
,

543 
œ°_p‚
 << 
PAGE_SHIFT
))

545 
	`nodes_˛ór
(
node_possibÀ_m≠
);

546 
	`nodes_˛ór
(
node_⁄löe_m≠
);

549 #ifde‡
CONFIG_K8_NUMA


550 i‡(!
numa_off
 && !
	`k8_sˇn_nodes
(
°¨t_p‚
<<
PAGE_SHIFT
,

551 
œ°_p‚
<<
PAGE_SHIFT
))

553 
	`nodes_˛ór
(
node_possibÀ_m≠
);

554 
	`nodes_˛ór
(
node_⁄löe_m≠
);

556 
	`¥ötk
(
KERN_INFO
 "%s\n",

557 
numa_off
 ? "NUMAÅurned off" : "No NUMA configuration found");

559 
	`¥ötk
(
KERN_INFO
 "FakingáÇodeát %016lx-%016lx\n",

560 
°¨t_p‚
 << 
PAGE_SHIFT
,

561 
œ°_p‚
 << 
PAGE_SHIFT
);

563 
memnode_shi·
 = 63;

564 
memnodem≠
 = 
memnode
.
embedded_m≠
;

565 
memnodem≠
[0] = 0;

566 
	`node_£t_⁄löe
(0);

567 
	`node_£t
(0, 
node_possibÀ_m≠
);

568 
i
 = 0; i < 
ƒ_˝u_ids
; i++)

569 
	`numa_£t_node
(
i
, 0);

570 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
œ°_p‚
);

571 
	`£tup_node_boŸmem
(0, 
°¨t_p‚
 << 
PAGE_SHIFT
, 
œ°_p‚
 << PAGE_SHIFT);

572 
	}
}

574 
__öô
 
	$numa_‰ì_Æl_boŸmem
()

576 
∑ges
 = 0;

577 
i
;

579 
	`f‹_óch_⁄löe_node
(
i
)

580 
∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
i
));

582  
∑ges
;

583 
	}
}

585 
__öô
 
	$numa_£tup
(*
›t
)

587 i‡(!
›t
)

588  -
EINVAL
;

589 i‡(!
	`°∫cmp
(
›t
, "off", 3))

590 
numa_off
 = 1;

591 #ifde‡
CONFIG_NUMA_EMU


592 i‡(!
	`°∫cmp
(
›t
, "fake=", 5))

593 
cmdlöe
 = 
›t
 + 5;

595 #ifde‡
CONFIG_ACPI_NUMA


596 i‡(!
	`°∫cmp
(
›t
, "noacpi", 6))

597 
a˝i_numa
 = -1;

600 
	}
}

601 
óæy_∑øm
("numa", 
numa_£tup
);

603 #ifde‡
CONFIG_NUMA


618 
__öô
 
	$öô_˝u_to_node
()

620 
˝u
;

621 
u16
 *
˝u_to_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
);

623 
	`BUG_ON
(
˝u_to_≠icid
 =
NULL
);

625 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

626 
node
;

627 
u16
 
≠icid
 = 
˝u_to_≠icid
[
˝u
];

629 i‡(
≠icid
 =
BAD_APICID
)

631 
node
 = 
≠icid_to_node
[
≠icid
];

632 i‡(
node
 =
NUMA_NO_NODE
)

634 i‡(!
	`node_⁄löe
(
node
))

636 
	`numa_£t_node
(
˝u
, 
node
);

638 
	}
}

642 
__˝uöô
 
	$numa_£t_node
(
˝u
, 
node
)

644 *
˝u_to_node_m≠
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
);

647 i‡(
˝u_to_node_m≠
) {

648 
˝u_to_node_m≠
[
˝u
] = 
node
;

652 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


653 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_possibÀ
(cpu)) {

654 
	`¥ötk
(
KERN_ERR
 "numa_£t_node: invÆid cpu# (%d)\n", 
˝u
);

655 
	`dump_°ack
();

659 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
Ë
node
;

661 i‡(
node
 !
NUMA_NO_NODE
)

662 
	`≥r_˝u
(
node_numbî
, 
˝u
Ë
node
;

663 
	}
}

665 
__˝uöô
 
	$numa_˛ór_node
(
˝u
)

667 
	`numa_£t_node
(
˝u
, 
NUMA_NO_NODE
);

668 
	}
}

670 #i‚de‡
CONFIG_DEBUG_PER_CPU_MAPS


672 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

674 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

675 
	}
}

677 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

679 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

680 
	}
}

687 
__˝uöô
 
	$numa_£t_˝umask
(
˝u
, 
íabÀ
)

689 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

690 
˝umask
 *
mask
;

691 
buf
[64];

693 
mask
 = 
node_to_˝umask_m≠
[
node
];

694 i‡(
mask
 =
NULL
) {

695 
	`¥ötk
(
KERN_ERR
 "node_to_˝umask_m≠[%i] NULL\n", 
node
);

696 
	`dump_°ack
();

700 i‡(
íabÀ
)

701 
	`˝umask_£t_˝u
(
˝u
, 
mask
);

703 
	`˝umask_˛ór_˝u
(
˝u
, 
mask
);

705 
	`˝uli°_s˙¥ötf
(
buf
, (buf), 
mask
);

706 
	`¥ötk
(
KERN_DEBUG
 "%s cpu %dÇode %d: maskÇow %s\n",

707 
íabÀ
 ? "numa_add_˝u" : "numa_ªmove_˝u", 
˝u
, 
node
, 
buf
);

708 
	}
}

710 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

712 
	`numa_£t_˝umask
(
˝u
, 1);

713 
	}
}

715 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

717 
	`numa_£t_˝umask
(
˝u
, 0);

718 
	}
}

720 
	$˝u_to_node
(
˝u
)

722 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)) {

723 
	`¥ötk
(
KERN_WARNING


724 "˝u_to_node(%d): ußgêtoÿóæy!\n", 
˝u
);

725 
	`dump_°ack
();

726  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

728  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

729 
	}
}

730 
EXPORT_SYMBOL
(
˝u_to_node
);

736 
	$óæy_˝u_to_node
(
˝u
)

738 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
))

739  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

741 i‡(!
	`˝u_possibÀ
(
˝u
)) {

742 
	`¥ötk
(
KERN_WARNING


743 "óæy_˝u_to_node(%d):Çÿ≥r_˝uáªa!\n", 
˝u
);

744 
	`dump_°ack
();

745  
NUMA_NO_NODE
;

747  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

748 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<löux/highmem.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/öãºu±.h
>

12 
	~<löux/£q_fûe.h
>

13 
	~<löux/debugfs.h
>

14 
	~<löux/p‚.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥o˚ss‹.h
>

18 
	~<asm/ébÊush.h
>

19 
	~<asm/£˘i⁄s.h
>

20 
	~<asm/£tup.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/¥Ÿo.h
>

24 
	~<asm/∑t.h
>

29 
	s˝a_d©a
 {

30 *
	mvaddr
;

31 
pg¥Ÿ_t
 
	mmask_£t
;

32 
pg¥Ÿ_t
 
	mmask_˛r
;

33 
	mnum∑ges
;

34 
	mÊags
;

35 
	mp‚
;

36 
	mf‹˚_•lô
 : 1;

37 
	mcuΩage
;

38 
∑ge
 **
	m∑ges
;

47 
DEFINE_SPINLOCK
(
˝a_lock
);

49 
	#CPA_FLUSHTLB
 1

	)

50 
	#CPA_ARRAY
 2

	)

51 
	#CPA_PAGES_ARRAY
 4

	)

53 #ifde‡
CONFIG_PROC_FS


54 
	gdúe˘_∑ges_cou¡
[
PG_LEVEL_NUM
];

56 
	$upd©e_∑ge_cou¡
(
Àvñ
, 
∑ges
)

58 
Êags
;

61 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

62 
dúe˘_∑ges_cou¡
[
Àvñ
] +
∑ges
;

63 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

64 
	}
}

66 
	$•lô_∑ge_cou¡
(
Àvñ
)

68 
dúe˘_∑ges_cou¡
[
Àvñ
]--;

69 
dúe˘_∑ges_cou¡
[
Àvñ
 - 1] +
PTRS_PER_PTE
;

70 
	}
}

72 
	$¨ch_ªp‹t_memöfo
(
£q_fûe
 *
m
)

74 
	`£q_¥ötf
(
m
, "DirectMap4k: %8lu kB\n",

75 
dúe˘_∑ges_cou¡
[
PG_LEVEL_4K
] << 2);

76 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

77 
	`£q_¥ötf
(
m
, "DirectMap2M: %8lu kB\n",

78 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 11);

80 
	`£q_¥ötf
(
m
, "DirectMap4M: %8lu kB\n",

81 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 12);

83 #ifde‡
CONFIG_X86_64


84 i‡(
dúe˘_gb∑ges
)

85 
	`£q_¥ötf
(
m
, "DirectMap1G: %8lu kB\n",

86 
dúe˘_∑ges_cou¡
[
PG_LEVEL_1G
] << 20);

88 
	}
}

90 
ölöe
 
	$•lô_∑ge_cou¡
(
Àvñ
Ë{ 
	}
}

93 #ifde‡
CONFIG_X86_64


95 
ölöe
 
	$highm≠_°¨t_p‚
()

97  
	`__∑
(
_ãxt
Ë>> 
PAGE_SHIFT
;

98 
	}
}

100 
ölöe
 
	$highm≠_íd_p‚
()

102  
	`__∑
(
	`roundup
(
_brk_íd
, 
PMD_SIZE
)Ë>> 
PAGE_SHIFT
;

103 
	}
}

107 #ifde‡
CONFIG_DEBUG_PAGEALLOC


108 
	#debug_∑góŒoc
 1

	)

110 
	#debug_∑góŒoc
 0

	)

113 
ölöe
 

114 
	$wôhö
(
addr
, 
°¨t
, 
íd
)

116  
addr
 >
°¨t
 &&ádd∏< 
íd
;

117 
	}
}

131 
	$˛Êush_ˇche_ønge
(*
vaddr
, 
size
)

133 *
víd
 = 
vaddr
 + 
size
 - 1;

135 
	`mb
();

137 ; 
vaddr
 < 
víd
; vadd∏+
boŸ_˝u_d©a
.
x86_˛Êush_size
)

138 
	`˛Êush
(
vaddr
);

142 
	`˛Êush
(
víd
);

144 
	`mb
();

145 
	}
}

147 
	$__˝a_Êush_Æl
(*
¨g
)

149 
ˇche
 = ()
¨g
;

155 
	`__Êush_éb_Æl
();

157 i‡(
ˇche
 && 
boŸ_˝u_d©a
.
x86
 >= 4)

158 
	`wbövd
();

159 
	}
}

161 
	$˝a_Êush_Æl
(
ˇche
)

163 
	`BUG_ON
(
	`úqs_dißbÀd
());

165 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
ˇche
, 1);

166 
	}
}

168 
	$__˝a_Êush_ønge
(*
¨g
)

175 
	`__Êush_éb_Æl
();

176 
	}
}

178 
	$˝a_Êush_ønge
(
°¨t
, 
num∑ges
, 
ˇche
)

180 
i
, 
Àvñ
;

181 
addr
;

183 
	`BUG_ON
(
	`úqs_dißbÀd
());

184 
	`WARN_ON
(
	`PAGE_ALIGN
(
°¨t
) != start);

186 
	`⁄_óch_˝u
(
__˝a_Êush_ønge
, 
NULL
, 1);

188 i‡(!
ˇche
)

197 
i
 = 0, 
addr
 = 
°¨t
; i < 
num∑ges
; i++,ádd∏+
PAGE_SIZE
) {

198 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

203 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

204 
	`˛Êush_ˇche_ønge
((*Ë
addr
, 
PAGE_SIZE
);

206 
	}
}

208 
	$˝a_Êush_¨øy
(*
°¨t
, 
num∑ges
, 
ˇche
,

209 
ö_Êags
, 
∑ge
 **
∑ges
)

211 
i
, 
Àvñ
;

212 
do_wbövd
 = 
ˇche
 && 
num∑ges
 >= 1024;

214 
	`BUG_ON
(
	`úqs_dißbÀd
());

216 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
do_wbövd
, 1);

218 i‡(!
ˇche
 || 
do_wbövd
)

227 
i
 = 0; i < 
num∑ges
; i++) {

228 
addr
;

229 
±e_t
 *
±e
;

231 i‡(
ö_Êags
 & 
CPA_PAGES_ARRAY
)

232 
addr
 = ()
	`∑ge_addªss
(
∑ges
[
i
]);

234 
addr
 = 
°¨t
[
i
];

236 
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

241 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

242 
	`˛Êush_ˇche_ønge
((*)
addr
, 
PAGE_SIZE
);

244 
	}
}

252 
ölöe
 
pg¥Ÿ_t
 
	$°©ic_¥Ÿe˘i⁄s
(
pg¥Ÿ_t
 
¥Ÿ
, 
addªss
,

253 
p‚
)

255 
pg¥Ÿ_t
 
f‹biddí
 = 
	`__pg¥Ÿ
(0);

261 i‡(
	`wôhö
(
p‚
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

262 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

269 i‡(
	`wôhö
(
addªss
, ()
_ãxt
, ()
_ëext
))

270 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

276 i‡(
	`wôhö
(
p‚
, 
	`__∑
(()
__°¨t_rod©a
Ë>> 
PAGE_SHIFT
,

277 
	`__∑
(()
__íd_rod©a
Ë>> 
PAGE_SHIFT
))

278 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

280 
¥Ÿ
 = 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
’rŸË& ~pg¥Ÿ_vÆ(
f‹biddí
));

282  
¥Ÿ
;

283 
	}
}

293 
±e_t
 *
	$lookup_addªss
(
addªss
, *
Àvñ
)

295 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
addªss
);

296 
pud_t
 *
pud
;

297 
pmd_t
 *
pmd
;

299 *
Àvñ
 = 
PG_LEVEL_NONE
;

301 i‡(
	`pgd_n⁄e
(*
pgd
))

302  
NULL
;

304 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

305 i‡(
	`pud_n⁄e
(*
pud
))

306  
NULL
;

308 *
Àvñ
 = 
PG_LEVEL_1G
;

309 i‡(
	`pud_œrge
(*
pud
Ë|| !
	`pud_¥e£¡
(*pud))

310  (
±e_t
 *)
pud
;

312 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

313 i‡(
	`pmd_n⁄e
(*
pmd
))

314  
NULL
;

316 *
Àvñ
 = 
PG_LEVEL_2M
;

317 i‡(
	`pmd_œrge
(*
pmd
Ë|| !
	`pmd_¥e£¡
(*pmd))

318  (
±e_t
 *)
pmd
;

320 *
Àvñ
 = 
PG_LEVEL_4K
;

322  
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

323 
	}
}

324 
EXPORT_SYMBOL_GPL
(
lookup_addªss
);

329 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
addªss
,Öã_à
±e
)

332 
	`£t_±e_©omic
(
k±e
, 
±e
);

333 #ifde‡
CONFIG_X86_32


334 i‡(!
SHARED_KERNEL_PMD
) {

335 
∑ge
 *page;

337 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

338 
pgd_t
 *
pgd
;

339 
pud_t
 *
pud
;

340 
pmd_t
 *
pmd
;

342 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

343 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

344 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

345 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

349 
	}
}

352 
	$åy_¥e£rve_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
,

353 
˝a_d©a
 *
˝a
)

355 
√xçage_addr
, 
num∑ges
, 
pmask
, 
psize
, 
Êags
, 
addr
, 
p‚
;

356 
±e_t
 
√w_±e
, 
ﬁd_±e
, *
tmp
;

357 
pg¥Ÿ_t
 
ﬁd_¥Ÿ
, 
√w_¥Ÿ
;

358 
i
, 
do_•lô
 = 1;

359 
Àvñ
;

361 i‡(
˝a
->
f‹˚_•lô
)

364 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

369 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

370 i‡(
tmp
 !
k±e
)

371 
out_u∆ock
;

373 
Àvñ
) {

374 
PG_LEVEL_2M
:

375 
psize
 = 
PMD_PAGE_SIZE
;

376 
pmask
 = 
PMD_PAGE_MASK
;

378 #ifde‡
CONFIG_X86_64


379 
PG_LEVEL_1G
:

380 
psize
 = 
PUD_PAGE_SIZE
;

381 
pmask
 = 
PUD_PAGE_MASK
;

385 
do_•lô
 = -
EINVAL
;

386 
out_u∆ock
;

393 
√xçage_addr
 = (
addªss
 + 
psize
Ë& 
pmask
;

394 
num∑ges
 = (
√xçage_addr
 - 
addªss
Ë>> 
PAGE_SHIFT
;

395 i‡(
num∑ges
 < 
˝a
->numpages)

396 
˝a
->
num∑ges
 =Çumpages;

401 
ﬁd_±e
 = *
k±e
;

402 
ﬁd_¥Ÿ
 = 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

404 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

405 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

411 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
Ë+ ((
addªss
 & (
psize
 - 1)Ë>> 
PAGE_SHIFT
);

412 
˝a
->
p‚
 =Öfn;

414 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

421 
addr
 = 
addªss
 + 
PAGE_SIZE
;

422 
p‚
++;

423 
i
 = 1; i < 
˝a
->
num∑ges
; i++, 
addr
 +
PAGE_SIZE
, 
p‚
++) {

424 
pg¥Ÿ_t
 
chk_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
(
√w_¥Ÿ
, 
addr
, 
p‚
);

426 i‡(
	`pg¥Ÿ_vÆ
(
chk_¥Ÿ
Ë!pg¥Ÿ_vÆ(
√w_¥Ÿ
))

427 
out_u∆ock
;

434 i‡(
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë=pg¥Ÿ_vÆ(
ﬁd_¥Ÿ
)) {

435 
do_•lô
 = 0;

436 
out_u∆ock
;

447 i‡(
addªss
 =(
√xçage_addr
 - 
psize
Ë&& 
˝a
->
num∑ges
 ==Çumpages) {

452 
√w_±e
 = 
	`p‚_±e
(
	`±e_p‚
(
ﬁd_±e
), 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

453 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
√w_±e
);

454 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

455 
do_•lô
 = 0;

458 
out_u∆ock
:

459 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

461  
do_•lô
;

462 
	}
}

464 
	$•lô_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
)

466 
Êags
, 
p‚
, 
p‚öc
 = 1;

467 
i
, 
Àvñ
;

468 
±e_t
 *
pba£
, *
tmp
;

469 
pg¥Ÿ_t
 
ªf_¥Ÿ
;

470 
∑ge
 *
ba£
;

472 i‡(!
debug_∑góŒoc
)

473 
	`•ö_u∆ock
(&
˝a_lock
);

474 
ba£
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_NOTRACK
, 0);

475 i‡(!
debug_∑góŒoc
)

476 
	`•ö_lock
(&
˝a_lock
);

477 i‡(!
ba£
)

478  -
ENOMEM
;

480 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

485 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

486 i‡(
tmp
 !
k±e
)

487 
out_u∆ock
;

489 
pba£
 = (
±e_t
 *)
	`∑ge_addªss
(
ba£
);

490 
	`∑øvút_Æloc_±e
(&
öô_mm
, 
	`∑ge_to_p‚
(
ba£
));

491 
ªf_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*
k±e
));

498 
	`WARN_ON_ONCE
(
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë& 
_PAGE_PAT_LARGE
);

500 #ifde‡
CONFIG_X86_64


501 i‡(
Àvñ
 =
PG_LEVEL_1G
) {

502 
p‚öc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

503 
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë|
_PAGE_PSE
;

510 
p‚
 = 
	`±e_p‚
(*
k±e
);

511 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
p‚
 +
p‚öc
)

512 
	`£t_±e
(&
pba£
[
i
], 
	`p‚_±e
(
p‚
, 
ªf_¥Ÿ
));

514 i‡(
addªss
 >()
	`__va
(0) &&

515 
addªss
 < ()
	`__va
(
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
))

516 
	`•lô_∑ge_cou¡
(
Àvñ
);

518 #ifde‡
CONFIG_X86_64


519 i‡(
addªss
 >()
	`__va
(1UL<<32) &&

520 
addªss
 < ()
	`__va
(
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))

521 
	`•lô_∑ge_cou¡
(
Àvñ
);

531 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
	`mk_±e
(
ba£
, 
	`__pg¥Ÿ
(
_KERNPG_TABLE
)));

541 
	`__Êush_éb_Æl
();

543 
ba£
 = 
NULL
;

545 
out_u∆ock
:

550 i‡(
ba£
)

551 
	`__‰ì_∑ge
(
ba£
);

552 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

555 
	}
}

557 
	$__˝a_¥o˚ss_Áu…
(
˝a_d©a
 *
˝a
, 
vaddr
,

558 
¥im¨y
)

563 i‡(!
¥im¨y
)

573 i‡(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

574 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))) {

575 
˝a
->
num∑ges
 = 1;

576 
˝a
->
p‚
 = 
	`__∑
(
vaddr
Ë>> 
PAGE_SHIFT
;

579 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zeroÖte. "

580 "vadd∏%lx c∑->vadd∏%lx\n", 
vaddr
,

581 *
˝a
->
vaddr
);

583  -
EFAULT
;

585 
	}
}

587 
	$__ch™ge_∑ge_©å
(
˝a_d©a
 *
˝a
, 
¥im¨y
)

589 
addªss
;

590 
do_•lô
, 
îr
;

591 
Àvñ
;

592 
±e_t
 *
k±e
, 
ﬁd_±e
;

594 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

595 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

596 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

598 
addªss
 = ()
	`∑ge_addªss
(
∑ge
);

599 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

600 
addªss
 = 
˝a
->
vaddr
[˝a->
cuΩage
];

602 
addªss
 = *
˝a
->
vaddr
;

603 
ª≥©
:

604 
k±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

605 i‡(!
k±e
)

606  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

608 
ﬁd_±e
 = *
k±e
;

609 i‡(!
	`±e_vÆ
(
ﬁd_±e
))

610  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

612 i‡(
Àvñ
 =
PG_LEVEL_4K
) {

613 
±e_t
 
√w_±e
;

614 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

615 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
);

617 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

618 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

620 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

627 
√w_±e
 = 
	`p‚_±e
(
p‚
, 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

628 
˝a
->
p‚
 =Öfn;

632 i‡(
	`±e_vÆ
(
ﬁd_±e
Ë!±e_vÆ(
√w_±e
)) {

633 
	`£t_±e_©omic
(
k±e
, 
√w_±e
);

634 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

636 
˝a
->
num∑ges
 = 1;

644 
do_•lô
 = 
	`åy_¥e£rve_œrge_∑ge
(
k±e
, 
addªss
, 
˝a
);

650 i‡(
do_•lô
 <= 0)

651  
do_•lô
;

656 
îr
 = 
	`•lô_œrge_∑ge
(
k±e
, 
addªss
);

657 i‡(!
îr
) {

676 
	`Êush_éb_Æl
();

677 
ª≥©
;

680  
îr
;

681 
	}
}

683 
__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
);

685 
	$˝a_¥o˚ss_Æüs
(
˝a_d©a
 *
˝a
)

687 
˝a_d©a
 
Æüs_˝a
;

688 
œddr
 = ()
	`__va
(
˝a
->
p‚
 << 
PAGE_SHIFT
);

689 
vaddr
, 
ªm≠≥d
;

690 
ªt
;

692 i‡(
˝a
->
p‚
 >
max_p‚_m≠≥d
)

695 #ifde‡
CONFIG_X86_64


696 i‡(
˝a
->
p‚
 >
max_low_p‚_m≠≥d
 && c∑->p‚ < (1UL<<(32-
PAGE_SHIFT
)))

703 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

704 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

705 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

707 
vaddr
 = ()
	`∑ge_addªss
(
∑ge
);

708 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

709 
vaddr
 = 
˝a
->vaddr[˝a->
cuΩage
];

711 
vaddr
 = *
˝a
->vaddr;

713 i‡(!(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

714 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
)))) {

716 
Æüs_˝a
 = *
˝a
;

717 
Æüs_˝a
.
vaddr
 = &
œddr
;

718 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

720 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

721 i‡(
ªt
)

722  
ªt
;

725 #ifde‡
CONFIG_X86_64


731 i‡(!
	`wôhö
(
vaddr
, ()
_ãxt
, 
_brk_íd
) &&

732 
	`wôhö
(
˝a
->
p‚
, 
	`highm≠_°¨t_p‚
(), 
	`highm≠_íd_p‚
())) {

733 
ãmp_˝a_vaddr
 = (
˝a
->
p‚
 << 
PAGE_SHIFT
) +

734 
__START_KERNEL_m≠
 - 
phys_ba£
;

735 
Æüs_˝a
 = *
˝a
;

736 
Æüs_˝a
.
vaddr
 = &
ãmp_˝a_vaddr
;

737 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

743 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

754 
ªm≠≥d
 = ()
	`p˝u_Õage_ªm≠≥d
((*)
œddr
);

755 i‡(
ªm≠≥d
) {

756 
	`WARN_ON
(
˝a
->
num∑ges
 > 1);

757 
Æüs_˝a
 = *
˝a
;

758 
Æüs_˝a
.
vaddr
 = &
ªm≠≥d
;

759 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

760 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

761 i‡(
ªt
)

762  
ªt
;

766 
	}
}

768 
	$__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
)

770 
ªt
, 
num∑ges
 = 
˝a
->numpages;

772 
num∑ges
) {

777 
˝a
->
num∑ges
 =Çumpages;

779 i‡(
˝a
->
Êags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

780 
˝a
->
num∑ges
 = 1;

782 i‡(!
debug_∑góŒoc
)

783 
	`•ö_lock
(&
˝a_lock
);

784 
ªt
 = 
	`__ch™ge_∑ge_©å
(
˝a
, 
checkÆüs
);

785 i‡(!
debug_∑góŒoc
)

786 
	`•ö_u∆ock
(&
˝a_lock
);

787 i‡(
ªt
)

788  
ªt
;

790 i‡(
checkÆüs
) {

791 
ªt
 = 
	`˝a_¥o˚ss_Æüs
(
˝a
);

792 i‡(
ªt
)

793  
ªt
;

801 
	`BUG_ON
(
˝a
->
num∑ges
 >Çumpages);

802 
num∑ges
 -
˝a
->numpages;

803 i‡(
˝a
->
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

804 
˝a
->
cuΩage
++;

806 *
˝a
->
vaddr
 +˝a->
num∑ges
 * 
PAGE_SIZE
;

810 
	}
}

812 
ölöe
 
	$ˇche_©å
(
pg¥Ÿ_t
 
©å
)

814  
	`pg¥Ÿ_vÆ
(
©å
) &

815 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

816 
	}
}

818 
	$ch™ge_∑ge_©å_£t_˛r
(*
addr
, 
num∑ges
,

819 
pg¥Ÿ_t
 
mask_£t
,Ög¥Ÿ_à
mask_˛r
,

820 
f‹˚_•lô
, 
ö_Êag
,

821 
∑ge
 **
∑ges
)

823 
˝a_d©a
 
˝a
;

824 
ªt
, 
ˇche
, 
checkÆüs
;

830 
mask_£t
 = 
	`ˇn⁄_pg¥Ÿ
(mask_set);

831 
mask_˛r
 = 
	`ˇn⁄_pg¥Ÿ
(mask_clr);

832 i‡(!
	`pg¥Ÿ_vÆ
(
mask_£t
Ë&& !pg¥Ÿ_vÆ(
mask_˛r
Ë&& !
f‹˚_•lô
)

836 i‡(
ö_Êag
 & 
CPA_ARRAY
) {

837 
i
;

838 
i
 = 0; i < 
num∑ges
; i++) {

839 i‡(
addr
[
i
] & ~
PAGE_MASK
) {

840 
addr
[
i
] &
PAGE_MASK
;

841 
	`WARN_ON_ONCE
(1);

844 } i‡(!(
ö_Êag
 & 
CPA_PAGES_ARRAY
)) {

849 i‡(*
addr
 & ~
PAGE_MASK
) {

850 *
addr
 &
PAGE_MASK
;

854 
	`WARN_ON_ONCE
(1);

859 
	`km≠_Êush_unu£d
();

861 
	`vm_unm≠_Æü£s
();

863 
˝a
.
vaddr
 = 
addr
;

864 
˝a
.
∑ges
 =Öages;

865 
˝a
.
num∑ges
 =Çumpages;

866 
˝a
.
mask_£t
 = mask_set;

867 
˝a
.
mask_˛r
 = mask_clr;

868 
˝a
.
Êags
 = 0;

869 
˝a
.
cuΩage
 = 0;

870 
˝a
.
f‹˚_•lô
 = force_split;

872 i‡(
ö_Êag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

873 
˝a
.
Êags
 |
ö_Êag
;

876 
checkÆüs
 = (
	`pg¥Ÿ_vÆ
(
mask_£t
Ë|Ög¥Ÿ_vÆ(
mask_˛r
)Ë!
_PAGE_NX
;

878 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 
checkÆüs
);

883 i‡(!(
˝a
.
Êags
 & 
CPA_FLUSHTLB
))

884 
out
;

890 
ˇche
 = 
	`ˇche_©å
(
mask_£t
);

898 i‡(!
ªt
 && 
˝u_has_˛Êush
) {

899 i‡(
˝a
.
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

900 
	`˝a_Êush_¨øy
(
addr
, 
num∑ges
, 
ˇche
,

901 
˝a
.
Êags
, 
∑ges
);

903 
	`˝a_Êush_ønge
(*
addr
, 
num∑ges
, 
ˇche
);

905 
	`˝a_Êush_Æl
(
ˇche
);

907 
out
:

908  
ªt
;

909 
	}
}

911 
ölöe
 
	$ch™ge_∑ge_©å_£t
(*
addr
, 
num∑ges
,

912 
pg¥Ÿ_t
 
mask
, 
¨øy
)

914  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

915 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

916 
	}
}

918 
ölöe
 
	$ch™ge_∑ge_©å_˛ór
(*
addr
, 
num∑ges
,

919 
pg¥Ÿ_t
 
mask
, 
¨øy
)

921  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

922 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

923 
	}
}

925 
ölöe
 
	$˝a_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

926 
pg¥Ÿ_t
 
mask
)

928  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

929 
CPA_PAGES_ARRAY
, 
∑ges
);

930 
	}
}

932 
ölöe
 
	$˝a_˛ór_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

933 
pg¥Ÿ_t
 
mask
)

935  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

936 
CPA_PAGES_ARRAY
, 
∑ges
);

937 
	}
}

939 
	$_£t_mem‹y_uc
(
addr
, 
num∑ges
)

944  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

945 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

946 
	}
}

948 
	$£t_mem‹y_uc
(
addr
, 
num∑ges
)

950 
ªt
;

955 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

956 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

957 i‡(
ªt
)

958 
out_îr
;

960 
ªt
 = 
	`_£t_mem‹y_uc
(
addr
, 
num∑ges
);

961 i‡(
ªt
)

962 
out_‰ì
;

966 
out_‰ì
:

967 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

968 
out_îr
:

969  
ªt
;

970 
	}
}

971 
EXPORT_SYMBOL
(
£t_mem‹y_uc
);

973 
	$£t_mem‹y_¨øy_uc
(*
addr
, 
addrö¨øy
)

975 
i
, 
j
;

976 
ªt
;

981 
i
 = 0; i < 
addrö¨øy
; i++) {

982 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
,

983 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

984 i‡(
ªt
)

985 
out_‰ì
;

988 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(
addr
, 
addrö¨øy
,

989 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 1);

990 i‡(
ªt
)

991 
out_‰ì
;

995 
out_‰ì
:

996 
j
 = 0; j < 
i
; j++)

997 
	`‰ì_memty≥
(
	`__∑
(
addr
[
j
]), __∑◊ddr[j]Ë+ 
PAGE_SIZE
);

999  
ªt
;

1000 
	}
}

1001 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_uc
);

1003 
	$_£t_mem‹y_wc
(
addr
, 
num∑ges
)

1005 
ªt
;

1006 
addr_c›y
 = 
addr
;

1008 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

1009 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

1010 i‡(!
ªt
) {

1011 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(&
addr_c›y
, 
num∑ges
,

1012 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1013 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1014 0, 0, 
NULL
);

1016  
ªt
;

1017 
	}
}

1019 
	$£t_mem‹y_wc
(
addr
, 
num∑ges
)

1021 
ªt
;

1023 i‡(!
∑t_íabÀd
)

1024  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1026 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

1027 
_PAGE_CACHE_WC
, 
NULL
);

1028 i‡(
ªt
)

1029 
out_îr
;

1031 
ªt
 = 
	`_£t_mem‹y_wc
(
addr
, 
num∑ges
);

1032 i‡(
ªt
)

1033 
out_‰ì
;

1037 
out_‰ì
:

1038 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1039 
out_îr
:

1040  
ªt
;

1041 
	}
}

1042 
EXPORT_SYMBOL
(
£t_mem‹y_wc
);

1044 
	$_£t_mem‹y_wb
(
addr
, 
num∑ges
)

1046  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
,

1047 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 0);

1048 
	}
}

1050 
	$£t_mem‹y_wb
(
addr
, 
num∑ges
)

1052 
ªt
;

1054 
ªt
 = 
	`_£t_mem‹y_wb
(
addr
, 
num∑ges
);

1055 i‡(
ªt
)

1056  
ªt
;

1058 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1060 
	}
}

1061 
EXPORT_SYMBOL
(
£t_mem‹y_wb
);

1063 
	$£t_mem‹y_¨øy_wb
(*
addr
, 
addrö¨øy
)

1065 
i
;

1066 
ªt
;

1068 
ªt
 = 
	`ch™ge_∑ge_©å_˛ór
(
addr
, 
addrö¨øy
,

1069 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 1);

1070 i‡(
ªt
)

1071  
ªt
;

1073 
i
 = 0; i < 
addrö¨øy
; i++)

1074 
	`‰ì_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
);

1077 
	}
}

1078 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wb
);

1080 
	$£t_mem‹y_x
(
addr
, 
num∑ges
)

1082  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1083 
	}
}

1084 
EXPORT_SYMBOL
(
£t_mem‹y_x
);

1086 
	$£t_mem‹y_nx
(
addr
, 
num∑ges
)

1088  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1089 
	}
}

1090 
EXPORT_SYMBOL
(
£t_mem‹y_nx
);

1092 
	$£t_mem‹y_ro
(
addr
, 
num∑ges
)

1094  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1095 
	}
}

1096 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_ro
);

1098 
	$£t_mem‹y_rw
(
addr
, 
num∑ges
)

1100  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1101 
	}
}

1102 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_rw
);

1104 
	$£t_mem‹y_≈
(
addr
, 
num∑ges
)

1106  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_PRESENT
), 0);

1107 
	}
}

1109 
	$£t_mem‹y_4k
(
addr
, 
num∑ges
)

1111  
	`ch™ge_∑ge_©å_£t_˛r
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0),

1112 
	`__pg¥Ÿ
(0), 1, 0, 
NULL
);

1113 
	}
}

1115 
	$£t_∑ges_uc
(
∑ge
 *∑ge, 
num∑ges
)

1117 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1119  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1120 
	}
}

1121 
EXPORT_SYMBOL
(
£t_∑ges_uc
);

1123 
	$£t_∑ges_¨øy_uc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1125 
°¨t
;

1126 
íd
;

1127 
i
;

1128 
‰ì_idx
;

1130 
i
 = 0; i < 
addrö¨øy
; i++) {

1131 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1133 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1134 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1135 i‡(
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
_PAGE_CACHE_UC_MINUS
, 
NULL
))

1136 
îr_out
;

1139 i‡(
	`˝a_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1140 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
)) == 0) {

1143 
îr_out
:

1144 
‰ì_idx
 = 
i
;

1145 
i
 = 0; i < 
‰ì_idx
; i++) {

1146 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1148 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1149 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1150 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1152  -
EINVAL
;

1153 
	}
}

1154 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_uc
);

1156 
	$£t_∑ges_wb
(
∑ge
 *∑ge, 
num∑ges
)

1158 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1160  
	`£t_mem‹y_wb
(
addr
, 
num∑ges
);

1161 
	}
}

1162 
EXPORT_SYMBOL
(
£t_∑ges_wb
);

1164 
	$£t_∑ges_¨øy_wb
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1166 
ªtvÆ
;

1167 
°¨t
;

1168 
íd
;

1169 
i
;

1171 
ªtvÆ
 = 
	`˝a_˛ór_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1172 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
));

1173 i‡(
ªtvÆ
)

1174  
ªtvÆ
;

1176 
i
 = 0; i < 
addrö¨øy
; i++) {

1177 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1179 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1180 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1181 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1185 
	}
}

1186 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wb
);

1188 
	$£t_∑ges_x
(
∑ge
 *∑ge, 
num∑ges
)

1190 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1192  
	`£t_mem‹y_x
(
addr
, 
num∑ges
);

1193 
	}
}

1194 
EXPORT_SYMBOL
(
£t_∑ges_x
);

1196 
	$£t_∑ges_nx
(
∑ge
 *∑ge, 
num∑ges
)

1198 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1200  
	`£t_mem‹y_nx
(
addr
, 
num∑ges
);

1201 
	}
}

1202 
EXPORT_SYMBOL
(
£t_∑ges_nx
);

1204 
	$£t_∑ges_ro
(
∑ge
 *∑ge, 
num∑ges
)

1206 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1208  
	`£t_mem‹y_ro
(
addr
, 
num∑ges
);

1209 
	}
}

1211 
	$£t_∑ges_rw
(
∑ge
 *∑ge, 
num∑ges
)

1213 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1215  
	`£t_mem‹y_rw
(
addr
, 
num∑ges
);

1216 
	}
}

1218 #ifde‡
CONFIG_DEBUG_PAGEALLOC


1220 
	$__£t_∑ges_p
(
∑ge
 *∑ge, 
num∑ges
)

1222 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1223 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1224 .
num∑ges
 =Çumpages,

1225 .
mask_£t
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1226 .
mask_˛r
 = 
	`__pg¥Ÿ
(0),

1227 .
Êags
 = 0};

1235  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1236 
	}
}

1238 
	$__£t_∑ges_≈
(
∑ge
 *∑ge, 
num∑ges
)

1240 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1241 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1242 .
num∑ges
 =Çumpages,

1243 .
mask_£t
 = 
	`__pg¥Ÿ
(0),

1244 .
mask_˛r
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1245 .
Êags
 = 0};

1253  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1254 
	}
}

1256 
	$kî√l_m≠_∑ges
(
∑ge
 *∑ge, 
num∑ges
, 
íabÀ
)

1258 i‡(
	`PageHighMem
(
∑ge
))

1260 i‡(!
íabÀ
) {

1261 
	`debug_check_no_locks_‰ìd
(
	`∑ge_addªss
(
∑ge
),

1262 
num∑ges
 * 
PAGE_SIZE
);

1268 i‡(!
debug_∑góŒoc_íabÀd
)

1276 i‡(
íabÀ
)

1277 
	`__£t_∑ges_p
(
∑ge
, 
num∑ges
);

1279 
	`__£t_∑ges_≈
(
∑ge
, 
num∑ges
);

1285 
	`__Êush_éb_Æl
();

1286 
	}
}

1288 #ifde‡
CONFIG_HIBERNATION


1290 
boﬁ
 
	$kî√l_∑ge_¥e£¡
(
∑ge
 *page)

1292 
Àvñ
;

1293 
±e_t
 *
±e
;

1295 i‡(
	`PageHighMem
(
∑ge
))

1296  
Ál£
;

1298 
±e
 = 
	`lookup_addªss
(()
	`∑ge_addªss
(
∑ge
), &
Àvñ
);

1299  (
	`±e_vÆ
(*
±e
Ë& 
_PAGE_PRESENT
);

1300 
	}
}

1310 #ifde‡
CONFIG_CPA_DEBUG


1311 
	~"∑góâr-ã°.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<löux/£q_fûe.h
>

11 
	~<löux/boŸmem.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/gÂ.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/fs.h
>

19 
	~<asm/ˇcheÊush.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/f˙é.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/mår.h
>

26 
	~<asm/∑ge.h
>

27 
	~<asm/m§.h
>

28 
	~<asm/∑t.h
>

29 
	~<asm/io.h
>

31 #ifde‡
CONFIG_X86_PAT


32 
__ªad_mo°ly
 
	g∑t_íabÀd
 = 1;

34 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

36 
∑t_íabÀd
 = 0;

37 
	`¥ötk
(
KERN_INFO
 "%s\n", 
ªas⁄
);

38 
	}
}

40 
__öô
 
	$n›©
(*
°r
)

42 
	`∑t_dißbÀ
("PAT support disabled.");

44 
	}
}

45 
óæy_∑øm
("n›©", 
n›©
);

47 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

49 ()
ªas⁄
;

50 
	}
}

54 
	gdebug_íabÀ
;

56 
__öô
 
	$∑t_debug_£tup
(*
°r
)

58 
debug_íabÀ
 = 1;

60 
	}
}

61 
__£tup
("debug∑t", 
∑t_debug_£tup
);

63 
	#d¥ötk
(
fmt
, 
¨g
...) \

64 dÿ{ i‡(
debug_íabÀ
Ë
	`¥ötk
(
KERN_INFO
 
fmt
, ##
¨g
); } 0)

	)

67 
u64
 
__ªad_mo°ly
 
	gboŸ_∑t_°©e
;

70 
	mPAT_UC
 = 0,

71 
	mPAT_WC
 = 1,

72 
	mPAT_WT
 = 4,

73 
	mPAT_WP
 = 5,

74 
	mPAT_WB
 = 6,

75 
	mPAT_UC_MINUS
 = 7,

78 
	#PAT
(
x
, 
y
Ë((
u64
)
PAT_
 ## y << ((x)*8))

	)

80 
	$∑t_öô
()

82 
u64
 
∑t
;

84 i‡(!
∑t_íabÀd
)

87 i‡(!
˝u_has_∑t
) {

88 i‡(!
boŸ_∑t_°©e
) {

89 
	`∑t_dißbÀ
("PATÇot supported by CPU.");

97 
	`¥ötk
(
KERN_ERR
 "PATÉnabled, "

99 
	`BUG
();

116 
∑t
 = 
	`PAT
(0, 
WB
Ë| PAT(1, 
WC
Ë| PAT(2, 
UC_MINUS
Ë| PAT(3, 
UC
) |

117 
	`PAT
(4, 
WB
Ë| PAT(5, 
WC
Ë| PAT(6, 
UC_MINUS
Ë| PAT(7, 
UC
);

120 i‡(!
boŸ_∑t_°©e
)

121 
	`rdm§l
(
MSR_IA32_CR_PAT
, 
boŸ_∑t_°©e
);

123 
	`wrm§l
(
MSR_IA32_CR_PAT
, 
∑t
);

124 
	`¥ötk
(
KERN_INFO
 "x86 PATÉnabled: cpu %d, old 0x%Lx,Çew 0x%Lx\n",

125 
	`smp_¥o˚ss‹_id
(), 
boŸ_∑t_°©e
, 
∑t
);

126 
	}
}

128 #unde‡
PAT


130 *
	$ˇâr_«me
(
Êags
)

132 
Êags
 & 
_PAGE_CACHE_MASK
) {

133 
_PAGE_CACHE_UC
:  "uncached";

134 
_PAGE_CACHE_UC_MINUS
:  "uncached-minus";

135 
_PAGE_CACHE_WB
:  "write-back";

136 
_PAGE_CACHE_WC
:  "write-combining";

139 
	}
}

158 
	smemty≥
 {

159 
u64
 
	m°¨t
;

160 
u64
 
	míd
;

161 
	mty≥
;

162 
li°_hód
 
	mnd
;

165 
LIST_HEAD
(
memty≥_li°
);

166 
DEFINE_SPINLOCK
(
memty≥_lock
);

175 
	$∑t_x_mår_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
)

181 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WB
) {

182 
u8
 
mår_ty≥
;

184 
mår_ty≥
 = 
	`mår_ty≥_lookup
(
°¨t
, 
íd
);

185 i‡(
mår_ty≥
 !
MTRR_TYPE_WRBACK
)

186  
_PAGE_CACHE_UC_MINUS
;

188  
_PAGE_CACHE_WB
;

191  
ªq_ty≥
;

192 
	}
}

195 
	$chk_c⁄Êi˘
(
memty≥
 *
√w
, memty≥ *
íåy
, *
ty≥
)

197 i‡(
√w
->
ty≥
 !
íåy
->type) {

198 i‡(
ty≥
) {

199 
√w
->
ty≥
 = 
íåy
->type;

200 *
ty≥
 = 
íåy
->type;

202 
c⁄Êi˘
;

206 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
, &
memty≥_li°
, 
nd
) {

207 i‡(
√w
->
íd
 <
íåy
->
°¨t
)

209 i‡(
√w
->
ty≥
 !
íåy
->type)

210 
c⁄Êi˘
;

214 
c⁄Êi˘
:

215 
	`¥ötk
(
KERN_INFO
 "%s:%d conflicting memoryÅypes "

216 "%Lx-%Lx %s<->%s\n", 
cuºít
->
comm
, cuºít->
pid
, 
√w
->
°¨t
,

217 
√w
->
íd
, 
	`ˇâr_«me
“ew->
ty≥
), c©å_«me(
íåy
->type));

218  -
EBUSY
;

219 
	}
}

221 
memty≥
 *
	gˇched_íåy
;

222 
u64
 
	gˇched_°¨t
;

224 
	$∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
)

226 
øm_∑ge
 = 0, 
nŸ_øm∑ge
 = 0;

227 
∑ge_ƒ
;

229 
∑ge_ƒ
 = (
°¨t
 >> 
PAGE_SHIFT
);Öage_ƒ < (
íd
 >> PAGE_SHIFT);

230 ++
∑ge_ƒ
) {

238 i‡(
∑ge_ƒ
 >(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

239 
	`∑ge_is_øm
(
∑ge_ƒ
))

240 
øm_∑ge
 = 1;

242 
nŸ_øm∑ge
 = 1;

244 i‡(
øm_∑ge
 =
nŸ_øm∑ge
)

248  
øm_∑ge
;

249 
	}
}

263 
	$ª£rve_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

264 *
√w_ty≥
)

266 
∑ge
 *page;

267 
u64
 
p‚
, 
íd_p‚
;

269 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

270 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

271 i‡(
	`∑ge_m≠≥d
(
∑ge
Ë|| 
	`PageN⁄WB
(page))

272 
out
;

274 
	`SëPageN⁄WB
(
∑ge
);

278 
out
:

279 
íd_p‚
 = 
p‚
;

280 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < 
íd_p‚
; ++pfn) {

281 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

282 
	`CÀ¨PageN⁄WB
(
∑ge
);

285  -
EINVAL
;

286 
	}
}

288 
	$‰ì_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
)

290 
∑ge
 *page;

291 
u64
 
p‚
, 
íd_p‚
;

293 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

294 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

295 i‡(
	`∑ge_m≠≥d
(
∑ge
Ë|| !
	`PageN⁄WB
(page))

296 
out
;

298 
	`CÀ¨PageN⁄WB
(
∑ge
);

302 
out
:

303 
íd_p‚
 = 
p‚
;

304 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < 
íd_p‚
; ++pfn) {

305 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

306 
	`SëPageN⁄WB
(
∑ge
);

308  -
EINVAL
;

309 
	}
}

326 
	$ª£rve_memty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

327 *
√w_ty≥
)

329 
memty≥
 *
√w
, *
íåy
;

330 
a˘uÆ_ty≥
;

331 
li°_hód
 *
whîe
;

332 
is_ønge_øm
;

333 
îr
 = 0;

335 
	`BUG_ON
(
°¨t
 >
íd
);

337 i‡(!
∑t_íabÀd
) {

339 i‡(
√w_ty≥
) {

340 i‡(
ªq_ty≥
 == -1)

341 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

343 *
√w_ty≥
 = 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
;

349 i‡(
	`is_ISA_ønge
(
°¨t
, 
íd
 - 1)) {

350 i‡(
√w_ty≥
)

351 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

361 
a˘uÆ_ty≥
 = 
	`∑t_x_mår_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
);

363 i‡(
√w_ty≥
)

364 *
√w_ty≥
 = 
a˘uÆ_ty≥
;

366 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

367 i‡(
is_ønge_øm
 == 1)

368  
	`ª£rve_øm_∑ges_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
,

369 
√w_ty≥
);

370 i‡(
is_ønge_øm
 < 0)

371  -
EINVAL
;

373 
√w
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

374 i‡(!
√w
)

375  -
ENOMEM
;

377 
√w
->
°¨t
 = start;

378 
√w
->
íd
 =Énd;

379 
√w
->
ty≥
 = 
a˘uÆ_ty≥
;

381 
	`•ö_lock
(&
memty≥_lock
);

383 i‡(
ˇched_íåy
 && 
°¨t
 >
ˇched_°¨t
)

384 
íåy
 = 
ˇched_íåy
;

386 
íåy
 = 
	`li°_íåy
(&
memty≥_li°
, 
memty≥
, 
nd
);

389 
whîe
 = 
NULL
;

390 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
, &
memty≥_li°
, 
nd
) {

391 i‡(
íd
 <
íåy
->
°¨t
) {

392 
whîe
 = 
íåy
->
nd
.
¥ev
;

393 
ˇched_íåy
 = 
	`li°_íåy
(
whîe
, 
memty≥
, 
nd
);

395 } i‡(
°¨t
 <
íåy
->start) {

396 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

397 i‡(!
îr
) {

398 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

399 
íåy
->
°¨t
,É¡ry->
íd
);

400 
whîe
 = 
íåy
->
nd
.
¥ev
;

401 
ˇched_íåy
 = 
	`li°_íåy
(
whîe
,

402 
memty≥
, 
nd
);

405 } i‡(
°¨t
 < 
íåy
->
íd
) {

406 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

407 i‡(!
îr
) {

408 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

409 
íåy
->
°¨t
,É¡ry->
íd
);

410 
ˇched_íåy
 = 
	`li°_íåy
(
íåy
->
nd
.
¥ev
,

411 
memty≥
, 
nd
);

417 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
,

418 &
memty≥_li°
, 
nd
) {

419 i‡(
°¨t
 <
íåy
->start) {

420 
whîe
 = 
íåy
->
nd
.
¥ev
;

429 i‡(
îr
) {

430 
	`¥ötk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

432 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
));

433 
	`k‰ì
(
√w
);

434 
	`•ö_u∆ock
(&
memty≥_lock
);

436  
îr
;

439 
ˇched_°¨t
 = 
°¨t
;

441 i‡(
whîe
)

442 
	`li°_add
(&
√w
->
nd
, 
whîe
);

444 
	`li°_add_èû
(&
√w
->
nd
, &
memty≥_li°
);

446 
	`•ö_u∆ock
(&
memty≥_lock
);

448 
	`d¥ötk
("reserve_memtypeádded 0x%Lx-0x%Lx,Årack %s,Ñeq %s,Ñet %s\n",

449 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
),

450 
√w_ty≥
 ? 
	`ˇâr_«me
(*new_type) : "-");

452  
îr
;

453 
	}
}

455 
	$‰ì_memty≥
(
u64
 
°¨t
, u64 
íd
)

457 
memty≥
 *
íåy
;

458 
îr
 = -
EINVAL
;

459 
is_ønge_øm
;

461 i‡(!
∑t_íabÀd
)

465 i‡(
	`is_ISA_ønge
(
°¨t
, 
íd
 - 1))

468 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

469 i‡(
is_ønge_øm
 == 1)

470  
	`‰ì_øm_∑ges_ty≥
(
°¨t
, 
íd
);

471 i‡(
is_ønge_øm
 < 0)

472  -
EINVAL
;

474 
	`•ö_lock
(&
memty≥_lock
);

475 
	`li°_f‹_óch_íåy
(
íåy
, &
memty≥_li°
, 
nd
) {

476 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

477 i‡(
ˇched_íåy
 =
íåy
 || 
ˇched_°¨t
 =
°¨t
)

478 
ˇched_íåy
 = 
NULL
;

480 
	`li°_dñ
(&
íåy
->
nd
);

481 
	`k‰ì
(
íåy
);

482 
îr
 = 0;

486 
	`•ö_u∆ock
(&
memty≥_lock
);

488 i‡(
îr
) {

489 
	`¥ötk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

490 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
, 
íd
);

493 
	`d¥ötk
("‰ì_memty≥Ñeque° 0x%Lx-0x%Lx\n", 
°¨t
, 
íd
);

495  
îr
;

496 
	}
}

499 
pg¥Ÿ_t
 
	$phys_mem_ac˚ss_¥Ÿ
(
fûe
 *fûe, 
p‚
,

500 
size
, 
pg¥Ÿ_t
 
vma_¥Ÿ
)

502  
vma_¥Ÿ
;

503 
	}
}

505 #ifde‡
CONFIG_STRICT_DEVMEM


507 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

510 
	}
}

513 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

515 
u64
 
‰om
 = ((u64)
p‚
Ë<< 
PAGE_SHIFT
;

516 
u64
 
to
 = 
‰om
 + 
size
;

517 
u64
 
curs‹
 = 
‰om
;

519 i‡(!
∑t_íabÀd
)

522 
curs‹
 < 
to
) {

523 i‡(!
	`devmem_is_Ælowed
(
p‚
)) {

524 
	`¥ötk
(
KERN_INFO


526 
cuºít
->
comm
, 
‰om
, 
to
);

529 
curs‹
 +
PAGE_SIZE
;

530 
p‚
++;

533 
	}
}

536 
	$phys_mem_ac˚ss_¥Ÿ_Ælowed
(
fûe
 *fûe, 
p‚
,

537 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
)

539 
Êags
 = 
_PAGE_CACHE_WB
;

541 i‡(!
	`ønge_is_Ælowed
(
p‚
, 
size
))

544 i‡(
fûe
->
f_Êags
 & 
O_SYNC
) {

545 
Êags
 = 
_PAGE_CACHE_UC_MINUS
;

548 #ifde‡
CONFIG_X86_32


557 i‡(!
∑t_íabÀd
 &&

558 !(
	`boŸ_˝u_has
(
X86_FEATURE_MTRR
) ||

559 
	`boŸ_˝u_has
(
X86_FEATURE_K6_MTRR
) ||

560 
	`boŸ_˝u_has
(
X86_FEATURE_CYRIX_ARR
) ||

561 
	`boŸ_˝u_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

562 (
p‚
 << 
PAGE_SHIFT
Ë>
	`__∑
(
high_mem‹y
)) {

563 
Êags
 = 
_PAGE_CACHE_UC
;

567 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_¥ŸË& ~
_PAGE_CACHE_MASK
) |

568 
Êags
);

570 
	}
}

576 
	$kî√l_m≠_sync_memty≥
(
u64
 
ba£
, 
size
, 
Êags
)

578 
id_sz
;

580 i‡(!
∑t_íabÀd
 || 
ba£
 >
	`__∑
(
high_mem‹y
))

583 
id_sz
 = (
	`__∑
(
high_mem‹y
Ë< 
ba£
 + 
size
) ?

584 
	`__∑
(
high_mem‹y
Ë- 
ba£
 :

585 
size
;

587 i‡(
	`i‹em≠_ch™ge_©å
(()
	`__va
(
ba£
), 
id_sz
, 
Êags
) < 0) {

588 
	`¥ötk
(
KERN_INFO


591 
cuºít
->
comm
, cuºít->
pid
,

592 
	`ˇâr_«me
(
Êags
),

593 
ba£
, ()(ba£ + 
size
));

594  -
EINVAL
;

597 
	}
}

604 
	$ª£rve_p‚_ønge
(
u64
 
∑ddr
, 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
,

605 
°ri˘_¥Ÿ
)

607 
is_øm
 = 0;

608 
ªt
;

609 
w™t_Êags
 = (
	`pg¥Ÿ_vÆ
(*
vma_¥Ÿ
Ë& 
_PAGE_CACHE_MASK
);

610 
Êags
 = 
w™t_Êags
;

612 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

618 i‡(
is_øm
 != 0)

621 
ªt
 = 
	`ª£rve_memty≥
(
∑ddr
,Öadd∏+ 
size
, 
w™t_Êags
, &
Êags
);

622 i‡(
ªt
)

623  
ªt
;

625 i‡(
Êags
 !
w™t_Êags
) {

626 i‡(
°ri˘_¥Ÿ
 ||

627 !
	`is_√w_memty≥_Ælowed
(
∑ddr
, 
size
, 
w™t_Êags
, 
Êags
)) {

628 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

629 
	`¥ötk
(
KERN_ERR
 "%s:%d mapÖfnÉxpected mappingÅype %s"

631 
cuºít
->
comm
, cuºít->
pid
,

632 
	`ˇâr_«me
(
w™t_Êags
),

633 ()
∑ddr
,

634 ()(
∑ddr
 + 
size
),

635 
	`ˇâr_«me
(
Êags
));

636  -
EINVAL
;

642 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

643 (~
_PAGE_CACHE_MASK
)) |

644 
Êags
);

647 i‡(
	`kî√l_m≠_sync_memty≥
(
∑ddr
, 
size
, 
Êags
) < 0) {

648 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

649  -
EINVAL
;

652 
	}
}

658 
	$‰ì_p‚_ønge
(
u64
 
∑ddr
, 
size
)

660 
is_øm
;

662 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

663 i‡(
is_øm
 == 0)

664 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

665 
	}
}

674 
	$åack_p‚_vma_c›y
(
vm_¨ó_°ru˘
 *
vma
)

676 
ªsour˚_size_t
 
∑ddr
;

677 
¥Ÿ
;

678 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

679 
pg¥Ÿ_t
 
pg¥Ÿ
;

681 i‡(!
∑t_íabÀd
)

689 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

694 i‡(
	`fﬁlow_phys
(
vma
, vma->
vm_°¨t
, 0, &
¥Ÿ
, &
∑ddr
)) {

695 
	`WARN_ON_ONCE
(1);

696  -
EINVAL
;

698 
pg¥Ÿ
 = 
	`__pg¥Ÿ
(
¥Ÿ
);

699  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, &
pg¥Ÿ
, 1);

703 
	}
}

713 
	$åack_p‚_vma_√w
(
vm_¨ó_°ru˘
 *
vma
, 
pg¥Ÿ_t
 *
¥Ÿ
,

714 
p‚
, 
size
)

716 
ªsour˚_size_t
 
∑ddr
;

717 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

719 i‡(!
∑t_íabÀd
)

727 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

729 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

730  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, 
¥Ÿ
, 0);

734 
	}
}

741 
	$u¡øck_p‚_vma
(
vm_¨ó_°ru˘
 *
vma
, 
p‚
,

742 
size
)

744 
ªsour˚_size_t
 
∑ddr
;

745 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

747 i‡(!
∑t_íabÀd
)

755 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

757 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

758 
	`‰ì_p‚_ønge
(
∑ddr
, 
vma_size
);

761 
	}
}

763 
pg¥Ÿ_t
 
	$pg¥Ÿ_wrôecomböe
(
pg¥Ÿ_t
 
¥Ÿ
)

765 i‡(
∑t_íabÀd
)

766  
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_CACHE_WC
);

768  
	`pg¥Ÿ_n⁄ˇched
(
¥Ÿ
);

769 
	}
}

770 
EXPORT_SYMBOL_GPL
(
pg¥Ÿ_wrôecomböe
);

772 #i‡
deföed
(
CONFIG_DEBUG_FS
Ë&& deföed(
CONFIG_X86_PAT
)

775 
memty≥
 *
	$memty≥_gë_idx
(
loff_t
 
pos
)

777 
memty≥
 *
li°_node
, *
¥öt_íåy
;

778 
i
 = 1;

780 
¥öt_íåy
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

781 i‡(!
¥öt_íåy
)

782  
NULL
;

784 
	`•ö_lock
(&
memty≥_lock
);

785 
	`li°_f‹_óch_íåy
(
li°_node
, &
memty≥_li°
, 
nd
) {

786 i‡(
pos
 =
i
) {

787 *
¥öt_íåy
 = *
li°_node
;

788 
	`•ö_u∆ock
(&
memty≥_lock
);

789  
¥öt_íåy
;

791 ++
i
;

793 
	`•ö_u∆ock
(&
memty≥_lock
);

794 
	`k‰ì
(
¥öt_íåy
);

796  
NULL
;

797 
	}
}

799 *
	$memty≥_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

801 i‡(*
pos
 == 0) {

802 ++*
pos
;

803 
	`£q_¥ötf
(
£q
, "PAT memtypeÜist:\n");

806  
	`memty≥_gë_idx
(*
pos
);

807 
	}
}

809 *
	$memty≥_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

811 ++*
pos
;

812  
	`memty≥_gë_idx
(*
pos
);

813 
	}
}

815 
	$memty≥_£q_°›
(
£q_fûe
 *
£q
, *
v
)

817 
	}
}

819 
	$memty≥_£q_show
(
£q_fûe
 *
£q
, *
v
)

821 
memty≥
 *
¥öt_íåy
 = (memty≥ *)
v
;

823 
	`£q_¥ötf
(
£q
, "%†@ 0x%Lx-0x%Lx\n", 
	`ˇâr_«me
(
¥öt_íåy
->
ty≥
),

824 
¥öt_íåy
->
°¨t
,Öröt_íåy->
íd
);

825 
	`k‰ì
(
¥öt_íåy
);

828 
	}
}

830 
£q_›î©i⁄s
 
	gmemty≥_£q_›s
 = {

831 .
°¨t
 = 
memty≥_£q_°¨t
,

832 .
	g√xt
 = 
memty≥_£q_√xt
,

833 .
	g°›
 = 
memty≥_£q_°›
,

834 .
	gshow
 = 
memty≥_£q_show
,

837 
	$memty≥_£q_›í
(
öode
 *öode, 
fûe
 *file)

839  
	`£q_›í
(
fûe
, &
memty≥_£q_›s
);

840 
	}
}

842 c⁄° 
fûe_›î©i⁄s
 
	gmemty≥_f›s
 = {

843 .
›í
 = 
memty≥_£q_›í
,

844 .
	gªad
 = 
£q_ªad
,

845 .
	gŒ£ek
 = 
£q_l£ek
,

846 .
	gªÀa£
 = 
£q_ªÀa£
,

849 
__öô
 
	$∑t_memty≥_li°_öô
()

851 
	`debugfs_¸óã_fûe
("∑t_memty≥_li°", 
S_IRUSR
, 
¨ch_debugfs_dú
,

852 
NULL
, &
memty≥_f›s
);

854 
	}
}

856 
œã_öôˇŒ
(
∑t_memty≥_li°_öô
);

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<löux/mm.h
>

2 
	~<asm/pgÆloc.h
>

3 
	~<asm/pgèbÀ.h
>

4 
	~<asm/éb.h
>

5 
	~<asm/fixm≠.h
>

7 
	#PGALLOC_GFP
 
GFP_KERNEL
 | 
__GFP_NOTRACK
 | 
__GFP_REPEAT
 | 
__GFP_ZERO


	)

9 
±e_t
 *
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

11  (
±e_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

12 
	}
}

14 
pgèbÀ_t
 
	$±e_Æloc_⁄e
(
mm_°ru˘
 *
mm
, 
addªss
)

16 
∑ge
 *
±e
;

18 #ifde‡
CONFIG_HIGHPTE


19 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
 | 
__GFP_HIGHMEM
, 0);

21 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
, 0);

23 i‡(
±e
)

24 
	`pgèbÀ_∑ge_˘‹
(
±e
);

25  
±e
;

26 
	}
}

28 
	$___±e_‰ì_éb
(
mmu_g©hî
 *
éb
, 
∑ge
 *
±e
)

30 
	`pgèbÀ_∑ge_dt‹
(
±e
);

31 
	`∑øvút_ªÀa£_±e
(
	`∑ge_to_p‚
(
±e
));

32 
	`éb_ªmove_∑ge
(
éb
, 
±e
);

33 
	}
}

35 #i‡
PAGETABLE_LEVELS
 > 2

36 
	$___pmd_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pmd_t
 *
pmd
)

38 
	`∑øvút_ªÀa£_pmd
(
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

39 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pmd
));

40 
	}
}

42 #i‡
PAGETABLE_LEVELS
 > 3

43 
	$___pud_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pud_t
 *
pud
)

45 
	`∑øvút_ªÀa£_pud
(
	`__∑
(
pud
Ë>> 
PAGE_SHIFT
);

46 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pud
));

47 
	}
}

51 
ölöe
 
	$pgd_li°_add
(
pgd_t
 *
pgd
)

53 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

55 
	`li°_add
(&
∑ge
->
Ãu
, &
pgd_li°
);

56 
	}
}

58 
ölöe
 
	$pgd_li°_dñ
(
pgd_t
 *
pgd
)

60 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

62 
	`li°_dñ
(&
∑ge
->
Ãu
);

63 
	}
}

65 
	#UNSHARED_PTRS_PER_PGD
 \

66 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

68 
	$pgd_˘‹
(
pgd_t
 *
pgd
)

73 i‡(
PAGETABLE_LEVELS
 == 2 ||

74 (
PAGETABLE_LEVELS
 =3 && 
SHARED_KERNEL_PMD
) ||

75 
PAGETABLE_LEVELS
 == 4) {

76 
	`˛⁄e_pgd_ønge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

77 
sw≠≥r_pg_dú
 + 
KERNEL_PGD_BOUNDARY
,

78 
KERNEL_PGD_PTRS
);

79 
	`∑øvút_Æloc_pmd_˛⁄e
(
	`__∑
(
pgd
Ë>> 
PAGE_SHIFT
,

80 
	`__∑
(
sw≠≥r_pg_dú
Ë>> 
PAGE_SHIFT
,

81 
KERNEL_PGD_BOUNDARY
,

82 
KERNEL_PGD_PTRS
);

86 i‡(!
SHARED_KERNEL_PMD
)

87 
	`pgd_li°_add
(
pgd
);

88 
	}
}

90 
	$pgd_dt‹
(
pgd_t
 *
pgd
)

92 
Êags
;

94 i‡(
SHARED_KERNEL_PMD
)

97 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

98 
	`pgd_li°_dñ
(
pgd
);

99 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

100 
	}
}

113 #ifde‡
CONFIG_X86_PAE


125 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

127 
	$pud_p›uœã
(
mm_°ru˘
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

129 
	`∑øvút_Æloc_pmd
(
mm
, 
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

133 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_PAGE_PRESENT
));

141 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

142 
	`wrôe_¸3
(
	`ªad_¸3
());

143 
	}
}

147 
	#PREALLOCATED_PMDS
 0

	)

151 
	$‰ì_pmds
(
pmd_t
 *
pmds
[])

153 
i
;

155 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

156 i‡(
pmds
[
i
])

157 
	`‰ì_∑ge
(()
pmds
[
i
]);

158 
	}
}

160 
	$¥óŒoˇã_pmds
(
pmd_t
 *
pmds
[])

162 
i
;

163 
boﬁ
 
Áûed
 = 
Ál£
;

165 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

166 
pmd_t
 *
pmd
 = (pmd_à*)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

167 i‡(
pmd
 =
NULL
)

168 
Áûed
 = 
åue
;

169 
pmds
[
i
] = 
pmd
;

172 i‡(
Áûed
) {

173 
	`‰ì_pmds
(
pmds
);

174  -
ENOMEM
;

178 
	}
}

186 
	$pgd_m›_up_pmds
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgdp
)

188 
i
;

190 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

191 
pgd_t
 
pgd
 = 
pgdp
[
i
];

193 i‡(
	`pgd_vÆ
(
pgd
) != 0) {

194 
pmd_t
 *
pmd
 = (pmd_à*)
	`pgd_∑ge_vaddr
(
pgd
);

196 
pgdp
[
i
] = 
	`«tive_make_pgd
(0);

198 
	`∑øvút_ªÀa£_pmd
(
	`pgd_vÆ
(
pgd
Ë>> 
PAGE_SHIFT
);

199 
	`pmd_‰ì
(
mm
, 
pmd
);

202 
	}
}

204 
	$pgd_¥ï›uœã_pmd
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

206 
pud_t
 *
pud
;

207 
addr
;

208 
i
;

210 i‡(
PREALLOCATED_PMDS
 == 0)

213 
pud
 = 
	`pud_off£t
(
pgd
, 0);

215 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

216 
i
++, 
pud
++, 
addr
 +
PUD_SIZE
) {

217 
pmd_t
 *
pmd
 = 
pmds
[
i
];

219 i‡(
i
 >
KERNEL_PGD_BOUNDARY
)

220 
	`mem˝y
(
pmd
, (
pmd_t
 *)
	`pgd_∑ge_vaddr
(
sw≠≥r_pg_dú
[
i
]),

221 (
pmd_t
Ë* 
PTRS_PER_PMD
);

223 
	`pud_p›uœã
(
mm
, 
pud
, 
pmd
);

225 
	}
}

227 
pgd_t
 *
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

229 
pgd_t
 *
pgd
;

230 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

231 
Êags
;

233 
pgd
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

235 i‡(
pgd
 =
NULL
)

236 
out
;

238 
mm
->
pgd
 =Ögd;

240 i‡(
	`¥óŒoˇã_pmds
(
pmds
) != 0)

241 
out_‰ì_pgd
;

243 i‡(
	`∑øvút_pgd_Æloc
(
mm
) != 0)

244 
out_‰ì_pmds
;

251 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

253 
	`pgd_˘‹
(
pgd
);

254 
	`pgd_¥ï›uœã_pmd
(
mm
, 
pgd
, 
pmds
);

256 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

258  
pgd
;

260 
out_‰ì_pmds
:

261 
	`‰ì_pmds
(
pmds
);

262 
out_‰ì_pgd
:

263 
	`‰ì_∑ge
(()
pgd
);

264 
out
:

265  
NULL
;

266 
	}
}

268 
	$pgd_‰ì
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
)

270 
	`pgd_m›_up_pmds
(
mm
, 
pgd
);

271 
	`pgd_dt‹
(
pgd
);

272 
	`∑øvút_pgd_‰ì
(
mm
, 
pgd
);

273 
	`‰ì_∑ge
(()
pgd
);

274 
	}
}

276 
	$±ï_£t_ac˚ss_Êags
(
vm_¨ó_°ru˘
 *
vma
,

277 
addªss
, 
±e_t
 *
±ï
,

278 
±e_t
 
íåy
, 
dúty
)

280 
ch™ged
 = !
	`±e_ßme
(*
±ï
, 
íåy
);

282 i‡(
ch™ged
 && 
dúty
) {

283 *
±ï
 = 
íåy
;

284 
	`±e_upd©e_de„r
(
vma
->
vm_mm
, 
addªss
, 
±ï
);

285 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

288  
ch™ged
;

289 
	}
}

291 
	$±ï_ã°_™d_˛ór_young
(
vm_¨ó_°ru˘
 *
vma
,

292 
addr
, 
±e_t
 *
±ï
)

294 
ªt
 = 0;

296 i‡(
	`±e_young
(*
±ï
))

297 
ªt
 = 
	`ã°_™d_˛ór_bô
(
_PAGE_BIT_ACCESSED
,

298 (*Ë&
±ï
->
±e
);

300 i‡(
ªt
)

301 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±ï
);

303  
ªt
;

304 
	}
}

306 
	$±ï_˛ór_Êush_young
(
vm_¨ó_°ru˘
 *
vma
,

307 
addªss
, 
±e_t
 *
±ï
)

309 
young
;

311 
young
 = 
	`±ï_ã°_™d_˛ór_young
(
vma
, 
addªss
, 
±ï
);

312 i‡(
young
)

313 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

315  
young
;

316 
	}
}

325 
__öô
 
	$ª£rve_t›_addªss
(
ª£rve
)

327 #ifde‡
CONFIG_X86_32


328 
	`BUG_ON
(
fixm≠s_£t
 > 0);

329 
	`¥ötk
(
KERN_INFO
 "Reserving virtualáddress spaceábove 0x%08x\n",

330 ()-
ª£rve
);

331 
__FIXADDR_TOP
 = -
ª£rve
 - 
PAGE_SIZE
;

333 
	}
}

335 
	gfixm≠s_£t
;

337 
	$__«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
±e_t
 
±e
)

339 
addªss
 = 
	`__fix_to_vút
(
idx
);

341 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

342 
	`BUG
();

345 
	`£t_±e_vaddr
(
addªss
, 
±e
);

346 
fixm≠s_£t
++;

347 
	}
}

349 
	$«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
phys_addr_t
 
phys
,

350 
pg¥Ÿ_t
 
Êags
)

352 
	`__«tive_£t_fixm≠
(
idx
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

353 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/mmz⁄e.h
>

15 
	~<löux/bôm≠.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/t›ﬁogy.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/mm.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/uv/uv.h
>

26 
a˝i_numa
 
	g__öôd©a
;

28 
a˝i_èbÀ_¶ô
 *
	ga˝i_¶ô
;

30 
nodemask_t
 
nodes_∑r£d
 
	g__öôd©a
;

31 
nodemask_t
 
˝u_nodes_∑r£d
 
	g__öôd©a
;

32 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

33 
boŸnode
 
	gnodes_add
[
MAX_NUMNODES
];

35 
num_node_memblks
 
	g__öôd©a
;

36 
boŸnode
 
	gnode_memblk_ønge
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

37 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

39 
__öô
 
	$£tup_node
(
pxm
)

41  
	`a˝i_m≠_pxm_to_node
(
pxm
);

42 
	}
}

44 
__öô
 
	$c⁄Êi˘ög_memblks
(
°¨t
, 
íd
)

46 
i
;

47 
i
 = 0; i < 
num_node_memblks
; i++) {

48 
boŸnode
 *
nd
 = &
node_memblk_ønge
[
i
];

49 i‡(
nd
->
°¨t
 =nd->
íd
)

51 i‡(
nd
->
íd
 > 
°¨t
 &&Çd->start <Énd)

52  
memblk_nodeid
[
i
];

53 i‡(
nd
->
íd
 =íd &&Çd->
°¨t
 == start)

54  
memblk_nodeid
[
i
];

57 
	}
}

59 
__öô
 
	$cutoff_node
(
i
, 
°¨t
, 
íd
)

61 
boŸnode
 *
nd
 = &
nodes
[
i
];

63 i‡(
nd
->
°¨t
 < start) {

64 
nd
->
°¨t
 = start;

65 i‡(
nd
->
íd
 <Çd->
°¨t
)

66 
nd
->
°¨t
 =Çd->
íd
;

68 i‡(
nd
->
íd
 >Énd) {

69 
nd
->
íd
 =Énd;

70 i‡(
nd
->
°¨t
 >Çd->
íd
)

71 
nd
->
°¨t
 =Çd->
íd
;

73 
	}
}

75 
__öô
 
	$bad_§©
()

77 
i
;

78 
	`¥ötk
(
KERN_ERR
 "SRAT: SRATÇot used.\n");

79 
a˝i_numa
 = -1;

80 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

81 
≠icid_to_node
[
i
] = 
NUMA_NO_NODE
;

82 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

83 
nodes
[
i
].
°¨t
 =Çodes[i].
íd
 = 0;

84 
nodes_add
[
i
].
°¨t
 =Çodes_add[i].
íd
 = 0;

86 
	`ªmove_Æl_a˘ive_ønges
();

87 
	}
}

89 
__öô
 
ölöe
 
	$§©_dißbÀd
()

91  
numa_off
 || 
a˝i_numa
 < 0;

92 
	}
}

95 
__öô
 
	$a˝i_numa_¶ô_öô
(
a˝i_èbÀ_¶ô
 *
¶ô
)

97 
Àngth
;

98 
phys
;

100 
Àngth
 = 
¶ô
->
hódî
.length;

101 
phys
 = 
	`föd_e820_¨ó
(0, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
, 
Àngth
,

102 
PAGE_SIZE
);

104 i‡(
phys
 == -1L)

105 
	`∑nic
(" CanÇot save slit!\n");

107 
a˝i_¶ô
 = 
	`__va
(
phys
);

108 
	`mem˝y
(
a˝i_¶ô
, 
¶ô
, 
Àngth
);

109 
	`ª£rve_óæy
(
phys
,Öhy†+ 
Àngth
, "ACPI SLIT");

110 
	}
}

113 
__öô


114 
	$a˝i_numa_x2≠ic_afföôy_öô
(
a˝i_§©_x2≠ic_˝u_afföôy
 *
∑
)

116 
pxm
, 
node
;

117 
≠ic_id
;

119 i‡(
	`§©_dißbÀd
())

121 i‡(
∑
->
hódî
.
Àngth
 < (
a˝i_§©_x2≠ic_˝u_afföôy
)) {

122 
	`bad_§©
();

125 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

127 
pxm
 = 
∑
->
¥oximôy_domaö
;

128 
node
 = 
	`£tup_node
(
pxm
);

129 i‡(
node
 < 0) {

130 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

131 
	`bad_§©
();

135 
≠ic_id
 = 
∑
->apic_id;

136 
≠icid_to_node
[
≠ic_id
] = 
node
;

137 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

138 
a˝i_numa
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

140 
pxm
, 
≠ic_id
, 
node
);

141 
	}
}

144 
__öô


145 
	$a˝i_numa_¥o˚ss‹_afföôy_öô
(
a˝i_§©_˝u_afföôy
 *
∑
)

147 
pxm
, 
node
;

148 
≠ic_id
;

150 i‡(
	`§©_dißbÀd
())

152 i‡(
∑
->
hódî
.
Àngth
 !(
a˝i_§©_˝u_afföôy
)) {

153 
	`bad_§©
();

156 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

158 
pxm
 = 
∑
->
¥oximôy_domaö_lo
;

159 
node
 = 
	`£tup_node
(
pxm
);

160 i‡(
node
 < 0) {

161 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

162 
	`bad_§©
();

166 i‡(
	`gë_uv_sy°em_ty≥
(Ë>
UV_X2APIC
)

167 
≠ic_id
 = (
∑
->≠ic_id << 8Ë|Öa->
loˇl_ßpic_eid
;

169 
≠ic_id
 = 
∑
->apic_id;

170 
≠icid_to_node
[
≠ic_id
] = 
node
;

171 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

172 
a˝i_numa
 = 1;

173 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

174 
pxm
, 
≠ic_id
, 
node
);

175 
	}
}

177 #ifde‡
CONFIG_MEMORY_HOTPLUG_SPARSE


178 
ölöe
 
	$ßve_add_öfo
(Ë{ 1;
	}
}

180 
ölöe
 
	$ßve_add_öfo
(Ë{ 0;
	}
}

186 
__öô


187 
	$upd©e_nodes_add
(
node
, 
°¨t
, 
íd
)

189 
s_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

190 
e_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

191 
ch™ged
 = 0;

192 
boŸnode
 *
nd
 = &
nodes_add
[
node
];

200 i‡((sig√d )(
íd
 - 
°¨t
Ë< 
NODE_MIN_SIZE
) {

201 
	`¥ötk
(
KERN_ERR
 "SRAT: HotplugáreaÅoo small\n");

206 i‡(
	`ab£¡_∑ges_ö_ønge
(
s_p‚
, 
e_p‚
) !=É_pfn - s_pfn) {

207 
	`¥ötk
(
KERN_ERR


209 
s_p‚
, 
e_p‚
);

215 i‡(
nd
->
°¨t
 =nd->
íd
) {

216 
nd
->
°¨t
 = start;

217 
nd
->
íd
 =Énd;

218 
ch™ged
 = 1;

220 i‡(
nd
->
°¨t
 =
íd
) {

221 
nd
->
°¨t
 = start;

222 
ch™ged
 = 1;

224 i‡(
nd
->
íd
 =
°¨t
) {

225 
nd
->
íd
 =Énd;

226 
ch™ged
 = 1;

228 i‡(!
ch™ged
)

229 
	`¥ötk
(
KERN_ERR
 "SRAT: Hotplug zoneÇot continuous. Partly ignored\n");

232 i‡(
ch™ged
)

233 
	`¥ötk
(
KERN_INFO
 "SRAT: hotÖlug zone found %Lx - %Lx\n",

234 
nd
->
°¨t
,Çd->
íd
);

235 
	}
}

238 
__öô


239 
	$a˝i_numa_mem‹y_afföôy_öô
(
a˝i_§©_mem_afföôy
 *
ma
)

241 
boŸnode
 *
nd
, 
ﬁdnode
;

242 
°¨t
, 
íd
;

243 
node
, 
pxm
;

244 
i
;

246 i‡(
	`§©_dißbÀd
())

248 i‡(
ma
->
hódî
.
Àngth
 !(
a˝i_§©_mem_afföôy
)) {

249 
	`bad_§©
();

252 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

255 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
Ë&& !
	`ßve_add_öfo
())

257 
°¨t
 = 
ma
->
ba£_addªss
;

258 
íd
 = 
°¨t
 + 
ma
->
Àngth
;

259 
pxm
 = 
ma
->
¥oximôy_domaö
;

260 
node
 = 
	`£tup_node
(
pxm
);

261 i‡(
node
 < 0) {

262 
	`¥ötk
(
KERN_ERR
 "SRAT: Too manyÖroximity domains.\n");

263 
	`bad_§©
();

266 
i
 = 
	`c⁄Êi˘ög_memblks
(
°¨t
, 
íd
);

267 i‡(
i
 =
node
) {

268 
	`¥ötk
(
KERN_WARNING


270 
pxm
, 
°¨t
, 
íd
, 
nodes
[
i
].start,Çodes[i].end);

271 } i‡(
i
 >= 0) {

272 
	`¥ötk
(
KERN_ERR


274 
pxm
, 
°¨t
, 
íd
, 
	`node_to_pxm
(
i
),

275 
nodes
[
i
].
°¨t
,Çodes[i].
íd
);

276 
	`bad_§©
();

279 
nd
 = &
nodes
[
node
];

280 
ﬁdnode
 = *
nd
;

281 i‡(!
	`node_ã°_™d_£t
(
node
, 
nodes_∑r£d
)) {

282 
nd
->
°¨t
 = start;

283 
nd
->
íd
 =Énd;

285 i‡(
°¨t
 < 
nd
->start)

286 
nd
->
°¨t
 = start;

287 i‡(
nd
->
íd
 <Énd)

288 
nd
->
íd
 =Énd;

291 
	`¥ötk
(
KERN_INFO
 "SRAT: Nodê%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

292 
°¨t
, 
íd
);

293 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
node
, 
°¨t
 >> 
PAGE_SHIFT
,

294 
íd
 >> 
PAGE_SHIFT
);

296 i‡(
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) {

297 
	`upd©e_nodes_add
(
node
, 
°¨t
, 
íd
);

299 *
nd
 = 
ﬁdnode
;

300 i‡((
nd
->
°¨t
 |Çd->
íd
) == 0)

301 
	`node_˛ór
(
node
, 
nodes_∑r£d
);

304 
node_memblk_ønge
[
num_node_memblks
].
°¨t
 = start;

305 
node_memblk_ønge
[
num_node_memblks
].
íd
 =Énd;

306 
memblk_nodeid
[
num_node_memblks
] = 
node
;

307 
num_node_memblks
++;

308 
	}
}

312 
__öô
 
	$nodes_covî_mem‹y
(c⁄° 
boŸnode
 *
nodes
)

314 
i
;

315 
pxmøm
, 
e820øm
;

317 
pxmøm
 = 0;

318 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

319 
s
 = 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
;

320 
e
 = 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
;

321 
pxmøm
 +
e
 - 
s
;

322 
pxmøm
 -
	`ab£¡_∑ges_ö_ønge
(
s
, 
e
);

323 i‡(()
pxmøm
 < 0)

324 
pxmøm
 = 0;

327 
e820øm
 = 
max_p‚
 - (
	`e820_hﬁe_size
(0, max_p‚<<
PAGE_SHIFT
)>>PAGE_SHIFT);

329 i‡(()(
e820øm
 - 
pxmøm
Ë>(1<<(20 - 
PAGE_SHIFT
))) {

330 
	`¥ötk
(
KERN_ERR


332 (
pxmøm
 << 
PAGE_SHIFT
) >> 20,

333 (
e820øm
 << 
PAGE_SHIFT
) >> 20);

337 
	}
}

339 
__öô
 
	$a˝i_numa_¨ch_fixup
(Ë{
	}
}

342 
__öô
 
	$a˝i_sˇn_nodes
(
°¨t
, 
íd
)

344 
i
;

346 i‡(
a˝i_numa
 <= 0)

350 
i
 = 0; i < 
MAX_NUMNODES
; i++)

351 
	`cutoff_node
(
i
, 
°¨t
, 
íd
);

353 i‡(!
	`nodes_covî_mem‹y
(
nodes
)) {

354 
	`bad_§©
();

358 
memnode_shi·
 = 
	`compuã_hash_shi·
(
node_memblk_ønge
, 
num_node_memblks
,

359 
memblk_nodeid
);

360 i‡(
memnode_shi·
 < 0) {

361 
	`¥ötk
(
KERN_ERR


363 
	`bad_§©
();

368 
	`nodes_‹
(
node_possibÀ_m≠
, 
nodes_∑r£d
, 
˝u_nodes_∑r£d
);

371 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

372 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

375 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

376 i‡(!
	`node_⁄löe
(
i
))

377 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

379 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

380 
node
 = 
	`óæy_˝u_to_node
(
i
);

382 i‡(
node
 =
NUMA_NO_NODE
)

384 i‡(!
	`node_⁄löe
(
node
))

385 
	`numa_˛ór_node
(
i
);

387 
	`numa_öô_¨øy
();

389 
	}
}

391 #ifde‡
CONFIG_NUMA_EMU


392 
	gÁke_node_to_pxm_m≠
[
MAX_NUMNODES
] 
	g__öôd©a
 = {

393 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


395 
s16
 
	gÁke_≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__öôd©a
 = {

396 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


398 
__öô
 
	$föd_node_by_addr
(
addr
)

400 
ªt
 = 
NUMA_NO_NODE
;

401 
i
;

403 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

409 i‡(
addr
 >
nodes
[
i
].
°¨t
 &&ádd∏<Çodes[i].
íd
) {

410 
ªt
 = 
i
;

414  
ªt
;

415 
	}
}

425 
__öô
 
	$a˝i_Áke_nodes
(c⁄° 
boŸnode
 *
Áke_nodes
, 
num_nodes
)

427 
i
, 
j
;

429 
	`¥ötk
(
KERN_INFO
 "Faking PXMáffinity for fakeÇodes onÑeal "

431 
i
 = 0; i < 
num_nodes
; i++) {

432 
nid
, 
pxm
;

434 
nid
 = 
	`föd_node_by_addr
(
Áke_nodes
[
i
].
°¨t
);

435 i‡(
nid
 =
NUMA_NO_NODE
)

437 
pxm
 = 
	`node_to_pxm
(
nid
);

438 i‡(
pxm
 =
PXM_INVAL
)

440 
Áke_node_to_pxm_m≠
[
i
] = 
pxm
;

445 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

446 i‡(
≠icid_to_node
[
j
] =
nid
)

447 
Áke_≠icid_to_node
[
j
] = 
i
;

449 
i
 = 0; i < 
num_nodes
; i++)

450 
	`__a˝i_m≠_pxm_to_node
(
Áke_node_to_pxm_m≠
[
i
], i);

451 
	`mem˝y
(
≠icid_to_node
, 
Áke_≠icid_to_node
, (apicid_to_node));

453 
	`nodes_˛ór
(
nodes_∑r£d
);

454 
i
 = 0; i < 
num_nodes
; i++)

455 i‡(
Áke_nodes
[
i
].
°¨t
 !Áke_nodes[i].
íd
)

456 
	`node_£t
(
i
, 
nodes_∑r£d
);

457 
	`WARN_ON
(!
	`nodes_covî_mem‹y
(
Áke_nodes
));

458 
	}
}

460 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

462  
	`node_to_pxm
(
a
Ë=node_to_pxm(
b
);

463 
	}
}

465 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

467  
a
 =
b
;

468 
	}
}

471 
	$__node_di°™˚
(
a
, 
b
)

473 
ödex
;

475 i‡(!
a˝i_¶ô
)

476  
	`nuŒ_¶ô_node_com∑ª
(
a
, 
b
Ë? 
LOCAL_DISTANCE
 :

477 
REMOTE_DISTANCE
;

478 
ödex
 = 
a˝i_¶ô
->
loˇlôy_cou¡
 * 
	`node_to_pxm
(
a
);

479  
a˝i_¶ô
->
íåy
[
ödex
 + 
	`node_to_pxm
(
b
)];

480 
	}
}

482 
EXPORT_SYMBOL
(
__node_di°™˚
);

484 #i‡
deföed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
Ë|| deföed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

485 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

487 
i
, 
ªt
 = 0;

489 
	`f‹_óch_node
(
i
)

490 i‡(
nodes_add
[
i
].
°¨t
 <°¨à&&Çodes_add[i].
íd
 > start)

491 
ªt
 = 
i
;

493  
ªt
;

494 
	}
}

495 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<löux/öô.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/•ölock.h
>

5 
	~<löux/smp.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/moduÀ.h
>

9 
	~<asm/ébÊush.h
>

10 
	~<asm/mmu_c⁄ãxt.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/uv/uv.h
>

14 
DEFINE_PER_CPU_SHARED_ALIGNED
(
éb_°©e
, 
˝u_éb°©e
)

15 { &
öô_mm
, 0, };

39 
	usmp_Êush_°©e
 {

41 
mm_°ru˘
 *
	mÊush_mm
;

42 
	mÊush_va
;

43 
•ölock_t
 
	méb°©e_lock
;

44 
DECLARE_BITMAP
(
Êush_˝umask
, 
NR_CPUS
);

46 
	m∑d
[
CONFIG_X86_INTERNODE_CACHE_BYTES
];

47 } 
	g____ˇchñöe_öã∫odólig√d_ö_smp
;

52 
smp_Êush_°©e
 
	gÊush_°©e
[
NUM_INVALIDATE_TLB_VECTORS
];

58 
	$Àave_mm
(
˝u
)

60 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
)

61 
	`BUG
();

62 
	`˝u_˛ór
(
˝u
, 
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)->
˝u_vm_mask
);

63 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

64 
	}
}

65 
EXPORT_SYMBOL_GPL
(
Àave_mm
);

122 #ifde‡
CONFIG_X86_64


123 
	gasmlökage


125 
	$smp_övÆid©e_öãºu±
(
±_ªgs
 *
ªgs
)

127 
˝u
;

128 
£ndî
;

129 
smp_Êush_°©e
 *
f
;

131 
˝u
 = 
	`smp_¥o˚ss‹_id
();

136 
£ndî
 = ~
ªgs
->
‹ig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

137 
f
 = &
Êush_°©e
[
£ndî
];

139 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
)))

140 
out
;

150 i‡(
f
->
Êush_mm
 =
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)) {

151 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
) {

152 i‡(
f
->
Êush_va
 =
TLB_FLUSH_ALL
)

153 
	`loˇl_Êush_éb
();

155 
	`__Êush_éb_⁄e
(
f
->
Êush_va
);

157 
	`Àave_mm
(
˝u
);

159 
out
:

160 
	`ack_APIC_úq
();

161 
	`smp_mb__bef‹e_˛ór_bô
();

162 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
));

163 
	`smp_mb__a·î_˛ór_bô
();

164 
	`öc_úq_°©
(
úq_éb_cou¡
);

165 
	}
}

167 
	$Êush_éb_Ÿhîs_ùi
(c⁄° 
˝umask
 *cpumask,

168 
mm_°ru˘
 *
mm
, 
va
)

170 
£ndî
;

171 
smp_Êush_°©e
 *
f
;

174 
£ndî
 = 
	`smp_¥o˚ss‹_id
(Ë% 
NUM_INVALIDATE_TLB_VECTORS
;

175 
f
 = &
Êush_°©e
[
£ndî
];

182 
	`•ö_lock
(&
f
->
éb°©e_lock
);

184 
f
->
Êush_mm
 = 
mm
;

185 
f
->
Êush_va
 = 
va
;

186 i‡(
	`˝umask_™dnŸ
(
	`to_˝umask
(
f
->
Êush_˝umask
), 
˝umask
, 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
()))) {

191 
≠ic
->
	`£nd_IPI_mask
(
	`to_˝umask
(
f
->
Êush_˝umask
),

192 
INVALIDATE_TLB_VECTOR_START
 + 
£ndî
);

194 !
	`˝umask_em±y
(
	`to_˝umask
(
f
->
Êush_˝umask
)))

195 
	`˝u_ªœx
();

198 
f
->
Êush_mm
 = 
NULL
;

199 
f
->
Êush_va
 = 0;

200 
	`•ö_u∆ock
(&
f
->
éb°©e_lock
);

201 
	}
}

203 
	$«tive_Êush_éb_Ÿhîs
(c⁄° 
˝umask
 *cpumask,

204 
mm_°ru˘
 *
mm
, 
va
)

206 i‡(
	`is_uv_sy°em
()) {

207 
˝u
;

209 
˝u
 = 
	`gë_˝u
();

210 
˝umask
 = 
	`uv_Êush_éb_Ÿhîs
(˝umask, 
mm
, 
va
, 
˝u
);

211 i‡(
˝umask
)

212 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

213 
	`put_˝u
();

216 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

217 
	}
}

219 
__˝uöô
 
	$öô_smp_Êush
()

221 
i
;

223 
i
 = 0; i < 
	`ARRAY_SIZE
(
Êush_°©e
); i++)

224 
	`•ö_lock_öô
(&
Êush_°©e
[
i
].
éb°©e_lock
);

227 
	}
}

228 
c‹e_öôˇŒ
(
öô_smp_Êush
);

230 
	$Êush_éb_cuºít_èsk
()

232 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

234 
	`¥ìm±_dißbÀ
();

236 
	`loˇl_Êush_éb
();

237 i‡(
	`˝umask_™y_but
(&
mm
->
˝u_vm_mask
, 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

238 
	`Êush_éb_Ÿhîs
(&
mm
->
˝u_vm_mask
, mm, 
TLB_FLUSH_ALL
);

239 
	`¥ìm±_íabÀ
();

240 
	}
}

242 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

244 
	`¥ìm±_dißbÀ
();

246 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

247 i‡(
cuºít
->
mm
)

248 
	`loˇl_Êush_éb
();

250 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

252 i‡(
	`˝umask_™y_but
(&
mm
->
˝u_vm_mask
, 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

253 
	`Êush_éb_Ÿhîs
(&
mm
->
˝u_vm_mask
, mm, 
TLB_FLUSH_ALL
);

255 
	`¥ìm±_íabÀ
();

256 
	}
}

258 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
va
)

260 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

262 
	`¥ìm±_dißbÀ
();

264 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

265 i‡(
cuºít
->
mm
)

266 
	`__Êush_éb_⁄e
(
va
);

268 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

271 i‡(
	`˝umask_™y_but
(&
mm
->
˝u_vm_mask
, 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

272 
	`Êush_éb_Ÿhîs
(&
mm
->
˝u_vm_mask
, mm, 
va
);

274 
	`¥ìm±_íabÀ
();

275 
	}
}

277 
	$do_Êush_éb_Æl
(*
öfo
)

279 
˝u
 = 
	`smp_¥o˚ss‹_id
();

281 
	`__Êush_éb_Æl
();

282 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_LAZY
)

283 
	`Àave_mm
(
˝u
);

284 
	}
}

286 
	$Êush_éb_Æl
()

288 
	`⁄_óch_˝u
(
do_Êush_éb_Æl
, 
NULL
, 1);

289 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<löux/kî√l.h
>

16 
	~<löux/posix-timîs.h
>

17 
	~<löux/time.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/vsysˇŒ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/uni°d.h
>

24 
	~<asm/io.h
>

25 
	~"vexã∫.h
"

27 
	#gtod
 
vdso_vsysˇŒ_gtod_d©a


	)

29 
nŸø˚
 
	$vdso_ÁŒback_gëtime
(
˛ock
, 
time•ec
 *
ts
)

31 
ªt
;

32 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

33 "0" (
__NR_˛ock_gëtime
),"D" (
˛ock
), "S" (
ts
) : "memory");

34  
ªt
;

35 
	}
}

37 
nŸø˚
 
ölöe
 
	$vgëns
()

39 
v
;

40 
	`cy˛es_t
 (*
vªad
)();

41 
vªad
 = 
gtod
->
˛ock
.vread;

42 
v
 = (
	`vªad
(Ë- 
gtod
->
˛ock
.
cy˛e_œ°
Ë& gtod->˛ock.
mask
;

43  (
v
 * 
gtod
->
˛ock
.
mu…
Ë>> gtod->˛ock.
shi·
;

44 
	}
}

46 
nŸø˚
 
noölöe
 
	$do_ªÆtime
(
time•ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_n£c
;

53 
ns
 = 
	`vgëns
();

54 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

55 
	`time•ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nŸø˚
 

61 
	$v£t_n‹mÆized_time•ec
(
time•ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >
NSEC_PER_SEC
) {

64 
n£c
 -
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic
(
time•ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
wÆl_time_£c
;

81 
ns
 = 
gtod
->
wÆl_time_n£c
 + 
	`vgëns
();

82 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

83 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

84 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nŸø˚
 
	$__vdso_˛ock_gëtime
(
˛ockid_t
 
˛ock
, 
time•ec
 *
ts
)

91 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
))

92 
˛ock
) {

93 
CLOCK_REALTIME
:

94  
	`do_ªÆtime
(
ts
);

95 
CLOCK_MONOTONIC
:

96  
	`do_m⁄Ÿ⁄ic
(
ts
);

98  
	`vdso_ÁŒback_gëtime
(
˛ock
, 
ts
);

99 
	}
}

100 
	$˛ock_gëtime
(
˛ockid_t
, 
time•ec
 *)

101 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_clock_gettime")));

103 
nŸø˚
 
	$__vdso_gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

105 
ªt
;

106 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
)) {

107 i‡(
	`likñy
(
tv
 !
NULL
)) {

108 
	`BUILD_BUG_ON
(
	`off£tof
(
timevÆ
, 
tv_u£c
) !=

109 
	`off£tof
(
time•ec
, 
tv_n£c
) ||

110 (*
tv
Ë!(
time•ec
));

111 
	`do_ªÆtime
((
time•ec
 *)
tv
);

112 
tv
->
tv_u£c
 /= 1000;

114 i‡(
	`u∆ikñy
(
tz
 !
NULL
)) {

116 
tz
->
tz_möuãswe°
 = 
gtod
->
sys_tz
.tz_minuteswest;

117 
tz
->
tz_d°time
 = 
gtod
->
sys_tz
.tz_dsttime;

121 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

122 "0" (
__NR_gëtimeofday
), "D" (
tv
), "S" (
tz
) : "memory");

123  
ªt
;

124 
	}
}

125 
	$gëtimeofday
(
timevÆ
 *, 
timez⁄e
 *)

126 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/gë˝u.h
>

10 
	~<löux/jiffõs.h
>

11 
	~<löux/time.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vexã∫.h
"

16 
nŸø˚
 

17 
	$__vdso_gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
unu£d
)

19 
p
;

21 i‡(*
vdso_vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

23 
	`«tive_ªad_ts˝
(&
p
);

26 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

28 i‡(
˝u
)

29 *
˝u
 = 
p
 & 0xfff;

30 i‡(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

36 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<löux/mm.h
>

7 
	~<löux/îr.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/øndom.h
>

11 
	~<löux/ñf.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~<asm/¥Ÿo.h
>

15 
	~<asm/vdso.h
>

17 
	~"vexã∫.h
"

18 #unde‡
VEXTERN


20 
__ªad_mo°ly
 
	gvdso_íabÀd
 = 1;

22 
vdso_°¨t
[], 
vdso_íd
[];

23 
vdso_sync_˝uid
;

25 
∑ge
 **
	gvdso_∑ges
;

26 
	gvdso_size
;

28 
ölöe
 *
	$v¨_ªf
(*
p
, *
«me
)

30 i‡(*(**)
p
 !(*)
VMAGIC
) {

31 
	`¥ötk
("VDSO: v¨übÀ %†brokí\n", 
«me
);

32 
vdso_íabÀd
 = 0;

34  
p
;

35 
	}
}

37 
__öô
 
	$öô_vdso_v¨s
()

39 
≈ages
 = (
vdso_íd
 - 
vdso_°¨t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

40 
i
;

41 *
vba£
;

43 
vdso_size
 = 
≈ages
 << 
PAGE_SHIFT
;

44 
vdso_∑ges
 = 
	`kmÆloc
((
∑ge
 *Ë* 
≈ages
, 
GFP_KERNEL
);

45 i‡(!
vdso_∑ges
)

46 
oom
;

47 
i
 = 0; i < 
≈ages
; i++) {

48 
∑ge
 *
p
;

49 
p
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

50 i‡(!
p
)

51 
oom
;

52 
vdso_∑ges
[
i
] = 
p
;

53 
	`c›y_∑ge
(
	`∑ge_addªss
(
p
), 
vdso_°¨t
 + 
i
*
PAGE_SIZE
);

56 
vba£
 = 
	`vm≠
(
vdso_∑ges
, 
≈ages
, 0, 
PAGE_KERNEL
);

57 i‡(!
vba£
)

58 
oom
;

60 i‡(
	`memcmp
(
vba£
, "\177ELF", 4)) {

61 
	`¥ötk
("VDSO: I'm broken;Çot ELF\n");

62 
vdso_íabÀd
 = 0;

65 
	#VEXTERN
(
x
) \

66 *(
	`ty≥of
(
__
 ## 
x
Ë**Ë
	`v¨_ªf
(
	`VDSO64_SYMBOL
(
vba£
, x), #xË&__ ## x;

	)

67 
	~"vexã∫.h
"

68 #unde‡
VEXTERN


71 
oom
:

72 
	`¥ötk
("Cannotállocate vdso\n");

73 
vdso_íabÀd
 = 0;

74  -
ENOMEM
;

75 
	}
}

76 
__öôˇŒ
(
öô_vdso_v¨s
);

78 
	glöux_bö¥m
;

84 
	$vdso_addr
(
°¨t
, 
Àn
)

86 
addr
, 
íd
;

87 
off£t
;

88 
íd
 = (
°¨t
 + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

89 i‡(
íd
 >
TASK_SIZE_MAX
)

90 
íd
 = 
TASK_SIZE_MAX
;

91 
íd
 -
Àn
;

93 
off£t
 = 
	`gë_øndom_öt
(Ë& (
PTRS_PER_PTE
 - 1);

94 
addr
 = 
°¨t
 + (
off£t
 << 
PAGE_SHIFT
);

95 i‡(
addr
 >
íd
)

96 
addr
 = 
íd
;

97  
addr
;

98 
	}
}

102 
	$¨ch_£tup_addôi⁄Æ_∑ges
(
löux_bö¥m
 *
b¥m
, 
u£s_öãΩ
)

104 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

105 
addr
;

106 
ªt
;

108 i‡(!
vdso_íabÀd
)

111 
	`down_wrôe
(&
mm
->
mm≠_£m
);

112 
addr
 = 
	`vdso_addr
(
mm
->
°¨t_°ack
, 
vdso_size
);

113 
addr
 = 
	`gë_unm≠≥d_¨ó
(
NULL
,áddr, 
vdso_size
, 0, 0);

114 i‡(
	`IS_ERR_VALUE
(
addr
)) {

115 
ªt
 = 
addr
;

116 
up_Áû
;

119 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = (*)
addr
;

121 
ªt
 = 
	`ö°Æl_•ecül_m≠pög
(
mm
, 
addr
, 
vdso_size
,

122 
VM_READ
|
VM_EXEC
|

123 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

124 
VM_ALWAYSDUMP
,

125 
vdso_∑ges
);

126 i‡(
ªt
) {

127 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = 
NULL
;

128 
up_Áû
;

131 
up_Áû
:

132 
	`up_wrôe
(&
mm
->
mm≠_£m
);

133  
ªt
;

134 
	}
}

136 
__öô
 
	$vdso_£tup
(*
s
)

138 
vdso_íabÀd
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

140 
	}
}

141 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/time.h
>

7 
	~<asm/vsysˇŒ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
Ë
	`ty≥of
 (
__
 ## xË*c⁄° 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vexã∫.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<löux/jiffõs.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/smp.h
>

13 
	gÕj_föe
;

14 
	g¥e£t_Õj
;

15 
__öô
 
	$Õj_£tup
(*
°r
)

17 
¥e£t_Õj
 = 
	`sim∂e_°πoul
(
°r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Õj=", 
Õj_£tup
);

23 #ifde‡
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100Ë? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
()

35 
¥e_°¨t
, 
°¨t
, 
po°_°¨t
;

36 
¥e_íd
, 
íd
, 
po°_íd
;

37 
°¨t_jiffõs
;

38 
timî_øã_mö
, 
timî_øã_max
;

39 
good_timî_sum
 = 0;

40 
good_timî_cou¡
 = 0;

41 
i
;

43 i‡(
	`ªad_cuºít_timî
(&
¥e_°¨t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
¥e_°¨t
 = 0;

67 
	`ªad_cuºít_timî
(&
°¨t
);

68 
°¨t_jiffõs
 = 
jiffõs
;

69 
jiffõs
 <(
°¨t_jiffõs
 + 1)) {

70 
¥e_°¨t
 = 
°¨t
;

71 
	`ªad_cuºít_timî
(&
°¨t
);

73 
	`ªad_cuºít_timî
(&
po°_°¨t
);

75 
¥e_íd
 = 0;

76 
íd
 = 
po°_°¨t
;

77 
jiffõs
 <=

78 (
°¨t_jiffõs
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
¥e_íd
 = 
íd
;

80 
	`ªad_cuºít_timî
(&
íd
);

82 
	`ªad_cuºít_timî
(&
po°_íd
);

84 
timî_øã_max
 = (
po°_íd
 - 
¥e_°¨t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
timî_øã_mö
 = (
¥e_íd
 - 
po°_°¨t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 i‡(
¥e_°¨t
 !0 && 
¥e_íd
 != 0 &&

94 (
timî_øã_max
 - 
timî_øã_mö
) < (timer_rate_max >> 3)) {

95 
good_timî_cou¡
++;

96 
good_timî_sum
 +
timî_øã_max
;

100 i‡(
good_timî_cou¡
)

101  (
good_timî_sum
/
good_timî_cou¡
);

103 
	`¥ötk
(
KERN_WARNING
 "calibrate_delay_direct() failedÅo getá good "

106 
	}
}

108 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
(Ë{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__˝uöô
 
	$ˇlibøã_dñay
()

124 
ticks
, 
lo›bô
;

125 
Õs_¥ecisi⁄
 = 
LPS_PREC
;

127 i‡(
¥e£t_Õj
) {

128 
lo›s_≥r_jiffy
 = 
¥e£t_Õj
;

129 
	`¥ötk
(
KERN_INFO


131 } i‡((
	`smp_¥o˚ss‹_id
(Ë=0Ë&& 
Õj_föe
) {

132 
lo›s_≥r_jiffy
 = 
Õj_föe
;

133 
	`¥ötk
(
KERN_INFO


136 } i‡((
lo›s_≥r_jiffy
 = 
	`ˇlibøã_dñay_dúe˘
()) != 0) {

137 
	`¥ötk
(
KERN_INFO


140 
lo›s_≥r_jiffy
 = (1<<12);

142 
	`¥ötk
(
KERN_INFO
 "Calibrating delayÜoop... ");

143 (
lo›s_≥r_jiffy
 <<= 1) != 0) {

145 
ticks
 = 
jiffõs
;

146 
ticks
 =
jiffõs
)

149 
ticks
 = 
jiffõs
;

150 
	`__dñay
(
lo›s_≥r_jiffy
);

151 
ticks
 = 
jiffõs
 -Åicks;

152 i‡(
ticks
)

160 
lo›s_≥r_jiffy
 >>= 1;

161 
lo›bô
 = 
lo›s_≥r_jiffy
;

162 
Õs_¥ecisi⁄
-- && (
lo›bô
 >>= 1)) {

163 
lo›s_≥r_jiffy
 |
lo›bô
;

164 
ticks
 = 
jiffõs
;

165 
ticks
 =
jiffõs
)

167 
ticks
 = 
jiffõs
;

168 
	`__dñay
(
lo›s_≥r_jiffy
);

169 i‡(
jiffõs
 !
ticks
)

170 
lo›s_≥r_jiffy
 &~
lo›bô
;

173 
	`¥ötk
(
KERN_CONT
 "%lu.%02lu BogoMIPS (lpj=%lu)\n",

174 
lo›s_≥r_jiffy
/(500000/
HZ
),

175 (
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100,Üoops_per_jiffy);

176 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/˘y≥.h
>

4 
	~<löux/fd.h
>

5 
	~<löux/ây.h
>

6 
	~<löux/su•íd.h
>

7 
	~<löux/roŸ_dev.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/gíhd.h
>

11 
	~<löux/mou¡.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/öôrd.h
>

16 
	~<löux/async.h
>

17 
	~<löux/fs_°ru˘.h
>

19 
	~<löux/nfs_fs.h
>

20 
	~<löux/nfs_fs_sb.h
>

21 
	~<löux/nfs_mou¡.h
>

23 
	~"do_mou¡s.h
"

25 
__öôd©a
 
	grd_dﬁﬂd
;

27 
	groŸ_mou¡Êags
 = 
MS_RDONLY
 | 
MS_SILENT
;

28 * 
__öôd©a
 
	groŸ_devi˚_«me
;

29 
__öôd©a
 
	gßved_roŸ_«me
[64];

30 
__öôd©a
 
	groŸ_waô
;

32 
dev_t
 
	gROOT_DEV
;

34 
__öô
 
	$lﬂd_ømdisk
(*
°r
)

36 
rd_dﬁﬂd
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 3;

38 
	}
}

39 
__£tup
("lﬂd_ømdisk=", 
lﬂd_ømdisk
);

41 
__öô
 
	$ªad⁄ly
(*
°r
)

43 i‡(*
°r
)

45 
roŸ_mou¡Êags
 |
MS_RDONLY
;

47 
	}
}

49 
__öô
 
	$ªadwrôe
(*
°r
)

51 i‡(*
°r
)

53 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

55 
	}
}

57 
__£tup
("ro", 
ªad⁄ly
);

58 
__£tup
("rw", 
ªadwrôe
);

77 
dev_t
 
	$«me_to_dev_t
(*
«me
)

79 
s
[32];

80 *
p
;

81 
dev_t
 
ªs
 = 0;

82 
∑π
;

84 i‡(
	`°∫cmp
(
«me
, "/dev/", 5) != 0) {

85 
maj
, 
mö
;

87 i‡(
	`ssˇnf
(
«me
, "%u:%u", &
maj
, &
mö
) == 2) {

88 
ªs
 = 
	`MKDEV
(
maj
, 
mö
);

89 i‡(
maj
 !
	`MAJOR
(
ªs
Ë|| 
mö
 !
	`MINOR
(res))

90 
Áû
;

92 
ªs
 = 
	`√w_decode_dev
(
	`sim∂e_°πoul
(
«me
, &
p
, 16));

93 i‡(*
p
)

94 
Áû
;

96 
d⁄e
;

99 
«me
 += 5;

100 
ªs
 = 
RoŸ_NFS
;

101 i‡(
	`°rcmp
(
«me
, "nfs") == 0)

102 
d⁄e
;

103 
ªs
 = 
RoŸ_RAM0
;

104 i‡(
	`°rcmp
(
«me
, "ram") == 0)

105 
d⁄e
;

107 i‡(
	`°æí
(
«me
) > 31)

108 
Áû
;

109 
	`°r˝y
(
s
, 
«me
);

110 
p
 = 
s
; *p;Ö++)

111 i‡(*
p
 == '/')

112 *
p
 = '!';

113 
ªs
 = 
	`blk_lookup_devt
(
s
, 0);

114 i‡(
ªs
)

115 
d⁄e
;

121 
p
 > 
s
 && 
	`isdigô
(p[-1]))

122 
p
--;

123 i‡(
p
 =
s
 || !*p || *p == '0')

124 
Áû
;

127 
∑π
 = 
	`sim∂e_°πoul
(
p
, 
NULL
, 10);

128 *
p
 = '\0';

129 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

130 i‡(
ªs
)

131 
d⁄e
;

134 i‡(
p
 < 
s
 + 2 || !
	`isdigô
(p[-2]) ||Ö[-1] != 'p')

135 
Áû
;

136 
p
[-1] = '\0';

137 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

138 i‡(
ªs
)

139 
d⁄e
;

141 
Áû
:

143 
d⁄e
:

144  
ªs
;

145 
	}
}

147 
__öô
 
	$roŸ_dev_£tup
(*
löe
)

149 
	`°æ˝y
(
ßved_roŸ_«me
, 
löe
, (saved_root_name));

151 
	}
}

153 
__£tup
("roŸ=", 
roŸ_dev_£tup
);

155 
__öô
 
	$roŸwaô_£tup
(*
°r
)

157 i‡(*
°r
)

159 
roŸ_waô
 = 1;

161 
	}
}

163 
__£tup
("roŸwaô", 
roŸwaô_£tup
);

165 * 
__öôd©a
 
	groŸ_mou¡_d©a
;

166 
__öô
 
	$roŸ_d©a_£tup
(*
°r
)

168 
roŸ_mou¡_d©a
 = 
°r
;

170 
	}
}

172 * 
__öôd©a
 
	groŸ_fs_«mes
;

173 
__öô
 
	$fs_«mes_£tup
(*
°r
)

175 
roŸ_fs_«mes
 = 
°r
;

177 
	}
}

179 
__öôd©a
 
	groŸ_dñay
;

180 
__öô
 
	$roŸ_dñay_£tup
(*
°r
)

182 
roŸ_dñay
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 0);

184 
	}
}

186 
__£tup
("roŸÊags=", 
roŸ_d©a_£tup
);

187 
__£tup
("roŸf°y≥=", 
fs_«mes_£tup
);

188 
__£tup
("roŸdñay=", 
roŸ_dñay_£tup
);

190 
__öô
 
	$gë_fs_«mes
(*
∑ge
)

192 *
s
 = 
∑ge
;

194 i‡(
roŸ_fs_«mes
) {

195 
	`°r˝y
(
∑ge
, 
roŸ_fs_«mes
);

196 *
s
++) {

197 i‡(
s
[-1] == ',')

198 
s
[-1] = '\0';

201 
Àn
 = 
	`gë_fûesy°em_li°
(
∑ge
);

202 *
p
, *
√xt
;

204 
∑ge
[
Àn
] = '\0';

205 
p
 = 
∑ge
-1;Ö;Ö = 
√xt
) {

206 
√xt
 = 
	`°rchr
(++
p
, '\n');

207 i‡(*
p
++ != '\t')

209 (*
s
++ = *
p
++) != '\n')

211 
s
[-1] = '\0';

214 *
s
 = '\0';

215 
	}
}

217 
__öô
 
	$do_mou¡_roŸ
(*
«me
, *
fs
, 
Êags
, *
d©a
)

219 
îr
 = 
	`sys_mou¡
(
«me
, "/roŸ", 
fs
, 
Êags
, 
d©a
);

220 i‡(
îr
)

221  
îr
;

223 
	`sys_chdú
("/root");

224 
ROOT_DEV
 = 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_dev
;

225 
	`¥ötk
("VFS: MountedÑoot (%s filesystem)%s on device %u:%u.\n",

226 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_ty≥
->
«me
,

227 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_Êags
 & 
MS_RDONLY
 ?

228 "Ñód⁄ly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

230 
	}
}

232 
__öô
 
	$mou¡_block_roŸ
(*
«me
, 
Êags
)

234 *
fs_«mes
 = 
	`__gë«me_gÂ
(
GFP_KERNEL


235 | 
__GFP_NOTRACK_FALSE_POSITIVE
);

236 *
p
;

237 #ifde‡
CONFIG_BLOCK


238 
b
[
BDEVNAME_SIZE
];

240 c⁄° *
b
 = 
«me
;

243 
	`gë_fs_«mes
(
fs_«mes
);

244 
ªåy
:

245 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1) {

246 
îr
 = 
	`do_mou¡_roŸ
(
«me
, 
p
, 
Êags
, 
roŸ_mou¡_d©a
);

247 
îr
) {

249 
out
;

250 -
EACCES
:

251 
Êags
 |
MS_RDONLY
;

252 
ªåy
;

253 -
EINVAL
:

261 #ifde‡
CONFIG_BLOCK


262 
	`__bdev«me
(
ROOT_DEV
, 
b
);

264 
	`¥ötk
("VFS: Cannot openÑoot device \"%s\" or %s\n",

265 
roŸ_devi˚_«me
, 
b
);

266 
	`¥ötk
("Pleaseáppendá correct \"root=\" boot option; hereáreÅheávailableÖartitions:\n");

268 
	`¥ötk_Æl_∑πôi⁄s
();

269 #ifde‡
CONFIG_DEBUG_BLOCK_EXT_DEVT


270 
	`¥ötk
("DEBUG_BLOCK_EXT_DEVT isÉnabled, youÇeedÅo specify "

273 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

276 
	`¥ötk
("List ofállÖartitions:\n");

277 
	`¥ötk_Æl_∑πôi⁄s
();

278 
	`¥ötk
("No filesystem could mountÑoot,Åried: ");

279 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1)

280 
	`¥ötk
(" %s", 
p
);

281 
	`¥ötk
("\n");

282 #ifde‡
CONFIG_BLOCK


283 
	`__bdev«me
(
ROOT_DEV
, 
b
);

285 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

286 
out
:

287 
	`puäame
(
fs_«mes
);

288 
	}
}

290 #ifde‡
CONFIG_ROOT_NFS


291 
__öô
 
	$mou¡_nfs_roŸ
()

293 *
d©a
 = 
	`nfs_roŸ_d©a
();

295 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

296 i‡(
d©a
 &&

297 
	`do_mou¡_roŸ
("/dev/roŸ", "nfs", 
roŸ_mou¡Êags
, 
d©a
) == 0)

300 
	}
}

303 #i‡
deföed
(
CONFIG_BLK_DEV_RAM
Ë|| deföed(
CONFIG_BLK_DEV_FD
)

304 
__öô
 
	$ch™ge_Ê›py
(*
fmt
, ...)

306 
ãrmios
Åermios;

307 
buf
[80];

308 
c
;

309 
fd
;

310 
va_li°
 
¨gs
;

311 
	`va_°¨t
(
¨gs
, 
fmt
);

312 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

313 
	`va_íd
(
¨gs
);

314 
fd
 = 
	`sys_›í
("/dev/roŸ", 
O_RDWR
 | 
O_NDELAY
, 0);

315 i‡(
fd
 >= 0) {

316 
	`sys_io˘l
(
fd
, 
FDEJECT
, 0);

317 
	`sys_˛o£
(
fd
);

319 
	`¥ötk
(
KERN_NOTICE
 "VFS: In£π %†™dÖªs†ENTER\n", 
buf
);

320 
fd
 = 
	`sys_›í
("/dev/c⁄sﬁe", 
O_RDWR
, 0);

321 i‡(
fd
 >= 0) {

322 
	`sys_io˘l
(
fd
, 
TCGETS
, ()&
ãrmios
);

323 
ãrmios
.
c_lÊag
 &~
ICANON
;

324 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

325 
	`sys_ªad
(
fd
, &
c
, 1);

326 
ãrmios
.
c_lÊag
 |
ICANON
;

327 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

328 
	`sys_˛o£
(
fd
);

330 
	}
}

333 
__öô
 
	$mou¡_roŸ
()

335 #ifde‡
CONFIG_ROOT_NFS


336 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
UNNAMED_MAJOR
) {

337 i‡(
	`mou¡_nfs_roŸ
())

340 
	`¥ötk
(
KERN_ERR
 "VFS: UnableÅo mountÑoot fs via NFS,Årying floppy.\n");

341 
ROOT_DEV
 = 
RoŸ_FD0
;

344 #ifde‡
CONFIG_BLK_DEV_FD


345 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
) {

347 i‡(
rd_dﬁﬂd
==2) {

348 i‡(
	`rd_lﬂd_disk
(1)) {

349 
ROOT_DEV
 = 
RoŸ_RAM1
;

350 
roŸ_devi˚_«me
 = 
NULL
;

353 
	`ch™ge_Ê›py
("root floppy");

356 #ifde‡
CONFIG_BLOCK


357 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

358 
	`mou¡_block_roŸ
("/dev/roŸ", 
roŸ_mou¡Êags
);

360 
	}
}

365 
__öô
 
	$¥ï¨e_«me•a˚
()

367 
is_Ê›py
;

369 i‡(
roŸ_dñay
) {

370 
	`¥ötk
(
KERN_INFO
 "Waiting %dsec before mountingÑoot device...\n",

371 
roŸ_dñay
);

372 
	`s¶ìp
(
roŸ_dñay
);

382 
	`waô_f‹_devi˚_¥obe
();

384 
	`md_run_£tup
();

386 i‡(
ßved_roŸ_«me
[0]) {

387 
roŸ_devi˚_«me
 = 
ßved_roŸ_«me
;

388 i‡(!
	`°∫cmp
(
roŸ_devi˚_«me
, "mtd", 3) ||

389 !
	`°∫cmp
(
roŸ_devi˚_«me
, "ubi", 3)) {

390 
	`mou¡_block_roŸ
(
roŸ_devi˚_«me
, 
roŸ_mou¡Êags
);

391 
out
;

393 
ROOT_DEV
 = 
	`«me_to_dev_t
(
roŸ_devi˚_«me
);

394 i‡(
	`°∫cmp
(
roŸ_devi˚_«me
, "/dev/", 5) == 0)

395 
roŸ_devi˚_«me
 += 5;

398 i‡(
	`öôrd_lﬂd
())

399 
out
;

402 i‡((
ROOT_DEV
 =0Ë&& 
roŸ_waô
) {

403 
	`¥ötk
(
KERN_INFO
 "Waiting forÑoot device %s...\n",

404 
ßved_roŸ_«me
);

405 
	`drivî_¥obe_d⁄e
() != 0 ||

406 (
ROOT_DEV
 = 
	`«me_to_dev_t
(
ßved_roŸ_«me
)) == 0)

407 
	`m¶ìp
(100);

408 
	`async_synchr⁄ize_fuŒ
();

411 
is_Ê›py
 = 
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
;

413 i‡(
is_Ê›py
 && 
rd_dﬁﬂd
 && 
	`rd_lﬂd_disk
(0))

414 
ROOT_DEV
 = 
RoŸ_RAM0
;

416 
	`mou¡_roŸ
();

417 
out
:

418 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

419 
	`sys_chroŸ
(".");

420 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<löux/uni°d.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/öôrd.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/‰ìzî.h
>

11 
	~"do_mou¡s.h
"

13 
	göôrd_°¨t
, 
	göôrd_íd
;

14 
	göôrd_bñow_°¨t_ok
;

15 
	gªÆ_roŸ_dev
;

16 
__öôd©a
 
	gﬁd_fd
, 
	groŸ_fd
;

17 
__öôd©a
 
	gmou¡_öôrd
 = 1;

19 
__öô
 
	$no_öôrd
(*
°r
)

21 
mou¡_öôrd
 = 0;

23 
	}
}

25 
__£tup
("noöôrd", 
no_öôrd
);

27 
__öô
 
	$do_löuxrc
(* 
shñl
)

29 *
¨gv
[] = { "löuxrc", 
NULL
, };

30 * 
ívp_öô
[];

32 
	`sys_˛o£
(
ﬁd_fd
);sys_˛o£(
roŸ_fd
);

33 
	`sys_˛o£
(0);sys_close(1);sys_close(2);

34 
	`sys_£tsid
();

35 (Ë
	`sys_›í
("/dev/c⁄sﬁe",
O_RDWR
,0);

36 (Ë
	`sys_dup
(0);

37 (Ë
	`sys_dup
(0);

38  
	`kî√l_execve
(
shñl
, 
¨gv
, 
ívp_öô
);

39 
	}
}

41 
__öô
 
	$h™dÀ_öôrd
()

43 
îr‹
;

44 
pid
;

46 
ªÆ_roŸ_dev
 = 
	`√w_ícode_dev
(
ROOT_DEV
);

47 
	`¸óã_dev
("/dev/roŸ.ﬁd", 
RoŸ_RAM0
);

49 
	`mou¡_block_roŸ
("/dev/roŸ.ﬁd", 
roŸ_mou¡Êags
 & ~
MS_RDONLY
);

50 
	`sys_mkdú
("/old", 0700);

51 
roŸ_fd
 = 
	`sys_›í
("/", 0, 0);

52 
ﬁd_fd
 = 
	`sys_›í
("/old", 0, 0);

54 
	`sys_chdú
("/root");

55 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

56 
	`sys_chroŸ
(".");

62 
cuºít
->
Êags
 |
PF_FREEZER_SKIP
;

64 
pid
 = 
	`kî√l_thªad
(
do_löuxrc
, "/löuxrc", 
SIGCHLD
);

65 i‡(
pid
 > 0)

66 
pid
 !
	`sys_waô4
(-1, 
NULL
, 0, NULL))

67 
	`yõld
();

69 
cuºít
->
Êags
 &~
PF_FREEZER_SKIP
;

72 
	`sys_fchdú
(
ﬁd_fd
);

73 
	`sys_mou¡
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

75 
	`sys_fchdú
(
roŸ_fd
);

76 
	`sys_chroŸ
(".");

77 
	`sys_˛o£
(
ﬁd_fd
);

78 
	`sys_˛o£
(
roŸ_fd
);

80 i‡(
	`√w_decode_dev
(
ªÆ_roŸ_dev
Ë=
RoŸ_RAM0
) {

81 
	`sys_chdú
("/old");

85 
ROOT_DEV
 = 
	`√w_decode_dev
(
ªÆ_roŸ_dev
);

86 
	`mou¡_roŸ
();

88 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo move oldÑootÅo /initrd ... ");

89 
îr‹
 = 
	`sys_mou¡
("/ﬁd", "/roŸ/öôrd", 
NULL
, 
MS_MOVE
, NULL);

90 i‡(!
îr‹
)

91 
	`¥ötk
("okay\n");

93 
fd
 = 
	`sys_›í
("/dev/roŸ.ﬁd", 
O_RDWR
, 0);

94 i‡(
îr‹
 =-
ENOENT
)

95 
	`¥ötk
("/initrd doesÇotÉxist. Ignored.\n");

97 
	`¥ötk
("failed\n");

98 
	`¥ötk
(
KERN_NOTICE
 "Unmounting oldÑoot\n");

99 
	`sys_umou¡
("/ﬁd", 
MNT_DETACH
);

100 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo freeÑamdisk memory ... ");

101 i‡(
fd
 < 0) {

102 
îr‹
 = 
fd
;

104 
îr‹
 = 
	`sys_io˘l
(
fd
, 
BLKFLSBUF
, 0);

105 
	`sys_˛o£
(
fd
);

107 
	`¥ötk
(!
îr‹
 ? "okay\n" : "failed\n");

109 
	}
}

111 
__öô
 
	$öôrd_lﬂd
()

113 i‡(
mou¡_öôrd
) {

114 
	`¸óã_dev
("/dev/øm", 
RoŸ_RAM0
);

121 i‡(
	`rd_lﬂd_image
("/öôrd.image"Ë&& 
ROOT_DEV
 !
RoŸ_RAM0
) {

122 
	`sys_u∆ök
("/initrd.image");

123 
	`h™dÀ_öôrd
();

127 
	`sys_u∆ök
("/initrd.image");

129 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<löux/dñay.h
>

2 
	~<löux/øid/md_u.h
>

3 
	~<löux/øid/md_p.h
>

5 
	~"do_mou¡s.h
"

16 #ifde‡
CONFIG_MD_AUTODETECT


17 
__öôd©a
 
	gøid_nﬂutodëe˘
;

19 
__öôd©a
 
	gøid_nﬂutodëe˘
=1;

21 
__öôd©a
 
	gøid_aut›¨t
;

24 
	mmö‹
;

25 
	m∑πôi⁄ed
;

26 
	mÀvñ
;

27 
	mchunk
;

28 *
	mdevi˚_«mes
;

29 } 
	gmd_£tup_¨gs
[256] 
	g__öôd©a
;

31 
md_£tup_íts
 
	g__öôd©a
;

53 
__öô
 
	$md_£tup
(*
°r
)

55 
mö‹
, 
Àvñ
, 
Á˘‹
, 
Áu…
, 
∑πôi⁄ed
 = 0;

56 *
≥∫ame
 = "";

57 *
°r1
;

58 
ít
;

60 i‡(*
°r
 == 'd') {

61 
∑πôi⁄ed
 = 1;

62 
°r
++;

64 i‡(
	`gë_›ti⁄
(&
°r
, &
mö‹
) != 2) {

65 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

68 
°r1
 = 
°r
;

69 
ít
=0 ;É¡< 
md_£tup_íts
 ;Ént++)

70 i‡(
md_£tup_¨gs
[
ít
].
mö‹
 == minor &&

71 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 ==Öartitioned) {

72 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d, Specified moreÅhan once. "

73 "RïœcögÖªviou†deföôi⁄.\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

76 i‡(
ít
 >
	`ARRAY_SIZE
(
md_£tup_¨gs
)) {

77 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d -Åoÿm™y md inôülißti⁄s\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

80 i‡(
ít
 >
md_£tup_íts
)

81 
md_£tup_íts
++;

82 
	`gë_›ti⁄
(&
°r
, &
Àvñ
)) {

84 i‡(
Àvñ
 =0 ||Üevñ =
LEVEL_LINEAR
) {

85 i‡(
	`gë_›ti⁄
(&
°r
, &
Á˘‹
) != 2 ||

86 
	`gë_›ti⁄
(&
°r
, &
Áu…
) != 2) {

87 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

90 
md_£tup_¨gs
[
ít
].
Àvñ
 =Üevel;

91 
md_£tup_¨gs
[
ít
].
chunk
 = 1 << (
Á˘‹
+12);

92 i‡(
Àvñ
 =
LEVEL_LINEAR
)

93 
≥∫ame
 = "linear";

95 
≥∫ame
 = "raid0";

100 
°r
 = 
°r1
;

103 
md_£tup_¨gs
[
ít
].
Àvñ
 = 
LEVEL_NONE
;

104 
≥∫ame
="super-block";

107 
	`¥ötk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mö‹
, 
≥∫ame
, 
°r
);

109 
md_£tup_¨gs
[
ít
].
devi˚_«mes
 = 
°r
;

110 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 =Öartitioned;

111 
md_£tup_¨gs
[
ít
].
mö‹
 = minor;

114 
	}
}

116 
__öô
 
	$md_£tup_drive
()

118 
mö‹
, 
i
, 
ít
, 
∑πôi⁄ed
;

119 
dev_t
 
dev
;

120 
dev_t
 
devi˚s
[
MD_SB_DISKS
+1];

122 
ít
 = 0;É¡ < 
md_£tup_íts
 ;Ént++) {

123 
fd
;

124 
îr
 = 0;

125 *
dev«me
;

126 
mdu_disk_öfo_t
 
döfo
;

127 
«me
[16];

129 
mö‹
 = 
md_£tup_¨gs
[
ít
].minor;

130 
∑πôi⁄ed
 = 
md_£tup_¨gs
[
ít
].partitioned;

131 
dev«me
 = 
md_£tup_¨gs
[
ít
].
devi˚_«mes
;

133 
	`•rötf
(
«me
, "/dev/md%s%d", 
∑πôi⁄ed
?"_d":"", 
mö‹
);

134 i‡(
∑πôi⁄ed
)

135 
dev
 = 
	`MKDEV
(
mdp_maj‹
, 
mö‹
 << 
MdpMö‹Shi·
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mö‹
);

138 
	`¸óã_dev
(
«me
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
dev«me
 !
NULL
; i++) {

140 *
p
;

141 
comp_«me
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`°rchr
(
dev«me
, ',');

145 i‡(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`«me_to_dev_t
(
dev«me
);

149 i‡(
	`°∫cmp
(
dev«me
, "/dev/", 5) == 0)

150 
dev«me
 += 5;

151 
	`¢¥ötf
(
comp_«me
, 63, "/dev/%s", 
dev«me
);

152 
rdev
 = 
	`b°©
(
comp_«me
);

153 i‡(
rdev
)

154 
dev
 = 
	`√w_decode_dev
(
rdev
);

155 i‡(!
dev
) {

156 
	`¥ötk
(
KERN_WARNING
 "md: Unknow¿devi˚Çame: %s\n", 
dev«me
);

160 
devi˚s
[
i
] = 
dev
;

162 
dev«me
 = 
p
;

164 
devi˚s
[
i
] = 0;

166 i‡(!
i
)

169 
	`¥ötk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
∑πôi⁄ed
 ? "_d" : "", 
mö‹
,

171 
md_£tup_¨gs
[
ít
].
devi˚_«mes
);

173 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

174 i‡(
fd
 < 0) {

175 
	`¥ötk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¨øy %s\n", 
«me
);

179 i‡(
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, 0Ë=-
EBUSY
) {

180 
	`¥ötk
(
KERN_WARNING


182 
mö‹
);

183 
	`sys_˛o£
(
fd
);

187 i‡(
md_£tup_¨gs
[
ít
].
Àvñ
 !
LEVEL_NONE
) {

189 
mdu_¨øy_öfo_t
 
aöfo
;

190 
aöfo
.
Àvñ
 = 
md_£tup_¨gs
[
ít
].level;

191 
aöfo
.
size
 = 0;

192 
aöfo
.
ƒ_disks
 =0;

193 
aöfo
.
øid_disks
 =0;

194 
devi˚s
[
aöfo
.
øid_disks
])

195 
aöfo
.
øid_disks
++;

196 
aöfo
.
md_mö‹
 =
mö‹
;

197 
aöfo
.
nŸ_≥rsi°ít
 = 1;

199 
aöfo
.
°©e
 = (1 << 
MD_SB_CLEAN
);

200 
aöfo
.
œyout
 = 0;

201 
aöfo
.
chunk_size
 = 
md_£tup_¨gs
[
ít
].
chunk
;

202 
îr
 = 
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, ()&
aöfo
);

203 
i
 = 0; !
îr
 && i <
MD_SB_DISKS
; i++) {

204 
dev
 = 
devi˚s
[
i
];

205 i‡(!
dev
)

207 
döfo
.
numbî
 = 
i
;

208 
döfo
.
øid_disk
 = 
i
;

209 
döfo
.
°©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

211 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

212 
îr
 = 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

216 
i
 = 0; i <
MD_SB_DISKS
; i++) {

217 
dev
 = 
devi˚s
[
i
];

218 i‡(!
dev
)

220 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

221 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

222 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

225 i‡(!
îr
)

226 
îr
 = 
	`sys_io˘l
(
fd
, 
RUN_ARRAY
, 0);

227 i‡(
îr
)

228 
	`¥ötk
(
KERN_WARNING
 "md: sèπög md%d faûed\n", 
mö‹
);

235 
	`sys_˛o£
(
fd
);

236 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

237 
	`sys_io˘l
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_˛o£
(
fd
);

241 
	}
}

243 
__öô
 
	$øid_£tup
(*
°r
)

245 
Àn
, 
pos
;

247 
Àn
 = 
	`°æí
(
°r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Àn
) {

251 *
comma
 = 
	`°rchr
(
°r
+
pos
, ',');

252 
wÀn
;

253 i‡(
comma
)

254 
wÀn
 = (
comma
-
°r
)-
pos
;

255 
wÀn
 = (
Àn
-1)-
pos
;

257 i‡(!
	`°∫cmp
(
°r
, "nﬂutodëe˘", 
wÀn
))

258 
øid_nﬂutodëe˘
 = 1;

259 i‡(!
	`°∫cmp
(
°r
, "autodëe˘", 
wÀn
))

260 
øid_nﬂutodëe˘
 = 0;

261 i‡(
	`°∫cmp
(
°r
, "∑πôi⁄abÀ", 
wÀn
)==0)

262 
øid_aut›¨t
 = 1;

263 i‡(
	`°∫cmp
(
°r
, "∑π", 
wÀn
)==0)

264 
øid_aut›¨t
 = 1;

265 
pos
 +
wÀn
+1;

268 
	}
}

270 
__£tup
("øid=", 
øid_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__öô
 
	$autodëe˘_øid
()

275 
fd
;

281 
	`¥ötk
(
KERN_INFO
 "md: Waiting foráll devicesÅo beávailable beforeáutodetect\n");

282 
	`¥ötk
(
KERN_INFO
 "md: If you don't useÑaid, useÑaid=noautodetect\n");

284 
	`waô_f‹_devi˚_¥obe
();

286 
fd
 = 
	`sys_›í
("/dev/md0", 0, 0);

287 i‡(
fd
 >= 0) {

288 
	`sys_io˘l
(
fd
, 
RAID_AUTORUN
, 
øid_aut›¨t
);

289 
	`sys_˛o£
(
fd
);

291 
	}
}

293 
__öô
 
	$md_run_£tup
()

295 
	`¸óã_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 i‡(
øid_nﬂutodëe˘
)

298 
	`¥ötk
(
KERN_INFO
 "md: Skippingáutodetection of RAIDárrays. (raid=autodetect will force)\n");

300 
	`autodëe˘_øid
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/¸amfs_fs.h
>

8 
	~<löux/öôrd.h
>

9 
	~<löux/°rög.h
>

11 
	~"do_mou¡s.h
"

12 
	~"../fs/squashfs/squashfs_fs.h
"

14 
	~<löux/decom¥ess/gíîic.h
>

17 
__öôd©a
 
	grd_¥om±
 = 1;

19 
__öô
 
	$¥om±_ømdisk
(*
°r
)

21 
rd_¥om±
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 1;

23 
	}
}

24 
__£tup
("¥om±_ømdisk=", 
¥om±_ømdisk
);

26 
__öôd©a
 
	grd_image_°¨t
;

28 
__öô
 
	$ømdisk_°¨t_£tup
(*
°r
)

30 
rd_image_°¨t
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0);

32 
	}
}

33 
__£tup
("ømdisk_°¨t=", 
ømdisk_°¨t_£tup
);

35 
__öô
 
¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
);

51 
__öô


52 
	$idítify_ømdisk_image
(
fd
, 
°¨t_block
, 
decom¥ess_‚
 *
decom¥ess‹
)

54 c⁄° 
size
 = 512;

55 
möix_su≥r_block
 *
möixsb
;

56 
ext2_su≥r_block
 *
ext2sb
;

57 
romfs_su≥r_block
 *
romfsb
;

58 
¸amfs_su≥r
 *
¸amfsb
;

59 
squashfs_su≥r_block
 *
squashfsb
;

60 
nblocks
 = -1;

61 *
buf
;

62 c⁄° *
com¥ess_«me
;

64 
buf
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

65 i‡(!
buf
)

68 
möixsb
 = (
möix_su≥r_block
 *Ë
buf
;

69 
ext2sb
 = (
ext2_su≥r_block
 *Ë
buf
;

70 
romfsb
 = (
romfs_su≥r_block
 *Ë
buf
;

71 
¸amfsb
 = (
¸amfs_su≥r
 *Ë
buf
;

72 
squashfsb
 = (
squashfs_su≥r_block
 *Ë
buf
;

73 
	`mem£t
(
buf
, 0xe5, 
size
);

78 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

79 
	`sys_ªad
(
fd
, 
buf
, 
size
);

81 *
decom¥ess‹
 = 
	`decom¥ess_mëhod
(
buf
, 
size
, &
com¥ess_«me
);

82 i‡(
com¥ess_«me
) {

83 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: %s image foundát block %d\n",

84 
com¥ess_«me
, 
°¨t_block
);

85 i‡(!*
decom¥ess‹
)

86 
	`¥ötk
(
KERN_EMERG


88 
com¥ess_«me
);

89 
nblocks
 = 0;

90 
d⁄e
;

94 i‡(
romfsb
->
w‹d0
 =
ROMSB_WORD0
 &&

95 
romfsb
->
w‹d1
 =
ROMSB_WORD1
) {

96 
	`¥ötk
(
KERN_NOTICE


98 
°¨t_block
);

99 
nblocks
 = (
	`¡ohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

100 
d⁄e
;

103 i‡(
¸amfsb
->
magic
 =
CRAMFS_MAGIC
) {

104 
	`¥ötk
(
KERN_NOTICE


106 
°¨t_block
);

107 
nblocks
 = (
¸amfsb
->
size
 + 
BLOCK_SIZE
 - 1Ë>> 
BLOCK_SIZE_BITS
;

108 
d⁄e
;

112 i‡(
	`À32_to_˝u
(
squashfsb
->
s_magic
Ë=
SQUASHFS_MAGIC
) {

113 
	`¥ötk
(
KERN_NOTICE


115 
°¨t_block
);

116 
nblocks
 = (
	`À64_to_˝u
(
squashfsb
->
byãs_u£d
Ë+ 
BLOCK_SIZE
 - 1)

117 >> 
BLOCK_SIZE_BITS
;

118 
d⁄e
;

124 
	`sys_l£ek
(
fd
, (
°¨t_block
+1Ë* 
BLOCK_SIZE
, 0);

125 
	`sys_ªad
(
fd
, 
buf
, 
size
);

128 i‡(
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC
 ||

129 
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC2
) {

130 
	`¥ötk
(
KERN_NOTICE


132 
°¨t_block
);

133 
nblocks
 = 
möixsb
->
s_nz⁄es
 << möixsb->
s_log_z⁄e_size
;

134 
d⁄e
;

138 i‡(
ext2sb
->
s_magic
 =
	`˝u_to_À16
(
EXT2_SUPER_MAGIC
)) {

139 
	`¥ötk
(
KERN_NOTICE


141 
°¨t_block
);

142 
nblocks
 = 
	`À32_to_˝u
(
ext2sb
->
s_blocks_cou¡
) <<

143 
	`À32_to_˝u
(
ext2sb
->
s_log_block_size
);

144 
d⁄e
;

147 
	`¥ötk
(
KERN_NOTICE


149 
°¨t_block
);

151 
d⁄e
:

152 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

153 
	`k‰ì
(
buf
);

154  
nblocks
;

155 
	}
}

157 
__öô
 
	$rd_lﬂd_image
(*
‰om
)

159 
ªs
 = 0;

160 
ö_fd
, 
out_fd
;

161 
rd_blocks
, 
devblocks
;

162 
nblocks
, 
i
, 
disk
;

163 *
buf
 = 
NULL
;

164 
rŸ©e
 = 0;

165 
decom¥ess_‚
 
decom¥ess‹
 = 
NULL
;

166 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

167 
rŸ©‹
[4] = { '|' , '/' , '-' , '\\' };

170 
out_fd
 = 
	`sys_›í
("/dev/øm", 
O_RDWR
, 0);

171 i‡(
out_fd
 < 0)

172 
out
;

174 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

175 i‡(
ö_fd
 < 0)

176 
no˛o£_öput
;

178 
nblocks
 = 
	`idítify_ømdisk_image
(
ö_fd
, 
rd_image_°¨t
, &
decom¥ess‹
);

179 i‡(
nblocks
 < 0)

180 
d⁄e
;

182 i‡(
nblocks
 == 0) {

183 i‡(
	`¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess‹
) == 0)

184 
suc˚ssful_lﬂd
;

185 
d⁄e
;

199 i‡(
	`sys_io˘l
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

200 
rd_blocks
 = 0;

202 
rd_blocks
 >>= 1;

204 i‡(
nblocks
 > 
rd_blocks
) {

205 
	`¥ötk
("RAMDISK: imageÅoo big! (%dKiB/%ldKiB)\n",

206 
nblocks
, 
rd_blocks
);

207 
d⁄e
;

213 i‡(
	`sys_io˘l
(
ö_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

214 
devblocks
 = 0;

216 
devblocks
 >>= 1;

218 i‡(
	`°rcmp
(
‰om
, "/initrd.image") == 0)

219 
devblocks
 = 
nblocks
;

221 i‡(
devblocks
 == 0) {

222 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇot determine device size\n");

223 
d⁄e
;

226 
buf
 = 
	`kmÆloc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

227 i‡(!
buf
) {

228 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇotállocate buffer\n");

229 
d⁄e
;

232 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] intoÑam disk... ",

233 
nblocks
, (“blocks-1)/
devblocks
)+1,Çblocks>devblocks ? "s" : "");

234 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

235 i‡(
i
 && (ò% 
devblocks
 == 0)) {

236 
	`¥ötk
("d⁄êdisk #%d.\n", 
disk
++);

237 
rŸ©e
 = 0;

238 i‡(
	`sys_˛o£
(
ö_fd
)) {

239 
	`¥ötk
("Error closingÅhe disk.\n");

240 
no˛o£_öput
;

242 
	`ch™ge_Ê›py
("disk #%d", 
disk
);

243 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

244 i‡(
ö_fd
 < 0) {

245 
	`¥ötk
("Error opening disk.\n");

246 
no˛o£_öput
;

248 
	`¥ötk
("Lﬂdög disk #%d... ", 
disk
);

250 
	`sys_ªad
(
ö_fd
, 
buf
, 
BLOCK_SIZE
);

251 
	`sys_wrôe
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

252 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

253 i‡(!(
i
 % 16)) {

254 
	`¥ötk
("%c\b", 
rŸ©‹
[
rŸ©e
 & 0x3]);

255 
rŸ©e
++;

259 
	`¥ötk
("done.\n");

261 
suc˚ssful_lﬂd
:

262 
ªs
 = 1;

263 
d⁄e
:

264 
	`sys_˛o£
(
ö_fd
);

265 
no˛o£_öput
:

266 
	`sys_˛o£
(
out_fd
);

267 
out
:

268 
	`k‰ì
(
buf
);

269 
	`sys_u∆ök
("/dev/ram");

270  
ªs
;

271 
	}
}

273 
__öô
 
	$rd_lﬂd_disk
(
n
)

275 i‡(
rd_¥om±
)

276 
	`ch™ge_Ê›py
("root floppy diskÅo beÜoaded into RAM disk");

277 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

278 
	`¸óã_dev
("/dev/øm", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

279  
	`rd_lﬂd_image
("/dev/root");

280 
	}
}

282 
	gexô_code
;

283 
	gdecom¥ess_îr‹
;

284 
	g¸d_öfd
, 
	g¸d_outfd
;

286 
__öô
 
	$com¥_fûl
(*
buf
, 
Àn
)

288 
r
 = 
	`sys_ªad
(
¸d_öfd
, 
buf
, 
Àn
);

289 i‡(
r
 < 0)

290 
	`¥ötk
(
KERN_ERR
 "RAMDISK:Érror whileÑeading compressed data");

291 i‡(
r
 == 0)

292 
	`¥ötk
(
KERN_ERR
 "RAMDISK: EOF whileÑeading compressed data");

293  
r
;

294 
	}
}

296 
__öô
 
	$com¥_Êush
(*
wödow
, 
out˙t
)

298 
wrôãn
 = 
	`sys_wrôe
(
¸d_outfd
, 
wödow
, 
out˙t
);

299 i‡(
wrôãn
 !
out˙t
) {

300 i‡(
decom¥ess_îr‹
 == 0)

301 
	`¥ötk
(
KERN_ERR


303 
wrôãn
, 
out˙t
);

304 
decom¥ess_îr‹
 = 1;

307  
out˙t
;

308 
	}
}

310 
__öô
 
	$îr‹
(*
x
)

312 
	`¥ötk
(
KERN_ERR
 "%s\n", 
x
);

313 
exô_code
 = 1;

314 
decom¥ess_îr‹
 = 1;

315 
	}
}

317 
__öô
 
	$¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
)

319 
ªsu…
;

320 
¸d_öfd
 = 
ö_fd
;

321 
¸d_outfd
 = 
out_fd
;

322 
ªsu…
 = 
	`deco
(
NULL
, 0, 
com¥_fûl
, 
com¥_Êush
, NULL, NULL, 
îr‹
);

323 i‡(
decom¥ess_îr‹
)

324 
ªsu…
 = 1;

325  
ªsu…
;

326 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<löux/öô.h
>

2 
	~<löux/fs.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/ty≥s.h
>

5 
	~<löux/f˙é.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dúít.h
>

9 
	~<löux/sysˇŒs.h
>

10 
	~<löux/utime.h
>

12 
__öôd©a
 *
	gmesßge
;

13 
__öô
 
	$îr‹
(*
x
)

15 i‡(!
mesßge
)

16 
mesßge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Àn
Ë(((÷íË+ 1Ë& ~3Ë+ 2)

	)

23 
__öôd©a
 
	shash
 {

24 
	möo
, 
	mmö‹
, 
	mmaj‹
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	m√xt
;

27 
	m«me
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	ghód
[32];

30 
ölöe
 
	$hash
(
maj‹
, 
mö‹
, 
öo
)

32 
tmp
 = 
öo
 + 
mö‹
 + (
maj‹
 << 3);

33 
tmp
 +=Åmp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__öô
 *
	$föd_lök
(
maj‹
, 
mö‹
, 
öo
,

38 
mode_t
 
mode
, *
«me
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
hód
 + 
	`hash
(
maj‹
, 
mö‹
, 
öo
); *p;Ö = &(*p)->
√xt
) {

42 i‡((*
p
)->
öo
 != ino)

44 i‡((*
p
)->
mö‹
 != minor)

46 i‡((*
p
)->
maj‹
 != major)

48 i‡(((*
p
)->
mode
 ^ modeË& 
S_IFMT
)

50  (*
p
)->
«me
;

52 
q
 = 
	`kmÆloc
((
hash
), 
GFP_KERNEL
);

53 i‡(!
q
)

54 
	`∑nic
("can'tállocateÜink hashÉntry");

55 
q
->
maj‹
 = major;

56 
q
->
mö‹
 = minor;

57 
q
->
öo
 = ino;

58 
q
->
mode
 = mode;

59 
	`°r˝y
(
q
->
«me
,Çame);

60 
q
->
√xt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__öô
 
	$‰ì_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
hód
;Ö < head + 32;Ö++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
√xt
;

72 
	`k‰ì
(
q
);

75 
	}
}

77 
__öô
 
	$do_utime
(
__u£r
 *
fûíame
, 
time_t
 
mtime
)

79 
time•ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__öôd©a
 
LIST_HEAD
(
dú_li°
);

90 
	sdú_íåy
 {

91 
li°_hód
 
	mli°
;

92 *
	m«me
;

93 
time_t
 
	mmtime
;

96 
__öô
 
	$dú_add
(c⁄° *
«me
, 
time_t
 
mtime
)

98 
dú_íåy
 *
de
 = 
	`kmÆloc
((dú_íåy), 
GFP_KERNEL
);

99 i‡(!
de
)

100 
	`∑nic
("can'tállocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li°
);

102 
de
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li°_add
(&
de
->
li°
, &
dú_li°
);

105 
	}
}

107 
__öô
 
	$dú_utime
()

109 
dú_íåy
 *
de
, *
tmp
;

110 
	`li°_f‹_óch_íåy_ß„
(
de
, 
tmp
, &
dú_li°
, 
li°
) {

111 
	`li°_dñ
(&
de
->
li°
);

112 
	`do_utime
(
de
->
«me
, de->
mtime
);

113 
	`k‰ì
(
de
->
«me
);

114 
	`k‰ì
(
de
);

116 
	}
}

118 
__öôd©a
 
time_t
 
	gmtime
;

122 
__öôd©a
 
	göo
, 
	gmaj‹
, 
	gmö‹
, 
	g∆ök
;

123 
__öôd©a
 
mode_t
 
	gmode
;

124 
__öôd©a
 
	gbody_Àn
, 
	g«me_Àn
;

125 
__öôd©a
 
uid_t
 
	guid
;

126 
__öôd©a
 
gid_t
 
	ggid
;

127 
__öôd©a
 
	grdev
;

129 
__öô
 
	$∑r£_hódî
(*
s
)

131 
∑r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`mem˝y
(
buf
, 
s
, 8);

138 
∑r£d
[
i
] = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 16);

140 
öo
 = 
∑r£d
[0];

141 
mode
 = 
∑r£d
[1];

142 
uid
 = 
∑r£d
[2];

143 
gid
 = 
∑r£d
[3];

144 
∆ök
 = 
∑r£d
[4];

145 
mtime
 = 
∑r£d
[5];

146 
body_Àn
 = 
∑r£d
[6];

147 
maj‹
 = 
∑r£d
[7];

148 
mö‹
 = 
∑r£d
[8];

149 
rdev
 = 
	`√w_ícode_dev
(
	`MKDEV
(
∑r£d
[9],Öarsed[10]));

150 
«me_Àn
 = 
∑r£d
[11];

151 
	}
}

155 
__öôd©a
 
	e°©e
 {

156 
	mSèπ
,

157 
	mCﬁÀ˘
,

158 
	mGŸHódî
,

159 
	mSkùIt
,

160 
	mGŸName
,

161 
	mC›yFûe
,

162 
	mGŸSymlök
,

163 
	mRe£t


164 } 
	g°©e
, 
	g√xt_°©e
;

166 
__öôd©a
 *
	gvi˘im
;

167 
__öôd©a
 
	gcou¡
;

168 
__öôd©a
 
loff_t
 
	gthis_hódî
, 
	g√xt_hódî
;

170 
ölöe
 
__öô
 
	$ót
(
n
)

172 
vi˘im
 +
n
;

173 
this_hódî
 +
n
;

174 
cou¡
 -
n
;

175 
	}
}

177 
__öôd©a
 *
	gvcﬁÀ˘ed
;

178 
__öôd©a
 *
	gcﬁÀ˘ed
;

179 
__öôd©a
 
	gªmaös
;

180 
__öôd©a
 *
	gcﬁÀ˘
;

182 
__öô
 
	$ªad_öto
(*
buf
, 
size
, 
°©e
 
√xt
)

184 i‡(
cou¡
 >
size
) {

185 
cﬁÀ˘ed
 = 
vi˘im
;

186 
	`ót
(
size
);

187 
°©e
 = 
√xt
;

189 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
buf
;

190 
ªmaös
 = 
size
;

191 
√xt_°©e
 = 
√xt
;

192 
°©e
 = 
CﬁÀ˘
;

194 
	}
}

196 
__öôd©a
 *
	ghódî_buf
, *
	gsymlök_buf
, *
	g«me_buf
;

198 
__öô
 
	$do_°¨t
()

200 
	`ªad_öto
(
hódî_buf
, 110, 
GŸHódî
);

202 
	}
}

204 
__öô
 
	$do_cﬁÀ˘
()

206 
n
 = 
ªmaös
;

207 i‡(
cou¡
 < 
n
)

208 
n
 = 
cou¡
;

209 
	`mem˝y
(
cﬁÀ˘
, 
vi˘im
, 
n
);

210 
	`ót
(
n
);

211 
cﬁÀ˘
 +
n
;

212 i‡((
ªmaös
 -
n
) != 0)

214 
°©e
 = 
√xt_°©e
;

216 
	}
}

218 
__öô
 
	$do_hódî
()

220 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070707", 6)==0) {

221 
	`îr‹
("incorrect cpio method used: use -HÇewc option");

224 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070701", 6)) {

225 
	`îr‹
("no cpio magic");

228 
	`∑r£_hódî
(
cﬁÀ˘ed
);

229 
√xt_hódî
 = 
this_hódî
 + 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

230 
√xt_hódî
 = (next_header + 3) & ~3;

231 
°©e
 = 
SkùIt
;

232 i‡(
«me_Àn
 <0 ||Çame_À¿> 
PATH_MAX
)

234 i‡(
	`S_ISLNK
(
mode
)) {

235 i‡(
body_Àn
 > 
PATH_MAX
)

237 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
symlök_buf
;

238 
ªmaös
 = 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

239 
√xt_°©e
 = 
GŸSymlök
;

240 
°©e
 = 
CﬁÀ˘
;

243 i‡(
	`S_ISREG
(
mode
Ë|| !
body_Àn
)

244 
	`ªad_öto
(
«me_buf
, 
	`N_ALIGN
(
«me_Àn
), 
GŸName
);

246 
	}
}

248 
__öô
 
	$do_skù
()

250 i‡(
this_hódî
 + 
cou¡
 < 
√xt_hódî
) {

251 
	`ót
(
cou¡
);

254 
	`ót
(
√xt_hódî
 - 
this_hódî
);

255 
°©e
 = 
√xt_°©e
;

258 
	}
}

260 
__öô
 
	$do_ª£t
()

262 
cou¡
 && *
vi˘im
 == '\0')

263 
	`ót
(1);

264 i‡(
cou¡
 && (
this_hódî
 & 3))

265 
	`îr‹
("brokenÖadding");

267 
	}
}

269 
__öô
 
	$maybe_lök
()

271 i‡(
∆ök
 >= 2) {

272 *
ﬁd
 = 
	`föd_lök
(
maj‹
, 
mö‹
, 
öo
, 
mode
, 
cﬁÀ˘ed
);

273 i‡(
ﬁd
)

274  (
	`sys_lök
(
ﬁd
, 
cﬁÀ˘ed
) < 0) ? -1 : 1;

277 
	}
}

279 
__öô
 
	$˛ón_∑th
(*
∑th
, 
mode_t
 
mode
)

281 
°©
 
°
;

283 i‡(!
	`sys_√wl°©
(
∑th
, &
°
Ë&& (°.
°_mode
^
mode
Ë& 
S_IFMT
) {

284 i‡(
	`S_ISDIR
(
°
.
°_mode
))

285 
	`sys_rmdú
(
∑th
);

287 
	`sys_u∆ök
(
∑th
);

289 
	}
}

291 
__öôd©a
 
	gwfd
;

293 
__öô
 
	$do_«me
()

295 
°©e
 = 
SkùIt
;

296 
√xt_°©e
 = 
Re£t
;

297 i‡(
	`°rcmp
(
cﬁÀ˘ed
, "TRAILER!!!") == 0) {

298 
	`‰ì_hash
();

301 
	`˛ón_∑th
(
cﬁÀ˘ed
, 
mode
);

302 i‡(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lök
();

304 i‡(
ml
 >= 0) {

305 
›íÊags
 = 
O_WRONLY
|
O_CREAT
;

306 i‡(
ml
 != 1)

307 
›íÊags
 |
O_TRUNC
;

308 
wfd
 = 
	`sys_›í
(
cﬁÀ˘ed
, 
›íÊags
, 
mode
);

310 i‡(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 i‡(
body_Àn
)

314 
	`sys_·runˇã
(
wfd
, 
body_Àn
);

315 
vcﬁÀ˘ed
 = 
	`k°rdup
(
cﬁÀ˘ed
, 
GFP_KERNEL
);

316 
°©e
 = 
C›yFûe
;

319 } i‡(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdú
(
cﬁÀ˘ed
, 
mode
);

321 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

323 
	`dú_add
(
cﬁÀ˘ed
, 
mtime
);

324 } i‡(
	`S_ISBLK
(
mode
Ë|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

326 i‡(
	`maybe_lök
() == 0) {

327 
	`sys_mknod
(
cﬁÀ˘ed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

330 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

334 
	}
}

336 
__öô
 
	$do_c›y
()

338 i‡(
cou¡
 >
body_Àn
) {

339 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
body_Àn
);

340 
	`sys_˛o£
(
wfd
);

341 
	`do_utime
(
vcﬁÀ˘ed
, 
mtime
);

342 
	`k‰ì
(
vcﬁÀ˘ed
);

343 
	`ót
(
body_Àn
);

344 
°©e
 = 
SkùIt
;

347 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
cou¡
);

348 
body_Àn
 -
cou¡
;

349 
	`ót
(
cou¡
);

352 
	}
}

354 
__öô
 
	$do_symlök
()

356 
cﬁÀ˘ed
[
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
] = '\0';

357 
	`˛ón_∑th
(
cﬁÀ˘ed
, 0);

358 
	`sys_symlök
(
cﬁÀ˘ed
 + 
	`N_ALIGN
(
«me_Àn
), collected);

359 
	`sys_lchown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

360 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

361 
°©e
 = 
SkùIt
;

362 
√xt_°©e
 = 
Re£t
;

364 
	}
}

366 
__öôd©a
 (*
a˘i⁄s
[])() = {

367 [
Sèπ
] = 
do_°¨t
,

368 [
CﬁÀ˘
] = 
do_cﬁÀ˘
,

369 [
GŸHódî
] = 
do_hódî
,

370 [
SkùIt
] = 
do_skù
,

371 [
GŸName
] = 
do_«me
,

372 [
C›yFûe
] = 
do_c›y
,

373 [
GŸSymlök
] = 
do_symlök
,

374 [
Re£t
] = 
do_ª£t
,

375 
	}
};

377 
__öô
 
	$wrôe_buf„r
(*
buf
, 
Àn
)

379 
cou¡
 = 
Àn
;

380 
vi˘im
 = 
buf
;

382 !
a˘i⁄s
[
°©e
]())

384  
Àn
 - 
cou¡
;

385 
	}
}

387 
__öô
 
	$Êush_buf„r
(*
bufv
, 
Àn
)

389 *
buf
 = (*Ë
bufv
;

390 
wrôãn
;

391 
‹igLí
 = 
Àn
;

392 i‡(
mesßge
)

394 (
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
)Ë<Üí && !
mesßge
) {

395 
c
 = 
buf
[
wrôãn
];

396 i‡(
c
 == '0') {

397 
buf
 +
wrôãn
;

398 
Àn
 -
wrôãn
;

399 
°©e
 = 
Sèπ
;

400 } i‡(
c
 == 0) {

401 
buf
 +
wrôãn
;

402 
Àn
 -
wrôãn
;

403 
°©e
 = 
Re£t
;

405 
	`îr‹
("junk in compressedárchive");

407  
‹igLí
;

408 
	}
}

410 
	gmy_ö±r
;

412 
	~<löux/decom¥ess/gíîic.h
>

414 * 
__öô
 
	$u≈ack_to_roŸfs
(*
buf
, 
Àn
)

416 
wrôãn
;

417 
decom¥ess_‚
 
decom¥ess
;

418 c⁄° *
com¥ess_«me
;

419 
__öôd©a
 
msg_buf
[64];

421 
hódî_buf
 = 
	`kmÆloc
(110, 
GFP_KERNEL
);

422 
symlök_buf
 = 
	`kmÆloc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXË+ 1, 
GFP_KERNEL
);

423 
«me_buf
 = 
	`kmÆloc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 i‡(!
hódî_buf
 || !
symlök_buf
 || !
«me_buf
)

426 
	`∑nic
("can'tállocate buffers");

428 
°©e
 = 
Sèπ
;

429 
this_hódî
 = 0;

430 
mesßge
 = 
NULL
;

431 !
mesßge
 && 
Àn
) {

432 
loff_t
 
ßved_off£t
 = 
this_hódî
;

433 i‡(*
buf
 ='0' && !(
this_hódî
 & 3)) {

434 
°©e
 = 
Sèπ
;

435 
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
);

436 
buf
 +
wrôãn
;

437 
Àn
 -
wrôãn
;

440 i‡(!*
buf
) {

441 
buf
++;

442 
Àn
--;

443 
this_hódî
++;

446 
this_hódî
 = 0;

447 
decom¥ess
 = 
	`decom¥ess_mëhod
(
buf
, 
Àn
, &
com¥ess_«me
);

448 i‡(
decom¥ess
)

449 
	`decom¥ess
(
buf
, 
Àn
, 
NULL
, 
Êush_buf„r
, NULL,

450 &
my_ö±r
, 
îr‹
);

451 i‡(
com¥ess_«me
) {

452 i‡(!
mesßge
) {

453 
	`¢¥ötf
(
msg_buf
,  msg_buf,

455 
com¥ess_«me
);

456 
mesßge
 = 
msg_buf
;

459 i‡(
°©e
 !
Re£t
)

460 
	`îr‹
("junk in compressedárchive");

461 
this_hódî
 = 
ßved_off£t
 + 
my_ö±r
;

462 
buf
 +
my_ö±r
;

463 
Àn
 -
my_ö±r
;

465 
	`dú_utime
();

466 
	`k‰ì
(
«me_buf
);

467 
	`k‰ì
(
symlök_buf
);

468 
	`k‰ì
(
hódî_buf
);

469  
mesßge
;

470 
	}
}

472 
__öôd©a
 
	gdo_ªèö_öôrd
;

474 
__öô
 
	$ªèö_öôrd_∑øm
(*
°r
)

476 i‡(*
°r
)

478 
do_ªèö_öôrd
 = 1;

480 
	}
}

481 
__£tup
("ªèö_öôrd", 
ªèö_öôrd_∑øm
);

483 
__öôømfs_°¨t
[], 
__öôømfs_íd
[];

484 
	~<löux/öôrd.h
>

485 
	~<löux/kexec.h
>

487 
__öô
 
	$‰ì_öôrd
()

489 #ifde‡
CONFIG_KEXEC


490 
¸ashk_°¨t
 = ()
	`__va
(
¸ashk_ªs
.
°¨t
);

491 
¸ashk_íd
 = ()
	`__va
(
¸ashk_ªs
.
íd
);

493 i‡(
do_ªèö_öôrd
)

494 
skù
;

496 #ifde‡
CONFIG_KEXEC


501 i‡(
öôrd_°¨t
 < 
¸ashk_íd
 && 
öôrd_íd
 > 
¸ashk_°¨t
) {

506 
	`mem£t
((*)
öôrd_°¨t
, 0, 
öôrd_íd
 - initrd_start);

507 i‡(
öôrd_°¨t
 < 
¸ashk_°¨t
)

508 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
¸ashk_°¨t
);

509 i‡(
öôrd_íd
 > 
¸ashk_íd
)

510 
	`‰ì_öôrd_mem
(
¸ashk_íd
, 
öôrd_íd
);

513 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
öôrd_íd
);

514 
skù
:

515 
öôrd_°¨t
 = 0;

516 
öôrd_íd
 = 0;

517 
	}
}

519 #ifde‡
CONFIG_BLK_DEV_RAM


520 
	#BUF_SIZE
 1024

	)

521 
__öô
 
	$˛ón_roŸfs
()

523 
fd
;

524 *
buf
;

525 
löux_dúít64
 *
dúp
;

526 
cou¡
;

528 
fd
 = 
	`sys_›í
("/", 
O_RDONLY
, 0);

529 
	`WARN_ON
(
fd
 < 0);

530 i‡(
fd
 < 0)

532 
buf
 = 
	`kzÆloc
(
BUF_SIZE
, 
GFP_KERNEL
);

533 
	`WARN_ON
(!
buf
);

534 i‡(!
buf
) {

535 
	`sys_˛o£
(
fd
);

539 
dúp
 = 
buf
;

540 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

541 
cou¡
 > 0) {

542 
cou¡
 > 0) {

543 
°©
 
°
;

544 
ªt
;

546 
ªt
 = 
	`sys_√wl°©
(
dúp
->
d_«me
, &
°
);

547 
	`WARN_ON_ONCE
(
ªt
);

548 i‡(!
ªt
) {

549 i‡(
	`S_ISDIR
(
°
.
°_mode
))

550 
	`sys_rmdú
(
dúp
->
d_«me
);

552 
	`sys_u∆ök
(
dúp
->
d_«me
);

555 
cou¡
 -
dúp
->
d_ª˛í
;

556 
dúp
 = (*)dú∞+ dúp->
d_ª˛í
;

558 
dúp
 = 
buf
;

559 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

560 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

563 
	`sys_˛o£
(
fd
);

564 
	`k‰ì
(
buf
);

565 
	}
}

568 
__öô
 
	$p›uœã_roŸfs
()

570 *
îr
 = 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

571 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

572 i‡(
îr
)

573 
	`∑nic
(
îr
);

574 i‡(
öôrd_°¨t
) {

575 #ifde‡
CONFIG_BLK_DEV_RAM


576 
fd
;

577 
	`¥ötk
(
KERN_INFO
 "TryingÅo unpackÑootfs imageás initramfs...\n");

578 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

579 
öôrd_íd
 - 
öôrd_°¨t
);

580 i‡(!
îr
) {

581 
	`‰ì_öôrd
();

584 
	`˛ón_roŸfs
();

585 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

586 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

588 
	`¥ötk
(
KERN_INFO
 "rootfs image isÇot initramfs (%s)"

589 ";Üook†likê™ inôrd\n", 
îr
);

590 
fd
 = 
	`sys_›í
("/öôrd.image", 
O_WRONLY
|
O_CREAT
, 0700);

591 i‡(
fd
 >= 0) {

592 
	`sys_wrôe
(
fd
, (*)
öôrd_°¨t
,

593 
öôrd_íd
 - 
öôrd_°¨t
);

594 
	`sys_˛o£
(
fd
);

595 
	`‰ì_öôrd
();

598 
	`¥ötk
(
KERN_INFO
 "Unpacking initramfs...\n");

599 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

600 
öôrd_íd
 - 
öôrd_°¨t
);

601 i‡(
îr
)

602 
	`¥ötk
(
KERN_EMERG
 "Inôømf†u≈ackög faûed: %s\n", 
îr
);

603 
	`‰ì_öôrd
();

607 
	}
}

608 
roŸfs_öôˇŒ
(
p›uœã_roŸfs
);

	@/cmpt816/linux/init/main.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/˘y≥.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/ut¢ame.h
>

22 
	~<löux/i›‹t.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp_lock.h
>

25 
	~<löux/öôrd.h
>

26 
	~<löux/boŸmem.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/ây.h
>

29 
	~<löux/gÂ.h
>

30 
	~<löux/≥r˝u.h
>

31 
	~<löux/kmod.h
>

32 
	~<löux/vmÆloc.h
>

33 
	~<löux/kî√l_°©.h
>

34 
	~<löux/°¨t_kî√l.h
>

35 
	~<löux/£curôy.h
>

36 
	~<löux/smp.h
>

37 
	~<löux/w‹kqueue.h
>

38 
	~<löux/¥ofûe.h
>

39 
	~<löux/rcupd©e.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/kÆlsyms.h
>

42 
	~<löux/wrôeback.h
>

43 
	~<löux/˝u.h
>

44 
	~<löux/˝u£t.h
>

45 
	~<löux/cgroup.h
>

46 
	~<löux/efi.h
>

47 
	~<löux/tick.h
>

48 
	~<löux/öãºu±.h
>

49 
	~<löux/èsk°©s_kîn.h
>

50 
	~<löux/dñayac˘.h
>

51 
	~<löux/uni°d.h
>

52 
	~<löux/rm≠.h
>

53 
	~<löux/mempﬁicy.h
>

54 
	~<löux/key.h
>

55 
	~<löux/buf„r_hód.h
>

56 
	~<löux/∑ge_cgroup.h
>

57 
	~<löux/debug_locks.h
>

58 
	~<löux/debugobje˘s.h
>

59 
	~<löux/lockdï.h
>

60 
	~<löux/kmemÀak.h
>

61 
	~<löux/pid_«me•a˚.h
>

62 
	~<löux/devi˚.h
>

63 
	~<löux/kthªad.h
>

64 
	~<löux/sched.h
>

65 
	~<löux/sig«l.h
>

66 
	~<löux/idr.h
>

67 
	~<löux/·ø˚.h
>

68 
	~<löux/async.h
>

69 
	~<löux/kmemcheck.h
>

70 
	~<löux/kmemåa˚.h
>

71 
	~<åa˚/boŸ.h
>

73 
	~<asm/io.h
>

74 
	~<asm/bugs.h
>

75 
	~<asm/£tup.h
>

76 
	~<asm/£˘i⁄s.h
>

77 
	~<asm/ˇcheÊush.h
>

79 #ifde‡
CONFIG_X86_LOCAL_APIC


80 
	~<asm/smp.h
>

83 
kî√l_öô
(*);

85 
öô_IRQ
();

86 
f‹k_öô
();

87 
mˇ_öô
();

88 
sbus_öô
();

89 
¥io_åì_öô
();

90 
ødix_åì_öô
();

91 
‰ì_öômem
();

92 #i‚de‡
CONFIG_DEBUG_RODATA


93 
ölöe
 
	$m¨k_rod©a_ro
(Ë{ 
	}
}

96 #ifde‡
CONFIG_TC


97 
tc_öô
();

100 
sy°em_°©es
 
sy°em_°©e
 
	g__ªad_mo°ly
;

101 
EXPORT_SYMBOL
(
sy°em_°©e
);

106 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

107 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

109 
time_öô
();

111 (*
__öôd©a
 
œã_time_öô
)();

112 
	`so·úq_öô
();

115 
__öôd©a
 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
];

117 *
ßved_comm™d_löe
;

119 *
°©ic_comm™d_löe
;

121 *
execuã_comm™d
;

122 *
ømdisk_execuã_comm™d
;

124 #ifde‡
CONFIG_SMP


126 
__öôd©a
 
£tup_max_˝us
 = 
NR_CPUS
;

139 
__wók
 
	$¨ch_dißbÀ_smp_suµ‹t
(Ë{ 
	}
}

141 
__öô
 
	$nosmp
(*
°r
)

143 
£tup_max_˝us
 = 0;

144 
	`¨ch_dißbÀ_smp_suµ‹t
();

147 
	}
}

149 
óæy_∑øm
("nosmp", 
nosmp
);

151 
__öô
 
	$max˝us
(*
°r
)

153 
	`gë_›ti⁄
(&
°r
, &
£tup_max_˝us
);

154 i‡(
£tup_max_˝us
 == 0)

155 
	`¨ch_dißbÀ_smp_suµ‹t
();

158 
	}
}

160 
óæy_∑øm
("max˝us", 
max˝us
);

162 c⁄° 
	g£tup_max_˝us
 = 
NR_CPUS
;

174 
	gª£t_devi˚s
;

175 
EXPORT_SYMBOL
(
ª£t_devi˚s
);

177 
__öô
 
	$£t_ª£t_devi˚s
(*
°r
)

179 
ª£t_devi˚s
 = 1;

181 
	}
}

183 
__£tup
("ª£t_devi˚s", 
£t_ª£t_devi˚s
);

185 * 
	g¨gv_öô
[
MAX_INIT_ARGS
+2] = { "öô", 
NULL
, };

186 * 
	gívp_öô
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMˆöux", 
NULL
, };

187 c⁄° *
	g∑nic_œãr
, *
	g∑nic_∑øm
;

189 
obs_kî√l_∑øm
 
__£tup_°¨t
[], 
__£tup_íd
[];

191 
__öô
 
	$obsﬁëe_check£tup
(*
löe
)

193 
obs_kî√l_∑øm
 *
p
;

194 
had_óæy_∑øm
 = 0;

196 
p
 = 
__£tup_°¨t
;

198 
n
 = 
	`°æí
(
p
->
°r
);

199 i‡(!
	`°∫cmp
(
löe
, 
p
->
°r
, 
n
)) {

200 i‡(
p
->
óæy
) {

205 i‡(
löe
[
n
] == '\0' ||Üine[n] == '=')

206 
had_óæy_∑øm
 = 1;

207 } i‡(!
p
->
£tup_func
) {

208 
	`¥ötk
(
KERN_WARNING
 "Parameter %s is obsolete,"

209 " ign‹ed\n", 
p
->
°r
);

211 } i‡(
p
->
	`£tup_func
(
löe
 + 
n
))

214 
p
++;

215 } 
p
 < 
__£tup_íd
);

217  
had_óæy_∑øm
;

218 
	}
}

224 
	glo›s_≥r_jiffy
 = (1<<12);

226 
EXPORT_SYMBOL
(
lo›s_≥r_jiffy
);

228 
__öô
 
	$debug_kî√l
(*
°r
)

230 
c⁄sﬁe_logÀvñ
 = 10;

232 
	}
}

234 
__öô
 
	$quõt_kî√l
(*
°r
)

236 
c⁄sﬁe_logÀvñ
 = 4;

238 
	}
}

240 
óæy_∑øm
("debug", 
debug_kî√l
);

241 
óæy_∑øm
("quõt", 
quõt_kî√l
);

243 
__öô
 
	$logÀvñ
(*
°r
)

245 
	`gë_›ti⁄
(&
°r
, &
c⁄sﬁe_logÀvñ
);

247 
	}
}

249 
óæy_∑øm
("logÀvñ", 
logÀvñ
);

255 
__öô
 
	$unknown_boŸ›ti⁄
(*
∑øm
, *
vÆ
)

258 i‡(
vÆ
) {

260 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+1)

261 
vÆ
[-1] = '=';

262 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+2) {

263 
vÆ
[-2] = '=';

264 
	`memmove
(
vÆ
-1, vÆ, 
	`°æí
(val)+1);

265 
vÆ
--;

267 
	`BUG
();

271 i‡(
	`obsﬁëe_check£tup
(
∑øm
))

278 i‡(
	`°rchr
(
∑øm
, '.'Ë&& (!
vÆ
 || strchr(param, '.') < val)) {

279 
	`¥ötk
(
KERN_ERR
 "Unknow¿boŸ o±i⁄ `%s': ign‹ög\n", 
∑øm
);

283 i‡(
∑nic_œãr
)

286 i‡(
vÆ
) {

288 
i
;

289 
i
 = 0; 
ívp_öô
[i]; i++) {

290 i‡(
i
 =
MAX_INIT_ENVS
) {

291 
∑nic_œãr
 = "Too many bootÉnv varsát `%s'";

292 
∑nic_∑øm
 = 
∑øm
;

294 i‡(!
	`°∫cmp
(
∑øm
, 
ívp_öô
[
i
], 
vÆ
 -Öaram))

297 
ívp_öô
[
i
] = 
∑øm
;

300 
i
;

301 
i
 = 0; 
¨gv_öô
[i]; i++) {

302 i‡(
i
 =
MAX_INIT_ARGS
) {

303 
∑nic_œãr
 = "Too many boot init varsát `%s'";

304 
∑nic_∑øm
 = 
∑øm
;

307 
¨gv_öô
[
i
] = 
∑øm
;

310 
	}
}

312 #ifde‡
CONFIG_DEBUG_PAGEALLOC


313 
__ªad_mo°ly
 
	gdebug_∑góŒoc_íabÀd
 = 0;

316 
__öô
 
	$öô_£tup
(*
°r
)

318 
i
;

320 
execuã_comm™d
 = 
°r
;

327 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

328 
¨gv_öô
[
i
] = 
NULL
;

330 
	}
}

331 
__£tup
("öô=", 
öô_£tup
);

333 
__öô
 
	$rdöô_£tup
(*
°r
)

335 
i
;

337 
ømdisk_execuã_comm™d
 = 
°r
;

339 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

340 
¨gv_öô
[
i
] = 
NULL
;

342 
	}
}

343 
__£tup
("rdöô=", 
rdöô_£tup
);

345 #i‚de‡
CONFIG_SMP


347 #ifde‡
CONFIG_X86_LOCAL_APIC


348 
__öô
 
	$smp_öô
()

350 
	`APIC_öô_unùro˚ss‹
();

351 
	}
}

353 
	#smp_öô
(Ëdÿ{ } 0)

	)

356 
ölöe
 
	$£tup_≥r_˝u_¨ós
(Ë{ 
	}
}

357 
ölöe
 
	$£tup_ƒ_˝u_ids
(Ë{ 
	}
}

358 
ölöe
 
	$smp_¥ï¨e_˝us
(
max˝us
Ë{ 
	}
}

362 #i‡
NR_CPUS
 > 
BITS_PER_LONG


363 
˝umask_t
 
˝u_mask_Æl
 
	g__ªad_mo°ly
 = 
CPU_MASK_ALL
;

364 
EXPORT_SYMBOL
(
˝u_mask_Æl
);

368 
ƒ_˝u_ids
 
	g__ªad_mo°ly
 = 
NR_CPUS
;

369 
EXPORT_SYMBOL
(
ƒ_˝u_ids
);

372 
__öô
 
	$£tup_ƒ_˝u_ids
()

374 
ƒ_˝u_ids
 = 
	`föd_œ°_bô
(
	`˝umask_bôs
(
˝u_possibÀ_mask
),
NR_CPUS
) + 1;

375 
	}
}

377 #i‚de‡
CONFIG_HAVE_SETUP_PER_CPU_AREA


378 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
;

380 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

382 
__öô
 
	$£tup_≥r_˝u_¨ós
()

384 
size
, 
i
;

385 *
±r
;

386 
ƒ_possibÀ_˝us
 = 
	`num_possibÀ_˝us
();

389 
size
 = 
	`ALIGN
(
PERCPU_ENOUGH_ROOM
, 
PAGE_SIZE
);

390 
±r
 = 
	`Æloc_boŸmem_∑ges
(
size
 * 
ƒ_possibÀ_˝us
);

392 
	`f‹_óch_possibÀ_˝u
(
i
) {

393 
__≥r_˝u_off£t
[
i
] = 
±r
 - 
__≥r_˝u_°¨t
;

394 
	`mem˝y
(
±r
, 
__≥r_˝u_°¨t
, 
__≥r_˝u_íd
 - __per_cpu_start);

395 
±r
 +
size
;

397 
	}
}

401 
__öô
 
	$smp_öô
()

403 
˝u
;

409 
	`£t_˝u_a˘ive
(
	`smp_¥o˚ss‹_id
(), 
åue
);

412 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

413 i‡(
	`num_⁄löe_˝us
(Ë>
£tup_max_˝us
)

415 i‡(!
	`˝u_⁄löe
(
˝u
))

416 
	`˝u_up
(
˝u
);

420 
	`¥ötk
(
KERN_INFO
 "Broughàu∞%ld CPUs\n", ()
	`num_⁄löe_˝us
());

421 
	`smp_˝us_d⁄e
(
£tup_max_˝us
);

422 
	}
}

432 
__öô
 
	$£tup_comm™d_löe
(*
comm™d_löe
)

434 
ßved_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
boŸ_comm™d_löe
)+1);

435 
°©ic_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
comm™d_löe
)+1);

436 
	`°r˝y
 (
ßved_comm™d_löe
, 
boŸ_comm™d_löe
);

437 
	`°r˝y
 (
°©ic_comm™d_löe
, 
comm™d_löe
);

438 
	}
}

449 
noölöe
 
__öô_ªfok
 
	$ª°_öô
()

450 
	$__ªÀa£s
(
kî√l_lock
)

452 
pid
;

454 
	`kî√l_thªad
(
kî√l_öô
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

455 
	`numa_deÁu…_pﬁicy
();

456 
pid
 = 
	`kî√l_thªad
(
kthªadd
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

457 
kthªadd_èsk
 = 
	`föd_èsk_by_pid_ns
(
pid
, &
öô_pid_ns
);

458 
	`u∆ock_kî√l
();

464 
	`öô_idÀ_boŸup_èsk
(
cuºít
);

465 
	`rcu_scheduÀr_°¨tög
();

466 
	`¥ìm±_íabÀ_no_ªsched
();

467 
	`scheduÀ
();

468 
	`¥ìm±_dißbÀ
();

471 
	`˝u_idÀ
();

472 
	}
}

475 
__öô
 
	$do_óæy_∑øm
(*
∑øm
, *
vÆ
)

477 
obs_kî√l_∑øm
 *
p
;

479 
p
 = 
__£tup_°¨t
;Ö < 
__£tup_íd
;Ö++) {

480 i‡((
p
->
óæy
 && 
	`°rcmp
(
∑øm
,Ö->
°r
) == 0) ||

481 (
	`°rcmp
(
∑øm
, "console") == 0 &&

482 
	`°rcmp
(
p
->
°r
, "earlycon") == 0)

484 i‡(
p
->
	`£tup_func
(
vÆ
) != 0)

485 
	`¥ötk
(
KERN_WARNING


486 "MÆf‹medÉ¨ly o±i⁄ '%s'\n", 
∑øm
);

491 
	}
}

493 
__öô
 
	$∑r£_óæy_›ti⁄s
(*
cmdlöe
)

495 
	`∑r£_¨gs
("óæy o±i⁄s", 
cmdlöe
, 
NULL
, 0, 
do_óæy_∑øm
);

496 
	}
}

499 
__öô
 
	$∑r£_óæy_∑øm
()

501 
__öôd©a
 
d⁄e
 = 0;

502 
__öôd©a
 
tmp_cmdlöe
[
COMMAND_LINE_SIZE
];

504 i‡(
d⁄e
)

508 
	`°æ˝y
(
tmp_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

509 
	`∑r£_óæy_›ti⁄s
(
tmp_cmdlöe
);

510 
d⁄e
 = 1;

511 
	}
}

517 
__öô
 
	$boŸ_˝u_öô
()

519 
˝u
 = 
	`smp_¥o˚ss‹_id
();

521 
	`£t_˝u_⁄löe
(
˝u
, 
åue
);

522 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

523 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

524 
	}
}

526 
__öô
 
__wók
 
	$smp_£tup_¥o˚ss‹_id
()

528 
	}
}

530 
__öô
 
__wók
 
	$thªad_öfo_ˇche_öô
()

532 
	}
}

537 
__öô
 
	$mm_öô
()

543 
	`∑ge_cgroup_öô_Ê©mem
();

544 
	`mem_öô
();

545 
	`kmem_ˇche_öô
();

546 
	`pgèbÀ_ˇche_öô
();

547 
	`vmÆloc_öô
();

548 
	}
}

550 
asmlökage
 
__öô
 
	$°¨t_kî√l
()

552 * 
comm™d_löe
;

553 
kî√l_∑øm
 
__°¨t___∑øm
[], 
__°›___∑øm
[];

555 
	`smp_£tup_¥o˚ss‹_id
();

561 
	`lockdï_öô
();

562 
	`debug_obje˘s_óæy_öô
();

567 
	`boŸ_öô_°ack_ˇ«ry
();

569 
	`cgroup_öô_óæy
();

571 
	`loˇl_úq_dißbÀ
();

572 
	`óæy_boŸ_úqs_off
();

573 
	`óæy_öô_úq_lock_˛ass
();

579 
	`lock_kî√l
();

580 
	`tick_öô
();

581 
	`boŸ_˝u_öô
();

582 
	`∑ge_addªss_öô
();

583 
	`¥ötk
(
KERN_NOTICE
 "%s", 
löux_b™√r
);

584 
	`£tup_¨ch
(&
comm™d_löe
);

585 
	`mm_öô_ow√r
(&
öô_mm
, &
öô_èsk
);

586 
	`£tup_comm™d_löe
(
comm™d_löe
);

587 
	`£tup_ƒ_˝u_ids
();

588 
	`£tup_≥r_˝u_¨ós
();

589 
	`smp_¥ï¨e_boŸ_˝u
();

591 
	`buûd_Æl_z⁄ñi°s
();

592 
	`∑ge_Æloc_öô
();

594 
	`¥ötk
(
KERN_NOTICE
 "Kî√»comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

595 
	`∑r£_óæy_∑øm
();

596 
	`∑r£_¨gs
("BoŸög kî√l", 
°©ic_comm™d_löe
, 
__°¨t___∑øm
,

597 
__°›___∑øm
 - 
__°¨t___∑øm
,

598 &
unknown_boŸ›ti⁄
);

603 
	`pidhash_öô
();

604 
	`vfs_ˇches_öô_óæy
();

605 
	`s‹t_maö_exèbÀ
();

606 
	`å≠_öô
();

607 
	`mm_öô
();

613 
	`sched_öô
();

618 
	`¥ìm±_dißbÀ
();

619 i‡(!
	`úqs_dißbÀd
()) {

620 
	`¥ötk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

622 
	`loˇl_úq_dißbÀ
();

624 
	`rcu_öô
();

626 
	`óæy_úq_öô
();

627 
	`öô_IRQ
();

628 
	`¥io_åì_öô
();

629 
	`öô_timîs
();

630 
	`hπimîs_öô
();

631 
	`so·úq_öô
();

632 
	`timekìpög_öô
();

633 
	`time_öô
();

634 
	`sched_˛ock_öô
();

635 
	`¥ofûe_öô
();

636 i‡(!
	`úqs_dißbÀd
())

637 
	`¥ötk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

639 
	`óæy_boŸ_úqs_⁄
();

640 
	`loˇl_úq_íabÀ
();

643 
	`£t_gÂ_Ælowed_mask
(
__GFP_BITS_MASK
);

645 
	`kmem_ˇche_öô_œã
();

652 
	`c⁄sﬁe_öô
();

653 i‡(
∑nic_œãr
)

654 
	`∑nic
(
∑nic_œãr
, 
∑nic_∑øm
);

656 
	`lockdï_öfo
();

663 
	`lockög_£l·e°
();

665 #ifde‡
CONFIG_BLK_DEV_INITRD


666 i‡(
öôrd_°¨t
 && !
öôrd_bñow_°¨t_ok
 &&

667 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)Ë< 
mö_low_p‚
) {

668 
	`¥ötk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

670 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)),

671 
mö_low_p‚
);

672 
öôrd_°¨t
 = 0;

675 
	`∑ge_cgroup_öô
();

676 
	`íabÀ_debug_∑góŒoc
();

677 
	`kmemåa˚_öô
();

678 
	`kmemÀak_öô
();

679 
	`debug_obje˘s_mem_öô
();

680 
	`idr_öô_ˇche
();

681 
	`£tup_≥r_˝u_∑ge£t
();

682 
	`numa_pﬁicy_öô
();

683 i‡(
œã_time_öô
)

684 
	`œã_time_öô
();

685 
	`ˇlibøã_dñay
();

686 
	`pidm≠_öô
();

687 
	`™⁄_vma_öô
();

688 #ifde‡
CONFIG_X86


689 i‡(
efi_íabÀd
)

690 
	`efi_íãr_vútuÆ_mode
();

692 
	`thªad_öfo_ˇche_öô
();

693 
	`¸ed_öô
();

694 
	`f‹k_öô
(
num_phy•ages
);

695 
	`¥oc_ˇches_öô
();

696 
	`buf„r_öô
();

697 
	`key_öô
();

698 
	`£curôy_öô
();

699 
	`vfs_ˇches_öô
(
num_phy•ages
);

700 
	`ødix_åì_öô
();

701 
	`sig«ls_öô
();

703 
	`∑ge_wrôeback_öô
();

704 #ifde‡
CONFIG_PROC_FS


705 
	`¥oc_roŸ_öô
();

707 
	`cgroup_öô
();

708 
	`˝u£t_öô
();

709 
	`èsk°©s_öô_óæy
();

710 
	`dñayac˘_öô
();

712 
	`check_bugs
();

714 
	`a˝i_óæy_öô
();

716 
	`·ø˚_öô
();

719 
	`ª°_öô
();

720 
	}
}

723 
__öô
 
	$do_˘‹s
()

725 #ifde‡
CONFIG_CONSTRUCTORS


726 
˘‹_‚_t
 *
ˇŒ
 = (˘‹_‚_à*Ë
__˘‹s_°¨t
;

728 ; 
ˇŒ
 < (
˘‹_‚_t
 *Ë
__˘‹s_íd
; call++)

729 (*
ˇŒ
)();

731 
	}
}

733 
	göôˇŒ_debug
;

734 
c‹e_∑øm
(
öôˇŒ_debug
, inôˇŒ_debug, 
boﬁ
, 0644);

736 
	gmsgbuf
[64];

737 
boŸ_åa˚_ˇŒ
 
	gˇŒ
;

738 
boŸ_åa˚_ªt
 
	gªt
;

740 
	$do_⁄e_öôˇŒ
(
öôˇŒ_t
 
‚
)

742 
cou¡
 = 
	`¥ìm±_cou¡
();

743 
ktime_t
 
ˇŒtime
, 
dñè
, 
ªâime
;

745 i‡(
öôˇŒ_debug
) {

746 
ˇŒ
.
ˇŒî
 = 
	`èsk_pid_ƒ
(
cuºít
);

747 
	`¥ötk
("ˇŒög %pF @ %i\n", 
‚
, 
ˇŒ
.
ˇŒî
);

748 
ˇŒtime
 = 
	`ktime_gë
();

749 
	`åa˚_boŸ_ˇŒ
(&
ˇŒ
, 
‚
);

750 
	`íabÀ_boŸ_åa˚
();

753 
ªt
.
ªsu…
 = 
	`‚
();

755 i‡(
öôˇŒ_debug
) {

756 
	`dißbÀ_boŸ_åa˚
();

757 
ªâime
 = 
	`ktime_gë
();

758 
dñè
 = 
	`ktime_sub
(
ªâime
, 
ˇŒtime
);

759 
ªt
.
duøti⁄
 = (Ë
	`ktime_to_ns
(
dñè
) >> 10;

760 
	`åa˚_boŸ_ªt
(&
ªt
, 
‚
);

761 
	`¥ötk
("öôˇŒ %pFÑëu∫ed %dá·î %Ld u£cs\n", 
‚
,

762 
ªt
.
ªsu…
,Ñë.
duøti⁄
);

765 
msgbuf
[0] = 0;

767 i‡(
ªt
.
ªsu…
 &&Ñë.ªsu… !-
ENODEV
 && 
öôˇŒ_debug
)

768 
	`•rötf
(
msgbuf
, "îr‹ codê%d ", 
ªt
.
ªsu…
);

770 i‡(
	`¥ìm±_cou¡
(Ë!
cou¡
) {

771 
	`°æˇt
(
msgbuf
, "preemption imbalance ", (msgbuf));

772 
	`¥ìm±_cou¡
(Ë
cou¡
;

774 i‡(
	`úqs_dißbÀd
()) {

775 
	`°æˇt
(
msgbuf
, "disabled interrupts ", (msgbuf));

776 
	`loˇl_úq_íabÀ
();

778 i‡(
msgbuf
[0]) {

779 
	`¥ötk
("öôˇŒ %pFÑëu∫ed wôh %s\n", 
‚
, 
msgbuf
);

782  
ªt
.
ªsu…
;

783 
	}
}

786 
öôˇŒ_t
 
__öôˇŒ_°¨t
[], 
__öôˇŒ_íd
[], 
__óæy_öôˇŒ_íd
[];

788 
__öô
 
	$do_öôˇŒs
()

790 
öôˇŒ_t
 *
ˇŒ
;

792 
ˇŒ
 = 
__óæy_öôˇŒ_íd
; cÆ»< 
__öôˇŒ_íd
; call++)

793 
	`do_⁄e_öôˇŒ
(*
ˇŒ
);

796 
	`Êush_scheduÀd_w‹k
();

797 
	}
}

806 
__öô
 
	$do_basic_£tup
()

808 
	`rcu_öô_sched
();

809 
	`öô_w‹kqueues
();

810 
	`˝u£t_öô_smp
();

811 
	`u£rmodehñ≥r_öô
();

812 
	`drivî_öô
();

813 
	`öô_úq_¥oc
();

814 
	`do_˘‹s
();

815 
	`do_öôˇŒs
();

816 
	}
}

818 
__öô
 
	$do_¥e_smp_öôˇŒs
()

820 
öôˇŒ_t
 *
ˇŒ
;

822 
ˇŒ
 = 
__öôˇŒ_°¨t
; cÆ»< 
__óæy_öôˇŒ_íd
; call++)

823 
	`do_⁄e_öôˇŒ
(*
ˇŒ
);

824 
	}
}

826 
	$run_öô_¥o˚ss
(*
öô_fûíame
)

828 
¨gv_öô
[0] = 
öô_fûíame
;

829 
	`kî√l_execve
(
öô_fûíame
, 
¨gv_öô
, 
ívp_öô
);

830 
	}
}

835 
noölöe
 
	$öô_po°
()

836 
	$__ªÀa£s
(
kî√l_lock
)

839 
	`async_synchr⁄ize_fuŒ
();

840 
	`‰ì_öômem
();

841 
	`u∆ock_kî√l
();

842 
	`m¨k_rod©a_ro
();

843 
sy°em_°©e
 = 
SYSTEM_RUNNING
;

844 
	`numa_deÁu…_pﬁicy
();

846 i‡(
	`sys_›í
((c⁄° 
__u£r
 *Ë"/dev/c⁄sﬁe", 
O_RDWR
, 0) < 0)

847 
	`¥ötk
(
KERN_WARNING
 "Warning: unableÅo openán initial console.\n");

849 (Ë
	`sys_dup
(0);

850 (Ë
	`sys_dup
(0);

852 
cuºít
->
sig«l
->
Êags
 |
SIGNAL_UNKILLABLE
;

854 i‡(
ømdisk_execuã_comm™d
) {

855 
	`run_öô_¥o˚ss
(
ømdisk_execuã_comm™d
);

856 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s\n",

857 
ømdisk_execuã_comm™d
);

866 i‡(
execuã_comm™d
) {

867 
	`run_öô_¥o˚ss
(
execuã_comm™d
);

868 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s. Attempting "

869 "deÁu…s...\n", 
execuã_comm™d
);

871 
	`run_öô_¥o˚ss
("/sbin/init");

872 
	`run_öô_¥o˚ss
("/etc/init");

873 
	`run_öô_¥o˚ss
("/bin/init");

874 
	`run_öô_¥o˚ss
("/bin/sh");

876 
	`∑nic
("No init found. TryÖassing init= optionÅo kernel.");

877 
	}
}

879 
__öô
 
	$kî√l_öô
(* 
unu£d
)

881 
	`lock_kî√l
();

886 
	`£t_mems_Ælowed
(
node_possibÀ_m≠
);

890 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
˝u_Æl_mask
);

899 
öô_pid_ns
.
chûd_ª≠î
 = 
cuºít
;

901 
ˇd_pid
 = 
	`èsk_pid
(
cuºít
);

903 
	`smp_¥ï¨e_˝us
(
£tup_max_˝us
);

905 
	`do_¥e_smp_öôˇŒs
();

906 
	`°¨t_boŸ_åa˚
();

908 
	`smp_öô
();

909 
	`sched_öô_smp
();

911 
	`do_basic_£tup
();

918 i‡(!
ømdisk_execuã_comm™d
)

919 
ømdisk_execuã_comm™d
 = "/init";

921 i‡(
	`sys_ac˚ss
((c⁄° 
__u£r
 *Ë
ømdisk_execuã_comm™d
, 0) != 0) {

922 
ømdisk_execuã_comm™d
 = 
NULL
;

923 
	`¥ï¨e_«me•a˚
();

932 
	`öô_po°
();

934 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<löux/compûe.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/uts.h
>

12 
	~<löux/ut¢ame.h
>

13 
	~<löux/ut§ñó£.h
>

14 
	~<löux/vîsi⁄.h
>

16 #i‚de‡
CONFIG_KALLSYMS


17 
	#vîsi⁄
(
a
Ë
Vîsi⁄_
 ## 
	)
a

18 
	#vîsi⁄_°rög
(
a
Ë
	`vîsi⁄
◊)

	)

20 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

21 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

24 
uts_«me•a˚
 
	göô_uts_ns
 = {

25 .
kªf
 = {

26 .
ªfcou¡
 = 
ATOMIC_INIT
(2),

28 .
	g«me
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnodíame
 = 
UTS_NODENAME
,

31 .
	gªÀa£
 = 
UTS_RELEASE
,

32 .
	gvîsi⁄
 = 
UTS_VERSION
,

33 .
	gmachöe
 = 
UTS_MACHINE
,

34 .
	gdomaö«me
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
öô_uts_ns
);

40 c⁄° 
	glöux_b™√r
[] =

41 "Löux vîsi⁄ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "Ë(" 
LINUX_COMPILER
 "Ë" 
UTS_VERSION
 "\n";

44 c⁄° 
	glöux_¥oc_b™√r
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
152
6477
/cmpt816/linux/arch/x86/ia32/audit.c
/cmpt816/linux/arch/x86/ia32/ia32_signal.c
/cmpt816/linux/arch/x86/ia32/ipc32.c
/cmpt816/linux/arch/x86/ia32/sys_ia32.c
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/processor.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c
/cmpt816/linux/arch/x86/kernel/cpu/perf_counter.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time_64.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
