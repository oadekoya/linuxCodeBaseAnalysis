cscope 15 /cmpt816/data -q 0000010947 0001398914
	@/cmpt816/linux/arch/x86/ia32/audit.c

1 
	~<asm/uni°d_32.h
>

3 
	gü32_dú_˛ass
[] = {

4 
	~<asm-gíîic/audô_dú_wrôe.h
>

8 
	gü32_ch©å_˛ass
[] = {

9 
	~<asm-gíîic/audô_ch™ge_©å.h
>

13 
	gü32_wrôe_˛ass
[] = {

14 
	~<asm-gíîic/audô_wrôe.h
>

18 
	gü32_ªad_˛ass
[] = {

19 
	~<asm-gíîic/audô_ªad.h
>

23 
	gü32_sig«l_˛ass
[] = {

24 
	~<asm-gíîic/audô_sig«l.h
>

28 
	$ü32_˛assify_sysˇŒ
(
sysˇŒ
)

30 
sysˇŒ
) {

31 
__NR_›í
:

33 
__NR_›í©
:

35 
__NR_sockëˇŒ
:

37 
__NR_execve
:

42 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ia32_signal.c

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/uni°d.h
>

20 
	~<löux/°ddef.h
>

21 
	~<löux/≥rs⁄Æôy.h
>

22 
	~<löux/com∑t.h
>

23 
	~<löux/böfmts.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/±ø˚.h
>

28 
	~<asm/ü32_uni°d.h
>

29 
	~<asm/u£r32.h
>

30 
	~<asm/sigc⁄ãxt32.h
>

31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/vdso.h
>

33 
	~<asm/sig‰ame.h
>

34 
	~<asm/sys_ü32.h
>

36 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

38 
	#FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

39 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

40 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

41 
X86_EFLAGS_CF
)

	)

43 
sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
);

45 
	$c›y_sigöfo_to_u£r32
(
com∑t_sigöfo_t
 
__u£r
 *
to
, 
sigöfo_t
 *
‰om
)

47 
îr
 = 0;

49 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
to
, (
com∑t_sigöfo_t
)))

50  -
EFAULT
;

52 
put_u£r_åy
 {

58 
	`put_u£r_ex
(
‰om
->
si_signo
, &
to
->si_signo);

59 
	`put_u£r_ex
(
‰om
->
si_î∫o
, &
to
->si_errno);

60 
	`put_u£r_ex
(()
‰om
->
si_code
, &
to
->si_code);

62 i‡(
‰om
->
si_code
 < 0) {

63 
	`put_u£r_ex
(
‰om
->
si_pid
, &
to
->si_pid);

64 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

65 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
), &
to
->si_ptr);

71 
	`put_u£r_ex
(
‰om
->
_sifõlds
.
_∑d
[0],

72 &
to
->
_sifõlds
.
_∑d
[0]);

73 
‰om
->
si_code
 >> 16) {

74 
__SI_FAULT
 >> 16:

76 
__SI_CHLD
 >> 16:

77 
	`put_u£r_ex
(
‰om
->
si_utime
, &
to
->si_utime);

78 
	`put_u£r_ex
(
‰om
->
si_°ime
, &
to
->si_stime);

79 
	`put_u£r_ex
(
‰om
->
si_°©us
, &
to
->si_status);

82 
__SI_KILL
 >> 16:

83 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

85 
__SI_POLL
 >> 16:

86 
	`put_u£r_ex
(
‰om
->
si_fd
, &
to
->si_fd);

88 
__SI_TIMER
 >> 16:

89 
	`put_u£r_ex
(
‰om
->
si_ovîrun
, &
to
->si_overrun);

90 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
),

91 &
to
->
si_±r
);

94 
__SI_RT
 >> 16:

95 
__SI_MESGQ
 >> 16:

96 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

97 
	`put_u£r_ex
(
‰om
->
si_öt
, &
to
->si_int);

101 } 
	`put_u£r_ˇtch
(
îr
);

103  
îr
;

104 
	}
}

106 
	$c›y_sigöfo_‰om_u£r32
(
sigöfo_t
 *
to
, 
com∑t_sigöfo_t
 
__u£r
 *
‰om
)

108 
îr
 = 0;

109 
u32
 
±r32
;

111 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰om
, (
com∑t_sigöfo_t
)))

112  -
EFAULT
;

114 
gë_u£r_åy
 {

115 
	`gë_u£r_ex
(
to
->
si_signo
, &
‰om
->si_signo);

116 
	`gë_u£r_ex
(
to
->
si_î∫o
, &
‰om
->si_errno);

117 
	`gë_u£r_ex
(
to
->
si_code
, &
‰om
->si_code);

119 
	`gë_u£r_ex
(
to
->
si_pid
, &
‰om
->si_pid);

120 
	`gë_u£r_ex
(
to
->
si_uid
, &
‰om
->si_uid);

121 
	`gë_u£r_ex
(
±r32
, &
‰om
->
si_±r
);

122 
to
->
si_±r
 = 
	`com∑t_±r
(
±r32
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

128 
asmlökage
 
	$sys32_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

130 
mask
 &
_BLOCKABLE
;

131 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

132 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

133 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

134 
	`ªˇlc_sig≥ndög
();

135 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

137 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

138 
	`scheduÀ
();

139 
	`£t_ª°‹e_sigmask
();

140  -
ERESTARTNOHAND
;

141 
	}
}

143 
asmlökage
 
	$sys32_sigÆt°ack
(c⁄° 
°ack_ü32_t
 
__u£r
 *
uss_±r
,

144 
°ack_ü32_t
 
__u£r
 *
uoss_±r
,

145 
±_ªgs
 *
ªgs
)

147 
°ack_t
 
uss
, 
uoss
;

148 
ªt
, 
îr
 = 0;

149 
mm_£gmít_t
 
£g
;

151 i‡(
uss_±r
) {

152 
u32
 
±r
;

154 
	`mem£t
(&
uss
, 0, (
°ack_t
));

155 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
uss_±r
, (
°ack_ü32_t
)))

156  -
EFAULT
;

158 
gë_u£r_åy
 {

159 
	`gë_u£r_ex
(
±r
, &
uss_±r
->
ss_•
);

160 
	`gë_u£r_ex
(
uss
.
ss_Êags
, &
uss_±r
->ss_flags);

161 
	`gë_u£r_ex
(
uss
.
ss_size
, &
uss_±r
->ss_size);

162 } 
	`gë_u£r_ˇtch
(
îr
);

164 i‡(
îr
)

165  -
EFAULT
;

166 
uss
.
ss_•
 = 
	`com∑t_±r
(
±r
);

168 
£g
 = 
	`gë_fs
();

169 
	`£t_fs
(
KERNEL_DS
);

170 
ªt
 = 
	`do_sigÆt°ack
(
uss_±r
 ? &
uss
 : 
NULL
, &
uoss
, 
ªgs
->
•
);

171 
	`£t_fs
(
£g
);

172 i‡(
ªt
 >0 && 
uoss_±r
) {

173 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss_±r
, (
°ack_ü32_t
)))

174  -
EFAULT
;

176 
put_u£r_åy
 {

177 
	`put_u£r_ex
(
	`±r_to_com∑t
(
uoss
.
ss_•
), &
uoss_±r
->ss_sp);

178 
	`put_u£r_ex
(
uoss
.
ss_Êags
, &
uoss_±r
->ss_flags);

179 
	`put_u£r_ex
(
uoss
.
ss_size
, &
uoss_±r
->ss_size);

180 } 
	`put_u£r_ˇtch
(
îr
);

182 i‡(
îr
)

183 
ªt
 = -
EFAULT
;

185  
ªt
;

186 
	}
}

191 
	#lﬂd£gmít_gs
(
v
Ë
	`lﬂd_gs_ödex
(v)

	)

192 
	#lﬂd£gmít_fs
(
v
Ë
	`lﬂd£gmít
(
fs
, v)

	)

193 
	#lﬂd£gmít_ds
(
v
Ë
	`lﬂd£gmít
(
ds
, v)

	)

194 
	#lﬂd£gmít_es
(
v
Ë
	`lﬂd£gmít
(
es
, v)

	)

196 
	#gë_u£r_£g
(
£g
Ë({ 
v
; 
	`ßve£gmít
(£g, v); v; })

	)

197 
	#£t_u£r_£g
(
£g
, 
v
Ë
lﬂd£gmít_
##
	`£g
(v)

	)

199 
	#COPY
(
x
) { \

200 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

201 }

	)

203 
	#GET_SEG
(
£g
) ({ \

204 
tmp
; \

205 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

206 
tmp
; \

207 })

	)

209 
	#COPY_SEG_CPL3
(
£g
) do { \

210 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

211 } 0)

	)

213 
	#RELOAD_SEG
(
£g
) { \

214 
¥e
 = 
	`GET_SEG
(
£g
); \

215 
cur
 = 
	`gë_u£r_£g
(
£g
); \

216 
¥e
 |= 3; \

217 i‡(
¥e
 !
cur
) \

218 
	`£t_u£r_£g
(
£g
, 
¥e
); \

219 }

	)

221 
	$ü32_ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
,

222 
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

223 *
∑x
)

225 
tmpÊags
, 
îr
 = 0;

226 
__u£r
 *
buf
;

227 
u32
 
tmp
;

230 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

232 
gë_u£r_åy
 {

239 
	`RELOAD_SEG
(
gs
);

240 
	`RELOAD_SEG
(
fs
);

241 
	`RELOAD_SEG
(
ds
);

242 
	`RELOAD_SEG
(
es
);

244 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

245 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

248 
	`COPY_SEG_CPL3
(
cs
);

249 
	`COPY_SEG_CPL3
(
ss
);

251 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

252 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

254 
ªgs
->
‹ig_ax
 = -1;

256 
	`gë_u£r_ex
(
tmp
, &
sc
->
Â°©e
);

257 
buf
 = 
	`com∑t_±r
(
tmp
);

258 
îr
 |
	`ª°‹e_i387_x°©e_ü32
(
buf
);

260 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

261 } 
	`gë_u£r_ˇtch
(
îr
);

263  
îr
;

264 
	}
}

266 
asmlökage
 
	$sys32_sigªtu∫
(
±_ªgs
 *
ªgs
)

268 
sig‰ame_ü32
 
__u£r
 *
‰ame
 = (sig‰ame_ü32 __u£∏*)(
ªgs
->
•
-8);

269 
sig£t_t
 
£t
;

270 
ax
;

272 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

273 
bad‰ame
;

274 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
)

275 || (
_COMPAT_NSIG_WORDS
 > 1

276 && 
	`__c›y_‰om_u£r
((((*Ë&
£t
.
sig
) + 4),

277 &
‰ame
->
exåamask
,

278 (
‰ame
->
exåamask
))))

279 
bad‰ame
;

281 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

282 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

283 
cuºít
->
blocked
 = 
£t
;

284 
	`ªˇlc_sig≥ndög
();

285 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

287 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

288 
bad‰ame
;

289  
ax
;

291 
bad‰ame
:

292 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bit sigreturn");

294 
	}
}

296 
asmlökage
 
	$sys32_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

299 
sig£t_t
 
£t
;

300 
ax
;

301 
±_ªgs
 
åegs
;

303 
‰ame
 = (
π_sig‰ame_ü32
 
__u£r
 *)(
ªgs
->
•
 - 4);

305 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

306 
bad‰ame
;

307 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

308 
bad‰ame
;

310 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

311 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

312 
cuºít
->
blocked
 = 
£t
;

313 
	`ªˇlc_sig≥ndög
();

314 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

316 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

317 
bad‰ame
;

319 
åegs
 = *
ªgs
;

320 i‡(
	`sys32_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, &
åegs
Ë=-
EFAULT
)

321 
bad‰ame
;

323  
ax
;

325 
bad‰ame
:

326 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bitÑt sigreturn");

328 
	}
}

334 
	$ü32_£tup_sigc⁄ãxt
(
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

335 
__u£r
 *
Â°©e
,

336 
±_ªgs
 *
ªgs
, 
mask
)

338 
îr
 = 0;

340 
put_u£r_åy
 {

341 
	`put_u£r_ex
(
	`gë_u£r_£g
(
gs
), (
__u£r
 *)&
sc
->gs);

342 
	`put_u£r_ex
(
	`gë_u£r_£g
(
fs
), (
__u£r
 *)&
sc
->fs);

343 
	`put_u£r_ex
(
	`gë_u£r_£g
(
ds
), (
__u£r
 *)&
sc
->ds);

344 
	`put_u£r_ex
(
	`gë_u£r_£g
(
es
), (
__u£r
 *)&
sc
->es);

346 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

347 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

348 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

349 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

350 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

351 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

352 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

353 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

354 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

355 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

356 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

357 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

358 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

359 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

360 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

362 
	`put_u£r_ex
(
	`±r_to_com∑t
(
Â°©e
), &
sc
->fpstate);

365 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

366 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

367 } 
	`put_u£r_ˇtch
(
îr
);

369  
îr
;

370 
	}
}

375 
__u£r
 *
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
,

376 
size_t
 
‰ame_size
,

377 **
Â°©e
)

379 
•
;

382 
•
 = 
ªgs
->sp;

385 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

386 i‡(
	`ßs_ss_Êags
(
•
) == 0)

387 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

391 i‡((
ªgs
->
ss
 & 0xffffË!
__USER32_DS
 &&

392 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

393 
ka
->
ß
.
ß_ª°‹î
)

394 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

396 i‡(
	`u£d_m©h
()) {

397 
•
 = s∞- 
sig_x°©e_ü32_size
;

398 *
Â°©e
 = (
_Â°©e_ü32
 *Ë
•
;

399 i‡(
	`ßve_i387_x°©e_ü32
(*
Â°©e
) < 0)

400  (
__u£r
 *) -1L;

403 
•
 -
‰ame_size
;

406 
•
 = ((sp + 4) & -16ul) - 4;

407  (
__u£r
 *Ë
•
;

408 
	}
}

410 
	$ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

411 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

413 
sig‰ame_ü32
 
__u£r
 *
‰ame
;

414 
__u£r
 *
ª°‹î
;

415 
îr
 = 0;

416 
__u£r
 *
Â°©e
 = 
NULL
;

420 
u16
 
p›lmovl
;

421 
u32
 
vÆ
;

422 
u16
 
öt80
;

423 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

425 
__NR_ü32_sigªtu∫
,

429 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

431 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

432  -
EFAULT
;

434 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

435  -
EFAULT
;

437 i‡(
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

438  -
EFAULT
;

440 i‡(
_COMPAT_NSIG_WORDS
 > 1) {

441 i‡(
	`__c›y_to_u£r
(
‰ame
->
exåamask
, &
£t
->
sig
[1],

442 (
‰ame
->
exåamask
)))

443  -
EFAULT
;

446 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

447 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

450 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

451 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

452 
sigªtu∫
);

454 
ª°‹î
 = &
‰ame
->
ªtcode
;

457 
put_u£r_åy
 {

458 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

464 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

465 } 
	`put_u£r_ˇtch
(
îr
);

467 i‡(
îr
)

468  -
EFAULT
;

471 
ªgs
->
•
 = (Ë
‰ame
;

472 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

475 
ªgs
->
ax
 = 
sig
;

476 
ªgs
->
dx
 = 0;

477 
ªgs
->
cx
 = 0;

479 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

480 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

482 
ªgs
->
cs
 = 
__USER32_CS
;

483 
ªgs
->
ss
 = 
__USER32_DS
;

486 
	}
}

488 
	$ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

489 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

491 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

492 
__u£r
 *
ª°‹î
;

493 
îr
 = 0;

494 
__u£r
 *
Â°©e
 = 
NULL
;

498 
u8
 
movl
;

499 
u32
 
vÆ
;

500 
u16
 
öt80
;

501 
u8
 
∑d
;

502 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

504 
__NR_ü32_π_sigªtu∫
,

509 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

511 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

512  -
EFAULT
;

514 
put_u£r_åy
 {

515 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

516 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
öfo
), &‰ame->
pöfo
);

517 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
uc
), &‰ame->
puc
);

518 
îr
 |
	`c›y_sigöfo_to_u£r32
(&
‰ame
->
öfo
, info);

521 i‡(
˝u_has_xßve
)

522 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

524 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

525 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

526 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

527 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

528 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

529 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

530 
îr
 |
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

531 
ªgs
, 
£t
->
sig
[0]);

532 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

534 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

535 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

537 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

538 
π_sigªtu∫
);

539 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

545 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

546 } 
	`put_u£r_ˇtch
(
îr
);

548 i‡(
îr
)

549  -
EFAULT
;

552 
ªgs
->
•
 = (Ë
‰ame
;

553 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

556 
ªgs
->
ax
 = 
sig
;

557 
ªgs
->
dx
 = (Ë&
‰ame
->
öfo
;

558 
ªgs
->
cx
 = (Ë&
‰ame
->
uc
;

560 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

561 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

563 
ªgs
->
cs
 = 
__USER32_CS
;

564 
ªgs
->
ss
 = 
__USER32_DS
;

567 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ipc32.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/•ölock.h
>

3 
	~<löux/li°.h
>

4 
	~<löux/sysˇŒs.h
>

5 
	~<löux/time.h
>

6 
	~<löux/£m.h
>

7 
	~<löux/msg.h
>

8 
	~<löux/shm.h
>

9 
	~<löux/ùc.h
>

10 
	~<löux/com∑t.h
>

11 
	~<asm/sys_ü32.h
>

13 
asmlökage
 
	$sys32_ùc
(
u32
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

14 
com∑t_u±r_t
 
±r
, 
u32
 
fi·h
)

16 
vîsi⁄
;

18 
vîsi⁄
 = 
ˇŒ
 >> 16;

19 
ˇŒ
 &= 0xffff;

21 
ˇŒ
) {

22 
SEMOP
:

24  
	`sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
, 
NULL
);

25 
SEMTIMEDOP
:

26  
	`com∑t_sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
,

27 
	`com∑t_±r
(
fi·h
));

28 
SEMGET
:

29  
	`sys_£mgë
(
fú°
, 
£c⁄d
, 
thúd
);

30 
SEMCTL
:

31  
	`com∑t_sys_£m˘l
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

33 
MSGSND
:

34  
	`com∑t_sys_msg¢d
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

35 
MSGRCV
:

36  
	`com∑t_sys_msgrcv
(
fú°
, 
£c⁄d
, 
fi·h
, 
thúd
,

37 
vîsi⁄
, 
	`com∑t_±r
(
±r
));

38 
MSGGET
:

39  
	`sys_msggë
((
key_t
Ë
fú°
, 
£c⁄d
);

40 
MSGCTL
:

41  
	`com∑t_sys_msg˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

43 
SHMAT
:

44  
	`com∑t_sys_shm©
(
fú°
, 
£c⁄d
, 
thúd
, 
vîsi⁄
,

45 
	`com∑t_±r
(
±r
));

46 
SHMDT
:

47  
	`sys_shmdt
(
	`com∑t_±r
(
±r
));

48 
SHMGET
:

49  
	`sys_shmgë
(
fú°
, ()
£c⁄d
, 
thúd
);

50 
SHMCTL
:

51  
	`com∑t_sys_shm˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

53  -
ENOSYS
;

54 
	}
}

	@/cmpt816/linux/arch/x86/ia32/sys_ia32.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/sig«l.h
>

28 
	~<löux/sysˇŒs.h
>

29 
	~<löux/times.h
>

30 
	~<löux/ut¢ame.h
>

31 
	~<löux/smp_lock.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/uio.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/≥rs⁄Æôy.h
>

36 
	~<löux/°©.h
>

37 
	~<löux/rw£m.h
>

38 
	~<löux/com∑t.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/±ø˚.h
>

41 
	~<löux/highuid.h
>

42 
	~<löux/sys˘l.h
>

43 
	~<asm/mm™.h
>

44 
	~<asm/ty≥s.h
>

45 
	~<asm/uac˚ss.h
>

46 
	~<asm/©omic.h
>

47 
	~<asm/vgtod.h
>

48 
	~<asm/sys_ü32.h
>

50 
	#AA
(
__x
Ë(()(__x))

	)

53 
asmlökage
 
	$sys32_åunˇã64
(
__u£r
 *
fûíame
,

54 
off£t_low
,

55 
off£t_high
)

57  
	`sys_åunˇã
(
fûíame
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

58 
	}
}

60 
asmlökage
 
	$sys32_·runˇã64
(
fd
, 
off£t_low
,

61 
off£t_high
)

63  
	`sys_·runˇã
(
fd
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

64 
	}
}

70 
	$˝_°©64
(
°©64
 
__u£r
 *
ubuf
, 
k°©
 *
°©
)

72 
	`ty≥of
(
ubuf
->
°_uid
Ë
uid
 = 0;

73 
	`ty≥of
(
ubuf
->
°_gid
Ë
gid
 = 0;

74 
	`SET_UID
(
uid
, 
°©
->uid);

75 
	`SET_GID
(
gid
, 
°©
->gid);

76 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ubuf
, (
°©64
)) ||

77 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
dev
), &
ubuf
->
°_dev
) ||

78 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
__°_öo
) ||

79 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
°_öo
) ||

80 
	`__put_u£r
(
°©
->
mode
, &
ubuf
->
°_mode
) ||

81 
	`__put_u£r
(
°©
->
∆ök
, &
ubuf
->
°_∆ök
) ||

82 
	`__put_u£r
(
uid
, &
ubuf
->
°_uid
) ||

83 
	`__put_u£r
(
gid
, &
ubuf
->
°_gid
) ||

84 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
rdev
), &
ubuf
->
°_rdev
) ||

85 
	`__put_u£r
(
°©
->
size
, &
ubuf
->
°_size
) ||

86 
	`__put_u£r
(
°©
->
©ime
.
tv_£c
, &
ubuf
->
°_©ime
) ||

87 
	`__put_u£r
(
°©
->
©ime
.
tv_n£c
, &
ubuf
->
°_©ime_n£c
) ||

88 
	`__put_u£r
(
°©
->
mtime
.
tv_£c
, &
ubuf
->
°_mtime
) ||

89 
	`__put_u£r
(
°©
->
mtime
.
tv_n£c
, &
ubuf
->
°_mtime_n£c
) ||

90 
	`__put_u£r
(
°©
->
˘ime
.
tv_£c
, &
ubuf
->
°_˘ime
) ||

91 
	`__put_u£r
(
°©
->
˘ime
.
tv_n£c
, &
ubuf
->
°_˘ime_n£c
) ||

92 
	`__put_u£r
(
°©
->
blksize
, &
ubuf
->
°_blksize
) ||

93 
	`__put_u£r
(
°©
->
blocks
, &
ubuf
->
°_blocks
))

94  -
EFAULT
;

96 
	}
}

98 
asmlökage
 
	$sys32_°©64
(
__u£r
 *
fûíame
,

99 
°©64
 
__u£r
 *
°©buf
)

101 
k°©
 
°©
;

102 
ªt
 = 
	`vfs_°©
(
fûíame
, &
°©
);

104 i‡(!
ªt
)

105 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

106  
ªt
;

107 
	}
}

109 
asmlökage
 
	$sys32_l°©64
(
__u£r
 *
fûíame
,

110 
°©64
 
__u£r
 *
°©buf
)

112 
k°©
 
°©
;

113 
ªt
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

114 i‡(!
ªt
)

115 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

116  
ªt
;

117 
	}
}

119 
asmlökage
 
	$sys32_f°©64
(
fd
, 
°©64
 
__u£r
 *
°©buf
)

121 
k°©
 
°©
;

122 
ªt
 = 
	`vfs_f°©
(
fd
, &
°©
);

123 i‡(!
ªt
)

124 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

125  
ªt
;

126 
	}
}

128 
asmlökage
 
	$sys32_f°©©
(
dfd
, 
__u£r
 *
fûíame
,

129 
°©64
 
__u£r
 *
°©buf
, 
Êag
)

131 
k°©
 
°©
;

132 
îr‹
;

134 
îr‹
 = 
	`vfs_f°©©
(
dfd
, 
fûíame
, &
°©
, 
Êag
);

135 i‡(
îr‹
)

136  
îr‹
;

137  
	`˝_°©64
(
°©buf
, &
°©
);

138 
	}
}

146 
	smm≠_¨g_°ru˘
 {

147 
	maddr
;

148 
	mÀn
;

149 
	m¥Ÿ
;

150 
	mÊags
;

151 
	mfd
;

152 
	moff£t
;

155 
asmlökage
 
	$sys32_mm≠
(
mm≠_¨g_°ru˘
 
__u£r
 *
¨g
)

157 
mm≠_¨g_°ru˘
 
a
;

158 
fûe
 *fûê
NULL
;

159 
ªtvÆ
;

160 
mm_°ru˘
 *
mm
 ;

162 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

163  -
EFAULT
;

165 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

166  -
EINVAL
;

168 i‡(!(
a
.
Êags
 & 
MAP_ANONYMOUS
)) {

169 
fûe
 = 
	`fgë
(
a
.
fd
);

170 i‡(!
fûe
)

171  -
EBADF
;

174 
mm
 = 
cuºít
->mm;

175 
	`down_wrôe
(&
mm
->
mm≠_£m
);

176 
ªtvÆ
 = 
	`do_mm≠_pgoff
(
fûe
, 
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,

177 
a
.
off£t
>>
PAGE_SHIFT
);

178 i‡(
fûe
)

179 
	`Âut
(
fûe
);

181 
	`up_wrôe
(&
mm
->
mm≠_£m
);

183  
ªtvÆ
;

184 
	}
}

186 
asmlökage
 
	$sys32_m¥Ÿe˘
(
°¨t
, 
size_t
 
Àn
,

187 
¥Ÿ
)

189  
	`sys_m¥Ÿe˘
(
°¨t
, 
Àn
, 
¥Ÿ
);

190 
	}
}

192 
asmlökage
 
	$sys32_π_siga˘i⁄
(
sig
, 
siga˘i⁄32
 
__u£r
 *
a˘
,

193 
siga˘i⁄32
 
__u£r
 *
ﬂ˘
,

194 
sig£tsize
)

196 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

197 
ªt
;

198 
com∑t_sig£t_t
 
£t32
;

201 i‡(
sig£tsize
 !(
com∑t_sig£t_t
))

202  -
EINVAL
;

204 i‡(
a˘
) {

205 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

207 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

208 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

209 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

210 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

211 
	`__c›y_‰om_u£r
(&
£t32
, &
a˘
->
ß_mask
,

212 (
com∑t_sig£t_t
)))

213  -
EFAULT
;

214 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

215 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

221 
_NSIG_WORDS
) {

222 4: 
√w_ka
.
ß
.
ß_mask
.
sig
[3] = 
£t32
.sig[6]

223 | ((()
£t32
.
sig
[7]) << 32);

224 3: 
√w_ka
.
ß
.
ß_mask
.
sig
[2] = 
£t32
.sig[4]

225 | ((()
£t32
.
sig
[5]) << 32);

226 2: 
√w_ka
.
ß
.
ß_mask
.
sig
[1] = 
£t32
.sig[2]

227 | ((()
£t32
.
sig
[3]) << 32);

228 1: 
√w_ka
.
ß
.
ß_mask
.
sig
[0] = 
£t32
.sig[0]

229 | ((()
£t32
.
sig
[1]) << 32);

233 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

235 i‡(!
ªt
 && 
ﬂ˘
) {

240 
_NSIG_WORDS
) {

242 
£t32
.
sig
[7] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[3] >> 32);

243 
£t32
.
sig
[6] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[3];

245 
£t32
.
sig
[5] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[2] >> 32);

246 
£t32
.
sig
[4] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[2];

248 
£t32
.
sig
[3] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[1] >> 32);

249 
£t32
.
sig
[2] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[1];

251 
£t32
.
sig
[1] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[0] >> 32);

252 
£t32
.
sig
[0] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[0];

254 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

255 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

256 &
ﬂ˘
->
ß_h™dÀr
) ||

257 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

258 &
ﬂ˘
->
ß_ª°‹î
) ||

259 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

260 
	`__c›y_to_u£r
(&
ﬂ˘
->
ß_mask
, &
£t32
,

261 (
com∑t_sig£t_t
)))

262  -
EFAULT
;

265  
ªt
;

266 
	}
}

268 
asmlökage
 
	$sys32_siga˘i⁄
(
sig
, 
ﬁd_siga˘i⁄32
 
__u£r
 *
a˘
,

269 
ﬁd_siga˘i⁄32
 
__u£r
 *
ﬂ˘
)

271 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

272 
ªt
;

274 i‡(
a˘
) {

275 
com∑t_ﬁd_sig£t_t
 
mask
;

276 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

278 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

279 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

280 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

281 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

282 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
))

283  -
EFAULT
;

285 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

286 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

288 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

291 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

293 i‡(!
ªt
 && 
ﬂ˘
) {

294 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

295 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

296 &
ﬂ˘
->
ß_h™dÀr
) ||

297 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

298 &
ﬂ˘
->
ß_ª°‹î
) ||

299 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

300 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask))

301  -
EFAULT
;

304  
ªt
;

305 
	}
}

307 
asmlökage
 
	$sys32_π_sig¥ocmask
(
how
, 
com∑t_sig£t_t
 
__u£r
 *
£t
,

308 
com∑t_sig£t_t
 
__u£r
 *
o£t
,

309 
sig£tsize
)

311 
sig£t_t
 
s
;

312 
com∑t_sig£t_t
 
s32
;

313 
ªt
;

314 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

316 i‡(
£t
) {

317 i‡(
	`c›y_‰om_u£r
(&
s32
, 
£t
, (
com∑t_sig£t_t
)))

318  -
EFAULT
;

319 
_NSIG_WORDS
) {

320 4: 
s
.
sig
[3] = 
s32
.sig[6] | ((()s32.sig[7]) << 32);

321 3: 
s
.
sig
[2] = 
s32
.sig[4] | ((()s32.sig[5]) << 32);

322 2: 
s
.
sig
[1] = 
s32
.sig[2] | ((()s32.sig[3]) << 32);

323 1: 
s
.
sig
[0] = 
s32
.sig[0] | ((()s32.sig[1]) << 32);

326 
	`£t_fs
(
KERNEL_DS
);

327 
ªt
 = 
	`sys_π_sig¥ocmask
(
how
,

328 
£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

329 
o£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

330 
sig£tsize
);

331 
	`£t_fs
(
ﬁd_fs
);

332 i‡(
ªt
)

333  
ªt
;

334 i‡(
o£t
) {

335 
_NSIG_WORDS
) {

336 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

337 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

338 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

339 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

341 i‡(
	`c›y_to_u£r
(
o£t
, &
s32
, (
com∑t_sig£t_t
)))

342  -
EFAULT
;

345 
	}
}

347 
asmlökage
 
	$sys32_Æ¨m
(
£c⁄ds
)

349  
	`Æ¨m_£tôimî
(
£c⁄ds
);

350 
	}
}

352 
	s£l_¨g_°ru˘
 {

353 
	mn
;

354 
	möp
;

355 
	mouç
;

356 
	mexp
;

357 
	mtvp
;

360 
asmlökage
 
	$sys32_ﬁd_£À˘
(
£l_¨g_°ru˘
 
__u£r
 *
¨g
)

362 
£l_¨g_°ru˘
 
a
;

364 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

365  -
EFAULT
;

366  
	`com∑t_sys_£À˘
(
a
.
n
, 
	`com∑t_±r
◊.
öp
), com∑t_±r◊.
ouç
),

367 
	`com∑t_±r
(
a
.
exp
), com∑t_±r◊.
tvp
));

368 
	}
}

370 
asmlökage
 
	$sys32_waôpid
(
com∑t_pid_t
 
pid
, *
°©_addr
,

371 
›ti⁄s
)

373  
	`com∑t_sys_waô4
(
pid
, 
°©_addr
, 
›ti⁄s
, 
NULL
);

374 
	}
}

378 
asmlökage
 
	$sys32_sysfs
(
›ti⁄
, 
u32
 
¨g1
, u32 
¨g2
)

380  
	`sys_sysfs
(
›ti⁄
, 
¨g1
, 
¨g2
);

381 
	}
}

383 
asmlökage
 
	$sys32_sched_º_gë_öãrvÆ
(
com∑t_pid_t
 
pid
,

384 
com∑t_time•ec
 
__u£r
 *
öãrvÆ
)

386 
time•ec
 
t
;

387 
ªt
;

388 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

390 
	`£t_fs
(
KERNEL_DS
);

391 
ªt
 = 
	`sys_sched_º_gë_öãrvÆ
(
pid
, (
time•ec
 
__u£r
 *)&
t
);

392 
	`£t_fs
(
ﬁd_fs
);

393 i‡(
	`put_com∑t_time•ec
(&
t
, 
öãrvÆ
))

394  -
EFAULT
;

395  
ªt
;

396 
	}
}

398 
asmlökage
 
	$sys32_π_sig≥ndög
(
com∑t_sig£t_t
 
__u£r
 *
£t
,

399 
com∑t_size_t
 
sig£tsize
)

401 
sig£t_t
 
s
;

402 
com∑t_sig£t_t
 
s32
;

403 
ªt
;

404 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

406 
	`£t_fs
(
KERNEL_DS
);

407 
ªt
 = 
	`sys_π_sig≥ndög
((
sig£t_t
 
__u£r
 *)&
s
, 
sig£tsize
);

408 
	`£t_fs
(
ﬁd_fs
);

409 i‡(!
ªt
) {

410 
_NSIG_WORDS
) {

411 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

412 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

413 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

414 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

416 i‡(
	`c›y_to_u£r
(
£t
, &
s32
, (
com∑t_sig£t_t
)))

417  -
EFAULT
;

419  
ªt
;

420 
	}
}

422 
asmlökage
 
	$sys32_π_sigqueueöfo
(
pid
, 
sig
,

423 
com∑t_sigöfo_t
 
__u£r
 *
uöfo
)

425 
sigöfo_t
 
öfo
;

426 
ªt
;

427 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

429 i‡(
	`c›y_sigöfo_‰om_u£r32
(&
öfo
, 
uöfo
))

430  -
EFAULT
;

431 
	`£t_fs
(
KERNEL_DS
);

432 
ªt
 = 
	`sys_π_sigqueueöfo
(
pid
, 
sig
, (
sigöfo_t
 
__u£r
 *)&
öfo
);

433 
	`£t_fs
(
ﬁd_fs
);

434  
ªt
;

435 
	}
}

437 #ifde‡
CONFIG_SYSCTL_SYSCALL


438 
	ssys˘l_ü32
 {

439 
	m«me
;

440 
	m∆í
;

441 
	mﬁdvÆ
;

442 
	mﬁdÀ≈
;

443 
	m√wvÆ
;

444 
	m√wÀn
;

445 
	m__unu£d
[4];

449 
asmlökage
 
	$sys32_sys˘l
(
sys˘l_ü32
 
__u£r
 *
¨gs32
)

451 
sys˘l_ü32
 
a32
;

452 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

453 
__u£r
 *
ﬁdvÆp
, *
√wvÆp
;

454 
size_t
 
ﬁdÀn
;

455 
__u£r
 *
«mï
;

456 
ªt
;

458 i‡(
	`c›y_‰om_u£r
(&
a32
, 
¨gs32
, (a32)))

459  -
EFAULT
;

469 
«mï
 = 
	`com∑t_±r
(
a32
.
«me
);

470 
ﬁdvÆp
 = 
	`com∑t_±r
(
a32
.
ﬁdvÆ
);

471 
√wvÆp
 = 
	`com∑t_±r
(
a32
.
√wvÆ
);

473 i‡((
ﬁdvÆp
 && 
	`gë_u£r
(
ﬁdÀn
, (
__u£r
 *)
	`com∑t_±r
(
a32
.
ﬁdÀ≈
)))

474 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«mï
, 0)

475 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬁdvÆp
, 0)

476 || !
	`ac˚ss_ok
(
VERIFY_WRITE
, 
√wvÆp
, 0))

477  -
EFAULT
;

479 
	`£t_fs
(
KERNEL_DS
);

480 
	`lock_kî√l
();

481 
ªt
 = 
	`do_sys˘l
(
«mï
, 
a32
.
∆í
, 
ﬁdvÆp
, (
size_t
 
__u£r
 *)&
ﬁdÀn
,

482 
√wvÆp
, (
size_t
Ë
a32
.
√wÀn
);

483 
	`u∆ock_kî√l
();

484 
	`£t_fs
(
ﬁd_fs
);

486 i‡(
ﬁdvÆp
 && 
	`put_u£r
(
ﬁdÀn
, (
__u£r
 *)
	`com∑t_±r
(
a32
.
ﬁdÀ≈
)))

487  -
EFAULT
;

489  
ªt
;

490 
	}
}

494 
asmlökage
 
	$sys32_¥ód
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

495 
u32
 
po¶o
, u32 
poshi
)

497  
	`sys_¥ód64
(
fd
, 
ubuf
, 
cou¡
,

498 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

499 
	}
}

501 
asmlökage
 
	$sys32_pwrôe
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

502 
u32
 
po¶o
, u32 
poshi
)

504  
	`sys_pwrôe64
(
fd
, 
ubuf
, 
cou¡
,

505 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

506 
	}
}

509 
asmlökage
 
	$sys32_≥rs⁄Æôy
(
≥rs⁄Æôy
)

511 
ªt
;

513 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
 &&

514 
≥rs⁄Æôy
 =
PER_LINUX
)

515 
≥rs⁄Æôy
 = 
PER_LINUX32
;

516 
ªt
 = 
	`sys_≥rs⁄Æôy
(
≥rs⁄Æôy
);

517 i‡(
ªt
 =
PER_LINUX32
)

518 
ªt
 = 
PER_LINUX
;

519  
ªt
;

520 
	}
}

522 
asmlökage
 
	$sys32_£ndfûe
(
out_fd
, 
ö_fd
,

523 
com∑t_off_t
 
__u£r
 *
off£t
, 
s32
 
cou¡
)

525 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

526 
ªt
;

527 
off_t
 
of
;

529 i‡(
off£t
 && 
	`gë_u£r
(
of
, offset))

530  -
EFAULT
;

532 
	`£t_fs
(
KERNEL_DS
);

533 
ªt
 = 
	`sys_£ndfûe
(
out_fd
, 
ö_fd
, 
off£t
 ? (
off_t
 
__u£r
 *)&
of
 : 
NULL
,

534 
cou¡
);

535 
	`£t_fs
(
ﬁd_fs
);

537 i‡(
off£t
 && 
	`put_u£r
(
of
, offset))

538  -
EFAULT
;

539  
ªt
;

540 
	}
}

542 
asmlökage
 
	$sys32_mm≠2
(
addr
, 
Àn
,

543 
¥Ÿ
, 
Êags
,

544 
fd
, 
pgoff
)

546 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

547 
îr‹
;

548 
fûe
 *fûê
NULL
;

550 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

551 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

552 
fûe
 = 
	`fgë
(
fd
);

553 i‡(!
fûe
)

554  -
EBADF
;

557 
	`down_wrôe
(&
mm
->
mm≠_£m
);

558 
îr‹
 = 
	`do_mm≠_pgoff
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
pgoff
);

559 
	`up_wrôe
(&
mm
->
mm≠_£m
);

561 i‡(
fûe
)

562 
	`Âut
(
fûe
);

563  
îr‹
;

564 
	}
}

566 
asmlökage
 
	$sys32_ﬁdu«me
(
ﬁdﬁd_ut¢ame
 
__u£r
 *
«me
)

568 *
¨ch
 = "x86_64";

569 
îr
;

571 i‡(!
«me
)

572  -
EFAULT
;

573 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«me
, (
ﬁdﬁd_ut¢ame
)))

574  -
EFAULT
;

576 
	`down_ªad
(&
uts_£m
);

578 
îr
 = 
	`__c›y_to_u£r
(&
«me
->
sy¢ame
, &
	`ut¢ame
()->sysname,

579 
__OLD_UTS_LEN
);

580 
îr
 |
	`__put_u£r
(0, 
«me
->
sy¢ame
+
__OLD_UTS_LEN
);

581 
îr
 |
	`__c›y_to_u£r
(&
«me
->
nodíame
, &
	`ut¢ame
()->nodename,

582 
__OLD_UTS_LEN
);

583 
îr
 |
	`__put_u£r
(0, 
«me
->
nodíame
+
__OLD_UTS_LEN
);

584 
îr
 |
	`__c›y_to_u£r
(&
«me
->
ªÀa£
, &
	`ut¢ame
()->release,

585 
__OLD_UTS_LEN
);

586 
îr
 |
	`__put_u£r
(0, 
«me
->
ªÀa£
+
__OLD_UTS_LEN
);

587 
îr
 |
	`__c›y_to_u£r
(&
«me
->
vîsi⁄
, &
	`ut¢ame
()->version,

588 
__OLD_UTS_LEN
);

589 
îr
 |
	`__put_u£r
(0, 
«me
->
vîsi⁄
+
__OLD_UTS_LEN
);

591 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

592 
¨ch
 = "i686";

594 
îr
 |
	`__c›y_to_u£r
(&
«me
->
machöe
, 
¨ch
, 
	`°æí
(arch) + 1);

596 
	`up_ªad
(&
uts_£m
);

598 
îr
 =Éº ? -
EFAULT
 : 0;

600  
îr
;

601 
	}
}

603 
	$sys32_u«me
(
ﬁd_ut¢ame
 
__u£r
 *
«me
)

605 
îr
;

607 i‡(!
«me
)

608  -
EFAULT
;

609 
	`down_ªad
(&
uts_£m
);

610 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

611 
	`up_ªad
(&
uts_£m
);

612 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

613 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

615  
îr
 ? -
EFAULT
 : 0;

616 
	}
}

618 
asmlökage
 
	$sys32_execve
(
__u£r
 *
«me
, 
com∑t_u±r_t
 __u£∏*
¨gv
,

619 
com∑t_u±r_t
 
__u£r
 *
ívp
, 
±_ªgs
 *
ªgs
)

621 
îr‹
;

622 *
fûíame
;

624 
fûíame
 = 
	`gë«me
(
«me
);

625 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

626 i‡(
	`IS_ERR
(
fûíame
))

627  
îr‹
;

628 
îr‹
 = 
	`com∑t_do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

629 
	`puäame
(
fûíame
);

630  
îr‹
;

631 
	}
}

633 
asmlökage
 
	$sys32_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

634 
±_ªgs
 *
ªgs
)

636 
__u£r
 *
∑ª¡_tid
 = (__u£∏*)
ªgs
->
dx
;

637 
__u£r
 *
chûd_tid
 = (__u£∏*)
ªgs
->
di
;

639 i‡(!
√w•
)

640 
√w•
 = 
ªgs
->
•
;

641  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

642 
	}
}

648 
	$sys32_l£ek
(
fd
, 
off£t
, 
whí˚
)

650  
	`sys_l£ek
(
fd
, 
off£t
, 
whí˚
);

651 
	}
}

653 
	$sys32_kûl
(
pid
, 
sig
)

655  
	`sys_kûl
(
pid
, 
sig
);

656 
	}
}

658 
	$sys32_Ádvi£64_64
(
fd
, 
__u32
 
off£t_low
, __u32 
off£t_high
,

659 
__u32
 
Àn_low
, __u32 
Àn_high
, 
advi˚
)

661  
	`sys_Ádvi£64_64
(
fd
,

662 (((
u64
)
off£t_high
)<<32Ë| 
off£t_low
,

663 (((
u64
)
Àn_high
)<<32Ë| 
Àn_low
,

664 
advi˚
);

665 
	}
}

667 
	$sys32_vm86_w¨nög
()

669 
èsk_°ru˘
 *
me
 = 
cuºít
;

670 
œ°comm
[(
me
->
comm
)];

672 i‡(
	`°∫cmp
(
œ°comm
, 
me
->
comm
, (lastcomm))) {

673 
	`com∑t_¥ötk
(
KERN_INFO


675 
me
->
comm
);

676 
	`°∫˝y
(
œ°comm
, 
me
->
comm
, (lastcomm));

678  -
ENOSYS
;

679 
	}
}

681 
	$sys32_lookup_dcookõ
(
u32
 
addr_low
, u32 
addr_high
,

682 
__u£r
 *
buf
, 
size_t
 
Àn
)

684  
	`sys_lookup_dcookõ
(((
u64
)
addr_high
 << 32Ë| 
addr_low
, 
buf
, 
Àn
);

685 
	}
}

687 
asmlökage
 
ssize_t
 
	$sys32_ªadahód
(
fd
, 
off_lo
, 
off_hi
,

688 
size_t
 
cou¡
)

690  
	`sys_ªadahód
(
fd
, ((
u64
)
off_hi
 << 32Ë| 
off_lo
, 
cou¡
);

691 
	}
}

693 
asmlökage
 
	$sys32_sync_fûe_ønge
(
fd
, 
off_low
, 
off_hi
,

694 
n_low
, 
n_hi
, 
Êags
)

696  
	`sys_sync_fûe_ønge
(
fd
,

697 ((
u64
)
off_hi
 << 32Ë| 
off_low
,

698 ((
u64
)
n_hi
 << 32Ë| 
n_low
, 
Êags
);

699 
	}
}

701 
asmlökage
 
	$sys32_Ádvi£64
(
fd
, 
off£t_lo
, 
off£t_hi
,

702 
size_t
 
Àn
, 
advi˚
)

704  
	`sys_Ádvi£64_64
(
fd
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

705 
Àn
, 
advi˚
);

706 
	}
}

708 
asmlökage
 
	$sys32_ÁŒoˇã
(
fd
, 
mode
, 
off£t_lo
,

709 
off£t_hi
, 
Àn_lo
,

710 
Àn_hi
)

712  
	`sys_ÁŒoˇã
(
fd
, 
mode
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

713 ((
u64
)
Àn_hi
 << 32Ë| 
Àn_lo
);

714 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<löux/öô.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/a˝i_pmtmr.h
>

29 
	~<löux/efi.h
>

30 
	~<löux/˝umask.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/dmi.h
>

33 
	~<löux/úq.h
>

34 
	~<löux/boŸmem.h
>

35 
	~<löux/i›‹t.h
>

36 
	~<löux/pci.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/io_≠ic.h
>

40 
	~<asm/≠ic.h
>

41 
	~<asm/io.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/smp.h
>

45 
__öôd©a
 
	ga˝i_f‹˚
 = 0;

46 
u32
 
	ga˝i_rsdt_f‹˚d
;

47 
	ga˝i_dißbÀd
;

48 
EXPORT_SYMBOL
(
a˝i_dißbÀd
);

50 #ifdef 
CONFIG_X86_64


51 
	~<asm/¥Ÿo.h
>

54 
	#BAD_MADT_ENTRY
(
íåy
, 
íd
) ( \

55 (!
íåy
Ë|| (Î¡ry + (*íåyË> 
íd
 || \

56 ((
a˝i_subèbÀ_hódî
 *)
íåy
)->
Àngth
 < (*íåy))

	)

58 
	#PREFIX
 "ACPI: "

	)

60 
	ga˝i_noúq
;

61 
	ga˝i_pci_dißbÀd
;

62 
EXPORT_SYMBOL
(
a˝i_pci_dißbÀd
);

63 
a˝i_ht
 
	g__öôd©a
 = 1;

65 
	ga˝i_œpic
;

66 
	ga˝i_iﬂpic
;

67 
	ga˝i_°ri˘
;

69 
u8
 
a˝i_sci_Êags
 
	g__öôd©a
;

70 
a˝i_sci_ovîride_gsi
 
	g__öôd©a
;

71 
a˝i_skù_timî_ovîride
 
	g__öôd©a
;

72 
a˝i_u£_timî_ovîride
 
	g__öôd©a
;

74 #ifde‡
CONFIG_X86_LOCAL_APIC


75 
u64
 
a˝i_œpic_addr
 
	g__öôd©a
 = 
APIC_DEFAULT_PHYS_BASE
;

78 #i‚de‡
__HAVE_ARCH_CMPXCHG


79 #w¨nög 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
™d
 
œãr
 
h¨dw¨e


90 
a˝i_úq_modñ_id
 
	ga˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_PIC
;

105 *
__öô
 
	$__a˝i_m≠_èbÀ
(
phys
, 
size
)

108 i‡(!
phys
 || !
size
)

109  
NULL
;

111  
	`óæy_i‹em≠
(
phys
, 
size
);

112 
	}
}

113 
__öô
 
	$__a˝i_unm≠_èbÀ
(*
m≠
, 
size
)

115 i‡(!
m≠
 || !
size
)

118 
	`óæy_iounm≠
(
m≠
, 
size
);

119 
	}
}

121 #ifde‡
CONFIG_X86_LOCAL_APIC


122 
__öô
 
	$a˝i_∑r£_madt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

124 
a˝i_èbÀ_madt
 *
madt
 = 
NULL
;

126 i‡(!
˝u_has_≠ic
)

127  -
EINVAL
;

129 
madt
 = (
a˝i_èbÀ_madt
 *)
èbÀ
;

130 i‡(!
madt
) {

131 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map MADT\n");

132  -
ENODEV
;

135 i‡(
madt
->
addªss
) {

136 
a˝i_œpic_addr
 = (
u64
Ë
madt
->
addªss
;

138 
	`¥ötk
(
KERN_DEBUG
 
PREFIX
 "Local APICáddress 0x%08x\n",

139 
madt
->
addªss
);

142 
	`deÁu…_a˝i_madt_€m_check
(
madt
->
hódî
.
€m_id
,

143 
madt
->
hódî
.
€m_èbÀ_id
);

146 
	}
}

148 
__˝uöô
 
	$a˝i_ªgi°î_œpic
(
id
, 
u8
 
íabÀd
)

150 
vî
 = 0;

152 i‡(!
íabÀd
) {

153 ++
dißbÀd_˝us
;

157 i‡(
boŸ_˝u_physiˇl_≠icid
 != -1U)

158 
vî
 = 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
];

160 
	`gíîic_¥o˚ss‹_öfo
(
id
, 
vî
);

161 
	}
}

163 
__öô


164 
	$a˝i_∑r£_x2≠ic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

166 
a˝i_madt_loˇl_x2≠ic
 *
¥o˚ss‹
 = 
NULL
;

168 
¥o˚ss‹
 = (
a˝i_madt_loˇl_x2≠ic
 *)
hódî
;

170 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

171  -
EINVAL
;

173 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

175 #ifde‡
CONFIG_X86_X2APIC


183 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
loˇl_≠ic_id
,

184 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

186 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "x2apicÉntry ignored\n");

190 
	}
}

192 
__öô


193 
	$a˝i_∑r£_œpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

195 
a˝i_madt_loˇl_≠ic
 *
¥o˚ss‹
 = 
NULL
;

197 
¥o˚ss‹
 = (
a˝i_madt_loˇl_≠ic
 *)
hódî
;

199 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

200  -
EINVAL
;

202 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

211 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
id
,

212 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

215 
	}
}

217 
__öô


218 
	$a˝i_∑r£_ßpic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

220 
a˝i_madt_loˇl_ßpic
 *
¥o˚ss‹
 = 
NULL
;

222 
¥o˚ss‹
 = (
a˝i_madt_loˇl_ßpic
 *)
hódî
;

224 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

225  -
EINVAL
;

227 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

229 
	`a˝i_ªgi°î_œpic
((
¥o˚ss‹
->
id
 << 8Ë|Öro˚ss‹->
eid
,

230 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

233 
	}
}

235 
__öô


236 
	$a˝i_∑r£_œpic_addr_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

237 c⁄° 
íd
)

239 
a˝i_madt_loˇl_≠ic_ovîride
 *
œpic_addr_ovr
 = 
NULL
;

241 
œpic_addr_ovr
 = (
a˝i_madt_loˇl_≠ic_ovîride
 *)
hódî
;

243 i‡(
	`BAD_MADT_ENTRY
(
œpic_addr_ovr
, 
íd
))

244  -
EINVAL
;

246 
a˝i_œpic_addr
 = 
œpic_addr_ovr
->
addªss
;

249 
	}
}

251 
__öô


252 
	$a˝i_∑r£_x2≠ic_nmi
(
a˝i_subèbÀ_hódî
 *
hódî
,

253 c⁄° 
íd
)

255 
a˝i_madt_loˇl_x2≠ic_nmi
 *
x2≠ic_nmi
 = 
NULL
;

257 
x2≠ic_nmi
 = (
a˝i_madt_loˇl_x2≠ic_nmi
 *)
hódî
;

259 i‡(
	`BAD_MADT_ENTRY
(
x2≠ic_nmi
, 
íd
))

260  -
EINVAL
;

262 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

264 i‡(
x2≠ic_nmi
->
löt
 != 1)

265 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

268 
	}
}

270 
__öô


271 
	$a˝i_∑r£_œpic_nmi
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

273 
a˝i_madt_loˇl_≠ic_nmi
 *
œpic_nmi
 = 
NULL
;

275 
œpic_nmi
 = (
a˝i_madt_loˇl_≠ic_nmi
 *)
hódî
;

277 i‡(
	`BAD_MADT_ENTRY
(
œpic_nmi
, 
íd
))

278  -
EINVAL
;

280 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

282 i‡(
œpic_nmi
->
löt
 != 1)

283 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

286 
	}
}

290 #ifde‡
CONFIG_X86_IO_APIC


292 
__öô


293 
	$a˝i_∑r£_iﬂpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

295 
a˝i_madt_io_≠ic
 *
iﬂpic
 = 
NULL
;

297 
iﬂpic
 = (
a˝i_madt_io_≠ic
 *)
hódî
;

299 i‡(
	`BAD_MADT_ENTRY
(
iﬂpic
, 
íd
))

300  -
EINVAL
;

302 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

304 
	`mp_ªgi°î_iﬂpic
(
iﬂpic
->
id
,

305 
iﬂpic
->
addªss
, iﬂpic->
globÆ_úq_ba£
);

308 
	}
}

313 
__öô
 
	$a˝i_sci_iﬂpic_£tup
(
u32
 
gsi
, 
u16
 
pﬁ¨ôy
, u16 
åiggî
)

315 i‡(
åiggî
 == 0)

316 
åiggî
 = 3;

318 i‡(
pﬁ¨ôy
 == 0)

319 
pﬁ¨ôy
 = 3;

322 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
)

323 
åiggî
 = (
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

325 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
)

326 
pﬁ¨ôy
 = 
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
;

333 
	`mp_ovîride_Àgacy_úq
(
gsi
, 
pﬁ¨ôy
, 
åiggî
, gsi);

339 
a˝i_sci_ovîride_gsi
 = 
gsi
;

341 
	}
}

343 
__öô


344 
	$a˝i_∑r£_öt_§c_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

345 c⁄° 
íd
)

347 
a˝i_madt_öãºu±_ovîride
 *
öt§c
 = 
NULL
;

349 
öt§c
 = (
a˝i_madt_öãºu±_ovîride
 *)
hódî
;

351 i‡(
	`BAD_MADT_ENTRY
(
öt§c
, 
íd
))

352  -
EINVAL
;

354 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

356 i‡(
öt§c
->
sour˚_úq
 =
a˝i_gbl_FADT
.
sci_öãºu±
) {

357 
	`a˝i_sci_iﬂpic_£tup
(
öt§c
->
globÆ_úq
,

358 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

359 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

363 i‡(
a˝i_skù_timî_ovîride
 &&

364 
öt§c
->
sour˚_úq
 =0 && i¡§c->
globÆ_úq
 == 2) {

365 
	`¥ötk
(
PREFIX
 "BIOS IRQ0Öin2 override ignored.\n");

369 
	`mp_ovîride_Àgacy_úq
(
öt§c
->
sour˚_úq
,

370 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

371 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

372 
öt§c
->
globÆ_úq
);

375 
	}
}

377 
__öô


378 
	$a˝i_∑r£_nmi_§c
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

380 
a˝i_madt_nmi_sour˚
 *
nmi_§c
 = 
NULL
;

382 
nmi_§c
 = (
a˝i_madt_nmi_sour˚
 *)
hódî
;

384 i‡(
	`BAD_MADT_ENTRY
(
nmi_§c
, 
íd
))

385  -
EINVAL
;

387 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

392 
	}
}

410 
__öô
 
	$a˝i_pic_sci_£t_åiggî
(
úq
, 
u16
 
åiggî
)

412 
mask
 = 1 << 
úq
;

413 
ﬁd
, 
√w
;

416 
ﬁd
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

423 
√w
 = 
a˝i_noúq
 ? 
ﬁd
 : 0;

429 
åiggî
) {

431 
√w
 &~
mask
;

434 
√w
 |
mask
;

438 i‡(
ﬁd
 =
√w
)

441 
	`¥ötk
(
PREFIX
 "£âög ELCRÅÿ%04x (‰om %04x)\n", 
√w
, 
ﬁd
);

442 
	`outb
(
√w
, 0x4d0);

443 
	`outb
(
√w
 >> 8, 0x4d1);

444 
	}
}

446 
	$a˝i_gsi_to_úq
(
u32
 
gsi
, *
úq
)

448 *
úq
 = 
gsi
;

450 
	}
}

456 
	$a˝i_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

458 
úq
;

459 
∂©_gsi
 = 
gsi
;

461 #ifde‡
CONFIG_PCI


465 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_PIC
) {

466 i‡(
åiggî
 =
ACPI_LEVEL_SENSITIVE
)

467 
	`eiß_£t_Àvñ_úq
(
gsi
);

471 #ifde‡
CONFIG_X86_IO_APIC


472 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
) {

473 
∂©_gsi
 = 
	`mp_ªgi°î_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

476 
	`a˝i_gsi_to_úq
(
∂©_gsi
, &
úq
);

477  
úq
;

478 
	}
}

483 #ifde‡
CONFIG_ACPI_HOTPLUG_CPU


485 
__˝uöô
 
	$_a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

487 
a˝i_buf„r
 
buf„r
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

488 
a˝i_obje˘
 *
obj
;

489 
a˝i_madt_loˇl_≠ic
 *
œpic
;

490 
˝umask_v¨_t
 
tmp_m≠
, 
√w_m≠
;

491 
u8
 
physid
;

492 
˝u
;

493 
ªtvÆ
 = -
ENOMEM
;

495 i‡(
	`ACPI_FAILURE
(
	`a˝i_evÆu©e_obje˘
(
h™dÀ
, "_MAT", 
NULL
, &
buf„r
)))

496  -
EINVAL
;

498 i‡(!
buf„r
.
Àngth
 || !buf„r.
poöãr
)

499  -
EINVAL
;

501 
obj
 = 
buf„r
.
poöãr
;

502 i‡(
obj
->
ty≥
 !
ACPI_TYPE_BUFFER
 ||

503 
obj
->
buf„r
.
Àngth
 < (*
œpic
)) {

504 
	`k‰ì
(
buf„r
.
poöãr
);

505  -
EINVAL
;

508 
œpic
 = (
a˝i_madt_loˇl_≠ic
 *)
obj
->
buf„r
.
poöãr
;

510 i‡(
œpic
->
hódî
.
ty≥
 !
ACPI_MADT_TYPE_LOCAL_APIC
 ||

511 !(
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
)) {

512 
	`k‰ì
(
buf„r
.
poöãr
);

513  -
EINVAL
;

516 
physid
 = 
œpic
->
id
;

518 
	`k‰ì
(
buf„r
.
poöãr
);

519 
buf„r
.
Àngth
 = 
ACPI_ALLOCATE_BUFFER
;

520 
buf„r
.
poöãr
 = 
NULL
;

522 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_m≠
, 
GFP_KERNEL
))

523 
out
;

525 i‡(!
	`Æloc_˝umask_v¨
(&
√w_m≠
, 
GFP_KERNEL
))

526 
‰ì_tmp_m≠
;

528 
	`˝umask_c›y
(
tmp_m≠
, 
˝u_¥e£¡_mask
);

529 
	`a˝i_ªgi°î_œpic
(
physid
, 
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

535 
	`˝umask_™dnŸ
(
√w_m≠
, 
˝u_¥e£¡_mask
, 
tmp_m≠
);

536 i‡(
	`˝umask_em±y
(
√w_m≠
)) {

537 
	`¥ötk
 ("UnableÅo mapÜapicÅoÜogical cpuÇumber\n");

538 
ªtvÆ
 = -
EINVAL
;

539 
‰ì_√w_m≠
;

542 
˝u
 = 
	`˝umask_fú°
(
√w_m≠
);

544 *
p˝u
 = 
˝u
;

545 
ªtvÆ
 = 0;

547 
‰ì_√w_m≠
:

548 
	`‰ì_˝umask_v¨
(
√w_m≠
);

549 
‰ì_tmp_m≠
:

550 
	`‰ì_˝umask_v¨
(
tmp_m≠
);

551 
out
:

552  
ªtvÆ
;

553 
	}
}

556 
__ªf
 
	$a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

558  
	`_a˝i_m≠_lßpic
(
h™dÀ
, 
p˝u
);

559 
	}
}

560 
EXPORT_SYMBOL
(
a˝i_m≠_lßpic
);

562 
	$a˝i_unm≠_lßpic
(
˝u
)

564 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) = -1;

565 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

566 
num_¥o˚ss‹s
--;

569 
	}
}

571 
EXPORT_SYMBOL
(
a˝i_unm≠_lßpic
);

574 
	$a˝i_ªgi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

577  -
EINVAL
;

578 
	}
}

580 
EXPORT_SYMBOL
(
a˝i_ªgi°î_iﬂpic
);

582 
	$a˝i_uƒegi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u32
 
gsi_ba£
)

585  -
EINVAL
;

586 
	}
}

588 
EXPORT_SYMBOL
(
a˝i_uƒegi°î_iﬂpic
);

590 
__öô
 
	$a˝i_∑r£_sbf
(
a˝i_èbÀ_hódî
 *
èbÀ
)

592 
a˝i_èbÀ_boŸ
 *
sb
;

594 
sb
 = (
a˝i_èbÀ_boŸ
 *)
èbÀ
;

595 i‡(!
sb
) {

596 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map SBF\n");

597  -
ENODEV
;

600 
sbf_p‹t
 = 
sb
->
cmos_ödex
;

603 
	}
}

605 #ifde‡
CONFIG_HPET_TIMER


606 
	~<asm/h≥t.h
>

608 
__öôd©a
 
ªsour˚
 *
	gh≥t_ªs
;

610 
__öô
 
	$a˝i_∑r£_h≥t
(
a˝i_èbÀ_hódî
 *
èbÀ
)

612 
a˝i_èbÀ_h≥t
 *
h≥t_tbl
;

614 
h≥t_tbl
 = (
a˝i_èbÀ_h≥t
 *)
èbÀ
;

615 i‡(!
h≥t_tbl
) {

616 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map HPET\n");

617  -
ENODEV
;

620 i‡(
h≥t_tbl
->
addªss
.
•a˚_id
 !
ACPI_SPACE_MEM
) {

621 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPETÅimers must beÜocated in "

626 
h≥t_addªss
 = 
h≥t_tbl
->
addªss
.address;

632 i‡(!
h≥t_addªss
) {

633 
	`¥ötk
(
KERN_WARNING
 
PREFIX


635 
h≥t_tbl
->
id
, 
h≥t_addªss
);

638 #ifde‡
CONFIG_X86_64


644 i‡(
h≥t_addªss
 == 0xfed0000000000000UL) {

645 i‡(!
h≥t_f‹˚_u£r
) {

646 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

649 "fix iàu∞tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

650 
h≥t_addªss
 = 0;

653 
	`¥ötk
(
KERN_WARNING
 
PREFIX


655 "tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

656 
h≥t_addªss
 >>= 32;

659 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

660 
h≥t_tbl
->
id
, 
h≥t_addªss
);

666 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

667 
h≥t_ªs
 = 
	`Æloc_boŸmem
((*h≥t_ªsË+ 
HPET_RESOURCE_NAME_SIZE
);

669 
h≥t_ªs
->
«me
 = (*)&hpet_res[1];

670 
h≥t_ªs
->
Êags
 = 
IORESOURCE_MEM
;

671 
	`¢¥ötf
((*)
h≥t_ªs
->
«me
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

672 
h≥t_tbl
->
£quí˚
);

674 
h≥t_ªs
->
°¨t
 = 
h≥t_addªss
;

675 
h≥t_ªs
->
íd
 = 
h≥t_addªss
 + (1 * 1024) - 1;

678 
	}
}

684 
__öô
 
	$h≥t_ö£π_ªsour˚
()

686 i‡(!
h≥t_ªs
)

689  
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
h≥t_ªs
);

690 
	}
}

692 
œã_öôˇŒ
(
h≥t_ö£π_ªsour˚
);

695 
	#a˝i_∑r£_h≥t
 
NULL


	)

698 
__öô
 
	$a˝i_∑r£_Ádt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

701 #ifde‡
CONFIG_X86_PM_TIMER


703 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
) {

705 i‡(
a˝i_gbl_FADT
.
xpm_timî_block
.
•a˚_id
 !=

706 
ACPI_ADR_SPACE_SYSTEM_IO
)

709 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
xpm_timî_block
.
addªss
;

715 i‡(!
pmtmr_i›‹t
)

716 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

719 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

721 i‡(
pmtmr_i›‹t
)

722 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

723 
pmtmr_i›‹t
);

726 
	}
}

728 #ifdef 
CONFIG_X86_LOCAL_APIC


734 
__öô
 
	$a˝i_ªgi°î_œpic_addªss
(
addªss
)

736 
mp_œpic_addr
 = 
addªss
;

738 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
addªss
);

739 i‡(
boŸ_˝u_physiˇl_≠icid
 == -1U) {

740 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

741 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
] =

742 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

744 
	}
}

746 
__öô
 
	$óæy_a˝i_∑r£_madt_œpic_addr_ovr
()

748 
cou¡
;

750 i‡(!
˝u_has_≠ic
)

751  -
ENODEV
;

758 
cou¡
 =

759 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

760 
a˝i_∑r£_œpic_addr_ovr
, 0);

761 i‡(
cou¡
 < 0) {

762 
	`¥ötk
(
KERN_ERR
 
PREFIX


764  
cou¡
;

767 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

769  
cou¡
;

770 
	}
}

772 
__öô
 
	$a˝i_∑r£_madt_œpic_íåõs
()

774 
cou¡
;

775 
x2cou¡
 = 0;

777 i‡(!
˝u_has_≠ic
)

778  -
ENODEV
;

785 
cou¡
 =

786 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

787 
a˝i_∑r£_œpic_addr_ovr
, 0);

788 i‡(
cou¡
 < 0) {

789 
	`¥ötk
(
KERN_ERR
 
PREFIX


791  
cou¡
;

794 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

796 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

797 
a˝i_∑r£_ßpic
, 
MAX_APICS
);

799 i‡(!
cou¡
) {

800 
x2cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

801 
a˝i_∑r£_x2≠ic
, 
MAX_APICS
);

802 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

803 
a˝i_∑r£_œpic
, 
MAX_APICS
);

805 i‡(!
cou¡
 && !
x2cou¡
) {

806 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No LAPICÉntriesÖresent\n");

808  -
ENODEV
;

809 } i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

810 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPICÉntry\n");

812  
cou¡
;

815 
x2cou¡
 =

816 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

817 
a˝i_∑r£_x2≠ic_nmi
, 0);

818 
cou¡
 =

819 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
a˝i_∑r£_œpic_nmi
, 0);

820 i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

821 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPIC NMIÉntry\n");

823  
cou¡
;

826 
	}
}

829 #ifdef 
CONFIG_X86_IO_APIC


830 
	#MP_ISA_BUS
 0

	)

832 #ifde‡
CONFIG_X86_ES7000


833 
es7000_∂©
;

836 
__öô
 
	$a˝i_¥obe_gsi
()

838 
idx
;

839 
gsi
;

840 
max_gsi
 = 0;

842 i‡(
a˝i_dißbÀd
)

845 i‡(!
a˝i_iﬂpic
)

848 
max_gsi
 = 0;

849 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++) {

850 
gsi
 = 
mp_gsi_routög
[
idx
].
gsi_íd
;

852 i‡(
gsi
 > 
max_gsi
)

853 
max_gsi
 = 
gsi
;

856  
max_gsi
 + 1;

857 
	}
}

859 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

860 
mpc_öt§c
 *
mp_úq
)

862 
	`mem˝y
(
mp_úq
, 
m
, (
mpc_öt§c
));

863 
	}
}

865 
	$mp_úq_cmp
(
mpc_öt§c
 *
mp_úq
,

866 
mpc_öt§c
 *
m
)

868  
	`memcmp
(
mp_úq
, 
m
, (
mpc_öt§c
));

869 
	}
}

871 
	$ßve_mp_úq
(
mpc_öt§c
 *
m
)

873 
i
;

875 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

876 i‡(!
	`mp_úq_cmp
(&
mp_úqs
[
i
], 
m
))

880 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

881 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

882 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

883 
	}
}

885 
__öô
 
	$mp_ovîride_Àgacy_úq
(
u8
 
bus_úq
, u8 
pﬁ¨ôy
, u8 
åiggî
, 
u32
 
gsi
)

887 
iﬂpic
;

888 
pö
;

889 
mpc_öt§c
 
mp_úq
;

894 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

895 i‡(
iﬂpic
 < 0)

897 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

904 i‡((
bus_úq
 =0Ë&& (
åiggî
 == 3))

905 
åiggî
 = 1;

907 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

908 
mp_úq
.
úqty≥
 = 
mp_INT
;

909 
mp_úq
.
úqÊag
 = (
åiggî
 << 2Ë| 
pﬁ¨ôy
;

910 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

911 
mp_úq
.
§cbusúq
 = 
bus_úq
;

912 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

913 
mp_úq
.
d°úq
 = 
pö
;

915 
	`ßve_mp_úq
(&
mp_úq
);

916 
	}
}

918 
__öô
 
	$mp_c⁄fig_a˝i_Àgacy_úqs
()

920 
i
;

921 
iﬂpic
;

922 
d°≠ic
;

923 
mpc_öt§c
 
mp_úq
;

925 #i‡
	`deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

929 
mp_bus_id_to_ty≥
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

931 
	`£t_bô
(
MP_ISA_BUS
, 
mp_bus_nŸ_pci
);

932 
	`¥_debug
("Bu†#%d i†ISA\n", 
MP_ISA_BUS
);

934 #ifde‡
CONFIG_X86_ES7000


938 i‡(
es7000_∂©
 == 1)

945 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

946 i‡(
iﬂpic
 < 0)

948 
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

954 
i
 = 0; i < 16; i++) {

955 
idx
;

957 
idx
 = 0; idx < 
mp_úq_íåõs
; idx++) {

958 
mpc_öt§c
 *
úq
 = 
mp_úqs
 + 
idx
;

961 i‡(
úq
->
§cbus
 =
MP_ISA_BUS
 && irq->
§cbusúq
 =
i
)

965 i‡(
úq
->
d°≠ic
 =d°≠i¯&& irq->
d°úq
 =
i
)

969 i‡(
idx
 !
mp_úq_íåõs
) {

970 
	`¥ötk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ovîride.\n", 
i
);

974 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

975 
mp_úq
.
úqÊag
 = 0;

976 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

977 
mp_úq
.
d°≠ic
 = dstapic;

978 
mp_úq
.
úqty≥
 = 
mp_INT
;

979 
mp_úq
.
§cbusúq
 = 
i
;

980 
mp_úq
.
d°úq
 = 
i
;

982 
	`ßve_mp_úq
(&
mp_úq
);

984 
	}
}

986 
	$mp_c⁄fig_a˝i_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
,

987 
pﬁ¨ôy
)

989 #ifde‡
CONFIG_X86_MPPARSE


990 
mpc_öt§c
 
mp_úq
;

991 
pci_dev
 *
pdev
;

992 
numbî
;

993 
dev‚
;

994 
iﬂpic
;

995 
u8
 
pö
;

997 i‡(!
a˝i_iﬂpic
)

999 i‡(!
dev
)

1001 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1004 
pdev
 = 
	`to_pci_dev
(
dev
);

1005 
numbî
 = 
pdev
->
bus
->number;

1006 
dev‚
 = 
pdev
->devfn;

1007 
pö
 = 
pdev
->pin;

1009 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1010 
mp_úq
.
úqty≥
 = 
mp_INT
;

1011 
mp_úq
.
úqÊag
 = (
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1012 (
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1013 
mp_úq
.
§cbus
 = 
numbî
;

1014 
mp_úq
.
§cbusúq
 = (((
dev‚
 >> 3Ë& 0x1fË<< 2Ë| ((
pö
 - 1) & 3);

1015 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1016 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1017 
mp_úq
.
d°úq
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1019 
	`ßve_mp_úq
(&
mp_úq
);

1022 
	}
}

1024 
	$mp_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

1026 
iﬂpic
;

1027 
iﬂpic_pö
;

1028 
io_≠ic_úq_©å
 
úq_©å
;

1030 i‡(
a˝i_úq_modñ
 !
ACPI_IRQ_MODEL_IOAPIC
)

1031  
gsi
;

1034 i‡(
a˝i_gbl_FADT
.
sci_öãºu±
 =
gsi
)

1035  
gsi
;

1037 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1038 i‡(
iﬂpic
 < 0) {

1039 
	`¥ötk
(
KERN_WARNING
 "NÿIOAPIC f‹ GSI %u\n", 
gsi
);

1040  
gsi
;

1043 
iﬂpic_pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1045 #ifde‡
CONFIG_X86_32


1046 i‡(
iﬂpic_ªnumbî_úq
)

1047 
gsi
 = 
	`iﬂpic_ªnumbî_úq
(
iﬂpic
, gsi);

1050 i‡(
iﬂpic_pö
 > 
MP_MAX_IOAPIC_PIN
) {

1051 
	`¥ötk
(
KERN_ERR
 "InvalidÑeferenceÅo IOAPICÖin "

1052 "%d-%d\n", 
mp_iﬂpics
[
iﬂpic
].
≠icid
,

1053 
iﬂpic_pö
);

1054  
gsi
;

1057 i‡(
íabÀ_upd©e_m±abÀ
)

1058 
	`mp_c⁄fig_a˝i_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

1060 
	`£t_io_≠ic_úq_©å
(&
úq_©å
, 
iﬂpic
, 
iﬂpic_pö
,

1061 
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1062 
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1063 
	`io_≠ic_£t_pci_routög
(
dev
, 
gsi
, &
úq_©å
);

1065  
gsi
;

1066 
	}
}

1072 
__öô
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1074 
cou¡
;

1082 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
)

1083  -
ENODEV
;

1085 i‡(!
˝u_has_≠ic
)

1086  -
ENODEV
;

1091 i‡(
skù_iﬂpic_£tup
) {

1092 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPICÖrobe "

1094  -
ENODEV
;

1097 
cou¡
 =

1098 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
a˝i_∑r£_iﬂpic
,

1099 
MAX_IO_APICS
);

1100 i‡(!
cou¡
) {

1101 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No IOAPICÉntriesÖresent\n");

1102  -
ENODEV
;

1103 } i‡(
cou¡
 < 0) {

1104 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing IOAPICÉntry\n");

1105  
cou¡
;

1108 
cou¡
 =

1109 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
a˝i_∑r£_öt_§c_ovr
,

1110 
ƒ_úqs
);

1111 i‡(
cou¡
 < 0) {

1112 
	`¥ötk
(
KERN_ERR
 
PREFIX


1115  
cou¡
;

1122 i‡(!
a˝i_sci_ovîride_gsi
)

1123 
	`a˝i_sci_iﬂpic_£tup
(
a˝i_gbl_FADT
.
sci_öãºu±
, 0, 0);

1126 
	`mp_c⁄fig_a˝i_Àgacy_úqs
();

1128 
cou¡
 =

1129 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
a˝i_∑r£_nmi_§c
,

1130 
ƒ_úqs
);

1131 i‡(
cou¡
 < 0) {

1132 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing NMI SRCÉntry\n");

1134  
cou¡
;

1138 
	}
}

1140 
ölöe
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1143 
	}
}

1146 
__öô
 
	$óæy_a˝i_¥o˚ss_madt
()

1148 #ifde‡
CONFIG_X86_LOCAL_APIC


1149 
îr‹
;

1151 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1156 
îr‹
 = 
	`óæy_a˝i_∑r£_madt_œpic_addr_ovr
();

1157 i‡(!
îr‹
) {

1158 
a˝i_œpic
 = 1;

1159 
smp_found_c⁄fig
 = 1;

1161 i‡(
îr‹
 =-
EINVAL
) {

1165 
	`¥ötk
(
KERN_ERR
 
PREFIX


1167 
	`dißbÀ_a˝i
();

1171 
	}
}

1173 
__öô
 
	$a˝i_¥o˚ss_madt
()

1175 #ifde‡
CONFIG_X86_LOCAL_APIC


1176 
îr‹
;

1178 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1183 
îr‹
 = 
	`a˝i_∑r£_madt_œpic_íåõs
();

1184 i‡(!
îr‹
) {

1185 
a˝i_œpic
 = 1;

1187 #ifde‡
CONFIG_X86_BIGSMP


1188 
	`gíîic_bigsmp_¥obe
();

1193 
îr‹
 = 
	`a˝i_∑r£_madt_iﬂpic_íåõs
();

1194 i‡(!
îr‹
) {

1195 
a˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1196 
a˝i_iﬂpic
 = 1;

1198 
smp_found_c⁄fig
 = 1;

1199 i‡(
≠ic
->
£tup_≠ic_routög
)

1200 
≠ic
->
	`£tup_≠ic_routög
();

1203 i‡(
îr‹
 =-
EINVAL
) {

1207 
	`¥ötk
(
KERN_ERR
 
PREFIX


1209 
	`dißbÀ_a˝i
();

1217 i‡(
smp_found_c⁄fig
) {

1218 
	`¥ötk
(
KERN_WARNING
 
PREFIX


1220 
smp_found_c⁄fig
 = 0;

1228 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

1229 
	`¥ötk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1231 i‡(
a˝i_œpic
)

1232 
	`¥ötk
(
KERN_INFO
 "Using ACPI forÖrocessor (LAPIC) "

1236 
	}
}

1238 
__öô
 
	$dißbÀ_a˝i_úq
(c⁄° 
dmi_sy°em_id
 *
d
)

1240 i‡(!
a˝i_f‹˚
) {

1241 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=noirq\n",

1242 
d
->
idít
);

1243 
	`a˝i_noúq_£t
();

1246 
	}
}

1248 
__öô
 
	$dißbÀ_a˝i_pci
(c⁄° 
dmi_sy°em_id
 *
d
)

1250 i‡(!
a˝i_f‹˚
) {

1251 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofÖci=noacpi\n",

1252 
d
->
idít
);

1253 
	`a˝i_dißbÀ_pci
();

1256 
	}
}

1258 
__öô
 
	$dmi_dißbÀ_a˝i
(c⁄° 
dmi_sy°em_id
 *
d
)

1260 i‡(!
a˝i_f‹˚
) {

1261 
	`¥ötk
(
KERN_NOTICE
 "%†dëe˘ed:á˝òoff\n", 
d
->
idít
);

1262 
	`dißbÀ_a˝i
();

1264 
	`¥ötk
(
KERN_NOTICE


1268 
	}
}

1273 
__öô
 
	$f‹˚_a˝i_ht
(c⁄° 
dmi_sy°em_id
 *
d
)

1275 i‡(!
a˝i_f‹˚
) {

1276 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=ht\n",

1277 
d
->
idít
);

1278 
	`dißbÀ_a˝i
();

1279 
a˝i_ht
 = 1;

1281 
	`¥ötk
(
KERN_NOTICE


1285 
	}
}

1290 
__öô
 
	$dmi_ign‹e_úq0_timî_ovîride
(c⁄° 
dmi_sy°em_id
 *
d
)

1296 i‡(!
a˝i_skù_timî_ovîride
) {

1297 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirkÇot complete.\n");

1298 
	`¥_nŸi˚
("%s detected: Ignoring BIOS IRQ0Öin2 override\n",

1299 
d
->
idít
);

1300 
a˝i_skù_timî_ovîride
 = 1;

1303 
	}
}

1309 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ
[] = {

1314 .
ˇŒback
 = 
dmi_dißbÀ_a˝i
,

1315 .
	gidít
 = "IBM Thinkpad",

1316 .
	gm©ches
 = {

1317 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1318 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1326 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1327 .
	gidít
 = "FSC Primergy T850",

1328 .
	gm©ches
 = {

1329 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

1330 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

1334 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1335 .
	gidít
 = "HP VISUALIZE NT Workstation",

1336 .
	gm©ches
 = {

1337 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

1338 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

1342 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1343 .
	gidít
 = "Compaq Workstation W8000",

1344 .
	gm©ches
 = {

1345 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

1346 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

1350 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1351 .
	gidít
 = "ASUS P2B-DS",

1352 .
	gm©ches
 = {

1353 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1354 
DMI_MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

1358 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1359 .
	gidít
 = "ASUS CUR-DLS",

1360 .
	gm©ches
 = {

1361 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1362 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

1366 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1367 .
	gidít
 = "ABIT i440BX-W83977",

1368 .
	gm©ches
 = {

1369 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

1370 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

1374 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1375 .
	gidít
 = "IBM Bladecenter",

1376 .
	gm©ches
 = {

1377 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1378 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMÉServer BladeCenter HS20"),

1382 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1383 .
	gidít
 = "IBMÉServer xSeries 360",

1384 .
	gm©ches
 = {

1385 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1386 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

1390 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1391 .
	gidít
 = "IBMÉserver xSeries 330",

1392 .
	gm©ches
 = {

1393 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1394 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

1398 .
	gˇŒback
 = 
f‹˚_a˝i_ht
,

1399 .
	gidít
 = "IBMÉserver xSeries 440",

1400 .
	gm©ches
 = {

1401 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1402 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

1410 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1411 .
	gidít
 = "ASUS A7V",

1412 .
	gm©ches
 = {

1413 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1414 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1416 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1427 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1428 .
	gidít
 = "IBM Thinkpad 600 Series 2645",

1429 .
	gm©ches
 = {

1430 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1431 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1435 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1436 .
	gidít
 = "IBM Thinkpad 600 Series 2646",

1437 .
	gm©ches
 = {

1438 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1439 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1446 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1447 .
	gidít
 = "ASUS PR-DLS",

1448 .
	gm©ches
 = {

1449 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1450 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1451 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1453 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1457 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1458 .
	gidít
 = "Acer TravelMate 36x Laptop",

1459 .
	gm©ches
 = {

1460 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1461 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1468 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ_œã
[] = {

1480 .
ˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1481 .
	gidít
 = "HPÇx6115Üaptop",

1482 .
	gm©ches
 = {

1483 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1484 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6115"),

1488 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1489 .
	gidít
 = "HP NX6125Üaptop",

1490 .
	gm©ches
 = {

1491 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1492 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6125"),

1496 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1497 .
	gidít
 = "HP NX6325Üaptop",

1498 .
	gm©ches
 = {

1499 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1500 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6325"),

1504 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1505 .
	gidít
 = "HP 6715bÜaptop",

1506 .
	gm©ches
 = {

1507 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1508 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1537 
__öô
 
	$a˝i_boŸ_èbÀ_öô
()

1539 
îr‹
;

1541 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ
);

1547 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1553 
îr‹
 = 
	`a˝i_èbÀ_öô
();

1554 i‡(
îr‹
) {

1555 
	`dißbÀ_a˝i
();

1556  
îr‹
;

1559 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1564 
îr‹
 = 
	`a˝i_bœckli°ed
();

1565 i‡(
îr‹
) {

1566 i‡(
a˝i_f‹˚
) {

1567 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1569 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1570 
	`dißbÀ_a˝i
();

1571  
îr‹
;

1576 
	}
}

1578 
__öô
 
	$óæy_a˝i_boŸ_öô
()

1584 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1590 
	`óæy_a˝i_¥o˚ss_madt
();

1593 
	}
}

1595 
__öô
 
	$a˝i_boŸ_öô
()

1598 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ_œã
);

1604 i‡(
a˝i_dißbÀd
 && !
a˝i_ht
)

1607 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1612 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_FADT
, 
a˝i_∑r£_Ádt
);

1617 
	`a˝i_¥o˚ss_madt
();

1619 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
a˝i_∑r£_h≥t
);

1622 
	}
}

1624 
__öô
 
	$∑r£_a˝i
(*
¨g
)

1626 i‡(!
¨g
)

1627  -
EINVAL
;

1630 i‡(
	`°rcmp
(
¨g
, "off") == 0) {

1631 
	`dißbÀ_a˝i
();

1634 i‡(
	`°rcmp
(
¨g
, "force") == 0) {

1635 
a˝i_f‹˚
 = 1;

1636 
a˝i_ht
 = 1;

1637 
a˝i_dißbÀd
 = 0;

1640 i‡(
	`°rcmp
(
¨g
, "strict") == 0) {

1641 
a˝i_°ri˘
 = 1;

1644 i‡(
	`°rcmp
(
¨g
, "ht") == 0) {

1645 i‡(!
a˝i_f‹˚
)

1646 
	`dißbÀ_a˝i
();

1647 
a˝i_ht
 = 1;

1650 i‡(
	`°rcmp
(
¨g
, "rsdt") == 0) {

1651 
a˝i_rsdt_f‹˚d
 = 1;

1654 i‡(
	`°rcmp
(
¨g
, "noirq") == 0) {

1655 
	`a˝i_noúq_£t
();

1658  -
EINVAL
;

1661 
	}
}

1662 
óæy_∑øm
("a˝i", 
∑r£_a˝i
);

1665 
__öô
 
	$∑r£_pci
(*
¨g
)

1667 i‡(
¨g
 && 
	`°rcmp
(arg, "noacpi") == 0)

1668 
	`a˝i_dißbÀ_pci
();

1670 
	}
}

1671 
óæy_∑øm
("pci", 
∑r£_pci
);

1673 
__öô
 
	$a˝i_mps_check
()

1675 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& !deföed(
CONFIG_X86_MPPARSE
)

1677 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1678 
	`¥ötk
(
KERN_WARNING
 "MPS support code isÇot built-in.\n"

1685 
	}
}

1687 #ifde‡
CONFIG_X86_IO_APIC


1688 
__öô
 
	$∑r£_a˝i_skù_timî_ovîride
(*
¨g
)

1690 
a˝i_skù_timî_ovîride
 = 1;

1692 
	}
}

1693 
óæy_∑øm
("a˝i_skù_timî_ovîride", 
∑r£_a˝i_skù_timî_ovîride
);

1695 
__öô
 
	$∑r£_a˝i_u£_timî_ovîride
(*
¨g
)

1697 
a˝i_u£_timî_ovîride
 = 1;

1699 
	}
}

1700 
óæy_∑øm
("a˝i_u£_timî_ovîride", 
∑r£_a˝i_u£_timî_ovîride
);

1703 
__öô
 
	$£tup_a˝i_sci
(*
s
)

1705 i‡(!
s
)

1706  -
EINVAL
;

1707 i‡(!
	`°rcmp
(
s
, "edge"))

1708 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1709 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1710 i‡(!
	`°rcmp
(
s
, "level"))

1711 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1712 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1713 i‡(!
	`°rcmp
(
s
, "high"))

1714 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1715 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1716 i‡(!
	`°rcmp
(
s
, "low"))

1717 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1718 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1720  -
EINVAL
;

1722 
	}
}

1723 
óæy_∑øm
("a˝i_sci", 
£tup_a˝i_sci
);

1725 
	$__a˝i_acquúe_globÆ_lock
(*
lock
)

1727 
ﬁd
, 
√w
, 
vÆ
;

1729 
ﬁd
 = *
lock
;

1730 
√w
 = (((
ﬁd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1731 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1732 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1733  (
√w
 < 3) ? -1 : 0;

1734 
	}
}

1736 
	$__a˝i_ªÀa£_globÆ_lock
(*
lock
)

1738 
ﬁd
, 
√w
, 
vÆ
;

1740 
ﬁd
 = *
lock
;

1741 
√w
 = 
ﬁd
 & ~0x3;

1742 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1743 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1744  
ﬁd
 & 0x1;

1745 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/sched.h
>

14 
	~<a˝i/¥o˚ss‹.h
>

15 
	~<asm/a˝i.h
>

27 
	$a˝i_¥o˚ss‹_powî_öô_bm_check
(
a˝i_¥o˚ss‹_Êags
 *
Êags
,

28 
˝u
)

30 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

32 
Êags
->
bm_check
 = 0;

33 i‡(
	`num_⁄löe_˝us
() == 1)

34 
Êags
->
bm_check
 = 1;

35 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

41 
Êags
->
bm_check
 = 1;

50 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

51 (
c
->
x86
 > 0x‡|| (c->x86 =6 && c->
x86_modñ
 >= 14)))

52 
Êags
->
bm_c⁄åﬁ
 = 0;

53 
	}
}

54 
EXPORT_SYMBOL
(
a˝i_¥o˚ss‹_powî_öô_bm_check
);

58 
	sc°©e_íåy
 {

60 
	móx
;

61 
	mecx
;

62 } 
	m°©es
[
ACPI_PROCESSOR_MAX_POWER
];

64 
c°©e_íåy
 *
	g˝u_c°©e_íåy
;

66 
	gmwaô_suµ‹ãd
[
ACPI_PROCESSOR_MAX_POWER
];

68 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

69 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

70 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

72 
	#CPUID_MWAIT_LEAF
 (5)

	)

73 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

74 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

76 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

78 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

80 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
(*
_cx
)

82 
a˝i_¥o˚ss‹_cx
 *
cx
 = 
_cx
;

83 
ªtvÆ
;

84 
óx
, 
ebx
, 
ecx
, 
edx
;

85 
edx_∑π
;

86 
c°©e_ty≥
;

87 
num_c°©e_subty≥
;

89 
	`˝uid
(
CPUID_MWAIT_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
c°©e_ty≥
 = ((
cx
->
addªss
 >> 
MWAIT_SUBSTATE_SIZE
) &

93 
MWAIT_CSTATE_MASK
) + 1;

94 
edx_∑π
 = 
edx
 >> (
c°©e_ty≥
 * 
MWAIT_SUBSTATE_SIZE
);

95 
num_c°©e_subty≥
 = 
edx_∑π
 & 
MWAIT_SUBSTATE_MASK
;

97 
ªtvÆ
 = 0;

98 i‡(
num_c°©e_subty≥
 < (
cx
->
addªss
 & 
MWAIT_SUBSTATE_MASK
)) {

99 
ªtvÆ
 = -1;

100 
out
;

104 i‡(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

105 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

106 
ªtvÆ
 = -1;

107 
out
;

110 i‡(!
mwaô_suµ‹ãd
[
c°©e_ty≥
]) {

111 
mwaô_suµ‹ãd
[
c°©e_ty≥
] = 1;

112 
	`¥ötk
(
KERN_DEBUG


114 "°©e\n", 
cx
->
ty≥
);

116 
	`¢¥ötf
(
cx
->
desc
,

117 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

118 
cx
->
addªss
);

119 
out
:

120  
ªtvÆ
;

121 
	}
}

123 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe
(
˝u
,

124 
a˝i_¥o˚ss‹_cx
 *
cx
, 
a˝i_powî_ªgi°î
 *
ªg
)

126 
c°©e_íåy
 *
≥r˝u_íåy
;

127 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

128 
ªtvÆ
;

130 i‡(!
˝u_c°©e_íåy
 || 
c
->
˝uid_Àvñ
 < 
CPUID_MWAIT_LEAF
)

133 i‡(
ªg
->
bô_off£t
 !
NATIVE_CSTATE_BEYOND_HALT
)

136 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

137 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = 0;

138 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 0;

142 
ªtvÆ
 = 
	`w‹k_⁄_˝u
(
˝u
, 
a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
, 
cx
);

143 i‡(
ªtvÆ
 == 0) {

145 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = cx->
addªss
;

146 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

148  
ªtvÆ
;

149 
	}
}

150 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_¥obe
);

152 
	$a˝i_¥o˚ss‹_ffh_c°©e_íãr
(
a˝i_¥o˚ss‹_cx
 *
cx
)

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
c°©e_íåy
 *
≥r˝u_íåy
;

157 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

158 
	`mwaô_idÀ_wôh_höts
(
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
,

159 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
);

160 
	}
}

161 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_íãr
);

163 
__öô
 
	$ffh_c°©e_öô
()

165 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

166 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
)

169 
˝u_c°©e_íåy
 = 
	`Æloc_≥r˝u
(
c°©e_íåy
);

171 
	}
}

173 
__exô
 
	$ffh_c°©e_exô
()

175 
	`‰ì_≥r˝u
(
˝u_c°©e_íåy
);

176 
˝u_c°©e_íåy
 = 
NULL
;

177 
	}
}

179 
¨ch_öôˇŒ
(
ffh_c°©e_öô
);

180 
__exôˇŒ
(
ffh_c°©e_exô
);

	@/cmpt816/linux/arch/x86/kernel/acpi/processor.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

12 
	~<a˝i/¥o˚ss‹.h
>

13 
	~<asm/a˝i.h
>

15 
	$öô_öãl_pdc
(
a˝i_¥o˚ss‹
 *
¥
, 
˝uöfo_x86
 *
c
)

17 
a˝i_obje˘_li°
 *
obj_li°
;

18 
a˝i_obje˘
 *
obj
;

19 
u32
 *
buf
;

22 
obj_li°
 = 
	`kmÆloc
((
a˝i_obje˘_li°
), 
GFP_KERNEL
);

23 i‡(!
obj_li°
) {

24 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

28 
obj
 = 
	`kmÆloc
((
a˝i_obje˘
), 
GFP_KERNEL
);

29 i‡(!
obj
) {

30 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

31 
	`k‰ì
(
obj_li°
);

35 
buf
 = 
	`kmÆloc
(12, 
GFP_KERNEL
);

36 i‡(!
buf
) {

37 
	`¥ötk
(
KERN_ERR
 "MemoryállocationÉrror\n");

38 
	`k‰ì
(
obj
);

39 
	`k‰ì
(
obj_li°
);

43 
buf
[0] = 
ACPI_PDC_REVISION_ID
;

44 
buf
[1] = 1;

45 
buf
[2] = 
ACPI_PDC_C_CAPABILITY_SMP
;

52 
buf
[2] |
ACPI_PDC_SMP_T_SWCOORD
;

53 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_EST
))

54 
buf
[2] |
ACPI_PDC_EST_CAPABILITY_SWSMP
;

56 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
))

57 
buf
[2] |
ACPI_PDC_T_FFH
;

62 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
))

63 
buf
[2] &~(
ACPI_PDC_C_C2C3_FFH
);

65 
obj
->
ty≥
 = 
ACPI_TYPE_BUFFER
;

66 
obj
->
buf„r
.
Àngth
 = 12;

67 
obj
->
buf„r
.
poöãr
 = (
u8
 *Ë
buf
;

68 
obj_li°
->
cou¡
 = 1;

69 
obj_li°
->
poöãr
 = 
obj
;

70 
¥
->
pdc
 = 
obj_li°
;

73 
	}
}

77 
	$¨ch_a˝i_¥o˚ss‹_öô_pdc
(
a˝i_¥o˚ss‹
 *
¥
)

79 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
¥
->
id
);

81 
¥
->
pdc
 = 
NULL
;

82 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 ||

83 
c
->
x86_víd‹
 =
X86_VENDOR_CENTAUR
)

84 
	`öô_öãl_pdc
(
¥
, 
c
);

87 
	}
}

89 
EXPORT_SYMBOL
(
¨ch_a˝i_¥o˚ss‹_öô_pdc
);

91 
	$¨ch_a˝i_¥o˚ss‹_˛ónup_pdc
(
a˝i_¥o˚ss‹
 *
¥
)

93 i‡(
¥
->
pdc
) {

94 
	`k‰ì
(
¥
->
pdc
->
poöãr
->
buf„r
.pointer);

95 
	`k‰ì
(
¥
->
pdc
->
poöãr
);

96 
	`k‰ì
(
¥
->
pdc
);

97 
¥
->
pdc
 = 
NULL
;

99 
	}
}

101 
EXPORT_SYMBOL
(
¨ch_a˝i_¥o˚ss‹_˛ónup_pdc
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c

1 
	~"../../../boŸ/ªgs.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boŸ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boŸ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boŸ/video-veß.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boŸ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boŸ.h
"

4 
	$udñay
(
lo›s
)

6 
lo›s
--)

7 
	`io_dñay
();

8 
	}
}

10 
	$bìp
(
hz
)

12 
u8
 
íabÀ
;

14 i‡(!
hz
) {

15 
íabÀ
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_dñay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_dñay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_dñay
();

26 
íabÀ
 = 0x03;

28 
	`öb
(0x61);

29 
	`io_dñay
();

30 
	`outb
(
íabÀ
, 0x61);

31 
	`io_dñay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_m‹£
(c⁄° *
∑âîn
)

41 
s
;

43 (
s
 = *
∑âîn
++)) {

44 
s
) {

46 
	`bìp
(
DOT_HZ
);

47 
	`udñay
(
US_PER_DOT
);

48 
	`bìp
(0);

49 
	`udñay
(
US_PER_DOT
);

52 
	`bìp
(
DASH_HZ
);

53 
	`udñay
(
US_PER_DOT
 * 3);

54 
	`bìp
(0);

55 
	`udñay
(
US_PER_DOT
);

58 
	`udñay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maö
()

67 i‡(
wakeup_hódî
.
ªÆ_magic
 != 0x12345678)

70 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 4)

71 
	`£nd_m‹£
("...-");

73 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 2) {

78 
	`¥obe_ˇrds
(0);

79 
	`£t_mode
(
wakeup_hódî
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<löux/a˝i.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/dmi.h
>

11 
	~<löux/˝umask.h
>

12 
	~<asm/£gmít.h
>

13 
	~<asm/desc.h
>

15 
	~"ªÆmode/wakeup.h
"

16 
	~"¶ìp.h
"

18 
	ga˝i_wakeup_addªss
;

19 
	ga˝i_ªÆmode_Êags
;

22 
	ga˝i_ªÆmode
;

24 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_64BIT
)

25 
	gãmp_°ack
[4096];

36 
	$a˝i_ßve_°©e_mem
()

38 
wakeup_hódî
 *
hódî
;

40 i‡(!
a˝i_ªÆmode
) {

41 
	`¥ötk
(
KERN_ERR
 "CouldÇotállocate memory during boot, "

43  -
ENOMEM
;

45 
	`mem˝y
((*)
a˝i_ªÆmode
, &
wakeup_code_°¨t
, 
WAKEUP_SIZE
);

47 
hódî
 = (
wakeup_hódî
 *)(
a˝i_ªÆmode
 + 
HEADER_OFFSET
);

48 i‡(
hódî
->
sig«tuª
 != 0x51ee1111) {

49 
	`¥ötk
(
KERN_ERR
 "wakeup header doesÇot match\n");

50  -
EINVAL
;

53 
hódî
->
video_mode
 = 
ßved_video_mode
;

55 
hódî
->
wakeup_jmp_£g
 = 
a˝i_wakeup_addªss
 >> 4;

66 
hódî
->
wakeup_gdt
[0] =

67 (
u64
)((
hódî
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
a˝i_wakeup_addªss
 +

69 ((*)&
hódî
->
wakeup_gdt
 - (*)
a˝i_ªÆmode
))

72 
hódî
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
a˝i_wakeup_addªss
, 0xfffff);

75 
hódî
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
a˝i_wakeup_addªss
, 0xfffff);

78 #i‚de‡
CONFIG_64BIT


79 
	`°‹e_gdt
((
desc_±r
 *)&
hódî
->
pmode_gdt
);

81 
hódî
->
pmode_e„r_low
 = 
nx_íabÀd
;

82 i‡(
hódî
->
pmode_e„r_low
 & 1) {

84 
	`rdm§
(
MSR_EFER
, 
hódî
->
pmode_e„r_low
,

85 
hódî
->
pmode_e„r_high
);

89 
hódî
->
pmode_¸0
 = 
	`ªad_¸0
();

90 
hódî
->
pmode_¸4
 = 
	`ªad_¸4_ß„
();

91 
hódî
->
ªÆmode_Êags
 = 
a˝i_ªÆmode_Êags
;

92 
hódî
->
ªÆ_magic
 = 0x12345678;

94 #i‚de‡
CONFIG_64BIT


95 
hódî
->
pmode_íåy
 = (
u32
)&
wakeup_pmode_ªtu∫
;

96 
hódî
->
pmode_¸3
 = (
u32
)(
swsu•_pg_dú
 - 
__PAGE_OFFSET
);

97 
ßved_magic
 = 0x12345678;

99 
hódî
->
åampﬁöe_£gmít
 = 
	`£tup_åampﬁöe
() >> 4;

100 #ifde‡
CONFIG_SMP


101 
°ack_°¨t
.
•
 = 
ãmp_°ack
 + (temp_stack);

102 
óæy_gdt_des¸
.
addªss
 =

103 ()
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

104 
öôül_gs
 = 
	`≥r_˝u_off£t
(
	`smp_¥o˚ss‹_id
());

106 
öôül_code
 = ()
wakeup_l⁄g64
;

107 
ßved_magic
 = 0x123456789abcdef0L;

111 
	}
}

116 
	$a˝i_ª°‹e_°©e_mem
()

118 
	}
}

129 
__öô
 
	$a˝i_ª£rve_boŸmem
()

131 i‡((&
wakeup_code_íd
 - &
wakeup_code_°¨t
Ë> 
WAKEUP_SIZE
) {

132 
	`¥ötk
(
KERN_ERR


137 
a˝i_ªÆmode
 = ()
	`Æloc_boŸmem_low
(
WAKEUP_SIZE
);

139 i‡(!
a˝i_ªÆmode
) {

140 
	`¥ötk
(
KERN_ERR
 "ACPI: CannotállocateÜowmem, S3 disabled.\n");

144 
a˝i_wakeup_addªss
 = 
	`vút_to_phys
((*)
a˝i_ªÆmode
);

145 
	}
}

148 
__öô
 
	$a˝i_¶ìp_£tup
(*
°r
)

150 (
°r
 !
NULL
) && (*str != '\0')) {

151 i‡(
	`°∫cmp
(
°r
, "s3_bios", 7) == 0)

152 
a˝i_ªÆmode_Êags
 |= 1;

153 i‡(
	`°∫cmp
(
°r
, "s3_mode", 7) == 0)

154 
a˝i_ªÆmode_Êags
 |= 2;

155 i‡(
	`°∫cmp
(
°r
, "s3_beep", 7) == 0)

156 
a˝i_ªÆmode_Êags
 |= 4;

157 #ifde‡
CONFIG_HIBERNATION


158 i‡(
	`°∫cmp
(
°r
, "s4_nohwsig", 10) == 0)

159 
	`a˝i_no_s4_hw_sig«tuª
();

160 i‡(
	`°∫cmp
(
°r
, "s4_nonvs", 8) == 0)

161 
	`a˝i_s4_no_nvs
();

163 i‡(
	`°∫cmp
(
°r
, "old_ordering", 12) == 0)

164 
	`a˝i_ﬁd_su•íd_‹dîög
();

165 
°r
 = 
	`°rchr
(str, ',');

166 i‡(
°r
 !
NULL
)

167 
°r
 +
	`°r•n
(str, ", \t");

170 
	}
}

172 
__£tup
("a˝i_¶ìp=", 
a˝i_¶ìp_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/muãx.h
>

4 
	~<löux/li°.h
>

5 
	~<löux/°rögify.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/mm.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~<löux/mem‹y.h
>

10 
	~<asm/Æã∫©ive.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/pgèbÀ.h
>

13 
	~<asm/m˚.h
>

14 
	~<asm/nmi.h
>

15 
	~<asm/vsysˇŒ.h
>

16 
	~<asm/ˇcheÊush.h
>

17 
	~<asm/ébÊush.h
>

18 
	~<asm/io.h
>

19 
	~<asm/fixm≠.h
>

21 
	#MAX_PATCH_LEN
 (255-1)

	)

23 #ifde‡
CONFIG_HOTPLUG_CPU


24 
	gsmp_Æt_⁄˚
;

26 
__öô
 
	$boŸ⁄ly
(*
°r
)

28 
smp_Æt_⁄˚
 = 1;

30 
	}
}

31 
__£tup
("smp-Æt-boŸ", 
boŸ⁄ly
);

33 
	#smp_Æt_⁄˚
 1

	)

36 
__öôd©a_‹_moduÀ
 
	gdebug_Æã∫©ive
;

38 
__öô
 
	$debug_Æt
(*
°r
)

40 
debug_Æã∫©ive
 = 1;

42 
	}
}

43 
__£tup
("debug-Æã∫©ive", 
debug_Æt
);

45 
	gn‹ïœ˚_smp
;

47 
__öô
 
	$£tup_n‹ïœ˚_smp
(*
°r
)

49 
n‹ïœ˚_smp
 = 1;

51 
	}
}

52 
__£tup
("n‹ïœ˚-smp", 
£tup_n‹ïœ˚_smp
);

54 #ifde‡
CONFIG_PARAVIRT


55 
__öôd©a_‹_moduÀ
 
	gn‹ïœ˚_∑øvút
 = 0;

57 
__öô
 
	$£tup_n‹ïœ˚_∑øvút
(*
°r
)

59 
n‹ïœ˚_∑øvút
 = 1;

61 
	}
}

62 
__£tup
("n‹ïœ˚-∑øvút", 
£tup_n‹ïœ˚_∑øvút
);

65 
	#DPRINTK
(
fmt
, 
¨gs
...Ëi‡(
debug_Æã∫©ive
) \

66 
	`¥ötk
(
KERN_DEBUG
 
fmt
, 
¨gs
)

	)

68 #i‡
deföed
(
GENERIC_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

72 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nintelnops: "

73 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


74 
GENERIC_NOP7
 
GENERIC_NOP8


76 c⁄° 
öã ›s
[];

77 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


78 
	göãl_n›s
[
ASM_NOP_MAX
+1] = {

79 
NULL
,

80 
öã ›s
,

81 
öã ›s
 + 1,

82 
öã ›s
 + 1 + 2,

83 
öã ›s
 + 1 + 2 + 3,

84 
öã ›s
 + 1 + 2 + 3 + 4,

85 
öã ›s
 + 1 + 2 + 3 + 4 + 5,

86 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6,

87 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

91 #ifde‡
K8_NOP1


92 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk8nops: "

93 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


94 
K8_NOP7
 
K8_NOP8


96 c⁄° 
k8n›s
[];

97 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


98 
	gk8_n›s
[
ASM_NOP_MAX
+1] = {

99 
NULL
,

100 
k8n›s
,

101 
k8n›s
 + 1,

102 
k8n›s
 + 1 + 2,

103 
k8n›s
 + 1 + 2 + 3,

104 
k8n›s
 + 1 + 2 + 3 + 4,

105 
k8n›s
 + 1 + 2 + 3 + 4 + 5,

106 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

107 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

111 #i‡
deföed
(
K7_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

112 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk7nops: "

113 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


114 
K7_NOP7
 
K7_NOP8


116 c⁄° 
k7n›s
[];

117 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


118 
	gk7_n›s
[
ASM_NOP_MAX
+1] = {

119 
NULL
,

120 
k7n›s
,

121 
k7n›s
 + 1,

122 
k7n›s
 + 1 + 2,

123 
k7n›s
 + 1 + 2 + 3,

124 
k7n›s
 + 1 + 2 + 3 + 4,

125 
k7n›s
 + 1 + 2 + 3 + 4 + 5,

126 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

127 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

131 #ifde‡
P6_NOP1


132 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\np6nops: "

133 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


134 
P6_NOP7
 
P6_NOP8


136 c⁄° 
p6n›s
[];

137 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


138 
	gp6_n›s
[
ASM_NOP_MAX
+1] = {

139 
NULL
,

140 
p6n›s
,

141 
p6n›s
 + 1,

142 
p6n›s
 + 1 + 2,

143 
p6n›s
 + 1 + 2 + 3,

144 
p6n›s
 + 1 + 2 + 3 + 4,

145 
p6n›s
 + 1 + 2 + 3 + 4 + 5,

146 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

147 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

151 #ifde‡
CONFIG_X86_64


153 
__vsysˇŒ_0
;

154 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

156 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

157 
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

158  
p6_n›s
;

160  
k8_n›s
;

161 
	}
}

165 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

167 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K8
))

168  
k8_n›s
;

169 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K7
))

170  
k7_n›s
;

171 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

172  
p6_n›s
;

174  
öãl_n›s
;

175 
	}
}

180 
__öô_‹_moduÀ
 
	$add_n›s
(*
ö¢s
, 
Àn
)

182 c⁄° *c⁄° *
n›èbÀ
 = 
	`föd_n›_èbÀ
();

184 
Àn
 > 0) {

185 
n›Àn
 = 
Àn
;

186 i‡(
n›Àn
 > 
ASM_NOP_MAX
)

187 
n›Àn
 = 
ASM_NOP_MAX
;

188 
	`mem˝y
(
ö¢s
, 
n›èbÀ
[
n›Àn
],Çoplen);

189 
ö¢s
 +
n›Àn
;

190 
Àn
 -
n›Àn
;

192 
	}
}

194 
Æt_ö°r
 
__Æt_ö°ru˘i⁄s
[], 
__Æt_ö°ru˘i⁄s_íd
[];

195 
u8
 *
__smp_locks
[], *
__smp_locks_íd
[];

196 *
ãxt_poke_óæy
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
);

204 
__öô_‹_moduÀ
 
	$≠∂y_Æã∫©ives
(
Æt_ö°r
 *
°¨t
,

205 
Æt_ö°r
 *
íd
)

207 
Æt_ö°r
 *
a
;

208 
ö¢buf
[
MAX_PATCH_LEN
];

210 
	`DPRINTK
("%s:á…ÅabÀ %∞-> %p\n", 
__func__
, 
°¨t
, 
íd
);

211 
a
 = 
°¨t
;á < 
íd
;á++) {

212 
u8
 *
ö°r
 = 
a
->instr;

213 
	`BUG_ON
(
a
->
ª∂a˚míéí
 >á->
ö°æí
);

214 
	`BUG_ON
(
a
->
ö°æí
 > (
ö¢buf
));

215 i‡(!
	`boŸ_˝u_has
(
a
->
˝uid
))

217 #ifde‡
CONFIG_X86_64


219 i‡(
ö°r
 >(
u8
 *)
VSYSCALL_START
 && in°∏< (u8*)
VSYSCALL_END
) {

220 
ö°r
 = 
	`__va
(ö°∏- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__∑_symbﬁ
(&
__vsysˇŒ_0
));

221 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

222 
__func__
, 
a
->
ö°r
, instr);

225 
	`mem˝y
(
ö¢buf
, 
a
->
ª∂a˚mít
,á->
ª∂a˚míéí
);

226 
	`add_n›s
(
ö¢buf
 + 
a
->
ª∂a˚míéí
,

227 
a
->
ö°æí
 -á->
ª∂a˚míéí
);

228 
	`ãxt_poke_óæy
(
ö°r
, 
ö¢buf
, 
a
->
ö°æí
);

230 
	}
}

232 #ifde‡
CONFIG_SMP


234 
	$Æã∫©ives_smp_lock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

236 
u8
 **
±r
;

238 
	`muãx_lock
(&
ãxt_muãx
);

239 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

240 i‡(*
±r
 < 
ãxt
)

242 i‡(*
±r
 > 
ãxt_íd
)

245 
	`ãxt_poke
(*
±r
, (([]){0xf0}), 1);

247 
	`muãx_u∆ock
(&
ãxt_muãx
);

248 
	}
}

250 
	$Æã∫©ives_smp_u∆ock
(
u8
 **
°¨t
, u8 **
íd
, u8 *
ãxt
, u8 *
ãxt_íd
)

252 
u8
 **
±r
;

254 i‡(
n‹ïœ˚_smp
)

257 
	`muãx_lock
(&
ãxt_muãx
);

258 
±r
 = 
°¨t
;Öå < 
íd
;Ötr++) {

259 i‡(*
±r
 < 
ãxt
)

261 i‡(*
±r
 > 
ãxt_íd
)

264 
	`ãxt_poke
(*
±r
, (([]){0x3E}), 1);

266 
	`muãx_u∆ock
(&
ãxt_muãx
);

267 
	}
}

269 
	ssmp_Æt_moduÀ
 {

271 
moduÀ
 *
	mmod
;

272 *
	m«me
;

275 
u8
 **
	mlocks
;

276 
u8
 **
	mlocks_íd
;

279 
u8
 *
	mãxt
;

280 
u8
 *
	mãxt_íd
;

282 
li°_hód
 
	m√xt
;

284 
LIST_HEAD
(
smp_Æt_moduÀs
);

285 
DEFINE_MUTEX
(
smp_Æt
);

286 
	gsmp_mode
 = 1;

288 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_add
(
moduÀ
 *
mod
,

289 *
«me
,

290 *
locks
, *
locks_íd
,

291 *
ãxt
, *
ãxt_íd
)

293 
smp_Æt_moduÀ
 *
smp
;

295 i‡(
n‹ïœ˚_smp
)

298 i‡(
smp_Æt_⁄˚
) {

299 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

300 
	`Æã∫©ives_smp_u∆ock
(
locks
, 
locks_íd
,

301 
ãxt
, 
ãxt_íd
);

305 
smp
 = 
	`kzÆloc
((*smp), 
GFP_KERNEL
);

306 i‡(
NULL
 =
smp
)

309 
smp
->
mod
 = mod;

310 
smp
->
«me
 =Çame;

311 
smp
->
locks
 =Üocks;

312 
smp
->
locks_íd
 =Üocks_end;

313 
smp
->
ãxt
 =Åext;

314 
smp
->
ãxt_íd
 =Åext_end;

315 
	`DPRINTK
("%s:Üocks %p -> %p,Åext %p -> %p,Çame %s\n",

316 
__func__
, 
smp
->
locks
, smp->
locks_íd
,

317 
smp
->
ãxt
, smp->
ãxt_íd
, smp->
«me
);

319 
	`muãx_lock
(&
smp_Æt
);

320 
	`li°_add_èû
(&
smp
->
√xt
, &
smp_Æt_moduÀs
);

321 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

322 
	`Æã∫©ives_smp_u∆ock
(
smp
->
locks
, smp->
locks_íd
,

323 
smp
->
ãxt
, smp->
ãxt_íd
);

324 
	`muãx_u∆ock
(&
smp_Æt
);

325 
	}
}

327 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_dñ
(
moduÀ
 *
mod
)

329 
smp_Æt_moduÀ
 *
ôem
;

331 i‡(
smp_Æt_⁄˚
 || 
n‹ïœ˚_smp
)

334 
	`muãx_lock
(&
smp_Æt
);

335 
	`li°_f‹_óch_íåy
(
ôem
, &
smp_Æt_moduÀs
, 
√xt
) {

336 i‡(
mod
 !
ôem
->mod)

338 
	`li°_dñ
(&
ôem
->
√xt
);

339 
	`muãx_u∆ock
(&
smp_Æt
);

340 
	`DPRINTK
("%s: %s\n", 
__func__
, 
ôem
->
«me
);

341 
	`k‰ì
(
ôem
);

344 
	`muãx_u∆ock
(&
smp_Æt
);

345 
	}
}

347 
	$Æã∫©ives_smp_swôch
(
smp
)

349 
smp_Æt_moduÀ
 *
mod
;

351 #ifde‡
CONFIG_LOCKDEP


359 
	`¥ötk
("lockdep: fixing upálternatives.\n");

362 i‡(
n‹ïœ˚_smp
 || 
smp_Æt_⁄˚
)

364 
	`BUG_ON
(!
smp
 && (
	`num_⁄löe_˝us
() > 1));

366 
	`muãx_lock
(&
smp_Æt
);

372 i‡(
smp
 =
smp_mode
) {

374 } i‡(
smp
) {

375 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo SMP code\n");

376 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

377 
	`˛ór_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

378 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

379 
	`Æã∫©ives_smp_lock
(
mod
->
locks
, mod->
locks_íd
,

380 
mod
->
ãxt
, mod->
ãxt_íd
);

382 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

383 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

384 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

385 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

386 
	`Æã∫©ives_smp_u∆ock
(
mod
->
locks
, mod->
locks_íd
,

387 
mod
->
ãxt
, mod->
ãxt_íd
);

389 
smp_mode
 = 
smp
;

390 
	`muãx_u∆ock
(&
smp_Æt
);

391 
	}
}

395 #ifde‡
CONFIG_PARAVIRT


396 
__öô_‹_moduÀ
 
	$≠∂y_∑øvút
(
∑øvút_∑tch_sôe
 *
°¨t
,

397 
∑øvút_∑tch_sôe
 *
íd
)

399 
∑øvút_∑tch_sôe
 *
p
;

400 
ö¢buf
[
MAX_PATCH_LEN
];

402 i‡(
n‹ïœ˚_∑øvút
)

405 
p
 = 
°¨t
;Ö < 
íd
;Ö++) {

406 
u£d
;

408 
	`BUG_ON
(
p
->
Àn
 > 
MAX_PATCH_LEN
);

410 
	`mem˝y
(
ö¢buf
, 
p
->
ö°r
,Ö->
Àn
);

411 
u£d
 = 
pv_öô_›s
.
	`∑tch
(
p
->
ö°πy≥
,Ö->
˛obbîs
, 
ö¢buf
,

412 ()
p
->
ö°r
,Ö->
Àn
);

414 
	`BUG_ON
(
u£d
 > 
p
->
Àn
);

417 
	`add_n›s
(
ö¢buf
 + 
u£d
, 
p
->
Àn
 - used);

418 
	`ãxt_poke_óæy
(
p
->
ö°r
, 
ö¢buf
,Ö->
Àn
);

420 
	}
}

421 
∑øvút_∑tch_sôe
 
__°¨t_∑øö°ru˘i⁄s
[],

422 
__°›_∑øö°ru˘i⁄s
[];

425 
__öô
 
	$Æã∫©ive_ö°ru˘i⁄s
()

430 
	`°›_nmi
();

443 
	`≠∂y_Æã∫©ives
(
__Æt_ö°ru˘i⁄s
, 
__Æt_ö°ru˘i⁄s_íd
);

448 #ifde‡
CONFIG_HOTPLUG_CPU


449 i‡(
	`num_possibÀ_˝us
() < 2)

450 
smp_Æt_⁄˚
 = 1;

453 #ifde‡
CONFIG_SMP


454 i‡(
smp_Æt_⁄˚
) {

455 i‡(1 =
	`num_possibÀ_˝us
()) {

456 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

457 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

458 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

460 
	`Æã∫©ives_smp_u∆ock
(
__smp_locks
, 
__smp_locks_íd
,

461 
_ãxt
, 
_ëext
);

464 
	`Æã∫©ives_smp_moduÀ_add
(
NULL
, "core kernel",

465 
__smp_locks
, 
__smp_locks_íd
,

466 
_ãxt
, 
_ëext
);

469 i‡(
	`num_¥e£¡_˝us
(Ë=1 || 
£tup_max_˝us
 <= 1)

470 
	`Æã∫©ives_smp_swôch
(0);

473 
	`≠∂y_∑øvút
(
__∑øö°ru˘i⁄s
, 
__∑øö°ru˘i⁄s_íd
);

475 i‡(
smp_Æt_⁄˚
)

476 
	`‰ì_öô_∑ges
("SMPálternatives",

477 ()
__smp_locks
,

478 ()
__smp_locks_íd
);

480 
	`ª°¨t_nmi
();

481 
	}
}

495 *
__öô_‹_moduÀ
 
	$ãxt_poke_óæy
(*
addr
, c⁄° *
›code
,

496 
size_t
 
Àn
)

498 
Êags
;

499 
	`loˇl_úq_ßve
(
Êags
);

500 
	`mem˝y
(
addr
, 
›code
, 
Àn
);

501 
	`sync_c‹e
();

502 
	`loˇl_úq_ª°‹e
(
Êags
);

505  
addr
;

506 
	}
}

521 *
__k¥obes
 
	$ãxt_poke
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

523 
Êags
;

524 *
vaddr
;

525 
∑ge
 *
∑ges
[2];

526 
i
;

528 i‡(!
	`c‹e_kî√l_ãxt
(()
addr
)) {

529 
∑ges
[0] = 
	`vmÆloc_to_∑ge
(
addr
);

530 
∑ges
[1] = 
	`vmÆloc_to_∑ge
(
addr
 + 
PAGE_SIZE
);

532 
∑ges
[0] = 
	`vút_to_∑ge
(
addr
);

533 
	`WARN_ON
(!
	`PageRe£rved
(
∑ges
[0]));

534 
∑ges
[1] = 
	`vút_to_∑ge
(
addr
 + 
PAGE_SIZE
);

536 
	`BUG_ON
(!
∑ges
[0]);

537 
	`loˇl_úq_ßve
(
Êags
);

538 
	`£t_fixm≠
(
FIX_TEXT_POKE0
, 
	`∑ge_to_phys
(
∑ges
[0]));

539 i‡(
∑ges
[1])

540 
	`£t_fixm≠
(
FIX_TEXT_POKE1
, 
	`∑ge_to_phys
(
∑ges
[1]));

541 
vaddr
 = (*)
	`fix_to_vút
(
FIX_TEXT_POKE0
);

542 
	`mem˝y
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
›code
, 
Àn
);

543 
	`˛ór_fixm≠
(
FIX_TEXT_POKE0
);

544 i‡(
∑ges
[1])

545 
	`˛ór_fixm≠
(
FIX_TEXT_POKE1
);

546 
	`loˇl_Êush_éb
();

547 
	`sync_c‹e
();

550 
i
 = 0; i < 
Àn
; i++)

551 
	`BUG_ON
(((*)
addr
)[
i
] !((*)
›code
)[i]);

552 
	`loˇl_úq_ª°‹e
(
Êags
);

553  
addr
;

554 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<löux/pci.h
>

21 
	~<löux/gÂ.h
>

22 
	~<löux/bô›s.h
>

23 
	~<löux/debugfs.h
>

24 
	~<löux/sˇâîli°.h
>

25 
	~<löux/dma-m≠pög.h
>

26 
	~<löux/iommu-hñ≥r.h
>

27 
	~<löux/iommu.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¨t.h
>

31 
	~<asm/amd_iommu_ty≥s.h
>

32 
	~<asm/amd_iommu.h
>

34 
	#CMD_SET_TYPE
(
cmd
, 
t
Ë((cmd)->
d©a
[1] |(—Ë<< 28))

	)

36 
	#EXIT_LOOP_COUNT
 10000000

	)

38 
DEFINE_RWLOCK
(
amd_iommu_devèbÀ_lock
);

41 
LIST_HEAD
(
iommu_pd_li°
);

42 
DEFINE_SPINLOCK
(
iommu_pd_li°_lock
);

48 
¥Ÿe˘i⁄_domaö
 *
	g±_domaö
;

50 
iommu_›s
 
	gamd_iommu_›s
;

55 
	siommu_cmd
 {

56 
u32
 
	md©a
[4];

59 
dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

60 
unôy_m≠_íåy
 *
e
);

61 
dma_›s_domaö
 *
föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
);

62 
u64
 *
Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

63 
addªss
, 
íd_lvl
,

64 
u64
 **
±e_∑ge
, 
gÂ_t
 
gÂ
);

65 
dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

66 
°¨t_∑ge
,

67 
∑ges
);

68 
ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
);

69 
u64
 *
„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

70 
addªss
, 
m≠_size
);

71 
upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
);

73 #ifde‡
CONFIG_AMD_IOMMU_STATS


79 
DECLARE_STATS_COUNTER
(
com∂_waô
);

80 
DECLARE_STATS_COUNTER
(
˙t_m≠_sögÀ
);

81 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

82 
DECLARE_STATS_COUNTER
(
˙t_m≠_sg
);

83 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sg
);

84 
DECLARE_STATS_COUNTER
(
˙t_Æloc_cohîít
);

85 
DECLARE_STATS_COUNTER
(
˙t_‰ì_cohîít
);

86 
DECLARE_STATS_COUNTER
(
¸oss_∑ge
);

87 
DECLARE_STATS_COUNTER
(
domaö_Êush_sögÀ
);

88 
DECLARE_STATS_COUNTER
(
domaö_Êush_Æl
);

89 
DECLARE_STATS_COUNTER
(
Ælo˚d_io_mem
);

90 
DECLARE_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

92 
díåy
 *
	g°©s_dú
;

93 
díåy
 *
	gde_isﬁ©e
;

94 
díåy
 *
	gde_fÊush
;

96 
	$amd_iommu_°©s_add
(
__iommu_cou¡î
 *
˙t
)

98 i‡(
°©s_dú
 =
NULL
)

101 
˙t
->
dít
 = 
	`debugfs_¸óã_u64
(˙t->
«me
, 0444, 
°©s_dú
,

102 &
˙t
->
vÆue
);

103 
	}
}

105 
	$amd_iommu_°©s_öô
()

107 
°©s_dú
 = 
	`debugfs_¸óã_dú
("amd-iommu", 
NULL
);

108 i‡(
°©s_dú
 =
NULL
)

111 
de_isﬁ©e
 = 
	`debugfs_¸óã_boﬁ
("isﬁ©i⁄", 0444, 
°©s_dú
,

112 (
u32
 *)&
amd_iommu_isﬁ©e
);

114 
de_fÊush
 = 
	`debugfs_¸óã_boﬁ
("fuŒÊush", 0444, 
°©s_dú
,

115 (
u32
 *)&
amd_iommu_unm≠_Êush
);

117 
	`amd_iommu_°©s_add
(&
com∂_waô
);

118 
	`amd_iommu_°©s_add
(&
˙t_m≠_sögÀ
);

119 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sögÀ
);

120 
	`amd_iommu_°©s_add
(&
˙t_m≠_sg
);

121 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sg
);

122 
	`amd_iommu_°©s_add
(&
˙t_Æloc_cohîít
);

123 
	`amd_iommu_°©s_add
(&
˙t_‰ì_cohîít
);

124 
	`amd_iommu_°©s_add
(&
¸oss_∑ge
);

125 
	`amd_iommu_°©s_add
(&
domaö_Êush_sögÀ
);

126 
	`amd_iommu_°©s_add
(&
domaö_Êush_Æl
);

127 
	`amd_iommu_°©s_add
(&
Ælo˚d_io_mem
);

128 
	`amd_iommu_°©s_add
(&
tŸÆ_m≠_ªque°s
);

129 
	}
}

134 
	$iommu_has_≈ˇche
(
amd_iommu
 *
iommu
)

136  
iommu
->
ˇp
 & (1UL << 
IOMMU_CAP_NPCACHE
);

137 
	}
}

145 
	$dump_dã_íåy
(
u16
 
devid
)

147 
i
;

149 
i
 = 0; i < 8; ++i)

150 
	`¥_îr
("AMD-Vi: DTE[%d]: %08x\n", 
i
,

151 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
]);

152 
	}
}

154 
	$dump_comm™d
(
phys_addr
)

156 
iommu_cmd
 *
cmd
 = 
	`phys_to_vút
(
phys_addr
);

157 
i
;

159 
i
 = 0; i < 4; ++i)

160 
	`¥_îr
("AMD-Vi: CMD[%d]: %08x\n", 
i
, 
cmd
->
d©a
[i]);

161 
	}
}

163 
	$iommu_¥öt_evít
(
amd_iommu
 *
iommu
, *
__evt
)

165 
u32
 *
evít
 = 
__evt
;

166 
ty≥
 = (
evít
[1] >> 
EVENT_TYPE_SHIFT
Ë& 
EVENT_TYPE_MASK
;

167 
devid
 = (
evít
[0] >> 
EVENT_DEVID_SHIFT
Ë& 
EVENT_DEVID_MASK
;

168 
domid
 = (
evít
[1] >> 
EVENT_DOMID_SHIFT
Ë& 
EVENT_DOMID_MASK
;

169 
Êags
 = (
evít
[1] >> 
EVENT_FLAGS_SHIFT
Ë& 
EVENT_FLAGS_MASK
;

170 
u64
 
addªss
 = (u64)(((u64)
evít
[3]) << 32) |Évent[2];

172 
	`¥ötk
(
KERN_ERR
 "AMD-Vi: EventÜogged [");

174 
ty≥
) {

175 
EVENT_TYPE_ILL_DEV
:

176 
	`¥ötk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

178 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

179 
addªss
, 
Êags
);

180 
	`dump_dã_íåy
(
devid
);

182 
EVENT_TYPE_IO_FAULT
:

183 
	`¥ötk
("IO_PAGE_FAULT device=%02x:%02x.%x "

185 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

186 
domid
, 
addªss
, 
Êags
);

188 
EVENT_TYPE_DEV_TAB_ERR
:

189 
	`¥ötk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

191 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

192 
addªss
, 
Êags
);

194 
EVENT_TYPE_PAGE_TAB_ERR
:

195 
	`¥ötk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

197 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

198 
domid
, 
addªss
, 
Êags
);

200 
EVENT_TYPE_ILL_CMD
:

201 
	`¥ötk
("ILLEGAL_COMMAND_ERRORáddªss=0x%016Œx]\n", 
addªss
);

202 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

203 
	`dump_comm™d
(
addªss
);

205 
EVENT_TYPE_CMD_HARD_ERR
:

206 
	`¥ötk
("COMMAND_HARDWARE_ERRORáddress=0x%016llx "

207 "Êags=0x%04x]\n", 
addªss
, 
Êags
);

209 
EVENT_TYPE_IOTLB_INV_TO
:

210 
	`¥ötk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

212 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

213 
addªss
);

215 
EVENT_TYPE_INV_DEV_REQ
:

216 
	`¥ötk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

218 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

219 
addªss
, 
Êags
);

222 
	`¥ötk
(
KERN_ERR
 "UNKNOWNÅy≥=0x%02x]\n", 
ty≥
);

224 
	}
}

226 
	$iommu_pﬁl_evíts
(
amd_iommu
 *
iommu
)

228 
u32
 
hód
, 
èû
;

229 
Êags
;

231 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

233 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

234 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

236 
hód
 !
èû
) {

237 
	`iommu_¥öt_evít
(
iommu
, iommu->
evt_buf
 + 
hód
);

238 
hód
 = (hód + 
EVENT_ENTRY_SIZE
Ë% 
iommu
->
evt_buf_size
;

241 
	`wrôñ
(
hód
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

243 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

244 
	}
}

246 
úqªtu∫_t
 
	$amd_iommu_öt_h™dÀr
(
úq
, *
d©a
)

248 
amd_iommu
 *
iommu
;

250 
	`f‹_óch_iommu
(
iommu
)

251 
	`iommu_pﬁl_evíts
(
iommu
);

253  
IRQ_HANDLED
;

254 
	}
}

266 
	$__iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

268 
u32
 
èû
, 
hód
;

269 
u8
 *
èrgë
;

271 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

272 
èrgë
 = 
iommu
->
cmd_buf
 + 
èû
;

273 
	`mem˝y_toio
(
èrgë
, 
cmd
, (*cmd));

274 
èû
 = (èû + (*
cmd
)Ë% 
iommu
->
cmd_buf_size
;

275 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

276 i‡(
èû
 =
hód
)

277  -
ENOMEM
;

278 
	`wrôñ
(
èû
, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

281 
	}
}

287 
	$iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

289 
Êags
;

290 
ªt
;

292 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

293 
ªt
 = 
	`__iommu_queue_comm™d
(
iommu
, 
cmd
);

294 i‡(!
ªt
)

295 
iommu
->
√ed_sync
 = 
åue
;

296 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

298  
ªt
;

299 
	}
}

305 
	$__iommu_waô_f‹_com∂ëi⁄
(
amd_iommu
 *
iommu
)

307 
ªady
 = 0;

308 
°©us
 = 0;

309 
i
 = 0;

311 
	`INC_STATS_COUNTER
(
com∂_waô
);

313 !
ªady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

314 ++
i
;

316 
°©us
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

317 
ªady
 = 
°©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

321 
°©us
 &~
MMIO_STATUS_COM_WAIT_INT_MASK
;

322 
	`wrôñ
(
°©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

324 i‡(
	`u∆ikñy
(
i
 =
EXIT_LOOP_COUNT
)) {

325 
	`•ö_u∆ock
(&
iommu
->
lock
);

326 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

327 
	`•ö_lock
(&
iommu
->
lock
);

329 
	}
}

335 
	$__iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

337 
iommu_cmd
 
cmd
;

339 
	`mem£t
(&
cmd
, 0, (cmd));

340 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

341 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

343  
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

344 
	}
}

353 
	$iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

355 
ªt
 = 0;

356 
Êags
;

358 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

360 i‡(!
iommu
->
√ed_sync
)

361 
out
;

363 
ªt
 = 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

365 
iommu
->
√ed_sync
 = 
Ál£
;

367 i‡(
ªt
)

368 
out
;

370 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

372 
out
:

373 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

376 
	}
}

381 
	$iommu_queue_öv_dev_íåy
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

383 
iommu_cmd
 
cmd
;

384 
ªt
;

386 
	`BUG_ON
(
iommu
 =
NULL
);

388 
	`mem£t
(&
cmd
, 0, (cmd));

389 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

390 
cmd
.
d©a
[0] = 
devid
;

392 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

394  
ªt
;

395 
	}
}

397 
	$__iommu_buûd_öv_iommu_∑ges
(
iommu_cmd
 *
cmd
, 
u64
 
addªss
,

398 
u16
 
domid
, 
pde
, 
s
)

400 
	`mem£t
(
cmd
, 0, (*cmd));

401 
addªss
 &
PAGE_MASK
;

402 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

403 
cmd
->
d©a
[1] |
domid
;

404 
cmd
->
d©a
[2] = 
	`lowî_32_bôs
(
addªss
);

405 
cmd
->
d©a
[3] = 
	`uµî_32_bôs
(
addªss
);

406 i‡(
s
)

407 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

408 i‡(
pde
)

409 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_PDE_MASK
;

410 
	}
}

415 
	$iommu_queue_öv_iommu_∑ges
(
amd_iommu
 *
iommu
,

416 
u64
 
addªss
, 
u16
 
domid
, 
pde
, 
s
)

418 
iommu_cmd
 
cmd
;

419 
ªt
;

421 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
addªss
, 
domid
, 
pde
, 
s
);

423 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

425  
ªt
;

426 
	}
}

433 
	$iommu_Êush_∑ges
(
amd_iommu
 *
iommu
, 
u16
 
domid
,

434 
u64
 
addªss
, 
size_t
 
size
)

436 
s
 = 0;

437 
∑ges
 = 
	`iommu_num_∑ges
(
addªss
, 
size
, 
PAGE_SIZE
);

439 
addªss
 &
PAGE_MASK
;

441 i‡(
∑ges
 > 1) {

446 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

447 
s
 = 1;

450 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 0, 
s
);

453 
	}
}

456 
	$iommu_Êush_éb
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

458 
u64
 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

460 
	`INC_STATS_COUNTER
(
domaö_Êush_sögÀ
);

462 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 0, 1);

463 
	}
}

466 
	$iommu_Êush_éb_pde
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

468 
u64
 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

470 
	`INC_STATS_COUNTER
(
domaö_Êush_sögÀ
);

472 
	`iommu_queue_öv_iommu_∑ges
(
iommu
, 
addªss
, 
domid
, 1, 1);

473 
	}
}

478 
	$Êush_domaö_⁄_iommu
(
amd_iommu
 *
iommu
, 
u16
 
domid
)

480 
iommu_cmd
 
cmd
;

481 
Êags
;

483 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
,

484 
domid
, 1, 1);

486 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

487 
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

488 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

489 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

490 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

491 
	}
}

493 
	$Êush_Æl_domaös_⁄_iommu
(
amd_iommu
 *
iommu
)

495 
i
;

497 
i
 = 1; i < 
MAX_DOMAIN_ID
; ++i) {

498 i‡(!
	`ã°_bô
(
i
, 
amd_iommu_pd_Æloc_bôm≠
))

500 
	`Êush_domaö_⁄_iommu
(
iommu
, 
i
);

503 
	}
}

509 
	$iommu_Êush_domaö
(
u16
 
domid
)

511 
amd_iommu
 *
iommu
;

513 
	`INC_STATS_COUNTER
(
domaö_Êush_Æl
);

515 
	`f‹_óch_iommu
(
iommu
)

516 
	`Êush_domaö_⁄_iommu
(
iommu
, 
domid
);

517 
	}
}

519 
	$amd_iommu_Êush_Æl_domaös
()

521 
amd_iommu
 *
iommu
;

523 
	`f‹_óch_iommu
(
iommu
)

524 
	`Êush_Æl_domaös_⁄_iommu
(
iommu
);

525 
	}
}

527 
	$Êush_Æl_devi˚s_f‹_iommu
(
amd_iommu
 *
iommu
)

529 
i
;

531 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i) {

532 i‡(
iommu
 !
amd_iommu_æookup_èbÀ
[
i
])

535 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
i
);

536 
	`iommu_com∂ëi⁄_waô
(
iommu
);

538 
	}
}

540 
	$Êush_devi˚s_by_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

542 
amd_iommu
 *
iommu
;

543 
i
;

545 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i) {

546 i‡((
domaö
 =
NULL
 && 
amd_iommu_pd_èbÀ
[
i
] == NULL) ||

547 (
amd_iommu_pd_èbÀ
[
i
] !
domaö
))

550 
iommu
 = 
amd_iommu_æookup_èbÀ
[
i
];

551 i‡(!
iommu
)

554 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
i
);

555 
	`iommu_com∂ëi⁄_waô
(
iommu
);

557 
	}
}

559 
	$ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
)

561 
	`¥_îr
("AMD-Vi: Resetting IOMMU command buffer\n");

563 i‡(
iommu
->
ª£t_ö_¥ogªss
)

564 
	`∑nic
("AMD-Vi: ILLEGAL_COMMAND_ERROR whileÑesetting command buffer\n");

566 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

568 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

569 
	`Êush_Æl_devi˚s_f‹_iommu
(
iommu
);

570 
	`Êush_Æl_domaös_⁄_iommu
(
iommu
);

572 
iommu
->
ª£t_ö_¥ogªss
 = 
Ál£
;

573 
	}
}

575 
	$amd_iommu_Êush_Æl_devi˚s
()

577 
	`Êush_devi˚s_by_domaö
(
NULL
);

578 
	}
}

594 
	$iommu_m≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

595 
bus_addr
,

596 
phys_addr
,

597 
¥Ÿ
,

598 
m≠_size
)

600 
u64
 
__±e
, *
±e
;

602 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

603 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

605 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
bus_addr
));

606 
	`BUG_ON
(!
	`PM_ALIGNED
(
m≠_size
, 
phys_addr
));

608 i‡(!(
¥Ÿ
 & 
IOMMU_PROT_MASK
))

609  -
EINVAL
;

611 
±e
 = 
	`Æloc_±e
(
dom
, 
bus_addr
, 
m≠_size
, 
NULL
, 
GFP_KERNEL
);

613 i‡(
	`IOMMU_PTE_PRESENT
(*
±e
))

614  -
EBUSY
;

616 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
;

617 i‡(
¥Ÿ
 & 
IOMMU_PROT_IR
)

618 
__±e
 |
IOMMU_PTE_IR
;

619 i‡(
¥Ÿ
 & 
IOMMU_PROT_IW
)

620 
__±e
 |
IOMMU_PTE_IW
;

622 *
±e
 = 
__±e
;

624 
	`upd©e_domaö
(
dom
);

627 
	}
}

629 
	$iommu_unm≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

630 
bus_addr
, 
m≠_size
)

632 
u64
 *
±e
 = 
	`„tch_±e
(
dom
, 
bus_addr
, 
m≠_size
);

634 i‡(
±e
)

635 *
±e
 = 0;

636 
	}
}

642 
	$iommu_f‹_unôy_m≠
(
amd_iommu
 *
iommu
,

643 
unôy_m≠_íåy
 *
íåy
)

645 
u16
 
bdf
, 
i
;

647 
i
 = 
íåy
->
devid_°¨t
; i <íåy->
devid_íd
; ++i) {

648 
bdf
 = 
amd_iommu_Æüs_èbÀ
[
i
];

649 i‡(
amd_iommu_æookup_èbÀ
[
bdf
] =
iommu
)

654 
	}
}

662 
	$iommu_öô_unôy_m≠pögs
(
amd_iommu
 *
iommu
)

664 
unôy_m≠_íåy
 *
íåy
;

665 
ªt
;

667 
	`li°_f‹_óch_íåy
(
íåy
, &
amd_iommu_unôy_m≠
, 
li°
) {

668 i‡(!
	`iommu_f‹_unôy_m≠
(
iommu
, 
íåy
))

670 
ªt
 = 
	`dma_›s_unôy_m≠
(
iommu
->
deÁu…_dom
, 
íåy
);

671 i‡(
ªt
)

672  
ªt
;

676 
	}
}

682 
	$dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

683 
unôy_m≠_íåy
 *
e
)

685 
u64
 
addr
;

686 
ªt
;

688 
addr
 = 
e
->
addªss_°¨t
;ádd∏<É->
addªss_íd
;

689 
addr
 +
PAGE_SIZE
) {

690 
ªt
 = 
	`iommu_m≠_∑ge
(&
dma_dom
->
domaö
, 
addr
,áddr, 
e
->
¥Ÿ
,

691 
PM_MAP_4k
);

692 i‡(
ªt
)

693  
ªt
;

698 i‡(
addr
 < 
dma_dom
->
≠îtuª_size
)

699 
	`__£t_bô
(
addr
 >> 
PAGE_SHIFT
,

700 
dma_dom
->
≠îtuª
[0]->
bôm≠
);

704 
	}
}

709 
	$öô_unôy_m≠pögs_f‹_devi˚
(
dma_›s_domaö
 *
dma_dom
,

710 
u16
 
devid
)

712 
unôy_m≠_íåy
 *
e
;

713 
ªt
;

715 
	`li°_f‹_óch_íåy
(
e
, &
amd_iommu_unôy_m≠
, 
li°
) {

716 i‡(!(
devid
 >
e
->
devid_°¨t
 && devid <e->
devid_íd
))

718 
ªt
 = 
	`dma_›s_unôy_m≠
(
dma_dom
, 
e
);

719 i‡(
ªt
)

720  
ªt
;

724 
	}
}

746 
u64
 *
	$„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

747 
addªss
, 
m≠_size
)

749 
Àvñ
;

750 
u64
 *
±e
;

752 
Àvñ
 = 
domaö
->
mode
 - 1;

753 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

755 
Àvñ
 > 
m≠_size
) {

756 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

757  
NULL
;

759 
Àvñ
 -= 1;

761 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

762 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

764 i‡((
	`PM_PTE_LEVEL
(*
±e
Ë=0Ë&& 
Àvñ
 !
m≠_size
) {

765 
±e
 = 
NULL
;

770  
±e
;

771 
	}
}

778 
	$Æloc_√w_ønge
(
amd_iommu
 *
iommu
,

779 
dma_›s_domaö
 *
dma_dom
,

780 
boﬁ
 
p›uœã
, 
gÂ_t
 
gÂ
)

782 
ödex
 = 
dma_dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

783 
i
;

785 #ifde‡
CONFIG_IOMMU_STRESS


786 
p›uœã
 = 
Ál£
;

789 i‡(
ödex
 >
APERTURE_MAX_RANGES
)

790  -
ENOMEM
;

792 
dma_dom
->
≠îtuª
[
ödex
] = 
	`kzÆloc
((
≠îtuª_ønge
), 
gÂ
);

793 i‡(!
dma_dom
->
≠îtuª
[
ödex
])

794  -
ENOMEM
;

796 
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

797 i‡(!
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
)

798 
out_‰ì
;

800 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 = dma_dom->
≠îtuª_size
;

802 i‡(
p›uœã
) {

803 
addªss
 = 
dma_dom
->
≠îtuª_size
;

804 
i
, 
num_±es
 = 
APERTURE_RANGE_PAGES
 / 512;

805 
u64
 *
±e
, *
±e_∑ge
;

807 
i
 = 0; i < 
num_±es
; ++i) {

808 
±e
 = 
	`Æloc_±e
(&
dma_dom
->
domaö
, 
addªss
, 
PM_MAP_4k
,

809 &
±e_∑ge
, 
gÂ
);

810 i‡(!
±e
)

811 
out_‰ì
;

813 
dma_dom
->
≠îtuª
[
ödex
]->
±e_∑ges
[
i
] = 
±e_∑ge
;

815 
addªss
 +
APERTURE_RANGE_SIZE
 / 64;

819 
dma_dom
->
≠îtuª_size
 +
APERTURE_RANGE_SIZE
;

822 i‡(
iommu
->
ex˛usi⁄_°¨t
 &&

823 
iommu
->
ex˛usi⁄_°¨t
 >
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 &&

824 
iommu
->
ex˛usi⁄_°¨t
 < 
dma_dom
->
≠îtuª_size
) {

825 
°¨çage
 = 
iommu
->
ex˛usi⁄_°¨t
 >> 
PAGE_SHIFT
;

826 
∑ges
 = 
	`iommu_num_∑ges
(
iommu
->
ex˛usi⁄_°¨t
,

827 
iommu
->
ex˛usi⁄_Àngth
,

828 
PAGE_SIZE
);

829 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
°¨çage
, 
∑ges
);

838 
i
 = 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
;

839 
i
 < 
dma_dom
->
≠îtuª_size
;

840 
i
 +
PAGE_SIZE
) {

841 
u64
 *
±e
 = 
	`„tch_±e
(&
dma_dom
->
domaö
, 
i
, 
PM_MAP_4k
);

842 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

845 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
i
 << 
PAGE_SHIFT
, 1);

848 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

852 
out_‰ì
:

853 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

855 
	`‰ì_∑ge
(()
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
);

857 
	`k‰ì
(
dma_dom
->
≠îtuª
[
ödex
]);

858 
dma_dom
->
≠îtuª
[
ödex
] = 
NULL
;

860  -
ENOMEM
;

861 
	}
}

863 
	$dma_›s_¨ó_Æloc
(
devi˚
 *
dev
,

864 
dma_›s_domaö
 *
dom
,

865 
∑ges
,

866 
Æign_mask
,

867 
u64
 
dma_mask
,

868 
°¨t
)

870 
√xt_bô
 = 
dom
->
√xt_addªss
 % 
APERTURE_RANGE_SIZE
;

871 
max_ödex
 = 
dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

872 
i
 = 
°¨t
 >> 
APERTURE_RANGE_SHIFT
;

873 
bound¨y_size
;

874 
addªss
 = -1;

875 
limô
;

877 
√xt_bô
 >>
PAGE_SHIFT
;

879 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

880 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

882 ;
i
 < 
max_ödex
; ++i) {

883 
off£t
 = 
dom
->
≠îtuª
[
i
]->off£à>> 
PAGE_SHIFT
;

885 i‡(
dom
->
≠îtuª
[
i
]->
off£t
 >
dma_mask
)

888 
limô
 = 
	`iommu_devi˚_max_ödex
(
APERTURE_RANGE_PAGES
, 
off£t
,

889 
dma_mask
 >> 
PAGE_SHIFT
);

891 
addªss
 = 
	`iommu_¨ó_Æloc
(
dom
->
≠îtuª
[
i
]->
bôm≠
,

892 
limô
, 
√xt_bô
, 
∑ges
, 0,

893 
bound¨y_size
, 
Æign_mask
);

894 i‡(
addªss
 != -1) {

895 
addªss
 = 
dom
->
≠îtuª
[
i
]->
off£t
 +

896 (
addªss
 << 
PAGE_SHIFT
);

897 
dom
->
√xt_addªss
 = 
addªss
 + (
∑ges
 << 
PAGE_SHIFT
);

901 
√xt_bô
 = 0;

904  
addªss
;

905 
	}
}

907 
	$dma_›s_Æloc_addªs£s
(
devi˚
 *
dev
,

908 
dma_›s_domaö
 *
dom
,

909 
∑ges
,

910 
Æign_mask
,

911 
u64
 
dma_mask
)

913 
addªss
;

915 #ifde‡
CONFIG_IOMMU_STRESS


916 
dom
->
√xt_addªss
 = 0;

917 
dom
->
√ed_Êush
 = 
åue
;

920 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

921 
dma_mask
, 
dom
->
√xt_addªss
);

923 i‡(
addªss
 == -1) {

924 
dom
->
√xt_addªss
 = 0;

925 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

926 
dma_mask
, 0);

927 
dom
->
√ed_Êush
 = 
åue
;

930 i‡(
	`u∆ikñy
(
addªss
 == -1))

931 
addªss
 = 
bad_dma_addªss
;

933 
	`WARN_ON
((
addªss
 + (
PAGE_SIZE
*
∑ges
)Ë> 
dom
->
≠îtuª_size
);

935  
addªss
;

936 
	}
}

943 
	$dma_›s_‰ì_addªs£s
(
dma_›s_domaö
 *
dom
,

944 
addªss
,

945 
∑ges
)

947 
i
 = 
addªss
 >> 
APERTURE_RANGE_SHIFT
;

948 
≠îtuª_ønge
 *
ønge
 = 
dom
->
≠îtuª
[
i
];

950 
	`BUG_ON
(
i
 >
APERTURE_MAX_RANGES
 || 
ønge
 =
NULL
);

952 #ifde‡
CONFIG_IOMMU_STRESS


953 i‡(
i
 < 4)

957 i‡(
addªss
 >
dom
->
√xt_addªss
)

958 
dom
->
√ed_Êush
 = 
åue
;

960 
addªss
 = (addªs†% 
APERTURE_RANGE_SIZE
Ë>> 
PAGE_SHIFT
;

962 
	`iommu_¨ó_‰ì
(
ønge
->
bôm≠
, 
addªss
, 
∑ges
);

964 
	}
}

976 
u16
 
	$domaö_id_Æloc
()

978 
Êags
;

979 
id
;

981 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

982 
id
 = 
	`föd_fú°_zîo_bô
(
amd_iommu_pd_Æloc_bôm≠
, 
MAX_DOMAIN_ID
);

983 
	`BUG_ON
(
id
 == 0);

984 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

985 
	`__£t_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

987 
id
 = 0;

988 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

990  
id
;

991 
	}
}

993 
	$domaö_id_‰ì
(
id
)

995 
Êags
;

997 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

998 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

999 
	`__˛ór_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1000 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1001 
	}
}

1007 
	$dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

1008 
°¨t_∑ge
,

1009 
∑ges
)

1011 
i
, 
œ°_∑ge
 = 
dom
->
≠îtuª_size
 >> 
PAGE_SHIFT
;

1013 i‡(
°¨t_∑ge
 + 
∑ges
 > 
œ°_∑ge
)

1014 
∑ges
 = 
œ°_∑ge
 - 
°¨t_∑ge
;

1016 
i
 = 
°¨t_∑ge
; i < sèπ_∑gê+ 
∑ges
; ++i) {

1017 
ödex
 = 
i
 / 
APERTURE_RANGE_PAGES
;

1018 
∑ge
 = 
i
 % 
APERTURE_RANGE_PAGES
;

1019 
	`__£t_bô
(
∑ge
, 
dom
->
≠îtuª
[
ödex
]->
bôm≠
);

1021 
	}
}

1023 
	$‰ì_∑gëabÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1025 
i
, 
j
;

1026 
u64
 *
p1
, *
p2
, *
p3
;

1028 
p1
 = 
domaö
->
±_roŸ
;

1030 i‡(!
p1
)

1033 
i
 = 0; i < 512; ++i) {

1034 i‡(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

1037 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

1038 
j
 = 0; j < 512; ++j) {

1039 i‡(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

1041 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

1042 
	`‰ì_∑ge
(()
p3
);

1045 
	`‰ì_∑ge
(()
p2
);

1048 
	`‰ì_∑ge
(()
p1
);

1050 
domaö
->
±_roŸ
 = 
NULL
;

1051 
	}
}

1057 
	$dma_›s_domaö_‰ì
(
dma_›s_domaö
 *
dom
)

1059 
i
;

1061 i‡(!
dom
)

1064 
	`‰ì_∑gëabÀ
(&
dom
->
domaö
);

1066 
i
 = 0; i < 
APERTURE_MAX_RANGES
; ++i) {

1067 i‡(!
dom
->
≠îtuª
[
i
])

1069 
	`‰ì_∑ge
(()
dom
->
≠îtuª
[
i
]->
bôm≠
);

1070 
	`k‰ì
(
dom
->
≠îtuª
[
i
]);

1073 
	`k‰ì
(
dom
);

1074 
	}
}

1081 
dma_›s_domaö
 *
	$dma_›s_domaö_Æloc
(
amd_iommu
 *
iommu
)

1083 
dma_›s_domaö
 *
dma_dom
;

1085 
dma_dom
 = 
	`kzÆloc
((
dma_›s_domaö
), 
GFP_KERNEL
);

1086 i‡(!
dma_dom
)

1087  
NULL
;

1089 
	`•ö_lock_öô
(&
dma_dom
->
domaö
.
lock
);

1091 
dma_dom
->
domaö
.
id
 = 
	`domaö_id_Æloc
();

1092 i‡(
dma_dom
->
domaö
.
id
 == 0)

1093 
‰ì_dma_dom
;

1094 
dma_dom
->
domaö
.
mode
 = 
PAGE_MODE_2_LEVEL
;

1095 
dma_dom
->
domaö
.
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1096 
dma_dom
->
domaö
.
Êags
 = 
PD_DMA_OPS_MASK
;

1097 
dma_dom
->
domaö
.
¥iv
 = dma_dom;

1098 i‡(!
dma_dom
->
domaö
.
±_roŸ
)

1099 
‰ì_dma_dom
;

1101 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1102 
dma_dom
->
èrgë_dev
 = 0xffff;

1104 i‡(
	`Æloc_√w_ønge
(
iommu
, 
dma_dom
, 
åue
, 
GFP_KERNEL
))

1105 
‰ì_dma_dom
;

1111 
dma_dom
->
≠îtuª
[0]->
bôm≠
[0] = 1;

1112 
dma_dom
->
√xt_addªss
 = 0;

1115  
dma_dom
;

1117 
‰ì_dma_dom
:

1118 
	`dma_›s_domaö_‰ì
(
dma_dom
);

1120  
NULL
;

1121 
	}
}

1127 
boﬁ
 
	$dma_›s_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1129  
domaö
->
Êags
 & 
PD_DMA_OPS_MASK
;

1130 
	}
}

1136 
¥Ÿe˘i⁄_domaö
 *
	$domaö_f‹_devi˚
(
u16
 
devid
)

1138 
¥Ÿe˘i⁄_domaö
 *
dom
;

1139 
Êags
;

1141 
	`ªad_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1142 
dom
 = 
amd_iommu_pd_èbÀ
[
devid
];

1143 
	`ªad_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1145  
dom
;

1146 
	}
}

1148 
	$£t_dã_íåy
(
u16
 
devid
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1150 
u64
 
±e_roŸ
 = 
	`vút_to_phys
(
domaö
->
±_roŸ
);

1152 
±e_roŸ
 |(
domaö
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

1153 << 
DEV_ENTRY_MODE_SHIFT
;

1154 
±e_roŸ
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1156 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 
domaö
->
id
;

1157 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 
	`uµî_32_bôs
(
±e_roŸ
);

1158 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
	`lowî_32_bôs
(
±e_roŸ
);

1160 
amd_iommu_pd_èbÀ
[
devid
] = 
domaö
;

1161 
	}
}

1167 
	$__©èch_devi˚
(
amd_iommu
 *
iommu
,

1168 
¥Ÿe˘i⁄_domaö
 *
domaö
,

1169 
u16
 
devid
)

1172 
	`•ö_lock
(&
domaö
->
lock
);

1175 
	`£t_dã_íåy
(
devid
, 
domaö
);

1177 
domaö
->
dev_˙t
 += 1;

1180 
	`•ö_u∆ock
(&
domaö
->
lock
);

1181 
	}
}

1187 
	$©èch_devi˚
(
amd_iommu
 *
iommu
,

1188 
¥Ÿe˘i⁄_domaö
 *
domaö
,

1189 
u16
 
devid
)

1191 
Êags
;

1193 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1194 
	`__©èch_devi˚
(
iommu
, 
domaö
, 
devid
);

1195 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1202 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

1203 
	`iommu_Êush_éb_pde
(
iommu
, 
domaö
->
id
);

1204 
	}
}

1209 
	$__dëach_devi˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
, 
u16
 
devid
)

1213 
	`•ö_lock
(&
domaö
->
lock
);

1216 
amd_iommu_pd_èbÀ
[
devid
] = 
NULL
;

1219 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1220 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 0;

1221 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 0;

1223 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

1226 
domaö
->
dev_˙t
 -= 1;

1229 
	`•ö_u∆ock
(&
domaö
->
lock
);

1235 i‡(
iommu_∑ss_through
) {

1236 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1237 
	`__©èch_devi˚
(
iommu
, 
±_domaö
, 
devid
);

1239 
	}
}

1244 
	$dëach_devi˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
, 
u16
 
devid
)

1246 
Êags
;

1249 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1250 
	`__dëach_devi˚
(
domaö
, 
devid
);

1251 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1252 
	}
}

1254 
	$devi˚_ch™ge_nŸifõr
(
nŸifõr_block
 *
nb
,

1255 
a˘i⁄
, *
d©a
)

1257 
devi˚
 *
dev
 = 
d©a
;

1258 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

1259 
u16
 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

1260 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1261 
dma_›s_domaö
 *
dma_domaö
;

1262 
amd_iommu
 *
iommu
;

1263 
Êags
;

1265 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

1266 
out
;

1268 
devid
 = 
amd_iommu_Æüs_èbÀ
[devid];

1270 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1271 i‡(
iommu
 =
NULL
)

1272 
out
;

1274 
domaö
 = 
	`domaö_f‹_devi˚
(
devid
);

1276 i‡(
domaö
 && !
	`dma_›s_domaö
(domain))

1277 
	`WARN_ONCE
(1, "AMD IOMMU WARNING: device %sálready bound "

1278 "tÿ®n⁄-dma-›†domaö\n", 
	`dev_«me
(
dev
));

1280 
a˘i⁄
) {

1281 
BUS_NOTIFY_UNBOUND_DRIVER
:

1282 i‡(!
domaö
)

1283 
out
;

1284 i‡(
iommu_∑ss_through
)

1286 
	`dëach_devi˚
(
domaö
, 
devid
);

1288 
BUS_NOTIFY_ADD_DEVICE
:

1290 
dma_domaö
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1291 i‡(
dma_domaö
)

1292 
out
;

1293 
dma_domaö
 = 
	`dma_›s_domaö_Æloc
(
iommu
);

1294 i‡(!
dma_domaö
)

1295 
out
;

1296 
dma_domaö
->
èrgë_dev
 = 
devid
;

1298 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1299 
	`li°_add_èû
(&
dma_domaö
->
li°
, &
iommu_pd_li°
);

1300 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1304 
out
;

1307 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

1308 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1310 
out
:

1312 
	}
}

1314 
nŸifõr_block
 
	gdevi˚_nb
 = {

1315 .
nŸifõr_ˇŒ
 = 
devi˚_ch™ge_nŸifõr
,

1328 
boﬁ
 
	$check_devi˚
(
devi˚
 *
dev
)

1330 i‡(!
dev
 || !dev->
dma_mask
)

1331  
Ál£
;

1333  
åue
;

1334 
	}
}

1340 
dma_›s_domaö
 *
	$föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
)

1342 
dma_›s_domaö
 *
íåy
, *
ªt
 = 
NULL
;

1343 
Êags
;

1345 i‡(
	`li°_em±y
(&
iommu_pd_li°
))

1346  
NULL
;

1348 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1350 
	`li°_f‹_óch_íåy
(
íåy
, &
iommu_pd_li°
, 
li°
) {

1351 i‡(
íåy
->
èrgë_dev
 =
devid
) {

1352 
ªt
 = 
íåy
;

1357 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1359  
ªt
;

1360 
	}
}

1369 
	$gë_devi˚_ªsour˚s
(
devi˚
 *
dev
,

1370 
amd_iommu
 **
iommu
,

1371 
¥Ÿe˘i⁄_domaö
 **
domaö
,

1372 
u16
 *
bdf
)

1374 
dma_›s_domaö
 *
dma_dom
;

1375 
pci_dev
 *
pcidev
;

1376 
u16
 
_bdf
;

1378 *
iommu
 = 
NULL
;

1379 *
domaö
 = 
NULL
;

1380 *
bdf
 = 0xffff;

1382 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1385 
pcidev
 = 
	`to_pci_dev
(
dev
);

1386 
_bdf
 = 
	`ˇlc_devid
(
pcidev
->
bus
->
numbî
,Öcidev->
dev‚
);

1389 i‡(
_bdf
 > 
amd_iommu_œ°_bdf
)

1392 *
bdf
 = 
amd_iommu_Æüs_èbÀ
[
_bdf
];

1394 *
iommu
 = 
amd_iommu_æookup_èbÀ
[*
bdf
];

1395 i‡(*
iommu
 =
NULL
)

1397 *
domaö
 = 
	`domaö_f‹_devi˚
(*
bdf
);

1398 i‡(*
domaö
 =
NULL
) {

1399 
dma_dom
 = 
	`föd_¥Ÿe˘i⁄_domaö
(*
bdf
);

1400 i‡(!
dma_dom
)

1401 
dma_dom
 = (*
iommu
)->
deÁu…_dom
;

1402 *
domaö
 = &
dma_dom
->domain;

1403 
	`©èch_devi˚
(*
iommu
, *
domaö
, *
bdf
);

1404 
	`DUMP_¥ötk
("UsingÖrotection domain %d for device %s\n",

1405 (*
domaö
)->
id
, 
	`dev_«me
(
dev
));

1408 i‡(
	`domaö_f‹_devi˚
(
_bdf
Ë=
NULL
)

1409 
	`©èch_devi˚
(*
iommu
, *
domaö
, 
_bdf
);

1412 
	}
}

1414 
	$upd©e_devi˚_èbÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1416 
Êags
;

1417 
i
;

1419 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i) {

1420 i‡(
amd_iommu_pd_èbÀ
[
i
] !
domaö
)

1422 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1423 
	`£t_dã_íåy
(
i
, 
domaö
);

1424 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1426 
	}
}

1428 
	$upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1430 i‡(!
domaö
->
upd©ed
)

1433 
	`upd©e_devi˚_èbÀ
(
domaö
);

1434 
	`Êush_devi˚s_by_domaö
(
domaö
);

1435 
	`iommu_Êush_domaö
(
domaö
->
id
);

1437 
domaö
->
upd©ed
 = 
Ál£
;

1438 
	}
}

1445 
boﬁ
 
	$ö¸ó£_addªss_•a˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

1446 
gÂ_t
 
gÂ
)

1448 
u64
 *
±e
;

1450 i‡(
domaö
->
mode
 =
PAGE_MODE_6_LEVEL
)

1452  
Ál£
;

1454 
±e
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

1455 i‡(!
±e
)

1456  
Ál£
;

1458 *
±e
 = 
	`PM_LEVEL_PDE
(
domaö
->
mode
,

1459 
	`vút_to_phys
(
domaö
->
±_roŸ
));

1460 
domaö
->
±_roŸ
 = 
±e
;

1461 
domaö
->
mode
 += 1;

1462 
domaö
->
upd©ed
 = 
åue
;

1464  
åue
;

1465 
	}
}

1467 
u64
 *
	$Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

1468 
addªss
,

1469 
íd_lvl
,

1470 
u64
 **
±e_∑ge
,

1471 
gÂ_t
 
gÂ
)

1473 
u64
 *
±e
, *
∑ge
;

1474 
Àvñ
;

1476 
addªss
 > 
	`PM_LEVEL_SIZE
(
domaö
->
mode
))

1477 
	`ö¸ó£_addªss_•a˚
(
domaö
, 
gÂ
);

1479 
Àvñ
 = 
domaö
->
mode
 - 1;

1480 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

1482 
Àvñ
 > 
íd_lvl
) {

1483 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

1484 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

1485 i‡(!
∑ge
)

1486  
NULL
;

1487 *
±e
 = 
	`PM_LEVEL_PDE
(
Àvñ
, 
	`vút_to_phys
(
∑ge
));

1490 
Àvñ
 -= 1;

1492 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

1494 i‡(
±e_∑ge
 && 
Àvñ
 =
íd_lvl
)

1495 *
±e_∑ge
 = 
±e
;

1497 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

1500  
±e
;

1501 
	}
}

1506 
u64
* 
	$dma_›s_gë_±e
(
dma_›s_domaö
 *
dom
,

1507 
addªss
)

1509 
≠îtuª_ønge
 *
≠îtuª
;

1510 
u64
 *
±e
, *
±e_∑ge
;

1512 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1513 i‡(!
≠îtuª
)

1514  
NULL
;

1516 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1517 i‡(!
±e
) {

1518 
±e
 = 
	`Æloc_±e
(&
dom
->
domaö
, 
addªss
, 
PM_MAP_4k
, &
±e_∑ge
,

1519 
GFP_ATOMIC
);

1520 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)] = 
±e_∑ge
;

1522 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1524 
	`upd©e_domaö
(&
dom
->
domaö
);

1526  
±e
;

1527 
	}
}

1533 
dma_addr_t
 
	$dma_›s_domaö_m≠
(
amd_iommu
 *
iommu
,

1534 
dma_›s_domaö
 *
dom
,

1535 
addªss
,

1536 
phys_addr_t
 
∑ddr
,

1537 
dúe˘i⁄
)

1539 
u64
 *
±e
, 
__±e
;

1541 
	`WARN_ON
(
addªss
 > 
dom
->
≠îtuª_size
);

1543 
∑ddr
 &
PAGE_MASK
;

1545 
±e
 = 
	`dma_›s_gë_±e
(
dom
, 
addªss
);

1546 i‡(!
±e
)

1547  
bad_dma_addªss
;

1549 
__±e
 = 
∑ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1551 i‡(
dúe˘i⁄
 =
DMA_TO_DEVICE
)

1552 
__±e
 |
IOMMU_PTE_IR
;

1553 i‡(
dúe˘i⁄
 =
DMA_FROM_DEVICE
)

1554 
__±e
 |
IOMMU_PTE_IW
;

1555 i‡(
dúe˘i⁄
 =
DMA_BIDIRECTIONAL
)

1556 
__±e
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1558 
	`WARN_ON
(*
±e
);

1560 *
±e
 = 
__±e
;

1562  (
dma_addr_t
)
addªss
;

1563 
	}
}

1568 
	$dma_›s_domaö_unm≠
(
amd_iommu
 *
iommu
,

1569 
dma_›s_domaö
 *
dom
,

1570 
addªss
)

1572 
≠îtuª_ønge
 *
≠îtuª
;

1573 
u64
 *
±e
;

1575 i‡(
addªss
 >
dom
->
≠îtuª_size
)

1578 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1579 i‡(!
≠îtuª
)

1582 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1583 i‡(!
±e
)

1586 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1588 
	`WARN_ON
(!*
±e
);

1590 *
±e
 = 0ULL;

1591 
	}
}

1599 
dma_addr_t
 
	$__m≠_sögÀ
(
devi˚
 *
dev
,

1600 
amd_iommu
 *
iommu
,

1601 
dma_›s_domaö
 *
dma_dom
,

1602 
phys_addr_t
 
∑ddr
,

1603 
size_t
 
size
,

1604 
dú
,

1605 
boﬁ
 
Æign
,

1606 
u64
 
dma_mask
)

1608 
dma_addr_t
 
off£t
 = 
∑ddr
 & ~
PAGE_MASK
;

1609 
dma_addr_t
 
addªss
, 
°¨t
, 
ªt
;

1610 
∑ges
;

1611 
Æign_mask
 = 0;

1612 
i
;

1614 
∑ges
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

1615 
∑ddr
 &
PAGE_MASK
;

1617 
	`INC_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

1619 i‡(
∑ges
 > 1)

1620 
	`INC_STATS_COUNTER
(
¸oss_∑ge
);

1622 i‡(
Æign
)

1623 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

1625 
ªåy
:

1626 
addªss
 = 
	`dma_›s_Æloc_addªs£s
(
dev
, 
dma_dom
, 
∑ges
, 
Æign_mask
,

1627 
dma_mask
);

1628 i‡(
	`u∆ikñy
(
addªss
 =
bad_dma_addªss
)) {

1634 
dma_dom
->
√xt_addªss
 = dma_dom->
≠îtuª_size
;

1636 i‡(
	`Æloc_√w_ønge
(
iommu
, 
dma_dom
, 
Ál£
, 
GFP_ATOMIC
))

1637 
out
;

1643 
ªåy
;

1646 
°¨t
 = 
addªss
;

1647 
i
 = 0; i < 
∑ges
; ++i) {

1648 
ªt
 = 
	`dma_›s_domaö_m≠
(
iommu
, 
dma_dom
, 
°¨t
, 
∑ddr
, 
dú
);

1649 i‡(
ªt
 =
bad_dma_addªss
)

1650 
out_unm≠
;

1652 
∑ddr
 +
PAGE_SIZE
;

1653 
°¨t
 +
PAGE_SIZE
;

1655 
addªss
 +
off£t
;

1657 
	`ADD_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1659 i‡(
	`u∆ikñy
(
dma_dom
->
√ed_Êush
 && !
amd_iommu_unm≠_Êush
)) {

1660 
	`iommu_Êush_éb
(
iommu
, 
dma_dom
->
domaö
.
id
);

1661 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1662 } i‡(
	`u∆ikñy
(
	`iommu_has_≈ˇche
(
iommu
)))

1663 
	`iommu_Êush_∑ges
(
iommu
, 
dma_dom
->
domaö
.
id
, 
addªss
, 
size
);

1665 
out
:

1666  
addªss
;

1668 
out_unm≠
:

1670 --
i
; i >= 0; --i) {

1671 
°¨t
 -
PAGE_SIZE
;

1672 
	`dma_›s_domaö_unm≠
(
iommu
, 
dma_dom
, 
°¨t
);

1675 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
addªss
, 
∑ges
);

1677  
bad_dma_addªss
;

1678 
	}
}

1684 
	$__unm≠_sögÀ
(
amd_iommu
 *
iommu
,

1685 
dma_›s_domaö
 *
dma_dom
,

1686 
dma_addr_t
 
dma_addr
,

1687 
size_t
 
size
,

1688 
dú
)

1690 
dma_addr_t
 
i
, 
°¨t
;

1691 
∑ges
;

1693 i‡((
dma_addr
 =
bad_dma_addªss
) ||

1694 (
dma_addr
 + 
size
 > 
dma_dom
->
≠îtuª_size
))

1697 
∑ges
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1698 
dma_addr
 &
PAGE_MASK
;

1699 
°¨t
 = 
dma_addr
;

1701 
i
 = 0; i < 
∑ges
; ++i) {

1702 
	`dma_›s_domaö_unm≠
(
iommu
, 
dma_dom
, 
°¨t
);

1703 
°¨t
 +
PAGE_SIZE
;

1706 
	`SUB_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1708 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
dma_addr
, 
∑ges
);

1710 i‡(
amd_iommu_unm≠_Êush
 || 
dma_dom
->
√ed_Êush
) {

1711 
	`iommu_Êush_∑ges
(
iommu
, 
dma_dom
->
domaö
.
id
, 
dma_addr
, 
size
);

1712 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1714 
	}
}

1719 
dma_addr_t
 
	$m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

1720 
off£t
, 
size_t
 
size
,

1721 
dma_d©a_dúe˘i⁄
 
dú
,

1722 
dma_©ås
 *
©ås
)

1724 
Êags
;

1725 
amd_iommu
 *
iommu
;

1726 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1727 
u16
 
devid
;

1728 
dma_addr_t
 
addr
;

1729 
u64
 
dma_mask
;

1730 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

1732 
	`INC_STATS_COUNTER
(
˙t_m≠_sögÀ
);

1734 i‡(!
	`check_devi˚
(
dev
))

1735  
bad_dma_addªss
;

1737 
dma_mask
 = *
dev
->dma_mask;

1739 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1741 i‡(
iommu
 =
NULL
 || 
domaö
 == NULL)

1743  (
dma_addr_t
)
∑ddr
;

1745 i‡(!
	`dma_›s_domaö
(
domaö
))

1746  
bad_dma_addªss
;

1748 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1749 
addr
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
, 
∑ddr
, 
size
, 
dú
, 
Ál£
,

1750 
dma_mask
);

1751 i‡(
addr
 =
bad_dma_addªss
)

1752 
out
;

1754 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1756 
out
:

1757 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1759  
addr
;

1760 
	}
}

1765 
	$unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

1766 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

1768 
Êags
;

1769 
amd_iommu
 *
iommu
;

1770 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1771 
u16
 
devid
;

1773 
	`INC_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

1775 i‡(!
	`check_devi˚
(
dev
) ||

1776 !
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1780 i‡(!
	`dma_›s_domaö
(
domaö
))

1783 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1785 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
dma_addr
, 
size
, 
dú
);

1787 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1789 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1790 
	}
}

1796 
	$m≠_sg_no_iommu
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1797 
√Àms
, 
dú
)

1799 
sˇâîli°
 *
s
;

1800 
i
;

1802 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1803 
s
->
dma_addªss
 = (
dma_addr_t
)
	`sg_phys
(s);

1804 
s
->
dma_Àngth
 = s->
Àngth
;

1807  
√Àms
;

1808 
	}
}

1814 
	$m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1815 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1816 
dma_©ås
 *
©ås
)

1818 
Êags
;

1819 
amd_iommu
 *
iommu
;

1820 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1821 
u16
 
devid
;

1822 
i
;

1823 
sˇâîli°
 *
s
;

1824 
phys_addr_t
 
∑ddr
;

1825 
m≠≥d_ñems
 = 0;

1826 
u64
 
dma_mask
;

1828 
	`INC_STATS_COUNTER
(
˙t_m≠_sg
);

1830 i‡(!
	`check_devi˚
(
dev
))

1833 
dma_mask
 = *
dev
->dma_mask;

1835 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1837 i‡(!
iommu
 || !
domaö
)

1838  
	`m≠_sg_no_iommu
(
dev
, 
sgli°
, 
√Àms
, 
dú
);

1840 i‡(!
	`dma_›s_domaö
(
domaö
))

1843 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1845 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1846 
∑ddr
 = 
	`sg_phys
(
s
);

1848 
s
->
dma_addªss
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
,

1849 
∑ddr
, 
s
->
Àngth
, 
dú
, 
Ál£
,

1850 
dma_mask
);

1852 i‡(
s
->
dma_addªss
) {

1853 
s
->
dma_Àngth
 = s->
Àngth
;

1854 
m≠≥d_ñems
++;

1856 
unm≠
;

1859 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1861 
out
:

1862 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1864  
m≠≥d_ñems
;

1865 
unm≠
:

1866 
	`f‹_óch_sg
(
sgli°
, 
s
, 
m≠≥d_ñems
, 
i
) {

1867 i‡(
s
->
dma_addªss
)

1868 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
s
->
dma_addªss
,

1869 
s
->
dma_Àngth
, 
dú
);

1870 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

1873 
m≠≥d_ñems
 = 0;

1875 
out
;

1876 
	}
}

1882 
	$unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

1883 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

1884 
dma_©ås
 *
©ås
)

1886 
Êags
;

1887 
amd_iommu
 *
iommu
;

1888 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1889 
sˇâîli°
 *
s
;

1890 
u16
 
devid
;

1891 
i
;

1893 
	`INC_STATS_COUNTER
(
˙t_unm≠_sg
);

1895 i‡(!
	`check_devi˚
(
dev
) ||

1896 !
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1899 i‡(!
	`dma_›s_domaö
(
domaö
))

1902 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1904 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

1905 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
s
->
dma_addªss
,

1906 
s
->
dma_Àngth
, 
dú
);

1907 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

1910 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1912 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1913 
	}
}

1918 *
	$Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

1919 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

1921 
Êags
;

1922 *
vút_addr
;

1923 
amd_iommu
 *
iommu
;

1924 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1925 
u16
 
devid
;

1926 
phys_addr_t
 
∑ddr
;

1927 
u64
 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

1929 
	`INC_STATS_COUNTER
(
˙t_Æloc_cohîít
);

1931 i‡(!
	`check_devi˚
(
dev
))

1932  
NULL
;

1934 i‡(!
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
))

1935 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

1937 
Êag
 |
__GFP_ZERO
;

1938 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

1939 i‡(!
vút_addr
)

1940  
NULL
;

1942 
∑ddr
 = 
	`vút_to_phys
(
vút_addr
);

1944 i‡(!
iommu
 || !
domaö
) {

1945 *
dma_addr
 = (
dma_addr_t
)
∑ddr
;

1946  
vút_addr
;

1949 i‡(!
	`dma_›s_domaö
(
domaö
))

1950 
out_‰ì
;

1952 i‡(!
dma_mask
)

1953 
dma_mask
 = *
dev
->dma_mask;

1955 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1957 *
dma_addr
 = 
	`__m≠_sögÀ
(
dev
, 
iommu
, 
domaö
->
¥iv
, 
∑ddr
,

1958 
size
, 
DMA_BIDIRECTIONAL
, 
åue
, 
dma_mask
);

1960 i‡(*
dma_addr
 =
bad_dma_addªss
) {

1961 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1962 
out_‰ì
;

1965 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1967 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1969  
vút_addr
;

1971 
out_‰ì
:

1973 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

1975  
NULL
;

1976 
	}
}

1981 
	$‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

1982 *
vút_addr
, 
dma_addr_t
 
dma_addr
)

1984 
Êags
;

1985 
amd_iommu
 *
iommu
;

1986 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1987 
u16
 
devid
;

1989 
	`INC_STATS_COUNTER
(
˙t_‰ì_cohîít
);

1991 i‡(!
	`check_devi˚
(
dev
))

1994 
	`gë_devi˚_ªsour˚s
(
dev
, &
iommu
, &
domaö
, &
devid
);

1996 i‡(!
iommu
 || !
domaö
)

1997 
‰ì_mem
;

1999 i‡(!
	`dma_›s_domaö
(
domaö
))

2000 
‰ì_mem
;

2002 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2004 
	`__unm≠_sögÀ
(
iommu
, 
domaö
->
¥iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

2006 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2008 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2010 
‰ì_mem
:

2011 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2012 
	}
}

2018 
	$amd_iommu_dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

2020 
u16
 
bdf
;

2021 
pci_dev
 *
pcidev
;

2024 i‡(!
dev
 || dev->
bus
 !&
pci_bus_ty≥
)

2027 
pcidev
 = 
	`to_pci_dev
(
dev
);

2029 
bdf
 = 
	`ˇlc_devid
(
pcidev
->
bus
->
numbî
,Öcidev->
dev‚
);

2032 i‡(
bdf
 > 
amd_iommu_œ°_bdf
)

2036 
	}
}

2045 
	$¥óŒoc_¥Ÿe˘i⁄_domaös
()

2047 
pci_dev
 *
dev
 = 
NULL
;

2048 
dma_›s_domaö
 *
dma_dom
;

2049 
amd_iommu
 *
iommu
;

2050 
u16
 
devid
;

2052 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2053 
devid
 = 
	`ˇlc_devid
(
dev
->
bus
->
numbî
, dev->
dev‚
);

2054 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

2056 
devid
 = 
amd_iommu_Æüs_èbÀ
[devid];

2057 i‡(
	`domaö_f‹_devi˚
(
devid
))

2059 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2060 i‡(!
iommu
)

2062 
dma_dom
 = 
	`dma_›s_domaö_Æloc
(
iommu
);

2063 i‡(!
dma_dom
)

2065 
	`öô_unôy_m≠pögs_f‹_devi˚
(
dma_dom
, 
devid
);

2066 
dma_dom
->
èrgë_dev
 = 
devid
;

2068 
	`li°_add_èû
(&
dma_dom
->
li°
, &
iommu_pd_li°
);

2070 
	}
}

2072 
dma_m≠_›s
 
	gamd_iommu_dma_›s
 = {

2073 .
Æloc_cohîít
 =álloc_coherent,

2074 .
	g‰ì_cohîít
 = 
‰ì_cohîít
,

2075 .
	gm≠_∑ge
 = 
m≠_∑ge
,

2076 .
	gunm≠_∑ge
 = 
unm≠_∑ge
,

2077 .
	gm≠_sg
 = 
m≠_sg
,

2078 .
	gunm≠_sg
 = 
unm≠_sg
,

2079 .
	gdma_suµ‹ãd
 = 
amd_iommu_dma_suµ‹ãd
,

2085 
__öô
 
	$amd_iommu_öô_dma_›s
()

2087 
amd_iommu
 *
iommu
;

2088 
ªt
;

2095 
	`f‹_óch_iommu
(
iommu
) {

2096 
iommu
->
deÁu…_dom
 = 
	`dma_›s_domaö_Æloc
(iommu);

2097 i‡(
iommu
->
deÁu…_dom
 =
NULL
)

2098  -
ENOMEM
;

2099 
iommu
->
deÁu…_dom
->
domaö
.
Êags
 |
PD_DEFAULT_MASK
;

2100 
ªt
 = 
	`iommu_öô_unôy_m≠pögs
(
iommu
);

2101 i‡(
ªt
)

2102 
‰ì_domaös
;

2109 i‡(
amd_iommu_isﬁ©e
)

2110 
	`¥óŒoc_¥Ÿe˘i⁄_domaös
();

2112 
iommu_dëe˘ed
 = 1;

2113 
f‹˚_iommu
 = 1;

2114 
bad_dma_addªss
 = 0;

2115 #ifde‡
CONFIG_GART_IOMMU


2116 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

2117 
g¨t_iommu_≠îtuª
 = 0;

2121 
dma_›s
 = &
amd_iommu_dma_›s
;

2123 
	`ªgi°î_iommu
(&
amd_iommu_›s
);

2125 
	`bus_ªgi°î_nŸifõr
(&
pci_bus_ty≥
, &
devi˚_nb
);

2127 
	`amd_iommu_°©s_öô
();

2131 
‰ì_domaös
:

2133 
	`f‹_óch_iommu
(
iommu
) {

2134 i‡(
iommu
->
deÁu…_dom
)

2135 
	`dma_›s_domaö_‰ì
(
iommu
->
deÁu…_dom
);

2138  
ªt
;

2139 
	}
}

2151 
	$˛ónup_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2153 
Êags
;

2154 
u16
 
devid
;

2156 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2158 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid)

2159 i‡(
amd_iommu_pd_èbÀ
[
devid
] =
domaö
)

2160 
	`__dëach_devi˚
(
domaö
, 
devid
);

2162 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2163 
	}
}

2165 
	$¥Ÿe˘i⁄_domaö_‰ì
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2167 i‡(!
domaö
)

2170 i‡(
domaö
->
id
)

2171 
	`domaö_id_‰ì
(
domaö
->
id
);

2173 
	`k‰ì
(
domaö
);

2174 
	}
}

2176 
¥Ÿe˘i⁄_domaö
 *
	$¥Ÿe˘i⁄_domaö_Æloc
()

2178 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2180 
domaö
 = 
	`kzÆloc
((*domaö), 
GFP_KERNEL
);

2181 i‡(!
domaö
)

2182  
NULL
;

2184 
	`•ö_lock_öô
(&
domaö
->
lock
);

2185 
domaö
->
id
 = 
	`domaö_id_Æloc
();

2186 i‡(!
domaö
->
id
)

2187 
out_îr
;

2189  
domaö
;

2191 
out_îr
:

2192 
	`k‰ì
(
domaö
);

2194  
NULL
;

2195 
	}
}

2197 
	$amd_iommu_domaö_öô
(
iommu_domaö
 *
dom
)

2199 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2201 
domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2202 i‡(!
domaö
)

2203 
out_‰ì
;

2205 
domaö
->
mode
 = 
PAGE_MODE_3_LEVEL
;

2206 
domaö
->
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

2207 i‡(!
domaö
->
±_roŸ
)

2208 
out_‰ì
;

2210 
dom
->
¥iv
 = 
domaö
;

2214 
out_‰ì
:

2215 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2217  -
ENOMEM
;

2218 
	}
}

2220 
	$amd_iommu_domaö_de°roy
(
iommu_domaö
 *
dom
)

2222 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2224 i‡(!
domaö
)

2227 i‡(
domaö
->
dev_˙t
 > 0)

2228 
	`˛ónup_domaö
(
domaö
);

2230 
	`BUG_ON
(
domaö
->
dev_˙t
 != 0);

2232 
	`‰ì_∑gëabÀ
(
domaö
);

2234 
	`domaö_id_‰ì
(
domaö
->
id
);

2236 
	`k‰ì
(
domaö
);

2238 
dom
->
¥iv
 = 
NULL
;

2239 
	}
}

2241 
	$amd_iommu_dëach_devi˚
(
iommu_domaö
 *
dom
,

2242 
devi˚
 *
dev
)

2244 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2245 
amd_iommu
 *
iommu
;

2246 
pci_dev
 *
pdev
;

2247 
u16
 
devid
;

2249 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

2252 
pdev
 = 
	`to_pci_dev
(
dev
);

2254 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

2256 i‡(
devid
 > 0)

2257 
	`dëach_devi˚
(
domaö
, 
devid
);

2259 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2260 i‡(!
iommu
)

2263 
	`iommu_queue_öv_dev_íåy
(
iommu
, 
devid
);

2264 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2265 
	}
}

2267 
	$amd_iommu_©èch_devi˚
(
iommu_domaö
 *
dom
,

2268 
devi˚
 *
dev
)

2270 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2271 
¥Ÿe˘i⁄_domaö
 *
ﬁd_domaö
;

2272 
amd_iommu
 *
iommu
;

2273 
pci_dev
 *
pdev
;

2274 
u16
 
devid
;

2276 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

2277  -
EINVAL
;

2279 
pdev
 = 
	`to_pci_dev
(
dev
);

2281 
devid
 = 
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

2283 i‡(
devid
 >
amd_iommu_œ°_bdf
 ||

2284 
devid
 !
amd_iommu_Æüs_èbÀ
[devid])

2285  -
EINVAL
;

2287 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2288 i‡(!
iommu
)

2289  -
EINVAL
;

2291 
ﬁd_domaö
 = 
	`domaö_f‹_devi˚
(
devid
);

2292 i‡(
ﬁd_domaö
)

2293 
	`dëach_devi˚
(
ﬁd_domaö
, 
devid
);

2295 
	`©èch_devi˚
(
iommu
, 
domaö
, 
devid
);

2297 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2300 
	}
}

2302 
	$amd_iommu_m≠_ønge
(
iommu_domaö
 *
dom
,

2303 
iova
, 
phys_addr_t
 
∑ddr
,

2304 
size_t
 
size
, 
iommu_¥Ÿ
)

2306 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2307 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

2308 
¥Ÿ
 = 0;

2309 
ªt
;

2311 i‡(
iommu_¥Ÿ
 & 
IOMMU_READ
)

2312 
¥Ÿ
 |
IOMMU_PROT_IR
;

2313 i‡(
iommu_¥Ÿ
 & 
IOMMU_WRITE
)

2314 
¥Ÿ
 |
IOMMU_PROT_IW
;

2316 
iova
 &
PAGE_MASK
;

2317 
∑ddr
 &
PAGE_MASK
;

2319 
i
 = 0; i < 
≈ages
; ++i) {

2320 
ªt
 = 
	`iommu_m≠_∑ge
(
domaö
, 
iova
, 
∑ddr
, 
¥Ÿ
, 
PM_MAP_4k
);

2321 i‡(
ªt
)

2322  
ªt
;

2324 
iova
 +
PAGE_SIZE
;

2325 
∑ddr
 +
PAGE_SIZE
;

2329 
	}
}

2331 
	$amd_iommu_unm≠_ønge
(
iommu_domaö
 *
dom
,

2332 
iova
, 
size_t
 
size
)

2335 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2336 
i
, 
≈ages
 = 
	`iommu_num_∑ges
(
iova
, 
size
, 
PAGE_SIZE
);

2338 
iova
 &
PAGE_MASK
;

2340 
i
 = 0; i < 
≈ages
; ++i) {

2341 
	`iommu_unm≠_∑ge
(
domaö
, 
iova
, 
PM_MAP_4k
);

2342 
iova
 +
PAGE_SIZE
;

2345 
	`iommu_Êush_domaö
(
domaö
->
id
);

2346 
	}
}

2348 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaö
 *
dom
,

2349 
iova
)

2351 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2352 
off£t
 = 
iova
 & ~
PAGE_MASK
;

2353 
phys_addr_t
 
∑ddr
;

2354 
u64
 *
±e
;

2356 
±e
 = 
	`„tch_±e
(
domaö
, 
iova
, 
PM_MAP_4k
);

2358 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

2361 
∑ddr
 = *
±e
 & 
IOMMU_PAGE_MASK
;

2362 
∑ddr
 |
off£t
;

2364  
∑ddr
;

2365 
	}
}

2367 
	$amd_iommu_domaö_has_ˇp
(
iommu_domaö
 *
domaö
,

2368 
ˇp
)

2371 
	}
}

2373 
iommu_›s
 
	gamd_iommu_›s
 = {

2374 .
domaö_öô
 = 
amd_iommu_domaö_öô
,

2375 .
	gdomaö_de°roy
 = 
amd_iommu_domaö_de°roy
,

2376 .
	g©èch_dev
 = 
amd_iommu_©èch_devi˚
,

2377 .
	gdëach_dev
 = 
amd_iommu_dëach_devi˚
,

2378 .
	gm≠
 = 
amd_iommu_m≠_ønge
,

2379 .
	gunm≠
 = 
amd_iommu_unm≠_ønge
,

2380 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

2381 .
	gdomaö_has_ˇp
 = 
amd_iommu_domaö_has_ˇp
,

2394 
__öô
 
	$amd_iommu_öô_∑s°hrough
()

2396 
pci_dev
 *
dev
 = 
NULL
;

2397 
u16
 
devid
, 
devid2
;

2400 
±_domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2401 i‡(!
±_domaö
)

2402  -
ENOMEM
;

2404 
±_domaö
->
mode
 |
PAGE_MODE_NONE
;

2406 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2407 
amd_iommu
 *
iommu
;

2409 
devid
 = 
	`ˇlc_devid
(
dev
->
bus
->
numbî
, dev->
dev‚
);

2410 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

2413 
devid2
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

2415 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid2
];

2416 i‡(!
iommu
)

2419 
	`__©èch_devi˚
(
iommu
, 
±_domaö
, 
devid
);

2420 
	`__©èch_devi˚
(
iommu
, 
±_domaö
, 
devid2
);

2423 
	`¥_öfo
("AMD-Vi: Initialized for Passthrough Mode\n");

2426 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<löux/pci.h
>

21 
	~<löux/a˝i.h
>

22 
	~<löux/gÂ.h
>

23 
	~<löux/li°.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/msi.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/amd_iommu_ty≥s.h
>

29 
	~<asm/amd_iommu.h
>

30 
	~<asm/iommu.h
>

31 
	~<asm/g¨t.h
>

36 
	#IVRS_HEADER_LENGTH
 48

	)

38 
	#ACPI_IVHD_TYPE
 0x10

	)

39 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

40 
	#ACPI_IVMD_TYPE
 0x21

	)

41 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

43 
	#IVHD_DEV_ALL
 0x01

	)

44 
	#IVHD_DEV_SELECT
 0x02

	)

45 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

46 
	#IVHD_DEV_RANGE_END
 0x04

	)

47 
	#IVHD_DEV_ALIAS
 0x42

	)

48 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

49 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

50 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

52 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

53 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

54 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

55 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

57 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

58 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

60 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

61 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

62 
	#ACPI_DEVFLAG_NMI
 0x04

	)

63 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

64 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

65 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

66 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

67 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

80 
	sivhd_hódî
 {

81 
u8
 
	mty≥
;

82 
u8
 
	mÊags
;

83 
u16
 
	mÀngth
;

84 
u16
 
	mdevid
;

85 
u16
 
	mˇp_±r
;

86 
u64
 
	mmmio_phys
;

87 
u16
 
	mpci_£g
;

88 
u16
 
	möfo
;

89 
u32
 
	mª£rved
;

90 } 
__©åibuã__
((
∑cked
));

96 
	sivhd_íåy
 {

97 
u8
 
	mty≥
;

98 
u16
 
	mdevid
;

99 
u8
 
	mÊags
;

100 
u32
 
	mext
;

101 } 
__©åibuã__
((
∑cked
));

107 
	sivmd_hódî
 {

108 
u8
 
	mty≥
;

109 
u8
 
	mÊags
;

110 
u16
 
	mÀngth
;

111 
u16
 
	mdevid
;

112 
u16
 
	maux
;

113 
u64
 
	mªsv
;

114 
u64
 
	mønge_°¨t
;

115 
u64
 
	mønge_Àngth
;

116 } 
__©åibuã__
((
∑cked
));

118 
boﬁ
 
	gamd_iommu_dump
;

120 
__öôd©a
 
	gamd_iommu_dëe˘ed
;

122 
u16
 
	gamd_iommu_œ°_bdf
;

124 
LIST_HEAD
(
amd_iommu_unôy_m≠
);

126 #ifde‡
CONFIG_IOMMU_STRESS


127 
boﬁ
 
	gamd_iommu_isﬁ©e
 = 
Ál£
;

129 
boﬁ
 
	gamd_iommu_isﬁ©e
 = 
åue
;

133 
boﬁ
 
	gamd_iommu_unm≠_Êush
;

135 
LIST_HEAD
(
amd_iommu_li°
);

144 
dev_èbÀ_íåy
 *
	gamd_iommu_dev_èbÀ
;

151 
u16
 *
	gamd_iommu_Æüs_èbÀ
;

157 
amd_iommu
 **
	gamd_iommu_æookup_èbÀ
;

163 
¥Ÿe˘i⁄_domaö
 **
	gamd_iommu_pd_èbÀ
;

169 *
	gamd_iommu_pd_Æloc_bôm≠
;

171 
u32
 
	gdev_èbÀ_size
;

172 
u32
 
	gÆüs_èbÀ_size
;

173 
u32
 
	gæookup_èbÀ_size
;

175 
ölöe
 
	$upd©e_œ°_devid
(
u16
 
devid
)

177 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

178 
amd_iommu_œ°_bdf
 = 
devid
;

179 
	}
}

181 
ölöe
 
	$tbl_size
(
íåy_size
)

183 
shi·
 = 
PAGE_SHIFT
 +

184 
	`gë_‹dî
((()
amd_iommu_œ°_bdf
 + 1Ë* 
íåy_size
);

186  1UL << 
shi·
;

187 
	}
}

202 
	$iommu_£t_ex˛usi⁄_ønge
(
amd_iommu
 *
iommu
)

204 
u64
 
°¨t
 = 
iommu
->
ex˛usi⁄_°¨t
 & 
PAGE_MASK
;

205 
u64
 
limô
 = (
°¨t
 + 
iommu
->
ex˛usi⁄_Àngth
Ë& 
PAGE_MASK
;

206 
u64
 
íåy
;

208 i‡(!
iommu
->
ex˛usi⁄_°¨t
)

211 
íåy
 = 
°¨t
 | 
MMIO_EXCL_ENABLE_MASK
;

212 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

213 &
íåy
, (entry));

215 
íåy
 = 
limô
;

216 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

217 &
íåy
, (entry));

218 
	}
}

221 
__öô
 
	$iommu_£t_devi˚_èbÀ
(
amd_iommu
 *
iommu
)

223 
u64
 
íåy
;

225 
	`BUG_ON
(
iommu
->
mmio_ba£
 =
NULL
);

227 
íåy
 = 
	`vút_to_phys
(
amd_iommu_dev_èbÀ
);

228 
íåy
 |(
dev_èbÀ_size
 >> 12) - 1;

229 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

230 &
íåy
, (entry));

231 
	}
}

234 
	$iommu_„©uª_íabÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

236 
u32
 
˘æ
;

238 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

239 
˘æ
 |(1 << 
bô
);

240 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

241 
	}
}

243 
	$iommu_„©uª_dißbÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

245 
u32
 
˘æ
;

247 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

248 
˘æ
 &~(1 << 
bô
);

249 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

250 
	}
}

253 
	$iommu_íabÀ
(
amd_iommu
 *
iommu
)

255 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Enabling IOMMUát %s cap 0x%hx\n",

256 
	`dev_«me
(&
iommu
->
dev
->dev), iommu->
ˇp_±r
);

258 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

259 
	}
}

261 
	$iommu_dißbÀ
(
amd_iommu
 *
iommu
)

264 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

267 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

268 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

271 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

272 
	}
}

278 
u8
 * 
__öô
 
	$iommu_m≠_mmio_•a˚
(
u64
 
addªss
)

280 
u8
 *
ªt
;

282 i‡(!
	`ªque°_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
, "amd_iommu"))

283  
NULL
;

285 
ªt
 = 
	`i‹em≠_noˇche
(
addªss
, 
MMIO_REGION_LENGTH
);

286 i‡(
ªt
 !
NULL
)

287  
ªt
;

289 
	`ªÀa£_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
);

291  
NULL
;

292 
	}
}

294 
__öô
 
	$iommu_unm≠_mmio_•a˚
(
amd_iommu
 *
iommu
)

296 i‡(
iommu
->
mmio_ba£
)

297 
	`iounm≠
(
iommu
->
mmio_ba£
);

298 
	`ªÀa£_mem_ªgi⁄
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

299 
	}
}

313 
ölöe
 
	$ivhd_íåy_Àngth
(
u8
 *
ivhd
)

315  0x04 << (*
ivhd
 >> 6);

316 
	}
}

322 
__öô
 
	$föd_œ°_devid_⁄_pci
(
bus
, 
dev
, 
‚
, 
ˇp_±r
)

324 
u32
 
ˇp
;

326 
ˇp
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 
‚
, 
ˇp_±r
+
MMIO_RANGE_OFFSET
);

327 
	`upd©e_œ°_devid
(
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ˇp
), 
	`MMIO_GET_LD
(cap)));

330 
	}
}

336 
__öô
 
	$föd_œ°_devid_‰om_ivhd
(
ivhd_hódî
 *
h
)

338 
u8
 *
p
 = (*)
h
, *
íd
 = (*)h;

339 
ivhd_íåy
 *
dev
;

341 
p
 +(*
h
);

342 
íd
 +
h
->
Àngth
;

344 
	`föd_œ°_devid_⁄_pci
(
	`PCI_BUS
(
h
->
devid
),

345 
	`PCI_SLOT
(
h
->
devid
),

346 
	`PCI_FUNC
(
h
->
devid
),

347 
h
->
ˇp_±r
);

349 
p
 < 
íd
) {

350 
dev
 = (
ivhd_íåy
 *)
p
;

351 
dev
->
ty≥
) {

352 
IVHD_DEV_SELECT
:

353 
IVHD_DEV_RANGE_END
:

354 
IVHD_DEV_ALIAS
:

355 
IVHD_DEV_EXT_SELECT
:

357 
	`upd©e_œ°_devid
(
dev
->
devid
);

362 
p
 +
	`ivhd_íåy_Àngth
(p);

365 
	`WARN_ON
(
p
 !
íd
);

368 
	}
}

375 
__öô
 
	$föd_œ°_devid_a˝i
(
a˝i_èbÀ_hódî
 *
èbÀ
)

377 
i
;

378 
u8
 
checksum
 = 0, *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

379 
ivhd_hódî
 *
h
;

385 
i
 = 0; i < 
èbÀ
->
Àngth
; ++i)

386 
checksum
 +
p
[
i
];

387 i‡(
checksum
 != 0)

389  -
ENODEV
;

391 
p
 +
IVRS_HEADER_LENGTH
;

393 
íd
 +
èbÀ
->
Àngth
;

394 
p
 < 
íd
) {

395 
h
 = (
ivhd_hódî
 *)
p
;

396 
h
->
ty≥
) {

397 
ACPI_IVHD_TYPE
:

398 
	`föd_œ°_devid_‰om_ivhd
(
h
);

403 
p
 +
h
->
Àngth
;

405 
	`WARN_ON
(
p
 !
íd
);

408 
	}
}

424 
u8
 * 
__öô
 
	$Æloc_comm™d_buf„r
(
amd_iommu
 *
iommu
)

426 
u8
 *
cmd_buf
 = (u8 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

427 
	`gë_‹dî
(
CMD_BUFFER_SIZE
));

429 i‡(
cmd_buf
 =
NULL
)

430  
NULL
;

432 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
;

434  
cmd_buf
;

435 
	}
}

441 
	$amd_iommu_ª£t_cmd_buf„r
(
amd_iommu
 *
iommu
)

443 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

445 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

446 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

448 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

449 
	}
}

455 
	$iommu_íabÀ_comm™d_buf„r
(
amd_iommu
 *
iommu
)

457 
u64
 
íåy
;

459 
	`BUG_ON
(
iommu
->
cmd_buf
 =
NULL
);

461 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
cmd_buf
);

462 
íåy
 |
MMIO_CMD_SIZE_512
;

464 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

465 &
íåy
, (entry));

467 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

468 
	}
}

470 
__öô
 
	$‰ì_comm™d_buf„r
(
amd_iommu
 *
iommu
)

472 
	`‰ì_∑ges
(()
iommu
->
cmd_buf
,

473 
	`gë_‹dî
(
iommu
->
cmd_buf_size
));

474 
	}
}

477 
u8
 * 
__öô
 
	$Æloc_evít_buf„r
(
amd_iommu
 *
iommu
)

479 
iommu
->
evt_buf
 = (
u8
 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

480 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

482 i‡(
iommu
->
evt_buf
 =
NULL
)

483  
NULL
;

485 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

487  
iommu
->
evt_buf
;

488 
	}
}

490 
	$iommu_íabÀ_evít_buf„r
(
amd_iommu
 *
iommu
)

492 
u64
 
íåy
;

494 
	`BUG_ON
(
iommu
->
evt_buf
 =
NULL
);

496 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
evt_buf
Ë| 
EVT_LEN_MASK
;

498 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

499 &
íåy
, (entry));

502 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

503 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

505 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

506 
	}
}

508 
__öô
 
	$‰ì_evít_buf„r
(
amd_iommu
 *
iommu
)

510 
	`‰ì_∑ges
(()
iommu
->
evt_buf
, 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

511 
	}
}

514 
	$£t_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

516 
i
 = (
bô
 >> 5) & 0x07;

517 
_bô
 = 
bô
 & 0x1f;

519 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] |(1 << 
_bô
);

520 
	}
}

522 
	$gë_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

524 
i
 = (
bô
 >> 5) & 0x07;

525 
_bô
 = 
bô
 & 0x1f;

527  (
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] & (1 << 
_bô
)) >> _bit;

528 
	}
}

531 
	$amd_iommu_≠∂y_îøtum_63
(
u16
 
devid
)

533 
sysmgt
;

535 
sysmgt
 = 
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
) |

536 (
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
) << 1);

538 i‡(
sysmgt
 == 0x01)

539 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_IW
);

540 
	}
}

543 
__öô
 
	$£t_iommu_f‹_devi˚
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

545 
amd_iommu_æookup_èbÀ
[
devid
] = 
iommu
;

546 
	}
}

552 
__öô
 
	$£t_dev_íåy_‰om_a˝i
(
amd_iommu
 *
iommu
,

553 
u16
 
devid
, 
u32
 
Êags
, u32 
ext_Êags
)

555 i‡(
Êags
 & 
ACPI_DEVFLAG_INITPASS
)

556 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_INIT_PASS
);

557 i‡(
Êags
 & 
ACPI_DEVFLAG_EXTINT
)

558 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_EINT_PASS
);

559 i‡(
Êags
 & 
ACPI_DEVFLAG_NMI
)

560 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_NMI_PASS
);

561 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT1
)

562 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
);

563 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT2
)

564 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
);

565 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT0
)

566 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

567 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT1
)

568 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

570 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

572 
	`£t_iommu_f‹_devi˚
(
iommu
, 
devid
);

573 
	}
}

579 
__öô
 
	$£t_devi˚_ex˛usi⁄_ønge
(
u16
 
devid
, 
ivmd_hódî
 *
m
)

581 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

583 i‡(!(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
))

586 i‡(
iommu
) {

592 
	`£t_dev_íåy_bô
(
m
->
devid
, 
DEV_ENTRY_EX
);

593 
iommu
->
ex˛usi⁄_°¨t
 = 
m
->
ønge_°¨t
;

594 
iommu
->
ex˛usi⁄_Àngth
 = 
m
->
ønge_Àngth
;

596 
	}
}

603 
__öô
 
	$öô_iommu_‰om_pci
(
amd_iommu
 *
iommu
)

605 
ˇp_±r
 = 
iommu
->cap_ptr;

606 
u32
 
ønge
, 
misc
;

608 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

609 &
iommu
->
ˇp
);

610 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_RANGE_OFFSET
,

611 &
ønge
);

612 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_MISC_OFFSET
,

613 &
misc
);

615 
iommu
->
fú°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

616 
	`MMIO_GET_FD
(
ønge
));

617 
iommu
->
œ°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

618 
	`MMIO_GET_LD
(
ønge
));

619 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

620 
	}
}

626 
__öô
 
	$öô_iommu_‰om_a˝i
(
amd_iommu
 *
iommu
,

627 
ivhd_hódî
 *
h
)

629 
u8
 *
p
 = (u8 *)
h
;

630 
u8
 *
íd
 = 
p
, 
Êags
 = 0;

631 
u16
 
dev_i
, 
devid
 = 0, 
devid_°¨t
 = 0, 
devid_to
 = 0;

632 
u32
 
ext_Êags
 = 0;

633 
boﬁ
 
Æüs
 = 
Ál£
;

634 
ivhd_íåy
 *
e
;

640 
h
->
Êags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

641 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_HT_TUN_EN
) :

642 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_HT_TUN_EN
);

644 
h
->
Êags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

645 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_PASSPW_EN
) :

646 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_PASSPW_EN
);

648 
h
->
Êags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

649 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

650 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
);

652 
h
->
Êags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

653 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_ISOC_EN
) :

654 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_ISOC_EN
);

659 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_COHERENT_EN
);

664 
p
 +(
ivhd_hódî
);

665 
íd
 +
h
->
Àngth
;

668 
p
 < 
íd
) {

669 
e
 = (
ivhd_íåy
 *)
p
;

670 
e
->
ty≥
) {

671 
IVHD_DEV_ALL
:

673 
	`DUMP_¥ötk
(" DEV_ALL\t\t\t first devid: %02x:%02x.%x"

675 
	`PCI_BUS
(
iommu
->
fú°_devi˚
),

676 
	`PCI_SLOT
(
iommu
->
fú°_devi˚
),

677 
	`PCI_FUNC
(
iommu
->
fú°_devi˚
),

678 
	`PCI_BUS
(
iommu
->
œ°_devi˚
),

679 
	`PCI_SLOT
(
iommu
->
œ°_devi˚
),

680 
	`PCI_FUNC
(
iommu
->
œ°_devi˚
),

681 
e
->
Êags
);

683 
dev_i
 = 
iommu
->
fú°_devi˚
;

684 
dev_i
 <
iommu
->
œ°_devi˚
; ++dev_i)

685 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

686 
e
->
Êags
, 0);

688 
IVHD_DEV_SELECT
:

690 
	`DUMP_¥ötk
(" DEV_SELECT\t\t\t devid: %02x:%02x.%x "

692 
	`PCI_BUS
(
e
->
devid
),

693 
	`PCI_SLOT
(
e
->
devid
),

694 
	`PCI_FUNC
(
e
->
devid
),

695 
e
->
Êags
);

697 
devid
 = 
e
->devid;

698 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
, 0);

700 
IVHD_DEV_SELECT_RANGE_START
:

702 
	`DUMP_¥ötk
(" DEV_SELECT_RANGE_START\t "

704 
	`PCI_BUS
(
e
->
devid
),

705 
	`PCI_SLOT
(
e
->
devid
),

706 
	`PCI_FUNC
(
e
->
devid
),

707 
e
->
Êags
);

709 
devid_°¨t
 = 
e
->
devid
;

710 
Êags
 = 
e
->flags;

711 
ext_Êags
 = 0;

712 
Æüs
 = 
Ál£
;

714 
IVHD_DEV_ALIAS
:

716 
	`DUMP_¥ötk
(" DEV_ALIAS\t\t\t devid: %02x:%02x.%x "

718 
	`PCI_BUS
(
e
->
devid
),

719 
	`PCI_SLOT
(
e
->
devid
),

720 
	`PCI_FUNC
(
e
->
devid
),

721 
e
->
Êags
,

722 
	`PCI_BUS
(
e
->
ext
 >> 8),

723 
	`PCI_SLOT
(
e
->
ext
 >> 8),

724 
	`PCI_FUNC
(
e
->
ext
 >> 8));

726 
devid
 = 
e
->devid;

727 
devid_to
 = 
e
->
ext
 >> 8;

728 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
 , 
e
->
Êags
, 0);

729 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid_to
, 
e
->
Êags
, 0);

730 
amd_iommu_Æüs_èbÀ
[
devid
] = 
devid_to
;

732 
IVHD_DEV_ALIAS_RANGE
:

734 
	`DUMP_¥ötk
(" DEV_ALIAS_RANGE\t\t "

737 
	`PCI_BUS
(
e
->
devid
),

738 
	`PCI_SLOT
(
e
->
devid
),

739 
	`PCI_FUNC
(
e
->
devid
),

740 
e
->
Êags
,

741 
	`PCI_BUS
(
e
->
ext
 >> 8),

742 
	`PCI_SLOT
(
e
->
ext
 >> 8),

743 
	`PCI_FUNC
(
e
->
ext
 >> 8));

745 
devid_°¨t
 = 
e
->
devid
;

746 
Êags
 = 
e
->flags;

747 
devid_to
 = 
e
->
ext
 >> 8;

748 
ext_Êags
 = 0;

749 
Æüs
 = 
åue
;

751 
IVHD_DEV_EXT_SELECT
:

753 
	`DUMP_¥ötk
(" DEV_EXT_SELECT\t\t devid: %02x:%02x.%x "

755 
	`PCI_BUS
(
e
->
devid
),

756 
	`PCI_SLOT
(
e
->
devid
),

757 
	`PCI_FUNC
(
e
->
devid
),

758 
e
->
Êags
,É->
ext
);

760 
devid
 = 
e
->devid;

761 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
,

762 
e
->
ext
);

764 
IVHD_DEV_EXT_SELECT_RANGE
:

766 
	`DUMP_¥ötk
(" DEV_EXT_SELECT_RANGE\t devid: "

768 
	`PCI_BUS
(
e
->
devid
),

769 
	`PCI_SLOT
(
e
->
devid
),

770 
	`PCI_FUNC
(
e
->
devid
),

771 
e
->
Êags
,É->
ext
);

773 
devid_°¨t
 = 
e
->
devid
;

774 
Êags
 = 
e
->flags;

775 
ext_Êags
 = 
e
->
ext
;

776 
Æüs
 = 
Ál£
;

778 
IVHD_DEV_RANGE_END
:

780 
	`DUMP_¥ötk
(" DEV_RANGE_END\t\t devid: %02x:%02x.%x\n",

781 
	`PCI_BUS
(
e
->
devid
),

782 
	`PCI_SLOT
(
e
->
devid
),

783 
	`PCI_FUNC
(
e
->
devid
));

785 
devid
 = 
e
->devid;

786 
dev_i
 = 
devid_°¨t
; dev_ò<
devid
; ++dev_i) {

787 i‡(
Æüs
) {

788 
amd_iommu_Æüs_èbÀ
[
dev_i
] = 
devid_to
;

789 
	`£t_dev_íåy_‰om_a˝i
(
iommu
,

790 
devid_to
, 
Êags
, 
ext_Êags
);

792 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

793 
Êags
, 
ext_Êags
);

800 
p
 +
	`ivhd_íåy_Àngth
(p);

802 
	}
}

805 
__öô
 
	$öô_iommu_devi˚s
(
amd_iommu
 *
iommu
)

807 
u16
 
i
;

809 
i
 = 
iommu
->
fú°_devi˚
; i <iommu->
œ°_devi˚
; ++i)

810 
	`£t_iommu_f‹_devi˚
(
iommu
, 
i
);

813 
	}
}

815 
__öô
 
	$‰ì_iommu_⁄e
(
amd_iommu
 *
iommu
)

817 
	`‰ì_comm™d_buf„r
(
iommu
);

818 
	`‰ì_evít_buf„r
(
iommu
);

819 
	`iommu_unm≠_mmio_•a˚
(
iommu
);

820 
	}
}

822 
__öô
 
	$‰ì_iommu_Æl
()

824 
amd_iommu
 *
iommu
, *
√xt
;

826 
	`f‹_óch_iommu_ß„
(
iommu
, 
√xt
) {

827 
	`li°_dñ
(&
iommu
->
li°
);

828 
	`‰ì_iommu_⁄e
(
iommu
);

829 
	`k‰ì
(
iommu
);

831 
	}
}

838 
__öô
 
	$öô_iommu_⁄e
(
amd_iommu
 *
iommu
, 
ivhd_hódî
 *
h
)

840 
	`•ö_lock_öô
(&
iommu
->
lock
);

841 
	`li°_add_èû
(&
iommu
->
li°
, &
amd_iommu_li°
);

846 
iommu
->
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

847 i‡(!
iommu
->
dev
)

850 
iommu
->
ˇp_±r
 = 
h
->cap_ptr;

851 
iommu
->
pci_£g
 = 
h
->pci_seg;

852 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

853 
iommu
->
mmio_ba£
 = 
	`iommu_m≠_mmio_•a˚
(
h
->
mmio_phys
);

854 i‡(!
iommu
->
mmio_ba£
)

855  -
ENOMEM
;

857 
iommu
->
cmd_buf
 = 
	`Æloc_comm™d_buf„r
(iommu);

858 i‡(!
iommu
->
cmd_buf
)

859  -
ENOMEM
;

861 
iommu
->
evt_buf
 = 
	`Æloc_evít_buf„r
(iommu);

862 i‡(!
iommu
->
evt_buf
)

863  -
ENOMEM
;

865 
iommu
->
öt_íabÀd
 = 
Ál£
;

867 
	`öô_iommu_‰om_pci
(
iommu
);

868 
	`öô_iommu_‰om_a˝i
(
iommu
, 
h
);

869 
	`öô_iommu_devi˚s
(
iommu
);

871  
	`pci_íabÀ_devi˚
(
iommu
->
dev
);

872 
	}
}

878 
__öô
 
	$öô_iommu_Æl
(
a˝i_èbÀ_hódî
 *
èbÀ
)

880 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

881 
ivhd_hódî
 *
h
;

882 
amd_iommu
 *
iommu
;

883 
ªt
;

885 
íd
 +
èbÀ
->
Àngth
;

886 
p
 +
IVRS_HEADER_LENGTH
;

888 
p
 < 
íd
) {

889 
h
 = (
ivhd_hódî
 *)
p
;

890 *
p
) {

891 
ACPI_IVHD_TYPE
:

893 
	`DUMP_¥ötk
("device: %02x:%02x.%01x cap: %04x "

895 
	`PCI_BUS
(
h
->
devid
), 
	`PCI_SLOT
(h->devid),

896 
	`PCI_FUNC
(
h
->
devid
), h->
ˇp_±r
,

897 
h
->
pci_£g
, h->
Êags
, h->
öfo
);

898 
	`DUMP_¥ötk
(" mmio-addr: %016llx\n",

899 
h
->
mmio_phys
);

901 
iommu
 = 
	`kzÆloc
((
amd_iommu
), 
GFP_KERNEL
);

902 i‡(
iommu
 =
NULL
)

903  -
ENOMEM
;

904 
ªt
 = 
	`öô_iommu_⁄e
(
iommu
, 
h
);

905 i‡(
ªt
)

906  
ªt
;

911 
p
 +
h
->
Àngth
;

914 
	`WARN_ON
(
p
 !
íd
);

917 
	}
}

928 
__öô
 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

930 
r
;

932 i‡(
	`pci_íabÀ_msi
(
iommu
->
dev
))

935 
r
 = 
	`ªque°_úq
(
iommu
->
dev
->
úq
, 
amd_iommu_öt_h™dÀr
,

936 
IRQF_SAMPLE_RANDOM
,

938 
NULL
);

940 i‡(
r
) {

941 
	`pci_dißbÀ_msi
(
iommu
->
dev
);

945 
iommu
->
öt_íabÀd
 = 
åue
;

946 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

949 
	}
}

951 
	$iommu_öô_msi
(
amd_iommu
 *
iommu
)

953 i‡(
iommu
->
öt_íabÀd
)

956 i‡(
	`pci_föd_ˇ∑bûôy
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

957  
	`iommu_£tup_msi
(
iommu
);

960 
	}
}

970 
__öô
 
	$‰ì_unôy_m≠s
()

972 
unôy_m≠_íåy
 *
íåy
, *
√xt
;

974 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, &
amd_iommu_unôy_m≠
, 
li°
) {

975 
	`li°_dñ
(&
íåy
->
li°
);

976 
	`k‰ì
(
íåy
);

978 
	}
}

981 
__öô
 
	$öô_ex˛usi⁄_ønge
(
ivmd_hódî
 *
m
)

983 
i
;

985 
m
->
ty≥
) {

986 
ACPI_IVMD_TYPE
:

987 
	`£t_devi˚_ex˛usi⁄_ønge
(
m
->
devid
, m);

989 
ACPI_IVMD_TYPE_ALL
:

990 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

991 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

993 
ACPI_IVMD_TYPE_RANGE
:

994 
i
 = 
m
->
devid
; i <m->
aux
; ++i)

995 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1002 
	}
}

1005 
__öô
 
	$öô_unôy_m≠_ønge
(
ivmd_hódî
 *
m
)

1007 
unôy_m≠_íåy
 *
e
 = 0;

1008 *
s
;

1010 
e
 = 
	`kzÆloc
((*e), 
GFP_KERNEL
);

1011 i‡(
e
 =
NULL
)

1012  -
ENOMEM
;

1014 
m
->
ty≥
) {

1016 
	`k‰ì
(
e
);

1018 
ACPI_IVMD_TYPE
:

1019 
s
 = "IVMD_TYPEi\t\t\t";

1020 
e
->
devid_°¨t
 =É->
devid_íd
 = 
m
->
devid
;

1022 
ACPI_IVMD_TYPE_ALL
:

1023 
s
 = "IVMD_TYPE_ALL\t\t";

1024 
e
->
devid_°¨t
 = 0;

1025 
e
->
devid_íd
 = 
amd_iommu_œ°_bdf
;

1027 
ACPI_IVMD_TYPE_RANGE
:

1028 
s
 = "IVMD_TYPE_RANGE\t\t";

1029 
e
->
devid_°¨t
 = 
m
->
devid
;

1030 
e
->
devid_íd
 = 
m
->
aux
;

1033 
e
->
addªss_°¨t
 = 
	`PAGE_ALIGN
(
m
->
ønge_°¨t
);

1034 
e
->
addªss_íd
 =É->
addªss_°¨t
 + 
	`PAGE_ALIGN
(
m
->
ønge_Àngth
);

1035 
e
->
¥Ÿ
 = 
m
->
Êags
 >> 1;

1037 
	`DUMP_¥ötk
("%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x"

1038 "Ñ™ge_°¨t: %016ŒxÑ™ge_íd: %016Œx fœgs: %x\n", 
s
,

1039 
	`PCI_BUS
(
e
->
devid_°¨t
), 
	`PCI_SLOT
(e->devid_start),

1040 
	`PCI_FUNC
(
e
->
devid_°¨t
), 
	`PCI_BUS
”->
devid_íd
),

1041 
	`PCI_SLOT
(
e
->
devid_íd
), 
	`PCI_FUNC
(e->devid_end),

1042 
e
->
addªss_°¨t
,É->
addªss_íd
, 
m
->
Êags
);

1044 
	`li°_add_èû
(&
e
->
li°
, &
amd_iommu_unôy_m≠
);

1047 
	}
}

1050 
__öô
 
	$öô_mem‹y_deföôi⁄s
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1052 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

1053 
ivmd_hódî
 *
m
;

1055 
íd
 +
èbÀ
->
Àngth
;

1056 
p
 +
IVRS_HEADER_LENGTH
;

1058 
p
 < 
íd
) {

1059 
m
 = (
ivmd_hódî
 *)
p
;

1060 i‡(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
)

1061 
	`öô_ex˛usi⁄_ønge
(
m
);

1062 i‡(
m
->
Êags
 & 
IVMD_FLAG_UNITY_MAP
)

1063 
	`öô_unôy_m≠_ønge
(
m
);

1065 
p
 +
m
->
Àngth
;

1069 
	}
}

1075 
	$öô_devi˚_èbÀ
()

1077 
u16
 
devid
;

1079 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid) {

1080 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_VALID
);

1081 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_TRANSLATION
);

1083 
	}
}

1089 
	$íabÀ_iommus
()

1091 
amd_iommu
 *
iommu
;

1093 
	`f‹_óch_iommu
(
iommu
) {

1094 
	`iommu_dißbÀ
(
iommu
);

1095 
	`iommu_£t_devi˚_èbÀ
(
iommu
);

1096 
	`iommu_íabÀ_comm™d_buf„r
(
iommu
);

1097 
	`iommu_íabÀ_evít_buf„r
(
iommu
);

1098 
	`iommu_£t_ex˛usi⁄_ønge
(
iommu
);

1099 
	`iommu_öô_msi
(
iommu
);

1100 
	`iommu_íabÀ
(
iommu
);

1102 
	}
}

1104 
	$dißbÀ_iommus
()

1106 
amd_iommu
 *
iommu
;

1108 
	`f‹_óch_iommu
(
iommu
)

1109 
	`iommu_dißbÀ
(
iommu
);

1110 
	}
}

1117 
	$amd_iommu_ªsume
(
sys_devi˚
 *
dev
)

1120 
	`íabÀ_iommus
();

1126 
	`amd_iommu_Êush_Æl_devi˚s
();

1127 
	`amd_iommu_Êush_Æl_domaös
();

1130 
	}
}

1132 
	$amd_iommu_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1135 
	`dißbÀ_iommus
();

1138 
	}
}

1140 
sysdev_˛ass
 
	gamd_iommu_sysdev_˛ass
 = {

1141 .
«me
 = "amd_iommu",

1142 .
	gsu•íd
 = 
amd_iommu_su•íd
,

1143 .
	gªsume
 = 
amd_iommu_ªsume
,

1146 
sys_devi˚
 
	gdevi˚_amd_iommu
 = {

1147 .
id
 = 0,

1148 .
	g˛s
 = &
amd_iommu_sysdev_˛ass
,

1179 
__öô
 
	$amd_iommu_öô
()

1181 
i
, 
ªt
 = 0;

1184 i‡(
no_iommu
) {

1185 
	`¥ötk
(
KERN_INFO
 "AMD-Vi disabled by kernel commandÜine\n");

1189 i‡(!
amd_iommu_dëe˘ed
)

1190  -
ENODEV
;

1197 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
föd_œ°_devid_a˝i
) != 0)

1198  -
ENODEV
;

1200 
dev_èbÀ_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1201 
Æüs_èbÀ_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1202 
æookup_èbÀ_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1204 
ªt
 = -
ENOMEM
;

1207 
amd_iommu_dev_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1208 
	`gë_‹dî
(
dev_èbÀ_size
));

1209 i‡(
amd_iommu_dev_èbÀ
 =
NULL
)

1210 
out
;

1216 
amd_iommu_Æüs_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1217 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1218 i‡(
amd_iommu_Æüs_èbÀ
 =
NULL
)

1219 
‰ì
;

1222 
amd_iommu_æookup_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(

1223 
GFP_KERNEL
 | 
__GFP_ZERO
,

1224 
	`gë_‹dî
(
æookup_èbÀ_size
));

1225 i‡(
amd_iommu_æookup_èbÀ
 =
NULL
)

1226 
‰ì
;

1232 
amd_iommu_pd_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1233 
	`gë_‹dî
(
æookup_èbÀ_size
));

1234 i‡(
amd_iommu_pd_èbÀ
 =
NULL
)

1235 
‰ì
;

1237 
amd_iommu_pd_Æloc_bôm≠
 = (*)
	`__gë_‰ì_∑ges
(

1238 
GFP_KERNEL
 | 
__GFP_ZERO
,

1239 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1240 i‡(
amd_iommu_pd_Æloc_bôm≠
 =
NULL
)

1241 
‰ì
;

1244 
	`öô_devi˚_èbÀ
();

1249 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1250 
amd_iommu_Æüs_èbÀ
[
i
] = i;

1256 
amd_iommu_pd_Æloc_bôm≠
[0] = 1;

1262 
ªt
 = -
ENODEV
;

1263 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_iommu_Æl
) != 0)

1264 
‰ì
;

1266 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_mem‹y_deföôi⁄s
) != 0)

1267 
‰ì
;

1269 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
amd_iommu_sysdev_˛ass
);

1270 i‡(
ªt
)

1271 
‰ì
;

1273 
ªt
 = 
	`sysdev_ªgi°î
(&
devi˚_amd_iommu
);

1274 i‡(
ªt
)

1275 
‰ì
;

1277 i‡(
iommu_∑ss_through
)

1278 
ªt
 = 
	`amd_iommu_öô_∑s°hrough
();

1280 
ªt
 = 
	`amd_iommu_öô_dma_›s
();

1281 i‡(
ªt
)

1282 
‰ì
;

1284 
	`íabÀ_iommus
();

1286 i‡(
iommu_∑ss_through
)

1287 
out
;

1289 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: device isolation ");

1290 i‡(
amd_iommu_isﬁ©e
)

1291 
	`¥ötk
("enabled\n");

1293 
	`¥ötk
("disabled\n");

1295 i‡(
amd_iommu_unm≠_Êush
)

1296 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: IO/TLB flush on unmapÉnabled\n");

1298 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Lazy IO/TLB flushingÉnabled\n");

1300 
out
:

1301  
ªt
;

1303 
‰ì
:

1304 
	`‰ì_∑ges
(()
amd_iommu_pd_Æloc_bôm≠
,

1305 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1307 
	`‰ì_∑ges
(()
amd_iommu_pd_èbÀ
,

1308 
	`gë_‹dî
(
æookup_èbÀ_size
));

1310 
	`‰ì_∑ges
(()
amd_iommu_æookup_èbÀ
,

1311 
	`gë_‹dî
(
æookup_èbÀ_size
));

1313 
	`‰ì_∑ges
(()
amd_iommu_Æüs_èbÀ
,

1314 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1316 
	`‰ì_∑ges
(()
amd_iommu_dev_èbÀ
,

1317 
	`gë_‹dî
(
dev_èbÀ_size
));

1319 
	`‰ì_iommu_Æl
();

1321 
	`‰ì_unôy_m≠s
();

1323 
out
;

1324 
	}
}

1326 
	$amd_iommu_shutdown
()

1328 
	`dißbÀ_iommus
();

1329 
	}
}

1338 
__öô
 
	$óæy_amd_iommu_dëe˘
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1341 
	}
}

1343 
__öô
 
	$amd_iommu_dëe˘
()

1345 i‡(
swiŸlb
 || 
no_iommu
 || (
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
))

1348 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
óæy_amd_iommu_dëe˘
) == 0) {

1349 
iommu_dëe˘ed
 = 1;

1350 
amd_iommu_dëe˘ed
 = 1;

1351 #ifde‡
CONFIG_GART_IOMMU


1352 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

1353 
g¨t_iommu_≠îtuª
 = 0;

1356 
	}
}

1365 
__öô
 
	$∑r£_amd_iommu_dump
(*
°r
)

1367 
amd_iommu_dump
 = 
åue
;

1370 
	}
}

1372 
__öô
 
	$∑r£_amd_iommu_›ti⁄s
(*
°r
)

1374 ; *
°r
; ++str) {

1375 i‡(
	`°∫cmp
(
°r
, "isolate", 7) == 0)

1376 
amd_iommu_isﬁ©e
 = 
åue
;

1377 i‡(
	`°∫cmp
(
°r
, "share", 5) == 0)

1378 
amd_iommu_isﬁ©e
 = 
Ál£
;

1379 i‡(
	`°∫cmp
(
°r
, "fullflush", 9) == 0)

1380 
amd_iommu_unm≠_Êush
 = 
åue
;

1384 
	}
}

1386 
__£tup
("amd_iommu_dump", 
∑r£_amd_iommu_dump
);

1387 
__£tup
("amd_iommu=", 
∑r£_amd_iommu_›ti⁄s
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/boŸmem.h
>

17 
	~<löux/mmz⁄e.h
>

18 
	~<löux/pci_ids.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/su•íd.h
>

23 
	~<löux/kmemÀak.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/io.h
>

26 
	~<asm/iommu.h
>

27 
	~<asm/g¨t.h
>

28 
	~<asm/pci-dúe˘.h
>

29 
	~<asm/dma.h
>

30 
	~<asm/k8.h
>

32 
	gg¨t_iommu_≠îtuª
;

33 
g¨t_iommu_≠îtuª_dißbÀd
 
	g__öôd©a
;

34 
g¨t_iommu_≠îtuª_Ælowed
 
	g__öôd©a
;

36 
ÁŒback_≠î_‹dî
 
	g__öôd©a
 = 1;

37 
ÁŒback_≠î_f‹˚
 
	g__öôd©a
;

39 
fix_≠îtuª
 
	g__öôd©a
 = 1;

41 
	sbus_dev_ønge
 {

42 
	mbus
;

43 
	mdev_ba£
;

44 
	mdev_limô
;

47 
bus_dev_ønge
 
	gbus_dev_ønges
[] 
	g__öôd©a
 = {

53 
ªsour˚
 
	gg¨t_ªsour˚
 = {

54 .
«me
 = "GART",

55 .
	gÊags
 = 
IORESOURCE_MEM
,

58 
__öô
 
	$ö£π_≠îtuª_ªsour˚
(
u32
 
≠î_ba£
, u32 
≠î_size
)

60 
g¨t_ªsour˚
.
°¨t
 = 
≠î_ba£
;

61 
g¨t_ªsour˚
.
íd
 = 
≠î_ba£
 + 
≠î_size
 - 1;

62 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
g¨t_ªsour˚
);

63 
	}
}

68 
u32
 
__öô
 
	$Æloˇã_≠îtuª
()

70 
u32
 
≠î_size
;

71 *
p
;

74 i‡(
ÁŒback_≠î_‹dî
 > 5)

75 
ÁŒback_≠î_‹dî
 = 5;

76 
≠î_size
 = (32 * 1024 * 1024Ë<< 
ÁŒback_≠î_‹dî
;

97 
p
 = 
	`__Æloc_boŸmem_n›™ic
(
≠î_size
,áper_size, 512ULL<<20);

102 
	`kmemÀak_ign‹e
(
p
);

103 i‡(!
p
 || 
	`__∑
’)+
≠î_size
 > 0xffffffff) {

104 
	`¥ötk
(
KERN_ERR


106 
p
, 
≠î_size
>>10);

107 i‡(
p
)

108 
	`‰ì_boŸmem
(
	`__∑
(
p
), 
≠î_size
);

111 
	`¥ötk
(
KERN_INFO
 "Mappingáperture over %d KB of RAM @ %lx\n",

112 
≠î_size
 >> 10, 
	`__∑
(
p
));

113 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
	`__∑
(
p
), 
≠î_size
);

114 
	`ªgi°î_noßve_ªgi⁄
((
u32
)
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

115 (
u32
)
	`__∑
(
p
+
≠î_size
Ë>> 
PAGE_SHIFT
);

117  (
u32
)
	`__∑
(
p
);

118 
	}
}

122 
u32
 
__öô
 
	$föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
)

124 
byãs
;

125 
u8
 
pos
;

127 i‡(!(
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

128 
PCI_STATUS_CAP_LIST
))

131 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

132 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

133 
u8
 
id
;

135 
pos
 &= ~3;

136 
id
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

137 i‡(
id
 == 0xff)

139 i‡(
id
 =
ˇp
)

140  
pos
;

141 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

142 
pos
+
PCI_CAP_LIST_NEXT
);

145 
	}
}

148 
u32
 
__öô
 
	$ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
, 
u32
 *
‹dî
)

150 
u32
 
≠size
;

151 
u32
 
≠sizîeg
;

152 
nbôs
;

153 
u32
 
≠î_low
, 
≠î_hi
;

154 
u64
 
≠î
;

155 
u32
 
ﬁd_‹dî
;

157 
	`¥ötk
(
KERN_INFO
 "AGP bridgê© %02x:%02x:%02x\n", 
bus
, 
¶Ÿ
, 
func
);

158 
≠sizîeg
 = 
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
 + 0x14);

159 i‡(
≠sizîeg
 == 0xffffffff) {

160 
	`¥ötk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

165 
ﬁd_‹dî
 = *
‹dî
;

167 
≠size
 = 
≠sizîeg
 & 0xfff;

169 i‡(
≠size
 & 0xff)

170 
≠size
 |= 0xf00;

171 
nbôs
 = 
	`hweight16
(
≠size
);

172 *
‹dî
 = 7 - 
nbôs
;

173 i‡(()*
‹dî
 < 0)

174 *
‹dî
 = 0;

176 
≠î_low
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x10);

177 
≠î_hi
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x14);

178 
≠î
 = (
≠î_low
 & ~((1<<22)-1)Ë| ((
u64
)
≠î_hi
 << 32);

184 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

185 
≠î
, 32 << 
ﬁd_‹dî
);

186 i‡(
≠î
 + (32ULL<<(20 + *
‹dî
)) > 0x100000000ULL) {

187 
	`¥ötk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) isÇotÑight, using settings from NB\n",

188 32 << *
‹dî
, 
≠sizîeg
);

189 *
‹dî
 = 
ﬁd_‹dî
;

192 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

193 
≠î
, 32 << *
‹dî
, 
≠sizîeg
);

195 i‡(!
	`≠îtuª_vÆid
(
≠î
, (32*1024*1024Ë<< *
‹dî
, 32<<20))

197  (
u32
)
≠î
;

198 
	}
}

213 
u32
 
__öô
 
	$£¨ch_agp_bridge
(
u32
 *
‹dî
, *
vÆid_agp
)

215 
bus
, 
¶Ÿ
, 
func
;

218 
bus
 = 0; bus < 256; bus++) {

219 
¶Ÿ
 = 0; slot < 32; slot++) {

220 
func
 = 0; func < 8; func++) {

221 
u32
 
˛ass
, 
ˇp
;

222 
u8
 
ty≥
;

223 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
,

224 
PCI_CLASS_REVISION
);

225 i‡(
˛ass
 == 0xffffffff)

228 
˛ass
 >> 16) {

229 
PCI_CLASS_BRIDGE_HOST
:

230 
PCI_CLASS_BRIDGE_OTHER
:

232 
ˇp
 = 
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
,

233 
PCI_CAP_ID_AGP
);

234 i‡(!
ˇp
)

236 *
vÆid_agp
 = 1;

237  
	`ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
,

238 
‹dî
);

242 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

243 
PCI_HEADER_TYPE
);

244 i‡(!(
ty≥
 & 0x80))

249 
	`¥ötk
(
KERN_INFO
 "No AGP bridge found\n");

252 
	}
}

254 
g¨t_fix_e820
 
	g__öôd©a
 = 1;

256 
__öô
 
	$∑r£_g¨t_mem
(*
p
)

258 i‡(!
p
)

259  -
EINVAL
;

261 i‡(!
	`°∫cmp
(
p
, "off", 3))

262 
g¨t_fix_e820
 = 0;

263 i‡(!
	`°∫cmp
(
p
, "on", 2))

264 
g¨t_fix_e820
 = 1;

267 
	}
}

268 
óæy_∑øm
("g¨t_fix_e820", 
∑r£_g¨t_mem
);

270 
__öô
 
	$óæy_g¨t_iommu_check
()

282 
i
, 
fix
, 
¶Ÿ
;

283 
u32
 
˘l
;

284 
u32
 
≠î_size
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

285 
u64
 
≠î_ba£
 = 0, 
œ°_≠î_ba£
 = 0;

286 
≠î_íabÀd
 = 0, 
œ°_≠î_íabÀd
 = 0, 
œ°_vÆid
 = 0;

288 i‡(!
	`óæy_pci_Ælowed
())

292 
fix
 = 0;

293 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

294 
bus
;

295 
dev_ba£
, 
dev_limô
;

297 
bus
 = 
bus_dev_ønges
[
i
].bus;

298 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

299 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

301 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

302 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

305 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

306 
≠î_íabÀd
 = 
˘l
 & 
AMD64_GARTEN
;

307 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

308 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

309 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

310 
≠î_ba£
 <<= 25;

312 i‡(
œ°_vÆid
) {

313 i‡((
≠î_‹dî
 !
œ°_≠î_‹dî
) ||

314 (
≠î_ba£
 !
œ°_≠î_ba£
) ||

315 (
≠î_íabÀd
 !
œ°_≠î_íabÀd
)) {

316 
fix
 = 1;

321 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

322 
œ°_≠î_ba£
 = 
≠î_ba£
;

323 
œ°_≠î_íabÀd
 = 
≠î_íabÀd
;

324 
œ°_vÆid
 = 1;

328 i‡(!
fix
 && !
≠î_íabÀd
)

331 i‡(!
≠î_ba£
 || !
≠î_size
 ||áper_base +áper_size > 0x100000000UL)

332 
fix
 = 1;

334 i‡(
g¨t_fix_e820
 && !
fix
 && 
≠î_íabÀd
) {

335 i‡(
	`e820_™y_m≠≥d
(
≠î_ba£
,á≥r_ba£ + 
≠î_size
,

336 
E820_RAM
)) {

338 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for GART\n");

339 
	`e820_add_ªgi⁄
(
≠î_ba£
, 
≠î_size
, 
E820_RESERVED
);

340 
	`upd©e_e820
();

344 i‡(!
fix
)

348 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

349 
bus
;

350 
dev_ba£
, 
dev_limô
;

352 
bus
 = 
bus_dev_ønges
[
i
].bus;

353 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

354 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

356 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

357 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

360 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

361 
˘l
 &~
AMD64_GARTEN
;

362 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

366 
	}
}

368 
__öôd©a
 
	g¥öãd_g¨t_size_msg
;

370 
__öô
 
	$g¨t_iommu_hﬁe_öô
()

372 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

373 
u32
 
≠î_size
, 
≠î_Æloc
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

374 
u64
 
≠î_ba£
, 
œ°_≠î_ba£
 = 0;

375 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

376 
i
, 
node
;

378 i‡(
g¨t_iommu_≠îtuª_dißbÀd
 || !
fix_≠îtuª
 ||

379 !
	`óæy_pci_Ælowed
())

382 
	`¥ötk
(
KERN_INFO
 "Checkingáperture...\n");

384 i‡(!
ÁŒback_≠î_f‹˚
)

385 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

387 
fix
 = 0;

388 
node
 = 0;

389 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

390 
bus
;

391 
dev_ba£
, 
dev_limô
;

393 
bus
 = 
bus_dev_ønges
[
i
].bus;

394 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

395 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

397 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

398 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

401 
iommu_dëe˘ed
 = 1;

402 
g¨t_iommu_≠îtuª
 = 1;

404 
≠î_‹dî
 = (
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
) >> 1) & 7;

405 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

406 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

407 
≠î_ba£
 <<= 25;

409 
	`¥ötk
(
KERN_INFO
 "Node %d:áperture @ %Lx size %u MB\n",

410 
node
, 
≠î_ba£
, 
≠î_size
 >> 20);

411 
node
++;

413 i‡(!
	`≠îtuª_vÆid
(
≠î_ba£
, 
≠î_size
, 64<<20)) {

414 i‡(
vÆid_agp
 && 
agp_≠î_ba£
 &&

415 
agp_≠î_ba£
 =
≠î_ba£
 &&

416 
agp_≠î_‹dî
 =
≠î_‹dî
) {

418 i‡(!
no_iommu
 &&

419 
max_p‚
 > 
MAX_DMA32_PFN
 &&

420 !
¥öãd_g¨t_size_msg
) {

421 
	`¥ötk
(
KERN_ERR
 "youáre using iommu withágp, but GART size isÜessÅhan 64M\n");

422 
	`¥ötk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

423 
	`¥ötk
(
KERN_ERR
 "if BIOS doesn't haveÅhat option, contact your HW vendor!\n");

424 
¥öãd_g¨t_size_msg
 = 1;

427 
fix
 = 1;

428 
out
;

432 i‡((
œ°_≠î_‹dî
 && 
≠î_‹dî
 !=Üast_aper_order) ||

433 (
œ°_≠î_ba£
 && 
≠î_ba£
 !=Üast_aper_base)) {

434 
fix
 = 1;

435 
out
;

437 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

438 
œ°_≠î_ba£
 = 
≠î_ba£
;

442 
out
:

443 i‡(!
fix
 && !
ÁŒback_≠î_f‹˚
) {

444 i‡(
œ°_≠î_ba£
) {

445 
n
 = (32 * 1024 * 1024Ë<< 
œ°_≠î_‹dî
;

447 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
œ°_≠î_ba£
, 
n
);

452 i‡(!
ÁŒback_≠î_f‹˚
) {

453 
≠î_Æloc
 = 
agp_≠î_ba£
;

454 
≠î_‹dî
 = 
agp_≠î_‹dî
;

457 i‡(
≠î_Æloc
) {

459 } i‡(
swiŸlb
 && !
vÆid_agp
) {

461 } i‡((!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

462 
f‹˚_iommu
 ||

463 
vÆid_agp
 ||

464 
ÁŒback_≠î_f‹˚
) {

465 
	`¥ötk
(
KERN_INFO


467 
	`¥ötk
(
KERN_INFO


469 
	`¥ötk
(
KERN_INFO


471 32 << 
ÁŒback_≠î_‹dî
);

473 
≠î_‹dî
 = 
ÁŒback_≠î_‹dî
;

474 
≠î_Æloc
 = 
	`Æloˇã_≠îtuª
();

475 i‡(!
≠î_Æloc
) {

484 
	`∑nic
("NotÉnough memory foráperture");

491 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

492 
bus
;

493 
dev_ba£
, 
dev_limô
;

495 
bus
 = 
bus_dev_ønges
[
i
].bus;

496 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

497 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

498 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

499 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

505 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
≠î_‹dî
 << 1);

506 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
, 
≠î_Æloc
 >> 25);

510 
	`£t_up_g¨t_ªsume
(
≠î_‹dî
, 
≠î_Æloc
);

511 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<löux/≥rf_evít.h
>

18 
	~<löux/kî√l_°©.h
>

19 
	~<löux/mc146818πc.h
>

20 
	~<löux/a˝i_pmtmr.h
>

21 
	~<löux/˛ockchùs.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/·ø˚.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/moduÀ.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/dñay.h
>

29 
	~<löux/timex.h
>

30 
	~<löux/dm¨.h
>

31 
	~<löux/öô.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/dmi.h
>

34 
	~<löux/nmi.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/≥rf_evít.h
>

39 
	~<asm/x86_öô.h
>

40 
	~<asm/pgÆloc.h
>

41 
	~<asm/©omic.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/i8253.h
>

44 
	~<asm/i8259.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/≠ic.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/h≥t.h
>

49 
	~<asm/idÀ.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/smp.h
>

52 
	~<asm/m˚.h
>

53 
	~<asm/kvm_∑ø.h
>

55 
	gnum_¥o˚ss‹s
;

57 
dißbÀd_˝us
 
	g__˝uöôd©a
;

60 
	gboŸ_˝u_physiˇl_≠icid
 = -1U;

71 
	gmax_physiˇl_≠icid
;

76 
physid_mask_t
 
	gphys_˝u_¥e£¡_m≠
;

81 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_˝u_to_≠icid
, 
BAD_APICID
);

82 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_˝u_≠icid
, 
BAD_APICID
);

83 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_≠icid
);

84 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_˝u_≠icid
);

86 #ifde‡
CONFIG_X86_32


92 
	gf‹˚_íabÀ_loˇl_≠ic
;

96 
__öô
 
	$∑r£_œpic
(*
¨g
)

98 
f‹˚_íabÀ_loˇl_≠ic
 = 1;

100 
	}
}

101 
óæy_∑øm
("œpic", 
∑r£_œpic
);

103 
	gíabÀd_vü_≠icba£
;

113 
ölöe
 
	$im¸_pic_to_≠ic
()

116 
	`outb
(0x70, 0x22);

118 
	`outb
(0x01, 0x23);

119 
	}
}

121 
ölöe
 
	$im¸_≠ic_to_pic
()

124 
	`outb
(0x70, 0x22);

126 
	`outb
(0x00, 0x23);

127 
	}
}

130 #ifde‡
CONFIG_X86_64


131 
≠ic_ˇlibøã_pmtmr
 
	g__öôd©a
;

132 
__öô
 
	$£tup_≠i˝mtimî
(*
s
)

134 
≠ic_ˇlibøã_pmtmr
 = 1;

135 
	`nŸsc_£tup
(
NULL
);

137 
	}
}

138 
__£tup
("≠i˝mtimî", 
£tup_≠i˝mtimî
);

141 
	gx2≠ic_mode
;

142 #ifde‡
CONFIG_X86_X2APIC


144 
	gx2≠ic_¥ì«bÀd
;

145 
__öô
 
	$£tup_nox2≠ic
(*
°r
)

147 i‡(
	`x2≠ic_íabÀd
()) {

148 
	`¥_w¨nög
("BiosálreadyÉnabled x2apic, "

153 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_X2APIC
);

155 
	}
}

156 
óæy_∑øm
("nox2≠ic", 
£tup_nox2≠ic
);

159 
	gmp_œpic_addr
;

160 
	gdißbÀ_≠ic
;

162 
dißbÀ_≠ic_timî
 
	g__˝uöôd©a
;

164 
	gloˇl_≠ic_timî_c2_ok
;

165 
EXPORT_SYMBOL_GPL
(
loˇl_≠ic_timî_c2_ok
);

167 
	gfú°_sy°em_ve˘‹
 = 0xfe;

172 
	g≠ic_vîbosôy
;

174 
	gpic_mode
;

177 
	gsmp_found_c⁄fig
;

179 
ªsour˚
 
	gœpic_ªsour˚
 = {

180 .
«me
 = "Local APIC",

181 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

184 
	gˇlibøti⁄_ªsu…
;

186 
œpic_√xt_evít
(
dñè
,

187 
˛ock_evít_devi˚
 *
evt
);

188 
œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

189 
˛ock_evít_devi˚
 *
evt
);

190 
œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
);

191 
≠ic_pm_a˘iv©e
();

196 
˛ock_evít_devi˚
 
	gœpic_˛ockevít
 = {

197 .
«me
 = "lapic",

198 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


199 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

200 .
	gshi·
 = 32,

201 .
	g£t_mode
 = 
œpic_timî_£tup
,

202 .
	g£t_√xt_evít
 = 
œpic_√xt_evít
,

203 .
	gbrﬂdˇ°
 = 
œpic_timî_brﬂdˇ°
,

204 .
	gøtög
 = 100,

205 .
	gúq
 = -1,

207 
DEFINE_PER_CPU
(
˛ock_evít_devi˚
, 
œpic_evíts
);

209 
	g≠ic_phys
;

214 
ölöe
 
	$œpic_gë_vîsi⁄
()

216  
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

217 
	}
}

222 
ölöe
 
	$œpic_is_öãgøãd
()

224 #ifde‡
CONFIG_X86_64


227  
	`APIC_INTEGRATED
(
	`œpic_gë_vîsi⁄
());

229 
	}
}

234 
	$modîn_≠ic
()

237 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
 &&

238 
boŸ_˝u_d©a
.
x86
 >= 0xf)

240  
	`œpic_gë_vîsi⁄
() >= 0x14;

241 
	}
}

247 
	$«tive_≠ic_wrôe_dummy
(
u32
 
ªg
, u32 
v
)

249 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 || !
dißbÀ_≠ic
));

250 
	}
}

252 
u32
 
	$«tive_≠ic_ªad_dummy
(
u32
 
ªg
)

254 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 && !
dißbÀ_≠ic
));

256 
	}
}

262 
	$≠ic_dißbÀ
()

264 
≠ic
->
ªad
 = 
«tive_≠ic_ªad_dummy
;

265 
≠ic
->
wrôe
 = 
«tive_≠ic_wrôe_dummy
;

266 
	}
}

268 
	$«tive_≠ic_waô_i¸_idÀ
()

270 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
)

271 
	`˝u_ªœx
();

272 
	}
}

274 
u32
 
	$«tive_ß„_≠ic_waô_i¸_idÀ
()

276 
u32
 
£nd_°©us
;

277 
timeout
;

279 
timeout
 = 0;

281 
£nd_°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
;

282 i‡(!
£nd_°©us
)

284 
	`udñay
(100);

285 } 
timeout
++ < 1000);

287  
£nd_°©us
;

288 
	}
}

290 
	$«tive_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
)

292 
	`≠ic_wrôe
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

293 
	`≠ic_wrôe
(
APIC_ICR
, 
low
);

294 
	}
}

296 
u64
 
	$«tive_≠ic_i¸_ªad
()

298 
u32
 
i¸1
, 
i¸2
;

300 
i¸2
 = 
	`≠ic_ªad
(
APIC_ICR2
);

301 
i¸1
 = 
	`≠ic_ªad
(
APIC_ICR
);

303  
i¸1
 | ((
u64
)
i¸2
 << 32);

304 
	}
}

309 
__˝uöô
 
	$íabÀ_NMI_through_LVT0
()

311 
v
;

314 
v
 = 
APIC_DM_NMI
;

317 i‡(!
	`œpic_is_öãgøãd
())

318 
v
 |
APIC_LVT_LEVEL_TRIGGER
;

320 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
);

321 
	}
}

323 #ifde‡
CONFIG_X86_32


327 
	$gë_physiˇl_brﬂdˇ°
()

329  
	`modîn_≠ic
() ? 0xff : 0xf;

330 
	}
}

336 
	$œpic_gë_maxlvt
()

338 
v
;

340 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

345  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)Ë? 
	`GET_APIC_MAXLVT
(v) : 2;

346 
	}
}

353 
	#APIC_DIVISOR
 16

	)

365 
	$__£tup_APIC_LVTT
(
˛ocks
, 
⁄eshŸ
, 
úqí
)

367 
lvâ_vÆue
, 
tmp_vÆue
;

369 
lvâ_vÆue
 = 
LOCAL_TIMER_VECTOR
;

370 i‡(!
⁄eshŸ
)

371 
lvâ_vÆue
 |
APIC_LVT_TIMER_PERIODIC
;

372 i‡(!
	`œpic_is_öãgøãd
())

373 
lvâ_vÆue
 |
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

375 i‡(!
úqí
)

376 
lvâ_vÆue
 |
APIC_LVT_MASKED
;

378 
	`≠ic_wrôe
(
APIC_LVTT
, 
lvâ_vÆue
);

383 
tmp_vÆue
 = 
	`≠ic_ªad
(
APIC_TDCR
);

384 
	`≠ic_wrôe
(
APIC_TDCR
,

385 (
tmp_vÆue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

386 
APIC_TDR_DIV_16
);

388 i‡(!
⁄eshŸ
)

389 
	`≠ic_wrôe
(
APIC_TMICT
, 
˛ocks
 / 
APIC_DIVISOR
);

390 
	}
}

402 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

403 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

405 
	$£tup_APIC_eûvt
(
u8
 
lvt_off
, u8 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

407 
ªg
 = (
lvt_off
 << 4Ë+ 
	`APIC_EILVTn
(0);

408 
v
 = (
mask
 << 16Ë| (
msg_ty≥
 << 8Ë| 
ve˘‹
;

410 
	`≠ic_wrôe
(
ªg
, 
v
);

411 
	}
}

413 
u8
 
	$£tup_APIC_eûvt_m˚
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

415 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_MCE
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

416  
APIC_EILVT_LVTOFF_MCE
;

417 
	}
}

419 
u8
 
	$£tup_APIC_eûvt_ibs
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

421 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_IBS
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

422  
APIC_EILVT_LVTOFF_IBS
;

423 
	}
}

424 
EXPORT_SYMBOL_GPL
(
£tup_APIC_eûvt_ibs
);

429 
	$œpic_√xt_evít
(
dñè
,

430 
˛ock_evít_devi˚
 *
evt
)

432 
	`≠ic_wrôe
(
APIC_TMICT
, 
dñè
);

434 
	}
}

439 
	$œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

440 
˛ock_evít_devi˚
 *
evt
)

442 
Êags
;

443 
v
;

446 i‡(
evt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
)

449 
	`loˇl_úq_ßve
(
Êags
);

451 
mode
) {

452 
CLOCK_EVT_MODE_PERIODIC
:

453 
CLOCK_EVT_MODE_ONESHOT
:

454 
	`__£tup_APIC_LVTT
(
ˇlibøti⁄_ªsu…
,

455 
mode
 !
CLOCK_EVT_MODE_PERIODIC
, 1);

457 
CLOCK_EVT_MODE_UNUSED
:

458 
CLOCK_EVT_MODE_SHUTDOWN
:

459 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

460 
v
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

461 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
);

462 
	`≠ic_wrôe
(
APIC_TMICT
, 0xffffffff);

464 
CLOCK_EVT_MODE_RESUME
:

469 
	`loˇl_úq_ª°‹e
(
Êags
);

470 
	}
}

475 
	$œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
)

477 #ifde‡
CONFIG_SMP


478 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

480 
	}
}

486 
__˝uöô
 
	$£tup_APIC_timî
()

488 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

490 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_ARAT
)) {

491 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_C3STOP
;

493 
œpic_˛ockevít
.
øtög
 = 150;

496 
	`mem˝y
(
Àvt
, &
œpic_˛ockevít
, (*levt));

497 
Àvt
->
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

499 
	`˛ockevíts_ªgi°î_devi˚
(
Àvt
);

500 
	}
}

523 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

525 
__öôd©a
 
	gœpic_ˇl_lo›s
 = -1;

526 
__öôd©a
 
	gœpic_ˇl_t1
, 
	gœpic_ˇl_t2
;

527 
__öôd©a
 
	gœpic_ˇl_tsc1
, 
	gœpic_ˇl_tsc2
;

528 
__öôd©a
 
	gœpic_ˇl_pm1
, 
	gœpic_ˇl_pm2
;

529 
__öôd©a
 
	gœpic_ˇl_j1
, 
	gœpic_ˇl_j2
;

534 
__öô
 
	$œpic_ˇl_h™dÀr
(
˛ock_evít_devi˚
 *
dev
)

536 
tsc
 = 0;

537 
èpic
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

538 
pm
 = 
	`a˝i_pm_ªad_óæy
();

540 i‡(
˝u_has_tsc
)

541 
	`rdts˛l
(
tsc
);

543 
œpic_ˇl_lo›s
++) {

545 
œpic_ˇl_t1
 = 
èpic
;

546 
œpic_ˇl_tsc1
 = 
tsc
;

547 
œpic_ˇl_pm1
 = 
pm
;

548 
œpic_ˇl_j1
 = 
jiffõs
;

551 
LAPIC_CAL_LOOPS
:

552 
œpic_ˇl_t2
 = 
èpic
;

553 
œpic_ˇl_tsc2
 = 
tsc
;

554 i‡(
pm
 < 
œpic_ˇl_pm1
)

555 
pm
 +
ACPI_PM_OVRRUN
;

556 
œpic_ˇl_pm2
 = 
pm
;

557 
œpic_ˇl_j2
 = 
jiffõs
;

560 
	}
}

562 
__öô


563 
	$ˇlibøã_by_pmtimî
(
dñèpm
, *
dñè
, *
dñètsc
)

565 c⁄° 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

566 c⁄° 
pm_thªsh
 = 
pm_100ms
 / 100;

567 
mu…
;

568 
u64
 
ªs
;

570 #i‚de‡
CONFIG_X86_PM_TIMER


574 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-Timî dñè = %ld\n", 
dñèpm
);

577 i‡(!
dñèpm
)

580 
mu…
 = 
	`˛ocksour˚_hz2mu…
(
PMTMR_TICKS_PER_SEC
, 22);

582 i‡(
dñèpm
 > (
pm_100ms
 - 
pm_thªsh
) &&

583 
dñèpm
 < (
pm_100ms
 + 
pm_thªsh
)) {

584 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-TimerÑesult ok\n");

588 
ªs
 = (((
u64
)
dñèpm
Ë* 
mu…
) >> 22;

589 
	`do_div
(
ªs
, 1000000);

590 
	`¥_w¨nög
("APIC calibrationÇot consistent "

591 "wôh PM-Timî: %ldm†ö°ód o‡100ms\n",()
ªs
);

594 
ªs
 = (((
u64
)(*
dñè
)Ë* 
pm_100ms
);

595 
	`do_div
(
ªs
, 
dñèpm
);

596 
	`¥_öfo
("APIC deltaádjustedÅo PM-Timer: "

597 "%lu (%ld)\n", ()
ªs
, *
dñè
);

598 *
dñè
 = ()
ªs
;

601 i‡(
˝u_has_tsc
) {

602 
ªs
 = (((
u64
)(*
dñètsc
)Ë* 
pm_100ms
);

603 
	`do_div
(
ªs
, 
dñèpm
);

604 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "TSC deltaádjustedÅo "

606 ()
ªs
, *
dñètsc
);

607 *
dñètsc
 = ()
ªs
;

611 
	}
}

613 
__öô
 
	$ˇlibøã_APIC_˛ock
()

615 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

616 (*
ªÆ_h™dÀr
)(
˛ock_evít_devi˚
 *
dev
);

617 
dñèj
;

618 
dñè
, 
dñètsc
;

619 
pm_ª„ªn˚d
 = 0;

621 
	`loˇl_úq_dißbÀ
();

624 
ªÆ_h™dÀr
 = 
globÆ_˛ock_evít
->
evít_h™dÀr
;

625 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

631 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

634 
	`loˇl_úq_íabÀ
();

636 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

637 
	`˝u_ªœx
();

639 
	`loˇl_úq_dißbÀ
();

642 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
ªÆ_h™dÀr
;

645 
dñè
 = 
œpic_ˇl_t1
 - 
œpic_ˇl_t2
;

646 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "...Ü≠i¯dñè = %ld\n", 
dñè
);

648 
dñètsc
 = ()(
œpic_ˇl_tsc2
 - 
œpic_ˇl_tsc1
);

651 
pm_ª„ªn˚d
 = !
	`ˇlibøã_by_pmtimî
(
œpic_ˇl_pm2
 - 
œpic_ˇl_pm1
,

652 &
dñè
, &
dñètsc
);

655 
œpic_˛ockevít
.
mu…
 = 
	`div_sc
(
dñè
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

656 
œpic_˛ockevít
.
shi·
);

657 
œpic_˛ockevít
.
max_dñè_ns
 =

658 
	`˛ockevít_dñè2ns
(0x7FFFFF, &
œpic_˛ockevít
);

659 
œpic_˛ockevít
.
mö_dñè_ns
 =

660 
	`˛ockevít_dñè2ns
(0xF, &
œpic_˛ockevít
);

662 
ˇlibøti⁄_ªsu…
 = (
dñè
 * 
APIC_DIVISOR
Ë/ 
LAPIC_CAL_LOOPS
;

664 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... dñè %ld\n", 
dñè
);

665 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... mu…: %ld\n", 
œpic_˛ockevít
.
mu…
);

666 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... calibrationÑesult: %u\n",

667 
ˇlibøti⁄_ªsu…
);

669 i‡(
˝u_has_tsc
) {

670 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... CPU clock speed is "

672 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë/ (1000000 / 
HZ
),

673 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë% (1000000 / 
HZ
));

676 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... host bus clock speed is "

678 
ˇlibøti⁄_ªsu…
 / (1000000 / 
HZ
),

679 
ˇlibøti⁄_ªsu…
 % (1000000 / 
HZ
));

684 i‡(
ˇlibøti⁄_ªsu…
 < (1000000 / 
HZ
)) {

685 
	`loˇl_úq_íabÀ
();

686 
	`¥_w¨nög
("APIC frequencyÅoo slow, disablingápicÅimer\n");

690 
Àvt
->
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

696 i‡(!
pm_ª„ªn˚d
) {

697 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... verify APICÅimer\n");

702 
Àvt
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

703 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Àvt
);

704 
œpic_ˇl_lo›s
 = -1;

707 
	`loˇl_úq_íabÀ
();

709 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

710 
	`˝u_ªœx
();

713 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Àvt
);

716 
dñèj
 = 
œpic_ˇl_j2
 - 
œpic_ˇl_j1
;

717 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffõ†dñè = %lu\n", 
dñèj
);

720 i‡(
dñèj
 >
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

721 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffiesÑesult ok\n");

723 
Àvt
->
„©uªs
 |
CLOCK_EVT_FEAT_DUMMY
;

725 
	`loˇl_úq_íabÀ
();

727 i‡(
Àvt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
) {

728 
	`¥_w¨nög
("APICÅimer disabled dueÅo verification failure\n");

733 
	}
}

740 
__öô
 
	$£tup_boŸ_APIC_˛ock
()

748 i‡(
dißbÀ_≠ic_timî
) {

749 
	`¥_öfo
("Disabling APICÅimer\n");

751 i‡(
	`num_possibÀ_˝us
() > 1) {

752 
œpic_˛ockevít
.
mu…
 = 1;

753 
	`£tup_APIC_timî
();

758 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "UsingÜocal APICÅimer interrupts.\n"

761 i‡(
	`ˇlibøã_APIC_˛ock
()) {

763 i‡(
	`num_possibÀ_˝us
() > 1)

764 
	`£tup_APIC_timî
();

773 i‡(
nmi_w©chdog
 !
NMI_IO_APIC
)

774 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

776 
	`¥_w¨nög
("APICÅimerÑegisteredás dummy,"

777 " duêtÿnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

780 
	`£tup_APIC_timî
();

781 
	}
}

783 
__˝uöô
 
	$£tup_£c⁄d¨y_APIC_˛ock
()

785 
	`£tup_APIC_timî
();

786 
	}
}

791 
	$loˇl_≠ic_timî_öãºu±
()

793 
˝u
 = 
	`smp_¥o˚ss‹_id
();

794 
˛ock_evít_devi˚
 *
evt
 = &
	`≥r_˝u
(
œpic_evíts
, 
˝u
);

807 i‡(!
evt
->
evít_h™dÀr
) {

808 
	`¥_w¨nög
("Spuriou†LAPICÅimî i¡îru± o¿˝u %d\n", 
˝u
);

810 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

817 
	`öc_úq_°©
(
≠ic_timî_úqs
);

819 
evt
->
	`evít_h™dÀr
(evt);

820 
	}
}

830 
__úq_íåy
 
	$smp_≠ic_timî_öãºu±
(
±_ªgs
 *
ªgs
)

832 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

838 
	`ack_APIC_úq
();

844 
	`exô_idÀ
();

845 
	`úq_íãr
();

846 
	`loˇl_≠ic_timî_öãºu±
();

847 
	`úq_exô
();

849 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

850 
	}
}

852 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

854  -
EINVAL
;

855 
	}
}

868 
	$˛ór_loˇl_APIC
()

870 
maxlvt
;

871 
u32
 
v
;

874 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

877 
maxlvt
 = 
	`œpic_gë_maxlvt
();

882 i‡(
maxlvt
 >= 3) {

883 
v
 = 
ERROR_APIC_VECTOR
;

884 
	`≠ic_wrôe
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

890 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

891 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

892 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

893 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

894 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

895 
	`≠ic_wrôe
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

896 i‡(
maxlvt
 >= 4) {

897 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

898 
	`≠ic_wrôe
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

902 #ifde‡
CONFIG_X86_THERMAL_VECTOR


903 i‡(
maxlvt
 >= 5) {

904 
v
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

905 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

908 #ifde‡
CONFIG_X86_MCE_INTEL


909 i‡(
maxlvt
 >= 6) {

910 
v
 = 
	`≠ic_ªad
(
APIC_LVTCMCI
);

911 i‡(!(
v
 & 
APIC_LVT_MASKED
))

912 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

919 
	`≠ic_wrôe
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

920 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

921 
	`≠ic_wrôe
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

922 i‡(
maxlvt
 >= 3)

923 
	`≠ic_wrôe
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

924 i‡(
maxlvt
 >= 4)

925 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

928 i‡(
	`œpic_is_öãgøãd
()) {

929 i‡(
maxlvt
 > 3)

931 
	`≠ic_wrôe
(
APIC_ESR
, 0);

932 
	`≠ic_ªad
(
APIC_ESR
);

934 
	}
}

939 
	$dißbÀ_loˇl_APIC
()

941 
vÆue
;

944 i‡(!
≠ic_phys
)

947 
	`˛ór_loˇl_APIC
();

953 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

954 
vÆue
 &~
APIC_SPIV_APIC_ENABLED
;

955 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

957 #ifde‡
CONFIG_X86_32


962 i‡(
íabÀd_vü_≠icba£
) {

963 
l
, 
h
;

965 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

966 
l
 &~
MSR_IA32_APICBASE_ENABLE
;

967 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

970 
	}
}

978 
	$œpic_shutdown
()

980 
Êags
;

982 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

985 
	`loˇl_úq_ßve
(
Êags
);

987 #ifde‡
CONFIG_X86_32


988 i‡(!
íabÀd_vü_≠icba£
)

989 
	`˛ór_loˇl_APIC
();

992 
	`dißbÀ_loˇl_APIC
();

995 
	`loˇl_úq_ª°‹e
(
Êags
);

996 
	}
}

1003 
__öô
 
	$vîify_loˇl_APIC
()

1005 
ªg0
, 
ªg1
;

1010 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVR
);

1011 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg0
);

1012 
	`≠ic_wrôe
(
APIC_LVR
, 
ªg0
 ^ 
APIC_LVR_MASK
);

1013 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVR
);

1014 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg1
);

1021 i‡(
ªg1
 !
ªg0
)

1027 
ªg1
 = 
	`GET_APIC_VERSION
(
ªg0
);

1028 i‡(
ªg1
 == 0x00 ||Ñeg1 == 0xff)

1030 
ªg1
 = 
	`œpic_gë_maxlvt
();

1031 i‡(
ªg1
 < 0x02 ||Ñeg1 == 0xff)

1037 
ªg0
 = 
	`≠ic_ªad
(
APIC_ID
);

1038 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg0
);

1039 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
 ^ 
≠ic
->
≠ic_id_mask
);

1040 
ªg1
 = 
	`≠ic_ªad
(
APIC_ID
);

1041 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg1
);

1042 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
);

1043 i‡(
ªg1
 !(
ªg0
 ^ 
≠ic
->
≠ic_id_mask
))

1051 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1052 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT0: %x\n", 
ªg0
);

1053 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1054 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT1: %x\n", 
ªg1
);

1057 
	}
}

1062 
__öô
 
	$sync_Arb_IDs
()

1068 i‡(
	`modîn_≠ic
(Ë|| 
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
)

1074 
	`≠ic_waô_i¸_idÀ
();

1076 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1077 
	`≠ic_wrôe
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1078 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1079 
	}
}

1084 
__öô
 
	$öô_b•_APIC
()

1086 
vÆue
;

1092 i‡(
smp_found_c⁄fig
 || !
˝u_has_≠ic
)

1098 
	`˛ór_loˇl_APIC
();

1103 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1104 
vÆue
 &~
APIC_VECTOR_MASK
;

1105 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1107 #ifde‡
CONFIG_X86_32


1109 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

1110 (
boŸ_˝u_d©a
.
x86
 == 15))

1111 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1114 
vÆue
 |
APIC_SPIV_FOCUS_DISABLED
;

1115 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1116 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1121 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1122 
vÆue
 = 
APIC_DM_NMI
;

1123 i‡(!
	`œpic_is_öãgøãd
())

1124 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1125 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1126 
	}
}

1128 
__˝uöô
 
	$œpic_£tup_e§
()

1130 
ﬁdvÆue
, 
vÆue
, 
maxlvt
;

1132 i‡(!
	`œpic_is_öãgøãd
()) {

1133 
	`¥_öfo
("No ESR for 82489DX.\n");

1137 i‡(
≠ic
->
dißbÀ_e§
) {

1144 
	`¥_öfo
("Leaving ESR disabled.\n");

1148 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1149 i‡(
maxlvt
 > 3)

1150 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1151 
ﬁdvÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1154 
vÆue
 = 
ERROR_APIC_VECTOR
;

1155 
	`≠ic_wrôe
(
APIC_LVTERR
, 
vÆue
);

1160 i‡(
maxlvt
 > 3)

1161 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1162 
vÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1163 i‡(
vÆue
 !
ﬁdvÆue
)

1164 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ESR value beforeÉnabling "

1166 
ﬁdvÆue
, 
vÆue
);

1167 
	}
}

1173 
__˝uöô
 
	$£tup_loˇl_APIC
()

1175 
vÆue
;

1176 
i
, 
j
;

1178 i‡(
dißbÀ_≠ic
) {

1179 
	`¨ch_dißbÀ_smp_suµ‹t
();

1183 #ifde‡
CONFIG_X86_32


1185 i‡(
	`œpic_is_öãgøãd
(Ë&& 
≠ic
->
dißbÀ_e§
) {

1186 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1187 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1188 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1189 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1192 
	`≥rf_evíts_œpic_öô
();

1194 
	`¥ìm±_dißbÀ
();

1200 
	`BUG_ON
(!
≠ic
->
	`≠ic_id_ªgi°îed
());

1207 
≠ic
->
	`öô_≠ic_ldr
();

1213 
vÆue
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1214 
vÆue
 &~
APIC_TPRI_MASK
;

1215 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
vÆue
);

1228 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1229 
vÆue
 = 
	`≠ic_ªad
(
APIC_ISR
 + 
i
*0x10);

1230 
j
 = 31; j >= 0; j--) {

1231 i‡(
vÆue
 & (1<<
j
))

1232 
	`ack_APIC_úq
();

1239 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1240 
vÆue
 &~
APIC_VECTOR_MASK
;

1244 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1246 #ifde‡
CONFIG_X86_32


1272 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1278 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1279 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1291 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
Ë& 
APIC_LVT_MASKED
;

1292 i‡(!
	`smp_¥o˚ss‹_id
(Ë&& (
pic_mode
 || !
vÆue
)) {

1293 
vÆue
 = 
APIC_DM_EXTINT
;

1294 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1295 
	`smp_¥o˚ss‹_id
());

1297 
vÆue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1298 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1299 
	`smp_¥o˚ss‹_id
());

1301 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1306 i‡(!
	`smp_¥o˚ss‹_id
())

1307 
vÆue
 = 
APIC_DM_NMI
;

1309 
vÆue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1310 i‡(!
	`œpic_is_öãgøãd
())

1311 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1312 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1314 
	`¥ìm±_íabÀ
();

1316 #ifde‡
CONFIG_X86_MCE_INTEL


1318 i‡(
	`smp_¥o˚ss‹_id
() == 0)

1319 
	`cmci_ªcheck
();

1321 
	}
}

1323 
__˝uöô
 
	$íd_loˇl_APIC_£tup
()

1325 
	`œpic_£tup_e§
();

1327 #ifde‡
CONFIG_X86_32


1329 
vÆue
;

1331 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1332 
vÆue
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1333 
	`≠ic_wrôe
(
APIC_LVTT
, 
vÆue
);

1337 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

1338 
	`≠ic_pm_a˘iv©e
();

1339 
	}
}

1341 #ifde‡
CONFIG_X86_X2APIC


1342 
	$check_x2≠ic
()

1344 i‡(
	`x2≠ic_íabÀd
()) {

1345 
	`¥_öfo
("x2apicÉnabled by BIOS, switchingÅo x2apic ops\n");

1346 
x2≠ic_¥ì«bÀd
 = 
x2≠ic_mode
 = 1;

1348 
	}
}

1350 
	$íabÀ_x2≠ic
()

1352 
m§
, 
m§2
;

1354 i‡(!
x2≠ic_mode
)

1357 
	`rdm§
(
MSR_IA32_APICBASE
, 
m§
, 
m§2
);

1358 i‡(!(
m§
 & 
X2APIC_ENABLE
)) {

1359 
	`¥_öfo
("Enabling x2apic\n");

1360 
	`wrm§
(
MSR_IA32_APICBASE
, 
m§
 | 
X2APIC_ENABLE
, 0);

1362 
	}
}

1365 
__öô
 
	$íabÀ_IR
()

1367 #ifde‡
CONFIG_INTR_REMAP


1368 i‡(!
	`öå_ªm≠pög_suµ‹ãd
()) {

1369 
	`¥_debug
("intr-remappingÇot supported\n");

1373 i‡(!
x2≠ic_¥ì«bÀd
 && 
skù_iﬂpic_£tup
) {

1374 
	`¥_öfo
("SkippedÉnabling intr-remap because of skipping "

1379 i‡(
	`íabÀ_öå_ªm≠pög
(
	`x2≠ic_suµ‹ãd
()))

1382 
	`¥_öfo
("Enabled Interrupt-remapping\n");

1388 
	}
}

1390 
__öô
 
	$íabÀ_IR_x2≠ic
()

1392 
Êags
;

1393 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

1394 
ªt
, 
x2≠ic_íabÀd
 = 0;

1395 
dm¨_èbÀ_öô_ªt
 = 0;

1397 #ifde‡
CONFIG_INTR_REMAP


1398 
dm¨_èbÀ_öô_ªt
 = 
	`dm¨_èbÀ_öô
();

1399 i‡(
dm¨_èbÀ_öô_ªt
)

1400 
	`¥_debug
("dmar_table_init() failed with %d:\n",

1401 
dm¨_èbÀ_öô_ªt
);

1404 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

1405 i‡(!
iﬂpic_íåõs
) {

1406 
	`¥_îr
("Allocate ioapic_entries failed\n");

1407 
out
;

1410 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

1411 i‡(
ªt
) {

1412 
	`¥_öfo
("Savög IO-APIC sèã faûed: %d\n", 
ªt
);

1413 
out
;

1416 
	`loˇl_úq_ßve
(
Êags
);

1417 
	`mask_8259A
();

1418 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

1420 i‡(
dm¨_èbÀ_öô_ªt
)

1421 
ªt
 = 0;

1423 
ªt
 = 
	`íabÀ_IR
();

1425 i‡(!
ªt
) {

1429 i‡(
max_physiˇl_≠icid
 > 255 || !
	`kvm_∑ø_avaûabÀ
())

1430 
nox2≠ic
;

1435 
	`x2≠ic_f‹˚_phys
();

1438 
x2≠ic_íabÀd
 = 1;

1440 i‡(
	`x2≠ic_suµ‹ãd
(Ë&& !
x2≠ic_mode
) {

1441 
x2≠ic_mode
 = 1;

1442 
	`íabÀ_x2≠ic
();

1443 
	`¥_öfo
("Enabled x2apic\n");

1446 
nox2≠ic
:

1447 i‡(!
ªt
)

1448 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

1449 
	`unmask_8259A
();

1450 
	`loˇl_úq_ª°‹e
(
Êags
);

1452 
out
:

1453 i‡(
iﬂpic_íåõs
)

1454 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

1456 i‡(
x2≠ic_íabÀd
)

1459 i‡(
x2≠ic_¥ì«bÀd
)

1460 
	`∑nic
("x2apic:Énabled by BIOS but kernel init failed.");

1461 i‡(
˝u_has_x2≠ic
)

1462 
	`¥_öfo
("NotÉnabling x2apic, Intr-remapping init failed.\n");

1463 
	}
}

1465 #ifde‡
CONFIG_X86_64


1472 
__öô
 
	$dëe˘_öô_APIC
()

1474 i‡(!
˝u_has_≠ic
) {

1475 
	`¥_öfo
("NoÜocal APICÖresent\n");

1479 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1481 
	}
}

1486 
__öô
 
	$dëe˘_öô_APIC
()

1488 
u32
 
h
, 
l
, 
„©uªs
;

1491 i‡(
dißbÀ_≠ic
)

1494 
boŸ_˝u_d©a
.
x86_víd‹
) {

1495 
X86_VENDOR_AMD
:

1496 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 > 1) ||

1497 (
boŸ_˝u_d©a
.
x86
 >= 15))

1499 
no_≠ic
;

1500 
X86_VENDOR_INTEL
:

1501 i‡(
boŸ_˝u_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1502 (
boŸ_˝u_d©a
.
x86
 =5 && 
˝u_has_≠ic
))

1504 
no_≠ic
;

1506 
no_≠ic
;

1509 i‡(!
˝u_has_≠ic
) {

1514 i‡(!
f‹˚_íabÀ_loˇl_≠ic
) {

1515 
	`¥_öfo
("Local APIC disabled by BIOS -- "

1524 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1525 i‡(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1526 
	`¥_öfo
("Local APIC disabled by BIOS --Ñeenabling.\n");

1527 
l
 &~
MSR_IA32_APICBASE_BASE
;

1528 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1529 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1530 
íabÀd_vü_≠icba£
 = 1;

1537 
„©uªs
 = 
	`˝uid_edx
(1);

1538 i‡(!(
„©uªs
 & (1 << 
X86_FEATURE_APIC
))) {

1539 
	`¥_w¨nög
("CouldÇotÉnable APIC!\n");

1542 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1543 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1546 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1547 i‡(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1548 
mp_œpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1550 
	`¥_öfo
("FoundándÉnabledÜocal APIC!\n");

1552 
	`≠ic_pm_a˘iv©e
();

1556 
no_≠ic
:

1557 
	`¥_öfo
("NoÜocal APICÖresent or hardware disabled\n");

1559 
	}
}

1562 #ifde‡
CONFIG_X86_64


1563 
__öô
 
	$óæy_öô_œpic_m≠pög
()

1569 i‡(!
smp_found_c⁄fig
)

1572 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
mp_œpic_addr
);

1573 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %16lx (%16lx)\n",

1574 
APIC_BASE
, 
mp_œpic_addr
);

1580 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1581 
	}
}

1587 
__öô
 
	$öô_≠ic_m≠pögs
()

1589 
√w_≠icid
;

1591 i‡(
x2≠ic_mode
) {

1592 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1597 i‡(!
smp_found_c⁄fig
 && 
	`dëe˘_öô_APIC
()) {

1599 
	`¥_öfo
("APIC: disableápic facility\n");

1600 
	`≠ic_dißbÀ
();

1602 
≠ic_phys
 = 
mp_œpic_addr
;

1608 i‡(!
a˝i_œpic
)

1609 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
≠ic_phys
);

1611 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %08lx (%08lx)\n",

1612 
APIC_BASE
, 
≠ic_phys
);

1619 
√w_≠icid
 = 
	`ªad_≠ic_id
();

1620 i‡(
boŸ_˝u_physiˇl_≠icid
 !
√w_≠icid
) {

1621 
boŸ_˝u_physiˇl_≠icid
 = 
√w_≠icid
;

1629 
≠ic_vîsi⁄
[
√w_≠icid
] =

1630 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

1632 
	}
}

1638 
	g≠ic_vîsi⁄
[
MAX_APICS
];

1640 
__öô
 
	$APIC_öô_unùro˚ss‹
()

1642 i‡(
dißbÀ_≠ic
) {

1643 
	`¥_öfo
("Apic disabled\n");

1646 #ifde‡
CONFIG_X86_64


1647 i‡(!
˝u_has_≠ic
) {

1648 
dißbÀ_≠ic
 = 1;

1649 
	`¥_öfo
("Apic disabled by BIOS\n");

1653 i‡(!
smp_found_c⁄fig
 && !
˝u_has_≠ic
)

1659 i‡(!
˝u_has_≠ic
 &&

1660 
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

1661 
	`¥_îr
("BIOS bug,Üocal APIC 0x%xÇot detected!...\n",

1662 
boŸ_˝u_physiˇl_≠icid
);

1667 
	`íabÀ_IR_x2≠ic
();

1668 #ifde‡
CONFIG_X86_64


1669 
	`deÁu…_£tup_≠ic_routög
();

1672 
	`vîify_loˇl_APIC
();

1673 
	`c⁄√˘_b•_APIC
();

1675 #ifde‡
CONFIG_X86_64


1676 
	`≠ic_wrôe
(
APIC_ID
, 
	`SET_APIC_ID
(
boŸ_˝u_physiˇl_≠icid
));

1683 #ifde‡
CONFIG_CRASH_DUMP


1684 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1687 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

1688 
	`£tup_loˇl_APIC
();

1690 #ifde‡
CONFIG_X86_IO_APIC


1695 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1696 
	`íabÀ_IO_APIC
();

1699 
	`íd_loˇl_APIC_£tup
();

1701 #ifde‡
CONFIG_X86_IO_APIC


1702 i‡(
smp_found_c⁄fig
 && !
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1703 
	`£tup_IO_APIC
();

1705 
ƒ_iﬂpics
 = 0;

1706 
	`loˇli£_nmi_w©chdog
();

1709 
	`loˇli£_nmi_w©chdog
();

1712 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1713 #ifde‡
CONFIG_X86_64


1714 
	`check_nmi_w©chdog
();

1718 
	}
}

1727 
	$smp_•urious_öãºu±
(
±_ªgs
 *
ªgs
)

1729 
u32
 
v
;

1731 
	`exô_idÀ
();

1732 
	`úq_íãr
();

1738 
v
 = 
	`≠ic_ªad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1739 i‡(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1740 
	`ack_APIC_úq
();

1742 
	`öc_úq_°©
(
úq_•urious_cou¡
);

1745 
	`¥_öfo
("spurious APIC interrupt on CPU#%d, "

1746 "shouldÇevî h≠≥n.\n", 
	`smp_¥o˚ss‹_id
());

1747 
	`úq_exô
();

1748 
	}
}

1753 
	$smp_îr‹_öãºu±
(
±_ªgs
 *
ªgs
)

1755 
u32
 
v
, 
v1
;

1757 
	`exô_idÀ
();

1758 
	`úq_íãr
();

1760 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1761 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1762 
v1
 = 
	`≠ic_ªad
(
APIC_ESR
);

1763 
	`ack_APIC_úq
();

1764 
	`©omic_öc
(&
úq_îr_cou¡
);

1777 
	`¥_debug
("APICÉrror on CPU%d: %02x(%02x)\n",

1778 
	`smp_¥o˚ss‹_id
(), 
v
 , 
v1
);

1779 
	`úq_exô
();

1780 
	}
}

1785 
__öô
 
	$c⁄√˘_b•_APIC
()

1787 #ifde‡
CONFIG_X86_32


1788 i‡(
pic_mode
) {

1792 
	`˛ór_loˇl_APIC
();

1797 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "leaving PIC mode, "

1799 
	`im¸_pic_to_≠ic
();

1802 i‡(
≠ic
->
íabÀ_≠ic_mode
)

1803 
≠ic
->
	`íabÀ_≠ic_mode
();

1804 
	}
}

1813 
	$disc⁄√˘_b•_APIC
(
vút_wúe_£tup
)

1815 
vÆue
;

1817 #ifde‡
CONFIG_X86_32


1818 i‡(
pic_mode
) {

1825 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "disabling APIC mode, "

1827 
	`im¸_≠ic_to_pic
();

1835 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1836 
vÆue
 &~
APIC_VECTOR_MASK
;

1837 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1838 
vÆue
 |= 0xf;

1839 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1841 i‡(!
vút_wúe_£tup
) {

1846 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1847 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1848 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1849 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1850 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1851 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_EXTINT
);

1852 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1855 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1862 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1863 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1864 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1865 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1866 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1867 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_NMI
);

1868 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1869 
	}
}

1871 
__˝uöô
 
	$gíîic_¥o˚ss‹_öfo
(
≠icid
, 
vîsi⁄
)

1873 
˝u
;

1878 i‡(
vîsi⁄
 == 0x0) {

1879 
	`¥_w¨nög
("BIOS bug, APIC version is 0 for CPU#%d! "

1881 
vîsi⁄
);

1882 
vîsi⁄
 = 0x10;

1884 
≠ic_vîsi⁄
[
≠icid
] = 
vîsi⁄
;

1886 i‡(
num_¥o˚ss‹s
 >
ƒ_˝u_ids
) {

1887 
max
 = 
ƒ_˝u_ids
;

1888 
this˝u
 = 
max
 + 
dißbÀd_˝us
;

1890 
	`¥_w¨nög
(

1892 " Pro˚ss‹ %d/0x%x ign‹ed.\n", 
max
, 
this˝u
, 
≠icid
);

1894 
dißbÀd_˝us
++;

1898 
num_¥o˚ss‹s
++;

1899 
˝u
 = 
	`˝umask_√xt_zîo
(-1, 
˝u_¥e£¡_mask
);

1901 i‡(
vîsi⁄
 !
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])

1902 
	`WARN_ONCE
(1,

1904 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
], 
˝u
, 
vîsi⁄
);

1906 
	`physid_£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
);

1907 i‡(
≠icid
 =
boŸ_˝u_physiˇl_≠icid
) {

1913 
˝u
 = 0;

1915 i‡(
≠icid
 > 
max_physiˇl_≠icid
)

1916 
max_physiˇl_≠icid
 = 
≠icid
;

1918 #ifde‡
CONFIG_X86_32


1919 
boŸ_˝u_d©a
.
x86_víd‹
) {

1920 
X86_VENDOR_INTEL
:

1921 i‡(
num_¥o˚ss‹s
 > 8)

1922 
def_to_bigsmp
 = 1;

1924 
X86_VENDOR_AMD
:

1925 i‡(
max_physiˇl_≠icid
 >= 8)

1926 
def_to_bigsmp
 = 1;

1930 #i‡
	`deföed
(
CONFIG_SMP
Ë|| deföed(
CONFIG_X86_64
)

1931 
	`óæy_≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
≠icid
;

1932 
	`óæy_≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
Ë
≠icid
;

1935 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

1936 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

1937 
	}
}

1939 
	$h¨d_smp_¥o˚ss‹_id
()

1941  
	`ªad_≠ic_id
();

1942 
	}
}

1944 
	$deÁu…_öô_≠ic_ldr
()

1946 
vÆ
;

1948 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1949 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

1950 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_¥o˚ss‹_id
());

1951 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

1952 
	}
}

1954 #ifde‡
CONFIG_X86_32


1955 
	$deÁu…_≠icid_to_node
(
logiˇl_≠icid
)

1957 #ifde‡
CONFIG_SMP


1958  
≠icid_2_node
[
	`h¨d_smp_¥o˚ss‹_id
()];

1962 
	}
}

1968 #ifde‡
CONFIG_PM


1976 
	ma˘ive
;

1978 
	m≠ic_id
;

1979 
	m≠ic_èsk¥i
;

1980 
	m≠ic_ldr
;

1981 
	m≠ic_d‰
;

1982 
	m≠ic_•iv
;

1983 
	m≠ic_lvâ
;

1984 
	m≠ic_lvçc
;

1985 
	m≠ic_lvt0
;

1986 
	m≠ic_lvt1
;

1987 
	m≠ic_lvãº
;

1988 
	m≠ic_tmi˘
;

1989 
	m≠ic_td¸
;

1990 
	m≠ic_thmr
;

1991 } 
	g≠ic_pm_°©e
;

1993 
	$œpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1995 
Êags
;

1996 
maxlvt
;

1998 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2001 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2003 
≠ic_pm_°©e
.
≠ic_id
 = 
	`≠ic_ªad
(
APIC_ID
);

2004 
≠ic_pm_°©e
.
≠ic_èsk¥i
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

2005 
≠ic_pm_°©e
.
≠ic_ldr
 = 
	`≠ic_ªad
(
APIC_LDR
);

2006 
≠ic_pm_°©e
.
≠ic_d‰
 = 
	`≠ic_ªad
(
APIC_DFR
);

2007 
≠ic_pm_°©e
.
≠ic_•iv
 = 
	`≠ic_ªad
(
APIC_SPIV
);

2008 
≠ic_pm_°©e
.
≠ic_lvâ
 = 
	`≠ic_ªad
(
APIC_LVTT
);

2009 i‡(
maxlvt
 >= 4)

2010 
≠ic_pm_°©e
.
≠ic_lvçc
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

2011 
≠ic_pm_°©e
.
≠ic_lvt0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2012 
≠ic_pm_°©e
.
≠ic_lvt1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

2013 
≠ic_pm_°©e
.
≠ic_lvãº
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

2014 
≠ic_pm_°©e
.
≠ic_tmi˘
 = 
	`≠ic_ªad
(
APIC_TMICT
);

2015 
≠ic_pm_°©e
.
≠ic_td¸
 = 
	`≠ic_ªad
(
APIC_TDCR
);

2016 #ifde‡
CONFIG_X86_THERMAL_VECTOR


2017 i‡(
maxlvt
 >= 5)

2018 
≠ic_pm_°©e
.
≠ic_thmr
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

2021 
	`loˇl_úq_ßve
(
Êags
);

2022 
	`dißbÀ_loˇl_APIC
();

2024 i‡(
öå_ªm≠pög_íabÀd
)

2025 
	`dißbÀ_öå_ªm≠pög
();

2027 
	`loˇl_úq_ª°‹e
(
Êags
);

2029 
	}
}

2031 
	$œpic_ªsume
(
sys_devi˚
 *
dev
)

2033 
l
, 
h
;

2034 
Êags
;

2035 
maxlvt
;

2036 
ªt
 = 0;

2037 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

2039 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2042 
	`loˇl_úq_ßve
(
Êags
);

2043 i‡(
öå_ªm≠pög_íabÀd
) {

2044 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

2045 i‡(!
iﬂpic_íåõs
) {

2046 
	`WARN
(1, "Alloc ioapic_entries inÜapicÑesume failed.");

2047 
ªt
 = -
ENOMEM
;

2048 
ª°‹e
;

2051 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

2052 i‡(
ªt
) {

2053 
	`WARN
(1, "Savög IO-APIC sèã faûed: %d\n", 
ªt
);

2054 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2055 
ª°‹e
;

2058 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

2059 
	`mask_8259A
();

2062 i‡(
x2≠ic_mode
)

2063 
	`íabÀ_x2≠ic
();

2071 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2072 
l
 &~
MSR_IA32_APICBASE_BASE
;

2073 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
mp_œpic_addr
;

2074 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2077 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2078 
	`≠ic_wrôe
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2079 
	`≠ic_wrôe
(
APIC_ID
, 
≠ic_pm_°©e
.
≠ic_id
);

2080 
	`≠ic_wrôe
(
APIC_DFR
, 
≠ic_pm_°©e
.
≠ic_d‰
);

2081 
	`≠ic_wrôe
(
APIC_LDR
, 
≠ic_pm_°©e
.
≠ic_ldr
);

2082 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
≠ic_pm_°©e
.
≠ic_èsk¥i
);

2083 
	`≠ic_wrôe
(
APIC_SPIV
, 
≠ic_pm_°©e
.
≠ic_•iv
);

2084 
	`≠ic_wrôe
(
APIC_LVT0
, 
≠ic_pm_°©e
.
≠ic_lvt0
);

2085 
	`≠ic_wrôe
(
APIC_LVT1
, 
≠ic_pm_°©e
.
≠ic_lvt1
);

2086 #i‡
	`deföed
(
CONFIG_X86_MCE_P4THERMAL
Ë|| deföed(
CONFIG_X86_MCE_INTEL
)

2087 i‡(
maxlvt
 >= 5)

2088 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
≠ic_pm_°©e
.
≠ic_thmr
);

2090 i‡(
maxlvt
 >= 4)

2091 
	`≠ic_wrôe
(
APIC_LVTPC
, 
≠ic_pm_°©e
.
≠ic_lvçc
);

2092 
	`≠ic_wrôe
(
APIC_LVTT
, 
≠ic_pm_°©e
.
≠ic_lvâ
);

2093 
	`≠ic_wrôe
(
APIC_TDCR
, 
≠ic_pm_°©e
.
≠ic_td¸
);

2094 
	`≠ic_wrôe
(
APIC_TMICT
, 
≠ic_pm_°©e
.
≠ic_tmi˘
);

2095 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2096 
	`≠ic_ªad
(
APIC_ESR
);

2097 
	`≠ic_wrôe
(
APIC_LVTERR
, 
≠ic_pm_°©e
.
≠ic_lvãº
);

2098 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2099 
	`≠ic_ªad
(
APIC_ESR
);

2101 i‡(
öå_ªm≠pög_íabÀd
) {

2102 
	`ªíabÀ_öå_ªm≠pög
(
x2≠ic_mode
);

2103 
	`unmask_8259A
();

2104 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

2105 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2107 
ª°‹e
:

2108 
	`loˇl_úq_ª°‹e
(
Êags
);

2110  
ªt
;

2111 
	}
}

2118 
sysdev_˛ass
 
	gœpic_sys˛ass
 = {

2119 .
«me
 = "lapic",

2120 .
	gªsume
 = 
œpic_ªsume
,

2121 .
	gsu•íd
 = 
œpic_su•íd
,

2124 
sys_devi˚
 
	gdevi˚_œpic
 = {

2125 .
id
 = 0,

2126 .
	g˛s
 = &
œpic_sys˛ass
,

2129 
__˝uöô
 
	$≠ic_pm_a˘iv©e
()

2131 
≠ic_pm_°©e
.
a˘ive
 = 1;

2132 
	}
}

2134 
__öô
 
	$öô_œpic_sysfs
()

2136 
îr‹
;

2138 i‡(!
˝u_has_≠ic
)

2142 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
œpic_sys˛ass
);

2143 i‡(!
îr‹
)

2144 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic
);

2145  
îr‹
;

2146 
	}
}

2149 
c‹e_öôˇŒ
(
öô_œpic_sysfs
);

2153 
	$≠ic_pm_a˘iv©e
(Ë{ 
	}
}

2157 #ifde‡
CONFIG_X86_64


2159 
__˝uöô
 
	$≠ic_˛u°î_num
()

2161 
i
, 
˛u°îs
, 
zîos
;

2162 
id
;

2163 
u16
 *
bios_˝u_≠icid
;

2164 
	`DECLARE_BITMAP
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2166 
bios_˝u_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
);

2167 
	`bôm≠_zîo
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2169 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

2171 i‡(
bios_˝u_≠icid
) {

2172 
id
 = 
bios_˝u_≠icid
[
i
];

2173 } i‡(
i
 < 
ƒ_˝u_ids
) {

2174 i‡(
	`˝u_¥e£¡
(
i
))

2175 
id
 = 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
i
);

2181 i‡(
id
 !
BAD_APICID
)

2182 
	`__£t_bô
(
	`APIC_CLUSTERID
(
id
), 
˛u°îm≠
);

2191 
˛u°îs
 = 0;

2192 
zîos
 = 0;

2193 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2194 i‡(
	`ã°_bô
(
i
, 
˛u°îm≠
)) {

2195 
˛u°îs
 +1 + 
zîos
;

2196 
zîos
 = 0;

2198 ++
zîos
;

2201  
˛u°îs
;

2202 
	}
}

2204 
__˝uöôd©a
 
	gmu…i_checked
;

2205 
__˝uöôd©a
 
	gmu…i
;

2207 
__˝uöô
 
	$£t_mu…i
(c⁄° 
dmi_sy°em_id
 *
d
)

2209 i‡(
mu…i
)

2211 
	`¥_öfo
("APIC: %†dëe˘ed, Mu…òChassis\n", 
d
->
idít
);

2212 
mu…i
 = 1;

2214 
	}
}

2216 c⁄° 
__˝uöôc⁄°
 
dmi_sy°em_id
 
	gmu…i_dmi_èbÀ
[] = {

2218 .
ˇŒback
 = 
£t_mu…i
,

2219 .
	gidít
 = "IBM System Summit2",

2220 .
	gm©ches
 = {

2221 
DMI_MATCH
(
DMI_SYS_VENDOR
, "IBM"),

2222 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Summit2"),

2228 
__˝uöô
 
	$dmi_check_mu…i
()

2230 i‡(
mu…i_checked
)

2233 
	`dmi_check_sy°em
(
mu…i_dmi_èbÀ
);

2234 
mu…i_checked
 = 1;

2235 
	}
}

2245 
__˝uöô
 
	$≠ic_is_˛u°îed_box
()

2247 
	`dmi_check_mu…i
();

2248 i‡(
mu…i
)

2251 i‡(!
	`is_vsmp_box
())

2258 i‡(
	`≠ic_˛u°î_num
() > 1)

2262 
	}
}

2268 
__öô
 
	$£tup_dißbÀ≠ic
(*
¨g
)

2270 
dißbÀ_≠ic
 = 1;

2271 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

2273 
	}
}

2274 
óæy_∑øm
("dißbÀ≠ic", 
£tup_dißbÀ≠ic
);

2277 
__öô
 
	$£tup_nﬁ≠ic
(*
¨g
)

2279  
	`£tup_dißbÀ≠ic
(
¨g
);

2280 
	}
}

2281 
óæy_∑øm
("nﬁ≠ic", 
£tup_nﬁ≠ic
);

2283 
__öô
 
	$∑r£_œpic_timî_c2_ok
(*
¨g
)

2285 
loˇl_≠ic_timî_c2_ok
 = 1;

2287 
	}
}

2288 
óæy_∑øm
("œpic_timî_c2_ok", 
∑r£_œpic_timî_c2_ok
);

2290 
__öô
 
	$∑r£_dißbÀ_≠ic_timî
(*
¨g
)

2292 
dißbÀ_≠ic_timî
 = 1;

2294 
	}
}

2295 
óæy_∑øm
("nﬂpi˘imî", 
∑r£_dißbÀ_≠ic_timî
);

2297 
__öô
 
	$∑r£_nﬁ≠ic_timî
(*
¨g
)

2299 
dißbÀ_≠ic_timî
 = 1;

2301 
	}
}

2302 
óæy_∑øm
("nﬁ≠ic_timî", 
∑r£_nﬁ≠ic_timî
);

2304 
__öô
 
	$≠ic_£t_vîbosôy
(*
¨g
)

2306 i‡(!
¨g
) {

2307 #ifde‡
CONFIG_X86_64


2308 
skù_iﬂpic_£tup
 = 0;

2311  -
EINVAL
;

2314 i‡(
	`°rcmp
("debug", 
¨g
) == 0)

2315 
≠ic_vîbosôy
 = 
APIC_DEBUG
;

2316 i‡(
	`°rcmp
("vîbo£", 
¨g
) == 0)

2317 
≠ic_vîbosôy
 = 
APIC_VERBOSE
;

2319 
	`¥_w¨nög
("APIC VerbosityÜevel %sÇotÑecognised"

2320 " u£ápic=vîbo£ o∏≠ic=debug\n", 
¨g
);

2321  -
EINVAL
;

2325 
	}
}

2326 
óæy_∑øm
("≠ic", 
≠ic_£t_vîbosôy
);

2328 
__öô
 
	$œpic_ö£π_ªsour˚
()

2330 i‡(!
≠ic_phys
)

2334 
œpic_ªsour˚
.
°¨t
 = 
≠ic_phys
;

2335 
œpic_ªsour˚
.
íd
 =Ü≠ic_ªsour˚.
°¨t
 + 
PAGE_SIZE
 - 1;

2336 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
œpic_ªsour˚
);

2339 
	}
}

2345 
œã_öôˇŒ
(
œpic_ö£π_ªsour˚
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/≠ic.h
>

21 
	~<asm/ùi.h
>

23 #ifde‡
CONFIG_ACPI


24 
	~<a˝i/a˝i_bus.h
>

27 
	$Ê©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

30 
	}
}

32 c⁄° 
˝umask
 *
	$Ê©_èrgë_˝us
()

34  
˝u_⁄löe_mask
;

35 
	}
}

37 
	$Ê©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

47 
	`˝umask_˛ór
(
ªtmask
);

48 
	`˝umask_bôs
(
ªtmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$Ê©_öô_≠ic_ldr
()

60 
vÆ
;

61 
num
, 
id
;

63 
num
 = 
	`smp_¥o˚ss‹_id
();

64 
id
 = 1UL << 
num
;

65 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

67 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

69 
	}
}

71 
ölöe
 
	$_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
)

73 
Êags
;

75 
	`loˇl_úq_ßve
(
Êags
);

76 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

77 
	`loˇl_úq_ª°‹e
(
Êags
);

78 
	}
}

80 
	$Ê©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

82 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

84 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

85 
	}
}

88 
	$Ê©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

90 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

91 
˝u
 = 
	`smp_¥o˚ss‹_id
();

93 i‡(
˝u
 < 
BITS_PER_LONG
)

94 
	`˛ór_bô
(
˝u
, &
mask
);

96 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

97 
	}
}

99 
	$Ê©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

101 
˝u
 = 
	`smp_¥o˚ss‹_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hŸ∂ug
 = 1;

105 
hŸ∂ug
 = 0;

107 i‡(
hŸ∂ug
 || 
ve˘‹
 =
NMI_VECTOR
) {

108 i‡(!
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
	`˝umask_of
(
˝u
))) {

109 
mask
 = 
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0];

111 i‡(
˝u
 < 
BITS_PER_LONG
)

112 
	`˛ór_bô
(
˝u
, &
mask
);

114 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

116 } i‡(
	`num_⁄löe_˝us
() > 1) {

117 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLBUT
,

118 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

120 
	}
}

122 
	$Ê©_£nd_IPI_Æl
(
ve˘‹
)

124 i‡(
ve˘‹
 =
NMI_VECTOR
) {

125 
	`Ê©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

127 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLINC
,

128 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

130 
	}
}

132 
	$Ê©_gë_≠ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_≠ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$ªad_x≠ic_id
()

151 
id
;

153 
id
 = 
	`Ê©_gë_≠ic_id
(
	`≠ic_ªad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$Ê©_≠ic_id_ªgi°îed
()

159  
	`physid_is£t
(
	`ªad_x≠ic_id
(), 
phys_˝u_¥e£¡_m≠
);

160 
	}
}

162 
	$Ê©_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

164  
öôül_≠ic_id
 >> 
ödex_msb
;

165 
	}
}

167 
≠ic
 
	g≠ic_Ê©
 = {

168 .
«me
 = "flat",

169 .
	g¥obe
 = 
NULL
,

170 .
	ga˝i_madt_€m_check
 = 
Ê©_a˝i_madt_€m_check
,

171 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

173 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

174 .
	gúq_de°_mode
 = 1,

176 .
	gèrgë_˝us
 = 
Ê©_èrgë_˝us
,

177 .
	gdißbÀ_e§
 = 0,

178 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_≠icid_u£d
 = 
NULL
,

180 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

182 .
	gve˘‹_Æloˇti⁄_domaö
 = 
Ê©_ve˘‹_Æloˇti⁄_domaö
,

183 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

185 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

186 .
	g£tup_≠ic_routög
 = 
NULL
,

187 .
	gmu…i_timî_check
 = 
NULL
,

188 .
	g≠icid_to_node
 = 
NULL
,

189 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

190 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

191 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

192 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

193 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

194 .
	gíabÀ_≠ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

196 .
	gmps_€m_check
 = 
NULL
,

198 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

199 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

200 .
	g≠ic_id_mask
 = 0xFFu << 24,

202 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

203 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

205 .
	g£nd_IPI_mask
 = 
Ê©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_Ælbut£lf
 = 
Ê©_£nd_IPI_mask_Ælbut£lf
,

207 .
	g£nd_IPI_Ælbut£lf
 = 
Ê©_£nd_IPI_Ælbut£lf
,

208 .
	g£nd_IPI_Æl
 = 
Ê©_£nd_IPI_Æl
,

209 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

211 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

214 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

215 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

217 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

218 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

219 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

220 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

221 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

222 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

230 
	$physÊ©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

232 #ifde‡
CONFIG_ACPI


238 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

239 (
a˝i_gbl_FADT
.
Êags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`¥ötk
(
KERN_DEBUG
 "system APIC only can useÖhysical flat");

246 
	}
}

248 c⁄° 
˝umask
 *
	$physÊ©_èrgë_˝us
()

250  
˝u_⁄löe_mask
;

251 
	}
}

253 
	$physÊ©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

255 
	`˝umask_˛ór
(
ªtmask
);

256 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

257 
	}
}

259 
	$physÊ©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

261 
	`deÁu…_£nd_IPI_mask_£quí˚_phys
(
˝umask
, 
ve˘‹
);

262 
	}
}

264 
	$physÊ©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *cpumask,

265 
ve˘‹
)

267 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝umask
, 
ve˘‹
);

268 
	}
}

270 
	$physÊ©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

272 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝u_⁄löe_mask
, 
ve˘‹
);

273 
	}
}

275 
	$physÊ©_£nd_IPI_Æl
(
ve˘‹
)

277 
	`physÊ©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

278 
	}
}

280 
	$physÊ©_˝u_mask_to_≠icid
(c⁄° 
˝umask
 *cpumask)

282 
˝u
;

288 
˝u
 = 
	`˝umask_fú°
(
˝umask
);

289 i‡(()
˝u
 < 
ƒ_˝u_ids
)

290  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

292  
BAD_APICID
;

293 
	}
}

296 
	$physÊ©_˝u_mask_to_≠icid_™d
(c⁄° 
˝umask
 *cpumask,

297 c⁄° 
˝umask
 *
™dmask
)

299 
˝u
;

305 
	`f‹_óch_˝u_™d
(
˝u
, 
˝umask
, 
™dmask
) {

306 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_⁄löe_mask
))

309 i‡(
˝u
 < 
ƒ_˝u_ids
)

310  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

312  
BAD_APICID
;

313 
	}
}

315 
≠ic
 
	g≠ic_physÊ©
 = {

317 .
«me
 = "physical flat",

318 .
	g¥obe
 = 
NULL
,

319 .
	ga˝i_madt_€m_check
 = 
physÊ©_a˝i_madt_€m_check
,

320 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

322 .
	gúq_dñivîy_mode
 = 
de°_Fixed
,

323 .
	gúq_de°_mode
 = 0,

325 .
	gèrgë_˝us
 = 
physÊ©_èrgë_˝us
,

326 .
	gdißbÀ_e§
 = 0,

327 .
	gde°_logiˇl
 = 0,

328 .
	gcheck_≠icid_u£d
 = 
NULL
,

329 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

331 .
	gve˘‹_Æloˇti⁄_domaö
 = 
physÊ©_ve˘‹_Æloˇti⁄_domaö
,

333 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

335 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

336 .
	g£tup_≠ic_routög
 = 
NULL
,

337 .
	gmu…i_timî_check
 = 
NULL
,

338 .
	g≠icid_to_node
 = 
NULL
,

339 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

340 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

341 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

342 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

343 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

344 .
	gíabÀ_≠ic_mode
 = 
NULL
,

345 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

346 .
	gmps_€m_check
 = 
NULL
,

348 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

349 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

350 .
	g≠ic_id_mask
 = 0xFFu << 24,

352 .
	g˝u_mask_to_≠icid
 = 
physÊ©_˝u_mask_to_≠icid
,

353 .
	g˝u_mask_to_≠icid_™d
 = 
physÊ©_˝u_mask_to_≠icid_™d
,

355 .
	g£nd_IPI_mask
 = 
physÊ©_£nd_IPI_mask
,

356 .
	g£nd_IPI_mask_Ælbut£lf
 = 
physÊ©_£nd_IPI_mask_Ælbut£lf
,

357 .
	g£nd_IPI_Ælbut£lf
 = 
physÊ©_£nd_IPI_Ælbut£lf
,

358 .
	g£nd_IPI_Æl
 = 
physÊ©_£nd_IPI_Æl
,

359 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

361 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

362 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

363 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

364 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

365 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

367 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

368 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

369 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

370 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

371 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

372 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<löux/mm.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/sched.h
>

28 
	~<löux/pci.h
>

29 
	~<löux/mc146818πc.h
>

30 
	~<löux/compûî.h
>

31 
	~<löux/a˝i.h
>

32 
	~<löux/moduÀ.h
>

33 
	~<löux/sysdev.h
>

34 
	~<löux/msi.h
>

35 
	~<löux/htúq.h
>

36 
	~<löux/‰ìzî.h
>

37 
	~<löux/kthªad.h
>

38 
	~<löux/jiffõs.h
>

39 #ifde‡
CONFIG_ACPI


40 
	~<a˝i/a˝i_bus.h
>

42 
	~<löux/boŸmem.h
>

43 
	~<löux/dm¨.h
>

44 
	~<löux/h≥t.h
>

46 
	~<asm/idÀ.h
>

47 
	~<asm/io.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/˝u.h
>

50 
	~<asm/desc.h
>

51 
	~<asm/¥Ÿo.h
>

52 
	~<asm/a˝i.h
>

53 
	~<asm/dma.h
>

54 
	~<asm/timî.h
>

55 
	~<asm/i8259.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/msidef.h
>

58 
	~<asm/hy≥πøn•‹t.h
>

59 
	~<asm/£tup.h
>

60 
	~<asm/úq_ªm≠pög.h
>

61 
	~<asm/h≥t.h
>

62 
	~<asm/hw_úq.h
>

63 
	~<asm/uv/uv_hub.h
>

64 
	~<asm/uv/uv_úq.h
>

66 
	~<asm/≠ic.h
>

68 
	#__≠icdebugöô
(
ty≥
Ëty≥ 
__öô


	)

69 
	#f‹_óch_úq_pö
(
íåy
, 
hód
) \

70 
íåy
 = 
hód
;É¡ry;É¡ry =É¡ry->
√xt
)

	)

76 
	gsis_≠ic_bug
 = -1;

78 
DEFINE_SPINLOCK
(
iﬂpic_lock
);

79 
DEFINE_SPINLOCK
(
ve˘‹_lock
);

84 
	gƒ_iﬂpic_ªgi°îs
[
MAX_IO_APICS
];

87 
mpc_iﬂpic
 
	gmp_iﬂpics
[
MAX_IO_APICS
];

88 
	gƒ_iﬂpics
;

91 
mp_iﬂpic_gsi
 
	gmp_gsi_routög
[
MAX_IO_APICS
];

94 
mpc_öt§c
 
	gmp_úqs
[
MAX_IRQ_SOURCES
];

97 
	gmp_úq_íåõs
;

100 
ƒ_Àgacy_úqs
 
	g__ªad_mo°ly
 = 
NR_IRQS_LEGACY
;

102 
	gƒ_úqs_gsi
 = 
NR_IRQS_LEGACY
;

104 #i‡
deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

105 
	gmp_bus_id_to_ty≥
[
MAX_MP_BUSSES
];

108 
DECLARE_BITMAP
(
mp_bus_nŸ_pci
, 
MAX_MP_BUSSES
);

110 
	gskù_iﬂpic_£tup
;

112 
	$¨ch_dißbÀ_smp_suµ‹t
()

114 #ifde‡
CONFIG_PCI


115 
noiﬂpicquúk
 = 1;

116 
noiﬂpi¸îouã
 = -1;

118 
skù_iﬂpic_£tup
 = 1;

119 
	}
}

121 
__öô
 
	$∑r£_nﬂpic
(*
°r
)

124 
	`¨ch_dißbÀ_smp_suµ‹t
();

126 
	}
}

127 
óæy_∑øm
("nﬂpic", 
∑r£_nﬂpic
);

129 
	súq_pö_li°
 {

130 
	m≠ic
, 
	mpö
;

131 
úq_pö_li°
 *
	m√xt
;

134 
úq_pö_li°
 *
	$gë_⁄e_‰ì_úq_2_pö
(
node
)

136 
úq_pö_li°
 *
pö
;

138 
pö
 = 
	`kzÆloc_node
((*pö), 
GFP_ATOMIC
, 
node
);

140  
pö
;

141 
	}
}

148 
	súq_cfg
 {

149 
úq_pö_li°
 *
	múq_2_pö
;

150 
˝umask_v¨_t
 
	mdomaö
;

151 
˝umask_v¨_t
 
	mﬁd_domaö
;

152 
	mmove_˛ónup_cou¡
;

153 
u8
 
	mve˘‹
;

154 
u8
 
	mmove_ö_¥ogªss
 : 1;

158 #ifde‡
CONFIG_SPARSE_IRQ


159 
úq_cfg
 
	gúq_cfgx
[] = {

161 
úq_cfg
 
úq_cfgx
[
NR_IRQS
] = {

163 [0] = { .
ve˘‹
 = 
IRQ0_VECTOR
, },

164 [1] = { .
ve˘‹
 = 
IRQ1_VECTOR
, },

165 [2] = { .
ve˘‹
 = 
IRQ2_VECTOR
, },

166 [3] = { .
ve˘‹
 = 
IRQ3_VECTOR
, },

167 [4] = { .
ve˘‹
 = 
IRQ4_VECTOR
, },

168 [5] = { .
ve˘‹
 = 
IRQ5_VECTOR
, },

169 [6] = { .
ve˘‹
 = 
IRQ6_VECTOR
, },

170 [7] = { .
ve˘‹
 = 
IRQ7_VECTOR
, },

171 [8] = { .
ve˘‹
 = 
IRQ8_VECTOR
, },

172 [9] = { .
ve˘‹
 = 
IRQ9_VECTOR
, },

173 [10] = { .
ve˘‹
 = 
IRQ10_VECTOR
, },

174 [11] = { .
ve˘‹
 = 
IRQ11_VECTOR
, },

175 [12] = { .
ve˘‹
 = 
IRQ12_VECTOR
, },

176 [13] = { .
ve˘‹
 = 
IRQ13_VECTOR
, },

177 [14] = { .
ve˘‹
 = 
IRQ14_VECTOR
, },

178 [15] = { .
ve˘‹
 = 
IRQ15_VECTOR
, },

181 
__öô
 
	$io_≠ic_dißbÀ_Àgacy
()

183 
ƒ_Àgacy_úqs
 = 0;

184 
ƒ_úqs_gsi
 = 0;

185 
	}
}

187 
__öô
 
	$¨ch_óæy_úq_öô
()

189 
úq_cfg
 *
cfg
;

190 
úq_desc
 *
desc
;

191 
cou¡
;

192 
node
;

193 
i
;

195 
cfg
 = 
úq_cfgx
;

196 
cou¡
 = 
	`ARRAY_SIZE
(
úq_cfgx
);

197 
node

	`˝u_to_node
(
boŸ_˝u_id
);

199 
i
 = 0; i < 
cou¡
; i++) {

200 
desc
 = 
	`úq_to_desc
(
i
);

201 
desc
->
chù_d©a
 = &
cfg
[
i
];

202 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
domaö
, 
GFP_NOWAIT
, 
node
);

203 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
ﬁd_domaö
, 
GFP_NOWAIT
, 
node
);

204 i‡(
i
 < 
ƒ_Àgacy_úqs
)

205 
	`˝umask_£èŒ
(
cfg
[
i
].
domaö
);

209 
	}
}

211 #ifde‡
CONFIG_SPARSE_IRQ


212 
úq_cfg
 *
	$úq_cfg
(
úq
)

214 
úq_cfg
 *
cfg
 = 
NULL
;

215 
úq_desc
 *
desc
;

217 
desc
 = 
	`úq_to_desc
(
úq
);

218 i‡(
desc
)

219 
cfg
 = 
desc
->
chù_d©a
;

221  
cfg
;

222 
	}
}

224 
úq_cfg
 *
	$gë_⁄e_‰ì_úq_cfg
(
node
)

226 
úq_cfg
 *
cfg
;

228 
cfg
 = 
	`kzÆloc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

229 i‡(
cfg
) {

230 i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
domaö
, 
GFP_ATOMIC
, 
node
)) {

231 
	`k‰ì
(
cfg
);

232 
cfg
 = 
NULL
;

233 } i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
ﬁd_domaö
,

234 
GFP_ATOMIC
, 
node
)) {

235 
	`‰ì_˝umask_v¨
(
cfg
->
domaö
);

236 
	`k‰ì
(
cfg
);

237 
cfg
 = 
NULL
;

241  
cfg
;

242 
	}
}

244 
	$¨ch_öô_chù_d©a
(
úq_desc
 *
desc
, 
node
)

246 
úq_cfg
 *
cfg
;

248 
cfg
 = 
desc
->
chù_d©a
;

249 i‡(!
cfg
) {

250 
desc
->
chù_d©a
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

251 i‡(!
desc
->
chù_d©a
) {

252 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_cfg\n");

253 
	`BUG_ON
(1);

258 
	}
}

262 
	$öô_c›y_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
, 
node
)

264 
úq_pö_li°
 *
ﬁd_íåy
, *
hód
, *
èû
, *
íåy
;

266 
cfg
->
úq_2_pö
 = 
NULL
;

267 
ﬁd_íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

268 i‡(!
ﬁd_íåy
)

271 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

272 i‡(!
íåy
)

275 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

276 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

277 
hód
 = 
íåy
;

278 
èû
 = 
íåy
;

279 
ﬁd_íåy
 = old_íåy->
√xt
;

280 
ﬁd_íåy
) {

281 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

282 i‡(!
íåy
) {

283 
íåy
 = 
hód
;

284 
íåy
) {

285 
hód
 = 
íåy
->
√xt
;

286 
	`k‰ì
(
íåy
);

287 
íåy
 = 
hód
;

292 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

293 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

294 
èû
->
√xt
 = 
íåy
;

295 
èû
 = 
íåy
;

296 
ﬁd_íåy
 = old_íåy->
√xt
;

299 
èû
->
√xt
 = 
NULL
;

300 
cfg
->
úq_2_pö
 = 
hód
;

301 
	}
}

303 
	$‰ì_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
)

305 
úq_pö_li°
 *
íåy
, *
√xt
;

307 i‡(
ﬁd_cfg
->
úq_2_pö
 =
cfg
->irq_2_pin)

310 
íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

312 
íåy
) {

313 
√xt
 = 
íåy
->next;

314 
	`k‰ì
(
íåy
);

315 
íåy
 = 
√xt
;

317 
ﬁd_cfg
->
úq_2_pö
 = 
NULL
;

318 
	}
}

320 
	$¨ch_öô_c›y_chù_d©a
(
úq_desc
 *
ﬁd_desc
,

321 
úq_desc
 *
desc
, 
node
)

323 
úq_cfg
 *
cfg
;

324 
úq_cfg
 *
ﬁd_cfg
;

326 
cfg
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

328 i‡(!
cfg
)

331 
desc
->
chù_d©a
 = 
cfg
;

333 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

335 
	`mem˝y
(
cfg
, 
ﬁd_cfg
, (
úq_cfg
));

337 
	`öô_c›y_úq_2_pö
(
ﬁd_cfg
, 
cfg
, 
node
);

338 
	}
}

340 
	$‰ì_úq_cfg
(
úq_cfg
 *
ﬁd_cfg
)

342 
	`k‰ì
(
ﬁd_cfg
);

343 
	}
}

345 
	$¨ch_‰ì_chù_d©a
(
úq_desc
 *
ﬁd_desc
, úq_des¯*
desc
)

347 
úq_cfg
 *
ﬁd_cfg
, *
cfg
;

349 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

350 
cfg
 = 
desc
->
chù_d©a
;

352 i‡(
ﬁd_cfg
 =
cfg
)

355 i‡(
ﬁd_cfg
) {

356 
	`‰ì_úq_2_pö
(
ﬁd_cfg
, 
cfg
);

357 
	`‰ì_úq_cfg
(
ﬁd_cfg
);

358 
ﬁd_desc
->
chù_d©a
 = 
NULL
;

360 
	}
}

364 
úq_cfg
 *
	$úq_cfg
(
úq
)

366  
úq
 < 
ƒ_úqs
 ? 
úq_cfgx
 + irq : 
NULL
;

367 
	}
}

371 
	sio_≠ic
 {

372 
	mödex
;

373 
	munu£d
[3];

374 
	md©a
;

375 
	munu£d2
[11];

376 
	meoi
;

379 
__©åibuã_c⁄°__
 
io_≠ic
 
__iomem
 *
	$io_≠ic_ba£
(
idx
)

381  (
__iomem
 *Ë
	`__fix_to_vút
(
FIX_IO_APIC_BASE_0
 + 
idx
)

382 + (
mp_iﬂpics
[
idx
].
≠iˇddr
 & ~
PAGE_MASK
);

383 
	}
}

385 
ölöe
 
	$io_≠ic_eoi
(
≠ic
, 
ve˘‹
)

387 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

388 
	`wrôñ
(
ve˘‹
, &
io_≠ic
->
eoi
);

389 
	}
}

391 
ölöe
 
	$io_≠ic_ªad
(
≠ic
, 
ªg
)

393 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

394 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

395  
	`ªadl
(&
io_≠ic
->
d©a
);

396 
	}
}

398 
ölöe
 
	$io_≠ic_wrôe
(
≠ic
, 
ªg
, 
vÆue
)

400 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

401 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

402 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

403 
	}
}

411 
ölöe
 
	$io_≠ic_modify
(
≠ic
, 
ªg
, 
vÆue
)

413 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

415 i‡(
sis_≠ic_bug
)

416 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

417 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

418 
	}
}

420 
boﬁ
 
	$io_≠ic_Àvñ_ack_≥ndög
(
úq_cfg
 *
cfg
)

422 
úq_pö_li°
 *
íåy
;

423 
Êags
;

425 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

426 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

427 
ªg
;

428 
pö
;

430 
pö
 = 
íåy
->pin;

431 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
*2);

433 i‡(
ªg
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

434 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

435  
åue
;

438 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

440  
Ál£
;

441 
	}
}

443 
	uíåy_uni⁄
 {

444 °ru˘ { 
u32
 
	mw1
, 
	mw2
; };

445 
IO_APIC_rouã_íåy
 
	míåy
;

448 
IO_APIC_rouã_íåy
 
	$iﬂpic_ªad_íåy
(
≠ic
, 
pö
)

450 
íåy_uni⁄
 
eu
;

451 
Êags
;

452 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

453 
eu
.
w1
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 2 * 
pö
);

454 
eu
.
w2
 = 
	`io_≠ic_ªad
(
≠ic
, 0x11 + 2 * 
pö
);

455 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

456  
eu
.
íåy
;

457 
	}
}

466 
	$__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

468 
íåy_uni⁄
 
eu
 = {{0, 0}};

470 
eu
.
íåy
 = 
e
;

471 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

472 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

473 
	}
}

475 
	$iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

477 
Êags
;

478 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

479 
	`__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
e
);

480 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

481 
	}
}

488 
	$iﬂpic_mask_íåy
(
≠ic
, 
pö
)

490 
Êags
;

491 
íåy_uni⁄
 
eu
 = { .
íåy
.
mask
 = 1 };

493 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

494 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

495 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

496 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

497 
	}
}

505 
	$add_pö_to_úq_node_n›™ic
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

507 
úq_pö_li°
 **
œ°
, *
íåy
;

510 
œ°
 = &
cfg
->
úq_2_pö
;

511 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

512 i‡(
íåy
->
≠ic
 =≠i¯&&É¡ry->
pö
 ==Öin)

514 
œ°
 = &
íåy
->
√xt
;

517 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

518 i‡(!
íåy
) {

519 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_pin_list (%d,%d,%d)\n",

520 
node
, 
≠ic
, 
pö
);

521  -
ENOMEM
;

523 
íåy
->
≠ic
 =ápic;

524 
íåy
->
pö
 =Öin;

526 *
œ°
 = 
íåy
;

528 
	}
}

530 
	$add_pö_to_úq_node
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

532 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
≠ic
, 
pö
))

533 
	`∑nic
("IO-APIC: failedÅoádd irq-pin. CanÇotÖroceed\n");

534 
	}
}

539 
__öô
 
	$ª∂a˚_pö_©_úq_node
(
úq_cfg
 *
cfg
, 
node
,

540 
ﬁd≠ic
, 
ﬁdpö
,

541 
√w≠ic
, 
√wpö
)

543 
úq_pö_li°
 *
íåy
;

545 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

546 i‡(
íåy
->
≠ic
 =
ﬁd≠ic
 &&É¡ry->
pö
 =
ﬁdpö
) {

547 
íåy
->
≠ic
 = 
√w≠ic
;

548 
íåy
->
pö
 = 
√wpö
;

555 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
√w≠ic
, 
√wpö
);

556 
	}
}

558 
io_≠ic_modify_úq
(
úq_cfg
 *
cfg
,

559 
mask_™d
, 
mask_‹
,

560 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

562 
pö
;

563 
úq_pö_li°
 *
íåy
;

565 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

566 
ªg
;

567 
pö
 = 
íåy
->pin;

568 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2);

569 
ªg
 &
mask_™d
;

570 
ªg
 |
mask_‹
;

571 
	`io_≠ic_modify
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2, 
ªg
);

572 i‡(
föÆ
)

573 
	`föÆ
(
íåy
);

575 
	}
}

577 
	$__unmask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

579 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

580 
	}
}

582 
	$io_≠ic_sync
(
úq_pö_li°
 *
íåy
)

588 
io_≠ic
 
__iomem
 *io_apic;

589 
io_≠ic
 = 
	`io_≠ic_ba£
(
íåy
->
≠ic
);

590 
	`ªadl
(&
io_≠ic
->
d©a
);

591 
	}
}

593 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

595 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_≠ic_sync
);

596 
	}
}

598 
	$__mask_™d_edge_IO_APIC_úq
(
úq_cfg
 *
cfg
)

600 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

601 
IO_APIC_REDIR_MASKED
, 
NULL
);

602 
	}
}

604 
	$__unmask_™d_Àvñ_IO_APIC_úq
(
úq_cfg
 *
cfg
)

606 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
,

607 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

608 
	}
}

610 
	$mask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

612 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

613 
Êags
;

615 
	`BUG_ON
(!
cfg
);

617 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

618 
	`__mask_IO_APIC_úq
(
cfg
);

619 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

620 
	}
}

622 
	$unmask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

624 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

625 
Êags
;

627 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

628 
	`__unmask_IO_APIC_úq
(
cfg
);

629 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

630 
	}
}

632 
	$mask_IO_APIC_úq
(
úq
)

634 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

636 
	`mask_IO_APIC_úq_desc
(
desc
);

637 
	}
}

638 
	$unmask_IO_APIC_úq
(
úq
)

640 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

642 
	`unmask_IO_APIC_úq_desc
(
desc
);

643 
	}
}

645 
	$˛ór_IO_APIC_pö
(
≠ic
, 
pö
)

647 
IO_APIC_rouã_íåy
 
íåy
;

650 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

651 i‡(
íåy
.
dñivîy_mode
 =
de°_SMI
)

656 
	`iﬂpic_mask_íåy
(
≠ic
, 
pö
);

657 
	}
}

659 
	$˛ór_IO_APIC
 ()

661 
≠ic
, 
pö
;

663 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

664 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

665 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

666 
	}
}

668 #ifde‡
CONFIG_X86_32


674 
	#MAX_PIRQS
 8

	)

675 
	gpúq_íåõs
[
MAX_PIRQS
] = {

676 [0 ... 
MAX_PIRQS
 - 1] = -1

679 
__öô
 
	$iﬂpic_púq_£tup
(*
°r
)

681 
i
, 
max
;

682 
öts
[
MAX_PIRQS
+1];

684 
	`gë_›ti⁄s
(
°r
, 
	`ARRAY_SIZE
(
öts
), ints);

686 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


688 
max
 = 
MAX_PIRQS
;

689 i‡(
öts
[0] < 
MAX_PIRQS
)

690 
max
 = 
öts
[0];

692 
i
 = 0; i < 
max
; i++) {

693 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


694 "... PIRQ%d -> IRQ %d\n", 
i
, 
öts
[i+1]);

698 
púq_íåõs
[
MAX_PIRQS
-
i
-1] = 
öts
[i+1];

701 
	}
}

703 
__£tup
("púq=", 
iﬂpic_púq_£tup
);

706 
IO_APIC_rouã_íåy
 **
	$Æloc_iﬂpic_íåõs
()

708 
≠ic
;

709 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
;

711 
iﬂpic_íåõs
 = 
	`kzÆloc
((*iﬂpic_íåõsË* 
ƒ_iﬂpics
,

712 
GFP_ATOMIC
);

713 i‡(!
iﬂpic_íåõs
)

716 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

717 
iﬂpic_íåõs
[
≠ic
] =

718 
	`kzÆloc
((
IO_APIC_rouã_íåy
) *

719 
ƒ_iﬂpic_ªgi°îs
[
≠ic
], 
GFP_ATOMIC
);

720 i‡(!
iﬂpic_íåõs
[
≠ic
])

721 
nomem
;

724  
iﬂpic_íåõs
;

726 
nomem
:

727 --
≠ic
 >= 0)

728 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

729 
	`k‰ì
(
iﬂpic_íåõs
);

732 
	}
}

737 
	$ßve_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

739 
≠ic
, 
pö
;

741 i‡(!
iﬂpic_íåõs
)

742  -
ENOMEM
;

744 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

745 i‡(!
iﬂpic_íåõs
[
≠ic
])

746  -
ENOMEM
;

748 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

749 
iﬂpic_íåõs
[
≠ic
][
pö
] =

750 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

754 
	}
}

759 
	$mask_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

761 
≠ic
, 
pö
;

763 i‡(!
iﬂpic_íåõs
)

766 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

767 i‡(!
iﬂpic_íåõs
[
≠ic
])

770 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

771 
IO_APIC_rouã_íåy
 
íåy
;

773 
íåy
 = 
iﬂpic_íåõs
[
≠ic
][
pö
];

774 i‡(!
íåy
.
mask
) {

775 
íåy
.
mask
 = 1;

776 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy
);

780 
	}
}

785 
	$ª°‹e_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

787 
≠ic
, 
pö
;

789 i‡(!
iﬂpic_íåõs
)

790  -
ENOMEM
;

792 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

793 i‡(!
iﬂpic_íåõs
[
≠ic
])

794  -
ENOMEM
;

796 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

797 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
,

798 
iﬂpic_íåõs
[
≠ic
][
pö
]);

801 
	}
}

803 
	$‰ì_iﬂpic_íåõs
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

805 
≠ic
;

807 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

808 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

810 
	`k‰ì
(
iﬂpic_íåõs
);

811 
	}
}

816 
	$föd_úq_íåy
(
≠ic
, 
pö
, 
ty≥
)

818 
i
;

820 
i
 = 0; i < 
mp_úq_íåõs
; i++)

821 i‡(
mp_úqs
[
i
].
úqty≥
 =
ty≥
 &&

822 (
mp_úqs
[
i
].
d°≠ic
 =
mp_iﬂpics
[
≠ic
].
≠icid
 ||

823 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
) &&

824 
mp_úqs
[
i
].
d°úq
 =
pö
)

825  
i
;

828 
	}
}

833 
__öô
 
	$föd_iß_úq_pö
(
úq
, 
ty≥
)

835 
i
;

837 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

838 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

840 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

841 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

842 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

844  
mp_úqs
[
i
].
d°úq
;

847 
	}
}

849 
__öô
 
	$föd_iß_úq_≠ic
(
úq
, 
ty≥
)

851 
i
;

853 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

854 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

856 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

857 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

858 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

861 i‡(
i
 < 
mp_úq_íåõs
) {

862 
≠ic
;

863 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

864 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
)

865  
≠ic
;

870 
	}
}

872 #i‡
deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

876 
	$EISA_ELCR
(
úq
)

878 i‡(
úq
 < 
ƒ_Àgacy_úqs
) {

879 
p‹t
 = 0x4d0 + (
úq
 >> 3);

880  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

882 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


883 "Brokí MPèbÀÑï‹t†ISA irq %d\n", 
úq
);

885 
	}
}

892 
	#deÁu…_ISA_åiggî
(
idx
Ë(0)

	)

893 
	#deÁu…_ISA_pﬁ¨ôy
(
idx
Ë(0)

	)

900 
	#deÁu…_EISA_åiggî
(
idx
Ë(
	`EISA_ELCR
(
mp_úqs
[idx].
§cbusúq
))

	)

901 
	#deÁu…_EISA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

906 
	#deÁu…_PCI_åiggî
(
idx
Ë(1)

	)

907 
	#deÁu…_PCI_pﬁ¨ôy
(
idx
Ë(1)

	)

912 
	#deÁu…_MCA_åiggî
(
idx
Ë(1)

	)

913 
	#deÁu…_MCA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

915 
	$MPBIOS_pﬁ¨ôy
(
idx
)

917 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

918 
pﬁ¨ôy
;

923 
mp_úqs
[
idx
].
úqÊag
 & 3)

926 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

927 
pﬁ¨ôy
 = 
	`deÁu…_ISA_pﬁ¨ôy
(
idx
);

929 
pﬁ¨ôy
 = 
	`deÁu…_PCI_pﬁ¨ôy
(
idx
);

933 
pﬁ¨ôy
 = 0;

938 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

939 
pﬁ¨ôy
 = 1;

944 
pﬁ¨ôy
 = 1;

949 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

950 
pﬁ¨ôy
 = 1;

954  
pﬁ¨ôy
;

955 
	}
}

957 
	$MPBIOS_åiggî
(
idx
)

959 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

960 
åiggî
;

965 (
mp_úqs
[
idx
].
úqÊag
>>2) & 3)

968 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

969 
åiggî
 = 
	`deÁu…_ISA_åiggî
(
idx
);

971 
åiggî
 = 
	`deÁu…_PCI_åiggî
(
idx
);

972 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

973 
mp_bus_id_to_ty≥
[
bus
]) {

974 
MP_BUS_ISA
:

979 
MP_BUS_EISA
:

981 
åiggî
 = 
	`deÁu…_EISA_åiggî
(
idx
);

984 
MP_BUS_PCI
:

989 
MP_BUS_MCA
:

991 
åiggî
 = 
	`deÁu…_MCA_åiggî
(
idx
);

996 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

997 
åiggî
 = 1;

1005 
åiggî
 = 0;

1010 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1011 
åiggî
 = 1;

1016 
åiggî
 = 1;

1021 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1022 
åiggî
 = 0;

1026  
åiggî
;

1027 
	}
}

1029 
ölöe
 
	$úq_pﬁ¨ôy
(
idx
)

1031  
	`MPBIOS_pﬁ¨ôy
(
idx
);

1032 
	}
}

1034 
ölöe
 
	$úq_åiggî
(
idx
)

1036  
	`MPBIOS_åiggî
(
idx
);

1037 
	}
}

1039 (*
iﬂpic_ªnumbî_úq
)(
iﬂpic
, 
úq
);

1040 
	$pö_2_úq
(
idx
, 
≠ic
, 
pö
)

1042 
úq
, 
i
;

1043 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

1048 i‡(
mp_úqs
[
idx
].
d°úq
 !
pö
)

1049 
	`¥ötk
(
KERN_ERR
 "broken BIOS or MPTABLEÖarser,áyiee!!\n");

1051 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1052 
úq
 = 
mp_úqs
[
idx
].
§cbusúq
;

1057 
i
 = 
úq
 = 0;

1058 
i
 < 
≠ic
)

1059 
úq
 +
ƒ_iﬂpic_ªgi°îs
[
i
++];

1060 
úq
 +
pö
;

1064 i‡(
iﬂpic_ªnumbî_úq
)

1065 
úq
 = 
	`iﬂpic_ªnumbî_úq
(
≠ic
, irq);

1068 #ifde‡
CONFIG_X86_32


1072 i‡((
pö
 >= 16) && (pin <= 23)) {

1073 i‡(
púq_íåõs
[
pö
-16] != -1) {

1074 i‡(!
púq_íåõs
[
pö
-16]) {

1075 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1076 "dißblög PIRQ%d\n", 
pö
-16);

1078 
úq
 = 
púq_íåõs
[
pö
-16];

1079 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1081 
pö
-16, 
úq
);

1087  
úq
;

1088 
	}
}

1094 
	$IO_APIC_gë_PCI_úq_ve˘‹
(
bus
, 
¶Ÿ
, 
pö
,

1095 
io_≠ic_úq_©å
 *
úq_©å
)

1097 
≠ic
, 
i
, 
be°_guess
 = -1;

1099 
	`≠ic_¥ötk
(
APIC_DEBUG
,

1101 
bus
, 
¶Ÿ
, 
pö
);

1102 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1103 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1104 "PCI BIOSÖas£dÇ⁄exi°íàPCI bu†%d!\n", 
bus
);

1107 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

1108 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

1110 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

1111 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
 ||

1112 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
)

1115 i‡(!
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

1116 !
mp_úqs
[
i
].
úqty≥
 &&

1117 (
bus
 =
lbus
) &&

1118 (
¶Ÿ
 =((
mp_úqs
[
i
].
§cbusúq
 >> 2) & 0x1f))) {

1119 
úq
 = 
	`pö_2_úq
(
i
, 
≠ic
, 
mp_úqs
[i].
d°úq
);

1121 i‡(!(
≠ic
 || 
	`IO_APIC_IRQ
(
úq
)))

1124 i‡(
pö
 =(
mp_úqs
[
i
].
§cbusúq
 & 3)) {

1125 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1126 
mp_úqs
[
i
].
d°úq
,

1127 
	`úq_åiggî
(
i
),

1128 
	`úq_pﬁ¨ôy
(
i
));

1129  
úq
;

1135 i‡(
be°_guess
 < 0) {

1136 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1137 
mp_úqs
[
i
].
d°úq
,

1138 
	`úq_åiggî
(
i
),

1139 
	`úq_pﬁ¨ôy
(
i
));

1140 
be°_guess
 = 
úq
;

1144  
be°_guess
;

1145 
	}
}

1146 
EXPORT_SYMBOL
(
IO_APIC_gë_PCI_úq_ve˘‹
);

1148 
	$lock_ve˘‹_lock
()

1153 
	`•ö_lock
(&
ve˘‹_lock
);

1154 
	}
}

1156 
	$u∆ock_ve˘‹_lock
()

1158 
	`•ö_u∆ock
(&
ve˘‹_lock
);

1159 
	}
}

1162 
	$__assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1175 
cuºít_ve˘‹
 = 
FIRST_DEVICE_VECTOR
, 
cuºít_off£t
 = 0;

1176 
ﬁd_ve˘‹
;

1177 
˝u
, 
îr
;

1178 
˝umask_v¨_t
 
tmp_mask
;

1180 i‡((
cfg
->
move_ö_¥ogªss
Ë|| cfg->
move_˛ónup_cou¡
)

1181  -
EBUSY
;

1183 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_mask
, 
GFP_ATOMIC
))

1184  -
ENOMEM
;

1186 
ﬁd_ve˘‹
 = 
cfg
->
ve˘‹
;

1187 i‡(
ﬁd_ve˘‹
) {

1188 
	`˝umask_™d
(
tmp_mask
, 
mask
, 
˝u_⁄löe_mask
);

1189 
	`˝umask_™d
(
tmp_mask
, 
cfg
->
domaö
,Åmp_mask);

1190 i‡(!
	`˝umask_em±y
(
tmp_mask
)) {

1191 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1197 
îr
 = -
ENOSPC
;

1198 
	`f‹_óch_˝u_™d
(
˝u
, 
mask
, 
˝u_⁄löe_mask
) {

1199 
√w_˝u
;

1200 
ve˘‹
, 
off£t
;

1202 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
tmp_mask
);

1204 
ve˘‹
 = 
cuºít_ve˘‹
;

1205 
off£t
 = 
cuºít_off£t
;

1206 
√xt
:

1207 
ve˘‹
 += 8;

1208 i‡(
ve˘‹
 >
fú°_sy°em_ve˘‹
) {

1210 
off£t
 = (offset + 1) % 8;

1211 
ve˘‹
 = 
FIRST_DEVICE_VECTOR
 + 
off£t
;

1213 i‡(
	`u∆ikñy
(
cuºít_ve˘‹
 =
ve˘‹
))

1216 i‡(
	`ã°_bô
(
ve˘‹
, 
u£d_ve˘‹s
))

1217 
√xt
;

1219 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1220 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] != -1)

1221 
√xt
;

1223 
cuºít_ve˘‹
 = 
ve˘‹
;

1224 
cuºít_off£t
 = 
off£t
;

1225 i‡(
ﬁd_ve˘‹
) {

1226 
cfg
->
move_ö_¥ogªss
 = 1;

1227 
	`˝umask_c›y
(
cfg
->
ﬁd_domaö
, cfg->
domaö
);

1229 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1230 
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] = 
úq
;

1231 
cfg
->
ve˘‹
 = vector;

1232 
	`˝umask_c›y
(
cfg
->
domaö
, 
tmp_mask
);

1233 
îr
 = 0;

1236 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1237  
îr
;

1238 
	}
}

1241 
	$assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1243 
îr
;

1244 
Êags
;

1246 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

1247 
îr
 = 
	`__assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
);

1248 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

1249  
îr
;

1250 
	}
}

1252 
	$__˛ór_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
)

1254 
˝u
, 
ve˘‹
;

1256 
	`BUG_ON
(!
cfg
->
ve˘‹
);

1258 
ve˘‹
 = 
cfg
->vector;

1259 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
domaö
, 
˝u_⁄löe_mask
)

1260 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1262 
cfg
->
ve˘‹
 = 0;

1263 
	`˝umask_˛ór
(
cfg
->
domaö
);

1265 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

1267 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
) {

1268 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
;

1269 
ve˘‹
++) {

1270 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] !
úq
)

1272 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1276 
cfg
->
move_ö_¥ogªss
 = 0;

1277 
	}
}

1279 
	$__£tup_ve˘‹_úq
(
˝u
)

1283 
úq
, 
ve˘‹
;

1284 
úq_cfg
 *
cfg
;

1285 
úq_desc
 *
desc
;

1288 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1289 
cfg
 = 
desc
->
chù_d©a
;

1290 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1292 
ve˘‹
 = 
cfg
->vector;

1293 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = 
úq
;

1296 
ve˘‹
 = 0; ve˘‹ < 
NR_VECTORS
; ++vector) {

1297 
úq
 = 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
];

1298 i‡(
úq
 < 0)

1301 
cfg
 = 
	`úq_cfg
(
úq
);

1302 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1303 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1305 
	}
}

1307 
úq_chù
 
	giﬂpic_chù
;

1308 
úq_chù
 
	gú_iﬂpic_chù
;

1310 
	#IOAPIC_AUTO
 -1

	)

1311 
	#IOAPIC_EDGE
 0

	)

1312 
	#IOAPIC_LEVEL
 1

	)

1314 #ifde‡
CONFIG_X86_32


1315 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1317 
≠ic
, 
idx
, 
pö
;

1319 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1320 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1321 
idx
 = 
	`föd_úq_íåy
(
≠ic
, 
pö
, 
mp_INT
);

1322 i‡((
idx
 !-1Ë&& (
úq
 =
	`pö_2_úq
(idx, 
≠ic
, 
pö
)))

1323  
	`úq_åiggî
(
idx
);

1330 
	}
}

1332 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1335 
	}
}

1338 
	$iﬂpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
, 
åiggî
)

1341 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1342 
åiggî
 =
IOAPIC_LEVEL
)

1343 
desc
->
°©us
 |
IRQ_LEVEL
;

1345 
desc
->
°©us
 &~
IRQ_LEVEL
;

1347 i‡(
	`úq_ªm≠≥d
(
úq
)) {

1348 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

1349 i‡(
åiggî
)

1350 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1351 
h™dÀ_Á°eoi_úq
,

1354 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1355 
h™dÀ_edge_úq
, "edge");

1359 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1360 
åiggî
 =
IOAPIC_LEVEL
)

1361 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1362 
h™dÀ_Á°eoi_úq
,

1365 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1366 
h™dÀ_edge_úq
, "edge");

1367 
	}
}

1369 
	$£tup_iﬂpic_íåy
(
≠ic_id
, 
úq
,

1370 
IO_APIC_rouã_íåy
 *
íåy
,

1371 
de°ö©i⁄
, 
åiggî
,

1372 
pﬁ¨ôy
, 
ve˘‹
, 
pö
)

1377 
	`mem£t
(
íåy
,0,(*entry));

1379 i‡(
öå_ªm≠pög_íabÀd
) {

1380 
öãl_iommu
 *
iommu
 = 
	`m≠_iﬂpic_to_ú
(
≠ic_id
);

1381 
úã
 irte;

1382 
IR_IO_APIC_rouã_íåy
 *
ú_íåy
 =

1383 (
IR_IO_APIC_rouã_íåy
 *Ë
íåy
;

1384 
ödex
;

1386 i‡(!
iommu
)

1387 
	`∑nic
("Nÿm≠pög iommu f‹ iﬂpi¯%d\n", 
≠ic_id
);

1389 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

1390 i‡(
ödex
 < 0)

1391 
	`∑nic
("FaûedÅÿÆloˇã IRTE f‹ iﬂpi¯%d\n", 
≠ic_id
);

1393 
	`mem£t
(&
úã
, 0, (irte));

1395 
úã
.
¥e£¡
 = 1;

1396 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

1404 
úã
.
åiggî_mode
 = 0;

1405 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1406 
úã
.
ve˘‹
 = vector;

1407 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°ö©i⁄
);

1410 
	`£t_iﬂpic_sid
(&
úã
, 
≠ic_id
);

1412 
	`modify_úã
(
úq
, &
úã
);

1414 
ú_íåy
->
ödex2
 = (
ödex
 >> 15) & 0x1;

1415 
ú_íåy
->
zîo
 = 0;

1416 
ú_íåy
->
f‹m©
 = 1;

1417 
ú_íåy
->
ödex
 = (index & 0x7fff);

1422 
ú_íåy
->
ve˘‹
 = 
pö
;

1424 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1425 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1426 
íåy
->
de°
 = 
de°ö©i⁄
;

1427 
íåy
->
ve˘‹
 = vector;

1430 
íåy
->
mask
 = 0;

1431 
íåy
->
åiggî
 =Årigger;

1432 
íåy
->
pﬁ¨ôy
 =Öolarity;

1437 i‡(
åiggî
)

1438 
íåy
->
mask
 = 1;

1440 
	}
}

1442 
	$£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
úq_desc
 *
desc
,

1443 
åiggî
, 
pﬁ¨ôy
)

1445 
úq_cfg
 *
cfg
;

1446 
IO_APIC_rouã_íåy
 
íåy
;

1447 
de°
;

1449 i‡(!
	`IO_APIC_IRQ
(
úq
))

1452 
cfg
 = 
desc
->
chù_d©a
;

1454 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
()))

1457 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

1459 
	`≠ic_¥ötk
(
APIC_VERBOSE
,
KERN_DEBUG


1462 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
, 
pö
, 
cfg
->
ve˘‹
,

1463 
úq
, 
åiggî
, 
pﬁ¨ôy
);

1466 i‡(
	`£tup_iﬂpic_íåy
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
úq
, &
íåy
,

1467 
de°
, 
åiggî
, 
pﬁ¨ôy
, 
cfg
->
ve˘‹
, 
pö
)) {

1468 
	`¥ötk
("FailedÅo setup ioapicÉntry for ioapic %d,Öin %d\n",

1469 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1470 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

1474 
	`iﬂpic_ªgi°î_öå
(
úq
, 
desc
, 
åiggî
);

1475 i‡(
úq
 < 
ƒ_Àgacy_úqs
)

1476 
	`dißbÀ_8259A_úq
(
úq
);

1478 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1479 
	}
}

1482 
DECLARE_BITMAP
(
pö_¥ogømmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

1483 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

1485 
__öô
 
	$£tup_IO_APIC_úqs
()

1487 
≠ic_id
 = 0, 
pö
, 
idx
, 
úq
;

1488 
nŸc⁄
 = 0;

1489 
úq_desc
 *
desc
;

1490 
úq_cfg
 *
cfg
;

1491 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1493 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1495 #ifde‡
CONFIG_ACPI


1496 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

1497 
≠ic_id
 = 
	`mp_föd_iﬂpic
(0);

1498 i‡(
≠ic_id
 < 0)

1499 
≠ic_id
 = 0;

1503 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic_id
];Öin++) {

1504 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1505 i‡(
idx
 == -1) {

1506 i‡(!
nŸc⁄
) {

1507 
nŸc⁄
 = 1;

1508 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1509 
KERN_DEBUG
 " %d-%d",

1510 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1512 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " %d-%d",

1513 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1516 i‡(
nŸc⁄
) {

1517 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1519 
nŸc⁄
 = 0;

1522 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1528 i‡(
≠ic
->
mu…i_timî_check
 &&

1529 
≠ic
->
	`mu…i_timî_check
(
≠ic_id
, 
úq
))

1532 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1533 i‡(!
desc
) {

1534 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1537 
cfg
 = 
desc
->
chù_d©a
;

1538 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1543 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1544 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1547 i‡(
nŸc⁄
)

1548 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1550 
	}
}

1555 
__öô
 
	$£tup_timî_IRQ0_pö
(
≠ic_id
, 
pö
,

1556 
ve˘‹
)

1558 
IO_APIC_rouã_íåy
 
íåy
;

1560 i‡(
öå_ªm≠pög_íabÀd
)

1563 
	`mem£t
(&
íåy
, 0, (entry));

1569 
íåy
.
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1570 
íåy
.
mask
 = 0;

1571 
íåy
.
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
◊pic->
	`èrgë_˝us
());

1572 
íåy
.
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1573 
íåy
.
pﬁ¨ôy
 = 0;

1574 
íåy
.
åiggî
 = 0;

1575 
íåy
.
ve˘‹
 = vector;

1581 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

1586 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1587 
	}
}

1590 
	$__≠icdebugöô
(Ë
	$¥öt_IO_APIC
()

1592 
≠ic
, 
i
;

1593 
IO_APIC_ªg_00
 
ªg_00
;

1594 
IO_APIC_ªg_01
 
ªg_01
;

1595 
IO_APIC_ªg_02
 
ªg_02
;

1596 
IO_APIC_ªg_03
 
ªg_03
;

1597 
Êags
;

1598 
úq_cfg
 *
cfg
;

1599 
úq_desc
 *
desc
;

1600 
úq
;

1602 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1605 
	`¥ötk
(
KERN_DEBUG
 "numbî o‡MP IRQ sour˚s: %d.\n", 
mp_úq_íåõs
);

1606 
i
 = 0; i < 
ƒ_iﬂpics
; i++)

1607 
	`¥ötk
(
KERN_DEBUG
 "number of IO-APIC #%dÑegisters: %d.\n",

1608 
mp_iﬂpics
[
i
].
≠icid
, 
ƒ_iﬂpic_ªgi°îs
[i]);

1614 
	`¥ötk
(
KERN_INFO
 "testingÅhe IO APIC.......................\n");

1616 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1618 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1619 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 0);

1620 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1621 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x10)

1622 
ªg_02
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 2);

1623 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x20)

1624 
ªg_03
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 3);

1625 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1627 
	`¥ötk
("\n");

1628 
	`¥ötk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_iﬂpics
[
≠ic
].
≠icid
);

1629 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #00: %08X\n", 
ªg_00
.
øw
);

1630 
	`¥ötk
(
KERN_DEBUG
 "....... :Öhysiˇ»APIC id: %02X\n", 
ªg_00
.
bôs
.
ID
);

1631 
	`¥ötk
(
KERN_DEBUG
 "....... : Dñivîy Ty≥: %X\n", 
ªg_00
.
bôs
.
dñivîy_ty≥
);

1632 
	`¥ötk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
ªg_00
.
bôs
.
LTS
);

1634 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #01: %08X\n", *(*)&
ªg_01
);

1635 
	`¥ötk
(
KERN_DEBUG
 "....... : maxÑedúe˘i⁄É¡rõs: %04X\n", 
ªg_01
.
bôs
.
íåõs
);

1637 
	`¥ötk
(
KERN_DEBUG
 "....... : PRQ im∂emíãd: %X\n", 
ªg_01
.
bôs
.
PRQ
);

1638 
	`¥ötk
(
KERN_DEBUG
 "....... : IO APIC vîsi⁄: %04X\n", 
ªg_01
.
bôs
.
vîsi⁄
);

1645 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x10 && 
ªg_02
.
øw
 !=Ñeg_01.raw) {

1646 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #02: %08X\n", 
ªg_02
.
øw
);

1647 
	`¥ötk
(
KERN_DEBUG
 "....... :árbôøti⁄: %02X\n", 
ªg_02
.
bôs
.
¨bôøti⁄
);

1655 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x20 && 
ªg_03
.
øw
 !
ªg_02
.raw &&

1656 
ªg_03
.
øw
 !
ªg_01
.raw) {

1657 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #03: %08X\n", 
ªg_03
.
øw
);

1658 
	`¥ötk
(
KERN_DEBUG
 "....... : BoŸ DT : %X\n", 
ªg_03
.
bôs
.
boŸ_DT
);

1661 
	`¥ötk
(
KERN_DEBUG
 ".... IRQÑedirectionÅable:\n");

1663 
	`¥ötk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1666 
i
 = 0; i <
ªg_01
.
bôs
.
íåõs
; i++) {

1667 
IO_APIC_rouã_íåy
 
íåy
;

1669 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
i
);

1671 
	`¥ötk
(
KERN_DEBUG
 " %02x %03X ",

1672 
i
,

1673 
íåy
.
de°


1676 
	`¥ötk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1677 
íåy
.
mask
,

1678 
íåy
.
åiggî
,

1679 
íåy
.
úr
,

1680 
íåy
.
pﬁ¨ôy
,

1681 
íåy
.
dñivîy_°©us
,

1682 
íåy
.
de°_mode
,

1683 
íåy
.
dñivîy_mode
,

1684 
íåy
.
ve˘‹


1688 
	`¥ötk
(
KERN_DEBUG
 "IRQÅoÖin mappings:\n");

1689 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1690 
úq_pö_li°
 *
íåy
;

1692 
cfg
 = 
desc
->
chù_d©a
;

1693 
íåy
 = 
cfg
->
úq_2_pö
;

1694 i‡(!
íåy
)

1696 
	`¥ötk
(
KERN_DEBUG
 "IRQ%d ", 
úq
);

1697 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

1698 
	`¥ötk
("-> %d:%d", 
íåy
->
≠ic
,É¡ry->
pö
);

1699 
	`¥ötk
("\n");

1702 
	`¥ötk
(
KERN_INFO
 ".................................... done.\n");

1705 
	}
}

1707 
	$__≠icdebugöô
(Ë
	$¥öt_APIC_fõld
(
ba£
)

1709 
i
;

1711 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1714 
	`¥ötk
(
KERN_DEBUG
);

1716 
i
 = 0; i < 8; i++)

1717 
	`¥ötk
(
KERN_CONT
 "%08x", 
	`≠ic_ªad
(
ba£
 + 
i
*0x10));

1719 
	`¥ötk
(
KERN_CONT
 "\n");

1720 
	}
}

1722 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APIC
(*
dummy
)

1724 
i
, 
v
, 
vî
, 
maxlvt
;

1725 
u64
 
i¸
;

1727 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1730 
	`¥ötk
(
KERN_DEBUG
 "printingÜocal APIC contents on CPU#%d/%d:\n",

1731 
	`smp_¥o˚ss‹_id
(), 
	`h¨d_smp_¥o˚ss‹_id
());

1732 
v
 = 
	`≠ic_ªad
(
APIC_ID
);

1733 
	`¥ötk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`ªad_≠ic_id
());

1734 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

1735 
	`¥ötk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1736 
vî
 = 
	`GET_APIC_VERSION
(
v
);

1737 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1739 
v
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1740 
	`¥ötk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1742 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1743 i‡(!
	`APIC_XAPIC
(
vî
)) {

1744 
v
 = 
	`≠ic_ªad
(
APIC_ARBPRI
);

1745 
	`¥ötk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1746 
v
 & 
APIC_ARBPRI_MASK
);

1748 
v
 = 
	`≠ic_ªad
(
APIC_PROCPRI
);

1749 
	`¥ötk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1756 i‡(!
	`APIC_INTEGRATED
(
vî
Ë|| 
maxlvt
 == 3) {

1757 
v
 = 
	`≠ic_ªad
(
APIC_RRR
);

1758 
	`¥ötk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1761 
v
 = 
	`≠ic_ªad
(
APIC_LDR
);

1762 
	`¥ötk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1763 i‡(!
	`x2≠ic_íabÀd
()) {

1764 
v
 = 
	`≠ic_ªad
(
APIC_DFR
);

1765 
	`¥ötk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1767 
v
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1768 
	`¥ötk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1770 
	`¥ötk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1771 
	`¥öt_APIC_fõld
(
APIC_ISR
);

1772 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1773 
	`¥öt_APIC_fõld
(
APIC_TMR
);

1774 
	`¥ötk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1775 
	`¥öt_APIC_fõld
(
APIC_IRR
);

1777 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1778 i‡(
maxlvt
 > 3)

1779 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1781 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1782 
	`¥ötk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1785 
i¸
 = 
	`≠ic_i¸_ªad
();

1786 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
i¸
);

1787 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
i¸
 >> 32));

1789 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1790 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1792 i‡(
maxlvt
 > 3) {

1793 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1794 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1796 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1797 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1798 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1799 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1801 i‡(
maxlvt
 > 2) {

1802 
v
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1803 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1806 
v
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1807 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1808 
v
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

1809 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1810 
v
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1811 
	`¥ötk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1813 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_EXTAPIC
)) {

1814 
v
 = 
	`≠ic_ªad
(
APIC_EFEAT
);

1815 
maxlvt
 = (
v
 >> 16) & 0xff;

1816 
	`¥ötk
(
KERN_DEBUG
 "... APIC EFEAT: %08x\n", 
v
);

1817 
v
 = 
	`≠ic_ªad
(
APIC_ECTRL
);

1818 
	`¥ötk
(
KERN_DEBUG
 "... APIC ECTRL: %08x\n", 
v
);

1819 
i
 = 0; i < 
maxlvt
; i++) {

1820 
v
 = 
	`≠ic_ªad
(
	`APIC_EILVTn
(
i
));

1821 
	`¥ötk
(
KERN_DEBUG
 "... APIC EILVT%d: %08x\n", 
i
, 
v
);

1824 
	`¥ötk
("\n");

1825 
	}
}

1827 
	$__≠icdebugöô
(Ë
	$¥öt_Æl_loˇl_APICs
()

1829 
˝u
;

1831 
	`¥ìm±_dißbÀ
();

1832 
	`f‹_óch_⁄löe_˝u
(
˝u
)

1833 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
¥öt_loˇl_APIC
, 
NULL
, 1);

1834 
	`¥ìm±_íabÀ
();

1835 
	}
}

1837 
	$__≠icdebugöô
(Ë
	$¥öt_PIC
()

1839 
v
;

1840 
Êags
;

1842 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
 || !
ƒ_Àgacy_úqs
)

1845 
	`¥ötk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1847 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

1849 
v
 = 
	`öb
(0xa1) << 8 | inb(0x21);

1850 
	`¥ötk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1852 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1853 
	`¥ötk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1855 
	`outb
(0x0b,0xa0);

1856 
	`outb
(0x0b,0x20);

1857 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1858 
	`outb
(0x0a,0xa0);

1859 
	`outb
(0x0a,0x20);

1861 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

1863 
	`¥ötk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1865 
v
 = 
	`öb
(0x4d1) << 8 | inb(0x4d0);

1866 
	`¥ötk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1867 
	}
}

1869 
	$__≠icdebugöô
(Ë
	$¥öt_Æl_ICs
()

1871 
	`¥öt_PIC
();

1874 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

1877 
	`¥öt_Æl_loˇl_APICs
();

1878 
	`¥öt_IO_APIC
();

1881 
	}
}

1883 
fs_öôˇŒ
(
¥öt_Æl_ICs
);

1887 °ru˘ { 
	mpö
, 
	m≠ic
; } 
	giﬂpic_i8259
 = { -1, -1 };

1889 
__öô
 
	$íabÀ_IO_APIC
()

1891 
IO_APIC_ªg_01
 
ªg_01
;

1892 
i8259_≠ic
, 
i8259_pö
;

1893 
≠ic
;

1894 
Êags
;

1899 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1900 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1901 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1902 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1903 
ƒ_iﬂpic_ªgi°îs
[
≠ic
] = 
ªg_01
.
bôs
.
íåõs
+1;

1906 i‡(!
ƒ_Àgacy_úqs
)

1909 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1910 
pö
;

1912 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1913 
IO_APIC_rouã_íåy
 
íåy
;

1914 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

1919 i‡((
íåy
.
mask
 =0Ë&& (íåy.
dñivîy_mode
 =
de°_ExtINT
)) {

1920 
iﬂpic_i8259
.
≠ic
 =ápic;

1921 
iﬂpic_i8259
.
pö
 =Öin;

1922 
found_i8259
;

1926 
found_i8259
:

1932 
i8259_pö
 = 
	`föd_iß_úq_pö
(0, 
mp_ExtINT
);

1933 
i8259_≠ic
 = 
	`föd_iß_úq_≠ic
(0, 
mp_ExtINT
);

1935 i‡((
iﬂpic_i8259
.
pö
 =-1Ë&& (
i8259_pö
 >= 0)) {

1936 
	`¥ötk
(
KERN_WARNING
 "ExtINTÇot setup in hardware butÑeported by MPÅable\n");

1937 
iﬂpic_i8259
.
pö
 = 
i8259_pö
;

1938 
iﬂpic_i8259
.
≠ic
 = 
i8259_≠ic
;

1941 i‡(((
iﬂpic_i8259
.
≠ic
 !
i8259_≠ic
Ë|| (iﬂpic_i8259.
pö
 !
i8259_pö
)) &&

1942 (
i8259_pö
 >0Ë&& (
iﬂpic_i8259
.
pö
 >= 0))

1944 
	`¥ötk
(
KERN_WARNING
 "ExtINT in hardwareánd MPÅable differ\n");

1950 
	`˛ór_IO_APIC
();

1951 
	}
}

1956 
	$dißbÀ_IO_APIC
()

1961 
	`˛ór_IO_APIC
();

1963 i‡(!
ƒ_Àgacy_úqs
)

1976 i‡(
iﬂpic_i8259
.
pö
 !-1 && !
öå_ªm≠pög_íabÀd
) {

1977 
IO_APIC_rouã_íåy
 
íåy
;

1979 
	`mem£t
(&
íåy
, 0, (entry));

1980 
íåy
.
mask
 = 0;

1981 
íåy
.
åiggî
 = 0;

1982 
íåy
.
úr
 = 0;

1983 
íåy
.
pﬁ¨ôy
 = 0;

1984 
íåy
.
dñivîy_°©us
 = 0;

1985 
íåy
.
de°_mode
 = 0;

1986 
íåy
.
dñivîy_mode
 = 
de°_ExtINT
;

1987 
íåy
.
ve˘‹
 = 0;

1988 
íåy
.
de°
 = 
	`ªad_≠ic_id
();

1993 
	`iﬂpic_wrôe_íåy
(
iﬂpic_i8259
.
≠ic
, iﬂpic_i8259.
pö
, 
íåy
);

1999 i‡(
˝u_has_≠ic
 || 
	`≠ic_‰om_smp_c⁄fig
())

2000 
	`disc⁄√˘_b•_APIC
(!
öå_ªm≠pög_íabÀd
 &&

2001 
iﬂpic_i8259
.
pö
 != -1);

2002 
	}
}

2004 #ifde‡
CONFIG_X86_32


2012 
__öô
 
	$£tup_iﬂpic_ids_‰om_mpc
()

2014 
IO_APIC_ªg_00
 
ªg_00
;

2015 
physid_mask_t
 
phys_id_¥e£¡_m≠
;

2016 
≠ic_id
;

2017 
i
;

2018 
ﬁd_id
;

2019 
Êags
;

2021 i‡(
a˝i_iﬂpic
)

2027 i‡(!(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
)

2028 || 
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

2034 
phys_id_¥e£¡_m≠
 = 
≠ic
->
	`iﬂpic_phys_id_m≠
(
phys_˝u_¥e£¡_m≠
);

2039 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++) {

2042 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2043 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2044 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2046 
ﬁd_id
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2048 i‡(
mp_iﬂpics
[
≠ic_id
].
≠icid
 >
	`gë_physiˇl_brﬂdˇ°
()) {

2049 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inÅhe MPCÅable!...\n",

2050 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2051 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2052 
ªg_00
.
bôs
.
ID
);

2053 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
ªg_00
.
bôs
.
ID
;

2061 i‡(
≠ic
->
	`check_≠icid_u£d
(
phys_id_¥e£¡_m≠
,

2062 
mp_iﬂpics
[
≠ic_id
].
≠icid
)) {

2063 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d isálready used!...\n",

2064 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2065 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++)

2066 i‡(!
	`physid_is£t
(
i
, 
phys_id_¥e£¡_m≠
))

2068 i‡(
i
 >
	`gë_physiˇl_brﬂdˇ°
())

2069 
	`∑nic
("Max APIC IDÉxceeded!\n");

2070 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2071 
i
);

2072 
	`physid_£t
(
i
, 
phys_id_¥e£¡_m≠
);

2073 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
i
;

2075 
physid_mask_t
 
tmp
;

2076 
tmp
 = 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2077 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Setting %d inÅhe "

2079 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2080 
	`physids_‹
(
phys_id_¥e£¡_m≠
,Öhys_id_¥e£¡_m≠, 
tmp
);

2088 i‡(
ﬁd_id
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2089 
i
 = 0; i < 
mp_úq_íåõs
; i++)

2090 i‡(
mp_úqs
[
i
].
d°≠ic
 =
ﬁd_id
)

2091 
mp_úqs
[
i
].
d°≠ic


2092 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2098 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


2100 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2102 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2103 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2104 
	`io_≠ic_wrôe
(
≠ic_id
, 0, 
ªg_00
.
øw
);

2105 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2110 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2111 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2112 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2113 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2114 
	`¥ötk
("couldÇot set ID!\n");

2116 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " ok.\n");

2118 
	}
}

2121 
no_timî_check
 
	g__öôd©a
;

2123 
__öô
 
	$nŸimîcheck
(*
s
)

2125 
no_timî_check
 = 1;

2127 
	}
}

2128 
__£tup
("no_timî_check", 
nŸimîcheck
);

2138 
__öô
 
	$timî_úq_w‹ks
()

2140 
t1
 = 
jiffõs
;

2141 
Êags
;

2143 i‡(
no_timî_check
)

2146 
	`loˇl_ßve_Êags
(
Êags
);

2147 
	`loˇl_úq_íabÀ
();

2149 
	`mdñay
((10 * 1000Ë/ 
HZ
);

2150 
	`loˇl_úq_ª°‹e
(
Êags
);

2161 i‡(
	`time_a·î
(
jiffõs
, 
t1
 + 4))

2164 
	}
}

2189 
	$°¨tup_iﬂpic_úq
(
úq
)

2191 
was_≥ndög
 = 0;

2192 
Êags
;

2193 
úq_cfg
 *
cfg
;

2195 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2196 i‡(
úq
 < 
ƒ_Àgacy_úqs
) {

2197 
	`dißbÀ_8259A_úq
(
úq
);

2198 i‡(
	`i8259A_úq_≥ndög
(
úq
))

2199 
was_≥ndög
 = 1;

2201 
cfg
 = 
	`úq_cfg
(
úq
);

2202 
	`__unmask_IO_APIC_úq
(
cfg
);

2203 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2205  
was_≥ndög
;

2206 
	}
}

2208 
	$iﬂpic_ªåiggî_úq
(
úq
)

2211 
úq_cfg
 *
cfg
 = 
	`úq_cfg
(
úq
);

2212 
Êags
;

2214 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

2215 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
	`˝umask_fú°
(
cfg
->
domaö
)), cfg->
ve˘‹
);

2216 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

2219 
	}
}

2230 #ifde‡
CONFIG_SMP


2231 
	$£nd_˛ónup_ve˘‹
(
úq_cfg
 *
cfg
)

2233 
˝umask_v¨_t
 
˛ónup_mask
;

2235 i‡(
	`u∆ikñy
(!
	`Æloc_˝umask_v¨
(&
˛ónup_mask
, 
GFP_ATOMIC
))) {

2236 
i
;

2237 
cfg
->
move_˛ónup_cou¡
 = 0;

2238 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2239 
cfg
->
move_˛ónup_cou¡
++;

2240 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2241 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

2243 
	`˝umask_™d
(
˛ónup_mask
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
);

2244 
cfg
->
move_˛ónup_cou¡
 = 
	`˝umask_weight
(
˛ónup_mask
);

2245 
≠ic
->
	`£nd_IPI_mask
(
˛ónup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

2246 
	`‰ì_˝umask_v¨
(
˛ónup_mask
);

2248 
cfg
->
move_ö_¥ogªss
 = 0;

2249 
	}
}

2251 
	$__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
úq_cfg
 *
cfg
)

2253 
≠ic
, 
pö
;

2254 
úq_pö_li°
 *
íåy
;

2255 
u8
 
ve˘‹
 = 
cfg
->vector;

2257 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2258 
ªg
;

2260 
≠ic
 = 
íåy
->apic;

2261 
pö
 = 
íåy
->pin;

2266 i‡(!
	`úq_ªm≠≥d
(
úq
))

2267 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 
pö
*2, 
de°
);

2268 
ªg
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 
pö
*2);

2269 
ªg
 &~
IO_APIC_REDIR_VECTOR_MASK
;

2270 
ªg
 |
ve˘‹
;

2271 
	`io_≠ic_modify
(
≠ic
, 0x10 + 
pö
*2, 
ªg
);

2273 
	}
}

2276 
assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
);

2284 
	$£t_desc_afföôy
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2286 
úq_cfg
 *
cfg
;

2287 
úq
;

2289 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2290  
BAD_APICID
;

2292 
úq
 = 
desc
->irq;

2293 
cfg
 = 
desc
->
chù_d©a
;

2294 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2295  
BAD_APICID
;

2297 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2299  
≠ic
->
	`˝u_mask_to_≠icid_™d
(
desc
->
afföôy
, 
cfg
->
domaö
);

2300 
	}
}

2303 
	$£t_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2305 
úq_cfg
 *
cfg
;

2306 
Êags
;

2307 
de°
;

2308 
úq
;

2309 
ªt
 = -1;

2311 
úq
 = 
desc
->irq;

2312 
cfg
 = 
desc
->
chù_d©a
;

2314 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2315 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

2316 i‡(
de°
 !
BAD_APICID
) {

2318 
de°
 = 
	`SET_APIC_LOGICAL_ID
(dest);

2319 
	`__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
cfg
);

2320 
ªt
 = 0;

2322 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2324  
ªt
;

2325 
	}
}

2328 
	$£t_iﬂpic_afföôy_úq
(
úq
, c⁄° 
˝umask
 *
mask
)

2330 
úq_desc
 *
desc
;

2332 
desc
 = 
	`úq_to_desc
(
úq
);

2334  
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2335 
	}
}

2337 #ifde‡
CONFIG_INTR_REMAP


2351 
	$migøã_iﬂpic_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2353 
úq_cfg
 *
cfg
;

2354 
úã
 irte;

2355 
de°
;

2356 
úq
;

2357 
ªt
 = -1;

2359 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2360  
ªt
;

2362 
úq
 = 
desc
->irq;

2363 i‡(
	`gë_úã
(
úq
, &
úã
))

2364  
ªt
;

2366 
cfg
 = 
desc
->
chù_d©a
;

2367 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2368  
ªt
;

2370 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
, 
mask
);

2372 
úã
.
ve˘‹
 = 
cfg
->vector;

2373 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

2378 
	`modify_úã
(
úq
, &
úã
);

2380 i‡(
cfg
->
move_ö_¥ogªss
)

2381 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2383 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2386 
	}
}

2391 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2392 c⁄° 
˝umask
 *
mask
)

2394  
	`migøã_iﬂpic_úq_desc
(
desc
, 
mask
);

2395 
	}
}

2396 
	$£t_ú_iﬂpic_afföôy_úq
(
úq
,

2397 c⁄° 
˝umask
 *
mask
)

2399 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2401  
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2402 
	}
}

2404 
ölöe
 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2405 c⁄° 
˝umask
 *
mask
)

2408 
	}
}

2411 
asmlökage
 
	$smp_úq_move_˛ónup_öãºu±
()

2413 
ve˘‹
, 
me
;

2415 
	`ack_APIC_úq
();

2416 
	`exô_idÀ
();

2417 
	`úq_íãr
();

2419 
me
 = 
	`smp_¥o˚ss‹_id
();

2420 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

2421 
úq
;

2422 
úr
;

2423 
úq_desc
 *
desc
;

2424 
úq_cfg
 *
cfg
;

2425 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

2427 i‡(
úq
 == -1)

2430 
desc
 = 
	`úq_to_desc
(
úq
);

2431 i‡(!
desc
)

2434 
cfg
 = 
	`úq_cfg
(
úq
);

2435 
	`•ö_lock
(&
desc
->
lock
);

2436 i‡(!
cfg
->
move_˛ónup_cou¡
)

2437 
u∆ock
;

2439 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2440 
u∆ock
;

2442 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

2450 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

2451 
≠ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2452 
u∆ock
;

2454 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] = -1;

2455 
cfg
->
move_˛ónup_cou¡
--;

2456 
u∆ock
:

2457 
	`•ö_u∆ock
(&
desc
->
lock
);

2460 
	`úq_exô
();

2461 
	}
}

2463 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
)

2465 
úq_desc
 *
desc
 = *
des˝
;

2466 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2467 
ve˘‹
, 
me
;

2469 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

2472 
ve˘‹
 = ~
	`gë_úq_ªgs
()->
‹ig_ax
;

2473 
me
 = 
	`smp_¥o˚ss‹_id
();

2475 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2476 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2477 
	}
}

2479 
ölöe
 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
Ë{
	}
}

2482 
	$ack_≠ic_edge
(
úq
)

2484 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2486 
	`úq_com∂ëe_move
(&
desc
);

2487 
	`move_«tive_úq
(
úq
);

2488 
	`ack_APIC_úq
();

2489 
	}
}

2491 
©omic_t
 
	gúq_mis_cou¡
;

2493 
	$ack_≠ic_Àvñ
(
úq
)

2495 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2496 
v
;

2497 
i
;

2498 
úq_cfg
 *
cfg
;

2499 
do_unmask_úq
 = 0;

2501 
	`úq_com∂ëe_move
(&
desc
);

2502 #ifde‡
CONFIG_GENERIC_PENDING_IRQ


2504 i‡(
	`u∆ikñy
(
desc
->
°©us
 & 
IRQ_MOVE_PENDING
)) {

2505 
do_unmask_úq
 = 1;

2506 
	`mask_IO_APIC_úq_desc
(
desc
);

2529 
cfg
 = 
desc
->
chù_d©a
;

2530 
i
 = 
cfg
->
ve˘‹
;

2531 
v
 = 
	`≠ic_ªad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2537 
	`ack_APIC_úq
();

2540 i‡(
	`u∆ikñy
(
do_unmask_úq
)) {

2567 
cfg
 = 
desc
->
chù_d©a
;

2568 i‡(!
	`io_≠ic_Àvñ_ack_≥ndög
(
cfg
))

2569 
	`move_masked_úq
(
úq
);

2570 
	`unmask_IO_APIC_úq_desc
(
desc
);

2574 i‡(!(
v
 & (1 << (
i
 & 0x1f)))) {

2575 
	`©omic_öc
(&
úq_mis_cou¡
);

2576 
	`•ö_lock
(&
iﬂpic_lock
);

2577 
	`__mask_™d_edge_IO_APIC_úq
(
cfg
);

2578 
	`__unmask_™d_Àvñ_IO_APIC_úq
(
cfg
);

2579 
	`•ö_u∆ock
(&
iﬂpic_lock
);

2581 
	}
}

2583 #ifde‡
CONFIG_INTR_REMAP


2584 
	$__eoi_iﬂpic_úq
(
úq
, 
úq_cfg
 *
cfg
)

2586 
úq_pö_li°
 *
íåy
;

2588 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

2589 
	`io_≠ic_eoi
(
íåy
->
≠ic
,É¡ry->
pö
);

2590 
	}
}

2593 
	$eoi_iﬂpic_úq
(
úq_desc
 *
desc
)

2595 
úq_cfg
 *
cfg
;

2596 
Êags
;

2597 
úq
;

2599 
úq
 = 
desc
->irq;

2600 
cfg
 = 
desc
->
chù_d©a
;

2602 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2603 
	`__eoi_iﬂpic_úq
(
úq
, 
cfg
);

2604 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2605 
	}
}

2607 
	$ú_ack_≠ic_edge
(
úq
)

2609 
	`ack_APIC_úq
();

2610 
	}
}

2612 
	$ú_ack_≠ic_Àvñ
(
úq
)

2614 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2616 
	`ack_APIC_úq
();

2617 
	`eoi_iﬂpic_úq
(
desc
);

2618 
	}
}

2621 
úq_chù
 
iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2622 .
«me
 = "IO-APIC",

2623 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2624 .
	gmask
 = 
mask_IO_APIC_úq
,

2625 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2626 .
	gack
 = 
ack_≠ic_edge
,

2627 .
	geoi
 = 
ack_≠ic_Àvñ
,

2628 #ifde‡
CONFIG_SMP


2629 .
	g£t_afföôy
 = 
£t_iﬂpic_afföôy_úq
,

2631 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2634 
úq_chù
 
ú_iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2635 .
«me
 = "IR-IO-APIC",

2636 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2637 .
	gmask
 = 
mask_IO_APIC_úq
,

2638 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2639 #ifde‡
CONFIG_INTR_REMAP


2640 .
	gack
 = 
ú_ack_≠ic_edge
,

2641 .
	geoi
 = 
ú_ack_≠ic_Àvñ
,

2642 #ifde‡
CONFIG_SMP


2643 .
	g£t_afföôy
 = 
£t_ú_iﬂpic_afföôy_úq
,

2646 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2649 
ölöe
 
	$öô_IO_APIC_å≠s
()

2651 
úq
;

2652 
úq_desc
 *
desc
;

2653 
úq_cfg
 *
cfg
;

2666 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

2667 
cfg
 = 
desc
->
chù_d©a
;

2668 i‡(
	`IO_APIC_IRQ
(
úq
Ë&& 
cfg
 && !cfg->
ve˘‹
) {

2674 i‡(
úq
 < 
ƒ_Àgacy_úqs
)

2675 
	`make_8259A_úq
(
úq
);

2678 
desc
->
chù
 = &
no_úq_chù
;

2681 
	}
}

2687 
	$mask_œpic_úq
(
úq
)

2689 
v
;

2691 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2692 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2693 
	}
}

2695 
	$unmask_œpic_úq
(
úq
)

2697 
v
;

2699 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2700 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2701 
	}
}

2703 
	$ack_œpic_úq
(
úq
)

2705 
	`ack_APIC_úq
();

2706 
	}
}

2708 
úq_chù
 
œpic_chù
 
	g__ªad_mo°ly
 = {

2709 .
«me
 = "local-APIC",

2710 .
	gmask
 = 
mask_œpic_úq
,

2711 .
	gunmask
 = 
unmask_œpic_úq
,

2712 .
	gack
 = 
ack_œpic_úq
,

2715 
	$œpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
)

2717 
desc
->
°©us
 &~
IRQ_LEVEL
;

2718 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
œpic_chù
, 
h™dÀ_edge_úq
,

2720 
	}
}

2722 
__öô
 
	$£tup_nmi
()

2733 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2735 
	`íabÀ_NMI_through_LVT0
();

2737 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " done.\n");

2738 
	}
}

2747 
ölöe
 
__öô
 
	$u∆ock_ExtINT_logic
()

2749 
≠ic
, 
pö
, 
i
;

2750 
IO_APIC_rouã_íåy
 
íåy0
, 
íåy1
;

2751 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

2753 
pö
 = 
	`föd_iß_úq_pö
(8, 
mp_INT
);

2754 i‡(
pö
 == -1) {

2755 
	`WARN_ON_ONCE
(1);

2758 
≠ic
 = 
	`föd_iß_úq_≠ic
(8, 
mp_INT
);

2759 i‡(
≠ic
 == -1) {

2760 
	`WARN_ON_ONCE
(1);

2764 
íåy0
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

2765 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2767 
	`mem£t
(&
íåy1
, 0, (entry1));

2769 
íåy1
.
de°_mode
 = 0;

2770 
íåy1
.
mask
 = 0;

2771 
íåy1
.
de°
 = 
	`h¨d_smp_¥o˚ss‹_id
();

2772 
íåy1
.
dñivîy_mode
 = 
de°_ExtINT
;

2773 
íåy1
.
pﬁ¨ôy
 = 
íåy0
.polarity;

2774 
íåy1
.
åiggî
 = 0;

2775 
íåy1
.
ve˘‹
 = 0;

2777 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy1
);

2779 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2780 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2781 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
 & ~
RTC_RATE_SELECT
) | 0x6,

2782 
RTC_FREQ_SELECT
);

2783 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2785 
i
 = 100;

2786 
i
-- > 0) {

2787 
	`mdñay
(10);

2788 i‡((
	`CMOS_READ
(
RTC_INTR_FLAGS
Ë& 
RTC_PF
) == RTC_PF)

2789 
i
 -= 10;

2792 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

2793 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

2794 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2796 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy0
);

2797 
	}
}

2799 
dißbÀ_timî_pö_1
 
	g__öôd©a
;

2801 
__öô
 
	$dißbÀ_timî_pö_£tup
(*
¨g
)

2803 
dißbÀ_timî_pö_1
 = 1;

2805 
	}
}

2806 
óæy_∑øm
("dißbÀ_timî_pö_1", 
dißbÀ_timî_pö_£tup
);

2808 
timî_through_8259
 
	g__öôd©a
;

2818 
ölöe
 
__öô
 
	$check_timî
()

2820 
úq_desc
 *
desc
 = 
	`úq_to_desc
(0);

2821 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2822 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

2823 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
;

2824 
Êags
;

2825 
no_pö1
 = 0;

2827 
	`loˇl_úq_ßve
(
Êags
);

2832 
	`dißbÀ_8259A_úq
(0);

2833 
	`assign_úq_ve˘‹
(0, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

2844 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2845 
	`öô_8259A
(1);

2846 #ifde‡
CONFIG_X86_32


2848 
vî
;

2850 
vî
 = 
	`≠ic_ªad
(
APIC_LVR
);

2851 
vî
 = 
	`GET_APIC_VERSION
(ver);

2852 
timî_ack
 = (
nmi_w©chdog
 =
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
vî
));

2856 
pö1
 = 
	`föd_iß_úq_pö
(0, 
mp_INT
);

2857 
≠ic1
 = 
	`föd_iß_úq_≠ic
(0, 
mp_INT
);

2858 
pö2
 = 
iﬂpic_i8259
.
pö
;

2859 
≠ic2
 = 
iﬂpic_i8259
.
≠ic
;

2861 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2863 
cfg
->
ve˘‹
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2872 i‡(
pö1
 == -1) {

2873 i‡(
öå_ªm≠pög_íabÀd
)

2874 
	`∑nic
("BIOS bug:ÅimerÇot connectedÅo IO-APIC");

2875 
pö1
 = 
pö2
;

2876 
≠ic1
 = 
≠ic2
;

2877 
no_pö1
 = 1;

2878 } i‡(
pö2
 == -1) {

2879 
pö2
 = 
pö1
;

2880 
≠ic2
 = 
≠ic1
;

2883 i‡(
pö1
 != -1) {

2887 i‡(
no_pö1
) {

2888 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
);

2889 
	`£tup_timî_IRQ0_pö
(
≠ic1
, 
pö1
, 
cfg
->
ve˘‹
);

2896 
idx
;

2897 
idx
 = 
	`föd_úq_íåy
(
≠ic1
, 
pö1
, 
mp_INT
);

2898 i‡(
idx
 !-1 && 
	`úq_åiggî
(idx))

2899 
	`unmask_IO_APIC_úq_desc
(
desc
);

2901 i‡(
	`timî_úq_w‹ks
()) {

2902 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2903 
	`£tup_nmi
();

2904 
	`íabÀ_8259A_úq
(0);

2906 i‡(
dißbÀ_timî_pö_1
 > 0)

2907 
	`˛ór_IO_APIC_pö
(0, 
pö1
);

2908 
out
;

2910 i‡(
öå_ªm≠pög_íabÀd
)

2911 
	`∑nic
("timer doesn't workÅhrough Interrupt-remapped IO-APIC");

2912 
	`loˇl_úq_dißbÀ
();

2913 
	`˛ór_IO_APIC_pö
(
≠ic1
, 
pö1
);

2914 i‡(!
no_pö1
)

2915 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

2918 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingÅo set upÅimer "

2920 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2921 "..... (foundápi¯%dÖö %dË...\n", 
≠ic2
, 
pö2
);

2925 
	`ª∂a˚_pö_©_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2926 
	`£tup_timî_IRQ0_pö
(
≠ic2
, 
pö2
, 
cfg
->
ve˘‹
);

2927 
	`íabÀ_8259A_úq
(0);

2928 i‡(
	`timî_úq_w‹ks
()) {

2929 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

2930 
timî_through_8259
 = 1;

2931 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2932 
	`dißbÀ_8259A_úq
(0);

2933 
	`£tup_nmi
();

2934 
	`íabÀ_8259A_úq
(0);

2936 
out
;

2941 
	`loˇl_úq_dißbÀ
();

2942 
	`dißbÀ_8259A_úq
(0);

2943 
	`˛ór_IO_APIC_pö
(
≠ic2
, 
pö2
);

2944 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

2947 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

2948 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

2950 
nmi_w©chdog
 = 
NMI_NONE
;

2952 #ifde‡
CONFIG_X86_32


2953 
timî_ack
 = 0;

2956 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2959 
	`œpic_ªgi°î_öå
(0, 
desc
);

2960 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

2961 
	`íabÀ_8259A_úq
(0);

2963 i‡(
	`timî_úq_w‹ks
()) {

2964 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

2965 
out
;

2967 
	`loˇl_úq_dißbÀ
();

2968 
	`dißbÀ_8259A_úq
(0);

2969 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

2970 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

2972 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


2975 
	`öô_8259A
(0);

2976 
	`make_8259A_úq
(0);

2977 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

2979 
	`u∆ock_ExtINT_logic
();

2981 i‡(
	`timî_úq_w‹ks
()) {

2982 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

2983 
out
;

2985 
	`loˇl_úq_dißbÀ
();

2986 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

2987 
	`∑nic
("IO-APIC +Åimer doesn't work! Boot withápic=debugánd sendá "

2989 
out
:

2990 
	`loˇl_úq_ª°‹e
(
Êags
);

2991 
	}
}

3010 
	#PIC_IRQS
 (1UL << 
PIC_CASCADE_IR
)

	)

3012 
__öô
 
	$£tup_IO_APIC
()

3018 
io_≠ic_úqs
 = 
ƒ_Àgacy_úqs
 ? ~
PIC_IRQS
 : ~0UL;

3020 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3024 
x86_öô
.
mµ¨£
.
	`£tup_iﬂpic_ids
();

3026 
	`sync_Arb_IDs
();

3027 
	`£tup_IO_APIC_úqs
();

3028 
	`öô_IO_APIC_å≠s
();

3029 i‡(
ƒ_Àgacy_úqs
)

3030 
	`check_timî
();

3031 
	}
}

3038 
__öô
 
	$io_≠ic_bug_föÆize
()

3040 i‡(
sis_≠ic_bug
 == -1)

3041 
sis_≠ic_bug
 = 0;

3043 
	}
}

3045 
œã_öôˇŒ
(
io_≠ic_bug_föÆize
);

3047 
	ssysfs_iﬂpic_d©a
 {

3048 
sys_devi˚
 
	mdev
;

3049 
IO_APIC_rouã_íåy
 
	míåy
[0];

3051 
sysfs_iﬂpic_d©a
 * 
	gmp_iﬂpic_d©a
[
MAX_IO_APICS
];

3053 
	$iﬂpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

3055 
IO_APIC_rouã_íåy
 *
íåy
;

3056 
sysfs_iﬂpic_d©a
 *
d©a
;

3057 
i
;

3059 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3060 
íåy
 = 
d©a
->entry;

3061 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i ++, 
íåy
 ++ )

3062 *
íåy
 = 
	`iﬂpic_ªad_íåy
(
dev
->
id
, 
i
);

3065 
	}
}

3067 
	$iﬂpic_ªsume
(
sys_devi˚
 *
dev
)

3069 
IO_APIC_rouã_íåy
 *
íåy
;

3070 
sysfs_iﬂpic_d©a
 *
d©a
;

3071 
Êags
;

3072 
IO_APIC_ªg_00
 
ªg_00
;

3073 
i
;

3075 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3076 
íåy
 = 
d©a
->entry;

3078 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3079 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
dev
->
id
, 0);

3080 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
dev
->
id
].
≠icid
) {

3081 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
dev
->
id
].
≠icid
;

3082 
	`io_≠ic_wrôe
(
dev
->
id
, 0, 
ªg_00
.
øw
);

3084 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3085 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i++)

3086 
	`iﬂpic_wrôe_íåy
(
dev
->
id
, 
i
, 
íåy
[i]);

3089 
	}
}

3091 
sysdev_˛ass
 
	giﬂpic_sysdev_˛ass
 = {

3092 .
«me
 = "ioapic",

3093 .
	gsu•íd
 = 
iﬂpic_su•íd
,

3094 .
	gªsume
 = 
iﬂpic_ªsume
,

3097 
__öô
 
	$iﬂpic_öô_sysfs
()

3099 
sys_devi˚
 * 
dev
;

3100 
i
, 
size
, 
îr‹
;

3102 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
iﬂpic_sysdev_˛ass
);

3103 i‡(
îr‹
)

3104  
îr‹
;

3106 
i
 = 0; i < 
ƒ_iﬂpics
; i++ ) {

3107 
size
 = (
sys_devi˚
Ë+ 
ƒ_iﬂpic_ªgi°îs
[
i
]

3108 * (
IO_APIC_rouã_íåy
);

3109 
mp_iﬂpic_d©a
[
i
] = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3110 i‡(!
mp_iﬂpic_d©a
[
i
]) {

3111 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3114 
dev
 = &
mp_iﬂpic_d©a
[
i
]->dev;

3115 
dev
->
id
 = 
i
;

3116 
dev
->
˛s
 = &
iﬂpic_sysdev_˛ass
;

3117 
îr‹
 = 
	`sysdev_ªgi°î
(
dev
);

3118 i‡(
îr‹
) {

3119 
	`k‰ì
(
mp_iﬂpic_d©a
[
i
]);

3120 
mp_iﬂpic_d©a
[
i
] = 
NULL
;

3121 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3127 
	}
}

3129 
devi˚_öôˇŒ
(
iﬂpic_öô_sysfs
);

3134 
	$¸óã_úq_ƒ
(
úq_w™t
, 
node
)

3137 
úq
;

3138 
√w
;

3139 
Êags
;

3140 
úq_cfg
 *
cfg_√w
 = 
NULL
;

3141 
úq_desc
 *
desc_√w
 = 
NULL
;

3143 
úq
 = 0;

3144 i‡(
úq_w™t
 < 
ƒ_úqs_gsi
)

3145 
úq_w™t
 = 
ƒ_úqs_gsi
;

3147 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3148 
√w
 = 
úq_w™t
;Çew < 
ƒ_úqs
;Çew++) {

3149 
desc_√w
 = 
	`úq_to_desc_Æloc_node
(
√w
, 
node
);

3150 i‡(!
desc_√w
) {

3151 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
√w
);

3154 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3156 i‡(
cfg_√w
->
ve˘‹
 != 0)

3159 
desc_√w
 = 
	`move_úq_desc
(desc_√w, 
node
);

3161 i‡(
	`__assign_úq_ve˘‹
(
√w
, 
cfg_√w
, 
≠ic
->
	`èrgë_˝us
()) == 0)

3162 
úq
 = 
√w
;

3165 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3167 i‡(
úq
 > 0) {

3168 
	`dy«mic_úq_öô
(
úq
);

3170 i‡(
desc_√w
)

3171 
desc_√w
->
chù_d©a
 = 
cfg_√w
;

3173  
úq
;

3174 
	}
}

3176 
	$¸óã_úq
()

3178 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3179 
úq_w™t
;

3180 
úq
;

3182 
úq_w™t
 = 
ƒ_úqs_gsi
;

3183 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3185 i‡(
úq
 == 0)

3186 
úq
 = -1;

3188  
úq
;

3189 
	}
}

3191 
	$de°roy_úq
(
úq
)

3193 
Êags
;

3194 
úq_cfg
 *
cfg
;

3195 
úq_desc
 *
desc
;

3198 
desc
 = 
	`úq_to_desc
(
úq
);

3199 
cfg
 = 
desc
->
chù_d©a
;

3200 
	`dy«mic_úq_˛ónup
(
úq
);

3202 
desc
->
chù_d©a
 = 
cfg
;

3204 
	`‰ì_úã
(
úq
);

3205 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3206 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

3207 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3208 
	}
}

3213 #ifde‡
CONFIG_PCI_MSI


3214 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
úq
, 
msi_msg
 *
msg
)

3216 
úq_cfg
 *
cfg
;

3217 
îr
;

3218 
de°
;

3220 i‡(
dißbÀ_≠ic
)

3221  -
ENXIO
;

3223 
cfg
 = 
	`úq_cfg
(
úq
);

3224 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3225 i‡(
îr
)

3226  
îr
;

3228 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

3230 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3231 
úã
 irte;

3232 
ú_ödex
;

3233 
u16
 
sub_h™dÀ
;

3235 
ú_ödex
 = 
	`m≠_úq_to_úã_h™dÀ
(
úq
, &
sub_h™dÀ
);

3236 
	`BUG_ON
(
ú_ödex
 == -1);

3238 
	`mem£t
 (&
úã
, 0, (irte));

3240 
úã
.
¥e£¡
 = 1;

3241 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

3242 
úã
.
åiggî_mode
 = 0;

3243 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3244 
úã
.
ve˘‹
 = 
cfg
->vector;

3245 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3248 
	`£t_msi_sid
(&
úã
, 
pdev
);

3250 
	`modify_úã
(
úq
, &
úã
);

3252 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3253 
msg
->
d©a
 = 
sub_h™dÀ
;

3254 
msg
->
addªss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3255 
MSI_ADDR_IR_SHV
 |

3256 
	`MSI_ADDR_IR_INDEX1
(
ú_ödex
) |

3257 
	`MSI_ADDR_IR_INDEX2
(
ú_ödex
);

3259 i‡(
	`x2≠ic_íabÀd
())

3260 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
 |

3261 
	`MSI_ADDR_EXT_DEST_ID
(
de°
);

3263 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3265 
msg
->
addªss_lo
 =

3266 
MSI_ADDR_BASE_LO
 |

3267 ((
≠ic
->
úq_de°_mode
 == 0) ?

3268 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3269 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3270 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3271 
MSI_ADDR_REDIRECTION_CPU
:

3272 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3273 
	`MSI_ADDR_DEST_ID
(
de°
);

3275 
msg
->
d©a
 =

3276 
MSI_DATA_TRIGGER_EDGE
 |

3277 
MSI_DATA_LEVEL_ASSERT
 |

3278 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3279 
MSI_DATA_DELIVERY_FIXED
:

3280 
MSI_DATA_DELIVERY_LOWPRI
) |

3281 
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3283  
îr
;

3284 
	}
}

3286 #ifde‡
CONFIG_SMP


3287 
	$£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3289 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3290 
úq_cfg
 *
cfg
;

3291 
msi_msg
 
msg
;

3292 
de°
;

3294 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3295 i‡(
de°
 =
BAD_APICID
)

3298 
cfg
 = 
desc
->
chù_d©a
;

3300 
	`ªad_msi_msg_desc
(
desc
, &
msg
);

3302 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3303 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3304 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3305 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3307 
	`wrôe_msi_msg_desc
(
desc
, &
msg
);

3310 
	}
}

3311 #ifde‡
CONFIG_INTR_REMAP


3317 
	$ú_£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3319 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3320 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

3321 
de°
;

3322 
úã
 irte;

3324 i‡(
	`gë_úã
(
úq
, &
úã
))

3327 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3328 i‡(
de°
 =
BAD_APICID
)

3331 
úã
.
ve˘‹
 = 
cfg
->vector;

3332 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3337 
	`modify_úã
(
úq
, &
úã
);

3344 i‡(
cfg
->
move_ö_¥ogªss
)

3345 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3348 
	}
}

3357 
úq_chù
 
	gmsi_chù
 = {

3358 .
«me
 = "PCI-MSI",

3359 .
	gunmask
 = 
unmask_msi_úq
,

3360 .
	gmask
 = 
mask_msi_úq
,

3361 .
	gack
 = 
ack_≠ic_edge
,

3362 #ifde‡
CONFIG_SMP


3363 .
	g£t_afföôy
 = 
£t_msi_úq_afföôy
,

3365 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3368 
úq_chù
 
	gmsi_ú_chù
 = {

3369 .
«me
 = "IR-PCI-MSI",

3370 .
	gunmask
 = 
unmask_msi_úq
,

3371 .
	gmask
 = 
mask_msi_úq
,

3372 #ifde‡
CONFIG_INTR_REMAP


3373 .
	gack
 = 
ú_ack_≠ic_edge
,

3374 #ifde‡
CONFIG_SMP


3375 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3378 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3386 
	$msi_Æloc_úã
(
pci_dev
 *
dev
, 
úq
, 
nvec
)

3388 
öãl_iommu
 *
iommu
;

3389 
ödex
;

3391 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3392 i‡(!
iommu
) {

3393 
	`¥ötk
(
KERN_ERR


3394 "U«bÀÅÿm≠ PCI %†tÿiommu\n", 
	`pci_«me
(
dev
));

3395  -
ENOENT
;

3398 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 
nvec
);

3399 i‡(
ödex
 < 0) {

3400 
	`¥ötk
(
KERN_ERR


3401 "U«bÀÅÿÆloˇã %d IRTE f‹ PCI %s\n", 
nvec
,

3402 
	`pci_«me
(
dev
));

3403  -
ENOSPC
;

3405  
ödex
;

3406 
	}
}

3408 
	$£tup_msi_úq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
úq
)

3410 
ªt
;

3411 
msi_msg
 
msg
;

3413 
ªt
 = 
	`msi_compo£_msg
(
dev
, 
úq
, &
msg
);

3414 i‡(
ªt
 < 0)

3415  
ªt
;

3417 
	`£t_úq_msi
(
úq
, 
msidesc
);

3418 
	`wrôe_msi_msg
(
úq
, &
msg
);

3420 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3421 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3425 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3426 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_ú_chù
, 
h™dÀ_edge_úq
, "edge");

3428 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_chù
, 
h™dÀ_edge_úq
, "edge");

3430 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ MSI/MSI-X\n", 
úq
);

3433 
	}
}

3435 
	$¨ch_£tup_msi_úqs
(
pci_dev
 *
dev
, 
nvec
, 
ty≥
)

3437 
úq
;

3438 
ªt
, 
sub_h™dÀ
;

3439 
msi_desc
 *
msidesc
;

3440 
úq_w™t
;

3441 
öãl_iommu
 *
iommu
 = 
NULL
;

3442 
ödex
 = 0;

3443 
node
;

3446 i‡(
ty≥
 =
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3449 
node
 = 
	`dev_to_node
(&
dev
->dev);

3450 
úq_w™t
 = 
ƒ_úqs_gsi
;

3451 
sub_h™dÀ
 = 0;

3452 
	`li°_f‹_óch_íåy
(
msidesc
, &
dev
->
msi_li°
, 
li°
) {

3453 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3454 i‡(
úq
 == 0)

3456 
úq_w™t
 = 
úq
 + 1;

3457 i‡(!
öå_ªm≠pög_íabÀd
)

3458 
no_ú
;

3460 i‡(!
sub_h™dÀ
) {

3465 
ödex
 = 
	`msi_Æloc_úã
(
dev
, 
úq
, 
nvec
);

3466 i‡(
ödex
 < 0) {

3467 
ªt
 = 
ödex
;

3468 
îr‹
;

3471 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3472 i‡(!
iommu
) {

3473 
ªt
 = -
ENOENT
;

3474 
îr‹
;

3481 
	`£t_úã_úq
(
úq
, 
iommu
, 
ödex
, 
sub_h™dÀ
);

3483 
no_ú
:

3484 
ªt
 = 
	`£tup_msi_úq
(
dev
, 
msidesc
, 
úq
);

3485 i‡(
ªt
 < 0)

3486 
îr‹
;

3487 
sub_h™dÀ
++;

3491 
îr‹
:

3492 
	`de°roy_úq
(
úq
);

3493  
ªt
;

3494 
	}
}

3496 
	$¨ch_ã¨down_msi_úq
(
úq
)

3498 
	`de°roy_úq
(
úq
);

3499 
	}
}

3501 #i‡
deföed
 (
CONFIG_DMAR
Ë|| deföed (
CONFIG_INTR_REMAP
)

3502 #ifde‡
CONFIG_SMP


3503 
	$dm¨_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3505 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3506 
úq_cfg
 *
cfg
;

3507 
msi_msg
 
msg
;

3508 
de°
;

3510 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3511 i‡(
de°
 =
BAD_APICID
)

3514 
cfg
 = 
desc
->
chù_d©a
;

3516 
	`dm¨_msi_ªad
(
úq
, &
msg
);

3518 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3519 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3520 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3521 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3523 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3526 
	}
}

3530 
úq_chù
 
	gdm¨_msi_ty≥
 = {

3531 .
«me
 = "DMAR_MSI",

3532 .
	gunmask
 = 
dm¨_msi_unmask
,

3533 .
	gmask
 = 
dm¨_msi_mask
,

3534 .
	gack
 = 
ack_≠ic_edge
,

3535 #ifde‡
CONFIG_SMP


3536 .
	g£t_afföôy
 = 
dm¨_msi_£t_afföôy
,

3538 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3541 
	$¨ch_£tup_dm¨_msi
(
úq
)

3543 
ªt
;

3544 
msi_msg
 
msg
;

3546 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
);

3547 i‡(
ªt
 < 0)

3548  
ªt
;

3549 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3550 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
dm¨_msi_ty≥
, 
h™dÀ_edge_úq
,

3553 
	}
}

3556 #ifde‡
CONFIG_HPET_TIMER


3558 #ifde‡
CONFIG_SMP


3559 
	$h≥t_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3561 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3562 
úq_cfg
 *
cfg
;

3563 
msi_msg
 
msg
;

3564 
de°
;

3566 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3567 i‡(
de°
 =
BAD_APICID
)

3570 
cfg
 = 
desc
->
chù_d©a
;

3572 
	`h≥t_msi_ªad
(
úq
, &
msg
);

3574 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3575 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3576 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3577 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3579 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3582 
	}
}

3586 
úq_chù
 
	gh≥t_msi_ty≥
 = {

3587 .
«me
 = "HPET_MSI",

3588 .
	gunmask
 = 
h≥t_msi_unmask
,

3589 .
	gmask
 = 
h≥t_msi_mask
,

3590 .
	gack
 = 
ack_≠ic_edge
,

3591 #ifde‡
CONFIG_SMP


3592 .
	g£t_afföôy
 = 
h≥t_msi_£t_afföôy
,

3594 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3597 
	$¨ch_£tup_h≥t_msi
(
úq
)

3599 
ªt
;

3600 
msi_msg
 
msg
;

3601 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3603 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
);

3604 i‡(
ªt
 < 0)

3605  
ªt
;

3607 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3608 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3609 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
h≥t_msi_ty≥
, 
h™dÀ_edge_úq
,

3613 
	}
}

3620 #ifde‡
CONFIG_HT_IRQ


3622 #ifde‡
CONFIG_SMP


3624 
	$èrgë_ht_úq
(
úq
, 
de°
, 
u8
 
ve˘‹
)

3626 
ht_úq_msg
 
msg
;

3627 
	`„tch_ht_úq_msg
(
úq
, &
msg
);

3629 
msg
.
addªss_lo
 &~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3630 
msg
.
addªss_hi
 &~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3632 
msg
.
addªss_lo
 |
	`HT_IRQ_LOW_VECTOR
(
ve˘‹
Ë| 
	`HT_IRQ_LOW_DEST_ID
(
de°
);

3633 
msg
.
addªss_hi
 |
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3635 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3636 
	}
}

3638 
	$£t_ht_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3640 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3641 
úq_cfg
 *
cfg
;

3642 
de°
;

3644 
de°
 = 
	`£t_desc_afföôy
(
desc
, 
mask
);

3645 i‡(
de°
 =
BAD_APICID
)

3648 
cfg
 = 
desc
->
chù_d©a
;

3650 
	`èrgë_ht_úq
(
úq
, 
de°
, 
cfg
->
ve˘‹
);

3653 
	}
}

3657 
úq_chù
 
	ght_úq_chù
 = {

3658 .
«me
 = "PCI-HT",

3659 .
	gmask
 = 
mask_ht_úq
,

3660 .
	gunmask
 = 
unmask_ht_úq
,

3661 .
	gack
 = 
ack_≠ic_edge
,

3662 #ifde‡
CONFIG_SMP


3663 .
	g£t_afföôy
 = 
£t_ht_úq_afföôy
,

3665 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3668 
	$¨ch_£tup_ht_úq
(
úq
, 
pci_dev
 *
dev
)

3670 
úq_cfg
 *
cfg
;

3671 
îr
;

3673 i‡(
dißbÀ_≠ic
)

3674  -
ENXIO
;

3676 
cfg
 = 
	`úq_cfg
(
úq
);

3677 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3678 i‡(!
îr
) {

3679 
ht_úq_msg
 
msg
;

3680 
de°
;

3682 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,

3683 
≠ic
->
	`èrgë_˝us
());

3685 
msg
.
addªss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3687 
msg
.
addªss_lo
 =

3688 
HT_IRQ_LOW_BASE
 |

3689 
	`HT_IRQ_LOW_DEST_ID
(
de°
) |

3690 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
ve˘‹
) |

3691 ((
≠ic
->
úq_de°_mode
 == 0) ?

3692 
HT_IRQ_LOW_DM_PHYSICAL
 :

3693 
HT_IRQ_LOW_DM_LOGICAL
) |

3694 
HT_IRQ_LOW_RQEOI_EDGE
 |

3695 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3696 
HT_IRQ_LOW_MT_FIXED
 :

3697 
HT_IRQ_LOW_MT_ARBITRATED
) |

3698 
HT_IRQ_LOW_IRQ_MASKED
;

3700 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3702 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ht_úq_chù
,

3703 
h™dÀ_edge_úq
, "edge");

3705 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ HT\n", 
úq
);

3707  
îr
;

3708 
	}
}

3711 #ifde‡
CONFIG_X86_UV


3716 
	$¨ch_íabÀ_uv_úq
(*
úq_«me
, 
úq
, 
˝u
, 
mmr_bœde
,

3717 
mmr_off£t
)

3719 c⁄° 
˝umask
 *
ñigibÀ_˝u
 = 
	`˝umask_of
(
˝u
);

3720 
úq_cfg
 *
cfg
;

3721 
mmr_≤ode
;

3722 
mmr_vÆue
;

3723 
uv_IO_APIC_rouã_íåy
 *
íåy
;

3724 
Êags
;

3725 
îr
;

3727 
	`BUILD_BUG_ON
((
uv_IO_APIC_rouã_íåy
) != ());

3729 
cfg
 = 
	`úq_cfg
(
úq
);

3731 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
ñigibÀ_˝u
);

3732 i‡(
îr
 != 0)

3733  
îr
;

3735 
	`•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3736 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
uv_úq_chù
, 
h™dÀ_≥r˝u_úq
,

3737 
úq_«me
);

3738 
	`•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3740 
mmr_vÆue
 = 0;

3741 
íåy
 = (
uv_IO_APIC_rouã_íåy
 *)&
mmr_vÆue
;

3742 
íåy
->
ve˘‹
 = 
cfg
->vector;

3743 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3744 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

3745 
íåy
->
pﬁ¨ôy
 = 0;

3746 
íåy
->
åiggî
 = 0;

3747 
íåy
->
mask
 = 0;

3748 
íåy
->
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
(
ñigibÀ_˝u
);

3750 
mmr_≤ode
 = 
	`uv_bœde_to_≤ode
(
mmr_bœde
);

3751 
	`uv_wrôe_globÆ_mmr64
(
mmr_≤ode
, 
mmr_off£t
, 
mmr_vÆue
);

3753 i‡(
cfg
->
move_ö_¥ogªss
)

3754 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3756  
úq
;

3757 
	}
}

3763 
	$¨ch_dißbÀ_uv_úq
(
mmr_bœde
, 
mmr_off£t
)

3765 
mmr_vÆue
;

3766 
uv_IO_APIC_rouã_íåy
 *
íåy
;

3767 
mmr_≤ode
;

3769 
	`BUILD_BUG_ON
((
uv_IO_APIC_rouã_íåy
) != ());

3771 
mmr_vÆue
 = 0;

3772 
íåy
 = (
uv_IO_APIC_rouã_íåy
 *)&
mmr_vÆue
;

3773 
íåy
->
mask
 = 1;

3775 
mmr_≤ode
 = 
	`uv_bœde_to_≤ode
(
mmr_bœde
);

3776 
	`uv_wrôe_globÆ_mmr64
(
mmr_≤ode
, 
mmr_off£t
, 
mmr_vÆue
);

3777 
	}
}

3780 
__öô
 
	$io_≠ic_gë_ªdú_íåõs
 (
iﬂpic
)

3782 
IO_APIC_ªg_01
 
ªg_01
;

3783 
Êags
;

3785 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3786 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

3787 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3789  
ªg_01
.
bôs
.
íåõs
;

3790 
	}
}

3792 
__öô
 
	$¥obe_ƒ_úqs_gsi
()

3794 
ƒ
 = 0;

3796 
ƒ
 = 
	`a˝i_¥obe_gsi
();

3797 i‡(
ƒ
 > 
ƒ_úqs_gsi
) {

3798 
ƒ_úqs_gsi
 = 
ƒ
;

3801 
idx
;

3803 
ƒ
 = 0;

3804 
idx
 = 0; idx < 
ƒ_iﬂpics
; idx++)

3805 
ƒ
 +
	`io_≠ic_gë_ªdú_íåõs
(
idx
) + 1;

3807 i‡(
ƒ
 > 
ƒ_úqs_gsi
)

3808 
ƒ_úqs_gsi
 = 
ƒ
;

3811 
	`¥ötk
(
KERN_DEBUG
 "ƒ_úqs_gsi: %d\n", 
ƒ_úqs_gsi
);

3812 
	}
}

3814 #ifde‡
CONFIG_SPARSE_IRQ


3815 
__öô
 
	$¨ch_¥obe_ƒ_úqs
()

3817 
ƒ
;

3819 i‡(
ƒ_úqs
 > (
NR_VECTORS
 * 
ƒ_˝u_ids
))

3820 
ƒ_úqs
 = 
NR_VECTORS
 * 
ƒ_˝u_ids
;

3822 
ƒ
 = 
ƒ_úqs_gsi
 + 8 * 
ƒ_˝u_ids
;

3823 #i‡
	`deföed
(
CONFIG_PCI_MSI
Ë|| deföed(
CONFIG_HT_IRQ
)

3827 
ƒ
 +
ƒ_úqs_gsi
 * 16;

3829 i‡(
ƒ
 < 
ƒ_úqs
)

3830 
ƒ_úqs
 = 
ƒ
;

3833 
	}
}

3836 
	$__io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3837 
io_≠ic_úq_©å
 *
úq_©å
)

3839 
úq_desc
 *
desc
;

3840 
úq_cfg
 *
cfg
;

3841 
node
;

3842 
iﬂpic
, 
pö
;

3843 
åiggî
, 
pﬁ¨ôy
;

3845 
iﬂpic
 = 
úq_©å
->ioapic;

3846 i‡(!
	`IO_APIC_IRQ
(
úq
)) {

3847 
	`≠ic_¥ötk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: InvalidÑeferenceÅo IRQ 0\n",

3848 
iﬂpic
);

3849  -
EINVAL
;

3852 i‡(
dev
)

3853 
node
 = 
	`dev_to_node
(
dev
);

3855 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3857 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

3858 i‡(!
desc
) {

3859 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯%d\n", 
úq
);

3863 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3864 
åiggî
 = 
úq_©å
->trigger;

3865 
pﬁ¨ôy
 = 
úq_©å
->polarity;

3870 i‡(
úq
 >
ƒ_Àgacy_úqs
) {

3871 
cfg
 = 
desc
->
chù_d©a
;

3872 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
iﬂpic
, 
pö
)) {

3873 
	`¥ötk
(
KERN_INFO
 "canÇotáddÖin %d for irq %d\n",

3874 
pö
, 
úq
);

3879 
	`£tup_IO_APIC_úq
(
iﬂpic
, 
pö
, 
úq
, 
desc
, 
åiggî
, 
pﬁ¨ôy
);

3882 
	}
}

3884 
	$io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3885 
io_≠ic_úq_©å
 *
úq_©å
)

3887 
iﬂpic
, 
pö
;

3893 
iﬂpic
 = 
úq_©å
->ioapic;

3894 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3895 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
)) {

3896 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

3897 
mp_iﬂpics
[
iﬂpic
].
≠icid
, 
pö
);

3900 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
);

3902  
	`__io_≠ic_£t_pci_routög
(
dev
, 
úq
, 
úq_©å
);

3903 
	}
}

3905 
u8
 
__öô
 
	$io_≠ic_unique_id
(
u8
 
id
)

3907 #ifde‡
CONFIG_X86_32


3908 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

3909 !
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

3910  
	`io_≠ic_gë_unique_id
(
ƒ_iﬂpics
, 
id
);

3912  
id
;

3914 
i
;

3915 
	`DECLARE_BITMAP
(
u£d
, 256);

3917 
	`bôm≠_zîo
(
u£d
, 256);

3918 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

3919 
mpc_iﬂpic
 *
ü
 = &
mp_iﬂpics
[
i
];

3920 
	`__£t_bô
(
ü
->
≠icid
, 
u£d
);

3922 i‡(!
	`ã°_bô
(
id
, 
u£d
))

3923  
id
;

3924  
	`föd_fú°_zîo_bô
(
u£d
, 256);

3926 
	}
}

3928 #ifde‡
CONFIG_X86_32


3929 
__öô
 
	$io_≠ic_gë_unique_id
(
iﬂpic
, 
≠ic_id
)

3931 
IO_APIC_ªg_00
 
ªg_00
;

3932 
physid_mask_t
 
≠ic_id_m≠
 = 
PHYSID_MASK_NONE
;

3933 
physid_mask_t
 
tmp
;

3934 
Êags
;

3935 
i
 = 0;

3946 i‡(
	`physids_em±y
(
≠ic_id_m≠
))

3947 
≠ic_id_m≠
 = 
≠ic
->
	`iﬂpic_phys_id_m≠
(
phys_˝u_¥e£¡_m≠
);

3949 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3950 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

3951 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3953 i‡(
≠ic_id
 >
	`gë_physiˇl_brﬂdˇ°
()) {

3954 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]: Invalidápic_id %d,Årying "

3955 "%d\n", 
iﬂpic
, 
≠ic_id
, 
ªg_00
.
bôs
.
ID
);

3956 
≠ic_id
 = 
ªg_00
.
bôs
.
ID
;

3963 i‡(
≠ic
->
	`check_≠icid_u£d
(
≠ic_id_m≠
, 
≠ic_id
)) {

3965 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++) {

3966 i‡(!
≠ic
->
	`check_≠icid_u£d
(
≠ic_id_m≠
, 
i
))

3970 i‡(
i
 =
	`gë_physiˇl_brﬂdˇ°
())

3971 
	`∑nic
("Maxápic_idÉxceeded!\n");

3973 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]:ápic_id %dálready used, "

3974 "åyög %d\n", 
iﬂpic
, 
≠ic_id
, 
i
);

3976 
≠ic_id
 = 
i
;

3979 
tmp
 = 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
≠ic_id
);

3980 
	`physids_‹
(
≠ic_id_m≠
,ápic_id_m≠, 
tmp
);

3982 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

3983 
ªg_00
.
bôs
.
ID
 = 
≠ic_id
;

3985 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3986 
	`io_≠ic_wrôe
(
iﬂpic
, 0, 
ªg_00
.
øw
);

3987 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

3988 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3991 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

3992 
	`¥ötk
("IOAPIC[%d]: U«bÀÅÿch™gê≠ic_id!\n", 
iﬂpic
);

3997 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


3998 "IOAPIC[%d]: Assig√dápic_id %d\n", 
iﬂpic
, 
≠ic_id
);

4000  
≠ic_id
;

4001 
	}
}

4004 
__öô
 
	$io_≠ic_gë_vîsi⁄
(
iﬂpic
)

4006 
IO_APIC_ªg_01
 
ªg_01
;

4007 
Êags
;

4009 
	`•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4010 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

4011 
	`•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4013  
ªg_01
.
bôs
.
vîsi⁄
;

4014 
	}
}

4016 
	$a˝i_gë_ovîride_úq
(
bus_úq
, *
åiggî
, *
pﬁ¨ôy
)

4018 
i
;

4020 i‡(
skù_iﬂpic_£tup
)

4023 
i
 = 0; i < 
mp_úq_íåõs
; i++)

4024 i‡(
mp_úqs
[
i
].
úqty≥
 =
mp_INT
 &&

4025 
mp_úqs
[
i
].
§cbusúq
 =
bus_úq
)

4027 i‡(
i
 >
mp_úq_íåõs
)

4030 *
åiggî
 = 
	`úq_åiggî
(
i
);

4031 *
pﬁ¨ôy
 = 
	`úq_pﬁ¨ôy
(
i
);

4033 
	}
}

4040 #ifde‡
CONFIG_SMP


4041 
__öô
 
	$£tup_iﬂpic_de°
()

4043 
pö
, 
iﬂpic
 = 0, 
úq
, 
úq_íåy
;

4044 
úq_desc
 *
desc
;

4045 c⁄° 
˝umask
 *
mask
;

4047 i‡(
skù_iﬂpic_£tup
 == 1)

4050 #ifde‡
CONFIG_ACPI


4051 i‡(!
a˝i_dißbÀd
 && 
a˝i_iﬂpic
) {

4052 
iﬂpic
 = 
	`mp_föd_iﬂpic
(0);

4053 i‡(
iﬂpic
 < 0)

4054 
iﬂpic
 = 0;

4058 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
iﬂpic
];Öin++) {

4059 
úq_íåy
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4060 i‡(
úq_íåy
 == -1)

4062 
úq
 = 
	`pö_2_úq
(
úq_íåy
, 
iﬂpic
, 
pö
);

4064 
desc
 = 
	`úq_to_desc
(
úq
);

4069 i‡(
desc
->
°©us
 &

4070 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4071 
mask
 = 
desc
->
afföôy
;

4073 
mask
 = 
≠ic
->
	`èrgë_˝us
();

4075 i‡(
öå_ªm≠pög_íabÀd
)

4076 
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4078 
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4081 
	}
}

4084 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4086 
ªsour˚
 *
	giﬂpic_ªsour˚s
;

4088 
ªsour˚
 * 
__öô
 
	$iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
)

4090 
n
;

4091 
ªsour˚
 *
ªs
;

4092 *
mem
;

4093 
i
;

4095 i‡(
ƒ_iﬂpics
 <= 0)

4096  
NULL
;

4098 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
ªsour˚
);

4099 
n
 *
ƒ_iﬂpics
;

4101 
mem
 = 
	`Æloc_boŸmem
(
n
);

4102 
ªs
 = (*)
mem
;

4104 
mem
 +(
ªsour˚
Ë* 
ƒ_iﬂpics
;

4106 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4107 
ªs
[
i
].
«me
 = 
mem
;

4108 
ªs
[
i
].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4109 
	`•rötf
(
mem
, "IOAPIC %u", 
i
);

4110 
mem
 +
IOAPIC_RESOURCE_NAME_SIZE
;

4113 
iﬂpic_ªsour˚s
 = 
ªs
;

4115  
ªs
;

4116 
	}
}

4118 
__öô
 
	$iﬂpic_öô_m≠pögs
()

4120 
iﬂpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4121 
ªsour˚
 *
iﬂpic_ªs
;

4122 
i
;

4124 
iﬂpic_ªs
 = 
	`iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
);

4125 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4126 i‡(
smp_found_c⁄fig
) {

4127 
iﬂpic_phys
 = 
mp_iﬂpics
[
i
].
≠iˇddr
;

4128 #ifde‡
CONFIG_X86_32


4129 i‡(!
iﬂpic_phys
) {

4130 
	`¥ötk
(
KERN_ERR


4134 
smp_found_c⁄fig
 = 0;

4135 
skù_iﬂpic_£tup
 = 1;

4136 
Áke_iﬂpic_∑ge
;

4140 #ifde‡
CONFIG_X86_32


4141 
Áke_iﬂpic_∑ge
:

4143 
iﬂpic_phys
 = ()

4144 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

4145 
iﬂpic_phys
 = 
	`__∑
(ioapic_phys);

4147 
	`£t_fixm≠_noˇche
(
idx
, 
iﬂpic_phys
);

4148 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

4150 
	`__fix_to_vút
(
idx
), 
iﬂpic_phys
);

4151 
idx
++;

4153 
iﬂpic_ªs
->
°¨t
 = 
iﬂpic_phys
;

4154 
iﬂpic_ªs
->
íd
 = 
iﬂpic_phys
 + (4 * 1024) - 1;

4155 
iﬂpic_ªs
++;

4157 
	}
}

4159 
__öô
 
	$iﬂpic_ö£π_ªsour˚s
()

4161 
i
;

4162 
ªsour˚
 *
r
 = 
iﬂpic_ªsour˚s
;

4164 i‡(!
r
) {

4165 i‡(
ƒ_iﬂpics
 > 0)

4166 
	`¥ötk
(
KERN_ERR


4171 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4172 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
r
);

4173 
r
++;

4175 
	}
}

4177 
	$mp_föd_iﬂpic
(
gsi
)

4179 
i
 = 0;

4182 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4183 i‡((
gsi
 >
mp_gsi_routög
[
i
].
gsi_ba£
)

4184 && (
gsi
 <
mp_gsi_routög
[
i
].
gsi_íd
))

4185  
i
;

4188 
	`¥ötk
(
KERN_ERR
 "ERROR: U«bÀÅÿloˇã IOAPIC f‹ GSI %d\n", 
gsi
);

4190 
	}
}

4192 
	$mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
)

4194 i‡(
	`WARN_ON
(
iﬂpic
 == -1))

4196 i‡(
	`WARN_ON
(
gsi
 > 
mp_gsi_routög
[
iﬂpic
].
gsi_íd
))

4199  
gsi
 - 
mp_gsi_routög
[
iﬂpic
].
gsi_ba£
;

4200 
	}
}

4202 
	$bad_iﬂpic
(
addªss
)

4204 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

4205 
	`¥ötk
(
KERN_WARNING
 "WARING: Max # of I/O APICs (%d)Éxceeded "

4206 "(found %d), skùpög\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

4209 i‡(!
addªss
) {

4210 
	`¥ötk
(
KERN_WARNING
 "WARNING: Bogus (zero) I/O APICáddress"

4215 
	}
}

4217 
__öô
 
	$mp_ªgi°î_iﬂpic
(
id
, 
u32
 
addªss
, u32 
gsi_ba£
)

4219 
idx
 = 0;

4221 i‡(
	`bad_iﬂpic
(
addªss
))

4224 
idx
 = 
ƒ_iﬂpics
;

4226 
mp_iﬂpics
[
idx
].
ty≥
 = 
MP_IOAPIC
;

4227 
mp_iﬂpics
[
idx
].
Êags
 = 
MPC_APIC_USABLE
;

4228 
mp_iﬂpics
[
idx
].
≠iˇddr
 = 
addªss
;

4230 
	`£t_fixm≠_noˇche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
addªss
);

4231 
mp_iﬂpics
[
idx
].
≠icid
 = 
	`io_≠ic_unique_id
(
id
);

4232 
mp_iﬂpics
[
idx
].
≠icvî
 = 
	`io_≠ic_gë_vîsi⁄
(idx);

4238 
mp_gsi_routög
[
idx
].
gsi_ba£
 = gsi_base;

4239 
mp_gsi_routög
[
idx
].
gsi_íd
 = 
gsi_ba£
 +

4240 
	`io_≠ic_gë_ªdú_íåõs
(
idx
);

4242 
	`¥ötk
(
KERN_INFO
 "IOAPIC[%d]:ápic_id %d, version %d,áddress 0x%x, "

4243 "GSI %d-%d\n", 
idx
, 
mp_iﬂpics
[idx].
≠icid
,

4244 
mp_iﬂpics
[
idx
].
≠icvî
, mp_iﬂpics[idx].
≠iˇddr
,

4245 
mp_gsi_routög
[
idx
].
gsi_ba£
, mp_gsi_routög[idx].
gsi_íd
);

4247 
ƒ_iﬂpics
++;

4248 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<löux/˝umask.h
>

2 
	~<löux/öãºu±.h
>

3 
	~<löux/öô.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/mc146818πc.h
>

10 
	~<löux/ˇche.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/moduÀ.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mår.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/ùi.h
>

22 
	$deÁu…_£nd_IPI_mask_£quí˚_phys
(c⁄° 
˝umask
 *
mask
, 
ve˘‹
)

24 
quîy_˝u
;

25 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

33 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

34 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

35 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

40 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(c⁄° 
˝umask
 *
mask
,

41 
ve˘‹
)

43 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

44 
quîy_˝u
;

45 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

50 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

51 i‡(
quîy_˝u
 =
this_˝u
)

53 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

54 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
	$deÁu…_£nd_IPI_mask_£quí˚_logiˇl
(c⁄° 
˝umask
 *
mask
,

60 
ve˘‹
)

62 
Êags
;

63 
quîy_˝u
;

71 
	`loˇl_úq_ßve
(
Êags
);

72 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
)

73 
	`__deÁu…_£nd_IPI_de°_fõld
(

74 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

75 
≠ic
->
de°_logiˇl
);

76 
	`loˇl_úq_ª°‹e
(
Êags
);

77 
	}
}

79 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_logiˇl
(c⁄° 
˝umask
 *
mask
,

80 
ve˘‹
)

82 
Êags
;

83 
quîy_˝u
;

84 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

88 
	`loˇl_úq_ßve
(
Êags
);

89 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

90 i‡(
quîy_˝u
 =
this_˝u
)

92 
	`__deÁu…_£nd_IPI_de°_fõld
(

93 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

94 
≠ic
->
de°_logiˇl
);

96 
	`loˇl_úq_ª°‹e
(
Êags
);

97 
	}
}

99 #ifde‡
CONFIG_X86_32


104 
	$deÁu…_£nd_IPI_mask_logiˇl
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

106 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

107 
Êags
;

109 i‡(
	`WARN_ONCE
(!
mask
, "empty IPI mask"))

112 
	`loˇl_úq_ßve
(
Êags
);

113 
	`WARN_ON
(
mask
 & ~
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0]);

114 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

118 
	$deÁu…_£nd_IPI_Ælbut£lf
(
ve˘‹
)

124 i‡(!(
	`num_⁄löe_˝us
() > 1))

127 
	`__deÁu…_loˇl_£nd_IPI_Ælbut£lf
(
ve˘‹
);

128 
	}
}

130 
	$deÁu…_£nd_IPI_Æl
(
ve˘‹
)

132 
	`__deÁu…_loˇl_£nd_IPI_Æl
(
ve˘‹
);

133 
	}
}

135 
	$deÁu…_£nd_IPI_£lf
(
ve˘‹
)

137 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

138 
	}
}

141 
	$c⁄vît_≠icid_to_˝u
(
≠ic_id
)

143 
i
;

145 
	`f‹_óch_possibÀ_˝u
(
i
) {

146 i‡(
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
i
Ë=
≠ic_id
)

147  
i
;

150 
	}
}

152 
	$ß„_smp_¥o˚ss‹_id
()

154 
≠icid
, 
˝uid
;

156 i‡(!
˝u_has_≠ic
)

159 
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

160 i‡(
≠icid
 =
BAD_APICID
)

163 
˝uid
 = 
	`c⁄vît_≠icid_to_˝u
(
≠icid
);

165  
˝uid
 >= 0 ? cpuid : 0;

166 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/≠ic.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/sys˘l.h
>

23 
	~<löux/≥r˝u.h
>

24 
	~<löux/k¥obes.h
>

25 
	~<löux/˝umask.h
>

26 
	~<löux/kî√l_°©.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/smp.h
>

30 
	~<asm/i8259.h
>

31 
	~<asm/io_≠ic.h
>

32 
	~<asm/¥Ÿo.h
>

33 
	~<asm/timî.h
>

35 
	~<asm/m˚.h
>

37 
	~<asm/mach_å≠s.h
>

39 
	gunknown_nmi_∑nic
;

40 
	gnmi_w©chdog_íabÀd
;

42 
˝umask_t
 
backåa˚_mask
 
	g__ªad_mo°ly
;

50 
©omic_t
 
	gnmi_a˘ive
 = 
ATOMIC_INIT
(0);

51 
EXPORT_SYMBOL
(
nmi_a˘ive
);

53 
	gnmi_w©chdog
 = 
NMI_NONE
;

54 
EXPORT_SYMBOL
(
nmi_w©chdog
);

56 
	g∑nic_⁄_timeout
;

58 
	gnmi_hz
 = 
HZ
;

59 
DEFINE_PER_CPU
(, 
wd_íabÀd
);

60 
ídÊag
 
	g__öôd©a
;

62 
ölöe
 
	$gë_nmi_cou¡
(
˝u
)

64  
	`≥r_˝u
(
úq_°©
, 
˝u
).
__nmi_cou¡
;

65 
	}
}

67 
ölöe
 
	$m˚_ö_¥ogªss
()

69 #i‡
	`deföed
(
CONFIG_X86_MCE
)

70  
	`©omic_ªad
(&
m˚_íåy
) > 0;

73 
	}
}

79 
ölöe
 
	$gë_timî_úqs
(
˝u
)

81  
	`≥r_˝u
(
úq_°©
, 
˝u
).
≠ic_timî_úqs
 +

82 
	`≥r_˝u
(
úq_°©
, 
˝u
).
úq0_úqs
;

83 
	}
}

85 #ifde‡
CONFIG_SMP


91 
__öô
 
	$nmi_˝u_busy
(*
d©a
)

93 
	`loˇl_úq_íabÀ_ö_h¨dúq
();

102 
ídÊag
 == 0)

103 
	`mb
();

104 
	}
}

107 
	$ªp‹t_brokí_nmi
(
˝u
, *
¥ev_nmi_cou¡
)

109 
	`¥ötk
(
KERN_CONT
 "\n");

111 
	`¥ötk
(
KERN_WARNING


113 
˝u
, 
¥ev_nmi_cou¡
[˝u], 
	`gë_nmi_cou¡
(cpu));

115 
	`¥ötk
(
KERN_WARNING


117 
	`¥ötk
(
KERN_WARNING


120 
	`≥r_˝u
(
wd_íabÀd
, 
˝u
) = 0;

121 
	`©omic_dec
(&
nmi_a˘ive
);

122 
	}
}

124 
	$__a˝i_nmi_dißbÀ
(*
__unu£d
)

126 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

127 
	}
}

129 
__öô
 
	$check_nmi_w©chdog
()

131 *
¥ev_nmi_cou¡
;

132 
˝u
;

134 i‡(!
	`nmi_w©chdog_a˘ive
(Ë|| !
	`©omic_ªad
(&
nmi_a˘ive
))

137 
¥ev_nmi_cou¡
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

138 i‡(!
¥ev_nmi_cou¡
)

139 
îr‹
;

141 
	`¥ötk
(
KERN_INFO
 "Testing NMI watchdog ... ");

143 #ifde‡
CONFIG_SMP


144 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

145 
	`smp_ˇŒ_fun˘i⁄
(
nmi_˝u_busy
, (*)&
ídÊag
, 0);

148 
	`f‹_óch_possibÀ_˝u
(
˝u
)

149 
¥ev_nmi_cou¡
[
˝u
] = 
	`gë_nmi_cou¡
(cpu);

150 
	`loˇl_úq_íabÀ
();

151 
	`mdñay
((20 * 1000Ë/ 
nmi_hz
);

153 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

154 i‡(!
	`≥r_˝u
(
wd_íabÀd
, 
˝u
))

156 i‡(
	`gë_nmi_cou¡
(
˝u
Ë- 
¥ev_nmi_cou¡
[cpu] <= 5)

157 
	`ªp‹t_brokí_nmi
(
˝u
, 
¥ev_nmi_cou¡
);

159 
ídÊag
 = 1;

160 i‡(!
	`©omic_ªad
(&
nmi_a˘ive
)) {

161 
	`k‰ì
(
¥ev_nmi_cou¡
);

162 
	`©omic_£t
(&
nmi_a˘ive
, -1);

163 
îr‹
;

165 
	`¥ötk
("OK.\n");

171 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

172 
nmi_hz
 = 
	`œpic_adju°_nmi_hz
(1);

174 
	`k‰ì
(
¥ev_nmi_cou¡
);

176 
îr‹
:

177 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

178 i‡(!
timî_through_8259
)

179 
	`dißbÀ_8259A_úq
(0);

180 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

183 #ifde‡
CONFIG_X86_32


184 
timî_ack
 = 0;

187 
	}
}

189 
__öô
 
	$£tup_nmi_w©chdog
(*
°r
)

191 
nmi
;

193 i‡(!
	`°∫cmp
(
°r
, "panic", 5)) {

194 
∑nic_⁄_timeout
 = 1;

195 
°r
 = 
	`°rchr
(str, ',');

196 i‡(!
°r
)

198 ++
°r
;

201 i‡(!
	`°∫cmp
(
°r
, "lapic", 5))

202 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

203 i‡(!
	`°∫cmp
(
°r
, "ioapic", 6))

204 
nmi_w©chdog
 = 
NMI_IO_APIC
;

206 
	`gë_›ti⁄
(&
°r
, &
nmi
);

207 i‡(
nmi
 >
NMI_INVALID
)

209 
nmi_w©chdog
 = 
nmi
;

213 
	}
}

214 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

219 #ifde‡
CONFIG_PM


221 
	gnmi_pm_a˘ive
;

223 
	$œpic_nmi_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

226 
nmi_pm_a˘ive
 = 
	`©omic_ªad
(&
nmi_a˘ive
);

227 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

228 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

230 
	}
}

232 
	$œpic_nmi_ªsume
(
sys_devi˚
 *
dev
)

235 i‡(
nmi_pm_a˘ive
 > 0) {

236 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

237 
	`touch_nmi_w©chdog
();

240 
	}
}

242 
sysdev_˛ass
 
	gnmi_sys˛ass
 = {

243 .
«me
 = "lapic_nmi",

244 .
	gªsume
 = 
œpic_nmi_ªsume
,

245 .
	gsu•íd
 = 
œpic_nmi_su•íd
,

248 
sys_devi˚
 
	gdevi˚_œpic_nmi
 = {

249 .
id
 = 0,

250 .
	g˛s
 = &
nmi_sys˛ass
,

253 
__öô
 
	$öô_œpic_nmi_sysfs
()

255 
îr‹
;

261 i‡(
nmi_w©chdog
 !
NMI_LOCAL_APIC
)

264 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) < 0)

267 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
nmi_sys˛ass
);

268 i‡(!
îr‹
)

269 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic_nmi
);

270  
îr‹
;

271 
	}
}

274 
œã_öôˇŒ
(
öô_œpic_nmi_sysfs
);

278 
	$__a˝i_nmi_íabÀ
(*
__unu£d
)

280 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
);

281 
	}
}

286 
	$a˝i_nmi_íabÀ
()

288 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

289 
	`⁄_óch_˝u
(
__a˝i_nmi_íabÀ
, 
NULL
, 1);

290 
	}
}

295 
	$a˝i_nmi_dißbÀ
()

297 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

298 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

299 
	}
}

305 
	$˝u_nmi_£t_wd_íabÀd
()

307 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

308 
	}
}

310 
	$£tup_≠ic_nmi_w©chdog
(*
unu£d
)

312 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
))

317 i‡(
	`smp_¥o˚ss‹_id
(Ë!0 && 
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

320 
nmi_w©chdog
) {

321 
NMI_LOCAL_APIC
:

322 i‡(
	`œpic_w©chdog_öô
(
nmi_hz
) < 0) {

323 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

327 
NMI_IO_APIC
:

328 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

329 
	`©omic_öc
(&
nmi_a˘ive
);

331 
	}
}

333 
	$°›_≠ic_nmi_w©chdog
(*
unu£d
)

336 i‡(!
	`nmi_w©chdog_a˘ive
())

338 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
) == 0)

340 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

341 
	`œpic_w©chdog_°›
();

343 
	`__a˝i_nmi_dißbÀ
(
NULL
);

344 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

345 
	`©omic_dec
(&
nmi_a˘ive
);

346 
	}
}

362 
DEFINE_PER_CPU
(, 
œ°_úq_sum
);

363 
DEFINE_PER_CPU
(
loˇl_t
, 
Æît_cou¡î
);

364 
DEFINE_PER_CPU
(, 
nmi_touch
);

366 
	$touch_nmi_w©chdog
()

368 i‡(
	`nmi_w©chdog_a˘ive
()) {

369 
˝u
;

376 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

377 i‡(
	`≥r_˝u
(
nmi_touch
, 
˝u
) != 1)

378 
	`≥r_˝u
(
nmi_touch
, 
˝u
) = 1;

385 
	`touch_so·lockup_w©chdog
();

386 
	}
}

387 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

389 
nŸø˚
 
__k¥obes
 

390 
	$nmi_w©chdog_tick
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

397 
sum
;

398 
touched
 = 0;

399 
˝u
 = 
	`smp_¥o˚ss‹_id
();

400 
rc
 = 0;

403 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

404 =
NOTIFY_STOP
) {

405 
rc
 = 1;

406 
touched
 = 1;

409 
sum
 = 
	`gë_timî_úqs
(
˝u
);

411 i‡(
	`__gë_˝u_v¨
(
nmi_touch
)) {

412 
	`__gë_˝u_v¨
(
nmi_touch
) = 0;

413 
touched
 = 1;

417 i‡(
	`˝umask_ã°_˝u
(
˝u
, &
backåa˚_mask
)) {

418 
	`DEFINE_SPINLOCK
(
lock
);

420 
	`•ö_lock
(&
lock
);

421 
	`¥ötk
(
KERN_WARNING
 "NMI backåa˚ f‹ cpu %d\n", 
˝u
);

422 
	`show_ªgs
(
ªgs
);

423 
	`dump_°ack
();

424 
	`•ö_u∆ock
(&
lock
);

425 
	`˝umask_˛ór_˝u
(
˝u
, &
backåa˚_mask
);

427 
rc
 = 1;

431 i‡(
	`m˚_ö_¥ogªss
())

432 
touched
 = 1;

435 i‡(!
touched
 && 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë=
sum
) {

440 
	`loˇl_öc
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
));

441 i‡(
	`loˇl_ªad
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
)Ë=5 * 
nmi_hz
)

445 
	`dõ_nmi
("BUG: NMI Watchdog detected LOCKUP",

446 
ªgs
, 
∑nic_⁄_timeout
);

448 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë
sum
;

449 
	`loˇl_£t
(&
	`__gë_˝u_v¨
(
Æît_cou¡î
), 0);

453 i‡(!
	`__gë_˝u_v¨
(
wd_íabÀd
))

454  
rc
;

455 
nmi_w©chdog
) {

456 
NMI_LOCAL_APIC
:

457 
rc
 |
	`œpic_wd_evít
(
nmi_hz
);

459 
NMI_IO_APIC
:

465 
rc
 = 1;

468  
rc
;

469 
	}
}

471 #ifde‡
CONFIG_SYSCTL


473 
	$íabÀ_iﬂpic_nmi_w©chdog_sögÀ
(*
unu£d
)

475 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

476 
	`©omic_öc
(&
nmi_a˘ive
);

477 
	`__a˝i_nmi_íabÀ
(
NULL
);

478 
	}
}

480 
	$íabÀ_iﬂpic_nmi_w©chdog
()

482 
	`⁄_óch_˝u
(
íabÀ_iﬂpic_nmi_w©chdog_sögÀ
, 
NULL
, 1);

483 
	`touch_nmi_w©chdog
();

484 
	}
}

486 
	$dißbÀ_iﬂpic_nmi_w©chdog
()

488 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

489 
	}
}

491 
__öô
 
	$£tup_unknown_nmi_∑nic
(*
°r
)

493 
unknown_nmi_∑nic
 = 1;

495 
	}
}

496 
__£tup
("unknown_nmi_∑nic", 
£tup_unknown_nmi_∑nic
);

498 
	$unknown_nmi_∑nic_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

500 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

501 
buf
[64];

503 
	`•rötf
(
buf
, "NMIÑe˚ived f‹ unknow¿ªas⁄ %02x\n", 
ªas⁄
);

504 
	`dõ_nmi
(
buf
, 
ªgs
, 1);

506 
	}
}

511 
	$¥oc_nmi_íabÀd
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

512 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

514 
ﬁd_°©e
;

516 
nmi_w©chdog_íabÀd
 = (
	`©omic_ªad
(&
nmi_a˘ive
) > 0) ? 1 : 0;

517 
ﬁd_°©e
 = 
nmi_w©chdog_íabÀd
;

518 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
buf„r
, 
Àngth
, 
µos
);

519 i‡(!!
ﬁd_°©e
 =!!
nmi_w©chdog_íabÀd
)

522 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë< 0 || !
	`nmi_w©chdog_a˘ive
()) {

523 
	`¥ötk
(
KERN_WARNING


525  -
EIO
;

528 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
) {

529 i‡(
nmi_w©chdog_íabÀd
)

530 
	`íabÀ_œpic_nmi_w©chdog
();

532 
	`dißbÀ_œpic_nmi_w©chdog
();

533 } i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

534 i‡(
nmi_w©chdog_íabÀd
)

535 
	`íabÀ_iﬂpic_nmi_w©chdog
();

537 
	`dißbÀ_iﬂpic_nmi_w©chdog
();

539 
	`¥ötk
(
KERN_WARNING


541  -
EIO
;

544 
	}
}

548 
	$do_nmi_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

550 #ifde‡
CONFIG_SYSCTL


551 i‡(
unknown_nmi_∑nic
)

552  
	`unknown_nmi_∑nic_ˇŒback
(
ªgs
, 
˝u
);

555 
	}
}

557 
	$¨ch_åiggî_Æl_˝u_backåa˚
()

559 
i
;

561 
	`˝umask_c›y
(&
backåa˚_mask
, 
˝u_⁄löe_mask
);

563 
	`¥ötk
(
KERN_INFO
 "sending NMIÅoáll CPUs:\n");

564 
≠ic
->
	`£nd_IPI_Æl
(
NMI_VECTOR
);

567 
i
 = 0; i < 10 * 1000; i++) {

568 i‡(
	`˝umask_em±y
(&
backåa˚_mask
))

570 
	`mdñay
(1);

572 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<löux/thªads.h
>

12 
	~<löux/˝umask.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/dm¨.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/ùi.h
>

24 
	~<asm/£tup.h
>

26 
≠ic
 
≠ic_Ê©
;

27 
≠ic
 
≠ic_physÊ©
;

28 
≠ic
 
≠ic_x2xpic_uv_x
;

29 
≠ic
 
≠ic_x2≠ic_phys
;

30 
≠ic
 
≠ic_x2≠ic_˛u°î
;

32 
≠ic
 
__ªad_mo°ly
 *
	g≠ic
 = &
≠ic_Ê©
;

33 
EXPORT_SYMBOL_GPL
(
≠ic
);

35 
≠ic
 *
	g≠ic_¥obe
[] 
	g__öôd©a
 = {

36 #ifde‡
CONFIG_X86_UV


37 &
≠ic_x2≠ic_uv_x
,

39 #ifde‡
CONFIG_X86_X2APIC


40 &
≠ic_x2≠ic_phys
,

41 &
≠ic_x2≠ic_˛u°î
,

43 &
≠ic_physÊ©
,

44 
NULL
,

47 
	$≠icid_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

49  
	`h¨d_smp_¥o˚ss‹_id
(Ë>> 
ödex_msb
;

50 
	}
}

55 
__öô
 
	$deÁu…_£tup_≠ic_routög
()

57 #ifde‡
CONFIG_X86_X2APIC


58 i‡(
x2≠ic_mode


59 #ifde‡
CONFIG_X86_UV


60 && 
≠ic
 !&
≠ic_x2≠ic_uv_x


63 i‡(
x2≠ic_phys
)

64 
≠ic
 = &
≠ic_x2≠ic_phys
;

66 
≠ic
 = &
≠ic_x2≠ic_˛u°î
;

70 i‡(
≠ic
 =&
≠ic_Ê©
) {

71 
boŸ_˝u_d©a
.
x86_víd‹
) {

72 
X86_VENDOR_INTEL
:

73 i‡(
num_¥o˚ss‹s
 > 8)

74 
≠ic
 = &
≠ic_physÊ©
;

76 
X86_VENDOR_AMD
:

77 i‡(
max_physiˇl_≠icid
 >= 8)

78 
≠ic
 = &
≠ic_physÊ©
;

82 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

84 i‡(
	`is_vsmp_box
()) {

86 
≠ic
->
phys_pkg_id
 = 
≠icid_phys_pkg_id
;

93 i‡(
öå_ªm≠pög_íabÀd
)

94 
	`íabÀ_drhd_Áu…_h™dlög
();

95 
	}
}

99 
	$≠ic_£nd_IPI_£lf
(
ve˘‹
)

101 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

102 
	}
}

104 
__öô
 
	$deÁu…_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

106 
i
;

108 
i
 = 0; 
≠ic_¥obe
[i]; ++i) {

109 i‡(
≠ic_¥obe
[
i
]->
	`a˝i_madt_€m_check
(
€m_id
, 
€m_èbÀ_id
)) {

110 
≠ic
 = 
≠ic_¥obe
[
i
];

111 
	`¥ötk
(
KERN_INFO
 "Setting APICÑoutingÅo %s.\n",

112 
≠ic
->
«me
);

117 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<löux/öô.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/audô.h
>

4 
	~<asm/uni°d.h
>

6 
	gdú_˛ass
[] = {

7 
	~<asm-gíîic/audô_dú_wrôe.h
>

11 
	gªad_˛ass
[] = {

12 
	~<asm-gíîic/audô_ªad.h
>

16 
	gwrôe_˛ass
[] = {

17 
	~<asm-gíîic/audô_wrôe.h
>

21 
	gch©å_˛ass
[] = {

22 
	~<asm-gíîic/audô_ch™ge_©å.h
>

26 
	gsig«l_˛ass
[] = {

27 
	~<asm-gíîic/audô_sig«l.h
>

31 
	$audô_˛assify_¨ch
(
¨ch
)

33 #ifde‡
CONFIG_IA32_EMULATION


34 i‡(
¨ch
 =
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$audô_˛assify_sysˇŒ
(
abi
, 
sysˇŒ
)

42 #ifde‡
CONFIG_IA32_EMULATION


43 
	`ü32_˛assify_sysˇŒ
();

44 i‡(
abi
 =
AUDIT_ARCH_I386
)

45  
	`ü32_˛assify_sysˇŒ
(
sysˇŒ
);

47 
sysˇŒ
) {

48 
__NR_›í
:

50 
__NR_›í©
:

52 
__NR_execve
:

57 
	}
}

59 
__öô
 
	$audô_˛as£s_öô
()

61 #ifde‡
CONFIG_IA32_EMULATION


62 
__u32
 
ü32_dú_˛ass
[];

63 
__u32
 
ü32_wrôe_˛ass
[];

64 
__u32
 
ü32_ªad_˛ass
[];

65 
__u32
 
ü32_ch©å_˛ass
[];

66 
__u32
 
ü32_sig«l_˛ass
[];

67 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE_32
, 
ü32_wrôe_˛ass
);

68 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ_32
, 
ü32_ªad_˛ass
);

69 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE_32
, 
ü32_dú_˛ass
);

70 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR_32
, 
ü32_ch©å_˛ass
);

71 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL_32
, 
ü32_sig«l_˛ass
);

73 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE
, 
wrôe_˛ass
);

74 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ
, 
ªad_˛ass
);

75 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE
, 
dú_˛ass
);

76 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR
, 
ch©å_˛ass
);

77 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL
, 
sig«l_˛ass
);

79 
	}
}

81 
__öôˇŒ
(
audô_˛as£s_öô
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<löux/ty≥s.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/•ölock.h
>

10 
	~<löux/a˝i.h
>

11 
	~<asm/io.h
>

13 
	~<löux/mc146818πc.h
>

15 
	#SBF_RESERVED
 (0x78)

	)

16 
	#SBF_PNPOS
 (1<<0)

	)

17 
	#SBF_BOOTING
 (1<<1)

	)

18 
	#SBF_DIAG
 (1<<2)

	)

19 
	#SBF_PARITY
 (1<<7)

	)

21 
sbf_p‹t
 
	g__öôd©a
 = -1;

23 
__öô
 
	$∑rôy
(
u8
 
v
)

25 
x
 = 0;

26 
i
;

28 
i
 = 0; i < 8; i++) {

29 
x
 ^(
v
 & 1);

30 
v
 >>= 1;

33  
x
;

34 
	}
}

36 
__öô
 
	$sbf_wrôe
(
u8
 
v
)

38 
Êags
;

40 i‡(
sbf_p‹t
 != -1) {

41 
v
 &~
SBF_PARITY
;

42 i‡(!
	`∑rôy
(
v
))

43 
v
 |
SBF_PARITY
;

45 
	`¥ötk
(
KERN_INFO
 "Simple Boot Flagát 0x%x setÅo 0x%x\n",

46 
sbf_p‹t
, 
v
);

48 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

49 
	`CMOS_WRITE
(
v
, 
sbf_p‹t
);

50 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

52 
	}
}

54 
u8
 
__öô
 
	$sbf_ªad
()

56 
Êags
;

57 
u8
 
v
;

59 i‡(
sbf_p‹t
 == -1)

62 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

63 
v
 = 
	`CMOS_READ
(
sbf_p‹t
);

64 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

66  
v
;

67 
	}
}

69 
__öô
 
	$sbf_vÆue_vÆid
(
u8
 
v
)

71 i‡(
v
 & 
SBF_RESERVED
)

73 i‡(!
	`∑rôy
(
v
))

77 
	}
}

79 
__öô
 
	$sbf_öô
()

81 
u8
 
v
;

83 i‡(
sbf_p‹t
 == -1)

86 
v
 = 
	`sbf_ªad
();

87 i‡(!
	`sbf_vÆue_vÆid
(
v
)) {

88 
	`¥ötk
(
KERN_WARNING
 "Simple Boot Flag value 0x%xÑead from "

89 "CMOS RAM wa†övÆid\n", 
v
);

92 
v
 &~
SBF_RESERVED
;

93 
v
 &~
SBF_BOOTING
;

94 
v
 &~
SBF_DIAG
;

95 #i‡
	`deföed
(
CONFIG_ISAPNP
)

96 
v
 |
SBF_PNPOS
;

98 
	`sbf_wrôe
(
v
);

101 
	}
}

102 
moduÀ_öô
(
sbf_öô
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/kthªad.h
>

4 
	~<löux/w‹kqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/¥Ÿo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__ªad_mo°ly
 
	gmem‹y_c‹ru±i⁄_check
 = -1;

18 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_size
 = 64*1024;

19 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_≥riod
 = 60;

21 
e820íåy
 
	gsˇn_¨ós
[
MAX_SCAN_AREAS
];

22 
	gnum_sˇn_¨ós
;

25 
__öô
 
	$£t_c‹ru±i⁄_check
(*
¨g
)

27 *
íd
;

29 
mem‹y_c‹ru±i⁄_check
 = 
	`sim∂e_°πﬁ
(
¨g
, &
íd
, 10);

31  (*
íd
 =0Ë? 0 : -
EINVAL
;

32 
	}
}

33 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check", 
£t_c‹ru±i⁄_check
);

35 
__öô
 
	$£t_c‹ru±i⁄_check_≥riod
(*
¨g
)

37 *
íd
;

39 
c‹ru±i⁄_check_≥riod
 = 
	`sim∂e_°πoul
(
¨g
, &
íd
, 10);

41  (*
íd
 =0Ë? 0 : -
EINVAL
;

42 
	}
}

43 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_≥riod", 
£t_c‹ru±i⁄_check_≥riod
);

45 
__öô
 
	$£t_c‹ru±i⁄_check_size
(*
¨g
)

47 *
íd
;

48 
size
;

50 
size
 = 
	`mem∑r£
(
¨g
, &
íd
);

52 i‡(*
íd
 == '\0')

53 
c‹ru±i⁄_check_size
 = 
size
;

55  (
size
 =
c‹ru±i⁄_check_size
Ë? 0 : -
EINVAL
;

56 
	}
}

57 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_size", 
£t_c‹ru±i⁄_check_size
);

60 
__öô
 
	$£tup_bios_c‹ru±i⁄_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 i‡(
mem‹y_c‹ru±i⁄_check
 == -1) {

65 
mem‹y_c‹ru±i⁄_check
 =

66 #ifde‡
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 i‡(
c‹ru±i⁄_check_size
 == 0)

75 
mem‹y_c‹ru±i⁄_check
 = 0;

77 i‡(!
mem‹y_c‹ru±i⁄_check
)

80 
c‹ru±i⁄_check_size
 = 
	`round_up
(c‹ru±i⁄_check_size, 
PAGE_SIZE
);

82 
addr
 < 
c‹ru±i⁄_check_size
 && 
num_sˇn_¨ós
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`föd_e820_¨ó_size
◊ddr, &
size
, 
PAGE_SIZE
);

86 i‡(!(
addr
 + 1))

89 i‡(
addr
 >
c‹ru±i⁄_check_size
)

92 i‡((
addr
 + 
size
Ë> 
c‹ru±i⁄_check_size
)

93 
size
 = 
c‹ru±i⁄_check_size
 - 
addr
;

95 
	`e820_upd©e_ønge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sˇn_¨ós
[
num_sˇn_¨ós
].
addr
 =áddr;

97 
sˇn_¨ós
[
num_sˇn_¨ós
].
size
 = size;

98 
num_sˇn_¨ós
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +
size
;

106 
	`¥ötk
(
KERN_INFO
 "Scanning %dáreas forÜow memory corruption\n",

107 
num_sˇn_¨ós
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_f‹_bios_c‹ru±i⁄
()

114 
i
;

115 
c‹ru±i⁄
 = 0;

117 i‡(!
mem‹y_c‹ru±i⁄_check
)

120 
i
 = 0; i < 
num_sˇn_¨ós
; i++) {

121 *
addr
 = 
	`__va
(
sˇn_¨ós
[
i
].addr);

122 
size
 = 
sˇn_¨ós
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 i‡(!*
addr
)

127 
	`¥ötk
(
KERN_ERR
 "CorruptedÜow memoryát %p (%lxÖhys) = %08lx\n",

128 
addr
, 
	`__∑
(addr), *addr);

129 
c‹ru±i⁄
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
c‹ru±i⁄
, 
KERN_ERR
 "Memory corruption detected inÜow memory\n");

135 
	}
}

137 
check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_w‹k
, 
check_c‹ru±i⁄
);

140 
	$check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
)

142 
	`check_f‹_bios_c‹ru±i⁄
();

143 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
,

144 
	`round_jiffõs_ªœtive
(
c‹ru±i⁄_check_≥riod
*
HZ
));

145 
	}
}

147 
	$°¨t_≥riodic_check_f‹_c‹ru±i⁄
()

149 i‡(!
mem‹y_c‹ru±i⁄_check
 || 
c‹ru±i⁄_check_≥riod
 == 0)

152 
	`¥ötk
(
KERN_INFO
 "Scanning forÜow memory corruptionÉvery %d seconds\n",

153 
c‹ru±i⁄_check_≥riod
);

156 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
, 0);

158 
	}
}

160 
moduÀ_öô
(
°¨t_≥riodic_check_f‹_c‹ru±i⁄
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<löux/˝u.h
>

7 
	~<asm/∑t.h
>

8 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/≠ic.h
>

12 
	s˝uid_bô
 {

13 
u16
 
	m„©uª
;

14 
u8
 
	mªg
;

15 
u8
 
	mbô
;

16 
u32
 
	mÀvñ
;

19 
	e˝uid_ªgs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__˝uöô
 
	$öô_sˇâîed_˝uid_„©uªs
(
˝uöfo_x86
 *
c
)

28 
u32
 
max_Àvñ
;

29 
u32
 
ªgs
[4];

30 c⁄° 
˝uid_bô
 *
cb
;

32 c⁄° 
˝uid_bô
 
__˝uöôc⁄°
 
˝uid_bôs
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

38 
cb
 = 
˝uid_bôs
; cb->
„©uª
; cb++) {

41 
max_Àvñ
 = 
	`˝uid_óx
(
cb
->
Àvñ
 & 0xffff0000);

42 i‡(
max_Àvñ
 < 
cb
->
Àvñ
 ||

43 
max_Àvñ
 > (
cb
->
Àvñ
 | 0xffff))

46 
	`˝uid
(
cb
->
Àvñ
, &
ªgs
[
CR_EAX
], &ªgs[
CR_EBX
],

47 &
ªgs
[
CR_ECX
], &ªgs[
CR_EDX
]);

49 i‡(
ªgs
[
cb
->
ªg
] & (1 << cb->
bô
))

50 
	`£t_˝u_ˇp
(
c
, 
cb
->
„©uª
);

52 
	}
}

55 
	#SMT_LEVEL
 0

	)

58 
	#INVALID_TYPE
 0

	)

59 
	#SMT_TYPE
 1

	)

60 
	#CORE_TYPE
 2

	)

62 
	#LEAFB_SUBTYPE
(
ecx
Ë((”cxË>> 8Ë& 0xff)

	)

63 
	#BITS_SHIFT_NEXT_LEVEL
(
óx
Ë(”axË& 0x1f)

	)

64 
	#LEVEL_MAX_SIBLINGS
(
ebx
Ë(”bxË& 0xffff)

	)

71 
__˝uöô
 
	$dëe˘_exãnded_t›ﬁogy
(
˝uöfo_x86
 *
c
)

73 #ifde‡
CONFIG_SMP


74 
óx
, 
ebx
, 
ecx
, 
edx
, 
sub_ödex
;

75 
ht_mask_width
, 
c‹e_∂us_mask_width
;

76 
c‹e_£À˘_mask
, 
c‹e_Àvñ_siblögs
;

78 i‡(
c
->
˝uid_Àvñ
 < 0xb)

81 
	`˝uid_cou¡
(0xb, 
SMT_LEVEL
, &
óx
, &
ebx
, &
ecx
, &
edx
);

86 i‡(
ebx
 =0 || (
	`LEAFB_SUBTYPE
(
ecx
Ë!
SMT_TYPE
))

89 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

94 
c
->
öôül_≠icid
 = 
edx
;

99 
c‹e_Àvñ_siblögs
 = 
smp_num_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

100 
c‹e_∂us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

102 
sub_ödex
 = 1;

104 
	`˝uid_cou¡
(0xb, 
sub_ödex
, &
óx
, &
ebx
, &
ecx
, &
edx
);

109 i‡(
	`LEAFB_SUBTYPE
(
ecx
Ë=
CORE_TYPE
) {

110 
c‹e_Àvñ_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

111 
c‹e_∂us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

115 
sub_ödex
++;

116 } 
	`LEAFB_SUBTYPE
(
ecx
Ë!
INVALID_TYPE
);

118 
c‹e_£À˘_mask
 = (~(-1 << 
c‹e_∂us_mask_width
)Ë>> 
ht_mask_width
;

120 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ht_mask_width
)

121 & 
c‹e_£À˘_mask
;

122 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
c‹e_∂us_mask_width
);

126 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

128 
c
->
x86_max_c‹es
 = (
c‹e_Àvñ_siblögs
 / 
smp_num_siblögs
);

131 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

132 
c
->
phys_¥oc_id
);

133 i‡(
c
->
x86_max_c‹es
 > 1)

134 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

135 
c
->
˝u_c‹e_id
);

138 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<löux/öô.h
>

2 
	~<löux/bô›s.h
>

3 
	~<löux/mm.h
>

5 
	~<löux/io.h
>

6 
	~<asm/¥o˚ss‹.h
>

7 
	~<asm/≠ic.h
>

8 
	~<asm/˝u.h
>

9 
	~<asm/pci-dúe˘.h
>

11 #ifde‡
CONFIG_X86_64


12 
	~<asm/numa_64.h
>

13 
	~<asm/mmc⁄fig.h
>

14 
	~<asm/ˇcheÊush.h
>

17 
	~"˝u.h
"

19 #ifde‡
CONFIG_X86_32


33 
vide
();

34 
__asm__
(".align 4\nvide:Ñet");

36 
__˝uöô
 
	$öô_amd_k5
(
˝uöfo_x86
 *
c
)

44 
	#CBAR
 (0xfffcË

	)

45 
	#CBAR_ENB
 (0x80000000)

	)

46 
	#CBAR_KEY
 (0X000000CB)

	)

47 i‡(
c
->
x86_modñ
 == 9 || c->x86_model == 10) {

48 i‡(
	`öl
(
CBAR
Ë& 
CBAR_ENB
)

49 
	`oué
(0 | 
CBAR_KEY
, 
CBAR
);

51 
	}
}

54 
__˝uöô
 
	$öô_amd_k6
(
˝uöfo_x86
 *
c
)

56 
u32
 
l
, 
h
;

57 
mbyãs
 = 
num_phy•ages
 >> (20-
PAGE_SHIFT
);

59 i‡(
c
->
x86_modñ
 < 6) {

61 i‡(
c
->
x86_modñ
 == 0) {

62 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_APIC
);

63 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PGE
);

68 i‡(
c
->
x86_modñ
 =6 && c->
x86_mask
 == 1) {

69 c⁄° 
K6_BUG_LOOP
 = 1000000;

70 
n
;

71 (*
f_vide
)();

72 
d
, 
d2
;

74 
	`¥ötk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

81 
n
 = 
K6_BUG_LOOP
;

82 
f_vide
 = 
vide
;

83 
	`rdts˛
(
d
);

84 
n
--)

85 
	`f_vide
();

86 
	`rdts˛
(
d2
);

87 
d
 = 
d2
-d;

89 i‡(
d
 > 20*
K6_BUG_LOOP
)

90 
	`¥ötk
(
KERN_CONT


93 
	`¥ötk
(
KERN_CONT
 "probably OK (after B9730xxxx).\n");

94 
	`¥ötk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

98 i‡(
c
->
x86_modñ
 < 8 ||

99 (
c
->
x86_modñ
 =8 && c->
x86_mask
 < 8)) {

101 i‡(
mbyãs
 > 508)

102 
mbyãs
 = 508;

104 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

105 i‡((
l
&0x0000FFFF) == 0) {

106 
Êags
;

107 
l
 = (1<<0)|((
mbyãs
/4)<<1);

108 
	`loˇl_úq_ßve
(
Êags
);

109 
	`wbövd
();

110 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

111 
	`loˇl_úq_ª°‹e
(
Êags
);

112 
	`¥ötk
(
KERN_INFO
 "Enabling old style K6 writeállocation for %d Mb\n",

113 
mbyãs
);

118 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 > 7) ||

119 
c
->
x86_modñ
 == 9 || c->x86_model == 13) {

122 i‡(
mbyãs
 > 4092)

123 
mbyãs
 = 4092;

125 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

126 i‡((
l
&0xFFFF0000) == 0) {

127 
Êags
;

128 
l
 = ((
mbyãs
>>2)<<22)|(1<<16);

129 
	`loˇl_úq_ßve
(
Êags
);

130 
	`wbövd
();

131 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

132 
	`loˇl_úq_ª°‹e
(
Êags
);

133 
	`¥ötk
(
KERN_INFO
 "EnablingÇew style K6 writeállocation for %d Mb\n",

134 
mbyãs
);

140 i‡(
c
->
x86_modñ
 == 10) {

145 
	}
}

147 
__˝uöô
 
	$amd_k7_smp_check
(
˝uöfo_x86
 *
c
)

149 #ifde‡
CONFIG_SMP


151 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

159 i‡((
c
->
x86_modñ
 =6Ë&& ((c->
x86_mask
 == 0) ||

160 (
c
->
x86_mask
 == 1)))

161 
vÆid_k7
;

164 i‡((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 == 0))

165 
vÆid_k7
;

174 i‡(((
c
->
x86_modñ
 =6Ë&& (c->
x86_mask
 >= 2)) ||

175 ((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 >= 1)) ||

176 (
c
->
x86_modñ
 > 7))

177 i‡(
˝u_has_mp
)

178 
vÆid_k7
;

186 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

188 i‡(!
	`ã°_èöt
(
TAINT_UNSAFE_SMP
))

189 
	`add_èöt
(
TAINT_UNSAFE_SMP
);

191 
vÆid_k7
:

194 
	}
}

196 
__˝uöô
 
	$öô_amd_k7
(
˝uöfo_x86
 *
c
)

198 
u32
 
l
, 
h
;

205 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 10) {

206 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XMM
)) {

207 
	`¥ötk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

208 
	`rdm§
(
MSR_K7_HWCR
, 
l
, 
h
);

209 
l
 &= ~0x00008000;

210 
	`wrm§
(
MSR_K7_HWCR
, 
l
, 
h
);

211 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XMM
);

220 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

221 
	`rdm§
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

222 i‡((
l
 & 0xfff00000) != 0x20000000) {

223 
	`¥ötk
(
KERN_INFO


225 
l
, ((l & 0x000fffff)|0x20000000));

226 
	`wrm§
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

230 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K7
);

232 
	`amd_k7_smp_check
(
c
);

233 
	}
}

236 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

237 
__˝uöô
 
	$√¨by_node
(
≠icid
)

239 
i
, 
node
;

241 
i
 = 
≠icid
 - 1; i >= 0; i--) {

242 
node
 = 
≠icid_to_node
[
i
];

243 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

244  
node
;

246 
i
 = 
≠icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

247 
node
 = 
≠icid_to_node
[
i
];

248 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

249  
node
;

251  
	`fú°_node
(
node_⁄löe_m≠
);

252 
	}
}

261 #ifde‡
CONFIG_X86_HT


262 
__˝uöô
 
	$amd_fixup_dcm
(
˝uöfo_x86
 *
c
)

264 #ifde‡
CONFIG_PCI


265 
u32
 
t
, 
˝n
;

266 
u8
 
n
, 
n_id
;

267 
˝u
 = 
	`smp_¥o˚ss‹_id
();

270 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
))

274 
t
 = 
	`ªad_pci_c⁄fig
(0, 24, 3, 0xe8);

275 i‡(!(
t
 & (1 << 29)))

278 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_AMD_DCM
);

281 
˝n
 = 
c
->
x86_max_c‹es
 >> 1;

284 
n
 = 
c
->
phys_¥oc_id
 << 1;

290 
t
 = 
	`ªad_pci_c⁄fig
(0, 24 + 
n
, 3, 0xe8);

291 
n
 = (
t
>>30) & 0x3;

292 i‡(
n
 == 0) {

293 i‡(
c
->
˝u_c‹e_id
 < 
˝n
)

294 
n_id
 = 0;

296 
n_id
 = 1;

298 i‡(
c
->
˝u_c‹e_id
 < 
˝n
)

299 
n_id
 = 1;

301 
n_id
 = 0;

305 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë(
c
->
phys_¥oc_id
 << 1Ë+ 
n_id
;

308 
c
->
˝u_c‹e_id
 = c->˝u_c‹e_id % 
˝n
;

310 
	}
}

317 
__˝uöô
 
	$amd_dëe˘_cmp
(
˝uöfo_x86
 *
c
)

319 #ifde‡
CONFIG_X86_HT


320 
bôs
;

321 
˝u
 = 
	`smp_¥o˚ss‹_id
();

323 
bôs
 = 
c
->
x86_c‹eid_bôs
;

325 
c
->
˝u_c‹e_id
 = c->
öôül_≠icid
 & ((1 << 
bôs
)-1);

327 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
 >> 
bôs
;

329 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
c
->
phys_¥oc_id
;

331 i‡((
c
->
x86
 =0x10Ë&& (c->
x86_modñ
 == 9))

332 
	`amd_fixup_dcm
(
c
);

334 
	}
}

336 
	$amd_gë_nb_id
(
˝u
)

338 
id
 = 0;

339 #ifde‡
CONFIG_SMP


340 
id
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

342  
id
;

343 
	}
}

344 
EXPORT_SYMBOL_GPL
(
amd_gë_nb_id
);

346 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

348 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

349 
˝u
 = 
	`smp_¥o˚ss‹_id
();

350 
node
;

351 
≠icid
 = 
c
->apicid;

353 
node
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

355 i‡(
≠icid_to_node
[
≠icid
] !
NUMA_NO_NODE
)

356 
node
 = 
≠icid_to_node
[
≠icid
];

357 i‡(!
	`node_⁄löe
(
node
)) {

368 
ht_nodeid
 = 
c
->
öôül_≠icid
;

370 i‡(
ht_nodeid
 >= 0 &&

371 
≠icid_to_node
[
ht_nodeid
] !
NUMA_NO_NODE
)

372 
node
 = 
≠icid_to_node
[
ht_nodeid
];

374 i‡(!
	`node_⁄löe
(
node
))

375 
node
 = 
	`√¨by_node
(
≠icid
);

377 
	`numa_£t_node
(
˝u
, 
node
);

379 
	`¥ötk
(
KERN_INFO
 "CPU %d/0x%x -> Nodê%d\n", 
˝u
, 
≠icid
, 
node
);

381 
	}
}

383 
__˝uöô
 
	$óæy_öô_amd_mc
(
˝uöfo_x86
 *
c
)

385 #ifde‡
CONFIG_X86_HT


386 
bôs
, 
ecx
;

389 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000008)

392 
ecx
 = 
	`˝uid_ecx
(0x80000008);

394 
c
->
x86_max_c‹es
 = (
ecx
 & 0xff) + 1;

397 
bôs
 = (
ecx
 >> 12) & 0xF;

400 i‡(
bôs
 == 0) {

401 (1 << 
bôs
Ë< 
c
->
x86_max_c‹es
)

402 
bôs
++;

405 
c
->
x86_c‹eid_bôs
 = 
bôs
;

407 
	}
}

409 
__˝uöô
 
	$óæy_öô_amd
(
˝uöfo_x86
 *
c
)

411 
	`óæy_öô_amd_mc
(
c
);

417 i‡(
c
->
x86_powî
 & (1 << 8)) {

418 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

419 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

422 #ifde‡
CONFIG_X86_64


423 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSCALL32
);

426 i‡(
c
->
x86
 == 5)

427 i‡(
c
->
x86_modñ
 == 13 || c->x86_model == 9 ||

428 (
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 8))

429 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K6_MTRR
);

431 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_PCI
)

433 i‡(
˝u_has_≠ic
 && 
c
->
x86
 >= 0xf) {

434 
vÆ
;

435 
vÆ
 = 
	`ªad_pci_c⁄fig
(0, 24, 0, 0x68);

436 i‡((
vÆ
 & ((1 << 17) | (1 << 18))) == ((1 << 17) | (1 << 18)))

437 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EXTD_APICID
);

440 
	}
}

442 
__˝uöô
 
	$öô_amd
(
˝uöfo_x86
 *
c
)

444 #ifde‡
CONFIG_SMP


445 
vÆue
;

454 i‡(
c
->
x86
 == 0xf) {

455 
	`rdm§l
(
MSR_K7_HWCR
, 
vÆue
);

456 
vÆue
 |= 1 << 6;

457 
	`wrm§l
(
MSR_K7_HWCR
, 
vÆue
);

461 
	`óæy_öô_amd
(
c
);

467 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

469 #ifde‡
CONFIG_X86_64


471 i‡(
c
->
x86
 == 0xf) {

472 
u32
 
Àvñ
;

474 
Àvñ
 = 
	`˝uid_óx
(1);

475 i‡((
Àvñ
 >= 0x0f48 &&Üevel < 0x0f50) ||Üevel >= 0x0f58)

476 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

483 i‡(
c
->
x86_modñ
 < 0x14 && 
	`˝u_has
(c, 
X86_FEATURE_LAHF_LM
)) {

484 
u64
 
vÆ
;

486 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_LAHF_LM
);

487 i‡(!
	`rdm§l_amd_ß„
(0xc001100d, &
vÆ
)) {

488 
vÆ
 &= ~(1ULL << 32);

489 
	`wrm§l_amd_ß„
(0xc001100d, 
vÆ
);

494 i‡(
c
->
x86
 == 0x10 || c->x86 == 0x11)

495 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

498 
c
->
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

507 
c
->
x86
) {

509 
	`öô_amd_k5
(
c
);

512 
	`öô_amd_k6
(
c
);

515 
	`öô_amd_k7
(
c
);

520 i‡(
c
->
x86
 < 6)

521 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_MCE
);

525 i‡(
c
->
x86
 >= 6)

526 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

528 i‡(!
c
->
x86_modñ_id
[0]) {

529 
c
->
x86
) {

533 
	`°r˝y
(
c
->
x86_modñ_id
, "Hammer");

538 
	`di•œy_ˇcheöfo
(
c
);

541 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

542 
	`amd_dëe˘_cmp
(
c
);

543 
	`§©_dëe˘_node
(
c
);

546 #ifde‡
CONFIG_X86_32


547 
	`dëe˘_ht
(
c
);

550 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000006) {

551 i‡((
c
->
x86
 >0x0fË&& (
	`˝uid_edx
(0x80000006) & 0xf000))

552 
num_ˇche_Àaves
 = 4;

554 
num_ˇche_Àaves
 = 3;

557 i‡(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

558 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K8
);

560 i‡(
˝u_has_xmm2
) {

562 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

565 #ifde‡
CONFIG_X86_64


566 i‡(
c
->
x86
 == 0x10) {

568 i‡(
c
 =&
boŸ_˝u_d©a
)

569 
	`check_íabÀ_amd_mmc⁄f_dmi
();

571 
	`Ám10h_check_íabÀ_mmcfg
();

574 i‡(
c
 =&
boŸ_˝u_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

575 
t£g
;

582 i‡(!
	`rdm§l_ß„
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

583 
	`¥ötk
(
KERN_DEBUG
 "t£g: %010Œx\n", 
t£g
);

584 i‡((
t£g
>>
PMD_SHIFT
) <

585 (
max_low_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

586 ((
t£g
>>
PMD_SHIFT
) <

587 (
max_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

588 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

589 
	`£t_mem‹y_4k
(()
	`__va
(
t£g
), 1);

593 
	}
}

595 #ifde‡
CONFIG_X86_32


596 
__˝uöô
 
	$amd_size_ˇche
(
˝uöfo_x86
 *
c
,

597 
size
)

600 i‡((
c
->
x86
 == 6)) {

602 i‡(
c
->
x86_modñ
 =3 && c->
x86_mask
 == 0)

603 
size
 = 64;

605 i‡(
c
->
x86_modñ
 == 4 &&

606 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

607 
size
 = 256;

609  
size
;

610 
	}
}

613 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gamd_˝u_dev
 = {

614 .
c_víd‹
 = "AMD",

615 .
	gc_idít
 = { "AuthenticAMD" },

616 #ifde‡
CONFIG_X86_32


617 .
	gc_modñs
 = {

618 { .
víd‹
 = 
X86_VENDOR_AMD
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

629 .
	gc_size_ˇche
 = 
amd_size_ˇche
,

631 .
	gc_óæy_öô
 = 
óæy_öô_amd
,

632 .
	gc_öô
 = 
öô_amd
,

633 .
	gc_x86_víd‹
 = 
X86_VENDOR_AMD
,

636 
˝u_dev_ªgi°î
(
amd_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

8 
	~<asm/Æã∫©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/mår.h
>

12 
	~<asm/ˇcheÊush.h
>

14 
__öô
 
	$check_bugs
()

16 
	`idítify_boŸ_˝u
();

17 #i‡!
	`deföed
(
CONFIG_SMP
)

18 
	`¥ötk
(
KERN_INFO
 "CPU: ");

19 
	`¥öt_˝u_öfo
(&
boŸ_˝u_d©a
);

21 
	`Æã∫©ive_ö°ru˘i⁄s
();

31 i‡(!
dúe˘_gb∑ges
)

32 
	`£t_mem‹y_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/˝u„©uª.h
>

3 c⁄° * c⁄° 
	gx86_ˇp_Êags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_EXTD_APICID
] = "extd_apicid",

63 [
X86_FEATURE_AMD_DCM
] = "amd_dcm",

64 [
X86_FEATURE_APERFMPERF
] = "aperfmperf",

65 [
X86_FEATURE_XMM3
] = "pni",

66 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

67 [
X86_FEATURE_DTES64
] = "dtes64",

68 [
X86_FEATURE_MWAIT
] = "monitor",

69 [
X86_FEATURE_DSCPL
] = "ds_cpl",

70 [
X86_FEATURE_VMX
] = "vmx",

71 [
X86_FEATURE_SMX
] = "smx",

72 [
X86_FEATURE_EST
] = "est",

73 [
X86_FEATURE_TM2
] = "tm2",

74 [
X86_FEATURE_SSSE3
] = "ssse3",

75 [
X86_FEATURE_CID
] = "cid",

76 [
X86_FEATURE_FMA
] = "fma",

77 [
X86_FEATURE_CX16
] = "cx16",

78 [
X86_FEATURE_XTPR
] = "xtpr",

79 [
X86_FEATURE_PDCM
] = "pdcm",

80 [
X86_FEATURE_DCA
] = "dca",

81 [
X86_FEATURE_XMM4_1
] = "sse4_1",

82 [
X86_FEATURE_XMM4_2
] = "sse4_2",

83 [
X86_FEATURE_X2APIC
] = "x2apic",

84 [
X86_FEATURE_MOVBE
] = "movbe",

85 [
X86_FEATURE_POPCNT
] = "popcnt",

86 [
X86_FEATURE_AES
] = "aes",

87 [
X86_FEATURE_XSAVE
] = "xsave",

88 [
X86_FEATURE_AVX
] = "avx",

89 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

90 [
X86_FEATURE_XSTORE
] = "rng",

91 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

92 [
X86_FEATURE_XCRYPT
] = "ace",

93 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

94 [
X86_FEATURE_ACE2
] = "ace2",

95 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

96 [
X86_FEATURE_PHE
] = "phe",

97 [
X86_FEATURE_PHE_EN
] = "phe_en",

98 [
X86_FEATURE_PMM
] = "pmm",

99 [
X86_FEATURE_PMM_EN
] = "pmm_en",

100 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

101 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

102 [
X86_FEATURE_SVM
] = "svm",

103 [
X86_FEATURE_EXTAPIC
] = "extapic",

104 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

105 [
X86_FEATURE_ABM
] = "abm",

106 [
X86_FEATURE_SSE4A
] = "sse4a",

107 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

108 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

109 [
X86_FEATURE_OSVW
] = "osvw",

110 [
X86_FEATURE_IBS
] = "ibs",

111 [
X86_FEATURE_SSE5
] = "sse5",

112 [
X86_FEATURE_SKINIT
] = "skinit",

113 [
X86_FEATURE_WDT
] = "wdt",

114 [
X86_FEATURE_IDA
] = "ida",

115 [
X86_FEATURE_ARAT
] = "arat",

116 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

117 [
X86_FEATURE_VNMI
] = "vnmi",

118 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

119 [
X86_FEATURE_EPT
] = "ept",

120 [
X86_FEATURE_VPID
] = "vpid",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<löux/bô›s.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/¥o˚ss‹.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"˝u.h
"

12 #ifde‡
CONFIG_X86_OOSTORE


14 
u32
 
__˝uöô
 
	$powî2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__˝uöô
 
	$˚¡aur_m¸_ö£π
(
ªg
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |
key
;

36 
	`wrm§
(
ªg
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mår_˚¡aur_ªp‹t_m¸
(
ªg
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__˝uöô
 
	$ømt›
()

47 
u32
 
˛ù
 = 0xFFFFFFFFUL;

48 
u32
 
t›
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 
°¨t
, 
íd
;

54 i‡(
e820
.
m≠
[
i
].
addr
 > 0xFFFFFFFFUL)

60 i‡(
e820
.
m≠
[
i
].
ty≥
 =
E820_RESERVED
) {

61 i‡(
e820
.
m≠
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m≠
[
i
].
addr
 < 
˛ù
)

63 
˛ù
 = 
e820
.
m≠
[
i
].
addr
;

66 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

67 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
;

68 i‡(
°¨t
 >
íd
)

70 i‡(
íd
 > 
t›
)

71 
t›
 = 
íd
;

85 i‡(
t›
 > 
˛ù
)

86 
t›
 = 
˛ù
;

88  
t›
;

89 
	}
}

94 
__˝uöô
 
	$˚¡aur_m¸_compuã
(
ƒ
, 
key
)

96 
u32
 
mem
 = 
	`ømt›
();

97 
u32
 
roŸ
 = 
	`powî2
(
mem
);

98 
u32
 
ba£
 = 
roŸ
;

99 
u32
 
t›
 = 
roŸ
;

100 
u32
 
Êo‹
 = 0;

101 
˘
 = 0;

103 
˘
 < 
ƒ
) {

104 
u32
 
f•a˚
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`powî2
(
mem
-
t›
);

116 
low
 = 
ba£
/2;

122 i‡(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 i‡(
Êo‹
 == 0)

131 
f•a˚
 = 512*1024;

132 i‡(
Êo‹
 == 512*1024)

133 
f•a˚
 = 128*1024;

140 i‡(
f•a˚
 > 
high
 && f•a˚ > 
low
) {

141 
	`˚¡aur_m¸_ö£π
(
˘
, 
Êo‹
, 
f•a˚
, 
key
);

142 
Êo‹
 +
f•a˚
;

143 } i‡(
high
 > 
low
) {

144 
	`˚¡aur_m¸_ö£π
(
˘
, 
t›
, 
high
, 
key
);

145 
t›
 +
high
;

146 } i‡(
low
 > 0) {

147 
ba£
 -
low
;

148 
	`˚¡aur_m¸_ö£π
(
˘
, 
ba£
, 
low
, 
key
);

151 
˘
++;

157  
˘
;

158 
	}
}

160 
__˝uöô
 
	$˚¡aur_¸óã_›timÆ_m¸
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__˝uöô
 
	$wöchù2_¸óã_›timÆ_m¸
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 25);

204 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |1<<(9+
i
);

207 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__˝uöô
 
	$wöchù2_u≈rŸe˘_m¸
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |
key
<<6;

229 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__˝uöô
 
	$wöchù2_¥Ÿe˘_m¸
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28Ë

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6Ë

	)

250 
__˝uöô
 
	$öô_c3
(
˝uöfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 i‡(
	`˝uid_óx
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`˝uid_edx
(0xC0000001);

259 i‡((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |
ACE_FCR
;

262 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 i‡((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |
RNG_ENABLE
;

270 
	`wrm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ˇ∑bûôy
[5] = 
	`˝uid_edx
(0xC0000001);

279 #ifde‡
CONFIG_X86_32


281 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 9) {

282 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

289 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model < 9)

290 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

292 i‡(
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0xf) {

293 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

294 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`di•œy_ˇcheöfo
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__˝uöô
 
	$óæy_öô_˚¡aur
(
˝uöfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifde‡
CONFIG_X86_32


327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 i‡(
c
->
x86_modñ
 >= 0xf)

332 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifde‡
CONFIG_X86_64


336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__˝uöô
 
	$öô_˚¡aur
(
˝uöfo_x86
 *
c
)

342 #ifde‡
CONFIG_X86_32


343 *
«me
;

344 
u32
 
f¸_£t
 = 0;

345 
u32
 
f¸_˛r
 = 0;

346 
u32
 
lo
, 
hi
, 
√wlo
;

347 
u32
 
Ø
, 
bb
, 
cc
, 
dd
;

353 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

355 
	`óæy_öô_˚¡aur
(
c
);

356 
c
->
x86
) {

357 #ifde‡
CONFIG_X86_32


359 
c
->
x86_modñ
) {

361 
«me
 = "C6";

362 
f¸_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
f¸_˛r
 = 
DPDC
;

364 
	`¥ötk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TSC
);

366 #ifde‡
CONFIG_X86_OOSTORE


367 
	`˚¡aur_¸óã_›timÆ_m¸
();

378 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
«me
 = "2";

387 
«me
 = "2A";

390 
«me
 = "2B";

393 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
f¸_˛r
 = 
DPDC
;

396 #ifde‡
CONFIG_X86_OOSTORE


397 
	`wöchù2_u≈rŸe˘_m¸
();

398 
	`wöchù2_¸óã_›timÆ_m¸
();

399 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wöchù2_¥Ÿe˘_m¸
();

412 
«me
 = "3";

413 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
f¸_˛r
 = 
DPDC
;

416 #ifde‡
CONFIG_X86_OOSTORE


417 
	`wöchù2_u≈rŸe˘_m¸
();

418 
	`wöchù2_¸óã_›timÆ_m¸
();

419 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wöchù2_¥Ÿe˘_m¸
();

432 
«me
 = "??";

435 
	`rdm§
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
√wlo
 = (
lo
|
f¸_£t
Ë& (~
f¸_˛r
);

438 i‡(
√wlo
 !
lo
) {

439 
	`¥ötk
(
KERN_INFO
 "Centaur FCR was 0x%XÇow 0x%X\n",

440 
lo
, 
√wlo
);

441 
	`wrm§
(
MSR_IDT_FCR1
, 
√wlo
, 
hi
);

443 
	`¥ötk
(
KERN_INFO
 "Cíèu∏FCR i†0x%X\n", 
lo
);

446 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

450 i‡(
c
->
x86_modñ
 >= 8)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

453 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000005) {

455 
	`˝uid
(0x80000005, &
Ø
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ˇche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`•rötf
(
c
->
x86_modñ_id
, "WöChù %s", 
«me
);

463 
	`öô_c3
(
c
);

466 #ifde‡
CONFIG_X86_64


467 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__˝uöô


472 
	$˚¡aur_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

474 #ifde‡
CONFIG_X86_32


476 i‡((
c
->
x86
 =6Ë&& ((c->
x86_modñ
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 == 9) &&

485 (
c
->
x86_mask
 =1Ë&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	g˚¡aur_˝u_dev
 = {

492 .
c_víd‹
 = "Centaur",

493 .
	gc_idít
 = { "CentaurHauls" },

494 .
	gc_óæy_öô
 = 
óæy_öô_˚¡aur
,

495 .
	gc_öô
 = 
öô_˚¡aur
,

496 .
	gc_size_ˇche
 = 
˚¡aur_size_ˇche
,

497 .
	gc_x86_víd‹
 = 
X86_VENDOR_CENTAUR
,

500 
˝u_dev_ªgi°î
(
˚¡aur_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<löux/boŸmem.h
>

2 
	~<löux/lökage.h
>

3 
	~<löux/bô›s.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/≥r˝u.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kgdb.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/io.h
>

15 
	~<asm/°ack¥Ÿe˘‹.h
>

16 
	~<asm/≥rf_evít.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/hy≥rvis‹.h
>

19 
	~<asm/¥o˚ss‹.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<löux/t›ﬁogy.h
>

22 
	~<löux/˝umask.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/≠ic.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/mår.h
>

31 
	~<löux/numa.h
>

32 
	~<asm/asm.h
>

33 
	~<asm/˝u.h
>

34 
	~<asm/m˚.h
>

35 
	~<asm/m§.h
>

36 
	~<asm/∑t.h
>

38 #ifde‡
CONFIG_X86_LOCAL_APIC


39 
	~<asm/uv/uv.h
>

42 
	~"˝u.h
"

45 
˝umask_v¨_t
 
	g˝u_öôülized_mask
;

46 
˝umask_v¨_t
 
	g˝u_ˇŒout_mask
;

47 
˝umask_v¨_t
 
	g˝u_ˇŒö_mask
;

50 
˝umask_v¨_t
 
	g˝u_siblög_£tup_mask
;

53 
__öô
 
	$£tup_˝u_loˇl_masks
()

55 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_öôülized_mask
);

56 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒö_mask
);

57 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒout_mask
);

58 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_siblög_£tup_mask
);

59 
	}
}

61 
__˝uöô
 
	$deÁu…_öô
(
˝uöfo_x86
 *
c
)

63 #ifde‡
CONFIG_X86_64


64 
	`di•œy_ˇcheöfo
(
c
);

68 i‡(
c
->
˝uid_Àvñ
 == -1) {

70 i‡(
c
->
x86
 == 4)

71 
	`°r˝y
(
c
->
x86_modñ_id
, "486");

72 i‡(
c
->
x86
 == 3)

73 
	`°r˝y
(
c
->
x86_modñ_id
, "386");

76 
	}
}

78 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gdeÁu…_˝u
 = {

79 .
c_öô
 = 
deÁu…_öô
,

80 .
	gc_víd‹
 = "Unknown",

81 .
	gc_x86_víd‹
 = 
X86_VENDOR_UNKNOWN
,

84 c⁄° 
˝u_dev
 *
this_˝u
 
	g__˝uöôd©a
 = &
deÁu…_˝u
;

86 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_∑ge
, gdt_∑geË{ .
gdt
 = {

87 #ifde‡
CONFIG_X86_64


96 [
GDT_ENTRY_KERNEL32_CS
] = 
GDT_ENTRY_INIT
(0xc09b, 0, 0xfffff),

97 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xa09b, 0, 0xfffff),

98 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc093, 0, 0xfffff),

99 [
GDT_ENTRY_DEFAULT_USER32_CS
] = 
GDT_ENTRY_INIT
(0xc0fb, 0, 0xfffff),

100 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f3, 0, 0xfffff),

101 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xa0fb, 0, 0xfffff),

103 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xc09a, 0, 0xfffff),

104 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

105 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xc0fa, 0, 0xfffff),

106 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f2, 0, 0xfffff),

113 [
GDT_ENTRY_PNPBIOS_CS32
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

115 [
GDT_ENTRY_PNPBIOS_CS16
] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

117 [
GDT_ENTRY_PNPBIOS_DS
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0xffff),

119 [
GDT_ENTRY_PNPBIOS_TS1
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

121 [
GDT_ENTRY_PNPBIOS_TS2
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

127 [
GDT_ENTRY_APMBIOS_BASE
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

129 [
GDT_ENTRY_APMBIOS_BASE
+1] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

131 [
GDT_ENTRY_APMBIOS_BASE
+2] = 
GDT_ENTRY_INIT
(0x4092, 0, 0xffff),

133 [
GDT_ENTRY_ESPFIX_SS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

134 [
GDT_ENTRY_PERCPU
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

135 
	gGDT_STACK_CANARY_INIT


138 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_∑ge
);

140 
__öô
 
	$x86_xßve_£tup
(*
s
)

142 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XSAVE
);

144 
	}
}

145 
__£tup
("noxßve", 
x86_xßve_£tup
);

147 #ifde‡
CONFIG_X86_32


148 
ˇchesize_ovîride
 
	g__˝uöôd©a
 = -1;

149 
dißbÀ_x86_£rül_ƒ
 
	g__˝uöôd©a
 = 1;

151 
__öô
 
	$ˇchesize_£tup
(*
°r
)

153 
	`gë_›ti⁄
(&
°r
, &
ˇchesize_ovîride
);

155 
	}
}

156 
__£tup
("ˇchesize=", 
ˇchesize_£tup
);

158 
__öô
 
	$x86_fx§_£tup
(*
s
)

160 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_FXSR
);

161 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XMM
);

163 
	}
}

164 
__£tup
("nofx§", 
x86_fx§_£tup
);

166 
__öô
 
	$x86_£p_£tup
(*
s
)

168 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_SEP
);

170 
	}
}

171 
__£tup
("no£p", 
x86_£p_£tup
);

174 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

176 
u32
 
f1
, 
f2
;

185 
asm
 volatile ("pushfl \n\t"

196 : "=&r" (
f1
), "=&r" (
f2
)

197 : "ú" (
Êag
));

199  ((
f1
^
f2
Ë& 
Êag
) != 0;

200 
	}
}

203 
__˝uöô
 
	$have_˝uid_p
()

205  
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_ID
);

206 
	}
}

208 
__˝uöô
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

210 
lo
, 
hi
;

212 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_PN
Ë|| !
dißbÀ_x86_£rül_ƒ
)

217 
	`rdm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

218 
lo
 |= 0x200000;

219 
	`wrm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

221 
	`¥ötk
(
KERN_NOTICE
 "CPU serialÇumber disabled.\n");

222 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PN
);

225 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

226 
	}
}

228 
__öô
 
	$x86_£rül_ƒ_£tup
(*
s
)

230 
dißbÀ_x86_£rül_ƒ
 = 0;

232 
	}
}

233 
__£tup
("£rü umbî", 
x86_£rül_ƒ_£tup
);

235 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

238 
	}
}

240 
ölöe
 
	$have_˝uid_p
()

243 
	}
}

244 
ölöe
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

246 
	}
}

254 
	s˝uid_dïídít_„©uª
 {

255 
u32
 
	m„©uª
;

256 
u32
 
	mÀvñ
;

259 c⁄° 
˝uid_dïídít_„©uª
 
__˝uöôc⁄°


260 
	g˝uid_dïídít_„©uªs
[] = {

261 { 
X86_FEATURE_MWAIT
, 0x00000005 },

262 { 
X86_FEATURE_DCA
, 0x00000009 },

263 { 
X86_FEATURE_XSAVE
, 0x0000000d },

267 
__˝uöô
 
	$fûãr_˝uid_„©uªs
(
˝uöfo_x86
 *
c
, 
boﬁ
 
w¨n
)

269 c⁄° 
˝uid_dïídít_„©uª
 *
df
;

271 
df
 = 
˝uid_dïídít_„©uªs
; df->
„©uª
; df++) {

273 i‡(!
	`˝u_has
(
c
, 
df
->
„©uª
))

282 i‡(!((
s32
)
df
->
Àvñ
 < 0 ?

283 (
u32
)
df
->
Àvñ
 > (u32)
c
->
exãnded_˝uid_Àvñ
 :

284 (
s32
)
df
->
Àvñ
 > (s32)
c
->
˝uid_Àvñ
))

287 
	`˛ór_˝u_ˇp
(
c
, 
df
->
„©uª
);

288 i‡(!
w¨n
)

291 
	`¥ötk
(
KERN_WARNING


293 
x86_ˇp_Êags
[
df
->
„©uª
], df->
Àvñ
);

295 
	}
}

305 c⁄° *
__˝uöô
 
	$èbÀ_lookup_modñ
(
˝uöfo_x86
 *
c
)

307 c⁄° 
˝u_modñ_öfo
 *
öfo
;

309 i‡(
c
->
x86_modñ
 >= 16)

310  
NULL
;

312 i‡(!
this_˝u
)

313  
NULL
;

315 
öfo
 = 
this_˝u
->
c_modñs
;

317 
öfo
 && info->
Ámûy
) {

318 i‡(
öfo
->
Ámûy
 =
c
->
x86
)

319  
öfo
->
modñ_«mes
[
c
->
x86_modñ
];

320 
öfo
++;

322  
NULL
;

323 
	}
}

325 
__u32
 
	g˝u_ˇps_˛óªd
[
NCAPINTS
] 
	g__˝uöôd©a
;

326 
__u32
 
	g˝u_ˇps_£t
[
NCAPINTS
] 
	g__˝uöôd©a
;

328 
	$lﬂd_≥r˝u_£gmít
(
˝u
)

330 #ifde‡
CONFIG_X86_32


331 
	`lﬂd£gmít
(
fs
, 
__KERNEL_PERCPU
);

333 
	`lﬂd£gmít
(
gs
, 0);

334 
	`wrm§l
(
MSR_GS_BASE
, ()
	`≥r_˝u
(
úq_°ack_uni⁄
.
gs_ba£
, 
˝u
));

336 
	`lﬂd_°ack_ˇ«ry_£gmít
();

337 
	}
}

343 
	$swôch_to_√w_gdt
(
˝u
)

345 
desc_±r
 
gdt_des¸
;

347 
gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

348 
gdt_des¸
.
size
 = 
GDT_SIZE
 - 1;

349 
	`lﬂd_gdt
(&
gdt_des¸
);

352 
	`lﬂd_≥r˝u_£gmít
(
˝u
);

353 
	}
}

355 c⁄° 
˝u_dev
 *
__˝uöôd©a
 
	g˝u_devs
[
X86_VENDOR_NUM
] = {};

357 
__˝uöô
 
	$gë_modñ_«me
(
˝uöfo_x86
 *
c
)

359 *
v
;

360 *
p
, *
q
;

362 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000004)

365 
v
 = (*)
c
->
x86_modñ_id
;

366 
	`˝uid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

367 
	`˝uid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

368 
	`˝uid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

369 
c
->
x86_modñ_id
[48] = 0;

375 
p
 = 
q
 = &
c
->
x86_modñ_id
[0];

376 *
p
 == ' ')

377 
p
++;

378 i‡(
p
 !
q
) {

379 *
p
)

380 *
q
++ = *
p
++;

381 
q
 <&
c
->
x86_modñ_id
[48])

382 *
q
++ = '\0';

384 
	}
}

386 
__˝uöô
 
	$di•œy_ˇcheöfo
(
˝uöfo_x86
 *
c
)

388 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

390 
n
 = 
c
->
exãnded_˝uid_Àvñ
;

392 i‡(
n
 >= 0x80000005) {

393 
	`˝uid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

394 
	`¥ötk
(
KERN_INFO
 "CPU: L1 I Cache: %dK (%d bytes/line), D cache %dK (%d bytes/line)\n",

395 
edx
>>24,Édx&0xFF, 
ecx
>>24,Écx&0xFF);

396 
c
->
x86_ˇche_size
 = (
ecx
>>24Ë+ (
edx
>>24);

397 #ifde‡
CONFIG_X86_64


399 
c
->
x86_ébsize
 = 0;

403 i‡(
n
 < 0x80000006)

406 
	`˝uid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

407 
l2size
 = 
ecx
 >> 16;

409 #ifde‡
CONFIG_X86_64


410 
c
->
x86_ébsize
 +((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

413 i‡(
this_˝u
->
c_size_ˇche
)

414 
l2size
 = 
this_˝u
->
	`c_size_ˇche
(
c
,Ü2size);

417 i‡(
ˇchesize_ovîride
 != -1)

418 
l2size
 = 
ˇchesize_ovîride
;

420 i‡(
l2size
 == 0)

424 
c
->
x86_ˇche_size
 = 
l2size
;

426 
	`¥ötk
(
KERN_INFO
 "CPU: L2 Cache: %dK (%d bytes/line)\n",

427 
l2size
, 
ecx
 & 0xFF);

428 
	}
}

430 
__˝uöô
 
	$dëe˘_ht
(
˝uöfo_x86
 *
c
)

432 #ifde‡
CONFIG_X86_HT


433 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

434 
ödex_msb
, 
c‹e_bôs
;

436 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_HT
))

439 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

440 
out
;

442 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

445 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
edx
);

447 
smp_num_siblögs
 = (
ebx
 & 0xff0000) >> 16;

449 i‡(
smp_num_siblögs
 == 1) {

450 
	`¥ötk
(
KERN_INFO
 "CPU: Hyper-Threading is disabled\n");

451 
out
;

454 i‡(
smp_num_siblögs
 <= 1)

455 
out
;

457 i‡(
smp_num_siblögs
 > 
ƒ_˝u_ids
) {

458 
	`¥_w¨nög
("CPU: UnsupportedÇumber of siblings %d",

459 
smp_num_siblögs
);

460 
smp_num_siblögs
 = 1;

464 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

465 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
);

467 
smp_num_siblögs
 = smp_num_siblög†/ 
c
->
x86_max_c‹es
;

469 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

471 
c‹e_bôs
 = 
	`gë_cou¡_‹dî
(
c
->
x86_max_c‹es
);

473 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
) &

474 ((1 << 
c‹e_bôs
) - 1);

476 
out
:

477 i‡((
c
->
x86_max_c‹es
 * 
smp_num_siblögs
) > 1) {

478 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

479 
c
->
phys_¥oc_id
);

480 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

481 
c
->
˝u_c‹e_id
);

484 
	}
}

486 
__˝uöô
 
	$gë_˝u_víd‹
(
˝uöfo_x86
 *
c
)

488 *
v
 = 
c
->
x86_víd‹_id
;

489 
i
;

491 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

492 i‡(!
˝u_devs
[
i
])

495 i‡(!
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[0]) ||

496 (
˝u_devs
[
i
]->
c_idít
[1] &&

497 !
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[1]))) {

499 
this_˝u
 = 
˝u_devs
[
i
];

500 
c
->
x86_víd‹
 = 
this_˝u
->
c_x86_víd‹
;

505 
	`¥ötk_⁄˚
(
KERN_ERR


507 "CPU: You∏sy°em may bêun°abÀ.\n", 
v
);

509 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

510 
this_˝u
 = &
deÁu…_˝u
;

511 
	}
}

513 
__˝uöô
 
	$˝u_dëe˘
(
˝uöfo_x86
 *
c
)

516 
	`˝uid
(0x00000000, (*)&
c
->
˝uid_Àvñ
,

517 (*)&
c
->
x86_víd‹_id
[0],

518 (*)&
c
->
x86_víd‹_id
[8],

519 (*)&
c
->
x86_víd‹_id
[4]);

521 
c
->
x86
 = 4;

523 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

524 
u32
 
junk
, 
tfms
, 
ˇp0
, 
misc
;

526 
	`˝uid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ˇp0
);

527 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

528 
c
->
x86_modñ
 = (
tfms
 >> 4) & 0xf;

529 
c
->
x86_mask
 = 
tfms
 & 0xf;

531 i‡(
c
->
x86
 == 0xf)

532 
c
->
x86
 +(
tfms
 >> 20) & 0xff;

533 i‡(
c
->
x86
 >= 0x6)

534 
c
->
x86_modñ
 +((
tfms
 >> 16) & 0xf) << 4;

536 i‡(
ˇp0
 & (1<<19)) {

537 
c
->
x86_˛Êush_size
 = ((
misc
 >> 8) & 0xff) * 8;

538 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

541 
	}
}

543 
__˝uöô
 
	$gë_˝u_ˇp
(
˝uöfo_x86
 *
c
)

545 
u32
 
tfms
, 
xlvl
;

546 
u32
 
ebx
;

549 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

550 
u32
 
ˇ∑bûôy
, 
exˇp
;

552 
	`˝uid
(0x00000001, &
tfms
, &
ebx
, &
exˇp
, &
ˇ∑bûôy
);

553 
c
->
x86_ˇ∑bûôy
[0] = 
ˇ∑bûôy
;

554 
c
->
x86_ˇ∑bûôy
[4] = 
exˇp
;

558 
xlvl
 = 
	`˝uid_óx
(0x80000000);

559 
c
->
exãnded_˝uid_Àvñ
 = 
xlvl
;

561 i‡((
xlvl
 & 0xffff0000) == 0x80000000) {

562 i‡(
xlvl
 >= 0x80000001) {

563 
c
->
x86_ˇ∑bûôy
[1] = 
	`˝uid_edx
(0x80000001);

564 
c
->
x86_ˇ∑bûôy
[6] = 
	`˝uid_ecx
(0x80000001);

568 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

569 
u32
 
óx
 = 
	`˝uid_óx
(0x80000008);

571 
c
->
x86_vút_bôs
 = (
óx
 >> 8) & 0xff;

572 
c
->
x86_phys_bôs
 = 
óx
 & 0xff;

574 #ifde‡
CONFIG_X86_32


575 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_PAE
Ë|| cpu_has(c, 
X86_FEATURE_PSE36
))

576 
c
->
x86_phys_bôs
 = 36;

579 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000007)

580 
c
->
x86_powî
 = 
	`˝uid_edx
(0x80000007);

582 
	}
}

584 
__˝uöô
 
	$idítify_˝u_wôhout_˝uid
(
˝uöfo_x86
 *
c
)

586 #ifde‡
CONFIG_X86_32


587 
i
;

593 i‡(
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_AC
))

594 
c
->
x86
 = 4;

596 
c
->
x86
 = 3;

598 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

599 i‡(
˝u_devs
[
i
] && cpu_devs[i]->
c_idítify
) {

600 
c
->
x86_víd‹_id
[0] = 0;

601 
˝u_devs
[
i
]->
	`c_idítify
(
c
);

602 i‡(
c
->
x86_víd‹_id
[0]) {

603 
	`gë_˝u_víd‹
(
c
);

608 
	}
}

619 
__öô
 
	$óæy_idítify_˝u
(
˝uöfo_x86
 *
c
)

621 #ifde‡
CONFIG_X86_64


622 
c
->
x86_˛Êush_size
 = 64;

623 
c
->
x86_phys_bôs
 = 36;

624 
c
->
x86_vút_bôs
 = 48;

626 
c
->
x86_˛Êush_size
 = 32;

627 
c
->
x86_phys_bôs
 = 32;

628 
c
->
x86_vút_bôs
 = 32;

630 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

632 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

633 
c
->
exãnded_˝uid_Àvñ
 = 0;

635 i‡(!
	`have_˝uid_p
())

636 
	`idítify_˝u_wôhout_˝uid
(
c
);

639 i‡(!
	`have_˝uid_p
())

642 
	`˝u_dëe˘
(
c
);

644 
	`gë_˝u_víd‹
(
c
);

646 
	`gë_˝u_ˇp
(
c
);

648 i‡(
this_˝u
->
c_óæy_öô
)

649 
this_˝u
->
	`c_óæy_öô
(
c
);

651 #ifde‡
CONFIG_SMP


652 
c
->
˝u_ödex
 = 
boŸ_˝u_id
;

654 
	`fûãr_˝uid_„©uªs
(
c
, 
Ál£
);

655 
	}
}

657 
__öô
 
	$óæy_˝u_öô
()

659 c⁄° 
˝u_dev
 *c⁄° *
cdev
;

660 
cou¡
 = 0;

662 
	`¥ötk
(
KERN_INFO
 "KERNEL supported cpus:\n");

663 
cdev
 = 
__x86_˝u_dev_°¨t
; cdev < 
__x86_˝u_dev_íd
; cdev++) {

664 c⁄° 
˝u_dev
 *
˝udev
 = *
cdev
;

665 
j
;

667 i‡(
cou¡
 >
X86_VENDOR_NUM
)

669 
˝u_devs
[
cou¡
] = 
˝udev
;

670 
cou¡
++;

672 
j
 = 0; j < 2; j++) {

673 i‡(!
˝udev
->
c_idít
[
j
])

675 
	`¥ötk
(
KERN_INFO
 " %†%s\n", 
˝udev
->
c_víd‹
,

676 
˝udev
->
c_idít
[
j
]);

680 
	`óæy_idítify_˝u
(&
boŸ_˝u_d©a
);

681 
	}
}

691 
__˝uöô
 
	$dëe˘_n›l
(
˝uöfo_x86
 *
c
)

693 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_NOPL
);

694 
	}
}

696 
__˝uöô
 
	$gíîic_idítify
(
˝uöfo_x86
 *
c
)

698 
c
->
exãnded_˝uid_Àvñ
 = 0;

700 i‡(!
	`have_˝uid_p
())

701 
	`idítify_˝u_wôhout_˝uid
(
c
);

704 i‡(!
	`have_˝uid_p
())

707 
	`˝u_dëe˘
(
c
);

709 
	`gë_˝u_víd‹
(
c
);

711 
	`gë_˝u_ˇp
(
c
);

713 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

714 
c
->
öôül_≠icid
 = (
	`˝uid_ebx
(1) >> 24) & 0xFF;

715 #ifde‡
CONFIG_X86_32


716 #ifde‡
CONFIG_X86_HT


717 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

719 
c
->
≠icid
 = c->
öôül_≠icid
;

723 #ifde‡
CONFIG_X86_HT


724 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
;

728 
	`gë_modñ_«me
(
c
);

730 
	`öô_sˇâîed_˝uid_„©uªs
(
c
);

731 
	`dëe˘_n›l
(
c
);

732 
	}
}

737 
__˝uöô
 
	$idítify_˝u
(
˝uöfo_x86
 *
c
)

739 
i
;

741 
c
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

742 
c
->
x86_ˇche_size
 = -1;

743 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

744 
c
->
x86_modñ
 = c->
x86_mask
 = 0;

745 
c
->
x86_víd‹_id
[0] = '\0';

746 
c
->
x86_modñ_id
[0] = '\0';

747 
c
->
x86_max_c‹es
 = 1;

748 
c
->
x86_c‹eid_bôs
 = 0;

749 #ifde‡
CONFIG_X86_64


750 
c
->
x86_˛Êush_size
 = 64;

751 
c
->
x86_phys_bôs
 = 36;

752 
c
->
x86_vút_bôs
 = 48;

754 
c
->
˝uid_Àvñ
 = -1;

755 
c
->
x86_˛Êush_size
 = 32;

756 
c
->
x86_phys_bôs
 = 32;

757 
c
->
x86_vút_bôs
 = 32;

759 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

760 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

762 
	`gíîic_idítify
(
c
);

764 i‡(
this_˝u
->
c_idítify
)

765 
this_˝u
->
	`c_idítify
(
c
);

768 
i
 = 0; i < 
NCAPINTS
; i++) {

769 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

770 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

773 #ifde‡
CONFIG_X86_64


774 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

787 i‡(
this_˝u
->
c_öô
)

788 
this_˝u
->
	`c_öô
(
c
);

791 
	`squash_the_°upid_£rül_numbî
(
c
);

799 
	`fûãr_˝uid_„©uªs
(
c
, 
åue
);

802 i‡(!
c
->
x86_modñ_id
[0]) {

803 c⁄° *
p
;

804 
p
 = 
	`èbÀ_lookup_modñ
(
c
);

805 i‡(
p
)

806 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

809 
	`•rötf
(
c
->
x86_modñ_id
, "%02x/%02x",

810 
c
->
x86
, c->
x86_modñ
);

813 #ifde‡
CONFIG_X86_64


814 
	`dëe˘_ht
(
c
);

817 
	`öô_hy≥rvis‹
(
c
);

823 
i
 = 0; i < 
NCAPINTS
; i++) {

824 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

825 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

834 i‡(
c
 !&
boŸ_˝u_d©a
) {

836 
i
 = 0; i < 
NCAPINTS
; i++)

837 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[
i
] &
c
->x86_capability[i];

840 #ifde‡
CONFIG_X86_MCE


842 
	`mcheck_öô
(
c
);

845 
	`£À˘_idÀ_routöe
(
c
);

847 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

848 
	`numa_add_˝u
(
	`smp_¥o˚ss‹_id
());

850 
	}
}

852 #ifde‡
CONFIG_X86_64


853 
	$vgë˝u_£t_mode
()

855 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_RDTSCP
))

856 
vgë˝u_mode
 = 
VGETCPU_RDTSCP
;

858 
vgë˝u_mode
 = 
VGETCPU_LSL
;

859 
	}
}

862 
__öô
 
	$idítify_boŸ_˝u
()

864 
	`idítify_˝u
(&
boŸ_˝u_d©a
);

865 
	`öô_c1e_mask
();

866 #ifde‡
CONFIG_X86_32


867 
	`sy£¡î_£tup
();

868 
	`íabÀ_£p_˝u
();

870 
	`vgë˝u_£t_mode
();

872 
	`öô_hw_≥rf_evíts
();

873 
	}
}

875 
__˝uöô
 
	$idítify_£c⁄d¨y_˝u
(
˝uöfo_x86
 *
c
)

877 
	`BUG_ON
(
c
 =&
boŸ_˝u_d©a
);

878 
	`idítify_˝u
(
c
);

879 #ifde‡
CONFIG_X86_32


880 
	`íabÀ_£p_˝u
();

882 
	`mår_≠_öô
();

883 
	}
}

885 
	sm§_ønge
 {

886 
	mmö
;

887 
	mmax
;

890 c⁄° 
m§_ønge
 
	gm§_ønge_¨øy
[] 
	g__˝uöôc⁄°
 = {

897 
__˝uöô
 
	$¥öt_˝u_m§
()

899 
ödex_mö
, 
ödex_max
;

900 
ödex
;

901 
u64
 
vÆ
;

902 
i
;

904 
i
 = 0; i < 
	`ARRAY_SIZE
(
m§_ønge_¨øy
); i++) {

905 
ödex_mö
 = 
m§_ønge_¨øy
[
i
].
mö
;

906 
ödex_max
 = 
m§_ønge_¨øy
[
i
].
max
;

908 
ödex
 = 
ödex_mö
; index < 
ödex_max
; index++) {

909 i‡(
	`rdm§l_amd_ß„
(
ödex
, &
vÆ
))

911 
	`¥ötk
(
KERN_INFO
 " MSR%08x: %016Œx\n", 
ödex
, 
vÆ
);

914 
	}
}

916 
show_m§
 
	g__˝uöôd©a
;

918 
__öô
 
	$£tup_show_m§
(*
¨g
)

920 
num
;

922 
	`gë_›ti⁄
(&
¨g
, &
num
);

924 i‡(
num
 > 0)

925 
show_m§
 = 
num
;

927 
	}
}

928 
__£tup
("show_m§=", 
£tup_show_m§
);

930 
__öô
 
	$£tup_no˛Êush
(*
¨g
)

932 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_CLFLSH
);

934 
	}
}

935 
__£tup
("no˛Êush", 
£tup_no˛Êush
);

937 
__˝uöô
 
	$¥öt_˝u_öfo
(
˝uöfo_x86
 *
c
)

939 c⁄° *
víd‹
 = 
NULL
;

941 i‡(
c
->
x86_víd‹
 < 
X86_VENDOR_NUM
) {

942 
víd‹
 = 
this_˝u
->
c_víd‹
;

944 i‡(
c
->
˝uid_Àvñ
 >= 0)

945 
víd‹
 = 
c
->
x86_víd‹_id
;

948 i‡(
víd‹
 && !
	`°r°r
(
c
->
x86_modñ_id
, vendor))

949 
	`¥ötk
(
KERN_CONT
 "%†", 
víd‹
);

951 i‡(
c
->
x86_modñ_id
[0])

952 
	`¥ötk
(
KERN_CONT
 "%s", 
c
->
x86_modñ_id
);

954 
	`¥ötk
(
KERN_CONT
 "%d86", 
c
->
x86
);

956 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

957 
	`¥ötk
(
KERN_CONT
 " sãµög %02x\n", 
c
->
x86_mask
);

959 
	`¥ötk
(
KERN_CONT
 "\n");

961 #ifde‡
CONFIG_SMP


962 i‡(
c
->
˝u_ödex
 < 
show_m§
)

963 
	`¥öt_˝u_m§
();

965 i‡(
show_m§
)

966 
	`¥öt_˝u_m§
();

968 
	}
}

970 
__öô
 
	$£tup_dißbÀ˝uid
(*
¨g
)

972 
bô
;

974 i‡(
	`gë_›ti⁄
(&
¨g
, &
bô
Ë&& bô < 
NCAPINTS
*32)

975 
	`£tup_˛ór_˝u_ˇp
(
bô
);

980 
	}
}

981 
__£tup
("˛ór˝uid=", 
£tup_dißbÀ˝uid
);

983 #ifde‡
CONFIG_X86_64


984 
desc_±r
 
	gidt_des¸
 = { 
NR_VECTORS
 * 16 - 1, (Ë
idt_èbÀ
 };

986 
	$DEFINE_PER_CPU_FIRST
(
úq_°ack_uni⁄
,

987 
úq_°ack_uni⁄
Ë
	`__Æig√d
(
PAGE_SIZE
);

993 
	$DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë
____ˇchñöe_Æig√d
 =

994 &
öô_èsk
;

995 
	`EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

997 
	`DEFINE_PER_CPU
(, 
kî√l_°ack
) =

998 ()&
öô_thªad_uni⁄
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

999 
	`EXPORT_PER_CPU_SYMBOL
(
kî√l_°ack
);

1001 
	`DEFINE_PER_CPU
(*, 
úq_°ack_±r
) =

1002 
	`öô_≥r_˝u_v¨
(
úq_°ack_uni⁄
.
úq_°ack
Ë+ 
IRQ_STACK_SIZE
 - 64;

1004 
	`DEFINE_PER_CPU
(, 
úq_cou¡
) = -1;

1012 c⁄° 
ex˚±i⁄_°ack_sizes
[
N_EXCEPTION_STACKS
] = {

1013 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

1014 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


1015 
	}
};

1017 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
ex˚±i⁄_°acks


1018 [(
N_EXCEPTION_STACKS
 - 1Ë* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
]);

1021 
	$sysˇŒ_öô
()

1028 
	`wrm§l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1029 
	`wrm§l
(
MSR_LSTAR
, 
sy°em_ˇŒ
);

1030 
	`wrm§l
(
MSR_CSTAR
, 
ign‹e_sy§ë
);

1032 #ifde‡
CONFIG_IA32_EMULATION


1033 
	`sysˇŒ32_˝u_öô
();

1037 
	`wrm§l
(
MSR_SYSCALL_MASK
,

1038 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1039 
	}
}

1041 
	gkî√l_eÊags
;

1047 
DEFINE_PER_CPU
(
‹ig_i°
, orig_ist);

1051 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë&
öô_èsk
;

1052 
EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

1054 #ifde‡
CONFIG_CC_STACKPROTECTOR


1055 
DEFINE_PER_CPU_ALIGNED
(
°ack_ˇ«ry
, stack_canary);

1059 
±_ªgs
 * 
__˝uöô
 
	$idÀ_ªgs
(
±_ªgs
 *
ªgs
)

1061 
	`mem£t
(
ªgs
, 0, (
±_ªgs
));

1062 
ªgs
->
fs
 = 
__KERNEL_PERCPU
;

1063 
ªgs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1065  
ªgs
;

1066 
	}
}

1072 
	$˛ór_Æl_debug_ªgs
()

1074 
i
;

1076 
i
 = 0; i < 8; i++) {

1078 i‡((
i
 == 4) || (i == 5))

1081 
	`£t_debugªg
(0, 
i
);

1083 
	}
}

1092 #ifde‡
CONFIG_X86_64


1094 
__˝uöô
 
	$˝u_öô
()

1096 
‹ig_i°
 *orig_ist;

1097 
èsk_°ru˘
 *
me
;

1098 
tss_°ru˘
 *
t
;

1099 
v
;

1100 
˝u
;

1101 
i
;

1103 
˝u
 = 
	`°ack_smp_¥o˚ss‹_id
();

1104 
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1105 
‹ig_i°
 = &
	`≥r_˝u
(‹ig_i°, 
˝u
);

1107 #ifde‡
CONFIG_NUMA


1108 i‡(
˝u
 !0 && 
	`≥r˝u_ªad
(
node_numbî
) == 0 &&

1109 
	`˝u_to_node
(
˝u
Ë!
NUMA_NO_NODE
)

1110 
	`≥r˝u_wrôe
(
node_numbî
, 
	`˝u_to_node
(
˝u
));

1113 
me
 = 
cuºít
;

1115 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
))

1116 
	`∑nic
("CPU#%dáÃódy inôülized!\n", 
˝u
);

1118 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1120 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1127 
	`swôch_to_√w_gdt
(
˝u
);

1128 
	`lﬂd£gmít
(
fs
, 0);

1130 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

1132 
	`mem£t
(
me
->
thªad
.
és_¨øy
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1133 
	`sysˇŒ_öô
();

1135 
	`wrm§l
(
MSR_FS_BASE
, 0);

1136 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 0);

1137 
	`b¨rõr
();

1139 
	`check_e„r
();

1140 i‡(
˝u
 != 0)

1141 
	`íabÀ_x2≠ic
();

1146 i‡(!
‹ig_i°
->
i°
[0]) {

1147 *
e°acks
 = 
	`≥r_˝u
(
ex˚±i⁄_°acks
, 
˝u
);

1149 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1150 
e°acks
 +
ex˚±i⁄_°ack_sizes
[
v
];

1151 
‹ig_i°
->
i°
[
v
] = 
t
->
x86_tss
.ist[v] =

1152 ()
e°acks
;

1156 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1162 
i
 = 0; i <
IO_BITMAP_LONGS
; i++)

1163 
t
->
io_bôm≠
[
i
] = ~0UL;

1165 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1166 
me
->
a˘ive_mm
 = &
öô_mm
;

1167 
	`BUG_ON
(
me
->
mm
);

1168 
	`íãr_œzy_éb
(&
öô_mm
, 
me
);

1170 
	`lﬂd_•0
(
t
, &
cuºít
->
thªad
);

1171 
	`£t_tss_desc
(
˝u
, 
t
);

1172 
	`lﬂd_TR_desc
();

1173 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1175 #ifde‡
CONFIG_KGDB


1182 i‡(
kgdb_c⁄√˘ed
 && 
¨ch_kgdb_›s
.
c‹ª˘_hw_bªak
)

1183 
¨ch_kgdb_›s
.
	`c‹ª˘_hw_bªak
();

1186 
	`˛ór_Æl_debug_ªgs
();

1188 
	`Âu_öô
();

1190 
	`øw_loˇl_ßve_Êags
(
kî√l_eÊags
);

1192 i‡(
	`is_uv_sy°em
())

1193 
	`uv_˝u_öô
();

1194 
	}
}

1198 
__˝uöô
 
	$˝u_öô
()

1200 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1201 
èsk_°ru˘
 *
cuº
 = 
cuºít
;

1202 
tss_°ru˘
 *
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1203 
thªad_°ru˘
 *
thªad
 = &
cuº
->thread;

1205 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
)) {

1206 
	`¥ötk
(
KERN_WARNING
 "CPU#%dáÃódy inôülized!\n", 
˝u
);

1208 
	`loˇl_úq_íabÀ
();

1211 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1213 i‡(
˝u_has_vme
 || 
˝u_has_tsc
 || 
˝u_has_de
)

1214 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1216 
	`lﬂd_idt
(&
idt_des¸
);

1217 
	`swôch_to_√w_gdt
(
˝u
);

1222 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1223 
cuº
->
a˘ive_mm
 = &
öô_mm
;

1224 
	`BUG_ON
(
cuº
->
mm
);

1225 
	`íãr_œzy_éb
(&
öô_mm
, 
cuº
);

1227 
	`lﬂd_•0
(
t
, 
thªad
);

1228 
	`£t_tss_desc
(
˝u
, 
t
);

1229 
	`lﬂd_TR_desc
();

1230 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1232 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1234 #ifde‡
CONFIG_DOUBLEFAULT


1236 
	`__£t_tss_desc
(
˝u
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubÀÁu…_tss
);

1239 
	`˛ór_Æl_debug_ªgs
();

1244 i‡(
˝u_has_xßve
)

1245 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

1247 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

1248 
	`˛ór_u£d_m©h
();

1249 
	`mxc§_„©uª_mask_öô
();

1254 i‡(
	`smp_¥o˚ss‹_id
(Ë=
boŸ_˝u_id
)

1255 
	`öô_thªad_x°©e
();

1257 
	`xßve_öô
();

1258 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<löux/kî√l.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/˝u‰eq.h
>

34 
	~<löux/compûî.h
>

35 
	~<löux/dmi.h
>

36 
	~<åa˚/evíts/powî.h
>

38 
	~<löux/a˝i.h
>

39 
	~<löux/io.h
>

40 
	~<löux/dñay.h
>

41 
	~<löux/uac˚ss.h
>

43 
	~<a˝i/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/¥o˚ss‹.h
>

47 
	~<asm/˝u„©uª.h
>

49 
	#d¥ötk
(
msg
...Ë
	`˝u‰eq_debug_¥ötk
(
CPUFREQ_DEBUG_DRIVER
, \

50 "a˝i-˝u‰eq", 
msg
)

	)

52 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

53 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

54 
MODULE_LICENSE
("GPL");

57 
	mUNDEFINED_CAPABLE
 = 0,

58 
	mSYSTEM_INTEL_MSR_CAPABLE
,

59 
	mSYSTEM_IO_CAPABLE
,

62 
	#INTEL_MSR_RANGE
 (0xffff)

	)

64 
	sa˝i_˝u‰eq_d©a
 {

65 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ma˝i_d©a
;

66 
˝u‰eq_‰equícy_èbÀ
 *
	m‰eq_èbÀ
;

67 
	mªsume
;

68 
	m˝u_„©uª
;

71 
DEFINE_PER_CPU
(
a˝i_˝u‰eq_d©a
 *, 
drv_d©a
);

73 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ﬁd_≥rf
);

76 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ga˝i_≥rf_d©a
;

78 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
;

80 
	ga˝i_p°©e_°ri˘
;

82 
	$check_e°_˝u
(
˝uid
)

84 
˝uöfo_x86
 *
˝u
 = &
	`˝u_d©a
(
˝uid
);

86  
	`˝u_has
(
˝u
, 
X86_FEATURE_EST
);

87 
	}
}

89 
	$exåa˘_io
(
u32
 
vÆue
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

91 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

92 
i
;

94 
≥rf
 = 
d©a
->
a˝i_d©a
;

96 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

97 i‡(
vÆue
 =
≥rf
->
°©es
[
i
].
°©us
)

98  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

101 
	}
}

103 
	$exåa˘_m§
(
u32
 
m§
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

105 
i
;

106 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

108 
m§
 &
INTEL_MSR_RANGE
;

109 
≥rf
 = 
d©a
->
a˝i_d©a
;

111 
i
 = 0; 
d©a
->
‰eq_èbÀ
[i].
‰equícy
 !
CPUFREQ_TABLE_END
; i++) {

112 i‡(
m§
 =
≥rf
->
°©es
[
d©a
->
‰eq_èbÀ
[
i
].
ödex
].
°©us
)

113  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

115  
d©a
->
‰eq_èbÀ
[0].
‰equícy
;

116 
	}
}

118 
	$exåa˘_‰eq
(
u32
 
vÆ
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

120 
d©a
->
˝u_„©uª
) {

121 
SYSTEM_INTEL_MSR_CAPABLE
:

122  
	`exåa˘_m§
(
vÆ
, 
d©a
);

123 
SYSTEM_IO_CAPABLE
:

124  
	`exåa˘_io
(
vÆ
, 
d©a
);

128 
	}
}

130 
	sm§_addr
 {

131 
u32
 
	mªg
;

134 
	sio_addr
 {

135 
u16
 
	mp‹t
;

136 
u8
 
	mbô_width
;

139 
	sdrv_cmd
 {

140 
	mty≥
;

141 c⁄° 
˝umask
 *
	mmask
;

143 
m§_addr
 
	mm§
;

144 
io_addr
 
	mio
;

145 } 
	maddr
;

146 
u32
 
	mvÆ
;

150 
	$do_drv_ªad
(*
_cmd
)

152 
drv_cmd
 *
cmd
 = 
_cmd
;

153 
u32
 
h
;

155 
cmd
->
ty≥
) {

156 
SYSTEM_INTEL_MSR_CAPABLE
:

157 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, cmd->
vÆ
, 
h
);

159 
SYSTEM_IO_CAPABLE
:

160 
	`a˝i_os_ªad_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

161 &
cmd
->
vÆ
,

162 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

167 
	}
}

170 
	$do_drv_wrôe
(*
_cmd
)

172 
drv_cmd
 *
cmd
 = 
_cmd
;

173 
u32
 
lo
, 
hi
;

175 
cmd
->
ty≥
) {

176 
SYSTEM_INTEL_MSR_CAPABLE
:

177 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

178 
lo
 = (lÿ& ~
INTEL_MSR_RANGE
Ë| (
cmd
->
vÆ
 & INTEL_MSR_RANGE);

179 
	`wrm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

181 
SYSTEM_IO_CAPABLE
:

182 
	`a˝i_os_wrôe_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

183 
cmd
->
vÆ
,

184 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

189 
	}
}

191 
	$drv_ªad
(
drv_cmd
 *
cmd
)

193 
cmd
->
vÆ
 = 0;

195 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
	`˝umask_™y
(
cmd
->
mask
), 
do_drv_ªad
, cmd, 1);

196 
	}
}

198 
	$drv_wrôe
(
drv_cmd
 *
cmd
)

200 
this_˝u
;

202 
this_˝u
 = 
	`gë_˝u
();

203 i‡(
	`˝umask_ã°_˝u
(
this_˝u
, 
cmd
->
mask
))

204 
	`do_drv_wrôe
(
cmd
);

205 
	`smp_ˇŒ_fun˘i⁄_m™y
(
cmd
->
mask
, 
do_drv_wrôe
, cmd, 1);

206 
	`put_˝u
();

207 
	}
}

209 
u32
 
	$gë_cur_vÆ
(c⁄° 
˝umask
 *
mask
)

211 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

212 
drv_cmd
 
cmd
;

214 i‡(
	`u∆ikñy
(
	`˝umask_em±y
(
mask
)))

217 
	`≥r_˝u
(
drv_d©a
, 
	`˝umask_fú°
(
mask
))->
˝u_„©uª
) {

218 
SYSTEM_INTEL_MSR_CAPABLE
:

219 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

220 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_STATUS
;

222 
SYSTEM_IO_CAPABLE
:

223 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

224 
≥rf
 = 
	`≥r_˝u
(
drv_d©a
, 
	`˝umask_fú°
(
mask
))->
a˝i_d©a
;

225 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

226 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

232 
cmd
.
mask
 = mask;

233 
	`drv_ªad
(&
cmd
);

235 
	`d¥ötk
("gë_cur_vÆ = %u\n", 
cmd
.
vÆ
);

237  
cmd
.
vÆ
;

238 
	}
}

241 
	$ªad_mósuªd_≥rf_˘rs
(*
_cur
)

243 
≠îfm≥rf
 *
am
 = 
_cur
;

245 
	`gë_≠îfm≥rf
(
am
);

246 
	}
}

261 
	$gë_mósuªd_≥rf
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

262 
˝u
)

264 
≠îfm≥rf
 
≥rf
;

265 
øtio
;

266 
ªtvÆ
;

268 i‡(
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
ªad_mósuªd_≥rf_˘rs
, &
≥rf
, 1))

271 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(&
	`≥r_˝u
(
ﬁd_≥rf
, 
˝u
), &
≥rf
);

272 
	`≥r_˝u
(
ﬁd_≥rf
, 
˝u
Ë
≥rf
;

274 
ªtvÆ
 = (
pﬁicy
->
˝uöfo
.
max_‰eq
 * 
øtio
Ë>> 
APERFMPERF_SHIFT
;

276  
ªtvÆ
;

277 
	}
}

279 
	$gë_cur_‰eq_⁄_˝u
(
˝u
)

281 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
˝u
);

282 
‰eq
;

283 
ˇched_‰eq
;

285 
	`d¥ötk
("gë_cur_‰eq_⁄_˝u (%d)\n", 
˝u
);

287 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

288 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

292 
ˇched_‰eq
 = 
d©a
->
‰eq_èbÀ
[d©a->
a˝i_d©a
->
°©e
].
‰equícy
;

293 
‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
	`˝umask_of
(
˝u
)), 
d©a
);

294 i‡(
‰eq
 !
ˇched_‰eq
) {

299 
d©a
->
ªsume
 = 1;

302 
	`d¥ötk
("cu∏‰eq = %u\n", 
‰eq
);

304  
‰eq
;

305 
	}
}

307 
	$check_‰eqs
(c⁄° 
˝umask
 *
mask
, 
‰eq
,

308 
a˝i_˝u‰eq_d©a
 *
d©a
)

310 
cur_‰eq
;

311 
i
;

313 
i
 = 0; i < 100; i++) {

314 
cur_‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
mask
), 
d©a
);

315 i‡(
cur_‰eq
 =
‰eq
)

317 
	`udñay
(10);

320 
	}
}

322 
	$a˝i_˝u‰eq_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

323 
èrgë_‰eq
, 
ªœti⁄
)

325 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

326 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

327 
˝u‰eq_‰eqs
 
‰eqs
;

328 
drv_cmd
 
cmd
;

329 
√xt_°©e
 = 0;

330 
√xt_≥rf_°©e
 = 0;

331 
i
;

332 
ªsu…
 = 0;

334 
	`d¥ötk
("a˝i_˝u‰eq_èrgë %d (%d)\n", 
èrgë_‰eq
, 
pﬁicy
->
˝u
);

336 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

337 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

338  -
ENODEV
;

341 
≥rf
 = 
d©a
->
a˝i_d©a
;

342 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_èrgë
(
pﬁicy
,

343 
d©a
->
‰eq_èbÀ
,

344 
èrgë_‰eq
,

345 
ªœti⁄
, &
√xt_°©e
);

346 i‡(
	`u∆ikñy
(
ªsu…
)) {

347 
ªsu…
 = -
ENODEV
;

348 
out
;

351 
√xt_≥rf_°©e
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
ödex
;

352 i‡(
≥rf
->
°©e
 =
√xt_≥rf_°©e
) {

353 i‡(
	`u∆ikñy
(
d©a
->
ªsume
)) {

354 
	`d¥ötk
("CalledáfterÑesume,ÑesettingÅo P%d\n",

355 
√xt_≥rf_°©e
);

356 
d©a
->
ªsume
 = 0;

358 
	`d¥ötk
("AlreadyátÅarget state (P%d)\n",

359 
√xt_≥rf_°©e
);

360 
out
;

364 
	`åa˚_powî_‰equícy
(
POWER_PSTATE
, 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
);

366 
d©a
->
˝u_„©uª
) {

367 
SYSTEM_INTEL_MSR_CAPABLE
:

368 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

369 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_CTL
;

370 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

372 
SYSTEM_IO_CAPABLE
:

373 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

374 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

375 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

376 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

379 
ªsu…
 = -
ENODEV
;

380 
out
;

384 i‡(
pﬁicy
->
sh¨ed_ty≥
 !
CPUFREQ_SHARED_TYPE_ANY
)

385 
cmd
.
mask
 = 
pﬁicy
->
˝us
;

387 
cmd
.
mask
 = 
	`˝umask_of
(
pﬁicy
->
˝u
);

389 
‰eqs
.
ﬁd
 = 
≥rf
->
°©es
[≥rf->
°©e
].
c‹e_‰equícy
 * 1000;

390 
‰eqs
.
√w
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
;

391 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

392 
‰eqs
.
˝u
 = 
i
;

393 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

396 
	`drv_wrôe
(&
cmd
);

398 i‡(
a˝i_p°©e_°ri˘
) {

399 i‡(!
	`check_‰eqs
(
cmd
.
mask
, 
‰eqs
.
√w
, 
d©a
)) {

400 
	`d¥ötk
("acpi_cpufreq_target failed (%d)\n",

401 
pﬁicy
->
˝u
);

402 
ªsu…
 = -
EAGAIN
;

403 
out
;

407 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

408 
‰eqs
.
˝u
 = 
i
;

409 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

411 
≥rf
->
°©e
 = 
√xt_≥rf_°©e
;

413 
out
:

414  
ªsu…
;

415 
	}
}

417 
	$a˝i_˝u‰eq_vîify
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

419 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

421 
	`d¥ötk
("acpi_cpufreq_verify\n");

423  
	`˝u‰eq_‰equícy_èbÀ_vîify
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

424 
	}
}

427 
	$a˝i_˝u‰eq_guess_‰eq
(
a˝i_˝u‰eq_d©a
 *
d©a
, 
˝u
)

429 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
 = 
d©a
->
a˝i_d©a
;

431 i‡(
˝u_khz
) {

433 
i
;

434 
‰eq
;

435 
‰eqn
 = 
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

437 
i
 = 0; i < (
≥rf
->
°©e_cou¡
-1); i++) {

438 
‰eq
 = 
‰eqn
;

439 
‰eqn
 = 
≥rf
->
°©es
[
i
+1].
c‹e_‰equícy
 * 1000;

440 i‡((2 * 
˝u_khz
Ë> (
‰eqn
 + 
‰eq
)) {

441 
≥rf
->
°©e
 = 
i
;

442  
‰eq
;

445 
≥rf
->
°©e
 =Öîf->
°©e_cou¡
-1;

446  
‰eqn
;

449 
≥rf
->
°©e
 = 0;

450  
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

452 
	}
}

454 
	$‰ì_a˝i_≥rf_d©a
()

456 
i
;

459 
	`f‹_óch_possibÀ_˝u
(
i
)

460 
	`‰ì_˝umask_v¨
(
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)

461 ->
sh¨ed_˝u_m≠
);

462 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

463 
	}
}

473 
__öô
 
	$a˝i_˝u‰eq_óæy_öô
()

475 
i
;

476 
	`d¥ötk
("acpi_cpufreq_early_init\n");

478 
a˝i_≥rf_d©a
 = 
	`Æloc_≥r˝u
(
a˝i_¥o˚ss‹_≥rf‹m™˚
);

479 i‡(!
a˝i_≥rf_d©a
) {

480 
	`d¥ötk
("MemoryállocationÉrror forácpi_perf_data.\n");

481  -
ENOMEM
;

483 
	`f‹_óch_possibÀ_˝u
(
i
) {

484 i‡(!
	`zÆloc_˝umask_v¨_node
(

485 &
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)->
sh¨ed_˝u_m≠
,

486 
GFP_KERNEL
, 
	`˝u_to_node
(
i
))) {

489 
	`‰ì_a˝i_≥rf_d©a
();

490  -
ENOMEM
;

495 
	`a˝i_¥o˚ss‹_¥îegi°î_≥rf‹m™˚
(
a˝i_≥rf_d©a
);

497 
	}
}

499 #ifde‡
CONFIG_SMP


506 
	gbios_wôh_sw_™y_bug
;

508 
	$sw_™y_bug_found
(c⁄° 
dmi_sy°em_id
 *
d
)

510 
bios_wôh_sw_™y_bug
 = 1;

512 
	}
}

514 c⁄° 
dmi_sy°em_id
 
	gsw_™y_bug_dmi_èbÀ
[] = {

516 .
ˇŒback
 = 
sw_™y_bug_found
,

517 .
	gidít
 = "Supermicro Server X6DLP",

518 .
	gm©ches
 = {

519 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

520 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

521 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

527 
	$a˝i_˝u‰eq_bœckli°
(
˝uöfo_x86
 *
c
)

534 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

535 i‡((
c
->
x86
 == 15) &&

536 (
c
->
x86_modñ
 == 6) &&

537 (
c
->
x86_mask
 == 8)) {

538 
	`¥ötk
(
KERN_INFO
 "acpi-cpufreq: Intel(R) "

542  -
ENODEV
;

546 
	}
}

549 
	$a˝i_˝u‰eq_˝u_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

551 
i
;

552 
vÆid_°©es
 = 0;

553 
˝u
 = 
pﬁicy
->cpu;

554 
a˝i_˝u‰eq_d©a
 *
d©a
;

555 
ªsu…
 = 0;

556 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
pﬁicy
->
˝u
);

557 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

558 #ifde‡
CONFIG_SMP


559 
bœckli°ed
;

562 
	`d¥ötk
("acpi_cpufreq_cpu_init\n");

564 #ifde‡
CONFIG_SMP


565 i‡(
bœckli°ed
)

566  
bœckli°ed
;

567 
bœckli°ed
 = 
	`a˝i_˝u‰eq_bœckli°
(
c
);

568 i‡(
bœckli°ed
)

569  
bœckli°ed
;

572 
d©a
 = 
	`kzÆloc
((
a˝i_˝u‰eq_d©a
), 
GFP_KERNEL
);

573 i‡(!
d©a
)

574  -
ENOMEM
;

576 
d©a
->
a˝i_d©a
 = 
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
˝u
);

577 
	`≥r_˝u
(
drv_d©a
, 
˝u
Ë
d©a
;

579 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

580 
a˝i_˝u‰eq_drivî
.
Êags
 |
CPUFREQ_CONST_LOOPS
;

582 
ªsu…
 = 
	`a˝i_¥o˚ss‹_ªgi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
, 
˝u
);

583 i‡(
ªsu…
)

584 
îr_‰ì
;

586 
≥rf
 = 
d©a
->
a˝i_d©a
;

587 
pﬁicy
->
sh¨ed_ty≥
 = 
≥rf
->shared_type;

593 i‡(
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ALL
 ||

594 
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ANY
) {

595 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

597 
	`˝umask_c›y
(
pﬁicy
->
ªœãd_˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

599 #ifde‡
CONFIG_SMP


600 
	`dmi_check_sy°em
(
sw_™y_bug_dmi_èbÀ
);

601 i‡(
bios_wôh_sw_™y_bug
 && 
	`˝umask_weight
(
pﬁicy
->
˝us
) == 1) {

602 
pﬁicy
->
sh¨ed_ty≥
 = 
CPUFREQ_SHARED_TYPE_ALL
;

603 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

608 i‡(
≥rf
->
°©e_cou¡
 <= 1) {

609 
	`d¥ötk
("No P-States\n");

610 
ªsu…
 = -
ENODEV
;

611 
îr_uƒeg
;

614 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 !≥rf->
°©us_ªgi°î
.space_id) {

615 
ªsu…
 = -
ENODEV
;

616 
îr_uƒeg
;

619 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

620 
ACPI_ADR_SPACE_SYSTEM_IO
:

621 
	`d¥ötk
("SYSTEM IOáddr space\n");

622 
d©a
->
˝u_„©uª
 = 
SYSTEM_IO_CAPABLE
;

624 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

625 
	`d¥ötk
("HARDWAREáddr space\n");

626 i‡(!
	`check_e°_˝u
(
˝u
)) {

627 
ªsu…
 = -
ENODEV
;

628 
îr_uƒeg
;

630 
d©a
->
˝u_„©uª
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

633 
	`d¥ötk
("Unknownáddr space %d\n",

634 (
u32
Ë(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
));

635 
ªsu…
 = -
ENODEV
;

636 
îr_uƒeg
;

639 
d©a
->
‰eq_èbÀ
 = 
	`kmÆloc
((
˝u‰eq_‰equícy_èbÀ
) *

640 (
≥rf
->
°©e_cou¡
+1), 
GFP_KERNEL
);

641 i‡(!
d©a
->
‰eq_èbÀ
) {

642 
ªsu…
 = -
ENOMEM
;

643 
îr_uƒeg
;

647 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 0;

648 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

649 i‡((
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000) >

650 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
)

651 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 =

652 
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000;

656 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 =
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

657 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 > 20 * 1000) {

658 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 20 * 1000;

659 
	`¥ötk_⁄˚
(
KERN_INFO


664 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

665 i‡(
i
 > 0 && 
≥rf
->
°©es
[i].
c‹e_‰equícy
 >=

666 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
-1].
‰equícy
 / 1000)

669 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
ödex
 = 
i
;

670 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 =

671 
≥rf
->
°©es
[
i
].
c‹e_‰equícy
 * 1000;

672 
vÆid_°©es
++;

674 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 = 
CPUFREQ_TABLE_END
;

675 
≥rf
->
°©e
 = 0;

677 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_˝uöfo
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

678 i‡(
ªsu…
)

679 
îr_‰eq‰ì
;

681 i‡(
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000 !
pﬁicy
->
˝uöfo
.
max_‰eq
)

682 
	`¥ötk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 isÇot max freq\n");

684 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

685 
ACPI_ADR_SPACE_SYSTEM_IO
:

687 
pﬁicy
->
cur
 = 
	`a˝i_˝u‰eq_guess_‰eq
(
d©a
,Öﬁicy->
˝u
);

689 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

690 
a˝i_˝u‰eq_drivî
.
gë
 = 
gë_cur_‰eq_⁄_˝u
;

691 
pﬁicy
->
cur
 = 
	`gë_cur_‰eq_⁄_˝u
(
˝u
);

698 
	`a˝i_¥o˚ss‹_nŸify_smm
(
THIS_MODULE
);

701 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_APERFMPERF
))

702 
a˝i_˝u‰eq_drivî
.
gëavg
 = 
gë_mósuªd_≥rf
;

704 
	`d¥ötk
("CPU%u - ACPIÖîf‹m™˚ m™agemíàa˘iv©ed.\n", 
˝u
);

705 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++)

706 
	`d¥ötk
(" %cP%d: %d MHz, %d mW, %d uS\n",

707 (
i
 =
≥rf
->
°©e
 ? '*' : ' '), i,

708 (
u32
Ë
≥rf
->
°©es
[
i
].
c‹e_‰equícy
,

709 (
u32
Ë
≥rf
->
°©es
[
i
].
powî
,

710 (
u32
Ë
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
);

712 
	`˝u‰eq_‰equícy_èbÀ_gë_©å
(
d©a
->
‰eq_èbÀ
, 
pﬁicy
->
˝u
);

718 
d©a
->
ªsume
 = 1;

720  
ªsu…
;

722 
îr_‰eq‰ì
:

723 
	`k‰ì
(
d©a
->
‰eq_èbÀ
);

724 
îr_uƒeg
:

725 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
≥rf
, 
˝u
);

726 
îr_‰ì
:

727 
	`k‰ì
(
d©a
);

728 
	`≥r_˝u
(
drv_d©a
, 
˝u
Ë
NULL
;

730  
ªsu…
;

731 
	}
}

733 
	$a˝i_˝u‰eq_˝u_exô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

735 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

737 
	`d¥ötk
("acpi_cpufreq_cpu_exit\n");

739 i‡(
d©a
) {

740 
	`˝u‰eq_‰equícy_èbÀ_put_©å
(
pﬁicy
->
˝u
);

741 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
Ë
NULL
;

742 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
,

743 
pﬁicy
->
˝u
);

744 
	`k‰ì
(
d©a
);

748 
	}
}

750 
	$a˝i_˝u‰eq_ªsume
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

752 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
drv_d©a
, 
pﬁicy
->
˝u
);

754 
	`d¥ötk
("acpi_cpufreq_resume\n");

756 
d©a
->
ªsume
 = 1;

759 
	}
}

761 
‰eq_©å
 *
	ga˝i_˝u‰eq_©å
[] = {

762 &
˝u‰eq_‰eq_©å_sˇlög_avaûabÀ_‰eqs
,

763 
NULL
,

766 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
 = {

767 .
vîify
 = 
a˝i_˝u‰eq_vîify
,

768 .
	gèrgë
 = 
a˝i_˝u‰eq_èrgë
,

769 .
	göô
 = 
a˝i_˝u‰eq_˝u_öô
,

770 .
	gexô
 = 
a˝i_˝u‰eq_˝u_exô
,

771 .
	gªsume
 = 
a˝i_˝u‰eq_ªsume
,

772 .
	g«me
 = "acpi-cpufreq",

773 .
	gow√r
 = 
THIS_MODULE
,

774 .
	g©å
 = 
a˝i_˝u‰eq_©å
,

777 
__öô
 
	$a˝i_˝u‰eq_öô
()

779 
ªt
;

781 i‡(
a˝i_dißbÀd
)

784 
	`d¥ötk
("acpi_cpufreq_init\n");

786 
ªt
 = 
	`a˝i_˝u‰eq_óæy_öô
();

787 i‡(
ªt
)

788  
ªt
;

790 
ªt
 = 
	`˝u‰eq_ªgi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

791 i‡(
ªt
)

792 
	`‰ì_a˝i_≥rf_d©a
();

794  
ªt
;

795 
	}
}

797 
__exô
 
	$a˝i_˝u‰eq_exô
()

799 
	`d¥ötk
("acpi_cpufreq_exit\n");

801 
	`˝u‰eq_uƒegi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

803 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

804 
	}
}

806 
moduÀ_∑øm
(
a˝i_p°©e_°ri˘
, 
uöt
, 0644);

807 
MODULE_PARM_DESC
(
a˝i_p°©e_°ri˘
,

811 
œã_öôˇŒ
(
a˝i_˝u‰eq_öô
);

812 
moduÀ_exô
(
a˝i_˝u‰eq_exô
);

814 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/vmw¨e.h
>

26 
	~<asm/hy≥rvis‹.h
>

28 
ölöe
 
__˝uöô


29 
	$dëe˘_hy≥rvis‹_víd‹
(
˝uöfo_x86
 *
c
)

31 i‡(
	`vmw¨e_∂©f‹m
())

32 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_VMWARE
;

34 
c
->
x86_hy≥r_víd‹
 = 
X86_HYPER_VENDOR_NONE
;

35 
	}
}

37 
ölöe
 
__˝uöô


38 
	$hy≥rvis‹_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

40 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
) {

41 
	`vmw¨e_£t_„©uª_bôs
(
c
);

44 
	}
}

46 
__˝uöô
 
	$öô_hy≥rvis‹
(
˝uöfo_x86
 *
c
)

48 
	`dëe˘_hy≥rvis‹_víd‹
(
c
);

49 
	`hy≥rvis‹_£t_„©uª_bôs
(
c
);

50 
	}
}

52 
__öô
 
	$öô_hy≥rvis‹_∂©f‹m
()

54 
	`öô_hy≥rvis‹
(&
boŸ_˝u_d©a
);

55 i‡(
boŸ_˝u_d©a
.
x86_hy≥r_víd‹
 =
X86_HYPER_VENDOR_VMWARE
)

56 
	`vmw¨e_∂©f‹m_£tup
();

57 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<löux/öô.h
>

2 
	~<löux/kî√l.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/bô›s.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/thªad_öfo.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/uac˚ss.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/pgèbÀ.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/ds.h
>

16 
	~<asm/bugs.h
>

17 
	~<asm/˝u.h
>

19 #ifde‡
CONFIG_X86_64


20 
	~<löux/t›ﬁogy.h
>

21 
	~<asm/numa_64.h
>

24 
	~"˝u.h
"

26 #ifde‡
CONFIG_X86_LOCAL_APIC


27 
	~<asm/mp•ec.h
>

28 
	~<asm/≠ic.h
>

31 
__˝uöô
 
	$óæy_öô_öãl
(
˝uöfo_x86
 *
c
)

34 i‡(
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xd)) {

35 
u64
 
misc_íabÀ
;

37 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

39 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

40 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

41 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

42 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

46 i‡((
c
->
x86
 =0x‡&& c->
x86_modñ
 >= 0x03) ||

47 (
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0x0e))

48 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

50 #ifde‡
CONFIG_X86_64


51 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

54 i‡(
c
->
x86
 =15 && c->
x86_ˇche_Æignmít
 == 64)

55 
c
->
x86_ˇche_Æignmít
 = 128;

59 i‡(
c
->
x86
 =0xF && c->
x86_modñ
 == 0x3

60 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

61 
c
->
x86_phys_bôs
 = 36;

70 i‡(
c
->
x86_powî
 & (1 << 8)) {

71 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

72 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

73 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

74 
sched_˛ock_°abÀ
 = 1;

87 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 15)

88 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PAT
);

90 #ifde‡
CONFIG_KMEMCHECK


99 i‡(
c
->
x86
 == 15) {

100 
u64
 
misc_íabÀ
;

102 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

104 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_FAST_STRING
) {

105 
	`¥ötk
(
KERN_INFO
 "kmemcheck: Disabling fast string operations\n");

107 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_FAST_STRING
;

108 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

112 
	}
}

114 #ifde‡
CONFIG_X86_32


121 
__˝uöô
 
	$µro_wôh_øm_bug
()

124 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

125 
boŸ_˝u_d©a
.
x86
 == 6 &&

126 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

127 
boŸ_˝u_d©a
.
x86_mask
 < 8) {

128 
	`¥ötk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. TakingÉvasiveáction.\n");

132 
	}
}

134 #ifde‡
CONFIG_X86_F00F_BUG


135 
__˝uöô
 
	$å≠_öô_f00f_bug
()

137 
	`__£t_fixm≠
(
FIX_F00F_IDT
, 
	`__∑
(&
idt_èbÀ
), 
PAGE_KERNEL_RO
);

143 
idt_des¸
.
addªss
 = 
	`fix_to_vút
(
FIX_F00F_IDT
);

144 
	`lﬂd_idt
(&
idt_des¸
);

145 
	}
}

148 
__˝uöô
 
	$öãl_smp_check
(
˝uöfo_x86
 *
c
)

150 #ifde‡
CONFIG_SMP


152 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

158 i‡(
c
->
x86
 == 5 &&

159 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

160 
c
->
x86_modñ
 <= 3) {

164 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

168 
	}
}

170 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

172 
lo
, 
hi
;

174 #ifde‡
CONFIG_X86_F00F_BUG


181 
c
->
f00f_bug
 = 0;

182 i‡(!
	`∑øvút_íabÀd
(Ë&& 
c
->
x86
 == 5) {

183 
f00f_w‹k¨ound_íabÀd
;

185 
c
->
f00f_bug
 = 1;

186 i‡(!
f00f_w‹k¨ound_íabÀd
) {

187 
	`å≠_öô_f00f_bug
();

188 
	`¥ötk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundÉnabled.\n");

189 
f00f_w‹k¨ound_íabÀd
 = 1;

198 i‡((
c
->
x86
<<8 | c->
x86_modñ
<<4 | c->
x86_mask
) < 0x633)

199 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_SEP
);

205 i‡((
c
->
x86
 =15Ë&& (c->
x86_modñ
 =1Ë&& (c->
x86_mask
 == 1)) {

206 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

207 i‡((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

208 
	`¥ötk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

209 
	`¥ötk
 (
KERN_INFO
 "CPU: Disabling hardwareÖrefetching (Errata 037)\n");

210 
lo
 |
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

211 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

221 i‡(
˝u_has_≠ic
 && (
c
->
x86
<<8 | c->
x86_modñ
<<4) == 0x520 &&

222 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

223 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_11AP
);

226 #ifde‡
CONFIG_X86_INTEL_USERCOPY


230 
c
->
x86
) {

236 
mov¶_mask
.
mask
 = 7;

239 
mov¶_mask
.
mask
 = 7;

244 #ifde‡
CONFIG_X86_NUMAQ


245 
	`numaq_tsc_dißbÀ
();

248 
	`öãl_smp_check
(
c
);

249 
	}
}

251 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

253 
	}
}

256 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

258 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

259 
node
;

260 
˝u
 = 
	`smp_¥o˚ss‹_id
();

261 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

265 
node
 = 
≠icid_to_node
[
≠icid
];

266 i‡(
node
 =
NUMA_NO_NODE
 || !
	`node_⁄löe
(node))

267 
node
 = 
	`fú°_node
(
node_⁄löe_m≠
);

268 
	`numa_£t_node
(
˝u
, 
node
);

270 
	`¥ötk
(
KERN_INFO
 "CPU %d/0x%x -> Nodê%d\n", 
˝u
, 
≠icid
, 
node
);

272 
	}
}

277 
__˝uöô
 
	$öãl_num_˝u_c‹es
(
˝uöfo_x86
 *
c
)

279 
óx
, 
ebx
, 
ecx
, 
edx
;

281 i‡(
c
->
˝uid_Àvñ
 < 4)

285 
	`˝uid_cou¡
(4, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

286 i‡(
óx
 & 0x1f)

287  (
óx
 >> 26) + 1;

290 
	}
}

292 
__˝uöô
 
	$dëe˘_vmx_vútˇp
(
˝uöfo_x86
 *
c
)

295 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

296 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

297 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

298 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

299 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

300 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

302 
u32
 
vmx_m§_low
, 
vmx_m§_high
, 
m§_˘l
, 
m§_˘l2
;

304 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

305 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

306 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

307 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

308 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

310 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m§_low
, 
vmx_m§_high
);

311 
m§_˘l
 = 
vmx_m§_high
 | 
vmx_m§_low
;

312 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

313 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

314 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

315 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

316 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

317 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

318 
vmx_m§_low
, 
vmx_m§_high
);

319 
m§_˘l2
 = 
vmx_m§_high
 | 
vmx_m§_low
;

320 i‡((
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

321 (
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

322 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

323 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

324 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

325 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

326 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

328 
	}
}

330 
__˝uöô
 
	$öô_öãl
(
˝uöfo_x86
 *
c
)

332 
l2
 = 0;

334 
	`óæy_öô_öãl
(
c
);

336 
	`öãl_w‹k¨ounds
(
c
);

343 
	`dëe˘_exãnded_t›ﬁogy
(
c
);

345 
l2
 = 
	`öô_öãl_ˇcheöfo
(
c
);

346 i‡(
c
->
˝uid_Àvñ
 > 9) {

347 
óx
 = 
	`˝uid_óx
(10);

349 i‡((
óx
 & 0xff) && (((eax>>8) & 0xff) > 1))

350 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

353 i‡(
c
->
˝uid_Àvñ
 > 6) {

354 
ecx
 = 
	`˝uid_ecx
(6);

355 i‡(
ecx
 & 0x01)

356 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_APERFMPERF
);

359 i‡(
˝u_has_xmm2
)

360 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

361 i‡(
˝u_has_ds
) {

362 
l1
;

363 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

364 i‡(!(
l1
 & (1<<11)))

365 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_BTS
);

366 i‡(!(
l1
 & (1<<12)))

367 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PEBS
);

368 
	`ds_öô_öãl
(
c
);

371 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =29 && 
˝u_has_˛Êush
)

372 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

374 #ifde‡
CONFIG_X86_64


375 i‡(
c
->
x86
 == 15)

376 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

377 i‡(
c
->
x86
 == 6)

378 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

385 i‡(
c
->
x86
 == 6) {

386 *
p
 = 
NULL
;

388 
c
->
x86_modñ
) {

390 i‡(
c
->
x86_mask
 == 0) {

391 i‡(
l2
 == 0)

392 
p
 = "Celeron (Covington)";

393 i‡(
l2
 == 256)

394 
p
 = "Mobile Pentium II (Dixon)";

399 i‡(
l2
 == 128)

400 
p
 = "Celeron (Mendocino)";

401 i‡(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

402 
p
 = "Celeron-A";

406 i‡(
l2
 == 128)

407 
p
 = "Celeron (Coppermine)";

411 i‡(
p
)

412 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

415 i‡(
c
->
x86
 == 15)

416 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P4
);

417 i‡(
c
->
x86
 == 6)

418 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P3
);

421 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

426 
c
->
x86_max_c‹es
 = 
	`öãl_num_˝u_c‹es
(c);

427 #ifde‡
CONFIG_X86_32


428 
	`dëe˘_ht
(
c
);

433 
	`§©_dëe˘_node
(
c
);

435 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_VMX
))

436 
	`dëe˘_vmx_vútˇp
(
c
);

437 
	}
}

439 #ifde‡
CONFIG_X86_32


440 
__˝uöô
 
	$öãl_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

448 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 =11Ë&& (
size
 == 0))

449 
size
 = 256;

450  
size
;

451 
	}
}

454 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	göãl_˝u_dev
 = {

455 .
c_víd‹
 = "Intel",

456 .
	gc_idít
 = { "GenuineIntel" },

457 #ifde‡
CONFIG_X86_32


458 .
	gc_modñs
 = {

459 { .
víd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

472 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 5, .
	gmodñ_«mes
 =

483 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 6, .
	gmodñ_«mes
 =

497 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 15, .
	gmodñ_«mes
 =

507 .
	gc_size_ˇche
 = 
öãl_size_ˇche
,

509 .
	gc_óæy_öô
 = 
óæy_öô_öãl
,

510 .
	gc_öô
 = 
öô_öãl
,

511 .
	gc_x86_víd‹
 = 
X86_VENDOR_INTEL
,

514 
˝u_dev_ªgi°î
(
öãl_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<löux/öô.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/˝u.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<löux/smp.h
>

20 
	~<asm/k8.h
>

22 
	#LVL_1_INST
 1

	)

23 
	#LVL_1_DATA
 2

	)

24 
	#LVL_2
 3

	)

25 
	#LVL_3
 4

	)

26 
	#LVL_TRACE
 5

	)

28 
	s_ˇche_èbÀ
 {

29 
	mdes¸ùt‹
;

30 
	mˇche_ty≥
;

31 
	msize
;

37 c⁄° 
_ˇche_èbÀ
 
__˝uöôc⁄°
 
	gˇche_èbÀ
[] =

39 { 0x06, 
LVL_1_INST
, 8 },

40 { 0x08, 
LVL_1_INST
, 16 },

41 { 0x09, 
LVL_1_INST
, 32 },

42 { 0x0a, 
LVL_1_DATA
, 8 },

43 { 0x0c, 
LVL_1_DATA
, 16 },

44 { 0x0d, 
LVL_1_DATA
, 16 },

45 { 0x21, 
LVL_2
, 256 },

46 { 0x22, 
LVL_3
, 512 },

47 { 0x23, 
LVL_3
, 1024 },

48 { 0x25, 
LVL_3
, 2048 },

49 { 0x29, 
LVL_3
, 4096 },

50 { 0x2c, 
LVL_1_DATA
, 32 },

51 { 0x30, 
LVL_1_INST
, 32 },

52 { 0x39, 
LVL_2
, 128 },

53 { 0x3a, 
LVL_2
, 192 },

54 { 0x3b, 
LVL_2
, 128 },

55 { 0x3c, 
LVL_2
, 256 },

56 { 0x3d, 
LVL_2
, 384 },

57 { 0x3e, 
LVL_2
, 512 },

58 { 0x3f, 
LVL_2
, 256 },

59 { 0x41, 
LVL_2
, 128 },

60 { 0x42, 
LVL_2
, 256 },

61 { 0x43, 
LVL_2
, 512 },

62 { 0x44, 
LVL_2
, 1024 },

63 { 0x45, 
LVL_2
, 2048 },

64 { 0x46, 
LVL_3
, 4096 },

65 { 0x47, 
LVL_3
, 8192 },

66 { 0x49, 
LVL_3
, 4096 },

67 { 0x4a, 
LVL_3
, 6144 },

68 { 0x4b, 
LVL_3
, 8192 },

69 { 0x4c, 
LVL_3
, 12288 },

70 { 0x4d, 
LVL_3
, 16384 },

71 { 0x4e, 
LVL_2
, 6144 },

72 { 0x60, 
LVL_1_DATA
, 16 },

73 { 0x66, 
LVL_1_DATA
, 8 },

74 { 0x67, 
LVL_1_DATA
, 16 },

75 { 0x68, 
LVL_1_DATA
, 32 },

76 { 0x70, 
LVL_TRACE
, 12 },

77 { 0x71, 
LVL_TRACE
, 16 },

78 { 0x72, 
LVL_TRACE
, 32 },

79 { 0x73, 
LVL_TRACE
, 64 },

80 { 0x78, 
LVL_2
, 1024 },

81 { 0x79, 
LVL_2
, 128 },

82 { 0x7a, 
LVL_2
, 256 },

83 { 0x7b, 
LVL_2
, 512 },

84 { 0x7c, 
LVL_2
, 1024 },

85 { 0x7d, 
LVL_2
, 2048 },

86 { 0x7f, 
LVL_2
, 512 },

87 { 0x82, 
LVL_2
, 256 },

88 { 0x83, 
LVL_2
, 512 },

89 { 0x84, 
LVL_2
, 1024 },

90 { 0x85, 
LVL_2
, 2048 },

91 { 0x86, 
LVL_2
, 512 },

92 { 0x87, 
LVL_2
, 1024 },

93 { 0xd0, 
LVL_3
, 512 },

94 { 0xd1, 
LVL_3
, 1024 },

95 { 0xd2, 
LVL_3
, 2048 },

96 { 0xd6, 
LVL_3
, 1024 },

97 { 0xd7, 
LVL_3
, 2038 },

98 { 0xd8, 
LVL_3
, 4096 },

99 { 0xdc, 
LVL_3
, 2048 },

100 { 0xdd, 
LVL_3
, 4096 },

101 { 0xde, 
LVL_3
, 8192 },

102 { 0xe2, 
LVL_3
, 2048 },

103 { 0xe3, 
LVL_3
, 4096 },

104 { 0xe4, 
LVL_3
, 8192 },

109 
	e_ˇche_ty≥
 {

110 
	mCACHE_TYPE_NULL
 = 0,

111 
	mCACHE_TYPE_DATA
 = 1,

112 
	mCACHE_TYPE_INST
 = 2,

113 
	mCACHE_TYPE_UNIFIED
 = 3

116 
	u_˝uid4_Àaf_óx
 {

118 
_ˇche_ty≥
 
	mty≥
:5;

119 
	mÀvñ
:3;

120 
	mis_£lf_öôülizög
:1;

121 
	mis_fuŒy_assocütive
:1;

122 
	mª£rved
:4;

123 
	mnum_thªads_sh¨ög
:12;

124 
	mnum_c‹es_⁄_dõ
:6;

125 } 
	m•lô
;

126 
u32
 
	mfuŒ
;

129 
	u_˝uid4_Àaf_ebx
 {

131 
	mcohîícy_löe_size
:12;

132 
	mphysiˇl_löe_∑πôi⁄
:10;

133 
	mways_of_assocütivôy
:10;

134 } 
	m•lô
;

135 
u32
 
	mfuŒ
;

138 
	u_˝uid4_Àaf_ecx
 {

140 
	mnumbî_of_£ts
:32;

141 } 
	m•lô
;

142 
u32
 
	mfuŒ
;

145 
	s_˝uid4_öfo
 {

146 
_˝uid4_Àaf_óx
 
	móx
;

147 
_˝uid4_Àaf_ebx
 
	mebx
;

148 
_˝uid4_Àaf_ecx
 
	mecx
;

149 
	msize
;

150 
	mˇn_dißbÀ
;

151 
DECLARE_BITMAP
(
sh¨ed_˝u_m≠
, 
NR_CPUS
);

155 
	s_˝uid4_öfo_ªgs
 {

156 
_˝uid4_Àaf_óx
 
	móx
;

157 
_˝uid4_Àaf_ebx
 
	mebx
;

158 
_˝uid4_Àaf_ecx
 
	mecx
;

159 
	msize
;

160 
	mˇn_dißbÀ
;

163 
	gnum_ˇche_Àaves
;

171 
	ul1_ˇche
 {

173 
	mlöe_size
:8;

174 
	mlöes_≥r_èg
:8;

175 
	massoc
:8;

176 
	msize_ö_kb
:8;

178 
	mvÆ
;

181 
	ul2_ˇche
 {

183 
	mlöe_size
:8;

184 
	mlöes_≥r_èg
:4;

185 
	massoc
:4;

186 
	msize_ö_kb
:16;

188 
	mvÆ
;

191 
	ul3_ˇche
 {

193 
	mlöe_size
:8;

194 
	mlöes_≥r_èg
:4;

195 
	massoc
:4;

196 
	mªs
:2;

197 
	msize_ícoded
:14;

199 
	mvÆ
;

202 c⁄° 
__˝uöôc⁄°
 
	gassocs
[] = {

216 c⁄° 
__˝uöôc⁄°
 
	gÀvñs
[] = { 1, 1, 2, 3 };

217 c⁄° 
__˝uöôc⁄°
 
	gty≥s
[] = { 1, 2, 3, 3 };

219 
__˝uöô


220 
	$amd_˝uid4
(
Àaf
, 
_˝uid4_Àaf_óx
 *
óx
,

221 
_˝uid4_Àaf_ebx
 *
ebx
,

222 
_˝uid4_Àaf_ecx
 *
ecx
)

224 
dummy
;

225 
löe_size
, 
löes_≥r_èg
, 
assoc
, 
size_ö_kb
;

226 
l1_ˇche
 
l1i
, 
l1d
;

227 
l2_ˇche
 
l2
;

228 
l3_ˇche
 
l3
;

229 
l1_ˇche
 *
l1
 = &
l1d
;

231 
óx
->
fuŒ
 = 0;

232 
ebx
->
fuŒ
 = 0;

233 
ecx
->
fuŒ
 = 0;

235 
	`˝uid
(0x80000005, &
dummy
, &dummy, &
l1d
.
vÆ
, &
l1i
.val);

236 
	`˝uid
(0x80000006, &
dummy
, &dummy, &
l2
.
vÆ
, &
l3
.val);

238 
Àaf
) {

240 
l1
 = &
l1i
;

242 i‡(!
l1
->
vÆ
)

244 
assoc
 = 
assocs
[
l1
->assoc];

245 
löe_size
 = 
l1
->line_size;

246 
löes_≥r_èg
 = 
l1
->lines_per_tag;

247 
size_ö_kb
 = 
l1
->size_in_kb;

250 i‡(!
l2
.
vÆ
)

252 
assoc
 = 
assocs
[
l2
.assoc];

253 
löe_size
 = 
l2
.line_size;

254 
löes_≥r_èg
 = 
l2
.lines_per_tag;

256 
size_ö_kb
 = 
cuºít_˝u_d©a
.
x86_ˇche_size
;

259 i‡(!
l3
.
vÆ
)

261 
assoc
 = 
assocs
[
l3
.assoc];

262 
löe_size
 = 
l3
.line_size;

263 
löes_≥r_èg
 = 
l3
.lines_per_tag;

264 
size_ö_kb
 = 
l3
.
size_ícoded
 * 512;

265 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_AMD_DCM
)) {

266 
size_ö_kb
 = size_in_kb >> 1;

267 
assoc
 =ássoc >> 1;

274 
óx
->
•lô
.
is_£lf_öôülizög
 = 1;

275 
óx
->
•lô
.
ty≥
 = 
ty≥s
[
Àaf
];

276 
óx
->
•lô
.
Àvñ
 = 
Àvñs
[
Àaf
];

277 
óx
->
•lô
.
num_thªads_sh¨ög
 = 0;

278 
óx
->
•lô
.
num_c‹es_⁄_dõ
 = 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

281 i‡(
assoc
 == 0xffff)

282 
óx
->
•lô
.
is_fuŒy_assocütive
 = 1;

283 
ebx
->
•lô
.
cohîícy_löe_size
 = 
löe_size
 - 1;

284 
ebx
->
•lô
.
ways_of_assocütivôy
 = 
assoc
 - 1;

285 
ebx
->
•lô
.
physiˇl_löe_∑πôi⁄
 = 
löes_≥r_èg
 - 1;

286 
ecx
->
•lô
.
numbî_of_£ts
 = (
size_ö_kb
 * 1024Ë/ 
löe_size
 /

287 (
ebx
->
•lô
.
ways_of_assocütivôy
 + 1) - 1;

288 
	}
}

290 
__˝uöô


291 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

293 i‡(
ödex
 < 3)

296 i‡(
boŸ_˝u_d©a
.
x86
 == 0x11)

300 i‡((
boŸ_˝u_d©a
.
x86
 =0x10Ë&& (boŸ_˝u_d©a.
x86_modñ
 < 0x8))

303 
this_Àaf
->
ˇn_dißbÀ
 = 1;

304 
	}
}

307 
__˝uöô
 
	$˝uid4_ˇche_lookup_ªgs
(
ödex
,

308 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

310 
_˝uid4_Àaf_óx
 
óx
;

311 
_˝uid4_Àaf_ebx
 
ebx
;

312 
_˝uid4_Àaf_ecx
 
ecx
;

313 
edx
;

315 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) {

316 
	`amd_˝uid4
(
ödex
, &
óx
, &
ebx
, &
ecx
);

317 i‡(
boŸ_˝u_d©a
.
x86
 >= 0x10)

318 
	`amd_check_l3_dißbÀ
(
ödex
, 
this_Àaf
);

320 
	`˝uid_cou¡
(4, 
ödex
, &
óx
.
fuŒ
, &
ebx
.fuŒ, &
ecx
.fuŒ, &
edx
);

323 i‡(
óx
.
•lô
.
ty≥
 =
CACHE_TYPE_NULL
)

324  -
EIO
;

326 
this_Àaf
->
óx
 =Éax;

327 
this_Àaf
->
ebx
 =Ébx;

328 
this_Àaf
->
ecx
 =Écx;

329 
this_Àaf
->
size
 = (
ecx
.
•lô
.
numbî_of_£ts
 + 1) *

330 (
ebx
.
•lô
.
cohîícy_löe_size
 + 1) *

331 (
ebx
.
•lô
.
physiˇl_löe_∑πôi⁄
 + 1) *

332 (
ebx
.
•lô
.
ways_of_assocütivôy
 + 1);

334 
	}
}

336 
__˝uöô
 
	$föd_num_ˇche_Àaves
()

338 
óx
, 
ebx
, 
ecx
, 
edx
;

339 
_˝uid4_Àaf_óx
 
ˇche_óx
;

340 
i
 = -1;

343 ++
i
;

345 
	`˝uid_cou¡
(4, 
i
, &
óx
, &
ebx
, &
ecx
, &
edx
);

346 
ˇche_óx
.
fuŒ
 = 
óx
;

347 } 
ˇche_óx
.
•lô
.
ty≥
 !
CACHE_TYPE_NULL
);

348  
i
;

349 
	}
}

351 
__˝uöô
 
	$öô_öãl_ˇcheöfo
(
˝uöfo_x86
 *
c
)

354 
åa˚
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

355 
√w_l1d
 = 0, 
√w_l1i
 = 0;

356 
√w_l2
 = 0, 
√w_l3
 = 0, 
i
;

357 
l2_id
 = 0, 
l3_id
 = 0, 
num_thªads_sh¨ög
, 
ödex_msb
;

358 #ifde‡
CONFIG_X86_HT


359 
˝u
 = 
c
->
˝u_ödex
;

362 i‡(
c
->
˝uid_Àvñ
 > 3) {

363 
is_öôülized
;

365 i‡(
is_öôülized
 == 0) {

367 
num_ˇche_Àaves
 = 
	`föd_num_ˇche_Àaves
();

368 
is_öôülized
++;

375 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

376 
_˝uid4_öfo_ªgs
 
this_Àaf
;

377 
ªtvÆ
;

379 
ªtvÆ
 = 
	`˝uid4_ˇche_lookup_ªgs
(
i
, &
this_Àaf
);

380 i‡(
ªtvÆ
 >= 0) {

381 
this_Àaf
.
óx
.
•lô
.
Àvñ
) {

383 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

384 
CACHE_TYPE_DATA
)

385 
√w_l1d
 = 
this_Àaf
.
size
/1024;

386 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

387 
CACHE_TYPE_INST
)

388 
√w_l1i
 = 
this_Àaf
.
size
/1024;

391 
√w_l2
 = 
this_Àaf
.
size
/1024;

392 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

393 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

394 
l2_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

397 
√w_l3
 = 
this_Àaf
.
size
/1024;

398 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

399 
ödex_msb
 = 
	`gë_cou¡_‹dî
(

400 
num_thªads_sh¨ög
);

401 
l3_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

413 i‡((
num_ˇche_Àaves
 =0 || 
c
->
x86
 =15Ë&& c->
˝uid_Àvñ
 > 1) {

415 
j
, 
n
;

416 
ªgs
[4];

417 *
dp
 = (*)
ªgs
;

418 
⁄ly_åa˚
 = 0;

420 i‡(
num_ˇche_Àaves
 !0 && 
c
->
x86
 == 15)

421 
⁄ly_åa˚
 = 1;

424 
n
 = 
	`˝uid_óx
(2) & 0xFF;

426 
i
 = 0 ; i < 
n
 ; i++) {

427 
	`˝uid
(2, &
ªgs
[0], &regs[1], &regs[2], &regs[3]);

430 
j
 = 0 ; j < 3 ; j++)

431 i‡(
ªgs
[
j
] & (1 << 31))

432 
ªgs
[
j
] = 0;

435 
j
 = 1 ; j < 16 ; j++) {

436 
des
 = 
dp
[
j
];

437 
k
 = 0;

440 
ˇche_èbÀ
[
k
].
des¸ùt‹
 != 0) {

441 i‡(
ˇche_èbÀ
[
k
].
des¸ùt‹
 =
des
) {

442 i‡(
⁄ly_åa˚
 && 
ˇche_èbÀ
[
k
].
ˇche_ty≥
 !
LVL_TRACE
)

444 
ˇche_èbÀ
[
k
].
ˇche_ty≥
) {

445 
LVL_1_INST
:

446 
l1i
 +
ˇche_èbÀ
[
k
].
size
;

448 
LVL_1_DATA
:

449 
l1d
 +
ˇche_èbÀ
[
k
].
size
;

451 
LVL_2
:

452 
l2
 +
ˇche_èbÀ
[
k
].
size
;

454 
LVL_3
:

455 
l3
 +
ˇche_èbÀ
[
k
].
size
;

457 
LVL_TRACE
:

458 
åa˚
 +
ˇche_èbÀ
[
k
].
size
;

465 
k
++;

471 i‡(
√w_l1d
)

472 
l1d
 = 
√w_l1d
;

474 i‡(
√w_l1i
)

475 
l1i
 = 
√w_l1i
;

477 i‡(
√w_l2
) {

478 
l2
 = 
√w_l2
;

479 #ifde‡
CONFIG_X86_HT


480 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l2_id
;

484 i‡(
√w_l3
) {

485 
l3
 = 
√w_l3
;

486 #ifde‡
CONFIG_X86_HT


487 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l3_id
;

491 i‡(
åa˚
)

492 
	`¥ötk
(
KERN_INFO
 "CPU: Tø˚ cache: %dK u›s", 
åa˚
);

493 i‡(
l1i
)

494 
	`¥ötk
(
KERN_INFO
 "CPU: L1 I cache: %dK", 
l1i
);

496 i‡(
l1d
)

497 
	`¥ötk
(
KERN_CONT
 ", L1 D cache: %dK\n", 
l1d
);

499 
	`¥ötk
(
KERN_CONT
 "\n");

501 i‡(
l2
)

502 
	`¥ötk
(
KERN_INFO
 "CPU: L2 cache: %dK\n", 
l2
);

504 i‡(
l3
)

505 
	`¥ötk
(
KERN_INFO
 "CPU: L3 cache: %dK\n", 
l3
);

507 
c
->
x86_ˇche_size
 = 
l3
 ?Ü3 : (
l2
 ?Ü2 : (
l1i
+
l1d
));

509  
l2
;

510 
	}
}

512 #ifde‡
CONFIG_SYSFS


515 
DEFINE_PER_CPU
(
_˝uid4_öfo
 *, 
˝uid4_öfo
);

516 
	#CPUID4_INFO_IDX
(
x
, 
y
Ë(&((
	`≥r_˝u
(
˝uid4_öfo
, x))[y]))

	)

518 #ifde‡
CONFIG_SMP


519 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

521 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

522 
num_thªads_sh¨ög
;

523 
ödex_msb
, 
i
;

524 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

526 i‡((
ödex
 =3Ë&& (
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)) {

527 
˝uöfo_x86
 *
d
;

528 
	`f‹_óch_⁄löe_˝u
(
i
) {

529 i‡(!
	`≥r_˝u
(
˝uid4_öfo
, 
i
))

531 
d
 = &
	`˝u_d©a
(
i
);

532 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

533 
	`˝umask_c›y
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
),

534 
d
->
Œc_sh¨ed_m≠
);

538 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

539 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
->
óx
.
•lô
.num_threads_sharing;

541 i‡(
num_thªads_sh¨ög
 == 1)

542 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

544 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

546 
	`f‹_óch_⁄löe_˝u
(
i
) {

547 i‡(
	`˝u_d©a
(
i
).
≠icid
 >> 
ödex_msb
 ==

548 
c
->
≠icid
 >> 
ödex_msb
) {

549 
	`˝umask_£t_˝u
(
i
,

550 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

551 i‡(
i
 !
˝u
 && 
	`≥r_˝u
(
˝uid4_öfo
, i)) {

552 
siblög_Àaf
 =

553 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

554 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(

555 
siblög_Àaf
->
sh¨ed_˝u_m≠
));

560 
	}
}

561 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

563 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

564 
siblög
;

566 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

567 
	`f‹_óch_˝u
(
siblög
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
)) {

568 
siblög_Àaf
 = 
	`CPUID4_INFO_IDX
(
siblög
, 
ödex
);

569 
	`˝umask_˛ór_˝u
(
˝u
,

570 
	`to_˝umask
(
siblög_Àaf
->
sh¨ed_˝u_m≠
));

572 
	}
}

574 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

576 
	}
}

578 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

580 
	}
}

583 
__˝uöô
 
	$‰ì_ˇche_©åibuãs
(
˝u
)

585 
i
;

587 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

588 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

590 
	`k‰ì
(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
));

591 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
NULL
;

592 
	}
}

595 
__˝uöô
 
	$˝uid4_ˇche_lookup
(
ödex
, 
_˝uid4_öfo
 *
this_Àaf
)

597 
_˝uid4_öfo_ªgs
 *
Àaf_ªgs
 =

598 (
_˝uid4_öfo_ªgs
 *)
this_Àaf
;

600  
	`˝uid4_ˇche_lookup_ªgs
(
ödex
, 
Àaf_ªgs
);

601 
	}
}

603 
__˝uöô
 
	$gë_˝u_Àaves
(*
_ªtvÆ
)

605 
j
, *
ªtvÆ
 = 
_ªtvÆ
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

608 
j
 = 0; j < 
num_ˇche_Àaves
; j++) {

609 
_˝uid4_öfo
 *
this_Àaf
;

610 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
j
);

611 *
ªtvÆ
 = 
	`˝uid4_ˇche_lookup
(
j
, 
this_Àaf
);

612 i‡(
	`u∆ikñy
(*
ªtvÆ
 < 0)) {

613 
i
;

615 
i
 = 0; i < 
j
; i++)

616 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

619 
	`ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
j
);

621 
	}
}

623 
__˝uöô
 
	$dëe˘_ˇche_©åibuãs
(
˝u
)

625 
ªtvÆ
;

627 i‡(
num_ˇche_Àaves
 == 0)

628  -
ENOENT
;

630 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
	`kzÆloc
(

631 (
_˝uid4_öfo
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

632 i‡(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë=
NULL
)

633  -
ENOMEM
;

635 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
gë_˝u_Àaves
, &
ªtvÆ
, 
åue
);

636 i‡(
ªtvÆ
) {

637 
	`k‰ì
(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
));

638 
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë
NULL
;

641  
ªtvÆ
;

642 
	}
}

644 
	~<löux/kobje˘.h
>

645 
	~<löux/sysfs.h
>

647 
sysdev_˛ass
 
˝u_sysdev_˛ass
;

650 
DEFINE_PER_CPU
(
kobje˘
 *, 
ˇche_kobje˘
);

652 
	s_ödex_kobje˘
 {

653 
kobje˘
 
	mkobj
;

654 
	m˝u
;

655 
	mödex
;

659 
DEFINE_PER_CPU
(
_ödex_kobje˘
 *, 
ödex_kobje˘
);

660 
	#INDEX_KOBJECT_PTR
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ödex_kobje˘
, x))[y]))

	)

662 
	#show_⁄e_∂us
(
fûe_«me
, 
obje˘
, 
vÆ
) \

663 
ssize_t
 
show_
##
fûe_«me
 \

664 (
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

666  
	`•rötf
(
buf
, "%lu\n", ()
this_Àaf
->
obje˘
 + 
vÆ
); \

667 }

	)

669 
show_⁄e_∂us
(
Àvñ
, 
óx
.
•lô
.level, 0);

670 
show_⁄e_∂us
(
cohîícy_löe_size
, 
ebx
.
•lô
.coherency_line_size, 1);

671 
show_⁄e_∂us
(
physiˇl_löe_∑πôi⁄
, 
ebx
.
•lô
.physical_line_partition, 1);

672 
show_⁄e_∂us
(
ways_of_assocütivôy
, 
ebx
.
•lô
.ways_of_associativity, 1);

673 
show_⁄e_∂us
(
numbî_of_£ts
, 
ecx
.
•lô
.number_of_sets, 1);

675 
ssize_t
 
	$show_size
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

677  
	`•rötf
(
buf
, "%luK\n", 
this_Àaf
->
size
 / 1024);

678 
	}
}

680 
ssize_t
 
	$show_sh¨ed_˝u_m≠_func
(
_˝uid4_öfo
 *
this_Àaf
,

681 
ty≥
, *
buf
)

683 
±rdiff_t
 
Àn
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

684 
n
 = 0;

686 i‡(
Àn
 > 1) {

687 c⁄° 
˝umask
 *
mask
;

689 
mask
 = 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
);

690 
n
 = 
ty≥
 ?

691 
	`˝uli°_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
) :

692 
	`˝umask_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
);

693 
buf
[
n
++] = '\n';

694 
buf
[
n
] = '\0';

696  
n
;

697 
	}
}

699 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_m≠
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

701  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 0, 
buf
);

702 
	}
}

704 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_li°
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

706  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 1, 
buf
);

707 
	}
}

709 
ssize_t
 
	$show_ty≥
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

711 
this_Àaf
->
óx
.
•lô
.
ty≥
) {

712 
CACHE_TYPE_DATA
:

713  
	`•rötf
(
buf
, "Data\n");

714 
CACHE_TYPE_INST
:

715  
	`•rötf
(
buf
, "Instruction\n");

716 
CACHE_TYPE_UNIFIED
:

717  
	`•rötf
(
buf
, "Unified\n");

719  
	`•rötf
(
buf
, "Unknown\n");

721 
	}
}

723 
	#to_obje˘
(
k
Ë
	`c⁄èöî_of
(k, 
_ödex_kobje˘
, 
kobj
)

	)

724 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
_ˇche_©å
, 
©å
)

	)

726 
ssize_t
 
	$show_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
,

727 
ödex
)

729 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

730 
node
 = 
	`˝u_to_node
(
˝u
);

731 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

732 
ªg
 = 0;

734 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

735  -
EINVAL
;

737 i‡(!
dev
)

738  -
EINVAL
;

740 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, &
ªg
);

741  
	`•rötf
(
buf
, "%x\n", 
ªg
);

742 
	}
}

744 
	#SHOW_CACHE_DISABLE
(
ödex
) \

745 
ssize_t
 \

746 
show_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

748  
	`show_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
ödex
); \

749 }

	)

750 
	$SHOW_CACHE_DISABLE
(0)

751 
	$SHOW_CACHE_DISABLE
(1)

753 
ssize_t
 
	$°‹e_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
,

754 c⁄° *
buf
, 
size_t
 
cou¡
, 
ödex
)

756 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

757 
node
 = 
	`˝u_to_node
(
˝u
);

758 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

759 
vÆ
 = 0;

760 
s¸ubbî
 = 0;

762 i‡(!
this_Àaf
->
ˇn_dißbÀ
)

763  -
EINVAL
;

765 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

766  -
EPERM
;

768 i‡(!
dev
)

769  -
EINVAL
;

771 i‡(
	`°ri˘_°πoul
(
buf
, 10, &
vÆ
) < 0)

772  -
EINVAL
;

774 
vÆ
 |= 0xc0000000;

776 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x58, &
s¸ubbî
);

777 
s¸ubbî
 &= ~0x1f000000;

778 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x58, 
s¸ubbî
);

780 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
 & ~0x40000000);

781 
	`wbövd
();

782 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x1BC + 
ödex
 * 4, 
vÆ
);

783  
cou¡
;

784 
	}
}

786 
	#STORE_CACHE_DISABLE
(
ödex
) \

787 
ssize_t
 \

788 
°‹e_ˇche_dißbÀ_
##
	`ödex
(
_˝uid4_öfo
 *
this_Àaf
, \

789 c⁄° *
buf
, 
size_t
 
cou¡
) \

791  
	`°‹e_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
cou¡
, 
ödex
); \

792 }

	)

793 
	$STORE_CACHE_DISABLE
(0)

794 
	$STORE_CACHE_DISABLE
(1)

796 
	s_ˇche_©å
 {

797 
©åibuã
 
©å
;

798 
	`ssize_t
 (*
show
)(
_˝uid4_öfo
 *, *);

799 
	`ssize_t
 (*
°‹e
)(
_˝uid4_öfo
 *, c⁄° *, 
size_t
 
cou¡
);

802 
	#deföe_⁄e_ro
(
_«me
) \

803 
_ˇche_©å
 
_«me
 = \

804 
	`__ATTR
(
_«me
, 0444, 
show_
##_«me, 
NULL
)

	)

806 
	`deföe_⁄e_ro
(
Àvñ
);

807 
	`deföe_⁄e_ro
(
ty≥
);

808 
	`deföe_⁄e_ro
(
cohîícy_löe_size
);

809 
	`deföe_⁄e_ro
(
physiˇl_löe_∑πôi⁄
);

810 
	`deföe_⁄e_ro
(
ways_of_assocütivôy
);

811 
	`deföe_⁄e_ro
(
numbî_of_£ts
);

812 
	`deföe_⁄e_ro
(
size
);

813 
	`deföe_⁄e_ro
(
sh¨ed_˝u_m≠
);

814 
	`deföe_⁄e_ro
(
sh¨ed_˝u_li°
);

816 
_ˇche_©å
 
ˇche_dißbÀ_0
 = 
	`__ATTR
(cache_disable_0, 0644,

817 
show_ˇche_dißbÀ_0
, 
°‹e_ˇche_dißbÀ_0
);

818 
_ˇche_©å
 
ˇche_dißbÀ_1
 = 
	`__ATTR
(cache_disable_1, 0644,

819 
show_ˇche_dißbÀ_1
, 
°‹e_ˇche_dißbÀ_1
);

821 
©åibuã
 *
deÁu…_©ås
[] = {

822 &
ty≥
.
©å
,

823 &
Àvñ
.
©å
,

824 &
cohîícy_löe_size
.
©å
,

825 &
physiˇl_löe_∑πôi⁄
.
©å
,

826 &
ways_of_assocütivôy
.
©å
,

827 &
numbî_of_£ts
.
©å
,

828 &
size
.
©å
,

829 &
sh¨ed_˝u_m≠
.
©å
,

830 &
sh¨ed_˝u_li°
.
©å
,

831 &
ˇche_dißbÀ_0
.
©å
,

832 &
ˇche_dißbÀ_1
.
©å
,

833 
NULL


834 
	}
};

836 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

838 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

839 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

840 
ssize_t
 
ªt
;

842 
ªt
 = 
Áâr
->
show
 ?

843 
Áâr
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

844 
buf
) :

846  
ªt
;

847 
	}
}

849 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

850 c⁄° *
buf
, 
size_t
 
cou¡
)

852 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

853 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

854 
ssize_t
 
ªt
;

856 
ªt
 = 
Áâr
->
°‹e
 ?

857 
Áâr
->
	`°‹e
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

858 
buf
, 
cou¡
) :

860  
ªt
;

861 
	}
}

863 
sysfs_›s
 
	gsysfs_›s
 = {

864 .
show
 = show,

865 .
	g°‹e
 = 
°‹e
,

868 
kobj_ty≥
 
	gkty≥_ˇche
 = {

869 .
sysfs_›s
 = &sysfs_ops,

870 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

873 
kobj_ty≥
 
	gkty≥_≥r˝u_íåy
 = {

874 .
sysfs_›s
 = &sysfs_ops,

877 
__˝uöô
 
	$˝uid4_ˇche_sysfs_exô
(
˝u
)

879 
	`k‰ì
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

880 
	`k‰ì
(
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
));

881 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
Ë
NULL
;

882 
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë
NULL
;

883 
	`‰ì_ˇche_©åibuãs
(
˝u
);

884 
	}
}

886 
__˝uöô
 
	$˝uid4_ˇche_sysfs_öô
(
˝u
)

888 
îr
;

890 i‡(
num_ˇche_Àaves
 == 0)

891  -
ENOENT
;

893 
îr
 = 
	`dëe˘_ˇche_©åibuãs
(
˝u
);

894 i‡(
îr
)

895  
îr
;

898 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
) =

899 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

900 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
Ë=
NULL
))

901 
îr_out
;

903 
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë
	`kzÆloc
(

904 (
_ödex_kobje˘
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

905 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ödex_kobje˘
, 
˝u
Ë=
NULL
))

906 
îr_out
;

910 
îr_out
:

911 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

912  -
ENOMEM
;

913 
	}
}

915 
DECLARE_BITMAP
(
ˇche_dev_m≠
, 
NR_CPUS
);

918 
__˝uöô
 
	$ˇche_add_dev
(
sys_devi˚
 * 
sys_dev
)

920 
˝u
 = 
sys_dev
->
id
;

921 
i
, 
j
;

922 
_ödex_kobje˘
 *
this_obje˘
;

923 
ªtvÆ
;

925 
ªtvÆ
 = 
	`˝uid4_ˇche_sysfs_öô
(
˝u
);

926 i‡(
	`u∆ikñy
(
ªtvÆ
 < 0))

927  
ªtvÆ
;

929 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
),

930 &
kty≥_≥r˝u_íåy
,

931 &
sys_dev
->
kobj
, "%s", "cache");

932 i‡(
ªtvÆ
 < 0) {

933 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

934  
ªtvÆ
;

937 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

938 
this_obje˘
 = 
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
);

939 
this_obje˘
->
˝u
 = cpu;

940 
this_obje˘
->
ödex
 = 
i
;

941 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(&(
this_obje˘
->
kobj
),

942 &
kty≥_ˇche
,

943 
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
),

944 "ödex%1lu", 
i
);

945 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

946 
j
 = 0; j < 
i
; j++)

947 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
j
)->
kobj
));

948 
	`kobje˘_put
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

949 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

950  
ªtvÆ
;

952 
	`kobje˘_uevít
(&(
this_obje˘
->
kobj
), 
KOBJ_ADD
);

954 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

956 
	`kobje˘_uevít
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
), 
KOBJ_ADD
);

958 
	}
}

960 
__˝uöô
 
	$ˇche_ªmove_dev
(
sys_devi˚
 * 
sys_dev
)

962 
˝u
 = 
sys_dev
->
id
;

963 
i
;

965 i‡(
	`≥r_˝u
(
˝uid4_öfo
, 
˝u
Ë=
NULL
)

967 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
)))

969 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

971 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

972 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
)->
kobj
));

973 
	`kobje˘_put
(
	`≥r_˝u
(
ˇche_kobje˘
, 
˝u
));

974 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

975 
	}
}

977 
__˝uöô
 
	$ˇcheöfo_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

978 
a˘i⁄
, *
h˝u
)

980 
˝u
 = ()
h˝u
;

981 
sys_devi˚
 *
sys_dev
;

983 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

984 
a˘i⁄
) {

985 
CPU_ONLINE
:

986 
CPU_ONLINE_FROZEN
:

987 
	`ˇche_add_dev
(
sys_dev
);

989 
CPU_DEAD
:

990 
CPU_DEAD_FROZEN
:

991 
	`ˇche_ªmove_dev
(
sys_dev
);

994  
NOTIFY_OK
;

995 
	}
}

997 
nŸifõr_block
 
__˝uöôd©a
 
	gˇcheöfo_˝u_nŸifõr
 = {

998 .
nŸifõr_ˇŒ
 = 
ˇcheöfo_˝u_ˇŒback
,

1001 
__˝uöô
 
	$ˇche_sysfs_öô
()

1003 
i
;

1005 i‡(
num_ˇche_Àaves
 == 0)

1008 
	`f‹_óch_⁄löe_˝u
(
i
) {

1009 
îr
;

1010 
sys_devi˚
 *
sys_dev
 = 
	`gë_˝u_sysdev
(
i
);

1012 
îr
 = 
	`ˇche_add_dev
(
sys_dev
);

1013 i‡(
îr
)

1014  
îr
;

1016 
	`ªgi°î_hŸ˝u_nŸifõr
(&
ˇcheöfo_˝u_nŸifõr
);

1018 
	}
}

1020 
devi˚_öôˇŒ
(
ˇche_sysfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/debugfs.h
>

16 
	~<asm/m˚.h
>

18 
	~"m˚-öã∫Æ.h
"

32 
	ec⁄ãxt
 { 
	mIN_KERNEL
 = 1, 
	mIN_USER
 = 2 };

33 
	e£r
 { 
	mSER_REQUIRED
 = 1, 
	mNO_SER
 = 2 };

35 
	s£vîôy
 {

36 
u64
 
	mmask
;

37 
u64
 
	mªsu…
;

38 
	m£v
;

39 
	mmcgmask
;

40 
	mmcgªs
;

41 
	m£r
;

42 
	mc⁄ãxt
;

43 
	mcovîed
;

44 *
	mmsg
;

45 } 
	g£vîôõs
[] = {

46 
	#KERNEL
 .
c⁄ãxt
 = 
IN_KERNEL


	)

47 
	#USER
 .
c⁄ãxt
 = 
IN_USER


	)

48 
	#SER
 .
£r
 = 
SER_REQUIRED


	)

49 
	#NOSER
 .
£r
 = 
NO_SER


	)

50 
	#SEV
(
s
Ë.
£v
 = 
MCE_
 ## s ## 
_SEVERITY


	)

51 
	#BITCLR
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = 0, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

52 
	#BITSET
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = x, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

53 
	#MCGMASK
(
x
, 
ªs
, 
s
, 
m
, 
r
...) \

54 { .
mcgmask
 = 
x
, .
mcgªs
 = 
ªs
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

55 
	#MASK
(
x
, 
y
, 
s
, 
m
, 
r
...) \

56 { .
mask
 = 
x
, .
ªsu…
 = 
y
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

57 
	#MCI_UC_S
 (
MCI_STATUS_UC
|
MCI_STATUS_S
)

	)

58 
	#MCI_UC_SAR
 (
MCI_STATUS_UC
|
MCI_STATUS_S
|
MCI_STATUS_AR
)

	)

59 
	#MCACOD
 0xffff

	)

61 
BITCLR
(
MCI_STATUS_VAL
, 
NO
, "Invalid"),

62 
BITCLR
(
MCI_STATUS_EN
, 
NO
, "NotÉnabled"),

63 
BITSET
(
MCI_STATUS_PCC
, 
PANIC
, "Processor context corrupt"),

65 
MCGMASK
(
MCG_STATUS_MCIP
, 0, 
PANIC
, "MCIPÇot set in MCA handler"),

67 
MCGMASK
(
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
, 0, 
PANIC
,

69 
MCGMASK
(
MCG_STATUS_RIPV
, 0, 
PANIC
, "In kernelándÇoÑestart IP",

70 
KERNEL
),

71 
BITCLR
(
MCI_STATUS_UC
, 
KEEP
, "C‹ª˘edÉº‹", 
NOSER
),

72 
MASK
(
MCI_STATUS_OVER
|
MCI_STATUS_UC
|
MCI_STATUS_EN
, MCI_STATUS_UC, 
SOME
,

73 "Spuriou†nŸÉ«bÀd", 
SER
),

76 
MASK
(
MCI_UC_SAR
, 
MCI_STATUS_UC
, 
KEEP
,

77 "Unc‹ª˘edÇÿa˘i⁄Ñequúed", 
SER
),

78 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_STATUS_UC
|
MCI_STATUS_AR
, 
PANIC
,

79 "IŒegÆ combö©i⁄ (UCNA wôh AR=1)", 
SER
),

80 
MASK
(
MCI_STATUS_S
, 0, 
KEEP
, "N⁄ sig«Œed machöêcheck", 
SER
),

83 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, MCI_STATUS_OVER|MCI_UC_SAR, 
PANIC
,

84 "A˘i⁄Ñequúed wôhÜo°Évíts", 
SER
),

85 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
|
MCACOD
, MCI_UC_SAR, 
PANIC
,

86 "A˘i⁄Ñequúed; unknow¿MCACOD", 
SER
),

89 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|0xfff0, 
MCI_UC_S
|0xc0, 
AO
,

90 "A˘i⁄ o±i⁄Æ: mem‹y s¸ubbögÉº‹", 
SER
),

91 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|
MCACOD
, 
MCI_UC_S
|0x17a, 
AO
,

92 "A˘i⁄ o±i⁄Æ:Üa°Üevñ cachêwrôebackÉº‹", 
SER
),

94 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
, 
SOME
,

95 "A˘i⁄ o±i⁄Æ unknow¿MCACOD", 
SER
),

96 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
|MCI_STATUS_OVER, 
SOME
,

97 "A˘i⁄ o±i⁄Æ wôhÜo°Évíts", 
SER
),

98 
BITSET
(
MCI_STATUS_UC
|
MCI_STATUS_OVER
, 
PANIC
, "Overflowed uncorrected"),

99 
BITSET
(
MCI_STATUS_UC
, 
UC
, "Uncorrected"),

100 
BITSET
(0, 
SOME
, "No match")

107 
	$îr‹_c⁄ãxt
(
m˚
 *
m
)

109 i‡(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
)

110  (
m
->
ù
 && (m->
cs
 & 3Ë=3Ë? 
IN_USER
 : 
IN_KERNEL
;

112  
IN_KERNEL
;

113 
	}
}

115 
	$m˚_£vîôy
(
m˚
 *
a
, 
tﬁî™t
, **
msg
)

117 
c⁄ãxt
 
˘x
 = 
	`îr‹_c⁄ãxt
(
a
);

118 
£vîôy
 *
s
;

120 
s
 = 
£vîôõs
;; s++) {

121 i‡((
a
->
°©us
 & 
s
->
mask
Ë!s->
ªsu…
)

123 i‡((
a
->
mcg°©us
 & 
s
->
mcgmask
Ë!s->
mcgªs
)

125 i‡(
s
->
£r
 =
SER_REQUIRED
 && !
m˚_£r
)

127 i‡(
s
->
£r
 =
NO_SER
 && 
m˚_£r
)

129 i‡(
s
->
c⁄ãxt
 && 
˘x
 != s->context)

131 i‡(
msg
)

132 *
msg
 = 
s
->msg;

133 
s
->
covîed
 = 1;

134 i‡(
s
->
£v
 >
MCE_UC_SEVERITY
 && 
˘x
 =
IN_KERNEL
) {

135 i‡(
∑nic_⁄_o›s
 || 
tﬁî™t
 < 1)

136  
MCE_PANIC_SEVERITY
;

138  
s
->
£v
;

140 
	}
}

142 #ifde‡
CONFIG_DEBUG_FS


143 *
	$s_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

145 i‡(*
pos
 >
	`ARRAY_SIZE
(
£vîôõs
))

146  
NULL
;

147  &
£vîôõs
[*
pos
];

148 
	}
}

150 *
	$s_√xt
(
£q_fûe
 *
f
, *
d©a
, 
loff_t
 *
pos
)

152 i‡(++(*
pos
Ë>
	`ARRAY_SIZE
(
£vîôõs
))

153  
NULL
;

154  &
£vîôõs
[*
pos
];

155 
	}
}

157 
	$s_°›
(
£q_fûe
 *
f
, *
d©a
)

159 
	}
}

161 
	$s_show
(
£q_fûe
 *
f
, *
d©a
)

163 
£vîôy
 *
£r
 = 
d©a
;

164 
	`£q_¥ötf
(
f
, "%d\t%s\n", 
£r
->
covîed
, sî->
msg
);

166 
	}
}

168 c⁄° 
£q_›î©i⁄s
 
	g£vîôõs_£q_›s
 = {

169 .
°¨t
 = 
s_°¨t
,

170 .
	g√xt
 = 
s_√xt
,

171 .
	g°›
 = 
s_°›
,

172 .
	gshow
 = 
s_show
,

175 
	$£vîôõs_covîage_›í
(
öode
 *öode, 
fûe
 *file)

177  
	`£q_›í
(
fûe
, &
£vîôõs_£q_›s
);

178 
	}
}

180 
ssize_t
 
	$£vîôõs_covîage_wrôe
(
fûe
 *file,

181 c⁄° 
__u£r
 *
ubuf
,

182 
size_t
 
cou¡
, 
loff_t
 *
µos
)

184 
i
;

185 
i
 = 0; i < 
	`ARRAY_SIZE
(
£vîôõs
); i++)

186 
£vîôõs
[
i
].
covîed
 = 0;

187  
cou¡
;

188 
	}
}

190 c⁄° 
fûe_›î©i⁄s
 
	g£vîôõs_covîage_f›s
 = {

191 .
›í
 = 
£vîôõs_covîage_›í
,

192 .
	gªÀa£
 = 
£q_ªÀa£
,

193 .
	gªad
 = 
£q_ªad
,

194 .
	gwrôe
 = 
£vîôõs_covîage_wrôe
,

197 
__öô
 
	$£vîôõs_debugfs_öô
()

199 
díåy
 *
dm˚
 = 
NULL
, *
f£vîôõs_covîage
 = NULL;

201 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

202 i‡(
dm˚
 =
NULL
)

203 
îr_out
;

204 
f£vîôõs_covîage
 = 
	`debugfs_¸óã_fûe
("severities-coverage",

205 0444, 
dm˚
, 
NULL
,

206 &
£vîôõs_covîage_f›s
);

207 i‡(
f£vîôõs_covîage
 =
NULL
)

208 
îr_out
;

212 
îr_out
:

213  -
ENOMEM
;

214 
	}
}

215 
œã_öôˇŒ
(
£vîôõs_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c

10 
	~<löux/thªad_öfo.h
>

11 
	~<löux/ˇ∑bûôy.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/kÆlsyms.h
>

16 
	~<löux/rcupd©e.h
>

17 
	~<löux/kobje˘.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≥r˝u.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/sysdev.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/˘y≥.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/sysfs.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/öô.h
>

30 
	~<löux/kmod.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/nmi.h
>

33 
	~<löux/˝u.h
>

34 
	~<löux/smp.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/mm.h
>

37 
	~<löux/debugfs.h
>

39 
	~<asm/¥o˚ss‹.h
>

40 
	~<asm/hw_úq.h
>

41 
	~<asm/≠ic.h
>

42 
	~<asm/idÀ.h
>

43 
	~<asm/ùi.h
>

44 
	~<asm/m˚.h
>

45 
	~<asm/m§.h
>

47 
	~"m˚-öã∫Æ.h
"

49 
m˚_dißbÀd
 
	g__ªad_mo°ly
;

51 
	#MISC_MCELOG_MINOR
 227

	)

53 
	#SPINUNIT
 100

	)

55 
©omic_t
 
	gm˚_íåy
;

57 
DEFINE_PER_CPU
(, 
m˚_ex˚±i⁄_cou¡
);

66 
tﬁî™t
 
	g__ªad_mo°ly
 = 1;

67 
b™ks
 
	g__ªad_mo°ly
;

68 
rù_m§
 
	g__ªad_mo°ly
;

69 
m˚_boŸlog
 
	g__ªad_mo°ly
 = -1;

70 
m⁄¨ch_timeout
 
	g__ªad_mo°ly
 = -1;

71 
m˚_∑nic_timeout
 
	g__ªad_mo°ly
;

72 
m˚_d⁄t_log_˚
 
	g__ªad_mo°ly
;

73 
m˚_cmci_dißbÀd
 
	g__ªad_mo°ly
;

74 
m˚_ign‹e_˚
 
	g__ªad_mo°ly
;

75 
m˚_£r
 
	g__ªad_mo°ly
;

77 
m˚_b™k
 *
m˚_b™ks
 
	g__ªad_mo°ly
;

80 
	gm˚_√ed_nŸify
;

81 
	gm˚_hñ≥r
[128];

82 *
	gm˚_hñ≥r_¨gv
[2] = { 
m˚_hñ≥r
, 
NULL
 };

84 
DECLARE_WAIT_QUEUE_HEAD
(
m˚_waô
);

85 
DEFINE_PER_CPU
(
m˚
, 
m˚s_£í
);

86 
	g˝u_missög
;

88 
	$deÁu…_decode_m˚
(
m˚
 *
m
)

90 
	`¥_emîg
("No humanÑeadable MCE decoding support onÅhis CPUÅype.\n");

91 
	`¥_emîg
("RunÅhe messageÅhrough 'mcelog --ascii'Åo decode.\n");

92 
	}
}

98 (*
x86_m˚_decode_ˇŒback
)(
m˚
 *
m
Ë
deÁu…_decode_m˚
;

99 
	`EXPORT_SYMBOL
(
x86_m˚_decode_ˇŒback
);

102 
	`DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_pﬁl_b™ks
) = {

103 [0 ... 
	`BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

104 
	}
};

106 
DEFINE_PER_CPU
(
w‹k_°ru˘
, 
m˚_w‹k
);

109 
	$m˚_£tup
(
m˚
 *
m
)

111 
	`mem£t
(
m
, 0, (
m˚
));

112 
m
->
˝u
 = m->
ext˝u
 = 
	`smp_¥o˚ss‹_id
();

113 
	`rdts˛l
(
m
->
tsc
);

115 
m
->
time
 = 
	`gë_£c⁄ds
();

116 
m
->
˝uvíd‹
 = 
boŸ_˝u_d©a
.
x86_víd‹
;

117 
m
->
˝uid
 = 
	`˝uid_óx
(1);

118 #ifde‡
CONFIG_SMP


119 
m
->
sockëid
 = 
	`˝u_d©a
(m->
ext˝u
).
phys_¥oc_id
;

121 
m
->
≠icid
 = 
	`˝u_d©a
(m->
ext˝u
).
öôül_≠icid
;

122 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
m
->
mcgˇp
);

123 
	}
}

125 
DEFINE_PER_CPU
(
m˚
, 
öje˘m
);

126 
EXPORT_PER_CPU_SYMBOL_GPL
(
öje˘m
);

134 
m˚_log
 
	gm˚log
 = {

135 .
sig«tuª
 = 
MCE_LOG_SIGNATURE
,

136 .
	gÀn
 = 
MCE_LOG_LEN
,

137 .
	gªc‹dÀn
 = (
m˚
),

140 
	$m˚_log
(
m˚
 *mce)

142 
√xt
, 
íåy
;

144 
m˚
->
föished
 = 0;

145 
	`wmb
();

147 
íåy
 = 
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
);

154 i‡(
íåy
 >
MCE_LOG_LEN
) {

155 
	`£t_bô
(
MCE_OVERFLOW
,

156 (*)&
m˚log
.
Êags
);

160 i‡(
m˚log
.
íåy
[íåy].
föished
) {

161 
íåy
++;

166 
	`smp_rmb
();

167 
√xt
 = 
íåy
 + 1;

168 i‡(
	`cmpxchg
(&
m˚log
.
√xt
, 
íåy
,Çext) ==Éntry)

171 
	`mem˝y
(
m˚log
.
íåy
 +É¡ry, 
m˚
, (mce));

172 
	`wmb
();

173 
m˚log
.
íåy
[íåy].
föished
 = 1;

174 
	`wmb
();

176 
m˚
->
föished
 = 1;

177 
	`£t_bô
(0, &
m˚_√ed_nŸify
);

178 
	}
}

180 
	$¥öt_m˚
(
m˚
 *
m
)

182 
	`¥_emîg
("CPU %d: Machine Check Exception: %16Lx Bank %d: %016Lx\n",

183 
m
->
ext˝u
, m->
mcg°©us
, m->
b™k
, m->
°©us
);

185 i‡(
m
->
ù
) {

186 
	`¥_emîg
("RIP%s %02x:<%016Lx> ",

187 !(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

188 
m
->
cs
, m->
ù
);

190 i‡(
m
->
cs
 =
__KERNEL_CS
)

191 
	`¥öt_symbﬁ
("{%s}", 
m
->
ù
);

192 
	`¥_c⁄t
("\n");

195 
	`¥_emîg
("TSC %Œx ", 
m
->
tsc
);

196 i‡(
m
->
addr
)

197 
	`¥_c⁄t
("ADDR %Œx ", 
m
->
addr
);

198 i‡(
m
->
misc
)

199 
	`¥_c⁄t
("MISC %Œx ", 
m
->
misc
);

201 
	`¥_c⁄t
("\n");

202 
	`¥_emîg
("PROCESSOR %u:%x TIME %llu SOCKET %u APIC %x\n",

203 
m
->
˝uvíd‹
, m->
˝uid
, m->
time
, m->
sockëid
, m->
≠icid
);

209 
	`x86_m˚_decode_ˇŒback
(
m
);

210 
	}
}

212 
	$¥öt_m˚_hód
()

214 
	`¥_emîg
("\nHARDWARE ERROR\n");

215 
	}
}

217 
	$¥öt_m˚_èû
()

219 
	`¥_emîg
("This isÇotá softwareÖroblem!\n");

220 
	}
}

222 
	#PANIC_TIMEOUT
 5

	)

224 
©omic_t
 
	gm˚_∑ni˚d
;

226 
	gÁke_∑nic
;

227 
©omic_t
 
	gm˚_Áke_∑ni˚d
;

230 
	$waô_f‹_∑nic
()

232 
timeout
 = 
PANIC_TIMEOUT
*
USEC_PER_SEC
;

234 
	`¥ìm±_dißbÀ
();

235 
	`loˇl_úq_íabÀ
();

236 
timeout
-- > 0)

237 
	`udñay
(1);

238 i‡(
∑nic_timeout
 == 0)

239 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

240 
	`∑nic
("Panicing machine check CPU died");

241 
	}
}

243 
	$m˚_∑nic
(*
msg
, 
m˚
 *
föÆ
, *
exp
)

245 
i
;

247 i‡(!
Áke_∑nic
) {

251 i‡(
	`©omic_öc_ªtu∫
(&
m˚_∑ni˚d
) > 1)

252 
	`waô_f‹_∑nic
();

253 
	`b¨rõr
();

255 
	`bu°_•ölocks
(1);

256 
	`c⁄sﬁe_vîbo£
();

259 i‡(
	`©omic_öc_ªtu∫
(&
m˚_Áke_∑ni˚d
) > 1)

262 
	`¥öt_m˚_hód
();

264 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

265 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

266 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

268 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

269 
	`¥öt_m˚
(
m
);

272 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

273 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

274 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

276 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

278 i‡(!
föÆ
 || 
	`memcmp
(
m
, föÆ, (
m˚
)))

279 
	`¥öt_m˚
(
m
);

281 i‡(
föÆ
)

282 
	`¥öt_m˚
(
föÆ
);

283 i‡(
˝u_missög
)

284 
	`¥ötk
(
KERN_EMERG
 "Some CPUs didn'tánswer in synchronization\n");

285 
	`¥öt_m˚_èû
();

286 i‡(
exp
)

287 
	`¥ötk
(
KERN_EMERG
 "Machöêcheck: %s\n", 
exp
);

288 i‡(!
Áke_∑nic
) {

289 i‡(
∑nic_timeout
 == 0)

290 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

291 
	`∑nic
(
msg
);

293 
	`¥ötk
(
KERN_EMERG
 "Fakêkî√»∑nic: %s\n", 
msg
);

294 
	}
}

298 
	$m§_to_off£t
(
u32
 
m§
)

300 
b™k
 = 
	`__gë_˝u_v¨
(
öje˘m
.bank);

302 i‡(
m§
 =
rù_m§
)

303  
	`off£tof
(
m˚
, 
ù
);

304 i‡(
m§
 =
	`MSR_IA32_MCx_STATUS
(
b™k
))

305  
	`off£tof
(
m˚
, 
°©us
);

306 i‡(
m§
 =
	`MSR_IA32_MCx_ADDR
(
b™k
))

307  
	`off£tof
(
m˚
, 
addr
);

308 i‡(
m§
 =
	`MSR_IA32_MCx_MISC
(
b™k
))

309  
	`off£tof
(
m˚
, 
misc
);

310 i‡(
m§
 =
MSR_IA32_MCG_STATUS
)

311  
	`off£tof
(
m˚
, 
mcg°©us
);

313 
	}
}

316 
u64
 
	$m˚_rdm§l
(
u32
 
m§
)

318 
u64
 
v
;

320 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

321 
off£t
 = 
	`m§_to_off£t
(
m§
);

323 i‡(
off£t
 < 0)

325  *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
);

328 i‡(
	`rdm§l_ß„
(
m§
, &
v
)) {

329 
	`WARN_ONCE
(1, "m˚: U«bÀÅÿªad m§ %d!\n", 
m§
);

335 
v
 = 0;

338  
v
;

339 
	}
}

341 
	$m˚_wrm§l
(
u32
 
m§
, 
u64
 
v
)

343 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

344 
off£t
 = 
	`m§_to_off£t
(
m§
);

346 i‡(
off£t
 >= 0)

347 *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
Ë
v
;

350 
	`wrm§l
(
m§
, 
v
);

351 
	}
}

358 
	#MCE_RING_SIZE
 16

	)

360 
	sm˚_rög
 {

361 
	m°¨t
;

362 
	míd
;

363 
	mrög
[
MCE_RING_SIZE
];

365 
DEFINE_PER_CPU
(
m˚_rög
, mce_ring);

368 
	$m˚_rög_em±y
()

370 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

372  
r
->
°¨t
 =r->
íd
;

373 
	}
}

375 
	$m˚_rög_gë
(*
p‚
)

377 
m˚_rög
 *
r
;

378 
ªt
 = 0;

380 *
p‚
 = 0;

381 
	`gë_˝u
();

382 
r
 = &
	`__gë_˝u_v¨
(
m˚_rög
);

383 i‡(
r
->
°¨t
 =r->
íd
)

384 
out
;

385 *
p‚
 = 
r
->
rög
[r->
°¨t
];

386 
r
->
°¨t
 = (r->°¨à+ 1Ë% 
MCE_RING_SIZE
;

387 
ªt
 = 1;

388 
out
:

389 
	`put_˝u
();

390  
ªt
;

391 
	}
}

394 
	$m˚_rög_add
(
p‚
)

396 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

397 
√xt
;

399 
√xt
 = (
r
->
íd
 + 1Ë% 
MCE_RING_SIZE
;

400 i‡(
√xt
 =
r
->
°¨t
)

402 
r
->
rög
[r->
íd
] = 
p‚
;

403 
	`wmb
();

404 
r
->
íd
 = 
√xt
;

406 
	}
}

408 
	$m˚_avaûabÀ
(
˝uöfo_x86
 *
c
)

410 i‡(
m˚_dißbÀd
)

412  
	`˝u_has
(
c
, 
X86_FEATURE_MCE
Ë&& cpu_has(c, 
X86_FEATURE_MCA
);

413 
	}
}

415 
	$m˚_scheduÀ_w‹k
()

417 i‡(!
	`m˚_rög_em±y
()) {

418 
w‹k_°ru˘
 *
w‹k
 = &
	`__gë_˝u_v¨
(
m˚_w‹k
);

419 i‡(!
	`w‹k_≥ndög
(
w‹k
))

420 
	`scheduÀ_w‹k
(
w‹k
);

422 
	}
}

428 
ölöe
 
	$m˚_gë_rù
(
m˚
 *
m
, 
±_ªgs
 *
ªgs
)

431 i‡(
ªgs
 && (
m
->
mcg°©us
 & (
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
))) {

432 
m
->
ù
 = 
ªgs
->ip;

433 
m
->
cs
 = 
ªgs
->cs;

435 
m
->
ù
 = 0;

436 
m
->
cs
 = 0;

438 i‡(
rù_m§
)

439 
m
->
ù
 = 
	`m˚_rdm§l
(
rù_m§
);

440 
	}
}

442 #ifde‡
CONFIG_X86_LOCAL_APIC


448 
asmlökage
 
	$smp_m˚_£lf_öãºu±
(
±_ªgs
 *
ªgs
)

450 
	`ack_APIC_úq
();

451 
	`exô_idÀ
();

452 
	`úq_íãr
();

453 
	`m˚_nŸify_úq
();

454 
	`m˚_scheduÀ_w‹k
();

455 
	`úq_exô
();

456 
	}
}

459 
	$m˚_ªp‹t_evít
(
±_ªgs
 *
ªgs
)

461 i‡(
ªgs
->
Êags
 & (
X86_VM_MASK
|
X86_EFLAGS_IF
)) {

462 
	`m˚_nŸify_úq
();

469 
	`m˚_scheduÀ_w‹k
();

473 #ifde‡
CONFIG_X86_LOCAL_APIC


478 i‡(!
˝u_has_≠ic
)

487 
≠ic
->
	`£nd_IPI_£lf
(
MCE_SELF_VECTOR
);

494 
	`≠ic_waô_i¸_idÀ
();

496 
	}
}

498 
DEFINE_PER_CPU
(, 
m˚_pﬁl_cou¡
);

515 
	$machöe_check_pﬁl
(
m˝_Êags
 
Êags
, 
m˚_b™ks_t
 *
b
)

517 
m˚
 
m
;

518 
i
;

520 
	`__gë_˝u_v¨
(
m˚_pﬁl_cou¡
)++;

522 
	`m˚_£tup
(&
m
);

524 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

525 
i
 = 0; i < 
b™ks
; i++) {

526 i‡(!
m˚_b™ks
[
i
].
˘l
 || !
	`ã°_bô
(i, *
b
))

529 
m
.
misc
 = 0;

530 
m
.
addr
 = 0;

531 
m
.
b™k
 = 
i
;

532 
m
.
tsc
 = 0;

534 
	`b¨rõr
();

535 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

536 i‡(!(
m
.
°©us
 & 
MCI_STATUS_VAL
))

545 i‡(!(
Êags
 & 
MCP_UC
) &&

546 (
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)))

549 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

550 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

551 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

552 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

554 i‡(!(
Êags
 & 
MCP_TIMESTAMP
))

555 
m
.
tsc
 = 0;

560 i‡(!(
Êags
 & 
MCP_DONTLOG
Ë&& !
m˚_d⁄t_log_˚
) {

561 
	`m˚_log
(&
m
);

562 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

568 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

576 
	`sync_c‹e
();

577 
	}
}

578 
EXPORT_SYMBOL_GPL
(
machöe_check_pﬁl
);

584 
	$m˚_no_way_out
(
m˚
 *
m
, **
msg
)

586 
i
;

588 
i
 = 0; i < 
b™ks
; i++) {

589 
m
->
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

590 i‡(
	`m˚_£vîôy
(
m
, 
tﬁî™t
, 
msg
Ë>
MCE_PANIC_SEVERITY
)

594 
	}
}

600 
©omic_t
 
	gm˚_executög
;

605 
©omic_t
 
	gm˚_ˇŒö
;

610 
	$m˚_timed_out
(
u64
 *
t
)

618 
	`rmb
();

619 i‡(
	`©omic_ªad
(&
m˚_∑ni˚d
))

620 
	`waô_f‹_∑nic
();

621 i‡(!
m⁄¨ch_timeout
)

622 
out
;

623 i‡((
s64
)*
t
 < 
SPINUNIT
) {

625 i‡(
tﬁî™t
 < 1)

626 
	`m˚_∑nic
("Timeout synchronizing machine check over CPUs",

627 
NULL
, NULL);

628 
˝u_missög
 = 1;

631 *
t
 -
SPINUNIT
;

632 
out
:

633 
	`touch_nmi_w©chdog
();

635 
	}
}

661 
	$m˚_ªign
()

663 
˝u
;

664 
m˚
 *
m
 = 
NULL
;

665 
globÆ_w‹°
 = 0;

666 *
msg
 = 
NULL
;

667 *
nmsg
 = 
NULL
;

674 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

675 
£vîôy
 = 
	`m˚_£vîôy
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 
tﬁî™t
,

676 &
nmsg
);

677 i‡(
£vîôy
 > 
globÆ_w‹°
) {

678 
msg
 = 
nmsg
;

679 
globÆ_w‹°
 = 
£vîôy
;

680 
m
 = &
	`≥r_˝u
(
m˚s_£í
, 
˝u
);

689 i‡(
m
 && 
globÆ_w‹°
 >
MCE_PANIC_SEVERITY
 && 
tﬁî™t
 < 3)

690 
	`m˚_∑nic
("F©Æ Machöêcheck", 
m
, 
msg
);

702 i‡(
globÆ_w‹°
 <
MCE_KEEP_SEVERITY
 && 
tﬁî™t
 < 3)

703 
	`m˚_∑nic
("Machöêcheck from unknow¿sour˚", 
NULL
, NULL);

709 
	`f‹_óch_possibÀ_˝u
(
˝u
)

710 
	`mem£t
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 0, (
m˚
));

711 
	}
}

713 
©omic_t
 
	gglobÆ_nwo
;

722 
	$m˚_°¨t
(*
no_way_out
)

724 
‹dî
;

725 
˝us
 = 
	`num_⁄löe_˝us
();

726 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

728 i‡(!
timeout
)

731 
	`©omic_add
(*
no_way_out
, &
globÆ_nwo
);

735 
	`smp_wmb
();

736 
‹dî
 = 
	`©omic_öc_ªtu∫
(&
m˚_ˇŒö
);

741 
	`©omic_ªad
(&
m˚_ˇŒö
Ë!
˝us
) {

742 i‡(
	`m˚_timed_out
(&
timeout
)) {

743 
	`©omic_£t
(&
globÆ_nwo
, 0);

746 
	`ndñay
(
SPINUNIT
);

752 
	`smp_rmb
();

754 i‡(
‹dî
 == 1) {

758 
	`©omic_£t
(&
m˚_executög
, 1);

766 
	`©omic_ªad
(&
m˚_executög
Ë< 
‹dî
) {

767 i‡(
	`m˚_timed_out
(&
timeout
)) {

768 
	`©omic_£t
(&
globÆ_nwo
, 0);

771 
	`ndñay
(
SPINUNIT
);

778 *
no_way_out
 = 
	`©omic_ªad
(&
globÆ_nwo
);

780  
‹dî
;

781 
	}
}

787 
	$m˚_íd
(
‹dî
)

789 
ªt
 = -1;

790 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

792 i‡(!
timeout
)

793 
ª£t
;

794 i‡(
‹dî
 < 0)

795 
ª£t
;

800 
	`©omic_öc
(&
m˚_executög
);

802 i‡(
‹dî
 == 1) {

804 
˝us
 = 
	`num_⁄löe_˝us
();

810 
	`©omic_ªad
(&
m˚_executög
Ë<
˝us
) {

811 i‡(
	`m˚_timed_out
(&
timeout
))

812 
ª£t
;

813 
	`ndñay
(
SPINUNIT
);

816 
	`m˚_ªign
();

817 
	`b¨rõr
();

818 
ªt
 = 0;

823 
	`©omic_ªad
(&
m˚_executög
) != 0) {

824 i‡(
	`m˚_timed_out
(&
timeout
))

825 
ª£t
;

826 
	`ndñay
(
SPINUNIT
);

838 
ª£t
:

839 
	`©omic_£t
(&
globÆ_nwo
, 0);

840 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

841 
	`b¨rõr
();

846 
	`©omic_£t
(&
m˚_executög
, 0);

847  
ªt
;

848 
	}
}

856 
	$m˚_ußbÀ_addªss
(
m˚
 *
m
)

858 i‡(!(
m
->
°©us
 & 
MCI_STATUS_MISCV
Ë|| !(m->°©u†& 
MCI_STATUS_ADDRV
))

860 i‡((
m
->
misc
 & 0x3fË> 
PAGE_SHIFT
)

862 i‡(((
m
->
misc
 >> 6Ë& 7Ë!
MCM_ADDR_PHYS
)

865 
	}
}

867 
	$m˚_˛ór_°©e
(*
to˛ór
)

869 
i
;

871 
i
 = 0; i < 
b™ks
; i++) {

872 i‡(
	`ã°_bô
(
i
, 
to˛ór
))

873 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

875 
	}
}

889 
	$do_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

891 
m˚
 
m
, *
föÆ
;

892 
i
;

893 
w‹°
 = 0;

894 
£vîôy
;

899 
‹dî
;

904 
no_way_out
 = 0;

909 
kûl_ô
 = 0;

910 
	`DECLARE_BITMAP
(
to˛ór
, 
MAX_NR_BANKS
);

911 *
msg
 = "Unknown";

913 
	`©omic_öc
(&
m˚_íåy
);

915 
	`__gë_˝u_v¨
(
m˚_ex˚±i⁄_cou¡
)++;

917 i‡(
	`nŸify_dõ
(
DIE_NMI
, "machöêcheck", 
ªgs
, 
îr‹_code
,

918 18, 
SIGKILL
Ë=
NOTIFY_STOP
)

919 
out
;

920 i‡(!
b™ks
)

921 
out
;

923 
	`m˚_£tup
(&
m
);

925 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

926 
föÆ
 = &
	`__gë_˝u_v¨
(
m˚s_£í
);

927 *
föÆ
 = 
m
;

929 
no_way_out
 = 
	`m˚_no_way_out
(&
m
, &
msg
);

931 
	`b¨rõr
();

936 i‡(!(
m
.
mcg°©us
 & 
MCG_STATUS_RIPV
))

937 
kûl_ô
 = 1;

944 
‹dî
 = 
	`m˚_°¨t
(&
no_way_out
);

945 
i
 = 0; i < 
b™ks
; i++) {

946 
	`__˛ór_bô
(
i
, 
to˛ór
);

947 i‡(!
m˚_b™ks
[
i
].
˘l
)

950 
m
.
misc
 = 0;

951 
m
.
addr
 = 0;

952 
m
.
b™k
 = 
i
;

954 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

955 i‡((
m
.
°©us
 & 
MCI_STATUS_VAL
) == 0)

962 i‡(!(
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)) &&

963 !
no_way_out
)

969 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

971 
£vîôy
 = 
	`m˚_£vîôy
(&
m
, 
tﬁî™t
, 
NULL
);

977 i‡(
£vîôy
 =
MCE_KEEP_SEVERITY
 && !
no_way_out
)

979 
	`__£t_bô
(
i
, 
to˛ór
);

980 i‡(
£vîôy
 =
MCE_NO_SEVERITY
) {

991 i‡(
£vîôy
 =
MCE_AR_SEVERITY
)

992 
kûl_ô
 = 1;

994 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

995 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

996 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

997 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

1006 i‡(
£vîôy
 =
MCE_AO_SEVERITY
 && 
	`m˚_ußbÀ_addªss
(&
m
))

1007 
	`m˚_rög_add
(
m
.
addr
 >> 
PAGE_SHIFT
);

1009 
	`m˚_gë_rù
(&
m
, 
ªgs
);

1010 
	`m˚_log
(&
m
);

1012 i‡(
£vîôy
 > 
w‹°
) {

1013 *
föÆ
 = 
m
;

1014 
w‹°
 = 
£vîôy
;

1018 i‡(!
no_way_out
)

1019 
	`m˚_˛ór_°©e
(
to˛ór
);

1025 i‡(
	`m˚_íd
(
‹dî
) < 0)

1026 
no_way_out
 = 
w‹°
 >
MCE_PANIC_SEVERITY
;

1035 i‡(
no_way_out
 && 
tﬁî™t
 < 3)

1036 
	`m˚_∑nic
("F©Æ machöêcheck o¿cuºíàCPU", 
föÆ
, 
msg
);

1045 i‡(
kûl_ô
 && 
tﬁî™t
 < 3)

1046 
	`f‹˚_sig
(
SIGBUS
, 
cuºít
);

1049 
	`£t_thªad_Êag
(
TIF_MCE_NOTIFY
);

1051 i‡(
w‹°
 > 0)

1052 
	`m˚_ªp‹t_evít
(
ªgs
);

1053 
	`m˚_wrm§l
(
MSR_IA32_MCG_STATUS
, 0);

1054 
out
:

1055 
	`©omic_dec
(&
m˚_íåy
);

1056 
	`sync_c‹e
();

1057 
	}
}

1058 
EXPORT_SYMBOL_GPL
(
do_machöe_check
);

1061 
__©åibuã__
((
wók
)Ë
	$mem‹y_Áûuª
(
p‚
, 
ve˘‹
)

1063 
	`¥ötk
(
KERN_ERR
 "A˘i⁄ o±i⁄Æ mem‹y faûuªáà%lx ign‹ed\n", 
p‚
);

1064 
	}
}

1077 
	$m˚_nŸify_¥o˚ss
()

1079 
p‚
;

1080 
	`m˚_nŸify_úq
();

1081 
	`m˚_rög_gë
(&
p‚
))

1082 
	`mem‹y_Áûuª
(
p‚
, 
MCE_VECTOR
);

1083 
	}
}

1085 
	$m˚_¥o˚ss_w‹k
(
w‹k_°ru˘
 *
dummy
)

1087 
	`m˚_nŸify_¥o˚ss
();

1088 
	}
}

1090 #ifde‡
CONFIG_X86_MCE_INTEL


1104 
	$m˚_log_thîm_thrŸ_evít
(
__u64
 
°©us
)

1106 
m˚
 
m
;

1108 
	`m˚_£tup
(&
m
);

1109 
m
.
b™k
 = 
MCE_THERMAL_BANK
;

1110 
m
.
°©us
 = status;

1111 
	`m˚_log
(&
m
);

1112 
	}
}

1120 
	gcheck_öãrvÆ
 = 5 * 60;

1122 
DEFINE_PER_CPU
(, 
m˚_√xt_öãrvÆ
);

1123 
DEFINE_PER_CPU
(
timî_li°
, 
m˚_timî
);

1125 
	$mcheck_timî
(
d©a
)

1127 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
d©a
);

1128 *
n
;

1130 
	`WARN_ON
(
	`smp_¥o˚ss‹_id
(Ë!
d©a
);

1132 i‡(
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
)) {

1133 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

1134 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

1141 
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1142 i‡(
	`m˚_nŸify_úq
())

1143 *
n
 = 
	`max
(*n/2, 
HZ
/100);

1145 *
n
 = 
	`mö
(*n*2, ()
	`round_jiffõs_ªœtive
(
check_öãrvÆ
*
HZ
));

1147 
t
->
expúes
 = 
jiffõs
 + *
n
;

1148 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1149 
	}
}

1151 
	$m˚_do_åiggî
(
w‹k_°ru˘
 *
w‹k
)

1153 
	`ˇŒ_u£rmodehñ≥r
(
m˚_hñ≥r
, 
m˚_hñ≥r_¨gv
, 
NULL
, 
UMH_NO_WAIT
);

1154 
	}
}

1156 
DECLARE_WORK
(
m˚_åiggî_w‹k
, 
m˚_do_åiggî
);

1163 
	$m˚_nŸify_úq
()

1166 
	`DEFINE_RATELIMIT_STATE
(
øãlimô
, 60*
HZ
, 2);

1168 
	`˛ór_thªad_Êag
(
TIF_MCE_NOTIFY
);

1170 i‡(
	`ã°_™d_˛ór_bô
(0, &
m˚_√ed_nŸify
)) {

1171 
	`wake_up_öãºu±ibÀ
(&
m˚_waô
);

1178 i‡(
m˚_hñ≥r
[0] && !
	`w‹k_≥ndög
(&
m˚_åiggî_w‹k
))

1179 
	`scheduÀ_w‹k
(&
m˚_åiggî_w‹k
);

1181 i‡(
	`__øãlimô
(&
øãlimô
))

1182 
	`¥ötk
(
KERN_INFO
 "Machine checkÉventsÜogged\n");

1187 
	}
}

1188 
EXPORT_SYMBOL_GPL
(
m˚_nŸify_úq
);

1190 
	$m˚_b™ks_öô
()

1192 
i
;

1194 
m˚_b™ks
 = 
	`kzÆloc
(
b™ks
 * (
m˚_b™k
), 
GFP_KERNEL
);

1195 i‡(!
m˚_b™ks
)

1196  -
ENOMEM
;

1197 
i
 = 0; i < 
b™ks
; i++) {

1198 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1200 
b
->
˘l
 = -1ULL;

1201 
b
->
öô
 = 1;

1204 
	}
}

1209 
__˝uöô
 
	$m˚_ˇp_öô
()

1211 
b
;

1212 
u64
 
ˇp
;

1214 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1216 
b
 = 
ˇp
 & 
MCG_BANKCNT_MASK
;

1217 i‡(!
b™ks
)

1218 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
b
);

1220 i‡(
b
 > 
MAX_NR_BANKS
) {

1221 
	`¥ötk
(
KERN_WARNING


1223 
MAX_NR_BANKS
, 
b
);

1224 
b
 = 
MAX_NR_BANKS
;

1228 
	`WARN_ON
(
b™ks
 !0 && 
b
 != banks);

1229 
b™ks
 = 
b
;

1230 i‡(!
m˚_b™ks
) {

1231 
îr
 = 
	`m˚_b™ks_öô
();

1233 i‡(
îr
)

1234  
îr
;

1238 i‡((
ˇp
 & 
MCG_EXT_P
Ë&& 
	`MCG_EXT_CNT
(cap) >= 9)

1239 
rù_m§
 = 
MSR_IA32_MCG_EIP
;

1241 i‡(
ˇp
 & 
MCG_SER_P
)

1242 
m˚_£r
 = 1;

1245 
	}
}

1247 
	$m˚_öô
()

1249 
m˚_b™ks_t
 
Æl_b™ks
;

1250 
u64
 
ˇp
;

1251 
i
;

1256 
	`bôm≠_fûl
(
Æl_b™ks
, 
MAX_NR_BANKS
);

1257 
	`machöe_check_pﬁl
(
MCP_UC
|(!
m˚_boŸlog
 ? 
MCP_DONTLOG
 : 0), &
Æl_b™ks
);

1259 
	`£t_ö_¸4
(
X86_CR4_MCE
);

1261 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1262 i‡(
ˇp
 & 
MCG_CTL_P
)

1263 
	`wrm§
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

1265 
i
 = 0; i < 
b™ks
; i++) {

1266 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1268 i‡(!
b
->
öô
)

1270 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1271 
	`wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

1273 
	}
}

1276 
__˝uöô
 
	$m˚_˝u_quúks
(
˝uöfo_x86
 *
c
)

1278 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_UNKNOWN
) {

1279 
	`¥_öfo
("MCE: unknown CPUÅype -ÇotÉnabling MCE support.\n");

1280  -
EOPNOTSUPP
;

1284 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
) {

1285 i‡(
c
->
x86
 =15 && 
b™ks
 > 4) {

1291 
	`˛ór_bô
(10, (*)&
m˚_b™ks
[4].
˘l
);

1293 i‡(
c
->
x86
 <17 && 
m˚_boŸlog
 < 0) {

1298 
m˚_boŸlog
 = 0;

1304 i‡(
c
->
x86
 =6 && 
b™ks
 > 0)

1305 
m˚_b™ks
[0].
˘l
 = 0;

1308 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

1318 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 0x1A && 
b™ks
 > 0)

1319 
m˚_b™ks
[0].
öô
 = 0;

1325 i‡((
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xe)) &&

1326 
m⁄¨ch_timeout
 < 0)

1327 
m⁄¨ch_timeout
 = 
USEC_PER_SEC
;

1333 i‡(
c
->
x86
 =6 && c->
x86_modñ
 <13 && 
m˚_boŸlog
 < 0)

1334 
m˚_boŸlog
 = 0;

1336 i‡(
m⁄¨ch_timeout
 < 0)

1337 
m⁄¨ch_timeout
 = 0;

1338 i‡(
m˚_boŸlog
 != 0)

1339 
m˚_∑nic_timeout
 = 30;

1342 
	}
}

1344 
__˝uöô
 
	$m˚_™cõ¡_öô
(
˝uöfo_x86
 *
c
)

1346 i‡(
c
->
x86
 != 5)

1348 
c
->
x86_víd‹
) {

1349 
X86_VENDOR_INTEL
:

1350 
	`öãl_p5_mcheck_öô
(
c
);

1352 
X86_VENDOR_CENTAUR
:

1353 
	`wöchù_mcheck_öô
(
c
);

1356 
	}
}

1358 
	$m˚_˝u_„©uªs
(
˝uöfo_x86
 *
c
)

1360 
c
->
x86_víd‹
) {

1361 
X86_VENDOR_INTEL
:

1362 
	`m˚_öãl_„©uª_öô
(
c
);

1364 
X86_VENDOR_AMD
:

1365 
	`m˚_amd_„©uª_öô
(
c
);

1370 
	}
}

1372 
	$m˚_öô_timî
()

1374 
timî_li°
 *
t
 = &
	`__gë_˝u_v¨
(
m˚_timî
);

1375 *
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1377 i‡(
m˚_ign‹e_˚
)

1380 *
n
 = 
check_öãrvÆ
 * 
HZ
;

1381 i‡(!*
n
)

1383 
	`£tup_timî
(
t
, 
mcheck_timî
, 
	`smp_¥o˚ss‹_id
());

1384 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 + *
n
);

1385 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1386 
	}
}

1389 
	$u√x≥˘ed_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

1391 
	`¥ötk
(
KERN_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

1392 
	`smp_¥o˚ss‹_id
());

1393 
	}
}

1396 (*
machöe_check_ve˘‹
)(
±_ªgs
 *, 
îr‹_code
) =

1397 
u√x≥˘ed_machöe_check
;

1403 
__˝uöô
 
	$mcheck_öô
(
˝uöfo_x86
 *
c
)

1405 i‡(
m˚_dißbÀd
)

1408 
	`m˚_™cõ¡_öô
(
c
);

1410 i‡(!
	`m˚_avaûabÀ
(
c
))

1413 i‡(
	`m˚_ˇp_öô
(Ë< 0 || 
	`m˚_˝u_quúks
(
c
) < 0) {

1414 
m˚_dißbÀd
 = 1;

1418 
machöe_check_ve˘‹
 = 
do_machöe_check
;

1420 
	`m˚_öô
();

1421 
	`m˚_˝u_„©uªs
(
c
);

1422 
	`m˚_öô_timî
();

1423 
	`INIT_WORK
(&
	`__gë_˝u_v¨
(
m˚_w‹k
), 
m˚_¥o˚ss_w‹k
);

1424 
	}
}

1430 
DEFINE_SPINLOCK
(
m˚_°©e_lock
);

1431 
	g›í_cou¡
;

1432 
	g›í_ex˛u
;

1434 
	$m˚_›í
(
öode
 *öode, 
fûe
 *file)

1436 
	`•ö_lock
(&
m˚_°©e_lock
);

1438 i‡(
›í_ex˛u
 || (
›í_cou¡
 && (
fûe
->
f_Êags
 & 
O_EXCL
))) {

1439 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1441  -
EBUSY
;

1444 i‡(
fûe
->
f_Êags
 & 
O_EXCL
)

1445 
›í_ex˛u
 = 1;

1446 
›í_cou¡
++;

1448 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1450  
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
);

1451 
	}
}

1453 
	$m˚_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1455 
	`•ö_lock
(&
m˚_°©e_lock
);

1457 
›í_cou¡
--;

1458 
›í_ex˛u
 = 0;

1460 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1463 
	}
}

1465 
	$cﬁÀ˘_tscs
(*
d©a
)

1467 *
˝u_tsc
 = (*)
d©a
;

1469 
	`rdts˛l
(
˝u_tsc
[
	`smp_¥o˚ss‹_id
()]);

1470 
	}
}

1472 
DEFINE_MUTEX
(
m˚_ªad_muãx
);

1474 
ssize_t
 
	$m˚_ªad
(
fûe
 *
fûp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

1475 
loff_t
 *
off
)

1477 
__u£r
 *
buf
 = 
ubuf
;

1478 *
˝u_tsc
;

1479 
¥ev
, 
√xt
;

1480 
i
, 
îr
;

1482 
˝u_tsc
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

1483 i‡(!
˝u_tsc
)

1484  -
ENOMEM
;

1486 
	`muãx_lock
(&
m˚_ªad_muãx
);

1487 
√xt
 = 
	`rcu_dîe„ªn˚
(
m˚log
.next);

1490 i‡(*
off
 !0 || 
usize
 < 
MCE_LOG_LEN
*(
m˚
)) {

1491 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1492 
	`k‰ì
(
˝u_tsc
);

1494  -
EINVAL
;

1497 
îr
 = 0;

1498 
¥ev
 = 0;

1500 
i
 = 
¥ev
; i < 
√xt
; i++) {

1501 
°¨t
 = 
jiffõs
;

1503 !
m˚log
.
íåy
[
i
].
föished
) {

1504 i‡(
	`time_a·î_eq
(
jiffõs
, 
°¨t
 + 2)) {

1505 
	`mem£t
(
m˚log
.
íåy
 + 
i
, 0,

1506 (
m˚
));

1507 
timeout
;

1509 
	`˝u_ªœx
();

1511 
	`smp_rmb
();

1512 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
 + 
i
,

1513 (
m˚
));

1514 
buf
 +(
m˚
);

1515 
timeout
:

1519 
	`mem£t
(
m˚log
.
íåy
 + 
¥ev
, 0,

1520 (
√xt
 - 
¥ev
Ë* (
m˚
));

1521 
¥ev
 = 
√xt
;

1522 
√xt
 = 
	`cmpxchg
(&
m˚log
.√xt, 
¥ev
, 0);

1523 } 
√xt
 !
¥ev
);

1525 
	`synchr⁄ize_sched
();

1531 
	`⁄_óch_˝u
(
cﬁÀ˘_tscs
, 
˝u_tsc
, 1);

1533 
i
 = 
√xt
; i < 
MCE_LOG_LEN
; i++) {

1534 i‡(
m˚log
.
íåy
[
i
].
föished
 &&

1535 
m˚log
.
íåy
[
i
].
tsc
 < 
˝u_tsc
[m˚log.íåy[i].
˝u
]) {

1536 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
+
i
,

1537 (
m˚
));

1538 
	`smp_rmb
();

1539 
buf
 +(
m˚
);

1540 
	`mem£t
(&
m˚log
.
íåy
[
i
], 0, (
m˚
));

1543 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1544 
	`k‰ì
(
˝u_tsc
);

1546  
îr
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

1547 
	}
}

1549 
	$m˚_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

1551 
	`pﬁl_waô
(
fûe
, &
m˚_waô
, 
waô
);

1552 i‡(
	`rcu_dîe„ªn˚
(
m˚log
.
√xt
))

1553  
POLLIN
 | 
POLLRDNORM
;

1555 
	}
}

1557 
	$m˚_io˘l
(
fûe
 *
f
, 
cmd
, 
¨g
)

1559 
__u£r
 *
p
 = (__u£∏*)
¨g
;

1561 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1562  -
EPERM
;

1564 
cmd
) {

1565 
MCE_GET_RECORD_LEN
:

1566  
	`put_u£r
((
m˚
), 
p
);

1567 
MCE_GET_LOG_LEN
:

1568  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

1569 
MCE_GETCLEAR_FLAGS
: {

1570 
Êags
;

1573 
Êags
 = 
m˚log
.flags;

1574 } 
	`cmpxchg
(&
m˚log
.
Êags
, flags, 0) != flags);

1576  
	`put_u£r
(
Êags
, 
p
);

1579  -
ENOTTY
;

1581 
	}
}

1584 
fûe_›î©i⁄s
 
	gm˚_chrdev_›s
 = {

1585 .
›í
 = 
m˚_›í
,

1586 .
	gªÀa£
 = 
m˚_ªÀa£
,

1587 .
	gªad
 = 
m˚_ªad
,

1588 .
	gpﬁl
 = 
m˚_pﬁl
,

1589 .
	gu∆ocked_io˘l
 = 
m˚_io˘l
,

1591 
EXPORT_SYMBOL_GPL
(
m˚_chrdev_›s
);

1593 
miscdevi˚
 
	gm˚_log_devi˚
 = {

1594 
MISC_MCELOG_MINOR
,

1596 &
m˚_chrdev_›s
,

1610 
__öô
 
	$mcheck_íabÀ
(*
°r
)

1612 i‡(*
°r
 == 0) {

1613 
	`íabÀ_p5_m˚
();

1616 i‡(*
°r
 == '=')

1617 
°r
++;

1618 i‡(!
	`°rcmp
(
°r
, "off"))

1619 
m˚_dißbÀd
 = 1;

1620 i‡(!
	`°rcmp
(
°r
, "no_cmci"))

1621 
m˚_cmci_dißbÀd
 = 1;

1622 i‡(!
	`°rcmp
(
°r
, "dont_log_ce"))

1623 
m˚_d⁄t_log_˚
 = 1;

1624 i‡(!
	`°rcmp
(
°r
, "ignore_ce"))

1625 
m˚_ign‹e_˚
 = 1;

1626 i‡(!
	`°rcmp
(
°r
, "bootlog") || !strcmp(str, "nobootlog"))

1627 
m˚_boŸlog
 = (
°r
[0] == 'b');

1628 i‡(
	`isdigô
(
°r
[0])) {

1629 
	`gë_›ti⁄
(&
°r
, &
tﬁî™t
);

1630 i‡(*
°r
 == ',') {

1631 ++
°r
;

1632 
	`gë_›ti⁄
(&
°r
, &
m⁄¨ch_timeout
);

1635 
	`¥ötk
(
KERN_INFO
 "mceárgument %s ignored. Please use /sys\n",

1636 
°r
);

1640 
	}
}

1641 
__£tup
("m˚", 
mcheck_íabÀ
);

1651 
	$m˚_dißbÀ
()

1653 
i
;

1655 
i
 = 0; i < 
b™ks
; i++) {

1656 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1658 i‡(
b
->
öô
)

1659 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1662 
	}
}

1664 
	$m˚_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1666  
	`m˚_dißbÀ
();

1667 
	}
}

1669 
	$m˚_shutdown
(
sys_devi˚
 *
dev
)

1671  
	`m˚_dißbÀ
();

1672 
	}
}

1679 
	$m˚_ªsume
(
sys_devi˚
 *
dev
)

1681 
	`m˚_öô
();

1682 
	`m˚_˝u_„©uªs
(&
cuºít_˝u_d©a
);

1685 
	}
}

1687 
	$m˚_˝u_ª°¨t
(*
d©a
)

1689 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1690 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1692 
	`m˚_öô
();

1693 
	`m˚_öô_timî
();

1694 
	}
}

1697 
	$m˚_ª°¨t
()

1699 
	`⁄_óch_˝u
(
m˚_˝u_ª°¨t
, 
NULL
, 1);

1700 
	}
}

1703 
	$m˚_dißbÀ_˚
(*
Æl
)

1705 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1707 i‡(
Æl
)

1708 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1709 
	`cmci_˛ór
();

1710 
	}
}

1712 
	$m˚_íabÀ_˚
(*
Æl
)

1714 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1716 
	`cmci_ªíabÀ
();

1717 
	`cmci_ªcheck
();

1718 i‡(
Æl
)

1719 
	`m˚_öô_timî
();

1720 
	}
}

1722 
sysdev_˛ass
 
	gm˚_sys˛ass
 = {

1723 .
su•íd
 = 
m˚_su•íd
,

1724 .
	gshutdown
 = 
m˚_shutdown
,

1725 .
	gªsume
 = 
m˚_ªsume
,

1726 .
	g«me
 = "machinecheck",

1729 
DEFINE_PER_CPU
(
sys_devi˚
, 
m˚_dev
);

1731 
__˝uöôd©a


1732 (*
thªshﬁd_˝u_ˇŒback
)(
a˘i⁄
, 
˝u
);

1734 
ölöe
 
m˚_b™k
 *
	$©å_to_b™k
(
sysdev_©åibuã
 *
©å
)

1736  
	`c⁄èöî_of
(
©å
, 
m˚_b™k
,áttr);

1737 
	}
}

1739 
ssize_t
 
	$show_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1740 *
buf
)

1742  
	`•rötf
(
buf
, "%Œx\n", 
	`©å_to_b™k
(
©å
)->
˘l
);

1743 
	}
}

1745 
ssize_t
 
	$£t_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1746 c⁄° *
buf
, 
size_t
 
size
)

1748 
u64
 
√w
;

1750 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1751  -
EINVAL
;

1753 
	`©å_to_b™k
(
©å
)->
˘l
 = 
√w
;

1754 
	`m˚_ª°¨t
();

1756  
size
;

1757 
	}
}

1759 
ssize_t


1760 
	$show_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
, *
buf
)

1762 
	`°r˝y
(
buf
, 
m˚_hñ≥r
);

1763 
	`°rˇt
(
buf
, "\n");

1764  
	`°æí
(
m˚_hñ≥r
) + 1;

1765 
	}
}

1767 
ssize_t
 
	$£t_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1768 c⁄° *
buf
, 
size_t
 
siz
)

1770 *
p
;

1772 
	`°∫˝y
(
m˚_hñ≥r
, 
buf
, (mce_helper));

1773 
m˚_hñ≥r
[(mce_helper)-1] = 0;

1774 
p
 = 
	`°rchr
(
m˚_hñ≥r
, '\n');

1776 i‡(
p
)

1777 *
p
 = 0;

1779  
	`°æí
(
m˚_hñ≥r
Ë+ !!
p
;

1780 
	}
}

1782 
ssize_t
 
	$£t_ign‹e_˚
(
sys_devi˚
 *
s
,

1783 
sysdev_©åibuã
 *
©å
,

1784 c⁄° *
buf
, 
size_t
 
size
)

1786 
u64
 
√w
;

1788 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1789  -
EINVAL
;

1791 i‡(
m˚_ign‹e_˚
 ^ !!
√w
) {

1792 i‡(
√w
) {

1794 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, (*)1, 1);

1795 
m˚_ign‹e_˚
 = 1;

1798 
m˚_ign‹e_˚
 = 0;

1799 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, (*)1, 1);

1802  
size
;

1803 
	}
}

1805 
ssize_t
 
	$£t_cmci_dißbÀd
(
sys_devi˚
 *
s
,

1806 
sysdev_©åibuã
 *
©å
,

1807 c⁄° *
buf
, 
size_t
 
size
)

1809 
u64
 
√w
;

1811 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1812  -
EINVAL
;

1814 i‡(
m˚_cmci_dißbÀd
 ^ !!
√w
) {

1815 i‡(
√w
) {

1817 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, 
NULL
, 1);

1818 
m˚_cmci_dißbÀd
 = 1;

1821 
m˚_cmci_dißbÀd
 = 0;

1822 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, 
NULL
, 1);

1825  
size
;

1826 
	}
}

1828 
ssize_t
 
	$°‹e_öt_wôh_ª°¨t
(
sys_devi˚
 *
s
,

1829 
sysdev_©åibuã
 *
©å
,

1830 c⁄° *
buf
, 
size_t
 
size
)

1832 
ssize_t
 
ªt
 = 
	`sysdev_°‹e_öt
(
s
, 
©å
, 
buf
, 
size
);

1833 
	`m˚_ª°¨t
();

1834  
ªt
;

1835 
	}
}

1837 
SYSDEV_ATTR
(
åiggî
, 0644, 
show_åiggî
, 
£t_åiggî
);

1838 
SYSDEV_INT_ATTR
(
tﬁî™t
, 0644,Åolerant);

1839 
SYSDEV_INT_ATTR
(
m⁄¨ch_timeout
, 0644, monarch_timeout);

1840 
SYSDEV_INT_ATTR
(
d⁄t_log_˚
, 0644, 
m˚_d⁄t_log_˚
);

1842 
sysdev_ext_©åibuã
 
	g©å_check_öãrvÆ
 = {

1843 
_SYSDEV_ATTR
(
check_öãrvÆ
, 0644, 
sysdev_show_öt
,

1844 
°‹e_öt_wôh_ª°¨t
),

1845 &
check_öãrvÆ


1848 
sysdev_ext_©åibuã
 
	g©å_ign‹e_˚
 = {

1849 
_SYSDEV_ATTR
(
ign‹e_˚
, 0644, 
sysdev_show_öt
, 
£t_ign‹e_˚
),

1850 &
m˚_ign‹e_˚


1853 
sysdev_ext_©åibuã
 
	g©å_cmci_dißbÀd
 = {

1854 
_SYSDEV_ATTR
(
cmci_dißbÀd
, 0644, 
sysdev_show_öt
, 
£t_cmci_dißbÀd
),

1855 &
m˚_cmci_dißbÀd


1858 
sysdev_©åibuã
 *
	gm˚_©ås
[] = {

1859 &
©å_tﬁî™t
.
©å
,

1860 &
©å_check_öãrvÆ
.
©å
,

1861 &
©å_åiggî
,

1862 &
©å_m⁄¨ch_timeout
.
©å
,

1863 &
©å_d⁄t_log_˚
.
©å
,

1864 &
©å_ign‹e_˚
.
©å
,

1865 &
©å_cmci_dißbÀd
.
©å
,

1866 
NULL


1869 
˝umask_v¨_t
 
	gm˚_dev_öôülized
;

1872 
__˝uöô
 
	$m˚_¸óã_devi˚
(
˝u
)

1874 
îr
;

1875 
i
, 
j
;

1877 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1878  -
EIO
;

1880 
	`mem£t
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 0, (
kobje˘
));

1881 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
id
 = cpu;

1882 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
˛s
 = &
m˚_sys˛ass
;

1884 
îr
 = 
	`sysdev_ªgi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1885 i‡(
îr
)

1886  
îr
;

1888 
i
 = 0; 
m˚_©ås
[i]; i++) {

1889 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1890 i‡(
îr
)

1891 
îr‹
;

1893 
j
 = 0; j < 
b™ks
; j++) {

1894 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
),

1895 &
m˚_b™ks
[
j
].
©å
);

1896 i‡(
îr
)

1897 
îr‹2
;

1899 
	`˝umask_£t_˝u
(
˝u
, 
m˚_dev_öôülized
);

1902 
îr‹2
:

1903 --
j
 >= 0)

1904 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
j
].
©å
);

1905 
îr‹
:

1906 --
i
 >= 0)

1907 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
i
].
©å
);

1909 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1911  
îr
;

1912 
	}
}

1914 
__˝uöô
 
	$m˚_ªmove_devi˚
(
˝u
)

1916 
i
;

1918 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
m˚_dev_öôülized
))

1921 
i
 = 0; 
m˚_©ås
[i]; i++)

1922 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1924 
i
 = 0; i < 
b™ks
; i++)

1925 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
i
].
©å
);

1927 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1928 
	`˝umask_˛ór_˝u
(
˝u
, 
m˚_dev_öôülized
);

1929 
	}
}

1932 
	$m˚_dißbÀ_˝u
(*
h
)

1934 
a˘i⁄
 = *(*)
h
;

1935 
i
;

1937 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1939 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1940 
	`cmci_˛ór
();

1941 
i
 = 0; i < 
b™ks
; i++) {

1942 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1944 i‡(
b
->
öô
)

1945 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1947 
	}
}

1949 
	$m˚_ªíabÀ_˝u
(*
h
)

1951 
a˘i⁄
 = *(*)
h
;

1952 
i
;

1954 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1957 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

1958 
	`cmci_ªíabÀ
();

1959 
i
 = 0; i < 
b™ks
; i++) {

1960 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1962 i‡(
b
->
öô
)

1963 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1965 
	}
}

1968 
__˝uöô


1969 
	$m˚_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
, *
h˝u
)

1971 
˝u
 = ()
h˝u
;

1972 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
˝u
);

1974 
a˘i⁄
) {

1975 
CPU_ONLINE
:

1976 
CPU_ONLINE_FROZEN
:

1977 
	`m˚_¸óã_devi˚
(
˝u
);

1978 i‡(
thªshﬁd_˝u_ˇŒback
)

1979 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

1981 
CPU_DEAD
:

1982 
CPU_DEAD_FROZEN
:

1983 i‡(
thªshﬁd_˝u_ˇŒback
)

1984 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

1985 
	`m˚_ªmove_devi˚
(
˝u
);

1987 
CPU_DOWN_PREPARE
:

1988 
CPU_DOWN_PREPARE_FROZEN
:

1989 
	`dñ_timî_sync
(
t
);

1990 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_dißbÀ_˝u
, &
a˘i⁄
, 1);

1992 
CPU_DOWN_FAILED
:

1993 
CPU_DOWN_FAILED_FROZEN
:

1994 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 +

1995 
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
));

1996 
	`add_timî_⁄
(
t
, 
˝u
);

1997 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_ªíabÀ_˝u
, &
a˘i⁄
, 1);

1999 
CPU_POST_DEAD
:

2001 
	`cmci_ªdiscovî
(
˝u
);

2004  
NOTIFY_OK
;

2005 
	}
}

2007 
nŸifõr_block
 
m˚_˝u_nŸifõr
 
	g__˝uöôd©a
 = {

2008 .
nŸifõr_ˇŒ
 = 
m˚_˝u_ˇŒback
,

2011 
__öô
 
	$m˚_öô_b™ks
()

2013 
i
;

2015 
i
 = 0; i < 
b™ks
; i++) {

2016 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2017 
sysdev_©åibuã
 *
a
 = &
b
->
©å
;

2019 
a
->
©å
.
«me
 = 
b
->
©å«me
;

2020 
	`¢¥ötf
(
b
->
©å«me
, 
ATTR_LEN
, "b™k%d", 
i
);

2022 
a
->
©å
.
mode
 = 0644;

2023 
a
->
show
 = 
show_b™k
;

2024 
a
->
°‹e
 = 
£t_b™k
;

2026 
	}
}

2028 
__öô
 
	$m˚_öô_devi˚
()

2030 
îr
;

2031 
i
 = 0;

2033 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

2034  -
EIO
;

2036 
	`zÆloc_˝umask_v¨
(&
m˚_dev_öôülized
, 
GFP_KERNEL
);

2038 
	`m˚_öô_b™ks
();

2040 
îr
 = 
	`sysdev_˛ass_ªgi°î
(&
m˚_sys˛ass
);

2041 i‡(
îr
)

2042  
îr
;

2044 
	`f‹_óch_⁄löe_˝u
(
i
) {

2045 
îr
 = 
	`m˚_¸óã_devi˚
(
i
);

2046 i‡(
îr
)

2047  
îr
;

2050 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m˚_˝u_nŸifõr
);

2051 
	`misc_ªgi°î
(&
m˚_log_devi˚
);

2053  
îr
;

2054 
	}
}

2056 
devi˚_öôˇŒ
(
m˚_öô_devi˚
);

2061 
__öô
 
	$mcheck_dißbÀ
(*
°r
)

2063 
m˚_dißbÀd
 = 1;

2065 
	}
}

2066 
__£tup
("nom˚", 
mcheck_dißbÀ
);

2068 #ifde‡
CONFIG_DEBUG_FS


2069 
díåy
 *
	$m˚_gë_debugfs_dú
()

2071 
díåy
 *
dm˚
;

2073 i‡(!
dm˚
)

2074 
dm˚
 = 
	`debugfs_¸óã_dú
("m˚", 
NULL
);

2076  
dm˚
;

2077 
	}
}

2079 
	$m˚_ª£t
()

2081 
˝u_missög
 = 0;

2082 
	`©omic_£t
(&
m˚_Áke_∑ni˚d
, 0);

2083 
	`©omic_£t
(&
m˚_executög
, 0);

2084 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

2085 
	`©omic_£t
(&
globÆ_nwo
, 0);

2086 
	}
}

2088 
	$Áke_∑nic_gë
(*
d©a
, 
u64
 *
vÆ
)

2090 *
vÆ
 = 
Áke_∑nic
;

2092 
	}
}

2094 
	$Áke_∑nic_£t
(*
d©a
, 
u64
 
vÆ
)

2096 
	`m˚_ª£t
();

2097 
Áke_∑nic
 = 
vÆ
;

2099 
	}
}

2101 
DEFINE_SIMPLE_ATTRIBUTE
(
Áke_∑nic_f›s
, 
Áke_∑nic_gë
,

2102 
Áke_∑nic_£t
, "%llu\n");

2104 
__öô
 
	$m˚_debugfs_öô
()

2106 
díåy
 *
dm˚
, *
fÁke_∑nic
;

2108 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

2109 i‡(!
dm˚
)

2110  -
ENOMEM
;

2111 
fÁke_∑nic
 = 
	`debugfs_¸óã_fûe
("Áke_∑nic", 0444, 
dm˚
, 
NULL
,

2112 &
Áke_∑nic_f›s
);

2113 i‡(!
fÁke_∑nic
)

2114  -
ENOMEM
;

2117 
	}
}

2118 
œã_öôˇŒ
(
m˚_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/kobje˘.h
>

19 
	~<löux/≥r˝u.h
>

20 
	~<löux/sysdev.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/sysfs.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/˝u.h
>

26 
	~<löux/smp.h
>

28 
	~<asm/≠ic.h
>

29 
	~<asm/idÀ.h
>

30 
	~<asm/m˚.h
>

31 
	~<asm/m§.h
>

33 
	#PFX
 "m˚_thªshﬁd: "

	)

34 
	#VERSION
 "vîsi⁄ 1.1.1"

	)

35 
	#NR_BANKS
 6

	)

36 
	#NR_BLOCKS
 9

	)

37 
	#THRESHOLD_MAX
 0xFFF

	)

38 
	#INT_TYPE_APIC
 0x00020000

	)

39 
	#MASK_VALID_HI
 0x80000000

	)

40 
	#MASK_CNTP_HI
 0x40000000

	)

41 
	#MASK_LOCKED_HI
 0x20000000

	)

42 
	#MASK_LVTOFF_HI
 0x00F00000

	)

43 
	#MASK_COUNT_EN_HI
 0x00080000

	)

44 
	#MASK_INT_TYPE_HI
 0x00060000

	)

45 
	#MASK_OVERFLOW_HI
 0x00010000

	)

46 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

47 
	#MASK_BLKPTR_LO
 0xFF000000

	)

48 
	#MCG_XBLK_ADDR
 0xC0000400

	)

50 
	sthªshﬁd_block
 {

51 
	mblock
;

52 
	mb™k
;

53 
	m˝u
;

54 
u32
 
	maddªss
;

55 
u16
 
	möãºu±_íabÀ
;

56 
u16
 
	mthªshﬁd_limô
;

57 
kobje˘
 
	mkobj
;

58 
li°_hód
 
	mmiscj
;

62 
thªshﬁd_block
 
	gthªshﬁd_deÁu…s
 = {

63 .
öãºu±_íabÀ
 = 0,

64 .
	gthªshﬁd_limô
 = 
THRESHOLD_MAX
,

67 
	sthªshﬁd_b™k
 {

68 
kobje˘
 *
	mkobj
;

69 
thªshﬁd_block
 *
	mblocks
;

70 
˝umask_v¨_t
 
	m˝us
;

72 
DEFINE_PER_CPU
(
thªshﬁd_b™k
 * [
NR_BANKS
], 
thªshﬁd_b™ks
);

74 #ifde‡
CONFIG_SMP


75 
	gsh¨ed_b™k
[
NR_BANKS
] = {

80 
DEFINE_PER_CPU
(, 
b™k_m≠
);

82 
amd_thªshﬁd_öãºu±
();

88 
	sthªsh_ª°¨t
 {

89 
thªshﬁd_block
 *
	mb
;

90 
	mª£t
;

91 
u16
 
	mﬁd_limô
;

96 
	$thªshﬁd_ª°¨t_b™k
(*
_å
)

98 
thªsh_ª°¨t
 *
å
 = 
_å
;

99 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

101 
	`rdm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

103 i‡(
å
->
b
->
thªshﬁd_limô
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

104 
å
->
ª£t
 = 1;

106 i‡(
å
->
ª£t
) {

107 
mci_misc_hi
 =

108 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

109 (
THRESHOLD_MAX
 - 
å
->
b
->
thªshﬁd_limô
);

110 } i‡(
å
->
ﬁd_limô
) {

111 
√w_cou¡
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

112 (
å
->
ﬁd_limô
 -År->
b
->
thªshﬁd_limô
);

114 
mci_misc_hi
 = (mci_misc_hò& ~
MASK_ERR_COUNT_HI
) |

115 (
√w_cou¡
 & 
THRESHOLD_MAX
);

118 
å
->
b
->
öãºu±_íabÀ
 ?

119 (
mci_misc_hi
 = (mci_misc_hò& ~
MASK_INT_TYPE_HI
Ë| 
INT_TYPE_APIC
) :

120 (
mci_misc_hi
 &~
MASK_INT_TYPE_HI
);

122 
mci_misc_hi
 |
MASK_COUNT_EN_HI
;

123 
	`wrm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

124 
	}
}

127 
	$m˚_amd_„©uª_öô
(
˝uöfo_x86
 *
c
)

129 
˝u
 = 
	`smp_¥o˚ss‹_id
();

130 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

131 
b™k
, 
block
;

132 
thªsh_ª°¨t
 
å
;

133 
u8
 
lvt_off
;

135 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

136 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

137 i‡(
block
 == 0)

138 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

139 i‡(
block
 == 1) {

140 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

141 i‡(!
addªss
)

143 
addªss
 +
MCG_XBLK_ADDR
;

145 ++
addªss
;

147 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

150 i‡(!(
high
 & 
MASK_VALID_HI
)) {

151 i‡(
block
)

157 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

158 (
high
 & 
MASK_LOCKED_HI
))

161 i‡(!
block
)

162 
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë|(1 << 
b™k
);

163 #ifde‡
CONFIG_SMP


164 i‡(
sh¨ed_b™k
[
b™k
] && 
c
->
˝u_c‹e_id
)

167 
lvt_off
 = 
	`£tup_APIC_eûvt_m˚
(
THRESHOLD_APIC_VECTOR
,

168 
APIC_EILVT_MSG_FIX
, 0);

170 
high
 &~
MASK_LVTOFF_HI
;

171 
high
 |
lvt_off
 << 20;

172 
	`wrm§
(
addªss
, 
low
, 
high
);

174 
thªshﬁd_deÁu…s
.
addªss
 =áddress;

175 
å
.
b
 = &
thªshﬁd_deÁu…s
;

176 
å
.
ª£t
 = 0;

177 
å
.
ﬁd_limô
 = 0;

178 
	`thªshﬁd_ª°¨t_b™k
(&
å
);

180 
m˚_thªshﬁd_ve˘‹
 = 
amd_thªshﬁd_öãºu±
;

183 
	}
}

194 
	$amd_thªshﬁd_öãºu±
()

196 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

197 
b™k
, 
block
;

198 
m˚
 
m
;

200 
	`m˚_£tup
(&
m
);

203 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

204 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
m
.
˝u
Ë& (1 << 
b™k
)))

206 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

207 i‡(
block
 == 0) {

208 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

209 } i‡(
block
 == 1) {

210 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

211 i‡(!
addªss
)

213 
addªss
 +
MCG_XBLK_ADDR
;

215 ++
addªss
;

218 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

221 i‡(!(
high
 & 
MASK_VALID_HI
)) {

222 i‡(
block
)

228 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

229 (
high
 & 
MASK_LOCKED_HI
))

236 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

237 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

239 i‡(
high
 & 
MASK_OVERFLOW_HI
) {

240 
	`rdm§l
(
addªss
, 
m
.
misc
);

241 
	`rdm§l
(
MSR_IA32_MC0_STATUS
 + 
b™k
 * 4,

242 
m
.
°©us
);

243 
m
.
b™k
 = 
K8_MCE_THRESHOLD_BASE


244 + 
b™k
 * 
NR_BLOCKS


245 + 
block
;

246 
	`m˚_log
(&
m
);

251 
	}
}

257 
	sthªshﬁd_©å
 {

258 
©åibuã
 
	m©å
;

259 
ssize_t
 (*
show
Ë(
	mthªshﬁd_block
 *, *);

260 
ssize_t
 (*
°‹e
Ë(
	mthªshﬁd_block
 *, c⁄° *, 
size_t
 
	mcou¡
);

263 
	#SHOW_FIELDS
(
«me
) \

264 
ssize_t
 
show_
 ## 
	`«me
(
thªshﬁd_block
 *
b
, *
buf
) \

266  
	`•rötf
(
buf
, "%lx\n", (Ë
b
->
«me
); \

267 }

	)

268 
	$SHOW_FIELDS
(
öãºu±_íabÀ
)

269 
	$SHOW_FIELDS
(
thªshﬁd_limô
)

271 
ssize_t


272 
	$°‹e_öãºu±_íabÀ
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

274 
thªsh_ª°¨t
 
å
;

275 
√w
;

277 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

278  -
EINVAL
;

280 
b
->
öãºu±_íabÀ
 = !!
√w
;

282 
å
.
b
 = b;

283 
å
.
ª£t
 = 0;

284 
å
.
ﬁd_limô
 = 0;

286 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

288  
size
;

289 
	}
}

291 
ssize_t


292 
	$°‹e_thªshﬁd_limô
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

294 
thªsh_ª°¨t
 
å
;

295 
√w
;

297 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

298  -
EINVAL
;

300 i‡(
√w
 > 
THRESHOLD_MAX
)

301 
√w
 = 
THRESHOLD_MAX
;

302 i‡(
√w
 < 1)

303 
√w
 = 1;

305 
å
.
ﬁd_limô
 = 
b
->
thªshﬁd_limô
;

306 
b
->
thªshﬁd_limô
 = 
√w
;

307 
å
.
b
 = b;

308 
å
.
ª£t
 = 0;

310 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

312  
size
;

313 
	}
}

315 
	sthªshﬁd_block_¸oss_˝u
 {

316 
thªshﬁd_block
 *
	mtb
;

317 
	mªtvÆ
;

320 
	$loˇl_îr‹_cou¡_h™dÀr
(*
_tbcc
)

322 
thªshﬁd_block_¸oss_˝u
 *
tbcc
 = 
_tbcc
;

323 
thªshﬁd_block
 *
b
 = 
tbcc
->
tb
;

324 
u32
 
low
, 
high
;

326 
	`rdm§
(
b
->
addªss
, 
low
, 
high
);

327 
tbcc
->
ªtvÆ
 = (
high
 & 0xFFFË- (
THRESHOLD_MAX
 - 
b
->
thªshﬁd_limô
);

328 
	}
}

330 
ssize_t
 
	$show_îr‹_cou¡
(
thªshﬁd_block
 *
b
, *
buf
)

332 
thªshﬁd_block_¸oss_˝u
 
tbcc
 = { .
tb
 = 
b
, };

334 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
loˇl_îr‹_cou¡_h™dÀr
, &
tbcc
, 1);

335  
	`•rötf
(
buf
, "%lx\n", 
tbcc
.
ªtvÆ
);

336 
	}
}

338 
ssize_t
 
	$°‹e_îr‹_cou¡
(
thªshﬁd_block
 *
b
,

339 c⁄° *
buf
, 
size_t
 
cou¡
)

341 
thªsh_ª°¨t
 
å
 = { .
b
 = b, .
ª£t
 = 1, .
ﬁd_limô
 = 0 };

343 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

345 
	}
}

347 
	#RW_ATTR
(
vÆ
) \

348 
thªshﬁd_©å
 
vÆ
 = { \

349 .
©å
 = {.
«me
 = 
	`__°rögify
(
vÆ
), .
mode
 = 0644 }, \

350 .
show
 = 
show_
## 
vÆ
, \

351 .
°‹e
 = 
°‹e_
## 
vÆ
, \

352 };

	)

354 
RW_ATTR
(
öãºu±_íabÀ
);

355 
RW_ATTR
(
thªshﬁd_limô
);

356 
RW_ATTR
(
îr‹_cou¡
);

358 
©åibuã
 *
	gdeÁu…_©ås
[] = {

359 &
öãºu±_íabÀ
.
©å
,

360 &
thªshﬁd_limô
.
©å
,

361 &
îr‹_cou¡
.
©å
,

362 
NULL


365 
	#to_block
(
k
Ë
	`c⁄èöî_of
(k, 
thªshﬁd_block
, 
kobj
)

	)

366 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
thªshﬁd_©å
, 
©å
)

	)

368 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

370 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

371 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

372 
ssize_t
 
ªt
;

374 
ªt
 = 
a
->
show
 ?á->
	`show
(
b
, 
buf
Ë: -
EIO
;

376  
ªt
;

377 
	}
}

379 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

380 c⁄° *
buf
, 
size_t
 
cou¡
)

382 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

383 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

384 
ssize_t
 
ªt
;

386 
ªt
 = 
a
->
°‹e
 ?á->
	`°‹e
(
b
, 
buf
, 
cou¡
Ë: -
EIO
;

388  
ªt
;

389 
	}
}

391 
sysfs_›s
 
	gthªshﬁd_›s
 = {

392 .
show
 = show,

393 .
	g°‹e
 = 
°‹e
,

396 
kobj_ty≥
 
	gthªshﬁd_kty≥
 = {

397 .
sysfs_›s
 = &
thªshﬁd_›s
,

398 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

401 
__˝uöô
 
	$Æloˇã_thªshﬁd_blocks
(
˝u
,

402 
b™k
,

403 
block
,

404 
u32
 
addªss
)

406 
thªshﬁd_block
 *
b
 = 
NULL
;

407 
u32
 
low
, 
high
;

408 
îr
;

410 i‡((
b™k
 >
NR_BANKS
Ë|| (
block
 >
NR_BLOCKS
))

413 i‡(
	`rdm§_ß„_⁄_˝u
(
˝u
, 
addªss
, &
low
, &
high
))

416 i‡(!(
high
 & 
MASK_VALID_HI
)) {

417 i‡(
block
)

418 
ªcur£
;

423 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

424 (
high
 & 
MASK_LOCKED_HI
))

425 
ªcur£
;

427 
b
 = 
	`kzÆloc
((
thªshﬁd_block
), 
GFP_KERNEL
);

428 i‡(!
b
)

429  -
ENOMEM
;

431 
b
->
block
 = block;

432 
b
->
b™k
 = bank;

433 
b
->
˝u
 = cpu;

434 
b
->
addªss
 =áddress;

435 
b
->
öãºu±_íabÀ
 = 0;

436 
b
->
thªshﬁd_limô
 = 
THRESHOLD_MAX
;

438 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

440 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
) {

441 
	`li°_add
(&
b
->
miscj
,

442 &
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
->
miscj
);

444 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
b
;

447 
îr
 = 
	`kobje˘_öô_™d_add
(&
b
->
kobj
, &
thªshﬁd_kty≥
,

448 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
kobj
,

449 "misc%i", 
block
);

450 i‡(
îr
)

451 
out_‰ì
;

452 
ªcur£
:

453 i‡(!
block
) {

454 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

455 i‡(!
addªss
)

457 
addªss
 +
MCG_XBLK_ADDR
;

459 ++
addªss
;

462 
îr
 = 
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, ++
block
, 
addªss
);

463 i‡(
îr
)

464 
out_‰ì
;

466 i‡(
b
)

467 
	`kobje˘_uevít
(&
b
->
kobj
, 
KOBJ_ADD
);

469  
îr
;

471 
out_‰ì
:

472 i‡(
b
) {

473 
	`kobje˘_put
(&
b
->
kobj
);

474 
	`k‰ì
(
b
);

476  
îr
;

477 
	}
}

479 
__˝uöô
 

480 
	$loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
)

482  
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, 0,

483 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4);

484 
	}
}

487 
__˝uöô
 
	$thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
)

489 
i
, 
îr
 = 0;

490 
thªshﬁd_b™k
 *
b
 = 
NULL
;

491 
«me
[32];

492 #ifde‡
CONFIG_SMP


493 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

496 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

498 #ifde‡
CONFIG_SMP


499 i‡(
	`˝u_d©a
(
˝u
).
˝u_c‹e_id
 && 
sh¨ed_b™k
[
b™k
]) {

500 
i
 = 
	`˝umask_fú°
(
c
->
Œc_sh¨ed_m≠
);

503 i‡(
	`˝u_d©a
(
i
).
˝u_c‹e_id
)

504 
out
;

507 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
])

508 
out
;

510 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
];

512 i‡(!
b
)

513 
out
;

515 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
,

516 
b
->
kobj
, 
«me
);

517 i‡(
îr
)

518 
out
;

520 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

521 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

523 
out
;

527 
b
 = 
	`kzÆloc
((
thªshﬁd_b™k
), 
GFP_KERNEL
);

528 i‡(!
b
) {

529 
îr
 = -
ENOMEM
;

530 
out
;

532 i‡(!
	`Æloc_˝umask_v¨
(&
b
->
˝us
, 
GFP_KERNEL
)) {

533 
	`k‰ì
(
b
);

534 
îr
 = -
ENOMEM
;

535 
out
;

538 
b
->
kobj
 = 
	`kobje˘_¸óã_™d_add
(
«me
, &
	`≥r_˝u
(
m˚_dev
, 
˝u
).kobj);

539 i‡(!
b
->
kobj
)

540 
out_‰ì
;

542 #i‚de‡
CONFIG_SMP


543 
	`˝umask_£èŒ
(
b
->
˝us
);

545 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

548 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

550 
îr
 = 
	`loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
);

551 i‡(
îr
)

552 
out_‰ì
;

554 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

555 i‡(
i
 =
˝u
)

558 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
,

559 
b
->
kobj
, 
«me
);

560 i‡(
îr
)

561 
out
;

563 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
b
;

566 
out
;

568 
out_‰ì
:

569 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

570 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

571 
	`k‰ì
(
b
);

572 
out
:

573  
îr
;

574 
	}
}

577 
__˝uöô
 
	$thªshﬁd_¸óã_devi˚
(
˝u
)

579 
b™k
;

580 
îr
 = 0;

582 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

583 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

585 
îr
 = 
	`thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
);

586 i‡(
îr
)

587 
out
;

589 
out
:

590  
îr
;

591 
	}
}

599 
	$dóŒoˇã_thªshﬁd_block
(
˝u
,

600 
b™k
)

602 
thªshﬁd_block
 *
pos
 = 
NULL
;

603 
thªshﬁd_block
 *
tmp
 = 
NULL
;

604 
thªshﬁd_b™k
 *
hód
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

606 i‡(!
hód
)

609 
	`li°_f‹_óch_íåy_ß„
(
pos
, 
tmp
, &
hód
->
blocks
->
miscj
, miscj) {

610 
	`kobje˘_put
(&
pos
->
kobj
);

611 
	`li°_dñ
(&
pos
->
miscj
);

612 
	`k‰ì
(
pos
);

615 
	`k‰ì
(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
);

616 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
NULL
;

617 
	}
}

619 
	$thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
)

621 
thªshﬁd_b™k
 *
b
;

622 
«me
[32];

623 
i
 = 0;

625 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

626 i‡(!
b
)

628 i‡(!
b
->
blocks
)

629 
‰ì_out
;

631 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

633 #ifde‡
CONFIG_SMP


635 i‡(
sh¨ed_b™k
[
b™k
] && 
b
->
blocks
->
˝u
 != cpu) {

636 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 
«me
);

637 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

644 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

645 i‡(
i
 =
˝u
)

648 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
, 
«me
);

649 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
NULL
;

652 
	`dóŒoˇã_thªshﬁd_block
(
˝u
, 
b™k
);

654 
‰ì_out
:

655 
	`kobje˘_dñ
(
b
->
kobj
);

656 
	`kobje˘_put
(
b
->
kobj
);

657 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

658 
	`k‰ì
(
b
);

659 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

660 
	}
}

662 
	$thªshﬁd_ªmove_devi˚
(
˝u
)

664 
b™k
;

666 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

667 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

669 
	`thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
);

671 
	}
}

674 
__˝uöô


675 
	$amd_64_thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
)

677 
a˘i⁄
) {

678 
CPU_ONLINE
:

679 
CPU_ONLINE_FROZEN
:

680 
	`thªshﬁd_¸óã_devi˚
(
˝u
);

682 
CPU_DEAD
:

683 
CPU_DEAD_FROZEN
:

684 
	`thªshﬁd_ªmove_devi˚
(
˝u
);

689 
	}
}

691 
__öô
 
	$thªshﬁd_öô_devi˚
()

693 
l˝u
 = 0;

696 
	`f‹_óch_⁄löe_˝u
(
l˝u
) {

697 
îr
 = 
	`thªshﬁd_¸óã_devi˚
(
l˝u
);

699 i‡(
îr
)

700  
îr
;

702 
thªshﬁd_˝u_ˇŒback
 = 
amd_64_thªshﬁd_˝u_ˇŒback
;

705 
	}
}

706 
devi˚_öôˇŒ
(
thªshﬁd_öô_devi˚
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c

8 
	~<löux/öô.h
>

9 
	~<löux/öãºu±.h
>

10 
	~<löux/≥r˝u.h
>

11 
	~<löux/sched.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/¥o˚ss‹.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/m˚.h
>

24 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_b™ks_ow√d
);

30 
DEFINE_SPINLOCK
(
cmci_discovî_lock
);

32 
	#CMCI_THRESHOLD
 1

	)

34 
	$cmci_suµ‹ãd
(*
b™ks
)

36 
u64
 
ˇp
;

38 i‡(
m˚_cmci_dißbÀd
 || 
m˚_ign‹e_˚
)

46 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
)

48 i‡(!
˝u_has_≠ic
 || 
	`œpic_gë_maxlvt
() < 6)

50 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

51 *
b™ks
 = 
	`mö_t
(, 
MAX_NR_BANKS
, 
ˇp
 & 0xff);

52  !!(
ˇp
 & 
MCG_CMCI_P
);

53 
	}
}

61 
	$öãl_thªshﬁd_öãºu±
()

63 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

64 
	`m˚_nŸify_úq
();

65 
	}
}

67 
	$¥öt_upd©e
(*
ty≥
, *
hdr
, 
num
)

69 i‡(*
hdr
 == 0)

70 
	`¥ötk
(
KERN_INFO
 "CPU %d MCA b™ks", 
	`smp_¥o˚ss‹_id
());

71 *
hdr
 = 1;

72 
	`¥ötk
(
KERN_CONT
 " %s:%d", 
ty≥
, 
num
);

73 
	}
}

80 
	$cmci_discovî
(
b™ks
, 
boŸ
)

82 *
ow√d
 = (*)&
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
);

83 
Êags
;

84 
hdr
 = 0;

85 
i
;

87 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

88 
i
 = 0; i < 
b™ks
; i++) {

89 
u64
 
vÆ
;

91 i‡(
	`ã°_bô
(
i
, 
ow√d
))

94 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

97 i‡(
vÆ
 & 
CMCI_EN
) {

98 i‡(
	`ã°_™d_˛ór_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

99 
	`¥öt_upd©e
("SHD", &
hdr
, 
i
);

100 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

104 
vÆ
 |
CMCI_EN
 | 
CMCI_THRESHOLD
;

105 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

106 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

109 i‡(
vÆ
 & 
CMCI_EN
) {

110 i‡(!
	`ã°_™d_£t_bô
(
i
, 
ow√d
Ë|| 
boŸ
)

111 
	`¥öt_upd©e
("CMCI", &
hdr
, 
i
);

112 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

114 
	`WARN_ON
(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
)));

117 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

118 i‡(
hdr
)

119 
	`¥ötk
(
KERN_CONT
 "\n");

120 
	}
}

126 
	$cmci_ªcheck
()

128 
Êags
;

129 
b™ks
;

131 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
Ë|| !
	`cmci_suµ‹ãd
(&
b™ks
))

133 
	`loˇl_úq_ßve
(
Êags
);

134 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

135 
	`loˇl_úq_ª°‹e
(
Êags
);

136 
	}
}

142 
	$cmci_˛ór
()

144 
Êags
;

145 
i
;

146 
b™ks
;

147 
u64
 
vÆ
;

149 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

151 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

152 
i
 = 0; i < 
b™ks
; i++) {

153 i‡(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
)))

156 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

157 
vÆ
 &~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

158 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

159 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

161 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

162 
	}
}

168 
	$cmci_ªdiscovî
(
dyög
)

170 
b™ks
;

171 
˝u
;

172 
˝umask_v¨_t
 
ﬁd
;

174 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

176 i‡(!
	`Æloc_˝umask_v¨
(&
ﬁd
, 
GFP_KERNEL
))

178 
	`˝umask_c›y
(
ﬁd
, &
cuºít
->
˝us_Ælowed
);

180 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

181 i‡(
˝u
 =
dyög
)

183 i‡(
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
˝u
)))

186 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

187 
	`cmci_discovî
(
b™ks
, 0);

190 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
ﬁd
);

191 
	`‰ì_˝umask_v¨
(
ﬁd
);

192 
	}
}

197 
	$cmci_ªíabÀ
()

199 
b™ks
;

200 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

201 
	`cmci_discovî
(
b™ks
, 0);

202 
	}
}

204 
	$öãl_öô_cmci
()

206 
b™ks
;

208 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

211 
m˚_thªshﬁd_ve˘‹
 = 
öãl_thªshﬁd_öãºu±
;

212 
	`cmci_discovî
(
b™ks
, 1);

219 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

220 
	`cmci_ªcheck
();

221 
	}
}

223 
	$m˚_öãl_„©uª_öô
(
˝uöfo_x86
 *
c
)

225 
	`öãl_öô_thîmÆ
(
c
);

226 
	`öãl_öô_cmci
();

227 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/jiffõs.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/≥r˝u.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/˝u.h
>

27 
	~<asm/¥o˚ss‹.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

35 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

40 
	sthîmÆ_°©e
 {

41 
boﬁ
 
	mis_thrŸéed
;

43 
u64
 
	m√xt_check
;

44 
	mthrŸée_cou¡
;

45 
	mœ°_thrŸée_cou¡
;

48 
DEFINE_PER_CPU
(
thîmÆ_°©e
,Åhermal_state);

50 
©omic_t
 
	gthîm_thrŸ_í
 = 
ATOMIC_INIT
(0);

52 #ifde‡
CONFIG_SYSFS


53 
	#deföe_thîm_thrŸ_sysdev_⁄e_ro
(
_«me
) \

54 
	`SYSDEV_ATTR
(
_«me
, 0444, 
thîm_thrŸ_sysdev_show_
##_«me, 
NULL
)

	)

56 
	#deföe_thîm_thrŸ_sysdev_show_func
(
«me
) \

58 
ssize_t
 
thîm_thrŸ_sysdev_show_
##
	`«me
( \

59 
sys_devi˚
 *
dev
, \

60 
sysdev_©åibuã
 *
©å
, \

61 *
buf
) \

63 
˝u
 = 
dev
->
id
; \

64 
ssize_t
 
ªt
; \

66 
	`¥ìm±_dißbÀ
(); \

67 i‡(
	`˝u_⁄löe
(
˝u
)) \

68 
ªt
 = 
	`•rötf
(
buf
, "%lu\n", \

69 
	`≥r_˝u
(
thîmÆ_°©e
, 
˝u
).
«me
); \

71 
ªt
 = 0; \

72 
	`¥ìm±_íabÀ
(); \

74  
ªt
; \

75 }

	)

77 
deföe_thîm_thrŸ_sysdev_show_func
(
thrŸée_cou¡
);

78 
deföe_thîm_thrŸ_sysdev_⁄e_ro
(
thrŸée_cou¡
);

80 
©åibuã
 *
	gthîmÆ_thrŸée_©ås
[] = {

81 &
©å_thrŸée_cou¡
.
©å
,

82 
NULL


85 
©åibuã_group
 
	gthîmÆ_thrŸée_©å_group
 = {

86 .
©ås
 = 
thîmÆ_thrŸée_©ås
,

87 .
	g«me
 = "thermal_throttle"

107 
	$thîm_thrŸ_¥o˚ss
(
boﬁ
 
is_thrŸéed
)

109 
thîmÆ_°©e
 *
°©e
;

110 
this_˝u
;

111 
boﬁ
 
was_thrŸéed
;

112 
u64
 
now
;

114 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

115 
now
 = 
	`gë_jiffõs_64
();

116 
°©e
 = &
	`≥r_˝u
(
thîmÆ_°©e
, 
this_˝u
);

118 
was_thrŸéed
 = 
°©e
->
is_thrŸéed
;

119 
°©e
->
is_thrŸéed
 = is_throttled;

121 i‡(
is_thrŸéed
)

122 
°©e
->
thrŸée_cou¡
++;

124 i‡(
	`time_bef‹e64
(
now
, 
°©e
->
√xt_check
) &&

125 
°©e
->
thrŸée_cou¡
 !°©e->
œ°_thrŸée_cou¡
)

128 
°©e
->
√xt_check
 = 
now
 + 
CHECK_INTERVAL
;

129 
°©e
->
œ°_thrŸée_cou¡
 = sèã->
thrŸée_cou¡
;

132 i‡(
is_thrŸéed
) {

133 
	`¥ötk
(
KERN_CRIT
 "CPU%d: Tem≥øtuªábovêthªshﬁd, cpu clockÅhrŸéed (tŸÆÉvít†%lu)\n", 
this_˝u
, 
°©e
->
thrŸée_cou¡
);

135 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

138 i‡(
was_thrŸéed
) {

139 
	`¥ötk
(
KERN_INFO
 "CPU%d: Tem≥øtuª/•ìdÇ‹mÆ\n", 
this_˝u
);

144 
	}
}

146 #ifde‡
CONFIG_SYSFS


148 
__˝uöô
 
	$thîmÆ_thrŸée_add_dev
(
sys_devi˚
 *
sys_dev
)

150  
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
,

151 &
thîmÆ_thrŸée_©å_group
);

152 
	}
}

154 
__˝uöô
 
	$thîmÆ_thrŸée_ªmove_dev
(
sys_devi˚
 *
sys_dev
)

156 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
thîmÆ_thrŸée_©å_group
);

157 
	}
}

160 
DEFINE_MUTEX
(
thîm_˝u_lock
);

163 
__˝uöô
 

164 
	$thîmÆ_thrŸée_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

165 
a˘i⁄
,

166 *
h˝u
)

168 
˝u
 = ()
h˝u
;

169 
sys_devi˚
 *
sys_dev
;

170 
îr
 = 0;

172 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

174 
a˘i⁄
) {

175 
CPU_UP_PREPARE
:

176 
CPU_UP_PREPARE_FROZEN
:

177 
	`muãx_lock
(&
thîm_˝u_lock
);

178 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
sys_dev
);

179 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

180 
	`WARN_ON
(
îr
);

182 
CPU_UP_CANCELED
:

183 
CPU_UP_CANCELED_FROZEN
:

184 
CPU_DEAD
:

185 
CPU_DEAD_FROZEN
:

186 
	`muãx_lock
(&
thîm_˝u_lock
);

187 
	`thîmÆ_thrŸée_ªmove_dev
(
sys_dev
);

188 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

191  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

192 
	}
}

194 
nŸifõr_block
 
thîmÆ_thrŸée_˝u_nŸifõr
 
	g__˝uöôd©a
 =

196 .
nŸifõr_ˇŒ
 = 
thîmÆ_thrŸée_˝u_ˇŒback
,

199 
__öô
 
	$thîmÆ_thrŸée_öô_devi˚
()

201 
˝u
 = 0;

202 
îr
;

204 i‡(!
	`©omic_ªad
(&
thîm_thrŸ_í
))

207 
	`ªgi°î_hŸ˝u_nŸifõr
(&
thîmÆ_thrŸée_˝u_nŸifõr
);

209 #ifde‡
CONFIG_HOTPLUG_CPU


210 
	`muãx_lock
(&
thîm_˝u_lock
);

213 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

214 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
	`gë_˝u_sysdev
(
˝u
));

215 
	`WARN_ON
(
îr
);

217 #ifde‡
CONFIG_HOTPLUG_CPU


218 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

222 
	}
}

223 
devi˚_öôˇŒ
(
thîmÆ_thrŸée_öô_devi˚
);

228 
	$öãl_thîmÆ_öãºu±
()

230 
__u64
 
m§_vÆ
;

232 
	`rdm§l
(
MSR_IA32_THERM_STATUS
, 
m§_vÆ
);

233 i‡(
	`thîm_thrŸ_¥o˚ss
((
m§_vÆ
 & 
THERM_STATUS_PROCHOT
) != 0))

234 
	`m˚_log_thîm_thrŸ_evít
(
m§_vÆ
);

235 
	}
}

237 
	$u√x≥˘ed_thîmÆ_öãºu±
()

239 
	`¥ötk
(
KERN_ERR
 "CPU%d: Unexpected LVT TMR interrupt!\n",

240 
	`smp_¥o˚ss‹_id
());

241 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

242 
	}
}

244 (*
smp_thîmÆ_ve˘‹
)(Ë
u√x≥˘ed_thîmÆ_öãºu±
;

246 
asmlökage
 
	$smp_thîmÆ_öãºu±
(
±_ªgs
 *
ªgs
)

248 
	`exô_idÀ
();

249 
	`úq_íãr
();

250 
	`öc_úq_°©
(
úq_thîmÆ_cou¡
);

251 
	`smp_thîmÆ_ve˘‹
();

252 
	`úq_exô
();

254 
	`ack_APIC_úq
();

255 
	}
}

257 
	$öãl_öô_thîmÆ
(
˝uöfo_x86
 *
c
)

259 
˝u
 = 
	`smp_¥o˚ss‹_id
();

260 
tm2
 = 0;

261 
u32
 
l
, 
h
;

264 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
Ë|| !˝u_has(c, 
X86_FEATURE_ACC
))

272 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

273 
h
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

274 i‡((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
Ë&& (
h
 & 
APIC_DM_SMI
)) {

275 
	`¥ötk
(
KERN_DEBUG


276 "CPU%d: ThîmÆ m⁄ô‹ög h™dÀd by SMI\n", 
˝u
);

281 i‡(
h
 & 
APIC_VECTOR_MASK
) {

282 
	`¥ötk
(
KERN_DEBUG


284 
˝u
, (
h
 & 
APIC_VECTOR_MASK
));

289 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TM2
)) {

290 i‡(
c
->
x86
 =6 && (c->
x86_modñ
 == 9 || c->x86_model == 13)) {

291 
	`rdm§
(
MSR_THERM2_CTL
, 
l
, 
h
);

292 i‡(
l
 & 
MSR_THERM2_CTL_TM_SELECT
)

293 
tm2
 = 1;

294 } i‡(
l
 & 
MSR_IA32_MISC_ENABLE_TM2
)

295 
tm2
 = 1;

299 
h
 = 
THERMAL_APIC_VECTOR
 | 
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
;

300 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
h
);

302 
	`rdm§
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

303 
	`wrm§
(
MSR_IA32_THERM_INTERRUPT
,

304 
l
 | (
THERM_INT_LOW_ENABLE
 | 
THERM_INT_HIGH_ENABLE
), 
h
);

306 
smp_thîmÆ_ve˘‹
 = 
öãl_thîmÆ_öãºu±
;

308 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

309 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

312 
l
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

313 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

315 
	`¥ötk
(
KERN_INFO
 "CPU%d: Thermal monitoringÉnabled (%s)\n",

316 
˝u
, 
tm2
 ? "TM2" : "TM1");

319 
	`©omic_£t
(&
thîm_thrŸ_í
, 1);

320 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<löux/öãºu±.h
>

5 
	~<löux/kî√l.h
>

7 
	~<asm/úq_ve˘‹s.h
>

8 
	~<asm/≠ic.h
>

9 
	~<asm/idÀ.h
>

10 
	~<asm/m˚.h
>

12 
	$deÁu…_thªshﬁd_öãºu±
()

14 
	`¥ötk
(
KERN_ERR
 "UnexpectedÅhreshold interruptát vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
m˚_thªshﬁd_ve˘‹
)(Ë
deÁu…_thªshﬁd_öãºu±
;

20 
asmlökage
 
	$smp_thªshﬁd_öãºu±
()

22 
	`exô_idÀ
();

23 
	`úq_íãr
();

24 
	`öc_úq_°©
(
úq_thªshﬁd_cou¡
);

25 
	`m˚_thªshﬁd_ve˘‹
();

26 
	`úq_exô
();

28 
	`ack_APIC_úq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/˝u.h
>

25 
	~<löux/s‹t.h
>

26 
	~<löux/muãx.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/kvm_∑ø.h
>

30 
	~<asm/¥o˚ss‹.h
>

31 
	~<asm/e820.h
>

32 
	~<asm/mår.h
>

33 
	~<asm/m§.h
>

35 
	~"mår.h
"

37 
	sªs_ønge
 {

38 
	m°¨t
;

39 
	míd
;

42 
	sv¨_mår_ønge_°©e
 {

43 
	mba£_p‚
;

44 
	msize_p‚
;

45 
mår_ty≥
 
	mty≥
;

48 
	sv¨_mår_°©e
 {

49 
	mønge_°¨tk
;

50 
	mønge_sizek
;

51 
	mchunk_sizek
;

52 
	mgøn_sizek
;

53 
	mªg
;

57 
	#RANGE_NUM
 256

	)

59 
ªs_ønge
 
__öôd©a
 
	gønge
[
RANGE_NUM
];

60 
__öôd©a
 
	gƒ_ønge
;

62 
v¨_mår_ønge_°©e
 
__öôd©a
 
	gønge_°©e
[
RANGE_NUM
];

64 
__öôd©a
 
	gdebug_¥öt
;

65 
	#D¥ötk
(
x
...Ëdÿ{ i‡(
debug_¥öt
Ë
	`¥ötk
(
KERN_DEBUG
 x); } 0)

	)

68 
__öô


69 
	$add_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

70 
°¨t
, 
íd
)

73 i‡(
ƒ_ønge
 >
RANGE_NUM
)

74  
ƒ_ønge
;

76 
ønge
[
ƒ_ønge
].
°¨t
 = start;

77 
ønge
[
ƒ_ønge
].
íd
 =Énd;

79 
ƒ_ønge
++;

81  
ƒ_ønge
;

82 
	}
}

84 
__öô


85 
	$add_ønge_wôh_mîge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

86 
°¨t
, 
íd
)

88 
i
;

91 
i
 = 0; i < 
ƒ_ønge
; i++) {

92 
föÆ_°¨t
, 
föÆ_íd
;

93 
comm⁄_°¨t
, 
comm⁄_íd
;

95 i‡(!
ønge
[
i
].
íd
)

98 
comm⁄_°¨t
 = 
	`max
(
ønge
[
i
].
°¨t
, start);

99 
comm⁄_íd
 = 
	`mö
(
ønge
[
i
].
íd
,Énd);

100 i‡(
comm⁄_°¨t
 > 
comm⁄_íd
 + 1)

103 
föÆ_°¨t
 = 
	`mö
(
ønge
[
i
].
°¨t
, start);

104 
föÆ_íd
 = 
	`max
(
ønge
[
i
].
íd
,Énd);

106 
ønge
[
i
].
°¨t
 = 
föÆ_°¨t
;

107 
ønge
[
i
].
íd
 = 
föÆ_íd
;

108  
ƒ_ønge
;

112  
	`add_ønge
(
ønge
, 
ƒ_ønge
, 
°¨t
, 
íd
);

113 
	}
}

115 
__öô


116 
	$subåa˘_ønge
(
ªs_ønge
 *
ønge
, 
°¨t
, 
íd
)

118 
i
, 
j
;

120 
j
 = 0; j < 
RANGE_NUM
; j++) {

121 i‡(!
ønge
[
j
].
íd
)

124 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end) {

125 
ønge
[
j
].
°¨t
 = 0;

126 
ønge
[
j
].
íd
 = 0;

130 i‡(
°¨t
 <
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end &&

131 
ønge
[
j
].
°¨t
 < 
íd
 + 1) {

132 
ønge
[
j
].
°¨t
 = 
íd
 + 1;

137 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 >=Ñange[j].end &&

138 
ønge
[
j
].
íd
 > 
°¨t
 - 1) {

139 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

143 i‡(
°¨t
 > 
ønge
[
j
].°¨à&& 
íd
 <Ñange[j].end) {

145 
i
 = 0; i < 
RANGE_NUM
; i++) {

146 i‡(
ønge
[
i
].
íd
 == 0)

149 i‡(
i
 < 
RANGE_NUM
) {

150 
ønge
[
i
].
íd
 =Ñ™ge[
j
].end;

151 
ønge
[
i
].
°¨t
 = 
íd
 + 1;

153 
	`¥ötk
(
KERN_ERR
 "run of slot inÑanges\n");

155 
ønge
[
j
].
íd
 = 
°¨t
 - 1;

159 
	}
}

161 
__öô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

163 c⁄° 
ªs_ønge
 *
r1
 = 
x1
;

164 c⁄° 
ªs_ønge
 *
r2
 = 
x2
;

165 
°¨t1
, 
°¨t2
;

167 
°¨t1
 = 
r1
->
°¨t
;

168 
°¨t2
 = 
r2
->
°¨t
;

170  
°¨t1
 - 
°¨t2
;

171 
	}
}

173 
	#BIOS_BUG_MSG
 
KERN_WARNING
 \

174 "WARNING: BIOS bug: VAR MTRR %d c⁄èö†°øngêUCÉ¡ry undî 1M, check wôh you∏sy°em víd‹!\n"

	)

176 
__öô


177 
	$x86_gë_mår_mem_ønge
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

178 
exåa_ªmove_ba£
,

179 
exåa_ªmove_size
)

181 
ba£
, 
size
;

182 
mår_ty≥
 
ty≥
;

183 
i
;

185 
i
 = 0; i < 
num_v¨_ønges
; i++) {

186 
ty≥
 = 
ønge_°©e
[
i
].type;

187 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

189 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

190 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

191 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_ønge, 
ba£
,

192 
ba£
 + 
size
 - 1);

194 i‡(
debug_¥öt
) {

195 
	`¥ötk
(
KERN_DEBUG
 "After WB checking\n");

196 
i
 = 0; i < 
ƒ_ønge
; i++)

197 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

198 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

202 
i
 = 0; i < 
num_v¨_ønges
; i++) {

203 
ty≥
 = 
ønge_°©e
[
i
].type;

204 i‡(
ty≥
 !
MTRR_TYPE_UNCACHABLE
 &&

205 
ty≥
 !
MTRR_TYPE_WRPROT
)

207 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

208 i‡(!
size
)

210 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

211 i‡(
ba£
 < (1<<(20-
PAGE_SHIFT
)Ë&& 
mår_°©e
.
have_fixed
 &&

212 (
mår_°©e
.
íabÀd
 & 1)) {

214 
	`¥ötk
(
BIOS_BUG_MSG
, 
i
);

215 i‡(
ba£
 + 
size
 <(1<<(20-
PAGE_SHIFT
)))

217 
size
 -(1<<(20-
PAGE_SHIFT
)Ë- 
ba£
;

218 
ba£
 = 1<<(20-
PAGE_SHIFT
);

220 
	`subåa˘_ønge
(
ønge
, 
ba£
, ba£ + 
size
 - 1);

222 i‡(
exåa_ªmove_size
)

223 
	`subåa˘_ønge
(
ønge
, 
exåa_ªmove_ba£
,

224 
exåa_ªmove_ba£
 + 
exåa_ªmove_size
 - 1);

227 
ƒ_ønge
 = 0;

228 
i
 = 0; i < 
RANGE_NUM
; i++) {

229 i‡(!
ønge
[
i
].
íd
)

231 
ƒ_ønge
++;

233 i‡(
debug_¥öt
) {

234 
	`¥ötk
(
KERN_DEBUG
 "After UC checking\n");

235 
i
 = 0; i < 
ƒ_ønge
; i++)

236 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

237 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

241 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

242 i‡(
debug_¥öt
) {

243 
	`¥ötk
(
KERN_DEBUG
 "After sorting\n");

244 
i
 = 0; i < 
ƒ_ønge
; i++)

245 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016lx - %016lx\n",

246 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
 + 1);

250 
i
 = 
ƒ_ønge
; i < 
RANGE_NUM
; i++)

251 
	`mem£t
(&
ønge
[
i
], 0, (range[i]));

253  
ƒ_ønge
;

254 
	}
}

256 #ifde‡
CONFIG_MTRR_SANITIZER


258 
__öô
 
	$sum_ønges
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
)

260 
sum
 = 0;

261 
i
;

263 
i
 = 0; i < 
ƒ_ønge
; i++)

264 
sum
 +
ønge
[
i
].
íd
 + 1 -Ñ™ge[i].
°¨t
;

266  
sum
;

267 
	}
}

269 
íabÀ_mår_˛ónup
 
	g__öôd©a
 =

270 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

272 
__öô
 
	$dißbÀ_mår_˛ónup_£tup
(*
°r
)

274 
íabÀ_mår_˛ónup
 = 0;

276 
	}
}

277 
óæy_∑øm
("dißbÀ_mår_˛ónup", 
dißbÀ_mår_˛ónup_£tup
);

279 
__öô
 
	$íabÀ_mår_˛ónup_£tup
(*
°r
)

281 
íabÀ_mår_˛ónup
 = 1;

283 
	}
}

284 
óæy_∑øm
("íabÀ_mår_˛ónup", 
íabÀ_mår_˛ónup_£tup
);

286 
__öô
 
	$mår_˛ónup_debug_£tup
(*
°r
)

288 
debug_¥öt
 = 1;

290 
	}
}

291 
óæy_∑øm
("mår_˛ónup_debug", 
mår_˛ónup_debug_£tup
);

293 
__öô


294 
	$£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

295 
ty≥
, 
addªss_bôs
)

297 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

298 
u64
 
ba£
, 
mask
;

300 i‡(!
sizek
) {

301 
	`fûl_mår_v¨_ønge
(
ªg
, 0, 0, 0, 0);

305 
mask
 = (1ULL << 
addªss_bôs
) - 1;

306 
mask
 &~((((
u64
)
sizek
) << 10) - 1);

308 
ba£
 = ((
u64
)
ba£k
) << 10;

310 
ba£
 |
ty≥
;

311 
mask
 |= 0x800;

313 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

314 
ba£_hi
 = 
ba£
 >> 32;

316 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

317 
mask_hi
 = 
mask
 >> 32;

319 
	`fûl_mår_v¨_ønge
(
ªg
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

320 
	}
}

322 
__öô


323 
	$ßve_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

324 
ty≥
)

326 
ønge_°©e
[
ªg
].
ba£_p‚
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

327 
ønge_°©e
[
ªg
].
size_p‚
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

328 
ønge_°©e
[
ªg
].
ty≥
 =Åype;

329 
	}
}

331 
__öô
 
	$£t_v¨_mår_Æl
(
addªss_bôs
)

333 
ba£k
, 
sizek
;

334 
ty≥
;

335 
ªg
;

337 
ªg
 = 0;Ñeg < 
num_v¨_ønges
;Ñeg++) {

338 
ba£k
 = 
ønge_°©e
[
ªg
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

339 
sizek
 = 
ønge_°©e
[
ªg
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

340 
ty≥
 = 
ønge_°©e
[
ªg
].type;

342 
	`£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
, 
ty≥
, 
addªss_bôs
);

344 
	}
}

346 
	$to_size_Á˘‹
(
sizek
, *
Á˘‹p
)

348 
ba£
 = 
sizek
;

349 
Á˘‹
;

351 i‡(
ba£
 & ((1<<10) - 1)) {

353 
Á˘‹
 = 'K';

354 } i‡(
ba£
 & ((1<<20) - 1)) {

355 
Á˘‹
 = 'M';

356 
ba£
 >>= 10;

358 
Á˘‹
 = 'G';

359 
ba£
 >>= 20;

362 *
Á˘‹p
 = 
Á˘‹
;

364  
ba£
;

365 
	}
}

367 
__öô


368 
	$ønge_to_mår
(
ªg
, 
ønge_°¨tk
,

369 
ønge_sizek
, 
ty≥
)

371 i‡(!
ønge_sizek
 || (
ªg
 >
num_v¨_ønges
))

372  
ªg
;

374 
ønge_sizek
) {

375 
max_Æign
, 
Æign
;

376 
sizek
;

379 i‡(
ønge_°¨tk
)

380 
max_Æign
 = 
	`ffs
(
ønge_°¨tk
) - 1;

382 
max_Æign
 = 32;

384 
Æign
 = 
	`Ês
(
ønge_sizek
) - 1;

385 i‡(
Æign
 > 
max_Æign
)

386 
Æign
 = 
max_Æign
;

388 
sizek
 = 1 << 
Æign
;

389 i‡(
debug_¥öt
) {

390 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

391 
°¨t_ba£
, 
size_ba£
;

393 
°¨t_ba£
 = 
	`to_size_Á˘‹
(
ønge_°¨tk
, &
°¨t_Á˘‹
);

394 
size_ba£
 = 
	`to_size_Á˘‹
(
sizek
, &
size_Á˘‹
);

396 
	`D¥ötk
("Setting variable MTRR %d, "

398 
ªg
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

399 
size_ba£
, 
size_Á˘‹
,

400 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

401 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

404 
	`ßve_v¨_mår
(
ªg
++, 
ønge_°¨tk
, 
sizek
, 
ty≥
);

405 
ønge_°¨tk
 +
sizek
;

406 
ønge_sizek
 -
sizek
;

407 i‡(
ªg
 >
num_v¨_ønges
)

410  
ªg
;

411 
	}
}

413 
__öô


414 
	$ønge_to_mår_wôh_hﬁe
(
v¨_mår_°©e
 *
°©e
, 
ba£k
,

415 
sizek
)

417 
hﬁe_ba£k
, 
hﬁe_sizek
;

418 
£c⁄d_ba£k
, 
£c⁄d_sizek
;

419 
ønge0_ba£k
, 
ønge0_sizek
;

420 
ønge_ba£k
, 
ønge_sizek
;

421 
chunk_sizek
;

422 
gøn_sizek
;

424 
hﬁe_ba£k
 = 0;

425 
hﬁe_sizek
 = 0;

426 
£c⁄d_ba£k
 = 0;

427 
£c⁄d_sizek
 = 0;

428 
chunk_sizek
 = 
°©e
->chunk_sizek;

429 
gøn_sizek
 = 
°©e
->gran_sizek;

432 
ønge_ba£k
 = 
	`ALIGN
(
°©e
->
ønge_°¨tk
, 
gøn_sizek
);

433 i‡((
ønge_ba£k
 > 
ba£k
) && basek)

434  
£c⁄d_sizek
;

436 
°©e
->
ønge_sizek
 -(
ønge_ba£k
 - sèã->
ønge_°¨tk
);

437 
ønge_sizek
 = 
	`ALIGN
(
°©e
->ønge_sizek, 
gøn_sizek
);

439 
ønge_sizek
 > 
°©e
->range_sizek) {

440 
ønge_sizek
 -
gøn_sizek
;

441 i‡(!
ønge_sizek
)

444 
°©e
->
ønge_sizek
 =Ñange_sizek;

447 
ønge0_ba£k
 = 
°©e
->
ønge_°¨tk
;

448 
ønge0_sizek
 = 
	`ALIGN
(
°©e
->
ønge_sizek
, 
chunk_sizek
);

451 i‡(
ønge0_sizek
 =
°©e
->
ønge_sizek
) {

452 
	`D¥ötk
("rangeX: %016lx - %016lx\n",

453 
ønge0_ba£k
<<10,

454 (
ønge0_ba£k
 + 
°©e
->
ønge_sizek
)<<10);

455 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

456 
°©e
->
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

461 i‡(
sizek
) {

462 
ønge0_ba£k
 + 
ønge0_sizek
 > (
ba£k
 + 
sizek
)) {

463 i‡(
ønge0_sizek
 >
chunk_sizek
)

464 
ønge0_sizek
 -
chunk_sizek
;

466 
ønge0_sizek
 = 0;

468 i‡(!
ønge0_sizek
)

473 
£c⁄d_åy
:

474 
ønge_ba£k
 = 
ønge0_ba£k
 + 
ønge0_sizek
;

477 i‡(
ønge_ba£k
 > 
ba£k
 &&Ñ™ge_ba£k <(ba£k + 
sizek
))

478 
£c⁄d_sizek
 = 
ønge_ba£k
 - 
ba£k
;

480 i‡(
ønge0_sizek
 > 
°©e
->
ønge_sizek
) {

483 
hﬁe_sizek
 = 
ønge0_sizek
 - 
°©e
->
ønge_sizek
 - 
£c⁄d_sizek
;

486 i‡(
hﬁe_sizek
 >(
ønge0_sizek
 >> 1) &&

487 
ønge0_sizek
 >
chunk_sizek
) {

488 
ønge0_sizek
 -
chunk_sizek
;

489 
£c⁄d_sizek
 = 0;

490 
hﬁe_sizek
 = 0;

492 
£c⁄d_åy
;

496 i‡(
ønge0_sizek
) {

497 
	`D¥ötk
("range0: %016lx - %016lx\n",

498 
ønge0_ba£k
<<10,

499 (
ønge0_ba£k
 + 
ønge0_sizek
)<<10);

500 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

501 
ønge0_sizek
, 
MTRR_TYPE_WRBACK
);

504 i‡(
ønge0_sizek
 < 
°©e
->
ønge_sizek
) {

506 
ønge_sizek
 = 
°©e
->ønge_sizek - 
ønge0_sizek
;

508 
	`D¥ötk
("range: %016lx - %016lx\n",

509 
ønge_ba£k
<<10,

510 (
ønge_ba£k
 + 
ønge_sizek
)<<10);

512 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge_ba£k
,

513 
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

516 i‡(
hﬁe_sizek
) {

517 
hﬁe_ba£k
 = 
ønge_ba£k
 - 
hﬁe_sizek
 - 
£c⁄d_sizek
;

518 
	`D¥ötk
("hole: %016lx - %016lx\n",

519 
hﬁe_ba£k
<<10,

520 (
hﬁe_ba£k
 + 
hﬁe_sizek
)<<10);

521 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
hﬁe_ba£k
,

522 
hﬁe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

525  
£c⁄d_sizek
;

526 
	}
}

528 
__öô


529 
	$£t_v¨_mår_ønge
(
v¨_mår_°©e
 *
°©e
, 
ba£_p‚
,

530 
size_p‚
)

532 
ba£k
, 
sizek
;

533 
£c⁄d_sizek
 = 0;

535 i‡(
°©e
->
ªg
 >
num_v¨_ønges
)

538 
ba£k
 = 
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

539 
sizek
 = 
size_p‚
 << (
PAGE_SHIFT
 - 10);

542 i‡((
ba£k
 <= 1024) ||

543 (
°©e
->
ønge_°¨tk
 + sèã->
ønge_sizek
 =
ba£k
)) {

544 
ídk
 = 
ba£k
 + 
sizek
;

545 
°©e
->
ønge_sizek
 = 
ídk
 - sèã->
ønge_°¨tk
;

549 i‡(
°©e
->
ønge_sizek
 != 0)

550 
£c⁄d_sizek
 = 
	`ønge_to_mår_wôh_hﬁe
(
°©e
, 
ba£k
, 
sizek
);

553 
°©e
->
ønge_°¨tk
 = 
ba£k
 + 
£c⁄d_sizek
;

554 
°©e
->
ønge_sizek
 = 
sizek
 - 
£c⁄d_sizek
;

555 
	}
}

558 
u64
 
mår_chunk_size
 
	g__öôd©a
 = (256ULL<<20);

560 
__öô
 
	$∑r£_mår_chunk_size_›t
(*
p
)

562 i‡(!
p
)

563  -
EINVAL
;

564 
mår_chunk_size
 = 
	`mem∑r£
(
p
, &p);

566 
	}
}

567 
óæy_∑øm
("mår_chunk_size", 
∑r£_mår_chunk_size_›t
);

570 
u64
 
mår_gøn_size
 
	g__öôd©a
;

572 
__öô
 
	$∑r£_mår_gøn_size_›t
(*
p
)

574 i‡(!
p
)

575  -
EINVAL
;

576 
mår_gøn_size
 = 
	`mem∑r£
(
p
, &p);

578 
	}
}

579 
óæy_∑øm
("mår_gøn_size", 
∑r£_mår_gøn_size_›t
);

581 
ƒ_mår_•¨e_ªg
 
	g__öôd©a
 =

582 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

584 
__öô
 
	$∑r£_mår_•¨e_ªg
(*
¨g
)

586 i‡(
¨g
)

587 
ƒ_mår_•¨e_ªg
 = 
	`sim∂e_°πoul
(
¨g
, 
NULL
, 0);

589 
	}
}

590 
óæy_∑øm
("mår_•¨e_ªg_ƒ", 
∑r£_mår_•¨e_ªg
);

592 
__öô


593 
	$x86_£tup_v¨_mårs
(
ªs_ønge
 *
ønge
, 
ƒ_ønge
,

594 
u64
 
chunk_size
, u64 
gøn_size
)

596 
v¨_mår_°©e
 
v¨_°©e
;

597 
num_ªg
;

598 
i
;

600 
v¨_°©e
.
ønge_°¨tk
 = 0;

601 
v¨_°©e
.
ønge_sizek
 = 0;

602 
v¨_°©e
.
ªg
 = 0;

603 
v¨_°©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

604 
v¨_°©e
.
gøn_sizek
 = 
gøn_size
 >> 10;

606 
	`mem£t
(
ønge_°©e
, 0, (range_state));

609 
i
 = 0; i < 
ƒ_ønge
; i++) {

610 
	`£t_v¨_mår_ønge
(&
v¨_°©e
, 
ønge
[
i
].
°¨t
,

611 
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
 + 1);

615 i‡(
v¨_°©e
.
ønge_sizek
 != 0)

616 
	`ønge_to_mår_wôh_hﬁe
(&
v¨_°©e
, 0, 0);

618 
num_ªg
 = 
v¨_°©e
.
ªg
;

620 
v¨_°©e
.
ªg
 < 
num_v¨_ønges
) {

621 
	`ßve_v¨_mår
(
v¨_°©e
.
ªg
, 0, 0, 0);

622 
v¨_°©e
.
ªg
++;

625  
num_ªg
;

626 
	}
}

628 
	smår_˛ónup_ªsu…
 {

629 
	mgøn_sizek
;

630 
	mchunk_sizek
;

631 
	mlo£_covî_sizek
;

632 
	mnum_ªg
;

633 
	mbad
;

641 
	#NUM_RESULT
 136

	)

642 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

644 
mår_˛ónup_ªsu…
 
__öôd©a
 
	gªsu…
[
NUM_RESULT
];

645 
__öôd©a
 
	gmö_loss_p‚
[
RANGE_NUM
];

647 
__öô
 
	$¥öt_out_mår_ønge_°©e
()

649 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

650 
°¨t_ba£
, 
size_ba£
;

651 
mår_ty≥
 
ty≥
;

652 
i
;

654 
i
 = 0; i < 
num_v¨_ønges
; i++) {

656 
size_ba£
 = 
ønge_°©e
[
i
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

657 i‡(!
size_ba£
)

660 
size_ba£
 = 
	`to_size_Á˘‹
(size_ba£, &
size_Á˘‹
),

661 
°¨t_ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

662 
°¨t_ba£
 = 
	`to_size_Á˘‹
(°¨t_ba£, &
°¨t_Á˘‹
),

663 
ty≥
 = 
ønge_°©e
[
i
].type;

665 
	`¥ötk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,Ñange: %ld%cB,Åype %s\n",

666 
i
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

667 
size_ba£
, 
size_Á˘‹
,

668 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

669 ((
ty≥
 =
MTRR_TYPE_WRPROT
) ? "WP" :

670 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

673 
	}
}

675 
__öô
 
	$mår_√ed_˛ónup
()

677 
i
;

678 
mår_ty≥
 
ty≥
;

679 
size
;

681 
num
[
MTRR_NUM_TYPES
 + 1];

684 
	`mem£t
(
num
, 0, (num));

685 
i
 = 0; i < 
num_v¨_ønges
; i++) {

686 
ty≥
 = 
ønge_°©e
[
i
].type;

687 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

688 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

690 i‡(!
size
)

691 
ty≥
 = 
MTRR_NUM_TYPES
;

692 i‡(
ty≥
 =
MTRR_TYPE_WRPROT
)

693 
ty≥
 = 
MTRR_TYPE_UNCACHABLE
;

694 
num
[
ty≥
]++;

698 i‡(!
num
[
MTRR_TYPE_UNCACHABLE
])

702 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

703 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

707 
	}
}

709 
__öôd©a
 
	gønge_sums
;

711 
__öô


712 
	$mår_ˇlc_ønge_°©e
(
u64
 
chunk_size
, u64 
gøn_size
,

713 
x_ªmove_ba£
,

714 
x_ªmove_size
, 
i
)

716 
ªs_ønge
 
ønge_√w
[
RANGE_NUM
];

717 
ønge_sums_√w
;

718 
ƒ_ønge_√w
;

719 
num_ªg
;

722 
num_ªg
 = 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

725 
	`mem£t
(
ønge_√w
, 0, (range_new));

726 
ƒ_ønge_√w
 = 
	`x86_gë_mår_mem_ønge
(
ønge_√w
, 0,

727 
x_ªmove_ba£
, 
x_ªmove_size
);

728 
ønge_sums_√w
 = 
	`sum_ønges
(
ønge_√w
, 
ƒ_ønge_√w
);

730 
ªsu…
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

731 
ªsu…
[
i
].
gøn_sizek
 = 
gøn_size
 >> 10;

732 
ªsu…
[
i
].
num_ªg
 =Çum_reg;

734 i‡(
ønge_sums
 < 
ønge_sums_√w
) {

735 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums_√w
 - 
ønge_sums
Ë<< 
PSHIFT
;

736 
ªsu…
[
i
].
bad
 = 1;

738 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums
 - 
ønge_sums_√w
Ë<< 
PSHIFT
;

742 i‡(!
ªsu…
[
i
].
bad
 && !ªsu…[i].
lo£_covî_sizek
) {

743 i‡(
ƒ_ønge_√w
 !
ƒ_ønge
 || 
	`memcmp
(
ønge
, 
ønge_√w
, (range)))

744 
ªsu…
[
i
].
bad
 = 1;

747 i‡(!
ªsu…
[
i
].
bad
 && (
ønge_sums
 - 
ønge_sums_√w
 < 
mö_loss_p‚
[
num_ªg
]))

748 
mö_loss_p‚
[
num_ªg
] = 
ønge_sums
 - 
ønge_sums_√w
;

749 
	}
}

751 
__öô
 
	$mår_¥öt_out_⁄e_ªsu…
(
i
)

753 
gøn_ba£
, 
chunk_ba£
, 
lo£_ba£
;

754 
gøn_Á˘‹
, 
chunk_Á˘‹
, 
lo£_Á˘‹
;

756 
gøn_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
gøn_sizek
, &
gøn_Á˘‹
),

757 
chunk_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
chunk_sizek
, &
chunk_Á˘‹
),

758 
lo£_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
lo£_covî_sizek
, &
lo£_Á˘‹
),

760 
	`¥_öfo
("%sgran_size: %ld%c \tchunk_size: %ld%c \t",

761 
ªsu…
[
i
].
bad
 ? "*BAD*" : " ",

762 
gøn_ba£
, 
gøn_Á˘‹
, 
chunk_ba£
, 
chunk_Á˘‹
);

763 
	`¥_c⁄t
("num_reg: %d \tlose cover RAM: %s%ld%c\n",

764 
ªsu…
[
i
].
num_ªg
,Ñesu…[i].
bad
 ? "-" : "",

765 
lo£_ba£
, 
lo£_Á˘‹
);

766 
	}
}

768 
__öô
 
	$mår_£¨ch_›timÆ_ödex
()

770 
num_ªg_good
;

771 
ödex_good
;

772 
i
;

774 i‡(
ƒ_mår_•¨e_ªg
 >
num_v¨_ønges
)

775 
ƒ_mår_•¨e_ªg
 = 
num_v¨_ønges
 - 1;

777 
num_ªg_good
 = -1;

778 
i
 = 
num_v¨_ønges
 - 
ƒ_mår_•¨e_ªg
; i > 0; i--) {

779 i‡(!
mö_loss_p‚
[
i
])

780 
num_ªg_good
 = 
i
;

783 
ödex_good
 = -1;

784 i‡(
num_ªg_good
 != -1) {

785 
i
 = 0; i < 
NUM_RESULT
; i++) {

786 i‡(!
ªsu…
[
i
].
bad
 &&

787 
ªsu…
[
i
].
num_ªg
 =
num_ªg_good
 &&

788 !
ªsu…
[
i
].
lo£_covî_sizek
) {

789 
ödex_good
 = 
i
;

795  
ödex_good
;

796 
	}
}

798 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

800 
x_ªmove_ba£
, 
x_ªmove_size
;

801 
ba£
, 
size
, 
def
, 
dummy
;

802 
u64
 
chunk_size
, 
gøn_size
;

803 
mår_ty≥
 
ty≥
;

804 
ödex_good
;

805 
i
;

807 i‡(!
	`is_˝u
(
INTEL
Ë|| 
íabÀ_mår_˛ónup
 < 1)

810 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

811 
def
 &= 0xff;

812 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

816 
	`mem£t
(
ønge_°©e
, 0, (range_state));

817 
i
 = 0; i < 
num_v¨_ønges
; i++) {

818 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

819 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

820 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

821 
ønge_°©e
[
i
].
ty≥
 =Åype;

825 i‡(!
	`mår_√ed_˛ónup
())

829 
	`¥ötk
(
KERN_DEBUG
 "original variable MTRRs\n");

830 
	`¥öt_out_mår_ønge_°©e
();

832 
	`mem£t
(
ønge
, 0, (range));

833 
x_ªmove_size
 = 0;

834 
x_ªmove_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

835 i‡(
mår_tom2
)

836 
x_ªmove_size
 = (
mår_tom2
 >> 
PAGE_SHIFT
Ë- 
x_ªmove_ba£
;

838 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
, 0, 
x_ªmove_ba£
, 
x_ªmove_size
);

843 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
,Çr_range, 0,

844 (1ULL<<(20 - 
PAGE_SHIFT
)) - 1);

846 
	`s‹t
(
ønge
, 
ƒ_ønge
, (
ªs_ønge
), 
cmp_ønge
, 
NULL
);

848 
ønge_sums
 = 
	`sum_ønges
(
ønge
, 
ƒ_ønge
);

849 
	`¥ötk
(
KERN_INFO
 "total RAM covered: %ldM\n",

850 
ønge_sums
 >> (20 - 
PAGE_SHIFT
));

852 i‡(
mår_chunk_size
 && 
mår_gøn_size
) {

853 
i
 = 0;

854 
	`mår_ˇlc_ønge_°©e
(
mår_chunk_size
, 
mår_gøn_size
,

855 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

857 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

859 i‡(!
ªsu…
[
i
].
bad
) {

860 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

861 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

862 
	`¥öt_out_mår_ønge_°©e
();

865 
	`¥ötk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

869 
i
 = 0;

870 
	`mem£t
(
mö_loss_p‚
, 0xff, (min_loss_pfn));

871 
	`mem£t
(
ªsu…
, 0, (result));

872 
gøn_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

874 
chunk_size
 = 
gøn_size
; chunk_size < (1ULL<<32);

875 
chunk_size
 <<= 1) {

877 i‡(
i
 >
NUM_RESULT
)

880 
	`mår_ˇlc_ønge_°©e
(
chunk_size
, 
gøn_size
,

881 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

882 i‡(
debug_¥öt
) {

883 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

884 
	`¥ötk
(
KERN_INFO
 "\n");

887 
i
++;

892 
ödex_good
 = 
	`mår_£¨ch_›timÆ_ödex
();

894 i‡(
ödex_good
 != -1) {

895 
	`¥ötk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

896 
i
 = 
ödex_good
;

897 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

900 
chunk_size
 = 
ªsu…
[
i
].
chunk_sizek
;

901 
chunk_size
 <<= 10;

902 
gøn_size
 = 
ªsu…
[
i
].
gøn_sizek
;

903 
gøn_size
 <<= 10;

904 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

905 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

906 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

907 
	`¥öt_out_mår_ønge_°©e
();

911 
i
 = 0; i < 
NUM_RESULT
; i++)

912 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

915 
	`¥ötk
(
KERN_INFO
 "mtrr_cleanup: canÇot find optimal value\n");

916 
	`¥ötk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

919 
	}
}

921 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

924 
	}
}

927 
	gdißbÀ_mår_åim
;

929 
__öô
 
	$dißbÀ_mår_åim_£tup
(*
°r
)

931 
dißbÀ_mår_åim
 = 1;

933 
	}
}

934 
óæy_∑øm
("dißbÀ_mår_åim", 
dißbÀ_mår_åim_£tup
);

942 
	#Tom2E«bÀd
 (1U << 21)

	)

943 
	#Tom2F‹˚MemTy≥WB
 (1U << 22)

	)

945 
__öô
 
	$amd_•ecül_deÁu…_mår
()

947 
u32
 
l
, 
h
;

949 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_AMD
)

951 i‡(
boŸ_˝u_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

954 i‡(
	`rdm§_ß„
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

960 i‡((
l
 & (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
)) ==

961 (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
))

964 
	}
}

966 
u64
 
__öô


967 
	$ªÆ_åim_mem‹y
(
°¨t_p‚
, 
limô_p‚
)

969 
u64
 
åim_°¨t
, 
åim_size
;

971 
åim_°¨t
 = 
°¨t_p‚
;

972 
åim_°¨t
 <<
PAGE_SHIFT
;

974 
åim_size
 = 
limô_p‚
;

975 
åim_size
 <<
PAGE_SHIFT
;

976 
åim_size
 -
åim_°¨t
;

978  
	`e820_upd©e_ønge
(
åim_°¨t
, 
åim_size
, 
E820_RAM
, 
E820_RESERVED
);

979 
	}
}

992 
__öô
 
	$mår_åim_unˇched_mem‹y
(
íd_p‚
)

994 
i
, 
ba£
, 
size
, 
highe°_p‚
 = 0, 
def
, 
dummy
;

995 
mår_ty≥
 
ty≥
;

996 
u64
 
tŸÆ_åim_size
;

998 
num
[
MTRR_NUM_TYPES
 + 1];

1004 i‡(!
	`is_˝u
(
INTEL
Ë|| 
dißbÀ_mår_åim
)

1007 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

1008 
def
 &= 0xff;

1009 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

1013 
	`mem£t
(
ønge_°©e
, 0, (range_state));

1014 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1015 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

1016 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

1017 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

1018 
ønge_°©e
[
i
].
ty≥
 =Åype;

1022 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1023 
ty≥
 = 
ønge_°©e
[
i
].type;

1024 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

1026 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

1027 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1028 i‡(
highe°_p‚
 < 
ba£
 + 
size
)

1029 
highe°_p‚
 = 
ba£
 + 
size
;

1033 i‡(!
highe°_p‚
) {

1034 
	`¥ötk
(
KERN_INFO
 "CPU MTRRsáll blank - virtualized system.\n");

1039 
	`mem£t
(
num
, 0, (num));

1040 
i
 = 0; i < 
num_v¨_ønges
; i++) {

1041 
ty≥
 = 
ønge_°©e
[
i
].type;

1042 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

1044 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

1045 i‡(!
size
)

1046 
ty≥
 = 
MTRR_NUM_TYPES
;

1047 
num
[
ty≥
]++;

1051 i‡(!
num
[
MTRR_TYPE_WRBACK
])

1055 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

1056 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

1059 
	`mem£t
(
ønge
, 0, (range));

1060 
ƒ_ønge
 = 0;

1061 i‡(
mår_tom2
) {

1062 
ønge
[
ƒ_ønge
].
°¨t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

1063 
ønge
[
ƒ_ønge
].
íd
 = (
mår_tom2
 >> 
PAGE_SHIFT
) - 1;

1064 i‡(
highe°_p‚
 < 
ønge
[
ƒ_ønge
].
íd
 + 1)

1065 
highe°_p‚
 = 
ønge
[
ƒ_ønge
].
íd
 + 1;

1066 
ƒ_ønge
++;

1068 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
,Çr_range, 0, 0);

1071 
tŸÆ_åim_size
 = 0;

1072 i‡(
ønge
[0].
°¨t
)

1073 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(0, 
ønge
[0].
°¨t
);

1076 
i
 = 0; i < 
ƒ_ønge
 - 1; i++) {

1077 i‡(
ønge
[
i
].
íd
 + 1 <Ñ™ge[i+1].
°¨t
)

1078 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1079 
ønge
[
i
+1].
°¨t
);

1083 
i
 = 
ƒ_ønge
 - 1;

1084 i‡(
ønge
[
i
].
íd
 + 1 < 
íd_p‚
)

1085 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
 + 1,

1086 
íd_p‚
);

1088 i‡(
tŸÆ_åim_size
) {

1089 
	`¥_w¨nög
("WARNING: BIOS bug: CPU MTRR†d⁄'àcovîáŒ o‡mem‹y,Üosög %ŒuMB o‡RAM.\n", 
tŸÆ_åim_size
 >> 20);

1091 i‡(!
ch™ged_by_mår_˛ónup
)

1092 
	`WARN_ON
(1);

1094 
	`¥_öfo
("updateÉ820 for mtrr\n");

1095 
	`upd©e_e820
();

1101 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

5 
	#DEBUG


	)

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/io.h
>

11 
	~<löux/mm.h
>

13 
	~<asm/¥o˚ss‹-Êags.h
>

14 
	~<asm/˝u„©uª.h
>

15 
	~<asm/ébÊush.h
>

16 
	~<asm/sy°em.h
>

17 
	~<asm/mår.h
>

18 
	~<asm/m§.h
>

19 
	~<asm/∑t.h
>

21 
	~"mår.h
"

23 
	sfixed_ønge_block
 {

24 
	mba£_m§
;

25 
	mønges
;

28 
fixed_ønge_block
 
	gfixed_ønge_blocks
[] = {

29 { 
MSR_MTRRfix64K_00000
, 1 },

30 { 
MSR_MTRRfix16K_80000
, 2 },

31 { 
MSR_MTRRfix4K_C0000
, 8 },

35 
	gsmp_ch™ges_mask
;

36 
	gmår_°©e_£t
;

37 
u64
 
	gmår_tom2
;

39 
mår_°©e_ty≥
 
	gmår_°©e
;

40 
EXPORT_SYMBOL_GPL
(
mår_°©e
);

50 
ölöe
 
	$k8_check_syscfg_døm_mod_í
()

52 
u32
 
lo
, 
hi
;

54 i‡(!((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) &&

55 (
boŸ_˝u_d©a
.
x86
 >= 0x0f)))

58 
	`rdm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

59 i‡(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

60 
	`¥ötk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

62 
	`smp_¥o˚ss‹_id
());

63 
lo
 &~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

64 
	`mår_wrm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

66 
	}
}

74 
u8
 
	$mår_ty≥_lookup
(
u64
 
°¨t
, u64 
íd
)

76 
i
;

77 
u64
 
ba£
, 
mask
;

78 
u8
 
¥ev_m©ch
, 
cuº_m©ch
;

80 i‡(!
mår_°©e_£t
)

83 i‡(!
mår_°©e
.
íabÀd
)

87 
íd
--;

90 i‡(
mår_°©e
.
have_fixed
 && (
°¨t
 < 0x100000)) {

91 
idx
;

93 i‡(
°¨t
 < 0x80000) {

94 
idx
 = 0;

95 
idx
 +(
°¨t
 >> 16);

96  
mår_°©e
.
fixed_ønges
[
idx
];

97 } i‡(
°¨t
 < 0xC0000) {

98 
idx
 = 1 * 8;

99 
idx
 +((
°¨t
 - 0x80000) >> 14);

100  
mår_°©e
.
fixed_ønges
[
idx
];

101 } i‡(
°¨t
 < 0x1000000) {

102 
idx
 = 3 * 8;

103 
idx
 +((
°¨t
 - 0xC0000) >> 12);

104  
mår_°©e
.
fixed_ønges
[
idx
];

113 i‡(!(
mår_°©e
.
íabÀd
 & 2))

114  
mår_°©e
.
def_ty≥
;

116 
¥ev_m©ch
 = 0xFF;

117 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

118 
°¨t_°©e
, 
íd_°©e
;

120 i‡(!(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11)))

123 
ba£
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
) << 32) +

124 (
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

125 
mask
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
) << 32) +

126 (
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & 
PAGE_MASK
);

128 
°¨t_°©e
 = ((
°¨t
 & 
mask
Ë=(
ba£
 & mask));

129 
íd_°©e
 = ((
íd
 & 
mask
Ë=(
ba£
 & mask));

130 i‡(
°¨t_°©e
 !
íd_°©e
)

133 i‡((
°¨t
 & 
mask
Ë!(
ba£
 & mask))

136 
cuº_m©ch
 = 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff;

137 i‡(
¥ev_m©ch
 == 0xFF) {

138 
¥ev_m©ch
 = 
cuº_m©ch
;

142 i‡(
¥ev_m©ch
 =
MTRR_TYPE_UNCACHABLE
 ||

143 
cuº_m©ch
 =
MTRR_TYPE_UNCACHABLE
) {

144  
MTRR_TYPE_UNCACHABLE
;

147 i‡((
¥ev_m©ch
 =
MTRR_TYPE_WRBACK
 &&

148 
cuº_m©ch
 =
MTRR_TYPE_WRTHROUGH
) ||

149 (
¥ev_m©ch
 =
MTRR_TYPE_WRTHROUGH
 &&

150 
cuº_m©ch
 =
MTRR_TYPE_WRBACK
)) {

151 
¥ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

152 
cuº_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

155 i‡(
¥ev_m©ch
 !
cuº_m©ch
)

156  
MTRR_TYPE_UNCACHABLE
;

159 i‡(
mår_tom2
) {

160 i‡(
°¨t
 >(1ULL<<32Ë&& (
íd
 < 
mår_tom2
))

161  
MTRR_TYPE_WRBACK
;

164 i‡(
¥ev_m©ch
 != 0xFF)

165  
¥ev_m©ch
;

167  
mår_°©e
.
def_ty≥
;

168 
	}
}

172 
	$gë_mår_v¨_ønge
(
ödex
, 
mår_v¨_ønge
 *
vr
)

174 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

175 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

176 
	}
}

179 
	$fûl_mår_v¨_ønge
(
ödex
,

180 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

182 
mår_v¨_ønge
 *
vr
;

184 
vr
 = 
mår_°©e
.
v¨_ønges
;

186 
vr
[
ödex
].
ba£_lo
 = base_lo;

187 
vr
[
ödex
].
ba£_hi
 = base_hi;

188 
vr
[
ödex
].
mask_lo
 = mask_lo;

189 
vr
[
ödex
].
mask_hi
 = mask_hi;

190 
	}
}

192 
	$gë_fixed_ønges
(
mår_ty≥
 *
‰s
)

194 *
p
 = (*)
‰s
;

195 
i
;

197 
	`k8_check_syscfg_døm_mod_í
();

199 
	`rdm§
(
MSR_MTRRfix64K_00000
, 
p
[0],Ö[1]);

201 
i
 = 0; i < 2; i++)

202 
	`rdm§
(
MSR_MTRRfix16K_80000
 + 
i
, 
p
[2 + i * 2],Ö[3 + i * 2]);

203 
i
 = 0; i < 8; i++)

204 
	`rdm§
(
MSR_MTRRfix4K_C0000
 + 
i
, 
p
[6 + i * 2],Ö[7 + i * 2]);

205 
	}
}

207 
	$mår_ßve_fixed_ønges
(*
öfo
)

209 i‡(
˝u_has_mår
)

210 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

211 
	}
}

213 
__öôd©a
 
	gœ°_fixed_°¨t
;

214 
__öôd©a
 
	gœ°_fixed_íd
;

215 
mår_ty≥
 
__öôd©a
 
	gœ°_fixed_ty≥
;

217 
__öô
 
	$¥öt_fixed_œ°
()

219 i‡(!
œ°_fixed_íd
)

222 
	`¥_debug
(" %05X-%05X %s\n", 
œ°_fixed_°¨t
,

223 
œ°_fixed_íd
 - 1, 
	`mår_©åib_to_°r
(
œ°_fixed_ty≥
));

225 
œ°_fixed_íd
 = 0;

226 
	}
}

228 
__öô
 
	$upd©e_fixed_œ°
(
ba£
, 
íd
,

229 
mår_ty≥
 
ty≥
)

231 
œ°_fixed_°¨t
 = 
ba£
;

232 
œ°_fixed_íd
 = 
íd
;

233 
œ°_fixed_ty≥
 = 
ty≥
;

234 
	}
}

236 
__öô


237 
	$¥öt_fixed
(
ba£
, 
°ï
, c⁄° 
mår_ty≥
 *
ty≥s
)

239 
i
;

241 
i
 = 0; i < 8; ++i, ++
ty≥s
, 
ba£
 +
°ï
) {

242 i‡(
œ°_fixed_íd
 == 0) {

243 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

246 i‡(
œ°_fixed_íd
 =
ba£
 && 
œ°_fixed_ty≥
 =*
ty≥s
) {

247 
œ°_fixed_íd
 = 
ba£
 + 
°ï
;

251 
	`¥öt_fixed_œ°
();

252 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

254 
	}
}

256 
¥ï¨e_£t
();

257 
po°_£t
();

259 
__öô
 
	$¥öt_mår_°©e
()

261 
i
;

262 
high_width
;

264 
	`¥_debug
("MTRR defaultÅype: %s\n",

265 
	`mår_©åib_to_°r
(
mår_°©e
.
def_ty≥
));

266 i‡(
mår_°©e
.
have_fixed
) {

267 
	`¥_debug
("MTRR fixedÑanges %sabled:\n",

268 
mår_°©e
.
íabÀd
 & 1 ? "en" : "dis");

269 
	`¥öt_fixed
(0x00000, 0x10000, 
mår_°©e
.
fixed_ønges
 + 0);

270 
i
 = 0; i < 2; ++i)

271 
	`¥öt_fixed
(0x80000 + 
i
 * 0x20000, 0x04000,

272 
mår_°©e
.
fixed_ønges
 + (
i
 + 1) * 8);

273 
i
 = 0; i < 8; ++i)

274 
	`¥öt_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000,

275 
mår_°©e
.
fixed_ønges
 + (
i
 + 3) * 8);

278 
	`¥öt_fixed_œ°
();

280 
	`¥_debug
("MTRR variableÑanges %sabled:\n",

281 
mår_°©e
.
íabÀd
 & 2 ? "en" : "dis");

282 i‡(
size_‹_mask
 & 0xffffffffUL)

283 
high_width
 = 
	`ffs
(
size_‹_mask
 & 0xffffffffUL) - 1;

285 
high_width
 = 
	`ffs
(
size_‹_mask
>>32) + 32 - 1;

286 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

288 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

289 i‡(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11))

290 
	`¥_debug
(" %u base %0*X%05X000 mask %0*X%05X000 %s\n",

291 
i
,

292 
high_width
,

293 
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
,

294 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 >> 12,

295 
high_width
,

296 
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
,

297 
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 >> 12,

298 
	`mår_©åib_to_°r
(
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff));

300 
	`¥_debug
(" %u dißbÀd\n", 
i
);

302 i‡(
mår_tom2
)

303 
	`¥_debug
("TOM2: %016Œxák®%ŒdM\n", 
mår_tom2
, mtrr_tom2>>20);

304 
	}
}

307 
__öô
 
	$gë_mår_°©e
()

309 
mår_v¨_ønge
 *
vrs
;

310 
Êags
;

311 
lo
, 
dummy
;

312 
i
;

314 
vrs
 = 
mår_°©e
.
v¨_ønges
;

316 
	`rdm§
(
MSR_MTRRˇp
, 
lo
, 
dummy
);

317 
mår_°©e
.
have_fixed
 = (
lo
 >> 8) & 1;

319 
i
 = 0; i < 
num_v¨_ønges
; i++)

320 
	`gë_mår_v¨_ønge
(
i
, &
vrs
[i]);

321 i‡(
mår_°©e
.
have_fixed
)

322 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

324 
	`rdm§
(
MSR_MTRRdefTy≥
, 
lo
, 
dummy
);

325 
mår_°©e
.
def_ty≥
 = (
lo
 & 0xff);

326 
mår_°©e
.
íabÀd
 = (
lo
 & 0xc00) >> 10;

328 i‡(
	`amd_•ecül_deÁu…_mår
()) {

329 
low
, 
high
;

332 
	`rdm§
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

333 
mår_tom2
 = 
high
;

334 
mår_tom2
 <<= 32;

335 
mår_tom2
 |
low
;

336 
mår_tom2
 &= 0xffffff800000ULL;

339 
	`¥öt_mår_°©e
();

341 
mår_°©e_£t
 = 1;

344 
	`loˇl_úq_ßve
(
Êags
);

345 
	`¥ï¨e_£t
();

347 
	`∑t_öô
();

349 
	`po°_£t
();

350 
	`loˇl_úq_ª°‹e
(
Êags
);

351 
	}
}

354 
__öô
 
	$mår_°©e_w¨n
()

356 
mask
 = 
smp_ch™ges_mask
;

358 i‡(!
mask
)

360 i‡(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

361 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent fixed MTRR settings\n");

362 i‡(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

363 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent variable MTRR settings\n");

364 i‡(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

365 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent MTRRdefType settings\n");

367 
	`¥ötk
(
KERN_INFO
 "mtrr:Örobably your BIOS doesÇot setupáll CPUs.\n");

368 
	`¥ötk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

369 
	}
}

376 
	$mår_wrm§
(
m§
, 
a
, 
b
)

378 i‡(
	`wrm§_ß„
(
m§
, 
a
, 
b
) < 0) {

379 
	`¥ötk
(
KERN_ERR


381 
	`smp_¥o˚ss‹_id
(), 
m§
, 
a
, 
b
);

383 
	}
}

392 
	$£t_fixed_ønge
(
m§
, 
boﬁ
 *
ch™ged
, *
m§w‹ds
)

394 
lo
, 
hi
;

396 
	`rdm§
(
m§
, 
lo
, 
hi
);

398 i‡(
lo
 !
m§w‹ds
[0] || 
hi
 != msrwords[1]) {

399 
	`mår_wrm§
(
m§
, 
m§w‹ds
[0], msrwords[1]);

400 *
ch™ged
 = 
åue
;

402 
	}
}

413 
	$gíîic_gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚_ªg
)

415 
lba£
, 
lsize
;

416 
mår_ty≥
 
…y≥
;

417 
i
, 
max
;

419 
max
 = 
num_v¨_ønges
;

420 i‡(
ª∂a˚_ªg
 >0 &&Ñïœ˚_ªg < 
max
)

421  
ª∂a˚_ªg
;

423 
i
 = 0; i < 
max
; ++i) {

424 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

425 i‡(
lsize
 == 0)

426  
i
;

429  -
ENOSPC
;

430 
	}
}

432 
	$gíîic_gë_mår
(
ªg
, *
ba£
,

433 *
size
, 
mår_ty≥
 *
ty≥
)

435 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

436 
tmp
, 
hi
;

437 
˝u
;

443 
˝u
 = 
	`gë_˝u
();

445 
	`rdm§
(
	`MTRRphysMask_MSR
(
ªg
), 
mask_lo
, 
mask_hi
);

447 i‡((
mask_lo
 & 0x800) == 0) {

449 *
ba£
 = 0;

450 *
size
 = 0;

451 *
ty≥
 = 0;

452 
out_put_˝u
;

455 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
ba£_lo
, 
ba£_hi
);

458 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
Ë| 
mask_lo
 >> PAGE_SHIFT;

459 
mask_lo
 = 
size_‹_mask
 | 
tmp
;

462 
hi
 = 
	`Ês
(
tmp
);

463 i‡(
hi
 > 0) {

464 
tmp
 |~((1<<(
hi
 - 1)) - 1);

466 i‡(
tmp
 !
mask_lo
) {

467 
	`WARN_ONCE
(1, 
KERN_INFO
 "mtrr: your BIOS has set upán incorrect mask, fixing it up.\n");

468 
mask_lo
 = 
tmp
;

476 *
size
 = -
mask_lo
;

477 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
Ë| 
ba£_lo
 >> PAGE_SHIFT;

478 *
ty≥
 = 
ba£_lo
 & 0xff;

480 
out_put_˝u
:

481 
	`put_˝u
();

482 
	}
}

489 
	$£t_fixed_ønges
(
mår_ty≥
 *
‰s
)

491 *
ßved
 = (*)
‰s
;

492 
boﬁ
 
ch™ged
 = 
Ál£
;

493 
block
 = -1, 
ønge
;

495 
	`k8_check_syscfg_døm_mod_í
();

497 
fixed_ønge_blocks
[++
block
].
ønges
) {

498 
ønge
 = 0;Ñ™gê< 
fixed_ønge_blocks
[
block
].
ønges
;Ñange++)

499 
	`£t_fixed_ønge
(
fixed_ønge_blocks
[
block
].
ba£_m§
 + 
ønge
,

500 &
ch™ged
, (*)
ßved
++);

503  
ch™ged
;

504 
	}
}

510 
boﬁ
 
	$£t_mår_v¨_ønges
(
ödex
, 
mår_v¨_ønge
 *
vr
)

512 
lo
, 
hi
;

513 
boﬁ
 
ch™ged
 = 
Ál£
;

515 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
lo
, 
hi
);

516 i‡((
vr
->
ba£_lo
 & 0xfffff0ffULË!(
lo
 & 0xfffff0ffUL)

517 || (
vr
->
ba£_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

518 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

520 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

521 
ch™ged
 = 
åue
;

524 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
lo
, 
hi
);

526 i‡((
vr
->
mask_lo
 & 0xfffff800ULË!(
lo
 & 0xfffff800UL)

527 || (
vr
->
mask_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

528 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

529 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

530 
ch™ged
 = 
åue
;

532  
ch™ged
;

533 
	}
}

535 
u32
 
	gde·y≥_lo
, 
	gde·y≥_hi
;

543 
	$£t_mår_°©e
()

545 
ch™ge_mask
 = 0;

546 
i
;

548 
i
 = 0; i < 
num_v¨_ønges
; i++) {

549 i‡(
	`£t_mår_v¨_ønges
(
i
, &
mår_°©e
.
v¨_ønges
[i]))

550 
ch™ge_mask
 |
MTRR_CHANGE_MASK_VARIABLE
;

553 i‡(
mår_°©e
.
have_fixed
 && 
	`£t_fixed_ønges
(mår_°©e.
fixed_ønges
))

554 
ch™ge_mask
 |
MTRR_CHANGE_MASK_FIXED
;

560 i‡((
de·y≥_lo
 & 0xffË!
mår_°©e
.
def_ty≥


561 || ((
de·y≥_lo
 & 0xc00Ë>> 10Ë!
mår_°©e
.
íabÀd
) {

563 
de·y≥_lo
 = (de·y≥_lÿ& ~0xcffË| 
mår_°©e
.
def_ty≥
 |

564 (
mår_°©e
.
íabÀd
 << 10);

565 
ch™ge_mask
 |
MTRR_CHANGE_MASK_DEFTYPE
;

568  
ch™ge_mask
;

569 
	}
}

572 
	g¸4
;

573 
DEFINE_SPINLOCK
(
£t_©omicôy_lock
);

582 
	$¥ï¨e_£t
(Ë
	$__acquúes
(
£t_©omicôy_lock
)

584 
¸0
;

593 
	`•ö_lock
(&
£t_©omicôy_lock
);

596 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

597 
	`wrôe_¸0
(
¸0
);

598 
	`wbövd
();

601 i‡(
˝u_has_pge
) {

602 
¸4
 = 
	`ªad_¸4
();

603 
	`wrôe_¸4
(
¸4
 & ~
X86_CR4_PGE
);

607 
	`__Êush_éb
();

610 
	`rdm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

613 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
 & ~0xcff, 
de·y≥_hi
);

614 
	}
}

616 
	$po°_£t
(Ë
	$__ªÀa£s
(
£t_©omicôy_lock
)

619 
	`__Êush_éb
();

622 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

625 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

628 i‡(
˝u_has_pge
)

629 
	`wrôe_¸4
(
¸4
);

630 
	`•ö_u∆ock
(&
£t_©omicôy_lock
);

631 
	}
}

633 
	$gíîic_£t_Æl
()

635 
mask
, 
cou¡
;

636 
Êags
;

638 
	`loˇl_úq_ßve
(
Êags
);

639 
	`¥ï¨e_£t
();

642 
mask
 = 
	`£t_mår_°©e
();

645 
	`∑t_öô
();

647 
	`po°_£t
();

648 
	`loˇl_úq_ª°‹e
(
Êags
);

651 
cou¡
 = 0; cou¡ <  
mask
 * 8; ++count) {

652 i‡(
mask
 & 0x01)

653 
	`£t_bô
(
cou¡
, &
smp_ch™ges_mask
);

654 
mask
 >>= 1;

657 
	}
}

669 
	$gíîic_£t_mår
(
ªg
, 
ba£
,

670 
size
, 
mår_ty≥
 
ty≥
)

672 
Êags
;

673 
mår_v¨_ønge
 *
vr
;

675 
vr
 = &
mår_°©e
.
v¨_ønges
[
ªg
];

677 
	`loˇl_úq_ßve
(
Êags
);

678 
	`¥ï¨e_£t
();

680 i‡(
size
 == 0) {

685 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 0, 0);

686 
	`mem£t
(
vr
, 0, (
mår_v¨_ønge
));

688 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty≥
;

689 
vr
->
ba£_hi
 = (
ba£
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

690 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

691 
vr
->
mask_hi
 = (-
size
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

693 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

694 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 
vr
->
mask_lo
, vr->
mask_hi
);

697 
	`po°_£t
();

698 
	`loˇl_úq_ª°‹e
(
Êags
);

699 
	}
}

701 
	$gíîic_vÆid©e_add_∑ge
(
ba£
, 
size
,

702 
ty≥
)

704 
lba£
, 
œ°
;

710 i‡(
	`is_˝u
(
INTEL
Ë&& 
boŸ_˝u_d©a
.
x86
 == 6 &&

711 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

712 
boŸ_˝u_d©a
.
x86_mask
 <= 7) {

713 i‡(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

714 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸ 4 MiBálig√d\n", 
ba£
);

715  -
EINVAL
;

717 i‡(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

718 (
ty≥
 =
MTRR_TYPE_WRCOMB


719 || 
ty≥
 =
MTRR_TYPE_WRBACK
)) {

720 
	`¥_w¨nög
("mtrr: writable mtrr between 0x70000000ánd 0x7003FFFF may hangÅhe CPU.\n");

721  -
EINVAL
;

729 
œ°
 = 
ba£
 + 
size
 - 1;

730 
lba£
 = 
ba£
; !÷ba£ & 1Ë&& (
œ°
 & 1);

731 
lba£
 =Üba£ >> 1, 
œ°
 =Üast >> 1)

733 i‡(
lba£
 !
œ°
) {

734 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸálig√d o¿®size(0x%lx000Ëbound¨y\n", 
ba£
, 
size
);

735  -
EINVAL
;

738 
	}
}

740 
	$gíîic_have_wrcomb
()

742 
c⁄fig
, 
dummy
;

743 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

744  
c⁄fig
 & (1 << 10);

745 
	}
}

747 
	$posôive_have_wrcomb
()

750 
	}
}

755 
mår_›s
 
	ggíîic_mår_›s
 = {

756 .
u£_öãl_if
 = 1,

757 .
	g£t_Æl
 = 
gíîic_£t_Æl
,

758 .
	ggë
 = 
gíîic_gë_mår
,

759 .
	ggë_‰ì_ªgi⁄
 = 
gíîic_gë_‰ì_ªgi⁄
,

760 .
	g£t
 = 
gíîic_£t_mår
,

761 .
	gvÆid©e_add_∑ge
 = 
gíîic_vÆid©e_add_∑ge
,

762 .
	ghave_wrcomb
 = 
gíîic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<löux/ˇ∑bûôy.h
>

2 
	~<löux/£q_fûe.h
>

3 
	~<löux/uac˚ss.h
>

4 
	~<löux/¥oc_fs.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/˘y≥.h
>

7 
	~<löux/öô.h
>

9 
	#LINE_SIZE
 80

	)

11 
	~<asm/mår.h
>

13 
	~"mår.h
"

15 
	#FILE_FCOUNT
(
f
Ë(((
£q_fûe
 *)((f)->
¥iv©e_d©a
))->
¥iv©e
)

	)

17 c⁄° *c⁄° 
	gmår_°rögs
[
MTRR_NUM_TYPES
] =

28 c⁄° *
	$mår_©åib_to_°r
(
x
)

30  (
x
 <6Ë? 
mår_°rögs
[x] : "?";

31 
	}
}

33 #ifde‡
CONFIG_PROC_FS


36 
	$mår_fûe_add
(
ba£
, 
size
,

37 
ty≥
, 
boﬁ
 
ö¸emít
, 
fûe
 *fûe, 
∑ge
)

39 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

40 
ªg
, 
max
;

42 
max
 = 
num_v¨_ønges
;

43 i‡(
fcou¡
 =
NULL
) {

44 
fcou¡
 = 
	`kzÆloc
(
max
 *  *fcou¡, 
GFP_KERNEL
);

45 i‡(!
fcou¡
)

46  -
ENOMEM
;

47 
	`FILE_FCOUNT
(
fûe
Ë
fcou¡
;

49 i‡(!
∑ge
) {

50 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

51  -
EINVAL
;

52 
ba£
 >>
PAGE_SHIFT
;

53 
size
 >>
PAGE_SHIFT
;

55 
ªg
 = 
	`mår_add_∑ge
(
ba£
, 
size
, 
ty≥
, 
åue
);

56 i‡(
ªg
 >= 0)

57 ++
fcou¡
[
ªg
];

58  
ªg
;

59 
	}
}

62 
	$mår_fûe_dñ
(
ba£
, 
size
,

63 
fûe
 *fûe, 
∑ge
)

65 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

66 
ªg
;

68 i‡(!
∑ge
) {

69 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

70  -
EINVAL
;

71 
ba£
 >>
PAGE_SHIFT
;

72 
size
 >>
PAGE_SHIFT
;

74 
ªg
 = 
	`mår_dñ_∑ge
(-1, 
ba£
, 
size
);

75 i‡(
ªg
 < 0)

76  
ªg
;

77 i‡(
fcou¡
 =
NULL
)

78  
ªg
;

79 i‡(
fcou¡
[
ªg
] < 1)

80  -
EINVAL
;

81 --
fcou¡
[
ªg
];

82  
ªg
;

83 
	}
}

91 
ssize_t


92 
	$mår_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 * 
µos
)

94 
i
, 
îr
;

95 
ªg
;

96 
ba£
, 
size
;

97 *
±r
;

98 
löe
[
LINE_SIZE
];

99 
Àngth
;

100 
size_t
 
löñí
;

102 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

103  -
EPERM
;

105 
	`mem£t
(
löe
, 0, 
LINE_SIZE
);

107 
Àngth
 = 
Àn
;

108 
Àngth
--;

110 i‡(
Àngth
 > 
LINE_SIZE
 - 1)

111 
Àngth
 = 
LINE_SIZE
 - 1;

113 i‡(
Àngth
 < 0)

114  -
EINVAL
;

116 i‡(
	`c›y_‰om_u£r
(
löe
, 
buf
, 
Àngth
))

117  -
EFAULT
;

119 
löñí
 = 
	`°æí
(
löe
);

120 
±r
 = 
löe
 + 
löñí
 - 1;

121 i‡(
löñí
 && *
±r
 == '\n')

122 *
±r
 = '\0';

124 i‡(!
	`°∫cmp
(
löe
, "disable=", 8)) {

125 
ªg
 = 
	`sim∂e_°πoul
(
löe
 + 8, &
±r
, 0);

126 
îr
 = 
	`mår_dñ_∑ge
(
ªg
, 0, 0);

127 i‡(
îr
 < 0)

128  
îr
;

129  
Àn
;

132 i‡(
	`°∫cmp
(
löe
, "base=", 5))

133  -
EINVAL
;

135 
ba£
 = 
	`sim∂e_°πouŒ
(
löe
 + 5, &
±r
, 0);

136 
	`is•a˚
(*
±r
))

137 
±r
++;

139 i‡(
	`°∫cmp
(
±r
, "size=", 5))

140  -
EINVAL
;

142 
size
 = 
	`sim∂e_°πouŒ
(
±r
 + 5, &ptr, 0);

143 i‡((
ba£
 & 0xfffË|| (
size
 & 0xfff))

144  -
EINVAL
;

145 
	`is•a˚
(*
±r
))

146 
±r
++;

148 i‡(
	`°∫cmp
(
±r
, "type=", 5))

149  -
EINVAL
;

150 
±r
 += 5;

151 
	`is•a˚
(*
±r
))

152 
±r
++;

154 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

155 i‡(
	`°rcmp
(
±r
, 
mår_°rögs
[
i
]))

157 
ba£
 >>
PAGE_SHIFT
;

158 
size
 >>
PAGE_SHIFT
;

159 
îr
 = 
	`mår_add_∑ge
(()
ba£
, ()
size
, 
i
, 
åue
);

160 i‡(
îr
 < 0)

161  
îr
;

162  
Àn
;

164  -
EINVAL
;

165 
	}
}

168 
	$mår_io˘l
(
fûe
 *fûe, 
cmd
, 
__¨g
)

170 
îr
 = 0;

171 
mår_ty≥
 
ty≥
;

172 
size
;

173 
mår_£¡ry
 
£¡ry
;

174 
mår_gíåy
 
gíåy
;

175 
__u£r
 *
¨g
 = (__u£∏*Ë
__¨g
;

177 
cmd
) {

178 
MTRRIOC_ADD_ENTRY
:

179 
MTRRIOC_SET_ENTRY
:

180 
MTRRIOC_DEL_ENTRY
:

181 
MTRRIOC_KILL_ENTRY
:

182 
MTRRIOC_ADD_PAGE_ENTRY
:

183 
MTRRIOC_SET_PAGE_ENTRY
:

184 
MTRRIOC_DEL_PAGE_ENTRY
:

185 
MTRRIOC_KILL_PAGE_ENTRY
:

186 i‡(
	`c›y_‰om_u£r
(&
£¡ry
, 
¨g
,  sentry))

187  -
EFAULT
;

189 
MTRRIOC_GET_ENTRY
:

190 
MTRRIOC_GET_PAGE_ENTRY
:

191 i‡(
	`c›y_‰om_u£r
(&
gíåy
, 
¨g
,  gentry))

192  -
EFAULT
;

194 #ifde‡
CONFIG_COMPAT


195 
MTRRIOC32_ADD_ENTRY
:

196 
MTRRIOC32_SET_ENTRY
:

197 
MTRRIOC32_DEL_ENTRY
:

198 
MTRRIOC32_KILL_ENTRY
:

199 
MTRRIOC32_ADD_PAGE_ENTRY
:

200 
MTRRIOC32_SET_PAGE_ENTRY
:

201 
MTRRIOC32_DEL_PAGE_ENTRY
:

202 
MTRRIOC32_KILL_PAGE_ENTRY
: {

203 
mår_£¡ry32
 
__u£r
 *
s32
;

205 
s32
 = (
mår_£¡ry32
 
__u£r
 *)
__¨g
;

206 
îr
 = 
	`gë_u£r
(
£¡ry
.
ba£
, &
s32
->base);

207 
îr
 |
	`gë_u£r
(
£¡ry
.
size
, &
s32
->size);

208 
îr
 |
	`gë_u£r
(
£¡ry
.
ty≥
, &
s32
->type);

209 i‡(
îr
)

210  
îr
;

213 
MTRRIOC32_GET_ENTRY
:

214 
MTRRIOC32_GET_PAGE_ENTRY
: {

215 
mår_gíåy32
 
__u£r
 *
g32
;

217 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

218 
îr
 = 
	`gë_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

219 
îr
 |
	`gë_u£r
(
gíåy
.
ba£
, &
g32
->base);

220 
îr
 |
	`gë_u£r
(
gíåy
.
size
, &
g32
->size);

221 
îr
 |
	`gë_u£r
(
gíåy
.
ty≥
, &
g32
->type);

222 i‡(
îr
)

223  
îr
;

229 
cmd
) {

231  -
ENOTTY
;

232 
MTRRIOC_ADD_ENTRY
:

233 #ifde‡
CONFIG_COMPAT


234 
MTRRIOC32_ADD_ENTRY
:

236 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

237  -
EPERM
;

238 
îr
 =

239 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

240 
fûe
, 0);

242 
MTRRIOC_SET_ENTRY
:

243 #ifde‡
CONFIG_COMPAT


244 
MTRRIOC32_SET_ENTRY
:

246 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

247  -
EPERM
;

248 
îr
 = 
	`mår_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

250 
MTRRIOC_DEL_ENTRY
:

251 #ifde‡
CONFIG_COMPAT


252 
MTRRIOC32_DEL_ENTRY
:

254 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

255  -
EPERM
;

256 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 0);

258 
MTRRIOC_KILL_ENTRY
:

259 #ifde‡
CONFIG_COMPAT


260 
MTRRIOC32_KILL_ENTRY
:

262 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

263  -
EPERM
;

264 
îr
 = 
	`mår_dñ
(-1, 
£¡ry
.
ba£
, síåy.
size
);

266 
MTRRIOC_GET_ENTRY
:

267 #ifde‡
CONFIG_COMPAT


268 
MTRRIOC32_GET_ENTRY
:

270 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

271  -
EINVAL
;

272 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

275 i‡(
gíåy
.
ba£
 + 
size
 - 1 >(1UL << (8 * (gíåy.sizeË- 
PAGE_SHIFT
))

276 || 
size
 >(1UL << (8 * (
gíåy
.sizeË- 
PAGE_SHIFT
)))

277 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

279 
gíåy
.
ba£
 <<
PAGE_SHIFT
;

280 
gíåy
.
size
 = sizê<< 
PAGE_SHIFT
;

281 
gíåy
.
ty≥
 =Åype;

285 
MTRRIOC_ADD_PAGE_ENTRY
:

286 #ifde‡
CONFIG_COMPAT


287 
MTRRIOC32_ADD_PAGE_ENTRY
:

289 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

290  -
EPERM
;

291 
îr
 =

292 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

293 
fûe
, 1);

295 
MTRRIOC_SET_PAGE_ENTRY
:

296 #ifde‡
CONFIG_COMPAT


297 
MTRRIOC32_SET_PAGE_ENTRY
:

299 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

300  -
EPERM
;

301 
îr
 =

302 
	`mår_add_∑ge
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

304 
MTRRIOC_DEL_PAGE_ENTRY
:

305 #ifde‡
CONFIG_COMPAT


306 
MTRRIOC32_DEL_PAGE_ENTRY
:

308 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

309  -
EPERM
;

310 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 1);

312 
MTRRIOC_KILL_PAGE_ENTRY
:

313 #ifde‡
CONFIG_COMPAT


314 
MTRRIOC32_KILL_PAGE_ENTRY
:

316 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

317  -
EPERM
;

318 
îr
 = 
	`mår_dñ_∑ge
(-1, 
£¡ry
.
ba£
, síåy.
size
);

320 
MTRRIOC_GET_PAGE_ENTRY
:

321 #ifde‡
CONFIG_COMPAT


322 
MTRRIOC32_GET_PAGE_ENTRY
:

324 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

325  -
EINVAL
;

326 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

328 i‡(
size
 !(
	`__ty≥of__
(
gíåy
.size))size)

329 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

331 
gíåy
.
size
 = size;

332 
gíåy
.
ty≥
 =Åype;

337 i‡(
îr
)

338  
îr
;

340 
cmd
) {

341 
MTRRIOC_GET_ENTRY
:

342 
MTRRIOC_GET_PAGE_ENTRY
:

343 i‡(
	`c›y_to_u£r
(
¨g
, &
gíåy
,  gentry))

344 
îr
 = -
EFAULT
;

346 #ifde‡
CONFIG_COMPAT


347 
MTRRIOC32_GET_ENTRY
:

348 
MTRRIOC32_GET_PAGE_ENTRY
: {

349 
mår_gíåy32
 
__u£r
 *
g32
;

351 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

352 
îr
 = 
	`put_u£r
(
gíåy
.
ba£
, &
g32
->base);

353 
îr
 |
	`put_u£r
(
gíåy
.
size
, &
g32
->size);

354 
îr
 |
	`put_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

355 
îr
 |
	`put_u£r
(
gíåy
.
ty≥
, &
g32
->type);

360  
îr
;

361 
	}
}

363 
	$mår_˛o£
(
öode
 *
öo
, 
fûe
 *file)

365 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

366 
i
, 
max
;

368 i‡(
fcou¡
 !
NULL
) {

369 
max
 = 
num_v¨_ønges
;

370 
i
 = 0; i < 
max
; ++i) {

371 
fcou¡
[
i
] > 0) {

372 
	`mår_dñ
(
i
, 0, 0);

373 --
fcou¡
[
i
];

376 
	`k‰ì
(
fcou¡
);

377 
	`FILE_FCOUNT
(
fûe
Ë
NULL
;

379  
	`sögÀ_ªÀa£
(
öo
, 
fûe
);

380 
	}
}

382 
mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
);

384 
	$mår_›í
(
öode
 *öode, 
fûe
 *file)

386 i‡(!
mår_if
)

387  -
EIO
;

388 i‡(!
mår_if
->
gë
)

389  -
ENXIO
;

390  
	`sögÀ_›í
(
fûe
, 
mår_£q_show
, 
NULL
);

391 
	}
}

393 c⁄° 
fûe_›î©i⁄s
 
	gmår_f›s
 = {

394 .
ow√r
 = 
THIS_MODULE
,

395 .
	g›í
 = 
mår_›í
,

396 .
	gªad
 = 
£q_ªad
,

397 .
	gŒ£ek
 = 
£q_l£ek
,

398 .
	gwrôe
 = 
mår_wrôe
,

399 .
	gu∆ocked_io˘l
 = 
mår_io˘l
,

400 .
	gcom∑t_io˘l
 = 
mår_io˘l
,

401 .
	gªÀa£
 = 
mår_˛o£
,

404 
	$mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
)

406 
Á˘‹
;

407 
i
, 
max
, 
Àn
;

408 
mår_ty≥
 
ty≥
;

409 
ba£
, 
size
;

411 
Àn
 = 0;

412 
max
 = 
num_v¨_ønges
;

413 
i
 = 0; i < 
max
; i++) {

414 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

415 i‡(
size
 == 0) {

416 
mår_ußge_èbÀ
[
i
] = 0;

419 i‡(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

421 
Á˘‹
 = 'K';

422 
size
 <<
PAGE_SHIFT
 - 10;

424 
Á˘‹
 = 'M';

425 
size
 >>20 - 
PAGE_SHIFT
;

428 
Àn
 +
	`£q_¥ötf
(
£q
, "reg%02i: base=0x%06lx000 "

430 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
,

431 
Á˘‹
, 
mår_ußge_èbÀ
[
i
],

432 
	`mår_©åib_to_°r
(
ty≥
));

435 
	}
}

437 
__öô
 
	$mår_if_öô
()

439 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

441 i‡((!
	`˝u_has
(
c
, 
X86_FEATURE_MTRR
)) &&

442 (!
	`˝u_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

443 (!
	`˝u_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

444 (!
	`˝u_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

445  -
ENODEV
;

447 
	`¥oc_¸óã
("mår", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mår_f›s
);

449 
	}
}

450 
¨ch_öôˇŒ
(
mår_if_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	#DEBUG


	)

36 
	~<löux/ty≥s.h
>

38 
	~<löux/kvm_∑ø.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/moduÀ.h
>

41 
	~<löux/muãx.h
>

42 
	~<löux/öô.h
>

43 
	~<löux/s‹t.h
>

44 
	~<löux/˝u.h
>

45 
	~<löux/pci.h
>

46 
	~<löux/smp.h
>

48 
	~<asm/¥o˚ss‹.h
>

49 
	~<asm/e820.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/m§.h
>

53 
	~"mår.h
"

55 
u32
 
	gnum_v¨_ønges
;

57 
	gmår_ußge_èbÀ
[
MTRR_MAX_VAR_RANGES
];

58 
DEFINE_MUTEX
(
mår_muãx
);

60 
u64
 
	gsize_‹_mask
, 
	gsize_™d_mask
;

61 
boﬁ
 
	gmår_≠s_dñayed_öô
;

63 
mår_›s
 *
	gmår_›s
[
X86_VENDOR_NUM
];

65 
mår_›s
 *
	gmår_if
;

67 
£t_mår
(
ªg
, 
ba£
,

68 
size
, 
mår_ty≥
 
ty≥
);

70 
	$£t_mår_›s
(
mår_›s
 *
›s
)

72 i‡(
›s
->
víd‹
 && ops->víd‹ < 
X86_VENDOR_NUM
)

73 
mår_›s
[
›s
->
víd‹
] = ops;

74 
	}
}

77 
	$have_wrcomb
()

79 
pci_dev
 *
dev
;

80 
u8
 
ªv
;

82 
dev
 = 
	`pci_gë_˛ass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
);

83 i‡(
dev
 !
NULL
) {

89 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_SERVERWORKS
 &&

90 
dev
->
devi˚
 =
PCI_DEVICE_ID_SERVERWORKS_LE
) {

91 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

92 i‡(
ªv
 <= 5) {

93 
	`¥_öfo
("mtrr: Serverworks LEÑev < 6 detected. Write-combining disabled.\n");

94 
	`pci_dev_put
(
dev
);

102 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_INTEL
 &&

103 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTEL_82451NX
) {

104 
	`¥_öfo
("mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

105 
	`pci_dev_put
(
dev
);

108 
	`pci_dev_put
(
dev
);

110  
mår_if
->
have_wrcomb
 ? mår_if->
	`have_wrcomb
() : 0;

111 
	}
}

114 
__öô
 
	$£t_num_v¨_ønges
()

116 
c⁄fig
 = 0, 
dummy
;

118 i‡(
	`u£_öãl
())

119 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

120 i‡(
	`is_˝u
(
AMD
))

121 
c⁄fig
 = 2;

122 i‡(
	`is_˝u
(
CYRIX
Ë|| is_˝u(
CENTAUR
))

123 
c⁄fig
 = 8;

125 
num_v¨_ønges
 = 
c⁄fig
 & 0xff;

126 
	}
}

128 
__öô
 
	$öô_èbÀ
()

130 
i
, 
max
;

132 
max
 = 
num_v¨_ønges
;

133 
i
 = 0; i < 
max
; i++)

134 
mår_ußge_èbÀ
[
i
] = 1;

135 
	}
}

137 
	s£t_mår_d©a
 {

138 
©omic_t
 
	mcou¡
;

139 
©omic_t
 
	mg©e
;

140 
	msmp_ba£
;

141 
	msmp_size
;

142 
	msmp_ªg
;

143 
mår_ty≥
 
	msmp_ty≥
;

151 
	$ùi_h™dÀr
(*
öfo
)

153 #ifde‡
CONFIG_SMP


154 
£t_mår_d©a
 *
d©a
 = 
öfo
;

155 
Êags
;

157 
	`loˇl_úq_ßve
(
Êags
);

159 
	`©omic_dec
(&
d©a
->
cou¡
);

160 !
	`©omic_ªad
(&
d©a
->
g©e
))

161 
	`˝u_ªœx
();

164 i‡(
d©a
->
smp_ªg
 != ~0U) {

165 
mår_if
->
	`£t
(
d©a
->
smp_ªg
, d©a->
smp_ba£
,

166 
d©a
->
smp_size
, d©a->
smp_ty≥
);

167 } i‡(
mår_≠s_dñayed_öô
) {

171 
mår_if
->
	`£t_Æl
();

174 
	`©omic_dec
(&
d©a
->
cou¡
);

175 
	`©omic_ªad
(&
d©a
->
g©e
))

176 
	`˝u_ªœx
();

178 
	`©omic_dec
(&
d©a
->
cou¡
);

179 
	`loˇl_úq_ª°‹e
(
Êags
);

181 
	}
}

183 
ölöe
 
	$ty≥s_com∑tibÀ
(
mår_ty≥
 
ty≥1
, mår_ty≥ 
ty≥2
)

185  
ty≥1
 =
MTRR_TYPE_UNCACHABLE
 ||

186 
ty≥2
 =
MTRR_TYPE_UNCACHABLE
 ||

187 (
ty≥1
 =
MTRR_TYPE_WRTHROUGH
 && 
ty≥2
 =
MTRR_TYPE_WRBACK
) ||

188 (
ty≥1
 =
MTRR_TYPE_WRBACK
 && 
ty≥2
 =
MTRR_TYPE_WRTHROUGH
);

189 
	}
}

232 
	$£t_mår
(
ªg
, 
ba£
, 
size
, 
mår_ty≥
 
ty≥
)

234 
£t_mår_d©a
 
d©a
;

235 
Êags
;

237 
d©a
.
smp_ªg
 = 
ªg
;

238 
d©a
.
smp_ba£
 = 
ba£
;

239 
d©a
.
smp_size
 = 
size
;

240 
d©a
.
smp_ty≥
 = 
ty≥
;

241 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

244 
	`smp_wmb
();

245 
	`©omic_£t
(&
d©a
.
g©e
, 0);

248 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_h™dÀr
, &
d©a
, 0) != 0)

249 
	`∑nic
("mtrr:Åimed out waiting for other CPUs\n");

251 
	`loˇl_úq_ßve
(
Êags
);

253 
	`©omic_ªad
(&
d©a
.
cou¡
))

254 
	`˝u_ªœx
();

257 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

258 
	`smp_wmb
();

259 
	`©omic_£t
(&
d©a
.
g©e
, 1);

270 i‡(
ªg
 != ~0U)

271 
mår_if
->
	`£t
(
ªg
, 
ba£
, 
size
, 
ty≥
);

272 i‡(!
mår_≠s_dñayed_öô
)

273 
mår_if
->
	`£t_Æl
();

276 
	`©omic_ªad
(&
d©a
.
cou¡
))

277 
	`˝u_ªœx
();

279 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

280 
	`smp_wmb
();

281 
	`©omic_£t
(&
d©a
.
g©e
, 0);

287 
	`©omic_ªad
(&
d©a
.
cou¡
))

288 
	`˝u_ªœx
();

290 
	`loˇl_úq_ª°‹e
(
Êags
);

291 
	}
}

328 
	$mår_add_∑ge
(
ba£
, 
size
,

329 
ty≥
, 
boﬁ
 
ö¸emít
)

331 
lba£
, 
lsize
;

332 
i
, 
ª∂a˚
, 
îr‹
;

333 
mår_ty≥
 
…y≥
;

335 i‡(!
mår_if
)

336  -
ENXIO
;

338 
îr‹
 = 
mår_if
->
	`vÆid©e_add_∑ge
(
ba£
, 
size
, 
ty≥
);

339 i‡(
îr‹
)

340  
îr‹
;

342 i‡(
ty≥
 >
MTRR_NUM_TYPES
) {

343 
	`¥_w¨nög
("mår:Åy≥: %u invÆid\n", 
ty≥
);

344  -
EINVAL
;

348 i‡((
ty≥
 =
MTRR_TYPE_WRCOMB
Ë&& !
	`have_wrcomb
()) {

349 
	`¥_w¨nög
("mtrr: yourÖrocessor doesn't support write-combining\n");

350  -
ENOSYS
;

353 i‡(!
size
) {

354 
	`¥_w¨nög
("mtrr: zero sizedÑequest\n");

355  -
EINVAL
;

358 i‡(
ba£
 & 
size_‹_mask
 || 
size
 & size_or_mask) {

359 
	`¥_w¨nög
("mtrr: base or sizeÉxceedsÅhe MTRR width\n");

360  -
EINVAL
;

363 
îr‹
 = -
EINVAL
;

364 
ª∂a˚
 = -1;

367 
	`gë_⁄löe_˝us
();

370 
	`muãx_lock
(&
mår_muãx
);

371 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

372 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

373 i‡(!
lsize
 || 
ba£
 > 
lba£
 +Üsize - 1 ||

374 
ba£
 + 
size
 - 1 < 
lba£
)

380 i‡(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >Üba£ + 
lsize
 - 1) {

381 i‡(
ba£
 <
lba£
 &&

382 
ba£
 + 
size
 - 1 >
lba£
 + 
lsize
 - 1) {

384 i‡(
ty≥
 =
…y≥
) {

385 
ª∂a˚
 =Ñïœ˚ =-1 ? 
i
 : -2;

387 } i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

390 
	`¥_w¨nög
("mtrr: 0x%lx000,0x%lx000 overlapsÉxisting"

391 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

392 
lsize
);

393 
out
;

396 i‡(
…y≥
 !
ty≥
) {

397 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

399 
	`¥_w¨nög
("mtrr:Åype mismatch for %lx000,%lx000 old: %sÇew: %s\n",

400 
ba£
, 
size
, 
	`mår_©åib_to_°r
(
…y≥
),

401 
	`mår_©åib_to_°r
(
ty≥
));

402 
out
;

404 i‡(
ö¸emít
)

405 ++
mår_ußge_èbÀ
[
i
];

406 
îr‹
 = 
i
;

407 
out
;

410 
i
 = 
mår_if
->
	`gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚
);

411 i‡(
i
 >= 0) {

412 
	`£t_mår
(
i
, 
ba£
, 
size
, 
ty≥
);

413 i‡(
	`likñy
(
ª∂a˚
 < 0)) {

414 
mår_ußge_èbÀ
[
i
] = 1;

416 
mår_ußge_èbÀ
[
i
] = mår_ußge_èbÀ[
ª∂a˚
];

417 i‡(
ö¸emít
)

418 
mår_ußge_èbÀ
[
i
]++;

419 i‡(
	`u∆ikñy
(
ª∂a˚
 !
i
)) {

420 
	`£t_mår
(
ª∂a˚
, 0, 0, 0);

421 
mår_ußge_èbÀ
[
ª∂a˚
] = 0;

425 
	`¥_öfo
("mtrr:Ço more MTRRsávailable\n");

427 
îr‹
 = 
i
;

428 
out
:

429 
	`muãx_u∆ock
(&
mår_muãx
);

430 
	`put_⁄löe_˝us
();

431  
îr‹
;

432 
	}
}

434 
	$mår_check
(
ba£
, 
size
)

436 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1))) {

437 
	`¥_w¨nög
("mtrr: sizeánd base must be multiples of 4 kiB\n");

438 
	`¥_debug
("mår: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

439 
	`dump_°ack
();

443 
	}
}

480 
	$mår_add
(
ba£
, 
size
, 
ty≥
,

481 
boﬁ
 
ö¸emít
)

483 i‡(
	`mår_check
(
ba£
, 
size
))

484  -
EINVAL
;

485  
	`mår_add_∑ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty≥
,

486 
ö¸emít
);

487 
	}
}

488 
EXPORT_SYMBOL
(
mår_add
);

504 
	$mår_dñ_∑ge
(
ªg
, 
ba£
, 
size
)

506 
i
, 
max
;

507 
mår_ty≥
 
…y≥
;

508 
lba£
, 
lsize
;

509 
îr‹
 = -
EINVAL
;

511 i‡(!
mår_if
)

512  -
ENXIO
;

514 
max
 = 
num_v¨_ønges
;

516 
	`gë_⁄löe_˝us
();

517 
	`muãx_lock
(&
mår_muãx
);

518 i‡(
ªg
 < 0) {

520 
i
 = 0; i < 
max
; ++i) {

521 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

522 i‡(
lba£
 =
ba£
 && 
lsize
 =
size
) {

523 
ªg
 = 
i
;

527 i‡(
ªg
 < 0) {

528 
	`¥_debug
("mtrr:Ço MTRR for %lx000,%lx000 found\n",

529 
ba£
, 
size
);

530 
out
;

533 i‡(
ªg
 >
max
) {

534 
	`¥_w¨nög
("mår:Ñegi°î: %dÅoÿbig\n", 
ªg
);

535 
out
;

537 
mår_if
->
	`gë
(
ªg
, &
lba£
, &
lsize
, &
…y≥
);

538 i‡(
lsize
 < 1) {

539 
	`¥_w¨nög
("mår: MTRR %dÇŸ u£d\n", 
ªg
);

540 
out
;

542 i‡(
mår_ußge_èbÀ
[
ªg
] < 1) {

543 
	`¥_w¨nög
("mår:Ñeg: %d ha†cou¡=0\n", 
ªg
);

544 
out
;

546 i‡(--
mår_ußge_èbÀ
[
ªg
] < 1)

547 
	`£t_mår
(
ªg
, 0, 0, 0);

548 
îr‹
 = 
ªg
;

549 
out
:

550 
	`muãx_u∆ock
(&
mår_muãx
);

551 
	`put_⁄löe_˝us
();

552  
îr‹
;

553 
	}
}

569 
	$mår_dñ
(
ªg
, 
ba£
, 
size
)

571 i‡(
	`mår_check
(
ba£
, 
size
))

572  -
EINVAL
;

573  
	`mår_dñ_∑ge
(
ªg
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

574 
	}
}

575 
EXPORT_SYMBOL
(
mår_dñ
);

582 
__öô
 
	$öô_ifs
()

584 #i‚de‡
CONFIG_X86_64


585 
	`amd_öô_mår
();

586 
	`cyrix_öô_mår
();

587 
	`˚¡aur_öô_mår
();

589 
	}
}

594 
	smår_vÆue
 {

595 
mår_ty≥
 
	m…y≥
;

596 
	mlba£
;

597 
	mlsize
;

600 
mår_vÆue
 
	gmår_vÆue
[
MTRR_MAX_VAR_RANGES
];

602 
	$mår_ßve
(
sys_devi˚
 *
sysdev
, 
pm_mesßge_t
 
°©e
)

604 
i
;

606 
i
 = 0; i < 
num_v¨_ønges
; i++) {

607 
mår_if
->
	`gë
(
i
, &
mår_vÆue
[i].
lba£
,

608 &
mår_vÆue
[
i
].
lsize
,

609 &
mår_vÆue
[
i
].
…y≥
);

612 
	}
}

614 
	$mår_ª°‹e
(
sys_devi˚
 *
sysdev
)

616 
i
;

618 
i
 = 0; i < 
num_v¨_ønges
; i++) {

619 i‡(
mår_vÆue
[
i
].
lsize
) {

620 
	`£t_mår
(
i
, 
mår_vÆue
[i].
lba£
,

621 
mår_vÆue
[
i
].
lsize
,

622 
mår_vÆue
[
i
].
…y≥
);

626 
	}
}

630 
sysdev_drivî
 
	gmår_sysdev_drivî
 = {

631 .
su•íd
 = 
mår_ßve
,

632 .
	gªsume
 = 
mår_ª°‹e
,

635 
__öôd©a
 
	gch™ged_by_mår_˛ónup
;

644 
__öô
 
	$mår_bp_öô
()

646 
u32
 
phys_addr
;

648 
	`öô_ifs
();

650 
phys_addr
 = 32;

652 i‡(
˝u_has_mår
) {

653 
mår_if
 = &
gíîic_mår_›s
;

654 
size_‹_mask
 = 0xff000000;

655 
size_™d_mask
 = 0x00f00000;

656 
phys_addr
 = 36;

663 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000008) {

664 
phys_addr
 = 
	`˝uid_óx
(0x80000008) & 0xff;

666 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

667 
boŸ_˝u_d©a
.
x86
 == 0xF &&

668 
boŸ_˝u_d©a
.
x86_modñ
 == 0x3 &&

669 (
boŸ_˝u_d©a
.
x86_mask
 == 0x3 ||

670 
boŸ_˝u_d©a
.
x86_mask
 == 0x4))

671 
phys_addr
 = 36;

673 
size_‹_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

674 
size_™d_mask
 = ~
size_‹_mask
 & 0xfffff00000ULL;

675 } i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_CENTAUR
 &&

676 
boŸ_˝u_d©a
.
x86
 == 6) {

681 
size_‹_mask
 = 0xfff00000;

682 
size_™d_mask
 = 0;

683 
phys_addr
 = 32;

686 
boŸ_˝u_d©a
.
x86_víd‹
) {

687 
X86_VENDOR_AMD
:

688 i‡(
˝u_has_k6_mår
) {

690 
mår_if
 = 
mår_›s
[
X86_VENDOR_AMD
];

691 
size_‹_mask
 = 0xfff00000;

692 
size_™d_mask
 = 0;

695 
X86_VENDOR_CENTAUR
:

696 i‡(
˝u_has_˚¡aur_m¸
) {

697 
mår_if
 = 
mår_›s
[
X86_VENDOR_CENTAUR
];

698 
size_‹_mask
 = 0xfff00000;

699 
size_™d_mask
 = 0;

702 
X86_VENDOR_CYRIX
:

703 i‡(
˝u_has_cyrix_¨r
) {

704 
mår_if
 = 
mår_›s
[
X86_VENDOR_CYRIX
];

705 
size_‹_mask
 = 0xfff00000;

706 
size_™d_mask
 = 0;

714 i‡(
mår_if
) {

715 
	`£t_num_v¨_ønges
();

716 
	`öô_èbÀ
();

717 i‡(
	`u£_öãl
()) {

718 
	`gë_mår_°©e
();

720 i‡(
	`mår_˛ónup
(
phys_addr
)) {

721 
ch™ged_by_mår_˛ónup
 = 1;

722 
mår_if
->
	`£t_Æl
();

726 
	}
}

728 
	$mår_≠_öô
()

730 i‡(!
	`u£_öãl
(Ë|| 
mår_≠s_dñayed_öô
)

745 
	`£t_mår
(~0U, 0, 0, 0);

746 
	}
}

751 
	$mår_ßve_°©e
()

753 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(0, 
mår_ßve_fixed_ønges
, 
NULL
, 1);

754 
	}
}

756 
	$£t_mår_≠s_dñayed_öô
()

758 i‡(!
	`u£_öãl
())

761 
mår_≠s_dñayed_öô
 = 
åue
;

762 
	}
}

767 
	$mår_≠s_öô
()

769 i‡(!
	`u£_öãl
())

772 
	`£t_mår
(~0U, 0, 0, 0);

773 
mår_≠s_dñayed_öô
 = 
Ál£
;

774 
	}
}

776 
	$mår_bp_ª°‹e
()

778 i‡(!
	`u£_öãl
())

781 
mår_if
->
	`£t_Æl
();

782 
	}
}

784 
__öô
 
	$mår_öô_föülize
()

786 i‡(!
mår_if
)

789 i‡(
	`u£_öãl
()) {

790 i‡(!
ch™ged_by_mår_˛ónup
)

791 
	`mår_°©e_w¨n
();

803 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mår_sysdev_drivî
);

806 
	}
}

807 
subsys_öôˇŒ
(
mår_öô_föülize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c

1 
	~<löux/öô.h
>

2 
	~<löux/io.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/¥o˚ss‹-cyrix.h
>

6 
	~<asm/¥o˚ss‹-Êags.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"mår.h
"

13 
	$£t_mår_¥ï¨e_ßve
(
£t_mår_c⁄ãxt
 *
˘xt
)

15 
¸0
;

18 
	`loˇl_úq_ßve
(
˘xt
->
Êags
);

20 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

23 i‡(
˝u_has_pge
) {

24 
˘xt
->
¸4vÆ
 = 
	`ªad_¸4
();

25 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
 & ~
X86_CR4_PGE
);

32 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

33 
	`wbövd
();

34 
	`wrôe_¸0
(
¸0
);

35 
	`wbövd
();

37 i‡(
	`u£_öãl
()) {

39 
	`rdm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
, ctxt->
de·y≥_hi
);

45 
˘xt
->
c¸3
 = 
	`gëCx86
(
CX86_CCR3
);

48 
	}
}

50 
	$£t_mår_ˇche_dißbÀ
(
£t_mår_c⁄ãxt
 *
˘xt
)

52 i‡(
	`u£_öãl
()) {

54 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
 & 0xf300UL,

55 
˘xt
->
de·y≥_hi
);

57 i‡(
	`is_˝u
(
CYRIX
)) {

59 
	`£tCx86
(
CX86_CCR3
, (
˘xt
->
c¸3
 & 0x0f) | 0x10);

62 
	}
}

65 
	$£t_mår_d⁄e
(
£t_mår_c⁄ãxt
 *
˘xt
)

67 i‡(
	`u£_öãl
(Ë|| 
	`is_˝u
(
CYRIX
)) {

70 
	`wbövd
();

73 i‡(
	`u£_öãl
()) {

75 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
˘xt
->
de·y≥_lo
,

76 
˘xt
->
de·y≥_hi
);

82 
	`£tCx86
(
CX86_CCR3
, 
˘xt
->
c¸3
);

86 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

89 i‡(
˝u_has_pge
)

90 
	`wrôe_¸4
(
˘xt
->
¸4vÆ
);

93 
	`loˇl_úq_ª°‹e
(
˘xt
->
Êags
);

94 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c

14 
	~<löux/≥rf_evít.h
>

15 
	~<löux/ˇ∑bûôy.h
>

16 
	~<löux/nŸifõr.h
>

17 
	~<löux/h¨dúq.h
>

18 
	~<löux/k¥obes.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kdebug.h
>

21 
	~<löux/sched.h
>

22 
	~<löux/uac˚ss.h
>

23 
	~<löux/highmem.h
>

24 
	~<löux/˝u.h
>

26 
	~<asm/≠ic.h
>

27 
	~<asm/°ackåa˚.h
>

28 
	~<asm/nmi.h
>

30 
u64
 
≥rf_evít_mask
 
	g__ªad_mo°ly
;

33 
	#MAX_PEBS_EVENTS
 4

	)

36 
	#BTS_RECORD_SIZE
 24

	)

39 
	#BTS_BUFFER_SIZE
 (
BTS_RECORD_SIZE
 * 2048)

	)

42 
	#BTS_OVFL_TH
 (
BTS_RECORD_SIZE
 * 128)

	)

48 
	#X86_DEBUGCTL_TR
 (1 << 6)

	)

49 
	#X86_DEBUGCTL_BTS
 (1 << 7)

	)

50 
	#X86_DEBUGCTL_BTINT
 (1 << 8)

	)

51 
	#X86_DEBUGCTL_BTS_OFF_OS
 (1 << 9)

	)

52 
	#X86_DEBUGCTL_BTS_OFF_USR
 (1 << 10)

	)

59 
	sdebug_°‹e
 {

60 
u64
 
	mbts_buf„r_ba£
;

61 
u64
 
	mbts_ödex
;

62 
u64
 
	mbts_absﬁuã_maximum
;

63 
u64
 
	mbts_öãºu±_thªshﬁd
;

64 
u64
 
	m≥bs_buf„r_ba£
;

65 
u64
 
	m≥bs_ödex
;

66 
u64
 
	m≥bs_absﬁuã_maximum
;

67 
u64
 
	m≥bs_öãºu±_thªshﬁd
;

68 
u64
 
	m≥bs_evít_ª£t
[
MAX_PEBS_EVENTS
];

71 
	s˝u_hw_evíts
 {

72 
≥rf_evít
 *
	mevíts
[
X86_PMC_IDX_MAX
];

73 
	mu£d_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

74 
	ma˘ive_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

75 
	möãºu±s
;

76 
	míabÀd
;

77 
debug_°‹e
 *
	mds
;

83 
	sx86_pmu
 {

84 c⁄° *
	m«me
;

85 
	mvîsi⁄
;

86 (*
	mh™dÀ_úq
)(
	m±_ªgs
 *);

87 (*
	mdißbÀ_Æl
)();

88 (*
	míabÀ_Æl
)();

89 (*
	míabÀ
)(
	mhw_≥rf_evít
 *, );

90 (*
	mdißbÀ
)(
	mhw_≥rf_evít
 *, );

91 
	mevít£l
;

92 
	m≥rf˘r
;

93 
u64
 (*
evít_m≠
)();

94 
u64
 (*
øw_evít
)(
	mu64
);

95 
	mmax_evíts
;

96 
	mnum_evíts
;

97 
	mnum_evíts_fixed
;

98 
	mevít_bôs
;

99 
u64
 
	mevít_mask
;

100 
	m≠ic
;

101 
u64
 
	mmax_≥riod
;

102 
u64
 
	möãl_˘æ
;

103 (*
	míabÀ_bts
)(
u64
 
	mc⁄fig
);

104 (*
	mdißbÀ_bts
)();

107 
x86_pmu
 x86_pmu 
	g__ªad_mo°ly
;

109 
DEFINE_PER_CPU
(
˝u_hw_evíts
, cpu_hw_events) = {

110 .
íabÀd
 = 1,

116 c⁄° 
u64
 
	gp6_≥rfm⁄_evít_m≠
[] =

118 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0079,

119 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

120 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0f2e,

121 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x012e,

122 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

123 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

124 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x0062,

127 
u64
 
	$p6_pmu_evít_m≠
(
hw_evít
)

129  
p6_≥rfm⁄_evít_m≠
[
hw_evít
];

130 
	}
}

138 
	#P6_NOP_EVENT
 0x0000002EULL

	)

140 
u64
 
	$p6_pmu_øw_evít
(
u64
 
hw_evít
)

142 
	#P6_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

143 
	#P6_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

144 
	#P6_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

145 
	#P6_EVNTSEL_INV_MASK
 0x00800000ULL

	)

146 
	#P6_EVNTSEL_REG_MASK
 0xFF000000ULL

	)

148 
	#P6_EVNTSEL_MASK
 \

149 (
P6_EVNTSEL_EVENT_MASK
 | \

150 
P6_EVNTSEL_UNIT_MASK
 | \

151 
P6_EVNTSEL_EDGE_MASK
 | \

152 
P6_EVNTSEL_INV_MASK
 | \

153 
P6_EVNTSEL_REG_MASK
)

	)

155  
hw_evít
 & 
P6_EVNTSEL_MASK
;

156 
	}
}

162 c⁄° 
u64
 
	göãl_≥rfm⁄_evít_m≠
[] =

164 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x003c,

165 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

166 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x4f2e,

167 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x412e,

168 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

169 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

170 [
PERF_COUNT_HW_BUS_CYCLES
] = 0x013c,

173 
u64
 
	$öãl_pmu_evít_m≠
(
hw_evít
)

175  
öãl_≥rfm⁄_evít_m≠
[
hw_evít
];

176 
	}
}

186 
	#C
(
x
Ë
PERF_COUNT_HW_CACHE_
##
	)
x

188 
u64
 
__ªad_mo°ly
 
	ghw_ˇche_evít_ids


189 [
PERF_COUNT_HW_CACHE_MAX
]

190 [
PERF_COUNT_HW_CACHE_OP_MAX
]

191 [
PERF_COUNT_HW_CACHE_RESULT_MAX
];

193 c⁄° 
u64
 
	g√hÆem_hw_ˇche_evít_ids


194 [
PERF_COUNT_HW_CACHE_MAX
]

195 [
PERF_COUNT_HW_CACHE_OP_MAX
]

196 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

198 [ 
C
(
L1D
) ] = {

199 [ 
C
(
OP_READ
) ] = {

200 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

201 [ 
C
(
RESULT_MISS
) ] = 0x0140,

203 [ 
C
(
OP_WRITE
) ] = {

204 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

205 [ 
C
(
RESULT_MISS
) ] = 0x0141,

207 [ 
C
(
OP_PREFETCH
) ] = {

208 [ 
C
(
RESULT_ACCESS
) ] = 0x014e,

209 [ 
C
(
RESULT_MISS
) ] = 0x024e,

212 [ 
C
(
L1I
 ) ] = {

213 [ 
C
(
OP_READ
) ] = {

214 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

215 [ 
C
(
RESULT_MISS
) ] = 0x0280,

217 [ 
C
(
OP_WRITE
) ] = {

218 [ 
C
(
RESULT_ACCESS
) ] = -1,

219 [ 
C
(
RESULT_MISS
) ] = -1,

221 [ 
C
(
OP_PREFETCH
) ] = {

222 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

223 [ 
C
(
RESULT_MISS
) ] = 0x0,

226 [ 
C
(
LL
 ) ] = {

227 [ 
C
(
OP_READ
) ] = {

228 [ 
C
(
RESULT_ACCESS
) ] = 0x0324,

229 [ 
C
(
RESULT_MISS
) ] = 0x0224,

231 [ 
C
(
OP_WRITE
) ] = {

232 [ 
C
(
RESULT_ACCESS
) ] = 0x0c24,

233 [ 
C
(
RESULT_MISS
) ] = 0x0824,

235 [ 
C
(
OP_PREFETCH
) ] = {

236 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2e,

237 [ 
C
(
RESULT_MISS
) ] = 0x412e,

240 [ 
C
(
DTLB
) ] = {

241 [ 
C
(
OP_READ
) ] = {

242 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

243 [ 
C
(
RESULT_MISS
) ] = 0x0108,

245 [ 
C
(
OP_WRITE
) ] = {

246 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

247 [ 
C
(
RESULT_MISS
) ] = 0x010c,

249 [ 
C
(
OP_PREFETCH
) ] = {

250 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

251 [ 
C
(
RESULT_MISS
) ] = 0x0,

254 [ 
C
(
ITLB
) ] = {

255 [ 
C
(
OP_READ
) ] = {

256 [ 
C
(
RESULT_ACCESS
) ] = 0x01c0,

257 [ 
C
(
RESULT_MISS
) ] = 0x20c8,

259 [ 
C
(
OP_WRITE
) ] = {

260 [ 
C
(
RESULT_ACCESS
) ] = -1,

261 [ 
C
(
RESULT_MISS
) ] = -1,

263 [ 
C
(
OP_PREFETCH
) ] = {

264 [ 
C
(
RESULT_ACCESS
) ] = -1,

265 [ 
C
(
RESULT_MISS
) ] = -1,

268 [ 
C
(
BPU
 ) ] = {

269 [ 
C
(
OP_READ
) ] = {

270 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

271 [ 
C
(
RESULT_MISS
) ] = 0x03e8,

273 [ 
C
(
OP_WRITE
) ] = {

274 [ 
C
(
RESULT_ACCESS
) ] = -1,

275 [ 
C
(
RESULT_MISS
) ] = -1,

277 [ 
C
(
OP_PREFETCH
) ] = {

278 [ 
C
(
RESULT_ACCESS
) ] = -1,

279 [ 
C
(
RESULT_MISS
) ] = -1,

284 c⁄° 
u64
 
	gc‹e2_hw_ˇche_evít_ids


285 [
PERF_COUNT_HW_CACHE_MAX
]

286 [
PERF_COUNT_HW_CACHE_OP_MAX
]

287 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

289 [ 
C
(
L1D
) ] = {

290 [ 
C
(
OP_READ
) ] = {

291 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

292 [ 
C
(
RESULT_MISS
) ] = 0x0140,

294 [ 
C
(
OP_WRITE
) ] = {

295 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

296 [ 
C
(
RESULT_MISS
) ] = 0x0141,

298 [ 
C
(
OP_PREFETCH
) ] = {

299 [ 
C
(
RESULT_ACCESS
) ] = 0x104e,

300 [ 
C
(
RESULT_MISS
) ] = 0,

303 [ 
C
(
L1I
 ) ] = {

304 [ 
C
(
OP_READ
) ] = {

305 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

306 [ 
C
(
RESULT_MISS
) ] = 0x0081,

308 [ 
C
(
OP_WRITE
) ] = {

309 [ 
C
(
RESULT_ACCESS
) ] = -1,

310 [ 
C
(
RESULT_MISS
) ] = -1,

312 [ 
C
(
OP_PREFETCH
) ] = {

313 [ 
C
(
RESULT_ACCESS
) ] = 0,

314 [ 
C
(
RESULT_MISS
) ] = 0,

317 [ 
C
(
LL
 ) ] = {

318 [ 
C
(
OP_READ
) ] = {

319 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

320 [ 
C
(
RESULT_MISS
) ] = 0x4129,

322 [ 
C
(
OP_WRITE
) ] = {

323 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

324 [ 
C
(
RESULT_MISS
) ] = 0x412A,

326 [ 
C
(
OP_PREFETCH
) ] = {

327 [ 
C
(
RESULT_ACCESS
) ] = 0,

328 [ 
C
(
RESULT_MISS
) ] = 0,

331 [ 
C
(
DTLB
) ] = {

332 [ 
C
(
OP_READ
) ] = {

333 [ 
C
(
RESULT_ACCESS
) ] = 0x0f40,

334 [ 
C
(
RESULT_MISS
) ] = 0x0208,

336 [ 
C
(
OP_WRITE
) ] = {

337 [ 
C
(
RESULT_ACCESS
) ] = 0x0f41,

338 [ 
C
(
RESULT_MISS
) ] = 0x0808,

340 [ 
C
(
OP_PREFETCH
) ] = {

341 [ 
C
(
RESULT_ACCESS
) ] = 0,

342 [ 
C
(
RESULT_MISS
) ] = 0,

345 [ 
C
(
ITLB
) ] = {

346 [ 
C
(
OP_READ
) ] = {

347 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

348 [ 
C
(
RESULT_MISS
) ] = 0x1282,

350 [ 
C
(
OP_WRITE
) ] = {

351 [ 
C
(
RESULT_ACCESS
) ] = -1,

352 [ 
C
(
RESULT_MISS
) ] = -1,

354 [ 
C
(
OP_PREFETCH
) ] = {

355 [ 
C
(
RESULT_ACCESS
) ] = -1,

356 [ 
C
(
RESULT_MISS
) ] = -1,

359 [ 
C
(
BPU
 ) ] = {

360 [ 
C
(
OP_READ
) ] = {

361 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

362 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

364 [ 
C
(
OP_WRITE
) ] = {

365 [ 
C
(
RESULT_ACCESS
) ] = -1,

366 [ 
C
(
RESULT_MISS
) ] = -1,

368 [ 
C
(
OP_PREFETCH
) ] = {

369 [ 
C
(
RESULT_ACCESS
) ] = -1,

370 [ 
C
(
RESULT_MISS
) ] = -1,

375 c⁄° 
u64
 
	g©om_hw_ˇche_evít_ids


376 [
PERF_COUNT_HW_CACHE_MAX
]

377 [
PERF_COUNT_HW_CACHE_OP_MAX
]

378 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

380 [ 
C
(
L1D
) ] = {

381 [ 
C
(
OP_READ
) ] = {

382 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

383 [ 
C
(
RESULT_MISS
) ] = 0,

385 [ 
C
(
OP_WRITE
) ] = {

386 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

387 [ 
C
(
RESULT_MISS
) ] = 0,

389 [ 
C
(
OP_PREFETCH
) ] = {

390 [ 
C
(
RESULT_ACCESS
) ] = 0x0,

391 [ 
C
(
RESULT_MISS
) ] = 0,

394 [ 
C
(
L1I
 ) ] = {

395 [ 
C
(
OP_READ
) ] = {

396 [ 
C
(
RESULT_ACCESS
) ] = 0x0380,

397 [ 
C
(
RESULT_MISS
) ] = 0x0280,

399 [ 
C
(
OP_WRITE
) ] = {

400 [ 
C
(
RESULT_ACCESS
) ] = -1,

401 [ 
C
(
RESULT_MISS
) ] = -1,

403 [ 
C
(
OP_PREFETCH
) ] = {

404 [ 
C
(
RESULT_ACCESS
) ] = 0,

405 [ 
C
(
RESULT_MISS
) ] = 0,

408 [ 
C
(
LL
 ) ] = {

409 [ 
C
(
OP_READ
) ] = {

410 [ 
C
(
RESULT_ACCESS
) ] = 0x4f29,

411 [ 
C
(
RESULT_MISS
) ] = 0x4129,

413 [ 
C
(
OP_WRITE
) ] = {

414 [ 
C
(
RESULT_ACCESS
) ] = 0x4f2A,

415 [ 
C
(
RESULT_MISS
) ] = 0x412A,

417 [ 
C
(
OP_PREFETCH
) ] = {

418 [ 
C
(
RESULT_ACCESS
) ] = 0,

419 [ 
C
(
RESULT_MISS
) ] = 0,

422 [ 
C
(
DTLB
) ] = {

423 [ 
C
(
OP_READ
) ] = {

424 [ 
C
(
RESULT_ACCESS
) ] = 0x2140,

425 [ 
C
(
RESULT_MISS
) ] = 0x0508,

427 [ 
C
(
OP_WRITE
) ] = {

428 [ 
C
(
RESULT_ACCESS
) ] = 0x2240,

429 [ 
C
(
RESULT_MISS
) ] = 0x0608,

431 [ 
C
(
OP_PREFETCH
) ] = {

432 [ 
C
(
RESULT_ACCESS
) ] = 0,

433 [ 
C
(
RESULT_MISS
) ] = 0,

436 [ 
C
(
ITLB
) ] = {

437 [ 
C
(
OP_READ
) ] = {

438 [ 
C
(
RESULT_ACCESS
) ] = 0x00c0,

439 [ 
C
(
RESULT_MISS
) ] = 0x0282,

441 [ 
C
(
OP_WRITE
) ] = {

442 [ 
C
(
RESULT_ACCESS
) ] = -1,

443 [ 
C
(
RESULT_MISS
) ] = -1,

445 [ 
C
(
OP_PREFETCH
) ] = {

446 [ 
C
(
RESULT_ACCESS
) ] = -1,

447 [ 
C
(
RESULT_MISS
) ] = -1,

450 [ 
C
(
BPU
 ) ] = {

451 [ 
C
(
OP_READ
) ] = {

452 [ 
C
(
RESULT_ACCESS
) ] = 0x00c4,

453 [ 
C
(
RESULT_MISS
) ] = 0x00c5,

455 [ 
C
(
OP_WRITE
) ] = {

456 [ 
C
(
RESULT_ACCESS
) ] = -1,

457 [ 
C
(
RESULT_MISS
) ] = -1,

459 [ 
C
(
OP_PREFETCH
) ] = {

460 [ 
C
(
RESULT_ACCESS
) ] = -1,

461 [ 
C
(
RESULT_MISS
) ] = -1,

466 
u64
 
	$öãl_pmu_øw_evít
(
u64
 
hw_evít
)

468 
	#CORE_EVNTSEL_EVENT_MASK
 0x000000FFULL

	)

469 
	#CORE_EVNTSEL_UNIT_MASK
 0x0000FF00ULL

	)

470 
	#CORE_EVNTSEL_EDGE_MASK
 0x00040000ULL

	)

471 
	#CORE_EVNTSEL_INV_MASK
 0x00800000ULL

	)

472 
	#CORE_EVNTSEL_REG_MASK
 0xFF000000ULL

	)

474 
	#CORE_EVNTSEL_MASK
 \

475 (
CORE_EVNTSEL_EVENT_MASK
 | \

476 
CORE_EVNTSEL_UNIT_MASK
 | \

477 
CORE_EVNTSEL_EDGE_MASK
 | \

478 
CORE_EVNTSEL_INV_MASK
 | \

479 
CORE_EVNTSEL_REG_MASK
)

	)

481  
hw_evít
 & 
CORE_EVNTSEL_MASK
;

482 
	}
}

484 c⁄° 
u64
 
	gamd_hw_ˇche_evít_ids


485 [
PERF_COUNT_HW_CACHE_MAX
]

486 [
PERF_COUNT_HW_CACHE_OP_MAX
]

487 [
PERF_COUNT_HW_CACHE_RESULT_MAX
] =

489 [ 
C
(
L1D
) ] = {

490 [ 
C
(
OP_READ
) ] = {

491 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

492 [ 
C
(
RESULT_MISS
) ] = 0x0041,

494 [ 
C
(
OP_WRITE
) ] = {

495 [ 
C
(
RESULT_ACCESS
) ] = 0x0142,

496 [ 
C
(
RESULT_MISS
) ] = 0,

498 [ 
C
(
OP_PREFETCH
) ] = {

499 [ 
C
(
RESULT_ACCESS
) ] = 0x0267,

500 [ 
C
(
RESULT_MISS
) ] = 0x0167,

503 [ 
C
(
L1I
 ) ] = {

504 [ 
C
(
OP_READ
) ] = {

505 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

506 [ 
C
(
RESULT_MISS
) ] = 0x0081,

508 [ 
C
(
OP_WRITE
) ] = {

509 [ 
C
(
RESULT_ACCESS
) ] = -1,

510 [ 
C
(
RESULT_MISS
) ] = -1,

512 [ 
C
(
OP_PREFETCH
) ] = {

513 [ 
C
(
RESULT_ACCESS
) ] = 0x014B,

514 [ 
C
(
RESULT_MISS
) ] = 0,

517 [ 
C
(
LL
 ) ] = {

518 [ 
C
(
OP_READ
) ] = {

519 [ 
C
(
RESULT_ACCESS
) ] = 0x037D,

520 [ 
C
(
RESULT_MISS
) ] = 0x037E,

522 [ 
C
(
OP_WRITE
) ] = {

523 [ 
C
(
RESULT_ACCESS
) ] = 0x017F,

524 [ 
C
(
RESULT_MISS
) ] = 0,

526 [ 
C
(
OP_PREFETCH
) ] = {

527 [ 
C
(
RESULT_ACCESS
) ] = 0,

528 [ 
C
(
RESULT_MISS
) ] = 0,

531 [ 
C
(
DTLB
) ] = {

532 [ 
C
(
OP_READ
) ] = {

533 [ 
C
(
RESULT_ACCESS
) ] = 0x0040,

534 [ 
C
(
RESULT_MISS
) ] = 0x0046,

536 [ 
C
(
OP_WRITE
) ] = {

537 [ 
C
(
RESULT_ACCESS
) ] = 0,

538 [ 
C
(
RESULT_MISS
) ] = 0,

540 [ 
C
(
OP_PREFETCH
) ] = {

541 [ 
C
(
RESULT_ACCESS
) ] = 0,

542 [ 
C
(
RESULT_MISS
) ] = 0,

545 [ 
C
(
ITLB
) ] = {

546 [ 
C
(
OP_READ
) ] = {

547 [ 
C
(
RESULT_ACCESS
) ] = 0x0080,

548 [ 
C
(
RESULT_MISS
) ] = 0x0085,

550 [ 
C
(
OP_WRITE
) ] = {

551 [ 
C
(
RESULT_ACCESS
) ] = -1,

552 [ 
C
(
RESULT_MISS
) ] = -1,

554 [ 
C
(
OP_PREFETCH
) ] = {

555 [ 
C
(
RESULT_ACCESS
) ] = -1,

556 [ 
C
(
RESULT_MISS
) ] = -1,

559 [ 
C
(
BPU
 ) ] = {

560 [ 
C
(
OP_READ
) ] = {

561 [ 
C
(
RESULT_ACCESS
) ] = 0x00c2,

562 [ 
C
(
RESULT_MISS
) ] = 0x00c3,

564 [ 
C
(
OP_WRITE
) ] = {

565 [ 
C
(
RESULT_ACCESS
) ] = -1,

566 [ 
C
(
RESULT_MISS
) ] = -1,

568 [ 
C
(
OP_PREFETCH
) ] = {

569 [ 
C
(
RESULT_ACCESS
) ] = -1,

570 [ 
C
(
RESULT_MISS
) ] = -1,

578 c⁄° 
u64
 
	gamd_≥rfm⁄_evít_m≠
[] =

580 [
PERF_COUNT_HW_CPU_CYCLES
] = 0x0076,

581 [
PERF_COUNT_HW_INSTRUCTIONS
] = 0x00c0,

582 [
PERF_COUNT_HW_CACHE_REFERENCES
] = 0x0080,

583 [
PERF_COUNT_HW_CACHE_MISSES
] = 0x0081,

584 [
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
] = 0x00c4,

585 [
PERF_COUNT_HW_BRANCH_MISSES
] = 0x00c5,

588 
u64
 
	$amd_pmu_evít_m≠
(
hw_evít
)

590  
amd_≥rfm⁄_evít_m≠
[
hw_evít
];

591 
	}
}

593 
u64
 
	$amd_pmu_øw_evít
(
u64
 
hw_evít
)

595 
	#K7_EVNTSEL_EVENT_MASK
 0x7000000FFULL

	)

596 
	#K7_EVNTSEL_UNIT_MASK
 0x00000FF00ULL

	)

597 
	#K7_EVNTSEL_EDGE_MASK
 0x000040000ULL

	)

598 
	#K7_EVNTSEL_INV_MASK
 0x000800000ULL

	)

599 
	#K7_EVNTSEL_REG_MASK
 0x0FF000000ULL

	)

601 
	#K7_EVNTSEL_MASK
 \

602 (
K7_EVNTSEL_EVENT_MASK
 | \

603 
K7_EVNTSEL_UNIT_MASK
 | \

604 
K7_EVNTSEL_EDGE_MASK
 | \

605 
K7_EVNTSEL_INV_MASK
 | \

606 
K7_EVNTSEL_REG_MASK
)

	)

608  
hw_evít
 & 
K7_EVNTSEL_MASK
;

609 
	}
}

616 
u64


617 
	$x86_≥rf_evít_upd©e
(
≥rf_evít
 *
evít
,

618 
hw_≥rf_evít
 *
hwc
, 
idx
)

620 
shi·
 = 64 - 
x86_pmu
.
evít_bôs
;

621 
u64
 
¥ev_øw_cou¡
, 
√w_øw_cou¡
;

622 
s64
 
dñè
;

624 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

634 
agaö
:

635 
¥ev_øw_cou¡
 = 
	`©omic64_ªad
(&
hwc
->
¥ev_cou¡
);

636 
	`rdm§l
(
hwc
->
evít_ba£
 + 
idx
, 
√w_øw_cou¡
);

638 i‡(
	`©omic64_cmpxchg
(&
hwc
->
¥ev_cou¡
, 
¥ev_øw_cou¡
,

639 
√w_øw_cou¡
Ë!
¥ev_øw_cou¡
)

640 
agaö
;

650 
dñè
 = (
√w_øw_cou¡
 << 
shi·
Ë- (
¥ev_øw_cou¡
 << shift);

651 
dñè
 >>
shi·
;

653 
	`©omic64_add
(
dñè
, &
evít
->
cou¡
);

654 
	`©omic64_sub
(
dñè
, &
hwc
->
≥riod_À·
);

656  
√w_øw_cou¡
;

657 
	}
}

659 
©omic_t
 
	ga˘ive_evíts
;

660 
DEFINE_MUTEX
(
pmc_ª£rve_muãx
);

662 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
()

664 #ifde‡
CONFIG_X86_LOCAL_APIC


665 
i
;

667 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

668 
	`dißbÀ_œpic_nmi_w©chdog
();

670 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

671 i‡(!
	`ª£rve_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
))

672 
≥rf˘r_Áû
;

675 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

676 i‡(!
	`ª£rve_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
))

677 
evít£l_Áû
;

681  
åue
;

683 #ifde‡
CONFIG_X86_LOCAL_APIC


684 
evít£l_Áû
:

685 
i
--; i >= 0; i--)

686 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

688 
i
 = 
x86_pmu
.
num_evíts
;

690 
≥rf˘r_Áû
:

691 
i
--; i >= 0; i--)

692 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

694 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

695 
	`íabÀ_œpic_nmi_w©chdog
();

697  
Ál£
;

699 
	}
}

701 
	$ªÀa£_pmc_h¨dw¨e
()

703 #ifde‡
CONFIG_X86_LOCAL_APIC


704 
i
;

706 
i
 = 0; i < 
x86_pmu
.
num_evíts
; i++) {

707 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

708 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

711 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

712 
	`íabÀ_œpic_nmi_w©chdog
();

714 
	}
}

716 
ölöe
 
boﬁ
 
	$bts_avaûabÀ
()

718  
x86_pmu
.
íabÀ_bts
 !
NULL
;

719 
	}
}

721 
ölöe
 
	$öô_debug_°‹e_⁄_˝u
(
˝u
)

723 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

725 i‡(!
ds
)

728 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
,

729 (
u32
)((
u64
)()
ds
),

730 (
u32
)((
u64
)()
ds
 >> 32));

731 
	}
}

733 
ölöe
 
	$föi_debug_°‹e_⁄_˝u
(
˝u
)

735 i‡(!
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
)

738 
	`wrm§_⁄_˝u
(
˝u
, 
MSR_IA32_DS_AREA
, 0, 0);

739 
	}
}

741 
	$ªÀa£_bts_h¨dw¨e
()

743 
˝u
;

745 i‡(!
	`bts_avaûabÀ
())

748 
	`gë_⁄löe_˝us
();

750 
	`f‹_óch_⁄löe_˝u
(
˝u
)

751 
	`föi_debug_°‹e_⁄_˝u
(
˝u
);

753 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

754 
debug_°‹e
 *
ds
 = 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).ds;

756 i‡(!
ds
)

759 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = 
NULL
;

761 
	`k‰ì
((*)()
ds
->
bts_buf„r_ba£
);

762 
	`k‰ì
(
ds
);

765 
	`put_⁄löe_˝us
();

766 
	}
}

768 
	$ª£rve_bts_h¨dw¨e
()

770 
˝u
, 
îr
 = 0;

772 i‡(!
	`bts_avaûabÀ
())

775 
	`gë_⁄löe_˝us
();

777 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

778 
debug_°‹e
 *
ds
;

779 *
buf„r
;

781 
îr
 = -
ENOMEM
;

782 
buf„r
 = 
	`kzÆloc
(
BTS_BUFFER_SIZE
, 
GFP_KERNEL
);

783 i‡(
	`u∆ikñy
(!
buf„r
))

786 
ds
 = 
	`kzÆloc
((*ds), 
GFP_KERNEL
);

787 i‡(
	`u∆ikñy
(!
ds
)) {

788 
	`k‰ì
(
buf„r
);

792 
ds
->
bts_buf„r_ba£
 = (
u64
)()
buf„r
;

793 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

794 
ds
->
bts_absﬁuã_maximum
 =

795 
ds
->
bts_buf„r_ba£
 + 
BTS_BUFFER_SIZE
;

796 
ds
->
bts_öãºu±_thªshﬁd
 =

797 
ds
->
bts_absﬁuã_maximum
 - 
BTS_OVFL_TH
;

799 
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
).
ds
 = ds;

800 
îr
 = 0;

803 i‡(
îr
)

804 
	`ªÀa£_bts_h¨dw¨e
();

806 
	`f‹_óch_⁄löe_˝u
(
˝u
)

807 
	`öô_debug_°‹e_⁄_˝u
(
˝u
);

810 
	`put_⁄löe_˝us
();

812  
îr
;

813 
	}
}

815 
	$hw_≥rf_evít_de°roy
(
≥rf_evít
 *
evít
)

817 i‡(
	`©omic_dec_™d_muãx_lock
(&
a˘ive_evíts
, &
pmc_ª£rve_muãx
)) {

818 
	`ªÀa£_pmc_h¨dw¨e
();

819 
	`ªÀa£_bts_h¨dw¨e
();

820 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

822 
	}
}

824 
ölöe
 
	$x86_pmu_öôülized
()

826  
x86_pmu
.
h™dÀ_úq
 !
NULL
;

827 
	}
}

829 
ölöe
 

830 
	$£t_ext_hw_©å
(
hw_≥rf_evít
 *
hwc
, 
≥rf_evít_©å
 *
©å
)

832 
ˇche_ty≥
, 
ˇche_›
, 
ˇche_ªsu…
;

833 
u64
 
c⁄fig
, 
vÆ
;

835 
c⁄fig
 = 
©å
->config;

837 
ˇche_ty≥
 = (
c⁄fig
 >> 0) & 0xff;

838 i‡(
ˇche_ty≥
 >
PERF_COUNT_HW_CACHE_MAX
)

839  -
EINVAL
;

841 
ˇche_›
 = (
c⁄fig
 >> 8) & 0xff;

842 i‡(
ˇche_›
 >
PERF_COUNT_HW_CACHE_OP_MAX
)

843  -
EINVAL
;

845 
ˇche_ªsu…
 = (
c⁄fig
 >> 16) & 0xff;

846 i‡(
ˇche_ªsu…
 >
PERF_COUNT_HW_CACHE_RESULT_MAX
)

847  -
EINVAL
;

849 
vÆ
 = 
hw_ˇche_evít_ids
[
ˇche_ty≥
][
ˇche_›
][
ˇche_ªsu…
];

851 i‡(
vÆ
 == 0)

852  -
ENOENT
;

854 i‡(
vÆ
 == -1)

855  -
EINVAL
;

857 
hwc
->
c⁄fig
 |
vÆ
;

860 
	}
}

862 
	$öãl_pmu_íabÀ_bts
(
u64
 
c⁄fig
)

864 
debug˘lm§
;

866 
debug˘lm§
 = 
	`gë_debug˘lm§
();

868 
debug˘lm§
 |
X86_DEBUGCTL_TR
;

869 
debug˘lm§
 |
X86_DEBUGCTL_BTS
;

870 
debug˘lm§
 |
X86_DEBUGCTL_BTINT
;

872 i‡(!(
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
))

873 
debug˘lm§
 |
X86_DEBUGCTL_BTS_OFF_OS
;

875 i‡(!(
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_USR
))

876 
debug˘lm§
 |
X86_DEBUGCTL_BTS_OFF_USR
;

878 
	`upd©e_debug˘lm§
(
debug˘lm§
);

879 
	}
}

881 
	$öãl_pmu_dißbÀ_bts
()

883 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

884 
debug˘lm§
;

886 i‡(!
˝uc
->
ds
)

889 
debug˘lm§
 = 
	`gë_debug˘lm§
();

891 
debug˘lm§
 &=

892 ~(
X86_DEBUGCTL_TR
 | 
X86_DEBUGCTL_BTS
 | 
X86_DEBUGCTL_BTINT
 |

893 
X86_DEBUGCTL_BTS_OFF_OS
 | 
X86_DEBUGCTL_BTS_OFF_USR
);

895 
	`upd©e_debug˘lm§
(
debug˘lm§
);

896 
	}
}

901 
	$__hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

903 
≥rf_evít_©å
 *
©å
 = &
evít
->attr;

904 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

905 
u64
 
c⁄fig
;

906 
îr
;

908 i‡(!
	`x86_pmu_öôülized
())

909  -
ENODEV
;

911 
îr
 = 0;

912 i‡(!
	`©omic_öc_nŸ_zîo
(&
a˘ive_evíts
)) {

913 
	`muãx_lock
(&
pmc_ª£rve_muãx
);

914 i‡(
	`©omic_ªad
(&
a˘ive_evíts
) == 0) {

915 i‡(!
	`ª£rve_pmc_h¨dw¨e
())

916 
îr
 = -
EBUSY
;

918 
îr
 = 
	`ª£rve_bts_h¨dw¨e
();

920 i‡(!
îr
)

921 
	`©omic_öc
(&
a˘ive_evíts
);

922 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

924 i‡(
îr
)

925  
îr
;

927 
evít
->
de°roy
 = 
hw_≥rf_evít_de°roy
;

933 
hwc
->
c⁄fig
 = 
ARCH_PERFMON_EVENTSEL_INT
;

938 i‡(!
©å
->
ex˛ude_u£r
)

939 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_USR
;

940 i‡(!
©å
->
ex˛ude_kî√l
)

941 
hwc
->
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_OS
;

943 i‡(!
hwc
->
ßm∂e_≥riod
) {

944 
hwc
->
ßm∂e_≥riod
 = 
x86_pmu
.
max_≥riod
;

945 
hwc
->
œ°_≥riod
 = hwc->
ßm∂e_≥riod
;

946 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, hwc->
ßm∂e_≥riod
);

954 i‡(!
x86_pmu
.
≠ic
)

955  -
EOPNOTSUPP
;

961 i‡(
©å
->
ty≥
 =
PERF_TYPE_RAW
) {

962 
hwc
->
c⁄fig
 |
x86_pmu
.
	`øw_evít
(
©å
->config);

966 i‡(
©å
->
ty≥
 =
PERF_TYPE_HW_CACHE
)

967  
	`£t_ext_hw_©å
(
hwc
, 
©å
);

969 i‡(
©å
->
c⁄fig
 >
x86_pmu
.
max_evíts
)

970  -
EINVAL
;

975 
c⁄fig
 = 
x86_pmu
.
	`evít_m≠
(
©å
->config);

977 i‡(
c⁄fig
 == 0)

978  -
ENOENT
;

980 i‡(
c⁄fig
 == -1LL)

981  -
EINVAL
;

986 i‡((
©å
->
c⁄fig
 =
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
) &&

987 (
hwc
->
ßm∂e_≥riod
 == 1)) {

989 i‡(!
	`bts_avaûabÀ
())

990  -
EOPNOTSUPP
;

993 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

994  -
EOPNOTSUPP
;

997 
hwc
->
c⁄fig
 |= config;

1000 
	}
}

1002 
	$p6_pmu_dißbÀ_Æl
()

1004 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1005 
u64
 
vÆ
;

1007 i‡(!
˝uc
->
íabÀd
)

1010 
˝uc
->
íabÀd
 = 0;

1011 
	`b¨rõr
();

1014 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1015 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1016 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1017 
	}
}

1019 
	$öãl_pmu_dißbÀ_Æl
()

1021 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1023 i‡(!
˝uc
->
íabÀd
)

1026 
˝uc
->
íabÀd
 = 0;

1027 
	`b¨rõr
();

1029 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 0);

1031 i‡(
	`ã°_bô
(
X86_PMC_IDX_FIXED_BTS
, 
˝uc
->
a˘ive_mask
))

1032 
	`öãl_pmu_dißbÀ_bts
();

1033 
	}
}

1035 
	$amd_pmu_dißbÀ_Æl
()

1037 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1038 
idx
;

1040 i‡(!
˝uc
->
íabÀd
)

1043 
˝uc
->
íabÀd
 = 0;

1049 
	`b¨rõr
();

1051 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1052 
u64
 
vÆ
;

1054 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1056 
	`rdm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1057 i‡(!(
vÆ
 & 
ARCH_PERFMON_EVENTSEL0_ENABLE
))

1059 
vÆ
 &~
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1060 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1062 
	}
}

1064 
	$hw_≥rf_dißbÀ
()

1066 i‡(!
	`x86_pmu_öôülized
())

1068  
x86_pmu
.
	`dißbÀ_Æl
();

1069 
	}
}

1071 
	$p6_pmu_íabÀ_Æl
()

1073 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1074 
vÆ
;

1076 i‡(
˝uc
->
íabÀd
)

1079 
˝uc
->
íabÀd
 = 1;

1080 
	`b¨rõr
();

1083 
	`rdm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1084 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1085 
	`wrm§l
(
MSR_P6_EVNTSEL0
, 
vÆ
);

1086 
	}
}

1088 
	$öãl_pmu_íabÀ_Æl
()

1090 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1092 i‡(
˝uc
->
íabÀd
)

1095 
˝uc
->
íabÀd
 = 1;

1096 
	`b¨rõr
();

1098 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
x86_pmu
.
öãl_˘æ
);

1100 i‡(
	`ã°_bô
(
X86_PMC_IDX_FIXED_BTS
, 
˝uc
->
a˘ive_mask
)) {

1101 
≥rf_evít
 *
evít
 =

1102 
˝uc
->
evíts
[
X86_PMC_IDX_FIXED_BTS
];

1104 i‡(
	`WARN_ON_ONCE
(!
evít
))

1107 
	`öãl_pmu_íabÀ_bts
(
evít
->
hw
.
c⁄fig
);

1109 
	}
}

1111 
	$amd_pmu_íabÀ_Æl
()

1113 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1114 
idx
;

1116 i‡(
˝uc
->
íabÀd
)

1119 
˝uc
->
íabÀd
 = 1;

1120 
	`b¨rõr
();

1122 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1123 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
idx
];

1124 
u64
 
vÆ
;

1126 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1129 
vÆ
 = 
evít
->
hw
.
c⁄fig
;

1130 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1131 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
idx
, 
vÆ
);

1133 
	}
}

1135 
	$hw_≥rf_íabÀ
()

1137 i‡(!
	`x86_pmu_öôülized
())

1139 
x86_pmu
.
	`íabÀ_Æl
();

1140 
	}
}

1142 
ölöe
 
u64
 
	$öãl_pmu_gë_°©us
()

1144 
u64
 
°©us
;

1146 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1148  
°©us
;

1149 
	}
}

1151 
ölöe
 
	$öãl_pmu_ack_°©us
(
u64
 
ack
)

1153 
	`wrm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ack
);

1154 
	}
}

1156 
ölöe
 
	$x86_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1158 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
,

1159 
hwc
->
c⁄fig
 | 
ARCH_PERFMON_EVENTSEL0_ENABLE
);

1160 
	}
}

1162 
ölöe
 
	$x86_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1164 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, hwc->
c⁄fig
);

1165 
	}
}

1167 
ölöe
 

1168 
	$öãl_pmu_dißbÀ_fixed
(
hw_≥rf_evít
 *
hwc
, 
__idx
)

1170 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

1171 
u64
 
˘æ_vÆ
, 
mask
;

1173 
mask
 = 0xfULL << (
idx
 * 4);

1175 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1176 
˘æ_vÆ
 &~
mask
;

1177 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1178 
	}
}

1180 
ölöe
 

1181 
	$p6_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1183 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1184 
u64
 
vÆ
 = 
P6_NOP_EVENT
;

1186 i‡(
˝uc
->
íabÀd
)

1187 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1189 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

1190 
	}
}

1192 
ölöe
 

1193 
	$öãl_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1195 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
)) {

1196 
	`öãl_pmu_dißbÀ_bts
();

1200 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

1201 
	`öãl_pmu_dißbÀ_fixed
(
hwc
, 
idx
);

1205 
	`x86_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1206 
	}
}

1208 
ölöe
 

1209 
	$amd_pmu_dißbÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1211 
	`x86_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1212 
	}
}

1214 
DEFINE_PER_CPU
(
u64
 [
X86_PMC_IDX_MAX
], 
pmc_¥ev_À·
);

1221 
	$x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
,

1222 
hw_≥rf_evít
 *
hwc
, 
idx
)

1224 
s64
 
À·
 = 
	`©omic64_ªad
(&
hwc
->
≥riod_À·
);

1225 
s64
 
≥riod
 = 
hwc
->
ßm∂e_≥riod
;

1226 
îr
, 
ªt
 = 0;

1228 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

1234 i‡(
	`u∆ikñy
(
À·
 <-
≥riod
)) {

1235 
À·
 = 
≥riod
;

1236 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

1237 
hwc
->
œ°_≥riod
 = 
≥riod
;

1238 
ªt
 = 1;

1241 i‡(
	`u∆ikñy
(
À·
 <= 0)) {

1242 
À·
 +
≥riod
;

1243 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

1244 
hwc
->
œ°_≥riod
 = 
≥riod
;

1245 
ªt
 = 1;

1250 i‡(
	`u∆ikñy
(
À·
 < 2))

1251 
À·
 = 2;

1253 i‡(
À·
 > 
x86_pmu
.
max_≥riod
)

1254 
À·
 = 
x86_pmu
.
max_≥riod
;

1256 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
	`smp_¥o˚ss‹_id
()Ë
À·
;

1262 
	`©omic64_£t
(&
hwc
->
¥ev_cou¡
, (
u64
)-
À·
);

1264 
îr
 = 
	`checkög_wrm§l
(
hwc
->
evít_ba£
 + 
idx
,

1265 (
u64
)(-
À·
Ë& 
x86_pmu
.
evít_mask
);

1267 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1269  
ªt
;

1270 
	}
}

1272 
ölöe
 

1273 
	$öãl_pmu_íabÀ_fixed
(
hw_≥rf_evít
 *
hwc
, 
__idx
)

1275 
idx
 = 
__idx
 - 
X86_PMC_IDX_FIXED
;

1276 
u64
 
˘æ_vÆ
, 
bôs
, 
mask
;

1277 
îr
;

1284 
bôs
 = 0x8ULL;

1285 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_USR
)

1286 
bôs
 |= 0x2;

1287 i‡(
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENTSEL_OS
)

1288 
bôs
 |= 0x1;

1289 
bôs
 <<(
idx
 * 4);

1290 
mask
 = 0xfULL << (
idx
 * 4);

1292 
	`rdm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1293 
˘æ_vÆ
 &~
mask
;

1294 
˘æ_vÆ
 |
bôs
;

1295 
îr
 = 
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
, 
˘æ_vÆ
);

1296 
	}
}

1298 
	$p6_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1300 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1301 
u64
 
vÆ
;

1303 
vÆ
 = 
hwc
->
c⁄fig
;

1304 i‡(
˝uc
->
íabÀd
)

1305 
vÆ
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

1307 ()
	`checkög_wrm§l
(
hwc
->
c⁄fig_ba£
 + 
idx
, 
vÆ
);

1308 
	}
}

1311 
	$öãl_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1313 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
)) {

1314 i‡(!
	`__gë_˝u_v¨
(
˝u_hw_evíts
).
íabÀd
)

1317 
	`öãl_pmu_íabÀ_bts
(
hwc
->
c⁄fig
);

1321 i‡(
	`u∆ikñy
(
hwc
->
c⁄fig_ba£
 =
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
)) {

1322 
	`öãl_pmu_íabÀ_fixed
(
hwc
, 
idx
);

1326 
	`x86_pmu_íabÀ_evít
(
hwc
, 
idx
);

1327 
	}
}

1329 
	$amd_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
, 
idx
)

1331 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1333 i‡(
˝uc
->
íabÀd
)

1334 
	`x86_pmu_íabÀ_evít
(
hwc
, 
idx
);

1335 
	}
}

1338 
	$fixed_mode_idx
(
≥rf_evít
 *
evít
, 
hw_≥rf_evít
 *
hwc
)

1340 
hw_evít
;

1342 
hw_evít
 = 
hwc
->
c⁄fig
 & 
ARCH_PERFMON_EVENT_MASK
;

1344 i‡(
	`u∆ikñy
((
hw_evít
 ==

1345 
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
)) &&

1346 (
hwc
->
ßm∂e_≥riod
 == 1)))

1347  
X86_PMC_IDX_FIXED_BTS
;

1349 i‡(!
x86_pmu
.
num_evíts_fixed
)

1352 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_INSTRUCTIONS
)))

1353  
X86_PMC_IDX_FIXED_INSTRUCTIONS
;

1354 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_CPU_CYCLES
)))

1355  
X86_PMC_IDX_FIXED_CPU_CYCLES
;

1356 i‡(
	`u∆ikñy
(
hw_evít
 =
x86_pmu
.
	`evít_m≠
(
PERF_COUNT_HW_BUS_CYCLES
)))

1357  
X86_PMC_IDX_FIXED_BUS_CYCLES
;

1360 
	}
}

1365 
	$x86_pmu_íabÀ
(
≥rf_evít
 *
evít
)

1367 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1368 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1369 
idx
;

1371 
idx
 = 
	`fixed_mode_idx
(
evít
, 
hwc
);

1372 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
) {

1374 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
))

1375  -
EAGAIN
;

1377 
hwc
->
c⁄fig_ba£
 = 0;

1378 
hwc
->
evít_ba£
 = 0;

1379 
hwc
->
idx
 = idx;

1380 } i‡(
idx
 >= 0) {

1385 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
))

1386 
åy_gíîic
;

1388 
hwc
->
c⁄fig_ba£
 = 
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
;

1393 
hwc
->
evít_ba£
 =

1394 
MSR_ARCH_PERFMON_FIXED_CTR0
 - 
X86_PMC_IDX_FIXED
;

1395 
hwc
->
idx
 = idx;

1397 
idx
 = 
hwc
->idx;

1399 i‡(
	`ã°_™d_£t_bô
(
idx
, 
˝uc
->
u£d_mask
)) {

1400 
åy_gíîic
:

1401 
idx
 = 
	`föd_fú°_zîo_bô
(
˝uc
->
u£d_mask
,

1402 
x86_pmu
.
num_evíts
);

1403 i‡(
idx
 =
x86_pmu
.
num_evíts
)

1404  -
EAGAIN
;

1406 
	`£t_bô
(
idx
, 
˝uc
->
u£d_mask
);

1407 
hwc
->
idx
 = idx;

1409 
hwc
->
c⁄fig_ba£
 = 
x86_pmu
.
evít£l
;

1410 
hwc
->
evít_ba£
 = 
x86_pmu
.
≥rf˘r
;

1413 
	`≥rf_evíts_œpic_öô
();

1415 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1417 
˝uc
->
evíts
[
idx
] = 
evít
;

1418 
	`£t_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1420 
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
);

1421 
x86_pmu
.
	`íabÀ
(
hwc
, 
idx
);

1423 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1426 
	}
}

1428 
	$x86_pmu_u¡hrŸée
(
≥rf_evít
 *
evít
)

1430 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1431 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1433 i‡(
	`WARN_ON_ONCE
(
hwc
->
idx
 >
X86_PMC_IDX_MAX
 ||

1434 
˝uc
->
evíts
[
hwc
->
idx
] !
evít
))

1437 
x86_pmu
.
	`íabÀ
(
hwc
, hwc->
idx
);

1438 
	}
}

1440 
	$≥rf_evít_¥öt_debug
()

1442 
u64
 
˘æ
, 
°©us
, 
ovîÊow
, 
pmc_˘æ
, 
pmc_cou¡
, 
¥ev_À·
, 
fixed
;

1443 
˝u_hw_evíts
 *
˝uc
;

1444 
Êags
;

1445 
˝u
, 
idx
;

1447 i‡(!
x86_pmu
.
num_evíts
)

1450 
	`loˇl_úq_ßve
(
Êags
);

1452 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1453 
˝uc
 = &
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
);

1455 i‡(
x86_pmu
.
vîsi⁄
 >= 2) {

1456 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
˘æ
);

1457 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1458 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ovîÊow
);

1459 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
, 
fixed
);

1461 
	`¥_öfo
("\n");

1462 
	`¥_öfo
("CPU#%d: cål: %016Œx\n", 
˝u
, 
˘æ
);

1463 
	`¥_öfo
("CPU#%d: sètus: %016Œx\n", 
˝u
, 
°©us
);

1464 
	`¥_öfo
("CPU#%d: ovîÊow: %016Œx\n", 
˝u
, 
ovîÊow
);

1465 
	`¥_öfo
("CPU#%d: fixed: %016Œx\n", 
˝u
, 
fixed
);

1467 
	`¥_öfo
("CPU#%d: u£d: %016Œx\n", 
˝u
, *(
u64
 *)
˝uc
->
u£d_mask
);

1469 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1470 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
pmc_˘æ
);

1471 
	`rdm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 
pmc_cou¡
);

1473 
¥ev_À·
 = 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
˝u
);

1475 
	`¥_öfo
("CPU#%d: gen-PMC%d ctrl: %016llx\n",

1476 
˝u
, 
idx
, 
pmc_˘æ
);

1477 
	`¥_öfo
("CPU#%d: gen-PMC%d count: %016llx\n",

1478 
˝u
, 
idx
, 
pmc_cou¡
);

1479 
	`¥_öfo
("CPU#%d: gen-PMC%dÜeft: %016llx\n",

1480 
˝u
, 
idx
, 
¥ev_À·
);

1482 
idx
 = 0; idx < 
x86_pmu
.
num_evíts_fixed
; idx++) {

1483 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 
pmc_cou¡
);

1485 
	`¥_öfo
("CPU#%d: fixed-PMC%d count: %016llx\n",

1486 
˝u
, 
idx
, 
pmc_cou¡
);

1488 
	`loˇl_úq_ª°‹e
(
Êags
);

1489 
	}
}

1491 
	$öãl_pmu_døö_bts_buf„r
(
˝u_hw_evíts
 *
˝uc
)

1493 
debug_°‹e
 *
ds
 = 
˝uc
->ds;

1494 
	sbts_ªc‹d
 {

1495 
u64
 
‰om
;

1496 
u64
 
to
;

1497 
u64
 
Êags
;

1499 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
X86_PMC_IDX_FIXED_BTS
];

1500 
bts_ªc‹d
 *
©
, *
t›
;

1501 
≥rf_ouçut_h™dÀ
 
h™dÀ
;

1502 
≥rf_evít_hódî
 
hódî
;

1503 
≥rf_ßm∂e_d©a
 
d©a
;

1504 
±_ªgs
 
ªgs
;

1506 i‡(!
evít
)

1509 i‡(!
ds
)

1512 
©
 = (
bts_ªc‹d
 *)()
ds
->
bts_buf„r_ba£
;

1513 
t›
 = (
bts_ªc‹d
 *)()
ds
->
bts_ödex
;

1515 i‡(
t›
 <
©
)

1518 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

1521 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1522 
d©a
.
addr
 = 0;

1523 
ªgs
.
ù
 = 0;

1530 
	`≥rf_¥ï¨e_ßm∂e
(&
hódî
, &
d©a
, 
evít
, &
ªgs
);

1532 i‡(
	`≥rf_ouçut_begö
(&
h™dÀ
, 
evít
,

1533 
hódî
.
size
 * (
t›
 - 
©
), 1, 1))

1536 ; 
©
 < 
t›
;át++) {

1537 
d©a
.
ù
 = 
©
->
‰om
;

1538 
d©a
.
addr
 = 
©
->
to
;

1540 
	`≥rf_ouçut_ßm∂e
(&
h™dÀ
, &
hódî
, &
d©a
, 
evít
);

1543 
	`≥rf_ouçut_íd
(&
h™dÀ
);

1546 
evít
->
hw
.
öãºu±s
++;

1547 
evít
->
≥ndög_kûl
 = 
POLL_IN
;

1548 
	}
}

1550 
	$x86_pmu_dißbÀ
(
≥rf_evít
 *
evít
)

1552 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1553 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1554 
idx
 = 
hwc
->idx;

1560 
	`˛ór_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1561 
x86_pmu
.
	`dißbÀ
(
hwc
, 
idx
);

1567 
	`b¨rõr
();

1573 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1576 i‡(
	`u∆ikñy
(
idx
 =
X86_PMC_IDX_FIXED_BTS
))

1577 
	`öãl_pmu_døö_bts_buf„r
(
˝uc
);

1579 
˝uc
->
evíts
[
idx
] = 
NULL
;

1580 
	`˛ór_bô
(
idx
, 
˝uc
->
u£d_mask
);

1582 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1583 
	}
}

1589 
	$öãl_pmu_ßve_™d_ª°¨t
(
≥rf_evít
 *
evít
)

1591 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1592 
idx
 = 
hwc
->idx;

1593 
ªt
;

1595 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1596 
ªt
 = 
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
);

1598 i‡(
evít
->
°©e
 =
PERF_EVENT_STATE_ACTIVE
)

1599 
	`öãl_pmu_íabÀ_evít
(
hwc
, 
idx
);

1601  
ªt
;

1602 
	}
}

1604 
	$öãl_pmu_ª£t
()

1606 
debug_°‹e
 *
ds
 = 
	`__gë_˝u_v¨
(
˝u_hw_evíts
).ds;

1607 
Êags
;

1608 
idx
;

1610 i‡(!
x86_pmu
.
num_evíts
)

1613 
	`loˇl_úq_ßve
(
Êags
);

1615 
	`¥ötk
("˛órög PMU sèã o¿CPU#%d\n", 
	`smp_¥o˚ss‹_id
());

1617 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1618 
	`checkög_wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 0ull);

1619 
	`checkög_wrm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 0ull);

1621 
idx
 = 0; idx < 
x86_pmu
.
num_evíts_fixed
; idx++) {

1622 
	`checkög_wrm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 0ull);

1624 i‡(
ds
)

1625 
ds
->
bts_ödex
 = ds->
bts_buf„r_ba£
;

1627 
	`loˇl_úq_ª°‹e
(
Êags
);

1628 
	}
}

1630 
	$p6_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1632 
≥rf_ßm∂e_d©a
 
d©a
;

1633 
˝u_hw_evíts
 *
˝uc
;

1634 
≥rf_evít
 *
evít
;

1635 
hw_≥rf_evít
 *
hwc
;

1636 
idx
, 
h™dÀd
 = 0;

1637 
u64
 
vÆ
;

1639 
d©a
.
addr
 = 0;

1641 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1643 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1644 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1647 
evít
 = 
˝uc
->
evíts
[
idx
];

1648 
hwc
 = &
evít
->
hw
;

1650 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1651 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
evít_bôs
 - 1)))

1657 
h™dÀd
 = 1;

1658 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1660 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
))

1663 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1664 
	`p6_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1667 i‡(
h™dÀd
)

1668 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1670  
h™dÀd
;

1671 
	}
}

1677 
	$öãl_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1679 
≥rf_ßm∂e_d©a
 
d©a
;

1680 
˝u_hw_evíts
 *
˝uc
;

1681 
bô
, 
lo›s
;

1682 
u64
 
ack
, 
°©us
;

1684 
d©a
.
addr
 = 0;

1686 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1688 
	`≥rf_dißbÀ
();

1689 
	`öãl_pmu_døö_bts_buf„r
(
˝uc
);

1690 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1691 i‡(!
°©us
) {

1692 
	`≥rf_íabÀ
();

1696 
lo›s
 = 0;

1697 
agaö
:

1698 i‡(++
lo›s
 > 100) {

1699 
	`WARN_ONCE
(1, "perfevents: irqÜoop stuck!\n");

1700 
	`≥rf_evít_¥öt_debug
();

1701 
	`öãl_pmu_ª£t
();

1702 
	`≥rf_íabÀ
();

1706 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1707 
ack
 = 
°©us
;

1708 
	`f‹_óch_bô
(
bô
, (*)&
°©us
, 
X86_PMC_IDX_MAX
) {

1709 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
bô
];

1711 
	`˛ór_bô
(
bô
, (*Ë&
°©us
);

1712 i‡(!
	`ã°_bô
(
bô
, 
˝uc
->
a˘ive_mask
))

1715 i‡(!
	`öãl_pmu_ßve_™d_ª°¨t
(
evít
))

1718 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1720 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1721 
	`öãl_pmu_dißbÀ_evít
(&
evít
->
hw
, 
bô
);

1724 
	`öãl_pmu_ack_°©us
(
ack
);

1729 
°©us
 = 
	`öãl_pmu_gë_°©us
();

1730 i‡(
°©us
)

1731 
agaö
;

1733 
	`≥rf_íabÀ
();

1736 
	}
}

1738 
	$amd_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1740 
≥rf_ßm∂e_d©a
 
d©a
;

1741 
˝u_hw_evíts
 *
˝uc
;

1742 
≥rf_evít
 *
evít
;

1743 
hw_≥rf_evít
 *
hwc
;

1744 
idx
, 
h™dÀd
 = 0;

1745 
u64
 
vÆ
;

1747 
d©a
.
addr
 = 0;

1749 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1751 
idx
 = 0; idx < 
x86_pmu
.
num_evíts
; idx++) {

1752 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1755 
evít
 = 
˝uc
->
evíts
[
idx
];

1756 
hwc
 = &
evít
->
hw
;

1758 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
, 
hwc
, 
idx
);

1759 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
evít_bôs
 - 1)))

1765 
h™dÀd
 = 1;

1766 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1768 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
, 
hwc
, 
idx
))

1771 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1772 
	`amd_pmu_dißbÀ_evít
(
hwc
, 
idx
);

1775 i‡(
h™dÀd
)

1776 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1778  
h™dÀd
;

1779 
	}
}

1781 
	$smp_≥rf_≥ndög_öãºu±
(
±_ªgs
 *
ªgs
)

1783 
	`úq_íãr
();

1784 
	`ack_APIC_úq
();

1785 
	`öc_úq_°©
(
≠ic_≥ndög_úqs
);

1786 
	`≥rf_evít_do_≥ndög
();

1787 
	`úq_exô
();

1788 
	}
}

1790 
	$£t_≥rf_evít_≥ndög
()

1792 #ifde‡
CONFIG_X86_LOCAL_APIC


1793 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1796 
≠ic
->
	`£nd_IPI_£lf
(
LOCAL_PENDING_VECTOR
);

1798 
	}
}

1800 
	$≥rf_evíts_œpic_öô
()

1802 #ifde‡
CONFIG_X86_LOCAL_APIC


1803 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1809 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1811 
	}
}

1813 
__k¥obes


1814 
	$≥rf_evít_nmi_h™dÀr
(
nŸifõr_block
 *
£lf
,

1815 
cmd
, *
__¨gs
)

1817 
dõ_¨gs
 *
¨gs
 = 
__¨gs
;

1818 
±_ªgs
 *
ªgs
;

1820 i‡(!
	`©omic_ªad
(&
a˘ive_evíts
))

1821  
NOTIFY_DONE
;

1823 
cmd
) {

1824 
DIE_NMI
:

1825 
DIE_NMI_IPI
:

1829  
NOTIFY_DONE
;

1832 
ªgs
 = 
¨gs
->regs;

1834 #ifde‡
CONFIG_X86_LOCAL_APIC


1835 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1844 
x86_pmu
.
	`h™dÀ_úq
(
ªgs
);

1846  
NOTIFY_STOP
;

1847 
	}
}

1849 
__ªad_mo°ly
 
nŸifõr_block
 
	g≥rf_evít_nmi_nŸifõr
 = {

1850 .
nŸifõr_ˇŒ
 = 
≥rf_evít_nmi_h™dÀr
,

1851 .
	g√xt
 = 
NULL
,

1852 .
	g¥i‹ôy
 = 1

1855 
x86_pmu
 
	gp6_pmu
 = {

1856 .
«me
 = "p6",

1857 .
	gh™dÀ_úq
 = 
p6_pmu_h™dÀ_úq
,

1858 .
	gdißbÀ_Æl
 = 
p6_pmu_dißbÀ_Æl
,

1859 .
	gíabÀ_Æl
 = 
p6_pmu_íabÀ_Æl
,

1860 .
	gíabÀ
 = 
p6_pmu_íabÀ_evít
,

1861 .
	gdißbÀ
 = 
p6_pmu_dißbÀ_evít
,

1862 .
	gevít£l
 = 
MSR_P6_EVNTSEL0
,

1863 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

1864 .
	gevít_m≠
 = 
p6_pmu_evít_m≠
,

1865 .
	gøw_evít
 = 
p6_pmu_øw_evít
,

1866 .
	gmax_evíts
 = 
ARRAY_SIZE
(
p6_≥rfm⁄_evít_m≠
),

1867 .
	g≠ic
 = 1,

1868 .
	gmax_≥riod
 = (1ULL << 31) - 1,

1869 .
	gvîsi⁄
 = 0,

1870 .
	gnum_evíts
 = 2,

1878 .
	gevít_bôs
 = 32,

1879 .
	gevít_mask
 = (1ULL << 32) - 1,

1882 
x86_pmu
 
	göãl_pmu
 = {

1883 .
«me
 = "Intel",

1884 .
	gh™dÀ_úq
 = 
öãl_pmu_h™dÀ_úq
,

1885 .
	gdißbÀ_Æl
 = 
öãl_pmu_dißbÀ_Æl
,

1886 .
	gíabÀ_Æl
 = 
öãl_pmu_íabÀ_Æl
,

1887 .
	gíabÀ
 = 
öãl_pmu_íabÀ_evít
,

1888 .
	gdißbÀ
 = 
öãl_pmu_dißbÀ_evít
,

1889 .
	gevít£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
,

1890 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
,

1891 .
	gevít_m≠
 = 
öãl_pmu_evít_m≠
,

1892 .
	gøw_evít
 = 
öãl_pmu_øw_evít
,

1893 .
	gmax_evíts
 = 
ARRAY_SIZE
(
öãl_≥rfm⁄_evít_m≠
),

1894 .
	g≠ic
 = 1,

1900 .
	gmax_≥riod
 = (1ULL << 31) - 1,

1901 .
	gíabÀ_bts
 = 
öãl_pmu_íabÀ_bts
,

1902 .
	gdißbÀ_bts
 = 
öãl_pmu_dißbÀ_bts
,

1905 
x86_pmu
 
	gamd_pmu
 = {

1906 .
«me
 = "AMD",

1907 .
	gh™dÀ_úq
 = 
amd_pmu_h™dÀ_úq
,

1908 .
	gdißbÀ_Æl
 = 
amd_pmu_dißbÀ_Æl
,

1909 .
	gíabÀ_Æl
 = 
amd_pmu_íabÀ_Æl
,

1910 .
	gíabÀ
 = 
amd_pmu_íabÀ_evít
,

1911 .
	gdißbÀ
 = 
amd_pmu_dißbÀ_evít
,

1912 .
	gevít£l
 = 
MSR_K7_EVNTSEL0
,

1913 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

1914 .
	gevít_m≠
 = 
amd_pmu_evít_m≠
,

1915 .
	gøw_evít
 = 
amd_pmu_øw_evít
,

1916 .
	gmax_evíts
 = 
ARRAY_SIZE
(
amd_≥rfm⁄_evít_m≠
),

1917 .
	gnum_evíts
 = 4,

1918 .
	gevít_bôs
 = 48,

1919 .
	gevít_mask
 = (1ULL << 48) - 1,

1920 .
	g≠ic
 = 1,

1922 .
	gmax_≥riod
 = (1ULL << 47) - 1,

1925 
	$p6_pmu_öô
()

1927 
boŸ_˝u_d©a
.
x86_modñ
) {

1941 
	`¥_c⁄t
("unsupportedÖ6 CPU model %d ",

1942 
boŸ_˝u_d©a
.
x86_modñ
);

1943  -
ENODEV
;

1946 
x86_pmu
 = 
p6_pmu
;

1948 i‡(!
˝u_has_≠ic
) {

1949 
	`¥_öfo
("no APIC, boot withÅhe \"lapic\" bootÖarameterÅo force-enable it.\n");

1950 
	`¥_öfo
("no hardware sampling interruptávailable.\n");

1951 
x86_pmu
.
≠ic
 = 0;

1955 
	}
}

1957 
	$öãl_pmu_öô
()

1959 
˝uid10_edx
 
edx
;

1960 
˝uid10_óx
 
óx
;

1961 
unu£d
;

1962 
ebx
;

1963 
vîsi⁄
;

1965 i‡(!
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

1967 i‡(
boŸ_˝u_d©a
.
x86
 == 6) {

1968  
	`p6_pmu_öô
();

1970  -
ENODEV
;

1978 
	`˝uid
(10, &
óx
.
fuŒ
, &
ebx
, &
unu£d
, &
edx
.full);

1979 i‡(
óx
.
•lô
.
mask_Àngth
 <
ARCH_PERFMON_BRANCH_MISSES_RETIRED
)

1980  -
ENODEV
;

1982 
vîsi⁄
 = 
óx
.
•lô
.
vîsi⁄_id
;

1983 i‡(
vîsi⁄
 < 2)

1984  -
ENODEV
;

1986 
x86_pmu
 = 
öãl_pmu
;

1987 
x86_pmu
.
vîsi⁄
 = version;

1988 
x86_pmu
.
num_evíts
 = 
óx
.
•lô
.num_events;

1989 
x86_pmu
.
evít_bôs
 = 
óx
.
•lô
.
bô_width
;

1990 
x86_pmu
.
evít_mask
 = (1ULL << 
óx
.
•lô
.
bô_width
) - 1;

1996 
x86_pmu
.
num_evíts_fixed
 = 
	`max
(()
edx
.
•lô
.num_events_fixed, 3);

2001 
boŸ_˝u_d©a
.
x86_modñ
) {

2006 
	`mem˝y
(
hw_ˇche_evít_ids
, 
c‹e2_hw_ˇche_evít_ids
,

2007 (
hw_ˇche_evít_ids
));

2009 
	`¥_c⁄t
("Core2Évents, ");

2013 
	`mem˝y
(
hw_ˇche_evít_ids
, 
√hÆem_hw_ˇche_evít_ids
,

2014 (
hw_ˇche_evít_ids
));

2016 
	`¥_c⁄t
("Nehalem/Corei7Évents, ");

2019 
	`mem˝y
(
hw_ˇche_evít_ids
, 
©om_hw_ˇche_evít_ids
,

2020 (
hw_ˇche_evít_ids
));

2022 
	`¥_c⁄t
("AtomÉvents, ");

2026 
	}
}

2028 
	$amd_pmu_öô
()

2031 i‡(
boŸ_˝u_d©a
.
x86
 < 6)

2032  -
ENODEV
;

2034 
x86_pmu
 = 
amd_pmu
;

2037 
	`mem˝y
(
hw_ˇche_evít_ids
, 
amd_hw_ˇche_evít_ids
,

2038 (
hw_ˇche_evít_ids
));

2041 
	}
}

2043 
__öô
 
	$öô_hw_≥rf_evíts
()

2045 
îr
;

2047 
	`¥_öfo
("Performance Events: ");

2049 
boŸ_˝u_d©a
.
x86_víd‹
) {

2050 
X86_VENDOR_INTEL
:

2051 
îr
 = 
	`öãl_pmu_öô
();

2053 
X86_VENDOR_AMD
:

2054 
îr
 = 
	`amd_pmu_öô
();

2059 i‡(
îr
 != 0) {

2060 
	`¥_c⁄t
("no PMU driver, softwareÉvents only.\n");

2064 
	`¥_c⁄t
("%†PMU drivî.\n", 
x86_pmu
.
«me
);

2066 i‡(
x86_pmu
.
num_evíts
 > 
X86_PMC_MAX_GENERIC
) {

2067 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents %d > max(%d), clipping!",

2068 
x86_pmu
.
num_evíts
, 
X86_PMC_MAX_GENERIC
);

2069 
x86_pmu
.
num_evíts
 = 
X86_PMC_MAX_GENERIC
;

2071 
≥rf_evít_mask
 = (1 << 
x86_pmu
.
num_evíts
) - 1;

2072 
≥rf_max_evíts
 = 
x86_pmu
.
num_evíts
;

2074 i‡(
x86_pmu
.
num_evíts_fixed
 > 
X86_PMC_MAX_FIXED
) {

2075 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents fixed %d > max(%d), clipping!",

2076 
x86_pmu
.
num_evíts_fixed
, 
X86_PMC_MAX_FIXED
);

2077 
x86_pmu
.
num_evíts_fixed
 = 
X86_PMC_MAX_FIXED
;

2080 
≥rf_evít_mask
 |=

2081 ((1LL << 
x86_pmu
.
num_evíts_fixed
)-1Ë<< 
X86_PMC_IDX_FIXED
;

2082 
x86_pmu
.
öãl_˘æ
 = 
≥rf_evít_mask
;

2084 
	`≥rf_evíts_œpic_öô
();

2085 
	`ªgi°î_dõ_nŸifõr
(&
≥rf_evít_nmi_nŸifõr
);

2087 
	`¥_öfo
("... vîsi⁄: %d\n", 
x86_pmu
.
vîsi⁄
);

2088 
	`¥_öfo
("... bô width: %d\n", 
x86_pmu
.
evít_bôs
);

2089 
	`¥_öfo
("... gíîi¯ªgi°îs: %d\n", 
x86_pmu
.
num_evíts
);

2090 
	`¥_öfo
("... vÆuêmask: %016Lx\n", 
x86_pmu
.
evít_mask
);

2091 
	`¥_öfo
("... maxÖîiod: %016Lx\n", 
x86_pmu
.
max_≥riod
);

2092 
	`¥_öfo
("... fixed-puΩo£Évíts: %d\n", 
x86_pmu
.
num_evíts_fixed
);

2093 
	`¥_öfo
("...Évíàmask: %016Lx\n", 
≥rf_evít_mask
);

2094 
	}
}

2096 
ölöe
 
	$x86_pmu_ªad
(
≥rf_evít
 *
evít
)

2098 
	`x86_≥rf_evít_upd©e
(
evít
, &evít->
hw
,Évít->hw.
idx
);

2099 
	}
}

2101 c⁄° 
pmu
 
	gpmu
 = {

2102 .
íabÀ
 = 
x86_pmu_íabÀ
,

2103 .
	gdißbÀ
 = 
x86_pmu_dißbÀ
,

2104 .
	gªad
 = 
x86_pmu_ªad
,

2105 .
	gu¡hrŸée
 = 
x86_pmu_u¡hrŸée
,

2108 c⁄° 
pmu
 *
	$hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

2110 
îr
;

2112 
îr
 = 
	`__hw_≥rf_evít_öô
(
evít
);

2113 i‡(
îr
) {

2114 i‡(
evít
->
de°roy
)

2115 
evít
->
	`de°roy
(event);

2116  
	`ERR_PTR
(
îr
);

2119  &
pmu
;

2120 
	}
}

2126 
ölöe


2127 
	$ˇŒchaö_°‹e
(
≥rf_ˇŒchaö_íåy
 *
íåy
, 
u64
 
ù
)

2129 i‡(
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
)

2130 
íåy
->
ù
[íåy->
ƒ
++] = ip;

2131 
	}
}

2133 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_úq_íåy
);

2134 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_nmi_íåy
);

2135 
DEFINE_PER_CPU
(, 
ö_nmi_‰ame
);

2139 
	$backåa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

2142 
	}
}

2144 
	$backåa˚_w¨nög
(*
d©a
, *
msg
)

2147 
	}
}

2149 
	$backåa˚_°ack
(*
d©a
, *
«me
)

2151 
	`≥r_˝u
(
ö_nmi_‰ame
, 
	`smp_¥o˚ss‹_id
()) =

2152 
	`x86_is_°ack_id
(
NMI_STACK
, 
«me
);

2155 
	}
}

2157 
	$backåa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

2159 
≥rf_ˇŒchaö_íåy
 *
íåy
 = 
d©a
;

2161 i‡(
	`≥r_˝u
(
ö_nmi_‰ame
, 
	`smp_¥o˚ss‹_id
()))

2164 i‡(
ªlübÀ
)

2165 
	`ˇŒchaö_°‹e
(
íåy
, 
addr
);

2166 
	}
}

2168 c⁄° 
°ackåa˚_›s
 
	gbackåa˚_›s
 = {

2169 .
w¨nög
 = 
backåa˚_w¨nög
,

2170 .
	gw¨nög_symbﬁ
 = 
backåa˚_w¨nög_symbﬁ
,

2171 .
	g°ack
 = 
backåa˚_°ack
,

2172 .
	gaddªss
 = 
backåa˚_addªss
,

2175 
	~"../dump°ack.h
"

2178 
	$≥rf_ˇŒchaö_kî√l
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2180 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_KERNEL
);

2181 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

2183 
	`dump_åa˚
(
NULL
, 
ªgs
, NULL, 0, &
backåa˚_›s
, 
íåy
);

2184 
	}
}

2190 
	$c›y_‰om_u£r_nmi
(*
to
, c⁄° 
__u£r
 *
‰om
, 
n
)

2192 
off£t
, 
addr
 = ()
‰om
;

2193 
ty≥
 = 
	`ö_nmi
(Ë? 
KM_NMI
 : 
KM_IRQ0
;

2194 
size
, 
Àn
 = 0;

2195 
∑ge
 *page;

2196 *
m≠
;

2197 
ªt
;

2200 
ªt
 = 
	`__gë_u£r_∑ges_Á°
(
addr
, 1, 0, &
∑ge
);

2201 i‡(!
ªt
)

2204 
off£t
 = 
addr
 & (
PAGE_SIZE
 - 1);

2205 
size
 = 
	`mö
(
PAGE_SIZE
 - 
off£t
, 
n
 - 
Àn
);

2207 
m≠
 = 
	`km≠_©omic
(
∑ge
, 
ty≥
);

2208 
	`mem˝y
(
to
, 
m≠
+
off£t
, 
size
);

2209 
	`kunm≠_©omic
(
m≠
, 
ty≥
);

2210 
	`put_∑ge
(
∑ge
);

2212 
Àn
 +
size
;

2213 
to
 +
size
;

2214 
addr
 +
size
;

2216 } 
Àn
 < 
n
);

2218  
Àn
;

2219 
	}
}

2221 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

2223 
byãs
;

2225 
byãs
 = 
	`c›y_‰om_u£r_nmi
(
‰ame
, 
Â
, (*frame));

2227  
byãs
 =(*
‰ame
);

2228 
	}
}

2231 
	$≥rf_ˇŒchaö_u£r
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2233 
°ack_‰ame
 
‰ame
;

2234 c⁄° 
__u£r
 *
Â
;

2236 i‡(!
	`u£r_mode
(
ªgs
))

2237 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

2239 
Â
 = (
__u£r
 *)
ªgs
->
bp
;

2241 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_USER
);

2242 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

2244 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

2245 
‰ame
.
√xt_‰ame
 = 
NULL
;

2246 
‰ame
.
ªtu∫_addªss
 = 0;

2248 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

2251 i‡(()
Â
 < 
ªgs
->
•
)

2254 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

2255 
Â
 = 
‰ame
.
√xt_‰ame
;

2257 
	}
}

2260 
	$≥rf_do_ˇŒchaö
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

2262 
is_u£r
;

2264 i‡(!
ªgs
)

2267 
is_u£r
 = 
	`u£r_mode
(
ªgs
);

2269 i‡(!
cuºít
 || cuºít->
pid
 == 0)

2272 i‡(
is_u£r
 && 
cuºít
->
°©e
 !
TASK_RUNNING
)

2275 i‡(!
is_u£r
)

2276 
	`≥rf_ˇŒchaö_kî√l
(
ªgs
, 
íåy
);

2278 i‡(
cuºít
->
mm
)

2279 
	`≥rf_ˇŒchaö_u£r
(
ªgs
, 
íåy
);

2280 
	}
}

2282 
≥rf_ˇŒchaö_íåy
 *
	$≥rf_ˇŒchaö
(
±_ªgs
 *
ªgs
)

2284 
≥rf_ˇŒchaö_íåy
 *
íåy
;

2286 i‡(
	`ö_nmi
())

2287 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_nmi_íåy
);

2289 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_úq_íåy
);

2291 
íåy
->
ƒ
 = 0;

2293 
	`≥rf_do_ˇŒchaö
(
ªgs
, 
íåy
);

2295  
íåy
;

2296 
	}
}

2298 
	$hw_≥rf_evít_£tup_⁄löe
(
˝u
)

2300 
	`öô_debug_°‹e_⁄_˝u
(
˝u
);

2301 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/bô›s.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/nmi.h
>

20 
	~<löux/k¥obes.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/≥rf_evít.h
>

25 
	snmi_w©chdog_˘lblk
 {

26 
	mcc¸_m§
;

27 
	m≥rf˘r_m§
;

28 
	mev¡£l_m§
;

32 
	swd_›s
 {

33 (*
	mª£rve
)();

34 (*
	muƒe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	mª¨m
)(
nmi_w©chdog_˘lblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m°›
)();

38 
	m≥rf˘r
;

39 
	mev¡£l
;

40 
u64
 
	mcheckbô
;

43 c⁄° 
wd_›s
 *
	gwd_›s
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
≥rf˘r_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
ev¡£l_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_˘lblk
,Çmi_watchdog_ctlblk);

66 
ölöe
 
	$nmi_≥rf˘r_m§_to_bô
(
m§
)

69 
boŸ_˝u_d©a
.
x86_víd‹
) {

70 
X86_VENDOR_AMD
:

71  
m§
 - 
MSR_K7_PERFCTR0
;

72 
X86_VENDOR_INTEL
:

73 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  
m§
 - 
MSR_ARCH_PERFMON_PERFCTR0
;

76 
boŸ_˝u_d©a
.
x86
) {

78  
m§
 - 
MSR_P6_PERFCTR0
;

80  
m§
 - 
MSR_P4_BPU_PERFCTR0
;

84 
	}
}

90 
ölöe
 
	$nmi_ev¡£l_m§_to_bô
(
m§
)

93 
boŸ_˝u_d©a
.
x86_víd‹
) {

94 
X86_VENDOR_AMD
:

95  
m§
 - 
MSR_K7_EVNTSEL0
;

96 
X86_VENDOR_INTEL
:

97 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  
m§
 - 
MSR_ARCH_PERFMON_EVENTSEL0
;

100 
boŸ_˝u_d©a
.
x86
) {

102  
m§
 - 
MSR_P6_EVNTSEL0
;

104  
m§
 - 
MSR_P4_BSU_ESCR0
;

109 
	}
}

112 
	$avaû_to_ª§v_≥rf˘r_nmi_bô
(
cou¡î
)

114 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

116  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

117 
	}
}

120 
	$avaû_to_ª§v_≥rf˘r_nmi
(
m§
)

122 
cou¡î
;

124 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

125 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

127  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

128 
	}
}

129 
EXPORT_SYMBOL
(
avaû_to_ª§v_≥rf˘r_nmi_bô
);

131 
	$ª£rve_≥rf˘r_nmi
(
m§
)

133 
cou¡î
;

135 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

137 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

140 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
))

143 
	}
}

144 
EXPORT_SYMBOL
(
ª£rve_≥rf˘r_nmi
);

146 
	$ªÀa£_≥rf˘r_nmi
(
m§
)

148 
cou¡î
;

150 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

152 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

155 
	`˛ór_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

156 
	}
}

157 
EXPORT_SYMBOL
(
ªÀa£_≥rf˘r_nmi
);

159 
	$ª£rve_ev¡£l_nmi
(
m§
)

161 
cou¡î
;

163 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

165 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

168 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
))

171 
	}
}

172 
EXPORT_SYMBOL
(
ª£rve_ev¡£l_nmi
);

174 
	$ªÀa£_ev¡£l_nmi
(
m§
)

176 
cou¡î
;

178 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

180 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

183 
	`˛ór_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
);

184 
	}
}

185 
EXPORT_SYMBOL
(
ªÀa£_ev¡£l_nmi
);

187 
	$dißbÀ_œpic_nmi_w©chdog
()

189 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

191 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

194 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

196 i‡(
wd_›s
)

197 
wd_›s
->
	`uƒe£rve
();

199 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

200 
	}
}

202 
	$íabÀ_œpic_nmi_w©chdog
()

204 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

207 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) != 0)

211 i‡(!
wd_›s
)

213 i‡(!
wd_›s
->
	`ª£rve
()) {

214 
	`¥ötk
(
KERN_ERR
 "NMI watchdog: cannotÑeserveÖerfctrs\n");

218 
	`⁄_óch_˝u
(
£tup_≠ic_nmi_w©chdog
, 
NULL
, 1);

219 
	`touch_nmi_w©chdog
();

220 
	}
}

226 
	$adju°_f‹_32bô_˘r
(
hz
)

228 
u64
 
cou¡î_vÆ
;

229 
ªtvÆ
 = 
hz
;

238 
cou¡î_vÆ
 = (
u64
)
˝u_khz
 * 1000;

239 
	`do_div
(
cou¡î_vÆ
, 
ªtvÆ
);

240 i‡(
cou¡î_vÆ
 > 0x7fffffffULL) {

241 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

242 
	`do_div
(
cou¡
, 0x7fffffffUL);

243 
ªtvÆ
 = 
cou¡
 + 1;

245  
ªtvÆ
;

246 
	}
}

248 
	$wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
,

249 c⁄° *
des¸
, 
nmi_hz
)

251 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

253 
	`do_div
(
cou¡
, 
nmi_hz
);

254 i‡(
des¸
)

255 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

256 
	`wrm§l
(
≥rf˘r_m§
, 0 - 
cou¡
);

257 
	}
}

259 
	$wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
,

260 c⁄° *
des¸
, 
nmi_hz
)

262 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

264 
	`do_div
(
cou¡
, 
nmi_hz
);

265 i‡(
des¸
)

266 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

267 
	`wrm§
(
≥rf˘r_m§
, (
u32
)(-
cou¡
), 0);

268 
	}
}

274 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

275 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

276 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

277 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

278 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

279 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

281 
	$£tup_k7_w©chdog
(
nmi_hz
)

283 
≥rf˘r_m§
, 
ev¡£l_m§
;

284 
ev¡£l
;

285 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

287 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

288 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

290 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

292 
ev¡£l
 = 
K7_EVNTSEL_INT


293 | 
K7_EVNTSEL_OS


294 | 
K7_EVNTSEL_USR


295 | 
K7_NMI_EVENT
;

298 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

299 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "K7_PERFCTR0", 
nmi_hz
);

302 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

303 
wd
->
ev¡£l_m§
 =Évntsel_msr;

304 
wd
->
cc¸_m§
 = 0;

307 
	`˝u_nmi_£t_wd_íabÀd
();

309 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

310 
ev¡£l
 |
K7_EVNTSEL_ENABLE
;

311 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

314 
	}
}

316 
	$sögÀ_m§_°›_w©chdog
()

318 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

320 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

321 
	}
}

323 
	$sögÀ_m§_ª£rve
()

325 i‡(!
	`ª£rve_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
))

328 i‡(!
	`ª£rve_ev¡£l_nmi
(
wd_›s
->
ev¡£l
)) {

329 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

333 
	}
}

335 
	$sögÀ_m§_uƒe£rve
()

337 
	`ªÀa£_ev¡£l_nmi
(
wd_›s
->
ev¡£l
);

338 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

339 
	}
}

341 
__k¥obes


342 
	$sögÀ_m§_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

345 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

346 
	}
}

348 c⁄° 
wd_›s
 
	gk7_wd_›s
 = {

349 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

350 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

351 .
	g£tup
 = 
£tup_k7_w©chdog
,

352 .
	gª¨m
 = 
sögÀ_m§_ª¨m
,

353 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

354 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

355 .
	gev¡£l
 = 
MSR_K7_EVNTSEL0
,

356 .
	gcheckbô
 = 1ULL << 47,

362 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

363 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

364 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

365 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

366 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

367 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

369 
	$£tup_p6_w©chdog
(
nmi_hz
)

371 
≥rf˘r_m§
, 
ev¡£l_m§
;

372 
ev¡£l
;

373 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

375 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

376 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

379 i‡(
	`wrm§_ß„
(
≥rf˘r_m§
, 0, 0) < 0)

382 
ev¡£l
 = 
P6_EVNTSEL_INT


383 | 
P6_EVNTSEL_OS


384 | 
P6_EVNTSEL_USR


385 | 
P6_NMI_EVENT
;

388 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

389 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

390 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "P6_PERFCTR0", 
nmi_hz
);

393 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

394 
wd
->
ev¡£l_m§
 =Évntsel_msr;

395 
wd
->
cc¸_m§
 = 0;

398 
	`˝u_nmi_£t_wd_íabÀd
();

400 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

401 
ev¡£l
 |
P6_EVNTSEL0_ENABLE
;

402 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

405 
	}
}

407 
__k¥obes
 
	$p6_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

415 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

418 
	`wrôe_w©chdog_cou¡î32
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

419 
	}
}

421 c⁄° 
wd_›s
 
	gp6_wd_›s
 = {

422 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

423 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

424 .
	g£tup
 = 
£tup_p6_w©chdog
,

425 .
	gª¨m
 = 
p6_ª¨m
,

426 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

427 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

428 .
	gev¡£l
 = 
MSR_P6_EVNTSEL0
,

429 .
	gcheckbô
 = 1ULL << 39,

436 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

437 
	#P4_ESCR_EVENT_SELECT
(
N
Ë((NË<< 25)

	)

438 
	#P4_ESCR_OS
 (1 << 3)

	)

439 
	#P4_ESCR_USR
 (1 << 2)

	)

440 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

441 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

442 
	#P4_CCCR_THRESHOLD
(
N
Ë((NË<< 20)

	)

443 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

444 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

445 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

446 
	#P4_CCCR_ESCR_SELECT
(
N
Ë((NË<< 13)

	)

447 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

448 
	#P4_CCCR_OVF
 (1 << 31)

	)

450 
	#P4_CONTROLS
 18

	)

451 
	gp4_c⁄åﬁs
[18] = {

452 
MSR_P4_BPU_CCCR0
,

453 
MSR_P4_BPU_CCCR1
,

454 
MSR_P4_BPU_CCCR2
,

455 
MSR_P4_BPU_CCCR3
,

456 
MSR_P4_MS_CCCR0
,

457 
MSR_P4_MS_CCCR1
,

458 
MSR_P4_MS_CCCR2
,

459 
MSR_P4_MS_CCCR3
,

460 
MSR_P4_FLAME_CCCR0
,

461 
MSR_P4_FLAME_CCCR1
,

462 
MSR_P4_FLAME_CCCR2
,

463 
MSR_P4_FLAME_CCCR3
,

464 
MSR_P4_IQ_CCCR0
,

465 
MSR_P4_IQ_CCCR1
,

466 
MSR_P4_IQ_CCCR2
,

467 
MSR_P4_IQ_CCCR3
,

468 
MSR_P4_IQ_CCCR4
,

469 
MSR_P4_IQ_CCCR5
,

476 
	$£tup_p4_w©chdog
(
nmi_hz
)

478 
≥rf˘r_m§
, 
ev¡£l_m§
, 
cc¸_m§
;

479 
ev¡£l
, 
cc¸_vÆ
;

480 
misc_íabÀ
, 
dummy
;

481 
ht_num
;

482 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

484 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
, 
dummy
);

485 i‡(!(
misc_íabÀ
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

488 #ifde‡
CONFIG_SMP


490 i‡(
smp_num_siblögs
 == 2) {

491 
ebx
, 
≠icid
;

493 
ebx
 = 
	`˝uid_ebx
(1);

494 
≠icid
 = (
ebx
 >> 24) & 0xff;

495 
ht_num
 = 
≠icid
 & 1;

498 
ht_num
 = 0;

506 i‡(!
ht_num
) {

508 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR0
;

509 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

510 
cc¸_m§
 = 
MSR_P4_IQ_CCCR0
;

511 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

522 i‡(
ª£t_devi˚s
) {

523 
low
, 
high
;

524 
i
;

526 
i
 = 0; i < 
P4_CONTROLS
; i++) {

527 
	`rdm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

528 
low
 &~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

529 
	`wrm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

534 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR1
;

535 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

536 
cc¸_m§
 = 
MSR_P4_IQ_CCCR1
;

539 i‡(
boŸ_˝u_d©a
.
x86_modñ
 =4 && boŸ_˝u_d©a.
x86_mask
 == 4)

540 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
;

542 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI1
;

543 
cc¸_vÆ
 |
	`P4_CCCR_ESCR_SELECT
(4);

546 
ev¡£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

547 | 
P4_ESCR_OS


548 | 
P4_ESCR_USR
;

550 
cc¸_vÆ
 |
	`P4_CCCR_THRESHOLD
(15)

551 | 
P4_CCCR_COMPLEMENT


552 | 
P4_CCCR_COMPARE


553 | 
P4_CCCR_REQUIRED
;

555 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

556 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

557 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "P4_IQ_COUNTER0", 
nmi_hz
);

559 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

560 
wd
->
ev¡£l_m§
 =Évntsel_msr;

561 
wd
->
cc¸_m§
 = cccr_msr;

564 
	`˝u_nmi_£t_wd_íabÀd
();

566 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

567 
cc¸_vÆ
 |
P4_CCCR_ENABLE
;

568 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

570 
	}
}

572 
	$°›_p4_w©chdog
()

574 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

575 
	`wrm§
(
wd
->
cc¸_m§
, 0, 0);

576 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

577 
	}
}

579 
	$p4_ª£rve
()

581 i‡(!
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
))

583 #ifde‡
CONFIG_SMP


584 i‡(
smp_num_siblögs
 > 1 && !
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
))

585 
Áû1
;

587 i‡(!
	`ª£rve_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
))

588 
Áû2
;

591 
Áû2
:

592 #ifde‡
CONFIG_SMP


593 i‡(
smp_num_siblögs
 > 1)

594 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

595 
Áû1
:

597 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

599 
	}
}

601 
	$p4_uƒe£rve
()

603 #ifde‡
CONFIG_SMP


604 i‡(
smp_num_siblögs
 > 1)

605 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

607 
	`ªÀa£_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
);

608 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

609 
	}
}

611 
__k¥obes
 
	$p4_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

613 
dummy
;

621 
	`rdm§l
(
wd
->
cc¸_m§
, 
dummy
);

622 
dummy
 &~
P4_CCCR_OVF
;

623 
	`wrm§l
(
wd
->
cc¸_m§
, 
dummy
);

624 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

626 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

627 
	}
}

629 c⁄° 
wd_›s
 
	gp4_wd_›s
 = {

630 .
ª£rve
 = 
p4_ª£rve
,

631 .
	guƒe£rve
 = 
p4_uƒe£rve
,

632 .
	g£tup
 = 
£tup_p4_w©chdog
,

633 .
	gª¨m
 = 
p4_ª¨m
,

634 .
	g°›
 = 
°›_p4_w©chdog
,

636 .
	g≥rf˘r
 = 
MSR_P4_BPU_PERFCTR0
,

637 .
	gev¡£l
 = 
MSR_P4_BSU_ESCR0
,

638 .
	gcheckbô
 = 1ULL << 39,

645 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

646 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

648 
wd_›s
 
	göãl_¨ch_wd_›s
;

650 
	$£tup_öãl_¨ch_w©chdog
(
nmi_hz
)

652 
ebx
;

653 
˝uid10_óx
 
óx
;

654 
unu£d
;

655 
≥rf˘r_m§
, 
ev¡£l_m§
;

656 
ev¡£l
;

657 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

664 
	`˝uid
(10, &(
óx
.
fuŒ
), &
ebx
, &
unu£d
, &unused);

665 i‡((
óx
.
•lô
.
mask_Àngth
 <

666 (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

667 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

670 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

671 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

673 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

675 
ev¡£l
 = 
ARCH_PERFMON_EVENTSEL_INT


676 | 
ARCH_PERFMON_EVENTSEL_OS


677 | 
ARCH_PERFMON_EVENTSEL_USR


678 | 
ARCH_PERFMON_NMI_EVENT_SEL


679 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

682 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

683 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

684 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

686 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

687 
wd
->
ev¡£l_m§
 =Évntsel_msr;

688 
wd
->
cc¸_m§
 = 0;

691 
	`˝u_nmi_£t_wd_íabÀd
();

693 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

694 
ev¡£l
 |
ARCH_PERFMON_EVENTSEL0_ENABLE
;

695 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

696 
öãl_¨ch_wd_›s
.
checkbô
 = 1ULL << (
óx
.
•lô
.
bô_width
 - 1);

698 
	}
}

700 
wd_›s
 
öãl_¨ch_wd_›s
 
	g__ªad_mo°ly
 = {

701 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

702 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

703 .
	g£tup
 = 
£tup_öãl_¨ch_w©chdog
,

704 .
	gª¨m
 = 
p6_ª¨m
,

705 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

706 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

707 .
	gev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

710 
	$¥obe_nmi_w©chdog
()

712 
boŸ_˝u_d©a
.
x86_víd‹
) {

713 
X86_VENDOR_AMD
:

714 i‡(
boŸ_˝u_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

715 
boŸ_˝u_d©a
.
x86
 != 16)

717 
wd_›s
 = &
k7_wd_›s
;

719 
X86_VENDOR_INTEL
:

726 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 14) ||

727 ((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 15 &&

728 
boŸ_˝u_d©a
.
x86_mask
 == 4))) {

729 
öãl_¨ch_wd_›s
.
≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

730 
öãl_¨ch_wd_›s
.
ev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

732 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

733 
wd_›s
 = &
öãl_¨ch_wd_›s
;

736 
boŸ_˝u_d©a
.
x86
) {

738 i‡(
boŸ_˝u_d©a
.
x86_modñ
 > 13)

741 
wd_›s
 = &
p6_wd_›s
;

744 
wd_›s
 = &
p4_wd_›s
;

751 
	}
}

755 
	$œpic_w©chdog_öô
(
nmi_hz
)

757 i‡(!
wd_›s
) {

758 
	`¥obe_nmi_w©chdog
();

759 i‡(!
wd_›s
) {

760 
	`¥ötk
(
KERN_INFO
 "NMI watchdog: CPUÇot supported\n");

764 i‡(!
wd_›s
->
	`ª£rve
()) {

765 
	`¥ötk
(
KERN_ERR


771 i‡(!(
wd_›s
->
	`£tup
(
nmi_hz
))) {

772 
	`¥ötk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

773 
	`øw_smp_¥o˚ss‹_id
());

778 
	}
}

780 
	$œpic_w©chdog_°›
()

782 i‡(
wd_›s
)

783 
wd_›s
->
	`°›
();

784 
	}
}

786 
	$œpic_adju°_nmi_hz
(
hz
)

788 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

789 i‡(
wd
->
≥rf˘r_m§
 =
MSR_P6_PERFCTR0
 ||

790 
wd
->
≥rf˘r_m§
 =
MSR_ARCH_PERFMON_PERFCTR1
)

791 
hz
 = 
	`adju°_f‹_32bô_˘r
(hz);

792  
hz
;

793 
	}
}

795 
__k¥obes
 
	$œpic_wd_evít
(
nmi_hz
)

797 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

798 
u64
 
˘r
;

800 
	`rdm§l
(
wd
->
≥rf˘r_m§
, 
˘r
);

801 i‡(
˘r
 & 
wd_›s
->
checkbô
)

804 
wd_›s
->
	`ª¨m
(
wd
, 
nmi_hz
);

806 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/˝u„©uª.h
>

9 c⁄° *c⁄° 
	gx86_powî_Êags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<löux/smp.h
>

2 
	~<löux/timex.h
>

3 
	~<löux/°rög.h
>

4 
	~<löux/£q_fûe.h
>

5 
	~<löux/˝u‰eq.h
>

10 
	$show_˝uöfo_c‹e
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
,

11 
˝u
)

13 #ifde‡
CONFIG_SMP


14 i‡(
c
->
x86_max_c‹es
 * 
smp_num_siblögs
 > 1) {

15 
	`£q_¥ötf
(
m
, "physiˇ»id\t: %d\n", 
c
->
phys_¥oc_id
);

16 
	`£q_¥ötf
(
m
, "siblings\t: %d\n",

17 
	`˝umask_weight
(
	`˝u_c‹e_mask
(
˝u
)));

18 
	`£q_¥ötf
(
m
, "c‹êid\t\t: %d\n", 
c
->
˝u_c‹e_id
);

19 
	`£q_¥ötf
(
m
, "˝u c‹es\t: %d\n", 
c
->
boŸed_c‹es
);

20 
	`£q_¥ötf
(
m
, "≠icid\t\t: %d\n", 
c
->
≠icid
);

21 
	`£q_¥ötf
(
m
, "öôü»≠icid\t: %d\n", 
c
->
öôül_≠icid
);

24 
	}
}

26 #ifde‡
CONFIG_X86_32


27 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

33 
Âu_ex˚±i⁄
 = 
c
->
h¨d_m©h
 && (
ign‹e_Âu_úq
 || 
˝u_has_Âu
);

34 
	`£q_¥ötf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
h…_w‹ks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¨d_m©h
 ? "yes" : "no",

48 
Âu_ex˚±i⁄
 ? "yes" : "no",

49 
c
->
˝uid_Àvñ
,

50 
c
->
wp_w‹ks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

55 
	`£q_¥ötf
(
m
,

60 
c
->
˝uid_Àvñ
);

61 
	}
}

64 
	$show_˝uöfo
(
£q_fûe
 *
m
, *
v
)

66 
˝uöfo_x86
 *
c
 = 
v
;

67 
˝u
 = 0;

68 
i
;

70 #ifde‡
CONFIG_SMP


71 
˝u
 = 
c
->
˝u_ödex
;

73 
	`£q_¥ötf
(
m
, "processor\t: %u\n"

78 
˝u
,

79 
c
->
x86_víd‹_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_modñ
,

82 
c
->
x86_modñ_id
[0] ? c->x86_model_id : "unknown");

84 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

85 
	`£q_¥ötf
(
m
, "°ïpög\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_¥ötf
(
m
, "stepping\t: unknown\n");

89 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
‰eq
 = 
	`˝u‰eq_quick_gë
(
˝u
);

92 i‡(!
‰eq
)

93 
‰eq
 = 
˝u_khz
;

94 
	`£q_¥ötf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
‰eq
 / 1000, (freq % 1000));

99 i‡(
c
->
x86_ˇche_size
 >= 0)

100 
	`£q_¥ötf
(
m
, "ˇchêsize\t: %d KB\n", 
c
->
x86_ˇche_size
);

102 
	`show_˝uöfo_c‹e
(
m
, 
c
, 
˝u
);

103 
	`show_˝uöfo_misc
(
m
, 
c
);

105 
	`£q_¥ötf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 i‡(
	`˝u_has
(
c
, 
i
Ë&& 
x86_ˇp_Êags
[i] !
NULL
)

108 
	`£q_¥ötf
(
m
, " %s", 
x86_ˇp_Êags
[
i
]);

110 
	`£q_¥ötf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
lo›s_≥r_jiffy
/(500000/
HZ
),

112 (
c
->
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100);

114 #ifde‡
CONFIG_X86_64


115 i‡(
c
->
x86_ébsize
 > 0)

116 
	`£q_¥ötf
(
m
, "TLB size\t: %d 4KÖages\n", 
c
->
x86_ébsize
);

118 
	`£q_¥ötf
(
m
, "˛Êush size\t: %u\n", 
c
->
x86_˛Êush_size
);

119 
	`£q_¥ötf
(
m
, "ˇche_Æignmít\t: %d\n", 
c
->
x86_ˇche_Æignmít
);

120 
	`£q_¥ötf
(
m
, "address sizes\t: %u bitsÖhysical, %u bits virtual\n",

121 
c
->
x86_phys_bôs
, c->
x86_vút_bôs
);

123 
	`£q_¥ötf
(
m
, "power management:");

124 
i
 = 0; i < 32; i++) {

125 i‡(
c
->
x86_powî
 & (1 << 
i
)) {

126 i‡(
i
 < 
	`ARRAY_SIZE
(
x86_powî_Êags
) &&

127 
x86_powî_Êags
[
i
])

128 
	`£q_¥ötf
(
m
, "%s%s",

129 
x86_powî_Êags
[
i
][0] ? " " : "",

130 
x86_powî_Êags
[
i
]);

132 
	`£q_¥ötf
(
m
, " [%d]", 
i
);

136 
	`£q_¥ötf
(
m
, "\n\n");

139 
	}
}

141 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

143 i‡(*
pos
 == 0)

144 *
pos
 = 
	`˝umask_fú°
(
˝u_⁄löe_mask
);

146 *
pos
 = 
	`˝umask_√xt
(*po†- 1, 
˝u_⁄löe_mask
);

147 i‡((*
pos
Ë< 
ƒ_˝u_ids
)

148  &
	`˝u_d©a
(*
pos
);

149  
NULL
;

150 
	}
}

152 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

154 (*
pos
)++;

155  
	`c_°¨t
(
m
, 
pos
);

156 
	}
}

158 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

160 
	}
}

162 c⁄° 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

163 .
°¨t
 = 
c_°¨t
,

164 .
	g√xt
 = 
c_√xt
,

165 .
	g°›
 = 
c_°›
,

166 .
	gshow
 = 
show_˝uöfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/sched.c

1 
	~<löux/sched.h
>

2 
	~<löux/m©h64.h
>

3 
	~<löux/≥r˝u.h
>

4 
	~<löux/úqÊags.h
>

6 
	~<asm/˝u„©uª.h
>

7 
	~<asm/¥o˚ss‹.h
>

9 #ifde‡
CONFIG_SMP


11 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ﬁd_≥rf_sched
);

13 
	$sˇÀ_≠îfm≥rf
()

15 
≠îfm≥rf
 
vÆ
, *
ﬁd
 = &
	`__gë_˝u_v¨
(
ﬁd_≥rf_sched
);

16 
øtio
, 
Êags
;

18 
	`loˇl_úq_ßve
(
Êags
);

19 
	`gë_≠îfm≥rf
(&
vÆ
);

20 
	`loˇl_úq_ª°‹e
(
Êags
);

22 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(
ﬁd
, &
vÆ
);

23 *
ﬁd
 = 
vÆ
;

25  
øtio
;

26 
	}
}

28 
	$¨ch_sˇÀ_‰eq_powî
(
sched_domaö
 *
sd
, 
˝u
)

34 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

35  
	`sˇÀ_≠îfm≥rf
();

41  
	`deÁu…_sˇÀ_‰eq_powî
(
sd
, 
˝u
);

42 
	}
}

44 
	$¨ch_sˇÀ_smt_powî
(
sched_domaö
 *
sd
, 
˝u
)

49 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

50  
SCHED_LOAD_SCALE
;

52  
	`deÁu…_sˇÀ_smt_powî
(
sd
, 
˝u
);

53 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<löux/dmi.h
>

25 
	~<asm/div64.h
>

26 
	~<asm/vmw¨e.h
>

27 
	~<asm/x86_öô.h
>

29 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

30 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

31 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

33 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

34 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

36 
	#VMWARE_PORT
(
cmd
, 
óx
, 
ebx
, 
ecx
, 
edx
) \

37 
	`__asm__
("inl (%%dx)" : \

38 "˜"(
óx
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

39 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

40 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

41 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

42 "mem‹y");

	)

44 
ölöe
 
	$__vmw¨e_∂©f‹m
()

46 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

47 
	`VMWARE_PORT
(
GETVERSION
, 
óx
, 
ebx
, 
ecx
, 
edx
);

48  
óx
 !(
uöt32_t
)-1 && 
ebx
 =
VMWARE_HYPERVISOR_MAGIC
;

49 
	}
}

51 
	$vmw¨e_gë_tsc_khz
()

53 
uöt64_t
 
tsc_hz
;

54 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

56 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

58 
tsc_hz
 = 
óx
 | (((
uöt64_t
)
ebx
) << 32);

59 
	`do_div
(
tsc_hz
, 1000);

60 
	`BUG_ON
(
tsc_hz
 >> 32);

61 
	`¥ötk
(
KERN_INFO
 "TSC freqÑead from hypervisor : %lu.%03lu MHz\n",

62 (Ë
tsc_hz
 / 1000,

63 (Ë
tsc_hz
 % 1000);

64  
tsc_hz
;

65 
	}
}

67 
__öô
 
	$vmw¨e_∂©f‹m_£tup
()

69 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

71 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

73 i‡(
ebx
 !
UINT_MAX
)

74 
x86_∂©f‹m
.
ˇlibøã_tsc
 = 
vmw¨e_gë_tsc_khz
;

76 
	`¥ötk
(
KERN_WARNING


78 
	}
}

85 
	$vmw¨e_∂©f‹m
()

87 i‡(
˝u_has_hy≥rvis‹
) {

88 
óx
, 
ebx
, 
ecx
, 
edx
;

89 
hy≥r_víd‹_id
[13];

91 
	`˝uid
(
CPUID_VMWARE_INFO_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
	`mem˝y
(
hy≥r_víd‹_id
 + 0, &
ebx
, 4);

93 
	`mem˝y
(
hy≥r_víd‹_id
 + 4, &
ecx
, 4);

94 
	`mem˝y
(
hy≥r_víd‹_id
 + 8, &
edx
, 4);

95 
hy≥r_víd‹_id
[12] = '\0';

96 i‡(!
	`°rcmp
(
hy≥r_víd‹_id
, "VMwareVMware"))

98 } i‡(
dmi_avaûabÀ
 && 
	`dmi_«me_ö_£rül
("VMware") &&

99 
	`__vmw¨e_∂©f‹m
())

103 
	}
}

117 
__˝uöô
 
	$vmw¨e_£t_„©uª_bôs
(
˝uöfo_x86
 *
c
)

119 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

120 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<löux/moduÀ.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/î∫o.h
>

32 
	~<löux/f˙é.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/smp_lock.h
>

37 
	~<löux/maj‹.h
>

38 
	~<löux/fs.h
>

39 
	~<löux/devi˚.h
>

40 
	~<löux/˝u.h
>

41 
	~<löux/nŸifõr.h
>

42 
	~<löux/uac˚ss.h
>

44 
	~<asm/¥o˚ss‹.h
>

45 
	~<asm/m§.h
>

46 
	~<asm/sy°em.h
>

48 
˛ass
 *
	g˝uid_˛ass
;

50 
	s˝uid_ªgs
 {

51 
u32
 
	móx
, 
	mebx
, 
	mecx
, 
	medx
;

54 
	$˝uid_smp_˝uid
(*
cmd_block
)

56 
˝uid_ªgs
 *
cmd
 = (˝uid_ªg†*)
cmd_block
;

58 
	`˝uid_cou¡
(
cmd
->
óx
, cmd->
ecx
,

59 &
cmd
->
óx
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

60 
	}
}

62 
loff_t
 
	$˝uid_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

64 
loff_t
 
ªt
;

65 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

67 
	`muãx_lock
(&
öode
->
i_muãx
);

68 
‹ig
) {

70 
fûe
->
f_pos
 = 
off£t
;

71 
ªt
 = 
fûe
->
f_pos
;

74 
fûe
->
f_pos
 +
off£t
;

75 
ªt
 = 
fûe
->
f_pos
;

78 
ªt
 = -
EINVAL
;

80 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

81  
ªt
;

82 
	}
}

84 
ssize_t
 
	$˝uid_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

85 
size_t
 
cou¡
, 
loff_t
 *
µos
)

87 
__u£r
 *
tmp
 = 
buf
;

88 
˝uid_ªgs
 
cmd
;

89 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

90 
u64
 
pos
 = *
µos
;

91 
ssize_t
 
byãs
 = 0;

92 
îr
 = 0;

94 i‡(
cou¡
 % 16)

95  -
EINVAL
;

97 ; 
cou¡
; count -= 16) {

98 
cmd
.
óx
 = 
pos
;

99 
cmd
.
ecx
 = 
pos
 >> 32;

100 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝uid_smp_˝uid
, &
cmd
, 1);

101 i‡(
îr
)

103 i‡(
	`c›y_to_u£r
(
tmp
, &
cmd
, 16)) {

104 
îr
 = -
EFAULT
;

107 
tmp
 += 16;

108 
byãs
 += 16;

109 *
µos
 = ++
pos
;

112  
byãs
 ? byã†: 
îr
;

113 
	}
}

115 
	$˝uid_›í
(
öode
 *öode, 
fûe
 *file)

117 
˝u
;

118 
˝uöfo_x86
 *
c
;

119 
ªt
 = 0;

121 
	`lock_kî√l
();

123 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

124 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu)) {

125 
ªt
 = -
ENXIO
;

126 
out
;

128 
c
 = &
	`˝u_d©a
(
˝u
);

129 i‡(
c
->
˝uid_Àvñ
 < 0)

130 
ªt
 = -
EIO
;

131 
out
:

132 
	`u∆ock_kî√l
();

133  
ªt
;

134 
	}
}

139 c⁄° 
fûe_›î©i⁄s
 
	g˝uid_f›s
 = {

140 .
ow√r
 = 
THIS_MODULE
,

141 .
	gŒ£ek
 = 
˝uid_£ek
,

142 .
	gªad
 = 
˝uid_ªad
,

143 .
	g›í
 = 
˝uid_›í
,

146 
__˝uöô
 
	$˝uid_devi˚_¸óã
(
˝u
)

148 
devi˚
 *
dev
;

150 
dev
 = 
	`devi˚_¸óã
(
˝uid_˛ass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
), NULL,

151 "˝u%d", 
˝u
);

152  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

153 
	}
}

155 
	$˝uid_devi˚_de°roy
(
˝u
)

157 
	`devi˚_de°roy
(
˝uid_˛ass
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
));

158 
	}
}

160 
__˝uöô
 
	$˝uid_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

161 
a˘i⁄
,

162 *
h˝u
)

164 
˝u
 = ()
h˝u
;

165 
îr
 = 0;

167 
a˘i⁄
) {

168 
CPU_UP_PREPARE
:

169 
îr
 = 
	`˝uid_devi˚_¸óã
(
˝u
);

171 
CPU_UP_CANCELED
:

172 
CPU_UP_CANCELED_FROZEN
:

173 
CPU_DEAD
:

174 
	`˝uid_devi˚_de°roy
(
˝u
);

177  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

178 
	}
}

180 
nŸifõr_block
 
__ªfd©a
 
	g˝uid_˛ass_˝u_nŸifõr
 =

182 .
nŸifõr_ˇŒ
 = 
˝uid_˛ass_˝u_ˇŒback
,

185 *
	$˝uid_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

187  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/˝uid", 
	`MINOR
(
dev
->
devt
));

188 
	}
}

190 
__öô
 
	$˝uid_öô
()

192 
i
, 
îr
 = 0;

193 
i
 = 0;

195 i‡(
	`ªgi°î_chrdev
(
CPUID_MAJOR
, "˝u/˝uid", &
˝uid_f›s
)) {

196 
	`¥ötk
(
KERN_ERR
 "cpuid: unableÅo get major %d for cpuid\n",

197 
CPUID_MAJOR
);

198 
îr
 = -
EBUSY
;

199 
out
;

201 
˝uid_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "cpuid");

202 i‡(
	`IS_ERR
(
˝uid_˛ass
)) {

203 
îr
 = 
	`PTR_ERR
(
˝uid_˛ass
);

204 
out_chrdev
;

206 
˝uid_˛ass
->
devnode
 = 
˝uid_devnode
;

207 
	`f‹_óch_⁄löe_˝u
(
i
) {

208 
îr
 = 
	`˝uid_devi˚_¸óã
(
i
);

209 i‡(
îr
 != 0)

210 
out_˛ass
;

212 
	`ªgi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

214 
îr
 = 0;

215 
out
;

217 
out_˛ass
:

218 
i
 = 0;

219 
	`f‹_óch_⁄löe_˝u
(
i
) {

220 
	`˝uid_devi˚_de°roy
(
i
);

222 
	`˛ass_de°roy
(
˝uid_˛ass
);

223 
out_chrdev
:

224 
	`uƒegi°î_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

225 
out
:

226  
îr
;

227 
	}
}

229 
__exô
 
	$˝uid_exô
()

231 
˝u
 = 0;

233 
	`f‹_óch_⁄löe_˝u
(
˝u
)

234 
	`˝uid_devi˚_de°roy
(
˝u
);

235 
	`˛ass_de°roy
(
˝uid_˛ass
);

236 
	`uƒegi°î_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

237 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

238 
	}
}

240 
moduÀ_öô
(
˝uid_öô
);

241 
moduÀ_exô
(
˝uid_exô
);

243 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

244 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

245 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<löux/öô.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/ªboŸ.h
>

15 
	~<löux/kexec.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/ñfc‹e.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/h¨dúq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_úq.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/h≥t.h
>

26 
	~<löux/kdebug.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ªboŸ.h
>

29 
	~<asm/vúãxt.h
>

30 
	~<asm/iommu.h
>

33 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

35 
	$kdump_nmi_ˇŒback
(
˝u
, 
dõ_¨gs
 *
¨gs
)

37 
±_ªgs
 *
ªgs
;

38 #ifde‡
CONFIG_X86_32


39 
±_ªgs
 
fixed_ªgs
;

42 
ªgs
 = 
¨gs
->regs;

44 #ifde‡
CONFIG_X86_32


45 i‡(!
	`u£r_mode_vm
(
ªgs
)) {

46 
	`¸ash_fixup_ss_e•
(&
fixed_ªgs
, 
ªgs
);

47 
ªgs
 = &
fixed_ªgs
;

50 
	`¸ash_ßve_˝u
(
ªgs
, 
˝u
);

58 
	`˝u_emîgícy_vmxoff
();

59 
	`˝u_emîgícy_svm_dißbÀ
();

61 
	`dißbÀ_loˇl_APIC
();

62 
	}
}

64 
	$kdump_nmi_shoŸdown_˝us
()

66 
	`nmi_shoŸdown_˝us
(
kdump_nmi_ˇŒback
);

68 
	`dißbÀ_loˇl_APIC
();

69 
	}
}

72 
	$kdump_nmi_shoŸdown_˝us
()

75 
	}
}

78 
	$«tive_machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

89 
	`loˇl_úq_dißbÀ
();

91 
	`kdump_nmi_shoŸdown_˝us
();

97 
	`˝u_emîgícy_vmxoff
();

98 
	`˝u_emîgícy_svm_dißbÀ
();

100 
	`œpic_shutdown
();

101 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

102 
	`dißbÀ_IO_APIC
();

104 #ifde‡
CONFIG_HPET_TIMER


105 
	`h≥t_dißbÀ
();

108 #ifde‡
CONFIG_X86_64


109 
	`pci_iommu_shutdown
();

112 
	`¸ash_ßve_˝u
(
ªgs
, 
	`ß„_smp_¥o˚ss‹_id
());

113 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/io.h
>

14 
	gñfc‹ehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$c›y_ﬁdmem_∑ge
(
p‚
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 i‡(!
csize
)

37 
vaddr
 = 
	`i‹em≠
(
p‚
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 i‡(!
vaddr
)

39  -
ENOMEM
;

41 i‡(
u£rbuf
) {

42 i‡(
	`c›y_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm≠
(
vaddr
);

44  -
EFAULT
;

47 
	`mem˝y
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm≠
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/·ø˚.h
>

14 
	~<löux/kexec.h
>

15 
	~<löux/bug.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/sysfs.h
>

19 
	~<asm/°ackåa˚.h
>

21 
	~"dump°ack.h
"

23 
	g∑nic_⁄_uƒecovîed_nmi
;

24 
	g∑nic_⁄_io_nmi
;

25 
	gcode_byãs
 = 64;

26 
	gk°ack_dïth_to_¥öt
 = 3 * 
STACKSLOTS_PER_LINE
;

27 
	gdõ_cou¡î
;

29 
	$¥ötk_addªss
(
addªss
, 
ªlübÀ
)

31 
	`¥ötk
(" [<%p>] %s%pS\n", (*Ë
addªss
,

32 
ªlübÀ
 ? "" : "? ", (*Ë
addªss
);

33 
	}
}

35 #ifde‡
CONFIG_FUNCTION_GRAPH_TRACER


37 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

38 c⁄° 
°ackåa˚_›s
 *
›s
,

39 
thªad_öfo
 *
töfo
, *
gøph
)

41 
èsk_°ru˘
 *
èsk
 = 
töfo
->task;

42 
ªt_addr
;

43 
ödex
 = 
èsk
->
cuº_ªt_°ack
;

45 i‡(
addr
 !()
ªtu∫_to_h™dÀr
)

48 i‡(!
èsk
->
ªt_°ack
 || 
ödex
 < *
gøph
)

51 
ödex
 -*
gøph
;

52 
ªt_addr
 = 
èsk
->
ªt_°ack
[
ödex
].
ªt
;

54 
›s
->
	`addªss
(
d©a
, 
ªt_addr
, 1);

56 (*
gøph
)++;

57 
	}
}

59 
ölöe
 

60 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

61 c⁄° 
°ackåa˚_›s
 *
›s
,

62 
thªad_öfo
 *
töfo
, *
gøph
)

63 { 
	}
}

73 
ölöe
 
	$vÆid_°ack_±r
(
thªad_öfo
 *
töfo
,

74 *
p
, 
size
, *
íd
)

76 *
t
 = 
töfo
;

77 i‡(
íd
) {

78 i‡(
p
 < 
íd
 &&Ö >”nd-
THREAD_SIZE
))

83  
p
 > 
t
 &&Ö <Å + 
THREAD_SIZE
 - 
size
;

84 
	}
}

87 
	$¥öt_c⁄ãxt_°ack
(
thªad_öfo
 *
töfo
,

88 *
°ack
, 
bp
,

89 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

90 *
íd
, *
gøph
)

92 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

94 
	`vÆid_°ack_±r
(
töfo
, 
°ack
, (*°ack), 
íd
)) {

95 
addr
;

97 
addr
 = *
°ack
;

98 i‡(
	`__kî√l_ãxt_addªss
(
addr
)) {

99 i‡((Ë
°ack
 =
bp
 + ()) {

100 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

101 
‰ame
 = føme->
√xt_‰ame
;

102 
bp
 = (Ë
‰ame
;

104 
›s
->
	`addªss
(
d©a
, 
addr
, 0);

106 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

108 
°ack
++;

110  
bp
;

111 
	}
}

115 
	$¥öt_åa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

117 
	`¥ötk
(
d©a
);

118 
	`¥öt_symbﬁ
(
msg
, 
symbﬁ
);

119 
	`¥ötk
("\n");

120 
	}
}

122 
	$¥öt_åa˚_w¨nög
(*
d©a
, *
msg
)

124 
	`¥ötk
("%s%s\n", (*)
d©a
, 
msg
);

125 
	}
}

127 
	$¥öt_åa˚_°ack
(*
d©a
, *
«me
)

129 
	`¥ötk
("%†<%s> ", (*)
d©a
, 
«me
);

131 
	}
}

136 
	$¥öt_åa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

138 
	`touch_nmi_w©chdog
();

139 
	`¥ötk
(
d©a
);

140 
	`¥ötk_addªss
(
addr
, 
ªlübÀ
);

141 
	}
}

143 c⁄° 
°ackåa˚_›s
 
	g¥öt_åa˚_›s
 = {

144 .
w¨nög
 = 
¥öt_åa˚_w¨nög
,

145 .
	gw¨nög_symbﬁ
 = 
¥öt_åa˚_w¨nög_symbﬁ
,

146 .
	g°ack
 = 
¥öt_åa˚_°ack
,

147 .
	gaddªss
 = 
¥öt_åa˚_addªss
,

151 
	$show_åa˚_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

152 *
°ack
, 
bp
, *
log_lvl
)

154 
	`¥ötk
("%sCÆ»Tø˚:\n", 
log_lvl
);

155 
	`dump_åa˚
(
èsk
, 
ªgs
, 
°ack
, 
bp
, &
¥öt_åa˚_›s
, 
log_lvl
);

156 
	}
}

158 
	$show_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

159 *
°ack
, 
bp
)

161 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
°ack
, 
bp
, "");

162 
	}
}

164 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

166 
	`show_°ack_log_lvl
(
èsk
, 
NULL
, 
•
, 0, "");

167 
	}
}

172 
	$dump_°ack
()

174 
bp
 = 0;

175 
°ack
;

177 #ifde‡
CONFIG_FRAME_POINTER


178 i‡(!
bp
)

179 
	`gë_bp
(
bp
);

182 
	`¥ötk
("Pid: %d, comm: %.20s %s %s %.*s\n",

183 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

184 
	`öô_ut¢ame
()->
ªÀa£
,

185 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

186 
	`öô_ut¢ame
()->
vîsi⁄
);

187 
	`show_åa˚
(
NULL
, NULL, &
°ack
, 
bp
);

188 
	}
}

189 
EXPORT_SYMBOL
(
dump_°ack
);

191 
øw_•ölock_t
 
	gdõ_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

192 
	gdõ_ow√r
 = -1;

193 
	gdõ_√°_cou¡
;

195 
__k¥obes
 
	$o›s_begö
()

197 
˝u
;

198 
Êags
;

203 
	`åa˚_hw_bønch_o›s
();

205 
	`o›s_íãr
();

208 
	`øw_loˇl_úq_ßve
(
Êags
);

209 
˝u
 = 
	`smp_¥o˚ss‹_id
();

210 i‡(!
	`__øw_•ö_åylock
(&
dõ_lock
)) {

211 i‡(
˝u
 =
dõ_ow√r
)

214 
	`__øw_•ö_lock
(&
dõ_lock
);

216 
dõ_√°_cou¡
++;

217 
dõ_ow√r
 = 
˝u
;

218 
	`c⁄sﬁe_vîbo£
();

219 
	`bu°_•ölocks
(1);

220  
Êags
;

221 
	}
}

223 
__k¥obes
 
	$o›s_íd
(
Êags
, 
±_ªgs
 *
ªgs
, 
sigƒ
)

225 i‡(
ªgs
 && 
	`kexec_should_¸ash
(
cuºít
))

226 
	`¸ash_kexec
(
ªgs
);

228 
	`bu°_•ölocks
(0);

229 
dõ_ow√r
 = -1;

230 
	`add_èöt
(
TAINT_DIE
);

231 
dõ_√°_cou¡
--;

232 i‡(!
dõ_√°_cou¡
)

234 
	`__øw_•ö_u∆ock
(&
dõ_lock
);

235 
	`øw_loˇl_úq_ª°‹e
(
Êags
);

236 
	`o›s_exô
();

238 i‡(!
sigƒ
)

240 i‡(
	`ö_öãºu±
())

241 
	`∑nic
("FatalÉxception in interrupt");

242 i‡(
∑nic_⁄_o›s
)

243 
	`∑nic
("FatalÉxception");

244 
	`do_exô
(
sigƒ
);

245 
	}
}

247 
__k¥obes
 
	$__dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

249 #ifde‡
CONFIG_X86_32


250 
ss
;

251 
•
;

253 
	`¥ötk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
°r
, 
îr
 & 0xffff, ++
dõ_cou¡î
);

254 #ifde‡
CONFIG_PREEMPT


255 
	`¥ötk
("PREEMPT ");

257 #ifde‡
CONFIG_SMP


258 
	`¥ötk
("SMP ");

260 #ifde‡
CONFIG_DEBUG_PAGEALLOC


261 
	`¥ötk
("DEBUG_PAGEALLOC");

263 
	`¥ötk
("\n");

264 
	`sysfs_¥ötk_œ°_fûe
();

265 i‡(
	`nŸify_dõ
(
DIE_OOPS
, 
°r
, 
ªgs
, 
îr
,

266 
cuºít
->
thªad
.
å≠_no
, 
SIGSEGV
Ë=
NOTIFY_STOP
)

269 
	`show_ªgi°îs
(
ªgs
);

270 #ifde‡
CONFIG_X86_32


271 
•
 = (Ë(&
ªgs
->sp);

272 
	`ßve£gmít
(
ss
, ss);

273 i‡(
	`u£r_mode
(
ªgs
)) {

274 
•
 = 
ªgs
->sp;

275 
ss
 = 
ªgs
->ss & 0xffff;

277 
	`¥ötk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
ªgs
->
ù
);

278 
	`¥öt_symbﬁ
("%s", 
ªgs
->
ù
);

279 
	`¥ötk
(" SS:ESP %04x:%08lx\n", 
ss
, 
•
);

282 
	`¥ötk
(
KERN_ALERT
 "RIP ");

283 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

284 
	`¥ötk
(" RSP <%016lx>\n", 
ªgs
->
•
);

287 
	}
}

293 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

295 
Êags
 = 
	`o›s_begö
();

296 
sig
 = 
SIGSEGV
;

298 i‡(!
	`u£r_mode_vm
(
ªgs
))

299 
	`ªp‹t_bug
(
ªgs
->
ù
,Ñegs);

301 i‡(
	`__dõ
(
°r
, 
ªgs
, 
îr
))

302 
sig
 = 0;

303 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

304 
	}
}

306 
nŸø˚
 
__k¥obes


307 
	$dõ_nmi
(*
°r
, 
±_ªgs
 *
ªgs
, 
do_∑nic
)

309 
Êags
;

311 i‡(
	`nŸify_dõ
(
DIE_NMIWATCHDOG
, 
°r
, 
ªgs
, 0, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

318 
Êags
 = 
	`o›s_begö
();

319 
	`¥ötk
(
KERN_EMERG
 "%s", 
°r
);

320 
	`¥ötk
(" on CPU%d, ip %08lx,Ñegisters:\n",

321 
	`smp_¥o˚ss‹_id
(), 
ªgs
->
ù
);

322 
	`show_ªgi°îs
(
ªgs
);

323 
	`o›s_íd
(
Êags
, 
ªgs
, 0);

324 i‡(
do_∑nic
 || 
∑nic_⁄_o›s
)

325 
	`∑nic
("Non maskable interrupt");

326 
	`nmi_exô
();

327 
	`loˇl_úq_íabÀ
();

328 
	`do_exô
(
SIGBUS
);

329 
	}
}

331 
__öô
 
	$o›s_£tup
(*
s
)

333 i‡(!
s
)

334  -
EINVAL
;

335 i‡(!
	`°rcmp
(
s
, "panic"))

336 
∑nic_⁄_o›s
 = 1;

338 
	}
}

339 
óæy_∑øm
("o›s", 
o›s_£tup
);

341 
__öô
 
	$k°ack_£tup
(*
s
)

343 i‡(!
s
)

344  -
EINVAL
;

345 
k°ack_dïth_to_¥öt
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

347 
	}
}

348 
óæy_∑øm
("k°ack", 
k°ack_£tup
);

350 
__öô
 
	$code_byãs_£tup
(*
s
)

352 
code_byãs
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

353 i‡(
code_byãs
 > 8192)

354 
code_byãs
 = 8192;

357 
	}
}

358 
__£tup
("code_byãs=", 
code_byãs_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/h¨dúq.h
>

9 
	~<löux/kdebug.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/±ø˚.h
>

12 
	~<löux/kexec.h
>

13 
	~<löux/bug.h
>

14 
	~<löux/nmi.h
>

15 
	~<löux/sysfs.h
>

17 
	~<asm/°ackåa˚.h
>

19 
	~"dump°ack.h
"

22 
	gx86_°ack_ids
[][8] = {

23 [
DEBUG_STACK
 - 1] = "#DB",

24 [
NMI_STACK
 - 1] = "NMI",

25 [
DOUBLEFAULT_STACK
 - 1] = "#DF",

26 [
STACKFAULT_STACK
 - 1] = "#SS",

27 [
MCE_STACK
 - 1] = "#MC",

28 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


29 [
N_EXCEPTION_STACKS
 ...

30 
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
 / 
EXCEPTION_STKSZ
 - 2] = "#DB[?]"

34 
	$x86_is_°ack_id
(
id
, *
«me
)

36  
x86_°ack_ids
[
id
 - 1] =
«me
;

37 
	}
}

39 *
	$ö_ex˚±i⁄_°ack
(
˝u
, 
°ack
,

40 *
u£dp
, **
idp
)

42 
k
;

48 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

49 
íd
 = 
	`≥r_˝u
(
‹ig_i°
, 
˝u
).
i°
[
k
];

54 i‡(
°ack
 >
íd
)

60 i‡(
°ack
 >
íd
 - 
EXCEPTION_STKSZ
) {

67 i‡(*
u£dp
 & (1U << 
k
))

69 *
u£dp
 |1U << 
k
;

70 *
idp
 = 
x86_°ack_ids
[
k
];

71  (*)
íd
;

78 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


79 i‡(
k
 =
DEBUG_STACK
 - 1 && 
°ack
 >
íd
 - 
DEBUG_STKSZ
) {

80 
j
 = 
N_EXCEPTION_STACKS
 - 1;

88 ++
j
;

89 
íd
 -
EXCEPTION_STKSZ
;

90 
x86_°ack_ids
[
j
][4] = '1' +

91 (
j
 - 
N_EXCEPTION_STACKS
);

92 } 
°ack
 < 
íd
 - 
EXCEPTION_STKSZ
);

93 i‡(*
u£dp
 & (1U << 
j
))

95 *
u£dp
 |1U << 
j
;

96 *
idp
 = 
x86_°ack_ids
[
j
];

97  (*)
íd
;

101  
NULL
;

102 
	}
}

111 
	$dump_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

112 *
°ack
, 
bp
,

113 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
)

115 c⁄° 
˝u
 = 
	`gë_˝u
();

116 *
úq_°ack_íd
 =

117 (*)
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
);

118 
u£d
 = 0;

119 
thªad_öfo
 *
töfo
;

120 
gøph
 = 0;

122 i‡(!
èsk
)

123 
èsk
 = 
cuºít
;

125 i‡(!
°ack
) {

126 
dummy
;

127 
°ack
 = &
dummy
;

128 i‡(
èsk
 &&Åask !
cuºít
)

129 
°ack
 = (*)
èsk
->
thªad
.
•
;

132 #ifde‡
CONFIG_FRAME_POINTER


133 i‡(!
bp
) {

134 i‡(
èsk
 =
cuºít
) {

136 
	`gë_bp
(
bp
);

139 
bp
 = *(*Ë
èsk
->
thªad
.
•
;

149 
töfo
 = 
	`èsk_thªad_öfo
(
èsk
);

151 *
id
;

152 *
e°ack_íd
;

153 
e°ack_íd
 = 
	`ö_ex˚±i⁄_°ack
(
˝u
, ()
°ack
,

154 &
u£d
, &
id
);

156 i‡(
e°ack_íd
) {

157 i‡(
›s
->
	`°ack
(
d©a
, 
id
) < 0)

160 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp, 
›s
,

161 
d©a
, 
e°ack_íd
, &
gøph
);

162 
›s
->
	`°ack
(
d©a
, "<EOE>");

168 
°ack
 = (*Ë
e°ack_íd
[-2];

171 i‡(
úq_°ack_íd
) {

172 *
úq_°ack
;

173 
úq_°ack
 = 
úq_°ack_íd
 -

174 (
IRQ_STACK_SIZE
 - 64Ë/ (*
úq_°ack
);

176 i‡(
°ack
 >
úq_°ack
 && sèck < 
úq_°ack_íd
) {

177 i‡(
›s
->
	`°ack
(
d©a
, "IRQ") < 0)

179 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp,

180 
›s
, 
d©a
, 
úq_°ack_íd
, &
gøph
);

186 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

187 
úq_°ack_íd
 = 
NULL
;

188 
›s
->
	`°ack
(
d©a
, "EOI");

198 
bp
 = 
	`¥öt_c⁄ãxt_°ack
(
töfo
, 
°ack
, bp, 
›s
, 
d©a
, 
NULL
, &
gøph
);

199 
	`put_˝u
();

200 
	}
}

201 
EXPORT_SYMBOL
(
dump_åa˚
);

204 
	$show_°ack_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

205 *
•
, 
bp
, *
log_lvl
)

207 *
°ack
;

208 
i
;

209 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

210 *
úq_°ack_íd
 =

211 (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
));

212 *
úq_°ack
 =

213 (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
Ë- 
IRQ_STACK_SIZE
);

220 i‡(
•
 =
NULL
) {

221 i‡(
èsk
)

222 
•
 = (*)
èsk
->
thªad
.sp;

224 
•
 = (*)&sp;

227 
°ack
 = 
•
;

228 
i
 = 0; i < 
k°ack_dïth_to_¥öt
; i++) {

229 i‡(
°ack
 >
úq_°ack
 && sèck <
úq_°ack_íd
) {

230 i‡(
°ack
 =
úq_°ack_íd
) {

231 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

232 
	`¥ötk
(" <EOI> ");

235 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

238 i‡(
i
 && ((ò% 
STACKSLOTS_PER_LINE
) == 0))

239 
	`¥ötk
("\n%s", 
log_lvl
);

240 
	`¥ötk
(" %016lx", *
°ack
++);

241 
	`touch_nmi_w©chdog
();

243 
	`¥ötk
("\n");

244 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
•
, 
bp
, 
log_lvl
);

245 
	}
}

247 
	$show_ªgi°îs
(
±_ªgs
 *
ªgs
)

249 
i
;

250 
•
;

251 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

252 
èsk_°ru˘
 *
cur
 = 
cuºít
;

254 
•
 = 
ªgs
->sp;

255 
	`¥ötk
("CPU %d ", 
˝u
);

256 
	`__show_ªgs
(
ªgs
, 1);

257 
	`¥ötk
("Process %s (pid: %d,Åhreadinfo %p,Åask %p)\n",

258 
cur
->
comm
, cur->
pid
, 
	`èsk_thªad_öfo
(cur), cur);

264 i‡(!
	`u£r_mode
(
ªgs
)) {

265 
code_¥ﬁogue
 = 
code_byãs
 * 43 / 64;

266 
code_Àn
 = 
code_byãs
;

267 
c
;

268 
u8
 *
ù
;

270 
	`¥ötk
(
KERN_EMERG
 "Stack:\n");

271 
	`show_°ack_log_lvl
(
NULL
, 
ªgs
, (*)
•
,

272 
ªgs
->
bp
, 
KERN_EMERG
);

274 
	`¥ötk
(
KERN_EMERG
 "Code: ");

276 
ù
 = (
u8
 *)
ªgs
->ù - 
code_¥ﬁogue
;

277 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 || 
	`¥obe_kî√l_addªss
(ù, 
c
)) {

279 
ù
 = (
u8
 *)
ªgs
->ip;

280 
code_Àn
 = code_À¿- 
code_¥ﬁogue
 + 1;

282 
i
 = 0; i < 
code_Àn
; i++, 
ù
++) {

283 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 ||

284 
	`¥obe_kî√l_addªss
(
ù
, 
c
)) {

285 
	`¥ötk
(" Bad RIP value.");

288 i‡(
ù
 =(
u8
 *)
ªgs
->ip)

289 
	`¥ötk
("<%02x> ", 
c
);

291 
	`¥ötk
("%02x ", 
c
);

294 
	`¥ötk
("\n");

295 
	}
}

297 
	$is_vÆid_bugaddr
(
ù
)

299 
ud2
;

301 i‡(
	`__c›y_‰om_u£r
(&
ud2
, (c⁄° 
__u£r
 *Ë
ù
, (ud2)))

304  
ud2
 == 0x0b0f;

305 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/boŸmem.h
>

15 
	~<löux/i›‹t.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/kexec.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/p‚.h
>

21 
	~<löux/su•íd.h
>

22 
	~<löux/fúmw¨e-m≠.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/∑ge.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/¥Ÿo.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/åampﬁöe.h
>

45 
e820m≠
 
	ge820
;

46 
e820m≠
 
	ge820_ßved
;

49 
	gpci_mem_°¨t
 = 0xaeedbabe;

50 #ifde‡
CONFIG_PCI


51 
EXPORT_SYMBOL
(
pci_mem_°¨t
);

59 
	$e820_™y_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

61 
i
;

63 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

64 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

66 i‡(
ty≥
 && 
ei
->type !=Åype)

68 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

73 
	}
}

74 
EXPORT_SYMBOL_GPL
(
e820_™y_m≠≥d
);

82 
__öô
 
	$e820_Æl_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

84 
i
;

86 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

87 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

89 i‡(
ty≥
 && 
ei
->type !=Åype)

92 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

98 i‡(
ei
->
addr
 <
°¨t
)

99 
°¨t
 = 
ei
->
addr
 +Éi->
size
;

104 i‡(
°¨t
 >
íd
)

108 
	}
}

113 
__öô
 
	$__e820_add_ªgi⁄
(
e820m≠
 *
e820x
, 
u64
 
°¨t
, u64 
size
,

114 
ty≥
)

116 
x
 = 
e820x
->
ƒ_m≠
;

118 i‡(
x
 >
	`ARRAY_SIZE
(
e820x
->
m≠
)) {

119 
	`¥ötk
(
KERN_ERR
 "Ooops! Too manyÉntries inÅhe memory map!\n");

123 
e820x
->
m≠
[
x
].
addr
 = 
°¨t
;

124 
e820x
->
m≠
[
x
].
size
 = size;

125 
e820x
->
m≠
[
x
].
ty≥
 =Åype;

126 
e820x
->
ƒ_m≠
++;

127 
	}
}

129 
__öô
 
	$e820_add_ªgi⁄
(
u64
 
°¨t
, u64 
size
, 
ty≥
)

131 
	`__e820_add_ªgi⁄
(&
e820
, 
°¨t
, 
size
, 
ty≥
);

132 
	}
}

134 
__öô
 
	$e820_¥öt_ty≥
(
u32
 
ty≥
)

136 
ty≥
) {

137 
E820_RAM
:

138 
E820_RESERVED_KERN
:

139 
	`¥ötk
(
KERN_CONT
 "(usable)");

141 
E820_RESERVED
:

142 
	`¥ötk
(
KERN_CONT
 "(reserved)");

144 
E820_ACPI
:

145 
	`¥ötk
(
KERN_CONT
 "(ACPI data)");

147 
E820_NVS
:

148 
	`¥ötk
(
KERN_CONT
 "(ACPI NVS)");

150 
E820_UNUSABLE
:

151 
	`¥ötk
(
KERN_CONT
 "(unusable)");

154 
	`¥ötk
(
KERN_CONT
 "ty≥ %u", 
ty≥
);

157 
	}
}

159 
__öô
 
	$e820_¥öt_m≠
(*
who
)

161 
i
;

163 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

164 
	`¥ötk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

165 (Ë
e820
.
m≠
[
i
].
addr
,

167 (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
));

168 
	`e820_¥öt_ty≥
(
e820
.
m≠
[
i
].
ty≥
);

169 
	`¥ötk
(
KERN_CONT
 "\n");

171 
	}
}

235 
__öô
 
	$ßnôize_e820_m≠
(
e820íåy
 *
biosm≠
, 
max_ƒ_m≠
,

236 
u32
 *
≤r_m≠
)

238 
	sch™ge_membî
 {

239 
e820íåy
 *
pbios
;

240 
addr
;

242 
ch™ge_membî
 
ch™ge_poöt_li°
[2*
E820_X_MAX
] 
__öôd©a
;

243 
ch™ge_membî
 *
ch™ge_poöt
[2*
E820_X_MAX
] 
__öôd©a
;

244 
e820íåy
 *
ovîœp_li°
[
E820_X_MAX
] 
__öôd©a
;

245 
e820íåy
 
√w_bios
[
E820_X_MAX
] 
__öôd©a
;

246 
ch™ge_membî
 *
ch™ge_tmp
;

247 
cuºít_ty≥
, 
œ°_ty≥
;

248 
œ°_addr
;

249 
chgidx
, 
°ûl_ch™gög
;

250 
ovîœp_íåõs
;

251 
√w_bios_íåy
;

252 
ﬁd_ƒ
, 
√w_ƒ
, 
chg_ƒ
;

253 
i
;

256 i‡(*
≤r_m≠
 < 2)

259 
ﬁd_ƒ
 = *
≤r_m≠
;

260 
	`BUG_ON
(
ﬁd_ƒ
 > 
max_ƒ_m≠
);

263 
i
 = 0; i < 
ﬁd_ƒ
; i++)

264 i‡(
biosm≠
[
i
].
addr
 + biosm≠[i].
size
 < biosmap[i].addr)

268 
i
 = 0; i < 2 * 
ﬁd_ƒ
; i++)

269 
ch™ge_poöt
[
i
] = &
ch™ge_poöt_li°
[i];

273 
chgidx
 = 0;

274 
i
 = 0; i < 
ﬁd_ƒ
; i++) {

275 i‡(
biosm≠
[
i
].
size
 != 0) {

276 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr;

277 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

278 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr +

279 
biosm≠
[
i
].
size
;

280 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

283 
chg_ƒ
 = 
chgidx
;

286 
°ûl_ch™gög
 = 1;

287 
°ûl_ch™gög
) {

288 
°ûl_ch™gög
 = 0;

289 
i
 = 1; i < 
chg_ƒ
; i++) {

290 
cuøddr
, 
œ°addr
;

291 
cuΩbaddr
, 
œ°pbaddr
;

293 
cuøddr
 = 
ch™ge_poöt
[
i
]->
addr
;

294 
œ°addr
 = 
ch™ge_poöt
[
i
 - 1]->
addr
;

295 
cuΩbaddr
 = 
ch™ge_poöt
[
i
]->
pbios
->
addr
;

296 
œ°pbaddr
 = 
ch™ge_poöt
[
i
 - 1]->
pbios
->
addr
;

305 i‡(
cuøddr
 < 
œ°addr
 ||

306 (
cuøddr
 =
œ°addr
 && cuødd∏=
cuΩbaddr
 &&

307 
œ°addr
 !
œ°pbaddr
)) {

308 
ch™ge_tmp
 = 
ch™ge_poöt
[
i
];

309 
ch™ge_poöt
[
i
] = change_point[i-1];

310 
ch™ge_poöt
[
i
-1] = 
ch™ge_tmp
;

311 
°ûl_ch™gög
 = 1;

317 
ovîœp_íåõs
 = 0;

318 
√w_bios_íåy
 = 0;

319 
œ°_ty≥
 = 0;

320 
œ°_addr
 = 0;

323 
chgidx
 = 0; chgidx < 
chg_ƒ
; chgidx++) {

325 i‡(
ch™ge_poöt
[
chgidx
]->
addr
 ==

326 
ch™ge_poöt
[
chgidx
]->
pbios
->
addr
) {

331 
ovîœp_li°
[
ovîœp_íåõs
++] =

332 
ch™ge_poöt
[
chgidx
]->
pbios
;

338 
i
 = 0; i < 
ovîœp_íåõs
; i++) {

339 i‡(
ovîœp_li°
[
i
] ==

340 
ch™ge_poöt
[
chgidx
]->
pbios
)

341 
ovîœp_li°
[
i
] =

342 
ovîœp_li°
[
ovîœp_íåõs
-1];

344 
ovîœp_íåõs
--;

351 
cuºít_ty≥
 = 0;

352 
i
 = 0; i < 
ovîœp_íåõs
; i++)

353 i‡(
ovîœp_li°
[
i
]->
ty≥
 > 
cuºít_ty≥
)

354 
cuºít_ty≥
 = 
ovîœp_li°
[
i
]->
ty≥
;

359 i‡(
cuºít_ty≥
 !
œ°_ty≥
) {

360 i‡(
œ°_ty≥
 != 0) {

361 
√w_bios
[
√w_bios_íåy
].
size
 =

362 
ch™ge_poöt
[
chgidx
]->
addr
 - 
œ°_addr
;

367 i‡(
√w_bios
[
√w_bios_íåy
].
size
 != 0)

372 i‡(++
√w_bios_íåy
 >
max_ƒ_m≠
)

375 i‡(
cuºít_ty≥
 != 0) {

376 
√w_bios
[
√w_bios_íåy
].
addr
 =

377 
ch™ge_poöt
[
chgidx
]->
addr
;

378 
√w_bios
[
√w_bios_íåy
].
ty≥
 = 
cuºít_ty≥
;

379 
œ°_addr
 = 
ch™ge_poöt
[
chgidx
]->
addr
;

381 
œ°_ty≥
 = 
cuºít_ty≥
;

385 
√w_ƒ
 = 
√w_bios_íåy
;

388 
	`mem˝y
(
biosm≠
, 
√w_bios
, 
√w_ƒ
 * (
e820íåy
));

389 *
≤r_m≠
 = 
√w_ƒ
;

392 
	}
}

394 
__öô
 
	$__≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

396 
ƒ_m≠
) {

397 
u64
 
°¨t
 = 
biosm≠
->
addr
;

398 
u64
 
size
 = 
biosm≠
->size;

399 
u64
 
íd
 = 
°¨t
 + 
size
;

400 
u32
 
ty≥
 = 
biosm≠
->type;

403 i‡(
°¨t
 > 
íd
)

406 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
ty≥
);

408 
biosm≠
++;

409 
ƒ_m≠
--;

412 
	}
}

423 
__öô
 
	$≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

426 i‡(
ƒ_m≠
 < 2)

429  
	`__≠≥nd_e820_m≠
(
biosm≠
, 
ƒ_m≠
);

430 
	}
}

432 
u64
 
__öô
 
	$__e820_upd©e_ønge
(
e820m≠
 *
e820x
, 
u64
 
°¨t
,

433 
u64
 
size
, 
ﬁd_ty≥
,

434 
√w_ty≥
)

436 
u64
 
íd
;

437 
i
;

438 
u64
 
ªÆ_upd©ed_size
 = 0;

440 
	`BUG_ON
(
ﬁd_ty≥
 =
√w_ty≥
);

442 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

443 
size
 = 
ULLONG_MAX
 - 
°¨t
;

445 
íd
 = 
°¨t
 + 
size
;

446 
	`¥ötk
(
KERN_DEBUG
 "e820 updateÑange: %016Lx - %016Lx ",

447 (Ë
°¨t
,

448 (Ë
íd
);

449 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

450 
	`¥ötk
(
KERN_CONT
 " ==> ");

451 
	`e820_¥öt_ty≥
(
√w_ty≥
);

452 
	`¥ötk
(
KERN_CONT
 "\n");

454 
i
 = 0; i < 
e820x
->
ƒ_m≠
; i++) {

455 
e820íåy
 *
ei
 = &
e820x
->
m≠
[
i
];

456 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

457 
u64
 
ei_íd
;

459 i‡(
ei
->
ty≥
 !
ﬁd_ty≥
)

462 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

464 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

465 
ei
->
ty≥
 = 
√w_ty≥
;

466 
ªÆ_upd©ed_size
 +
ei
->
size
;

471 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

472 
	`__e820_add_ªgi⁄
(
e820x
, 
°¨t
, 
size
, 
√w_ty≥
);

473 
	`__e820_add_ªgi⁄
(
e820x
, 
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

474 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

475 
ªÆ_upd©ed_size
 +
size
;

480 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

481 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

482 i‡(
föÆ_°¨t
 >
föÆ_íd
)

485 
	`__e820_add_ªgi⁄
(
e820x
, 
föÆ_°¨t
, 
föÆ_íd
 - final_start,

486 
√w_ty≥
);

488 
ªÆ_upd©ed_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

494 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

495 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

497 
ei
->
addr
 = 
föÆ_íd
;

499  
ªÆ_upd©ed_size
;

500 
	}
}

502 
u64
 
__öô
 
	$e820_upd©e_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

503 
√w_ty≥
)

505  
	`__e820_upd©e_ønge
(&
e820
, 
°¨t
, 
size
, 
ﬁd_ty≥
, 
√w_ty≥
);

506 
	}
}

508 
u64
 
__öô
 
	$e820_upd©e_ønge_ßved
(
u64
 
°¨t
, u64 
size
,

509 
ﬁd_ty≥
, 
√w_ty≥
)

511  
	`__e820_upd©e_ønge
(&
e820_ßved
, 
°¨t
, 
size
, 
ﬁd_ty≥
,

512 
√w_ty≥
);

513 
	}
}

516 
u64
 
__öô
 
	$e820_ªmove_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

517 
checkty≥
)

519 
i
;

520 
u64
 
ªÆ_ªmoved_size
 = 0;

522 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

523 
size
 = 
ULLONG_MAX
 - 
°¨t
;

525 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

526 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

527 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

529 i‡(
checkty≥
 && 
ei
->
ty≥
 !
ﬁd_ty≥
)

532 i‡(
ei
->
addr
 >
°¨t
 &&

533 (
ei
->
addr
 +Éi->
size
Ë<(
°¨t
 + size)) {

534 
ªÆ_ªmoved_size
 +
ei
->
size
;

535 
	`mem£t
(
ei
, 0, (
e820íåy
));

539 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

540 
föÆ_íd
 = 
	`mö
(
°¨t
 + 
size
, 
ei
->
addr
 +Éi->size);

541 i‡(
föÆ_°¨t
 >
föÆ_íd
)

543 
ªÆ_ªmoved_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

545 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

546 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

548 
ei
->
addr
 = 
föÆ_íd
;

550  
ªÆ_ªmoved_size
;

551 
	}
}

553 
__öô
 
	$upd©e_e820
()

555 
u32
 
ƒ_m≠
;

557 
ƒ_m≠
 = 
e820
.nr_map;

558 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ_m≠
))

560 
e820
.
ƒ_m≠
 =Çr_map;

561 
	`¥ötk
(
KERN_INFO
 "modifiedÖhysical RAM map:\n");

562 
	`e820_¥öt_m≠
("modified");

563 
	}
}

564 
__öô
 
	$upd©e_e820_ßved
()

566 
u32
 
ƒ_m≠
;

568 
ƒ_m≠
 = 
e820_ßved
.nr_map;

569 i‡(
	`ßnôize_e820_m≠
(
e820_ßved
.
m≠
, 
	`ARRAY_SIZE
”820_ßved.m≠), &
ƒ_m≠
))

571 
e820_ßved
.
ƒ_m≠
 =Çr_map;

572 
	}
}

573 
	#MAX_GAP_END
 0x100000000uŒ

	)

577 
__öô
 
	$e820_£¨ch_g≠
(*
g≠°¨t
, *
g≠size
,

578 
°¨t_addr
, 
íd_addr
)

580 
œ°
;

581 
i
 = 
e820
.
ƒ_m≠
;

582 
found
 = 0;

584 
œ°
 = (
íd_addr
 &&Énd_add∏< 
MAX_GAP_END
) ?Énd_addr : MAX_GAP_END;

586 --
i
 >= 0) {

587 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

588 
íd
 = 
°¨t
 + 
e820
.
m≠
[
i
].
size
;

590 i‡(
íd
 < 
°¨t_addr
)

597 i‡(
œ°
 > 
íd
) {

598 
g≠
 = 
œ°
 - 
íd
;

600 i‡(
g≠
 >*
g≠size
) {

601 *
g≠size
 = 
g≠
;

602 *
g≠°¨t
 = 
íd
;

603 
found
 = 1;

606 i‡(
°¨t
 < 
œ°
)

607 
œ°
 = 
°¨t
;

609  
found
;

610 
	}
}

618 
__öô
 
	$e820_£tup_g≠
()

620 
g≠°¨t
, 
g≠size
;

621 
found
;

623 
g≠°¨t
 = 0x10000000;

624 
g≠size
 = 0x400000;

625 
found
 = 
	`e820_£¨ch_g≠
(&
g≠°¨t
, &
g≠size
, 0, 
MAX_GAP_END
);

627 #ifde‡
CONFIG_X86_64


628 i‡(!
found
) {

629 
g≠°¨t
 = (
max_p‚
 << 
PAGE_SHIFT
) + 1024*1024;

630 
	`¥ötk
(
KERN_ERR


639 
pci_mem_°¨t
 = 
g≠°¨t
;

641 
	`¥ötk
(
KERN_INFO


643 
pci_mem_°¨t
, 
g≠°¨t
, 
g≠size
);

644 
	}
}

652 
__öô
 
	$∑r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
∑_d©a
)

654 
u32
 
m≠_Àn
;

655 
íåõs
;

656 
e820íåy
 *
extm≠
;

658 
íåõs
 = 
sd©a
->
Àn
 / (
e820íåy
);

659 
m≠_Àn
 = 
sd©a
->
Àn
 + (
£tup_d©a
);

660 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

661 
sd©a
 = 
	`óæy_i‹em≠
(
∑_d©a
, 
m≠_Àn
);

662 
extm≠
 = (
e820íåy
 *)(
sd©a
->
d©a
);

663 
	`__≠≥nd_e820_m≠
(
extm≠
, 
íåõs
);

664 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

665 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

666 
	`óæy_iounm≠
(
sd©a
, 
m≠_Àn
);

667 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

668 
	`e820_¥öt_m≠
("extended");

669 
	}
}

671 #i‡
deföed
(
CONFIG_X86_64
) || \

672 (
deföed
(
CONFIG_X86_32
Ë&& 
	$deföed
(
CONFIG_HIBERNATION
))

681 
__öô
 
	$e820_m¨k_noßve_ªgi⁄s
(
limô_p‚
)

683 
i
;

684 
p‚
;

686 
p‚
 = 
	`PFN_DOWN
(
e820
.
m≠
[0].
addr
 +É820.m≠[0].
size
);

687 
i
 = 1; i < 
e820
.
ƒ_m≠
; i++) {

688 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

690 i‡(
p‚
 < 
	`PFN_UP
(
ei
->
addr
))

691 
	`ªgi°î_noßve_ªgi⁄
(
p‚
, 
	`PFN_UP
(
ei
->
addr
));

693 
p‚
 = 
	`PFN_DOWN
(
ei
->
addr
 +Éi->
size
);

694 i‡(
ei
->
ty≥
 !
E820_RAM
 &&Éi->ty≥ !
E820_RESERVED_KERN
)

695 
	`ªgi°î_noßve_ªgi⁄
(
	`PFN_UP
(
ei
->
addr
), 
p‚
);

697 i‡(
p‚
 >
limô_p‚
)

700 
	}
}

703 #ifde‡
CONFIG_HIBERNATION


708 
__öô
 
	$e820_m¨k_nvs_mem‹y
()

710 
i
;

712 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

713 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

715 i‡(
ei
->
ty≥
 =
E820_NVS
)

716 
	`hibî«ã_nvs_ªgi°î
(
ei
->
addr
,Éi->
size
);

720 
	}
}

721 
c‹e_öôˇŒ
(
e820_m¨k_nvs_mem‹y
);

727 
	#MAX_EARLY_RES
 20

	)

729 
	sóæy_ªs
 {

730 
u64
 
	m°¨t
, 
	míd
;

731 
	m«me
[16];

732 
	movîœp_ok
;

734 
óæy_ªs
 
	góæy_ªs
[
MAX_EARLY_RES
] 
	g__öôd©a
 = {

735 { 0, 
PAGE_SIZE
, "BIOS dataÖage" },

739 
__öô
 
	$föd_ovîœµed_óæy
(
u64
 
°¨t
, u64 
íd
)

741 
i
;

742 
óæy_ªs
 *
r
;

744 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

745 
r
 = &
óæy_ªs
[
i
];

746 i‡(
íd
 > 
r
->
°¨t
 && start <Ñ->end)

750  
i
;

751 
	}
}

758 
__öô
 
	$dr›_ønge
(
i
)

760 
j
;

762 
j
 = 
i
 + 1; j < 
MAX_EARLY_RES
 && 
óæy_ªs
[j].
íd
; j++)

765 
	`memmove
(&
óæy_ªs
[
i
], &early_res[i + 1],

766 (
j
 - 1 - 
i
Ë* (
óæy_ªs
));

768 
óæy_ªs
[
j
 - 1].
íd
 = 0;

769 
	}
}

781 
__öô
 
	$dr›_ovîœps_th©_¨e_ok
(
u64
 
°¨t
, u64 
íd
)

783 
i
;

784 
óæy_ªs
 *
r
;

785 
u64
 
lowî_°¨t
, 
lowî_íd
;

786 
u64
 
uµî_°¨t
, 
uµî_íd
;

787 
«me
[16];

789 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

790 
r
 = &
óæy_ªs
[
i
];

793 i‡(
íd
 <
r
->
°¨t
 || start >=Ñ->end)

801 i‡(!
r
->
ovîœp_ok
)

812 
	`°∫˝y
(
«me
, 
r
->name, (name) - 1);

814 
lowî_°¨t
 = 
lowî_íd
 = 0;

815 
uµî_°¨t
 = 
uµî_íd
 = 0;

816 i‡(
r
->
°¨t
 < start) {

817 
lowî_°¨t
 = 
r
->
°¨t
;

818 
lowî_íd
 = 
°¨t
;

820 i‡(
r
->
íd
 >Énd) {

821 
uµî_°¨t
 = 
íd
;

822 
uµî_íd
 = 
r
->
íd
;

826 
	`dr›_ønge
(
i
);

828 
i
--;

831 i‡(
lowî_íd
)

832 
	`ª£rve_óæy_ovîœp_ok
(
lowî_°¨t
, 
lowî_íd
, 
«me
);

833 i‡(
uµî_íd
)

834 
	`ª£rve_óæy_ovîœp_ok
(
uµî_°¨t
, 
uµî_íd
, 
«me
);

836 
	}
}

838 
__öô
 
	$__ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
,

839 
ovîœp_ok
)

841 
i
;

842 
óæy_ªs
 *
r
;

844 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

845 i‡(
i
 >
MAX_EARLY_RES
)

846 
	`∑nic
("Too manyÉarlyÑeservations");

847 
r
 = &
óæy_ªs
[
i
];

848 i‡(
r
->
íd
)

849 
	`∑nic
("OverlappingÉarlyÑeservations "

851 
°¨t
, 
íd
 - 1, 
«me
?«me:"", 
r
->start,

852 
r
->
íd
 - 1,Ñ->
«me
);

853 
r
->
°¨t
 = start;

854 
r
->
íd
 =Énd;

855 
r
->
ovîœp_ok
 = overlap_ok;

856 i‡(
«me
)

857 
	`°∫˝y
(
r
->
«me
,Çame, (r->name) - 1);

858 
	}
}

880 
__öô
 
	$ª£rve_óæy_ovîœp_ok
(
u64
 
°¨t
, u64 
íd
, *
«me
)

882 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

883 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 1);

884 
	}
}

894 
__öô
 
	$ª£rve_óæy
(
u64
 
°¨t
, u64 
íd
, *
«me
)

896 i‡(
°¨t
 >
íd
)

899 
	`dr›_ovîœps_th©_¨e_ok
(
°¨t
, 
íd
);

900 
	`__ª£rve_óæy
(
°¨t
, 
íd
, 
«me
, 0);

901 
	}
}

903 
__öô
 
	$‰ì_óæy
(
u64
 
°¨t
, u64 
íd
)

905 
óæy_ªs
 *
r
;

906 
i
;

908 
i
 = 
	`föd_ovîœµed_óæy
(
°¨t
, 
íd
);

909 
r
 = &
óæy_ªs
[
i
];

910 i‡(
i
 >
MAX_EARLY_RES
 || 
r
->
íd
 !íd ||Ñ->
°¨t
 != start)

911 
	`∑nic
("free_early onÇotÑeservedárea: %llx-%llx!",

912 
°¨t
, 
íd
 - 1);

914 
	`dr›_ønge
(
i
);

915 
	}
}

917 
__öô
 
	$óæy_ªs_to_boŸmem
(
u64
 
°¨t
, u64 
íd
)

919 
i
, 
cou¡
;

920 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

922 
cou¡
 = 0;

923 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++)

924 
cou¡
++;

926 
	`¥ötk
(
KERN_INFO
 "(%dÉarlyÑeservations) ==> bootmem [%010llx - %010llx]\n",

927 
cou¡
, 
°¨t
, 
íd
);

928 
i
 = 0; i < 
cou¡
; i++) {

929 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

930 
	`¥ötk
(
KERN_INFO
 " #%d [%010Œx - %010Œx] %16s", 
i
,

931 
r
->
°¨t
,Ñ->
íd
,Ñ->
«me
);

932 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
r
->start);

933 
föÆ_íd
 = 
	`mö
(
íd
, 
r
->end);

934 i‡(
föÆ_°¨t
 >
föÆ_íd
) {

935 
	`¥ötk
(
KERN_CONT
 "\n");

938 
	`¥ötk
(
KERN_CONT
 " ==> [%010llx - %010llx]\n",

939 
föÆ_°¨t
, 
föÆ_íd
);

940 
	`ª£rve_boŸmem_gíîic
(
föÆ_°¨t
, 
föÆ_íd
 - final_start,

941 
BOOTMEM_DEFAULT
);

943 
	}
}

946 
ölöe
 
__öô
 
	$bad_addr
(
u64
 *
addΩ
, u64 
size
, u64 
Æign
)

948 
i
;

949 
u64
 
addr
 = *
addΩ
;

950 
ch™ged
 = 0;

951 
óæy_ªs
 *
r
;

952 
agaö
:

953 
i
 = 
	`föd_ovîœµed_óæy
(
addr
,ádd∏+ 
size
);

954 
r
 = &
óæy_ªs
[
i
];

955 i‡(
i
 < 
MAX_EARLY_RES
 && 
r
->
íd
) {

956 *
addΩ
 = 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

957 
ch™ged
 = 1;

958 
agaö
;

960  
ch™ged
;

961 
	}
}

964 
ölöe
 
__öô
 
	$bad_addr_size
(
u64
 *
addΩ
, u64 *
sizï
, u64 
Æign
)

966 
i
;

967 
u64
 
addr
 = *
addΩ
, 
œ°
;

968 
u64
 
size
 = *
sizï
;

969 
ch™ged
 = 0;

970 
agaö
:

971 
œ°
 = 
addr
 + 
size
;

972 
i
 = 0; i < 
MAX_EARLY_RES
 && 
óæy_ªs
[i].
íd
; i++) {

973 
óæy_ªs
 *
r
 = &óæy_ªs[
i
];

974 i‡(
œ°
 > 
r
->
°¨t
 && 
addr
 <Ñ->start) {

975 
size
 = 
r
->
°¨t
 - 
addr
;

976 
ch™ged
 = 1;

977 
agaö
;

979 i‡(
œ°
 > 
r
->
íd
 && 
addr
 <Ñ->end) {

980 
addr
 = 
	`round_up
(
r
->
íd
, 
Æign
);

981 
size
 = 
œ°
 - 
addr
;

982 
ch™ged
 = 1;

983 
agaö
;

985 i‡(
œ°
 <
r
->
íd
 && 
addr
 >r->
°¨t
) {

986 (*
sizï
)++;

990 i‡(
ch™ged
) {

991 *
addΩ
 = 
addr
;

992 *
sizï
 = 
size
;

994  
ch™ged
;

995 
	}
}

1000 
u64
 
__öô
 
	$föd_e820_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

1002 
i
;

1004 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1005 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1006 
u64
 
addr
, 
œ°
;

1007 
u64
 
ei_œ°
;

1009 i‡(
ei
->
ty≥
 !
E820_RAM
)

1011 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1012 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1013 i‡(
addr
 < 
°¨t
)

1014 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1015 i‡(
addr
 >
ei_œ°
)

1017 
	`bad_addr
(&
addr
, 
size
, 
Æign
Ë&&áddr+sizê<
ei_œ°
)

1019 
œ°
 = 
addr
 + 
size
;

1020 i‡(
œ°
 > 
ei_œ°
)

1022 i‡(
œ°
 > 
íd
)

1024  
addr
;

1027 
	}
}

1032 
u64
 
__öô
 
	$föd_e820_¨ó_size
(
u64
 
°¨t
, u64 *
sizï
, u64 
Æign
)

1034 
i
;

1036 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1037 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1038 
u64
 
addr
, 
œ°
;

1039 
u64
 
ei_œ°
;

1041 i‡(
ei
->
ty≥
 !
E820_RAM
)

1043 
addr
 = 
	`round_up
(
ei
->addr, 
Æign
);

1044 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

1045 i‡(
addr
 < 
°¨t
)

1046 
addr
 = 
	`round_up
(
°¨t
, 
Æign
);

1047 i‡(
addr
 >
ei_œ°
)

1049 *
sizï
 = 
ei_œ°
 - 
addr
;

1050 
	`bad_addr_size
(&
addr
, 
sizï
, 
Æign
) &&

1051 
addr
 + *
sizï
 <
ei_œ°
)

1053 
œ°
 = 
addr
 + *
sizï
;

1054 i‡(
œ°
 > 
ei_œ°
)

1056  
addr
;

1060 
	}
}

1065 
u64
 
__öô
 
	$óæy_ª£rve_e820
(
u64
 
°¨â
, u64 
sizë
, u64 
Æign
)

1067 
u64
 
size
 = 0;

1068 
u64
 
addr
;

1069 
u64
 
°¨t
;

1071 
°¨t
 = 
°¨â
; ; sèπ +
size
) {

1072 
°¨t
 = 
	`föd_e820_¨ó_size
(°¨t, &
size
, 
Æign
);

1073 i‡(!(
°¨t
 + 1))

1075 i‡(
size
 >
sizë
)

1079 #ifde‡
CONFIG_X86_32


1080 i‡(
°¨t
 >
MAXMEM
)

1082 i‡(
°¨t
 + 
size
 > 
MAXMEM
)

1083 
size
 = 
MAXMEM
 - 
°¨t
;

1086 
addr
 = 
	`round_down
(
°¨t
 + 
size
 - 
sizë
, 
Æign
);

1087 i‡(
addr
 < 
°¨t
)

1089 
	`e820_upd©e_ønge
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1090 
	`e820_upd©e_ønge_ßved
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

1091 
	`¥ötk
(
KERN_INFO
 "updateÉ820 forÉarly_reserve_e820\n");

1092 
	`upd©e_e820
();

1093 
	`upd©e_e820_ßved
();

1095  
addr
;

1096 
	}
}

1098 #ifde‡
CONFIG_X86_32


1099 #ifde‡
CONFIG_X86_PAE


1100 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

1102 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

1105 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

1111 
__öô
 
	$e820_íd_p‚
(
limô_p‚
, 
ty≥
)

1113 
i
;

1114 
œ°_p‚
 = 0;

1115 
max_¨ch_p‚
 = 
MAX_ARCH_PFN
;

1117 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1118 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

1119 
°¨t_p‚
;

1120 
íd_p‚
;

1122 i‡(
ei
->
ty≥
 !=Åype)

1125 
°¨t_p‚
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

1126 
íd_p‚
 = (
ei
->
addr
 +Éi->
size
Ë>> 
PAGE_SHIFT
;

1128 i‡(
°¨t_p‚
 >
limô_p‚
)

1130 i‡(
íd_p‚
 > 
limô_p‚
) {

1131 
œ°_p‚
 = 
limô_p‚
;

1134 i‡(
íd_p‚
 > 
œ°_p‚
)

1135 
œ°_p‚
 = 
íd_p‚
;

1138 i‡(
œ°_p‚
 > 
max_¨ch_p‚
)

1139 
œ°_p‚
 = 
max_¨ch_p‚
;

1141 
	`¥ötk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

1142 
œ°_p‚
, 
max_¨ch_p‚
);

1143  
œ°_p‚
;

1144 
	}
}

1145 
__öô
 
	$e820_íd_of_øm_p‚
()

1147  
	`e820_íd_p‚
(
MAX_ARCH_PFN
, 
E820_RAM
);

1148 
	}
}

1150 
__öô
 
	$e820_íd_of_low_øm_p‚
()

1152  
	`e820_íd_p‚
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

1153 
	}
}

1158 
__öô
 
	$e820_föd_a˘ive_ªgi⁄
(c⁄° 
e820íåy
 *
ei
,

1159 
°¨t_p‚
,

1160 
œ°_p‚
,

1161 *
ei_°¨ç‚
,

1162 *
ei_ídp‚
)

1164 
u64
 
Æign
 = 
PAGE_SIZE
;

1166 *
ei_°¨ç‚
 = 
	`round_up
(
ei
->
addr
, 
Æign
Ë>> 
PAGE_SHIFT
;

1167 *
ei_ídp‚
 = 
	`round_down
(
ei
->
addr
 +Éi->
size
, 
Æign
Ë>> 
PAGE_SHIFT
;

1170 i‡(*
ei_°¨ç‚
 >*
ei_ídp‚
)

1174 i‡(
ei
->
ty≥
 !
E820_RAM
 || *
ei_ídp‚
 <
°¨t_p‚
 ||

1175 *
ei_°¨ç‚
 >
œ°_p‚
)

1179 i‡(*
ei_°¨ç‚
 < 
°¨t_p‚
)

1180 *
ei_°¨ç‚
 = 
°¨t_p‚
;

1181 i‡(*
ei_ídp‚
 > 
œ°_p‚
)

1182 *
ei_ídp‚
 = 
œ°_p‚
;

1185 
	}
}

1188 
__öô
 
	$e820_ªgi°î_a˘ive_ªgi⁄s
(
nid
, 
°¨t_p‚
,

1189 
œ°_p‚
)

1191 
ei_°¨ç‚
;

1192 
ei_ídp‚
;

1193 
i
;

1195 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++)

1196 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1197 
°¨t_p‚
, 
œ°_p‚
,

1198 &
ei_°¨ç‚
, &
ei_ídp‚
))

1199 
	`add_a˘ive_ønge
(
nid
, 
ei_°¨ç‚
, 
ei_ídp‚
);

1200 
	}
}

1207 
u64
 
__öô
 
	$e820_hﬁe_size
(
u64
 
°¨t
, u64 
íd
)

1209 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

1210 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

1211 
ei_°¨ç‚
, 
ei_ídp‚
, 
øm
 = 0;

1212 
i
;

1214 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1215 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

1216 
°¨t_p‚
, 
œ°_p‚
,

1217 &
ei_°¨ç‚
, &
ei_ídp‚
))

1218 
øm
 +
ei_ídp‚
 - 
ei_°¨ç‚
;

1220  
íd
 - 
°¨t
 - ((
u64
)
øm
 << 
PAGE_SHIFT
);

1221 
	}
}

1223 
	$óæy_∑nic
(*
msg
)

1225 
	`óæy_¥ötk
(
msg
);

1226 
	`∑nic
(
msg
);

1227 
	}
}

1229 
u£rdef
 
	g__öôd©a
;

1232 
__öô
 
	$∑r£_mem›t
(*
p
)

1234 
u64
 
mem_size
;

1236 i‡(!
p
)

1237  -
EINVAL
;

1239 #ifde‡
CONFIG_X86_32


1240 i‡(!
	`°rcmp
(
p
, "nopentium")) {

1241 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_PSE
);

1246 
u£rdef
 = 1;

1247 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1248 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1251 
	}
}

1252 
óæy_∑øm
("mem", 
∑r£_mem›t
);

1254 
__öô
 
	$∑r£_memm≠_›t
(*
p
)

1256 *
ﬁdp
;

1257 
u64
 
°¨t_©
, 
mem_size
;

1259 i‡(!
p
)

1260  -
EINVAL
;

1262 i‡(!
	`°∫cmp
(
p
, "exactmap", 8)) {

1263 #ifde‡
CONFIG_CRASH_DUMP


1269 
ßved_max_p‚
 = 
	`e820_íd_of_øm_p‚
();

1271 
e820
.
ƒ_m≠
 = 0;

1272 
u£rdef
 = 1;

1276 
ﬁdp
 = 
p
;

1277 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1278 i‡(
p
 =
ﬁdp
)

1279  -
EINVAL
;

1281 
u£rdef
 = 1;

1282 i‡(*
p
 == '@') {

1283 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1284 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RAM
);

1285 } i‡(*
p
 == '#') {

1286 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1287 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_ACPI
);

1288 } i‡(*
p
 == '$') {

1289 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1290 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RESERVED
);

1292 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1294  *
p
 ='\0' ? 0 : -
EINVAL
;

1295 
	}
}

1296 
óæy_∑øm
("memm≠", 
∑r£_memm≠_›t
);

1298 
__öô
 
	$föish_e820_∑rsög
()

1300 i‡(
u£rdef
) {

1301 
u32
 
ƒ
 = 
e820
.
ƒ_m≠
;

1303 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ
) < 0)

1304 
	`óæy_∑nic
("Invalid user supplied memory map");

1305 
e820
.
ƒ_m≠
 = 
ƒ
;

1307 
	`¥ötk
(
KERN_INFO
 "user-definedÖhysical RAM map:\n");

1308 
	`e820_¥öt_m≠
("user");

1310 
	}
}

1312 
ölöe
 c⁄° *
	$e820_ty≥_to_°rög
(
e820_ty≥
)

1314 
e820_ty≥
) {

1315 
E820_RESERVED_KERN
:

1316 
E820_RAM
:  "System RAM";

1317 
E820_ACPI
:  "ACPI Tables";

1318 
E820_NVS
:  "ACPI Non-volatile Storage";

1319 
E820_UNUSABLE
:  "Unusable memory";

1322 
	}
}

1327 
ªsour˚
 
__öôd©a
 *
	ge820_ªs
;

1328 
__öô
 
	$e820_ª£rve_ªsour˚s
()

1330 
i
;

1331 
ªsour˚
 *
ªs
;

1332 
u64
 
íd
;

1334 
ªs
 = 
	`Æloc_boŸmem
((
ªsour˚
Ë* 
e820
.
ƒ_m≠
);

1335 
e820_ªs
 = 
ªs
;

1336 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1337 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
 - 1;

1338 i‡(
íd
 !(
ªsour˚_size_t
)end) {

1339 
ªs
++;

1342 
ªs
->
«me
 = 
	`e820_ty≥_to_°rög
(
e820
.
m≠
[
i
].
ty≥
);

1343 
ªs
->
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

1344 
ªs
->
íd
 =Énd;

1346 
ªs
->
Êags
 = 
IORESOURCE_MEM
;

1353 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RESERVED
 || 
ªs
->
°¨t
 < (1ULL<<20)) {

1354 
ªs
->
Êags
 |
IORESOURCE_BUSY
;

1355 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

1357 
ªs
++;

1360 
i
 = 0; i < 
e820_ßved
.
ƒ_m≠
; i++) {

1361 
e820íåy
 *
íåy
 = &
e820_ßved
.
m≠
[
i
];

1362 
	`fúmw¨e_m≠_add_óæy
(
íåy
->
addr
,

1363 
íåy
->
addr
 +É¡ry->
size
 - 1,

1364 
	`e820_ty≥_to_°rög
(
íåy
->
ty≥
));

1366 
	}
}

1369 
	$øm_Æignmít
(
ªsour˚_size_t
 
pos
)

1371 
mb
 = 
pos
 >> 20;

1374 i‡(!
mb
)

1378 i‡(
mb
 < 16)

1383 
	}
}

1385 
	#MAX_RESOURCE_SIZE
 ((
ªsour˚_size_t
)-1)

	)

1387 
__öô
 
	$e820_ª£rve_ªsour˚s_œã
()

1389 
i
;

1390 
ªsour˚
 *
ªs
;

1392 
ªs
 = 
e820_ªs
;

1393 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1394 i‡(!
ªs
->
∑ª¡
 &&Ñes->
íd
)

1395 
	`ö£π_ªsour˚_ex∑nd_to_fô
(&
iomem_ªsour˚
, 
ªs
);

1396 
ªs
++;

1403 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1404 
e820íåy
 *
íåy
 = &
e820
.
m≠
[
i
];

1405 
u64
 
°¨t
, 
íd
;

1407 i‡(
íåy
->
ty≥
 !
E820_RAM
)

1409 
°¨t
 = 
íåy
->
addr
 +É¡ry->
size
;

1410 
íd
 = 
	`round_up
(
°¨t
, 
	`øm_Æignmít
(start)) - 1;

1411 i‡(
íd
 > 
MAX_RESOURCE_SIZE
)

1412 
íd
 = 
MAX_RESOURCE_SIZE
;

1413 i‡(
°¨t
 >
íd
)

1415 
	`ª£rve_ªgi⁄_wôh_•lô
(&
iomem_ªsour˚
, 
°¨t
, 
íd
,

1418 
	}
}

1420 *
__öô
 
	$deÁu…_machöe_•ecific_mem‹y_£tup
()

1422 *
who
 = "BIOS-e820";

1423 
u32
 
√w_ƒ
;

1430 
√w_ƒ
 = 
boŸ_∑øms
.
e820_íåõs
;

1431 
	`ßnôize_e820_m≠
(
boŸ_∑øms
.
e820_m≠
,

1432 
	`ARRAY_SIZE
(
boŸ_∑øms
.
e820_m≠
),

1433 &
√w_ƒ
);

1434 
boŸ_∑øms
.
e820_íåõs
 = 
√w_ƒ
;

1435 i‡(
	`≠≥nd_e820_m≠
(
boŸ_∑øms
.
e820_m≠
, boŸ_∑øms.
e820_íåõs
)

1437 
u64
 
mem_size
;

1440 i‡(
boŸ_∑øms
.
Æt_mem_k


1441 < 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
) {

1442 
mem_size
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
;

1443 
who
 = "BIOS-88";

1445 
mem_size
 = 
boŸ_∑øms
.
Æt_mem_k
;

1446 
who
 = "BIOS-e801";

1449 
e820
.
ƒ_m≠
 = 0;

1450 
	`e820_add_ªgi⁄
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1451 
	`e820_add_ªgi⁄
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1455  
who
;

1456 
	}
}

1458 
__öô
 
	$£tup_mem‹y_m≠
()

1460 *
who
;

1462 
who
 = 
x86_öô
.
ªsour˚s
.
	`mem‹y_£tup
();

1463 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

1464 
	`¥ötk
(
KERN_INFO
 "BIOS-providedÖhysical RAM map:\n");

1465 
	`e820_¥öt_m≠
(
who
);

1466 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<löux/pci.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/pci_ids.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_≠ic.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¨t.h
>

22 
__öô
 
	$fix_hy≥πøn•‹t_c⁄fig
(
num
, 
¶Ÿ
, 
func
)

24 
u32
 
htcfg
;

31 
htcfg
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68);

32 i‡(
htcfg
 & (1 << 18)) {

33 
	`¥ötk
(
KERN_INFO
 "Detected use ofÉxtendedápic ids "

35 i‡((
htcfg
 & (1 << 17)) == 0) {

36 
	`¥ötk
(
KERN_INFO
 "Enabling hypertransportÉxtended "

38 
	`¥ötk
(
KERN_INFO
 "NoteÅhis isá bios bug, "

40 
htcfg
 |= (1 << 17);

41 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68, 
htcfg
);

46 
	}
}

48 
__öô
 
	$vü_bugs
(
num
, 
¶Ÿ
, 
func
)

50 #ifde‡
CONFIG_GART_IOMMU


51 i‡((
max_p‚
 > 
MAX_DMA32_PFN
 || 
f‹˚_iommu
) &&

52 !
g¨t_iommu_≠îtuª_Ælowed
) {

53 
	`¥ötk
(
KERN_INFO


56 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

59 
	}
}

61 #ifde‡
CONFIG_ACPI


62 #ifde‡
CONFIG_X86_IO_APIC


64 
__öô
 
	$nvidü_h≥t_check
(
a˝i_èbÀ_hódî
 *
hódî
)

67 
	}
}

71 
__öô
 
	$nvidü_bugs
(
num
, 
¶Ÿ
, 
func
)

73 #ifde‡
CONFIG_ACPI


74 #ifde‡
CONFIG_X86_IO_APIC


82 i‡(
a˝i_u£_timî_ovîride
)

85 i‡(
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
nvidü_h≥t_check
)) {

86 
a˝i_skù_timî_ovîride
 = 1;

87 
	`¥ötk
(
KERN_INFO
 "Nvidia board "

90 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

97 
	}
}

99 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

100 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

101 
u32
 
__öô
 
	$©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
)

103 
u32
 
d
;

104 
u8
 
b
;

106 
b
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac);

107 
b
 &= ~(1<<5);

108 
	`wrôe_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac, 
b
);

110 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

111 
d
 |= 1<<8;

112 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

114 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

115 
d
 &= 0xff;

116  
d
;

117 
	}
}

120 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

122 
u32
 
d
;

123 
u8
 
b
;

125 i‡(
a˝i_u£_timî_ovîride
)

128 
d
 = 
	`©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
);

129 i‡(
d
 < 0x82)

130 
a˝i_skù_timî_ovîride
 = 1;

133 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

134 i‡(!(
b
 & 0x2))

135 
a˝i_skù_timî_ovîride
 = 1;

138 i‡(
a˝i_skù_timî_ovîride
) {

139 
	`¥ötk
(
KERN_INFO
 "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

140 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

141 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

144 
	}
}

146 
u32
 
__öô
 
	$©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
)

148 
u32
 
ﬁd
, 
d
;

150 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

151 
ﬁd
 = 
d
;

152 
d
 &= ~(1<<8);

153 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

154 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

155 
d
 &= 0xff;

156 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
ﬁd
);

158  
d
;

159 
	}
}

161 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

163 
u32
 
d
, 
ªv
;

165 i‡(
a˝i_u£_timî_ovîride
)

168 
ªv
 = 
	`©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
);

169 i‡(
ªv
 > 0x13)

173 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x64);

174 i‡(!(
d
 & (1<<14)))

175 
a˝i_skù_timî_ovîride
 = 1;

177 i‡(
a˝i_skù_timî_ovîride
) {

178 
	`¥ötk
(
KERN_INFO
 "SB600Ñevisi⁄ 0x%x\n", 
ªv
);

179 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

180 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

183 
	}
}

185 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

187 
	}
}

189 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

191 
	}
}

194 
	#QFLAG_APPLY_ONCE
 0x1

	)

195 
	#QFLAG_APPLIED
 0x2

	)

196 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

197 
	schù£t
 {

198 
u32
 
	mvíd‹
;

199 
u32
 
	mdevi˚
;

200 
u32
 
	m˛ass
;

201 
u32
 
	m˛ass_mask
;

202 
u32
 
	mÊags
;

203 (*
	mf
)(
	mnum
, 
	m¶Ÿ
, 
	mfunc
);

212 
chù£t
 
	góæy_qrk
[] 
	g__öôd©a
 = {

213 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

214 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidü_bugs
 },

215 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

216 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vü_bugs
 },

217 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

218 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy≥πøn•‹t_c⁄fig
 },

219 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

220 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

221 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

222 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_c⁄td
 },

237 
__öô
 
	$check_dev_quúk
(
num
, 
¶Ÿ
, 
func
)

239 
u16
 
˛ass
;

240 
u16
 
víd‹
;

241 
u16
 
devi˚
;

242 
u8
 
ty≥
;

243 
i
;

245 
˛ass
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_CLASS_DEVICE
);

247 i‡(
˛ass
 == 0xffff)

250 
víd‹
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_VENDOR_ID
);

252 
devi˚
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_DEVICE_ID
);

254 
i
 = 0; 
óæy_qrk
[i].
f
 !
NULL
; i++) {

255 i‡(((
óæy_qrk
[
i
].
víd‹
 =
PCI_ANY_ID
) ||

256 (
óæy_qrk
[
i
].
víd‹
 == vendor)) &&

257 ((
óæy_qrk
[
i
].
devi˚
 =
PCI_ANY_ID
) ||

258 (
óæy_qrk
[
i
].
devi˚
 == device)) &&

259 (!((
óæy_qrk
[
i
].
˛ass
 ^ class) &

260 
óæy_qrk
[
i
].
˛ass_mask
))) {

261 i‡((
óæy_qrk
[
i
].
Êags
 &

262 
QFLAG_DONE
) != QFLAG_DONE)

263 
óæy_qrk
[
i
].
	`f
(
num
, 
¶Ÿ
, 
func
);

264 
óæy_qrk
[
i
].
Êags
 |
QFLAG_APPLIED
;

268 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

269 
PCI_HEADER_TYPE
);

270 i‡(!(
ty≥
 & 0x80))

274 
	}
}

276 
__öô
 
	$óæy_quúks
()

278 
¶Ÿ
, 
func
;

280 i‡(!
	`óæy_pci_Ælowed
())

285 
¶Ÿ
 = 0; slot < 32; slot++)

286 
func
 = 0; func < 8; func++) {

288 i‡(
	`check_dev_quúk
(0, 
¶Ÿ
, 
func
))

291 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<löux/c⁄sﬁe.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/s¸ìn_öfo.h
>

6 
	~<löux/usb/ch9.h
>

7 
	~<löux/pci_ªgs.h
>

8 
	~<löux/pci_ids.h
>

9 
	~<löux/î∫o.h
>

10 
	~<asm/io.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/f˙é.h
>

13 
	~<asm/£tup.h
>

14 
	~<xí/hvc-c⁄sﬁe.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/fixm≠.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<löux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcuºít_ypos
 = 25, 
	gcuºít_xpos
;

26 
	$óæy_vga_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
°r
++Ë!'\0' && 
n
-- > 0) {

32 i‡(
cuºít_ypos
 >
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wrôew
(
	`ªadw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wrôew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cuºít_ypos
 = 
max_ypos
-1;

44 i‡(
c
 == '\n') {

45 
cuºít_xpos
 = 0;

46 
cuºít_ypos
++;

47 } i‡(
c
 != '\r') {

48 
	`wrôew
(((0x7 << 8Ë| (Ë
c
),

49 
VGABASE
 + 2*(
max_xpos
*
cuºít_ypos
 +

50 
cuºít_xpos
++));

51 i‡(
cuºít_xpos
 >
max_xpos
) {

52 
cuºít_xpos
 = 0;

53 
cuºít_ypos
++;

57 
	}
}

59 
c⁄sﬁe
 
	góæy_vga_c⁄sﬁe
 = {

60 .
«me
 = "earlyvga",

61 .
	gwrôe
 = 
óæy_vga_wrôe
,

62 .
	gÊags
 = 
CON_PRINTBUFFER
,

63 .
	gödex
 = -1,

68 
	góæy_£rül_ba£
 = 0x3f8;

70 
	#XMTRDY
 0x20

	)

72 
	#DLAB
 0x80

	)

74 
	#TXR
 0

	)

75 
	#RXR
 0

	)

76 
	#IER
 1

	)

77 
	#IIR
 2

	)

78 
	#FCR
 2

	)

79 
	#LCR
 3

	)

80 
	#MCR
 4

	)

81 
	#LSR
 5

	)

82 
	#MSR
 6

	)

83 
	#DLL
 0

	)

84 
	#DLH
 1

	)

86 
	$óæy_£rül_putc
(
ch
)

88 
timeout
 = 0xffff;

90 (
	`öb
(
óæy_£rül_ba£
 + 
LSR
Ë& 
XMTRDY
Ë=0 && --
timeout
)

91 
	`˝u_ªœx
();

92 
	`outb
(
ch
, 
óæy_£rül_ba£
 + 
TXR
);

93  
timeout
 ? 0 : -1;

94 
	}
}

96 
	$óæy_£rül_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
s
, 
n
)

98 *
s
 && 
n
-- > 0) {

99 i‡(*
s
 == '\n')

100 
	`óæy_£rül_putc
('\r');

101 
	`óæy_£rül_putc
(*
s
);

102 
s
++;

104 
	}
}

106 
	#DEFAULT_BAUD
 9600

	)

108 
__öô
 
	$óæy_£rül_öô
(*
s
)

110 
c
;

111 
divis‹
;

112 
baud
 = 
DEFAULT_BAUD
;

113 *
e
;

115 i‡(*
s
 == ',')

116 ++
s
;

118 i‡(*
s
) {

119 
p‹t
;

120 i‡(!
	`°∫cmp
(
s
, "0x", 2)) {

121 
óæy_£rül_ba£
 = 
	`sim∂e_°πoul
(
s
, &
e
, 16);

123 c⁄° 
__öôc⁄°
 
ba£s
[] = { 0x3f8, 0x2f8 };

125 i‡(!
	`°∫cmp
(
s
, "ttyS", 4))

126 
s
 += 4;

127 
p‹t
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

128 i‡(
p‹t
 > 1 || 
s
 =
e
)

129 
p‹t
 = 0;

130 
óæy_£rül_ba£
 = 
ba£s
[
p‹t
];

132 
s
 +
	`°rc•n
(s, ",");

133 i‡(*
s
 == ',')

134 
s
++;

137 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
LCR
);

138 
	`outb
(0, 
óæy_£rül_ba£
 + 
IER
);

139 
	`outb
(0, 
óæy_£rül_ba£
 + 
FCR
);

140 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
MCR
);

142 i‡(*
s
) {

143 
baud
 = 
	`sim∂e_°πoul
(
s
, &
e
, 0);

144 i‡(
baud
 =0 || 
s
 =
e
)

145 
baud
 = 
DEFAULT_BAUD
;

148 
divis‹
 = 115200 / 
baud
;

149 
c
 = 
	`öb
(
óæy_£rül_ba£
 + 
LCR
);

150 
	`outb
(
c
 | 
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

151 
	`outb
(
divis‹
 & 0xff, 
óæy_£rül_ba£
 + 
DLL
);

152 
	`outb
((
divis‹
 >> 8Ë& 0xff, 
óæy_£rül_ba£
 + 
DLH
);

153 
	`outb
(
c
 & ~
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

154 
	}
}

156 
c⁄sﬁe
 
	góæy_£rül_c⁄sﬁe
 = {

157 .
«me
 = "earlyser",

158 .
	gwrôe
 = 
óæy_£rül_wrôe
,

159 .
	gÊags
 = 
CON_PRINTBUFFER
,

160 .
	gödex
 = -1,

164 
c⁄sﬁe
 *
	góæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

165 
__öôd©a
 
	góæy_c⁄sﬁe_öôülized
;

167 
asmlökage
 
	$óæy_¥ötk
(c⁄° *
fmt
, ...)

169 
buf
[512];

170 
n
;

171 
va_li°
 
≠
;

173 
	`va_°¨t
(
≠
, 
fmt
);

174 
n
 = 
	`vs˙¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

175 
óæy_c⁄sﬁe
->
	`wrôe
”¨ly_c⁄sﬁe, 
buf
, 
n
);

176 
	`va_íd
(
≠
);

177 
	}
}

179 
ölöe
 
	$óæy_c⁄sﬁe_ªgi°î
(
c⁄sﬁe
 *
c⁄
, 
kìp_óæy
)

181 i‡(
óæy_c⁄sﬁe
->
ödex
 != -1) {

182 
	`¥ötk
(
KERN_CRIT
 "ERROR:Éarlyprintk= %sálready used\n",

183 
c⁄
->
«me
);

186 
óæy_c⁄sﬁe
 = 
c⁄
;

187 i‡(
kìp_óæy
)

188 
óæy_c⁄sﬁe
->
Êags
 &~
CON_BOOT
;

190 
óæy_c⁄sﬁe
->
Êags
 |
CON_BOOT
;

191 
	`ªgi°î_c⁄sﬁe
(
óæy_c⁄sﬁe
);

192 
	}
}

194 
__öô
 
	$£tup_óæy_¥ötk
(*
buf
)

196 
kìp
;

198 i‡(!
buf
)

201 i‡(
óæy_c⁄sﬁe_öôülized
)

203 
óæy_c⁄sﬁe_öôülized
 = 1;

205 
kìp
 = (
	`°r°r
(
buf
, "kìp"Ë!
NULL
);

207 *
buf
 != '\0') {

208 i‡(!
	`°∫cmp
(
buf
, "serial", 6)) {

209 
buf
 += 6;

210 
	`óæy_£rül_öô
(
buf
);

211 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

212 i‡(!
	`°∫cmp
(
buf
, ",ttyS", 5))

213 
buf
 += 5;

215 i‡(!
	`°∫cmp
(
buf
, "ttyS", 4)) {

216 
	`óæy_£rül_öô
(
buf
 + 4);

217 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

219 i‡(!
	`°∫cmp
(
buf
, "vga", 3) &&

220 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_isVGA
 == 1) {

221 
max_xpos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_cﬁs
;

222 
max_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_löes
;

223 
cuºít_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_y
;

224 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_vga_c⁄sﬁe
, 
kìp
);

226 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


227 i‡(!
	`°∫cmp
(
buf
, "dbgp", 4Ë&& !
	`óæy_dbgp_öô
(buf + 4))

228 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_dbgp_c⁄sﬁe
, 
kìp
);

230 #ifde‡
CONFIG_HVC_XEN


231 i‡(!
	`°∫cmp
(
buf
, "xen", 3))

232 
	`óæy_c⁄sﬁe_ªgi°î
(&
xíboŸ_c⁄sﬁe
, 
kìp
);

234 
buf
++;

237 
	}
}

239 
óæy_∑øm
("óæy¥ötk", 
£tup_óæy_¥ötk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/efi.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/•ölock.h
>

34 
	~<löux/uac˚ss.h
>

35 
	~<löux/time.h
>

36 
	~<löux/io.h
>

37 
	~<löux/ªboŸ.h
>

38 
	~<löux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ˇcheÊush.h
>

44 
	~<asm/ébÊush.h
>

45 
	~<asm/x86_öô.h
>

47 
	#EFI_DEBUG
 1

	)

48 
	#PFX
 "EFI: "

	)

50 
	gefi_íabÀd
;

51 
EXPORT_SYMBOL
(
efi_íabÀd
);

53 
efi
 
	gefi
;

54 
EXPORT_SYMBOL
(
efi
);

56 
efi_mem‹y_m≠
 
	gmemm≠
;

58 
efi
 
efi_phys
 
	g__öôd©a
;

59 
efi_sy°em_èbÀ_t
 
efi_sy°ab
 
	g__öôd©a
;

61 
__öô
 
	$£tup_n€fi
(*
¨g
)

63 
efi_íabÀd
 = 0;

65 
	}
}

66 
óæy_∑øm
("n€fi", 
£tup_n€fi
);

68 
	gadd_efi_memm≠
;

69 
EXPORT_SYMBOL
(
add_efi_memm≠
);

71 
__öô
 
	$£tup_add_efi_memm≠
(*
¨g
)

73 
add_efi_memm≠
 = 1;

75 
	}
}

76 
óæy_∑øm
("add_efi_memm≠", 
£tup_add_efi_memm≠
);

79 
efi_°©us_t
 
	$vút_efi_gë_time
(
efi_time_t
 *
tm
, 
efi_time_ˇp_t
 *
tc
)

81  
	`efi_ˇŒ_vút2
(
gë_time
, 
tm
, 
tc
);

82 
	}
}

84 
efi_°©us_t
 
	$vút_efi_£t_time
(
efi_time_t
 *
tm
)

86  
	`efi_ˇŒ_vút1
(
£t_time
, 
tm
);

87 
	}
}

89 
efi_°©us_t
 
	$vút_efi_gë_wakeup_time
(
efi_boﬁ_t
 *
íabÀd
,

90 
efi_boﬁ_t
 *
≥ndög
,

91 
efi_time_t
 *
tm
)

93  
	`efi_ˇŒ_vút3
(
gë_wakeup_time
,

94 
íabÀd
, 
≥ndög
, 
tm
);

95 
	}
}

97 
efi_°©us_t
 
	$vút_efi_£t_wakeup_time
(
efi_boﬁ_t
 
íabÀd
, 
efi_time_t
 *
tm
)

99  
	`efi_ˇŒ_vút2
(
£t_wakeup_time
,

100 
íabÀd
, 
tm
);

101 
	}
}

103 
efi_°©us_t
 
	$vút_efi_gë_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

104 
efi_guid_t
 *
víd‹
,

105 
u32
 *
©å
,

106 *
d©a_size
,

107 *
d©a
)

109  
	`efi_ˇŒ_vút5
(
gë_v¨übÀ
,

110 
«me
, 
víd‹
, 
©å
,

111 
d©a_size
, 
d©a
);

112 
	}
}

114 
efi_°©us_t
 
	$vút_efi_gë_√xt_v¨übÀ
(*
«me_size
,

115 
efi_ch¨16_t
 *
«me
,

116 
efi_guid_t
 *
víd‹
)

118  
	`efi_ˇŒ_vút3
(
gë_√xt_v¨übÀ
,

119 
«me_size
, 
«me
, 
víd‹
);

120 
	}
}

122 
efi_°©us_t
 
	$vút_efi_£t_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

123 
efi_guid_t
 *
víd‹
,

124 
©å
,

125 
d©a_size
,

126 *
d©a
)

128  
	`efi_ˇŒ_vút5
(
£t_v¨übÀ
,

129 
«me
, 
víd‹
, 
©å
,

130 
d©a_size
, 
d©a
);

131 
	}
}

133 
efi_°©us_t
 
	$vút_efi_gë_√xt_high_m⁄o_cou¡
(
u32
 *
cou¡
)

135  
	`efi_ˇŒ_vút1
(
gë_√xt_high_m⁄o_cou¡
, 
cou¡
);

136 
	}
}

138 
	$vút_efi_ª£t_sy°em
(
ª£t_ty≥
,

139 
efi_°©us_t
 
°©us
,

140 
d©a_size
,

141 
efi_ch¨16_t
 *
d©a
)

143 
	`efi_ˇŒ_vút4
(
ª£t_sy°em
, 
ª£t_ty≥
, 
°©us
,

144 
d©a_size
, 
d©a
);

145 
	}
}

147 
efi_°©us_t
 
	$vút_efi_£t_vútuÆ_addªss_m≠
(

148 
mem‹y_m≠_size
,

149 
des¸ùt‹_size
,

150 
u32
 
des¸ùt‹_vîsi⁄
,

151 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

153  
	`efi_ˇŒ_vút4
(
£t_vútuÆ_addªss_m≠
,

154 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

155 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

156 
	}
}

158 
efi_°©us_t
 
__öô
 
	$phys_efi_£t_vútuÆ_addªss_m≠
(

159 
mem‹y_m≠_size
,

160 
des¸ùt‹_size
,

161 
u32
 
des¸ùt‹_vîsi⁄
,

162 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

164 
efi_°©us_t
 
°©us
;

166 
	`efi_ˇŒ_phys_¥ñog
();

167 
°©us
 = 
	`efi_ˇŒ_phys4
(
efi_phys
.
£t_vútuÆ_addªss_m≠
,

168 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

169 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

170 
	`efi_ˇŒ_phys_ïûog
();

171  
°©us
;

172 
	}
}

174 
efi_°©us_t
 
__öô
 
	$phys_efi_gë_time
(
efi_time_t
 *
tm
,

175 
efi_time_ˇp_t
 *
tc
)

177 
efi_°©us_t
 
°©us
;

179 
	`efi_ˇŒ_phys_¥ñog
();

180 
°©us
 = 
	`efi_ˇŒ_phys2
(
efi_phys
.
gë_time
, 
tm
, 
tc
);

181 
	`efi_ˇŒ_phys_ïûog
();

182  
°©us
;

183 
	}
}

185 
	$efi_£t_πc_mmss
(
nowtime
)

187 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
;

188 
efi_°©us_t
 
°©us
;

189 
efi_time_t
 
e·
;

190 
efi_time_ˇp_t
 
ˇp
;

192 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

193 i‡(
°©us
 !
EFI_SUCCESS
) {

194 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

198 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

199 
ªÆ_möuãs
 = 
nowtime
 / 60;

200 i‡(((
	`abs
(
ªÆ_möuãs
 - 
e·
.
möuã
) + 15)/30) & 1)

201 
ªÆ_möuãs
 += 30;

202 
ªÆ_möuãs
 %= 60;

203 
e·
.
möuã
 = 
ªÆ_möuãs
;

204 
e·
.
£c⁄d
 = 
ªÆ_£c⁄ds
;

206 
°©us
 = 
efi
.
	`£t_time
(&
e·
);

207 i‡(
°©us
 !
EFI_SUCCESS
) {

208 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can't writeÅime!\n");

212 
	}
}

214 
	$efi_gë_time
()

216 
efi_°©us_t
 
°©us
;

217 
efi_time_t
 
e·
;

218 
efi_time_ˇp_t
 
ˇp
;

220 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

221 i‡(
°©us
 !
EFI_SUCCESS
)

222 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

224  
	`mktime
(
e·
.
yór
,É·.
m⁄th
,É·.
day
,É·.
hour
,

225 
e·
.
möuã
,É·.
£c⁄d
);

226 
	}
}

234 
__öô
 
	$do_add_efi_memm≠
()

236 *
p
;

238 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

239 
efi_mem‹y_desc_t
 *
md
 = 
p
;

240 
°¨t
 = 
md
->
phys_addr
;

241 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

242 
e820_ty≥
;

244 
md
->
ty≥
) {

245 
EFI_LOADER_CODE
:

246 
EFI_LOADER_DATA
:

247 
EFI_BOOT_SERVICES_CODE
:

248 
EFI_BOOT_SERVICES_DATA
:

249 
EFI_CONVENTIONAL_MEMORY
:

250 i‡(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)

251 
e820_ty≥
 = 
E820_RAM
;

253 
e820_ty≥
 = 
E820_RESERVED
;

255 
EFI_ACPI_RECLAIM_MEMORY
:

256 
e820_ty≥
 = 
E820_ACPI
;

258 
EFI_ACPI_MEMORY_NVS
:

259 
e820_ty≥
 = 
E820_NVS
;

261 
EFI_UNUSABLE_MEMORY
:

262 
e820_ty≥
 = 
E820_UNUSABLE
;

270 
e820_ty≥
 = 
E820_RESERVED
;

273 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
e820_ty≥
);

275 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

276 
	}
}

278 
__öô
 
	$efi_ª£rve_óæy
()

280 
pm≠
;

282 #ifde‡
CONFIG_X86_32


283 
pm≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
;

285 
pm≠
 = (
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
 |

286 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_hi
<<32));

288 
memm≠
.
phys_m≠
 = (*)
pm≠
;

289 
memm≠
.
ƒ_m≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_size
 /

290 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

291 
memm≠
.
desc_vîsi⁄
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_vîsi⁄
;

292 
memm≠
.
desc_size
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

293 
	`ª£rve_óæy
(
pm≠
,Öm≠ + 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
,

295 
	}
}

297 #i‡
EFI_DEBUG


298 
__öô
 
	$¥öt_efi_memm≠
()

300 
efi_mem‹y_desc_t
 *
md
;

301 *
p
;

302 
i
;

304 
p
 = 
memm≠
.
m≠
, 
i
 = 0;

305 
p
 < 
memm≠
.
m≠_íd
;

306 
p
 +
memm≠
.
desc_size
, 
i
++) {

307 
md
 = 
p
;

308 
	`¥ötk
(
KERN_INFO
 
PFX
 "mem%02u:Åype=%u,áttr=0x%llx, "

310 
i
, 
md
->
ty≥
, md->
©åibuã
, md->
phys_addr
,

311 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
),

312 (
md
->
num_∑ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

314 
	}
}

317 
__öô
 
	$efi_öô
()

319 
efi_c⁄fig_èbÀ_t
 *
c⁄fig_èbÀs
;

320 
efi_ru¡ime_£rvi˚s_t
 *
ru¡ime
;

321 
efi_ch¨16_t
 *
c16
;

322 
víd‹
[100] = "unknown";

323 
i
 = 0;

324 *
tmp
;

326 #ifde‡
CONFIG_X86_32


327 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
;

329 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)

330 (
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
 |

331 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab_hi
<<32));

334 
efi
.
sy°ab
 = 
	`óæy_i‹em≠
(()
efi_phys
.systab,

335 (
efi_sy°em_èbÀ_t
));

336 i‡(
efi
.
sy°ab
 =
NULL
)

337 
	`¥ötk
(
KERN_ERR
 "Couldn't mapÅhe EFI systemÅable!\n");

338 
	`mem˝y
(&
efi_sy°ab
, 
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

339 
	`óæy_iounm≠
(
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

340 
efi
.
sy°ab
 = &
efi_sy°ab
;

345 i‡(
efi
.
sy°ab
->
hdr
.
sig«tuª
 !
EFI_SYSTEM_TABLE_SIGNATURE
)

346 
	`¥ötk
(
KERN_ERR
 "EFI systemÅable signature incorrect!\n");

347 i‡((
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16) == 0)

348 
	`¥ötk
(
KERN_ERR
 "Warning: EFI systemÅable version "

350 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

351 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff);

356 
c16
 = 
tmp
 = 
	`óæy_i‹em≠
(
efi
.
sy°ab
->
fw_víd‹
, 2);

357 i‡(
c16
) {

358 
i
 = 0; i < (
víd‹
Ë- 1 && *
c16
; ++i)

359 
víd‹
[
i
] = *
c16
++;

360 
víd‹
[
i
] = '\0';

362 
	`¥ötk
(
KERN_ERR
 
PFX
 "CouldÇot mapÅhe firmware vendor!\n");

363 
	`óæy_iounm≠
(
tmp
, 2);

365 
	`¥ötk
(
KERN_INFO
 "EFI v%u.%.02u by %s \n",

366 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

367 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff, 
víd‹
);

372 
c⁄fig_èbÀs
 = 
	`óæy_i‹em≠
(

373 
efi
.
sy°ab
->
èbÀs
,

374 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

375 i‡(
c⁄fig_èbÀs
 =
NULL
)

376 
	`¥ötk
(
KERN_ERR
 "CouldÇot map EFI Configuration Table!\n");

378 
	`¥ötk
(
KERN_INFO
);

379 
i
 = 0; i < 
efi
.
sy°ab
->
ƒ_èbÀs
; i++) {

380 i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

381 
efi
.
mps
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

382 
	`¥ötk
(" MPS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

383 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

384 
ACPI_20_TABLE_GUID
)) {

385 
efi
.
a˝i20
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

386 
	`¥ötk
(" ACPI 2.0=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

387 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

388 
ACPI_TABLE_GUID
)) {

389 
efi
.
a˝i
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

390 
	`¥ötk
(" ACPI=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

391 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

392 
SMBIOS_TABLE_GUID
)) {

393 
efi
.
smbios
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

394 
	`¥ötk
(" SMBIOS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

395 #ifde‡
CONFIG_X86_UV


396 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

397 
UV_SYSTEM_TABLE_GUID
)) {

398 
efi
.
uv_sy°ab
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

399 
	`¥ötk
(" UVsy°ab=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

401 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

402 
HCDP_TABLE_GUID
)) {

403 
efi
.
hcdp
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

404 
	`¥ötk
(" HCDP=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

405 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

406 
UGA_IO_PROTOCOL_GUID
)) {

407 
efi
.
uga
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

408 
	`¥ötk
(" UGA=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

411 
	`¥ötk
("\n");

412 
	`óæy_iounm≠
(
c⁄fig_èbÀs
,

413 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

421 
ru¡ime
 = 
	`óæy_i‹em≠
(()
efi
.
sy°ab
->runtime,

422 (
efi_ru¡ime_£rvi˚s_t
));

423 i‡(
ru¡ime
 !
NULL
) {

429 
efi_phys
.
gë_time
 = (
efi_gë_time_t
 *)
ru¡ime
->get_time;

430 
efi_phys
.
£t_vútuÆ_addªss_m≠
 =

431 (
efi_£t_vútuÆ_addªss_m≠_t
 *)

432 
ru¡ime
->
£t_vútuÆ_addªss_m≠
;

437 
efi
.
gë_time
 = 
phys_efi_gë_time
;

439 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFIÑuntime service "

441 
	`óæy_iounm≠
(
ru¡ime
, (
efi_ru¡ime_£rvi˚s_t
));

444 
memm≠
.
m≠
 = 
	`óæy_i‹em≠
(()memm≠.
phys_m≠
,

445 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
);

446 i‡(
memm≠
.
m≠
 =
NULL
)

447 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFI memory map!\n");

448 
memm≠
.
m≠_íd
 = memm≠.
m≠
 + (memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

450 i‡(
memm≠
.
desc_size
 !(
efi_mem‹y_desc_t
))

451 
	`¥ötk
(
KERN_WARNING


454 i‡(
add_efi_memm≠
)

455 
	`do_add_efi_memm≠
();

457 #ifde‡
CONFIG_X86_32


458 
x86_∂©f‹m
.
gë_wÆl˛ock
 = 
efi_gë_time
;

459 
x86_∂©f‹m
.
£t_wÆl˛ock
 = 
efi_£t_πc_mmss
;

463 
ªboŸ_ty≥
 = 
BOOT_EFI
;

465 #i‡
EFI_DEBUG


466 
	`¥öt_efi_memm≠
();

468 
	}
}

470 
__öô
 
	$ru¡ime_code_∑ge_mkexec
()

472 
efi_mem‹y_desc_t
 *
md
;

473 *
p
;

474 
u64
 
addr
, 
≈ages
;

477 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

478 
md
 = 
p
;

480 i‡(
md
->
ty≥
 !
EFI_RUNTIME_SERVICES_CODE
)

483 
addr
 = 
md
->
vút_addr
;

484 
≈ages
 = 
md
->
num_∑ges
;

485 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

486 
	`£t_mem‹y_x
(
addr
, 
≈ages
);

488 
	}
}

498 
__öô
 
	$efi_íãr_vútuÆ_mode
()

500 
efi_mem‹y_desc_t
 *
md
;

501 
efi_°©us_t
 
°©us
;

502 
size
;

503 
u64
 
íd
, 
sy°ab
, 
addr
, 
≈ages
, 
íd_p‚
;

504 *
p
, *
va
;

506 
efi
.
sy°ab
 = 
NULL
;

507 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

508 
md
 = 
p
;

509 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_RUNTIME
))

512 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

513 
íd
 = 
md
->
phys_addr
 + 
size
;

515 
íd_p‚
 = 
	`PFN_UP
(
íd
);

516 i‡(
íd_p‚
 <
max_low_p‚_m≠≥d


517 || (
íd_p‚
 > (1UL << (32 - 
PAGE_SHIFT
))

518 && 
íd_p‚
 <
max_p‚_m≠≥d
))

519 
va
 = 
	`__va
(
md
->
phys_addr
);

521 
va
 = 
	`efi_i‹em≠
(
md
->
phys_addr
, 
size
, md->
ty≥
);

523 
md
->
vút_addr
 = (
u64
Ë(Ë
va
;

525 i‡(!
va
) {

526 
	`¥ötk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

527 ()
md
->
phys_addr
);

531 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)) {

532 
addr
 = 
md
->
vút_addr
;

533 
≈ages
 = 
md
->
num_∑ges
;

534 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

535 
	`£t_mem‹y_uc
(
addr
, 
≈ages
);

538 
sy°ab
 = (
u64
Ë(Ë
efi_phys
.systab;

539 i‡(
md
->
phys_addr
 <
sy°ab
 && sy°ab < 
íd
) {

540 
sy°ab
 +
md
->
vút_addr
 - md->
phys_addr
;

541 
efi
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *) () systab;

545 
	`BUG_ON
(!
efi
.
sy°ab
);

547 
°©us
 = 
	`phys_efi_£t_vútuÆ_addªss_m≠
(

548 
memm≠
.
desc_size
 * memm≠.
ƒ_m≠
,

549 
memm≠
.
desc_size
,

550 
memm≠
.
desc_vîsi⁄
,

551 
memm≠
.
phys_m≠
);

553 i‡(
°©us
 !
EFI_SUCCESS
) {

554 
	`¥ötk
(
KERN_ALERT
 "UnableÅo switch EFI into virtual mode "

555 "(°©us=%lx)!\n", 
°©us
);

556 
	`∑nic
("EFI callÅo SetVirtualAddressMap() failed!");

565 
efi
.
gë_time
 = 
vút_efi_gë_time
;

566 
efi
.
£t_time
 = 
vút_efi_£t_time
;

567 
efi
.
gë_wakeup_time
 = 
vút_efi_gë_wakeup_time
;

568 
efi
.
£t_wakeup_time
 = 
vút_efi_£t_wakeup_time
;

569 
efi
.
gë_v¨übÀ
 = 
vút_efi_gë_v¨übÀ
;

570 
efi
.
gë_√xt_v¨übÀ
 = 
vút_efi_gë_√xt_v¨übÀ
;

571 
efi
.
£t_v¨übÀ
 = 
vút_efi_£t_v¨übÀ
;

572 
efi
.
gë_√xt_high_m⁄o_cou¡
 = 
vút_efi_gë_√xt_high_m⁄o_cou¡
;

573 
efi
.
ª£t_sy°em
 = 
vút_efi_ª£t_sy°em
;

574 
efi
.
£t_vútuÆ_addªss_m≠
 = 
vút_efi_£t_vútuÆ_addªss_m≠
;

575 i‡(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
)

576 
	`ru¡ime_code_∑ge_mkexec
();

577 
	`óæy_iounm≠
(
memm≠
.
m≠
, memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

578 
memm≠
.
m≠
 = 
NULL
;

579 
	}
}

584 
u32
 
	$efi_mem_ty≥
(
phys_addr
)

586 
efi_mem‹y_desc_t
 *
md
;

587 *
p
;

589 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

590 
md
 = 
p
;

591 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

592 (
phys_addr
 < (
md
->phys_addr +

593 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

594  
md
->
ty≥
;

597 
	}
}

599 
u64
 
	$efi_mem_©åibuãs
(
phys_addr
)

601 
efi_mem‹y_desc_t
 *
md
;

602 *
p
;

604 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

605 
md
 = 
p
;

606 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

607 (
phys_addr
 < (
md
->phys_addr +

608 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

609  
md
->
©åibuã
;

612 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/efi.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/ªboŸ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/fixm≠.h
>

41 
pgd_t
 
ßve_pgd
 
	g__öôd©a
;

42 
efi_Êags
 
	g__öôd©a
;

44 
__öô
 
	$óæy_m≠pög_£t_exec
(
°¨t
,

45 
íd
,

46 
execuèbÀ
)

48 
num_∑ges
;

50 
°¨t
 &
PMD_MASK
;

51 
íd
 = (íd + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

52 
num_∑ges
 = (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

53 i‡(
execuèbÀ
)

54 
	`£t_mem‹y_x
(()
	`__va
(
°¨t
), 
num_∑ges
);

56 
	`£t_mem‹y_nx
(()
	`__va
(
°¨t
), 
num_∑ges
);

57 
	}
}

59 
__öô
 
	$óæy_ru¡ime_code_m≠pög_£t_exec
(
execuèbÀ
)

61 
efi_mem‹y_desc_t
 *
md
;

62 *
p
;

64 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

69 
md
 = 
p
;

70 i‡(
md
->
ty≥
 =
EFI_RUNTIME_SERVICES_CODE
) {

71 
íd
;

72 
íd
 = 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
);

73 
	`óæy_m≠pög_£t_exec
(
md
->
phys_addr
, 
íd
, 
execuèbÀ
);

76 
	}
}

78 
__öô
 
	$efi_ˇŒ_phys_¥ñog
()

80 
vaddªss
;

82 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(1);

83 
	`loˇl_úq_ßve
(
efi_Êags
);

84 
vaddªss
 = ()
	`__va
(0x0UL);

85 
ßve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vaddªss
));

87 
	`__Êush_éb_Æl
();

88 
	}
}

90 
__öô
 
	$efi_ˇŒ_phys_ïûog
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
ßve_pgd
);

96 
	`__Êush_éb_Æl
();

97 
	`loˇl_úq_ª°‹e
(
efi_Êags
);

98 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__öô
 
	$efi_i‹em≠
(
phys_addr
, 
size
,

102 
u32
 
ty≥
)

104 
œ°_m≠_p‚
;

106 i‡(
ty≥
 =
EFI_MEMORY_MAPPED_IO
)

107  
	`i‹em≠
(
phys_addr
, 
size
);

109 
œ°_m≠_p‚
 = 
	`öô_mem‹y_m≠pög
(
phys_addr
,Öhys_add∏+ 
size
);

110 i‡((
œ°_m≠_p‚
 << 
PAGE_SHIFT
Ë< 
phys_addr
 + 
size
)

111  
NULL
;

113  (
__iomem
 *)
	`__va
(
phys_addr
);

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/öô.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__öô
 
	$ª£rve_ebda_ªgi⁄
()

21 
lowmem
, 
ebda_addr
;

29 i‡(
	`∑øvút_íabÀd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`gë_bios_ebda
();

41 i‡((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 i‡((
ebda_addr
 =0Ë&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 i‡((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`ª£rve_óæy_ovîœp_ok
(
lowmem
, 0x100000, "BIOSÑeserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<löux/öô.h
>

8 
	~<löux/lökage.h
>

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/≥r˝u.h
>

13 
	~<löux/°¨t_kî√l.h
>

14 
	~<löux/io.h
>

16 
	~<asm/¥o˚ss‹.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/£˘i⁄s.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/åampﬁöe.h
>

27 
	~<asm/bios_ebda.h
>

29 
__öô
 
	$z≠_idítôy_m≠pögs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_˛ór
(
pgd
);

33 
	`__Êush_éb_Æl
();

34 
	}
}

38 
__öô
 
	$˛ór_bss
()

40 
	`mem£t
(
__bss_°¨t
, 0,

41 (Ë
__bss_°›
 - (Ë
__bss_°¨t
);

42 
	}
}

44 
__öô
 
	$c›y_boŸd©a
(*
ªÆ_mode_d©a
)

46 * 
comm™d_löe
;

48 
	`mem˝y
(&
boŸ_∑øms
, 
ªÆ_mode_d©a
,  boot_params);

49 i‡(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
) {

50 
comm™d_löe
 = 
	`__va
(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
);

51 
	`mem˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__öô
 
	$x86_64_°¨t_kî√l
(* 
ªÆ_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1Ë& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vút
(
__íd_of_fixed_addªs£s
Ë<
MODULES_END
);

74 
	`˛ór_bss
();

77 
	`z≠_idítôy_m≠pögs
();

80 
	`˛ónup_highm≠
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifde‡
CONFIG_EARLY_PRINTK


84 
	`£t_öå_g©e
(
i
, &
óæy_idt_h™dÀrs
[i]);

86 
	`£t_öå_g©e
(
i
, 
óæy_idt_h™dÀr
);

89 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

91 i‡(
c⁄sﬁe_logÀvñ
 == 10)

92 
	`óæy_¥ötk
("Kernelálive\n");

94 
	`x86_64_°¨t_ª£rv©i⁄s
(
ªÆ_mode_d©a
);

95 
	}
}

97 
__öô
 
	$x86_64_°¨t_ª£rv©i⁄s
(*
ªÆ_mode_d©a
)

99 
	`c›y_boŸd©a
(
	`__va
(
ªÆ_mode_d©a
));

101 
	`ª£rve_åampﬁöe_mem‹y
();

103 
	`ª£rve_óæy
(
	`__∑_symbﬁ
(&
_ãxt
), __∑_symbﬁ(&
__bss_°›
), "TEXT DATA BSS");

105 #ifde‡
CONFIG_BLK_DEV_INITRD


107 i‡(
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 && boŸ_∑øms.hdr.
ømdisk_image
) {

108 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

109 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

110 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

111 
	`ª£rve_óæy
(
ømdisk_image
, 
ømdisk_íd
, "RAMDISK");

115 
	`ª£rve_ebda_ªgi⁄
();

123 
	`°¨t_kî√l
();

124 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<löux/˛ocksour˚.h
>

2 
	~<löux/˛ockchùs.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/sysdev.h
>

5 
	~<löux/dñay.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/h≥t.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/˝u.h
>

10 
	~<löux/pm.h
>

11 
	~<löux/io.h
>

13 
	~<asm/fixm≠.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/h≥t.h
>

17 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

18 
	#HPET_SHIFT
 22

	)

22 
	#FSEC_PER_NSEC
 1000000L

	)

24 
	#HPET_DEV_USED_BIT
 2

	)

25 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

26 
	#HPET_DEV_VALID
 0x8

	)

27 
	#HPET_DEV_FSB_CAP
 0x1000

	)

28 
	#HPET_DEV_PERI_CAP
 0x2000

	)

30 
	#EVT_TO_HPET_DEV
(
evt
Ë
	`c⁄èöî_of
”vt, 
h≥t_dev
,Évt)

	)

35 
	gh≥t_addªss
;

36 #ifde‡
CONFIG_PCI_MSI


37 
	gh≥t_num_timîs
;

39 
__iomem
 *
	gh≥t_vút_addªss
;

41 
	sh≥t_dev
 {

42 
˛ock_evít_devi˚
 
	mevt
;

43 
	mnum
;

44 
	m˝u
;

45 
	múq
;

46 
	mÊags
;

47 
	m«me
[10];

50 
	$h≥t_ªadl
(
a
)

52  
	`ªadl
(
h≥t_vút_addªss
 + 
a
);

53 
	}
}

55 
ölöe
 
	$h≥t_wrôñ
(
d
, 
a
)

57 
	`wrôñ
(
d
, 
h≥t_vút_addªss
 + 
a
);

58 
	}
}

60 #ifde‡
CONFIG_X86_64


61 
	~<asm/pgèbÀ.h
>

64 
ölöe
 
	$h≥t_£t_m≠pög
()

66 
h≥t_vút_addªss
 = 
	`i‹em≠_noˇche
(
h≥t_addªss
, 
HPET_MMAP_SIZE
);

67 #ifde‡
CONFIG_X86_64


68 
	`__£t_fixm≠
(
VSYSCALL_HPET
, 
h≥t_addªss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

70 
	}
}

72 
ölöe
 
	$h≥t_˛ór_m≠pög
()

74 
	`iounm≠
(
h≥t_vút_addªss
);

75 
h≥t_vút_addªss
 = 
NULL
;

76 
	}
}

81 
	gboŸ_h≥t_dißbÀ
;

82 
	gh≥t_f‹˚_u£r
;

83 
	gh≥t_vîbo£
;

85 
__öô
 
	$h≥t_£tup
(*
°r
)

87 i‡(
°r
) {

88 i‡(!
	`°∫cmp
("dißbÀ", 
°r
, 7))

89 
boŸ_h≥t_dißbÀ
 = 1;

90 i‡(!
	`°∫cmp
("f‹˚", 
°r
, 5))

91 
h≥t_f‹˚_u£r
 = 1;

92 i‡(!
	`°∫cmp
("vîbo£", 
°r
, 7))

93 
h≥t_vîbo£
 = 1;

96 
	}
}

97 
__£tup
("h≥t=", 
h≥t_£tup
);

99 
__öô
 
	$dißbÀ_h≥t
(*
°r
)

101 
boŸ_h≥t_dißbÀ
 = 1;

103 
	}
}

104 
__£tup
("noh≥t", 
dißbÀ_h≥t
);

106 
ölöe
 
	$is_h≥t_ˇ∑bÀ
()

108  !
boŸ_h≥t_dißbÀ
 && 
h≥t_addªss
;

109 
	}
}

114 
	gh≥t_Àgacy_öt_íabÀd
;

119 
	$is_h≥t_íabÀd
()

121  
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_Àgacy_öt_íabÀd
;

122 
	}
}

123 
EXPORT_SYMBOL_GPL
(
is_h≥t_íabÀd
);

125 
	$_h≥t_¥öt_c⁄fig
(c⁄° *
fun˘i⁄
, 
löe
)

127 
u32
 
i
, 
timîs
, 
l
, 
h
;

128 
	`¥ötk
(
KERN_INFO
 "h≥t: %s(%d):\n", 
fun˘i⁄
, 
löe
);

129 
l
 = 
	`h≥t_ªadl
(
HPET_ID
);

130 
h
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

131 
timîs
 = ((
l
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

132 
	`¥ötk
(
KERN_INFO
 "h≥t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

133 
l
 = 
	`h≥t_ªadl
(
HPET_CFG
);

134 
h
 = 
	`h≥t_ªadl
(
HPET_STATUS
);

135 
	`¥ötk
(
KERN_INFO
 "h≥t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

136 
l
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

137 
h
 = 
	`h≥t_ªadl
(
HPET_COUNTER
+4);

138 
	`¥ötk
(
KERN_INFO
 "h≥t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

140 
i
 = 0; i < 
timîs
; i++) {

141 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

142 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
)+4);

143 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

144 
i
, 
l
, 
h
);

145 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
));

146 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
)+4);

147 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

148 
i
, 
l
, 
h
);

149 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
));

150 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
)+4);

151 
	`¥ötk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

152 
i
, 
l
, 
h
);

154 
	}
}

156 
	#h≥t_¥öt_c⁄fig
() \

158 i‡(
h≥t_vîbo£
) \

159 
	`_h≥t_¥öt_c⁄fig
(
__FUNCTION__
, 
__LINE__
); \

160 } 0)

	)

166 #ifde‡
CONFIG_HPET


168 
h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
);

170 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
)

172 
h≥t
 
__iomem
 *h≥à
h≥t_vút_addªss
;

173 
h≥t_timî
 
__iomem
 *
timî
 = &
h≥t
->
h≥t_timîs
[2];

174 
ƒtimîs
, 
i
;

175 
h≥t_d©a
 
hd
;

177 
ƒtimîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

179 
	`mem£t
(&
hd
, 0, (hd));

180 
hd
.
hd_phys_addªss
 = 
h≥t_addªss
;

181 
hd
.
hd_addªss
 = 
h≥t
;

182 
hd
.
hd_núqs
 = 
ƒtimîs
;

183 
	`h≥t_ª£rve_timî
(&
hd
, 0);

185 #ifde‡
CONFIG_HPET_EMULATE_RTC


186 
	`h≥t_ª£rve_timî
(&
hd
, 1);

194 
hd
.
hd_úq
[0] = 
HPET_LEGACY_8254
;

195 
hd
.
hd_úq
[1] = 
HPET_LEGACY_RTC
;

197 
i
 = 2; i < 
ƒtimîs
; 
timî
++, i++) {

198 
hd
.
hd_úq
[
i
] = (
	`ªadl
(&
timî
->
h≥t_c⁄fig
) &

199 
Tn_INT_ROUTE_CNF_MASK
Ë>> 
Tn_INT_ROUTE_CNF_SHIFT
;

202 
	`h≥t_ª£rve_msi_timîs
(&
hd
);

204 
	`h≥t_Æloc
(&
hd
);

206 
	}
}

208 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
Ë{ 
	}
}

214 
	gh≥t_≥riod
;

216 
h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

217 
˛ock_evít_devi˚
 *
evt
);

218 
h≥t_Àgacy_√xt_evít
(
dñè
,

219 
˛ock_evít_devi˚
 *
evt
);

224 
˛ock_evít_devi˚
 
	gh≥t_˛ockevít
 = {

225 .
«me
 = "hpet",

226 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

227 .
	g£t_mode
 = 
h≥t_Àgacy_£t_mode
,

228 .
	g£t_√xt_evít
 = 
h≥t_Àgacy_√xt_evít
,

229 .
	gshi·
 = 32,

230 .
	gúq
 = 0,

231 .
	gøtög
 = 50,

234 
	$h≥t_°›_cou¡î
()

236 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

237 
cfg
 &~
HPET_CFG_ENABLE
;

238 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

239 
	}
}

241 
	$h≥t_ª£t_cou¡î
()

243 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
);

244 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
 + 4);

245 
	}
}

247 
	$h≥t_°¨t_cou¡î
()

249 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

250 
cfg
 |
HPET_CFG_ENABLE
;

251 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

252 
	}
}

254 
	$h≥t_ª°¨t_cou¡î
()

256 
	`h≥t_°›_cou¡î
();

257 
	`h≥t_ª£t_cou¡î
();

258 
	`h≥t_°¨t_cou¡î
();

259 
	}
}

261 
	$h≥t_ªsume_devi˚
()

263 
	`f‹˚_h≥t_ªsume
();

264 
	}
}

266 
	$h≥t_ªsume_cou¡î
()

268 
	`h≥t_ªsume_devi˚
();

269 
	`h≥t_ª°¨t_cou¡î
();

270 
	}
}

272 
	$h≥t_íabÀ_Àgacy_öt
()

274 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

276 
cfg
 |
HPET_CFG_LEGACY
;

277 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

278 
h≥t_Àgacy_öt_íabÀd
 = 1;

279 
	}
}

281 
	$h≥t_Àgacy_˛ockevít_ªgi°î
()

284 
	`h≥t_íabÀ_Àgacy_öt
();

294 
h≥t_˛ockevít
.
mu…
 = 
	`div_sc
((Ë
FSEC_PER_NSEC
,

295 
h≥t_≥riod
, 
h≥t_˛ockevít
.
shi·
);

297 
h≥t_˛ockevít
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,

298 &
h≥t_˛ockevít
);

300 
h≥t_˛ockevít
.
mö_dñè_ns
 = 5000;

306 
h≥t_˛ockevít
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

307 
	`˛ockevíts_ªgi°î_devi˚
(&
h≥t_˛ockevít
);

308 
globÆ_˛ock_evít
 = &
h≥t_˛ockevít
;

309 
	`¥ötk
(
KERN_DEBUG
 "hpet clockeventÑegistered\n");

310 
	}
}

312 
h≥t_£tup_msi_úq
(
úq
);

314 
	$h≥t_£t_mode
(
˛ock_evít_mode
 
mode
,

315 
˛ock_evít_devi˚
 *
evt
, 
timî
)

317 
cfg
, 
cmp
, 
now
;

318 
uöt64_t
 
dñè
;

320 
mode
) {

321 
CLOCK_EVT_MODE_PERIODIC
:

322 
	`h≥t_°›_cou¡î
();

323 
dñè
 = ((
uöt64_t
)(
NSEC_PER_SEC
/
HZ
)Ë* 
evt
->
mu…
;

324 
dñè
 >>
evt
->
shi·
;

325 
now
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

326 
cmp
 = 
now
 + (Ë
dñè
;

327 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

329 
cfg
 &~
HPET_TN_LEVEL
;

330 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

331 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

332 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

333 
	`h≥t_wrôñ
(
cmp
, 
	`HPET_Tn_CMP
(
timî
));

334 
	`udñay
(1);

342 
	`h≥t_wrôñ
((Ë
dñè
, 
	`HPET_Tn_CMP
(
timî
));

343 
	`h≥t_°¨t_cou¡î
();

344 
	`h≥t_¥öt_c⁄fig
();

347 
CLOCK_EVT_MODE_ONESHOT
:

348 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

349 
cfg
 &~
HPET_TN_PERIODIC
;

350 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

351 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

354 
CLOCK_EVT_MODE_UNUSED
:

355 
CLOCK_EVT_MODE_SHUTDOWN
:

356 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

357 
cfg
 &~
HPET_TN_ENABLE
;

358 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

361 
CLOCK_EVT_MODE_RESUME
:

362 i‡(
timî
 == 0) {

363 
	`h≥t_íabÀ_Àgacy_öt
();

365 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

366 
	`h≥t_£tup_msi_úq
(
hdev
->
úq
);

367 
	`dißbÀ_úq
(
hdev
->
úq
);

368 
	`úq_£t_afföôy
(
hdev
->
úq
, 
	`˝umask_of
(hdev->
˝u
));

369 
	`íabÀ_úq
(
hdev
->
úq
);

371 
	`h≥t_¥öt_c⁄fig
();

374 
	}
}

376 
	$h≥t_√xt_evít
(
dñè
,

377 
˛ock_evít_devi˚
 *
evt
, 
timî
)

379 
u32
 
˙t
;

381 
˙t
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

382 
˙t
 +(
u32
Ë
dñè
;

383 
	`h≥t_wrôñ
(
˙t
, 
	`HPET_Tn_CMP
(
timî
));

390 
	`WARN_ON_ONCE
((
u32
)
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
)Ë!
˙t
);

392  (
s32
)((
u32
)
	`h≥t_ªadl
(
HPET_COUNTER
Ë- 
˙t
Ë>0 ? -
ETIME
 : 0;

393 
	}
}

395 
	$h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

396 
˛ock_evít_devi˚
 *
evt
)

398 
	`h≥t_£t_mode
(
mode
, 
evt
, 0);

399 
	}
}

401 
	$h≥t_Àgacy_√xt_evít
(
dñè
,

402 
˛ock_evít_devi˚
 *
evt
)

404  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 0);

405 
	}
}

410 #ifde‡
CONFIG_PCI_MSI


412 
DEFINE_PER_CPU
(
h≥t_dev
 *, 
˝u_h≥t_dev
);

413 
h≥t_dev
 *
	gh≥t_devs
;

415 
	$h≥t_msi_unmask
(
úq
)

417 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

418 
cfg
;

421 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

422 
cfg
 |
HPET_TN_FSB
;

423 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

424 
	}
}

426 
	$h≥t_msi_mask
(
úq
)

428 
cfg
;

429 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

432 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

433 
cfg
 &~
HPET_TN_FSB
;

434 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

435 
	}
}

437 
	$h≥t_msi_wrôe
(
úq
, 
msi_msg
 *
msg
)

439 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

441 
	`h≥t_wrôñ
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

442 
	`h≥t_wrôñ
(
msg
->
addªss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

443 
	}
}

445 
	$h≥t_msi_ªad
(
úq
, 
msi_msg
 *
msg
)

447 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

449 
msg
->
d©a
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

450 
msg
->
addªss_lo
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

451 
msg
->
addªss_hi
 = 0;

452 
	}
}

454 
	$h≥t_msi_£t_mode
(
˛ock_evít_mode
 
mode
,

455 
˛ock_evít_devi˚
 *
evt
)

457 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

458 
	`h≥t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

459 
	}
}

461 
	$h≥t_msi_√xt_evít
(
dñè
,

462 
˛ock_evít_devi˚
 *
evt
)

464 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

465  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 
hdev
->
num
);

466 
	}
}

468 
	$h≥t_£tup_msi_úq
(
úq
)

470 i‡(
	`¨ch_£tup_h≥t_msi
(
úq
)) {

471 
	`de°roy_úq
(
úq
);

472  -
EINVAL
;

475 
	}
}

477 
	$h≥t_assign_úq
(
h≥t_dev
 *
dev
)

479 
úq
;

481 
úq
 = 
	`¸óã_úq
();

482 i‡(!
úq
)

483  -
EINVAL
;

485 
	`£t_úq_d©a
(
úq
, 
dev
);

487 i‡(
	`h≥t_£tup_msi_úq
(
úq
))

488  -
EINVAL
;

490 
dev
->
úq
 = irq;

492 
	}
}

494 
úqªtu∫_t
 
	$h≥t_öãºu±_h™dÀr
(
úq
, *
d©a
)

496 
h≥t_dev
 *
dev
 = (h≥t_dev *)
d©a
;

497 
˛ock_evít_devi˚
 *
hevt
 = &
dev
->
evt
;

499 i‡(!
hevt
->
evít_h™dÀr
) {

500 
	`¥ötk
(
KERN_INFO
 "Spurious HPETÅimer interrupt on HPETÅimer %d\n",

501 
dev
->
num
);

502  
IRQ_HANDLED
;

505 
hevt
->
	`evít_h™dÀr
(hevt);

506  
IRQ_HANDLED
;

507 
	}
}

509 
	$h≥t_£tup_úq
(
h≥t_dev
 *
dev
)

512 i‡(
	`ªque°_úq
(
dev
->
úq
, 
h≥t_öãºu±_h™dÀr
,

513 
IRQF_TIMER
 | 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
,

514 
dev
->
«me
, dev))

517 
	`dißbÀ_úq
(
dev
->
úq
);

518 
	`úq_£t_afföôy
(
dev
->
úq
, 
	`˝umask_of
(dev->
˝u
));

519 
	`íabÀ_úq
(
dev
->
úq
);

521 
	`¥ötk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

522 
dev
->
«me
, dev->
úq
);

525 
	}
}

528 
	$öô_⁄e_h≥t_msi_˛ockevít
(
h≥t_dev
 *
hdev
, 
˝u
)

530 
˛ock_evít_devi˚
 *
evt
 = &
hdev
->evt;

531 
uöt64_t
 
h≥t_‰eq
;

533 
	`WARN_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

534 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

537 i‡(
	`h≥t_£tup_msi_úq
(
hdev
->
úq
))

540 
hdev
->
˝u
 = cpu;

541 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
hdev
;

542 
evt
->
«me
 = 
hdev
->name;

543 
	`h≥t_£tup_úq
(
hdev
);

544 
evt
->
úq
 = 
hdev
->irq;

546 
evt
->
øtög
 = 110;

547 
evt
->
„©uªs
 = 
CLOCK_EVT_FEAT_ONESHOT
;

548 i‡(
hdev
->
Êags
 & 
HPET_DEV_PERI_CAP
)

549 
evt
->
„©uªs
 |
CLOCK_EVT_FEAT_PERIODIC
;

551 
evt
->
£t_mode
 = 
h≥t_msi_£t_mode
;

552 
evt
->
£t_√xt_evít
 = 
h≥t_msi_√xt_evít
;

553 
evt
->
shi·
 = 32;

560 
h≥t_‰eq
 = 1000000000000000ULL;

561 
	`do_div
(
h≥t_‰eq
, 
h≥t_≥riod
);

562 
evt
->
mu…
 = 
	`div_sc
((Ë
h≥t_‰eq
,

563 
NSEC_PER_SEC
, 
evt
->
shi·
);

565 
evt
->
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,Évt);

567 
evt
->
mö_dñè_ns
 = 5000;

569 
evt
->
˝umask
 = 
	`˝umask_of
(
hdev
->
˝u
);

570 
	`˛ockevíts_ªgi°î_devi˚
(
evt
);

571 
	}
}

573 #ifde‡
CONFIG_HPET


575 
	#RESERVE_TIMERS
 1

	)

577 
	#RESERVE_TIMERS
 0

	)

580 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

582 
id
;

583 
num_timîs
;

584 
num_timîs_u£d
 = 0;

585 
i
;

587 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

589 
num_timîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
);

590 
num_timîs
++;

591 
	`h≥t_¥öt_c⁄fig
();

593 
h≥t_devs
 = 
	`kzÆloc
((
h≥t_dev
Ë* 
num_timîs
, 
GFP_KERNEL
);

594 i‡(!
h≥t_devs
)

597 
h≥t_num_timîs
 = 
num_timîs
;

599 
i
 = 
°¨t_timî
; i < 
num_timîs
 - 
RESERVE_TIMERS
; i++) {

600 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
num_timîs_u£d
];

601 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

604 i‡(!(
cfg
 & 
HPET_TN_FSB_CAP
))

607 
hdev
->
Êags
 = 0;

608 i‡(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

609 
hdev
->
Êags
 |
HPET_DEV_PERI_CAP
;

610 
hdev
->
num
 = 
i
;

612 
	`•rötf
(
hdev
->
«me
, "h≥t%d", 
i
);

613 i‡(
	`h≥t_assign_úq
(
hdev
))

616 
hdev
->
Êags
 |
HPET_DEV_FSB_CAP
;

617 
hdev
->
Êags
 |
HPET_DEV_VALID
;

618 
num_timîs_u£d
++;

619 i‡(
num_timîs_u£d
 =
	`num_possibÀ_˝us
())

623 
	`¥ötk
(
KERN_INFO
 "HPET: %dÅimers inÅotal, %dÅimers will be used forÖer-cpuÅimer\n",

624 
num_timîs
, 
num_timîs_u£d
);

625 
	}
}

627 #ifde‡
CONFIG_HPET


628 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

630 
i
;

632 i‡(!
h≥t_devs
)

635 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

636 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

638 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

641 
hd
->
hd_úq
[
hdev
->
num
] = hdev->
úq
;

642 
	`h≥t_ª£rve_timî
(
hd
, 
hdev
->
num
);

644 
	}
}

647 
h≥t_dev
 *
	$h≥t_gë_unu£d_timî
()

649 
i
;

651 i‡(!
h≥t_devs
)

652  
NULL
;

654 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

655 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

657 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

659 i‡(
	`ã°_™d_£t_bô
(
HPET_DEV_USED_BIT
,

660 (*)&
hdev
->
Êags
))

662  
hdev
;

664  
NULL
;

665 
	}
}

667 
	sh≥t_w‹k_°ru˘
 {

668 
dñayed_w‹k
 
	mw‹k
;

669 
com∂ëi⁄
 
	mcom∂ëe
;

672 
	$h≥t_w‹k
(
w‹k_°ru˘
 *
w
)

674 
h≥t_dev
 *
hdev
;

675 
˝u
 = 
	`smp_¥o˚ss‹_id
();

676 
h≥t_w‹k_°ru˘
 *
h≥t_w‹k
;

678 
h≥t_w‹k
 = 
	`c⁄èöî_of
(
w
, 
h≥t_w‹k_°ru˘
, 
w‹k
.work);

680 
hdev
 = 
	`h≥t_gë_unu£d_timî
();

681 i‡(
hdev
)

682 
	`öô_⁄e_h≥t_msi_˛ockevít
(
hdev
, 
˝u
);

684 
	`com∂ëe
(&
h≥t_w‹k
->
com∂ëe
);

685 
	}
}

687 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

688 
a˘i⁄
, *
h˝u
)

690 
˝u
 = ()
h˝u
;

691 
h≥t_w‹k_°ru˘
 
w‹k
;

692 
h≥t_dev
 *
hdev
 = 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
);

694 
a˘i⁄
 & 0xf) {

695 
CPU_ONLINE
:

696 
	`INIT_DELAYED_WORK_ON_STACK
(&
w‹k
.w‹k, 
h≥t_w‹k
);

697 
	`öô_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

699 
	`scheduÀ_dñayed_w‹k_⁄
(
˝u
, &
w‹k
.work, 0);

700 
	`waô_f‹_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

701 
	`de°roy_timî_⁄_°ack
(&
w‹k
.w‹k.
timî
);

703 
CPU_DEAD
:

704 i‡(
hdev
) {

705 
	`‰ì_úq
(
hdev
->
úq
, hdev);

706 
hdev
->
Êags
 &~
HPET_DEV_USED
;

707 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
NULL
;

711  
NOTIFY_OK
;

712 
	}
}

715 
	$h≥t_£tup_msi_úq
(
úq
)

718 
	}
}

719 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

722 
	}
}

724 #ifde‡
CONFIG_HPET


725 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

728 
	}
}

731 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

732 
a˘i⁄
, *
h˝u
)

734  
NOTIFY_OK
;

735 
	}
}

742 
cy˛e_t
 
	$ªad_h≥t
(
˛ocksour˚
 *
cs
)

744  (
cy˛e_t
)
	`h≥t_ªadl
(
HPET_COUNTER
);

745 
	}
}

747 #ifde‡
CONFIG_X86_64


748 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_h≥t
()

750  
	`ªadl
((c⁄° 
__iomem
 *)
	`fix_to_vút
(
VSYSCALL_HPET
) + 0xf0);

751 
	}
}

754 
˛ocksour˚
 
	g˛ocksour˚_h≥t
 = {

755 .
«me
 = "hpet",

756 .
	gøtög
 = 250,

757 .
	gªad
 = 
ªad_h≥t
,

758 .
	gmask
 = 
HPET_MASK
,

759 .
	gshi·
 = 
HPET_SHIFT
,

760 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

761 .
	gªsume
 = 
h≥t_ªsume_cou¡î
,

762 #ifde‡
CONFIG_X86_64


763 .
	gvªad
 = 
vªad_h≥t
,

767 
	$h≥t_˛ocksour˚_ªgi°î
()

769 
u64
 
°¨t
, 
now
;

770 
cy˛e_t
 
t1
;

773 
	`h≥t_ª°¨t_cou¡î
();

776 
t1
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

777 
	`rdts˛l
(
°¨t
);

786 
	`ªp_n›
();

787 
	`rdts˛l
(
now
);

788 } (
now
 - 
°¨t
) < 200000UL);

790 i‡(
t1
 =
	`h≥t_ªadl
(
HPET_COUNTER
)) {

791 
	`¥ötk
(
KERN_WARNING


793  -
ENODEV
;

804 
˛ocksour˚_h≥t
.
mu…
 = 
	`div_sc
(
h≥t_≥riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

806 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_h≥t
);

809 
	}
}

814 
__öô
 
	$h≥t_íabÀ
()

816 
id
;

817 
i
;

819 i‡(!
	`is_h≥t_ˇ∑bÀ
())

822 
	`h≥t_£t_m≠pög
();

827 
h≥t_≥riod
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

842 
i
 = 0; 
	`h≥t_ªadl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

843 i‡(
i
 == 1000) {

844 
	`¥ötk
(
KERN_WARNING


847 
out_noh≥t
;

851 i‡(
h≥t_≥riod
 < 
HPET_MIN_PERIOD
 || h≥t_≥riod > 
HPET_MAX_PERIOD
)

852 
out_noh≥t
;

858 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

859 
	`h≥t_¥öt_c⁄fig
();

861 #ifde‡
CONFIG_HPET_EMULATE_RTC


866 i‡(!(
id
 & 
HPET_ID_NUMBER
))

867 
out_noh≥t
;

870 i‡(
	`h≥t_˛ocksour˚_ªgi°î
())

871 
out_noh≥t
;

873 i‡(
id
 & 
HPET_ID_LEGSUP
) {

874 
	`h≥t_Àgacy_˛ockevít_ªgi°î
();

875 
	`h≥t_msi_ˇ∑bûôy_lookup
(2);

878 
	`h≥t_msi_ˇ∑bûôy_lookup
(0);

881 
out_noh≥t
:

882 
	`h≥t_˛ór_m≠pög
();

883 
h≥t_addªss
 = 0;

885 
	}
}

893 
__öô
 
	$h≥t_œã_öô
()

895 
˝u
;

897 i‡(
boŸ_h≥t_dißbÀ
)

898  -
ENODEV
;

900 i‡(!
h≥t_addªss
) {

901 i‡(!
f‹˚_h≥t_addªss
)

902  -
ENODEV
;

904 
h≥t_addªss
 = 
f‹˚_h≥t_addªss
;

905 
	`h≥t_íabÀ
();

908 i‡(!
h≥t_vút_addªss
)

909  -
ENODEV
;

911 
	`h≥t_ª£rve_∂©f‹m_timîs
(
	`h≥t_ªadl
(
HPET_ID
));

912 
	`h≥t_¥öt_c⁄fig
();

914 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

915 
	`h≥t_˝uhp_nŸify
(
NULL
, 
CPU_ONLINE
, (*)()
˝u
);

919 
	`hŸ˝u_nŸifõr
(
h≥t_˝uhp_nŸify
, -20);

922 
	}
}

923 
fs_öôˇŒ
(
h≥t_œã_öô
);

925 
	$h≥t_dißbÀ
()

927 i‡(
	`is_h≥t_ˇ∑bÀ
()) {

928 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

930 i‡(
h≥t_Àgacy_öt_íabÀd
) {

931 
cfg
 &~
HPET_CFG_LEGACY
;

932 
h≥t_Àgacy_öt_íabÀd
 = 0;

934 
cfg
 &~
HPET_CFG_ENABLE
;

935 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

937 
	}
}

939 #ifde‡
CONFIG_HPET_EMULATE_RTC


955 
	~<löux/mc146818πc.h
>

956 
	~<löux/πc.h
>

957 
	~<asm/πc.h
>

959 
	#DEFAULT_RTC_INT_FREQ
 64

	)

960 
	#DEFAULT_RTC_SHIFT
 6

	)

961 
	#RTC_NUM_INTS
 1

	)

963 
	gh≥t_πc_Êags
;

964 
	gh≥t_¥ev_upd©e_£c
;

965 
πc_time
 
	gh≥t_Æ¨m_time
;

966 
	gh≥t_põ_cou¡
;

967 
u32
 
	gh≥t_t1_cmp
;

968 
	gh≥t_deÁu…_dñè
;

969 
	gh≥t_põ_dñè
;

970 
	gh≥t_põ_limô
;

972 
πc_úq_h™dÀr
 
	gúq_h™dÀr
;

977 
ölöe
 
	$h≥t_˙t_ahód
(
u32
 
c1
, u32 
c2
)

979  (
s32
)(
c2
 - 
c1
) < 0;

980 
	}
}

985 
	$h≥t_ªgi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

987 i‡(!
	`is_h≥t_íabÀd
())

988  -
ENODEV
;

989 i‡(
úq_h™dÀr
)

990  -
EBUSY
;

992 
úq_h™dÀr
 = 
h™dÀr
;

995 
	}
}

996 
EXPORT_SYMBOL_GPL
(
h≥t_ªgi°î_úq_h™dÀr
);

1002 
	$h≥t_uƒegi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1004 i‡(!
	`is_h≥t_íabÀd
())

1007 
úq_h™dÀr
 = 
NULL
;

1008 
h≥t_πc_Êags
 = 0;

1009 
	}
}

1010 
EXPORT_SYMBOL_GPL
(
h≥t_uƒegi°î_úq_h™dÀr
);

1018 
	$h≥t_πc_timî_öô
()

1020 
cfg
, 
˙t
, 
dñè
, 
Êags
;

1022 i‡(!
	`is_h≥t_íabÀd
())

1025 i‡(!
h≥t_deÁu…_dñè
) {

1026 
uöt64_t
 
˛c
;

1028 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1029 
˛c
 >>
h≥t_˛ockevít
.
shi·
 + 
DEFAULT_RTC_SHIFT
;

1030 
h≥t_deÁu…_dñè
 = (Ë
˛c
;

1033 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1034 
dñè
 = 
h≥t_deÁu…_dñè
;

1036 
dñè
 = 
h≥t_põ_dñè
;

1038 
	`loˇl_úq_ßve
(
Êags
);

1040 
˙t
 = 
dñè
 + 
	`h≥t_ªadl
(
HPET_COUNTER
);

1041 
	`h≥t_wrôñ
(
˙t
, 
HPET_T1_CMP
);

1042 
h≥t_t1_cmp
 = 
˙t
;

1044 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1045 
cfg
 &~
HPET_TN_PERIODIC
;

1046 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1047 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1049 
	`loˇl_úq_ª°‹e
(
Êags
);

1052 
	}
}

1053 
EXPORT_SYMBOL_GPL
(
h≥t_πc_timî_öô
);

1060 
	$h≥t_mask_πc_úq_bô
(
bô_mask
)

1062 i‡(!
	`is_h≥t_íabÀd
())

1065 
h≥t_πc_Êags
 &~
bô_mask
;

1067 
	}
}

1068 
EXPORT_SYMBOL_GPL
(
h≥t_mask_πc_úq_bô
);

1070 
	$h≥t_£t_πc_úq_bô
(
bô_mask
)

1072 
ﬁdbôs
 = 
h≥t_πc_Êags
;

1074 i‡(!
	`is_h≥t_íabÀd
())

1077 
h≥t_πc_Êags
 |
bô_mask
;

1079 i‡((
bô_mask
 & 
RTC_UIE
Ë&& !(
ﬁdbôs
 & RTC_UIE))

1080 
h≥t_¥ev_upd©e_£c
 = -1;

1082 i‡(!
ﬁdbôs
)

1083 
	`h≥t_πc_timî_öô
();

1086 
	}
}

1087 
EXPORT_SYMBOL_GPL
(
h≥t_£t_πc_úq_bô
);

1089 
	$h≥t_£t_Æ¨m_time
(
hrs
, 
mö
,

1090 
£c
)

1092 i‡(!
	`is_h≥t_íabÀd
())

1095 
h≥t_Æ¨m_time
.
tm_hour
 = 
hrs
;

1096 
h≥t_Æ¨m_time
.
tm_mö
 = 
mö
;

1097 
h≥t_Æ¨m_time
.
tm_£c
 = 
£c
;

1100 
	}
}

1101 
EXPORT_SYMBOL_GPL
(
h≥t_£t_Æ¨m_time
);

1103 
	$h≥t_£t_≥riodic_‰eq
(
‰eq
)

1105 
uöt64_t
 
˛c
;

1107 i‡(!
	`is_h≥t_íabÀd
())

1110 i‡(
‰eq
 <
DEFAULT_RTC_INT_FREQ
)

1111 
h≥t_põ_limô
 = 
DEFAULT_RTC_INT_FREQ
 / 
‰eq
;

1113 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1114 
	`do_div
(
˛c
, 
‰eq
);

1115 
˛c
 >>
h≥t_˛ockevít
.
shi·
;

1116 
h≥t_põ_dñè
 = (Ë
˛c
;

1119 
	}
}

1120 
EXPORT_SYMBOL_GPL
(
h≥t_£t_≥riodic_‰eq
);

1122 
	$h≥t_πc_dr›≥d_úq
()

1124  
	`is_h≥t_íabÀd
();

1125 
	}
}

1126 
EXPORT_SYMBOL_GPL
(
h≥t_πc_dr›≥d_úq
);

1128 
	$h≥t_πc_timî_ªöô
()

1130 
cfg
, 
dñè
;

1131 
lo°_öts
 = -1;

1133 i‡(
	`u∆ikñy
(!
h≥t_πc_Êags
)) {

1134 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1135 
cfg
 &~
HPET_TN_ENABLE
;

1136 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1140 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1141 
dñè
 = 
h≥t_deÁu…_dñè
;

1143 
dñè
 = 
h≥t_põ_dñè
;

1150 
h≥t_t1_cmp
 +
dñè
;

1151 
	`h≥t_wrôñ
(
h≥t_t1_cmp
, 
HPET_T1_CMP
);

1152 
lo°_öts
++;

1153 } !
	`h≥t_˙t_ahód
(
h≥t_t1_cmp
, 
	`h≥t_ªadl
(
HPET_COUNTER
)));

1155 i‡(
lo°_öts
) {

1156 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
)

1157 
h≥t_põ_cou¡
 +
lo°_öts
;

1158 i‡(
	`¥ötk_øãlimô
())

1159 
	`¥ötk
(
KERN_WARNING
 "hpet1:Üost %dÑtc interrupts\n",

1160 
lo°_öts
);

1162 
	}
}

1164 
úqªtu∫_t
 
	$h≥t_πc_öãºu±
(
úq
, *
dev_id
)

1166 
πc_time
 
cuº_time
;

1167 
πc_öt_Êag
 = 0;

1169 
	`h≥t_πc_timî_ªöô
();

1170 
	`mem£t
(&
cuº_time
, 0, (
πc_time
));

1172 i‡(
h≥t_πc_Êags
 & (
RTC_UIE
 | 
RTC_AIE
))

1173 
	`gë_πc_time
(&
cuº_time
);

1175 i‡(
h≥t_πc_Êags
 & 
RTC_UIE
 &&

1176 
cuº_time
.
tm_£c
 !
h≥t_¥ev_upd©e_£c
) {

1177 i‡(
h≥t_¥ev_upd©e_£c
 >= 0)

1178 
πc_öt_Êag
 = 
RTC_UF
;

1179 
h≥t_¥ev_upd©e_£c
 = 
cuº_time
.
tm_£c
;

1182 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
 &&

1183 ++
h≥t_põ_cou¡
 >
h≥t_põ_limô
) {

1184 
πc_öt_Êag
 |
RTC_PF
;

1185 
h≥t_põ_cou¡
 = 0;

1188 i‡(
h≥t_πc_Êags
 & 
RTC_AIE
 &&

1189 (
cuº_time
.
tm_£c
 =
h≥t_Æ¨m_time
.tm_sec) &&

1190 (
cuº_time
.
tm_mö
 =
h≥t_Æ¨m_time
.tm_min) &&

1191 (
cuº_time
.
tm_hour
 =
h≥t_Æ¨m_time
.tm_hour))

1192 
πc_öt_Êag
 |
RTC_AF
;

1194 i‡(
πc_öt_Êag
) {

1195 
πc_öt_Êag
 |(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1196 i‡(
úq_h™dÀr
)

1197 
	`úq_h™dÀr
(
πc_öt_Êag
, 
dev_id
);

1199  
IRQ_HANDLED
;

1200 
	}
}

1201 
EXPORT_SYMBOL_GPL
(
h≥t_πc_öãºu±
);

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/ªg£t.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/sigc⁄ãxt.h
>

13 
	~<asm/¥o˚ss‹.h
>

14 
	~<asm/m©h_emu.h
>

15 
	~<asm/uac˚ss.h
>

16 
	~<asm/±ø˚.h
>

17 
	~<asm/i387.h
>

18 
	~<asm/u£r.h
>

20 #ifde‡
CONFIG_X86_64


21 
	~<asm/sigc⁄ãxt32.h
>

22 
	~<asm/u£r32.h
>

24 
	#ßve_i387_x°©e_ü32
 
ßve_i387_x°©e


	)

25 
	#ª°‹e_i387_x°©e_ü32
 
ª°‹e_i387_x°©e


	)

26 
	#_Â°©e_ü32
 
_Â°©e


	)

27 
	#_x°©e_ü32
 
_x°©e


	)

28 
	#sig_x°©e_ü32_size
 
sig_x°©e_size


	)

29 
	#fx_sw_ª£rved_ü32
 
fx_sw_ª£rved


	)

30 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

31 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

34 #ifde‡
CONFIG_MATH_EMULATION


35 
	#HAVE_HWFP
 (
boŸ_˝u_d©a
.
h¨d_m©h
)

	)

37 
	#HAVE_HWFP
 1

	)

40 
mxc§_„©uª_mask
 
	g__ªad_mo°ly
 = 0xffffffffu;

41 
	gx°©e_size
;

42 
	gsig_x°©e_ü32_size
 = (
_Â°©e_ü32
);

43 
i387_fxßve_°ru˘
 
fx_s¸©ch
 
	g__˝uöôd©a
;

45 
__˝uöô
 
	$mxc§_„©uª_mask_öô
()

47 
mask
 = 0;

49 
	`˛ts
();

50 i‡(
˝u_has_fx§
) {

51 
	`mem£t
(&
fx_s¸©ch
, 0, (
i387_fxßve_°ru˘
));

52 
asm
 vﬁ©ûe("fxßvê%0" : : "m" (
fx_s¸©ch
));

53 
mask
 = 
fx_s¸©ch
.
mxc§_mask
;

54 i‡(
mask
 == 0)

55 
mask
 = 0x0000ffbf;

57 
mxc§_„©uª_mask
 &
mask
;

58 
	`°ts
();

59 
	}
}

61 
__˝uöô
 
	$öô_thªad_x°©e
()

63 i‡(!
HAVE_HWFP
) {

64 
x°©e_size
 = (
i387_so·_°ru˘
);

68 i‡(
˝u_has_xßve
) {

69 
	`xßve_˙txt_öô
();

73 i‡(
˝u_has_fx§
)

74 
x°©e_size
 = (
i387_fxßve_°ru˘
);

75 #ifde‡
CONFIG_X86_32


77 
x°©e_size
 = (
i387_fßve_°ru˘
);

79 
	}
}

81 #ifde‡
CONFIG_X86_64


86 
__˝uöô
 
	$Âu_öô
()

88 
ﬁd¸0
 = 
	`ªad_¸0
();

90 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

91 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

93 
	`wrôe_¸0
(
ﬁd¸0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

98 i‡(!
	`smp_¥o˚ss‹_id
())

99 
	`öô_thªad_x°©e
();

100 
	`xßve_öô
();

102 
	`mxc§_„©uª_mask_öô
();

104 i‡(
˝u_has_xßve
)

105 
	`cuºít_thªad_öfo
()->
°©us
 = 
TS_XSAVE
;

107 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

108 
	`˛ór_u£d_m©h
();

109 
	}
}

118 
	$öô_Âu
(
èsk_°ru˘
 *
tsk
)

120 i‡(
	`tsk_u£d_m©h
(
tsk
)) {

121 i‡(
HAVE_HWFP
 && 
tsk
 =
cuºít
)

122 
	`u∆azy_Âu
(
tsk
);

129 i‡(!
tsk
->
thªad
.
x°©e
) {

130 
tsk
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

131 
GFP_KERNEL
);

132 i‡(!
tsk
->
thªad
.
x°©e
)

133  -
ENOMEM
;

136 #ifde‡
CONFIG_X86_32


137 i‡(!
HAVE_HWFP
) {

138 
	`mem£t
(
tsk
->
thªad
.
x°©e
, 0, 
x°©e_size
);

139 
	`föô_èsk
(
tsk
);

140 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

145 i‡(
˝u_has_fx§
) {

146 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

148 
	`mem£t
(
fx
, 0, 
x°©e_size
);

149 
fx
->
cwd
 = 0x37f;

150 i‡(
˝u_has_xmm
)

151 
fx
->
mxc§
 = 
MXCSR_DEFAULT
;

153 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

154 
	`mem£t
(
Â
, 0, 
x°©e_size
);

155 
Â
->
cwd
 = 0xffff037fu;

156 
Â
->
swd
 = 0xffff0000u;

157 
Â
->
twd
 = 0xffffffffu;

158 
Â
->
fos
 = 0xffff0000u;

163 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

165 
	}
}

167 
	$Âªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

169  
	`tsk_u£d_m©h
(
èrgë
Ë? 
ªg£t
->
n
 : 0;

170 
	}
}

172 
	$xÂªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

174  (
˝u_has_fx§
 && 
	`tsk_u£d_m©h
(
èrgë
)Ë? 
ªg£t
->
n
 : 0;

175 
	}
}

177 
	$xÂªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

178 
pos
, 
cou¡
,

179 *
kbuf
, 
__u£r
 *
ubuf
)

181 
ªt
;

183 i‡(!
˝u_has_fx§
)

184  -
ENODEV
;

186 
ªt
 = 
	`öô_Âu
(
èrgë
);

187 i‡(
ªt
)

188  
ªt
;

190  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

191 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

192 
	}
}

194 
	$xÂªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
ªt
;

200 i‡(!
˝u_has_fx§
)

201  -
ENODEV
;

203 
ªt
 = 
	`öô_Âu
(
èrgë
);

204 i‡(
ªt
)

205  
ªt
;

207 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

209 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

210 &
èrgë
->
thªad
.
x°©e
->
fxßve
, 0, -1);

215 
èrgë
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

221 i‡(
˝u_has_xßve
)

222 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

224  
ªt
;

225 
	}
}

227 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


233 
ölöe
 
	$twd_i387_to_fx§
(
twd
)

235 
tmp
;

238 
tmp
 = ~
twd
;

239 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

241 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

242 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

243 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

245  
tmp
;

246 
	}
}

248 
	#FPREG_ADDR
(
f
, 
n
Ë((*)&(f)->
°_•a˚
 + (nË* 16);

	)

249 
	#FP_EXP_TAG_VALID
 0

	)

250 
	#FP_EXP_TAG_ZERO
 1

	)

251 
	#FP_EXP_TAG_SPECIAL
 2

	)

252 
	#FP_EXP_TAG_EMPTY
 3

	)

254 
ölöe
 
u32
 
	$twd_fx§_to_i387
(
i387_fxßve_°ru˘
 *
fxßve
)

256 
_Âxªg
 *
°
;

257 
u32
 
tos
 = (
fxßve
->
swd
 >> 11) & 7;

258 
u32
 
twd
 = (Ë
fxßve
->twd;

259 
u32
 
èg
;

260 
u32
 
ªt
 = 0xffff0000u;

261 
i
;

263 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

264 i‡(
twd
 & 0x1) {

265 
°
 = 
	`FPREG_ADDR
(
fxßve
, (
i
 - 
tos
) & 7);

267 
°
->
exp⁄ít
 & 0x7fff) {

269 
èg
 = 
FP_EXP_TAG_SPECIAL
;

272 i‡(!
°
->
signifiˇnd
[0] &&

273 !
°
->
signifiˇnd
[1] &&

274 !
°
->
signifiˇnd
[2] &&

275 !
°
->
signifiˇnd
[3])

276 
èg
 = 
FP_EXP_TAG_ZERO
;

278 
èg
 = 
FP_EXP_TAG_SPECIAL
;

281 i‡(
°
->
signifiˇnd
[3] & 0x8000)

282 
èg
 = 
FP_EXP_TAG_VALID
;

284 
èg
 = 
FP_EXP_TAG_SPECIAL
;

288 
èg
 = 
FP_EXP_TAG_EMPTY
;

290 
ªt
 |
èg
 << (2 * 
i
);

292  
ªt
;

293 
	}
}

300 
	$c⁄vît_‰om_fx§
(
u£r_i387_ü32_°ru˘
 *
ív
, 
èsk_°ru˘
 *
tsk
)

302 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

303 
_Âªg
 *
to
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

304 
_Âxªg
 *
‰om
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

305 
i
;

307 
ív
->
cwd
 = 
fxßve
->cwd | 0xffff0000u;

308 
ív
->
swd
 = 
fxßve
->swd | 0xffff0000u;

309 
ív
->
twd
 = 
	`twd_fx§_to_i387
(
fxßve
);

311 #ifde‡
CONFIG_X86_64


312 
ív
->
fù
 = 
fxßve
->
rù
;

313 
ív
->
foo
 = 
fxßve
->
rdp
;

314 i‡(
tsk
 =
cuºít
) {

319 
	`asm
("mov %%ds, %[fos]" : [
fos
] "Ù" (
ív
->fos));

320 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "Ù" (
ív
->fcs));

322 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

324 
ív
->
fos
 = 0xffff0000 | 
tsk
->
thªad
.
ds
;

325 
ív
->
fcs
 = 
ªgs
->
cs
;

328 
ív
->
fù
 = 
fxßve
->fip;

329 
ív
->
fcs
 = (
u16
Ë
fxßve
->fc†| ((
u32
Ëfxßve->
f›
 << 16);

330 
ív
->
foo
 = 
fxßve
->foo;

331 
ív
->
fos
 = 
fxßve
->fos;

334 
i
 = 0; i < 8; ++i)

335 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (to[0]));

336 
	}
}

338 
	$c⁄vît_to_fx§
(
èsk_°ru˘
 *
tsk
,

339 c⁄° 
u£r_i387_ü32_°ru˘
 *
ív
)

342 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
x°©e
->fxsave;

343 
_Âªg
 *
‰om
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

344 
_Âxªg
 *
to
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

345 
i
;

347 
fxßve
->
cwd
 = 
ív
->cwd;

348 
fxßve
->
swd
 = 
ív
->swd;

349 
fxßve
->
twd
 = 
	`twd_i387_to_fx§
(
ív
->twd);

350 
fxßve
->
f›
 = (
u16
Ë((
u32
Ë
ív
->
fcs
 >> 16);

351 #ifde‡
CONFIG_X86_64


352 
fxßve
->
rù
 = 
ív
->
fù
;

353 
fxßve
->
rdp
 = 
ív
->
foo
;

356 
fxßve
->
fù
 = 
ív
->fip;

357 
fxßve
->
fcs
 = (
ív
->fcs & 0xffff);

358 
fxßve
->
foo
 = 
ív
->foo;

359 
fxßve
->
fos
 = 
ív
->fos;

362 
i
 = 0; i < 8; ++i)

363 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (from[0]));

364 
	}
}

366 
	$Âªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

367 
pos
, 
cou¡
,

368 *
kbuf
, 
__u£r
 *
ubuf
)

370 
u£r_i387_ü32_°ru˘
 
ív
;

371 
ªt
;

373 
ªt
 = 
	`öô_Âu
(
èrgë
);

374 i‡(
ªt
)

375  
ªt
;

377 i‡(!
HAVE_HWFP
)

378  
	`Âªgs_so·_gë
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

380 i‡(!
˝u_has_fx§
) {

381  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

382 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0,

386 i‡(
kbuf
 && 
pos
 =0 && 
cou¡
 =(
ív
)) {

387 
	`c⁄vît_‰om_fx§
(
kbuf
, 
èrgë
);

391 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

393  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

394 
	}
}

396 
	$Âªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

397 
pos
, 
cou¡
,

398 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

400 
u£r_i387_ü32_°ru˘
 
ív
;

401 
ªt
;

403 
ªt
 = 
	`öô_Âu
(
èrgë
);

404 i‡(
ªt
)

405  
ªt
;

407 
	`£t_°›≥d_chûd_u£d_m©h
(
èrgë
);

409 i‡(!
HAVE_HWFP
)

410  
	`Âªgs_so·_£t
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

412 i‡(!
˝u_has_fx§
) {

413  
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

414 &
èrgë
->
thªad
.
x°©e
->
fßve
, 0, -1);

417 i‡(
pos
 > 0 || 
cou¡
 < (
ív
))

418 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

420 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

421 i‡(!
ªt
)

422 
	`c⁄vît_to_fx§
(
èrgë
, &
ív
);

428 i‡(
˝u_has_xßve
)

429 
èrgë
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FP
;

430  
ªt
;

431 
	}
}

437 
ölöe
 
	$ßve_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

439 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

440 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
x°©e
->
fßve
;

442 
Â
->
°©us
 = fp->
swd
;

443 i‡(
	`__c›y_to_u£r
(
buf
, 
Â
, (
i387_fßve_°ru˘
)))

446 
	}
}

448 
	$ßve_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

450 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

451 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
x°©e
->
fxßve
;

452 
u£r_i387_ü32_°ru˘
 
ív
;

453 
îr
 = 0;

455 
	`c⁄vît_‰om_fx§
(&
ív
, 
tsk
);

456 i‡(
	`__c›y_to_u£r
(
buf
, &
ív
, (env)))

459 
îr
 |
	`__put_u£r
(
fx
->
swd
, &
buf
->
°©us
);

460 
îr
 |
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

461 i‡(
îr
)

464 i‡(
	`__c›y_to_u£r
(&
buf
->
_fx§_ív
[0], 
fx
, 
x°©e_size
))

467 
	}
}

469 
	$ßve_i387_xßve
(
__u£r
 *
buf
)

471 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

472 
_Â°©e_ü32
 
__u£r
 *
fx
 = 
buf
;

473 
îr
 = 0;

486 
tsk
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

488 i‡(
	`ßve_i387_fxßve
(
fx
) < 0)

491 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved_ü32
,

492 (
_Âx_sw_byãs
));

493 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

494 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_ü32_size


495 - 
FP_XSTATE_MAGIC2_SIZE
));

496 i‡(
îr
)

500 
	}
}

502 
	$ßve_i387_x°©e_ü32
(
__u£r
 *
buf
)

504 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

505 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

507 i‡(!
	`u£d_m©h
())

510 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_ü32_size
))

511  -
EACCES
;

516 
	`˛ór_u£d_m©h
();

518 i‡(!
HAVE_HWFP
) {

519  
	`Âªgs_so·_gë
(
cuºít
, 
NULL
,

520 0, (
u£r_i387_ü32_°ru˘
),

521 
NULL
, 
Â
) ? -1 : 1;

524 
	`u∆azy_Âu
(
tsk
);

526 i‡(
˝u_has_xßve
)

527  
	`ßve_i387_xßve
(
Â
);

528 i‡(
˝u_has_fx§
)

529  
	`ßve_i387_fxßve
(
Â
);

531  
	`ßve_i387_fßve
(
Â
);

532 
	}
}

534 
ölöe
 
	$ª°‹e_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

536 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

538  
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fßve
, 
buf
,

539 (
i387_fßve_°ru˘
));

540 
	}
}

542 
	$ª°‹e_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
,

543 
size
)

545 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

546 
u£r_i387_ü32_°ru˘
 
ív
;

547 
îr
;

549 
îr
 = 
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
x°©e
->
fxßve
, &
buf
->
_fx§_ív
[0],

550 
size
);

552 
tsk
->
thªad
.
x°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

553 i‡(
îr
 || 
	`__c›y_‰om_u£r
(&
ív
, 
buf
, (env)))

555 
	`c⁄vît_to_fx§
(
tsk
, &
ív
);

558 
	}
}

560 
	$ª°‹e_i387_xßve
(
__u£r
 *
buf
)

562 
_Âx_sw_byãs
 
fx_sw_u£r
;

563 
_Â°©e_ü32
 
__u£r
 *
fx_u£r
 =

564 ((
_Â°©e_ü32
 
__u£r
 *Ë
buf
);

565 
i387_fxßve_°ru˘
 
__u£r
 *
fx
 =

566 (
i387_fxßve_°ru˘
 
__u£r
 *Ë&
fx_u£r
->
_fx§_ív
[0];

567 
xßve_hdr_°ru˘
 *
xßve_hdr
 =

568 &
cuºít
->
thªad
.
x°©e
->
xßve
.
xßve_hdr
;

569 
u64
 
mask
;

570 
îr
;

572 i‡(
	`check_f‹_x°©e
(
fx
, 
buf
, &
fx_sw_u£r
))

573 
fx_⁄ly
;

575 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

577 
îr
 = 
	`ª°‹e_i387_fxßve
(
buf
, 
fx_sw_u£r
.
x°©e_size
);

579 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

583 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

589 
mask
 = ~(
p˙txt_mask
 & ~mask);

590 
xßve_hdr
->
x°©e_bv
 &
mask
;

592  
îr
;

593 
fx_⁄ly
:

599 
xßve_hdr
->
x°©e_bv
 = 
XSTATE_FPSSE
;

600  
	`ª°‹e_i387_fxßve
(
buf
, (
i387_fxßve_°ru˘
));

601 
	}
}

603 
	$ª°‹e_i387_x°©e_ü32
(
__u£r
 *
buf
)

605 
îr
;

606 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

607 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

609 i‡(
HAVE_HWFP
)

610 
	`˛ór_Âu
(
tsk
);

612 i‡(!
buf
) {

613 i‡(
	`u£d_m©h
()) {

614 
	`˛ór_Âu
(
tsk
);

615 
	`˛ór_u£d_m©h
();

620 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_ü32_size
))

621  -
EACCES
;

623 i‡(!
	`u£d_m©h
()) {

624 
îr
 = 
	`öô_Âu
(
tsk
);

625 i‡(
îr
)

626  
îr
;

629 i‡(
HAVE_HWFP
) {

630 i‡(
˝u_has_xßve
)

631 
îr
 = 
	`ª°‹e_i387_xßve
(
buf
);

632 i‡(
˝u_has_fx§
)

633 
îr
 = 
	`ª°‹e_i387_fxßve
(
Â
, (

634 
i387_fxßve_°ru˘
));

636 
îr
 = 
	`ª°‹e_i387_fßve
(
Â
);

638 
îr
 = 
	`Âªgs_so·_£t
(
cuºít
, 
NULL
,

639 0, (
u£r_i387_ü32_°ru˘
),

640 
NULL
, 
Â
) != 0;

642 
	`£t_u£d_m©h
();

644  
îr
;

645 
	}
}

654 
	$dump_Âu
(
±_ªgs
 *
ªgs
, 
u£r_i387_°ru˘
 *
Âu
)

656 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

657 
ÂvÆid
;

659 
ÂvÆid
 = !!
	`u£d_m©h
();

660 i‡(
ÂvÆid
)

661 
ÂvÆid
 = !
	`Âªgs_gë
(
tsk
, 
NULL
,

662 0, (
u£r_i387_ü32_°ru˘
),

663 
Âu
, 
NULL
);

665  
ÂvÆid
;

666 
	}
}

667 
EXPORT_SYMBOL
(
dump_Âu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<löux/öô.h
>

13 
	~<löux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_ªsume
(
sys_devi˚
 *
dev
)

26 
Êags
;

27 
i
;

29 
Êags
 = 
	`˛aim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_cou¡
(
i
, 1);

41 
	`íabÀ_dma
(4);

43 
	`ªÀa£_dma_lock
(
Êags
);

46 
	}
}

48 
	$i8237A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

51 
	}
}

53 
sysdev_˛ass
 
	gi8237_sysdev_˛ass
 = {

54 .
«me
 = "i8237",

55 .
	gsu•íd
 = 
i8237A_su•íd
,

56 .
	gªsume
 = 
i8237A_ªsume
,

59 
sys_devi˚
 
	gdevi˚_i8237A
 = {

60 .
id
 = 0,

61 .
	g˛s
 = &
i8237_sysdev_˛ass
,

64 
__öô
 
	$i8237A_öô_sysfs
()

66 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8237_sysdev_˛ass
);

67 i‡(!
îr‹
)

68 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8237A
);

69  
îr‹
;

70 
	}
}

71 
devi˚_öôˇŒ
(
i8237A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<löux/˛ockchùs.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/jiffõs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/io.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

17 
	~<asm/smp.h
>

19 
DEFINE_SPINLOCK
(
i8253_lock
);

20 
EXPORT_SYMBOL
(
i8253_lock
);

26 
˛ock_evít_devi˚
 *
	gglobÆ_˛ock_evít
;

33 
	$öô_pô_timî
(
˛ock_evít_mode
 
mode
,

34 
˛ock_evít_devi˚
 *
evt
)

36 
	`•ö_lock
(&
i8253_lock
);

38 
mode
) {

39 
CLOCK_EVT_MODE_PERIODIC
:

41 
	`outb_pô
(0x34, 
PIT_MODE
);

42 
	`outb_pô
(
LATCH
 & 0xf‡, 
PIT_CH0
);

43 
	`outb_pô
(
LATCH
 >> 8 , 
PIT_CH0
);

46 
CLOCK_EVT_MODE_SHUTDOWN
:

47 
CLOCK_EVT_MODE_UNUSED
:

48 i‡(
evt
->
mode
 =
CLOCK_EVT_MODE_PERIODIC
 ||

49 
evt
->
mode
 =
CLOCK_EVT_MODE_ONESHOT
) {

50 
	`outb_pô
(0x30, 
PIT_MODE
);

51 
	`outb_pô
(0, 
PIT_CH0
);

52 
	`outb_pô
(0, 
PIT_CH0
);

56 
CLOCK_EVT_MODE_ONESHOT
:

58 
	`outb_pô
(0x38, 
PIT_MODE
);

61 
CLOCK_EVT_MODE_RESUME
:

65 
	`•ö_u∆ock
(&
i8253_lock
);

66 
	}
}

73 
	$pô_√xt_evít
(
dñè
, 
˛ock_evít_devi˚
 *
evt
)

75 
	`•ö_lock
(&
i8253_lock
);

76 
	`outb_pô
(
dñè
 & 0xf‡, 
PIT_CH0
);

77 
	`outb_pô
(
dñè
 >> 8 , 
PIT_CH0
);

78 
	`•ö_u∆ock
(&
i8253_lock
);

81 
	}
}

91 
˛ock_evít_devi˚
 
	gpô_˚
 = {

92 .
«me
 = "pit",

93 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

94 .
	g£t_mode
 = 
öô_pô_timî
,

95 .
	g£t_√xt_evít
 = 
pô_√xt_evít
,

96 .
	gshi·
 = 32,

97 .
	gúq
 = 0,

104 
__öô
 
	$£tup_pô_timî
()

110 
pô_˚
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

111 
pô_˚
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,Öô_˚.
shi·
);

112 
pô_˚
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFF, &pit_ce);

113 
pô_˚
.
mö_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0xF, &pit_ce);

115 
	`˛ockevíts_ªgi°î_devi˚
(&
pô_˚
);

116 
globÆ_˛ock_evít
 = &
pô_˚
;

117 
	}
}

119 #i‚de‡
CONFIG_X86_64


125 
cy˛e_t
 
	$pô_ªad
(
˛ocksour˚
 *
cs
)

127 
ﬁd_cou¡
;

128 
u32
 
ﬁd_jifs
;

129 
Êags
;

130 
cou¡
;

131 
u32
 
jifs
;

133 
	`•ö_lock_úqßve
(&
i8253_lock
, 
Êags
);

147 
jifs
 = 
jiffõs
;

148 
	`outb_pô
(0x00, 
PIT_MODE
);

149 
cou¡
 = 
	`öb_pô
(
PIT_CH0
);

150 
cou¡
 |
	`öb_pô
(
PIT_CH0
) << 8;

153 i‡(
cou¡
 > 
LATCH
) {

154 
	`outb_pô
(0x34, 
PIT_MODE
);

155 
	`outb_pô
(
LATCH
 & 0xff, 
PIT_CH0
);

156 
	`outb_pô
(
LATCH
 >> 8, 
PIT_CH0
);

157 
cou¡
 = 
LATCH
 - 1;

173 i‡(
cou¡
 > 
ﬁd_cou¡
 && 
jifs
 =
ﬁd_jifs
)

174 
cou¡
 = 
ﬁd_cou¡
;

176 
ﬁd_cou¡
 = 
cou¡
;

177 
ﬁd_jifs
 = 
jifs
;

179 
	`•ö_u∆ock_úqª°‹e
(&
i8253_lock
, 
Êags
);

181 
cou¡
 = (
LATCH
 - 1) - count;

183  (
cy˛e_t
)(
jifs
 * 
LATCH
Ë+ 
cou¡
;

184 
	}
}

186 
˛ocksour˚
 
	gpô_cs
 = {

187 .
«me
 = "pit",

188 .
	gøtög
 = 110,

189 .
	gªad
 = 
pô_ªad
,

190 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

191 .
	gmu…
 = 0,

192 .
	gshi·
 = 20,

195 
__öô
 
	$öô_pô_˛ocksour˚
()

204 i‡(
	`num_possibÀ_˝us
(Ë> 1 || 
	`is_h≥t_íabÀd
() ||

205 
pô_˚
.
mode
 !
CLOCK_EVT_MODE_PERIODIC
)

208 
pô_cs
.
mu…
 = 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
,Öô_cs.
shi·
);

210  
	`˛ocksour˚_ªgi°î
(&
pô_cs
);

211 
	}
}

212 
¨ch_öôˇŒ
(
öô_pô_˛ocksour˚
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/sysdev.h
>

13 
	~<löux/bô›s.h
>

14 
	~<löux/a˝i.h
>

15 
	~<löux/io.h
>

16 
	~<löux/dñay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/timî.h
>

21 
	~<asm/hw_úq.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/i8259.h
>

34 
	gi8259A_auto_eoi
;

35 
DEFINE_SPINLOCK
(
i8259A_lock
);

36 
mask_™d_ack_8259A
();

38 
úq_chù
 
	gi8259A_chù
 = {

39 .
«me
 = "XT-PIC",

40 .
	gmask
 = 
dißbÀ_8259A_úq
,

41 .
	gdißbÀ
 = 
dißbÀ_8259A_úq
,

42 .
	gunmask
 = 
íabÀ_8259A_úq
,

43 .
	gmask_ack
 = 
mask_™d_ack_8259A
,

53 
	gˇched_úq_mask
 = 0xffff;

64 
	gio_≠ic_úqs
;

66 
	$dißbÀ_8259A_úq
(
úq
)

68 
mask
 = 1 << 
úq
;

69 
Êags
;

71 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

72 
ˇched_úq_mask
 |
mask
;

73 i‡(
úq
 & 8)

74 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

76 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

77 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

78 
	}
}

80 
	$íabÀ_8259A_úq
(
úq
)

82 
mask
 = ~(1 << 
úq
);

83 
Êags
;

85 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

86 
ˇched_úq_mask
 &
mask
;

87 i‡(
úq
 & 8)

88 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

90 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

91 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

92 
	}
}

94 
	$i8259A_úq_≥ndög
(
úq
)

96 
mask
 = 1<<
úq
;

97 
Êags
;

98 
ªt
;

100 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

101 i‡(
úq
 < 8)

102 
ªt
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
mask
;

104 
ªt
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
mask
 >> 8);

105 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

107  
ªt
;

108 
	}
}

110 
	$make_8259A_úq
(
úq
)

112 
	`dißbÀ_úq_nosync
(
úq
);

113 
io_≠ic_úqs
 &~(1<<
úq
);

114 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
i8259A_chù
, 
h™dÀ_Àvñ_úq
,

116 
	`íabÀ_úq
(
úq
);

117 
	}
}

125 
ölöe
 
	$i8259A_úq_ªÆ
(
úq
)

127 
vÆue
;

128 
úqmask
 = 1<<
úq
;

130 i‡(
úq
 < 8) {

131 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

132 
vÆue
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
úqmask
;

133 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

134  
vÆue
;

136 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

137 
vÆue
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
úqmask
 >> 8);

138 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

139  
vÆue
;

140 
	}
}

148 
	$mask_™d_ack_8259A
(
úq
)

150 
úqmask
 = 1 << 
úq
;

151 
Êags
;

153 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

169 i‡(
ˇched_úq_mask
 & 
úqmask
)

170 
•urious_8259A_úq
;

171 
ˇched_úq_mask
 |
úqmask
;

173 
h™dÀ_ªÆ_úq
:

174 i‡(
úq
 & 8) {

175 
	`öb
(
PIC_SLAVE_IMR
);

176 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

178 
	`outb
(0x60+(
úq
&7), 
PIC_SLAVE_CMD
);

180 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

182 
	`öb
(
PIC_MASTER_IMR
);

183 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

184 
	`outb
(0x60+
úq
, 
PIC_MASTER_CMD
);

186 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

189 
•urious_8259A_úq
:

193 i‡(
	`i8259A_úq_ªÆ
(
úq
))

198 
h™dÀ_ªÆ_úq
;

201 
•urious_úq_mask
;

206 i‡(!(
•urious_úq_mask
 & 
úqmask
)) {

207 
	`¥ötk
(
KERN_DEBUG


208 "•uriou†8259A i¡îru±: IRQ%d.\n", 
úq
);

209 
•urious_úq_mask
 |
úqmask
;

211 
	`©omic_öc
(&
úq_îr_cou¡
);

217 
h™dÀ_ªÆ_úq
;

219 
	}
}

221 
	gúq_åiggî
[2];

225 
	$ª°‹e_ELCR
(*
åiggî
)

227 
	`outb
(
åiggî
[0], 0x4d0);

228 
	`outb
(
åiggî
[1], 0x4d1);

229 
	}
}

231 
	$ßve_ELCR
(*
åiggî
)

234 
åiggî
[0] = 
	`öb
(0x4d0) & 0xF8;

235 
åiggî
[1] = 
	`öb
(0x4d1) & 0xDE;

236 
	}
}

238 
	$i8259A_ªsume
(
sys_devi˚
 *
dev
)

240 
	`öô_8259A
(
i8259A_auto_eoi
);

241 
	`ª°‹e_ELCR
(
úq_åiggî
);

243 
	}
}

245 
	$i8259A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

247 
	`ßve_ELCR
(
úq_åiggî
);

249 
	}
}

251 
	$i8259A_shutdown
(
sys_devi˚
 *
dev
)

257 
	`outb
(0xff, 
PIC_MASTER_IMR
);

258 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

260 
	}
}

262 
sysdev_˛ass
 
	gi8259_sysdev_˛ass
 = {

263 .
«me
 = "i8259",

264 .
	gsu•íd
 = 
i8259A_su•íd
,

265 .
	gªsume
 = 
i8259A_ªsume
,

266 .
	gshutdown
 = 
i8259A_shutdown
,

269 
sys_devi˚
 
	gdevi˚_i8259A
 = {

270 .
id
 = 0,

271 .
	g˛s
 = &
i8259_sysdev_˛ass
,

274 
__öô
 
	$i8259A_öô_sysfs
()

276 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8259_sysdev_˛ass
);

277 i‡(!
îr‹
)

278 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8259A
);

279  
îr‹
;

280 
	}
}

282 
devi˚_öôˇŒ
(
i8259A_öô_sysfs
);

284 
	$mask_8259A
()

286 
Êags
;

288 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

290 
	`outb
(0xff, 
PIC_MASTER_IMR
);

291 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

293 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

294 
	}
}

296 
	$unmask_8259A
()

298 
Êags
;

300 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

302 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

303 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

305 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

306 
	}
}

308 
	$öô_8259A
(
auto_eoi
)

310 
Êags
;

312 
i8259A_auto_eoi
 = 
auto_eoi
;

314 
	`•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

316 
	`outb
(0xff, 
PIC_MASTER_IMR
);

317 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

322 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

326 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

329 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

331 i‡(
auto_eoi
)

332 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

334 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

336 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

339 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

341 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

343 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

345 i‡(
auto_eoi
)

350 
i8259A_chù
.
mask_ack
 = 
dißbÀ_8259A_úq
;

352 
i8259A_chù
.
mask_ack
 = 
mask_™d_ack_8259A
;

354 
	`udñay
(100);

356 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

357 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

359 
	`•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

9 
	~<asm/uac˚ss.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/desc.h
>

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

23 
thªad_uni⁄
 
öô_thªad_uni⁄
 
	g__öô_èsk_d©a
 =

24 { 
INIT_THREAD_INFO
(
öô_èsk
) };

31 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

32 
EXPORT_SYMBOL
(
öô_èsk
);

41 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_°ru˘
, 
öô_tss
Ë
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/io.h
>

15 
io_dñay_ty≥
 
	g__ªad_mo°ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__öôd©a
 
	gio_dñay_ovîride
;

22 
	$«tive_io_dñay
()

24 
io_dñay_ty≥
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`udñay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
«tive_io_dñay
);

47 
__öô
 
	$dmi_io_dñay_0xed_p‹t
(c⁄° 
dmi_sy°em_id
 *
id
)

49 i‡(
io_dñay_ty≥
 =
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`¥_nŸi˚
("%s: usög 0xed I/O dñayÖ‹t\n", 
id
->
idít
);

51 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy°em_id
 
__öôd©a
 
	gio_dñay_0xed_p‹t_dmi_èbÀ
[] = {

63 .
ˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

64 .
	gidít
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

72 .
	gidít
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

80 .
	gidít
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

88 .
	gidít
 = "HP PavilionÅx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

96 .
	gidít
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__öô
 
	$io_dñay_öô
()

107 i‡(!
io_dñay_ovîride
)

108 
	`dmi_check_sy°em
(
io_dñay_0xed_p‹t_dmi_èbÀ
);

109 
	}
}

111 
__öô
 
	$io_dñay_∑øm
(*
s
)

113 i‡(!
s
)

114  -
EINVAL
;

116 i‡(!
	`°rcmp
(
s
, "0x80"))

117 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 i‡(!
	`°rcmp
(
s
, "0xed"))

119 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 i‡(!
	`°rcmp
(
s
, "udelay"))

121 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 i‡(!
	`°rcmp
(
s
, "none"))

123 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_dñay_ovîride
 = 1;

129 
	}
}

131 
óæy_∑øm
("io_dñay", 
io_dñay_∑øm
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<löux/sched.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/ˇ∑bûôy.h
>

9 
	~<löux/î∫o.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/i›‹t.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/°ddef.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/thªad_öfo.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<asm/sysˇŒs.h
>

20 
	$£t_bôm≠
(*
bôm≠
, 
ba£
,

21 
exã¡
, 
√w_vÆue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
exã¡
; i++) {

26 i‡(
√w_vÆue
)

27 
	`__£t_bô
(
i
, 
bôm≠
);

29 
	`__˛ór_bô
(
i
, 
bôm≠
);

31 
	}
}

36 
asmlökage
 
	$sys_i›îm
(
‰om
, 
num
, 
tu∫_⁄
)

38 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

39 
tss_°ru˘
 *
tss
;

40 
i
, 
max_l⁄g
, 
byãs
, 
byãs_upd©ed
;

42 i‡((
‰om
 + 
num
 <‰omË|| (‰om +Çum > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 i‡(
tu∫_⁄
 && !
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 i‡(!
t
->
io_bôm≠_±r
) {

53 *
bôm≠
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 i‡(!
bôm≠
)

56  -
ENOMEM
;

58 
	`mem£t
(
bôm≠
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_bôm≠_±r
 = 
bôm≠
;

60 
	`£t_thªad_Êag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

72 
	`£t_bôm≠
(
t
->
io_bôm≠_±r
, 
‰om
, 
num
, !
tu∫_⁄
);

78 
max_l⁄g
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 i‡(
t
->
io_bôm≠_±r
[
i
] != ~0UL)

81 
max_l⁄g
 = 
i
;

83 
byãs
 = (
max_l⁄g
 + 1) * ();

84 
byãs_upd©ed
 = 
	`max
(
byãs
, 
t
->
io_bôm≠_max
);

86 
t
->
io_bôm≠_max
 = 
byãs
;

89 
	`mem˝y
(
tss
->
io_bôm≠
, 
t
->
io_bôm≠_±r
, 
byãs_upd©ed
);

91 
	`put_˝u
();

94 
	}
}

106 
	$do_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

108 
ﬁd
 = (
ªgs
->
Êags
 >> 12) & 3;

110 i‡(
Àvñ
 > 3)

111  -
EINVAL
;

113 i‡(
Àvñ
 > 
ﬁd
) {

114 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

115  -
EPERM
;

117 
ªgs
->
Êags
 = (ªgs->Êag†& ~
X86_EFLAGS_IOPL
Ë| (
Àvñ
 << 12);

120 
	}
}

122 #ifde‡
CONFIG_X86_32


123 
	$sys_i›l
(
±_ªgs
 *
ªgs
)

125 
Àvñ
 = 
ªgs
->
bx
;

126 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

127 
rc
;

129 
rc
 = 
	`do_i›l
(
Àvñ
, 
ªgs
);

130 i‡(
rc
 < 0)

131 
out
;

133 
t
->
i›l
 = 
Àvñ
 << 12;

134 
	`£t_i›l_mask
(
t
->
i›l
);

135 
out
:

136  
rc
;

137 
	}
}

139 
asmlökage
 
	$sys_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

141  
	`do_i›l
(
Àvñ
, 
ªgs
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<löux/˝u.h
>

5 
	~<löux/öãºu±.h
>

6 
	~<löux/kî√l_°©.h
>

7 
	~<löux/£q_fûe.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/·ø˚.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/io_≠ic.h
>

13 
	~<asm/úq.h
>

14 
	~<asm/idÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/hw_úq.h
>

18 
©omic_t
 
	gúq_îr_cou¡
;

21 (*
gíîic_öãºu±_exãnsi⁄
)(Ë
NULL
;

27 
	$ack_bad_úq
(
úq
)

29 i‡(
	`¥ötk_øãlimô
())

30 
	`¥_îr
("u√x≥˘ed IRQÅø∞© ve˘‹ %02x\n", 
úq
);

41 
	`ack_APIC_úq
();

42 
	}
}

44 
	#úq_°©s
(
x
Ë(&
	`≥r_˝u
(
úq_°©
, x))

	)

48 
	$show_Ÿhî_öãºu±s
(
£q_fûe
 *
p
, 
¥ec
)

50 
j
;

52 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "NMI");

53 
	`f‹_óch_⁄löe_˝u
(
j
)

54 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
__nmi_cou¡
);

55 
	`£q_¥ötf
(
p
, " Non-maskable interrupts\n");

56 #ifde‡
CONFIG_X86_LOCAL_APIC


57 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "LOC");

58 
	`f‹_óch_⁄löe_˝u
(
j
)

59 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_timî_úqs
);

60 
	`£q_¥ötf
(
p
, " LocalÅimer interrupts\n");

62 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "SPU");

63 
	`f‹_óch_⁄löe_˝u
(
j
)

64 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_•urious_cou¡
);

65 
	`£q_¥ötf
(
p
, " Spurious interrupts\n");

66 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PMI");

67 
	`f‹_óch_⁄löe_˝u
(
j
)

68 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥rf_úqs
);

69 
	`£q_¥ötf
(
p
, " Performance monitoring interrupts\n");

70 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PND");

71 
	`f‹_óch_⁄löe_˝u
(
j
)

72 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥ndög_úqs
);

73 
	`£q_¥ötf
(
p
, " PerformanceÖending work\n");

75 i‡(
gíîic_öãºu±_exãnsi⁄
) {

76 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PLT");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
gíîic_úqs
);

79 
	`£q_¥ötf
(
p
, " Platform interrupts\n");

81 #ifde‡
CONFIG_SMP


82 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "RES");

83 
	`f‹_óch_⁄löe_˝u
(
j
)

84 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ªsched_cou¡
);

85 
	`£q_¥ötf
(
p
, " Rescheduling interrupts\n");

86 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CAL");

87 
	`f‹_óch_⁄löe_˝u
(
j
)

88 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ˇŒ_cou¡
);

89 
	`£q_¥ötf
(
p
, " Function call interrupts\n");

90 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TLB");

91 
	`f‹_óch_⁄löe_˝u
(
j
)

92 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_éb_cou¡
);

93 
	`£q_¥ötf
(
p
, " TLB shootdowns\n");

95 #ifde‡
CONFIG_X86_MCE


96 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TRM");

97 
	`f‹_óch_⁄löe_˝u
(
j
)

98 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thîmÆ_cou¡
);

99 
	`£q_¥ötf
(
p
, " ThermalÉvent interrupts\n");

100 #ifde‡
CONFIG_X86_MCE_THRESHOLD


101 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "THR");

102 
	`f‹_óch_⁄löe_˝u
(
j
)

103 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thªshﬁd_cou¡
);

104 
	`£q_¥ötf
(
p
, " Threshold APIC interrupts\n");

107 #ifde‡
CONFIG_X86_MCE


108 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCE");

109 
	`f‹_óch_⁄löe_˝u
(
j
)

110 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
j
));

111 
	`£q_¥ötf
(
p
, " Machine checkÉxceptions\n");

112 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCP");

113 
	`f‹_óch_⁄löe_˝u
(
j
)

114 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
j
));

115 
	`£q_¥ötf
(
p
, " Machine checkÖolls\n");

117 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "ERR", 
	`©omic_ªad
(&
úq_îr_cou¡
));

118 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

119 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "MIS", 
	`©omic_ªad
(&
úq_mis_cou¡
));

122 
	}
}

124 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

126 
Êags
, 
™y_cou¡
 = 0;

127 
i
 = *(
loff_t
 *Ë
v
, 
j
, 
¥ec
;

128 
úqa˘i⁄
 *
a˘i⁄
;

129 
úq_desc
 *
desc
;

131 i‡(
i
 > 
ƒ_úqs
)

134 
¥ec
 = 3, 
j
 = 1000;Öª¯< 10 && j <
ƒ_úqs
; ++prec)

135 
j
 *= 10;

137 i‡(
i
 =
ƒ_úqs
)

138  
	`show_Ÿhî_öãºu±s
(
p
, 
¥ec
);

141 i‡(
i
 == 0) {

142 
	`£q_¥ötf
(
p
, "%*s", 
¥ec
 + 8, "");

143 
	`f‹_óch_⁄löe_˝u
(
j
)

144 
	`£q_¥ötf
(
p
, "CPU%-8d", 
j
);

145 
	`£q_putc
(
p
, '\n');

148 
desc
 = 
	`úq_to_desc
(
i
);

149 i‡(!
desc
)

152 
	`•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

153 
	`f‹_óch_⁄löe_˝u
(
j
)

154 
™y_cou¡
 |
	`k°©_úqs_˝u
(
i
, 
j
);

155 
a˘i⁄
 = 
desc
->action;

156 i‡(!
a˘i⁄
 && !
™y_cou¡
)

157 
out
;

159 
	`£q_¥ötf
(
p
, "%*d: ", 
¥ec
, 
i
);

160 
	`f‹_óch_⁄löe_˝u
(
j
)

161 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs_˝u
(
i
, 
j
));

162 
	`£q_¥ötf
(
p
, " %8s", 
desc
->
chù
->
«me
);

163 
	`£q_¥ötf
(
p
, "-%-8s", 
desc
->
«me
);

165 i‡(
a˘i⁄
) {

166 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

167 (
a˘i⁄
 =á˘i⁄->
√xt
Ë!
NULL
)

168 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

171 
	`£q_putc
(
p
, '\n');

172 
out
:

173 
	`•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

175 
	}
}

180 
u64
 
	$¨ch_úq_°©_˝u
(
˝u
)

182 
u64
 
sum
 = 
	`úq_°©s
(
˝u
)->
__nmi_cou¡
;

184 #ifde‡
CONFIG_X86_LOCAL_APIC


185 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_timî_úqs
;

186 
sum
 +
	`úq_°©s
(
˝u
)->
úq_•urious_cou¡
;

187 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥rf_úqs
;

188 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥ndög_úqs
;

190 i‡(
gíîic_öãºu±_exãnsi⁄
)

191 
sum
 +
	`úq_°©s
(
˝u
)->
gíîic_úqs
;

192 #ifde‡
CONFIG_SMP


193 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ªsched_cou¡
;

194 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ˇŒ_cou¡
;

195 
sum
 +
	`úq_°©s
(
˝u
)->
úq_éb_cou¡
;

197 #ifde‡
CONFIG_X86_MCE


198 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thîmÆ_cou¡
;

199 #ifde‡
CONFIG_X86_MCE_THRESHOLD


200 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thªshﬁd_cou¡
;

203 #ifde‡
CONFIG_X86_MCE


204 
sum
 +
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
˝u
);

205 
sum
 +
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
˝u
);

207  
sum
;

208 
	}
}

210 
u64
 
	$¨ch_úq_°©
()

212 
u64
 
sum
 = 
	`©omic_ªad
(&
úq_îr_cou¡
);

214 #ifde‡
CONFIG_X86_IO_APIC


215 
sum
 +
	`©omic_ªad
(&
úq_mis_cou¡
);

217  
sum
;

218 
	}
}

226 
__úq_íåy
 
	$do_IRQ
(
±_ªgs
 *
ªgs
)

228 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

231 
ve˘‹
 = ~
ªgs
->
‹ig_ax
;

232 
úq
;

234 
	`exô_idÀ
();

235 
	`úq_íãr
();

237 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

239 i‡(!
	`h™dÀ_úq
(
úq
, 
ªgs
)) {

240 
	`ack_APIC_úq
();

242 i‡(
	`¥ötk_øãlimô
())

243 
	`¥_emîg
("%s: %d.%d No irq handler for vector (irq %d)\n",

244 
__func__
, 
	`smp_¥o˚ss‹_id
(), 
ve˘‹
, 
úq
);

247 
	`úq_exô
();

249 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

251 
	}
}

256 
	$smp_gíîic_öãºu±
(
±_ªgs
 *
ªgs
)

258 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

260 
	`ack_APIC_úq
();

262 
	`exô_idÀ
();

264 
	`úq_íãr
();

266 
	`öc_úq_°©
(
gíîic_úqs
);

268 i‡(
gíîic_öãºu±_exãnsi⁄
)

269 
	`gíîic_öãºu±_exãnsi⁄
();

271 
	`úq_exô
();

273 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

274 
	}
}

276 
EXPORT_SYMBOL_GPL
(
ve˘‹_u£d_by_≥r˝u_úq
);

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/·ø˚.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/smp.h
>

19 
	~<asm/io_≠ic.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/≠ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
úq_˝u°©_t
, 
úq_°©
);

24 
EXPORT_PER_CPU_SYMBOL
(
úq_°©
);

26 
DEFINE_PER_CPU
(
±_ªgs
 *, 
úq_ªgs
);

27 
EXPORT_PER_CPU_SYMBOL
(
úq_ªgs
);

36 
ölöe
 
	$°ack_ovîÊow_check
(
±_ªgs
 *
ªgs
)

38 #ifde‡
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`èsk_°ack_∑ge
(
cuºít
);

41 
	`WARN_ONCE
(
ªgs
->
•
 >
curba£
 &&

42 
ªgs
->
•
 <
curba£
 + 
THREAD_SIZE
 &&

43 
ªgs
->
•
 < 
curba£
 + (
thªad_öfo
) +

44 (
±_ªgs
) + 128,

47 
cuºít
->
comm
, 
curba£
, 
ªgs
->
•
);

49 
	}
}

51 
boﬁ
 
	$h™dÀ_úq
(
úq
, 
±_ªgs
 *
ªgs
)

53 
úq_desc
 *
desc
;

55 
	`°ack_ovîÊow_check
(
ªgs
);

57 
desc
 = 
	`úq_to_desc
(
úq
);

58 i‡(
	`u∆ikñy
(!
desc
))

59  
Ál£
;

61 
	`gíîic_h™dÀ_úq_desc
(
úq
, 
desc
);

62  
åue
;

63 
	}
}

65 #ifde‡
CONFIG_HOTPLUG_CPU


67 
	$fixup_úqs
()

69 
úq
;

70 
w¨√d
;

71 
úq_desc
 *
desc
;

73 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

74 
bªak_afföôy
 = 0;

75 
£t_afföôy
 = 1;

76 c⁄° 
˝umask
 *
afföôy
;

78 i‡(!
desc
)

80 i‡(
úq
 == 2)

84 
	`•ö_lock
(&
desc
->
lock
);

86 
afföôy
 = 
desc
->affinity;

87 i‡(!
	`úq_has_a˘i⁄
(
úq
) ||

88 
	`˝umask_equÆ
(
afföôy
, 
˝u_⁄löe_mask
)) {

89 
	`•ö_u∆ock
(&
desc
->
lock
);

93 i‡(
	`˝umask_™y_™d
(
afföôy
, 
˝u_⁄löe_mask
Ë>
ƒ_˝u_ids
) {

94 
bªak_afföôy
 = 1;

95 
afföôy
 = 
˝u_Æl_mask
;

98 i‡(
desc
->
chù
->
mask
)

99 
desc
->
chù
->
	`mask
(
úq
);

101 i‡(
desc
->
chù
->
£t_afföôy
)

102 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
afföôy
);

103 i‡(!(
w¨√d
++))

104 
£t_afföôy
 = 0;

106 i‡(
desc
->
chù
->
unmask
)

107 
desc
->
chù
->
	`unmask
(
úq
);

109 
	`•ö_u∆ock
(&
desc
->
lock
);

111 i‡(
bªak_afföôy
 && 
£t_afföôy
)

112 
	`¥ötk
("Brokêafföôy f‹ irq %i\n", 
úq
);

113 i‡(!
£t_afföôy
)

114 
	`¥ötk
("C™nŸ sëáfföôy f‹ irq %i\n", 
úq
);

118 
	`loˇl_úq_íabÀ
();

119 
	`mdñay
(1);

120 
	`loˇl_úq_dißbÀ
();

121 
	}
}

124 
ˇŒ_so·úq
();

126 
asmlökage
 
	$do_so·úq
()

128 
__u32
 
≥ndög
;

129 
Êags
;

131 i‡(
	`ö_öãºu±
())

134 
	`loˇl_úq_ßve
(
Êags
);

135 
≥ndög
 = 
	`loˇl_so·úq_≥ndög
();

137 i‡(
≥ndög
) {

138 
	`ˇŒ_so·úq
();

139 
	`WARN_ON_ONCE
(
	`so·úq_cou¡
());

141 
	`loˇl_úq_ª°‹e
(
Êags
);

142 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øndom.h
>

10 
	~<löux/k¥obes.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/kî√l_°©.h
>

13 
	~<löux/sysdev.h
>

14 
	~<löux/bô›s.h
>

15 
	~<löux/a˝i.h
>

16 
	~<löux/io.h
>

17 
	~<löux/dñay.h
>

19 
	~<asm/©omic.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/hw_úq.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/desc.h
>

25 
	~<asm/≠ic.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/i8259.h
>

28 
	~<asm/å≠s.h
>

46 #ifde‡
CONFIG_X86_32


59 
úqªtu∫_t
 
	$m©h_îr‹_úq
(
˝l
, *
dev_id
)

61 
	`outb
(0, 0xF0);

62 i‡(
ign‹e_Âu_úq
 || !
boŸ_˝u_d©a
.
h¨d_m©h
)

63  
IRQ_NONE
;

64 
	`m©h_îr‹
((
__u£r
 *)
	`gë_úq_ªgs
()->
ù
);

65  
IRQ_HANDLED
;

66 
	}
}

72 
úqa˘i⁄
 
	gÂu_úq
 = {

73 .
h™dÀr
 = 
m©h_îr‹_úq
,

74 .
	g«me
 = "fpu",

81 
úqa˘i⁄
 
	gúq2
 = {

82 .
h™dÀr
 = 
no_a˘i⁄
,

83 .
	g«me
 = "cascade",

86 
DEFINE_PER_CPU
(
ve˘‹_úq_t
, 
ve˘‹_úq
) = {

87 [0 ... 
IRQ0_VECTOR
 - 1] = -1,

88 [
IRQ0_VECTOR
] = 0,

89 [
IRQ1_VECTOR
] = 1,

90 [
IRQ2_VECTOR
] = 2,

91 [
IRQ3_VECTOR
] = 3,

92 [
IRQ4_VECTOR
] = 4,

93 [
IRQ5_VECTOR
] = 5,

94 [
IRQ6_VECTOR
] = 6,

95 [
IRQ7_VECTOR
] = 7,

96 [
IRQ8_VECTOR
] = 8,

97 [
IRQ9_VECTOR
] = 9,

98 [
IRQ10_VECTOR
] = 10,

99 [
IRQ11_VECTOR
] = 11,

100 [
IRQ12_VECTOR
] = 12,

101 [
IRQ13_VECTOR
] = 13,

102 [
IRQ14_VECTOR
] = 14,

103 [
IRQ15_VECTOR
] = 15,

104 [
IRQ15_VECTOR
 + 1 ... 
NR_VECTORS
 - 1] = -1

107 
	$ve˘‹_u£d_by_≥r˝u_úq
(
ve˘‹
)

109 
˝u
;

111 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

112 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] != -1)

117 
	}
}

119 
__öô
 
	$öô_ISA_úqs
()

121 
i
;

123 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

124 
	`öô_b•_APIC
();

126 
	`öô_8259A
(0);

131 
i
 = 0; i < 
NR_IRQS_LEGACY
; i++) {

132 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
i
);

134 
desc
->
°©us
 = 
IRQ_DISABLED
;

135 
desc
->
a˘i⁄
 = 
NULL
;

136 
desc
->
dïth
 = 1;

138 
	`£t_úq_chù_™d_h™dÀr_«me
(
i
, &
i8259A_chù
,

139 
h™dÀ_Àvñ_úq
, "XT");

141 
	}
}

143 
__öô
 
	$öô_IRQ
()

145 
x86_öô
.
úqs
.
	`öå_öô
();

146 
	}
}

148 
__öô
 
	$smp_öå_öô
()

150 #ifde‡
CONFIG_SMP


151 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

156 
	`Æloc_öå_g©e
(
RESCHEDULE_VECTOR
, 
ªscheduÀ_öãºu±
);

159 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
övÆid©e_öãºu±0
);

160 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
övÆid©e_öãºu±1
);

161 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
övÆid©e_öãºu±2
);

162 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
övÆid©e_öãºu±3
);

163 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
övÆid©e_öãºu±4
);

164 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
övÆid©e_öãºu±5
);

165 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
övÆid©e_öãºu±6
);

166 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
övÆid©e_öãºu±7
);

169 
	`Æloc_öå_g©e
(
CALL_FUNCTION_VECTOR
, 
ˇŒ_fun˘i⁄_öãºu±
);

172 
	`Æloc_öå_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

173 
ˇŒ_fun˘i⁄_sögÀ_öãºu±
);

176 
	`£t_öå_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
úq_move_˛ónup_öãºu±
);

177 
	`£t_bô
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_ve˘‹s
);

180 
	`Æloc_öå_g©e
(
REBOOT_VECTOR
, 
ªboŸ_öãºu±
);

183 
	}
}

185 
__öô
 
	$≠ic_öå_öô
()

187 
	`smp_öå_öô
();

189 #ifde‡
CONFIG_X86_THERMAL_VECTOR


190 
	`Æloc_öå_g©e
(
THERMAL_APIC_VECTOR
, 
thîmÆ_öãºu±
);

192 #ifde‡
CONFIG_X86_MCE_THRESHOLD


193 
	`Æloc_öå_g©e
(
THRESHOLD_APIC_VECTOR
, 
thªshﬁd_öãºu±
);

195 #i‡
	`deföed
(
CONFIG_X86_MCE
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

196 
	`Æloc_öå_g©e
(
MCE_SELF_VECTOR
, 
m˚_£lf_öãºu±
);

199 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

201 
	`Æloc_öå_g©e
(
LOCAL_TIMER_VECTOR
, 
≠ic_timî_öãºu±
);

204 
	`Æloc_öå_g©e
(
GENERIC_INTERRUPT_VECTOR
, 
gíîic_öãºu±
);

207 
	`Æloc_öå_g©e
(
SPURIOUS_APIC_VECTOR
, 
•urious_öãºu±
);

208 
	`Æloc_öå_g©e
(
ERROR_APIC_VECTOR
, 
îr‹_öãºu±
);

211 #ifde‡
CONFIG_PERF_EVENTS


212 
	`Æloc_öå_g©e
(
LOCAL_PENDING_VECTOR
, 
≥rf_≥ndög_öãºu±
);

216 
	}
}

218 
__öô
 
	$«tive_öô_IRQ
()

220 
i
;

223 
x86_öô
.
úqs
.
	`¥e_ve˘‹_öô
();

225 
	`≠ic_öå_öô
();

232 
i
 = 
FIRST_EXTERNAL_VECTOR
; i < 
NR_VECTORS
; i++) {

234 i‡(!
	`ã°_bô
(
i
, 
u£d_ve˘‹s
))

235 
	`£t_öå_g©e
(
i
, 
öãºu±
[i-
FIRST_EXTERNAL_VECTOR
]);

238 i‡(!
a˝i_iﬂpic
)

239 
	`£tup_úq
(2, &
úq2
);

241 #ifde‡
CONFIG_X86_32


246 i‡(
boŸ_˝u_d©a
.
h¨d_m©h
 && !
˝u_has_Âu
)

247 
	`£tup_úq
(
FPU_IRQ
, &
Âu_úq
);

249 
	`úq_˘x_öô
(
	`smp_¥o˚ss‹_id
());

251 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<löux/gÂ.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<löux/öô.h
>

8 
	~<löux/î∫o.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/•ölock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_n‹thbridges
;

14 
EXPORT_SYMBOL
(
num_k8_n‹thbridges
);

16 
u32
 *
	gÊush_w‹ds
;

18 
pci_devi˚_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_n‹thbridges
;

26 
EXPORT_SYMBOL
(
k8_n‹thbridges
);

28 
pci_dev
 *
	$√xt_k8_n‹thbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 i‡(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ˇche_k8_n‹thbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 i‡(
num_k8_n‹thbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
)

48 
num_k8_n‹thbridges
++;

50 
k8_n‹thbridges
 = 
	`kmÆloc
((
num_k8_n‹thbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 i‡(!
k8_n‹thbridges
)

53  -
ENOMEM
;

55 i‡(!
num_k8_n‹thbridges
) {

56 
k8_n‹thbridges
[0] = 
NULL
;

60 
Êush_w‹ds
 = 
	`kmÆloc
(
num_k8_n‹thbridges
 * (
u32
), 
GFP_KERNEL
);

61 i‡(!
Êush_w‹ds
) {

62 
	`k‰ì
(
k8_n‹thbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
) {

69 
k8_n‹thbridges
[
i
] = 
dev
;

70 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x9c, &
Êush_w‹ds
[
i
++]);

72 
k8_n‹thbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ˇche_k8_n‹thbridges
);

79 
__öô
 
	$óæy_is_k8_nb
(
u32
 
devi˚
)

81 
pci_devi˚_id
 *
id
;

82 
u32
 
víd‹
 = 
devi˚
 & 0xffff;

83 
devi˚
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
víd‹
; id++)

85 i‡(
víd‹
 =
id
->víd‹ && 
devi˚
 == id->device)

88 
	}
}

90 
	$k8_Êush_g¨ts
()

92 
Êushed
, 
i
;

93 
Êags
;

94 
	`DEFINE_SPINLOCK
(
g¨t_lock
);

100 
	`•ö_lock_úqßve
(&
g¨t_lock
, 
Êags
);

101 
Êushed
 = 0;

102 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

103 
	`pci_wrôe_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
], 0x9c,

104 
Êush_w‹ds
[
i
]|1);

105 
Êushed
++;

107 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_ªad_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
],

112 0x9c, &
w
);

113 i‡(!(
w
 & 1))

115 
	`˝u_ªœx
();

118 
	`•ö_u∆ock_úqª°‹e
(&
g¨t_lock
, 
Êags
);

119 i‡(!
Êushed
)

120 
	`¥ötk
("nothingÅo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_Êush_g¨ts
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<löux/debugfs.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/°©.h
>

14 
	~<löux/io.h
>

15 
	~<löux/mm.h
>

17 
	~<asm/£tup.h
>

19 
díåy
 *
	g¨ch_debugfs_dú
;

20 
EXPORT_SYMBOL
(
¨ch_debugfs_dú
);

22 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


23 
	s£tup_d©a_node
 {

24 
u64
 
	m∑ddr
;

25 
u32
 
	mty≥
;

26 
u32
 
	mÀn
;

29 
ssize_t
 
	$£tup_d©a_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

30 
size_t
 
cou¡
, 
loff_t
 *
µos
)

32 
£tup_d©a_node
 *
node
 = 
fûe
->
¥iv©e_d©a
;

33 
ªmaö
;

34 
loff_t
 
pos
 = *
µos
;

35 
∑ge
 *
pg
;

36 *
p
;

37 
u64
 
∑
;

39 i‡(
pos
 < 0)

40  -
EINVAL
;

42 i‡(
pos
 >
node
->
Àn
)

45 i‡(
cou¡
 > 
node
->
Àn
 - 
pos
)

46 
cou¡
 = 
node
->
Àn
 - 
pos
;

48 
∑
 = 
node
->
∑ddr
 + (
£tup_d©a
Ë+ 
pos
;

49 
pg
 = 
	`p‚_to_∑ge
((
∑
 + 
cou¡
 - 1Ë>> 
PAGE_SHIFT
);

50 i‡(
	`PageHighMem
(
pg
)) {

51 
p
 = 
	`i‹em≠_ˇche
(
∑
, 
cou¡
);

52 i‡(!
p
)

53  -
ENXIO
;

55 
p
 = 
	`__va
(
∑
);

57 
ªmaö
 = 
	`c›y_to_u£r
(
u£r_buf
, 
p
, 
cou¡
);

59 i‡(
	`PageHighMem
(
pg
))

60 
	`iounm≠
(
p
);

62 i‡(
ªmaö
)

63  -
EFAULT
;

65 *
µos
 = 
pos
 + 
cou¡
;

67  
cou¡
;

68 
	}
}

70 
	$£tup_d©a_›í
(
öode
 *öode, 
fûe
 *file)

72 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

75 
	}
}

77 c⁄° 
fûe_›î©i⁄s
 
	gf›s_£tup_d©a
 = {

78 .
ªad
 = 
£tup_d©a_ªad
,

79 .
	g›í
 = 
£tup_d©a_›í
,

82 
__öô


83 
	$¸óã_£tup_d©a_node
(
díåy
 *
∑ª¡
, 
no
,

84 
£tup_d©a_node
 *
node
)

86 
díåy
 *
d
, *
ty≥
, *
d©a
;

87 
buf
[16];

89 
	`•rötf
(
buf
, "%d", 
no
);

90 
d
 = 
	`debugfs_¸óã_dú
(
buf
, 
∑ª¡
);

91 i‡(!
d
)

92  -
ENOMEM
;

94 
ty≥
 = 
	`debugfs_¸óã_x32
("ty≥", 
S_IRUGO
, 
d
, &
node
->type);

95 i‡(!
ty≥
)

96 
îr_dú
;

98 
d©a
 = 
	`debugfs_¸óã_fûe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
f›s_£tup_d©a
);

99 i‡(!
d©a
)

100 
îr_ty≥
;

104 
îr_ty≥
:

105 
	`debugfs_ªmove
(
ty≥
);

106 
îr_dú
:

107 
	`debugfs_ªmove
(
d
);

108  -
ENOMEM
;

109 
	}
}

111 
__öô
 
	$¸óã_£tup_d©a_nodes
(
díåy
 *
∑ª¡
)

113 
£tup_d©a_node
 *
node
;

114 
£tup_d©a
 *
d©a
;

115 
îr‹
 = -
ENOMEM
;

116 
díåy
 *
d
;

117 
∑ge
 *
pg
;

118 
u64
 
∑_d©a
;

119 
no
 = 0;

121 
d
 = 
	`debugfs_¸óã_dú
("£tup_d©a", 
∑ª¡
);

122 i‡(!
d
)

123  -
ENOMEM
;

125 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

127 
∑_d©a
) {

128 
node
 = 
	`kmÆloc
((*node), 
GFP_KERNEL
);

129 i‡(!
node
)

130 
îr_dú
;

132 
pg
 = 
	`p‚_to_∑ge
((
∑_d©a
+(*
d©a
)-1Ë>> 
PAGE_SHIFT
);

133 i‡(
	`PageHighMem
(
pg
)) {

134 
d©a
 = 
	`i‹em≠_ˇche
(
∑_d©a
, (*data));

135 i‡(!
d©a
) {

136 
	`k‰ì
(
node
);

137 
îr‹
 = -
ENXIO
;

138 
îr_dú
;

141 
d©a
 = 
	`__va
(
∑_d©a
);

143 
node
->
∑ddr
 = 
∑_d©a
;

144 
node
->
ty≥
 = 
d©a
->type;

145 
node
->
Àn
 = 
d©a
->len;

146 
îr‹
 = 
	`¸óã_£tup_d©a_node
(
d
, 
no
, 
node
);

147 
∑_d©a
 = 
d©a
->
√xt
;

149 i‡(
	`PageHighMem
(
pg
))

150 
	`iounm≠
(
d©a
);

151 i‡(
îr‹
)

152 
îr_dú
;

153 
no
++;

158 
îr_dú
:

159 
	`debugfs_ªmove
(
d
);

160  
îr‹
;

161 
	}
}

163 
debugfs_blob_wøµî
 
	gboŸ_∑øms_blob
 = {

164 .
d©a
 = &
boŸ_∑øms
,

165 .
	gsize
 = (
boŸ_∑øms
),

168 
__öô
 
	$boŸ_∑øms_kdebugfs_öô
()

170 
díåy
 *
dbp
, *
vîsi⁄
, *
d©a
;

171 
îr‹
 = -
ENOMEM
;

173 
dbp
 = 
	`debugfs_¸óã_dú
("boŸ_∑øms", 
NULL
);

174 i‡(!
dbp
)

175  -
ENOMEM
;

177 
vîsi⁄
 = 
	`debugfs_¸óã_x16
("vîsi⁄", 
S_IRUGO
, 
dbp
,

178 &
boŸ_∑øms
.
hdr
.
vîsi⁄
);

179 i‡(!
vîsi⁄
)

180 
îr_dú
;

182 
d©a
 = 
	`debugfs_¸óã_blob
("d©a", 
S_IRUGO
, 
dbp
,

183 &
boŸ_∑øms_blob
);

184 i‡(!
d©a
)

185 
îr_vîsi⁄
;

187 
îr‹
 = 
	`¸óã_£tup_d©a_nodes
(
dbp
);

188 i‡(
îr‹
)

189 
îr_d©a
;

193 
îr_d©a
:

194 
	`debugfs_ªmove
(
d©a
);

195 
îr_vîsi⁄
:

196 
	`debugfs_ªmove
(
vîsi⁄
);

197 
îr_dú
:

198 
	`debugfs_ªmove
(
dbp
);

199  
îr‹
;

200 
	}
}

203 
__öô
 
	$¨ch_kdebugfs_öô
()

205 
îr‹
 = 0;

207 
¨ch_debugfs_dú
 = 
	`debugfs_¸óã_dú
("x86", 
NULL
);

208 i‡(!
¨ch_debugfs_dú
)

209  -
ENOMEM
;

211 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


212 
îr‹
 = 
	`boŸ_∑øms_kdebugfs_öô
();

215  
îr‹
;

216 
	}
}

217 
¨ch_öôˇŒ
(
¨ch_kdebugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<löux/k¥obes.h
>

44 
	~<löux/±ø˚.h
>

45 
	~<löux/°rög.h
>

46 
	~<löux/¶ab.h
>

47 
	~<löux/h¨dúq.h
>

48 
	~<löux/¥ìm±.h
>

49 
	~<löux/moduÀ.h
>

50 
	~<löux/kdebug.h
>

52 
	~<asm/ˇcheÊush.h
>

53 
	~<asm/desc.h
>

54 
	~<asm/pgèbÀ.h
>

55 
	~<asm/uac˚ss.h
>

56 
	~<asm/Æã∫©ive.h
>

58 
j¥obe_ªtu∫_íd
();

60 
DEFINE_PER_CPU
(
k¥obe
 *, 
cuºít_k¥obe
Ë
NULL
;

61 
DEFINE_PER_CPU
(
k¥obe_˘lblk
, kprobe_ctlblk);

63 #ifde‡
CONFIG_X86_64


64 
	#°ack_addr
(
ªgs
Ë((*Ïegs->
•
)

	)

74 
	#°ack_addr
(
ªgs
Ë((*)&ªgs->
•
)

	)

77 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

78 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

79 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

80 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

81 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

82 << (
row
 % 32))

	)

87 c⁄° 
u32
 
	gtwobyã_is_boo°abÀ
[256 / 32] = {

90 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

91 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

92 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

93 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

94 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

95 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

96 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

97 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

98 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

99 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

100 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

101 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

102 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

103 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

104 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

105 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

109 c⁄° 
u32
 
	g⁄ebyã_has_modrm
[256 / 32] = {

112 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

113 
W
(0x10, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

114 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) |

115 
W
(0x30, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0) ,

116 
W
(0x40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

117 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

118 
W
(0x60, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0) |

119 
W
(0x70, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

120 
W
(0x80, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

121 
W
(0x90, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

122 
W
(0xa0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

123 
W
(0xb0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

124 
W
(0xc0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

125 
W
(0xd0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) ,

126 
W
(0xe0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

127 
W
(0xf0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1)

131 c⁄° 
u32
 
	gtwobyã_has_modrm
[256 / 32] = {

134 
W
(0x00, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1) |

135 
W
(0x10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0) ,

136 
W
(0x20, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

137 
W
(0x30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

138 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

139 
W
(0x50, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

140 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

141 
W
(0x70, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1) ,

142 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

143 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

144 
W
(0xa0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) |

145 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1) ,

146 
W
(0xc0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0) |

147 
W
(0xd0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

148 
W
(0xe0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

149 
W
(0xf0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0)

153 #unde‡
W


155 
kªçrobe_bœckpoöt
 
	gkªçrobe_bœckli°
[] = {

158 {
NULL
, NULL}

160 c⁄° 
	gkªçrobe_bœckli°_size
 = 
ARRAY_SIZE
(
kªçrobe_bœckli°
);

163 
__k¥obes
 
	$£t_jmp_›
(*
‰om
, *
to
)

165 
	s__¨ch_jmp_›
 {

166 
›
;

167 
s32
 
øddr
;

168 } 
	`__©åibuã__
((
∑cked
)Ë* 
j›
;

169 
j›
 = (
__¨ch_jmp_›
 *)
‰om
;

170 
j›
->
øddr
 = (
s32
)(()(
to
Ë- (()(
‰om
) + 5));

171 
j›
->
›
 = 
RELATIVEJUMP_INSTRUCTION
;

172 
	}
}

178 
__k¥obes
 
	$is_REX_¥efix
(
k¥obe_›code_t
 *
ö¢
)

180 #ifde‡
CONFIG_X86_64


181 i‡((*
ö¢
 & 0xf0) == 0x40)

185 
	}
}

191 
__k¥obes
 
	$ˇn_boo°
(
k¥obe_›code_t
 *
›codes
)

193 
k¥obe_›code_t
 
›code
;

194 
k¥obe_›code_t
 *
‹ig_›codes
 = 
›codes
;

196 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(()
›codes
))

199 
ªåy
:

200 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

202 
›code
 = *(
›codes
++);

205 i‡(
›code
 == 0x0f) {

206 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

208  
	`ã°_bô
(*
›codes
,

209 (*)
twobyã_is_boo°abÀ
);

212 
›code
 & 0xf0) {

213 #ifde‡
CONFIG_X86_64


215 
ªåy
;

218 i‡(0x63 < 
›code
 && opcode < 0x67)

219 
ªåy
;

221  (
›code
 != 0x62 && opcode != 0x67);

226  (0xc1 < 
›code
 && opcode < 0xcc) || opcode == 0xcf;

229  (
›code
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

232  ((
›code
 & 0x04) || opcode == 0xea);

234 i‡((
›code
 & 0x0c) == 0 && opcode != 0xf1)

235 
ªåy
;

237  (
›code
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

240 i‡(
›code
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

241 
ªåy
;

243  (
›code
 != 0x2e && opcode != 0x9a);

245 
	}
}

250 
__k¥obes
 
	$is_IF_modifõr
(
k¥obe_›code_t
 *
ö¢
)

252 *
ö¢
) {

264 i‡(
	`is_REX_¥efix
(
ö¢
))

265  
	`is_IF_modifõr
(++
ö¢
);

268 
	}
}

277 
__k¥obes
 
	$fix_rùªl
(
k¥obe
 *
p
)

279 #ifde‡
CONFIG_X86_64


280 
u8
 *
ö¢
 = 
p
->
aö¢
.insn;

281 
s64
 
di•
;

282 
√ed_modrm
;

286 *
ö¢
) {

298 ++
ö¢
;

305 i‡(
	`is_REX_¥efix
(
ö¢
))

306 ++
ö¢
;

308 i‡(*
ö¢
 == 0x0f) {

310 ++
ö¢
;

311 
√ed_modrm
 = 
	`ã°_bô
(*
ö¢
,

312 (*)
twobyã_has_modrm
);

315 
√ed_modrm
 = 
	`ã°_bô
(*
ö¢
,

316 (*)
⁄ebyã_has_modrm
);

318 i‡(
√ed_modrm
) {

319 
u8
 
modrm
 = *++
ö¢
;

320 i‡((
modrm
 & 0xc7) == 0x05) {

323 ++
ö¢
;

337 
di•
 = (
u8
 *Ë
p
->
addr
 + *((
s32
 *Ë
ö¢
) -

338 (
u8
 *Ë
p
->
aö¢
.
ö¢
;

339 
	`BUG_ON
((
s64
Ë(
s32
Ë
di•
 != disp);

340 *(
s32
 *)
ö¢
 = (s32Ë
di•
;

344 
	}
}

346 
__k¥obes
 
	$¨ch_c›y_k¥obe
(
k¥obe
 *
p
)

348 
	`mem˝y
(
p
->
aö¢
.
ö¢
,Ö->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

350 
	`fix_rùªl
(
p
);

352 i‡(
	`ˇn_boo°
(
p
->
addr
))

353 
p
->
aö¢
.
boo°abÀ
 = 0;

355 
p
->
aö¢
.
boo°abÀ
 = -1;

357 
p
->
›code
 = *p->
addr
;

358 
	}
}

360 
__k¥obes
 
	$¨ch_¥ï¨e_k¥obe
(
k¥obe
 *
p
)

363 
p
->
aö¢
.
ö¢
 = 
	`gë_ö¢_¶Ÿ
();

364 i‡(!
p
->
aö¢
.
ö¢
)

365  -
ENOMEM
;

366 
	`¨ch_c›y_k¥obe
(
p
);

368 
	}
}

370 
__k¥obes
 
	$¨ch_¨m_k¥obe
(
k¥obe
 *
p
)

372 
	`ãxt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

373 
	}
}

375 
__k¥obes
 
	$¨ch_dißrm_k¥obe
(
k¥obe
 *
p
)

377 
	`ãxt_poke
(
p
->
addr
, &p->
›code
, 1);

378 
	}
}

380 
__k¥obes
 
	$¨ch_ªmove_k¥obe
(
k¥obe
 *
p
)

382 i‡(
p
->
aö¢
.
ö¢
) {

383 
	`‰ì_ö¢_¶Ÿ
(
p
->
aö¢
.
ö¢
, (p->aö¢.
boo°abÀ
 == 1));

384 
p
->
aö¢
.
ö¢
 = 
NULL
;

386 
	}
}

388 
__k¥obes
 
	$ßve_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

390 
kcb
->
¥ev_k¥obe
.
kp
 = 
	`k¥obe_ru¬ög
();

391 
kcb
->
¥ev_k¥obe
.
°©us
 = kcb->
k¥obe_°©us
;

392 
kcb
->
¥ev_k¥obe
.
ﬁd_Êags
 = kcb->
k¥obe_ﬁd_Êags
;

393 
kcb
->
¥ev_k¥obe
.
ßved_Êags
 = kcb->
k¥obe_ßved_Êags
;

394 
	}
}

396 
__k¥obes
 
	$ª°‹e_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

398 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
kcb
->
¥ev_k¥obe
.
kp
;

399 
kcb
->
k¥obe_°©us
 = kcb->
¥ev_k¥obe
.
°©us
;

400 
kcb
->
k¥obe_ﬁd_Êags
 = kcb->
¥ev_k¥obe
.
ﬁd_Êags
;

401 
kcb
->
k¥obe_ßved_Êags
 = kcb->
¥ev_k¥obe
.
ßved_Êags
;

402 
	}
}

404 
__k¥obes
 
	$£t_cuºít_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

405 
k¥obe_˘lblk
 *
kcb
)

407 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
p
;

408 
kcb
->
k¥obe_ßved_Êags
 = kcb->
k¥obe_ﬁd_Êags


409 (
ªgs
->
Êags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

410 i‡(
	`is_IF_modifõr
(
p
->
aö¢
.
ö¢
))

411 
kcb
->
k¥obe_ßved_Êags
 &~
X86_EFLAGS_IF
;

412 
	}
}

414 
__k¥obes
 
	$˛ór_btf
()

416 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

417 
	`upd©e_debug˘lm§
(0);

418 
	}
}

420 
__k¥obes
 
	$ª°‹e_btf
()

422 i‡(
	`ã°_thªad_Êag
(
TIF_DEBUGCTLMSR
))

423 
	`upd©e_debug˘lm§
(
cuºít
->
thªad
.
debug˘lm§
);

424 
	}
}

426 
__k¥obes
 
	$¥ï¨e_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

428 
	`˛ór_btf
();

429 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

430 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

432 i‡(
p
->
›code
 =
BREAKPOINT_INSTRUCTION
)

433 
ªgs
->
ù
 = ()
p
->
addr
;

435 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

436 
	}
}

438 
__k¥obes
 
	$¨ch_¥ï¨e_kªçrobe
(
kªçrobe_ö°™˚
 *
ri
,

439 
±_ªgs
 *
ªgs
)

441 *
ßø
 = 
	`°ack_addr
(
ªgs
);

443 
ri
->
ªt_addr
 = (
k¥obe_›code_t
 *Ë*
ßø
;

446 *
ßø
 = (Ë&
kªçrobe_åampﬁöe
;

447 
	}
}

449 
__k¥obes
 
	$£tup_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

450 
k¥obe_˘lblk
 *
kcb
)

452 #i‡!
	`deföed
(
CONFIG_PREEMPT
Ë|| deföed(
CONFIG_FREEZER
)

453 i‡(
p
->
aö¢
.
boo°abÀ
 =1 && !p->
po°_h™dÀr
) {

455 
	`ª£t_cuºít_k¥obe
();

456 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

457 
	`¥ìm±_íabÀ_no_ªsched
();

461 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

462 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SS
;

463 
	}
}

470 
__k¥obes
 
	$ªíãr_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

471 
k¥obe_˘lblk
 *
kcb
)

473 
kcb
->
k¥obe_°©us
) {

474 
KPROBE_HIT_SSDONE
:

475 #ifde‡
CONFIG_X86_64


480 
	`¨ch_dißrm_k¥obe
(
p
);

481 
ªgs
->
ù
 = ()
p
->
addr
;

482 
	`ª£t_cuºít_k¥obe
();

483 
	`¥ìm±_íabÀ_no_ªsched
();

486 
KPROBE_HIT_ACTIVE
:

487 
	`ßve_¥evious_k¥obe
(
kcb
);

488 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

489 
	`k¥obes_öc_nmis£d_cou¡
(
p
);

490 
	`¥ï¨e_sögÀ°ï
(
p
, 
ªgs
);

491 
kcb
->
k¥obe_°©us
 = 
KPROBE_REENTER
;

493 
KPROBE_HIT_SS
:

494 i‡(
p
 =
	`k¥obe_ru¬ög
()) {

495 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

496 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

508 
	`WARN_ON
(1);

513 
	}
}

519 
__k¥obes
 
	$k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

521 
k¥obe_›code_t
 *
addr
;

522 
k¥obe
 *
p
;

523 
k¥obe_˘lblk
 *
kcb
;

525 
addr
 = (
k¥obe_›code_t
 *)(
ªgs
->
ù
 - (kprobe_opcode_t));

526 i‡(*
addr
 !
BREAKPOINT_INSTRUCTION
) {

536 
ªgs
->
ù
 = ()
addr
;

546 
	`¥ìm±_dißbÀ
();

548 
kcb
 = 
	`gë_k¥obe_˘lblk
();

549 
p
 = 
	`gë_k¥obe
(
addr
);

551 i‡(
p
) {

552 i‡(
	`k¥obe_ru¬ög
()) {

553 i‡(
	`ªíãr_k¥obe
(
p
, 
ªgs
, 
kcb
))

556 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

557 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

567 i‡(!
p
->
¥e_h™dÀr
 || !p->
	`¥e_h™dÀr
’, 
ªgs
))

568 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

571 } i‡(
	`k¥obe_ru¬ög
()) {

572 
p
 = 
	`__gë_˝u_v¨
(
cuºít_k¥obe
);

573 i‡(
p
->
bªak_h™dÀr
 &&Ö->
	`bªak_h™dÀr
’, 
ªgs
)) {

574 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
);

579 
	`¥ìm±_íabÀ_no_ªsched
();

581 
	}
}

587 
__u£d
 
__k¥obes
 
	$kªçrobe_åampﬁöe_hﬁdî
()

589 
asm
 volatile (

592 #ifde‡
CONFIG_X86_64


674 
	}
}

679 
__u£d
 
__k¥obes
 *
	$åampﬁöe_h™dÀr
(
±_ªgs
 *
ªgs
)

681 
kªçrobe_ö°™˚
 *
ri
 = 
NULL
;

682 
hli°_hód
 *
hód
, 
em±y_Ω
;

683 
hli°_node
 *
node
, *
tmp
;

684 
Êags
, 
‹ig_ªt_addªss
 = 0;

685 
åampﬁöe_addªss
 = ()&
kªçrobe_åampﬁöe
;

687 
	`INIT_HLIST_HEAD
(&
em±y_Ω
);

688 
	`kªçrobe_hash_lock
(
cuºít
, &
hód
, &
Êags
);

690 #ifde‡
CONFIG_X86_64


691 
ªgs
->
cs
 = 
__KERNEL_CS
;

693 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

694 
ªgs
->
gs
 = 0;

696 
ªgs
->
ù
 = 
åampﬁöe_addªss
;

697 
ªgs
->
‹ig_ax
 = ~0UL;

712 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, 
hód
, 
hli°
) {

713 i‡(
ri
->
èsk
 !
cuºít
)

717 i‡(
ri
->
Ω
 &&Ñi->Ω->
h™dÀr
) {

718 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
ri
->
Ω
->
kp
;

719 
	`gë_k¥obe_˘lblk
()->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

720 
ri
->
Ω
->
	`h™dÀr
‘i, 
ªgs
);

721 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

724 
‹ig_ªt_addªss
 = ()
ri
->
ªt_addr
;

725 
	`ªcy˛e_Ω_ö°
(
ri
, &
em±y_Ω
);

727 i‡(
‹ig_ªt_addªss
 !
åampﬁöe_addªss
)

736 
	`kªçrobe_as£π
(
ri
, 
‹ig_ªt_addªss
, 
åampﬁöe_addªss
);

738 
	`kªçrobe_hash_u∆ock
(
cuºít
, &
Êags
);

740 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, &
em±y_Ω
, 
hli°
) {

741 
	`hli°_dñ
(&
ri
->
hli°
);

742 
	`k‰ì
(
ri
);

744  (*)
‹ig_ªt_addªss
;

745 
	}
}

774 
__k¥obes
 
	$ªsume_executi⁄
(
k¥obe
 *
p
,

775 
±_ªgs
 *
ªgs
, 
k¥obe_˘lblk
 *
kcb
)

777 *
tos
 = 
	`°ack_addr
(
ªgs
);

778 
c›y_ù
 = ()
p
->
aö¢
.
ö¢
;

779 
‹ig_ù
 = ()
p
->
addr
;

780 
k¥obe_›code_t
 *
ö¢
 = 
p
->
aö¢
.insn;

783 i‡(
	`is_REX_¥efix
(
ö¢
))

784 
ö¢
++;

786 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

787 *
ö¢
) {

789 *
tos
 &~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

790 *
tos
 |
kcb
->
k¥obe_ﬁd_Êags
;

799 
p
->
aö¢
.
boo°abÀ
 = 1;

800 
no_ch™ge
;

802 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

804 #ifde‡
CONFIG_X86_32


806 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

807 
no_ch™ge
;

810 i‡((
ö¢
[1] & 0x30) == 0x10) {

816 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

817 
no_ch™ge
;

818 } i‡(((
ö¢
[1] & 0x31) == 0x20) ||

819 ((
ö¢
[1] & 0x31) == 0x21)) {

824 
p
->
aö¢
.
boo°abÀ
 = 1;

825 
no_ch™ge
;

831 i‡(
p
->
aö¢
.
boo°abÀ
 == 0) {

832 i‡((
ªgs
->
ù
 > 
c›y_ù
) &&

833 (
ªgs
->
ù
 - 
c›y_ù
Ë+ 5 < 
MAX_INSN_SIZE
) {

838 
	`£t_jmp_›
((*)
ªgs
->
ù
,

839 (*)
‹ig_ù
 + (
ªgs
->
ù
 - 
c›y_ù
));

840 
p
->
aö¢
.
boo°abÀ
 = 1;

842 
p
->
aö¢
.
boo°abÀ
 = -1;

846 
ªgs
->
ù
 +
‹ig_ù
 - 
c›y_ù
;

848 
no_ch™ge
:

849 
	`ª°‹e_btf
();

850 
	}
}

856 
__k¥obes
 
	$po°_k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

858 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

859 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

861 i‡(!
cur
)

864 
	`ªsume_executi⁄
(
cur
, 
ªgs
, 
kcb
);

865 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

867 i‡((
kcb
->
k¥obe_°©us
 !
KPROBE_REENTER
Ë&& 
cur
->
po°_h™dÀr
) {

868 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SSDONE
;

869 
cur
->
	`po°_h™dÀr
(cur, 
ªgs
, 0);

873 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
) {

874 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

875 
out
;

877 
	`ª£t_cuºít_k¥obe
();

878 
out
:

879 
	`¥ìm±_íabÀ_no_ªsched
();

886 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
)

890 
	}
}

892 
__k¥obes
 
	$k¥obe_Áu…_h™dÀr
(
±_ªgs
 *
ªgs
, 
å≠ƒ
)

894 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

895 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

897 
kcb
->
k¥obe_°©us
) {

898 
KPROBE_HIT_SS
:

899 
KPROBE_REENTER
:

907 
ªgs
->
ù
 = ()
cur
->
addr
;

908 
ªgs
->
Êags
 |
kcb
->
k¥obe_ﬁd_Êags
;

909 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
)

910 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

912 
	`ª£t_cuºít_k¥obe
();

913 
	`¥ìm±_íabÀ_no_ªsched
();

915 
KPROBE_HIT_ACTIVE
:

916 
KPROBE_HIT_SSDONE
:

922 
	`k¥obes_öc_nmis£d_cou¡
(
cur
);

931 i‡(
cur
->
Áu…_h™dÀr
 && cur->
	`Áu…_h™dÀr
(cur, 
ªgs
, 
å≠ƒ
))

938 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

950 
	}
}

955 
__k¥obes
 
	$k¥obe_ex˚±i⁄s_nŸify
(
nŸifõr_block
 *
£lf
,

956 
vÆ
, *
d©a
)

958 
dõ_¨gs
 *
¨gs
 = 
d©a
;

959 
ªt
 = 
NOTIFY_DONE
;

961 i‡(
¨gs
->
ªgs
 && 
	`u£r_mode_vm
(args->regs))

962  
ªt
;

964 
vÆ
) {

965 
DIE_INT3
:

966 i‡(
	`k¥obe_h™dÀr
(
¨gs
->
ªgs
))

967 
ªt
 = 
NOTIFY_STOP
;

969 
DIE_DEBUG
:

970 i‡(
	`po°_k¥obe_h™dÀr
(
¨gs
->
ªgs
))

971 
ªt
 = 
NOTIFY_STOP
;

973 
DIE_GPF
:

979 i‡(!
	`¥ìm±ibÀ
(Ë&& 
	`k¥obe_ru¬ög
() &&

980 
	`k¥obe_Áu…_h™dÀr
(
¨gs
->
ªgs
,árgs->
å≠ƒ
))

981 
ªt
 = 
NOTIFY_STOP
;

986  
ªt
;

987 
	}
}

989 
__k¥obes
 
	$£tjmp_¥e_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

991 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

992 
addr
;

993 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

995 
kcb
->
j¥obe_ßved_ªgs
 = *
ªgs
;

996 
kcb
->
j¥obe_ßved_•
 = 
	`°ack_addr
(
ªgs
);

997 
addr
 = ()(
kcb
->
j¥obe_ßved_•
);

1006 
	`mem˝y
(
kcb
->
j¥obes_°ack
, (
k¥obe_›code_t
 *)
addr
,

1007 
	`MIN_STACK_SIZE
(
addr
));

1008 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

1009 
	`åa˚_h¨dúqs_off
();

1010 
ªgs
->
ù
 = ()(
jp
->
íåy
);

1012 
	}
}

1014 
__k¥obes
 
	$j¥obe_ªtu∫
()

1016 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1018 
asm
 volatile (

1019 #ifde‡
CONFIG_X86_64


1028 (
kcb
->
j¥obe_ßved_•
):"memory");

1029 
	}
}

1031 
__k¥obes
 
	$l⁄gjmp_bªak_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1033 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1034 
u8
 *
addr
 = (u8 *Ë(
ªgs
->
ù
 - 1);

1035 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1037 i‡((
addr
 > (
u8
 *Ë
j¥obe_ªtu∫
) &&

1038 (
addr
 < (
u8
 *Ë
j¥obe_ªtu∫_íd
)) {

1039 i‡(
	`°ack_addr
(
ªgs
Ë!
kcb
->
j¥obe_ßved_•
) {

1040 
±_ªgs
 *
ßved_ªgs
 = &
kcb
->
j¥obe_ßved_ªgs
;

1041 
	`¥ötk
(
KERN_ERR


1043 
	`°ack_addr
(
ªgs
), 
kcb
->
j¥obe_ßved_•
);

1044 
	`¥ötk
(
KERN_ERR
 "SavedÑegi°î†f‹ j¥obê%p\n", 
jp
);

1045 
	`show_ªgi°îs
(
ßved_ªgs
);

1046 
	`¥ötk
(
KERN_ERR
 "CurrentÑegisters\n");

1047 
	`show_ªgi°îs
(
ªgs
);

1048 
	`BUG
();

1050 *
ªgs
 = 
kcb
->
j¥obe_ßved_ªgs
;

1051 
	`mem˝y
((
k¥obe_›code_t
 *)(
kcb
->
j¥obe_ßved_•
),

1052 
kcb
->
j¥obes_°ack
,

1053 
	`MIN_STACK_SIZE
(
kcb
->
j¥obe_ßved_•
));

1054 
	`¥ìm±_íabÀ_no_ªsched
();

1058 
	}
}

1060 
__öô
 
	$¨ch_öô_k¥obes
()

1063 
	}
}

1065 
__k¥obes
 
	$¨ch_åampﬁöe_k¥obe
(
k¥obe
 *
p
)

1068 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<löux/î∫o.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/uac˚ss.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/ldt.h
>

19 
	~<asm/desc.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

21 
	~<asm/sysˇŒs.h
>

23 #ifde‡
CONFIG_SMP


24 
	$Êush_ldt
(*
cuºít_mm
)

26 i‡(
cuºít
->
a˘ive_mm
 =
cuºít_mm
)

27 
	`lﬂd_LDT
(&
cuºít
->
a˘ive_mm
->
c⁄ãxt
);

28 
	}
}

31 
	$Æloc_ldt
(
mm_c⁄ãxt_t
 *
pc
, 
möcou¡
, 
ªlﬂd
)

33 *
ﬁdldt
, *
√wldt
;

34 
ﬁdsize
;

36 i‡(
möcou¡
 <
pc
->
size
)

38 
ﬁdsize
 = 
pc
->
size
;

39 
möcou¡
 = (möcou¡ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

40 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

41 i‡(
möcou¡
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

42 
√wldt
 = 
	`vmÆloc
(
möcou¡
 * 
LDT_ENTRY_SIZE
);

44 
√wldt
 = (*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
);

46 i‡(!
√wldt
)

47  -
ENOMEM
;

49 i‡(
ﬁdsize
)

50 
	`mem˝y
(
√wldt
, 
pc
->
ldt
, 
ﬁdsize
 * 
LDT_ENTRY_SIZE
);

51 
ﬁdldt
 = 
pc
->
ldt
;

52 
	`mem£t
(
√wldt
 + 
ﬁdsize
 * 
LDT_ENTRY_SIZE
, 0,

53 (
möcou¡
 - 
ﬁdsize
Ë* 
LDT_ENTRY_SIZE
);

55 
	`∑øvút_Æloc_ldt
(
√wldt
, 
möcou¡
);

57 #ifde‡
CONFIG_X86_64


59 
	`wmb
();

61 
pc
->
ldt
 = 
√wldt
;

62 
	`wmb
();

63 
pc
->
size
 = 
möcou¡
;

64 
	`wmb
();

66 i‡(
ªlﬂd
) {

67 #ifde‡
CONFIG_SMP


68 
	`¥ìm±_dißbÀ
();

69 
	`lﬂd_LDT
(
pc
);

70 i‡(!
	`˝umask_equÆ
(
	`mm_˝umask
(
cuºít
->
mm
),

71 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
())))

72 
	`smp_ˇŒ_fun˘i⁄
(
Êush_ldt
, 
cuºít
->
mm
, 1);

73 
	`¥ìm±_íabÀ
();

75 
	`lﬂd_LDT
(
pc
);

78 i‡(
ﬁdsize
) {

79 
	`∑øvút_‰ì_ldt
(
ﬁdldt
, 
ﬁdsize
);

80 i‡(
ﬁdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

81 
	`v‰ì
(
ﬁdldt
);

83 
	`put_∑ge
(
	`vút_to_∑ge
(
ﬁdldt
));

86 
	}
}

88 
ölöe
 
	$c›y_ldt
(
mm_c⁄ãxt_t
 *
√w
, mm_c⁄ãxt_à*
ﬁd
)

90 
îr
 = 
	`Æloc_ldt
(
√w
, 
ﬁd
->
size
, 0);

91 
i
;

93 i‡(
îr
 < 0)

94  
îr
;

96 
i
 = 0; i < 
ﬁd
->
size
; i++)

97 
	`wrôe_ldt_íåy
(
√w
->
ldt
, 
i
, 
ﬁd
->ldà+ i * 
LDT_ENTRY_SIZE
);

99 
	}
}

105 
	$öô_√w_c⁄ãxt
(
èsk_°ru˘
 *
tsk
, 
mm_°ru˘
 *
mm
)

107 
mm_°ru˘
 *
ﬁd_mm
;

108 
ªtvÆ
 = 0;

110 
	`muãx_öô
(&
mm
->
c⁄ãxt
.
lock
);

111 
mm
->
c⁄ãxt
.
size
 = 0;

112 
ﬁd_mm
 = 
cuºít
->
mm
;

113 i‡(
ﬁd_mm
 && old_mm->
c⁄ãxt
.
size
 > 0) {

114 
	`muãx_lock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

115 
ªtvÆ
 = 
	`c›y_ldt
(&
mm
->
c⁄ãxt
, &
ﬁd_mm
->context);

116 
	`muãx_u∆ock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

118  
ªtvÆ
;

119 
	}
}

126 
	$de°roy_c⁄ãxt
(
mm_°ru˘
 *
mm
)

128 i‡(
mm
->
c⁄ãxt
.
size
) {

129 #ifde‡
CONFIG_X86_32


131 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

132 
	`˛ór_LDT
();

134 
	`∑øvút_‰ì_ldt
(
mm
->
c⁄ãxt
.
ldt
, mm->c⁄ãxt.
size
);

135 i‡(
mm
->
c⁄ãxt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

136 
	`v‰ì
(
mm
->
c⁄ãxt
.
ldt
);

138 
	`put_∑ge
(
	`vút_to_∑ge
(
mm
->
c⁄ãxt
.
ldt
));

139 
mm
->
c⁄ãxt
.
size
 = 0;

141 
	}
}

143 
	$ªad_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

145 
îr
;

146 
size
;

147 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

149 i‡(!
mm
->
c⁄ãxt
.
size
)

151 i‡(
byãcou¡
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

152 
byãcou¡
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

154 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

155 
size
 = 
mm
->
c⁄ãxt
.sizê* 
LDT_ENTRY_SIZE
;

156 i‡(
size
 > 
byãcou¡
)

157 
size
 = 
byãcou¡
;

159 
îr
 = 0;

160 i‡(
	`c›y_to_u£r
(
±r
, 
mm
->
c⁄ãxt
.
ldt
, 
size
))

161 
îr
 = -
EFAULT
;

162 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

163 i‡(
îr
 < 0)

164 
îr‹_ªtu∫
;

165 i‡(
size
 !
byãcou¡
) {

167 i‡(
	`˛ór_u£r
(
±r
 + 
size
, 
byãcou¡
 - size) != 0) {

168 
îr
 = -
EFAULT
;

169 
îr‹_ªtu∫
;

172  
byãcou¡
;

173 
îr‹_ªtu∫
:

174  
îr
;

175 
	}
}

177 
	$ªad_deÁu…_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

180 #ifde‡
CONFIG_X86_32


181 
size
 = 5 * (
desc_°ru˘
);

183 
size
 = 128;

185 i‡(
byãcou¡
 > 
size
)

186 
byãcou¡
 = 
size
;

187 i‡(
	`˛ór_u£r
(
±r
, 
byãcou¡
))

188  -
EFAULT
;

189  
byãcou¡
;

190 
	}
}

192 
	$wrôe_ldt
(
__u£r
 *
±r
, 
byãcou¡
, 
ﬁdmode
)

194 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

195 
desc_°ru˘
 
ldt
;

196 
îr‹
;

197 
u£r_desc
 
ldt_öfo
;

199 
îr‹
 = -
EINVAL
;

200 i‡(
byãcou¡
 !(
ldt_öfo
))

201 
out
;

202 
îr‹
 = -
EFAULT
;

203 i‡(
	`c›y_‰om_u£r
(&
ldt_öfo
, 
±r
, (ldt_info)))

204 
out
;

206 
îr‹
 = -
EINVAL
;

207 i‡(
ldt_öfo
.
íåy_numbî
 >
LDT_ENTRIES
)

208 
out
;

209 i‡(
ldt_öfo
.
c⁄ã¡s
 == 3) {

210 i‡(
ﬁdmode
)

211 
out
;

212 i‡(
ldt_öfo
.
£g_nŸ_¥e£¡
 == 0)

213 
out
;

216 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

217 i‡(
ldt_öfo
.
íåy_numbî
 >
mm
->
c⁄ãxt
.
size
) {

218 
îr‹
 = 
	`Æloc_ldt
(&
cuºít
->
mm
->
c⁄ãxt
,

219 
ldt_öfo
.
íåy_numbî
 + 1, 1);

220 i‡(
îr‹
 < 0)

221 
out_u∆ock
;

225 i‡(
ldt_öfo
.
ba£_addr
 =0 &&Üdt_öfo.
limô
 == 0) {

226 i‡(
ﬁdmode
 || 
	`LDT_em±y
(&
ldt_öfo
)) {

227 
	`mem£t
(&
ldt
, 0, (ldt));

228 
ö°Æl
;

232 
	`fûl_ldt
(&
ldt
, &
ldt_öfo
);

233 i‡(
ﬁdmode
)

234 
ldt
.
avl
 = 0;

237 
ö°Æl
:

238 
	`wrôe_ldt_íåy
(
mm
->
c⁄ãxt
.
ldt
, 
ldt_öfo
.
íåy_numbî
, &ldt);

239 
îr‹
 = 0;

241 
out_u∆ock
:

242 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

243 
out
:

244  
îr‹
;

245 
	}
}

247 
asmlökage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

248 
byãcou¡
)

250 
ªt
 = -
ENOSYS
;

252 
func
) {

254 
ªt
 = 
	`ªad_ldt
(
±r
, 
byãcou¡
);

257 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 1);

260 
ªt
 = 
	`ªad_deÁu…_ldt
(
±r
, 
byãcou¡
);

263 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 0);

266  
ªt
;

267 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<löux/mm.h
>

10 
	~<löux/kexec.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/ªboŸ.h
>

13 
	~<löux/numa.h
>

14 
	~<löux/·ø˚.h
>

15 
	~<löux/io.h
>

16 
	~<löux/su•íd.h
>

18 
	~<asm/pgèbÀ.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/mmu_c⁄ãxt.h
>

22 
	$öô_⁄e_Àvñ2_∑ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

23 
addr
)

25 
pud_t
 *
pud
;

26 
pmd_t
 *
pmd
;

27 
∑ge
 *page;

28 
ªsu…
 = -
ENOMEM
;

30 
addr
 &
PMD_MASK
;

31 
pgd
 +
	`pgd_ödex
(
addr
);

32 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

33 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

34 i‡(!
∑ge
)

35 
out
;

36 
pud
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

37 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

38 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

40 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

41 i‡(!
	`pud_¥e£¡
(*
pud
)) {

42 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

43 i‡(!
∑ge
)

44 
out
;

45 
pmd
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

46 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

47 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

49 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

50 i‡(!
	`pmd_¥e£¡
(*
pmd
))

51 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

52 
ªsu…
 = 0;

53 
out
:

54  
ªsu…
;

55 
	}
}

57 
	$öô_Àvñ2_∑ge
(
pmd_t
 *
Àvñ2p
, 
addr
)

59 
íd_addr
;

61 
addr
 &
PAGE_MASK
;

62 
íd_addr
 = 
addr
 + 
PUD_SIZE
;

63 
addr
 < 
íd_addr
) {

64 
	`£t_pmd
(
Àvñ2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

65 
addr
 +
PMD_SIZE
;

67 
	}
}

69 
	$öô_Àvñ3_∑ge
(
kimage
 *
image
, 
pud_t
 *
Àvñ3p
,

70 
addr
, 
œ°_addr
)

72 
íd_addr
;

73 
ªsu…
;

75 
ªsu…
 = 0;

76 
addr
 &
PAGE_MASK
;

77 
íd_addr
 = 
addr
 + 
PGDIR_SIZE
;

78 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

79 
∑ge
 *page;

80 
pmd_t
 *
Àvñ2p
;

82 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

83 i‡(!
∑ge
) {

84 
ªsu…
 = -
ENOMEM
;

85 
out
;

87 
Àvñ2p
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

88 
	`öô_Àvñ2_∑ge
(
Àvñ2p
, 
addr
);

89 
	`£t_pud
(
Àvñ3p
++, 
	`__pud
(
	`__∑
(
Àvñ2p
Ë| 
_KERNPG_TABLE
));

90 
addr
 +
PUD_SIZE
;

93 
addr
 < 
íd_addr
) {

94 
	`pud_˛ór
(
Àvñ3p
++);

95 
addr
 +
PUD_SIZE
;

97 
out
:

98  
ªsu…
;

99 
	}
}

102 
	$öô_Àvñ4_∑ge
(
kimage
 *
image
, 
pgd_t
 *
Àvñ4p
,

103 
addr
, 
œ°_addr
)

105 
íd_addr
;

106 
ªsu…
;

108 
ªsu…
 = 0;

109 
addr
 &
PAGE_MASK
;

110 
íd_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

111 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

112 
∑ge
 *page;

113 
pud_t
 *
Àvñ3p
;

115 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

116 i‡(!
∑ge
) {

117 
ªsu…
 = -
ENOMEM
;

118 
out
;

120 
Àvñ3p
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

121 
ªsu…
 = 
	`öô_Àvñ3_∑ge
(
image
, 
Àvñ3p
, 
addr
, 
œ°_addr
);

122 i‡(
ªsu…
)

123 
out
;

124 
	`£t_pgd
(
Àvñ4p
++, 
	`__pgd
(
	`__∑
(
Àvñ3p
Ë| 
_KERNPG_TABLE
));

125 
addr
 +
PGDIR_SIZE
;

128 
addr
 < 
íd_addr
) {

129 
	`pgd_˛ór
(
Àvñ4p
++);

130 
addr
 +
PGDIR_SIZE
;

132 
out
:

133  
ªsu…
;

134 
	}
}

136 
	$‰ì_å™sôi⁄_pgèbÀ
(
kimage
 *
image
)

138 
	`‰ì_∑ge
(()
image
->
¨ch
.
pud
);

139 
	`‰ì_∑ge
(()
image
->
¨ch
.
pmd
);

140 
	`‰ì_∑ge
(()
image
->
¨ch
.
±e
);

141 
	}
}

143 
	$öô_å™sôi⁄_pgèbÀ
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

145 
pud_t
 *
pud
;

146 
pmd_t
 *
pmd
;

147 
±e_t
 *
±e
;

148 
vaddr
, 
∑ddr
;

149 
ªsu…
 = -
ENOMEM
;

151 
vaddr
 = ()
ªloˇã_kî√l
;

152 
∑ddr
 = 
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
)+
PAGE_SIZE
);

153 
pgd
 +
	`pgd_ödex
(
vaddr
);

154 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

155 
pud
 = (
pud_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

156 i‡(!
pud
)

157 
îr
;

158 
image
->
¨ch
.
pud
 =Öud;

159 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

161 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

162 i‡(!
	`pud_¥e£¡
(*
pud
)) {

163 
pmd
 = (
pmd_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

164 i‡(!
pmd
)

165 
îr
;

166 
image
->
¨ch
.
pmd
 =Ömd;

167 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

169 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

170 i‡(!
	`pmd_¥e£¡
(*
pmd
)) {

171 
±e
 = (
±e_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

172 i‡(!
±e
)

173 
îr
;

174 
image
->
¨ch
.
±e
 =Öte;

175 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__∑
(
±e
Ë| 
_KERNPG_TABLE
));

177 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

178 
	`£t_±e
(
±e
, 
	`p‚_±e
(
∑ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

180 
îr
:

181 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

182  
ªsu…
;

183 
	}
}

186 
	$öô_pgèbÀ
(
kimage
 *
image
, 
°¨t_pgèbÀ
)

188 
pgd_t
 *
Àvñ4p
;

189 
ªsu…
;

190 
Àvñ4p
 = (
pgd_t
 *)
	`__va
(
°¨t_pgèbÀ
);

191 
ªsu…
 = 
	`öô_Àvñ4_∑ge
(
image
, 
Àvñ4p
, 0, 
max_p‚
 << 
PAGE_SHIFT
);

192 i‡(
ªsu…
)

193  
ªsu…
;

198 
ªsu…
 = 
	`öô_⁄e_Àvñ2_∑ge
(
image
, 
Àvñ4p
, image->
°¨t
);

199 i‡(
ªsu…
)

200  
ªsu…
;

201  
	`öô_å™sôi⁄_pgèbÀ
(
image
, 
Àvñ4p
);

202 
	}
}

204 
	$£t_idt
(*
√widt
, 
u16
 
limô
)

206 
desc_±r
 
curidt
;

209 
curidt
.
size
 = 
limô
;

210 
curidt
.
addªss
 = ()
√widt
;

212 
__asm__
 
	`__vﬁ©ûe__
 (

214 : : "m" (
curidt
)

216 
	}
};

219 
	$£t_gdt
(*
√wgdt
, 
u16
 
limô
)

221 
desc_±r
 
curgdt
;

224 
curgdt
.
size
 = 
limô
;

225 
curgdt
.
addªss
 = ()
√wgdt
;

227 
__asm__
 
	`__vﬁ©ûe__
 (

229 : : "m" (
curgdt
)

231 
	}
};

233 
	$lﬂd_£gmíts
()

235 
__asm__
 
	`__vﬁ©ûe__
 (

241 : : "a" (
__KERNEL_DS
) : "memory"

243 
	}
}

245 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

247 
°¨t_pgèbÀ
;

248 
ªsu…
;

251 
°¨t_pgèbÀ
 = 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

254 
ªsu…
 = 
	`öô_pgèbÀ
(
image
, 
°¨t_pgèbÀ
);

255 i‡(
ªsu…
)

256  
ªsu…
;

259 
	}
}

261 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

263 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

264 
	}
}

270 
	$machöe_kexec
(
kimage
 *
image
)

272 
∑ge_li°
[
PAGES_NR
];

273 *
c⁄åﬁ_∑ge
;

274 
ßve_·ø˚_íabÀd
;

276 #ifde‡
CONFIG_KEXEC_JUMP


277 i‡(
image
->
¥e£rve_c⁄ãxt
)

278 
	`ßve_¥o˚ss‹_°©e
();

281 
ßve_·ø˚_íabÀd
 = 
	`__·ø˚_íabÀd_ßve
();

284 
	`loˇl_úq_dißbÀ
();

286 i‡(
image
->
¥e£rve_c⁄ãxt
) {

287 #ifde‡
CONFIG_X86_IO_APIC


295 
	`dißbÀ_IO_APIC
();

299 
c⁄åﬁ_∑ge
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
Ë+ 
PAGE_SIZE
;

300 
	`mem˝y
(
c⁄åﬁ_∑ge
, 
ªloˇã_kî√l
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

302 
∑ge_li°
[
PA_CONTROL_PAGE
] = 
	`vút_to_phys
(
c⁄åﬁ_∑ge
);

303 
∑ge_li°
[
VA_CONTROL_PAGE
] = ()
c⁄åﬁ_∑ge
;

304 
∑ge_li°
[
PA_TABLE_PAGE
] =

305 ()
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
));

307 i‡(
image
->
ty≥
 =
KEXEC_TYPE_DEFAULT
)

308 
∑ge_li°
[
PA_SWAP_PAGE
] = (
	`∑ge_to_p‚
(
image
->
sw≠_∑ge
)

309 << 
PAGE_SHIFT
);

321 
	`lﬂd_£gmíts
();

326 
	`£t_gdt
(
	`phys_to_vút
(0), 0);

327 
	`£t_idt
(
	`phys_to_vút
(0), 0);

330 
image
->
°¨t
 = 
	`ªloˇã_kî√l
(()image->
hód
,

331 ()
∑ge_li°
,

332 
image
->
°¨t
,

333 
image
->
¥e£rve_c⁄ãxt
);

335 #ifde‡
CONFIG_KEXEC_JUMP


336 i‡(
image
->
¥e£rve_c⁄ãxt
)

337 
	`ª°‹e_¥o˚ss‹_°©e
();

340 
	`__·ø˚_íabÀd_ª°‹e
(
ßve_·ø˚_íabÀd
);

341 
	}
}

343 
	$¨ch_¸ash_ßve_vmc‹eöfo
()

345 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

346 
	`VMCOREINFO_SYMBOL
(
öô_Àvñ4_pgt
);

348 #ifde‡
CONFIG_NUMA


349 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

350 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

352 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

16 
	~<löux/fúmw¨e.h
>

17 
	~<löux/pci_ids.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/vmÆloc.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/pci.h
>

24 
	~<asm/mi¸ocode.h
>

25 
	~<asm/¥o˚ss‹.h
>

26 
	~<asm/m§.h
>

28 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

29 
MODULE_AUTHOR
("Peter Oruba");

30 
MODULE_LICENSE
("GPL v2");

32 
	#UCODE_MAGIC
 0x00414d44

	)

33 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

34 
	#UCODE_UCODE_TYPE
 0x00000001

	)

36 
	sequiv_˝u_íåy
 {

37 
u32
 
	mö°ÆÀd_˝u
;

38 
u32
 
	mfixed_îøè_mask
;

39 
u32
 
	mfixed_îøè_com∑ª
;

40 
u16
 
	mequiv_˝u
;

41 
u16
 
	mªs
;

42 } 
__©åibuã__
((
∑cked
));

44 
	smi¸ocode_hódî_amd
 {

45 
u32
 
	md©a_code
;

46 
u32
 
	m∑tch_id
;

47 
u16
 
	mmc_∑tch_d©a_id
;

48 
u8
 
	mmc_∑tch_d©a_Àn
;

49 
u8
 
	möô_Êag
;

50 
u32
 
	mmc_∑tch_d©a_checksum
;

51 
u32
 
	mnb_dev_id
;

52 
u32
 
	msb_dev_id
;

53 
u16
 
	m¥o˚ss‹_ªv_id
;

54 
u8
 
	mnb_ªv_id
;

55 
u8
 
	msb_ªv_id
;

56 
u8
 
	mbios_≠i_ªv
;

57 
u8
 
	mª£rved1
[3];

58 
u32
 
	mm©ch_ªg
[8];

59 } 
__©åibuã__
((
∑cked
));

61 
	smi¸ocode_amd
 {

62 
mi¸ocode_hódî_amd
 
	mhdr
;

63 
	mmpb
[0];

66 
	#UCODE_MAX_SIZE
 2048

	)

67 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

68 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

70 
equiv_˝u_íåy
 *
	gequiv_˝u_èbÀ
;

72 
	$cﬁÀ˘_˝u_öfo_amd
(
˝u
, 
˝u_sig«tuª
 *
csig
)

74 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

75 
u32
 
dummy
;

77 
	`mem£t
(
csig
, 0, (*csig));

78 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

79 
	`¥ötk
(
KERN_WARNING
 "microcode: CPU%d: AMD CPU family 0x%xÇot "

80 "suµ‹ãd\n", 
˝u
, 
c
->
x86
);

83 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
ªv
, 
dummy
);

84 
	`¥ötk
(
KERN_INFO
 "mi¸ocode: CPU%d:Ö©ch_Àvñ=0x%x\n", 
˝u
, 
csig
->
ªv
);

86 
	}
}

88 
	$gë_m©chög_mi¸ocode
(
˝u
, *
mc
, 
ªv
)

90 
mi¸ocode_hódî_amd
 *
mc_hódî
 = 
mc
;

91 
cuºít_˝u_id
;

92 
u16
 
equiv_˝u_id
 = 0;

93 
i
 = 0;

95 
	`BUG_ON
(
equiv_˝u_èbÀ
 =
NULL
);

96 
cuºít_˝u_id
 = 
	`˝uid_óx
(0x00000001);

98 
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
 != 0) {

99 i‡(
cuºít_˝u_id
 =
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
) {

100 
equiv_˝u_id
 = 
equiv_˝u_èbÀ
[
i
].
equiv_˝u
;

103 
i
++;

106 i‡(!
equiv_˝u_id
) {

107 
	`¥ötk
(
KERN_WARNING
 "microcode: CPU%d: cpuÑevision "

108 "nŸÜi°ed i¿equivÆíà˝uÅabÀ\n", 
˝u
);

112 i‡(
mc_hódî
->
¥o˚ss‹_ªv_id
 !
equiv_˝u_id
) {

113 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d:Öatch mismatch "

115 
˝u
, 
mc_hódî
->
¥o˚ss‹_ªv_id
, 
equiv_˝u_id
);

120 i‡(
mc_hódî
->
nb_dev_id
 || mc_hódî->
sb_dev_id
) {

121 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d:Üoading of chipset "

122 "•ecifi¯codênŸ yë suµ‹ãd\n", 
˝u
);

126 i‡(
mc_hódî
->
∑tch_id
 <
ªv
)

130 
	}
}

132 
	$≠∂y_mi¸ocode_amd
(
˝u
)

134 
u32
 
ªv
, 
dummy
;

135 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

136 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u_num
;

137 
mi¸ocode_amd
 *
mc_amd
 = 
uci
->
mc
;

140 
	`BUG_ON
(
˝u_num
 !
˝u
);

142 i‡(
mc_amd
 =
NULL
)

145 
	`wrm§l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

147 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
ªv
, 
dummy
);

150 i‡(
ªv
 !
mc_amd
->
hdr
.
∑tch_id
) {

151 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d: update failed "

152 "(f‹Ö©ch_Àvñ=0x%x)\n", 
˝u
, 
mc_amd
->
hdr
.
∑tch_id
);

156 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d: updated (newÖatch_level=0x%x)\n",

157 
˝u
, 
ªv
);

159 
uci
->
˝u_sig
.
ªv
 =Ñev;

162 
	}
}

164 
	$gë_ucode_d©a
(*
to
, c⁄° 
u8
 *
‰om
, 
size_t
 
n
)

166 
	`mem˝y
(
to
, 
‰om
, 
n
);

168 
	}
}

171 
	$gë_√xt_ucode
(c⁄° 
u8
 *
buf
, 
size
, *
mc_size
)

173 
tŸÆ_size
;

174 
u8
 
£˘i⁄_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

175 *
mc
;

177 i‡(
	`gë_ucode_d©a
(
£˘i⁄_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

178  
NULL
;

180 i‡(
£˘i⁄_hdr
[0] !
UCODE_UCODE_TYPE
) {

181 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: invalidÅype field in "

183  
NULL
;

186 
tŸÆ_size
 = (Ë(
£˘i⁄_hdr
[4] + (section_hdr[5] << 8));

188 
	`¥ötk
(
KERN_DEBUG
 "microcode: size %u,Åotal_size %u\n",

189 
size
, 
tŸÆ_size
);

191 i‡(
tŸÆ_size
 > 
size
 ||ÅŸÆ_sizê> 
UCODE_MAX_SIZE
) {

192 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: size mismatch\n");

193  
NULL
;

196 
mc
 = 
	`vmÆloc
(
UCODE_MAX_SIZE
);

197 i‡(
mc
) {

198 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

199 i‡(
	`gë_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

200 
tŸÆ_size
)) {

201 
	`v‰ì
(
mc
);

202 
mc
 = 
NULL
;

204 *
mc_size
 = 
tŸÆ_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

206  
mc
;

207 
	}
}

209 
	$ö°Æl_equiv_˝u_èbÀ
(c⁄° 
u8
 *
buf
)

211 
u8
 *
c⁄èöî_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

212 *
buf_pos
 = (*)
c⁄èöî_hdr
;

213 
size
;

215 i‡(
	`gë_ucode_d©a
(&
c⁄èöî_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

218 
size
 = 
buf_pos
[2];

220 i‡(
buf_pos
[1] !
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

221 
	`¥ötk
(
KERN_ERR
 "microcode:Érror: invalidÅype field in "

226 
equiv_˝u_èbÀ
 = (
equiv_˝u_íåy
 *Ë
	`vmÆloc
(
size
);

227 i‡(!
equiv_˝u_èbÀ
) {

228 
	`¥ötk
(
KERN_ERR
 "microcode: failedÅoállocate "

233 
buf
 +
UCODE_CONTAINER_HEADER_SIZE
;

234 i‡(
	`gë_ucode_d©a
(
equiv_˝u_èbÀ
, 
buf
, 
size
)) {

235 
	`v‰ì
(
equiv_˝u_èbÀ
);

239  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

240 
	}
}

242 
	$‰ì_equiv_˝u_èbÀ
()

244 
	`v‰ì
(
equiv_˝u_èbÀ
);

245 
equiv_˝u_èbÀ
 = 
NULL
;

246 
	}
}

248 
ucode_°©e


249 
	$gíîic_lﬂd_mi¸ocode
(
˝u
, c⁄° 
u8
 *
d©a
, 
size_t
 
size
)

251 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

252 c⁄° 
u8
 *
ucode_±r
 = 
d©a
;

253 *
√w_mc
 = 
NULL
;

254 *
mc
;

255 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

256 
À·ovî
;

257 
off£t
;

258 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

260 
off£t
 = 
	`ö°Æl_equiv_˝u_èbÀ
(
ucode_±r
);

261 i‡(!
off£t
) {

262 
	`¥ötk
(
KERN_ERR
 "microcode: failedÅo create "

264  
UCODE_ERROR
;

267 
ucode_±r
 +
off£t
;

268 
À·ovî
 = 
size
 - 
off£t
;

270 
À·ovî
) {

271 
	`unöôülized_v¨
(
mc_size
);

272 
mi¸ocode_hódî_amd
 *
mc_hódî
;

274 
mc
 = 
	`gë_√xt_ucode
(
ucode_±r
, 
À·ovî
, &
mc_size
);

275 i‡(!
mc
)

278 
mc_hódî
 = (
mi¸ocode_hódî_amd
 *)
mc
;

279 i‡(
	`gë_m©chög_mi¸ocode
(
˝u
, 
mc
, 
√w_ªv
)) {

280 
	`v‰ì
(
√w_mc
);

281 
√w_ªv
 = 
mc_hódî
->
∑tch_id
;

282 
√w_mc
 = 
mc
;

284 
	`v‰ì
(
mc
);

286 
ucode_±r
 +
mc_size
;

287 
À·ovî
 -
mc_size
;

290 i‡(
√w_mc
) {

291 i‡(!
À·ovî
) {

292 
	`v‰ì
(
uci
->
mc
);

293 
uci
->
mc
 = 
√w_mc
;

294 
	`¥_debug
("microcode: CPU%d foundá matching microcode "

296 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

298 
	`v‰ì
(
√w_mc
);

299 
°©e
 = 
UCODE_ERROR
;

302 
°©e
 = 
UCODE_NFOUND
;

304 
	`‰ì_equiv_˝u_èbÀ
();

306  
°©e
;

307 
	}
}

309 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

311 c⁄° *
fw_«me
 = "amd-ucode/microcode_amd.bin";

312 c⁄° 
fúmw¨e
 *firmware;

313 
ucode_°©e
 
ªt
;

315 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
fw_«me
, 
devi˚
)) {

316 
	`¥ötk
(
KERN_ERR
 "mi¸ocode: faûedÅÿlﬂd fûê%s\n", 
fw_«me
);

317  
UCODE_NFOUND
;

320 i‡(*(
u32
 *)
fúmw¨e
->
d©a
 !
UCODE_MAGIC
) {

321 
	`¥ötk
(
KERN_ERR
 "microcode: invalid UCODE_MAGIC (0x%08x)\n",

322 *(
u32
 *)
fúmw¨e
->
d©a
);

323  
UCODE_ERROR
;

326 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, 
fúmw¨e
->
d©a
, fúmw¨e->
size
);

328 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

330  
ªt
;

331 
	}
}

333 
ucode_°©e


334 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

336 
	`¥ötk
(
KERN_INFO
 "microcode: AMD microcode update via "

338  
UCODE_ERROR
;

339 
	}
}

341 
	$mi¸ocode_föi_˝u_amd
(
˝u
)

343 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

345 
	`v‰ì
(
uci
->
mc
);

346 
uci
->
mc
 = 
NULL
;

347 
	}
}

349 
mi¸ocode_›s
 
	gmi¸ocode_amd_›s
 = {

350 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

351 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

352 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo_amd
,

353 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode_amd
,

354 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u_amd
,

357 
mi¸ocode_›s
 * 
__öô
 
	$öô_amd_mi¸ocode
()

359  &
mi¸ocode_amd_›s
;

360 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

73 
	~<löux/∂©f‹m_devi˚.h
>

74 
	~<löux/miscdevi˚.h
>

75 
	~<löux/ˇ∑bûôy.h
>

76 
	~<löux/smp_lock.h
>

77 
	~<löux/kî√l.h
>

78 
	~<löux/moduÀ.h
>

79 
	~<löux/muãx.h
>

80 
	~<löux/˝u.h
>

81 
	~<löux/fs.h
>

82 
	~<löux/mm.h
>

84 
	~<asm/mi¸ocode.h
>

85 
	~<asm/¥o˚ss‹.h
>

87 
MODULE_DESCRIPTION
("Microcode Update Driver");

88 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

89 
MODULE_LICENSE
("GPL");

91 
	#MICROCODE_VERSION
 "2.00"

	)

93 
mi¸ocode_›s
 *
	gmi¸ocode_›s
;

107 
DEFINE_MUTEX
(
mi¸ocode_muãx
);

109 
ucode_˝u_öfo
 
	gucode_˝u_öfo
[
NR_CPUS
];

110 
EXPORT_SYMBOL_GPL
(
ucode_˝u_öfo
);

116 
	s˝u_öfo_˘x
 {

117 
˝u_sig«tuª
 *
	m˝u_sig
;

118 
	mîr
;

121 
	$cﬁÀ˘_˝u_öfo_loˇl
(*
¨g
)

123 
˝u_öfo_˘x
 *
˘x
 = 
¨g
;

125 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`cﬁÀ˘_˝u_öfo
(
	`smp_¥o˚ss‹_id
(),

126 
˘x
->
˝u_sig
);

127 
	}
}

129 
	$cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, 
˝u_sig«tuª
 *
˝u_sig
)

131 
˝u_öfo_˘x
 
˘x
 = { .
˝u_sig
 = cpu_sig, .
îr
 = 0 };

132 
ªt
;

134 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
cﬁÀ˘_˝u_öfo_loˇl
, &
˘x
, 1);

135 i‡(!
ªt
)

136 
ªt
 = 
˘x
.
îr
;

138  
ªt
;

139 
	}
}

141 
	$cﬁÀ˘_˝u_öfo
(
˝u
)

143 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

144 
ªt
;

146 
	`mem£t
(
uci
, 0, (*uci));

148 
ªt
 = 
	`cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, &
uci
->
˝u_sig
);

149 i‡(!
ªt
)

150 
uci
->
vÆid
 = 1;

152  
ªt
;

153 
	}
}

155 
	s≠∂y_mi¸ocode_˘x
 {

156 
	mîr
;

159 
	$≠∂y_mi¸ocode_loˇl
(*
¨g
)

161 
≠∂y_mi¸ocode_˘x
 *
˘x
 = 
¨g
;

163 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
	`smp_¥o˚ss‹_id
());

164 
	}
}

166 
	$≠∂y_mi¸ocode_⁄_èrgë
(
˝u
)

168 
≠∂y_mi¸ocode_˘x
 
˘x
 = { .
îr
 = 0 };

169 
ªt
;

171 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
≠∂y_mi¸ocode_loˇl
, &
˘x
, 1);

172 i‡(!
ªt
)

173 
ªt
 = 
˘x
.
îr
;

175  
ªt
;

176 
	}
}

178 #ifde‡
CONFIG_MICROCODE_OLD_INTERFACE


179 
	$do_mi¸ocode_upd©e
(c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

181 
îr‹
 = 0;

182 
˝u
;

184 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

185 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

186 
ucode_°©e
 
u°©e
;

188 i‡(!
uci
->
vÆid
)

191 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_u£r
(
˝u
, 
buf
, 
size
);

192 i‡(
u°©e
 =
UCODE_ERROR
) {

193 
îr‹
 = -1;

195 } i‡(
u°©e
 =
UCODE_OK
)

196 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

199  
îr‹
;

200 
	}
}

202 
	$mi¸ocode_›í
(
öode
 *
unu£d1
, 
fûe
 *
unu£d2
)

204 
	`cy˛e_kî√l_lock
();

205  
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
Ë? 0 : -
EPERM
;

206 
	}
}

208 
ssize_t
 
	$mi¸ocode_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

209 
size_t
 
Àn
, 
loff_t
 *
µos
)

211 
ssize_t
 
ªt
 = -
EINVAL
;

213 i‡((
Àn
 >> 
PAGE_SHIFT
Ë> 
tŸÆøm_∑ges
) {

214 
	`¥_îr
("mi¸ocode:Åoÿmuch d©®(max %ldÖages)\n", 
tŸÆøm_∑ges
);

215  
ªt
;

218 
	`gë_⁄löe_˝us
();

219 
	`muãx_lock
(&
mi¸ocode_muãx
);

221 i‡(
	`do_mi¸ocode_upd©e
(
buf
, 
Àn
) == 0)

222 
ªt
 = (
ssize_t
)
Àn
;

224 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

225 
	`put_⁄löe_˝us
();

227  
ªt
;

228 
	}
}

230 c⁄° 
fûe_›î©i⁄s
 
	gmi¸ocode_f›s
 = {

231 .
ow√r
 = 
THIS_MODULE
,

232 .
	gwrôe
 = 
mi¸ocode_wrôe
,

233 .
	g›í
 = 
mi¸ocode_›í
,

236 
miscdevi˚
 
	gmi¸ocode_dev
 = {

237 .
mö‹
 = 
MICROCODE_MINOR
,

238 .
	g«me
 = "microcode",

239 .
	gnodíame
 = "cpu/microcode",

240 .
	gf›s
 = &
mi¸ocode_f›s
,

243 
__öô
 
	$mi¸ocode_dev_öô
()

245 
îr‹
;

247 
îr‹
 = 
	`misc_ªgi°î
(&
mi¸ocode_dev
);

248 i‡(
îr‹
) {

249 
	`¥_îr
("mi¸ocode: c™'àmisc_ªgi°î o¿mö‹=%d\n", 
MICROCODE_MINOR
);

250  
îr‹
;

254 
	}
}

256 
	$mi¸ocode_dev_exô
()

258 
	`misc_dîegi°î
(&
mi¸ocode_dev
);

259 
	}
}

261 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

263 
	#mi¸ocode_dev_öô
(Ë0

	)

264 
	#mi¸ocode_dev_exô
(Ëdÿ{ } 0)

	)

268 
∂©f‹m_devi˚
 *
	gmi¸ocode_pdev
;

270 
	$ªlﬂd_f‹_˝u
(
˝u
)

272 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

273 
îr
 = 0;

275 
	`muãx_lock
(&
mi¸ocode_muãx
);

276 i‡(
uci
->
vÆid
) {

277 
ucode_°©e
 
u°©e
;

279 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

280 i‡(
u°©e
 =
UCODE_OK
)

281 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

283 i‡(
u°©e
 =
UCODE_ERROR
)

284 
îr
 = -
EINVAL
;

286 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

288  
îr
;

289 
	}
}

291 
ssize_t
 
	$ªlﬂd_°‹e
(
sys_devi˚
 *
dev
,

292 
sysdev_©åibuã
 *
©å
,

293 c⁄° *
buf
, 
size_t
 
size
)

295 
vÆ
;

296 
˝u
 = 
dev
->
id
;

297 
ªt
 = 0;

298 *
íd
;

300 
vÆ
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

301 i‡(
íd
 =
buf
)

302  -
EINVAL
;

304 i‡(
vÆ
 == 1) {

305 
	`gë_⁄löe_˝us
();

306 i‡(
	`˝u_⁄löe
(
˝u
))

307 
ªt
 = 
	`ªlﬂd_f‹_˝u
(
˝u
);

308 
	`put_⁄löe_˝us
();

311 i‡(!
ªt
)

312 
ªt
 = 
size
;

314  
ªt
;

315 
	}
}

317 
ssize_t
 
	$vîsi⁄_show
(
sys_devi˚
 *
dev
,

318 
sysdev_©åibuã
 *
©å
, *
buf
)

320 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

322  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
ªv
);

323 
	}
}

325 
ssize_t
 
	$pf_show
(
sys_devi˚
 *
dev
,

326 
sysdev_©åibuã
 *
©å
, *
buf
)

328 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

330  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
pf
);

331 
	}
}

333 
SYSDEV_ATTR
(
ªlﬂd
, 0200, 
NULL
, 
ªlﬂd_°‹e
);

334 
SYSDEV_ATTR
(
vîsi⁄
, 0400, 
vîsi⁄_show
, 
NULL
);

335 
SYSDEV_ATTR
(
¥o˚ss‹_Êags
, 0400, 
pf_show
, 
NULL
);

337 
©åibuã
 *
	gmc_deÁu…_©ås
[] = {

338 &
©å_ªlﬂd
.
©å
,

339 &
©å_vîsi⁄
.
©å
,

340 &
©å_¥o˚ss‹_Êags
.
©å
,

341 
NULL


344 
©åibuã_group
 
	gmc_©å_group
 = {

345 .
©ås
 = 
mc_deÁu…_©ås
,

346 .
	g«me
 = "microcode",

349 
	$mi¸ocode_föi_˝u
(
˝u
)

351 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

353 
mi¸ocode_›s
->
	`mi¸ocode_föi_˝u
(
˝u
);

354 
uci
->
vÆid
 = 0;

355 
	}
}

357 
ucode_°©e
 
	$mi¸ocode_ªsume_˝u
(
˝u
)

359 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

361 i‡(!
uci
->
mc
)

362  
UCODE_NFOUND
;

364 
	`¥_debug
("mi¸ocode: CPU%d upd©ed up⁄Ñesume\n", 
˝u
);

365 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

367  
UCODE_OK
;

368 
	}
}

370 
ucode_°©e
 
	$mi¸ocode_öô_˝u
(
˝u
)

372 
ucode_°©e
 
u°©e
;

374 i‡(
	`cﬁÀ˘_˝u_öfo
(
˝u
))

375  
UCODE_ERROR
;

378 i‡(
sy°em_°©e
 !
SYSTEM_RUNNING
)

379  
UCODE_NFOUND
;

381 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

383 i‡(
u°©e
 =
UCODE_OK
) {

384 
	`¥_debug
("mi¸ocode: CPU%d upd©ed up⁄ inô\n", 
˝u
);

385 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

388  
u°©e
;

389 
	}
}

391 
ucode_°©e
 
	$mi¸ocode_upd©e_˝u
(
˝u
)

393 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

394 
ucode_°©e
 
u°©e
;

396 i‡(
uci
->
vÆid
)

397 
u°©e
 = 
	`mi¸ocode_ªsume_˝u
(
˝u
);

399 
u°©e
 = 
	`mi¸ocode_öô_˝u
(
˝u
);

401  
u°©e
;

402 
	}
}

404 
	$mc_sysdev_add
(
sys_devi˚
 *
sys_dev
)

406 
îr
, 
˝u
 = 
sys_dev
->
id
;

408 i‡(!
	`˝u_⁄löe
(
˝u
))

411 
	`¥_debug
("mi¸ocode: CPU%dádded\n", 
˝u
);

413 
îr
 = 
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

414 i‡(
îr
)

415  
îr
;

417 i‡(
	`mi¸ocode_öô_˝u
(
˝u
Ë=
UCODE_ERROR
)

418 
îr
 = -
EINVAL
;

420  
îr
;

421 
	}
}

423 
	$mc_sysdev_ªmove
(
sys_devi˚
 *
sys_dev
)

425 
˝u
 = 
sys_dev
->
id
;

427 i‡(!
	`˝u_⁄löe
(
˝u
))

430 
	`¥_debug
("mi¸ocode: CPU%dÑemoved\n", 
˝u
);

431 
	`mi¸ocode_föi_˝u
(
˝u
);

432 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

434 
	}
}

436 
	$mc_sysdev_ªsume
(
sys_devi˚
 *
dev
)

438 
˝u
 = 
dev
->
id
;

439 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

441 i‡(!
	`˝u_⁄löe
(
˝u
))

451 
	`WARN_ON
(
˝u
 != 0);

453 i‡(
uci
->
vÆid
 && uci->
mc
)

454 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
˝u
);

457 
	}
}

459 
sysdev_drivî
 
	gmc_sysdev_drivî
 = {

460 .
add
 = 
mc_sysdev_add
,

461 .
	gªmove
 = 
mc_sysdev_ªmove
,

462 .
	gªsume
 = 
mc_sysdev_ªsume
,

465 
__˝uöô
 

466 
	$mc_˝u_ˇŒback
(
nŸifõr_block
 *
nb
, 
a˘i⁄
, *
h˝u
)

468 
˝u
 = ()
h˝u
;

469 
sys_devi˚
 *
sys_dev
;

471 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

472 
a˘i⁄
) {

473 
CPU_ONLINE
:

474 
CPU_ONLINE_FROZEN
:

475 
	`mi¸ocode_upd©e_˝u
(
˝u
);

476 
CPU_DOWN_FAILED
:

477 
CPU_DOWN_FAILED_FROZEN
:

478 
	`¥_debug
("mi¸ocode: CPU%dádded\n", 
˝u
);

479 i‡(
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
))

480 
	`¥_îr
("mi¸ocode: FaûedÅÿ¸óã grou∞f‹ CPU%d\n", 
˝u
);

482 
CPU_DOWN_PREPARE
:

483 
CPU_DOWN_PREPARE_FROZEN
:

485 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

486 
	`¥_debug
("mi¸ocode: CPU%dÑemoved\n", 
˝u
);

488 
CPU_DEAD
:

489 
CPU_UP_CANCELED_FROZEN
:

491 
	`mi¸ocode_föi_˝u
(
˝u
);

494  
NOTIFY_OK
;

495 
	}
}

497 
nŸifõr_block
 
__ªfd©a
 
	gmc_˝u_nŸifõr
 = {

498 .
nŸifõr_ˇŒ
 = 
mc_˝u_ˇŒback
,

501 
__öô
 
	$mi¸ocode_öô
()

503 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(0);

504 
îr‹
;

506 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

507 
mi¸ocode_›s
 = 
	`öô_öãl_mi¸ocode
();

508 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)

509 
mi¸ocode_›s
 = 
	`öô_amd_mi¸ocode
();

511 i‡(!
mi¸ocode_›s
) {

512 
	`¥_îr
("microcode:Ço support forÅhis CPU vendor\n");

513  -
ENODEV
;

516 
mi¸ocode_pdev
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("microcode", -1,

517 
NULL
, 0);

518 i‡(
	`IS_ERR
(
mi¸ocode_pdev
)) {

519 
	`mi¸ocode_dev_exô
();

520  
	`PTR_ERR
(
mi¸ocode_pdev
);

523 
	`gë_⁄löe_˝us
();

524 
	`muãx_lock
(&
mi¸ocode_muãx
);

526 
îr‹
 = 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

528 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

529 
	`put_⁄löe_˝us
();

531 i‡(
îr‹
) {

532 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

533  
îr‹
;

536 
îr‹
 = 
	`mi¸ocode_dev_öô
();

537 i‡(
îr‹
)

538  
îr‹
;

540 
	`ªgi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

542 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION


547 
	}
}

548 
moduÀ_öô
(
mi¸ocode_öô
);

550 
__exô
 
	$mi¸ocode_exô
()

552 
	`mi¸ocode_dev_exô
();

554 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

556 
	`gë_⁄löe_˝us
();

557 
	`muãx_lock
(&
mi¸ocode_muãx
);

559 
	`sysdev_drivî_uƒegi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

561 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

562 
	`put_⁄löe_˝us
();

564 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

566 
mi¸ocode_›s
 = 
NULL
;

568 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION
 "Ñemoved.\n");

569 
	}
}

570 
moduÀ_exô
(
mi¸ocode_exô
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

73 
	~<löux/fúmw¨e.h
>

74 
	~<löux/uac˚ss.h
>

75 
	~<löux/kî√l.h
>

76 
	~<löux/moduÀ.h
>

77 
	~<löux/vmÆloc.h
>

79 
	~<asm/mi¸ocode.h
>

80 
	~<asm/¥o˚ss‹.h
>

81 
	~<asm/m§.h
>

83 
MODULE_DESCRIPTION
("Microcode Update Driver");

84 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

85 
MODULE_LICENSE
("GPL");

87 
	smi¸ocode_hódî_öãl
 {

88 
	mhdrvî
;

89 
	mªv
;

90 
	md©e
;

91 
	msig
;

92 
	mcksum
;

93 
	mldrvî
;

94 
	mpf
;

95 
	md©asize
;

96 
	mtŸÆsize
;

97 
	mª£rved
[3];

100 
	smi¸ocode_öãl
 {

101 
mi¸ocode_hódî_öãl
 
	mhdr
;

102 
	mbôs
[0];

106 
	sexãnded_sig«tuª
 {

107 
	msig
;

108 
	mpf
;

109 
	mcksum
;

112 
	sexãnded_sigèbÀ
 {

113 
	mcou¡
;

114 
	mcksum
;

115 
	mª£rved
[3];

116 
exãnded_sig«tuª
 
	msigs
[0];

119 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

120 
	#MC_HEADER_SIZE
 ((
mi¸ocode_hódî_öãl
))

	)

121 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

122 
	#EXT_HEADER_SIZE
 ((
exãnded_sigèbÀ
))

	)

123 
	#EXT_SIGNATURE_SIZE
 ((
exãnded_sig«tuª
))

	)

124 
	#DWSIZE
 ((
u32
))

	)

126 
	#gë_tŸÆsize
(
mc
) \

127 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 ? \

128 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 : \

129 
DEFAULT_UCODE_TOTALSIZE
)

	)

131 
	#gë_d©asize
(
mc
) \

132 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 ? \

133 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

135 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

136 (((
s1
Ë=(
s2
)Ë&& (((
p1
Ë& (
p2
)Ë|| ((’1Ë=0Ë&& (’2Ë=0))))

	)

138 
	#exâabÀ_size
(
ë
Ë(”t)->
cou¡
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

140 
	$cﬁÀ˘_˝u_öfo
(
˝u_num
, 
˝u_sig«tuª
 *
csig
)

142 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u_num
);

143 
vÆ
[2];

145 
	`mem£t
(
csig
, 0, (*csig));

147 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

148 
	`˝u_has
(
c
, 
X86_FEATURE_IA64
)) {

149 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%dÇotá capable Intel "

150 "¥o˚ss‹\n", 
˝u_num
);

154 
csig
->
sig
 = 
	`˝uid_óx
(0x00000001);

156 i‡((
c
->
x86_modñ
 >5Ë|| (c->
x86
 > 6)) {

158 
	`rdm§
(
MSR_IA32_PLATFORM_ID
, 
vÆ
[0], val[1]);

159 
csig
->
pf
 = 1 << ((
vÆ
[1] >> 18) & 7);

162 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

164 
	`sync_c‹e
();

166 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], 
csig
->
ªv
);

168 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d sig=0x%x,Öf=0x%x,Ñevision=0x%x\n",

169 
˝u_num
, 
csig
->
sig
, csig->
pf
, csig->
ªv
);

172 
	}
}

174 
ölöe
 
	$upd©e_m©ch_˝u
(
˝u_sig«tuª
 *
csig
, 
sig
, 
pf
)

176  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

177 
	}
}

179 
ölöe
 

180 
	$upd©e_m©ch_ªvisi⁄
(
mi¸ocode_hódî_öãl
 *
mc_hódî
, 
ªv
)

182  (
mc_hódî
->
ªv
 <=Ñev) ? 0 : 1;

183 
	}
}

185 
	$mi¸ocode_ßnôy_check
(*
mc
)

187 
tŸÆ_size
, 
d©a_size
, 
ext_èbÀ_size
;

188 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

189 
exãnded_sigèbÀ
 *
ext_hódî
 = 
NULL
;

190 
sum
, 
‹ig_sum
, 
ext_sigcou¡
 = 0, 
i
;

191 
exãnded_sig«tuª
 *
ext_sig
;

193 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

194 
d©a_size
 = 
	`gë_d©asize
(
mc_hódî
);

196 i‡(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tŸÆ_size
) {

197 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

199  -
EINVAL
;

202 i‡(
mc_hódî
->
ldrvî
 !1 || mc_hódî->
hdrvî
 != 1) {

203 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

205  -
EINVAL
;

207 
ext_èbÀ_size
 = 
tŸÆ_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

208 i‡(
ext_èbÀ_size
) {

209 i‡((
ext_èbÀ_size
 < 
EXT_HEADER_SIZE
)

210 || ((
ext_èbÀ_size
 - 
EXT_HEADER_SIZE
Ë% 
EXT_SIGNATURE_SIZE
)) {

211 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

213  -
EINVAL
;

215 
ext_hódî
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

216 i‡(
ext_èbÀ_size
 !
	`exâabÀ_size
(
ext_hódî
)) {

217 
	`¥ötk
(
KERN_ERR
 "microcode:Érror! "

219  -
EFAULT
;

221 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

225 i‡(
ext_èbÀ_size
) {

226 
ext_èbÀ_sum
 = 0;

227 *
ext_èbÀp
 = (*)
ext_hódî
;

229 
i
 = 
ext_èbÀ_size
 / 
DWSIZE
;

230 
i
--)

231 
ext_èbÀ_sum
 +
ext_èbÀp
[
i
];

232 i‡(
ext_èbÀ_sum
) {

233 
	`¥ötk
(
KERN_WARNING
 "microcode:áborting, "

235  -
EINVAL
;

240 
‹ig_sum
 = 0;

241 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
Ë/ 
DWSIZE
;

242 
i
--)

243 
‹ig_sum
 +((*)
mc
)[
i
];

244 i‡(
‹ig_sum
) {

245 
	`¥ötk
(
KERN_ERR
 "microcode:áborting, bad checksum\n");

246  -
EINVAL
;

248 i‡(!
ext_èbÀ_size
)

251 
i
 = 0; i < 
ext_sigcou¡
; i++) {

252 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
 +

253 
EXT_SIGNATURE_SIZE
 * 
i
;

254 
sum
 = 
‹ig_sum


255 - (
mc_hódî
->
sig
 + mc_hódî->
pf
 + mc_hódî->
cksum
)

256 + (
ext_sig
->
sig
 +Éxt_sig->
pf
 +Éxt_sig->
cksum
);

257 i‡(
sum
) {

258 
	`¥ötk
(
KERN_ERR
 "microcode:áborting, bad checksum\n");

259  -
EINVAL
;

263 
	}
}

270 
	$gë_m©chög_mi¸ocode
(
˝u_sig«tuª
 *
˝u_sig
, *
mc
, 
ªv
)

272 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

273 
exãnded_sigèbÀ
 *
ext_hódî
;

274 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

275 
ext_sigcou¡
, 
i
;

276 
exãnded_sig«tuª
 *
ext_sig
;

278 i‡(!
	`upd©e_m©ch_ªvisi⁄
(
mc_hódî
, 
ªv
))

281 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
mc_hódî
->
sig
, mc_hódî->
pf
))

285 i‡(
tŸÆ_size
 <
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
)

288 
ext_hódî
 = 
mc
 + 
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
;

289 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

290 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
;

292 
i
 = 0; i < 
ext_sigcou¡
; i++) {

293 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
ext_sig
->
sig
,Éxt_sig->
pf
))

295 
ext_sig
++;

298 
	}
}

300 
	$≠∂y_mi¸ocode
(
˝u
)

302 
mi¸ocode_öãl
 *
mc_öãl
;

303 
ucode_˝u_öfo
 *
uci
;

304 
vÆ
[2];

305 
˝u_num
;

307 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

308 
uci
 = 
ucode_˝u_öfo
 + 
˝u
;

309 
mc_öãl
 = 
uci
->
mc
;

312 
	`BUG_ON
(
˝u_num
 !
˝u
);

314 i‡(
mc_öãl
 =
NULL
)

318 
	`wrm§
(
MSR_IA32_UCODE_WRITE
,

319 (Ë
mc_öãl
->
bôs
,

320 (Ë
mc_öãl
->
bôs
 >> 16 >> 16);

321 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

324 
	`sync_c‹e
();

327 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], val[1]);

329 i‡(
vÆ
[1] !
mc_öãl
->
hdr
.
ªv
) {

330 
	`¥ötk
(
KERN_ERR
 "microcode: CPU%d update "

332 
˝u_num
, 
mc_öãl
->
hdr
.
ªv
);

335 
	`¥ötk
(
KERN_INFO
 "microcode: CPU%d updatedÅoÑevision "

337 
˝u_num
, 
vÆ
[1],

338 
mc_öãl
->
hdr
.
d©e
 & 0xffff,

339 
mc_öãl
->
hdr
.
d©e
 >> 24,

340 (
mc_öãl
->
hdr
.
d©e
 >> 16) & 0xff);

342 
uci
->
˝u_sig
.
ªv
 = 
vÆ
[1];

345 
	}
}

347 
ucode_°©e
 
gíîic_lﬂd_mi¸ocode
(
˝u
, *
d©a
, 
size_t
 
size
,

348 (*
gë_ucode_d©a
)(*, c⁄° *, 
size_t
))

350 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

351 
u8
 *
ucode_±r
 = 
d©a
, *
√w_mc
 = 
NULL
, *
mc
;

352 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

353 
À·ovî
 = 
size
;

354 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

356 
À·ovî
) {

357 
mi¸ocode_hódî_öãl
 
mc_hódî
;

358 
mc_size
;

360 i‡(
	`gë_ucode_d©a
(&
mc_hódî
, 
ucode_±r
, (mc_header)))

363 
mc_size
 = 
	`gë_tŸÆsize
(&
mc_hódî
);

364 i‡(!
mc_size
 || mc_sizê> 
À·ovî
) {

365 
	`¥ötk
(
KERN_ERR
 "microcode:Érror!"

370 
mc
 = 
	`vmÆloc
(
mc_size
);

371 i‡(!
mc
)

374 i‡(
	`gë_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

375 
	`mi¸ocode_ßnôy_check
(
mc
) < 0) {

376 
	`v‰ì
(
mc
);

380 i‡(
	`gë_m©chög_mi¸ocode
(&
uci
->
˝u_sig
, 
mc
, 
√w_ªv
)) {

381 i‡(
√w_mc
)

382 
	`v‰ì
(
√w_mc
);

383 
√w_ªv
 = 
mc_hódî
.
ªv
;

384 
√w_mc
 = 
mc
;

386 
	`v‰ì
(
mc
);

388 
ucode_±r
 +
mc_size
;

389 
À·ovî
 -
mc_size
;

392 i‡(
À·ovî
) {

393 i‡(
√w_mc
)

394 
	`v‰ì
(
√w_mc
);

395 
°©e
 = 
UCODE_ERROR
;

396 
out
;

399 i‡(!
√w_mc
) {

400 
°©e
 = 
UCODE_NFOUND
;

401 
out
;

404 i‡(
uci
->
mc
)

405 
	`v‰ì
(
uci
->
mc
);

406 
uci
->
mc
 = (
mi¸ocode_öãl
 *)
√w_mc
;

408 
	`¥_debug
("microcode: CPU%d foundá matching microcode update with"

410 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

411 
out
:

412  
°©e
;

413 
	}
}

415 
	$gë_ucode_fw
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

417 
	`mem˝y
(
to
, 
‰om
, 
n
);

419 
	}
}

421 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

423 
«me
[30];

424 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

425 c⁄° 
fúmw¨e
 *firmware;

426 
ucode_°©e
 
ªt
;

428 
	`•rötf
(
«me
, "intel-ucode/%02x-%02x-%02x",

429 
c
->
x86
, c->
x86_modñ
, c->
x86_mask
);

431 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
«me
, 
devi˚
)) {

432 
	`¥_debug
("mi¸ocode: d©®fûê%†lﬂd faûed\n", 
«me
);

433  
UCODE_NFOUND
;

436 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
fúmw¨e
->
d©a
,

437 
fúmw¨e
->
size
, &
gë_ucode_fw
);

439 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

441  
ªt
;

442 
	}
}

444 
	$gë_ucode_u£r
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

446  
	`c›y_‰om_u£r
(
to
, 
‰om
, 
n
);

447 
	}
}

449 
ucode_°©e


450 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

452  
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
buf
, 
size
, &
gë_ucode_u£r
);

453 
	}
}

455 
	$mi¸ocode_föi_˝u
(
˝u
)

457 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

459 
	`v‰ì
(
uci
->
mc
);

460 
uci
->
mc
 = 
NULL
;

461 
	}
}

463 
mi¸ocode_›s
 
	gmi¸ocode_öãl_›s
 = {

464 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

465 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

466 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo
,

467 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode
,

468 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u
,

471 
mi¸ocode_›s
 * 
__öô
 
	$öô_öãl_mi¸ocode
()

473  &
mi¸ocode_öãl_›s
;

474 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/dmi.h
>

10 
	~<asm/pci-dúe˘.h
>

11 
	~<löux/s‹t.h
>

12 
	~<asm/io.h
>

13 
	~<asm/m§.h
>

14 
	~<asm/a˝i.h
>

15 
	~<asm/mmc⁄fig.h
>

16 
	~<asm/pci_x86.h
>

18 
	spci_ho°bridge_¥obe
 {

19 
u32
 
	mbus
;

20 
u32
 
	m¶Ÿ
;

21 
u32
 
	mvíd‹
;

22 
u32
 
	mdevi˚
;

25 
u64
 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£
;

26 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£_°©us
;

28 
pci_ho°bridge_¥obe
 
	gpci_¥obes
[] 
	g__˝uöôd©a
 = {

29 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

30 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

33 
	sønge
 {

34 
u64
 
	m°¨t
;

35 
u64
 
	míd
;

38 
__˝uöô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

40 c⁄° 
ønge
 *
r1
 = 
x1
;

41 c⁄° 
ønge
 *
r2
 = 
x2
;

42 
°¨t1
, 
°¨t2
;

44 
°¨t1
 = 
r1
->
°¨t
 >> 32;

45 
°¨t2
 = 
r2
->
°¨t
 >> 32;

47  
°¨t1
 - 
°¨t2
;

48 
	}
}

52 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

53 
	#BASE_VALID
(
b
Ë((b !(0xfdULL << 32)Ë&& (b !(0x„ULL << 32)))

	)

54 
__˝uöô
 
	$gë_Ám10h_pci_mmc⁄f_ba£
()

56 
i
;

57 
bus
;

58 
¶Ÿ
;

59 
found
;

61 
u64
 
vÆ
;

62 
u32
 
addªss
;

63 
u64
 
tom2
;

64 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

66 
hi_mmio_num
;

67 
ønge
Ñange[8];

71 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
)

74 i‡(!
	`óæy_pci_Ælowed
())

75 
Áû
;

77 
found
 = 0;

78 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_¥obes
); i++) {

79 
u32
 
id
;

80 
u16
 
devi˚
;

81 
u16
 
víd‹
;

83 
bus
 = 
pci_¥obes
[
i
].bus;

84 
¶Ÿ
 = 
pci_¥obes
[
i
].slot;

85 
id
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 0, 
PCI_VENDOR_ID
);

87 
víd‹
 = 
id
 & 0xffff;

88 
devi˚
 = (
id
>>16) & 0xffff;

89 i‡(
pci_¥obes
[
i
].
víd‹
 == vendor &&

90 
pci_¥obes
[
i
].
devi˚
 == device) {

91 
found
 = 1;

96 i‡(!
found
)

97 
Áû
;

100 
addªss
 = 
MSR_K8_SYSCFG
;

101 
	`rdm§l
(
addªss
, 
vÆ
);

104 i‡(!(
vÆ
 & (1<<21))) {

105 
tom2
 = 0;

108 
addªss
 = 
MSR_K8_TOP_MEM2
;

109 
	`rdm§l
(
addªss
, 
vÆ
);

110 
tom2
 = 
vÆ
 & (0xffffULL<<32);

113 i‡(
ba£
 <
tom2
)

114 
ba£
 = 
tom2
 + (1ULL<<32);

120 
hi_mmio_num
 = 0;

121 
i
 = 0; i < 8; i++) {

122 
u32
 
ªg
;

123 
u64
 
°¨t
;

124 
u64
 
íd
;

125 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x80 + (
i
 << 3));

126 i‡(!(
ªg
 & 3))

129 
°¨t
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

130 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x84 + (
i
 << 3));

131 
íd
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

133 i‡(!
íd
)

136 
ønge
[
hi_mmio_num
].
°¨t
 = start;

137 
ønge
[
hi_mmio_num
].
íd
 =Énd;

138 
hi_mmio_num
++;

141 i‡(!
hi_mmio_num
)

142 
out
;

145 
	`s‹t
(
ønge
, 
hi_mmio_num
, (ønge), 
cmp_ønge
, 
NULL
);

147 i‡(
ønge
[
hi_mmio_num
 - 1].
íd
 < 
ba£
)

148 
out
;

149 i‡(
ønge
[0].
°¨t
 > 
ba£
)

150 
out
;

153 
ba£
 = 
ønge
[0].
°¨t
 - (1ULL << 32);

154 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

155 
out
;

156 
ba£
 = 
ønge
[
hi_mmio_num
 - 1].
íd
 + (1ULL << 32);

157 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

158 
out
;

160 i‡(
hi_mmio_num
 > 1)

161 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

162 i‡(
ønge
[
i
 + 1].
°¨t
 > (ønge[i].
íd
 + (1ULL << 32))) {

163 
ba£
 = 
ønge
[
i
].
íd
 + (1ULL << 32);

164 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

165 
out
;

169 
Áû
:

170 
Ám10h_pci_mmc⁄f_ba£_°©us
 = -1;

172 
out
:

173 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

174 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

175 
	}
}

177 
__˝uöô
 
	$Ám10h_check_íabÀ_mmcfg
()

179 
u64
 
vÆ
;

180 
u32
 
addªss
;

182 i‡(!(
pci_¥obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

185 
addªss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

186 
	`rdm§l
(
addªss
, 
vÆ
);

189 i‡(
vÆ
 & 
FAM10H_MMIO_CONF_ENABLE
) {

190 
bu¢bôs
;

191 
bu¢bôs
 = (
vÆ
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

192 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

195 i‡(!
a˝i_pci_dißbÀd
 || 
bu¢bôs
 >= 8) {

196 
u64
 
ba£
;

197 
ba£
 = 
vÆ
 & (0xffffULL << 32);

198 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0) {

199 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

200 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

202 } i‡(
Ám10h_pci_mmc⁄f_ba£
 =
ba£
)

211 
	`gë_Ám10h_pci_mmc⁄f_ba£
();

212 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0)

215 
	`¥ötk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

216 
vÆ
 &~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

217 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

218 
vÆ
 |
Ám10h_pci_mmc⁄f_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

219 
FAM10H_MMIO_CONF_ENABLE
;

220 
	`wrm§l
(
addªss
, 
vÆ
);

221 
	}
}

223 
__devöô
 
	$£t_check_íabÀ_amd_mmc⁄f
(c⁄° 
dmi_sy°em_id
 *
d
)

225 
pci_¥obe
 |
PCI_CHECK_ENABLE_AMD_MMCONF
;

227 
	}
}

229 c⁄° 
dmi_sy°em_id
 
__˝uöôc⁄°
 
	gmmc⁄f_dmi_èbÀ
[] = {

231 .
ˇŒback
 = 
£t_check_íabÀ_amd_mmc⁄f
,

232 .
	gidít
 = "Sun Microsystems Machine",

233 .
	gm©ches
 = {

234 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

240 
__˝uöô
 
	$check_íabÀ_amd_mmc⁄f_dmi
()

242 
	`dmi_check_sy°em
(
mmc⁄f_dmi_èbÀ
);

243 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/bug.h
>

25 
	~<löux/mm.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/pgèbÀ.h
>

32 
	#DEBUGP
 
¥ötk


	)

34 
	#DEBUGP
(
fmt
...)

	)

37 *
	$moduÀ_Æloc
(
size
)

39 
vm_°ru˘
 *
¨ó
;

41 i‡(!
size
)

42  
NULL
;

43 
size
 = 
	`PAGE_ALIGN
(size);

44 i‡(
size
 > 
MODULES_LEN
)

45  
NULL
;

47 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

48 i‡(!
¨ó
)

49  
NULL
;

51  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
,

52 
PAGE_KERNEL_EXEC
);

53 
	}
}

56 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

58 
	`v‰ì
(
moduÀ_ªgi⁄
);

59 
	}
}

62 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

63 
Elf_Shdr
 *
£chdrs
,

64 *
£c°rögs
,

65 
moduÀ
 *
mod
)

68 
	}
}

70 #ifde‡
CONFIG_X86_32


71 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
,

72 c⁄° *
°πab
,

73 
symödex
,

74 
ªl£c
,

75 
moduÀ
 *
me
)

77 
i
;

78 
Elf32_Rñ
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

79 
Elf32_Sym
 *
sym
;

80 
uöt32_t
 *
loˇti⁄
;

82 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

83 
£chdrs
[
ªl£c
].
sh_öfo
);

84 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

86 
loˇti⁄
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


87 + 
ªl
[
i
].
r_off£t
;

90 
sym
 = (
Elf32_Sym
 *)
£chdrs
[
symödex
].
sh_addr


91 + 
	`ELF32_R_SYM
(
ªl
[
i
].
r_öfo
);

93 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

94 
R_386_32
:

96 *
loˇti⁄
 +
sym
->
°_vÆue
;

98 
R_386_PC32
:

100 *
loˇti⁄
 +
sym
->
°_vÆue
 - (
uöt32_t
)location;

103 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %u\n",

104 
me
->
«me
, 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
));

105  -
ENOEXEC
;

109 
	}
}

111 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
,

112 c⁄° *
°πab
,

113 
symödex
,

114 
ªl£c
,

115 
moduÀ
 *
me
)

117 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

118 
me
->
«me
);

119  -
ENOEXEC
;

120 
	}
}

122 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
,

123 c⁄° *
°πab
,

124 
symödex
,

125 
ªl£c
,

126 
moduÀ
 *
me
)

128 
i
;

129 
Elf64_Rña
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

130 
Elf64_Sym
 *
sym
;

131 *
loc
;

132 
u64
 
vÆ
;

134 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

135 
£chdrs
[
ªl£c
].
sh_öfo
);

136 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

138 
loc
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


139 + 
ªl
[
i
].
r_off£t
;

143 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr


144 + 
	`ELF64_R_SYM
(
ªl
[
i
].
r_öfo
);

146 
	`DEBUGP
("type %d st_value %LxÑ_addend %LxÜoc %Lx\n",

147 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
),

148 
sym
->
°_vÆue
, 
ªl
[
i
].
r_addíd
, (
u64
)
loc
);

150 
vÆ
 = 
sym
->
°_vÆue
 + 
ªl
[
i
].
r_addíd
;

152 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

153 
R_X86_64_NONE
:

155 
R_X86_64_64
:

156 *(
u64
 *)
loc
 = 
vÆ
;

158 
R_X86_64_32
:

159 *(
u32
 *)
loc
 = 
vÆ
;

160 i‡(
vÆ
 !*(
u32
 *)
loc
)

161 
ovîÊow
;

163 
R_X86_64_32S
:

164 *(
s32
 *)
loc
 = 
vÆ
;

165 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

166 
ovîÊow
;

168 
R_X86_64_PC32
:

169 
vÆ
 -(
u64
)
loc
;

170 *(
u32
 *)
loc
 = 
vÆ
;

172 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

173 
ovîÊow
;

177 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelaÑelocation: %llu\n",

178 
me
->
«me
, 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
));

179  -
ENOEXEC
;

184 
ovîÊow
:

185 
	`¥ötk
(
KERN_ERR
 "overflow inÑelocationÅype %d val %Lx\n",

186 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
), 
vÆ
);

187 
	`¥ötk
(
KERN_ERR
 "`%s'ÜikelyÇot compiled with -mcmodel=kernel\n",

188 
me
->
«me
);

189  -
ENOEXEC
;

190 
	}
}

192 
	$≠∂y_ªloˇã
(
Elf_Shdr
 *
£chdrs
,

193 c⁄° *
°πab
,

194 
symödex
,

195 
ªl£c
,

196 
moduÀ
 *
me
)

198 
	`¥ötk
(
KERN_ERR
 "nonáddÑelocationÇot supported\n");

199  -
ENOSYS
;

200 
	}
}

204 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
,

205 c⁄° 
Elf_Shdr
 *
£chdrs
,

206 
moduÀ
 *
me
)

208 c⁄° 
Elf_Shdr
 *
s
, *
ãxt
 = 
NULL
, *
Æt
 = NULL, *
locks
 = NULL,

209 *
∑ø
 = 
NULL
;

210 *
£c°rögs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh°∫dx
].
sh_off£t
;

212 
s
 = 
£chdrs
; s < sechdr†+ 
hdr
->
e_shnum
; s++) {

213 i‡(!
	`°rcmp
(".ãxt", 
£c°rögs
 + 
s
->
sh_«me
))

214 
ãxt
 = 
s
;

215 i‡(!
	`°rcmp
(".Ætö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

216 
Æt
 = 
s
;

217 i‡(!
	`°rcmp
(".smp_locks", 
£c°rögs
 + 
s
->
sh_«me
))

218 
locks
 = 
s
;

219 i‡(!
	`°rcmp
(".∑øö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

220 
∑ø
 = 
s
;

223 i‡(
Æt
) {

225 *
a£g
 = (*)
Æt
->
sh_addr
;

226 
	`≠∂y_Æã∫©ives
(
a£g
,á£g + 
Æt
->
sh_size
);

228 i‡(
locks
 && 
ãxt
) {

229 *
l£g
 = (*)
locks
->
sh_addr
;

230 *
t£g
 = (*)
ãxt
->
sh_addr
;

231 
	`Æã∫©ives_smp_moduÀ_add
(
me
, me->
«me
,

232 
l£g
,Ü£g + 
locks
->
sh_size
,

233 
t£g
,Å£g + 
ãxt
->
sh_size
);

236 i‡(
∑ø
) {

237 *
p£g
 = (*)
∑ø
->
sh_addr
;

238 
	`≠∂y_∑øvút
(
p£g
,Ö£g + 
∑ø
->
sh_size
);

241  
	`moduÀ_bug_föÆize
(
hdr
, 
£chdrs
, 
me
);

242 
	}
}

244 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

246 
	`Æã∫©ives_smp_moduÀ_dñ
(
mod
);

247 
	`moduÀ_bug_˛ónup
(
mod
);

248 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<löux/mm.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dñay.h
>

13 
	~<löux/boŸmem.h
>

14 
	~<löux/kî√l_°©.h
>

15 
	~<löux/mc146818πc.h
>

16 
	~<löux/bô›s.h
>

17 
	~<löux/a˝i.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/pci.h
>

22 
	~<asm/mår.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/pgÆloc.h
>

25 
	~<asm/io_≠ic.h
>

26 
	~<asm/¥Ÿo.h
>

27 
	~<asm/bios_ebda.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/åampﬁöe.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/smp.h
>

33 
	~<asm/≠ic.h
>

38 
__öô
 
	$mpf_checksum
(*
mp
, 
Àn
)

40 
sum
 = 0;

42 
Àn
--)

43 
sum
 +*
mp
++;

45  
sum
 & 0xFF;

46 
	}
}

48 
__öô
 
	$deÁu…_mpc_≠ic_id
(
mpc_˝u
 *
m
)

50  
m
->
≠icid
;

51 
	}
}

53 
__öô
 
	$MP_¥o˚ss‹_öfo
(
mpc_˝u
 *
m
)

55 
≠icid
;

56 *
boŸup_˝u
 = "";

58 i‡(!(
m
->
˝uÊag
 & 
CPU_ENABLED
)) {

59 
dißbÀd_˝us
++;

63 
≠icid
 = 
x86_öô
.
mµ¨£
.
	`mpc_≠ic_id
(
m
);

65 i‡(
m
->
˝uÊag
 & 
CPU_BOOTPROCESSOR
) {

66 
boŸup_˝u
 = " (Bootup-CPU)";

67 
boŸ_˝u_physiˇl_≠icid
 = 
m
->
≠icid
;

70 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹ #%d%s\n", 
m
->
≠icid
, 
boŸup_˝u
);

71 
	`gíîic_¥o˚ss‹_öfo
(
≠icid
, 
m
->
≠icvî
);

72 
	}
}

74 #ifde‡
CONFIG_X86_IO_APIC


75 
__öô
 
	$deÁu…_mpc_€m_bus_öfo
(
mpc_bus
 *
m
, *
°r
)

77 
	`mem˝y
(
°r
, 
m
->
bu°y≥
, 6);

78 
°r
[6] = 0;

79 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Bu†#%d i†%s\n", 
m
->
busid
, 
°r
);

80 
	}
}

82 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
)

84 
°r
[7];

86 
x86_öô
.
mµ¨£
.
	`mpc_€m_bus_öfo
(
m
, 
°r
);

88 #i‡
MAX_MP_BUSSES
 < 256

89 i‡(
m
->
busid
 >
MAX_MP_BUSSES
) {

90 
	`¥ötk
(
KERN_WARNING
 "MPÅable busid value (%d) for bustype %s "

92 
m
->
busid
, 
°r
, 
MAX_MP_BUSSES
 - 1);

97 i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

98 
	`£t_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

99 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

100 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_ISA
;

102 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

103 i‡(
x86_öô
.
mµ¨£
.
mpc_€m_pci_bus
)

104 
x86_öô
.
mµ¨£
.
	`mpc_€m_pci_bus
(
m
);

106 
	`˛ór_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

107 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

108 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_PCI
;

109 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

110 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_EISA
;

111 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

112 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_MCA
;

115 
	`¥ötk
(
KERN_WARNING
 "Unknow¿bu°y≥ %†- ign‹ög\n", 
°r
);

116 
	}
}

118 
	$bad_iﬂpic
(
addªss
)

120 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

121 
	`¥ötk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)Éxceeded "

122 "(found %d)\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

123 
	`∑nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

125 i‡(!
addªss
) {

126 
	`¥ötk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APICáddress"

131 
	}
}

133 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
)

135 i‡(!(
m
->
Êags
 & 
MPC_APIC_USABLE
))

138 
	`¥ötk
(
KERN_INFO
 "I/O APIC #%d Version %dát 0x%X.\n",

139 
m
->
≠icid
, m->
≠icvî
, m->
≠iˇddr
);

141 i‡(
	`bad_iﬂpic
(
m
->
≠iˇddr
))

144 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠iˇddr
 = 
m
->apicaddr;

145 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icid
 = 
m
->apicid;

146 
mp_iﬂpics
[
ƒ_iﬂpics
].
ty≥
 = 
m
->type;

147 
mp_iﬂpics
[
ƒ_iﬂpics
].
≠icvî
 = 
m
->apicver;

148 
mp_iﬂpics
[
ƒ_iﬂpics
].
Êags
 = 
m
->flags;

149 
ƒ_iﬂpics
++;

150 
	}
}

152 
	$¥öt_MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

154 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

156 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbus
,

157 
m
->
§cbusúq
, m->
d°≠ic
, m->
d°úq
);

158 
	}
}

160 
__öô
 
	$¥öt_mp_úq_öfo
(
mpc_öt§c
 *
mp_úq
)

162 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

164 
mp_úq
->
úqty≥
, mp_úq->
úqÊag
 & 3,

165 (
mp_úq
->
úqÊag
 >> 2Ë& 3, mp_úq->
§cbus
,

166 
mp_úq
->
§cbusúq
, mp_úq->
d°≠ic
, mp_úq->
d°úq
);

167 
	}
}

169 
__öô
 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

170 
mpc_öt§c
 *
mp_úq
)

172 
mp_úq
->
d°≠ic
 = 
m
->dstapic;

173 
mp_úq
->
ty≥
 = 
m
->type;

174 
mp_úq
->
úqty≥
 = 
m
->irqtype;

175 
mp_úq
->
úqÊag
 = 
m
->irqflag;

176 
mp_úq
->
§cbus
 = 
m
->srcbus;

177 
mp_úq
->
§cbusúq
 = 
m
->srcbusirq;

178 
mp_úq
->
d°úq
 = 
m
->dstirq;

179 
	}
}

181 
__öô
 
	$assign_to_mpc_öt§c
(
mpc_öt§c
 *
mp_úq
,

182 
mpc_öt§c
 *
m
)

184 
m
->
d°≠ic
 = 
mp_úq
->dstapic;

185 
m
->
ty≥
 = 
mp_úq
->type;

186 
m
->
úqty≥
 = 
mp_úq
->irqtype;

187 
m
->
úqÊag
 = 
mp_úq
->irqflag;

188 
m
->
§cbus
 = 
mp_úq
->srcbus;

189 
m
->
§cbusúq
 = 
mp_úq
->srcbusirq;

190 
m
->
d°úq
 = 
mp_úq
->dstirq;

191 
	}
}

193 
__öô
 
	$mp_úq_mpc_öt§c_cmp
(
mpc_öt§c
 *
mp_úq
,

194 
mpc_öt§c
 *
m
)

196 i‡(
mp_úq
->
d°≠ic
 !
m
->dstapic)

198 i‡(
mp_úq
->
ty≥
 !
m
->type)

200 i‡(
mp_úq
->
úqty≥
 !
m
->irqtype)

202 i‡(
mp_úq
->
úqÊag
 !
m
->irqflag)

204 i‡(
mp_úq
->
§cbus
 !
m
->srcbus)

206 i‡(
mp_úq
->
§cbusúq
 !
m
->srcbusirq)

208 i‡(
mp_úq
->
d°úq
 !
m
->dstirq)

212 
	}
}

214 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

216 
i
;

218 
	`¥öt_MP_öt§c_öfo
(
m
);

220 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

221 i‡(!
	`mp_úq_mpc_öt§c_cmp
(&
mp_úqs
[
i
], 
m
))

225 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

226 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

227 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

228 
	}
}

230 
ölöe
 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
Ë{
	}
}

231 
ölöe
 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
Ë{
	}
}

232 
ölöe
 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
Ë{
	}
}

236 
__öô
 
	$MP_löt§c_öfo
(
mpc_löt§c
 *
m
)

238 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Lint:Åype %d,Öol %d,Årig %d, bus %02x,"

240 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbusid
,

241 
m
->
§cbusúq
, m->
de°≠ic
, m->
de°≠i˛öt
);

242 
	}
}

248 
__öô
 
	$smp_check_mpc
(
mpc_èbÀ
 *
mpc
, *
€m
, *
°r
)

251 i‡(
	`memcmp
(
mpc
->
sig«tuª
, 
MPC_SIGNATURE
, 4)) {

252 
	`¥ötk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

253 
mpc
->
sig«tuª
[0], mpc->signature[1],

254 
mpc
->
sig«tuª
[2], mpc->signature[3]);

257 i‡(
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
)) {

258 
	`¥ötk
(
KERN_ERR
 "MPTABLE: checksumÉrror!\n");

261 i‡(
mpc
->
•ec
 != 0x01 && mpc->spec != 0x04) {

262 
	`¥ötk
(
KERN_ERR
 "MPTABLE: badÅable version (%d)!!\n",

263 
mpc
->
•ec
);

266 i‡(!
mpc
->
œpic
) {

267 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇullÜocal APICáddress!\n");

270 
	`mem˝y
(
€m
, 
mpc
->oem, 8);

271 
€m
[8] = 0;

272 
	`¥ötk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
€m
);

274 
	`mem˝y
(
°r
, 
mpc
->
¥odu˘id
, 12);

275 
°r
[12] = 0;

277 
	`¥ötk
(
KERN_INFO
 "MPTABLE: Produ˘ ID: %s\n", 
°r
);

279 
	`¥ötk
(
KERN_INFO
 "MPTABLE: APICát: 0x%X\n", 
mpc
->
œpic
);

282 
	}
}

284 
	$skù_íåy
(**
±r
, *
cou¡
, 
size
)

286 *
±r
 +
size
;

287 *
cou¡
 +
size
;

288 
	}
}

290 
__öô
 
	$smp_dump_m±abÀ
(
mpc_èbÀ
 *
mpc
, *
m±
)

292 
	`¥ötk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

293 "ty≥ %x\n", *
m±
);

294 
	`¥öt_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

295 1, 
mpc
, mpc->
Àngth
, 1);

296 
	}
}

298 
__öô
 
	$deÁu…_smp_ªad_mpc_€m
(
mpc_èbÀ
 *
mpc
Ë{ 
	}
}

300 
__öô
 
	$smp_ªad_mpc
(
mpc_èbÀ
 *
mpc
, 
óæy
)

302 
°r
[16];

303 
€m
[10];

305 
cou¡
 = (*
mpc
);

306 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

308 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

311 #ifde‡
CONFIG_X86_32


312 
	`gíîic_mps_€m_check
(
mpc
, 
€m
, 
°r
);

315 i‡(!
a˝i_œpic
)

316 
mp_œpic_addr
 = 
mpc
->
œpic
;

318 i‡(
óæy
)

321 i‡(
mpc
->
€m±r
)

322 
x86_öô
.
mµ¨£
.
	`smp_ªad_mpc_€m
(
mpc
);

327 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(0);

329 
cou¡
 < 
mpc
->
Àngth
) {

330 *
m±
) {

331 
MP_PROCESSOR
:

333 i‡(!
a˝i_œpic
)

334 
	`MP_¥o˚ss‹_öfo
((
mpc_˝u
 *)
m±
);

335 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

337 
MP_BUS
:

338 
	`MP_bus_öfo
((
mpc_bus
 *)
m±
);

339 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

341 
MP_IOAPIC
:

342 
	`MP_iﬂpic_öfo
((
mpc_iﬂpic
 *)
m±
);

343 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

345 
MP_INTSRC
:

346 
	`MP_öt§c_öfo
((
mpc_öt§c
 *)
m±
);

347 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

349 
MP_LINTSRC
:

350 
	`MP_löt§c_öfo
((
mpc_löt§c
 *)
m±
);

351 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

355 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

356 
cou¡
 = 
mpc
->
Àngth
;

359 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(1);

362 #ifde‡
CONFIG_X86_BIGSMP


363 
	`gíîic_bigsmp_¥obe
();

366 i‡(
≠ic
->
£tup_≠ic_routög
)

367 
≠ic
->
	`£tup_≠ic_routög
();

369 i‡(!
num_¥o˚ss‹s
)

370 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇoÖrocessorsÑegistered!\n");

371  
num_¥o˚ss‹s
;

372 
	}
}

374 #ifde‡
CONFIG_X86_IO_APIC


376 
__öô
 
	$ELCR_åiggî
(
úq
)

378 
p‹t
;

380 
p‹t
 = 0x4d0 + (
úq
 >> 3);

381  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

382 
	}
}

384 
__öô
 
	$c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
)

386 
mpc_öt§c
 
öt§c
;

387 
i
;

388 
ELCR_ÁŒback
 = 0;

390 
öt§c
.
ty≥
 = 
MP_INTSRC
;

391 
öt§c
.
úqÊag
 = 0;

392 
öt§c
.
§cbus
 = 0;

393 
öt§c
.
d°≠ic
 = 
mp_iﬂpics
[0].
≠icid
;

395 
öt§c
.
úqty≥
 = 
mp_INT
;

405 i‡(
mpc_deÁu…_ty≥
 == 5) {

406 
	`¥ötk
(
KERN_INFO
 "ISA/PCI busÅype withÇo IRQ information... "

409 i‡(
	`ELCR_åiggî
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

410 
	`ELCR_åiggî
(13))

411 
	`¥ötk
(
KERN_ERR
 "ELCR contains invalid data... "

414 
	`¥ötk
(
KERN_INFO


416 
ELCR_ÁŒback
 = 1;

420 
i
 = 0; i < 16; i++) {

421 
mpc_deÁu…_ty≥
) {

423 i‡(
i
 == 0 || i == 13)

427 i‡(
i
 == 2)

431 i‡(
ELCR_ÁŒback
) {

437 i‡(
	`ELCR_åiggî
(
i
))

438 
öt§c
.
úqÊag
 = 13;

440 
öt§c
.
úqÊag
 = 0;

443 
öt§c
.
§cbusúq
 = 
i
;

444 
öt§c
.
d°úq
 = 
i
 ? i : 2;

445 
	`MP_öt§c_öfo
(&
öt§c
);

448 
öt§c
.
úqty≥
 = 
mp_ExtINT
;

449 
öt§c
.
§cbusúq
 = 0;

450 
öt§c
.
d°úq
 = 0;

451 
	`MP_öt§c_öfo
(&
öt§c
);

452 
	}
}

455 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
)

457 
mpc_iﬂpic
 
iﬂpic
;

458 
mpc_bus
 
bus
;

460 
bus
.
ty≥
 = 
MP_BUS
;

461 
bus
.
busid
 = 0;

462 
mpc_deÁu…_ty≥
) {

464 
	`¥ötk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

465 
mpc_deÁu…_ty≥
);

469 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

474 
	`mem˝y
(
bus
.
bu°y≥
, "EISA ", 6);

478 
	`mem˝y
(
bus
.
bu°y≥
, "MCA ", 6);

480 
	`MP_bus_öfo
(&
bus
);

481 i‡(
mpc_deÁu…_ty≥
 > 4) {

482 
bus
.
busid
 = 1;

483 
	`mem˝y
(
bus
.
bu°y≥
, "PCI ", 6);

484 
	`MP_bus_öfo
(&
bus
);

487 
iﬂpic
.
ty≥
 = 
MP_IOAPIC
;

488 
iﬂpic
.
≠icid
 = 2;

489 
iﬂpic
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

490 
iﬂpic
.
Êags
 = 
MPC_APIC_USABLE
;

491 
iﬂpic
.
≠iˇddr
 = 
IO_APIC_DEFAULT_PHYS_BASE
;

492 
	`MP_iﬂpic_öfo
(&
iﬂpic
);

497 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
);

498 
	}
}

500 
ölöe
 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
Ë{ 
	}
}

503 
ölöe
 
__öô
 
	$c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpc_deÁu…_ty≥
)

505 
mpc_˝u
 
¥o˚ss‹
;

506 
mpc_löt§c
 
löt§c
;

507 
löây≥s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

508 
i
;

513 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

518 
¥o˚ss‹
.
ty≥
 = 
MP_PROCESSOR
;

520 
¥o˚ss‹
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

521 
¥o˚ss‹
.
˝uÊag
 = 
CPU_ENABLED
;

522 
¥o˚ss‹
.
˝u„©uª
 = (
boŸ_˝u_d©a
.
x86
 << 8) |

523 (
boŸ_˝u_d©a
.
x86_modñ
 << 4Ë| boŸ_˝u_d©a.
x86_mask
;

524 
¥o˚ss‹
.
„©uªÊag
 = 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[0];

525 
¥o˚ss‹
.
ª£rved
[0] = 0;

526 
¥o˚ss‹
.
ª£rved
[1] = 0;

527 
i
 = 0; i < 2; i++) {

528 
¥o˚ss‹
.
≠icid
 = 
i
;

529 
	`MP_¥o˚ss‹_öfo
(&
¥o˚ss‹
);

532 
	`c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
);

534 
löt§c
.
ty≥
 = 
MP_LINTSRC
;

535 
löt§c
.
úqÊag
 = 0;

536 
löt§c
.
§cbusid
 = 0;

537 
löt§c
.
§cbusúq
 = 0;

538 
löt§c
.
de°≠ic
 = 
MP_APIC_ALL
;

539 
i
 = 0; i < 2; i++) {

540 
löt§c
.
úqty≥
 = 
löây≥s
[
i
];

541 
löt§c
.
de°≠i˛öt
 = 
i
;

542 
	`MP_löt§c_öfo
(&
löt§c
);

544 
	}
}

546 
mpf_öãl
 *
	gmpf_found
;

548 
__öô
 
	$gë_mpc_size
(
phy•å
)

550 
mpc_èbÀ
 *
mpc
;

551 
size
;

553 
mpc
 = 
	`óæy_i‹em≠
(
phy•å
, 
PAGE_SIZE
);

554 
size
 = 
mpc
->
Àngth
;

555 
	`óæy_iounm≠
(
mpc
, 
PAGE_SIZE
);

556 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy•å
,Öhy•å + 
size
);

558  
size
;

559 
	}
}

561 
__öô
 
	$check_phy•å
(
mpf_öãl
 *
mpf
, 
óæy
)

563 
mpc_èbÀ
 *
mpc
;

564 
size
;

566 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

567 
mpc
 = 
	`óæy_i‹em≠
(
mpf
->
phy•å
, 
size
);

572 i‡(!
	`smp_ªad_mpc
(
mpc
, 
óæy
)) {

573 #ifde‡
CONFIG_X86_LOCAL_APIC


574 
smp_found_c⁄fig
 = 0;

576 
	`¥ötk
(
KERN_ERR
 "BIOS bug, MPÅableÉrrors detected!...\n"

578 
	`óæy_iounm≠
(
mpc
, 
size
);

581 
	`óæy_iounm≠
(
mpc
, 
size
);

583 i‡(
óæy
)

586 #ifde‡
CONFIG_X86_IO_APIC


592 i‡(!
mp_úq_íåõs
) {

593 
mpc_bus
 
bus
;

595 
	`¥ötk
(
KERN_ERR
 "BIOS bug,ÇoÉxplicit IRQÉntries, "

598 
bus
.
ty≥
 = 
MP_BUS
;

599 
bus
.
busid
 = 0;

600 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

601 
	`MP_bus_öfo
(&
bus
);

603 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(0);

608 
	}
}

613 
__öô
 
	$deÁu…_gë_smp_c⁄fig
(
óæy
)

615 
mpf_öãl
 *
mpf
 = 
mpf_found
;

617 i‡(!
mpf
)

620 i‡(
a˝i_œpic
 && 
óæy
)

627 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

630 
	`¥ötk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

631 
mpf
->
•ecifiˇti⁄
);

632 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_X86_32
)

633 i‡(
mpf
->
„©uª2
 & (1 << 7)) {

634 
	`¥ötk
(
KERN_INFO
 " IMCRánd PIC compatibility mode.\n");

635 
pic_mode
 = 1;

637 
	`¥ötk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

638 
pic_mode
 = 0;

644 i‡(
mpf
->
„©uª1
 != 0) {

645 i‡(
óæy
) {

649 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

653 
	`¥ötk
(
KERN_INFO
 "Default MP configuration #%d\n",

654 
mpf
->
„©uª1
);

655 
	`c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpf
->
„©uª1
);

657 } i‡(
mpf
->
phy•å
) {

658 i‡(
	`check_phy•å
(
mpf
, 
óæy
))

661 
	`BUG
();

663 i‡(!
óæy
)

664 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹s: %d\n", 
num_¥o˚ss‹s
);

668 
	}
}

670 
__öô
 
	$smp_ª£rve_boŸmem
(
mpf_öãl
 *
mpf
)

672 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

673 #ifde‡
CONFIG_X86_32


683 
íd
 = 
max_low_p‚
 * 
PAGE_SIZE
;

685 i‡(
mpf
->
phy•å
 < 
íd
) {

686 i‡(
mpf
->
phy•å
 + 
size
 > 
íd
)

687 
size
 = 
íd
 - 
mpf
->
phy•å
;

688 
	`ª£rve_boŸmem_gíîic
(
mpf
->
phy•å
, 
size
, 
BOOTMEM_DEFAULT
);

691 
	`ª£rve_boŸmem_gíîic
(
mpf
->
phy•å
, 
size
, 
BOOTMEM_DEFAULT
);

693 
	}
}

695 
__öô
 
	$smp_sˇn_c⁄fig
(
ba£
, 
Àngth
,

696 
ª£rve
)

698 *
bp
 = 
	`phys_to_vút
(
ba£
);

699 
mpf_öãl
 *
mpf
;

701 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

702 
bp
, 
Àngth
);

703 
	`BUILD_BUG_ON
((*
mpf
) != 16);

705 
Àngth
 > 0) {

706 
mpf
 = (
mpf_öãl
 *)
bp
;

707 i‡((*
bp
 =
SMP_MAGIC_IDENT
) &&

708 (
mpf
->
Àngth
 == 1) &&

709 !
	`mpf_checksum
((*)
bp
, 16) &&

710 ((
mpf
->
•ecifiˇti⁄
 == 1)

711 || (
mpf
->
•ecifiˇti⁄
 == 4))) {

712 #ifde‡
CONFIG_X86_LOCAL_APIC


713 
smp_found_c⁄fig
 = 1;

715 
mpf_found
 = 
mpf
;

717 
	`¥ötk
(
KERN_INFO
 "found SMP MP-tableát [%p] %llx\n",

718 
mpf
, (
u64
)
	`vút_to_phys
(mpf));

720 i‡(!
ª£rve
)

722 
	`ª£rve_boŸmem_gíîic
(
	`vút_to_phys
(
mpf
), (*mpf),

723 
BOOTMEM_DEFAULT
);

724 i‡(
mpf
->
phy•å
)

725 
	`smp_ª£rve_boŸmem
(
mpf
);

729 
bp
 += 4;

730 
Àngth
 -= 16;

733 
	}
}

735 
__öô
 
	$deÁu…_föd_smp_c⁄fig
(
ª£rve
)

737 
addªss
;

747 i‡(
	`smp_sˇn_c⁄fig
(0x0, 0x400, 
ª£rve
) ||

748 
	`smp_sˇn_c⁄fig
(639 * 0x400, 0x400, 
ª£rve
) ||

749 
	`smp_sˇn_c⁄fig
(0xF0000, 0x10000, 
ª£rve
))

768 
addªss
 = 
	`gë_bios_ebda
();

769 i‡(
addªss
)

770 
	`smp_sˇn_c⁄fig
(
addªss
, 0x400, 
ª£rve
);

771 
	}
}

773 #ifde‡
CONFIG_X86_IO_APIC


774 
u8
 
__öôd©a
 
	gúq_u£d
[
MAX_IRQ_SOURCES
];

776 
__öô
 
	$gë_MP_öt§c_ödex
(
mpc_öt§c
 *
m
)

778 
i
;

780 i‡(
m
->
úqty≥
 !
mp_INT
)

783 i‡(
m
->
úqÊag
 != 0x0f)

788 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

789 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

792 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

795 i‡(
mp_úqs
[
i
].
§cbus
 !
m
->srcbus)

797 i‡(
mp_úqs
[
i
].
§cbusúq
 !
m
->srcbusirq)

799 i‡(
úq_u£d
[
i
]) {

803 
úq_u£d
[
i
] = 1;

804  
i
;

809 
	}
}

811 
	#SPARE_SLOT_NUM
 20

	)

813 
mpc_öt§c
 
__öôd©a
 *
	gm_•¨e
[
SPARE_SLOT_NUM
];

815 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
)

817 
i
;

819 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "OLD ");

820 
	`¥öt_MP_öt§c_öfo
(
m
);

822 
i
 = 
	`gë_MP_öt§c_ödex
(
m
);

823 i‡(
i
 > 0) {

824 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

825 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "NEW ");

826 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

829 i‡(!
i
) {

833 i‡(*
ƒ_m_•¨e
 < 
SPARE_SLOT_NUM
) {

838 
m_•¨e
[*
ƒ_m_•¨e
] = 
m
;

839 *
ƒ_m_•¨e
 += 1;

841 
	}
}

844 
ölöe
 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
Ë{
	}
}

848 
	$check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
)

850 
ªt
 = 0;

852 i‡(!
mpc_√w_phys
 || 
cou¡
 <
mpc_√w_Àngth
) {

853 
	`WARN
(1, "upd©e_m±abÀ: Nÿ•¨ê¶Ÿ†÷ígth: %x)\n", 
cou¡
);

857  
ªt
;

858 
	}
}

860 
__öô
 
	$ª∂a˚_öt§c_Æl
(
mpc_èbÀ
 *
mpc
,

861 
mpc_√w_phys
,

862 
mpc_√w_Àngth
)

864 #ifde‡
CONFIG_X86_IO_APIC


865 
i
;

867 
cou¡
 = (*
mpc
);

868 
ƒ_m_•¨e
 = 0;

869 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

871 
	`¥ötk
(
KERN_INFO
 "mpc_Àngth %x\n", 
mpc
->
Àngth
);

872 
cou¡
 < 
mpc
->
Àngth
) {

873 *
m±
) {

874 
MP_PROCESSOR
:

875 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

877 
MP_BUS
:

878 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

880 
MP_IOAPIC
:

881 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

883 
MP_INTSRC
:

884 
	`check_úq_§c
((
mpc_öt§c
 *)
m±
, &
ƒ_m_•¨e
);

885 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

887 
MP_LINTSRC
:

888 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

892 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

893 
out
;

897 #ifde‡
CONFIG_X86_IO_APIC


898 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

899 i‡(
úq_u£d
[
i
])

902 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

905 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

908 i‡(
ƒ_m_•¨e
 > 0) {

909 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "*NEW* found\n");

910 
ƒ_m_•¨e
--;

911 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m_•¨e
[
ƒ_m_•¨e
]);

912 
m_•¨e
[
ƒ_m_•¨e
] = 
NULL
;

914 
mpc_öt§c
 *
m
 = (mpc_öt§¯*)
m±
;

915 
cou¡
 +(
mpc_öt§c
);

916 i‡(
	`check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
) < 0)

917 
out
;

918 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

919 
mpc
->
Àngth
 = 
cou¡
;

920 
m±
 +(
mpc_öt§c
);

922 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

925 
out
:

927 
mpc
->
checksum
 = 0;

928 
mpc
->
checksum
 -
	`mpf_checksum
((*)mpc, mpc->
Àngth
);

931 
	}
}

933 
	gíabÀ_upd©e_m±abÀ
;

935 
__öô
 
	$upd©e_m±abÀ_£tup
(*
°r
)

937 
íabÀ_upd©e_m±abÀ
 = 1;

938 #ifde‡
CONFIG_PCI


939 
pci_rouãúq
 = 1;

942 
	}
}

943 
óæy_∑øm
("upd©e_m±abÀ", 
upd©e_m±abÀ_£tup
);

945 
__öôd©a
 
	gmpc_√w_phys
;

946 
mpc_√w_Àngth
 
	g__öôd©a
 = 4096;

949 
__öôd©a
 
	gÆloc_m±abÀ
;

950 
__öô
 
	$∑r£_Æloc_m±abÀ_›t
(*
p
)

952 
íabÀ_upd©e_m±abÀ
 = 1;

953 #ifde‡
CONFIG_PCI


954 
pci_rouãúq
 = 1;

956 
Æloc_m±abÀ
 = 1;

957 i‡(!
p
)

959 
mpc_√w_Àngth
 = 
	`mem∑r£
(
p
, &p);

961 
	}
}

962 
óæy_∑øm
("Æloc_m±abÀ", 
∑r£_Æloc_m±abÀ_›t
);

964 
__öô
 
	$óæy_ª£rve_e820_mpc_√w
()

966 i‡(
íabÀ_upd©e_m±abÀ
 && 
Æloc_m±abÀ
) {

967 
u64
 
°¨â
 = 0;

968 #ifde‡
CONFIG_X86_TRAMPOLINE


969 
°¨â
 = 
TRAMPOLINE_BASE
;

971 
mpc_√w_phys
 = 
	`óæy_ª£rve_e820
(
°¨â
, 
mpc_√w_Àngth
, 4);

973 
	}
}

975 
__öô
 
	$upd©e_mp_èbÀ
()

977 
°r
[16];

978 
€m
[10];

979 
mpf_öãl
 *
mpf
;

980 
mpc_èbÀ
 *
mpc
, *
mpc_√w
;

982 i‡(!
íabÀ_upd©e_m±abÀ
)

985 
mpf
 = 
mpf_found
;

986 i‡(!
mpf
)

992 i‡(
mpf
->
„©uª1
 != 0)

995 i‡(!
mpf
->
phy•å
)

998 
mpc
 = 
	`phys_to_vút
(
mpf
->
phy•å
);

1000 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

1003 
	`¥ötk
(
KERN_INFO
 "mpf: %Œx\n", (
u64
)
	`vút_to_phys
(
mpf
));

1004 
	`¥ötk
(
KERN_INFO
 "phy•å: %x\n", 
mpf
->
phy•å
);

1006 i‡(
mpc_√w_phys
 && 
mpc
->
Àngth
 > 
mpc_√w_Àngth
) {

1007 
mpc_√w_phys
 = 0;

1008 
	`¥ötk
(
KERN_INFO
 "mpc_new_length is %ld,Ölease useálloc_mptable=8k\n",

1009 
mpc_√w_Àngth
);

1012 i‡(!
mpc_√w_phys
) {

1013 
ﬁd
, 
√w
;

1015 
mpc
->
checksum
 = 0;

1016 
ﬁd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

1017 
mpc
->
checksum
 = 0xff;

1018 
√w
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

1019 i‡(
ﬁd
 =
√w
) {

1020 
	`¥ötk
(
KERN_INFO
 "mpc isÑeadonly,ÖleaseÅryálloc_mptable instead\n");

1023 
	`¥ötk
(
KERN_INFO
 "use in-positonÑeplacing\n");

1025 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1026 
mpc_√w
 = 
	`phys_to_vút
(
mpc_√w_phys
);

1027 
	`mem˝y
(
mpc_√w
, 
mpc
, mpc->
Àngth
);

1028 
mpc
 = 
mpc_√w
;

1030 i‡(
mpc_√w_phys
 - 
mpf
->
phy•å
) {

1031 
mpf_öãl
 *
mpf_√w
;

1033 
	`¥ötk
(
KERN_INFO
 "mpfÇew: %x\n", 0x400 - 16);

1034 
mpf_√w
 = 
	`phys_to_vút
(0x400 - 16);

1035 
	`mem˝y
(
mpf_√w
, 
mpf
, 16);

1036 
mpf
 = 
mpf_√w
;

1037 
mpf
->
phy•å
 = 
mpc_√w_phys
;

1039 
mpf
->
checksum
 = 0;

1040 
mpf
->
checksum
 -
	`mpf_checksum
((*)mpf, 16);

1041 
	`¥ötk
(
KERN_INFO
 "phy•åÇew: %x\n", 
mpf
->
phy•å
);

1050 
	`ª∂a˚_öt§c_Æl
(
mpc
, 
mpc_√w_phys
, 
mpc_√w_Àngth
);

1053 
	}
}

1055 
œã_öôˇŒ
(
upd©e_mp_èbÀ
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

25 
	~<löux/moduÀ.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/î∫o.h
>

29 
	~<löux/f˙é.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/smp_lock.h
>

34 
	~<löux/maj‹.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/devi˚.h
>

37 
	~<löux/˝u.h
>

38 
	~<löux/nŸifõr.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~<asm/¥o˚ss‹.h
>

42 
	~<asm/m§.h
>

43 
	~<asm/sy°em.h
>

45 
˛ass
 *
	gm§_˛ass
;

47 
loff_t
 
	$m§_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

49 
loff_t
 
ªt
;

50 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

52 
	`muãx_lock
(&
öode
->
i_muãx
);

53 
‹ig
) {

55 
fûe
->
f_pos
 = 
off£t
;

56 
ªt
 = 
fûe
->
f_pos
;

59 
fûe
->
f_pos
 +
off£t
;

60 
ªt
 = 
fûe
->
f_pos
;

63 
ªt
 = -
EINVAL
;

65 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

66  
ªt
;

67 
	}
}

69 
ssize_t
 
	$m§_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

70 
size_t
 
cou¡
, 
loff_t
 *
µos
)

72 
u32
 
__u£r
 *
tmp
 = (u32 __u£∏*Ë
buf
;

73 
u32
 
d©a
[2];

74 
u32
 
ªg
 = *
µos
;

75 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

76 
îr
 = 0;

77 
ssize_t
 
byãs
 = 0;

79 i‡(
cou¡
 % 8)

80  -
EINVAL
;

82 ; 
cou¡
; count -= 8) {

83 
îr
 = 
	`rdm§_ß„_⁄_˝u
(
˝u
, 
ªg
, &
d©a
[0], &data[1]);

84 i‡(
îr
)

86 i‡(
	`c›y_to_u£r
(
tmp
, &
d©a
, 8)) {

87 
îr
 = -
EFAULT
;

90 
tmp
 += 2;

91 
byãs
 += 8;

94  
byãs
 ? byã†: 
îr
;

95 
	}
}

97 
ssize_t
 
	$m§_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

98 
size_t
 
cou¡
, 
loff_t
 *
µos
)

100 c⁄° 
u32
 
__u£r
 *
tmp
 = (c⁄° u32 __u£∏*)
buf
;

101 
u32
 
d©a
[2];

102 
u32
 
ªg
 = *
µos
;

103 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

104 
îr
 = 0;

105 
ssize_t
 
byãs
 = 0;

107 i‡(
cou¡
 % 8)

108  -
EINVAL
;

110 ; 
cou¡
; count -= 8) {

111 i‡(
	`c›y_‰om_u£r
(&
d©a
, 
tmp
, 8)) {

112 
îr
 = -
EFAULT
;

115 
îr
 = 
	`wrm§_ß„_⁄_˝u
(
˝u
, 
ªg
, 
d©a
[0], data[1]);

116 i‡(
îr
)

118 
tmp
 += 2;

119 
byãs
 += 8;

122  
byãs
 ? byã†: 
îr
;

123 
	}
}

125 
	$m§_io˘l
(
fûe
 *fûe, 
ioc
, 
¨g
)

127 
u32
 
__u£r
 *
uªgs
 = (u32 __u£∏*)
¨g
;

128 
u32
 
ªgs
[8];

129 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

130 
îr
;

132 
ioc
) {

133 
X86_IOC_RDMSR_REGS
:

134 i‡(!(
fûe
->
f_mode
 & 
FMODE_READ
)) {

135 
îr
 = -
EBADF
;

138 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

139 
îr
 = -
EFAULT
;

142 
îr
 = 
	`rdm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

143 i‡(
îr
)

145 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

146 
îr
 = -
EFAULT
;

149 
X86_IOC_WRMSR_REGS
:

150 i‡(!(
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

151 
îr
 = -
EBADF
;

154 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

155 
îr
 = -
EFAULT
;

158 
îr
 = 
	`wrm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

159 i‡(
îr
)

161 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

162 
îr
 = -
EFAULT
;

166 
îr
 = -
ENOTTY
;

170  
îr
;

171 
	}
}

173 
	$m§_›í
(
öode
 *öode, 
fûe
 *file)

175 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

176 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

177 
ªt
 = 0;

179 
	`lock_kî√l
();

180 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

182 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu)) {

183 
ªt
 = -
ENXIO
;

184 
out
;

186 
c
 = &
	`˝u_d©a
(
˝u
);

187 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MSR
))

188 
ªt
 = -
EIO
;

189 
out
:

190 
	`u∆ock_kî√l
();

191  
ªt
;

192 
	}
}

197 c⁄° 
fûe_›î©i⁄s
 
	gm§_f›s
 = {

198 .
ow√r
 = 
THIS_MODULE
,

199 .
	gŒ£ek
 = 
m§_£ek
,

200 .
	gªad
 = 
m§_ªad
,

201 .
	gwrôe
 = 
m§_wrôe
,

202 .
	g›í
 = 
m§_›í
,

203 .
	gu∆ocked_io˘l
 = 
m§_io˘l
,

204 .
	gcom∑t_io˘l
 = 
m§_io˘l
,

207 
__˝uöô
 
	$m§_devi˚_¸óã
(
˝u
)

209 
devi˚
 *
dev
;

211 
dev
 = 
	`devi˚_¸óã
(
m§_˛ass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
), NULL,

212 "m§%d", 
˝u
);

213  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

214 
	}
}

216 
	$m§_devi˚_de°roy
(
˝u
)

218 
	`devi˚_de°roy
(
m§_˛ass
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
));

219 
	}
}

221 
__˝uöô
 
	$m§_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

222 
a˘i⁄
, *
h˝u
)

224 
˝u
 = ()
h˝u
;

225 
îr
 = 0;

227 
a˘i⁄
) {

228 
CPU_UP_PREPARE
:

229 
îr
 = 
	`m§_devi˚_¸óã
(
˝u
);

231 
CPU_UP_CANCELED
:

232 
CPU_UP_CANCELED_FROZEN
:

233 
CPU_DEAD
:

234 
	`m§_devi˚_de°roy
(
˝u
);

237  
îr
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

238 
	}
}

240 
nŸifõr_block
 
__ªfd©a
 
	gm§_˛ass_˝u_nŸifõr
 = {

241 .
nŸifõr_ˇŒ
 = 
m§_˛ass_˝u_ˇŒback
,

244 *
	$m§_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

246  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/m§", 
	`MINOR
(
dev
->
devt
));

247 
	}
}

249 
__öô
 
	$m§_öô
()

251 
i
, 
îr
 = 0;

252 
i
 = 0;

254 i‡(
	`ªgi°î_chrdev
(
MSR_MAJOR
, "˝u/m§", &
m§_f›s
)) {

255 
	`¥ötk
(
KERN_ERR
 "msr: unableÅo get major %d for msr\n",

256 
MSR_MAJOR
);

257 
îr
 = -
EBUSY
;

258 
out
;

260 
m§_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "msr");

261 i‡(
	`IS_ERR
(
m§_˛ass
)) {

262 
îr
 = 
	`PTR_ERR
(
m§_˛ass
);

263 
out_chrdev
;

265 
m§_˛ass
->
devnode
 = 
m§_devnode
;

266 
	`f‹_óch_⁄löe_˝u
(
i
) {

267 
îr
 = 
	`m§_devi˚_¸óã
(
i
);

268 i‡(
îr
 != 0)

269 
out_˛ass
;

271 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

273 
îr
 = 0;

274 
out
;

276 
out_˛ass
:

277 
i
 = 0;

278 
	`f‹_óch_⁄löe_˝u
(
i
)

279 
	`m§_devi˚_de°roy
(
i
);

280 
	`˛ass_de°roy
(
m§_˛ass
);

281 
out_chrdev
:

282 
	`uƒegi°î_chrdev
(
MSR_MAJOR
, "cpu/msr");

283 
out
:

284  
îr
;

285 
	}
}

287 
__exô
 
	$m§_exô
()

289 
˝u
 = 0;

290 
	`f‹_óch_⁄löe_˝u
(
˝u
)

291 
	`m§_devi˚_de°roy
(
˝u
);

292 
	`˛ass_de°roy
(
m§_˛ass
);

293 
	`uƒegi°î_chrdev
(
MSR_MAJOR
, "cpu/msr");

294 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

295 
	}
}

297 
moduÀ_öô
(
m§_öô
);

298 
	$moduÀ_exô
(
m§_exô
)

300 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

301 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

302 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<löux/kî√l.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/•ölock.h
>

31 
	~<löux/°rög.h
>

32 
	~<löux/¸ash_dump.h
>

33 
	~<löux/dma-m≠pög.h
>

34 
	~<löux/bô›s.h
>

35 
	~<löux/pci_ids.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/sˇâîli°.h
>

39 
	~<löux/iommu-hñ≥r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ˇlg¨y.h
>

43 
	~<asm/t˚.h
>

44 
	~<asm/pci-dúe˘.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

50 #ifde‡
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


51 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 1;

53 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 0;

56 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

57 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

60 
	#CALGARY_CONFIG_REG
 0x0108

	)

61 
	#PHB_CSR_OFFSET
 0x0110

	)

62 
	#PHB_PLSSR_OFFSET
 0x0120

	)

63 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

64 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

65 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

66 
	#PHB_MEM_1_LOW
 0x0190

	)

67 
	#PHB_MEM_1_HIGH
 0x01A0

	)

68 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

69 
	#PHB_MEM_1_SIZE
 0x01C0

	)

70 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

71 
	#PHB_AER_OFFSET
 0x0200

	)

72 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

73 
	#PHB_CONFIG_0_LOW
 0x0230

	)

74 
	#PHB_CONFIG_0_END
 0x0240

	)

75 
	#PHB_MEM_2_LOW
 0x02B0

	)

76 
	#PHB_MEM_2_HIGH
 0x02C0

	)

77 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

78 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

79 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

82 
	#PHB_SAVIOR_L2
 0x0DB0

	)

83 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

84 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

85 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

88 
	#PHB_TCE_ENABLE
 0x20000000

	)

89 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

90 
	#PHB_DAC_DISABLE
 0x01000000

	)

91 
	#PHB_MEM2_ENABLE
 0x00400000

	)

92 
	#PHB_MCSR_ENABLE
 0x00100000

	)

94 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

95 
	#TAR_VALID
 0x0000000000000008UL

	)

97 
	#CSR_AGENT_MASK
 0xf„0ffff

	)

99 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

101 
	#PMR_SOFTSTOP
 0x80000000

	)

102 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

103 
	#PMR_HARDSTOP
 0x20000000

	)

105 
	#MAX_NUM_OF_PHBS
 8

	)

106 
	#MAX_NUM_CHASSIS
 8

	)

108 
	#MAX_PHB_BUS_NUM
 (
MAX_NUM_OF_PHBS
 * 
MAX_NUM_CHASSIS
 * 2)

	)

109 
	#PHBS_PER_CALGARY
 4

	)

112 c⁄° 
	gèr_off£ts
[] = {

119 c⁄° 
	g•lô_queue_off£ts
[] = {

126 c⁄° 
	gphb_off£ts
[] = {

135 c⁄° 
	gphb_debug_off£ts
[] = {

147 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

149 
	#EMERGENCY_PAGES
 32

	)

151 
	g•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

152 
å™¶©e_em±y_¶Ÿs
 
	g__ªad_mo°ly
 = 0;

153 
ˇlg¨y_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

155 
rio_èbÀ_hdr
 *rio_èbÀ_hd∏
	g__öôd©a
;

156 
sˇl_dëaû
 *
	gsˇl_devs
[
MAX_NUMNODES
] 
	g__öôd©a
;

157 
rio_dëaû
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__öôd©a
;

159 
	sˇlg¨y_bus_öfo
 {

160 *
	mt˚_•a˚
;

161 
	må™¶©i⁄_dißbÀd
;

162 sig√d 
	mphbid
;

163 
__iomem
 *
	mbb¨
;

166 
ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

167 
ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

168 
ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

169 
ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

170 
ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

171 
ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

172 
ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
);

173 
gë_t˚_•a˚_‰om_èr
();

175 
ˇl_chù£t_›s
 
	gˇlg¨y_chù_›s
 = {

176 .
h™dÀ_quúks
 = 
ˇlg¨y_h™dÀ_quúks
,

177 .
	gt˚_ˇche_bœ°
 = 
ˇlg¨y_t˚_ˇche_bœ°
,

178 .
	gdump_îr‹_ªgs
 = 
ˇlg¨y_dump_îr‹_ªgs


181 
ˇl_chù£t_›s
 
	gˇlioc2_chù_›s
 = {

182 .
h™dÀ_quúks
 = 
ˇlioc2_h™dÀ_quúks
,

183 .
	gt˚_ˇche_bœ°
 = 
ˇlioc2_t˚_ˇche_bœ°
,

184 .
	gdump_îr‹_ªgs
 = 
ˇlioc2_dump_îr‹_ªgs


187 
ˇlg¨y_bus_öfo
 
	gbus_öfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

189 
ölöe
 
	$å™¶©i⁄_íabÀd
(
iommu_èbÀ
 *
tbl
)

192  (
tbl
 !
NULL
);

193 
	}
}

195 
	$iommu_ønge_ª£rve
(
iommu_èbÀ
 *
tbl
,

196 
°¨t_addr
, 
≈ages
)

198 
ödex
;

199 
íd
;

200 
Êags
;

202 
ödex
 = 
°¨t_addr
 >> 
PAGE_SHIFT
;

205 i‡(
ödex
 >
tbl
->
ô_size
)

208 
íd
 = 
ödex
 + 
≈ages
;

209 i‡(
íd
 > 
tbl
->
ô_size
)

210 
íd
 = 
tbl
->
ô_size
;

212 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

214 
	`iommu_¨ó_ª£rve
(
tbl
->
ô_m≠
, 
ödex
, 
≈ages
);

216 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

217 
	}
}

219 
	$iommu_ønge_Æloc
(
devi˚
 *
dev
,

220 
iommu_èbÀ
 *
tbl
,

221 
≈ages
)

223 
Êags
;

224 
off£t
;

225 
bound¨y_size
;

227 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

228 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

230 
	`BUG_ON
(
≈ages
 == 0);

232 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

234 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
,Åbl->
ô_höt
,

235 
≈ages
, 0, 
bound¨y_size
, 0);

236 i‡(
off£t
 == ~0UL) {

237 
tbl
->
chù_›s
->
	`t˚_ˇche_bœ°
(tbl);

239 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
, 0,

240 
≈ages
, 0, 
bound¨y_size
, 0);

241 i‡(
off£t
 == ~0UL) {

242 
	`¥ötk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

243 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

244 i‡(
∑nic_⁄_ovîÊow
)

245 
	`∑nic
("Calgary: fixÅheállocator.\n");

247  
bad_dma_addªss
;

251 
tbl
->
ô_höt
 = 
off£t
 + 
≈ages
;

252 
	`BUG_ON
(
tbl
->
ô_höt
 >Åbl->
ô_size
);

254 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

256  
off£t
;

257 
	}
}

259 
dma_addr_t
 
	$iommu_Æloc
(
devi˚
 *
dev
, 
iommu_èbÀ
 *
tbl
,

260 *
vaddr
, 
≈ages
, 
dúe˘i⁄
)

262 
íåy
;

263 
dma_addr_t
 
ªt
 = 
bad_dma_addªss
;

265 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

267 i‡(
	`u∆ikñy
(
íåy
 =
bad_dma_addªss
))

268 
îr‹
;

271 
ªt
 = (
íåy
 << 
PAGE_SHIFT
Ë| (()
vaddr
 & ~
PAGE_MASK
);

274 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, ()
vaddr
 & 
PAGE_MASK
,

275 
dúe˘i⁄
);

277  
ªt
;

279 
îr‹
:

280 
	`¥ötk
(
KERN_WARNING
 "Calgary: failedÅoállocate %uÖages in "

281 "iommu %p\n", 
≈ages
, 
tbl
);

282  
bad_dma_addªss
;

283 
	}
}

285 
	$iommu_‰ì
(
iommu_èbÀ
 *
tbl
, 
dma_addr_t
 
dma_addr
,

286 
≈ages
)

288 
íåy
;

289 
badíd
;

290 
Êags
;

293 
badíd
 = 
bad_dma_addªss
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

294 i‡(
	`u∆ikñy
((
dma_addr
 >
bad_dma_addªss
Ë&& (dma_add∏< 
badíd
))) {

295 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverÅried unmapping bad DMA "

296 "addªs†0x%Lx\n", 
dma_addr
);

300 
íåy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

302 
	`BUG_ON
(
íåy
 + 
≈ages
 > 
tbl
->
ô_size
);

304 
	`t˚_‰ì
(
tbl
, 
íåy
, 
≈ages
);

306 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

308 
	`iommu_¨ó_‰ì
(
tbl
->
ô_m≠
, 
íåy
, 
≈ages
);

310 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

311 
	}
}

313 
ölöe
 
iommu_èbÀ
 *
	$föd_iommu_èbÀ
(
devi˚
 *
dev
)

315 
pci_dev
 *
pdev
;

316 
pci_bus
 *
pbus
;

317 
iommu_èbÀ
 *
tbl
;

319 
pdev
 = 
	`to_pci_dev
(
dev
);

321 
pbus
 = 
pdev
->
bus
;

324 
pbus
->
∑ª¡
)

325 
pbus
 =Öbus->
∑ª¡
;

327 
tbl
 = 
	`pci_iommu
(
pbus
);

329 
	`BUG_ON
(
tbl
 && (tbl->
ô_bu¢o
 !
pbus
->
numbî
));

331  
tbl
;

332 
	}
}

334 
	$ˇlg¨y_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

335 
√Àms
,
dma_d©a_dúe˘i⁄
 
dú
,

336 
dma_©ås
 *
©ås
)

338 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

339 
sˇâîli°
 *
s
;

340 
i
;

342 i‡(!
	`å™¶©i⁄_íabÀd
(
tbl
))

345 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

346 
≈ages
;

347 
dma_addr_t
 
dma
 = 
s
->
dma_addªss
;

348 
dmÆí
 = 
s
->
dma_Àngth
;

350 i‡(
dmÆí
 == 0)

353 
≈ages
 = 
	`iommu_num_∑ges
(
dma
, 
dmÆí
, 
PAGE_SIZE
);

354 
	`iommu_‰ì
(
tbl
, 
dma
, 
≈ages
);

356 
	}
}

358 
	$ˇlg¨y_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

359 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

360 
dma_©ås
 *
©ås
)

362 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

363 
sˇâîli°
 *
s
;

364 
vaddr
;

365 
≈ages
;

366 
íåy
;

367 
i
;

369 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

370 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

372 
vaddr
 = (Ë
	`sg_vút
(
s
);

373 
≈ages
 = 
	`iommu_num_∑ges
(
vaddr
, 
s
->
Àngth
, 
PAGE_SIZE
);

375 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

376 i‡(
íåy
 =
bad_dma_addªss
) {

378 
s
->
dma_Àngth
 = 0;

379 
îr‹
;

382 
s
->
dma_addªss
 = (
íåy
 << 
PAGE_SHIFT
Ë| s->
off£t
;

385 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, 
vaddr
 & 
PAGE_MASK
, 
dú
);

387 
s
->
dma_Àngth
 = s->
Àngth
;

390  
√Àms
;

391 
îr‹
:

392 
	`ˇlg¨y_unm≠_sg
(
dev
, 
sg
, 
√Àms
, 
dú
, 
NULL
);

393 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

394 
sg
->
dma_addªss
 = 
bad_dma_addªss
;

395 
sg
->
dma_Àngth
 = 0;

398 
	}
}

400 
dma_addr_t
 
	$ˇlg¨y_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

401 
off£t
, 
size_t
 
size
,

402 
dma_d©a_dúe˘i⁄
 
dú
,

403 
dma_©ås
 *
©ås
)

405 *
vaddr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

406 
uaddr
;

407 
≈ages
;

408 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

410 
uaddr
 = ()
vaddr
;

411 
≈ages
 = 
	`iommu_num_∑ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

413  
	`iommu_Æloc
(
dev
, 
tbl
, 
vaddr
, 
≈ages
, 
dú
);

414 
	}
}

416 
	$ˇlg¨y_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

417 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

418 
dma_©ås
 *
©ås
)

420 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

421 
≈ages
;

423 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

424 
	`iommu_‰ì
(
tbl
, 
dma_addr
, 
≈ages
);

425 
	}
}

427 * 
	$ˇlg¨y_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

428 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êag
)

430 *
ªt
 = 
NULL
;

431 
dma_addr_t
 
m≠pög
;

432 
≈ages
, 
‹dî
;

433 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

435 
size
 = 
	`PAGE_ALIGN
(size);

436 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

437 
‹dî
 = 
	`gë_‹dî
(
size
);

439 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

442 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
‹dî
);

443 i‡(!
ªt
)

444 
îr‹
;

445 
	`mem£t
(
ªt
, 0, 
size
);

448 
m≠pög
 = 
	`iommu_Æloc
(
dev
, 
tbl
, 
ªt
, 
≈ages
, 
DMA_BIDIRECTIONAL
);

449 i‡(
m≠pög
 =
bad_dma_addªss
)

450 
‰ì
;

451 *
dma_h™dÀ
 = 
m≠pög
;

452  
ªt
;

453 
‰ì
:

454 
	`‰ì_∑ges
(()
ªt
, 
	`gë_‹dî
(
size
));

455 
ªt
 = 
NULL
;

456 
îr‹
:

457  
ªt
;

458 
	}
}

460 
	$ˇlg¨y_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

461 *
vaddr
, 
dma_addr_t
 
dma_h™dÀ
)

463 
≈ages
;

464 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

466 
size
 = 
	`PAGE_ALIGN
(size);

467 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

469 
	`iommu_‰ì
(
tbl
, 
dma_h™dÀ
, 
≈ages
);

470 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

471 
	}
}

473 
dma_m≠_›s
 
	gˇlg¨y_dma_›s
 = {

474 .
Æloc_cohîít
 = 
ˇlg¨y_Æloc_cohîít
,

475 .
	g‰ì_cohîít
 = 
ˇlg¨y_‰ì_cohîít
,

476 .
	gm≠_sg
 = 
ˇlg¨y_m≠_sg
,

477 .
	gunm≠_sg
 = 
ˇlg¨y_unm≠_sg
,

478 .
	gm≠_∑ge
 = 
ˇlg¨y_m≠_∑ge
,

479 .
	gunm≠_∑ge
 = 
ˇlg¨y_unm≠_∑ge
,

482 
ölöe
 
__iomem
 * 
	$bu¢o_to_bb¨
(
num
)

484  
bus_öfo
[
num
].
bb¨
;

485 
	}
}

487 
ölöe
 
	$bu¢o_to_phbid
(
num
)

489  
bus_öfo
[
num
].
phbid
;

490 
	}
}

492 
ölöe
 
	$•lô_queue_off£t
(
num
)

494 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

496  
•lô_queue_off£ts
[
idx
];

497 
	}
}

499 
ölöe
 
	$èr_off£t
(
num
)

501 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

503  
èr_off£ts
[
idx
];

504 
	}
}

506 
ölöe
 
	$phb_off£t
(
num
)

508 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

510  
phb_off£ts
[
idx
];

511 
	}
}

513 
ölöe
 
__iomem
* 
	$ˇlg¨y_ªg
(
__iomem
 *
b¨
, 
off£t
)

515 
èrgë
 = (()
b¨
Ë| 
off£t
;

516  (
__iomem
*)
èrgë
;

517 
	}
}

519 
ölöe
 
	$is_ˇlioc2
(
devi˚
)

521  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALIOC2
);

522 
	}
}

524 
ölöe
 
	$is_ˇlg¨y
(
devi˚
)

526  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
);

527 
	}
}

529 
ölöe
 
	$is_ˇl_pci_dev
(
devi˚
)

531  (
	`is_ˇlg¨y
(
devi˚
Ë|| 
	`is_ˇlioc2
(device));

532 
	}
}

534 
	$ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

536 
u64
 
vÆ
;

537 
u32
 
´r
;

538 
i
 = 0;

539 
__iomem
 *
bb¨
 = 
tbl
->bbar;

540 
__iomem
 *
èrgë
;

543 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

544 
´r
 = 
	`ªadl
(
èrgë
);

545 
	`wrôñ
(0, 
èrgë
);

548 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

549 
vÆ
 = 
	`ªadl
(
èrgë
);

552 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
tbl
->
ô_bu¢o
));

554 
vÆ
 = 
	`ªadq
(
èrgë
);

555 
i
++;

556 } (
vÆ
 & 0xffË!0xf‡&& 
i
 < 100);

557 i‡(
i
 == 100)

558 
	`¥ötk
(
KERN_WARNING
 "Calgary: PCI busÇot quiesced, "

562 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
tbl
->
ô_bu¢o
));

563 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

566 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

567 
	`wrôñ
(
´r
, 
èrgë
);

568 ()
	`ªadl
(
èrgë
);

569 
	}
}

571 
	$ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

573 
__iomem
 *
bb¨
 = 
tbl
->bbar;

574 
__iomem
 *
èrgë
;

575 
u64
 
vÆ64
;

576 
u32
 
vÆ
;

577 
i
 = 0;

578 
cou¡
 = 1;

579 
bus
 = 
tbl
->
ô_bu¢o
;

581 
begö
:

582 
	`¥ötk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xÉnteringÅce cache blast "

583 "£quí˚ - cou¡ %d\n", 
bus
, 
cou¡
);

586 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

587 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

588 
	`¥ötk
(
KERN_DEBUG
 "1a.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

589 
vÆ
 |
PMR_SOFTSTOP
;

590 
	`¥ötk
(
KERN_DEBUG
 "1b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

591 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

594 
	`¥ötk
(
KERN_DEBUG
 "2a. startingÅoÖoll split queues\n");

595 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
bus
));

597 
vÆ64
 = 
	`ªadq
(
èrgë
);

598 
i
++;

599 } (
vÆ64
 & 0xffË!0xf‡&& 
i
 < 100);

600 i‡(
i
 == 100)

601 
	`¥ötk
(
KERN_WARNING
 "CalIOC2: PCI busÇot quiesced, "

605 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

606 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

607 
	`¥ötk
(
KERN_DEBUG
 "3.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

610 i‡(
vÆ
 & 
PMR_SOFTSTOPFAULT
) {

611 i‡(++
cou¡
 < 100)

612 
begö
;

614 
	`¥ötk
(
KERN_WARNING
 "CalIOC2:Åoo many SoftStopFaults, "

621 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

622 
	`¥ötk
(
KERN_DEBUG
 "5a. sœmmög i¡ÿH¨dSt› byÑódög %p\n", 
èrgë
);

623 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

624 
	`¥ötk
(
KERN_DEBUG
 "5b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

625 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

626 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

627 
	`¥ötk
(
KERN_DEBUG
 "5c.Ñód 0x%x [LE] from %∞(debug)\n", 
vÆ
, 
èrgë
);

630 
	`¥ötk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

631 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
bus
));

632 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

635 
	`¥ötk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

636 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

637 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

638 
	`¥ötk
(
KERN_DEBUG
 "7b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

641 
	`¥ötk
(
KERN_DEBUG
 "8a.Ñemoving HardStop from PMCR\n");

642 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

643 
vÆ
 = 0;

644 
	`¥ötk
(
KERN_DEBUG
 "8b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

645 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

646 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

647 
	`¥ötk
(
KERN_DEBUG
 "8c.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

648 
	}
}

650 
__öô
 
	$ˇlg¨y_ª£rve_mem_ªgi⁄
(
pci_dev
 *
dev
, 
u64
 
°¨t
,

651 
u64
 
limô
)

653 
num∑ges
;

655 
limô
 =Üimit | 0xfffff;

656 
limô
++;

658 
num∑ges
 = ((
limô
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

659 
	`iommu_ønge_ª£rve
(
	`pci_iommu
(
dev
->
bus
), 
°¨t
, 
num∑ges
);

660 
	}
}

662 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
pci_dev
 *
dev
)

664 
__iomem
 *
èrgë
;

665 
u64
 
low
, 
high
, 
sizñow
;

666 
u64
 
°¨t
, 
limô
;

667 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

668 
bu¢um
 = 
dev
->
bus
->
numbî
;

669 
__iomem
 *
bb¨
 = 
tbl
->bbar;

672 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_LOW
);

673 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

674 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_HIGH
);

675 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

676 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_SIZE
);

677 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

679 
°¨t
 = (
high
 << 32Ë| 
low
;

680 
limô
 = 
sizñow
;

682 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

683 
	}
}

685 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
pci_dev
 *
dev
)

687 
__iomem
 *
èrgë
;

688 
u32
 
vÆ32
;

689 
u64
 
low
, 
high
, 
sizñow
, 
sizehigh
;

690 
u64
 
°¨t
, 
limô
;

691 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

692 
bu¢um
 = 
dev
->
bus
->
numbî
;

693 
__iomem
 *
bb¨
 = 
tbl
->bbar;

696 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

697 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

698 i‡(!(
vÆ32
 & 
PHB_MEM2_ENABLE
))

701 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_LOW
);

702 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

703 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_HIGH
);

704 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

705 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_LOW
);

706 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

707 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_HIGH
);

708 
sizehigh
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

710 
°¨t
 = (
high
 << 32Ë| 
low
;

711 
limô
 = (
sizehigh
 << 32Ë| 
sizñow
;

713 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

714 
	}
}

723 
__öô
 
	$ˇlg¨y_ª£rve_ªgi⁄s
(
pci_dev
 *
dev
)

725 
≈ages
;

726 
u64
 
°¨t
;

727 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

730 
	`iommu_ønge_ª£rve
(
tbl
, 
bad_dma_addªss
, 
EMERGENCY_PAGES
);

734 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
)) {

735 
°¨t
 = (640 * 1024);

736 
≈ages
 = ((1024 - 640Ë* 1024Ë>> 
PAGE_SHIFT
;

738 
°¨t
 = 0;

739 
≈ages
 = (1 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

741 
	`iommu_ønge_ª£rve
(
tbl
, 
°¨t
, 
≈ages
);

744 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
dev
);

745 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
dev
);

746 
	}
}

748 
__öô
 
	$ˇlg¨y_£tup_èr
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

750 
u64
 
vÆ64
;

751 
u64
 
èbÀ_phys
;

752 
__iomem
 *
èrgë
;

753 
ªt
;

754 
iommu_èbÀ
 *
tbl
;

757 
ªt
 = 
	`buûd_t˚_èbÀ
(
dev
, 
bb¨
);

758 i‡(
ªt
)

759  
ªt
;

761 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

762 
tbl
->
ô_ba£
 = ()
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
;

764 i‡(
	`is_kdump_kî√l
())

765 
	`ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
tbl
);

767 
	`t˚_‰ì
(
tbl
, 0,Åbl->
ô_size
);

769 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
))

770 
tbl
->
chù_›s
 = &
ˇlg¨y_chù_›s
;

771 i‡(
	`is_ˇlioc2
(
dev
->
devi˚
))

772 
tbl
->
chù_›s
 = &
ˇlioc2_chù_›s
;

774 
	`BUG
();

776 
	`ˇlg¨y_ª£rve_ªgi⁄s
(
dev
);

779 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

780 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

783 
vÆ64
 &~
TAR_SW_BITS
;

784 
èbÀ_phys
 = (
u64
)
	`__∑
(
tbl
->
ô_ba£
);

786 
vÆ64
 |
èbÀ_phys
;

788 
	`BUG_ON
(
•ecifõd_èbÀ_size
 > 
TCE_TABLE_SIZE_8M
);

789 
vÆ64
 |(
u64
Ë
•ecifõd_èbÀ_size
;

791 
tbl
->
èr_vÆ
 = 
	`˝u_to_be64
(
vÆ64
);

793 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

794 
	`ªadq
(
èrgë
);

797 
	}
}

799 
__öô
 
	$ˇlg¨y_‰ì_bus
(
pci_dev
 *
dev
)

801 
u64
 
vÆ64
;

802 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

803 
__iomem
 *
èrgë
;

804 
bôm≠sz
;

806 
èrgë
 = 
	`ˇlg¨y_ªg
(
tbl
->
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

807 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

808 
vÆ64
 &~
TAR_SW_BITS
;

809 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

810 
	`ªadq
(
èrgë
);

812 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

813 
	`‰ì_∑ges
(()
tbl
->
ô_m≠
, 
	`gë_‹dî
(
bôm≠sz
));

814 
tbl
->
ô_m≠
 = 
NULL
;

816 
	`k‰ì
(
tbl
);

818 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

821 
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
 = 
NULL
;

822 
	}
}

824 
	$ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

826 
__iomem
 *
bb¨
 = 
tbl
->bbar;

827 
__iomem
 *
èrgë
;

828 
u32
 
c§
, 
∂s§
;

830 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

831 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

833 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

834 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

837 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on Calgary PHB 0x%x, "

838 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
ô_bu¢o
, 
c§
, 
∂s§
);

839 
	}
}

841 
	$ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

843 
__iomem
 *
bb¨
 = 
tbl
->bbar;

844 
u32
 
c§
, 
csmr
, 
∂s§
, 
mck
, 
rc°©
;

845 
__iomem
 *
èrgë
;

846 
phboff
 = 
	`phb_off£t
(
tbl
->
ô_bu¢o
);

847 
îroff
;

848 
u32
 
îºegs
[7];

849 
i
;

852 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_CSR_OFFSET
);

853 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

855 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

856 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

858 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x290);

859 
csmr
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

861 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x800);

862 
mck
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

864 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on CalIOC2 PHB 0x%x\n",

865 
tbl
->
ô_bu¢o
);

867 
	`¥ötk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

868 
c§
, 
∂s§
, 
csmr
, 
mck
);

871 
	`¥ötk
(
KERN_EMERG
 "Calgary: ");

872 
i
 = 0; i < 
	`ARRAY_SIZE
(
îºegs
); i++) {

874 
îroff
 = (0x810 + (
i
 * 0x10));

875 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
îroff
);

876 
îºegs
[
i
] = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

877 
	`¥ötk
("0x%08x@0x%lx ", 
îºegs
[
i
], 
îroff
);

879 
	`¥ötk
("\n");

882 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

883 
rc°©
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

884 
	`¥ötk
(
KERN_EMERG
 "CÆg¨y: 0x%08x@0x%x\n", 
rc°©
,

885 
PHB_ROOT_COMPLEX_STATUS
);

886 
	}
}

888 
	$ˇlg¨y_w©chdog
(
d©a
)

890 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

891 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

892 
__iomem
 *
bb¨
 = 
tbl
->bbar;

893 
u32
 
vÆ32
;

894 
__iomem
 *
èrgë
;

896 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

897 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

900 i‡(
vÆ32
 & 
CSR_AGENT_MASK
) {

901 
tbl
->
chù_›s
->
	`dump_îr‹_ªgs
(tbl);

904 
	`wrôñ
(0, 
èrgë
);

907 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
) |

908 
PHB_CONFIG_RW_OFFSET
);

909 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

910 
vÆ32
 |
PHB_SLOT_DISABLE
;

911 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

912 
	`ªadl
(
èrgë
);

915 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
 + 2 * 
HZ
);

917 
	}
}

919 
__öô
 
	$ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
__iomem
 *
bb¨
,

920 
bu¢um
, 
timeout
)

922 
u64
 
vÆ64
;

923 
__iomem
 *
èrgë
;

924 
phb_shi·
 = ~0;

925 
u64
 
mask
;

927 
	`bu¢o_to_phbid
(
bu¢um
)) {

928 0: 
phb_shi·
 = (63 - 19);

930 1: 
phb_shi·
 = (63 - 23);

932 2: 
phb_shi·
 = (63 - 27);

934 3: 
phb_shi·
 = (63 - 35);

937 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

940 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
CALGARY_CONFIG_REG
);

941 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

944 
mask
 = ~(0xFUL << 
phb_shi·
);

945 
vÆ64
 &
mask
;

946 
vÆ64
 |(
timeout
 << 
phb_shi·
);

947 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

948 
	`ªadq
(
èrgë
);

949 
	}
}

951 
__öô
 
	$ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

953 
bu¢um
 = 
dev
->
bus
->
numbî
;

954 
__iomem
 *
bb¨
 = 
tbl
->bbar;

955 
__iomem
 *
èrgë
;

956 
u32
 
vÆ
;

961 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_SAVIOR_L2
);

962 
vÆ
 = 
	`˝u_to_be32
(
	`ªadl
(
èrgë
));

963 
vÆ
 |= 0x00800000;

964 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

965 
	}
}

967 
__öô
 
	$ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

969 
bu¢um
 = 
dev
->
bus
->
numbî
;

975 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
Ë&& (
bu¢um
 == 1))

976 
	`ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
tbl
->
bb¨
, 
bu¢um
,

977 
CCR_2SEC_TIMEOUT
);

978 
	}
}

980 
__öô
 
	$ˇlg¨y_íabÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

982 
u32
 
vÆ32
;

983 
bu¢um
;

984 
__iomem
 *
èrgë
;

985 
__iomem
 *
bb¨
;

986 
iommu_èbÀ
 *
tbl
;

988 
bu¢um
 = 
dev
->
bus
->
numbî
;

989 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

990 
bb¨
 = 
tbl
->bbar;

993 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

994 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

995 
vÆ32
 |
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

997 
	`¥ötk
(
KERN_INFO
 "Calgary:ÉnablingÅranslation on %s PHB %#x\n",

998 (
dev
->
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
) ?

999 "CÆg¨y" : "CÆIOC2", 
bu¢um
);

1000 
	`¥ötk
(
KERN_INFO
 "Calgary:Érrant DMAs willÇow beÖrevented onÅhis "

1003 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1004 
	`ªadl
(
èrgë
);

1006 
	`öô_timî
(&
tbl
->
w©chdog_timî
);

1007 
tbl
->
w©chdog_timî
.
fun˘i⁄
 = &
ˇlg¨y_w©chdog
;

1008 
tbl
->
w©chdog_timî
.
d©a
 = ()
dev
;

1009 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
);

1010 
	}
}

1012 
__öô
 
	$ˇlg¨y_dißbÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

1014 
u32
 
vÆ32
;

1015 
bu¢um
;

1016 
__iomem
 *
èrgë
;

1017 
__iomem
 *
bb¨
;

1018 
iommu_èbÀ
 *
tbl
;

1020 
bu¢um
 = 
dev
->
bus
->
numbî
;

1021 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1022 
bb¨
 = 
tbl
->bbar;

1025 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

1026 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1027 
vÆ32
 &~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1029 
	`¥ötk
(
KERN_INFO
 "CÆg¨y: dißblögÅøn¶©i⁄ o¿PHB %#x!\n", 
bu¢um
);

1030 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1031 
	`ªadl
(
èrgë
);

1033 
	`dñ_timî_sync
(&
tbl
->
w©chdog_timî
);

1034 
	}
}

1036 
__öô
 
	$ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
pci_dev
 *
dev
)

1038 
	`pci_dev_gë
(
dev
);

1039 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1042 i‡(
dev
->
bus
->
∑ª¡
)

1043 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1045 
dev
->
bus
->
£lf
 = dev;

1046 
	}
}

1048 
__öô
 
	$ˇlg¨y_öô_⁄e
(
pci_dev
 *
dev
)

1050 
__iomem
 *
bb¨
;

1051 
iommu_èbÀ
 *
tbl
;

1052 
ªt
;

1054 
	`BUG_ON
(
dev
->
bus
->
numbî
 >
MAX_PHB_BUS_NUM
);

1056 
bb¨
 = 
	`bu¢o_to_bb¨
(
dev
->
bus
->
numbî
);

1057 
ªt
 = 
	`ˇlg¨y_£tup_èr
(
dev
, 
bb¨
);

1058 i‡(
ªt
)

1059 
d⁄e
;

1061 
	`pci_dev_gë
(
dev
);

1063 i‡(
dev
->
bus
->
∑ª¡
) {

1064 i‡(
dev
->
bus
->
∑ª¡
->
£lf
)

1065 
	`¥ötk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1066 "bus->∑ª¡->£lf!\n", 
dev
);

1067 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1069 
dev
->
bus
->
£lf
 = dev;

1071 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1072 
tbl
->
chù_›s
->
	`h™dÀ_quúks
—bl, 
dev
);

1074 
	`ˇlg¨y_íabÀ_å™¶©i⁄
(
dev
);

1078 
d⁄e
:

1079  
ªt
;

1080 
	}
}

1082 
__öô
 
	$ˇlg¨y_loˇã_bb¨s
()

1084 
ªt
;

1085 
rioidx
, 
phb
, 
bus
;

1086 
__iomem
 *
bb¨
;

1087 
__iomem
 *
èrgë
;

1088 
off£t
;

1089 
u8
 
°¨t_bus
, 
íd_bus
;

1090 
u32
 
vÆ
;

1092 
ªt
 = -
ENODATA
;

1093 
rioidx
 = 0;Ñioidx < 
rio_èbÀ_hdr
->
num_rio_dev
;Ñioidx++) {

1094 
rio_dëaû
 *
rio
 = 
rio_devs
[
rioidx
];

1096 i‡((
rio
->
ty≥
 !
COMPAT_CALGARY
Ë&& (rio->ty≥ !
ALT_CALGARY
))

1100 
bb¨
 = 
	`i‹em≠_noˇche
(
rio
->
BBAR
, 1024 * 1024);

1101 i‡(!
bb¨
)

1102 
îr‹
;

1104 
phb
 = 0;Öhb < 
PHBS_PER_CALGARY
;Öhb++) {

1105 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1106 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
off£t
);

1108 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1110 
°¨t_bus
 = (
u8
)((
vÆ
 & 0x00FF0000) >> 16);

1111 
íd_bus
 = (
u8
)((
vÆ
 & 0x0000FF00) >> 8);

1113 i‡(
íd_bus
) {

1114 
bus
 = 
°¨t_bus
; bu†<
íd_bus
; bus++) {

1115 
bus_öfo
[
bus
].
bb¨
 = bbar;

1116 
bus_öfo
[
bus
].
phbid
 = 
phb
;

1119 
bus_öfo
[
°¨t_bus
].
bb¨
 = bbar;

1120 
bus_öfo
[
°¨t_bus
].
phbid
 = 
phb
;

1127 
îr‹
:

1129 
bus
 = 0; bu†< 
	`ARRAY_SIZE
(
bus_öfo
); bus++)

1130 i‡(
bus_öfo
[
bus
].
bb¨
)

1131 
	`iounm≠
(
bus_öfo
[
bus
].
bb¨
);

1133  
ªt
;

1134 
	}
}

1136 
__öô
 
	$ˇlg¨y_öô
()

1138 
ªt
;

1139 
pci_dev
 *
dev
 = 
NULL
;

1140 
ˇlg¨y_bus_öfo
 *
öfo
;

1142 
ªt
 = 
	`ˇlg¨y_loˇã_bb¨s
();

1143 i‡(
ªt
)

1144  
ªt
;

1147 i‡(
	`is_kdump_kî√l
())

1148 
	`gë_t˚_•a˚_‰om_èr
();

1151 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1152 i‡(!
dev
)

1154 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1157 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1158 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1159 
	`ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
dev
);

1163 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1166 
ªt
 = 
	`ˇlg¨y_öô_⁄e
(
dev
);

1167 i‡(
ªt
)

1168 
îr‹
;

1171 
dev
 = 
NULL
;

1172 
	`f‹_óch_pci_dev
(
dev
) {

1173 
iommu_èbÀ
 *
tbl
;

1175 
tbl
 = 
	`föd_iommu_èbÀ
(&
dev
->dev);

1177 i‡(
	`å™¶©i⁄_íabÀd
(
tbl
))

1178 
dev
->dev.
¨chd©a
.
dma_›s
 = &
ˇlg¨y_dma_›s
;

1181  
ªt
;

1183 
îr‹
:

1185 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1186 i‡(!
dev
)

1188 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1191 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1192 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1193 
	`pci_dev_put
(
dev
);

1196 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1199 
	`ˇlg¨y_dißbÀ_å™¶©i⁄
(
dev
);

1200 
	`ˇlg¨y_‰ì_bus
(
dev
);

1201 
	`pci_dev_put
(
dev
);

1202 
dev
->dev.
¨chd©a
.
dma_›s
 = 
NULL
;

1205  
ªt
;

1206 
	}
}

1208 
ölöe
 
__öô
 
	$dëîmöe_t˚_èbÀ_size
(
u64
 
øm
)

1210 
ªt
;

1212 i‡(
•ecifõd_èbÀ_size
 !
TCE_TABLE_SIZE_UNSPECIFIED
)

1213  
•ecifõd_èbÀ_size
;

1222 
ªt
 = 
	`gë_‹dî
(
øm
 >> 13);

1223 i‡(
ªt
 > 
TCE_TABLE_SIZE_8M
)

1224 
ªt
 = 
TCE_TABLE_SIZE_8M
;

1226  
ªt
;

1227 
	}
}

1229 
__öô
 
	$buûd_dëaû_¨øys
()

1231 
±r
;

1232 
numnodes
, 
i
;

1233 
sˇl_dëaû_size
, 
rio_dëaû_size
;

1235 
numnodes
 = 
rio_èbÀ_hdr
->
num_sˇl_dev
;

1236 i‡(
numnodes
 > 
MAX_NUMNODES
){

1237 
	`¥ötk
(
KERN_WARNING


1240 
MAX_NUMNODES
, 
numnodes
);

1241  -
ENODEV
;

1244 
rio_èbÀ_hdr
->
vîsi⁄
){

1246 
sˇl_dëaû_size
 = 11;

1247 
rio_dëaû_size
 = 13;

1250 
sˇl_dëaû_size
 = 12;

1251 
rio_dëaû_size
 = 15;

1254 
	`¥ötk
(
KERN_WARNING


1256 
rio_èbÀ_hdr
->
vîsi⁄
);

1257  -
EPROTO
;

1260 
±r
 = (()
rio_èbÀ_hdr
) + 3;

1261 
i
 = 0; i < 
numnodes
; i++, 
±r
 +
sˇl_dëaû_size
)

1262 
sˇl_devs
[
i
] = (
sˇl_dëaû
 *)
±r
;

1264 
i
 = 0; i < 
rio_èbÀ_hdr
->
num_rio_dev
;

1265 
i
++, 
±r
 +
rio_dëaû_size
)

1266 
rio_devs
[
i
] = (
rio_dëaû
 *)
±r
;

1269 
	}
}

1271 
__öô
 
	$ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_dev
)

1273 
dev
;

1274 
u32
 
vÆ
;

1276 i‡(
pci_dev
 =
PCI_DEVICE_ID_IBM_CALIOC2
) {

1284 
dev
 = 1; dev < 8; dev++) {

1285 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 0, 0);

1286 i‡(
vÆ
 != 0xffffffff)

1289  (
vÆ
 != 0xffffffff);

1290 
	}
}

1297 
	$ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
)

1299 
u64
 *
ç
;

1300 
ödex
;

1301 
ç
 = ((
u64
 *)
tbl
->
ô_ba£
);

1302 
ödex
 = 0 ; index < 
tbl
->
ô_size
; index++) {

1303 i‡(*
ç
 != 0x0)

1304 
	`£t_bô
(
ödex
, 
tbl
->
ô_m≠
);

1305 
ç
++;

1307 
	}
}

1314 
__öô
 
	$gë_t˚_•a˚_‰om_èr
()

1316 
bus
;

1317 
__iomem
 *
èrgë
;

1318 
t˚_•a˚
;

1320 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1321 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1322 
pci_devi˚
;

1323 
u32
 
vÆ
;

1325 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1326 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1328 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1330 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1333 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1334 
å™¶©e_em±y_¶Ÿs
) {

1335 
èrgë
 = 
	`ˇlg¨y_ªg
(
bus_öfo
[
bus
].
bb¨
,

1336 
	`èr_off£t
(
bus
));

1337 
t˚_•a˚
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

1338 
t˚_•a˚
 =Å˚_•a˚ & 
TAR_SW_BITS
;

1340 
t˚_•a˚
 =Å˚_•a˚ & (~
•ecifõd_èbÀ_size
);

1341 
öfo
->
t˚_•a˚
 = (
u64
 *)
	`__va
(tce_space);

1345 
	}
}

1347 
__öô
 
	$dëe˘_ˇlg¨y
()

1349 
bus
;

1350 *
tbl
;

1351 
ˇlg¨y_found
 = 0;

1352 
±r
;

1353 
off£t
, 
¥ev_off£t
;

1354 
ªt
;

1360 i‡(
swiŸlb
 || 
no_iommu
 || 
iommu_dëe˘ed
)

1363 i‡(!
u£_ˇlg¨y
)

1366 i‡(!
	`óæy_pci_Ælowed
())

1369 
	`¥ötk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDAárea\n");

1371 
±r
 = ()
	`phys_to_vút
(
	`gë_bios_ebda
());

1373 
rio_èbÀ_hdr
 = 
NULL
;

1374 
¥ev_off£t
 = 0;

1375 
off£t
 = 0x180;

1380 
off£t
 > 
¥ev_off£t
) {

1382 i‡(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1384 
rio_èbÀ_hdr
 = (rio_èbÀ_hd∏*)(
±r
 + 
off£t
 + 4);

1387 
¥ev_off£t
 = 
off£t
;

1388 
off£t
 = *((*)(
±r
 + offset));

1390 i‡(!
rio_èbÀ_hdr
) {

1391 
	`¥ötk
(
KERN_DEBUG
 "Calgary: UnableÅoÜocate Rio GrandeÅable "

1396 
ªt
 = 
	`buûd_dëaû_¨øys
();

1397 i‡(
ªt
) {

1398 
	`¥ötk
(
KERN_DEBUG
 "CÆg¨y: buûd_dëaû_¨øy†ªà%d\n", 
ªt
);

1402 
•ecifõd_èbÀ_size
 = 
	`dëîmöe_t˚_èbÀ_size
((
	`is_kdump_kî√l
() ?

1403 
ßved_max_p‚
 : 
max_p‚
Ë* 
PAGE_SIZE
);

1405 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1406 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1407 
pci_devi˚
;

1408 
u32
 
vÆ
;

1410 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1411 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1413 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1416 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1419 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1420 
å™¶©e_em±y_¶Ÿs
) {

1425 i‡(!
	`is_kdump_kî√l
()) {

1426 
tbl
 = 
	`Æloc_t˚_èbÀ
();

1427 i‡(!
tbl
)

1428 
˛ónup
;

1429 
öfo
->
t˚_•a˚
 = 
tbl
;

1431 
ˇlg¨y_found
 = 1;

1435 
	`¥ötk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1436 
ˇlg¨y_found
 ? "found" : "not found");

1438 i‡(
ˇlg¨y_found
) {

1439 
iommu_dëe˘ed
 = 1;

1440 
ˇlg¨y_dëe˘ed
 = 1;

1441 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1442 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary TCEÅable spec is %d\n",

1443 
•ecifõd_èbÀ_size
);

1446 i‡(
max_p‚
 > 
MAX_DMA32_PFN
)

1447 
swiŸlb
 = 1;

1451 
˛ónup
:

1452 --
bus
; bus >= 0; --bus) {

1453 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1455 i‡(
öfo
->
t˚_•a˚
)

1456 
	`‰ì_t˚_èbÀ
(
öfo
->
t˚_•a˚
);

1458 
	}
}

1460 
__öô
 
	$ˇlg¨y_iommu_öô
()

1462 
ªt
;

1464 i‡(
no_iommu
 || (
swiŸlb
 && !
ˇlg¨y_dëe˘ed
))

1465  -
ENODEV
;

1467 i‡(!
ˇlg¨y_dëe˘ed
)

1468  -
ENODEV
;

1471 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1473 
ªt
 = 
	`ˇlg¨y_öô
();

1474 i‡(
ªt
) {

1475 
	`¥ötk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1476 "ÁŒög backÅÿno_iommu\n", 
ªt
);

1477  
ªt
;

1480 
f‹˚_iommu
 = 1;

1481 
bad_dma_addªss
 = 0x0;

1483 i‡(!
dma_›s
)

1484 
dma_›s
 = &
nommu_dma_›s
;

1487 
	}
}

1489 
__öô
 
	$ˇlg¨y_∑r£_›ti⁄s
(*
p
)

1491 
bridge
;

1492 
size_t
 
Àn
;

1493 * 
ídp
;

1495 *
p
) {

1496 i‡(!
	`°∫cmp
(
p
, "64k", 3))

1497 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_64K
;

1498 i‡(!
	`°∫cmp
(
p
, "128k", 4))

1499 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_128K
;

1500 i‡(!
	`°∫cmp
(
p
, "256k", 4))

1501 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_256K
;

1502 i‡(!
	`°∫cmp
(
p
, "512k", 4))

1503 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_512K
;

1504 i‡(!
	`°∫cmp
(
p
, "1M", 2))

1505 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_1M
;

1506 i‡(!
	`°∫cmp
(
p
, "2M", 2))

1507 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_2M
;

1508 i‡(!
	`°∫cmp
(
p
, "4M", 2))

1509 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_4M
;

1510 i‡(!
	`°∫cmp
(
p
, "8M", 2))

1511 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_8M
;

1513 
Àn
 = 
	`°æí
("translate_empty_slots");

1514 i‡(!
	`°∫cmp
(
p
, "å™¶©e_em±y_¶Ÿs", 
Àn
))

1515 
å™¶©e_em±y_¶Ÿs
 = 1;

1517 
Àn
 = 
	`°æí
("disable");

1518 i‡(!
	`°∫cmp
(
p
, "dißbÀ", 
Àn
)) {

1519 
p
 +
Àn
;

1520 i‡(*
p
 == '=')

1521 ++
p
;

1522 i‡(*
p
 == '\0')

1524 
bridge
 = 
	`sim∂e_°πoul
(
p
, &
ídp
, 0);

1525 i‡(
p
 =
ídp
)

1528 i‡(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1529 
	`¥ötk
(
KERN_INFO
 "Calgary: disabling "

1530 "å™¶©i⁄ f‹ PHB %#x\n", 
bridge
);

1531 
bus_öfo
[
bridge
].
å™¶©i⁄_dißbÀd
 = 1;

1535 
p
 = 
	`°Ωbrk
(p, ",");

1536 i‡(!
p
)

1539 
p
++;

1542 
	}
}

1543 
__£tup
("ˇlg¨y=", 
ˇlg¨y_∑r£_›ti⁄s
);

1545 
__öô
 
	$ˇlg¨y_fixup_⁄e_t˚_•a˚
(
pci_dev
 *
dev
)

1547 
iommu_èbÀ
 *
tbl
;

1548 
≈ages
;

1549 
i
;

1551 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1553 
i
 = 0; i < 4; i++) {

1554 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
PCI_BRIDGE_RESOURCES
 + 
i
];

1557 i‡(!(
r
->
Êags
 & 
IORESOURCE_MEM
))

1561 i‡(!
r
->
°¨t
)

1565 
≈ages
 = (
r
->
íd
 -Ñ->
°¨t
Ë>> 
PAGE_SHIFT
;

1566 
≈ages
++;

1568 
	`iommu_ønge_ª£rve
(
tbl
, 
r
->
°¨t
, 
≈ages
);

1570 
	}
}

1572 
__öô
 
	$ˇlg¨y_fixup_t˚_•a˚s
()

1574 
pci_dev
 *
dev
 = 
NULL
;

1575 
ˇlg¨y_bus_öfo
 *
öfo
;

1577 i‡(
no_iommu
 || 
swiŸlb
 || !
ˇlg¨y_dëe˘ed
)

1578  -
ENODEV
;

1580 
	`¥ötk
(
KERN_DEBUG
 "Calgary: fixing upÅce spaces\n");

1583 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1584 i‡(!
dev
)

1586 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1589 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1590 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1593 i‡(!
öfo
->
t˚_•a˚
)

1596 
	`ˇlg¨y_fixup_⁄e_t˚_•a˚
(
dev
);

1601 
	}
}

1607 
roŸfs_öôˇŒ
(
ˇlg¨y_fixup_t˚_•a˚s
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<löux/dma-m≠pög.h
>

2 
	~<löux/dma-debug.h
>

3 
	~<löux/dm¨.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/pci.h
>

6 
	~<löux/kmemÀak.h
>

8 
	~<asm/¥Ÿo.h
>

9 
	~<asm/dma.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/g¨t.h
>

12 
	~<asm/ˇlg¨y.h
>

13 
	~<asm/amd_iommu.h
>

15 
f‹bid_dac
 
	g__ªad_mo°ly
;

17 
dma_m≠_›s
 *
	gdma_›s
;

18 
EXPORT_SYMBOL
(
dma_›s
);

20 
iommu_ßc_f‹˚
 
	g__ªad_mo°ly
;

22 #ifde‡
CONFIG_IOMMU_DEBUG


23 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 1;

24 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 1;

26 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 0;

27 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 0;

30 
iommu_mîge
 
	g__ªad_mo°ly
 = 0;

32 
no_iommu
 
	g__ªad_mo°ly
;

34 
iommu_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

43 
iommu_∑ss_through
 
	g__ªad_mo°ly
;

45 
dma_addr_t
 
bad_dma_addªss
 
	g__ªad_mo°ly
 = 0;

46 
EXPORT_SYMBOL
(
bad_dma_addªss
);

49 
devi˚
 
	gx86_dma_ÁŒback_dev
 = {

50 .
öô_«me
 = "fallback device",

51 .
	gcohîít_dma_mask
 = 
ISA_DMA_BIT_MASK
,

52 .
	gdma_mask
 = &
x86_dma_ÁŒback_dev
.
cohîít_dma_mask
,

54 
EXPORT_SYMBOL
(
x86_dma_ÁŒback_dev
);

57 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

59 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

61 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

62  -
EIO
;

64 *
dev
->
dma_mask
 = 
mask
;

67 
	}
}

68 
EXPORT_SYMBOL
(
dma_£t_mask
);

70 #ifde‡
CONFIG_X86_64


71 
__öôd©a
 *
	gdma32_boŸmem_±r
;

72 
dma32_boŸmem_size
 
	g__öôd©a
 = (128ULL<<20);

74 
__öô
 
	$∑r£_dma32_size_›t
(*
p
)

76 i‡(!
p
)

77  -
EINVAL
;

78 
dma32_boŸmem_size
 = 
	`mem∑r£
(
p
, &p);

80 
	}
}

81 
óæy_∑øm
("dma32_size", 
∑r£_dma32_size_›t
);

83 
__öô
 
	$dma32_ª£rve_boŸmem
()

85 
size
, 
Æign
;

86 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

93 
Æign
 = 64ULL<<20;

94 
size
 = 
	`roundup
(
dma32_boŸmem_size
, 
Æign
);

95 
dma32_boŸmem_±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
,

101 
	`kmemÀak_ign‹e
(
dma32_boŸmem_±r
);

102 i‡(
dma32_boŸmem_±r
)

103 
dma32_boŸmem_size
 = 
size
;

105 
dma32_boŸmem_size
 = 0;

106 
	}
}

107 
__öô
 
	$dma32_‰ì_boŸmem
()

110 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

113 i‡(!
dma32_boŸmem_±r
)

116 
	`‰ì_boŸmem
(
	`__∑
(
dma32_boŸmem_±r
), 
dma32_boŸmem_size
);

118 
dma32_boŸmem_±r
 = 
NULL
;

119 
dma32_boŸmem_size
 = 0;

120 
	}
}

123 
__öô
 
	$pci_iommu_Æloc
()

125 #ifde‡
CONFIG_X86_64


127 
	`dma32_‰ì_boŸmem
();

134 
	`g¨t_iommu_hﬁe_öô
();

136 
	`dëe˘_ˇlg¨y
();

138 
	`dëe˘_öãl_iommu
();

140 
	`amd_iommu_dëe˘
();

142 
	`pci_swiŸlb_öô
();

143 
	}
}

145 *
	$dma_gíîic_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

146 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

148 
dma_mask
;

149 
∑ge
 *page;

150 
dma_addr_t
 
addr
;

152 
dma_mask
 = 
	`dma_Æloc_cohîít_mask
(
dev
, 
Êag
);

154 
Êag
 |
__GFP_ZERO
;

155 
agaö
:

156 
∑ge
 = 
	`Æloc_∑ges_node
(
	`dev_to_node
(
dev
), 
Êag
, 
	`gë_‹dî
(
size
));

157 i‡(!
∑ge
)

158  
NULL
;

160 
addr
 = 
	`∑ge_to_phys
(
∑ge
);

161 i‡(
addr
 + 
size
 > 
dma_mask
) {

162 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

164 i‡(
dma_mask
 < 
	`DMA_BIT_MASK
(32Ë&& !(
Êag
 & 
GFP_DMA
)) {

165 
Êag
 = (Êag & ~
GFP_DMA32
Ë| 
GFP_DMA
;

166 
agaö
;

169  
NULL
;

172 *
dma_addr
 = 
addr
;

173  
	`∑ge_addªss
(
∑ge
);

174 
	}
}

180 
__öô
 
	$iommu_£tup
(*
p
)

182 
iommu_mîge
 = 1;

184 i‡(!
p
)

185  -
EINVAL
;

187 *
p
) {

188 i‡(!
	`°∫cmp
(
p
, "off", 3))

189 
no_iommu
 = 1;

191 i‡(!
	`°∫cmp
(
p
, "force", 5))

192 
f‹˚_iommu
 = 1;

193 i‡(!
	`°∫cmp
(
p
, "noforce", 7)) {

194 
iommu_mîge
 = 0;

195 
f‹˚_iommu
 = 0;

198 i‡(!
	`°∫cmp
(
p
, "biomerge", 8)) {

199 
iommu_mîge
 = 1;

200 
f‹˚_iommu
 = 1;

202 i‡(!
	`°∫cmp
(
p
, "panic", 5))

203 
∑nic_⁄_ovîÊow
 = 1;

204 i‡(!
	`°∫cmp
(
p
, "nopanic", 7))

205 
∑nic_⁄_ovîÊow
 = 0;

206 i‡(!
	`°∫cmp
(
p
, "merge", 5)) {

207 
iommu_mîge
 = 1;

208 
f‹˚_iommu
 = 1;

210 i‡(!
	`°∫cmp
(
p
, "nomerge", 7))

211 
iommu_mîge
 = 0;

212 i‡(!
	`°∫cmp
(
p
, "forcesac", 8))

213 
iommu_ßc_f‹˚
 = 1;

214 i‡(!
	`°∫cmp
(
p
, "allowdac", 8))

215 
f‹bid_dac
 = 0;

216 i‡(!
	`°∫cmp
(
p
, "nodac", 5))

217 
f‹bid_dac
 = -1;

218 i‡(!
	`°∫cmp
(
p
, "usedac", 6)) {

219 
f‹bid_dac
 = -1;

222 #ifde‡
CONFIG_SWIOTLB


223 i‡(!
	`°∫cmp
(
p
, "soft", 4))

224 
swiŸlb
 = 1;

226 i‡(!
	`°∫cmp
(
p
, "pt", 2))

227 
iommu_∑ss_through
 = 1;

229 
	`g¨t_∑r£_›ti⁄s
(
p
);

231 #ifde‡
CONFIG_CALGARY_IOMMU


232 i‡(!
	`°∫cmp
(
p
, "calgary", 7))

233 
u£_ˇlg¨y
 = 1;

236 
p
 +
	`°rc•n
(p, ",");

237 i‡(*
p
 == ',')

238 ++
p
;

241 
	}
}

242 
óæy_∑øm
("iommu", 
iommu_£tup
);

244 
	$dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

246 
dma_m≠_›s
 *
›s
 = 
	`gë_dma_›s
(
dev
);

248 #ifde‡
CONFIG_PCI


249 i‡(
mask
 > 0xfffffff‡&& 
f‹bid_dac
 > 0) {

250 
	`dev_öfo
(
dev
, "PCI: Disallowing DAC for device\n");

255 i‡(
›s
->
dma_suµ‹ãd
)

256  
›s
->
	`dma_suµ‹ãd
(
dev
, 
mask
);

261 i‡(
mask
 < 
	`DMA_BIT_MASK
(24))

276 i‡(
iommu_ßc_f‹˚
 && (
mask
 >
	`DMA_BIT_MASK
(40))) {

277 
	`dev_öfo
(
dev
, "F‹˚ SAC wôh mask %Lx\n", 
mask
);

282 
	}
}

283 
EXPORT_SYMBOL
(
dma_suµ‹ãd
);

285 
__öô
 
	$pci_iommu_öô
()

287 
	`dma_debug_öô
(
PREALLOC_DMA_DEBUG_ENTRIES
);

289 #ifde‡
CONFIG_PCI


290 
	`dma_debug_add_bus
(&
pci_bus_ty≥
);

293 
	`ˇlg¨y_iommu_öô
();

295 
	`öãl_iommu_öô
();

297 
	`amd_iommu_öô
();

299 
	`g¨t_iommu_öô
();

301 
	`no_iommu_öô
();

303 
	}
}

305 
	$pci_iommu_shutdown
()

307 
	`g¨t_iommu_shutdown
();

309 
	`amd_iommu_shutdown
();

310 
	}
}

312 
roŸfs_öôˇŒ
(
pci_iommu_öô
);

314 #ifde‡
CONFIG_PCI


317 
__devöô
 
	$vü_no_dac
(
pci_dev
 *
dev
)

319 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
 && 
f‹bid_dac
 == 0) {

320 
	`dev_öfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

321 
f‹bid_dac
 = 1;

323 
	}
}

324 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vü_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<löux/ty≥s.h
>

15 
	~<löux/˘y≥.h
>

16 
	~<löux/agp_backíd.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/•ölock.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/t›ﬁogy.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bô›s.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<löux/iommu-hñ≥r.h
>

30 
	~<löux/sysdev.h
>

31 
	~<löux/io.h
>

32 
	~<asm/©omic.h
>

33 
	~<asm/mår.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/¥Ÿo.h
>

36 
	~<asm/iommu.h
>

37 
	~<asm/g¨t.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/swiŸlb.h
>

40 
	~<asm/dma.h
>

41 
	~<asm/k8.h
>

43 
	giommu_bus_ba£
;

44 
	giommu_size
;

45 
	giommu_∑ges
;

47 
u32
 *
	giommu_g©t_ba£
;

56 
	giommu_fuŒÊush
 = 1;

59 
DEFINE_SPINLOCK
(
iommu_bôm≠_lock
);

61 *
	giommu_g¨t_bôm≠
;

63 
u32
 
	gg¨t_unm≠≥d_íåy
;

65 
	#GPTE_VALID
 1

	)

66 
	#GPTE_COHERENT
 2

	)

67 
	#GPTE_ENCODE
(
x
) \

68 (((
x
Ë& 0xfffff000Ë| (((xË>> 32Ë<< 4Ë| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

69 
	#GPTE_DECODE
(
x
Ë(((xË& 0xfffff000Ë| (((
u64
)(xË& 0xff0Ë<< 28))

	)

71 
	#EMERGENCY_PAGES
 32

	)

73 #ifde‡
CONFIG_AGP


74 
	#AGPEXTERN
 

	)

76 
	#AGPEXTERN


	)

80 
AGPEXTERN
 
agp_mem‹y_ª£rved
;

81 
AGPEXTERN
 
__u32
 *
	gagp_g©t_èbÀ
;

83 
	g√xt_bô
;

84 
boﬁ
 
	g√ed_Êush
;

86 
	$Æloc_iommu
(
devi˚
 *
dev
, 
size
,

87 
Æign_mask
)

89 
off£t
, 
Êags
;

90 
bound¨y_size
;

91 
ba£_ödex
;

93 
ba£_ödex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_gë_£g_bound¨y
(
dev
),

94 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

95 
bound¨y_size
 = 
	`ALIGN
(()
	`dma_gë_£g_bound¨y
(
dev
) + 1,

96 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

98 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

99 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 
√xt_bô
,

100 
size
, 
ba£_ödex
, 
bound¨y_size
, 
Æign_mask
);

101 i‡(
off£t
 == -1) {

102 
√ed_Êush
 = 
åue
;

103 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 0,

104 
size
, 
ba£_ödex
, 
bound¨y_size
,

105 
Æign_mask
);

107 i‡(
off£t
 != -1) {

108 
√xt_bô
 = 
off£t
+
size
;

109 i‡(
√xt_bô
 >
iommu_∑ges
) {

110 
√xt_bô
 = 0;

111 
√ed_Êush
 = 
åue
;

114 i‡(
iommu_fuŒÊush
)

115 
√ed_Êush
 = 
åue
;

116 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

118  
off£t
;

119 
	}
}

121 
	$‰ì_iommu
(
off£t
, 
size
)

123 
Êags
;

125 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

126 
	`iommu_¨ó_‰ì
(
iommu_g¨t_bôm≠
, 
off£t
, 
size
);

127 i‡(
off£t
 >
√xt_bô
)

128 
√xt_bô
 = 
off£t
 + 
size
;

129 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

130 
	}
}

135 
	$Êush_g¨t
()

137 
Êags
;

139 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

140 i‡(
√ed_Êush
) {

141 
	`k8_Êush_g¨ts
();

142 
√ed_Êush
 = 
Ál£
;

144 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

145 
	}
}

147 #ifde‡
CONFIG_IOMMU_LEAK


149 
	gÀak_åa˚
;

150 
	giommu_Àak_∑ges
 = 20;

152 
	$dump_Àak
()

154 
dump
;

156 i‡(
dump
)

158 
dump
 = 1;

160 
	`show_°ack
(
NULL
, NULL);

161 
	`debug_dma_dump_m≠pögs
(
NULL
);

162 
	}
}

165 
	$iommu_fuŒ
(
devi˚
 *
dev
, 
size_t
 
size
, 
dú
)

177 
	`dev_îr
(
dev
, "PCI-DMA: Ouào‡IOMMU s∑˚ f‹ %lu byãs\n", 
size
);

179 i‡(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

180 i‡(
dú
 =
PCI_DMA_FROMDEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

181 
	`∑nic
("PCI-DMA: Memory would be corrupted\n");

182 i‡(
dú
 =
PCI_DMA_TODEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

183 
	`∑nic
(
KERN_ERR


186 #ifde‡
CONFIG_IOMMU_LEAK


187 
	`dump_Àak
();

189 
	}
}

191 
ölöe
 

192 
	$√ed_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

194  
f‹˚_iommu
 || !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

195 
	}
}

197 
ölöe
 

198 
	$n⁄f‹˚d_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

200  !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

201 
	}
}

206 
dma_addr_t
 
	$dma_m≠_¨ó
(
devi˚
 *
dev
, 
dma_addr_t
 
phys_mem
,

207 
size_t
 
size
, 
dú
, 
Æign_mask
)

209 
≈ages
 = 
	`iommu_num_∑ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

210 
iommu_∑ge
 = 
	`Æloc_iommu
(
dev
, 
≈ages
, 
Æign_mask
);

211 
i
;

213 i‡(
iommu_∑ge
 == -1) {

214 i‡(!
	`n⁄f‹˚d_iommu
(
dev
, 
phys_mem
, 
size
))

215  
phys_mem
;

216 i‡(
∑nic_⁄_ovîÊow
)

217 
	`∑nic
("dma_m≠_¨ó ovîÊow %lu byãs\n", 
size
);

218 
	`iommu_fuŒ
(
dev
, 
size
, 
dú
);

219  
bad_dma_addªss
;

222 
i
 = 0; i < 
≈ages
; i++) {

223 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

224 
phys_mem
 +
PAGE_SIZE
;

226  
iommu_bus_ba£
 + 
iommu_∑ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

227 
	}
}

230 
dma_addr_t
 
	$g¨t_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

231 
off£t
, 
size_t
 
size
,

232 
dma_d©a_dúe˘i⁄
 
dú
,

233 
dma_©ås
 *
©ås
)

235 
bus
;

236 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

238 i‡(!
dev
)

239 
dev
 = &
x86_dma_ÁŒback_dev
;

241 i‡(!
	`√ed_iommu
(
dev
, 
∑ddr
, 
size
))

242  
∑ddr
;

244 
bus
 = 
	`dma_m≠_¨ó
(
dev
, 
∑ddr
, 
size
, 
dú
, 0);

245 
	`Êush_g¨t
();

247  
bus
;

248 
	}
}

253 
	$g¨t_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

254 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

255 
dma_©ås
 *
©ås
)

257 
iommu_∑ge
;

258 
≈ages
;

259 
i
;

261 i‡(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

262 
dma_addr
 >
iommu_bus_ba£
 + 
iommu_size
)

265 
iommu_∑ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

266 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

267 
i
 = 0; i < 
≈ages
; i++) {

268 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
g¨t_unm≠≥d_íåy
;

270 
	`‰ì_iommu
(
iommu_∑ge
, 
≈ages
);

271 
	}
}

276 
	$g¨t_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

277 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

279 
sˇâîli°
 *
s
;

280 
i
;

282 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

283 i‡(!
s
->
dma_Àngth
 || !s->
Àngth
)

285 
	`g¨t_unm≠_∑ge
(
dev
, 
s
->
dma_addªss
, s->
dma_Àngth
, 
dú
, 
NULL
);

287 
	}
}

290 
	$dma_m≠_sg_n⁄f‹˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

291 
√¡s
, 
dú
)

293 
sˇâîli°
 *
s
;

294 
i
;

296 #ifde‡
CONFIG_IOMMU_DEBUG


297 
	`¥ötk
(
KERN_DEBUG
 "dma_map_sg overflow\n");

300 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

301 
addr
 = 
	`sg_phys
(
s
);

303 i‡(
	`n⁄f‹˚d_iommu
(
dev
, 
addr
, 
s
->
Àngth
)) {

304 
addr
 = 
	`dma_m≠_¨ó
(
dev
,áddr, 
s
->
Àngth
, 
dú
, 0);

305 i‡(
addr
 =
bad_dma_addªss
) {

306 i‡(
i
 > 0)

307 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
i
, 
dú
, 
NULL
);

308 
√¡s
 = 0;

309 
sg
[0].
dma_Àngth
 = 0;

313 
s
->
dma_addªss
 = 
addr
;

314 
s
->
dma_Àngth
 = s->
Àngth
;

316 
	`Êush_g¨t
();

318  
√¡s
;

319 
	}
}

322 
	$__dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
,

323 
√Àms
, 
sˇâîli°
 *
sout
,

324 
∑ges
)

326 
iommu_°¨t
 = 
	`Æloc_iommu
(
dev
, 
∑ges
, 0);

327 
iommu_∑ge
 = 
iommu_°¨t
;

328 
sˇâîli°
 *
s
;

329 
i
;

331 i‡(
iommu_°¨t
 == -1)

334 
	`f‹_óch_sg
(
°¨t
, 
s
, 
√Àms
, 
i
) {

335 
∑ges
, 
addr
;

336 
phys_addr
 = 
s
->
dma_addªss
;

338 
	`BUG_ON
(
s
 !
°¨t
 && s->
off£t
);

339 i‡(
s
 =
°¨t
) {

340 
sout
->
dma_addªss
 = 
iommu_bus_ba£
;

341 
sout
->
dma_addªss
 +
iommu_∑ge
*
PAGE_SIZE
 + 
s
->
off£t
;

342 
sout
->
dma_Àngth
 = 
s
->
Àngth
;

344 
sout
->
dma_Àngth
 +
s
->
Àngth
;

347 
addr
 = 
phys_addr
;

348 
∑ges
 = 
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

349 
∑ges
--) {

350 
iommu_g©t_ba£
[
iommu_∑ge
] = 
	`GPTE_ENCODE
(
addr
);

351 
addr
 +
PAGE_SIZE
;

352 
iommu_∑ge
++;

355 
	`BUG_ON
(
iommu_∑ge
 - 
iommu_°¨t
 !
∑ges
);

358 
	}
}

360 
ölöe
 

361 
	$dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
, 
√Àms
,

362 
sˇâîli°
 *
sout
, 
∑ges
, 
√ed
)

364 i‡(!
√ed
) {

365 
	`BUG_ON
(
√Àms
 != 1);

366 
sout
->
dma_addªss
 = 
°¨t
->dma_address;

367 
sout
->
dma_Àngth
 = 
°¨t
->
Àngth
;

370  
	`__dma_m≠_c⁄t
(
dev
, 
°¨t
, 
√Àms
, 
sout
, 
∑ges
);

371 
	}
}

377 
	$g¨t_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

378 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

380 
sˇâîli°
 *
s
, *
ps
, *
°¨t_sg
, *
sgm≠
;

381 
√ed
 = 0, 
√xäìd
, 
i
, 
out
, 
°¨t
;

382 
∑ges
 = 0;

383 
£g_size
;

384 
max_£g_size
;

386 i‡(
√¡s
 == 0)

389 i‡(!
dev
)

390 
dev
 = &
x86_dma_ÁŒback_dev
;

392 
out
 = 0;

393 
°¨t
 = 0;

394 
°¨t_sg
 = 
sgm≠
 = 
sg
;

395 
£g_size
 = 0;

396 
max_£g_size
 = 
	`dma_gë_max_£g_size
(
dev
);

397 
ps
 = 
NULL
;

398 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

399 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

401 
s
->
dma_addªss
 = 
addr
;

402 
	`BUG_ON
(
s
->
Àngth
 == 0);

404 
√xäìd
 = 
	`√ed_iommu
(
dev
, 
addr
, 
s
->
Àngth
);

407 i‡(
i
 > 
°¨t
) {

413 i‡(!
iommu_mîge
 || !
√xäìd
 || !
√ed
 || 
s
->
off£t
 ||

414 (
s
->
Àngth
 + 
£g_size
 > 
max_£g_size
) ||

415 (
ps
->
off£t
 +Ös->
Àngth
Ë% 
PAGE_SIZE
) {

416 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
,

417 
sgm≠
, 
∑ges
, 
√ed
) < 0)

418 
îr‹
;

419 
out
++;

420 
£g_size
 = 0;

421 
sgm≠
 = 
	`sg_√xt
(sgmap);

422 
∑ges
 = 0;

423 
°¨t
 = 
i
;

424 
°¨t_sg
 = 
s
;

428 
£g_size
 +
s
->
Àngth
;

429 
√ed
 = 
√xäìd
;

430 
∑ges
 +
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

431 
ps
 = 
s
;

433 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
, 
sgm≠
, 
∑ges
, 
√ed
) < 0)

434 
îr‹
;

435 
out
++;

436 
	`Êush_g¨t
();

437 i‡(
out
 < 
√¡s
) {

438 
sgm≠
 = 
	`sg_√xt
(sgmap);

439 
sgm≠
->
dma_Àngth
 = 0;

441  
out
;

443 
îr‹
:

444 
	`Êush_g¨t
();

445 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
out
, 
dú
, 
NULL
);

448 i‡(
f‹˚_iommu
 || 
iommu_mîge
) {

449 
out
 = 
	`dma_m≠_sg_n⁄f‹˚
(
dev
, 
sg
, 
√¡s
, 
dú
);

450 i‡(
out
 > 0)

451  
out
;

453 i‡(
∑nic_⁄_ovîÊow
)

454 
	`∑nic
("dma_m≠_sg: ovîÊow o¿%luÖages\n", 
∑ges
);

456 
	`iommu_fuŒ
(
dev
, 
∑ges
 << 
PAGE_SHIFT
, 
dú
);

457 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
)

458 
s
->
dma_addªss
 = 
bad_dma_addªss
;

460 
	}
}

464 
	$g¨t_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

465 
gÂ_t
 
Êag
)

467 
dma_addr_t
 
∑ddr
;

468 
Æign_mask
;

469 
∑ge
 *page;

471 i‡(
f‹˚_iommu
 && !(
Êag
 & 
GFP_DMA
)) {

472 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

473 
∑ge
 = 
	`Æloc_∑ges
(
Êag
 | 
__GFP_ZERO
, 
	`gë_‹dî
(
size
));

474 i‡(!
∑ge
)

475  
NULL
;

477 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

478 
∑ddr
 = 
	`dma_m≠_¨ó
(
dev
, 
	`∑ge_to_phys
(
∑ge
), 
size
,

479 
DMA_BIDIRECTIONAL
, 
Æign_mask
);

481 
	`Êush_g¨t
();

482 i‡(
∑ddr
 !
bad_dma_addªss
) {

483 *
dma_addr
 = 
∑ddr
;

484  
	`∑ge_addªss
(
∑ge
);

486 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

488  
	`dma_gíîic_Æloc_cohîít
(
dev
, 
size
, 
dma_addr
, 
Êag
);

490  
NULL
;

491 
	}
}

495 
	$g¨t_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

496 
dma_addr_t
 
dma_addr
)

498 
	`g¨t_unm≠_∑ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

499 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

500 
	}
}

502 
	gno_agp
;

504 
__öô
 
	$check_iommu_size
(
≠î
, 
u64
 
≠î_size
)

506 
a
;

508 i‡(!
iommu_size
) {

509 
iommu_size
 = 
≠î_size
;

510 i‡(!
no_agp
)

511 
iommu_size
 /= 2;

514 
a
 = 
≠î
 + 
iommu_size
;

515 
iommu_size
 -
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -á;

517 i‡(
iommu_size
 < 64*1024*1024) {

518 
	`¥ötk
(
KERN_WARNING


521 
iommu_size
 >> 20);

524  
iommu_size
;

525 
	}
}

527 
__öô
 
	$ªad_≠îtuª
(
pci_dev
 *
dev
, 
u32
 *
size
)

529 
≠î_size
 = 0, 
≠î_ba£_32
, 
≠î_‹dî
;

530 
u64
 
≠î_ba£
;

532 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
≠î_ba£_32
);

533 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
≠î_‹dî
);

534 
≠î_‹dî
 = (aper_order >> 1) & 7;

536 
≠î_ba£
 = 
≠î_ba£_32
 & 0x7fff;

537 
≠î_ba£
 <<= 25;

539 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

540 i‡(
≠î_ba£
 + 
≠î_size
 > 0x100000000UL || !aper_size)

541 
≠î_ba£
 = 0;

543 *
size
 = 
≠î_size
;

544  
≠î_ba£
;

545 
	}
}

547 
	$íabÀ_g¨t_å™¶©i⁄s
()

549 
i
;

551 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

552 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

554 
	`íabÀ_g¨t_å™¶©i⁄
(
dev
, 
	`__∑
(
agp_g©t_èbÀ
));

556 
	}
}

562 
boﬁ
 
	gfix_up_n‹th_bridges
;

563 
u32
 
	g≠îtuª_‹dî
;

564 
u32
 
	g≠îtuª_Æloc
;

566 
	$£t_up_g¨t_ªsume
(
u32
 
≠î_‹dî
, u32 
≠î_Æloc
)

568 
fix_up_n‹th_bridges
 = 
åue
;

569 
≠îtuª_‹dî
 = 
≠î_‹dî
;

570 
≠îtuª_Æloc
 = 
≠î_Æloc
;

571 
	}
}

573 
	$g¨t_ªsume
(
sys_devi˚
 *
dev
)

575 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Resuming GART IOMMU\n");

577 i‡(
fix_up_n‹th_bridges
) {

578 
i
;

580 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Restoring GARTáperture settings\n");

582 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

583 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

589 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
,

590 
≠îtuª_‹dî
 << 1);

591 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
,

592 
≠îtuª_Æloc
 >> 25);

596 
	`íabÀ_g¨t_å™¶©i⁄s
();

599 
	}
}

601 
	$g¨t_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

604 
	}
}

606 
sysdev_˛ass
 
	gg¨t_sysdev_˛ass
 = {

607 .
«me
 = "gart",

608 .
	gsu•íd
 = 
g¨t_su•íd
,

609 .
	gªsume
 = 
g¨t_ªsume
,

613 
sys_devi˚
 
	gdevi˚_g¨t
 = {

614 .
id
 = 0,

615 .
	g˛s
 = &
g¨t_sysdev_˛ass
,

622 
__öô
 
	$öô_k8_g©t
(
agp_kîn_öfo
 *
öfo
)

624 
≠î_size
, 
g©t_size
, 
√w_≠î_size
;

625 
≠î_ba£
, 
√w_≠î_ba£
;

626 
pci_dev
 *
dev
;

627 *
g©t
;

628 
i
, 
îr‹
;

630 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Disabling AGP.\n");

631 
≠î_size
 = 
≠î_ba£
 = 
öfo
->aper_size = 0;

632 
dev
 = 
NULL
;

633 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

634 
dev
 = 
k8_n‹thbridges
[
i
];

635 
√w_≠î_ba£
 = 
	`ªad_≠îtuª
(
dev
, &
√w_≠î_size
);

636 i‡(!
√w_≠î_ba£
)

637 
nommu
;

639 i‡(!
≠î_ba£
) {

640 
≠î_size
 = 
√w_≠î_size
;

641 
≠î_ba£
 = 
√w_≠î_ba£
;

643 i‡(
≠î_size
 !
√w_≠î_size
 || 
≠î_ba£
 !
√w_≠î_ba£
)

644 
nommu
;

646 i‡(!
≠î_ba£
)

647 
nommu
;

648 
öfo
->
≠î_ba£
 =áper_base;

649 
öfo
->
≠î_size
 =áper_size >> 20;

651 
g©t_size
 = (
≠î_size
 >> 
PAGE_SHIFT
Ë* (
u32
);

652 
g©t
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

653 
	`gë_‹dî
(
g©t_size
));

654 i‡(!
g©t
)

655 
	`∑nic
("Cannotállocate GATTÅable");

656 i‡(
	`£t_mem‹y_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

657 
	`∑nic
("CouldÇot set GART PTEsÅo uncacheableÖages");

659 
agp_g©t_èbÀ
 = 
g©t
;

661 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
g¨t_sysdev_˛ass
);

662 i‡(!
îr‹
)

663 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_g¨t
);

664 i‡(
îr‹
)

665 
	`∑nic
("CouldÇotÑegister gart_sysdev -- "

668 
	`Êush_g¨t
();

670 
	`¥ötk
(
KERN_INFO
 "PCI-DMA:áperture base @ %x size %u KB\n",

671 
≠î_ba£
, 
≠î_size
>>10);

675 
nommu
:

677 
	`¥ötk
(
KERN_WARNING
 "PCI-DMA: MoreÅhan 4GB of RAMándÇo IOMMU\n"

680 
	}
}

682 
dma_m≠_›s
 
	gg¨t_dma_›s
 = {

683 .
m≠_sg
 = 
g¨t_m≠_sg
,

684 .
	gunm≠_sg
 = 
g¨t_unm≠_sg
,

685 .
	gm≠_∑ge
 = 
g¨t_m≠_∑ge
,

686 .
	gunm≠_∑ge
 = 
g¨t_unm≠_∑ge
,

687 .
	gÆloc_cohîít
 = 
g¨t_Æloc_cohîít
,

688 .
	g‰ì_cohîít
 = 
g¨t_‰ì_cohîít
,

691 
	$g¨t_iommu_shutdown
()

693 
pci_dev
 *
dev
;

694 
i
;

696 i‡(
no_agp
 && (
dma_›s
 !&
g¨t_dma_›s
))

699 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

700 
u32
 
˘l
;

702 
dev
 = 
k8_n‹thbridges
[
i
];

703 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
˘l
);

705 
˘l
 &~
GARTEN
;

707 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
˘l
);

709 
	}
}

711 
__öô
 
	$g¨t_iommu_öô
()

713 
agp_kîn_öfo
 
öfo
;

714 
iommu_°¨t
;

715 
≠î_ba£
, 
≠î_size
;

716 
°¨t_p‚
, 
íd_p‚
;

717 
s¸©ch
;

718 
i
;

720 i‡(
	`ˇche_k8_n‹thbridges
(Ë< 0 || 
num_k8_n‹thbridges
 == 0)

723 #i‚de‡
CONFIG_AGP_AMD64


724 
no_agp
 = 1;

728 
no_agp
 =Ço_agp ||

729 (
	`agp_amd64_öô
() < 0) ||

730 (
	`agp_c›y_öfo
(
agp_bridge
, &
öfo
) < 0);

733 i‡(
swiŸlb
)

737 i‡(
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
)

740 i‡(
no_iommu
 ||

741 (!
f‹˚_iommu
 && 
max_p‚
 <
MAX_DMA32_PFN
) ||

742 !
g¨t_iommu_≠îtuª
 ||

743 (
no_agp
 && 
	`öô_k8_g©t
(&
öfo
) < 0)) {

744 i‡(
max_p‚
 > 
MAX_DMA32_PFN
) {

745 
	`¥ötk
(
KERN_WARNING
 "MoreÅhan 4GB of memory "

747 
	`¥ötk
(
KERN_WARNING
 "falling backÅo iommu=soft.\n");

753 
≠î_size
 = 
öfo
.aper_size << 20;

754 
≠î_ba£
 = 
öfo
.aper_base;

755 
íd_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
Ë+ (
≠î_size
>>PAGE_SHIFT);

756 i‡(
íd_p‚
 > 
max_low_p‚_m≠≥d
) {

757 
°¨t_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
);

758 
	`öô_mem‹y_m≠pög
(
°¨t_p‚
<<
PAGE_SHIFT
, 
íd_p‚
<<PAGE_SHIFT);

761 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: using GART IOMMU.\n");

762 
iommu_size
 = 
	`check_iommu_size
(
öfo
.
≠î_ba£
, 
≠î_size
);

763 
iommu_∑ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

765 
iommu_g¨t_bôm≠
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

766 
	`gë_‹dî
(
iommu_∑ges
/8));

767 i‡(!
iommu_g¨t_bôm≠
)

768 
	`∑nic
("Cannotállocate iommu bitmap\n");

770 #ifde‡
CONFIG_IOMMU_LEAK


771 i‡(
Àak_åa˚
) {

772 
ªt
;

774 
ªt
 = 
	`dma_debug_ªsize_íåõs
(
iommu_∑ges
);

775 i‡(
ªt
)

776 
	`¥ötk
(
KERN_DEBUG


785 
	`iommu_¨ó_ª£rve
(
iommu_g¨t_bôm≠
, 0, 
EMERGENCY_PAGES
);

787 
agp_mem‹y_ª£rved
 = 
iommu_size
;

788 
	`¥ötk
(
KERN_INFO


790 
iommu_size
 >> 20);

792 
iommu_°¨t
 = 
≠î_size
 - 
iommu_size
;

793 
iommu_bus_ba£
 = 
öfo
.
≠î_ba£
 + 
iommu_°¨t
;

794 
bad_dma_addªss
 = 
iommu_bus_ba£
;

795 
iommu_g©t_ba£
 = 
agp_g©t_èbÀ
 + (
iommu_°¨t
>>
PAGE_SHIFT
);

806 
	`£t_mem‹y_≈
(()
	`__va
(
iommu_bus_ba£
),

807 
iommu_size
 >> 
PAGE_SHIFT
);

816 
	`wbövd
();

824 
	`íabÀ_g¨t_å™¶©i⁄s
();

832 
s¸©ch
 = 
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

833 i‡(!
s¸©ch
)

834 
	`∑nic
("Cannotállocate iommu scratchÖage");

835 
g¨t_unm≠≥d_íåy
 = 
	`GPTE_ENCODE
(
	`__∑
(
s¸©ch
));

836 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_∑ges
; i++)

837 
iommu_g©t_ba£
[
i
] = 
g¨t_unm≠≥d_íåy
;

839 
	`Êush_g¨t
();

840 
dma_›s
 = &
g¨t_dma_›s
;

841 
	}
}

843 
__öô
 
	$g¨t_∑r£_›ti⁄s
(*
p
)

845 
¨g
;

847 #ifde‡
CONFIG_IOMMU_LEAK


848 i‡(!
	`°∫cmp
(
p
, "leak", 4)) {

849 
Àak_åa˚
 = 1;

850 
p
 += 4;

851 i‡(*
p
 == '=')

852 ++
p
;

853 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

854 
iommu_Àak_∑ges
 = 
¨g
;

857 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

858 
iommu_size
 = 
¨g
;

859 i‡(!
	`°∫cmp
(
p
, "fullflush", 8))

860 
iommu_fuŒÊush
 = 1;

861 i‡(!
	`°∫cmp
(
p
, "nofullflush", 11))

862 
iommu_fuŒÊush
 = 0;

863 i‡(!
	`°∫cmp
(
p
, "noagp", 5))

864 
no_agp
 = 1;

865 i‡(!
	`°∫cmp
(
p
, "noaperture", 10))

866 
fix_≠îtuª
 = 0;

868 i‡(!
	`°∫cmp
(
p
, "force", 5))

869 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

870 i‡(!
	`°∫cmp
(
p
, "allowed", 7))

871 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

872 i‡(!
	`°∫cmp
(
p
, "memaper", 7)) {

873 
ÁŒback_≠î_f‹˚
 = 1;

874 
p
 += 7;

875 i‡(*
p
 == '=') {

876 ++
p
;

877 i‡(
	`gë_›ti⁄
(&
p
, &
¨g
))

878 
ÁŒback_≠î_‹dî
 = 
¨g
;

881 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<löux/dma-m≠pög.h
>

4 
	~<löux/sˇâîli°.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/pci.h
>

8 
	~<löux/mm.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/dma.h
>

15 
	$check_addr
(*
«me
, 
devi˚
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

17 i‡(
hwdev
 && !
	`dma_ˇ∑bÀ
(hwdev, 
bus
, 
size
)) {

18 i‡(*
hwdev
->
dma_mask
 >
	`DMA_BIT_MASK
(32))

19 
	`¥ötk
(
KERN_ERR


21 
«me
, ()
bus
, 
size
,

22 ()*
hwdev
->
dma_mask
);

26 
	}
}

28 
dma_addr_t
 
	$nommu_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

29 
off£t
, 
size_t
 
size
,

30 
dma_d©a_dúe˘i⁄
 
dú
,

31 
dma_©ås
 *
©ås
)

33 
dma_addr_t
 
bus
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

34 
	`WARN_ON
(
size
 == 0);

35 i‡(!
	`check_addr
("m≠_sögÀ", 
dev
, 
bus
, 
size
))

36  
bad_dma_addªss
;

37 
	`Êush_wrôe_buf„rs
();

38  
bus
;

39 
	}
}

56 
	$nommu_m≠_sg
(
devi˚
 *
hwdev
, 
sˇâîli°
 *
sg
,

57 
√¡s
, 
dma_d©a_dúe˘i⁄
 
dú
,

58 
dma_©ås
 *
©ås
)

60 
sˇâîli°
 *
s
;

61 
i
;

63 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

65 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

66 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

67 
s
->
dma_addªss
 = 
	`sg_phys
(s);

68 i‡(!
	`check_addr
("m≠_sg", 
hwdev
, 
s
->
dma_addªss
, s->
Àngth
))

70 
s
->
dma_Àngth
 = s->
Àngth
;

72 
	`Êush_wrôe_buf„rs
();

73  
√¡s
;

74 
	}
}

76 
	$nommu_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

77 
dma_addr_t
 
dma_addr
)

79 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

80 
	}
}

82 
	$nommu_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
,

83 
dma_addr_t
 
addr
, 
size_t
 
size
,

84 
dma_d©a_dúe˘i⁄
 
dú
)

86 
	`Êush_wrôe_buf„rs
();

87 
	}
}

90 
	$nommu_sync_sg_f‹_devi˚
(
devi˚
 *
dev
,

91 
sˇâîli°
 *
sg
, 
√Àms
,

92 
dma_d©a_dúe˘i⁄
 
dú
)

94 
	`Êush_wrôe_buf„rs
();

95 
	}
}

97 
dma_m≠_›s
 
	gnommu_dma_›s
 = {

98 .
Æloc_cohîít
 = 
dma_gíîic_Æloc_cohîít
,

99 .
	g‰ì_cohîít
 = 
nommu_‰ì_cohîít
,

100 .
	gm≠_sg
 = 
nommu_m≠_sg
,

101 .
	gm≠_∑ge
 = 
nommu_m≠_∑ge
,

102 .
	gsync_sögÀ_f‹_devi˚
 = 
nommu_sync_sögÀ_f‹_devi˚
,

103 .
	gsync_sg_f‹_devi˚
 = 
nommu_sync_sg_f‹_devi˚
,

104 .
	gis_phys
 = 1,

107 
__öô
 
	$no_iommu_öô
()

109 i‡(
dma_›s
)

112 
f‹˚_iommu
 = 0;

113 
dma_›s
 = &
nommu_dma_›s
;

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<löux/pci.h
>

4 
	~<löux/ˇche.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/swiŸlb.h
>

7 
	~<löux/boŸmem.h
>

8 
	~<löux/dma-m≠pög.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiŸlb.h
>

12 
	~<asm/dma.h
>

14 
swiŸlb
 
	g__ªad_mo°ly
;

16 *
	$x86_swiŸlb_Æloc_cohîít
(
devi˚
 *
hwdev
, 
size_t
 
size
,

17 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êags
)

19 *
vaddr
;

21 
vaddr
 = 
	`dma_gíîic_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

22 i‡(
vaddr
)

23  
vaddr
;

25  
	`swiŸlb_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

26 
	}
}

28 
dma_m≠_›s
 
	gswiŸlb_dma_›s
 = {

29 .
m≠pög_îr‹
 = 
swiŸlb_dma_m≠pög_îr‹
,

30 .
	gÆloc_cohîít
 = 
x86_swiŸlb_Æloc_cohîít
,

31 .
	g‰ì_cohîít
 = 
swiŸlb_‰ì_cohîít
,

32 .
	gsync_sögÀ_f‹_˝u
 = 
swiŸlb_sync_sögÀ_f‹_˝u
,

33 .
	gsync_sögÀ_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_f‹_devi˚
,

34 .
	gsync_sögÀ_ønge_f‹_˝u
 = 
swiŸlb_sync_sögÀ_ønge_f‹_˝u
,

35 .
	gsync_sögÀ_ønge_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_ønge_f‹_devi˚
,

36 .
	gsync_sg_f‹_˝u
 = 
swiŸlb_sync_sg_f‹_˝u
,

37 .
	gsync_sg_f‹_devi˚
 = 
swiŸlb_sync_sg_f‹_devi˚
,

38 .
	gm≠_sg
 = 
swiŸlb_m≠_sg_©ås
,

39 .
	gunm≠_sg
 = 
swiŸlb_unm≠_sg_©ås
,

40 .
	gm≠_∑ge
 = 
swiŸlb_m≠_∑ge
,

41 .
	gunm≠_∑ge
 = 
swiŸlb_unm≠_∑ge
,

42 .
	gdma_suµ‹ãd
 = 
NULL
,

45 
__öô
 
	$pci_swiŸlb_öô
()

48 #ifde‡
CONFIG_X86_64


49 i‡((!
iommu_dëe˘ed
 && !
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
))

50 
swiŸlb
 = 1;

52 i‡(
swiŸlb_f‹˚
)

53 
swiŸlb
 = 1;

54 i‡(
swiŸlb
) {

55 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using software bounce buffering for IO (SWIOTLB)\n");

56 
	`swiŸlb_öô
();

57 
dma_›s
 = &
swiŸlb_dma_›s
;

59 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<löux/∂©f‹m_devi˚.h
>

2 
	~<löux/îr.h
>

3 
	~<löux/öô.h
>

5 
__öô
 
	$add_pc•kr
()

7 
∂©f‹m_devi˚
 *
pd
;

9 
pd
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("pc•kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
Ë? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
devi˚_öôˇŒ
(
add_pc•kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<löux/jiffõs.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/time.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/˝umask.h
>

22 
	~<löux/a˝i_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/m§.h
>

27 
	~<asm/vsysˇŒ.h
>

29 
ölöe
 
u32
 
	$cyc2us
(
u32
 
cy˛es
)

38 
cy˛es
 *= 286;

39  (
cy˛es
 >> 10);

40 
	}
}

42 
	$pmtimî_waô_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
;

46 
a
 =
b
;

47 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
)

48 
	`˝u_ªœx
();

49  
b
;

50 
	}
}

53 
	$pmtimî_waô
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtimî_waô_tick
();

58 
b
 = 
	`öl
(
pmtmr_i›‹t
);

59 
	`˝u_ªœx
();

60 } 
	`cyc2us
(
b
 - 
a
Ë< 
us
);

61 
	}
}

63 
__öô
 
	$n›mtimî_£tup
(*
s
)

65 
pmtmr_i›‹t
 = 0;

67 
	}
}

69 
__£tup
("n›mtimî", 
n›mtimî_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/smp.h
>

5 
	~<löux/¥˘l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/pm.h
>

10 
	~<löux/˛ockchùs.h
>

11 
	~<löux/øndom.h
>

12 
	~<åa˚/evíts/powî.h
>

13 
	~<asm/sy°em.h
>

14 
	~<asm/≠ic.h
>

15 
	~<asm/sysˇŒs.h
>

16 
	~<asm/idÀ.h
>

17 
	~<asm/uac˚ss.h
>

18 
	~<asm/i387.h
>

19 
	~<asm/ds.h
>

21 
	gidÀ_hÆt
;

22 
EXPORT_SYMBOL
(
idÀ_hÆt
);

23 
	gidÀ_nomwaô
;

24 
EXPORT_SYMBOL
(
idÀ_nomwaô
);

26 
kmem_ˇche
 *
	gèsk_x°©e_ˇchï
;

28 
	$¨ch_dup_èsk_°ru˘
(
èsk_°ru˘
 *
d°
, èsk_°ru˘ *
§c
)

30 *
d°
 = *
§c
;

31 i‡(
§c
->
thªad
.
x°©e
) {

32 
d°
->
thªad
.
x°©e
 = 
	`kmem_ˇche_Æloc
(
èsk_x°©e_ˇchï
,

33 
GFP_KERNEL
);

34 i‡(!
d°
->
thªad
.
x°©e
)

35  -
ENOMEM
;

36 
	`WARN_ON
(()
d°
->
thªad
.
x°©e
 & 15);

37 
	`mem˝y
(
d°
->
thªad
.
x°©e
, 
§c
->thªad.x°©e, 
x°©e_size
);

40 
	}
}

42 
	$‰ì_thªad_x°©e
(
èsk_°ru˘
 *
tsk
)

44 i‡(
tsk
->
thªad
.
x°©e
) {

45 
	`kmem_ˇche_‰ì
(
èsk_x°©e_ˇchï
, 
tsk
->
thªad
.
x°©e
);

46 
tsk
->
thªad
.
x°©e
 = 
NULL
;

49 
	`WARN
(
tsk
->
thªad
.
ds_˘x
, "leaking DS context\n");

50 
	}
}

52 
	$‰ì_thªad_öfo
(
thªad_öfo
 *
ti
)

54 
	`‰ì_thªad_x°©e
(
ti
->
èsk
);

55 
	`‰ì_∑ges
(()
ti
, 
	`gë_‹dî
(
THREAD_SIZE
));

56 
	}
}

58 
	$¨ch_èsk_ˇche_öô
()

60 
èsk_x°©e_ˇchï
 =

61 
	`kmem_ˇche_¸óã
("èsk_x°©e", 
x°©e_size
,

62 
	`__Æignof__
(
thªad_x°©e
),

63 
SLAB_PANIC
 | 
SLAB_NOTRACK
, 
NULL
);

64 
	}
}

69 
	$exô_thªad
()

71 
èsk_°ru˘
 *
me
 = 
cuºít
;

72 
thªad_°ru˘
 *
t
 = &
me
->
thªad
;

73 *
bp
 = 
t
->
io_bôm≠_±r
;

75 i‡(
bp
) {

76 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

78 
t
->
io_bôm≠_±r
 = 
NULL
;

79 
	`˛ór_thªad_Êag
(
TIF_IO_BITMAP
);

83 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
t
->
io_bôm≠_max
);

84 
t
->
io_bôm≠_max
 = 0;

85 
	`put_˝u
();

86 
	`k‰ì
(
bp
);

88 
	}
}

90 
	$Êush_thªad
()

92 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

94 #ifde‡
CONFIG_X86_64


95 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_ABI_PENDING
)) {

96 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_ABI_PENDING
);

97 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
)) {

98 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
);

100 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
);

101 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_COMPAT
;

106 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUG
);

108 
tsk
->
thªad
.
debugªg0
 = 0;

109 
tsk
->
thªad
.
debugªg1
 = 0;

110 
tsk
->
thªad
.
debugªg2
 = 0;

111 
tsk
->
thªad
.
debugªg3
 = 0;

112 
tsk
->
thªad
.
debugªg6
 = 0;

113 
tsk
->
thªad
.
debugªg7
 = 0;

114 
	`mem£t
(
tsk
->
thªad
.
és_¨øy
, 0, (tsk->thread.tls_array));

118 
tsk
->
Âu_cou¡î
 = 0;

119 
	`˛ór_Âu
(
tsk
);

120 
	`˛ór_u£d_m©h
();

121 
	}
}

123 
	$h¨d_dißbÀ_TSC
()

125 
	`wrôe_¸4
(
	`ªad_¸4
(Ë| 
X86_CR4_TSD
);

126 
	}
}

128 
	$dißbÀ_TSC
()

130 
	`¥ìm±_dißbÀ
();

131 i‡(!
	`ã°_™d_£t_thªad_Êag
(
TIF_NOTSC
))

136 
	`h¨d_dißbÀ_TSC
();

137 
	`¥ìm±_íabÀ
();

138 
	}
}

140 
	$h¨d_íabÀ_TSC
()

142 
	`wrôe_¸4
(
	`ªad_¸4
(Ë& ~
X86_CR4_TSD
);

143 
	}
}

145 
	$íabÀ_TSC
()

147 
	`¥ìm±_dißbÀ
();

148 i‡(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_NOTSC
))

153 
	`h¨d_íabÀ_TSC
();

154 
	`¥ìm±_íabÀ
();

155 
	}
}

157 
	$gë_tsc_mode
(
adr
)

159 
vÆ
;

161 i‡(
	`ã°_thªad_Êag
(
TIF_NOTSC
))

162 
vÆ
 = 
PR_TSC_SIGSEGV
;

164 
vÆ
 = 
PR_TSC_ENABLE
;

166  
	`put_u£r
(
vÆ
, (
__u£r
 *)
adr
);

167 
	}
}

169 
	$£t_tsc_mode
(
vÆ
)

171 i‡(
vÆ
 =
PR_TSC_SIGSEGV
)

172 
	`dißbÀ_TSC
();

173 i‡(
vÆ
 =
PR_TSC_ENABLE
)

174 
	`íabÀ_TSC
();

176  -
EINVAL
;

179 
	}
}

181 
	$__swôch_to_xåa
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
,

182 
tss_°ru˘
 *
tss
)

184 
thªad_°ru˘
 *
¥ev
, *
√xt
;

186 
¥ev
 = &
¥ev_p
->
thªad
;

187 
√xt
 = &
√xt_p
->
thªad
;

189 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DS_AREA_MSR
) ||

190 
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_DS_AREA_MSR
))

191 
	`ds_swôch_to
(
¥ev_p
, 
√xt_p
);

192 i‡(
√xt
->
debug˘lm§
 !
¥ev
->debugctlmsr)

193 
	`upd©e_debug˘lm§
(
√xt
->
debug˘lm§
);

195 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_DEBUG
)) {

196 
	`£t_debugªg
(
√xt
->
debugªg0
, 0);

197 
	`£t_debugªg
(
√xt
->
debugªg1
, 1);

198 
	`£t_debugªg
(
√xt
->
debugªg2
, 2);

199 
	`£t_debugªg
(
√xt
->
debugªg3
, 3);

201 
	`£t_debugªg
(
√xt
->
debugªg6
, 6);

202 
	`£t_debugªg
(
√xt
->
debugªg7
, 7);

205 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_NOTSC
) ^

206 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
)) {

208 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
))

209 
	`h¨d_dißbÀ_TSC
();

211 
	`h¨d_íabÀ_TSC
();

214 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_IO_BITMAP
)) {

219 
	`mem˝y
(
tss
->
io_bôm≠
, 
√xt
->
io_bôm≠_±r
,

220 
	`max
(
¥ev
->
io_bôm≠_max
, 
√xt
->io_bitmap_max));

221 } i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_IO_BITMAP
)) {

225 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
¥ev
->
io_bôm≠_max
);

227 
	}
}

229 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

231  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0, 
NULL
, NULL);

232 
	}
}

244 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

246  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0,

247 
NULL
, NULL);

248 
	}
}

254 
	gboŸ_›ti⁄_idÀ_ovîride
 = 0;

255 
EXPORT_SYMBOL
(
boŸ_›ti⁄_idÀ_ovîride
);

260 (*
pm_idÀ
)();

261 
	`EXPORT_SYMBOL
(
pm_idÀ
);

263 #ifde‡
CONFIG_X86_32


268 
h…_cou¡î
;

269 
	$dißbÀ_h…
()

271 
h…_cou¡î
++;

272 
	}
}

273 
EXPORT_SYMBOL
(
dißbÀ_h…
);

275 
	$íabÀ_h…
()

277 
h…_cou¡î
--;

278 
	}
}

279 
EXPORT_SYMBOL
(
íabÀ_h…
);

281 
ölöe
 
	$h…_u£_hÆt
()

283  (!
h…_cou¡î
 && 
boŸ_˝u_d©a
.
h…_w‹ks_ok
);

284 
	}
}

286 
ölöe
 
	$h…_u£_hÆt
()

289 
	}
}

296 
	$deÁu…_idÀ
()

298 i‡(
	`h…_u£_hÆt
()) {

299 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

300 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_POLLING
;

305 
	`smp_mb
();

307 i‡(!
	`√ed_ªsched
())

308 
	`ß„_hÆt
();

310 
	`loˇl_úq_íabÀ
();

311 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

313 
	`loˇl_úq_íabÀ
();

315 
	`˝u_ªœx
();

317 
	}
}

318 #ifde‡
CONFIG_APM_MODULE


319 
EXPORT_SYMBOL
(
deÁu…_idÀ
);

322 
	$°›_this_˝u
(*
dummy
)

324 
	`loˇl_úq_dißbÀ
();

328 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
Ál£
);

329 
	`dißbÀ_loˇl_APIC
();

332 i‡(
	`h…_w‹ks
(
	`smp_¥o˚ss‹_id
()))

333 
	`hÆt
();

335 
	}
}

337 
	$do_nŸhög
(*
unu£d
)

339 
	}
}

349 
	$˝u_idÀ_waô
()

351 
	`smp_mb
();

353 
	`smp_ˇŒ_fun˘i⁄
(
do_nŸhög
, 
NULL
, 1);

354 
	}
}

355 
EXPORT_SYMBOL_GPL
(
˝u_idÀ_waô
);

367 
	$mwaô_idÀ_wôh_höts
(
ax
, 
cx
)

369 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, (
ax
>>4)+1);

370 i‡(!
	`√ed_ªsched
()) {

371 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

372 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

374 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

375 
	`smp_mb
();

376 i‡(!
	`√ed_ªsched
())

377 
	`__mwaô
(
ax
, 
cx
);

379 
	}
}

382 
	$mwaô_idÀ
()

384 i‡(!
	`√ed_ªsched
()) {

385 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

386 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

387 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

389 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

390 
	`smp_mb
();

391 i‡(!
	`√ed_ªsched
())

392 
	`__°i_mwaô
(0, 0);

394 
	`loˇl_úq_íabÀ
();

396 
	`loˇl_úq_íabÀ
();

397 
	}
}

404 
	$pﬁl_idÀ
()

406 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 0);

407 
	`loˇl_úq_íabÀ
();

408 !
	`√ed_ªsched
())

409 
	`˝u_ªœx
();

410 
	`åa˚_powî_íd
(0);

411 
	}
}

425 
__˝uöôd©a
 
	gf‹˚_mwaô
;

427 
	#MWAIT_INFO
 0x05

	)

428 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

429 
	#MWAIT_EDX_C1
 0xf0

	)

431 
__˝uöô
 
	$mwaô_ußbÀ
(c⁄° 
˝uöfo_x86
 *
c
)

433 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

435 i‡(
f‹˚_mwaô
)

438 i‡(
c
->
˝uid_Àvñ
 < 
MWAIT_INFO
)

441 
	`˝uid
(
MWAIT_INFO
, &
óx
, &
ebx
, &
ecx
, &
edx
);

443 i‡(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

450  (
edx
 & 
MWAIT_EDX_C1
);

451 
	}
}

456 
__˝uöô
 
	$check_c1e_idÀ
(c⁄° 
˝uöfo_x86
 *
c
)

458 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
)

461 i‡(
c
->
x86
 < 0x0F)

465 i‡(
c
->
x86
 =0x0‡&& c->
x86_modñ
 < 0x40)

469 
	}
}

471 
˝umask_v¨_t
 
	gc1e_mask
;

472 
	gc1e_dëe˘ed
;

474 
	$c1e_ªmove_˝u
(
˝u
)

476 i‡(
c1e_mask
 !
NULL
)

477 
	`˝umask_˛ór_˝u
(
˝u
, 
c1e_mask
);

478 
	}
}

485 
	$c1e_idÀ
()

487 i‡(
	`√ed_ªsched
())

490 i‡(!
c1e_dëe˘ed
) {

491 
u32
 
lo
, 
hi
;

493 
	`rdm§
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

494 i‡(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

495 
c1e_dëe˘ed
 = 1;

496 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_NONSTOP_TSC
))

497 
	`m¨k_tsc_un°abÀ
("TSC halt in AMD C1E");

498 
	`¥ötk
(
KERN_INFO
 "System has AMD C1EÉnabled\n");

499 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_AMDC1E
);

503 i‡(
c1e_dëe˘ed
) {

504 
˝u
 = 
	`smp_¥o˚ss‹_id
();

506 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
c1e_mask
)) {

507 
	`˝umask_£t_˝u
(
˝u
, 
c1e_mask
);

511 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

512 &
˝u
);

513 
	`¥ötk
(
KERN_INFO
 "SwitchÅo broadcast mode on CPU%d\n",

514 
˝u
);

516 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
˝u
);

518 
	`deÁu…_idÀ
();

524 
	`loˇl_úq_dißbÀ
();

525 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
˝u
);

526 
	`loˇl_úq_íabÀ
();

528 
	`deÁu…_idÀ
();

529 
	}
}

531 
__˝uöô
 
	$£À˘_idÀ_routöe
(c⁄° 
˝uöfo_x86
 *
c
)

533 #ifde‡
CONFIG_SMP


534 i‡(
pm_idÀ
 =
pﬁl_idÀ
 && 
smp_num_siblögs
 > 1) {

535 
	`¥ötk
(
KERN_WARNING
 "WARNING:Öolling idleánd HTÉnabled,"

539 i‡(
pm_idÀ
)

542 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
Ë&& 
	`mwaô_ußbÀ
(c)) {

546 
	`¥ötk
(
KERN_INFO
 "using mwait in idleÅhreads.\n");

547 
pm_idÀ
 = 
mwaô_idÀ
;

548 } i‡(
	`check_c1e_idÀ
(
c
)) {

549 
	`¥ötk
(
KERN_INFO
 "using C1Eáware idleÑoutine\n");

550 
pm_idÀ
 = 
c1e_idÀ
;

552 
pm_idÀ
 = 
deÁu…_idÀ
;

553 
	}
}

555 
__öô
 
	$öô_c1e_mask
()

558 i‡(
pm_idÀ
 =
c1e_idÀ
)

559 
	`zÆloc_˝umask_v¨
(&
c1e_mask
, 
GFP_KERNEL
);

560 
	}
}

562 
__öô
 
	$idÀ_£tup
(*
°r
)

564 i‡(!
°r
)

565  -
EINVAL
;

567 i‡(!
	`°rcmp
(
°r
, "poll")) {

568 
	`¥ötk
("usingÖolling idleÅhreads.\n");

569 
pm_idÀ
 = 
pﬁl_idÀ
;

570 } i‡(!
	`°rcmp
(
°r
, "mwait"))

571 
f‹˚_mwaô
 = 1;

572 i‡(!
	`°rcmp
(
°r
, "halt")) {

580 
pm_idÀ
 = 
deÁu…_idÀ
;

581 
idÀ_hÆt
 = 1;

583 } i‡(!
	`°rcmp
(
°r
, "nomwait")) {

590 
idÀ_nomwaô
 = 1;

595 
boŸ_›ti⁄_idÀ_ovîride
 = 1;

597 
	}
}

598 
óæy_∑øm
("idÀ", 
idÀ_£tup
);

600 
	$¨ch_Æign_°ack
(
•
)

602 i‡(!(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
Ë&& 
øndomize_va_•a˚
)

603 
•
 -
	`gë_øndom_öt
() % 8192;

604  
•
 & ~0xf;

605 
	}
}

607 
	$¨ch_øndomize_brk
(
mm_°ru˘
 *
mm
)

609 
ønge_íd
 = 
mm
->
brk
 + 0x02000000;

610  
	`øndomize_ønge
(
mm
->
brk
, 
ønge_íd
, 0) ? : mm->brk;

611 
	}
}

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/˝u.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/ñfc‹e.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/u£r.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/ut¢ame.h
>

30 
	~<löux/dñay.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/±ø˚.h
>

33 
	~<löux/nŸifõr.h
>

34 
	~<löux/k¥obes.h
>

35 
	~<löux/kdebug.h
>

36 
	~<löux/tick.h
>

37 
	~<löux/¥˘l.h
>

38 
	~<löux/uac˚ss.h
>

39 
	~<löux/io.h
>

40 
	~<löux/·ø˚.h
>

41 
	~<löux/dmi.h
>

43 
	~<asm/pgèbÀ.h
>

44 
	~<asm/sy°em.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/i387.h
>

47 
	~<asm/mmu_c⁄ãxt.h
>

48 
	~<asm/¥˘l.h
>

49 
	~<asm/desc.h
>

50 
	~<asm/¥Ÿo.h
>

51 
	~<asm/ü32.h
>

52 
	~<asm/idÀ.h
>

53 
	~<asm/sysˇŒs.h
>

54 
	~<asm/ds.h
>

56 
asmlökage
 
ªt_‰om_f‹k
();

58 
DEFINE_PER_CPU
(, 
ﬁd_r•
);

59 
DEFINE_PER_CPU
(, 
is_idÀ
);

61 
	gkî√l_thªad_Êags
 = 
CLONE_VM
 | 
CLONE_UNTRACED
;

63 
ATOMIC_NOTIFIER_HEAD
(
idÀ_nŸifõr
);

65 
	$idÀ_nŸifõr_ªgi°î
(
nŸifõr_block
 *
n
)

67 
	`©omic_nŸifõr_chaö_ªgi°î
(&
idÀ_nŸifõr
, 
n
);

68 
	}
}

69 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_ªgi°î
);

71 
	$idÀ_nŸifõr_uƒegi°î
(
nŸifõr_block
 *
n
)

73 
	`©omic_nŸifõr_chaö_uƒegi°î
(&
idÀ_nŸifõr
, 
n
);

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_uƒegi°î
);

77 
	$íãr_idÀ
()

79 
	`≥r˝u_wrôe
(
is_idÀ
, 1);

80 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_START
, 
NULL
);

81 
	}
}

83 
	$__exô_idÀ
()

85 i‡(
	`x86_ã°_™d_˛ór_bô_≥r˝u
(0, 
is_idÀ
) == 0)

87 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_END
, 
NULL
);

88 
	}
}

91 
	$exô_idÀ
()

94 i‡(
cuºít
->
pid
)

96 
	`__exô_idÀ
();

97 
	}
}

99 #i‚de‡
CONFIG_SMP


100 
ölöe
 
	$∂ay_dód
()

102 
	`BUG
();

103 
	}
}

112 
	$˝u_idÀ
()

114 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

123 
	`boŸ_öô_°ack_ˇ«ry
();

127 
	`tick_nohz_°›_sched_tick
(1);

128 !
	`√ed_ªsched
()) {

130 
	`rmb
();

132 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
()))

133 
	`∂ay_dód
();

139 
	`loˇl_úq_dißbÀ
();

140 
	`íãr_idÀ
();

142 
	`°›_¸ôiˇl_timögs
();

143 
	`pm_idÀ
();

144 
	`°¨t_¸ôiˇl_timögs
();

148 
	`__exô_idÀ
();

151 
	`tick_nohz_ª°¨t_sched_tick
();

152 
	`¥ìm±_íabÀ_no_ªsched
();

153 
	`scheduÀ
();

154 
	`¥ìm±_dißbÀ
();

156 
	}
}

159 
	$__show_ªgs
(
±_ªgs
 *
ªgs
, 
Æl
)

161 
¸0
 = 0L, 
¸2
 = 0L, 
¸3
 = 0L, 
¸4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

162 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

163 
fsödex
, 
gsödex
;

164 
ds
, 
cs
, 
es
;

165 c⁄° *
bﬂrd
;

167 
	`¥ötk
("\n");

168 
	`¥öt_moduÀs
();

169 
bﬂrd
 = 
	`dmi_gë_sy°em_öfo
(
DMI_PRODUCT_NAME
);

170 i‡(!
bﬂrd
)

171 
bﬂrd
 = "";

172 
	`¥ötk
(
KERN_INFO
 "Pid: %d, comm: %.20s %s %s %.*s %s\n",

173 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

174 
	`öô_ut¢ame
()->
ªÀa£
,

175 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

176 
	`öô_ut¢ame
()->
vîsi⁄
, 
bﬂrd
);

177 
	`¥ötk
(
KERN_INFO
 "RIP: %04lx:[<%016lx>] ", 
ªgs
->
cs
 & 0xffff,Ñegs->
ù
);

178 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

179 
	`¥ötk
(
KERN_INFO
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
ªgs
->
ss
,

180 
ªgs
->
•
,Ñegs->
Êags
);

181 
	`¥ötk
(
KERN_INFO
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

182 
ªgs
->
ax
,Ñegs->
bx
,Ñegs->
cx
);

183 
	`¥ötk
(
KERN_INFO
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

184 
ªgs
->
dx
,Ñegs->
si
,Ñegs->
di
);

185 
	`¥ötk
(
KERN_INFO
 "RBP: %016lx R08: %016lx R09: %016lx\n",

186 
ªgs
->
bp
,Ñegs->
r8
,Ñegs->
r9
);

187 
	`¥ötk
(
KERN_INFO
 "R10: %016lx R11: %016lx R12: %016lx\n",

188 
ªgs
->
r10
,Ñegs->
r11
,Ñegs->
r12
);

189 
	`¥ötk
(
KERN_INFO
 "R13: %016lx R14: %016lx R15: %016lx\n",

190 
ªgs
->
r13
,Ñegs->
r14
,Ñegs->
r15
);

192 
	`asm
("mov»%%ds,%0" : "Ù" (
ds
));

193 
	`asm
("mov»%%cs,%0" : "Ù" (
cs
));

194 
	`asm
("mov»%%es,%0" : "Ù" (
es
));

195 
	`asm
("mov»%%fs,%0" : "Ù" (
fsödex
));

196 
	`asm
("mov»%%gs,%0" : "Ù" (
gsödex
));

198 
	`rdm§l
(
MSR_FS_BASE
, 
fs
);

199 
	`rdm§l
(
MSR_GS_BASE
, 
gs
);

200 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

202 i‡(!
Æl
)

205 
¸0
 = 
	`ªad_¸0
();

206 
¸2
 = 
	`ªad_¸2
();

207 
¸3
 = 
	`ªad_¸3
();

208 
¸4
 = 
	`ªad_¸4
();

210 
	`¥ötk
(
KERN_INFO
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

211 
fs
, 
fsödex
, 
gs
, 
gsödex
, 
shadowgs
);

212 
	`¥ötk
(
KERN_INFO
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

213 
es
, 
¸0
);

214 
	`¥ötk
(
KERN_INFO
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
¸2
, 
¸3
,

215 
¸4
);

217 
	`gë_debugªg
(
d0
, 0);

218 
	`gë_debugªg
(
d1
, 1);

219 
	`gë_debugªg
(
d2
, 2);

220 
	`¥ötk
(
KERN_INFO
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

221 
	`gë_debugªg
(
d3
, 3);

222 
	`gë_debugªg
(
d6
, 6);

223 
	`gë_debugªg
(
d7
, 7);

224 
	`¥ötk
(
KERN_INFO
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

225 
	}
}

227 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

229 
	`¥ötk
(
KERN_INFO
 "CPU %d:", 
	`smp_¥o˚ss‹_id
());

230 
	`__show_ªgs
(
ªgs
, 1);

231 
	`show_åa˚
(
NULL
, 
ªgs
, (*)‘eg†+ 1),Ñegs->
bp
);

232 
	}
}

234 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

236 i‡(
dód_èsk
->
mm
) {

237 i‡(
dód_èsk
->
mm
->
c⁄ãxt
.
size
) {

238 
	`¥ötk
("WARNING: deadÖrocess %8s still has LDT? <%p/%d>\n",

239 
dód_èsk
->
comm
,

240 
dód_èsk
->
mm
->
c⁄ãxt
.
ldt
,

241 
dód_èsk
->
mm
->
c⁄ãxt
.
size
);

242 
	`BUG
();

245 
	}
}

247 
ölöe
 
	$£t_32bô_és
(
èsk_°ru˘
 *
t
, 
és
, 
u32
 
addr
)

249 
u£r_desc
 
ud
 = {

250 .
ba£_addr
 = 
addr
,

251 .
limô
 = 0xfffff,

252 .
£g_32bô
 = 1,

253 .
limô_ö_∑ges
 = 1,

254 .
u£abÀ
 = 1,

256 
desc_°ru˘
 *
desc
 = 
t
->
thªad
.
és_¨øy
;

257 
desc
 +
és
;

258 
	`fûl_ldt
(
desc
, &
ud
);

259 
	}
}

261 
ölöe
 
u32
 
	$ªad_32bô_és
(
èsk_°ru˘
 *
t
, 
és
)

263  
	`gë_desc_ba£
(&
t
->
thªad
.
és_¨øy
[
és
]);

264 
	}
}

270 
	$¥ï¨e_to_c›y
(
èsk_°ru˘
 *
tsk
)

272 
	`u∆azy_Âu
(
tsk
);

273 
	}
}

275 
	$c›y_thªad
(
˛⁄e_Êags
, 
•
,

276 
unu£d
,

277 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

279 
îr
;

280 
±_ªgs
 *
chûdªgs
;

281 
èsk_°ru˘
 *
me
 = 
cuºít
;

283 
chûdªgs
 = ((
±_ªgs
 *)

284 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
p
))) - 1;

285 *
chûdªgs
 = *
ªgs
;

287 
chûdªgs
->
ax
 = 0;

288 
chûdªgs
->
•
 = sp;

289 i‡(
•
 == ~0UL)

290 
chûdªgs
->
•
 = ()childregs;

292 
p
->
thªad
.
•
 = (Ë
chûdªgs
;

293 
p
->
thªad
.
•0
 = (Ë(
chûdªgs
+1);

294 
p
->
thªad
.
u£r•
 = 
me
->thread.usersp;

296 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_FORK
);

298 
p
->
thªad
.
fs
 = 
me
->thread.fs;

299 
p
->
thªad
.
gs
 = 
me
->thread.gs;

301 
	`ßve£gmít
(
gs
, 
p
->
thªad
.
gsödex
);

302 
	`ßve£gmít
(
fs
, 
p
->
thªad
.
fsödex
);

303 
	`ßve£gmít
(
es
, 
p
->
thªad
.es);

304 
	`ßve£gmít
(
ds
, 
p
->
thªad
.ds);

306 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
me
, 
TIF_IO_BITMAP
))) {

307 
p
->
thªad
.
io_bôm≠_±r
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

308 i‡(!
p
->
thªad
.
io_bôm≠_±r
) {

309 
p
->
thªad
.
io_bôm≠_max
 = 0;

310  -
ENOMEM
;

312 
	`mem˝y
(
p
->
thªad
.
io_bôm≠_±r
, 
me
->thread.io_bitmap_ptr,

313 
IO_BITMAP_BYTES
);

314 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_IO_BITMAP
);

320 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
) {

321 #ifde‡
CONFIG_IA32_EMULATION


322 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

323 
îr
 = 
	`do_£t_thªad_¨ó
(
p
, -1,

324 (
u£r_desc
 
__u£r
 *)
chûdªgs
->
si
, 0);

327 
îr
 = 
	`do_¨ch_¥˘l
(
p
, 
ARCH_SET_FS
, 
chûdªgs
->
r8
);

328 i‡(
îr
)

329 
out
;

332 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DS_AREA_MSR
);

333 
p
->
thªad
.
ds_˘x
 = 
NULL
;

335 
	`˛ór_tsk_thªad_Êag
(
p
, 
TIF_DEBUGCTLMSR
);

336 
p
->
thªad
.
debug˘lm§
 = 0;

338 
îr
 = 0;

339 
out
:

340 i‡(
îr
 && 
p
->
thªad
.
io_bôm≠_±r
) {

341 
	`k‰ì
(
p
->
thªad
.
io_bôm≠_±r
);

342 
p
->
thªad
.
io_bôm≠_max
 = 0;

344  
îr
;

345 
	}
}

348 
	$°¨t_thªad
(
±_ªgs
 *
ªgs
, 
√w_ù
, 
√w_•
)

350 
	`lﬂd£gmít
(
fs
, 0);

351 
	`lﬂd£gmít
(
es
, 0);

352 
	`lﬂd£gmít
(
ds
, 0);

353 
	`lﬂd_gs_ödex
(0);

354 
ªgs
->
ù
 = 
√w_ù
;

355 
ªgs
->
•
 = 
√w_•
;

356 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√w_•
);

357 
ªgs
->
cs
 = 
__USER_CS
;

358 
ªgs
->
ss
 = 
__USER_DS
;

359 
ªgs
->
Êags
 = 0x200;

360 
	`£t_fs
(
USER_DS
);

364 
	`‰ì_thªad_x°©e
(
cuºít
);

365 
	}
}

366 
EXPORT_SYMBOL_GPL
(
°¨t_thªad
);

378 
__nŸø˚_funcgøph
 
èsk_°ru˘
 *

379 
	$__swôch_to
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
)

381 
thªad_°ru˘
 *
¥ev
 = &
¥ev_p
->
thªad
;

382 
thªad_°ru˘
 *
√xt
 = &
√xt_p
->
thªad
;

383 
˝u
 = 
	`smp_¥o˚ss‹_id
();

384 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

385 
fsödex
, 
gsödex
;

386 
boﬁ
 
¥ñﬂd_Âu
;

393 
¥ñﬂd_Âu
 = 
	`tsk_u£d_m©h
(
√xt_p
Ë&&Çext_p->
Âu_cou¡î
 > 5;

396 i‡(
¥ñﬂd_Âu
)

397 
	`¥e„tch
(
√xt
->
x°©e
);

402 
	`lﬂd_•0
(
tss
, 
√xt
);

408 
	`ßve£gmít
(
es
, 
¥ev
->es);

409 i‡(
	`u∆ikñy
(
√xt
->
es
 | 
¥ev
->es))

410 
	`lﬂd£gmít
(
es
, 
√xt
->es);

412 
	`ßve£gmít
(
ds
, 
¥ev
->ds);

413 i‡(
	`u∆ikñy
(
√xt
->
ds
 | 
¥ev
->ds))

414 
	`lﬂd£gmít
(
ds
, 
√xt
->ds);

422 
	`ßve£gmít
(
fs
, 
fsödex
);

423 
	`ßve£gmít
(
gs
, 
gsödex
);

425 
	`lﬂd_TLS
(
√xt
, 
˝u
);

428 
	`u∆azy_Âu
(
¥ev_p
);

431 i‡(
¥ñﬂd_Âu
)

432 
	`˛ts
();

441 
	`¨ch_íd_c⁄ãxt_swôch
(
√xt_p
);

450 i‡(
	`u∆ikñy
(
fsödex
 | 
√xt
->fsödex | 
¥ev
->
fs
)) {

451 
	`lﬂd£gmít
(
fs
, 
√xt
->
fsödex
);

457 i‡(
fsödex
)

458 
¥ev
->
fs
 = 0;

461 i‡(
√xt
->
fs
)

462 
	`wrm§l
(
MSR_FS_BASE
, 
√xt
->
fs
);

463 
¥ev
->
fsödex
 = fsindex;

465 i‡(
	`u∆ikñy
(
gsödex
 | 
√xt
->gsödex | 
¥ev
->
gs
)) {

466 
	`lﬂd_gs_ödex
(
√xt
->
gsödex
);

467 i‡(
gsödex
)

468 
¥ev
->
gs
 = 0;

470 i‡(
√xt
->
gs
)

471 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 
√xt
->
gs
);

472 
¥ev
->
gsödex
 = gsindex;

477 
¥ev
->
u£r•
 = 
	`≥r˝u_ªad
(
ﬁd_r•
);

478 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√xt
->
u£r•
);

479 
	`≥r˝u_wrôe
(
cuºít_èsk
, 
√xt_p
);

481 
	`≥r˝u_wrôe
(
kî√l_°ack
,

482 ()
	`èsk_°ack_∑ge
(
√xt_p
) +

483 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

488 i‡(
	`u∆ikñy
(
	`èsk_thªad_öfo
(
√xt_p
)->
Êags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

489 
	`èsk_thªad_öfo
(
¥ev_p
)->
Êags
 & 
_TIF_WORK_CTXSW_PREV
))

490 
	`__swôch_to_xåa
(
¥ev_p
, 
√xt_p
, 
tss
);

496 i‡(
¥ñﬂd_Âu
)

497 
	`__m©h_°©e_ª°‹e
();

498  
¥ev_p
;

499 
	}
}

504 
asmlökage


505 
	$sys_execve
(
__u£r
 *
«me
, __u£∏* __u£∏*
¨gv
,

506 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

508 
îr‹
;

509 *
fûíame
;

511 
fûíame
 = 
	`gë«me
(
«me
);

512 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

513 i‡(
	`IS_ERR
(
fûíame
))

514  
îr‹
;

515 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

516 
	`puäame
(
fûíame
);

517  
îr‹
;

518 
	}
}

520 
	$£t_≥rs⁄Æôy_64bô
()

525 
	`˛ór_thªad_Êag
(
TIF_IA32
);

531 
cuºít
->
≥rs⁄Æôy
 &~
READ_IMPLIES_EXEC
;

532 
	}
}

534 
asmlökage
 

535 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

536 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
, 
±_ªgs
 *
ªgs
)

538 i‡(!
√w•
)

539 
√w•
 = 
ªgs
->
•
;

540  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

541 
	}
}

543 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

545 
°ack
;

546 
u64
 
Â
, 
ù
;

547 
cou¡
 = 0;

549 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

551 
°ack
 = ()
	`èsk_°ack_∑ge
(
p
);

552 i‡(
p
->
thªad
.
•
 < 
°ack
 ||Ö->thªad.• >°ack+
THREAD_SIZE
)

554 
Â
 = *(
u64
 *)(
p
->
thªad
.
•
);

556 i‡(
Â
 < ()
°ack
 ||

557 
Â
 >()
°ack
+
THREAD_SIZE
)

559 
ù
 = *(
u64
 *)(
Â
+8);

560 i‡(!
	`ö_sched_fun˘i⁄s
(
ù
))

561  
ù
;

562 
Â
 = *(
u64
 *)fp;

563 } 
cou¡
++ < 16);

565 
	}
}

567 
	$do_¨ch_¥˘l
(
èsk_°ru˘
 *
èsk
, 
code
, 
addr
)

569 
ªt
 = 0;

570 
doô
 = 
èsk
 =
cuºít
;

571 
˝u
;

573 
code
) {

574 
ARCH_SET_GS
:

575 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

576  -
EPERM
;

577 
˝u
 = 
	`gë_˝u
();

580 i‡(
addr
 <= 0xffffffff) {

581 
	`£t_32bô_és
(
èsk
, 
GS_TLS
, 
addr
);

582 i‡(
doô
) {

583 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

584 
	`lﬂd_gs_ödex
(
GS_TLS_SEL
);

586 
èsk
->
thªad
.
gsödex
 = 
GS_TLS_SEL
;

587 
èsk
->
thªad
.
gs
 = 0;

589 
èsk
->
thªad
.
gsödex
 = 0;

590 
èsk
->
thªad
.
gs
 = 
addr
;

591 i‡(
doô
) {

592 
	`lﬂd_gs_ödex
(0);

593 
ªt
 = 
	`checkög_wrm§l
(
MSR_KERNEL_GS_BASE
, 
addr
);

596 
	`put_˝u
();

598 
ARCH_SET_FS
:

601 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

602  -
EPERM
;

603 
˝u
 = 
	`gë_˝u
();

606 i‡(
addr
 <= 0xffffffff) {

607 
	`£t_32bô_és
(
èsk
, 
FS_TLS
, 
addr
);

608 i‡(
doô
) {

609 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

610 
	`lﬂd£gmít
(
fs
, 
FS_TLS_SEL
);

612 
èsk
->
thªad
.
fsödex
 = 
FS_TLS_SEL
;

613 
èsk
->
thªad
.
fs
 = 0;

615 
èsk
->
thªad
.
fsödex
 = 0;

616 
èsk
->
thªad
.
fs
 = 
addr
;

617 i‡(
doô
) {

620 
	`lﬂd£gmít
(
fs
, 0);

621 
ªt
 = 
	`checkög_wrm§l
(
MSR_FS_BASE
, 
addr
);

624 
	`put_˝u
();

626 
ARCH_GET_FS
: {

627 
ba£
;

628 i‡(
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
)

629 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
FS_TLS
);

630 i‡(
doô
)

631 
	`rdm§l
(
MSR_FS_BASE
, 
ba£
);

633 
ba£
 = 
èsk
->
thªad
.
fs
;

634 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

637 
ARCH_GET_GS
: {

638 
ba£
;

639 
gsödex
;

640 i‡(
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
)

641 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
GS_TLS
);

642 i‡(
doô
) {

643 
	`ßve£gmít
(
gs
, 
gsödex
);

644 i‡(
gsödex
)

645 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

647 
ba£
 = 
èsk
->
thªad
.
gs
;

649 
ba£
 = 
èsk
->
thªad
.
gs
;

650 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

655 
ªt
 = -
EINVAL
;

659  
ªt
;

660 
	}
}

662 
	$sys_¨ch_¥˘l
(
code
, 
addr
)

664  
	`do_¨ch_¥˘l
(
cuºít
, 
code
, 
addr
);

665 
	}
}

667 
	$KSTK_ESP
(
èsk_°ru˘
 *
èsk
)

669  (
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
)) ?

670 (
	`èsk_±_ªgs
(
èsk
)->
•
Ë: (—ask)->
thªad
.
u£r•
);

671 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/ªg£t.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/u£r.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/£curôy.h
>

21 
	~<löux/audô.h
>

22 
	~<löux/£ccomp.h
>

23 
	~<löux/sig«l.h
>

24 
	~<löux/w‹kqueue.h
>

26 
	~<asm/uac˚ss.h
>

27 
	~<asm/pgèbÀ.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/¥o˚ss‹.h
>

30 
	~<asm/i387.h
>

31 
	~<asm/debugªg.h
>

32 
	~<asm/ldt.h
>

33 
	~<asm/desc.h
>

34 
	~<asm/¥˘l.h
>

35 
	~<asm/¥Ÿo.h
>

36 
	~<asm/ds.h
>

38 
	~"és.h
"

40 
	#CREATE_TRACE_POINTS


	)

41 
	~<åa˚/evíts/sysˇŒs.h
>

43 
	ex86_ªg£t
 {

44 
	mREGSET_GENERAL
,

45 
	mREGSET_FP
,

46 
	mREGSET_XFP
,

47 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

48 
	mREGSET_TLS
,

49 
	mREGSET_IOPERM32
,

60 
	#FLAG_MASK_32
 (() \

61 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

62 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

63 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

64 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

65 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

70 
ölöe
 
boﬁ
 
	$övÆid_£À˘‹
(
u16
 
vÆue
)

72  
	`u∆ikñy
(
vÆue
 !0 && (vÆuê& 
SEGMENT_RPL_MASK
Ë!
USER_RPL
);

73 
	}
}

75 #ifde‡
CONFIG_X86_32


77 
	#FLAG_MASK
 
FLAG_MASK_32


	)

79 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
ªgno
)

81 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
bx
) != 0);

82  &
ªgs
->
bx
 + (
ªgno
 >> 2);

83 
	}
}

85 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

90 
ªtvÆ
;

91 i‡(
off£t
 !
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
))

92 
ªtvÆ
 = *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

94 i‡(
èsk
 =
cuºít
)

95 
ªtvÆ
 = 
	`gë_u£r_gs
(
	`èsk_±_ªgs
(
èsk
));

97 
ªtvÆ
 = 
	`èsk_u£r_gs
(
èsk
);

99  
ªtvÆ
;

100 
	}
}

102 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

103 
off£t
, 
u16
 
vÆue
)

108 i‡(
	`övÆid_£À˘‹
(
vÆue
))

109  -
EIO
;

120 
off£t
) {

121 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

122 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

123 i‡(
	`u∆ikñy
(
vÆue
 == 0))

124  -
EIO
;

127 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
Ë
vÆue
;

130 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

131 i‡(
èsk
 =
cuºít
)

132 
	`£t_u£r_gs
(
	`èsk_±_ªgs
(
èsk
), 
vÆue
);

134 
	`èsk_u£r_gs
(
èsk
Ë
vÆue
;

138 
	}
}

140 
	$debugªg_addr_limô
(
èsk_°ru˘
 *
èsk
)

142  
TASK_SIZE
 - 3;

143 
	}
}

147 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

149 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
off£t
)

151 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
r15
) != 0);

152  &
ªgs
->
r15
 + (
off£t
 / (regs->r15));

153 
	}
}

155 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

160 
£g
;

162 
off£t
) {

163 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

164 i‡(
èsk
 =
cuºít
) {

166 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

167  
£g
;

169  
èsk
->
thªad
.
fsödex
;

170 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

171 i‡(
èsk
 =
cuºít
) {

172 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

173  
£g
;

175  
èsk
->
thªad
.
gsödex
;

176 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

177 i‡(
èsk
 =
cuºít
) {

178 
	`asm
("mov»%%ds,%0" : "Ù" (
£g
));

179  
£g
;

181  
èsk
->
thªad
.
ds
;

182 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

183 i‡(
èsk
 =
cuºít
) {

184 
	`asm
("mov»%%es,%0" : "Ù" (
£g
));

185  
£g
;

187  
èsk
->
thªad
.
es
;

189 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

190 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

193  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

194 
	}
}

196 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

197 
off£t
, 
u16
 
vÆue
)

202 i‡(
	`övÆid_£À˘‹
(
vÆue
))

203  -
EIO
;

205 
off£t
) {

206 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs
):

211 i‡((
vÆue
 =
FS_TLS_SEL
 && 
èsk
->
thªad
.
fsödex
 == 0 &&

212 
èsk
->
thªad
.
fs
 != 0) ||

213 (
vÆue
 =0 && 
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
 &&

214 
èsk
->
thªad
.
fs
 == 0))

216 
èsk
->
thªad
.
fsödex
 = 
vÆue
;

217 i‡(
èsk
 =
cuºít
)

218 
	`lﬂd£gmít
(
fs
, 
èsk
->
thªad
.
fsödex
);

220 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs
):

225 i‡((
vÆue
 =
GS_TLS_SEL
 && 
èsk
->
thªad
.
gsödex
 == 0 &&

226 
èsk
->
thªad
.
gs
 != 0) ||

227 (
vÆue
 =0 && 
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
 &&

228 
èsk
->
thªad
.
gs
 == 0))

230 
èsk
->
thªad
.
gsödex
 = 
vÆue
;

231 i‡(
èsk
 =
cuºít
)

232 
	`lﬂd_gs_ödex
(
èsk
->
thªad
.
gsödex
);

234 
	`off£tof
(
u£r_ªgs_°ru˘
,
ds
):

235 
èsk
->
thªad
.
ds
 = 
vÆue
;

236 i‡(
èsk
 =
cuºít
)

237 
	`lﬂd£gmít
(
ds
, 
èsk
->
thªad
.ds);

239 
	`off£tof
(
u£r_ªgs_°ru˘
,
es
):

240 
èsk
->
thªad
.
es
 = 
vÆue
;

241 i‡(
èsk
 =
cuºít
)

242 
	`lﬂd£gmít
(
es
, 
èsk
->
thªad
.es);

248 
	`off£tof
(
u£r_ªgs_°ru˘
,
cs
):

249 i‡(
	`u∆ikñy
(
vÆue
 == 0))

250  -
EIO
;

251 #ifde‡
CONFIG_IA32_EMULATION


252 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

253 
	`èsk_±_ªgs
(
èsk
)->
cs
 = 
vÆue
;

256 
	`off£tof
(
u£r_ªgs_°ru˘
,
ss
):

257 i‡(
	`u∆ikñy
(
vÆue
 == 0))

258  -
EIO
;

259 #ifde‡
CONFIG_IA32_EMULATION


260 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

261 
	`èsk_±_ªgs
(
èsk
)->
ss
 = 
vÆue
;

267 
	}
}

269 
	$debugªg_addr_limô
(
èsk_°ru˘
 *
èsk
)

271 #ifde‡
CONFIG_IA32_EMULATION


272 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

273  
IA32_PAGE_OFFSET
 - 3;

275  
TASK_SIZE_MAX
 - 7;

276 
	}
}

280 
	$gë_Êags
(
èsk_°ru˘
 *
èsk
)

282 
ªtvÆ
 = 
	`èsk_±_ªgs
(
èsk
)->
Êags
;

287 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

288 
ªtvÆ
 &~
X86_EFLAGS_TF
;

290  
ªtvÆ
;

291 
	}
}

293 
	$£t_Êags
(
èsk_°ru˘
 *
èsk
, 
vÆue
)

295 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

302 i‡(
vÆue
 & 
X86_EFLAGS_TF
)

303 
	`˛ór_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
);

304 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

305 
vÆue
 |
X86_EFLAGS_TF
;

307 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FLAG_MASK
Ë| (
vÆue
 & FLAG_MASK);

310 
	}
}

312 
	$puåeg
(
èsk_°ru˘
 *
chûd
,

313 
off£t
, 
vÆue
)

315 
off£t
) {

316 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

317 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

318 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

319 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

320 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

321 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

322  
	`£t_£gmít_ªg
(
chûd
, 
off£t
, 
vÆue
);

324 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

325  
	`£t_Êags
(
chûd
, 
vÆue
);

327 #ifde‡
CONFIG_X86_64


328 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs_ba£
):

329 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

330  -
EIO
;

336 i‡(
chûd
->
thªad
.
fs
 !
vÆue
)

337  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_FS
, 
vÆue
);

339 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs_ba£
):

343 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

344  -
EIO
;

345 i‡(
chûd
->
thªad
.
gs
 !
vÆue
)

346  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_GS
, 
vÆue
);

351 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
chûd
), 
off£t
Ë
vÆue
;

353 
	}
}

355 
	$gëªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

357 
off£t
) {

358 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

359 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

360 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

361 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

362 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

363 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

364  
	`gë_£gmít_ªg
(
èsk
, 
off£t
);

366 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

367  
	`gë_Êags
(
èsk
);

369 #ifde‡
CONFIG_X86_64


370 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs_ba£
): {

376 
£g
 = 
èsk
->
thªad
.
fsödex
;

377 i‡(
èsk
->
thªad
.
fs
 != 0)

378  
èsk
->
thªad
.
fs
;

379 i‡(
èsk
 =
cuºít
)

380 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

381 i‡(
£g
 !
FS_TLS_SEL
)

383  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
FS_TLS
]);

385 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs_ba£
): {

389 
£g
 = 
èsk
->
thªad
.
gsödex
;

390 i‡(
èsk
->
thªad
.
gs
 != 0)

391  
èsk
->
thªad
.
gs
;

392 i‡(
èsk
 =
cuºít
)

393 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

394 i‡(
£g
 !
GS_TLS_SEL
)

396  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
GS_TLS
]);

401  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

402 
	}
}

404 
	$gíªgs_gë
(
èsk_°ru˘
 *
èrgë
,

405 c⁄° 
u£r_ªg£t
 *
ªg£t
,

406 
pos
, 
cou¡
,

407 *
kbuf
, 
__u£r
 *
ubuf
)

409 i‡(
kbuf
) {

410 *
k
 = 
kbuf
;

411 
cou¡
 > 0) {

412 *
k
++ = 
	`gëªg
(
èrgë
, 
pos
);

413 
cou¡
 -(*
k
);

414 
pos
 +(*
k
);

417 
__u£r
 *
u
 = 
ubuf
;

418 
cou¡
 > 0) {

419 i‡(
	`__put_u£r
(
	`gëªg
(
èrgë
, 
pos
), 
u
++))

420  -
EFAULT
;

421 
cou¡
 -(*
u
);

422 
pos
 +(*
u
);

427 
	}
}

429 
	$gíªgs_£t
(
èsk_°ru˘
 *
èrgë
,

430 c⁄° 
u£r_ªg£t
 *
ªg£t
,

431 
pos
, 
cou¡
,

432 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

434 
ªt
 = 0;

435 i‡(
kbuf
) {

436 c⁄° *
k
 = 
kbuf
;

437 
cou¡
 > 0 && !
ªt
) {

438 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, *
k
++);

439 
cou¡
 -(*
k
);

440 
pos
 +(*
k
);

443 c⁄° 
__u£r
 *
u
 = 
ubuf
;

444 
cou¡
 > 0 && !
ªt
) {

445 
w‹d
;

446 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

447 i‡(
ªt
)

449 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, 
w‹d
);

450 
cou¡
 -(*
u
);

451 
pos
 +(*
u
);

454  
ªt
;

455 
	}
}

462 
	$±ø˚_gë_debugªg
(
èsk_°ru˘
 *
chûd
, 
n
)

464 
n
) {

465 0:  
chûd
->
thªad
.
debugªg0
;

466 1:  
chûd
->
thªad
.
debugªg1
;

467 2:  
chûd
->
thªad
.
debugªg2
;

468 3:  
chûd
->
thªad
.
debugªg3
;

469 6:  
chûd
->
thªad
.
debugªg6
;

470 7:  
chûd
->
thªad
.
debugªg7
;

473 
	}
}

475 
	$±ø˚_£t_debugªg
(
èsk_°ru˘
 *
chûd
,

476 
n
, 
d©a
)

478 
i
;

480 i‡(
	`u∆ikñy
(
n
 == 4 ||Ç == 5))

481  -
EIO
;

483 i‡(
n
 < 4 && 
	`u∆ikñy
(
d©a
 >
	`debugªg_addr_limô
(
chûd
)))

484  -
EIO
;

486 
n
) {

487 0: 
chûd
->
thªad
.
debugªg0
 = 
d©a
; ;

488 1: 
chûd
->
thªad
.
debugªg1
 = 
d©a
; ;

489 2: 
chûd
->
thªad
.
debugªg2
 = 
d©a
; ;

490 3: 
chûd
->
thªad
.
debugªg3
 = 
d©a
; ;

493 i‡((
d©a
 & ~0xffffffffUL) != 0)

494  -
EIO
;

495 
chûd
->
thªad
.
debugªg6
 = 
d©a
;

529 #ifde‡
CONFIG_X86_32


530 
	#DR7_MASK
 0x5f54

	)

532 
	#DR7_MASK
 0x5554

	)

534 
d©a
 &~
DR_CONTROL_RESERVED
;

535 
i
 = 0; i < 4; i++)

536 i‡((
DR7_MASK
 >> ((
d©a
 >> (16 + 4*
i
)) & 0xf)) & 1)

537  -
EIO
;

538 
chûd
->
thªad
.
debugªg7
 = 
d©a
;

539 i‡(
d©a
)

540 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUG
);

542 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUG
);

547 
	}
}

553 
	$i›îm_a˘ive
(
èsk_°ru˘
 *
èrgë
,

554 c⁄° 
u£r_ªg£t
 *
ªg£t
)

556  
èrgë
->
thªad
.
io_bôm≠_max
 / 
ªg£t
->
size
;

557 
	}
}

559 
	$i›îm_gë
(
èsk_°ru˘
 *
èrgë
,

560 c⁄° 
u£r_ªg£t
 *
ªg£t
,

561 
pos
, 
cou¡
,

562 *
kbuf
, 
__u£r
 *
ubuf
)

564 i‡(!
èrgë
->
thªad
.
io_bôm≠_±r
)

565  -
ENXIO
;

567  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

568 
èrgë
->
thªad
.
io_bôm≠_±r
,

569 0, 
IO_BITMAP_BYTES
);

570 
	}
}

572 #ifde‡
CONFIG_X86_PTRACE_BTS


590 
	sbts_c⁄ãxt
 {

592 
bts_åa˚r
 *
	måa˚r
;

595 *
	mbuf„r
;

596 
	msize
;

599 
mm_°ru˘
 *
	mmm
;

602 
èsk_°ru˘
 *
	mèsk
;

605 
	mbts_ovÊ_sig«l
;

608 
w‹k_°ru˘
 
	mw‹k
;

611 
	$Æloc_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
, 
size
)

613 *
buf„r
 = 
NULL
;

614 
îr
 = -
ENOMEM
;

616 
îr
 = 
	`accou¡_locked_mem‹y
(
cuºít
->
mm
, cuºít->
sig«l
->
æim
, 
size
);

617 i‡(
îr
 < 0)

618  
îr
;

620 
buf„r
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

621 i‡(!
buf„r
)

622 
out_ªfund
;

624 
c⁄ãxt
->
buf„r
 = buffer;

625 
c⁄ãxt
->
size
 = size;

626 
c⁄ãxt
->
mm
 = 
	`gë_èsk_mm
(
cuºít
);

630 
out_ªfund
:

631 
	`ªfund_locked_mem‹y
(
cuºít
->
mm
, 
size
);

632  
îr
;

633 
	}
}

635 
ölöe
 
	$‰ì_bts_buf„r
(
bts_c⁄ãxt
 *
c⁄ãxt
)

637 i‡(!
c⁄ãxt
->
buf„r
)

640 
	`k‰ì
(
c⁄ãxt
->
buf„r
);

641 
c⁄ãxt
->
buf„r
 = 
NULL
;

643 
	`ªfund_locked_mem‹y
(
c⁄ãxt
->
mm
, c⁄ãxt->
size
);

644 
c⁄ãxt
->
size
 = 0;

646 
	`mmput
(
c⁄ãxt
->
mm
);

647 
c⁄ãxt
->
mm
 = 
NULL
;

648 
	}
}

650 
	$‰ì_bts_c⁄ãxt_w‹k
(
w‹k_°ru˘
 *
w
)

652 
bts_c⁄ãxt
 *
c⁄ãxt
;

654 
c⁄ãxt
 = 
	`c⁄èöî_of
(
w
, 
bts_c⁄ãxt
, 
w‹k
);

656 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

657 
	`put_èsk_°ru˘
(
c⁄ãxt
->
èsk
);

658 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

659 
	`k‰ì
(
c⁄ãxt
);

660 
	}
}

662 
ölöe
 
	$‰ì_bts_c⁄ãxt
(
bts_c⁄ãxt
 *
c⁄ãxt
)

664 
	`INIT_WORK
(&
c⁄ãxt
->
w‹k
, 
‰ì_bts_c⁄ãxt_w‹k
);

665 
	`scheduÀ_w‹k
(&
c⁄ãxt
->
w‹k
);

666 
	}
}

668 
ölöe
 
bts_c⁄ãxt
 *
	$Æloc_bts_c⁄ãxt
(
èsk_°ru˘
 *
èsk
)

670 
bts_c⁄ãxt
 *
c⁄ãxt
 = 
	`kzÆloc
((*c⁄ãxt), 
GFP_KERNEL
);

671 i‡(
c⁄ãxt
) {

672 
c⁄ãxt
->
èsk
 =Åask;

673 
èsk
->
bts
 = 
c⁄ãxt
;

675 
	`gë_èsk_°ru˘
(
èsk
);

678  
c⁄ãxt
;

679 
	}
}

681 
	$±ø˚_bts_ªad_ªc‹d
(
èsk_°ru˘
 *
chûd
, 
size_t
 
ödex
,

682 
bts_°ru˘
 
__u£r
 *
out
)

684 
bts_c⁄ãxt
 *
c⁄ãxt
;

685 c⁄° 
bts_åa˚
 *
åa˚
;

686 
bts_°ru˘
 
bts
;

687 c⁄° *
©
;

688 
îr‹
;

690 
c⁄ãxt
 = 
chûd
->
bts
;

691 i‡(!
c⁄ãxt
)

692  -
ESRCH
;

694 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

695 i‡(!
åa˚
)

696  -
ESRCH
;

698 
©
 = 
åa˚
->
ds
.
t›
 - ((
ödex
 + 1Ë*Åø˚->ds.
size
);

699 i‡((*)
©
 < 
åa˚
->
ds
.
begö
)

700 
©
 +(
åa˚
->
ds
.
n
 *Åø˚->ds.
size
);

702 i‡(!
åa˚
->
ªad
)

703  -
EOPNOTSUPP
;

705 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

706 i‡(
îr‹
 < 0)

707  
îr‹
;

709 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

710  -
EFAULT
;

712  (
bts
);

713 
	}
}

715 
	$±ø˚_bts_døö
(
èsk_°ru˘
 *
chûd
,

716 
size
,

717 
bts_°ru˘
 
__u£r
 *
out
)

719 
bts_c⁄ãxt
 *
c⁄ãxt
;

720 c⁄° 
bts_åa˚
 *
åa˚
;

721 c⁄° *
©
;

722 
îr‹
, 
døöed
 = 0;

724 
c⁄ãxt
 = 
chûd
->
bts
;

725 i‡(!
c⁄ãxt
)

726  -
ESRCH
;

728 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

729 i‡(!
åa˚
)

730  -
ESRCH
;

732 i‡(!
åa˚
->
ªad
)

733  -
EOPNOTSUPP
;

735 i‡(
size
 < (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
))

736  -
EIO
;

738 
©
 = 
åa˚
->
ds
.
begö
; (*Ôà<Åø˚->ds.
t›
;

739 
out
++, 
døöed
++, 
©
 +
åa˚
->
ds
.
size
) {

740 
bts_°ru˘
 
bts
;

742 
îr‹
 = 
åa˚
->
	`ªad
(
c⁄ãxt
->
åa˚r
, 
©
, &
bts
);

743 i‡(
îr‹
 < 0)

744  
îr‹
;

746 i‡(
	`c›y_to_u£r
(
out
, &
bts
, (bts)))

747  -
EFAULT
;

750 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

752 
îr‹
 = 
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

753 i‡(
îr‹
 < 0)

754  
îr‹
;

756  
døöed
;

757 
	}
}

759 
	$±ø˚_bts_c⁄fig
(
èsk_°ru˘
 *
chûd
,

760 
cfg_size
,

761 c⁄° 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

763 
bts_c⁄ãxt
 *
c⁄ãxt
;

764 
±ø˚_bts_c⁄fig
 
cfg
;

765 
Êags
 = 0;

767 i‡(
cfg_size
 < (
cfg
))

768  -
EIO
;

770 i‡(
	`c›y_‰om_u£r
(&
cfg
, 
ucfg
, (cfg)))

771  -
EFAULT
;

773 
c⁄ãxt
 = 
chûd
->
bts
;

774 i‡(!
c⁄ãxt
)

775 
c⁄ãxt
 = 
	`Æloc_bts_c⁄ãxt
(
chûd
);

776 i‡(!
c⁄ãxt
)

777  -
ENOMEM
;

779 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SIGNAL
) {

780 i‡(!
cfg
.
sig«l
)

781  -
EINVAL
;

783  -
EOPNOTSUPP
;

784 
c⁄ãxt
->
bts_ovÊ_sig«l
 = 
cfg
.
sig«l
;

787 
	`ds_ªÀa£_bts
(
c⁄ãxt
->
åa˚r
);

788 
c⁄ãxt
->
åa˚r
 = 
NULL
;

790 i‡((
cfg
.
Êags
 & 
PTRACE_BTS_O_ALLOC
Ë&& (cfg.
size
 !
c⁄ãxt
->size)) {

791 
îr
;

793 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

794 i‡(!
cfg
.
size
)

797 
îr
 = 
	`Æloc_bts_buf„r
(
c⁄ãxt
, 
cfg
.
size
);

798 i‡(
îr
 < 0)

799  
îr
;

802 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_TRACE
)

803 
Êags
 |
BTS_USER
;

805 i‡(
cfg
.
Êags
 & 
PTRACE_BTS_O_SCHED
)

806 
Êags
 |
BTS_TIMESTAMPS
;

808 
c⁄ãxt
->
åa˚r
 =

809 
	`ds_ªque°_bts_èsk
(
chûd
, 
c⁄ãxt
->
buf„r
, c⁄ãxt->
size
,

810 
NULL
, (
size_t
)-1, 
Êags
);

811 i‡(
	`u∆ikñy
(
	`IS_ERR
(
c⁄ãxt
->
åa˚r
))) {

812 
îr‹
 = 
	`PTR_ERR
(
c⁄ãxt
->
åa˚r
);

814 
	`‰ì_bts_buf„r
(
c⁄ãxt
);

815 
c⁄ãxt
->
åa˚r
 = 
NULL
;

816  
îr‹
;

819  (
cfg
);

820 
	}
}

822 
	$±ø˚_bts_°©us
(
èsk_°ru˘
 *
chûd
,

823 
cfg_size
,

824 
±ø˚_bts_c⁄fig
 
__u£r
 *
ucfg
)

826 
bts_c⁄ãxt
 *
c⁄ãxt
;

827 c⁄° 
bts_åa˚
 *
åa˚
;

828 
±ø˚_bts_c⁄fig
 
cfg
;

830 
c⁄ãxt
 = 
chûd
->
bts
;

831 i‡(!
c⁄ãxt
)

832  -
ESRCH
;

834 i‡(
cfg_size
 < (
cfg
))

835  -
EIO
;

837 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

838 i‡(!
åa˚
)

839  -
ESRCH
;

841 
	`mem£t
(&
cfg
, 0, (cfg));

842 
cfg
.
size
 = 
åa˚
->
ds
.
íd
 -Åø˚->ds.
begö
;

843 
cfg
.
sig«l
 = 
c⁄ãxt
->
bts_ovÊ_sig«l
;

844 
cfg
.
bts_size
 = (
bts_°ru˘
);

846 i‡(
cfg
.
sig«l
)

847 
cfg
.
Êags
 |
PTRACE_BTS_O_SIGNAL
;

849 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_USER
)

850 
cfg
.
Êags
 |
PTRACE_BTS_O_TRACE
;

852 i‡(
åa˚
->
ds
.
Êags
 & 
BTS_TIMESTAMPS
)

853 
cfg
.
Êags
 |
PTRACE_BTS_O_SCHED
;

855 i‡(
	`c›y_to_u£r
(
ucfg
, &
cfg
, (cfg)))

856  -
EFAULT
;

858  (
cfg
);

859 
	}
}

861 
	$±ø˚_bts_˛ór
(
èsk_°ru˘
 *
chûd
)

863 
bts_c⁄ãxt
 *
c⁄ãxt
;

864 c⁄° 
bts_åa˚
 *
åa˚
;

866 
c⁄ãxt
 = 
chûd
->
bts
;

867 i‡(!
c⁄ãxt
)

868  -
ESRCH
;

870 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

871 i‡(!
åa˚
)

872  -
ESRCH
;

874 
	`mem£t
(
åa˚
->
ds
.
begö
, 0,Åø˚->ds.
n
 *Åø˚->ds.
size
);

876  
	`ds_ª£t_bts
(
c⁄ãxt
->
åa˚r
);

877 
	}
}

879 
	$±ø˚_bts_size
(
èsk_°ru˘
 *
chûd
)

881 
bts_c⁄ãxt
 *
c⁄ãxt
;

882 c⁄° 
bts_åa˚
 *
åa˚
;

884 
c⁄ãxt
 = 
chûd
->
bts
;

885 i‡(!
c⁄ãxt
)

886  -
ESRCH
;

888 
åa˚
 = 
	`ds_ªad_bts
(
c⁄ãxt
->
åa˚r
);

889 i‡(!
åa˚
)

890  -
ESRCH
;

892  (
åa˚
->
ds
.
t›
 -Åø˚->ds.
begö
Ë/Åø˚->ds.
size
;

893 
	}
}

899 
	$±ø˚_bts_u¡ø˚
(
èsk_°ru˘
 *
chûd
)

901 i‡(
	`u∆ikñy
(
chûd
->
bts
)) {

902 
	`‰ì_bts_c⁄ãxt
(
chûd
->
bts
);

903 
chûd
->
bts
 = 
NULL
;

905 
	}
}

913 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

915 
	`u£r_dißbÀ_sögÀ_°ï
(
chûd
);

916 #ifde‡
TIF_SYSCALL_EMU


917 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_EMU
);

919 
	}
}

921 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


922 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
;

925 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

927 
ªt
;

928 
__u£r
 *
d©≠
 = (__u£∏*)
d©a
;

930 
ªque°
) {

932 
PTRACE_PEEKUSR
: {

933 
tmp
;

935 
ªt
 = -
EIO
;

936 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

937 
addr
 >(
u£r
))

940 
tmp
 = 0;

941 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

942 
tmp
 = 
	`gëªg
(
chûd
, 
addr
);

943 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

944 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

945 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

946 
tmp
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
addr
 / (
d©a
));

948 
ªt
 = 
	`put_u£r
(
tmp
, 
d©≠
);

952 
PTRACE_POKEUSR
:

953 
ªt
 = -
EIO
;

954 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

955 
addr
 >(
u£r
))

958 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

959 
ªt
 = 
	`puåeg
(
chûd
, 
addr
, 
d©a
);

960 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

961 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

962 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

963 
ªt
 = 
	`±ø˚_£t_debugªg
(
chûd
,

964 
addr
 / (
d©a
), data);

968 
PTRACE_GETREGS
:

969  
	`c›y_ªg£t_to_u£r
(
chûd
,

970 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

971 
REGSET_GENERAL
,

972 0, (
u£r_ªgs_°ru˘
),

973 
d©≠
);

975 
PTRACE_SETREGS
:

976  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

977 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

978 
REGSET_GENERAL
,

979 0, (
u£r_ªgs_°ru˘
),

980 
d©≠
);

982 
PTRACE_GETFPREGS
:

983  
	`c›y_ªg£t_to_u£r
(
chûd
,

984 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

985 
REGSET_FP
,

986 0, (
u£r_i387_°ru˘
),

987 
d©≠
);

989 
PTRACE_SETFPREGS
:

990  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

991 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

992 
REGSET_FP
,

993 0, (
u£r_i387_°ru˘
),

994 
d©≠
);

996 #ifde‡
CONFIG_X86_32


997 
PTRACE_GETFPXREGS
:

998  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

999 
REGSET_XFP
,

1000 0, (
u£r_fx§_°ru˘
),

1001 
d©≠
Ë? -
EIO
 : 0;

1003 
PTRACE_SETFPXREGS
:

1004  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1005 
REGSET_XFP
,

1006 0, (
u£r_fx§_°ru˘
),

1007 
d©≠
Ë? -
EIO
 : 0;

1010 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1011 
PTRACE_GET_THREAD_AREA
:

1012 i‡(
addr
 < 0)

1013  -
EIO
;

1014 
ªt
 = 
	`do_gë_thªad_¨ó
(
chûd
, 
addr
,

1015 (
u£r_desc
 
__u£r
 *Ë
d©a
);

1018 
PTRACE_SET_THREAD_AREA
:

1019 i‡(
addr
 < 0)

1020  -
EIO
;

1021 
ªt
 = 
	`do_£t_thªad_¨ó
(
chûd
, 
addr
,

1022 (
u£r_desc
 
__u£r
 *Ë
d©a
, 0);

1026 #ifde‡
CONFIG_X86_64


1030 
PTRACE_ARCH_PRCTL
:

1031 
ªt
 = 
	`do_¨ch_¥˘l
(
chûd
, 
d©a
, 
addr
);

1038 #ifde‡
CONFIG_X86_PTRACE_BTS


1039 
PTRACE_BTS_CONFIG
:

1040 
ªt
 = 
±ø˚_bts_c⁄fig


1041 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1044 
PTRACE_BTS_STATUS
:

1045 
ªt
 = 
±ø˚_bts_°©us


1046 (
chûd
, 
d©a
, (
±ø˚_bts_c⁄fig
 
__u£r
 *)
addr
);

1049 
PTRACE_BTS_SIZE
:

1050 
ªt
 = 
	`±ø˚_bts_size
(
chûd
);

1053 
PTRACE_BTS_GET
:

1054 
ªt
 = 
±ø˚_bts_ªad_ªc‹d


1055 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1058 
PTRACE_BTS_CLEAR
:

1059 
ªt
 = 
	`±ø˚_bts_˛ór
(
chûd
);

1062 
PTRACE_BTS_DRAIN
:

1063 
ªt
 = 
±ø˚_bts_døö


1064 (
chûd
, 
d©a
, (
bts_°ru˘
 
__u£r
 *Ë
addr
);

1069 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1073  
ªt
;

1074 
	}
}

1076 #ifde‡
CONFIG_IA32_EMULATION


1078 
	~<löux/com∑t.h
>

1079 
	~<löux/sysˇŒs.h
>

1080 
	~<asm/ü32.h
>

1081 
	~<asm/u£r32.h
>

1083 
	#R32
(
l
,
q
) \

1084 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1085 
ªgs
->
q
 = 
vÆue
; 

	)

1087 
	#SEG32
(
rs
) \

1088 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1089  
	`£t_£gmít_ªg
(
chûd
, \

1090 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
), \

1091 
vÆue
); \

1092 

	)

1094 
	$puåeg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 
vÆue
)

1096 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1098 
ªgno
) {

1100 
	`SEG32
(
cs
);

1101 
	`SEG32
(
ds
);

1102 
	`SEG32
(
es
);

1103 
	`SEG32
(
fs
);

1104 
	`SEG32
(
gs
);

1105 
	`SEG32
(
ss
);

1107 
	`R32
(
ebx
, 
bx
);

1108 
	`R32
(
ecx
, 
cx
);

1109 
	`R32
(
edx
, 
dx
);

1110 
	`R32
(
edi
, 
di
);

1111 
	`R32
(
esi
, 
si
);

1112 
	`R32
(
ebp
, 
bp
);

1113 
	`R32
(
óx
, 
ax
);

1114 
	`R32
(
eù
, 
ù
);

1115 
	`R32
(
e•
, 
•
);

1117 
	`off£tof
(
u£r32
, 
ªgs
.
‹ig_óx
):

1125 
ªgs
->
‹ig_ax
 = 
vÆue
;

1126 i‡(
	`sysˇŒ_gë_ƒ
(
chûd
, 
ªgs
) >= 0)

1127 
	`èsk_thªad_öfo
(
chûd
)->
°©us
 |
TS_COMPAT
;

1130 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1131  
	`£t_Êags
(
chûd
, 
vÆue
);

1133 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1134 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1135 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1136  
	`±ø˚_£t_debugªg
(
chûd
, 
ªgno
 / 4, 
vÆue
);

1139 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1140  -
EIO
;

1149 
	}
}

1151 #unde‡
R32


1152 #unde‡
SEG32


1154 
	#R32
(
l
,
q
) \

1155 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1156 *
vÆ
 = 
ªgs
->
q
; 

	)

1158 
	#SEG32
(
rs
) \

1159 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1160 *
vÆ
 = 
	`gë_£gmít_ªg
(
chûd
, \

1161 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
)); \

1162 

	)

1164 
	$gëªg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 *
vÆ
)

1166 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1168 
ªgno
) {

1170 
	`SEG32
(
ds
);

1171 
	`SEG32
(
es
);

1172 
	`SEG32
(
fs
);

1173 
	`SEG32
(
gs
);

1175 
	`R32
(
cs
, cs);

1176 
	`R32
(
ss
, ss);

1177 
	`R32
(
ebx
, 
bx
);

1178 
	`R32
(
ecx
, 
cx
);

1179 
	`R32
(
edx
, 
dx
);

1180 
	`R32
(
edi
, 
di
);

1181 
	`R32
(
esi
, 
si
);

1182 
	`R32
(
ebp
, 
bp
);

1183 
	`R32
(
óx
, 
ax
);

1184 
	`R32
(
‹ig_óx
, 
‹ig_ax
);

1185 
	`R32
(
eù
, 
ù
);

1186 
	`R32
(
e•
, 
•
);

1188 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1189 *
vÆ
 = 
	`gë_Êags
(
chûd
);

1192 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1193 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1194 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1195 *
vÆ
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
ªgno
 / 4);

1199 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1200  -
EIO
;

1206 *
vÆ
 = 0;

1210 
	}
}

1212 #unde‡
R32


1213 #unde‡
SEG32


1215 
	$gíªgs32_gë
(
èsk_°ru˘
 *
èrgë
,

1216 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1217 
pos
, 
cou¡
,

1218 *
kbuf
, 
__u£r
 *
ubuf
)

1220 i‡(
kbuf
) {

1221 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1222 
cou¡
 > 0) {

1223 
	`gëªg32
(
èrgë
, 
pos
, 
k
++);

1224 
cou¡
 -(*
k
);

1225 
pos
 +(*
k
);

1228 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1229 
cou¡
 > 0) {

1230 
com∑t_ul⁄g_t
 
w‹d
;

1231 
	`gëªg32
(
èrgë
, 
pos
, &
w‹d
);

1232 i‡(
	`__put_u£r
(
w‹d
, 
u
++))

1233  -
EFAULT
;

1234 
cou¡
 -(*
u
);

1235 
pos
 +(*
u
);

1240 
	}
}

1242 
	$gíªgs32_£t
(
èsk_°ru˘
 *
èrgë
,

1243 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1244 
pos
, 
cou¡
,

1245 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

1247 
ªt
 = 0;

1248 i‡(
kbuf
) {

1249 c⁄° 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1250 
cou¡
 > 0 && !
ªt
) {

1251 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, *
k
++);

1252 
cou¡
 -(*
k
);

1253 
pos
 +(*
k
);

1256 c⁄° 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1257 
cou¡
 > 0 && !
ªt
) {

1258 
com∑t_ul⁄g_t
 
w‹d
;

1259 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

1260 i‡(
ªt
)

1262 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, 
w‹d
);

1263 
cou¡
 -(*
u
);

1264 
pos
 +(*
u
);

1267  
ªt
;

1268 
	}
}

1270 
	$com∑t_¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
com∑t_l⁄g_t
 
ªque°
,

1271 
com∑t_ul⁄g_t
 
ˇddr
, com∑t_ul⁄g_à
cd©a
)

1273 
addr
 = 
ˇddr
;

1274 
d©a
 = 
cd©a
;

1275 
__u£r
 *
d©≠
 = 
	`com∑t_±r
(
d©a
);

1276 
ªt
;

1277 
__u32
 
vÆ
;

1279 
ªque°
) {

1280 
PTRACE_PEEKUSR
:

1281 
ªt
 = 
	`gëªg32
(
chûd
, 
addr
, &
vÆ
);

1282 i‡(
ªt
 == 0)

1283 
ªt
 = 
	`put_u£r
(
vÆ
, (
__u32
 
__u£r
 *)
d©≠
);

1286 
PTRACE_POKEUSR
:

1287 
ªt
 = 
	`puåeg32
(
chûd
, 
addr
, 
d©a
);

1290 
PTRACE_GETREGS
:

1291  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1292 
REGSET_GENERAL
,

1293 0, (
u£r_ªgs_°ru˘32
),

1294 
d©≠
);

1296 
PTRACE_SETREGS
:

1297  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1298 
REGSET_GENERAL
, 0,

1299 (
u£r_ªgs_°ru˘32
),

1300 
d©≠
);

1302 
PTRACE_GETFPREGS
:

1303  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1304 
REGSET_FP
, 0,

1305 (
u£r_i387_ü32_°ru˘
),

1306 
d©≠
);

1308 
PTRACE_SETFPREGS
:

1309  
	`c›y_ªg£t_‰om_u£r
(

1310 
chûd
, &
u£r_x86_32_võw
, 
REGSET_FP
,

1311 0, (
u£r_i387_ü32_°ru˘
), 
d©≠
);

1313 
PTRACE_GETFPXREGS
:

1314  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1315 
REGSET_XFP
, 0,

1316 (
u£r32_fx§_°ru˘
),

1317 
d©≠
);

1319 
PTRACE_SETFPXREGS
:

1320  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1321 
REGSET_XFP
, 0,

1322 (
u£r32_fx§_°ru˘
),

1323 
d©≠
);

1325 
PTRACE_GET_THREAD_AREA
:

1326 
PTRACE_SET_THREAD_AREA
:

1327 #ifde‡
CONFIG_X86_PTRACE_BTS


1328 
PTRACE_BTS_CONFIG
:

1329 
PTRACE_BTS_STATUS
:

1330 
PTRACE_BTS_SIZE
:

1331 
PTRACE_BTS_GET
:

1332 
PTRACE_BTS_CLEAR
:

1333 
PTRACE_BTS_DRAIN
:

1335  
	`¨ch_±ø˚
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1338  
	`com∑t_±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1341  
ªt
;

1342 
	}
}

1346 #ifde‡
CONFIG_X86_64


1348 c⁄° 
u£r_ªg£t
 
	gx86_64_ªg£ts
[] = {

1349 [
REGSET_GENERAL
] = {

1350 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1351 .
	gn
 = (
u£r_ªgs_°ru˘
) / (),

1352 .
	gsize
 = (), .
	gÆign
 = (),

1353 .
	ggë
 = 
gíªgs_gë
, .
	g£t
 = 
gíªgs_£t


1355 [
REGSET_FP
] = {

1356 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1357 .
	gn
 = (
u£r_i387_°ru˘
) / (),

1358 .
	gsize
 = (), .
	gÆign
 = (),

1359 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1361 [
REGSET_IOPERM64
] = {

1362 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1363 .
	gn
 = 
IO_BITMAP_LONGS
,

1364 .
	gsize
 = (), .
	gÆign
 = (),

1365 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1369 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_64_võw
 = {

1370 .
«me
 = "x86_64", .
	ge_machöe
 = 
EM_X86_64
,

1371 .
	gªg£ts
 = 
x86_64_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1376 
	#u£r_ªgs_°ru˘32
 
u£r_ªgs_°ru˘


	)

1377 
	#gíªgs32_gë
 
gíªgs_gë


	)

1378 
	#gíªgs32_£t
 
gíªgs_£t


	)

1380 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

1381 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

1385 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1386 c⁄° 
u£r_ªg£t
 
	gx86_32_ªg£ts
[] = {

1387 [
REGSET_GENERAL
] = {

1388 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1389 .
	gn
 = (
u£r_ªgs_°ru˘32
Ë/ (
u32
),

1390 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1391 .
	ggë
 = 
gíªgs32_gë
, .
	g£t
 = 
gíªgs32_£t


1393 [
REGSET_FP
] = {

1394 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1395 .
	gn
 = (
u£r_i387_ü32_°ru˘
Ë/ (
u32
),

1396 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1397 .
	ga˘ive
 = 
Âªgs_a˘ive
, .
	ggë
 = 
Âªgs_gë
, .
	g£t
 = 
Âªgs_£t


1399 [
REGSET_XFP
] = {

1400 .
c‹e_nŸe_ty≥
 = 
NT_PRXFPREG
,

1401 .
	gn
 = (
u£r32_fx§_°ru˘
Ë/ (
u32
),

1402 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1403 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1405 [
REGSET_TLS
] = {

1406 .
c‹e_nŸe_ty≥
 = 
NT_386_TLS
,

1407 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbüs
 = 
GDT_ENTRY_TLS_MIN
,

1408 .
	gsize
 = (
u£r_desc
),

1409 .
	gÆign
 = (
u£r_desc
),

1410 .
	ga˘ive
 = 
ªg£t_és_a˘ive
,

1411 .
	ggë
 = 
ªg£t_és_gë
, .
	g£t
 = 
ªg£t_és_£t


1413 [
REGSET_IOPERM32
] = {

1414 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1415 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1416 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1417 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1421 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
 = {

1422 .
«me
 = "i386", .
	ge_machöe
 = 
EM_386
,

1423 .
	gªg£ts
 = 
x86_32_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1427 c⁄° 
u£r_ªg£t_võw
 *
	$èsk_u£r_ªg£t_võw
(
èsk_°ru˘
 *
èsk
)

1429 #ifde‡
CONFIG_IA32_EMULATION


1430 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

1432 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1433  &
u£r_x86_32_võw
;

1435 #ifde‡
CONFIG_X86_64


1436  &
u£r_x86_64_võw
;

1438 
	}
}

1440 
	$£nd_sigå≠
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
,

1441 
îr‹_code
, 
si_code
)

1443 
sigöfo
 
öfo
;

1445 
tsk
->
thªad
.
å≠_no
 = 1;

1446 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

1448 
	`mem£t
(&
öfo
, 0, (info));

1449 
öfo
.
si_signo
 = 
SIGTRAP
;

1450 
öfo
.
si_code
 = si_code;

1453 
öfo
.
si_addr
 = 
	`u£r_mode_vm
(
ªgs
Ë? (
__u£r
 *Ëªgs->
ù
 : 
NULL
;

1456 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

1457 
	}
}

1460 #ifde‡
CONFIG_X86_32


1461 
	#IS_IA32
 1

	)

1462 #ñi‡
deföed
 
CONFIG_IA32_EMULATION


1463 
	#IS_IA32
 
	`is_com∑t_èsk
()

	)

1465 
	#IS_IA32
 0

	)

1472 
asmªg∑rm
 
	$sysˇŒ_åa˚_íãr
(
±_ªgs
 *
ªgs
)

1474 
ªt
 = 0;

1483 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
))

1484 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

1487 
	`£cuª_computög
(
ªgs
->
‹ig_ax
);

1489 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1490 
ªt
 = -1L;

1492 i‡((
ªt
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
)) &&

1493 
	`åa˚hook_ªp‹t_sysˇŒ_íåy
(
ªgs
))

1494 
ªt
 = -1L;

1496 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1497 
	`åa˚_sys_íãr
(
ªgs
,Ñegs->
‹ig_ax
);

1499 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
)) {

1500 i‡(
IS_IA32
)

1501 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_I386
,

1502 
ªgs
->
‹ig_ax
,

1503 
ªgs
->
bx
,Ñegs->
cx
,

1504 
ªgs
->
dx
,Ñegs->
si
);

1505 #ifde‡
CONFIG_X86_64


1507 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_X86_64
,

1508 
ªgs
->
‹ig_ax
,

1509 
ªgs
->
di
,Ñegs->
si
,

1510 
ªgs
->
dx
,Ñegs->
r10
);

1514  
ªt
 ?: 
ªgs
->
‹ig_ax
;

1515 
	}
}

1517 
asmªg∑rm
 
	$sysˇŒ_åa˚_Àave
(
±_ªgs
 *
ªgs
)

1519 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
))

1520 
	`audô_sysˇŒ_exô
(
	`AUDITSC_RESULT
(
ªgs
->
ax
),Ñegs->ax);

1522 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1523 
	`åa˚_sys_exô
(
ªgs
,Ñegs->
ax
);

1525 i‡(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

1526 
	`åa˚hook_ªp‹t_sysˇŒ_exô
(
ªgs
, 0);

1534 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1541 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
) &&

1542 
	`åa˚hook_c⁄sidî_Áèl_sig«l
(
cuºít
, 
SIGTRAP
))

1543 
	`£nd_sigå≠
(
cuºít
, 
ªgs
, 0, 
TRAP_BRKPT
);

1544 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<löux/pci.h
>

5 
	~<löux/úq.h
>

7 
	~<asm/h≥t.h
>

9 #i‡
deföed
(
CONFIG_X86_IO_APIC
Ë&& deföed(
CONFIG_SMP
Ë&& deföed(
CONFIG_PCI
)

11 
__devöô
 
	$quúk_öãl_úqbÆ™˚
(
pci_dev
 *
dev
)

13 
u8
 
c⁄fig
, 
ªv
;

14 
u16
 
w‹d
;

21 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

22 i‡(
ªv
 > 0x9)

26 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xf4, &
c⁄fig
);

27 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
|0x2);

33 
	`pci_bus_ªad_c⁄fig_w‹d
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
w‹d
);

35 i‡(!(
w‹d
 & (1 << 13))) {

36 
	`dev_öfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noúqdebug_£tup
("");

39 #ifde‡
CONFIG_PROC_FS


40 
no_úq_afföôy
 = 1;

45 i‡(!(
c⁄fig
 & 0x2))

46 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quúk_öãl_úqbÆ™˚
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quúk_öãl_úqbÆ™˚
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quúk_öãl_úqbÆ™˚
);

56 #i‡
deföed
(
CONFIG_HPET_TIMER
)

57 
	gf‹˚_h≥t_addªss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gf‹˚_h≥t_ªsume_ty≥
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_f‹˚_h≥t_ªsume
()

72 
u32
 
vÆ
;

74 i‡(!
f‹˚_h≥t_addªss
)

77 
	`BUG_ON
(
rcba_ba£
 =
NULL
);

80 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

81 i‡(!(
vÆ
 & 0x80)) {

83 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

87 i‡(!(
vÆ
 & 0x80))

88 
	`BUG
();

90 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

93 
	}
}

95 
	$ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

97 
u32
 
vÆ
;

98 
u32
 
	`unöôülized_v¨
(
rcba
);

99 
îr
 = 0;

101 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

104 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 i‡(
rcba
 == 0) {

107 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`i‹em≠_noˇche
(
rcba
, 0x4000);

114 i‡(
rcba_ba£
 =
NULL
) {

115 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

123 i‡(
vÆ
 & 0x80) {

125 
vÆ
 = val & 0x3;

126 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

127 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

128 "0x%lx\n", 
f‹˚_h≥t_addªss
);

129 
	`iounm≠
(
rcba_ba£
);

134 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

137 i‡(!(
vÆ
 & 0x80)) {

138 
îr
 = 1;

140 
vÆ
 = val & 0x3;

141 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

144 i‡(
îr
) {

145 
f‹˚_h≥t_addªss
 = 0;

146 
	`iounm≠
(
rcba_ba£
);

147 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev,

150 
f‹˚_h≥t_ªsume_ty≥
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

152 "0x%lx\n", 
f‹˚_h≥t_addªss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_f‹˚_íabÀ_h≥t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_f‹˚_íabÀ_h≥t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_f‹˚_íabÀ_h≥t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_f‹˚_íabÀ_h≥t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_f‹˚_íabÀ_h≥t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_f‹˚_íabÀ_h≥t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_f‹˚_íabÀ_h≥t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_f‹˚_íabÀ_h≥t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_f‹˚_íabÀ_h≥t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_f‹˚_íabÀ_h≥t
);

177 
pci_dev
 *
	gˇched_dev
;

179 
	$h≥t_¥öt_f‹˚_öfo
()

181 
	`¥ötk
(
KERN_INFO
 "HPETÇotÉnabled in BIOS. "

183 
	}
}

185 
	$ﬁd_ich_f‹˚_h≥t_ªsume
()

187 
u32
 
vÆ
;

188 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

190 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

193 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

194 
gí_˙é
 &= (~(0x7 << 15));

195 
gí_˙é
 |= (0x4 << 15);

197 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, 
gí_˙é
);

198 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

199 
vÆ
 = 
gí_˙é
 >> 15;

200 
vÆ
 &= 0x7;

201 i‡(
vÆ
 == 0x4)

202 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

204 
	`BUG
();

205 
	}
}

207 
	$ﬁd_ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

209 
u32
 
vÆ
;

210 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

212 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

215 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

220 
vÆ
 = 
gí_˙é
 >> 15;

221 
vÆ
 &= 0x7;

222 i‡(
vÆ
 & 0x4) {

223 
vÆ
 &= 0x3;

224 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

225 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

226 
f‹˚_h≥t_addªss
);

234 
gí_˙é
 &= (~(0x7 << 15));

235 
gí_˙é
 |= (0x4 << 15);

236 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0xD0, 
gí_˙é
);

238 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

240 
vÆ
 = 
gí_˙é
 >> 15;

241 
vÆ
 &= 0x7;

242 i‡(
vÆ
 & 0x4) {

244 
vÆ
 &= 0x3;

245 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

246 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

247 "0x%lx\n", 
f‹˚_h≥t_addªss
);

248 
ˇched_dev
 = 
dev
;

249 
f‹˚_h≥t_ªsume_ty≥
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

254 
	}
}

260 
	$ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
(
pci_dev
 *
dev
)

262 i‡(
h≥t_f‹˚_u£r
)

263 
	`ﬁd_ich_f‹˚_íabÀ_h≥t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

282 
	$vt8237_f‹˚_h≥t_ªsume
()

284 
u32
 
vÆ
;

286 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

289 
vÆ
 = 0xfed00000 | 0x80;

290 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, 
vÆ
);

292 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, &
vÆ
);

293 i‡(
vÆ
 & 0x80)

294 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

301 
u32
 
	`unöôülized_v¨
(
vÆ
);

303 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

306 i‡(!
h≥t_f‹˚_u£r
) {

307 
	`h≥t_¥öt_f‹˚_öfo
();

311 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

316 i‡(
vÆ
 & 0x80) {

317 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

318 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

319 
f‹˚_h≥t_addªss
);

327 
vÆ
 = 0xfed00000 | 0x80;

328 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x68, 
vÆ
);

330 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

331 i‡(
vÆ
 & 0x80) {

332 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

333 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

334 "0x%lx\n", 
f‹˚_h≥t_addªss
);

335 
ˇched_dev
 = 
dev
;

336 
f‹˚_h≥t_ªsume_ty≥
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_f‹˚_íabÀ_h≥t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_f‹˚_íabÀ_h≥t
);

348 
	$©i_f‹˚_h≥t_ªsume
()

350 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x14, 0xfed00000);

351 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_ªv
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xac, 
b
);

362 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x70, 
d
);

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
vÆ
;

374 
u8
 
b
;

376 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

379 i‡(!
h≥t_f‹˚_u£r
) {

380 
	`h≥t_¥öt_f‹˚_öfo
();

384 
d
 = 
	`©i_ixp4x0_ªv
(
dev
);

385 i‡(
d
 < 0x82)

389 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x14, 0xfed00000);

390 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x14, &
vÆ
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

397 i‡(!(
b
 & 0x1))

399 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x64, 
d
);

402 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

403 i‡(!(
d
 & (1<<10)))

406 
f‹˚_h≥t_addªss
 = 
vÆ
;

407 
f‹˚_h≥t_ªsume_ty≥
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

409 
f‹˚_h≥t_addªss
);

410 
ˇched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_f‹˚_íabÀ_h≥t
);

418 
	$nvidü_f‹˚_h≥t_ªsume
()

420 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x44, 0xfed00001);

421 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

422 
	}
}

424 
	$nvidü_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

426 
u32
 
	`unöôülized_v¨
(
vÆ
);

428 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

431 i‡(!
h≥t_f‹˚_u£r
) {

432 
	`h≥t_¥öt_f‹˚_öfo
();

436 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x44, 0xfed00001);

437 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x44, &
vÆ
);

438 
f‹˚_h≥t_addªss
 = 
vÆ
 & 0xfffffffe;

439 
f‹˚_h≥t_ªsume_ty≥
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

441 
f‹˚_h≥t_addªss
);

442 
ˇched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidü_f‹˚_íabÀ_h≥t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidü_f‹˚_íabÀ_h≥t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidü_f‹˚_íabÀ_h≥t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidü_f‹˚_íabÀ_h≥t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidü_f‹˚_íabÀ_h≥t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidü_f‹˚_íabÀ_h≥t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidü_f‹˚_íabÀ_h≥t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidü_f‹˚_íabÀ_h≥t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidü_f‹˚_íabÀ_h≥t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidü_f‹˚_íabÀ_h≥t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidü_f‹˚_íabÀ_h≥t
);

472 
	$f‹˚_h≥t_ªsume
()

474 
f‹˚_h≥t_ªsume_ty≥
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_f‹˚_h≥t_ªsume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`ﬁd_ich_f‹˚_h≥t_ªsume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_f‹˚_h≥t_ªsume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidü_f‹˚_h≥t_ªsume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_f‹˚_h≥t_ªsume
();

493 
	}
}

496 #i‡
deföed
(
CONFIG_PCI
Ë&& deföed(
CONFIG_NUMA
)

498 
__öô
 
	$quúk_amd_nb_node
(
pci_dev
 *
dev
)

500 
pci_dev
 *
nb_ht
;

501 
dev‚
;

502 
u32
 
vÆ
;

504 
dev‚
 = 
	`PCI_DEVFN
(
	`PCI_SLOT
(
dev
->devfn), 0);

505 
nb_ht
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, 
dev‚
);

506 i‡(!
nb_ht
)

509 
	`pci_ªad_c⁄fig_dw‹d
(
nb_ht
, 0x60, &
vÆ
);

510 
	`£t_dev_node
(&
dev
->dev, 
vÆ
 & 7);

511 
	`pci_dev_put
(
nb_ht
);

512 
	}
}

514 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

515 
quúk_amd_nb_node
);

516 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
,

517 
quúk_amd_nb_node
);

518 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
,

519 
quúk_amd_nb_node
);

520 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
,

521 
quúk_amd_nb_node
);

522 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_HT
,

523 
quúk_amd_nb_node
);

524 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MAP
,

525 
quúk_amd_nb_node
);

526 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_DRAM
,

527 
quúk_amd_nb_node
);

528 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
,

529 
quúk_amd_nb_node
);

530 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_LINK
,

531 
quúk_amd_nb_node
);

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ªboŸ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/pm.h
>

5 
	~<löux/efi.h
>

6 
	~<löux/dmi.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/tboŸ.h
>

9 
	~<a˝i/ªboŸ.h
>

10 
	~<asm/io.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/h≥t.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/ªboŸ_fixups.h
>

17 
	~<asm/ªboŸ.h
>

18 
	~<asm/pci_x86.h
>

19 
	~<asm/vúãxt.h
>

20 
	~<asm/˝u.h
>

22 #ifde‡
CONFIG_X86_32


23 
	~<löux/˘y≥.h
>

24 
	~<löux/mc146818πc.h
>

26 
	~<asm/iommu.h
>

32 (*
pm_powî_off
)();

33 
	`EXPORT_SYMBOL
(
pm_powî_off
);

35 c⁄° 
desc_±r
 
no_idt
 = {
	}
};

36 
	gªboŸ_mode
;

37 
ªboŸ_ty≥
 
	gªboŸ_ty≥
 = 
BOOT_KBD
;

38 
	gªboŸ_f‹˚
;

40 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_SMP
)

41 
	gªboŸ_˝u
 = -1;

48 
	gªboŸ_emîgícy
;

51 
boﬁ
 
	gp‹t_cf9_ß„
 = 
Ál£
;

65 
__öô
 
	$ªboŸ_£tup
(*
°r
)

68 *
°r
) {

70 
ªboŸ_mode
 = 0x1234;

74 
ªboŸ_mode
 = 0;

77 #ifde‡
CONFIG_X86_32


78 #ifde‡
CONFIG_SMP


80 i‡(
	`isdigô
(*(
°r
+1))) {

81 
ªboŸ_˝u
 = (Ë(*(
°r
+1) - '0');

82 i‡(
	`isdigô
(*(
°r
+2)))

83 
ªboŸ_˝u
 =ÑeboŸ_˝u*10 + ()(*(
°r
+2) - '0');

98 
ªboŸ_ty≥
 = *
°r
;

102 
ªboŸ_f‹˚
 = 1;

106 
°r
 = 
	`°rchr
(str, ',');

107 i‡(
°r
)

108 
°r
++;

113 
	}
}

115 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

118 #ifde‡
CONFIG_X86_32


128 
__öô
 
	$£t_bios_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

130 i‡(
ªboŸ_ty≥
 !
BOOT_BIOS
) {

131 
ªboŸ_ty≥
 = 
BOOT_BIOS
;

132 
	`¥ötk
(
KERN_INFO
 "%†£rõ†bﬂrd dëe˘ed. Sñe˘ög BIOS-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

135 
	}
}

137 
dmi_sy°em_id
 
__öôd©a
 
	gªboŸ_dmi_èbÀ
[] = {

139 .
ˇŒback
 = 
£t_bios_ªboŸ
,

140 .
	gidít
 = "Dell E520",

141 .
	gm©ches
 = {

142 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

143 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

147 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

148 .
	gidít
 = "Dell PowerEdge 1300",

149 .
	gm©ches
 = {

150 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

151 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

155 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

156 .
	gidít
 = "Dell PowerEdge 300",

157 .
	gm©ches
 = {

158 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

159 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

163 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

164 .
	gidít
 = "Dell OptiPlex 745",

165 .
	gm©ches
 = {

166 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

167 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

171 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

172 .
	gidít
 = "Dell OptiPlex 745",

173 .
	gm©ches
 = {

174 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

175 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

176 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

180 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

181 .
	gidít
 = "Dell OptiPlex 745",

182 .
	gm©ches
 = {

183 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

184 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

185 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

189 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

190 .
	gidít
 = "Dell OptiPlex 330",

191 .
	gm©ches
 = {

192 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

193 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

194 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

198 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

199 .
	gidít
 = "Dell OptiPlex 360",

200 .
	gm©ches
 = {

201 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

202 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 360"),

203 
DMI_MATCH
(
DMI_BOARD_NAME
, "0T656F"),

207 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

208 .
	gidít
 = "Dell PowerEdge 2400",

209 .
	gm©ches
 = {

210 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

211 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

215 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

216 .
	gidít
 = "Dell Precision T5400",

217 .
	gm©ches
 = {

218 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

219 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

223 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

224 .
	gidít
 = "HP Compaq Laptop",

225 .
	gm©ches
 = {

226 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

227 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

231 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

232 .
	gidít
 = "Dell XPS710",

233 .
	gm©ches
 = {

234 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

235 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

239 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

240 .
	gidít
 = "Dell DXP061",

241 .
	gm©ches
 = {

242 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

243 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

247 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

248 .
	gidít
 = "Sony VGN-Z540N",

249 .
	gm©ches
 = {

250 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

251 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

255 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

256 .
	gidít
 = "CompuLab SBC-FITPC2",

257 .
	gm©ches
 = {

258 
DMI_MATCH
(
DMI_SYS_VENDOR
, "CompuLab"),

259 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "SBC-FITPC2"),

265 
__öô
 
	$ªboŸ_öô
()

267 
	`dmi_check_sy°em
(
ªboŸ_dmi_èbÀ
);

269 
	}
}

270 
c‹e_öôˇŒ
(
ªboŸ_öô
);

279 
	gªÆ_mode_gdt_íåõs
 [3] =

286 c⁄° 
desc_±r


287 
	gªÆ_mode_gdt
 = {  (
ªÆ_mode_gdt_íåõs
) - 1, ()real_mode_gdt_entries },

288 
	gªÆ_mode_idt
 = { 0x3ff, 0 };

308 c⁄° 
	gªÆ_mode_swôch
 [] =

322 c⁄° 
	gjump_to_bios
 [] =

332 
	$machöe_ªÆ_ª°¨t
(c⁄° *
code
, 
Àngth
)

334 
	`loˇl_úq_dißbÀ
();

345 
	`•ö_lock
(&
πc_lock
);

346 
	`CMOS_WRITE
(0x00, 0x8f);

347 
	`•ö_u∆ock
(&
πc_lock
);

352 
	`mem˝y
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

353 (
sw≠≥r_pg_dú
 [0]Ë* 
KERNEL_PGD_PTRS
);

358 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

365 *((*)0x472Ë
ªboŸ_mode
;

372 
	`mem˝y
((*)(0x1000 - (
ªÆ_mode_swôch
) - 100),

373 
ªÆ_mode_swôch
,  (real_mode_switch));

374 
	`mem˝y
((*)(0x1000 - 100), 
code
, 
Àngth
);

377 
	`lﬂd_idt
(&
ªÆ_mode_idt
);

382 
	`lﬂd_gdt
(&
ªÆ_mode_gdt
);

389 
__asm__
 
	`__vﬁ©ûe__
 ("movl $0x0010,%%eax\n"

399 
__asm__
 
	`__vﬁ©ûe__
 ("ljmp $0x0008,%0"

401 : "i" ((*)(0x1000 -  (
ªÆ_mode_swôch
) - 100)));

402 
	}
}

403 #ifde‡
CONFIG_APM_MODULE


404 
EXPORT_SYMBOL
(
machöe_ªÆ_ª°¨t
);

412 
__öô
 
	$£t_pci_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

414 i‡(
ªboŸ_ty≥
 !
BOOT_CF9
) {

415 
ªboŸ_ty≥
 = 
BOOT_CF9
;

416 
	`¥ötk
(
KERN_INFO
 "%s series board detected. "

417 "Sñe˘ög PCI-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

420 
	}
}

422 
dmi_sy°em_id
 
__öôd©a
 
	gpci_ªboŸ_dmi_èbÀ
[] = {

424 .
ˇŒback
 = 
£t_pci_ªboŸ
,

425 .
	gidít
 = "Apple MacBook5",

426 .
	gm©ches
 = {

427 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

428 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBook5"),

432 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

433 .
	gidít
 = "Apple MacBookPro5",

434 .
	gm©ches
 = {

435 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

436 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBookPro5"),

440 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

441 .
	gidít
 = "Apple Macmini3,1",

442 .
	gm©ches
 = {

443 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

444 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Macmini3,1"),

450 
__öô
 
	$pci_ªboŸ_öô
()

452 
	`dmi_check_sy°em
(
pci_ªboŸ_dmi_èbÀ
);

454 
	}
}

455 
c‹e_öôˇŒ
(
pci_ªboŸ_öô
);

457 
ölöe
 
	$kb_waô
()

459 
i
;

461 
i
 = 0; i < 0x10000; i++) {

462 i‡((
	`öb
(0x64) & 0x02) == 0)

464 
	`udñay
(2);

466 
	}
}

468 
	$vmxoff_nmi
(
˝u
, 
dõ_¨gs
 *
¨gs
)

470 
	`˝u_emîgícy_vmxoff
();

471 
	}
}

475 
	$emîgícy_vmx_dißbÀ_Æl
()

478 
	`loˇl_úq_dißbÀ
();

498 i‡(
	`˝u_has_vmx
(Ë&& 
	`˝u_vmx_íabÀd
()) {

501 
	`˝u_vmxoff
();

504 
	`nmi_shoŸdown_˝us
(
vmxoff_nmi
);

507 
	}
}

510 
__©åibuã__
((
wók
)Ë
	$mach_ªboŸ_fixups
()

512 
	}
}

514 
	$«tive_machöe_emîgícy_ª°¨t
()

516 
i
;

518 i‡(
ªboŸ_emîgícy
)

519 
	`emîgícy_vmx_dißbÀ_Æl
();

521 
	`tboŸ_shutdown
(
TB_SHUTDOWN_REBOOT
);

524 *((*)
	`__va
(0x472)Ë
ªboŸ_mode
;

528 
ªboŸ_ty≥
) {

529 
BOOT_KBD
:

530 
	`mach_ªboŸ_fixups
();

532 
i
 = 0; i < 10; i++) {

533 
	`kb_waô
();

534 
	`udñay
(50);

535 
	`outb
(0xfe, 0x64);

536 
	`udñay
(50);

539 
BOOT_TRIPLE
:

540 
	`lﬂd_idt
(&
no_idt
);

541 
__asm__
 
	`__vﬁ©ûe__
("int3");

543 
ªboŸ_ty≥
 = 
BOOT_KBD
;

546 #ifde‡
CONFIG_X86_32


547 
BOOT_BIOS
:

548 
	`machöe_ªÆ_ª°¨t
(
jump_to_bios
, (jump_to_bios));

550 
ªboŸ_ty≥
 = 
BOOT_KBD
;

554 
BOOT_ACPI
:

555 
	`a˝i_ªboŸ
();

556 
ªboŸ_ty≥
 = 
BOOT_KBD
;

559 
BOOT_EFI
:

560 i‡(
efi_íabÀd
)

561 
efi
.
	`ª£t_sy°em
(
ªboŸ_mode
 ?

562 
EFI_RESET_WARM
 :

563 
EFI_RESET_COLD
,

564 
EFI_SUCCESS
, 0, 
NULL
);

565 
ªboŸ_ty≥
 = 
BOOT_KBD
;

568 
BOOT_CF9
:

569 
p‹t_cf9_ß„
 = 
åue
;

572 
BOOT_CF9_COND
:

573 i‡(
p‹t_cf9_ß„
) {

574 
u8
 
cf9
 = 
	`öb
(0xcf9) & ~6;

575 
	`outb
(
cf9
|2, 0xcf9);

576 
	`udñay
(50);

577 
	`outb
(
cf9
|6, 0xcf9);

578 
	`udñay
(50);

580 
ªboŸ_ty≥
 = 
BOOT_KBD
;

584 
	}
}

586 
	$«tive_machöe_shutdown
()

589 #ifde‡
CONFIG_SMP


592 
ªboŸ_˝u_id
 = 0;

594 #ifde‡
CONFIG_X86_32


596 i‡((
ªboŸ_˝u
 !-1Ë&& (ªboŸ_˝u < 
ƒ_˝u_ids
) &&

597 
	`˝u_⁄löe
(
ªboŸ_˝u
))

598 
ªboŸ_˝u_id
 = 
ªboŸ_˝u
;

602 i‡(!
	`˝u_⁄löe
(
ªboŸ_˝u_id
))

603 
ªboŸ_˝u_id
 = 
	`smp_¥o˚ss‹_id
();

606 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
ªboŸ_˝u_id
));

611 
	`smp_£nd_°›
();

614 
	`œpic_shutdown
();

616 #ifde‡
CONFIG_X86_IO_APIC


617 
	`dißbÀ_IO_APIC
();

620 #ifde‡
CONFIG_HPET_TIMER


621 
	`h≥t_dißbÀ
();

624 #ifde‡
CONFIG_X86_64


625 
	`pci_iommu_shutdown
();

627 
	}
}

629 
	$__machöe_emîgícy_ª°¨t
(
emîgícy
)

631 
ªboŸ_emîgícy
 = 
emîgícy
;

632 
machöe_›s
.
	`emîgícy_ª°¨t
();

633 
	}
}

635 
	$«tive_machöe_ª°¨t
(*
__unu£d
)

637 
	`¥ötk
("machineÑestart\n");

639 i‡(!
ªboŸ_f‹˚
)

640 
	`machöe_shutdown
();

641 
	`__machöe_emîgícy_ª°¨t
(0);

642 
	}
}

644 
	$«tive_machöe_hÆt
()

647 
	`machöe_shutdown
();

649 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

652 
	`°›_this_˝u
(
NULL
);

653 
	}
}

655 
	$«tive_machöe_powî_off
()

657 i‡(
pm_powî_off
) {

658 i‡(!
ªboŸ_f‹˚
)

659 
	`machöe_shutdown
();

660 
	`pm_powî_off
();

663 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

664 
	}
}

666 
machöe_›s
 
	gmachöe_›s
 = {

667 .
powî_off
 = 
«tive_machöe_powî_off
,

668 .
	gshutdown
 = 
«tive_machöe_shutdown
,

669 .
	gemîgícy_ª°¨t
 = 
«tive_machöe_emîgícy_ª°¨t
,

670 .
	gª°¨t
 = 
«tive_machöe_ª°¨t
,

671 .
	ghÆt
 = 
«tive_machöe_hÆt
,

672 #ifde‡
CONFIG_KEXEC


673 .
	g¸ash_shutdown
 = 
«tive_machöe_¸ash_shutdown
,

677 
	$machöe_powî_off
()

679 
machöe_›s
.
	`powî_off
();

680 
	}
}

682 
	$machöe_shutdown
()

684 
machöe_›s
.
	`shutdown
();

685 
	}
}

687 
	$machöe_emîgícy_ª°¨t
()

689 
	`__machöe_emîgícy_ª°¨t
(1);

690 
	}
}

692 
	$machöe_ª°¨t
(*
cmd
)

694 
machöe_›s
.
	`ª°¨t
(
cmd
);

695 
	}
}

697 
	$machöe_hÆt
()

699 
machöe_›s
.
	`hÆt
();

700 
	}
}

702 #ifde‡
CONFIG_KEXEC


703 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

705 
machöe_›s
.
	`¸ash_shutdown
(
ªgs
);

706 
	}
}

710 #i‡
deföed
(
CONFIG_SMP
)

713 
	g¸ashög_˝u
;

714 
nmi_shoŸdown_cb
 
	gshoŸdown_ˇŒback
;

716 
©omic_t
 
	gwaôög_f‹_¸ash_ùi
;

718 
	$¸ash_nmi_ˇŒback
(
nŸifõr_block
 *
£lf
,

719 
vÆ
, *
d©a
)

721 
˝u
;

723 i‡(
vÆ
 !
DIE_NMI_IPI
)

724  
NOTIFY_OK
;

726 
˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

732 i‡(
˝u
 =
¸ashög_˝u
)

733  
NOTIFY_STOP
;

734 
	`loˇl_úq_dißbÀ
();

736 
	`shoŸdown_ˇŒback
(
˝u
, (
dõ_¨gs
 *)
d©a
);

738 
	`©omic_dec
(&
waôög_f‹_¸ash_ùi
);

740 
	`hÆt
();

742 
	`˝u_ªœx
();

745 
	}
}

747 
	$smp_£nd_nmi_Ælbut£lf
()

749 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
NMI_VECTOR
);

750 
	}
}

752 
nŸifõr_block
 
	g¸ash_nmi_nb
 = {

753 .
nŸifõr_ˇŒ
 = 
¸ash_nmi_ˇŒback
,

762 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

764 
m£cs
;

765 
	`loˇl_úq_dißbÀ
();

768 
¸ashög_˝u
 = 
	`ß„_smp_¥o˚ss‹_id
();

770 
shoŸdown_ˇŒback
 = 
ˇŒback
;

772 
	`©omic_£t
(&
waôög_f‹_¸ash_ùi
, 
	`num_⁄löe_˝us
() - 1);

774 i‡(
	`ªgi°î_dõ_nŸifõr
(&
¸ash_nmi_nb
))

779 
	`wmb
();

781 
	`smp_£nd_nmi_Ælbut£lf
();

783 
m£cs
 = 1000;

784 (
	`©omic_ªad
(&
waôög_f‹_¸ash_ùi
Ë> 0Ë&& 
m£cs
) {

785 
	`mdñay
(1);

786 
m£cs
--;

790 
	}
}

792 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

795 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<löux/∂©f‹m_devi˚.h
>

5 
	~<löux/mc146818πc.h
>

6 
	~<löux/a˝i.h
>

7 
	~<löux/bcd.h
>

8 
	~<löux/≤p.h
>

10 
	~<asm/vsysˇŒ.h
>

11 
	~<asm/x86_öô.h
>

12 
	~<asm/time.h
>

14 #ifde‡
CONFIG_X86_32


20 vﬁ©ûê
	gcmos_lock
;

21 
EXPORT_SYMBOL
(
cmos_lock
);

25 
	#CMOS_YEARS_OFFS
 2000

	)

27 
DEFINE_SPINLOCK
(
πc_lock
);

28 
EXPORT_SYMBOL
(
πc_lock
);

40 
	$mach_£t_πc_mmss
(
nowtime
)

42 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

43 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

44 
ªtvÆ
 = 0;

47 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

48 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

51 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

52 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

54 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

55 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

56 
cmos_möuãs
 = 
	`bcd2bö
(cmos_minutes);

64 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

65 
ªÆ_möuãs
 = 
nowtime
 / 60;

67 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

68 
ªÆ_möuãs
 += 30;

69 
ªÆ_möuãs
 %= 60;

71 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

72 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

73 
ªÆ_£c⁄ds
 = 
	`bö2bcd
(real_seconds);

74 
ªÆ_möuãs
 = 
	`bö2bcd
(real_minutes);

76 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
, 
RTC_SECONDS
);

77 
	`CMOS_WRITE
(
ªÆ_möuãs
, 
RTC_MINUTES
);

79 
	`¥ötk
(
KERN_WARNING


81 
cmos_möuãs
, 
ªÆ_möuãs
);

82 
ªtvÆ
 = -1;

92 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

93 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

95  
ªtvÆ
;

96 
	}
}

98 
	$mach_gë_cmos_time
()

100 
°©us
, 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
˚¡ury
 = 0;

108 (
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
))

109 
	`˝u_ªœx
();

111 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

112 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

113 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

114 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

115 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

116 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

118 #ifde‡
CONFIG_ACPI


119 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

120 
a˝i_gbl_FADT
.
˚¡ury
)

121 
˚¡ury
 = 
	`CMOS_READ
(
a˝i_gbl_FADT
.century);

124 
°©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

125 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
°©us
 & 
RTC_DM_BINARY
));

127 i‡(
RTC_ALWAYS_BCD
 || !(
°©us
 & 
RTC_DM_BINARY
)) {

128 
£c
 = 
	`bcd2bö
(sec);

129 
mö
 = 
	`bcd2bö
(min);

130 
hour
 = 
	`bcd2bö
(hour);

131 
day
 = 
	`bcd2bö
(day);

132 
m⁄
 = 
	`bcd2bö
(mon);

133 
yór
 = 
	`bcd2bö
(year);

136 i‡(
˚¡ury
) {

137 
˚¡ury
 = 
	`bcd2bö
(century);

138 
yór
 +
˚¡ury
 * 100;

139 
	`¥ötk
(
KERN_INFO
 "Exãnded CMOS yór: %d\n", 
˚¡ury
 * 100);

141 
yór
 +
CMOS_YEARS_OFFS
;

143  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

144 
	}
}

147 
	$πc_cmos_ªad
(
addr
)

149 
vÆ
;

151 
	`lock_cmos_¥efix
(
addr
);

152 
	`outb
(
addr
, 
	`RTC_PORT
(0));

153 
vÆ
 = 
	`öb
(
	`RTC_PORT
(1));

154 
	`lock_cmos_suffix
(
addr
);

156  
vÆ
;

157 
	}
}

158 
EXPORT_SYMBOL
(
πc_cmos_ªad
);

160 
	$πc_cmos_wrôe
(
vÆ
, 
addr
)

162 
	`lock_cmos_¥efix
(
addr
);

163 
	`outb
(
addr
, 
	`RTC_PORT
(0));

164 
	`outb
(
vÆ
, 
	`RTC_PORT
(1));

165 
	`lock_cmos_suffix
(
addr
);

166 
	}
}

167 
EXPORT_SYMBOL
(
πc_cmos_wrôe
);

169 
	$upd©e_≥rsi°ít_˛ock
(
time•ec
 
now
)

171 
Êags
;

172 
ªtvÆ
;

174 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

175 
ªtvÆ
 = 
x86_∂©f‹m
.
	`£t_wÆl˛ock
(
now
.
tv_£c
);

176 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

178  
ªtvÆ
;

179 
	}
}

182 
	$ªad_≥rsi°ít_˛ock
(
time•ec
 *
ts
)

184 
ªtvÆ
, 
Êags
;

186 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

187 
ªtvÆ
 = 
x86_∂©f‹m
.
	`gë_wÆl˛ock
();

188 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

190 
ts
->
tv_£c
 = 
ªtvÆ
;

191 
ts
->
tv_n£c
 = 0;

192 
	}
}

194 
	$«tive_ªad_tsc
()

196  
	`__«tive_ªad_tsc
();

197 
	}
}

198 
EXPORT_SYMBOL
(
«tive_ªad_tsc
);

201 
ªsour˚
 
	gπc_ªsour˚s
[] = {

203 .
°¨t
 = 
RTC_PORT
(0),

204 .
	gíd
 = 
RTC_PORT
(1),

205 .
	gÊags
 = 
IORESOURCE_IO
,

208 .
°¨t
 = 
RTC_IRQ
,

209 .
	gíd
 = 
RTC_IRQ
,

210 .
	gÊags
 = 
IORESOURCE_IRQ
,

214 
∂©f‹m_devi˚
 
	gπc_devi˚
 = {

215 .
«me
 = "rtc_cmos",

216 .
	gid
 = -1,

217 .
	gªsour˚
 = 
πc_ªsour˚s
,

218 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

221 
__öô
 
	$add_πc_cmos
()

223 #ifde‡
CONFIG_PNP


224 c⁄° *
ids
[] 
__öôc⁄°
 =

226 
≤p_dev
 *
dev
;

227 
≤p_id
 *
id
;

228 
i
;

230 
	`≤p_f‹_óch_dev
(
dev
) {

231 
id
 = 
dev
->id; id; id = id->
√xt
) {

232 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

233 i‡(
	`com∑ª_≤p_id
(
id
, 
ids
[
i
]) != 0)

240 
	`∂©f‹m_devi˚_ªgi°î
(&
πc_devi˚
);

241 
	`dev_öfo
(&
πc_devi˚
.
dev
,

245 
	}
}

246 
devi˚_öôˇŒ
(
add_πc_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<löux/sched.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/mmz⁄e.h
>

27 
	~<löux/s¸ìn_öfo.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/a˝i.h
>

30 
	~<löux/sfi.h
>

31 
	~<löux/≠m_bios.h
>

32 
	~<löux/öôrd.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/c⁄sﬁe.h
>

36 
	~<löux/mˇ.h
>

37 
	~<löux/roŸ_dev.h
>

38 
	~<löux/highmem.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/efi.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/edd.h
>

43 
	~<löux/iscsi_ib·.h
>

44 
	~<löux/nodemask.h
>

45 
	~<löux/kexec.h
>

46 
	~<löux/dmi.h
>

47 
	~<löux/p‚.h
>

48 
	~<löux/pci.h
>

49 
	~<asm/pci-dúe˘.h
>

50 
	~<löux/öô_ohci1394_dma.h
>

51 
	~<löux/kvm_∑ø.h
>

53 
	~<löux/î∫o.h
>

54 
	~<löux/kî√l.h
>

55 
	~<löux/°ddef.h
>

56 
	~<löux/uni°d.h
>

57 
	~<löux/±ø˚.h
>

58 
	~<löux/¶ab.h
>

59 
	~<löux/u£r.h
>

60 
	~<löux/dñay.h
>

62 
	~<löux/kÆlsyms.h
>

63 
	~<löux/˝u‰eq.h
>

64 
	~<löux/dma-m≠pög.h
>

65 
	~<löux/˘y≥.h
>

66 
	~<löux/uac˚ss.h
>

68 
	~<löux/≥r˝u.h
>

69 
	~<löux/¸ash_dump.h
>

70 
	~<löux/tboŸ.h
>

72 
	~<video/edid.h
>

74 
	~<asm/mår.h
>

75 
	~<asm/≠ic.h
>

76 
	~<asm/e820.h
>

77 
	~<asm/mp•ec.h
>

78 
	~<asm/£tup.h
>

79 
	~<asm/efi.h
>

80 
	~<asm/timî.h
>

81 
	~<asm/i8259.h
>

82 
	~<asm/£˘i⁄s.h
>

83 
	~<asm/dmi.h
>

84 
	~<asm/io_≠ic.h
>

85 
	~<asm/i°.h
>

86 
	~<asm/vmi.h
>

87 
	~<asm/£tup_¨ch.h
>

88 
	~<asm/bios_ebda.h
>

89 
	~<asm/ˇcheÊush.h
>

90 
	~<asm/¥o˚ss‹.h
>

91 
	~<asm/bugs.h
>

93 
	~<asm/sy°em.h
>

94 
	~<asm/vsysˇŒ.h
>

95 
	~<asm/˝u.h
>

96 
	~<asm/desc.h
>

97 
	~<asm/dma.h
>

98 
	~<asm/iommu.h
>

99 
	~<asm/g¨t.h
>

100 
	~<asm/mmu_c⁄ãxt.h
>

101 
	~<asm/¥Ÿo.h
>

103 
	~<asm/∑øvút.h
>

104 
	~<asm/hy≥rvis‹.h
>

106 
	~<asm/≥r˝u.h
>

107 
	~<asm/t›ﬁogy.h
>

108 
	~<asm/≠icdef.h
>

109 #ifde‡
CONFIG_X86_64


110 
	~<asm/numa_64.h
>

118 
	gmax_low_p‚_m≠≥d
;

119 
	gmax_p‚_m≠≥d
;

121 
RESERVE_BRK
(
dmi_Æloc
, 65536);

123 
boŸ_˝u_id
 
	g__ªad_mo°ly
;

125 
__öôd©a
 
	g_brk_°¨t
 = ()
__brk_ba£
;

126 
	g_brk_íd
 = ()
__brk_ba£
;

128 #ifde‡
CONFIG_X86_64


129 
	$deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
)

131  
	`__deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
);

132 
	}
}

134 
	$deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
)

136  
	`__deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
);

137 
	}
}

140 #i‚de‡
CONFIG_DEBUG_BOOT_PARAMS


141 
boŸ_∑øms
 
__öôd©a
 
	gboŸ_∑øms
;

143 
boŸ_∑øms
 
	gboŸ_∑øms
;

149 
ªsour˚
 
	gd©a_ªsour˚
 = {

150 .
«me
 = "Kernel data",

151 .
	g°¨t
 = 0,

152 .
	gíd
 = 0,

153 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


156 
ªsour˚
 
	gcode_ªsour˚
 = {

157 .
«me
 = "Kernel code",

158 .
	g°¨t
 = 0,

159 .
	gíd
 = 0,

160 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


163 
ªsour˚
 
	gbss_ªsour˚
 = {

164 .
«me
 = "Kernel bss",

165 .
	g°¨t
 = 0,

166 .
	gíd
 = 0,

167 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


171 #ifde‡
CONFIG_X86_32


173 
˝uöfo_x86
 
√w_˝u_d©a
 
	g__˝uöôd©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

175 
˝uöfo_x86
 
boŸ_˝u_d©a
 
	g__ªad_mo°ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

176 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

177 
	$£t_mˇ_bus
(
x
)

179 #ifde‡
CONFIG_MCA


180 
MCA_bus
 = 
x
;

182 
	}
}

184 
	gdef_to_bigsmp
;

187 
	gmachöe_id
;

188 
	gmachöe_submodñ_id
;

189 
	gBIOS_ªvisi⁄
;

191 
≠m_öfo
 
	g≠m_öfo
;

192 
EXPORT_SYMBOL
(
≠m_öfo
);

194 #i‡
deföed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

195 
	$deföed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

196 
i°_öfo
 ist_info;

197 
	`EXPORT_SYMBOL
(
i°_öfo
);

199 
i°_öfo
 ist_info;

203 
˝uöfo_x86
 
boŸ_˝u_d©a
 
__ªad_mo°ly
 = {

204 .
x86_phys_bôs
 = 
MAX_PHYSMEM_BITS
,

205 
	}
};

206 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

210 #i‡!
deföed
(
CONFIG_X86_PAE
Ë|| deföed(
CONFIG_X86_64
)

211 
	gmmu_¸4_„©uªs
;

213 
	gmmu_¸4_„©uªs
 = 
X86_CR4_PAE
;

217 
	gboŸlﬂdî_ty≥
, 
	gboŸlﬂdî_vîsi⁄
;

222 
s¸ìn_öfo
 
	gs¸ìn_öfo
;

223 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

224 
edid_öfo
 
	gedid_öfo
;

225 
EXPORT_SYMBOL_GPL
(
edid_öfo
);

227 
roŸ_mou¡Êags
;

229 
	gßved_video_mode
;

231 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

232 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

233 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

235 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

236 #ifde‡
CONFIG_CMDLINE_BOOL


237 
__öôd©a
 
	gbuûtö_cmdlöe
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

240 #i‡
deföed
(
CONFIG_EDD
Ë|| deföed(
CONFIG_EDD_MODULE
)

241 
edd
 
	gedd
;

242 #ifde‡
CONFIG_EDD_MODULE


243 
EXPORT_SYMBOL
(
edd
);

250 
ölöe
 
	$c›y_edd
()

252 
	`mem˝y
(
edd
.
mbr_sig«tuª
, 
boŸ_∑øms
.
edd_mbr_sig_buf„r
,

253 (
edd
.
mbr_sig«tuª
));

254 
	`mem˝y
(
edd
.
edd_öfo
, 
boŸ_∑øms
.
eddbuf
, (edd.edd_info));

255 
edd
.
mbr_sig«tuª_ƒ
 = 
boŸ_∑øms
.
edd_mbr_sig_buf_íåõs
;

256 
edd
.
edd_öfo_ƒ
 = 
boŸ_∑øms
.
eddbuf_íåõs
;

257 
	}
}

259 
ölöe
 
	$c›y_edd
()

261 
	}
}

264 * 
__öô
 
	$exãnd_brk
(
size_t
 
size
, size_à
Æign
)

266 
size_t
 
mask
 = 
Æign
 - 1;

267 *
ªt
;

269 
	`BUG_ON
(
_brk_°¨t
 == 0);

270 
	`BUG_ON
(
Æign
 & 
mask
);

272 
_brk_íd
 = (_brk_íd + 
mask
) & ~mask;

273 
	`BUG_ON
((*)(
_brk_íd
 + 
size
Ë> 
__brk_limô
);

275 
ªt
 = (*)
_brk_íd
;

276 
_brk_íd
 +
size
;

278 
	`mem£t
(
ªt
, 0, 
size
);

280  
ªt
;

281 
	}
}

283 #ifde‡
CONFIG_X86_64


284 
__öô
 
	$öô_gb∑ges
()

286 i‡(
dúe˘_gb∑ges
 && 
˝u_has_gb∑ges
)

287 
	`¥ötk
(
KERN_INFO
 "Using GBÖages for direct mapping\n");

289 
dúe˘_gb∑ges
 = 0;

290 
	}
}

292 
ölöe
 
	$öô_gb∑ges
()

294 
	}
}

297 
__öô
 
	$ª£rve_brk
()

299 i‡(
_brk_íd
 > 
_brk_°¨t
)

300 
	`ª£rve_óæy
(
	`__∑
(
_brk_°¨t
), __∑(
_brk_íd
), "BRK");

304 
_brk_°¨t
 = 0;

305 
	}
}

307 #ifde‡
CONFIG_BLK_DEV_INITRD


309 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

310 
__öô
 
	$ªloˇã_öôrd
()

313 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

314 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

315 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

316 
u64
 
ømdisk_hîe
;

317 
¶›
, 
˛í
, 
m≠addr
;

318 *
p
, *
q
;

321 
ømdisk_hîe
 = 
	`föd_e820_¨ó
(0, 
íd_of_lowmem
, 
ømdisk_size
,

322 
PAGE_SIZE
);

324 i‡(
ømdisk_hîe
 == -1ULL)

325 
	`∑nic
("Cannot findÖlace forÇew RAMDISK of size %lld\n",

326 
ømdisk_size
);

330 
	`ª£rve_óæy
(
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
,

332 
öôrd_°¨t
 = 
ømdisk_hîe
 + 
PAGE_OFFSET
;

333 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

334 
	`¥ötk
(
KERN_INFO
 "AllocatedÇew RAMDISK: %08llx - %08llx\n",

335 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
);

337 
q
 = (*)
öôrd_°¨t
;

340 i‡(
ømdisk_image
 < 
íd_of_lowmem
) {

341 
˛í
 = 
íd_of_lowmem
 - 
ømdisk_image
;

342 
p
 = (*)
	`__va
(
ømdisk_image
);

343 
	`mem˝y
(
q
, 
p
, 
˛í
);

344 
q
 +
˛í
;

345 
ømdisk_image
 +
˛í
;

346 
ømdisk_size
 -
˛í
;

350 
ømdisk_size
) {

351 
¶›
 = 
ømdisk_image
 & ~
PAGE_MASK
;

352 
˛í
 = 
ømdisk_size
;

353 i‡(
˛í
 > 
MAX_MAP_CHUNK
-
¶›
)

354 
˛í
 = 
MAX_MAP_CHUNK
-
¶›
;

355 
m≠addr
 = 
ømdisk_image
 & 
PAGE_MASK
;

356 
p
 = 
	`óæy_memªm≠
(
m≠addr
, 
˛í
+
¶›
);

357 
	`mem˝y
(
q
, 
p
+
¶›
, 
˛í
);

358 
	`óæy_iounm≠
(
p
, 
˛í
+
¶›
);

359 
q
 +
˛í
;

360 
ømdisk_image
 +
˛í
;

361 
ømdisk_size
 -
˛í
;

364 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

365 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

366 
	`¥ötk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxÅo"

368 
ømdisk_image
,Ñamdisk_imagê+ 
ømdisk_size
 - 1,

369 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
 - 1);

370 
	}
}

372 
__öô
 
	$ª£rve_öôrd
()

374 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

375 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

376 
u64
 
ømdisk_íd
 = 
ømdisk_image
 + 
ømdisk_size
;

377 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

379 i‡(!
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 ||

380 !
ømdisk_image
 || !
ømdisk_size
)

383 
öôrd_°¨t
 = 0;

385 i‡(
ømdisk_size
 >(
íd_of_lowmem
>>1)) {

386 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

387 
	`¥ötk
(
KERN_ERR
 "initrdÅooÜargeÅo handle, "

392 
	`¥ötk
(
KERN_INFO
 "RAMDISK: %08Œx - %08Œx\n", 
ømdisk_image
,

393 
ømdisk_íd
);

396 i‡(
ømdisk_íd
 <
íd_of_lowmem
) {

402 
öôrd_°¨t
 = 
ømdisk_image
 + 
PAGE_OFFSET
;

403 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

407 
	`ªloˇã_öôrd
();

409 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

410 
	}
}

412 
__öô
 
	$ª£rve_öôrd
()

414 
	}
}

417 
__öô
 
	$∑r£_£tup_d©a
()

419 
£tup_d©a
 *
d©a
;

420 
u64
 
∑_d©a
;

422 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

424 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

425 
∑_d©a
) {

426 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, 
PAGE_SIZE
);

427 
d©a
->
ty≥
) {

428 
SETUP_E820_EXT
:

429 
	`∑r£_e820_ext
(
d©a
, 
∑_d©a
);

434 
∑_d©a
 = 
d©a
->
√xt
;

435 
	`óæy_iounm≠
(
d©a
, 
PAGE_SIZE
);

437 
	}
}

439 
__öô
 
	$e820_ª£rve_£tup_d©a
()

441 
£tup_d©a
 *
d©a
;

442 
u64
 
∑_d©a
;

443 
found
 = 0;

445 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

447 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

448 
∑_d©a
) {

449 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

450 
	`e820_upd©e_ønge
(
∑_d©a
, (*
d©a
)+d©a->
Àn
,

451 
E820_RAM
, 
E820_RESERVED_KERN
);

452 
found
 = 1;

453 
∑_d©a
 = 
d©a
->
√xt
;

454 
	`óæy_iounm≠
(
d©a
, (*data));

456 i‡(!
found
)

459 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

460 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

461 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

462 
	`e820_¥öt_m≠
("reserve setup_data");

463 
	}
}

465 
__öô
 
	$ª£rve_óæy_£tup_d©a
()

467 
£tup_d©a
 *
d©a
;

468 
u64
 
∑_d©a
;

469 
buf
[32];

471 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

473 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

474 
∑_d©a
) {

475 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

476 
	`•rötf
(
buf
, "£tu∞d©®%x", 
d©a
->
ty≥
);

477 
	`ª£rve_óæy
(
∑_d©a
,Öa_d©a+(*
d©a
)+d©a->
Àn
, 
buf
);

478 
∑_d©a
 = 
d©a
->
√xt
;

479 
	`óæy_iounm≠
(
d©a
, (*data));

481 
	}
}

487 #ifde‡
CONFIG_KEXEC


496 
__öô
 
	$föd_™d_ª£rve_¸ashkî√l
(
size
)

498 c⁄° 
Æignmít
 = 16<<20;

499 
°¨t
 = 0LL;

502 
ªt
;

504 
°¨t
 = 
	`föd_e820_¨ó
(°¨t, 
ULONG_MAX
, 
size
, 
Æignmít
);

505 i‡(
°¨t
 == -1ULL)

506  
°¨t
;

509 
ªt
 = 
	`ª£rve_boŸmem_gíîic
(
°¨t
, 
size
, 
BOOTMEM_EXCLUSIVE
);

510 i‡(
ªt
 >= 0)

511  
°¨t
;

513 
°¨t
 +
Æignmít
;

515 
	}
}

517 
ölöe
 
	$gë_tŸÆ_mem
()

519 
tŸÆ
;

521 
tŸÆ
 = 
max_low_p‚
 - 
mö_low_p‚
;

522 #ifde‡
CONFIG_HIGHMEM


523 
tŸÆ
 +
highíd_p‚
 - 
high°¨t_p‚
;

526  
tŸÆ
 << 
PAGE_SHIFT
;

527 
	}
}

529 
__öô
 
	$ª£rve_¸ashkî√l
()

531 
tŸÆ_mem
;

532 
¸ash_size
, 
¸ash_ba£
;

533 
ªt
;

535 
tŸÆ_mem
 = 
	`gë_tŸÆ_mem
();

537 
ªt
 = 
	`∑r£_¸ashkî√l
(
boŸ_comm™d_löe
, 
tŸÆ_mem
,

538 &
¸ash_size
, &
¸ash_ba£
);

539 i‡(
ªt
 !0 || 
¸ash_size
 <= 0)

543 i‡(
¸ash_ba£
 <= 0) {

544 
¸ash_ba£
 = 
	`föd_™d_ª£rve_¸ashkî√l
(
¸ash_size
);

545 i‡(
¸ash_ba£
 == -1ULL) {

546 
	`¥_öfo
("crashkernelÑeservation failed. "

551 
ªt
 = 
	`ª£rve_boŸmem_gíîic
(
¸ash_ba£
, 
¸ash_size
,

552 
BOOTMEM_EXCLUSIVE
);

553 i‡(
ªt
 < 0) {

554 
	`¥_öfo
("crashkernelÑeservation failed - "

560 
	`¥ötk
(
KERN_INFO
 "Reserving %ldMB of memoryát %ldMB "

562 ()(
¸ash_size
 >> 20),

563 ()(
¸ash_ba£
 >> 20),

564 ()(
tŸÆ_mem
 >> 20));

566 
¸ashk_ªs
.
°¨t
 = 
¸ash_ba£
;

567 
¸ashk_ªs
.
íd
 = 
¸ash_ba£
 + 
¸ash_size
 - 1;

568 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
¸ashk_ªs
);

569 
	}
}

571 
__öô
 
	$ª£rve_¸ashkî√l
()

573 
	}
}

576 
ªsour˚
 
	g°™d¨d_io_ªsour˚s
[] = {

577 { .
«me
 = "dma1", .
	g°¨t
 = 0x00, .
	gíd
 = 0x1f,

578 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

579 { .
	g«me
 = "pic1", .
	g°¨t
 = 0x20, .
	gíd
 = 0x21,

580 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

581 { .
	g«me
 = "timî0", .
	g°¨t
 = 0x40, .
	gíd
 = 0x43,

582 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

583 { .
	g«me
 = "timî1", .
	g°¨t
 = 0x50, .
	gíd
 = 0x53,

584 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

585 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x60, .
	gíd
 = 0x60,

586 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

587 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x64, .
	gíd
 = 0x64,

588 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

589 { .
	g«me
 = "dm®∑gêªg", .
	g°¨t
 = 0x80, .
	gíd
 = 0x8f,

590 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

591 { .
	g«me
 = "pic2", .
	g°¨t
 = 0xa0, .
	gíd
 = 0xa1,

592 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

593 { .
	g«me
 = "dma2", .
	g°¨t
 = 0xc0, .
	gíd
 = 0xdf,

594 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

595 { .
	g«me
 = "Âu", .
	g°¨t
 = 0xf0, .
	gíd
 = 0xff,

596 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

599 
__öô
 
	$ª£rve_°™d¨d_io_ªsour˚s
()

601 
i
;

604 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); i++)

605 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
°™d¨d_io_ªsour˚s
[
i
]);

607 
	}
}

615 #ifde‡
CONFIG_CRASH_DUMP


620 
__öô
 
	$£tup_ñfc‹ehdr
(*
¨g
)

622 *
íd
;

623 i‡(!
¨g
)

624  -
EINVAL
;

625 
ñfc‹ehdr_addr
 = 
	`mem∑r£
(
¨g
, &
íd
);

626  
íd
 > 
¨g
 ? 0 : -
EINVAL
;

627 
	}
}

628 
óæy_∑øm
("ñfc‹ehdr", 
£tup_ñfc‹ehdr
);

631 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


632 
__öô
 
	$dmi_low_mem‹y_c‹ru±i⁄
(c⁄° 
dmi_sy°em_id
 *
d
)

634 
	`¥ötk
(
KERN_NOTICE


636 
d
->
idít
);

638 
	`e820_upd©e_ønge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

639 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

642 
	}
}

646 
dmi_sy°em_id
 
__öôd©a
 
	gbad_bios_dmi_èbÀ
[] = {

647 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


649 .
ˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

650 .
	gidít
 = "AMI BIOS",

651 .
	gm©ches
 = {

652 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

656 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

657 .
	gidít
 = "Phoenix BIOS",

658 .
	gm©ches
 = {

659 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

663 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

664 .
	gidít
 = "Phoenix/MSC BIOS",

665 .
	gm©ches
 = {

666 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix/MSC"),

676 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

677 .
	gidít
 = "AMI BIOS",

678 .
	gm©ches
 = {

679 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45ID"),

699 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

701 #ifde‡
CONFIG_X86_32


702 
	`mem˝y
(&
boŸ_˝u_d©a
, &
√w_˝u_d©a
, (new_cpu_data));

703 
	`visws_óæy_dëe˘
();

705 
	`¥ötk
(
KERN_INFO
 "Comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

709 
	`vmi_öô
();

711 
	`óæy_˝u_öô
();

712 
	`óæy_i‹em≠_öô
();

714 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
boŸ_∑øms
.
hdr
.
roŸ_dev
);

715 
s¸ìn_öfo
 = 
boŸ_∑øms
.screen_info;

716 
edid_öfo
 = 
boŸ_∑øms
.edid_info;

717 #ifde‡
CONFIG_X86_32


718 
≠m_öfo
.
bios
 = 
boŸ_∑øms
.
≠m_bios_öfo
;

719 
i°_öfo
 = 
boŸ_∑øms
.ist_info;

720 i‡(
boŸ_∑øms
.
sys_desc_èbÀ
.
Àngth
 != 0) {

721 
	`£t_mˇ_bus
(
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[3] & 0x2);

722 
machöe_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[0];

723 
machöe_submodñ_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[1];

724 
BIOS_ªvisi⁄
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[2];

727 
ßved_video_mode
 = 
boŸ_∑øms
.
hdr
.
vid_mode
;

728 
boŸlﬂdî_ty≥
 = 
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
;

729 i‡((
boŸlﬂdî_ty≥
 >> 4) == 0xe) {

730 
boŸlﬂdî_ty≥
 &= 0xf;

731 
boŸlﬂdî_ty≥
 |(
boŸ_∑øms
.
hdr
.
ext_lﬂdî_ty≥
+0x10) << 4;

733 
boŸlﬂdî_vîsi⁄
 = 
boŸlﬂdî_ty≥
 & 0xf;

734 
boŸlﬂdî_vîsi⁄
 |
boŸ_∑øms
.
hdr
.
ext_lﬂdî_vî
 << 4;

736 #ifde‡
CONFIG_BLK_DEV_RAM


737 
rd_image_°¨t
 = 
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_IMAGE_START_MASK
;

738 
rd_¥om±
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

739 
rd_dﬁﬂd
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

741 #ifde‡
CONFIG_EFI


742 i‡(!
	`°∫cmp
((*)&
boŸ_∑øms
.
efi_öfo
.
efi_lﬂdî_sig«tuª
,

743 #ifde‡
CONFIG_X86_32


749 
efi_íabÀd
 = 1;

750 
	`efi_ª£rve_óæy
();

754 
x86_öô
.
€m
.
	`¨ch_£tup
();

756 
	`£tup_mem‹y_m≠
();

757 
	`∑r£_£tup_d©a
();

759 
	`e820_ª£rve_£tup_d©a
();

761 
	`c›y_edd
();

763 i‡(!
boŸ_∑øms
.
hdr
.
roŸ_Êags
)

764 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

765 
öô_mm
.
°¨t_code
 = (Ë
_ãxt
;

766 
öô_mm
.
íd_code
 = (Ë
_ëext
;

767 
öô_mm
.
íd_d©a
 = (Ë
_ed©a
;

768 
öô_mm
.
brk
 = 
_brk_íd
;

770 
code_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ãxt
);

771 
code_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ëext
)-1;

772 
d©a_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ëext
);

773 
d©a_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ed©a
)-1;

774 
bss_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(&
__bss_°¨t
);

775 
bss_ªsour˚
.
íd
 = 
	`vút_to_phys
(&
__bss_°›
)-1;

777 #ifde‡
CONFIG_CMDLINE_BOOL


778 #ifde‡
CONFIG_CMDLINE_OVERRIDE


779 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

781 i‡(
buûtö_cmdlöe
[0]) {

783 
	`°æˇt
(
buûtö_cmdlöe
, " ", 
COMMAND_LINE_SIZE
);

784 
	`°æˇt
(
buûtö_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

785 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

790 
	`°æ˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

791 *
cmdlöe_p
 = 
comm™d_löe
;

793 #ifde‡
CONFIG_X86_64


800 
	`check_e„r
();

803 
	`∑r£_óæy_∑øm
();

805 #ifde‡
CONFIG_X86_64


806 
	`check_e„r
();

810 
	`vmi_a˘iv©e
();

813 
	`ª£rve_óæy_£tup_d©a
();

815 i‡(
	`a˝i_mps_check
()) {

816 #ifde‡
CONFIG_X86_LOCAL_APIC


817 
dißbÀ_≠ic
 = 1;

819 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

822 #ifde‡
CONFIG_PCI


823 i‡(
pci_óæy_dump_ªgs
)

824 
	`óæy_dump_pci_devi˚s
();

827 
	`föish_e820_∑rsög
();

829 i‡(
efi_íabÀd
)

830 
	`efi_öô
();

832 
	`dmi_sˇn_machöe
();

834 
	`dmi_check_sy°em
(
bad_bios_dmi_èbÀ
);

840 
	`öô_hy≥rvis‹_∂©f‹m
();

842 
x86_öô
.
ªsour˚s
.
	`¥obe_roms
();

845 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
code_ªsour˚
);

846 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
d©a_ªsour˚
);

847 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
bss_ªsour˚
);

850 #ifde‡
CONFIG_X86_32


851 i‡(
	`µro_wôh_øm_bug
()) {

852 
	`e820_upd©e_ønge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

853 
E820_RESERVED
);

854 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

855 
	`¥ötk
(
KERN_INFO
 "fixedÖhysical RAM map:\n");

856 
	`e820_¥öt_m≠
("bad_ppro");

859 
	`óæy_g¨t_iommu_check
();

866 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

869 
	`óæy_ª£rve_e820_mpc_√w
();

871 
	`mår_bp_öô
();

872 i‡(
	`mår_åim_unˇched_mem‹y
(
max_p‚
))

873 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

875 #ifde‡
CONFIG_X86_32


877 
	`föd_low_p‚_ønge
();

879 
num_phy•ages
 = 
max_p‚
;

881 
	`check_x2≠ic
();

885 i‡(
max_p‚
 > (1UL<<(32 - 
PAGE_SHIFT
)))

886 
max_low_p‚
 = 
	`e820_íd_of_low_øm_p‚
();

888 
max_low_p‚
 = 
max_p‚
;

890 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

891 
max_p‚_m≠≥d
 = 
KERNEL_IMAGE_SIZE
 >> 
PAGE_SHIFT
;

894 #ifde‡
CONFIG_X86_CHECK_BIOS_CORRUPTION


895 
	`£tup_bios_c‹ru±i⁄_check
();

898 
	`¥ötk
(
KERN_DEBUG
 "initial memory mapped : 0 - %08lx\n",

899 
max_p‚_m≠≥d
<<
PAGE_SHIFT
);

901 
	`ª£rve_brk
();

903 
	`öô_gb∑ges
();

906 
max_low_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

907 
max_p‚_m≠≥d
 = 
max_low_p‚_m≠≥d
;

909 #ifde‡
CONFIG_X86_64


910 i‡(
max_p‚
 > 
max_low_p‚
) {

911 
max_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(1UL<<32,

912 
max_p‚
<<
PAGE_SHIFT
);

914 
max_low_p‚
 = 
max_p‚
;

922 #ifde‡
CONFIG_PROVIDE_OHCI1394_DMA_INIT


923 i‡(
öô_ohci1394_dma_óæy
)

924 
	`öô_ohci1394_dma_⁄_Æl_c⁄åﬁÀrs
();

927 
	`ª£rve_öôrd
();

929 
	`vsmp_öô
();

931 
	`io_dñay_öô
();

936 
	`a˝i_boŸ_èbÀ_öô
();

938 
	`óæy_a˝i_boŸ_öô
();

940 #ifde‡
CONFIG_ACPI_NUMA


944 
	`a˝i_numa_öô
();

947 
	`öômem_öô
(0, 
max_p‚
);

949 #ifde‡
CONFIG_ACPI_SLEEP


953 
	`a˝i_ª£rve_boŸmem
();

958 
	`föd_smp_c⁄fig
();

960 
	`ª£rve_¸ashkî√l
();

962 #ifde‡
CONFIG_X86_64


968 
	`dma32_ª£rve_boŸmem
();

971 
	`ª£rve_ib·_ªgi⁄
();

973 #ifde‡
CONFIG_KVM_CLOCK


974 
	`kvm˛ock_öô
();

977 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_°¨t
(
sw≠≥r_pg_dú
);

978 
	`∑gög_öô
();

979 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_d⁄e
(
sw≠≥r_pg_dú
);

981 
	`tboŸ_¥obe
();

983 #ifde‡
CONFIG_X86_64


984 
	`m≠_vsysˇŒ
();

987 
	`gíîic_≠ic_¥obe
();

989 
	`óæy_quúks
();

994 
	`a˝i_boŸ_öô
();

996 
	`sfi_öô
();

1001 i‡(
smp_found_c⁄fig
)

1002 
	`gë_smp_c⁄fig
();

1004 
	`¥efûl_possibÀ_m≠
();

1006 #ifde‡
CONFIG_X86_64


1007 
	`öô_˝u_to_node
();

1010 
	`öô_≠ic_m≠pögs
();

1011 
	`iﬂpic_öô_m≠pögs
();

1014 
	`¥obe_ƒ_úqs_gsi
();

1016 
	`kvm_gue°_öô
();

1018 
	`e820_ª£rve_ªsour˚s
();

1019 
	`e820_m¨k_noßve_ªgi⁄s
(
max_low_p‚
);

1021 
x86_öô
.
ªsour˚s
.
	`ª£rve_ªsour˚s
();

1023 
	`e820_£tup_g≠
();

1025 #ifde‡
CONFIG_VT


1026 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

1027 i‡(!
efi_íabÀd
 || (
	`efi_mem_ty≥
(0xa0000Ë!
EFI_CONVENTIONAL_MEMORY
))

1028 
c⁄swôchp
 = &
vga_c⁄
;

1029 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

1030 
c⁄swôchp
 = &
dummy_c⁄
;

1033 
x86_öô
.
€m
.
	`b™√r
();

1034 
	}
}

1036 #ifde‡
CONFIG_X86_32


1038 
ªsour˚
 
	gvideo_øm_ªsour˚
 = {

1039 .
«me
 = "Video RAMárea",

1040 .
	g°¨t
 = 0xa0000,

1041 .
	gíd
 = 0xbffff,

1042 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


1045 
__öô
 
	$i386_ª£rve_ªsour˚s
()

1047 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm_ªsour˚
);

1048 
	`ª£rve_°™d¨d_io_ªsour˚s
();

1049 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/≥r˝u.h
>

6 
	~<löux/kexec.h
>

7 
	~<löux/¸ash_dump.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/t›ﬁogy.h
>

10 
	~<löux/p‚.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/£tup.h
>

14 
	~<asm/mp•ec.h
>

15 
	~<asm/≠icdef.h
>

16 
	~<asm/highmem.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/˝umask.h
>

19 
	~<asm/˝u.h
>

20 
	~<asm/°ack¥Ÿe˘‹.h
>

22 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


23 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

25 
	#DBG
(
x
...)

	)

28 
DEFINE_PER_CPU
(, 
˝u_numbî
);

29 
EXPORT_PER_CPU_SYMBOL
(
˝u_numbî
);

31 #ifde‡
CONFIG_X86_64


32 
	#BOOT_PERCPU_OFFSET
 (()
__≥r_˝u_lﬂd
)

	)

34 
	#BOOT_PERCPU_OFFSET
 0

	)

37 
DEFINE_PER_CPU
(, 
this_˝u_off
Ë
BOOT_PERCPU_OFFSET
;

38 
EXPORT_PER_CPU_SYMBOL
(
this_˝u_off
);

40 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
 = {

41 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

43 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

52 #ifde‡
CONFIG_X86_64


53 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

55 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

58 #ifde‡
CONFIG_X86_32


69 
boﬁ
 
__öô
 
	$p˝u_√ed_numa
()

71 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


72 
pg_d©a_t
 *
œ°
 = 
NULL
;

73 
˝u
;

75 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

76 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

78 i‡(
	`node_⁄löe
(
node
Ë&& 
	`NODE_DATA
(node) &&

79 
œ°
 &&Üa° !
	`NODE_DATA
(
node
))

80  
åue
;

82 
œ°
 = 
	`NODE_DATA
(
node
);

85  
Ál£
;

86 
	}
}

102 * 
__öô
 
	$p˝u_Æloc_boŸmem
(
˝u
, 
size
,

103 
Æign
)

105 c⁄° 
gﬂl
 = 
	`__∑
(
MAX_DMA_ADDRESS
);

106 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


107 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

108 *
±r
;

110 i‡(!
	`node_⁄löe
(
node
Ë|| !
	`NODE_DATA
(node)) {

111 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

112 
	`¥_öfo
("cpu %d hasÇoÇode %d orÇode-local memory\n",

113 
˝u
, 
node
);

114 
	`¥_debug
("per cpu data for cpu%d %lu bytesát %016lx\n",

115 
˝u
, 
size
, 
	`__∑
(
±r
));

117 
±r
 = 
	`__Æloc_boŸmem_node_n›™ic
(
	`NODE_DATA
(
node
),

118 
size
, 
Æign
, 
gﬂl
);

119 
	`¥_debug
("per cpu data for cpu%d %lu bytes onÇode%dát "

120 "%016lx\n", 
˝u
, 
size
, 
node
, 
	`__∑
(
±r
));

122  
±r
;

124  
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

126 
	}
}

131 * 
__öô
 
	$p˝u_fc_Æloc
(
˝u
, 
size_t
 
size
, size_à
Æign
)

133  
	`p˝u_Æloc_boŸmem
(
˝u
, 
size
, 
Æign
);

134 
	}
}

136 
__öô
 
	$p˝u_fc_‰ì
(*
±r
, 
size_t
 
size
)

138 
	`‰ì_boŸmem
(
	`__∑
(
±r
), 
size
);

139 
	}
}

141 
__öô
 
	$p˝u_˝u_di°™˚
(
‰om
, 
to
)

143 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


144 i‡(
	`óæy_˝u_to_node
(
‰om
Ë=óæy_˝u_to_node(
to
))

145  
LOCAL_DISTANCE
;

147  
REMOTE_DISTANCE
;

149  
LOCAL_DISTANCE
;

151 
	}
}

153 
__öô
 
	$p˝up_p›uœã_±e
(
addr
)

155 
	`p›uœã_exåa_±e
(
addr
);

156 
	}
}

158 
ölöe
 
	$£tup_≥r˝u_£gmít
(
˝u
)

160 #ifde‡
CONFIG_X86_32


161 
desc_°ru˘
 
gdt
;

163 
	`∑ck_des¸ùt‹
(&
gdt
, 
	`≥r_˝u_off£t
(
˝u
), 0xFFFFF,

164 0x2 | 
DESCTYPE_S
, 0x8);

165 
gdt
.
s
 = 1;

166 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
),

167 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

169 
	}
}

171 
__öô
 
	$£tup_≥r_˝u_¨ós
()

173 
˝u
;

174 
dñè
;

175 
rc
;

177 
	`¥_öfo
("NR_CPUS:%dÇr_cpumask_bits:%dÇr_cpu_ids:%dÇr_node_ids:%d\n",

178 
NR_CPUS
, 
ƒ_˝umask_bôs
, 
ƒ_˝u_ids
, 
ƒ_node_ids
);

186 #ifde‡
CONFIG_X86_32


187 i‡(
p˝u_cho£n_fc
 =
PCPU_FC_AUTO
 && 
	`p˝u_√ed_numa
())

188 
p˝u_cho£n_fc
 = 
PCPU_FC_PAGE
;

190 
rc
 = -
EINVAL
;

191 i‡(
p˝u_cho£n_fc
 !
PCPU_FC_PAGE
) {

192 c⁄° 
size_t
 
©om_size
 = 
˝u_has_p£
 ? 
PMD_SIZE
 : 
PAGE_SIZE
;

193 c⁄° 
size_t
 
dyn_size
 = 
PERCPU_MODULE_RESERVE
 +

194 
PERCPU_DYNAMIC_RESERVE
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

196 
rc
 = 
	`p˝u_embed_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

197 
dyn_size
, 
©om_size
,

198 
p˝u_˝u_di°™˚
,

199 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
);

200 i‡(
rc
 < 0)

201 
	`¥_w¨nög
("PERCPU: %sállocator failed (%d), "

203 
p˝u_fc_«mes
[
p˝u_cho£n_fc
], 
rc
);

205 i‡(
rc
 < 0)

206 
rc
 = 
	`p˝u_∑ge_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

207 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
,

208 
p˝up_p›uœã_±e
);

209 i‡(
rc
 < 0)

210 
	`∑nic
("ˇ¬Ÿ inôülizê≥r˝uáª®”º=%d)", 
rc
);

213 
dñè
 = ()
p˝u_ba£_addr
 - ()
__≥r_˝u_°¨t
;

214 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

215 
	`≥r_˝u_off£t
(
˝u
Ë
dñè
 + 
p˝u_unô_off£ts
[cpu];

216 
	`≥r_˝u
(
this_˝u_off
, 
˝u
Ë
	`≥r_˝u_off£t
(cpu);

217 
	`≥r_˝u
(
˝u_numbî
, 
˝u
) = cpu;

218 
	`£tup_≥r˝u_£gmít
(
˝u
);

219 
	`£tup_°ack_ˇ«ry_£gmít
(
˝u
);

227 #ifde‡
CONFIG_X86_LOCAL_APIC


228 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) =

229 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_≠icid
, 
˝u
);

230 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
) =

231 
	`óæy_≥r_˝u_m≠
(
x86_bios_˝u_≠icid
, 
˝u
);

233 #ifde‡
CONFIG_X86_64


234 
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
) =

235 
	`≥r_˝u
(
úq_°ack_uni⁄
.
úq_°ack
, 
˝u
) +

236 
IRQ_STACK_SIZE
 - 64;

237 #ifde‡
CONFIG_NUMA


238 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
) =

239 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_node_m≠
, 
˝u
);

246 i‡(
˝u
 =
boŸ_˝u_id
)

247 
	`swôch_to_√w_gdt
(
˝u
);

251 #ifde‡
CONFIG_X86_LOCAL_APIC


252 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
Ë
NULL
;

253 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
Ë
NULL
;

255 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

256 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
Ë
NULL
;

259 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

264 
	`≥r_˝u
(
node_numbî
, 
boŸ_˝u_id
Ë
	`˝u_to_node
(boot_cpu_id);

268 
	`£tup_node_to_˝umask_m≠
();

271 
	`£tup_˝u_loˇl_masks
();

272 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/smp.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/sig«l.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/waô.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/≥rs⁄Æôy.h
>

21 
	~<löux/uac˚ss.h
>

23 
	~<asm/¥o˚ss‹.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/i387.h
>

26 
	~<asm/vdso.h
>

27 
	~<asm/m˚.h
>

29 #ifde‡
CONFIG_X86_64


30 
	~<asm/¥Ÿo.h
>

31 
	~<asm/ü32_uni°d.h
>

34 
	~<asm/sysˇŒ.h
>

35 
	~<asm/sysˇŒs.h
>

37 
	~<asm/sig‰ame.h
>

39 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

41 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

42 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

43 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

44 
X86_EFLAGS_CF
)

	)

46 #ifde‡
CONFIG_X86_32


47 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

49 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

52 
	#COPY
(
x
) do { \

53 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

54 } 0)

	)

56 
	#GET_SEG
(
£g
) ({ \

57 
tmp
; \

58 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

59 
tmp
; \

60 })

	)

62 
	#COPY_SEG
(
£g
) do { \

63 
ªgs
->
£g
 = 
	`GET_SEG
(seg); \

64 } 0)

	)

66 
	#COPY_SEG_CPL3
(
£g
) do { \

67 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

68 } 0)

	)

71 
	$ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
, 
sigc⁄ãxt
 
__u£r
 *
sc
,

72 *
∑x
)

74 
__u£r
 *
buf
;

75 
tmpÊags
;

76 
îr
 = 0;

79 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

81 
gë_u£r_åy
 {

83 #ifde‡
CONFIG_X86_32


84 
	`£t_u£r_gs
(
ªgs
, 
	`GET_SEG
(
gs
));

85 
	`COPY_SEG
(
fs
);

86 
	`COPY_SEG
(
es
);

87 
	`COPY_SEG
(
ds
);

90 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

91 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

93 #ifde‡
CONFIG_X86_64


94 
	`COPY
(
r8
);

95 
	`COPY
(
r9
);

96 
	`COPY
(
r10
);

97 
	`COPY
(
r11
);

98 
	`COPY
(
r12
);

99 
	`COPY
(
r13
);

100 
	`COPY
(
r14
);

101 
	`COPY
(
r15
);

104 #ifde‡
CONFIG_X86_32


105 
	`COPY_SEG_CPL3
(
cs
);

106 
	`COPY_SEG_CPL3
(
ss
);

111 
	`COPY_SEG_CPL3
(
cs
);

114 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

115 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

116 
ªgs
->
‹ig_ax
 = -1;

118 
	`gë_u£r_ex
(
buf
, &
sc
->
Â°©e
);

119 
îr
 |
	`ª°‹e_i387_x°©e
(
buf
);

121 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

122 } 
	`gë_u£r_ˇtch
(
îr
);

124  
îr
;

125 
	}
}

128 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, __u£∏*
Â°©e
,

129 
±_ªgs
 *
ªgs
, 
mask
)

131 
îr
 = 0;

133 
put_u£r_åy
 {

135 #ifde‡
CONFIG_X86_32


136 
	`put_u£r_ex
(
	`gë_u£r_gs
(
ªgs
), (
__u£r
 *)&
sc
->
gs
);

137 
	`put_u£r_ex
(
ªgs
->
fs
, (
__u£r
 *)&
sc
->fs);

138 
	`put_u£r_ex
(
ªgs
->
es
, (
__u£r
 *)&
sc
->es);

139 
	`put_u£r_ex
(
ªgs
->
ds
, (
__u£r
 *)&
sc
->ds);

142 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

143 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

144 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

145 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

146 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

147 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

148 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

149 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

150 #ifde‡
CONFIG_X86_64


151 
	`put_u£r_ex
(
ªgs
->
r8
, &
sc
->r8);

152 
	`put_u£r_ex
(
ªgs
->
r9
, &
sc
->r9);

153 
	`put_u£r_ex
(
ªgs
->
r10
, &
sc
->r10);

154 
	`put_u£r_ex
(
ªgs
->
r11
, &
sc
->r11);

155 
	`put_u£r_ex
(
ªgs
->
r12
, &
sc
->r12);

156 
	`put_u£r_ex
(
ªgs
->
r13
, &
sc
->r13);

157 
	`put_u£r_ex
(
ªgs
->
r14
, &
sc
->r14);

158 
	`put_u£r_ex
(
ªgs
->
r15
, &
sc
->r15);

161 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

162 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

163 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

164 #ifde‡
CONFIG_X86_32


165 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

166 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

167 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

168 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

170 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

171 
	`put_u£r_ex
(
ªgs
->
cs
, &
sc
->cs);

172 
	`put_u£r_ex
(0, &
sc
->
gs
);

173 
	`put_u£r_ex
(0, &
sc
->
fs
);

176 
	`put_u£r_ex
(
Â°©e
, &
sc
->fpstate);

179 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

180 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

181 } 
	`put_u£r_ˇtch
(
îr
);

183  
îr
;

184 
	}
}

193 
	$Æign_sig‰ame
(
•
)

195 #ifde‡
CONFIG_X86_32


200 
•
 = ((sp + 4) & -16ul) - 4;

202 
•
 = 
	`round_down
(sp, 16) - 8;

204  
•
;

205 
	}
}

207 
ölöe
 
__u£r
 *

208 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
size_t
 
‰ame_size
,

209 
__u£r
 **
Â°©e
)

212 
•
 = 
ªgs
->sp;

213 
⁄sig°ack
 = 
	`⁄_sig_°ack
(
•
);

215 #ifde‡
CONFIG_X86_64


217 
•
 -= 128;

220 i‡(!
⁄sig°ack
) {

222 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

223 i‡(
cuºít
->
ßs_ss_size
)

224 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

226 #ifde‡
CONFIG_X86_32


228 i‡((
ªgs
->
ss
 & 0xffffË!
__USER_DS
 &&

229 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

230 
ka
->
ß
.
ß_ª°‹î
)

231 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

236 i‡(
	`u£d_m©h
()) {

237 
•
 -
sig_x°©e_size
;

238 #ifde‡
CONFIG_X86_64


239 
•
 = 
	`round_down
(sp, 64);

241 *
Â°©e
 = (
__u£r
 *)
•
;

244 
•
 = 
	`Æign_sig‰ame
(• - 
‰ame_size
);

250 i‡(
⁄sig°ack
 && !
	`likñy
(
	`⁄_sig_°ack
(
•
)))

251  (
__u£r
 *)-1L;

254 i‡(
	`u£d_m©h
(Ë&& 
	`ßve_i387_x°©e
(*
Â°©e
) < 0)

255  (
__u£r
 *)-1L;

257  (
__u£r
 *)
•
;

258 
	}
}

260 #ifde‡
CONFIG_X86_32


262 
u16
 
	mp›lmovl
;

263 
u32
 
	mvÆ
;

264 
u16
 
	möt80
;

265 } 
__©åibuã__
((
∑cked
)Ë
	gªtcode
 = {

267 
__NR_sigªtu∫
,

272 
u8
 
	mmovl
;

273 
u32
 
	mvÆ
;

274 
u16
 
	möt80
;

275 
u8
 
	m∑d
;

276 } 
__©åibuã__
((
∑cked
)Ë
	gπ_ªtcode
 = {

278 
__NR_π_sigªtu∫
,

284 
	$__£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

285 
±_ªgs
 *
ªgs
)

287 
sig‰ame
 
__u£r
 *
‰ame
;

288 
__u£r
 *
ª°‹î
;

289 
îr
 = 0;

290 
__u£r
 *
Â°©e
 = 
NULL
;

292 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

294 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

295  -
EFAULT
;

297 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

298  -
EFAULT
;

300 i‡(
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

301  -
EFAULT
;

303 i‡(
_NSIG_WORDS
 > 1) {

304 i‡(
	`__c›y_to_u£r
(&
‰ame
->
exåamask
, &
£t
->
sig
[1],

305 (
‰ame
->
exåamask
)))

306  -
EFAULT
;

309 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

310 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
sigªtu∫
);

312 
ª°‹î
 = &
‰ame
->
ªtcode
;

313 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

314 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

317 
îr
 |
	`__put_u£r
(
ª°‹î
, &
‰ame
->
¥ëcode
);

326 
îr
 |
	`__put_u£r
(*((
u64
 *)&
ªtcode
), (u64 *)
‰ame
->retcode);

328 i‡(
îr
)

329  -
EFAULT
;

332 
ªgs
->
•
 = ()
‰ame
;

333 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

334 
ªgs
->
ax
 = ()
sig
;

335 
ªgs
->
dx
 = 0;

336 
ªgs
->
cx
 = 0;

338 
ªgs
->
ds
 = 
__USER_DS
;

339 
ªgs
->
es
 = 
__USER_DS
;

340 
ªgs
->
ss
 = 
__USER_DS
;

341 
ªgs
->
cs
 = 
__USER_CS
;

344 
	}
}

346 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

347 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

349 
π_sig‰ame
 
__u£r
 *
‰ame
;

350 
__u£r
 *
ª°‹î
;

351 
îr
 = 0;

352 
__u£r
 *
Â°©e
 = 
NULL
;

354 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

356 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

357  -
EFAULT
;

359 
put_u£r_åy
 {

360 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

361 
	`put_u£r_ex
(&
‰ame
->
öfo
, &‰ame->
pöfo
);

362 
	`put_u£r_ex
(&
‰ame
->
uc
, &‰ame->
puc
);

363 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

366 i‡(
˝u_has_xßve
)

367 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

369 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

370 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

371 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

372 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

373 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

374 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

375 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

376 
ªgs
, 
£t
->
sig
[0]);

377 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

380 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
π_sigªtu∫
);

381 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

382 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

383 
	`put_u£r_ex
(
ª°‹î
, &
‰ame
->
¥ëcode
);

392 
	`put_u£r_ex
(*((
u64
 *)&
π_ªtcode
), (u64 *)
‰ame
->
ªtcode
);

393 } 
	`put_u£r_ˇtch
(
îr
);

395 i‡(
îr
)

396  -
EFAULT
;

399 
ªgs
->
•
 = ()
‰ame
;

400 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

401 
ªgs
->
ax
 = ()
sig
;

402 
ªgs
->
dx
 = ()&
‰ame
->
öfo
;

403 
ªgs
->
cx
 = ()&
‰ame
->
uc
;

405 
ªgs
->
ds
 = 
__USER_DS
;

406 
ªgs
->
es
 = 
__USER_DS
;

407 
ªgs
->
ss
 = 
__USER_DS
;

408 
ªgs
->
cs
 = 
__USER_CS
;

411 
	}
}

413 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

414 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

416 
π_sig‰ame
 
__u£r
 *
‰ame
;

417 
__u£r
 *
Â
 = 
NULL
;

418 
îr
 = 0;

419 
èsk_°ru˘
 *
me
 = 
cuºít
;

421 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (
π_sig‰ame
), &
Â
);

423 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

424  -
EFAULT
;

426 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
) {

427 i‡(
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info))

428  -
EFAULT
;

431 
put_u£r_åy
 {

433 i‡(
˝u_has_xßve
)

434 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

436 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

437 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

438 
	`put_u£r_ex
(
me
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

439 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

440 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

441 
	`put_u£r_ex
(
me
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

442 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â
, 
ªgs
, 
£t
->
sig
[0]);

443 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

448 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

449 
	`put_u£r_ex
(
ka
->
ß
.
ß_ª°‹î
, &
‰ame
->
¥ëcode
);

452 
îr
 |-
EFAULT
;

454 } 
	`put_u£r_ˇtch
(
îr
);

456 i‡(
îr
)

457  -
EFAULT
;

460 
ªgs
->
di
 = 
sig
;

462 
ªgs
->
ax
 = 0;

466 
ªgs
->
si
 = ()&
‰ame
->
öfo
;

467 
ªgs
->
dx
 = ()&
‰ame
->
uc
;

468 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

470 
ªgs
->
•
 = ()
‰ame
;

474 
ªgs
->
cs
 = 
__USER_CS
;

477 
	}
}

480 #ifde‡
CONFIG_X86_32


484 
asmlökage
 

485 
	$sys_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

487 
mask
 &
_BLOCKABLE
;

488 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

489 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

490 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

491 
	`ªˇlc_sig≥ndög
();

492 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

494 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

495 
	`scheduÀ
();

496 
	`£t_ª°‹e_sigmask
();

498  -
ERESTARTNOHAND
;

499 
	}
}

501 
asmlökage
 

502 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

503 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

505 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

506 
ªt
 = 0;

508 i‡(
a˘
) {

509 
ﬁd_sig£t_t
 
mask
;

511 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)))

512  -
EFAULT
;

514 
gë_u£r_åy
 {

515 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler);

516 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

517 
	`gë_u£r_ex
(
mask
, &
a˘
->
ß_mask
);

518 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer);

519 } 
	`gë_u£r_ˇtch
(
ªt
);

521 i‡(
ªt
)

522  -
EFAULT
;

523 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

526 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

528 i‡(!
ªt
 && 
ﬂ˘
) {

529 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)))

530  -
EFAULT
;

532 
put_u£r_åy
 {

533 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler);

534 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

535 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

536 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer);

537 } 
	`put_u£r_ˇtch
(
ªt
);

539 i‡(
ªt
)

540  -
EFAULT
;

543  
ªt
;

544 
	}
}

547 #ifde‡
CONFIG_X86_32


548 
	$sys_sigÆt°ack
(
±_ªgs
 *
ªgs
)

550 c⁄° 
°ack_t
 
__u£r
 *
uss
 = (c⁄° sèck_à__u£∏*)
ªgs
->
bx
;

551 
°ack_t
 
__u£r
 *
uoss
 = (°ack_à__u£∏*)
ªgs
->
cx
;

553  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

554 
	}
}

556 
asmlökage
 

557 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
,

558 
±_ªgs
 *
ªgs
)

560  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

561 
	}
}

567 #ifde‡
CONFIG_X86_32


568 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

570 
sig‰ame
 
__u£r
 *
‰ame
;

571 
ax
;

572 
sig£t_t
 
£t
;

574 
‰ame
 = (
sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - 8);

576 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

577 
bad‰ame
;

578 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
Ë|| (
_NSIG_WORDS
 > 1

579 && 
	`__c›y_‰om_u£r
(&
£t
.
sig
[1], &
‰ame
->
exåamask
,

580 (
‰ame
->
exåamask
))))

581 
bad‰ame
;

583 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

584 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

585 
cuºít
->
blocked
 = 
£t
;

586 
	`ªˇlc_sig≥ndög
();

587 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

589 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

590 
bad‰ame
;

591  
ax
;

593 
bad‰ame
:

594 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "sigreturn");

597 
	}
}

600 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

602 
π_sig‰ame
 
__u£r
 *
‰ame
;

603 
ax
;

604 
sig£t_t
 
£t
;

606 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - ());

607 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

608 
bad‰ame
;

609 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

610 
bad‰ame
;

612 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

613 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

614 
cuºít
->
blocked
 = 
£t
;

615 
	`ªˇlc_sig≥ndög
();

616 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

618 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

619 
bad‰ame
;

621 i‡(
	`do_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
•
Ë=-
EFAULT
)

622 
bad‰ame
;

624  
ax
;

626 
bad‰ame
:

627 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "rt_sigreturn");

629 
	}
}

634 
	$sigƒ_c⁄vît
(
sig
)

636 #ifde‡
CONFIG_X86_32


637 
thªad_öfo
 *
öfo
 = 
	`cuºít_thªad_öfo
();

639 i‡(
öfo
->
exec_domaö
 && info->exec_domaö->
sig«l_övm≠
 && 
sig
 < 32)

640  
öfo
->
exec_domaö
->
sig«l_övm≠
[
sig
];

642  
sig
;

643 
	}
}

645 #ifde‡
CONFIG_X86_32


647 
	#is_ü32
 1

	)

648 
	#ü32_£tup_‰ame
 
__£tup_‰ame


	)

649 
	#ü32_£tup_π_‰ame
 
__£tup_π_‰ame


	)

653 #ifde‡
CONFIG_IA32_EMULATION


654 
	#is_ü32
 
	`ã°_thªad_Êag
(
TIF_IA32
)

	)

656 
	#is_ü32
 0

	)

659 
ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

660 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

661 
ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

662 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

667 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

668 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

670 
usig
 = 
	`sigƒ_c⁄vît
(
sig
);

671 
ªt
;

674 i‡(
is_ü32
) {

675 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

676 
ªt
 = 
	`ü32_£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

678 
ªt
 = 
	`ü32_£tup_‰ame
(
usig
, 
ka
, 
£t
, 
ªgs
);

680 
ªt
 = 
	`__£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

682 i‡(
ªt
) {

683 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

684  -
EFAULT
;

687  
ªt
;

688 
	}
}

691 
	$h™dÀ_sig«l
(
sig
, 
sigöfo_t
 *
öfo
, 
k_siga˘i⁄
 *
ka
,

692 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
)

694 
ªt
;

697 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

699 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

700 -
ERESTART_RESTARTBLOCK
:

701 -
ERESTARTNOHAND
:

702 
ªgs
->
ax
 = -
EINTR
;

705 -
ERESTARTSYS
:

706 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

707 
ªgs
->
ax
 = -
EINTR
;

711 -
ERESTARTNOINTR
:

712 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

713 
ªgs
->
ù
 -= 2;

722 i‡(
	`u∆ikñy
(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
) &&

723 
	`likñy
(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_FORCED_TF
)))

724 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

726 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

728 i‡(
ªt
)

729  
ªt
;

731 #ifde‡
CONFIG_X86_64


737 
	`£t_fs
(
USER_DS
);

743 
ªgs
->
Êags
 &~
X86_EFLAGS_DF
;

751 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

753 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

754 
	`sig‹£ts
(&
cuºít
->
blocked
, &cuºít->blocked, &
ka
->
ß
.
ß_mask
);

755 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

756 
	`sigadd£t
(&
cuºít
->
blocked
, 
sig
);

757 
	`ªˇlc_sig≥ndög
();

758 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

760 
	`åa˚hook_sig«l_h™dÀr
(
sig
, 
öfo
, 
ka
, 
ªgs
,

761 
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
));

764 
	}
}

766 #ifde‡
CONFIG_X86_32


767 
	#NR_ª°¨t_sysˇŒ
 
__NR_ª°¨t_sysˇŒ


	)

769 
	#NR_ª°¨t_sysˇŒ
 \

770 
	`ã°_thªad_Êag
(
TIF_IA32
Ë? 
__NR_ü32_ª°¨t_sysˇŒ
 : 
__NR_ª°¨t_sysˇŒ


	)

778 
	$do_sig«l
(
±_ªgs
 *
ªgs
)

780 
k_siga˘i⁄
 
ka
;

781 
sigöfo_t
 
öfo
;

782 
sigƒ
;

783 
sig£t_t
 *
ﬁd£t
;

792 i‡(!
	`u£r_mode
(
ªgs
))

795 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
)

796 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

798 
ﬁd£t
 = &
cuºít
->
blocked
;

800 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

801 i‡(
sigƒ
 > 0) {

808 i‡(
cuºít
->
thªad
.
debugªg7
)

809 
	`£t_debugªg
(
cuºít
->
thªad
.
debugªg7
, 7);

812 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
öfo
, &
ka
, 
ﬁd£t
, 
ªgs
) == 0) {

819 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

825 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

827 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

828 -
ERESTARTNOHAND
:

829 -
ERESTARTSYS
:

830 -
ERESTARTNOINTR
:

831 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

832 
ªgs
->
ù
 -= 2;

835 -
ERESTART_RESTARTBLOCK
:

836 
ªgs
->
ax
 = 
NR_ª°¨t_sysˇŒ
;

837 
ªgs
->
ù
 -= 2;

846 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
) {

847 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

848 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

850 
	}
}

857 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, *
unu£d
, 
__u32
 
thªad_öfo_Êags
)

859 #ifde‡
CONFIG_X86_MCE


861 i‡(
thªad_öfo_Êags
 & 
_TIF_MCE_NOTIFY
)

862 
	`m˚_nŸify_¥o˚ss
();

866 i‡(
thªad_öfo_Êags
 & 
_TIF_SIGPENDING
)

867 
	`do_sig«l
(
ªgs
);

869 i‡(
thªad_öfo_Êags
 & 
_TIF_NOTIFY_RESUME
) {

870 
	`˛ór_thªad_Êag
(
TIF_NOTIFY_RESUME
);

871 
	`åa˚hook_nŸify_ªsume
(
ªgs
);

872 i‡(
cuºít
->
ª∂a˚mít_£ssi⁄_keyrög
)

873 
	`key_ª∂a˚_£ssi⁄_keyrög
();

876 #ifde‡
CONFIG_X86_32


877 
	`˛ór_thªad_Êag
(
TIF_IRET
);

879 
	}
}

881 
	$sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
)

883 
èsk_°ru˘
 *
me
 = 
cuºít
;

885 i‡(
show_unh™dÀd_sig«ls
 && 
	`¥ötk_øãlimô
()) {

886 
	`¥ötk
("%s"

888 
	`èsk_pid_ƒ
(
cuºít
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

889 
me
->
comm
, me->
pid
, 
whîe
, 
‰ame
,

890 
ªgs
->
ù
,Ñegs->
•
,Ñegs->
‹ig_ax
);

891 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

892 
	`¥ötk
(
KERN_CONT
 "\n");

895 
	`f‹˚_sig
(
SIGSEGV
, 
me
);

896 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/mc146818πc.h
>

21 
	~<löux/ˇche.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/˝u.h
>

25 
	~<asm/mår.h
>

26 
	~<asm/ébÊush.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/≠ic.h
>

114 
	$«tive_smp_£nd_ªscheduÀ
(
˝u
)

116 i‡(
	`u∆ikñy
(
	`˝u_is_ofÊöe
(
˝u
))) {

117 
	`WARN_ON
(1);

120 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
RESCHEDULE_VECTOR
);

121 
	}
}

123 
	$«tive_£nd_ˇŒ_func_sögÀ_ùi
(
˝u
)

125 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
CALL_FUNCTION_SINGLE_VECTOR
);

126 
	}
}

128 
	$«tive_£nd_ˇŒ_func_ùi
(c⁄° 
˝umask
 *
mask
)

130 
˝umask_v¨_t
 
Ælbut£lf
;

132 i‡(!
	`Æloc_˝umask_v¨
(&
Ælbut£lf
, 
GFP_ATOMIC
)) {

133 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

137 
	`˝umask_c›y
(
Ælbut£lf
, 
˝u_⁄löe_mask
);

138 
	`˝umask_˛ór_˝u
(
	`smp_¥o˚ss‹_id
(), 
Ælbut£lf
);

140 i‡(
	`˝umask_equÆ
(
mask
, 
Ælbut£lf
) &&

141 
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
˝u_ˇŒout_mask
))

142 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
CALL_FUNCTION_VECTOR
);

144 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

146 
	`‰ì_˝umask_v¨
(
Ælbut£lf
);

147 
	}
}

153 
asmlökage
 
	$smp_ªboŸ_öãºu±
()

155 
	`ack_APIC_úq
();

156 
	`úq_íãr
();

157 
	`°›_this_˝u
(
NULL
);

158 
	`úq_exô
();

159 
	}
}

161 
	$«tive_smp_£nd_°›
()

163 
Êags
;

164 
waô
;

166 i‡(
ªboŸ_f‹˚
)

178 i‡(
	`num_⁄löe_˝us
() > 1) {

179 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
REBOOT_VECTOR
);

182 
waô
 = 
USEC_PER_SEC
;

183 
	`num_⁄löe_˝us
(Ë> 1 && 
waô
--)

184 
	`udñay
(1);

187 
	`loˇl_úq_ßve
(
Êags
);

188 
	`dißbÀ_loˇl_APIC
();

189 
	`loˇl_úq_ª°‹e
(
Êags
);

190 
	}
}

197 
	$smp_ªscheduÀ_öãºu±
(
±_ªgs
 *
ªgs
)

199 
	`ack_APIC_úq
();

200 
	`öc_úq_°©
(
úq_ªsched_cou¡
);

204 
	}
}

206 
	$smp_ˇŒ_fun˘i⁄_öãºu±
(
±_ªgs
 *
ªgs
)

208 
	`ack_APIC_úq
();

209 
	`úq_íãr
();

210 
	`gíîic_smp_ˇŒ_fun˘i⁄_öãºu±
();

211 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

212 
	`úq_exô
();

213 
	}
}

215 
	$smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
(
±_ªgs
 *
ªgs
)

217 
	`ack_APIC_úq
();

218 
	`úq_íãr
();

219 
	`gíîic_smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
();

220 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

221 
	`úq_exô
();

222 
	}
}

224 
smp_›s
 
	gsmp_›s
 = {

225 .
smp_¥ï¨e_boŸ_˝u
 = 
«tive_smp_¥ï¨e_boŸ_˝u
,

226 .
	gsmp_¥ï¨e_˝us
 = 
«tive_smp_¥ï¨e_˝us
,

227 .
	gsmp_˝us_d⁄e
 = 
«tive_smp_˝us_d⁄e
,

229 .
	gsmp_£nd_°›
 = 
«tive_smp_£nd_°›
,

230 .
	gsmp_£nd_ªscheduÀ
 = 
«tive_smp_£nd_ªscheduÀ
,

232 .
	g˝u_up
 = 
«tive_˝u_up
,

233 .
	g˝u_dõ
 = 
«tive_˝u_dõ
,

234 .
	g˝u_dißbÀ
 = 
«tive_˝u_dißbÀ
,

235 .
	g∂ay_dód
 = 
«tive_∂ay_dód
,

237 .
	g£nd_ˇŒ_func_ùi
 = 
«tive_£nd_ˇŒ_func_ùi
,

238 .
	g£nd_ˇŒ_func_sögÀ_ùi
 = 
«tive_£nd_ˇŒ_func_sögÀ_ùi
,

240 
EXPORT_SYMBOL_GPL
(
smp_›s
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<löux/öô.h
>

43 
	~<löux/smp.h
>

44 
	~<löux/moduÀ.h
>

45 
	~<löux/sched.h
>

46 
	~<löux/≥r˝u.h
>

47 
	~<löux/boŸmem.h
>

48 
	~<löux/îr.h
>

49 
	~<löux/nmi.h
>

50 
	~<löux/tboŸ.h
>

52 
	~<asm/a˝i.h
>

53 
	~<asm/desc.h
>

54 
	~<asm/nmi.h
>

55 
	~<asm/úq.h
>

56 
	~<asm/idÀ.h
>

57 
	~<asm/åampﬁöe.h
>

58 
	~<asm/˝u.h
>

59 
	~<asm/numa.h
>

60 
	~<asm/pgèbÀ.h
>

61 
	~<asm/ébÊush.h
>

62 
	~<asm/mår.h
>

63 
	~<asm/vmi.h
>

64 
	~<asm/≠ic.h
>

65 
	~<asm/£tup.h
>

66 
	~<asm/uv/uv.h
>

67 
	~<löux/mc146818πc.h
>

69 
	~<asm/smpboŸ_hooks.h
>

71 #ifde‡
CONFIG_X86_32


72 
u8
 
	g≠icid_2_node
[
MAX_APICID
];

73 
	glow_m≠pögs
;

77 
DEFINE_PER_CPU
(, 
˝u_°©e
) = { 0 };

83 #ifde‡
CONFIG_HOTPLUG_CPU


88 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
idÀ_thªad_¨øy
);

89 
	#gë_idÀ_f‹_˝u
(
x
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, x))

	)

90 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, xË’))

	)

92 
èsk_°ru˘
 *
	gidÀ_thªad_¨øy
[
NR_CPUS
] 
	g__˝uöôd©a
 ;

93 
	#gë_idÀ_f‹_˝u
(
x
Ë(
idÀ_thªad_¨øy
[(x)])

	)

94 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
idÀ_thªad_¨øy
[(x)] = (p))

	)

98 
	gsmp_num_siblögs
 = 1;

99 
EXPORT_SYMBOL
(
smp_num_siblögs
);

102 
DEFINE_PER_CPU
(
u16
, 
˝u_Œc_id
Ë
BAD_APICID
;

105 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_siblög_m≠
);

106 
EXPORT_PER_CPU_SYMBOL
(
˝u_siblög_m≠
);

109 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_c‹e_m≠
);

110 
EXPORT_PER_CPU_SYMBOL
(
˝u_c‹e_m≠
);

113 
DEFINE_PER_CPU_SHARED_ALIGNED
(
˝uöfo_x86
, 
˝u_öfo
);

114 
EXPORT_PER_CPU_SYMBOL
(
˝u_öfo
);

116 
©omic_t
 
	göô_dós£πed
;

118 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_32
)

120 
	g˝u_to_node_m≠
[
NR_CPUS
] 
	g__ªad_mo°ly
 = { [0 ... NR_CPUS-1] = 0 };

121 
EXPORT_SYMBOL
(
˝u_to_node_m≠
);

124 
	$m≠_˝u_to_node
(
˝u
, 
node
)

126 
	`¥ötk
(
KERN_INFO
 "M≠pög cpu %dÅÿnodê%d\n", 
˝u
, 
node
);

127 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

128 
˝u_to_node_m≠
[
˝u
] = 
node
;

129 
	}
}

132 
	$unm≠_˝u_to_node
(
˝u
)

134 
node
;

136 
	`¥ötk
(
KERN_INFO
 "Unm≠pög cpu %d fromáŒÇodes\n", 
˝u
);

137 
node
 = 0;Çodê< 
MAX_NUMNODES
;Çode++)

138 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

139 
˝u_to_node_m≠
[
˝u
] = 0;

140 
	}
}

142 
	#m≠_˝u_to_node
(
˝u
, 
node
Ë({})

	)

143 
	#unm≠_˝u_to_node
(
˝u
Ë({})

	)

146 #ifde‡
CONFIG_X86_32


147 
	gboŸ_˝u_logiˇl_≠icid
;

149 
u8
 
	g˝u_2_logiˇl_≠icid
[
NR_CPUS
] 
	g__ªad_mo°ly
 =

150 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

152 
	$m≠_˝u_to_logiˇl_≠icid
()

154 
˝u
 = 
	`smp_¥o˚ss‹_id
();

155 
≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

156 
node
 = 
≠ic
->
	`≠icid_to_node
(
≠icid
);

158 i‡(!
	`node_⁄löe
(
node
))

159 
node
 = 
fú°_⁄löe_node
;

161 
˝u_2_logiˇl_≠icid
[
˝u
] = 
≠icid
;

162 
	`m≠_˝u_to_node
(
˝u
, 
node
);

163 
	}
}

165 
	$numa_ªmove_˝u
(
˝u
)

167 
˝u_2_logiˇl_≠icid
[
˝u
] = 
BAD_APICID
;

168 
	`unm≠_˝u_to_node
(
˝u
);

169 
	}
}

171 
	#m≠_˝u_to_logiˇl_≠icid
(Ëdÿ{} 0)

	)

178 
__˝uöô
 
	$smp_ˇŒö
()

180 
˝uid
, 
phys_id
;

181 
timeout
;

189 i‡(
≠ic
->
waô_f‹_öô_dós£π
)

190 
≠ic
->
	`waô_f‹_öô_dós£π
(&
öô_dós£πed
);

195 
phys_id
 = 
	`ªad_≠ic_id
();

196 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

197 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒö_mask
)) {

198 
	`∑nic
("%s:Öhy†CPU#%d, CPU#%dáÃódyÖª£¡??\n", 
__func__
,

199 
phys_id
, 
˝uid
);

201 
	`¥_debug
("CPU#%d (phy†ID: %dËwaôög f‹ CALLOUT\n", 
˝uid
, 
phys_id
);

214 
timeout
 = 
jiffõs
 + 2*
HZ
;

215 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

219 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒout_mask
))

221 
	`˝u_ªœx
();

224 i‡(!
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

225 
	`∑nic
("%s: CPU%d started up but didÇot getá callout!\n",

226 
__func__
, 
˝uid
);

236 
	`¥_debug
("CALLIN, before setup_local_APIC().\n");

237 i‡(
≠ic
->
smp_ˇŒö_˛ór_loˇl_≠ic
)

238 
≠ic
->
	`smp_ˇŒö_˛ór_loˇl_≠ic
();

239 
	`£tup_loˇl_APIC
();

240 
	`íd_loˇl_APIC_£tup
();

241 
	`m≠_˝u_to_logiˇl_≠icid
();

243 
	`nŸify_˝u_°¨tög
(
˝uid
);

250 
	`loˇl_úq_íabÀ
();

251 
	`ˇlibøã_dñay
();

252 
	`loˇl_úq_dißbÀ
();

253 
	`¥_debug
("Sèckáàabouà%p\n", &
˝uid
);

258 
	`smp_°‹e_˝u_öfo
(
˝uid
);

263 
	`˝umask_£t_˝u
(
˝uid
, 
˝u_ˇŒö_mask
);

264 
	}
}

269 
nŸø˚
 
__˝uöô
 
	$°¨t_£c⁄d¨y
(*
unu£d
)

276 
	`vmi_brögup
();

277 
	`˝u_öô
();

278 
	`¥ìm±_dißbÀ
();

279 
	`smp_ˇŒö
();

282 
	`b¨rõr
();

286 
	`check_tsc_sync_èrgë
();

288 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

289 
	`dißbÀ_8259A_úq
(0);

290 
	`íabÀ_NMI_through_LVT0
();

291 
	`íabÀ_8259A_úq
(0);

294 #ifde‡
CONFIG_X86_32


295 
low_m≠pögs
)

296 
	`˝u_ªœx
();

297 
	`__Êush_éb_Æl
();

301 
	`£t_˝u_siblög_m≠
(
	`øw_smp_¥o˚ss‹_id
());

302 
	`wmb
();

316 
	`ùi_ˇŒ_lock
();

317 
	`lock_ve˘‹_lock
();

318 
	`__£tup_ve˘‹_úq
(
	`smp_¥o˚ss‹_id
());

319 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
åue
);

320 
	`u∆ock_ve˘‹_lock
();

321 
	`ùi_ˇŒ_u∆ock
();

322 
	`≥r_˝u
(
˝u_°©e
, 
	`smp_¥o˚ss‹_id
()Ë
CPU_ONLINE
;

325 
	`loˇl_úq_íabÀ
();

327 
x86_˝uöô
.
	`£tup_≥r˝u_˛ockev
();

329 
	`wmb
();

330 
	`˝u_idÀ
();

331 
	}
}

333 #ifde‡
CONFIG_CPUMASK_OFFSTACK


335 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

336 c⁄° 
˝uöfo_x86
 *
§c
)

338 
˝umask
 *
Œc
 = 
d°
->
Œc_sh¨ed_m≠
;

339 *
d°
 = *
§c
;

340 
d°
->
Œc_sh¨ed_m≠
 = 
Œc
;

341 
	}
}

343 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

344 c⁄° 
˝uöfo_x86
 *
§c
)

346 *
d°
 = *
§c
;

347 
	}
}

355 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
id
)

357 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
id
);

359 
	`c›y_˝uöfo_x86
(
c
, &
boŸ_˝u_d©a
);

360 
c
->
˝u_ödex
 = 
id
;

361 i‡(
id
 != 0)

362 
	`idítify_£c⁄d¨y_˝u
(
c
);

363 
	}
}

366 
__˝uöô
 
	$£t_˝u_siblög_m≠
(
˝u
)

368 
i
;

369 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

371 
	`˝umask_£t_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

373 i‡(
smp_num_siblögs
 > 1) {

374 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

375 
˝uöfo_x86
 *
o
 = &
	`˝u_d©a
(
i
);

377 i‡(
c
->
phys_¥oc_id
 =
o
->phys_proc_id &&

378 
c
->
˝u_c‹e_id
 =
o
->cpu_core_id) {

379 
	`˝umask_£t_˝u
(
i
, 
	`˝u_siblög_mask
(
˝u
));

380 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(
i
));

381 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

382 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

383 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

384 
	`˝umask_£t_˝u
(
˝u
, 
o
->
Œc_sh¨ed_m≠
);

388 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(cpu));

391 
	`˝umask_£t_˝u
(
˝u
, 
c
->
Œc_sh¨ed_m≠
);

393 i‡(
cuºít_˝u_d©a
.
x86_max_c‹es
 == 1) {

394 
	`˝umask_c›y
(
	`˝u_c‹e_mask
(
˝u
), 
	`˝u_siblög_mask
(cpu));

395 
c
->
boŸed_c‹es
 = 1;

399 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

400 i‡(
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë!
BAD_APICID
 &&

401 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë=≥r_˝u(˝u_Œc_id, 
i
)) {

402 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

403 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

405 i‡(
c
->
phys_¥oc_id
 =
	`˝u_d©a
(
i
).phys_proc_id) {

406 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

407 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

411 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1) {

416 i‡(
	`˝umask_fú°
(
	`˝u_siblög_mask
(
i
)) == i)

417 
c
->
boŸed_c‹es
++;

422 i‡(
i
 !
˝u
)

423 
	`˝u_d©a
(
i
).
boŸed_c‹es
++;

424 } i‡(
i
 !
˝u
 && !
c
->
boŸed_c‹es
)

425 
c
->
boŸed_c‹es
 = 
	`˝u_d©a
(
i
).booted_cores;

428 
	}
}

431 c⁄° 
˝umask
 *
	$˝u_c‹egroup_mask
(
˝u
)

433 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

438 i‡((
sched_mc_powî_ßvögs
 || 
sched_smt_powî_ßvögs
) &&

439 !(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
)))

440  
	`˝u_c‹e_mask
(
˝u
);

442  
c
->
Œc_sh¨ed_m≠
;

443 
	}
}

445 
	$im¥ess_‰õnds
()

447 
˝u
;

448 
bogosum
 = 0;

452 
	`¥_debug
("Before bogomips.\n");

453 
	`f‹_óch_possibÀ_˝u
(
˝u
)

454 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒout_mask
))

455 
bogosum
 +
	`˝u_d©a
(
˝u
).
lo›s_≥r_jiffy
;

456 
	`¥ötk
(
KERN_INFO


458 
	`num_⁄löe_˝us
(),

459 
bogosum
/(500000/
HZ
),

460 (
bogosum
/(5000/
HZ
))%100);

462 
	`¥_debug
("Before bogocount - settingáctivated=1.\n");

463 
	}
}

465 
	$__öquúe_ªmŸe_≠ic
(
≠icid
)

467 
i
, 
ªgs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

468 *
«mes
[] = { "ID", "VERSION", "SPIV" };

469 
timeout
;

470 
u32
 
°©us
;

472 
	`¥ötk
(
KERN_INFO
 "InquúögÑemŸêAPIC 0x%x...\n", 
≠icid
);

474 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªgs
); i++) {

475 
	`¥ötk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
≠icid
, 
«mes
[
i
]);

480 
°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

481 i‡(
°©us
)

482 
	`¥ötk
(
KERN_CONT


485 
	`≠ic_i¸_wrôe
(
APIC_DM_REMRD
 | 
ªgs
[
i
], 
≠icid
);

487 
timeout
 = 0;

489 
	`udñay
(100);

490 
°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_RR_MASK
;

491 } 
°©us
 =
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

493 
°©us
) {

494 
APIC_ICR_RR_VALID
:

495 
°©us
 = 
	`≠ic_ªad
(
APIC_RRR
);

496 
	`¥ötk
(
KERN_CONT
 "%08x\n", 
°©us
);

499 
	`¥ötk
(
KERN_CONT
 "failed\n");

502 
	}
}

509 
__˝uöô


510 
	$wakeup_£c⁄d¨y_˝u_vü_nmi
(
logiˇl_≠icid
, 
°¨t_eù
)

512 
£nd_°©us
, 
ac˚±_°©us
 = 0;

513 
maxlvt
;

518 
	`≠ic_i¸_wrôe
(
APIC_DM_NMI
 | 
≠ic
->
de°_logiˇl
, 
logiˇl_≠icid
);

520 
	`¥_debug
("Waiting for sendÅo finish...\n");

521 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

526 
	`udñay
(200);

527 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

528 
maxlvt
 = 
	`œpic_gë_maxlvt
();

529 i‡(
maxlvt
 > 3)

530 
	`≠ic_wrôe
(
APIC_ESR
, 0);

531 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

533 
	`¥_debug
("NMI sent.\n");

535 i‡(
£nd_°©us
)

536 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

537 i‡(
ac˚±_°©us
)

538 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

540  (
£nd_°©us
 | 
ac˚±_°©us
);

541 
	}
}

543 
__˝uöô


544 
	$wakeup_£c⁄d¨y_˝u_vü_öô
(
phys_≠icid
, 
°¨t_eù
)

546 
£nd_°©us
, 
ac˚±_°©us
 = 0;

547 
maxlvt
, 
num_°¨ts
, 
j
;

549 
maxlvt
 = 
	`œpic_gë_maxlvt
();

554 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
])) {

555 i‡(
maxlvt
 > 3)

556 
	`≠ic_wrôe
(
APIC_ESR
, 0);

557 
	`≠ic_ªad
(
APIC_ESR
);

560 
	`¥_debug
("Asserting INIT.\n");

568 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

569 
phys_≠icid
);

571 
	`¥_debug
("Waiting for sendÅo finish...\n");

572 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

574 
	`mdñay
(10);

576 
	`¥_debug
("Deasserting INIT.\n");

580 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_≠icid
);

582 
	`¥_debug
("Waiting for sendÅo finish...\n");

583 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

585 
	`mb
();

586 
	`©omic_£t
(&
öô_dós£πed
, 1);

594 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
]))

595 
num_°¨ts
 = 2;

597 
num_°¨ts
 = 0;

603 
	`°¨tup_ùi_hook
(
phys_≠icid
, (Ë
°¨t_£c⁄d¨y
,

604 ()
°ack_°¨t
.
•
);

609 
	`¥_debug
("#°¨tu∞lo›s: %d.\n", 
num_°¨ts
);

611 
j
 = 1; j <
num_°¨ts
; j++) {

612 
	`¥_debug
("Sídög STARTUP #%d.\n", 
j
);

613 i‡(
maxlvt
 > 3)

614 
	`≠ic_wrôe
(
APIC_ESR
, 0);

615 
	`≠ic_ªad
(
APIC_ESR
);

616 
	`¥_debug
("Afterápic_write.\n");

625 
	`≠ic_i¸_wrôe
(
APIC_DM_STARTUP
 | (
°¨t_eù
 >> 12),

626 
phys_≠icid
);

631 
	`udñay
(300);

633 
	`¥_debug
("StartupÖoint 1.\n");

635 
	`¥_debug
("Waiting for sendÅo finish...\n");

636 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

641 
	`udñay
(200);

642 i‡(
maxlvt
 > 3)

643 
	`≠ic_wrôe
(
APIC_ESR
, 0);

644 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

645 i‡(
£nd_°©us
 || 
ac˚±_°©us
)

648 
	`¥_debug
("After Startup.\n");

650 i‡(
£nd_°©us
)

651 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

652 i‡(
ac˚±_°©us
)

653 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

655  (
£nd_°©us
 | 
ac˚±_°©us
);

656 
	}
}

658 
	s¸óã_idÀ
 {

659 
w‹k_°ru˘
 
	mw‹k
;

660 
èsk_°ru˘
 *
	midÀ
;

661 
com∂ëi⁄
 
	md⁄e
;

662 
	m˝u
;

665 
__˝uöô
 
	$do_f‹k_idÀ
(
w‹k_°ru˘
 *
w‹k
)

667 
¸óã_idÀ
 *
c_idÀ
 =

668 
	`c⁄èöî_of
(
w‹k
, 
¸óã_idÀ
, work);

670 
c_idÀ
->
idÀ
 = 
	`f‹k_idÀ
(c_idÀ->
˝u
);

671 
	`com∂ëe
(&
c_idÀ
->
d⁄e
);

672 
	}
}

680 
__˝uöô
 
	$do_boŸ_˝u
(
≠icid
, 
˝u
)

682 
boŸ_îr‹
 = 0;

683 
°¨t_ù
;

684 
timeout
;

685 
¸óã_idÀ
 
c_idÀ
 = {

686 .
˝u
 = cpu,

687 .
d⁄e
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idÀ
.done),

690 
	`INIT_WORK
(&
c_idÀ
.
w‹k
, 
do_f‹k_idÀ
);

692 
	`Æã∫©ives_smp_swôch
(1);

694 
c_idÀ
.
idÀ
 = 
	`gë_idÀ_f‹_˝u
(
˝u
);

700 i‡(
c_idÀ
.
idÀ
) {

701 
c_idÀ
.
idÀ
->
thªad
.
•
 = (Ë(((
±_ªgs
 *)

702 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
))) - 1);

703 
	`öô_idÀ
(
c_idÀ
.
idÀ
, 
˝u
);

704 
do_ª°
;

707 i‡(!
	`kevítd_up
(Ë|| 
	`cuºít_is_kevítd
())

708 
c_idÀ
.
w‹k
.
	`func
(&c_idle.work);

710 
	`scheduÀ_w‹k
(&
c_idÀ
.
w‹k
);

711 
	`waô_f‹_com∂ëi⁄
(&
c_idÀ
.
d⁄e
);

714 i‡(
	`IS_ERR
(
c_idÀ
.
idÀ
)) {

715 
	`¥ötk
("Áûed f‹k f‹ CPU %d\n", 
˝u
);

716  
	`PTR_ERR
(
c_idÀ
.
idÀ
);

719 
	`£t_idÀ_f‹_˝u
(
˝u
, 
c_idÀ
.
idÀ
);

720 
do_ª°
:

721 
	`≥r_˝u
(
cuºít_èsk
, 
˝u
Ë
c_idÀ
.
idÀ
;

722 #ifde‡
CONFIG_X86_32


724 
	`úq_˘x_öô
(
˝u
);

726 
	`˛ór_tsk_thªad_Êag
(
c_idÀ
.
idÀ
, 
TIF_FORK
);

727 
öôül_gs
 = 
	`≥r_˝u_off£t
(
˝u
);

728 
	`≥r_˝u
(
kî√l_°ack
, 
˝u
) =

729 ()
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
) -

730 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

732 
óæy_gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

733 
öôül_code
 = ()
°¨t_£c⁄d¨y
;

734 
°ack_°¨t
.
•
 = (*Ë
c_idÀ
.
idÀ
->
thªad
.sp;

737 
°¨t_ù
 = 
	`£tup_åampﬁöe
();

740 
	`¥ötk
(
KERN_INFO
 "BootingÖrocessor %d APIC 0x%x ip 0x%lx\n",

741 
˝u
, 
≠icid
, 
°¨t_ù
);

748 
	`©omic_£t
(&
öô_dós£πed
, 0);

750 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

752 
	`¥_debug
("Setting warmÑeset codeánd vector.\n");

754 
	`smpboŸ_£tup_w¨m_ª£t_ve˘‹
(
°¨t_ù
);

758 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

759 
	`≠ic_wrôe
(
APIC_ESR
, 0);

760 
	`≠ic_ªad
(
APIC_ESR
);

768 i‡(
≠ic
->
wakeup_£c⁄d¨y_˝u
)

769 
boŸ_îr‹
 = 
≠ic
->
	`wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_ù
);

771 
boŸ_îr‹
 = 
	`wakeup_£c⁄d¨y_˝u_vü_öô
(
≠icid
, 
°¨t_ù
);

773 i‡(!
boŸ_îr‹
) {

777 
	`¥_debug
("Bef‹êCÆlouà%d.\n", 
˝u
);

778 
	`˝umask_£t_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

779 
	`¥_debug
("A·î CÆlouà%d.\n", 
˝u
);

784 
timeout
 = 0;Åimeout < 50000;Åimeout++) {

785 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

787 
	`udñay
(100);

790 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

792 
	`¥_debug
("OK.\n");

793 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 
˝u
);

794 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(
˝u
));

795 
	`¥_debug
("CPU has booted.\n");

797 
boŸ_îr‹
 = 1;

798 i‡(*((vﬁ©ûê*)
åampﬁöe_ba£
)

801 
	`¥ötk
(
KERN_ERR
 "Stuck ??\n");

804 
	`¥ötk
(
KERN_ERR
 "NotÑesponding.\n");

805 i‡(
≠ic
->
öquúe_ªmŸe_≠ic
)

806 
≠ic
->
	`öquúe_ªmŸe_≠ic
(
≠icid
);

810 i‡(
boŸ_îr‹
) {

812 
	`numa_ªmove_˝u
(
˝u
);

815 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

818 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

820 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

821 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
BAD_APICID
;

825 *((vﬁ©ûê*)
åampﬁöe_ba£
) = 0;

827 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

831 
	`smpboŸ_ª°‹e_w¨m_ª£t_ve˘‹
();

834  
boŸ_îr‹
;

835 
	}
}

837 
__˝uöô
 
	$«tive_˝u_up
(
˝u
)

839 
≠icid
 = 
≠ic
->
	`˝u_¥e£¡_to_≠icid
(
˝u
);

840 
Êags
;

841 
îr
;

843 
	`WARN_ON
(
	`úqs_dißbÀd
());

845 
	`¥_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
˝u
);

847 i‡(
≠icid
 =
BAD_APICID
 ||ápicid =
boŸ_˝u_physiˇl_≠icid
 ||

848 !
	`physid_is£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
)) {

849 
	`¥ötk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
˝u
);

850  -
EINVAL
;

856 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

857 
	`¥_debug
("do_boŸ_˝u %d AÃódy sèπed\n", 
˝u
);

858  -
ENOSYS
;

865 
	`mår_ßve_°©e
();

867 
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë
CPU_UP_PREPARE
;

869 #ifde‡
CONFIG_X86_32


871 
	`˛⁄e_pgd_ønge
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

872 
	`mö_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

873 
	`Êush_éb_Æl
();

874 
low_m≠pögs
 = 1;

876 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

878 
	`z≠_low_m≠pögs
(
Ál£
);

879 
low_m≠pögs
 = 0;

881 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

883 i‡(
îr
) {

884 
	`¥_debug
("do_boŸ_˝u faûed %d\n", 
îr
);

885  -
EIO
;

892 
	`loˇl_úq_ßve
(
Êags
);

893 
	`check_tsc_sync_sour˚
(
˝u
);

894 
	`loˇl_úq_ª°‹e
(
Êags
);

896 !
	`˝u_⁄löe
(
˝u
)) {

897 
	`˝u_ªœx
();

898 
	`touch_nmi_w©chdog
();

902 
	}
}

909 
__öô
 
	$dißbÀ_smp
()

911 
	`öô_˝u_¥e£¡
(
	`˝umask_of
(0));

912 
	`öô_˝u_possibÀ
(
	`˝umask_of
(0));

913 
	`smpboŸ_˛ór_io_≠ic_úqs
();

915 i‡(
smp_found_c⁄fig
)

916 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

918 
	`physid_£t_mask_of_physid
(0, &
phys_˝u_¥e£¡_m≠
);

919 
	`m≠_˝u_to_logiˇl_≠icid
();

920 
	`˝umask_£t_˝u
(0, 
	`˝u_siblög_mask
(0));

921 
	`˝umask_£t_˝u
(0, 
	`˝u_c‹e_mask
(0));

922 
	}
}

927 
__öô
 
	$smp_ßnôy_check
(
max_˝us
)

929 
	`¥ìm±_dißbÀ
();

931 #i‡!
	`deföed
(
CONFIG_X86_BIGSMP
Ë&& deföed(
CONFIG_X86_32
)

932 i‡(
def_to_bigsmp
 && 
ƒ_˝u_ids
 > 8) {

933 
˝u
;

934 
ƒ
;

936 
	`¥ötk
(
KERN_WARNING


940 
ƒ
 = 0;

941 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

942 i‡(
ƒ
 >= 8)

943 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

944 
ƒ
++;

947 
ƒ
 = 0;

948 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

949 i‡(
ƒ
 >= 8)

950 
	`£t_˝u_possibÀ
(
˝u
, 
Ál£
);

951 
ƒ
++;

954 
ƒ_˝u_ids
 = 8;

958 i‡(!
	`physid_is£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
)) {

959 
	`¥ötk
(
KERN_WARNING


961 
	`h¨d_smp_¥o˚ss‹_id
());

963 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

970 i‡(!
smp_found_c⁄fig
 && !
a˝i_œpic
) {

971 
	`¥ìm±_íabÀ
();

972 
	`¥ötk
(
KERN_NOTICE
 "SMP motherboardÇot detected.\n");

973 
	`dißbÀ_smp
();

974 i‡(
	`APIC_öô_unùro˚ss‹
())

975 
	`¥ötk
(
KERN_NOTICE
 "Local APICÇot detected."

984 i‡(!
≠ic
->
	`check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)) {

985 
	`¥ötk
(
KERN_NOTICE


987 
boŸ_˝u_physiˇl_≠icid
);

988 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

990 
	`¥ìm±_íabÀ
();

995 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]) &&

996 !
˝u_has_≠ic
) {

997 i‡(!
dißbÀ_≠ic
) {

998 
	`¥_îr
("BIOS bug,Üocal APIC #%dÇot detected!...\n",

999 
boŸ_˝u_physiˇl_≠icid
);

1000 
	`¥_îr
("... forcing use of dummy APICÉmulation."

1003 
	`smpboŸ_˛ór_io_≠ic
();

1004 
	`¨ch_dißbÀ_smp_suµ‹t
();

1008 
	`vîify_loˇl_APIC
();

1013 i‡(!
max_˝us
) {

1014 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

1015 
	`smpboŸ_˛ór_io_≠ic
();

1017 
	`loˇli£_nmi_w©chdog
();

1019 
	`c⁄√˘_b•_APIC
();

1020 
	`£tup_loˇl_APIC
();

1021 
	`íd_loˇl_APIC_£tup
();

1026 
	}
}

1028 
__öô
 
	$smp_˝u_ödex_deÁu…
()

1030 
i
;

1031 
˝uöfo_x86
 *
c
;

1033 
	`f‹_óch_possibÀ_˝u
(
i
) {

1034 
c
 = &
	`˝u_d©a
(
i
);

1036 
c
->
˝u_ödex
 = 
ƒ_˝u_ids
;

1038 
	}
}

1044 
__öô
 
	$«tive_smp_¥ï¨e_˝us
(
max_˝us
)

1046 
i
;

1048 
	`¥ìm±_dißbÀ
();

1049 
	`smp_˝u_ödex_deÁu…
();

1050 
cuºít_˝u_d©a
 = 
boŸ_˝u_d©a
;

1051 
	`˝umask_c›y
(
˝u_ˇŒö_mask
, 
	`˝umask_of
(0));

1052 
	`mb
();

1056 
	`smp_°‹e_˝u_öfo
(0);

1057 #ifde‡
CONFIG_X86_32


1058 
boŸ_˝u_logiˇl_≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

1060 
	`cuºít_thªad_öfo
()->
˝u
 = 0;

1061 
	`f‹_óch_possibÀ_˝u
(
i
) {

1062 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
), 
GFP_KERNEL
);

1063 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
), 
GFP_KERNEL
);

1064 
	`zÆloc_˝umask_v¨
(&
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
, 
GFP_KERNEL
);

1066 
	`£t_˝u_siblög_m≠
(0);

1068 
	`íabÀ_IR_x2≠ic
();

1069 #ifde‡
CONFIG_X86_64


1070 
	`deÁu…_£tup_≠ic_routög
();

1073 i‡(
	`smp_ßnôy_check
(
max_˝us
) < 0) {

1074 
	`¥ötk
(
KERN_INFO
 "SMP disabled\n");

1075 
	`dißbÀ_smp
();

1076 
out
;

1079 
	`¥ìm±_dißbÀ
();

1080 i‡(
	`ªad_≠ic_id
(Ë!
boŸ_˝u_physiˇl_≠icid
) {

1081 
	`∑nic
("Boot APIC ID inÜocal APIC unexpected (%d vs %d)",

1082 
	`ªad_≠ic_id
(), 
boŸ_˝u_physiˇl_≠icid
);

1085 
	`¥ìm±_íabÀ
();

1087 
	`c⁄√˘_b•_APIC
();

1092 
	`£tup_loˇl_APIC
();

1097 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1098 
	`íabÀ_IO_APIC
();

1100 
	`íd_loˇl_APIC_£tup
();

1102 
	`m≠_˝u_to_logiˇl_≠icid
();

1104 i‡(
≠ic
->
£tup_p‹tio_ªm≠
)

1105 
≠ic
->
	`£tup_p‹tio_ªm≠
();

1107 
	`smpboŸ_£tup_io_≠ic
();

1112 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 0);

1113 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(0));

1114 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1116 i‡(
	`is_uv_sy°em
())

1117 
	`uv_sy°em_öô
();

1119 
	`£t_mår_≠s_dñayed_öô
();

1120 
out
:

1121 
	`¥ìm±_íabÀ
();

1122 
	}
}

1124 
	$¨ch_íabÀ_n⁄boŸ_˝us_begö
()

1126 
	`£t_mår_≠s_dñayed_öô
();

1127 
	}
}

1129 
	$¨ch_íabÀ_n⁄boŸ_˝us_íd
()

1131 
	`mår_≠s_öô
();

1132 
	}
}

1137 
__öô
 
	$«tive_smp_¥ï¨e_boŸ_˝u
()

1139 
me
 = 
	`smp_¥o˚ss‹_id
();

1140 
	`swôch_to_√w_gdt
(
me
);

1142 
	`˝umask_£t_˝u
(
me
, 
˝u_ˇŒout_mask
);

1143 
	`≥r_˝u
(
˝u_°©e
, 
me
Ë
CPU_ONLINE
;

1144 
	}
}

1146 
__öô
 
	$«tive_smp_˝us_d⁄e
(
max_˝us
)

1148 
	`¥_debug
("Boot done.\n");

1150 
	`im¥ess_‰õnds
();

1151 #ifde‡
CONFIG_X86_IO_APIC


1152 
	`£tup_iﬂpic_de°
();

1154 
	`check_nmi_w©chdog
();

1155 
	`mår_≠s_öô
();

1156 
	}
}

1158 
__öôd©a
 
	g£tup_possibÀ_˝us
 = -1;

1159 
__öô
 
	$_£tup_possibÀ_˝us
(*
°r
)

1161 
	`gë_›ti⁄
(&
°r
, &
£tup_possibÀ_˝us
);

1163 
	}
}

1164 
óæy_∑øm
("possibÀ_˝us", 
_£tup_possibÀ_˝us
);

1184 
__öô
 
	$¥efûl_possibÀ_m≠
()

1186 
i
, 
possibÀ
;

1189 i‡(!
num_¥o˚ss‹s
)

1190 
num_¥o˚ss‹s
 = 1;

1192 i‡(
£tup_possibÀ_˝us
 == -1)

1193 
possibÀ
 = 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
;

1195 
possibÀ
 = 
£tup_possibÀ_˝us
;

1197 
tŸÆ_˝us
 = 
	`max_t
(, 
possibÀ
, 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
);

1199 i‡(
possibÀ
 > 
CONFIG_NR_CPUS
) {

1200 
	`¥ötk
(
KERN_WARNING


1202 
possibÀ
, 
CONFIG_NR_CPUS
);

1203 
possibÀ
 = 
CONFIG_NR_CPUS
;

1206 
	`¥ötk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1207 
possibÀ
, 
	`max_t
(,ÖossibÀ - 
num_¥o˚ss‹s
, 0));

1209 
i
 = 0; i < 
possibÀ
; i++)

1210 
	`£t_˝u_possibÀ
(
i
, 
åue
);

1212 
ƒ_˝u_ids
 = 
possibÀ
;

1213 
	}
}

1215 #ifde‡
CONFIG_HOTPLUG_CPU


1217 
	$ªmove_siblögöfo
(
˝u
)

1219 
siblög
;

1220 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

1222 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_c‹e_mask
(
˝u
)) {

1223 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
siblög
));

1227 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1)

1228 
	`˝u_d©a
(
siblög
).
boŸed_c‹es
--;

1231 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_siblög_mask
(
˝u
))

1232 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_siblög_mask
(
siblög
));

1233 
	`˝umask_˛ór
(
	`˝u_siblög_mask
(
˝u
));

1234 
	`˝umask_˛ór
(
	`˝u_c‹e_mask
(
˝u
));

1235 
c
->
phys_¥oc_id
 = 0;

1236 
c
->
˝u_c‹e_id
 = 0;

1237 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

1238 
	}
}

1240 
__ªf
 
	$ªmove_˝u_‰om_m≠s
(
˝u
)

1242 
	`£t_˝u_⁄löe
(
˝u
, 
Ál£
);

1243 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

1244 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒö_mask
);

1246 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

1247 
	`numa_ªmove_˝u
(
˝u
);

1248 
	}
}

1250 
	$˝u_dißbÀ_comm⁄
()

1252 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1259 
	`loˇl_úq_íabÀ
();

1260 
	`mdñay
(1);

1262 
	`loˇl_úq_dißbÀ
();

1263 
	`ªmove_siblögöfo
(
˝u
);

1266 
	`lock_ve˘‹_lock
();

1267 
	`ªmove_˝u_‰om_m≠s
(
˝u
);

1268 
	`u∆ock_ve˘‹_lock
();

1269 
	`fixup_úqs
();

1270 
	}
}

1272 
	$«tive_˝u_dißbÀ
()

1274 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1284 i‡(
˝u
 == 0)

1285  -
EBUSY
;

1287 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

1288 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

1289 
	`˛ór_loˇl_APIC
();

1291 
	`˝u_dißbÀ_comm⁄
();

1293 
	}
}

1295 
	$«tive_˝u_dõ
(
˝u
)

1298 
i
;

1300 
i
 = 0; i < 10; i++) {

1302 i‡(
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë=
CPU_DEAD
) {

1303 
	`¥ötk
(
KERN_INFO
 "CPU %d i†now ofÊöe\n", 
˝u
);

1304 i‡(1 =
	`num_⁄löe_˝us
())

1305 
	`Æã∫©ives_smp_swôch
(0);

1308 
	`m¶ìp
(100);

1310 
	`¥ötk
(
KERN_ERR
 "CPU %u didn'àdõ...\n", 
˝u
);

1311 
	}
}

1313 
	$∂ay_dód_comm⁄
()

1315 
	`idÀ_èsk_exô
();

1316 
	`ª£t_œzy_éb°©e
();

1317 
	`úq_˘x_exô
(
	`øw_smp_¥o˚ss‹_id
());

1318 
	`c1e_ªmove_˝u
(
	`øw_smp_¥o˚ss‹_id
());

1320 
	`mb
();

1322 
	`__gë_˝u_v¨
(
˝u_°©e
Ë
CPU_DEAD
;

1327 
	`loˇl_úq_dißbÀ
();

1328 
	}
}

1330 
	$«tive_∂ay_dód
()

1332 
	`∂ay_dód_comm⁄
();

1333 
	`tboŸ_shutdown
(
TB_SHUTDOWN_WFS
);

1334 
	`wbövd_hÆt
();

1335 
	}
}

1338 
	$«tive_˝u_dißbÀ
()

1340  -
ENOSYS
;

1341 
	}
}

1343 
	$«tive_˝u_dõ
(
˝u
)

1346 
	`BUG
();

1347 
	}
}

1349 
	$«tive_∂ay_dód
()

1351 
	`BUG
();

1352 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/uac˚ss.h
>

10 
	~<asm/°ackåa˚.h
>

12 
	$ßve_°ack_w¨nög
(*
d©a
, *
msg
)

14 
	}
}

17 
	$ßve_°ack_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

19 
	}
}

21 
	$ßve_°ack_°ack
(*
d©a
, *
«me
)

24 
	}
}

26 
	$ßve_°ack_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

28 
°ack_åa˚
 *
åa˚
 = 
d©a
;

29 i‡(!
ªlübÀ
)

31 i‡(
åa˚
->
skù
 > 0) {

32 
åa˚
->
skù
--;

35 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

36 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

37 
	}
}

40 
	$ßve_°ack_addªss_nosched
(*
d©a
, 
addr
, 
ªlübÀ
)

42 
°ack_åa˚
 *
åa˚
 = (°ack_åa˚ *)
d©a
;

43 i‡(!
ªlübÀ
)

45 i‡(
	`ö_sched_fun˘i⁄s
(
addr
))

47 i‡(
åa˚
->
skù
 > 0) {

48 
åa˚
->
skù
--;

51 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

53 
	}
}

55 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s
 = {

56 .
w¨nög
 = 
ßve_°ack_w¨nög
,

57 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

58 .
	g°ack
 = 
ßve_°ack_°ack
,

59 .
	gaddªss
 = 
ßve_°ack_addªss
,

62 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s_nosched
 = {

63 .
w¨nög
 = 
ßve_°ack_w¨nög
,

64 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

65 .
	g°ack
 = 
ßve_°ack_°ack
,

66 .
	gaddªss
 = 
ßve_°ack_addªss_nosched
,

72 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

74 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 0, &
ßve_°ack_›s
, 
åa˚
);

75 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

76 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

77 
	}
}

78 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚
);

80 
	$ßve_°ack_åa˚_bp
(
°ack_åa˚
 *
åa˚
, 
bp
)

82 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 
bp
, &
ßve_°ack_›s
, 
åa˚
);

83 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

84 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

85 
	}
}

87 
	$ßve_°ack_åa˚_tsk
(
èsk_°ru˘
 *
tsk
, 
°ack_åa˚
 *
åa˚
)

89 
	`dump_åa˚
(
tsk
, 
NULL
, NULL, 0, &
ßve_°ack_›s_nosched
, 
åa˚
);

90 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

91 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

92 
	}
}

93 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚_tsk
);

97 
	s°ack_‰ame
 {

98 c⁄° 
__u£r
 *
	m√xt_Â
;

99 
	mªt_addr
;

102 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

104 
ªt
;

106 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
Â
, (*
‰ame
)))

109 
ªt
 = 1;

110 
	`∑geÁu…_dißbÀ
();

111 i‡(
	`__c›y_‰om_u£r_ö©omic
(
‰ame
, 
Â
, (*frame)))

112 
ªt
 = 0;

113 
	`∑geÁu…_íabÀ
();

115  
ªt
;

116 
	}
}

118 
ölöe
 
	$__ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

120 c⁄° 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

121 c⁄° 
__u£r
 *
Â
 = (c⁄° __u£∏*)
ªgs
->
bp
;

123 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

124 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ªgs
->
ù
;

126 
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
) {

127 
°ack_‰ame
 
‰ame
;

129 
‰ame
.
√xt_Â
 = 
NULL
;

130 
‰ame
.
ªt_addr
 = 0;

131 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

133 i‡(()
Â
 < 
ªgs
->
•
)

135 i‡(
‰ame
.
ªt_addr
) {

136 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] =

137 
‰ame
.
ªt_addr
;

139 i‡(
Â
 =
‰ame
.
√xt_Â
)

141 
Â
 = 
‰ame
.
√xt_Â
;

143 
	}
}

145 
	$ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

150 i‡(
cuºít
->
mm
) {

151 
	`__ßve_°ack_åa˚_u£r
(
åa˚
);

153 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

154 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

155 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<löux/sched.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/±ø˚.h
>

7 
	~<asm/desc.h
>

9 
	$c⁄vît_ù_to_löór
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

11 
addr
, 
£g
;

13 
addr
 = 
ªgs
->
ù
;

14 
£g
 = 
ªgs
->
cs
 & 0xffff;

15 i‡(
	`v8086_mode
(
ªgs
)) {

16 
addr
 = (add∏& 0xffffË+ (
£g
 << 4);

17  
addr
;

26 i‡((
£g
 & 
SEGMENT_TI_MASK
Ë=
SEGMENT_LDT
) {

27 
desc_°ru˘
 *
desc
;

28 
ba£
;

30 
£g
 &= ~7UL;

32 
	`muãx_lock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

33 i‡(
	`u∆ikñy
((
£g
 >> 3Ë>
chûd
->
mm
->
c⁄ãxt
.
size
))

34 
addr
 = -1L;

36 
desc
 = 
chûd
->
mm
->
c⁄ãxt
.
ldt
 + 
£g
;

37 
ba£
 = 
	`gë_desc_ba£
(
desc
);

40 i‡(!
desc
->
d
)

41 
addr
 &= 0xffff;

42 
addr
 +
ba£
;

44 
	`muãx_u∆ock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

47  
addr
;

48 
	}
}

50 
	$is_£âög_å≠_Êag
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

52 
i
, 
c›õd
;

53 
›code
[15];

54 
addr
 = 
	`c⁄vît_ù_to_löór
(
chûd
, 
ªgs
);

56 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, 
›code
, (opcode), 0);

57 
i
 = 0; i < 
c›õd
; i++) {

58 
›code
[
i
]) {

75 #ifde‡
CONFIG_X86_64


77 i‡(
ªgs
->
cs
 !
__USER_CS
)

99 
	}
}

104 
	$íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

106 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

107 
oÊags
;

119 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
)))

120 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

127 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

129 
oÊags
 = 
ªgs
->
Êags
;

132 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

143 i‡(
	`is_£âög_å≠_Êag
(
chûd
, 
ªgs
)) {

144 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

152 i‡(
oÊags
 & 
X86_EFLAGS_TF
)

153  
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

155 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

158 
	}
}

163 
	$wrôe_debug˘lm§
(
èsk_°ru˘
 *
chûd
, 
vÆ
)

165 i‡(
chûd
->
thªad
.
debug˘lm§
 =
vÆ
)

168 
chûd
->
thªad
.
debug˘lm§
 = 
vÆ
;

170 i‡(
chûd
 !
cuºít
)

173 
	`upd©e_debug˘lm§
(
vÆ
);

174 
	}
}

179 
	$íabÀ_°ï
(
èsk_°ru˘
 *
chûd
, 
boﬁ
 
block
)

188 i‡(
	`íabÀ_sögÀ_°ï
(
chûd
Ë&& 
block
) {

189 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

190 
	`wrôe_debug˘lm§
(
chûd
,

191 
chûd
->
thªad
.
debug˘lm§
 | 
DEBUGCTLMSR_BTF
);

193 
	`wrôe_debug˘lm§
(
chûd
,

194 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

196 i‡(!
chûd
->
thªad
.
debug˘lm§
)

197 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

199 
	}
}

201 
	$u£r_íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

203 
	`íabÀ_°ï
(
chûd
, 0);

204 
	}
}

206 
	$u£r_íabÀ_block_°ï
(
èsk_°ru˘
 *
chûd
)

208 
	`íabÀ_°ï
(
chûd
, 1);

209 
	}
}

211 
	$u£r_dißbÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

216 
	`wrôe_debug˘lm§
(
chûd
,

217 
chûd
->
thªad
.
debug˘lm§
 & ~
DEBUGCTLMSR_BTF
);

219 i‡(!
chûd
->
thªad
.
debug˘lm§
)

220 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_DEBUGCTLMSR
);

223 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

226 i‡(
	`ã°_™d_˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
))

227 
	`èsk_±_ªgs
(
chûd
)->
Êags
 &~
X86_EFLAGS_TF
;

228 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/sysˇŒs.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/fs.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/£m.h
>

8 
	~<löux/msg.h
>

9 
	~<löux/shm.h
>

10 
	~<löux/°©.h
>

11 
	~<löux/mm™.h
>

12 
	~<löux/fûe.h
>

13 
	~<löux/ut¢ame.h
>

14 
	~<löux/≥rs⁄Æôy.h
>

15 
	~<löux/øndom.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/ü32.h
>

19 
	~<asm/sysˇŒs.h
>

21 
	$SYSCALL_DEFINE6
(
mm≠
, , 
addr
, , 
Àn
,

22 , 
¥Ÿ
, , 
Êags
,

23 , 
fd
, , 
off
)

25 
îr‹
;

26 
fûe
 *file;

28 
îr‹
 = -
EINVAL
;

29 i‡(
off
 & ~
PAGE_MASK
)

30 
out
;

32 
îr‹
 = -
EBADF
;

33 
fûe
 = 
NULL
;

34 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

35 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

36 
fûe
 = 
	`fgë
(
fd
);

37 i‡(!
fûe
)

38 
out
;

40 
	`down_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

41 
îr‹
 = 
	`do_mm≠_pgoff
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
off
 >> 
PAGE_SHIFT
);

42 
	`up_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

44 i‡(
fûe
)

45 
	`Âut
(
fûe
);

46 
out
:

47  
îr‹
;

48 
	}
}

50 
	$föd_°¨t_íd
(
Êags
, *
begö
,

51 *
íd
)

53 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
)) {

54 
√w_begö
;

62 *
begö
 = 0x40000000;

63 *
íd
 = 0x80000000;

64 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

65 
√w_begö
 = 
	`øndomize_ønge
(*
begö
, *begin + 0x02000000, 0);

66 i‡(
√w_begö
)

67 *
begö
 = 
√w_begö
;

70 *
begö
 = 
TASK_UNMAPPED_BASE
;

71 *
íd
 = 
TASK_SIZE
;

73 
	}
}

76 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

77 
Àn
, 
pgoff
, 
Êags
)

79 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

80 
vm_¨ó_°ru˘
 *
vma
;

81 
°¨t_addr
;

82 
begö
, 
íd
;

84 i‡(
Êags
 & 
MAP_FIXED
)

85  
addr
;

87 
	`föd_°¨t_íd
(
Êags
, &
begö
, &
íd
);

89 i‡(
Àn
 > 
íd
)

90  -
ENOMEM
;

92 i‡(
addr
) {

93 
addr
 = 
	`PAGE_ALIGN
(addr);

94 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

95 i‡(
íd
 - 
Àn
 >
addr
 &&

96 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

97  
addr
;

99 i‡(((
Êags
 & 
MAP_32BIT
Ë|| 
	`ã°_thªad_Êag
(
TIF_IA32
))

100 && 
Àn
 <
mm
->
ˇched_hﬁe_size
) {

101 
mm
->
ˇched_hﬁe_size
 = 0;

102 
mm
->
‰ì_¨ó_ˇche
 = 
begö
;

104 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

105 i‡(
addr
 < 
begö
)

106 
addr
 = 
begö
;

107 
°¨t_addr
 = 
addr
;

109 
fuŒ_£¨ch
:

110 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

112 i‡(
íd
 - 
Àn
 < 
addr
) {

117 i‡(
°¨t_addr
 !
begö
) {

118 
°¨t_addr
 = 
addr
 = 
begö
;

119 
mm
->
ˇched_hﬁe_size
 = 0;

120 
fuŒ_£¨ch
;

122  -
ENOMEM
;

124 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

128 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

129  
addr
;

131 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

132 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

134 
addr
 = 
vma
->
vm_íd
;

136 
	}
}

140 
	$¨ch_gë_unm≠≥d_¨ó_t›down
(
fûe
 *
fûp
, c⁄° 
addr0
,

141 c⁄° 
Àn
, c⁄° 
pgoff
,

142 c⁄° 
Êags
)

144 
vm_¨ó_°ru˘
 *
vma
;

145 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

146 
addr
 = 
addr0
;

149 i‡(
Àn
 > 
TASK_SIZE
)

150  -
ENOMEM
;

152 i‡(
Êags
 & 
MAP_FIXED
)

153  
addr
;

156 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
))

157 
bŸtomup
;

160 i‡(
addr
) {

161 
addr
 = 
	`PAGE_ALIGN
(addr);

162 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

163 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

164 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

165  
addr
;

169 i‡(
Àn
 <
mm
->
ˇched_hﬁe_size
) {

170 
mm
->
ˇched_hﬁe_size
 = 0;

171 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

175 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

178 i‡(
addr
 > 
Àn
) {

179 
vma
 = 
	`föd_vma
(
mm
, 
addr
-
Àn
);

180 i‡(!
vma
 || 
addr
 <vma->
vm_°¨t
)

182  
mm
->
‰ì_¨ó_ˇche
 = 
addr
-
Àn
;

185 i‡(
mm
->
mm≠_ba£
 < 
Àn
)

186 
bŸtomup
;

188 
addr
 = 
mm
->
mm≠_ba£
-
Àn
;

196 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

197 i‡(!
vma
 || 
addr
+
Àn
 <vma->
vm_°¨t
)

199  
mm
->
‰ì_¨ó_ˇche
 = 
addr
;

202 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

203 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

206 
addr
 = 
vma
->
vm_°¨t
-
Àn
;

207 } 
Àn
 < 
vma
->
vm_°¨t
);

209 
bŸtomup
:

216 
mm
->
ˇched_hﬁe_size
 = ~0UL;

217 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

218 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó
(
fûp
, 
addr0
, 
Àn
, 
pgoff
, 
Êags
);

222 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

223 
mm
->
ˇched_hﬁe_size
 = ~0UL;

225  
addr
;

226 
	}
}

229 
	$SYSCALL_DEFINE1
(
u«me
, 
√w_ut¢ame
 
__u£r
 *, 
«me
)

231 
îr
;

232 
	`down_ªad
(&
uts_£m
);

233 
îr
 = 
	`c›y_to_u£r
(
«me
, 
	`ut¢ame
(), (*name));

234 
	`up_ªad
(&
uts_£m
);

235 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
)

236 
îr
 |
	`c›y_to_u£r
(&
«me
->
machöe
, "i686", 5);

237  
îr
 ? -
EFAULT
 : 0;

238 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<löux/lökage.h
>

4 
	~<löux/sys.h
>

5 
	~<löux/ˇche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
ƒ
, 
sym
Ë
asmlökage
 
	`sym
(Ë;

	)

11 #unde‡
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni°d_64.h
>

14 #unde‡
__SYSCALL


15 
	#__SYSCALL
(
ƒ
, 
sym
Ë[ƒ] = sym,

	)

16 #unde‡
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ˇŒ_±r_t
)();

20 
	`sys_ni_sysˇŒ
();

22 c⁄° 
sys_ˇŒ_±r_t
 
sys_ˇŒ_èbÀ
[
__NR_sysˇŒ_max
+1] = {

27 [0 ... 
__NR_sysˇŒ_max
] = &
sys_ni_sysˇŒ
,

28 
	~<asm/uni°d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/•ölock.h
>

30 
	~<löux/°rög.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/dma-m≠pög.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<asm/t˚.h
>

35 
	~<asm/ˇlg¨y.h
>

36 
	~<asm/¥Ÿo.h
>

39 
ölöe
 
	$Êush_t˚
(* 
t˚addr
)

42 i‡(
˝u_has_˛Êush
)

43 
	`˛Êush
(
t˚addr
);

45 
	`wbövd
();

46 
	}
}

48 
	$t˚_buûd
(
iommu_èbÀ
 *
tbl
, 
ödex
,

49 
≈ages
, 
uaddr
, 
dúe˘i⁄
)

51 
u64
* 
ç
;

52 
u64
 
t
;

53 
u64
 
Ωn
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 i‡(
dúe˘i⁄
 !
DMA_TO_DEVICE
)

57 
t
 |(1 << 
TCE_WRITE_SHIFT
);

59 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

61 
≈ages
--) {

62 
Ωn
 = (
	`vút_to_bus
((*)
uaddr
)Ë>> 
PAGE_SHIFT
;

63 
t
 &~
TCE_RPN_MASK
;

64 
t
 |(
Ωn
 << 
TCE_RPN_SHIFT
);

66 *
ç
 = 
	`˝u_to_be64
(
t
);

67 
	`Êush_t˚
(
ç
);

69 
uaddr
 +
PAGE_SIZE
;

70 
ç
++;

72 
	}
}

74 
	$t˚_‰ì
(
iommu_èbÀ
 *
tbl
, 
ödex
, 
≈ages
)

76 
u64
* 
ç
;

78 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

80 
≈ages
--) {

81 *
ç
 = 
	`˝u_to_be64
(0);

82 
	`Êush_t˚
(
ç
);

83 
ç
++;

85 
	}
}

87 
ölöe
 
	$èbÀ_size_to_numbî_of_íåõs
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$t˚_èbÀ_£ç¨ms
(
pci_dev
 *
dev
, 
iommu_èbÀ
 *
tbl
)

99 
bôm≠sz
;

100 
bmµages
;

101 
ªt
;

103 
tbl
->
ô_bu¢o
 = 
dev
->
bus
->
numbî
;

106 
tbl
->
ô_size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

112 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
bôm≠sz
));

114 i‡(!
bmµages
) {

115 
	`¥ötk
(
KERN_ERR
 "Calgary: cannotállocate bitmap\n");

116 
ªt
 = -
ENOMEM
;

117 
d⁄e
;

120 
tbl
->
ô_m≠
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
ô_m≠
, 0, 
bôm≠sz
);

124 
tbl
->
ô_höt
 = 0;

126 
	`•ö_lock_öô
(&
tbl
->
ô_lock
);

130 
d⁄e
:

131  
ªt
;

132 
	}
}

134 
__öô
 
	$buûd_t˚_èbÀ
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

136 
iommu_èbÀ
 *
tbl
;

137 
ªt
;

139 i‡(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`¥ötk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kzÆloc
((
iommu_èbÀ
), 
GFP_KERNEL
);

146 i‡(!
tbl
) {

147 
	`¥ötk
(
KERN_ERR
 "Calgary:Érrorállocating iommu_table\n");

148 
ªt
 = -
ENOMEM
;

149 
d⁄e
;

152 
ªt
 = 
	`t˚_èbÀ_£ç¨ms
(
dev
, 
tbl
);

153 i‡(
ªt
)

154 
‰ì_tbl
;

156 
tbl
->
bb¨
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
‰ì_tbl
:

163 
	`k‰ì
(
tbl
);

164 
d⁄e
:

165  
ªt
;

166 
	}
}

168 * 
__öô
 
	$Æloc_t˚_èbÀ
()

170 
size
;

172 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

173 
size
 *
TCE_ENTRY_SIZE
;

175  
	`__Æloc_boŸmem_low
(
size
, size, 0);

176 
	}
}

178 
__öô
 
	$‰ì_t˚_èbÀ
(*
tbl
)

180 
size
;

182 i‡(!
tbl
)

185 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

186 
size
 *
TCE_ENTRY_SIZE
;

188 
	`‰ì_boŸmem
(
	`__∑
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/s‹t.h
>

14 
	~<löux/¶ab.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_ã°_d©a
;

45 
	$fudze_ex˚±i⁄_èbÀ
(*
m¨kî
, *
√w
)

47 
moduÀ
 *
mod
 = 
THIS_MODULE
;

48 
ex˚±i⁄_èbÀ_íåy
 *
exèbÀ
;

56 i‡(
mod
->
num_exíåõs
 > 1) {

57 
	`¥ötk
(
KERN_ERR
 "test_nx:Åoo manyÉxceptionÅableÉntries!\n");

58 
	`¥ötk
(
KERN_ERR
 "test_nx:ÅestÑesultsáreÇotÑeliable.\n");

61 
exèbÀ
 = (
ex˚±i⁄_èbÀ_íåy
 *)
mod
->extable;

62 
exèbÀ
[0].
ö¢
 = ()
√w
;

63 
	}
}

71 
foo_œbñ
();

80 
noölöe
 
	$ã°_addªss
(*
addªss
)

82 
ªsu…
;

85 
	`fudze_ex˚±i⁄_èbÀ
(&
foo_œbñ
, 
addªss
);

86 
ªsu…
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¶t
] "Ù" (
ªsu…
)

97 : [
Áke_code
] "r" (
addªss
), [
zîo
] "r" (0UL), "0" (
ªsu…
)

100 
	`fudze_ex˚±i⁄_èbÀ
(
addªss
, &
foo_œbñ
);

102 i‡(
ªsu…
)

103  -
ENODEV
;

105 
	}
}

107 
	gã°_d©a
 = 0xC3;

109 
	$ã°_NX
()

111 
ªt
 = 0;

113 
°ackcode
[] = {0xC3, 0x90, 0 };

114 *
hóp
;

116 
ã°_d©a
 = 0xC3;

118 
	`¥ötk
(
KERN_INFO
 "Testing NXÖrotection\n");

121 i‡(
	`ã°_addªss
(&
°ackcode
)) {

122 
	`¥ötk
(
KERN_ERR
 "test_nx: stack wasÉxecutable\n");

123 
ªt
 = -
ENODEV
;

128 
hóp
 = 
	`kmÆloc
(64, 
GFP_KERNEL
);

129 i‡(!
hóp
)

130  -
ENOMEM
;

131 
hóp
[0] = 0xC3;

133 i‡(
	`ã°_addªss
(
hóp
)) {

134 
	`¥ötk
(
KERN_ERR
 "test_nx: heap wasÉxecutable\n");

135 
ªt
 = -
ENODEV
;

137 
	`k‰ì
(
hóp
);

145 #ifde‡
CONFIG_DEBUG_RODATA


147 i‡(
rod©a_ã°_d©a
 != 0xC3) {

148 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
ªt
 = -
ENODEV
;

150 } i‡(
	`ã°_addªss
(&
rod©a_ã°_d©a
)) {

151 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata section isÉxecutable\n");

152 
ªt
 = -
ENODEV
;

158 i‡(
	`ã°_addªss
(&
ã°_d©a
)) {

159 
	`¥ötk
(
KERN_ERR
 "test_nx: .data section isÉxecutable\n");

160 
ªt
 = -
ENODEV
;

165 
	}
}

167 
	$ã°_exô
()

169 
	}
}

171 
moduÀ_öô
(
ã°_NX
);

172 
moduÀ_exô
(
ã°_exô
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forÅhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time.c

12 
	~<löux/˛ockchùs.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/time.h
>

15 
	~<löux/mˇ.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/x86_öô.h
>

19 
	~<asm/i8259.h
>

20 
	~<asm/i8253.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/time.h
>

25 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_X86_IO_APIC
)

26 
	gtimî_ack
;

29 #ifde‡
CONFIG_X86_64


30 vﬁ©ûê
__jiffõs
 
	g__£˘i⁄_jiffõs
 = 
INITIAL_JIFFIES
;

33 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

35 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

37 i‡(!
	`u£r_mode_vm
(
ªgs
Ë&& 
	`ö_lock_fun˘i⁄s
(
pc
)) {

38 #ifde‡
CONFIG_FRAME_POINTER


39  *(*)(
ªgs
->
bp
 + ());

41 *
•
 =

42 (*)
	`kî√l_°ack_poöãr
(
ªgs
);

48 i‡(
•
[0] >> 22)

49  
•
[0];

50 i‡(
•
[1] >> 22)

51  
•
[1];

54  
pc
;

55 
	}
}

56 
EXPORT_SYMBOL
(
¥ofûe_pc
);

61 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

64 
	`öc_úq_°©
(
úq0_úqs
);

67 i‡(
timî_ack
) {

73 
	`•ö_lock
(&
i8259A_lock
);

74 
	`outb
(0x0c, 
PIC_MASTER_OCW3
);

76 
	`öb
(
PIC_MASTER_POLL
);

77 
	`•ö_u∆ock
(&
i8259A_lock
);

80 
globÆ_˛ock_evít
->
	`evít_h™dÀr
(global_clock_event);

83 i‡(
MCA_bus
)

84 
	`outb_p
(
	`öb_p
(0x61)| 0x80, 0x61);

86  
IRQ_HANDLED
;

87 
	}
}

89 
úqa˘i⁄
 
	gúq0
 = {

90 .
h™dÀr
 = 
timî_öãºu±
,

91 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

92 .
	g«me
 = "timer"

95 
__öô
 
	$£tup_deÁu…_timî_úq
()

97 
	`£tup_úq
(0, &
úq0
);

98 
	}
}

101 
__öô
 
	$h≥t_time_öô
()

103 i‡(!
	`h≥t_íabÀ
())

104 
	`£tup_pô_timî
();

105 
	`£tup_deÁu…_timî_úq
();

106 
	}
}

108 
__öô
 
	$x86_œã_time_öô
()

110 
x86_öô
.
timîs
.
	`timî_öô
();

111 
	`tsc_öô
();

112 
	}
}

118 
__öô
 
	$time_öô
()

120 
œã_time_öô
 = 
x86_œã_time_öô
;

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/u£r.h
>

5 
	~<löux/ªg£t.h
>

7 
	~<asm/uac˚ss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy°em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/¥Ÿo.h
>

13 
	~<asm/sysˇŒs.h
>

15 
	~"és.h
"

20 
	$gë_‰ì_idx
()

22 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 i‡(
	`desc_em±y
(&
t
->
és_¨øy
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_és_desc
(
èsk_°ru˘
 *
p
, 
idx
,

32 c⁄° 
u£r_desc
 *
öfo
, 
n
)

34 
thªad_°ru˘
 *
t
 = &
p
->
thªad
;

35 
desc_°ru˘
 *
desc
 = &
t
->
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
˝u
;

41 
˝u
 = 
	`gë_˝u
();

43 
n
-- > 0) {

44 i‡(
	`LDT_em±y
(
öfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fûl_ldt
(
desc
, 
öfo
);

48 ++
öfo
;

49 ++
desc
;

52 i‡(
t
 =&
cuºít
->
thªad
)

53 
	`lﬂd_TLS
(
t
, 
˝u
);

55 
	`put_˝u
();

56 
	}
}

61 
	$do_£t_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_öfo
,

63 
ˇn_Æloˇã
)

65 
u£r_desc
 
öfo
;

67 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
u_öfo
, (info)))

68  -
EFAULT
;

70 i‡(
idx
 == -1)

71 
idx
 = 
öfo
.
íåy_numbî
;

77 i‡(
idx
 =-1 && 
ˇn_Æloˇã
) {

78 
idx
 = 
	`gë_‰ì_idx
();

79 i‡(
idx
 < 0)

80  
idx
;

81 i‡(
	`put_u£r
(
idx
, &
u_öfo
->
íåy_numbî
))

82  -
EFAULT
;

85 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_és_desc
(
p
, 
idx
, &
öfo
, 1);

91 
	}
}

93 
asmlökage
 
	$sys_£t_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

95 
ªt
 = 
	`do_£t_thªad_¨ó
(
cuºít
, -1, 
u_öfo
, 1);

96 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

97  
ªt
;

98 
	}
}

105 
	$fûl_u£r_desc
(
u£r_desc
 *
öfo
, 
idx
,

106 c⁄° 
desc_°ru˘
 *
desc
)

109 
	`mem£t
(
öfo
, 0, (*info));

110 
öfo
->
íåy_numbî
 = 
idx
;

111 
öfo
->
ba£_addr
 = 
	`gë_desc_ba£
(
desc
);

112 
öfo
->
limô
 = 
	`gë_desc_limô
(
desc
);

113 
öfo
->
£g_32bô
 = 
desc
->
d
;

114 
öfo
->
c⁄ã¡s
 = 
desc
->
ty≥
 >> 2;

115 
öfo
->
ªad_exec_⁄ly
 = !(
desc
->
ty≥
 & 2);

116 
öfo
->
limô_ö_∑ges
 = 
desc
->
g
;

117 
öfo
->
£g_nŸ_¥e£¡
 = !
desc
->
p
;

118 
öfo
->
u£abÀ
 = 
desc
->
avl
;

119 #ifde‡
CONFIG_X86_64


120 
öfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_gë_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_öfo
)

127 
u£r_desc
 
öfo
;

129 i‡(
idx
 =-1 && 
	`gë_u£r
(idx, &
u_öfo
->
íåy_numbî
))

130  -
EFAULT
;

132 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fûl_u£r_desc
(&
öfo
, 
idx
,

136 &
p
->
thªad
.
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 i‡(
	`c›y_to_u£r
(
u_öfo
, &
öfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlökage
 
	$sys_gë_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

145 
ªt
 = 
	`do_gë_thªad_¨ó
(
cuºít
, -1, 
u_öfo
);

146 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

147  
ªt
;

148 
	}
}

150 
	$ªg£t_és_a˘ive
(
èsk_°ru˘
 *
èrgë
,

151 c⁄° 
u£r_ªg£t
 *
ªg£t
)

153 
thªad_°ru˘
 *
t
 = &
èrgë
->
thªad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
és_¨øy
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$ªg£t_és_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

161 
pos
, 
cou¡
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 c⁄° 
desc_°ru˘
 *
és
;

166 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
cou¡
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /(
u£r_desc
);

172 
cou¡
 /(
u£r_desc
);

174 
és
 = &
èrgë
->
thªad
.
és_¨øy
[
pos
];

176 i‡(
kbuf
) {

177 
u£r_desc
 *
öfo
 = 
kbuf
;

178 
cou¡
-- > 0)

179 
	`fûl_u£r_desc
(
öfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
és
++);

182 
u£r_desc
 
__u£r
 *
u_öfo
 = 
ubuf
;

183 
cou¡
-- > 0) {

184 
u£r_desc
 
öfo
;

185 
	`fûl_u£r_desc
(&
öfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
és
++);

186 i‡(
	`__c›y_to_u£r
(
u_öfo
++, &
öfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$ªg£t_és_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
u£r_desc
 
öfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 c⁄° 
u£r_desc
 *
öfo
;

201 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
cou¡
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 i‡(
kbuf
)

207 
öfo
 = 
kbuf
;

208 i‡(
	`__c›y_‰om_u£r
(
öfobuf
, 
ubuf
, 
cou¡
))

209  -
EFAULT
;

211 
öfo
 = 
öfobuf
;

213 
	`£t_és_desc
(
èrgë
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
öfo
, 
cou¡
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<löux/nodemask.h
>

29 
	~<löux/mmz⁄e.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<asm/˝u.h
>

34 
DEFINE_PER_CPU
(
x86_˝u
, 
˝u_devi˚s
);

36 #ifde‡
CONFIG_HOTPLUG_CPU


37 
__ªf
 
	$¨ch_ªgi°î_˝u
(
num
)

48 i‡(
num
)

49 
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
.
hŸ∂uggabÀ
 = 1;

51  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

52 
	}
}

53 
EXPORT_SYMBOL
(
¨ch_ªgi°î_˝u
);

55 
	$¨ch_uƒegi°î_˝u
(
num
)

57 
	`uƒegi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¨ch_uƒegi°î_˝u
);

62 
__öô
 
	$¨ch_ªgi°î_˝u
(
num
)

64  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

65 
	}
}

68 
__öô
 
	$t›ﬁogy_öô
()

70 
i
;

72 #ifde‡
CONFIG_NUMA


73 
	`f‹_óch_⁄löe_node
(
i
)

74 
	`ªgi°î_⁄e_node
(
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
i
)

78 
	`¨ch_ªgi°î_˝u
(
i
);

81 
	}
}

82 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<löux/io.h
>

3 
	~<asm/åampﬁöe.h
>

4 
	~<asm/e820.h
>

6 #i‡
deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_ACPI_SLEEP
)

7 
	#__åampöô


	)

8 
	#__åampöôd©a


	)

10 
	#__åampöô
 
__˝uöô


	)

11 
	#__åampöôd©a
 
__˝uöôd©a


	)

15 *
__åampöôd©a
 
	gåampﬁöe_ba£
 = 
__va
(
TRAMPOLINE_BASE
);

17 
__öô
 
	$ª£rve_åampﬁöe_mem‹y
()

19 #ifde‡
CONFIG_X86_32


25 
	`ª£rve_óæy
(
PAGE_SIZE
, PAGE_SIZE + PAGE_SIZE, "EX TRAMPOLINE");

28 
	`ª£rve_óæy
(
TRAMPOLINE_BASE
, TRAMPOLINE_BASE + 
TRAMPOLINE_SIZE
,

30 
	}
}

37 
__åampöô
 
	$£tup_åampﬁöe
()

39 
	`mem˝y
(
åampﬁöe_ba£
, 
åampﬁöe_d©a
, 
TRAMPOLINE_SIZE
);

40  
	`vút_to_phys
(
åampﬁöe_ba£
);

41 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<löux/öãºu±.h
>

13 
	~<löux/kÆlsyms.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/k¥obes.h
>

16 
	~<löux/uac˚ss.h
>

17 
	~<löux/kdebug.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/±ø˚.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/î∫o.h
>

24 
	~<löux/kexec.h
>

25 
	~<löux/sched.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/öô.h
>

28 
	~<löux/bug.h
>

29 
	~<löux/nmi.h
>

30 
	~<löux/mm.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/io.h
>

34 #ifde‡
CONFIG_EISA


35 
	~<löux/i›‹t.h
>

36 
	~<löux/eiß.h
>

39 #ifde‡
CONFIG_MCA


40 
	~<löux/mˇ.h
>

43 #i‡
deföed
(
CONFIG_EDAC
)

44 
	~<löux/edac.h
>

47 
	~<asm/kmemcheck.h
>

48 
	~<asm/°ackåa˚.h
>

49 
	~<asm/¥o˚ss‹.h
>

50 
	~<asm/debugªg.h
>

51 
	~<asm/©omic.h
>

52 
	~<asm/sy°em.h
>

53 
	~<asm/å≠s.h
>

54 
	~<asm/desc.h
>

55 
	~<asm/i387.h
>

56 
	~<asm/m˚.h
>

58 
	~<asm/mach_å≠s.h
>

60 #ifde‡
CONFIG_X86_64


61 
	~<asm/x86_öô.h
>

62 
	~<asm/pgÆloc.h
>

63 
	~<asm/¥Ÿo.h
>

65 
	~<asm/¥o˚ss‹-Êags.h
>

66 
	~<asm/£tup.h
>

68 
asmlökage
 
sy°em_ˇŒ
();

71 
	gign‹e_Âu_úq
;

77 
g©e_desc
 
	gidt_èbÀ
[
NR_VECTORS
] 
	g__∑ge_Æig√d_d©a
 = { { { { 0, 0 } } }, };

80 
DECLARE_BITMAP
(
u£d_ve˘‹s
, 
NR_VECTORS
);

81 
EXPORT_SYMBOL_GPL
(
u£d_ve˘‹s
);

83 
	gign‹e_nmis
;

85 
ölöe
 
	$c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

87 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

88 
	`loˇl_úq_íabÀ
();

89 
	}
}

91 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

93 
	`öc_¥ìm±_cou¡
();

94 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

95 
	`loˇl_úq_íabÀ
();

96 
	}
}

98 
ölöe
 
	$c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

100 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

101 
	`loˇl_úq_dißbÀ
();

102 
	}
}

104 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

106 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

107 
	`loˇl_úq_dißbÀ
();

108 
	`dec_¥ìm±_cou¡
();

109 
	}
}

111 #ifde‡
CONFIG_X86_32


112 
ölöe
 

113 
	$dõ_if_kî√l
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

115 i‡(!
	`u£r_mode_vm
(
ªgs
))

116 
	`dõ
(
°r
, 
ªgs
, 
îr
);

117 
	}
}

120 
__k¥obes


121 
	$do_å≠
(
å≠ƒ
, 
sigƒ
, *
°r
, 
±_ªgs
 *
ªgs
,

122 
îr‹_code
, 
sigöfo_t
 *
öfo
)

124 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

126 #ifde‡
CONFIG_X86_32


127 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

132 i‡(
å≠ƒ
 < 6)

133 
vm86_å≠
;

134 
å≠_sig«l
;

138 i‡(!
	`u£r_mode
(
ªgs
))

139 
kî√l_å≠
;

141 #ifde‡
CONFIG_X86_32


142 
å≠_sig«l
:

153 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

154 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

156 #ifde‡
CONFIG_X86_64


157 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
sigƒ
) &&

158 
	`¥ötk_øãlimô
()) {

159 
	`¥ötk
(
KERN_INFO


161 
tsk
->
comm
,Åsk->
pid
, 
°r
,

162 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

163 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

164 
	`¥ötk
("\n");

168 i‡(
öfo
)

169 
	`f‹˚_sig_öfo
(
sigƒ
, 
öfo
, 
tsk
);

171 
	`f‹˚_sig
(
sigƒ
, 
tsk
);

174 
kî√l_å≠
:

175 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

176 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

177 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

178 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

182 #ifde‡
CONFIG_X86_32


183 
vm86_å≠
:

184 i‡(
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

185 
îr‹_code
, 
å≠ƒ
))

186 
å≠_sig«l
;

189 
	}
}

191 
	#DO_ERROR
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
) \

192 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

194 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

195 =
NOTIFY_STOP
) \

197 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

198 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, 
NULL
); \

199 }

	)

201 
	#DO_ERROR_INFO
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
, 
sicode
, 
süddr
) \

202 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

204 
sigöfo_t
 
öfo
; \

205 
öfo
.
si_signo
 = 
sigƒ
; \

206 
öfo
.
si_î∫o
 = 0; \

207 
öfo
.
si_code
 = 
sicode
; \

208 
öfo
.
si_addr
 = (
__u£r
 *)
süddr
; \

209 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

210 =
NOTIFY_STOP
) \

212 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

213 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, &
öfo
); \

214 }

	)

216 
DO_ERROR_INFO
(0, 
SIGFPE
, "dividêîr‹", 
divide_îr‹
, 
FPE_INTDIV
, 
ªgs
->
ù
)

217 
DO_ERROR
(4, 
SIGSEGV
, "ovîÊow", 
ovîÊow
)

218 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

219 
DO_ERROR_INFO
(6, 
SIGILL
, "övÆid opcode", 
övÆid_›
, 
ILL_ILLOPN
, 
ªgs
->
ù
)

220 
DO_ERROR
(9, 
SIGFPE
, "c›ro˚ss‹ segmíàovîrun", 
c›ro˚ss‹_£gmít_ovîrun
)

221 
DO_ERROR
(10, 
SIGSEGV
, "övÆid TSS", 
övÆid_TSS
)

222 
DO_ERROR
(11, 
SIGBUS
, "£gmíànŸÖª£¡", 
£gmít_nŸ_¥e£¡
)

223 #ifde‡
CONFIG_X86_32


224 
DO_ERROR
(12, 
SIGBUS
, "°ack segmít", 
°ack_£gmít
)

226 
DO_ERROR_INFO
(17, 
SIGBUS
, "Æignmíàcheck", 
Æignmít_check
, 
BUS_ADRALN
, 0)

228 #ifde‡
CONFIG_X86_64


230 
dŸø∂ökage
 
	$do_°ack_£gmít
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

232 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "°ack segmít", 
ªgs
, 
îr‹_code
,

233 12, 
SIGBUS
Ë=
NOTIFY_STOP
)

235 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

236 
	`do_å≠
(12, 
SIGBUS
, "°ack segmít", 
ªgs
, 
îr‹_code
, 
NULL
);

237 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

238 
	}
}

240 
dŸø∂ökage
 
	$do_doubÀ_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

242 c⁄° 
°r
[] = "double fault";

243 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

246 
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 8, 
SIGSEGV
);

248 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

249 
tsk
->
thªad
.
å≠_no
 = 8;

256 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

257 
	}
}

260 
dŸø∂ökage
 
__k¥obes


261 
	$do_gíîÆ_¥Ÿe˘i⁄
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

263 
èsk_°ru˘
 *
tsk
;

265 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

267 #ifde‡
CONFIG_X86_32


268 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

269 
gp_ö_vm86
;

272 
tsk
 = 
cuºít
;

273 i‡(!
	`u£r_mode
(
ªgs
))

274 
gp_ö_kî√l
;

276 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

277 
tsk
->
thªad
.
å≠_no
 = 13;

279 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
) &&

280 
	`¥ötk_øãlimô
()) {

281 
	`¥ötk
(
KERN_INFO


283 
tsk
->
comm
, 
	`èsk_pid_ƒ
(tsk),

284 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

285 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

286 
	`¥ötk
("\n");

289 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

292 #ifde‡
CONFIG_X86_32


293 
gp_ö_vm86
:

294 
	`loˇl_úq_íabÀ
();

295 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
);

299 
gp_ö_kî√l
:

300 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

303 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

304 
tsk
->
thªad
.
å≠_no
 = 13;

305 i‡(
	`nŸify_dõ
(
DIE_GPF
, "gíîÆÖrŸe˘i⁄ fau…", 
ªgs
,

306 
îr‹_code
, 13, 
SIGSEGV
Ë=
NOTIFY_STOP
)

308 
	`dõ
("gíîÆÖrŸe˘i⁄ fau…", 
ªgs
, 
îr‹_code
);

309 
	}
}

311 
nŸø˚
 
__k¥obes
 

312 
	$mem_∑rôy_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

314 
	`¥ötk
(
KERN_EMERG


316 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

318 
	`¥ötk
(
KERN_EMERG


321 #i‡
	`deföed
(
CONFIG_EDAC
)

322 i‡(
	`edac_h™dÀr_£t
()) {

323 
	`edac_©omic_as£π_îr‹
();

328 i‡(
∑nic_⁄_uƒecovîed_nmi
)

329 
	`∑nic
("NMI: Not continuing");

331 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

334 
ªas⁄
 = (reason & 0xf) | 4;

335 
	`outb
(
ªas⁄
, 0x61);

336 
	}
}

338 
nŸø˚
 
__k¥obes
 

339 
	$io_check_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

341 
i
;

343 
	`¥ötk
(
KERN_EMERG
 "NMI: IOCKÉrror (debug interrupt?)\n");

344 
	`show_ªgi°îs
(
ªgs
);

346 i‡(
∑nic_⁄_io_nmi
)

347 
	`∑nic
("NMI IOCKÉrror: Not continuing");

350 
ªas⁄
 = (reason & 0xf) | 8;

351 
	`outb
(
ªas⁄
, 0x61);

353 
i
 = 2000;

354 --
i
)

355 
	`udñay
(1000);

357 
ªas⁄
 &= ~8;

358 
	`outb
(
ªas⁄
, 0x61);

359 
	}
}

361 
nŸø˚
 
__k¥obes
 

362 
	$unknown_nmi_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

364 i‡(
	`nŸify_dõ
(
DIE_NMIUNKNOWN
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
) ==

365 
NOTIFY_STOP
)

367 #ifde‡
CONFIG_MCA


372 i‡(
MCA_bus
) {

373 
	`mˇ_h™dÀ_nmi
();

377 
	`¥ötk
(
KERN_EMERG


379 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

381 
	`¥ötk
(
KERN_EMERG
 "Do you haveá strangeÖower saving modeÉnabled?\n");

382 i‡(
∑nic_⁄_uƒecovîed_nmi
)

383 
	`∑nic
("NMI: Not continuing");

385 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

386 
	}
}

388 
nŸø˚
 
__k¥obes
 
	$deÁu…_do_nmi
(
±_ªgs
 *
ªgs
)

390 
ªas⁄
 = 0;

391 
˝u
;

393 
˝u
 = 
	`smp_¥o˚ss‹_id
();

396 i‡(!
˝u
)

397 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

399 i‡(!(
ªas⁄
 & 0xc0)) {

400 i‡(
	`nŸify_dõ
(
DIE_NMI_IPI
, "nmi_ùi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

401 =
NOTIFY_STOP
)

403 #ifde‡
CONFIG_X86_LOCAL_APIC


408 i‡(
	`nmi_w©chdog_tick
(
ªgs
, 
ªas⁄
))

410 i‡(!
	`do_nmi_ˇŒback
(
ªgs
, 
˝u
))

411 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

413 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

418 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

422 i‡(
ªas⁄
 & 0x80)

423 
	`mem_∑rôy_îr‹
(
ªas⁄
, 
ªgs
);

424 i‡(
ªas⁄
 & 0x40)

425 
	`io_check_îr‹
(
ªas⁄
, 
ªgs
);

426 #ifde‡
CONFIG_X86_32


431 
	`ªas£π_nmi
();

433 
	}
}

435 
dŸø∂ökage
 
nŸø˚
 
__k¥obes
 

436 
	$do_nmi
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

438 
	`nmi_íãr
();

440 
	`öc_úq_°©
(
__nmi_cou¡
);

442 i‡(!
ign‹e_nmis
)

443 
	`deÁu…_do_nmi
(
ªgs
);

445 
	`nmi_exô
();

446 
	}
}

448 
	$°›_nmi
()

450 
	`a˝i_nmi_dißbÀ
();

451 
ign‹e_nmis
++;

452 
	}
}

454 
	$ª°¨t_nmi
()

456 
ign‹e_nmis
--;

457 
	`a˝i_nmi_íabÀ
();

458 
	}
}

461 
dŸø∂ökage
 
__k¥obes
 
	$do_öt3
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

463 #ifde‡
CONFIG_KPROBES


464 i‡(
	`nŸify_dõ
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

465 =
NOTIFY_STOP
)

468 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

469 =
NOTIFY_STOP
)

473 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

474 
	`do_å≠
(3, 
SIGTRAP
, "öt3", 
ªgs
, 
îr‹_code
, 
NULL
);

475 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

476 
	}
}

478 #ifde‡
CONFIG_X86_64


484 
asmlökage
 
__k¥obes
 
±_ªgs
 *
	$sync_ªgs
(
±_ªgs
 *
îegs
)

486 
±_ªgs
 *
ªgs
 = 
îegs
;

488 i‡(
îegs
 =(
±_ªgs
 *Îªgs->
•
)

491 i‡(
	`u£r_mode
(
îegs
))

492 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

497 i‡(
îegs
->
Êags
 & 
X86_EFLAGS_IF
)

498 
ªgs
 = (
±_ªgs
 *)(
îegs
->
•
 -= (pt_regs));

499 i‡(
îegs
 !
ªgs
)

500 *
ªgs
 = *
îegs
;

501  
ªgs
;

502 
	}
}

529 
dŸø∂ökage
 
__k¥obes
 
	$do_debug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

531 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

532 
c⁄dôi⁄
;

533 
si_code
;

535 
	`gë_debugªg
(
c⁄dôi⁄
, 6);

538 i‡(
c⁄dôi⁄
 & 
DR_STEP
 && 
	`kmemcheck_å≠
(
ªgs
))

544 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_DEBUGCTLMSR
);

545 
tsk
->
thªad
.
debug˘lm§
 = 0;

547 i‡(
	`nŸify_dõ
(
DIE_DEBUG
, "debug", 
ªgs
, 
c⁄dôi⁄
, 
îr‹_code
,

548 
SIGTRAP
Ë=
NOTIFY_STOP
)

552 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

555 i‡(
c⁄dôi⁄
 & (
DR_TRAP0
|
DR_TRAP1
|
DR_TRAP2
|
DR_TRAP3
)) {

556 i‡(!
tsk
->
thªad
.
debugªg7
)

557 
˛ór_dr7
;

560 #ifde‡
CONFIG_X86_32


561 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

562 
debug_vm86
;

566 
tsk
->
thªad
.
debugªg6
 = 
c⁄dôi⁄
;

572 i‡(
c⁄dôi⁄
 & 
DR_STEP
) {

573 i‡(!
	`u£r_mode
(
ªgs
))

574 
˛ór_TF_ªíabÀ
;

577 
si_code
 = 
	`gë_si_code
(
c⁄dôi⁄
);

579 
	`£nd_sigå≠
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
);

585 
˛ór_dr7
:

586 
	`£t_debugªg
(0, 7);

587 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

590 #ifde‡
CONFIG_X86_32


591 
debug_vm86
:

593 
	`dec_¥ìm±_cou¡
();

594 
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
, 1);

595 
	`c⁄dôi⁄Æ_˛i
(
ªgs
);

599 
˛ór_TF_ªíabÀ
:

600 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_SINGLESTEP
);

601 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

602 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

604 
	}
}

606 #ifde‡
CONFIG_X86_64


607 
	$kî√l_m©h_îr‹
(
±_ªgs
 *
ªgs
, c⁄° *
°r
, 
å≠ƒ
)

609 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

612 
	`nŸify_dõ
(
DIE_GPF
, 
°r
, 
ªgs
, 0, 
å≠ƒ
, 
SIGFPE
);

614 
cuºít
->
thªad
.
å≠_no
 = 
å≠ƒ
;

615 
	`dõ
(
°r
, 
ªgs
, 0);

617 
	}
}

625 
	$m©h_îr‹
(
__u£r
 *
ù
)

627 
èsk_°ru˘
 *
èsk
;

628 
sigöfo_t
 
öfo
;

629 
cwd
, 
swd
, 
îr
;

634 
èsk
 = 
cuºít
;

635 
	`ßve_öô_Âu
(
èsk
);

636 
èsk
->
thªad
.
å≠_no
 = 16;

637 
èsk
->
thªad
.
îr‹_code
 = 0;

638 
öfo
.
si_signo
 = 
SIGFPE
;

639 
öfo
.
si_î∫o
 = 0;

640 
öfo
.
si_addr
 = 
ù
;

651 
cwd
 = 
	`gë_Âu_cwd
(
èsk
);

652 
swd
 = 
	`gë_Âu_swd
(
èsk
);

654 
îr
 = 
swd
 & ~
cwd
;

656 i‡(
îr
 & 0x001) {

662 
öfo
.
si_code
 = 
FPE_FLTINV
;

663 } i‡(
îr
 & 0x004) {

664 
öfo
.
si_code
 = 
FPE_FLTDIV
;

665 } i‡(
îr
 & 0x008) {

666 
öfo
.
si_code
 = 
FPE_FLTOVF
;

667 } i‡(
îr
 & 0x012) {

668 
öfo
.
si_code
 = 
FPE_FLTUND
;

669 } i‡(
îr
 & 0x020) {

670 
öfo
.
si_code
 = 
FPE_FLTRES
;

678 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

679 
	}
}

681 
dŸø∂ökage
 
	$do_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

683 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

685 #ifde‡
CONFIG_X86_32


686 
ign‹e_Âu_úq
 = 1;

688 i‡(!
	`u£r_mode
(
ªgs
) &&

689 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel x87 mathÉrror", 16))

693 
	`m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

694 
	}
}

696 
	$simd_m©h_îr‹
(
__u£r
 *
ù
)

698 
èsk_°ru˘
 *
èsk
;

699 
sigöfo_t
 
öfo
;

700 
mxc§
;

705 
èsk
 = 
cuºít
;

706 
	`ßve_öô_Âu
(
èsk
);

707 
èsk
->
thªad
.
å≠_no
 = 19;

708 
èsk
->
thªad
.
îr‹_code
 = 0;

709 
öfo
.
si_signo
 = 
SIGFPE
;

710 
öfo
.
si_î∫o
 = 0;

711 
öfo
.
si_code
 = 
__SI_FAULT
;

712 
öfo
.
si_addr
 = 
ù
;

719 
mxc§
 = 
	`gë_Âu_mxc§
(
èsk
);

720 ~((
mxc§
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

725 
öfo
.
si_code
 = 
FPE_FLTINV
;

729 
öfo
.
si_code
 = 
FPE_FLTUND
;

732 
öfo
.
si_code
 = 
FPE_FLTDIV
;

735 
öfo
.
si_code
 = 
FPE_FLTOVF
;

738 
öfo
.
si_code
 = 
FPE_FLTRES
;

741 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

742 
	}
}

744 
dŸø∂ökage
 

745 
	$do_simd_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

747 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

749 #ifde‡
CONFIG_X86_32


750 i‡(
˝u_has_xmm
) {

752 
ign‹e_Âu_úq
 = 1;

753 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

760 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

761 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *)
ªgs
, 
îr‹_code
);

764 
cuºít
->
thªad
.
å≠_no
 = 19;

765 
cuºít
->
thªad
.
îr‹_code
 =Érror_code;

766 
	`dõ_if_kî√l
("ˇchêÊush díõd", 
ªgs
, 
îr‹_code
);

767 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

769 i‡(!
	`u£r_mode
(
ªgs
) &&

770 
	`kî√l_m©h_îr‹
(
ªgs
, "kernel simd mathÉrror", 19))

772 
	`simd_m©h_îr‹
((
__u£r
 *)
ªgs
->
ù
);

774 
	}
}

776 
dŸø∂ökage
 

777 
	$do_•urious_öãºu±_bug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

779 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

782 
	`¥ötk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

784 
	}
}

786 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thîmÆ_öãºu±
()

788 
	}
}

790 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thªshﬁd_öãºu±
()

792 
	}
}

798 
	$__m©h_°©e_ª°‹e
()

800 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

801 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

806 i‡(
	`u∆ikñy
(
	`ª°‹e_Âu_checkög
(
tsk
))) {

807 
	`°ts
();

808 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

812 
thªad
->
°©us
 |
TS_USEDFPU
;

813 
tsk
->
Âu_cou¡î
++;

814 
	}
}

826 
asmlökage
 
	$m©h_°©e_ª°‹e
()

828 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

829 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

831 i‡(!
	`tsk_u£d_m©h
(
tsk
)) {

832 
	`loˇl_úq_íabÀ
();

836 i‡(
	`öô_Âu
(
tsk
)) {

840 
	`do_group_exô
(
SIGKILL
);

843 
	`loˇl_úq_dißbÀ
();

846 
	`˛ts
();

848 
	`__m©h_°©e_ª°‹e
();

849 
	}
}

850 
EXPORT_SYMBOL_GPL
(
m©h_°©e_ª°‹e
);

852 #i‚de‡
CONFIG_MATH_EMULATION


853 
	$m©h_emuœã
(
m©h_emu_öfo
 *
öfo
)

855 
	`¥ötk
(
KERN_EMERG


857 
	`¥ötk
(
KERN_EMERG
 "kûlög %s.\n", 
cuºít
->
comm
);

858 
	`f‹˚_sig
(
SIGFPE
, 
cuºít
);

859 
	`scheduÀ
();

860 
	}
}

863 
dŸø∂ökage
 
__k¥obes


864 
	$do_devi˚_nŸ_avaûabÀ
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

866 #ifde‡
CONFIG_X86_32


867 i‡(
	`ªad_¸0
(Ë& 
X86_CR0_EM
) {

868 
m©h_emu_öfo
 
öfo
 = { };

870 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

872 
öfo
.
ªgs
 =Ñegs;

873 
	`m©h_emuœã
(&
öfo
);

875 
	`m©h_°©e_ª°‹e
();

876 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

879 
	`m©h_°©e_ª°‹e
();

881 
	}
}

883 #ifde‡
CONFIG_X86_32


884 
dŸø∂ökage
 
	$do_úë_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

886 
sigöfo_t
 
öfo
;

887 
	`loˇl_úq_íabÀ
();

889 
öfo
.
si_signo
 = 
SIGILL
;

890 
öfo
.
si_î∫o
 = 0;

891 
öfo
.
si_code
 = 
ILL_BADSTK
;

892 
öfo
.
si_addr
 = 
NULL
;

893 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "iretÉxception",

894 
ªgs
, 
îr‹_code
, 32, 
SIGILL
Ë=
NOTIFY_STOP
)

896 
	`do_å≠
(32, 
SIGILL
, "úëÉx˚±i⁄", 
ªgs
, 
îr‹_code
, &
öfo
);

897 
	}
}

900 
__öô
 
	$å≠_öô
()

902 
i
;

904 #ifde‡
CONFIG_EISA


905 
__iomem
 *
p
 = 
	`óæy_i‹em≠
(0x0FFFD9, 4);

907 i‡(
	`ªadl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

908 
EISA_bus
 = 1;

909 
	`óæy_iounm≠
(
p
, 4);

912 
	`£t_öå_g©e
(0, &
divide_îr‹
);

913 
	`£t_öå_g©e_i°
(1, &
debug
, 
DEBUG_STACK
);

914 
	`£t_öå_g©e_i°
(2, &
nmi
, 
NMI_STACK
);

916 
	`£t_sy°em_öå_g©e_i°
(3, &
öt3
, 
DEBUG_STACK
);

918 
	`£t_sy°em_öå_g©e
(4, &
ovîÊow
);

919 
	`£t_öå_g©e
(5, &
bounds
);

920 
	`£t_öå_g©e
(6, &
övÆid_›
);

921 
	`£t_öå_g©e
(7, &
devi˚_nŸ_avaûabÀ
);

922 #ifde‡
CONFIG_X86_32


923 
	`£t_èsk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

925 
	`£t_öå_g©e_i°
(8, &
doubÀ_Áu…
, 
DOUBLEFAULT_STACK
);

927 
	`£t_öå_g©e
(9, &
c›ro˚ss‹_£gmít_ovîrun
);

928 
	`£t_öå_g©e
(10, &
övÆid_TSS
);

929 
	`£t_öå_g©e
(11, &
£gmít_nŸ_¥e£¡
);

930 
	`£t_öå_g©e_i°
(12, &
°ack_£gmít
, 
STACKFAULT_STACK
);

931 
	`£t_öå_g©e
(13, &
gíîÆ_¥Ÿe˘i⁄
);

932 
	`£t_öå_g©e
(14, &
∑ge_Áu…
);

933 
	`£t_öå_g©e
(15, &
•urious_öãºu±_bug
);

934 
	`£t_öå_g©e
(16, &
c›ro˚ss‹_îr‹
);

935 
	`£t_öå_g©e
(17, &
Æignmít_check
);

936 #ifde‡
CONFIG_X86_MCE


937 
	`£t_öå_g©e_i°
(18, &
machöe_check
, 
MCE_STACK
);

939 
	`£t_öå_g©e
(19, &
simd_c›ro˚ss‹_îr‹
);

942 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

943 
	`£t_bô
(
i
, 
u£d_ve˘‹s
);

945 #ifde‡
CONFIG_IA32_EMULATION


946 
	`£t_sy°em_öå_g©e
(
IA32_SYSCALL_VECTOR
, 
ü32_sysˇŒ
);

947 
	`£t_bô
(
IA32_SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

950 #ifde‡
CONFIG_X86_32


951 i‡(
˝u_has_fx§
) {

952 
	`¥ötk
(
KERN_INFO
 "Enabling fast FPU saveándÑestore... ");

953 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

954 
	`¥ötk
("done.\n");

956 i‡(
˝u_has_xmm
) {

957 
	`¥ötk
(
KERN_INFO


959 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

960 
	`¥ötk
("done.\n");

963 
	`£t_sy°em_å≠_g©e
(
SYSCALL_VECTOR
, &
sy°em_ˇŒ
);

964 
	`£t_bô
(
SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

970 
	`˝u_öô
();

972 
x86_öô
.
úqs
.
	`å≠_öô
();

973 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/timî.h
>

6 
	~<löux/a˝i_pmtmr.h
>

7 
	~<löux/˝u‰eq.h
>

8 
	~<löux/dmi.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/˛ocksour˚.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/timex.h
>

14 
	~<asm/h≥t.h
>

15 
	~<asm/timî.h
>

16 
	~<asm/vgtod.h
>

17 
	~<asm/time.h
>

18 
	~<asm/dñay.h
>

19 
	~<asm/hy≥rvis‹.h
>

20 
	~<asm/nmi.h
>

21 
	~<asm/x86_öô.h
>

23 
__ªad_mo°ly
 
	g˝u_khz
;

24 
EXPORT_SYMBOL
(
˝u_khz
);

26 
__ªad_mo°ly
 
	gtsc_khz
;

27 
EXPORT_SYMBOL
(
tsc_khz
);

32 
__ªad_mo°ly
 
	gtsc_un°abÀ
;

37 
__ªad_mo°ly
 
	gtsc_dißbÀd
 = -1;

39 
	gtsc_˛ocksour˚_ªlübÀ
;

43 
u64
 
	$«tive_sched_˛ock
()

45 
u64
 
this_off£t
;

55 i‡(
	`u∆ikñy
(
tsc_dißbÀd
)) {

57  (
jiffõs_64
 - 
INITIAL_JIFFIES
Ë* (1000000000 / 
HZ
);

61 
	`rdts˛l
(
this_off£t
);

64  
	`__cy˛es_2_ns
(
this_off£t
);

65 
	}
}

69 #ifde‡
CONFIG_PARAVIRT


70 
	$sched_˛ock
()

72  
	`∑øvút_sched_˛ock
();

73 
	}
}

76 
	$sched_˛ock
(Ë
	`__©åibuã__
((
	`Æüs
("native_sched_clock")));

79 
	$check_tsc_un°abÀ
()

81  
tsc_un°abÀ
;

82 
	}
}

83 
EXPORT_SYMBOL_GPL
(
check_tsc_un°abÀ
);

85 #ifde‡
CONFIG_X86_TSC


86 
__öô
 
	$nŸsc_£tup
(*
°r
)

88 
	`¥ötk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

90 
tsc_dißbÀd
 = 1;

92 
	}
}

98 
__öô
 
	$nŸsc_£tup
(*
°r
)

100 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_TSC
);

102 
	}
}

105 
__£tup
("nŸsc", 
nŸsc_£tup
);

107 
__öô
 
	$tsc_£tup
(*
°r
)

109 i‡(!
	`°rcmp
(
°r
, "reliable"))

110 
tsc_˛ocksour˚_ªlübÀ
 = 1;

112 
	}
}

114 
__£tup
("tsc=", 
tsc_£tup
);

116 
	#MAX_RETRIES
 5

	)

117 
	#SMI_TRESHOLD
 50000

	)

122 
u64
 
	$tsc_ªad_ªfs
(
u64
 *
p
, 
h≥t
)

124 
u64
 
t1
, 
t2
;

125 
i
;

127 
i
 = 0; i < 
MAX_RETRIES
; i++) {

128 
t1
 = 
	`gë_cy˛es
();

129 i‡(
h≥t
)

130 *
p
 = 
	`h≥t_ªadl
(
HPET_COUNTER
) & 0xFFFFFFFF;

132 *
p
 = 
	`a˝i_pm_ªad_óæy
();

133 
t2
 = 
	`gë_cy˛es
();

134 i‡((
t2
 - 
t1
Ë< 
SMI_TRESHOLD
)

135  
t2
;

137  
ULLONG_MAX
;

138 
	}
}

143 
	$ˇlc_h≥t_ªf
(
u64
 
dñètsc
, u64 
h≥t1
, u64 
h≥t2
)

145 
u64
 
tmp
;

147 i‡(
h≥t2
 < 
h≥t1
)

148 
h≥t2
 += 0x100000000ULL;

149 
h≥t2
 -
h≥t1
;

150 
tmp
 = ((
u64
)
h≥t2
 * 
	`h≥t_ªadl
(
HPET_PERIOD
));

151 
	`do_div
(
tmp
, 1000000);

152 
	`do_div
(
dñètsc
, 
tmp
);

154  (Ë
dñètsc
;

155 
	}
}

160 
	$ˇlc_pmtimî_ªf
(
u64
 
dñètsc
, u64 
pm1
, u64 
pm2
)

162 
u64
 
tmp
;

164 i‡(!
pm1
 && !
pm2
)

165  
ULONG_MAX
;

167 i‡(
pm2
 < 
pm1
)

168 
pm2
 +(
u64
)
ACPI_PM_OVRRUN
;

169 
pm2
 -
pm1
;

170 
tmp
 = 
pm2
 * 1000000000LL;

171 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

172 
	`do_div
(
dñètsc
, 
tmp
);

174  (Ë
dñètsc
;

175 
	}
}

177 
	#CAL_MS
 10

	)

178 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

179 
	#CAL_PIT_LOOPS
 1000

	)

181 
	#CAL2_MS
 50

	)

182 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

183 
	#CAL2_PIT_LOOPS
 5000

	)

193 
	$pô_ˇlibøã_tsc
(
u32
 
œtch
, 
ms
, 
lo›mö
)

195 
u64
 
tsc
, 
t1
, 
t2
, 
dñè
;

196 
tscmö
, 
tscmax
;

197 
pô˙t
;

200 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

207 
	`outb
(0xb0, 0x43);

208 
	`outb
(
œtch
 & 0xff, 0x42);

209 
	`outb
(
œtch
 >> 8, 0x42);

211 
tsc
 = 
t1
 = 
t2
 = 
	`gë_cy˛es
();

213 
pô˙t
 = 0;

214 
tscmax
 = 0;

215 
tscmö
 = 
ULONG_MAX
;

216 (
	`öb
(0x61) & 0x20) == 0) {

217 
t2
 = 
	`gë_cy˛es
();

218 
dñè
 = 
t2
 - 
tsc
;

219 
tsc
 = 
t2
;

220 i‡((Ë
dñè
 < 
tscmö
)

221 
tscmö
 = (Ë
dñè
;

222 i‡((Ë
dñè
 > 
tscmax
)

223 
tscmax
 = (Ë
dñè
;

224 
pô˙t
++;

236 i‡(
pô˙t
 < 
lo›mö
 || 
tscmax
 > 10 * 
tscmö
)

237  
ULONG_MAX
;

240 
dñè
 = 
t2
 - 
t1
;

241 
	`do_div
(
dñè
, 
ms
);

242  
dñè
;

243 
	}
}

280 
ölöe
 
	$pô_vîify_msb
(
vÆ
)

283 
	`öb
(0x42);

284  
	`öb
(0x42Ë=
vÆ
;

285 
	}
}

287 
ölöe
 
	$pô_ex≥˘_msb
(
vÆ
, 
u64
 *
ts˝
, *
dñèp
)

289 
cou¡
;

290 
u64
 
tsc
 = 0;

292 
cou¡
 = 0; count < 50000; count++) {

293 i‡(!
	`pô_vîify_msb
(
vÆ
))

295 
tsc
 = 
	`gë_cy˛es
();

297 *
dñèp
 = 
	`gë_cy˛es
(Ë- 
tsc
;

298 *
ts˝
 = 
tsc
;

304  
cou¡
 > 5;

305 
	}
}

313 
	#MAX_QUICK_PIT_MS
 25

	)

314 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

316 
	$quick_pô_ˇlibøã
()

318 
i
;

319 
u64
 
tsc
, 
dñè
;

320 
d1
, 
d2
;

323 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

334 
	`outb
(0xb0, 0x43);

337 
	`outb
(0xff, 0x42);

338 
	`outb
(0xff, 0x42);

346 
	`pô_vîify_msb
(0);

348 i‡(
	`pô_ex≥˘_msb
(0xff, &
tsc
, &
d1
)) {

349 
i
 = 1; i <
MAX_QUICK_PIT_ITERATIONS
; i++) {

350 i‡(!
	`pô_ex≥˘_msb
(0xff-
i
, &
dñè
, &
d2
))

356 
dñè
 -
tsc
;

357 i‡(
d1
+
d2
 >
dñè
 >> 11)

367 i‡(!
	`pô_vîify_msb
(0x„ - 
i
))

369 
suc˚ss
;

372 
	`¥ötk
("Fast TSC calibration failed\n");

375 
suc˚ss
:

391 
dñè
 +()(
d2
 - 
d1
)/2;

392 
dñè
 *
PIT_TICK_RATE
;

393 
	`do_div
(
dñè
, 
i
*256*1000);

394 
	`¥ötk
("Fast TSC calibration using PIT\n");

395  
dñè
;

396 
	}
}

401 
	$«tive_ˇlibøã_tsc
()

403 
u64
 
tsc1
, 
tsc2
, 
dñè
, 
ªf1
, 
ªf2
;

404 
tsc_pô_mö
 = 
ULONG_MAX
, 
tsc_ªf_mö
 = ULONG_MAX;

405 
Êags
, 
œtch
, 
ms
, 
Á°_ˇlibøã
;

406 
h≥t
 = 
	`is_h≥t_íabÀd
(), 
i
, 
lo›mö
;

408 
	`loˇl_úq_ßve
(
Êags
);

409 
Á°_ˇlibøã
 = 
	`quick_pô_ˇlibøã
();

410 
	`loˇl_úq_ª°‹e
(
Êags
);

411 i‡(
Á°_ˇlibøã
)

412  
Á°_ˇlibøã
;

440 
œtch
 = 
CAL_LATCH
;

441 
ms
 = 
CAL_MS
;

442 
lo›mö
 = 
CAL_PIT_LOOPS
;

444 
i
 = 0; i < 3; i++) {

445 
tsc_pô_khz
;

453 
	`loˇl_úq_ßve
(
Êags
);

454 
tsc1
 = 
	`tsc_ªad_ªfs
(&
ªf1
, 
h≥t
);

455 
tsc_pô_khz
 = 
	`pô_ˇlibøã_tsc
(
œtch
, 
ms
, 
lo›mö
);

456 
tsc2
 = 
	`tsc_ªad_ªfs
(&
ªf2
, 
h≥t
);

457 
	`loˇl_úq_ª°‹e
(
Êags
);

460 
tsc_pô_mö
 = 
	`mö
—sc_pô_mö, 
tsc_pô_khz
);

463 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
)

467 i‡(
tsc1
 =
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

470 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

471 i‡(
h≥t
)

472 
tsc2
 = 
	`ˇlc_h≥t_ªf
—sc2, 
ªf1
, 
ªf2
);

474 
tsc2
 = 
	`ˇlc_pmtimî_ªf
—sc2, 
ªf1
, 
ªf2
);

476 
tsc_ªf_mö
 = 
	`mö
—sc_ªf_mö, (Ë
tsc2
);

479 
dñè
 = ((
u64
Ë
tsc_pô_mö
) * 100;

480 
	`do_div
(
dñè
, 
tsc_ªf_mö
);

488 i‡(
dñè
 >= 90 && delta <= 110) {

489 
	`¥ötk
(
KERN_INFO


491 
h≥t
 ? "HPET" : "PMTIMER", 
i
 + 1);

492  
tsc_ªf_mö
;

501 i‡(
i
 =1 && 
tsc_pô_mö
 =
ULONG_MAX
) {

502 
œtch
 = 
CAL2_LATCH
;

503 
ms
 = 
CAL2_MS
;

504 
lo›mö
 = 
CAL2_PIT_LOOPS
;

511 i‡(
tsc_pô_mö
 =
ULONG_MAX
) {

513 
	`¥ötk
(
KERN_WARNING
 "TSC: UnableÅo calibrateágainst PIT\n");

516 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

517 
	`¥ötk
("TSC: NoÑeference (HPET/PMTIMER)ávailable\n");

522 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

523 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

529 
	`¥ötk
(
KERN_INFO
 "TSC: using %sÑeference calibration\n",

530 
h≥t
 ? "HPET" : "PMTIMER");

532  
tsc_ªf_mö
;

536 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

537 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

538  
tsc_pô_mö
;

542 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

543 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

545  
tsc_pô_mö
;

553 
	`¥ötk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

554 
h≥t
 ? "HPET" : "PMTIMER", 
tsc_pô_mö
, 
tsc_ªf_mö
);

555 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

556  
tsc_pô_mö
;

557 
	}
}

559 
	$ªˇlibøã_˝u_khz
()

561 #i‚de‡
CONFIG_SMP


562 
˝u_khz_ﬁd
 = 
˝u_khz
;

564 i‡(
˝u_has_tsc
) {

565 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

566 
˝u_khz
 = 
tsc_khz
;

567 
	`˝u_d©a
(0).
lo›s_≥r_jiffy
 =

568 
	`˝u‰eq_sˇÀ
(
	`˝u_d©a
(0).
lo›s_≥r_jiffy
,

569 
˝u_khz_ﬁd
, 
˝u_khz
);

572  -
ENODEV
;

574  -
ENODEV
;

576 
	}
}

578 
EXPORT_SYMBOL
(
ªˇlibøã_˝u_khz
);

603 
DEFINE_PER_CPU
(, 
cyc2ns
);

604 
DEFINE_PER_CPU
(, 
cyc2ns_off£t
);

606 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
)

608 
tsc_now
, 
ns_now
, *
off£t
;

609 
Êags
, *
sˇÀ
;

611 
	`loˇl_úq_ßve
(
Êags
);

612 
	`sched_˛ock_idÀ_¶ìp_evít
();

614 
sˇÀ
 = &
	`≥r_˝u
(
cyc2ns
, 
˝u
);

615 
off£t
 = &
	`≥r_˝u
(
cyc2ns_off£t
, 
˝u
);

617 
	`rdts˛l
(
tsc_now
);

618 
ns_now
 = 
	`__cy˛es_2_ns
(
tsc_now
);

620 i‡(
˝u_khz
) {

621 *
sˇÀ
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

622 *
off£t
 = 
ns_now
 - (
tsc_now
 * *
sˇÀ
 >> 
CYC2NS_SCALE_FACTOR
);

625 
	`sched_˛ock_idÀ_wakeup_evít
(0);

626 
	`loˇl_úq_ª°‹e
(
Êags
);

627 
	}
}

629 #ifde‡
CONFIG_CPU_FREQ


642 
	gªf_‰eq
;

643 
	glo›s_≥r_jiffy_ªf
;

644 
	gtsc_khz_ªf
;

646 
	$time_˝u‰eq_nŸifõr
(
nŸifõr_block
 *
nb
, 
vÆ
,

647 *
d©a
)

649 
˝u‰eq_‰eqs
 *
‰eq
 = 
d©a
;

650 *
Õj
;

652 i‡(
	`˝u_has
(&
	`˝u_d©a
(
‰eq
->
˝u
), 
X86_FEATURE_CONSTANT_TSC
))

655 
Õj
 = &
boŸ_˝u_d©a
.
lo›s_≥r_jiffy
;

656 #ifde‡
CONFIG_SMP


657 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

658 
Õj
 = &
	`˝u_d©a
(
‰eq
->
˝u
).
lo›s_≥r_jiffy
;

661 i‡(!
ªf_‰eq
) {

662 
ªf_‰eq
 = 
‰eq
->
ﬁd
;

663 
lo›s_≥r_jiffy_ªf
 = *
Õj
;

664 
tsc_khz_ªf
 = 
tsc_khz
;

666 i‡((
vÆ
 =
CPUFREQ_PRECHANGE
 && 
‰eq
->
ﬁd
 < fªq->
√w
) ||

667 (
vÆ
 =
CPUFREQ_POSTCHANGE
 && 
‰eq
->
ﬁd
 > fªq->
√w
) ||

668 (
vÆ
 =
CPUFREQ_RESUMECHANGE
)) {

669 *
Õj
 = 
	`˝u‰eq_sˇÀ
(
lo›s_≥r_jiffy_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

671 
tsc_khz
 = 
	`˝u‰eq_sˇÀ
(
tsc_khz_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

672 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

673 
	`m¨k_tsc_un°abÀ
("cpufreq changes");

676 
	`£t_cyc2ns_sˇÀ
(
tsc_khz
, 
‰eq
->
˝u
);

679 
	}
}

681 
nŸifõr_block
 
	gtime_˝u‰eq_nŸifõr_block
 = {

682 .
nŸifõr_ˇŒ
 = 
time_˝u‰eq_nŸifõr


685 
__öô
 
	$˝u‰eq_tsc
()

687 i‡(!
˝u_has_tsc
)

689 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

691 
	`˝u‰eq_ªgi°î_nŸifõr
(&
time_˝u‰eq_nŸifõr_block
,

692 
CPUFREQ_TRANSITION_NOTIFIER
);

694 
	}
}

696 
c‹e_öôˇŒ
(
˝u‰eq_tsc
);

702 
˛ocksour˚
 
	g˛ocksour˚_tsc
;

716 
cy˛e_t
 
	$ªad_tsc
(
˛ocksour˚
 *
cs
)

718 
cy˛e_t
 
ªt
 = (cy˛e_t)
	`gë_cy˛es
();

720  
ªt
 >
˛ocksour˚_tsc
.
cy˛e_œ°
 ?

721 
ªt
 : 
˛ocksour˚_tsc
.
cy˛e_œ°
;

722 
	}
}

724 #ifde‡
CONFIG_X86_64


725 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_tsc
()

727 
cy˛e_t
 
ªt
;

734 
	`rdtsc_b¨rõr
();

735 
ªt
 = (
cy˛e_t
)
	`vgë_cy˛es
();

736 
	`rdtsc_b¨rõr
();

738  
ªt
 >
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 ?

739 
ªt
 : 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

740 
	}
}

743 
	$ªsume_tsc
()

745 
˛ocksour˚_tsc
.
cy˛e_œ°
 = 0;

746 
	}
}

748 
˛ocksour˚
 
	g˛ocksour˚_tsc
 = {

749 .
«me
 = "tsc",

750 .
	gøtög
 = 300,

751 .
	gªad
 = 
ªad_tsc
,

752 .
	gªsume
 = 
ªsume_tsc
,

753 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

754 .
	gshi·
 = 22,

755 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

756 
CLOCK_SOURCE_MUST_VERIFY
,

757 #ifde‡
CONFIG_X86_64


758 .
	gvªad
 = 
vªad_tsc
,

762 
	$m¨k_tsc_un°abÀ
(*
ªas⁄
)

764 i‡(!
tsc_un°abÀ
) {

765 
tsc_un°abÀ
 = 1;

766 
	`¥ötk
(
KERN_INFO
 "M¨kög TSC un°abÀ duêtÿ%s\n", 
ªas⁄
);

768 i‡(
˛ocksour˚_tsc
.
mu…
)

769 
	`˛ocksour˚_m¨k_un°abÀ
(&
˛ocksour˚_tsc
);

771 
˛ocksour˚_tsc
.
Êags
 |
CLOCK_SOURCE_UNSTABLE
;

772 
˛ocksour˚_tsc
.
øtög
 = 0;

775 
	}
}

777 
EXPORT_SYMBOL_GPL
(
m¨k_tsc_un°abÀ
);

779 
__öô
 
	$dmi_m¨k_tsc_un°abÀ
(c⁄° 
dmi_sy°em_id
 *
d
)

781 
	`¥ötk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

782 
d
->
idít
);

783 
tsc_un°abÀ
 = 1;

785 
	}
}

788 
dmi_sy°em_id
 
__öôd©a
 
	gbad_tsc_dmi_èbÀ
[] = {

790 .
ˇŒback
 = 
dmi_m¨k_tsc_un°abÀ
,

791 .
	gidít
 = "IBM Thinkpad 380XD",

792 .
	gm©ches
 = {

793 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

794 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

800 
__öô
 
	$check_sy°em_tsc_ªlübÀ
()

802 #ifde‡
CONFIG_MGEODE_LX


804 
	#RTSC_SUSP
 0x100

	)

805 
ªs_low
, 
ªs_high
;

807 
	`rdm§_ß„
(
MSR_GEODE_BUSCONT_CONF0
, &
ªs_low
, &
ªs_high
);

809 i‡(
ªs_low
 & 
RTSC_SUSP
)

810 
tsc_˛ocksour˚_ªlübÀ
 = 1;

812 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

813 
tsc_˛ocksour˚_ªlübÀ
 = 1;

814 
	}
}

820 
__˝uöô
 
	$unsynchr⁄ized_tsc
()

822 i‡(!
˝u_has_tsc
 || 
tsc_un°abÀ
)

825 #ifde‡
CONFIG_SMP


826 i‡(
	`≠ic_is_˛u°îed_box
())

830 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

836 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
) {

838 i‡(
	`num_possibÀ_˝us
() > 1)

839 
tsc_un°abÀ
 = 1;

842  
tsc_un°abÀ
;

843 
	}
}

845 
__öô
 
	$öô_tsc_˛ocksour˚
()

847 
˛ocksour˚_tsc
.
mu…
 = 
	`˛ocksour˚_khz2mu…
(
tsc_khz
,

848 
˛ocksour˚_tsc
.
shi·
);

849 i‡(
tsc_˛ocksour˚_ªlübÀ
)

850 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_MUST_VERIFY
;

852 i‡(
	`check_tsc_un°abÀ
()) {

853 
˛ocksour˚_tsc
.
øtög
 = 0;

854 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_IS_CONTINUOUS
;

856 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_tsc
);

857 
	}
}

859 #ifde‡
CONFIG_X86_64


864 
	#TICK_COUNT
 100000000

	)

865 
__öô
 
	$ˇlibøã_˝u
()

867 
tsc_°¨t
, 
tsc_now
;

868 
i
, 
no_˘r_‰ì
;

869 
ev¡£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

870 
Êags
;

872 
i
 = 0; i < 4; i++)

873 i‡(
	`avaû_to_ª§v_≥rf˘r_nmi_bô
(
i
))

875 
no_˘r_‰ì
 = (
i
 == 4);

876 i‡(
no_˘r_‰ì
) {

877 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMDÖerfctrs busy ... "

879 
i
 = 3;

880 
	`rdm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

881 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

882 
	`rdm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

884 
	`ª£rve_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

885 
	`ª£rve_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

887 
	`loˇl_úq_ßve
(
Êags
);

889 
	`wrm§l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

890 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

891 
	`rdts˛
(
tsc_°¨t
);

893 
	`rdm§l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

894 
tsc_now
 = 
	`gë_cy˛es
();

895 } (
tsc_now
 - 
tsc_°¨t
Ë< 
TICK_COUNT
);

897 
	`loˇl_úq_ª°‹e
(
Êags
);

898 i‡(
no_˘r_‰ì
) {

899 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

900 
	`wrm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

901 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

903 
	`ªÀa£_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

904 
	`ªÀa£_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

907  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_°¨t
);

908 
	}
}

910 
ölöe
 
	$ˇlibøã_˝u
(Ë{  
˝u_khz
; 
	}
}

913 
__öô
 
	$tsc_öô
()

915 
u64
 
Õj
;

916 
˝u
;

918 
x86_öô
.
timîs
.
	`tsc_¥e_öô
();

920 i‡(!
˝u_has_tsc
)

923 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

924 
˝u_khz
 = 
tsc_khz
;

926 i‡(!
tsc_khz
) {

927 
	`m¨k_tsc_un°abÀ
("couldÇot calculate TSC khz");

931 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

932 (
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
))

933 
˝u_khz
 = 
	`ˇlibøã_˝u
();

935 
	`¥ötk
("Detected %lu.%03lu MHzÖrocessor.\n",

936 ()
˝u_khz
 / 1000,

937 ()
˝u_khz
 % 1000);

945 
	`f‹_óch_possibÀ_˝u
(
˝u
)

946 
	`£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
);

948 i‡(
tsc_dißbÀd
 > 0)

952 
tsc_dißbÀd
 = 0;

954 
Õj
 = ((
u64
)
tsc_khz
 * 1000);

955 
	`do_div
(
Õj
, 
HZ
);

956 
Õj_föe
 = 
Õj
;

958 
	`u£_tsc_dñay
();

960 
	`dmi_check_sy°em
(
bad_tsc_dmi_èbÀ
);

962 i‡(
	`unsynchr⁄ized_tsc
())

963 
	`m¨k_tsc_un°abÀ
("TSCs unsynchronized");

965 
	`check_sy°em_tsc_ªlübÀ
();

966 
	`öô_tsc_˛ocksour˚
();

967 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<löux/•ölock.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__˝uöôd©a
 
©omic_t
 
	g°¨t_cou¡
;

29 
__˝uöôd©a
 
©omic_t
 
	g°›_cou¡
;

36 
__˝uöôd©a
 
øw_•ölock_t
 
	gsync_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

38 
__˝uöôd©a
 
cy˛es_t
 
	gœ°_tsc
;

39 
__˝uöôd©a
 
cy˛es_t
 
	gmax_w¨p
;

40 
__˝uöôd©a
 
	gƒ_w¨ps
;

45 
__˝uöô
 
	$check_tsc_w¨p
()

47 
cy˛es_t
 
°¨t
, 
now
, 
¥ev
, 
íd
;

48 
i
;

50 
	`rdtsc_b¨rõr
();

51 
°¨t
 = 
	`gë_cy˛es
();

52 
	`rdtsc_b¨rõr
();

56 
íd
 = 
°¨t
 + 
tsc_khz
 * 20ULL;

57 
now
 = 
°¨t
;

59 
i
 = 0; ; i++) {

65 
	`__øw_•ö_lock
(&
sync_lock
);

66 
¥ev
 = 
œ°_tsc
;

67 
	`rdtsc_b¨rõr
();

68 
now
 = 
	`gë_cy˛es
();

69 
	`rdtsc_b¨rõr
();

70 
œ°_tsc
 = 
now
;

71 
	`__øw_•ö_u∆ock
(&
sync_lock
);

79 i‡(
	`u∆ikñy
(!(
i
 & 7))) {

80 i‡(
now
 > 
íd
 || 
i
 > 10000000)

82 
	`˝u_ªœx
();

83 
	`touch_nmi_w©chdog
();

89 i‡(
	`u∆ikñy
(
¥ev
 > 
now
)) {

90 
	`__øw_•ö_lock
(&
sync_lock
);

91 
max_w¨p
 = 
	`max
(max_w¨p, 
¥ev
 - 
now
);

92 
ƒ_w¨ps
++;

93 
	`__øw_•ö_u∆ock
(&
sync_lock
);

96 
	`WARN
(!(
now
-
°¨t
),

98 
now
-
°¨t
, 
íd
-start);

99 
	}
}

105 
__˝uöô
 
	$check_tsc_sync_sour˚
(
˝u
)

107 
˝us
 = 2;

113 i‡(
	`unsynchr⁄ized_tsc
())

116 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
)) {

117 
	`¥ötk_⁄˚
(
KERN_INFO
 "Skipping synchronization checksás TSC isÑeliable.\n");

121 
	`¥_öfo
("checking TSC synchronization [CPU#%d -> CPU#%d]:",

122 
	`smp_¥o˚ss‹_id
(), 
˝u
);

127 
	`©omic_£t
(&
°›_cou¡
, 0);

132 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
-1)

133 
	`˝u_ªœx
();

137 
	`©omic_öc
(&
°¨t_cou¡
);

139 
	`check_tsc_w¨p
();

141 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
-1)

142 
	`˝u_ªœx
();

144 i‡(
ƒ_w¨ps
) {

145 
	`¥ötk
("\n");

146 
	`¥_w¨nög
("Measured %Ld cycles TSC warp between CPUs, "

147 "tu∫ög of‡TSC clock.\n", 
max_w¨p
);

148 
	`m¨k_tsc_un°abÀ
("check_tsc_sync_source failed");

150 
	`¥ötk
("Öassed.\n");

156 
	`©omic_£t
(&
°¨t_cou¡
, 0);

157 
ƒ_w¨ps
 = 0;

158 
max_w¨p
 = 0;

159 
œ°_tsc
 = 0;

164 
	`©omic_öc
(&
°›_cou¡
);

165 
	}
}

170 
__˝uöô
 
	$check_tsc_sync_èrgë
()

172 
˝us
 = 2;

174 i‡(
	`unsynchr⁄ized_tsc
(Ë|| 
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

181 
	`©omic_öc
(&
°¨t_cou¡
);

182 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
)

183 
	`˝u_ªœx
();

185 
	`check_tsc_w¨p
();

190 
	`©omic_öc
(&
°›_cou¡
);

195 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
)

196 
	`˝u_ªœx
();

197 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<löux/öô.h
>

16 
	~<löux/pci_ids.h
>

17 
	~<löux/pci_ªgs.h
>

19 
	~<asm/≠ic.h
>

20 
	~<asm/pci-dúe˘.h
>

21 
	~<asm/io.h
>

22 
	~<asm/∑øvút.h
>

23 
	~<asm/£tup.h
>

25 #i‡
deföed
 
CONFIG_PCI
 && deföed 
CONFIG_PARAVIRT


32 
	$vsmp_ßve_Ê
()

34 
Êags
 = 
	`«tive_ßve_Ê
();

36 i‡(!(
Êags
 & 
X86_EFLAGS_IF
Ë|| (Êag†& 
X86_EFLAGS_AC
))

37 
Êags
 &~
X86_EFLAGS_IF
;

38  
Êags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ßve_Ê
);

42 
	$vsmp_ª°‹e_Ê
(
Êags
)

44 i‡(
Êags
 & 
X86_EFLAGS_IF
)

45 
Êags
 &~
X86_EFLAGS_AC
;

47 
Êags
 |
X86_EFLAGS_AC
;

48 
	`«tive_ª°‹e_Ê
(
Êags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ª°‹e_Ê
);

52 
	$vsmp_úq_dißbÀ
()

54 
Êags
 = 
	`«tive_ßve_Ê
();

56 
	`«tive_ª°‹e_Ê
((
Êags
 & ~
X86_EFLAGS_IF
Ë| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_dißbÀ
);

60 
	$vsmp_úq_íabÀ
()

62 
Êags
 = 
	`«tive_ßve_Ê
();

64 
	`«tive_ª°‹e_Ê
((
Êags
 | 
X86_EFLAGS_IF
Ë& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_íabÀ
);

68 
__öô_‹_moduÀ
 
	$vsmp_∑tch
(
u8
 
ty≥
, 
u16
 
˛obbîs
, *
ibuf
,

69 
addr
, 
Àn
)

71 
ty≥
) {

72 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_íabÀ
):

73 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_dißbÀ
):

74 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ßve_Ê
):

75 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ª°‹e_Ê
):

76  
	`∑øvút_∑tch_deÁu…
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

78  
	`«tive_∑tch
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

81 
	}
}

83 
__öô
 
	$£t_vsmp_pv_›s
()

85 
__iomem
 *
addªss
;

86 
ˇp
, 
˘l
, 
cfg
;

89 
cfg
 = 
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
addªss
 = 
	`óæy_i‹em≠
(
cfg
, 8);

91 
ˇp
 = 
	`ªadl
(
addªss
);

92 
˘l
 = 
	`ªadl
(
addªss
 + 4);

93 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ˇp
, 
˘l
);

95 i‡(
ˇp
 & 
˘l
 & (1 << 4)) {

97 
pv_úq_›s
.
úq_dißbÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_dißbÀ
);

98 
pv_úq_›s
.
úq_íabÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_íabÀ
);

99 
pv_úq_›s
.
ßve_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ßve_Ê
);

100 
pv_úq_›s
.
ª°‹e_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ª°‹e_Ê
);

101 
pv_öô_›s
.
∑tch
 = 
vsmp_∑tch
;

103 
˘l
 &= ~(1 << 4);

104 
	`wrôñ
(
˘l
, 
addªss
 + 4);

105 
˘l
 = 
	`ªadl
(
addªss
 + 4);

106 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: c⁄åﬁ sëÅo:0x%08x\n", 
˘l
);

109 
	`óæy_iounm≠
(
addªss
, 8);

110 
	}
}

112 
__öô
 
	$£t_vsmp_pv_›s
()

114 
	}
}

117 #ifde‡
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__öô
 
	$dëe˘_vsmp_box
()

122 
is_vsmp
 = 0;

124 i‡(!
	`óæy_pci_Ælowed
())

128 i‡(
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 i‡(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__öô
 
	$dëe˘_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__öô
 
	$vsmp_öô
()

154 
	`dëe˘_vsmp_box
();

155 i‡(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_›s
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<löux/time.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/jiffõs.h
>

29 
	~<löux/sys˘l.h
>

30 
	~<löux/˛ocksour˚.h
>

31 
	~<löux/gë˝u.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/smp.h
>

34 
	~<löux/nŸifõr.h
>

36 
	~<asm/vsysˇŒ.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/uni°d.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/î∫o.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gmít.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/t›ﬁogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysˇŒ
(
ƒ
) \

49 
	`__©åibuã__
 ((
unu£d
, 
	`__£˘i⁄__
(".vsysˇŒ_" #ƒ))Ë
nŸø˚


	)

50 
	#__sysˇŒ_˛obbî
 "r11","cx","mem‹y"

	)

58 
__vgë˝u_mode
 
	g__£˘i⁄_vgë˝u_mode
;

60 
vsysˇŒ_gtod_d©a
 
__vsysˇŒ_gtod_d©a
 
	g__£˘i⁄_vsysˇŒ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsys˘l_íabÀd
 = 1,

66 
	$upd©e_vsysˇŒ_tz
()

68 
Êags
;

70 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

72 
vsysˇŒ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

74 
	}
}

76 
	$upd©e_vsysˇŒ
(
time•ec
 *
wÆl_time
, 
˛ocksour˚
 *
˛ock
)

78 
Êags
;

80 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

82 
vsysˇŒ_gtod_d©a
.
˛ock
.
vªad
 = clock->vread;

83 
vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 = clock->cycle_last;

84 
vsysˇŒ_gtod_d©a
.
˛ock
.
mask
 = clock->mask;

85 
vsysˇŒ_gtod_d©a
.
˛ock
.
mu…
 = clock->mult;

86 
vsysˇŒ_gtod_d©a
.
˛ock
.
shi·
 = clock->shift;

87 
vsysˇŒ_gtod_d©a
.
wÆl_time_£c
 = 
wÆl_time
->
tv_£c
;

88 
vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
 = 
wÆl_time
->
tv_n£c
;

89 
vsysˇŒ_gtod_d©a
.
wÆl_to_m⁄Ÿ⁄ic
 = wall_to_monotonic;

90 
vsysˇŒ_gtod_d©a
.
wÆl_time_cﬂr£
 = 
	`__cuºít_kî√l_time
();

91 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

92 
	}
}

97 
__Æways_ölöe
 
	$do_gë_tz
(
timez⁄e
 * 
tz
)

99 *
tz
 = 
__vsysˇŒ_gtod_d©a
.
sys_tz
;

100 
	}
}

102 
__Æways_ölöe
 
	$gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

104 
ªt
;

105 
asm
 volatile("syscall"

106 : "˜" (
ªt
)

107 : "0" (
__NR_gëtimeofday
),"D" (
tv
),"S" (
tz
)

108 : 
__sysˇŒ_˛obbî
 );

109  
ªt
;

110 
	}
}

112 
__Æways_ölöe
 
	$time_sysˇŒ
(*
t
)

114 
£cs
;

115 
asm
 volatile("syscall"

116 : "˜" (
£cs
)

117 : "0" (
__NR_time
),"D" (
t
Ë: 
__sysˇŒ_˛obbî
);

118  
£cs
;

119 
	}
}

121 
__Æways_ölöe
 
	$do_vgëtimeofday
(
timevÆ
 * 
tv
)

123 
cy˛e_t
 
now
, 
ba£
, 
mask
, 
cy˛e_dñè
;

124 
£q
;

125 
mu…
, 
shi·
, 
n£c
;

126 
	`cy˛e_t
 (*
vªad
)();

128 
£q
 = 
	`ªad_£qbegö
(&
__vsysˇŒ_gtod_d©a
.
lock
);

130 
vªad
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.vread;

131 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
 || !
vªad
)) {

132 
	`gëtimeofday
(
tv
,
NULL
);

136 
now
 = 
	`vªad
();

137 
ba£
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

138 
mask
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mask;

139 
mu…
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mult;

140 
shi·
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.shift;

142 
tv
->
tv_£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_£c
;

143 
n£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
;

144 } 
	`ªad_£qªåy
(&
__vsysˇŒ_gtod_d©a
.
lock
, 
£q
));

147 
cy˛e_dñè
 = (
now
 - 
ba£
Ë& 
mask
;

149 
n£c
 +(
cy˛e_dñè
 * 
mu…
Ë>> 
shi·
;

151 
n£c
 >
NSEC_PER_SEC
) {

152 
tv
->
tv_£c
 += 1;

153 
n£c
 -
NSEC_PER_SEC
;

155 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

156 
	}
}

158 
	$__vsysˇŒ
(0Ë
	$vgëtimeofday
(
timevÆ
 * 
tv
, 
timez⁄e
 * 
tz
)

160 i‡(
tv
)

161 
	`do_vgëtimeofday
(
tv
);

162 i‡(
tz
)

163 
	`do_gë_tz
(
tz
);

165 
	}
}

169 
time_t
 
	$__vsysˇŒ
(1Ë
	$vtime
(
time_t
 *
t
)

171 
timevÆ
 
tv
;

172 
time_t
 
ªsu…
;

173 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
))

174  
	`time_sysˇŒ
(
t
);

176 
	`vgëtimeofday
(&
tv
, 
NULL
);

177 
ªsu…
 = 
tv
.
tv_£c
;

178 i‡(
t
)

179 *
t
 = 
ªsu…
;

180  
ªsu…
;

181 
	}
}

191 
	$__vsysˇŒ
(2)

192 
	$vgë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

194 
p
;

195 
j
 = 0;

205 i‡(
tˇche
 &&Åˇche->
blob
[0] =(
j
 = 
__jiffõs
)) {

206 
p
 = 
tˇche
->
blob
[1];

207 } i‡(
__vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

209 
	`«tive_ªad_ts˝
(&
p
);

212 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

214 i‡(
tˇche
) {

215 
tˇche
->
blob
[0] = 
j
;

216 
tˇche
->
blob
[1] = 
p
;

218 i‡(
˝u
)

219 *
˝u
 = 
p
 & 0xfff;

220 i‡(
node
)

221 *
node
 = 
p
 >> 12;

223 
	}
}

225 
	$__vsysˇŒ
(3Ë
	$víosys_1
()

227  -
ENOSYS
;

228 
	}
}

230 #ifde‡
CONFIG_SYSCTL


231 
˘l_èbÀ
 
	gkî√l_èbÀ2
[] = {

232 { .
¥o˙ame
 = "vsyscall64",

233 .
	gd©a
 = &
vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
, .
	gmaxÀn
 = (),

234 .
	gmode
 = 0644,

235 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
 },

239 
˘l_èbÀ
 
	gkî√l_roŸ_èbÀ2
[] = {

240 { .
˘l_«me
 = 
CTL_KERN
, .
	g¥o˙ame
 = "kî√l", .
	gmode
 = 0555,

241 .
	gchûd
 = 
kî√l_èbÀ2
 },

248 
__˝uöô
 
	$vsysˇŒ_£t_˝u
(
˝u
)

250 
d
;

251 
node
 = 0;

252 #ifde‡
CONFIG_NUMA


253 
node
 = 
	`˝u_to_node
(
˝u
);

255 i‡(
	`˝u_has
(&
	`˝u_d©a
(
˝u
), 
X86_FEATURE_RDTSCP
))

256 
	`wrôe_rdts˝_aux
((
node
 << 12Ë| 
˝u
);

261 
d
 = 0x0f40000000000ULL;

262 
d
 |
˝u
;

263 
d
 |(
node
 & 0xf) << 12;

264 
d
 |(
node
 >> 4) << 48;

265 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

266 
	}
}

268 
__˝uöô
 
	$˝u_vsysˇŒ_öô
(*
¨g
)

271 
	`vsysˇŒ_£t_˝u
(
	`øw_smp_¥o˚ss‹_id
());

272 
	}
}

274 
__˝uöô


275 
	$˝u_vsysˇŒ_nŸifõr
(
nŸifõr_block
 *
n
, 
a˘i⁄
, *
¨g
)

277 
˝u
 = ()
¨g
;

278 i‡(
a˘i⁄
 =
CPU_ONLINE
 ||á˘i⁄ =
CPU_ONLINE_FROZEN
)

279 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝u_vsysˇŒ_öô
, 
NULL
, 1);

280  
NOTIFY_DONE
;

281 
	}
}

283 
__öô
 
	$m≠_vsysˇŒ
()

285 
__vsysˇŒ_0
;

286 
phyßddr_∑ge0
 = 
	`__∑_symbﬁ
(&
__vsysˇŒ_0
);

289 
	`__£t_fixm≠
(
VSYSCALL_FIRST_PAGE
, 
phyßddr_∑ge0
, 
PAGE_KERNEL_VSYSCALL
);

290 
	}
}

292 
__öô
 
	$vsysˇŒ_öô
()

294 
	`BUG_ON
(((Ë&
vgëtimeofday
 !=

295 
	`VSYSCALL_ADDR
(
__NR_vgëtimeofday
)));

296 
	`BUG_ON
((Ë&
vtime
 !
	`VSYSCALL_ADDR
(
__NR_vtime
));

297 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0Ë!
	`__fix_to_vút
(
VSYSCALL_FIRST_PAGE
)));

298 
	`BUG_ON
((Ë&
vgë˝u
 !
	`VSYSCALL_ADDR
(
__NR_vgë˝u
));

299 #ifde‡
CONFIG_SYSCTL


300 
	`ªgi°î_sys˘l_èbÀ
(
kî√l_roŸ_èbÀ2
);

302 
	`⁄_óch_˝u
(
˝u_vsysˇŒ_öô
, 
NULL
, 1);

303 
	`hŸ˝u_nŸifõr
(
˝u_vsysˇŒ_nŸifõr
, 0);

305 
	}
}

307 
__öôˇŒ
(
vsysˇŒ_öô
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/smp.h
>

7 
	~<√t/checksum.h
>

9 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/uac˚ss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/·ø˚.h
>

15 #ifde‡
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcou¡
);

20 
EXPORT_SYMBOL
(
kî√l_thªad
);

22 
EXPORT_SYMBOL
(
__gë_u£r_1
);

23 
EXPORT_SYMBOL
(
__gë_u£r_2
);

24 
EXPORT_SYMBOL
(
__gë_u£r_4
);

25 
EXPORT_SYMBOL
(
__gë_u£r_8
);

26 
EXPORT_SYMBOL
(
__put_u£r_1
);

27 
EXPORT_SYMBOL
(
__put_u£r_2
);

28 
EXPORT_SYMBOL
(
__put_u£r_4
);

29 
EXPORT_SYMBOL
(
__put_u£r_8
);

31 
EXPORT_SYMBOL
(
c›y_u£r_gíîic
);

32 
EXPORT_SYMBOL
(
__c›y_u£r_noˇche
);

33 
EXPORT_SYMBOL
(
c›y_‰om_u£r
);

34 
EXPORT_SYMBOL
(
c›y_to_u£r
);

35 
EXPORT_SYMBOL
(
__c›y_‰om_u£r_ö©omic
);

37 
EXPORT_SYMBOL
(
c›y_∑ge
);

38 
EXPORT_SYMBOL
(
˛ór_∑ge
);

40 
EXPORT_SYMBOL
(
csum_∑πül
);

46 #unde‡
mem˝y


47 #unde‡
mem£t


48 #unde‡
memmove


50 *
mem£t
(*, , 
__kî√l_size_t
);

51 *
mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

52 *
__mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

54 
EXPORT_SYMBOL
(
mem£t
);

55 
EXPORT_SYMBOL
(
mem˝y
);

56 
EXPORT_SYMBOL
(
__mem˝y
);

58 
EXPORT_SYMBOL
(
em±y_zîo_∑ge
);

59 
EXPORT_SYMBOL
(
öô_Àvñ4_pgt
);

60 
EXPORT_SYMBOL
(
lﬂd_gs_ödex
);

	@/cmpt816/linux/arch/x86/kernel/x86_init.c

6 
	~<löux/öô.h
>

8 
	~<asm/bios_ebda.h
>

9 
	~<asm/∑øvút.h
>

10 
	~<asm/mp•ec.h
>

11 
	~<asm/£tup.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/e820.h
>

14 
	~<asm/time.h
>

15 
	~<asm/úq.h
>

16 
	~<asm/tsc.h
>

18 
__˝uöô
 
	$x86_öô_no›
(Ë{ 
	}
}

19 
__öô
 
	$x86_öô_uöt_no›
(
unu£d
Ë{ 
	}
}

20 
__öô
 
	$x86_öô_pgd_no›
(
pgd_t
 *
unu£d
Ë{ 
	}
}

26 
x86_öô_›s
 
x86_öô
 
	g__öôd©a
 = {

28 .
ªsour˚s
 = {

29 .
¥obe_roms
 = 
x86_öô_no›
,

30 .
	gª£rve_ªsour˚s
 = 
ª£rve_°™d¨d_io_ªsour˚s
,

31 .
	gmem‹y_£tup
 = 
deÁu…_machöe_•ecific_mem‹y_£tup
,

34 .
	gmµ¨£
 = {

35 .
mpc_ªc‹d
 = 
x86_öô_uöt_no›
,

36 .
	g£tup_iﬂpic_ids
 = 
x86_öô_no›
,

37 .
	gmpc_≠ic_id
 = 
deÁu…_mpc_≠ic_id
,

38 .
	gsmp_ªad_mpc_€m
 = 
deÁu…_smp_ªad_mpc_€m
,

39 .
	gmpc_€m_bus_öfo
 = 
deÁu…_mpc_€m_bus_öfo
,

40 .
	gföd_smp_c⁄fig
 = 
deÁu…_föd_smp_c⁄fig
,

41 .
	ggë_smp_c⁄fig
 = 
deÁu…_gë_smp_c⁄fig
,

44 .
	gúqs
 = {

45 .
¥e_ve˘‹_öô
 = 
öô_ISA_úqs
,

46 .
	göå_öô
 = 
«tive_öô_IRQ
,

47 .
	gå≠_öô
 = 
x86_öô_no›
,

50 .
	g€m
 = {

51 .
¨ch_£tup
 = 
x86_öô_no›
,

52 .
	gb™√r
 = 
deÁu…_b™√r
,

55 .
	g∑gög
 = {

56 .
∑gëabÀ_£tup_°¨t
 = 
«tive_∑gëabÀ_£tup_°¨t
,

57 .
	g∑gëabÀ_£tup_d⁄e
 = 
«tive_∑gëabÀ_£tup_d⁄e
,

60 .
	gtimîs
 = {

61 .
£tup_≥r˝u_˛ockev
 = 
£tup_boŸ_APIC_˛ock
,

62 .
	gtsc_¥e_öô
 = 
x86_öô_no›
,

63 .
	gtimî_öô
 = 
h≥t_time_öô
,

67 
x86_˝uöô_›s
 
x86_˝uöô
 
	g__˝uöôd©a
 = {

68 .
£tup_≥r˝u_˛ockev
 = 
£tup_£c⁄d¨y_APIC_˛ock
,

71 
x86_∂©f‹m_›s
 
	gx86_∂©f‹m
 = {

72 .
ˇlibøã_tsc
 = 
«tive_ˇlibøã_tsc
,

73 .
	ggë_wÆl˛ock
 = 
mach_gë_cmos_time
,

74 .
	g£t_wÆl˛ock
 = 
mach_£t_πc_mmss
,

	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<löux/boŸmem.h
>

7 
	~<löux/com∑t.h
>

8 
	~<asm/i387.h
>

9 #ifde‡
CONFIG_IA32_EMULATION


10 
	~<asm/sigc⁄ãxt32.h
>

12 
	~<asm/x¸.h
>

17 
u64
 
	gp˙txt_mask
;

19 
_Âx_sw_byãs
 
	gfx_sw_ª£rved
;

20 #ifde‡
CONFIG_IA32_EMULATION


21 
_Âx_sw_byãs
 
	gfx_sw_ª£rved_ü32
;

28 
	$check_f‹_x°©e
(
i387_fxßve_°ru˘
 
__u£r
 *
buf
,

29 
__u£r
 *
Â°©e
,

30 
_Âx_sw_byãs
 *
fx_sw_u£r
)

32 
mö_x°©e_size
 = (
i387_fxßve_°ru˘
) +

33 (
xßve_hdr_°ru˘
);

34 
magic2
;

35 
îr
;

37 
îr
 = 
	`__c›y_‰om_u£r
(
fx_sw_u£r
, &
buf
->
sw_ª£rved
[0],

38 (
_Âx_sw_byãs
));

40 i‡(
îr
)

41  
îr
;

46 i‡(
fx_sw_u£r
->
magic1
 !
FP_XSTATE_MAGIC1
)

52 i‡(
fx_sw_u£r
->
x°©e_size
 < 
mö_x°©e_size
 ||

53 
fx_sw_u£r
->
x°©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x°©e_size
 > fx_sw_u£r->
exãnded_size
)

57 
îr
 = 
	`__gë_u£r
(
magic2
, (
__u32
 *Ë(((*)
Â°©e
) +

58 
fx_sw_u£r
->
exãnded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 i‡(
îr
 || 
magic2
 !
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifde‡
CONFIG_X86_64


77 
	$ßve_i387_x°©e
(
__u£r
 *
buf
)

79 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

80 
îr
 = 0;

82 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x°©e_size
 < 
x°©e_size
);

87 i‡(()
buf
 % 64)

88 
	`¥ötk
("ßve_i387_x°©e: bad fp°©ê%p\n", 
buf
);

90 i‡(!
	`u£d_m©h
())

93 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_USEDFPU
) {

98 
îr
 = 
	`__˛ór_u£r
(
buf
, 
sig_x°©e_size
);

99 i‡(
îr
)

100  
îr
;

102 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

103 
îr
 = 
	`xßve_u£r
(
buf
);

105 
îr
 = 
	`fxßve_u£r
(
buf
);

107 i‡(
îr
)

108  
îr
;

109 
	`èsk_thªad_öfo
(
tsk
)->
°©us
 &~
TS_USEDFPU
;

110 
	`°ts
();

112 i‡(
	`__c›y_to_u£r
(
buf
, &
tsk
->
thªad
.
x°©e
->
fxßve
,

113 
x°©e_size
))

117 
	`˛ór_u£d_m©h
();

119 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
) {

120 
_Â°©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x°©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x°©e_bv
;

124 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved
,

125 (
_Âx_sw_byãs
));

127 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
îr
 |
	`__gë_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

149 
x°©e_bv
 |
XSTATE_FPSSE
;

151 
îr
 |
	`__put_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

153 i‡(
îr
)

154  
îr
;

158 
	}
}

164 
	$ª°‹e_u£r_x°©e
(
__u£r
 *
buf
)

166 
_Âx_sw_byãs
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
îr
;

170 i‡((()
buf
 % 64) ||

171 
	`check_f‹_x°©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_⁄ly
;

174 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

179 
îr
 = 
	`xª°‹e_u£r
(
buf
, 
mask
);

180 i‡(
îr
)

181  
îr
;

186 
mask
 = 
p˙txt_mask
 & ~mask;

188 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
mask
);

192 
fx_⁄ly
:

198 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
p˙txt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)
buf
);

200 
	}
}

205 
	$ª°‹e_i387_x°©e
(
__u£r
 *
buf
)

207 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

208 
îr
 = 0;

210 i‡(!
buf
) {

211 i‡(
	`u£d_m©h
())

212 
˛ór
;

215 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_size
))

216  -
EACCES
;

218 i‡(!
	`u£d_m©h
()) {

219 
îr
 = 
	`öô_Âu
(
tsk
);

220 i‡(
îr
)

221  
îr
;

224 i‡(!(
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 & 
TS_USEDFPU
)) {

225 
	`˛ts
();

226 
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 |
TS_USEDFPU
;

228 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_XSAVE
)

229 
îr
 = 
	`ª°‹e_u£r_x°©e
(
buf
);

231 
îr
 = 
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)

232 
buf
);

233 i‡(
	`u∆ikñy
(
îr
)) {

238 
˛ór
:

239 
	`˛ór_Âu
(
tsk
);

240 
	`˛ór_u£d_m©h
();

242  
îr
;

243 
	}
}

253 
	$¥ï¨e_fx_sw_‰ame
()

255 
size_exãnded
 = (
x°©e_size
 - (
i387_fxßve_°ru˘
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x°©e_size
 = (
_Â°©e
Ë+ 
size_exãnded
;

260 #ifde‡
CONFIG_IA32_EMULATION


261 
sig_x°©e_ü32_size
 = (
_Â°©e_ü32
Ë+ 
size_exãnded
;

264 
	`mem£t
(&
fx_sw_ª£rved
, 0, (fx_sw_reserved));

266 
fx_sw_ª£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_ª£rved
.
exãnded_size
 = 
sig_x°©e_size
;

268 
fx_sw_ª£rved
.
x°©e_bv
 = 
p˙txt_mask
;

269 
fx_sw_ª£rved
.
x°©e_size
 = xstate_size;

270 #ifde‡
CONFIG_IA32_EMULATION


271 
	`mem˝y
(&
fx_sw_ª£rved_ü32
, &
fx_sw_ª£rved
,

272 (
_Âx_sw_byãs
));

273 
fx_sw_ª£rved_ü32
.
exãnded_size
 = 
sig_x°©e_ü32_size
;

275 
	}
}

280 
xßve_°ru˘
 *
	göô_x°©e_buf
;

282 #ifde‡
CONFIG_X86_64


283 
	gsig_x°©e_size
 = (
_Â°©e
);

289 
__˝uöô
 
	$xßve_öô
()

291 i‡(!
˝u_has_xßve
)

294 
	`£t_ö_¸4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
p˙txt_mask
);

301 
	}
}

306 
__öô
 
	$£tup_x°©e_öô
()

308 
öô_x°©e_buf
 = 
	`Æloc_boŸmem
(
x°©e_size
);

309 
öô_x°©e_buf
->
i387
.
mxc§
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__ªf
 
	$xßve_˙txt_öô
()

317 
óx
, 
ebx
, 
ecx
, 
edx
;

319 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

320 
p˙txt_mask
 = 
óx
 + ((
u64
)
edx
 << 32);

322 i‡((
p˙txt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`¥ötk
(
KERN_ERR
 "FP/SSEÇot shown under xsave features 0x%llx\n",

324 
p˙txt_mask
);

325 
	`BUG
();

331 
p˙txt_mask
 =Ö˙txt_mask & 
XCNTXT_MASK
;

332 
	`xßve_öô
();

337 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

338 
x°©e_size
 = 
ebx
;

340 
	`¥ï¨e_fx_sw_‰ame
();

342 
	`£tup_x°©e_öô
();

344 
	`¥ötk
(
KERN_INFO
 "xsave/xrstor:Énabled xstate_bv 0x%llx, "

346 
p˙txt_mask
, 
x°©e_size
);

347 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/•ölock.h
>

3 
	~<asm/uac˚ss.h
>

6 
	$fixup_ex˚±i⁄
(
±_ªgs
 *
ªgs
)

8 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

10 #ifde‡
CONFIG_PNPBIOS


11 i‡(
	`u∆ikñy
(
	`SEGMENT_IS_PNP_CODE
(
ªgs
->
cs
))) {

12 
u32
 
≤p_bios_Áu…_eù
, 
≤p_bios_Áu…_e•
;

13 
u32
 
≤p_bios_is_uâî_¸≠
;

14 
≤p_bios_is_uâî_¸≠
 = 1;

15 
	`¥ötk
(
KERN_CRIT
 "PNPBIOS fault..áttemptingÑecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
≤p_bios_Áu…_e•
), "g" (
≤p_bios_Áu…_eù
));

20 
	`∑nic
("do_trap: can't hitÅhis");

24 
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
);

25 i‡(
fixup
) {

27 i‡(
fixup
->fixup < 16) {

28 
	`cuºít_thªad_öfo
()->
uac˚ss_îr
 = -
EFAULT
;

29 
ªgs
->
ù
 +
fixup
->fixup;

32 
ªgs
->
ù
 = 
fixup
->fixup;

37 
	}
}

39 #ifde‡
CONFIG_X86_64


44 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *

45 
	$£¨ch_exèbÀ
(c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fú°
,

46 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
œ°
,

47 
vÆue
)

50 i‡((
vÆue
 >> 32) == 0)

51 
vÆue
 |= 0xffffffffUL << 32;

53 
fú°
 <
œ°
) {

54 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
mid
;

55 
diff
;

57 
mid
 = (
œ°
 - 
fú°
) / 2 + first;

58 
diff
 = 
mid
->
ö¢
 - 
vÆue
;

59 i‡(
diff
 == 0)

60  
mid
;

61 i‡(
diff
 < 0)

62 
fú°
 = 
mid
+1;

64 
œ°
 = 
mid
-1;

66  
NULL
;

67 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<löux/magic.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/kdebug.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/boŸmem.h
>

11 
	~<löux/k¥obes.h
>

12 
	~<löux/mmiŸø˚.h
>

13 
	~<löux/≥rf_evít.h
>

15 
	~<asm/å≠s.h
>

16 
	~<asm/pgÆloc.h
>

17 
	~<asm/kmemcheck.h
>

28 
	ex86_pf_îr‹_code
 {

30 
	mPF_PROT
 = 1 << 0,

31 
	mPF_WRITE
 = 1 << 1,

32 
	mPF_USER
 = 1 << 2,

33 
	mPF_RSVD
 = 1 << 3,

34 
	mPF_INSTR
 = 1 << 4,

41 
ölöe
 
	$kmmio_Áu…
(
±_ªgs
 *
ªgs
, 
addr
)

43 i‡(
	`u∆ikñy
(
	`is_kmmio_a˘ive
()))

44 i‡(
	`kmmio_h™dÀr
(
ªgs
, 
addr
) == 1)

47 
	}
}

49 
ölöe
 
	$nŸify_∑ge_Áu…
(
±_ªgs
 *
ªgs
)

51 
ªt
 = 0;

54 i‡(
	`k¥obes_buût_ö
(Ë&& !
	`u£r_mode_vm
(
ªgs
)) {

55 
	`¥ìm±_dißbÀ
();

56 i‡(
	`k¥obe_ru¬ög
(Ë&& 
	`k¥obe_Áu…_h™dÀr
(
ªgs
, 14))

57 
ªt
 = 1;

58 
	`¥ìm±_íabÀ
();

61  
ªt
;

62 
	}
}

79 
ölöe
 

80 
	$check_¥e„tch_›code
(
±_ªgs
 *
ªgs
, *
ö°r
,

81 
›code
, *
¥e„tch
)

83 
ö°r_hi
 = 
›code
 & 0xf0;

84 
ö°r_lo
 = 
›code
 & 0x0f;

86 
ö°r_hi
) {

95  ((
ö°r_lo
 & 7) == 0x6);

96 #ifde‡
CONFIG_X86_64


105  (!
	`u£r_mode
(
ªgs
)Ë|| (ªgs->
cs
 =
__USER_CS
);

109  (
ö°r_lo
 & 0xC) == 0x4;

112  !
ö°r_lo
 || (instr_lo>>1) == 1;

115 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

118 *
¥e„tch
 = (
ö°r_lo
 == 0xF) &&

119 (
›code
 == 0x0D || opcode == 0x18);

124 
	}
}

127 
	$is_¥e„tch
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addr
)

129 *
max_ö°r
;

130 *
ö°r
;

131 
¥e„tch
 = 0;

137 i‡(
îr‹_code
 & 
PF_INSTR
)

140 
ö°r
 = (*)
	`c⁄vît_ù_to_löór
(
cuºít
, 
ªgs
);

141 
max_ö°r
 = 
ö°r
 + 15;

143 i‡(
	`u£r_mode
(
ªgs
Ë&& 
ö°r
 >(*)
TASK_SIZE
)

146 
ö°r
 < 
max_ö°r
) {

147 
›code
;

149 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

152 
ö°r
++;

154 i‡(!
	`check_¥e„tch_›code
(
ªgs
, 
ö°r
, 
›code
, &
¥e„tch
))

157  
¥e„tch
;

158 
	}
}

161 
	$f‹˚_sig_öfo_Áu…
(
si_signo
, 
si_code
, 
addªss
,

162 
èsk_°ru˘
 *
tsk
)

164 
sigöfo_t
 
öfo
;

166 
öfo
.
si_signo
 = si_signo;

167 
öfo
.
si_î∫o
 = 0;

168 
öfo
.
si_code
 = si_code;

169 
öfo
.
si_addr
 = (
__u£r
 *)
addªss
;

170 
öfo
.
si_addr_lsb
 = 
si_code
 =
BUS_MCEERR_AR
 ? 
PAGE_SHIFT
 : 0;

172 
	`f‹˚_sig_öfo
(
si_signo
, &
öfo
, 
tsk
);

173 
	}
}

175 
DEFINE_SPINLOCK
(
pgd_lock
);

176 
LIST_HEAD
(
pgd_li°
);

178 #ifde‡
CONFIG_X86_32


179 
ölöe
 
pmd_t
 *
	$vmÆloc_sync_⁄e
(
pgd_t
 *
pgd
, 
addªss
)

181 
ödex
 = 
	`pgd_ödex
(
addªss
);

182 
pgd_t
 *
pgd_k
;

183 
pud_t
 *
pud
, *
pud_k
;

184 
pmd_t
 *
pmd
, *
pmd_k
;

186 
pgd
 +
ödex
;

187 
pgd_k
 = 
öô_mm
.
pgd
 + 
ödex
;

189 i‡(!
	`pgd_¥e£¡
(*
pgd_k
))

190  
NULL
;

197 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

198 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
addªss
);

199 i‡(!
	`pud_¥e£¡
(*
pud_k
))

200  
NULL
;

202 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

203 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
addªss
);

204 i‡(!
	`pmd_¥e£¡
(*
pmd_k
))

205  
NULL
;

207 i‡(!
	`pmd_¥e£¡
(*
pmd
))

208 
	`£t_pmd
(
pmd
, *
pmd_k
);

210 
	`BUG_ON
(
	`pmd_∑ge
(*
pmd
Ë!pmd_∑ge(*
pmd_k
));

212  
pmd_k
;

213 
	}
}

215 
	$vmÆloc_sync_Æl
()

217 
addªss
;

219 i‡(
SHARED_KERNEL_PMD
)

222 
addªss
 = 
VMALLOC_START
 & 
PMD_MASK
;

223 
addªss
 >
TASK_SIZE
 &&áddªs†< 
FIXADDR_TOP
;

224 
addªss
 +
PMD_SIZE
) {

226 
Êags
;

227 
∑ge
 *page;

229 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

230 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

231 i‡(!
	`vmÆloc_sync_⁄e
(
	`∑ge_addªss
(
∑ge
), 
addªss
))

234 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

236 
	}
}

243 
noölöe
 
	$vmÆloc_Áu…
(
addªss
)

245 
pgd_∑ddr
;

246 
pmd_t
 *
pmd_k
;

247 
±e_t
 *
±e_k
;

250 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

260 
pgd_∑ddr
 = 
	`ªad_¸3
();

261 
pmd_k
 = 
	`vmÆloc_sync_⁄e
(
	`__va
(
pgd_∑ddr
), 
addªss
);

262 i‡(!
pmd_k
)

265 
±e_k
 = 
	`±e_off£t_kî√l
(
pmd_k
, 
addªss
);

266 i‡(!
	`±e_¥e£¡
(*
±e_k
))

270 
	}
}

275 
ölöe
 

276 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

277 
èsk_°ru˘
 *
tsk
)

279 
bô
;

281 i‡(!
	`v8086_mode
(
ªgs
))

284 
bô
 = (
addªss
 - 0xA0000Ë>> 
PAGE_SHIFT
;

285 i‡(
bô
 < 32)

286 
tsk
->
thªad
.
s¸ìn_bôm≠
 |1 << 
bô
;

287 
	}
}

289 
boﬁ
 
	$low_p‚
(
p‚
)

291  
p‚
 < 
max_low_p‚
;

292 
	}
}

294 
	$dump_∑gëabÀ
(
addªss
)

296 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

297 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addªss
)];

298 
pmd_t
 *
pmd
;

299 
±e_t
 *
±e
;

301 #ifde‡
CONFIG_X86_PAE


302 
	`¥ötk
("*pd± = %016Lx ", 
	`pgd_vÆ
(*
pgd
));

303 i‡(!
	`low_p‚
(
	`pgd_vÆ
(*
pgd
Ë>> 
PAGE_SHIFT
Ë|| !
	`pgd_¥e£¡
(*pgd))

304 
out
;

306 
pmd
 = 
	`pmd_off£t
(
	`pud_off£t
(
pgd
, 
addªss
),áddress);

307 
	`¥ötk
(
KERN_CONT
 "*pdê%0*Lx ", (*
pmd
Ë* 2, (
u64
)
	`pmd_vÆ
(*pmd));

315 i‡(!
	`low_p‚
(
	`pmd_p‚
(*
pmd
)Ë|| !
	`pmd_¥e£¡
(*pmdË|| 
	`pmd_œrge
(*pmd))

316 
out
;

318 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

319 
	`¥ötk
("*±ê%0*Lx ", (*
±e
Ë* 2, (
u64
)
	`±e_vÆ
(*pte));

320 
out
:

321 
	`¥ötk
("\n");

322 
	}
}

326 
	$vmÆloc_sync_Æl
()

328 
addªss
;

330 
addªss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;áddªs†<
VMALLOC_END
;

331 
addªss
 +
PGDIR_SIZE
) {

333 c⁄° 
pgd_t
 *
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

334 
Êags
;

335 
∑ge
 *page;

337 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

340 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

341 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

342 
pgd_t
 *
pgd
;

343 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

344 i‡(
	`pgd_n⁄e
(*
pgd
))

345 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

347 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

349 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

351 
	}
}

360 
noölöe
 
	$vmÆloc_Áu…
(
addªss
)

362 
pgd_t
 *
pgd
, *
pgd_ªf
;

363 
pud_t
 *
pud
, *
pud_ªf
;

364 
pmd_t
 *
pmd
, *
pmd_ªf
;

365 
±e_t
 *
±e
, *
±e_ªf
;

368 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

376 
pgd
 = 
	`pgd_off£t
(
cuºít
->
a˘ive_mm
, 
addªss
);

377 
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

378 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

381 i‡(
	`pgd_n⁄e
(*
pgd
))

382 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

384 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

391 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

392 
pud_ªf
 = 
	`pud_off£t
(
pgd_ªf
, 
addªss
);

393 i‡(
	`pud_n⁄e
(*
pud_ªf
))

396 i‡(
	`pud_n⁄e
(*
pud
Ë|| 
	`pud_∑ge_vaddr
(*pudË!pud_∑ge_vaddr(*
pud_ªf
))

397 
	`BUG
();

399 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

400 
pmd_ªf
 = 
	`pmd_off£t
(
pud_ªf
, 
addªss
);

401 i‡(
	`pmd_n⁄e
(*
pmd_ªf
))

404 i‡(
	`pmd_n⁄e
(*
pmd
Ë|| 
	`pmd_∑ge
(*pmdË!pmd_∑ge(*
pmd_ªf
))

405 
	`BUG
();

407 
±e_ªf
 = 
	`±e_off£t_kî√l
(
pmd_ªf
, 
addªss
);

408 i‡(!
	`±e_¥e£¡
(*
±e_ªf
))

411 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

418 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| 
	`±e_p‚
(*±eË!±e_p‚(*
±e_ªf
))

419 
	`BUG
();

422 
	}
}

424 c⁄° 
	gîøè93_w¨nög
[] =

425 
KERN_ERR


434 
ölöe
 

435 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

436 
èsk_°ru˘
 *
tsk
)

438 
	}
}

440 
	$bad_addªss
(*
p
)

442 
dummy
;

444  
	`¥obe_kî√l_addªss
((*)
p
, 
dummy
);

445 
	}
}

447 
	$dump_∑gëabÀ
(
addªss
)

449 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
(Ë& 
PHYSICAL_PAGE_MASK
);

450 
pgd_t
 *
pgd
 = 
ba£
 + 
	`pgd_ödex
(
addªss
);

451 
pud_t
 *
pud
;

452 
pmd_t
 *
pmd
;

453 
±e_t
 *
±e
;

455 i‡(
	`bad_addªss
(
pgd
))

456 
bad
;

458 
	`¥ötk
("PGD %lx ", 
	`pgd_vÆ
(*
pgd
));

460 i‡(!
	`pgd_¥e£¡
(*
pgd
))

461 
out
;

463 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

464 i‡(
	`bad_addªss
(
pud
))

465 
bad
;

467 
	`¥ötk
("PUD %lx ", 
	`pud_vÆ
(*
pud
));

468 i‡(!
	`pud_¥e£¡
(*
pud
Ë|| 
	`pud_œrge
(*pud))

469 
out
;

471 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

472 i‡(
	`bad_addªss
(
pmd
))

473 
bad
;

475 
	`¥ötk
("PMD %lx ", 
	`pmd_vÆ
(*
pmd
));

476 i‡(!
	`pmd_¥e£¡
(*
pmd
Ë|| 
	`pmd_œrge
(*pmd))

477 
out
;

479 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

480 i‡(
	`bad_addªss
(
±e
))

481 
bad
;

483 
	`¥ötk
("PTE %lx", 
	`±e_vÆ
(*
±e
));

484 
out
:

485 
	`¥ötk
("\n");

487 
bad
:

488 
	`¥ötk
("BAD\n");

489 
	}
}

507 
	$is_îøè93
(
±_ªgs
 *
ªgs
, 
addªss
)

509 #ifde‡
CONFIG_X86_64


510 i‡(
addªss
 !
ªgs
->
ù
)

513 i‡((
addªss
 >> 32) != 0)

516 
addªss
 |= 0xffffffffUL << 32;

517 i‡((
addªss
 >(
u64
)
_°ext
 &&áddªs†<(u64)
_ëext
) ||

518 (
addªss
 >
MODULES_VADDR
 &&áddªs†<
MODULES_END
)) {

519 
	`¥ötk_⁄˚
(
îøè93_w¨nög
);

520 
ªgs
->
ù
 = 
addªss
;

525 
	}
}

535 
	$is_îøè100
(
±_ªgs
 *
ªgs
, 
addªss
)

537 #ifde‡
CONFIG_X86_64


538 i‡((
ªgs
->
cs
 =
__USER32_CS
 || (ªgs->c†& (1<<2))Ë&& (
addªss
 >> 32))

542 
	}
}

544 
	$is_f00f_bug
(
±_ªgs
 *
ªgs
, 
addªss
)

546 #ifde‡
CONFIG_X86_F00F_BUG


547 
ƒ
;

552 i‡(
boŸ_˝u_d©a
.
f00f_bug
) {

553 
ƒ
 = (
addªss
 - 
idt_des¸
.address) >> 3;

555 i‡(
ƒ
 == 6) {

556 
	`do_övÆid_›
(
ªgs
, 0);

562 
	}
}

564 c⁄° 
	gnx_w¨nög
[] = 
KERN_CRIT


568 
	$show_Áu…_o›s
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

569 
addªss
)

571 i‡(!
	`o›s_may_¥öt
())

574 i‡(
îr‹_code
 & 
PF_INSTR
) {

575 
Àvñ
;

577 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

579 i‡(
±e
 && 
	`±e_¥e£¡
(*±eË&& !
	`±e_exec
(*pte))

580 
	`¥ötk
(
nx_w¨nög
, 
	`cuºít_uid
());

583 
	`¥ötk
(
KERN_ALERT
 "BUG: unableÅo handle kernel ");

584 i‡(
addªss
 < 
PAGE_SIZE
)

585 
	`¥ötk
(
KERN_CONT
 "NULLÖointer dereference");

587 
	`¥ötk
(
KERN_CONT
 "pagingÑequest");

589 
	`¥ötk
(
KERN_CONT
 "áà%p\n", (*Ë
addªss
);

590 
	`¥ötk
(
KERN_ALERT
 "IP:");

591 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

593 
	`dump_∑gëabÀ
(
addªss
);

594 
	}
}

596 
noölöe
 

597 
	$pgèbÀ_bad
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

598 
addªss
)

600 
èsk_°ru˘
 *
tsk
;

601 
Êags
;

602 
sig
;

604 
Êags
 = 
	`o›s_begö
();

605 
tsk
 = 
cuºít
;

606 
sig
 = 
SIGKILL
;

608 
	`¥ötk
(
KERN_ALERT
 "%s: CorruptedÖageÅableátáddress %lx\n",

609 
tsk
->
comm
, 
addªss
);

610 
	`dump_∑gëabÀ
(
addªss
);

612 
tsk
->
thªad
.
¸2
 = 
addªss
;

613 
tsk
->
thªad
.
å≠_no
 = 14;

614 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

616 i‡(
	`__dõ
("BadÖagëabÀ", 
ªgs
, 
îr‹_code
))

617 
sig
 = 0;

619 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

620 
	}
}

622 
noölöe
 

623 
	$no_c⁄ãxt
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

624 
addªss
)

626 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

627 *
°ackíd
;

628 
Êags
;

629 
sig
;

632 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

646 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

649 i‡(
	`is_îøè93
(
ªgs
, 
addªss
))

656 
Êags
 = 
	`o›s_begö
();

658 
	`show_Áu…_o›s
(
ªgs
, 
îr‹_code
, 
addªss
);

660 
°ackíd
 = 
	`íd_of_°ack
(
tsk
);

661 i‡(*
°ackíd
 !
STACK_END_MAGIC
)

662 
	`¥ötk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

664 
tsk
->
thªad
.
¸2
 = 
addªss
;

665 
tsk
->
thªad
.
å≠_no
 = 14;

666 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

668 
sig
 = 
SIGKILL
;

669 i‡(
	`__dõ
("O›s", 
ªgs
, 
îr‹_code
))

670 
sig
 = 0;

673 
	`¥ötk
(
KERN_EMERG
 "CR2: %016lx\n", 
addªss
);

675 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

676 
	}
}

682 
ölöe
 

683 
	$show_sig«l_msg
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

684 
addªss
, 
èsk_°ru˘
 *
tsk
)

686 i‡(!
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
))

689 i‡(!
	`¥ötk_øãlimô
())

692 
	`¥ötk
("%s%s[%d]: segfaultát %lx ip %p sp %pÉrror %lx",

693 
	`èsk_pid_ƒ
(
tsk
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

694 
tsk
->
comm
, 
	`èsk_pid_ƒ
—sk), 
addªss
,

695 (*)
ªgs
->
ù
, (*Ïegs->
•
, 
îr‹_code
);

697 
	`¥öt_vma_addr
(
KERN_CONT
 " i¿", 
ªgs
->
ù
);

699 
	`¥ötk
(
KERN_CONT
 "\n");

700 
	}
}

703 
	$__bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

704 
addªss
, 
si_code
)

706 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

709 i‡(
îr‹_code
 & 
PF_USER
) {

713 
	`loˇl_úq_íabÀ
();

719 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

722 i‡(
	`is_îøè100
(
ªgs
, 
addªss
))

725 i‡(
	`u∆ikñy
(
show_unh™dÀd_sig«ls
))

726 
	`show_sig«l_msg
(
ªgs
, 
îr‹_code
, 
addªss
, 
tsk
);

729 
tsk
->
thªad
.
¸2
 = 
addªss
;

730 
tsk
->
thªad
.
îr‹_code
 =Éº‹_codê| (
addªss
 >
TASK_SIZE
);

731 
tsk
->
thªad
.
å≠_no
 = 14;

733 
	`f‹˚_sig_öfo_Áu…
(
SIGSEGV
, 
si_code
, 
addªss
, 
tsk
);

738 i‡(
	`is_f00f_bug
(
ªgs
, 
addªss
))

741 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

742 
	}
}

744 
noölöe
 

745 
	$bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

746 
addªss
)

748 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

749 
	}
}

752 
	$__bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

753 
addªss
, 
si_code
)

755 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

761 
	`up_ªad
(&
mm
->
mm≠_£m
);

763 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
si_code
);

764 
	}
}

766 
noölöe
 

767 
	$bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

769 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

770 
	}
}

772 
noölöe
 

773 
	$bad_¨ó_ac˚ss_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

774 
addªss
)

776 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_ACCERR
);

777 
	}
}

781 
	$out_of_mem‹y
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

782 
addªss
)

788 
	`up_ªad
(&
cuºít
->
mm
->
mm≠_£m
);

790 
	`∑geÁu…_out_of_mem‹y
();

791 
	}
}

794 
	$do_sigbus
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
,

795 
Áu…
)

797 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

798 
mm_°ru˘
 *
mm
 = 
tsk
->mm;

799 
code
 = 
BUS_ADRERR
;

801 
	`up_ªad
(&
mm
->
mm≠_£m
);

804 i‡(!(
îr‹_code
 & 
PF_USER
))

805 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

808 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

811 
tsk
->
thªad
.
¸2
 = 
addªss
;

812 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

813 
tsk
->
thªad
.
å≠_no
 = 14;

815 #ifde‡
CONFIG_MEMORY_FAILURE


816 i‡(
Áu…
 & 
VM_FAULT_HWPOISON
) {

817 
	`¥ötk
(
KERN_ERR


819 
tsk
->
comm
,Åsk->
pid
, 
addªss
);

820 
code
 = 
BUS_MCEERR_AR
;

823 
	`f‹˚_sig_öfo_Áu…
(
SIGBUS
, 
code
, 
addªss
, 
tsk
);

824 
	}
}

826 
noölöe
 

827 
	$mm_Áu…_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

828 
addªss
, 
Áu…
)

830 i‡(
Áu…
 & 
VM_FAULT_OOM
) {

831 
	`out_of_mem‹y
(
ªgs
, 
îr‹_code
, 
addªss
);

833 i‡(
Áu…
 & (
VM_FAULT_SIGBUS
|
VM_FAULT_HWPOISON
))

834 
	`do_sigbus
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

836 
	`BUG
();

838 
	}
}

840 
	$•urious_Áu…_check
(
îr‹_code
, 
±e_t
 *
±e
)

842 i‡((
îr‹_code
 & 
PF_WRITE
Ë&& !
	`±e_wrôe
(*
±e
))

845 i‡((
îr‹_code
 & 
PF_INSTR
Ë&& !
	`±e_exec
(*
±e
))

849 
	}
}

863 
noölöe
 

864 
	$•urious_Áu…
(
îr‹_code
, 
addªss
)

866 
pgd_t
 *
pgd
;

867 
pud_t
 *
pud
;

868 
pmd_t
 *
pmd
;

869 
±e_t
 *
±e
;

870 
ªt
;

873 i‡(
îr‹_code
 & (
PF_USER
 | 
PF_RSVD
))

876 
pgd
 = 
öô_mm
.pgd + 
	`pgd_ödex
(
addªss
);

877 i‡(!
	`pgd_¥e£¡
(*
pgd
))

880 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

881 i‡(!
	`pud_¥e£¡
(*
pud
))

884 i‡(
	`pud_œrge
(*
pud
))

885  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pud
);

887 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

888 i‡(!
	`pmd_¥e£¡
(*
pmd
))

891 i‡(
	`pmd_œrge
(*
pmd
))

892  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

894 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

895 i‡(!
	`±e_¥e£¡
(*
±e
))

898 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, 
±e
);

899 i‡(!
ªt
)

906 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

907 
	`WARN_ONCE
(!
ªt
, "PMD has incorrectÖermission bits\n");

909  
ªt
;

910 
	}
}

912 
	gshow_unh™dÀd_sig«ls
 = 1;

914 
ölöe
 

915 
	$ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vm_¨ó_°ru˘
 *
vma
)

917 i‡(
wrôe
) {

919 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_WRITE
)))

925 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_PROT
))

929 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

933 
	}
}

935 
	$Áu…_ö_kî√l_•a˚
(
addªss
)

937  
addªss
 >
TASK_SIZE_MAX
;

938 
	}
}

945 
dŸø∂ökage
 
__k¥obes


946 
	$do_∑ge_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

948 
vm_¨ó_°ru˘
 *
vma
;

949 
èsk_°ru˘
 *
tsk
;

950 
addªss
;

951 
mm_°ru˘
 *
mm
;

952 
wrôe
;

953 
Áu…
;

955 
tsk
 = 
cuºít
;

956 
mm
 = 
tsk
->mm;

959 
addªss
 = 
	`ªad_¸2
();

965 i‡(
	`kmemcheck_a˘ive
(
ªgs
))

966 
	`kmemcheck_hide
(
ªgs
);

967 
	`¥e„tchw
(&
mm
->
mm≠_£m
);

969 i‡(
	`u∆ikñy
(
	`kmmio_Áu…
(
ªgs
, 
addªss
)))

985 i‡(
	`u∆ikñy
(
	`Áu…_ö_kî√l_•a˚
(
addªss
))) {

986 i‡(!(
îr‹_code
 & (
PF_RSVD
 | 
PF_USER
 | 
PF_PROT
))) {

987 i‡(
	`vmÆloc_Áu…
(
addªss
) >= 0)

990 i‡(
	`kmemcheck_Áu…
(
ªgs
, 
addªss
, 
îr‹_code
))

995 i‡(
	`•urious_Áu…
(
îr‹_code
, 
addªss
))

999 i‡(
	`nŸify_∑ge_Áu…
(
ªgs
))

1005 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1011 i‡(
	`u∆ikñy
(
	`nŸify_∑ge_Áu…
(
ªgs
)))

1020 i‡(
	`u£r_mode_vm
(
ªgs
)) {

1021 
	`loˇl_úq_íabÀ
();

1022 
îr‹_code
 |
PF_USER
;

1024 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

1025 
	`loˇl_úq_íabÀ
();

1028 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_RSVD
))

1029 
	`pgèbÀ_bad
(
ªgs
, 
îr‹_code
, 
addªss
);

1031 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS
, 1, 0, 
ªgs
, 
addªss
);

1037 i‡(
	`u∆ikñy
(
	`ö_©omic
(Ë|| !
mm
)) {

1038 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1058 i‡(
	`u∆ikñy
(!
	`down_ªad_åylock
(&
mm
->
mm≠_£m
))) {

1059 i‡((
îr‹_code
 & 
PF_USER
) == 0 &&

1060 !
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
)) {

1061 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1064 
	`down_ªad
(&
mm
->
mm≠_£m
);

1071 
	`might_¶ìp
();

1074 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

1075 i‡(
	`u∆ikñy
(!
vma
)) {

1076 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1079 i‡(
	`likñy
(
vma
->
vm_°¨t
 <
addªss
))

1080 
good_¨ó
;

1081 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))) {

1082 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1085 i‡(
îr‹_code
 & 
PF_USER
) {

1092 i‡(
	`u∆ikñy
(
addªss
 + 65536 + 32 * (Ë< 
ªgs
->
•
)) {

1093 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1097 i‡(
	`u∆ikñy
(
	`ex∑nd_°ack
(
vma
, 
addªss
))) {

1098 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1106 
good_¨ó
:

1107 
wrôe
 = 
îr‹_code
 & 
PF_WRITE
;

1109 i‡(
	`u∆ikñy
(
	`ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vma
))) {

1110 
	`bad_¨ó_ac˚ss_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
);

1119 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
wrôe
 ? 
FAULT_FLAG_WRITE
 : 0);

1121 i‡(
	`u∆ikñy
(
Áu…
 & 
VM_FAULT_ERROR
)) {

1122 
	`mm_Áu…_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

1126 i‡(
Áu…
 & 
VM_FAULT_MAJOR
) {

1127 
tsk
->
maj_Êt
++;

1128 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MAJ
, 1, 0,

1129 
ªgs
, 
addªss
);

1131 
tsk
->
mö_Êt
++;

1132 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MIN
, 1, 0,

1133 
ªgs
, 
addªss
);

1136 
	`check_v8086_mode
(
ªgs
, 
addªss
, 
tsk
);

1138 
	`up_ªad
(&
mm
->
mm≠_£m
);

1139 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<löux/sched.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/vm°©.h
>

10 
	~<löux/highmem.h
>

12 
	~<asm/pgèbÀ.h
>

14 
ölöe
 
±e_t
 
	$gup_gë_±e
(
±e_t
 *
±ï
)

16 #i‚de‡
CONFIG_X86_PAE


17  
	`ACCESS_ONCE
(*
±ï
);

51 
±e_t
 
±e
;

53 
ªåy
:

54 
±e
.
±e_low
 = 
±ï
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±ï
->pte_high;

57 
	`smp_rmb
();

58 i‡(
	`u∆ikñy
(
±e
.
±e_low
 !
±ï
->pte_low))

59 
ªåy
;

61  
±e
;

63 
	}
}

70 
noölöe
 
	$gup_±e_ønge
(
pmd_t
 
pmd
, 
addr
,

71 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

73 
mask
;

74 
±e_t
 *
±ï
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 i‡(
wrôe
)

78 
mask
 |
_PAGE_RW
;

80 
±ï
 = 
	`±e_off£t_m≠
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_gë_±e
(
±ï
);

83 
∑ge
 *page;

85 i‡((
	`±e_Êags
(
±e
Ë& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm≠
(
±ï
);

89 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

90 
∑ge
 = 
	`±e_∑ge
(
±e
);

91 
	`gë_∑ge
(
∑ge
);

92 
∑ges
[*
ƒ
] = 
∑ge
;

93 (*
ƒ
)++;

95 } 
±ï
++, 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

96 
	`±e_unm≠
(
±ï
 - 1);

99 
	}
}

101 
ölöe
 
	$gë_hód_∑ge_mu…ùÀ
(
∑ge
 *∑ge, 
ƒ
)

103 
	`VM_BUG_ON
(
∑ge
 !
	`compound_hód
(page));

104 
	`VM_BUG_ON
(
	`∑ge_cou¡
(
∑ge
) == 0);

105 
	`©omic_add
(
ƒ
, &
∑ge
->
_cou¡
);

106 
	}
}

108 
noölöe
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

111 
mask
;

112 
±e_t
 
±e
 = *’ã_à*)&
pmd
;

113 
∑ge
 *
hód
, *page;

114 
ªfs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 i‡(
wrôe
)

118 
mask
 |
_PAGE_RW
;

119 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

125 
ªfs
 = 0;

126 
hód
 = 
	`±e_∑ge
(
±e
);

127 
∑ge
 = 
hód
 + ((
addr
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

130 
∑ges
[*
ƒ
] = 
∑ge
;

131 (*
ƒ
)++;

132 
∑ge
++;

133 
ªfs
++;

134 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

135 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

138 
	}
}

140 
	$gup_pmd_ønge
(
pud_t
 
pud
, 
addr
, 
íd
,

141 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

143 
√xt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

151 i‡(
	`pmd_n⁄e
(
pmd
))

153 i‡(
	`u∆ikñy
(
	`pmd_œrge
(
pmd
))) {

154 i‡(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

157 i‡(!
	`gup_±e_ønge
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

160 } 
pmdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

163 
	}
}

165 
noölöe
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

168 
mask
;

169 
±e_t
 
±e
 = *’ã_à*)&
pud
;

170 
∑ge
 *
hód
, *page;

171 
ªfs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 i‡(
wrôe
)

175 
mask
 |
_PAGE_RW
;

176 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

182 
ªfs
 = 0;

183 
hód
 = 
	`±e_∑ge
(
±e
);

184 
∑ge
 = 
hód
 + ((
addr
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

187 
∑ges
[*
ƒ
] = 
∑ge
;

188 (*
ƒ
)++;

189 
∑ge
++;

190 
ªfs
++;

191 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

192 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

195 
	}
}

197 
	$gup_pud_ønge
(
pgd_t
 
pgd
, 
addr
, 
íd
,

198 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

200 
√xt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
√xt
 = 
	`pud_addr_íd
(
addr
, 
íd
);

208 i‡(
	`pud_n⁄e
(
pud
))

210 i‡(
	`u∆ikñy
(
	`pud_œrge
(
pud
))) {

211 i‡(!
	`gup_huge_pud
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

214 i‡(!
	`gup_pmd_ønge
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

217 } 
pudp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

220 
	}
}

226 
	$__gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

227 
∑ge
 **
∑ges
)

229 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

230 
addr
, 
Àn
, 
íd
;

231 
√xt
;

232 
Êags
;

233 
pgd_t
 *
pgdp
;

234 
ƒ
 = 0;

236 
°¨t
 &
PAGE_MASK
;

237 
addr
 = 
°¨t
;

238 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

239 
íd
 = 
°¨t
 + 
Àn
;

240 i‡(
	`u∆ikñy
(!
	`ac˚ss_ok
(
wrôe
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

241 (
__u£r
 *)
°¨t
, 
Àn
)))

262 
	`loˇl_úq_ßve
(
Êags
);

263 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

265 
pgd_t
 
pgd
 = *
pgdp
;

267 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

268 i‡(
	`pgd_n⁄e
(
pgd
))

270 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

272 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

273 
	`loˇl_úq_ª°‹e
(
Êags
);

275  
ƒ
;

276 
	}
}

294 
	$gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

295 
∑ge
 **
∑ges
)

297 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

298 
addr
, 
Àn
, 
íd
;

299 
√xt
;

300 
pgd_t
 *
pgdp
;

301 
ƒ
 = 0;

303 
°¨t
 &
PAGE_MASK
;

304 
addr
 = 
°¨t
;

305 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

307 
íd
 = 
°¨t
 + 
Àn
;

308 i‡(
íd
 < 
°¨t
)

309 
¶ow_úq⁄
;

311 #ifde‡
CONFIG_X86_64


312 i‡(
íd
 >> 
__VIRTUAL_MASK_SHIFT
)

313 
¶ow_úq⁄
;

334 
	`loˇl_úq_dißbÀ
();

335 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

337 
pgd_t
 
pgd
 = *
pgdp
;

339 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

340 i‡(
	`pgd_n⁄e
(
pgd
))

341 
¶ow
;

342 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

343 
¶ow
;

344 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

345 
	`loˇl_úq_íabÀ
();

347 
	`VM_BUG_ON
(
ƒ
 !(
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

348  
ƒ
;

351 
ªt
;

353 
¶ow
:

354 
	`loˇl_úq_íabÀ
();

355 
¶ow_úq⁄
:

357 
°¨t
 +
ƒ
 << 
PAGE_SHIFT
;

358 
∑ges
 +
ƒ
;

360 
	`down_ªad
(&
mm
->
mm≠_£m
);

361 
ªt
 = 
	`gë_u£r_∑ges
(
cuºít
, 
mm
, 
°¨t
,

362 (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
, 
wrôe
, 0, 
∑ges
, 
NULL
);

363 
	`up_ªad
(&
mm
->
mm≠_£m
);

366 i‡(
ƒ
 > 0) {

367 i‡(
ªt
 < 0)

368 
ªt
 = 
ƒ
;

370 
ªt
 +
ƒ
;

373  
ªt
;

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<löux/öô.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/hugëlb.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/îr.h
>

14 
	~<löux/sys˘l.h
>

15 
	~<asm/mm™.h
>

16 
	~<asm/éb.h
>

17 
	~<asm/ébÊush.h
>

18 
	~<asm/pgÆloc.h
>

20 
	$∑ge_èbÀ_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
svma
,

21 
vm_¨ó_°ru˘
 *
vma
,

22 
addr
, 
pgoff_t
 
idx
)

24 
ßddr
 = ((
idx
 - 
svma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
) +

25 
svma
->
vm_°¨t
;

26 
sba£
 = 
ßddr
 & 
PUD_MASK
;

27 
s_íd
 = 
sba£
 + 
PUD_SIZE
;

30 
vm_Êags
 = 
vma
->vm_Êag†& ~
VM_LOCKED
;

31 
svm_Êags
 = 
svma
->
vm_Êags
 & ~
VM_LOCKED
;

37 i‡(
	`pmd_ödex
(
addr
Ë!pmd_ödex(
ßddr
) ||

38 
vm_Êags
 !
svm_Êags
 ||

39 
sba£
 < 
svma
->
vm_°¨t
 || svma->
vm_íd
 < 
s_íd
)

42  
ßddr
;

43 
	}
}

45 
	$vma_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

47 
ba£
 = 
addr
 & 
PUD_MASK
;

48 
íd
 = 
ba£
 + 
PUD_SIZE
;

53 i‡(
vma
->
vm_Êags
 & 
VM_MAYSHARE
 &&

54 
vma
->
vm_°¨t
 <
ba£
 && 
íd
 <vma->
vm_íd
)

57 
	}
}

62 
	$huge_pmd_sh¨e
(
mm_°ru˘
 *
mm
, 
addr
, 
pud_t
 *
pud
)

64 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

65 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

66 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_°¨t
Ë>> 
PAGE_SHIFT
) +

67 
vma
->
vm_pgoff
;

68 
¥io_åì_ôî
 
ôî
;

69 
vm_¨ó_°ru˘
 *
svma
;

70 
ßddr
;

71 
±e_t
 *
•ã
 = 
NULL
;

73 i‡(!
	`vma_sh¨óbÀ
(
vma
, 
addr
))

76 
	`•ö_lock
(&
m≠pög
->
i_mm≠_lock
);

77 
	`vma_¥io_åì_f‹óch
(
svma
, &
ôî
, &
m≠pög
->
i_mm≠
, 
idx
, idx) {

78 i‡(
svma
 =
vma
)

81 
ßddr
 = 
	`∑ge_èbÀ_sh¨óbÀ
(
svma
, 
vma
, 
addr
, 
idx
);

82 i‡(
ßddr
) {

83 
•ã
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
ßddr
);

84 i‡(
•ã
) {

85 
	`gë_∑ge
(
	`vút_to_∑ge
(
•ã
));

91 i‡(!
•ã
)

92 
out
;

94 
	`•ö_lock
(&
mm
->
∑ge_èbÀ_lock
);

95 i‡(
	`pud_n⁄e
(*
pud
))

96 
	`pud_p›uœã
(
mm
, 
pud
, (
pmd_t
 *)(()
•ã
 & 
PAGE_MASK
));

98 
	`put_∑ge
(
	`vút_to_∑ge
(
•ã
));

99 
	`•ö_u∆ock
(&
mm
->
∑ge_èbÀ_lock
);

100 
out
:

101 
	`•ö_u∆ock
(&
m≠pög
->
i_mm≠_lock
);

102 
	}
}

116 
	$huge_pmd_unsh¨e
(
mm_°ru˘
 *
mm
, *
addr
, 
±e_t
 *
±ï
)

118 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

119 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

121 
	`BUG_ON
(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 0);

122 i‡(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 1)

125 
	`pud_˛ór
(
pud
);

126 
	`put_∑ge
(
	`vút_to_∑ge
(
±ï
));

127 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

129 
	}
}

131 
±e_t
 *
	$huge_±e_Æloc
(
mm_°ru˘
 *
mm
,

132 
addr
, 
sz
)

134 
pgd_t
 *
pgd
;

135 
pud_t
 *
pud
;

136 
±e_t
 *
±e
 = 
NULL
;

138 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

139 
pud
 = 
	`pud_Æloc
(
mm
, 
pgd
, 
addr
);

140 i‡(
pud
) {

141 i‡(
sz
 =
PUD_SIZE
) {

142 
±e
 = (
±e_t
 *)
pud
;

144 
	`BUG_ON
(
sz
 !
PMD_SIZE
);

145 i‡(
	`pud_n⁄e
(*
pud
))

146 
	`huge_pmd_sh¨e
(
mm
, 
addr
, 
pud
);

147 
±e
 = (
±e_t
 *Ë
	`pmd_Æloc
(
mm
, 
pud
, 
addr
);

150 
	`BUG_ON
(
±e
 && !
	`±e_n⁄e
(*±eË&& !
	`±e_huge
(*pte));

152  
±e
;

153 
	}
}

155 
±e_t
 *
	$huge_±e_off£t
(
mm_°ru˘
 *
mm
, 
addr
)

157 
pgd_t
 *
pgd
;

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
 = 
NULL
;

161 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

162 i‡(
	`pgd_¥e£¡
(*
pgd
)) {

163 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

164 i‡(
	`pud_¥e£¡
(*
pud
)) {

165 i‡(
	`pud_œrge
(*
pud
))

166  (
±e_t
 *)
pud
;

167 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

170  (
±e_t
 *Ë
pmd
;

171 
	}
}

174 
∑ge
 *

175 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

177 
°¨t
 = 
addªss
;

178 
Àngth
 = 1;

179 
ƒ
;

180 
∑ge
 *page;

181 
vm_¨ó_°ru˘
 *
vma
;

183 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

184 i‡(!
vma
 || !
	`is_vm_hugëlb_∑ge
(vma))

185  
	`ERR_PTR
(-
EINVAL
);

187 
±e
 = 
	`huge_±e_off£t
(
mm
, 
addªss
);

190 
	`WARN_ON
(!
±e
 || 
	`±e_n⁄e
(*pte));

192 
∑ge
 = &
	`±e_∑ge
(*
±e
)[
vp‚
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

194 
	`WARN_ON
(!
	`PageHód
(
∑ge
));

196  
∑ge
;

197 
	}
}

199 
	$pmd_huge
(
pmd_t
 
pmd
)

202 
	}
}

204 
	$pud_huge
(
pud_t
 
pud
)

207 
	}
}

209 
∑ge
 *

210 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

211 
pmd_t
 *
pmd
, 
wrôe
)

213  
NULL
;

214 
	}
}

218 
∑ge
 *

219 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

221  
	`ERR_PTR
(-
EINVAL
);

222 
	}
}

224 
	$pmd_huge
(
pmd_t
 
pmd
)

226  !!(
	`pmd_vÆ
(
pmd
Ë& 
_PAGE_PSE
);

227 
	}
}

229 
	$pud_huge
(
pud_t
 
pud
)

231  !!(
	`pud_vÆ
(
pud
Ë& 
_PAGE_PSE
);

232 
	}
}

234 
∑ge
 *

235 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

236 
pmd_t
 *
pmd
, 
wrôe
)

238 
∑ge
 *page;

240 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pmd
);

241 i‡(
∑ge
)

242 
∑ge
 +((
addªss
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

243  
∑ge
;

244 
	}
}

246 
∑ge
 *

247 
	$fﬁlow_huge_pud
(
mm_°ru˘
 *
mm
, 
addªss
,

248 
pud_t
 *
pud
, 
wrôe
)

250 
∑ge
 *page;

252 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pud
);

253 i‡(
∑ge
)

254 
∑ge
 +((
addªss
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

255  
∑ge
;

256 
	}
}

262 #ifde‡
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


263 
	$hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
 *file,

264 
addr
, 
Àn
,

265 
pgoff
, 
Êags
)

267 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

268 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

269 
vm_¨ó_°ru˘
 *
vma
;

270 
°¨t_addr
;

272 i‡(
Àn
 > 
mm
->
ˇched_hﬁe_size
) {

273 
°¨t_addr
 = 
mm
->
‰ì_¨ó_ˇche
;

275 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

276 
mm
->
ˇched_hﬁe_size
 = 0;

279 
fuŒ_£¨ch
:

280 
addr
 = 
	`ALIGN
(
°¨t_addr
, 
	`huge_∑ge_size
(
h
));

282 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

284 i‡(
TASK_SIZE
 - 
Àn
 < 
addr
) {

289 i‡(
°¨t_addr
 !
TASK_UNMAPPED_BASE
) {

290 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

291 
mm
->
ˇched_hﬁe_size
 = 0;

292 
fuŒ_£¨ch
;

294  -
ENOMEM
;

296 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

297 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

298  
addr
;

300 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

301 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

302 
addr
 = 
	`ALIGN
(
vma
->
vm_íd
, 
	`huge_∑ge_size
(
h
));

304 
	}
}

306 
	$hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
 *file,

307 
addr0
, 
Àn
,

308 
pgoff
, 
Êags
)

310 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

311 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

312 
vm_¨ó_°ru˘
 *
vma
, *
¥ev_vma
;

313 
ba£
 = 
mm
->
mm≠_ba£
, 
addr
 = 
addr0
;

314 
œrge°_hﬁe
 = 
mm
->
ˇched_hﬁe_size
;

315 
fú°_time
 = 1;

318 i‡(
mm
->
‰ì_¨ó_ˇche
 > 
ba£
)

319 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

321 i‡(
Àn
 <
œrge°_hﬁe
) {

322 
œrge°_hﬁe
 = 0;

323 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

325 
åy_agaö
:

327 i‡(
mm
->
‰ì_¨ó_ˇche
 < 
Àn
)

328 
Áû
;

331 
addr
 = (
mm
->
‰ì_¨ó_ˇche
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

337 i‡(!(
vma
 = 
	`föd_vma_¥ev
(
mm
, 
addr
, &
¥ev_vma
)))

338  
addr
;

344 i‡(
addr
 + 
Àn
 <
vma
->
vm_°¨t
 &&

345 (!
¥ev_vma
 || (
addr
 >¥ev_vma->
vm_íd
))) {

347 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

348  (
mm
->
‰ì_¨ó_ˇche
 = 
addr
);

351 i‡(
mm
->
‰ì_¨ó_ˇche
 =
vma
->
vm_íd
) {

352 
mm
->
‰ì_¨ó_ˇche
 = 
vma
->
vm_°¨t
;

353 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

358 i‡(
addr
 + 
œrge°_hﬁe
 < 
vma
->
vm_°¨t
)

359 
œrge°_hﬁe
 = 
vma
->
vm_°¨t
 - 
addr
;

362 
addr
 = (
vma
->
vm_°¨t
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

363 } 
Àn
 <
vma
->
vm_°¨t
);

365 
Áû
:

370 i‡(
fú°_time
) {

371 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

372 
œrge°_hﬁe
 = 0;

373 
fú°_time
 = 0;

374 
åy_agaö
;

382 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

383 
mm
->
ˇched_hﬁe_size
 = ~0UL;

384 
addr
 = 
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr0
,

385 
Àn
, 
pgoff
, 
Êags
);

390 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

391 
mm
->
ˇched_hﬁe_size
 = ~0UL;

393  
addr
;

394 
	}
}

397 
	$hugëlb_gë_unm≠≥d_¨ó
(
fûe
 *fûe, 
addr
,

398 
Àn
, 
pgoff
, 
Êags
)

400 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

401 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

402 
vm_¨ó_°ru˘
 *
vma
;

404 i‡(
Àn
 & ~
	`huge_∑ge_mask
(
h
))

405  -
EINVAL
;

406 i‡(
Àn
 > 
TASK_SIZE
)

407  -
ENOMEM
;

409 i‡(
Êags
 & 
MAP_FIXED
) {

410 i‡(
	`¥ï¨e_hugïage_ønge
(
fûe
, 
addr
, 
Àn
))

411  -
EINVAL
;

412  
addr
;

415 i‡(
addr
) {

416 
addr
 = 
	`ALIGN
◊ddr, 
	`huge_∑ge_size
(
h
));

417 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

418 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

419 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

420  
addr
;

422 i‡(
mm
->
gë_unm≠≥d_¨ó
 =
¨ch_gë_unm≠≥d_¨ó
)

423  
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr
, 
Àn
,

424 
pgoff
, 
Êags
);

426  
	`hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
, 
addr
, 
Àn
,

427 
pgoff
, 
Êags
);

428 
	}
}

432 #ifde‡
CONFIG_X86_64


433 
__öô
 
	$£tup_hugïagesz
(*
›t
)

435 
ps
 = 
	`mem∑r£
(
›t
, &opt);

436 i‡(
ps
 =
PMD_SIZE
) {

437 
	`hugëlb_add_h°©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

438 } i‡(
ps
 =
PUD_SIZE
 && 
˝u_has_gb∑ges
) {

439 
	`hugëlb_add_h°©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

441 
	`¥ötk
(
KERN_ERR
 "hugepagesz: UnsupportedÖage size %lu M\n",

442 
ps
 >> 20);

446 
	}
}

447 
__£tup
("hugïagesz=", 
£tup_hugïagesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<löux/öôrd.h
>

2 
	~<löux/i›‹t.h
>

3 
	~<löux/sw≠.h
>

5 
	~<asm/ˇcheÊush.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/öô.h
>

8 
	~<asm/∑ge.h
>

9 
	~<asm/∑ge_ty≥s.h
>

10 
	~<asm/£˘i⁄s.h
>

11 
	~<asm/£tup.h
>

12 
	~<asm/sy°em.h
>

13 
	~<asm/ébÊush.h
>

14 
	~<asm/éb.h
>

15 
	~<asm/¥Ÿo.h
>

17 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

19 
__öôd©a
 
	ge820_èbÀ_°¨t
;

20 
__memöôd©a
 
	ge820_èbÀ_íd
;

21 
__memöôd©a
 
	ge820_èbÀ_t›
;

23 
	ga·î_boŸmem
;

25 
	gdúe˘_gb∑ges


26 #ifde‡
CONFIG_DIRECT_GBPAGES


31 
__öô
 
	$föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
,

32 
u£_gb∑ges
)

34 
puds
, 
pmds
, 
±es
, 
èbÀs
, 
°¨t
;

36 
puds
 = (
íd
 + 
PUD_SIZE
 - 1Ë>> 
PUD_SHIFT
;

37 
èbÀs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

39 i‡(
u£_gb∑ges
) {

40 
exåa
;

42 
exåa
 = 
íd
 - (”nd>>
PUD_SHIFT
) << PUD_SHIFT);

43 
pmds
 = (
exåa
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

45 
pmds
 = (
íd
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

47 
èbÀs
 +
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

49 i‡(
u£_p£
) {

50 
exåa
;

52 
exåa
 = 
íd
 - (”nd>>
PMD_SHIFT
) << PMD_SHIFT);

53 #ifde‡
CONFIG_X86_32


54 
exåa
 +
PMD_SIZE
;

56 
±es
 = (
exåa
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

58 
±es
 = (
íd
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

60 
èbÀs
 +
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

62 #ifde‡
CONFIG_X86_32


64 
èbÀs
 +
	`roundup
(
__íd_of_fixed_addªs£s
 * (
±e_t
), 
PAGE_SIZE
);

72 #ifde‡
CONFIG_X86_32


73 
°¨t
 = 0x7000;

75 
°¨t
 = 0x8000;

77 
e820_èbÀ_°¨t
 = 
	`föd_e820_¨ó
(
°¨t
, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
,

78 
èbÀs
, 
PAGE_SIZE
);

79 i‡(
e820_èbÀ_°¨t
 == -1UL)

80 
	`∑nic
("Cannot find space forÅhe kernelÖageÅables");

82 
e820_èbÀ_°¨t
 >>
PAGE_SHIFT
;

83 
e820_èbÀ_íd
 = 
e820_èbÀ_°¨t
;

84 
e820_èbÀ_t›
 = 
e820_èbÀ_°¨t
 + (
èbÀs
 >> 
PAGE_SHIFT
);

86 
	`¥ötk
(
KERN_DEBUG
 "kernel direct mappingÅables upÅo %lx @ %lx-%lx\n",

87 
íd
, 
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
, 
e820_èbÀ_t›
 << PAGE_SHIFT);

88 
	}
}

90 
	sm≠_ønge
 {

91 
	m°¨t
;

92 
	míd
;

93 
	m∑ge_size_mask
;

96 #ifde‡
CONFIG_X86_32


97 
	#NR_RANGE_MR
 3

	)

99 
	#NR_RANGE_MR
 5

	)

102 
__memöô
 
	$ßve_mr
(
m≠_ønge
 *
mr
, 
ƒ_ønge
,

103 
°¨t_p‚
, 
íd_p‚
,

104 
∑ge_size_mask
)

106 i‡(
°¨t_p‚
 < 
íd_p‚
) {

107 i‡(
ƒ_ønge
 >
NR_RANGE_MR
)

108 
	`∑nic
("run out ofÑange for init_memory_mapping\n");

109 
mr
[
ƒ_ønge
].
°¨t
 = 
°¨t_p‚
<<
PAGE_SHIFT
;

110 
mr
[
ƒ_ønge
].
íd
 = 
íd_p‚
<<
PAGE_SHIFT
;

111 
mr
[
ƒ_ønge
].
∑ge_size_mask
 =Öage_size_mask;

112 
ƒ_ønge
++;

115  
ƒ_ønge
;

116 
	}
}

123 
__öô_ªfok
 
	$öô_mem‹y_m≠pög
(
°¨t
,

124 
íd
)

126 
∑ge_size_mask
 = 0;

127 
°¨t_p‚
, 
íd_p‚
;

128 
ªt
 = 0;

129 
pos
;

131 
m≠_ønge
 
mr
[
NR_RANGE_MR
];

132 
ƒ_ønge
, 
i
;

133 
u£_p£
, 
u£_gb∑ges
;

135 
	`¥ötk
(
KERN_INFO
 "öô_mem‹y_m≠pög: %016lx-%016lx\n", 
°¨t
, 
íd
);

137 #i‡
	`deföed
(
CONFIG_DEBUG_PAGEALLOC
Ë|| deföed(
CONFIG_KMEMCHECK
)

143 
u£_p£
 = 
u£_gb∑ges
 = 0;

145 
u£_p£
 = 
˝u_has_p£
;

146 
u£_gb∑ges
 = 
dúe˘_gb∑ges
;

149 
	`£t_nx
();

150 i‡(
nx_íabÀd
)

151 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection:áctive\n");

154 i‡(
˝u_has_p£
)

155 
	`£t_ö_¸4
(
X86_CR4_PSE
);

158 i‡(
˝u_has_pge
) {

159 
	`£t_ö_¸4
(
X86_CR4_PGE
);

160 
__suµ‹ãd_±e_mask
 |
_PAGE_GLOBAL
;

163 i‡(
u£_gb∑ges
)

164 
∑ge_size_mask
 |1 << 
PG_LEVEL_1G
;

165 i‡(
u£_p£
)

166 
∑ge_size_mask
 |1 << 
PG_LEVEL_2M
;

168 
	`mem£t
(
mr
, 0, (mr));

169 
ƒ_ønge
 = 0;

172 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

173 
pos
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

174 #ifde‡
CONFIG_X86_32


181 i‡(
pos
 == 0)

182 
íd_p‚
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

184 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

185 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

187 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1)Ë>> 
PMD_SHIFT
)

188 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

190 i‡(
íd_p‚
 > (
íd
 >> 
PAGE_SHIFT
))

191 
íd_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

192 i‡(
°¨t_p‚
 < 
íd_p‚
) {

193 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

194 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

198 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

199 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

200 #ifde‡
CONFIG_X86_32


201 
íd_p‚
 = (
íd
>>
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

203 
íd_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

204 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

205 i‡(
íd_p‚
 > ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

206 
íd_p‚
 = ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

209 i‡(
°¨t_p‚
 < 
íd_p‚
) {

210 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

211 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

212 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

215 #ifde‡
CONFIG_X86_64


217 
°¨t_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

218 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

219 
íd_p‚
 = (
íd
 >> 
PUD_SHIFT
Ë<< (PUD_SHIFT - 
PAGE_SHIFT
);

220 i‡(
°¨t_p‚
 < 
íd_p‚
) {

221 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

222 
∑ge_size_mask
 &

223 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

224 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

228 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

229 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

230 
íd_p‚
 = (
íd
 >> 
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

231 i‡(
°¨t_p‚
 < 
íd_p‚
) {

232 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

233 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

234 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

239 
°¨t_p‚
 = 
pos
>>
PAGE_SHIFT
;

240 
íd_p‚
 = 
íd
>>
PAGE_SHIFT
;

241 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

244 
i
 = 0; 
ƒ_ønge
 > 1 && i <Çr_range - 1; i++) {

245 
ﬁd_°¨t
;

246 i‡(
mr
[
i
].
íd
 !mr[i+1].
°¨t
 ||

247 
mr
[
i
].
∑ge_size_mask
 != mr[i+1].page_size_mask)

250 
ﬁd_°¨t
 = 
mr
[
i
].
°¨t
;

251 
	`memmove
(&
mr
[
i
], &mr[i+1],

252 (
ƒ_ønge
 - 1 - 
i
Ë* (
m≠_ønge
));

253 
mr
[
i
--].
°¨t
 = 
ﬁd_°¨t
;

254 
ƒ_ønge
--;

257 
i
 = 0; i < 
ƒ_ønge
; i++)

258 
	`¥ötk
(
KERN_DEBUG
 " %010lx - %010lxÖage %s\n",

259 
mr
[
i
].
°¨t
, mr[i].
íd
,

260 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

261 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

270 i‡(!
a·î_boŸmem
)

271 
	`föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
, 
u£_gb∑ges
);

273 #ifde‡
CONFIG_X86_32


274 
i
 = 0; i < 
ƒ_ønge
; i++)

275 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

276 
mr
[
i
].
∑ge_size_mask
);

277 
ªt
 = 
íd
;

279 
i
 = 0; i < 
ƒ_ønge
; i++)

280 
ªt
 = 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

281 
mr
[
i
].
∑ge_size_mask
);

284 #ifde‡
CONFIG_X86_32


285 
	`óæy_i‹em≠_∑ge_èbÀ_ønge_öô
();

287 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

290 #ifde‡
CONFIG_X86_64


291 i‡(!
a·î_boŸmem
 && !
°¨t
) {

292 
pud_t
 *
pud
;

293 
pmd_t
 *
pmd
;

295 
mmu_¸4_„©uªs
 = 
	`ªad_¸4
();

303 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_íd
), _brk_end);

304 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_íd
 - 1);

305 ++
pmd
 <
	`pmd_off£t
(
pud
, ()
_íd
 - 1))

306 
	`pmd_˛ór
(
pmd
);

309 
	`__Êush_éb_Æl
();

311 i‡(!
a·î_boŸmem
 && 
e820_èbÀ_íd
 > 
e820_èbÀ_°¨t
)

312 
	`ª£rve_óæy
(
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
,

313 
e820_èbÀ_íd
 << 
PAGE_SHIFT
, "PGTABLE");

315 i‡(!
a·î_boŸmem
)

316 
	`óæy_memã°
(
°¨t
, 
íd
);

318  
ªt
 >> 
PAGE_SHIFT
;

319 
	}
}

332 
	$devmem_is_Ælowed
(
∑gír
)

334 i‡(
∑gír
 <= 256)

336 i‡(
	`iomem_is_ex˛usive
(
∑gír
 << 
PAGE_SHIFT
))

338 i‡(!
	`∑ge_is_øm
(
∑gír
))

341 
	}
}

343 
	$‰ì_öô_∑ges
(*
wh©
, 
begö
, 
íd
)

345 
addr
 = 
begö
;

347 i‡(
addr
 >
íd
)

355 #ifde‡
CONFIG_DEBUG_PAGEALLOC


356 
	`¥ötk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

357 
begö
, 
	`PAGE_ALIGN
(
íd
));

358 
	`£t_mem‹y_≈
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

365 
	`£t_mem‹y_rw
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

367 
	`¥ötk
(
KERN_INFO
 "Fªeög %s: %luk fªed\n", 
wh©
, (
íd
 - 
begö
) >> 10);

369 ; 
addr
 < 
íd
;ádd∏+
PAGE_SIZE
) {

370 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
addr
));

371 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
addr
));

372 
	`mem£t
((*)(
addr
 & ~(
PAGE_SIZE
-1)),

373 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

374 
	`‰ì_∑ge
(
addr
);

375 
tŸÆøm_∑ges
++;

378 
	}
}

380 
	$‰ì_öômem
()

382 
	`‰ì_öô_∑ges
("unused kernel memory",

383 ()(&
__öô_begö
),

384 ()(&
__öô_íd
));

385 
	}
}

387 #ifde‡
CONFIG_BLK_DEV_INITRD


388 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

390 
	`‰ì_öô_∑ges
("öôrd mem‹y", 
°¨t
, 
íd
);

391 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<löux/sig«l.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/mm™.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sw≠.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/∑gem≠.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/¥oc_fs.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/p‚.h
>

27 
	~<löux/pois⁄.h
>

28 
	~<löux/dma-m≠pög.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/mem‹y_hŸ∂ug.h
>

31 
	~<löux/nmi.h
>

33 
	~<asm/¥o˚ss‹.h
>

34 
	~<asm/bios_ebda.h
>

35 
	~<asm/sy°em.h
>

36 
	~<asm/uac˚ss.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/pgÆloc.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/e820.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/éb.h
>

44 
	~<asm/mmu_c⁄ãxt.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/smp.h
>

47 
	~<asm/£˘i⁄s.h
>

48 
	~<asm/kdebug.h
>

49 
	~<asm/numa.h
>

50 
	~<asm/ˇcheÊush.h
>

51 
	~<asm/öô.h
>

53 
dma_ª£rve
 
	g__öôd©a
;

55 
__öô
 
	$∑r£_dúe˘_gb∑ges_off
(*
¨g
)

57 
dúe˘_gb∑ges
 = 0;

59 
	}
}

60 
óæy_∑øm
("nogb∑ges", 
∑r£_dúe˘_gb∑ges_off
);

62 
__öô
 
	$∑r£_dúe˘_gb∑ges_⁄
(*
¨g
)

64 
dúe˘_gb∑ges
 = 1;

66 
	}
}

67 
óæy_∑øm
("gb∑ges", 
∑r£_dúe˘_gb∑ges_⁄
);

75 
±evÆ_t
 
__suµ‹ãd_±e_mask
 
	g__ªad_mo°ly
 = ~
_PAGE_IOMAP
;

76 
EXPORT_SYMBOL_GPL
(
__suµ‹ãd_±e_mask
);

78 
	gf‹˚_≥rs⁄Æôy32
;

88 
__öô
 
	$n⁄x32_£tup
(*
°r
)

90 i‡(!
	`°rcmp
(
°r
, "on"))

91 
f‹˚_≥rs⁄Æôy32
 &~
READ_IMPLIES_EXEC
;

92 i‡(!
	`°rcmp
(
°r
, "off"))

93 
f‹˚_≥rs⁄Æôy32
 |
READ_IMPLIES_EXEC
;

95 
	}
}

96 
__£tup
("n€xec32=", 
n⁄x32_£tup
);

102 
__ªf
 *
	$•p_gë∑ge
()

104 *
±r
;

106 i‡(
a·î_boŸmem
)

107 
±r
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

109 
±r
 = 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

111 i‡(!
±r
 || ((Ìå & ~
PAGE_MASK
)) {

112 
	`∑nic
("set_pte_phys: cannotállocateÖage data %s\n",

113 
a·î_boŸmem
 ? "after bootmem" : "");

116 
	`¥_debug
("•p_gë∑gê%p\n", 
±r
);

118  
±r
;

119 
	}
}

121 
pud_t
 *
	$fûl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

123 i‡(
	`pgd_n⁄e
(*
pgd
)) {

124 
pud_t
 *
pud
 = (pud_à*)
	`•p_gë∑ge
();

125 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
pud
);

126 i‡(
pud
 !
	`pud_off£t
(
pgd
, 0))

127 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

128 
pud
, 
	`pud_off£t
(
pgd
, 0));

130  
	`pud_off£t
(
pgd
, 
vaddr
);

131 
	}
}

133 
pmd_t
 *
	$fûl_pmd
(
pud_t
 *
pud
, 
vaddr
)

135 i‡(
	`pud_n⁄e
(*
pud
)) {

136 
pmd_t
 *
pmd
 = (pmd_à*Ë
	`•p_gë∑ge
();

137 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
pmd
);

138 i‡(
pmd
 !
	`pmd_off£t
(
pud
, 0))

139 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

140 
pmd
, 
	`pmd_off£t
(
pud
, 0));

142  
	`pmd_off£t
(
pud
, 
vaddr
);

143 
	}
}

145 
±e_t
 *
	$fûl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

147 i‡(
	`pmd_n⁄e
(*
pmd
)) {

148 
±e_t
 *
±e
 = (±e_à*Ë
	`•p_gë∑ge
();

149 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
±e
);

150 i‡(
±e
 !
	`±e_off£t_kî√l
(
pmd
, 0))

151 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

153  
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

154 
	}
}

156 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_∑ge
, 
vaddr
, 
±e_t
 
√w_±e
)

158 
pud_t
 *
pud
;

159 
pmd_t
 *
pmd
;

160 
±e_t
 *
±e
;

162 
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
vaddr
);

163 
pmd
 = 
	`fûl_pmd
(
pud
, 
vaddr
);

164 
±e
 = 
	`fûl_±e
(
pmd
, 
vaddr
);

166 
	`£t_±e
(
±e
, 
√w_±e
);

172 
	`__Êush_éb_⁄e
(
vaddr
);

173 
	}
}

175 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±evÆ
)

177 
pgd_t
 *
pgd
;

178 
pud_t
 *
pud_∑ge
;

180 
	`¥_debug
("£t_±e_vadd∏%lxÅÿ%lx\n", 
vaddr
, 
	`«tive_±e_vÆ
(
±evÆ
));

182 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

183 i‡(
	`pgd_n⁄e
(*
pgd
)) {

184 
	`¥ötk
(
KERN_ERR


188 
pud_∑ge
 = (
pud_t
*)
	`pgd_∑ge_vaddr
(*
pgd
);

189 
	`£t_±e_vaddr_pud
(
pud_∑ge
, 
vaddr
, 
±evÆ
);

190 
	}
}

192 
pmd_t
 * 
__öô
 
	$p›uœã_exåa_pmd
(
vaddr
)

194 
pgd_t
 *
pgd
;

195 
pud_t
 *
pud
;

197 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

198 
pud
 = 
	`fûl_pud
(
pgd
, 
vaddr
);

199  
	`fûl_pmd
(
pud
, 
vaddr
);

200 
	}
}

202 
±e_t
 * 
__öô
 
	$p›uœã_exåa_±e
(
vaddr
)

204 
pmd_t
 *
pmd
;

206 
pmd
 = 
	`p›uœã_exåa_pmd
(
vaddr
);

207  
	`fûl_±e
(
pmd
, 
vaddr
);

208 
	}
}

213 
__öô
 
	$__öô_exåa_m≠pög
(
phys
, 
size
,

214 
pg¥Ÿ_t
 
¥Ÿ
)

216 
pgd_t
 *
pgd
;

217 
pud_t
 *
pud
;

218 
pmd_t
 *
pmd
;

220 
	`BUG_ON
((
phys
 & ~
PMD_MASK
Ë|| (
size
 & ~PMD_MASK));

221 ; 
size
; 
phys
 +
PMD_SIZE
, size -= PMD_SIZE) {

222 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

223 i‡(
	`pgd_n⁄e
(*
pgd
)) {

224 
pud
 = (
pud_t
 *Ë
	`•p_gë∑ge
();

225 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
 |

226 
_PAGE_USER
));

228 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

229 i‡(
	`pud_n⁄e
(*
pud
)) {

230 
pmd
 = (
pmd_t
 *Ë
	`•p_gë∑ge
();

231 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
 |

232 
_PAGE_USER
));

234 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

235 
	`BUG_ON
(!
	`pmd_n⁄e
(*
pmd
));

236 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg¥Ÿ_vÆ
(
¥Ÿ
)));

238 
	}
}

240 
__öô
 
	$öô_exåa_m≠pög_wb
(
phys
, 
size
)

242 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

243 
	}
}

245 
__öô
 
	$öô_exåa_m≠pög_uc
(
phys
, 
size
)

247 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

248 
	}
}

263 
__öô
 
	$˛ónup_highm≠
()

265 
vaddr
 = 
__START_KERNEL_m≠
;

266 
íd
 = 
	`roundup
(()
_íd
, 
PMD_SIZE
) - 1;

267 
pmd_t
 *
pmd
 = 
Àvñ2_kî√l_pgt
;

268 
pmd_t
 *
œ°_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

270 ; 
pmd
 < 
œ°_pmd
;Ömd++, 
vaddr
 +
PMD_SIZE
) {

271 i‡(
	`pmd_n⁄e
(*
pmd
))

273 i‡(
vaddr
 < (Ë
_ãxt
 || vadd∏> 
íd
)

274 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

276 
	}
}

278 
__ªf
 *
	$Æloc_low_∑ge
(*
phys
)

280 
p‚
 = 
e820_èbÀ_íd
++;

281 *
adr
;

283 i‡(
a·î_boŸmem
) {

284 
adr
 = (*)
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

285 *
phys
 = 
	`__∑
(
adr
);

287  
adr
;

290 i‡(
p‚
 >
e820_èbÀ_t›
)

291 
	`∑nic
("alloc_low_page:Ñan out of memory");

293 
adr
 = 
	`óæy_memªm≠
(
p‚
 * 
PAGE_SIZE
, PAGE_SIZE);

294 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

295 *
phys
 = 
p‚
 * 
PAGE_SIZE
;

296  
adr
;

297 
	}
}

299 
__ªf
 
	$unm≠_low_∑ge
(*
adr
)

301 i‡(
a·î_boŸmem
)

304 
	`óæy_iounm≠
(
adr
, 
PAGE_SIZE
);

305 
	}
}

307 
__memöô


308 
	$phys_±e_öô
(
±e_t
 *
±e_∑ge
, 
addr
, 
íd
,

309 
pg¥Ÿ_t
 
¥Ÿ
)

311 
∑ges
 = 0;

312 
œ°_m≠_addr
 = 
íd
;

313 
i
;

315 
±e_t
 *
±e
 = 
±e_∑ge
 + 
	`±e_ödex
(
addr
);

317 
i
 = 
	`±e_ödex
(
addr
); i < 
PTRS_PER_PTE
; i++,ádd∏+
PAGE_SIZE
, 
±e
++) {

319 i‡(
addr
 >
íd
) {

320 i‡(!
a·î_boŸmem
) {

321 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

322 
	`£t_±e
(
±e
, 
	`__±e
(0));

333 i‡(
	`±e_vÆ
(*
±e
)) {

334 
∑ges
++;

339 
	`¥ötk
("Öte=%páddr=%lxÖte=%016lx\n",

340 
±e
, 
addr
, 
	`p‚_±e
◊dd∏>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

341 
∑ges
++;

342 
	`£t_±e
(
±e
, 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
¥Ÿ
));

343 
œ°_m≠_addr
 = (
addr
 & 
PAGE_MASK
Ë+ 
PAGE_SIZE
;

346 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_4K
, 
∑ges
);

348  
œ°_m≠_addr
;

349 
	}
}

351 
__memöô


352 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
addªss
, 
íd
,

353 
pg¥Ÿ_t
 
¥Ÿ
)

355 
±e_t
 *
±e
 = (±e_à*)
	`pmd_∑ge_vaddr
(*
pmd
);

357  
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
¥Ÿ
);

358 
	}
}

360 
__memöô


361 
	$phys_pmd_öô
(
pmd_t
 *
pmd_∑ge
, 
addªss
, 
íd
,

362 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

364 
∑ges
 = 0;

365 
œ°_m≠_addr
 = 
íd
;

367 
i
 = 
	`pmd_ödex
(
addªss
);

369 ; 
i
 < 
PTRS_PER_PMD
; i++, 
addªss
 +
PMD_SIZE
) {

370 
±e_phys
;

371 
pmd_t
 *
pmd
 = 
pmd_∑ge
 + 
	`pmd_ödex
(
addªss
);

372 
±e_t
 *
±e
;

373 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
¥Ÿ
;

375 i‡(
addªss
 >
íd
) {

376 i‡(!
a·î_boŸmem
) {

377 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

378 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

383 i‡(
	`pmd_vÆ
(*
pmd
)) {

384 i‡(!
	`pmd_œrge
(*
pmd
)) {

385 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

386 
œ°_m≠_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
addªss
,

387 
íd
, 
¥Ÿ
);

388 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

403 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

404 
∑ges
++;

407 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pmd
));

410 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

411 
∑ges
++;

412 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

413 
	`£t_±e
((
±e_t
 *)
pmd
,

414 
	`p‚_±e
(
addªss
 >> 
PAGE_SHIFT
,

415 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_PSE
)));

416 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

417 
œ°_m≠_addr
 = (
addªss
 & 
PMD_MASK
Ë+ 
PMD_SIZE
;

421 
±e
 = 
	`Æloc_low_∑ge
(&
±e_phys
);

422 
œ°_m≠_addr
 = 
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
√w_¥Ÿ
);

423 
	`unm≠_low_∑ge
(
±e
);

425 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

426 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
	`__va
(
±e_phys
));

427 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

429 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_2M
, 
∑ges
);

430  
œ°_m≠_addr
;

431 
	}
}

433 
__memöô


434 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
addªss
, 
íd
,

435 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

437 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

438 
œ°_m≠_addr
;

440 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addªss
, 
íd
, 
∑ge_size_mask
, 
¥Ÿ
);

441 
	`__Êush_éb_Æl
();

442  
œ°_m≠_addr
;

443 
	}
}

445 
__memöô


446 
	$phys_pud_öô
(
pud_t
 *
pud_∑ge
, 
addr
, 
íd
,

447 
∑ge_size_mask
)

449 
∑ges
 = 0;

450 
œ°_m≠_addr
 = 
íd
;

451 
i
 = 
	`pud_ödex
(
addr
);

453 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add∏& 
PUD_MASK
Ë+ 
PUD_SIZE
) {

454 
pmd_phys
;

455 
pud_t
 *
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
addr
);

456 
pmd_t
 *
pmd
;

457 
pg¥Ÿ_t
 
¥Ÿ
 = 
PAGE_KERNEL
;

459 i‡(
addr
 >
íd
)

462 i‡(!
a·î_boŸmem
 &&

463 !
	`e820_™y_m≠≥d
(
addr
,áddr+
PUD_SIZE
, 0)) {

464 
	`£t_pud
(
pud
, 
	`__pud
(0));

468 i‡(
	`pud_vÆ
(*
pud
)) {

469 i‡(!
	`pud_œrge
(*
pud
)) {

470 
œ°_m≠_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
íd
,

471 
∑ge_size_mask
, 
¥Ÿ
);

486 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

487 
∑ges
++;

490 
¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pud
));

493 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

494 
∑ges
++;

495 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

496 
	`£t_±e
((
±e_t
 *)
pud
,

497 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

498 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

499 
œ°_m≠_addr
 = (
addr
 & 
PUD_MASK
Ë+ 
PUD_SIZE
;

503 
pmd
 = 
	`Æloc_low_∑ge
(&
pmd_phys
);

504 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addr
, 
íd
, 
∑ge_size_mask
,

505 
¥Ÿ
);

506 
	`unm≠_low_∑ge
(
pmd
);

508 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

509 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
	`__va
(
pmd_phys
));

510 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

512 
	`__Êush_éb_Æl
();

514 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_1G
, 
∑ges
);

516  
œ°_m≠_addr
;

517 
	}
}

519 
__memöô


520 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
íd
,

521 
∑ge_size_mask
)

523 
pud_t
 *
pud
;

525 
pud
 = (
pud_t
 *)
	`pgd_∑ge_vaddr
(*
pgd
);

527  
	`phys_pud_öô
(
pud
, 
addr
, 
íd
, 
∑ge_size_mask
);

528 
	}
}

530 
__memöô


531 
	$kî√l_physiˇl_m≠pög_öô
(
°¨t
,

532 
íd
,

533 
∑ge_size_mask
)

536 
√xt
, 
œ°_m≠_addr
 = 
íd
;

538 
°¨t
 = ()
	`__va
(start);

539 
íd
 = ()
	`__va
(end);

541 ; 
°¨t
 < 
íd
; sèπ = 
√xt
) {

542 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
°¨t
);

543 
pud_phys
;

544 
pud_t
 *
pud
;

546 
√xt
 = (
°¨t
 + 
PGDIR_SIZE
Ë& 
PGDIR_MASK
;

547 i‡(
√xt
 > 
íd
)

548 
√xt
 = 
íd
;

550 i‡(
	`pgd_vÆ
(*
pgd
)) {

551 
œ°_m≠_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__∑
(
°¨t
),

552 
	`__∑
(
íd
), 
∑ge_size_mask
);

556 
pud
 = 
	`Æloc_low_∑ge
(&
pud_phys
);

557 
œ°_m≠_addr
 = 
	`phys_pud_öô
(
pud
, 
	`__∑
(
°¨t
), __∑(
√xt
),

558 
∑ge_size_mask
);

559 
	`unm≠_low_∑ge
(
pud
);

561 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

562 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
	`__va
(
pud_phys
));

563 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

565 
	`__Êush_éb_Æl
();

567  
œ°_m≠_addr
;

568 
	}
}

570 #i‚de‡
CONFIG_NUMA


571 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
íd_p‚
)

573 
boŸm≠_size
, 
boŸm≠
;

575 
boŸm≠_size
 = 
	`boŸmem_boŸm≠_∑ges
(
íd_p‚
)<<
PAGE_SHIFT
;

576 
boŸm≠
 = 
	`föd_e820_¨ó
(0, 
íd_p‚
<<
PAGE_SHIFT
, 
boŸm≠_size
,

577 
PAGE_SIZE
);

578 i‡(
boŸm≠
 == -1L)

579 
	`∑nic
("C™nŸ föd boŸmem m≠ o‡sizê%ld\n", 
boŸm≠_size
);

581 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(0), 
boŸm≠
 >> 
PAGE_SHIFT
,

582 0, 
íd_p‚
);

583 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

584 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(0, 
íd_p‚
);

585 
	`óæy_ªs_to_boŸmem
(0, 
íd_p‚
<<
PAGE_SHIFT
);

586 
	`ª£rve_boŸmem
(
boŸm≠
, 
boŸm≠_size
, 
BOOTMEM_DEFAULT
);

587 
	}
}

590 
__öô
 
	$∑gög_öô
()

592 
max_z⁄e_p‚s
[
MAX_NR_ZONES
];

594 
	`mem£t
(
max_z⁄e_p‚s
, 0, (max_zone_pfns));

595 
max_z⁄e_p‚s
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

596 
max_z⁄e_p‚s
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

597 
max_z⁄e_p‚s
[
ZONE_NORMAL
] = 
max_p‚
;

599 
	`•¨£_mem‹y_¥e£¡_wôh_a˘ive_ªgi⁄s
(
MAX_NUMNODES
);

600 
	`•¨£_öô
();

608 
	`node_˛ór_°©e
(0, 
N_NORMAL_MEMORY
);

610 
	`‰ì_¨ó_öô_nodes
(
max_z⁄e_p‚s
);

611 
	}
}

616 #ifde‡
CONFIG_MEMORY_HOTPLUG


621 
	$¨ch_add_mem‹y
(
nid
, 
u64
 
°¨t
, u64 
size
)

623 
pgli°_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

624 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
ZONE_NORMAL
;

625 
œ°_m≠≥d_p‚
, 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

626 
ƒ_∑ges
 = 
size
 >> 
PAGE_SHIFT
;

627 
ªt
;

629 
œ°_m≠≥d_p‚
 = 
	`öô_mem‹y_m≠pög
(
°¨t
, sèπ + 
size
);

630 i‡(
œ°_m≠≥d_p‚
 > 
max_p‚_m≠≥d
)

631 
max_p‚_m≠≥d
 = 
œ°_m≠≥d_p‚
;

633 
ªt
 = 
	`__add_∑ges
(
nid
, 
z⁄e
, 
°¨t_p‚
, 
ƒ_∑ges
);

634 
	`WARN_ON_ONCE
(
ªt
);

636  
ªt
;

637 
	}
}

638 
EXPORT_SYMBOL_GPL
(
¨ch_add_mem‹y
);

640 #i‡!
deföed
(
CONFIG_ACPI_NUMA
Ë&& deföed(
CONFIG_NUMA
)

641 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

644 
	}
}

645 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

650 
kc‹e_li°
 
	gkc‹e_vsysˇŒ
;

652 
__öô
 
	$mem_öô
()

654 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
;

655 
ab£¡_∑ges
;

657 
	`pci_iommu_Æloc
();

661 
ª£rved∑ges
 = 0;

664 #ifde‡
CONFIG_NUMA


665 
tŸÆøm_∑ges
 = 
	`numa_‰ì_Æl_boŸmem
();

667 
tŸÆøm_∑ges
 = 
	`‰ì_Æl_boŸmem
();

670 
ab£¡_∑ges
 = 
	`ab£¡_∑ges_ö_ønge
(0, 
max_p‚
);

671 
ª£rved∑ges
 = 
max_p‚
 - 
tŸÆøm_∑ges
 - 
ab£¡_∑ges
;

672 
a·î_boŸmem
 = 1;

674 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

675 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_ëext
;

676 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

679 
	`k˛i°_add
(&
kc‹e_vsysˇŒ
, (*)
VSYSCALL_START
,

680 
VSYSCALL_END
 - 
VSYSCALL_START
, 
KCORE_OTHER
);

682 
	`¥ötk
(
KERN_INFO
 "Memory: %luk/%lukávailable (%ldk kernel code, "

684 
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

685 
max_p‚
 << (
PAGE_SHIFT
-10),

686 
codesize
 >> 10,

687 
ab£¡_∑ges
 << (
PAGE_SHIFT
-10),

688 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

689 
d©asize
 >> 10,

690 
öôsize
 >> 10);

691 
	}
}

693 #ifde‡
CONFIG_DEBUG_RODATA


694 c⁄° 
	grod©a_ã°_d©a
 = 0xC3;

695 
EXPORT_SYMBOL_GPL
(
rod©a_ã°_d©a
);

697 
	gkî√l_£t_to_ªad⁄ly
;

699 
	$£t_kî√l_ãxt_rw
()

701 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
);

702 
íd
 = 
	`PFN_ALIGN
(
__°¨t_rod©a
);

704 i‡(!
kî√l_£t_to_ªad⁄ly
)

707 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead write\n",

708 
°¨t
, 
íd
);

710 
	`£t_mem‹y_rw
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

711 
	}
}

713 
	$£t_kî√l_ãxt_ro
()

715 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
);

716 
íd
 = 
	`PFN_ALIGN
(
__°¨t_rod©a
);

718 i‡(!
kî√l_£t_to_ªad⁄ly
)

721 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead only\n",

722 
°¨t
, 
íd
);

724 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

725 
	}
}

727 
	$m¨k_rod©a_ro
()

729 
°¨t
 = 
	`PFN_ALIGN
(
_°ext
), 
íd
 = PFN_ALIGN(
__íd_rod©a
);

730 
rod©a_°¨t
 =

731 (()
__°¨t_rod©a
 + 
PAGE_SIZE
 - 1Ë& 
PAGE_MASK
;

733 
	`¥ötk
(
KERN_INFO
 "WriteÖrotectingÅhe kernelÑead-only data: %luk\n",

734 (
íd
 - 
°¨t
) >> 10);

735 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

737 
kî√l_£t_to_ªad⁄ly
 = 1;

743 
	`£t_mem‹y_nx
(
rod©a_°¨t
, (
íd
 -Ñod©a_°¨tË>> 
PAGE_SHIFT
);

745 
	`rod©a_ã°
();

747 #ifde‡
CONFIG_CPA_DEBUG


748 
	`¥ötk
(
KERN_INFO
 "Te°ög CPA: undÿ%lx-%lx\n", 
°¨t
, 
íd
);

749 
	`£t_mem‹y_rw
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

751 
	`¥ötk
(
KERN_INFO
 "Testing CPA:ágain\n");

752 
	`£t_mem‹y_ro
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

754 
	}
}

758 
__öô
 
	$ª£rve_boŸmem_gíîic
(
phys
, 
Àn
,

759 
Êags
)

761 #ifde‡
CONFIG_NUMA


762 
nid
, 
√xt_nid
;

763 
ªt
;

765 
p‚
 = 
phys
 >> 
PAGE_SHIFT
;

767 i‡(
p‚
 >
max_p‚
) {

772 i‡(
p‚
 < 
max_p‚_m≠≥d
)

773  -
EFAULT
;

775 
	`¥ötk
(
KERN_ERR
 "reserve_bootmem: illegalÑeserve %lx %lu\n",

776 
phys
, 
Àn
);

777  -
EFAULT
;

781 #ifde‡
CONFIG_NUMA


782 
nid
 = 
	`phys_to_nid
(
phys
);

783 
√xt_nid
 = 
	`phys_to_nid
(
phys
 + 
Àn
 - 1);

784 i‡(
nid
 =
√xt_nid
)

785 
ªt
 = 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Àn
, 
Êags
);

787 
ªt
 = 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

789 i‡(
ªt
 != 0)

790  
ªt
;

793 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

796 i‡(
phys
+
Àn
 <
MAX_DMA_PFN
*
PAGE_SIZE
) {

797 
dma_ª£rve
 +
Àn
 / 
PAGE_SIZE
;

798 
	`£t_dma_ª£rve
(
dma_ª£rve
);

802 
	}
}

804 
	$kîn_addr_vÆid
(
addr
)

806 
above
 = (()
addr
Ë>> 
__VIRTUAL_MASK_SHIFT
;

807 
pgd_t
 *
pgd
;

808 
pud_t
 *
pud
;

809 
pmd_t
 *
pmd
;

810 
±e_t
 *
±e
;

812 i‡(
above
 != 0 &&ábove != -1UL)

815 
pgd
 = 
	`pgd_off£t_k
(
addr
);

816 i‡(
	`pgd_n⁄e
(*
pgd
))

819 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

820 i‡(
	`pud_n⁄e
(*
pud
))

823 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

824 i‡(
	`pmd_n⁄e
(*
pmd
))

827 i‡(
	`pmd_œrge
(*
pmd
))

828  
	`p‚_vÆid
(
	`pmd_p‚
(*
pmd
));

830 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addr
);

831 i‡(
	`±e_n⁄e
(*
±e
))

834  
	`p‚_vÆid
(
	`±e_p‚
(*
±e
));

835 
	}
}

842 
vm_¨ó_°ru˘
 
	gg©e_vma
 = {

843 .
vm_°¨t
 = 
VSYSCALL_START
,

844 .
	gvm_íd
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

845 .
	gvm_∑ge_¥Ÿ
 = 
PAGE_READONLY_EXEC
,

846 .
	gvm_Êags
 = 
VM_READ
 | 
VM_EXEC


849 
vm_¨ó_°ru˘
 *
	$gë_g©e_vma
(
èsk_°ru˘
 *
tsk
)

851 #ifde‡
CONFIG_IA32_EMULATION


852 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
))

853  
NULL
;

855  &
g©e_vma
;

856 
	}
}

858 
	$ö_g©e_¨ó
(
èsk_°ru˘
 *
èsk
, 
addr
)

860 
vm_¨ó_°ru˘
 *
vma
 = 
	`gë_g©e_vma
(
èsk
);

862 i‡(!
vma
)

865  (
addr
 >
vma
->
vm_°¨t
Ë&& (add∏< vma->
vm_íd
);

866 
	}
}

873 
	$ö_g©e_¨ó_no_èsk
(
addr
)

875  (
addr
 >
VSYSCALL_START
Ë&& (add∏< 
VSYSCALL_END
);

876 
	}
}

878 c⁄° *
	$¨ch_vma_«me
(
vm_¨ó_°ru˘
 *
vma
)

880 i‡(
vma
->
vm_mm
 && vma->
vm_°¨t
 =()vma->vm_mm->
c⁄ãxt
.
vdso
)

882 i‡(
vma
 =&
g©e_vma
)

884  
NULL
;

885 
	}
}

887 #ifde‡
CONFIG_SPARSEMEM_VMEMMAP


891 
__memöôd©a
 
	gaddr_°¨t
, 
	gaddr_íd
;

892 
__memöôd©a
 *
	gp_°¨t
, *
	gp_íd
;

893 
__memöôd©a
 
	gnode_°¨t
;

895 
__memöô


896 
	$vmemm≠_p›uœã
(
∑ge
 *
°¨t_∑ge
, 
size
, 
node
)

898 
addr
 = ()
°¨t_∑ge
;

899 
íd
 = ()(
°¨t_∑ge
 + 
size
);

900 
√xt
;

901 
pgd_t
 *
pgd
;

902 
pud_t
 *
pud
;

903 
pmd_t
 *
pmd
;

905 ; 
addr
 < 
íd
;ádd∏
√xt
) {

906 *
p
 = 
NULL
;

908 
pgd
 = 
	`vmemm≠_pgd_p›uœã
(
addr
, 
node
);

909 i‡(!
pgd
)

910  -
ENOMEM
;

912 
pud
 = 
	`vmemm≠_pud_p›uœã
(
pgd
, 
addr
, 
node
);

913 i‡(!
pud
)

914  -
ENOMEM
;

916 i‡(!
˝u_has_p£
) {

917 
√xt
 = (
addr
 + 
PAGE_SIZE
Ë& 
PAGE_MASK
;

918 
pmd
 = 
	`vmemm≠_pmd_p›uœã
(
pud
, 
addr
, 
node
);

920 i‡(!
pmd
)

921  -
ENOMEM
;

923 
p
 = 
	`vmemm≠_±e_p›uœã
(
pmd
, 
addr
, 
node
);

925 i‡(!
p
)

926  -
ENOMEM
;

928 
addr_íd
 = 
addr
 + 
PAGE_SIZE
;

929 
p_íd
 = 
p
 + 
PAGE_SIZE
;

931 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

933 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

934 i‡(
	`pmd_n⁄e
(*
pmd
)) {

935 
±e_t
 
íåy
;

937 
p
 = 
	`vmemm≠_Æloc_block
(
PMD_SIZE
, 
node
);

938 i‡(!
p
)

939  -
ENOMEM
;

941 
íåy
 = 
	`p‚_±e
(
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

942 
PAGE_KERNEL_LARGE
);

943 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_vÆ
(
íåy
)));

946 i‡(
p_íd
 !
p
 || 
node_°¨t
 !
node
) {

947 i‡(
p_°¨t
)

948 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

949 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

950 
addr_°¨t
 = 
addr
;

951 
node_°¨t
 = 
node
;

952 
p_°¨t
 = 
p
;

955 
addr_íd
 = 
addr
 + 
PMD_SIZE
;

956 
p_íd
 = 
p
 + 
PMD_SIZE
;

958 
	`vmemm≠_vîify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
√xt
);

963 
	}
}

965 
__memöô
 
	$vmemm≠_p›uœã_¥öt_œ°
()

967 i‡(
p_°¨t
) {

968 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

969 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

970 
p_°¨t
 = 
NULL
;

971 
p_íd
 = 
NULL
;

972 
node_°¨t
 = 0;

974 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<löux/boŸmem.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/io.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/mmiŸø˚.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm≠.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/∑t.h
>

25 
	~"phyßddr.h
"

27 
	$∑ge_is_øm
(
∑gír
)

29 
ªsour˚_size_t
 
addr
, 
íd
;

30 
i
;

37 i‡(
∑gír
 == 0)

44 i‡(
∑gír
 >(
BIOS_BEGIN
 >> 
PAGE_SHIFT
) &&

45 
∑gír
 < (
BIOS_END
 >> 
PAGE_SHIFT
))

48 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RAM
)

54 
addr
 = (
e820
.
m≠
[
i
].add∏+ 
PAGE_SIZE
-1Ë>> 
PAGE_SHIFT
;

55 
íd
 = (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
Ë>> 
PAGE_SHIFT
;

58 i‡((
∑gír
 >
addr
Ë&& (∑gí∏< 
íd
))

62 
	}
}

68 
	$i‹em≠_ch™ge_©å
(
vaddr
, 
size
,

69 
¥Ÿ_vÆ
)

71 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

72 
îr
;

74 
¥Ÿ_vÆ
) {

75 
_PAGE_CACHE_UC
:

77 
îr
 = 
	`_£t_mem‹y_uc
(
vaddr
, 
ƒ∑ges
);

79 
_PAGE_CACHE_WC
:

80 
îr
 = 
	`_£t_mem‹y_wc
(
vaddr
, 
ƒ∑ges
);

82 
_PAGE_CACHE_WB
:

83 
îr
 = 
	`_£t_mem‹y_wb
(
vaddr
, 
ƒ∑ges
);

87  
îr
;

88 
	}
}

99 
__iomem
 *
	$__i‹em≠_ˇŒî
(
ªsour˚_size_t
 
phys_addr
,

100 
size
, 
¥Ÿ_vÆ
, *
ˇŒî
)

102 
p‚
, 
off£t
, 
vaddr
;

103 
ªsour˚_size_t
 
œ°_addr
;

104 c⁄° 
ªsour˚_size_t
 
u«lig√d_phys_addr
 = 
phys_addr
;

105 c⁄° 
u«lig√d_size
 = 
size
;

106 
vm_°ru˘
 *
¨ó
;

107 
√w_¥Ÿ_vÆ
;

108 
pg¥Ÿ_t
 
¥Ÿ
;

109 
ªtvÆ
;

110 
__iomem
 *
ªt_addr
;

113 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

114 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
)

115  
NULL
;

117 i‡(!
	`phys_addr_vÆid
(
phys_addr
)) {

118 
	`¥ötk
(
KERN_WARNING
 "ioremap: invalidÖhysicaláddress %llx\n",

119 ()
phys_addr
);

120 
	`WARN_ON_ONCE
(1);

121  
NULL
;

127 i‡(
	`is_ISA_ønge
(
phys_addr
, 
œ°_addr
))

128  (
__f‹˚
 
__iomem
 *)
	`phys_to_vút
(
phys_addr
);

134 
	`WARN_ONCE
(
	`iomem_m≠_ßnôy_check
(
phys_addr
, 
size
),

135 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

140 
p‚
 = 
phys_addr
 >> 
PAGE_SHIFT
;

141 (
p‚
 << 
PAGE_SHIFT
Ë< (
œ°_addr
 & 
PAGE_MASK
);

142 
p‚
++) {

144 
is_øm
 = 
	`∑ge_is_øm
(
p‚
);

146 i‡(
is_øm
 && 
	`p‚_vÆid
(
p‚
Ë&& !
	`PageRe£rved
(
	`p‚_to_∑ge
(pfn)))

147  
NULL
;

148 
	`WARN_ON_ONCE
(
is_øm
);

154 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

155 
phys_addr
 &
PAGE_MASK
;

156 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
+1Ë- 
phys_addr
;

158 
ªtvÆ
 = 
	`ª£rve_memty≥
(
phys_addr
, (
u64
Ìhys_add∏+ 
size
,

159 
¥Ÿ_vÆ
, &
√w_¥Ÿ_vÆ
);

160 i‡(
ªtvÆ
) {

161 
	`¥ötk
(
KERN_ERR
 "i‹em≠Ñe£rve_memty≥ faûed %d\n", 
ªtvÆ
);

162  
NULL
;

165 i‡(
¥Ÿ_vÆ
 !
√w_¥Ÿ_vÆ
) {

166 i‡(!
	`is_√w_memty≥_Ælowed
(
phys_addr
, 
size
,

167 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
)) {

168 
	`¥ötk
(
KERN_ERR


170 ()
phys_addr
,

171 ()(
phys_addr
 + 
size
),

172 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
);

173 
îr_‰ì_memty≥
;

175 
¥Ÿ_vÆ
 = 
√w_¥Ÿ_vÆ
;

178 
¥Ÿ_vÆ
) {

179 
_PAGE_CACHE_UC
:

181 
¥Ÿ
 = 
PAGE_KERNEL_IO_NOCACHE
;

183 
_PAGE_CACHE_UC_MINUS
:

184 
¥Ÿ
 = 
PAGE_KERNEL_IO_UC_MINUS
;

186 
_PAGE_CACHE_WC
:

187 
¥Ÿ
 = 
PAGE_KERNEL_IO_WC
;

189 
_PAGE_CACHE_WB
:

190 
¥Ÿ
 = 
PAGE_KERNEL_IO
;

197 
¨ó
 = 
	`gë_vm_¨ó_ˇŒî
(
size
, 
VM_IOREMAP
, 
ˇŒî
);

198 i‡(!
¨ó
)

199 
îr_‰ì_memty≥
;

200 
¨ó
->
phys_addr
 =Öhys_addr;

201 
vaddr
 = (Ë
¨ó
->
addr
;

203 i‡(
	`kî√l_m≠_sync_memty≥
(
phys_addr
, 
size
, 
¥Ÿ_vÆ
))

204 
îr_‰ì_¨ó
;

206 i‡(
	`i‹em≠_∑ge_ønge
(
vaddr
, vadd∏+ 
size
, 
phys_addr
, 
¥Ÿ
))

207 
îr_‰ì_¨ó
;

209 
ªt_addr
 = (
__iomem
 *Ë(
vaddr
 + 
off£t
);

210 
	`mmiŸø˚_i‹em≠
(
u«lig√d_phys_addr
, 
u«lig√d_size
, 
ªt_addr
);

212  
ªt_addr
;

213 
îr_‰ì_¨ó
:

214 
	`‰ì_vm_¨ó
(
¨ó
);

215 
îr_‰ì_memty≥
:

216 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

217  
NULL
;

218 
	}
}

241 
__iomem
 *
	$i‹em≠_noˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

250 
vÆ
 = 
_PAGE_CACHE_UC_MINUS
;

252  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
vÆ
,

253 
	`__buûtö_ªtu∫_addªss
(0));

254 
	}
}

255 
EXPORT_SYMBOL
(
i‹em≠_noˇche
);

267 
__iomem
 *
	$i‹em≠_wc
(
ªsour˚_size_t
 
phys_addr
, 
size
)

269 i‡(
∑t_íabÀd
)

270  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

271 
	`__buûtö_ªtu∫_addªss
(0));

273  
	`i‹em≠_noˇche
(
phys_addr
, 
size
);

274 
	}
}

275 
EXPORT_SYMBOL
(
i‹em≠_wc
);

277 
__iomem
 *
	$i‹em≠_ˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

279  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

280 
	`__buûtö_ªtu∫_addªss
(0));

281 
	}
}

282 
EXPORT_SYMBOL
(
i‹em≠_ˇche
);

284 
__iomem
 *
	$i‹em≠_deÁu…
(
ªsour˚_size_t
 
phys_addr
,

285 
size
)

287 
Êags
;

288 
__iomem
 *
ªt
;

289 
îr
;

296 
îr
 = 
	`ª£rve_memty≥
(
phys_addr
,Öhys_add∏+ 
size
,

297 
_PAGE_CACHE_WB
, &
Êags
);

298 i‡(
îr
 < 0)

299  
NULL
;

301 
ªt
 = 
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
Êags
,

302 
	`__buûtö_ªtu∫_addªss
(0));

304 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

305  
ªt
;

306 
	}
}

308 
__iomem
 *
	$i‹em≠_¥Ÿ
(
ªsour˚_size_t
 
phys_addr
, 
size
,

309 
¥Ÿ_vÆ
)

311  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, (
¥Ÿ_vÆ
 & 
_PAGE_CACHE_MASK
),

312 
	`__buûtö_ªtu∫_addªss
(0));

313 
	}
}

314 
EXPORT_SYMBOL
(
i‹em≠_¥Ÿ
);

322 
	$iounm≠
(vﬁ©ûê
__iomem
 *
addr
)

324 
vm_°ru˘
 *
p
, *
o
;

326 i‡((
__f‹˚
 *)
addr
 <
high_mem‹y
)

334 i‡((
__f‹˚
 *)
addr
 >
	`phys_to_vút
(
ISA_START_ADDRESS
) &&

335 (
__f‹˚
 *)
addr
 < 
	`phys_to_vút
(
ISA_END_ADDRESS
))

338 
addr
 = (vﬁ©ûê
__iomem
 *)

339 (
PAGE_MASK
 & (
__f‹˚
)
addr
);

341 
	`mmiŸø˚_iounm≠
(
addr
);

348 
	`ªad_lock
(&
vmli°_lock
);

349 
p
 = 
vmli°
;Ö;Ö =Ö->
√xt
) {

350 i‡(
p
->
addr
 =(
__f‹˚
 *)addr)

353 
	`ªad_u∆ock
(&
vmli°_lock
);

355 i‡(!
p
) {

356 
	`¥ötk
(
KERN_ERR
 "iounm≠: badáddªs†%p\n", 
addr
);

357 
	`dump_°ack
();

361 
	`‰ì_memty≥
(
p
->
phys_addr
,Ö->phys_add∏+ 
	`gë_vm_¨ó_size
(p));

364 
o
 = 
	`ªmove_vm_¨ó
((
__f‹˚
 *)
addr
);

365 
	`BUG_ON
(
p
 !
o
 || o =
NULL
);

366 
	`k‰ì
(
p
);

367 
	}
}

368 
EXPORT_SYMBOL
(
iounm≠
);

374 *
	$xœã_dev_mem_±r
(
phys
)

376 *
addr
;

377 
°¨t
 = 
phys
 & 
PAGE_MASK
;

380 i‡(
	`∑ge_is_øm
(
°¨t
 >> 
PAGE_SHIFT
))

381  
	`__va
(
phys
);

383 
addr
 = (
__f‹˚
 *)
	`i‹em≠_deÁu…
(
°¨t
, 
PAGE_SIZE
);

384 i‡(
addr
)

385 
addr
 = (*)((Ôdd∏| (
phys
 & ~
PAGE_MASK
));

387  
addr
;

388 
	}
}

390 
	$unxœã_dev_mem_±r
(
phys
, *
addr
)

392 i‡(
	`∑ge_is_øm
(
phys
 >> 
PAGE_SHIFT
))

395 
	`iounm≠
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

397 
	}
}

399 
__öôd©a
 
	góæy_i‹em≠_debug
;

401 
__öô
 
	$óæy_i‹em≠_debug_£tup
(*
°r
)

403 
óæy_i‹em≠_debug
 = 1;

406 
	}
}

407 
óæy_∑øm
("óæy_i‹em≠_debug", 
óæy_i‹em≠_debug_£tup
);

409 
__öôd©a
 
	ga·î_∑gög_öô
;

410 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/’ã_t)] 
	g__∑ge_Æig√d_bss
;

412 
ölöe
 
pmd_t
 * 
__öô
 
	$óæy_i‹em≠_pmd
(
addr
)

415 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

416 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addr
)];

417 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

418 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

420  
pmd
;

421 
	}
}

423 
ölöe
 
±e_t
 * 
__öô
 
	$óæy_i‹em≠_±e
(
addr
)

425  &
bm_±e
[
	`±e_ödex
(
addr
)];

426 
	}
}

428 
	g¶Ÿ_vút
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

430 
__öô
 
	$óæy_i‹em≠_öô
()

432 
pmd_t
 *
pmd
;

433 
i
;

435 i‡(
óæy_i‹em≠_debug
)

436 
	`¥ötk
(
KERN_INFO
 "early_ioremap_init()\n");

438 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

439 
¶Ÿ_vút
[
i
] = 
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

441 
pmd
 = 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

442 
	`mem£t
(
bm_±e
, 0, (bm_pte));

443 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
bm_±e
);

449 i‡(
pmd
 !
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
))) {

450 
	`WARN_ON
(1);

451 
	`¥ötk
(
KERN_WARNING
 "pmd %p != %p\n",

452 
pmd
, 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
)));

453 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

454 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

455 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

456 
	`fix_to_vút
(
FIX_BTMAP_END
));

458 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

459 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

460 
FIX_BTMAP_BEGIN
);

462 
	}
}

464 
__öô
 
	$óæy_i‹em≠_ª£t
()

466 
a·î_∑gög_öô
 = 1;

467 
	}
}

469 
__öô
 
	$__óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

470 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
Êags
)

472 
addr
 = 
	`__fix_to_vút
(
idx
);

473 
±e_t
 *
±e
;

475 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

476 
	`BUG
();

479 
±e
 = 
	`óæy_i‹em≠_±e
(
addr
);

481 i‡(
	`pg¥Ÿ_vÆ
(
Êags
))

482 
	`£t_±e
(
±e
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

484 
	`±e_˛ór
(&
öô_mm
, 
addr
, 
±e
);

485 
	`__Êush_éb_⁄e
(
addr
);

486 
	}
}

488 
ölöe
 
__öô
 
	$óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

489 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
¥Ÿ
)

491 i‡(
a·î_∑gög_öô
)

492 
	`__£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

494 
	`__óæy_£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

495 
	}
}

497 
ölöe
 
__öô
 
	$óæy_˛ór_fixm≠
(
fixed_addªs£s
 
idx
)

499 i‡(
a·î_∑gög_öô
)

500 
	`˛ór_fixm≠
(
idx
);

502 
	`__óæy_£t_fixm≠
(
idx
, 0, 
	`__pg¥Ÿ
(0));

503 
	}
}

505 
__iomem
 *
	g¥ev_m≠
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

506 
	g¥ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

508 
__öô
 
	$check_óæy_i‹em≠_Àak
()

510 
cou¡
 = 0;

511 
i
;

513 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

514 i‡(
¥ev_m≠
[
i
])

515 
cou¡
++;

517 i‡(!
cou¡
)

519 
	`WARN
(1, 
KERN_WARNING


521 
cou¡
);

522 
	`¥ötk
(
KERN_WARNING


526 
	}
}

527 
œã_öôˇŒ
(
check_óæy_i‹em≠_Àak
);

529 
__öô
 
__iomem
 *

530 
	$__óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
, 
pg¥Ÿ_t
 
¥Ÿ
)

532 
off£t
;

533 
ªsour˚_size_t
 
œ°_addr
;

534 
ƒ∑ges
;

535 
fixed_addªs£s
 
idx0
, 
idx
;

536 
i
, 
¶Ÿ
;

538 
	`WARN_ON
(
sy°em_°©e
 !
SYSTEM_BOOTING
);

540 
¶Ÿ
 = -1;

541 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

542 i‡(!
¥ev_m≠
[
i
]) {

543 
¶Ÿ
 = 
i
;

548 i‡(
¶Ÿ
 < 0) {

549 
	`¥ötk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)Çot found slot\n",

550 (
u64
)
phys_addr
, 
size
);

551 
	`WARN_ON
(1);

552  
NULL
;

555 i‡(
óæy_i‹em≠_debug
) {

556 
	`¥ötk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

557 (
u64
)
phys_addr
, 
size
, 
¶Ÿ
);

558 
	`dump_°ack
();

562 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

563 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
) {

564 
	`WARN_ON
(1);

565  
NULL
;

568 
¥ev_size
[
¶Ÿ
] = 
size
;

572 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

573 
phys_addr
 &
PAGE_MASK
;

574 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
 + 1Ë- 
phys_addr
;

579 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

580 i‡(
ƒ∑ges
 > 
NR_FIX_BTMAPS
) {

581 
	`WARN_ON
(1);

582  
NULL
;

588 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

589 
idx
 = 
idx0
;

590 
ƒ∑ges
 > 0) {

591 
	`óæy_£t_fixm≠
(
idx
, 
phys_addr
, 
¥Ÿ
);

592 
phys_addr
 +
PAGE_SIZE
;

593 --
idx
;

594 --
ƒ∑ges
;

596 i‡(
óæy_i‹em≠_debug
)

597 
	`¥ötk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¶Ÿ_vút
[
¶Ÿ
]);

599 
¥ev_m≠
[
¶Ÿ
] = (
__iomem
 *)(
off£t
 + 
¶Ÿ_vút
[slot]);

600  
¥ev_m≠
[
¶Ÿ
];

601 
	}
}

604 
__öô
 
__iomem
 *

605 
	$óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

607  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

608 
	}
}

611 
__öô
 
__iomem
 *

612 
	$óæy_memªm≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

614  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

615 
	}
}

617 
__öô
 
	$óæy_iounm≠
(
__iomem
 *
addr
, 
size
)

619 
vút_addr
;

620 
off£t
;

621 
ƒ∑ges
;

622 
fixed_addªs£s
 
idx
;

623 
i
, 
¶Ÿ
;

625 
¶Ÿ
 = -1;

626 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

627 i‡(
¥ev_m≠
[
i
] =
addr
) {

628 
¶Ÿ
 = 
i
;

633 i‡(
¶Ÿ
 < 0) {

634 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx)Çot found slot\n",

635 
addr
, 
size
);

636 
	`WARN_ON
(1);

640 i‡(
¥ev_size
[
¶Ÿ
] !
size
) {

641 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] sizeÇot consistent %08lx\n",

642 
addr
, 
size
, 
¶Ÿ
, 
¥ev_size
[slot]);

643 
	`WARN_ON
(1);

647 i‡(
óæy_i‹em≠_debug
) {

648 
	`¥ötk
(
KERN_INFO
 "óæy_iounm≠(%p, %08lxË[%d]\n", 
addr
,

649 
size
, 
¶Ÿ
);

650 
	`dump_°ack
();

653 
vút_addr
 = ()
addr
;

654 i‡(
vút_addr
 < 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
)) {

655 
	`WARN_ON
(1);

658 
off£t
 = 
vút_addr
 & ~
PAGE_MASK
;

659 
ƒ∑ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1Ë>> 
PAGE_SHIFT
;

661 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

662 
ƒ∑ges
 > 0) {

663 
	`óæy_˛ór_fixm≠
(
idx
);

664 --
idx
;

665 --
ƒ∑ges
;

667 
¥ev_m≠
[
¶Ÿ
] = 
NULL
;

668 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<löux/pci_ids.h
>

16 
	~<löux/a˝i.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/mmz⁄e.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dúe˘.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/k8.h
>

27 
__öô
 
	$föd_n‹thbridge
()

29 
num
;

31 
num
 = 0;Çum < 32;Çum++) {

32 
u32
 
hódî
;

34 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 0, 0x00);

35 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

36 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

37 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

40 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 1, 0x00);

41 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

42 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

43 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

45  
num
;

49 
	}
}

51 
__öô
 
	$óæy_gë_boŸ_˝u_id
()

60 #ifde‡
CONFIG_X86_MPPARSE


61 
	`óæy_föd_smp_c⁄fig
();

63 #ifde‡
CONFIG_ACPI


67 
	`óæy_a˝i_boŸ_öô
();

69 #ifde‡
CONFIG_X86_MPPARSE


73 i‡(
smp_found_c⁄fig
)

74 
	`óæy_gë_smp_c⁄fig
();

76 
	`óæy_öô_œpic_m≠pög
();

77 
	}
}

79 
__öô
 
	$k8_sˇn_nodes
(
°¨t
, 
íd
)

81 
numnodes
, 
c‹es
, 
bôs
, 
≠icid_ba£
;

82 
¥evba£
;

83 
boŸnode
 
nodes
[8];

84 
i
, 
j
, 
nb
, 
found
 = 0;

85 
u32
 
nodeid
, 
ªg
;

87 i‡(!
	`óæy_pci_Ælowed
())

90 
nb
 = 
	`föd_n‹thbridge
();

91 i‡(
nb
 < 0)

92  
nb
;

94 
	`¥ötk
(
KERN_INFO
 "Sˇ¬ög NUMAÅ›ﬁogy i¿N‹thbridgê%d\n", 
nb
);

96 
ªg
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 0, 0x60);

97 
numnodes
 = ((
ªg
 >> 4) & 0xF) + 1;

98 i‡(
numnodes
 <= 1)

101 
	`¥ötk
(
KERN_INFO
 "Numbî o‡node†%d\n", 
numnodes
);

103 
	`mem£t
(&
nodes
, 0, (nodes));

104 
¥evba£
 = 0;

105 
i
 = 0; i < 8; i++) {

106 
ba£
, 
limô
;

108 
ba£
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x40 + 
i
*8);

109 
limô
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x44 + 
i
*8);

111 
nodeid
 = 
limô
 & 7;

112 i‡((
ba£
 & 3) == 0) {

113 i‡(
i
 < 
numnodes
)

114 
	`¥ötk
("Skùpög dißbÀdÇodê%d\n", 
i
);

117 i‡(
nodeid
 >
numnodes
) {

118 
	`¥ötk
("Ign‹ögÉx˚s†nodê%d (%lx:%lx)\n", 
nodeid
,

119 
ba£
, 
limô
);

123 i‡(!
limô
) {

124 
	`¥ötk
(
KERN_INFO
 "SkippingÇodeÉntry %d (base %lx)\n",

125 
i
, 
ba£
);

128 i‡((
ba£
 >> 8Ë& 3 || (
limô
 >> 8) & 3) {

129 
	`¥ötk
(
KERN_ERR
 "Node %d using interleaving mode %lx/%lx\n",

130 
nodeid
, (
ba£
>>8)&3, (
limô
>>8) & 3);

133 i‡(
	`node_is£t
(
nodeid
, 
node_possibÀ_m≠
)) {

134 
	`¥ötk
(
KERN_INFO
 "Node %dálreadyÖresent. Skipping\n",

135 
nodeid
);

139 
limô
 >>= 16;

140 
limô
 <<= 24;

141 
limô
 |= (1<<24)-1;

142 
limô
++;

144 i‡(
limô
 > 
max_p‚
 << 
PAGE_SHIFT
)

145 
limô
 = 
max_p‚
 << 
PAGE_SHIFT
;

146 i‡(
limô
 <
ba£
)

149 
ba£
 >>= 16;

150 
ba£
 <<= 24;

152 i‡(
ba£
 < 
°¨t
)

153 
ba£
 = 
°¨t
;

154 i‡(
limô
 > 
íd
)

155 
limô
 = 
íd
;

156 i‡(
limô
 =
ba£
) {

157 
	`¥ötk
(
KERN_ERR
 "Em±yÇodê%d\n", 
nodeid
);

160 i‡(
limô
 < 
ba£
) {

161 
	`¥ötk
(
KERN_ERR
 "Node %d bogus settings %lx-%lx.\n",

162 
nodeid
, 
ba£
, 
limô
);

167 i‡(
¥evba£
 > 
ba£
) {

168 
	`¥ötk
(
KERN_ERR
 "Node mapÇot sorted %lx,%lx\n",

169 
¥evba£
, 
ba£
);

173 
	`¥ötk
(
KERN_INFO
 "Node %d MemBase %016lx Limit %016lx\n",

174 
nodeid
, 
ba£
, 
limô
);

176 
found
++;

178 
nodes
[
nodeid
].
°¨t
 = 
ba£
;

179 
nodes
[
nodeid
].
íd
 = 
limô
;

181 
¥evba£
 = 
ba£
;

183 
	`node_£t
(
nodeid
, 
node_possibÀ_m≠
);

186 i‡(!
found
)

189 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 8, 
NULL
);

190 i‡(
memnode_shi·
 < 0) {

191 
	`¥ötk
(
KERN_ERR
 "No NUMAÇode hash function found. Contact maintainer\n");

194 
	`¥ötk
(
KERN_INFO
 "UsögÇodêhash shi· o‡%d\n", 
memnode_shi·
);

197 
bôs
 = 
boŸ_˝u_d©a
.
x86_c‹eid_bôs
;

198 
c‹es
 = (1<<
bôs
);

199 
≠icid_ba£
 = 0;

201 
	`óæy_gë_boŸ_˝u_id
();

202 i‡(
boŸ_˝u_physiˇl_≠icid
 > 0) {

203 
	`¥ötk
(
KERN_INFO
 "BSP APIC ID: %02x\n",

204 
boŸ_˝u_physiˇl_≠icid
);

205 
≠icid_ba£
 = 
boŸ_˝u_physiˇl_≠icid
;

208 
i
 = 0; i < 8; i++) {

209 i‡(
nodes
[
i
].
°¨t
 =nodes[i].
íd
)

212 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
,

213 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
,

214 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

215 
j
 = 
≠icid_ba£
; j < 
c‹es
 +ápicid_base; j++)

216 
≠icid_to_node
[(
i
 << 
bôs
Ë+ 
j
] = i;

217 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

220 
	`numa_öô_¨øy
();

222 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<löux/≥rs⁄Æôy.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/limôs.h
>

31 
	~<löux/sched.h
>

32 
	~<asm/ñf.h
>

34 
	$°ack_maxøndom_size
()

36 
max
 = 0;

37 i‡((
cuºít
->
Êags
 & 
PF_RANDOMIZE
) &&

38 !(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
)) {

39 
max
 = ((-1UË& 
STACK_RND_MASK
Ë<< 
PAGE_SHIFT
;

42  
max
;

43 
	}
}

51 
	#MIN_GAP
 (128*1024*1024UL + 
	`°ack_maxøndom_size
())

	)

52 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

57 
	$mm≠_is_ü32
()

59 #ifde‡
CONFIG_X86_32


62 #ifde‡
CONFIG_IA32_EMULATION


63 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

67 
	}
}

69 
	$mm≠_is_Àgacy
()

71 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_COMPAT_LAYOUT
)

74 i‡(
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
 =
RLIM_INFINITY
)

77  
sys˘l_Àgacy_va_œyout
;

78 
	}
}

80 
	$mm≠_∫d
()

82 
∫d
 = 0;

88 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

89 i‡(
	`mm≠_is_ü32
())

90 
∫d
 = ()
	`gë_øndom_öt
() % (1<<8);

92 
∫d
 = ()(
	`gë_øndom_öt
() % (1<<28));

94  
∫d
 << 
PAGE_SHIFT
;

95 
	}
}

97 
	$mm≠_ba£
()

99 
g≠
 = 
cuºít
->
sig«l
->
æim
[
RLIMIT_STACK
].
æim_cur
;

101 i‡(
g≠
 < 
MIN_GAP
)

102 
g≠
 = 
MIN_GAP
;

103 i‡(
g≠
 > 
MAX_GAP
)

104 
g≠
 = 
MAX_GAP
;

106  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g≠
 - 
	`mm≠_∫d
());

107 
	}
}

113 
	$mm≠_Àgacy_ba£
()

115 i‡(
	`mm≠_is_ü32
())

116  
TASK_UNMAPPED_BASE
;

118  
TASK_UNMAPPED_BASE
 + 
	`mm≠_∫d
();

119 
	}
}

125 
	$¨ch_pick_mm≠_œyout
(
mm_°ru˘
 *
mm
)

127 i‡(
	`mm≠_is_Àgacy
()) {

128 
mm
->
mm≠_ba£
 = 
	`mm≠_Àgacy_ba£
();

129 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó
;

130 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó
;

132 
mm
->
mm≠_ba£
 = 
	`mm≠_ba£
();

133 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó_t›down
;

134 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó_t›down
;

136 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<löux/t›ﬁogy.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/boŸmem.h
>

6 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


7 
	#DBG
(
x
...Ë
	`¥ötk
(
KERN_DEBUG
 x)

	)

9 
	#DBG
(
x
...)

	)

15 
˝umask_v¨_t
 
	gnode_to_˝umask_m≠
[
MAX_NUMNODES
];

16 
EXPORT_SYMBOL
(
node_to_˝umask_m≠
);

25 
__öô
 
	$£tup_node_to_˝umask_m≠
()

27 
node
, 
num
 = 0;

30 i‡(
ƒ_node_ids
 =
MAX_NUMNODES
) {

31 
	`f‹_óch_node_mask
(
node
, 
node_possibÀ_m≠
)

32 
num
 = 
node
;

33 
ƒ_node_ids
 = 
num
 + 1;

37 
node
 = 0;Çodê< 
ƒ_node_ids
;Çode++)

38 
	`Æloc_boŸmem_˝umask_v¨
(&
node_to_˝umask_m≠
[
node
]);

41 
	`¥_debug
("Nodêtÿ˝umask m≠ f‹ %dÇodes\n", 
ƒ_node_ids
);

42 
	}
}

44 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


48 c⁄° 
˝umask
 *
	$˝umask_of_node
(
node
)

50 i‡(
node
 >
ƒ_node_ids
) {

51 
	`¥ötk
(
KERN_WARNING


53 
node
, 
ƒ_node_ids
);

54 
	`dump_°ack
();

55  
˝u_n⁄e_mask
;

57 i‡(
node_to_˝umask_m≠
[
node
] =
NULL
) {

58 
	`¥ötk
(
KERN_WARNING


60 
node
);

61 
	`dump_°ack
();

62  
˝u_⁄löe_mask
;

64  
node_to_˝umask_m≠
[
node
];

65 
	}
}

66 
EXPORT_SYMBOL
(
˝umask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/mmz⁄e.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/a˝i.h
>

21 
	~<asm/k8.h
>

23 
pgli°_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__ªad_mo°ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__˝uöôd©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__öôd©a
;

33 
__öôd©a
 
	gnodem≠_addr
;

34 
__öôd©a
 
	gnodem≠_size
;

36 
DEFINE_PER_CPU
(, 
node_numbî
) = 0;

37 
EXPORT_PER_CPU_SYMBOL
(
node_numbî
);

42 
DEFINE_EARLY_PER_CPU
(, 
x86_˝u_to_node_m≠
, 
NUMA_NO_NODE
);

43 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_node_m≠
);

52 
__öô
 
	$p›uœã_memnodem≠
(c⁄° 
boŸnode
 *
nodes
,

53 
numnodes
, 
shi·
, *
nodeids
)

55 
addr
, 
íd
;

56 
i
, 
ªs
 = -1;

58 
	`mem£t
(
memnodem≠
, 0xff, (
s16
)*
memnodem≠size
);

59 
i
 = 0; i < 
numnodes
; i++) {

60 
addr
 = 
nodes
[
i
].
°¨t
;

61 
íd
 = 
nodes
[
i
].end;

62 i‡(
addr
 >
íd
)

64 i‡((
íd
 >> 
shi·
Ë>
memnodem≠size
)

67 i‡(
memnodem≠
[
addr
 >> 
shi·
] !
NUMA_NO_NODE
)

70 i‡(!
nodeids
)

71 
memnodem≠
[
addr
 >> 
shi·
] = 
i
;

73 
memnodem≠
[
addr
 >> 
shi·
] = 
nodeids
[
i
];

75 
addr
 +(1UL << 
shi·
);

76 } 
addr
 < 
íd
);

77 
ªs
 = 1;

79  
ªs
;

80 
	}
}

82 
__öô
 
	$Æloˇã_ˇchólig√d_memnodem≠
()

84 
addr
;

86 
memnodem≠
 = 
memnode
.
embedded_m≠
;

87 i‡(
memnodem≠size
 <
	`ARRAY_SIZE
(
memnode
.
embedded_m≠
))

90 
addr
 = 0x8000;

91 
nodem≠_size
 = 
	`roundup
((
s16
Ë* 
memnodem≠size
, 
L1_CACHE_BYTES
);

92 
nodem≠_addr
 = 
	`föd_e820_¨ó
(
addr
, 
max_p‚
<<
PAGE_SHIFT
,

93 
nodem≠_size
, 
L1_CACHE_BYTES
);

94 i‡(
nodem≠_addr
 == -1UL) {

95 
	`¥ötk
(
KERN_ERR


97 
nodem≠_addr
 = 
nodem≠_size
 = 0;

100 
memnodem≠
 = 
	`phys_to_vút
(
nodem≠_addr
);

101 
	`ª£rve_óæy
(
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
, "MEMNODEMAP");

103 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

104 
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
);

106 
	}
}

112 
__öô
 
	$exåa˘_lsb_‰om_nodes
(c⁄° 
boŸnode
 *
nodes
,

113 
numnodes
)

115 
i
, 
nodes_u£d
 = 0;

116 
°¨t
, 
íd
;

117 
bôfõld
 = 0, 
memt›
 = 0;

119 
i
 = 0; i < 
numnodes
; i++) {

120 
°¨t
 = 
nodes
[
i
].start;

121 
íd
 = 
nodes
[
i
].end;

122 i‡(
°¨t
 >
íd
)

124 
bôfõld
 |
°¨t
;

125 
nodes_u£d
++;

126 i‡(
íd
 > 
memt›
)

127 
memt›
 = 
íd
;

129 i‡(
nodes_u£d
 <= 1)

130 
i
 = 63;

132 
i
 = 
	`föd_fú°_bô
(&
bôfõld
, ()*8);

133 
memnodem≠size
 = (
memt›
 >> 
i
)+1;

134  
i
;

135 
	}
}

137 
__öô
 
	$compuã_hash_shi·
(
boŸnode
 *
nodes
, 
numnodes
,

138 *
nodeids
)

140 
shi·
;

142 
shi·
 = 
	`exåa˘_lsb_‰om_nodes
(
nodes
, 
numnodes
);

143 i‡(
	`Æloˇã_ˇchólig√d_memnodem≠
())

145 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Using %d forÅhe hash shift.\n",

146 
shi·
);

148 i‡(
	`p›uœã_memnodem≠
(
nodes
, 
numnodes
, 
shi·
, 
nodeids
) != 1) {

149 
	`¥ötk
(
KERN_INFO
 "Your memory isÇotáligned youÇeedÅo "

151 "shi·=%d\n", 
shi·
);

154  
shi·
;

155 
	}
}

157 
__memöô
 
	$__óæy_p‚_to_nid
(
p‚
)

159  
	`phys_to_nid
(
p‚
 << 
PAGE_SHIFT
);

160 
	}
}

162 * 
__öô
 
	$óæy_node_mem
(
nodeid
, 
°¨t
,

163 
íd
, 
size
,

164 
Æign
)

166 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

167 *
±r
;

169 i‡(
mem
 != -1L)

170  
	`__va
(
mem
);

172 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
	`__∑
(
MAX_DMA_ADDRESS
));

173 i‡(
±r
 =
NULL
) {

174 
	`¥ötk
(
KERN_ERR
 "Cannot find %lu bytes inÇode %d\n",

175 
size
, 
nodeid
);

176  
NULL
;

178  
±r
;

179 
	}
}

182 
__öô


183 
	$£tup_node_boŸmem
(
nodeid
, 
°¨t
, 
íd
)

185 
°¨t_p‚
, 
œ°_p‚
, 
boŸm≠_∑ges
, 
boŸm≠_size
;

186 c⁄° 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

187 
boŸm≠_°¨t
, 
noded©a_phys
;

188 *
boŸm≠
;

189 
nid
;

191 i‡(!
íd
)

198 i‡(
íd
 && (íd - 
°¨t
Ë< 
NODE_MIN_SIZE
)

201 
°¨t
 = 
	`roundup
(°¨t, 
ZONE_ALIGN
);

203 
	`¥ötk
(
KERN_INFO
 "BoŸmem sëu∞nodê%d %016lx-%016lx\n", 
nodeid
,

204 
°¨t
, 
íd
);

206 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

207 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

209 
node_d©a
[
nodeid
] = 
	`óæy_node_mem
“odeid, 
°¨t
, 
íd
, 
pgd©_size
,

210 
SMP_CACHE_BYTES
);

211 i‡(
node_d©a
[
nodeid
] =
NULL
)

213 
noded©a_phys
 = 
	`__∑
(
node_d©a
[
nodeid
]);

214 
	`¥ötk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

215 
noded©a_phys
 + 
pgd©_size
 - 1);

217 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

218 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boŸmem_node_d©a
[nodeid];

219 
	`NODE_DATA
(
nodeid
)->
node_°¨t_p‚
 = 
°¨t_p‚
;

220 
	`NODE_DATA
(
nodeid
)->
node_•™√d_∑ges
 = 
œ°_p‚
 - 
°¨t_p‚
;

229 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
œ°_p‚
 - 
°¨t_p‚
);

230 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

231 i‡(
nid
 =
nodeid
)

232 
boŸm≠_°¨t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

234 
boŸm≠_°¨t
 = 
	`roundup
(
°¨t
, 
PAGE_SIZE
);

239 
boŸm≠
 = 
	`óæy_node_mem
(
nodeid
, 
boŸm≠_°¨t
, 
íd
,

240 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

241 i‡(
boŸm≠
 =
NULL
) {

242 i‡(
noded©a_phys
 < 
°¨t
 ||Çoded©a_phy†>
íd
)

243 
	`‰ì_boŸmem
(
noded©a_phys
, 
pgd©_size
);

244 
node_d©a
[
nodeid
] = 
NULL
;

247 
boŸm≠_°¨t
 = 
	`__∑
(
boŸm≠
);

249 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nodeid
),

250 
boŸm≠_°¨t
 >> 
PAGE_SHIFT
,

251 
°¨t_p‚
, 
œ°_p‚
);

253 
	`¥ötk
(
KERN_INFO
 " bootmap [%016lx - %016lx]Öages %lx\n",

254 
boŸm≠_°¨t
, boŸm≠_°¨à+ 
boŸm≠_size
 - 1,

255 
boŸm≠_∑ges
);

257 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(
nodeid
, 
íd
);

264 
	`óæy_ªs_to_boŸmem
(
°¨t
, 
íd
);

270 i‡(
nid
 !
nodeid
)

271 
	`¥ötk
(
KERN_INFO
 " NODE_DATA(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

273 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
noded©a_phys
,

274 
pgd©_size
, 
BOOTMEM_DEFAULT
);

275 
nid
 = 
	`phys_to_nid
(
boŸm≠_°¨t
);

276 i‡(
nid
 !
nodeid
)

277 
	`¥ötk
(
KERN_INFO
 " boŸm≠(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

279 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nodeid
), 
boŸm≠_°¨t
,

280 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
BOOTMEM_DEFAULT
);

282 
	`node_£t_⁄löe
(
nodeid
);

283 
	}
}

292 
__öô
 
	$numa_öô_¨øy
()

294 
º
, 
i
;

296 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

297 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

298 i‡(
	`óæy_˝u_to_node
(
i
Ë!
NUMA_NO_NODE
)

300 
	`numa_£t_node
(
i
, 
º
);

301 
º
 = 
	`√xt_node
‘r, 
node_⁄löe_m≠
);

302 i‡(
º
 =
MAX_NUMNODES
)

303 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

305 
	}
}

307 #ifde‡
CONFIG_NUMA_EMU


309 *
cmdlöe
 
	g__öôd©a
;

318 
__öô
 
	$£tup_node_ønge
(
nid
, 
boŸnode
 *
nodes
, 
u64
 *
addr
,

319 
u64
 
size
, u64 
max_addr
)

321 
ªt
 = 0;

323 
nodes
[
nid
].
°¨t
 = *
addr
;

324 *
addr
 +
size
;

325 i‡(*
addr
 >
max_addr
) {

326 *
addr
 = 
max_addr
;

327 
ªt
 = -1;

329 
nodes
[
nid
].
íd
 = *
addr
;

330 
	`node_£t
(
nid
, 
node_possibÀ_m≠
);

331 
	`¥ötk
(
KERN_INFO
 "FakögÇodê%dáà%016Lx-%016Lx (%LuMB)\n", 
nid
,

332 
nodes
[
nid
].
°¨t
,Çodes[nid].
íd
,

333 (
nodes
[
nid
].
íd
 -Çodes[nid].
°¨t
) >> 20);

334  
ªt
;

335 
	}
}

342 
__öô
 
	$•lô_nodes_equÆly
(
boŸnode
 *
nodes
, 
u64
 *
addr
,

343 
u64
 
max_addr
, 
node_°¨t
,

344 
num_nodes
)

346 
big
;

347 
u64
 
size
;

348 
i
;

350 i‡(
num_nodes
 <= 0)

352 i‡(
num_nodes
 > 
MAX_NUMNODES
)

353 
num_nodes
 = 
MAX_NUMNODES
;

354 
size
 = (
max_addr
 - *
addr
 - 
	`e820_hﬁe_size
(*addr, max_addr)) /

355 
num_nodes
;

360 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë* 
num_nodes
) /

361 
FAKE_NODE_MIN_SIZE
;

364 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

365 i‡(!
size
) {

366 
	`¥ötk
(
KERN_ERR
 "NotÉnough memory forÉachÇode. "

371 
i
 = 
node_°¨t
; i < 
num_nodes
 +Çode_start; i++) {

372 
u64
 
íd
 = *
addr
 + 
size
;

374 i‡(
i
 < 
big
)

375 
íd
 +
FAKE_NODE_MIN_SIZE
;

380 i‡(
i
 =
num_nodes
 + 
node_°¨t
 - 1)

381 
íd
 = 
max_addr
;

383 
íd
 - *
addr
 - 
	`e820_hﬁe_size
(*addr,Énd) <

384 
size
) {

385 
íd
 +
FAKE_NODE_MIN_SIZE
;

386 i‡(
íd
 > 
max_addr
) {

387 
íd
 = 
max_addr
;

391 i‡(
	`£tup_node_ønge
(
i
, 
nodes
, 
addr
, 
íd
 - *addr, 
max_addr
) < 0)

394  
i
 - 
node_°¨t
 + 1;

395 
	}
}

402 
__öô
 
	$•lô_nodes_by_size
(
boŸnode
 *
nodes
, 
u64
 *
addr
,

403 
u64
 
max_addr
, 
node_°¨t
, u64 
size
)

405 
i
 = 
node_°¨t
;

406 
size
 = (sizê<< 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

407 !
	`£tup_node_ønge
(
i
++, 
nodes
, 
addr
, 
size
, 
max_addr
))

409  
i
 - 
node_°¨t
;

410 
	}
}

416 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

418 
__öô
 
	$numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
)

420 
u64
 
size
, 
addr
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

421 
u64
 
max_addr
 = 
œ°_p‚
 << 
PAGE_SHIFT
;

422 
num_nodes
 = 0, 
num
 = 0, 
c€ff_Êag
, 
c€ff
 = -1, 
i
;

424 
	`mem£t
(&
nodes
, 0, (nodes));

429 i‡(!
	`°rchr
(
cmdlöe
, '*') && !strchr(cmdline, ',')) {

430 
n
 = 
	`sim∂e_°πﬁ
(
cmdlöe
, 
NULL
, 0);

432 
num_nodes
 = 
	`•lô_nodes_equÆly
(
nodes
, &
addr
, 
max_addr
, 0, 
n
);

433 i‡(
num_nodes
 < 0)

434  
num_nodes
;

435 
out
;

439 
c€ff_Êag
 = 0; ; 
cmdlöe
++) {

440 i‡(*
cmdlöe
 && 
	`isdigô
(*cmdline)) {

441 
num
 =Çum * 10 + *
cmdlöe
 - '0';

444 i‡(*
cmdlöe
 == '*') {

445 i‡(
num
 > 0)

446 
c€ff
 = 
num
;

447 
c€ff_Êag
 = 1;

449 i‡(!*
cmdlöe
 || *cmdline == ',') {

450 i‡(!
c€ff_Êag
)

451 
c€ff
 = 1;

456 
size
 = ((
u64
)
num
 << 20Ë& 
FAKE_NODE_MIN_HASH_MASK
;

457 i‡(
size
)

458 
i
 = 0; i < 
c€ff
; i++, 
num_nodes
++)

459 i‡(
	`£tup_node_ønge
(
num_nodes
, 
nodes
,

460 &
addr
, 
size
, 
max_addr
) < 0)

461 
d⁄e
;

462 i‡(!*
cmdlöe
)

464 
c€ff_Êag
 = 0;

465 
c€ff
 = -1;

467 
num
 = 0;

469 
d⁄e
:

470 i‡(!
num_nodes
)

473 i‡(
addr
 < 
max_addr
) {

474 i‡(
c€ff_Êag
 && 
c€ff
 < 0) {

476 
num_nodes
 +
	`•lô_nodes_by_size
(
nodes
, &
addr
, 
max_addr
,

477 
num_nodes
, 
num
);

478 
out
;

480 *(
cmdlöe
 - 1)) {

483 i‡(
c€ff
 <= 0)

485 
num_nodes
 +
	`•lô_nodes_equÆly
(
nodes
, &
addr
, 
max_addr
,

486 
num_nodes
, 
c€ff
);

493 
	`£tup_node_ønge
(
num_nodes
, 
nodes
, &
addr
,

494 
max_addr
 - 
addr
, max_addr);

495 
num_nodes
++;

498 
out
:

499 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 
num_nodes
, 
NULL
);

500 i‡(
memnode_shi·
 < 0) {

501 
memnode_shi·
 = 0;

502 
	`¥ötk
(
KERN_ERR
 "No NUMA hash function found. NUMAÉmulation "

512 
	`ªmove_Æl_a˘ive_ønges
();

513 #ifde‡
CONFIG_ACPI_NUMA


514 
a˝i_numa
 = -1;

516 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

517 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

518 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

519 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

521 
	`a˝i_Áke_nodes
(
nodes
, 
num_nodes
);

522 
	`numa_öô_¨øy
();

524 
	}
}

527 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
œ°_p‚
)

529 
i
;

531 
	`nodes_˛ór
(
node_possibÀ_m≠
);

532 
	`nodes_˛ór
(
node_⁄löe_m≠
);

534 #ifde‡
CONFIG_NUMA_EMU


535 i‡(
cmdlöe
 && !
	`numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
))

537 
	`nodes_˛ór
(
node_possibÀ_m≠
);

538 
	`nodes_˛ór
(
node_⁄löe_m≠
);

541 #ifde‡
CONFIG_ACPI_NUMA


542 i‡(!
numa_off
 && !
	`a˝i_sˇn_nodes
(
°¨t_p‚
 << 
PAGE_SHIFT
,

543 
œ°_p‚
 << 
PAGE_SHIFT
))

545 
	`nodes_˛ór
(
node_possibÀ_m≠
);

546 
	`nodes_˛ór
(
node_⁄löe_m≠
);

549 #ifde‡
CONFIG_K8_NUMA


550 i‡(!
numa_off
 && !
	`k8_sˇn_nodes
(
°¨t_p‚
<<
PAGE_SHIFT
,

551 
œ°_p‚
<<
PAGE_SHIFT
))

553 
	`nodes_˛ór
(
node_possibÀ_m≠
);

554 
	`nodes_˛ór
(
node_⁄löe_m≠
);

556 
	`¥ötk
(
KERN_INFO
 "%s\n",

557 
numa_off
 ? "NUMAÅurned off" : "No NUMA configuration found");

559 
	`¥ötk
(
KERN_INFO
 "FakingáÇodeát %016lx-%016lx\n",

560 
°¨t_p‚
 << 
PAGE_SHIFT
,

561 
œ°_p‚
 << 
PAGE_SHIFT
);

563 
memnode_shi·
 = 63;

564 
memnodem≠
 = 
memnode
.
embedded_m≠
;

565 
memnodem≠
[0] = 0;

566 
	`node_£t_⁄löe
(0);

567 
	`node_£t
(0, 
node_possibÀ_m≠
);

568 
i
 = 0; i < 
ƒ_˝u_ids
; i++)

569 
	`numa_£t_node
(
i
, 0);

570 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
œ°_p‚
);

571 
	`£tup_node_boŸmem
(0, 
°¨t_p‚
 << 
PAGE_SHIFT
, 
œ°_p‚
 << PAGE_SHIFT);

572 
	}
}

574 
__öô
 
	$numa_‰ì_Æl_boŸmem
()

576 
∑ges
 = 0;

577 
i
;

579 
	`f‹_óch_⁄löe_node
(
i
)

580 
∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
i
));

582  
∑ges
;

583 
	}
}

585 
__öô
 
	$numa_£tup
(*
›t
)

587 i‡(!
›t
)

588  -
EINVAL
;

589 i‡(!
	`°∫cmp
(
›t
, "off", 3))

590 
numa_off
 = 1;

591 #ifde‡
CONFIG_NUMA_EMU


592 i‡(!
	`°∫cmp
(
›t
, "fake=", 5))

593 
cmdlöe
 = 
›t
 + 5;

595 #ifde‡
CONFIG_ACPI_NUMA


596 i‡(!
	`°∫cmp
(
›t
, "noacpi", 6))

597 
a˝i_numa
 = -1;

600 
	}
}

601 
óæy_∑øm
("numa", 
numa_£tup
);

603 #ifde‡
CONFIG_NUMA


618 
__öô
 
	$öô_˝u_to_node
()

620 
˝u
;

621 
u16
 *
˝u_to_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
);

623 
	`BUG_ON
(
˝u_to_≠icid
 =
NULL
);

625 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

626 
node
;

627 
u16
 
≠icid
 = 
˝u_to_≠icid
[
˝u
];

629 i‡(
≠icid
 =
BAD_APICID
)

631 
node
 = 
≠icid_to_node
[
≠icid
];

632 i‡(
node
 =
NUMA_NO_NODE
)

634 i‡(!
	`node_⁄löe
(
node
))

636 
	`numa_£t_node
(
˝u
, 
node
);

638 
	}
}

642 
__˝uöô
 
	$numa_£t_node
(
˝u
, 
node
)

644 *
˝u_to_node_m≠
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
);

647 i‡(
˝u_to_node_m≠
) {

648 
˝u_to_node_m≠
[
˝u
] = 
node
;

652 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


653 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_possibÀ
(cpu)) {

654 
	`¥ötk
(
KERN_ERR
 "numa_£t_node: invÆid cpu# (%d)\n", 
˝u
);

655 
	`dump_°ack
();

659 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
Ë
node
;

661 i‡(
node
 !
NUMA_NO_NODE
)

662 
	`≥r_˝u
(
node_numbî
, 
˝u
Ë
node
;

663 
	}
}

665 
__˝uöô
 
	$numa_˛ór_node
(
˝u
)

667 
	`numa_£t_node
(
˝u
, 
NUMA_NO_NODE
);

668 
	}
}

670 #i‚de‡
CONFIG_DEBUG_PER_CPU_MAPS


672 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

674 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

675 
	}
}

677 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

679 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

680 
	}
}

687 
__˝uöô
 
	$numa_£t_˝umask
(
˝u
, 
íabÀ
)

689 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

690 
˝umask
 *
mask
;

691 
buf
[64];

693 
mask
 = 
node_to_˝umask_m≠
[
node
];

694 i‡(
mask
 =
NULL
) {

695 
	`¥ötk
(
KERN_ERR
 "node_to_˝umask_m≠[%i] NULL\n", 
node
);

696 
	`dump_°ack
();

700 i‡(
íabÀ
)

701 
	`˝umask_£t_˝u
(
˝u
, 
mask
);

703 
	`˝umask_˛ór_˝u
(
˝u
, 
mask
);

705 
	`˝uli°_s˙¥ötf
(
buf
, (buf), 
mask
);

706 
	`¥ötk
(
KERN_DEBUG
 "%s cpu %dÇode %d: maskÇow %s\n",

707 
íabÀ
 ? "numa_add_˝u" : "numa_ªmove_˝u", 
˝u
, 
node
, 
buf
);

708 
	}
}

710 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

712 
	`numa_£t_˝umask
(
˝u
, 1);

713 
	}
}

715 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

717 
	`numa_£t_˝umask
(
˝u
, 0);

718 
	}
}

720 
	$˝u_to_node
(
˝u
)

722 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)) {

723 
	`¥ötk
(
KERN_WARNING


724 "˝u_to_node(%d): ußgêtoÿóæy!\n", 
˝u
);

725 
	`dump_°ack
();

726  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

728  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

729 
	}
}

730 
EXPORT_SYMBOL
(
˝u_to_node
);

736 
	$óæy_˝u_to_node
(
˝u
)

738 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
))

739  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

741 i‡(!
	`˝u_possibÀ
(
˝u
)) {

742 
	`¥ötk
(
KERN_WARNING


743 "óæy_˝u_to_node(%d):Çÿ≥r_˝uáªa!\n", 
˝u
);

744 
	`dump_°ack
();

745  
NUMA_NO_NODE
;

747  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

748 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<löux/highmem.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/öãºu±.h
>

12 
	~<löux/£q_fûe.h
>

13 
	~<löux/debugfs.h
>

14 
	~<löux/p‚.h
>

15 
	~<löux/≥r˝u.h
>

17 
	~<asm/e820.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<asm/£tup.h
>

22 
	~<asm/uac˚ss.h
>

23 
	~<asm/pgÆloc.h
>

24 
	~<asm/¥Ÿo.h
>

25 
	~<asm/∑t.h
>

30 
	s˝a_d©a
 {

31 *
	mvaddr
;

32 
pg¥Ÿ_t
 
	mmask_£t
;

33 
pg¥Ÿ_t
 
	mmask_˛r
;

34 
	mnum∑ges
;

35 
	mÊags
;

36 
	mp‚
;

37 
	mf‹˚_•lô
 : 1;

38 
	mcuΩage
;

39 
∑ge
 **
	m∑ges
;

48 
DEFINE_SPINLOCK
(
˝a_lock
);

50 
	#CPA_FLUSHTLB
 1

	)

51 
	#CPA_ARRAY
 2

	)

52 
	#CPA_PAGES_ARRAY
 4

	)

54 #ifde‡
CONFIG_PROC_FS


55 
	gdúe˘_∑ges_cou¡
[
PG_LEVEL_NUM
];

57 
	$upd©e_∑ge_cou¡
(
Àvñ
, 
∑ges
)

59 
Êags
;

62 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

63 
dúe˘_∑ges_cou¡
[
Àvñ
] +
∑ges
;

64 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

65 
	}
}

67 
	$•lô_∑ge_cou¡
(
Àvñ
)

69 
dúe˘_∑ges_cou¡
[
Àvñ
]--;

70 
dúe˘_∑ges_cou¡
[
Àvñ
 - 1] +
PTRS_PER_PTE
;

71 
	}
}

73 
	$¨ch_ªp‹t_memöfo
(
£q_fûe
 *
m
)

75 
	`£q_¥ötf
(
m
, "DirectMap4k: %8lu kB\n",

76 
dúe˘_∑ges_cou¡
[
PG_LEVEL_4K
] << 2);

77 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

78 
	`£q_¥ötf
(
m
, "DirectMap2M: %8lu kB\n",

79 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 11);

81 
	`£q_¥ötf
(
m
, "DirectMap4M: %8lu kB\n",

82 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 12);

84 #ifde‡
CONFIG_X86_64


85 i‡(
dúe˘_gb∑ges
)

86 
	`£q_¥ötf
(
m
, "DirectMap1G: %8lu kB\n",

87 
dúe˘_∑ges_cou¡
[
PG_LEVEL_1G
] << 20);

89 
	}
}

91 
ölöe
 
	$•lô_∑ge_cou¡
(
Àvñ
Ë{ 
	}
}

94 #ifde‡
CONFIG_X86_64


96 
ölöe
 
	$highm≠_°¨t_p‚
()

98  
	`__∑
(
_ãxt
Ë>> 
PAGE_SHIFT
;

99 
	}
}

101 
ölöe
 
	$highm≠_íd_p‚
()

103  
	`__∑
(
	`roundup
(
_brk_íd
, 
PMD_SIZE
)Ë>> 
PAGE_SHIFT
;

104 
	}
}

108 #ifde‡
CONFIG_DEBUG_PAGEALLOC


109 
	#debug_∑góŒoc
 1

	)

111 
	#debug_∑góŒoc
 0

	)

114 
ölöe
 

115 
	$wôhö
(
addr
, 
°¨t
, 
íd
)

117  
addr
 >
°¨t
 &&ádd∏< 
íd
;

118 
	}
}

132 
	$˛Êush_ˇche_ønge
(*
vaddr
, 
size
)

134 *
víd
 = 
vaddr
 + 
size
 - 1;

136 
	`mb
();

138 ; 
vaddr
 < 
víd
; vadd∏+
boŸ_˝u_d©a
.
x86_˛Êush_size
)

139 
	`˛Êush
(
vaddr
);

143 
	`˛Êush
(
víd
);

145 
	`mb
();

146 
	}
}

147 
EXPORT_SYMBOL_GPL
(
˛Êush_ˇche_ønge
);

149 
	$__˝a_Êush_Æl
(*
¨g
)

151 
ˇche
 = ()
¨g
;

157 
	`__Êush_éb_Æl
();

159 i‡(
ˇche
 && 
boŸ_˝u_d©a
.
x86
 >= 4)

160 
	`wbövd
();

161 
	}
}

163 
	$˝a_Êush_Æl
(
ˇche
)

165 
	`BUG_ON
(
	`úqs_dißbÀd
());

167 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
ˇche
, 1);

168 
	}
}

170 
	$__˝a_Êush_ønge
(*
¨g
)

177 
	`__Êush_éb_Æl
();

178 
	}
}

180 
	$˝a_Êush_ønge
(
°¨t
, 
num∑ges
, 
ˇche
)

182 
i
, 
Àvñ
;

183 
addr
;

185 
	`BUG_ON
(
	`úqs_dißbÀd
());

186 
	`WARN_ON
(
	`PAGE_ALIGN
(
°¨t
) != start);

188 
	`⁄_óch_˝u
(
__˝a_Êush_ønge
, 
NULL
, 1);

190 i‡(!
ˇche
)

199 
i
 = 0, 
addr
 = 
°¨t
; i < 
num∑ges
; i++,ádd∏+
PAGE_SIZE
) {

200 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

205 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

206 
	`˛Êush_ˇche_ønge
((*Ë
addr
, 
PAGE_SIZE
);

208 
	}
}

210 
	$˝a_Êush_¨øy
(*
°¨t
, 
num∑ges
, 
ˇche
,

211 
ö_Êags
, 
∑ge
 **
∑ges
)

213 
i
, 
Àvñ
;

214 
do_wbövd
 = 
ˇche
 && 
num∑ges
 >= 1024;

216 
	`BUG_ON
(
	`úqs_dißbÀd
());

218 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
do_wbövd
, 1);

220 i‡(!
ˇche
 || 
do_wbövd
)

229 
i
 = 0; i < 
num∑ges
; i++) {

230 
addr
;

231 
±e_t
 *
±e
;

233 i‡(
ö_Êags
 & 
CPA_PAGES_ARRAY
)

234 
addr
 = ()
	`∑ge_addªss
(
∑ges
[
i
]);

236 
addr
 = 
°¨t
[
i
];

238 
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

243 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

244 
	`˛Êush_ˇche_ønge
((*)
addr
, 
PAGE_SIZE
);

246 
	}
}

254 
ölöe
 
pg¥Ÿ_t
 
	$°©ic_¥Ÿe˘i⁄s
(
pg¥Ÿ_t
 
¥Ÿ
, 
addªss
,

255 
p‚
)

257 
pg¥Ÿ_t
 
f‹biddí
 = 
	`__pg¥Ÿ
(0);

263 i‡(
	`wôhö
(
p‚
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

264 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

271 i‡(
	`wôhö
(
addªss
, ()
_ãxt
, ()
_ëext
))

272 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

278 i‡(
	`wôhö
(
p‚
, 
	`__∑
(()
__°¨t_rod©a
Ë>> 
PAGE_SHIFT
,

279 
	`__∑
(()
__íd_rod©a
Ë>> 
PAGE_SHIFT
))

280 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

282 
¥Ÿ
 = 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
’rŸË& ~pg¥Ÿ_vÆ(
f‹biddí
));

284  
¥Ÿ
;

285 
	}
}

295 
±e_t
 *
	$lookup_addªss
(
addªss
, *
Àvñ
)

297 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
addªss
);

298 
pud_t
 *
pud
;

299 
pmd_t
 *
pmd
;

301 *
Àvñ
 = 
PG_LEVEL_NONE
;

303 i‡(
	`pgd_n⁄e
(*
pgd
))

304  
NULL
;

306 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

307 i‡(
	`pud_n⁄e
(*
pud
))

308  
NULL
;

310 *
Àvñ
 = 
PG_LEVEL_1G
;

311 i‡(
	`pud_œrge
(*
pud
Ë|| !
	`pud_¥e£¡
(*pud))

312  (
±e_t
 *)
pud
;

314 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

315 i‡(
	`pmd_n⁄e
(*
pmd
))

316  
NULL
;

318 *
Àvñ
 = 
PG_LEVEL_2M
;

319 i‡(
	`pmd_œrge
(*
pmd
Ë|| !
	`pmd_¥e£¡
(*pmd))

320  (
±e_t
 *)
pmd
;

322 *
Àvñ
 = 
PG_LEVEL_4K
;

324  
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

325 
	}
}

326 
EXPORT_SYMBOL_GPL
(
lookup_addªss
);

331 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
addªss
,Öã_à
±e
)

334 
	`£t_±e_©omic
(
k±e
, 
±e
);

335 #ifde‡
CONFIG_X86_32


336 i‡(!
SHARED_KERNEL_PMD
) {

337 
∑ge
 *page;

339 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

340 
pgd_t
 *
pgd
;

341 
pud_t
 *
pud
;

342 
pmd_t
 *
pmd
;

344 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

345 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

346 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

347 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

351 
	}
}

354 
	$åy_¥e£rve_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
,

355 
˝a_d©a
 *
˝a
)

357 
√xçage_addr
, 
num∑ges
, 
pmask
, 
psize
, 
Êags
, 
addr
, 
p‚
;

358 
±e_t
 
√w_±e
, 
ﬁd_±e
, *
tmp
;

359 
pg¥Ÿ_t
 
ﬁd_¥Ÿ
, 
√w_¥Ÿ
;

360 
i
, 
do_•lô
 = 1;

361 
Àvñ
;

363 i‡(
˝a
->
f‹˚_•lô
)

366 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

371 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

372 i‡(
tmp
 !
k±e
)

373 
out_u∆ock
;

375 
Àvñ
) {

376 
PG_LEVEL_2M
:

377 
psize
 = 
PMD_PAGE_SIZE
;

378 
pmask
 = 
PMD_PAGE_MASK
;

380 #ifde‡
CONFIG_X86_64


381 
PG_LEVEL_1G
:

382 
psize
 = 
PUD_PAGE_SIZE
;

383 
pmask
 = 
PUD_PAGE_MASK
;

387 
do_•lô
 = -
EINVAL
;

388 
out_u∆ock
;

395 
√xçage_addr
 = (
addªss
 + 
psize
Ë& 
pmask
;

396 
num∑ges
 = (
√xçage_addr
 - 
addªss
Ë>> 
PAGE_SHIFT
;

397 i‡(
num∑ges
 < 
˝a
->numpages)

398 
˝a
->
num∑ges
 =Çumpages;

403 
ﬁd_±e
 = *
k±e
;

404 
ﬁd_¥Ÿ
 = 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

406 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

407 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

413 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
Ë+ ((
addªss
 & (
psize
 - 1)Ë>> 
PAGE_SHIFT
);

414 
˝a
->
p‚
 =Öfn;

416 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

423 
addr
 = 
addªss
 + 
PAGE_SIZE
;

424 
p‚
++;

425 
i
 = 1; i < 
˝a
->
num∑ges
; i++, 
addr
 +
PAGE_SIZE
, 
p‚
++) {

426 
pg¥Ÿ_t
 
chk_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
(
√w_¥Ÿ
, 
addr
, 
p‚
);

428 i‡(
	`pg¥Ÿ_vÆ
(
chk_¥Ÿ
Ë!pg¥Ÿ_vÆ(
√w_¥Ÿ
))

429 
out_u∆ock
;

436 i‡(
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë=pg¥Ÿ_vÆ(
ﬁd_¥Ÿ
)) {

437 
do_•lô
 = 0;

438 
out_u∆ock
;

449 i‡(
addªss
 =(
√xçage_addr
 - 
psize
Ë&& 
˝a
->
num∑ges
 ==Çumpages) {

454 
√w_±e
 = 
	`p‚_±e
(
	`±e_p‚
(
ﬁd_±e
), 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

455 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
√w_±e
);

456 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

457 
do_•lô
 = 0;

460 
out_u∆ock
:

461 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

463  
do_•lô
;

464 
	}
}

466 
	$•lô_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
)

468 
Êags
, 
p‚
, 
p‚öc
 = 1;

469 
i
, 
Àvñ
;

470 
±e_t
 *
pba£
, *
tmp
;

471 
pg¥Ÿ_t
 
ªf_¥Ÿ
;

472 
∑ge
 *
ba£
;

474 i‡(!
debug_∑góŒoc
)

475 
	`•ö_u∆ock
(&
˝a_lock
);

476 
ba£
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_NOTRACK
, 0);

477 i‡(!
debug_∑góŒoc
)

478 
	`•ö_lock
(&
˝a_lock
);

479 i‡(!
ba£
)

480  -
ENOMEM
;

482 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

487 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

488 i‡(
tmp
 !
k±e
)

489 
out_u∆ock
;

491 
pba£
 = (
±e_t
 *)
	`∑ge_addªss
(
ba£
);

492 
	`∑øvút_Æloc_±e
(&
öô_mm
, 
	`∑ge_to_p‚
(
ba£
));

493 
ªf_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*
k±e
));

500 
	`WARN_ON_ONCE
(
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë& 
_PAGE_PAT_LARGE
);

502 #ifde‡
CONFIG_X86_64


503 i‡(
Àvñ
 =
PG_LEVEL_1G
) {

504 
p‚öc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

505 
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë|
_PAGE_PSE
;

512 
p‚
 = 
	`±e_p‚
(*
k±e
);

513 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
p‚
 +
p‚öc
)

514 
	`£t_±e
(&
pba£
[
i
], 
	`p‚_±e
(
p‚
, 
ªf_¥Ÿ
));

516 i‡(
addªss
 >()
	`__va
(0) &&

517 
addªss
 < ()
	`__va
(
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
))

518 
	`•lô_∑ge_cou¡
(
Àvñ
);

520 #ifde‡
CONFIG_X86_64


521 i‡(
addªss
 >()
	`__va
(1UL<<32) &&

522 
addªss
 < ()
	`__va
(
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))

523 
	`•lô_∑ge_cou¡
(
Àvñ
);

533 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
	`mk_±e
(
ba£
, 
	`__pg¥Ÿ
(
_KERNPG_TABLE
)));

543 
	`__Êush_éb_Æl
();

545 
ba£
 = 
NULL
;

547 
out_u∆ock
:

552 i‡(
ba£
)

553 
	`__‰ì_∑ge
(
ba£
);

554 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

557 
	}
}

559 
	$__˝a_¥o˚ss_Áu…
(
˝a_d©a
 *
˝a
, 
vaddr
,

560 
¥im¨y
)

565 i‡(!
¥im¨y
)

575 i‡(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

576 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))) {

577 
˝a
->
num∑ges
 = 1;

578 
˝a
->
p‚
 = 
	`__∑
(
vaddr
Ë>> 
PAGE_SHIFT
;

581 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zeroÖte. "

582 "vadd∏%lx c∑->vadd∏%lx\n", 
vaddr
,

583 *
˝a
->
vaddr
);

585  -
EFAULT
;

587 
	}
}

589 
	$__ch™ge_∑ge_©å
(
˝a_d©a
 *
˝a
, 
¥im¨y
)

591 
addªss
;

592 
do_•lô
, 
îr
;

593 
Àvñ
;

594 
±e_t
 *
k±e
, 
ﬁd_±e
;

596 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

597 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

598 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

600 
addªss
 = ()
	`∑ge_addªss
(
∑ge
);

601 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

602 
addªss
 = 
˝a
->
vaddr
[˝a->
cuΩage
];

604 
addªss
 = *
˝a
->
vaddr
;

605 
ª≥©
:

606 
k±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

607 i‡(!
k±e
)

608  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

610 
ﬁd_±e
 = *
k±e
;

611 i‡(!
	`±e_vÆ
(
ﬁd_±e
))

612  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

614 i‡(
Àvñ
 =
PG_LEVEL_4K
) {

615 
±e_t
 
√w_±e
;

616 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

617 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
);

619 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

620 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

622 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

629 
√w_±e
 = 
	`p‚_±e
(
p‚
, 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

630 
˝a
->
p‚
 =Öfn;

634 i‡(
	`±e_vÆ
(
ﬁd_±e
Ë!±e_vÆ(
√w_±e
)) {

635 
	`£t_±e_©omic
(
k±e
, 
√w_±e
);

636 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

638 
˝a
->
num∑ges
 = 1;

646 
do_•lô
 = 
	`åy_¥e£rve_œrge_∑ge
(
k±e
, 
addªss
, 
˝a
);

652 i‡(
do_•lô
 <= 0)

653  
do_•lô
;

658 
îr
 = 
	`•lô_œrge_∑ge
(
k±e
, 
addªss
);

659 i‡(!
îr
) {

678 
	`Êush_éb_Æl
();

679 
ª≥©
;

682  
îr
;

683 
	}
}

685 
__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
);

687 
	$˝a_¥o˚ss_Æüs
(
˝a_d©a
 *
˝a
)

689 
˝a_d©a
 
Æüs_˝a
;

690 
œddr
 = ()
	`__va
(
˝a
->
p‚
 << 
PAGE_SHIFT
);

691 
vaddr
;

692 
ªt
;

694 i‡(
˝a
->
p‚
 >
max_p‚_m≠≥d
)

697 #ifde‡
CONFIG_X86_64


698 i‡(
˝a
->
p‚
 >
max_low_p‚_m≠≥d
 && c∑->p‚ < (1UL<<(32-
PAGE_SHIFT
)))

705 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

706 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

707 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

709 
vaddr
 = ()
	`∑ge_addªss
(
∑ge
);

710 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

711 
vaddr
 = 
˝a
->vaddr[˝a->
cuΩage
];

713 
vaddr
 = *
˝a
->vaddr;

715 i‡(!(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

716 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
)))) {

718 
Æüs_˝a
 = *
˝a
;

719 
Æüs_˝a
.
vaddr
 = &
œddr
;

720 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

722 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

723 i‡(
ªt
)

724  
ªt
;

727 #ifde‡
CONFIG_X86_64


733 i‡(!
	`wôhö
(
vaddr
, ()
_ãxt
, 
_brk_íd
) &&

734 
	`wôhö
(
˝a
->
p‚
, 
	`highm≠_°¨t_p‚
(), 
	`highm≠_íd_p‚
())) {

735 
ãmp_˝a_vaddr
 = (
˝a
->
p‚
 << 
PAGE_SHIFT
) +

736 
__START_KERNEL_m≠
 - 
phys_ba£
;

737 
Æüs_˝a
 = *
˝a
;

738 
Æüs_˝a
.
vaddr
 = &
ãmp_˝a_vaddr
;

739 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

745 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

750 
	}
}

752 
	$__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
)

754 
ªt
, 
num∑ges
 = 
˝a
->numpages;

756 
num∑ges
) {

761 
˝a
->
num∑ges
 =Çumpages;

763 i‡(
˝a
->
Êags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

764 
˝a
->
num∑ges
 = 1;

766 i‡(!
debug_∑góŒoc
)

767 
	`•ö_lock
(&
˝a_lock
);

768 
ªt
 = 
	`__ch™ge_∑ge_©å
(
˝a
, 
checkÆüs
);

769 i‡(!
debug_∑góŒoc
)

770 
	`•ö_u∆ock
(&
˝a_lock
);

771 i‡(
ªt
)

772  
ªt
;

774 i‡(
checkÆüs
) {

775 
ªt
 = 
	`˝a_¥o˚ss_Æüs
(
˝a
);

776 i‡(
ªt
)

777  
ªt
;

785 
	`BUG_ON
(
˝a
->
num∑ges
 >Çumpages);

786 
num∑ges
 -
˝a
->numpages;

787 i‡(
˝a
->
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

788 
˝a
->
cuΩage
++;

790 *
˝a
->
vaddr
 +˝a->
num∑ges
 * 
PAGE_SIZE
;

794 
	}
}

796 
ölöe
 
	$ˇche_©å
(
pg¥Ÿ_t
 
©å
)

798  
	`pg¥Ÿ_vÆ
(
©å
) &

799 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

800 
	}
}

802 
	$ch™ge_∑ge_©å_£t_˛r
(*
addr
, 
num∑ges
,

803 
pg¥Ÿ_t
 
mask_£t
,Ög¥Ÿ_à
mask_˛r
,

804 
f‹˚_•lô
, 
ö_Êag
,

805 
∑ge
 **
∑ges
)

807 
˝a_d©a
 
˝a
;

808 
ªt
, 
ˇche
, 
checkÆüs
;

809 
baddr
 = 0;

815 
mask_£t
 = 
	`ˇn⁄_pg¥Ÿ
(mask_set);

816 
mask_˛r
 = 
	`ˇn⁄_pg¥Ÿ
(mask_clr);

817 i‡(!
	`pg¥Ÿ_vÆ
(
mask_£t
Ë&& !pg¥Ÿ_vÆ(
mask_˛r
Ë&& !
f‹˚_•lô
)

821 i‡(
ö_Êag
 & 
CPA_ARRAY
) {

822 
i
;

823 
i
 = 0; i < 
num∑ges
; i++) {

824 i‡(
addr
[
i
] & ~
PAGE_MASK
) {

825 
addr
[
i
] &
PAGE_MASK
;

826 
	`WARN_ON_ONCE
(1);

829 } i‡(!(
ö_Êag
 & 
CPA_PAGES_ARRAY
)) {

834 i‡(*
addr
 & ~
PAGE_MASK
) {

835 *
addr
 &
PAGE_MASK
;

839 
	`WARN_ON_ONCE
(1);

845 
baddr
 = *
addr
;

849 
	`km≠_Êush_unu£d
();

851 
	`vm_unm≠_Æü£s
();

853 
˝a
.
vaddr
 = 
addr
;

854 
˝a
.
∑ges
 =Öages;

855 
˝a
.
num∑ges
 =Çumpages;

856 
˝a
.
mask_£t
 = mask_set;

857 
˝a
.
mask_˛r
 = mask_clr;

858 
˝a
.
Êags
 = 0;

859 
˝a
.
cuΩage
 = 0;

860 
˝a
.
f‹˚_•lô
 = force_split;

862 i‡(
ö_Êag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

863 
˝a
.
Êags
 |
ö_Êag
;

866 
checkÆüs
 = (
	`pg¥Ÿ_vÆ
(
mask_£t
Ë|Ög¥Ÿ_vÆ(
mask_˛r
)Ë!
_PAGE_NX
;

868 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 
checkÆüs
);

873 i‡(!(
˝a
.
Êags
 & 
CPA_FLUSHTLB
))

874 
out
;

880 
ˇche
 = 
	`ˇche_©å
(
mask_£t
);

888 i‡(!
ªt
 && 
˝u_has_˛Êush
) {

889 i‡(
˝a
.
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

890 
	`˝a_Êush_¨øy
(
addr
, 
num∑ges
, 
ˇche
,

891 
˝a
.
Êags
, 
∑ges
);

893 
	`˝a_Êush_ønge
(
baddr
, 
num∑ges
, 
ˇche
);

895 
	`˝a_Êush_Æl
(
ˇche
);

897 
out
:

898  
ªt
;

899 
	}
}

901 
ölöe
 
	$ch™ge_∑ge_©å_£t
(*
addr
, 
num∑ges
,

902 
pg¥Ÿ_t
 
mask
, 
¨øy
)

904  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

905 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

906 
	}
}

908 
ölöe
 
	$ch™ge_∑ge_©å_˛ór
(*
addr
, 
num∑ges
,

909 
pg¥Ÿ_t
 
mask
, 
¨øy
)

911  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

912 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

913 
	}
}

915 
ölöe
 
	$˝a_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

916 
pg¥Ÿ_t
 
mask
)

918  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

919 
CPA_PAGES_ARRAY
, 
∑ges
);

920 
	}
}

922 
ölöe
 
	$˝a_˛ór_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

923 
pg¥Ÿ_t
 
mask
)

925  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

926 
CPA_PAGES_ARRAY
, 
∑ges
);

927 
	}
}

929 
	$_£t_mem‹y_uc
(
addr
, 
num∑ges
)

934  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

935 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

936 
	}
}

938 
	$£t_mem‹y_uc
(
addr
, 
num∑ges
)

940 
ªt
;

945 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

946 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

947 i‡(
ªt
)

948 
out_îr
;

950 
ªt
 = 
	`_£t_mem‹y_uc
(
addr
, 
num∑ges
);

951 i‡(
ªt
)

952 
out_‰ì
;

956 
out_‰ì
:

957 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

958 
out_îr
:

959  
ªt
;

960 
	}
}

961 
EXPORT_SYMBOL
(
£t_mem‹y_uc
);

963 
	$£t_mem‹y_¨øy_uc
(*
addr
, 
addrö¨øy
)

965 
i
, 
j
;

966 
ªt
;

971 
i
 = 0; i < 
addrö¨øy
; i++) {

972 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
,

973 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

974 i‡(
ªt
)

975 
out_‰ì
;

978 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(
addr
, 
addrö¨øy
,

979 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 1);

980 i‡(
ªt
)

981 
out_‰ì
;

985 
out_‰ì
:

986 
j
 = 0; j < 
i
; j++)

987 
	`‰ì_memty≥
(
	`__∑
(
addr
[
j
]), __∑◊ddr[j]Ë+ 
PAGE_SIZE
);

989  
ªt
;

990 
	}
}

991 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_uc
);

993 
	$_£t_mem‹y_wc
(
addr
, 
num∑ges
)

995 
ªt
;

996 
addr_c›y
 = 
addr
;

998 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

999 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

1000 i‡(!
ªt
) {

1001 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(&
addr_c›y
, 
num∑ges
,

1002 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1003 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1004 0, 0, 
NULL
);

1006  
ªt
;

1007 
	}
}

1009 
	$£t_mem‹y_wc
(
addr
, 
num∑ges
)

1011 
ªt
;

1013 i‡(!
∑t_íabÀd
)

1014  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1016 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

1017 
_PAGE_CACHE_WC
, 
NULL
);

1018 i‡(
ªt
)

1019 
out_îr
;

1021 
ªt
 = 
	`_£t_mem‹y_wc
(
addr
, 
num∑ges
);

1022 i‡(
ªt
)

1023 
out_‰ì
;

1027 
out_‰ì
:

1028 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1029 
out_îr
:

1030  
ªt
;

1031 
	}
}

1032 
EXPORT_SYMBOL
(
£t_mem‹y_wc
);

1034 
	$_£t_mem‹y_wb
(
addr
, 
num∑ges
)

1036  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
,

1037 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 0);

1038 
	}
}

1040 
	$£t_mem‹y_wb
(
addr
, 
num∑ges
)

1042 
ªt
;

1044 
ªt
 = 
	`_£t_mem‹y_wb
(
addr
, 
num∑ges
);

1045 i‡(
ªt
)

1046  
ªt
;

1048 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1050 
	}
}

1051 
EXPORT_SYMBOL
(
£t_mem‹y_wb
);

1053 
	$£t_mem‹y_¨øy_wb
(*
addr
, 
addrö¨øy
)

1055 
i
;

1056 
ªt
;

1058 
ªt
 = 
	`ch™ge_∑ge_©å_˛ór
(
addr
, 
addrö¨øy
,

1059 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 1);

1060 i‡(
ªt
)

1061  
ªt
;

1063 
i
 = 0; i < 
addrö¨øy
; i++)

1064 
	`‰ì_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
);

1067 
	}
}

1068 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wb
);

1070 
	$£t_mem‹y_x
(
addr
, 
num∑ges
)

1072  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1073 
	}
}

1074 
EXPORT_SYMBOL
(
£t_mem‹y_x
);

1076 
	$£t_mem‹y_nx
(
addr
, 
num∑ges
)

1078  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1079 
	}
}

1080 
EXPORT_SYMBOL
(
£t_mem‹y_nx
);

1082 
	$£t_mem‹y_ro
(
addr
, 
num∑ges
)

1084  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1085 
	}
}

1086 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_ro
);

1088 
	$£t_mem‹y_rw
(
addr
, 
num∑ges
)

1090  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1091 
	}
}

1092 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_rw
);

1094 
	$£t_mem‹y_≈
(
addr
, 
num∑ges
)

1096  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_PRESENT
), 0);

1097 
	}
}

1099 
	$£t_mem‹y_4k
(
addr
, 
num∑ges
)

1101  
	`ch™ge_∑ge_©å_£t_˛r
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0),

1102 
	`__pg¥Ÿ
(0), 1, 0, 
NULL
);

1103 
	}
}

1105 
	$£t_∑ges_uc
(
∑ge
 *∑ge, 
num∑ges
)

1107 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1109  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1110 
	}
}

1111 
EXPORT_SYMBOL
(
£t_∑ges_uc
);

1113 
	$£t_∑ges_¨øy_uc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1115 
°¨t
;

1116 
íd
;

1117 
i
;

1118 
‰ì_idx
;

1120 
i
 = 0; i < 
addrö¨øy
; i++) {

1121 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1123 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1124 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1125 i‡(
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
_PAGE_CACHE_UC_MINUS
, 
NULL
))

1126 
îr_out
;

1129 i‡(
	`˝a_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1130 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
)) == 0) {

1133 
îr_out
:

1134 
‰ì_idx
 = 
i
;

1135 
i
 = 0; i < 
‰ì_idx
; i++) {

1136 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1138 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1139 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1140 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1142  -
EINVAL
;

1143 
	}
}

1144 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_uc
);

1146 
	$£t_∑ges_wb
(
∑ge
 *∑ge, 
num∑ges
)

1148 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1150  
	`£t_mem‹y_wb
(
addr
, 
num∑ges
);

1151 
	}
}

1152 
EXPORT_SYMBOL
(
£t_∑ges_wb
);

1154 
	$£t_∑ges_¨øy_wb
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1156 
ªtvÆ
;

1157 
°¨t
;

1158 
íd
;

1159 
i
;

1161 
ªtvÆ
 = 
	`˝a_˛ór_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1162 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
));

1163 i‡(
ªtvÆ
)

1164  
ªtvÆ
;

1166 
i
 = 0; i < 
addrö¨øy
; i++) {

1167 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1169 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1170 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1171 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1175 
	}
}

1176 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wb
);

1178 
	$£t_∑ges_x
(
∑ge
 *∑ge, 
num∑ges
)

1180 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1182  
	`£t_mem‹y_x
(
addr
, 
num∑ges
);

1183 
	}
}

1184 
EXPORT_SYMBOL
(
£t_∑ges_x
);

1186 
	$£t_∑ges_nx
(
∑ge
 *∑ge, 
num∑ges
)

1188 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1190  
	`£t_mem‹y_nx
(
addr
, 
num∑ges
);

1191 
	}
}

1192 
EXPORT_SYMBOL
(
£t_∑ges_nx
);

1194 
	$£t_∑ges_ro
(
∑ge
 *∑ge, 
num∑ges
)

1196 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1198  
	`£t_mem‹y_ro
(
addr
, 
num∑ges
);

1199 
	}
}

1201 
	$£t_∑ges_rw
(
∑ge
 *∑ge, 
num∑ges
)

1203 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1205  
	`£t_mem‹y_rw
(
addr
, 
num∑ges
);

1206 
	}
}

1208 #ifde‡
CONFIG_DEBUG_PAGEALLOC


1210 
	$__£t_∑ges_p
(
∑ge
 *∑ge, 
num∑ges
)

1212 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1213 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1214 .
num∑ges
 =Çumpages,

1215 .
mask_£t
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1216 .
mask_˛r
 = 
	`__pg¥Ÿ
(0),

1217 .
Êags
 = 0};

1225  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1226 
	}
}

1228 
	$__£t_∑ges_≈
(
∑ge
 *∑ge, 
num∑ges
)

1230 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1231 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1232 .
num∑ges
 =Çumpages,

1233 .
mask_£t
 = 
	`__pg¥Ÿ
(0),

1234 .
mask_˛r
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1235 .
Êags
 = 0};

1243  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1244 
	}
}

1246 
	$kî√l_m≠_∑ges
(
∑ge
 *∑ge, 
num∑ges
, 
íabÀ
)

1248 i‡(
	`PageHighMem
(
∑ge
))

1250 i‡(!
íabÀ
) {

1251 
	`debug_check_no_locks_‰ìd
(
	`∑ge_addªss
(
∑ge
),

1252 
num∑ges
 * 
PAGE_SIZE
);

1258 i‡(!
debug_∑góŒoc_íabÀd
)

1266 i‡(
íabÀ
)

1267 
	`__£t_∑ges_p
(
∑ge
, 
num∑ges
);

1269 
	`__£t_∑ges_≈
(
∑ge
, 
num∑ges
);

1275 
	`__Êush_éb_Æl
();

1276 
	}
}

1278 #ifde‡
CONFIG_HIBERNATION


1280 
boﬁ
 
	$kî√l_∑ge_¥e£¡
(
∑ge
 *page)

1282 
Àvñ
;

1283 
±e_t
 *
±e
;

1285 i‡(
	`PageHighMem
(
∑ge
))

1286  
Ál£
;

1288 
±e
 = 
	`lookup_addªss
(()
	`∑ge_addªss
(
∑ge
), &
Àvñ
);

1289  (
	`±e_vÆ
(*
±e
Ë& 
_PAGE_PRESENT
);

1290 
	}
}

1300 #ifde‡
CONFIG_CPA_DEBUG


1301 
	~"∑góâr-ã°.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<löux/£q_fûe.h
>

11 
	~<löux/boŸmem.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/gÂ.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/rbåì.h
>

20 
	~<asm/ˇcheÊush.h
>

21 
	~<asm/¥o˚ss‹.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/f˙é.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/mår.h
>

27 
	~<asm/∑ge.h
>

28 
	~<asm/m§.h
>

29 
	~<asm/∑t.h
>

30 
	~<asm/io.h
>

32 #ifde‡
CONFIG_X86_PAT


33 
__ªad_mo°ly
 
	g∑t_íabÀd
 = 1;

35 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

37 
∑t_íabÀd
 = 0;

38 
	`¥ötk
(
KERN_INFO
 "%s\n", 
ªas⁄
);

39 
	}
}

41 
__öô
 
	$n›©
(*
°r
)

43 
	`∑t_dißbÀ
("PAT support disabled.");

45 
	}
}

46 
óæy_∑øm
("n›©", 
n›©
);

48 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

50 ()
ªas⁄
;

51 
	}
}

55 
	gdebug_íabÀ
;

57 
__öô
 
	$∑t_debug_£tup
(*
°r
)

59 
debug_íabÀ
 = 1;

61 
	}
}

62 
__£tup
("debug∑t", 
∑t_debug_£tup
);

64 
	#d¥ötk
(
fmt
, 
¨g
...) \

65 dÿ{ i‡(
debug_íabÀ
Ë
	`¥ötk
(
KERN_INFO
 
fmt
, ##
¨g
); } 0)

	)

68 
u64
 
__ªad_mo°ly
 
	gboŸ_∑t_°©e
;

71 
	mPAT_UC
 = 0,

72 
	mPAT_WC
 = 1,

73 
	mPAT_WT
 = 4,

74 
	mPAT_WP
 = 5,

75 
	mPAT_WB
 = 6,

76 
	mPAT_UC_MINUS
 = 7,

79 
	#PAT
(
x
, 
y
Ë((
u64
)
PAT_
 ## y << ((x)*8))

	)

81 
	$∑t_öô
()

83 
u64
 
∑t
;

84 
boﬁ
 
boŸ_˝u
 = !
boŸ_∑t_°©e
;

86 i‡(!
∑t_íabÀd
)

89 i‡(!
˝u_has_∑t
) {

90 i‡(!
boŸ_∑t_°©e
) {

91 
	`∑t_dißbÀ
("PATÇot supported by CPU.");

99 
	`¥ötk
(
KERN_ERR
 "PATÉnabled, "

101 
	`BUG
();

118 
∑t
 = 
	`PAT
(0, 
WB
Ë| PAT(1, 
WC
Ë| PAT(2, 
UC_MINUS
Ë| PAT(3, 
UC
) |

119 
	`PAT
(4, 
WB
Ë| PAT(5, 
WC
Ë| PAT(6, 
UC_MINUS
Ë| PAT(7, 
UC
);

122 i‡(!
boŸ_∑t_°©e
)

123 
	`rdm§l
(
MSR_IA32_CR_PAT
, 
boŸ_∑t_°©e
);

125 
	`wrm§l
(
MSR_IA32_CR_PAT
, 
∑t
);

127 i‡(
boŸ_˝u
)

128 
	`¥ötk
(
KERN_INFO
 "x86 PATÉnabled: cpu %d, old 0x%Lx,Çew 0x%Lx\n",

129 
	`smp_¥o˚ss‹_id
(), 
boŸ_∑t_°©e
, 
∑t
);

130 
	}
}

132 #unde‡
PAT


134 *
	$ˇâr_«me
(
Êags
)

136 
Êags
 & 
_PAGE_CACHE_MASK
) {

137 
_PAGE_CACHE_UC
:  "uncached";

138 
_PAGE_CACHE_UC_MINUS
:  "uncached-minus";

139 
_PAGE_CACHE_WB
:  "write-back";

140 
_PAGE_CACHE_WC
:  "write-combining";

143 
	}
}

161 
	smemty≥
 {

162 
u64
 
	m°¨t
;

163 
u64
 
	míd
;

164 
	mty≥
;

165 
li°_hód
 
	mnd
;

166 
rb_node
 
	mrb
;

169 
rb_roŸ
 
	gmemty≥_rbroŸ
 = 
RB_ROOT
;

170 
LIST_HEAD
(
memty≥_li°
);

171 
DEFINE_SPINLOCK
(
memty≥_lock
);

173 
memty≥
 *
	$memty≥_rb_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
°¨t
)

175 
rb_node
 *
node
 = 
roŸ
->rb_node;

176 
memty≥
 *
œ°_lowî
 = 
NULL
;

178 
node
) {

179 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

181 i‡(
d©a
->
°¨t
 < start) {

182 
œ°_lowî
 = 
d©a
;

183 
node
 =Çode->
rb_right
;

184 } i‡(
d©a
->
°¨t
 > start) {

185 
node
 =Çode->
rb_À·
;

187  
d©a
;

191  
œ°_lowî
;

192 
	}
}

194 
	$memty≥_rb_ö£π
(
rb_roŸ
 *
roŸ
, 
memty≥
 *
d©a
)

196 
rb_node
 **
√w
 = &(
roŸ
->rb_node);

197 
rb_node
 *
∑ª¡
 = 
NULL
;

199 *
√w
) {

200 
memty≥
 *
this
 = 
	`c⁄èöî_of
(*
√w
, memty≥, 
rb
);

202 
∑ª¡
 = *
√w
;

203 i‡(
d©a
->
°¨t
 <
this
->start)

204 
√w
 = &((*√w)->
rb_À·
);

205 i‡(
d©a
->
°¨t
 > 
this
->start)

206 
√w
 = &((*√w)->
rb_right
);

209 
	`rb_lök_node
(&
d©a
->
rb
, 
∑ª¡
, 
√w
);

210 
	`rb_ö£π_cﬁ‹
(&
d©a
->
rb
, 
roŸ
);

211 
	}
}

220 
	$∑t_x_mår_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
)

226 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WB
) {

227 
u8
 
mår_ty≥
;

229 
mår_ty≥
 = 
	`mår_ty≥_lookup
(
°¨t
, 
íd
);

230 i‡(
mår_ty≥
 !
MTRR_TYPE_WRBACK
)

231  
_PAGE_CACHE_UC_MINUS
;

233  
_PAGE_CACHE_WB
;

236  
ªq_ty≥
;

237 
	}
}

240 
	$chk_c⁄Êi˘
(
memty≥
 *
√w
, memty≥ *
íåy
, *
ty≥
)

242 i‡(
√w
->
ty≥
 !
íåy
->type) {

243 i‡(
ty≥
) {

244 
√w
->
ty≥
 = 
íåy
->type;

245 *
ty≥
 = 
íåy
->type;

247 
c⁄Êi˘
;

251 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
, &
memty≥_li°
, 
nd
) {

252 i‡(
√w
->
íd
 <
íåy
->
°¨t
)

254 i‡(
√w
->
ty≥
 !
íåy
->type)

255 
c⁄Êi˘
;

259 
c⁄Êi˘
:

260 
	`¥ötk
(
KERN_INFO
 "%s:%d conflicting memoryÅypes "

261 "%Lx-%Lx %s<->%s\n", 
cuºít
->
comm
, cuºít->
pid
, 
√w
->
°¨t
,

262 
√w
->
íd
, 
	`ˇâr_«me
“ew->
ty≥
), c©å_«me(
íåy
->type));

263  -
EBUSY
;

264 
	}
}

266 
	$∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
)

268 
øm_∑ge
 = 0, 
nŸ_øm∑ge
 = 0;

269 
∑ge_ƒ
;

271 
∑ge_ƒ
 = (
°¨t
 >> 
PAGE_SHIFT
);Öage_ƒ < (
íd
 >> PAGE_SHIFT);

272 ++
∑ge_ƒ
) {

280 i‡(
∑ge_ƒ
 >(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

281 
	`∑ge_is_øm
(
∑ge_ƒ
))

282 
øm_∑ge
 = 1;

284 
nŸ_øm∑ge
 = 1;

286 i‡(
øm_∑ge
 =
nŸ_øm∑ge
)

290  
øm_∑ge
;

291 
	}
}

301 
	$ª£rve_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

302 *
√w_ty≥
)

304 
∑ge
 *page;

305 
u64
 
p‚
;

307 i‡(
ªq_ty≥
 =
_PAGE_CACHE_UC
) {

309 
	`WARN_ON_ONCE
(1);

310 
ªq_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

313 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

314 
ty≥
;

316 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

317 
ty≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

318 i‡(
ty≥
 != -1) {

319 
	`¥ötk
(
KERN_INFO
 "reserve_ram_pages_type failed "

321 
°¨t
, 
íd
, 
ty≥
, 
ªq_ty≥
);

322 i‡(
√w_ty≥
)

323 *
√w_ty≥
 = 
ty≥
;

325  -
EBUSY
;

329 i‡(
√w_ty≥
)

330 *
√w_ty≥
 = 
ªq_ty≥
;

332 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

333 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

334 
	`£t_∑ge_memty≥
(
∑ge
, 
ªq_ty≥
);

337 
	}
}

339 
	$‰ì_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
)

341 
∑ge
 *page;

342 
u64
 
p‚
;

344 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

345 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

346 
	`£t_∑ge_memty≥
(
∑ge
, -1);

349 
	}
}

366 
	$ª£rve_memty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

367 *
√w_ty≥
)

369 
memty≥
 *
√w
, *
íåy
;

370 
a˘uÆ_ty≥
;

371 
li°_hód
 *
whîe
;

372 
is_ønge_øm
;

373 
îr
 = 0;

375 
	`BUG_ON
(
°¨t
 >
íd
);

377 i‡(!
∑t_íabÀd
) {

379 i‡(
√w_ty≥
) {

380 i‡(
ªq_ty≥
 == -1)

381 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

382 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WC
)

383 *
√w_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

385 *
√w_ty≥
 = 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
;

391 i‡(
	`is_ISA_ønge
(
°¨t
, 
íd
 - 1)) {

392 i‡(
√w_ty≥
)

393 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

403 
a˘uÆ_ty≥
 = 
	`∑t_x_mår_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
);

405 i‡(
√w_ty≥
)

406 *
√w_ty≥
 = 
a˘uÆ_ty≥
;

408 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

409 i‡(
is_ønge_øm
 == 1) {

411 
	`•ö_lock
(&
memty≥_lock
);

412 
îr
 = 
	`ª£rve_øm_∑ges_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, 
√w_ty≥
);

413 
	`•ö_u∆ock
(&
memty≥_lock
);

415  
îr
;

416 } i‡(
is_ønge_øm
 < 0) {

417  -
EINVAL
;

420 
√w
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

421 i‡(!
√w
)

422  -
ENOMEM
;

424 
√w
->
°¨t
 = start;

425 
√w
->
íd
 =Énd;

426 
√w
->
ty≥
 = 
a˘uÆ_ty≥
;

428 
	`•ö_lock
(&
memty≥_lock
);

431 
whîe
 = 
NULL
;

432 
	`li°_f‹_óch_íåy
(
íåy
, &
memty≥_li°
, 
nd
) {

433 i‡(
íd
 <
íåy
->
°¨t
) {

434 
whîe
 = 
íåy
->
nd
.
¥ev
;

436 } i‡(
°¨t
 <
íåy
->start) {

437 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

438 i‡(!
îr
) {

439 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

440 
íåy
->
°¨t
,É¡ry->
íd
);

441 
whîe
 = 
íåy
->
nd
.
¥ev
;

444 } i‡(
°¨t
 < 
íåy
->
íd
) {

445 
îr
 = 
	`chk_c⁄Êi˘
(
√w
, 
íåy
, 
√w_ty≥
);

446 i‡(!
îr
) {

447 
	`d¥ötk
("Overlapát 0x%Lx-0x%Lx\n",

448 
íåy
->
°¨t
,É¡ry->
íd
);

454 
	`li°_f‹_óch_íåy_c⁄töue
(
íåy
,

455 &
memty≥_li°
, 
nd
) {

456 i‡(
°¨t
 <
íåy
->start) {

457 
whîe
 = 
íåy
->
nd
.
¥ev
;

466 i‡(
îr
) {

467 
	`¥ötk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

469 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
));

470 
	`k‰ì
(
√w
);

471 
	`•ö_u∆ock
(&
memty≥_lock
);

473  
îr
;

476 i‡(
whîe
)

477 
	`li°_add
(&
√w
->
nd
, 
whîe
);

479 
	`li°_add_èû
(&
√w
->
nd
, &
memty≥_li°
);

481 
	`memty≥_rb_ö£π
(&
memty≥_rbroŸ
, 
√w
);

483 
	`•ö_u∆ock
(&
memty≥_lock
);

485 
	`d¥ötk
("reserve_memtypeádded 0x%Lx-0x%Lx,Årack %s,Ñeq %s,Ñet %s\n",

486 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
),

487 
√w_ty≥
 ? 
	`ˇâr_«me
(*new_type) : "-");

489  
îr
;

490 
	}
}

492 
	$‰ì_memty≥
(
u64
 
°¨t
, u64 
íd
)

494 
memty≥
 *
íåy
, *
ßved_íåy
;

495 
îr
 = -
EINVAL
;

496 
is_ønge_øm
;

498 i‡(!
∑t_íabÀd
)

502 i‡(
	`is_ISA_ønge
(
°¨t
, 
íd
 - 1))

505 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

506 i‡(
is_ønge_øm
 == 1) {

508 
	`•ö_lock
(&
memty≥_lock
);

509 
îr
 = 
	`‰ì_øm_∑ges_ty≥
(
°¨t
, 
íd
);

510 
	`•ö_u∆ock
(&
memty≥_lock
);

512  
îr
;

513 } i‡(
is_ønge_øm
 < 0) {

514  -
EINVAL
;

517 
	`•ö_lock
(&
memty≥_lock
);

519 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
°¨t
);

520 i‡(
	`u∆ikñy
(
íåy
 =
NULL
))

521 
u∆ock_ªt
;

529 
ßved_íåy
 = 
íåy
;

530 
	`li°_f‹_óch_íåy_‰om
(
íåy
, &
memty≥_li°
, 
nd
) {

531 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

532 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

533 
	`li°_dñ
(&
íåy
->
nd
);

534 
	`k‰ì
(
íåy
);

535 
îr
 = 0;

537 } i‡(
íåy
->
°¨t
 > start) {

542 i‡(!
îr
)

543 
u∆ock_ªt
;

545 
íåy
 = 
ßved_íåy
;

546 
	`li°_f‹_óch_íåy_ªvî£
(
íåy
, &
memty≥_li°
, 
nd
) {

547 i‡(
íåy
->
°¨t
 =°¨à&&É¡ry->
íd
 ==Énd) {

548 
	`rb_îa£
(&
íåy
->
rb
, &
memty≥_rbroŸ
);

549 
	`li°_dñ
(&
íåy
->
nd
);

550 
	`k‰ì
(
íåy
);

551 
îr
 = 0;

553 } i‡(
íåy
->
°¨t
 < start) {

557 
u∆ock_ªt
:

558 
	`•ö_u∆ock
(&
memty≥_lock
);

560 i‡(
îr
) {

561 
	`¥ötk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

562 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
, 
íd
);

565 
	`d¥ötk
("‰ì_memty≥Ñeque° 0x%Lx-0x%Lx\n", 
°¨t
, 
íd
);

567  
îr
;

568 
	}
}

580 
	$lookup_memty≥
(
u64
 
∑ddr
)

582 
ªây≥
 = 
_PAGE_CACHE_WB
;

583 
memty≥
 *
íåy
;

585 i‡(
	`is_ISA_ønge
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
 - 1))

586  
ªây≥
;

588 i‡(
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
)) {

589 
∑ge
 *page;

590 
	`•ö_lock
(&
memty≥_lock
);

591 
∑ge
 = 
	`p‚_to_∑ge
(
∑ddr
 >> 
PAGE_SHIFT
);

592 
ªây≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

593 
	`•ö_u∆ock
(&
memty≥_lock
);

598 i‡(
ªây≥
 == -1)

599 
ªây≥
 = 
_PAGE_CACHE_WB
;

601  
ªây≥
;

604 
	`•ö_lock
(&
memty≥_lock
);

606 
íåy
 = 
	`memty≥_rb_£¨ch
(&
memty≥_rbroŸ
, 
∑ddr
);

607 i‡(
íåy
 !
NULL
)

608 
ªây≥
 = 
íåy
->
ty≥
;

610 
ªây≥
 = 
_PAGE_CACHE_UC_MINUS
;

612 
	`•ö_u∆ock
(&
memty≥_lock
);

613  
ªây≥
;

614 
	}
}

626 
	$io_ª£rve_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
,

627 *
ty≥
)

629 
ªsour˚_size_t
 
size
 = 
íd
 - 
°¨t
;

630 
ªq_ty≥
 = *
ty≥
;

631 
√w_ty≥
;

632 
ªt
;

634 
	`WARN_ON_ONCE
(
	`iomem_m≠_ßnôy_check
(
°¨t
, 
size
));

636 
ªt
 = 
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, &
√w_ty≥
);

637 i‡(
ªt
)

638 
out_îr
;

640 i‡(!
	`is_√w_memty≥_Ælowed
(
°¨t
, 
size
, 
ªq_ty≥
, 
√w_ty≥
))

641 
out_‰ì
;

643 i‡(
	`kî√l_m≠_sync_memty≥
(
°¨t
, 
size
, 
√w_ty≥
) < 0)

644 
out_‰ì
;

646 *
ty≥
 = 
√w_ty≥
;

649 
out_‰ì
:

650 
	`‰ì_memty≥
(
°¨t
, 
íd
);

651 
ªt
 = -
EBUSY
;

652 
out_îr
:

653  
ªt
;

654 
	}
}

661 
	$io_‰ì_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
)

663 
	`‰ì_memty≥
(
°¨t
, 
íd
);

664 
	}
}

666 
pg¥Ÿ_t
 
	$phys_mem_ac˚ss_¥Ÿ
(
fûe
 *fûe, 
p‚
,

667 
size
, 
pg¥Ÿ_t
 
vma_¥Ÿ
)

669  
vma_¥Ÿ
;

670 
	}
}

672 #ifde‡
CONFIG_STRICT_DEVMEM


674 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

677 
	}
}

680 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

682 
u64
 
‰om
 = ((u64)
p‚
Ë<< 
PAGE_SHIFT
;

683 
u64
 
to
 = 
‰om
 + 
size
;

684 
u64
 
curs‹
 = 
‰om
;

686 i‡(!
∑t_íabÀd
)

689 
curs‹
 < 
to
) {

690 i‡(!
	`devmem_is_Ælowed
(
p‚
)) {

691 
	`¥ötk
(
KERN_INFO


693 
cuºít
->
comm
, 
‰om
, 
to
);

696 
curs‹
 +
PAGE_SIZE
;

697 
p‚
++;

700 
	}
}

703 
	$phys_mem_ac˚ss_¥Ÿ_Ælowed
(
fûe
 *fûe, 
p‚
,

704 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
)

706 
Êags
 = 
_PAGE_CACHE_WB
;

708 i‡(!
	`ønge_is_Ælowed
(
p‚
, 
size
))

711 i‡(
fûe
->
f_Êags
 & 
O_SYNC
) {

712 
Êags
 = 
_PAGE_CACHE_UC_MINUS
;

715 #ifde‡
CONFIG_X86_32


724 i‡(!
∑t_íabÀd
 &&

725 !(
	`boŸ_˝u_has
(
X86_FEATURE_MTRR
) ||

726 
	`boŸ_˝u_has
(
X86_FEATURE_K6_MTRR
) ||

727 
	`boŸ_˝u_has
(
X86_FEATURE_CYRIX_ARR
) ||

728 
	`boŸ_˝u_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

729 (
p‚
 << 
PAGE_SHIFT
Ë>
	`__∑
(
high_mem‹y
)) {

730 
Êags
 = 
_PAGE_CACHE_UC
;

734 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_¥ŸË& ~
_PAGE_CACHE_MASK
) |

735 
Êags
);

737 
	}
}

743 
	$kî√l_m≠_sync_memty≥
(
u64
 
ba£
, 
size
, 
Êags
)

745 
id_sz
;

747 i‡(
ba£
 >
	`__∑
(
high_mem‹y
))

750 
id_sz
 = (
	`__∑
(
high_mem‹y
Ë< 
ba£
 + 
size
) ?

751 
	`__∑
(
high_mem‹y
Ë- 
ba£
 :

752 
size
;

754 i‡(
	`i‹em≠_ch™ge_©å
(()
	`__va
(
ba£
), 
id_sz
, 
Êags
) < 0) {

755 
	`¥ötk
(
KERN_INFO


758 
cuºít
->
comm
, cuºít->
pid
,

759 
	`ˇâr_«me
(
Êags
),

760 
ba£
, ()(ba£ + 
size
));

761  -
EINVAL
;

764 
	}
}

771 
	$ª£rve_p‚_ønge
(
u64
 
∑ddr
, 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
,

772 
°ri˘_¥Ÿ
)

774 
is_øm
 = 0;

775 
ªt
;

776 
w™t_Êags
 = (
	`pg¥Ÿ_vÆ
(*
vma_¥Ÿ
Ë& 
_PAGE_CACHE_MASK
);

777 
Êags
 = 
w™t_Êags
;

779 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

786 i‡(
is_øm
) {

787 i‡(!
∑t_íabÀd
)

790 
Êags
 = 
	`lookup_memty≥
(
∑ddr
);

791 i‡(
w™t_Êags
 !
Êags
) {

792 
	`¥ötk
(
KERN_WARNING


794 
cuºít
->
comm
, cuºít->
pid
,

795 
	`ˇâr_«me
(
w™t_Êags
),

796 ()
∑ddr
,

797 ()(
∑ddr
 + 
size
),

798 
	`ˇâr_«me
(
Êags
));

799 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

800 (~
_PAGE_CACHE_MASK
)) |

801 
Êags
);

806 
ªt
 = 
	`ª£rve_memty≥
(
∑ddr
,Öadd∏+ 
size
, 
w™t_Êags
, &
Êags
);

807 i‡(
ªt
)

808  
ªt
;

810 i‡(
Êags
 !
w™t_Êags
) {

811 i‡(
°ri˘_¥Ÿ
 ||

812 !
	`is_√w_memty≥_Ælowed
(
∑ddr
, 
size
, 
w™t_Êags
, 
Êags
)) {

813 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

814 
	`¥ötk
(
KERN_ERR
 "%s:%d mapÖfnÉxpected mappingÅype %s"

816 
cuºít
->
comm
, cuºít->
pid
,

817 
	`ˇâr_«me
(
w™t_Êags
),

818 ()
∑ddr
,

819 ()(
∑ddr
 + 
size
),

820 
	`ˇâr_«me
(
Êags
));

821  -
EINVAL
;

827 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

828 (~
_PAGE_CACHE_MASK
)) |

829 
Êags
);

832 i‡(
	`kî√l_m≠_sync_memty≥
(
∑ddr
, 
size
, 
Êags
) < 0) {

833 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

834  -
EINVAL
;

837 
	}
}

843 
	$‰ì_p‚_ønge
(
u64
 
∑ddr
, 
size
)

845 
is_øm
;

847 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

848 i‡(
is_øm
 == 0)

849 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

850 
	}
}

859 
	$åack_p‚_vma_c›y
(
vm_¨ó_°ru˘
 *
vma
)

861 
ªsour˚_size_t
 
∑ddr
;

862 
¥Ÿ
;

863 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

864 
pg¥Ÿ_t
 
pg¥Ÿ
;

866 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

871 i‡(
	`fﬁlow_phys
(
vma
, vma->
vm_°¨t
, 0, &
¥Ÿ
, &
∑ddr
)) {

872 
	`WARN_ON_ONCE
(1);

873  -
EINVAL
;

875 
pg¥Ÿ
 = 
	`__pg¥Ÿ
(
¥Ÿ
);

876  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, &
pg¥Ÿ
, 1);

880 
	}
}

890 
	$åack_p‚_vma_√w
(
vm_¨ó_°ru˘
 *
vma
, 
pg¥Ÿ_t
 *
¥Ÿ
,

891 
p‚
, 
size
)

893 
Êags
;

894 
ªsour˚_size_t
 
∑ddr
;

895 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

897 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

899 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

900  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, 
¥Ÿ
, 0);

903 i‡(!
∑t_íabÀd
)

907 
Êags
 = 
	`lookup_memty≥
(
p‚
 << 
PAGE_SHIFT
);

908 *
¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
Ë& (~
_PAGE_CACHE_MASK
)) |

909 
Êags
);

912 
	}
}

919 
	$u¡øck_p‚_vma
(
vm_¨ó_°ru˘
 *
vma
, 
p‚
,

920 
size
)

922 
ªsour˚_size_t
 
∑ddr
;

923 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

925 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

927 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

928 
	`‰ì_p‚_ønge
(
∑ddr
, 
vma_size
);

931 
	}
}

933 
pg¥Ÿ_t
 
	$pg¥Ÿ_wrôecomböe
(
pg¥Ÿ_t
 
¥Ÿ
)

935 i‡(
∑t_íabÀd
)

936  
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_CACHE_WC
);

938  
	`pg¥Ÿ_n⁄ˇched
(
¥Ÿ
);

939 
	}
}

940 
EXPORT_SYMBOL_GPL
(
pg¥Ÿ_wrôecomböe
);

942 #i‡
deföed
(
CONFIG_DEBUG_FS
Ë&& deföed(
CONFIG_X86_PAT
)

945 
memty≥
 *
	$memty≥_gë_idx
(
loff_t
 
pos
)

947 
memty≥
 *
li°_node
, *
¥öt_íåy
;

948 
i
 = 1;

950 
¥öt_íåy
 = 
	`kmÆloc
((
memty≥
), 
GFP_KERNEL
);

951 i‡(!
¥öt_íåy
)

952  
NULL
;

954 
	`•ö_lock
(&
memty≥_lock
);

955 
	`li°_f‹_óch_íåy
(
li°_node
, &
memty≥_li°
, 
nd
) {

956 i‡(
pos
 =
i
) {

957 *
¥öt_íåy
 = *
li°_node
;

958 
	`•ö_u∆ock
(&
memty≥_lock
);

959  
¥öt_íåy
;

961 ++
i
;

963 
	`•ö_u∆ock
(&
memty≥_lock
);

964 
	`k‰ì
(
¥öt_íåy
);

966  
NULL
;

967 
	}
}

969 *
	$memty≥_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

971 i‡(*
pos
 == 0) {

972 ++*
pos
;

973 
	`£q_¥ötf
(
£q
, "PAT memtypeÜist:\n");

976  
	`memty≥_gë_idx
(*
pos
);

977 
	}
}

979 *
	$memty≥_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

981 ++*
pos
;

982  
	`memty≥_gë_idx
(*
pos
);

983 
	}
}

985 
	$memty≥_£q_°›
(
£q_fûe
 *
£q
, *
v
)

987 
	}
}

989 
	$memty≥_£q_show
(
£q_fûe
 *
£q
, *
v
)

991 
memty≥
 *
¥öt_íåy
 = (memty≥ *)
v
;

993 
	`£q_¥ötf
(
£q
, "%†@ 0x%Lx-0x%Lx\n", 
	`ˇâr_«me
(
¥öt_íåy
->
ty≥
),

994 
¥öt_íåy
->
°¨t
,Öröt_íåy->
íd
);

995 
	`k‰ì
(
¥öt_íåy
);

998 
	}
}

1000 c⁄° 
£q_›î©i⁄s
 
	gmemty≥_£q_›s
 = {

1001 .
°¨t
 = 
memty≥_£q_°¨t
,

1002 .
	g√xt
 = 
memty≥_£q_√xt
,

1003 .
	g°›
 = 
memty≥_£q_°›
,

1004 .
	gshow
 = 
memty≥_£q_show
,

1007 
	$memty≥_£q_›í
(
öode
 *öode, 
fûe
 *file)

1009  
	`£q_›í
(
fûe
, &
memty≥_£q_›s
);

1010 
	}
}

1012 c⁄° 
fûe_›î©i⁄s
 
	gmemty≥_f›s
 = {

1013 .
›í
 = 
memty≥_£q_›í
,

1014 .
	gªad
 = 
£q_ªad
,

1015 .
	gŒ£ek
 = 
£q_l£ek
,

1016 .
	gªÀa£
 = 
£q_ªÀa£
,

1019 
__öô
 
	$∑t_memty≥_li°_öô
()

1021 
	`debugfs_¸óã_fûe
("∑t_memty≥_li°", 
S_IRUSR
, 
¨ch_debugfs_dú
,

1022 
NULL
, &
memty≥_f›s
);

1024 
	}
}

1026 
œã_öôˇŒ
(
∑t_memty≥_li°_öô
);

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<löux/mm.h
>

2 
	~<asm/pgÆloc.h
>

3 
	~<asm/pgèbÀ.h
>

4 
	~<asm/éb.h
>

5 
	~<asm/fixm≠.h
>

7 
	#PGALLOC_GFP
 
GFP_KERNEL
 | 
__GFP_NOTRACK
 | 
__GFP_REPEAT
 | 
__GFP_ZERO


	)

9 
±e_t
 *
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

11  (
±e_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

12 
	}
}

14 
pgèbÀ_t
 
	$±e_Æloc_⁄e
(
mm_°ru˘
 *
mm
, 
addªss
)

16 
∑ge
 *
±e
;

18 #ifde‡
CONFIG_HIGHPTE


19 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
 | 
__GFP_HIGHMEM
, 0);

21 
±e
 = 
	`Æloc_∑ges
(
PGALLOC_GFP
, 0);

23 i‡(
±e
)

24 
	`pgèbÀ_∑ge_˘‹
(
±e
);

25  
±e
;

26 
	}
}

28 
	$___±e_‰ì_éb
(
mmu_g©hî
 *
éb
, 
∑ge
 *
±e
)

30 
	`pgèbÀ_∑ge_dt‹
(
±e
);

31 
	`∑øvút_ªÀa£_±e
(
	`∑ge_to_p‚
(
±e
));

32 
	`éb_ªmove_∑ge
(
éb
, 
±e
);

33 
	}
}

35 #i‡
PAGETABLE_LEVELS
 > 2

36 
	$___pmd_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pmd_t
 *
pmd
)

38 
	`∑øvút_ªÀa£_pmd
(
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

39 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pmd
));

40 
	}
}

42 #i‡
PAGETABLE_LEVELS
 > 3

43 
	$___pud_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pud_t
 *
pud
)

45 
	`∑øvút_ªÀa£_pud
(
	`__∑
(
pud
Ë>> 
PAGE_SHIFT
);

46 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pud
));

47 
	}
}

51 
ölöe
 
	$pgd_li°_add
(
pgd_t
 *
pgd
)

53 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

55 
	`li°_add
(&
∑ge
->
Ãu
, &
pgd_li°
);

56 
	}
}

58 
ölöe
 
	$pgd_li°_dñ
(
pgd_t
 *
pgd
)

60 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

62 
	`li°_dñ
(&
∑ge
->
Ãu
);

63 
	}
}

65 
	#UNSHARED_PTRS_PER_PGD
 \

66 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

68 
	$pgd_˘‹
(
pgd_t
 *
pgd
)

73 i‡(
PAGETABLE_LEVELS
 == 2 ||

74 (
PAGETABLE_LEVELS
 =3 && 
SHARED_KERNEL_PMD
) ||

75 
PAGETABLE_LEVELS
 == 4) {

76 
	`˛⁄e_pgd_ønge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

77 
sw≠≥r_pg_dú
 + 
KERNEL_PGD_BOUNDARY
,

78 
KERNEL_PGD_PTRS
);

79 
	`∑øvút_Æloc_pmd_˛⁄e
(
	`__∑
(
pgd
Ë>> 
PAGE_SHIFT
,

80 
	`__∑
(
sw≠≥r_pg_dú
Ë>> 
PAGE_SHIFT
,

81 
KERNEL_PGD_BOUNDARY
,

82 
KERNEL_PGD_PTRS
);

86 i‡(!
SHARED_KERNEL_PMD
)

87 
	`pgd_li°_add
(
pgd
);

88 
	}
}

90 
	$pgd_dt‹
(
pgd_t
 *
pgd
)

92 
Êags
;

94 i‡(
SHARED_KERNEL_PMD
)

97 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

98 
	`pgd_li°_dñ
(
pgd
);

99 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

100 
	}
}

113 #ifde‡
CONFIG_X86_PAE


125 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

127 
	$pud_p›uœã
(
mm_°ru˘
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

129 
	`∑øvút_Æloc_pmd
(
mm
, 
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

133 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_PAGE_PRESENT
));

141 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

142 
	`wrôe_¸3
(
	`ªad_¸3
());

143 
	}
}

147 
	#PREALLOCATED_PMDS
 0

	)

151 
	$‰ì_pmds
(
pmd_t
 *
pmds
[])

153 
i
;

155 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

156 i‡(
pmds
[
i
])

157 
	`‰ì_∑ge
(()
pmds
[
i
]);

158 
	}
}

160 
	$¥óŒoˇã_pmds
(
pmd_t
 *
pmds
[])

162 
i
;

163 
boﬁ
 
Áûed
 = 
Ál£
;

165 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

166 
pmd_t
 *
pmd
 = (pmd_à*)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

167 i‡(
pmd
 =
NULL
)

168 
Áûed
 = 
åue
;

169 
pmds
[
i
] = 
pmd
;

172 i‡(
Áûed
) {

173 
	`‰ì_pmds
(
pmds
);

174  -
ENOMEM
;

178 
	}
}

186 
	$pgd_m›_up_pmds
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgdp
)

188 
i
;

190 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

191 
pgd_t
 
pgd
 = 
pgdp
[
i
];

193 i‡(
	`pgd_vÆ
(
pgd
) != 0) {

194 
pmd_t
 *
pmd
 = (pmd_à*)
	`pgd_∑ge_vaddr
(
pgd
);

196 
pgdp
[
i
] = 
	`«tive_make_pgd
(0);

198 
	`∑øvút_ªÀa£_pmd
(
	`pgd_vÆ
(
pgd
Ë>> 
PAGE_SHIFT
);

199 
	`pmd_‰ì
(
mm
, 
pmd
);

202 
	}
}

204 
	$pgd_¥ï›uœã_pmd
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

206 
pud_t
 *
pud
;

207 
addr
;

208 
i
;

210 i‡(
PREALLOCATED_PMDS
 == 0)

213 
pud
 = 
	`pud_off£t
(
pgd
, 0);

215 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

216 
i
++, 
pud
++, 
addr
 +
PUD_SIZE
) {

217 
pmd_t
 *
pmd
 = 
pmds
[
i
];

219 i‡(
i
 >
KERNEL_PGD_BOUNDARY
)

220 
	`mem˝y
(
pmd
, (
pmd_t
 *)
	`pgd_∑ge_vaddr
(
sw≠≥r_pg_dú
[
i
]),

221 (
pmd_t
Ë* 
PTRS_PER_PMD
);

223 
	`pud_p›uœã
(
mm
, 
pud
, 
pmd
);

225 
	}
}

227 
pgd_t
 *
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

229 
pgd_t
 *
pgd
;

230 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

231 
Êags
;

233 
pgd
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

235 i‡(
pgd
 =
NULL
)

236 
out
;

238 
mm
->
pgd
 =Ögd;

240 i‡(
	`¥óŒoˇã_pmds
(
pmds
) != 0)

241 
out_‰ì_pgd
;

243 i‡(
	`∑øvút_pgd_Æloc
(
mm
) != 0)

244 
out_‰ì_pmds
;

251 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

253 
	`pgd_˘‹
(
pgd
);

254 
	`pgd_¥ï›uœã_pmd
(
mm
, 
pgd
, 
pmds
);

256 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

258  
pgd
;

260 
out_‰ì_pmds
:

261 
	`‰ì_pmds
(
pmds
);

262 
out_‰ì_pgd
:

263 
	`‰ì_∑ge
(()
pgd
);

264 
out
:

265  
NULL
;

266 
	}
}

268 
	$pgd_‰ì
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
)

270 
	`pgd_m›_up_pmds
(
mm
, 
pgd
);

271 
	`pgd_dt‹
(
pgd
);

272 
	`∑øvút_pgd_‰ì
(
mm
, 
pgd
);

273 
	`‰ì_∑ge
(()
pgd
);

274 
	}
}

276 
	$±ï_£t_ac˚ss_Êags
(
vm_¨ó_°ru˘
 *
vma
,

277 
addªss
, 
±e_t
 *
±ï
,

278 
±e_t
 
íåy
, 
dúty
)

280 
ch™ged
 = !
	`±e_ßme
(*
±ï
, 
íåy
);

282 i‡(
ch™ged
 && 
dúty
) {

283 *
±ï
 = 
íåy
;

284 
	`±e_upd©e_de„r
(
vma
->
vm_mm
, 
addªss
, 
±ï
);

285 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

288  
ch™ged
;

289 
	}
}

291 
	$±ï_ã°_™d_˛ór_young
(
vm_¨ó_°ru˘
 *
vma
,

292 
addr
, 
±e_t
 *
±ï
)

294 
ªt
 = 0;

296 i‡(
	`±e_young
(*
±ï
))

297 
ªt
 = 
	`ã°_™d_˛ór_bô
(
_PAGE_BIT_ACCESSED
,

298 (*Ë&
±ï
->
±e
);

300 i‡(
ªt
)

301 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±ï
);

303  
ªt
;

304 
	}
}

306 
	$±ï_˛ór_Êush_young
(
vm_¨ó_°ru˘
 *
vma
,

307 
addªss
, 
±e_t
 *
±ï
)

309 
young
;

311 
young
 = 
	`±ï_ã°_™d_˛ór_young
(
vma
, 
addªss
, 
±ï
);

312 i‡(
young
)

313 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

315  
young
;

316 
	}
}

325 
__öô
 
	$ª£rve_t›_addªss
(
ª£rve
)

327 #ifde‡
CONFIG_X86_32


328 
	`BUG_ON
(
fixm≠s_£t
 > 0);

329 
	`¥ötk
(
KERN_INFO
 "Reserving virtualáddress spaceábove 0x%08x\n",

330 ()-
ª£rve
);

331 
__FIXADDR_TOP
 = -
ª£rve
 - 
PAGE_SIZE
;

333 
	}
}

335 
	gfixm≠s_£t
;

337 
	$__«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
±e_t
 
±e
)

339 
addªss
 = 
	`__fix_to_vút
(
idx
);

341 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

342 
	`BUG
();

345 
	`£t_±e_vaddr
(
addªss
, 
±e
);

346 
fixm≠s_£t
++;

347 
	}
}

349 
	$«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
phys_addr_t
 
phys
,

350 
pg¥Ÿ_t
 
Êags
)

352 
	`__«tive_£t_fixm≠
(
idx
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

353 
	}
}

	@/cmpt816/linux/arch/x86/mm/physaddr.c

1 
	~<löux/mmdebug.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/∑ge.h
>

7 
	~"phyßddr.h
"

9 #ifde‡
CONFIG_X86_64


11 
	$__phys_addr
(
x
)

13 i‡(
x
 >
__START_KERNEL_m≠
) {

14 
x
 -
__START_KERNEL_m≠
;

15 
	`VIRTUAL_BUG_ON
(
x
 >
KERNEL_IMAGE_SIZE
);

16 
x
 +
phys_ba£
;

18 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

19 
x
 -
PAGE_OFFSET
;

20 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_vÆid
(
x
));

22  
x
;

23 
	}
}

24 
EXPORT_SYMBOL
(
__phys_addr
);

26 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

28 i‡(
x
 >
__START_KERNEL_m≠
) {

29 
x
 -
__START_KERNEL_m≠
;

30 i‡(
x
 >
KERNEL_IMAGE_SIZE
)

31  
Ál£
;

32 
x
 +
phys_ba£
;

34 i‡(
x
 < 
PAGE_OFFSET
)

35  
Ál£
;

36 
x
 -
PAGE_OFFSET
;

37 i‡(!
	`phys_addr_vÆid
(
x
))

38  
Ál£
;

41  
	`p‚_vÆid
(
x
 >> 
PAGE_SHIFT
);

42 
	}
}

43 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

47 #ifde‡
CONFIG_DEBUG_VIRTUAL


48 
	$__phys_addr
(
x
)

51 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

52 
	`VIRTUAL_BUG_ON
(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
));

53  
x
 - 
PAGE_OFFSET
;

54 
	}
}

55 
EXPORT_SYMBOL
(
__phys_addr
);

58 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

60 i‡(
x
 < 
PAGE_OFFSET
)

61  
Ál£
;

62 i‡(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
))

63  
Ál£
;

64 i‡(
x
 >
FIXADDR_START
)

65  
Ál£
;

66  
	`p‚_vÆid
((
x
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

	@/cmpt816/linux/arch/x86/mm/setup_nx.c

1 
	~<löux/•ölock.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/pgèbÀ.h
>

7 
	gnx_íabÀd
;

9 #i‡
deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

10 
dißbÀ_nx
 
	g__˝uöôd©a
;

20 
__öô
 
	$n€xec_£tup
(*
°r
)

22 i‡(!
°r
)

23  -
EINVAL
;

24 i‡(!
	`°∫cmp
(
°r
, "on", 2)) {

25 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

26 
dißbÀ_nx
 = 0;

27 } i‡(!
	`°∫cmp
(
°r
, "off", 3)) {

28 
dißbÀ_nx
 = 1;

29 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

32 
	}
}

33 
óæy_∑øm
("n€xec", 
n€xec_£tup
);

36 #ifde‡
CONFIG_X86_PAE


37 
__öô
 
	$£t_nx
()

39 
v
[4], 
l
, 
h
;

41 i‡(
˝u_has_∑e
 && (
	`˝uid_óx
(0x80000000) > 0x80000001)) {

42 
	`˝uid
(0x80000001, &
v
[0], &v[1], &v[2], &v[3]);

44 i‡((
v
[3] & (1 << 20)Ë&& !
dißbÀ_nx
) {

45 
	`rdm§
(
MSR_EFER
, 
l
, 
h
);

46 
l
 |
EFER_NX
;

47 
	`wrm§
(
MSR_EFER
, 
l
, 
h
);

48 
nx_íabÀd
 = 1;

49 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

52 
	}
}

54 
	$£t_nx
()

56 
	}
}

59 #ifde‡
CONFIG_X86_64


60 
__˝uöô
 
	$check_e„r
()

62 
e„r
;

64 
	`rdm§l
(
MSR_EFER
, 
e„r
);

65 i‡(!(
e„r
 & 
EFER_NX
Ë|| 
dißbÀ_nx
)

66 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

67 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/mmz⁄e.h
>

15 
	~<löux/bôm≠.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/t›ﬁogy.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/mm.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/uv/uv.h
>

26 
a˝i_numa
 
	g__öôd©a
;

28 
a˝i_èbÀ_¶ô
 *
	ga˝i_¶ô
;

30 
nodemask_t
 
nodes_∑r£d
 
	g__öôd©a
;

31 
nodemask_t
 
˝u_nodes_∑r£d
 
	g__öôd©a
;

32 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

33 
boŸnode
 
	gnodes_add
[
MAX_NUMNODES
];

35 
num_node_memblks
 
	g__öôd©a
;

36 
boŸnode
 
	gnode_memblk_ønge
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

37 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

39 
__öô
 
	$£tup_node
(
pxm
)

41  
	`a˝i_m≠_pxm_to_node
(
pxm
);

42 
	}
}

44 
__öô
 
	$c⁄Êi˘ög_memblks
(
°¨t
, 
íd
)

46 
i
;

47 
i
 = 0; i < 
num_node_memblks
; i++) {

48 
boŸnode
 *
nd
 = &
node_memblk_ønge
[
i
];

49 i‡(
nd
->
°¨t
 =nd->
íd
)

51 i‡(
nd
->
íd
 > 
°¨t
 &&Çd->start <Énd)

52  
memblk_nodeid
[
i
];

53 i‡(
nd
->
íd
 =íd &&Çd->
°¨t
 == start)

54  
memblk_nodeid
[
i
];

57 
	}
}

59 
__öô
 
	$cutoff_node
(
i
, 
°¨t
, 
íd
)

61 
boŸnode
 *
nd
 = &
nodes
[
i
];

63 i‡(
nd
->
°¨t
 < start) {

64 
nd
->
°¨t
 = start;

65 i‡(
nd
->
íd
 <Çd->
°¨t
)

66 
nd
->
°¨t
 =Çd->
íd
;

68 i‡(
nd
->
íd
 >Énd) {

69 
nd
->
íd
 =Énd;

70 i‡(
nd
->
°¨t
 >Çd->
íd
)

71 
nd
->
°¨t
 =Çd->
íd
;

73 
	}
}

75 
__öô
 
	$bad_§©
()

77 
i
;

78 
	`¥ötk
(
KERN_ERR
 "SRAT: SRATÇot used.\n");

79 
a˝i_numa
 = -1;

80 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

81 
≠icid_to_node
[
i
] = 
NUMA_NO_NODE
;

82 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

83 
nodes
[
i
].
°¨t
 =Çodes[i].
íd
 = 0;

84 
nodes_add
[
i
].
°¨t
 =Çodes_add[i].
íd
 = 0;

86 
	`ªmove_Æl_a˘ive_ønges
();

87 
	}
}

89 
__öô
 
ölöe
 
	$§©_dißbÀd
()

91  
numa_off
 || 
a˝i_numa
 < 0;

92 
	}
}

95 
__öô
 
	$a˝i_numa_¶ô_öô
(
a˝i_èbÀ_¶ô
 *
¶ô
)

97 
Àngth
;

98 
phys
;

100 
Àngth
 = 
¶ô
->
hódî
.length;

101 
phys
 = 
	`föd_e820_¨ó
(0, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
, 
Àngth
,

102 
PAGE_SIZE
);

104 i‡(
phys
 == -1L)

105 
	`∑nic
(" CanÇot save slit!\n");

107 
a˝i_¶ô
 = 
	`__va
(
phys
);

108 
	`mem˝y
(
a˝i_¶ô
, 
¶ô
, 
Àngth
);

109 
	`ª£rve_óæy
(
phys
,Öhy†+ 
Àngth
, "ACPI SLIT");

110 
	}
}

113 
__öô


114 
	$a˝i_numa_x2≠ic_afföôy_öô
(
a˝i_§©_x2≠ic_˝u_afföôy
 *
∑
)

116 
pxm
, 
node
;

117 
≠ic_id
;

119 i‡(
	`§©_dißbÀd
())

121 i‡(
∑
->
hódî
.
Àngth
 < (
a˝i_§©_x2≠ic_˝u_afföôy
)) {

122 
	`bad_§©
();

125 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

127 
pxm
 = 
∑
->
¥oximôy_domaö
;

128 
node
 = 
	`£tup_node
(
pxm
);

129 i‡(
node
 < 0) {

130 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

131 
	`bad_§©
();

135 
≠ic_id
 = 
∑
->apic_id;

136 
≠icid_to_node
[
≠ic_id
] = 
node
;

137 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

138 
a˝i_numa
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

140 
pxm
, 
≠ic_id
, 
node
);

141 
	}
}

144 
__öô


145 
	$a˝i_numa_¥o˚ss‹_afföôy_öô
(
a˝i_§©_˝u_afföôy
 *
∑
)

147 
pxm
, 
node
;

148 
≠ic_id
;

150 i‡(
	`§©_dißbÀd
())

152 i‡(
∑
->
hódî
.
Àngth
 !(
a˝i_§©_˝u_afföôy
)) {

153 
	`bad_§©
();

156 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

158 
pxm
 = 
∑
->
¥oximôy_domaö_lo
;

159 
node
 = 
	`£tup_node
(
pxm
);

160 i‡(
node
 < 0) {

161 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

162 
	`bad_§©
();

166 i‡(
	`gë_uv_sy°em_ty≥
(Ë>
UV_X2APIC
)

167 
≠ic_id
 = (
∑
->≠ic_id << 8Ë|Öa->
loˇl_ßpic_eid
;

169 
≠ic_id
 = 
∑
->apic_id;

170 
≠icid_to_node
[
≠ic_id
] = 
node
;

171 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

172 
a˝i_numa
 = 1;

173 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

174 
pxm
, 
≠ic_id
, 
node
);

175 
	}
}

177 #ifde‡
CONFIG_MEMORY_HOTPLUG_SPARSE


178 
ölöe
 
	$ßve_add_öfo
(Ë{ 1;
	}
}

180 
ölöe
 
	$ßve_add_öfo
(Ë{ 0;
	}
}

186 
__öô


187 
	$upd©e_nodes_add
(
node
, 
°¨t
, 
íd
)

189 
s_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

190 
e_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

191 
ch™ged
 = 0;

192 
boŸnode
 *
nd
 = &
nodes_add
[
node
];

200 i‡((sig√d )(
íd
 - 
°¨t
Ë< 
NODE_MIN_SIZE
) {

201 
	`¥ötk
(
KERN_ERR
 "SRAT: HotplugáreaÅoo small\n");

206 i‡(
	`ab£¡_∑ges_ö_ønge
(
s_p‚
, 
e_p‚
) !=É_pfn - s_pfn) {

207 
	`¥ötk
(
KERN_ERR


209 
s_p‚
, 
e_p‚
);

215 i‡(
nd
->
°¨t
 =nd->
íd
) {

216 
nd
->
°¨t
 = start;

217 
nd
->
íd
 =Énd;

218 
ch™ged
 = 1;

220 i‡(
nd
->
°¨t
 =
íd
) {

221 
nd
->
°¨t
 = start;

222 
ch™ged
 = 1;

224 i‡(
nd
->
íd
 =
°¨t
) {

225 
nd
->
íd
 =Énd;

226 
ch™ged
 = 1;

228 i‡(!
ch™ged
)

229 
	`¥ötk
(
KERN_ERR
 "SRAT: Hotplug zoneÇot continuous. Partly ignored\n");

232 i‡(
ch™ged
)

233 
	`¥ötk
(
KERN_INFO
 "SRAT: hotÖlug zone found %Lx - %Lx\n",

234 
nd
->
°¨t
,Çd->
íd
);

235 
	}
}

238 
__öô


239 
	$a˝i_numa_mem‹y_afföôy_öô
(
a˝i_§©_mem_afföôy
 *
ma
)

241 
boŸnode
 *
nd
, 
ﬁdnode
;

242 
°¨t
, 
íd
;

243 
node
, 
pxm
;

244 
i
;

246 i‡(
	`§©_dißbÀd
())

248 i‡(
ma
->
hódî
.
Àngth
 !(
a˝i_§©_mem_afföôy
)) {

249 
	`bad_§©
();

252 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

255 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
Ë&& !
	`ßve_add_öfo
())

257 
°¨t
 = 
ma
->
ba£_addªss
;

258 
íd
 = 
°¨t
 + 
ma
->
Àngth
;

259 
pxm
 = 
ma
->
¥oximôy_domaö
;

260 
node
 = 
	`£tup_node
(
pxm
);

261 i‡(
node
 < 0) {

262 
	`¥ötk
(
KERN_ERR
 "SRAT: Too manyÖroximity domains.\n");

263 
	`bad_§©
();

266 
i
 = 
	`c⁄Êi˘ög_memblks
(
°¨t
, 
íd
);

267 i‡(
i
 =
node
) {

268 
	`¥ötk
(
KERN_WARNING


270 
pxm
, 
°¨t
, 
íd
, 
nodes
[
i
].start,Çodes[i].end);

271 } i‡(
i
 >= 0) {

272 
	`¥ötk
(
KERN_ERR


274 
pxm
, 
°¨t
, 
íd
, 
	`node_to_pxm
(
i
),

275 
nodes
[
i
].
°¨t
,Çodes[i].
íd
);

276 
	`bad_§©
();

279 
nd
 = &
nodes
[
node
];

280 
ﬁdnode
 = *
nd
;

281 i‡(!
	`node_ã°_™d_£t
(
node
, 
nodes_∑r£d
)) {

282 
nd
->
°¨t
 = start;

283 
nd
->
íd
 =Énd;

285 i‡(
°¨t
 < 
nd
->start)

286 
nd
->
°¨t
 = start;

287 i‡(
nd
->
íd
 <Énd)

288 
nd
->
íd
 =Énd;

291 
	`¥ötk
(
KERN_INFO
 "SRAT: Nodê%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

292 
°¨t
, 
íd
);

293 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
node
, 
°¨t
 >> 
PAGE_SHIFT
,

294 
íd
 >> 
PAGE_SHIFT
);

296 i‡(
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) {

297 
	`upd©e_nodes_add
(
node
, 
°¨t
, 
íd
);

299 *
nd
 = 
ﬁdnode
;

300 i‡((
nd
->
°¨t
 |Çd->
íd
) == 0)

301 
	`node_˛ór
(
node
, 
nodes_∑r£d
);

304 
node_memblk_ønge
[
num_node_memblks
].
°¨t
 = start;

305 
node_memblk_ønge
[
num_node_memblks
].
íd
 =Énd;

306 
memblk_nodeid
[
num_node_memblks
] = 
node
;

307 
num_node_memblks
++;

308 
	}
}

312 
__öô
 
	$nodes_covî_mem‹y
(c⁄° 
boŸnode
 *
nodes
)

314 
i
;

315 
pxmøm
, 
e820øm
;

317 
pxmøm
 = 0;

318 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

319 
s
 = 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
;

320 
e
 = 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
;

321 
pxmøm
 +
e
 - 
s
;

322 
pxmøm
 -
	`ab£¡_∑ges_ö_ønge
(
s
, 
e
);

323 i‡(()
pxmøm
 < 0)

324 
pxmøm
 = 0;

327 
e820øm
 = 
max_p‚
 - (
	`e820_hﬁe_size
(0, max_p‚<<
PAGE_SHIFT
)>>PAGE_SHIFT);

329 i‡(()(
e820øm
 - 
pxmøm
Ë>(1<<(20 - 
PAGE_SHIFT
))) {

330 
	`¥ötk
(
KERN_ERR


332 (
pxmøm
 << 
PAGE_SHIFT
) >> 20,

333 (
e820øm
 << 
PAGE_SHIFT
) >> 20);

337 
	}
}

339 
__öô
 
	$a˝i_numa_¨ch_fixup
(Ë{
	}
}

342 
__öô
 
	$a˝i_sˇn_nodes
(
°¨t
, 
íd
)

344 
i
;

346 i‡(
a˝i_numa
 <= 0)

350 
i
 = 0; i < 
MAX_NUMNODES
; i++)

351 
	`cutoff_node
(
i
, 
°¨t
, 
íd
);

353 i‡(!
	`nodes_covî_mem‹y
(
nodes
)) {

354 
	`bad_§©
();

358 
memnode_shi·
 = 
	`compuã_hash_shi·
(
node_memblk_ønge
, 
num_node_memblks
,

359 
memblk_nodeid
);

360 i‡(
memnode_shi·
 < 0) {

361 
	`¥ötk
(
KERN_ERR


363 
	`bad_§©
();

368 
	`nodes_‹
(
node_possibÀ_m≠
, 
nodes_∑r£d
, 
˝u_nodes_∑r£d
);

371 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

372 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

375 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

376 i‡(!
	`node_⁄löe
(
i
))

377 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

379 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

380 
node
 = 
	`óæy_˝u_to_node
(
i
);

382 i‡(
node
 =
NUMA_NO_NODE
)

384 i‡(!
	`node_⁄löe
(
node
))

385 
	`numa_˛ór_node
(
i
);

387 
	`numa_öô_¨øy
();

389 
	}
}

391 #ifde‡
CONFIG_NUMA_EMU


392 
	gÁke_node_to_pxm_m≠
[
MAX_NUMNODES
] 
	g__öôd©a
 = {

393 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


395 
s16
 
	gÁke_≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__öôd©a
 = {

396 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


398 
__öô
 
	$föd_node_by_addr
(
addr
)

400 
ªt
 = 
NUMA_NO_NODE
;

401 
i
;

403 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

409 i‡(
addr
 >
nodes
[
i
].
°¨t
 &&ádd∏<Çodes[i].
íd
) {

410 
ªt
 = 
i
;

414  
ªt
;

415 
	}
}

425 
__öô
 
	$a˝i_Áke_nodes
(c⁄° 
boŸnode
 *
Áke_nodes
, 
num_nodes
)

427 
i
, 
j
;

429 
	`¥ötk
(
KERN_INFO
 "Faking PXMáffinity for fakeÇodes onÑeal "

431 
i
 = 0; i < 
num_nodes
; i++) {

432 
nid
, 
pxm
;

434 
nid
 = 
	`föd_node_by_addr
(
Áke_nodes
[
i
].
°¨t
);

435 i‡(
nid
 =
NUMA_NO_NODE
)

437 
pxm
 = 
	`node_to_pxm
(
nid
);

438 i‡(
pxm
 =
PXM_INVAL
)

440 
Áke_node_to_pxm_m≠
[
i
] = 
pxm
;

445 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

446 i‡(
≠icid_to_node
[
j
] =
nid
)

447 
Áke_≠icid_to_node
[
j
] = 
i
;

449 
i
 = 0; i < 
num_nodes
; i++)

450 
	`__a˝i_m≠_pxm_to_node
(
Áke_node_to_pxm_m≠
[
i
], i);

451 
	`mem˝y
(
≠icid_to_node
, 
Áke_≠icid_to_node
, (apicid_to_node));

453 
	`nodes_˛ór
(
nodes_∑r£d
);

454 
i
 = 0; i < 
num_nodes
; i++)

455 i‡(
Áke_nodes
[
i
].
°¨t
 !Áke_nodes[i].
íd
)

456 
	`node_£t
(
i
, 
nodes_∑r£d
);

457 
	`WARN_ON
(!
	`nodes_covî_mem‹y
(
Áke_nodes
));

458 
	}
}

460 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

462  
	`node_to_pxm
(
a
Ë=node_to_pxm(
b
);

463 
	}
}

465 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

467  
a
 =
b
;

468 
	}
}

471 
	$__node_di°™˚
(
a
, 
b
)

473 
ödex
;

475 i‡(!
a˝i_¶ô
)

476  
	`nuŒ_¶ô_node_com∑ª
(
a
, 
b
Ë? 
LOCAL_DISTANCE
 :

477 
REMOTE_DISTANCE
;

478 
ödex
 = 
a˝i_¶ô
->
loˇlôy_cou¡
 * 
	`node_to_pxm
(
a
);

479  
a˝i_¶ô
->
íåy
[
ödex
 + 
	`node_to_pxm
(
b
)];

480 
	}
}

482 
EXPORT_SYMBOL
(
__node_di°™˚
);

484 #i‡
deföed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
Ë|| deföed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

485 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

487 
i
, 
ªt
 = 0;

489 
	`f‹_óch_node
(
i
)

490 i‡(
nodes_add
[
i
].
°¨t
 <°¨à&&Çodes_add[i].
íd
 > start)

491 
ªt
 = 
i
;

493  
ªt
;

494 
	}
}

495 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<löux/öô.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/•ölock.h
>

5 
	~<löux/smp.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/moduÀ.h
>

9 
	~<asm/ébÊush.h
>

10 
	~<asm/mmu_c⁄ãxt.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/uv/uv.h
>

14 
DEFINE_PER_CPU_SHARED_ALIGNED
(
éb_°©e
, 
˝u_éb°©e
)

15 { &
öô_mm
, 0, };

39 
	usmp_Êush_°©e
 {

41 
mm_°ru˘
 *
	mÊush_mm
;

42 
	mÊush_va
;

43 
•ölock_t
 
	méb°©e_lock
;

44 
DECLARE_BITMAP
(
Êush_˝umask
, 
NR_CPUS
);

46 
	m∑d
[
CONFIG_X86_INTERNODE_CACHE_BYTES
];

47 } 
	g____ˇchñöe_öã∫odólig√d_ö_smp
;

52 
smp_Êush_°©e
 
	gÊush_°©e
[
NUM_INVALIDATE_TLB_VECTORS
];

58 
	$Àave_mm
(
˝u
)

60 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
)

61 
	`BUG
();

62 
	`˝umask_˛ór_˝u
(
˝u
,

63 
	`mm_˝umask
(
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)));

64 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

65 
	}
}

66 
EXPORT_SYMBOL_GPL
(
Àave_mm
);

123 #ifde‡
CONFIG_X86_64


124 
	gasmlökage


126 
	$smp_övÆid©e_öãºu±
(
±_ªgs
 *
ªgs
)

128 
˝u
;

129 
£ndî
;

130 
smp_Êush_°©e
 *
f
;

132 
˝u
 = 
	`smp_¥o˚ss‹_id
();

137 
£ndî
 = ~
ªgs
->
‹ig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

138 
f
 = &
Êush_°©e
[
£ndî
];

140 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
)))

141 
out
;

151 i‡(
f
->
Êush_mm
 =
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)) {

152 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
) {

153 i‡(
f
->
Êush_va
 =
TLB_FLUSH_ALL
)

154 
	`loˇl_Êush_éb
();

156 
	`__Êush_éb_⁄e
(
f
->
Êush_va
);

158 
	`Àave_mm
(
˝u
);

160 
out
:

161 
	`ack_APIC_úq
();

162 
	`smp_mb__bef‹e_˛ór_bô
();

163 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
));

164 
	`smp_mb__a·î_˛ór_bô
();

165 
	`öc_úq_°©
(
úq_éb_cou¡
);

166 
	}
}

168 
	$Êush_éb_Ÿhîs_ùi
(c⁄° 
˝umask
 *cpumask,

169 
mm_°ru˘
 *
mm
, 
va
)

171 
£ndî
;

172 
smp_Êush_°©e
 *
f
;

175 
£ndî
 = 
	`smp_¥o˚ss‹_id
(Ë% 
NUM_INVALIDATE_TLB_VECTORS
;

176 
f
 = &
Êush_°©e
[
£ndî
];

183 
	`•ö_lock
(&
f
->
éb°©e_lock
);

185 
f
->
Êush_mm
 = 
mm
;

186 
f
->
Êush_va
 = 
va
;

187 i‡(
	`˝umask_™dnŸ
(
	`to_˝umask
(
f
->
Êush_˝umask
), 
˝umask
, 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
()))) {

192 
≠ic
->
	`£nd_IPI_mask
(
	`to_˝umask
(
f
->
Êush_˝umask
),

193 
INVALIDATE_TLB_VECTOR_START
 + 
£ndî
);

195 !
	`˝umask_em±y
(
	`to_˝umask
(
f
->
Êush_˝umask
)))

196 
	`˝u_ªœx
();

199 
f
->
Êush_mm
 = 
NULL
;

200 
f
->
Êush_va
 = 0;

201 
	`•ö_u∆ock
(&
f
->
éb°©e_lock
);

202 
	}
}

204 
	$«tive_Êush_éb_Ÿhîs
(c⁄° 
˝umask
 *cpumask,

205 
mm_°ru˘
 *
mm
, 
va
)

207 i‡(
	`is_uv_sy°em
()) {

208 
˝u
;

210 
˝u
 = 
	`gë_˝u
();

211 
˝umask
 = 
	`uv_Êush_éb_Ÿhîs
(˝umask, 
mm
, 
va
, 
˝u
);

212 i‡(
˝umask
)

213 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

214 
	`put_˝u
();

217 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

218 
	}
}

220 
__˝uöô
 
	$öô_smp_Êush
()

222 
i
;

224 
i
 = 0; i < 
	`ARRAY_SIZE
(
Êush_°©e
); i++)

225 
	`•ö_lock_öô
(&
Êush_°©e
[
i
].
éb°©e_lock
);

228 
	}
}

229 
c‹e_öôˇŒ
(
öô_smp_Êush
);

231 
	$Êush_éb_cuºít_èsk
()

233 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

235 
	`¥ìm±_dißbÀ
();

237 
	`loˇl_Êush_éb
();

238 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

239 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

240 
	`¥ìm±_íabÀ
();

241 
	}
}

243 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

245 
	`¥ìm±_dißbÀ
();

247 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

248 i‡(
cuºít
->
mm
)

249 
	`loˇl_Êush_éb
();

251 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

253 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

254 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

256 
	`¥ìm±_íabÀ
();

257 
	}
}

259 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
va
)

261 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

263 
	`¥ìm±_dißbÀ
();

265 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

266 i‡(
cuºít
->
mm
)

267 
	`__Êush_éb_⁄e
(
va
);

269 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

272 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

273 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
va
);

275 
	`¥ìm±_íabÀ
();

276 
	}
}

278 
	$do_Êush_éb_Æl
(*
öfo
)

280 
˝u
 = 
	`smp_¥o˚ss‹_id
();

282 
	`__Êush_éb_Æl
();

283 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_LAZY
)

284 
	`Àave_mm
(
˝u
);

285 
	}
}

287 
	$Êush_éb_Æl
()

289 
	`⁄_óch_˝u
(
do_Êush_éb_Æl
, 
NULL
, 1);

290 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<löux/kî√l.h
>

16 
	~<löux/posix-timîs.h
>

17 
	~<löux/time.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/vsysˇŒ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/uni°d.h
>

24 
	~<asm/io.h
>

25 
	~"vexã∫.h
"

27 
	#gtod
 
vdso_vsysˇŒ_gtod_d©a


	)

29 
nŸø˚
 
	$vdso_ÁŒback_gëtime
(
˛ock
, 
time•ec
 *
ts
)

31 
ªt
;

32 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

33 "0" (
__NR_˛ock_gëtime
),"D" (
˛ock
), "S" (
ts
) : "memory");

34  
ªt
;

35 
	}
}

37 
nŸø˚
 
ölöe
 
	$vgëns
()

39 
v
;

40 
	`cy˛es_t
 (*
vªad
)();

41 
vªad
 = 
gtod
->
˛ock
.vread;

42 
v
 = (
	`vªad
(Ë- 
gtod
->
˛ock
.
cy˛e_œ°
Ë& gtod->˛ock.
mask
;

43  (
v
 * 
gtod
->
˛ock
.
mu…
Ë>> gtod->˛ock.
shi·
;

44 
	}
}

46 
nŸø˚
 
noölöe
 
	$do_ªÆtime
(
time•ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_n£c
;

53 
ns
 = 
	`vgëns
();

54 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

55 
	`time•ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nŸø˚
 

61 
	$v£t_n‹mÆized_time•ec
(
time•ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >
NSEC_PER_SEC
) {

64 
n£c
 -
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic
(
time•ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
wÆl_time_£c
;

81 
ns
 = 
gtod
->
wÆl_time_n£c
 + 
	`vgëns
();

82 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

83 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

84 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nŸø˚
 
noölöe
 
	$do_ªÆtime_cﬂr£
(
time•ec
 *
ts
)

91 
£q
;

93 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

94 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_sec;

95 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_nsec;

96 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

98 
	}
}

100 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic_cﬂr£
(
time•ec
 *
ts
)

102 
£q
, 
ns
, 
£cs
;

104 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

105 
£cs
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_£c
;

106 
ns
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_n£c
;

107 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

108 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

109 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

110 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

112 
	}
}

114 
nŸø˚
 
	$__vdso_˛ock_gëtime
(
˛ockid_t
 
˛ock
, 
time•ec
 *
ts
)

116 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
))

117 
˛ock
) {

118 
CLOCK_REALTIME
:

119 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

120  
	`do_ªÆtime
(
ts
);

122 
CLOCK_MONOTONIC
:

123 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

124  
	`do_m⁄Ÿ⁄ic
(
ts
);

126 
CLOCK_REALTIME_COARSE
:

127  
	`do_ªÆtime_cﬂr£
(
ts
);

128 
CLOCK_MONOTONIC_COARSE
:

129  
	`do_m⁄Ÿ⁄ic_cﬂr£
(
ts
);

131  
	`vdso_ÁŒback_gëtime
(
˛ock
, 
ts
);

132 
	}
}

133 
	$˛ock_gëtime
(
˛ockid_t
, 
time•ec
 *)

134 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_clock_gettime")));

136 
nŸø˚
 
	$__vdso_gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

138 
ªt
;

139 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
)) {

140 i‡(
	`likñy
(
tv
 !
NULL
)) {

141 
	`BUILD_BUG_ON
(
	`off£tof
(
timevÆ
, 
tv_u£c
) !=

142 
	`off£tof
(
time•ec
, 
tv_n£c
) ||

143 (*
tv
Ë!(
time•ec
));

144 
	`do_ªÆtime
((
time•ec
 *)
tv
);

145 
tv
->
tv_u£c
 /= 1000;

147 i‡(
	`u∆ikñy
(
tz
 !
NULL
)) {

149 
tz
->
tz_möuãswe°
 = 
gtod
->
sys_tz
.tz_minuteswest;

150 
tz
->
tz_d°time
 = 
gtod
->
sys_tz
.tz_dsttime;

154 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

155 "0" (
__NR_gëtimeofday
), "D" (
tv
), "S" (
tz
) : "memory");

156  
ªt
;

157 
	}
}

158 
	$gëtimeofday
(
timevÆ
 *, 
timez⁄e
 *)

159 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/gë˝u.h
>

10 
	~<löux/jiffõs.h
>

11 
	~<löux/time.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vexã∫.h
"

16 
nŸø˚
 

17 
	$__vdso_gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
unu£d
)

19 
p
;

21 i‡(*
vdso_vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

23 
	`«tive_ªad_ts˝
(&
p
);

26 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

28 i‡(
˝u
)

29 *
˝u
 = 
p
 & 0xfff;

30 i‡(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

36 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<löux/mm.h
>

7 
	~<löux/îr.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/øndom.h
>

11 
	~<löux/ñf.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~<asm/¥Ÿo.h
>

15 
	~<asm/vdso.h
>

17 
	~"vexã∫.h
"

18 #unde‡
VEXTERN


20 
__ªad_mo°ly
 
	gvdso_íabÀd
 = 1;

22 
vdso_°¨t
[], 
vdso_íd
[];

23 
vdso_sync_˝uid
;

25 
∑ge
 **
	gvdso_∑ges
;

26 
	gvdso_size
;

28 
ölöe
 *
	$v¨_ªf
(*
p
, *
«me
)

30 i‡(*(**)
p
 !(*)
VMAGIC
) {

31 
	`¥ötk
("VDSO: v¨übÀ %†brokí\n", 
«me
);

32 
vdso_íabÀd
 = 0;

34  
p
;

35 
	}
}

37 
__öô
 
	$öô_vdso_v¨s
()

39 
≈ages
 = (
vdso_íd
 - 
vdso_°¨t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

40 
i
;

41 *
vba£
;

43 
vdso_size
 = 
≈ages
 << 
PAGE_SHIFT
;

44 
vdso_∑ges
 = 
	`kmÆloc
((
∑ge
 *Ë* 
≈ages
, 
GFP_KERNEL
);

45 i‡(!
vdso_∑ges
)

46 
oom
;

47 
i
 = 0; i < 
≈ages
; i++) {

48 
∑ge
 *
p
;

49 
p
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

50 i‡(!
p
)

51 
oom
;

52 
vdso_∑ges
[
i
] = 
p
;

53 
	`c›y_∑ge
(
	`∑ge_addªss
(
p
), 
vdso_°¨t
 + 
i
*
PAGE_SIZE
);

56 
vba£
 = 
	`vm≠
(
vdso_∑ges
, 
≈ages
, 0, 
PAGE_KERNEL
);

57 i‡(!
vba£
)

58 
oom
;

60 i‡(
	`memcmp
(
vba£
, "\177ELF", 4)) {

61 
	`¥ötk
("VDSO: I'm broken;Çot ELF\n");

62 
vdso_íabÀd
 = 0;

65 
	#VEXTERN
(
x
) \

66 *(
	`ty≥of
(
__
 ## 
x
Ë**Ë
	`v¨_ªf
(
	`VDSO64_SYMBOL
(
vba£
, x), #xË&__ ## x;

	)

67 
	~"vexã∫.h
"

68 #unde‡
VEXTERN


71 
oom
:

72 
	`¥ötk
("Cannotállocate vdso\n");

73 
vdso_íabÀd
 = 0;

74  -
ENOMEM
;

75 
	}
}

76 
__öôˇŒ
(
öô_vdso_v¨s
);

78 
	glöux_bö¥m
;

84 
	$vdso_addr
(
°¨t
, 
Àn
)

86 
addr
, 
íd
;

87 
off£t
;

88 
íd
 = (
°¨t
 + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

89 i‡(
íd
 >
TASK_SIZE_MAX
)

90 
íd
 = 
TASK_SIZE_MAX
;

91 
íd
 -
Àn
;

93 
off£t
 = 
	`gë_øndom_öt
(Ë& (
PTRS_PER_PTE
 - 1);

94 
addr
 = 
°¨t
 + (
off£t
 << 
PAGE_SHIFT
);

95 i‡(
addr
 >
íd
)

96 
addr
 = 
íd
;

97  
addr
;

98 
	}
}

102 
	$¨ch_£tup_addôi⁄Æ_∑ges
(
löux_bö¥m
 *
b¥m
, 
u£s_öãΩ
)

104 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

105 
addr
;

106 
ªt
;

108 i‡(!
vdso_íabÀd
)

111 
	`down_wrôe
(&
mm
->
mm≠_£m
);

112 
addr
 = 
	`vdso_addr
(
mm
->
°¨t_°ack
, 
vdso_size
);

113 
addr
 = 
	`gë_unm≠≥d_¨ó
(
NULL
,áddr, 
vdso_size
, 0, 0);

114 i‡(
	`IS_ERR_VALUE
(
addr
)) {

115 
ªt
 = 
addr
;

116 
up_Áû
;

119 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = (*)
addr
;

121 
ªt
 = 
	`ö°Æl_•ecül_m≠pög
(
mm
, 
addr
, 
vdso_size
,

122 
VM_READ
|
VM_EXEC
|

123 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

124 
VM_ALWAYSDUMP
,

125 
vdso_∑ges
);

126 i‡(
ªt
) {

127 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = 
NULL
;

128 
up_Áû
;

131 
up_Áû
:

132 
	`up_wrôe
(&
mm
->
mm≠_£m
);

133  
ªt
;

134 
	}
}

136 
__öô
 
	$vdso_£tup
(*
s
)

138 
vdso_íabÀd
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

140 
	}
}

141 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/time.h
>

7 
	~<asm/vsysˇŒ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
Ë
	`ty≥of
 (
__
 ## xË*c⁄° 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vexã∫.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<löux/jiffõs.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/smp.h
>

13 
	gÕj_föe
;

14 
	g¥e£t_Õj
;

15 
__öô
 
	$Õj_£tup
(*
°r
)

17 
¥e£t_Õj
 = 
	`sim∂e_°πoul
(
°r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Õj=", 
Õj_£tup
);

23 #ifde‡
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100Ë? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
()

35 
¥e_°¨t
, 
°¨t
, 
po°_°¨t
;

36 
¥e_íd
, 
íd
, 
po°_íd
;

37 
°¨t_jiffõs
;

38 
timî_øã_mö
, 
timî_øã_max
;

39 
good_timî_sum
 = 0;

40 
good_timî_cou¡
 = 0;

41 
i
;

43 i‡(
	`ªad_cuºít_timî
(&
¥e_°¨t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
¥e_°¨t
 = 0;

67 
	`ªad_cuºít_timî
(&
°¨t
);

68 
°¨t_jiffõs
 = 
jiffõs
;

69 
jiffõs
 <(
°¨t_jiffõs
 + 1)) {

70 
¥e_°¨t
 = 
°¨t
;

71 
	`ªad_cuºít_timî
(&
°¨t
);

73 
	`ªad_cuºít_timî
(&
po°_°¨t
);

75 
¥e_íd
 = 0;

76 
íd
 = 
po°_°¨t
;

77 
jiffõs
 <=

78 (
°¨t_jiffõs
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
¥e_íd
 = 
íd
;

80 
	`ªad_cuºít_timî
(&
íd
);

82 
	`ªad_cuºít_timî
(&
po°_íd
);

84 
timî_øã_max
 = (
po°_íd
 - 
¥e_°¨t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
timî_øã_mö
 = (
¥e_íd
 - 
po°_°¨t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 i‡(
¥e_°¨t
 !0 && 
¥e_íd
 != 0 &&

94 (
timî_øã_max
 - 
timî_øã_mö
) < (timer_rate_max >> 3)) {

95 
good_timî_cou¡
++;

96 
good_timî_sum
 +
timî_øã_max
;

100 i‡(
good_timî_cou¡
)

101  (
good_timî_sum
/
good_timî_cou¡
);

103 
	`¥ötk
(
KERN_WARNING
 "calibrate_delay_direct() failedÅo getá good "

106 
	}
}

108 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
(Ë{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__˝uöô
 
	$ˇlibøã_dñay
()

124 
ticks
, 
lo›bô
;

125 
Õs_¥ecisi⁄
 = 
LPS_PREC
;

127 i‡(
¥e£t_Õj
) {

128 
lo›s_≥r_jiffy
 = 
¥e£t_Õj
;

129 
	`¥ötk
(
KERN_INFO


131 } i‡((
	`smp_¥o˚ss‹_id
(Ë=0Ë&& 
Õj_föe
) {

132 
lo›s_≥r_jiffy
 = 
Õj_föe
;

133 
	`¥ötk
(
KERN_INFO


136 } i‡((
lo›s_≥r_jiffy
 = 
	`ˇlibøã_dñay_dúe˘
()) != 0) {

137 
	`¥ötk
(
KERN_INFO


140 
lo›s_≥r_jiffy
 = (1<<12);

142 
	`¥ötk
(
KERN_INFO
 "Calibrating delayÜoop... ");

143 (
lo›s_≥r_jiffy
 <<= 1) != 0) {

145 
ticks
 = 
jiffõs
;

146 
ticks
 =
jiffõs
)

149 
ticks
 = 
jiffõs
;

150 
	`__dñay
(
lo›s_≥r_jiffy
);

151 
ticks
 = 
jiffõs
 -Åicks;

152 i‡(
ticks
)

160 
lo›s_≥r_jiffy
 >>= 1;

161 
lo›bô
 = 
lo›s_≥r_jiffy
;

162 
Õs_¥ecisi⁄
-- && (
lo›bô
 >>= 1)) {

163 
lo›s_≥r_jiffy
 |
lo›bô
;

164 
ticks
 = 
jiffõs
;

165 
ticks
 =
jiffõs
)

167 
ticks
 = 
jiffõs
;

168 
	`__dñay
(
lo›s_≥r_jiffy
);

169 i‡(
jiffõs
 !
ticks
)

170 
lo›s_≥r_jiffy
 &~
lo›bô
;

173 
	`¥ötk
(
KERN_CONT
 "%lu.%02lu BogoMIPS (lpj=%lu)\n",

174 
lo›s_≥r_jiffy
/(500000/
HZ
),

175 (
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100,Üoops_per_jiffy);

176 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/˘y≥.h
>

4 
	~<löux/fd.h
>

5 
	~<löux/ây.h
>

6 
	~<löux/su•íd.h
>

7 
	~<löux/roŸ_dev.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/gíhd.h
>

11 
	~<löux/mou¡.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/öôrd.h
>

16 
	~<löux/async.h
>

17 
	~<löux/fs_°ru˘.h
>

19 
	~<löux/nfs_fs.h
>

20 
	~<löux/nfs_fs_sb.h
>

21 
	~<löux/nfs_mou¡.h
>

23 
	~"do_mou¡s.h
"

25 
__öôd©a
 
	grd_dﬁﬂd
;

27 
	groŸ_mou¡Êags
 = 
MS_RDONLY
 | 
MS_SILENT
;

28 * 
__öôd©a
 
	groŸ_devi˚_«me
;

29 
__öôd©a
 
	gßved_roŸ_«me
[64];

30 
__öôd©a
 
	groŸ_waô
;

32 
dev_t
 
	gROOT_DEV
;

34 
__öô
 
	$lﬂd_ømdisk
(*
°r
)

36 
rd_dﬁﬂd
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 3;

38 
	}
}

39 
__£tup
("lﬂd_ømdisk=", 
lﬂd_ømdisk
);

41 
__öô
 
	$ªad⁄ly
(*
°r
)

43 i‡(*
°r
)

45 
roŸ_mou¡Êags
 |
MS_RDONLY
;

47 
	}
}

49 
__öô
 
	$ªadwrôe
(*
°r
)

51 i‡(*
°r
)

53 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

55 
	}
}

57 
__£tup
("ro", 
ªad⁄ly
);

58 
__£tup
("rw", 
ªadwrôe
);

77 
dev_t
 
	$«me_to_dev_t
(*
«me
)

79 
s
[32];

80 *
p
;

81 
dev_t
 
ªs
 = 0;

82 
∑π
;

84 i‡(
	`°∫cmp
(
«me
, "/dev/", 5) != 0) {

85 
maj
, 
mö
;

87 i‡(
	`ssˇnf
(
«me
, "%u:%u", &
maj
, &
mö
) == 2) {

88 
ªs
 = 
	`MKDEV
(
maj
, 
mö
);

89 i‡(
maj
 !
	`MAJOR
(
ªs
Ë|| 
mö
 !
	`MINOR
(res))

90 
Áû
;

92 
ªs
 = 
	`√w_decode_dev
(
	`sim∂e_°πoul
(
«me
, &
p
, 16));

93 i‡(*
p
)

94 
Áû
;

96 
d⁄e
;

99 
«me
 += 5;

100 
ªs
 = 
RoŸ_NFS
;

101 i‡(
	`°rcmp
(
«me
, "nfs") == 0)

102 
d⁄e
;

103 
ªs
 = 
RoŸ_RAM0
;

104 i‡(
	`°rcmp
(
«me
, "ram") == 0)

105 
d⁄e
;

107 i‡(
	`°æí
(
«me
) > 31)

108 
Áû
;

109 
	`°r˝y
(
s
, 
«me
);

110 
p
 = 
s
; *p;Ö++)

111 i‡(*
p
 == '/')

112 *
p
 = '!';

113 
ªs
 = 
	`blk_lookup_devt
(
s
, 0);

114 i‡(
ªs
)

115 
d⁄e
;

121 
p
 > 
s
 && 
	`isdigô
(p[-1]))

122 
p
--;

123 i‡(
p
 =
s
 || !*p || *p == '0')

124 
Áû
;

127 
∑π
 = 
	`sim∂e_°πoul
(
p
, 
NULL
, 10);

128 *
p
 = '\0';

129 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

130 i‡(
ªs
)

131 
d⁄e
;

134 i‡(
p
 < 
s
 + 2 || !
	`isdigô
(p[-2]) ||Ö[-1] != 'p')

135 
Áû
;

136 
p
[-1] = '\0';

137 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

138 i‡(
ªs
)

139 
d⁄e
;

141 
Áû
:

143 
d⁄e
:

144  
ªs
;

145 
	}
}

147 
__öô
 
	$roŸ_dev_£tup
(*
löe
)

149 
	`°æ˝y
(
ßved_roŸ_«me
, 
löe
, (saved_root_name));

151 
	}
}

153 
__£tup
("roŸ=", 
roŸ_dev_£tup
);

155 
__öô
 
	$roŸwaô_£tup
(*
°r
)

157 i‡(*
°r
)

159 
roŸ_waô
 = 1;

161 
	}
}

163 
__£tup
("roŸwaô", 
roŸwaô_£tup
);

165 * 
__öôd©a
 
	groŸ_mou¡_d©a
;

166 
__öô
 
	$roŸ_d©a_£tup
(*
°r
)

168 
roŸ_mou¡_d©a
 = 
°r
;

170 
	}
}

172 * 
__öôd©a
 
	groŸ_fs_«mes
;

173 
__öô
 
	$fs_«mes_£tup
(*
°r
)

175 
roŸ_fs_«mes
 = 
°r
;

177 
	}
}

179 
__öôd©a
 
	groŸ_dñay
;

180 
__öô
 
	$roŸ_dñay_£tup
(*
°r
)

182 
roŸ_dñay
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 0);

184 
	}
}

186 
__£tup
("roŸÊags=", 
roŸ_d©a_£tup
);

187 
__£tup
("roŸf°y≥=", 
fs_«mes_£tup
);

188 
__£tup
("roŸdñay=", 
roŸ_dñay_£tup
);

190 
__öô
 
	$gë_fs_«mes
(*
∑ge
)

192 *
s
 = 
∑ge
;

194 i‡(
roŸ_fs_«mes
) {

195 
	`°r˝y
(
∑ge
, 
roŸ_fs_«mes
);

196 *
s
++) {

197 i‡(
s
[-1] == ',')

198 
s
[-1] = '\0';

201 
Àn
 = 
	`gë_fûesy°em_li°
(
∑ge
);

202 *
p
, *
√xt
;

204 
∑ge
[
Àn
] = '\0';

205 
p
 = 
∑ge
-1;Ö;Ö = 
√xt
) {

206 
√xt
 = 
	`°rchr
(++
p
, '\n');

207 i‡(*
p
++ != '\t')

209 (*
s
++ = *
p
++) != '\n')

211 
s
[-1] = '\0';

214 *
s
 = '\0';

215 
	}
}

217 
__öô
 
	$do_mou¡_roŸ
(*
«me
, *
fs
, 
Êags
, *
d©a
)

219 
îr
 = 
	`sys_mou¡
(
«me
, "/roŸ", 
fs
, 
Êags
, 
d©a
);

220 i‡(
îr
)

221  
îr
;

223 
	`sys_chdú
("/root");

224 
ROOT_DEV
 = 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_dev
;

225 
	`¥ötk
("VFS: MountedÑoot (%s filesystem)%s on device %u:%u.\n",

226 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_ty≥
->
«me
,

227 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_Êags
 & 
MS_RDONLY
 ?

228 "Ñód⁄ly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

230 
	}
}

232 
__öô
 
	$mou¡_block_roŸ
(*
«me
, 
Êags
)

234 *
fs_«mes
 = 
	`__gë«me_gÂ
(
GFP_KERNEL


235 | 
__GFP_NOTRACK_FALSE_POSITIVE
);

236 *
p
;

237 #ifde‡
CONFIG_BLOCK


238 
b
[
BDEVNAME_SIZE
];

240 c⁄° *
b
 = 
«me
;

243 
	`gë_fs_«mes
(
fs_«mes
);

244 
ªåy
:

245 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1) {

246 
îr
 = 
	`do_mou¡_roŸ
(
«me
, 
p
, 
Êags
, 
roŸ_mou¡_d©a
);

247 
îr
) {

249 
out
;

250 -
EACCES
:

251 
Êags
 |
MS_RDONLY
;

252 
ªåy
;

253 -
EINVAL
:

261 #ifde‡
CONFIG_BLOCK


262 
	`__bdev«me
(
ROOT_DEV
, 
b
);

264 
	`¥ötk
("VFS: Cannot openÑoot device \"%s\" or %s\n",

265 
roŸ_devi˚_«me
, 
b
);

266 
	`¥ötk
("Pleaseáppendá correct \"root=\" boot option; hereáreÅheávailableÖartitions:\n");

268 
	`¥ötk_Æl_∑πôi⁄s
();

269 #ifde‡
CONFIG_DEBUG_BLOCK_EXT_DEVT


270 
	`¥ötk
("DEBUG_BLOCK_EXT_DEVT isÉnabled, youÇeedÅo specify "

273 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

276 
	`¥ötk
("List ofállÖartitions:\n");

277 
	`¥ötk_Æl_∑πôi⁄s
();

278 
	`¥ötk
("No filesystem could mountÑoot,Åried: ");

279 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1)

280 
	`¥ötk
(" %s", 
p
);

281 
	`¥ötk
("\n");

282 #ifde‡
CONFIG_BLOCK


283 
	`__bdev«me
(
ROOT_DEV
, 
b
);

285 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

286 
out
:

287 
	`puäame
(
fs_«mes
);

288 
	}
}

290 #ifde‡
CONFIG_ROOT_NFS


291 
__öô
 
	$mou¡_nfs_roŸ
()

293 *
d©a
 = 
	`nfs_roŸ_d©a
();

295 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

296 i‡(
d©a
 &&

297 
	`do_mou¡_roŸ
("/dev/roŸ", "nfs", 
roŸ_mou¡Êags
, 
d©a
) == 0)

300 
	}
}

303 #i‡
deföed
(
CONFIG_BLK_DEV_RAM
Ë|| deföed(
CONFIG_BLK_DEV_FD
)

304 
__öô
 
	$ch™ge_Ê›py
(*
fmt
, ...)

306 
ãrmios
Åermios;

307 
buf
[80];

308 
c
;

309 
fd
;

310 
va_li°
 
¨gs
;

311 
	`va_°¨t
(
¨gs
, 
fmt
);

312 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

313 
	`va_íd
(
¨gs
);

314 
fd
 = 
	`sys_›í
("/dev/roŸ", 
O_RDWR
 | 
O_NDELAY
, 0);

315 i‡(
fd
 >= 0) {

316 
	`sys_io˘l
(
fd
, 
FDEJECT
, 0);

317 
	`sys_˛o£
(
fd
);

319 
	`¥ötk
(
KERN_NOTICE
 "VFS: In£π %†™dÖªs†ENTER\n", 
buf
);

320 
fd
 = 
	`sys_›í
("/dev/c⁄sﬁe", 
O_RDWR
, 0);

321 i‡(
fd
 >= 0) {

322 
	`sys_io˘l
(
fd
, 
TCGETS
, ()&
ãrmios
);

323 
ãrmios
.
c_lÊag
 &~
ICANON
;

324 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

325 
	`sys_ªad
(
fd
, &
c
, 1);

326 
ãrmios
.
c_lÊag
 |
ICANON
;

327 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

328 
	`sys_˛o£
(
fd
);

330 
	}
}

333 
__öô
 
	$mou¡_roŸ
()

335 #ifde‡
CONFIG_ROOT_NFS


336 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
UNNAMED_MAJOR
) {

337 i‡(
	`mou¡_nfs_roŸ
())

340 
	`¥ötk
(
KERN_ERR
 "VFS: UnableÅo mountÑoot fs via NFS,Årying floppy.\n");

341 
ROOT_DEV
 = 
RoŸ_FD0
;

344 #ifde‡
CONFIG_BLK_DEV_FD


345 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
) {

347 i‡(
rd_dﬁﬂd
==2) {

348 i‡(
	`rd_lﬂd_disk
(1)) {

349 
ROOT_DEV
 = 
RoŸ_RAM1
;

350 
roŸ_devi˚_«me
 = 
NULL
;

353 
	`ch™ge_Ê›py
("root floppy");

356 #ifde‡
CONFIG_BLOCK


357 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

358 
	`mou¡_block_roŸ
("/dev/roŸ", 
roŸ_mou¡Êags
);

360 
	}
}

365 
__öô
 
	$¥ï¨e_«me•a˚
()

367 
is_Ê›py
;

369 i‡(
roŸ_dñay
) {

370 
	`¥ötk
(
KERN_INFO
 "Waiting %dsec before mountingÑoot device...\n",

371 
roŸ_dñay
);

372 
	`s¶ìp
(
roŸ_dñay
);

382 
	`waô_f‹_devi˚_¥obe
();

384 
	`md_run_£tup
();

386 i‡(
ßved_roŸ_«me
[0]) {

387 
roŸ_devi˚_«me
 = 
ßved_roŸ_«me
;

388 i‡(!
	`°∫cmp
(
roŸ_devi˚_«me
, "mtd", 3) ||

389 !
	`°∫cmp
(
roŸ_devi˚_«me
, "ubi", 3)) {

390 
	`mou¡_block_roŸ
(
roŸ_devi˚_«me
, 
roŸ_mou¡Êags
);

391 
out
;

393 
ROOT_DEV
 = 
	`«me_to_dev_t
(
roŸ_devi˚_«me
);

394 i‡(
	`°∫cmp
(
roŸ_devi˚_«me
, "/dev/", 5) == 0)

395 
roŸ_devi˚_«me
 += 5;

398 i‡(
	`öôrd_lﬂd
())

399 
out
;

402 i‡((
ROOT_DEV
 =0Ë&& 
roŸ_waô
) {

403 
	`¥ötk
(
KERN_INFO
 "Waiting forÑoot device %s...\n",

404 
ßved_roŸ_«me
);

405 
	`drivî_¥obe_d⁄e
() != 0 ||

406 (
ROOT_DEV
 = 
	`«me_to_dev_t
(
ßved_roŸ_«me
)) == 0)

407 
	`m¶ìp
(100);

408 
	`async_synchr⁄ize_fuŒ
();

411 
is_Ê›py
 = 
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
;

413 i‡(
is_Ê›py
 && 
rd_dﬁﬂd
 && 
	`rd_lﬂd_disk
(0))

414 
ROOT_DEV
 = 
RoŸ_RAM0
;

416 
	`mou¡_roŸ
();

417 
out
:

418 
	`devtmpfs_mou¡
("dev");

419 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

420 
	`sys_chroŸ
(".");

421 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<löux/uni°d.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/öôrd.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/‰ìzî.h
>

11 
	~"do_mou¡s.h
"

13 
	göôrd_°¨t
, 
	göôrd_íd
;

14 
	göôrd_bñow_°¨t_ok
;

15 
	gªÆ_roŸ_dev
;

16 
__öôd©a
 
	gﬁd_fd
, 
	groŸ_fd
;

17 
__öôd©a
 
	gmou¡_öôrd
 = 1;

19 
__öô
 
	$no_öôrd
(*
°r
)

21 
mou¡_öôrd
 = 0;

23 
	}
}

25 
__£tup
("noöôrd", 
no_öôrd
);

27 
__öô
 
	$do_löuxrc
(* 
shñl
)

29 *
¨gv
[] = { "löuxrc", 
NULL
, };

30 * 
ívp_öô
[];

32 
	`sys_˛o£
(
ﬁd_fd
);sys_˛o£(
roŸ_fd
);

33 
	`sys_˛o£
(0);sys_close(1);sys_close(2);

34 
	`sys_£tsid
();

35 (Ë
	`sys_›í
("/dev/c⁄sﬁe",
O_RDWR
,0);

36 (Ë
	`sys_dup
(0);

37 (Ë
	`sys_dup
(0);

38  
	`kî√l_execve
(
shñl
, 
¨gv
, 
ívp_öô
);

39 
	}
}

41 
__öô
 
	$h™dÀ_öôrd
()

43 
îr‹
;

44 
pid
;

46 
ªÆ_roŸ_dev
 = 
	`√w_ícode_dev
(
ROOT_DEV
);

47 
	`¸óã_dev
("/dev/roŸ.ﬁd", 
RoŸ_RAM0
);

49 
	`mou¡_block_roŸ
("/dev/roŸ.ﬁd", 
roŸ_mou¡Êags
 & ~
MS_RDONLY
);

50 
	`sys_mkdú
("/old", 0700);

51 
roŸ_fd
 = 
	`sys_›í
("/", 0, 0);

52 
ﬁd_fd
 = 
	`sys_›í
("/old", 0, 0);

54 
	`sys_chdú
("/root");

55 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

56 
	`sys_chroŸ
(".");

62 
cuºít
->
Êags
 |
PF_FREEZER_SKIP
;

64 
pid
 = 
	`kî√l_thªad
(
do_löuxrc
, "/löuxrc", 
SIGCHLD
);

65 i‡(
pid
 > 0)

66 
pid
 !
	`sys_waô4
(-1, 
NULL
, 0, NULL))

67 
	`yõld
();

69 
cuºít
->
Êags
 &~
PF_FREEZER_SKIP
;

72 
	`sys_fchdú
(
ﬁd_fd
);

73 
	`sys_mou¡
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

75 
	`sys_fchdú
(
roŸ_fd
);

76 
	`sys_chroŸ
(".");

77 
	`sys_˛o£
(
ﬁd_fd
);

78 
	`sys_˛o£
(
roŸ_fd
);

80 i‡(
	`√w_decode_dev
(
ªÆ_roŸ_dev
Ë=
RoŸ_RAM0
) {

81 
	`sys_chdú
("/old");

85 
ROOT_DEV
 = 
	`√w_decode_dev
(
ªÆ_roŸ_dev
);

86 
	`mou¡_roŸ
();

88 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo move oldÑootÅo /initrd ... ");

89 
îr‹
 = 
	`sys_mou¡
("/ﬁd", "/roŸ/öôrd", 
NULL
, 
MS_MOVE
, NULL);

90 i‡(!
îr‹
)

91 
	`¥ötk
("okay\n");

93 
fd
 = 
	`sys_›í
("/dev/roŸ.ﬁd", 
O_RDWR
, 0);

94 i‡(
îr‹
 =-
ENOENT
)

95 
	`¥ötk
("/initrd doesÇotÉxist. Ignored.\n");

97 
	`¥ötk
("failed\n");

98 
	`¥ötk
(
KERN_NOTICE
 "Unmounting oldÑoot\n");

99 
	`sys_umou¡
("/ﬁd", 
MNT_DETACH
);

100 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo freeÑamdisk memory ... ");

101 i‡(
fd
 < 0) {

102 
îr‹
 = 
fd
;

104 
îr‹
 = 
	`sys_io˘l
(
fd
, 
BLKFLSBUF
, 0);

105 
	`sys_˛o£
(
fd
);

107 
	`¥ötk
(!
îr‹
 ? "okay\n" : "failed\n");

109 
	}
}

111 
__öô
 
	$öôrd_lﬂd
()

113 i‡(
mou¡_öôrd
) {

114 
	`¸óã_dev
("/dev/øm", 
RoŸ_RAM0
);

121 i‡(
	`rd_lﬂd_image
("/öôrd.image"Ë&& 
ROOT_DEV
 !
RoŸ_RAM0
) {

122 
	`sys_u∆ök
("/initrd.image");

123 
	`h™dÀ_öôrd
();

127 
	`sys_u∆ök
("/initrd.image");

129 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<löux/dñay.h
>

2 
	~<löux/øid/md_u.h
>

3 
	~<löux/øid/md_p.h
>

5 
	~"do_mou¡s.h
"

16 #ifde‡
CONFIG_MD_AUTODETECT


17 
__öôd©a
 
	gøid_nﬂutodëe˘
;

19 
__öôd©a
 
	gøid_nﬂutodëe˘
=1;

21 
__öôd©a
 
	gøid_aut›¨t
;

24 
	mmö‹
;

25 
	m∑πôi⁄ed
;

26 
	mÀvñ
;

27 
	mchunk
;

28 *
	mdevi˚_«mes
;

29 } 
	gmd_£tup_¨gs
[256] 
	g__öôd©a
;

31 
md_£tup_íts
 
	g__öôd©a
;

53 
__öô
 
	$md_£tup
(*
°r
)

55 
mö‹
, 
Àvñ
, 
Á˘‹
, 
Áu…
, 
∑πôi⁄ed
 = 0;

56 *
≥∫ame
 = "";

57 *
°r1
;

58 
ít
;

60 i‡(*
°r
 == 'd') {

61 
∑πôi⁄ed
 = 1;

62 
°r
++;

64 i‡(
	`gë_›ti⁄
(&
°r
, &
mö‹
) != 2) {

65 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

68 
°r1
 = 
°r
;

69 
ít
=0 ;É¡< 
md_£tup_íts
 ;Ént++)

70 i‡(
md_£tup_¨gs
[
ít
].
mö‹
 == minor &&

71 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 ==Öartitioned) {

72 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d, Specified moreÅhan once. "

73 "RïœcögÖªviou†deföôi⁄.\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

76 i‡(
ít
 >
	`ARRAY_SIZE
(
md_£tup_¨gs
)) {

77 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d -Åoÿm™y md inôülißti⁄s\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

80 i‡(
ít
 >
md_£tup_íts
)

81 
md_£tup_íts
++;

82 
	`gë_›ti⁄
(&
°r
, &
Àvñ
)) {

84 i‡(
Àvñ
 =0 ||Üevñ =
LEVEL_LINEAR
) {

85 i‡(
	`gë_›ti⁄
(&
°r
, &
Á˘‹
) != 2 ||

86 
	`gë_›ti⁄
(&
°r
, &
Áu…
) != 2) {

87 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

90 
md_£tup_¨gs
[
ít
].
Àvñ
 =Üevel;

91 
md_£tup_¨gs
[
ít
].
chunk
 = 1 << (
Á˘‹
+12);

92 i‡(
Àvñ
 =
LEVEL_LINEAR
)

93 
≥∫ame
 = "linear";

95 
≥∫ame
 = "raid0";

100 
°r
 = 
°r1
;

103 
md_£tup_¨gs
[
ít
].
Àvñ
 = 
LEVEL_NONE
;

104 
≥∫ame
="super-block";

107 
	`¥ötk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mö‹
, 
≥∫ame
, 
°r
);

109 
md_£tup_¨gs
[
ít
].
devi˚_«mes
 = 
°r
;

110 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 =Öartitioned;

111 
md_£tup_¨gs
[
ít
].
mö‹
 = minor;

114 
	}
}

116 
__öô
 
	$md_£tup_drive
()

118 
mö‹
, 
i
, 
ít
, 
∑πôi⁄ed
;

119 
dev_t
 
dev
;

120 
dev_t
 
devi˚s
[
MD_SB_DISKS
+1];

122 
ít
 = 0;É¡ < 
md_£tup_íts
 ;Ént++) {

123 
fd
;

124 
îr
 = 0;

125 *
dev«me
;

126 
mdu_disk_öfo_t
 
döfo
;

127 
«me
[16];

129 
mö‹
 = 
md_£tup_¨gs
[
ít
].minor;

130 
∑πôi⁄ed
 = 
md_£tup_¨gs
[
ít
].partitioned;

131 
dev«me
 = 
md_£tup_¨gs
[
ít
].
devi˚_«mes
;

133 
	`•rötf
(
«me
, "/dev/md%s%d", 
∑πôi⁄ed
?"_d":"", 
mö‹
);

134 i‡(
∑πôi⁄ed
)

135 
dev
 = 
	`MKDEV
(
mdp_maj‹
, 
mö‹
 << 
MdpMö‹Shi·
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mö‹
);

138 
	`¸óã_dev
(
«me
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
dev«me
 !
NULL
; i++) {

140 *
p
;

141 
comp_«me
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`°rchr
(
dev«me
, ',');

145 i‡(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`«me_to_dev_t
(
dev«me
);

149 i‡(
	`°∫cmp
(
dev«me
, "/dev/", 5) == 0)

150 
dev«me
 += 5;

151 
	`¢¥ötf
(
comp_«me
, 63, "/dev/%s", 
dev«me
);

152 
rdev
 = 
	`b°©
(
comp_«me
);

153 i‡(
rdev
)

154 
dev
 = 
	`√w_decode_dev
(
rdev
);

155 i‡(!
dev
) {

156 
	`¥ötk
(
KERN_WARNING
 "md: Unknow¿devi˚Çame: %s\n", 
dev«me
);

160 
devi˚s
[
i
] = 
dev
;

162 
dev«me
 = 
p
;

164 
devi˚s
[
i
] = 0;

166 i‡(!
i
)

169 
	`¥ötk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
∑πôi⁄ed
 ? "_d" : "", 
mö‹
,

171 
md_£tup_¨gs
[
ít
].
devi˚_«mes
);

173 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

174 i‡(
fd
 < 0) {

175 
	`¥ötk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¨øy %s\n", 
«me
);

179 i‡(
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, 0Ë=-
EBUSY
) {

180 
	`¥ötk
(
KERN_WARNING


182 
mö‹
);

183 
	`sys_˛o£
(
fd
);

187 i‡(
md_£tup_¨gs
[
ít
].
Àvñ
 !
LEVEL_NONE
) {

189 
mdu_¨øy_öfo_t
 
aöfo
;

190 
aöfo
.
Àvñ
 = 
md_£tup_¨gs
[
ít
].level;

191 
aöfo
.
size
 = 0;

192 
aöfo
.
ƒ_disks
 =0;

193 
aöfo
.
øid_disks
 =0;

194 
devi˚s
[
aöfo
.
øid_disks
])

195 
aöfo
.
øid_disks
++;

196 
aöfo
.
md_mö‹
 =
mö‹
;

197 
aöfo
.
nŸ_≥rsi°ít
 = 1;

199 
aöfo
.
°©e
 = (1 << 
MD_SB_CLEAN
);

200 
aöfo
.
œyout
 = 0;

201 
aöfo
.
chunk_size
 = 
md_£tup_¨gs
[
ít
].
chunk
;

202 
îr
 = 
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, ()&
aöfo
);

203 
i
 = 0; !
îr
 && i <
MD_SB_DISKS
; i++) {

204 
dev
 = 
devi˚s
[
i
];

205 i‡(!
dev
)

207 
döfo
.
numbî
 = 
i
;

208 
döfo
.
øid_disk
 = 
i
;

209 
döfo
.
°©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

211 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

212 
îr
 = 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

216 
i
 = 0; i <
MD_SB_DISKS
; i++) {

217 
dev
 = 
devi˚s
[
i
];

218 i‡(!
dev
)

220 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

221 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

222 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

225 i‡(!
îr
)

226 
îr
 = 
	`sys_io˘l
(
fd
, 
RUN_ARRAY
, 0);

227 i‡(
îr
)

228 
	`¥ötk
(
KERN_WARNING
 "md: sèπög md%d faûed\n", 
mö‹
);

235 
	`sys_˛o£
(
fd
);

236 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

237 
	`sys_io˘l
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_˛o£
(
fd
);

241 
	}
}

243 
__öô
 
	$øid_£tup
(*
°r
)

245 
Àn
, 
pos
;

247 
Àn
 = 
	`°æí
(
°r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Àn
) {

251 *
comma
 = 
	`°rchr
(
°r
+
pos
, ',');

252 
wÀn
;

253 i‡(
comma
)

254 
wÀn
 = (
comma
-
°r
)-
pos
;

255 
wÀn
 = (
Àn
-1)-
pos
;

257 i‡(!
	`°∫cmp
(
°r
, "nﬂutodëe˘", 
wÀn
))

258 
øid_nﬂutodëe˘
 = 1;

259 i‡(!
	`°∫cmp
(
°r
, "autodëe˘", 
wÀn
))

260 
øid_nﬂutodëe˘
 = 0;

261 i‡(
	`°∫cmp
(
°r
, "∑πôi⁄abÀ", 
wÀn
)==0)

262 
øid_aut›¨t
 = 1;

263 i‡(
	`°∫cmp
(
°r
, "∑π", 
wÀn
)==0)

264 
øid_aut›¨t
 = 1;

265 
pos
 +
wÀn
+1;

268 
	}
}

270 
__£tup
("øid=", 
øid_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__öô
 
	$autodëe˘_øid
()

275 
fd
;

281 
	`¥ötk
(
KERN_INFO
 "md: Waiting foráll devicesÅo beávailable beforeáutodetect\n");

282 
	`¥ötk
(
KERN_INFO
 "md: If you don't useÑaid, useÑaid=noautodetect\n");

284 
	`waô_f‹_devi˚_¥obe
();

286 
fd
 = 
	`sys_›í
("/dev/md0", 0, 0);

287 i‡(
fd
 >= 0) {

288 
	`sys_io˘l
(
fd
, 
RAID_AUTORUN
, 
øid_aut›¨t
);

289 
	`sys_˛o£
(
fd
);

291 
	}
}

293 
__öô
 
	$md_run_£tup
()

295 
	`¸óã_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 i‡(
øid_nﬂutodëe˘
)

298 
	`¥ötk
(
KERN_INFO
 "md: Skippingáutodetection of RAIDárrays. (raid=autodetect will force)\n");

300 
	`autodëe˘_øid
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/¸amfs_fs.h
>

8 
	~<löux/öôrd.h
>

9 
	~<löux/°rög.h
>

11 
	~"do_mou¡s.h
"

12 
	~"../fs/squashfs/squashfs_fs.h
"

14 
	~<löux/decom¥ess/gíîic.h
>

17 
__öôd©a
 
	grd_¥om±
 = 1;

19 
__öô
 
	$¥om±_ømdisk
(*
°r
)

21 
rd_¥om±
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 1;

23 
	}
}

24 
__£tup
("¥om±_ømdisk=", 
¥om±_ømdisk
);

26 
__öôd©a
 
	grd_image_°¨t
;

28 
__öô
 
	$ømdisk_°¨t_£tup
(*
°r
)

30 
rd_image_°¨t
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0);

32 
	}
}

33 
__£tup
("ømdisk_°¨t=", 
ømdisk_°¨t_£tup
);

35 
__öô
 
¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
);

51 
__öô


52 
	$idítify_ømdisk_image
(
fd
, 
°¨t_block
, 
decom¥ess_‚
 *
decom¥ess‹
)

54 c⁄° 
size
 = 512;

55 
möix_su≥r_block
 *
möixsb
;

56 
ext2_su≥r_block
 *
ext2sb
;

57 
romfs_su≥r_block
 *
romfsb
;

58 
¸amfs_su≥r
 *
¸amfsb
;

59 
squashfs_su≥r_block
 *
squashfsb
;

60 
nblocks
 = -1;

61 *
buf
;

62 c⁄° *
com¥ess_«me
;

64 
buf
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

65 i‡(!
buf
)

68 
möixsb
 = (
möix_su≥r_block
 *Ë
buf
;

69 
ext2sb
 = (
ext2_su≥r_block
 *Ë
buf
;

70 
romfsb
 = (
romfs_su≥r_block
 *Ë
buf
;

71 
¸amfsb
 = (
¸amfs_su≥r
 *Ë
buf
;

72 
squashfsb
 = (
squashfs_su≥r_block
 *Ë
buf
;

73 
	`mem£t
(
buf
, 0xe5, 
size
);

78 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

79 
	`sys_ªad
(
fd
, 
buf
, 
size
);

81 *
decom¥ess‹
 = 
	`decom¥ess_mëhod
(
buf
, 
size
, &
com¥ess_«me
);

82 i‡(
com¥ess_«me
) {

83 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: %s image foundát block %d\n",

84 
com¥ess_«me
, 
°¨t_block
);

85 i‡(!*
decom¥ess‹
)

86 
	`¥ötk
(
KERN_EMERG


88 
com¥ess_«me
);

89 
nblocks
 = 0;

90 
d⁄e
;

94 i‡(
romfsb
->
w‹d0
 =
ROMSB_WORD0
 &&

95 
romfsb
->
w‹d1
 =
ROMSB_WORD1
) {

96 
	`¥ötk
(
KERN_NOTICE


98 
°¨t_block
);

99 
nblocks
 = (
	`¡ohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

100 
d⁄e
;

103 i‡(
¸amfsb
->
magic
 =
CRAMFS_MAGIC
) {

104 
	`¥ötk
(
KERN_NOTICE


106 
°¨t_block
);

107 
nblocks
 = (
¸amfsb
->
size
 + 
BLOCK_SIZE
 - 1Ë>> 
BLOCK_SIZE_BITS
;

108 
d⁄e
;

112 i‡(
	`À32_to_˝u
(
squashfsb
->
s_magic
Ë=
SQUASHFS_MAGIC
) {

113 
	`¥ötk
(
KERN_NOTICE


115 
°¨t_block
);

116 
nblocks
 = (
	`À64_to_˝u
(
squashfsb
->
byãs_u£d
Ë+ 
BLOCK_SIZE
 - 1)

117 >> 
BLOCK_SIZE_BITS
;

118 
d⁄e
;

124 
	`sys_l£ek
(
fd
, (
°¨t_block
+1Ë* 
BLOCK_SIZE
, 0);

125 
	`sys_ªad
(
fd
, 
buf
, 
size
);

128 i‡(
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC
 ||

129 
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC2
) {

130 
	`¥ötk
(
KERN_NOTICE


132 
°¨t_block
);

133 
nblocks
 = 
möixsb
->
s_nz⁄es
 << möixsb->
s_log_z⁄e_size
;

134 
d⁄e
;

138 i‡(
ext2sb
->
s_magic
 =
	`˝u_to_À16
(
EXT2_SUPER_MAGIC
)) {

139 
	`¥ötk
(
KERN_NOTICE


141 
°¨t_block
);

142 
nblocks
 = 
	`À32_to_˝u
(
ext2sb
->
s_blocks_cou¡
) <<

143 
	`À32_to_˝u
(
ext2sb
->
s_log_block_size
);

144 
d⁄e
;

147 
	`¥ötk
(
KERN_NOTICE


149 
°¨t_block
);

151 
d⁄e
:

152 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

153 
	`k‰ì
(
buf
);

154  
nblocks
;

155 
	}
}

157 
__öô
 
	$rd_lﬂd_image
(*
‰om
)

159 
ªs
 = 0;

160 
ö_fd
, 
out_fd
;

161 
rd_blocks
, 
devblocks
;

162 
nblocks
, 
i
, 
disk
;

163 *
buf
 = 
NULL
;

164 
rŸ©e
 = 0;

165 
decom¥ess_‚
 
decom¥ess‹
 = 
NULL
;

166 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

167 
rŸ©‹
[4] = { '|' , '/' , '-' , '\\' };

170 
out_fd
 = 
	`sys_›í
("/dev/øm", 
O_RDWR
, 0);

171 i‡(
out_fd
 < 0)

172 
out
;

174 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

175 i‡(
ö_fd
 < 0)

176 
no˛o£_öput
;

178 
nblocks
 = 
	`idítify_ømdisk_image
(
ö_fd
, 
rd_image_°¨t
, &
decom¥ess‹
);

179 i‡(
nblocks
 < 0)

180 
d⁄e
;

182 i‡(
nblocks
 == 0) {

183 i‡(
	`¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess‹
) == 0)

184 
suc˚ssful_lﬂd
;

185 
d⁄e
;

199 i‡(
	`sys_io˘l
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

200 
rd_blocks
 = 0;

202 
rd_blocks
 >>= 1;

204 i‡(
nblocks
 > 
rd_blocks
) {

205 
	`¥ötk
("RAMDISK: imageÅoo big! (%dKiB/%ldKiB)\n",

206 
nblocks
, 
rd_blocks
);

207 
d⁄e
;

213 i‡(
	`sys_io˘l
(
ö_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

214 
devblocks
 = 0;

216 
devblocks
 >>= 1;

218 i‡(
	`°rcmp
(
‰om
, "/initrd.image") == 0)

219 
devblocks
 = 
nblocks
;

221 i‡(
devblocks
 == 0) {

222 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇot determine device size\n");

223 
d⁄e
;

226 
buf
 = 
	`kmÆloc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

227 i‡(!
buf
) {

228 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇotállocate buffer\n");

229 
d⁄e
;

232 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] intoÑam disk... ",

233 
nblocks
, (“blocks-1)/
devblocks
)+1,Çblocks>devblocks ? "s" : "");

234 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

235 i‡(
i
 && (ò% 
devblocks
 == 0)) {

236 
	`¥ötk
("d⁄êdisk #%d.\n", 
disk
++);

237 
rŸ©e
 = 0;

238 i‡(
	`sys_˛o£
(
ö_fd
)) {

239 
	`¥ötk
("Error closingÅhe disk.\n");

240 
no˛o£_öput
;

242 
	`ch™ge_Ê›py
("disk #%d", 
disk
);

243 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

244 i‡(
ö_fd
 < 0) {

245 
	`¥ötk
("Error opening disk.\n");

246 
no˛o£_öput
;

248 
	`¥ötk
("Lﬂdög disk #%d... ", 
disk
);

250 
	`sys_ªad
(
ö_fd
, 
buf
, 
BLOCK_SIZE
);

251 
	`sys_wrôe
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

252 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

253 i‡(!(
i
 % 16)) {

254 
	`¥ötk
("%c\b", 
rŸ©‹
[
rŸ©e
 & 0x3]);

255 
rŸ©e
++;

259 
	`¥ötk
("done.\n");

261 
suc˚ssful_lﬂd
:

262 
ªs
 = 1;

263 
d⁄e
:

264 
	`sys_˛o£
(
ö_fd
);

265 
no˛o£_öput
:

266 
	`sys_˛o£
(
out_fd
);

267 
out
:

268 
	`k‰ì
(
buf
);

269 
	`sys_u∆ök
("/dev/ram");

270  
ªs
;

271 
	}
}

273 
__öô
 
	$rd_lﬂd_disk
(
n
)

275 i‡(
rd_¥om±
)

276 
	`ch™ge_Ê›py
("root floppy diskÅo beÜoaded into RAM disk");

277 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

278 
	`¸óã_dev
("/dev/øm", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

279  
	`rd_lﬂd_image
("/dev/root");

280 
	}
}

282 
	gexô_code
;

283 
	gdecom¥ess_îr‹
;

284 
	g¸d_öfd
, 
	g¸d_outfd
;

286 
__öô
 
	$com¥_fûl
(*
buf
, 
Àn
)

288 
r
 = 
	`sys_ªad
(
¸d_öfd
, 
buf
, 
Àn
);

289 i‡(
r
 < 0)

290 
	`¥ötk
(
KERN_ERR
 "RAMDISK:Érror whileÑeading compressed data");

291 i‡(
r
 == 0)

292 
	`¥ötk
(
KERN_ERR
 "RAMDISK: EOF whileÑeading compressed data");

293  
r
;

294 
	}
}

296 
__öô
 
	$com¥_Êush
(*
wödow
, 
out˙t
)

298 
wrôãn
 = 
	`sys_wrôe
(
¸d_outfd
, 
wödow
, 
out˙t
);

299 i‡(
wrôãn
 !
out˙t
) {

300 i‡(
decom¥ess_îr‹
 == 0)

301 
	`¥ötk
(
KERN_ERR


303 
wrôãn
, 
out˙t
);

304 
decom¥ess_îr‹
 = 1;

307  
out˙t
;

308 
	}
}

310 
__öô
 
	$îr‹
(*
x
)

312 
	`¥ötk
(
KERN_ERR
 "%s\n", 
x
);

313 
exô_code
 = 1;

314 
decom¥ess_îr‹
 = 1;

315 
	}
}

317 
__öô
 
	$¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
)

319 
ªsu…
;

320 
¸d_öfd
 = 
ö_fd
;

321 
¸d_outfd
 = 
out_fd
;

322 
ªsu…
 = 
	`deco
(
NULL
, 0, 
com¥_fûl
, 
com¥_Êush
, NULL, NULL, 
îr‹
);

323 i‡(
decom¥ess_îr‹
)

324 
ªsu…
 = 1;

325  
ªsu…
;

326 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<löux/öô.h
>

2 
	~<löux/fs.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/ty≥s.h
>

5 
	~<löux/f˙é.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dúít.h
>

9 
	~<löux/sysˇŒs.h
>

10 
	~<löux/utime.h
>

12 
__öôd©a
 *
	gmesßge
;

13 
__öô
 
	$îr‹
(*
x
)

15 i‡(!
mesßge
)

16 
mesßge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Àn
Ë(((÷íË+ 1Ë& ~3Ë+ 2)

	)

23 
__öôd©a
 
	shash
 {

24 
	möo
, 
	mmö‹
, 
	mmaj‹
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	m√xt
;

27 
	m«me
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	ghód
[32];

30 
ölöe
 
	$hash
(
maj‹
, 
mö‹
, 
öo
)

32 
tmp
 = 
öo
 + 
mö‹
 + (
maj‹
 << 3);

33 
tmp
 +=Åmp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__öô
 *
	$föd_lök
(
maj‹
, 
mö‹
, 
öo
,

38 
mode_t
 
mode
, *
«me
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
hód
 + 
	`hash
(
maj‹
, 
mö‹
, 
öo
); *p;Ö = &(*p)->
√xt
) {

42 i‡((*
p
)->
öo
 != ino)

44 i‡((*
p
)->
mö‹
 != minor)

46 i‡((*
p
)->
maj‹
 != major)

48 i‡(((*
p
)->
mode
 ^ modeË& 
S_IFMT
)

50  (*
p
)->
«me
;

52 
q
 = 
	`kmÆloc
((
hash
), 
GFP_KERNEL
);

53 i‡(!
q
)

54 
	`∑nic
("can'tállocateÜink hashÉntry");

55 
q
->
maj‹
 = major;

56 
q
->
mö‹
 = minor;

57 
q
->
öo
 = ino;

58 
q
->
mode
 = mode;

59 
	`°r˝y
(
q
->
«me
,Çame);

60 
q
->
√xt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__öô
 
	$‰ì_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
hód
;Ö < head + 32;Ö++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
√xt
;

72 
	`k‰ì
(
q
);

75 
	}
}

77 
__öô
 
	$do_utime
(
__u£r
 *
fûíame
, 
time_t
 
mtime
)

79 
time•ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__öôd©a
 
LIST_HEAD
(
dú_li°
);

90 
	sdú_íåy
 {

91 
li°_hód
 
	mli°
;

92 *
	m«me
;

93 
time_t
 
	mmtime
;

96 
__öô
 
	$dú_add
(c⁄° *
«me
, 
time_t
 
mtime
)

98 
dú_íåy
 *
de
 = 
	`kmÆloc
((dú_íåy), 
GFP_KERNEL
);

99 i‡(!
de
)

100 
	`∑nic
("can'tállocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li°
);

102 
de
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li°_add
(&
de
->
li°
, &
dú_li°
);

105 
	}
}

107 
__öô
 
	$dú_utime
()

109 
dú_íåy
 *
de
, *
tmp
;

110 
	`li°_f‹_óch_íåy_ß„
(
de
, 
tmp
, &
dú_li°
, 
li°
) {

111 
	`li°_dñ
(&
de
->
li°
);

112 
	`do_utime
(
de
->
«me
, de->
mtime
);

113 
	`k‰ì
(
de
->
«me
);

114 
	`k‰ì
(
de
);

116 
	}
}

118 
__öôd©a
 
time_t
 
	gmtime
;

122 
__öôd©a
 
	göo
, 
	gmaj‹
, 
	gmö‹
, 
	g∆ök
;

123 
__öôd©a
 
mode_t
 
	gmode
;

124 
__öôd©a
 
	gbody_Àn
, 
	g«me_Àn
;

125 
__öôd©a
 
uid_t
 
	guid
;

126 
__öôd©a
 
gid_t
 
	ggid
;

127 
__öôd©a
 
	grdev
;

129 
__öô
 
	$∑r£_hódî
(*
s
)

131 
∑r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`mem˝y
(
buf
, 
s
, 8);

138 
∑r£d
[
i
] = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 16);

140 
öo
 = 
∑r£d
[0];

141 
mode
 = 
∑r£d
[1];

142 
uid
 = 
∑r£d
[2];

143 
gid
 = 
∑r£d
[3];

144 
∆ök
 = 
∑r£d
[4];

145 
mtime
 = 
∑r£d
[5];

146 
body_Àn
 = 
∑r£d
[6];

147 
maj‹
 = 
∑r£d
[7];

148 
mö‹
 = 
∑r£d
[8];

149 
rdev
 = 
	`√w_ícode_dev
(
	`MKDEV
(
∑r£d
[9],Öarsed[10]));

150 
«me_Àn
 = 
∑r£d
[11];

151 
	}
}

155 
__öôd©a
 
	e°©e
 {

156 
	mSèπ
,

157 
	mCﬁÀ˘
,

158 
	mGŸHódî
,

159 
	mSkùIt
,

160 
	mGŸName
,

161 
	mC›yFûe
,

162 
	mGŸSymlök
,

163 
	mRe£t


164 } 
	g°©e
, 
	g√xt_°©e
;

166 
__öôd©a
 *
	gvi˘im
;

167 
__öôd©a
 
	gcou¡
;

168 
__öôd©a
 
loff_t
 
	gthis_hódî
, 
	g√xt_hódî
;

170 
ölöe
 
__öô
 
	$ót
(
n
)

172 
vi˘im
 +
n
;

173 
this_hódî
 +
n
;

174 
cou¡
 -
n
;

175 
	}
}

177 
__öôd©a
 *
	gvcﬁÀ˘ed
;

178 
__öôd©a
 *
	gcﬁÀ˘ed
;

179 
__öôd©a
 
	gªmaös
;

180 
__öôd©a
 *
	gcﬁÀ˘
;

182 
__öô
 
	$ªad_öto
(*
buf
, 
size
, 
°©e
 
√xt
)

184 i‡(
cou¡
 >
size
) {

185 
cﬁÀ˘ed
 = 
vi˘im
;

186 
	`ót
(
size
);

187 
°©e
 = 
√xt
;

189 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
buf
;

190 
ªmaös
 = 
size
;

191 
√xt_°©e
 = 
√xt
;

192 
°©e
 = 
CﬁÀ˘
;

194 
	}
}

196 
__öôd©a
 *
	ghódî_buf
, *
	gsymlök_buf
, *
	g«me_buf
;

198 
__öô
 
	$do_°¨t
()

200 
	`ªad_öto
(
hódî_buf
, 110, 
GŸHódî
);

202 
	}
}

204 
__öô
 
	$do_cﬁÀ˘
()

206 
n
 = 
ªmaös
;

207 i‡(
cou¡
 < 
n
)

208 
n
 = 
cou¡
;

209 
	`mem˝y
(
cﬁÀ˘
, 
vi˘im
, 
n
);

210 
	`ót
(
n
);

211 
cﬁÀ˘
 +
n
;

212 i‡((
ªmaös
 -
n
) != 0)

214 
°©e
 = 
√xt_°©e
;

216 
	}
}

218 
__öô
 
	$do_hódî
()

220 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070707", 6)==0) {

221 
	`îr‹
("incorrect cpio method used: use -HÇewc option");

224 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070701", 6)) {

225 
	`îr‹
("no cpio magic");

228 
	`∑r£_hódî
(
cﬁÀ˘ed
);

229 
√xt_hódî
 = 
this_hódî
 + 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

230 
√xt_hódî
 = (next_header + 3) & ~3;

231 
°©e
 = 
SkùIt
;

232 i‡(
«me_Àn
 <0 ||Çame_À¿> 
PATH_MAX
)

234 i‡(
	`S_ISLNK
(
mode
)) {

235 i‡(
body_Àn
 > 
PATH_MAX
)

237 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
symlök_buf
;

238 
ªmaös
 = 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

239 
√xt_°©e
 = 
GŸSymlök
;

240 
°©e
 = 
CﬁÀ˘
;

243 i‡(
	`S_ISREG
(
mode
Ë|| !
body_Àn
)

244 
	`ªad_öto
(
«me_buf
, 
	`N_ALIGN
(
«me_Àn
), 
GŸName
);

246 
	}
}

248 
__öô
 
	$do_skù
()

250 i‡(
this_hódî
 + 
cou¡
 < 
√xt_hódî
) {

251 
	`ót
(
cou¡
);

254 
	`ót
(
√xt_hódî
 - 
this_hódî
);

255 
°©e
 = 
√xt_°©e
;

258 
	}
}

260 
__öô
 
	$do_ª£t
()

262 
cou¡
 && *
vi˘im
 == '\0')

263 
	`ót
(1);

264 i‡(
cou¡
 && (
this_hódî
 & 3))

265 
	`îr‹
("brokenÖadding");

267 
	}
}

269 
__öô
 
	$maybe_lök
()

271 i‡(
∆ök
 >= 2) {

272 *
ﬁd
 = 
	`föd_lök
(
maj‹
, 
mö‹
, 
öo
, 
mode
, 
cﬁÀ˘ed
);

273 i‡(
ﬁd
)

274  (
	`sys_lök
(
ﬁd
, 
cﬁÀ˘ed
) < 0) ? -1 : 1;

277 
	}
}

279 
__öô
 
	$˛ón_∑th
(*
∑th
, 
mode_t
 
mode
)

281 
°©
 
°
;

283 i‡(!
	`sys_√wl°©
(
∑th
, &
°
Ë&& (°.
°_mode
^
mode
Ë& 
S_IFMT
) {

284 i‡(
	`S_ISDIR
(
°
.
°_mode
))

285 
	`sys_rmdú
(
∑th
);

287 
	`sys_u∆ök
(
∑th
);

289 
	}
}

291 
__öôd©a
 
	gwfd
;

293 
__öô
 
	$do_«me
()

295 
°©e
 = 
SkùIt
;

296 
√xt_°©e
 = 
Re£t
;

297 i‡(
	`°rcmp
(
cﬁÀ˘ed
, "TRAILER!!!") == 0) {

298 
	`‰ì_hash
();

301 
	`˛ón_∑th
(
cﬁÀ˘ed
, 
mode
);

302 i‡(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lök
();

304 i‡(
ml
 >= 0) {

305 
›íÊags
 = 
O_WRONLY
|
O_CREAT
;

306 i‡(
ml
 != 1)

307 
›íÊags
 |
O_TRUNC
;

308 
wfd
 = 
	`sys_›í
(
cﬁÀ˘ed
, 
›íÊags
, 
mode
);

310 i‡(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 i‡(
body_Àn
)

314 
	`sys_·runˇã
(
wfd
, 
body_Àn
);

315 
vcﬁÀ˘ed
 = 
	`k°rdup
(
cﬁÀ˘ed
, 
GFP_KERNEL
);

316 
°©e
 = 
C›yFûe
;

319 } i‡(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdú
(
cﬁÀ˘ed
, 
mode
);

321 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

323 
	`dú_add
(
cﬁÀ˘ed
, 
mtime
);

324 } i‡(
	`S_ISBLK
(
mode
Ë|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

326 i‡(
	`maybe_lök
() == 0) {

327 
	`sys_mknod
(
cﬁÀ˘ed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

330 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

334 
	}
}

336 
__öô
 
	$do_c›y
()

338 i‡(
cou¡
 >
body_Àn
) {

339 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
body_Àn
);

340 
	`sys_˛o£
(
wfd
);

341 
	`do_utime
(
vcﬁÀ˘ed
, 
mtime
);

342 
	`k‰ì
(
vcﬁÀ˘ed
);

343 
	`ót
(
body_Àn
);

344 
°©e
 = 
SkùIt
;

347 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
cou¡
);

348 
body_Àn
 -
cou¡
;

349 
	`ót
(
cou¡
);

352 
	}
}

354 
__öô
 
	$do_symlök
()

356 
cﬁÀ˘ed
[
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
] = '\0';

357 
	`˛ón_∑th
(
cﬁÀ˘ed
, 0);

358 
	`sys_symlök
(
cﬁÀ˘ed
 + 
	`N_ALIGN
(
«me_Àn
), collected);

359 
	`sys_lchown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

360 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

361 
°©e
 = 
SkùIt
;

362 
√xt_°©e
 = 
Re£t
;

364 
	}
}

366 
__öôd©a
 (*
a˘i⁄s
[])() = {

367 [
Sèπ
] = 
do_°¨t
,

368 [
CﬁÀ˘
] = 
do_cﬁÀ˘
,

369 [
GŸHódî
] = 
do_hódî
,

370 [
SkùIt
] = 
do_skù
,

371 [
GŸName
] = 
do_«me
,

372 [
C›yFûe
] = 
do_c›y
,

373 [
GŸSymlök
] = 
do_symlök
,

374 [
Re£t
] = 
do_ª£t
,

375 
	}
};

377 
__öô
 
	$wrôe_buf„r
(*
buf
, 
Àn
)

379 
cou¡
 = 
Àn
;

380 
vi˘im
 = 
buf
;

382 !
a˘i⁄s
[
°©e
]())

384  
Àn
 - 
cou¡
;

385 
	}
}

387 
__öô
 
	$Êush_buf„r
(*
bufv
, 
Àn
)

389 *
buf
 = (*Ë
bufv
;

390 
wrôãn
;

391 
‹igLí
 = 
Àn
;

392 i‡(
mesßge
)

394 (
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
)Ë<Üí && !
mesßge
) {

395 
c
 = 
buf
[
wrôãn
];

396 i‡(
c
 == '0') {

397 
buf
 +
wrôãn
;

398 
Àn
 -
wrôãn
;

399 
°©e
 = 
Sèπ
;

400 } i‡(
c
 == 0) {

401 
buf
 +
wrôãn
;

402 
Àn
 -
wrôãn
;

403 
°©e
 = 
Re£t
;

405 
	`îr‹
("junk in compressedárchive");

407  
‹igLí
;

408 
	}
}

410 
	gmy_ö±r
;

412 
	~<löux/decom¥ess/gíîic.h
>

414 * 
__öô
 
	$u≈ack_to_roŸfs
(*
buf
, 
Àn
)

416 
wrôãn
;

417 
decom¥ess_‚
 
decom¥ess
;

418 c⁄° *
com¥ess_«me
;

419 
__öôd©a
 
msg_buf
[64];

421 
hódî_buf
 = 
	`kmÆloc
(110, 
GFP_KERNEL
);

422 
symlök_buf
 = 
	`kmÆloc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXË+ 1, 
GFP_KERNEL
);

423 
«me_buf
 = 
	`kmÆloc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 i‡(!
hódî_buf
 || !
symlök_buf
 || !
«me_buf
)

426 
	`∑nic
("can'tállocate buffers");

428 
°©e
 = 
Sèπ
;

429 
this_hódî
 = 0;

430 
mesßge
 = 
NULL
;

431 !
mesßge
 && 
Àn
) {

432 
loff_t
 
ßved_off£t
 = 
this_hódî
;

433 i‡(*
buf
 ='0' && !(
this_hódî
 & 3)) {

434 
°©e
 = 
Sèπ
;

435 
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
);

436 
buf
 +
wrôãn
;

437 
Àn
 -
wrôãn
;

440 i‡(!*
buf
) {

441 
buf
++;

442 
Àn
--;

443 
this_hódî
++;

446 
this_hódî
 = 0;

447 
decom¥ess
 = 
	`decom¥ess_mëhod
(
buf
, 
Àn
, &
com¥ess_«me
);

448 i‡(
decom¥ess
)

449 
	`decom¥ess
(
buf
, 
Àn
, 
NULL
, 
Êush_buf„r
, NULL,

450 &
my_ö±r
, 
îr‹
);

451 i‡(
com¥ess_«me
) {

452 i‡(!
mesßge
) {

453 
	`¢¥ötf
(
msg_buf
,  msg_buf,

455 
com¥ess_«me
);

456 
mesßge
 = 
msg_buf
;

459 i‡(
°©e
 !
Re£t
)

460 
	`îr‹
("junk in compressedárchive");

461 
this_hódî
 = 
ßved_off£t
 + 
my_ö±r
;

462 
buf
 +
my_ö±r
;

463 
Àn
 -
my_ö±r
;

465 
	`dú_utime
();

466 
	`k‰ì
(
«me_buf
);

467 
	`k‰ì
(
symlök_buf
);

468 
	`k‰ì
(
hódî_buf
);

469  
mesßge
;

470 
	}
}

472 
__öôd©a
 
	gdo_ªèö_öôrd
;

474 
__öô
 
	$ªèö_öôrd_∑øm
(*
°r
)

476 i‡(*
°r
)

478 
do_ªèö_öôrd
 = 1;

480 
	}
}

481 
__£tup
("ªèö_öôrd", 
ªèö_öôrd_∑øm
);

483 
__öôømfs_°¨t
[], 
__öôømfs_íd
[];

484 
	~<löux/öôrd.h
>

485 
	~<löux/kexec.h
>

487 
__öô
 
	$‰ì_öôrd
()

489 #ifde‡
CONFIG_KEXEC


490 
¸ashk_°¨t
 = ()
	`__va
(
¸ashk_ªs
.
°¨t
);

491 
¸ashk_íd
 = ()
	`__va
(
¸ashk_ªs
.
íd
);

493 i‡(
do_ªèö_öôrd
)

494 
skù
;

496 #ifde‡
CONFIG_KEXEC


501 i‡(
öôrd_°¨t
 < 
¸ashk_íd
 && 
öôrd_íd
 > 
¸ashk_°¨t
) {

506 
	`mem£t
((*)
öôrd_°¨t
, 0, 
öôrd_íd
 - initrd_start);

507 i‡(
öôrd_°¨t
 < 
¸ashk_°¨t
)

508 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
¸ashk_°¨t
);

509 i‡(
öôrd_íd
 > 
¸ashk_íd
)

510 
	`‰ì_öôrd_mem
(
¸ashk_íd
, 
öôrd_íd
);

513 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
öôrd_íd
);

514 
skù
:

515 
öôrd_°¨t
 = 0;

516 
öôrd_íd
 = 0;

517 
	}
}

519 #ifde‡
CONFIG_BLK_DEV_RAM


520 
	#BUF_SIZE
 1024

	)

521 
__öô
 
	$˛ón_roŸfs
()

523 
fd
;

524 *
buf
;

525 
löux_dúít64
 *
dúp
;

526 
cou¡
;

528 
fd
 = 
	`sys_›í
("/", 
O_RDONLY
, 0);

529 
	`WARN_ON
(
fd
 < 0);

530 i‡(
fd
 < 0)

532 
buf
 = 
	`kzÆloc
(
BUF_SIZE
, 
GFP_KERNEL
);

533 
	`WARN_ON
(!
buf
);

534 i‡(!
buf
) {

535 
	`sys_˛o£
(
fd
);

539 
dúp
 = 
buf
;

540 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

541 
cou¡
 > 0) {

542 
cou¡
 > 0) {

543 
°©
 
°
;

544 
ªt
;

546 
ªt
 = 
	`sys_√wl°©
(
dúp
->
d_«me
, &
°
);

547 
	`WARN_ON_ONCE
(
ªt
);

548 i‡(!
ªt
) {

549 i‡(
	`S_ISDIR
(
°
.
°_mode
))

550 
	`sys_rmdú
(
dúp
->
d_«me
);

552 
	`sys_u∆ök
(
dúp
->
d_«me
);

555 
cou¡
 -
dúp
->
d_ª˛í
;

556 
dúp
 = (*)dú∞+ dúp->
d_ª˛í
;

558 
dúp
 = 
buf
;

559 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

560 
cou¡
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

563 
	`sys_˛o£
(
fd
);

564 
	`k‰ì
(
buf
);

565 
	}
}

568 
__öô
 
	$p›uœã_roŸfs
()

570 *
îr
 = 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

571 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

572 i‡(
îr
)

573 
	`∑nic
(
îr
);

574 i‡(
öôrd_°¨t
) {

575 #ifde‡
CONFIG_BLK_DEV_RAM


576 
fd
;

577 
	`¥ötk
(
KERN_INFO
 "TryingÅo unpackÑootfs imageás initramfs...\n");

578 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

579 
öôrd_íd
 - 
öôrd_°¨t
);

580 i‡(!
îr
) {

581 
	`‰ì_öôrd
();

584 
	`˛ón_roŸfs
();

585 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

586 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

588 
	`¥ötk
(
KERN_INFO
 "rootfs image isÇot initramfs (%s)"

589 ";Üook†likê™ inôrd\n", 
îr
);

590 
fd
 = 
	`sys_›í
("/öôrd.image", 
O_WRONLY
|
O_CREAT
, 0700);

591 i‡(
fd
 >= 0) {

592 
	`sys_wrôe
(
fd
, (*)
öôrd_°¨t
,

593 
öôrd_íd
 - 
öôrd_°¨t
);

594 
	`sys_˛o£
(
fd
);

595 
	`‰ì_öôrd
();

598 
	`¥ötk
(
KERN_INFO
 "Unpacking initramfs...\n");

599 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

600 
öôrd_íd
 - 
öôrd_°¨t
);

601 i‡(
îr
)

602 
	`¥ötk
(
KERN_EMERG
 "Inôømf†u≈ackög faûed: %s\n", 
îr
);

603 
	`‰ì_öôrd
();

607 
	}
}

608 
roŸfs_öôˇŒ
(
p›uœã_roŸfs
);

	@/cmpt816/linux/init/main.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/˘y≥.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/smp_lock.h
>

24 
	~<löux/öôrd.h
>

25 
	~<löux/boŸmem.h
>

26 
	~<löux/a˝i.h
>

27 
	~<löux/ây.h
>

28 
	~<löux/gÂ.h
>

29 
	~<löux/≥r˝u.h
>

30 
	~<löux/kmod.h
>

31 
	~<löux/vmÆloc.h
>

32 
	~<löux/kî√l_°©.h
>

33 
	~<löux/°¨t_kî√l.h
>

34 
	~<löux/£curôy.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/¥ofûe.h
>

38 
	~<löux/rcupd©e.h
>

39 
	~<löux/moduÀ∑øm.h
>

40 
	~<löux/kÆlsyms.h
>

41 
	~<löux/wrôeback.h
>

42 
	~<löux/˝u.h
>

43 
	~<löux/˝u£t.h
>

44 
	~<löux/cgroup.h
>

45 
	~<löux/efi.h
>

46 
	~<löux/tick.h
>

47 
	~<löux/öãºu±.h
>

48 
	~<löux/èsk°©s_kîn.h
>

49 
	~<löux/dñayac˘.h
>

50 
	~<löux/uni°d.h
>

51 
	~<löux/rm≠.h
>

52 
	~<löux/mempﬁicy.h
>

53 
	~<löux/key.h
>

54 
	~<löux/buf„r_hód.h
>

55 
	~<löux/∑ge_cgroup.h
>

56 
	~<löux/debug_locks.h
>

57 
	~<löux/debugobje˘s.h
>

58 
	~<löux/lockdï.h
>

59 
	~<löux/kmemÀak.h
>

60 
	~<löux/pid_«me•a˚.h
>

61 
	~<löux/devi˚.h
>

62 
	~<löux/kthªad.h
>

63 
	~<löux/sched.h
>

64 
	~<löux/sig«l.h
>

65 
	~<löux/idr.h
>

66 
	~<löux/·ø˚.h
>

67 
	~<löux/async.h
>

68 
	~<löux/kmemcheck.h
>

69 
	~<löux/kmemåa˚.h
>

70 
	~<löux/sfi.h
>

71 
	~<löux/shmem_fs.h
>

72 
	~<åa˚/boŸ.h
>

74 
	~<asm/io.h
>

75 
	~<asm/bugs.h
>

76 
	~<asm/£tup.h
>

77 
	~<asm/£˘i⁄s.h
>

78 
	~<asm/ˇcheÊush.h
>

80 #ifde‡
CONFIG_X86_LOCAL_APIC


81 
	~<asm/smp.h
>

84 
kî√l_öô
(*);

86 
öô_IRQ
();

87 
f‹k_öô
();

88 
mˇ_öô
();

89 
sbus_öô
();

90 
¥io_åì_öô
();

91 
ødix_åì_öô
();

92 
‰ì_öômem
();

93 #i‚de‡
CONFIG_DEBUG_RODATA


94 
ölöe
 
	$m¨k_rod©a_ro
(Ë{ 
	}
}

97 #ifde‡
CONFIG_TC


98 
tc_öô
();

101 
sy°em_°©es
 
sy°em_°©e
 
	g__ªad_mo°ly
;

102 
EXPORT_SYMBOL
(
sy°em_°©e
);

107 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

108 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

110 
time_öô
();

112 (*
__öôd©a
 
œã_time_öô
)();

113 
	`so·úq_öô
();

116 
__öôd©a
 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
];

118 *
ßved_comm™d_löe
;

120 *
°©ic_comm™d_löe
;

122 *
execuã_comm™d
;

123 *
ømdisk_execuã_comm™d
;

125 #ifde‡
CONFIG_SMP


127 
__öôd©a
 
£tup_max_˝us
 = 
NR_CPUS
;

140 
__wók
 
	$¨ch_dißbÀ_smp_suµ‹t
(Ë{ 
	}
}

142 
__öô
 
	$nosmp
(*
°r
)

144 
£tup_max_˝us
 = 0;

145 
	`¨ch_dißbÀ_smp_suµ‹t
();

148 
	}
}

150 
óæy_∑øm
("nosmp", 
nosmp
);

152 
__öô
 
	$max˝us
(*
°r
)

154 
	`gë_›ti⁄
(&
°r
, &
£tup_max_˝us
);

155 i‡(
£tup_max_˝us
 == 0)

156 
	`¨ch_dißbÀ_smp_suµ‹t
();

159 
	}
}

161 
óæy_∑øm
("max˝us", 
max˝us
);

163 c⁄° 
	g£tup_max_˝us
 = 
NR_CPUS
;

175 
	gª£t_devi˚s
;

176 
EXPORT_SYMBOL
(
ª£t_devi˚s
);

178 
__öô
 
	$£t_ª£t_devi˚s
(*
°r
)

180 
ª£t_devi˚s
 = 1;

182 
	}
}

184 
__£tup
("ª£t_devi˚s", 
£t_ª£t_devi˚s
);

186 * 
	g¨gv_öô
[
MAX_INIT_ARGS
+2] = { "öô", 
NULL
, };

187 * 
	gívp_öô
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMˆöux", 
NULL
, };

188 c⁄° *
	g∑nic_œãr
, *
	g∑nic_∑øm
;

190 
obs_kî√l_∑øm
 
__£tup_°¨t
[], 
__£tup_íd
[];

192 
__öô
 
	$obsﬁëe_check£tup
(*
löe
)

194 
obs_kî√l_∑øm
 *
p
;

195 
had_óæy_∑øm
 = 0;

197 
p
 = 
__£tup_°¨t
;

199 
n
 = 
	`°æí
(
p
->
°r
);

200 i‡(!
	`°∫cmp
(
löe
, 
p
->
°r
, 
n
)) {

201 i‡(
p
->
óæy
) {

206 i‡(
löe
[
n
] == '\0' ||Üine[n] == '=')

207 
had_óæy_∑øm
 = 1;

208 } i‡(!
p
->
£tup_func
) {

209 
	`¥ötk
(
KERN_WARNING
 "Parameter %s is obsolete,"

210 " ign‹ed\n", 
p
->
°r
);

212 } i‡(
p
->
	`£tup_func
(
löe
 + 
n
))

215 
p
++;

216 } 
p
 < 
__£tup_íd
);

218  
had_óæy_∑øm
;

219 
	}
}

225 
	glo›s_≥r_jiffy
 = (1<<12);

227 
EXPORT_SYMBOL
(
lo›s_≥r_jiffy
);

229 
__öô
 
	$debug_kî√l
(*
°r
)

231 
c⁄sﬁe_logÀvñ
 = 10;

233 
	}
}

235 
__öô
 
	$quõt_kî√l
(*
°r
)

237 
c⁄sﬁe_logÀvñ
 = 4;

239 
	}
}

241 
óæy_∑øm
("debug", 
debug_kî√l
);

242 
óæy_∑øm
("quõt", 
quõt_kî√l
);

244 
__öô
 
	$logÀvñ
(*
°r
)

246 
	`gë_›ti⁄
(&
°r
, &
c⁄sﬁe_logÀvñ
);

248 
	}
}

250 
óæy_∑øm
("logÀvñ", 
logÀvñ
);

256 
__öô
 
	$unknown_boŸ›ti⁄
(*
∑øm
, *
vÆ
)

259 i‡(
vÆ
) {

261 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+1)

262 
vÆ
[-1] = '=';

263 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+2) {

264 
vÆ
[-2] = '=';

265 
	`memmove
(
vÆ
-1, vÆ, 
	`°æí
(val)+1);

266 
vÆ
--;

268 
	`BUG
();

272 i‡(
	`obsﬁëe_check£tup
(
∑øm
))

276 i‡(
	`°rchr
(
∑øm
, '.'Ë&& (!
vÆ
 || strchr(param, '.') < val))

279 i‡(
∑nic_œãr
)

282 i‡(
vÆ
) {

284 
i
;

285 
i
 = 0; 
ívp_öô
[i]; i++) {

286 i‡(
i
 =
MAX_INIT_ENVS
) {

287 
∑nic_œãr
 = "Too many bootÉnv varsát `%s'";

288 
∑nic_∑øm
 = 
∑øm
;

290 i‡(!
	`°∫cmp
(
∑øm
, 
ívp_öô
[
i
], 
vÆ
 -Öaram))

293 
ívp_öô
[
i
] = 
∑øm
;

296 
i
;

297 
i
 = 0; 
¨gv_öô
[i]; i++) {

298 i‡(
i
 =
MAX_INIT_ARGS
) {

299 
∑nic_œãr
 = "Too many boot init varsát `%s'";

300 
∑nic_∑øm
 = 
∑øm
;

303 
¨gv_öô
[
i
] = 
∑øm
;

306 
	}
}

308 #ifde‡
CONFIG_DEBUG_PAGEALLOC


309 
__ªad_mo°ly
 
	gdebug_∑góŒoc_íabÀd
 = 0;

312 
__öô
 
	$öô_£tup
(*
°r
)

314 
i
;

316 
execuã_comm™d
 = 
°r
;

323 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

324 
¨gv_öô
[
i
] = 
NULL
;

326 
	}
}

327 
__£tup
("öô=", 
öô_£tup
);

329 
__öô
 
	$rdöô_£tup
(*
°r
)

331 
i
;

333 
ømdisk_execuã_comm™d
 = 
°r
;

335 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

336 
¨gv_öô
[
i
] = 
NULL
;

338 
	}
}

339 
__£tup
("rdöô=", 
rdöô_£tup
);

341 #i‚de‡
CONFIG_SMP


343 #ifde‡
CONFIG_X86_LOCAL_APIC


344 
__öô
 
	$smp_öô
()

346 
	`APIC_öô_unùro˚ss‹
();

347 
	}
}

349 
	#smp_öô
(Ëdÿ{ } 0)

	)

352 
ölöe
 
	$£tup_ƒ_˝u_ids
(Ë{ 
	}
}

353 
ölöe
 
	$smp_¥ï¨e_˝us
(
max˝us
Ë{ 
	}
}

358 
ƒ_˝u_ids
 
	g__ªad_mo°ly
 = 
NR_CPUS
;

359 
EXPORT_SYMBOL
(
ƒ_˝u_ids
);

362 
__öô
 
	$£tup_ƒ_˝u_ids
()

364 
ƒ_˝u_ids
 = 
	`föd_œ°_bô
(
	`˝umask_bôs
(
˝u_possibÀ_mask
),
NR_CPUS
) + 1;

365 
	}
}

368 
__öô
 
	$smp_öô
()

370 
˝u
;

376 
	`£t_˝u_a˘ive
(
	`smp_¥o˚ss‹_id
(), 
åue
);

379 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

380 i‡(
	`num_⁄löe_˝us
(Ë>
£tup_max_˝us
)

382 i‡(!
	`˝u_⁄löe
(
˝u
))

383 
	`˝u_up
(
˝u
);

387 
	`¥ötk
(
KERN_INFO
 "Broughàu∞%ld CPUs\n", ()
	`num_⁄löe_˝us
());

388 
	`smp_˝us_d⁄e
(
£tup_max_˝us
);

389 
	}
}

399 
__öô
 
	$£tup_comm™d_löe
(*
comm™d_löe
)

401 
ßved_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
boŸ_comm™d_löe
)+1);

402 
°©ic_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
comm™d_löe
)+1);

403 
	`°r˝y
 (
ßved_comm™d_löe
, 
boŸ_comm™d_löe
);

404 
	`°r˝y
 (
°©ic_comm™d_löe
, 
comm™d_löe
);

405 
	}
}

416 
noölöe
 
__öô_ªfok
 
	$ª°_öô
()

417 
	$__ªÀa£s
(
kî√l_lock
)

419 
pid
;

421 
	`rcu_scheduÀr_°¨tög
();

422 
	`kî√l_thªad
(
kî√l_öô
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

423 
	`numa_deÁu…_pﬁicy
();

424 
pid
 = 
	`kî√l_thªad
(
kthªadd
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

425 
kthªadd_èsk
 = 
	`föd_èsk_by_pid_ns
(
pid
, &
öô_pid_ns
);

426 
	`u∆ock_kî√l
();

432 
	`öô_idÀ_boŸup_èsk
(
cuºít
);

433 
	`¥ìm±_íabÀ_no_ªsched
();

434 
	`scheduÀ
();

435 
	`¥ìm±_dißbÀ
();

438 
	`˝u_idÀ
();

439 
	}
}

442 
__öô
 
	$do_óæy_∑øm
(*
∑øm
, *
vÆ
)

444 
obs_kî√l_∑øm
 *
p
;

446 
p
 = 
__£tup_°¨t
;Ö < 
__£tup_íd
;Ö++) {

447 i‡((
p
->
óæy
 && 
	`°rcmp
(
∑øm
,Ö->
°r
) == 0) ||

448 (
	`°rcmp
(
∑øm
, "console") == 0 &&

449 
	`°rcmp
(
p
->
°r
, "earlycon") == 0)

451 i‡(
p
->
	`£tup_func
(
vÆ
) != 0)

452 
	`¥ötk
(
KERN_WARNING


453 "MÆf‹medÉ¨ly o±i⁄ '%s'\n", 
∑øm
);

458 
	}
}

460 
__öô
 
	$∑r£_óæy_›ti⁄s
(*
cmdlöe
)

462 
	`∑r£_¨gs
("óæy o±i⁄s", 
cmdlöe
, 
NULL
, 0, 
do_óæy_∑øm
);

463 
	}
}

466 
__öô
 
	$∑r£_óæy_∑øm
()

468 
__öôd©a
 
d⁄e
 = 0;

469 
__öôd©a
 
tmp_cmdlöe
[
COMMAND_LINE_SIZE
];

471 i‡(
d⁄e
)

475 
	`°æ˝y
(
tmp_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

476 
	`∑r£_óæy_›ti⁄s
(
tmp_cmdlöe
);

477 
d⁄e
 = 1;

478 
	}
}

484 
__öô
 
	$boŸ_˝u_öô
()

486 
˝u
 = 
	`smp_¥o˚ss‹_id
();

488 
	`£t_˝u_⁄löe
(
˝u
, 
åue
);

489 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

490 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

491 
	}
}

493 
__öô
 
__wók
 
	$smp_£tup_¥o˚ss‹_id
()

495 
	}
}

497 
__öô
 
__wók
 
	$thªad_öfo_ˇche_öô
()

499 
	}
}

504 
__öô
 
	$mm_öô
()

510 
	`∑ge_cgroup_öô_Ê©mem
();

511 
	`mem_öô
();

512 
	`kmem_ˇche_öô
();

513 
	`pgèbÀ_ˇche_öô
();

514 
	`vmÆloc_öô
();

515 
	}
}

517 
asmlökage
 
__öô
 
	$°¨t_kî√l
()

519 * 
comm™d_löe
;

520 
kî√l_∑øm
 
__°¨t___∑øm
[], 
__°›___∑øm
[];

522 
	`smp_£tup_¥o˚ss‹_id
();

528 
	`lockdï_öô
();

529 
	`debug_obje˘s_óæy_öô
();

534 
	`boŸ_öô_°ack_ˇ«ry
();

536 
	`cgroup_öô_óæy
();

538 
	`loˇl_úq_dißbÀ
();

539 
	`óæy_boŸ_úqs_off
();

540 
	`óæy_öô_úq_lock_˛ass
();

546 
	`lock_kî√l
();

547 
	`tick_öô
();

548 
	`boŸ_˝u_öô
();

549 
	`∑ge_addªss_öô
();

550 
	`¥ötk
(
KERN_NOTICE
 "%s", 
löux_b™√r
);

551 
	`£tup_¨ch
(&
comm™d_löe
);

552 
	`mm_öô_ow√r
(&
öô_mm
, &
öô_èsk
);

553 
	`£tup_comm™d_löe
(
comm™d_löe
);

554 
	`£tup_ƒ_˝u_ids
();

555 
	`£tup_≥r_˝u_¨ós
();

556 
	`smp_¥ï¨e_boŸ_˝u
();

558 
	`buûd_Æl_z⁄ñi°s
();

559 
	`∑ge_Æloc_öô
();

561 
	`¥ötk
(
KERN_NOTICE
 "Kî√»comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

562 
	`∑r£_óæy_∑øm
();

563 
	`∑r£_¨gs
("BoŸög kî√l", 
°©ic_comm™d_löe
, 
__°¨t___∑øm
,

564 
__°›___∑øm
 - 
__°¨t___∑øm
,

565 &
unknown_boŸ›ti⁄
);

570 
	`pidhash_öô
();

571 
	`vfs_ˇches_öô_óæy
();

572 
	`s‹t_maö_exèbÀ
();

573 
	`å≠_öô
();

574 
	`mm_öô
();

580 
	`sched_öô
();

585 
	`¥ìm±_dißbÀ
();

586 i‡(!
	`úqs_dißbÀd
()) {

587 
	`¥ötk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

589 
	`loˇl_úq_dißbÀ
();

591 
	`rcu_öô
();

593 
	`óæy_úq_öô
();

594 
	`öô_IRQ
();

595 
	`¥io_åì_öô
();

596 
	`öô_timîs
();

597 
	`hπimîs_öô
();

598 
	`so·úq_öô
();

599 
	`timekìpög_öô
();

600 
	`time_öô
();

601 
	`¥ofûe_öô
();

602 i‡(!
	`úqs_dißbÀd
())

603 
	`¥ötk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

605 
	`óæy_boŸ_úqs_⁄
();

606 
	`loˇl_úq_íabÀ
();

609 
	`£t_gÂ_Ælowed_mask
(
__GFP_BITS_MASK
);

611 
	`kmem_ˇche_öô_œã
();

618 
	`c⁄sﬁe_öô
();

619 i‡(
∑nic_œãr
)

620 
	`∑nic
(
∑nic_œãr
, 
∑nic_∑øm
);

622 
	`lockdï_öfo
();

629 
	`lockög_£l·e°
();

631 #ifde‡
CONFIG_BLK_DEV_INITRD


632 i‡(
öôrd_°¨t
 && !
öôrd_bñow_°¨t_ok
 &&

633 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)Ë< 
mö_low_p‚
) {

634 
	`¥ötk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

636 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)),

637 
mö_low_p‚
);

638 
öôrd_°¨t
 = 0;

641 
	`∑ge_cgroup_öô
();

642 
	`íabÀ_debug_∑góŒoc
();

643 
	`kmemåa˚_öô
();

644 
	`kmemÀak_öô
();

645 
	`debug_obje˘s_mem_öô
();

646 
	`idr_öô_ˇche
();

647 
	`£tup_≥r_˝u_∑ge£t
();

648 
	`numa_pﬁicy_öô
();

649 i‡(
œã_time_öô
)

650 
	`œã_time_öô
();

651 
	`sched_˛ock_öô
();

652 
	`ˇlibøã_dñay
();

653 
	`pidm≠_öô
();

654 
	`™⁄_vma_öô
();

655 #ifde‡
CONFIG_X86


656 i‡(
efi_íabÀd
)

657 
	`efi_íãr_vútuÆ_mode
();

659 
	`thªad_öfo_ˇche_öô
();

660 
	`¸ed_öô
();

661 
	`f‹k_öô
(
tŸÆøm_∑ges
);

662 
	`¥oc_ˇches_öô
();

663 
	`buf„r_öô
();

664 
	`key_öô
();

665 
	`£curôy_öô
();

666 
	`vfs_ˇches_öô
(
tŸÆøm_∑ges
);

667 
	`ødix_åì_öô
();

668 
	`sig«ls_öô
();

670 
	`∑ge_wrôeback_öô
();

671 #ifde‡
CONFIG_PROC_FS


672 
	`¥oc_roŸ_öô
();

674 
	`cgroup_öô
();

675 
	`˝u£t_öô
();

676 
	`èsk°©s_öô_óæy
();

677 
	`dñayac˘_öô
();

679 
	`check_bugs
();

681 
	`a˝i_óæy_öô
();

682 
	`sfi_öô_œã
();

684 
	`·ø˚_öô
();

687 
	`ª°_öô
();

688 
	}
}

691 
__öô
 
	$do_˘‹s
()

693 #ifde‡
CONFIG_CONSTRUCTORS


694 
˘‹_‚_t
 *
ˇŒ
 = (˘‹_‚_à*Ë
__˘‹s_°¨t
;

696 ; 
ˇŒ
 < (
˘‹_‚_t
 *Ë
__˘‹s_íd
; call++)

697 (*
ˇŒ
)();

699 
	}
}

701 
	göôˇŒ_debug
;

702 
c‹e_∑øm
(
öôˇŒ_debug
, inôˇŒ_debug, 
boﬁ
, 0644);

704 
	gmsgbuf
[64];

705 
boŸ_åa˚_ˇŒ
 
	gˇŒ
;

706 
boŸ_åa˚_ªt
 
	gªt
;

708 
	$do_⁄e_öôˇŒ
(
öôˇŒ_t
 
‚
)

710 
cou¡
 = 
	`¥ìm±_cou¡
();

711 
ktime_t
 
ˇŒtime
, 
dñè
, 
ªâime
;

713 i‡(
öôˇŒ_debug
) {

714 
ˇŒ
.
ˇŒî
 = 
	`èsk_pid_ƒ
(
cuºít
);

715 
	`¥ötk
("ˇŒög %pF @ %i\n", 
‚
, 
ˇŒ
.
ˇŒî
);

716 
ˇŒtime
 = 
	`ktime_gë
();

717 
	`åa˚_boŸ_ˇŒ
(&
ˇŒ
, 
‚
);

718 
	`íabÀ_boŸ_åa˚
();

721 
ªt
.
ªsu…
 = 
	`‚
();

723 i‡(
öôˇŒ_debug
) {

724 
	`dißbÀ_boŸ_åa˚
();

725 
ªâime
 = 
	`ktime_gë
();

726 
dñè
 = 
	`ktime_sub
(
ªâime
, 
ˇŒtime
);

727 
ªt
.
duøti⁄
 = (Ë
	`ktime_to_ns
(
dñè
) >> 10;

728 
	`åa˚_boŸ_ªt
(&
ªt
, 
‚
);

729 
	`¥ötk
("öôˇŒ %pFÑëu∫ed %dá·î %Ld u£cs\n", 
‚
,

730 
ªt
.
ªsu…
,Ñë.
duøti⁄
);

733 
msgbuf
[0] = 0;

735 i‡(
ªt
.
ªsu…
 &&Ñë.ªsu… !-
ENODEV
 && 
öôˇŒ_debug
)

736 
	`•rötf
(
msgbuf
, "îr‹ codê%d ", 
ªt
.
ªsu…
);

738 i‡(
	`¥ìm±_cou¡
(Ë!
cou¡
) {

739 
	`°æˇt
(
msgbuf
, "preemption imbalance ", (msgbuf));

740 
	`¥ìm±_cou¡
(Ë
cou¡
;

742 i‡(
	`úqs_dißbÀd
()) {

743 
	`°æˇt
(
msgbuf
, "disabled interrupts ", (msgbuf));

744 
	`loˇl_úq_íabÀ
();

746 i‡(
msgbuf
[0]) {

747 
	`¥ötk
("öôˇŒ %pFÑëu∫ed wôh %s\n", 
‚
, 
msgbuf
);

750  
ªt
.
ªsu…
;

751 
	}
}

754 
öôˇŒ_t
 
__öôˇŒ_°¨t
[], 
__öôˇŒ_íd
[], 
__óæy_öôˇŒ_íd
[];

756 
__öô
 
	$do_öôˇŒs
()

758 
öôˇŒ_t
 *
ˇŒ
;

760 
ˇŒ
 = 
__óæy_öôˇŒ_íd
; cÆ»< 
__öôˇŒ_íd
; call++)

761 
	`do_⁄e_öôˇŒ
(*
ˇŒ
);

764 
	`Êush_scheduÀd_w‹k
();

765 
	}
}

774 
__öô
 
	$do_basic_£tup
()

776 
	`öô_w‹kqueues
();

777 
	`˝u£t_öô_smp
();

778 
	`u£rmodehñ≥r_öô
();

779 
	`öô_tmpfs
();

780 
	`drivî_öô
();

781 
	`öô_úq_¥oc
();

782 
	`do_˘‹s
();

783 
	`do_öôˇŒs
();

784 
	}
}

786 
__öô
 
	$do_¥e_smp_öôˇŒs
()

788 
öôˇŒ_t
 *
ˇŒ
;

790 
ˇŒ
 = 
__öôˇŒ_°¨t
; cÆ»< 
__óæy_öôˇŒ_íd
; call++)

791 
	`do_⁄e_öôˇŒ
(*
ˇŒ
);

792 
	}
}

794 
	$run_öô_¥o˚ss
(*
öô_fûíame
)

796 
¨gv_öô
[0] = 
öô_fûíame
;

797 
	`kî√l_execve
(
öô_fûíame
, 
¨gv_öô
, 
ívp_öô
);

798 
	}
}

803 
noölöe
 
	$öô_po°
()

804 
	$__ªÀa£s
(
kî√l_lock
)

807 
	`async_synchr⁄ize_fuŒ
();

808 
	`‰ì_öômem
();

809 
	`u∆ock_kî√l
();

810 
	`m¨k_rod©a_ro
();

811 
sy°em_°©e
 = 
SYSTEM_RUNNING
;

812 
	`numa_deÁu…_pﬁicy
();

814 i‡(
	`sys_›í
((c⁄° 
__u£r
 *Ë"/dev/c⁄sﬁe", 
O_RDWR
, 0) < 0)

815 
	`¥ötk
(
KERN_WARNING
 "Warning: unableÅo openán initial console.\n");

817 (Ë
	`sys_dup
(0);

818 (Ë
	`sys_dup
(0);

820 
cuºít
->
sig«l
->
Êags
 |
SIGNAL_UNKILLABLE
;

822 i‡(
ømdisk_execuã_comm™d
) {

823 
	`run_öô_¥o˚ss
(
ømdisk_execuã_comm™d
);

824 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s\n",

825 
ømdisk_execuã_comm™d
);

834 i‡(
execuã_comm™d
) {

835 
	`run_öô_¥o˚ss
(
execuã_comm™d
);

836 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s. Attempting "

837 "deÁu…s...\n", 
execuã_comm™d
);

839 
	`run_öô_¥o˚ss
("/sbin/init");

840 
	`run_öô_¥o˚ss
("/etc/init");

841 
	`run_öô_¥o˚ss
("/bin/init");

842 
	`run_öô_¥o˚ss
("/bin/sh");

844 
	`∑nic
("No init found. TryÖassing init= optionÅo kernel.");

845 
	}
}

847 
__öô
 
	$kî√l_öô
(* 
unu£d
)

849 
	`lock_kî√l
();

854 
	`£t_mems_Ælowed
(
node_possibÀ_m≠
);

858 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
˝u_Æl_mask
);

867 
öô_pid_ns
.
chûd_ª≠î
 = 
cuºít
;

869 
ˇd_pid
 = 
	`èsk_pid
(
cuºít
);

871 
	`smp_¥ï¨e_˝us
(
£tup_max_˝us
);

873 
	`do_¥e_smp_öôˇŒs
();

874 
	`°¨t_boŸ_åa˚
();

876 
	`smp_öô
();

877 
	`sched_öô_smp
();

879 
	`do_basic_£tup
();

886 i‡(!
ømdisk_execuã_comm™d
)

887 
ømdisk_execuã_comm™d
 = "/init";

889 i‡(
	`sys_ac˚ss
((c⁄° 
__u£r
 *Ë
ømdisk_execuã_comm™d
, 0) != 0) {

890 
ømdisk_execuã_comm™d
 = 
NULL
;

891 
	`¥ï¨e_«me•a˚
();

900 
	`öô_po°
();

902 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<löux/compûe.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/uts.h
>

12 
	~<löux/ut¢ame.h
>

13 
	~<löux/ut§ñó£.h
>

14 
	~<löux/vîsi⁄.h
>

16 #i‚de‡
CONFIG_KALLSYMS


17 
	#vîsi⁄
(
a
Ë
Vîsi⁄_
 ## 
	)
a

18 
	#vîsi⁄_°rög
(
a
Ë
	`vîsi⁄
◊)

	)

20 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

21 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

24 
uts_«me•a˚
 
	göô_uts_ns
 = {

25 .
kªf
 = {

26 .
ªfcou¡
 = 
ATOMIC_INIT
(2),

28 .
	g«me
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnodíame
 = 
UTS_NODENAME
,

31 .
	gªÀa£
 = 
UTS_RELEASE
,

32 .
	gvîsi⁄
 = 
UTS_VERSION
,

33 .
	gmachöe
 = 
UTS_MACHINE
,

34 .
	gdomaö«me
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
öô_uts_ns
);

40 c⁄° 
	glöux_b™√r
[] =

41 "Löux vîsi⁄ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "Ë(" 
LINUX_COMPILER
 "Ë" 
UTS_VERSION
 "\n";

44 c⁄° 
	glöux_¥oc_b™√r
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
156
6633
/cmpt816/linux/arch/x86/ia32/audit.c
/cmpt816/linux/arch/x86/ia32/ia32_signal.c
/cmpt816/linux/arch/x86/ia32/ipc32.c
/cmpt816/linux/arch/x86/ia32/sys_ia32.c
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/processor.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c
/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/sched.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/x86_init.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/physaddr.c
/cmpt816/linux/arch/x86/mm/setup_nx.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
