cscope 15 /cmpt816/data -q 0000006466 0000718287
	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<lšux/š™.h
>

27 
	~<lšux/aıi.h
>

28 
	~<lšux/aıi_pmtmr.h
>

29 
	~<lšux/efi.h
>

30 
	~<lšux/ıumask.h
>

31 
	~<lšux/moduË.h
>

32 
	~<lšux/dmi.h
>

33 
	~<lšux/œq.h
>

34 
	~<lšux/boÙmem.h
>

35 
	~<lšux/iİÜt.h
>

37 
	~<asm/pgbË.h
>

38 
	~<asm/io_­ic.h
>

39 
	~<asm/­ic.h
>

40 
	~<asm/io.h
>

41 
	~<asm/mp¥ec.h
>

43 
__š™d©a
 
	gaıi_fÜû
 = 0;

45 #ifdef 
CONFIG_ACPI


46 
	gaıi_di§bËd
 = 0;

48 
	gaıi_di§bËd
 = 1;

50 
EXPORT_SYMBOL
(
aıi_di§bËd
);

52 #ifdef 
CONFIG_X86_64


54 
	~<asm/´Ùo.h
>

56 
šlše
 
	$aıi_madt_Ûm_check
(*
Ûm_id
, *
Ûm_bË_id
è{  0; 
	}
}

61 #ifdef 
CONFIG_X86_LOCAL_APIC


62 
	~<mach_­ic.h
>

63 
	~<mach_mµ¬£.h
>

68 
	#BAD_MADT_ENTRY
(
’Œy
, 
’d
) ( \

69 (!
’Œy
è|| (ëÁry + (*’Œyè> 
’d
 || \

70 ((
aıi_subbË_h—d”
 *)
’Œy
)->
Ëngth
 < (*’Œy))

	)

72 
	#PREFIX
 "ACPI: "

	)

74 
	gaıi_noœq
;

75 
aıi_pci_di§bËd
 
	g__š™d©a
;

76 
aıi_ht
 
	g__š™d©a
 = 1;

78 
	gaıi_Ïpic
;

79 
	gaıi_ißpic
;

80 
	gaıi_¡riù
;

81 
EXPORT_SYMBOL
(
aıi_¡riù
);

83 
u8
 
aıi_sci_æags
 
	g__š™d©a
;

84 
aıi_sci_ov”ride_gsi
 
	g__š™d©a
;

85 
aıi_sk_tim”_ov”ride
 
	g__š™d©a
;

86 
aıi_u£_tim”_ov”ride
 
	g__š™d©a
;

88 #ifdeà
CONFIG_X86_LOCAL_APIC


89 
u64
 
aıi_Ïpic_addr
 
	g__š™d©a
 = 
APIC_DEFAULT_PHYS_BASE
;

92 #iâdeà
__HAVE_ARCH_CMPXCHG


93 #w¬nšg 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
ªd
 
Ï‹r
 
h¬dw¬e


104 
aıi_œq_mod–_id
 
	gaıi_œq_mod–
 = 
ACPI_IRQ_MODEL_PIC
;

106 #ifdef 
CONFIG_X86_64


109 *
	$__aıi_m­_bË
(
phys_addr
, 
size
)

111 ià(!
phys_addr
 || !
size
)

112  
NULL
;

114 ià(
phys_addr
+
size
 <ğ(
’d_pâ_m­
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
)

115  
	`__va
(
phys_addr
);

117  
NULL
;

118 
	}
}

134 *
	$__aıi_m­_bË
(
phys
, 
size
)

136 
ba£
, 
off£t
, 
m­³d_size
;

137 
idx
;

139 ià(
phys
 + 
size
 < 8 * 1024 * 1024)

140  
	`__va
(
phys
);

142 
off£t
 = 
phys
 & (
PAGE_SIZE
 - 1);

143 
m­³d_size
 = 
PAGE_SIZE
 - 
off£t
;

144 
	`£t_fixm­
(
FIX_ACPI_END
, 
phys
);

145 
ba£
 = 
	`fix_to_vœt
(
FIX_ACPI_END
);

150 
idx
 = 
FIX_ACPI_END
;

151 
m­³d_size
 < 
size
) {

152 ià(--
idx
 < 
FIX_ACPI_BEGIN
)

153  
NULL
;

154 
phys
 +ğ
PAGE_SIZE
;

155 
	`£t_fixm­
(
idx
, 
phys
);

156 
m­³d_size
 +ğ
PAGE_SIZE
;

159  ((*)
ba£
 + 
off£t
);

160 
	}
}

163 #ifdeà
CONFIG_PCI_MMCONFIG


165 
aıi_mcfg_®loÿtiÚ
 *
	gpci_mmcfg_cÚfig
;

166 
	gpci_mmcfg_cÚfig_num
;

168 
__š™
 
	$aıi_·r£_mcfg
(
aıi_bË_h—d”
 *
h—d”
)

170 
aıi_bË_mcfg
 *
mcfg
;

171 
i
;

172 
cÚfig_size
;

174 ià(!
h—d”
)

175  -
EINVAL
;

177 
mcfg
 = (
aıi_bË_mcfg
 *)
h—d”
;

180 
pci_mmcfg_cÚfig_num
 = 0;

181 
i
 = 
h—d”
->
Ëngth
 - (
aıi_bË_mcfg
);

182 
i
 >ğ(
aıi_mcfg_®loÿtiÚ
)) {

183 ++
pci_mmcfg_cÚfig_num
;

184 
i
 -ğ(
aıi_mcfg_®loÿtiÚ
);

186 ià(
pci_mmcfg_cÚfig_num
 == 0) {

187 
	`´štk
(
KERN_ERR
 
PREFIX
 "MMCONFIG has‚oƒntries\n");

188  -
ENODEV
;

191 
cÚfig_size
 = 
pci_mmcfg_cÚfig_num
 * (*
pci_mmcfg_cÚfig
);

192 
pci_mmcfg_cÚfig
 = 
	`km®loc
(
cÚfig_size
, 
GFP_KERNEL
);

193 ià(!
pci_mmcfg_cÚfig
) {

194 
	`´štk
(
KERN_WARNING
 
PREFIX


196  -
ENOMEM
;

199 
	`memıy
(
pci_mmcfg_cÚfig
, &
mcfg
[1], 
cÚfig_size
);

200 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

201 ià(
pci_mmcfg_cÚfig
[
i
].
add»ss
 > 0xFFFFFFFF) {

202 
	`´štk
(
KERN_ERR
 
PREFIX


204 
	`kä“
(
pci_mmcfg_cÚfig
);

205 
pci_mmcfg_cÚfig_num
 = 0;

206  -
ENODEV
;

211 
	}
}

214 #ifdeà
CONFIG_X86_LOCAL_APIC


215 
__š™
 
	$aıi_·r£_madt
(
aıi_bË_h—d”
 *
bË
)

217 
aıi_bË_madt
 *
madt
 = 
NULL
;

219 ià(!
ıu_has_­ic
)

220  -
EINVAL
;

222 
madt
 = (
aıi_bË_madt
 *)
bË
;

223 ià(!
madt
) {

224 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map MADT\n");

225  -
ENODEV
;

228 ià(
madt
->
add»ss
) {

229 
aıi_Ïpic_addr
 = (
u64
è
madt
->
add»ss
;

231 
	`´štk
(
KERN_DEBUG
 
PREFIX
 "Local APIC‡ddress 0x%08x\n",

232 
madt
->
add»ss
);

235 
	`aıi_madt_Ûm_check
(
madt
->
h—d”
.
Ûm_id
, madt->h—d”.
Ûm_bË_id
);

238 
	}
}

240 
__š™


241 
	$aıi_·r£_Ïpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

243 
aıi_madt_loÿl_­ic
 *
´oûssÜ
 = 
NULL
;

245 
´oûssÜ
 = (
aıi_madt_loÿl_­ic
 *)
h—d”
;

247 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

248  -
EINVAL
;

250 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

259 
	`mp_»gi¡”_Ïpic
(
´oûssÜ
->
id
,

260 
´oûssÜ
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

263 
	}
}

265 
__š™


266 
	$aıi_·r£_Ïpic_addr_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

267 cÚ¡ 
’d
)

269 
aıi_madt_loÿl_­ic_ov”ride
 *
Ïpic_addr_ovr
 = 
NULL
;

271 
Ïpic_addr_ovr
 = (
aıi_madt_loÿl_­ic_ov”ride
 *)
h—d”
;

273 ià(
	`BAD_MADT_ENTRY
(
Ïpic_addr_ovr
, 
’d
))

274  -
EINVAL
;

276 
aıi_Ïpic_addr
 = 
Ïpic_addr_ovr
->
add»ss
;

279 
	}
}

281 
__š™


282 
	$aıi_·r£_Ïpic_nmi
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

284 
aıi_madt_loÿl_­ic_nmi
 *
Ïpic_nmi
 = 
NULL
;

286 
Ïpic_nmi
 = (
aıi_madt_loÿl_­ic_nmi
 *)
h—d”
;

288 ià(
	`BAD_MADT_ENTRY
(
Ïpic_nmi
, 
’d
))

289  -
EINVAL
;

291 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

293 ià(
Ïpic_nmi
->
lšt
 != 1)

294 
	`´štk
(
KERN_WARNING
 
PREFIX
 "NMI‚ot connectedo LINT 1!\n");

297 
	}
}

301 #ifdeà
CONFIG_X86_IO_APIC


303 
__š™


304 
	$aıi_·r£_ißpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

306 
aıi_madt_io_­ic
 *
ißpic
 = 
NULL
;

308 
ißpic
 = (
aıi_madt_io_­ic
 *)
h—d”
;

310 ià(
	`BAD_MADT_ENTRY
(
ißpic
, 
’d
))

311  -
EINVAL
;

313 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

315 
	`mp_»gi¡”_ißpic
(
ißpic
->
id
,

316 
ißpic
->
add»ss
, ißpic->
glob®_œq_ba£
);

319 
	}
}

324 
__š™
 
	$aıi_sci_ißpic_£tup
(
u32
 
gsi
, 
u16
 
pŞ¬™y
, u16 
Œigg”
)

326 ià(
Œigg”
 == 0)

327 
Œigg”
 = 3;

329 ià(
pŞ¬™y
 == 0)

330 
pŞ¬™y
 = 3;

333 ià(
aıi_sci_æags
 & 
ACPI_MADT_TRIGGER_MASK
)

334 
Œigg”
 = (
aıi_sci_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

336 ià(
aıi_sci_æags
 & 
ACPI_MADT_POLARITY_MASK
)

337 
pŞ¬™y
 = 
aıi_sci_æags
 & 
ACPI_MADT_POLARITY_MASK
;

344 
	`mp_ov”ride_Ëgacy_œq
(
gsi
, 
pŞ¬™y
, 
Œigg”
, gsi);

350 
aıi_sci_ov”ride_gsi
 = 
gsi
;

352 
	}
}

354 
__š™


355 
	$aıi_·r£_št_¤c_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

356 cÚ¡ 
’d
)

358 
aıi_madt_š‹¼u±_ov”ride
 *
št¤c
 = 
NULL
;

360 
št¤c
 = (
aıi_madt_š‹¼u±_ov”ride
 *)
h—d”
;

362 ià(
	`BAD_MADT_ENTRY
(
št¤c
, 
’d
))

363  -
EINVAL
;

365 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

367 ià(
št¤c
->
sourû_œq
 =ğ
aıi_gbl_FADT
.
sci_š‹¼u±
) {

368 
	`aıi_sci_ißpic_£tup
(
št¤c
->
glob®_œq
,

369 
št¤c
->
šti_æags
 & 
ACPI_MADT_POLARITY_MASK
,

370 (
št¤c
->
šti_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2);

374 ià(
aıi_sk_tim”_ov”ride
 &&

375 
št¤c
->
sourû_œq
 =ğ0 && iÁ¤c->
glob®_œq
 == 2) {

376 
	`´štk
(
PREFIX
 "BIOS IRQ0…in2 override ignored.\n");

380 
	`mp_ov”ride_Ëgacy_œq
(
št¤c
->
sourû_œq
,

381 
št¤c
->
šti_æags
 & 
ACPI_MADT_POLARITY_MASK
,

382 (
št¤c
->
šti_æags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

383 
št¤c
->
glob®_œq
);

386 
	}
}

388 
__š™


389 
	$aıi_·r£_nmi_¤c
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

391 
aıi_madt_nmi_sourû
 *
nmi_¤c
 = 
NULL
;

393 
nmi_¤c
 = (
aıi_madt_nmi_sourû
 *)
h—d”
;

395 ià(
	`BAD_MADT_ENTRY
(
nmi_¤c
, 
’d
))

396  -
EINVAL
;

398 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

403 
	}
}

421 
__š™
 
	$aıi_pic_sci_£t_Œigg”
(
œq
, 
u16
 
Œigg”
)

423 
mask
 = 1 << 
œq
;

424 
Şd
, 
Ãw
;

427 
Şd
 = 
	`šb
(0x4d0) | (inb(0x4d1) << 8);

434 
Ãw
 = 
aıi_noœq
 ? 
Şd
 : 0;

440 
Œigg”
) {

442 
Ãw
 &ğ~
mask
;

445 
Ãw
 |ğ
mask
;

449 ià(
Şd
 =ğ
Ãw
)

452 
	`´štk
(
PREFIX
 "£‰šg ELCRØ%04x (äom %04x)\n", 
Ãw
, 
Şd
);

453 
	`outb
(
Ãw
, 0x4d0);

454 
	`outb
(
Ãw
 >> 8, 0x4d1);

455 
	}
}

457 
	$aıi_gsi_to_œq
(
u32
 
gsi
, *
œq
)

459 *
œq
 = 
gsi
;

461 
	}
}

467 
	$aıi_»gi¡”_gsi
(
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

469 
œq
;

470 
¶©_gsi
 = 
gsi
;

472 #ifdeà
CONFIG_PCI


476 ià(
aıi_œq_mod–
 =ğ
ACPI_IRQ_MODEL_PIC
) {

477 
	`ei§_£t_Ëv–_œq
(
œq
);

479 ià(
Œigg”šg
 =ğ
ACPI_LEVEL_SENSITIVE
)

480 
	`ei§_£t_Ëv–_œq
(
gsi
);

484 #ifdeà
CONFIG_X86_IO_APIC


485 ià(
aıi_œq_mod–
 =ğ
ACPI_IRQ_MODEL_IOAPIC
) {

486 
¶©_gsi
 = 
	`mp_»gi¡”_gsi
(
gsi
, 
Œigg”šg
, 
pŞ¬™y
);

489 
	`aıi_gsi_to_œq
(
¶©_gsi
, &
œq
);

490  
œq
;

491 
	}
}

493 
EXPORT_SYMBOL
(
aıi_»gi¡”_gsi
);

498 #ifdeà
CONFIG_ACPI_HOTPLUG_CPU


499 
	$aıi_m­_l§pic
(
aıi_hªdË
 
hªdË
, *
pıu
)

501 
aıi_bufãr
 
bufãr
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

502 
aıi_objeù
 *
obj
;

503 
aıi_madt_loÿl_­ic
 *
Ïpic
;

504 
ıumask_t
 
tmp_m­
, 
Ãw_m­
;

505 
u8
 
physid
;

506 
ıu
;

508 ià(
	`ACPI_FAILURE
(
	`aıi_ev®u©e_objeù
(
hªdË
, "_MAT", 
NULL
, &
bufãr
)))

509  -
EINVAL
;

511 ià(!
bufãr
.
Ëngth
 || !bufãr.
poš‹r
)

512  -
EINVAL
;

514 
obj
 = 
bufãr
.
poš‹r
;

515 ià(
obj
->
ty³
 !ğ
ACPI_TYPE_BUFFER
 ||

516 
obj
->
bufãr
.
Ëngth
 < (*
Ïpic
)) {

517 
	`kä“
(
bufãr
.
poš‹r
);

518  -
EINVAL
;

521 
Ïpic
 = (
aıi_madt_loÿl_­ic
 *)
obj
->
bufãr
.
poš‹r
;

523 ià(
Ïpic
->
h—d”
.
ty³
 !ğ
ACPI_MADT_TYPE_LOCAL_APIC
 ||

524 !(
Ïpic
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
)) {

525 
	`kä“
(
bufãr
.
poš‹r
);

526  -
EINVAL
;

529 
physid
 = 
Ïpic
->
id
;

531 
	`kä“
(
bufãr
.
poš‹r
);

532 
bufãr
.
Ëngth
 = 
ACPI_ALLOCATE_BUFFER
;

533 
bufãr
.
poš‹r
 = 
NULL
;

535 
tmp_m­
 = 
ıu_´e£Á_m­
;

536 
	`mp_»gi¡”_Ïpic
(
physid
, 
Ïpic
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
);

542 
	`ıus_ªdnÙ
(
Ãw_m­
, 
ıu_´e£Á_m­
, 
tmp_m­
);

543 ià(
	`ıus_em±y
(
Ãw_m­
)) {

544 
	`´štk
 ("Unableo map†apico†ogical cpu‚umber\n");

545  -
EINVAL
;

548 
ıu
 = 
	`fœ¡_ıu
(
Ãw_m­
);

550 *
pıu
 = 
ıu
;

552 
	}
}

554 
EXPORT_SYMBOL
(
aıi_m­_l§pic
);

556 
	$aıi_unm­_l§pic
(
ıu
)

558 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
) = -1;

559 
	`ıu_ş—r
(
ıu
, 
ıu_´e£Á_m­
);

560 
num_´oûssÜs
--;

563 
	}
}

565 
EXPORT_SYMBOL
(
aıi_unm­_l§pic
);

568 
	$aıi_»gi¡”_ißpic
(
aıi_hªdË
 
hªdË
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

571  -
EINVAL
;

572 
	}
}

574 
EXPORT_SYMBOL
(
aıi_»gi¡”_ißpic
);

576 
	$aıi_uÄegi¡”_ißpic
(
aıi_hªdË
 
hªdË
, 
u32
 
gsi_ba£
)

579  -
EINVAL
;

580 
	}
}

582 
EXPORT_SYMBOL
(
aıi_uÄegi¡”_ißpic
);

584 
__š™


585 
	$aıi_sÿn_rsdp
(
¡¬t
, 
Ëngth
)

587 
off£t
 = 0;

588 
sig_Ën
 = ("RSD PTR ") - 1;

594 
off£t
 = 0; off£ˆ< 
Ëngth
; offset += 16) {

595 ià(
	`¡ºcmp
((*)(
	`phys_to_vœt
(
¡¬t
è+ 
off£t
), "RSD PTR ", 
sig_Ën
))

597  (
¡¬t
 + 
off£t
);

601 
	}
}

603 
__š™
 
	$aıi_·r£_sbf
(
aıi_bË_h—d”
 *
bË
)

605 
aıi_bË_boÙ
 *
sb
;

607 
sb
 = (
aıi_bË_boÙ
 *)
bË
;

608 ià(!
sb
) {

609 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map SBF\n");

610  -
ENODEV
;

613 
sbf_pÜt
 = 
sb
->
cmos_šdex
;

616 
	}
}

618 #ifdeà
CONFIG_HPET_TIMER


619 
	~<asm/h³t.h
>

621 
__š™d©a
 
»sourû
 *
	gh³t_»s
;

623 
__š™
 
	$aıi_·r£_h³t
(
aıi_bË_h—d”
 *
bË
)

625 
aıi_bË_h³t
 *
h³t_tbl
;

627 
h³t_tbl
 = (
aıi_bË_h³t
 *)
bË
;

628 ià(!
h³t_tbl
) {

629 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map HPET\n");

630  -
ENODEV
;

633 ià(
h³t_tbl
->
add»ss
.
¥aû_id
 !ğ
ACPI_SPACE_MEM
) {

634 
	`´štk
(
KERN_WARNING
 
PREFIX
 "HPETimers must be†ocated in "

639 
h³t_add»ss
 = 
h³t_tbl
->
add»ss
.address;

645 ià(!
h³t_add»ss
) {

646 
	`´štk
(
KERN_WARNING
 
PREFIX


648 
h³t_tbl
->
id
, 
h³t_add»ss
);

651 #ifdeà
CONFIG_X86_64


657 ià(
h³t_add»ss
 == 0xfed0000000000000UL) {

658 ià(!
h³t_fÜû_u£r
) {

659 
	`´štk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

662 "fix iˆu°tØ0xãd00000.\n", 
h³t_tbl
->
id
);

663 
h³t_add»ss
 = 0;

666 
	`´štk
(
KERN_WARNING
 
PREFIX


668 "tØ0xãd00000.\n", 
h³t_tbl
->
id
);

669 
h³t_add»ss
 >>= 32;

672 
	`´štk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

673 
h³t_tbl
->
id
, 
h³t_add»ss
);

679 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

680 
h³t_»s
 = 
	`®loc_boÙmem
((*h³t_»sè+ 
HPET_RESOURCE_NAME_SIZE
);

682 ià(!
h³t_»s
)

685 
	`mem£t
(
h³t_»s
, 0, (*hpet_res));

686 
h³t_»s
->
Çme
 = (*)&hpet_res[1];

687 
h³t_»s
->
æags
 = 
IORESOURCE_MEM
;

688 
	`¢´štf
((*)
h³t_»s
->
Çme
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

689 
h³t_tbl
->
£qu’û
);

691 
h³t_»s
->
¡¬t
 = 
h³t_add»ss
;

692 
h³t_»s
->
’d
 = 
h³t_add»ss
 + (1 * 1024) - 1;

695 
	}
}

701 
__š™
 
	$h³t_š£¹_»sourû
()

703 ià(!
h³t_»s
)

706  
	`š£¹_»sourû
(&
iomem_»sourû
, 
h³t_»s
);

707 
	}
}

709 
Ï‹_š™ÿÎ
(
h³t_š£¹_»sourû
);

712 
	#aıi_·r£_h³t
 
NULL


	)

715 
__š™
 
	$aıi_·r£_çdt
(
aıi_bË_h—d”
 *
bË
)

718 #ifdeà
CONFIG_X86_PM_TIMER


720 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
) {

722 ià(
aıi_gbl_FADT
.
xpm_tim”_block
.
¥aû_id
 !=

723 
ACPI_ADR_SPACE_SYSTEM_IO
)

726 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
xpm_tim”_block
.
add»ss
;

732 ià(!
pmtmr_iİÜt
)

733 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
pm_tim”_block
;

736 
pmtmr_iİÜt
 = 
aıi_gbl_FADT
.
pm_tim”_block
;

738 ià(
pmtmr_iİÜt
)

739 
	`´štk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

740 
pmtmr_iİÜt
);

743 
	}
}

745 
__š™
 
	$aıi_fšd_rsdp
()

747 
rsdp_phys
 = 0;

749 ià(
efi_’abËd
) {

750 ià(
efi
.
aıi20
 !ğ
EFI_INVALID_TABLE_ADDR
)

751  
efi
.
aıi20
;

752 ià(
efi
.
aıi
 !ğ
EFI_INVALID_TABLE_ADDR
)

753  
efi
.
aıi
;

759 
rsdp_phys
 = 
	`aıi_sÿn_rsdp
(0, 0x400);

760 ià(!
rsdp_phys
)

761 
rsdp_phys
 = 
	`aıi_sÿn_rsdp
(0xE0000, 0x20000);

763  
rsdp_phys
;

764 
	}
}

766 #ifdef 
CONFIG_X86_LOCAL_APIC


771 
__š™
 
	$aıi_·r£_madt_Ïpic_’Œ›s
()

773 
couÁ
;

775 ià(!
ıu_has_­ic
)

776  -
ENODEV
;

783 
couÁ
 =

784 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

785 
aıi_·r£_Ïpic_addr_ovr
, 0);

786 ià(
couÁ
 < 0) {

787 
	`´štk
(
KERN_ERR
 
PREFIX


789  
couÁ
;

792 
	`mp_»gi¡”_Ïpic_add»ss
(
aıi_Ïpic_addr
);

794 
couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
, 
aıi_·r£_Ïpic
,

795 
MAX_APICS
);

796 ià(!
couÁ
) {

797 
	`´štk
(
KERN_ERR
 
PREFIX
 "No LAPICƒntries…resent\n");

799  -
ENODEV
;

800 } ià(
couÁ
 < 0) {

801 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPICƒntry\n");

803  
couÁ
;

806 
couÁ
 =

807 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
aıi_·r£_Ïpic_nmi
, 0);

808 ià(
couÁ
 < 0) {

809 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPIC NMIƒntry\n");

811  
couÁ
;

814 
	}
}

817 #ifdef 
CONFIG_X86_IO_APIC


822 
__š™
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

824 
couÁ
;

832 ià(
aıi_di§bËd
 || 
aıi_noœq
) {

833  -
ENODEV
;

836 ià(!
ıu_has_­ic
)

837  -
ENODEV
;

842 ià(
sk_ißpic_£tup
) {

843 
	`´štk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPIC…robe "

845  -
ENODEV
;

848 
couÁ
 =

849 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
aıi_·r£_ißpic
,

850 
MAX_IO_APICS
);

851 ià(!
couÁ
) {

852 
	`´štk
(
KERN_ERR
 
PREFIX
 "No IOAPICƒntries…resent\n");

853  -
ENODEV
;

854 } ià(
couÁ
 < 0) {

855 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing IOAPICƒntry\n");

856  
couÁ
;

859 
couÁ
 =

860 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
aıi_·r£_št_¤c_ovr
,

861 
NR_IRQ_VECTORS
);

862 ià(
couÁ
 < 0) {

863 
	`´štk
(
KERN_ERR
 
PREFIX


866  
couÁ
;

873 ià(!
aıi_sci_ov”ride_gsi
)

874 
	`aıi_sci_ißpic_£tup
(
aıi_gbl_FADT
.
sci_š‹¼u±
, 0, 0);

877 
	`mp_cÚfig_aıi_Ëgacy_œqs
();

879 
couÁ
 =

880 
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
aıi_·r£_nmi_¤c
,

881 
NR_IRQ_VECTORS
);

882 ià(
couÁ
 < 0) {

883 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing NMI SRCƒntry\n");

885  
couÁ
;

889 
	}
}

891 
šlše
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

894 
	}
}

897 
__š™
 
	$aıi_´oûss_madt
()

899 #ifdeà
CONFIG_X86_LOCAL_APIC


900 
”rÜ
;

902 ià(!
	`aıi_bË_·r£
(
ACPI_SIG_MADT
, 
aıi_·r£_madt
)) {

907 
”rÜ
 = 
	`aıi_·r£_madt_Ïpic_’Œ›s
();

908 ià(!
”rÜ
) {

909 
aıi_Ïpic
 = 1;

911 #ifdeà
CONFIG_X86_GENERICARCH


912 
	`g’”ic_bigsmp_´obe
();

917 
”rÜ
 = 
	`aıi_·r£_madt_ißpic_’Œ›s
();

918 ià(!
”rÜ
) {

919 
aıi_œq_mod–
 = 
ACPI_IRQ_MODEL_IOAPIC
;

920 
	`aıi_œq_b®ªû_£t
(
NULL
);

921 
aıi_ißpic
 = 1;

923 
smp_found_cÚfig
 = 1;

924 
	`£tup_­ic_routšg
();

927 ià(
”rÜ
 =ğ-
EINVAL
) {

931 
	`´štk
(
KERN_ERR
 
PREFIX


933 
	`di§bË_aıi
();

938 
	}
}

940 #ifdeà
__i386__


942 
__š™
 
	$di§bË_aıi_œq
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

944 ià(!
aıi_fÜû
) {

945 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=noirq\n",

946 
d
->
id’t
);

947 
	`aıi_noœq_£t
();

950 
	}
}

952 
__š™
 
	$di§bË_aıi_pci
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

954 ià(!
aıi_fÜû
) {

955 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of…ci=noacpi\n",

956 
d
->
id’t
);

957 
	`aıi_di§bË_pci
();

960 
	}
}

962 
__š™
 
	$dmi_di§bË_aıi
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

964 ià(!
aıi_fÜû
) {

965 
	`´štk
(
KERN_NOTICE
 "% d‘eùed:‡ı˜off\n", 
d
->
id’t
);

966 
	`di§bË_aıi
();

968 
	`´štk
(
KERN_NOTICE


972 
	}
}

977 
__š™
 
	$fÜû_aıi_ht
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

979 ià(!
aıi_fÜû
) {

980 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=ht\n",

981 
d
->
id’t
);

982 
	`di§bË_aıi
();

983 
aıi_ht
 = 1;

985 
	`´štk
(
KERN_NOTICE


989 
	}
}

995 
dmi_sy¡em_id
 
__š™d©a
 
	gaıi_dmi_bË
[] = {

1000 .
ÿÎback
 = 
dmi_di§bË_aıi
,

1001 .
	gid’t
 = "IBM Thinkpad",

1002 .
	gm©ches
 = {

1003 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1004 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1012 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1013 .
	gid’t
 = "FSC Primergy T850",

1014 .
	gm©ches
 = {

1015 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

1016 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

1020 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1021 .
	gid’t
 = "HP VISUALIZE NT Workstation",

1022 .
	gm©ches
 = {

1023 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

1024 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

1028 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1029 .
	gid’t
 = "Compaq Workstation W8000",

1030 .
	gm©ches
 = {

1031 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

1032 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

1036 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1037 .
	gid’t
 = "ASUS P4B266",

1038 .
	gm©ches
 = {

1039 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1040 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4B266"),

1044 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1045 .
	gid’t
 = "ASUS P2B-DS",

1046 .
	gm©ches
 = {

1047 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1048 
DMI_MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

1052 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1053 .
	gid’t
 = "ASUS CUR-DLS",

1054 .
	gm©ches
 = {

1055 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1056 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

1060 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1061 .
	gid’t
 = "ABIT i440BX-W83977",

1062 .
	gm©ches
 = {

1063 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

1064 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

1068 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1069 .
	gid’t
 = "IBM Bladecenter",

1070 .
	gm©ches
 = {

1071 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1072 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMƒServer BladeCenter HS20"),

1076 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1077 .
	gid’t
 = "IBMƒServer xSeries 360",

1078 .
	gm©ches
 = {

1079 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1080 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

1084 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1085 .
	gid’t
 = "IBMƒserver xSeries 330",

1086 .
	gm©ches
 = {

1087 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1088 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

1092 .
	gÿÎback
 = 
fÜû_aıi_ht
,

1093 .
	gid’t
 = "IBMƒserver xSeries 440",

1094 .
	gm©ches
 = {

1095 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1096 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

1104 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1105 .
	gid’t
 = "ASUS A7V",

1106 .
	gm©ches
 = {

1107 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1108 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1110 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1121 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1122 .
	gid’t
 = "IBM Thinkpad 600 Series 2645",

1123 .
	gm©ches
 = {

1124 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1125 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1129 .
	gÿÎback
 = 
di§bË_aıi_œq
,

1130 .
	gid’t
 = "IBM Thinkpad 600 Series 2646",

1131 .
	gm©ches
 = {

1132 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1133 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1140 .
	gÿÎback
 = 
di§bË_aıi_pci
,

1141 .
	gid’t
 = "ASUS PR-DLS",

1142 .
	gm©ches
 = {

1143 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1144 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1145 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1147 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1151 .
	gÿÎback
 = 
di§bË_aıi_pci
,

1152 .
	gid’t
 = "Acer TravelMate 36x Laptop",

1153 .
	gm©ches
 = {

1154 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1155 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1186 
__š™
 
	$aıi_boÙ_bË_š™
()

1188 
”rÜ
;

1190 #ifdeà
__i386__


1191 
	`dmi_check_sy¡em
(
aıi_dmi_bË
);

1198 ià(
aıi_di§bËd
 && !
aıi_ht
)

1204 
”rÜ
 = 
	`aıi_bË_š™
();

1205 ià(
”rÜ
) {

1206 
	`di§bË_aıi
();

1207  
”rÜ
;

1210 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

1215 
”rÜ
 = 
	`aıi_bÏckli¡ed
();

1216 ià(
”rÜ
) {

1217 ià(
aıi_fÜû
) {

1218 
	`´štk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1220 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1221 
	`di§bË_aıi
();

1222  
”rÜ
;

1227 
	}
}

1229 
__š™
 
	$aıi_boÙ_š™
()

1235 ià(
aıi_di§bËd
 && !
aıi_ht
)

1238 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

1243 
	`aıi_bË_·r£
(
ACPI_SIG_FADT
, 
aıi_·r£_çdt
);

1248 
	`aıi_´oûss_madt
();

1250 
	`aıi_bË_·r£
(
ACPI_SIG_HPET
, 
aıi_·r£_h³t
);

1253 
	}
}

1255 
__š™
 
	$·r£_aıi
(*
¬g
)

1257 ià(!
¬g
)

1258  -
EINVAL
;

1261 ià(
	`¡rcmp
(
¬g
, "off") == 0) {

1262 
	`di§bË_aıi
();

1265 ià(
	`¡rcmp
(
¬g
, "force") == 0) {

1266 
aıi_fÜû
 = 1;

1267 
aıi_ht
 = 1;

1268 
aıi_di§bËd
 = 0;

1271 ià(
	`¡rcmp
(
¬g
, "strict") == 0) {

1272 
aıi_¡riù
 = 1;

1275 ià(
	`¡rcmp
(
¬g
, "ht") == 0) {

1276 ià(!
aıi_fÜû
)

1277 
	`di§bË_aıi
();

1278 
aıi_ht
 = 1;

1281 ià(
	`¡rcmp
(
¬g
, "noirq") == 0) {

1282 
	`aıi_noœq_£t
();

1285  -
EINVAL
;

1288 
	}
}

1289 
—¾y_·¿m
("aıi", 
·r£_aıi
);

1292 
__š™
 
	$·r£_pci
(*
¬g
)

1294 ià(
¬g
 && 
	`¡rcmp
(arg, "noacpi") == 0)

1295 
	`aıi_di§bË_pci
();

1297 
	}
}

1298 
—¾y_·¿m
("pci", 
·r£_pci
);

1300 #ifdeà
CONFIG_X86_IO_APIC


1301 
__š™
 
	$·r£_aıi_sk_tim”_ov”ride
(*
¬g
)

1303 
aıi_sk_tim”_ov”ride
 = 1;

1305 
	}
}

1306 
—¾y_·¿m
("aıi_sk_tim”_ov”ride", 
·r£_aıi_sk_tim”_ov”ride
);

1308 
__š™
 
	$·r£_aıi_u£_tim”_ov”ride
(*
¬g
)

1310 
aıi_u£_tim”_ov”ride
 = 1;

1312 
	}
}

1313 
—¾y_·¿m
("aıi_u£_tim”_ov”ride", 
·r£_aıi_u£_tim”_ov”ride
);

1316 
__š™
 
	$£tup_aıi_sci
(*
s
)

1318 ià(!
s
)

1319  -
EINVAL
;

1320 ià(!
	`¡rcmp
(
s
, "edge"))

1321 
aıi_sci_æags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1322 (
aıi_sci_æags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1323 ià(!
	`¡rcmp
(
s
, "level"))

1324 
aıi_sci_æags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1325 (
aıi_sci_æags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1326 ià(!
	`¡rcmp
(
s
, "high"))

1327 
aıi_sci_æags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1328 (
aıi_sci_æags
 & ~
ACPI_MADT_POLARITY_MASK
);

1329 ià(!
	`¡rcmp
(
s
, "low"))

1330 
aıi_sci_æags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1331 (
aıi_sci_æags
 & ~
ACPI_MADT_POLARITY_MASK
);

1333  -
EINVAL
;

1335 
	}
}

1336 
—¾y_·¿m
("aıi_sci", 
£tup_aıi_sci
);

1338 
	$__aıi_acquœe_glob®_lock
(*
lock
)

1340 
Şd
, 
Ãw
, 
v®
;

1342 
Şd
 = *
lock
;

1343 
Ãw
 = (((
Şd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1344 
v®
 = 
	`cmpxchg
(
lock
, 
Şd
, 
Ãw
);

1345 } 
	`uÆik–y
 (
v®
 !ğ
Şd
));

1346  (
Ãw
 < 3) ? -1 : 0;

1347 
	}
}

1349 
	$__aıi_»Ëa£_glob®_lock
(*
lock
)

1351 
Şd
, 
Ãw
, 
v®
;

1353 
Şd
 = *
lock
;

1354 
Ãw
 = 
Şd
 & ~0x3;

1355 
v®
 = 
	`cmpxchg
(
lock
, 
Şd
, 
Ãw
);

1356 } 
	`uÆik–y
 (
v®
 !ğ
Şd
));

1357  
Şd
 & 0x1;

1358 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/aıi.h
>

13 
	~<lšux/ıu.h
>

14 
	~<lšux/sched.h
>

16 
	~<aıi/´oûssÜ.h
>

17 
	~<asm/aıi.h
>

29 
	$aıi_´oûssÜ_pow”_š™_bm_check
(
aıi_´oûssÜ_æags
 *
æags
,

30 
ıu
)

32 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

34 
æags
->
bm_check
 = 0;

35 ià(
	`num_Úlše_ıus
() == 1)

36 
æags
->
bm_check
 = 1;

37 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) {

43 
æags
->
bm_check
 = 1;

45 
	}
}

46 
EXPORT_SYMBOL
(
aıi_´oûssÜ_pow”_š™_bm_check
);

50 
	sc¡©e_’Œy
 {

52 
	m—x
;

53 
	mecx
;

54 } 
	m¡©es
[
ACPI_PROCESSOR_MAX_POWER
];

56 
c¡©e_’Œy
 *
	gıu_c¡©e_’Œy
;

58 
	gmwa™_suµÜ‹d
[
ACPI_PROCESSOR_MAX_POWER
];

60 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

61 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

63 
	#CPUID_MWAIT_LEAF
 (5)

	)

64 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

65 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

67 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

69 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

71 
	$aıi_´oûssÜ_ffh_c¡©e_´obe
(
ıu
,

72 
aıi_´oûssÜ_cx
 *
cx
, 
aıi_pow”_»gi¡”
 *
»g
)

74 
c¡©e_’Œy
 *
³rıu_’Œy
;

75 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

77 
ıumask_t
 
§ved_mask
;

78 
»tv®
;

79 
—x
, 
ebx
, 
ecx
, 
edx
;

80 
edx_·¹
;

81 
c¡©e_ty³
;

82 
num_c¡©e_subty³
;

84 ià(!
ıu_c¡©e_’Œy
 || 
c
->
ıuid_Ëv–
 < 
CPUID_MWAIT_LEAF
 )

87 ià(
»g
->
b™_off£t
 !ğ
NATIVE_CSTATE_BEYOND_HALT
)

90 
³rıu_’Œy
 = 
	`³r_ıu_±r
(
ıu_c¡©e_’Œy
, 
ıu
);

91 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
 = 0;

92 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
 = 0;

95 
§ved_mask
 = 
cu¼’t
->
ıus_®lowed
;

96 
»tv®
 = 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
ıu
));

97 ià(
»tv®
)

100 
	`ıuid
(
CPUID_MWAIT_LEAF
, &
—x
, &
ebx
, &
ecx
, &
edx
);

103 
c¡©e_ty³
 = (
cx
->
add»ss
 >> 
MWAIT_SUBSTATE_SIZE
) + 1;

104 
edx_·¹
 = 
edx
 >> (
c¡©e_ty³
 * 
MWAIT_SUBSTATE_SIZE
);

105 
num_c¡©e_subty³
 = 
edx_·¹
 & 
MWAIT_SUBSTATE_MASK
;

107 
»tv®
 = 0;

108 ià(
num_c¡©e_subty³
 < (
cx
->
add»ss
 & 
MWAIT_SUBSTATE_MASK
)) {

109 
»tv®
 = -1;

110 
out
;

114 ià(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

115 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

116 
»tv®
 = -1;

117 
out
;

119 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

122 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
 = cx->
add»ss
;

124 ià(!
mwa™_suµÜ‹d
[
c¡©e_ty³
]) {

125 
mwa™_suµÜ‹d
[
c¡©e_ty³
] = 1;

126 
	`´štk
(
KERN_DEBUG
 "Monitor-Mwait will be usedoƒnter C-%d "

127 "¡©e\n", 
cx
->
ty³
);

130 
out
:

131 
	`£t_ıus_®lowed
(
cu¼’t
, 
§ved_mask
);

132  
»tv®
;

133 
	}
}

134 
EXPORT_SYMBOL_GPL
(
aıi_´oûssÜ_ffh_c¡©e_´obe
);

136 
	$aıi_´oûssÜ_ffh_c¡©e_’‹r
(
aıi_´oûssÜ_cx
 *
cx
)

138 
ıu
 = 
	`smp_´oûssÜ_id
();

139 
c¡©e_’Œy
 *
³rıu_’Œy
;

141 
³rıu_’Œy
 = 
	`³r_ıu_±r
(
ıu_c¡©e_’Œy
, 
ıu
);

142 
	`mwa™_idË_w™h_hšts
(
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
—x
,

143 
³rıu_’Œy
->
¡©es
[
cx
->
šdex
].
ecx
);

144 
	}
}

145 
EXPORT_SYMBOL_GPL
(
aıi_´oûssÜ_ffh_c¡©e_’‹r
);

147 
__š™
 
	$ffh_c¡©e_š™
()

149 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

150 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
)

153 
ıu_c¡©e_’Œy
 = 
	`®loc_³rıu
(
c¡©e_’Œy
);

155 
	}
}

157 
__ex™
 
	$ffh_c¡©e_ex™
()

159 
	`ä“_³rıu
(
ıu_c¡©e_’Œy
);

160 
ıu_c¡©e_’Œy
 = 
NULL
;

161 
	}
}

163 
¬ch_š™ÿÎ
(
ffh_c¡©e_š™
);

164 
__ex™ÿÎ
(
ffh_c¡©e_ex™
);

	@/cmpt816/linux/arch/x86/kernel/acpi/processor.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/aıi.h
>

14 
	~<aıi/´oûssÜ.h
>

15 
	~<asm/aıi.h
>

17 
	$š™_š‹l_pdc
(
aıi_´oûssÜ
 *
´
, 
ıušfo_x86
 *
c
)

19 
aıi_objeù_li¡
 *
obj_li¡
;

20 
aıi_objeù
 *
obj
;

21 
u32
 *
buf
;

24 
obj_li¡
 = 
	`km®loc
((
aıi_objeù_li¡
), 
GFP_KERNEL
);

25 ià(!
obj_li¡
) {

26 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

30 
obj
 = 
	`km®loc
((
aıi_objeù
), 
GFP_KERNEL
);

31 ià(!
obj
) {

32 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

33 
	`kä“
(
obj_li¡
);

37 
buf
 = 
	`km®loc
(12, 
GFP_KERNEL
);

38 ià(!
buf
) {

39 
	`´štk
(
KERN_ERR
 "Memory‡llocationƒrror\n");

40 
	`kä“
(
obj
);

41 
	`kä“
(
obj_li¡
);

45 
buf
[0] = 
ACPI_PDC_REVISION_ID
;

46 
buf
[1] = 1;

47 
buf
[2] = 
ACPI_PDC_C_CAPABILITY_SMP
;

49 ià(
	`ıu_has
(
c
, 
X86_FEATURE_EST
))

50 
buf
[2] |ğ
ACPI_PDC_EST_CAPABILITY_SWSMP
;

52 ià(
	`ıu_has
(
c
, 
X86_FEATURE_ACPI
))

53 
buf
[2] |ğ
ACPI_PDC_T_FFH
;

55 
obj
->
ty³
 = 
ACPI_TYPE_BUFFER
;

56 
obj
->
bufãr
.
Ëngth
 = 12;

57 
obj
->
bufãr
.
poš‹r
 = (
u8
 *è
buf
;

58 
obj_li¡
->
couÁ
 = 1;

59 
obj_li¡
->
poš‹r
 = 
obj
;

60 
´
->
pdc
 = 
obj_li¡
;

63 
	}
}

66 
	$¬ch_aıi_´oûssÜ_š™_pdc
(
aıi_´oûssÜ
 *
´
)

68 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
´
->
id
);

70 
´
->
pdc
 = 
NULL
;

71 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

72 
	`š™_š‹l_pdc
(
´
, 
c
);

75 
	}
}

77 
EXPORT_SYMBOL
(
¬ch_aıi_´oûssÜ_š™_pdc
);

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep_64.c

29 
	~<lšux/k”Ãl.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/ty³s.h
>

32 
	~<lšux/¡ddef.h
>

33 
	~<lšux/¦ab.h
>

34 
	~<lšux/pci.h
>

35 
	~<lšux/boÙmem.h
>

36 
	~<lšux/aıi.h
>

37 
	~<lšux/ıumask.h
>

39 
	~<asm/mp¥ec.h
>

40 
	~<asm/io.h
>

41 
	~<asm/­ic.h
>

42 
	~<asm/­icdef.h
>

43 
	~<asm/·ge.h
>

44 
	~<asm/pgbË.h
>

45 
	~<asm/pg®loc.h
>

46 
	~<asm/io_­ic.h
>

47 
	~<asm/´Ùo.h
>

48 
	~<asm/bæush.h
>

55 
	gaıi_wakeup_add»ss
 = 0;

56 
	gaıi_»®mode_æags
;

57 
wakeup_¡¬t
, 
wakeup_’d
;

59 
aıi_cİy_wakeup_routše
();

67 
	$aıi_§ve_¡©e_mem
()

69 
	`memıy
((*)
aıi_wakeup_add»ss
, &
wakeup_¡¬t
,

70 &
wakeup_’d
 - &
wakeup_¡¬t
);

71 
	`aıi_cİy_wakeup_routše
(
aıi_wakeup_add»ss
);

74 
	}
}

79 
	$aıi_»¡Üe_¡©e_mem
()

81 
	}
}

91 
__š™
 
	$aıi_»£rve_boÙmem
()

93 
aıi_wakeup_add»ss
 = ()
	`®loc_boÙmem_low
(
PAGE_SIZE
*2);

94 ià((&
wakeup_’d
 - &
wakeup_¡¬t
è> (
PAGE_SIZE
*2))

95 
	`´štk
(
KERN_CRIT


98 
	}
}

100 
__š™
 
	$aıi_¦“p_£tup
(*
¡r
)

102 (
¡r
 !ğ
NULL
) && (*str != '\0')) {

103 ià(
	`¡ºcmp
(
¡r
, "s3_bios", 7) == 0)

104 
aıi_»®mode_æags
 |= 1;

105 ià(
	`¡ºcmp
(
¡r
, "s3_mode", 7) == 0)

106 
aıi_»®mode_æags
 |= 2;

107 ià(
	`¡ºcmp
(
¡r
, "s3_beep", 7) == 0)

108 
aıi_»®mode_æags
 |= 4;

109 
¡r
 = 
	`¡rchr
(str, ',');

110 ià(
¡r
 !ğ
NULL
)

111 
¡r
 +ğ
	`¡r¥n
(str, ", \t");

114 
	}
}

116 
__£tup
("aıi_¦“p=", 
aıi_¦“p_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/¥šlock.h
>

4 
	~<lšux/li¡.h
>

5 
	~<lšux/k´obes.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/vm®loc.h
>

8 
	~<asm/®‹º©ive.h
>

9 
	~<asm/£ùiÚs.h
>

10 
	~<asm/pgbË.h
>

11 
	~<asm/mû.h
>

12 
	~<asm/nmi.h
>

13 
	~<asm/vsysÿÎ.h
>

15 
	#MAX_PATCH_LEN
 (255-1)

	)

17 #ifdeà
CONFIG_HOTPLUG_CPU


18 
	gsmp_®t_Úû
;

20 
__š™
 
	$boÙÚly
(*
¡r
)

22 
smp_®t_Úû
 = 1;

24 
	}
}

25 
__£tup
("smp-®t-boÙ", 
boÙÚly
);

27 
	#smp_®t_Úû
 1

	)

30 
	gdebug_®‹º©ive
;

32 
__š™
 
	$debug_®t
(*
¡r
)

34 
debug_®‹º©ive
 = 1;

36 
	}
}

37 
__£tup
("debug-®‹º©ive", 
debug_®t
);

39 
	gnÜ•Ïû_smp
;

41 
__š™
 
	$£tup_nÜ•Ïû_smp
(*
¡r
)

43 
nÜ•Ïû_smp
 = 1;

45 
	}
}

46 
__£tup
("nÜ•Ïû-smp", 
£tup_nÜ•Ïû_smp
);

48 #ifdeà
CONFIG_PARAVIRT


49 
	gnÜ•Ïû_·¿vœt
 = 0;

51 
__š™
 
	$£tup_nÜ•Ïû_·¿vœt
(*
¡r
)

53 
nÜ•Ïû_·¿vœt
 = 1;

55 
	}
}

56 
__£tup
("nÜ•Ïû-·¿vœt", 
£tup_nÜ•Ïû_·¿vœt
);

59 
	#DPRINTK
(
fmt
, 
¬gs
...èià(
debug_®‹º©ive
) \

60 
	`´štk
(
KERN_DEBUG
 
fmt
, 
¬gs
)

	)

62 #ifdeà
GENERIC_NOP1


66 
asm
("\t.section .rodata, \"a\"\nintelnops: "

67 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


68 
GENERIC_NOP7
 
GENERIC_NOP8
);

69 cÚ¡ 
š‹Êİs
[];

70 cÚ¡ *cÚ¡ 
	gš‹l_nİs
[
ASM_NOP_MAX
+1] = {

71 
NULL
,

72 
š‹Êİs
,

73 
š‹Êİs
 + 1,

74 
š‹Êİs
 + 1 + 2,

75 
š‹Êİs
 + 1 + 2 + 3,

76 
š‹Êİs
 + 1 + 2 + 3 + 4,

77 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5,

78 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5 + 6,

79 
š‹Êİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

83 #ifdeà
K8_NOP1


84 
asm
("\t.section .rodata, \"a\"\nk8nops: "

85 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


86 
K8_NOP7
 
K8_NOP8
);

87 cÚ¡ 
k8nİs
[];

88 cÚ¡ *cÚ¡ 
	gk8_nİs
[
ASM_NOP_MAX
+1] = {

89 
NULL
,

90 
k8nİs
,

91 
k8nİs
 + 1,

92 
k8nİs
 + 1 + 2,

93 
k8nİs
 + 1 + 2 + 3,

94 
k8nİs
 + 1 + 2 + 3 + 4,

95 
k8nİs
 + 1 + 2 + 3 + 4 + 5,

96 
k8nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

97 
k8nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

101 #ifdeà
K7_NOP1


102 
asm
("\t.section .rodata, \"a\"\nk7nops: "

103 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


104 
K7_NOP7
 
K7_NOP8
);

105 cÚ¡ 
k7nİs
[];

106 cÚ¡ *cÚ¡ 
	gk7_nİs
[
ASM_NOP_MAX
+1] = {

107 
NULL
,

108 
k7nİs
,

109 
k7nİs
 + 1,

110 
k7nİs
 + 1 + 2,

111 
k7nİs
 + 1 + 2 + 3,

112 
k7nİs
 + 1 + 2 + 3 + 4,

113 
k7nİs
 + 1 + 2 + 3 + 4 + 5,

114 
k7nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

115 
k7nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

119 #ifdeà
P6_NOP1


120 
asm
("\t.section .rodata, \"a\"\np6nops: "

121 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


122 
P6_NOP7
 
P6_NOP8
);

123 cÚ¡ 
p6nİs
[];

124 cÚ¡ *cÚ¡ 
	gp6_nİs
[
ASM_NOP_MAX
+1] = {

125 
NULL
,

126 
p6nİs
,

127 
p6nİs
 + 1,

128 
p6nİs
 + 1 + 2,

129 
p6nİs
 + 1 + 2 + 3,

130 
p6nİs
 + 1 + 2 + 3 + 4,

131 
p6nİs
 + 1 + 2 + 3 + 4 + 5,

132 
p6nİs
 + 1 + 2 + 3 + 4 + 5 + 6,

133 
p6nİs
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

137 #ifdeà
CONFIG_X86_64


139 
__vsysÿÎ_0
;

140 
šlše
 cÚ¡ *cÚ¡ * 
	$fšd_nİ_bË
()

142  
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 ||

143 
boÙ_ıu_d©a
.
x86
 < 6 ? 
k8_nİs
 : 
p6_nİs
;

144 
	}
}

148 cÚ¡ 
	snİ
 {

149 
	mıuid
;

150 cÚ¡ *cÚ¡ *
	mnİbË
;

151 } 
	gnİty³s
[] = {

152 { 
X86_FEATURE_K8
, 
k8_nİs
 },

153 { 
X86_FEATURE_K7
, 
k7_nİs
 },

154 { 
X86_FEATURE_P4
, 
p6_nİs
 },

155 { 
X86_FEATURE_P3
, 
p6_nİs
 },

156 { -1, 
NULL
 }

159 cÚ¡ *cÚ¡ * 
	$fšd_nİ_bË
()

161 cÚ¡ *cÚ¡ *
nİbË
 = 
š‹l_nİs
;

162 
i
;

164 
i
 = 0; 
nİty³s
[i].
ıuid
 >= 0; i++) {

165 ià(
	`boÙ_ıu_has
(
nİty³s
[
i
].
ıuid
)) {

166 
nİbË
 = 
nİty³s
[
i
].noptable;

170  
nİbË
;

171 
	}
}

176 
	$add_nİs
(*
š¢s
, 
Ën
)

178 cÚ¡ *cÚ¡ *
nİbË
 = 
	`fšd_nİ_bË
();

180 
Ën
 > 0) {

181 
nİËn
 = 
Ën
;

182 ià(
nİËn
 > 
ASM_NOP_MAX
)

183 
nİËn
 = 
ASM_NOP_MAX
;

184 
	`memıy
(
š¢s
, 
nİbË
[
nİËn
],‚oplen);

185 
š¢s
 +ğ
nİËn
;

186 
Ën
 -ğ
nİËn
;

188 
	}
}

190 
®t_š¡r
 
__®t_š¡ruùiÚs
[], 
__®t_š¡ruùiÚs_’d
[];

191 
u8
 *
__smp_locks
[], *
__smp_locks_’d
[];

199 
	$­¶y_®‹º©ives
(
®t_š¡r
 *
¡¬t
, ®t_š¡¸*
’d
)

201 
®t_š¡r
 *
a
;

202 
š¢buf
[
MAX_PATCH_LEN
];

204 
	`DPRINTK
("%s:‡ÉabË %°-> %p\n", 
__FUNCTION__
, 
¡¬t
, 
’d
);

205 
a
 = 
¡¬t
;‡ < 
’d
;‡++) {

206 
u8
 *
š¡r
 = 
a
->instr;

207 
	`BUG_ON
(
a
->
»¶aûm’’
 >‡->
š¡¾’
);

208 
	`BUG_ON
(
a
->
š¡¾’
 > (
š¢buf
));

209 ià(!
	`boÙ_ıu_has
(
a
->
ıuid
))

211 #ifdeà
CONFIG_X86_64


213 ià(
š¡r
 >ğ(
u8
 *)
VSYSCALL_START
 && in¡¸< (u8*)
VSYSCALL_END
) {

214 
š¡r
 = 
	`__va
(š¡¸- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__·_symbŞ
(&
__vsysÿÎ_0
));

215 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

216 
__FUNCTION__
, 
a
->
š¡r
, instr);

219 
	`memıy
(
š¢buf
, 
a
->
»¶aûm’t
,‡->
»¶aûm’’
);

220 
	`add_nİs
(
š¢buf
 + 
a
->
»¶aûm’’
,

221 
a
->
š¡¾’
 -‡->
»¶aûm’’
);

222 
	`‹xt_poke
(
š¡r
, 
š¢buf
, 
a
->
š¡¾’
);

224 
	}
}

226 #ifdeà
CONFIG_SMP


228 
	$®‹º©ives_smp_lock
(
u8
 **
¡¬t
, u8 **
’d
, u8 *
‹xt
, u8 *
‹xt_’d
)

230 
u8
 **
±r
;

232 
±r
 = 
¡¬t
;…Œ < 
’d
;…tr++) {

233 ià(*
±r
 < 
‹xt
)

235 ià(*
±r
 > 
‹xt_’d
)

237 
	`‹xt_poke
(*
±r
, (([]){0xf0}), 1);

239 
	}
}

241 
	$®‹º©ives_smp_uÆock
(
u8
 **
¡¬t
, u8 **
’d
, u8 *
‹xt
, u8 *
‹xt_’d
)

243 
u8
 **
±r
;

244 
š¢
[1];

246 ià(
nÜ•Ïû_smp
)

249 
	`add_nİs
(
š¢
, 1);

250 
±r
 = 
¡¬t
;…Œ < 
’d
;…tr++) {

251 ià(*
±r
 < 
‹xt
)

253 ià(*
±r
 > 
‹xt_’d
)

255 
	`‹xt_poke
(*
±r
, 
š¢
, 1);

257 
	}
}

259 
	ssmp_®t_moduË
 {

261 
moduË
 *
	mmod
;

262 *
	mÇme
;

265 
u8
 **
	mlocks
;

266 
u8
 **
	mlocks_’d
;

269 
u8
 *
	m‹xt
;

270 
u8
 *
	m‹xt_’d
;

272 
li¡_h—d
 
	mÃxt
;

274 
LIST_HEAD
(
smp_®t_moduËs
);

275 
DEFINE_SPINLOCK
(
smp_®t
);

277 
	$®‹º©ives_smp_moduË_add
(
moduË
 *
mod
, *
Çme
,

278 *
locks
, *
locks_’d
,

279 *
‹xt
, *
‹xt_’d
)

281 
smp_®t_moduË
 *
smp
;

282 
æags
;

284 ià(
nÜ•Ïû_smp
)

287 ià(
smp_®t_Úû
) {

288 ià(
	`boÙ_ıu_has
(
X86_FEATURE_UP
))

289 
	`®‹º©ives_smp_uÆock
(
locks
, 
locks_’d
,

290 
‹xt
, 
‹xt_’d
);

294 
smp
 = 
	`kz®loc
((*smp), 
GFP_KERNEL
);

295 ià(
NULL
 =ğ
smp
)

298 
smp
->
mod
 = mod;

299 
smp
->
Çme
 =‚ame;

300 
smp
->
locks
 =†ocks;

301 
smp
->
locks_’d
 =†ocks_end;

302 
smp
->
‹xt
 =ext;

303 
smp
->
‹xt_’d
 =ext_end;

304 
	`DPRINTK
("%s:†ocks %p -> %p,ext %p -> %p,‚ame %s\n",

305 
__FUNCTION__
, 
smp
->
locks
, smp->
locks_’d
,

306 
smp
->
‹xt
, smp->
‹xt_’d
, smp->
Çme
);

308 
	`¥š_lock_œq§ve
(&
smp_®t
, 
æags
);

309 
	`li¡_add_
(&
smp
->
Ãxt
, &
smp_®t_moduËs
);

310 ià(
	`boÙ_ıu_has
(
X86_FEATURE_UP
))

311 
	`®‹º©ives_smp_uÆock
(
smp
->
locks
, smp->
locks_’d
,

312 
smp
->
‹xt
, smp->
‹xt_’d
);

313 
	`¥š_uÆock_œq»¡Üe
(&
smp_®t
, 
æags
);

314 
	}
}

316 
	$®‹º©ives_smp_moduË_d–
(
moduË
 *
mod
)

318 
smp_®t_moduË
 *
™em
;

319 
æags
;

321 ià(
smp_®t_Úû
 || 
nÜ•Ïû_smp
)

324 
	`¥š_lock_œq§ve
(&
smp_®t
, 
æags
);

325 
	`li¡_fÜ_—ch_’Œy
(
™em
, &
smp_®t_moduËs
, 
Ãxt
) {

326 ià(
mod
 !ğ
™em
->mod)

328 
	`li¡_d–
(&
™em
->
Ãxt
);

329 
	`¥š_uÆock_œq»¡Üe
(&
smp_®t
, 
æags
);

330 
	`DPRINTK
("%s: %s\n", 
__FUNCTION__
, 
™em
->
Çme
);

331 
	`kä“
(
™em
);

334 
	`¥š_uÆock_œq»¡Üe
(&
smp_®t
, 
æags
);

335 
	}
}

337 
	$®‹º©ives_smp_sw™ch
(
smp
)

339 
smp_®t_moduË
 *
mod
;

340 
æags
;

342 #ifdeà
CONFIG_LOCKDEP


348 
	`´štk
("lockdep:‚ot fixing up‡lternatives.\n");

352 ià(
nÜ•Ïû_smp
 || 
smp_®t_Úû
)

354 
	`BUG_ON
(!
smp
 && (
	`num_Úlše_ıus
() > 1));

356 
	`¥š_lock_œq§ve
(&
smp_®t
, 
æags
);

357 ià(
smp
) {

358 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo SMP code\n");

359 
	`ş—r_b™
(
X86_FEATURE_UP
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

360 
	`ş—r_b™
(
X86_FEATURE_UP
, 
	`ıu_d©a
(0).
x86_ÿ·b™y
);

361 
	`li¡_fÜ_—ch_’Œy
(
mod
, &
smp_®t_moduËs
, 
Ãxt
)

362 
	`®‹º©ives_smp_lock
(
mod
->
locks
, mod->
locks_’d
,

363 
mod
->
‹xt
, mod->
‹xt_’d
);

365 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo UP code\n");

366 
	`£t_b™
(
X86_FEATURE_UP
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

367 
	`£t_b™
(
X86_FEATURE_UP
, 
	`ıu_d©a
(0).
x86_ÿ·b™y
);

368 
	`li¡_fÜ_—ch_’Œy
(
mod
, &
smp_®t_moduËs
, 
Ãxt
)

369 
	`®‹º©ives_smp_uÆock
(
mod
->
locks
, mod->
locks_’d
,

370 
mod
->
‹xt
, mod->
‹xt_’d
);

372 
	`¥š_uÆock_œq»¡Üe
(&
smp_®t
, 
æags
);

373 
	}
}

377 #ifdeà
CONFIG_PARAVIRT


378 
	$­¶y_·¿vœt
(
·¿vœt_·tch_s™e
 *
¡¬t
,

379 
·¿vœt_·tch_s™e
 *
’d
)

381 
·¿vœt_·tch_s™e
 *
p
;

382 
š¢buf
[
MAX_PATCH_LEN
];

384 ià(
nÜ•Ïû_·¿vœt
)

387 
p
 = 
¡¬t
;… < 
’d
;…++) {

388 
u£d
;

390 
	`BUG_ON
(
p
->
Ën
 > 
MAX_PATCH_LEN
);

392 
	`memıy
(
š¢buf
, 
p
->
š¡r
,…->
Ën
);

393 
u£d
 = 
pv_š™_İs
.
	`·tch
(
p
->
š¡¹y³
,…->
şobb”s
, 
š¢buf
,

394 ()
p
->
š¡r
,…->
Ën
);

396 
	`BUG_ON
(
u£d
 > 
p
->
Ën
);

399 
	`add_nİs
(
š¢buf
 + 
u£d
, 
p
->
Ën
 - used);

400 
	`‹xt_poke
(
p
->
š¡r
, 
š¢buf
,…->
Ën
);

402 
	}
}

403 
·¿vœt_·tch_s™e
 
__¡¬t_·¿š¡ruùiÚs
[],

404 
__¡İ_·¿š¡ruùiÚs
[];

407 
__š™
 
	$®‹º©ive_š¡ruùiÚs
()

409 
æags
;

414 
	`¡İ_nmi
();

415 #ifdeà
CONFIG_X86_MCE


416 
	`¡İ_mû
();

419 
	`loÿl_œq_§ve
(
æags
);

420 
	`­¶y_®‹º©ives
(
__®t_š¡ruùiÚs
, 
__®t_š¡ruùiÚs_’d
);

425 #ifdeà
CONFIG_HOTPLUG_CPU


426 ià(
	`num_possibË_ıus
() < 2)

427 
smp_®t_Úû
 = 1;

430 #ifdeà
CONFIG_SMP


431 ià(
smp_®t_Úû
) {

432 ià(1 =ğ
	`num_possibË_ıus
()) {

433 
	`´štk
(
KERN_INFO
 "SMP‡lternatives: switchingo UP code\n");

434 
	`£t_b™
(
X86_FEATURE_UP
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

435 
	`£t_b™
(
X86_FEATURE_UP
, 
	`ıu_d©a
(0).
x86_ÿ·b™y
);

436 
	`®‹º©ives_smp_uÆock
(
__smp_locks
, 
__smp_locks_’d
,

437 
_‹xt
, 
_‘ext
);

440 
	`®‹º©ives_smp_moduË_add
(
NULL
, "core kernel",

441 
__smp_locks
, 
__smp_locks_’d
,

442 
_‹xt
, 
_‘ext
);

443 
	`®‹º©ives_smp_sw™ch
(0);

446 
	`­¶y_·¿vœt
(
__·¿š¡ruùiÚs
, 
__·¿š¡ruùiÚs_’d
);

447 
	`loÿl_œq_»¡Üe
(
æags
);

449 ià(
smp_®t_Úû
)

450 
	`ä“_š™_·ges
("SMP‡lternatives",

451 ()
__smp_locks
,

452 ()
__smp_locks_’d
);

454 
	`»¡¬t_nmi
();

455 #ifdeà
CONFIG_X86_MCE


456 
	`»¡¬t_mû
();

458 
	}
}

468 
__k´obes
 
	$‹xt_poke
(*
addr
, *
İcode
, 
Ën
)

470 
	`memıy
(
addr
, 
İcode
, 
Ën
);

471 
	`sync_cÜe
();

474 
	}
}

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/ty³s.h
>

14 
	~<lšux/š™.h
>

15 
	~<lšux/boÙmem.h
>

16 
	~<lšux/mmzÚe.h
>

17 
	~<lšux/pci_ids.h
>

18 
	~<lšux/pci.h
>

19 
	~<lšux/b™İs.h
>

20 
	~<lšux/iİÜt.h
>

21 
	~<asm/e820.h
>

22 
	~<asm/io.h
>

23 
	~<asm/g¬t.h
>

24 
	~<asm/pci-dœeù.h
>

25 
	~<asm/dma.h
>

26 
	~<asm/k8.h
>

28 
	gg¬t_iommu_­”tu»
;

29 
g¬t_iommu_­”tu»_di§bËd
 
	g__š™d©a
 = 0;

30 
g¬t_iommu_­”tu»_®lowed
 
	g__š™d©a
 = 0;

32 
çÎback_­”_Üd”
 
	g__š™d©a
 = 1;

33 
çÎback_­”_fÜû
 
	g__š™d©a
 = 0;

35 
fix_­”tu»
 
	g__š™d©a
 = 1;

37 
»sourû
 
	gg¬t_»sourû
 = {

38 .
Çme
 = "GART",

39 .
	gæags
 = 
IORESOURCE_MEM
,

42 
__š™
 
	$š£¹_­”tu»_»sourû
(
u32
 
­”_ba£
, u32 
­”_size
)

44 
g¬t_»sourû
.
¡¬t
 = 
­”_ba£
;

45 
g¬t_»sourû
.
’d
 = 
­”_ba£
 + 
­”_size
 - 1;

46 
	`š£¹_»sourû
(&
iomem_»sourû
, &
g¬t_»sourû
);

47 
	}
}

52 
u32
 
__š™
 
	$®loÿ‹_­”tu»
()

54 
u32
 
­”_size
;

55 *
p
;

57 ià(
çÎback_­”_Üd”
 > 7)

58 
çÎback_­”_Üd”
 = 7;

59 
­”_size
 = (32 * 1024 * 1024è<< 
çÎback_­”_Üd”
;

67 
p
 = 
	`__®loc_boÙmem_nİªic
(
­”_size
,‡per_size, 0);

68 ià(!
p
 || 
	`__·
Õ)+
­”_size
 > 0xffffffff) {

69 
	`´štk
("Cannot‡llocate‡perture memory hole (%p,%uK)\n",

70 
p
, 
­”_size
>>10);

71 ià(
p
)

72 
	`ä“_boÙmem
(
	`__·
(
p
), 
­”_size
);

75 
	`´štk
("Mapping‡perture over %d KB of RAM @ %lx\n",

76 
­”_size
 >> 10, 
	`__·
(
p
));

77 
	`š£¹_­”tu»_»sourû
((
u32
)
	`__·
(
p
), 
­”_size
);

78  (
u32
)
	`__·
(
p
);

79 
	}
}

81 
__š™
 
	$­”tu»_v®id
(
u64
 
­”_ba£
, 
u32
 
­”_size
)

83 ià(!
­”_ba£
)

85 ià(
­”_size
 < 64*1024*1024) {

86 
	`´štk
("A³¹u»oØsm®È(%d MB)\n", 
­”_size
>>20);

89 ià(
­”_ba£
 + 
­”_size
 > 0x100000000UL) {

90 
	`´štk
("Aperture beyond 4GB. Ignoring.\n");

93 ià(
	`e820_ªy_m­³d
(
­”_ba£
,‡³r_ba£ + 
­”_size
, 
E820_RAM
)) {

94 
	`´štk
("Aperture…ointingoƒ820 RAM. Ignoring.\n");

98 
	}
}

101 
__u32
 
__š™
 
	$fšd_ÿp
(
num
, 
¦Ù
, 
func
, 
ÿp
)

103 
u8
 
pos
;

104 
by‹s
;

105 ià(!(
	`»ad_pci_cÚfig_16
(
num
,
¦Ù
,
func
,
PCI_STATUS
è& 
PCI_STATUS_CAP_LIST
))

107 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
num
,
¦Ù
,
func
,
PCI_CAPABILITY_LIST
);

108 
by‹s
 = 0; by‹ < 48 && 
pos
 >= 0x40; bytes++) {

109 
u8
 
id
;

110 
pos
 &= ~3;

111 
id
 = 
	`»ad_pci_cÚfig_by‹
(
num
,
¦Ù
,
func
,
pos
+
PCI_CAP_LIST_ID
);

112 ià(
id
 == 0xff)

114 ià(
id
 =ğ
ÿp
)

115  
pos
;

116 
pos
 = 
	`»ad_pci_cÚfig_by‹
(
num
,
¦Ù
,
func
,pos+
PCI_CAP_LIST_NEXT
);

119 
	}
}

122 
__u32
 
__š™
 
	$»ad_agp
(
num
, 
¦Ù
, 
func
, 
ÿp
, 
u32
 *
Üd”
)

124 
u32
 
­size
;

125 
u32
 
­siz”eg
;

126 
nb™s
;

127 
u32
 
­”_low
, 
­”_hi
;

128 
u64
 
­”
;

130 
	`´štk
("AGP bridg© %02x:%02x:%02x\n", 
num
, 
¦Ù
, 
func
);

131 
­siz”eg
 = 
	`»ad_pci_cÚfig_16
(
num
,
¦Ù
,
func
, 
ÿp
 + 0x14);

132 ià(
­siz”eg
 == 0xffffffff) {

133 
	`´štk
("APSIZE in AGP bridge unreadable\n");

137 
­size
 = 
­siz”eg
 & 0xfff;

139 ià(
­size
 & 0xff)

140 
­size
 |= 0xf00;

141 
nb™s
 = 
	`hweight16
(
­size
);

142 *
Üd”
 = 7 - 
nb™s
;

143 ià(()*
Üd”
 < 0)

144 *
Üd”
 = 0;

146 
­”_low
 = 
	`»ad_pci_cÚfig
(
num
,
¦Ù
,
func
, 0x10);

147 
­”_hi
 = 
	`»ad_pci_cÚfig
(
num
,
¦Ù
,
func
,0x14);

148 
­”
 = (
­”_low
 & ~((1<<22)-1)è| ((
u64
)
­”_hi
 << 32);

150 
	`´štk
("Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

151 
­”
, 32 << *
Üd”
, 
­siz”eg
);

153 ià(!
	`­”tu»_v®id
(
­”
, (32*1024*1024è<< *
Üd”
))

155  (
u32
)
­”
;

156 
	}
}

169 
__u32
 
__š™
 
	$£¬ch_agp_bridge
(
u32
 *
Üd”
, *
v®id_agp
)

171 
num
, 
¦Ù
, 
func
;

174 
num
 = 0;‚um < 256;‚um++) {

175 
¦Ù
 = 0; slot < 32; slot++) {

176 
func
 = 0; func < 8; func++) {

177 
u32
 
şass
, 
ÿp
;

178 
u8
 
ty³
;

179 
şass
 = 
	`»ad_pci_cÚfig
(
num
,
¦Ù
,
func
,

180 
PCI_CLASS_REVISION
);

181 ià(
şass
 == 0xffffffff)

184 
şass
 >> 16) {

185 
PCI_CLASS_BRIDGE_HOST
:

186 
PCI_CLASS_BRIDGE_OTHER
:

188 
ÿp
 = 
	`fšd_ÿp
(
num
,
¦Ù
,
func
,
PCI_CAP_ID_AGP
);

189 ià(!
ÿp
)

191 *
v®id_agp
 = 1;

192  
	`»ad_agp
(
num
,
¦Ù
,
func
,
ÿp
,
Üd”
);

196 
ty³
 = 
	`»ad_pci_cÚfig_by‹
(
num
,
¦Ù
,
func
,

197 
PCI_HEADER_TYPE
);

198 ià(!(
ty³
 & 0x80))

203 
	`´štk
("No AGP bridge found\n");

205 
	}
}

207 
__š™
 
	$g¬t_iommu_hŞe_š™
()

209 
fix
, 
num
;

210 
u32
 
­”_size
, 
­”_®loc
 = 0, 
­”_Üd”
 = 0, 
Ï¡_­”_Üd”
 = 0;

211 
u64
 
­”_ba£
, 
Ï¡_­”_ba£
 = 0;

212 
v®id_agp
 = 0;

214 ià(
g¬t_iommu_­”tu»_di§bËd
 || !
fix_­”tu»
 ||

215 !
	`—¾y_pci_®lowed
())

218 
	`´štk
(
KERN_INFO
 "Checking‡perture...\n");

220 
fix
 = 0;

221 
num
 = 24;‚um < 32;‚um++) {

222 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(0, 
num
, 3, 0x00)))

225 
iommu_d‘eùed
 = 1;

226 
g¬t_iommu_­”tu»
 = 1;

228 
­”_Üd”
 = (
	`»ad_pci_cÚfig
(0, 
num
, 3, 0x90) >> 1) & 7;

229 
­”_size
 = (32 * 1024 * 1024è<< 
­”_Üd”
;

230 
­”_ba£
 = 
	`»ad_pci_cÚfig
(0, 
num
, 3, 0x94) & 0x7fff;

231 
­”_ba£
 <<= 25;

233 
	`´štk
("CPU %d:‡³¹u» @ %Lx siz%u MB\n", 
num
-24,

234 
­”_ba£
, 
­”_size
>>20);

236 ià(!
	`­”tu»_v®id
(
­”_ba£
, 
­”_size
)) {

237 
fix
 = 1;

241 ià((
Ï¡_­”_Üd”
 && 
­”_Üd”
 !=†ast_aper_order) ||

242 (
Ï¡_­”_ba£
 && 
­”_ba£
 !=†ast_aper_base)) {

243 
fix
 = 1;

246 
Ï¡_­”_Üd”
 = 
­”_Üd”
;

247 
Ï¡_­”_ba£
 = 
­”_ba£
;

250 ià(!
fix
 && !
çÎback_­”_fÜû
) {

251 ià(
Ï¡_­”_ba£
) {

252 
n
 = (32 * 1024 * 1024è<< 
Ï¡_­”_Üd”
;

253 
	`š£¹_­”tu»_»sourû
((
u32
)
Ï¡_­”_ba£
, 
n
);

258 ià(!
çÎback_­”_fÜû
)

259 
­”_®loc
 = 
	`£¬ch_agp_bridge
(&
­”_Üd”
, &
v®id_agp
);

261 ià(
­”_®loc
) {

263 } ià(
swiÙlb
 && !
v®id_agp
) {

265 } ià((!
no_iommu
 && 
’d_pâ
 > 
MAX_DMA32_PFN
) ||

266 
fÜû_iommu
 ||

267 
v®id_agp
 ||

268 
çÎback_­”_fÜû
) {

269 
	`´štk
("Your BIOS doesn't†eave‡‡perture memory hole\n");

270 
	`´štk
("Pleaseƒnablehe IOMMU option inhe BIOS setup\n");

271 
	`´štk
("This costs you %d MB of RAM\n",

272 32 << 
çÎback_­”_Üd”
);

274 
­”_Üd”
 = 
çÎback_­”_Üd”
;

275 
­”_®loc
 = 
	`®loÿ‹_­”tu»
();

276 ià(!
­”_®loc
) {

282 
	`·nic
("Notƒnough memory for‡perture");

289 
num
 = 24;‚um < 32;‚um++) {

290 ià(!
	`—¾y_is_k8_nb
(
	`»ad_pci_cÚfig
(0, 
num
, 3, 0x00)))

296 
	`wr™e_pci_cÚfig
(0, 
num
, 3, 0x90, 
­”_Üd”
<<1);

297 
	`wr™e_pci_cÚfig
(0, 
num
, 3, 0x94, 
­”_®loc
>>25);

299 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic_64.c

17 
	~<lšux/š™.h
>

19 
	~<lšux/mm.h
>

20 
	~<lšux/d–ay.h
>

21 
	~<lšux/boÙmem.h
>

22 
	~<lšux/š‹¼u±.h
>

23 
	~<lšux/mc146818¹c.h
>

24 
	~<lšux/k”Ãl_¡©.h
>

25 
	~<lšux/sysdev.h
>

26 
	~<lšux/moduË.h
>

27 
	~<lšux/iİÜt.h
>

28 
	~<lšux/şockchs.h
>

30 
	~<asm/©omic.h
>

31 
	~<asm/smp.h
>

32 
	~<asm/mŒr.h
>

33 
	~<asm/mp¥ec.h
>

34 
	~<asm/pg®loc.h
>

35 
	~<asm/mach_­ic.h
>

36 
	~<asm/nmi.h
>

37 
	~<asm/idË.h
>

38 
	~<asm/´Ùo.h
>

39 
	~<asm/timex.h
>

40 
	~<asm/h³t.h
>

41 
	~<asm/­ic.h
>

43 
	g­ic_v”bos™y
;

44 
di§bË_­ic_tim”
 
	g__ıuš™d©a
;

45 
­ic_ÿlib¿‹_pmtmr
 
	g__š™d©a
;

48 
	gloÿl_­ic_tim”_c2_ok
;

49 
EXPORT_SYMBOL_GPL
(
loÿl_­ic_tim”_c2_ok
);

51 
»sourû
 *
	gißpic_»sourûs
;

52 
»sourû
 
	gÏpic_»sourû
 = {

53 .
Çme
 = "Local APIC",

54 .
	gæags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

57 
	gÿlib¿tiÚ_»suÉ
;

59 
Ïpic_Ãxt_ev’t
(
d–
,

60 
şock_ev’t_deviû
 *
evt
);

61 
Ïpic_tim”_£tup
(
şock_ev’t_mode
 
mode
,

62 
şock_ev’t_deviû
 *
evt
);

64 
Ïpic_tim”_brßdÿ¡
(
ıumask_t
 
mask
);

66 
__£tup_APIC_LVTT
(
şocks
, 
ÚeshÙ
, 
œq’
);

68 
şock_ev’t_deviû
 
	gÏpic_şockev’t
 = {

69 .
Çme
 = "lapic",

70 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


71 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

72 .
	gshiá
 = 32,

73 .
	g£t_mode
 = 
Ïpic_tim”_£tup
,

74 .
	g£t_Ãxt_ev’t
 = 
Ïpic_Ãxt_ev’t
,

75 .
	gbrßdÿ¡
 = 
Ïpic_tim”_brßdÿ¡
,

76 .
	g¿tšg
 = 100,

77 .
	gœq
 = -1,

79 
DEFINE_PER_CPU
(
şock_ev’t_deviû
, 
Ïpic_ev’ts
);

81 
	$Ïpic_Ãxt_ev’t
(
d–
,

82 
şock_ev’t_deviû
 *
evt
)

84 
	`­ic_wr™e
(
APIC_TMICT
, 
d–
);

86 
	}
}

88 
	$Ïpic_tim”_£tup
(
şock_ev’t_mode
 
mode
,

89 
şock_ev’t_deviû
 *
evt
)

91 
æags
;

92 
v
;

95 ià(
evt
->
ã©u»s
 & 
CLOCK_EVT_FEAT_DUMMY
)

98 
	`loÿl_œq_§ve
(
æags
);

100 
mode
) {

101 
CLOCK_EVT_MODE_PERIODIC
:

102 
CLOCK_EVT_MODE_ONESHOT
:

103 
	`__£tup_APIC_LVTT
(
ÿlib¿tiÚ_»suÉ
,

104 
mode
 !ğ
CLOCK_EVT_MODE_PERIODIC
, 1);

106 
CLOCK_EVT_MODE_UNUSED
:

107 
CLOCK_EVT_MODE_SHUTDOWN
:

108 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

109 
v
 |ğ(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

110 
	`­ic_wr™e
(
APIC_LVTT
, 
v
);

112 
CLOCK_EVT_MODE_RESUME
:

117 
	`loÿl_œq_»¡Üe
(
æags
);

118 
	}
}

123 
	$Ïpic_tim”_brßdÿ¡
(
ıumask_t
 
mask
)

125 #ifdeà
CONFIG_SMP


126 
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

128 
	}
}

130 
­ic_pm_aùiv©e
();

132 
	$­ic_wa™_iü_idË
()

134 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
)

135 
	`ıu_»Ïx
();

136 
	}
}

138 
	$§ã_­ic_wa™_iü_idË
()

140 
£nd_¡©us
;

141 
timeout
;

143 
timeout
 = 0;

145 
£nd_¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
;

146 ià(!
£nd_¡©us
)

148 
	`ud–ay
(100);

149 } 
timeout
++ < 1000);

151  
£nd_¡©us
;

152 
	}
}

154 
	$’abË_NMI_through_LVT0
 (* 
dummy
)

156 
v
;

159 
v
 = 
APIC_DM_NMI
;

160 
	`­ic_wr™e
(
APIC_LVT0
, 
v
);

161 
	}
}

163 
	$g‘_maxlvt
()

165 
v
, 
maxlvt
;

167 
v
 = 
	`­ic_»ad
(
APIC_LVR
);

168 
maxlvt
 = 
	`GET_APIC_MAXLVT
(
v
);

169  
maxlvt
;

170 
	}
}

176 
	$ack_bad_œq
(
œq
)

178 
	`´štk
("uÃx³ùed IRQ¿°© veùÜ %02x\n", 
œq
);

188 ià(!
di§bË_­ic
)

189 
	`ack_APIC_œq
();

190 
	}
}

192 
	$ş—r_loÿl_APIC
()

194 
maxlvt
;

195 
v
;

197 
maxlvt
 = 
	`g‘_maxlvt
();

203 ià(
maxlvt
 >= 3) {

204 
v
 = 
ERROR_APIC_VECTOR
;

205 
	`­ic_wr™e
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

211 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

212 
	`­ic_wr™e
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

213 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

214 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

215 
v
 = 
	`­ic_»ad
(
APIC_LVT1
);

216 
	`­ic_wr™e
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

217 ià(
maxlvt
 >= 4) {

218 
v
 = 
	`­ic_»ad
(
APIC_LVTPC
);

219 
	`­ic_wr™e
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

225 
	`­ic_wr™e
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

226 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

227 
	`­ic_wr™e
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

228 ià(
maxlvt
 >= 3)

229 
	`­ic_wr™e
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

230 ià(
maxlvt
 >= 4)

231 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

232 
	`­ic_wr™e
(
APIC_ESR
, 0);

233 
	`­ic_»ad
(
APIC_ESR
);

234 
	}
}

236 
	$discÚÃù_b¥_APIC
(
vœt_wœe_£tup
)

239 
v®ue
;

242 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

243 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

244 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

245 
v®ue
 |= 0xf;

246 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

248 ià(!
vœt_wœe_£tup
) {

253 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
);

254 
v®ue
 &ğ~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

255 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

256 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
 );

257 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

258 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_EXTINT
);

259 
	`­ic_wr™e
(
APIC_LVT0
, 
v®ue
);

262 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

266 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT1
);

267 
v®ue
 &ğ~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

268 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

269 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

270 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

271 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_NMI
);

272 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

273 
	}
}

275 
	$di§bË_loÿl_APIC
()

277 
v®ue
;

279 
	`ş—r_loÿl_APIC
();

285 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

286 
v®ue
 &ğ~
APIC_SPIV_APIC_ENABLED
;

287 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

288 
	}
}

290 
	$Ïpic_shutdown
()

292 
æags
;

294 ià(!
ıu_has_­ic
)

297 
	`loÿl_œq_§ve
(
æags
);

299 
	`di§bË_loÿl_APIC
();

301 
	`loÿl_œq_»¡Üe
(
æags
);

302 
	}
}

309 
__š™
 
	$v”ify_loÿl_APIC
()

311 
»g0
, 
»g1
;

316 
»g0
 = 
	`­ic_»ad
(
APIC_LVR
);

317 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g0
);

318 
	`­ic_wr™e
(
APIC_LVR
, 
»g0
 ^ 
APIC_LVR_MASK
);

319 
»g1
 = 
	`­ic_»ad
(
APIC_LVR
);

320 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g1
);

327 ià(
»g1
 !ğ
»g0
)

333 
»g1
 = 
	`GET_APIC_VERSION
(
»g0
);

334 ià(
»g1
 == 0x00 ||„eg1 == 0xff)

336 
»g1
 = 
	`g‘_maxlvt
();

337 ià(
»g1
 < 0x02 ||„eg1 == 0xff)

343 
»g0
 = 
	`­ic_»ad
(
APIC_ID
);

344 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg ID: %x\n", 
»g0
);

345 
	`­ic_wr™e
(
APIC_ID
, 
»g0
 ^ 
APIC_ID_MASK
);

346 
»g1
 = 
	`­ic_»ad
(
APIC_ID
);

347 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg ID: %x\n", 
»g1
);

348 
	`­ic_wr™e
(
APIC_ID
, 
»g0
);

349 ià(
»g1
 !ğ(
»g0
 ^ 
APIC_ID_MASK
))

357 
»g0
 = 
	`­ic_»ad
(
APIC_LVT0
);

358 
	`­ic_´štk
(
APIC_DEBUG
,"G‘tšg LVT0: %x\n", 
»g0
);

359 
»g1
 = 
	`­ic_»ad
(
APIC_LVT1
);

360 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg LVT1: %x\n", 
»g1
);

363 
	}
}

365 
__š™
 
	$sync_Arb_IDs
()

368 
v”
 = 
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

369 ià(
v”
 >= 0x14)

375 
	`­ic_wa™_iü_idË
();

377 
	`­ic_´štk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

378 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_DEST_ALLINC
 | 
APIC_INT_LEVELTRIG


379 | 
APIC_DM_INIT
);

380 
	}
}

385 
__š™
 
	$š™_b¥_APIC
()

387 
v®ue
;

393 ià(
smp_found_cÚfig
 || !
ıu_has_­ic
)

396 
v®ue
 = 
	`­ic_»ad
(
APIC_LVR
);

401 
	`ş—r_loÿl_APIC
();

406 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

407 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

408 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

409 
v®ue
 |ğ
APIC_SPIV_FOCUS_DISABLED
;

410 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

411 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

416 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

417 
v®ue
 = 
APIC_DM_NMI
;

418 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

419 
	}
}

421 
__ıuš™
 
	$£tup_loÿl_APIC
 ()

423 
v®ue
, 
maxlvt
;

424 
i
, 
j
;

426 
v®ue
 = 
	`­ic_»ad
(
APIC_LVR
);

428 
	`BUILD_BUG_ON
((
SPURIOUS_APIC_VECTOR
 & 0x0f) != 0x0f);

434 ià(!
	`­ic_id_»gi¡”ed
())

435 
	`BUG
();

442 
	`š™_­ic_ldr
();

448 
v®ue
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

449 
v®ue
 &ğ~
APIC_TPRI_MASK
;

450 
	`­ic_wr™e
(
APIC_TASKPRI
, 
v®ue
);

463 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

464 
v®ue
 = 
	`­ic_»ad
(
APIC_ISR
 + 
i
*0x10);

465 
j
 = 31; j >= 0; j--) {

466 ià(
v®ue
 & (1<<
j
))

467 
	`ack_APIC_œq
();

474 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

475 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

479 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

486 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

487 
	`­ic_wr™e
(
APIC_SPIV
, 
v®ue
);

499 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
è& 
APIC_LVT_MASKED
;

500 ià(!
	`smp_´oûssÜ_id
(è&& !
v®ue
) {

501 
v®ue
 = 
APIC_DM_EXTINT
;

502 
	`­ic_´štk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

503 
	`smp_´oûssÜ_id
());

505 
v®ue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

506 
	`­ic_´štk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

507 
	`smp_´oûssÜ_id
());

509 
	`­ic_wr™e
(
APIC_LVT0
, 
v®ue
);

514 ià(!
	`smp_´oûssÜ_id
())

515 
v®ue
 = 
APIC_DM_NMI
;

517 
v®ue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

518 
	`­ic_wr™e
(
APIC_LVT1
, 
v®ue
);

521 
Şdv®ue
;

522 
maxlvt
 = 
	`g‘_maxlvt
();

523 
Şdv®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

524 
v®ue
 = 
ERROR_APIC_VECTOR
;

525 
	`­ic_wr™e
(
APIC_LVTERR
, 
v®ue
);

529 ià(
maxlvt
 > 3)

530 
	`­ic_wr™e
(
APIC_ESR
, 0);

531 
v®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

532 ià(
v®ue
 !ğ
Şdv®ue
)

533 
	`­ic_´štk
(
APIC_VERBOSE
,

535 
Şdv®ue
, 
v®ue
);

538 
	`nmi_w©chdog_deçuÉ
();

539 
	`£tup_­ic_nmi_w©chdog
(
NULL
);

540 
	`­ic_pm_aùiv©e
();

541 
	}
}

543 #ifdeà
CONFIG_PM


549 
	maùive
;

551 
	m­ic_id
;

552 
	m­ic_sk´i
;

553 
	m­ic_ldr
;

554 
	m­ic_dä
;

555 
	m­ic_¥iv
;

556 
	m­ic_lv‰
;

557 
	m­ic_lvc
;

558 
	m­ic_lvt0
;

559 
	m­ic_lvt1
;

560 
	m­ic_lv‹¼
;

561 
	m­ic_tmiù
;

562 
	m­ic_tdü
;

563 
	m­ic_thmr
;

564 } 
	g­ic_pm_¡©e
;

566 
	$Ïpic_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

568 
æags
;

569 
maxlvt
;

571 ià(!
­ic_pm_¡©e
.
aùive
)

574 
maxlvt
 = 
	`g‘_maxlvt
();

576 
­ic_pm_¡©e
.
­ic_id
 = 
	`­ic_»ad
(
APIC_ID
);

577 
­ic_pm_¡©e
.
­ic_sk´i
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

578 
­ic_pm_¡©e
.
­ic_ldr
 = 
	`­ic_»ad
(
APIC_LDR
);

579 
­ic_pm_¡©e
.
­ic_dä
 = 
	`­ic_»ad
(
APIC_DFR
);

580 
­ic_pm_¡©e
.
­ic_¥iv
 = 
	`­ic_»ad
(
APIC_SPIV
);

581 
­ic_pm_¡©e
.
­ic_lv‰
 = 
	`­ic_»ad
(
APIC_LVTT
);

582 ià(
maxlvt
 >= 4)

583 
­ic_pm_¡©e
.
­ic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

584 
­ic_pm_¡©e
.
­ic_lvt0
 = 
	`­ic_»ad
(
APIC_LVT0
);

585 
­ic_pm_¡©e
.
­ic_lvt1
 = 
	`­ic_»ad
(
APIC_LVT1
);

586 
­ic_pm_¡©e
.
­ic_lv‹¼
 = 
	`­ic_»ad
(
APIC_LVTERR
);

587 
­ic_pm_¡©e
.
­ic_tmiù
 = 
	`­ic_»ad
(
APIC_TMICT
);

588 
­ic_pm_¡©e
.
­ic_tdü
 = 
	`­ic_»ad
(
APIC_TDCR
);

589 #ifdeà
CONFIG_X86_MCE_INTEL


590 ià(
maxlvt
 >= 5)

591 
­ic_pm_¡©e
.
­ic_thmr
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

593 
	`loÿl_œq_§ve
(
æags
);

594 
	`di§bË_loÿl_APIC
();

595 
	`loÿl_œq_»¡Üe
(
æags
);

597 
	}
}

599 
	$Ïpic_»sume
(
sys_deviû
 *
dev
)

601 
l
, 
h
;

602 
æags
;

603 
maxlvt
;

605 ià(!
­ic_pm_¡©e
.
aùive
)

608 
maxlvt
 = 
	`g‘_maxlvt
();

610 
	`loÿl_œq_§ve
(
æags
);

611 
	`rdm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

612 
l
 &ğ~
MSR_IA32_APICBASE_BASE
;

613 
l
 |ğ
MSR_IA32_APICBASE_ENABLE
 | 
mp_Ïpic_addr
;

614 
	`wrm¤
(
MSR_IA32_APICBASE
, 
l
, 
h
);

615 
	`­ic_wr™e
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

616 
	`­ic_wr™e
(
APIC_ID
, 
­ic_pm_¡©e
.
­ic_id
);

617 
	`­ic_wr™e
(
APIC_DFR
, 
­ic_pm_¡©e
.
­ic_dä
);

618 
	`­ic_wr™e
(
APIC_LDR
, 
­ic_pm_¡©e
.
­ic_ldr
);

619 
	`­ic_wr™e
(
APIC_TASKPRI
, 
­ic_pm_¡©e
.
­ic_sk´i
);

620 
	`­ic_wr™e
(
APIC_SPIV
, 
­ic_pm_¡©e
.
­ic_¥iv
);

621 
	`­ic_wr™e
(
APIC_LVT0
, 
­ic_pm_¡©e
.
­ic_lvt0
);

622 
	`­ic_wr™e
(
APIC_LVT1
, 
­ic_pm_¡©e
.
­ic_lvt1
);

623 #ifdeà
CONFIG_X86_MCE_INTEL


624 ià(
maxlvt
 >= 5)

625 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
­ic_pm_¡©e
.
­ic_thmr
);

627 ià(
maxlvt
 >= 4)

628 
	`­ic_wr™e
(
APIC_LVTPC
, 
­ic_pm_¡©e
.
­ic_lvc
);

629 
	`­ic_wr™e
(
APIC_LVTT
, 
­ic_pm_¡©e
.
­ic_lv‰
);

630 
	`­ic_wr™e
(
APIC_TDCR
, 
­ic_pm_¡©e
.
­ic_tdü
);

631 
	`­ic_wr™e
(
APIC_TMICT
, 
­ic_pm_¡©e
.
­ic_tmiù
);

632 
	`­ic_wr™e
(
APIC_ESR
, 0);

633 
	`­ic_»ad
(
APIC_ESR
);

634 
	`­ic_wr™e
(
APIC_LVTERR
, 
­ic_pm_¡©e
.
­ic_lv‹¼
);

635 
	`­ic_wr™e
(
APIC_ESR
, 0);

636 
	`­ic_»ad
(
APIC_ESR
);

637 
	`loÿl_œq_»¡Üe
(
æags
);

639 
	}
}

641 
sysdev_şass
 
	gÏpic_sysşass
 = {

642 
£t_k£t_Çme
("lapic"),

643 .
»sume
 = 
Ïpic_»sume
,

644 .
	gsu¥’d
 = 
Ïpic_su¥’d
,

647 
sys_deviû
 
	gdeviû_Ïpic
 = {

648 .
id
 = 0,

649 .
	gşs
 = &
Ïpic_sysşass
,

652 
__ıuš™
 
	$­ic_pm_aùiv©e
()

654 
­ic_pm_¡©e
.
aùive
 = 1;

655 
	}
}

657 
__š™
 
	$š™_Ïpic_sysfs
()

659 
”rÜ
;

660 ià(!
ıu_has_­ic
)

663 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
Ïpic_sysşass
);

664 ià(!
”rÜ
)

665 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_Ïpic
);

666  
”rÜ
;

667 
	}
}

668 
deviû_š™ÿÎ
(
š™_Ïpic_sysfs
);

672 
	$­ic_pm_aùiv©e
(è{ 
	}
}

676 
__š™
 
	$­ic_£t_v”bos™y
(*
¡r
)

678 ià(
¡r
 =ğ
NULL
) {

679 
sk_ißpic_£tup
 = 0;

680 
ißpic_fÜû
 = 1;

683 ià(
	`¡rcmp
("debug", 
¡r
) == 0)

684 
­ic_v”bos™y
 = 
APIC_DEBUG
;

685 ià(
	`¡rcmp
("v”bo£", 
¡r
) == 0)

686 
­ic_v”bos™y
 = 
APIC_VERBOSE
;

688 
	`´štk
(
KERN_WARNING
 "APIC Verbosity†evel %s‚ot„ecognised"

689 " u£‡pic=v”bo£ o¸­ic=debug\n", 
¡r
);

690  -
EINVAL
;

694 
	}
}

695 
—¾y_·¿m
("­ic", 
­ic_£t_v”bos™y
);

704 
__š™
 
	$d‘eù_š™_APIC
 ()

706 ià(!
ıu_has_­ic
) {

707 
	`´štk
(
KERN_INFO
 "No†ocal APIC…resent\n");

711 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

712 
boÙ_ıu_id
 = 0;

714 
	}
}

716 #ifdeà
CONFIG_X86_IO_APIC


717 
»sourû
 * 
__š™
 
	$ißpic_£tup_»sourûs
()

719 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

720 
n
;

721 
»sourû
 *
»s
;

722 *
mem
;

723 
i
;

725 ià(
Ä_ißpics
 <= 0)

726  
NULL
;

728 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
»sourû
);

729 
n
 *ğ
Ä_ißpics
;

731 
mem
 = 
	`®loc_boÙmem
(
n
);

732 
»s
 = (*)
mem
;

734 ià(
mem
 !ğ
NULL
) {

735 
	`mem£t
(
mem
, 0, 
n
);

736 
mem
 +ğ(
»sourû
è* 
Ä_ißpics
;

738 
i
 = 0; i < 
Ä_ißpics
; i++) {

739 
»s
[
i
].
Çme
 = 
mem
;

740 
»s
[
i
].
æags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

741 
	`¥rštf
(
mem
, "IOAPIC %u", 
i
);

742 
mem
 +ğ
IOAPIC_RESOURCE_NAME_SIZE
;

746 
ißpic_»sourûs
 = 
»s
;

748  
»s
;

749 
	}
}

751 
__š™
 
	$ißpic_š£¹_»sourûs
()

753 
i
;

754 
»sourû
 *
r
 = 
ißpic_»sourûs
;

756 ià(!
r
) {

757 
	`´štk
("IO APIC„esources could be‚ot be‡llocated.\n");

761 
i
 = 0; i < 
Ä_ißpics
; i++) {

762 
	`š£¹_»sourû
(&
iomem_»sourû
, 
r
);

763 
r
++;

767 
	}
}

771 
Ï‹_š™ÿÎ
(
ißpic_š£¹_»sourûs
);

774 
__š™
 
	$š™_­ic_m­pšgs
()

776 
­ic_phys
;

783 ià(!
smp_found_cÚfig
 && 
	`d‘eù_š™_APIC
()) {

784 
­ic_phys
 = (è
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

785 
­ic_phys
 = 
	`__·
(apic_phys);

787 
­ic_phys
 = 
mp_Ïpic_addr
;

789 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
­ic_phys
);

790 
	`­ic_´štk
(
APIC_VERBOSE
, "mapped APICo %16lx (%16lx)\n",

791 
APIC_BASE
, 
­ic_phys
);

794 
Ïpic_»sourû
.
¡¬t
 = 
­ic_phys
;

795 
Ïpic_»sourû
.
’d
 =†­ic_»sourû.
¡¬t
 + 
PAGE_SIZE
 - 1;

796 
	`š£¹_»sourû
(&
iomem_»sourû
, &
Ïpic_»sourû
);

802 
boÙ_ıu_id
 = 
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
));

805 
ißpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

806 
i
;

807 
»sourû
 *
ißpic_»s
;

809 
ißpic_»s
 = 
	`ißpic_£tup_»sourûs
();

810 
i
 = 0; i < 
Ä_ißpics
; i++) {

811 ià(
smp_found_cÚfig
) {

812 
ißpic_phys
 = 
mp_ißpics
[
i
].
mpc_­iÿddr
;

814 
ißpic_phys
 = ()

815 
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

816 
ißpic_phys
 = 
	`__·
(ioapic_phys);

818 
	`£t_fixm­_noÿche
(
idx
, 
ißpic_phys
);

819 
	`­ic_´štk
(
APIC_VERBOSE
,

821 
	`__fix_to_vœt
(
idx
), 
ißpic_phys
);

822 
idx
++;

824 ià(
ißpic_»s
 !ğ
NULL
) {

825 
ißpic_»s
->
¡¬t
 = 
ißpic_phys
;

826 
ißpic_»s
->
’d
 = 
ißpic_phys
 + (4 * 1024) - 1;

827 
ißpic_»s
++;

831 
	}
}

844 
	$__£tup_APIC_LVTT
(
şocks
, 
ÚeshÙ
, 
œq’
)

846 
lv‰_v®ue
, 
tmp_v®ue
;

848 
lv‰_v®ue
 = 
LOCAL_TIMER_VECTOR
;

849 ià(!
ÚeshÙ
)

850 
lv‰_v®ue
 |ğ
APIC_LVT_TIMER_PERIODIC
;

851 ià(!
œq’
)

852 
lv‰_v®ue
 |ğ
APIC_LVT_MASKED
;

854 
	`­ic_wr™e
(
APIC_LVTT
, 
lv‰_v®ue
);

859 
tmp_v®ue
 = 
	`­ic_»ad
(
APIC_TDCR
);

860 
	`­ic_wr™e
(
APIC_TDCR
, (
tmp_v®ue


861 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
))

862 | 
APIC_TDR_DIV_16
);

864 ià(!
ÚeshÙ
)

865 
	`­ic_wr™e
(
APIC_TMICT
, 
şocks
);

866 
	}
}

868 
	$£tup_APIC_tim”
()

870 
şock_ev’t_deviû
 *
Ëvt
 = &
	`__g‘_ıu_v¬
(
Ïpic_ev’ts
);

872 
	`memıy
(
Ëvt
, &
Ïpic_şockev’t
, (*levt));

873 
Ëvt
->
ıumask
 = 
	`ıumask_of_ıu
(
	`smp_´oûssÜ_id
());

875 
	`şockev’ts_»gi¡”_deviû
(
Ëvt
);

876 
	}
}

891 
	#TICK_COUNT
 100000000

	)

893 
__š™
 
	$ÿlib¿‹_APIC_şock
()

895 
­ic
, 
­ic_¡¬t
;

896 
tsc
, 
tsc_¡¬t
;

897 
»suÉ
;

899 
	`loÿl_œq_di§bË
();

908 
	`__£tup_APIC_LVTT
(250000000, 0, 0);

910 
­ic_¡¬t
 = 
	`­ic_»ad
(
APIC_TMCCT
);

911 #ifdeà
CONFIG_X86_PM_TIMER


912 ià(
­ic_ÿlib¿‹_pmtmr
 && 
pmtmr_iİÜt
) {

913 
	`pmtim”_wa™
(5000);

914 
­ic
 = 
	`­ic_»ad
(
APIC_TMCCT
);

915 
»suÉ
 = (
­ic_¡¬t
 - 
­ic
) * 1000L / 5;

919 
	`rdtsşl
(
tsc_¡¬t
);

922 
­ic
 = 
	`­ic_»ad
(
APIC_TMCCT
);

923 
	`rdtsşl
(
tsc
);

924 } (
tsc
 - 
tsc_¡¬t
è< 
TICK_COUNT
 &&

925 (
­ic_¡¬t
 - 
­ic
è< 
TICK_COUNT
);

927 
»suÉ
 = (
­ic_¡¬t
 - 
­ic
è* 1000L * 
tsc_khz
 /

928 (
tsc
 - 
tsc_¡¬t
);

931 
	`loÿl_œq_’abË
();

933 
	`´štk
(
KERN_DEBUG
 "APICim” c®ib¿tiÚ„esuÉ %d\n", 
»suÉ
);

935 
	`´štk
(
KERN_INFO
 "Detected %d.%03d MHz APICimer.\n",

936 
»suÉ
 / 1000 / 1000,„esult / 1000 % 1000);

939 
Ïpic_şockev’t
.
muÉ
 = 
	`div_sc
(
»suÉ
, 
NSEC_PER_SEC
, 32);

940 
Ïpic_şockev’t
.
max_d–_ns
 =

941 
	`şockev’t_d–2ns
(0x7FFFFF, &
Ïpic_şockev’t
);

942 
Ïpic_şockev’t
.
mš_d–_ns
 =

943 
	`şockev’t_d–2ns
(0xF, &
Ïpic_şockev’t
);

945 
ÿlib¿tiÚ_»suÉ
 = 
»suÉ
 / 
HZ
;

946 
	}
}

948 
__š™
 
	$£tup_boÙ_APIC_şock
 ()

956 ià(
di§bË_­ic_tim”
) {

957 
	`´štk
(
KERN_INFO
 "Disabling APICimer\n");

959 ià(
	`num_possibË_ıus
() > 1)

960 
	`£tup_APIC_tim”
();

964 
	`´štk
(
KERN_INFO
 "Using†ocal APICimer interrupts.\n");

965 
	`ÿlib¿‹_APIC_şock
();

972 ià(
nmi_w©chdog
 !ğ
NMI_IO_APIC
)

973 
Ïpic_şockev’t
.
ã©u»s
 &ğ~
CLOCK_EVT_FEAT_DUMMY
;

975 
	`´štk
(
KERN_WARNING
 "APICimer„egistered‡s dummy,"

978 
	`£tup_APIC_tim”
();

979 
	}
}

989 
__ıuš™
 
	$check_boÙ_­ic_tim”_brßdÿ¡
()

991 ià(!
di§bË_­ic_tim”
 ||

992 (
Ïpic_şockev’t
.
ã©u»s
 & 
CLOCK_EVT_FEAT_DUMMY
))

995 
	`´štk
(
KERN_INFO
 "AMD C1E detected†ate. Forceimer broadcast.\n");

996 
Ïpic_şockev’t
.
ã©u»s
 |ğ
CLOCK_EVT_FEAT_DUMMY
;

998 
	`loÿl_œq_’abË
();

999 
	`şockev’ts_nÙify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
, &
boÙ_ıu_id
);

1000 
	`loÿl_œq_di§bË
();

1001 
	}
}

1003 
__ıuš™
 
	$£tup_£cÚd¬y_APIC_şock
()

1005 
	`check_boÙ_­ic_tim”_brßdÿ¡
();

1006 
	`£tup_APIC_tim”
();

1007 
	}
}

1009 
	$£tup_´ofšg_tim”
(
muÉl›r
)

1011  -
EINVAL
;

1012 
	}
}

1014 
	$£tup_APIC_ex‹nded_lvt
(
lvt_off
, 
veùÜ
,

1015 
msg_ty³
, 
mask
)

1017 
»g
 = (
lvt_off
 << 4è+ 
K8_APIC_EXT_LVT_BASE
;

1018 
v
 = (
mask
 << 16è| (
msg_ty³
 << 8è| 
veùÜ
;

1019 
	`­ic_wr™e
(
»g
, 
v
);

1020 
	}
}

1032 
	$smp_loÿl_tim”_š‹¼u±
()

1034 
ıu
 = 
	`smp_´oûssÜ_id
();

1035 
şock_ev’t_deviû
 *
evt
 = &
	`³r_ıu
(
Ïpic_ev’ts
, 
ıu
);

1048 ià(!
evt
->
ev’t_hªdËr
) {

1049 
	`´štk
(
KERN_WARNING


1050 "Spuriou LAPICim” iÁ”ru± oÀıu %d\n", 
ıu
);

1052 
	`Ïpic_tim”_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

1059 
	`add_pda
(
­ic_tim”_œqs
, 1);

1061 
evt
->
	`ev’t_hªdËr
(evt);

1062 
	}
}

1072 
	$smp_­ic_tim”_š‹¼u±
(
±_»gs
 *
»gs
)

1074 
±_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1080 
	`ack_APIC_œq
();

1086 
	`ex™_idË
();

1087 
	`œq_’‹r
();

1088 
	`smp_loÿl_tim”_š‹¼u±
();

1089 
	`œq_ex™
();

1090 
	`£t_œq_»gs
(
Şd_»gs
);

1091 
	}
}

1102 
__ıuš™
 
	$­ic_is_şu¡”ed_box
()

1104 
i
, 
şu¡”s
, 
z”os
;

1105 
id
;

1106 
	`DECLARE_BITMAP
(
şu¡”m­
, 
NUM_APIC_CLUSTERS
);

1108 
	`b™m­_z”o
(
şu¡”m­
, 
NUM_APIC_CLUSTERS
);

1110 
i
 = 0; i < 
NR_CPUS
; i++) {

1111 
id
 = 
bios_ıu_­icid
[
i
];

1112 ià(
id
 !ğ
BAD_APICID
)

1113 
	`__£t_b™
(
	`APIC_CLUSTERID
(
id
), 
şu¡”m­
);

1122 
şu¡”s
 = 0;

1123 
z”os
 = 0;

1124 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

1125 ià(
	`‹¡_b™
(
i
, 
şu¡”m­
)) {

1126 
şu¡”s
 +ğ1 + 
z”os
;

1127 
z”os
 = 0;

1129 ++
z”os
;

1137  (
şu¡”s
 > 2);

1138 
	}
}

1143 
asmlškage
 
	$smp_¥urious_š‹¼u±
()

1145 
v
;

1146 
	`ex™_idË
();

1147 
	`œq_’‹r
();

1153 
v
 = 
	`­ic_»ad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1154 ià(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1155 
	`ack_APIC_œq
();

1157 
	`add_pda
(
œq_¥urious_couÁ
, 1);

1158 
	`œq_ex™
();

1159 
	}
}

1165 
asmlškage
 
	$smp_”rÜ_š‹¼u±
()

1167 
v
, 
v1
;

1169 
	`ex™_idË
();

1170 
	`œq_’‹r
();

1172 
v
 = 
	`­ic_»ad
(
APIC_ESR
);

1173 
	`­ic_wr™e
(
APIC_ESR
, 0);

1174 
v1
 = 
	`­ic_»ad
(
APIC_ESR
);

1175 
	`ack_APIC_œq
();

1176 
	`©omic_šc
(&
œq_”r_couÁ
);

1188 
	`´štk
 (
KERN_DEBUG
 "APICƒrror on CPU%d: %02x(%02x)\n",

1189 
	`smp_´oûssÜ_id
(), 
v
 , 
v1
);

1190 
	`œq_ex™
();

1191 
	}
}

1193 
	gdi§bË_­ic
;

1199 
__š™
 
	$APIC_š™_unroûssÜ
 ()

1201 ià(
di§bË_­ic
) {

1202 
	`´štk
(
KERN_INFO
 "Apic disabled\n");

1205 ià(!
ıu_has_­ic
) {

1206 
di§bË_­ic
 = 1;

1207 
	`´štk
(
KERN_INFO
 "Apic disabled by BIOS\n");

1211 
	`v”ify_loÿl_APIC
();

1213 
phys_ıu_´e£Á_m­
 = 
	`physid_mask_of_physid
(
boÙ_ıu_id
);

1214 
	`­ic_wr™e
(
APIC_ID
, 
	`SET_APIC_ID
(
boÙ_ıu_id
));

1216 
	`£tup_loÿl_APIC
();

1218 ià(
smp_found_cÚfig
 && !
sk_ißpic_£tup
 && 
Ä_ißpics
)

1219 
	`£tup_IO_APIC
();

1221 
Ä_ißpics
 = 0;

1222 
	`£tup_boÙ_APIC_şock
();

1223 
	`check_nmi_w©chdog
();

1225 
	}
}

1227 
__š™
 
	$£tup_di§bË­ic
(*
¡r
)

1229 
di§bË_­ic
 = 1;

1230 
	`ş—r_b™
(
X86_FEATURE_APIC
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

1232 
	}
}

1233 
—¾y_·¿m
("di§bË­ic", 
£tup_di§bË­ic
);

1236 
__š™
 
	$£tup_nŞ­ic
(*
¡r
)

1238  
	`£tup_di§bË­ic
(
¡r
);

1239 
	}
}

1240 
—¾y_·¿m
("nŞ­ic", 
£tup_nŞ­ic
);

1242 
__š™
 
	$·r£_Ïpic_tim”_c2_ok
(*
¬g
)

1244 
loÿl_­ic_tim”_c2_ok
 = 1;

1246 
	}
}

1247 
—¾y_·¿m
("Ïpic_tim”_c2_ok", 
·r£_Ïpic_tim”_c2_ok
);

1249 
__š™
 
	$£tup_nßpiùim”
(*
¡r
)

1251 ià(
¡r
[0] != ' ' && str[0] != 0)

1253 
di§bË_­ic_tim”
 = 1;

1255 
	}
}

1256 
__£tup
("nßpiùim”", 
£tup_nßpiùim”
);

1258 
__š™
 
	$£tup_­iımtim”
(*
s
)

1260 
­ic_ÿlib¿‹_pmtmr
 = 1;

1261 
	`nÙsc_£tup
(
NULL
);

1263 
	}
}

1264 
__£tup
("­iımtim”", 
£tup_­iımtim”
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/¡ršg.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<lšux/¥šlock.h
>

12 
	~<lšux/aıi.h
>

13 
	~<asm/io.h
>

15 
	~<lšux/mc146818¹c.h
>

18 
	#SBF_RESERVED
 (0x78)

	)

19 
	#SBF_PNPOS
 (1<<0)

	)

20 
	#SBF_BOOTING
 (1<<1)

	)

21 
	#SBF_DIAG
 (1<<2)

	)

22 
	#SBF_PARITY
 (1<<7)

	)

25 
sbf_pÜt
 
	g__š™d©a
 = -1;

28 
__š™
 
	$·r™y
(
u8
 
v
)

30 
x
 = 0;

31 
i
;

33 
i
=0;i<8;i++)

35 
x
^=(
v
&1);

36 
v
>>=1;

38  
x
;

39 
	}
}

41 
__š™
 
	$sbf_wr™e
(
u8
 
v
)

43 
æags
;

44 if(
sbf_pÜt
 != -1)

46 
v
 &ğ~
SBF_PARITY
;

47 if(!
	`·r™y
(
v
))

48 
v
|=
SBF_PARITY
;

50 
	`´štk
(
KERN_INFO
 "Sim¶BoÙ FÏg‡ˆ0x%x s‘Ø0x%x\n", 
sbf_pÜt
, 
v
);

52 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

53 
	`CMOS_WRITE
(
v
, 
sbf_pÜt
);

54 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

56 
	}
}

58 
u8
 
__š™
 
	$sbf_»ad
()

60 
u8
 
v
;

61 
æags
;

62 if(
sbf_pÜt
 == -1)

64 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

65 
v
 = 
	`CMOS_READ
(
sbf_pÜt
);

66 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

67  
v
;

68 
	}
}

70 
__š™
 
	$sbf_v®ue_v®id
(
u8
 
v
)

72 if(
v
&
SBF_RESERVED
)

74 if(!
	`·r™y
(
v
))

77 
	}
}

79 
__š™
 
	$sbf_š™
()

81 
u8
 
v
;

82 if(
sbf_pÜt
 == -1)

84 
v
 = 
	`sbf_»ad
();

85 if(!
	`sbf_v®ue_v®id
(
v
))

86 
	`´štk
(
KERN_WARNING
 "Sim¶BoÙ FÏg v®u0x%x„—d from CMOS RAM wa šv®id\n",
v
);

88 
v
 &ğ~
SBF_RESERVED
;

89 
v
 &ğ~
SBF_BOOTING
;

90 
v
 &ğ~
SBF_DIAG
;

91 #ià
	`defšed
(
CONFIG_ISAPNP
)

92 
v
 |ğ
SBF_PNPOS
;

94 
	`sbf_wr™e
(
v
);

96 
	}
}

98 
moduË_š™
(
sbf_š™
);

	@/cmpt816/linux/arch/x86/kernel/bugs_64.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/š™.h
>

8 
	~<asm/®‹º©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/´oûssÜ.h
>

11 
	~<asm/mŒr.h
>

13 
__š™
 
	$check_bugs
()

15 
	`id’tify_ıu
(&
boÙ_ıu_d©a
);

16 
	`mŒr_bp_š™
();

17 #ià!
	`defšed
(
CONFIG_SMP
)

18 
	`´štk
("CPU: ");

19 
	`´št_ıu_šfo
(&
boÙ_ıu_d©a
);

21 
	`®‹º©ive_š¡ruùiÚs
();

22 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

7 
	~<lšux/ıu.h
>

9 
	~<asm/´oûssÜ.h
>

11 
	sıuid_b™
 {

12 
u16
 
	mã©u»
;

13 
u8
 
	m»g
;

14 
u8
 
	mb™
;

15 
u32
 
	mËv–
;

18 
	eıuid_»gs
 {

19 
	mCR_EAX
 = 0,

20 
	mCR_ECX
,

21 
	mCR_EDX
,

22 
	mCR_EBX


25 
__ıuš™
 
	$š™_sÿ‰”ed_ıuid_ã©u»s
(
ıušfo_x86
 *
c
)

27 
u32
 
max_Ëv–
;

28 
u32
 
»gs
[4];

29 cÚ¡ 
ıuid_b™
 *
cb
;

31 cÚ¡ 
ıuid_b™
 
ıuid_b™s
[] = {

32 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

36 
cb
 = 
ıuid_b™s
; cb->
ã©u»
; cb++) {

39 
max_Ëv–
 = 
	`ıuid_—x
(
cb
->
Ëv–
 & 0xffff0000);

40 ià(
max_Ëv–
 < 
cb
->
Ëv–
 ||

41 
max_Ëv–
 > (
cb
->
Ëv–
 | 0xffff))

44 
	`ıuid
(
cb
->
Ëv–
, &
»gs
[
CR_EAX
], &»gs[
CR_EBX
],

45 &
»gs
[
CR_ECX
], &»gs[
CR_EDX
]);

47 ià(
»gs
[
cb
->
»g
] & (1 << cb->
b™
))

48 
	`£t_b™
(
cb
->
ã©u»
, 
c
->
x86_ÿ·b™y
);

50 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/moduË.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/smp.h
>

32 
	~<lšux/sched.h
>

33 
	~<lšux/ıuäeq.h
>

34 
	~<lšux/comp”.h
>

35 
	~<lšux/dmi.h
>

37 
	~<lšux/aıi.h
>

38 
	~<aıi/´oûssÜ.h
>

40 
	~<asm/io.h
>

41 
	~<asm/m¤.h
>

42 
	~<asm/´oûssÜ.h
>

43 
	~<asm/ıuã©u».h
>

44 
	~<asm/d–ay.h
>

45 
	~<asm/uacûss.h
>

47 
	#d´štk
(
msg
...è
	`ıuäeq_debug_´štk
(
CPUFREQ_DEBUG_DRIVER
, "aıi-ıuäeq", msg)

	)

49 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

50 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

51 
MODULE_LICENSE
("GPL");

54 
	mUNDEFINED_CAPABLE
 = 0,

55 
	mSYSTEM_INTEL_MSR_CAPABLE
,

56 
	mSYSTEM_IO_CAPABLE
,

59 
	#INTEL_MSR_RANGE
 (0xffff)

	)

60 
	#CPUID_6_ECX_APERFMPERF_CAPABILITY
 (0x1)

	)

62 
	saıi_ıuäeq_d©a
 {

63 
aıi_´oûssÜ_³rfÜmªû
 *
	maıi_d©a
;

64 
ıuäeq_äequ’cy_bË
 *
	mäeq_bË
;

65 
	mmax_äeq
;

66 
	m»sume
;

67 
	mıu_ã©u»
;

70 
aıi_ıuäeq_d©a
 *
	gdrv_d©a
[
NR_CPUS
];

72 
aıi_´oûssÜ_³rfÜmªû
 *
	gaıi_³rf_d©a
;

74 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
;

76 
	gaıi_p¡©e_¡riù
;

78 
	$check_e¡_ıu
(
ıuid
)

80 
ıušfo_x86
 *
ıu
 = &
	`ıu_d©a
(
ıuid
);

82 ià(
ıu
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 ||

83 !
	`ıu_has
(
ıu
, 
X86_FEATURE_EST
))

87 
	}
}

89 
	$exŒaù_io
(
u32
 
v®ue
, 
aıi_ıuäeq_d©a
 *
d©a
)

91 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

92 
i
;

94 
³rf
 = 
d©a
->
aıi_d©a
;

96 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

97 ià(
v®ue
 =ğ
³rf
->
¡©es
[
i
].
¡©us
)

98  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

101 
	}
}

103 
	$exŒaù_m¤
(
u32
 
m¤
, 
aıi_ıuäeq_d©a
 *
d©a
)

105 
i
;

106 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

108 
m¤
 &ğ
INTEL_MSR_RANGE
;

109 
³rf
 = 
d©a
->
aıi_d©a
;

111 
i
=0; 
d©a
->
äeq_bË
[i].
äequ’cy
 !ğ
CPUFREQ_TABLE_END
; i++) {

112 ià(
m¤
 =ğ
³rf
->
¡©es
[
d©a
->
äeq_bË
[
i
].
šdex
].
¡©us
)

113  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

115  
d©a
->
äeq_bË
[0].
äequ’cy
;

116 
	}
}

118 
	$exŒaù_äeq
(
u32
 
v®
, 
aıi_ıuäeq_d©a
 *
d©a
)

120 
d©a
->
ıu_ã©u»
) {

121 
SYSTEM_INTEL_MSR_CAPABLE
:

122  
	`exŒaù_m¤
(
v®
, 
d©a
);

123 
SYSTEM_IO_CAPABLE
:

124  
	`exŒaù_io
(
v®
, 
d©a
);

128 
	}
}

130 
	sm¤_addr
 {

131 
u32
 
	m»g
;

134 
	sio_addr
 {

135 
u16
 
	mpÜt
;

136 
u8
 
	mb™_width
;

140 
m¤_addr
 
	mm¤
;

141 
io_addr
 
	mio
;

142 } 
	tdrv_addr_uniÚ
;

144 
	sdrv_cmd
 {

145 
	mty³
;

146 
ıumask_t
 
	mmask
;

147 
drv_addr_uniÚ
 
	maddr
;

148 
u32
 
	mv®
;

151 
	$do_drv_»ad
(
drv_cmd
 *
cmd
)

153 
u32
 
h
;

155 
cmd
->
ty³
) {

156 
SYSTEM_INTEL_MSR_CAPABLE
:

157 
	`rdm¤
(
cmd
->
addr
.
m¤
.
»g
, cmd->
v®
, 
h
);

159 
SYSTEM_IO_CAPABLE
:

160 
	`aıi_os_»ad_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

161 &
cmd
->
v®
,

162 (
u32
)
cmd
->
addr
.
io
.
b™_width
);

167 
	}
}

169 
	$do_drv_wr™e
(
drv_cmd
 *
cmd
)

171 
u32
 
lo
, 
hi
;

173 
cmd
->
ty³
) {

174 
SYSTEM_INTEL_MSR_CAPABLE
:

175 
	`rdm¤
(
cmd
->
addr
.
m¤
.
»g
, 
lo
, 
hi
);

176 
lo
 = (lØ& ~
INTEL_MSR_RANGE
è| (
cmd
->
v®
 & INTEL_MSR_RANGE);

177 
	`wrm¤
(
cmd
->
addr
.
m¤
.
»g
, 
lo
, 
hi
);

179 
SYSTEM_IO_CAPABLE
:

180 
	`aıi_os_wr™e_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

181 
cmd
->
v®
,

182 (
u32
)
cmd
->
addr
.
io
.
b™_width
);

187 
	}
}

189 
	$drv_»ad
(
drv_cmd
 *
cmd
)

191 
ıumask_t
 
§ved_mask
 = 
cu¼’t
->
ıus_®lowed
;

192 
cmd
->
v®
 = 0;

194 
	`£t_ıus_®lowed
(
cu¼’t
, 
cmd
->
mask
);

195 
	`do_drv_»ad
(
cmd
);

196 
	`£t_ıus_®lowed
(
cu¼’t
, 
§ved_mask
);

197 
	}
}

199 
	$drv_wr™e
(
drv_cmd
 *
cmd
)

201 
ıumask_t
 
§ved_mask
 = 
cu¼’t
->
ıus_®lowed
;

202 
i
;

204 
	`fÜ_—ch_ıu_mask
(
i
, 
cmd
->
mask
) {

205 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
i
));

206 
	`do_drv_wr™e
(
cmd
);

209 
	`£t_ıus_®lowed
(
cu¼’t
, 
§ved_mask
);

211 
	}
}

213 
u32
 
	$g‘_cur_v®
(
ıumask_t
 
mask
)

215 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

216 
drv_cmd
 
cmd
;

218 ià(
	`uÆik–y
(
	`ıus_em±y
(
mask
)))

221 
drv_d©a
[
	`fœ¡_ıu
(
mask
)]->
ıu_ã©u»
) {

222 
SYSTEM_INTEL_MSR_CAPABLE
:

223 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

224 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_STATUS
;

226 
SYSTEM_IO_CAPABLE
:

227 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

228 
³rf
 = 
drv_d©a
[
	`fœ¡_ıu
(
mask
)]->
aıi_d©a
;

229 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

230 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

236 
cmd
.
mask
 = mask;

238 
	`drv_»ad
(&
cmd
);

240 
	`d´štk
("g‘_cur_v® = %u\n", 
cmd
.
v®
);

242  
cmd
.
v®
;

243 
	}
}

258 
	$g‘_m—su»d_³rf
(
ıu
)

262 
u32
 
lo
;

263 
u32
 
hi
;

264 } 
¥l™
;

265 
u64
 
whŞe
;

266 } 
­”f_cur
, 
m³rf_cur
;

268 
ıumask_t
 
§ved_mask
;

269 
³rf_³rûÁ
;

270 
»tv®
;

272 
§ved_mask
 = 
cu¼’t
->
ıus_®lowed
;

273 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
ıu
));

274 ià(
	`g‘_ıu
(è!ğ
ıu
) {

276 
	`put_ıu
();

280 
	`rdm¤
(
MSR_IA32_APERF
, 
­”f_cur
.
¥l™
.
lo
,‡³rf_cur.¥l™.
hi
);

281 
	`rdm¤
(
MSR_IA32_MPERF
, 
m³rf_cur
.
¥l™
.
lo
, m³rf_cur.¥l™.
hi
);

283 
	`wrm¤
(
MSR_IA32_APERF
, 0,0);

284 
	`wrm¤
(
MSR_IA32_MPERF
, 0,0);

286 #ifdeà
__i386__


292 ià(
	`uÆik–y
(
­”f_cur
.
¥l™
.
hi
 || 
m³rf_cur
.split.hi)) {

293 
shiá_couÁ
;

294 
u32
 
h
;

296 
h
 = 
	`max_t
(
u32
, 
­”f_cur
.
¥l™
.
hi
, 
m³rf_cur
.split.hi);

297 
shiá_couÁ
 = 
	`æs
(
h
);

299 
­”f_cur
.
whŞe
 >>ğ
shiá_couÁ
;

300 
m³rf_cur
.
whŞe
 >>ğ
shiá_couÁ
;

303 ià((()(-1è/ 100è< 
­”f_cur
.
¥l™
.
lo
) {

304 
shiá_couÁ
 = 7;

305 
­”f_cur
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

306 
m³rf_cur
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

309 ià(
­”f_cur
.
¥l™
.
lo
 && 
m³rf_cur
.split.lo)

310 
³rf_³rûÁ
 = (
­”f_cur
.
¥l™
.
lo
 * 100è/ 
m³rf_cur
.split.lo;

312 
³rf_³rûÁ
 = 0;

315 ià(
	`uÆik–y
((()(-1è/ 100è< 
­”f_cur
.
whŞe
)) {

316 
shiá_couÁ
 = 7;

317 
­”f_cur
.
whŞe
 >>ğ
shiá_couÁ
;

318 
m³rf_cur
.
whŞe
 >>ğ
shiá_couÁ
;

321 ià(
­”f_cur
.
whŞe
 && 
m³rf_cur
.whole)

322 
³rf_³rûÁ
 = (
­”f_cur
.
whŞe
 * 100è/ 
m³rf_cur
.whole;

324 
³rf_³rûÁ
 = 0;

328 
»tv®
 = 
drv_d©a
[
ıu
]->
max_äeq
 * 
³rf_³rûÁ
 / 100;

330 
	`put_ıu
();

331 
	`£t_ıus_®lowed
(
cu¼’t
, 
§ved_mask
);

333 
	`d´štk
("ıu %d:…”fÜmªû…”ûÁ %d\n", 
ıu
, 
³rf_³rûÁ
);

334  
»tv®
;

335 
	}
}

337 
	$g‘_cur_äeq_Ú_ıu
(
ıu
)

339 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
ıu
];

340 
äeq
;

342 
	`d´štk
("g‘_cur_äeq_Ú_ıu (%d)\n", 
ıu
);

344 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

345 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

349 
äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
	`ıumask_of_ıu
(
ıu
)), 
d©a
);

350 
	`d´štk
("cu¸äeq = %u\n", 
äeq
);

352  
äeq
;

353 
	}
}

355 
	$check_äeqs
(
ıumask_t
 
mask
, 
äeq
,

356 
aıi_ıuäeq_d©a
 *
d©a
)

358 
cur_äeq
;

359 
i
;

361 
i
=0; i<100; i++) {

362 
cur_äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
mask
), 
d©a
);

363 ià(
cur_äeq
 =ğ
äeq
)

365 
	`ud–ay
(10);

368 
	}
}

370 
	$aıi_ıuäeq_rg‘
(
ıuäeq_pŞicy
 *
pŞicy
,

371 
rg‘_äeq
, 
»ÏtiÚ
)

373 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

374 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

375 
ıuäeq_äeqs
 
äeqs
;

376 
ıumask_t
 
Úlše_pŞicy_ıus
;

377 
drv_cmd
 
cmd
;

378 
Ãxt_¡©e
 = 0;

379 
Ãxt_³rf_¡©e
 = 0;

380 
i
;

381 
»suÉ
 = 0;

383 
	`d´štk
("aıi_ıuäeq_rg‘ %d (%d)\n", 
rg‘_äeq
, 
pŞicy
->
ıu
);

385 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

386 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

387  -
ENODEV
;

390 
³rf
 = 
d©a
->
aıi_d©a
;

391 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_rg‘
(
pŞicy
,

392 
d©a
->
äeq_bË
,

393 
rg‘_äeq
,

394 
»ÏtiÚ
, &
Ãxt_¡©e
);

395 ià(
	`uÆik–y
(
»suÉ
))

396  -
ENODEV
;

398 #ifdeà
CONFIG_HOTPLUG_CPU


400 
	`ıus_ªd
(
Úlše_pŞicy_ıus
, 
ıu_Úlše_m­
, 
pŞicy
->
ıus
);

402 
Úlše_pŞicy_ıus
 = 
pŞicy
->
ıus
;

405 
Ãxt_³rf_¡©e
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
šdex
;

406 ià(
³rf
->
¡©e
 =ğ
Ãxt_³rf_¡©e
) {

407 ià(
	`uÆik–y
(
d©a
->
»sume
)) {

408 
	`d´štk
("Called‡fter„esume,„esettingo P%d\n",

409 
Ãxt_³rf_¡©e
);

410 
d©a
->
»sume
 = 0;

412 
	`d´štk
("Already‡target state (P%d)\n",

413 
Ãxt_³rf_¡©e
);

418 
d©a
->
ıu_ã©u»
) {

419 
SYSTEM_INTEL_MSR_CAPABLE
:

420 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

421 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_CTL
;

422 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

424 
SYSTEM_IO_CAPABLE
:

425 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

426 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

427 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

428 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

431  -
ENODEV
;

434 
	`ıus_ş—r
(
cmd
.
mask
);

436 ià(
pŞicy
->
sh¬ed_ty³
 !ğ
CPUFREQ_SHARED_TYPE_ANY
)

437 
cmd
.
mask
 = 
Úlše_pŞicy_ıus
;

439 
	`ıu_£t
(
pŞicy
->
ıu
, 
cmd
.
mask
);

441 
äeqs
.
Şd
 = 
³rf
->
¡©es
[³rf->
¡©e
].
cÜe_äequ’cy
 * 1000;

442 
äeqs
.
Ãw
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
äequ’cy
;

443 
	`fÜ_—ch_ıu_mask
(
i
, 
cmd
.
mask
) {

444 
äeqs
.
ıu
 = 
i
;

445 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_PRECHANGE
);

448 
	`drv_wr™e
(&
cmd
);

450 ià(
aıi_p¡©e_¡riù
) {

451 ià(!
	`check_äeqs
(
cmd
.
mask
, 
äeqs
.
Ãw
, 
d©a
)) {

452 
	`d´štk
("acpi_cpufreq_target failed (%d)\n",

453 
pŞicy
->
ıu
);

454  -
EAGAIN
;

458 
	`fÜ_—ch_ıu_mask
(
i
, 
cmd
.
mask
) {

459 
äeqs
.
ıu
 = 
i
;

460 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_POSTCHANGE
);

462 
³rf
->
¡©e
 = 
Ãxt_³rf_¡©e
;

464  
»suÉ
;

465 
	}
}

467 
	$aıi_ıuäeq_v”ify
(
ıuäeq_pŞicy
 *
pŞicy
)

469 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

471 
	`d´štk
("acpi_cpufreq_verify\n");

473  
	`ıuäeq_äequ’cy_bË_v”ify
(
pŞicy
, 
d©a
->
äeq_bË
);

474 
	}
}

477 
	$aıi_ıuäeq_guess_äeq
(
aıi_ıuäeq_d©a
 *
d©a
, 
ıu
)

479 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
 = 
d©a
->
aıi_d©a
;

481 ià(
ıu_khz
) {

483 
i
;

484 
äeq
;

485 
äeqn
 = 
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

487 
i
=0; i<(
³rf
->
¡©e_couÁ
-1); i++) {

488 
äeq
 = 
äeqn
;

489 
äeqn
 = 
³rf
->
¡©es
[
i
+1].
cÜe_äequ’cy
 * 1000;

490 ià((2 * 
ıu_khz
è> (
äeqn
 + 
äeq
)) {

491 
³rf
->
¡©e
 = 
i
;

492  
äeq
;

495 
³rf
->
¡©e
 =…”f->
¡©e_couÁ
-1;

496  
äeqn
;

499 
³rf
->
¡©e
 = 0;

500  
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

502 
	}
}

512 
__š™
 
	$aıi_ıuäeq_—¾y_š™
()

514 
	`d´štk
("acpi_cpufreq_early_init\n");

516 
aıi_³rf_d©a
 = 
	`®loc_³rıu
(
aıi_´oûssÜ_³rfÜmªû
);

517 ià(!
aıi_³rf_d©a
) {

518 
	`d´štk
("Memory‡llocationƒrror for‡cpi_perf_data.\n");

519  -
ENOMEM
;

523 
	`aıi_´oûssÜ_´”egi¡”_³rfÜmªû
(
aıi_³rf_d©a
);

525 
	}
}

527 #ifdeà
CONFIG_SMP


534 
	gbios_w™h_sw_ªy_bug
;

536 
	$sw_ªy_bug_found
(cÚ¡ 
dmi_sy¡em_id
 *
d
)

538 
bios_w™h_sw_ªy_bug
 = 1;

540 
	}
}

542 cÚ¡ 
dmi_sy¡em_id
 
	gsw_ªy_bug_dmi_bË
[] = {

544 .
ÿÎback
 = 
sw_ªy_bug_found
,

545 .
	gid’t
 = "Supermicro Server X6DLP",

546 .
	gm©ches
 = {

547 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

548 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

549 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

556 
	$aıi_ıuäeq_ıu_š™
(
ıuäeq_pŞicy
 *
pŞicy
)

558 
i
;

559 
v®id_¡©es
 = 0;

560 
ıu
 = 
pŞicy
->cpu;

561 
aıi_ıuäeq_d©a
 *
d©a
;

562 
»suÉ
 = 0;

563 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
pŞicy
->
ıu
);

564 
aıi_´oûssÜ_³rfÜmªû
 *
³rf
;

566 
	`d´štk
("acpi_cpufreq_cpu_init\n");

568 
d©a
 = 
	`kz®loc
((
aıi_ıuäeq_d©a
), 
GFP_KERNEL
);

569 ià(!
d©a
)

570  -
ENOMEM
;

572 
d©a
->
aıi_d©a
 = 
	`³rıu_±r
(
aıi_³rf_d©a
, 
ıu
);

573 
drv_d©a
[
ıu
] = 
d©a
;

575 ià(
	`ıu_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

576 
aıi_ıuäeq_driv”
.
æags
 |ğ
CPUFREQ_CONST_LOOPS
;

578 
»suÉ
 = 
	`aıi_´oûssÜ_»gi¡”_³rfÜmªû
(
d©a
->
aıi_d©a
, 
ıu
);

579 ià(
»suÉ
)

580 
”r_ä“
;

582 
³rf
 = 
d©a
->
aıi_d©a
;

583 
pŞicy
->
sh¬ed_ty³
 = 
³rf
->shared_type;

589 ià(
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ALL
 ||

590 
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ANY
) {

591 
pŞicy
->
ıus
 = 
³rf
->
sh¬ed_ıu_m­
;

594 #ifdeà
CONFIG_SMP


595 
	`dmi_check_sy¡em
(
sw_ªy_bug_dmi_bË
);

596 ià(
bios_w™h_sw_ªy_bug
 && 
	`ıus_weight
(
pŞicy
->
ıus
) == 1) {

597 
pŞicy
->
sh¬ed_ty³
 = 
CPUFREQ_SHARED_TYPE_ALL
;

598 
pŞicy
->
ıus
 = 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
);

603 ià(
³rf
->
¡©e_couÁ
 <= 1) {

604 
	`d´štk
("No P-States\n");

605 
»suÉ
 = -
ENODEV
;

606 
”r_uÄeg
;

609 ià(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
 !ğ³rf->
¡©us_»gi¡”
.space_id) {

610 
»suÉ
 = -
ENODEV
;

611 
”r_uÄeg
;

614 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

615 
ACPI_ADR_SPACE_SYSTEM_IO
:

616 
	`d´štk
("SYSTEM IO‡ddr space\n");

617 
d©a
->
ıu_ã©u»
 = 
SYSTEM_IO_CAPABLE
;

619 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

620 
	`d´štk
("HARDWARE‡ddr space\n");

621 ià(!
	`check_e¡_ıu
(
ıu
)) {

622 
»suÉ
 = -
ENODEV
;

623 
”r_uÄeg
;

625 
d©a
->
ıu_ã©u»
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

628 
	`d´štk
("Unknown‡ddr space %d\n",

629 (
u32
è(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
));

630 
»suÉ
 = -
ENODEV
;

631 
”r_uÄeg
;

634 
d©a
->
äeq_bË
 = 
	`km®loc
((
ıuäeq_äequ’cy_bË
) *

635 (
³rf
->
¡©e_couÁ
+1), 
GFP_KERNEL
);

636 ià(!
d©a
->
äeq_bË
) {

637 
»suÉ
 = -
ENOMEM
;

638 
”r_uÄeg
;

642 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = 0;

643 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

644 ià((
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000) >

645 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
)

646 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 =

647 
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000;

650 
d©a
->
max_äeq
 = 
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

652 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

653 ià(
i
>0 && 
³rf
->
¡©es
[i].
cÜe_äequ’cy
 >=

654 
d©a
->
äeq_bË
[
v®id_¡©es
-1].
äequ’cy
 / 1000)

657 
d©a
->
äeq_bË
[
v®id_¡©es
].
šdex
 = 
i
;

658 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 =

659 
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
 * 1000;

660 
v®id_¡©es
++;

662 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

663 
³rf
->
¡©e
 = 0;

665 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_ıušfo
(
pŞicy
, 
d©a
->
äeq_bË
);

666 ià(
»suÉ
)

667 
”r_äeqä“
;

669 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

670 
ACPI_ADR_SPACE_SYSTEM_IO
:

672 
pŞicy
->
cur
 = 
	`aıi_ıuäeq_guess_äeq
(
d©a
,…Şicy->
ıu
);

674 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

675 
aıi_ıuäeq_driv”
.
g‘
 = 
g‘_cur_äeq_Ú_ıu
;

676 
pŞicy
->
cur
 = 
	`g‘_cur_äeq_Ú_ıu
(
ıu
);

683 
	`aıi_´oûssÜ_nÙify_smm
(
THIS_MODULE
);

686 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 && c->
ıuid_Ëv–
 >= 6) {

687 
ecx
;

688 
ecx
 = 
	`ıuid_ecx
(6);

689 ià(
ecx
 & 
CPUID_6_ECX_APERFMPERF_CAPABILITY
)

690 
aıi_ıuäeq_driv”
.
g‘avg
 = 
g‘_m—su»d_³rf
;

693 
	`d´štk
("CPU%u - ACPI…”fÜmªû mªagem’ˆaùiv©ed.\n", 
ıu
);

694 
i
 = 0; i < 
³rf
->
¡©e_couÁ
; i++)

695 
	`d´štk
(" %cP%d: %d MHz, %d mW, %d uS\n",

696 (
i
 =ğ
³rf
->
¡©e
 ? '*' : ' '), i,

697 (
u32
è
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
,

698 (
u32
è
³rf
->
¡©es
[
i
].
pow”
,

699 (
u32
è
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
);

701 
	`ıuäeq_äequ’cy_bË_g‘_©Œ
(
d©a
->
äeq_bË
, 
pŞicy
->
ıu
);

707 
d©a
->
»sume
 = 1;

709  
»suÉ
;

711 
”r_äeqä“
:

712 
	`kä“
(
d©a
->
äeq_bË
);

713 
”r_uÄeg
:

714 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(
³rf
, 
ıu
);

715 
”r_ä“
:

716 
	`kä“
(
d©a
);

717 
drv_d©a
[
ıu
] = 
NULL
;

719  
»suÉ
;

720 
	}
}

722 
	$aıi_ıuäeq_ıu_ex™
(
ıuäeq_pŞicy
 *
pŞicy
)

724 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

726 
	`d´štk
("acpi_cpufreq_cpu_exit\n");

728 ià(
d©a
) {

729 
	`ıuäeq_äequ’cy_bË_put_©Œ
(
pŞicy
->
ıu
);

730 
drv_d©a
[
pŞicy
->
ıu
] = 
NULL
;

731 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(
d©a
->
aıi_d©a
,

732 
pŞicy
->
ıu
);

733 
	`kä“
(
d©a
);

737 
	}
}

739 
	$aıi_ıuäeq_»sume
(
ıuäeq_pŞicy
 *
pŞicy
)

741 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

743 
	`d´štk
("acpi_cpufreq_resume\n");

745 
d©a
->
»sume
 = 1;

748 
	}
}

750 
äeq_©Œ
 *
	gaıi_ıuäeq_©Œ
[] = {

751 &
ıuäeq_äeq_©Œ_sÿlšg_avaabË_äeqs
,

752 
NULL
,

755 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
 = {

756 .
v”ify
 = 
aıi_ıuäeq_v”ify
,

757 .
	grg‘
 = 
aıi_ıuäeq_rg‘
,

758 .
	gš™
 = 
aıi_ıuäeq_ıu_š™
,

759 .
	gex™
 = 
aıi_ıuäeq_ıu_ex™
,

760 .
	g»sume
 = 
aıi_ıuäeq_»sume
,

761 .
	gÇme
 = "acpi-cpufreq",

762 .
	gowÃr
 = 
THIS_MODULE
,

763 .
	g©Œ
 = 
aıi_ıuäeq_©Œ
,

766 
__š™
 
	$aıi_ıuäeq_š™
()

768 
»t
;

770 
	`d´štk
("acpi_cpufreq_init\n");

772 
»t
 = 
	`aıi_ıuäeq_—¾y_š™
();

773 ià(
»t
)

774  
»t
;

776  
	`ıuäeq_»gi¡”_driv”
(&
aıi_ıuäeq_driv”
);

777 
	}
}

779 
__ex™
 
	$aıi_ıuäeq_ex™
()

781 
	`d´štk
("acpi_cpufreq_exit\n");

783 
	`ıuäeq_uÄegi¡”_driv”
(&
aıi_ıuäeq_driv”
);

785 
	`ä“_³rıu
(
aıi_³rf_d©a
);

788 
	}
}

790 
moduË_·¿m
(
aıi_p¡©e_¡riù
, 
ušt
, 0644);

791 
MODULE_PARM_DESC
(
aıi_p¡©e_¡riù
,

795 
Ï‹_š™ÿÎ
(
aıi_ıuäeq_š™
);

796 
moduË_ex™
(
aıi_ıuäeq_ex™
);

798 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/powernow-k8.c

27 
	~<lšux/k”Ãl.h
>

28 
	~<lšux/smp.h
>

29 
	~<lšux/moduË.h
>

30 
	~<lšux/š™.h
>

31 
	~<lšux/ıuäeq.h
>

32 
	~<lšux/¦ab.h
>

33 
	~<lšux/¡ršg.h
>

34 
	~<lšux/ıumask.h
>

35 
	~<lšux/sched.h
>

37 
	~<asm/m¤.h
>

38 
	~<asm/io.h
>

39 
	~<asm/d–ay.h
>

41 #ifdeà
CONFIG_X86_POWERNOW_K8_ACPI


42 
	~<lšux/aıi.h
>

43 
	~<lšux/mu‹x.h
>

44 
	~<aıi/´oûssÜ.h
>

47 
	#PFX
 "pow”now-k8: "

	)

48 
	#BFX
 
PFX
 "BIOSƒ¼Ü: "

	)

49 
	#VERSION
 "v”siÚ 2.20.00"

	)

50 
	~"pow”now-k8.h
"

53 
DEFINE_MUTEX
(
fidvid_mu‹x
);

55 
pow”now_k8_d©a
 *
	gpow”now_d©a
[
NR_CPUS
];

57 
	gıu_çmy
 = 
CPU_OPTERON
;

59 #iâdeà
CONFIG_SMP


60 
DEFINE_PER_CPU
(
ıumask_t
, 
ıu_cÜe_m­
);

64 
u32
 
	$fšd_äeq_äom_fid
(
u32
 
fid
)

66  800 + (
fid
 * 100);

67 
	}
}

71 
u32
 
	$fšd_khz_äeq_äom_fid
(
u32
 
fid
)

73  1000 * 
	`fšd_äeq_äom_fid
(
fid
);

74 
	}
}

76 
u32
 
	$fšd_khz_äeq_äom_p¡©e
(
ıuäeq_äequ’cy_bË
 *
d©a
, 
u32
 
p¡©e
)

78  
d©a
[
p¡©e
].
äequ’cy
;

79 
	}
}

88 
u32
 
	$cÚv”t_fid_to_vco_fid
(
u32
 
fid
)

90 ià(
fid
 < 
HI_FID_TABLE_BOTTOM
)

91  8 + (2 * 
fid
);

93  
fid
;

94 
	}
}

100 
	$³ndšg_b™_¡uck
()

102 
u32
 
lo
, 
hi
;

104 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

107 
	`rdm¤
(
MSR_FIDVID_STATUS
, 
lo
, 
hi
);

108  
lo
 & 
MSR_S_LO_CHANGE_PENDING
 ? 1 : 0;

109 
	}
}

115 
	$qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
pow”now_k8_d©a
 *
d©a
)

117 
u32
 
lo
, 
hi
;

118 
u32
 
i
 = 0;

120 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
) {

121 
	`rdm¤
(
MSR_PSTATE_STATUS
, 
lo
, 
hi
);

122 
i
 = 
lo
 & 
HW_PSTATE_MASK
;

123 
d©a
->
cu¼p¡©e
 = 
i
;

127 ià(
i
++ > 10000) {

128 
	`d´štk
("detected change…ending stuck\n");

131 
	`rdm¤
(
MSR_FIDVID_STATUS
, 
lo
, 
hi
);

132 } 
lo
 & 
MSR_S_LO_CHANGE_PENDING
);

134 
d©a
->
cu¼vid
 = 
hi
 & 
MSR_S_HI_CURRENT_VID
;

135 
d©a
->
cu¼fid
 = 
lo
 & 
MSR_S_LO_CURRENT_FID
;

138 
	}
}

141 
	$couÁ_off_œt
(
pow”now_k8_d©a
 *
d©a
)

143 
	`ud–ay
((1 << 
d©a
->
œt
) * 10);

145 
	}
}

148 
	$couÁ_off_v¡
(
pow”now_k8_d©a
 *
d©a
)

150 
	`ud–ay
(
d©a
->
v¡abË
 * 
VST_UNITS_20US
);

152 
	}
}

155 
	$fidvid_m¤_š™
()

157 
u32
 
lo
, 
hi
;

158 
u8
 
fid
, 
vid
;

160 
	`rdm¤
(
MSR_FIDVID_STATUS
, 
lo
, 
hi
);

161 
vid
 = 
hi
 & 
MSR_S_HI_CURRENT_VID
;

162 
fid
 = 
lo
 & 
MSR_S_LO_CURRENT_FID
;

163 
lo
 = 
fid
 | (
vid
 << 
MSR_C_LO_VID_SHIFT
);

164 
hi
 = 
MSR_C_HI_STP_GNT_BENIGN
;

165 
	`d´štk
("ıu%d, in™†Ø0x%x, h˜0x%x\n", 
	`smp_´oûssÜ_id
(), 
lo
, 
hi
);

166 
	`wrm¤
(
MSR_FIDVID_CTL
, 
lo
, 
hi
);

167 
	}
}

171 
	$wr™e_Ãw_fid
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
fid
)

173 
u32
 
lo
;

174 
u32
 
§vevid
 = 
d©a
->
cu¼vid
;

175 
u32
 
i
 = 0;

177 ià((
fid
 & 
INVALID_FID_MASK
è|| (
d©a
->
cu¼vid
 & 
INVALID_VID_MASK
)) {

178 
	`´štk
(
KERN_ERR
 
PFX
 "internalƒrror - overflow on fid write\n");

182 
lo
 = 
fid
 | (
d©a
->
cu¼vid
 << 
MSR_C_LO_VID_SHIFT
è| 
MSR_C_LO_INIT_FID_VID
;

184 
	`d´štk
("writing fid 0x%x,†o 0x%x, hi 0x%x\n",

185 
fid
, 
lo
, 
d©a
->
¶Îock
 * 
PLL_LOCK_CONVERSION
);

188 
	`wrm¤
(
MSR_FIDVID_CTL
, 
lo
, 
d©a
->
¶Îock
 * 
PLL_LOCK_CONVERSION
);

189 ià(
i
++ > 100) {

190 
	`´štk
(
KERN_ERR
 
PFX
 "Hardwareƒrror -…ending bit very stuck -‚o further…state changes…ossible\n");

193 } 
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
));

195 
	`couÁ_off_œt
(
d©a
);

197 ià(
§vevid
 !ğ
d©a
->
cu¼vid
) {

198 
	`´štk
(
KERN_ERR
 
PFX
 "vid change on fidrans, old 0x%x,‚ew 0x%x\n",

199 
§vevid
, 
d©a
->
cu¼vid
);

203 ià(
fid
 !ğ
d©a
->
cu¼fid
) {

204 
	`´štk
(
KERN_ERR
 
PFX
 "fid¿n çed, fid 0x%x, cu¼ 0x%x\n", 
fid
,

205 
d©a
->
cu¼fid
);

210 
	}
}

213 
	$wr™e_Ãw_vid
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
vid
)

215 
u32
 
lo
;

216 
u32
 
§vefid
 = 
d©a
->
cu¼fid
;

217 
i
 = 0;

219 ià((
d©a
->
cu¼fid
 & 
INVALID_FID_MASK
è|| (
vid
 & 
INVALID_VID_MASK
)) {

220 
	`´štk
(
KERN_ERR
 
PFX
 "internalƒrror - overflow on vid write\n");

224 
lo
 = 
d©a
->
cu¼fid
 | (
vid
 << 
MSR_C_LO_VID_SHIFT
è| 
MSR_C_LO_INIT_FID_VID
;

226 
	`d´štk
("writing vid 0x%x,†o 0x%x, hi 0x%x\n",

227 
vid
, 
lo
, 
STOP_GRANT_5NS
);

230 
	`wrm¤
(
MSR_FIDVID_CTL
, 
lo
, 
STOP_GRANT_5NS
);

231 ià(
i
++ > 100) {

232 
	`´štk
(
KERN_ERR
 
PFX
 "internalƒrror -…ending bit very stuck -‚o further…state changes…ossible\n");

235 } 
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
));

237 ià(
§vefid
 !ğ
d©a
->
cu¼fid
) {

238 
	`´štk
(
KERN_ERR
 
PFX
 "fid changed on vidrans, old 0x%x‚ew 0x%x\n",

239 
§vefid
, 
d©a
->
cu¼fid
);

243 ià(
vid
 !ğ
d©a
->
cu¼vid
) {

244 
	`´štk
(
KERN_ERR
 
PFX
 "vid¿n çed, vid 0x%x, cu¼ 0x%x\n", 
vid
,

245 
d©a
->
cu¼vid
);

250 
	}
}

257 
	$deü—£_vid_code_by_¡•
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
»qvid
, u32 
¡•
)

259 ià((
d©a
->
cu¼vid
 - 
»qvid
è> 
¡•
)

260 
»qvid
 = 
d©a
->
cu¼vid
 - 
¡•
;

262 ià(
	`wr™e_Ãw_vid
(
d©a
, 
»qvid
))

265 
	`couÁ_off_v¡
(
d©a
);

268 
	}
}

271 
	$Œªs™iÚ_p¡©e
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
p¡©e
)

273 
	`wrm¤
(
MSR_PSTATE_CTRL
, 
p¡©e
, 0);

274 
d©a
->
cu¼p¡©e
 = 
p¡©e
;

276 
	}
}

279 
	$Œªs™iÚ_fid_vid
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
»qfid
, u32 
»qvid
)

281 ià(
	`cÜe_vŞge_´e_Œªs™iÚ
(
d©a
, 
»qvid
))

284 ià(
	`cÜe_äequ’cy_Œªs™iÚ
(
d©a
, 
»qfid
))

287 ià(
	`cÜe_vŞge_po¡_Œªs™iÚ
(
d©a
, 
»qvid
))

290 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

293 ià((
»qfid
 !ğ
d©a
->
cu¼fid
è|| (
»qvid
 !ğd©a->
cu¼vid
)) {

294 
	`´štk
(
KERN_ERR
 
PFX
 "failed (cpu%d):„eq 0x%x 0x%x, curr 0x%x 0x%x\n",

295 
	`smp_´oûssÜ_id
(),

296 
»qfid
, 
»qvid
, 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

300 
	`d´štk
("transitioned (cpu%d):‚ew fid 0x%x, vid 0x%x\n",

301 
	`smp_´oûssÜ_id
(), 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

304 
	}
}

307 
	$cÜe_vŞge_´e_Œªs™iÚ
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
»qvid
)

309 
u32
 
rvo¡•s
 = 
d©a
->
rvo
;

310 
u32
 
§vefid
 = 
d©a
->
cu¼fid
;

311 
u32
 
maxvid
, 
lo
;

313 
	`d´štk
("ph1 (cpu%d): start, currfid 0x%x, currvid 0x%x,„eqvid 0x%x,„vo 0x%x\n",

314 
	`smp_´oûssÜ_id
(),

315 
d©a
->
cu¼fid
, d©a->
cu¼vid
, 
»qvid
, d©a->
rvo
);

317 
	`rdm¤
(
MSR_FIDVID_STATUS
, 
lo
, 
maxvid
);

318 
maxvid
 = 0x1f & (maxvid >> 16);

319 
	`d´štk
("ph1 maxvid=0x%x\n", 
maxvid
);

320 ià(
»qvid
 < 
maxvid
)

321 
»qvid
 = 
maxvid
;

323 
d©a
->
cu¼vid
 > 
»qvid
) {

324 
	`d´štk
("ph1: curr 0x%x,„eq vid 0x%x\n",

325 
d©a
->
cu¼vid
, 
»qvid
);

326 ià(
	`deü—£_vid_code_by_¡•
(
d©a
, 
»qvid
, d©a->
vidmvs
))

330 (
rvo¡•s
 > 0è&& ((
d©a
->
rvo
 + d©a->
cu¼vid
è> 
»qvid
)) {

331 ià(
d©a
->
cu¼vid
 =ğ
maxvid
) {

332 
rvo¡•s
 = 0;

334 
	`d´štk
("ph1: changing vid for„vo,„eq 0x%x\n",

335 
d©a
->
cu¼vid
 - 1);

336 ià(
	`deü—£_vid_code_by_¡•
(
d©a
, d©a->
cu¼vid
 - 1, 1))

338 
rvo¡•s
--;

342 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

345 ià(
§vefid
 !ğ
d©a
->
cu¼fid
) {

346 
	`´štk
(
KERN_ERR
 
PFX
 "ph1ƒ¼, cu¼fid chªged 0x%x\n", 
d©a
->
cu¼fid
);

350 
	`d´štk
("ph1 complete, currfid 0x%x, currvid 0x%x\n",

351 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

354 
	}
}

357 
	$cÜe_äequ’cy_Œªs™iÚ
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
»qfid
)

359 
u32
 
vcÜeqfid
, 
vcocu¼fid
, 
vcofiddiff
, 
fid_š‹rv®
, 
§vevid
 = 
d©a
->
cu¼vid
;

361 ià((
»qfid
 < 
HI_FID_TABLE_BOTTOM
è&& (
d©a
->
cu¼fid
 < HI_FID_TABLE_BOTTOM)) {

362 
	`´štk
(
KERN_ERR
 
PFX
 "ph2: illegal†o-loransition 0x%x 0x%x\n",

363 
»qfid
, 
d©a
->
cu¼fid
);

367 ià(
d©a
->
cu¼fid
 =ğ
»qfid
) {

368 
	`´štk
(
KERN_ERR
 
PFX
 "ph2‚uÎ fid¿ns™iÚ 0x%x\n", 
d©a
->
cu¼fid
);

372 
	`d´štk
("ph2 (cpu%d): starting, currfid 0x%x, currvid 0x%x,„eqfid 0x%x\n",

373 
	`smp_´oûssÜ_id
(),

374 
d©a
->
cu¼fid
, d©a->
cu¼vid
, 
»qfid
);

376 
vcÜeqfid
 = 
	`cÚv”t_fid_to_vco_fid
(
»qfid
);

377 
vcocu¼fid
 = 
	`cÚv”t_fid_to_vco_fid
(
d©a
->
cu¼fid
);

378 
vcofiddiff
 = 
vcocu¼fid
 > 
vcÜeqfid
 ? vcocurrfid - vcoreqfid

379 : 
vcÜeqfid
 - 
vcocu¼fid
;

381 
vcofiddiff
 > 2) {

382 (
d©a
->
cu¼fid
 & 1è? (
fid_š‹rv®
 = 1) : (fid_interval = 2);

384 ià(
»qfid
 > 
d©a
->
cu¼fid
) {

385 ià(
d©a
->
cu¼fid
 > 
LO_FID_TABLE_TOP
) {

386 ià(
	`wr™e_Ãw_fid
(
d©a
, d©a->
cu¼fid
 + 
fid_š‹rv®
)) {

390 ià(
wr™e_Ãw_fid


391 (
d©a
, 2 + 
	`cÚv”t_fid_to_vco_fid
(d©a->
cu¼fid
))) {

396 ià(
	`wr™e_Ãw_fid
(
d©a
, d©a->
cu¼fid
 - 
fid_š‹rv®
))

400 
vcocu¼fid
 = 
	`cÚv”t_fid_to_vco_fid
(
d©a
->
cu¼fid
);

401 
vcofiddiff
 = 
vcocu¼fid
 > 
vcÜeqfid
 ? vcocurrfid - vcoreqfid

402 : 
vcÜeqfid
 - 
vcocu¼fid
;

405 ià(
	`wr™e_Ãw_fid
(
d©a
, 
»qfid
))

408 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

411 ià(
d©a
->
cu¼fid
 !ğ
»qfid
) {

412 
	`´štk
(
KERN_ERR
 
PFX


414 
d©a
->
cu¼fid
, 
»qfid
);

418 ià(
§vevid
 !ğ
d©a
->
cu¼vid
) {

419 
	`´štk
(
KERN_ERR
 
PFX
 "ph2: vid changed, save 0x%x, curr 0x%x\n",

420 
§vevid
, 
d©a
->
cu¼vid
);

424 
	`d´štk
("ph2 complete, currfid 0x%x, currvid 0x%x\n",

425 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

428 
	}
}

431 
	$cÜe_vŞge_po¡_Œªs™iÚ
(
pow”now_k8_d©a
 *
d©a
, 
u32
 
»qvid
)

433 
u32
 
§vefid
 = 
d©a
->
cu¼fid
;

434 
u32
 
§v”eqvid
 = 
»qvid
;

436 
	`d´štk
("ph3 (cpu%d): starting, currfid 0x%x, currvid 0x%x\n",

437 
	`smp_´oûssÜ_id
(),

438 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

440 ià(
»qvid
 !ğ
d©a
->
cu¼vid
) {

441 ià(
	`wr™e_Ãw_vid
(
d©a
, 
»qvid
))

444 ià(
§vefid
 !ğ
d©a
->
cu¼fid
) {

445 
	`´štk
(
KERN_ERR
 
PFX


447 
§vefid
, 
d©a
->
cu¼fid
);

451 ià(
d©a
->
cu¼vid
 !ğ
»qvid
) {

452 
	`´štk
(
KERN_ERR
 
PFX


454 
»qvid
, 
d©a
->
cu¼vid
);

459 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

462 ià(
§v”eqvid
 !ğ
d©a
->
cu¼vid
) {

463 
	`d´štk
("ph3 faed, cu¼vid 0x%x\n", 
d©a
->
cu¼vid
);

467 ià(
§vefid
 !ğ
d©a
->
cu¼fid
) {

468 
	`d´štk
("ph3 failed, currfid changed 0x%x\n",

469 
d©a
->
cu¼fid
);

473 
	`d´štk
("ph3 complete, currfid 0x%x, currvid 0x%x\n",

474 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

477 
	}
}

479 
	$check_suµÜ‹d_ıu
(
ıu
)

481 
ıumask_t
 
Şdmask
 = 
CPU_MASK_ALL
;

482 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

483 
rc
 = 0;

485 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

486 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
ıu
));

488 ià(
	`smp_´oûssÜ_id
(è!ğ
ıu
) {

489 
	`´štk
(
KERN_ERR
 
PFX
 "lim™šgØıu %u faed\n", 
ıu
);

490 
out
;

493 ià(
cu¼’t_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

494 
out
;

496 
—x
 = 
	`ıuid_—x
(
CPUID_PROCESSOR_SIGNATURE
);

497 ià(((
—x
 & 
CPUID_XFAM
è!ğ
CPUID_XFAM_K8
) &&

498 ((
—x
 & 
CPUID_XFAM
è< 
CPUID_XFAM_10H
))

499 
out
;

501 ià((
—x
 & 
CPUID_XFAM
è=ğ
CPUID_XFAM_K8
) {

502 ià(((
—x
 & 
CPUID_USE_XFAM_XMOD
) != CPUID_USE_XFAM_XMOD) ||

503 ((
—x
 & 
CPUID_XMOD
è> 
CPUID_XMOD_REV_MASK
)) {

504 
	`´štk
(
KERN_INFO
 
PFX
 "ProûssÜ cpuid %x‚Ù suµÜ‹d\n", 
—x
);

505 
out
;

508 
—x
 = 
	`ıuid_—x
(
CPUID_GET_MAX_CAPABILITIES
);

509 ià(
—x
 < 
CPUID_FREQ_VOLT_CAPABILITIES
) {

510 
	`´štk
(
KERN_INFO
 
PFX


512 
out
;

515 
	`ıuid
(
CPUID_FREQ_VOLT_CAPABILITIES
, &
—x
, &
ebx
, &
ecx
, &
edx
);

516 ià((
edx
 & 
P_STATE_TRANSITION_CAPABLE
) != P_STATE_TRANSITION_CAPABLE) {

517 
	`´štk
(
KERN_INFO
 
PFX
 "Power stateransitions‚ot supported\n");

518 
out
;

521 
	`ıuid
(
CPUID_FREQ_VOLT_CAPABILITIES
, &
—x
, &
ebx
, &
ecx
, &
edx
);

522 ià((
edx
 & 
USE_HW_PSTATE
) == USE_HW_PSTATE)

523 
ıu_çmy
 = 
CPU_HW_PSTATE
;

525 
out
;

528 
rc
 = 1;

530 
out
:

531 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

532  
rc
;

533 
	}
}

535 
	$check_p¡_bË
(
pow”now_k8_d©a
 *
d©a
, 
p¡_s
 *
p¡
, 
u8
 
maxvid
)

537 
j
;

538 
u8
 
Ï¡fid
 = 0xff;

540 
j
 = 0; j < 
d©a
->
numps
; j++) {

541 ià(
p¡
[
j
].
vid
 > 
LEAST_VID
) {

542 
	`´štk
(
KERN_ERR
 
PFX
 "vid %d inv®id : 0x%x\n", 
j
, 
p¡
[j].
vid
);

543  -
EINVAL
;

545 ià(
p¡
[
j
].
vid
 < 
d©a
->
rvo
) {

546 
	`´štk
(
KERN_ERR
 
BFX
 "0 vidƒxûeded w™h…¡©%d\n", 
j
);

547  -
ENODEV
;

549 ià(
p¡
[
j
].
vid
 < 
maxvid
 + 
d©a
->
rvo
) {

550 
	`´štk
(
KERN_ERR
 
BFX
 "maxvidƒxûeded w™h…¡©%d\n", 
j
);

551  -
ENODEV
;

553 ià(
p¡
[
j
].
fid
 > 
MAX_FID
) {

554 
	`´štk
(
KERN_ERR
 
BFX
 "maxfidƒxûeded w™h…¡©%d\n", 
j
);

555  -
ENODEV
;

557 ià(
j
 && (
p¡
[j].
fid
 < 
HI_FID_TABLE_BOTTOM
)) {

559 
	`´štk
(
KERN_ERR
 
BFX
 "twØlow fid - %d : 0x%x\n", 
j
, 
p¡
[j].
fid
);

560  -
EINVAL
;

562 ià(
p¡
[
j
].
fid
 < 
Ï¡fid
)

563 
Ï¡fid
 = 
p¡
[
j
].
fid
;

565 ià(
Ï¡fid
 & 1) {

566 
	`´štk
(
KERN_ERR
 
BFX
 "lastfid invalid\n");

567  -
EINVAL
;

569 ià(
Ï¡fid
 > 
LO_FID_TABLE_TOP
)

570 
	`´štk
(
KERN_INFO
 
BFX
 "first fid‚ot from†o freqable\n");

573 
	}
}

575 
	$´št_basics
(
pow”now_k8_d©a
 *
d©a
)

577 
j
;

578 
j
 = 0; j < 
d©a
->
numps
; j++) {

579 ià(
d©a
->
pow”now_bË
[
j
].
äequ’cy
 !ğ
CPUFREQ_ENTRY_INVALID
) {

580 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
) {

581 
	`´štk
(
KERN_INFO
 
PFX
 " %d : fid 0x%x did 0x%x (%d MHz)\n",

582 
j
,

583 (
d©a
->
pow”now_bË
[
j
].
šdex
 & 0xff00) >> 8,

584 (
d©a
->
pow”now_bË
[
j
].
šdex
 & 0xff0000) >> 16,

585 
d©a
->
pow”now_bË
[
j
].
äequ’cy
/1000);

587 
	`´štk
(
KERN_INFO
 
PFX
 " %d : fid 0x%x (%d MHz), vid 0x%x\n",

588 
j
,

589 
d©a
->
pow”now_bË
[
j
].
šdex
 & 0xff,

590 
d©a
->
pow”now_bË
[
j
].
äequ’cy
/1000,

591 
d©a
->
pow”now_bË
[
j
].
šdex
 >> 8);

595 ià(
d©a
->
b©ps
)

596 
	`´štk
(
KERN_INFO
 
PFX
 "OÆy %d…¡©e Ú b©‹ry\n", 
d©a
->
b©ps
);

597 
	}
}

599 
	$fl_pow”now_bË
(
pow”now_k8_d©a
 *
d©a
, 
p¡_s
 *
p¡
, 
u8
 
maxvid
)

601 
ıuäeq_äequ’cy_bË
 *
pow”now_bË
;

602 
j
;

604 ià(
d©a
->
b©ps
) {

605 
	`´štk
(
KERN_WARNING
 
PFX
 "OÆy %d…¡©e u§bË (u£ ACPI driv” fÜ fuÎ„ªge\n", 
d©a
->
b©ps
);

606 
d©a
->
numps
 = d©a->
b©ps
;

609  
j
=1; j<
d©a
->
numps
; j++ ) {

610 ià(
p¡
[
j
-1].
fid
 >=…st[j].fid) {

611 
	`´štk
(
KERN_ERR
 
PFX
 "PST out of sequence\n");

612  -
EINVAL
;

616 ià(
d©a
->
numps
 < 2) {

617 
	`´štk
(
KERN_ERR
 
PFX
 "no… statesoransition\n");

618  -
ENODEV
;

621 ià(
	`check_p¡_bË
(
d©a
, 
p¡
, 
maxvid
))

622  -
EINVAL
;

624 
pow”now_bË
 = 
	`km®loc
(((
ıuäeq_äequ’cy_bË
)

625 * (
d©a
->
numps
 + 1)), 
GFP_KERNEL
);

626 ià(!
pow”now_bË
) {

627 
	`´štk
(
KERN_ERR
 
PFX
 "powernow_table memory‡lloc failure\n");

628  -
ENOMEM
;

631 
j
 = 0; j < 
d©a
->
numps
; j++) {

632 
pow”now_bË
[
j
].
šdex
 = 
p¡
[j].
fid
;

633 
pow”now_bË
[
j
].
šdex
 |ğ(
p¡
[j].
vid
 << 8);

634 
pow”now_bË
[
j
].
äequ’cy
 = 
	`fšd_khz_äeq_äom_fid
(
p¡
[j].
fid
);

636 
pow”now_bË
[
d©a
->
numps
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

637 
pow”now_bË
[
d©a
->
numps
].
šdex
 = 0;

639 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
)) {

640 
	`kä“
(
pow”now_bË
);

641  -
EIO
;

644 
	`d´štk
("cfid 0x%x, cvid 0x%x\n", 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

645 
d©a
->
pow”now_bË
 =…owernow_table;

646 ià(
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_cÜe_m­
, 
d©a
->
ıu
)) == data->cpu)

647 
	`´št_basics
(
d©a
);

649 
j
 = 0; j < 
d©a
->
numps
; j++)

650 ià((
p¡
[
j
].
fid
==
d©a
->
cu¼fid
è&& (p¡[j].
vid
==d©a->
cu¼vid
))

653 
	`d´štk
("currfid/vid do‚ot match PST, ignoring\n");

655 
	}
}

658 
	$fšd_psb_bË
(
pow”now_k8_d©a
 *
d©a
)

660 
psb_s
 *
psb
;

661 
i
;

662 
u32
 
mvs
;

663 
u8
 
maxvid
;

664 
u32
 
ı¡
 = 0;

665 
u32
 
thisıuid
;

667 
i
 = 0xc0000; i < 0xffff0; i += 0x10) {

671 
psb
 = 
	`phys_to_vœt
(
i
);

672 ià(
	`memcmp
(
psb
, 
PSB_ID_STRING
, 
PSB_ID_STRING_LEN
) != 0)

675 
	`d´štk
("found PSB h—d”‡ˆ0x%p\n", 
psb
);

677 
	`d´štk
("bË v”s: 0x%x\n", 
psb
->
bËv”siÚ
);

678 ià(
psb
->
bËv”siÚ
 !ğ
PSB_VERSION_1_4
) {

679 
	`´štk
(
KERN_ERR
 
BFX
 "PSBable is‚ot v1.4\n");

680  -
ENODEV
;

683 
	`d´štk
("æags: 0x%x\n", 
psb
->
æags1
);

684 ià(
psb
->
æags1
) {

685 
	`´štk
(
KERN_ERR
 
BFX
 "unknown flags\n");

686  -
ENODEV
;

689 
d©a
->
v¡abË
 = 
psb
->vstable;

690 
	`d´štk
("vŞg¡abiz©iÚime: %d(*20us)\n", 
d©a
->
v¡abË
);

692 
	`d´štk
("æags2: 0x%x\n", 
psb
->
æags2
);

693 
d©a
->
rvo
 = 
psb
->
æags2
 & 3;

694 
d©a
->
œt
 = ((
psb
->
æags2
) >> 2) & 3;

695 
mvs
 = ((
psb
->
æags2
) >> 4) & 3;

696 
d©a
->
vidmvs
 = 1 << 
mvs
;

697 
d©a
->
b©ps
 = ((
psb
->
æags2
) >> 6) & 3;

699 
	`d´štk
("¿m°vŞgoff£t: %d\n", 
d©a
->
rvo
);

700 
	`d´štk
("isochrÚou »l›àtime: %d\n", 
d©a
->
œt
);

701 
	`d´štk
("maximum vŞg¡•: %d - 0x%x\n", 
mvs
, 
d©a
->
vidmvs
);

703 
	`d´štk
("nump¡: 0x%x\n", 
psb
->
num_bËs
);

704 
ı¡
 = 
psb
->
num_bËs
;

705 ià((
psb
->
ıuid
 == 0x00000fc0) || (psb->cpuid == 0x00000fe0) ){

706 
thisıuid
 = 
	`ıuid_—x
(
CPUID_PROCESSOR_SIGNATURE
);

707 ià((
thisıuid
 == 0x00000fc0) || (thiscpuid == 0x00000fe0) ) {

708 
ı¡
 = 1;

711 ià(
ı¡
 != 1) {

712 
	`´štk
(
KERN_ERR
 
BFX
 "numpst must be 1\n");

713  -
ENODEV
;

716 
d©a
->
¶Îock
 = 
psb
->
¶Îocktime
;

717 
	`d´štk
("¶Îocktime: 0x%x (un™ 1us)\n", 
psb
->
¶Îocktime
);

718 
	`d´štk
("maxfid: 0x%x\n", 
psb
->
maxfid
);

719 
	`d´štk
("maxvid: 0x%x\n", 
psb
->
maxvid
);

720 
maxvid
 = 
psb
->maxvid;

722 
d©a
->
numps
 = 
psb
->numps;

723 
	`d´štk
("nump¡©es: 0x%x\n", 
d©a
->
numps
);

724  
	`fl_pow”now_bË
(
d©a
, (
p¡_s
 *)(
psb
+1), 
maxvid
);

737 
	`´štk
(
KERN_ERR
 
PFX
 "BIOSƒrror -‚o PSB or ACPI _PSS objects\n");

738  -
ENODEV
;

739 
	}
}

741 #ifdeà
CONFIG_X86_POWERNOW_K8_ACPI


742 
	$pow”now_k8_aıi_p¡_v®ues
(
pow”now_k8_d©a
 *
d©a
, 
šdex
)

744 ià(!
d©a
->
aıi_d©a
.
¡©e_couÁ
 || (
ıu_çmy
 =ğ
CPU_HW_PSTATE
))

747 
d©a
->
œt
 = (d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
IRT_SHIFT
è& 
IRT_MASK
;

748 
d©a
->
rvo
 = (d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
RVO_SHIFT
è& 
RVO_MASK
;

749 
d©a
->
ex‰y³
 = (d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
EXT_TYPE_SHIFT
è& 
EXT_TYPE_MASK
;

750 
d©a
->
¶Îock
 = (d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
PLL_L_SHIFT
è& 
PLL_L_MASK
;

751 
d©a
->
vidmvs
 = 1 << ((d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
MVS_SHIFT
è& 
MVS_MASK
);

752 
d©a
->
v¡abË
 = (d©a->
aıi_d©a
.
¡©es
[
šdex
].
cÚŒŞ
 >> 
VST_SHIFT
è& 
VST_MASK
;

753 
	}
}

755 
	$pow”now_k8_ıu_š™_aıi
(
pow”now_k8_d©a
 *
d©a
)

757 
ıuäeq_äequ’cy_bË
 *
pow”now_bË
;

758 
»t_v®
;

760 ià(
	`aıi_´oûssÜ_»gi¡”_³rfÜmªû
(&
d©a
->
aıi_d©a
, d©a->
ıu
)) {

761 
	`d´štk
("register…erformance failed: bad ACPI data\n");

762  -
EIO
;

766 ià(
d©a
->
aıi_d©a
.
¡©e_couÁ
 <= 1) {

767 
	`d´štk
("No ACPI P-States\n");

768 
”r_out
;

771 ià((
d©a
->
aıi_d©a
.
cÚŒŞ_»gi¡”
.
¥aû_id
 !ğ
ACPI_ADR_SPACE_FIXED_HARDWARE
) ||

772 (
d©a
->
aıi_d©a
.
¡©us_»gi¡”
.
¥aû_id
 !ğ
ACPI_ADR_SPACE_FIXED_HARDWARE
)) {

773 
	`d´štk
("Invalid control/status„egisters (%x - %x)\n",

774 
d©a
->
aıi_d©a
.
cÚŒŞ_»gi¡”
.
¥aû_id
,

775 
d©a
->
aıi_d©a
.
¡©us_»gi¡”
.
¥aû_id
);

776 
”r_out
;

780 
pow”now_bË
 = 
	`km®loc
(((
ıuäeq_äequ’cy_bË
)

781 * (
d©a
->
aıi_d©a
.
¡©e_couÁ
 + 1)), 
GFP_KERNEL
);

782 ià(!
pow”now_bË
) {

783 
	`d´štk
("powernow_table memory‡lloc failure\n");

784 
”r_out
;

787 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

788 
»t_v®
 = 
	`fl_pow”now_bË_p¡©e
(
d©a
, 
pow”now_bË
);

790 
»t_v®
 = 
	`fl_pow”now_bË_fidvid
(
d©a
, 
pow”now_bË
);

791 ià(
»t_v®
)

792 
”r_out_mem
;

794 
pow”now_bË
[
d©a
->
aıi_d©a
.
¡©e_couÁ
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

795 
pow”now_bË
[
d©a
->
aıi_d©a
.
¡©e_couÁ
].
šdex
 = 0;

796 
d©a
->
pow”now_bË
 =…owernow_table;

799 
d©a
->
numps
 = d©a->
aıi_d©a
.
¡©e_couÁ
;

800 ià(
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_cÜe_m­
, 
d©a
->
ıu
)) == data->cpu)

801 
	`´št_basics
(
d©a
);

802 
	`pow”now_k8_aıi_p¡_v®ues
(
d©a
, 0);

805 
	`aıi_´oûssÜ_nÙify_smm
(
THIS_MODULE
);

809 
”r_out_mem
:

810 
	`kä“
(
pow”now_bË
);

812 
”r_out
:

813 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(&
d©a
->
aıi_d©a
, d©a->
ıu
);

816 
d©a
->
aıi_d©a
.
¡©e_couÁ
 = 0;

818  -
ENODEV
;

819 
	}
}

821 
	$fl_pow”now_bË_p¡©e
(
pow”now_k8_d©a
 *
d©a
, 
ıuäeq_äequ’cy_bË
 *
pow”now_bË
)

823 
i
;

824 
u32
 
hi
 = 0, 
lo
 = 0;

825 
	`rdm¤
(
MSR_PSTATE_CUR_LIMIT
, 
hi
, 
lo
);

826 
d©a
->
max_hw_p¡©e
 = (
hi
 & 
HW_PSTATE_MAX_MASK
è>> 
HW_PSTATE_MAX_SHIFT
;

828 
i
 = 0; i < 
d©a
->
aıi_d©a
.
¡©e_couÁ
; i++) {

829 
u32
 
šdex
;

830 
u32
 
hi
 = 0, 
lo
 = 0;

832 
šdex
 = 
d©a
->
aıi_d©a
.
¡©es
[
i
].
cÚŒŞ
 & 
HW_PSTATE_MASK
;

833 ià(
šdex
 > 
d©a
->
max_hw_p¡©e
) {

834 
	`´štk
(
KERN_ERR
 
PFX
 "šv®id…¡©%d - bad v®u%d.\n", 
i
, 
šdex
);

835 
	`´štk
(
KERN_ERR
 
PFX
 "Please„eporto BIOS manufacturer\n");

836 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

839 
	`rdm¤
(
MSR_PSTATE_DEF_BASE
 + 
šdex
, 
lo
, 
hi
);

840 ià(!(
hi
 & 
HW_PSTATE_VALID_MASK
)) {

841 
	`d´štk
("šv®id…¡©%d, ignÜšg\n", 
šdex
);

842 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

846 
pow”now_bË
[
i
].
šdex
 = index;

848 
pow”now_bË
[
i
].
äequ’cy
 = 
d©a
->
aıi_d©a
.
¡©es
[i].
cÜe_äequ’cy
 * 1000;

851 
	}
}

853 
	$fl_pow”now_bË_fidvid
(
pow”now_k8_d©a
 *
d©a
, 
ıuäeq_äequ’cy_bË
 *
pow”now_bË
)

855 
i
;

856 
úoäeq
 = 0;

857 
i
 = 0; i < 
d©a
->
aıi_d©a
.
¡©e_couÁ
; i++) {

858 
u32
 
fid
;

859 
u32
 
vid
;

861 ià(
d©a
->
ex‰y³
) {

862 
fid
 = 
d©a
->
aıi_d©a
.
¡©es
[
i
].
¡©us
 & 
EXT_FID_MASK
;

863 
vid
 = (
d©a
->
aıi_d©a
.
¡©es
[
i
].
¡©us
 >> 
VID_SHIFT
è& 
EXT_VID_MASK
;

865 
fid
 = 
d©a
->
aıi_d©a
.
¡©es
[
i
].
cÚŒŞ
 & 
FID_MASK
;

866 
vid
 = (
d©a
->
aıi_d©a
.
¡©es
[
i
].
cÚŒŞ
 >> 
VID_SHIFT
è& 
VID_MASK
;

869 
	`d´štk
(" %d : fid 0x%x, vid 0x%x\n", 
i
, 
fid
, 
vid
);

871 
pow”now_bË
[
i
].
šdex
 = 
fid
;

872 
pow”now_bË
[
i
].
šdex
 |ğ(
vid
 << 8);

873 
pow”now_bË
[
i
].
äequ’cy
 = 
	`fšd_khz_äeq_äom_fid
(
fid
);

876 ià((
pow”now_bË
[
i
].
äequ’cy
 > (
MAX_FREQ
 * 1000)) ||

877 (
pow”now_bË
[
i
].
äequ’cy
 < (
MIN_FREQ
 * 1000))) {

878 
	`d´štk
("šv®id f»q %u kHz, ignÜšg\n", 
pow”now_bË
[
i
].
äequ’cy
);

879 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

884 ià(
vid
 =ğ
VID_OFF
) {

885 
	`d´štk
("šv®id vid %u, ignÜšg\n", 
vid
);

886 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

891 ià(
fid
 < 
HI_FID_TABLE_BOTTOM
) {

892 ià(
úoäeq
) {

894 ià((
pow”now_bË
[
i
].
äequ’cy
 !ğpow”now_bË[
úoäeq
].frequency) ||

895 (
pow”now_bË
[
i
].
šdex
 !ğpow”now_bË[
úoäeq
].index)) {

896 
	`´štk
(
KERN_ERR
 
PFX
 "Too many†o freqableƒntries\n");

900 
	`d´štk
("double†ow frequencyableƒntry, ignoring it.\n");

901 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

904 
úoäeq
 = 
i
;

907 ià(
pow”now_bË
[
i
].
äequ’cy
 !ğ(
d©a
->
aıi_d©a
.
¡©es
[i].
cÜe_äequ’cy
 * 1000)) {

908 
	`´štk
(
KERN_INFO
 
PFX
 "invalid freqƒntries %u kHz vs. %u kHz\n",

909 
pow”now_bË
[
i
].
äequ’cy
,

910 (è(
d©a
->
aıi_d©a
.
¡©es
[
i
].
cÜe_äequ’cy
 * 1000));

911 
pow”now_bË
[
i
].
äequ’cy
 = 
CPUFREQ_ENTRY_INVALID
;

916 
	}
}

918 
	$pow”now_k8_ıu_ex™_aıi
(
pow”now_k8_d©a
 *
d©a
)

920 ià(
d©a
->
aıi_d©a
.
¡©e_couÁ
)

921 
	`aıi_´oûssÜ_uÄegi¡”_³rfÜmªû
(&
d©a
->
aıi_d©a
, d©a->
ıu
);

922 
	}
}

925 
	$pow”now_k8_ıu_š™_aıi
(
pow”now_k8_d©a
 *
d©a
è{  -
ENODEV
; 
	}
}

926 
	$pow”now_k8_ıu_ex™_aıi
(
pow”now_k8_d©a
 *
d©a
è{ ; 
	}
}

927 
	$pow”now_k8_aıi_p¡_v®ues
(
pow”now_k8_d©a
 *
d©a
, 
šdex
è{ ; 
	}
}

931 
	$Œªs™iÚ_äequ’cy_fidvid
(
pow”now_k8_d©a
 *
d©a
, 
šdex
)

933 
u32
 
fid
 = 0;

934 
u32
 
vid
 = 0;

935 
»s
, 
i
;

936 
ıuäeq_äeqs
 
äeqs
;

938 
	`d´štk
("ıu %d¿ns™iÚØšdex %u\n", 
	`smp_´oûssÜ_id
(), 
šdex
);

945 
fid
 = 
d©a
->
pow”now_bË
[
šdex
].index & 0xFF;

946 
vid
 = (
d©a
->
pow”now_bË
[
šdex
].index & 0xFF00) >> 8;

948 
	`d´štk
("bË m©ched fid 0x%x, givšg vid 0x%x\n", 
fid
, 
vid
);

950 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

953 ià((
d©a
->
cu¼vid
 =ğ
vid
è&& (d©a->
cu¼fid
 =ğ
fid
)) {

954 
	`d´štk
("target matches current values (fid 0x%x, vid 0x%x)\n",

955 
fid
, 
vid
);

959 ià((
fid
 < 
HI_FID_TABLE_BOTTOM
è&& (
d©a
->
cu¼fid
 < HI_FID_TABLE_BOTTOM)) {

960 
	`´štk
(
KERN_ERR
 
PFX


962 
d©a
->
cu¼fid
, 
fid
);

966 
	`d´štk
("cpu %d, changingo fid 0x%x, vid 0x%x\n",

967 
	`smp_´oûssÜ_id
(), 
fid
, 
vid
);

968 
äeqs
.
Şd
 = 
	`fšd_khz_äeq_äom_fid
(
d©a
->
cu¼fid
);

969 
äeqs
.
Ãw
 = 
	`fšd_khz_äeq_äom_fid
(
fid
);

971 
	`fÜ_—ch_ıu_mask
(
i
, *(
d©a
->
avaabË_cÜes
)) {

972 
äeqs
.
ıu
 = 
i
;

973 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_PRECHANGE
);

976 
»s
 = 
	`Œªs™iÚ_fid_vid
(
d©a
, 
fid
, 
vid
);

977 
äeqs
.
Ãw
 = 
	`fšd_khz_äeq_äom_fid
(
d©a
->
cu¼fid
);

979 
	`fÜ_—ch_ıu_mask
(
i
, *(
d©a
->
avaabË_cÜes
)) {

980 
äeqs
.
ıu
 = 
i
;

981 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_POSTCHANGE
);

983  
»s
;

984 
	}
}

987 
	$Œªs™iÚ_äequ’cy_p¡©e
(
pow”now_k8_d©a
 *
d©a
, 
šdex
)

989 
u32
 
p¡©e
 = 0;

990 
»s
, 
i
;

991 
ıuäeq_äeqs
 
äeqs
;

993 
	`d´štk
("ıu %d¿ns™iÚØšdex %u\n", 
	`smp_´oûssÜ_id
(), 
šdex
);

996 
p¡©e
 = 
šdex
 & 
HW_PSTATE_MASK
;

997 ià(
p¡©e
 > 
d©a
->
max_hw_p¡©e
)

999 
äeqs
.
Şd
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, d©a->
cu¼p¡©e
);

1000 
äeqs
.
Ãw
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, 
p¡©e
);

1002 
	`fÜ_—ch_ıu_mask
(
i
, *(
d©a
->
avaabË_cÜes
)) {

1003 
äeqs
.
ıu
 = 
i
;

1004 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_PRECHANGE
);

1007 
»s
 = 
	`Œªs™iÚ_p¡©e
(
d©a
, 
p¡©e
);

1008 
äeqs
.
Ãw
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, 
p¡©e
);

1010 
	`fÜ_—ch_ıu_mask
(
i
, *(
d©a
->
avaabË_cÜes
)) {

1011 
äeqs
.
ıu
 = 
i
;

1012 
	`ıuäeq_nÙify_Œªs™iÚ
(&
äeqs
, 
CPUFREQ_POSTCHANGE
);

1014  
»s
;

1015 
	}
}

1018 
	$pow”nowk8_rg‘
(
ıuäeq_pŞicy
 *
pŞ
, 
rgäeq
, 
»ÏtiÚ
)

1020 
ıumask_t
 
Şdmask
 = 
CPU_MASK_ALL
;

1021 
pow”now_k8_d©a
 *
d©a
 = 
pow”now_d©a
[
pŞ
->
ıu
];

1022 
u32
 
checkfid
;

1023 
u32
 
checkvid
;

1024 
Ãw¡©e
;

1025 
»t
 = -
EIO
;

1027 ià(!
d©a
)

1028  -
EINVAL
;

1030 
checkfid
 = 
d©a
->
cu¼fid
;

1031 
checkvid
 = 
d©a
->
cu¼vid
;

1034 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

1035 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
pŞ
->
ıu
));

1037 ià(
	`smp_´oûssÜ_id
(è!ğ
pŞ
->
ıu
) {

1038 
	`´štk
(
KERN_ERR
 
PFX
 "lim™šgØıu %u faed\n", 
pŞ
->
ıu
);

1039 
”r_out
;

1042 ià(
	`³ndšg_b™_¡uck
()) {

1043 
	`´štk
(
KERN_ERR
 
PFX
 "failingarg, change…ending bit set\n");

1044 
”r_out
;

1047 
	`d´štk
("targ: cpu %d, %d kHz, min %d, max %d,„elation %d\n",

1048 
pŞ
->
ıu
, 
rgäeq
,…Ş->
mš
,…Ş->
max
, 
»ÏtiÚ
);

1050 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

1051 
”r_out
;

1053 ià(
ıu_çmy
 !ğ
CPU_HW_PSTATE
) {

1054 
	`d´štk
("targ: curr fid 0x%x, vid 0x%x\n",

1055 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

1057 ià((
checkvid
 !ğ
d©a
->
cu¼vid
è|| (
checkfid
 !ğd©a->
cu¼fid
)) {

1058 
	`´štk
(
KERN_INFO
 
PFX


1060 
checkfid
, 
d©a
->
cu¼fid
, 
checkvid
, d©a->
cu¼vid
);

1064 ià(
	`ıuäeq_äequ’cy_bË_rg‘
(
pŞ
, 
d©a
->
pow”now_bË
, 
rgäeq
, 
»ÏtiÚ
, &
Ãw¡©e
))

1065 
”r_out
;

1067 
	`mu‹x_lock
(&
fidvid_mu‹x
);

1069 
	`pow”now_k8_aıi_p¡_v®ues
(
d©a
, 
Ãw¡©e
);

1071 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1072 
»t
 = 
	`Œªs™iÚ_äequ’cy_p¡©e
(
d©a
, 
Ãw¡©e
);

1074 
»t
 = 
	`Œªs™iÚ_äequ’cy_fidvid
(
d©a
, 
Ãw¡©e
);

1075 ià(
»t
) {

1076 
	`´štk
(
KERN_ERR
 
PFX
 "transition frequency failed\n");

1077 
»t
 = 1;

1078 
	`mu‹x_uÆock
(&
fidvid_mu‹x
);

1079 
”r_out
;

1081 
	`mu‹x_uÆock
(&
fidvid_mu‹x
);

1083 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1084 
pŞ
->
cur
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, 
Ãw¡©e
);

1086 
pŞ
->
cur
 = 
	`fšd_khz_äeq_äom_fid
(
d©a
->
cu¼fid
);

1087 
»t
 = 0;

1089 
”r_out
:

1090 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

1091  
»t
;

1092 
	}
}

1095 
	$pow”nowk8_v”ify
(
ıuäeq_pŞicy
 *
pŞ
)

1097 
pow”now_k8_d©a
 *
d©a
 = 
pow”now_d©a
[
pŞ
->
ıu
];

1099 ià(!
d©a
)

1100  -
EINVAL
;

1102  
	`ıuäeq_äequ’cy_bË_v”ify
(
pŞ
, 
d©a
->
pow”now_bË
);

1103 
	}
}

1106 
__ıuš™
 
	$pow”nowk8_ıu_š™
(
ıuäeq_pŞicy
 *
pŞ
)

1108 
pow”now_k8_d©a
 *
d©a
;

1109 
ıumask_t
 
Şdmask
 = 
CPU_MASK_ALL
;

1110 
rc
;

1112 ià(!
	`ıu_Úlše
(
pŞ
->
ıu
))

1113  -
ENODEV
;

1115 ià(!
	`check_suµÜ‹d_ıu
(
pŞ
->
ıu
))

1116  -
ENODEV
;

1118 
d©a
 = 
	`kz®loc
((
pow”now_k8_d©a
), 
GFP_KERNEL
);

1119 ià(!
d©a
) {

1120 
	`´štk
(
KERN_ERR
 
PFX
 "unableo‡lloc…owernow_k8_data");

1121  -
ENOMEM
;

1124 
d©a
->
ıu
 = 
pŞ
->cpu;

1126 ià(
	`pow”now_k8_ıu_š™_aıi
(
d©a
)) {

1131 ià(
	`num_Úlše_ıus
() != 1) {

1132 
	`´štk
(
KERN_ERR
 
PFX
 "MP systems‚ot supported by PSB BIOS structure\n");

1133 
	`kä“
(
d©a
);

1134  -
ENODEV
;

1136 ià(
pŞ
->
ıu
 != 0) {

1137 
	`´štk
(
KERN_ERR
 
PFX
 "No _PSS objects for CPU otherhan CPU0\n");

1138 
	`kä“
(
d©a
);

1139  -
ENODEV
;

1141 
rc
 = 
	`fšd_psb_bË
(
d©a
);

1142 ià(
rc
) {

1143 
	`kä“
(
d©a
);

1144  -
ENODEV
;

1149 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

1150 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
pŞ
->
ıu
));

1152 ià(
	`smp_´oûssÜ_id
(è!ğ
pŞ
->
ıu
) {

1153 
	`´štk
(
KERN_ERR
 
PFX
 "lim™šgØıu %u faed\n", 
pŞ
->
ıu
);

1154 
”r_out
;

1157 ià(
	`³ndšg_b™_¡uck
()) {

1158 
	`´štk
(
KERN_ERR
 
PFX
 "failing init, change…ending bit set\n");

1159 
”r_out
;

1162 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

1163 
”r_out
;

1165 ià(
ıu_çmy
 =ğ
CPU_OPTERON
)

1166 
	`fidvid_m¤_š™
();

1169 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

1171 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1172 
pŞ
->
ıus
 = 
	`ıumask_of_ıu
ÕŞ->
ıu
);

1174 
pŞ
->
ıus
 = 
	`³r_ıu
(
ıu_cÜe_m­
,…Ş->
ıu
);

1175 
d©a
->
avaabË_cÜes
 = &(
pŞ
->
ıus
);

1179 
pŞ
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = (((
d©a
->
rvo
 + 8è* d©a->
v¡abË
 * 
VST_UNITS_20US
)

1180 + (3 * (1 << 
d©a
->
œt
) * 10)) * 1000;

1182 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1183 
pŞ
->
cur
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, d©a->
cu¼p¡©e
);

1185 
pŞ
->
cur
 = 
	`fšd_khz_äeq_äom_fid
(
d©a
->
cu¼fid
);

1186 
	`d´štk
("pŞicy cu¼’ˆäequ’cy %d kHz\n", 
pŞ
->
cur
);

1189 ià(
	`ıuäeq_äequ’cy_bË_ıušfo
(
pŞ
, 
d©a
->
pow”now_bË
)) {

1190 
	`´štk
(
KERN_ERR
 
PFX
 "invalid…owernow_table\n");

1191 
	`pow”now_k8_ıu_ex™_aıi
(
d©a
);

1192 
	`kä“
(
d©a
->
pow”now_bË
);

1193 
	`kä“
(
d©a
);

1194  -
EINVAL
;

1197 
	`ıuäeq_äequ’cy_bË_g‘_©Œ
(
d©a
->
pow”now_bË
, 
pŞ
->
ıu
);

1199 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1200 
	`d´štk
("ıu_š™ dÚe, cu¼’ˆp¡©0x%x\n", 
d©a
->
cu¼p¡©e
);

1202 
	`d´štk
("cpu_init done, current fid 0x%x, vid 0x%x\n",

1203 
d©a
->
cu¼fid
, d©a->
cu¼vid
);

1205 
pow”now_d©a
[
pŞ
->
ıu
] = 
d©a
;

1209 
”r_out
:

1210 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

1211 
	`pow”now_k8_ıu_ex™_aıi
(
d©a
);

1213 
	`kä“
(
d©a
);

1214  -
ENODEV
;

1215 
	}
}

1217 
__devex™
 
	$pow”nowk8_ıu_ex™
 (
ıuäeq_pŞicy
 *
pŞ
)

1219 
pow”now_k8_d©a
 *
d©a
 = 
pow”now_d©a
[
pŞ
->
ıu
];

1221 ià(!
d©a
)

1222  -
EINVAL
;

1224 
	`pow”now_k8_ıu_ex™_aıi
(
d©a
);

1226 
	`ıuäeq_äequ’cy_bË_put_©Œ
(
pŞ
->
ıu
);

1228 
	`kä“
(
d©a
->
pow”now_bË
);

1229 
	`kä“
(
d©a
);

1232 
	}
}

1234 
	$pow”nowk8_g‘
 (
ıu
)

1236 
pow”now_k8_d©a
 *
d©a
;

1237 
ıumask_t
 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

1238 
khz
 = 0;

1240 
d©a
 = 
pow”now_d©a
[
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
))];

1242 ià(!
d©a
)

1243  -
EINVAL
;

1245 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
ıu
));

1246 ià(
	`smp_´oûssÜ_id
(è!ğ
ıu
) {

1247 
	`´štk
(
KERN_ERR
 
PFX
 "lim™šgØCPU %d faed iÀpow”nowk8_g‘\n", 
ıu
);

1248 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

1252 ià(
	`qu”y_cu¼’t_v®ues_w™h_³ndšg_wa™
(
d©a
))

1253 
out
;

1255 ià(
ıu_çmy
 =ğ
CPU_HW_PSTATE
)

1256 
khz
 = 
	`fšd_khz_äeq_äom_p¡©e
(
d©a
->
pow”now_bË
, d©a->
cu¼p¡©e
);

1258 
khz
 = 
	`fšd_khz_äeq_äom_fid
(
d©a
->
cu¼fid
);

1261 
out
:

1262 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

1263  
khz
;

1264 
	}
}

1266 
äeq_©Œ
* 
	gpow”now_k8_©Œ
[] = {

1267 &
ıuäeq_äeq_©Œ_sÿlšg_avaabË_äeqs
,

1268 
NULL
,

1271 
ıuäeq_driv”
 
	gıuäeq_amd64_driv”
 = {

1272 .
v”ify
 = 
pow”nowk8_v”ify
,

1273 .
	grg‘
 = 
pow”nowk8_rg‘
,

1274 .
	gš™
 = 
pow”nowk8_ıu_š™
,

1275 .
	gex™
 = 
__devex™_p
(
pow”nowk8_ıu_ex™
),

1276 .
	gg‘
 = 
pow”nowk8_g‘
,

1277 .
	gÇme
 = "powernow-k8",

1278 .
	gowÃr
 = 
THIS_MODULE
,

1279 .
	g©Œ
 = 
pow”now_k8_©Œ
,

1283 
__ıuš™
 
	$pow”nowk8_š™
()

1285 
i
, 
suµÜ‹d_ıus
 = 0;

1287 
	`fÜ_—ch_Úlše_ıu
(
i
) {

1288 ià(
	`check_suµÜ‹d_ıu
(
i
))

1289 
suµÜ‹d_ıus
++;

1292 ià(
suµÜ‹d_ıus
 =ğ
	`num_Úlše_ıus
()) {

1293 
	`´štk
(
KERN_INFO
 
PFX
 "Found %d %s "

1294 "´oûssÜ (%d cpu cÜesè(" 
VERSION
 ")\n",

1295 
	`num_Úlše_nodes
(),

1296 
boÙ_ıu_d©a
.
x86_mod–_id
, 
suµÜ‹d_ıus
);

1297  
	`ıuäeq_»gi¡”_driv”
(&
ıuäeq_amd64_driv”
);

1300  -
ENODEV
;

1301 
	}
}

1304 
__ex™
 
	$pow”nowk8_ex™
()

1306 
	`d´štk
("exit\n");

1308 
	`ıuäeq_uÄegi¡”_driv”
(&
ıuäeq_amd64_driv”
);

1309 
	}
}

1311 
MODULE_AUTHOR
("Paul Devriendt <paul.devriendt@amd.com>‡nd Mark Langsdorf <mark.langsdorf@amd.com>");

1312 
MODULE_DESCRIPTION
("AMD Athlon 64‡nd Opteron…rocessor frequency driver.");

1313 
MODULE_LICENSE
("GPL");

1315 
Ï‹_š™ÿÎ
(
pow”nowk8_š™
);

1316 
moduË_ex™
(
pow”nowk8_ex™
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<lšux/š™.h
>

11 
	~<lšux/¦ab.h
>

12 
	~<lšux/deviû.h
>

13 
	~<lšux/comp”.h
>

14 
	~<lšux/ıu.h
>

15 
	~<lšux/sched.h
>

17 
	~<asm/´oûssÜ.h
>

18 
	~<asm/smp.h
>

20 
	#LVL_1_INST
 1

	)

21 
	#LVL_1_DATA
 2

	)

22 
	#LVL_2
 3

	)

23 
	#LVL_3
 4

	)

24 
	#LVL_TRACE
 5

	)

26 
	s_ÿche_bË


28 
	mdesütÜ
;

29 
	mÿche_ty³
;

30 
	msize
;

34 
_ÿche_bË
 
	gÿche_bË
[] 
	g__ıuš™d©a
 =

36 { 0x06, 
LVL_1_INST
, 8 },

37 { 0x08, 
LVL_1_INST
, 16 },

38 { 0x0a, 
LVL_1_DATA
, 8 },

39 { 0x0c, 
LVL_1_DATA
, 16 },

40 { 0x22, 
LVL_3
, 512 },

41 { 0x23, 
LVL_3
, 1024 },

42 { 0x25, 
LVL_3
, 2048 },

43 { 0x29, 
LVL_3
, 4096 },

44 { 0x2c, 
LVL_1_DATA
, 32 },

45 { 0x30, 
LVL_1_INST
, 32 },

46 { 0x39, 
LVL_2
, 128 },

47 { 0x3a, 
LVL_2
, 192 },

48 { 0x3b, 
LVL_2
, 128 },

49 { 0x3c, 
LVL_2
, 256 },

50 { 0x3d, 
LVL_2
, 384 },

51 { 0x3e, 
LVL_2
, 512 },

52 { 0x3f, 
LVL_2
, 256 },

53 { 0x41, 
LVL_2
, 128 },

54 { 0x42, 
LVL_2
, 256 },

55 { 0x43, 
LVL_2
, 512 },

56 { 0x44, 
LVL_2
, 1024 },

57 { 0x45, 
LVL_2
, 2048 },

58 { 0x46, 
LVL_3
, 4096 },

59 { 0x47, 
LVL_3
, 8192 },

60 { 0x49, 
LVL_3
, 4096 },

61 { 0x4a, 
LVL_3
, 6144 },

62 { 0x4b, 
LVL_3
, 8192 },

63 { 0x4c, 
LVL_3
, 12288 },

64 { 0x4d, 
LVL_3
, 16384 },

65 { 0x60, 
LVL_1_DATA
, 16 },

66 { 0x66, 
LVL_1_DATA
, 8 },

67 { 0x67, 
LVL_1_DATA
, 16 },

68 { 0x68, 
LVL_1_DATA
, 32 },

69 { 0x70, 
LVL_TRACE
, 12 },

70 { 0x71, 
LVL_TRACE
, 16 },

71 { 0x72, 
LVL_TRACE
, 32 },

72 { 0x73, 
LVL_TRACE
, 64 },

73 { 0x78, 
LVL_2
, 1024 },

74 { 0x79, 
LVL_2
, 128 },

75 { 0x7a, 
LVL_2
, 256 },

76 { 0x7b, 
LVL_2
, 512 },

77 { 0x7c, 
LVL_2
, 1024 },

78 { 0x7d, 
LVL_2
, 2048 },

79 { 0x7f, 
LVL_2
, 512 },

80 { 0x82, 
LVL_2
, 256 },

81 { 0x83, 
LVL_2
, 512 },

82 { 0x84, 
LVL_2
, 1024 },

83 { 0x85, 
LVL_2
, 2048 },

84 { 0x86, 
LVL_2
, 512 },

85 { 0x87, 
LVL_2
, 1024 },

90 
	e_ÿche_ty³


92 
	mCACHE_TYPE_NULL
 = 0,

93 
	mCACHE_TYPE_DATA
 = 1,

94 
	mCACHE_TYPE_INST
 = 2,

95 
	mCACHE_TYPE_UNIFIED
 = 3

98 
	u_ıuid4_Ëaf_—x
 {

100 
_ÿche_ty³
 
	mty³
:5;

101 
	mËv–
:3;

102 
	mis_£lf_š™Ÿlizšg
:1;

103 
	mis_fuÎy_assocŸtive
:1;

104 
	m»£rved
:4;

105 
	mnum_th»ads_sh¬šg
:12;

106 
	mnum_cÜes_Ú_d›
:6;

107 } 
	m¥l™
;

108 
u32
 
	mfuÎ
;

111 
	u_ıuid4_Ëaf_ebx
 {

113 
	mcoh”’cy_lše_size
:12;

114 
	mphysiÿl_lše_·¹™iÚ
:10;

115 
	mways_of_assocŸtiv™y
:10;

116 } 
	m¥l™
;

117 
u32
 
	mfuÎ
;

120 
	u_ıuid4_Ëaf_ecx
 {

122 
	mnumb”_of_£ts
:32;

123 } 
	m¥l™
;

124 
u32
 
	mfuÎ
;

127 
	s_ıuid4_šfo
 {

128 
_ıuid4_Ëaf_—x
 
	m—x
;

129 
_ıuid4_Ëaf_ebx
 
	mebx
;

130 
_ıuid4_Ëaf_ecx
 
	mecx
;

131 
	msize
;

132 
ıumask_t
 
	msh¬ed_ıu_m­
;

135 
	gnum_ÿche_Ëaves
;

143 
	ul1_ÿche
 {

145 
	mlše_size
 : 8;

146 
	mlšes_³r_g
 : 8;

147 
	massoc
 : 8;

148 
	msize_š_kb
 : 8;

150 
	mv®
;

153 
	ul2_ÿche
 {

155 
	mlše_size
 : 8;

156 
	mlšes_³r_g
 : 4;

157 
	massoc
 : 4;

158 
	msize_š_kb
 : 16;

160 
	mv®
;

163 
	ul3_ÿche
 {

165 
	mlše_size
 : 8;

166 
	mlšes_³r_g
 : 4;

167 
	massoc
 : 4;

168 
	m»s
 : 2;

169 
	msize_’coded
 : 14;

171 
	mv®
;

174 
	gassocs
[] 
	g__ıuš™d©a
 = {

181 
	gËv–s
[] 
	g__ıuš™d©a
 = { 1, 1, 2, 3 };

182 
	gty³s
[] 
	g__ıuš™d©a
 = { 1, 2, 3, 3 };

184 
__ıuš™
 
	$amd_ıuid4
(
Ëaf
, 
_ıuid4_Ëaf_—x
 *
—x
,

185 
_ıuid4_Ëaf_ebx
 *
ebx
,

186 
_ıuid4_Ëaf_ecx
 *
ecx
)

188 
dummy
;

189 
lše_size
, 
lšes_³r_g
, 
assoc
, 
size_š_kb
;

190 
l1_ÿche
 
l1i
, 
l1d
;

191 
l2_ÿche
 
l2
;

192 
l3_ÿche
 
l3
;

193 
l1_ÿche
 *
l1
 = &
l1d
;

195 
—x
->
fuÎ
 = 0;

196 
ebx
->
fuÎ
 = 0;

197 
ecx
->
fuÎ
 = 0;

199 
	`ıuid
(0x80000005, &
dummy
, &dummy, &
l1d
.
v®
, &
l1i
.val);

200 
	`ıuid
(0x80000006, &
dummy
, &dummy, &
l2
.
v®
, &
l3
.val);

202 
Ëaf
) {

204 
l1
 = &
l1i
;

206 ià(!
l1
->
v®
)

208 
assoc
 = 
l1
->assoc;

209 
lše_size
 = 
l1
->line_size;

210 
lšes_³r_g
 = 
l1
->lines_per_tag;

211 
size_š_kb
 = 
l1
->size_in_kb;

214 ià(!
l2
.
v®
)

216 
assoc
 = 
l2
.assoc;

217 
lše_size
 = 
l2
.line_size;

218 
lšes_³r_g
 = 
l2
.lines_per_tag;

220 
size_š_kb
 = 
cu¼’t_ıu_d©a
.
x86_ÿche_size
;

223 ià(!
l3
.
v®
)

225 
assoc
 = 
l3
.assoc;

226 
lše_size
 = 
l3
.line_size;

227 
lšes_³r_g
 = 
l3
.lines_per_tag;

228 
size_š_kb
 = 
l3
.
size_’coded
 * 512;

234 
—x
->
¥l™
.
is_£lf_š™Ÿlizšg
 = 1;

235 
—x
->
¥l™
.
ty³
 = 
ty³s
[
Ëaf
];

236 
—x
->
¥l™
.
Ëv–
 = 
Ëv–s
[
Ëaf
];

237 ià(
Ëaf
 == 3)

238 
—x
->
¥l™
.
num_th»ads_sh¬šg
 = 
cu¼’t_ıu_d©a
.
x86_max_cÜes
 - 1;

240 
—x
->
¥l™
.
num_th»ads_sh¬šg
 = 0;

241 
—x
->
¥l™
.
num_cÜes_Ú_d›
 = 
cu¼’t_ıu_d©a
.
x86_max_cÜes
 - 1;

244 ià(
assoc
 == 0xf)

245 
—x
->
¥l™
.
is_fuÎy_assocŸtive
 = 1;

246 
ebx
->
¥l™
.
coh”’cy_lše_size
 = 
lše_size
 - 1;

247 
ebx
->
¥l™
.
ways_of_assocŸtiv™y
 = 
assocs
[
assoc
] - 1;

248 
ebx
->
¥l™
.
physiÿl_lše_·¹™iÚ
 = 
lšes_³r_g
 - 1;

249 
ecx
->
¥l™
.
numb”_of_£ts
 = (
size_š_kb
 * 1024è/ 
lše_size
 /

250 (
ebx
->
¥l™
.
ways_of_assocŸtiv™y
 + 1) - 1;

251 
	}
}

253 
__ıuš™
 
	$ıuid4_ÿche_lookup
(
šdex
, 
_ıuid4_šfo
 *
this_Ëaf
)

255 
_ıuid4_Ëaf_—x
 
—x
;

256 
_ıuid4_Ëaf_ebx
 
ebx
;

257 
_ıuid4_Ëaf_ecx
 
ecx
;

258 
edx
;

260 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
)

261 
	`amd_ıuid4
(
šdex
, &
—x
, &
ebx
, &
ecx
);

263 
	`ıuid_couÁ
(4, 
šdex
, &
—x
.
fuÎ
, &
ebx
.fuÎ, &
ecx
.fuÎ, &
edx
);

264 ià(
—x
.
¥l™
.
ty³
 =ğ
CACHE_TYPE_NULL
)

265  -
EIO
;

267 
this_Ëaf
->
—x
 =ƒax;

268 
this_Ëaf
->
ebx
 =ƒbx;

269 
this_Ëaf
->
ecx
 =ƒcx;

270 
this_Ëaf
->
size
 = (
ecx
.
¥l™
.
numb”_of_£ts
 + 1) *

271 (
ebx
.
¥l™
.
coh”’cy_lše_size
 + 1) *

272 (
ebx
.
¥l™
.
physiÿl_lše_·¹™iÚ
 + 1) *

273 (
ebx
.
¥l™
.
ways_of_assocŸtiv™y
 + 1);

275 
	}
}

277 
__ıuš™
 
	$fšd_num_ÿche_Ëaves
()

279 
—x
, 
ebx
, 
ecx
, 
edx
;

280 
_ıuid4_Ëaf_—x
 
ÿche_—x
;

281 
i
 = -1;

284 ++
i
;

286 
	`ıuid_couÁ
(4, 
i
, &
—x
, &
ebx
, &
ecx
, &
edx
);

287 
ÿche_—x
.
fuÎ
 = 
—x
;

288 } 
ÿche_—x
.
¥l™
.
ty³
 !ğ
CACHE_TYPE_NULL
);

289  
i
;

290 
	}
}

292 
__ıuš™
 
	$š™_š‹l_ÿchešfo
(
ıušfo_x86
 *
c
)

294 
Œaû
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

295 
Ãw_l1d
 = 0, 
Ãw_l1i
 = 0;

296 
Ãw_l2
 = 0, 
Ãw_l3
 = 0, 
i
;

297 
l2_id
 = 0, 
l3_id
 = 0, 
num_th»ads_sh¬šg
, 
šdex_msb
;

298 #ifdeà
CONFIG_X86_HT


299 
ıu
 = 
c
->
ıu_šdex
;

302 ià(
c
->
ıuid_Ëv–
 > 3) {

303 
is_š™Ÿlized
;

305 ià(
is_š™Ÿlized
 == 0) {

307 
num_ÿche_Ëaves
 = 
	`fšd_num_ÿche_Ëaves
();

308 
is_š™Ÿlized
++;

315 
i
 = 0; i < 
num_ÿche_Ëaves
; i++) {

316 
_ıuid4_šfo
 
this_Ëaf
;

318 
»tv®
;

320 
»tv®
 = 
	`ıuid4_ÿche_lookup
(
i
, &
this_Ëaf
);

321 ià(
»tv®
 >= 0) {

322 
this_Ëaf
.
—x
.
¥l™
.
Ëv–
) {

324 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

325 
CACHE_TYPE_DATA
)

326 
Ãw_l1d
 = 
this_Ëaf
.
size
/1024;

327 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

328 
CACHE_TYPE_INST
)

329 
Ãw_l1i
 = 
this_Ëaf
.
size
/1024;

332 
Ãw_l2
 = 
this_Ëaf
.
size
/1024;

333 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

334 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

335 
l2_id
 = 
c
->
­icid
 >> 
šdex_msb
;

338 
Ãw_l3
 = 
this_Ëaf
.
size
/1024;

339 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

340 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

341 
l3_id
 = 
c
->
­icid
 >> 
šdex_msb
;

353 ià((
num_ÿche_Ëaves
 =ğ0 || 
c
->
x86
 =ğ15è&& c->
ıuid_Ëv–
 > 1) {

355 
i
, 
j
, 
n
;

356 
»gs
[4];

357 *
dp
 = (*)
»gs
;

358 
Úly_Œaû
 = 0;

360 ià(
num_ÿche_Ëaves
 !ğ0 && 
c
->
x86
 == 15)

361 
Úly_Œaû
 = 1;

364 
n
 = 
	`ıuid_—x
(2) & 0xFF;

366  
i
 = 0 ; i < 
n
 ; i++ ) {

367 
	`ıuid
(2, &
»gs
[0], &regs[1], &regs[2], &regs[3]);

370  
j
 = 0 ; j < 3 ; j++ ) {

371 iàĞ
»gs
[
j
] < 0 )„egs[j] = 0;

375  
j
 = 1 ; j < 16 ; j++ ) {

376 
des
 = 
dp
[
j
];

377 
k
 = 0;

380 
ÿche_bË
[
k
].
desütÜ
 != 0)

382 ià(
ÿche_bË
[
k
].
desütÜ
 =ğ
des
) {

383 ià(
Úly_Œaû
 && 
ÿche_bË
[
k
].
ÿche_ty³
 !ğ
LVL_TRACE
)

385 
ÿche_bË
[
k
].
ÿche_ty³
) {

386 
LVL_1_INST
:

387 
l1i
 +ğ
ÿche_bË
[
k
].
size
;

389 
LVL_1_DATA
:

390 
l1d
 +ğ
ÿche_bË
[
k
].
size
;

392 
LVL_2
:

393 
l2
 +ğ
ÿche_bË
[
k
].
size
;

395 
LVL_3
:

396 
l3
 +ğ
ÿche_bË
[
k
].
size
;

398 
LVL_TRACE
:

399 
Œaû
 +ğ
ÿche_bË
[
k
].
size
;

406 
k
++;

412 ià(
Ãw_l1d
)

413 
l1d
 = 
Ãw_l1d
;

415 ià(
Ãw_l1i
)

416 
l1i
 = 
Ãw_l1i
;

418 ià(
Ãw_l2
) {

419 
l2
 = 
Ãw_l2
;

420 #ifdeà
CONFIG_X86_HT


421 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
èğ
l2_id
;

425 ià(
Ãw_l3
) {

426 
l3
 = 
Ãw_l3
;

427 #ifdeà
CONFIG_X86_HT


428 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
èğ
l3_id
;

432 ià(
Œaû
)

433 
	`´štk
 (
KERN_INFO
 "CPU: T¿û cache: %dK uİs", 
Œaû
);

434 iàĞ
l1i
 )

435 
	`´štk
 (
KERN_INFO
 "CPU: L1 I cache: %dK", 
l1i
);

437 ià(
l1d
)

438 
	`´štk
(", L1 D cache: %dK\n", 
l1d
);

440 
	`´štk
("\n");

442 ià(
l2
)

443 
	`´štk
(
KERN_INFO
 "CPU: L2 cache: %dK\n", 
l2
);

445 ià(
l3
)

446 
	`´štk
(
KERN_INFO
 "CPU: L3 cache: %dK\n", 
l3
);

448 
c
->
x86_ÿche_size
 = 
l3
 ?†3 : (
l2
 ?†2 : (
l1i
+
l1d
));

450  
l2
;

451 
	}
}

454 
_ıuid4_šfo
 *
	gıuid4_šfo
[
NR_CPUS
];

455 
	#CPUID4_INFO_IDX
(
x
,
y
è(&((
ıuid4_šfo
[x])[y]))

	)

457 #ifdeà
CONFIG_SMP


458 
__ıuš™
 
	$ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
šdex
)

460 
_ıuid4_šfo
 *
this_Ëaf
, *
siblšg_Ëaf
;

461 
num_th»ads_sh¬šg
;

462 
šdex_msb
, 
i
;

463 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

465 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
šdex
);

466 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
->
—x
.
¥l™
.num_threads_sharing;

468 ià(
num_th»ads_sh¬šg
 == 1)

469 
	`ıu_£t
(
ıu
, 
this_Ëaf
->
sh¬ed_ıu_m­
);

471 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

473 
	`fÜ_—ch_Úlše_ıu
(
i
) {

474 ià(
	`ıu_d©a
(
i
).
­icid
 >> 
šdex_msb
 ==

475 
c
->
­icid
 >> 
šdex_msb
) {

476 
	`ıu_£t
(
i
, 
this_Ëaf
->
sh¬ed_ıu_m­
);

477 ià(
i
 !ğ
ıu
 && 
ıuid4_šfo
[i]) {

478 
siblšg_Ëaf
 = 
	`CPUID4_INFO_IDX
(
i
, 
šdex
);

479 
	`ıu_£t
(
ıu
, 
siblšg_Ëaf
->
sh¬ed_ıu_m­
);

484 
	}
}

485 
__ıuš™
 
	$ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
šdex
)

487 
_ıuid4_šfo
 *
this_Ëaf
, *
siblšg_Ëaf
;

488 
siblšg
;

490 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
šdex
);

491 
	`fÜ_—ch_ıu_mask
(
siblšg
, 
this_Ëaf
->
sh¬ed_ıu_m­
) {

492 
siblšg_Ëaf
 = 
	`CPUID4_INFO_IDX
(
siblšg
, 
šdex
);

493 
	`ıu_ş—r
(
ıu
, 
siblšg_Ëaf
->
sh¬ed_ıu_m­
);

495 
	}
}

497 
__ıuš™
 
	$ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
šdex
è{
	}
}

498 
__ıuš™
 
	$ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
šdex
è{
	}
}

501 
__ıuš™
 
	$ä“_ÿche_©Œibu‹s
(
ıu
)

503 
i
;

505 
i
 = 0; i < 
num_ÿche_Ëaves
; i++)

506 
	`ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
i
);

508 
	`kä“
(
ıuid4_šfo
[
ıu
]);

509 
ıuid4_šfo
[
ıu
] = 
NULL
;

510 
	}
}

512 
__ıuš™
 
	$d‘eù_ÿche_©Œibu‹s
(
ıu
)

514 
_ıuid4_šfo
 *
this_Ëaf
;

515 
j
;

516 
»tv®
;

517 
ıumask_t
 
Şdmask
;

519 ià(
num_ÿche_Ëaves
 == 0)

520  -
ENOENT
;

522 
ıuid4_šfo
[
ıu
] = 
	`kz®loc
(

523 (
_ıuid4_šfo
è* 
num_ÿche_Ëaves
, 
GFP_KERNEL
);

524 ià(
ıuid4_šfo
[
ıu
] =ğ
NULL
)

525  -
ENOMEM
;

527 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

528 
»tv®
 = 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
ıu
));

529 ià(
»tv®
)

530 
out
;

533 
j
 = 0; j < 
num_ÿche_Ëaves
; j++) {

534 
this_Ëaf
 = 
	`CPUID4_INFO_IDX
(
ıu
, 
j
);

535 
»tv®
 = 
	`ıuid4_ÿche_lookup
(
j
, 
this_Ëaf
);

536 ià(
	`uÆik–y
(
»tv®
 < 0)) {

537 
i
;

539 
i
 = 0; i < 
j
; i++)

540 
	`ÿche_»move_sh¬ed_ıu_m­
(
ıu
, 
i
);

543 
	`ÿche_sh¬ed_ıu_m­_£tup
(
ıu
, 
j
);

545 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

547 
out
:

548 ià(
»tv®
) {

549 
	`kä“
(
ıuid4_šfo
[
ıu
]);

550 
ıuid4_šfo
[
ıu
] = 
NULL
;

553  
»tv®
;

554 
	}
}

556 #ifdeà
CONFIG_SYSFS


558 
	~<lšux/kobjeù.h
>

559 
	~<lšux/sysfs.h
>

561 
sysdev_şass
 
ıu_sysdev_şass
;

564 
kobjeù
 * 
	gÿche_kobjeù
[
NR_CPUS
];

566 
	s_šdex_kobjeù
 {

567 
kobjeù
 
	mkobj
;

568 
	mıu
;

569 
	mšdex
;

573 
_šdex_kobjeù
 *
	gšdex_kobjeù
[
NR_CPUS
];

574 
	#INDEX_KOBJECT_PTR
(
x
,
y
è(&((
šdex_kobjeù
[x])[y]))

	)

576 
	#show_Úe_¶us
(
fe_Çme
, 
objeù
, 
v®
) \

577 
ssize_t
 
show_
##
fe_Çme
 \

578 (
_ıuid4_šfo
 *
this_Ëaf
, *
buf
) \

580  
	`¥rštf
 (
buf
, "%lu\n", ()
this_Ëaf
->
objeù
 + 
v®
); \

581 }

	)

583 
show_Úe_¶us
(
Ëv–
, 
—x
.
¥l™
.level, 0);

584 
show_Úe_¶us
(
coh”’cy_lše_size
, 
ebx
.
¥l™
.coherency_line_size, 1);

585 
show_Úe_¶us
(
physiÿl_lše_·¹™iÚ
, 
ebx
.
¥l™
.physical_line_partition, 1);

586 
show_Úe_¶us
(
ways_of_assocŸtiv™y
, 
ebx
.
¥l™
.ways_of_associativity, 1);

587 
show_Úe_¶us
(
numb”_of_£ts
, 
ecx
.
¥l™
.number_of_sets, 1);

589 
ssize_t
 
	$show_size
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
)

591  
	`¥rštf
 (
buf
, "%luK\n", 
this_Ëaf
->
size
 / 1024);

592 
	}
}

594 
ssize_t
 
	$show_sh¬ed_ıu_m­
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
)

596 
mask_¡r
[
NR_CPUS
];

597 
	`ıumask_sú´štf
(
mask_¡r
, 
NR_CPUS
, 
this_Ëaf
->
sh¬ed_ıu_m­
);

598  
	`¥rštf
(
buf
, "%s\n", 
mask_¡r
);

599 
	}
}

601 
ssize_t
 
	$show_ty³
(
_ıuid4_šfo
 *
this_Ëaf
, *
buf
) {

602 
this_Ëaf
->
—x
.
¥l™
.
ty³
) {

603 
CACHE_TYPE_DATA
:

604  
	`¥rštf
(
buf
, "Data\n");

606 
CACHE_TYPE_INST
:

607  
	`¥rštf
(
buf
, "Instruction\n");

609 
CACHE_TYPE_UNIFIED
:

610  
	`¥rštf
(
buf
, "Unified\n");

613  
	`¥rštf
(
buf
, "Unknown\n");

616 
	}
}

618 
	s_ÿche_©Œ
 {

619 
©Œibu‹
 
	m©Œ
;

620 
ssize_t
 (*
show
)(
	m_ıuid4_šfo
 *, *);

621 
ssize_t
 (*
¡Üe
)(
	m_ıuid4_šfo
 *, cÚ¡ *, 
size_t
 
	mcouÁ
);

624 
	#defše_Úe_ro
(
_Çme
) \

625 
_ÿche_©Œ
 
_Çme
 = \

626 
	`__ATTR
(
_Çme
, 0444, 
show_
##_Çme, 
NULL
)

	)

628 
defše_Úe_ro
(
Ëv–
);

629 
defše_Úe_ro
(
ty³
);

630 
defše_Úe_ro
(
coh”’cy_lše_size
);

631 
defše_Úe_ro
(
physiÿl_lše_·¹™iÚ
);

632 
defše_Úe_ro
(
ways_of_assocŸtiv™y
);

633 
defše_Úe_ro
(
numb”_of_£ts
);

634 
defše_Úe_ro
(
size
);

635 
defše_Úe_ro
(
sh¬ed_ıu_m­
);

637 
©Œibu‹
 * 
	gdeçuÉ_©Œs
[] = {

638 &
ty³
.
©Œ
,

639 &
Ëv–
.
©Œ
,

640 &
coh”’cy_lše_size
.
©Œ
,

641 &
physiÿl_lše_·¹™iÚ
.
©Œ
,

642 &
ways_of_assocŸtiv™y
.
©Œ
,

643 &
numb”_of_£ts
.
©Œ
,

644 &
size
.
©Œ
,

645 &
sh¬ed_ıu_m­
.
©Œ
,

646 
NULL


649 
	#to_objeù
(
k
è
	`cÚš”_of
(k, 
_šdex_kobjeù
, 
kobj
)

	)

650 
	#to_©Œ
(
a
è
	`cÚš”_of
×, 
_ÿche_©Œ
, 
©Œ
)

	)

652 
ssize_t
 
	$show
(
kobjeù
 * 
kobj
, 
©Œibu‹
 * 
©Œ
, * 
buf
)

654 
_ÿche_©Œ
 *
ç‰r
 = 
	`to_©Œ
(
©Œ
);

655 
_šdex_kobjeù
 *
this_Ëaf
 = 
	`to_objeù
(
kobj
);

656 
ssize_t
 
»t
;

658 
»t
 = 
ç‰r
->
show
 ?

659 
ç‰r
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Ëaf
->
ıu
,his_Ëaf->
šdex
),

660 
buf
) :

662  
»t
;

663 
	}
}

665 
ssize_t
 
	$¡Üe
(
kobjeù
 * 
kobj
, 
©Œibu‹
 * 
©Œ
,

666 cÚ¡ * 
buf
, 
size_t
 
couÁ
)

669 
	}
}

671 
sysfs_İs
 
	gsysfs_İs
 = {

672 .
show
 = show,

673 .
	g¡Üe
 = 
¡Üe
,

676 
kobj_ty³
 
	gkty³_ÿche
 = {

677 .
sysfs_İs
 = &sysfs_ops,

678 .
	gdeçuÉ_©Œs
 = 
deçuÉ_©Œs
,

681 
kobj_ty³
 
	gkty³_³rıu_’Œy
 = {

682 .
sysfs_İs
 = &sysfs_ops,

685 
__ıuš™
 
	$ıuid4_ÿche_sysfs_ex™
(
ıu
)

687 
	`kä“
(
ÿche_kobjeù
[
ıu
]);

688 
	`kä“
(
šdex_kobjeù
[
ıu
]);

689 
ÿche_kobjeù
[
ıu
] = 
NULL
;

690 
šdex_kobjeù
[
ıu
] = 
NULL
;

691 
	`ä“_ÿche_©Œibu‹s
(
ıu
);

692 
	}
}

694 
__ıuš™
 
	$ıuid4_ÿche_sysfs_š™
(
ıu
)

696 
”r
;

698 ià(
num_ÿche_Ëaves
 == 0)

699  -
ENOENT
;

701 
”r
 = 
	`d‘eù_ÿche_©Œibu‹s
(
ıu
);

702 ià(
”r
)

703  
”r
;

706 
ÿche_kobjeù
[
ıu
] = 
	`kz®loc
((
kobjeù
), 
GFP_KERNEL
);

707 ià(
	`uÆik–y
(
ÿche_kobjeù
[
ıu
] =ğ
NULL
))

708 
”r_out
;

710 
šdex_kobjeù
[
ıu
] = 
	`kz®loc
(

711 (
_šdex_kobjeù
 ) * 
num_ÿche_Ëaves
, 
GFP_KERNEL
);

712 ià(
	`uÆik–y
(
šdex_kobjeù
[
ıu
] =ğ
NULL
))

713 
”r_out
;

717 
”r_out
:

718 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

719  -
ENOMEM
;

720 
	}
}

722 
ıumask_t
 
	gÿche_dev_m­
 = 
CPU_MASK_NONE
;

725 
__ıuš™
 
	$ÿche_add_dev
(
sys_deviû
 * 
sys_dev
)

727 
ıu
 = 
sys_dev
->
id
;

728 
i
, 
j
;

729 
_šdex_kobjeù
 *
this_objeù
;

730 
»tv®
;

732 
»tv®
 = 
	`ıuid4_ÿche_sysfs_š™
(
ıu
);

733 ià(
	`uÆik–y
(
»tv®
 < 0))

734  
»tv®
;

736 
ÿche_kobjeù
[
ıu
]->
·»Á
 = &
sys_dev
->
kobj
;

737 
	`kobjeù_£t_Çme
(
ÿche_kobjeù
[
ıu
], "%s", "cache");

738 
ÿche_kobjeù
[
ıu
]->
kty³
 = &
kty³_³rıu_’Œy
;

739 
»tv®
 = 
	`kobjeù_»gi¡”
(
ÿche_kobjeù
[
ıu
]);

740 ià(
»tv®
 < 0) {

741 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

742  
»tv®
;

745 
i
 = 0; i < 
num_ÿche_Ëaves
; i++) {

746 
this_objeù
 = 
	`INDEX_KOBJECT_PTR
(
ıu
,
i
);

747 
this_objeù
->
ıu
 = cpu;

748 
this_objeù
->
šdex
 = 
i
;

749 
this_objeù
->
kobj
.
·»Á
 = 
ÿche_kobjeù
[
ıu
];

750 
	`kobjeù_£t_Çme
(&(
this_objeù
->
kobj
), "šdex%1lu", 
i
);

751 
this_objeù
->
kobj
.
kty³
 = &
kty³_ÿche
;

752 
»tv®
 = 
	`kobjeù_»gi¡”
(&(
this_objeù
->
kobj
));

753 ià(
	`uÆik–y
(
»tv®
)) {

754 
j
 = 0; j < 
i
; j++) {

755 
	`kobjeù_uÄegi¡”
(

756 &(
	`INDEX_KOBJECT_PTR
(
ıu
,
j
)->
kobj
));

758 
	`kobjeù_uÄegi¡”
(
ÿche_kobjeù
[
ıu
]);

759 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

763 ià(!
»tv®
)

764 
	`ıu_£t
(
ıu
, 
ÿche_dev_m­
);

766  
»tv®
;

767 
	}
}

769 
__ıuš™
 
	$ÿche_»move_dev
(
sys_deviû
 * 
sys_dev
)

771 
ıu
 = 
sys_dev
->
id
;

772 
i
;

774 ià(
ıuid4_šfo
[
ıu
] =ğ
NULL
)

776 ià(!
	`ıu_is£t
(
ıu
, 
ÿche_dev_m­
))

778 
	`ıu_ş—r
(
ıu
, 
ÿche_dev_m­
);

780 
i
 = 0; i < 
num_ÿche_Ëaves
; i++)

781 
	`kobjeù_uÄegi¡”
(&(
	`INDEX_KOBJECT_PTR
(
ıu
,
i
)->
kobj
));

782 
	`kobjeù_uÄegi¡”
(
ÿche_kobjeù
[
ıu
]);

783 
	`ıuid4_ÿche_sysfs_ex™
(
ıu
);

784 
	}
}

786 
__ıuš™
 
	$ÿchešfo_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

787 
aùiÚ
, *
hıu
)

789 
ıu
 = ()
hıu
;

790 
sys_deviû
 *
sys_dev
;

792 
sys_dev
 = 
	`g‘_ıu_sysdev
(
ıu
);

793 
aùiÚ
) {

794 
CPU_ONLINE
:

795 
CPU_ONLINE_FROZEN
:

796 
	`ÿche_add_dev
(
sys_dev
);

798 
CPU_DEAD
:

799 
CPU_DEAD_FROZEN
:

800 
	`ÿche_»move_dev
(
sys_dev
);

803  
NOTIFY_OK
;

804 
	}
}

806 
nÙif›r_block
 
__ıuš™d©a
 
	gÿchešfo_ıu_nÙif›r
 =

808 .
nÙif›r_ÿÎ
 = 
ÿchešfo_ıu_ÿÎback
,

811 
__ıuš™
 
	$ÿche_sysfs_š™
()

813 
i
;

815 ià(
num_ÿche_Ëaves
 == 0)

818 
	`fÜ_—ch_Úlše_ıu
(
i
) {

819 
”r
;

820 
sys_deviû
 *
sys_dev
 = 
	`g‘_ıu_sysdev
(
i
);

822 
”r
 = 
	`ÿche_add_dev
(
sys_dev
);

823 ià(
”r
)

824  
”r
;

826 
	`»gi¡”_hÙıu_nÙif›r
(&
ÿchešfo_ıu_nÙif›r
);

828 
	}
}

830 
deviû_š™ÿÎ
(
ÿche_sysfs_š™
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_64.c

8 
	~<lšux/š™.h
>

9 
	~<lšux/ty³s.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/rcupd©e.h
>

14 
	~<lšux/k®lsyms.h
>

15 
	~<lšux/sysdev.h
>

16 
	~<lšux/miscdeviû.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/ÿ·b™y.h
>

19 
	~<lšux/ıu.h
>

20 
	~<lšux/³rıu.h
>

21 
	~<lšux/pŞl.h
>

22 
	~<lšux/th»ad_šfo.h
>

23 
	~<lšux/ùy³.h
>

24 
	~<lšux/kmod.h
>

25 
	~<lšux/kdebug.h
>

26 
	~<asm/´oûssÜ.h
>

27 
	~<asm/m¤.h
>

28 
	~<asm/mû.h
>

29 
	~<asm/uacûss.h
>

30 
	~<asm/smp.h
>

31 
	~<asm/idË.h
>

33 
	#MISC_MCELOG_MINOR
 227

	)

34 
	#NR_BANKS
 6

	)

36 
©omic_t
 
	gmû_’Œy
;

38 
	gmû_dÚt_š™
;

47 
	gtŞ”ªt
 = 1;

48 
	gbªks
;

49 
	gbªk
[
NR_BANKS
] = { [0 ... NR_BANKS-1] = ~0UL };

50 
	gnÙify_u£r
;

51 
	gr_m¤
;

52 
	gmû_boÙlog
 = 1;

53 
©omic_t
 
	gmû_ev’ts
;

55 
	gŒigg”
[128];

56 *
	gŒigg”_¬gv
[2] = { 
Œigg”
, 
NULL
 };

58 
DECLARE_WAIT_QUEUE_HEAD
(
mû_wa™
);

66 
mû_log
 
	gmûlog
 = {

67 
MCE_LOG_SIGNATURE
,

68 
MCE_LOG_LEN
,

71 
	$mû_log
(
mû
 *mce)

73 
Ãxt
, 
’Œy
;

74 
	`©omic_šc
(&
mû_ev’ts
);

75 
mû
->
fšished
 = 0;

76 
	`wmb
();

78 
’Œy
 = 
	`rcu_d”eã»nû
(
mûlog
.
Ãxt
);

82 ià(
’Œy
 >ğ
MCE_LOG_LEN
) {

83 
	`£t_b™
(
MCE_OVERFLOW
, &
mûlog
.
æags
);

87 ià(
mûlog
.
’Œy
[’Œy].
fšished
) {

88 
’Œy
++;

93 
	`smp_rmb
();

94 
Ãxt
 = 
’Œy
 + 1;

95 ià(
	`cmpxchg
(&
mûlog
.
Ãxt
, 
’Œy
,‚ext) ==ƒntry)

98 
	`memıy
(
mûlog
.
’Œy
 +ƒÁry, 
mû
, (mce));

99 
	`wmb
();

100 
mûlog
.
’Œy
[’Œy].
fšished
 = 1;

101 
	`wmb
();

103 
	`£t_b™
(0, &
nÙify_u£r
);

104 
	}
}

106 
	$´št_mû
(
mû
 *
m
)

108 
	`´štk
(
KERN_EMERG
 "\n"

109 
KERN_EMERG
 "HARDWARE ERROR\n"

110 
KERN_EMERG


112 
m
->
ıu
, m->
mcg¡©us
, m->
bªk
, m->
¡©us
);

113 ià(
m
->
r
) {

114 
	`´štk
(
KERN_EMERG
 "RIP%s %02x:<%016Lx> ",

115 !(
m
->
mcg¡©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

116 
m
->
cs
, m->
r
);

117 ià(
m
->
cs
 =ğ
__KERNEL_CS
)

118 
	`´št_symbŞ
("{%s}", 
m
->
r
);

119 
	`´štk
("\n");

121 
	`´štk
(
KERN_EMERG
 "TSC %Lx ", 
m
->
tsc
);

122 ià(
m
->
addr
)

123 
	`´štk
("ADDR %Lx ", 
m
->
addr
);

124 ià(
m
->
misc
)

125 
	`´štk
("MISC %Lx ", 
m
->
misc
);

126 
	`´štk
("\n");

127 
	`´štk
(
KERN_EMERG
 "This is‚ot‡ software…roblem!\n");

128 
	`´štk
(
KERN_EMERG
 "Runhrough mcelog --asciio decode "

130 
	}
}

132 
	$mû_·nic
(*
msg
, 
mû
 *
backup
, 
¡¬t
)

134 
i
;

136 
	`oİs_begš
();

137 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

138 
tsc
 = 
mûlog
.
’Œy
[
i
].tsc;

140 ià(
	`time_befÜe
(
tsc
, 
¡¬t
))

142 
	`´št_mû
(&
mûlog
.
’Œy
[
i
]);

143 ià(
backup
 && 
mûlog
.
’Œy
[
i
].
tsc
 == backup->tsc)

144 
backup
 = 
NULL
;

146 ià(
backup
)

147 
	`´št_mû
(
backup
);

148 
	`·nic
(
msg
);

149 
	}
}

151 
	$mû_avaabË
(
ıušfo_x86
 *
c
)

153  
	`ıu_has
(
c
, 
X86_FEATURE_MCE
è&& cpu_has(c, 
X86_FEATURE_MCA
);

154 
	}
}

156 
šlše
 
	$mû_g‘_r
(
mû
 *
m
, 
±_»gs
 *
»gs
)

158 ià(
»gs
 && (
m
->
mcg¡©us
 & 
MCG_STATUS_RIPV
)) {

159 
m
->
r
 = 
»gs
->rip;

160 
m
->
cs
 = 
»gs
->cs;

162 
m
->
r
 = 0;

163 
m
->
cs
 = 0;

165 ià(
r_m¤
) {

167 
m
->
mcg¡©us
 |ğ
MCG_STATUS_EIPV
;

168 
	`rdm¤l
(
r_m¤
, 
m
->
r
);

169 
m
->
cs
 = 0;

171 
	}
}

176 
	$do_machše_check
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

178 
mû
 
m
, 
·nicm
;

179 
u64
 
mû¡¬t
 = 0;

180 
i
;

181 
·nicm_found
 = 0;

186 
no_way_out
 = 0;

191 
kl_™
 = 0;

193 
	`©omic_šc
(&
mû_’Œy
);

195 ià(
»gs
)

196 
	`nÙify_d›
(
DIE_NMI
, "machšcheck", 
»gs
, 
”rÜ_code
, 18,

197 
SIGKILL
);

198 ià(!
bªks
)

199 
out2
;

201 
	`mem£t
(&
m
, 0, (
mû
));

202 
m
.
ıu
 = 
	`smp_´oûssÜ_id
();

203 
	`rdm¤l
(
MSR_IA32_MCG_STATUS
, 
m
.
mcg¡©us
);

205 ià(!(
m
.
mcg¡©us
 & 
MCG_STATUS_RIPV
))

206 
no_way_out
 = 1;

208 
	`rdtsşl
(
mû¡¬t
);

209 
	`b¬r›r
();

211 
i
 = 0; i < 
bªks
; i++) {

212 ià(!
bªk
[
i
])

215 
m
.
misc
 = 0;

216 
m
.
addr
 = 0;

217 
m
.
bªk
 = 
i
;

218 
m
.
tsc
 = 0;

220 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
 + 
i
*4, 
m
.
¡©us
);

221 ià((
m
.
¡©us
 & 
MCI_STATUS_VAL
) == 0)

224 ià(
m
.
¡©us
 & 
MCI_STATUS_EN
) {

226 
no_way_out
 |ğ!!(
m
.
¡©us
 & 
MCI_STATUS_PCC
);

232 ià(
m
.
¡©us
 & 
MCI_STATUS_UC
) {

233 ià(
tŞ”ªt
 < 1 || 
m
.
¡©us
 & 
MCI_STATUS_OVER
)

234 
no_way_out
 = 1;

235 
kl_™
 = 1;

239 ià(
m
.
¡©us
 & 
MCI_STATUS_MISCV
)

240 
	`rdm¤l
(
MSR_IA32_MC0_MISC
 + 
i
*4, 
m
.
misc
);

241 ià(
m
.
¡©us
 & 
MCI_STATUS_ADDRV
)

242 
	`rdm¤l
(
MSR_IA32_MC0_ADDR
 + 
i
*4, 
m
.
addr
);

244 
	`mû_g‘_r
(&
m
, 
»gs
);

245 ià(
”rÜ_code
 >= 0)

246 
	`rdtsşl
(
m
.
tsc
);

247 ià(
”rÜ_code
 != -2)

248 
	`mû_log
(&
m
);

253 ià((
m
.
¡©us
 & 
MCI_STATUS_UC
è&& (m.¡©u & 
MCI_STATUS_EN
)) {

254 
·nicm
 = 
m
;

255 
·nicm_found
 = 1;

258 
	`add_št
(
TAINT_MACHINE_CHECK
);

262 ià(!
»gs
)

263 
out
;

267 ià(!
·nicm_found
)

268 
·nicm
 = 
m
;

274 ià(
no_way_out
 && 
tŞ”ªt
 < 3)

275 
	`mû_·nic
("Machšcheck", &
·nicm
, 
mû¡¬t
);

283 ià(
kl_™
 && 
tŞ”ªt
 < 3) {

284 
u£r_¥aû
 = 0;

290 ià(
m
.
mcg¡©us
 & 
MCG_STATUS_EIPV
)

291 
u£r_¥aû
 = 
·nicm
.
r
 && (·nicm.
cs
 & 3);

300 ià(
u£r_¥aû
) {

301 
	`do_ex™
(
SIGBUS
);

302 } ià(
·nic_Ú_oİs
 || 
tŞ”ªt
 < 2) {

303 
	`mû_·nic
("Uncorrected machine check",

304 &
·nicm
, 
mû¡¬t
);

309 
	`£t_th»ad_æag
(
TIF_MCE_NOTIFY
);

311 
out
:

313 
i
 = 0; i < 
bªks
; i++)

314 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

315 
	`wrm¤l
(
MSR_IA32_MCG_STATUS
, 0);

316 
out2
:

317 
	`©omic_dec
(&
mû_’Œy
);

318 
	}
}

320 #ifdeà
CONFIG_X86_MCE_INTEL


334 
	$mû_log_th”m_thrÙ_ev’t
(
ıu
, 
__u64
 
¡©us
)

336 
mû
 
m
;

338 
	`mem£t
(&
m
, 0, (m));

339 
m
.
ıu
 = cpu;

340 
m
.
bªk
 = 
MCE_THERMAL_BANK
;

341 
m
.
¡©us
 = status;

342 
	`rdtsşl
(
m
.
tsc
);

343 
	`mû_log
(&
m
);

344 
	}
}

353 
	gcheck_š‹rv®
 = 5 * 60;

354 
	gÃxt_š‹rv®
;

355 
mcheck_tim”
(
wÜk_¡ruù
 *
wÜk
);

356 
DECLARE_DELAYED_WORK
(
mcheck_wÜk
, 
mcheck_tim”
);

358 
	$mcheck_check_ıu
(*
šfo
)

360 ià(
	`mû_avaabË
(&
cu¼’t_ıu_d©a
))

361 
	`do_machše_check
(
NULL
, 0);

362 
	}
}

364 
	$mcheck_tim”
(
wÜk_¡ruù
 *
wÜk
)

366 
	`Ú_—ch_ıu
(
mcheck_check_ıu
, 
NULL
, 1, 1);

372 ià(
	`mû_nÙify_u£r
()) {

373 
Ãxt_š‹rv®
 = 
	`max
Òext_š‹rv®/2, 
HZ
/100);

375 
Ãxt_š‹rv®
 = 
	`mš
(next_interval * 2,

376 ()
	`round_jiff›s_»Ïtive
(
check_š‹rv®
*
HZ
));

379 
	`scheduË_d–ayed_wÜk
(&
mcheck_wÜk
, 
Ãxt_š‹rv®
);

380 
	}
}

388 
	$mû_nÙify_u£r
()

390 
	`ş—r_th»ad_æag
(
TIF_MCE_NOTIFY
);

391 ià(
	`‹¡_ªd_ş—r_b™
(0, &
nÙify_u£r
)) {

392 
Ï¡_´št
;

393 
now
 = 
jiff›s
;

395 
	`wake_up_š‹¼u±ibË
(&
mû_wa™
);

396 ià(
Œigg”
[0])

397 
	`ÿÎ_u£rmodeh–³r
(
Œigg”
, 
Œigg”_¬gv
, 
NULL
,

398 
UMH_NO_WAIT
);

400 ià(
	`time_aá”_eq
(
now
, 
Ï¡_´št
 + (
check_š‹rv®
*
HZ
))) {

401 
Ï¡_´št
 = 
now
;

402 
	`´štk
(
KERN_INFO
 "Machine checkƒvents†ogged\n");

408 
	}
}

412 
	$mû_idË_ÿÎback
(
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
junk
)

415 ià(
aùiÚ
 =ğ
IDLE_END
 && 
	`‹¡_th»ad_æag
(
TIF_MCE_NOTIFY
))

416 
	`mû_nÙify_u£r
();

418  
NOTIFY_OK
;

419 
	}
}

421 
nÙif›r_block
 
	gmû_idË_nÙif›r
 = {

422 .
nÙif›r_ÿÎ
 = 
mû_idË_ÿÎback
,

425 
__š™
 
	$³riodic_mcheck_š™
()

427 
Ãxt_š‹rv®
 = 
check_š‹rv®
 * 
HZ
;

428 ià(
Ãxt_š‹rv®
)

429 
	`scheduË_d–ayed_wÜk
(&
mcheck_wÜk
,

430 
	`round_jiff›s_»Ïtive
(
Ãxt_š‹rv®
));

431 
	`idË_nÙif›r_»gi¡”
(&
mû_idË_nÙif›r
);

433 
	}
}

434 
__š™ÿÎ
(
³riodic_mcheck_š™
);

440 
	$mû_š™
(*
dummy
)

442 
u64
 
ÿp
;

443 
i
;

445 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
ÿp
);

446 
bªks
 = 
ÿp
 & 0xff;

447 ià(
bªks
 > 
NR_BANKS
) {

448 
	`´štk
(
KERN_INFO
 "MCE: w¬nšg: usšg oÆy %d bªks\n", 
bªks
);

449 
bªks
 = 
NR_BANKS
;

452 ià((
ÿp
 & (1<<9)) && ((cap >> 16) & 0xff) >= 9)

453 
r_m¤
 = 
MSR_IA32_MCG_EIP
;

457 
	`do_machše_check
(
NULL
, 
mû_boÙlog
 ? -1 : -2);

459 
	`£t_š_ü4
(
X86_CR4_MCE
);

461 ià(
ÿp
 & 
MCG_CTL_P
)

462 
	`wrm¤
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

464 
i
 = 0; i < 
bªks
; i++) {

465 
	`wrm¤l
(
MSR_IA32_MC0_CTL
+4*
i
, 
bªk
[i]);

466 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
+4*
i
, 0);

468 
	}
}

471 
__ıuš™
 
	$mû_ıu_quœks
(
ıušfo_x86
 *
c
)

474 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 && c->
x86
 == 15) {

477 
	`ş—r_b™
(10, &
bªk
[4]);

480 
mû_boÙlog
 = 0;

483 
	}
}

485 
__ıuš™
 
	$mû_ıu_ã©u»s
(
ıušfo_x86
 *
c
)

487 
c
->
x86_v’dÜ
) {

488 
X86_VENDOR_INTEL
:

489 
	`mû_š‹l_ã©u»_š™
(
c
);

491 
X86_VENDOR_AMD
:

492 
	`mû_amd_ã©u»_š™
(
c
);

497 
	}
}

503 
__ıuš™
 
	$mcheck_š™
(
ıušfo_x86
 *
c
)

505 
ıumask_t
 
mû_ıus
 = 
CPU_MASK_NONE
;

507 
	`mû_ıu_quœks
(
c
);

509 ià(
mû_dÚt_š™
 ||

510 
	`ıu_‹¡_ªd_£t
(
	`smp_´oûssÜ_id
(), 
mû_ıus
) ||

511 !
	`mû_avaabË
(
c
))

514 
	`mû_š™
(
NULL
);

515 
	`mû_ıu_ã©u»s
(
c
);

516 
	}
}

522 
DEFINE_SPINLOCK
(
mû_¡©e_lock
);

523 
	gİ’_couÁ
;

524 
	gİ’_exşu
;

526 
	$mû_İ’
(
šode
 *šode, 
fe
 *file)

528 
	`¥š_lock
(&
mû_¡©e_lock
);

530 ià(
İ’_exşu
 || (
İ’_couÁ
 && (
fe
->
f_æags
 & 
O_EXCL
))) {

531 
	`¥š_uÆock
(&
mû_¡©e_lock
);

532  -
EBUSY
;

535 ià(
fe
->
f_æags
 & 
O_EXCL
)

536 
İ’_exşu
 = 1;

537 
İ’_couÁ
++;

539 
	`¥š_uÆock
(&
mû_¡©e_lock
);

541  
	`nÚ£ekabË_İ’
(
šode
, 
fe
);

542 
	}
}

544 
	$mû_»Ëa£
(
šode
 *šode, 
fe
 *file)

546 
	`¥š_lock
(&
mû_¡©e_lock
);

548 
İ’_couÁ
--;

549 
İ’_exşu
 = 0;

551 
	`¥š_uÆock
(&
mû_¡©e_lock
);

554 
	}
}

556 
	$cŞËù_tscs
(*
d©a
)

558 *
ıu_tsc
 = (*)
d©a
;

560 
	`rdtsşl
(
ıu_tsc
[
	`smp_´oûssÜ_id
()]);

561 
	}
}

563 
ssize_t
 
	$mû_»ad
(
fe
 *
fp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

564 
loff_t
 *
off
)

566 *
ıu_tsc
;

567 
	`DECLARE_MUTEX
(
mû_»ad_£m
);

568 
Ãxt
;

569 
__u£r
 *
buf
 = 
ubuf
;

570 
i
, 
”r
;

572 
ıu_tsc
 = 
	`km®loc
(
NR_CPUS
 * (), 
GFP_KERNEL
);

573 ià(!
ıu_tsc
)

574  -
ENOMEM
;

576 
	`down
(&
mû_»ad_£m
);

577 
Ãxt
 = 
	`rcu_d”eã»nû
(
mûlog
.next);

580 ià(*
off
 !ğ0 || 
usize
 < 
MCE_LOG_LEN
*(
mû
)) {

581 
	`up
(&
mû_»ad_£m
);

582 
	`kä“
(
ıu_tsc
);

583  -
EINVAL
;

586 
”r
 = 0;

587 
i
 = 0; i < 
Ãxt
; i++) {

588 
¡¬t
 = 
jiff›s
;

590 !
mûlog
.
’Œy
[
i
].
fšished
) {

591 ià(
	`time_aá”_eq
(
jiff›s
, 
¡¬t
 + 2)) {

592 
	`mem£t
(
mûlog
.
’Œy
 + 
i
,0, (
mû
));

593 
timeout
;

595 
	`ıu_»Ïx
();

597 
	`smp_rmb
();

598 
”r
 |ğ
	`cİy_to_u£r
(
buf
, 
mûlog
.
’Œy
 + 
i
, (
mû
));

599 
buf
 +ğ(
mû
);

600 
timeout
:

604 
	`mem£t
(
mûlog
.
’Œy
, 0, 
Ãxt
 * (
mû
));

605 
mûlog
.
Ãxt
 = 0;

607 
	`synchrÚize_sched
();

613 
	`Ú_—ch_ıu
(
cŞËù_tscs
, 
ıu_tsc
, 1, 1);

614 
i
 = 
Ãxt
; i < 
MCE_LOG_LEN
; i++) {

615 ià(
mûlog
.
’Œy
[
i
].
fšished
 &&

616 
mûlog
.
’Œy
[
i
].
tsc
 < 
ıu_tsc
[mûlog.’Œy[i].
ıu
]) {

617 
”r
 |ğ
	`cİy_to_u£r
(
buf
, 
mûlog
.
’Œy
+
i
,

618 (
mû
));

619 
	`smp_rmb
();

620 
buf
 +ğ(
mû
);

621 
	`mem£t
(&
mûlog
.
’Œy
[
i
], 0, (
mû
));

624 
	`up
(&
mû_»ad_£m
);

625 
	`kä“
(
ıu_tsc
);

626  
”r
 ? -
EFAULT
 : 
buf
 - 
ubuf
;

627 
	}
}

629 
	$mû_pŞl
(
fe
 *fe, 
pŞl_bË
 *
wa™
)

631 
	`pŞl_wa™
(
fe
, &
mû_wa™
, 
wa™
);

632 ià(
	`rcu_d”eã»nû
(
mûlog
.
Ãxt
))

633  
POLLIN
 | 
POLLRDNORM
;

635 
	}
}

637 
	$mû_ioùl
(
šode
 *
i
, 
fe
 *
f
,
cmd
,

638 
¬g
)

640 
__u£r
 *
p
 = (__u£¸*)
¬g
;

642 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

643  -
EPERM
;

644 
cmd
) {

645 
MCE_GET_RECORD_LEN
:

646  
	`put_u£r
((
mû
), 
p
);

647 
MCE_GET_LOG_LEN
:

648  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

649 
MCE_GETCLEAR_FLAGS
: {

650 
æags
;

653 
æags
 = 
mûlog
.flags;

654 } 
	`cmpxchg
(&
mûlog
.
æags
, flags, 0) != flags);

655  
	`put_u£r
(
æags
, 
p
);

658  -
ENOTTY
;

660 
	}
}

662 cÚ¡ 
fe_İ”©iÚs
 
	gmû_chrdev_İs
 = {

663 .
İ’
 = 
mû_İ’
,

664 .
	g»Ëa£
 = 
mû_»Ëa£
,

665 .
	g»ad
 = 
mû_»ad
,

666 .
	gpŞl
 = 
mû_pŞl
,

667 .
	gioùl
 = 
mû_ioùl
,

670 
miscdeviû
 
	gmû_log_deviû
 = {

671 
MISC_MCELOG_MINOR
,

673 &
mû_chrdev_İs
,

676 
Şd_ü4
 
	g__š™d©a
;

678 
__š™
 
	$¡İ_mû
()

680 
Şd_ü4
 = 
	`»ad_ü4
();

681 
	`ş—r_š_ü4
(
X86_CR4_MCE
);

682 
	}
}

684 
__š™
 
	$»¡¬t_mû
()

686 ià(
Şd_ü4
 & 
X86_CR4_MCE
)

687 
	`£t_š_ü4
(
X86_CR4_MCE
);

688 
	}
}

693 
__š™
 
	$mcheck_di§bË
(*
¡r
)

695 
mû_dÚt_š™
 = 1;

697 
	}
}

704 
__š™
 
	$mcheck_’abË
(*
¡r
)

706 ià(!
	`¡rcmp
(
¡r
, "off"))

707 
mû_dÚt_š™
 = 1;

708 ià(!
	`¡rcmp
(
¡r
, "bootlog") || !strcmp(str,"nobootlog"))

709 
mû_boÙlog
 = 
¡r
[0] == 'b';

710 ià(
	`isdig™
(
¡r
[0]))

711 
	`g‘_İtiÚ
(&
¡r
, &
tŞ”ªt
);

713 
	`´štk
("mûğ¬gum’ˆ% ignÜed. PËa£ u£ /sys", 
¡r
);

715 
	}
}

717 
__£tup
("nomû", 
mcheck_di§bË
);

718 
__£tup
("mû=", 
mcheck_’abË
);

727 
	$mû_»sume
(
sys_deviû
 *
dev
)

729 
	`mû_š™
(
NULL
);

731 
	}
}

734 
	$mû_»¡¬t
()

736 ià(
Ãxt_š‹rv®
)

737 
	`ÿnûl_d–ayed_wÜk
(&
mcheck_wÜk
);

739 
	`Ú_—ch_ıu
(
mû_š™
, 
NULL
, 1, 1);

740 
Ãxt_š‹rv®
 = 
check_š‹rv®
 * 
HZ
;

741 ià(
Ãxt_š‹rv®
)

742 
	`scheduË_d–ayed_wÜk
(&
mcheck_wÜk
,

743 
	`round_jiff›s_»Ïtive
(
Ãxt_š‹rv®
));

744 
	}
}

746 
sysdev_şass
 
	gmû_sysşass
 = {

747 .
»sume
 = 
mû_»sume
,

748 
£t_k£t_Çme
("machinecheck"),

751 
DEFINE_PER_CPU
(
sys_deviû
, 
deviû_mû
);

754 
	#ACCESSOR
(
Çme
, 
v¬
, 
¡¬t
) \

755 
ssize_t
 
show_
 ## 
	`Çme
(
sys_deviû
 *
s
, *
buf
) { \

756  
	`¥rštf
(
buf
, "%lx\n", ()
v¬
); \

758 
ssize_t
 
£t_
 ## 
	`Çme
(
sys_deviû
 *
s
,cÚ¡ *
buf
,
size_t
 
siz
) { \

759 *
’d
; \

760 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0); \

761 ià(
’d
 =ğ
buf
è -
EINVAL
; \

762 
v¬
 = 
Ãw
; \

763 
¡¬t
; \

764  
’d
-
buf
; \

766 
	`SYSDEV_ATTR
(
Çme
, 0644, 
show_
 ##‚ame, 
£t_
 ##‚ame);

	)

769 
ACCESSOR
(
bªk0ùl
,
bªk
[0],
	$mû_»¡¬t
())

770 
	`ACCESSOR
(
bªk1ùl
,
bªk
[1],
	$mû_»¡¬t
())

771 
	`ACCESSOR
(
bªk2ùl
,
bªk
[2],
	$mû_»¡¬t
())

772 
	`ACCESSOR
(
bªk3ùl
,
bªk
[3],
	$mû_»¡¬t
())

773 
	`ACCESSOR
(
bªk4ùl
,
bªk
[4],
	$mû_»¡¬t
())

774 
	`ACCESSOR
(
bªk5ùl
,
bªk
[5],
	$mû_»¡¬t
())

776 
ssize_t
 
	$show_Œigg”
(
sys_deviû
 *
s
, *
buf
)

778 
	`¡rıy
(
buf
, 
Œigg”
);

779 
	`¡rÿt
(
buf
, "\n");

780  
	`¡¾’
(
Œigg”
) + 1;

781 
	}
}

783 
ssize_t
 
	$£t_Œigg”
(
sys_deviû
 *
s
,cÚ¡ *
buf
,
size_t
 
siz
)

785 *
p
;

786 
Ën
;

787 
	`¡ºıy
(
Œigg”
, 
buf
, (trigger));

788 
Œigg”
[(trigger)-1] = 0;

789 
Ën
 = 
	`¡¾’
(
Œigg”
);

790 
p
 = 
	`¡rchr
(
Œigg”
, '\n');

791 ià(*
p
) *p = 0;

792  
Ën
;

793 
	}
}

795 
SYSDEV_ATTR
(
Œigg”
, 0644, 
show_Œigg”
, 
£t_Œigg”
);

796 
	$ACCESSOR
(
tŞ”ªt
,tolerant,)

797 
	`ACCESSOR
(
check_š‹rv®
,check_š‹rv®,
	$mû_»¡¬t
())

798 
sysdev_©Œibu‹
 *
mû_©Œibu‹s
[] = {

799 &
©Œ_bªk0ùl
, &
©Œ_bªk1ùl
, &
©Œ_bªk2ùl
,

800 &
©Œ_bªk3ùl
, &
©Œ_bªk4ùl
, &
©Œ_bªk5ùl
,

801 &
©Œ_tŞ”ªt
, &
©Œ_check_š‹rv®
, &
©Œ_Œigg”
,

802 
NULL


803 
	}
};

805 
ıumask_t
 
	gmû_deviû_š™Ÿlized
 = 
CPU_MASK_NONE
;

808 
__ıuš™
 
	$mû_ü—‹_deviû
(
ıu
)

810 
”r
;

811 
i
;

813 ià(!
	`mû_avaabË
(&
boÙ_ıu_d©a
))

814  -
EIO
;

816 
	`mem£t
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
, 0, (
kobjeù
));

817 
	`³r_ıu
(
deviû_mû
,
ıu
).
id
 = cpu;

818 
	`³r_ıu
(
deviû_mû
,
ıu
).
şs
 = &
mû_sysşass
;

820 
”r
 = 
	`sysdev_»gi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

821 ià(
”r
)

822  
”r
;

824 
i
 = 0; 
mû_©Œibu‹s
[i]; i++) {

825 
”r
 = 
	`sysdev_ü—‹_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

826 
mû_©Œibu‹s
[
i
]);

827 ià(
”r
)

828 
”rÜ
;

830 
	`ıu_£t
(
ıu
, 
mû_deviû_š™Ÿlized
);

833 
”rÜ
:

834 
i
--) {

835 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

836 
mû_©Œibu‹s
[
i
]);

838 
	`sysdev_uÄegi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

840  
”r
;

841 
	}
}

843 
	$mû_»move_deviû
(
ıu
)

845 
i
;

847 ià(!
	`ıu_is£t
(
ıu
, 
mû_deviû_š™Ÿlized
))

850 
i
 = 0; 
mû_©Œibu‹s
[i]; i++)

851 
	`sysdev_»move_fe
(&
	`³r_ıu
(
deviû_mû
,
ıu
),

852 
mû_©Œibu‹s
[
i
]);

853 
	`sysdev_uÄegi¡”
(&
	`³r_ıu
(
deviû_mû
,
ıu
));

854 
	`ıu_ş—r
(
ıu
, 
mû_deviû_š™Ÿlized
);

855 
	}
}

859 
	$mû_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

861 
ıu
 = ()
hıu
;

863 
aùiÚ
) {

864 
CPU_ONLINE
:

865 
CPU_ONLINE_FROZEN
:

866 
	`mû_ü—‹_deviû
(
ıu
);

868 
CPU_DEAD
:

869 
CPU_DEAD_FROZEN
:

870 
	`mû_»move_deviû
(
ıu
);

873  
NOTIFY_OK
;

874 
	}
}

876 
nÙif›r_block
 
	gmû_ıu_nÙif›r
 = {

877 .
nÙif›r_ÿÎ
 = 
mû_ıu_ÿÎback
,

880 
__š™
 
	$mû_š™_deviû
()

882 
”r
;

883 
i
 = 0;

885 ià(!
	`mû_avaabË
(&
boÙ_ıu_d©a
))

886  -
EIO
;

887 
”r
 = 
	`sysdev_şass_»gi¡”
(&
mû_sysşass
);

888 ià(
”r
)

889  
”r
;

891 
	`fÜ_—ch_Úlše_ıu
(
i
) {

892 
”r
 = 
	`mû_ü—‹_deviû
(
i
);

893 ià(
”r
)

894  
”r
;

897 
	`»gi¡”_hÙıu_nÙif›r
(&
mû_ıu_nÙif›r
);

898 
	`misc_»gi¡”
(&
mû_log_deviû
);

899  
”r
;

900 
	}
}

902 
deviû_š™ÿÎ
(
mû_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd_64.c

17 
	~<lšux/ıu.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/š‹¼u±.h
>

21 
	~<lšux/kobjeù.h
>

22 
	~<lšux/nÙif›r.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/smp.h
>

25 
	~<lšux/sysdev.h
>

26 
	~<lšux/sysfs.h
>

27 
	~<asm/­ic.h
>

28 
	~<asm/mû.h
>

29 
	~<asm/m¤.h
>

30 
	~<asm/³rıu.h
>

31 
	~<asm/idË.h
>

33 
	#PFX
 "mû_th»shŞd: "

	)

34 
	#VERSION
 "v”siÚ 1.1.1"

	)

35 
	#NR_BANKS
 6

	)

36 
	#NR_BLOCKS
 9

	)

37 
	#THRESHOLD_MAX
 0xFFF

	)

38 
	#INT_TYPE_APIC
 0x00020000

	)

39 
	#MASK_VALID_HI
 0x80000000

	)

40 
	#MASK_CNTP_HI
 0x40000000

	)

41 
	#MASK_LOCKED_HI
 0x20000000

	)

42 
	#MASK_LVTOFF_HI
 0x00F00000

	)

43 
	#MASK_COUNT_EN_HI
 0x00080000

	)

44 
	#MASK_INT_TYPE_HI
 0x00060000

	)

45 
	#MASK_OVERFLOW_HI
 0x00010000

	)

46 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

47 
	#MASK_BLKPTR_LO
 0xFF000000

	)

48 
	#MCG_XBLK_ADDR
 0xC0000400

	)

50 
	sth»shŞd_block
 {

51 
	mblock
;

52 
	mbªk
;

53 
	mıu
;

54 
u32
 
	madd»ss
;

55 
u16
 
	mš‹¼u±_’abË
;

56 
u16
 
	mth»shŞd_lim™
;

57 
kobjeù
 
	mkobj
;

58 
li¡_h—d
 
	mmiscj
;

62 
th»shŞd_block
 
	gth»shŞd_deçuÉs
 = {

63 .
š‹¼u±_’abË
 = 0,

64 .
	gth»shŞd_lim™
 = 
THRESHOLD_MAX
,

67 
	sth»shŞd_bªk
 {

68 
kobjeù
 
	mkobj
;

69 
th»shŞd_block
 *
	mblocks
;

70 
ıumask_t
 
	mıus
;

72 
DEFINE_PER_CPU
(
th»shŞd_bªk
 *, 
th»shŞd_bªks
[
NR_BANKS
]);

74 #ifdeà
CONFIG_SMP


75 
	gsh¬ed_bªk
[
NR_BANKS
] = {

80 
DEFINE_PER_CPU
(, 
bªk_m­
);

87 
	$th»shŞd_»¡¬t_bªk
(
th»shŞd_block
 *
b
,

88 
»£t
, 
u16
 
Şd_lim™
)

90 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

92 
	`rdm¤
(
b
->
add»ss
, 
mci_misc_lo
, 
mci_misc_hi
);

94 ià(
b
->
th»shŞd_lim™
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

95 
»£t
 = 1;

97 ià(
»£t
) {

98 
mci_misc_hi
 =

99 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

100 (
THRESHOLD_MAX
 - 
b
->
th»shŞd_lim™
);

101 } ià(
Şd_lim™
) {

102 
Ãw_couÁ
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

103 (
Şd_lim™
 - 
b
->
th»shŞd_lim™
);

104 
mci_misc_hi
 = (mci_misc_h˜& ~
MASK_ERR_COUNT_HI
) |

105 (
Ãw_couÁ
 & 
THRESHOLD_MAX
);

108 
b
->
š‹¼u±_’abË
 ?

109 (
mci_misc_hi
 = (mci_misc_h˜& ~
MASK_INT_TYPE_HI
è| 
INT_TYPE_APIC
) :

110 (
mci_misc_hi
 &ğ~
MASK_INT_TYPE_HI
);

112 
mci_misc_hi
 |ğ
MASK_COUNT_EN_HI
;

113 
	`wrm¤
(
b
->
add»ss
, 
mci_misc_lo
, 
mci_misc_hi
);

114 
	}
}

117 
__ıuš™
 
	$mû_amd_ã©u»_š™
(
ıušfo_x86
 *
c
)

119 
bªk
, 
block
;

120 
ıu
 = 
	`smp_´oûssÜ_id
();

121 
u32
 
low
 = 0, 
high
 = 0, 
add»ss
 = 0;

123 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

124 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

125 ià(
block
 == 0)

126 
add»ss
 = 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4;

127 ià(
block
 == 1) {

128 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

129 ià(!
add»ss
)

131 
add»ss
 +ğ
MCG_XBLK_ADDR
;

134 ++
add»ss
;

136 ià(
	`rdm¤_§ã
(
add»ss
, &
low
, &
high
))

139 ià(!(
high
 & 
MASK_VALID_HI
)) {

140 ià(
block
)

146 ià(!(
high
 & 
MASK_CNTP_HI
) ||

147 (
high
 & 
MASK_LOCKED_HI
))

150 ià(!
block
)

151 
	`³r_ıu
(
bªk_m­
, 
ıu
è|ğ(1 << 
bªk
);

152 #ifdeà
CONFIG_SMP


153 ià(
sh¬ed_bªk
[
bªk
] && 
c
->
ıu_cÜe_id
)

156 
high
 &ğ~
MASK_LVTOFF_HI
;

157 
high
 |ğ
K8_APIC_EXT_LVT_ENTRY_THRESHOLD
 << 20;

158 
	`wrm¤
(
add»ss
, 
low
, 
high
);

160 
	`£tup_APIC_ex‹nded_lvt
(
K8_APIC_EXT_LVT_ENTRY_THRESHOLD
,

161 
THRESHOLD_APIC_VECTOR
,

162 
K8_APIC_EXT_INT_MSG_FIX
, 0);

164 
th»shŞd_deçuÉs
.
add»ss
 =‡ddress;

165 
	`th»shŞd_»¡¬t_bªk
(&
th»shŞd_deçuÉs
, 0, 0);

168 
	}
}

179 
asmlškage
 
	$mû_th»shŞd_š‹¼u±
()

181 
bªk
, 
block
;

182 
mû
 
m
;

183 
u32
 
low
 = 0, 
high
 = 0, 
add»ss
 = 0;

185 
	`ack_APIC_œq
();

186 
	`ex™_idË
();

187 
	`œq_’‹r
();

189 
	`mem£t
(&
m
, 0, (m));

190 
	`rdtsşl
(
m
.
tsc
);

191 
m
.
ıu
 = 
	`smp_´oûssÜ_id
();

194 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

195 ià(!(
	`³r_ıu
(
bªk_m­
, 
m
.
ıu
è& (1 << 
bªk
)))

197 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

198 ià(
block
 == 0)

199 
add»ss
 = 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4;

200 ià(
block
 == 1) {

201 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

202 ià(!
add»ss
)

204 
add»ss
 +ğ
MCG_XBLK_ADDR
;

207 ++
add»ss
;

209 ià(
	`rdm¤_§ã
(
add»ss
, &
low
, &
high
))

212 ià(!(
high
 & 
MASK_VALID_HI
)) {

213 ià(
block
)

219 ià(!(
high
 & 
MASK_CNTP_HI
) ||

220 (
high
 & 
MASK_LOCKED_HI
))

225 
	`do_machše_check
(
NULL
, 0);

227 ià(
high
 & 
MASK_OVERFLOW_HI
) {

228 
	`rdm¤l
(
add»ss
, 
m
.
misc
);

229 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
 + 
bªk
 * 4,

230 
m
.
¡©us
);

231 
m
.
bªk
 = 
K8_MCE_THRESHOLD_BASE


232 + 
bªk
 * 
NR_BLOCKS


233 + 
block
;

234 
	`mû_log
(&
m
);

235 
out
;

239 
out
:

240 
	`add_pda
(
œq_th»shŞd_couÁ
, 1);

241 
	`œq_ex™
();

242 
	}
}

248 
	sth»shŞd_©Œ
 {

249 
©Œibu‹
 
	m©Œ
;

250 
ssize_t
(*
show
è(
	mth»shŞd_block
 *, *);

251 
ssize_t
(*
¡Üe
è(
	mth»shŞd_block
 *, cÚ¡ *, 
size_t
 
	mcouÁ
);

254 
ıumask_t
 
	$affš™y_£t
(
ıu
)

256 
ıumask_t
 
Şdmask
 = 
cu¼’t
->
ıus_®lowed
;

257 
ıumask_t
 
Ãwmask
 = 
CPU_MASK_NONE
;

258 
	`ıu_£t
(
ıu
, 
Ãwmask
);

259 
	`£t_ıus_®lowed
(
cu¼’t
, 
Ãwmask
);

260  
Şdmask
;

261 
	}
}

263 
	$affš™y_»¡Üe
(
ıumask_t
 
Şdmask
)

265 
	`£t_ıus_®lowed
(
cu¼’t
, 
Şdmask
);

266 
	}
}

268 
	#SHOW_FIELDS
(
Çme
) \

269 
ssize_t
 
show_
 ## 
	`Çme
(
th»shŞd_block
 * 
b
, *
buf
) \

271  
	`¥rštf
(
buf
, "%lx\n", (è
b
->
Çme
); \

272 }

	)

273 
	$SHOW_FIELDS
(
š‹¼u±_’abË
)

274 
	$SHOW_FIELDS
(
th»shŞd_lim™
)

276 
ssize_t
 
	$¡Üe_š‹¼u±_’abË
(
th»shŞd_block
 *
b
,

277 cÚ¡ *
buf
, 
size_t
 
couÁ
)

279 *
’d
;

280 
ıumask_t
 
Şdmask
;

281 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0);

282 ià(
’d
 =ğ
buf
)

283  -
EINVAL
;

284 
b
->
š‹¼u±_’abË
 = !!
Ãw
;

286 
Şdmask
 = 
	`affš™y_£t
(
b
->
ıu
);

287 
	`th»shŞd_»¡¬t_bªk
(
b
, 0, 0);

288 
	`affš™y_»¡Üe
(
Şdmask
);

290  
’d
 - 
buf
;

291 
	}
}

293 
ssize_t
 
	$¡Üe_th»shŞd_lim™
(
th»shŞd_block
 *
b
,

294 cÚ¡ *
buf
, 
size_t
 
couÁ
)

296 *
’d
;

297 
ıumask_t
 
Şdmask
;

298 
u16
 
Şd
;

299 
Ãw
 = 
	`sim¶e_¡¹oul
(
buf
, &
’d
, 0);

300 ià(
’d
 =ğ
buf
)

301  -
EINVAL
;

302 ià(
Ãw
 > 
THRESHOLD_MAX
)

303 
Ãw
 = 
THRESHOLD_MAX
;

304 ià(
Ãw
 < 1)

305 
Ãw
 = 1;

306 
Şd
 = 
b
->
th»shŞd_lim™
;

307 
b
->
th»shŞd_lim™
 = 
Ãw
;

309 
Şdmask
 = 
	`affš™y_£t
(
b
->
ıu
);

310 
	`th»shŞd_»¡¬t_bªk
(
b
, 0, 
Şd
);

311 
	`affš™y_»¡Üe
(
Şdmask
);

313  
’d
 - 
buf
;

314 
	}
}

316 
ssize_t
 
	$show_”rÜ_couÁ
(
th»shŞd_block
 *
b
, *
buf
)

318 
u32
 
high
, 
low
;

319 
ıumask_t
 
Şdmask
;

320 
Şdmask
 = 
	`affš™y_£t
(
b
->
ıu
);

321 
	`rdm¤
(
b
->
add»ss
, 
low
, 
high
);

322 
	`affš™y_»¡Üe
(
Şdmask
);

323  
	`¥rštf
(
buf
, "%x\n",

324 (
high
 & 0xFFFè- (
THRESHOLD_MAX
 - 
b
->
th»shŞd_lim™
));

325 
	}
}

327 
ssize_t
 
	$¡Üe_”rÜ_couÁ
(
th»shŞd_block
 *
b
,

328 cÚ¡ *
buf
, 
size_t
 
couÁ
)

330 
ıumask_t
 
Şdmask
;

331 
Şdmask
 = 
	`affš™y_£t
(
b
->
ıu
);

332 
	`th»shŞd_»¡¬t_bªk
(
b
, 1, 0);

333 
	`affš™y_»¡Üe
(
Şdmask
);

335 
	}
}

337 
	#THRESHOLD_ATTR
(
_Çme
,
_mode
,
_show
,
_¡Üe
) { \

338 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

339 .
show
 = 
_show
, \

340 .
¡Üe
 = 
_¡Üe
, \

341 };

	)

343 
	#RW_ATTR
(
Çme
) \

344 
th»shŞd_©Œ
 
Çme
 = \

345 
	`THRESHOLD_ATTR
(
Çme
, 0644, 
show_
##‚ame, 
¡Üe_
##‚ame)

	)

347 
RW_ATTR
(
š‹¼u±_’abË
);

348 
RW_ATTR
(
th»shŞd_lim™
);

349 
RW_ATTR
(
”rÜ_couÁ
);

351 
©Œibu‹
 *
	gdeçuÉ_©Œs
[] = {

352 &
š‹¼u±_’abË
.
©Œ
,

353 &
th»shŞd_lim™
.
©Œ
,

354 &
”rÜ_couÁ
.
©Œ
,

355 
NULL


358 
	#to_block
(
k
è
	`cÚš”_of
(k, 
th»shŞd_block
, 
kobj
)

	)

359 
	#to_©Œ
(
a
è
	`cÚš”_of
×, 
th»shŞd_©Œ
, 
©Œ
)

	)

361 
ssize_t
 
	$show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

363 
th»shŞd_block
 *
b
 = 
	`to_block
(
kobj
);

364 
th»shŞd_©Œ
 *
a
 = 
	`to_©Œ
(
©Œ
);

365 
ssize_t
 
»t
;

366 
»t
 = 
a
->
show
 ?‡->
	`show
(
b
, 
buf
è: -
EIO
;

367  
»t
;

368 
	}
}

370 
ssize_t
 
	$¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

371 cÚ¡ *
buf
, 
size_t
 
couÁ
)

373 
th»shŞd_block
 *
b
 = 
	`to_block
(
kobj
);

374 
th»shŞd_©Œ
 *
a
 = 
	`to_©Œ
(
©Œ
);

375 
ssize_t
 
»t
;

376 
»t
 = 
a
->
¡Üe
 ?‡->
	`¡Üe
(
b
, 
buf
, 
couÁ
è: -
EIO
;

377  
»t
;

378 
	}
}

380 
sysfs_İs
 
	gth»shŞd_İs
 = {

381 .
show
 = show,

382 .
	g¡Üe
 = 
¡Üe
,

385 
kobj_ty³
 
	gth»shŞd_kty³
 = {

386 .
sysfs_İs
 = &
th»shŞd_İs
,

387 .
	gdeçuÉ_©Œs
 = 
deçuÉ_©Œs
,

390 
__ıuš™
 
	$®loÿ‹_th»shŞd_blocks
(
ıu
,

391 
bªk
,

392 
block
,

393 
u32
 
add»ss
)

395 
”r
;

396 
u32
 
low
, 
high
;

397 
th»shŞd_block
 *
b
 = 
NULL
;

399 ià((
bªk
 >ğ
NR_BANKS
è|| (
block
 >ğ
NR_BLOCKS
))

402 ià(
	`rdm¤_§ã
(
add»ss
, &
low
, &
high
))

405 ià(!(
high
 & 
MASK_VALID_HI
)) {

406 ià(
block
)

407 
»cur£
;

412 ià(!(
high
 & 
MASK_CNTP_HI
) ||

413 (
high
 & 
MASK_LOCKED_HI
))

414 
»cur£
;

416 
b
 = 
	`kz®loc
((
th»shŞd_block
), 
GFP_KERNEL
);

417 ià(!
b
)

418  -
ENOMEM
;

420 
b
->
block
 = block;

421 
b
->
bªk
 = bank;

422 
b
->
ıu
 = cpu;

423 
b
->
add»ss
 =‡ddress;

424 
b
->
š‹¼u±_’abË
 = 0;

425 
b
->
th»shŞd_lim™
 = 
THRESHOLD_MAX
;

427 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

429 ià(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
)

430 
	`li¡_add
(&
b
->
miscj
,

431 &
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
->
miscj
);

433 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
 = 
b
;

435 
	`kobjeù_£t_Çme
(&
b
->
kobj
, "misc%i", 
block
);

436 
b
->
kobj
.
·»Á
 = &
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->kobj;

437 
b
->
kobj
.
kty³
 = &
th»shŞd_kty³
;

438 
”r
 = 
	`kobjeù_»gi¡”
(&
b
->
kobj
);

439 ià(
”r
)

440 
out_ä“
;

441 
»cur£
:

442 ià(!
block
) {

443 
add»ss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

444 ià(!
add»ss
)

446 
add»ss
 +ğ
MCG_XBLK_ADDR
;

448 ++
add»ss
;

450 
”r
 = 
	`®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
, ++
block
, 
add»ss
);

451 ià(
”r
)

452 
out_ä“
;

454  
”r
;

456 
out_ä“
:

457 ià(
b
) {

458 
	`kobjeù_uÄegi¡”
(&
b
->
kobj
);

459 
	`kä“
(
b
);

461  
”r
;

462 
	}
}

465 
__ıuš™
 
	$th»shŞd_ü—‹_bªk
(
ıu
, 
bªk
)

467 
i
, 
”r
 = 0;

468 
th»shŞd_bªk
 *
b
 = 
NULL
;

469 
ıumask_t
 
Şdmask
 = 
CPU_MASK_NONE
;

470 
Çme
[32];

472 
	`¥rštf
(
Çme
, "th»shŞd_bªk%i", 
bªk
);

474 #ifdeà
CONFIG_SMP


475 ià(
	`ıu_d©a
(
ıu
).
ıu_cÜe_id
 && 
sh¬ed_bªk
[
bªk
]) {

476 
i
 = 
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

479 ià(
	`ıu_d©a
(
i
).
ıu_cÜe_id
)

480 
out
;

483 ià(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
])

484 
out
;

486 
b
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
];

488 ià(!
b
)

489 
out
;

491 
”r
 = 
	`sysfs_ü—‹_lšk
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
,

492 &
b
->
kobj
, 
Çme
);

493 ià(
”r
)

494 
out
;

496 
b
->
ıus
 = 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
);

497 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
b
;

498 
out
;

502 
b
 = 
	`kz®loc
((
th»shŞd_bªk
), 
GFP_KERNEL
);

503 ià(!
b
) {

504 
”r
 = -
ENOMEM
;

505 
out
;

508 
	`kobjeù_£t_Çme
(&
b
->
kobj
, "th»shŞd_bªk%i", 
bªk
);

509 
b
->
kobj
.
·»Á
 = &
	`³r_ıu
(
deviû_mû
, 
ıu
).kobj;

510 #iâdeà
CONFIG_SMP


511 
b
->
ıus
 = 
CPU_MASK_ALL
;

513 
b
->
ıus
 = 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
);

515 
”r
 = 
	`kobjeù_»gi¡”
(&
b
->
kobj
);

516 ià(
”r
)

517 
out_ä“
;

519 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
b
;

521 
Şdmask
 = 
	`affš™y_£t
(
ıu
);

522 
”r
 = 
	`®loÿ‹_th»shŞd_blocks
(
ıu
, 
bªk
, 0,

523 
MSR_IA32_MC0_MISC
 + 
bªk
 * 4);

524 
	`affš™y_»¡Üe
(
Şdmask
);

526 ià(
”r
)

527 
out_ä“
;

529 
	`fÜ_—ch_ıu_mask
(
i
, 
b
->
ıus
) {

530 ià(
i
 =ğ
ıu
)

533 
”r
 = 
	`sysfs_ü—‹_lšk
(&
	`³r_ıu
(
deviû_mû
, 
i
).
kobj
,

534 &
b
->
kobj
, 
Çme
);

535 ià(
”r
)

536 
out
;

538 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
] = 
b
;

541 
out
;

543 
out_ä“
:

544 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

545 
	`kä“
(
b
);

546 
out
:

547  
”r
;

548 
	}
}

551 
__ıuš™
 
	$th»shŞd_ü—‹_deviû
(
ıu
)

553 
bªk
;

554 
”r
 = 0;

556 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

557 ià(!(
	`³r_ıu
(
bªk_m­
, 
ıu
è& 1 << 
bªk
))

559 
”r
 = 
	`th»shŞd_ü—‹_bªk
(
ıu
, 
bªk
);

560 ià(
”r
)

561 
out
;

563 
out
:

564  
”r
;

565 
	}
}

573 
	$d—Îoÿ‹_th»shŞd_block
(
ıu
,

574 
bªk
)

576 
th»shŞd_block
 *
pos
 = 
NULL
;

577 
th»shŞd_block
 *
tmp
 = 
NULL
;

578 
th»shŞd_bªk
 *
h—d
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
];

580 ià(!
h—d
)

583 
	`li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
tmp
, &
h—d
->
blocks
->
miscj
, miscj) {

584 
	`kobjeù_uÄegi¡”
(&
pos
->
kobj
);

585 
	`li¡_d–
(&
pos
->
miscj
);

586 
	`kä“
(
pos
);

589 
	`kä“
(
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
);

590 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
]->
blocks
 = 
NULL
;

591 
	}
}

593 
	$th»shŞd_»move_bªk
(
ıu
, 
bªk
)

595 
i
 = 0;

596 
th»shŞd_bªk
 *
b
;

597 
Çme
[32];

599 
b
 = 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
];

601 ià(!
b
)

604 ià(!
b
->
blocks
)

605 
ä“_out
;

607 
	`¥rštf
(
Çme
, "th»shŞd_bªk%i", 
bªk
);

609 #ifdeà
CONFIG_SMP


611 ià(
sh¬ed_bªk
[
bªk
] && 
b
->
blocks
->
ıu
 != cpu) {

612 
	`sysfs_»move_lšk
(&
	`³r_ıu
(
deviû_mû
, 
ıu
).
kobj
, 
Çme
);

613 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

619 
	`fÜ_—ch_ıu_mask
(
i
, 
b
->
ıus
) {

620 ià(
i
 =ğ
ıu
)

623 
	`sysfs_»move_lšk
(&
	`³r_ıu
(
deviû_mû
, 
i
).
kobj
, 
Çme
);

624 
	`³r_ıu
(
th»shŞd_bªks
, 
i
)[
bªk
] = 
NULL
;

627 
	`d—Îoÿ‹_th»shŞd_block
(
ıu
, 
bªk
);

629 
ä“_out
:

630 
	`kobjeù_uÄegi¡”
(&
b
->
kobj
);

631 
	`kä“
(
b
);

632 
	`³r_ıu
(
th»shŞd_bªks
, 
ıu
)[
bªk
] = 
NULL
;

633 
	}
}

635 
	$th»shŞd_»move_deviû
(
ıu
)

637 
bªk
;

639 
bªk
 = 0; bªk < 
NR_BANKS
; ++bank) {

640 ià(!(
	`³r_ıu
(
bªk_m­
, 
ıu
è& 1 << 
bªk
))

642 
	`th»shŞd_»move_bªk
(
ıu
, 
bªk
);

644 
	}
}

647 
	$th»shŞd_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

648 
aùiÚ
, *
hıu
)

651 
ıu
 = ()
hıu
;

653 ià(
ıu
 >ğ
NR_CPUS
)

654 
out
;

656 
aùiÚ
) {

657 
CPU_ONLINE
:

658 
CPU_ONLINE_FROZEN
:

659 
	`th»shŞd_ü—‹_deviû
(
ıu
);

661 
CPU_DEAD
:

662 
CPU_DEAD_FROZEN
:

663 
	`th»shŞd_»move_deviû
(
ıu
);

668 
out
:

669  
NOTIFY_OK
;

670 
	}
}

672 
nÙif›r_block
 
	gth»shŞd_ıu_nÙif›r
 = {

673 .
nÙif›r_ÿÎ
 = 
th»shŞd_ıu_ÿÎback
,

676 
__š™
 
	$th»shŞd_š™_deviû
()

678 
lıu
 = 0;

681 
	`fÜ_—ch_Úlše_ıu
(
lıu
) {

682 
”r
 = 
	`th»shŞd_ü—‹_deviû
(
lıu
);

683 ià(
”r
)

684  
”r
;

686 
	`»gi¡”_hÙıu_nÙif›r
(&
th»shŞd_ıu_nÙif›r
);

688 
	}
}

690 
deviû_š™ÿÎ
(
th»shŞd_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel_64.c

6 
	~<lšux/š™.h
>

7 
	~<lšux/š‹¼u±.h
>

8 
	~<lšux/³rıu.h
>

9 
	~<asm/´oûssÜ.h
>

10 
	~<asm/m¤.h
>

11 
	~<asm/mû.h
>

12 
	~<asm/hw_œq.h
>

13 
	~<asm/idË.h
>

14 
	~<asm/th”m_thrÙ.h
>

16 
asmlškage
 
	$smp_th”m®_š‹¼u±
()

18 
__u64
 
m¤_v®
;

20 
	`ack_APIC_œq
();

22 
	`ex™_idË
();

23 
	`œq_’‹r
();

25 
	`rdm¤l
(
MSR_IA32_THERM_STATUS
, 
m¤_v®
);

26 ià(
	`th”m_thrÙ_´oûss
(
m¤_v®
 & 1))

27 
	`mû_log_th”m_thrÙ_ev’t
(
	`smp_´oûssÜ_id
(), 
m¤_v®
);

29 
	`add_pda
(
œq_th”m®_couÁ
, 1);

30 
	`œq_ex™
();

31 
	}
}

33 
__ıuš™
 
	$š‹l_š™_th”m®
(
ıušfo_x86
 *
c
)

35 
u32
 
l
, 
h
;

36 
tm2
 = 0;

37 
ıu
 = 
	`smp_´oûssÜ_id
();

39 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACPI
))

42 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACC
))

49 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

50 
h
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

51 ià((
l
 & (1 << 3)è&& (
h
 & 
APIC_DM_SMI
)) {

52 
	`´štk
(
KERN_DEBUG


53 "CPU%d: Th”m® mÚ™Üšg hªdËd by SMI\n", 
ıu
);

57 ià(
	`ıu_has
(
c
, 
X86_FEATURE_TM2
è&& (
l
 & (1 << 13)))

58 
tm2
 = 1;

60 ià(
h
 & 
APIC_VECTOR_MASK
) {

61 
	`´štk
(
KERN_DEBUG


63 "š¡®Ëd\n", 
ıu
, (
h
 & 
APIC_VECTOR_MASK
));

67 
h
 = 
THERMAL_APIC_VECTOR
;

68 
h
 |ğ(
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
);

69 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
h
);

71 
	`rdm¤
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

72 
	`wrm¤
(
MSR_IA32_THERM_INTERRUPT
, 
l
 | 0x03, 
h
);

74 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

75 
	`wrm¤
(
MSR_IA32_MISC_ENABLE
, 
l
 | (1 << 3), 
h
);

77 
l
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

78 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

79 
	`´štk
(
KERN_INFO
 "CPU%d: Thermal monitoringƒnabled (%s)\n",

80 
ıu
, 
tm2
 ? "TM2" : "TM1");

83 
	`©omic_£t
(&
th”m_thrÙ_’
, 1);

85 
	}
}

87 
__ıuš™
 
	$mû_š‹l_ã©u»_š™
(
ıušfo_x86
 *
c
)

89 
	`š‹l_š™_th”m®
(
c
);

90 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

18 
	~<lšux/³rıu.h
>

19 
	~<lšux/sysdev.h
>

20 
	~<lšux/ıu.h
>

21 
	~<asm/ıu.h
>

22 
	~<lšux/nÙif›r.h
>

23 
	~<lšux/jiff›s.h
>

24 
	~<asm/th”m_thrÙ.h
>

27 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

29 
DEFINE_PER_CPU
(
__u64
, 
Ãxt_check
èğ
INITIAL_JIFFIES
;

30 
DEFINE_PER_CPU
(, 
th”m®_thrÙe_couÁ
);

31 
©omic_t
 
	gth”m_thrÙ_’
 = 
ATOMIC_INIT
(0);

33 #ifdeà
CONFIG_SYSFS


34 
	#defše_th”m_thrÙ_sysdev_Úe_ro
(
_Çme
) \

35 
	`SYSDEV_ATTR
(
_Çme
, 0444, 
th”m_thrÙ_sysdev_show_
##_Çme, 
NULL
)

	)

37 
	#defše_th”m_thrÙ_sysdev_show_func
(
Çme
) \

38 
ssize_t
 
th”m_thrÙ_sysdev_show_
##
	`Çme
(
sys_deviû
 *
dev
, \

39 *
buf
) \

41 
ıu
 = 
dev
->
id
; \

42 
ssize_t
 
»t
; \

44 
	`´“m±_di§bË
(); \

45 ià(
	`ıu_Úlše
(
ıu
)) \

46 
»t
 = 
	`¥rštf
(
buf
, "%lu\n", \

47 
	`³r_ıu
(
th”m®_thrÙe_
##
Çme
, 
ıu
)); \

49 
»t
 = 0; \

50 
	`´“m±_’abË
(); \

52  
»t
; \

53 }

	)

55 
defše_th”m_thrÙ_sysdev_show_func
(
couÁ
);

56 
defše_th”m_thrÙ_sysdev_Úe_ro
(
couÁ
);

58 
©Œibu‹
 *
	gth”m®_thrÙe_©Œs
[] = {

59 &
©Œ_couÁ
.
©Œ
,

60 
NULL


63 
©Œibu‹_group
 
	gth”m®_thrÙe_©Œ_group
 = {

64 .
©Œs
 = 
th”m®_thrÙe_©Œs
,

65 .
	gÇme
 = "thermal_throttle"

85 
	$th”m_thrÙ_´oûss
(
cu¼
)

87 
ıu
 = 
	`smp_´oûssÜ_id
();

88 
__u64
 
tmp_jiffs
 = 
	`g‘_jiff›s_64
();

90 ià(
cu¼
)

91 
	`__g‘_ıu_v¬
(
th”m®_thrÙe_couÁ
)++;

93 ià(
	`time_befÜe64
(
tmp_jiffs
, 
	`__g‘_ıu_v¬
(
Ãxt_check
)))

96 
	`__g‘_ıu_v¬
(
Ãxt_check
èğ
tmp_jiffs
 + 
CHECK_INTERVAL
;

99 ià(
cu¼
) {

100 
	`´štk
(
KERN_CRIT
 "CPU%d: Temperature‡bovehreshold, "

101 "ıu clockhrÙed (tÙ®ƒv’t ğ%lu)\n", 
ıu
,

102 
	`__g‘_ıu_v¬
(
th”m®_thrÙe_couÁ
));

104 
	`add_št
(
TAINT_MACHINE_CHECK
);

106 
	`´štk
(
KERN_CRIT
 "CPU%d: Tem³¿tu»/¥“d‚Üm®\n", 
ıu
);

110 
	}
}

112 #ifdeà
CONFIG_SYSFS


114 
__ıuš™
 
	$th”m®_thrÙe_add_dev
(
sys_deviû
 *
sys_dev
)

116  
	`sysfs_ü—‹_group
(&
sys_dev
->
kobj
, &
th”m®_thrÙe_©Œ_group
);

117 
	}
}

119 
__ıuš™
 
	$th”m®_thrÙe_»move_dev
(
sys_deviû
 *
sys_dev
)

121  
	`sysfs_»move_group
(&
sys_dev
->
kobj
, &
th”m®_thrÙe_©Œ_group
);

122 
	}
}

125 
DEFINE_MUTEX
(
th”m_ıu_lock
);

128 
__ıuš™
 
	$th”m®_thrÙe_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

129 
aùiÚ
,

130 *
hıu
)

132 
ıu
 = ()
hıu
;

133 
sys_deviû
 *
sys_dev
;

134 
”r
 = 0;

136 
sys_dev
 = 
	`g‘_ıu_sysdev
(
ıu
);

137 
aùiÚ
) {

138 
CPU_UP_PREPARE
:

139 
CPU_UP_PREPARE_FROZEN
:

140 
	`mu‹x_lock
(&
th”m_ıu_lock
);

141 
”r
 = 
	`th”m®_thrÙe_add_dev
(
sys_dev
);

142 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

143 
	`WARN_ON
(
”r
);

145 
CPU_UP_CANCELED
:

146 
CPU_UP_CANCELED_FROZEN
:

147 
CPU_DEAD
:

148 
CPU_DEAD_FROZEN
:

149 
	`mu‹x_lock
(&
th”m_ıu_lock
);

150 
	`th”m®_thrÙe_»move_dev
(
sys_dev
);

151 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

154  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

155 
	}
}

157 
nÙif›r_block
 
th”m®_thrÙe_ıu_nÙif›r
 
	g__ıuš™d©a
 =

159 .
nÙif›r_ÿÎ
 = 
th”m®_thrÙe_ıu_ÿÎback
,

162 
__š™
 
	$th”m®_thrÙe_š™_deviû
()

164 
ıu
 = 0;

165 
”r
;

167 ià(!
	`©omic_»ad
(&
th”m_thrÙ_’
))

170 
	`»gi¡”_hÙıu_nÙif›r
(&
th”m®_thrÙe_ıu_nÙif›r
);

172 #ifdeà
CONFIG_HOTPLUG_CPU


173 
	`mu‹x_lock
(&
th”m_ıu_lock
);

176 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

177 
”r
 = 
	`th”m®_thrÙe_add_dev
(
	`g‘_ıu_sysdev
(
ıu
));

178 
	`WARN_ON
(
”r
);

180 #ifdeà
CONFIG_HOTPLUG_CPU


181 
	`mu‹x_uÆock
(&
th”m_ıu_lock
);

185 
	}
}

187 
deviû_š™ÿÎ
(
th”m®_thrÙe_š™_deviû
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

3 
	~<lšux/š™.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/mm.h
>

6 
	~<lšux/moduË.h
>

7 
	~<asm/io.h
>

8 
	~<asm/mŒr.h
>

9 
	~<asm/m¤.h
>

10 
	~<asm/sy¡em.h
>

11 
	~<asm/ıuã©u».h
>

12 
	~<asm/bæush.h
>

13 
	~"mŒr.h
"

15 
	smŒr_¡©e
 {

16 
mŒr_v¬_¿nge
 *
	mv¬_¿nges
;

17 
mŒr_ty³
 
	mfixed_¿nges
[
NUM_FIXED_RANGES
];

18 
	m’abËd
;

19 
	mhave_fixed
;

20 
mŒr_ty³
 
	mdef_ty³
;

23 
	sfixed_¿nge_block
 {

24 
	mba£_m¤
;

25 
	m¿nges
;

28 
fixed_¿nge_block
 
	gfixed_¿nge_blocks
[] = {

29 { 
MTRRfix64K_00000_MSR
, 1 },

30 { 
MTRRfix16K_80000_MSR
, 2 },

31 { 
MTRRfix4K_C0000_MSR
, 8 },

35 
	gsmp_chªges_mask
;

36 
mŒr_¡©e
 
	gmŒr_¡©e
 = {};

38 #undeà
MODULE_PARAM_PREFIX


39 
	#MODULE_PARAM_PREFIX
 "mŒr."

	)

41 
	gmŒr_show
;

42 
moduË_·¿m_Çmed
(
show
, 
mŒr_show
, 
boŞ
, 0);

46 
	$g‘_mŒr_v¬_¿nge
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

48 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

49 
	`rdm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask_lo
, vr->
mask_hi
);

50 
	}
}

53 
	$g‘_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

55 *
p
 = (*è
äs
;

56 
i
;

58 
	`rdm¤
(
MTRRfix64K_00000_MSR
, 
p
[0],…[1]);

60 
i
 = 0; i < 2; i++)

61 
	`rdm¤
(
MTRRfix16K_80000_MSR
 + 
i
, 
p
[2 + i * 2],…[3 + i * 2]);

62 
i
 = 0; i < 8; i++)

63 
	`rdm¤
(
MTRRfix4K_C0000_MSR
 + 
i
, 
p
[6 + i * 2],…[7 + i * 2]);

64 
	}
}

66 
	$mŒr_§ve_fixed_¿nges
(*
šfo
)

68 ià(
ıu_has_mŒr
)

69 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

70 
	}
}

72 
	$´št_fixed
(
ba£
, 
¡•
, cÚ¡ 
mŒr_ty³
*
ty³s
)

74 
i
;

76 
i
 = 0; i < 8; ++i, ++
ty³s
, 
ba£
 +ğ
¡•
)

77 
	`´štk
(
KERN_INFO
 "MTRR %05X-%05X %s\n",

78 
ba£
, ba£ + 
¡•
 - 1, 
	`mŒr_©Œib_to_¡r
(*
ty³s
));

79 
	}
}

82 
__š™
 
	$g‘_mŒr_¡©e
()

84 
i
;

85 
mŒr_v¬_¿nge
 *
vrs
;

86 
lo
, 
dummy
;

88 ià(!
mŒr_¡©e
.
v¬_¿nges
) {

89 
mŒr_¡©e
.
v¬_¿nges
 = 
	`km®loc
(
num_v¬_¿nges
 *  (
mŒr_v¬_¿nge
),

90 
GFP_KERNEL
);

91 ià(!
mŒr_¡©e
.
v¬_¿nges
)

94 
vrs
 = 
mŒr_¡©e
.
v¬_¿nges
;

96 
	`rdm¤
(
MTRRÿp_MSR
, 
lo
, 
dummy
);

97 
mŒr_¡©e
.
have_fixed
 = (
lo
 >> 8) & 1;

99 
i
 = 0; i < 
num_v¬_¿nges
; i++)

100 
	`g‘_mŒr_v¬_¿nge
(
i
, &
vrs
[i]);

101 ià(
mŒr_¡©e
.
have_fixed
)

102 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

104 
	`rdm¤
(
MTRRdefTy³_MSR
, 
lo
, 
dummy
);

105 
mŒr_¡©e
.
def_ty³
 = (
lo
 & 0xff);

106 
mŒr_¡©e
.
’abËd
 = (
lo
 & 0xc00) >> 10;

108 ià(
mŒr_show
) {

109 
high_width
;

111 
	`´štk
(
KERN_INFO
 "MTRR deçuÉy³: %s\n", 
	`mŒr_©Œib_to_¡r
(
mŒr_¡©e
.
def_ty³
));

112 ià(
mŒr_¡©e
.
have_fixed
) {

113 
	`´štk
(
KERN_INFO
 "MTRR fixed„anges %sabled:\n",

114 
mŒr_¡©e
.
’abËd
 & 1 ? "en" : "dis");

115 
	`´št_fixed
(0x00000, 0x10000, 
mŒr_¡©e
.
fixed_¿nges
 + 0);

116 
i
 = 0; i < 2; ++i)

117 
	`´št_fixed
(0x80000 + 
i
 * 0x20000, 0x04000, 
mŒr_¡©e
.
fixed_¿nges
 + (i + 1) * 8);

118 
i
 = 0; i < 8; ++i)

119 
	`´št_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000, 
mŒr_¡©e
.
fixed_¿nges
 + (i + 3) * 8);

121 
	`´štk
(
KERN_INFO
 "MTRR variable„anges %sabled:\n",

122 
mŒr_¡©e
.
’abËd
 & 2 ? "en" : "dis");

123 
high_width
 = ((
size_Ü_mask
 ? 
	`ffs
(size_Ü_maskè- 1 : 32è- (32 - 
PAGE_SHIFT
) + 3) / 4;

124 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

125 ià(
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 & (1 << 11))

126 
	`´štk
(
KERN_INFO
 "MTRR %u base %0*X%05X000 mask %0*X%05X000 %s\n",

127 
i
,

128 
high_width
,

129 
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_hi
,

130 
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 >> 12,

131 
high_width
,

132 
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_hi
,

133 
mŒr_¡©e
.
v¬_¿nges
[
i
].
mask_lo
 >> 12,

134 
	`mŒr_©Œib_to_¡r
(
mŒr_¡©e
.
v¬_¿nges
[
i
].
ba£_lo
 & 0xff));

136 
	`´štk
(
KERN_INFO
 "MTRR %u di§bËd\n", 
i
);

139 
	}
}

142 
__š™
 
	$mŒr_¡©e_w¬n
()

144 
mask
 = 
smp_chªges_mask
;

146 ià(!
mask
)

148 ià(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

149 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent fixed MTRR settings\n");

150 ià(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

151 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent variable MTRR settings\n");

152 ià(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

153 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent MTRRdefType settings\n");

154 
	`´štk
(
KERN_INFO
 "mtrr:…robably your BIOS does‚ot setup‡ll CPUs.\n");

155 
	`´štk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

156 
	}
}

161 
	$mŒr_wrm¤
(
m¤
, 
a
, 
b
)

163 ià(
	`wrm¤_§ã
(
m¤
, 
a
, 
b
) < 0)

164 
	`´štk
(
KERN_ERR


166 
	`smp_´oûssÜ_id
(), 
m¤
, 
a
, 
b
);

167 
	}
}

173 
šlše
 
	$k8_’abË_fixed_iÜrs
()

175 
lo
, 
hi
;

177 
	`rdm¤
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

178 
	`mŒr_wrm¤
(
MSR_K8_SYSCFG
, 
lo


179 | 
K8_MTRRFIXRANGE_DRAM_ENABLE


180 | 
K8_MTRRFIXRANGE_DRAM_MODIFY
, 
hi
);

181 
	}
}

191 
	$£t_fixed_¿nge
(
m¤
, * 
chªged
, * 
m¤wÜds
)

193 
lo
, 
hi
;

195 
	`rdm¤
(
m¤
, 
lo
, 
hi
);

197 ià(
lo
 !ğ
m¤wÜds
[0] || 
hi
 != msrwords[1]) {

198 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 &&

199 
boÙ_ıu_d©a
.
x86
 == 15 &&

200 ((
m¤wÜds
[0] | m¤wÜds[1]è& 
K8_MTRR_RDMEM_WRMEM_MASK
))

201 
	`k8_’abË_fixed_iÜrs
();

202 
	`mŒr_wrm¤
(
m¤
, 
m¤wÜds
[0], msrwords[1]);

203 *
chªged
 = 
TRUE
;

205 
	}
}

207 
	$g’”ic_g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû_»g
)

214 
i
, 
max
;

215 
mŒr_ty³
 
Éy³
;

216 
lba£
, 
lsize
;

218 
max
 = 
num_v¬_¿nges
;

219 ià(
»¶aû_»g
 >ğ0 &&„•Ïû_»g < 
max
)

220  
»¶aû_»g
;

221 
i
 = 0; i < 
max
; ++i) {

222 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

223 ià(
lsize
 == 0)

224  
i
;

226  -
ENOSPC
;

227 
	}
}

229 
	$g’”ic_g‘_mŒr
(
»g
, *
ba£
,

230 *
size
, 
mŒr_ty³
 *
ty³
)

232 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

234 
	`rdm¤
(
	`MTRRphysMask_MSR
(
»g
), 
mask_lo
, 
mask_hi
);

235 ià((
mask_lo
 & 0x800) == 0) {

237 *
ba£
 = 0;

238 *
size
 = 0;

239 *
ty³
 = 0;

243 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
»g
), 
ba£_lo
, 
ba£_hi
);

246 
mask_lo
 = 
size_Ü_mask
 | 
mask_hi
 << (32 - 
PAGE_SHIFT
)

247 | 
mask_lo
 >> 
PAGE_SHIFT
;

251 *
size
 = -
mask_lo
;

252 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
è| 
ba£_lo
 >> PAGE_SHIFT;

253 *
ty³
 = 
ba£_lo
 & 0xff;

254 
	}
}

260 
	$£t_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

262 *
§ved
 = (*è
äs
;

263 
chªged
 = 
FALSE
;

264 
block
=-1, 
¿nge
;

266 
fixed_¿nge_blocks
[++
block
].
¿nges
)

267 
¿nge
=0;„ªg< 
fixed_¿nge_blocks
[
block
].
¿nges
;„ange++)

268 
	`£t_fixed_¿nge
(
fixed_¿nge_blocks
[
block
].
ba£_m¤
 + 
¿nge
,

269 &
chªged
, (*è
§ved
++);

271  
chªged
;

272 
	}
}

276 
	$£t_mŒr_v¬_¿nges
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

278 
lo
, 
hi
;

279 
chªged
 = 
FALSE
;

281 
	`rdm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
lo
, 
hi
);

282 ià((
vr
->
ba£_lo
 & 0xfffff0ffULè!ğ(
lo
 & 0xfffff0ffUL)

283 || (
vr
->
ba£_hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
))) !=

284 (
hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
)))) {

285 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

286 
chªged
 = 
TRUE
;

289 
	`rdm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
lo
, 
hi
);

291 ià((
vr
->
mask_lo
 & 0xfffff800ULè!ğ(
lo
 & 0xfffff800UL)

292 || (
vr
->
mask_hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
))) !=

293 (
hi
 & (
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
)))) {

294 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask_lo
, vr->
mask_hi
);

295 
chªged
 = 
TRUE
;

297  
chªged
;

298 
	}
}

300 
u32
 
	gdeáy³_lo
, 
	gdeáy³_hi
;

302 
	$£t_mŒr_¡©e
()

310 
i
;

311 
chªge_mask
 = 0;

313 
i
 = 0; i < 
num_v¬_¿nges
; i++)

314 ià(
	`£t_mŒr_v¬_¿nges
(
i
, &
mŒr_¡©e
.
v¬_¿nges
[i]))

315 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_VARIABLE
;

317 ià(
mŒr_¡©e
.
have_fixed
 && 
	`£t_fixed_¿nges
(mŒr_¡©e.
fixed_¿nges
))

318 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_FIXED
;

322 ià((
deáy³_lo
 & 0xffè!ğ
mŒr_¡©e
.
def_ty³


323 || ((
deáy³_lo
 & 0xc00è>> 10è!ğ
mŒr_¡©e
.
’abËd
) {

324 
deáy³_lo
 = (deáy³_lØ& ~0xcffè| 
mŒr_¡©e
.
def_ty³
 | (mŒr_¡©e.
’abËd
 << 10);

325 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_DEFTYPE
;

328  
chªge_mask
;

329 
	}
}

332 
	gü4
 = 0;

333 
DEFINE_SPINLOCK
(
£t_©omic™y_lock
);

342 
	$´•¬e_£t
(è
	$__acquœes
(
£t_©omic™y_lock
)

344 
ü0
;

350 
	`¥š_lock
(&
£t_©omic™y_lock
);

353 
ü0
 = 
	`»ad_ü0
() | 0x40000000;

354 
	`wr™e_ü0
(
ü0
);

355 
	`wbšvd
();

358 iàĞ
ıu_has_pge
 ) {

359 
ü4
 = 
	`»ad_ü4
();

360 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

364 
	`__æush_b
();

367 
	`rdm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
, 
deáy³_hi
);

370 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
 & ~0xcff, 
deáy³_hi
);

371 
	}
}

373 
	$po¡_£t
(è
	$__»Ëa£s
(
£t_©omic™y_lock
)

376 
	`__æush_b
();

379 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³_lo
, 
deáy³_hi
);

382 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

385 iàĞ
ıu_has_pge
 )

386 
	`wr™e_ü4
(
ü4
);

387 
	`¥š_uÆock
(&
£t_©omic™y_lock
);

388 
	}
}

390 
	$g’”ic_£t_®l
()

392 
mask
, 
couÁ
;

393 
æags
;

395 
	`loÿl_œq_§ve
(
æags
);

396 
	`´•¬e_£t
();

399 
mask
 = 
	`£t_mŒr_¡©e
();

401 
	`po¡_£t
();

402 
	`loÿl_œq_»¡Üe
(
æags
);

405 
couÁ
 = 0; couÁ <  
mask
 * 8; ++count) {

406 ià(
mask
 & 0x01)

407 
	`£t_b™
(
couÁ
, &
smp_chªges_mask
);

408 
mask
 >>= 1;

411 
	}
}

413 
	$g’”ic_£t_mŒr
(
»g
, 
ba£
,

414 
size
, 
mŒr_ty³
 
ty³
)

425 
æags
;

426 
mŒr_v¬_¿nge
 *
vr
;

428 
vr
 = &
mŒr_¡©e
.
v¬_¿nges
[
»g
];

430 
	`loÿl_œq_§ve
(
æags
);

431 
	`´•¬e_£t
();

433 ià(
size
 == 0) {

436 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 0, 0);

437 
	`mem£t
(
vr
, 0, (
mŒr_v¬_¿nge
));

439 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty³
;

440 
vr
->
ba£_hi
 = (
ba£
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

441 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

442 
vr
->
mask_hi
 = (-
size
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

444 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
»g
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

445 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 
vr
->
mask_lo
, vr->
mask_hi
);

448 
	`po¡_£t
();

449 
	`loÿl_œq_»¡Üe
(
æags
);

450 
	}
}

452 
	$g’”ic_v®id©e_add_·ge
(
ba£
, 
size
, 
ty³
)

454 
lba£
, 
Ï¡
;

458 ià(
	`is_ıu
(
INTEL
è&& 
boÙ_ıu_d©a
.
x86
 == 6 &&

459 
boÙ_ıu_d©a
.
x86_mod–
 == 1 &&

460 
boÙ_ıu_d©a
.
x86_mask
 <= 7) {

461 ià(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

462 
	`´štk
(
KERN_WARNING
 "mŒr: ba£(0x%lx000èi nÙ 4 MiB‡ligÃd\n", 
ba£
);

463  -
EINVAL
;

465 ià(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

466 (
ty³
 =ğ
MTRR_TYPE_WRCOMB


467 || 
ty³
 =ğ
MTRR_TYPE_WRBACK
)) {

468 
	`´štk
(
KERN_WARNING
 "mtrr: writable mtrr between 0x70000000‡nd 0x7003FFFF may hanghe CPU.\n");

469  -
EINVAL
;

475 
Ï¡
 = 
ba£
 + 
size
 - 1;

476 
lba£
 = 
ba£
; !Öba£ & 1è&& (
Ï¡
 & 1);

477 
lba£
 =†ba£ >> 1, 
Ï¡
 =†ast >> 1) ;

478 ià(
lba£
 !ğ
Ï¡
) {

479 
	`´štk
(
KERN_WARNING
 "mtrr: base(0x%lx000) is‚ot‡ligned on‡ size(0x%lx000) boundary\n",

480 
ba£
, 
size
);

481  -
EINVAL
;

484 
	}
}

487 
	$g’”ic_have_wrcomb
()

489 
cÚfig
, 
dummy
;

490 
	`rdm¤
(
MTRRÿp_MSR
, 
cÚfig
, 
dummy
);

491  (
cÚfig
 & (1 << 10));

492 
	}
}

494 
	$pos™ive_have_wrcomb
()

497 
	}
}

501 
mŒr_İs
 
	gg’”ic_mŒr_İs
 = {

502 .
u£_š‹l_if
 = 1,

503 .
	g£t_®l
 = 
g’”ic_£t_®l
,

504 .
	gg‘
 = 
g’”ic_g‘_mŒr
,

505 .
	gg‘_ä“_»giÚ
 = 
g’”ic_g‘_ä“_»giÚ
,

506 .
	g£t
 = 
g’”ic_£t_mŒr
,

507 .
	gv®id©e_add_·ge
 = 
g’”ic_v®id©e_add_·ge
,

508 .
	ghave_wrcomb
 = 
g’”ic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/´oc_fs.h
>

3 
	~<lšux/ÿ·b™y.h
>

4 
	~<lšux/ùy³.h
>

5 
	~<lšux/moduË.h
>

6 
	~<lšux/£q_fe.h
>

7 
	~<asm/uacûss.h
>

9 
	#LINE_SIZE
 80

	)

11 
	~<asm/mŒr.h
>

12 
	~"mŒr.h
"

15 *
u§ge_bË
;

18 
	#FILE_FCOUNT
(
f
è(((
£q_fe
 *)((f)->
´iv©e_d©a
))->
´iv©e
)

	)

20 cÚ¡ *cÚ¡ 
	gmŒr_¡ršgs
[
MTRR_NUM_TYPES
] =

31 cÚ¡ *
	$mŒr_©Œib_to_¡r
(
x
)

33  (
x
 <ğ6è? 
mŒr_¡ršgs
[x] : "?";

34 
	}
}

36 #ifdeà
CONFIG_PROC_FS


39 
	$mŒr_fe_add
(
ba£
, 
size
,

40 
ty³
, 
šüem’t
, 
fe
 *fe, 
·ge
)

42 
»g
, 
max
;

43 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

45 
max
 = 
num_v¬_¿nges
;

46 ià(
fcouÁ
 =ğ
NULL
) {

47 
fcouÁ
 = 
	`kz®loc
(
max
 *  *fcouÁ, 
GFP_KERNEL
);

48 ià(!
fcouÁ
)

49  -
ENOMEM
;

50 
	`FILE_FCOUNT
(
fe
èğ
fcouÁ
;

52 ià(!
·ge
) {

53 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1)))

54  -
EINVAL
;

55 
ba£
 >>ğ
PAGE_SHIFT
;

56 
size
 >>ğ
PAGE_SHIFT
;

58 
»g
 = 
	`mŒr_add_·ge
(
ba£
, 
size
, 
ty³
, 1);

59 ià(
»g
 >= 0)

60 ++
fcouÁ
[
»g
];

61  
»g
;

62 
	}
}

65 
	$mŒr_fe_d–
(
ba£
, 
size
,

66 
fe
 *fe, 
·ge
)

68 
»g
;

69 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

71 ià(!
·ge
) {

72 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1)))

73  -
EINVAL
;

74 
ba£
 >>ğ
PAGE_SHIFT
;

75 
size
 >>ğ
PAGE_SHIFT
;

77 
»g
 = 
	`mŒr_d–_·ge
(-1, 
ba£
, 
size
);

78 ià(
»g
 < 0)

79  
»g
;

80 ià(
fcouÁ
 =ğ
NULL
)

81  
»g
;

82 ià(
fcouÁ
[
»g
] < 1)

83  -
EINVAL
;

84 --
fcouÁ
[
»g
];

85  
»g
;

86 
	}
}

89 
ssize_t


90 
	$mŒr_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
, 
size_t
 
Ën
, 
loff_t
 * 
µos
)

96 
i
, 
”r
;

97 
»g
;

98 
ba£
, 
size
;

99 *
±r
;

100 
lše
[
LINE_SIZE
];

101 
size_t
 
lš–’
;

103 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

104  -
EPERM
;

105 ià(!
Ën
)

106  -
EINVAL
;

107 
	`mem£t
(
lše
, 0, 
LINE_SIZE
);

108 ià(
Ën
 > 
LINE_SIZE
)

109 
Ën
 = 
LINE_SIZE
;

110 ià(
	`cİy_äom_u£r
(
lše
, 
buf
, 
Ën
 - 1))

111  -
EFAULT
;

112 
lš–’
 = 
	`¡¾’
(
lše
);

113 
±r
 = 
lše
 + 
lš–’
 - 1;

114 ià(
lš–’
 && *
±r
 == '\n')

115 *
±r
 = '\0';

116 ià(!
	`¡ºcmp
(
lše
, "disable=", 8)) {

117 
»g
 = 
	`sim¶e_¡¹oul
(
lše
 + 8, &
±r
, 0);

118 
”r
 = 
	`mŒr_d–_·ge
(
»g
, 0, 0);

119 ià(
”r
 < 0)

120  
”r
;

121  
Ën
;

123 ià(
	`¡ºcmp
(
lše
, "base=", 5))

124  -
EINVAL
;

125 
ba£
 = 
	`sim¶e_¡¹ouÎ
(
lše
 + 5, &
±r
, 0);

126 ; 
	`is¥aû
(*
±r
); ++ptr) ;

127 ià(
	`¡ºcmp
(
±r
, "size=", 5))

128  -
EINVAL
;

129 
size
 = 
	`sim¶e_¡¹ouÎ
(
±r
 + 5, &ptr, 0);

130 ià((
ba£
 & 0xfffè|| (
size
 & 0xfff))

131  -
EINVAL
;

132 ; 
	`is¥aû
(*
±r
); ++ptr) ;

133 ià(
	`¡ºcmp
(
±r
, "type=", 5))

134  -
EINVAL
;

135 
±r
 += 5;

136 ; 
	`is¥aû
(*
±r
); ++ptr) ;

137 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

138 ià(
	`¡rcmp
(
±r
, 
mŒr_¡ršgs
[
i
]))

140 
ba£
 >>ğ
PAGE_SHIFT
;

141 
size
 >>ğ
PAGE_SHIFT
;

142 
”r
 =

143 
	`mŒr_add_·ge
((è
ba£
, (è
size
, 
i
,

145 ià(
”r
 < 0)

146  
”r
;

147  
Ën
;

149  -
EINVAL
;

150 
	}
}

153 
	$mŒr_ioùl
(
fe
 *fe, 
cmd
, 
__¬g
)

155 
”r
 = 0;

156 
mŒr_ty³
 
ty³
;

157 
size
;

158 
mŒr_£Áry
 
£Áry
;

159 
mŒr_g’Œy
 
g’Œy
;

160 
__u£r
 *
¬g
 = (__u£¸*è
__¬g
;

162 
cmd
) {

163 
MTRRIOC_ADD_ENTRY
:

164 
MTRRIOC_SET_ENTRY
:

165 
MTRRIOC_DEL_ENTRY
:

166 
MTRRIOC_KILL_ENTRY
:

167 
MTRRIOC_ADD_PAGE_ENTRY
:

168 
MTRRIOC_SET_PAGE_ENTRY
:

169 
MTRRIOC_DEL_PAGE_ENTRY
:

170 
MTRRIOC_KILL_PAGE_ENTRY
:

171 ià(
	`cİy_äom_u£r
(&
£Áry
, 
¬g
,  sentry))

172  -
EFAULT
;

174 
MTRRIOC_GET_ENTRY
:

175 
MTRRIOC_GET_PAGE_ENTRY
:

176 ià(
	`cİy_äom_u£r
(&
g’Œy
, 
¬g
,  gentry))

177  -
EFAULT
;

179 #ifdeà
CONFIG_COMPAT


180 
MTRRIOC32_ADD_ENTRY
:

181 
MTRRIOC32_SET_ENTRY
:

182 
MTRRIOC32_DEL_ENTRY
:

183 
MTRRIOC32_KILL_ENTRY
:

184 
MTRRIOC32_ADD_PAGE_ENTRY
:

185 
MTRRIOC32_SET_PAGE_ENTRY
:

186 
MTRRIOC32_DEL_PAGE_ENTRY
:

187 
MTRRIOC32_KILL_PAGE_ENTRY
: {

188 
mŒr_£Áry32
 
__u£r
 *
s32
 = (mŒr_£Áry32 __u£¸*)
__¬g
;

189 
”r
 = 
	`g‘_u£r
(
£Áry
.
ba£
, &
s32
->base);

190 
”r
 |ğ
	`g‘_u£r
(
£Áry
.
size
, &
s32
->size);

191 
”r
 |ğ
	`g‘_u£r
(
£Áry
.
ty³
, &
s32
->type);

192 ià(
”r
)

193  
”r
;

196 
MTRRIOC32_GET_ENTRY
:

197 
MTRRIOC32_GET_PAGE_ENTRY
: {

198 
mŒr_g’Œy32
 
__u£r
 *
g32
 = (mŒr_g’Œy32 __u£¸*)
__¬g
;

199 
”r
 = 
	`g‘_u£r
(
g’Œy
.
»gnum
, &
g32
->regnum);

200 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
ba£
, &
g32
->base);

201 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
size
, &
g32
->size);

202 
”r
 |ğ
	`g‘_u£r
(
g’Œy
.
ty³
, &
g32
->type);

203 ià(
”r
)

204  
”r
;

210 
cmd
) {

212  -
ENOTTY
;

213 
MTRRIOC_ADD_ENTRY
:

214 #ifdeà
CONFIG_COMPAT


215 
MTRRIOC32_ADD_ENTRY
:

217 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

218  -
EPERM
;

219 
”r
 =

220 
	`mŒr_fe_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 1,

221 
fe
, 0);

223 
MTRRIOC_SET_ENTRY
:

224 #ifdeà
CONFIG_COMPAT


225 
MTRRIOC32_SET_ENTRY
:

227 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

228  -
EPERM
;

229 
”r
 = 
	`mŒr_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 0);

231 
MTRRIOC_DEL_ENTRY
:

232 #ifdeà
CONFIG_COMPAT


233 
MTRRIOC32_DEL_ENTRY
:

235 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

236  -
EPERM
;

237 
”r
 = 
	`mŒr_fe_d–
(
£Áry
.
ba£
, s’Œy.
size
, 
fe
, 0);

239 
MTRRIOC_KILL_ENTRY
:

240 #ifdeà
CONFIG_COMPAT


241 
MTRRIOC32_KILL_ENTRY
:

243 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

244  -
EPERM
;

245 
”r
 = 
	`mŒr_d–
(-1, 
£Áry
.
ba£
, s’Œy.
size
);

247 
MTRRIOC_GET_ENTRY
:

248 #ifdeà
CONFIG_COMPAT


249 
MTRRIOC32_GET_ENTRY
:

251 ià(
g’Œy
.
»gnum
 >ğ
num_v¬_¿nges
)

252  -
EINVAL
;

253 
mŒr_if
->
	`g‘
(
g’Œy
.
»gnum
, &g’Œy.
ba£
, &
size
, &
ty³
);

256 ià(
g’Œy
.
ba£
 + 
size
 - 1 >ğ(1UL << (8 * (g’Œy.sizeè- 
PAGE_SHIFT
))

257 || 
size
 >ğ(1UL << (8 * (
g’Œy
.sizeè- 
PAGE_SHIFT
)))

258 
g’Œy
.
ba£
 = g’Œy.
size
 = g’Œy.
ty³
 = 0;

260 
g’Œy
.
ba£
 <<ğ
PAGE_SHIFT
;

261 
g’Œy
.
size
 = siz<< 
PAGE_SHIFT
;

262 
g’Œy
.
ty³
 =ype;

266 
MTRRIOC_ADD_PAGE_ENTRY
:

267 #ifdeà
CONFIG_COMPAT


268 
MTRRIOC32_ADD_PAGE_ENTRY
:

270 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

271  -
EPERM
;

272 
”r
 =

273 
	`mŒr_fe_add
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 1,

274 
fe
, 1);

276 
MTRRIOC_SET_PAGE_ENTRY
:

277 #ifdeà
CONFIG_COMPAT


278 
MTRRIOC32_SET_PAGE_ENTRY
:

280 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

281  -
EPERM
;

282 
”r
 = 
	`mŒr_add_·ge
(
£Áry
.
ba£
, s’Œy.
size
, s’Œy.
ty³
, 0);

284 
MTRRIOC_DEL_PAGE_ENTRY
:

285 #ifdeà
CONFIG_COMPAT


286 
MTRRIOC32_DEL_PAGE_ENTRY
:

288 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

289  -
EPERM
;

290 
”r
 = 
	`mŒr_fe_d–
(
£Áry
.
ba£
, s’Œy.
size
, 
fe
, 1);

292 
MTRRIOC_KILL_PAGE_ENTRY
:

293 #ifdeà
CONFIG_COMPAT


294 
MTRRIOC32_KILL_PAGE_ENTRY
:

296 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

297  -
EPERM
;

298 
”r
 = 
	`mŒr_d–_·ge
(-1, 
£Áry
.
ba£
, s’Œy.
size
);

300 
MTRRIOC_GET_PAGE_ENTRY
:

301 #ifdeà
CONFIG_COMPAT


302 
MTRRIOC32_GET_PAGE_ENTRY
:

304 ià(
g’Œy
.
»gnum
 >ğ
num_v¬_¿nges
)

305  -
EINVAL
;

306 
mŒr_if
->
	`g‘
(
g’Œy
.
»gnum
, &g’Œy.
ba£
, &
size
, &
ty³
);

308 ià(
size
 !ğ(
	`__ty³of__
(
g’Œy
.size))size)

309 
g’Œy
.
ba£
 = g’Œy.
size
 = g’Œy.
ty³
 = 0;

311 
g’Œy
.
size
 = size;

312 
g’Œy
.
ty³
 =ype;

317 ià(
”r
)

318  
”r
;

320 
cmd
) {

321 
MTRRIOC_GET_ENTRY
:

322 
MTRRIOC_GET_PAGE_ENTRY
:

323 ià(
	`cİy_to_u£r
(
¬g
, &
g’Œy
,  gentry))

324 
”r
 = -
EFAULT
;

326 #ifdeà
CONFIG_COMPAT


327 
MTRRIOC32_GET_ENTRY
:

328 
MTRRIOC32_GET_PAGE_ENTRY
: {

329 
mŒr_g’Œy32
 
__u£r
 *
g32
 = (mŒr_g’Œy32 __u£¸*)
__¬g
;

330 
”r
 = 
	`put_u£r
(
g’Œy
.
ba£
, &
g32
->base);

331 
”r
 |ğ
	`put_u£r
(
g’Œy
.
size
, &
g32
->size);

332 
”r
 |ğ
	`put_u£r
(
g’Œy
.
»gnum
, &
g32
->regnum);

333 
”r
 |ğ
	`put_u£r
(
g’Œy
.
ty³
, &
g32
->type);

338  
”r
;

339 
	}
}

342 
	$mŒr_şo£
(
šode
 *
šo
, 
fe
 *file)

344 
i
, 
max
;

345 *
fcouÁ
 = 
	`FILE_FCOUNT
(
fe
);

347 ià(
fcouÁ
 !ğ
NULL
) {

348 
max
 = 
num_v¬_¿nges
;

349 
i
 = 0; i < 
max
; ++i) {

350 
fcouÁ
[
i
] > 0) {

351 
	`mŒr_d–
(
i
, 0, 0);

352 --
fcouÁ
[
i
];

355 
	`kä“
(
fcouÁ
);

356 
	`FILE_FCOUNT
(
fe
èğ
NULL
;

358  
	`sšgË_»Ëa£
(
šo
, 
fe
);

359 
	}
}

361 
mŒr_£q_show
(
£q_fe
 *
£q
, *
off£t
);

363 
	$mŒr_İ’
(
šode
 *šode, 
fe
 *file)

365 ià(!
mŒr_if
)

366  -
EIO
;

367 ià(!
mŒr_if
->
g‘
)

368  -
ENXIO
;

369  
	`sšgË_İ’
(
fe
, 
mŒr_£q_show
, 
NULL
);

370 
	}
}

372 cÚ¡ 
fe_İ”©iÚs
 
	gmŒr_fİs
 = {

373 .
owÃr
 = 
THIS_MODULE
,

374 .
	gİ’
 = 
mŒr_İ’
,

375 .
	g»ad
 = 
£q_»ad
,

376 .
	gÎ£ek
 = 
£q_l£ek
,

377 .
	gwr™e
 = 
mŒr_wr™e
,

378 .
	guÆocked_ioùl
 = 
mŒr_ioùl
,

379 .
	gcom·t_ioùl
 = 
mŒr_ioùl
,

380 .
	g»Ëa£
 = 
mŒr_şo£
,

384 
´oc_dœ_’Œy
 *
	g´oc_roÙ_mŒr
;

387 
	$mŒr_£q_show
(
£q_fe
 *
£q
, *
off£t
)

389 
çùÜ
;

390 
i
, 
max
, 
Ën
;

391 
mŒr_ty³
 
ty³
;

392 
ba£
, 
size
;

394 
Ën
 = 0;

395 
max
 = 
num_v¬_¿nges
;

396 
i
 = 0; i < 
max
; i++) {

397 
mŒr_if
->
	`g‘
(
i
, &
ba£
, &
size
, &
ty³
);

398 ià(
size
 == 0)

399 
u§ge_bË
[
i
] = 0;

401 ià(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

403 
çùÜ
 = 'K';

404 
size
 <<ğ
PAGE_SHIFT
 - 10;

406 
çùÜ
 = 'M';

407 
size
 >>ğ20 - 
PAGE_SHIFT
;

410 
Ën
 +ğ
	`£q_´štf
(
£q
,

412 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
, 
çùÜ
,

413 
	`mŒr_©Œib_to_¡r
(
ty³
), 
u§ge_bË
[
i
]);

417 
	}
}

419 
__š™
 
	$mŒr_if_š™
()

421 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

423 ià((!
	`ıu_has
(
c
, 
X86_FEATURE_MTRR
)) &&

424 (!
	`ıu_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

425 (!
	`ıu_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

426 (!
	`ıu_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

427  -
ENODEV
;

429 
´oc_roÙ_mŒr
 =

430 
	`ü—‹_´oc_’Œy
("mŒr", 
S_IWUSR
 | 
S_IRUGO
, &
´oc_roÙ
);

431 ià(
´oc_roÙ_mŒr
) {

432 
´oc_roÙ_mŒr
->
owÃr
 = 
THIS_MODULE
;

433 
´oc_roÙ_mŒr
->
´oc_fİs
 = &
mŒr_fİs
;

436 
	}
}

438 
¬ch_š™ÿÎ
(
mŒr_if_š™
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	~<lšux/moduË.h
>

35 
	~<lšux/š™.h
>

36 
	~<lšux/pci.h
>

37 
	~<lšux/smp.h
>

38 
	~<lšux/ıu.h
>

39 
	~<lšux/mu‹x.h
>

41 
	~<asm/mŒr.h
>

43 
	~<asm/uacûss.h
>

44 
	~<asm/´oûssÜ.h
>

45 
	~<asm/m¤.h
>

46 
	~"mŒr.h
"

48 
u32
 
	gnum_v¬_¿nges
 = 0;

50 *
	gu§ge_bË
;

51 
DEFINE_MUTEX
(
mŒr_mu‹x
);

53 
u64
 
	gsize_Ü_mask
, 
	gsize_ªd_mask
;

55 
mŒr_İs
 * 
	gmŒr_İs
[
X86_VENDOR_NUM
] = {};

57 
mŒr_İs
 * 
	gmŒr_if
 = 
NULL
;

59 
£t_mŒr
(
»g
, 
ba£
,

60 
size
, 
mŒr_ty³
 
ty³
);

62 #iâdeà
CONFIG_X86_64


63 
¬r3_´Ùeùed
;

65 
	#¬r3_´Ùeùed
 0

	)

68 
	$£t_mŒr_İs
(
mŒr_İs
 * 
İs
)

70 ià(
İs
->
v’dÜ
 && ops->v’dÜ < 
X86_VENDOR_NUM
)

71 
mŒr_İs
[
İs
->
v’dÜ
] = ops;

72 
	}
}

75 
	$have_wrcomb
()

77 
pci_dev
 *
dev
;

78 
u8
 
»v
;

80 ià((
dev
 = 
	`pci_g‘_şass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
)) != NULL) {

83 ià(
dev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_SERVERWORKS
 &&

84 
dev
->
deviû
 =ğ
PCI_DEVICE_ID_SERVERWORKS_LE
) {

85 
	`pci_»ad_cÚfig_by‹
(
dev
, 
PCI_CLASS_REVISION
, &
»v
);

86 ià(
»v
 <= 5) {

87 
	`´štk
(
KERN_INFO
 "mtrr: Serverworks LE„ev < 6 detected. Write-combining disabled.\n");

88 
	`pci_dev_put
(
dev
);

94 ià(
dev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_INTEL
 &&

95 
dev
->
deviû
 =ğ
PCI_DEVICE_ID_INTEL_82451NX
) {

96 
	`´štk
(
KERN_INFO
 "mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

97 
	`pci_dev_put
(
dev
);

100 
	`pci_dev_put
(
dev
);

102  (
mŒr_if
->
have_wrcomb
 ? mŒr_if->
	`have_wrcomb
() : 0);

103 
	}
}

106 
__š™
 
	$£t_num_v¬_¿nges
()

108 
cÚfig
 = 0, 
dummy
;

110 ià(
	`u£_š‹l
()) {

111 
	`rdm¤
(
MTRRÿp_MSR
, 
cÚfig
, 
dummy
);

112 } ià(
	`is_ıu
(
AMD
))

113 
cÚfig
 = 2;

114 ià(
	`is_ıu
(
CYRIX
è|| is_ıu(
CENTAUR
))

115 
cÚfig
 = 8;

116 
num_v¬_¿nges
 = 
cÚfig
 & 0xff;

117 
	}
}

119 
__š™
 
	$š™_bË
()

121 
i
, 
max
;

123 
max
 = 
num_v¬_¿nges
;

124 ià((
u§ge_bË
 = 
	`km®loc
(
max
 *  *u§ge_bË, 
GFP_KERNEL
))

125 =ğ
NULL
) {

126 
	`´štk
(
KERN_ERR
 "mtrr: could‚ot‡llocate\n");

129 
i
 = 0; i < 
max
; i++)

130 
u§ge_bË
[
i
] = 1;

131 
	}
}

133 
	s£t_mŒr_d©a
 {

134 
©omic_t
 
	mcouÁ
;

135 
©omic_t
 
	mg©e
;

136 
	msmp_ba£
;

137 
	msmp_size
;

138 
	msmp_»g
;

139 
mŒr_ty³
 
	msmp_ty³
;

142 
	$i_hªdËr
(*
šfo
)

147 #ifdeà
CONFIG_SMP


148 
£t_mŒr_d©a
 *
d©a
 = 
šfo
;

149 
æags
;

151 
	`loÿl_œq_§ve
(
æags
);

153 
	`©omic_dec
(&
d©a
->
couÁ
);

154 !
	`©omic_»ad
(&
d©a
->
g©e
))

155 
	`ıu_»Ïx
();

158 ià(
d©a
->
smp_»g
 != ~0U)

159 
mŒr_if
->
	`£t
(
d©a
->
smp_»g
, d©a->
smp_ba£
,

160 
d©a
->
smp_size
, d©a->
smp_ty³
);

162 
mŒr_if
->
	`£t_®l
();

164 
	`©omic_dec
(&
d©a
->
couÁ
);

165 
	`©omic_»ad
(&
d©a
->
g©e
))

166 
	`ıu_»Ïx
();

168 
	`©omic_dec
(&
d©a
->
couÁ
);

169 
	`loÿl_œq_»¡Üe
(
æags
);

171 
	}
}

173 
šlše
 
	$ty³s_com·tibË
(
mŒr_ty³
 
ty³1
, mŒr_ty³ 
ty³2
) {

174  
ty³1
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

175 
ty³2
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

176 (
ty³1
 =ğ
MTRR_TYPE_WRTHROUGH
 && 
ty³2
 =ğ
MTRR_TYPE_WRBACK
) ||

177 (
ty³1
 =ğ
MTRR_TYPE_WRBACK
 && 
ty³2
 =ğ
MTRR_TYPE_WRTHROUGH
);

178 
	}
}

219 
	$£t_mŒr
(
»g
, 
ba£
,

220 
size
, 
mŒr_ty³
 
ty³
)

222 
£t_mŒr_d©a
 
d©a
;

223 
æags
;

225 
d©a
.
smp_»g
 = 
»g
;

226 
d©a
.
smp_ba£
 = 
ba£
;

227 
d©a
.
smp_size
 = 
size
;

228 
d©a
.
smp_ty³
 = 
ty³
;

229 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

231 
	`smp_wmb
();

232 
	`©omic_£t
(&
d©a
.
g©e
,0);

235 ià(
	`smp_ÿÎ_funùiÚ
(
i_hªdËr
, &
d©a
, 1, 0) != 0)

236 
	`·nic
("mtrr:imed out waiting for other CPUs\n");

238 
	`loÿl_œq_§ve
(
æags
);

240 
	`©omic_»ad
(&
d©a
.
couÁ
))

241 
	`ıu_»Ïx
();

244 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

245 
	`smp_wmb
();

246 
	`©omic_£t
(&
d©a
.
g©e
,1);

256 ià(
»g
 != ~0U)

257 
mŒr_if
->
	`£t
(
»g
,
ba£
,
size
,
ty³
);

260 
	`©omic_»ad
(&
d©a
.
couÁ
))

261 
	`ıu_»Ïx
();

263 
	`©omic_£t
(&
d©a
.
couÁ
, 
	`num_boÙšg_ıus
() - 1);

264 
	`smp_wmb
();

265 
	`©omic_£t
(&
d©a
.
g©e
,0);

271 
	`©omic_»ad
(&
d©a
.
couÁ
))

272 
	`ıu_»Ïx
();

274 
	`loÿl_œq_»¡Üe
(
æags
);

275 
	}
}

313 
	$mŒr_add_·ge
(
ba£
, 
size
,

314 
ty³
, 
šüem’t
)

316 
i
, 
»¶aû
, 
”rÜ
;

317 
mŒr_ty³
 
Éy³
;

318 
lba£
, 
lsize
;

320 ià(!
mŒr_if
)

321  -
ENXIO
;

323 ià((
”rÜ
 = 
mŒr_if
->
	`v®id©e_add_·ge
(
ba£
,
size
,
ty³
)))

324  
”rÜ
;

326 ià(
ty³
 >ğ
MTRR_NUM_TYPES
) {

327 
	`´štk
(
KERN_WARNING
 "mŒr:y³: %u inv®id\n", 
ty³
);

328  -
EINVAL
;

332 ià((
ty³
 =ğ
MTRR_TYPE_WRCOMB
è&& !
	`have_wrcomb
()) {

333 
	`´štk
(
KERN_WARNING


335  -
ENOSYS
;

338 ià(!
size
) {

339 
	`´štk
(
KERN_WARNING
 "mtrr: zero sized„equest\n");

340  -
EINVAL
;

343 ià(
ba£
 & 
size_Ü_mask
 || 
size
 & size_or_mask) {

344 
	`´štk
(
KERN_WARNING
 "mtrr: base or sizeƒxceedshe MTRR width\n");

345  -
EINVAL
;

348 
”rÜ
 = -
EINVAL
;

349 
»¶aû
 = -1;

352 
	`lock_ıu_hÙ¶ug
();

354 
	`mu‹x_lock
(&
mŒr_mu‹x
);

355 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

356 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

357 ià(!
lsize
 || 
ba£
 > 
lba£
 +†siz- 1 || ba£ + 
size
 - 1 <†base)

360 ià(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >†ba£ + 
lsize
 - 1) {

361 ià(
ba£
 <ğ
lba£
 && ba£ + 
size
 - 1 >ğlba£ + 
lsize
 - 1) {

363 ià(
ty³
 =ğ
Éy³
) {

364 
»¶aû
 =„•Ïû =ğ-1 ? 
i
 : -2;

367 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

370 
	`´štk
(
KERN_WARNING


372 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

373 
lsize
);

374 
out
;

377 ià(
Éy³
 !ğ
ty³
) {

378 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

380 
	`´štk
 (
KERN_WARNING
 "mtrr:ype mismatch for %lx000,%lx000 old: %s‚ew: %s\n",

381 
ba£
, 
size
, 
	`mŒr_©Œib_to_¡r
(
Éy³
),

382 
	`mŒr_©Œib_to_¡r
(
ty³
));

383 
out
;

385 ià(
šüem’t
)

386 ++
u§ge_bË
[
i
];

387 
”rÜ
 = 
i
;

388 
out
;

391 
i
 = 
mŒr_if
->
	`g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû
);

392 ià(
i
 >= 0) {

393 
	`£t_mŒr
(
i
, 
ba£
, 
size
, 
ty³
);

394 ià(
	`lik–y
(
»¶aû
 < 0))

395 
u§ge_bË
[
i
] = 1;

397 
u§ge_bË
[
i
] = u§ge_bË[
»¶aû
] + !!
šüem’t
;

398 ià(
	`uÆik–y
(
»¶aû
 !ğ
i
)) {

399 
	`£t_mŒr
(
»¶aû
, 0, 0, 0);

400 
u§ge_bË
[
»¶aû
] = 0;

404 
	`´štk
(
KERN_INFO
 "mtrr:‚o more MTRRs‡vailable\n");

405 
”rÜ
 = 
i
;

406 
out
:

407 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

408 
	`uÆock_ıu_hÙ¶ug
();

409  
”rÜ
;

410 
	}
}

412 
	$mŒr_check
(
ba£
, 
size
)

414 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1))) {

415 
	`´štk
(
KERN_WARNING


417 
	`´štk
(
KERN_DEBUG


418 "mŒr: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

419 
	`dump_¡ack
();

423 
	}
}

462 
	$mŒr_add
(
ba£
, 
size
, 
ty³
,

463 
šüem’t
)

465 ià(
	`mŒr_check
(
ba£
, 
size
))

466  -
EINVAL
;

467  
	`mŒr_add_·ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty³
,

468 
šüem’t
);

469 
	}
}

486 
	$mŒr_d–_·ge
(
»g
, 
ba£
, 
size
)

488 
i
, 
max
;

489 
mŒr_ty³
 
Éy³
;

490 
lba£
, 
lsize
;

491 
”rÜ
 = -
EINVAL
;

493 ià(!
mŒr_if
)

494  -
ENXIO
;

496 
max
 = 
num_v¬_¿nges
;

498 
	`lock_ıu_hÙ¶ug
();

499 
	`mu‹x_lock
(&
mŒr_mu‹x
);

500 ià(
»g
 < 0) {

502 
i
 = 0; i < 
max
; ++i) {

503 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

504 ià(
lba£
 =ğ
ba£
 && 
lsize
 =ğ
size
) {

505 
»g
 = 
i
;

509 ià(
»g
 < 0) {

510 
	`´štk
(
KERN_DEBUG
 "mŒr:‚ØMTRR fÜ %lx000,%lx000 found\n", 
ba£
,

511 
size
);

512 
out
;

515 ià(
»g
 >ğ
max
) {

516 
	`´štk
(
KERN_WARNING
 "mŒr:„egi¡”: %doØbig\n", 
»g
);

517 
out
;

519 ià(
	`is_ıu
(
CYRIX
è&& !
	`u£_š‹l
()) {

520 ià((
»g
 =ğ3è&& 
¬r3_´Ùeùed
) {

521 
	`´štk
(
KERN_WARNING
 "mtrr: ARR3 cannot be changed\n");

522 
out
;

525 
mŒr_if
->
	`g‘
(
»g
, &
lba£
, &
lsize
, &
Éy³
);

526 ià(
lsize
 < 1) {

527 
	`´štk
(
KERN_WARNING
 "mŒr: MTRR %d‚Ù u£d\n", 
»g
);

528 
out
;

530 ià(
u§ge_bË
[
»g
] < 1) {

531 
	`´štk
(
KERN_WARNING
 "mŒr:„eg: %d ha couÁ=0\n", 
»g
);

532 
out
;

534 ià(--
u§ge_bË
[
»g
] < 1)

535 
	`£t_mŒr
(
»g
, 0, 0, 0);

536 
”rÜ
 = 
»g
;

537 
out
:

538 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

539 
	`uÆock_ıu_hÙ¶ug
();

540  
”rÜ
;

541 
	}
}

558 
	$mŒr_d–
(
»g
, 
ba£
, 
size
)

560 ià(
	`mŒr_check
(
ba£
, 
size
))

561  -
EINVAL
;

562  
	`mŒr_d–_·ge
(
»g
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

563 
	}
}

565 
EXPORT_SYMBOL
(
mŒr_add
);

566 
EXPORT_SYMBOL
(
mŒr_d–
);

572 
amd_š™_mŒr
();

573 
cyrix_š™_mŒr
();

574 
ûÁaur_š™_mŒr
();

576 
__š™
 
	$š™_ifs
()

578 #iâdeà
CONFIG_X86_64


579 
	`amd_š™_mŒr
();

580 
	`cyrix_š™_mŒr
();

581 
	`ûÁaur_š™_mŒr
();

583 
	}
}

588 
	smŒr_v®ue
 {

589 
mŒr_ty³
 
	mÉy³
;

590 
	mlba£
;

591 
	mlsize
;

594 
mŒr_v®ue
 * 
	gmŒr_¡©e
;

596 
	$mŒr_§ve
(
sys_deviû
 * 
sysdev
, 
pm_mes§ge_t
 
¡©e
)

598 
i
;

599 
size
 = 
num_v¬_¿nges
 * (
mŒr_v®ue
);

601 
mŒr_¡©e
 = 
	`kz®loc
(
size
,
GFP_ATOMIC
);

602 ià(!
mŒr_¡©e
)

603  -
ENOMEM
;

605 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

606 
mŒr_if
->
	`g‘
(
i
,

607 &
mŒr_¡©e
[
i
].
lba£
,

608 &
mŒr_¡©e
[
i
].
lsize
,

609 &
mŒr_¡©e
[
i
].
Éy³
);

612 
	}
}

614 
	$mŒr_»¡Üe
(
sys_deviû
 * 
sysdev
)

616 
i
;

618 
i
 = 0; i < 
num_v¬_¿nges
; i++) {

619 ià(
mŒr_¡©e
[
i
].
lsize
)

620 
	`£t_mŒr
(
i
,

621 
mŒr_¡©e
[
i
].
lba£
,

622 
mŒr_¡©e
[
i
].
lsize
,

623 
mŒr_¡©e
[
i
].
Éy³
);

625 
	`kä“
(
mŒr_¡©e
);

627 
	}
}

631 
sysdev_driv”
 
	gmŒr_sysdev_driv”
 = {

632 .
su¥’d
 = 
mŒr_§ve
,

633 .
	g»sume
 = 
mŒr_»¡Üe
,

644 
__š™
 
	$mŒr_bp_š™
()

646 
	`š™_ifs
();

648 ià(
ıu_has_mŒr
) {

649 
mŒr_if
 = &
g’”ic_mŒr_İs
;

650 
size_Ü_mask
 = 0xff000000;

651 
size_ªd_mask
 = 0x00f00000;

656 ià(
	`ıuid_—x
(0x80000000) >= 0x80000008) {

657 
u32
 
phys_addr
;

658 
phys_addr
 = 
	`ıuid_—x
(0x80000008) & 0xff;

660 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

661 
boÙ_ıu_d©a
.
x86
 == 0xF &&

662 
boÙ_ıu_d©a
.
x86_mod–
 == 0x3 &&

663 (
boÙ_ıu_d©a
.
x86_mask
 == 0x3 ||

664 
boÙ_ıu_d©a
.
x86_mask
 == 0x4))

665 
phys_addr
 = 36;

667 
size_Ü_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

668 
size_ªd_mask
 = ~
size_Ü_mask
 & 0xfffff00000ULL;

669 } ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_CENTAUR
 &&

670 
boÙ_ıu_d©a
.
x86
 == 6) {

673 
size_Ü_mask
 = 0xfff00000;

674 
size_ªd_mask
 = 0;

677 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

678 
X86_VENDOR_AMD
:

679 ià(
ıu_has_k6_mŒr
) {

681 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_AMD
];

682 
size_Ü_mask
 = 0xfff00000;

683 
size_ªd_mask
 = 0;

686 
X86_VENDOR_CENTAUR
:

687 ià(
ıu_has_ûÁaur_mü
) {

688 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_CENTAUR
];

689 
size_Ü_mask
 = 0xfff00000;

690 
size_ªd_mask
 = 0;

693 
X86_VENDOR_CYRIX
:

694 ià(
ıu_has_cyrix_¬r
) {

695 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_CYRIX
];

696 
size_Ü_mask
 = 0xfff00000;

697 
size_ªd_mask
 = 0;

705 ià(
mŒr_if
) {

706 
	`£t_num_v¬_¿nges
();

707 
	`š™_bË
();

708 ià(
	`u£_š‹l
())

709 
	`g‘_mŒr_¡©e
();

711 
	}
}

713 
	$mŒr_­_š™
()

715 
æags
;

717 ià(!
mŒr_if
 || !
	`u£_š‹l
())

727 
	`loÿl_œq_§ve
(
æags
);

729 
mŒr_if
->
	`£t_®l
();

731 
	`loÿl_œq_»¡Üe
(
æags
);

732 
	}
}

737 
	$mŒr_§ve_¡©e
()

739 
	`smp_ÿÎ_funùiÚ_sšgË
(0, 
mŒr_§ve_fixed_¿nges
, 
NULL
, 1, 1);

740 
	}
}

742 
__š™
 
	$mŒr_š™_fšŸlize
()

744 ià(!
mŒr_if
)

746 ià(
	`u£_š‹l
())

747 
	`mŒr_¡©e_w¬n
();

755 
	`sysdev_driv”_»gi¡”
(&
ıu_sysdev_şass
,

756 &
mŒr_sysdev_driv”
);

759 
	}
}

760 
subsys_š™ÿÎ
(
mŒr_š™_fšŸlize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c

1 
	~<lšux/mm.h
>

2 
	~<lšux/š™.h
>

3 
	~<asm/io.h
>

4 
	~<asm/mŒr.h
>

5 
	~<asm/m¤.h
>

6 
	~<asm/´oûssÜ-cyrix.h
>

7 
	~"mŒr.h
"

11 
	$£t_mŒr_´•¬e_§ve
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

13 
ü0
;

16 
	`loÿl_œq_§ve
(
ùxt
->
æags
);

18 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

21 iàĞ
ıu_has_pge
 ) {

22 
ùxt
->
ü4v®
 = 
	`»ad_ü4
();

23 
	`wr™e_ü4
(
ùxt
->
ü4v®
 & ~
X86_CR4_PGE
);

28 
ü0
 = 
	`»ad_ü0
() | 0x40000000;

29 
	`wbšvd
();

30 
	`wr™e_ü0
(
ü0
);

31 
	`wbšvd
();

33 ià(
	`u£_š‹l
())

35 
	`rdm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
, ctxt->
deáy³_hi
);

38 
ùxt
->
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

40 
	}
}

42 
	$£t_mŒr_ÿche_di§bË
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

44 ià(
	`u£_š‹l
())

46 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
 & 0xf300UL,

47 
ùxt
->
deáy³_hi
);

48 ià(
	`is_ıu
(
CYRIX
))

50 
	`£tCx86
(
CX86_CCR3
, (
ùxt
->
cü3
 & 0x0f) | 0x10);

51 
	}
}

54 
	$£t_mŒr_dÚe
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

56 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

59 
	`wbšvd
();

62 ià(
	`u£_š‹l
())

64 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³_lo
, ctxt->
deáy³_hi
);

67 
	`£tCx86
(
CX86_CCR3
, 
ùxt
->
cü3
);

70 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

73 iàĞ
ıu_has_pge
 )

74 
	`wr™e_ü4
(
ùxt
->
ü4v®
);

77 
	`loÿl_œq_»¡Üe
(
ùxt
->
æags
);

78 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

10 
	~<lšux/³rıu.h
>

11 
	~<lšux/moduË.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/b™İs.h
>

14 
	~<lšux/smp.h
>

15 
	~<lšux/nmi.h
>

16 
	~<asm/­ic.h
>

17 
	~<asm/š‹l_¬ch_³rfmÚ.h
>

19 
	snmi_w©chdog_ùlblk
 {

20 
	mccü_m¤
;

21 
	m³rfùr_m¤
;

22 
	mevÁ£l_m¤
;

26 
	swd_İs
 {

27 (*
	m»£rve
)();

28 (*
	muÄe£rve
)();

29 (*
	m£tup
)(
	mnmi_hz
);

30 (*
	m»¬m
)(
nmi_w©chdog_ùlblk
 *
	mwd
, 
	mnmi_hz
);

31 (*
	m¡İ
)();

32 
	m³rfùr
;

33 
	mevÁ£l
;

34 
u64
 
	mcheckb™
;

37 cÚ¡ 
wd_İs
 *
	gwd_İs
;

42 
	#NMI_MAX_COUNTER_BITS
 66

	)

50 
DECLARE_BITMAP
(
³rfùr_nmi_owÃr
, 
NMI_MAX_COUNTER_BITS
);

51 
DECLARE_BITMAP
(
evÁ£l_nmi_owÃr
, 
NMI_MAX_COUNTER_BITS
);

53 
DEFINE_PER_CPU
(
nmi_w©chdog_ùlblk
,‚mi_watchdog_ctlblk);

56 
šlše
 
	$nmi_³rfùr_m¤_to_b™
(
m¤
)

59 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

60 
X86_VENDOR_AMD
:

61  (
m¤
 - 
MSR_K7_PERFCTR0
);

62 
X86_VENDOR_INTEL
:

63 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

64  (
m¤
 - 
MSR_ARCH_PERFMON_PERFCTR0
);

66 
boÙ_ıu_d©a
.
x86
) {

68  (
m¤
 - 
MSR_P6_PERFCTR0
);

70  (
m¤
 - 
MSR_P4_BPU_PERFCTR0
);

74 
	}
}

78 
šlše
 
	$nmi_evÁ£l_m¤_to_b™
(
m¤
)

81 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

82 
X86_VENDOR_AMD
:

83  (
m¤
 - 
MSR_K7_EVNTSEL0
);

84 
X86_VENDOR_INTEL
:

85 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

86  (
m¤
 - 
MSR_ARCH_PERFMON_EVENTSEL0
);

88 
boÙ_ıu_d©a
.
x86
) {

90  (
m¤
 - 
MSR_P6_EVNTSEL0
);

92  (
m¤
 - 
MSR_P4_BSU_ESCR0
);

97 
	}
}

100 
	$ava_to_»¤v_³rfùr_nmi_b™
(
couÁ”
)

102 
	`BUG_ON
(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
);

104  (!
	`‹¡_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
));

105 
	}
}

108 
	$ava_to_»¤v_³rfùr_nmi
(
m¤
)

110 
couÁ”
;

112 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

113 
	`BUG_ON
(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
);

115  (!
	`‹¡_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
));

116 
	}
}

118 
	$»£rve_³rfùr_nmi
(
m¤
)

120 
couÁ”
;

122 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

124 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

127 ià(!
	`‹¡_ªd_£t_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
))

130 
	}
}

132 
	$»Ëa£_³rfùr_nmi
(
m¤
)

134 
couÁ”
;

136 
couÁ”
 = 
	`nmi_³rfùr_m¤_to_b™
(
m¤
);

138 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

141 
	`ş—r_b™
(
couÁ”
, 
³rfùr_nmi_owÃr
);

142 
	}
}

144 
	$»£rve_evÁ£l_nmi
(
m¤
)

146 
couÁ”
;

148 
couÁ”
 = 
	`nmi_evÁ£l_m¤_to_b™
(
m¤
);

150 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

153 ià(!
	`‹¡_ªd_£t_b™
(
couÁ”
, 
evÁ£l_nmi_owÃr
))

156 
	}
}

158 
	$»Ëa£_evÁ£l_nmi
(
m¤
)

160 
couÁ”
;

162 
couÁ”
 = 
	`nmi_evÁ£l_m¤_to_b™
(
m¤
);

164 ià(
couÁ”
 > 
NMI_MAX_COUNTER_BITS
)

167 
	`ş—r_b™
(
couÁ”
, 
evÁ£l_nmi_owÃr
);

168 
	}
}

170 
EXPORT_SYMBOL
(
ava_to_»¤v_³rfùr_nmi
);

171 
EXPORT_SYMBOL
(
ava_to_»¤v_³rfùr_nmi_b™
);

172 
EXPORT_SYMBOL
(
»£rve_³rfùr_nmi
);

173 
EXPORT_SYMBOL
(
»Ëa£_³rfùr_nmi
);

174 
EXPORT_SYMBOL
(
»£rve_evÁ£l_nmi
);

175 
EXPORT_SYMBOL
(
»Ëa£_evÁ£l_nmi
);

177 
	$di§bË_Ïpic_nmi_w©chdog
()

179 
	`BUG_ON
(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
);

181 ià(
	`©omic_»ad
(&
nmi_aùive
) <= 0)

184 
	`Ú_—ch_ıu
(
¡İ_­ic_nmi_w©chdog
, 
NULL
, 0, 1);

185 
wd_İs
->
	`uÄe£rve
();

187 
	`BUG_ON
(
	`©omic_»ad
(&
nmi_aùive
) != 0);

188 
	}
}

190 
	$’abË_Ïpic_nmi_w©chdog
()

192 
	`BUG_ON
(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
);

195 ià(
	`©omic_»ad
(&
nmi_aùive
) != 0)

199 ià(!
wd_İs
)

201 ià(!
wd_İs
->
	`»£rve
()) {

202 
	`´štk
(
KERN_ERR
 "NMI watchdog: cannot„eserve…erfctrs\n");

206 
	`Ú_—ch_ıu
(
£tup_­ic_nmi_w©chdog
, 
NULL
, 0, 1);

207 
	`touch_nmi_w©chdog
();

208 
	}
}

214 
	$adju¡_fÜ_32b™_ùr
(
hz
)

216 
u64
 
couÁ”_v®
;

217 
»tv®
 = 
hz
;

226 
couÁ”_v®
 = (
u64
)
ıu_khz
 * 1000;

227 
	`do_div
(
couÁ”_v®
, 
»tv®
);

228 ià(
couÁ”_v®
 > 0x7fffffffULL) {

229 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

230 
	`do_div
(
couÁ
, 0x7fffffffUL);

231 
»tv®
 = 
couÁ
 + 1;

233  
»tv®
;

234 
	}
}

237 
	$wr™e_w©chdog_couÁ”
(
³rfùr_m¤
, cÚ¡ *
desü
, 
nmi_hz
)

239 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

241 
	`do_div
(
couÁ
, 
nmi_hz
);

242 if(
desü
)

243 
	`D´štk
("£‰šg % tØ-0x%08Lx\n", 
desü
, 
couÁ
);

244 
	`wrm¤l
(
³rfùr_m¤
, 0 - 
couÁ
);

245 
	}
}

247 
	$wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
,

248 cÚ¡ *
desü
, 
nmi_hz
)

250 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

252 
	`do_div
(
couÁ
, 
nmi_hz
);

253 if(
desü
)

254 
	`D´štk
("£‰šg % tØ-0x%08Lx\n", 
desü
, 
couÁ
);

255 
	`wrm¤
(
³rfùr_m¤
, (
u32
)(-
couÁ
), 0);

256 
	}
}

261 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

262 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

263 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

264 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

265 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

266 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

268 
	$£tup_k7_w©chdog
(
nmi_hz
)

270 
³rfùr_m¤
, 
evÁ£l_m¤
;

271 
evÁ£l
;

272 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

274 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

275 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

277 
	`wrm¤l
(
³rfùr_m¤
, 0UL);

279 
evÁ£l
 = 
K7_EVNTSEL_INT


280 | 
K7_EVNTSEL_OS


281 | 
K7_EVNTSEL_USR


282 | 
K7_NMI_EVENT
;

285 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

286 
	`wr™e_w©chdog_couÁ”
(
³rfùr_m¤
, "K7_PERFCTR0",
nmi_hz
);

287 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

288 
evÁ£l
 |ğ
K7_EVNTSEL_ENABLE
;

289 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

291 
wd
->
³rfùr_m¤
 =…erfctr_msr;

292 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

293 
wd
->
ccü_m¤
 = 0;

295 
	}
}

297 
	$sšgË_m¤_¡İ_w©chdog
()

299 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

301 
	`wrm¤
(
wd
->
evÁ£l_m¤
, 0, 0);

302 
	}
}

304 
	$sšgË_m¤_»£rve
()

306 ià(!
	`»£rve_³rfùr_nmi
(
wd_İs
->
³rfùr
))

309 ià(!
	`»£rve_evÁ£l_nmi
(
wd_İs
->
evÁ£l
)) {

310 
	`»Ëa£_³rfùr_nmi
(
wd_İs
->
³rfùr
);

314 
	}
}

316 
	$sšgË_m¤_uÄe£rve
()

318 
	`»Ëa£_evÁ£l_nmi
(
wd_İs
->
evÁ£l
);

319 
	`»Ëa£_³rfùr_nmi
(
wd_İs
->
³rfùr
);

320 
	}
}

322 
	$sšgË_m¤_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

325 
	`wr™e_w©chdog_couÁ”
(
wd
->
³rfùr_m¤
, 
NULL
, 
nmi_hz
);

326 
	}
}

328 cÚ¡ 
wd_İs
 
	gk7_wd_İs
 = {

329 .
»£rve
 = 
sšgË_m¤_»£rve
,

330 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

331 .
	g£tup
 = 
£tup_k7_w©chdog
,

332 .
	g»¬m
 = 
sšgË_m¤_»¬m
,

333 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

334 .
	g³rfùr
 = 
MSR_K7_PERFCTR0
,

335 .
	gevÁ£l
 = 
MSR_K7_EVNTSEL0
,

336 .
	gcheckb™
 = 1ULL<<47,

341 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

342 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

343 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

344 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

345 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

346 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

348 
	$£tup_p6_w©chdog
(
nmi_hz
)

350 
³rfùr_m¤
, 
evÁ£l_m¤
;

351 
evÁ£l
;

352 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

354 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

355 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

358 ià(
	`wrm¤_§ã
(
³rfùr_m¤
, 0, 0) < 0)

361 
evÁ£l
 = 
P6_EVNTSEL_INT


362 | 
P6_EVNTSEL_OS


363 | 
P6_EVNTSEL_USR


364 | 
P6_NMI_EVENT
;

367 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

368 
nmi_hz
 = 
	`adju¡_fÜ_32b™_ùr
(nmi_hz);

369 
	`wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
, "P6_PERFCTR0",
nmi_hz
);

370 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

371 
evÁ£l
 |ğ
P6_EVNTSEL0_ENABLE
;

372 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

374 
wd
->
³rfùr_m¤
 =…erfctr_msr;

375 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

376 
wd
->
ccü_m¤
 = 0;

378 
	}
}

380 
	$p6_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

386 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

388 
	`wr™e_w©chdog_couÁ”32
(
wd
->
³rfùr_m¤
, 
NULL
,
nmi_hz
);

389 
	}
}

391 cÚ¡ 
wd_İs
 
	gp6_wd_İs
 = {

392 .
»£rve
 = 
sšgË_m¤_»£rve
,

393 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

394 .
	g£tup
 = 
£tup_p6_w©chdog
,

395 .
	g»¬m
 = 
p6_»¬m
,

396 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

397 .
	g³rfùr
 = 
MSR_P6_PERFCTR0
,

398 .
	gevÁ£l
 = 
MSR_P6_EVNTSEL0
,

399 .
	gcheckb™
 = 1ULL<<39,

404 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1<<7)

	)

405 
	#P4_ESCR_EVENT_SELECT
(
N
è((N)<<25)

	)

406 
	#P4_ESCR_OS
 (1<<3)

	)

407 
	#P4_ESCR_USR
 (1<<2)

	)

408 
	#P4_CCCR_OVF_PMI0
 (1<<26)

	)

409 
	#P4_CCCR_OVF_PMI1
 (1<<27)

	)

410 
	#P4_CCCR_THRESHOLD
(
N
è((N)<<20)

	)

411 
	#P4_CCCR_COMPLEMENT
 (1<<19)

	)

412 
	#P4_CCCR_COMPARE
 (1<<18)

	)

413 
	#P4_CCCR_REQUIRED
 (3<<16)

	)

414 
	#P4_CCCR_ESCR_SELECT
(
N
è((N)<<13)

	)

415 
	#P4_CCCR_ENABLE
 (1<<12)

	)

416 
	#P4_CCCR_OVF
 (1<<31)

	)

422 
	$£tup_p4_w©chdog
(
nmi_hz
)

424 
³rfùr_m¤
, 
evÁ£l_m¤
, 
ccü_m¤
;

425 
evÁ£l
, 
ccü_v®
;

426 
misc_’abË
, 
dummy
;

427 
ht_num
;

428 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

430 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
, 
dummy
);

431 ià(!(
misc_’abË
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

434 #ifdeà
CONFIG_SMP


436 ià(
smp_num_siblšgs
 == 2) {

437 
ebx
, 
­icid
;

439 
ebx
 = 
	`ıuid_ebx
(1);

440 
­icid
 = (
ebx
 >> 24) & 0xff;

441 
ht_num
 = 
­icid
 & 1;

444 
ht_num
 = 0;

451 ià(!
ht_num
) {

453 
³rfùr_m¤
 = 
MSR_P4_IQ_PERFCTR0
;

454 
evÁ£l_m¤
 = 
MSR_P4_CRU_ESCR0
;

455 
ccü_m¤
 = 
MSR_P4_IQ_CCCR0
;

456 
ccü_v®
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

459 
³rfùr_m¤
 = 
MSR_P4_IQ_PERFCTR1
;

460 
evÁ£l_m¤
 = 
MSR_P4_CRU_ESCR0
;

461 
ccü_m¤
 = 
MSR_P4_IQ_CCCR1
;

462 
ccü_v®
 = 
P4_CCCR_OVF_PMI1
 | 
	`P4_CCCR_ESCR_SELECT
(4);

465 
evÁ£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

466 | 
P4_ESCR_OS


467 | 
P4_ESCR_USR
;

469 
ccü_v®
 |ğ
	`P4_CCCR_THRESHOLD
(15)

470 | 
P4_CCCR_COMPLEMENT


471 | 
P4_CCCR_COMPARE


472 | 
P4_CCCR_REQUIRED
;

474 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

475 
	`wrm¤
(
ccü_m¤
, 
ccü_v®
, 0);

476 
	`wr™e_w©chdog_couÁ”
(
³rfùr_m¤
, "P4_IQ_COUNTER0", 
nmi_hz
);

477 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

478 
ccü_v®
 |ğ
P4_CCCR_ENABLE
;

479 
	`wrm¤
(
ccü_m¤
, 
ccü_v®
, 0);

480 
wd
->
³rfùr_m¤
 =…erfctr_msr;

481 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

482 
wd
->
ccü_m¤
 = cccr_msr;

484 
	}
}

486 
	$¡İ_p4_w©chdog
()

488 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

489 
	`wrm¤
(
wd
->
ccü_m¤
, 0, 0);

490 
	`wrm¤
(
wd
->
evÁ£l_m¤
, 0, 0);

491 
	}
}

493 
	$p4_»£rve
()

495 ià(!
	`»£rve_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
))

497 #ifdeà
CONFIG_SMP


498 ià(
smp_num_siblšgs
 > 1 && !
	`»£rve_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
))

499 
ç1
;

501 ià(!
	`»£rve_evÁ£l_nmi
(
MSR_P4_CRU_ESCR0
))

502 
ç2
;

505 
ç2
:

506 #ifdeà
CONFIG_SMP


507 ià(
smp_num_siblšgs
 > 1)

508 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
);

509 
ç1
:

511 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
);

513 
	}
}

515 
	$p4_uÄe£rve
()

517 #ifdeà
CONFIG_SMP


518 ià(
smp_num_siblšgs
 > 1)

519 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR1
);

521 
	`»Ëa£_evÁ£l_nmi
(
MSR_P4_CRU_ESCR0
);

522 
	`»Ëa£_³rfùr_nmi
(
MSR_P4_IQ_PERFCTR0
);

523 
	}
}

525 
	$p4_»¬m
(
nmi_w©chdog_ùlblk
 *
wd
, 
nmi_hz
)

527 
dummy
;

535 
	`rdm¤l
(
wd
->
ccü_m¤
, 
dummy
);

536 
dummy
 &ğ~
P4_CCCR_OVF
;

537 
	`wrm¤l
(
wd
->
ccü_m¤
, 
dummy
);

538 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

540 
	`wr™e_w©chdog_couÁ”
(
wd
->
³rfùr_m¤
, 
NULL
, 
nmi_hz
);

541 
	}
}

543 cÚ¡ 
wd_İs
 
	gp4_wd_İs
 = {

544 .
»£rve
 = 
p4_»£rve
,

545 .
	guÄe£rve
 = 
p4_uÄe£rve
,

546 .
	g£tup
 = 
£tup_p4_w©chdog
,

547 .
	g»¬m
 = 
p4_»¬m
,

548 .
	g¡İ
 = 
¡İ_p4_w©chdog
,

550 .
	g³rfùr
 = 
MSR_P4_BPU_PERFCTR0
,

551 .
	gevÁ£l
 = 
MSR_P4_BSU_ESCR0
,

552 .
	gcheckb™
 = 1ULL<<39,

558 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

559 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

561 
wd_İs
 
	gš‹l_¬ch_wd_İs
;

563 
	$£tup_š‹l_¬ch_w©chdog
(
nmi_hz
)

565 
ebx
;

566 
ıuid10_—x
 
—x
;

567 
unu£d
;

568 
³rfùr_m¤
, 
evÁ£l_m¤
;

569 
evÁ£l
;

570 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

577 
	`ıuid
(10, &(
—x
.
fuÎ
), &
ebx
, &
unu£d
, &unused);

578 ià((
—x
.
¥l™
.
mask_Ëngth
 < (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

579 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

582 
³rfùr_m¤
 = 
wd_İs
->
³rfùr
;

583 
evÁ£l_m¤
 = 
wd_İs
->
evÁ£l
;

585 
	`wrm¤l
(
³rfùr_m¤
, 0UL);

587 
evÁ£l
 = 
ARCH_PERFMON_EVENTSEL_INT


588 | 
ARCH_PERFMON_EVENTSEL_OS


589 | 
ARCH_PERFMON_EVENTSEL_USR


590 | 
ARCH_PERFMON_NMI_EVENT_SEL


591 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

594 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

595 
nmi_hz
 = 
	`adju¡_fÜ_32b™_ùr
(nmi_hz);

596 
	`wr™e_w©chdog_couÁ”32
(
³rfùr_m¤
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

597 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

598 
evÁ£l
 |ğ
ARCH_PERFMON_EVENTSEL0_ENABLE
;

599 
	`wrm¤
(
evÁ£l_m¤
, 
evÁ£l
, 0);

601 
wd
->
³rfùr_m¤
 =…erfctr_msr;

602 
wd
->
evÁ£l_m¤
 =ƒvntsel_msr;

603 
wd
->
ccü_m¤
 = 0;

604 
š‹l_¬ch_wd_İs
.
checkb™
 = 1ULL << (
—x
.
¥l™
.
b™_width
 - 1);

606 
	}
}

608 
wd_İs
 
š‹l_¬ch_wd_İs
 
	g__»ad_mo¡ly
 = {

609 .
»£rve
 = 
sšgË_m¤_»£rve
,

610 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

611 .
	g£tup
 = 
£tup_š‹l_¬ch_w©chdog
,

612 .
	g»¬m
 = 
p6_»¬m
,

613 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

614 .
	g³rfùr
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

615 .
	gevÁ£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

618 
wd_İs
 
	gcÜeduo_wd_İs
 = {

619 .
»£rve
 = 
sšgË_m¤_»£rve
,

620 .
	guÄe£rve
 = 
sšgË_m¤_uÄe£rve
,

621 .
	g£tup
 = 
£tup_š‹l_¬ch_w©chdog
,

622 .
	g»¬m
 = 
p6_»¬m
,

623 .
	g¡İ
 = 
sšgË_m¤_¡İ_w©chdog
,

624 .
	g³rfùr
 = 
MSR_ARCH_PERFMON_PERFCTR0
,

625 .
	gevÁ£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
,

628 
	$´obe_nmi_w©chdog
()

630 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

631 
X86_VENDOR_AMD
:

632 ià(
boÙ_ıu_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

633 
boÙ_ıu_d©a
.
x86
 != 16)

635 
wd_İs
 = &
k7_wd_İs
;

637 
X86_VENDOR_INTEL
:

640 ià(
boÙ_ıu_d©a
.
x86
 =ğ6 && boÙ_ıu_d©a.
x86_mod–
 == 14) {

641 
wd_İs
 = &
cÜeduo_wd_İs
;

644 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

645 
wd_İs
 = &
š‹l_¬ch_wd_İs
;

648 
boÙ_ıu_d©a
.
x86
) {

650 ià(
boÙ_ıu_d©a
.
x86_mod–
 > 0xd)

653 
wd_İs
 = &
p6_wd_İs
;

656 ià(
boÙ_ıu_d©a
.
x86_mod–
 > 0x4)

659 
wd_İs
 = &
p4_wd_İs
;

666 
	}
}

670 
	$Ïpic_w©chdog_š™
(
nmi_hz
)

672 ià(!
wd_İs
) {

673 
	`´obe_nmi_w©chdog
();

674 ià(!
wd_İs
)

677 ià(!
wd_İs
->
	`»£rve
()) {

678 
	`´štk
(
KERN_ERR


684 ià(!(
wd_İs
->
	`£tup
(
nmi_hz
))) {

685 
	`´štk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

686 
	`¿w_smp_´oûssÜ_id
());

691 
	}
}

693 
	$Ïpic_w©chdog_¡İ
()

695 ià(
wd_İs
)

696 
wd_İs
->
	`¡İ
();

697 
	}
}

699 
	$Ïpic_adju¡_nmi_hz
(
hz
)

701 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

702 ià(
wd
->
³rfùr_m¤
 =ğ
MSR_P6_PERFCTR0
 ||

703 
wd
->
³rfùr_m¤
 =ğ
MSR_ARCH_PERFMON_PERFCTR1
)

704 
hz
 = 
	`adju¡_fÜ_32b™_ùr
(hz);

705  
hz
;

706 
	}
}

708 
	$Ïpic_wd_ev’t
(
nmi_hz
)

710 
nmi_w©chdog_ùlblk
 *
wd
 = &
	`__g‘_ıu_v¬
(nmi_watchdog_ctlblk);

711 
u64
 
ùr
;

712 
	`rdm¤l
(
wd
->
³rfùr_m¤
, 
ùr
);

713 ià(
ùr
 & 
wd_İs
->
checkb™
) {

716 
wd_İs
->
	`»¬m
(
wd
, 
nmi_hz
);

718 
	}
}

720 
	$Ïpic_w©chdog_ok
()

722  
wd_İs
 !ğ
NULL
;

723 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

24 
	~<lšux/moduË.h
>

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/”ºo.h
>

28 
	~<lšux/fú.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/pŞl.h
>

31 
	~<lšux/smp.h
>

32 
	~<lšux/majÜ.h
>

33 
	~<lšux/fs.h
>

34 
	~<lšux/smp_lock.h
>

35 
	~<lšux/deviû.h
>

36 
	~<lšux/ıu.h
>

37 
	~<lšux/nÙif›r.h
>

39 
	~<asm/´oûssÜ.h
>

40 
	~<asm/m¤.h
>

41 
	~<asm/uacûss.h
>

42 
	~<asm/sy¡em.h
>

44 
şass
 *
	gıuid_şass
;

46 
	sıuid_commªd
 {

47 
u32
 
	m»g
;

48 
u32
 *
	md©a
;

51 
	$ıuid_smp_ıuid
(*
cmd_block
)

53 
ıuid_commªd
 *
cmd
 = (ıuid_commªd *)
cmd_block
;

55 
	`ıuid
(
cmd
->
»g
, &cmd->
d©a
[0], &cmd->data[1], &cmd->data[2],

56 &
cmd
->
d©a
[3]);

57 
	}
}

59 
šlše
 
	$do_ıuid
(
ıu
, 
u32
 
»g
, u32 * 
d©a
)

61 
ıuid_commªd
 
cmd
;

63 
cmd
.
»g
 =„eg;

64 
cmd
.
d©a
 = data;

66 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
ıuid_smp_ıuid
, &
cmd
, 1, 1);

67 
	}
}

69 
loff_t
 
	$ıuid_£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
Üig
)

71 
loff_t
 
»t
;

73 
	`lock_k”Ãl
();

75 
Üig
) {

77 
fe
->
f_pos
 = 
off£t
;

78 
»t
 = 
fe
->
f_pos
;

81 
fe
->
f_pos
 +ğ
off£t
;

82 
»t
 = 
fe
->
f_pos
;

85 
»t
 = -
EINVAL
;

88 
	`uÆock_k”Ãl
();

89  
»t
;

90 
	}
}

92 
ssize_t
 
	$ıuid_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

93 
size_t
 
couÁ
, 
loff_t
 * 
µos
)

95 
__u£r
 *
tmp
 = 
buf
;

96 
u32
 
d©a
[4];

97 
u32
 
»g
 = *
µos
;

98 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

100 ià(
couÁ
 % 16)

101  -
EINVAL
;

103 ; 
couÁ
; count -= 16) {

104 
	`do_ıuid
(
ıu
, 
»g
, 
d©a
);

105 ià(
	`cİy_to_u£r
(
tmp
, &
d©a
, 16))

106  -
EFAULT
;

107 
tmp
 += 16;

108 *
µos
 = 
»g
++;

111  
tmp
 - 
buf
;

112 
	}
}

114 
	$ıuid_İ’
(
šode
 *šode, 
fe
 *file)

116 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

117 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

119 ià(
ıu
 >ğ
NR_CPUS
 || !
	`ıu_Úlše
(cpu))

120  -
ENXIO
;

121 ià(
c
->
ıuid_Ëv–
 < 0)

122  -
EIO
;

125 
	}
}

130 cÚ¡ 
fe_İ”©iÚs
 
	gıuid_fİs
 = {

131 .
owÃr
 = 
THIS_MODULE
,

132 .
	gÎ£ek
 = 
ıuid_£ek
,

133 .
	g»ad
 = 
ıuid_»ad
,

134 .
	gİ’
 = 
ıuid_İ’
,

137 
__ıuš™
 
	$ıuid_deviû_ü—‹
(
ıu
)

139 
deviû
 *
dev
;

141 
dev
 = 
	`deviû_ü—‹
(
ıuid_şass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
ıu
),

142 "ıu%d", 
ıu
);

143  
	`IS_ERR
(
dev
è? 
	`PTR_ERR
(dev) : 0;

144 
	}
}

146 
	$ıuid_deviû_de¡roy
(
ıu
)

148 
	`deviû_de¡roy
(
ıuid_şass
, 
	`MKDEV
(
CPUID_MAJOR
, 
ıu
));

149 
	}
}

151 
__ıuš™
 
	$ıuid_şass_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

152 
aùiÚ
,

153 *
hıu
)

155 
ıu
 = ()
hıu
;

156 
”r
 = 0;

158 
aùiÚ
) {

159 
CPU_UP_PREPARE
:

160 
CPU_UP_PREPARE_FROZEN
:

161 
”r
 = 
	`ıuid_deviû_ü—‹
(
ıu
);

163 
CPU_UP_CANCELED
:

164 
CPU_UP_CANCELED_FROZEN
:

165 
CPU_DEAD
:

166 
CPU_DEAD_FROZEN
:

167 
	`ıuid_deviû_de¡roy
(
ıu
);

170  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

171 
	}
}

173 
nÙif›r_block
 
__ıuš™d©a
 
	gıuid_şass_ıu_nÙif›r
 =

175 .
nÙif›r_ÿÎ
 = 
ıuid_şass_ıu_ÿÎback
,

178 
__š™
 
	$ıuid_š™
()

180 
i
, 
”r
 = 0;

181 
i
 = 0;

183 ià(
	`»gi¡”_chrdev
(
CPUID_MAJOR
, "ıu/ıuid", &
ıuid_fİs
)) {

184 
	`´štk
(
KERN_ERR
 "cpuid: unableo get major %d for cpuid\n",

185 
CPUID_MAJOR
);

186 
”r
 = -
EBUSY
;

187 
out
;

189 
ıuid_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "cpuid");

190 ià(
	`IS_ERR
(
ıuid_şass
)) {

191 
”r
 = 
	`PTR_ERR
(
ıuid_şass
);

192 
out_chrdev
;

194 
	`fÜ_—ch_Úlše_ıu
(
i
) {

195 
”r
 = 
	`ıuid_deviû_ü—‹
(
i
);

196 ià(
”r
 != 0)

197 
out_şass
;

199 
	`»gi¡”_hÙıu_nÙif›r
(&
ıuid_şass_ıu_nÙif›r
);

201 
”r
 = 0;

202 
out
;

204 
out_şass
:

205 
i
 = 0;

206 
	`fÜ_—ch_Úlše_ıu
(
i
) {

207 
	`ıuid_deviû_de¡roy
(
i
);

209 
	`şass_de¡roy
(
ıuid_şass
);

210 
out_chrdev
:

211 
	`uÄegi¡”_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

212 
out
:

213  
”r
;

214 
	}
}

216 
__ex™
 
	$ıuid_ex™
()

218 
ıu
 = 0;

220 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

221 
	`ıuid_deviû_de¡roy
(
ıu
);

222 
	`şass_de¡roy
(
ıuid_şass
);

223 
	`uÄegi¡”_chrdev
(
CPUID_MAJOR
, "cpu/cpuid");

224 
	`uÄegi¡”_hÙıu_nÙif›r
(&
ıuid_şass_ıu_nÙif›r
);

225 
	}
}

227 
moduË_š™
(
ıuid_š™
);

228 
moduË_ex™
(
ıuid_ex™
);

230 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

231 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

232 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/e820_64.c

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/š™.h
>

14 
	~<lšux/boÙmem.h
>

15 
	~<lšux/iİÜt.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/kexec.h
>

18 
	~<lšux/moduË.h
>

19 
	~<lšux/mm.h
>

20 
	~<lšux/su¥’d.h
>

21 
	~<lšux/pâ.h
>

23 
	~<asm/pgbË.h
>

24 
	~<asm/·ge.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/´Ùo.h
>

27 
	~<asm/£tup.h
>

28 
	~<asm/£ùiÚs.h
>

30 
e820m­
 
	ge820
;

35 
	g’d_pâ
;

36 
EXPORT_SYMBOL
(
’d_pâ
);

43 
	g’d_pâ_m­
;

48 
__š™d©a
 
	g’d_u£r_pâ
 = 
MAXMEM
>>
PAGE_SHIFT
;

50 
»sourû
 
code_»sourû
, 
d©a_»sourû
, 
bss_»sourû
;

53 
šlše
 
	$bad_addr
(*
add½
, 
size
)

55 
addr
 = *
add½
, 
Ï¡
 =‡dd¸+ 
size
;

58 ià(
addr
 < 0x8000) {

59 *
add½
 = 
	`PAGE_ALIGN
(0x8000);

64 ià(
Ï¡
 >ğ
bË_¡¬t
<<
PAGE_SHIFT
 && 
addr
 < 
bË_’d
<<PAGE_SHIFT) {

65 *
add½
 = 
	`PAGE_ALIGN
(
bË_’d
 << 
PAGE_SHIFT
);

70 #ifdeà
CONFIG_BLK_DEV_INITRD


71 ià(
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
 && boÙ_·¿ms.hdr.
¿mdisk_image
) {

72 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

73 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

74 
¿mdisk_’d
 = 
¿mdisk_image
+
¿mdisk_size
;

76 ià(
Ï¡
 >ğ
¿mdisk_image
 && 
addr
 < 
¿mdisk_’d
) {

77 *
add½
 = 
	`PAGE_ALIGN
(
¿mdisk_’d
);

83 ià(
Ï¡
 >ğ
	`__·_symbŞ
(&
_‹xt
è&& 
addr
 < __·_symbŞ(&
_’d
)) {

84 *
add½
 = 
	`PAGE_ALIGN
(
	`__·_symbŞ
(&
_’d
));

88 ià(
Ï¡
 >ğ
ebda_addr
 && 
addr
 <ƒbda_add¸+ 
ebda_size
) {

89 *
add½
 = 
	`PAGE_ALIGN
(
ebda_addr
 + 
ebda_size
);

93 #ifdeà
CONFIG_NUMA


95 ià(
Ï¡
 >ğ
nodem­_addr
 && 
addr
 <‚odem­_add¸+ 
nodem­_size
) {

96 *
add½
 = 
nodem­_addr
 + 
nodem­_size
;

102 
	}
}

109 
	$e820_ªy_m­³d
(
¡¬t
, 
’d
, 
ty³
)

111 
i
;

112 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

113 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

114 ià(
ty³
 && 
ei
->type !=ype)

116 ià(
ei
->
addr
 >ğ
’d
 ||ƒi->add¸+ƒi->
size
 <ğ
¡¬t
)

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
e820_ªy_m­³d
);

130 
__š™
 
	$e820_®l_m­³d
(
¡¬t
, 
’d
, 
ty³
)

132 
i
;

133 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

134 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

135 ià(
ty³
 && 
ei
->type !=ype)

138 ià(
ei
->
addr
 >ğ
’d
 ||ƒi->add¸+ƒi->
size
 <ğ
¡¬t
)

144 ià(
ei
->
addr
 <ğ
¡¬t
)

145 
¡¬t
 = 
ei
->
addr
 +ƒi->
size
;

147 ià(
¡¬t
 >ğ
’d
)

151 
	}
}

156 
__š™
 
	$fšd_e820_¬—
(
¡¬t
, 
’d
, 
size
)

158 
i
;

159 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

160 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

161 
addr
 = 
ei
->addr, 
Ï¡
;

162 ià(
ei
->
ty³
 !ğ
E820_RAM
)

164 ià(
addr
 < 
¡¬t
)

165 
addr
 = 
¡¬t
;

166 ià(
addr
 > 
ei
->add¸+ƒi->
size
)

168 
	`bad_addr
(&
addr
, 
size
è&&‡ddr+siz<ğ
ei
->addr+ei->size)

170 
Ï¡
 = 
	`PAGE_ALIGN
(
addr
è+ 
size
;

171 ià(
Ï¡
 > 
ei
->
addr
 +ƒi->
size
)

173 ià(
Ï¡
 > 
’d
)

175  
addr
;

178 
	}
}

183 
__š™
 
	$e820_’d_of_¿m
()

185 
’d_pâ
 = 0;

186 
’d_pâ
 = 
	`fšd_max_pâ_w™h_aùive_»giÚs
();

188 ià(
’d_pâ
 > 
’d_pâ_m­
)

189 
’d_pâ_m­
 = 
’d_pâ
;

190 ià(
’d_pâ_m­
 > 
MAXMEM
>>
PAGE_SHIFT
)

191 
’d_pâ_m­
 = 
MAXMEM
>>
PAGE_SHIFT
;

192 ià(
’d_pâ
 > 
’d_u£r_pâ
)

193 
’d_pâ
 = 
’d_u£r_pâ
;

194 ià(
’d_pâ
 > 
’d_pâ_m­
)

195 
’d_pâ
 = 
’d_pâ_m­
;

197 
	`´štk
("’d_pâ_m­ = %lu\n", 
’d_pâ_m­
);

198  
’d_pâ
;

199 
	}
}

204 
__š™
 
	$e820_»£rve_»sourûs
()

206 
i
;

207 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

208 
»sourû
 *
»s
;

209 
»s
 = 
	`®loc_boÙmem_low
((
»sourû
));

210 
e820
.
m­
[
i
].
ty³
) {

211 
E820_RAM
: 
»s
->
Çme
 = "System RAM"; ;

212 
E820_ACPI
: 
»s
->
Çme
 = "ACPI Tables"; ;

213 
E820_NVS
: 
»s
->
Çme
 = "ACPI Non-volatile Storage"; ;

214 : 
»s
->
Çme
 = "reserved";

216 
»s
->
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

217 
»s
->
’d
 =„es->
¡¬t
 + 
e820
.
m­
[
i
].
size
 - 1;

218 
»s
->
æags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

219 
	`»que¡_»sourû
(&
iomem_»sourû
, 
»s
);

220 ià(
e820
.
m­
[
i
].
ty³
 =ğ
E820_RAM
) {

226 
	`»que¡_»sourû
(
»s
, &
code_»sourû
);

227 
	`»que¡_»sourû
(
»s
, &
d©a_»sourû
);

228 
	`»que¡_»sourû
(
»s
, &
bss_»sourû
);

229 #ifdeà
CONFIG_KEXEC


230 ià(
üashk_»s
.
¡¬t
 !ğüashk_»s.
’d
)

231 
	`»que¡_»sourû
(
»s
, &
üashk_»s
);

235 
	}
}

245 
__š™
 
	$e820_m¬k_no§ve_»giÚs
()

247 
i
;

248 
·ddr
;

250 
·ddr
 = 
	`round_down
(
e820
.
m­
[0].
addr
 +ƒ820.m­[0].
size
, 
PAGE_SIZE
);

251 
i
 = 1; i < 
e820
.
Ä_m­
; i++) {

252 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

254 ià(
·ddr
 < 
ei
->
addr
)

255 
	`»gi¡”_no§ve_»giÚ
(
	`PFN_DOWN
(
·ddr
),

256 
	`PFN_UP
(
ei
->
addr
));

258 
·ddr
 = 
	`round_down
(
ei
->
addr
 +ƒi->
size
, 
PAGE_SIZE
);

259 ià(
ei
->
ty³
 !ğ
E820_RAM
)

260 
	`»gi¡”_no§ve_»giÚ
(
	`PFN_UP
(
ei
->
addr
),

261 
	`PFN_DOWN
(
·ddr
));

263 ià(
·ddr
 >ğ(
’d_pâ
 << 
PAGE_SHIFT
))

266 
	}
}

272 
__š™
 
	$e820_fšd_aùive_»giÚ
(cÚ¡ 
e820’Œy
 *
ei
,

273 
¡¬t_pâ
,

274 
’d_pâ
,

275 *
ei_¡¬â
,

276 *
ei_’dpâ
)

278 *
ei_¡¬â
 = 
	`round_up
(
ei
->
addr
, 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

279 *
ei_’dpâ
 = 
	`round_down
(
ei
->
addr
 +ƒi->
size
, 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

282 ià(*
ei_¡¬â
 >ğ*
ei_’dpâ
)

286 ià(
ei
->
ty³
 !ğ
E820_RAM
 && *
ei_’dpâ
 > 
’d_pâ_m­
)

287 
’d_pâ_m­
 = *
ei_’dpâ
;

290 ià(
ei
->
ty³
 !ğ
E820_RAM
 || *
ei_’dpâ
 <ğ
¡¬t_pâ
 ||

291 *
ei_¡¬â
 >ğ
’d_pâ
)

295 ià(*
ei_¡¬â
 < 
¡¬t_pâ
)

296 *
ei_¡¬â
 = 
¡¬t_pâ
;

297 ià(*
ei_’dpâ
 > 
’d_pâ
)

298 *
ei_’dpâ
 = 
’d_pâ
;

301 ià(*
ei_¡¬â
 >ğ
’d_u£r_pâ
)

303 ià(*
ei_’dpâ
 > 
’d_u£r_pâ
)

304 *
ei_’dpâ
 = 
’d_u£r_pâ
;

307 
	}
}

310 
__š™


311 
	$e820_»gi¡”_aùive_»giÚs
(
nid
, 
¡¬t_pâ
,

312 
’d_pâ
)

314 
ei_¡¬â
;

315 
ei_’dpâ
;

316 
i
;

318 
i
 = 0; i < 
e820
.
Ä_m­
; i++)

319 ià(
	`e820_fšd_aùive_»giÚ
(&
e820
.
m­
[
i
],

320 
¡¬t_pâ
, 
’d_pâ
,

321 &
ei_¡¬â
, &
ei_’dpâ
))

322 
	`add_aùive_¿nge
(
nid
, 
ei_¡¬â
, 
ei_’dpâ
);

323 
	}
}

328 
__š™
 
	$add_memÜy_»giÚ
(
¡¬t
, 
size
, 
ty³
)

330 
x
 = 
e820
.
Ä_m­
;

332 ià(
x
 =ğ
E820MAX
) {

333 
	`´štk
(
KERN_ERR
 "Ooops! Too manyƒntries inhe memory map!\n");

337 
e820
.
m­
[
x
].
addr
 = 
¡¬t
;

338 
e820
.
m­
[
x
].
size
 = size;

339 
e820
.
m­
[
x
].
ty³
 =ype;

340 
e820
.
Ä_m­
++;

341 
	}
}

348 
__š™
 
	$e820_hŞe_size
(
¡¬t
, 
’d
)

350 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

351 
’d_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

352 
ei_¡¬â
;

353 
ei_’dpâ
;

354 
¿m
 = 0;

355 
i
;

357 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

358 ià(
	`e820_fšd_aùive_»giÚ
(&
e820
.
m­
[
i
],

359 
¡¬t_pâ
, 
’d_pâ
,

360 &
ei_¡¬â
, &
ei_’dpâ
))

361 
¿m
 +ğ
ei_’dpâ
 - 
ei_¡¬â
;

363  
’d
 - 
¡¬t
 - (
¿m
 << 
PAGE_SHIFT
);

364 
	}
}

366 
__š™
 
	$e820_´št_m­
(*
who
)

368 
i
;

370 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

371 
	`´štk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

372 (è
e820
.
m­
[
i
].
addr
,

373 (è(
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
));

374 
e820
.
m­
[
i
].
ty³
) {

375 
E820_RAM
: 
	`´štk
("(usable)\n");

377 
E820_RESERVED
:

378 
	`´štk
("(reserved)\n");

380 
E820_ACPI
:

381 
	`´štk
("(ACPI data)\n");

383 
E820_NVS
:

384 
	`´štk
("(ACPI NVS)\n");

386 : 
	`´štk
("ty³ %u\n", 
e820
.
m­
[
i
].
ty³
);

390 
	}
}

399 
__š™
 
	$§n™ize_e820_m­
(
e820’Œy
 * 
biosm­
, * 
²r_m­
)

401 
	schªge_memb”
 {

402 
e820’Œy
 *
pbios
;

403 
addr
;

405 
chªge_memb”
 
chªge_pošt_li¡
[2*
E820MAX
] 
__š™d©a
;

406 
chªge_memb”
 *
chªge_pošt
[2*
E820MAX
] 
__š™d©a
;

407 
e820’Œy
 *
ov”Ïp_li¡
[
E820MAX
] 
__š™d©a
;

408 
e820’Œy
 
Ãw_bios
[
E820MAX
] 
__š™d©a
;

409 
chªge_memb”
 *
chªge_tmp
;

410 
cu¼’t_ty³
, 
Ï¡_ty³
;

411 
Ï¡_addr
;

412 
chgidx
, 
¡l_chªgšg
;

413 
ov”Ïp_’Œ›s
;

414 
Ãw_bios_’Œy
;

415 
Şd_Ä
, 
Ãw_Ä
, 
chg_Ä
;

416 
i
;

455 ià(*
²r_m­
 < 2)

458 
Şd_Ä
 = *
²r_m­
;

461 
i
=0; i<
Şd_Ä
; i++)

462 ià(
biosm­
[
i
].
addr
 + biosm­[i].
size
 < biosmap[i].addr)

466 
i
=0; i < 2*
Şd_Ä
; i++)

467 
chªge_pošt
[
i
] = &
chªge_pošt_li¡
[i];

471 
chgidx
 = 0;

472 
i
=0; i < 
Şd_Ä
; i++) {

473 ià(
biosm­
[
i
].
size
 != 0) {

474 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].addr;

475 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

476 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].add¸+ biosm­[i].
size
;

477 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

480 
chg_Ä
 = 
chgidx
;

483 
¡l_chªgšg
 = 1;

484 
¡l_chªgšg
) {

485 
¡l_chªgšg
 = 0;

486 
i
=1; i < 
chg_Ä
; i++) {

489 ià((
chªge_pošt
[
i
]->
addr
 < change_point[i-1]->addr) ||

490 ((
chªge_pošt
[
i
]->
addr
 == change_point[i-1]->addr) &&

491 (
chªge_pošt
[
i
]->
addr
 =ğchªge_pošt[i]->
pbios
->addr) &&

492 (
chªge_pošt
[
i
-1]->
addr
 !ğchªge_pošt[i-1]->
pbios
->addr))

495 
chªge_tmp
 = 
chªge_pošt
[
i
];

496 
chªge_pošt
[
i
] = change_point[i-1];

497 
chªge_pošt
[
i
-1] = 
chªge_tmp
;

498 
¡l_chªgšg
=1;

504 
ov”Ïp_’Œ›s
=0;

505 
Ãw_bios_’Œy
=0;

506 
Ï¡_ty³
 = 0;

507 
Ï¡_addr
 = 0;

509 
chgidx
=0; chgidx < 
chg_Ä
; chgidx++)

512 ià(
chªge_pošt
[
chgidx
]->
addr
 =ğchªge_pošt[chgidx]->
pbios
->addr)

515 
ov”Ïp_li¡
[
ov”Ïp_’Œ›s
++]=
chªge_pošt
[
chgidx
]->
pbios
;

520 
i
=0; i<
ov”Ïp_’Œ›s
; i++)

522 ià(
ov”Ïp_li¡
[
i
] =ğ
chªge_pošt
[
chgidx
]->
pbios
)

523 
ov”Ïp_li¡
[
i
] = ov”Ïp_li¡[
ov”Ïp_’Œ›s
-1];

525 
ov”Ïp_’Œ›s
--;

529 
cu¼’t_ty³
 = 0;

530 
i
=0; i<
ov”Ïp_’Œ›s
; i++)

531 ià(
ov”Ïp_li¡
[
i
]->
ty³
 > 
cu¼’t_ty³
)

532 
cu¼’t_ty³
 = 
ov”Ïp_li¡
[
i
]->
ty³
;

534 ià(
cu¼’t_ty³
 !ğ
Ï¡_ty³
) {

535 ià(
Ï¡_ty³
 != 0) {

536 
Ãw_bios
[
Ãw_bios_’Œy
].
size
 =

537 
chªge_pošt
[
chgidx
]->
addr
 - 
Ï¡_addr
;

539 ià(
Ãw_bios
[
Ãw_bios_’Œy
].
size
 != 0)

540 ià(++
Ãw_bios_’Œy
 >ğ
E820MAX
)

543 ià(
cu¼’t_ty³
 != 0) {

544 
Ãw_bios
[
Ãw_bios_’Œy
].
addr
 = 
chªge_pošt
[
chgidx
]->addr;

545 
Ãw_bios
[
Ãw_bios_’Œy
].
ty³
 = 
cu¼’t_ty³
;

546 
Ï¡_addr
=
chªge_pošt
[
chgidx
]->
addr
;

548 
Ï¡_ty³
 = 
cu¼’t_ty³
;

551 
Ãw_Ä
 = 
Ãw_bios_’Œy
;

554 
	`memıy
(
biosm­
, 
Ãw_bios
, 
Ãw_Ä
*(
e820’Œy
));

555 *
²r_m­
 = 
Ãw_Ä
;

558 
	}
}

569 
__š™
 
	$cİy_e820_m­
(
e820’Œy
 * 
biosm­
, 
Ä_m­
)

572 ià(
Ä_m­
 < 2)

576 
¡¬t
 = 
biosm­
->
addr
;

577 
size
 = 
biosm­
->size;

578 
’d
 = 
¡¬t
 + 
size
;

579 
ty³
 = 
biosm­
->type;

582 ià(
¡¬t
 > 
’d
)

585 
	`add_memÜy_»giÚ
(
¡¬t
, 
size
, 
ty³
);

586 } 
biosm­
++,--
Ä_m­
);

588 
	}
}

590 
	$—¾y_·nic
(*
msg
)

592 
	`—¾y_´štk
(
msg
);

593 
	`·nic
(
msg
);

594 
	}
}

596 
__š™
 
	$£tup_memÜy_»giÚ
()

604 
	`§n™ize_e820_m­
(
boÙ_·¿ms
.
e820_m­
, &boÙ_·¿ms.
e820_’Œ›s
);

605 ià(
	`cİy_e820_m­
(
boÙ_·¿ms
.
e820_m­
, boÙ_·¿ms.
e820_’Œ›s
) < 0)

606 
	`—¾y_·nic
("Cannot find‡ valid memory map");

607 
	`´štk
(
KERN_INFO
 "BIOS-provided…hysical RAM map:\n");

608 
	`e820_´št_m­
("BIOS-e820");

609 
	}
}

611 
__š™
 
	$·r£_memİt
(*
p
)

613 ià(!
p
)

614  -
EINVAL
;

615 
’d_u£r_pâ
 = 
	`mem·r£
(
p
, &p);

616 
’d_u£r_pâ
 >>ğ
PAGE_SHIFT
;

618 
	}
}

619 
—¾y_·¿m
("mem", 
·r£_memİt
);

621 
u£rdef
 
	g__š™d©a
;

623 
__š™
 
	$·r£_memm­_İt
(*
p
)

625 *
Şdp
;

626 
¡¬t_©
, 
mem_size
;

628 ià(!
	`¡rcmp
(
p
, "exactmap")) {

629 #ifdeà
CONFIG_CRASH_DUMP


635 
	`e820_»gi¡”_aùive_»giÚs
(0, 0, -1UL);

636 
§ved_max_pâ
 = 
	`e820_’d_of_¿m
();

637 
	`»move_®l_aùive_¿nges
();

639 
’d_pâ_m­
 = 0;

640 
e820
.
Ä_m­
 = 0;

641 
u£rdef
 = 1;

645 
Şdp
 = 
p
;

646 
mem_size
 = 
	`mem·r£
(
p
, &p);

647 ià(
p
 =ğ
Şdp
)

648  -
EINVAL
;

649 ià(*
p
 == '@') {

650 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

651 
	`add_memÜy_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_RAM
);

652 } ià(*
p
 == '#') {

653 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

654 
	`add_memÜy_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_ACPI
);

655 } ià(*
p
 == '$') {

656 
¡¬t_©
 = 
	`mem·r£
(
p
+1, &p);

657 
	`add_memÜy_»giÚ
(
¡¬t_©
, 
mem_size
, 
E820_RESERVED
);

659 
’d_u£r_pâ
 = (
mem_size
 >> 
PAGE_SHIFT
);

661  *
p
 =ğ'\0' ? 0 : -
EINVAL
;

662 
	}
}

663 
—¾y_·¿m
("memm­", 
·r£_memm­_İt
);

665 
__š™
 
	$fšish_e820_·rsšg
()

667 ià(
u£rdef
) {

668 
	`´štk
(
KERN_INFO
 "user-defined…hysical RAM map:\n");

669 
	`e820_´št_m­
("user");

671 
	}
}

673 
	gpci_mem_¡¬t
 = 0xaeedbabe;

674 
EXPORT_SYMBOL
(
pci_mem_¡¬t
);

682 
__š™
 
	$e820_£tup_g­
()

684 
g­¡¬t
, 
g­size
, 
round
;

685 
Ï¡
;

686 
i
;

687 
found
 = 0;

689 
Ï¡
 = 0x100000000ull;

690 
g­¡¬t
 = 0x10000000;

691 
g­size
 = 0x400000;

692 
i
 = 
e820
.
Ä_m­
;

693 --
i
 >= 0) {

694 
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

695 
’d
 = 
¡¬t
 + 
e820
.
m­
[
i
].
size
;

701 ià(
Ï¡
 > 
’d
) {

702 
g­
 = 
Ï¡
 - 
’d
;

704 ià(
g­
 > 
g­size
) {

705 
g­size
 = 
g­
;

706 
g­¡¬t
 = 
’d
;

707 
found
 = 1;

710 ià(
¡¬t
 < 
Ï¡
)

711 
Ï¡
 = 
¡¬t
;

714 ià(!
found
) {

715 
g­¡¬t
 = (
’d_pâ
 << 
PAGE_SHIFT
) + 1024*1024;

716 
	`´štk
(
KERN_ERR
 "PCI: Warning: Cannot find‡ gap inhe 32bit‡ddress„ange\n"

717 
KERN_ERR
 "PCI: Unassigned devices with 32bit„esource„egisters may break!\n");

724 
round
 = 0x100000;

725 (
g­size
 >> 4è> 
round
)

726 
round
 +=„ound;

728 
pci_mem_¡¬t
 = (
g­¡¬t
 + 
round
) & -round;

730 
	`´štk
(
KERN_INFO
 "Allocating PCI„esources starting‡t %lx (gap: %lx:%lx)\n",

731 
pci_mem_¡¬t
, 
g­¡¬t
, 
g­size
);

732 
	}
}

734 
__š™
 
	$¬ch_g‘_¿m_¿nge
(
¦Ù
, 
u64
 *
addr
, u64 *
size
)

736 
i
;

738 ià(
¦Ù
 < 0 || slÙ >ğ
e820
.
Ä_m­
)

740 
i
 = 
¦Ù
; i < 
e820
.
Ä_m­
; i++) {

741 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
)

745 ià(
i
 =ğ
e820
.
Ä_m­
 ||ƒ820.
m­
[i].
addr
 > (
max_pâ
 << 
PAGE_SHIFT
))

747 *
addr
 = 
e820
.
m­
[
i
].addr;

748 *
size
 = 
	`mš_t
(
u64
, 
e820
.
m­
[
i
].siz+ƒ820.m­[i].
addr
,

749 
max_pâ
 << 
PAGE_SHIFT
è- *
addr
;

750  
i
 + 1;

751 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<lšux/pci.h
>

13 
	~<lšux/aıi.h
>

14 
	~<lšux/pci_ids.h
>

15 
	~<asm/pci-dœeù.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_­ic.h
>

18 
	~<asm/­ic.h
>

20 #ifdeà
CONFIG_GART_IOMMU


21 
	~<asm/g¬t.h
>

24 
__š™
 
	$vŸ_bugs
()

26 #ifdeà
CONFIG_GART_IOMMU


27 ià((
’d_pâ
 > 
MAX_DMA32_PFN
 || 
fÜû_iommu
) &&

28 !
g¬t_iommu_­”tu»_®lowed
) {

29 
	`´štk
(
KERN_INFO


32 
g¬t_iommu_­”tu»_di§bËd
 = 1;

35 
	}
}

37 #ifdeà
CONFIG_ACPI


38 #ifdeà
CONFIG_X86_IO_APIC


40 
__š™
 
	$nvidŸ_h³t_check
(
aıi_bË_h—d”
 *
h—d”
)

43 
	}
}

47 
__š™
 
	$nvidŸ_bugs
()

49 #ifdeà
CONFIG_ACPI


50 #ifdeà
CONFIG_X86_IO_APIC


58 ià(
aıi_u£_tim”_ov”ride
)

61 ià(
	`aıi_bË_·r£
(
ACPI_SIG_HPET
, 
nvidŸ_h³t_check
)) {

62 
aıi_sk_tim”_ov”ride
 = 1;

63 
	`´štk
(
KERN_INFO
 "Nvidia board "

66 
	`´štk
(
KERN_INFO
 "If you gotimerrouble "

73 
	}
}

75 
__š™
 
	$©i_bugs
()

77 #ifdeà
CONFIG_X86_IO_APIC


78 ià(
tim”_ov”_8254
 == 1) {

79 
tim”_ov”_8254
 = 0;

80 
	`´štk
(
KERN_INFO


84 
	}
}

86 
	sch£t
 {

87 
u16
 
	mv’dÜ
;

88 (*
	mf
)();

91 
ch£t
 
	g—¾y_qrk
[] 
	g__š™d©a
 = {

92 { 
PCI_VENDOR_ID_NVIDIA
, 
nvidŸ_bugs
 },

93 { 
PCI_VENDOR_ID_VIA
, 
vŸ_bugs
 },

94 { 
PCI_VENDOR_ID_ATI
, 
©i_bugs
 },

98 
__š™
 
	$—¾y_quœks
()

100 
num
, 
¦Ù
, 
func
;

102 ià(!
	`—¾y_pci_®lowed
())

106 
num
 = 0;‚um < 32;‚um++) {

107 
¦Ù
 = 0; slot < 32; slot++) {

108 
func
 = 0; func < 8; func++) {

109 
u32
 
şass
;

110 
u32
 
v’dÜ
;

111 
u8
 
ty³
;

112 
i
;

113 
şass
 = 
	`»ad_pci_cÚfig
(
num
,
¦Ù
,
func
,

114 
PCI_CLASS_REVISION
);

115 ià(
şass
 == 0xffffffff)

118 ià((
şass
 >> 16è!ğ
PCI_CLASS_BRIDGE_PCI
)

121 
v’dÜ
 = 
	`»ad_pci_cÚfig
(
num
, 
¦Ù
, 
func
,

122 
PCI_VENDOR_ID
);

123 
v’dÜ
 &= 0xffff;

125 
i
 = 0; 
—¾y_qrk
[i].
f
; i++)

126 ià(
—¾y_qrk
[
i
].
v’dÜ
 == vendor) {

127 
—¾y_qrk
[
i
].
	`f
();

131 
ty³
 = 
	`»ad_pci_cÚfig_by‹
(
num
, 
¦Ù
, 
func
,

132 
PCI_HEADER_TYPE
);

133 ià(!(
ty³
 & 0x80))

138 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<lšux/cÚsŞe.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/š™.h
>

4 
	~<lšux/¡ršg.h
>

5 
	~<lšux/sü“n_šfo.h
>

6 
	~<asm/io.h
>

7 
	~<asm/´oûssÜ.h
>

8 
	~<asm/fú.h
>

9 
	~<asm/£tup.h
>

10 
	~<x’/hvc-cÚsŞe.h
>

13 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

15 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

16 
	gcu¼’t_ypos
 = 25, 
	gcu¼’t_xpos
 = 0;

18 
	$—¾y_vga_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
¡r
, 
n
)

20 
c
;

21 
i
, 
k
, 
j
;

23 (
c
 = *
¡r
++è!ğ'\0' && 
n
-- > 0) {

24 ià(
cu¼’t_ypos
 >ğ
max_ypos
) {

26 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

27 
i
 = 0; i < 
max_xpos
; i++) {

28 
	`wr™ew
(
	`»adw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

29 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

32 
i
 = 0; i < 
max_xpos
; i++)

33 
	`wr™ew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

34 
cu¼’t_ypos
 = 
max_ypos
-1;

36 ià(
c
 == '\n') {

37 
cu¼’t_xpos
 = 0;

38 
cu¼’t_ypos
++;

39 } ià(
c
 != '\r') {

40 
	`wr™ew
(((0x7 << 8è| (è
c
),

41 
VGABASE
 + 2*(
max_xpos
*
cu¼’t_ypos
 +

42 
cu¼’t_xpos
++));

43 ià(
cu¼’t_xpos
 >ğ
max_xpos
) {

44 
cu¼’t_xpos
 = 0;

45 
cu¼’t_ypos
++;

49 
	}
}

51 
cÚsŞe
 
	g—¾y_vga_cÚsŞe
 = {

52 .
Çme
 = "earlyvga",

53 .
	gwr™e
 = 
—¾y_vga_wr™e
,

54 .
	gæags
 = 
CON_PRINTBUFFER
,

55 .
	gšdex
 = -1,

60 
	g—¾y_£rŸl_ba£
 = 0x3f8;

62 
	#XMTRDY
 0x20

	)

64 
	#DLAB
 0x80

	)

66 
	#TXR
 0

	)

67 
	#RXR
 0

	)

68 
	#IER
 1

	)

69 
	#IIR
 2

	)

70 
	#FCR
 2

	)

71 
	#LCR
 3

	)

72 
	#MCR
 4

	)

73 
	#LSR
 5

	)

74 
	#MSR
 6

	)

75 
	#DLL
 0

	)

76 
	#DLH
 1

	)

78 
	$—¾y_£rŸl_putc
(
ch
)

80 
timeout
 = 0xffff;

81 (
	`šb
(
—¾y_£rŸl_ba£
 + 
LSR
è& 
XMTRDY
è=ğ0 && --
timeout
)

82 
	`ıu_»Ïx
();

83 
	`outb
(
ch
, 
—¾y_£rŸl_ba£
 + 
TXR
);

84  
timeout
 ? 0 : -1;

85 
	}
}

87 
	$—¾y_£rŸl_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
s
, 
n
)

89 *
s
 && 
n
-- > 0) {

90 ià(*
s
 == '\n')

91 
	`—¾y_£rŸl_putc
('\r');

92 
	`—¾y_£rŸl_putc
(*
s
);

93 
s
++;

95 
	}
}

97 
	#DEFAULT_BAUD
 9600

	)

99 
__š™
 
	$—¾y_£rŸl_š™
(*
s
)

101 
c
;

102 
divisÜ
;

103 
baud
 = 
DEFAULT_BAUD
;

104 *
e
;

106 ià(*
s
 == ',')

107 ++
s
;

109 ià(*
s
) {

110 
pÜt
;

111 ià(!
	`¡ºcmp
(
s
,"0x",2)) {

112 
—¾y_£rŸl_ba£
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 16);

114 
ba£s
[] = { 0x3f8, 0x2f8 };

116 ià(!
	`¡ºcmp
(
s
,"ttyS",4))

117 
s
 += 4;

118 
pÜt
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 10);

119 ià(
pÜt
 > 1 || 
s
 =ğ
e
)

120 
pÜt
 = 0;

121 
—¾y_£rŸl_ba£
 = 
ba£s
[
pÜt
];

123 
s
 +ğ
	`¡rc¥n
(s, ",");

124 ià(*
s
 == ',')

125 
s
++;

128 
	`outb
(0x3, 
—¾y_£rŸl_ba£
 + 
LCR
);

129 
	`outb
(0, 
—¾y_£rŸl_ba£
 + 
IER
);

130 
	`outb
(0, 
—¾y_£rŸl_ba£
 + 
FCR
);

131 
	`outb
(0x3, 
—¾y_£rŸl_ba£
 + 
MCR
);

133 ià(*
s
) {

134 
baud
 = 
	`sim¶e_¡¹oul
(
s
, &
e
, 0);

135 ià(
baud
 =ğ0 || 
s
 =ğ
e
)

136 
baud
 = 
DEFAULT_BAUD
;

139 
divisÜ
 = 115200 / 
baud
;

140 
c
 = 
	`šb
(
—¾y_£rŸl_ba£
 + 
LCR
);

141 
	`outb
(
c
 | 
DLAB
, 
—¾y_£rŸl_ba£
 + 
LCR
);

142 
	`outb
(
divisÜ
 & 0xff, 
—¾y_£rŸl_ba£
 + 
DLL
);

143 
	`outb
((
divisÜ
 >> 8è& 0xff, 
—¾y_£rŸl_ba£
 + 
DLH
);

144 
	`outb
(
c
 & ~
DLAB
, 
—¾y_£rŸl_ba£
 + 
LCR
);

145 
	}
}

147 
cÚsŞe
 
	g—¾y_£rŸl_cÚsŞe
 = {

148 .
Çme
 = "earlyser",

149 .
	gwr™e
 = 
—¾y_£rŸl_wr™e
,

150 .
	gæags
 = 
CON_PRINTBUFFER
,

151 .
	gšdex
 = -1,

156 
	gsimnow_fd
;

159 
	mMAGIC1
 = 0xBACCD00A,

160 
	mMAGIC2
 = 0xCA110000,

161 
	mXOPEN
 = 5,

162 
	mXWRITE
 = 4,

165 
nošlše
 
	$simnow
(
cmd
, 
a
, 
b
, 
c
)

167 
»t
;

168 
asm
 volatile("cpuid" :

169 "÷" (
»t
) :

170 "b" (
a
), "c" (
b
), "d" (
c
), "0" (
MAGIC1
), "D" (
cmd
 + 
MAGIC2
));

171  
»t
;

172 
	}
}

174 
__š™
 
	$simnow_š™
(*
¡r
)

176 *
â
 = "klog";

177 ià(*
¡r
 == '=')

178 
â
 = ++
¡r
;

180 
simnow_fd
 = 
	`simnow
(
XOPEN
, ()
â
, 
O_WRONLY
|
O_APPEND
|
O_CREAT
, 0644);

181 
	}
}

183 
	$simnow_wr™e
(
cÚsŞe
 *
cÚ
, cÚ¡ *
s
, 
n
)

185 
	`simnow
(
XWRITE
, 
simnow_fd
, ()
s
, 
n
);

186 
	}
}

188 
cÚsŞe
 
	gsimnow_cÚsŞe
 = {

189 .
Çme
 = "simnow",

190 .
	gwr™e
 = 
simnow_wr™e
,

191 .
	gæags
 = 
CON_PRINTBUFFER
,

192 .
	gšdex
 = -1,

196 
cÚsŞe
 *
	g—¾y_cÚsŞe
 = &
—¾y_vga_cÚsŞe
;

197 
	g—¾y_cÚsŞe_š™Ÿlized
 = 0;

199 
	$—¾y_´štk
(cÚ¡ *
fmt
, ...)

201 
buf
[512];

202 
n
;

203 
va_li¡
 
­
;

205 
	`va_¡¬t
(
­
,
fmt
);

206 
n
 = 
	`vsú´štf
(
buf
,512,
fmt
,
­
);

207 
—¾y_cÚsŞe
->
	`wr™e
Ó¬ly_cÚsŞe,
buf
,
n
);

208 
	`va_’d
(
­
);

209 
	}
}

211 
__š™d©a
 
	gk“p_—¾y
;

213 
__š™
 
	$£tup_—¾y_´štk
(*
buf
)

215 ià(!
buf
)

218 ià(
—¾y_cÚsŞe_š™Ÿlized
)

220 
—¾y_cÚsŞe_š™Ÿlized
 = 1;

222 ià(
	`¡r¡r
(
buf
, "keep"))

223 
k“p_—¾y
 = 1;

225 ià(!
	`¡ºcmp
(
buf
, "serial", 6)) {

226 
	`—¾y_£rŸl_š™
(
buf
 + 6);

227 
—¾y_cÚsŞe
 = &
—¾y_£rŸl_cÚsŞe
;

228 } ià(!
	`¡ºcmp
(
buf
, "ttyS", 4)) {

229 
	`—¾y_£rŸl_š™
(
buf
);

230 
—¾y_cÚsŞe
 = &
—¾y_£rŸl_cÚsŞe
;

231 } ià(!
	`¡ºcmp
(
buf
, "vga", 3)

232 && 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_isVGA
 == 1) {

233 
max_xpos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_cŞs
;

234 
max_ypos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_video_lšes
;

235 
cu¼’t_ypos
 = 
boÙ_·¿ms
.
sü“n_šfo
.
Üig_y
;

236 
—¾y_cÚsŞe
 = &
—¾y_vga_cÚsŞe
;

237 } ià(!
	`¡ºcmp
(
buf
, "simnow", 6)) {

238 
	`simnow_š™
(
buf
 + 6);

239 
—¾y_cÚsŞe
 = &
simnow_cÚsŞe
;

240 
k“p_—¾y
 = 1;

241 #ifdeà
CONFIG_HVC_XEN


242 } ià(!
	`¡ºcmp
(
buf
, "xen", 3)) {

243 
—¾y_cÚsŞe
 = &
x’boÙ_cÚsŞe
;

247 ià(
k“p_—¾y
)

248 
—¾y_cÚsŞe
->
æags
 &ğ~
CON_BOOT
;

250 
—¾y_cÚsŞe
->
æags
 |ğ
CON_BOOT
;

251 
	`»gi¡”_cÚsŞe
(
—¾y_cÚsŞe
);

253 
	}
}

254 
—¾y_·¿m
("—¾y´štk", 
£tup_—¾y_´štk
);

	@/cmpt816/linux/arch/x86/kernel/genapic_64.c

11 
	~<lšux/th»ads.h
>

12 
	~<lšux/ıumask.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/ùy³.h
>

17 
	~<lšux/š™.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/i.h
>

21 
	~<asm/g’­ic.h
>

23 #ifdeà
CONFIG_ACPI


24 
	~<aıi/aıi_bus.h
>

35 
u8
 
	gx86_ıu_to_­icid_š™
[
NR_CPUS
] 
	g__š™d©a


36 ğ{ [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

37 *
	gx86_ıu_to_­icid_±r
;

38 
DEFINE_PER_CPU
(
u8
, 
x86_ıu_to_­icid
èğ
BAD_APICID
;

39 
EXPORT_PER_CPU_SYMBOL
(
x86_ıu_to_­icid
);

41 
g’­ic
 
__»ad_mo¡ly
 *
	gg’­ic
 = &
­ic_æ©
;

46 
__š™
 
	$£tup_­ic_routšg
()

48 #ifdeà
CONFIG_ACPI


54 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 > 
FADT2_REVISION_ID
 &&

55 (
aıi_gbl_FADT
.
æags
 & 
ACPI_FADT_APIC_PHYSICAL
))

56 
g’­ic
 = &
­ic_physæ©
;

60 ià(
	`ıus_weight
(
ıu_possibË_m­
) <= 8)

61 
g’­ic
 = &
­ic_æ©
;

63 
g’­ic
 = &
­ic_physæ©
;

65 
	`´štk
(
KERN_INFO
 "S‘tšg APIC„outšgØ%s\n", 
g’­ic
->
Çme
);

66 
	}
}

70 
	$£nd_IPI_£lf
(
veùÜ
)

72 
	`__£nd_IPI_shÜtcut
(
APIC_DEST_SELF
, 
veùÜ
, 
APIC_DEST_PHYSICAL
);

73 
	}
}

	@/cmpt816/linux/arch/x86/kernel/genapic_flat_64.c

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/th»ads.h
>

13 
	~<lšux/ıumask.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/ùy³.h
>

17 
	~<lšux/š™.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/i.h
>

20 
	~<asm/g’­ic.h
>

22 
ıumask_t
 
	$æ©_rg‘_ıus
()

24  
ıu_Úlše_m­
;

25 
	}
}

27 
ıumask_t
 
	$æ©_veùÜ_®loÿtiÚ_domaš
(
ıu
)

37 
ıumask_t
 
domaš
 = { { [0] = 
APIC_ALL_CPUS
, } };

38  
domaš
;

39 
	}
}

48 
	$æ©_š™_­ic_ldr
()

50 
v®
;

51 
num
, 
id
;

53 
num
 = 
	`smp_´oûssÜ_id
();

54 
id
 = 1UL << 
num
;

55 
	`­ic_wr™e
(
APIC_DFR
, 
APIC_DFR_FLAT
);

56 
v®
 = 
	`­ic_»ad
(
APIC_LDR
è& ~
APIC_LDR_MASK
;

57 
v®
 |ğ
	`SET_APIC_LOGICAL_ID
(
id
);

58 
	`­ic_wr™e
(
APIC_LDR
, 
v®
);

59 
	}
}

61 
	$æ©_£nd_IPI_mask
(
ıumask_t
 
ıumask
, 
veùÜ
)

63 
mask
 = 
	`ıus_addr
(
ıumask
)[0];

64 
æags
;

66 
	`loÿl_œq_§ve
(
æags
);

67 
	`__£nd_IPI_de¡_f›ld
(
mask
, 
veùÜ
, 
APIC_DEST_LOGICAL
);

68 
	`loÿl_œq_»¡Üe
(
æags
);

69 
	}
}

71 
	$æ©_£nd_IPI_®lbut£lf
(
veùÜ
)

73 #ifdef 
CONFIG_HOTPLUG_CPU


74 
hÙ¶ug
 = 1;

76 
hÙ¶ug
 = 0;

78 ià(
hÙ¶ug
 || 
veùÜ
 =ğ
NMI_VECTOR
) {

79 
ıumask_t
 
®lbutme
 = 
ıu_Úlše_m­
;

81 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbutme
);

83 ià(!
	`ıus_em±y
(
®lbutme
))

84 
	`æ©_£nd_IPI_mask
(
®lbutme
, 
veùÜ
);

85 } ià(
	`num_Úlše_ıus
() > 1) {

86 
	`__£nd_IPI_shÜtcut
(
APIC_DEST_ALLBUT
, 
veùÜ
,
APIC_DEST_LOGICAL
);

88 
	}
}

90 
	$æ©_£nd_IPI_®l
(
veùÜ
)

92 ià(
veùÜ
 =ğ
NMI_VECTOR
)

93 
	`æ©_£nd_IPI_mask
(
ıu_Úlše_m­
, 
veùÜ
);

95 
	`__£nd_IPI_shÜtcut
(
APIC_DEST_ALLINC
, 
veùÜ
, 
APIC_DEST_LOGICAL
);

96 
	}
}

98 
	$æ©_­ic_id_»gi¡”ed
()

100  
	`physid_is£t
(
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
)), 
phys_ıu_´e£Á_m­
);

101 
	}
}

103 
	$æ©_ıu_mask_to_­icid
(
ıumask_t
 
ıumask
)

105  
	`ıus_addr
(
ıumask
)[0] & 
APIC_ALL_CPUS
;

106 
	}
}

108 
	$phys_pkg_id
(
šdex_msb
)

110  
	`h¬d_smp_´oûssÜ_id
(è>> 
šdex_msb
;

111 
	}
}

113 
g’­ic
 
	g­ic_æ©
 = {

114 .
Çme
 = "flat",

115 .
	gšt_d–iv”y_mode
 = 
de¡_Lowe¡Prio
,

116 .
	gšt_de¡_mode
 = (
APIC_DEST_LOGICAL
 != 0),

117 .
	grg‘_ıus
 = 
æ©_rg‘_ıus
,

118 .
	gveùÜ_®loÿtiÚ_domaš
 = 
æ©_veùÜ_®loÿtiÚ_domaš
,

119 .
	g­ic_id_»gi¡”ed
 = 
æ©_­ic_id_»gi¡”ed
,

120 .
	gš™_­ic_ldr
 = 
æ©_š™_­ic_ldr
,

121 .
	g£nd_IPI_®l
 = 
æ©_£nd_IPI_®l
,

122 .
	g£nd_IPI_®lbut£lf
 = 
æ©_£nd_IPI_®lbut£lf
,

123 .
	g£nd_IPI_mask
 = 
æ©_£nd_IPI_mask
,

124 .
	gıu_mask_to_­icid
 = 
æ©_ıu_mask_to_­icid
,

125 .
	gphys_pkg_id
 = 
phys_pkg_id
,

134 
ıumask_t
 
	$physæ©_rg‘_ıus
()

136  
ıu_Úlše_m­
;

137 
	}
}

139 
ıumask_t
 
	$physæ©_veùÜ_®loÿtiÚ_domaš
(
ıu
)

141 
ıumask_t
 
domaš
 = 
CPU_MASK_NONE
;

142 
	`ıu_£t
(
ıu
, 
domaš
);

143  
domaš
;

144 
	}
}

147 
	$physæ©_£nd_IPI_mask
(
ıumask_t
 
ıumask
, 
veùÜ
)

149 
	`£nd_IPI_mask_£qu’û
(
ıumask
, 
veùÜ
);

150 
	}
}

152 
	$physæ©_£nd_IPI_®lbut£lf
(
veùÜ
)

154 
ıumask_t
 
®lbutme
 = 
ıu_Úlše_m­
;

156 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbutme
);

157 
	`physæ©_£nd_IPI_mask
(
®lbutme
, 
veùÜ
);

158 
	}
}

160 
	$physæ©_£nd_IPI_®l
(
veùÜ
)

162 
	`physæ©_£nd_IPI_mask
(
ıu_Úlše_m­
, 
veùÜ
);

163 
	}
}

165 
	$physæ©_ıu_mask_to_­icid
(
ıumask_t
 
ıumask
)

167 
ıu
;

173 
ıu
 = 
	`fœ¡_ıu
(
ıumask
);

174 ià(()
ıu
 < 
NR_CPUS
)

175  
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
);

177  
BAD_APICID
;

178 
	}
}

180 
g’­ic
 
	g­ic_physæ©
 = {

181 .
Çme
 = "physical flat",

182 .
	gšt_d–iv”y_mode
 = 
de¡_Fixed
,

183 .
	gšt_de¡_mode
 = (
APIC_DEST_PHYSICAL
 != 0),

184 .
	grg‘_ıus
 = 
physæ©_rg‘_ıus
,

185 .
	gveùÜ_®loÿtiÚ_domaš
 = 
physæ©_veùÜ_®loÿtiÚ_domaš
,

186 .
	g­ic_id_»gi¡”ed
 = 
æ©_­ic_id_»gi¡”ed
,

187 .
	gš™_­ic_ldr
 = 
æ©_š™_­ic_ldr
,

188 .
	g£nd_IPI_®l
 = 
physæ©_£nd_IPI_®l
,

189 .
	g£nd_IPI_®lbut£lf
 = 
physæ©_£nd_IPI_®lbut£lf
,

190 .
	g£nd_IPI_mask
 = 
physæ©_£nd_IPI_mask
,

191 .
	gıu_mask_to_­icid
 = 
physæ©_ıu_mask_to_­icid
,

192 .
	gphys_pkg_id
 = 
phys_pkg_id
,

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<lšux/š™.h
>

8 
	~<lšux/lškage.h
>

9 
	~<lšux/ty³s.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/³rıu.h
>

14 
	~<asm/´oûssÜ.h
>

15 
	~<asm/´Ùo.h
>

16 
	~<asm/smp.h
>

17 
	~<asm/£tup.h
>

18 
	~<asm/desc.h
>

19 
	~<asm/pgbË.h
>

20 
	~<asm/bæush.h
>

21 
	~<asm/£ùiÚs.h
>

23 
__š™
 
	$z­_id’t™y_m­pšgs
()

25 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

26 
	`pgd_ş—r
(
pgd
);

27 
	`__æush_b
();

28 
	}
}

32 
__š™
 
	$ş—r_bss
()

34 
	`mem£t
(
__bss_¡¬t
, 0,

35 (è
__bss_¡İ
 - (è
__bss_¡¬t
);

36 
	}
}

38 
__š™
 
	$cİy_boÙd©a
(*
»®_mode_d©a
)

40 * 
commªd_lše
;

42 
	`memıy
(&
boÙ_·¿ms
, 
»®_mode_d©a
,  boot_params);

43 ià(
boÙ_·¿ms
.
hdr
.
cmd_lše_±r
) {

44 
commªd_lše
 = 
	`__va
(
boÙ_·¿ms
.
hdr
.
cmd_lše_±r
);

45 
	`memıy
(
boÙ_commªd_lše
, 
commªd_lše
, 
COMMAND_LINE_SIZE
);

47 
	}
}

49 
__š™
 
	$x86_64_¡¬t_k”Ãl
(* 
»®_mode_d©a
)

51 
i
;

54 
	`ş—r_bss
();

57 
	`z­_id’t™y_m­pšgs
();

59 
i
 = 0; i < 
IDT_ENTRIES
; i++)

60 
	`£t_šŒ_g©e
(
i
, 
—¾y_idt_hªdËr
);

61 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
idt_desü
);

63 
	`—¾y_´štk
("Kernel‡live\n");

65 
i
 = 0; i < 
NR_CPUS
; i++)

66 
	`ıu_pda
(
i
èğ&
boÙ_ıu_pda
[i];

68 
	`pda_š™
(0);

69 
	`cİy_boÙd©a
(
	`__va
(
»®_mode_d©a
));

70 #ifdeà
CONFIG_SMP


71 
	`ıu_£t
(0, 
ıu_Úlše_m­
);

73 
	`¡¬t_k”Ãl
();

74 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<lšux/şocksourû.h
>

2 
	~<lšux/şockchs.h
>

3 
	~<lšux/d–ay.h
>

4 
	~<lšux/”ºo.h
>

5 
	~<lšux/h³t.h
>

6 
	~<lšux/š™.h
>

7 
	~<lšux/sysdev.h
>

8 
	~<lšux/pm.h
>

9 
	~<lšux/d–ay.h
>

11 
	~<asm/fixm­.h
>

12 
	~<asm/h³t.h
>

13 
	~<asm/i8253.h
>

14 
	~<asm/io.h
>

16 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

17 
	#HPET_SHIFT
 22

	)

20 
	#FSEC_PER_NSEC
 1000000

	)

25 
	gh³t_add»ss
;

26 
__iomem
 *
	gh³t_vœt_add»ss
;

28 
	$h³t_»adl
(
a
)

30  
	`»adl
(
h³t_vœt_add»ss
 + 
a
);

31 
	}
}

33 
šlše
 
	$h³t_wr™–
(
d
, 
a
)

35 
	`wr™–
(
d
, 
h³t_vœt_add»ss
 + 
a
);

36 
	}
}

38 #ifdeà
CONFIG_X86_64


40 
	~<asm/pgbË.h
>

42 
šlše
 
	$h³t_£t_m­pšg
()

44 
	`£t_fixm­_noÿche
(
FIX_HPET_BASE
, 
h³t_add»ss
);

45 
	`__£t_fixm­
(
VSYSCALL_HPET
, 
h³t_add»ss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

46 
h³t_vœt_add»ss
 = (
__iomem
 *)
	`fix_to_vœt
(
FIX_HPET_BASE
);

47 
	}
}

49 
šlše
 
	$h³t_ş—r_m­pšg
()

51 
h³t_vœt_add»ss
 = 
NULL
;

52 
	}
}

56 
šlše
 
	$h³t_£t_m­pšg
()

58 
h³t_vœt_add»ss
 = 
	`iÜem­_noÿche
(
h³t_add»ss
, 
HPET_MMAP_SIZE
);

59 
	}
}

61 
šlše
 
	$h³t_ş—r_m­pšg
()

63 
	`iounm­
(
h³t_vœt_add»ss
);

64 
h³t_vœt_add»ss
 = 
NULL
;

65 
	}
}

71 
	gboÙ_h³t_di§bË
;

72 
	gh³t_fÜû_u£r
;

74 
__š™
 
	$h³t_£tup
(* 
¡r
)

76 ià(
¡r
) {

77 ià(!
	`¡ºcmp
("di§bË", 
¡r
, 7))

78 
boÙ_h³t_di§bË
 = 1;

79 ià(!
	`¡ºcmp
("fÜû", 
¡r
, 5))

80 
h³t_fÜû_u£r
 = 1;

83 
	}
}

84 
__£tup
("h³t=", 
h³t_£tup
);

86 
__š™
 
	$di§bË_h³t
(*
¡r
)

88 
boÙ_h³t_di§bË
 = 1;

90 
	}
}

91 
__£tup
("noh³t", 
di§bË_h³t
);

93 
šlše
 
	$is_h³t_ÿ·bË
()

95  (!
boÙ_h³t_di§bË
 && 
h³t_add»ss
);

96 
	}
}

101 
	gh³t_Ëgacy_št_’abËd
;

106 
	$is_h³t_’abËd
()

108  
	`is_h³t_ÿ·bË
(è&& 
h³t_Ëgacy_št_’abËd
;

109 
	}
}

115 #ifdeà
CONFIG_HPET


116 
	$h³t_»£rve_¶©fÜm_tim”s
(
id
)

118 
h³t
 
__iomem
 *h³ˆğ
h³t_vœt_add»ss
;

119 
h³t_tim”
 
__iomem
 *
tim”
 = &
h³t
->
h³t_tim”s
[2];

120 
Ätim”s
, 
i
;

121 
h³t_d©a
 
hd
;

123 
Ätim”s
 = ((
id
 & 
HPET_ID_NUMBER
è>> 
HPET_ID_NUMBER_SHIFT
) + 1;

125 
	`mem£t
(&
hd
, 0,  (hd));

126 
hd
.
hd_phys_add»ss
 = 
h³t_add»ss
;

127 
hd
.
hd_add»ss
 = 
h³t
;

128 
hd
.
hd_nœqs
 = 
Ätim”s
;

129 
hd
.
hd_æags
 = 
HPET_DATA_PLATFORM
;

130 
	`h³t_»£rve_tim”
(&
hd
, 0);

132 #ifdeà
CONFIG_HPET_EMULATE_RTC


133 
	`h³t_»£rve_tim”
(&
hd
, 1);

136 
hd
.
hd_œq
[0] = 
HPET_LEGACY_8254
;

137 
hd
.
hd_œq
[1] = 
HPET_LEGACY_RTC
;

139 
i
 = 2; i < 
Ätim”s
; 
tim”
++, i++)

140 
hd
.
hd_œq
[
i
] = (
tim”
->
h³t_cÚfig
 & 
Tn_INT_ROUTE_CNF_MASK
) >>

141 
Tn_INT_ROUTE_CNF_SHIFT
;

143 
	`h³t_®loc
(&
hd
);

145 
	}
}

147 
	$h³t_»£rve_¶©fÜm_tim”s
(
id
è{ 
	}
}

153 
	gh³t_³riod
;

155 
h³t_Ëgacy_£t_mode
(
şock_ev’t_mode
 
mode
,

156 
şock_ev’t_deviû
 *
evt
);

157 
h³t_Ëgacy_Ãxt_ev’t
(
d–
,

158 
şock_ev’t_deviû
 *
evt
);

163 
şock_ev’t_deviû
 
	gh³t_şockev’t
 = {

164 .
Çme
 = "hpet",

165 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

166 .
	g£t_mode
 = 
h³t_Ëgacy_£t_mode
,

167 .
	g£t_Ãxt_ev’t
 = 
h³t_Ëgacy_Ãxt_ev’t
,

168 .
	gshiá
 = 32,

169 .
	gœq
 = 0,

170 .
	g¿tšg
 = 50,

173 
	$h³t_¡¬t_couÁ”
()

175 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

177 
cfg
 &ğ~
HPET_CFG_ENABLE
;

178 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

179 
	`h³t_wr™–
(0, 
HPET_COUNTER
);

180 
	`h³t_wr™–
(0, 
HPET_COUNTER
 + 4);

181 
cfg
 |ğ
HPET_CFG_ENABLE
;

182 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

183 
	}
}

185 
	$h³t_»sume_deviû
()

187 
	`fÜû_h³t_»sume
();

188 
	}
}

190 
	$h³t_»¡¬t_couÁ”
()

192 
	`h³t_»sume_deviû
();

193 
	`h³t_¡¬t_couÁ”
();

194 
	}
}

196 
	$h³t_’abË_Ëgacy_št
()

198 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

200 
cfg
 |ğ
HPET_CFG_LEGACY
;

201 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

202 
h³t_Ëgacy_št_’abËd
 = 1;

203 
	}
}

205 
	$h³t_Ëgacy_şockev’t_»gi¡”
()

207 
ušt64_t
 
h³t_äeq
;

210 
	`h³t_’abË_Ëgacy_št
();

217 
h³t_äeq
 = 1000000000000000ULL;

218 
	`do_div
(
h³t_äeq
, 
h³t_³riod
);

219 
h³t_şockev’t
.
muÉ
 = 
	`div_sc
((è
h³t_äeq
,

220 
NSEC_PER_SEC
, 32);

222 
h³t_şockev’t
.
max_d–_ns
 = 
	`şockev’t_d–2ns
(0x7FFFFFFF,

223 &
h³t_şockev’t
);

224 
h³t_şockev’t
.
mš_d–_ns
 = 
	`şockev’t_d–2ns
(0x30,

225 &
h³t_şockev’t
);

231 
h³t_şockev’t
.
ıumask
 = 
	`ıumask_of_ıu
(
	`smp_´oûssÜ_id
());

232 
	`şockev’ts_»gi¡”_deviû
(&
h³t_şockev’t
);

233 
glob®_şock_ev’t
 = &
h³t_şockev’t
;

234 
	`´štk
(
KERN_DEBUG
 "hpet clockevent„egistered\n");

235 
	}
}

237 
	$h³t_Ëgacy_£t_mode
(
şock_ev’t_mode
 
mode
,

238 
şock_ev’t_deviû
 *
evt
)

240 
cfg
, 
cmp
, 
now
;

241 
ušt64_t
 
d–
;

243 
mode
) {

244 
CLOCK_EVT_MODE_PERIODIC
:

245 
d–
 = ((
ušt64_t
)(
NSEC_PER_SEC
/
HZ
)è* 
h³t_şockev’t
.
muÉ
;

246 
d–
 >>ğ
h³t_şockev’t
.
shiá
;

247 
now
 = 
	`h³t_»adl
(
HPET_COUNTER
);

248 
cmp
 = 
now
 + (è
d–
;

249 
cfg
 = 
	`h³t_»adl
(
HPET_T0_CFG
);

250 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

251 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

252 
	`h³t_wr™–
(
cfg
, 
HPET_T0_CFG
);

258 
	`h³t_wr™–
(
cmp
, 
HPET_T0_CMP
);

259 
	`ud–ay
(1);

260 
	`h³t_wr™–
((è
d–
, 
HPET_T0_CMP
);

263 
CLOCK_EVT_MODE_ONESHOT
:

264 
cfg
 = 
	`h³t_»adl
(
HPET_T0_CFG
);

265 
cfg
 &ğ~
HPET_TN_PERIODIC
;

266 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

267 
	`h³t_wr™–
(
cfg
, 
HPET_T0_CFG
);

270 
CLOCK_EVT_MODE_UNUSED
:

271 
CLOCK_EVT_MODE_SHUTDOWN
:

272 
cfg
 = 
	`h³t_»adl
(
HPET_T0_CFG
);

273 
cfg
 &ğ~
HPET_TN_ENABLE
;

274 
	`h³t_wr™–
(
cfg
, 
HPET_T0_CFG
);

277 
CLOCK_EVT_MODE_RESUME
:

278 
	`h³t_’abË_Ëgacy_št
();

281 
	}
}

283 
	$h³t_Ëgacy_Ãxt_ev’t
(
d–
,

284 
şock_ev’t_deviû
 *
evt
)

286 
út
;

288 
út
 = 
	`h³t_»adl
(
HPET_COUNTER
);

289 
út
 +ğ
d–
;

290 
	`h³t_wr™–
(
út
, 
HPET_T0_CMP
);

292  (()(
	`h³t_»adl
(
HPET_COUNTER
è- 
út
 ) > 0è? -
ETIME
 : 0;

293 
	}
}

298 
cyşe_t
 
	$»ad_h³t
()

300  (
cyşe_t
)
	`h³t_»adl
(
HPET_COUNTER
);

301 
	}
}

303 #ifdeà
CONFIG_X86_64


304 
cyşe_t
 
__vsysÿÎ_â
 
	$v»ad_h³t
()

306  
	`»adl
((cÚ¡ 
__iomem
 *)
	`fix_to_vœt
(
VSYSCALL_HPET
) + 0xf0);

307 
	}
}

310 
şocksourû
 
	gşocksourû_h³t
 = {

311 .
Çme
 = "hpet",

312 .
	g¿tšg
 = 250,

313 .
	g»ad
 = 
»ad_h³t
,

314 .
	gmask
 = 
HPET_MASK
,

315 .
	gshiá
 = 
HPET_SHIFT
,

316 .
	gæags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

317 .
	g»sume
 = 
h³t_»¡¬t_couÁ”
,

318 #ifdeà
CONFIG_X86_64


319 .
	gv»ad
 = 
v»ad_h³t
,

323 
	$h³t_şocksourû_»gi¡”
()

325 
u64
 
tmp
, 
¡¬t
, 
now
;

326 
cyşe_t
 
t1
;

329 
	`h³t_¡¬t_couÁ”
();

332 
t1
 = 
	`»ad_h³t
();

333 
	`rdtsşl
(
¡¬t
);

342 
	`»p_nİ
();

343 
	`rdtsşl
(
now
);

344 } (
now
 - 
¡¬t
) < 200000UL);

346 ià(
t1
 =ğ
	`»ad_h³t
()) {

347 
	`´štk
(
KERN_WARNING


349  -
ENODEV
;

364 
tmp
 = (
u64
)
h³t_³riod
 << 
HPET_SHIFT
;

365 
	`do_div
(
tmp
, 
FSEC_PER_NSEC
);

366 
şocksourû_h³t
.
muÉ
 = (
u32
)
tmp
;

368 
	`şocksourû_»gi¡”
(&
şocksourû_h³t
);

371 
	}
}

376 
__š™
 
	$h³t_’abË
()

378 
id
;

380 ià(!
	`is_h³t_ÿ·bË
())

383 
	`h³t_£t_m­pšg
();

388 
h³t_³riod
 = 
	`h³t_»adl
(
HPET_PERIOD
);

389 ià(
h³t_³riod
 < 
HPET_MIN_PERIOD
 || h³t_³riod > 
HPET_MAX_PERIOD
)

390 
out_noh³t
;

396 
id
 = 
	`h³t_»adl
(
HPET_ID
);

398 #ifdeà
CONFIG_HPET_EMULATE_RTC


403 ià(!(
id
 & 
HPET_ID_NUMBER
))

404 
out_noh³t
;

407 ià(
	`h³t_şocksourû_»gi¡”
())

408 
out_noh³t
;

410 ià(
id
 & 
HPET_ID_LEGSUP
) {

411 
	`h³t_Ëgacy_şockev’t_»gi¡”
();

416 
out_noh³t
:

417 
	`h³t_ş—r_m­pšg
();

418 
boÙ_h³t_di§bË
 = 1;

420 
	}
}

428 
__š™
 
	$h³t_Ï‹_š™
()

430 ià(
boÙ_h³t_di§bË
)

431  -
ENODEV
;

433 ià(!
h³t_add»ss
) {

434 ià(!
fÜû_h³t_add»ss
)

435  -
ENODEV
;

437 
h³t_add»ss
 = 
fÜû_h³t_add»ss
;

438 
	`h³t_’abË
();

439 ià(!
h³t_vœt_add»ss
)

440  -
ENODEV
;

443 
	`h³t_»£rve_¶©fÜm_tim”s
(
	`h³t_»adl
(
HPET_ID
));

446 
	}
}

447 
fs_š™ÿÎ
(
h³t_Ï‹_š™
);

449 
	$h³t_di§bË
()

451 ià(
	`is_h³t_ÿ·bË
()) {

452 
cfg
 = 
	`h³t_»adl
(
HPET_CFG
);

454 ià(
h³t_Ëgacy_št_’abËd
) {

455 
cfg
 &ğ~
HPET_CFG_LEGACY
;

456 
h³t_Ëgacy_št_’abËd
 = 0;

458 
cfg
 &ğ~
HPET_CFG_ENABLE
;

459 
	`h³t_wr™–
(
cfg
, 
HPET_CFG
);

461 
	}
}

463 #ifdeà
CONFIG_HPET_EMULATE_RTC


479 
	~<lšux/mc146818¹c.h
>

480 
	~<lšux/¹c.h
>

482 
	#DEFAULT_RTC_INT_FREQ
 64

	)

483 
	#DEFAULT_RTC_SHIFT
 6

	)

484 
	#RTC_NUM_INTS
 1

	)

486 
	gh³t_¹c_æags
;

487 
	gh³t_´ev_upd©e_£c
;

488 
¹c_time
 
	gh³t_®¬m_time
;

489 
	gh³t_p›_couÁ
;

490 
	gh³t_t1_cmp
;

491 
	gh³t_deçuÉ_d–
;

492 
	gh³t_p›_d–
;

493 
	gh³t_p›_lim™
;

501 
	$h³t_¹c_tim”_š™
()

503 
cfg
, 
út
, 
d–
, 
æags
;

505 ià(!
	`is_h³t_’abËd
())

508 ià(!
h³t_deçuÉ_d–
) {

509 
ušt64_t
 
şc
;

511 
şc
 = (
ušt64_t
è
h³t_şockev’t
.
muÉ
 * 
NSEC_PER_SEC
;

512 
şc
 >>ğ
h³t_şockev’t
.
shiá
 + 
DEFAULT_RTC_SHIFT
;

513 
h³t_deçuÉ_d–
 = (è
şc
;

516 ià(!(
h³t_¹c_æags
 & 
RTC_PIE
è|| 
h³t_p›_lim™
)

517 
d–
 = 
h³t_deçuÉ_d–
;

519 
d–
 = 
h³t_p›_d–
;

521 
	`loÿl_œq_§ve
(
æags
);

523 
út
 = 
d–
 + 
	`h³t_»adl
(
HPET_COUNTER
);

524 
	`h³t_wr™–
(
út
, 
HPET_T1_CMP
);

525 
h³t_t1_cmp
 = 
út
;

527 
cfg
 = 
	`h³t_»adl
(
HPET_T1_CFG
);

528 
cfg
 &ğ~
HPET_TN_PERIODIC
;

529 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

530 
	`h³t_wr™–
(
cfg
, 
HPET_T1_CFG
);

532 
	`loÿl_œq_»¡Üe
(
æags
);

535 
	}
}

542 
	$h³t_mask_¹c_œq_b™
(
b™_mask
)

544 ià(!
	`is_h³t_’abËd
())

547 
h³t_¹c_æags
 &ğ~
b™_mask
;

549 
	}
}

551 
	$h³t_£t_¹c_œq_b™
(
b™_mask
)

553 
Şdb™s
 = 
h³t_¹c_æags
;

555 ià(!
	`is_h³t_’abËd
())

558 
h³t_¹c_æags
 |ğ
b™_mask
;

560 ià(!
Şdb™s
)

561 
	`h³t_¹c_tim”_š™
();

564 
	}
}

566 
	$h³t_£t_®¬m_time
(
hrs
, 
mš
,

567 
£c
)

569 ià(!
	`is_h³t_’abËd
())

572 
h³t_®¬m_time
.
tm_hour
 = 
hrs
;

573 
h³t_®¬m_time
.
tm_mš
 = 
mš
;

574 
h³t_®¬m_time
.
tm_£c
 = 
£c
;

577 
	}
}

579 
	$h³t_£t_³riodic_äeq
(
äeq
)

581 
ušt64_t
 
şc
;

583 ià(!
	`is_h³t_’abËd
())

586 ià(
äeq
 <ğ
DEFAULT_RTC_INT_FREQ
)

587 
h³t_p›_lim™
 = 
DEFAULT_RTC_INT_FREQ
 / 
äeq
;

589 
şc
 = (
ušt64_t
è
h³t_şockev’t
.
muÉ
 * 
NSEC_PER_SEC
;

590 
	`do_div
(
şc
, 
äeq
);

591 
şc
 >>ğ
h³t_şockev’t
.
shiá
;

592 
h³t_p›_d–
 = (è
şc
;

595 
	}
}

597 
	$h³t_¹c_drİ³d_œq
()

599  
	`is_h³t_’abËd
();

600 
	}
}

602 
	$h³t_¹c_tim”_»š™
()

604 
cfg
, 
d–
;

605 
lo¡_šts
 = -1;

607 ià(
	`uÆik–y
(!
h³t_¹c_æags
)) {

608 
cfg
 = 
	`h³t_»adl
(
HPET_T1_CFG
);

609 
cfg
 &ğ~
HPET_TN_ENABLE
;

610 
	`h³t_wr™–
(
cfg
, 
HPET_T1_CFG
);

614 ià(!(
h³t_¹c_æags
 & 
RTC_PIE
è|| 
h³t_p›_lim™
)

615 
d–
 = 
h³t_deçuÉ_d–
;

617 
d–
 = 
h³t_p›_d–
;

624 
h³t_t1_cmp
 +ğ
d–
;

625 
	`h³t_wr™–
(
h³t_t1_cmp
, 
HPET_T1_CMP
);

626 
lo¡_šts
++;

627 } ()(
	`h³t_»adl
(
HPET_COUNTER
è- 
h³t_t1_cmp
) > 0);

629 ià(
lo¡_šts
) {

630 ià(
h³t_¹c_æags
 & 
RTC_PIE
)

631 
h³t_p›_couÁ
 +ğ
lo¡_šts
;

632 ià(
	`´štk_¿‹lim™
())

633 
	`´štk
(
KERN_WARNING
 "rtc:†ost %d interrupts\n",

634 
lo¡_šts
);

636 
	}
}

638 
œq»tuº_t
 
	$h³t_¹c_š‹¼u±
(
œq
, *
dev_id
)

640 
¹c_time
 
cu¼_time
;

641 
¹c_št_æag
 = 0;

643 
	`h³t_¹c_tim”_»š™
();

645 ià(
h³t_¹c_æags
 & (
RTC_UIE
 | 
RTC_AIE
))

646 
	`¹c_g‘_¹c_time
(&
cu¼_time
);

648 ià(
h³t_¹c_æags
 & 
RTC_UIE
 &&

649 
cu¼_time
.
tm_£c
 !ğ
h³t_´ev_upd©e_£c
) {

650 
¹c_št_æag
 = 
RTC_UF
;

651 
h³t_´ev_upd©e_£c
 = 
cu¼_time
.
tm_£c
;

654 ià(
h³t_¹c_æags
 & 
RTC_PIE
 &&

655 ++
h³t_p›_couÁ
 >ğ
h³t_p›_lim™
) {

656 
¹c_št_æag
 |ğ
RTC_PF
;

657 
h³t_p›_couÁ
 = 0;

660 ià(
h³t_¹c_æags
 & 
RTC_AIE
 &&

661 (
cu¼_time
.
tm_£c
 =ğ
h³t_®¬m_time
.tm_sec) &&

662 (
cu¼_time
.
tm_mš
 =ğ
h³t_®¬m_time
.tm_min) &&

663 (
cu¼_time
.
tm_hour
 =ğ
h³t_®¬m_time
.tm_hour))

664 
¹c_št_æag
 |ğ
RTC_AF
;

666 ià(
¹c_št_æag
) {

667 
¹c_št_æag
 |ğ(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

668 
	`¹c_š‹¼u±
(
¹c_št_æag
, 
dev_id
);

670  
IRQ_HANDLED
;

671 
	}
}

	@/cmpt816/linux/arch/x86/kernel/i387_64.c

15 
	~<lšux/sched.h
>

16 
	~<lšux/š™.h
>

17 
	~<asm/´oûssÜ.h
>

18 
	~<asm/i387.h
>

19 
	~<asm/sigcÚ‹xt.h
>

20 
	~<asm/u£r.h
>

21 
	~<asm/±¿û.h
>

22 
	~<asm/uacûss.h
>

24 
mxc¤_ã©u»_mask
 
	g__»ad_mo¡ly
 = 0xffffffff;

26 
	$mxc¤_ã©u»_mask_š™
()

28 
mask
;

29 
	`şts
();

30 
	`mem£t
(&
cu¼’t
->
th»ad
.
i387
.
fx§ve
, 0, (
i387_fx§ve_¡ruù
));

31 
asm
 vŞ©e("fx§v%0" : : "m" (
cu¼’t
->
th»ad
.
i387
.
fx§ve
));

32 
mask
 = 
cu¼’t
->
th»ad
.
i387
.
fx§ve
.
mxc¤_mask
;

33 ià(
mask
 == 0) mask = 0x0000ffbf;

34 
mxc¤_ã©u»_mask
 &ğ
mask
;

35 
	`¡ts
();

36 
	}
}

42 
__ıuš™
 
	$åu_š™
()

44 
Şdü0
 = 
	`»ad_ü0
();

45 
	`__bad_fx§ve_®ignm’t
();

47 ià(
	`off£tof
(
sk_¡ruù
, 
th»ad
.
i387
.
fx§ve
) & 15)

48 
	`__bad_fx§ve_®ignm’t
();

49 
	`£t_š_ü4
(
X86_CR4_OSFXSR
);

50 
	`£t_š_ü4
(
X86_CR4_OSXMMEXCPT
);

52 
	`wr™e_ü0
(
Şdü0
 & ~((1UL<<3)|(1UL<<2)));

54 
	`mxc¤_ã©u»_mask_š™
();

56 
	`cu¼’t_th»ad_šfo
()->
¡©us
 = 0;

57 
	`ş—r_u£d_m©h
();

58 
	}
}

60 
	$š™_åu
(
sk_¡ruù
 *
chd
)

62 ià(
	`tsk_u£d_m©h
(
chd
)) {

63 ià(
chd
 =ğ
cu¼’t
)

64 
	`uÆazy_åu
(
chd
);

67 
	`mem£t
(&
chd
->
th»ad
.
i387
.
fx§ve
, 0, (
i387_fx§ve_¡ruù
));

68 
chd
->
th»ad
.
i387
.
fx§ve
.
cwd
 = 0x37f;

69 
chd
->
th»ad
.
i387
.
fx§ve
.
mxc¤
 = 0x1f80;

71 
	`£t_¡İ³d_chd_u£d_m©h
(
chd
);

72 
	}
}

78 
	$§ve_i387
(
_å¡©e
 
__u£r
 *
buf
)

80 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

81 
”r
 = 0;

83 
	`BUILD_BUG_ON
((
u£r_i387_¡ruù
) !=

84 (
tsk
->
th»ad
.
i387
.
fx§ve
));

86 ià(()
buf
 % 16)

87 
	`´štk
("§ve_i387: bad fp¡©%p\n",
buf
);

89 ià(!
	`u£d_m©h
())

91 
	`ş—r_u£d_m©h
();

92 ià(
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 & 
TS_USEDFPU
) {

93 
”r
 = 
	`§ve_i387_checkšg
((
i387_fx§ve_¡ruù
 
__u£r
 *)
buf
);

94 ià(
”r
) ƒrr;

95 
	`sk_th»ad_šfo
(
tsk
)->
¡©us
 &ğ~
TS_USEDFPU
;

96 
	`¡ts
();

98 ià(
	`__cİy_to_u£r
(
buf
, &
tsk
->
th»ad
.
i387
.
fx§ve
,

99 (
i387_fx§ve_¡ruù
)))

103 
	}
}

109 
	$g‘_å»gs
(
u£r_i387_¡ruù
 
__u£r
 *
buf
, 
sk_¡ruù
 *
tsk
)

111 
	`š™_åu
(
tsk
);

112  
	`__cİy_to_u£r
(
buf
, &
tsk
->
th»ad
.
i387
.
fx§ve
,

113 (
u£r_i387_¡ruù
)è? -
EFAULT
 : 0;

114 
	}
}

116 
	$£t_å»gs
(
sk_¡ruù
 *
tsk
, 
u£r_i387_¡ruù
 
__u£r
 *
buf
)

118 ià(
	`__cİy_äom_u£r
(&
tsk
->
th»ad
.
i387
.
fx§ve
, 
buf
,

119 (
u£r_i387_¡ruù
)))

120  -
EFAULT
;

122 
	}
}

128 
	$dump_åu
Ğ
±_»gs
 *
»gs
, 
u£r_i387_¡ruù
 *
åu
 )

130 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

132 ià(!
	`u£d_m©h
())

135 
	`uÆazy_åu
(
tsk
);

136 
	`memıy
(
åu
, &
tsk
->
th»ad
.
i387
.
fx§ve
, (
u£r_i387_¡ruù
));

138 
	}
}

140 
	$dump_sk_åu
(
sk_¡ruù
 *
tsk
, 
u£r_i387_¡ruù
 *
åu
)

142 
åv®id
 = !!
	`tsk_u£d_m©h
(
tsk
);

144 ià(
åv®id
) {

145 ià(
tsk
 =ğ
cu¼’t
)

146 
	`uÆazy_åu
(
tsk
);

147 
	`memıy
(
åu
, &
tsk
->
th»ad
.
i387
.
fx§ve
, (
u£r_i387_¡ruù
));

149  
åv®id
;

150 
	}
}

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<lšux/š™.h
>

13 
	~<lšux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_»sume
(
sys_deviû
 *
dev
)

26 
æags
;

27 
i
;

29 
æags
 = 
	`şaim_dma_lock
();

31 
	`dma_outb
(
DMA1_RESET_REG
, 0);

32 
	`dma_outb
(
DMA2_RESET_REG
, 0);

34 
i
 = 0;i < 8;i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_couÁ
(
i
, 1);

41 
	`’abË_dma
(4);

43 
	`»Ëa£_dma_lock
(
æags
);

46 
	}
}

48 
	$i8237A_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

51 
	}
}

53 
sysdev_şass
 
	gi8237_sysdev_şass
 = {

54 
£t_k£t_Çme
("i8237"),

55 .
su¥’d
 = 
i8237A_su¥’d
,

56 .
	g»sume
 = 
i8237A_»sume
,

59 
sys_deviû
 
	gdeviû_i8237A
 = {

60 .
id
 = 0,

61 .
	gşs
 = &
i8237_sysdev_şass
,

64 
__š™
 
	$i8237A_š™_sysfs
()

66 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
i8237_sysdev_şass
);

67 ià(!
”rÜ
)

68 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_i8237A
);

69  
”rÜ
;

70 
	}
}

72 
deviû_š™ÿÎ
(
i8237A_š™_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<lšux/şockchs.h
>

6 
	~<lšux/š™.h
>

7 
	~<lšux/š‹¼u±.h
>

8 
	~<lšux/jiff›s.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/¥šlock.h
>

12 
	~<asm/smp.h
>

13 
	~<asm/d–ay.h
>

14 
	~<asm/i8253.h
>

15 
	~<asm/io.h
>

17 
DEFINE_SPINLOCK
(
i8253_lock
);

18 
EXPORT_SYMBOL
(
i8253_lock
);

24 
şock_ev’t_deviû
 *
	gglob®_şock_ev’t
;

31 
	$š™_p™_tim”
(
şock_ev’t_mode
 
mode
,

32 
şock_ev’t_deviû
 *
evt
)

34 
æags
;

36 
	`¥š_lock_œq§ve
(&
i8253_lock
, 
æags
);

38 
mode
) {

39 
CLOCK_EVT_MODE_PERIODIC
:

41 
	`outb_p
(0x34, 
PIT_MODE
);

42 
	`outb_p
(
LATCH
 & 0xfà, 
PIT_CH0
);

43 
	`outb
(
LATCH
 >> 8 , 
PIT_CH0
);

46 
CLOCK_EVT_MODE_SHUTDOWN
:

47 
CLOCK_EVT_MODE_UNUSED
:

48 ià(
evt
->
mode
 =ğ
CLOCK_EVT_MODE_PERIODIC
 ||

49 
evt
->
mode
 =ğ
CLOCK_EVT_MODE_ONESHOT
) {

50 
	`outb_p
(0x30, 
PIT_MODE
);

51 
	`outb_p
(0, 
PIT_CH0
);

52 
	`outb_p
(0, 
PIT_CH0
);

56 
CLOCK_EVT_MODE_ONESHOT
:

58 
	`outb_p
(0x38, 
PIT_MODE
);

61 
CLOCK_EVT_MODE_RESUME
:

65 
	`¥š_uÆock_œq»¡Üe
(&
i8253_lock
, 
æags
);

66 
	}
}

73 
	$p™_Ãxt_ev’t
(
d–
, 
şock_ev’t_deviû
 *
evt
)

75 
æags
;

77 
	`¥š_lock_œq§ve
(&
i8253_lock
, 
æags
);

78 
	`outb_p
(
d–
 & 0xfà, 
PIT_CH0
);

79 
	`outb
(
d–
 >> 8 , 
PIT_CH0
);

80 
	`¥š_uÆock_œq»¡Üe
(&
i8253_lock
, 
æags
);

83 
	}
}

93 
şock_ev’t_deviû
 
	gp™_şockev’t
 = {

94 .
Çme
 = "pit",

95 .
	gã©u»s
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

96 .
	g£t_mode
 = 
š™_p™_tim”
,

97 .
	g£t_Ãxt_ev’t
 = 
p™_Ãxt_ev’t
,

98 .
	gshiá
 = 32,

99 .
	gœq
 = 0,

106 
__š™
 
	$£tup_p™_tim”
()

112 
p™_şockev’t
.
ıumask
 = 
	`ıumask_of_ıu
(
	`smp_´oûssÜ_id
());

113 
p™_şockev’t
.
muÉ
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
, 32);

114 
p™_şockev’t
.
max_d–_ns
 =

115 
	`şockev’t_d–2ns
(0x7FFF, &
p™_şockev’t
);

116 
p™_şockev’t
.
mš_d–_ns
 =

117 
	`şockev’t_d–2ns
(0xF, &
p™_şockev’t
);

118 
	`şockev’ts_»gi¡”_deviû
(&
p™_şockev’t
);

119 
glob®_şock_ev’t
 = &
p™_şockev’t
;

120 
	}
}

122 #iâdeà
CONFIG_X86_64


128 
cyşe_t
 
	$p™_»ad
()

130 
æags
;

131 
couÁ
;

132 
u32
 
jifs
;

133 
Şd_couÁ
;

134 
u32
 
Şd_jifs
;

136 
	`¥š_lock_œq§ve
(&
i8253_lock
, 
æags
);

150 
jifs
 = 
jiff›s
;

151 
	`outb_p
(0x00, 
PIT_MODE
);

152 
couÁ
 = 
	`šb_p
(
PIT_CH0
);

153 
couÁ
 |ğ
	`šb_p
(
PIT_CH0
) << 8;

156 ià(
couÁ
 > 
LATCH
) {

157 
	`outb_p
(0x34, 
PIT_MODE
);

158 
	`outb_p
(
LATCH
 & 0xff, 
PIT_CH0
);

159 
	`outb
(
LATCH
 >> 8, 
PIT_CH0
);

160 
couÁ
 = 
LATCH
 - 1;

176 ià(
couÁ
 > 
Şd_couÁ
 && 
jifs
 =ğ
Şd_jifs
) {

177 
couÁ
 = 
Şd_couÁ
;

179 
Şd_couÁ
 = 
couÁ
;

180 
Şd_jifs
 = 
jifs
;

182 
	`¥š_uÆock_œq»¡Üe
(&
i8253_lock
, 
æags
);

184 
couÁ
 = (
LATCH
 - 1) - count;

186  (
cyşe_t
)(
jifs
 * 
LATCH
è+ 
couÁ
;

187 
	}
}

189 
şocksourû
 
	gşocksourû_p™
 = {

190 .
Çme
 = "pit",

191 .
	g¿tšg
 = 110,

192 .
	g»ad
 = 
p™_»ad
,

193 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

194 .
	gmuÉ
 = 0,

195 .
	gshiá
 = 20,

198 
__š™
 
	$š™_p™_şocksourû
()

200 ià(
	`num_possibË_ıus
() > 1)

203 
şocksourû_p™
.
muÉ
 = 
	`şocksourû_hz2muÉ
(
CLOCK_TICK_RATE
, 20);

204  
	`şocksourû_»gi¡”
(&
şocksourû_p™
);

205 
	}
}

206 
¬ch_š™ÿÎ
(
š™_p™_şocksourû
);

	@/cmpt816/linux/arch/x86/kernel/i8259_64.c

1 
	~<lšux/lškage.h
>

2 
	~<lšux/”ºo.h
>

3 
	~<lšux/sigÇl.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/iİÜt.h
>

6 
	~<lšux/š‹¼u±.h
>

7 
	~<lšux/timex.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¿ndom.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/k”Ãl_¡©.h
>

12 
	~<lšux/sysdev.h
>

13 
	~<lšux/b™İs.h
>

15 
	~<asm/aıi.h
>

16 
	~<asm/©omic.h
>

17 
	~<asm/sy¡em.h
>

18 
	~<asm/io.h
>

19 
	~<asm/hw_œq.h
>

20 
	~<asm/pgbË.h
>

21 
	~<asm/d–ay.h
>

22 
	~<asm/desc.h
>

23 
	~<asm/­ic.h
>

36 
	#BI
(
x
,
y
) \

37 
	`BUILD_IRQ
(
x
##
y
)

	)

39 
	#BUILD_16_IRQS
(
x
) \

40 
	`BI
(
x
,0) BI(x,1) BI(x,2) BI(x,3) \

41 
	`BI
(
x
,4) BI(x,5) BI(x,6) BI(x,7) \

42 
	`BI
(
x
,8èBI(x,9èBI(x,
a
èBI(x,
b
) \

43 
	`BI
(
x
,
c
èBI(x,
d
èBI(x,
e
èBI(x,
f
)

	)

60 
	$BUILD_16_IRQS
(0x2è
	$BUILD_16_IRQS
(0x3)

61 
	$BUILD_16_IRQS
(0x4è
	$BUILD_16_IRQS
(0x5è
	$BUILD_16_IRQS
(0x6è
	$BUILD_16_IRQS
(0x7)

62 
	$BUILD_16_IRQS
(0x8è
	$BUILD_16_IRQS
(0x9è
	$BUILD_16_IRQS
(0xaè
	$BUILD_16_IRQS
(0xb)

63 
	$BUILD_16_IRQS
(0xcè
	$BUILD_16_IRQS
(0xdè
	$BUILD_16_IRQS
(0xeè
	$BUILD_16_IRQS
(0xf)

65 #undeà
BUILD_16_IRQS


66 #undeà
BI


69 
	#IRQ
(
x
,
y
) \

70 
IRQ
##
x
##
y
##
_š‹¼u±


	)

72 
	#IRQLIST_16
(
x
) \

73 
	`IRQ
(
x
,0), IRQ(x,1), IRQ(x,2), IRQ(x,3), \

74 
	`IRQ
(
x
,4), IRQ(x,5), IRQ(x,6), IRQ(x,7), \

75 
	`IRQ
(
x
,8), IRQ(x,9), IRQ(x,
a
), IRQ(x,
b
), \

76 
	`IRQ
(
x
,
c
), IRQ(x,
d
), IRQ(x,
e
), IRQ(x,
f
)

	)

79 (*
š‹¼u±
[
NR_VECTORS
 - 
FIRST_EXTERNAL_VECTOR
])() = {

80 
	`IRQLIST_16
(0x2), IRQLIST_16(0x3),

81 
	`IRQLIST_16
(0x4), IRQLIST_16(0x5), IRQLIST_16(0x6), IRQLIST_16(0x7),

82 
	`IRQLIST_16
(0x8), IRQLIST_16(0x9), IRQLIST_16(0xa), IRQLIST_16(0xb),

83 
	`IRQLIST_16
(0xc), IRQLIST_16(0xd), IRQLIST_16(0xe), IRQLIST_16(0xf)

84 
	}
};

86 #undeà
IRQ


87 #undeà
IRQLIST_16


98 
	gi8259A_auto_eoi
;

99 
DEFINE_SPINLOCK
(
i8259A_lock
);

100 
mask_ªd_ack_8259A
();

102 
œq_ch
 
	gi8259A_ch
 = {

103 .
Çme
 = "XT-PIC",

104 .
	gmask
 = 
di§bË_8259A_œq
,

105 .
	gdi§bË
 = 
di§bË_8259A_œq
,

106 .
	gunmask
 = 
’abË_8259A_œq
,

107 .
	gmask_ack
 = 
mask_ªd_ack_8259A
,

117 
	gÿched_œq_mask
 = 0xffff;

119 
	#__by‹
(
x
,
y
è(((*)&(y))[x])

	)

120 
	#ÿched_21
 (
	`__by‹
(0,
ÿched_œq_mask
))

	)

121 
	#ÿched_A1
 (
	`__by‹
(1,
ÿched_œq_mask
))

	)

132 
	gio_­ic_œqs
;

134 
	$di§bË_8259A_œq
(
œq
)

136 
mask
 = 1 << 
œq
;

137 
æags
;

139 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

140 
ÿched_œq_mask
 |ğ
mask
;

141 ià(
œq
 & 8)

142 
	`outb
(
ÿched_A1
,0xA1);

144 
	`outb
(
ÿched_21
,0x21);

145 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

146 
	}
}

148 
	$’abË_8259A_œq
(
œq
)

150 
mask
 = ~(1 << 
œq
);

151 
æags
;

153 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

154 
ÿched_œq_mask
 &ğ
mask
;

155 ià(
œq
 & 8)

156 
	`outb
(
ÿched_A1
,0xA1);

158 
	`outb
(
ÿched_21
,0x21);

159 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

160 
	}
}

162 
	$i8259A_œq_³ndšg
(
œq
)

164 
mask
 = 1<<
œq
;

165 
æags
;

166 
»t
;

168 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

169 ià(
œq
 < 8)

170 
»t
 = 
	`šb
(0x20è& 
mask
;

172 
»t
 = 
	`šb
(0xA0è& (
mask
 >> 8);

173 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

175  
»t
;

176 
	}
}

178 
	$make_8259A_œq
(
œq
)

180 
	`di§bË_œq_nosync
(
œq
);

181 
io_­ic_œqs
 &ğ~(1<<
œq
);

182 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
i8259A_ch
, 
hªdË_Ëv–_œq
,

184 
	`’abË_œq
(
œq
);

185 
	}
}

193 
šlše
 
	$i8259A_œq_»®
(
œq
)

195 
v®ue
;

196 
œqmask
 = 1<<
œq
;

198 ià(
œq
 < 8) {

199 
	`outb
(0x0B,0x20);

200 
v®ue
 = 
	`šb
(0x20è& 
œqmask
;

201 
	`outb
(0x0A,0x20);

202  
v®ue
;

204 
	`outb
(0x0B,0xA0);

205 
v®ue
 = 
	`šb
(0xA0è& (
œqmask
 >> 8);

206 
	`outb
(0x0A,0xA0);

207  
v®ue
;

208 
	}
}

216 
	$mask_ªd_ack_8259A
(
œq
)

218 
œqmask
 = 1 << 
œq
;

219 
æags
;

221 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

237 ià(
ÿched_œq_mask
 & 
œqmask
)

238 
¥urious_8259A_œq
;

239 
ÿched_œq_mask
 |ğ
œqmask
;

241 
hªdË_»®_œq
:

242 ià(
œq
 & 8) {

243 
	`šb
(0xA1);

244 
	`outb
(
ÿched_A1
,0xA1);

245 
	`outb
(0x60+(
œq
&7),0xA0);

246 
	`outb
(0x62,0x20);

248 
	`šb
(0x21);

249 
	`outb
(
ÿched_21
,0x21);

250 
	`outb
(0x60+
œq
,0x20);

252 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

255 
¥urious_8259A_œq
:

259 ià(
	`i8259A_œq_»®
(
œq
))

264 
hªdË_»®_œq
;

267 
¥urious_œq_mask
;

272 ià(!(
¥urious_œq_mask
 & 
œqmask
)) {

273 
	`´štk
(
KERN_DEBUG
 "¥uriou 8259A iÁ”ru±: IRQ%d.\n", 
œq
);

274 
¥urious_œq_mask
 |ğ
œqmask
;

276 
	`©omic_šc
(&
œq_”r_couÁ
);

282 
hªdË_»®_œq
;

284 
	}
}

286 
	$š™_8259A
(
auto_eoi
)

288 
æags
;

290 
i8259A_auto_eoi
 = 
auto_eoi
;

292 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

294 
	`outb
(0xff, 0x21);

295 
	`outb
(0xff, 0xA1);

300 
	`outb_p
(0x11, 0x20);

301 
	`outb_p
(
IRQ0_VECTOR
, 0x21);

302 
	`outb_p
(0x04, 0x21);

303 ià(
auto_eoi
)

304 
	`outb_p
(0x03, 0x21);

306 
	`outb_p
(0x01, 0x21);

308 
	`outb_p
(0x11, 0xA0);

309 
	`outb_p
(
IRQ8_VECTOR
, 0xA1);

310 
	`outb_p
(0x02, 0xA1);

311 
	`outb_p
(0x01, 0xA1);

314 ià(
auto_eoi
)

319 
i8259A_ch
.
mask_ack
 = 
di§bË_8259A_œq
;

321 
i8259A_ch
.
mask_ack
 = 
mask_ªd_ack_8259A
;

323 
	`ud–ay
(100);

325 
	`outb
(
ÿched_21
, 0x21);

326 
	`outb
(
ÿched_A1
, 0xA1);

328 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

329 
	}
}

331 
	gœq_Œigg”
[2];

335 
	$»¡Üe_ELCR
(*
Œigg”
)

337 
	`outb
(
Œigg”
[0], 0x4d0);

338 
	`outb
(
Œigg”
[1], 0x4d1);

339 
	}
}

341 
	$§ve_ELCR
(*
Œigg”
)

344 
Œigg”
[0] = 
	`šb
(0x4d0) & 0xF8;

345 
Œigg”
[1] = 
	`šb
(0x4d1) & 0xDE;

346 
	}
}

348 
	$i8259A_»sume
(
sys_deviû
 *
dev
)

350 
	`š™_8259A
(
i8259A_auto_eoi
);

351 
	`»¡Üe_ELCR
(
œq_Œigg”
);

353 
	}
}

355 
	$i8259A_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

357 
	`§ve_ELCR
(
œq_Œigg”
);

359 
	}
}

361 
	$i8259A_shutdown
(
sys_deviû
 *
dev
)

367 
	`outb
(0xff, 0x21);

368 
	`outb
(0xff, 0xA1);

370 
	}
}

372 
sysdev_şass
 
	gi8259_sysdev_şass
 = {

373 
£t_k£t_Çme
("i8259"),

374 .
su¥’d
 = 
i8259A_su¥’d
,

375 .
	g»sume
 = 
i8259A_»sume
,

376 .
	gshutdown
 = 
i8259A_shutdown
,

379 
sys_deviû
 
	gdeviû_i8259A
 = {

380 .
id
 = 0,

381 .
	gşs
 = &
i8259_sysdev_şass
,

384 
__š™
 
	$i8259A_š™_sysfs
()

386 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
i8259_sysdev_şass
);

387 ià(!
”rÜ
)

388 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_i8259A
);

389  
”rÜ
;

390 
	}
}

392 
deviû_š™ÿÎ
(
i8259A_š™_sysfs
);

398 
œqaùiÚ
 
	gœq2
 = {

399 .
hªdËr
 = 
no_aùiÚ
,

400 .
	gmask
 = 
CPU_MASK_NONE
,

401 .
	gÇme
 = "cascade",

403 
DEFINE_PER_CPU
(
veùÜ_œq_t
, 
veùÜ_œq
) = {

404 [0 ... 
IRQ0_VECTOR
 - 1] = -1,

405 [
IRQ0_VECTOR
] = 0,

406 [
IRQ1_VECTOR
] = 1,

407 [
IRQ2_VECTOR
] = 2,

408 [
IRQ3_VECTOR
] = 3,

409 [
IRQ4_VECTOR
] = 4,

410 [
IRQ5_VECTOR
] = 5,

411 [
IRQ6_VECTOR
] = 6,

412 [
IRQ7_VECTOR
] = 7,

413 [
IRQ8_VECTOR
] = 8,

414 [
IRQ9_VECTOR
] = 9,

415 [
IRQ10_VECTOR
] = 10,

416 [
IRQ11_VECTOR
] = 11,

417 [
IRQ12_VECTOR
] = 12,

418 [
IRQ13_VECTOR
] = 13,

419 [
IRQ14_VECTOR
] = 14,

420 [
IRQ15_VECTOR
] = 15,

421 [
IRQ15_VECTOR
 + 1 ... 
NR_VECTORS
 - 1] = -1

424 
__š™
 
	$š™_ISA_œqs
 ()

426 
i
;

428 
	`š™_b¥_APIC
();

429 
	`š™_8259A
(0);

431 
i
 = 0; i < 
NR_IRQS
; i++) {

432 
œq_desc
[
i
].
¡©us
 = 
IRQ_DISABLED
;

433 
œq_desc
[
i
].
aùiÚ
 = 
NULL
;

434 
œq_desc
[
i
].
d•th
 = 1;

436 ià(
i
 < 16) {

440 
	`£t_œq_ch_ªd_hªdËr_Çme
(
i
, &
i8259A_ch
,

441 
hªdË_Ëv–_œq
, "XT");

446 
œq_desc
[
i
].
ch
 = &
no_œq_ch
;

449 
	}
}

451 
__š™
 
	$š™_IRQ
()

453 
i
;

455 
	`š™_ISA_œqs
();

461 
i
 = 0; i < (
NR_VECTORS
 - 
FIRST_EXTERNAL_VECTOR
); i++) {

462 
veùÜ
 = 
FIRST_EXTERNAL_VECTOR
 + 
i
;

463 ià(
veùÜ
 !ğ
IA32_SYSCALL_VECTOR
)

464 
	`£t_šŒ_g©e
(
veùÜ
, 
š‹¼u±
[
i
]);

467 #ifdeà
CONFIG_SMP


472 
	`£t_šŒ_g©e
(
RESCHEDULE_VECTOR
, 
»scheduË_š‹¼u±
);

475 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
šv®id©e_š‹¼u±0
);

476 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
šv®id©e_š‹¼u±1
);

477 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
šv®id©e_š‹¼u±2
);

478 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
šv®id©e_š‹¼u±3
);

479 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
šv®id©e_š‹¼u±4
);

480 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
šv®id©e_š‹¼u±5
);

481 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
šv®id©e_š‹¼u±6
);

482 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
šv®id©e_š‹¼u±7
);

485 
	`£t_šŒ_g©e
(
CALL_FUNCTION_VECTOR
, 
ÿÎ_funùiÚ_š‹¼u±
);

488 
	`£t_šŒ_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
œq_move_ş—nup_š‹¼u±
);

490 
	`£t_šŒ_g©e
(
THERMAL_APIC_VECTOR
, 
th”m®_š‹¼u±
);

491 
	`£t_šŒ_g©e
(
THRESHOLD_APIC_VECTOR
, 
th»shŞd_š‹¼u±
);

494 
	`£t_šŒ_g©e
(
LOCAL_TIMER_VECTOR
, 
­ic_tim”_š‹¼u±
);

497 
	`£t_šŒ_g©e
(
SPURIOUS_APIC_VECTOR
, 
¥urious_š‹¼u±
);

498 
	`£t_šŒ_g©e
(
ERROR_APIC_VECTOR
, 
”rÜ_š‹¼u±
);

500 ià(!
aıi_ißpic
)

501 
	`£tup_œq
(2, &
œq2
);

502 
	}
}

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<lšux/mm.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/sched.h
>

4 
	~<lšux/š™.h
>

5 
	~<lšux/š™_sk.h
>

6 
	~<lšux/fs.h
>

7 
	~<lšux/mqueue.h
>

9 
	~<asm/uacûss.h
>

10 
	~<asm/pgbË.h
>

11 
	~<asm/desc.h
>

13 
fs_¡ruù
 
	gš™_fs
 = 
INIT_FS
;

14 
fes_¡ruù
 
	gš™_fes
 = 
INIT_FILES
;

15 
sigÇl_¡ruù
 
	gš™_sigÇls
 = 
INIT_SIGNALS
(
š™_sigÇls
);

16 
sighªd_¡ruù
 
	gš™_sighªd
 = 
INIT_SIGHAND
(
š™_sighªd
);

17 
mm_¡ruù
 
	gš™_mm
 = 
INIT_MM
(
š™_mm
);

18 
EXPORT_SYMBOL
(
š™_mm
);

27 
th»ad_uniÚ
 
š™_th»ad_uniÚ


28 
__©Œibu‹__
((
__£ùiÚ__
(".data.init_task"))) =

29 { 
INIT_THREAD_INFO
(
š™_sk
) };

36 
sk_¡ruù
 
	gš™_sk
 = 
INIT_TASK
(
š™_sk
);

37 
EXPORT_SYMBOL
(
š™_sk
);

46 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_¡ruù
, 
š™_tss
èğ
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_apic_64.c

23 
	~<lšux/mm.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/š™.h
>

26 
	~<lšux/d–ay.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/pci.h
>

29 
	~<lšux/mc146818¹c.h
>

30 
	~<lšux/aıi.h
>

31 
	~<lšux/sysdev.h
>

32 
	~<lšux/msi.h
>

33 
	~<lšux/htœq.h
>

34 
	~<lšux/dm¬.h
>

35 #ifdeà
CONFIG_ACPI


36 
	~<aıi/aıi_bus.h
>

39 
	~<asm/idË.h
>

40 
	~<asm/io.h
>

41 
	~<asm/smp.h
>

42 
	~<asm/desc.h
>

43 
	~<asm/´Ùo.h
>

44 
	~<asm/mach_­ic.h
>

45 
	~<asm/aıi.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/nmi.h
>

48 
	~<asm/msidef.h
>

49 
	~<asm/hy³¹¿n¥Üt.h
>

51 
	sœq_cfg
 {

52 
ıumask_t
 
	mdomaš
;

53 
ıumask_t
 
	mŞd_domaš
;

54 
	mmove_ş—nup_couÁ
;

55 
u8
 
	mveùÜ
;

56 
u8
 
	mmove_š_´og»ss
 : 1;

60 
œq_cfg
 
	gœq_cfg
[
NR_IRQS
] 
	g__»ad_mo¡ly
 = {

61 [0] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ0_VECTOR
, },

62 [1] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ1_VECTOR
, },

63 [2] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ2_VECTOR
, },

64 [3] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ3_VECTOR
, },

65 [4] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ4_VECTOR
, },

66 [5] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ5_VECTOR
, },

67 [6] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ6_VECTOR
, },

68 [7] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ7_VECTOR
, },

69 [8] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ8_VECTOR
, },

70 [9] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ9_VECTOR
, },

71 [10] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ10_VECTOR
, },

72 [11] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ11_VECTOR
, },

73 [12] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ12_VECTOR
, },

74 [13] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ13_VECTOR
, },

75 [14] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ14_VECTOR
, },

76 [15] = { .
domaš
 = 
CPU_MASK_ALL
, .
	gveùÜ
 = 
IRQ15_VECTOR
, },

79 
assign_œq_veùÜ
(
œq
, 
ıumask_t
 
mask
);

81 
	#__­icdebugš™
 
__š™


	)

83 
	gsis_­ic_bug
;

85 
	gno_tim”_check
;

87 
di§bË_tim”_pš_1
 
	g__š™d©a
;

89 
tim”_ov”_8254
 
	g__š™d©a
 = 1;

92 ¡ruù { 
	mpš
, 
	m­ic
; } 
	gißpic_i8259
 = { -1, -1 };

94 
DEFINE_SPINLOCK
(
ißpic_lock
);

95 
DEFINE_SPINLOCK
(
veùÜ_lock
);

100 
	gÄ_ißpic_»gi¡”s
[
MAX_IO_APICS
];

106 
	#MAX_PLUS_SHARED_IRQS
 
NR_IRQS


	)

107 
	#PIN_MAP_SIZE
 (
MAX_PLUS_SHARED_IRQS
 + 
NR_IRQS
)

	)

116 
	sœq_pš_li¡
 {

117 
	m­ic
, 
	mpš
, 
	mÃxt
;

118 } 
	gœq_2_pš
[
PIN_MAP_SIZE
];

120 
	sio_­ic
 {

121 
	mšdex
;

122 
	munu£d
[3];

123 
	md©a
;

126 
__©Œibu‹_cÚ¡__
 
io_­ic
 
__iomem
 *
	$io_­ic_ba£
(
idx
)

128  (
__iomem
 *è
	`__fix_to_vœt
(
FIX_IO_APIC_BASE_0
 + 
idx
)

129 + (
mp_ißpics
[
idx
].
mpc_­iÿddr
 & ~
PAGE_MASK
);

130 
	}
}

132 
šlše
 
	$io_­ic_»ad
(
­ic
, 
»g
)

134 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

135 
	`wr™–
(
»g
, &
io_­ic
->
šdex
);

136  
	`»adl
(&
io_­ic
->
d©a
);

137 
	}
}

139 
šlše
 
	$io_­ic_wr™e
(
­ic
, 
»g
, 
v®ue
)

141 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

142 
	`wr™–
(
»g
, &
io_­ic
->
šdex
);

143 
	`wr™–
(
v®ue
, &
io_­ic
->
d©a
);

144 
	}
}

150 
šlše
 
	$io_­ic_modify
(
­ic
, 
v®ue
)

152 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

153 
	`wr™–
(
v®ue
, &
io_­ic
->
d©a
);

154 
	}
}

156 
	$io_­ic_Ëv–_ack_³ndšg
(
œq
)

158 
œq_pš_li¡
 *
’Œy
;

159 
æags
;

160 
³ndšg
 = 0;

162 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

163 
’Œy
 = 
œq_2_pš
 + 
œq
;

165 
»g
;

166 
pš
;

168 
pš
 = 
’Œy
->pin;

169 ià(
pš
 == -1)

171 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
*2);

173 
³ndšg
 |ğ(
»g
 >> 14) & 1;

174 ià(!
’Œy
->
Ãxt
)

176 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

178 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

179  
³ndšg
;

180 
	}
}

186 
šlše
 
	$io_­ic_sync
(
­ic
)

188 
io_­ic
 
__iomem
 *io_­iøğ
	`io_­ic_ba£
(
­ic
);

189 
	`»adl
(&
io_­ic
->
d©a
);

190 
	}
}

192 
	#__DO_ACTION
(
R
, 
ACTION
, 
FINAL
) \

195 
pš
; \

196 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
; \

198 
	`BUG_ON
(
œq
 >ğ
NR_IRQS
); \

200 
»g
; \

201 
pš
 = 
’Œy
->pin; \

202 ià(
pš
 == -1) \

204 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
R
 + 
pš
*2); \

205 
»g
 
ACTION
; \

206 
	`io_­ic_modify
(
’Œy
->
­ic
, 
»g
); \

207 
FINAL
; \

208 ià(!
’Œy
->
Ãxt
) \

210 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
; \

212 }

	)

214 
	u’Œy_uniÚ
 {

215 ¡ruù { 
u32
 
	mw1
, 
	mw2
; };

216 
IO_APIC_rou‹_’Œy
 
	m’Œy
;

219 
IO_APIC_rou‹_’Œy
 
	$ißpic_»ad_’Œy
(
­ic
, 
pš
)

221 
’Œy_uniÚ
 
eu
;

222 
æags
;

223 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

224 
eu
.
w1
 = 
	`io_­ic_»ad
(
­ic
, 0x10 + 2 * 
pš
);

225 
eu
.
w2
 = 
	`io_­ic_»ad
(
­ic
, 0x11 + 2 * 
pš
);

226 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

227  
eu
.
’Œy
;

228 
	}
}

237 
	$__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
IO_APIC_rou‹_’Œy
 
e
)

239 
’Œy_uniÚ
 
eu
;

240 
eu
.
’Œy
 = 
e
;

241 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2*
pš
, 
eu
.
w2
);

242 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2*
pš
, 
eu
.
w1
);

243 
	}
}

245 
	$ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
IO_APIC_rou‹_’Œy
 
e
)

247 
æags
;

248 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

249 
	`__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
e
);

250 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

251 
	}
}

258 
	$ißpic_mask_’Œy
(
­ic
, 
pš
)

260 
æags
;

261 
’Œy_uniÚ
 
eu
 = { .
’Œy
.
mask
 = 1 };

263 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

264 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2*
pš
, 
eu
.
w1
);

265 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2*
pš
, 
eu
.
w2
);

266 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

267 
	}
}

269 #ifdeà
CONFIG_SMP


270 
	$__rg‘_IO_APIC_œq
(
œq
, 
de¡
, 
u8
 
veùÜ
)

272 
­ic
, 
pš
;

273 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

275 
	`BUG_ON
(
œq
 >ğ
NR_IRQS
);

277 
»g
;

278 
­ic
 = 
’Œy
->apic;

279 
pš
 = 
’Œy
->pin;

280 ià(
pš
 == -1)

282 
	`io_­ic_wr™e
(
­ic
, 0x11 + 
pš
*2, 
de¡
);

283 
»g
 = 
	`io_­ic_»ad
(
­ic
, 0x10 + 
pš
*2);

284 
»g
 &= ~0x000000ff;

285 
»g
 |ğ
veùÜ
;

286 
	`io_­ic_modify
(
­ic
, 
»g
);

287 ià(!
’Œy
->
Ãxt
)

289 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

291 
	}
}

293 
	$£t_ißpic_affš™y_œq
(
œq
, 
ıumask_t
 
mask
)

295 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

296 
æags
;

297 
de¡
;

298 
ıumask_t
 
tmp
;

300 
	`ıus_ªd
(
tmp
, 
mask
, 
ıu_Úlše_m­
);

301 ià(
	`ıus_em±y
(
tmp
))

304 ià(
	`assign_œq_veùÜ
(
œq
, 
mask
))

307 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
, 
mask
);

308 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

313 
de¡
 = 
	`SET_APIC_LOGICAL_ID
(dest);

315 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

316 
	`__rg‘_IO_APIC_œq
(
œq
, 
de¡
, 
cfg
->
veùÜ
);

317 
œq_desc
[
œq
].
affš™y
 = 
mask
;

318 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

319 
	}
}

327 
	$add_pš_to_œq
(
œq
, 
­ic
, 
pš
)

329 
fœ¡_ä“_’Œy
 = 
NR_IRQS
;

330 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

332 
	`BUG_ON
(
œq
 >ğ
NR_IRQS
);

333 
’Œy
->
Ãxt
)

334 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

336 ià(
’Œy
->
pš
 != -1) {

337 
’Œy
->
Ãxt
 = 
fœ¡_ä“_’Œy
;

338 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

339 ià(++
fœ¡_ä“_’Œy
 >ğ
PIN_MAP_SIZE
)

340 
	`·nic
("io_apic.c:„an out of irq_2_pinƒntries!");

342 
’Œy
->
­ic
 =‡pic;

343 
’Œy
->
pš
 =…in;

344 
	}
}

347 
	#DO_ACTION
(
Çme
,
R
,
ACTION
, 
FINAL
) \

349 
Çme
##
	`_IO_APIC_œq
 (
œq
) \

350 
	`__DO_ACTION
(
R
, 
ACTION
, 
FINAL
)

	)

352 
DO_ACTION
Ğ
__mask
, 0, |ğ0x00010000, 
io_­ic_sync
(
’Œy
->
­ic
) )

354 
	$DO_ACTION
Ğ
__unmask
, 0, &= 0xfffeffff, )

357 
	$mask_IO_APIC_œq
 (
œq
)

359 
æags
;

361 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

362 
	`__mask_IO_APIC_œq
(
œq
);

363 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

364 
	}
}

366 
	$unmask_IO_APIC_œq
 (
œq
)

368 
æags
;

370 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

371 
	`__unmask_IO_APIC_œq
(
œq
);

372 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

373 
	}
}

375 
	$ş—r_IO_APIC_pš
(
­ic
, 
pš
)

377 
IO_APIC_rou‹_’Œy
 
’Œy
;

380 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

381 ià(
’Œy
.
d–iv”y_mode
 =ğ
de¡_SMI
)

386 
	`ißpic_mask_’Œy
(
­ic
, 
pš
);

387 
	}
}

389 
	$ş—r_IO_APIC
 ()

391 
­ic
, 
pš
;

393 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

394 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

395 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

396 
	}
}

398 
	gsk_ißpic_£tup
;

399 
	gißpic_fÜû
;

401 
__š™
 
	$·r£_nßpic
(*
¡r
)

403 
	`di§bË_ißpic_£tup
();

405 
	}
}

406 
—¾y_·¿m
("nßpic", 
·r£_nßpic
);

409 
__š™
 
	$di§bË_tim”_pš_£tup
(*
¬g
)

411 
di§bË_tim”_pš_1
 = 1;

413 
	}
}

414 
__£tup
("di§bË_tim”_pš_1", 
di§bË_tim”_pš_£tup
);

416 
__š™
 
	$£tup_di§bË_8254_tim”
(*
s
)

418 
tim”_ov”_8254
 = -1;

420 
	}
}

421 
__š™
 
	$£tup_’abË_8254_tim”
(*
s
)

423 
tim”_ov”_8254
 = 2;

425 
	}
}

427 
__£tup
("di§bË_8254_tim”", 
£tup_di§bË_8254_tim”
);

428 
__£tup
("’abË_8254_tim”", 
£tup_’abË_8254_tim”
);

434 
	$fšd_œq_’Œy
(
­ic
, 
pš
, 
ty³
)

436 
i
;

438 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

439 ià(
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
 &&

440 (
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
mp_ißpics
[
­ic
].
mpc_­icid
 ||

441 
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
MP_APIC_ALL
) &&

442 
mp_œqs
[
i
].
mpc_d¡œq
 =ğ
pš
)

443  
i
;

446 
	}
}

451 
__š™
 
	$fšd_i§_œq_pš
(
œq
, 
ty³
)

453 
i
;

455 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

456 
lbus
 = 
mp_œqs
[
i
].
mpc_¤cbus
;

458 ià(
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

459 (
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
) &&

460 (
mp_œqs
[
i
].
mpc_¤cbusœq
 =ğ
œq
))

462  
mp_œqs
[
i
].
mpc_d¡œq
;

465 
	}
}

467 
__š™
 
	$fšd_i§_œq_­ic
(
œq
, 
ty³
)

469 
i
;

471 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

472 
lbus
 = 
mp_œqs
[
i
].
mpc_¤cbus
;

474 ià(
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

475 (
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
) &&

476 (
mp_œqs
[
i
].
mpc_¤cbusœq
 =ğ
œq
))

479 ià(
i
 < 
mp_œq_’Œ›s
) {

480 
­ic
;

481 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

482 ià(
mp_ißpics
[
­ic
].
mpc_­icid
 =ğ
mp_œqs
[
i
].
mpc_d¡­ic
)

483  
­ic
;

488 
	}
}

494 
pš_2_œq
(
idx
, 
­ic
, 
pš
);

496 
	$IO_APIC_g‘_PCI_œq_veùÜ
(
bus
, 
¦Ù
, 
pš
)

498 
­ic
, 
i
, 
be¡_guess
 = -1;

500 
	`­ic_´štk
(
APIC_DEBUG
, "querying PCI -> IRQ mapping bus:%d, slot:%d,…in:%d.\n",

501 
bus
, 
¦Ù
, 
pš
);

502 ià(
mp_bus_id_to_pci_bus
[
bus
] == -1) {

503 
	`­ic_´štk
(
APIC_VERBOSE
, "PCI BIOS…as£d‚Úexi¡’ˆPCI bu %d!\n", 
bus
);

506 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

507 
lbus
 = 
mp_œqs
[
i
].
mpc_¤cbus
;

509 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

510 ià(
mp_ißpics
[
­ic
].
mpc_­icid
 =ğ
mp_œqs
[
i
].
mpc_d¡­ic
 ||

511 
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
MP_APIC_ALL
)

514 ià(!
	`‹¡_b™
(
lbus
, 
mp_bus_nÙ_pci
) &&

515 !
mp_œqs
[
i
].
mpc_œqty³
 &&

516 (
bus
 =ğ
lbus
) &&

517 (
¦Ù
 =ğ((
mp_œqs
[
i
].
mpc_¤cbusœq
 >> 2) & 0x1f))) {

518 
œq
 = 
	`pš_2_œq
(
i
,
­ic
,
mp_œqs
[i].
mpc_d¡œq
);

520 ià(!(
­ic
 || 
	`IO_APIC_IRQ
(
œq
)))

523 ià(
pš
 =ğ(
mp_œqs
[
i
].
mpc_¤cbusœq
 & 3))

524  
œq
;

529 ià(
be¡_guess
 < 0)

530 
be¡_guess
 = 
œq
;

533 
	`BUG_ON
(
be¡_guess
 >ğ
NR_IRQS
);

534  
be¡_guess
;

535 
	}
}

540 
	#deçuÉ_ISA_Œigg”
(
idx
è(0)

	)

541 
	#deçuÉ_ISA_pŞ¬™y
(
idx
è(0)

	)

546 
	#deçuÉ_PCI_Œigg”
(
idx
è(1)

	)

547 
	#deçuÉ_PCI_pŞ¬™y
(
idx
è(1)

	)

549 
	$MPBIOS_pŞ¬™y
(
idx
)

551 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

552 
pŞ¬™y
;

557 
mp_œqs
[
idx
].
mpc_œqæag
 & 3)

560 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
))

561 
pŞ¬™y
 = 
	`deçuÉ_ISA_pŞ¬™y
(
idx
);

563 
pŞ¬™y
 = 
	`deçuÉ_PCI_pŞ¬™y
(
idx
);

567 
pŞ¬™y
 = 0;

572 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

573 
pŞ¬™y
 = 1;

578 
pŞ¬™y
 = 1;

583 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

584 
pŞ¬™y
 = 1;

588  
pŞ¬™y
;

589 
	}
}

591 
	$MPBIOS_Œigg”
(
idx
)

593 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

594 
Œigg”
;

599 (
mp_œqs
[
idx
].
mpc_œqæag
>>2) & 3)

602 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
))

603 
Œigg”
 = 
	`deçuÉ_ISA_Œigg”
(
idx
);

605 
Œigg”
 = 
	`deçuÉ_PCI_Œigg”
(
idx
);

609 
Œigg”
 = 0;

614 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

615 
Œigg”
 = 1;

620 
Œigg”
 = 1;

625 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

626 
Œigg”
 = 0;

630  
Œigg”
;

631 
	}
}

633 
šlše
 
	$œq_pŞ¬™y
(
idx
)

635  
	`MPBIOS_pŞ¬™y
(
idx
);

636 
	}
}

638 
šlše
 
	$œq_Œigg”
(
idx
)

640  
	`MPBIOS_Œigg”
(
idx
);

641 
	}
}

643 
	$pš_2_œq
(
idx
, 
­ic
, 
pš
)

645 
œq
, 
i
;

646 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

651 ià(
mp_œqs
[
idx
].
mpc_d¡œq
 !ğ
pš
)

652 
	`´štk
(
KERN_ERR
 "broken BIOS or MPTABLE…arser,‡yiee!!\n");

654 ià(
	`‹¡_b™
(
bus
, 
mp_bus_nÙ_pci
)) {

655 
œq
 = 
mp_œqs
[
idx
].
mpc_¤cbusœq
;

660 
i
 = 
œq
 = 0;

661 
i
 < 
­ic
)

662 
œq
 +ğ
Ä_ißpic_»gi¡”s
[
i
++];

663 
œq
 +ğ
pš
;

665 
	`BUG_ON
(
œq
 >ğ
NR_IRQS
);

666  
œq
;

667 
	}
}

669 
	$__assign_œq_veùÜ
(
œq
, 
ıumask_t
 
mask
)

682 
cu¼’t_veùÜ
 = 
FIRST_DEVICE_VECTOR
, 
cu¼’t_off£t
 = 0;

683 
Şd_veùÜ
;

684 
ıu
;

685 
œq_cfg
 *
cfg
;

687 
	`BUG_ON
(()
œq
 >ğ
NR_IRQS
);

688 
cfg
 = &
œq_cfg
[
œq
];

691 
	`ıus_ªd
(
mask
, mask, 
ıu_Úlše_m­
);

693 ià((
cfg
->
move_š_´og»ss
è|| cfg->
move_ş—nup_couÁ
)

694  -
EBUSY
;

696 
Şd_veùÜ
 = 
cfg
->
veùÜ
;

697 ià(
Şd_veùÜ
) {

698 
ıumask_t
 
tmp
;

699 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
, 
mask
);

700 ià(!
	`ıus_em±y
(
tmp
))

704 
	`fÜ_—ch_ıu_mask
(
ıu
, 
mask
) {

705 
ıumask_t
 
domaš
, 
Ãw_mask
;

706 
Ãw_ıu
;

707 
veùÜ
, 
off£t
;

709 
domaš
 = 
	`veùÜ_®loÿtiÚ_domaš
(
ıu
);

710 
	`ıus_ªd
(
Ãw_mask
, 
domaš
, 
ıu_Úlše_m­
);

712 
veùÜ
 = 
cu¼’t_veùÜ
;

713 
off£t
 = 
cu¼’t_off£t
;

714 
Ãxt
:

715 
veùÜ
 += 8;

716 ià(
veùÜ
 >ğ
FIRST_SYSTEM_VECTOR
) {

718 
off£t
 = (offset + 1) % 8;

719 
veùÜ
 = 
FIRST_DEVICE_VECTOR
 + 
off£t
;

721 ià(
	`uÆik–y
(
cu¼’t_veùÜ
 =ğ
veùÜ
))

723 ià(
veùÜ
 =ğ
IA32_SYSCALL_VECTOR
)

724 
Ãxt
;

725 
	`fÜ_—ch_ıu_mask
(
Ãw_ıu
, 
Ãw_mask
)

726 ià(
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] != -1)

727 
Ãxt
;

729 
cu¼’t_veùÜ
 = 
veùÜ
;

730 
cu¼’t_off£t
 = 
off£t
;

731 ià(
Şd_veùÜ
) {

732 
cfg
->
move_š_´og»ss
 = 1;

733 
cfg
->
Şd_domaš
 = cfg->
domaš
;

735 
	`fÜ_—ch_ıu_mask
(
Ãw_ıu
, 
Ãw_mask
)

736 
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] = 
œq
;

737 
cfg
->
veùÜ
 = vector;

738 
cfg
->
domaš
 = domain;

741  -
ENOSPC
;

742 
	}
}

744 
	$assign_œq_veùÜ
(
œq
, 
ıumask_t
 
mask
)

746 
”r
;

747 
æags
;

749 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

750 
”r
 = 
	`__assign_œq_veùÜ
(
œq
, 
mask
);

751 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

752  
”r
;

753 
	}
}

755 
	$__ş—r_œq_veùÜ
(
œq
)

757 
œq_cfg
 *
cfg
;

758 
ıumask_t
 
mask
;

759 
ıu
, 
veùÜ
;

761 
	`BUG_ON
(()
œq
 >ğ
NR_IRQS
);

762 
cfg
 = &
œq_cfg
[
œq
];

763 
	`BUG_ON
(!
cfg
->
veùÜ
);

765 
veùÜ
 = 
cfg
->vector;

766 
	`ıus_ªd
(
mask
, 
cfg
->
domaš
, 
ıu_Úlše_m­
);

767 
	`fÜ_—ch_ıu_mask
(
ıu
, 
mask
)

768 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

770 
cfg
->
veùÜ
 = 0;

771 
cfg
->
domaš
 = 
CPU_MASK_NONE
;

772 
	}
}

774 
	$__£tup_veùÜ_œq
(
ıu
)

778 
œq
, 
veùÜ
;

781 
œq
 = 0; irq < 
NR_IRQS
; ++irq) {

782 ià(!
	`ıu_is£t
(
ıu
, 
œq_cfg
[
œq
].
domaš
))

784 
veùÜ
 = 
œq_cfg
[
œq
].vector;

785 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = 
œq
;

788 
veùÜ
 = 0; veùÜ < 
NR_VECTORS
; ++vector) {

789 
œq
 = 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
];

790 ià(
œq
 < 0)

792 ià(!
	`ıu_is£t
(
ıu
, 
œq_cfg
[
œq
].
domaš
))

793 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

795 
	}
}

798 
œq_ch
 
	gißpic_ch
;

800 
	$ißpic_»gi¡”_šŒ
(
œq
, 
Œigg”
)

802 ià(
Œigg”
) {

803 
œq_desc
[
œq
].
¡©us
 |ğ
IRQ_LEVEL
;

804 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ißpic_ch
,

805 
hªdË_ç¡eoi_œq
, "fasteoi");

807 
œq_desc
[
œq
].
¡©us
 &ğ~
IRQ_LEVEL
;

808 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ißpic_ch
,

809 
hªdË_edge_œq
, "edge");

811 
	}
}

813 
	$£tup_IO_APIC_œq
(
­ic
, 
pš
, 
œq
,

814 
Œigg”
, 
pŞ¬™y
)

816 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

817 
IO_APIC_rou‹_’Œy
 
’Œy
;

818 
ıumask_t
 
mask
;

820 ià(!
	`IO_APIC_IRQ
(
œq
))

823 
mask
 = 
TARGET_CPUS
;

824 ià(
	`assign_œq_veùÜ
(
œq
, 
mask
))

827 
	`ıus_ªd
(
mask
, 
cfg
->
domaš
, mask);

829 
	`­ic_´štk
(
APIC_VERBOSE
,
KERN_DEBUG


832 
­ic
, 
mp_ißpics
[­ic].
mpc_­icid
, 
pš
, 
cfg
->
veùÜ
,

833 
œq
, 
Œigg”
, 
pŞ¬™y
);

838 
	`mem£t
(&
’Œy
,0,(entry));

840 
’Œy
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

841 
’Œy
.
de¡_mode
 = 
INT_DEST_MODE
;

842 
’Œy
.
de¡
 = 
	`ıu_mask_to_­icid
(
mask
);

843 
’Œy
.
mask
 = 0;

844 
’Œy
.
Œigg”
 =rigger;

845 
’Œy
.
pŞ¬™y
 =…olarity;

846 
’Œy
.
veùÜ
 = 
cfg
->vector;

851 ià(
Œigg”
)

852 
’Œy
.
mask
 = 1;

854 
	`ißpic_»gi¡”_šŒ
(
œq
, 
Œigg”
);

855 ià(
œq
 < 16)

856 
	`di§bË_8259A_œq
(
œq
);

858 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
’Œy
);

859 
	}
}

861 
__š™
 
	$£tup_IO_APIC_œqs
()

863 
­ic
, 
pš
, 
idx
, 
œq
, 
fœ¡_nÙcÚ
 = 1;

865 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

867 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

868 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

870 
idx
 = 
	`fšd_œq_’Œy
(
­ic
,
pš
,
mp_INT
);

871 ià(
idx
 == -1) {

872 ià(
fœ¡_nÙcÚ
) {

873 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG
 " IO-APIC (­icid-pšè%d-%d", 
mp_ißpics
[
­ic
].
mpc_­icid
, 
pš
);

874 
fœ¡_nÙcÚ
 = 0;

876 
	`­ic_´štk
(
APIC_VERBOSE
, ", %d-%d", 
mp_ißpics
[
­ic
].
mpc_­icid
, 
pš
);

879 ià(!
fœ¡_nÙcÚ
) {

880 
	`­ic_´štk
(
APIC_VERBOSE
, "‚ot connected.\n");

881 
fœ¡_nÙcÚ
 = 1;

884 
œq
 = 
	`pš_2_œq
(
idx
, 
­ic
, 
pš
);

885 
	`add_pš_to_œq
(
œq
, 
­ic
, 
pš
);

887 
	`£tup_IO_APIC_œq
(
­ic
, 
pš
, 
œq
,

888 
	`œq_Œigg”
(
idx
), 
	`œq_pŞ¬™y
(idx));

892 ià(!
fœ¡_nÙcÚ
)

893 
	`­ic_´štk
(
APIC_VERBOSE
, "‚ot connected.\n");

894 
	}
}

900 
__š™
 
	$£tup_ExtINT_IRQ0_pš
(
­ic
, 
pš
, 
veùÜ
)

902 
IO_APIC_rou‹_’Œy
 
’Œy
;

903 
æags
;

905 
	`mem£t
(&
’Œy
,0,(entry));

907 
	`di§bË_8259A_œq
(0);

910 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

916 
’Œy
.
de¡_mode
 = 
INT_DEST_MODE
;

917 
’Œy
.
mask
 = 0;

918 
’Œy
.
de¡
 = 
	`ıu_mask_to_­icid
(
TARGET_CPUS
);

919 
’Œy
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

920 
’Œy
.
pŞ¬™y
 = 0;

921 
’Œy
.
Œigg”
 = 0;

922 
’Œy
.
veùÜ
 = vector;

928 
	`£t_œq_ch_ªd_hªdËr_Çme
(0, &
ißpic_ch
, 
hªdË_edge_œq
, "edge");

933 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

934 
	`io_­ic_wr™e
(
­ic
, 0x11+2*
pš
, *(((*)&
’Œy
)+1));

935 
	`io_­ic_wr™e
(
­ic
, 0x10+2*
pš
, *(((*)&
’Œy
)+0));

936 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

938 
	`’abË_8259A_œq
(0);

939 
	}
}

941 
__­icdebugš™
 
	$´št_IO_APIC
()

943 
­ic
, 
i
;

944 
IO_APIC_»g_00
 
»g_00
;

945 
IO_APIC_»g_01
 
»g_01
;

946 
IO_APIC_»g_02
 
»g_02
;

947 
æags
;

949 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

952 
	`´štk
(
KERN_DEBUG
 "numb” oàMP IRQ sourûs: %d.\n", 
mp_œq_’Œ›s
);

953 
i
 = 0; i < 
Ä_ißpics
; i++)

954 
	`´štk
(
KERN_DEBUG
 "number of IO-APIC #%d„egisters: %d.\n",

955 
mp_ißpics
[
i
].
mpc_­icid
, 
Ä_ißpic_»gi¡”s
[i]);

961 
	`´štk
(
KERN_INFO
 "testinghe IO APIC.......................\n");

963 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

965 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

966 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 0);

967 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 1);

968 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x10)

969 
»g_02
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 2);

970 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

972 
	`´štk
("\n");

973 
	`´štk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_ißpics
[
­ic
].
mpc_­icid
);

974 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #00: %08X\n", 
»g_00
.
¿w
);

975 
	`´štk
(
KERN_DEBUG
 "....... :…hysiÿÈAPIC id: %02X\n", 
»g_00
.
b™s
.
ID
);

977 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #01: %08X\n", *(*)&
»g_01
);

978 
	`´štk
(
KERN_DEBUG
 "....... : max„edœeùiÚƒÁr›s: %04X\n", 
»g_01
.
b™s
.
’Œ›s
);

980 
	`´štk
(
KERN_DEBUG
 "....... : PRQ im¶em’‹d: %X\n", 
»g_01
.
b™s
.
PRQ
);

981 
	`´štk
(
KERN_DEBUG
 "....... : IO APIC v”siÚ: %04X\n", 
»g_01
.
b™s
.
v”siÚ
);

983 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x10) {

984 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #02: %08X\n", 
»g_02
.
¿w
);

985 
	`´štk
(
KERN_DEBUG
 "....... :‡rb™¿tiÚ: %02X\n", 
»g_02
.
b™s
.
¬b™¿tiÚ
);

988 
	`´štk
(
KERN_DEBUG
 ".... IRQ„edirectionable:\n");

990 
	`´štk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

993 
i
 = 0; i <ğ
»g_01
.
b™s
.
’Œ›s
; i++) {

994 
IO_APIC_rou‹_’Œy
 
’Œy
;

996 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
i
);

998 
	`´štk
(
KERN_DEBUG
 " %02x %03X ",

999 
i
,

1000 
’Œy
.
de¡


1003 
	`´štk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1004 
’Œy
.
mask
,

1005 
’Œy
.
Œigg”
,

1006 
’Œy
.
œr
,

1007 
’Œy
.
pŞ¬™y
,

1008 
’Œy
.
d–iv”y_¡©us
,

1009 
’Œy
.
de¡_mode
,

1010 
’Œy
.
d–iv”y_mode
,

1011 
’Œy
.
veùÜ


1015 
	`´štk
(
KERN_DEBUG
 "IRQo…in mappings:\n");

1016 
i
 = 0; i < 
NR_IRQS
; i++) {

1017 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
i
;

1018 ià(
’Œy
->
pš
 < 0)

1020 
	`´štk
(
KERN_DEBUG
 "IRQ%d ", 
i
);

1022 
	`´štk
("-> %d:%d", 
’Œy
->
­ic
,ƒÁry->
pš
);

1023 ià(!
’Œy
->
Ãxt
)

1025 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

1027 
	`´štk
("\n");

1030 
	`´štk
(
KERN_INFO
 ".................................... done.\n");

1033 
	}
}

1037 
__­icdebugš™
 
	$´št_APIC_b™f›ld
 (
ba£
)

1039 
v
;

1040 
i
, 
j
;

1042 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1045 
	`´štk
(
KERN_DEBUG
 "0123456789abcdef0123456789abcdef\n" KERN_DEBUG);

1046 
i
 = 0; i < 8; i++) {

1047 
v
 = 
	`­ic_»ad
(
ba£
 + 
i
*0x10);

1048 
j
 = 0; j < 32; j++) {

1049 ià(
v
 & (1<<
j
))

1050 
	`´štk
("1");

1052 
	`´štk
("0");

1054 
	`´štk
("\n");

1056 
	}
}

1058 
__­icdebugš™
 
	$´št_loÿl_APIC
(* 
dummy
)

1060 
v
, 
v”
, 
maxlvt
;

1062 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1065 
	`´štk
("\n" 
KERN_DEBUG
 "printing†ocal APIC contents on CPU#%d/%d:\n",

1066 
	`smp_´oûssÜ_id
(), 
	`h¬d_smp_´oûssÜ_id
());

1067 
v
 = 
	`­ic_»ad
(
APIC_ID
);

1068 
	`´štk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`GET_APIC_ID
(v));

1069 
v
 = 
	`­ic_»ad
(
APIC_LVR
);

1070 
	`´štk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1071 
v”
 = 
	`GET_APIC_VERSION
(
v
);

1072 
maxlvt
 = 
	`g‘_maxlvt
();

1074 
v
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

1075 
	`´štk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1077 
v
 = 
	`­ic_»ad
(
APIC_ARBPRI
);

1078 
	`´štk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1079 
v
 & 
APIC_ARBPRI_MASK
);

1080 
v
 = 
	`­ic_»ad
(
APIC_PROCPRI
);

1081 
	`´štk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1083 
v
 = 
	`­ic_»ad
(
APIC_EOI
);

1084 
	`´štk
(
KERN_DEBUG
 "... APIC EOI: %08x\n", 
v
);

1085 
v
 = 
	`­ic_»ad
(
APIC_RRR
);

1086 
	`´štk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1087 
v
 = 
	`­ic_»ad
(
APIC_LDR
);

1088 
	`´štk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1089 
v
 = 
	`­ic_»ad
(
APIC_DFR
);

1090 
	`´štk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1091 
v
 = 
	`­ic_»ad
(
APIC_SPIV
);

1092 
	`´štk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1094 
	`´štk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1095 
	`´št_APIC_b™f›ld
(
APIC_ISR
);

1096 
	`´štk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1097 
	`´št_APIC_b™f›ld
(
APIC_TMR
);

1098 
	`´štk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1099 
	`´št_APIC_b™f›ld
(
APIC_IRR
);

1101 
v
 = 
	`­ic_»ad
(
APIC_ESR
);

1102 
	`´štk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1104 
v
 = 
	`­ic_»ad
(
APIC_ICR
);

1105 
	`´štk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", 
v
);

1106 
v
 = 
	`­ic_»ad
(
APIC_ICR2
);

1107 
	`´štk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", 
v
);

1109 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

1110 
	`´štk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1112 ià(
maxlvt
 > 3) {

1113 
v
 = 
	`­ic_»ad
(
APIC_LVTPC
);

1114 
	`´štk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1116 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1117 
	`´štk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1118 
v
 = 
	`­ic_»ad
(
APIC_LVT1
);

1119 
	`´štk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1121 ià(
maxlvt
 > 2) {

1122 
v
 = 
	`­ic_»ad
(
APIC_LVTERR
);

1123 
	`´štk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1126 
v
 = 
	`­ic_»ad
(
APIC_TMICT
);

1127 
	`´štk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1128 
v
 = 
	`­ic_»ad
(
APIC_TMCCT
);

1129 
	`´štk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1130 
v
 = 
	`­ic_»ad
(
APIC_TDCR
);

1131 
	`´štk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1132 
	`´štk
("\n");

1133 
	}
}

1135 
	$´št_®l_loÿl_APICs
 ()

1137 
	`Ú_—ch_ıu
(
´št_loÿl_APIC
, 
NULL
, 1, 1);

1138 
	}
}

1140 
__­icdebugš™
 
	$´št_PIC
()

1142 
v
;

1143 
æags
;

1145 ià(
­ic_v”bos™y
 =ğ
APIC_QUIET
)

1148 
	`´štk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1150 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

1152 
v
 = 
	`šb
(0xa1) << 8 | inb(0x21);

1153 
	`´štk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1155 
v
 = 
	`šb
(0xa0) << 8 | inb(0x20);

1156 
	`´štk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1158 
	`outb
(0x0b,0xa0);

1159 
	`outb
(0x0b,0x20);

1160 
v
 = 
	`šb
(0xa0) << 8 | inb(0x20);

1161 
	`outb
(0x0a,0xa0);

1162 
	`outb
(0x0a,0x20);

1164 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

1166 
	`´štk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1168 
v
 = 
	`šb
(0x4d1) << 8 | inb(0x4d0);

1169 
	`´štk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1170 
	}
}

1174 
__š™
 
	$’abË_IO_APIC
()

1176 
IO_APIC_»g_01
 
»g_01
;

1177 
i8259_­ic
, 
i8259_pš
;

1178 
i
, 
­ic
;

1179 
æags
;

1181 
i
 = 0; i < 
PIN_MAP_SIZE
; i++) {

1182 
œq_2_pš
[
i
].
pš
 = -1;

1183 
œq_2_pš
[
i
].
Ãxt
 = 0;

1189 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1190 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1191 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 1);

1192 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1193 
Ä_ißpic_»gi¡”s
[
­ic
] = 
»g_01
.
b™s
.
’Œ›s
+1;

1195 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1196 
pš
;

1198 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

1199 
IO_APIC_rou‹_’Œy
 
’Œy
;

1200 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
);

1205 ià((
’Œy
.
mask
 =ğ0è&& (’Œy.
d–iv”y_mode
 =ğ
de¡_ExtINT
)) {

1206 
ißpic_i8259
.
­ic
 =‡pic;

1207 
ißpic_i8259
.
pš
 =…in;

1208 
found_i8259
;

1212 
found_i8259
:

1214 
i8259_pš
 = 
	`fšd_i§_œq_pš
(0, 
mp_ExtINT
);

1215 
i8259_­ic
 = 
	`fšd_i§_œq_­ic
(0, 
mp_ExtINT
);

1217 ià((
ißpic_i8259
.
pš
 =ğ-1è&& (
i8259_pš
 >= 0)) {

1218 
	`´štk
(
KERN_WARNING
 "ExtINT‚ot setup in hardware but„eported by MPable\n");

1219 
ißpic_i8259
.
pš
 = 
i8259_pš
;

1220 
ißpic_i8259
.
­ic
 = 
i8259_­ic
;

1223 ià(((
ißpic_i8259
.
­ic
 !ğ
i8259_­ic
è|| (ißpic_i8259.
pš
 !ğ
i8259_pš
)) &&

1224 (
i8259_pš
 >ğ0è&& (
ißpic_i8259
.
pš
 >= 0))

1226 
	`´štk
(
KERN_WARNING
 "ExtINT in hardware‡nd MPable differ\n");

1232 
	`ş—r_IO_APIC
();

1233 
	}
}

1238 
	$di§bË_IO_APIC
()

1243 
	`ş—r_IO_APIC
();

1250 ià(
ißpic_i8259
.
pš
 != -1) {

1251 
IO_APIC_rou‹_’Œy
 
’Œy
;

1253 
	`mem£t
(&
’Œy
, 0, (entry));

1254 
’Œy
.
mask
 = 0;

1255 
’Œy
.
Œigg”
 = 0;

1256 
’Œy
.
œr
 = 0;

1257 
’Œy
.
pŞ¬™y
 = 0;

1258 
’Œy
.
d–iv”y_¡©us
 = 0;

1259 
’Œy
.
de¡_mode
 = 0;

1260 
’Œy
.
d–iv”y_mode
 = 
de¡_ExtINT
;

1261 
’Œy
.
veùÜ
 = 0;

1262 
’Œy
.
de¡
 = 
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
));

1267 
	`ißpic_wr™e_’Œy
(
ißpic_i8259
.
­ic
, ißpic_i8259.
pš
, 
’Œy
);

1270 
	`discÚÃù_b¥_APIC
(
ißpic_i8259
.
pš
 != -1);

1271 
	}
}

1281 
__š™
 
	$tim”_œq_wÜks
()

1283 
t1
 = 
jiff›s
;

1284 
æags
;

1286 
	`loÿl_§ve_æags
(
æags
);

1287 
	`loÿl_œq_’abË
();

1289 
	`md–ay
((10 * 1000è/ 
HZ
);

1290 
	`loÿl_œq_»¡Üe
(
æags
);

1301 ià(
jiff›s
 - 
t1
 > 4)

1304 
	}
}

1329 
	$¡¬tup_ißpic_œq
(
œq
)

1331 
was_³ndšg
 = 0;

1332 
æags
;

1334 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1335 ià(
œq
 < 16) {

1336 
	`di§bË_8259A_œq
(
œq
);

1337 ià(
	`i8259A_œq_³ndšg
(
œq
))

1338 
was_³ndšg
 = 1;

1340 
	`__unmask_IO_APIC_œq
(
œq
);

1341 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1343  
was_³ndšg
;

1344 
	}
}

1346 
	$ißpic_»Œigg”_œq
(
œq
)

1348 
œq_cfg
 *
cfg
 = &œq_cfg[
œq
];

1349 
ıumask_t
 
mask
;

1350 
æags
;

1352 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

1353 
	`ıus_ş—r
(
mask
);

1354 
	`ıu_£t
(
	`fœ¡_ıu
(
cfg
->
domaš
), 
mask
);

1356 
	`£nd_IPI_mask
(
mask
, 
cfg
->
veùÜ
);

1357 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

1360 
	}
}

1371 #ifdeà
CONFIG_SMP


1372 
asmlškage
 
	$smp_œq_move_ş—nup_š‹¼u±
()

1374 
veùÜ
, 
me
;

1375 
	`ack_APIC_œq
();

1376 
	`ex™_idË
();

1377 
	`œq_’‹r
();

1379 
me
 = 
	`smp_´oûssÜ_id
();

1380 
veùÜ
 = 
FIRST_EXTERNAL_VECTOR
; veùÜ < 
NR_VECTORS
; vector++) {

1381 
œq
;

1382 
œq_desc
 *
desc
;

1383 
œq_cfg
 *
cfg
;

1384 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
];

1385 ià(
œq
 >ğ
NR_IRQS
)

1388 
desc
 = 
œq_desc
 + 
œq
;

1389 
cfg
 = 
œq_cfg
 + 
œq
;

1390 
	`¥š_lock
(&
desc
->
lock
);

1391 ià(!
cfg
->
move_ş—nup_couÁ
)

1392 
uÆock
;

1394 ià((
veùÜ
 =ğ
cfg
->veùÜè&& 
	`ıu_is£t
(
me
, cfg->
domaš
))

1395 
uÆock
;

1397 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
] = -1;

1398 
cfg
->
move_ş—nup_couÁ
--;

1399 
uÆock
:

1400 
	`¥š_uÆock
(&
desc
->
lock
);

1403 
	`œq_ex™
();

1404 
	}
}

1406 
	$œq_com¶‘e_move
(
œq
)

1408 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

1409 
veùÜ
, 
me
;

1411 ià(
	`lik–y
(!
cfg
->
move_š_´og»ss
))

1414 
veùÜ
 = ~
	`g‘_œq_»gs
()->
Üig_¿x
;

1415 
me
 = 
	`smp_´oûssÜ_id
();

1416 ià((
veùÜ
 =ğ
cfg
->veùÜè&& 
	`ıu_is£t
(
me
, cfg->
domaš
)) {

1417 
ıumask_t
 
ş—nup_mask
;

1419 
	`ıus_ªd
(
ş—nup_mask
, 
cfg
->
Şd_domaš
, 
ıu_Úlše_m­
);

1420 
cfg
->
move_ş—nup_couÁ
 = 
	`ıus_weight
(
ş—nup_mask
);

1421 
	`£nd_IPI_mask
(
ş—nup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

1422 
cfg
->
move_š_´og»ss
 = 0;

1424 
	}
}

1426 
šlše
 
	$œq_com¶‘e_move
(
œq
è{
	}
}

1429 
	$ack_­ic_edge
(
œq
)

1431 
	`œq_com¶‘e_move
(
œq
);

1432 
	`move_Çtive_œq
(
œq
);

1433 
	`ack_APIC_œq
();

1434 
	}
}

1436 
	$ack_­ic_Ëv–
(
œq
)

1438 
do_unmask_œq
 = 0;

1440 
	`œq_com¶‘e_move
(
œq
);

1441 #ià
	`defšed
(
CONFIG_GENERIC_PENDING_IRQ
è|| defšed(
CONFIG_IRQBALANCE
)

1443 ià(
	`uÆik–y
(
œq_desc
[
œq
].
¡©us
 & 
IRQ_MOVE_PENDING
)) {

1444 
do_unmask_œq
 = 1;

1445 
	`mask_IO_APIC_œq
(
œq
);

1453 
	`ack_APIC_œq
();

1456 ià(
	`uÆik–y
(
do_unmask_œq
)) {

1483 ià(!
	`io_­ic_Ëv–_ack_³ndšg
(
œq
))

1484 
	`move_masked_œq
(
œq
);

1485 
	`unmask_IO_APIC_œq
(
œq
);

1487 
	}
}

1489 
œq_ch
 
ißpic_ch
 
	g__»ad_mo¡ly
 = {

1490 .
Çme
 = "IO-APIC",

1491 .
	g¡¬tup
 = 
¡¬tup_ißpic_œq
,

1492 .
	gmask
 = 
mask_IO_APIC_œq
,

1493 .
	gunmask
 = 
unmask_IO_APIC_œq
,

1494 .
	gack
 = 
ack_­ic_edge
,

1495 .
	geoi
 = 
ack_­ic_Ëv–
,

1496 #ifdeà
CONFIG_SMP


1497 .
	g£t_affš™y
 = 
£t_ißpic_affš™y_œq
,

1499 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

1502 
šlše
 
	$š™_IO_APIC_Œ­s
()

1504 
œq
;

1517 
œq
 = 0; irq < 
NR_IRQS
 ; irq++) {

1518 
tmp
 = 
œq
;

1519 ià(
	`IO_APIC_IRQ
(
tmp
è&& !
œq_cfg
[tmp].
veùÜ
) {

1525 ià(
œq
 < 16)

1526 
	`make_8259A_œq
(
œq
);

1529 
œq_desc
[
œq
].
ch
 = &
no_œq_ch
;

1532 
	}
}

1534 
	$’abË_Ïpic_œq
 (
œq
)

1536 
v
;

1538 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1539 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

1540 
	}
}

1542 
	$di§bË_Ïpic_œq
 (
œq
)

1544 
v
;

1546 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1547 
	`­ic_wr™e
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

1548 
	}
}

1550 
	$ack_Ïpic_œq
 (
œq
)

1552 
	`ack_APIC_œq
();

1553 
	}
}

1555 
	$’d_Ïpic_œq
 (
i
è{ 
	}
}

1557 
hw_š‹¼u±_ty³
 
Ïpic_œq_ty³
 
	g__»ad_mo¡ly
 = {

1558 .
Çme
 = "local-APIC",

1559 .
	gty³Çme
 = "local-APIC-edge",

1560 .
	g¡¬tup
 = 
NULL
,

1561 .
	gshutdown
 = 
NULL
,

1562 .
	g’abË
 = 
’abË_Ïpic_œq
,

1563 .
	gdi§bË
 = 
di§bË_Ïpic_œq
,

1564 .
	gack
 = 
ack_Ïpic_œq
,

1565 .
	g’d
 = 
’d_Ïpic_œq
,

1568 
	$£tup_nmi
 ()

1579 
	`´štk
(
KERN_INFO
 "activating NMI Watchdog ...");

1581 
	`’abË_NMI_through_LVT0
(
NULL
);

1583 
	`´štk
(" done.\n");

1584 
	}
}

1593 
šlše
 
	$uÆock_ExtINT_logic
()

1595 
­ic
, 
pš
, 
i
;

1596 
IO_APIC_rou‹_’Œy
 
’Œy0
, 
’Œy1
;

1597 
§ve_cÚŒŞ
, 
§ve_äeq_£Ëù
;

1598 
æags
;

1600 
pš
 = 
	`fšd_i§_œq_pš
(8, 
mp_INT
);

1601 
­ic
 = 
	`fšd_i§_œq_­ic
(8, 
mp_INT
);

1602 ià(
pš
 == -1)

1605 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1606 *(((*)&
’Œy0
è+ 1èğ
	`io_­ic_»ad
(
­ic
, 0x11 + 2 * 
pš
);

1607 *(((*)&
’Œy0
è+ 0èğ
	`io_­ic_»ad
(
­ic
, 0x10 + 2 * 
pš
);

1608 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1609 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

1611 
	`mem£t
(&
’Œy1
, 0, (entry1));

1613 
’Œy1
.
de¡_mode
 = 0;

1614 
’Œy1
.
mask
 = 0;

1615 
’Œy1
.
de¡
 = 
	`h¬d_smp_´oûssÜ_id
();

1616 
’Œy1
.
d–iv”y_mode
 = 
de¡_ExtINT
;

1617 
’Œy1
.
pŞ¬™y
 = 
’Œy0
.polarity;

1618 
’Œy1
.
Œigg”
 = 0;

1619 
’Œy1
.
veùÜ
 = 0;

1621 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1622 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2 * 
pš
, *(((*)&
’Œy1
) + 1));

1623 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2 * 
pš
, *(((*)&
’Œy1
) + 0));

1624 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1626 
§ve_cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

1627 
§ve_äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

1628 
	`CMOS_WRITE
((
§ve_äeq_£Ëù
 & ~
RTC_RATE_SELECT
) | 0x6,

1629 
RTC_FREQ_SELECT
);

1630 
	`CMOS_WRITE
(
§ve_cÚŒŞ
 | 
RTC_PIE
, 
RTC_CONTROL
);

1632 
i
 = 100;

1633 
i
-- > 0) {

1634 
	`md–ay
(10);

1635 ià((
	`CMOS_READ
(
RTC_INTR_FLAGS
è& 
RTC_PF
) == RTC_PF)

1636 
i
 -= 10;

1639 
	`CMOS_WRITE
(
§ve_cÚŒŞ
, 
RTC_CONTROL
);

1640 
	`CMOS_WRITE
(
§ve_äeq_£Ëù
, 
RTC_FREQ_SELECT
);

1641 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

1643 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1644 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2 * 
pš
, *(((*)&
’Œy0
) + 1));

1645 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2 * 
pš
, *(((*)&
’Œy0
) + 0));

1646 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1647 
	}
}

1657 
šlše
 
	$check_tim”
()

1659 
œq_cfg
 *
cfg
 = irq_cfg + 0;

1660 
­ic1
, 
pš1
, 
­ic2
, 
pš2
;

1661 
æags
;

1663 
	`loÿl_œq_§ve
(
æags
);

1668 
	`di§bË_8259A_œq
(0);

1669 
	`assign_œq_veùÜ
(0, 
TARGET_CPUS
);

1678 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

1679 
	`š™_8259A
(1);

1680 ià(
tim”_ov”_8254
 > 0)

1681 
	`’abË_8259A_œq
(0);

1683 
pš1
 = 
	`fšd_i§_œq_pš
(0, 
mp_INT
);

1684 
­ic1
 = 
	`fšd_i§_œq_­ic
(0, 
mp_INT
);

1685 
pš2
 = 
ißpic_i8259
.
pš
;

1686 
­ic2
 = 
ißpic_i8259
.
­ic
;

1688 
	`­ic_´štk
(
APIC_VERBOSE
,
KERN_INFO
 "..TIMER: vector=0x%02X‡pic1=%d…in1=%d‡pic2=%d…in2=%d\n",

1689 
cfg
->
veùÜ
, 
­ic1
, 
pš1
, 
­ic2
, 
pš2
);

1691 ià(
pš1
 != -1) {

1695 
	`unmask_IO_APIC_œq
(0);

1696 ià(!
no_tim”_check
 && 
	`tim”_œq_wÜks
()) {

1697 
	`nmi_w©chdog_deçuÉ
();

1698 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

1699 
	`di§bË_8259A_œq
(0);

1700 
	`£tup_nmi
();

1701 
	`’abË_8259A_œq
(0);

1703 ià(
di§bË_tim”_pš_1
 > 0)

1704 
	`ş—r_IO_APIC_pš
(0, 
pš1
);

1705 
out
;

1707 
	`ş—r_IO_APIC_pš
(
­ic1
, 
pš1
);

1708 
	`­ic_´štk
(
APIC_QUIET
,
KERN_ERR
 "..MP-BIOS bug: 8254imer‚ot "

1712 
	`­ic_´štk
(
APIC_VERBOSE
,
KERN_INFO
 "...tryingo set upimer (IRQ0) "

1714 ià(
pš2
 != -1) {

1715 
	`­ic_´štk
(
APIC_VERBOSE
,"\n..... (found‡pic %d…in %d) ...",

1716 
­ic2
, 
pš2
);

1720 
	`£tup_ExtINT_IRQ0_pš
(
­ic2
, 
pš2
, 
cfg
->
veùÜ
);

1721 ià(
	`tim”_œq_wÜks
()) {

1722 
	`­ic_´štk
(
APIC_VERBOSE
," works.\n");

1723 
	`nmi_w©chdog_deçuÉ
();

1724 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

1725 
	`£tup_nmi
();

1727 
out
;

1732 
	`ş—r_IO_APIC_pš
(
­ic2
, 
pš2
);

1734 
	`­ic_´štk
(
APIC_VERBOSE
," failed.\n");

1736 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

1737 
	`´štk
(
KERN_WARNING
 "timer doesn't workhroughhe IO-APIC - disabling NMI Watchdog!\n");

1738 
nmi_w©chdog
 = 0;

1741 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO
 "...tryingo set upimer‡s Virtual Wire IRQ...");

1743 
	`di§bË_8259A_œq
(0);

1744 
œq_desc
[0].
ch
 = &
Ïpic_œq_ty³
;

1745 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
veùÜ
);

1746 
	`’abË_8259A_œq
(0);

1748 ià(
	`tim”_œq_wÜks
()) {

1749 
	`­ic_´štk
(
APIC_VERBOSE
," works.\n");

1750 
out
;

1752 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
veùÜ
);

1753 
	`­ic_´štk
(
APIC_VERBOSE
," failed.\n");

1755 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO
 "...tryingo set upimer‡s ExtINT IRQ...");

1757 
	`š™_8259A
(0);

1758 
	`make_8259A_œq
(0);

1759 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1761 
	`uÆock_ExtINT_logic
();

1763 ià(
	`tim”_œq_wÜks
()) {

1764 
	`­ic_´štk
(
APIC_VERBOSE
," works.\n");

1765 
out
;

1767 
	`­ic_´štk
(
APIC_VERBOSE
," failed :(.\n");

1768 
	`·nic
("IO-APIC +imer doesn't work! Try usinghe 'noapic' kernel…arameter\n");

1769 
out
:

1770 
	`loÿl_œq_»¡Üe
(
æags
);

1771 
	}
}

1773 
__š™
 
	$nÙim”check
(*
s
)

1775 
no_tim”_check
 = 1;

1777 
	}
}

1778 
__£tup
("no_tim”_check", 
nÙim”check
);

1787 
	#PIC_IRQS
 (1<<2)

	)

1789 
__š™
 
	$£tup_IO_APIC
()

1791 
	`’abË_IO_APIC
();

1793 ià(
aıi_ißpic
)

1794 
io_­ic_œqs
 = ~0;

1796 
io_­ic_œqs
 = ~
PIC_IRQS
;

1798 
	`­ic_´štk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

1800 
	`sync_Arb_IDs
();

1801 
	`£tup_IO_APIC_œqs
();

1802 
	`š™_IO_APIC_Œ­s
();

1803 
	`check_tim”
();

1804 ià(!
aıi_ißpic
)

1805 
	`´št_IO_APIC
();

1806 
	}
}

1808 
	ssysfs_ißpic_d©a
 {

1809 
sys_deviû
 
	mdev
;

1810 
IO_APIC_rou‹_’Œy
 
	m’Œy
[0];

1812 
sysfs_ißpic_d©a
 * 
	gmp_ißpic_d©a
[
MAX_IO_APICS
];

1814 
	$ißpic_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

1816 
IO_APIC_rou‹_’Œy
 *
’Œy
;

1817 
sysfs_ißpic_d©a
 *
d©a
;

1818 
i
;

1820 
d©a
 = 
	`cÚš”_of
(
dev
, 
sysfs_ißpic_d©a
, dev);

1821 
’Œy
 = 
d©a
->entry;

1822 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
dev
->
id
]; i ++, 
’Œy
 ++ )

1823 *
’Œy
 = 
	`ißpic_»ad_’Œy
(
dev
->
id
, 
i
);

1826 
	}
}

1828 
	$ißpic_»sume
(
sys_deviû
 *
dev
)

1830 
IO_APIC_rou‹_’Œy
 *
’Œy
;

1831 
sysfs_ißpic_d©a
 *
d©a
;

1832 
æags
;

1833 
IO_APIC_»g_00
 
»g_00
;

1834 
i
;

1836 
d©a
 = 
	`cÚš”_of
(
dev
, 
sysfs_ißpic_d©a
, dev);

1837 
’Œy
 = 
d©a
->entry;

1839 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1840 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
dev
->
id
, 0);

1841 ià(
»g_00
.
b™s
.
ID
 !ğ
mp_ißpics
[
dev
->
id
].
mpc_­icid
) {

1842 
»g_00
.
b™s
.
ID
 = 
mp_ißpics
[
dev
->
id
].
mpc_­icid
;

1843 
	`io_­ic_wr™e
(
dev
->
id
, 0, 
»g_00
.
¿w
);

1845 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1846 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
dev
->
id
]; i++)

1847 
	`ißpic_wr™e_’Œy
(
dev
->
id
, 
i
, 
’Œy
[i]);

1850 
	}
}

1852 
sysdev_şass
 
	gißpic_sysdev_şass
 = {

1853 
£t_k£t_Çme
("ioapic"),

1854 .
su¥’d
 = 
ißpic_su¥’d
,

1855 .
	g»sume
 = 
ißpic_»sume
,

1858 
__š™
 
	$ißpic_š™_sysfs
()

1860 
sys_deviû
 * 
dev
;

1861 
i
, 
size
, 
”rÜ
;

1863 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
ißpic_sysdev_şass
);

1864 ià(
”rÜ
)

1865  
”rÜ
;

1867 
i
 = 0; i < 
Ä_ißpics
; i++ ) {

1868 
size
 = (
sys_deviû
è+ 
Ä_ißpic_»gi¡”s
[
i
]

1869 * (
IO_APIC_rou‹_’Œy
);

1870 
mp_ißpic_d©a
[
i
] = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

1871 ià(!
mp_ißpic_d©a
[
i
]) {

1872 
	`´štk
(
KERN_ERR
 "Cª'ˆsu¥’d/»sumIOAPIC %d\n", 
i
);

1875 
dev
 = &
mp_ißpic_d©a
[
i
]->dev;

1876 
dev
->
id
 = 
i
;

1877 
dev
->
şs
 = &
ißpic_sysdev_şass
;

1878 
”rÜ
 = 
	`sysdev_»gi¡”
(
dev
);

1879 ià(
”rÜ
) {

1880 
	`kä“
(
mp_ißpic_d©a
[
i
]);

1881 
mp_ißpic_d©a
[
i
] = 
NULL
;

1882 
	`´štk
(
KERN_ERR
 "Cª'ˆsu¥’d/»sumIOAPIC %d\n", 
i
);

1888 
	}
}

1890 
deviû_š™ÿÎ
(
ißpic_š™_sysfs
);

1895 
	$ü—‹_œq
()

1898 
œq
;

1899 
Ãw
;

1900 
æags
;

1902 
œq
 = -
ENOSPC
;

1903 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

1904 
Ãw
 = (
NR_IRQS
 - 1);‚ew >= 0;‚ew--) {

1905 ià(
	`¶©fÜm_Ëgacy_œq
(
Ãw
))

1907 ià(
œq_cfg
[
Ãw
].
veùÜ
 != 0)

1909 ià(
	`__assign_œq_veùÜ
(
Ãw
, 
TARGET_CPUS
) == 0)

1910 
œq
 = 
Ãw
;

1913 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

1915 ià(
œq
 >= 0) {

1916 
	`dyÇmic_œq_š™
(
œq
);

1918  
œq
;

1919 
	}
}

1921 
	$de¡roy_œq
(
œq
)

1923 
æags
;

1925 
	`dyÇmic_œq_ş—nup
(
œq
);

1927 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

1928 
	`__ş—r_œq_veùÜ
(
œq
);

1929 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

1930 
	}
}

1935 #ifdeà
CONFIG_PCI_MSI


1936 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
œq
, 
msi_msg
 *
msg
)

1938 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

1939 
”r
;

1940 
de¡
;

1941 
ıumask_t
 
tmp
;

1943 
tmp
 = 
TARGET_CPUS
;

1944 
”r
 = 
	`assign_œq_veùÜ
(
œq
, 
tmp
);

1945 ià(!
”r
) {

1946 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
,mp);

1947 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

1949 
msg
->
add»ss_hi
 = 
MSI_ADDR_BASE_HI
;

1950 
msg
->
add»ss_lo
 =

1951 
MSI_ADDR_BASE_LO
 |

1952 ((
INT_DEST_MODE
 == 0) ?

1953 
MSI_ADDR_DEST_MODE_PHYSICAL
:

1954 
MSI_ADDR_DEST_MODE_LOGICAL
) |

1955 ((
INT_DELIVERY_MODE
 !ğ
de¡_Lowe¡Prio
) ?

1956 
MSI_ADDR_REDIRECTION_CPU
:

1957 
MSI_ADDR_REDIRECTION_LOWPRI
) |

1958 
	`MSI_ADDR_DEST_ID
(
de¡
);

1960 
msg
->
d©a
 =

1961 
MSI_DATA_TRIGGER_EDGE
 |

1962 
MSI_DATA_LEVEL_ASSERT
 |

1963 ((
INT_DELIVERY_MODE
 !ğ
de¡_Lowe¡Prio
) ?

1964 
MSI_DATA_DELIVERY_FIXED
:

1965 
MSI_DATA_DELIVERY_LOWPRI
) |

1966 
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

1968  
”r
;

1969 
	}
}

1971 #ifdeà
CONFIG_SMP


1972 
	$£t_msi_œq_affš™y
(
œq
, 
ıumask_t
 
mask
)

1974 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

1975 
msi_msg
 
msg
;

1976 
de¡
;

1977 
ıumask_t
 
tmp
;

1979 
	`ıus_ªd
(
tmp
, 
mask
, 
ıu_Úlše_m­
);

1980 ià(
	`ıus_em±y
(
tmp
))

1983 ià(
	`assign_œq_veùÜ
(
œq
, 
mask
))

1986 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
, 
mask
);

1987 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

1989 
	`»ad_msi_msg
(
œq
, &
msg
);

1991 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

1992 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

1993 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

1994 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

1996 
	`wr™e_msi_msg
(
œq
, &
msg
);

1997 
œq_desc
[
œq
].
affš™y
 = 
mask
;

1998 
	}
}

2005 
œq_ch
 
	gmsi_ch
 = {

2006 .
Çme
 = "PCI-MSI",

2007 .
	gunmask
 = 
unmask_msi_œq
,

2008 .
	gmask
 = 
mask_msi_œq
,

2009 .
	gack
 = 
ack_­ic_edge
,

2010 #ifdeà
CONFIG_SMP


2011 .
	g£t_affš™y
 = 
£t_msi_œq_affš™y
,

2013 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

2016 
	$¬ch_£tup_msi_œq
(
pci_dev
 *
dev
, 
msi_desc
 *
desc
)

2018 
msi_msg
 
msg
;

2019 
œq
, 
»t
;

2020 
œq
 = 
	`ü—‹_œq
();

2021 ià(
œq
 < 0)

2022  
œq
;

2024 
»t
 = 
	`msi_compo£_msg
(
dev
, 
œq
, &
msg
);

2025 ià(
»t
 < 0) {

2026 
	`de¡roy_œq
(
œq
);

2027  
»t
;

2030 
	`£t_œq_msi
(
œq
, 
desc
);

2031 
	`wr™e_msi_msg
(
œq
, &
msg
);

2033 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
msi_ch
, 
hªdË_edge_œq
, "edge");

2036 
	}
}

2038 
	$¬ch_‹¬down_msi_œq
(
œq
)

2040 
	`de¡roy_œq
(
œq
);

2041 
	}
}

2043 #ifdeà
CONFIG_DMAR


2044 #ifdeà
CONFIG_SMP


2045 
	$dm¬_msi_£t_affš™y
(
œq
, 
ıumask_t
 
mask
)

2047 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

2048 
msi_msg
 
msg
;

2049 
de¡
;

2050 
ıumask_t
 
tmp
;

2052 
	`ıus_ªd
(
tmp
, 
mask
, 
ıu_Úlše_m­
);

2053 ià(
	`ıus_em±y
(
tmp
))

2056 ià(
	`assign_œq_veùÜ
(
œq
, 
mask
))

2059 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
, 
mask
);

2060 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

2062 
	`dm¬_msi_»ad
(
œq
, &
msg
);

2064 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

2065 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

2066 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

2067 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

2069 
	`dm¬_msi_wr™e
(
œq
, &
msg
);

2070 
œq_desc
[
œq
].
affš™y
 = 
mask
;

2071 
	}
}

2074 
œq_ch
 
	gdm¬_msi_ty³
 = {

2075 .
Çme
 = "DMAR_MSI",

2076 .
	gunmask
 = 
dm¬_msi_unmask
,

2077 .
	gmask
 = 
dm¬_msi_mask
,

2078 .
	gack
 = 
ack_­ic_edge
,

2079 #ifdeà
CONFIG_SMP


2080 .
	g£t_affš™y
 = 
dm¬_msi_£t_affš™y
,

2082 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

2085 
	$¬ch_£tup_dm¬_msi
(
œq
)

2087 
»t
;

2088 
msi_msg
 
msg
;

2090 
»t
 = 
	`msi_compo£_msg
(
NULL
, 
œq
, &
msg
);

2091 ià(
»t
 < 0)

2092  
»t
;

2093 
	`dm¬_msi_wr™e
(
œq
, &
msg
);

2094 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
dm¬_msi_ty³
, 
hªdË_edge_œq
,

2097 
	}
}

2104 #ifdeà
CONFIG_HT_IRQ


2106 #ifdeà
CONFIG_SMP


2108 
	$rg‘_ht_œq
(
œq
, 
de¡
, 
u8
 
veùÜ
)

2110 
ht_œq_msg
 
msg
;

2111 
	`ãtch_ht_œq_msg
(
œq
, &
msg
);

2113 
msg
.
add»ss_lo
 &ğ~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

2114 
msg
.
add»ss_hi
 &ğ~(
HT_IRQ_HIGH_DEST_ID_MASK
);

2116 
msg
.
add»ss_lo
 |ğ
	`HT_IRQ_LOW_VECTOR
(
veùÜ
è| 
	`HT_IRQ_LOW_DEST_ID
(
de¡
);

2117 
msg
.
add»ss_hi
 |ğ
	`HT_IRQ_HIGH_DEST_ID
(
de¡
);

2119 
	`wr™e_ht_œq_msg
(
œq
, &
msg
);

2120 
	}
}

2122 
	$£t_ht_œq_affš™y
(
œq
, 
ıumask_t
 
mask
)

2124 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

2125 
de¡
;

2126 
ıumask_t
 
tmp
;

2128 
	`ıus_ªd
(
tmp
, 
mask
, 
ıu_Úlše_m­
);

2129 ià(
	`ıus_em±y
(
tmp
))

2132 ià(
	`assign_œq_veùÜ
(
œq
, 
mask
))

2135 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
, 
mask
);

2136 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

2138 
	`rg‘_ht_œq
(
œq
, 
de¡
, 
cfg
->
veùÜ
);

2139 
œq_desc
[
œq
].
affš™y
 = 
mask
;

2140 
	}
}

2143 
œq_ch
 
	ght_œq_ch
 = {

2144 .
Çme
 = "PCI-HT",

2145 .
	gmask
 = 
mask_ht_œq
,

2146 .
	gunmask
 = 
unmask_ht_œq
,

2147 .
	gack
 = 
ack_­ic_edge
,

2148 #ifdeà
CONFIG_SMP


2149 .
	g£t_affš™y
 = 
£t_ht_œq_affš™y
,

2151 .
	g»Œigg”
 = 
ißpic_»Œigg”_œq
,

2154 
	$¬ch_£tup_ht_œq
(
œq
, 
pci_dev
 *
dev
)

2156 
œq_cfg
 *
cfg
 = irq_cfg + 
œq
;

2157 
”r
;

2158 
ıumask_t
 
tmp
;

2160 
tmp
 = 
TARGET_CPUS
;

2161 
”r
 = 
	`assign_œq_veùÜ
(
œq
, 
tmp
);

2162 ià(!
”r
) {

2163 
ht_œq_msg
 
msg
;

2164 
de¡
;

2166 
	`ıus_ªd
(
tmp
, 
cfg
->
domaš
,mp);

2167 
de¡
 = 
	`ıu_mask_to_­icid
(
tmp
);

2169 
msg
.
add»ss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de¡
);

2171 
msg
.
add»ss_lo
 =

2172 
HT_IRQ_LOW_BASE
 |

2173 
	`HT_IRQ_LOW_DEST_ID
(
de¡
) |

2174 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
veùÜ
) |

2175 ((
INT_DEST_MODE
 == 0) ?

2176 
HT_IRQ_LOW_DM_PHYSICAL
 :

2177 
HT_IRQ_LOW_DM_LOGICAL
) |

2178 
HT_IRQ_LOW_RQEOI_EDGE
 |

2179 ((
INT_DELIVERY_MODE
 !ğ
de¡_Lowe¡Prio
) ?

2180 
HT_IRQ_LOW_MT_FIXED
 :

2181 
HT_IRQ_LOW_MT_ARBITRATED
) |

2182 
HT_IRQ_LOW_IRQ_MASKED
;

2184 
	`wr™e_ht_œq_msg
(
œq
, &
msg
);

2186 
	`£t_œq_ch_ªd_hªdËr_Çme
(
œq
, &
ht_œq_ch
,

2187 
hªdË_edge_œq
, "edge");

2189  
”r
;

2190 
	}
}

2197 #ifdeà
CONFIG_ACPI


2199 
	#IO_APIC_MAX_ID
 0xFE

	)

2201 
__š™
 
	$io_­ic_g‘_»dœ_’Œ›s
 (
ißpic
)

2203 
IO_APIC_»g_01
 
»g_01
;

2204 
æags
;

2206 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2207 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 1);

2208 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2210  
»g_01
.
b™s
.
’Œ›s
;

2211 
	}
}

2214 
	$io_­ic_£t_pci_routšg
 (
ißpic
, 
pš
, 
œq
, 
Œigg”šg
, 
pŞ¬™y
)

2216 ià(!
	`IO_APIC_IRQ
(
œq
)) {

2217 
	`­ic_´štk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: Invalid„eferenceo IRQ 0\n",

2218 
ißpic
);

2219  -
EINVAL
;

2225 ià(
œq
 >= 16)

2226 
	`add_pš_to_œq
(
œq
, 
ißpic
, 
pš
);

2228 
	`£tup_IO_APIC_œq
(
ißpic
, 
pš
, 
œq
, 
Œigg”šg
, 
pŞ¬™y
);

2231 
	}
}

2234 
	$aıi_g‘_ov”ride_œq
(
bus_œq
, *
Œigg”
, *
pŞ¬™y
)

2236 
i
;

2238 ià(
sk_ißpic_£tup
)

2241 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

2242 ià(
mp_œqs
[
i
].
mpc_œqty³
 =ğ
mp_INT
 &&

2243 
mp_œqs
[
i
].
mpc_¤cbusœq
 =ğ
bus_œq
)

2245 ià(
i
 >ğ
mp_œq_’Œ›s
)

2248 *
Œigg”
 = 
	`œq_Œigg”
(
i
);

2249 *
pŞ¬™y
 = 
	`œq_pŞ¬™y
(
i
);

2251 
	}
}

2260 #ifdeà
CONFIG_SMP


2261 
__š™
 
	$£tup_ißpic_de¡
()

2263 
pš
, 
ißpic
, 
œq
, 
œq_’Œy
;

2265 ià(
sk_ißpic_£tup
 == 1)

2268 
ißpic
 = 0; ißpiø< 
Ä_ißpics
; ioapic++) {

2269 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
ißpic
];…in++) {

2270 
œq_’Œy
 = 
	`fšd_œq_’Œy
(
ißpic
, 
pš
, 
mp_INT
);

2271 ià(
œq_’Œy
 == -1)

2273 
œq
 = 
	`pš_2_œq
(
œq_’Œy
, 
ißpic
, 
pš
);

2279 ià(!
œq_cfg
[
œq
].
veùÜ
)

2280 
	`£tup_IO_APIC_œq
(
ißpic
, 
pš
, 
œq
,

2281 
	`œq_Œigg”
(
œq_’Œy
),

2282 
	`œq_pŞ¬™y
(
œq_’Œy
));

2284 
	`£t_ißpic_affš™y_œq
(
œq
, 
TARGET_CPUS
);

2288 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ioport_64.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/ÿ·b™y.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/ty³s.h
>

11 
	~<lšux/iİÜt.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/¡ddef.h
>

14 
	~<lšux/¦ab.h
>

15 
	~<lšux/th»ad_šfo.h
>

16 
	~<lšux/sysÿÎs.h
>

19 
	$£t_b™m­
(*
b™m­
, 
ba£
, 
ex‹Á
, 
Ãw_v®ue
)

21 
i
;

22 ià(
Ãw_v®ue
)

23 
i
 = 
ba£
; i < ba£ + 
ex‹Á
; i++)

24 
	`__£t_b™
(
i
, 
b™m­
);

26 
i
 = 
ba£
; i < ba£ + 
ex‹Á
; i++)

27 
	`ş—r_b™
(
i
, 
b™m­
);

28 
	}
}

33 
asmlškage
 
	$sys_iİ”m
(
äom
, 
num
, 
tuº_Ú
)

35 
i
, 
max_lÚg
, 
by‹s
, 
by‹s_upd©ed
;

36 
th»ad_¡ruù
 * 
t
 = &
cu¼’t
->
th»ad
;

37 
tss_¡ruù
 * 
tss
;

38 *
b™m­
;

40 ià((
äom
 + 
num
 <ğäomè|| (äom +‚um > 
IO_BITMAP_BITS
))

41  -
EINVAL
;

42 ià(
tuº_Ú
 && !
	`ÿ·bË
(
CAP_SYS_RAWIO
))

43  -
EPERM
;

50 ià(!
t
->
io_b™m­_±r
) {

51 
b™m­
 = 
	`km®loc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

52 ià(!
b™m­
)

53  -
ENOMEM
;

55 
	`mem£t
(
b™m­
, 0xff, 
IO_BITMAP_BYTES
);

56 
t
->
io_b™m­_±r
 = 
b™m­
;

57 
	`£t_th»ad_æag
(
TIF_IO_BITMAP
);

67 
tss
 = &
	`³r_ıu
(
š™_tss
, 
	`g‘_ıu
());

69 
	`£t_b™m­
(
t
->
io_b™m­_±r
, 
äom
, 
num
, !
tuº_Ú
);

75 
max_lÚg
 = 0;

76 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

77 ià(
t
->
io_b™m­_±r
[
i
] != ~0UL)

78 
max_lÚg
 = 
i
;

80 
by‹s
 = (
max_lÚg
 + 1) * ();

81 
by‹s_upd©ed
 = 
	`max
(
by‹s
, 
t
->
io_b™m­_max
);

83 
t
->
io_b™m­_max
 = 
by‹s
;

86 
	`memıy
(
tss
->
io_b™m­
, 
t
->
io_b™m­_±r
, 
by‹s_upd©ed
);

88 
	`put_ıu
();

91 
	}
}

104 
asmlškage
 
	$sys_iİl
(
Ëv–
, 
±_»gs
 *
»gs
)

106 
Şd
 = (
»gs
->
eæags
 >> 12) & 3;

108 ià(
Ëv–
 > 3)

109  -
EINVAL
;

111 ià(
Ëv–
 > 
Şd
) {

112 ià(!
	`ÿ·bË
(
CAP_SYS_RAWIO
))

113  -
EPERM
;

115 
»gs
->
eæags
 = (»gs->eæag &~ 
X86_EFLAGS_IOPL
è| (
Ëv–
 << 12);

117 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<lšux/k”Ãl_¡©.h
>

12 
	~<lšux/š‹¼u±.h
>

13 
	~<lšux/£q_fe.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<asm/uacûss.h
>

17 
	~<asm/io_­ic.h
>

18 
	~<asm/idË.h
>

19 
	~<asm/smp.h
>

21 
©omic_t
 
	gœq_”r_couÁ
;

23 #ifdeà
CONFIG_DEBUG_STACKOVERFLOW


31 
šlše
 
	$¡ack_ov”æow_check
(
±_»gs
 *
»gs
)

33 
u64
 
curba£
 = (u64)
	`sk_¡ack_·ge
(
cu¼’t
);

34 
w¬Ãd
 = -60*
HZ
;

36 ià(
»gs
->
r¥
 >ğ
curba£
 &&„egs->r¥ <ğcurba£ + 
THREAD_SIZE
 &&

37 
»gs
->
r¥
 < 
curba£
 + (
th»ad_šfo
) + 128 &&

38 
	`time_aá”
(
jiff›s
, 
w¬Ãd
 + 60*
HZ
)) {

39 
	`´štk
("do_IRQ: %s‚ear stack overflow (cur:%Lx,rsp:%lx)\n",

40 
cu¼’t
->
comm
, 
curba£
, 
»gs
->
r¥
);

41 
	`show_¡ack
(
NULL
,NULL);

42 
w¬Ãd
 = 
jiff›s
;

44 
	}
}

51 
	$show_š‹¼u±s
(
£q_fe
 *
p
, *
v
)

53 
i
 = *(
loff_t
 *è
v
, 
j
;

54 
œqaùiÚ
 * 
aùiÚ
;

55 
æags
;

57 ià(
i
 == 0) {

58 
	`£q_´štf
(
p
, " ");

59 
	`fÜ_—ch_Úlše_ıu
(
j
)

60 
	`£q_´štf
(
p
, "CPU%-8d",
j
);

61 
	`£q_putc
(
p
, '\n');

64 ià(
i
 < 
NR_IRQS
) {

65 
ªy_couÁ
 = 0;

67 
	`¥š_lock_œq§ve
(&
œq_desc
[
i
].
lock
, 
æags
);

68 #iâdeà
CONFIG_SMP


69 
ªy_couÁ
 = 
	`k¡©_œqs
(
i
);

71 
	`fÜ_—ch_Úlše_ıu
(
j
)

72 
ªy_couÁ
 |ğ
	`k¡©_ıu
(
j
).
œqs
[
i
];

74 
aùiÚ
 = 
œq_desc
[
i
].action;

75 ià(!
aùiÚ
 && !
ªy_couÁ
)

76 
sk
;

77 
	`£q_´štf
(
p
, "%3d: ",
i
);

78 #iâdeà
CONFIG_SMP


79 
	`£q_´štf
(
p
, "%10u ", 
	`k¡©_œqs
(
i
));

81 
	`fÜ_—ch_Úlše_ıu
(
j
)

82 
	`£q_´štf
(
p
, "%10u ", 
	`k¡©_ıu
(
j
).
œqs
[
i
]);

84 
	`£q_´štf
(
p
, " %8s", 
œq_desc
[
i
].
ch
->
Çme
);

85 
	`£q_´štf
(
p
, "-%-8s", 
œq_desc
[
i
].
Çme
);

87 ià(
aùiÚ
) {

88 
	`£q_´štf
(
p
, " %s", 
aùiÚ
->
Çme
);

89 (
aùiÚ
 =‡ùiÚ->
Ãxt
è!ğ
NULL
)

90 
	`£q_´štf
(
p
, ", %s", 
aùiÚ
->
Çme
);

92 
	`£q_putc
(
p
, '\n');

93 
sk
:

94 
	`¥š_uÆock_œq»¡Üe
(&
œq_desc
[
i
].
lock
, 
æags
);

95 } ià(
i
 =ğ
NR_IRQS
) {

96 
	`£q_´štf
(
p
, "NMI: ");

97 
	`fÜ_—ch_Úlše_ıu
(
j
)

98 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
__nmi_couÁ
);

99 
	`£q_´štf
(
p
, " Non-maskable interrupts\n");

100 
	`£q_´štf
(
p
, "LOC: ");

101 
	`fÜ_—ch_Úlše_ıu
(
j
)

102 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
­ic_tim”_œqs
);

103 
	`£q_´štf
(
p
, " Localimer interrupts\n");

104 #ifdeà
CONFIG_SMP


105 
	`£q_´štf
(
p
, "RES: ");

106 
	`fÜ_—ch_Úlše_ıu
(
j
)

107 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_»sched_couÁ
);

108 
	`£q_´štf
(
p
, " Rescheduling interrupts\n");

109 
	`£q_´štf
(
p
, "CAL: ");

110 
	`fÜ_—ch_Úlše_ıu
(
j
)

111 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_ÿÎ_couÁ
);

112 
	`£q_´štf
(
p
, " function call interrupts\n");

113 
	`£q_´štf
(
p
, "TLB: ");

114 
	`fÜ_—ch_Úlše_ıu
(
j
)

115 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_b_couÁ
);

116 
	`£q_´štf
(
p
, " TLB shootdowns\n");

118 
	`£q_´štf
(
p
, "TRM: ");

119 
	`fÜ_—ch_Úlše_ıu
(
j
)

120 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_th”m®_couÁ
);

121 
	`£q_´štf
(
p
, " Thermalƒvent interrupts\n");

122 
	`£q_´štf
(
p
, "THR: ");

123 
	`fÜ_—ch_Úlše_ıu
(
j
)

124 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_th»shŞd_couÁ
);

125 
	`£q_´štf
(
p
, " Threshold APIC interrupts\n");

126 
	`£q_´štf
(
p
, "SPU: ");

127 
	`fÜ_—ch_Úlše_ıu
(
j
)

128 
	`£q_´štf
(
p
, "%10u ", 
	`ıu_pda
(
j
)->
œq_¥urious_couÁ
);

129 
	`£q_´štf
(
p
, " Spurious interrupts\n");

130 
	`£q_´štf
(
p
, "ERR: %10u\n", 
	`©omic_»ad
(&
œq_”r_couÁ
));

133 
	}
}

140 
asmlškage
 
	$do_IRQ
(
±_»gs
 *
»gs
)

142 
±_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

145 
veùÜ
 = ~
»gs
->
Üig_¿x
;

146 
œq
;

148 
	`ex™_idË
();

149 
	`œq_’‹r
();

150 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
];

152 #ifdeà
CONFIG_DEBUG_STACKOVERFLOW


153 
	`¡ack_ov”æow_check
(
»gs
);

156 ià(
	`lik–y
(
œq
 < 
NR_IRQS
))

157 
	`g’”ic_hªdË_œq
(
œq
);

159 ià(!
di§bË_­ic
)

160 
	`ack_APIC_œq
();

162 ià(
	`´štk_¿‹lim™
())

163 
	`´štk
(
KERN_EMERG
 "%s: %d.%d No irq handler for vector\n",

164 
__func__
, 
	`smp_´oûssÜ_id
(), 
veùÜ
);

167 
	`œq_ex™
();

169 
	`£t_œq_»gs
(
Şd_»gs
);

171 
	}
}

173 #ifdeà
CONFIG_HOTPLUG_CPU


174 
	$fixup_œqs
(
ıumask_t
 
m­
)

176 
œq
;

177 
w¬Ãd
;

179 
œq
 = 0; irq < 
NR_IRQS
; irq++) {

180 
ıumask_t
 
mask
;

181 
b»ak_affš™y
 = 0;

182 
£t_affš™y
 = 1;

184 ià(
œq
 == 2)

188 
	`¥š_lock
(&
œq_desc
[
œq
].
lock
);

190 ià(!
	`œq_has_aùiÚ
(
œq
) ||

191 
	`ıus_equ®
(
œq_desc
[
œq
].
affš™y
, 
m­
)) {

192 
	`¥š_uÆock
(&
œq_desc
[
œq
].
lock
);

196 
	`ıus_ªd
(
mask
, 
œq_desc
[
œq
].
affš™y
, 
m­
);

197 ià(
	`ıus_em±y
(
mask
)) {

198 
b»ak_affš™y
 = 1;

199 
mask
 = 
m­
;

202 ià(
œq_desc
[
œq
].
ch
->
mask
)

203 
œq_desc
[
œq
].
ch
->
	`mask
(irq);

205 ià(
œq_desc
[
œq
].
ch
->
£t_affš™y
)

206 
œq_desc
[
œq
].
ch
->
	`£t_affš™y
(œq, 
mask
);

207 ià(!(
w¬Ãd
++))

208 
£t_affš™y
 = 0;

210 ià(
œq_desc
[
œq
].
ch
->
unmask
)

211 
œq_desc
[
œq
].
ch
->
	`unmask
(irq);

213 
	`¥š_uÆock
(&
œq_desc
[
œq
].
lock
);

215 ià(
b»ak_affš™y
 && 
£t_affš™y
)

216 
	`´štk
("Brokaffš™y fÜ irq %i\n", 
œq
);

217 ià(!
£t_affš™y
)

218 
	`´štk
("CªnÙ s‘‡ffš™y fÜ irq %i\n", 
œq
);

222 
	`loÿl_œq_’abË
();

223 
	`md–ay
(1);

224 
	`loÿl_œq_di§bË
();

225 
	}
}

228 
ÿÎ_soáœq
();

230 
asmlškage
 
	$do_soáœq
()

232 
__u32
 
³ndšg
;

233 
æags
;

235 ià(
	`š_š‹¼u±
())

238 
	`loÿl_œq_§ve
(
æags
);

239 
³ndšg
 = 
	`loÿl_soáœq_³ndšg
();

241 ià(
³ndšg
) {

242 
	`ÿÎ_soáœq
();

243 
	`WARN_ON_ONCE
(
	`soáœq_couÁ
());

245 
	`loÿl_œq_»¡Üe
(
æags
);

246 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<lšux/gå.h
>

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/š™.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/¥šlock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_nÜthbridges
;

14 
EXPORT_SYMBOL
(
num_k8_nÜthbridges
);

16 
u32
 *
	gæush_wÜds
;

18 
pci_deviû_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 0x1103) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 0x1203) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_nÜthbridges
;

26 
EXPORT_SYMBOL
(
k8_nÜthbridges
);

28 
pci_dev
 *
	$Ãxt_k8_nÜthbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_g‘_deviû
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 ià(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ÿche_k8_nÜthbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 ià(
num_k8_nÜthbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`Ãxt_k8_nÜthbridge
(dev)è!ğ
NULL
)

48 
num_k8_nÜthbridges
++;

50 
k8_nÜthbridges
 = 
	`km®loc
((
num_k8_nÜthbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 ià(!
k8_nÜthbridges
)

53  -
ENOMEM
;

55 ià(!
num_k8_nÜthbridges
) {

56 
k8_nÜthbridges
[0] = 
NULL
;

60 
æush_wÜds
 = 
	`km®loc
(
num_k8_nÜthbridges
 * (
u32
), 
GFP_KERNEL
);

61 ià(!
æush_wÜds
) {

62 
	`kä“
(
k8_nÜthbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`Ãxt_k8_nÜthbridge
(dev)è!ğ
NULL
) {

69 
k8_nÜthbridges
[
i
] = 
dev
;

70 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x9c, &
æush_wÜds
[
i
++]);

72 
k8_nÜthbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ÿche_k8_nÜthbridges
);

79 
__š™
 
	$—¾y_is_k8_nb
(
u32
 
deviû
)

81 
pci_deviû_id
 *
id
;

82 
u32
 
v’dÜ
 = 
deviû
 & 0xffff;

83 
deviû
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
v’dÜ
; id++)

85 ià(
v’dÜ
 =ğ
id
->v’dÜ && 
deviû
 == id->device)

88 
	}
}

90 
	$k8_æush_g¬ts
()

92 
æushed
, 
i
;

93 
æags
;

94 
	`DEFINE_SPINLOCK
(
g¬t_lock
);

100 
	`¥š_lock_œq§ve
(&
g¬t_lock
, 
æags
);

101 
æushed
 = 0;

102 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

103 
	`pci_wr™e_cÚfig_dwÜd
(
k8_nÜthbridges
[
i
], 0x9c,

104 
æush_wÜds
[
i
]|1);

105 
æushed
++;

107 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_»ad_cÚfig_dwÜd
(
k8_nÜthbridges
[
i
],

112 0x9c, &
w
);

113 ià(!(
w
 & 1))

115 
	`ıu_»Ïx
();

118 
	`¥š_uÆock_œq»¡Üe
(&
g¬t_lock
, 
æags
);

119 ià(!
æushed
)

120 
	`´štk
("nothingo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_æush_g¬ts
);

	@/cmpt816/linux/arch/x86/kernel/kprobes_64.c

33 
	~<lšux/k´obes.h
>

34 
	~<lšux/±¿û.h
>

35 
	~<lšux/¡ršg.h
>

36 
	~<lšux/¦ab.h
>

37 
	~<lšux/´“m±.h
>

38 
	~<lšux/moduË.h
>

39 
	~<lšux/kdebug.h
>

41 
	~<asm/pgbË.h
>

42 
	~<asm/uacûss.h
>

43 
	~<asm/®‹º©ive.h
>

45 
j´obe_»tuº_’d
();

46 
__k´obes
 
¬ch_cİy_k´obe
(
k´obe
 *
p
);

48 
DEFINE_PER_CPU
(
k´obe
 *, 
cu¼’t_k´obe
èğ
NULL
;

49 
DEFINE_PER_CPU
(
k´obe_ùlblk
, kprobe_ctlblk);

51 
k»robe_bÏckpošt
 
	gk»robe_bÏckli¡
[] = {

54 {
NULL
, NULL}

56 cÚ¡ 
	gk»robe_bÏckli¡_size
 = 
ARRAY_SIZE
(
k»robe_bÏckli¡
);

61 
__k´obes
 
	$is_IF_modif›r
(
k´obe_İcode_t
 *
š¢
)

63 *
š¢
) {

71 ià(*
š¢
 >= 0x40 && *insn <= 0x4f && *++insn == 0xcf)

74 
	}
}

76 
__k´obes
 
	$¬ch_´•¬e_k´obe
(
k´obe
 *
p
)

79 
p
->
aš¢
.
š¢
 = 
	`g‘_š¢_¦Ù
();

80 ià(!
p
->
aš¢
.
š¢
) {

81  -
ENOMEM
;

83 
	`¬ch_cİy_k´obe
(
p
);

85 
	}
}

92 
s32
 
__k´obes
 *
	$is_r»l
(
u8
 *
š¢
)

94 
	#W
(
row
,
b0
,
b1
,
b2
,
b3
,
b4
,
b5
,
b6
,
b7
,
b8
,
b9
,
ba
,
bb
,
bc
,
bd
,
be
,
bf
) \

95 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

96 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

97 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

98 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

99 << (
row
 % 64))

	)

100 cÚ¡ 
u64
 
Úeby‹_has_modrm
[256 / 64] = {

103 
	`W
(0x00, 1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0)|

104 
	`W
(0x10, 1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0)|

105 
	`W
(0x20, 1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0)|

106 
	`W
(0x30, 1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0),

107 
	`W
(0x40, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

108 
	`W
(0x50, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

109 
	`W
(0x60, 0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0)|

110 
	`W
(0x70, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),

111 
	`W
(0x80, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

112 
	`W
(0x90, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

113 
	`W
(0xa0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

114 
	`W
(0xb0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),

115 
	`W
(0xc0, 1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0)|

116 
	`W
(0xd0, 1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1)|

117 
	`W
(0xe0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

118 
	`W
(0xf0, 0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1)

122 cÚ¡ 
u64
 
twoby‹_has_modrm
[256 / 64] = {

125 
	`W
(0x00, 1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1)|

126 
	`W
(0x10, 1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0)|

127 
	`W
(0x20, 1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1)|

128 
	`W
(0x30, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),

129 
	`W
(0x40, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

130 
	`W
(0x50, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

131 
	`W
(0x60, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

132 
	`W
(0x70, 1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1),

133 
	`W
(0x80, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)|

134 
	`W
(0x90, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

135 
	`W
(0xa0, 0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1)|

136 
	`W
(0xb0, 1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1),

137 
	`W
(0xc0, 1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0)|

138 
	`W
(0xd0, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

139 
	`W
(0xe0, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)|

140 
	`W
(0xf0, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0)

144 #undeà
W


145 
Ãed_modrm
;

149 *
š¢
) {

161 ++
š¢
;

168 ià((*
š¢
 & 0xf0) == 0x40)

169 ++
š¢
;

171 ià(*
š¢
 == 0x0f) {

172 ++
š¢
;

173 
Ãed_modrm
 = 
	`‹¡_b™
(*
š¢
, 
twoby‹_has_modrm
);

175 
Ãed_modrm
 = 
	`‹¡_b™
(*
š¢
, 
Úeby‹_has_modrm
);

178 ià(
Ãed_modrm
) {

179 
u8
 
modrm
 = *++
š¢
;

180 ià((
modrm
 & 0xc7) == 0x05) {

182  (
s32
 *è++
š¢
;

187  
NULL
;

188 
	}
}

190 
__k´obes
 
	$¬ch_cİy_k´obe
(
k´obe
 *
p
)

192 
s32
 *
rdi¥
;

193 
	`memıy
(
p
->
aš¢
.
š¢
,…->
addr
, 
MAX_INSN_SIZE
);

194 
rdi¥
 = 
	`is_r»l
(
p
->
aš¢
.
š¢
);

195 ià(
rdi¥
) {

209 
s64
 
di¥
 = (
u8
 *è
p
->
addr
 + *
rdi¥
 - (u8 *èp->
aš¢
.
š¢
;

210 
	`BUG_ON
((
s64
è(
s32
è
di¥
 != disp);

211 *
rdi¥
 = 
di¥
;

213 
p
->
İcode
 = *p->
addr
;

214 
	}
}

216 
__k´obes
 
	$¬ch_¬m_k´obe
(
k´obe
 *
p
)

218 
	`‹xt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

219 
	}
}

221 
__k´obes
 
	$¬ch_di§rm_k´obe
(
k´obe
 *
p
)

223 
	`‹xt_poke
(
p
->
addr
, &p->
İcode
, 1);

224 
	}
}

226 
__k´obes
 
	$¬ch_»move_k´obe
(
k´obe
 *
p
)

228 
	`mu‹x_lock
(&
k´obe_mu‹x
);

229 
	`ä“_š¢_¦Ù
(
p
->
aš¢
.
š¢
, 0);

230 
	`mu‹x_uÆock
(&
k´obe_mu‹x
);

231 
	}
}

233 
__k´obes
 
	$§ve_´evious_k´obe
(
k´obe_ùlblk
 *
kcb
)

235 
kcb
->
´ev_k´obe
.
kp
 = 
	`k´obe_ruÂšg
();

236 
kcb
->
´ev_k´obe
.
¡©us
 = kcb->
k´obe_¡©us
;

237 
kcb
->
´ev_k´obe
.
Şd_ræags
 = kcb->
k´obe_Şd_ræags
;

238 
kcb
->
´ev_k´obe
.
§ved_ræags
 = kcb->
k´obe_§ved_ræags
;

239 
	}
}

241 
__k´obes
 
	$»¡Üe_´evious_k´obe
(
k´obe_ùlblk
 *
kcb
)

243 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ
kcb
->
´ev_k´obe
.
kp
;

244 
kcb
->
k´obe_¡©us
 = kcb->
´ev_k´obe
.
¡©us
;

245 
kcb
->
k´obe_Şd_ræags
 = kcb->
´ev_k´obe
.
Şd_ræags
;

246 
kcb
->
k´obe_§ved_ræags
 = kcb->
´ev_k´obe
.
§ved_ræags
;

247 
	}
}

249 
__k´obes
 
	$£t_cu¼’t_k´obe
(
k´obe
 *
p
, 
±_»gs
 *
»gs
,

250 
k´obe_ùlblk
 *
kcb
)

252 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
èğ
p
;

253 
kcb
->
k´obe_§ved_ræags
 = kcb->
k´obe_Şd_ræags


254 ğ(
»gs
->
eæags
 & (
TF_MASK
 | 
IF_MASK
));

255 ià(
	`is_IF_modif›r
(
p
->
aš¢
.
š¢
))

256 
kcb
->
k´obe_§ved_ræags
 &ğ~
IF_MASK
;

257 
	}
}

259 
__k´obes
 
	$´•¬e_sšgË¡•
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

261 
»gs
->
eæags
 |ğ
TF_MASK
;

262 
»gs
->
eæags
 &ğ~
IF_MASK
;

264 ià(
p
->
İcode
 =ğ
BREAKPOINT_INSTRUCTION
)

265 
»gs
->
r
 = ()
p
->
addr
;

267 
»gs
->
r
 = ()
p
->
aš¢
.
š¢
;

268 
	}
}

271 
__k´obes
 
	$¬ch_´•¬e_k»robe
(
k»robe_š¡ªû
 *
ri
,

272 
±_»gs
 *
»gs
)

274 *
§¿
 = (*)
»gs
->
r¥
;

276 
ri
->
»t_addr
 = (
k´obe_İcode_t
 *è*
§¿
;

278 *
§¿
 = (è&
k»robe_ŒampŞše
;

279 
	}
}

281 
__k´obes
 
	$k´obe_hªdËr
(
±_»gs
 *
»gs
)

283 
k´obe
 *
p
;

284 
»t
 = 0;

285 
k´obe_İcode_t
 *
addr
 = (k´obe_İcode_ˆ*)(
»gs
->
r
 - (kprobe_opcode_t));

286 
k´obe_ùlblk
 *
kcb
;

292 
	`´“m±_di§bË
();

293 
kcb
 = 
	`g‘_k´obe_ùlblk
();

296 ià(
	`k´obe_ruÂšg
()) {

297 
p
 = 
	`g‘_k´obe
(
addr
);

298 ià(
p
) {

299 ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_HIT_SS
 &&

300 *
p
->
aš¢
.
š¢
 =ğ
BREAKPOINT_INSTRUCTION
) {

301 
»gs
->
eæags
 &ğ~
TF_MASK
;

302 
»gs
->
eæags
 |ğ
kcb
->
k´obe_§ved_ræags
;

303 
no_k´obe
;

304 } ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_HIT_SSDONE
) {

310 
	`¬ch_di§rm_k´obe
(
p
);

311 
»gs
->
r
 = ()
p
->
addr
;

312 
	`»£t_cu¼’t_k´obe
();

313 
»t
 = 1;

322 
	`§ve_´evious_k´obe
(
kcb
);

323 
	`£t_cu¼’t_k´obe
(
p
, 
»gs
, 
kcb
);

324 
	`k´obes_šc_nmis£d_couÁ
(
p
);

325 
	`´•¬e_sšgË¡•
(
p
, 
»gs
);

326 
kcb
->
k´obe_¡©us
 = 
KPROBE_REENTER
;

330 ià(*
addr
 !ğ
BREAKPOINT_INSTRUCTION
) {

335 
»gs
->
r
 = ()
addr
;

336 
»t
 = 1;

337 
no_k´obe
;

339 
p
 = 
	`__g‘_ıu_v¬
(
cu¼’t_k´obe
);

340 ià(
p
->
b»ak_hªdËr
 &&…->
	`b»ak_hªdËr
Õ, 
»gs
)) {

341 
ss_´obe
;

344 
no_k´obe
;

347 
p
 = 
	`g‘_k´obe
(
addr
);

348 ià(!
p
) {

349 ià(*
addr
 !ğ
BREAKPOINT_INSTRUCTION
) {

359 
»gs
->
r
 = ()
addr
;

360 
»t
 = 1;

363 
no_k´obe
;

366 
	`£t_cu¼’t_k´obe
(
p
, 
»gs
, 
kcb
);

367 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_ACTIVE
;

369 ià(
p
->
´e_hªdËr
 &&…->
	`´e_hªdËr
Õ, 
»gs
))

373 
ss_´obe
:

374 
	`´•¬e_sšgË¡•
(
p
, 
»gs
);

375 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_SS
;

378 
no_k´obe
:

379 
	`´“m±_’abË_no_»sched
();

380  
»t
;

381 
	}
}

388 
	$k»robe_ŒampŞše_hŞd”
()

390 
asm
 volatile ( ".global kretprobe_trampoline\n"

393 
	}
}

398 
__k´obes
 
	$ŒampŞše_´obe_hªdËr
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

400 
k»robe_š¡ªû
 *
ri
 = 
NULL
;

401 
hli¡_h—d
 *
h—d
, 
em±y_½
;

402 
hli¡_node
 *
node
, *
tmp
;

403 
æags
, 
Üig_»t_add»ss
 = 0;

404 
ŒampŞše_add»ss
 =()&
k»robe_ŒampŞše
;

406 
	`INIT_HLIST_HEAD
(&
em±y_½
);

407 
	`¥š_lock_œq§ve
(&
k»robe_lock
, 
æags
);

408 
h—d
 = 
	`k»robe_š¡_bË_h—d
(
cu¼’t
);

423 
	`hli¡_fÜ_—ch_’Œy_§ã
(
ri
, 
node
, 
tmp
, 
h—d
, 
hli¡
) {

424 ià(
ri
->
sk
 !ğ
cu¼’t
)

428 ià(
ri
->
½
 &&„i->½->
hªdËr
)

429 
ri
->
½
->
	`hªdËr
Ôi, 
»gs
);

431 
Üig_»t_add»ss
 = ()
ri
->
»t_addr
;

432 
	`»cyşe_½_š¡
(
ri
, &
em±y_½
);

434 ià(
Üig_»t_add»ss
 !ğ
ŒampŞše_add»ss
)

443 
	`k»robe_as£¹
(
ri
, 
Üig_»t_add»ss
, 
ŒampŞše_add»ss
);

444 
»gs
->
r
 = 
Üig_»t_add»ss
;

446 
	`»£t_cu¼’t_k´obe
();

447 
	`¥š_uÆock_œq»¡Üe
(&
k»robe_lock
, 
æags
);

448 
	`´“m±_’abË_no_»sched
();

450 
	`hli¡_fÜ_—ch_’Œy_§ã
(
ri
, 
node
, 
tmp
, &
em±y_½
, 
hli¡
) {

451 
	`hli¡_d–
(&
ri
->
hli¡
);

452 
	`kä“
(
ri
);

460 
	}
}

484 
__k´obes
 
	$»sume_executiÚ
(
k´obe
 *
p
,

485 
±_»gs
 *
»gs
, 
k´obe_ùlblk
 *
kcb
)

487 *
tos
 = (*)
»gs
->
r¥
;

488 
cİy_r
 = ()
p
->
aš¢
.
š¢
;

489 
Üig_r
 = ()
p
->
addr
;

490 
k´obe_İcode_t
 *
š¢
 = 
p
->
aš¢
.insn;

493 ià(*
š¢
 >= 0x40 && *insn <= 0x4f)

494 
š¢
++;

496 
»gs
->
eæags
 &ğ~
TF_MASK
;

497 *
š¢
) {

499 *
tos
 &ğ~(
TF_MASK
 | 
IF_MASK
);

500 *
tos
 |ğ
kcb
->
k´obe_Şd_ræags
;

509 
no_chªge
;

511 *
tos
 = 
Üig_r
 + (*to - 
cİy_r
);

514 ià((
š¢
[1] & 0x30) == 0x10) {

517 *
tos
 = 
Üig_r
 + (*to - 
cİy_r
);

518 
no_chªge
;

519 } ià(((
š¢
[1] & 0x31) == 0x20) ||

520 ((
š¢
[1] & 0x31) == 0x21)) {

522 
no_chªge
;

528 
»gs
->
r
 = 
Üig_r
 + (»gs->r - 
cİy_r
);

529 
no_chªge
:

532 
	}
}

534 
__k´obes
 
	$po¡_k´obe_hªdËr
(
±_»gs
 *
»gs
)

536 
k´obe
 *
cur
 = 
	`k´obe_ruÂšg
();

537 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

539 ià(!
cur
)

542 ià((
kcb
->
k´obe_¡©us
 !ğ
KPROBE_REENTER
è&& 
cur
->
po¡_hªdËr
) {

543 
kcb
->
k´obe_¡©us
 = 
KPROBE_HIT_SSDONE
;

544 
cur
->
	`po¡_hªdËr
(cur, 
»gs
, 0);

547 
	`»sume_executiÚ
(
cur
, 
»gs
, 
kcb
);

548 
»gs
->
eæags
 |ğ
kcb
->
k´obe_§ved_ræags
;

549 
	`Œaû_h¬dœqs_fixup_æags
(
»gs
->
eæags
);

552 ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_REENTER
) {

553 
	`»¡Üe_´evious_k´obe
(
kcb
);

554 
out
;

556 
	`»£t_cu¼’t_k´obe
();

557 
out
:

558 
	`´“m±_’abË_no_»sched
();

565 ià(
»gs
->
eæags
 & 
TF_MASK
)

569 
	}
}

571 
__k´obes
 
	$k´obe_çuÉ_hªdËr
(
±_»gs
 *
»gs
, 
Œ­Ä
)

573 
k´obe
 *
cur
 = 
	`k´obe_ruÂšg
();

574 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

575 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

577 
kcb
->
k´obe_¡©us
) {

578 
KPROBE_HIT_SS
:

579 
KPROBE_REENTER
:

587 
»gs
->
r
 = ()
cur
->
addr
;

588 
»gs
->
eæags
 |ğ
kcb
->
k´obe_Şd_ræags
;

589 ià(
kcb
->
k´obe_¡©us
 =ğ
KPROBE_REENTER
)

590 
	`»¡Üe_´evious_k´obe
(
kcb
);

592 
	`»£t_cu¼’t_k´obe
();

593 
	`´“m±_’abË_no_»sched
();

595 
KPROBE_HIT_ACTIVE
:

596 
KPROBE_HIT_SSDONE
:

602 
	`k´obes_šc_nmis£d_couÁ
(
cur
);

611 ià(
cur
->
çuÉ_hªdËr
 && cur->
	`çuÉ_hªdËr
(cur, 
»gs
, 
Œ­Ä
))

618 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
);

619 ià(
fixup
) {

620 
»gs
->
r
 = 
fixup
->fixup;

633 
	}
}

638 
__k´obes
 
	$k´obe_exû±iÚs_nÙify
(
nÙif›r_block
 *
£lf
,

639 
v®
, *
d©a
)

641 
d›_¬gs
 *
¬gs
 = (d›_¬g *)
d©a
;

642 
»t
 = 
NOTIFY_DONE
;

644 ià(
¬gs
->
»gs
 && 
	`u£r_mode
(args->regs))

645  
»t
;

647 
v®
) {

648 
DIE_INT3
:

649 ià(
	`k´obe_hªdËr
(
¬gs
->
»gs
))

650 
»t
 = 
NOTIFY_STOP
;

652 
DIE_DEBUG
:

653 ià(
	`po¡_k´obe_hªdËr
(
¬gs
->
»gs
))

654 
»t
 = 
NOTIFY_STOP
;

656 
DIE_GPF
:

658 
	`´“m±_di§bË
();

659 ià(
	`k´obe_ruÂšg
() &&

660 
	`k´obe_çuÉ_hªdËr
(
¬gs
->
»gs
,‡rgs->
Œ­Ä
))

661 
»t
 = 
NOTIFY_STOP
;

662 
	`´“m±_’abË
();

667  
»t
;

668 
	}
}

670 
__k´obes
 
	$£tjmp_´e_hªdËr
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

672 
j´obe
 *
jp
 = 
	`cÚš”_of
(
p
, j´obe, 
kp
);

673 
addr
;

674 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

676 
kcb
->
j´obe_§ved_»gs
 = *
»gs
;

677 
kcb
->
j´obe_§ved_r¥
 = (*è
»gs
->
r¥
;

678 
addr
 = ()(
kcb
->
j´obe_§ved_r¥
);

686 
	`memıy
(
kcb
->
j´obes_¡ack
, (
k´obe_İcode_t
 *)
addr
,

687 
	`MIN_STACK_SIZE
(
addr
));

688 
»gs
->
eæags
 &ğ~
IF_MASK
;

689 
	`Œaû_h¬dœqs_off
();

690 
»gs
->
r
 = ()(
jp
->
’Œy
);

692 
	}
}

694 
__k´obes
 
	$j´obe_»tuº
()

696 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

698 
asm
 volatile (" xchg %%rbx,%%rsp \n"

703 (
kcb
->
j´obe_§ved_r¥
):"memory");

704 
	}
}

706 
__k´obes
 
	$lÚgjmp_b»ak_hªdËr
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

708 
k´obe_ùlblk
 *
kcb
 = 
	`g‘_k´obe_ùlblk
();

709 
u8
 *
addr
 = (u8 *è(
»gs
->
r
 - 1);

710 
¡ack_addr
 = ()(
kcb
->
j´obe_§ved_r¥
);

711 
j´obe
 *
jp
 = 
	`cÚš”_of
(
p
, j´obe, 
kp
);

713 ià((
addr
 > (
u8
 *è
j´obe_»tuº
è&& (add¸< (u8 *è
j´obe_»tuº_’d
)) {

714 ià((*)
»gs
->
r¥
 !ğ
kcb
->
j´obe_§ved_r¥
) {

715 
±_»gs
 *
§ved_»gs
 = &
kcb
->
j´obe_§ved_»gs
;

716 
	`´štk
("current„sp %p does‚ot match saved„sp %p\n",

717 (*)
»gs
->
r¥
, 
kcb
->
j´obe_§ved_r¥
);

718 
	`´štk
("Saved„egi¡” fÜ j´ob%p\n", 
jp
);

719 
	`show_»gi¡”s
(
§ved_»gs
);

720 
	`´štk
("Current„egisters\n");

721 
	`show_»gi¡”s
(
»gs
);

722 
	`BUG
();

724 *
»gs
 = 
kcb
->
j´obe_§ved_»gs
;

725 
	`memıy
((
k´obe_İcode_t
 *è
¡ack_addr
, 
kcb
->
j´obes_¡ack
,

726 
	`MIN_STACK_SIZE
(
¡ack_addr
));

727 
	`´“m±_’abË_no_»sched
();

731 
	}
}

733 
k´obe
 
	gŒampŞše_p
 = {

734 .
addr
 = (
k´obe_İcode_t
 *è&
k»robe_ŒampŞše
,

735 .
	g´e_hªdËr
 = 
ŒampŞše_´obe_hªdËr


738 
__š™
 
	$¬ch_š™_k´obes
()

740  
	`»gi¡”_k´obe
(&
ŒampŞše_p
);

741 
	}
}

743 
__k´obes
 
	$¬ch_ŒampŞše_k´obe
(
k´obe
 *
p
)

745 ià(
p
->
addr
 =ğ(
k´obe_İcode_t
 *)&
k»robe_ŒampŞše
)

749 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt_64.c

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/mm.h
>

13 
	~<lšux/smp.h
>

14 
	~<lšux/vm®loc.h
>

15 
	~<lšux/¦ab.h
>

17 
	~<asm/uacûss.h
>

18 
	~<asm/sy¡em.h
>

19 
	~<asm/ldt.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/´Ùo.h
>

23 #ifdeà
CONFIG_SMP


24 
	$æush_ldt
(*
nuÎ
)

26 ià(
cu¼’t
->
aùive_mm
)

27 
	`lßd_LDT
(&
cu¼’t
->
aùive_mm
->
cÚ‹xt
);

28 
	}
}

31 
	$®loc_ldt
(
mm_cÚ‹xt_t
 *
pc
, 
mšcouÁ
, 
»lßd
)

33 *
Şdldt
;

34 *
Ãwldt
;

35 
Şdsize
;

37 ià(
mšcouÁ
 <ğ()
pc
->
size
)

39 
Şdsize
 = 
pc
->
size
;

40 
mšcouÁ
 = (mincount+511)&(~511);

41 ià(
mšcouÁ
*
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

42 
Ãwldt
 = 
	`vm®loc
(
mšcouÁ
*
LDT_ENTRY_SIZE
);

44 
Ãwldt
 = 
	`km®loc
(
mšcouÁ
*
LDT_ENTRY_SIZE
, 
GFP_KERNEL
);

46 ià(!
Ãwldt
)

47  -
ENOMEM
;

49 ià(
Şdsize
)

50 
	`memıy
(
Ãwldt
, 
pc
->
ldt
, 
Şdsize
*
LDT_ENTRY_SIZE
);

51 
Şdldt
 = 
pc
->
ldt
;

52 
	`mem£t
(
Ãwldt
+
Şdsize
*
LDT_ENTRY_SIZE
, 0, (
mšcouÁ
-oldsize)*LDT_ENTRY_SIZE);

53 
	`wmb
();

54 
pc
->
ldt
 = 
Ãwldt
;

55 
	`wmb
();

56 
pc
->
size
 = 
mšcouÁ
;

57 
	`wmb
();

58 ià(
»lßd
) {

59 #ifdeà
CONFIG_SMP


60 
ıumask_t
 
mask
;

62 
	`´“m±_di§bË
();

63 
mask
 = 
	`ıumask_of_ıu
(
	`smp_´oûssÜ_id
());

64 
	`lßd_LDT
(
pc
);

65 ià(!
	`ıus_equ®
(
cu¼’t
->
mm
->
ıu_vm_mask
, 
mask
))

66 
	`smp_ÿÎ_funùiÚ
(
æush_ldt
, 
NULL
, 1, 1);

67 
	`´“m±_’abË
();

69 
	`lßd_LDT
(
pc
);

72 ià(
Şdsize
) {

73 ià(
Şdsize
*
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

74 
	`vä“
(
Şdldt
);

76 
	`kä“
(
Şdldt
);

79 
	}
}

81 
šlše
 
	$cİy_ldt
(
mm_cÚ‹xt_t
 *
Ãw
, mm_cÚ‹xt_ˆ*
Şd
)

83 
”r
 = 
	`®loc_ldt
(
Ãw
, 
Şd
->
size
, 0);

84 ià(
”r
 < 0)

85  
”r
;

86 
	`memıy
(
Ãw
->
ldt
, 
Şd
->ldt, old->
size
*
LDT_ENTRY_SIZE
);

88 
	}
}

94 
	$š™_Ãw_cÚ‹xt
(
sk_¡ruù
 *
tsk
, 
mm_¡ruù
 *
mm
)

96 
mm_¡ruù
 * 
Şd_mm
;

97 
»tv®
 = 0;

99 
	`mu‹x_š™
(&
mm
->
cÚ‹xt
.
lock
);

100 
mm
->
cÚ‹xt
.
size
 = 0;

101 
Şd_mm
 = 
cu¼’t
->
mm
;

102 ià(
Şd_mm
 && old_mm->
cÚ‹xt
.
size
 > 0) {

103 
	`mu‹x_lock
(&
Şd_mm
->
cÚ‹xt
.
lock
);

104 
»tv®
 = 
	`cİy_ldt
(&
mm
->
cÚ‹xt
, &
Şd_mm
->context);

105 
	`mu‹x_uÆock
(&
Şd_mm
->
cÚ‹xt
.
lock
);

107  
»tv®
;

108 
	}
}

114 
	$de¡roy_cÚ‹xt
(
mm_¡ruù
 *
mm
)

116 ià(
mm
->
cÚ‹xt
.
size
) {

117 ià(()
mm
->
cÚ‹xt
.
size
*
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

118 
	`vä“
(
mm
->
cÚ‹xt
.
ldt
);

120 
	`kä“
(
mm
->
cÚ‹xt
.
ldt
);

121 
mm
->
cÚ‹xt
.
size
 = 0;

123 
	}
}

125 
	$»ad_ldt
(
__u£r
 * 
±r
, 
by‹couÁ
)

127 
”r
;

128 
size
;

129 
mm_¡ruù
 * 
mm
 = 
cu¼’t
->mm;

131 ià(!
mm
->
cÚ‹xt
.
size
)

133 ià(
by‹couÁ
 > 
LDT_ENTRY_SIZE
*
LDT_ENTRIES
)

134 
by‹couÁ
 = 
LDT_ENTRY_SIZE
*
LDT_ENTRIES
;

136 
	`mu‹x_lock
(&
mm
->
cÚ‹xt
.
lock
);

137 
size
 = 
mm
->
cÚ‹xt
.size*
LDT_ENTRY_SIZE
;

138 ià(
size
 > 
by‹couÁ
)

139 
size
 = 
by‹couÁ
;

141 
”r
 = 0;

142 ià(
	`cİy_to_u£r
(
±r
, 
mm
->
cÚ‹xt
.
ldt
, 
size
))

143 
”r
 = -
EFAULT
;

144 
	`mu‹x_uÆock
(&
mm
->
cÚ‹xt
.
lock
);

145 ià(
”r
 < 0)

146 
”rÜ_»tuº
;

147 ià(
size
 !ğ
by‹couÁ
) {

149 ià(
	`ş—r_u£r
(
±r
+
size
, 
by‹couÁ
-size) != 0) {

150 
”r
 = -
EFAULT
;

151 
”rÜ_»tuº
;

154  
by‹couÁ
;

155 
”rÜ_»tuº
:

156  
”r
;

157 
	}
}

159 
	$»ad_deçuÉ_ldt
(
__u£r
 * 
±r
, 
by‹couÁ
)

163 ià(
by‹couÁ
 > 128)

164 
by‹couÁ
 = 128;

165 ià(
	`ş—r_u£r
(
±r
, 
by‹couÁ
))

166  -
EFAULT
;

167  
by‹couÁ
;

168 
	}
}

170 
	$wr™e_ldt
(
__u£r
 * 
±r
, 
by‹couÁ
, 
Şdmode
)

172 
sk_¡ruù
 *
me
 = 
cu¼’t
;

173 
mm_¡ruù
 * 
mm
 = 
me
->mm;

174 
__u32
 
’Œy_1
, 
’Œy_2
, *
Í
;

175 
”rÜ
;

176 
u£r_desc
 
ldt_šfo
;

178 
”rÜ
 = -
EINVAL
;

180 ià(
by‹couÁ
 !ğ(
ldt_šfo
))

181 
out
;

182 
”rÜ
 = -
EFAULT
;

183 ià(
	`cİy_äom_u£r
(&
ldt_šfo
, 
±r
, 
by‹couÁ
))

184 
out
;

186 
”rÜ
 = -
EINVAL
;

187 ià(
ldt_šfo
.
’Œy_numb”
 >ğ
LDT_ENTRIES
)

188 
out
;

189 ià(
ldt_šfo
.
cÚ‹Ás
 == 3) {

190 ià(
Şdmode
)

191 
out
;

192 ià(
ldt_šfo
.
£g_nÙ_´e£Á
 == 0)

193 
out
;

196 
	`mu‹x_lock
(&
mm
->
cÚ‹xt
.
lock
);

197 ià(
ldt_šfo
.
’Œy_numb”
 >ğ()
mm
->
cÚ‹xt
.
size
) {

198 
”rÜ
 = 
	`®loc_ldt
(&
cu¼’t
->
mm
->
cÚ‹xt
, 
ldt_šfo
.
’Œy_numb”
+1, 1);

199 ià(
”rÜ
 < 0)

200 
out_uÆock
;

203 
Í
 = (
__u32
 *è((
ldt_šfo
.
’Œy_numb”
 << 3è+ (*è
mm
->
cÚ‹xt
.
ldt
);

206 ià(
ldt_šfo
.
ba£_addr
 =ğ0 &&†dt_šfo.
lim™
 == 0) {

207 ià(
Şdmode
 || 
	`LDT_em±y
(&
ldt_šfo
)) {

208 
’Œy_1
 = 0;

209 
’Œy_2
 = 0;

210 
š¡®l
;

214 
’Œy_1
 = 
	`LDT_’Œy_a
(&
ldt_šfo
);

215 
’Œy_2
 = 
	`LDT_’Œy_b
(&
ldt_šfo
);

216 ià(
Şdmode
)

217 
’Œy_2
 &= ~(1 << 20);

220 
š¡®l
:

221 *
Í
 = 
’Œy_1
;

222 *(
Í
+1èğ
’Œy_2
;

223 
”rÜ
 = 0;

225 
out_uÆock
:

226 
	`mu‹x_uÆock
(&
mm
->
cÚ‹xt
.
lock
);

227 
out
:

228  
”rÜ
;

229 
	}
}

231 
asmlškage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
, 
by‹couÁ
)

233 
»t
 = -
ENOSYS
;

235 
func
) {

237 
»t
 = 
	`»ad_ldt
(
±r
, 
by‹couÁ
);

240 
»t
 = 
	`wr™e_ldt
(
±r
, 
by‹couÁ
, 1);

243 
»t
 = 
	`»ad_deçuÉ_ldt
(
±r
, 
by‹couÁ
);

246 
»t
 = 
	`wr™e_ldt
(
±r
, 
by‹couÁ
, 0);

249  
»t
;

250 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module_64.c

19 
	~<lšux/moduËlßd”.h
>

20 
	~<lšux/–f.h
>

21 
	~<lšux/vm®loc.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/¡ršg.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/bug.h
>

28 
	~<asm/sy¡em.h
>

29 
	~<asm/·ge.h
>

30 
	~<asm/pgbË.h
>

32 
	#DEBUGP
(
fmt
...)

	)

34 #iâdeà
CONFIG_UML


35 
	$moduË_ä“
(
moduË
 *
mod
, *
moduË_»giÚ
)

37 
	`vä“
(
moduË_»giÚ
);

40 
	}
}

42 *
	$moduË_®loc
(
size
)

44 
vm_¡ruù
 *
¬—
;

46 ià(!
size
)

47  
NULL
;

48 
size
 = 
	`PAGE_ALIGN
(size);

49 ià(
size
 > 
MODULES_LEN
)

50  
NULL
;

52 
¬—
 = 
	`__g‘_vm_¬—
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

53 ià(!
¬—
)

54  
NULL
;

56  
	`__vm®loc_¬—
(
¬—
, 
GFP_KERNEL
, 
PAGE_KERNEL_EXEC
);

57 
	}
}

61 
	$moduË_äob_¬ch_£ùiÚs
(
Elf_Ehdr
 *
hdr
,

62 
Elf_Shdr
 *
£chdrs
,

63 *
£c¡ršgs
,

64 
moduË
 *
mod
)

67 
	}
}

69 
	$­¶y_»loÿ‹_add
(
Elf64_Shdr
 *
£chdrs
,

70 cÚ¡ *
¡¹ab
,

71 
symšdex
,

72 
»l£c
,

73 
moduË
 *
me
)

75 
i
;

76 
Elf64_R–a
 *
»l
 = (*)
£chdrs
[
»l£c
].
sh_addr
;

77 
Elf64_Sym
 *
sym
;

78 *
loc
;

79 
u64
 
v®
;

81 
	`DEBUGP
("Aµlyšg„–oÿ‹ seùiÚ %uØ%u\n", 
»l£c
,

82 
£chdrs
[
»l£c
].
sh_šfo
);

83 
i
 = 0; i < 
£chdrs
[
»l£c
].
sh_size
 / (*
»l
); i++) {

85 
loc
 = (*)
£chdrs
[£chdrs[
»l£c
].
sh_šfo
].
sh_addr


86 + 
»l
[
i
].
r_off£t
;

90 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symšdex
].
sh_addr


91 + 
	`ELF64_R_SYM
(
»l
[
i
].
r_šfo
);

93 
	`DEBUGP
("type %d st_value %Lx„_addend %Lx†oc %Lx\n",

94 ()
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
),

95 
sym
->
¡_v®ue
, 
»l
[
i
].
r_add’d
, (
u64
)
loc
);

97 
v®
 = 
sym
->
¡_v®ue
 + 
»l
[
i
].
r_add’d
;

99 
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
)) {

100 
R_X86_64_NONE
:

102 
R_X86_64_64
:

103 *(
u64
 *)
loc
 = 
v®
;

105 
R_X86_64_32
:

106 *(
u32
 *)
loc
 = 
v®
;

107 ià(
v®
 !ğ*(
u32
 *)
loc
)

108 
ov”æow
;

110 
R_X86_64_32S
:

111 *(
s32
 *)
loc
 = 
v®
;

112 ià((
s64
)
v®
 !ğ*(
s32
 *)
loc
)

113 
ov”æow
;

115 
R_X86_64_PC32
:

116 
v®
 -ğ(
u64
)
loc
;

117 *(
u32
 *)
loc
 = 
v®
;

119 ià((
s64
)
v®
 !ğ*(
s32
 *)
loc
)

120 
ov”æow
;

124 
	`´štk
(
KERN_ERR
 "module %s: Unknown„ela„elocation: %Lu\n",

125 
me
->
Çme
, 
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
));

126  -
ENOEXEC
;

131 
ov”æow
:

132 
	`´štk
(
KERN_ERR
 "overflow in„elocationype %d val %Lx\n",

133 ()
	`ELF64_R_TYPE
(
»l
[
i
].
r_šfo
), 
v®
);

134 
	`´štk
(
KERN_ERR
 "`%s'†ikely‚ot compiled with -mcmodel=kernel\n",

135 
me
->
Çme
);

136  -
ENOEXEC
;

137 
	}
}

139 
	$­¶y_»loÿ‹
(
Elf_Shdr
 *
£chdrs
,

140 cÚ¡ *
¡¹ab
,

141 
symšdex
,

142 
»l£c
,

143 
moduË
 *
me
)

145 
	`´štk
("non‡dd„elocation‚ot supported\n");

146  -
ENOSYS
;

147 
	}
}

149 
	$moduË_fš®ize
(cÚ¡ 
Elf_Ehdr
 *
hdr
,

150 cÚ¡ 
Elf_Shdr
 *
£chdrs
,

151 
moduË
 *
me
)

153 cÚ¡ 
Elf_Shdr
 *
s
, *
‹xt
 = 
NULL
, *
®t
 = NULL, *
locks
 = NULL;

154 *
£c¡ršgs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh¡ºdx
].
sh_off£t
;

156 
s
 = 
£chdrs
; s < sechdr + 
hdr
->
e_shnum
; s++) {

157 ià(!
	`¡rcmp
(".‹xt", 
£c¡ršgs
 + 
s
->
sh_Çme
))

158 
‹xt
 = 
s
;

159 ià(!
	`¡rcmp
(".®tš¡ruùiÚs", 
£c¡ršgs
 + 
s
->
sh_Çme
))

160 
®t
 = 
s
;

161 ià(!
	`¡rcmp
(".smp_locks", 
£c¡ršgs
 + 
s
->
sh_Çme
))

162 
locks
ğ
s
;

165 ià(
®t
) {

167 *
a£g
 = (*)
®t
->
sh_addr
;

168 
	`­¶y_®‹º©ives
(
a£g
,‡£g + 
®t
->
sh_size
);

170 ià(
locks
 && 
‹xt
) {

171 *
l£g
 = (*)
locks
->
sh_addr
;

172 *
t£g
 = (*)
‹xt
->
sh_addr
;

173 
	`®‹º©ives_smp_moduË_add
(
me
, me->
Çme
,

174 
l£g
,†£g + 
locks
->
sh_size
,

175 
t£g
,£g + 
‹xt
->
sh_size
);

178  
	`moduË_bug_fš®ize
(
hdr
, 
£chdrs
, 
me
);

179 
	}
}

181 
	$moduË_¬ch_ş—nup
(
moduË
 *
mod
)

183 
	`®‹º©ives_smp_moduË_d–
(
mod
);

184 
	`moduË_bug_ş—nup
(
mod
);

185 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse_64.c

16 
	~<lšux/mm.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/d–ay.h
>

19 
	~<lšux/boÙmem.h
>

20 
	~<lšux/k”Ãl_¡©.h
>

21 
	~<lšux/mc146818¹c.h
>

22 
	~<lšux/aıi.h
>

23 
	~<lšux/moduË.h
>

25 
	~<asm/smp.h
>

26 
	~<asm/mŒr.h
>

27 
	~<asm/mp¥ec.h
>

28 
	~<asm/pg®loc.h
>

29 
	~<asm/io_­ic.h
>

30 
	~<asm/´Ùo.h
>

31 
	~<asm/aıi.h
>

34 
	gsmp_found_cÚfig
;

40 
DECLARE_BITMAP
(
mp_bus_nÙ_pci
, 
MAX_MP_BUSSES
);

41 
	gmp_bus_id_to_pci_bus
 [
MAX_MP_BUSSES
] = { [0 ... MAX_MP_BUSSES-1] = -1 };

43 
	gmp_cu¼’t_pci_id
 = 0;

45 
mpc_cÚfig_ißpic
 
	gmp_ißpics
[
MAX_IO_APICS
];

48 
mpc_cÚfig_št¤c
 
	gmp_œqs
[
MAX_IRQ_SOURCES
];

51 
	gmp_œq_’Œ›s
;

53 
	gÄ_ißpics
;

54 
	gmp_Ïpic_addr
 = 0;

59 
	gboÙ_ıu_id
 = -1U;

60 
EXPORT_SYMBOL
(
boÙ_ıu_id
);

63 
num_´oûssÜs
 
	g__ıuš™d©a
 = 0;

65 
di§bËd_ıus
 
	g__ıuš™d©a
;

68 
physid_mask_t
 
	gphys_ıu_´e£Á_m­
 = 
PHYSID_MASK_NONE
;

70 
u8
 
	gbios_ıu_­icid
[
NR_CPUS
] = { [0 ... NR_CPUS-1] = 
BAD_APICID
 };

81 
__š™
 
	$mpf_checksum
(*
mp
, 
Ën
)

83 
sum
 = 0;

85 
Ën
--)

86 
sum
 +ğ*
mp
++;

88  
sum
 & 0xFF;

89 
	}
}

91 
__ıuš™
 
	$MP_´oûssÜ_šfo
(
mpc_cÚfig_´oûssÜ
 *
m
)

93 
ıu
;

94 
ıumask_t
 
tmp_m­
;

95 *
boÙup_ıu
 = "";

97 ià(!(
m
->
mpc_ıuæag
 & 
CPU_ENABLED
)) {

98 
di§bËd_ıus
++;

101 ià(
m
->
mpc_ıuæag
 & 
CPU_BOOTPROCESSOR
) {

102 
boÙup_ıu
 = " (Bootup-CPU)";

103 
boÙ_ıu_id
 = 
m
->
mpc_­icid
;

106 
	`´štk
(
KERN_INFO
 "ProûssÜ #%d%s\n", 
m
->
mpc_­icid
, 
boÙup_ıu
);

108 ià(
num_´oûssÜs
 >ğ
NR_CPUS
) {

109 
	`´štk
(
KERN_WARNING
 "WARNING: NR_CPUS†imit of %i„eached."

110 " ProûssÜ ignÜed.\n", 
NR_CPUS
);

114 
num_´oûssÜs
++;

115 
	`ıus_com¶em’t
(
tmp_m­
, 
ıu_´e£Á_m­
);

116 
ıu
 = 
	`fœ¡_ıu
(
tmp_m­
);

118 
	`physid_£t
(
m
->
mpc_­icid
, 
phys_ıu_´e£Á_m­
);

119 ià(
m
->
mpc_ıuæag
 & 
CPU_BOOTPROCESSOR
) {

125 
ıu
 = 0;

127 
bios_ıu_­icid
[
ıu
] = 
m
->
mpc_­icid
;

134 ià(
x86_ıu_to_­icid_±r
) {

135 
u8
 *
x86_ıu_to_­icid
 = (u8 *)
x86_ıu_to_­icid_±r
;

136 
x86_ıu_to_­icid
[
ıu
] = 
m
->
mpc_­icid
;

138 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
èğ
m
->
mpc_­icid
;

141 
	`ıu_£t
(
ıu
, 
ıu_possibË_m­
);

142 
	`ıu_£t
(
ıu
, 
ıu_´e£Á_m­
);

143 
	}
}

145 
__š™
 
	$MP_bus_šfo
 (
mpc_cÚfig_bus
 *
m
)

147 
¡r
[7];

149 
	`memıy
(
¡r
, 
m
->
mpc_bu¡y³
, 6);

150 
¡r
[6] = 0;

151 
	`D´štk
("Bu #%d i %s\n", 
m
->
mpc_busid
, 
¡r
);

153 ià(
	`¡ºcmp
(
¡r
, "ISA", 3) == 0) {

154 
	`£t_b™
(
m
->
mpc_busid
, 
mp_bus_nÙ_pci
);

155 } ià(
	`¡ºcmp
(
¡r
, "PCI", 3) == 0) {

156 
	`ş—r_b™
(
m
->
mpc_busid
, 
mp_bus_nÙ_pci
);

157 
mp_bus_id_to_pci_bus
[
m
->
mpc_busid
] = 
mp_cu¼’t_pci_id
;

158 
mp_cu¼’t_pci_id
++;

160 
	`´štk
(
KERN_ERR
 "UnknowÀbu¡y³ %s\n", 
¡r
);

162 
	}
}

164 
	$bad_ißpic
(
add»ss
)

166 ià(
Ä_ißpics
 >ğ
MAX_IO_APICS
) {

167 
	`´štk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)ƒxceeded "

168 "(found %d)\n", 
MAX_IO_APICS
, 
Ä_ißpics
);

169 
	`·nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

171 ià(!
add»ss
) {

172 
	`´štk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APIC‡ddress"

177 
	}
}

179 
__š™
 
	$MP_ißpic_šfo
 (
mpc_cÚfig_ißpic
 *
m
)

181 ià(!(
m
->
mpc_æags
 & 
MPC_APIC_USABLE
))

184 
	`´štk
("I/O APIC #%d‡t 0x%X.\n",

185 
m
->
mpc_­icid
, m->
mpc_­iÿddr
);

187 ià(
	`bad_ißpic
(
m
->
mpc_­iÿddr
))

190 
mp_ißpics
[
Ä_ißpics
] = *
m
;

191 
Ä_ißpics
++;

192 
	}
}

194 
__š™
 
	$MP_št¤c_šfo
 (
mpc_cÚfig_št¤c
 *
m
)

196 
mp_œqs
 [
mp_œq_’Œ›s
] = *
m
;

197 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d,"

199 
m
->
mpc_œqty³
, m->
mpc_œqæag
 & 3,

200 (
m
->
mpc_œqæag
 >> 2è& 3, m->
mpc_¤cbus
,

201 
m
->
mpc_¤cbusœq
, m->
mpc_d¡­ic
, m->
mpc_d¡œq
);

202 ià(++
mp_œq_’Œ›s
 >ğ
MAX_IRQ_SOURCES
)

203 
	`·nic
("Max # of irq sourcesƒxceeded!!\n");

204 
	}
}

206 
__š™
 
	$MP_lšt¤c_šfo
 (
mpc_cÚfig_lšt¤c
 *
m
)

208 
	`D´štk
("Lint:ype %d,…ol %d,rig %d, bus %d,"

210 
m
->
mpc_œqty³
, m->
mpc_œqæag
 & 3,

211 (
m
->
mpc_œqæag
 >> 2è&3, m->
mpc_¤cbusid
,

212 
m
->
mpc_¤cbusœq
, m->
mpc_de¡­ic
, m->
mpc_de¡­işšt
);

213 
	}
}

219 
__š™
 
	$smp_»ad_mpc
(
mp_cÚfig_bË
 *
mpc
)

221 
¡r
[16];

222 
couÁ
=(*
mpc
);

223 *
m±
=((*)
mpc
)+
couÁ
;

225 ià(
	`memcmp
(
mpc
->
mpc_sigÇtu»
,
MPC_SIGNATURE
,4)) {

226 
	`´štk
("MPTABLE: bad signature [%c%c%c%c]!\n",

227 
mpc
->
mpc_sigÇtu»
[0],

228 
mpc
->
mpc_sigÇtu»
[1],

229 
mpc
->
mpc_sigÇtu»
[2],

230 
mpc
->
mpc_sigÇtu»
[3]);

233 ià(
	`mpf_checksum
((*)
mpc
,mpc->
mpc_Ëngth
)) {

234 
	`´štk
("MPTABLE: checksumƒrror!\n");

237 ià(
mpc
->
mpc_¥ec
!=0x01 && mpc->mpc_spec!=0x04) {

238 
	`´štk
(
KERN_ERR
 "MPTABLE: badable version (%d)!!\n",

239 
mpc
->
mpc_¥ec
);

242 ià(!
mpc
->
mpc_Ïpic
) {

243 
	`´štk
(
KERN_ERR
 "MPTABLE:‚ull†ocal APIC‡ddress!\n");

246 
	`memıy
(
¡r
,
mpc
->
mpc_Ûm
,8);

247 
¡r
[8] = 0;

248 
	`´štk
(
KERN_INFO
 "MPTABLE: OEM ID: % ",
¡r
);

250 
	`memıy
(
¡r
,
mpc
->
mpc_´oduùid
,12);

251 
¡r
[12] = 0;

252 
	`´štk
("MPTABLE: Produù ID: % ",
¡r
);

254 
	`´štk
("MPTABLE: APIC‡t: 0x%X\n",
mpc
->
mpc_Ïpic
);

257 ià(!
aıi_Ïpic
)

258 
mp_Ïpic_addr
 = 
mpc
->
mpc_Ïpic
;

263 
couÁ
 < 
mpc
->
mpc_Ëngth
) {

264 *
m±
) {

265 
MP_PROCESSOR
:

267 
mpc_cÚfig_´oûssÜ
 *
m
=

268 (
mpc_cÚfig_´oûssÜ
 *)
m±
;

269 ià(!
aıi_Ïpic
)

270 
	`MP_´oûssÜ_šfo
(
m
);

271 
m±
 +ğ(*
m
);

272 
couÁ
 +ğ(*
m
);

275 
MP_BUS
:

277 
mpc_cÚfig_bus
 *
m
=

278 (
mpc_cÚfig_bus
 *)
m±
;

279 
	`MP_bus_šfo
(
m
);

280 
m±
 +ğ(*
m
);

281 
couÁ
 +ğ(*
m
);

284 
MP_IOAPIC
:

286 
mpc_cÚfig_ißpic
 *
m
=

287 (
mpc_cÚfig_ißpic
 *)
m±
;

288 
	`MP_ißpic_šfo
(
m
);

289 
m±
 +ğ(*
m
);

290 
couÁ
 +ğ(*
m
);

293 
MP_INTSRC
:

295 
mpc_cÚfig_št¤c
 *
m
=

296 (
mpc_cÚfig_št¤c
 *)
m±
;

298 
	`MP_št¤c_šfo
(
m
);

299 
m±
 +ğ(*
m
);

300 
couÁ
 +ğ(*
m
);

303 
MP_LINTSRC
:

305 
mpc_cÚfig_lšt¤c
 *
m
=

306 (
mpc_cÚfig_lšt¤c
 *)
m±
;

307 
	`MP_lšt¤c_šfo
(
m
);

308 
m±
 +ğ(*
m
);

309 
couÁ
 +ğ(*
m
);

314 
	`£tup_­ic_routšg
();

315 ià(!
num_´oûssÜs
)

316 
	`´štk
(
KERN_ERR
 "MPTABLE:‚o…rocessors„egistered!\n");

317  
num_´oûssÜs
;

318 
	}
}

320 
__š™
 
	$ELCR_Œigg”
(
œq
)

322 
pÜt
;

324 
pÜt
 = 0x4d0 + (
œq
 >> 3);

325  (
	`šb
(
pÜt
è>> (
œq
 & 7)) & 1;

326 
	}
}

328 
__š™
 
	$cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
)

330 
mpc_cÚfig_št¤c
 
št¤c
;

331 
i
;

332 
ELCR_çÎback
 = 0;

334 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

335 
št¤c
.
mpc_œqæag
 = 0;

336 
št¤c
.
mpc_¤cbus
 = 0;

337 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[0].
mpc_­icid
;

339 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

349 ià(
mpc_deçuÉ_ty³
 == 5) {

350 
	`´štk
(
KERN_INFO
 "ISA/PCI busype with‚o IRQ information... falling backo ELCR\n");

352 ià(
	`ELCR_Œigg”
(0) || ELCR_trigger(1) || ELCR_trigger(2) || ELCR_trigger(13))

353 
	`´štk
(
KERN_ERR
 "ELCR contains invalid data...‚ot using ELCR\n");

355 
	`´štk
(
KERN_INFO
 "Using ELCRo identify PCI interrupts\n");

356 
ELCR_çÎback
 = 1;

360 
i
 = 0; i < 16; i++) {

361 
mpc_deçuÉ_ty³
) {

363 ià(
i
 == 0 || i == 13)

367 ià(
i
 == 2)

371 ià(
ELCR_çÎback
) {

377 ià(
	`ELCR_Œigg”
(
i
))

378 
št¤c
.
mpc_œqæag
 = 13;

380 
št¤c
.
mpc_œqæag
 = 0;

383 
št¤c
.
mpc_¤cbusœq
 = 
i
;

384 
št¤c
.
mpc_d¡œq
 = 
i
 ? i : 2;

385 
	`MP_št¤c_šfo
(&
št¤c
);

388 
št¤c
.
mpc_œqty³
 = 
mp_ExtINT
;

389 
št¤c
.
mpc_¤cbusœq
 = 0;

390 
št¤c
.
mpc_d¡œq
 = 0;

391 
	`MP_št¤c_šfo
(&
št¤c
);

392 
	}
}

394 
šlše
 
__š™
 
	$cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpc_deçuÉ_ty³
)

396 
mpc_cÚfig_´oûssÜ
 
´oûssÜ
;

397 
mpc_cÚfig_bus
 
bus
;

398 
mpc_cÚfig_ißpic
 
ißpic
;

399 
mpc_cÚfig_lšt¤c
 
lšt¤c
;

400 
lš‰y³s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

401 
i
;

406 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

411 
´oûssÜ
.
mpc_ty³
 = 
MP_PROCESSOR
;

412 
´oûssÜ
.
mpc_­icv”
 = 0;

413 
´oûssÜ
.
mpc_ıuæag
 = 
CPU_ENABLED
;

414 
´oûssÜ
.
mpc_ıuã©u»
 = 0;

415 
´oûssÜ
.
mpc_ã©u»æag
 = 0;

416 
´oûssÜ
.
mpc_»£rved
[0] = 0;

417 
´oûssÜ
.
mpc_»£rved
[1] = 0;

418 
i
 = 0; i < 2; i++) {

419 
´oûssÜ
.
mpc_­icid
 = 
i
;

420 
	`MP_´oûssÜ_šfo
(&
´oûssÜ
);

423 
bus
.
mpc_ty³
 = 
MP_BUS
;

424 
bus
.
mpc_busid
 = 0;

425 
mpc_deçuÉ_ty³
) {

427 
	`´štk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

428 
mpc_deçuÉ_ty³
);

432 
	`memıy
(
bus
.
mpc_bu¡y³
, "ISA ", 6);

435 
	`MP_bus_šfo
(&
bus
);

436 ià(
mpc_deçuÉ_ty³
 > 4) {

437 
bus
.
mpc_busid
 = 1;

438 
	`memıy
(
bus
.
mpc_bu¡y³
, "PCI ", 6);

439 
	`MP_bus_šfo
(&
bus
);

442 
ißpic
.
mpc_ty³
 = 
MP_IOAPIC
;

443 
ißpic
.
mpc_­icid
 = 2;

444 
ißpic
.
mpc_­icv”
 = 0;

445 
ißpic
.
mpc_æags
 = 
MPC_APIC_USABLE
;

446 
ißpic
.
mpc_­iÿddr
 = 0xFEC00000;

447 
	`MP_ißpic_šfo
(&
ißpic
);

452 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
);

454 
lšt¤c
.
mpc_ty³
 = 
MP_LINTSRC
;

455 
lšt¤c
.
mpc_œqæag
 = 0;

456 
lšt¤c
.
mpc_¤cbusid
 = 0;

457 
lšt¤c
.
mpc_¤cbusœq
 = 0;

458 
lšt¤c
.
mpc_de¡­ic
 = 
MP_APIC_ALL
;

459 
i
 = 0; i < 2; i++) {

460 
lšt¤c
.
mpc_œqty³
 = 
lš‰y³s
[
i
];

461 
lšt¤c
.
mpc_de¡­işšt
 = 
i
;

462 
	`MP_lšt¤c_šfo
(&
lšt¤c
);

464 
	}
}

466 
š‹l_mp_æßtšg
 *
	gmpf_found
;

471 
__š™
 
	$g‘_smp_cÚfig
 ()

473 
š‹l_mp_æßtšg
 *
mpf
 = 
mpf_found
;

479 ià(
aıi_Ïpic
 && 
aıi_ißpic
) {

480 
	`´štk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration information\n");

483 ià(
aıi_Ïpic
)

484 
	`´štk
(
KERN_INFO
 "Using ACPI for…rocessor (LAPIC) configuration information\n");

486 
	`´štk
("IÁ– MuÉiProûssÜ S³cifiÿtiÚ v1.%d\n", 
mpf
->
mpf_¥ecifiÿtiÚ
);

491 ià(
mpf
->
mpf_ã©u»1
 != 0) {

493 
	`´štk
(
KERN_INFO
 "DeçuÉ MP cÚfigu¿tiÚ #%d\n", 
mpf
->
mpf_ã©u»1
);

494 
	`cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpf
->
mpf_ã©u»1
);

496 } ià(
mpf
->
mpf_phy¥Œ
) {

502 ià(!
	`smp_»ad_mpc
(
	`phys_to_vœt
(
mpf
->
mpf_phy¥Œ
))) {

503 
smp_found_cÚfig
 = 0;

504 
	`´štk
(
KERN_ERR
 "BIOS bug, MPableƒrrors detected!...\n");

505 
	`´štk
(
KERN_ERR
 "... disabling SMP support. (tell your hw vendor)\n");

513 ià(!
mp_œq_’Œ›s
) {

514 
mpc_cÚfig_bus
 
bus
;

516 
	`´štk
(
KERN_ERR
 "BIOS bug,‚oƒxplicit IRQƒntries, using default mptable. (tell your hw vendor)\n");

518 
bus
.
mpc_ty³
 = 
MP_BUS
;

519 
bus
.
mpc_busid
 = 0;

520 
	`memıy
(
bus
.
mpc_bu¡y³
, "ISA ", 6);

521 
	`MP_bus_šfo
(&
bus
);

523 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(0);

527 
	`BUG
();

529 
	`´štk
(
KERN_INFO
 "ProûssÜs: %d\n", 
num_´oûssÜs
);

533 
	}
}

535 
__š™
 
	$smp_sÿn_cÚfig
 (
ba£
, 
Ëngth
)

537 
	`__bad_mpf_size
();

538 *
bp
 = 
	`phys_to_vœt
(
ba£
);

539 
š‹l_mp_æßtšg
 *
mpf
;

541 
	`D´štk
("SÿÀSMP from %°fÜ %ld by‹s.\n", 
bp
,
Ëngth
);

542 ià((*
mpf
) != 16)

543 
	`__bad_mpf_size
();

545 
Ëngth
 > 0) {

546 
mpf
 = (
š‹l_mp_æßtšg
 *)
bp
;

547 ià((*
bp
 =ğ
SMP_MAGIC_IDENT
) &&

548 (
mpf
->
mpf_Ëngth
 == 1) &&

549 !
	`mpf_checksum
((*)
bp
, 16) &&

550 ((
mpf
->
mpf_¥ecifiÿtiÚ
 == 1)

551 || (
mpf
->
mpf_¥ecifiÿtiÚ
 == 4)) ) {

553 
smp_found_cÚfig
 = 1;

554 
	`»£rve_boÙmem_g’”ic
(
	`vœt_to_phys
(
mpf
), 
PAGE_SIZE
);

555 ià(
mpf
->
mpf_phy¥Œ
)

556 
	`»£rve_boÙmem_g’”ic
(
mpf
->
mpf_phy¥Œ
, 
PAGE_SIZE
);

557 
mpf_found
 = 
mpf
;

560 
bp
 += 4;

561 
Ëngth
 -= 16;

564 
	}
}

566 
__š™
 
	$fšd_smp_cÚfig
()

568 
add»ss
;

578 ià(
	`smp_sÿn_cÚfig
(0x0,0x400) ||

579 
	`smp_sÿn_cÚfig
(639*0x400,0x400) ||

580 
	`smp_sÿn_cÚfig
(0xF0000,0x10000))

595 
add»ss
 = *(*)
	`phys_to_vœt
(0x40E);

596 
add»ss
 <<= 4;

597 ià(
	`smp_sÿn_cÚfig
(
add»ss
, 0x1000))

601 
	`´štk
(
KERN_INFO
 "No mptable found.\n");

602 
	}
}

608 #ifdeà
CONFIG_ACPI


610 
__š™
 
	$mp_»gi¡”_Ïpic_add»ss
(
u64
 
add»ss
)

612 
mp_Ïpic_addr
 = (è
add»ss
;

613 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
mp_Ïpic_addr
);

614 ià(
boÙ_ıu_id
 == -1U)

615 
boÙ_ıu_id
 = 
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
));

616 
	}
}

618 
__ıuš™
 
	$mp_»gi¡”_Ïpic
 (
u8
 
id
, u8 
’abËd
)

620 
mpc_cÚfig_´oûssÜ
 
´oûssÜ
;

621 
boÙ_ıu
 = 0;

623 ià(
id
 =ğ
boÙ_ıu_id
)

624 
boÙ_ıu
 = 1;

626 
´oûssÜ
.
mpc_ty³
 = 
MP_PROCESSOR
;

627 
´oûssÜ
.
mpc_­icid
 = 
id
;

628 
´oûssÜ
.
mpc_­icv”
 = 0;

629 
´oûssÜ
.
mpc_ıuæag
 = (
’abËd
 ? 
CPU_ENABLED
 : 0);

630 
´oûssÜ
.
mpc_ıuæag
 |ğ(
boÙ_ıu
 ? 
CPU_BOOTPROCESSOR
 : 0);

631 
´oûssÜ
.
mpc_ıuã©u»
 = 0;

632 
´oûssÜ
.
mpc_ã©u»æag
 = 0;

633 
´oûssÜ
.
mpc_»£rved
[0] = 0;

634 
´oûssÜ
.
mpc_»£rved
[1] = 0;

636 
	`MP_´oûssÜ_šfo
(&
´oûssÜ
);

637 
	}
}

639 
	#MP_ISA_BUS
 0

	)

640 
	#MP_MAX_IOAPIC_PIN
 127

	)

642 
	smp_ißpic_routšg
 {

643 
	m­ic_id
;

644 
	mgsi_¡¬t
;

645 
	mgsi_’d
;

646 
u32
 
	mpš_´og¿mmed
[4];

647 } 
	gmp_ißpic_routšg
[
MAX_IO_APICS
];

649 
	$mp_fšd_ißpic
(
gsi
)

651 
i
 = 0;

654 
i
 = 0; i < 
Ä_ißpics
; i++) {

655 ià((
gsi
 >ğ
mp_ißpic_routšg
[
i
].
gsi_¡¬t
)

656 && (
gsi
 <ğ
mp_ißpic_routšg
[
i
].
gsi_’d
))

657  
i
;

660 
	`´štk
(
KERN_ERR
 "ERROR: UÇbËØloÿ‹ IOAPIC fÜ GSI %d\n", 
gsi
);

662 
	}
}

664 
u8
 
	$uniq_ißpic_id
(
u8
 
id
)

666 
i
;

667 
	`DECLARE_BITMAP
(
u£d
, 256);

668 
	`b™m­_z”o
(
u£d
, 256);

669 
i
 = 0; i < 
Ä_ißpics
; i++) {

670 
mpc_cÚfig_ißpic
 *
Ÿ
 = &
mp_ißpics
[
i
];

671 
	`__£t_b™
(
Ÿ
->
mpc_­icid
, 
u£d
);

673 ià(!
	`‹¡_b™
(
id
, 
u£d
))

674  
id
;

675  
	`fšd_fœ¡_z”o_b™
(
u£d
, 256);

676 
	}
}

678 
__š™
 
	$mp_»gi¡”_ißpic
(
u8
 
id
, 
u32
 
add»ss
, u32 
gsi_ba£
)

680 
idx
 = 0;

682 ià(
	`bad_ißpic
(
add»ss
))

685 
idx
 = 
Ä_ißpics
;

687 
mp_ißpics
[
idx
].
mpc_ty³
 = 
MP_IOAPIC
;

688 
mp_ißpics
[
idx
].
mpc_æags
 = 
MPC_APIC_USABLE
;

689 
mp_ißpics
[
idx
].
mpc_­iÿddr
 = 
add»ss
;

691 
	`£t_fixm­_noÿche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
add»ss
);

692 
mp_ißpics
[
idx
].
mpc_­icid
 = 
	`uniq_ißpic_id
(
id
);

693 
mp_ißpics
[
idx
].
mpc_­icv”
 = 0;

699 
mp_ißpic_routšg
[
idx
].
­ic_id
 = 
mp_ißpics
[idx].
mpc_­icid
;

700 
mp_ißpic_routšg
[
idx
].
gsi_¡¬t
 = 
gsi_ba£
;

701 
mp_ißpic_routšg
[
idx
].
gsi_’d
 = 
gsi_ba£
 +

702 
	`io_­ic_g‘_»dœ_’Œ›s
(
idx
);

704 
	`´štk
(
KERN_INFO
 "IOAPIC[%d]:‡pic_id %d,‡ddress 0x%x, "

705 "GSI %d-%d\n", 
idx
, 
mp_ißpics
[idx].
mpc_­icid
,

706 
mp_ißpics
[
idx
].
mpc_­iÿddr
,

707 
mp_ißpic_routšg
[
idx
].
gsi_¡¬t
,

708 
mp_ißpic_routšg
[
idx
].
gsi_’d
);

710 
Ä_ißpics
++;

711 
	}
}

713 
__š™


714 
	$mp_ov”ride_Ëgacy_œq
(
u8
 
bus_œq
, u8 
pŞ¬™y
, u8 
Œigg”
, 
u32
 
gsi
)

716 
mpc_cÚfig_št¤c
 
št¤c
;

717 
ißpic
 = -1;

718 
pš
 = -1;

723 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

724 ià(
ißpic
 < 0)

726 
pš
 = 
gsi
 - 
mp_ißpic_routšg
[
ißpic
].
gsi_¡¬t
;

733 ià((
bus_œq
 =ğ0è&& (
Œigg”
 == 3))

734 
Œigg”
 = 1;

736 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

737 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

738 
št¤c
.
mpc_œqæag
 = (
Œigg”
 << 2è| 
pŞ¬™y
;

739 
št¤c
.
mpc_¤cbus
 = 
MP_ISA_BUS
;

740 
št¤c
.
mpc_¤cbusœq
 = 
bus_œq
;

741 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[
ißpic
].
mpc_­icid
;

742 
št¤c
.
mpc_d¡œq
 = 
pš
;

744 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d, irq %d, %d-%d\n",

745 
št¤c
.
mpc_œqty³
, iÁ¤c.
mpc_œqæag
 & 3,

746 (
št¤c
.
mpc_œqæag
 >> 2è& 3, iÁ¤c.
mpc_¤cbus
,

747 
št¤c
.
mpc_¤cbusœq
, iÁ¤c.
mpc_d¡­ic
, iÁ¤c.
mpc_d¡œq
);

749 
mp_œqs
[
mp_œq_’Œ›s
] = 
št¤c
;

750 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

751 
	`·nic
("Max # of irq sourcesƒxceeded!\n");

752 
	}
}

754 
__š™
 
	$mp_cÚfig_aıi_Ëgacy_œqs
()

756 
mpc_cÚfig_št¤c
 
št¤c
;

757 
i
 = 0;

758 
ißpic
 = -1;

763 
	`£t_b™
(
MP_ISA_BUS
, 
mp_bus_nÙ_pci
);

768 
ißpic
 = 
	`mp_fšd_ißpic
(0);

769 ià(
ißpic
 < 0)

772 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

773 
št¤c
.
mpc_œqæag
 = 0;

774 
št¤c
.
mpc_¤cbus
 = 
MP_ISA_BUS
;

775 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[
ißpic
].
mpc_­icid
;

781 
i
 = 0; i < 16; i++) {

782 
idx
;

784 
idx
 = 0; idx < 
mp_œq_’Œ›s
; idx++) {

785 
mpc_cÚfig_št¤c
 *
œq
 = 
mp_œqs
 + 
idx
;

788 ià(
œq
->
mpc_¤cbus
 =ğ
MP_ISA_BUS
 && irq->
mpc_¤cbusœq
 =ğ
i
)

792 ià((
œq
->
mpc_d¡­ic
 =ğ
št¤c
.mpc_dstapic) &&

793 (
œq
->
mpc_d¡œq
 =ğ
i
))

797 ià(
idx
 !ğ
mp_œq_’Œ›s
) {

798 
	`´štk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ov”ride.\n", 
i
);

802 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

803 
št¤c
.
mpc_¤cbusœq
 = 
i
;

804 
št¤c
.
mpc_d¡œq
 = 
i
;

806 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d, irq %d, "

807 "%d-%d\n", 
št¤c
.
mpc_œqty³
, iÁ¤c.
mpc_œqæag
 & 3,

808 (
št¤c
.
mpc_œqæag
 >> 2è& 3, iÁ¤c.
mpc_¤cbus
,

809 
št¤c
.
mpc_¤cbusœq
, iÁ¤c.
mpc_d¡­ic
,

810 
št¤c
.
mpc_d¡œq
);

812 
mp_œqs
[
mp_œq_’Œ›s
] = 
št¤c
;

813 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

814 
	`·nic
("Max # of irq sourcesƒxceeded!\n");

816 
	}
}

818 
	$mp_»gi¡”_gsi
(
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

820 
ißpic
 = -1;

821 
ißpic_pš
 = 0;

822 
idx
, 
b™
 = 0;

824 ià(
aıi_œq_mod–
 !ğ
ACPI_IRQ_MODEL_IOAPIC
)

825  
gsi
;

828 ià(
aıi_gbl_FADT
.
sci_š‹¼u±
 =ğ
gsi
)

829  
gsi
;

831 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

832 ià(
ißpic
 < 0) {

833 
	`´štk
(
KERN_WARNING
 "NØIOAPIC fÜ GSI %u\n", 
gsi
);

834  
gsi
;

837 
ißpic_pš
 = 
gsi
 - 
mp_ißpic_routšg
[
ißpic
].
gsi_¡¬t
;

844 
b™
 = 
ißpic_pš
 % 32;

845 
idx
 = (
ißpic_pš
 < 32) ? 0 : (ioapic_pin / 32);

846 ià(
idx
 > 3) {

847 
	`´štk
(
KERN_ERR
 "Invalid„eferenceo IOAPIC…in "

848 "%d-%d\n", 
mp_ißpic_routšg
[
ißpic
].
­ic_id
,

849 
ißpic_pš
);

850  
gsi
;

852 ià((1<<
b™
è& 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
[
idx
]) {

853 
	`D´štk
(
KERN_DEBUG
 "Pin %d-%d‡lready…rogrammed\n",

854 
mp_ißpic_routšg
[
ißpic
].
­ic_id
, 
ißpic_pš
);

855  
gsi
;

858 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
[
idx
] |ğ(1<<
b™
);

860 
	`io_­ic_£t_pci_routšg
(
ißpic
, 
ißpic_pš
, 
gsi
,

861 
Œigg”šg
 =ğ
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

862 
pŞ¬™y
 =ğ
ACPI_ACTIVE_HIGH
 ? 0 : 1);

863  
gsi
;

864 
	}
}

	@/cmpt816/linux/arch/x86/kernel/msr.c

24 
	~<lšux/moduË.h
>

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/”ºo.h
>

28 
	~<lšux/fú.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/pŞl.h
>

31 
	~<lšux/smp.h
>

32 
	~<lšux/smp_lock.h
>

33 
	~<lšux/majÜ.h
>

34 
	~<lšux/fs.h
>

35 
	~<lšux/deviû.h
>

36 
	~<lšux/ıu.h
>

37 
	~<lšux/nÙif›r.h
>

39 
	~<asm/´oûssÜ.h
>

40 
	~<asm/m¤.h
>

41 
	~<asm/uacûss.h
>

42 
	~<asm/sy¡em.h
>

44 
şass
 *
	gm¤_şass
;

46 
loff_t
 
	$m¤_£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
Üig
)

48 
loff_t
 
»t
 = -
EINVAL
;

50 
	`lock_k”Ãl
();

51 
Üig
) {

53 
fe
->
f_pos
 = 
off£t
;

54 
»t
 = 
fe
->
f_pos
;

57 
fe
->
f_pos
 +ğ
off£t
;

58 
»t
 = 
fe
->
f_pos
;

60 
	`uÆock_k”Ãl
();

61  
»t
;

62 
	}
}

64 
ssize_t
 
	$m¤_»ad
(
fe
 *fe, 
__u£r
 * 
buf
,

65 
size_t
 
couÁ
, 
loff_t
 * 
µos
)

67 
u32
 
__u£r
 *
tmp
 = (u32 __u£¸*è
buf
;

68 
u32
 
d©a
[2];

69 
u32
 
»g
 = *
µos
;

70 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

71 
”r
;

73 ià(
couÁ
 % 8)

74  -
EINVAL
;

76 ; 
couÁ
; count -= 8) {

77 
”r
 = 
	`rdm¤_§ã_Ú_ıu
(
ıu
, 
»g
, &
d©a
[0], &data[1]);

78 ià(
”r
)

79  -
EIO
;

80 ià(
	`cİy_to_u£r
(
tmp
, &
d©a
, 8))

81  -
EFAULT
;

82 
tmp
 += 2;

85  ((
__u£r
 *)
tmp
è- 
buf
;

86 
	}
}

88 
ssize_t
 
	$m¤_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
,

89 
size_t
 
couÁ
, 
loff_t
 *
µos
)

91 cÚ¡ 
u32
 
__u£r
 *
tmp
 = (cÚ¡ u32 __u£¸*)
buf
;

92 
u32
 
d©a
[2];

93 
u32
 
»g
 = *
µos
;

94 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

95 
”r
;

97 ià(
couÁ
 % 8)

98  -
EINVAL
;

100 ; 
couÁ
; count -= 8) {

101 ià(
	`cİy_äom_u£r
(&
d©a
, 
tmp
, 8))

102  -
EFAULT
;

103 
”r
 = 
	`wrm¤_§ã_Ú_ıu
(
ıu
, 
»g
, 
d©a
[0], data[1]);

104 ià(
”r
)

105  -
EIO
;

106 
tmp
 += 2;

109  ((
__u£r
 *)
tmp
è- 
buf
;

110 
	}
}

112 
	$m¤_İ’
(
šode
 *šode, 
fe
 *file)

114 
ıu
 = 
	`imšÜ
(
fe
->
f_·th
.
d’Œy
->
d_šode
);

115 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

117 ià(
ıu
 >ğ
NR_CPUS
 || !
	`ıu_Úlše
(cpu))

118  -
ENXIO
;

119 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_MSR
))

120  -
EIO
;

123 
	}
}

128 cÚ¡ 
fe_İ”©iÚs
 
	gm¤_fİs
 = {

129 .
owÃr
 = 
THIS_MODULE
,

130 .
	gÎ£ek
 = 
m¤_£ek
,

131 .
	g»ad
 = 
m¤_»ad
,

132 .
	gwr™e
 = 
m¤_wr™e
,

133 .
	gİ’
 = 
m¤_İ’
,

136 
__ıuš™
 
	$m¤_deviû_ü—‹
(
ıu
)

138 
deviû
 *
dev
;

140 
dev
 = 
	`deviû_ü—‹
(
m¤_şass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
ıu
),

141 "m¤%d", 
ıu
);

142  
	`IS_ERR
(
dev
è? 
	`PTR_ERR
(dev) : 0;

143 
	}
}

145 
	$m¤_deviû_de¡roy
(
ıu
)

147 
	`deviû_de¡roy
(
m¤_şass
, 
	`MKDEV
(
MSR_MAJOR
, 
ıu
));

148 
	}
}

150 
__ıuš™
 
	$m¤_şass_ıu_ÿÎback
(
nÙif›r_block
 *
nfb
,

151 
aùiÚ
, *
hıu
)

153 
ıu
 = ()
hıu
;

154 
”r
 = 0;

156 
aùiÚ
) {

157 
CPU_UP_PREPARE
:

158 
CPU_UP_PREPARE_FROZEN
:

159 
”r
 = 
	`m¤_deviû_ü—‹
(
ıu
);

161 
CPU_UP_CANCELED
:

162 
CPU_UP_CANCELED_FROZEN
:

163 
CPU_DEAD
:

164 
CPU_DEAD_FROZEN
:

165 
	`m¤_deviû_de¡roy
(
ıu
);

168  
”r
 ? 
NOTIFY_BAD
 : 
NOTIFY_OK
;

169 
	}
}

171 
nÙif›r_block
 
__ıuš™d©a
 
	gm¤_şass_ıu_nÙif›r
 = {

172 .
nÙif›r_ÿÎ
 = 
m¤_şass_ıu_ÿÎback
,

175 
__š™
 
	$m¤_š™
()

177 
i
, 
”r
 = 0;

178 
i
 = 0;

180 ià(
	`»gi¡”_chrdev
(
MSR_MAJOR
, "ıu/m¤", &
m¤_fİs
)) {

181 
	`´štk
(
KERN_ERR
 "msr: unableo get major %d for msr\n",

182 
MSR_MAJOR
);

183 
”r
 = -
EBUSY
;

184 
out
;

186 
m¤_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "msr");

187 ià(
	`IS_ERR
(
m¤_şass
)) {

188 
”r
 = 
	`PTR_ERR
(
m¤_şass
);

189 
out_chrdev
;

191 
	`fÜ_—ch_Úlše_ıu
(
i
) {

192 
”r
 = 
	`m¤_deviû_ü—‹
(
i
);

193 ià(
”r
 != 0)

194 
out_şass
;

196 
	`»gi¡”_hÙıu_nÙif›r
(&
m¤_şass_ıu_nÙif›r
);

198 
”r
 = 0;

199 
out
;

201 
out_şass
:

202 
i
 = 0;

203 
	`fÜ_—ch_Úlše_ıu
(
i
)

204 
	`m¤_deviû_de¡roy
(
i
);

205 
	`şass_de¡roy
(
m¤_şass
);

206 
out_chrdev
:

207 
	`uÄegi¡”_chrdev
(
MSR_MAJOR
, "cpu/msr");

208 
out
:

209  
”r
;

210 
	}
}

212 
__ex™
 
	$m¤_ex™
()

214 
ıu
 = 0;

215 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

216 
	`m¤_deviû_de¡roy
(
ıu
);

217 
	`şass_de¡roy
(
m¤_şass
);

218 
	`uÄegi¡”_chrdev
(
MSR_MAJOR
, "cpu/msr");

219 
	`uÄegi¡”_hÙıu_nÙif›r
(&
m¤_şass_ıu_nÙif›r
);

220 
	}
}

222 
moduË_š™
(
m¤_š™
);

223 
	$moduË_ex™
(
m¤_ex™
)

225 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

226 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

227 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/nmi_64.c

13 
	~<lšux/nmi.h
>

14 
	~<lšux/mm.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/š‹¼u±.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/sysdev.h
>

19 
	~<lšux/sysùl.h
>

20 
	~<lšux/k´obes.h
>

21 
	~<lšux/ıumask.h
>

22 
	~<lšux/kdebug.h
>

24 
	~<asm/smp.h
>

25 
	~<asm/nmi.h
>

26 
	~<asm/´Ùo.h
>

27 
	~<asm/mû.h
>

29 
	gunknown_nmi_·nic
;

30 
	gnmi_w©chdog_’abËd
;

31 
	g·nic_Ú_uÄecov”ed_nmi
;

33 
ıumask_t
 
	gbackŒaû_mask
 = 
CPU_MASK_NONE
;

41 
©omic_t
 
	gnmi_aùive
 = 
ATOMIC_INIT
(0);

42 
	g·nic_Ú_timeout
;

44 
	gnmi_w©chdog
 = 
NMI_DEFAULT
;

45 
	gnmi_hz
 = 
HZ
;

47 
DEFINE_PER_CPU
(, 
wd_’abËd
);

50 
unknown_nmi_·nic_ÿÎback
(
±_»gs
 *
»gs
, 
ıu
);

53 
	$nmi_w©chdog_deçuÉ
()

55 ià(
nmi_w©chdog
 !ğ
NMI_DEFAULT
)

57 
nmi_w©chdog
 = 
NMI_NONE
;

58 
	}
}

60 
’dæag
 
	g__š™d©a
 = 0;

62 #ifdeà
CONFIG_SMP


67 
__š™
 
	$nmi_ıu_busy
(*
d©a
)

69 
	`loÿl_œq_’abË_š_h¬dœq
();

76 
’dæag
 == 0)

77 
	`mb
();

78 
	}
}

81 
__š™
 
	$check_nmi_w©chdog
 ()

83 *
couÁs
;

84 
ıu
;

86 ià((
nmi_w©chdog
 =ğ
NMI_NONE
è|| (nmi_w©chdog =ğ
NMI_DISABLED
))

89 ià(!
	`©omic_»ad
(&
nmi_aùive
))

92 
couÁs
 = 
	`km®loc
(
NR_CPUS
 * (), 
GFP_KERNEL
);

93 ià(!
couÁs
)

96 
	`´štk
(
KERN_INFO
 "testing NMI watchdog ... ");

98 #ifdeà
CONFIG_SMP


99 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

100 
	`smp_ÿÎ_funùiÚ
(
nmi_ıu_busy
, (*)&
’dæag
, 0, 0);

103 
ıu
 = 0; cpu < 
NR_CPUS
; cpu++)

104 
couÁs
[
ıu
] = 
	`ıu_pda
(ıu)->
__nmi_couÁ
;

105 
	`loÿl_œq_’abË
();

106 
	`md–ay
((20*1000)/
nmi_hz
);

108 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

109 ià(!
	`³r_ıu
(
wd_’abËd
, 
ıu
))

111 ià(
	`ıu_pda
(
ıu
)->
__nmi_couÁ
 - 
couÁs
[cpu] <= 5) {

112 
	`´štk
(
KERN_WARNING
 "WARNING: CPU#%d: NMI "

114 
ıu
,

115 
couÁs
[
ıu
],

116 
	`ıu_pda
(
ıu
)->
__nmi_couÁ
);

117 
	`³r_ıu
(
wd_’abËd
, 
ıu
) = 0;

118 
	`©omic_dec
(&
nmi_aùive
);

121 ià(!
	`©omic_»ad
(&
nmi_aùive
)) {

122 
	`kä“
(
couÁs
);

123 
	`©omic_£t
(&
nmi_aùive
, -1);

124 
’dæag
 = 1;

127 
’dæag
 = 1;

128 
	`´štk
("OK.\n");

132 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

133 
nmi_hz
 = 
	`Ïpic_adju¡_nmi_hz
(1);

135 
	`kä“
(
couÁs
);

137 
	}
}

139 
__š™
 
	$£tup_nmi_w©chdog
(*
¡r
)

141 
nmi
;

143 ià(!
	`¡ºcmp
(
¡r
,"panic",5)) {

144 
·nic_Ú_timeout
 = 1;

145 
¡r
 = 
	`¡rchr
(str, ',');

146 ià(!
¡r
)

148 ++
¡r
;

151 
	`g‘_İtiÚ
(&
¡r
, &
nmi
);

153 ià((
nmi
 >ğ
NMI_INVALID
è|| (nm˜< 
NMI_NONE
))

156 
nmi_w©chdog
 = 
nmi
;

158 
	}
}

160 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

163 
	$__aıi_nmi_di§bË
(*
__unu£d
)

165 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

166 
	}
}

171 
	$aıi_nmi_di§bË
()

173 ià(
	`©omic_»ad
(&
nmi_aùive
è&& 
nmi_w©chdog
 =ğ
NMI_IO_APIC
)

174 
	`Ú_—ch_ıu
(
__aıi_nmi_di§bË
, 
NULL
, 0, 1);

175 
	}
}

177 
	$__aıi_nmi_’abË
(*
__unu£d
)

179 
	`­ic_wr™e
(
APIC_LVT0
, 
APIC_DM_NMI
);

180 
	}
}

185 
	$aıi_nmi_’abË
()

187 ià(
	`©omic_»ad
(&
nmi_aùive
è&& 
nmi_w©chdog
 =ğ
NMI_IO_APIC
)

188 
	`Ú_—ch_ıu
(
__aıi_nmi_’abË
, 
NULL
, 0, 1);

189 
	}
}

190 #ifdeà
CONFIG_PM


192 
	gnmi_pm_aùive
;

194 
	$Ïpic_nmi_su¥’d
(
sys_deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

197 
nmi_pm_aùive
 = 
	`©omic_»ad
(&
nmi_aùive
);

198 
	`¡İ_­ic_nmi_w©chdog
(
NULL
);

199 
	`BUG_ON
(
	`©omic_»ad
(&
nmi_aùive
) != 0);

201 
	}
}

203 
	$Ïpic_nmi_»sume
(
sys_deviû
 *
dev
)

206 ià(
nmi_pm_aùive
 > 0) {

207 
	`£tup_­ic_nmi_w©chdog
(
NULL
);

208 
	`touch_nmi_w©chdog
();

211 
	}
}

213 
sysdev_şass
 
	gnmi_sysşass
 = {

214 
£t_k£t_Çme
("lapic_nmi"),

215 .
»sume
 = 
Ïpic_nmi_»sume
,

216 .
	gsu¥’d
 = 
Ïpic_nmi_su¥’d
,

219 
sys_deviû
 
	gdeviû_Ïpic_nmi
 = {

220 .
id
 = 0,

221 .
	gşs
 = &
nmi_sysşass
,

224 
__š™
 
	$š™_Ïpic_nmi_sysfs
()

226 
”rÜ
;

231 ià(
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
)

234 iàĞ
	`©omic_»ad
(&
nmi_aùive
) < 0 )

237 
”rÜ
 = 
	`sysdev_şass_»gi¡”
(&
nmi_sysşass
);

238 ià(!
”rÜ
)

239 
”rÜ
 = 
	`sysdev_»gi¡”
(&
deviû_Ïpic_nmi
);

240  
”rÜ
;

241 
	}
}

243 
Ï‹_š™ÿÎ
(
š™_Ïpic_nmi_sysfs
);

247 
	$£tup_­ic_nmi_w©chdog
(*
unu£d
)

249 ià(
	`__g‘_ıu_v¬
(
wd_’abËd
) == 1)

254 ià((
	`smp_´oûssÜ_id
(è!ğ0è&& (
	`©omic_»ad
(&
nmi_aùive
) <= 0))

257 
nmi_w©chdog
) {

258 
NMI_LOCAL_APIC
:

259 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 1;

260 ià(
	`Ïpic_w©chdog_š™
(
nmi_hz
) < 0) {

261 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 0;

265 
NMI_IO_APIC
:

266 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 1;

267 
	`©omic_šc
(&
nmi_aùive
);

269 
	}
}

271 
	$¡İ_­ic_nmi_w©chdog
(*
unu£d
)

274 ià((
nmi_w©chdog
 !ğ
NMI_LOCAL_APIC
) &&

275 (
nmi_w©chdog
 !ğ
NMI_IO_APIC
))

277 ià(
	`__g‘_ıu_v¬
(
wd_’abËd
) == 0)

279 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

280 
	`Ïpic_w©chdog_¡İ
();

281 
	`__g‘_ıu_v¬
(
wd_’abËd
) = 0;

282 
	`©omic_dec
(&
nmi_aùive
);

283 
	}
}

294 
DEFINE_PER_CPU
(, 
Ï¡_œq_sum
);

295 
DEFINE_PER_CPU
(
loÿl_t
, 
®”t_couÁ”
);

296 
DEFINE_PER_CPU
(, 
nmi_touch
);

298 
	$touch_nmi_w©chdog
()

300 ià(
nmi_w©chdog
 > 0) {

301 
ıu
;

308 
	`fÜ_—ch_´e£Á_ıu
(
ıu
) {

309 ià(
	`³r_ıu
(
nmi_touch
, 
ıu
) != 1)

310 
	`³r_ıu
(
nmi_touch
, 
ıu
) = 1;

314 
	`touch_soálockup_w©chdog
();

315 
	}
}

317 
__k´obes
 
	$nmi_w©chdog_tick
(
±_»gs
 * 
»gs
, 
»asÚ
)

319 
sum
;

320 
touched
 = 0;

321 
ıu
 = 
	`smp_´oûssÜ_id
();

322 
rc
 = 0;

325 ià(
	`nÙify_d›
(
DIE_NMI
, "nmi", 
»gs
, 
»asÚ
, 2, 
SIGINT
)

326 =ğ
NOTIFY_STOP
) {

327 
rc
 = 1;

328 
touched
 = 1;

331 
sum
 = 
	`»ad_pda
(
­ic_tim”_œqs
è+„—d_pda(
œq0_œqs
);

332 ià(
	`__g‘_ıu_v¬
(
nmi_touch
)) {

333 
	`__g‘_ıu_v¬
(
nmi_touch
) = 0;

334 
touched
 = 1;

337 ià(
	`ıu_is£t
(
ıu
, 
backŒaû_mask
)) {

338 
	`DEFINE_SPINLOCK
(
lock
);

340 
	`¥š_lock
(&
lock
);

341 
	`´štk
("NMI backŒaû fÜ cpu %d\n", 
ıu
);

342 
	`dump_¡ack
();

343 
	`¥š_uÆock
(&
lock
);

344 
	`ıu_ş—r
(
ıu
, 
backŒaû_mask
);

347 #ifdeà
CONFIG_X86_MCE


350 ià(
	`©omic_»ad
(&
mû_’Œy
) > 0)

351 
touched
 = 1;

354 ià(!
touched
 && 
	`__g‘_ıu_v¬
(
Ï¡_œq_sum
è=ğ
sum
) {

359 
	`loÿl_šc
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
));

360 ià(
	`loÿl_»ad
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
)è=ğ5*
nmi_hz
)

361 
	`d›_nmi
("NMI W©chdog d‘eùed LOCKUP oÀCPU %d\n", 
»gs
,

362 
·nic_Ú_timeout
);

364 
	`__g‘_ıu_v¬
(
Ï¡_œq_sum
èğ
sum
;

365 
	`loÿl_£t
(&
	`__g‘_ıu_v¬
(
®”t_couÁ”
), 0);

369 ià(!
	`__g‘_ıu_v¬
(
wd_’abËd
))

370  
rc
;

371 
nmi_w©chdog
) {

372 
NMI_LOCAL_APIC
:

373 
rc
 |ğ
	`Ïpic_wd_ev’t
(
nmi_hz
);

375 
NMI_IO_APIC
:

380 
rc
 = 1;

383  
rc
;

384 
	}
}

386 
	gignÜe_nmis
;

388 
asmlškage
 
__k´obes
 
	$do_nmi
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

390 
	`nmi_’‹r
();

391 
	`add_pda
(
__nmi_couÁ
,1);

392 ià(!
ignÜe_nmis
)

393 
	`deçuÉ_do_nmi
(
»gs
);

394 
	`nmi_ex™
();

395 
	}
}

397 
	$do_nmi_ÿÎback
(
±_»gs
 * 
»gs
, 
ıu
)

399 #ifdeà
CONFIG_SYSCTL


400 ià(
unknown_nmi_·nic
)

401  
	`unknown_nmi_·nic_ÿÎback
(
»gs
, 
ıu
);

404 
	}
}

406 
	$¡İ_nmi
()

408 
	`aıi_nmi_di§bË
();

409 
ignÜe_nmis
++;

410 
	}
}

412 
	$»¡¬t_nmi
()

414 
ignÜe_nmis
--;

415 
	`aıi_nmi_’abË
();

416 
	}
}

418 #ifdeà
CONFIG_SYSCTL


420 
	$unknown_nmi_·nic_ÿÎback
(
±_»gs
 *
»gs
, 
ıu
)

422 
»asÚ
 = 
	`g‘_nmi_»asÚ
();

423 
buf
[64];

425 
	`¥rštf
(
buf
, "NMI„eûived fÜ unknowÀ»asÚ %02x\n", 
»asÚ
);

426 
	`d›_nmi
(
buf
, 
»gs
, 1);

428 
	}
}

433 
	$´oc_nmi_’abËd
(
ùl_bË
 *
bË
, 
wr™e
, 
fe
 *file,

434 
__u£r
 *
bufãr
, 
size_t
 *
Ëngth
, 
loff_t
 *
µos
)

436 
Şd_¡©e
;

438 
nmi_w©chdog_’abËd
 = (
	`©omic_»ad
(&
nmi_aùive
) > 0) ? 1 : 0;

439 
Şd_¡©e
 = 
nmi_w©chdog_’abËd
;

440 
	`´oc_doštvec
(
bË
, 
wr™e
, 
fe
, 
bufãr
, 
Ëngth
, 
µos
);

441 ià(!!
Şd_¡©e
 =ğ!!
nmi_w©chdog_’abËd
)

444 ià(
	`©omic_»ad
(&
nmi_aùive
è< 0 || 
nmi_w©chdog
 =ğ
NMI_DISABLED
) {

445 
	`´štk
Ğ
KERN_WARNING
 "NMI watchdog is…ermanently disabled\n");

446  -
EIO
;

450 
	`nmi_w©chdog_deçuÉ
();

452 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
) {

453 ià(
nmi_w©chdog_’abËd
)

454 
	`’abË_Ïpic_nmi_w©chdog
();

456 
	`di§bË_Ïpic_nmi_w©chdog
();

458 
	`´štk
Ğ
KERN_WARNING


460  -
EIO
;

463 
	}
}

467 
	$__Œigg”_®l_ıu_backŒaû
()

469 
i
;

471 
backŒaû_mask
 = 
ıu_Úlše_m­
;

473 
i
 = 0; i < 10 * 1000; i++) {

474 ià(
	`ıus_em±y
(
backŒaû_mask
))

476 
	`md–ay
(1);

478 
	}
}

480 
EXPORT_SYMBOL
(
nmi_aùive
);

481 
EXPORT_SYMBOL
(
nmi_w©chdog
);

482 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma_64.c

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/pci.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/dm¬.h
>

11 
	~<asm/io.h
>

12 
	~<asm/g¬t.h
>

13 
	~<asm/ÿlg¬y.h
>

15 
iommu_m”ge
 
	g__»ad_mo¡ly
 = 0;

16 
EXPORT_SYMBOL
(
iommu_m”ge
);

18 
dma_addr_t
 
bad_dma_add»ss
 
	g__»ad_mo¡ly
;

19 
EXPORT_SYMBOL
(
bad_dma_add»ss
);

23 
iommu_bio_m”ge
 
	g__»ad_mo¡ly
 = 0;

24 
EXPORT_SYMBOL
(
iommu_bio_m”ge
);

26 
iommu_§c_fÜû
 
	g__»ad_mo¡ly
 = 0;

28 
no_iommu
 
	g__»ad_mo¡ly
;

29 #ifdeà
CONFIG_IOMMU_DEBUG


30 
·nic_Ú_ov”æow
 
	g__»ad_mo¡ly
 = 1;

31 
fÜû_iommu
 
	g__»ad_mo¡ly
 = 1;

33 
·nic_Ú_ov”æow
 
	g__»ad_mo¡ly
 = 0;

34 
fÜû_iommu
 
	g__»ad_mo¡ly
= 0;

38 
iommu_d‘eùed
 
	g__»ad_mo¡ly
 = 0;

43 
deviû
 
	gçÎback_dev
 = {

44 .
bus_id
 = "fallback device",

45 .
	gcoh”’t_dma_mask
 = 
DMA_32BIT_MASK
,

46 .
	gdma_mask
 = &
çÎback_dev
.
coh”’t_dma_mask
,

50 
nošlše
 *

51 
	$dma_®loc_·ges
(
deviû
 *
dev
, 
gå_t
 
gå
, 
Üd”
)

53 
·ge
 *page;

54 
node
;

56 
node
 = 
	`dev_to_node
(
dev
);

57 ià(
node
 == -1)

58 
node
 = 
	`numa_node_id
();

60 ià(
node
 < 
	`fœ¡_node
(
node_Úlše_m­
))

61 
node
 = 
	`fœ¡_node
(
node_Úlše_m­
);

63 
·ge
 = 
	`®loc_·ges_node
(
node
, 
gå
, 
Üd”
);

64  
·ge
 ? 
	`·ge_add»ss
Õageè: 
NULL
;

65 
	}
}

71 
	$dma_®loc_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_hªdË
,

72 
gå_t
 
gå
)

74 *
memÜy
;

75 
dma_mask
 = 0;

76 
u64
 
bus
;

78 ià(!
dev
)

79 
dev
 = &
çÎback_dev
;

80 
dma_mask
 = 
dev
->
coh”’t_dma_mask
;

81 ià(
dma_mask
 == 0)

82 
dma_mask
 = 
DMA_32BIT_MASK
;

85 ià(
dev
->
dma_mask
 =ğ
NULL
)

86  
NULL
;

89 
gå
 |ğ
__GFP_NORETRY
;

93 
dma_mask
 &ğ*
dev
->dma_mask;

99 ià(
dma_mask
 <ğ
DMA_32BIT_MASK
)

100 
gå
 |ğ
GFP_DMA32
;

102 
agaš
:

103 
memÜy
 = 
	`dma_®loc_·ges
(
dev
, 
gå
, 
	`g‘_Üd”
(
size
));

104 ià(
memÜy
 =ğ
NULL
)

105  
NULL
;

108 
high
, 
mmu
;

109 
bus
 = 
	`vœt_to_bus
(
memÜy
);

110 
high
 = (
bus
 + 
size
è>ğ
dma_mask
;

111 
mmu
 = 
high
;

112 ià(
fÜû_iommu
 && !(
gå
 & 
GFP_DMA
))

113 
mmu
 = 1;

114 ià(
high
) {

115 
	`ä“_·ges
(()
memÜy
,

116 
	`g‘_Üd”
(
size
));

120 ià(
dma_mask
 < 
DMA_32BIT_MASK
 && !(
gå
 & 
GFP_DMA
)) {

121 
gå
 = (gå & ~
GFP_DMA32
è| 
GFP_DMA
;

122 
agaš
;

126 
gå
 &ğ~(
GFP_DMA32
|
GFP_DMA
);

128 ià(
dma_İs
->
®loc_coh”’t
)

129  
dma_İs
->
	`®loc_coh”’t
(
dev
, 
size
,

130 
dma_hªdË
, 
gå
);

131  
NULL
;

134 
	`mem£t
(
memÜy
, 0, 
size
);

135 ià(!
mmu
) {

136 *
dma_hªdË
 = 
	`vœt_to_bus
(
memÜy
);

137  
memÜy
;

141 ià(
dma_İs
->
®loc_coh”’t
) {

142 
	`ä“_·ges
(()
memÜy
, 
	`g‘_Üd”
(
size
));

143 
gå
 &ğ~(
GFP_DMA
|
GFP_DMA32
);

144  
dma_İs
->
	`®loc_coh”’t
(
dev
, 
size
, 
dma_hªdË
, 
gå
);

147 ià(
dma_İs
->
m­_sim¶e
) {

148 *
dma_hªdË
 = 
dma_İs
->
	`m­_sim¶e
(
dev
, 
memÜy
,

149 
size
,

150 
PCI_DMA_BIDIRECTIONAL
);

151 ià(*
dma_hªdË
 !ğ
bad_dma_add»ss
)

152  
memÜy
;

155 ià(
·nic_Ú_ov”æow
)

156 
	`·nic
("dma_®loc_coh”’t: IOMMU ov”æow by %lu by‹s\n",
size
);

157 
	`ä“_·ges
(()
memÜy
, 
	`g‘_Üd”
(
size
));

158  
NULL
;

159 
	}
}

160 
EXPORT_SYMBOL
(
dma_®loc_coh”’t
);

166 
	$dma_ä“_coh”’t
(
deviû
 *
dev
, 
size_t
 
size
,

167 *
vaddr
, 
dma_addr_t
 
bus
)

169 
	`WARN_ON
(
	`œqs_di§bËd
());

170 ià(
dma_İs
->
unm­_sšgË
)

171 
dma_İs
->
	`unm­_sšgË
(
dev
, 
bus
, 
size
, 0);

172 
	`ä“_·ges
(()
vaddr
, 
	`g‘_Üd”
(
size
));

173 
	}
}

174 
EXPORT_SYMBOL
(
dma_ä“_coh”’t
);

176 
fÜbid_dac
 
	g__»ad_mo¡ly
;

178 
	$dma_suµÜ‹d
(
deviû
 *
dev
, 
u64
 
mask
)

180 #ifdeà
CONFIG_PCI


181 ià(
mask
 > 0xfffffffà&& 
fÜbid_dac
 > 0) {

185 
	`´štk
(
KERN_INFO
 "PCI: Di§Îowšg DAC fÜ deviû %s\n", 
dev
->
bus_id
);

190 ià(
dma_İs
->
dma_suµÜ‹d
)

191  
dma_İs
->
	`dma_suµÜ‹d
(
dev
, 
mask
);

196 ià(
mask
 < 
DMA_24BIT_MASK
)

211 ià(
iommu_§c_fÜû
 && (
mask
 >ğ
DMA_40BIT_MASK
)) {

212 
	`´štk
(
KERN_INFO
 "%s: FÜû SAC w™h mask %Lx\n", 
dev
->
bus_id
,
mask
);

217 
	}
}

218 
EXPORT_SYMBOL
(
dma_suµÜ‹d
);

220 
	$dma_£t_mask
(
deviû
 *
dev
, 
u64
 
mask
)

222 ià(!
dev
->
dma_mask
 || !
	`dma_suµÜ‹d
(dev, 
mask
))

223  -
EIO
;

224 *
dev
->
dma_mask
 = 
mask
;

226 
	}
}

227 
EXPORT_SYMBOL
(
dma_£t_mask
);

233 
__š™
 
	$iommu_£tup
(*
p
)

235 
iommu_m”ge
 = 1;

237 ià(!
p
)

238  -
EINVAL
;

240 *
p
) {

241 ià(!
	`¡ºcmp
(
p
,"off",3))

242 
no_iommu
 = 1;

244 ià(!
	`¡ºcmp
(
p
,"force",5))

245 
fÜû_iommu
 = 1;

246 ià(!
	`¡ºcmp
(
p
,"noforce",7)) {

247 
iommu_m”ge
 = 0;

248 
fÜû_iommu
 = 0;

251 ià(!
	`¡ºcmp
(
p
, "biomerge",8)) {

252 
iommu_bio_m”ge
 = 4096;

253 
iommu_m”ge
 = 1;

254 
fÜû_iommu
 = 1;

256 ià(!
	`¡ºcmp
(
p
, "panic",5))

257 
·nic_Ú_ov”æow
 = 1;

258 ià(!
	`¡ºcmp
(
p
, "nopanic",7))

259 
·nic_Ú_ov”æow
 = 0;

260 ià(!
	`¡ºcmp
(
p
, "merge",5)) {

261 
iommu_m”ge
 = 1;

262 
fÜû_iommu
 = 1;

264 ià(!
	`¡ºcmp
(
p
, "nomerge",7))

265 
iommu_m”ge
 = 0;

266 ià(!
	`¡ºcmp
(
p
, "forcesac",8))

267 
iommu_§c_fÜû
 = 1;

268 ià(!
	`¡ºcmp
(
p
, "allowdac", 8))

269 
fÜbid_dac
 = 0;

270 ià(!
	`¡ºcmp
(
p
, "nodac", 5))

271 
fÜbid_dac
 = -1;

273 #ifdeà
CONFIG_SWIOTLB


274 ià(!
	`¡ºcmp
(
p
, "soft",4))

275 
swiÙlb
 = 1;

278 #ifdeà
CONFIG_GART_IOMMU


279 
	`g¬t_·r£_İtiÚs
(
p
);

282 #ifdeà
CONFIG_CALGARY_IOMMU


283 ià(!
	`¡ºcmp
(
p
, "calgary", 7))

284 
u£_ÿlg¬y
 = 1;

287 
p
 +ğ
	`¡rc¥n
(p, ",");

288 ià(*
p
 == ',')

289 ++
p
;

292 
	}
}

293 
—¾y_·¿m
("iommu", 
iommu_£tup
);

295 
__š™
 
	$pci_iommu_®loc
()

301 #ifdeà
CONFIG_GART_IOMMU


302 
	`g¬t_iommu_hŞe_š™
();

305 #ifdeà
CONFIG_CALGARY_IOMMU


306 
	`d‘eù_ÿlg¬y
();

309 
	`d‘eù_š‹l_iommu
();

311 #ifdeà
CONFIG_SWIOTLB


312 
	`pci_swiÙlb_š™
();

314 
	}
}

316 
__š™
 
	$pci_iommu_š™
()

318 #ifdeà
CONFIG_CALGARY_IOMMU


319 
	`ÿlg¬y_iommu_š™
();

322 
	`š‹l_iommu_š™
();

324 #ifdeà
CONFIG_GART_IOMMU


325 
	`g¬t_iommu_š™
();

328 
	`no_iommu_š™
();

330 
	}
}

332 
	$pci_iommu_shutdown
()

334 
	`g¬t_iommu_shutdown
();

335 
	}
}

337 #ifdeà
CONFIG_PCI


340 
__devš™
 
	$vŸ_no_dac
(
pci_dev
 *
dev
)

342 ià((
dev
->
şass
 >> 8è=ğ
PCI_CLASS_BRIDGE_PCI
 && 
fÜbid_dac
 == 0) {

343 
	`´štk
(
KERN_INFO
 "PCI: VIA PCI bridge detected. Disabling DAC.\n");

344 
fÜbid_dac
 = 1;

346 
	}
}

347 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vŸ_no_dac
);

350 
fs_š™ÿÎ
(
pci_iommu_š™
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/ùy³.h
>

16 
	~<lšux/agp_back’d.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/¥šlock.h
>

21 
	~<lšux/pci.h
>

22 
	~<lšux/moduË.h
>

23 
	~<lšux/tİŞogy.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/b™İs.h
>

26 
	~<lšux/kdebug.h
>

27 
	~<lšux/sÿ‰”li¡.h
>

28 
	~<asm/©omic.h
>

29 
	~<asm/io.h
>

30 
	~<asm/mŒr.h
>

31 
	~<asm/pgbË.h
>

32 
	~<asm/´Ùo.h
>

33 
	~<asm/g¬t.h
>

34 
	~<asm/ÿcheæush.h
>

35 
	~<asm/swiÙlb.h
>

36 
	~<asm/dma.h
>

37 
	~<asm/k8.h
>

39 
	giommu_bus_ba£
;

40 
	giommu_size
;

41 
	giommu_·ges
;

43 
u32
 *
	giommu_g©t_ba£
;

50 
	giommu_fuÎæush
 = 1;

53 
DEFINE_SPINLOCK
(
iommu_b™m­_lock
);

54 *
	giommu_g¬t_b™m­
;

56 
u32
 
	gg¬t_unm­³d_’Œy
;

58 
	#GPTE_VALID
 1

	)

59 
	#GPTE_COHERENT
 2

	)

60 
	#GPTE_ENCODE
(
x
) \

61 (((
x
è& 0xfffff000è| (((xè>> 32è<< 4è| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

62 
	#GPTE_DECODE
(
x
è(((xè& 0xfffff000è| (((
u64
)(xè& 0xff0è<< 28))

	)

64 
	#to_·ges
(
addr
,
size
) \

65 (
	`round_up
(((
addr
è& ~
PAGE_MASK
è+ (
size
), 
PAGE_SIZE
è>> 
PAGE_SHIFT
)

	)

67 
	#EMERGENCY_PAGES
 32

	)

69 #ifdeà
CONFIG_AGP


70 
	#AGPEXTERN
 

	)

72 
	#AGPEXTERN


	)

76 
AGPEXTERN
 
agp_memÜy_»£rved
;

77 
AGPEXTERN
 
__u32
 *
	gagp_g©t_bË
;

79 
	gÃxt_b™
;

80 
	gÃed_æush
;

82 
	$®loc_iommu
(
size
)

84 
off£t
, 
æags
;

86 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

87 
off£t
 = 
	`fšd_Ãxt_z”o_¡ršg
(
iommu_g¬t_b™m­
,
Ãxt_b™
,
iommu_·ges
,
size
);

88 ià(
off£t
 == -1) {

89 
Ãed_æush
 = 1;

90 
off£t
 = 
	`fšd_Ãxt_z”o_¡ršg
(
iommu_g¬t_b™m­
,0,
iommu_·ges
,
size
);

92 ià(
off£t
 != -1) {

93 
	`£t_b™_¡ršg
(
iommu_g¬t_b™m­
, 
off£t
, 
size
);

94 
Ãxt_b™
 = 
off£t
+
size
;

95 ià(
Ãxt_b™
 >ğ
iommu_·ges
) {

96 
Ãxt_b™
 = 0;

97 
Ãed_æush
 = 1;

100 ià(
iommu_fuÎæush
)

101 
Ãed_æush
 = 1;

102 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

103  
off£t
;

104 
	}
}

106 
	$ä“_iommu
(
off£t
, 
size
)

108 
æags
;

109 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

110 
	`__ş—r_b™_¡ršg
(
iommu_g¬t_b™m­
, 
off£t
, 
size
);

111 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

112 
	}
}

117 
	$æush_g¬t
()

119 
æags
;

120 
	`¥š_lock_œq§ve
(&
iommu_b™m­_lock
, 
æags
);

121 ià(
Ãed_æush
) {

122 
	`k8_æush_g¬ts
();

123 
Ãed_æush
 = 0;

125 
	`¥š_uÆock_œq»¡Üe
(&
iommu_b™m­_lock
, 
æags
);

126 
	}
}

128 #ifdeà
CONFIG_IOMMU_LEAK


130 
	#SET_LEAK
(
x
èià(
iommu_Ëak_b
) \

131 
iommu_Ëak_b
[
x
] = 
	`__butš_»tuº_add»ss
(0);

	)

132 
	#CLEAR_LEAK
(
x
èià(
iommu_Ëak_b
) \

133 
iommu_Ëak_b
[
x
] = 
NULL
;

	)

136 **
	giommu_Ëak_b
;

137 
	gËak_Œaû
;

138 
	giommu_Ëak_·ges
 = 20;

139 
	$dump_Ëak
()

141 
i
;

142 
dump
;

143 ià(
dump
 || !
iommu_Ëak_b
) ;

144 
dump
 = 1;

145 
	`show_¡ack
(
NULL
,NULL);

147 
	`´štk
("Dumpšg %d…age äomƒnd oàIOMMU:\n", 
iommu_Ëak_·ges
);

148 
i
 = 0; i < 
iommu_Ëak_·ges
; i+=2) {

149 
	`´štk
("%lu: ", 
iommu_·ges
-
i
);

150 
	`´štk_add»ss
((è
iommu_Ëak_b
[
iommu_·ges
-
i
]);

151 
	`´štk
("%c", (
i
+1)%2 == 0 ? '\n' : ' ');

153 
	`´štk
("\n");

154 
	}
}

156 
	#SET_LEAK
(
x
)

	)

157 
	#CLEAR_LEAK
(
x
)

	)

160 
	$iommu_fuÎ
(
deviû
 *
dev
, 
size_t
 
size
, 
dœ
)

172 
	`´štk
(
KERN_ERR


174 
size
, 
dev
->
bus_id
);

176 ià(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

177 ià(
dœ
 =ğ
PCI_DMA_FROMDEVICE
 || dœ =ğ
PCI_DMA_BIDIRECTIONAL
)

178 
	`·nic
("PCI-DMA: Memory would be corrupted\n");

179 ià(
dœ
 =ğ
PCI_DMA_TODEVICE
 || dœ =ğ
PCI_DMA_BIDIRECTIONAL
)

180 
	`·nic
(
KERN_ERR
 "PCI-DMA: Random memory would be DMAed\n");

183 #ifdeà
CONFIG_IOMMU_LEAK


184 
	`dump_Ëak
();

186 
	}
}

188 
šlše
 
	$Ãed_iommu
(
deviû
 *
dev
, 
addr
, 
size_t
 
size
)

190 
u64
 
mask
 = *
dev
->
dma_mask
;

191 
high
 = 
addr
 + 
size
 > 
mask
;

192 
mmu
 = 
high
;

193 ià(
fÜû_iommu
)

194 
mmu
 = 1;

195  
mmu
;

196 
	}
}

198 
šlše
 
	$nÚfÜûd_iommu
(
deviû
 *
dev
, 
addr
, 
size_t
 
size
)

200 
u64
 
mask
 = *
dev
->
dma_mask
;

201 
high
 = 
addr
 + 
size
 > 
mask
;

202 
mmu
 = 
high
;

203  
mmu
;

204 
	}
}

209 
dma_addr_t
 
	$dma_m­_¬—
(
deviû
 *
dev
, 
dma_addr_t
 
phys_mem
,

210 
size_t
 
size
, 
dœ
)

212 
Åages
 = 
	`to_·ges
(
phys_mem
, 
size
);

213 
iommu_·ge
 = 
	`®loc_iommu
(
Åages
);

214 
i
;

215 ià(
iommu_·ge
 == -1) {

216 ià(!
	`nÚfÜûd_iommu
(
dev
, 
phys_mem
, 
size
))

217  
phys_mem
;

218 ià(
·nic_Ú_ov”æow
)

219 
	`·nic
("dma_m­_¬— ov”æow %lu by‹s\n", 
size
);

220 
	`iommu_fuÎ
(
dev
, 
size
, 
dœ
);

221  
bad_dma_add»ss
;

224 
i
 = 0; i < 
Åages
; i++) {

225 
iommu_g©t_ba£
[
iommu_·ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

226 
	`SET_LEAK
(
iommu_·ge
 + 
i
);

227 
phys_mem
 +ğ
PAGE_SIZE
;

229  
iommu_bus_ba£
 + 
iommu_·ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

230 
	}
}

232 
dma_addr_t
 
	$g¬t_m­_sim¶e
(
deviû
 *
dev
, *
buf
,

233 
size_t
 
size
, 
dœ
)

235 
dma_addr_t
 
m­
 = 
	`dma_m­_¬—
(
dev
, 
	`vœt_to_bus
(
buf
), 
size
, 
dœ
);

236 
	`æush_g¬t
();

237  
m­
;

238 
	}
}

241 
dma_addr_t
 
	$g¬t_m­_sšgË
(
deviû
 *
dev
, *
addr
, 
size_t
 
size
, 
dœ
)

243 
phys_mem
, 
bus
;

245 ià(!
dev
)

246 
dev
 = &
çÎback_dev
;

248 
phys_mem
 = 
	`vœt_to_phys
(
addr
);

249 ià(!
	`Ãed_iommu
(
dev
, 
phys_mem
, 
size
))

250  
phys_mem
;

252 
bus
 = 
	`g¬t_m­_sim¶e
(
dev
, 
addr
, 
size
, 
dœ
);

253  
bus
;

254 
	}
}

259 
	$g¬t_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
,

260 
size_t
 
size
, 
dœeùiÚ
)

262 
iommu_·ge
;

263 
Åages
;

264 
i
;

266 ià(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

267 
dma_addr
 >ğ
iommu_bus_ba£
 + 
iommu_size
)

269 
iommu_·ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

270 
Åages
 = 
	`to_·ges
(
dma_addr
, 
size
);

271 
i
 = 0; i < 
Åages
; i++) {

272 
iommu_g©t_ba£
[
iommu_·ge
 + 
i
] = 
g¬t_unm­³d_’Œy
;

273 
	`CLEAR_LEAK
(
iommu_·ge
 + 
i
);

275 
	`ä“_iommu
(
iommu_·ge
, 
Åages
);

276 
	}
}

281 
	$g¬t_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
, 
dœ
)

283 
sÿ‰”li¡
 *
s
;

284 
i
;

286 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

287 ià(!
s
->
dma_Ëngth
 || !s->
Ëngth
)

289 
	`g¬t_unm­_sšgË
(
dev
, 
s
->
dma_add»ss
, s->
dma_Ëngth
, 
dœ
);

291 
	}
}

294 
	$dma_m­_sg_nÚfÜû
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
,

295 
ÃÁs
, 
dœ
)

297 
sÿ‰”li¡
 *
s
;

298 
i
;

300 #ifdeà
CONFIG_IOMMU_DEBUG


301 
	`´štk
(
KERN_DEBUG
 "dma_map_sg overflow\n");

304 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

305 
addr
 = 
	`sg_phys
(
s
);

306 ià(
	`nÚfÜûd_iommu
(
dev
, 
addr
, 
s
->
Ëngth
)) {

307 
addr
 = 
	`dma_m­_¬—
(
dev
,‡ddr, 
s
->
Ëngth
, 
dœ
);

308 ià(
addr
 =ğ
bad_dma_add»ss
) {

309 ià(
i
 > 0)

310 
	`g¬t_unm­_sg
(
dev
, 
sg
, 
i
, 
dœ
);

311 
ÃÁs
 = 0;

312 
sg
[0].
dma_Ëngth
 = 0;

316 
s
->
dma_add»ss
 = 
addr
;

317 
s
->
dma_Ëngth
 = s->
Ëngth
;

319 
	`æush_g¬t
();

320  
ÃÁs
;

321 
	}
}

324 
	$__dma_m­_cÚt
(
sÿ‰”li¡
 *
¡¬t
, 
ÃËms
,

325 
sÿ‰”li¡
 *
sout
, 
·ges
)

327 
iommu_¡¬t
 = 
	`®loc_iommu
(
·ges
);

328 
iommu_·ge
 = 
iommu_¡¬t
;

329 
sÿ‰”li¡
 *
s
;

330 
i
;

332 ià(
iommu_¡¬t
 == -1)

335 
	`fÜ_—ch_sg
(
¡¬t
, 
s
, 
ÃËms
, 
i
) {

336 
·ges
, 
addr
;

337 
phys_addr
 = 
s
->
dma_add»ss
;

339 
	`BUG_ON
(
s
 !ğ
¡¬t
 && s->
off£t
);

340 ià(
s
 =ğ
¡¬t
) {

341 
sout
->
dma_add»ss
 = 
iommu_bus_ba£
;

342 
sout
->
dma_add»ss
 +ğ
iommu_·ge
*
PAGE_SIZE
 + 
s
->
off£t
;

343 
sout
->
dma_Ëngth
 = 
s
->
Ëngth
;

345 
sout
->
dma_Ëngth
 +ğ
s
->
Ëngth
;

348 
addr
 = 
phys_addr
;

349 
·ges
 = 
	`to_·ges
(
s
->
off£t
, s->
Ëngth
);

350 
·ges
--) {

351 
iommu_g©t_ba£
[
iommu_·ge
] = 
	`GPTE_ENCODE
(
addr
);

352 
	`SET_LEAK
(
iommu_·ge
);

353 
addr
 +ğ
PAGE_SIZE
;

354 
iommu_·ge
++;

357 
	`BUG_ON
(
iommu_·ge
 - 
iommu_¡¬t
 !ğ
·ges
);

359 
	}
}

361 
šlše
 
	$dma_m­_cÚt
(
sÿ‰”li¡
 *
¡¬t
, 
ÃËms
,

362 
sÿ‰”li¡
 *
sout
,

363 
·ges
, 
Ãed
)

365 ià(!
Ãed
) {

366 
	`BUG_ON
(
ÃËms
 != 1);

367 
sout
->
dma_add»ss
 = 
¡¬t
->dma_address;

368 
sout
->
dma_Ëngth
 = 
¡¬t
->
Ëngth
;

371  
	`__dma_m­_cÚt
(
¡¬t
, 
ÃËms
, 
sout
, 
·ges
);

372 
	}
}

378 
	$g¬t_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

379 
dœ
)

381 
i
;

382 
out
;

383 
¡¬t
;

384 
·ges
 = 0;

385 
Ãed
 = 0, 
ÃxŠ“d
;

386 
sÿ‰”li¡
 *
s
, *
ps
, *
¡¬t_sg
, *
sgm­
;

388 ià(
ÃÁs
 == 0)

391 ià(!
dev
)

392 
dev
 = &
çÎback_dev
;

394 
out
 = 0;

395 
¡¬t
 = 0;

396 
¡¬t_sg
 = 
sgm­
 = 
sg
;

397 
ps
 = 
NULL
;

398 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

399 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

400 
s
->
dma_add»ss
 = 
addr
;

401 
	`BUG_ON
(
s
->
Ëngth
 == 0);

403 
ÃxŠ“d
 = 
	`Ãed_iommu
(
dev
, 
addr
, 
s
->
Ëngth
);

406 ià(
i
 > 
¡¬t
) {

409 ià(!
iommu_m”ge
 || !
ÃxŠ“d
 || !
Ãed
 || 
s
->
off£t
 ||

410 (
ps
->
off£t
 +…s->
Ëngth
è% 
PAGE_SIZE
) {

411 ià(
	`dma_m­_cÚt
(
¡¬t_sg
, 
i
 - 
¡¬t
, 
sgm­
,

412 
·ges
, 
Ãed
) < 0)

413 
”rÜ
;

414 
out
++;

415 
sgm­
 = 
	`sg_Ãxt
(sgmap);

416 
·ges
 = 0;

417 
¡¬t
 = 
i
;

418 
¡¬t_sg
 = 
s
;

422 
Ãed
 = 
ÃxŠ“d
;

423 
·ges
 +ğ
	`to_·ges
(
s
->
off£t
, s->
Ëngth
);

424 
ps
 = 
s
;

426 ià(
	`dma_m­_cÚt
(
¡¬t_sg
, 
i
 - 
¡¬t
, 
sgm­
, 
·ges
, 
Ãed
) < 0)

427 
”rÜ
;

428 
out
++;

429 
	`æush_g¬t
();

430 ià(
out
 < 
ÃÁs
) {

431 
sgm­
 = 
	`sg_Ãxt
(sgmap);

432 
sgm­
->
dma_Ëngth
 = 0;

434  
out
;

436 
”rÜ
:

437 
	`æush_g¬t
();

438 
	`g¬t_unm­_sg
(
dev
, 
sg
, 
out
, 
dœ
);

440 ià(
fÜû_iommu
 || 
iommu_m”ge
) {

441 
out
 = 
	`dma_m­_sg_nÚfÜû
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

442 ià(
out
 > 0)

443  
out
;

445 ià(
·nic_Ú_ov”æow
)

446 
	`·nic
("dma_m­_sg: ov”æow oÀ%lu…ages\n", 
·ges
);

447 
	`iommu_fuÎ
(
dev
, 
·ges
 << 
PAGE_SHIFT
, 
dœ
);

448 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
)

449 
s
->
dma_add»ss
 = 
bad_dma_add»ss
;

451 
	}
}

453 
	gno_agp
;

455 
__š™
 
	$check_iommu_size
(
­”
, 
u64
 
­”_size
)

457 
a
;

458 ià(!
iommu_size
) {

459 
iommu_size
 = 
­”_size
;

460 ià(!
no_agp
)

461 
iommu_size
 /= 2;

464 
a
 = 
­”
 + 
iommu_size
;

465 
iommu_size
 -ğ
	`round_up
(
a
, 
LARGE_PAGE_SIZE
) -‡;

467 ià(
iommu_size
 < 64*1024*1024)

468 
	`´štk
(
KERN_WARNING


469 "PCI-DMA: W¬nšg: Sm®ÈIOMMU %luMB. CÚsid” inü—sšghAGP‡³¹u» iÀBIOS\n",
iommu_size
>>20);

471  
iommu_size
;

472 
	}
}

474 
__š™
 
	$»ad_­”tu»
(
pci_dev
 *
dev
, 
u32
 *
size
)

476 
­”_size
 = 0, 
­”_ba£_32
;

477 
u64
 
­”_ba£
;

478 
­”_Üd”
;

480 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x94, &
­”_ba£_32
);

481 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x90, &
­”_Üd”
);

482 
­”_Üd”
 = (aper_order >> 1) & 7;

484 
­”_ba£
 = 
­”_ba£_32
 & 0x7fff;

485 
­”_ba£
 <<= 25;

487 
­”_size
 = (32 * 1024 * 1024è<< 
­”_Üd”
;

488 ià(
­”_ba£
 + 
­”_size
 > 0x100000000UL || !aper_size)

489 
­”_ba£
 = 0;

491 *
size
 = 
­”_size
;

492  
­”_ba£
;

493 
	}
}

499 
__š™
 
	$š™_k8_g©t
(
agp_k”n_šfo
 *
šfo
)

501 
pci_dev
 *
dev
;

502 *
g©t
;

503 
­”_ba£
, 
Ãw_­”_ba£
;

504 
­”_size
, 
g©t_size
, 
Ãw_­”_size
;

505 
i
;

507 
	`´štk
(
KERN_INFO
 "PCI-DMA: Disabling AGP.\n");

508 
­”_size
 = 
­”_ba£
 = 
šfo
->aper_size = 0;

509 
dev
 = 
NULL
;

510 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

511 
dev
 = 
k8_nÜthbridges
[
i
];

512 
Ãw_­”_ba£
 = 
	`»ad_­”tu»
(
dev
, &
Ãw_­”_size
);

513 ià(!
Ãw_­”_ba£
)

514 
nommu
;

516 ià(!
­”_ba£
) {

517 
­”_size
 = 
Ãw_­”_size
;

518 
­”_ba£
 = 
Ãw_­”_ba£
;

520 ià(
­”_size
 !ğ
Ãw_­”_size
 || 
­”_ba£
 !ğ
Ãw_­”_ba£
)

521 
nommu
;

523 ià(!
­”_ba£
)

524 
nommu
;

525 
šfo
->
­”_ba£
 =‡per_base;

526 
šfo
->
­”_size
 =‡per_size>>20;

528 
g©t_size
 = (
­”_size
 >> 
PAGE_SHIFT
è* (
u32
);

529 
g©t
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
g©t_size
));

530 ià(!
g©t
)

531 
	`·nic
("Cannot‡llocate GATTable");

532 ià(
	`chªge_·ge_©Œ_addr
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_NOCACHE
))

533 
	`·nic
("Could‚ot set GART PTEso uncacheable…ages");

534 
	`glob®_æush_b
();

536 
	`mem£t
(
g©t
, 0, 
g©t_size
);

537 
agp_g©t_bË
 = 
g©t
;

539 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

540 
u32
 
ùl
;

541 
u32
 
g©t_»g
;

543 
dev
 = 
k8_nÜthbridges
[
i
];

544 
g©t_»g
 = 
	`__·
(
g©t
) >> 12;

545 
g©t_»g
 <<= 4;

546 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x98, 
g©t_»g
);

547 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x90, &
ùl
);

549 
ùl
 |= 1;

550 
ùl
 &= ~((1<<4) | (1<<5));

552 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x90, 
ùl
);

554 
	`æush_g¬t
();

556 
	`´štk
("PCI-DMA:‡³¹u» ba£ @ %x siz%u KB\n",
­”_ba£
, 
­”_size
>>10);

559 
nommu
:

561 
	`´štk
(
KERN_ERR
 "PCI-DMA: Morehan 4GB of RAM‡nd‚o IOMMU\n"

562 
KERN_ERR
 "PCI-DMA: 32bit PCI IO may malfunction.\n");

564 
	}
}

566 
agp_amd64_š™
();

568 cÚ¡ 
dma_m­pšg_İs
 
	gg¬t_dma_İs
 = {

569 .
m­pšg_”rÜ
 = 
NULL
,

570 .
	gm­_sšgË
 = 
g¬t_m­_sšgË
,

571 .
	gm­_sim¶e
 = 
g¬t_m­_sim¶e
,

572 .
	gunm­_sšgË
 = 
g¬t_unm­_sšgË
,

573 .
	gsync_sšgË_fÜ_ıu
 = 
NULL
,

574 .
	gsync_sšgË_fÜ_deviû
 = 
NULL
,

575 .
	gsync_sšgË_¿nge_fÜ_ıu
 = 
NULL
,

576 .
	gsync_sšgË_¿nge_fÜ_deviû
 = 
NULL
,

577 .
	gsync_sg_fÜ_ıu
 = 
NULL
,

578 .
	gsync_sg_fÜ_deviû
 = 
NULL
,

579 .
	gm­_sg
 = 
g¬t_m­_sg
,

580 .
	gunm­_sg
 = 
g¬t_unm­_sg
,

583 
	$g¬t_iommu_shutdown
()

585 
pci_dev
 *
dev
;

586 
i
;

588 ià(
no_agp
 && (
dma_İs
 !ğ&
g¬t_dma_İs
))

591 
i
 = 0; i < 
num_k8_nÜthbridges
; i++) {

592 
u32
 
ùl
;

594 
dev
 = 
k8_nÜthbridges
[
i
];

595 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x90, &
ùl
);

597 
ùl
 &= ~1;

599 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x90, 
ùl
);

601 
	}
}

603 
__š™
 
	$g¬t_iommu_š™
()

605 
agp_k”n_šfo
 
šfo
;

606 
­”_size
;

607 
iommu_¡¬t
;

608 
sü©ch
;

609 
i
;

611 ià(
	`ÿche_k8_nÜthbridges
(è< 0 || 
num_k8_nÜthbridges
 == 0) {

612 
	`´štk
(
KERN_INFO
 "PCI-GART: No AMD‚orthbridge found.\n");

616 #iâdeà
CONFIG_AGP_AMD64


617 
no_agp
 = 1;

621 
no_agp
 =‚o_agp ||

622 (
	`agp_amd64_š™
() < 0) ||

623 (
	`agp_cİy_šfo
(
agp_bridge
, &
šfo
) < 0);

626 ià(
swiÙlb
)

630 ià(
iommu_d‘eùed
 && !
g¬t_iommu_­”tu»
)

633 ià(
no_iommu
 ||

634 (!
fÜû_iommu
 && 
’d_pâ
 <ğ
MAX_DMA32_PFN
) ||

635 !
g¬t_iommu_­”tu»
 ||

636 (
no_agp
 && 
	`š™_k8_g©t
(&
šfo
) < 0)) {

637 ià(
’d_pâ
 > 
MAX_DMA32_PFN
) {

638 
	`´štk
(
KERN_ERR
 "WARNING morehan 4GB of memory "

640 
KERN_ERR
 "WARNING 32bit PCI may malfunction.\n");

645 
	`´štk
(
KERN_INFO
 "PCI-DMA: using GART IOMMU.\n");

646 
­”_size
 = 
šfo
.aper_size * 1024 * 1024;

647 
iommu_size
 = 
	`check_iommu_size
(
šfo
.
­”_ba£
, 
­”_size
);

648 
iommu_·ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

650 
iommu_g¬t_b™m­
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,

651 
	`g‘_Üd”
(
iommu_·ges
/8));

652 ià(!
iommu_g¬t_b™m­
)

653 
	`·nic
("Cannot‡llocate iommu bitmap\n");

654 
	`mem£t
(
iommu_g¬t_b™m­
, 0, 
iommu_·ges
/8);

656 #ifdeà
CONFIG_IOMMU_LEAK


657 ià(
Ëak_Œaû
) {

658 
iommu_Ëak_b
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,

659 
	`g‘_Üd”
(
iommu_·ges
*(*)));

660 ià(
iommu_Ëak_b
)

661 
	`mem£t
(
iommu_Ëak_b
, 0, 
iommu_·ges
 * 8);

663 
	`´štk
("PCI-DMA: Cannot‡llocate†eakrace‡rea\n");

671 
	`£t_b™_¡ršg
(
iommu_g¬t_b™m­
, 0, 
EMERGENCY_PAGES
);

673 
agp_memÜy_»£rved
 = 
iommu_size
;

674 
	`´štk
(
KERN_INFO


676 
iommu_size
>>20);

678 
iommu_¡¬t
 = 
­”_size
 - 
iommu_size
;

679 
iommu_bus_ba£
 = 
šfo
.
­”_ba£
 + 
iommu_¡¬t
;

680 
bad_dma_add»ss
 = 
iommu_bus_ba£
;

681 
iommu_g©t_ba£
 = 
agp_g©t_bË
 + (
iommu_¡¬t
>>
PAGE_SHIFT
);

692 
	`ş—r_k”Ãl_m­pšg
(()
	`__va
(
iommu_bus_ba£
), 
iommu_size
);

700 
sü©ch
 = 
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
);

701 ià(!
sü©ch
)

702 
	`·nic
("Cannot‡llocate iommu scratch…age");

703 
g¬t_unm­³d_’Œy
 = 
	`GPTE_ENCODE
(
	`__·
(
sü©ch
));

704 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_·ges
; i++)

705 
iommu_g©t_ba£
[
i
] = 
g¬t_unm­³d_’Œy
;

707 
	`æush_g¬t
();

708 
dma_İs
 = &
g¬t_dma_İs
;

709 
	}
}

711 
__š™
 
	$g¬t_·r£_İtiÚs
(*
p
)

713 
¬g
;

715 #ifdeà
CONFIG_IOMMU_LEAK


716 ià(!
	`¡ºcmp
(
p
,"leak",4)) {

717 
Ëak_Œaû
 = 1;

718 
p
 += 4;

719 ià(*
p
 == '=') ++p;

720 ià(
	`isdig™
(*
p
è&& 
	`g‘_İtiÚ
(&p, &
¬g
))

721 
iommu_Ëak_·ges
 = 
¬g
;

724 ià(
	`isdig™
(*
p
è&& 
	`g‘_İtiÚ
(&p, &
¬g
))

725 
iommu_size
 = 
¬g
;

726 ià(!
	`¡ºcmp
(
p
, "fullflush",8))

727 
iommu_fuÎæush
 = 1;

728 ià(!
	`¡ºcmp
(
p
, "nofullflush",11))

729 
iommu_fuÎæush
 = 0;

730 ià(!
	`¡ºcmp
(
p
,"noagp",5))

731 
no_agp
 = 1;

732 ià(!
	`¡ºcmp
(
p
, "noaperture",10))

733 
fix_­”tu»
 = 0;

735 ià(!
	`¡ºcmp
(
p
,"force",5))

736 
g¬t_iommu_­”tu»_®lowed
 = 1;

737 ià(!
	`¡ºcmp
(
p
,"allowed",7))

738 
g¬t_iommu_­”tu»_®lowed
 = 1;

739 ià(!
	`¡ºcmp
(
p
, "memaper", 7)) {

740 
çÎback_­”_fÜû
 = 1;

741 
p
 += 7;

742 ià(*
p
 == '=') {

743 ++
p
;

744 ià(
	`g‘_İtiÚ
(&
p
, &
¬g
))

745 
çÎback_­”_Üd”
 = 
¬g
;

748 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu_64.c

3 
	~<lšux/mm.h
>

4 
	~<lšux/š™.h
>

5 
	~<lšux/pci.h
>

6 
	~<lšux/¡ršg.h
>

7 
	~<lšux/dma-m­pšg.h
>

8 
	~<lšux/sÿ‰”li¡.h
>

10 
	~<asm/g¬t.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/dma.h
>

15 
	$check_addr
(*
Çme
, 
deviû
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

17 ià(
hwdev
 && 
bus
 + 
size
 > *hwdev->
dma_mask
) {

18 ià(*
hwdev
->
dma_mask
 >ğ
DMA_32BIT_MASK
)

19 
	`´štk
(
KERN_ERR


21 
Çme
, ()
bus
, 
size
,

22 ()*
hwdev
->
dma_mask
);

26 
	}
}

28 
dma_addr_t


29 
	$nommu_m­_sšgË
(
deviû
 *
hwdev
, *
±r
, 
size_t
 
size
,

30 
dœeùiÚ
)

32 
dma_addr_t
 
bus
 = 
	`vœt_to_bus
(
±r
);

33 ià(!
	`check_addr
("m­_sšgË", 
hwdev
, 
bus
, 
size
))

34  
bad_dma_add»ss
;

35  
bus
;

36 
	}
}

38 
	$nommu_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
addr
,
size_t
 
size
,

39 
dœeùiÚ
)

41 
	}
}

58 
	$nommu_m­_sg
(
deviû
 *
hwdev
, 
sÿ‰”li¡
 *
sg
,

59 
ÃÁs
, 
dœeùiÚ
)

61 
sÿ‰”li¡
 *
s
;

62 
i
;

64 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

65 
	`BUG_ON
(!
	`sg_·ge
(
s
));

66 
s
->
dma_add»ss
 = 
	`vœt_to_bus
(
	`sg_vœt
(s));

67 ià(!
	`check_addr
("m­_sg", 
hwdev
, 
s
->
dma_add»ss
, s->
Ëngth
))

69 
s
->
dma_Ëngth
 = s->
Ëngth
;

71  
ÃÁs
;

72 
	}
}

78 
	$nommu_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
,

79 
ÃÁs
, 
dœ
)

81 
	}
}

83 cÚ¡ 
dma_m­pšg_İs
 
	gnommu_dma_İs
 = {

84 .
m­_sšgË
 = 
nommu_m­_sšgË
,

85 .
	gunm­_sšgË
 = 
nommu_unm­_sšgË
,

86 .
	gm­_sg
 = 
nommu_m­_sg
,

87 .
	gunm­_sg
 = 
nommu_unm­_sg
,

88 .
	gis_phys
 = 1,

91 
__š™
 
	$no_iommu_š™
()

93 ià(
dma_İs
)

96 
fÜû_iommu
 = 0;

97 
dma_İs
 = &
nommu_dma_İs
;

98 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb_64.c

3 
	~<lšux/pci.h
>

4 
	~<lšux/ÿche.h
>

5 
	~<lšux/moduË.h
>

6 
	~<lšux/dma-m­pšg.h
>

8 
	~<asm/g¬t.h
>

9 
	~<asm/swiÙlb.h
>

10 
	~<asm/dma.h
>

12 
swiÙlb
 
	g__»ad_mo¡ly
;

13 
EXPORT_SYMBOL
(
swiÙlb
);

15 cÚ¡ 
dma_m­pšg_İs
 
	gswiÙlb_dma_İs
 = {

16 .
m­pšg_”rÜ
 = 
swiÙlb_dma_m­pšg_”rÜ
,

17 .
	g®loc_coh”’t
 = 
swiÙlb_®loc_coh”’t
,

18 .
	gä“_coh”’t
 = 
swiÙlb_ä“_coh”’t
,

19 .
	gm­_sšgË
 = 
swiÙlb_m­_sšgË
,

20 .
	gunm­_sšgË
 = 
swiÙlb_unm­_sšgË
,

21 .
	gsync_sšgË_fÜ_ıu
 = 
swiÙlb_sync_sšgË_fÜ_ıu
,

22 .
	gsync_sšgË_fÜ_deviû
 = 
swiÙlb_sync_sšgË_fÜ_deviû
,

23 .
	gsync_sšgË_¿nge_fÜ_ıu
 = 
swiÙlb_sync_sšgË_¿nge_fÜ_ıu
,

24 .
	gsync_sšgË_¿nge_fÜ_deviû
 = 
swiÙlb_sync_sšgË_¿nge_fÜ_deviû
,

25 .
	gsync_sg_fÜ_ıu
 = 
swiÙlb_sync_sg_fÜ_ıu
,

26 .
	gsync_sg_fÜ_deviû
 = 
swiÙlb_sync_sg_fÜ_deviû
,

27 .
	gm­_sg
 = 
swiÙlb_m­_sg
,

28 .
	gunm­_sg
 = 
swiÙlb_unm­_sg
,

29 .
	gdma_suµÜ‹d
 = 
NULL
,

32 
__š™
 
	$pci_swiÙlb_š™
()

35 ià(!
iommu_d‘eùed
 && !
no_iommu
 && 
’d_pâ
 > 
MAX_DMA32_PFN
)

36 
swiÙlb
 = 1;

37 ià(
swiÙlb_fÜû
)

38 
swiÙlb
 = 1;

39 ià(
swiÙlb
) {

40 
	`´štk
(
KERN_INFO
 "PCI-DMA: Using software bounce buffering for IO (SWIOTLB)\n");

41 
	`swiÙlb_š™
();

42 
dma_İs
 = &
swiÙlb_dma_İs
;

44 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<lšux/¶©fÜm_deviû.h
>

2 
	~<lšux/”ºo.h
>

3 
	~<lšux/š™.h
>

5 
__š™
 
	$add_pc¥kr
()

7 
¶©fÜm_deviû
 *
pd
;

8 
»t
;

10 
pd
 = 
	`¶©fÜm_deviû_®loc
("pcspkr", -1);

11 ià(!
pd
)

12  -
ENOMEM
;

14 
»t
 = 
	`¶©fÜm_deviû_add
(
pd
);

15 ià(
»t
)

16 
	`¶©fÜm_deviû_put
(
pd
);

18  
»t
;

19 
	}
}

20 
deviû_š™ÿÎ
(
add_pc¥kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<lšux/jiff›s.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/time.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/ıumask.h
>

22 
	~<asm/io.h
>

23 
	~<asm/´Ùo.h
>

24 
	~<asm/m¤.h
>

25 
	~<asm/vsysÿÎ.h
>

27 
	#ACPI_PM_MASK
 0xFFFFFF

	)

29 
šlše
 
u32
 
	$cyc2us
(
u32
 
cyşes
)

38 
cyşes
 *= 286;

39  (
cyşes
 >> 10);

40 
	}
}

42 
	$pmtim”_wa™_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`šl
(
pmtmr_iİÜt
è& 
ACPI_PM_MASK
;

46 
a
 =ğ
b
;

47 
b
 = 
	`šl
(
pmtmr_iİÜt
è& 
ACPI_PM_MASK
)

48 
	`ıu_»Ïx
();

49  
b
;

50 
	}
}

53 
	$pmtim”_wa™
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtim”_wa™_tick
();

58 
b
 = 
	`šl
(
pmtmr_iİÜt
);

59 
	`ıu_»Ïx
();

60 } 
	`cyc2us
(
b
 - 
a
è< 
us
);

61 
	}
}

63 
__š™
 
	$nİmtim”_£tup
(*
s
)

65 
pmtmr_iİÜt
 = 0;

67 
	}
}

69 
__£tup
("nİmtim”", 
nİmtim”_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<¡d¬g.h
>

19 
	~<lšux/ıu.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/–fcÜe.h
>

26 
	~<lšux/smp.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/u£r.h
>

29 
	~<lšux/moduË.h
>

30 
	~<lšux/a.out.h
>

31 
	~<lšux/š‹¼u±.h
>

32 
	~<lšux/d–ay.h
>

33 
	~<lšux/±¿û.h
>

34 
	~<lšux/ut¢ame.h
>

35 
	~<lšux/¿ndom.h
>

36 
	~<lšux/nÙif›r.h
>

37 
	~<lšux/k´obes.h
>

38 
	~<lšux/kdebug.h
>

39 
	~<lšux/tick.h
>

41 
	~<asm/uacûss.h
>

42 
	~<asm/pgbË.h
>

43 
	~<asm/sy¡em.h
>

44 
	~<asm/io.h
>

45 
	~<asm/´oûssÜ.h
>

46 
	~<asm/i387.h
>

47 
	~<asm/mmu_cÚ‹xt.h
>

48 
	~<asm/pda.h
>

49 
	~<asm/´ùl.h
>

50 
	~<asm/desc.h
>

51 
	~<asm/´Ùo.h
>

52 
	~<asm/Ÿ32.h
>

53 
	~<asm/idË.h
>

55 
asmlškage
 
»t_äom_fÜk
();

57 
	gk”Ãl_th»ad_æags
 = 
CLONE_VM
 | 
CLONE_UNTRACED
;

59 
	gboÙ_İtiÚ_idË_ov”ride
 = 0;

60 
EXPORT_SYMBOL
(
boÙ_İtiÚ_idË_ov”ride
);

65 (*
pm_idË
)();

66 
	`EXPORT_SYMBOL
(
pm_idË
);

67 
	`DEFINE_PER_CPU
(, 
ıu_idË_¡©e
);

69 
	`ATOMIC_NOTIFIER_HEAD
(
idË_nÙif›r
);

71 
	$idË_nÙif›r_»gi¡”
(
nÙif›r_block
 *
n
)

73 
	`©omic_nÙif›r_chaš_»gi¡”
(&
idË_nÙif›r
, 
n
);

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
idË_nÙif›r_»gi¡”
);

77 
	$idË_nÙif›r_uÄegi¡”
(
nÙif›r_block
 *
n
)

79 
	`©omic_nÙif›r_chaš_uÄegi¡”
(&
idË_nÙif›r
, 
n
);

80 
	}
}

81 
EXPORT_SYMBOL
(
idË_nÙif›r_uÄegi¡”
);

83 
	$’‹r_idË
()

85 
	`wr™e_pda
(
isidË
, 1);

86 
	`©omic_nÙif›r_ÿÎ_chaš
(&
idË_nÙif›r
, 
IDLE_START
, 
NULL
);

87 
	}
}

89 
	$__ex™_idË
()

91 ià(
	`‹¡_ªd_ş—r_b™_pda
(0, 
isidË
) == 0)

93 
	`©omic_nÙif›r_ÿÎ_chaš
(&
idË_nÙif›r
, 
IDLE_END
, 
NULL
);

94 
	}
}

97 
	$ex™_idË
()

100 ià(
cu¼’t
->
pid
)

102 
	`__ex™_idË
();

103 
	}
}

109 
	$deçuÉ_idË
()

111 
	`cu¼’t_th»ad_šfo
()->
¡©us
 &ğ~
TS_POLLING
;

116 
	`smp_mb
();

117 
	`loÿl_œq_di§bË
();

118 ià(!
	`Ãed_»sched
()) {

121 
	`§ã_h®t
();

123 
	`loÿl_œq_’abË
();

124 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_POLLING
;

125 
	}
}

132 
	$pŞl_idË
 ()

134 
	`loÿl_œq_’abË
();

135 
	`ıu_»Ïx
();

136 
	}
}

138 
	$do_nÙhšg
(*
unu£d
)

140 
	}
}

142 
	$ıu_idË_wa™
()

144 
ıu
, 
this_ıu
 = 
	`g‘_ıu
();

145 
ıumask_t
 
m­
, 
tmp
 = 
cu¼’t
->
ıus_®lowed
;

147 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
this_ıu
));

148 
	`put_ıu
();

150 
	`ıus_ş—r
(
m­
);

151 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

152 
	`³r_ıu
(
ıu_idË_¡©e
, 
ıu
) = 1;

153 
	`ıu_£t
(
ıu
, 
m­
);

156 
	`__g‘_ıu_v¬
(
ıu_idË_¡©e
) = 0;

158 
	`wmb
();

160 
	`s¦“p
(1);

161 
	`fÜ_—ch_Úlše_ıu
(
ıu
) {

162 ià(
	`ıu_is£t
(
ıu
, 
m­
) &&

163 !
	`³r_ıu
(
ıu_idË_¡©e
, 
ıu
))

164 
	`ıu_ş—r
(
ıu
, 
m­
);

166 
	`ıus_ªd
(
m­
, m­, 
ıu_Úlše_m­
);

173 
	`smp_ÿÎ_funùiÚ_mask
(
m­
, 
do_nÙhšg
, 0, 0);

174 } !
	`ıus_em±y
(
m­
));

176 
	`£t_ıus_®lowed
(
cu¼’t
, 
tmp
);

177 
	}
}

178 
EXPORT_SYMBOL_GPL
(
ıu_idË_wa™
);

180 #ifdeà
CONFIG_HOTPLUG_CPU


181 
DECLARE_PER_CPU
(, 
ıu_¡©e
);

183 
	~<asm/nmi.h
>

185 
šlše
 
	$¶ay_d—d
()

187 
	`idË_sk_ex™
();

188 
	`wbšvd
();

189 
	`mb
();

191 
	`__g‘_ıu_v¬
(
ıu_¡©e
èğ
CPU_DEAD
;

193 
	`loÿl_œq_di§bË
();

195 
	`h®t
();

196 
	}
}

198 
šlše
 
	$¶ay_d—d
()

200 
	`BUG
();

201 
	}
}

210 
	$ıu_idË
 ()

212 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_POLLING
;

215 !
	`Ãed_»sched
()) {

216 (*
idË
)();

218 ià(
	`__g‘_ıu_v¬
(
ıu_idË_¡©e
))

219 
	`__g‘_ıu_v¬
(
ıu_idË_¡©e
) = 0;

221 
	`tick_nohz_¡İ_sched_tick
();

223 
	`rmb
();

224 
idË
 = 
pm_idË
;

225 ià(!
idË
)

226 
idË
 = 
deçuÉ_idË
;

227 ià(
	`ıu_is_ofæše
(
	`smp_´oûssÜ_id
()))

228 
	`¶ay_d—d
();

234 
	`loÿl_œq_di§bË
();

235 
	`’‹r_idË
();

236 
	`idË
();

240 
	`__ex™_idË
();

243 
	`tick_nohz_»¡¬t_sched_tick
();

244 
	`´“m±_’abË_no_»sched
();

245 
	`scheduË
();

246 
	`´“m±_di§bË
();

248 
	}
}

260 
	$mwa™_idË_w™h_hšts
(
—x
, 
ecx
)

262 ià(!
	`Ãed_»sched
()) {

263 
	`__mÚ™Ü
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
, 0, 0);

264 
	`smp_mb
();

265 ià(!
	`Ãed_»sched
())

266 
	`__mwa™
(
—x
, 
ecx
);

268 
	}
}

271 
	$mwa™_idË
()

273 ià(!
	`Ãed_»sched
()) {

274 
	`__mÚ™Ü
((*)&
	`cu¼’t_th»ad_šfo
()->
æags
, 0, 0);

275 
	`smp_mb
();

276 ià(!
	`Ãed_»sched
())

277 
	`__¡i_mwa™
(0, 0);

279 
	`loÿl_œq_’abË
();

281 
	`loÿl_œq_’abË
();

283 
	}
}

285 
__ıuš™
 
	$£Ëù_idË_routše
(cÚ¡ 
ıušfo_x86
 *
c
)

287 
´š‹d
;

288 ià(
	`ıu_has
(
c
, 
X86_FEATURE_MWAIT
)) {

293 ià(!
pm_idË
) {

294 ià(!
´š‹d
) {

295 
	`´štk
(
KERN_INFO
 "using mwait in idlehreads.\n");

296 
´š‹d
 = 1;

298 
pm_idË
 = 
mwa™_idË
;

301 
	}
}

303 
__š™
 
	$idË_£tup
 (*
¡r
)

305 ià(!
	`¡rcmp
(
¡r
, "poll")) {

306 
	`´štk
("using…olling idlehreads.\n");

307 
pm_idË
 = 
pŞl_idË
;

308 } ià(!
	`¡rcmp
(
¡r
, "mwait"))

309 
fÜû_mwa™
 = 1;

313 
boÙ_İtiÚ_idË_ov”ride
 = 1;

315 
	}
}

316 
—¾y_·¿m
("idË", 
idË_£tup
);

319 
	$__show_»gs
(
±_»gs
 * 
»gs
)

321 
ü0
 = 0L, 
ü2
 = 0L, 
ü3
 = 0L, 
ü4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

322 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

323 
fsšdex
,
gsšdex
;

324 
ds
,
cs
,
es
;

326 
	`´štk
("\n");

327 
	`´št_moduËs
();

328 
	`´štk
("Pid: %d, comm: %.20s %s %s %.*s\n",

329 
cu¼’t
->
pid
, cu¼’t->
comm
, 
	`´št_š‹d
(),

330 
	`š™_ut¢ame
()->
»Ëa£
,

331 ()
	`¡rc¥n
(
	`š™_ut¢ame
()->
v”siÚ
, " "),

332 
	`š™_ut¢ame
()->
v”siÚ
);

333 
	`´štk
("RIP: %04lx:[<%016lx>] ", 
»gs
->
cs
 & 0xffff,„egs->
r
);

334 
	`´štk_add»ss
(
»gs
->
r
);

335 
	`´štk
("RSP: %04lx:%016lx EFLAGS: %08lx\n", 
»gs
->
ss
,„egs->
r¥
,

336 
»gs
->
eæags
);

337 
	`´štk
("RAX: %016lx RBX: %016lx RCX: %016lx\n",

338 
»gs
->
¿x
,„egs->
rbx
,„egs->
rcx
);

339 
	`´štk
("RDX: %016lx RSI: %016lx RDI: %016lx\n",

340 
»gs
->
rdx
,„egs->
rsi
,„egs->
rdi
);

341 
	`´štk
("RBP: %016lx R08: %016lx R09: %016lx\n",

342 
»gs
->
rbp
,„egs->
r8
,„egs->
r9
);

343 
	`´štk
("R10: %016lx R11: %016lx R12: %016lx\n",

344 
»gs
->
r10
,„egs->
r11
,„egs->
r12
);

345 
	`´štk
("R13: %016lx R14: %016lx R15: %016lx\n",

346 
»gs
->
r13
,„egs->
r14
,„egs->
r15
);

348 
	`asm
("movÈ%%ds,%0" : "ô" (
ds
));

349 
	`asm
("movÈ%%cs,%0" : "ô" (
cs
));

350 
	`asm
("movÈ%%es,%0" : "ô" (
es
));

351 
	`asm
("movÈ%%fs,%0" : "ô" (
fsšdex
));

352 
	`asm
("movÈ%%gs,%0" : "ô" (
gsšdex
));

354 
	`rdm¤l
(
MSR_FS_BASE
, 
fs
);

355 
	`rdm¤l
(
MSR_GS_BASE
, 
gs
);

356 
	`rdm¤l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

358 
ü0
 = 
	`»ad_ü0
();

359 
ü2
 = 
	`»ad_ü2
();

360 
ü3
 = 
	`»ad_ü3
();

361 
ü4
 = 
	`»ad_ü4
();

363 
	`´štk
("FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

364 
fs
,
fsšdex
,
gs
,
gsšdex
,
shadowgs
);

365 
	`´štk
("CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
, 
es
, 
ü0
);

366 
	`´štk
("CR2: %016lx CR3: %016lx CR4: %016lx\n", 
ü2
, 
ü3
, 
ü4
);

368 
	`g‘_debug»g
(
d0
, 0);

369 
	`g‘_debug»g
(
d1
, 1);

370 
	`g‘_debug»g
(
d2
, 2);

371 
	`´štk
("DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

372 
	`g‘_debug»g
(
d3
, 3);

373 
	`g‘_debug»g
(
d6
, 6);

374 
	`g‘_debug»g
(
d7
, 7);

375 
	`´štk
("DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

376 
	}
}

378 
	$show_»gs
(
±_»gs
 *
»gs
)

380 
	`´štk
("CPU %d:", 
	`smp_´oûssÜ_id
());

381 
	`__show_»gs
(
»gs
);

382 
	`show_Œaû
(
NULL
, 
»gs
, (*)(regs + 1));

383 
	}
}

388 
	$ex™_th»ad
()

390 
sk_¡ruù
 *
me
 = 
cu¼’t
;

391 
th»ad_¡ruù
 *
t
 = &
me
->
th»ad
;

393 ià(
me
->
th»ad
.
io_b™m­_±r
) {

394 
tss_¡ruù
 *
tss
 = &
	`³r_ıu
(
š™_tss
, 
	`g‘_ıu
());

396 
	`kä“
(
t
->
io_b™m­_±r
);

397 
t
->
io_b™m­_±r
 = 
NULL
;

398 
	`ş—r_th»ad_æag
(
TIF_IO_BITMAP
);

402 
	`mem£t
(
tss
->
io_b™m­
, 0xff, 
t
->
io_b™m­_max
);

403 
t
->
io_b™m­_max
 = 0;

404 
	`put_ıu
();

406 
	}
}

408 
	$æush_th»ad
()

410 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

412 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_ABI_PENDING
)) {

413 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_ABI_PENDING
);

414 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
)) {

415 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
);

417 
	`£t_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
);

418 
	`cu¼’t_th»ad_šfo
()->
¡©us
 |ğ
TS_COMPAT
;

421 
	`ş—r_tsk_th»ad_æag
(
tsk
, 
TIF_DEBUG
);

423 
tsk
->
th»ad
.
debug»g0
 = 0;

424 
tsk
->
th»ad
.
debug»g1
 = 0;

425 
tsk
->
th»ad
.
debug»g2
 = 0;

426 
tsk
->
th»ad
.
debug»g3
 = 0;

427 
tsk
->
th»ad
.
debug»g6
 = 0;

428 
tsk
->
th»ad
.
debug»g7
 = 0;

429 
	`mem£t
(
tsk
->
th»ad
.
s_¬¿y
, 0, (tsk->thread.tls_array));

433 
	`ş—r_åu
(
tsk
);

434 
	`ş—r_u£d_m©h
();

435 
	}
}

437 
	$»Ëa£_th»ad
(
sk_¡ruù
 *
d—d_sk
)

439 ià(
d—d_sk
->
mm
) {

440 ià(
d—d_sk
->
mm
->
cÚ‹xt
.
size
) {

441 
	`´štk
("WARNING: dead…rocess %8s still has LDT? <%p/%d>\n",

442 
d—d_sk
->
comm
,

443 
d—d_sk
->
mm
->
cÚ‹xt
.
ldt
,

444 
d—d_sk
->
mm
->
cÚ‹xt
.
size
);

445 
	`BUG
();

448 
	}
}

450 
šlše
 
	$£t_32b™_s
(
sk_¡ruù
 *
t
, 
s
, 
u32
 
addr
)

452 
u£r_desc
 
ud
 = {

453 .
ba£_addr
 = 
addr
,

454 .
lim™
 = 0xfffff,

455 .
£g_32b™
 = 1,

456 .
lim™_š_·ges
 = 1,

457 .
u£abË
 = 1,

459 
n_desc_¡ruù
 *
desc
 = (*)
t
->
th»ad
.
s_¬¿y
;

460 
desc
 +ğ
s
;

461 
desc
->
a
 = 
	`LDT_’Œy_a
(&
ud
);

462 
desc
->
b
 = 
	`LDT_’Œy_b
(&
ud
);

463 
	}
}

465 
šlše
 
u32
 
	$»ad_32b™_s
(
sk_¡ruù
 *
t
, 
s
)

467 
desc_¡ruù
 *
desc
 = (*)
t
->
th»ad
.
s_¬¿y
;

468 
desc
 +ğ
s
;

469  
desc
->
ba£0
 |

470 (((
u32
)
desc
->
ba£1
) << 16) |

471 (((
u32
)
desc
->
ba£2
) << 24);

472 
	}
}

478 
	$´•¬e_to_cİy
(
sk_¡ruù
 *
tsk
)

480 
	`uÆazy_åu
(
tsk
);

481 
	}
}

483 
	$cİy_th»ad
(
Ä
, 
şÚe_æags
, 
r¥
,

484 
unu£d
,

485 
sk_¡ruù
 * 
p
, 
±_»gs
 * 
»gs
)

487 
”r
;

488 
±_»gs
 * 
chd»gs
;

489 
sk_¡ruù
 *
me
 = 
cu¼’t
;

491 
chd»gs
 = ((
±_»gs
 *)

492 (
THREAD_SIZE
 + 
	`sk_¡ack_·ge
(
p
))) - 1;

493 *
chd»gs
 = *
»gs
;

495 
chd»gs
->
¿x
 = 0;

496 
chd»gs
->
r¥
 =„sp;

497 ià(
r¥
 == ~0UL)

498 
chd»gs
->
r¥
 = ()childregs;

500 
p
->
th»ad
.
r¥
 = (è
chd»gs
;

501 
p
->
th»ad
.
r¥0
 = (è(
chd»gs
+1);

502 
p
->
th»ad
.
u£¼¥
 = 
me
->thread.userrsp;

504 
	`£t_tsk_th»ad_æag
(
p
, 
TIF_FORK
);

506 
p
->
th»ad
.
fs
 = 
me
->thread.fs;

507 
p
->
th»ad
.
gs
 = 
me
->thread.gs;

509 
	`asm
("mov %%gs,%0" : "=m" (
p
->
th»ad
.
gsšdex
));

510 
	`asm
("mov %%fs,%0" : "=m" (
p
->
th»ad
.
fsšdex
));

511 
	`asm
("mov %%es,%0" : "=m" (
p
->
th»ad
.
es
));

512 
	`asm
("mov %%ds,%0" : "=m" (
p
->
th»ad
.
ds
));

514 ià(
	`uÆik–y
(
	`‹¡_tsk_th»ad_æag
(
me
, 
TIF_IO_BITMAP
))) {

515 
p
->
th»ad
.
io_b™m­_±r
 = 
	`km®loc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

516 ià(!
p
->
th»ad
.
io_b™m­_±r
) {

517 
p
->
th»ad
.
io_b™m­_max
 = 0;

518  -
ENOMEM
;

520 
	`memıy
(
p
->
th»ad
.
io_b™m­_±r
, 
me
->thread.io_bitmap_ptr,

521 
IO_BITMAP_BYTES
);

522 
	`£t_tsk_th»ad_æag
(
p
, 
TIF_IO_BITMAP
);

528 ià(
şÚe_æags
 & 
CLONE_SETTLS
) {

529 #ifdeà
CONFIG_IA32_EMULATION


530 ià(
	`‹¡_th»ad_æag
(
TIF_IA32
))

531 
”r
 = 
	`Ÿ32_chd_s
(
p
, 
chd»gs
);

534 
”r
 = 
	`do_¬ch_´ùl
(
p
, 
ARCH_SET_FS
, 
chd»gs
->
r8
);

535 ià(
”r
)

536 
out
;

538 
”r
 = 0;

539 
out
:

540 ià(
”r
 && 
p
->
th»ad
.
io_b™m­_±r
) {

541 
	`kä“
(
p
->
th»ad
.
io_b™m­_±r
);

542 
p
->
th»ad
.
io_b™m­_max
 = 0;

544  
”r
;

545 
	}
}

550 
	#lßddebug
(
th»ad
,
r
è
	`£t_debug»g
Ñh»ad->
debug»g
 ##„,„)

	)

552 
šlše
 
	$__sw™ch_to_xŒa
(
sk_¡ruù
 *
´ev_p
,

553 
sk_¡ruù
 *
Ãxt_p
,

554 
tss_¡ruù
 *
tss
)

556 
th»ad_¡ruù
 *
´ev
, *
Ãxt
;

558 
´ev
 = &
´ev_p
->
th»ad
,

559 
Ãxt
 = &
Ãxt_p
->
th»ad
;

561 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_DEBUG
)) {

562 
	`lßddebug
(
Ãxt
, 0);

563 
	`lßddebug
(
Ãxt
, 1);

564 
	`lßddebug
(
Ãxt
, 2);

565 
	`lßddebug
(
Ãxt
, 3);

567 
	`lßddebug
(
Ãxt
, 6);

568 
	`lßddebug
(
Ãxt
, 7);

571 ià(
	`‹¡_tsk_th»ad_æag
(
Ãxt_p
, 
TIF_IO_BITMAP
)) {

576 
	`memıy
(
tss
->
io_b™m­
, 
Ãxt
->
io_b™m­_±r
,

577 
	`max
(
´ev
->
io_b™m­_max
, 
Ãxt
->io_bitmap_max));

578 } ià(
	`‹¡_tsk_th»ad_æag
(
´ev_p
, 
TIF_IO_BITMAP
)) {

582 
	`mem£t
(
tss
->
io_b™m­
, 0xff, 
´ev
->
io_b™m­_max
);

584 
	}
}

595 
sk_¡ruù
 *

596 
	$__sw™ch_to
(
sk_¡ruù
 *
´ev_p
, sk_¡ruù *
Ãxt_p
)

598 
th»ad_¡ruù
 *
´ev
 = &
´ev_p
->
th»ad
,

599 *
Ãxt
 = &
Ãxt_p
->
th»ad
;

600 
ıu
 = 
	`smp_´oûssÜ_id
();

601 
tss_¡ruù
 *
tss
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

604 ià(
Ãxt_p
->
åu_couÁ”
>5)

605 
	`´eãtch
(&
Ãxt
->
i387
.
fx§ve
);

610 
tss
->
r¥0
 = 
Ãxt
->rsp0;

616 
asm
 vŞ©e("mov %%es,%0" : "=m" (
´ev
->
es
));

617 ià(
	`uÆik–y
(
Ãxt
->
es
 | 
´ev
->es))

618 
	`lßd£gm’t
(
es
, 
Ãxt
->es);

620 
asm
 vŞ©("mov %%ds,%0" : "=m" (
´ev
->
ds
));

621 ià(
	`uÆik–y
(
Ãxt
->
ds
 | 
´ev
->ds))

622 
	`lßd£gm’t
(
ds
, 
Ãxt
->ds);

624 
	`lßd_TLS
(
Ãxt
, 
ıu
);

630 
fsšdex
;

631 
asm
 vŞ©e("movÈ%%fs,%0" : "ô" (
fsšdex
));

636 ià(
	`uÆik–y
(
fsšdex
 | 
Ãxt
->fsšdex | 
´ev
->
fs
)) {

637 
	`lßd£gm’t
(
fs
, 
Ãxt
->
fsšdex
);

642 ià(
fsšdex
)

643 
´ev
->
fs
 = 0;

646 ià(
Ãxt
->
fs
)

647 
	`wrm¤l
(
MSR_FS_BASE
, 
Ãxt
->
fs
);

648 
´ev
->
fsšdex
 = fsindex;

651 
gsšdex
;

652 
asm
 vŞ©e("movÈ%%gs,%0" : "ô" (
gsšdex
));

653 ià(
	`uÆik–y
(
gsšdex
 | 
Ãxt
->gsšdex | 
´ev
->
gs
)) {

654 
	`lßd_gs_šdex
(
Ãxt
->
gsšdex
);

655 ià(
gsšdex
)

656 
´ev
->
gs
 = 0;

658 ià(
Ãxt
->
gs
)

659 
	`wrm¤l
(
MSR_KERNEL_GS_BASE
, 
Ãxt
->
gs
);

660 
´ev
->
gsšdex
 = gsindex;

664 
	`uÆazy_åu
(
´ev_p
);

669 
´ev
->
u£¼¥
 = 
	`»ad_pda
(
Şdr¥
);

670 
	`wr™e_pda
(
Şdr¥
, 
Ãxt
->
u£¼¥
);

671 
	`wr™e_pda
(
pcu¼’t
, 
Ãxt_p
);

673 
	`wr™e_pda
(
k”Ãl¡ack
,

674 ()
	`sk_¡ack_·ge
(
Ãxt_p
è+ 
THREAD_SIZE
 - 
PDA_STACKOFFSET
);

675 #ifdeà
CONFIG_CC_STACKPROTECTOR


676 
	`wr™e_pda
(
¡ack_ÿÇry
, 
Ãxt_p
->stack_canary);

681 
	`BUILD_BUG_ON
(
	`off£tof
(
x8664_pda
, 
¡ack_ÿÇry
) != 40);

687 ià(
	`uÆik–y
((
	`sk_th»ad_šfo
(
Ãxt_p
)->
æags
 & 
_TIF_WORK_CTXSW
))

688 || 
	`‹¡_tsk_th»ad_æag
(
´ev_p
, 
TIF_IO_BITMAP
))

689 
	`__sw™ch_to_xŒa
(
´ev_p
, 
Ãxt_p
, 
tss
);

695 ià(
Ãxt_p
->
åu_couÁ”
>5)

696 
	`m©h_¡©e_»¡Üe
();

697  
´ev_p
;

698 
	}
}

703 
asmlškage


704 
	$sys_execve
(
__u£r
 *
Çme
, __u£¸* __u£¸*
¬gv
,

705 
__u£r
 * __u£¸*
’vp
, 
±_»gs
 
»gs
)

707 
”rÜ
;

708 * 
f’ame
;

710 
f’ame
 = 
	`g‘Çme
(
Çme
);

711 
”rÜ
 = 
	`PTR_ERR
(
f’ame
);

712 ià(
	`IS_ERR
(
f’ame
))

713  
”rÜ
;

714 
”rÜ
 = 
	`do_execve
(
f’ame
, 
¬gv
, 
’vp
, &
»gs
);

715 ià(
”rÜ
 == 0) {

716 
	`sk_lock
(
cu¼’t
);

717 
cu¼’t
->
±¿û
 &ğ~
PT_DTRACE
;

718 
	`sk_uÆock
(
cu¼’t
);

720 
	`puŠame
(
f’ame
);

721  
”rÜ
;

722 
	}
}

724 
	$£t_³rsÚ®™y_64b™
()

729 
	`ş—r_th»ad_æag
(
TIF_IA32
);

735 
cu¼’t
->
³rsÚ®™y
 &ğ~
READ_IMPLIES_EXEC
;

736 
	}
}

738 
asmlškage
 
	$sys_fÜk
(
±_»gs
 *
»gs
)

740  
	`do_fÜk
(
SIGCHLD
, 
»gs
->
r¥
,„egs, 0, 
NULL
, NULL);

741 
	}
}

743 
asmlškage
 

744 
	$sys_şÚe
(
şÚe_æags
, 
Ãw¥
,

745 
__u£r
 *
·»Á_tid
, __u£¸*
chd_tid
, 
±_»gs
 *
»gs
)

747 ià(!
Ãw¥
)

748 
Ãw¥
 = 
»gs
->
r¥
;

749  
	`do_fÜk
(
şÚe_æags
, 
Ãw¥
, 
»gs
, 0, 
·»Á_tid
, 
chd_tid
);

750 
	}
}

762 
asmlškage
 
	$sys_vfÜk
(
±_»gs
 *
»gs
)

764  
	`do_fÜk
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
»gs
->
r¥
,„egs, 0,

765 
NULL
, NULL);

766 
	}
}

768 
	$g‘_wchª
(
sk_¡ruù
 *
p
)

770 
¡ack
;

771 
u64
 
å
,
r
;

772 
couÁ
 = 0;

774 ià(!
p
 ||… =ğ
cu¼’t
 ||…->
¡©e
==
TASK_RUNNING
)

776 
¡ack
 = ()
	`sk_¡ack_·ge
(
p
);

777 ià(
p
->
th»ad
.
r¥
 < 
¡ack
 ||…->th»ad.r¥ > sck+
THREAD_SIZE
)

779 
å
 = *(
u64
 *)(
p
->
th»ad
.
r¥
);

781 ià(
å
 < ()
¡ack
 ||

782 
å
 > ()
¡ack
+
THREAD_SIZE
)

784 
r
 = *(
u64
 *)(
å
+8);

785 ià(!
	`š_sched_funùiÚs
(
r
))

786  
r
;

787 
å
 = *(
u64
 *)fp;

788 } 
couÁ
++ < 16);

790 
	}
}

792 
	$do_¬ch_´ùl
(
sk_¡ruù
 *
sk
, 
code
, 
addr
)

794 
»t
 = 0;

795 
do™
 = 
sk
 =ğ
cu¼’t
;

796 
ıu
;

798 
code
) {

799 
ARCH_SET_GS
:

800 ià(
addr
 >ğ
	`TASK_SIZE_OF
(
sk
))

801  -
EPERM
;

802 
ıu
 = 
	`g‘_ıu
();

805 ià(
addr
 <= 0xffffffff) {

806 
	`£t_32b™_s
(
sk
, 
GS_TLS
, 
addr
);

807 ià(
do™
) {

808 
	`lßd_TLS
(&
sk
->
th»ad
, 
ıu
);

809 
	`lßd_gs_šdex
(
GS_TLS_SEL
);

811 
sk
->
th»ad
.
gsšdex
 = 
GS_TLS_SEL
;

812 
sk
->
th»ad
.
gs
 = 0;

814 
sk
->
th»ad
.
gsšdex
 = 0;

815 
sk
->
th»ad
.
gs
 = 
addr
;

816 ià(
do™
) {

817 
	`lßd_gs_šdex
(0);

818 
»t
 = 
	`checkšg_wrm¤l
(
MSR_KERNEL_GS_BASE
, 
addr
);

821 
	`put_ıu
();

823 
ARCH_SET_FS
:

826 ià(
addr
 >ğ
	`TASK_SIZE_OF
(
sk
))

827  -
EPERM
;

828 
ıu
 = 
	`g‘_ıu
();

831 ià(
addr
 <= 0xffffffff) {

832 
	`£t_32b™_s
(
sk
, 
FS_TLS
, 
addr
);

833 ià(
do™
) {

834 
	`lßd_TLS
(&
sk
->
th»ad
, 
ıu
);

835 
asm
 vŞ©e("movÈ%0,%%fs" :: "r"(
FS_TLS_SEL
));

837 
sk
->
th»ad
.
fsšdex
 = 
FS_TLS_SEL
;

838 
sk
->
th»ad
.
fs
 = 0;

840 
sk
->
th»ad
.
fsšdex
 = 0;

841 
sk
->
th»ad
.
fs
 = 
addr
;

842 ià(
do™
) {

845 
asm
 volatile("movl %0,%%fs" :: "r" (0));

846 
»t
 = 
	`checkšg_wrm¤l
(
MSR_FS_BASE
, 
addr
);

849 
	`put_ıu
();

851 
ARCH_GET_FS
: {

852 
ba£
;

853 ià(
sk
->
th»ad
.
fsšdex
 =ğ
FS_TLS_SEL
)

854 
ba£
 = 
	`»ad_32b™_s
(
sk
, 
FS_TLS
);

855 ià(
do™
)

856 
	`rdm¤l
(
MSR_FS_BASE
, 
ba£
);

858 
ba£
 = 
sk
->
th»ad
.
fs
;

859 
»t
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

862 
ARCH_GET_GS
: {

863 
ba£
;

864 
gsšdex
;

865 ià(
sk
->
th»ad
.
gsšdex
 =ğ
GS_TLS_SEL
)

866 
ba£
 = 
	`»ad_32b™_s
(
sk
, 
GS_TLS
);

867 ià(
do™
) {

868 
	`asm
("movÈ%%gs,%0" : "ô" (
gsšdex
));

869 ià(
gsšdex
)

870 
	`rdm¤l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

872 
ba£
 = 
sk
->
th»ad
.
gs
;

875 
ba£
 = 
sk
->
th»ad
.
gs
;

876 
»t
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

881 
»t
 = -
EINVAL
;

885  
»t
;

886 
	}
}

888 
	$sys_¬ch_´ùl
(
code
, 
addr
)

890  
	`do_¬ch_´ùl
(
cu¼’t
, 
code
, 
addr
);

891 
	}
}

896 
	$dump_sk_»gs
(
sk_¡ruù
 *
tsk
, 
–f_g»g£t_t
 *
»gs
)

898 
±_»gs
 *
µ
, 
±»gs
;

900 
µ
 = 
	`sk_±_»gs
(
tsk
);

902 
±»gs
 = *
µ
;

903 
±»gs
.
cs
 &= 0xffff;

904 
±»gs
.
ss
 &= 0xffff;

906 
	`–f_cÜe_cİy_»gs
(
»gs
, &
±»gs
);

909 
	}
}

911 
	$¬ch_®ign_¡ack
(
¥
)

913 ià(!(
cu¼’t
->
³rsÚ®™y
 & 
ADDR_NO_RANDOMIZE
è&& 
¿ndomize_va_¥aû
)

914 
¥
 -ğ
	`g‘_¿ndom_št
() % 8192;

915  
¥
 & ~0xf;

916 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace_64.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/mm.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/”ºo.h
>

14 
	~<lšux/±¿û.h
>

15 
	~<lšux/u£r.h
>

16 
	~<lšux/£cur™y.h
>

17 
	~<lšux/aud™.h
>

18 
	~<lšux/£ccomp.h
>

19 
	~<lšux/sigÇl.h
>

21 
	~<asm/uacûss.h
>

22 
	~<asm/pgbË.h
>

23 
	~<asm/sy¡em.h
>

24 
	~<asm/´oûssÜ.h
>

25 
	~<asm/i387.h
>

26 
	~<asm/debug»g.h
>

27 
	~<asm/ldt.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/´Ùo.h
>

30 
	~<asm/Ÿ32.h
>

42 
	#FLAG_MASK
 0x54dd5UL

	)

45 
	#TRAP_FLAG
 0x100UL

	)

50 
	#EFLAGS
 
	`off£tof
(
±_»gs
, 
eæags
)

	)

51 
	#EFL_OFFSET
 (()(
EFLAGS
-(
±_»gs
)))

	)

59 
šlše
 
	$g‘_¡ack_lÚg
(
sk_¡ruù
 *
sk
, 
off£t
)

61 *
¡ack
;

63 
¡ack
 = (*)
sk
->
th»ad
.
r¥0
;

64 
¡ack
 +ğ
off£t
;

65  (*((*)
¡ack
));

66 
	}
}

74 
šlše
 
	$put_¡ack_lÚg
(
sk_¡ruù
 *
sk
, 
off£t
,

75 
d©a
)

77 * 
¡ack
;

79 
¡ack
 = (*è
sk
->
th»ad
.
r¥0
;

80 
¡ack
 +ğ
off£t
;

81 *(*è
¡ack
 = 
d©a
;

83 
	}
}

85 
	#LDT_SEGMENT
 4

	)

87 
	$cÚv”t_r_to_lš—r
(
sk_¡ruù
 *
chd
, 
±_»gs
 *
»gs
)

89 
addr
, 
£g
;

91 
addr
 = 
»gs
->
r
;

92 
£g
 = 
»gs
->
cs
 & 0xffff;

100 ià(
£g
 & 
LDT_SEGMENT
) {

101 
u32
 *
desc
;

102 
ba£
;

104 
£g
 &= ~7UL;

106 
	`mu‹x_lock
(&
chd
->
mm
->
cÚ‹xt
.
lock
);

107 ià(
	`uÆik–y
((
£g
 >> 3è>ğ
chd
->
mm
->
cÚ‹xt
.
size
))

108 
addr
 = -1L;

110 
desc
 = 
chd
->
mm
->
cÚ‹xt
.
ldt
 + 
£g
;

111 
ba£
 = ((
desc
[0] >> 16) |

112 ((
desc
[1] & 0xff) << 16) |

113 (
desc
[1] & 0xff000000));

116 ià(!((
desc
[1] >> 22) & 1))

117 
addr
 &= 0xffff;

118 
addr
 +ğ
ba£
;

120 
	`mu‹x_uÆock
(&
chd
->
mm
->
cÚ‹xt
.
lock
);

123  
addr
;

124 
	}
}

126 
	$is_£‰šg_Œ­_æag
(
sk_¡ruù
 *
chd
, 
±_»gs
 *
»gs
)

128 
i
, 
cİ›d
;

129 
İcode
[15];

130 
addr
 = 
	`cÚv”t_r_to_lš—r
(
chd
, 
»gs
);

132 
cİ›d
 = 
	`acûss_´oûss_vm
(
chd
, 
addr
, 
İcode
, (opcode), 0);

133 
i
 = 0; i < 
cİ›d
; i++) {

134 
İcode
[
i
]) {

152 ià(
»gs
->
cs
 !ğ
__USER_CS
)

173 
	}
}

175 
	$£t_sšgË¡•
(
sk_¡ruù
 *
chd
)

177 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
chd
);

184 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

189 ià(
»gs
->
eæags
 & 
TRAP_FLAG
)

193 
»gs
->
eæags
 |ğ
TRAP_FLAG
;

200 ià(
	`is_£‰šg_Œ­_æag
(
chd
, 
»gs
))

203 
chd
->
±¿û
 |ğ
PT_DTRACE
;

204 
	}
}

206 
	$ş—r_sšgË¡•
(
sk_¡ruù
 *
chd
)

209 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

212 ià(
chd
->
±¿û
 & 
PT_DTRACE
) {

213 
±_»gs
 *
»gs
 = 
	`sk_±_»gs
(
chd
);

214 
»gs
->
eæags
 &ğ~
TRAP_FLAG
;

215 
chd
->
±¿û
 &ğ~
PT_DTRACE
;

217 
	}
}

224 
	$±¿û_di§bË
(
sk_¡ruù
 *
chd
)

226 
	`ş—r_sšgË¡•
(
chd
);

227 
	}
}

229 
	$puŒeg
(
sk_¡ruù
 *
chd
,

230 
»gno
, 
v®ue
)

232 
tmp
;

234 
»gno
) {

235 
	`off£tof
(
u£r_»gs_¡ruù
,
fs
):

236 ià(
v®ue
 && (value & 3) != 3)

237  -
EIO
;

238 
chd
->
th»ad
.
fsšdex
 = 
v®ue
 & 0xffff;

240 
	`off£tof
(
u£r_»gs_¡ruù
,
gs
):

241 ià(
v®ue
 && (value & 3) != 3)

242  -
EIO
;

243 
chd
->
th»ad
.
gsšdex
 = 
v®ue
 & 0xffff;

245 
	`off£tof
(
u£r_»gs_¡ruù
,
ds
):

246 ià(
v®ue
 && (value & 3) != 3)

247  -
EIO
;

248 
chd
->
th»ad
.
ds
 = 
v®ue
 & 0xffff;

250 
	`off£tof
(
u£r_»gs_¡ruù
,
es
):

251 ià(
v®ue
 && (value & 3) != 3)

252  -
EIO
;

253 
chd
->
th»ad
.
es
 = 
v®ue
 & 0xffff;

255 
	`off£tof
(
u£r_»gs_¡ruù
,
ss
):

256 ià((
v®ue
 & 3) != 3)

257  -
EIO
;

258 
v®ue
 &= 0xffff;

260 
	`off£tof
(
u£r_»gs_¡ruù
,
fs_ba£
):

261 ià(
v®ue
 >ğ
	`TASK_SIZE_OF
(
chd
))

262  -
EIO
;

263 
chd
->
th»ad
.
fs
 = 
v®ue
;

265 
	`off£tof
(
u£r_»gs_¡ruù
,
gs_ba£
):

266 ià(
v®ue
 >ğ
	`TASK_SIZE_OF
(
chd
))

267  -
EIO
;

268 
chd
->
th»ad
.
gs
 = 
v®ue
;

270 
	`off£tof
(
u£r_»gs_¡ruù
, 
eæags
):

271 
v®ue
 &ğ
FLAG_MASK
;

272 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, 
EFL_OFFSET
);

273 
tmp
 &ğ~
FLAG_MASK
;

274 
v®ue
 |ğ
tmp
;

276 
	`off£tof
(
u£r_»gs_¡ruù
,
cs
):

277 ià((
v®ue
 & 3) != 3)

278  -
EIO
;

279 
v®ue
 &= 0xffff;

282 
	`put_¡ack_lÚg
(
chd
, 
»gno
 - (
±_»gs
), 
v®ue
);

284 
	}
}

286 
	$g‘»g
(
sk_¡ruù
 *
chd
, 
»gno
)

288 
v®
;

289 
»gno
) {

290 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs
):

291  
chd
->
th»ad
.
fsšdex
;

292 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs
):

293  
chd
->
th»ad
.
gsšdex
;

294 
	`off£tof
(
u£r_»gs_¡ruù
, 
ds
):

295  
chd
->
th»ad
.
ds
;

296 
	`off£tof
(
u£r_»gs_¡ruù
, 
es
):

297  
chd
->
th»ad
.
es
;

298 
	`off£tof
(
u£r_»gs_¡ruù
, 
fs_ba£
):

299  
chd
->
th»ad
.
fs
;

300 
	`off£tof
(
u£r_»gs_¡ruù
, 
gs_ba£
):

301  
chd
->
th»ad
.
gs
;

303 
»gno
 =„egnØ- (
±_»gs
);

304 
v®
 = 
	`g‘_¡ack_lÚg
(
chd
, 
»gno
);

305 ià(
	`‹¡_tsk_th»ad_æag
(
chd
, 
TIF_IA32
))

306 
v®
 &= 0xffffffff;

307  
v®
;

310 
	}
}

312 
	$¬ch_±¿û
(
sk_¡ruù
 *
chd
, 
»que¡
, 
addr
, 
d©a
)

314 
i
, 
»t
;

315 
ui
;

317 
»que¡
) {

319 
PTRACE_PEEKTEXT
:

320 
PTRACE_PEEKDATA
:

321 
»t
 = 
	`g’”ic_±¿û_³ekd©a
(
chd
, 
addr
, 
d©a
);

325 
PTRACE_PEEKUSR
: {

326 
tmp
;

328 
»t
 = -
EIO
;

329 ià((
addr
 & 7) ||

330 
addr
 > (
u£r
) - 7)

333 
addr
) {

334 0 ... (
u£r_»gs_¡ruù
) - ():

335 
tmp
 = 
	`g‘»g
(
chd
, 
addr
);

337 
	`off£tof
(
u£r
, 
u_debug»g
[0]):

338 
tmp
 = 
chd
->
th»ad
.
debug»g0
;

340 
	`off£tof
(
u£r
, 
u_debug»g
[1]):

341 
tmp
 = 
chd
->
th»ad
.
debug»g1
;

343 
	`off£tof
(
u£r
, 
u_debug»g
[2]):

344 
tmp
 = 
chd
->
th»ad
.
debug»g2
;

346 
	`off£tof
(
u£r
, 
u_debug»g
[3]):

347 
tmp
 = 
chd
->
th»ad
.
debug»g3
;

349 
	`off£tof
(
u£r
, 
u_debug»g
[6]):

350 
tmp
 = 
chd
->
th»ad
.
debug»g6
;

352 
	`off£tof
(
u£r
, 
u_debug»g
[7]):

353 
tmp
 = 
chd
->
th»ad
.
debug»g7
;

356 
tmp
 = 0;

359 
»t
 = 
	`put_u£r
(
tmp
,(
__u£r
 *è
d©a
);

364 
PTRACE_POKETEXT
:

365 
PTRACE_POKEDATA
:

366 
»t
 = 
	`g’”ic_±¿û_poked©a
(
chd
, 
addr
, 
d©a
);

369 
PTRACE_POKEUSR
:

371 
dsize
 = 
	`‹¡_tsk_th»ad_æag
(
chd
, 
TIF_IA32
) ? 3 : 7;

372 
»t
 = -
EIO
;

373 ià((
addr
 & 7) ||

374 
addr
 > (
u£r
) - 7)

377 
addr
) {

378 0 ... (
u£r_»gs_¡ruù
) - ():

379 
»t
 = 
	`puŒeg
(
chd
, 
addr
, 
d©a
);

382 
	`off£tof
(
u£r
, 
u_debug»g
[0]):

383 ià(
d©a
 >ğ
	`TASK_SIZE_OF
(
chd
è- 
dsize
) ;

384 
chd
->
th»ad
.
debug»g0
 = 
d©a
;

385 
»t
 = 0;

387 
	`off£tof
(
u£r
, 
u_debug»g
[1]):

388 ià(
d©a
 >ğ
	`TASK_SIZE_OF
(
chd
è- 
dsize
) ;

389 
chd
->
th»ad
.
debug»g1
 = 
d©a
;

390 
»t
 = 0;

392 
	`off£tof
(
u£r
, 
u_debug»g
[2]):

393 ià(
d©a
 >ğ
	`TASK_SIZE_OF
(
chd
è- 
dsize
) ;

394 
chd
->
th»ad
.
debug»g2
 = 
d©a
;

395 
»t
 = 0;

397 
	`off£tof
(
u£r
, 
u_debug»g
[3]):

398 ià(
d©a
 >ğ
	`TASK_SIZE_OF
(
chd
è- 
dsize
) ;

399 
chd
->
th»ad
.
debug»g3
 = 
d©a
;

400 
»t
 = 0;

402 
	`off£tof
(
u£r
, 
u_debug»g
[6]):

403 ià(
d©a
 >> 32)

405 
chd
->
th»ad
.
debug»g6
 = 
d©a
;

406 
»t
 = 0;

408 
	`off£tof
(
u£r
, 
u_debug»g
[7]):

411 
d©a
 &ğ~
DR_CONTROL_RESERVED
;

412 
i
=0; i<4; i++)

413 ià((0x5554 >> ((
d©a
 >> (16 + 4*
i
)) & 0xf)) & 1)

415 ià(
i
 == 4) {

416 
chd
->
th»ad
.
debug»g7
 = 
d©a
;

417 ià(
d©a
)

418 
	`£t_tsk_th»ad_æag
(
chd
, 
TIF_DEBUG
);

420 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_DEBUG
);

421 
»t
 = 0;

427 
PTRACE_SYSCALL
:

428 
PTRACE_CONT
:

430 
»t
 = -
EIO
;

431 ià(!
	`v®id_sigÇl
(
d©a
))

433 ià(
»que¡
 =ğ
PTRACE_SYSCALL
)

434 
	`£t_tsk_th»ad_æag
(
chd
,
TIF_SYSCALL_TRACE
);

436 
	`ş—r_tsk_th»ad_æag
(
chd
,
TIF_SYSCALL_TRACE
);

437 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

438 
chd
->
ex™_code
 = 
d©a
;

440 
	`ş—r_sšgË¡•
(
chd
);

441 
	`wake_up_´oûss
(
chd
);

442 
»t
 = 0;

445 #ifdeà
CONFIG_IA32_EMULATION


450 
PTRACE_SET_THREAD_AREA
: {

451 
u£r_desc
 
__u£r
 *
p
;

452 
Şd
;

453 
p
 = (
u£r_desc
 
__u£r
 *)
d©a
;

454 
	`g‘_u£r
(
Şd
, &
p
->
’Œy_numb”
);

455 
	`put_u£r
(
addr
, &
p
->
’Œy_numb”
);

456 
»t
 = 
	`do_£t_th»ad_¬—
(&
chd
->
th»ad
, 
p
);

457 
	`put_u£r
(
Şd
, &
p
->
’Œy_numb”
);

459 
PTRACE_GET_THREAD_AREA
:

460 
p
 = (
u£r_desc
 
__u£r
 *)
d©a
;

461 
	`g‘_u£r
(
Şd
, &
p
->
’Œy_numb”
);

462 
	`put_u£r
(
addr
, &
p
->
’Œy_numb”
);

463 
»t
 = 
	`do_g‘_th»ad_¬—
(&
chd
->
th»ad
, 
p
);

464 
	`put_u£r
(
Şd
, &
p
->
’Œy_numb”
);

471 
PTRACE_ARCH_PRCTL
:

472 
»t
 = 
	`do_¬ch_´ùl
(
chd
, 
d©a
, 
addr
);

480 
PTRACE_KILL
:

481 
»t
 = 0;

482 ià(
chd
->
ex™_¡©e
 =ğ
EXIT_ZOMBIE
)

484 
	`ş—r_tsk_th»ad_æag
(
chd
, 
TIF_SINGLESTEP
);

485 
chd
->
ex™_code
 = 
SIGKILL
;

487 
	`ş—r_sšgË¡•
(
chd
);

488 
	`wake_up_´oûss
(
chd
);

491 
PTRACE_SINGLESTEP
:

492 
»t
 = -
EIO
;

493 ià(!
	`v®id_sigÇl
(
d©a
))

495 
	`ş—r_tsk_th»ad_æag
(
chd
,
TIF_SYSCALL_TRACE
);

496 
	`£t_sšgË¡•
(
chd
);

497 
chd
->
ex™_code
 = 
d©a
;

499 
	`wake_up_´oûss
(
chd
);

500 
»t
 = 0;

503 
PTRACE_GETREGS
: {

504 ià(!
	`acûss_ok
(
VERIFY_WRITE
, (
__u£r
 *)
d©a
,

505 (
u£r_»gs_¡ruù
))) {

506 
»t
 = -
EIO
;

509 
»t
 = 0;

510 
ui
 = 0; u˜< (
u£r_»gs_¡ruù
); ui += ()) {

511 
»t
 |ğ
	`__put_u£r
(
	`g‘»g
(
chd
, 
ui
),(
__u£r
 *è
d©a
);

512 
d©a
 += ();

517 
PTRACE_SETREGS
: {

518 
tmp
;

519 ià(!
	`acûss_ok
(
VERIFY_READ
, (
__u£r
 *)
d©a
,

520 (
u£r_»gs_¡ruù
))) {

521 
»t
 = -
EIO
;

524 
»t
 = 0;

525 
ui
 = 0; u˜< (
u£r_»gs_¡ruù
); ui += ()) {

526 
»t
 = 
	`__g‘_u£r
(
tmp
, (
__u£r
 *è
d©a
);

527 ià(
»t
)

529 
»t
 = 
	`puŒeg
(
chd
, 
ui
, 
tmp
);

530 ià(
»t
)

532 
d©a
 += ();

537 
PTRACE_GETFPREGS
: {

538 ià(!
	`acûss_ok
(
VERIFY_WRITE
, (
__u£r
 *)
d©a
,

539 (
u£r_i387_¡ruù
))) {

540 
»t
 = -
EIO
;

543 
»t
 = 
	`g‘_å»gs
((
u£r_i387_¡ruù
 
__u£r
 *)
d©a
, 
chd
);

547 
PTRACE_SETFPREGS
: {

548 ià(!
	`acûss_ok
(
VERIFY_READ
, (
__u£r
 *)
d©a
,

549 (
u£r_i387_¡ruù
))) {

550 
»t
 = -
EIO
;

553 
	`£t_¡İ³d_chd_u£d_m©h
(
chd
);

554 
»t
 = 
	`£t_å»gs
(
chd
, (
u£r_i387_¡ruù
 
__u£r
 *)
d©a
);

559 
»t
 = 
	`±¿û_»que¡
(
chd
, 
»que¡
, 
addr
, 
d©a
);

562  
»t
;

563 
	}
}

565 
	$sysÿÎ_Œaû
(
±_»gs
 *
»gs
)

569 
	`´štk
("trace %s„ip %lx„sp %lx„ax %d origrax %d caller %lxiflags %x…trace %x\n",

570 
cu¼’t
->
comm
,

571 
»gs
->
r
,„egs->
r¥
,„egs->
¿x
,„egs->
Üig_¿x
, 
	`__butš_»tuº_add»ss
(0),

572 
	`cu¼’t_th»ad_šfo
()->
æags
, 
cu¼’t
->
±¿û
);

575 
	`±¿û_nÙify
(
SIGTRAP
 | ((
cu¼’t
->
±¿û
 & 
PT_TRACESYSGOOD
)

582 ià(
cu¼’t
->
ex™_code
) {

583 
	`£nd_sig
(
cu¼’t
->
ex™_code
, current, 1);

584 
cu¼’t
->
ex™_code
 = 0;

586 
	}
}

588 
asmlškage
 
	$sysÿÎ_Œaû_’‹r
(
±_»gs
 *
»gs
)

591 
	`£cu»_computšg
(
»gs
->
Üig_¿x
);

593 ià(
	`‹¡_th»ad_æag
(
TIF_SYSCALL_TRACE
)

594 && (
cu¼’t
->
±¿û
 & 
PT_PTRACED
))

595 
	`sysÿÎ_Œaû
(
»gs
);

597 ià(
	`uÆik–y
(
cu¼’t
->
aud™_cÚ‹xt
)) {

598 ià(
	`‹¡_th»ad_æag
(
TIF_IA32
)) {

599 
	`aud™_sysÿÎ_’Œy
(
AUDIT_ARCH_I386
,

600 
»gs
->
Üig_¿x
,

601 
»gs
->
rbx
,„egs->
rcx
,

602 
»gs
->
rdx
,„egs->
rsi
);

604 
	`aud™_sysÿÎ_’Œy
(
AUDIT_ARCH_X86_64
,

605 
»gs
->
Üig_¿x
,

606 
»gs
->
rdi
,„egs->
rsi
,

607 
»gs
->
rdx
,„egs->
r10
);

610 
	}
}

612 
asmlškage
 
	$sysÿÎ_Œaû_Ëave
(
±_»gs
 *
»gs
)

614 ià(
	`uÆik–y
(
cu¼’t
->
aud™_cÚ‹xt
))

615 
	`aud™_sysÿÎ_ex™
(
	`AUDITSC_RESULT
(
»gs
->
¿x
),„egs->rax);

617 ià((
	`‹¡_th»ad_æag
(
TIF_SYSCALL_TRACE
)

618 || 
	`‹¡_th»ad_æag
(
TIF_SINGLESTEP
))

619 && (
cu¼’t
->
±¿û
 & 
PT_PTRACED
))

620 
	`sysÿÎ_Œaû
(
»gs
);

621 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<lšux/pci.h
>

5 
	~<lšux/œq.h
>

7 
	~<asm/h³t.h
>

9 #ià
defšed
(
CONFIG_X86_IO_APIC
è&& defšed(
CONFIG_SMP
è&& defšed(
CONFIG_PCI
)

11 
__devš™
 
	$quœk_š‹l_œqb®ªû
(
pci_dev
 *
dev
)

13 
u8
 
cÚfig
, 
»v
;

14 
u32
 
wÜd
;

21 
	`pci_»ad_cÚfig_by‹
(
dev
, 
PCI_CLASS_REVISION
, &
»v
);

22 ià(
»v
 > 0x9)

26 
	`pci_»ad_cÚfig_by‹
(
dev
, 0xf4, &
cÚfig
);

27 
	`pci_wr™e_cÚfig_by‹
(
dev
, 0xf4, 
cÚfig
|0x2);

30 
¿w_pci_İs
->
	`»ad
(0, 0, 0x40, 0x4c, 2, &
wÜd
);

32 ià(!(
wÜd
 & (1 << 13))) {

33 
	`´štk
(
KERN_INFO
 "Intel E7520/7320/7525 detected. "

35 #ifdeà
CONFIG_IRQBALANCE


36 
	`œqb®ªû_di§bË
("");

38 
	`noœqdebug_£tup
("");

39 #ifdeà
CONFIG_PROC_FS


40 
no_œq_affš™y
 = 1;

45 ià(!(
cÚfig
 & 0x2))

46 
	`pci_wr™e_cÚfig_by‹
(
dev
, 0xf4, 
cÚfig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quœk_š‹l_œqb®ªû
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quœk_š‹l_œqb®ªû
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quœk_š‹l_œqb®ªû
);

56 #ià
defšed
(
CONFIG_HPET_TIMER
)

57 
	gfÜû_h³t_add»ss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 } 
	gfÜû_h³t_»sume_ty³
;

67 
__iomem
 *
	grcba_ba£
;

69 
	$ich_fÜû_h³t_»sume
()

71 
u32
 
v®
;

73 ià(!
fÜû_h³t_add»ss
)

76 ià(
rcba_ba£
 =ğ
NULL
)

77 
	`BUG
();

80 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

81 ià(!(
v®
 & 0x80)) {

83 
	`wr™–
(
v®
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

87 ià(!(
v®
 & 0x80))

88 
	`BUG
();

90 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

93 
	}
}

95 
	$ich_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

97 
u32
 
v®
;

98 
u32
 
	`unš™Ÿlized_v¬
(
rcba
);

99 
”r
 = 0;

101 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

104 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 ià(
rcba
 == 0) {

107 
	`´štk
(
KERN_DEBUG
 "RCBA disabled. Cannot forceƒnable HPET\n");

112 
rcba_ba£
 = 
	`iÜem­_noÿche
(
rcba
, 0x4000);

113 ià(
rcba_ba£
 =ğ
NULL
) {

114 
	`´štk
(
KERN_DEBUG
 "ioremap failed. Cannot forceƒnable HPET\n");

119 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

121 ià(
v®
 & 0x80) {

123 
v®
 = val & 0x3;

124 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

125 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t base‡ddress 0x%lx\n",

126 
fÜû_h³t_add»ss
);

127 
	`iounm­
(
rcba_ba£
);

132 
	`wr™–
(
v®
 | 0x80, 
rcba_ba£
 + 0x3404);

134 
v®
 = 
	`»adl
(
rcba_ba£
 + 0x3404);

135 ià(!(
v®
 & 0x80)) {

136 
”r
 = 1;

138 
v®
 = val & 0x3;

139 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

142 ià(
”r
) {

143 
fÜû_h³t_add»ss
 = 0;

144 
	`iounm­
(
rcba_ba£
);

145 
	`´štk
(
KERN_DEBUG
 "Failedo forceƒnable HPET\n");

147 
fÜû_h³t_»sume_ty³
 = 
ICH_FORCE_HPET_RESUME
;

148 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t base‡ddress 0x%lx\n",

149 
fÜû_h³t_add»ss
);

151 
	}
}

153 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

154 
ich_fÜû_’abË_h³t
);

155 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

156 
ich_fÜû_’abË_h³t
);

157 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

158 
ich_fÜû_’abË_h³t
);

159 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

160 
ich_fÜû_’abË_h³t
);

161 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

162 
ich_fÜû_’abË_h³t
);

163 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

164 
ich_fÜû_’abË_h³t
);

167 
pci_dev
 *
	gÿched_dev
;

169 
	$Şd_ich_fÜû_h³t_»sume
()

171 
u32
 
v®
;

172 
u32
 
	`unš™Ÿlized_v¬
(
g’_ú
);

174 ià(!
fÜû_h³t_add»ss
 || !
ÿched_dev
)

177 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, &
g’_ú
);

178 
g’_ú
 &= (~(0x7 << 15));

179 
g’_ú
 |= (0x4 << 15);

181 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, 
g’_ú
);

182 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0xD0, &
g’_ú
);

183 
v®
 = 
g’_ú
 >> 15;

184 
v®
 &= 0x7;

185 ià(
v®
 == 0x4)

186 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

188 
	`BUG
();

189 
	}
}

191 
	$Şd_ich_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

193 
u32
 
v®
;

194 
u32
 
	`unš™Ÿlized_v¬
(
g’_ú
);

196 ià(
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

199 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xD0, &
g’_ú
);

204 
v®
 = 
g’_ú
 >> 15;

205 
v®
 &= 0x7;

206 ià(
v®
 & 0x4) {

207 
v®
 &= 0x3;

208 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

209 
	`´štk
(
KERN_DEBUG
 "HPET‡t base‡ddress 0x%lx\n",

210 
fÜû_h³t_add»ss
);

218 
g’_ú
 &= (~(0x7 << 15));

219 
g’_ú
 |= (0x4 << 15);

220 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0xD0, 
g’_ú
);

222 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0xD0, &
g’_ú
);

224 
v®
 = 
g’_ú
 >> 15;

225 
v®
 &= 0x7;

226 ià(
v®
 & 0x4) {

228 
v®
 &= 0x3;

229 
fÜû_h³t_add»ss
 = 0xFED00000 | (
v®
 << 12);

230 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t base‡ddress 0x%lx\n",

231 
fÜû_h³t_add»ss
);

232 
ÿched_dev
 = 
dev
;

233 
fÜû_h³t_»sume_ty³
 = 
OLD_ICH_FORCE_HPET_RESUME
;

237 
	`´štk
(
KERN_DEBUG
 "Failedo forceƒnable HPET\n");

238 
	}
}

244 
	$Şd_ich_fÜû_’abË_h³t_u£r
(
pci_dev
 *
dev
)

246 ià(
h³t_fÜû_u£r
)

247 
	`Şd_ich_fÜû_’abË_h³t
(
dev
);

248 
	}
}

250 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

251 
Şd_ich_fÜû_’abË_h³t_u£r
);

252 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

253 
Şd_ich_fÜû_’abË_h³t_u£r
);

254 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

255 
Şd_ich_fÜû_’abË_h³t_u£r
);

256 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

257 
Şd_ich_fÜû_’abË_h³t_u£r
);

258 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

259 
Şd_ich_fÜû_’abË_h³t
);

260 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

261 
Şd_ich_fÜû_’abË_h³t
);

264 
	$vt8237_fÜû_h³t_»sume
()

266 
u32
 
v®
;

268 ià(!
fÜû_h³t_add»ss
 || !
ÿched_dev
)

271 
v®
 = 0xfed00000 | 0x80;

272 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0x68, 
v®
);

274 
	`pci_»ad_cÚfig_dwÜd
(
ÿched_dev
, 0x68, &
v®
);

275 ià(
v®
 & 0x80)

276 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

278 
	`BUG
();

279 
	}
}

281 
	$vt8237_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

283 
u32
 
	`unš™Ÿlized_v¬
(
v®
);

285 ià(!
h³t_fÜû_u£r
 || 
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

288 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x68, &
v®
);

293 ià(
v®
 & 0x80) {

294 
fÜû_h³t_add»ss
 = (
v®
 & ~0x3ff);

295 
	`´štk
(
KERN_DEBUG
 "HPET‡t base‡ddress 0x%lx\n",

296 
fÜû_h³t_add»ss
);

304 
v®
 = 0xfed00000 | 0x80;

305 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x68, 
v®
);

307 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x68, &
v®
);

308 ià(
v®
 & 0x80) {

309 
fÜû_h³t_add»ss
 = (
v®
 & ~0x3ff);

310 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t base‡ddress 0x%lx\n",

311 
fÜû_h³t_add»ss
);

312 
ÿched_dev
 = 
dev
;

313 
fÜû_h³t_»sume_ty³
 = 
VT8237_FORCE_HPET_RESUME
;

317 
	`´štk
(
KERN_DEBUG
 "Failedo forceƒnable HPET\n");

318 
	}
}

320 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

321 
vt8237_fÜû_’abË_h³t
);

322 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

323 
vt8237_fÜû_’abË_h³t
);

328 
	$nvidŸ_fÜû_h³t_»sume
()

330 
	`pci_wr™e_cÚfig_dwÜd
(
ÿched_dev
, 0x44, 0xfed00001);

331 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t„esume\n");

332 
	}
}

334 
	$nvidŸ_fÜû_’abË_h³t
(
pci_dev
 *
dev
)

336 
u32
 
	`unš™Ÿlized_v¬
(
v®
);

338 ià(!
h³t_fÜû_u£r
 || 
h³t_add»ss
 || 
fÜû_h³t_add»ss
)

341 
	`pci_wr™e_cÚfig_dwÜd
(
dev
, 0x44, 0xfed00001);

342 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 0x44, &
v®
);

343 
fÜû_h³t_add»ss
 = 
v®
 & 0xfffffffe;

344 
fÜû_h³t_»sume_ty³
 = 
NVIDIA_FORCE_HPET_RESUME
;

345 
	`´štk
(
KERN_DEBUG
 "Forceƒnabled HPET‡t base‡ddress 0x%lx\n",

346 
fÜû_h³t_add»ss
);

347 
ÿched_dev
 = 
dev
;

349 
	}
}

352 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

353 
nvidŸ_fÜû_’abË_h³t
);

354 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

355 
nvidŸ_fÜû_’abË_h³t
);

358 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

359 
nvidŸ_fÜû_’abË_h³t
);

360 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

361 
nvidŸ_fÜû_’abË_h³t
);

362 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

363 
nvidŸ_fÜû_’abË_h³t
);

364 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

365 
nvidŸ_fÜû_’abË_h³t
);

366 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

367 
nvidŸ_fÜû_’abË_h³t
);

368 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

369 
nvidŸ_fÜû_’abË_h³t
);

370 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

371 
nvidŸ_fÜû_’abË_h³t
);

372 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

373 
nvidŸ_fÜû_’abË_h³t
);

375 
	$fÜû_h³t_»sume
()

377 
fÜû_h³t_»sume_ty³
) {

378 
ICH_FORCE_HPET_RESUME
:

379  
	`ich_fÜû_h³t_»sume
();

381 
OLD_ICH_FORCE_HPET_RESUME
:

382  
	`Şd_ich_fÜû_h³t_»sume
();

384 
VT8237_FORCE_HPET_RESUME
:

385  
	`vt8237_fÜû_h³t_»sume
();

387 
NVIDIA_FORCE_HPET_RESUME
:

388  
	`nvidŸ_fÜû_h³t_»sume
();

393 
	}
}

	@/cmpt816/linux/arch/x86/kernel/reboot_64.c

2 
	~<lšux/moduË.h
>

3 
	~<lšux/»boÙ.h
>

4 
	~<lšux/š™.h
>

5 
	~<lšux/smp.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/ùy³.h
>

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/pm.h
>

10 
	~<lšux/kdebug.h
>

11 
	~<lšux/sched.h
>

12 
	~<asm/io.h
>

13 
	~<asm/d–ay.h
>

14 
	~<asm/desc.h
>

15 
	~<asm/hw_œq.h
>

16 
	~<asm/sy¡em.h
>

17 
	~<asm/pgbË.h
>

18 
	~<asm/bæush.h
>

19 
	~<asm/­ic.h
>

20 
	~<asm/h³t.h
>

21 
	~<asm/g¬t.h
>

26 (*
pm_pow”_off
)();

27 
	`EXPORT_SYMBOL
(
pm_pow”_off
);

29 
no_idt
[3];

31 
BOOT_TRIPLE
 = 't',

32 
BOOT_KBD
 = 'k'

33 } 
»boÙ_ty³
 = 
BOOT_KBD
;

34 
»boÙ_mode
 = 0;

35 
»boÙ_fÜû
;

44 
__š™
 
	$»boÙ_£tup
(*
¡r
)

47 *
¡r
) {

49 
»boÙ_mode
 = 0x1234;

53 
»boÙ_mode
 = 0;

59 
»boÙ_ty³
 = *
¡r
;

62 
»boÙ_fÜû
 = 1;

65 if((
¡r
 = 
	`¡rchr
(¡r,',')è!ğ
NULL
)

66 
¡r
++;

71 
	}
}

73 
__£tup
("»boÙ=", 
»boÙ_£tup
);

75 
šlše
 
	$kb_wa™
()

77 
i
;

79 
i
=0; i<0x10000; i++)

80 ià((
	`šb_p
(0x64) & 0x02) == 0)

82 
	}
}

84 
	$machše_shutdown
()

86 
æags
;

89 #ifdeà
CONFIG_SMP


90 
»boÙ_ıu_id
;

93 
»boÙ_ıu_id
 = 0;

96 ià(!
	`ıu_is£t
(
»boÙ_ıu_id
, 
ıu_Úlše_m­
)) {

97 
»boÙ_ıu_id
 = 
	`smp_´oûssÜ_id
();

101 
	`£t_ıus_®lowed
(
cu¼’t
, 
	`ıumask_of_ıu
(
»boÙ_ıu_id
));

106 
	`smp_£nd_¡İ
();

109 
	`loÿl_œq_§ve
(
æags
);

111 #iâdeà
CONFIG_SMP


112 
	`di§bË_loÿl_APIC
();

115 
	`di§bË_IO_APIC
();

117 #ifdeà
CONFIG_HPET_TIMER


118 
	`h³t_di§bË
();

120 
	`loÿl_œq_»¡Üe
(
æags
);

122 
	`pci_iommu_shutdown
();

123 
	}
}

125 
	$machše_em”g’cy_»¡¬t
()

127 
i
;

130 *((*)
	`__va
(0x472)èğ
»boÙ_mode
;

134 
»boÙ_ty³
) {

135 
BOOT_KBD
:

136 
i
=0; i<10; i++) {

137 
	`kb_wa™
();

138 
	`ud–ay
(50);

139 
	`outb
(0xfe,0x64);

140 
	`ud–ay
(50);

143 
BOOT_TRIPLE
:

144 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
no_idt
);

145 
__asm__
 
	`__vŞ©e__
("int3");

147 
»boÙ_ty³
 = 
BOOT_KBD
;

151 
	}
}

153 
	$machše_»¡¬t
(* 
__unu£d
)

155 
	`´štk
("machine„estart\n");

157 ià(!
»boÙ_fÜû
) {

158 
	`machše_shutdown
();

160 
	`machše_em”g’cy_»¡¬t
();

161 
	}
}

163 
	$machše_h®t
()

165 
	}
}

167 
	$machše_pow”_off
()

169 ià(
pm_pow”_off
) {

170 ià(!
»boÙ_fÜû
) {

171 
	`machše_shutdown
();

173 
	`pm_pow”_off
();

175 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup64.c

7 
	~<lšux/š™.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/¡ršg.h
>

11 
	~<lšux/boÙmem.h
>

12 
	~<lšux/b™İs.h
>

13 
	~<lšux/moduË.h
>

14 
	~<asm/pda.h
>

15 
	~<asm/pgbË.h
>

16 
	~<asm/´oûssÜ.h
>

17 
	~<asm/desc.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/mmu_cÚ‹xt.h
>

20 
	~<asm/smp.h
>

21 
	~<asm/i387.h
>

22 
	~<asm/³rıu.h
>

23 
	~<asm/´Ùo.h
>

24 
	~<asm/£ùiÚs.h
>

25 
	~<asm/£tup.h
>

27 
boÙ_·¿ms
 
__š™d©a
 
	gboÙ_·¿ms
;

29 
ıumask_t
 
ıu_š™Ÿlized
 
	g__ıuš™d©a
 = 
CPU_MASK_NONE
;

31 
x8664_pda
 *
	g_ıu_pda
[
NR_CPUS
] 
	g__»ad_mo¡ly
;

32 
EXPORT_SYMBOL
(
_ıu_pda
);

33 
x8664_pda
 
	gboÙ_ıu_pda
[
NR_CPUS
] 
	g__ÿch–še_®igÃd
;

35 
desc_±r
 
	gidt_desü
 = { 256 * 16 - 1, (è
idt_bË
 };

37 
	gboÙ_ıu_¡ack
[
IRQSTACKSIZE
] 
__©Œibu‹__
((
£ùiÚ
(".bss.page_aligned")));

39 
__suµÜ‹d_±e_mask
 
	g__»ad_mo¡ly
 = ~0UL;

40 
do_nÙ_nx
 
	g__ıuš™d©a
 = 0;

48 
__š™
 
	$nÚx_£tup
(*
¡r
)

50 ià(!
¡r
)

51  -
EINVAL
;

52 ià(!
	`¡ºcmp
(
¡r
, "on", 2)) {

53 
__suµÜ‹d_±e_mask
 |ğ
_PAGE_NX
;

54 
do_nÙ_nx
 = 0;

55 } ià(!
	`¡ºcmp
(
¡r
, "off", 3)) {

56 
do_nÙ_nx
 = 1;

57 
__suµÜ‹d_±e_mask
 &ğ~
_PAGE_NX
;

60 
	}
}

61 
—¾y_·¿m
("nÛxec", 
nÚx_£tup
);

63 
	gfÜû_³rsÚ®™y32
 = 0;

72 
__š™
 
	$nÚx32_£tup
(*
¡r
)

74 ià(!
	`¡rcmp
(
¡r
, "on"))

75 
fÜû_³rsÚ®™y32
 &ğ~
READ_IMPLIES_EXEC
;

76 ià(!
	`¡rcmp
(
¡r
, "off"))

77 
fÜû_³rsÚ®™y32
 |ğ
READ_IMPLIES_EXEC
;

79 
	}
}

80 
__£tup
("nÛxec32=", 
nÚx32_£tup
);

87 
__š™
 
	$£tup_³r_ıu_¬—s
()

89 
i
;

90 
size
;

92 #ifdeà
CONFIG_HOTPLUG_CPU


93 
	`´efl_possibË_m­
();

97 
size
 = 
PERCPU_ENOUGH_ROOM
;

99 
	`´štk
(
KERN_INFO
 "PERCPU: AÎoÿtšg %lu by‹ oà³¸ıu d©a\n", 
size
);

100 
	`fÜ_—ch_ıu_mask
 (
i
, 
ıu_possibË_m­
) {

101 *
±r
;

103 ià(!
	`NODE_DATA
(
	`ıu_to_node
(
i
))) {

104 
	`´štk
("cpu with‚o‚ode %d,‚um_online_nodes %d\n",

105 
i
, 
	`num_Úlše_nodes
());

106 
±r
 = 
	`®loc_boÙmem_·ges
(
size
);

108 
±r
 = 
	`®loc_boÙmem_·ges_node
(
	`NODE_DATA
(
	`ıu_to_node
(
i
)), 
size
);

110 ià(!
±r
)

111 
	`·nic
("CªnÙ‡Îoÿ‹ cpu d©¨fÜ CPU %d\n", 
i
);

112 
	`ıu_pda
(
i
)->
d©a_off£t
 = 
±r
 - 
__³r_ıu_¡¬t
;

113 
	`memıy
(
±r
, 
__³r_ıu_¡¬t
, 
__³r_ıu_’d
 - __per_cpu_start);

115 
	}
}

117 
	$pda_š™
(
ıu
)

119 
x8664_pda
 *
pda
 = 
	`ıu_pda
(
ıu
);

122 
asm
 volatile("movl %0,%%fs ; movl %0,%%gs" :: "r" (0));

124 
	`mb
();

125 
	`wrm¤l
(
MSR_GS_BASE
, 
pda
);

126 
	`mb
();

128 
pda
->
ıunumb”
 = 
ıu
;

129 
pda
->
œqcouÁ
 = -1;

130 
pda
->
k”Ãl¡ack
 =

131 ()
	`¡ack_th»ad_šfo
(è- 
PDA_STACKOFFSET
 + 
THREAD_SIZE
;

132 
pda
->
aùive_mm
 = &
š™_mm
;

133 
pda
->
mmu_¡©e
 = 0;

135 ià(
ıu
 == 0) {

137 
pda
->
pcu¼’t
 = &
š™_sk
;

138 
pda
->
œq¡ack±r
 = 
boÙ_ıu_¡ack
;

140 
pda
->
œq¡ack±r
 = (*)

141 
	`__g‘_ä“_·ges
(
GFP_ATOMIC
, 
IRQSTACK_ORDER
);

142 ià(!
pda
->
œq¡ack±r
)

143 
	`·nic
("ÿÂÙ‡Îoÿ‹ irq¡ack fÜ cpu %d", 
ıu
);

147 
pda
->
œq¡ack±r
 +ğ
IRQSTACKSIZE
-64;

148 
	}
}

150 
	gboÙ_exû±iÚ_¡acks
[(
N_EXCEPTION_STACKS
 - 1è* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
]

151 
__©Œibu‹__
((
£ùiÚ
(".bss.page_aligned")));

153 
asmlškage
 
ignÜe_sy¤‘
();

156 
	$sysÿÎ_š™
()

163 
	`wrm¤l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

164 
	`wrm¤l
(
MSR_LSTAR
, 
sy¡em_ÿÎ
);

165 
	`wrm¤l
(
MSR_CSTAR
, 
ignÜe_sy¤‘
);

167 #ifdeà
CONFIG_IA32_EMULATION


168 
	`sysÿÎ32_ıu_š™
 ();

172 
	`wrm¤l
(
MSR_SYSCALL_MASK
, 
EF_TF
|
EF_DF
|
EF_IE
|0x3000);

173 
	}
}

175 
__ıuš™
 
	$check_eãr
()

177 
eãr
;

179 
	`rdm¤l
(
MSR_EFER
, 
eãr
);

180 ià(!(
eãr
 & 
EFER_NX
è|| 
do_nÙ_nx
) {

181 
__suµÜ‹d_±e_mask
 &ğ~
_PAGE_NX
;

183 
	}
}

185 
	gk”Ãl_eæags
;

191 
DEFINE_PER_CPU
(
Üig_i¡
, orig_ist);

200 
__ıuš™
 
	$ıu_š™
 ()

202 
ıu
 = 
	`¡ack_smp_´oûssÜ_id
();

203 
tss_¡ruù
 *
t
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

204 
Üig_i¡
 *Üig_i¡ = &
	`³r_ıu
(Üig_i¡, 
ıu
);

205 
v
;

206 *
e¡acks
 = 
NULL
;

207 
sk_¡ruù
 *
me
;

208 
i
;

211 ià(
ıu
 != 0) {

212 
	`pda_š™
(
ıu
);

214 
e¡acks
 = 
boÙ_exû±iÚ_¡acks
;

216 
me
 = 
cu¼’t
;

218 ià(
	`ıu_‹¡_ªd_£t
(
ıu
, 
ıu_š™Ÿlized
))

219 
	`·nic
("CPU#%d‡Ì—dy in™Ÿlized!\n", 
ıu
);

221 
	`´štk
("In™Ÿlizšg CPU#%d\n", 
ıu
);

223 
	`ş—r_š_ü4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

229 ià(
ıu
)

230 
	`memıy
(
	`ıu_gdt
(
ıu
), 
ıu_gdt_bË
, 
GDT_SIZE
);

232 
ıu_gdt_desü
[
ıu
].
size
 = 
GDT_SIZE
;

233 
	`lßd_gdt
((cÚ¡ 
desc_±r
 *)&
ıu_gdt_desü
[
ıu
]);

234 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
idt_desü
);

236 
	`mem£t
(
me
->
th»ad
.
s_¬¿y
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

237 
	`sysÿÎ_š™
();

239 
	`wrm¤l
(
MSR_FS_BASE
, 0);

240 
	`wrm¤l
(
MSR_KERNEL_GS_BASE
, 0);

241 
	`b¬r›r
();

243 
	`check_eãr
();

248 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

249 cÚ¡ 
Üd”
[
N_EXCEPTION_STACKS
] = {

250 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STACK_ORDER
,

251 [
DEBUG_STACK
 - 1] = 
DEBUG_STACK_ORDER


253 ià(
ıu
) {

254 
e¡acks
 = (*)
	`__g‘_ä“_·ges
(
GFP_ATOMIC
, 
Üd”
[
v
]);

255 ià(!
e¡acks
)

256 
	`·nic
("Cannot‡llocateƒxception stack %ld %d\n",

257 
v
, 
ıu
);

259 
e¡acks
 +ğ
PAGE_SIZE
 << 
Üd”
[
v
];

260 
Üig_i¡
->
i¡
[
v
] = 
t
->i¡[v] = ()
e¡acks
;

263 
t
->
io_b™m­_ba£
 = 
	`off£tof
(
tss_¡ruù
, 
io_b™m­
);

268 
i
 = 0; i <ğ
IO_BITMAP_LONGS
; i++)

269 
t
->
io_b™m­
[
i
] = ~0UL;

271 
	`©omic_šc
(&
š™_mm
.
mm_couÁ
);

272 
me
->
aùive_mm
 = &
š™_mm
;

273 ià(
me
->
mm
)

274 
	`BUG
();

275 
	`’‹r_Ïzy_b
(&
š™_mm
, 
me
);

277 
	`£t_tss_desc
(
ıu
, 
t
);

278 
	`lßd_TR_desc
();

279 
	`lßd_LDT
(&
š™_mm
.
cÚ‹xt
);

285 
	`£t_debug»g
(0UL, 0);

286 
	`£t_debug»g
(0UL, 1);

287 
	`£t_debug»g
(0UL, 2);

288 
	`£t_debug»g
(0UL, 3);

289 
	`£t_debug»g
(0UL, 6);

290 
	`£t_debug»g
(0UL, 7);

292 
	`åu_š™
();

294 
	`¿w_loÿl_§ve_æags
(
k”Ãl_eæags
);

295 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_64.c

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/mm.h
>

13 
	~<lšux/¡ddef.h
>

14 
	~<lšux/uni¡d.h
>

15 
	~<lšux/±¿û.h
>

16 
	~<lšux/¦ab.h
>

17 
	~<lšux/u£r.h
>

18 
	~<lšux/a.out.h
>

19 
	~<lšux/sü“n_šfo.h
>

20 
	~<lšux/iİÜt.h
>

21 
	~<lšux/d–ay.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/š™rd.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/boÙmem.h
>

26 
	~<lšux/moduË.h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<lšux/cÚsŞe.h
>

29 
	~<lšux/£q_fe.h
>

30 
	~<lšux/üash_dump.h
>

31 
	~<lšux/roÙ_dev.h
>

32 
	~<lšux/pci.h
>

33 
	~<lšux/aıi.h
>

34 
	~<lšux/k®lsyms.h
>

35 
	~<lšux/edd.h
>

36 
	~<lšux/mmzÚe.h
>

37 
	~<lšux/kexec.h
>

38 
	~<lšux/ıuäeq.h
>

39 
	~<lšux/dmi.h
>

40 
	~<lšux/dma-m­pšg.h
>

41 
	~<lšux/ùy³.h
>

43 
	~<asm/mŒr.h
>

44 
	~<asm/uacûss.h
>

45 
	~<asm/sy¡em.h
>

46 
	~<asm/io.h
>

47 
	~<asm/smp.h
>

48 
	~<asm/m¤.h
>

49 
	~<asm/desc.h
>

50 
	~<video/edid.h
>

51 
	~<asm/e820.h
>

52 
	~<asm/dma.h
>

53 
	~<asm/mp¥ec.h
>

54 
	~<asm/mmu_cÚ‹xt.h
>

55 
	~<asm/´Ùo.h
>

56 
	~<asm/£tup.h
>

57 
	~<asm/mach_­ic.h
>

58 
	~<asm/numa.h
>

59 
	~<asm/£ùiÚs.h
>

60 
	~<asm/dmi.h
>

61 
	~<asm/ÿcheæush.h
>

67 
ıušfo_x86
 
boÙ_ıu_d©a
 
	g__»ad_mo¡ly
;

68 
EXPORT_SYMBOL
(
boÙ_ıu_d©a
);

70 
	gmmu_ü4_ã©u»s
;

73 
	gboÙlßd”_ty³
;

75 
	g§ved_video_mode
;

77 
fÜû_mwa™
 
	g__ıuš™d©a
;

82 
	gdmi_®loc_šdex
;

83 
	gdmi_®loc_d©a
[
DMI_MAX_DATA
];

88 
sü“n_šfo
 
	gsü“n_šfo
;

89 
EXPORT_SYMBOL
(
sü“n_šfo
);

90 
	ssys_desc_bË_¡ruù
 {

91 
	mËngth
;

92 
	mbË
[0];

95 
edid_šfo
 
	gedid_šfo
;

96 
EXPORT_SYMBOL_GPL
(
edid_šfo
);

98 
roÙ_mouÁæags
;

100 
__š™d©a
 
	gcommªd_lše
[
COMMAND_LINE_SIZE
];

102 
»sourû
 
	g¡ªd¬d_io_»sourûs
[] = {

103 { .
Çme
 = "dma1", .
	g¡¬t
 = 0x00, .
	g’d
 = 0x1f,

104 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

105 { .
	gÇme
 = "pic1", .
	g¡¬t
 = 0x20, .
	g’d
 = 0x21,

106 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

107 { .
	gÇme
 = "tim”0", .
	g¡¬t
 = 0x40, .
	g’d
 = 0x43,

108 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

109 { .
	gÇme
 = "tim”1", .
	g¡¬t
 = 0x50, .
	g’d
 = 0x53,

110 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

111 { .
	gÇme
 = "keybßrd", .
	g¡¬t
 = 0x60, .
	g’d
 = 0x6f,

112 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

113 { .
	gÇme
 = "dm¨·g»g", .
	g¡¬t
 = 0x80, .
	g’d
 = 0x8f,

114 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

115 { .
	gÇme
 = "pic2", .
	g¡¬t
 = 0xa0, .
	g’d
 = 0xa1,

116 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

117 { .
	gÇme
 = "dma2", .
	g¡¬t
 = 0xc0, .
	g’d
 = 0xdf,

118 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

119 { .
	gÇme
 = "åu", .
	g¡¬t
 = 0xf0, .
	g’d
 = 0xff,

120 .
	gæags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

123 
	#IORESOURCE_RAM
 (
IORESOURCE_BUSY
 | 
IORESOURCE_MEM
)

	)

125 
»sourû
 
	gd©a_»sourû
 = {

126 .
Çme
 = "Kernel data",

127 .
	g¡¬t
 = 0,

128 .
	g’d
 = 0,

129 .
	gæags
 = 
IORESOURCE_RAM
,

131 
»sourû
 
	gcode_»sourû
 = {

132 .
Çme
 = "Kernel code",

133 .
	g¡¬t
 = 0,

134 .
	g’d
 = 0,

135 .
	gæags
 = 
IORESOURCE_RAM
,

137 
»sourû
 
	gbss_»sourû
 = {

138 .
Çme
 = "Kernel bss",

139 .
	g¡¬t
 = 0,

140 .
	g’d
 = 0,

141 .
	gæags
 = 
IORESOURCE_RAM
,

144 #ifdeà
CONFIG_PROC_VMCORE


149 
__š™
 
	$£tup_–fcÜehdr
(*
¬g
)

151 *
’d
;

152 ià(!
¬g
)

153  -
EINVAL
;

154 
–fcÜehdr_addr
 = 
	`mem·r£
(
¬g
, &
’d
);

155  
’d
 > 
¬g
 ? 0 : -
EINVAL
;

156 
	}
}

157 
—¾y_·¿m
("–fcÜehdr", 
£tup_–fcÜehdr
);

160 #iâdeà
CONFIG_NUMA


161 
__š™


162 
	$cÚtig_š™mem_š™
(
¡¬t_pâ
, 
’d_pâ
)

164 
boÙm­_size
, 
boÙm­
;

166 
boÙm­_size
 = 
	`boÙmem_boÙm­_·ges
(
’d_pâ
)<<
PAGE_SHIFT
;

167 
boÙm­
 = 
	`fšd_e820_¬—
(0, 
’d_pâ
<<
PAGE_SHIFT
, 
boÙm­_size
);

168 ià(
boÙm­
 == -1L)

169 
	`·nic
("CªnÙ fšd boÙmem m­ oàsiz%ld\n",
boÙm­_size
);

170 
boÙm­_size
 = 
	`š™_boÙmem
(
boÙm­
 >> 
PAGE_SHIFT
, 
’d_pâ
);

171 
	`e820_»gi¡”_aùive_»giÚs
(0, 
¡¬t_pâ
, 
’d_pâ
);

172 
	`ä“_boÙmem_w™h_aùive_»giÚs
(0, 
’d_pâ
);

173 
	`»£rve_boÙmem
(
boÙm­
, 
boÙm­_size
);

174 
	}
}

177 #ià
defšed
(
CONFIG_EDD
è|| defšed(
CONFIG_EDD_MODULE
)

178 
edd
 
	gedd
;

179 #ifdeà
CONFIG_EDD_MODULE


180 
EXPORT_SYMBOL
(
edd
);

187 
šlše
 
	$cİy_edd
()

189 
	`memıy
(
edd
.
mbr_sigÇtu»
, 
boÙ_·¿ms
.
edd_mbr_sig_bufãr
,

190 (
edd
.
mbr_sigÇtu»
));

191 
	`memıy
(
edd
.
edd_šfo
, 
boÙ_·¿ms
.
eddbuf
, (edd.edd_info));

192 
edd
.
mbr_sigÇtu»_Ä
 = 
boÙ_·¿ms
.
edd_mbr_sig_buf_’Œ›s
;

193 
edd
.
edd_šfo_Ä
 = 
boÙ_·¿ms
.
eddbuf_’Œ›s
;

194 
	}
}

196 
šlše
 
	$cİy_edd
()

198 
	}
}

201 #ifdeà
CONFIG_KEXEC


202 
__š™
 
	$»£rve_üashk”Ãl
()

204 
ä“_mem
;

205 
üash_size
, 
üash_ba£
;

206 
»t
;

208 
ä“_mem
 = (()
max_low_pâ
 - 
mš_low_pâ
è<< 
PAGE_SHIFT
;

210 
»t
 = 
	`·r£_üashk”Ãl
(
boÙ_commªd_lše
, 
ä“_mem
,

211 &
üash_size
, &
üash_ba£
);

212 ià(
»t
 =ğ0 && 
üash_size
) {

213 ià(
üash_ba£
 > 0) {

214 
	`´štk
(
KERN_INFO
 "Reserving %ldMB of memory‡t %ldMB "

216 ()(
üash_size
 >> 20),

217 ()(
üash_ba£
 >> 20),

218 ()(
ä“_mem
 >> 20));

219 
üashk_»s
.
¡¬t
 = 
üash_ba£
;

220 
üashk_»s
.
’d
 = 
üash_ba£
 + 
üash_size
 - 1;

221 
	`»£rve_boÙmem
(
üash_ba£
, 
üash_size
);

223 
	`´štk
(
KERN_INFO
 "crashkernel„eservation failed - "

226 
	}
}

228 
šlše
 
__š™
 
	$»£rve_üashk”Ãl
()

229 {
	}
}

232 
	#EBDA_ADDR_POINTER
 0x40E

	)

234 
__š™d©a
 
	gebda_addr
;

235 
__š™d©a
 
	gebda_size
;

237 
	$discov”_ebda
()

243 
ebda_addr
 = *(*)
	`__va
(
EBDA_ADDR_POINTER
);

244 
ebda_addr
 <<= 4;

246 
ebda_size
 = *(*)
	`__va
(
ebda_addr
);

249 ià(
ebda_size
 == 0)

250 
ebda_size
 = 1;

251 
ebda_size
 <<= 10;

252 
ebda_size
 = 
	`round_up
Óbda_siz+ (
ebda_addr
 & ~
PAGE_MASK
), 
PAGE_SIZE
);

253 ià(
ebda_size
 > 64*1024)

254 
ebda_size
 = 64*1024;

255 
	}
}

257 
__š™
 
	$£tup_¬ch
(**
cmdlše_p
)

259 
	`´štk
(
KERN_INFO
 "Commªd†še: %s\n", 
boÙ_commªd_lše
);

261 
ROOT_DEV
 = 
	`Şd_decode_dev
(
boÙ_·¿ms
.
hdr
.
roÙ_dev
);

262 
sü“n_šfo
 = 
boÙ_·¿ms
.screen_info;

263 
edid_šfo
 = 
boÙ_·¿ms
.edid_info;

264 
§ved_video_mode
 = 
boÙ_·¿ms
.
hdr
.
vid_mode
;

265 
boÙlßd”_ty³
 = 
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
;

267 #ifdeà
CONFIG_BLK_DEV_RAM


268 
rd_image_¡¬t
 = 
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_IMAGE_START_MASK
;

269 
rd_´om±
 = ((
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

270 
rd_dŞßd
 = ((
boÙ_·¿ms
.
hdr
.
¿m_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

272 
	`£tup_memÜy_»giÚ
();

273 
	`cİy_edd
();

275 ià(!
boÙ_·¿ms
.
hdr
.
roÙ_æags
)

276 
roÙ_mouÁæags
 &ğ~
MS_RDONLY
;

277 
š™_mm
.
¡¬t_code
 = (è&
_‹xt
;

278 
š™_mm
.
’d_code
 = (è&
_‘ext
;

279 
š™_mm
.
’d_d©a
 = (è&
_ed©a
;

280 
š™_mm
.
brk
 = (è&
_’d
;

282 
code_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(&
_‹xt
);

283 
code_»sourû
.
’d
 = 
	`vœt_to_phys
(&
_‘ext
)-1;

284 
d©a_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(&
_‘ext
);

285 
d©a_»sourû
.
’d
 = 
	`vœt_to_phys
(&
_ed©a
)-1;

286 
bss_»sourû
.
¡¬t
 = 
	`vœt_to_phys
(&
__bss_¡¬t
);

287 
bss_»sourû
.
’d
 = 
	`vœt_to_phys
(&
__bss_¡İ
)-1;

289 
	`—¾y_id’tify_ıu
(&
boÙ_ıu_d©a
);

291 
	`¡¾ıy
(
commªd_lše
, 
boÙ_commªd_lše
, 
COMMAND_LINE_SIZE
);

292 *
cmdlše_p
 = 
commªd_lše
;

294 
	`·r£_—¾y_·¿m
();

296 
	`fšish_e820_·rsšg
();

298 
	`e820_»gi¡”_aùive_»giÚs
(0, 0, -1UL);

303 
’d_pâ
 = 
	`e820_’d_of_¿m
();

304 
num_phy¥ages
 = 
’d_pâ
;

306 
	`check_eãr
();

308 
	`discov”_ebda
();

310 
	`š™_memÜy_m­pšg
(0, (
’d_pâ_m­
 << 
PAGE_SHIFT
));

312 
	`dmi_sÿn_machše
();

314 #ifdeà
CONFIG_SMP


316 
x86_ıu_to_­icid_±r
 = (*)&
x86_ıu_to_­icid_š™
;

319 #ifdeà
CONFIG_ACPI


324 
	`aıi_boÙ_bË_š™
();

328 
max_low_pâ
 = 
’d_pâ
;

329 
max_pâ
 = 
’d_pâ
;

330 
high_memÜy
 = (*)
	`__va
(
’d_pâ
 * 
PAGE_SIZE
 - 1) + 1;

333 
	`»move_®l_aùive_¿nges
();

335 #ifdeà
CONFIG_ACPI_NUMA


339 
	`aıi_numa_š™
();

342 #ifdeà
CONFIG_NUMA


343 
	`numa_š™mem_š™
(0, 
’d_pâ
);

345 
	`cÚtig_š™mem_š™
(0, 
’d_pâ
);

349 
	`»£rve_boÙmem_g’”ic
(
bË_¡¬t
 << 
PAGE_SHIFT
,

350 (
bË_’d
 - 
bË_¡¬t
è<< 
PAGE_SHIFT
);

353 
	`»£rve_boÙmem_g’”ic
(
	`__·_symbŞ
(&
_‹xt
),

354 
	`__·_symbŞ
(&
_’d
è- __·_symbŞ(&
_‹xt
));

360 
	`»£rve_boÙmem_g’”ic
(0, 
PAGE_SIZE
);

363 ià(
ebda_addr
)

364 
	`»£rve_boÙmem_g’”ic
(
ebda_addr
, 
ebda_size
);

365 #ifdeà
CONFIG_NUMA


367 ià(
nodem­_addr
)

368 
	`»£rve_boÙmem_g’”ic
(
nodem­_addr
, 
nodem­_size
);

371 #ifdeà
CONFIG_SMP


373 
	`»£rve_boÙmem_g’”ic
(
SMP_TRAMPOLINE_BASE
, 2*
PAGE_SIZE
);

376 #ifdeà
CONFIG_ACPI_SLEEP


380 
	`aıi_»£rve_boÙmem
();

385 
	`fšd_smp_cÚfig
();

386 #ifdeà
CONFIG_BLK_DEV_INITRD


387 ià(
boÙ_·¿ms
.
hdr
.
ty³_of_lßd”
 && boÙ_·¿ms.hdr.
¿mdisk_image
) {

388 
¿mdisk_image
 = 
boÙ_·¿ms
.
hdr
.ramdisk_image;

389 
¿mdisk_size
 = 
boÙ_·¿ms
.
hdr
.ramdisk_size;

390 
¿mdisk_’d
 = 
¿mdisk_image
 + 
¿mdisk_size
;

391 
’d_of_mem
 = 
’d_pâ
 << 
PAGE_SHIFT
;

393 ià(
¿mdisk_’d
 <ğ
’d_of_mem
) {

394 
	`»£rve_boÙmem_g’”ic
(
¿mdisk_image
, 
¿mdisk_size
);

395 
š™rd_¡¬t
 = 
¿mdisk_image
 + 
PAGE_OFFSET
;

396 
š™rd_’d
 = 
š™rd_¡¬t
+
¿mdisk_size
;

398 
	`´štk
(
KERN_ERR
 "initrdƒxtends beyondƒnd of memory "

400 
¿mdisk_’d
, 
’d_of_mem
);

401 
š™rd_¡¬t
 = 0;

405 
	`»£rve_üashk”Ãl
();

406 
	`·gšg_š™
();

408 #ifdeà
CONFIG_PCI


409 
	`—¾y_quœks
();

417 
	`ıu_£t
(0, 
ıu_´e£Á_m­
);

418 #ifdeà
CONFIG_ACPI


422 
	`aıi_boÙ_š™
();

425 
	`š™_ıu_to_node
();

430 ià(
smp_found_cÚfig
)

431 
	`g‘_smp_cÚfig
();

432 
	`š™_­ic_m­pšgs
();

437 
	`e820_»£rve_»sourûs
();

438 
	`e820_m¬k_no§ve_»giÚs
();

441 
i
;

443 
i
 = 0; i < 
	`ARRAY_SIZE
(
¡ªd¬d_io_»sourûs
); i++)

444 
	`»que¡_»sourû
(&
iİÜt_»sourû
, &
¡ªd¬d_io_»sourûs
[
i
]);

447 
	`e820_£tup_g­
();

449 #ifdeà
CONFIG_VT


450 #ià
	`defšed
(
CONFIG_VGA_CONSOLE
)

451 
cÚsw™chp
 = &
vga_cÚ
;

452 #–ià
	`defšed
(
CONFIG_DUMMY_CONSOLE
)

453 
cÚsw™chp
 = &
dummy_cÚ
;

456 
	}
}

458 
__ıuš™
 
	$g‘_mod–_Çme
(
ıušfo_x86
 *
c
)

460 *
v
;

462 ià(
c
->
ex‹nded_ıuid_Ëv–
 < 0x80000004)

465 
v
 = (*è
c
->
x86_mod–_id
;

466 
	`ıuid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

467 
	`ıuid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

468 
	`ıuid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

469 
c
->
x86_mod–_id
[48] = 0;

471 
	}
}

474 
__ıuš™
 
	$di¥Ïy_ÿchešfo
(
ıušfo_x86
 *
c
)

476 
n
, 
dummy
, 
—x
, 
ebx
, 
ecx
, 
edx
;

478 
n
 = 
c
->
ex‹nded_ıuid_Ëv–
;

480 ià(
n
 >= 0x80000005) {

481 
	`ıuid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

482 
	`´štk
(
KERN_INFO
 "CPU: L1 I Cache: %dK (%d bytes/line), D cache %dK (%d bytes/line)\n",

483 
edx
>>24,ƒdx&0xFF, 
ecx
>>24,ƒcx&0xFF);

484 
c
->
x86_ÿche_size
=(
ecx
>>24)+(
edx
>>24);

486 
c
->
x86_bsize
 = 0;

489 ià(
n
 >= 0x80000006) {

490 
	`ıuid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

491 
ecx
 = 
	`ıuid_ecx
(0x80000006);

492 
c
->
x86_ÿche_size
 = 
ecx
 >> 16;

493 
c
->
x86_bsize
 +ğ((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

495 
	`´štk
(
KERN_INFO
 "CPU: L2 Cache: %dK (%d bytes/line)\n",

496 
c
->
x86_ÿche_size
, 
ecx
 & 0xFF);

499 ià(
n
 >= 0x80000007)

500 
	`ıuid
(0x80000007, &
dummy
, &dummy, &dummy, &
c
->
x86_pow”
);

501 ià(
n
 >= 0x80000008) {

502 
	`ıuid
(0x80000008, &
—x
, &
dummy
, &dummy, &dummy);

503 
c
->
x86_vœt_b™s
 = (
—x
 >> 8) & 0xff;

504 
c
->
x86_phys_b™s
 = 
—x
 & 0xff;

506 
	}
}

508 #ifdeà
CONFIG_NUMA


509 
	$Ã¬by_node
(
­icid
)

511 
i
;

512 
i
 = 
­icid
 - 1; i >= 0; i--) {

513 
node
 = 
­icid_to_node
[
i
];

514 ià(
node
 !ğ
NUMA_NO_NODE
 && 
	`node_Úlše
(node))

515  
node
;

517 
i
 = 
­icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

518 
node
 = 
­icid_to_node
[
i
];

519 ià(
node
 !ğ
NUMA_NO_NODE
 && 
	`node_Úlše
(node))

520  
node
;

522  
	`fœ¡_node
(
node_Úlše_m­
);

523 
	}
}

530 
__š™
 
	$amd_d‘eù_cmp
(
ıušfo_x86
 *
c
)

532 #ifdeà
CONFIG_SMP


533 
b™s
;

534 #ifdeà
CONFIG_NUMA


535 
ıu
 = 
	`smp_´oûssÜ_id
();

536 
node
 = 0;

537 
­icid
 = 
	`h¬d_smp_´oûssÜ_id
();

539 
ecx
 = 
	`ıuid_ecx
(0x80000008);

541 
c
->
x86_max_cÜes
 = (
ecx
 & 0xff) + 1;

544 
b™s
 = (
ecx
 >> 12) & 0xF;

547 ià(
b™s
 == 0) {

548 (1 << 
b™s
è< 
c
->
x86_max_cÜes
)

549 
b™s
++;

553 
c
->
ıu_cÜe_id
 = c->
phys_´oc_id
 & ((1 << 
b™s
)-1);

555 
c
->
phys_´oc_id
 = 
	`phys_pkg_id
(
b™s
);

557 #ifdeà
CONFIG_NUMA


558 
node
 = 
c
->
phys_´oc_id
;

559 ià(
­icid_to_node
[
­icid
] !ğ
NUMA_NO_NODE
)

560 
node
 = 
­icid_to_node
[
­icid
];

561 ià(!
	`node_Úlše
(
node
)) {

571 
ht_nodeid
 = 
­icid
 - (
	`ıu_d©a
(0).
phys_´oc_id
 << 
b™s
);

572 ià(
ht_nodeid
 >= 0 &&

573 
­icid_to_node
[
ht_nodeid
] !ğ
NUMA_NO_NODE
)

574 
node
 = 
­icid_to_node
[
ht_nodeid
];

576 ià(!
	`node_Úlše
(
node
))

577 
node
 = 
	`Ã¬by_node
(
­icid
);

579 
	`numa_£t_node
(
ıu
, 
node
);

581 
	`´štk
(
KERN_INFO
 "CPU %d/%x -> Nod%d\n", 
ıu
, 
­icid
, 
node
);

584 
	}
}

586 
	#ENABLE_C1E_MASK
 0x18000000

	)

587 
	#CPUID_PROCESSOR_SIGNATURE
 1

	)

588 
	#CPUID_XFAM
 0x0ff00000

	)

589 
	#CPUID_XFAM_K8
 0x00000000

	)

590 
	#CPUID_XFAM_10H
 0x00100000

	)

591 
	#CPUID_XFAM_11H
 0x00200000

	)

592 
	#CPUID_XMOD
 0x000f0000

	)

593 
	#CPUID_XMOD_REV_F
 0x00040000

	)

596 
__ıuš™
 
	$amd_­ic_tim”_brok’
()

598 
u32
 
lo
, 
hi
;

599 
u32
 
—x
 = 
	`ıuid_—x
(
CPUID_PROCESSOR_SIGNATURE
);

600 
—x
 & 
CPUID_XFAM
) {

601 
CPUID_XFAM_K8
:

602 ià((
—x
 & 
CPUID_XMOD
è< 
CPUID_XMOD_REV_F
)

604 
CPUID_XFAM_10H
:

605 
CPUID_XFAM_11H
:

606 
	`rdm¤
(
MSR_K8_ENABLE_C1E
, 
lo
, 
hi
);

607 ià(
lo
 & 
ENABLE_C1E_MASK
)

615 
	}
}

617 
__ıuš™
 
	$š™_amd
(
ıušfo_x86
 *
c
)

619 
Ëv–
;

621 #ifdeà
CONFIG_SMP


622 
v®ue
;

631 ià(
c
->
x86
 == 15) {

632 
	`rdm¤l
(
MSR_K8_HWCR
, 
v®ue
);

633 
v®ue
 |= 1 << 6;

634 
	`wrm¤l
(
MSR_K8_HWCR
, 
v®ue
);

640 
	`ş—r_b™
(0*32+31, &
c
->
x86_ÿ·b™y
);

643 
Ëv–
 = 
	`ıuid_—x
(1);

644 ià(
c
->
x86
 =ğ15 && ((
Ëv–
 >= 0x0f48 &&†evel < 0x0f50) ||†evel >= 0x0f58))

645 
	`£t_b™
(
X86_FEATURE_REP_GOOD
, &
c
->
x86_ÿ·b™y
);

646 ià(
c
->
x86
 == 0x10 || c->x86 == 0x11)

647 
	`£t_b™
(
X86_FEATURE_REP_GOOD
, &
c
->
x86_ÿ·b™y
);

650 ià(
c
->
x86
 >= 6)

651 
	`£t_b™
(
X86_FEATURE_FXSAVE_LEAK
, &
c
->
x86_ÿ·b™y
);

653 
Ëv–
 = 
	`g‘_mod–_Çme
(
c
);

654 ià(!
Ëv–
) {

655 
c
->
x86
) {

659 
	`¡rıy
(
c
->
x86_mod–_id
, "Hammer");

663 
	`di¥Ïy_ÿchešfo
(
c
);

666 ià(
c
->
x86_pow”
 & (1<<8))

667 
	`£t_b™
(
X86_FEATURE_CONSTANT_TSC
, &
c
->
x86_ÿ·b™y
);

670 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000008)

671 
	`amd_d‘eù_cmp
(
c
);

673 ià(
c
->
ex‹nded_ıuid_Ëv–
 >= 0x80000006 &&

674 (
	`ıuid_edx
(0x80000006) & 0xf000))

675 
num_ÿche_Ëaves
 = 4;

677 
num_ÿche_Ëaves
 = 3;

679 ià(
c
->
x86
 == 0xf || c->x86 == 0x10 || c->x86 == 0x11)

680 
	`£t_b™
(
X86_FEATURE_K8
, &
c
->
x86_ÿ·b™y
);

683 
	`ş—r_b™
(
X86_FEATURE_SYNC_RDTSC
, &
c
->
x86_ÿ·b™y
);

686 ià(
c
->
x86
 =ğ0x10 && !
fÜû_mwa™
)

687 
	`ş—r_b™
(
X86_FEATURE_MWAIT
, &
c
->
x86_ÿ·b™y
);

689 ià(
	`amd_­ic_tim”_brok’
())

690 
di§bË_­ic_tim”
 = 1;

691 
	}
}

693 
__ıuš™
 
	$d‘eù_ht
(
ıušfo_x86
 *
c
)

695 #ifdeà
CONFIG_SMP


696 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

697 
šdex_msb
, 
cÜe_b™s
;

699 
	`ıuid
(1, &
—x
, &
ebx
, &
ecx
, &
edx
);

702 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_HT
))

704 ià(
	`ıu_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

705 
out
;

707 
smp_num_siblšgs
 = (
ebx
 & 0xff0000) >> 16;

709 ià(
smp_num_siblšgs
 == 1) {

710 
	`´štk
(
KERN_INFO
 "CPU: Hyper-Threading is disabled\n");

711 } ià(
smp_num_siblšgs
 > 1 ) {

713 ià(
smp_num_siblšgs
 > 
NR_CPUS
) {

714 
	`´štk
(
KERN_WARNING
 "CPU: UnsuµÜ‹d‚umb” oàthsiblšg %d", 
smp_num_siblšgs
);

715 
smp_num_siblšgs
 = 1;

719 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
smp_num_siblšgs
);

720 
c
->
phys_´oc_id
 = 
	`phys_pkg_id
(
šdex_msb
);

722 
smp_num_siblšgs
 = smp_num_siblšg / 
c
->
x86_max_cÜes
;

724 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
smp_num_siblšgs
) ;

726 
cÜe_b™s
 = 
	`g‘_couÁ_Üd”
(
c
->
x86_max_cÜes
);

728 
c
->
ıu_cÜe_id
 = 
	`phys_pkg_id
(
šdex_msb
) &

729 ((1 << 
cÜe_b™s
) - 1);

731 
out
:

732 ià((
c
->
x86_max_cÜes
 * 
smp_num_siblšgs
) > 1) {

733 
	`´štk
(
KERN_INFO
 "CPU: PhysiÿÈProûssÜ ID: %d\n", 
c
->
phys_´oc_id
);

734 
	`´štk
(
KERN_INFO
 "CPU: ProûssÜ CÜID: %d\n", 
c
->
ıu_cÜe_id
);

738 
	}
}

743 
__ıuš™
 
	$š‹l_num_ıu_cÜes
(
ıušfo_x86
 *
c
)

745 
—x
, 
t
;

747 ià(
c
->
ıuid_Ëv–
 < 4)

750 
	`ıuid_couÁ
(4, 0, &
—x
, &
t
, &t, &t);

752 ià(
—x
 & 0x1f)

753  ((
—x
 >> 26) + 1);

756 
	}
}

758 
	$¤©_d‘eù_node
()

760 #ifdeà
CONFIG_NUMA


761 
node
;

762 
ıu
 = 
	`smp_´oûssÜ_id
();

763 
­icid
 = 
	`h¬d_smp_´oûssÜ_id
();

767 
node
 = 
­icid_to_node
[
­icid
];

768 ià(
node
 =ğ
NUMA_NO_NODE
)

769 
node
 = 
	`fœ¡_node
(
node_Úlše_m­
);

770 
	`numa_£t_node
(
ıu
, 
node
);

772 
	`´štk
(
KERN_INFO
 "CPU %d/%x -> Nod%d\n", 
ıu
, 
­icid
, 
node
);

774 
	}
}

776 
__ıuš™
 
	$š™_š‹l
(
ıušfo_x86
 *
c
)

779 
n
;

781 
	`š™_š‹l_ÿchešfo
(
c
);

782 ià(
c
->
ıuid_Ëv–
 > 9 ) {

783 
—x
 = 
	`ıuid_—x
(10);

785 ià((
—x
 & 0xff) && (((eax>>8) & 0xff) > 1))

786 
	`£t_b™
(
X86_FEATURE_ARCH_PERFMON
, &
c
->
x86_ÿ·b™y
);

789 ià(
ıu_has_ds
) {

790 
l1
, 
l2
;

791 
	`rdm¤
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

792 ià(!(
l1
 & (1<<11)))

793 
	`£t_b™
(
X86_FEATURE_BTS
, 
c
->
x86_ÿ·b™y
);

794 ià(!(
l1
 & (1<<12)))

795 
	`£t_b™
(
X86_FEATURE_PEBS
, 
c
->
x86_ÿ·b™y
);

798 
n
 = 
c
->
ex‹nded_ıuid_Ëv–
;

799 ià(
n
 >= 0x80000008) {

800 
—x
 = 
	`ıuid_—x
(0x80000008);

801 
c
->
x86_vœt_b™s
 = (
—x
 >> 8) & 0xff;

802 
c
->
x86_phys_b™s
 = 
—x
 & 0xff;

804 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

805 
c
->
x86
 =ğ0xF && c->
x86_mod–
 == 0x3 &&

806 
c
->
x86_mask
 == 0x4)

807 
c
->
x86_phys_b™s
 = 36;

810 ià(
c
->
x86
 == 15)

811 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
 * 2;

812 ià((
c
->
x86
 =ğ0xà&& c->
x86_mod–
 >= 0x03) ||

813 (
c
->
x86
 =ğ0x6 && c->
x86_mod–
 >= 0x0e))

814 
	`£t_b™
(
X86_FEATURE_CONSTANT_TSC
, &
c
->
x86_ÿ·b™y
);

815 ià(
c
->
x86
 == 6)

816 
	`£t_b™
(
X86_FEATURE_REP_GOOD
, &
c
->
x86_ÿ·b™y
);

817 ià(
c
->
x86
 == 15)

818 
	`£t_b™
(
X86_FEATURE_SYNC_RDTSC
, &
c
->
x86_ÿ·b™y
);

820 
	`ş—r_b™
(
X86_FEATURE_SYNC_RDTSC
, &
c
->
x86_ÿ·b™y
);

821 
c
->
x86_max_cÜes
 = 
	`š‹l_num_ıu_cÜes
(c);

823 
	`¤©_d‘eù_node
();

824 
	}
}

826 
__ıuš™
 
	$g‘_ıu_v’dÜ
(
ıušfo_x86
 *
c
)

828 *
v
 = 
c
->
x86_v’dÜ_id
;

830 ià(!
	`¡rcmp
(
v
, "AuthenticAMD"))

831 
c
->
x86_v’dÜ
 = 
X86_VENDOR_AMD
;

832 ià(!
	`¡rcmp
(
v
, "GenuineIntel"))

833 
c
->
x86_v’dÜ
 = 
X86_VENDOR_INTEL
;

835 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

836 
	}
}

838 
	sıu_mod–_šfo
 {

839 
	mv’dÜ
;

840 
	mçmy
;

841 *
	mmod–_Çmes
[16];

847 
__ıuš™
 
	$—¾y_id’tify_ıu
(
ıušfo_x86
 *
c
)

849 
u32
 
tfms
;

851 
c
->
loİs_³r_jiffy
 =†oops_per_jiffy;

852 
c
->
x86_ÿche_size
 = -1;

853 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

854 
c
->
x86_mod–
 = c->
x86_mask
 = 0;

855 
c
->
x86_v’dÜ_id
[0] = '\0';

856 
c
->
x86_mod–_id
[0] = '\0';

857 
c
->
x86_şæush_size
 = 64;

858 
c
->
x86_ÿche_®ignm’t
 = c->
x86_şæush_size
;

859 
c
->
x86_max_cÜes
 = 1;

860 
c
->
ex‹nded_ıuid_Ëv–
 = 0;

861 
	`mem£t
(&
c
->
x86_ÿ·b™y
, 0,  c->x86_capability);

864 
	`ıuid
(0x00000000, (*)&
c
->
ıuid_Ëv–
,

865 (*)&
c
->
x86_v’dÜ_id
[0],

866 (*)&
c
->
x86_v’dÜ_id
[8],

867 (*)&
c
->
x86_v’dÜ_id
[4]);

869 
	`g‘_ıu_v’dÜ
(
c
);

875 ià(
c
->
ıuid_Ëv–
 >= 0x00000001) {

876 
__u32
 
misc
;

877 
	`ıuid
(0x00000001, &
tfms
, &
misc
, &
c
->
x86_ÿ·b™y
[4],

878 &
c
->
x86_ÿ·b™y
[0]);

879 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

880 
c
->
x86_mod–
 = (
tfms
 >> 4) & 0xf;

881 
c
->
x86_mask
 = 
tfms
 & 0xf;

882 ià(
c
->
x86
 == 0xf)

883 
c
->
x86
 +ğ(
tfms
 >> 20) & 0xff;

884 ià(
c
->
x86
 >= 0x6)

885 
c
->
x86_mod–
 +ğ((
tfms
 >> 16) & 0xF) << 4;

886 ià(
c
->
x86_ÿ·b™y
[0] & (1<<19))

887 
c
->
x86_şæush_size
 = ((
misc
 >> 8) & 0xff) * 8;

890 
c
->
x86
 = 4;

893 #ifdeà
CONFIG_SMP


894 
c
->
phys_´oc_id
 = (
	`ıuid_ebx
(1) >> 24) & 0xff;

896 
	}
}

901 
__ıuš™
 
	$id’tify_ıu
(
ıušfo_x86
 *
c
)

903 
i
;

904 
u32
 
xlvl
;

906 
	`—¾y_id’tify_ıu
(
c
);

909 
xlvl
 = 
	`ıuid_—x
(0x80000000);

910 
c
->
ex‹nded_ıuid_Ëv–
 = 
xlvl
;

911 ià((
xlvl
 & 0xffff0000) == 0x80000000) {

912 ià(
xlvl
 >= 0x80000001) {

913 
c
->
x86_ÿ·b™y
[1] = 
	`ıuid_edx
(0x80000001);

914 
c
->
x86_ÿ·b™y
[6] = 
	`ıuid_ecx
(0x80000001);

916 ià(
xlvl
 >= 0x80000004)

917 
	`g‘_mod–_Çme
(
c
);

921 
xlvl
 = 
	`ıuid_—x
(0x80860000);

922 ià((
xlvl
 & 0xffff0000) == 0x80860000) {

924 ià(
xlvl
 >= 0x80860001)

925 
c
->
x86_ÿ·b™y
[2] = 
	`ıuid_edx
(0x80860001);

928 
	`š™_sÿ‰”ed_ıuid_ã©u»s
(
c
);

930 
c
->
­icid
 = 
	`phys_pkg_id
(0);

942 
c
->
x86_v’dÜ
) {

943 
X86_VENDOR_AMD
:

944 
	`š™_amd
(
c
);

947 
X86_VENDOR_INTEL
:

948 
	`š™_š‹l
(
c
);

951 
X86_VENDOR_UNKNOWN
:

953 
	`di¥Ïy_ÿchešfo
(
c
);

957 
	`£Ëù_idË_routše
(
c
);

958 
	`d‘eù_ht
(
c
);

966 ià(
c
 !ğ&
boÙ_ıu_d©a
) {

968 
i
 = 0 ; i < 
NCAPINTS
 ; i++)

969 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[
i
] &ğ
c
->x86_capability[i];

972 #ifdeà
CONFIG_X86_MCE


973 
	`mcheck_š™
(
c
);

975 ià(
c
 !ğ&
boÙ_ıu_d©a
)

976 
	`mŒr_­_š™
();

977 #ifdeà
CONFIG_NUMA


978 
	`numa_add_ıu
(
	`smp_´oûssÜ_id
());

980 
	}
}

983 
__ıuš™
 
	$´št_ıu_šfo
(
ıušfo_x86
 *
c
)

985 ià(
c
->
x86_mod–_id
[0])

986 
	`´štk
("%s", 
c
->
x86_mod–_id
);

988 ià(
c
->
x86_mask
 || c->
ıuid_Ëv–
 >= 0)

989 
	`´štk
(" s‹µšg %02x\n", 
c
->
x86_mask
);

991 
	`´štk
("\n");

992 
	}
}

998 
	$show_ıušfo
(
£q_fe
 *
m
, *
v
)

1000 
ıušfo_x86
 *
c
 = 
v
;

1001 
ıu
 = 0;

1011 cÚ¡ *cÚ¡ 
x86_ÿp_æags
[] = {

1014 "cx8", "­ic", 
NULL
, "sep", "mtrr", "pge", "mca", "cmov",

1015 "·t", "p£36", "²", "şæush", 
NULL
, "dts", "acpi", "mmx",

1019 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1020 
NULL
, NULL, NULL, "syscall", NULL, NULL, NULL, NULL,

1021 
NULL
, NULL, NULL, NULL, "nx", NULL, "mmxext", NULL,

1022 
NULL
, "fxsr_opt", "pdpe1gb", "rdtscp", NULL, "lm",

1026 "»cov”y", "lÚgrun", 
NULL
, "lrti", NULL, NULL, NULL, NULL,

1027 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1028 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1029 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1033 
NULL
, NULL, NULL, NULL,

1034 "cÚ¡ªt_tsc", "up", 
NULL
, "arch_perfmon",

1035 "³bs", "bts", 
NULL
, "sync_rdtsc",

1036 "»p_good", 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL,

1037 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1040 "²i", 
NULL
, NULL, "monitor", "ds_cpl", "vmx", "smx", "est",

1041 "tm2", "ss£3", "cid", 
NULL
, NULL, "cx16", "xtpr", NULL,

1042 
NULL
, NULL, "dca", "sse4_1", "sse4_2", NULL, NULL, "popcnt",

1043 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1046 
NULL
, NULL, "rng", "rng_en", NULL, NULL, "ace", "ace_en",

1047 "aû2", "aû2_’", "phe", "phe_’", "pmm", "pmm_’", 
NULL
, NULL,

1048 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1049 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1055 "skš™", "wdt", 
NULL
, NULL,

1056 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1057 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1060 "ida", 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL,

1061 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1062 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1063 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

1065 cÚ¡ *cÚ¡ 
x86_pow”_æags
[] = {

1079 #ifdeà
CONFIG_SMP


1080 
ıu
 = 
c
->
ıu_šdex
;

1083 
	`£q_´štf
(
m
,"processor\t: %u\n"

1088 ()
ıu
,

1089 
c
->
x86_v’dÜ_id
[0] ? c->x86_vendor_id : "unknown",

1090 
c
->
x86
,

1091 ()
c
->
x86_mod–
,

1092 
c
->
x86_mod–_id
[0] ? c->x86_model_id : "unknown");

1094 ià(
c
->
x86_mask
 || c->
ıuid_Ëv–
 >= 0)

1095 
	`£q_´štf
(
m
, "¡•pšg\t: %d\n", 
c
->
x86_mask
);

1097 
	`£q_´štf
(
m
, "stepping\t: unknown\n");

1099 ià(
	`ıu_has
(
c
,
X86_FEATURE_TSC
)) {

1100 
äeq
 = 
	`ıuäeq_quick_g‘
(()
ıu
);

1101 ià(!
äeq
)

1102 
äeq
 = 
ıu_khz
;

1103 
	`£q_´štf
(
m
, "cpu MHz\t\t: %u.%03u\n",

1104 
äeq
 / 1000, (freq % 1000));

1108 ià(
c
->
x86_ÿche_size
 >= 0)

1109 
	`£q_´štf
(
m
, "ÿchsize\t: %d KB\n", 
c
->
x86_ÿche_size
);

1111 #ifdeà
CONFIG_SMP


1112 ià(
smp_num_siblšgs
 * 
c
->
x86_max_cÜes
 > 1) {

1113 
	`£q_´štf
(
m
, "physiÿÈid\t: %d\n", 
c
->
phys_´oc_id
);

1114 
	`£q_´štf
(
m
, "siblings\t: %d\n",

1115 
	`ıus_weight
(
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
)));

1116 
	`£q_´štf
(
m
, "cÜid\t\t: %d\n", 
c
->
ıu_cÜe_id
);

1117 
	`£q_´štf
(
m
, "ıu cÜes\t: %d\n", 
c
->
boÙed_cÜes
);

1121 
	`£q_´štf
(
m
,

1127 
c
->
ıuid_Ëv–
);

1130 
i
;

1131  
i
 = 0 ; i < 32*
NCAPINTS
 ; i++ )

1132 ià(
	`ıu_has
(
c
, 
i
è&& 
x86_ÿp_æags
[i] !ğ
NULL
)

1133 
	`£q_´štf
(
m
, " %s", 
x86_ÿp_æags
[
i
]);

1136 
	`£q_´štf
(
m
, "\nbogomips\t: %lu.%02lu\n",

1137 
c
->
loİs_³r_jiffy
/(500000/
HZ
),

1138 (
c
->
loİs_³r_jiffy
/(5000/
HZ
)) % 100);

1140 ià(
c
->
x86_bsize
 > 0)

1141 
	`£q_´štf
(
m
, "TLB size\t: %d 4K…ages\n", 
c
->
x86_bsize
);

1142 
	`£q_´štf
(
m
, "şæush size\t: %d\n", 
c
->
x86_şæush_size
);

1143 
	`£q_´štf
(
m
, "ÿche_®ignm’t\t: %d\n", 
c
->
x86_ÿche_®ignm’t
);

1145 
	`£q_´štf
(
m
, "address sizes\t: %u bits…hysical, %u bits virtual\n",

1146 
c
->
x86_phys_b™s
, c->
x86_vœt_b™s
);

1148 
	`£q_´štf
(
m
, "power management:");

1150 
i
;

1151 
i
 = 0; i < 32; i++)

1152 ià(
c
->
x86_pow”
 & (1 << 
i
)) {

1153 ià(
i
 < 
	`ARRAY_SIZE
(
x86_pow”_æags
) &&

1154 
x86_pow”_æags
[
i
])

1155 
	`£q_´štf
(
m
, "%s%s",

1156 
x86_pow”_æags
[
i
][0]?" ":"",

1157 
x86_pow”_æags
[
i
]);

1159 
	`£q_´štf
(
m
, " [%d]", 
i
);

1163 
	`£q_´štf
(
m
, "\n\n");

1166 
	}
}

1168 *
	$c_¡¬t
(
£q_fe
 *
m
, 
loff_t
 *
pos
)

1170 ià(*
pos
 == 0)

1171 *
pos
 = 
	`fœ¡_ıu
(
ıu_Úlše_m­
);

1172 ià((*
pos
è< 
NR_CPUS
 && 
	`ıu_Úlše
(*pos))

1173  &
	`ıu_d©a
(*
pos
);

1174  
NULL
;

1175 
	}
}

1177 *
	$c_Ãxt
(
£q_fe
 *
m
, *
v
, 
loff_t
 *
pos
)

1179 *
pos
 = 
	`Ãxt_ıu
(*pos, 
ıu_Úlše_m­
);

1180  
	`c_¡¬t
(
m
, 
pos
);

1181 
	}
}

1183 
	$c_¡İ
(
£q_fe
 *
m
, *
v
)

1185 
	}
}

1187 
£q_İ”©iÚs
 
	gıušfo_İ
 = {

1188 .
¡¬t
 =
c_¡¬t
,

1189 .
	gÃxt
 = 
c_Ãxt
,

1190 .
	g¡İ
 = 
c_¡İ
,

1191 .
	gshow
 = 
show_ıušfo
,

	@/cmpt816/linux/arch/x86/kernel/signal_64.c

10 
	~<lšux/sched.h
>

11 
	~<lšux/mm.h
>

12 
	~<lšux/smp.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/sigÇl.h
>

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/wa™.h
>

17 
	~<lšux/±¿û.h
>

18 
	~<lšux/uni¡d.h
>

19 
	~<lšux/¡ddef.h
>

20 
	~<lšux/³rsÚ®™y.h
>

21 
	~<lšux/comp”.h
>

22 
	~<asm/ucÚ‹xt.h
>

23 
	~<asm/uacûss.h
>

24 
	~<asm/i387.h
>

25 
	~<asm/´Ùo.h
>

26 
	~<asm/Ÿ32_uni¡d.h
>

27 
	~<asm/mû.h
>

31 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
è| sigmask(
SIGSTOP
)))

	)

33 
Ÿ32_£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

34 
sig£t_t
 *
£t
, 
±_»gs
 * 
»gs
);

35 
Ÿ32_£tup_äame
(
sig
, 
k_sigaùiÚ
 *
ka
,

36 
sig£t_t
 *
£t
, 
±_»gs
 * 
»gs
);

38 
asmlškage
 

39 
	$sys_sig®t¡ack
(cÚ¡ 
¡ack_t
 
__u£r
 *
uss
, sck_ˆ__u£¸*
uoss
,

40 
±_»gs
 *
»gs
)

42  
	`do_sig®t¡ack
(
uss
, 
uoss
, 
»gs
->
r¥
);

43 
	}
}

50 
	s¹_sigäame


52 
__u£r
 *
	m´‘code
;

53 
ucÚ‹xt
 
	muc
;

54 
sigšfo
 
	mšfo
;

58 
	$»¡Üe_sigcÚ‹xt
(
±_»gs
 *
»gs
, 
sigcÚ‹xt
 
__u£r
 *
sc
, *
´ax
)

60 
”r
 = 0;

63 
	`cu¼’t_th»ad_šfo
()->
»¡¬t_block
.
â
 = 
do_no_»¡¬t_sysÿÎ
;

65 
	#COPY
(
x
è
”r
 |ğ
	`__g‘_u£r
(
»gs
->x, &
sc
->x)

	)

67 
	`COPY
(
rdi
); COPY(
rsi
); COPY(
rbp
); COPY(
r¥
); COPY(
rbx
);

68 
	`COPY
(
rdx
); COPY(
rcx
); COPY(
r
);

69 
	`COPY
(
r8
);

70 
	`COPY
(
r9
);

71 
	`COPY
(
r10
);

72 
	`COPY
(
r11
);

73 
	`COPY
(
r12
);

74 
	`COPY
(
r13
);

75 
	`COPY
(
r14
);

76 
	`COPY
(
r15
);

82 
cs
;

83 
”r
 |ğ
	`__g‘_u£r
(
cs
, &
sc
->cs);

84 
»gs
->
cs
 = cs | 3;

88 
tmpæags
;

89 
”r
 |ğ
	`__g‘_u£r
(
tmpæags
, &
sc
->
eæags
);

90 
»gs
->
eæags
 = (»gs->eæag & ~0x40DD5è| (
tmpæags
 & 0x40DD5);

91 
»gs
->
Üig_¿x
 = -1;

95 
_å¡©e
 
__u£r
 * 
buf
;

96 
”r
 |ğ
	`__g‘_u£r
(
buf
, &
sc
->
å¡©e
);

98 ià(
buf
) {

99 ià(!
	`acûss_ok
(
VERIFY_READ
, 
buf
, (*buf)))

100 
badäame
;

101 
”r
 |ğ
	`»¡Üe_i387
(
buf
);

103 
sk_¡ruù
 *
me
 = 
cu¼’t
;

104 ià(
	`u£d_m©h
()) {

105 
	`ş—r_åu
(
me
);

106 
	`ş—r_u£d_m©h
();

111 
”r
 |ğ
	`__g‘_u£r
(*
´ax
, &
sc
->
¿x
);

112  
”r
;

114 
badäame
:

116 
	}
}

118 
asmlškage
 
	$sys_¹_sig»tuº
(
±_»gs
 *
»gs
)

120 
¹_sigäame
 
__u£r
 *
äame
;

121 
sig£t_t
 
£t
;

122 
—x
;

124 
äame
 = (
¹_sigäame
 
__u£r
 *)(
»gs
->
r¥
 - 8);

125 ià(!
	`acûss_ok
(
VERIFY_READ
, 
äame
, (*frame))) {

126 
badäame
;

128 ià(
	`__cİy_äom_u£r
(&
£t
, &
äame
->
uc
.
uc_sigmask
, (set))) {

129 
badäame
;

132 
	`sigd–£tmask
(&
£t
, ~
_BLOCKABLE
);

133 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

134 
cu¼’t
->
blocked
 = 
£t
;

135 
	`»ÿlc_sig³ndšg
();

136 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

138 ià(
	`»¡Üe_sigcÚ‹xt
(
»gs
, &
äame
->
uc
.
uc_mcÚ‹xt
, &
—x
))

139 
badäame
;

141 #ifdeà
DEBUG_SIG


142 
	`´štk
("%d sig»tuº„:%lx„¥:%lx f¿me:%°¿x:%lx\n",
cu¼’t
->
pid
,
»gs
->
r
,»gs->
r¥
,
äame
,
—x
);

145 ià(
	`do_sig®t¡ack
(&
äame
->
uc
.
uc_¡ack
, 
NULL
, 
»gs
->
r¥
è=ğ-
EFAULT
)

146 
badäame
;

148  
—x
;

150 
badäame
:

151 
	`sigÇl_çuÉ
(
»gs
,
äame
,"sigreturn");

153 
	}
}

159 
šlše
 

160 
	$£tup_sigcÚ‹xt
(
sigcÚ‹xt
 
__u£r
 *
sc
, 
±_»gs
 *
»gs
, 
mask
, 
sk_¡ruù
 *
me
)

162 
”r
 = 0;

164 
”r
 |ğ
	`__put_u£r
(
»gs
->
cs
, &
sc
->cs);

165 
”r
 |ğ
	`__put_u£r
(0, &
sc
->
gs
);

166 
”r
 |ğ
	`__put_u£r
(0, &
sc
->
fs
);

168 
”r
 |ğ
	`__put_u£r
(
»gs
->
rdi
, &
sc
->rdi);

169 
”r
 |ğ
	`__put_u£r
(
»gs
->
rsi
, &
sc
->rsi);

170 
”r
 |ğ
	`__put_u£r
(
»gs
->
rbp
, &
sc
->rbp);

171 
”r
 |ğ
	`__put_u£r
(
»gs
->
r¥
, &
sc
->rsp);

172 
”r
 |ğ
	`__put_u£r
(
»gs
->
rbx
, &
sc
->rbx);

173 
”r
 |ğ
	`__put_u£r
(
»gs
->
rdx
, &
sc
->rdx);

174 
”r
 |ğ
	`__put_u£r
(
»gs
->
rcx
, &
sc
->rcx);

175 
”r
 |ğ
	`__put_u£r
(
»gs
->
¿x
, &
sc
->rax);

176 
”r
 |ğ
	`__put_u£r
(
»gs
->
r8
, &
sc
->r8);

177 
”r
 |ğ
	`__put_u£r
(
»gs
->
r9
, &
sc
->r9);

178 
”r
 |ğ
	`__put_u£r
(
»gs
->
r10
, &
sc
->r10);

179 
”r
 |ğ
	`__put_u£r
(
»gs
->
r11
, &
sc
->r11);

180 
”r
 |ğ
	`__put_u£r
(
»gs
->
r12
, &
sc
->r12);

181 
”r
 |ğ
	`__put_u£r
(
»gs
->
r13
, &
sc
->r13);

182 
”r
 |ğ
	`__put_u£r
(
»gs
->
r14
, &
sc
->r14);

183 
”r
 |ğ
	`__put_u£r
(
»gs
->
r15
, &
sc
->r15);

184 
”r
 |ğ
	`__put_u£r
(
me
->
th»ad
.
Œ­_no
, &
sc
->
Œ­no
);

185 
”r
 |ğ
	`__put_u£r
(
me
->
th»ad
.
”rÜ_code
, &
sc
->err);

186 
”r
 |ğ
	`__put_u£r
(
»gs
->
r
, &
sc
->rip);

187 
”r
 |ğ
	`__put_u£r
(
»gs
->
eæags
, &
sc
->eflags);

188 
”r
 |ğ
	`__put_u£r
(
mask
, &
sc
->
Şdmask
);

189 
”r
 |ğ
	`__put_u£r
(
me
->
th»ad
.
ü2
, &
sc
->cr2);

191  
”r
;

192 
	}
}

198 
__u£r
 *

199 
	$g‘_¡ack
(
k_sigaùiÚ
 *
ka
, 
±_»gs
 *
»gs
, 
size
)

201 
r¥
;

204 
r¥
 = 
»gs
->rsp - 128;

207 ià(
ka
->
§
.
§_æags
 & 
SA_ONSTACK
) {

208 ià(
	`§s_ss_æags
(
r¥
) == 0)

209 
r¥
 = 
cu¼’t
->
§s_ss_¥
 + cu¼’t->
§s_ss_size
;

212  (
__u£r
 *)
	`round_down
(
r¥
 - 
size
, 16);

213 
	}
}

215 
	$£tup_¹_äame
(
sig
, 
k_sigaùiÚ
 *
ka
, 
sigšfo_t
 *
šfo
,

216 
sig£t_t
 *
£t
, 
±_»gs
 * 
»gs
)

218 
¹_sigäame
 
__u£r
 *
äame
;

219 
_å¡©e
 
__u£r
 *
å
 = 
NULL
;

220 
”r
 = 0;

221 
sk_¡ruù
 *
me
 = 
cu¼’t
;

223 ià(
	`u£d_m©h
()) {

224 
å
 = 
	`g‘_¡ack
(
ka
, 
»gs
, (
_å¡©e
));

225 
äame
 = (
__u£r
 *)
	`round_down
(

226 ()
å
 - (
¹_sigäame
), 16) - 8;

228 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
å
, (
_å¡©e
)))

229 
give_sig£gv
;

231 ià(
	`§ve_i387
(
å
) < 0)

232 
”r
 |= -1;

234 
äame
 = 
	`g‘_¡ack
(
ka
, 
»gs
, (
¹_sigäame
)) - 8;

236 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
äame
, (*frame)))

237 
give_sig£gv
;

239 ià(
ka
->
§
.
§_æags
 & 
SA_SIGINFO
) {

240 
”r
 |ğ
	`cİy_sigšfo_to_u£r
(&
äame
->
šfo
, info);

241 ià(
”r
)

242 
give_sig£gv
;

246 
”r
 |ğ
	`__put_u£r
(0, &
äame
->
uc
.
uc_æags
);

247 
”r
 |ğ
	`__put_u£r
(0, &
äame
->
uc
.
uc_lšk
);

248 
”r
 |ğ
	`__put_u£r
(
me
->
§s_ss_¥
, &
äame
->
uc
.
uc_¡ack
.
ss_¥
);

249 
”r
 |ğ
	`__put_u£r
(
	`§s_ss_æags
(
»gs
->
r¥
),

250 &
äame
->
uc
.
uc_¡ack
.
ss_æags
);

251 
”r
 |ğ
	`__put_u£r
(
me
->
§s_ss_size
, &
äame
->
uc
.
uc_¡ack
.
ss_size
);

252 
”r
 |ğ
	`£tup_sigcÚ‹xt
(&
äame
->
uc
.
uc_mcÚ‹xt
, 
»gs
, 
£t
->
sig
[0], 
me
);

253 
”r
 |ğ
	`__put_u£r
(
å
, &
äame
->
uc
.
uc_mcÚ‹xt
.
å¡©e
);

254 ià((*
£t
) == 16) {

255 
	`__put_u£r
(
£t
->
sig
[0], &
äame
->
uc
.
uc_sigmask
.sig[0]);

256 
	`__put_u£r
(
£t
->
sig
[1], &
äame
->
uc
.
uc_sigmask
.sig[1]);

258 
”r
 |ğ
	`__cİy_to_u£r
(&
äame
->
uc
.
uc_sigmask
, 
£t
, (*set));

263 ià(
ka
->
§
.
§_æags
 & 
SA_RESTORER
) {

264 
”r
 |ğ
	`__put_u£r
(
ka
->
§
.
§_»¡Ü”
, &
äame
->
´‘code
);

267 
give_sig£gv
;

270 ià(
”r
)

271 
give_sig£gv
;

273 #ifdeà
DEBUG_SIG


274 
	`´štk
("%d old„ %lx old„¥ %lx old„ax %lx\n", 
cu¼’t
->
pid
,
»gs
->
r
,»gs->
r¥
,»gs->
¿x
);

278 
»gs
->
rdi
 = 
sig
;

280 
»gs
->
¿x
 = 0;

284 
»gs
->
rsi
 = ()&
äame
->
šfo
;

285 
»gs
->
rdx
 = ()&
äame
->
uc
;

286 
»gs
->
r
 = (è
ka
->
§
.
§_hªdËr
;

288 
»gs
->
r¥
 = ()
äame
;

292 
»gs
->
cs
 = 
__USER_CS
;

296 
	`£t_fs
(
USER_DS
);

298 
»gs
->
eæags
 &ğ~
TF_MASK
;

299 ià(
	`‹¡_th»ad_æag
(
TIF_SINGLESTEP
))

300 
	`±¿û_nÙify
(
SIGTRAP
);

301 #ifdeà
DEBUG_SIG


302 
	`´štk
("SIG deliver (%s:%d): sp=%p…c=%lx„a=%p\n",

303 
cu¼’t
->
comm
, cu¼’t->
pid
, 
äame
, 
»gs
->
r
, f¿me->
´‘code
);

308 
give_sig£gv
:

309 
	`fÜû_sig£gv
(
sig
, 
cu¼’t
);

310  -
EFAULT
;

311 
	}
}

318 
	$hªdË_sigÇl
(
sig
, 
sigšfo_t
 *
šfo
, 
k_sigaùiÚ
 *
ka
,

319 
sig£t_t
 *
Şd£t
, 
±_»gs
 *
»gs
)

321 
»t
;

323 #ifdeà
DEBUG_SIG


324 
	`´štk
("handle_signal…id:%d sig:%lu„ip:%lx„sp:%lx„egs=%p\n",

325 
cu¼’t
->
pid
, 
sig
,

326 
»gs
->
r
,„egs->
r¥
,„egs);

330 ià(()
»gs
->
Üig_¿x
 >= 0) {

332 
»gs
->
¿x
) {

333 -
ERESTART_RESTARTBLOCK
:

334 -
ERESTARTNOHAND
:

335 
»gs
->
¿x
 = -
EINTR
;

338 -
ERESTARTSYS
:

339 ià(!(
ka
->
§
.
§_æags
 & 
SA_RESTART
)) {

340 
»gs
->
¿x
 = -
EINTR
;

344 -
ERESTARTNOINTR
:

345 
»gs
->
¿x
 =„egs->
Üig_¿x
;

346 
»gs
->
r
 -= 2;

356 ià(
	`uÆik–y
(
»gs
->
eæags
 & 
TF_MASK
)) {

357 ià(
	`lik–y
(
cu¼’t
->
±¿û
 & 
PT_DTRACE
)) {

358 
cu¼’t
->
±¿û
 &ğ~
PT_DTRACE
;

359 
»gs
->
eæags
 &ğ~
TF_MASK
;

363 #ifdeà
CONFIG_IA32_EMULATION


364 ià(
	`‹¡_th»ad_æag
(
TIF_IA32
)) {

365 ià(
ka
->
§
.
§_æags
 & 
SA_SIGINFO
)

366 
»t
 = 
	`Ÿ32_£tup_¹_äame
(
sig
, 
ka
, 
šfo
, 
Şd£t
, 
»gs
);

368 
»t
 = 
	`Ÿ32_£tup_äame
(
sig
, 
ka
, 
Şd£t
, 
»gs
);

371 
»t
 = 
	`£tup_¹_äame
(
sig
, 
ka
, 
šfo
, 
Şd£t
, 
»gs
);

373 ià(
»t
 == 0) {

374 
	`¥š_lock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

375 
	`sigÜ£ts
(&
cu¼’t
->
blocked
,&cu¼’t->blocked,&
ka
->
§
.
§_mask
);

376 ià(!(
ka
->
§
.
§_æags
 & 
SA_NODEFER
))

377 
	`sigadd£t
(&
cu¼’t
->
blocked
,
sig
);

378 
	`»ÿlc_sig³ndšg
();

379 
	`¥š_uÆock_œq
(&
cu¼’t
->
sighªd
->
siglock
);

382  
»t
;

383 
	}
}

390 
	$do_sigÇl
(
±_»gs
 *
»gs
)

392 
k_sigaùiÚ
 
ka
;

393 
sigšfo_t
 
šfo
;

394 
sigÄ
;

395 
sig£t_t
 *
Şd£t
;

403 ià(!
	`u£r_mode
(
»gs
))

406 ià(
	`‹¡_th»ad_æag
(
TIF_RESTORE_SIGMASK
))

407 
Şd£t
 = &
cu¼’t
->
§ved_sigmask
;

409 
Şd£t
 = &
cu¼’t
->
blocked
;

411 
sigÄ
 = 
	`g‘_sigÇl_to_d–iv”
(&
šfo
, &
ka
, 
»gs
, 
NULL
);

412 ià(
sigÄ
 > 0) {

418 ià(
cu¼’t
->
th»ad
.
debug»g7
)

419 
	`£t_debug»g
(
cu¼’t
->
th»ad
.
debug»g7
, 7);

422 ià(
	`hªdË_sigÇl
(
sigÄ
, &
šfo
, &
ka
, 
Şd£t
, 
»gs
) == 0) {

427 
	`ş—r_th»ad_æag
(
TIF_RESTORE_SIGMASK
);

433 ià(()
»gs
->
Üig_¿x
 >= 0) {

435 
»s
 = 
»gs
->
¿x
;

436 
»s
) {

437 -
ERESTARTNOHAND
:

438 -
ERESTARTSYS
:

439 -
ERESTARTNOINTR
:

440 
»gs
->
¿x
 =„egs->
Üig_¿x
;

441 
»gs
->
r
 -= 2;

443 -
ERESTART_RESTARTBLOCK
:

444 
»gs
->
¿x
 = 
	`‹¡_th»ad_æag
(
TIF_IA32
) ?

445 
__NR_Ÿ32_»¡¬t_sysÿÎ
 :

446 
__NR_»¡¬t_sysÿÎ
;

447 
»gs
->
r
 -= 2;

454 ià(
	`‹¡_th»ad_æag
(
TIF_RESTORE_SIGMASK
)) {

455 
	`ş—r_th»ad_æag
(
TIF_RESTORE_SIGMASK
);

456 
	`sig´ocmask
(
SIG_SETMASK
, &
cu¼’t
->
§ved_sigmask
, 
NULL
);

458 
	}
}

461 
	$do_nÙify_»sume
(
±_»gs
 *
»gs
, *
unu£d
, 
__u32
 
th»ad_šfo_æags
)

463 #ifdeà
DEBUG_SIG


464 
	`´štk
("do_notify_resume flags:%x„ip:%lx„sp:%lx caller:%p…ending:%x\n",

465 
th»ad_šfo_æags
, 
»gs
->
r
,„egs->
r¥
, 
	`__butš_»tuº_add»ss
(0),
	`sigÇl_³ndšg
(
cu¼’t
));

469 ià(
th»ad_šfo_æags
 & 
_TIF_SINGLESTEP
) {

470 
»gs
->
eæags
 |ğ
TF_MASK
;

471 
	`ş—r_th»ad_æag
(
TIF_SINGLESTEP
);

474 #ifdeà
CONFIG_X86_MCE


476 ià(
th»ad_šfo_æags
 & 
_TIF_MCE_NOTIFY
)

477 
	`mû_nÙify_u£r
();

481 ià(
th»ad_šfo_æags
 & (
_TIF_SIGPENDING
|
_TIF_RESTORE_SIGMASK
))

482 
	`do_sigÇl
(
»gs
);

483 
	}
}

485 
	$sigÇl_çuÉ
(
±_»gs
 *
»gs
, 
__u£r
 *
äame
, *
wh”e
)

487 
sk_¡ruù
 *
me
 = 
cu¼’t
;

488 ià(
show_unhªdËd_sigÇls
 && 
	`´štk_¿‹lim™
())

489 
	`´štk
("%s[%d] bad frame in %s frame:%p„ip:%lx„sp:%lx orax:%lx\n",

490 
me
->
comm
,me->
pid
,
wh”e
,
äame
,
»gs
->
r
,»gs->
r¥
,»gs->
Üig_¿x
);

492 
	`fÜû_sig
(
SIGSEGV
, 
me
);

493 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp_64.c

12 
	~<lšux/š™.h
>

14 
	~<lšux/mm.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/¥šlock.h
>

17 
	~<lšux/smp.h
>

18 
	~<lšux/k”Ãl_¡©.h
>

19 
	~<lšux/mc146818¹c.h
>

20 
	~<lšux/š‹¼u±.h
>

22 
	~<asm/mŒr.h
>

23 
	~<asm/pg®loc.h
>

24 
	~<asm/bæush.h
>

25 
	~<asm/mach_­ic.h
>

26 
	~<asm/mmu_cÚ‹xt.h
>

27 
	~<asm/´Ùo.h
>

28 
	~<asm/­icdef.h
>

29 
	~<asm/idË.h
>

53 
	usmp_æush_¡©e
 {

55 
ıumask_t
 
	mæush_ıumask
;

56 
mm_¡ruù
 *
	mæush_mm
;

57 
	mæush_va
;

58 
	#FLUSH_ALL
 -1ULL

	)

59 
¥šlock_t
 
	mb¡©e_lock
;

61 
	m·d
[
SMP_CACHE_BYTES
];

62 } 
	g____ÿch–še_®igÃd
;

67 
DEFINE_PER_CPU
(
smp_æush_¡©e
, 
æush_¡©e
);

73 
šlše
 
	$Ëave_mm
(
ıu
)

75 ià(
	`»ad_pda
(
mmu_¡©e
è=ğ
TLBSTATE_OK
)

76 
	`BUG
();

77 
	`ıu_ş—r
(
ıu
, 
	`»ad_pda
(
aùive_mm
)->
ıu_vm_mask
);

78 
	`lßd_ü3
(
sw­³r_pg_dœ
);

79 
	}
}

129 
asmlškage
 
	$smp_šv®id©e_š‹¼u±
(
±_»gs
 *
»gs
)

131 
ıu
;

132 
£nd”
;

133 
smp_æush_¡©e
 *
f
;

135 
ıu
 = 
	`smp_´oûssÜ_id
();

140 
£nd”
 = ~
»gs
->
Üig_¿x
 - 
INVALIDATE_TLB_VECTOR_START
;

141 
f
 = &
	`³r_ıu
(
æush_¡©e
, 
£nd”
);

143 ià(!
	`ıu_is£t
(
ıu
, 
f
->
æush_ıumask
))

144 
out
;

154 ià(
f
->
æush_mm
 =ğ
	`»ad_pda
(
aùive_mm
)) {

155 ià(
	`»ad_pda
(
mmu_¡©e
è=ğ
TLBSTATE_OK
) {

156 ià(
f
->
æush_va
 =ğ
FLUSH_ALL
)

157 
	`loÿl_æush_b
();

159 
	`__æush_b_Úe
(
f
->
æush_va
);

161 
	`Ëave_mm
(
ıu
);

163 
out
:

164 
	`ack_APIC_œq
();

165 
	`ıu_ş—r
(
ıu
, 
f
->
æush_ıumask
);

166 
	`add_pda
(
œq_b_couÁ
, 1);

167 
	}
}

169 
	$æush_b_Ùh”s
(
ıumask_t
 
ıumask
, 
mm_¡ruù
 *
mm
,

170 
va
)

172 
£nd”
;

173 
smp_æush_¡©e
 *
f
;

176 
£nd”
 = 
	`smp_´oûssÜ_id
(è% 
NUM_INVALIDATE_TLB_VECTORS
;

177 
f
 = &
	`³r_ıu
(
æush_¡©e
, 
£nd”
);

182 
	`¥š_lock
(&
f
->
b¡©e_lock
);

184 
f
->
æush_mm
 = 
mm
;

185 
f
->
æush_va
 = 
va
;

186 
	`ıus_Ü
(
f
->
æush_ıumask
, 
ıumask
, f->flush_cpumask);

192 
	`£nd_IPI_mask
(
ıumask
, 
INVALIDATE_TLB_VECTOR_START
 + 
£nd”
);

194 !
	`ıus_em±y
(
f
->
æush_ıumask
))

195 
	`ıu_»Ïx
();

197 
f
->
æush_mm
 = 
NULL
;

198 
f
->
æush_va
 = 0;

199 
	`¥š_uÆock
(&
f
->
b¡©e_lock
);

200 
	}
}

202 
__ıuš™
 
	$š™_smp_æush
()

204 
i
;

205 
	`fÜ_—ch_ıu_mask
(
i
, 
ıu_possibË_m­
) {

206 
	`¥š_lock_š™
(&
	`³r_ıu
(
æush_¡©e
, 
i
).
b¡©e_lock
);

209 
	}
}

211 
cÜe_š™ÿÎ
(
š™_smp_æush
);

213 
	$æush_b_cu¼’t_sk
()

215 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

216 
ıumask_t
 
ıu_mask
;

218 
	`´“m±_di§bË
();

219 
ıu_mask
 = 
mm
->
ıu_vm_mask
;

220 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_mask
);

222 
	`loÿl_æush_b
();

223 ià(!
	`ıus_em±y
(
ıu_mask
))

224 
	`æush_b_Ùh”s
(
ıu_mask
, 
mm
, 
FLUSH_ALL
);

225 
	`´“m±_’abË
();

226 
	}
}

227 
EXPORT_SYMBOL
(
æush_b_cu¼’t_sk
);

229 
	$æush_b_mm
 (
mm_¡ruù
 * 
mm
)

231 
ıumask_t
 
ıu_mask
;

233 
	`´“m±_di§bË
();

234 
ıu_mask
 = 
mm
->
ıu_vm_mask
;

235 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_mask
);

237 ià(
cu¼’t
->
aùive_mm
 =ğ
mm
) {

238 ià(
cu¼’t
->
mm
)

239 
	`loÿl_æush_b
();

241 
	`Ëave_mm
(
	`smp_´oûssÜ_id
());

243 ià(!
	`ıus_em±y
(
ıu_mask
))

244 
	`æush_b_Ùh”s
(
ıu_mask
, 
mm
, 
FLUSH_ALL
);

246 
	`´“m±_’abË
();

247 
	}
}

248 
EXPORT_SYMBOL
(
æush_b_mm
);

250 
	$æush_b_·ge
(
vm_¬—_¡ruù
 * 
vma
, 
va
)

252 
mm_¡ruù
 *
mm
 = 
vma
->
vm_mm
;

253 
ıumask_t
 
ıu_mask
;

255 
	`´“m±_di§bË
();

256 
ıu_mask
 = 
mm
->
ıu_vm_mask
;

257 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_mask
);

259 ià(
cu¼’t
->
aùive_mm
 =ğ
mm
) {

260 if(
cu¼’t
->
mm
)

261 
	`__æush_b_Úe
(
va
);

263 
	`Ëave_mm
(
	`smp_´oûssÜ_id
());

266 ià(!
	`ıus_em±y
(
ıu_mask
))

267 
	`æush_b_Ùh”s
(
ıu_mask
, 
mm
, 
va
);

269 
	`´“m±_’abË
();

270 
	}
}

271 
EXPORT_SYMBOL
(
æush_b_·ge
);

273 
	$do_æush_b_®l
(* 
šfo
)

275 
ıu
 = 
	`smp_´oûssÜ_id
();

277 
	`__æush_b_®l
();

278 ià(
	`»ad_pda
(
mmu_¡©e
è=ğ
TLBSTATE_LAZY
)

279 
	`Ëave_mm
(
ıu
);

280 
	}
}

282 
	$æush_b_®l
()

284 
	`Ú_—ch_ıu
(
do_æush_b_®l
, 
NULL
, 1, 1);

285 
	}
}

293 
	$smp_£nd_»scheduË
(
ıu
)

295 
	`£nd_IPI_mask
(
	`ıumask_of_ıu
(
ıu
), 
RESCHEDULE_VECTOR
);

296 
	}
}

302 
DEFINE_SPINLOCK
(
ÿÎ_lock
);

304 
	sÿÎ_d©a_¡ruù
 {

305 (*
	mfunc
è(*
	mšfo
);

306 *
	mšfo
;

307 
©omic_t
 
	m¡¬‹d
;

308 
©omic_t
 
	mfšished
;

309 
	mwa™
;

312 
ÿÎ_d©a_¡ruù
 * 
	gÿÎ_d©a
;

314 
	$lock_i_ÿÎ_lock
()

316 
	`¥š_lock_œq
(&
ÿÎ_lock
);

317 
	}
}

319 
	$uÆock_i_ÿÎ_lock
()

321 
	`¥š_uÆock_œq
(&
ÿÎ_lock
);

322 
	}
}

330 
__smp_ÿÎ_funùiÚ_mask
(
ıumask_t
 
mask
,

331 (*
func
)(*), *
šfo
,

332 
wa™
)

334 
ÿÎ_d©a_¡ruù
 
d©a
;

335 
ıumask_t
 
®lbut£lf
;

336 
ıus
;

338 
®lbut£lf
 = 
ıu_Úlše_m­
;

339 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbut£lf
);

341 
	`ıus_ªd
(
mask
, mask, 
®lbut£lf
);

342 
ıus
 = 
	`ıus_weight
(
mask
);

344 ià(!
ıus
)

347 
d©a
.
func
 = func;

348 
d©a
.
šfo
 = info;

349 
	`©omic_£t
(&
d©a
.
¡¬‹d
, 0);

350 
d©a
.
wa™
 = wait;

351 ià(
wa™
)

352 
	`©omic_£t
(&
d©a
.
fšished
, 0);

354 
ÿÎ_d©a
 = &
d©a
;

355 
	`wmb
();

358 ià(
	`ıus_equ®
(
mask
, 
®lbut£lf
))

359 
	`£nd_IPI_®lbut£lf
(
CALL_FUNCTION_VECTOR
);

361 
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

364 
	`©omic_»ad
(&
d©a
.
¡¬‹d
è!ğ
ıus
)

365 
	`ıu_»Ïx
();

367 ià(!
wa™
)

370 
	`©omic_»ad
(&
d©a
.
fšished
è!ğ
ıus
)

371 
	`ıu_»Ïx
();

374 
	}
}

390 
smp_ÿÎ_funùiÚ_mask
(
ıumask_t
 
mask
,

391 (*
func
)(*), *
šfo
,

392 
wa™
)

394 
»t
;

397 
	`WARN_ON
(
	`œqs_di§bËd
());

399 
	`¥š_lock
(&
ÿÎ_lock
);

400 
»t
 = 
	`__smp_ÿÎ_funùiÚ_mask
(
mask
, 
func
, 
šfo
, 
wa™
);

401 
	`¥š_uÆock
(&
ÿÎ_lock
);

402  
»t
;

403 
	}
}

404 
EXPORT_SYMBOL
(
smp_ÿÎ_funùiÚ_mask
);

419 
smp_ÿÎ_funùiÚ_sšgË
 (
ıu
, (*
func
è(*
šfo
), *info,

420 
nÚ©omic
, 
wa™
)

423 
»t
;

424 
me
 = 
	`g‘_ıu
();

427 
	`WARN_ON
(
	`œqs_di§bËd
());

429 ià(
ıu
 =ğ
me
) {

430 
	`loÿl_œq_di§bË
();

431 
	`func
(
šfo
);

432 
	`loÿl_œq_’abË
();

433 
	`put_ıu
();

437 
»t
 = 
	`smp_ÿÎ_funùiÚ_mask
(
	`ıumask_of_ıu
(
ıu
), 
func
, 
šfo
, 
wa™
);

439 
	`put_ıu
();

440  
»t
;

441 
	}
}

442 
EXPORT_SYMBOL
(
smp_ÿÎ_funùiÚ_sšgË
);

459 
smp_ÿÎ_funùiÚ
 ((*
func
è(*
šfo
), *šfo, 
nÚ©omic
,

460 
wa™
)

462  
	`smp_ÿÎ_funùiÚ_mask
(
ıu_Úlše_m­
, 
func
, 
šfo
, 
wa™
);

463 
	}
}

464 
EXPORT_SYMBOL
(
smp_ÿÎ_funùiÚ
);

466 
	$¡İ_this_ıu
(*
dummy
)

468 
	`loÿl_œq_di§bË
();

472 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_Úlše_m­
);

473 
	`di§bË_loÿl_APIC
();

475 
	`h®t
();

476 
	}
}

478 
	$smp_£nd_¡İ
()

480 
nŞock
;

481 
æags
;

483 ià(
»boÙ_fÜû
)

487 
nŞock
 = !
	`¥š_Œylock
(&
ÿÎ_lock
);

488 
	`loÿl_œq_§ve
(
æags
);

489 
	`__smp_ÿÎ_funùiÚ_mask
(
ıu_Úlše_m­
, 
¡İ_this_ıu
, 
NULL
, 0);

490 ià(!
nŞock
)

491 
	`¥š_uÆock
(&
ÿÎ_lock
);

492 
	`di§bË_loÿl_APIC
();

493 
	`loÿl_œq_»¡Üe
(
æags
);

494 
	}
}

501 
asmlškage
 
	$smp_»scheduË_š‹¼u±
()

503 
	`ack_APIC_œq
();

504 
	`add_pda
(
œq_»sched_couÁ
, 1);

505 
	}
}

507 
asmlškage
 
	$smp_ÿÎ_funùiÚ_š‹¼u±
()

509 (*
func
è(*
šfo
èğ
ÿÎ_d©a
->func;

510 *
šfo
 = 
ÿÎ_d©a
->info;

511 
wa™
 = 
ÿÎ_d©a
->wait;

513 
	`ack_APIC_œq
();

518 
	`mb
();

519 
	`©omic_šc
(&
ÿÎ_d©a
->
¡¬‹d
);

523 
	`ex™_idË
();

524 
	`œq_’‹r
();

525 (*
func
)(
šfo
);

526 
	`add_pda
(
œq_ÿÎ_couÁ
, 1);

527 
	`œq_ex™
();

528 ià(
wa™
) {

529 
	`mb
();

530 
	`©omic_šc
(&
ÿÎ_d©a
->
fšished
);

532 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smpboot_64.c

41 
	~<lšux/š™.h
>

43 
	~<lšux/mm.h
>

44 
	~<lšux/k”Ãl_¡©.h
>

45 
	~<lšux/boÙmem.h
>

46 
	~<lšux/th»ad_šfo.h
>

47 
	~<lšux/moduË.h
>

48 
	~<lšux/d–ay.h
>

49 
	~<lšux/mc146818¹c.h
>

50 
	~<lšux/smp.h
>

51 
	~<lšux/kdebug.h
>

53 
	~<asm/mŒr.h
>

54 
	~<asm/pg®loc.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/bæush.h
>

57 
	~<asm/´Ùo.h
>

58 
	~<asm/nmi.h
>

59 
	~<asm/œq.h
>

60 
	~<asm/hw_œq.h
>

61 
	~<asm/numa.h
>

64 
	gsmp_num_siblšgs
 = 1;

65 
EXPORT_SYMBOL
(
smp_num_siblšgs
);

68 
DEFINE_PER_CPU
(
u8
, 
ıu_Îc_id
èğ
BAD_APICID
;

71 
ıumask_t
 
ıu_Úlše_m­
 
	g__»ad_mo¡ly
;

73 
EXPORT_SYMBOL
(
ıu_Úlše_m­
);

79 
ıumask_t
 
	gıu_ÿÎš_m­
;

80 
ıumask_t
 
	gıu_ÿÎout_m­
;

81 
EXPORT_SYMBOL
(
ıu_ÿÎout_m­
);

83 
ıumask_t
 
	gıu_possibË_m­
;

84 
EXPORT_SYMBOL
(
ıu_possibË_m­
);

87 
DEFINE_PER_CPU_SHARED_ALIGNED
(
ıušfo_x86
, 
ıu_šfo
);

88 
EXPORT_PER_CPU_SYMBOL
(
ıu_šfo
);

91 
	gsmp_th»ads_»ady
;

94 
DEFINE_PER_CPU
(
ıumask_t
, 
ıu_siblšg_m­
);

95 
EXPORT_PER_CPU_SYMBOL
(
ıu_siblšg_m­
);

98 
DEFINE_PER_CPU
(
ıumask_t
, 
ıu_cÜe_m­
);

99 
EXPORT_PER_CPU_SYMBOL
(
ıu_cÜe_m­
);

105 cÚ¡ 
ŒampŞše_d©a
[];

106 cÚ¡ 
ŒampŞše_’d
[];

109 
DEFINE_PER_CPU
(, 
ıu_¡©e
) = { 0 };

116 
sk_¡ruù
 *
	gidË_th»ad_¬¿y
[
NR_CPUS
] 
	g__ıuš™d©a
 ;

118 
	#g‘_idË_fÜ_ıu
(
x
è(
idË_th»ad_¬¿y
[(x)])

	)

119 
	#£t_idË_fÜ_ıu
(
x
,
p
è(
idË_th»ad_¬¿y
[(x)] = (p))

	)

127 
__ıuš™
 
	$£tup_ŒampŞše
()

129 *
Œamp
 = 
	`__va
(
SMP_TRAMPOLINE_BASE
);

130 
	`memıy
(
Œamp
, 
ŒampŞše_d©a
, 
ŒampŞše_’d
 -rampoline_data);

131  
	`vœt_to_phys
(
Œamp
);

132 
	}
}

139 
__ıuš™
 
	$smp_¡Üe_ıu_šfo
(
id
)

141 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
id
);

143 *
c
 = 
boÙ_ıu_d©a
;

144 
c
->
ıu_šdex
 = 
id
;

145 
	`id’tify_ıu
(
c
);

146 
	`´št_ıu_šfo
(
c
);

147 
	}
}

149 
©omic_t
 
š™_d—s£¹ed
 
	g__ıuš™d©a
;

155 
__ıuš™
 
	$smp_ÿÎš
()

157 
ıuid
, 
phys_id
;

158 
timeout
;

166 !
	`©omic_»ad
(&
š™_d—s£¹ed
))

167 
	`ıu_»Ïx
();

172 
phys_id
 = 
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
));

173 
ıuid
 = 
	`smp_´oûssÜ_id
();

174 ià(
	`ıu_is£t
(
ıuid
, 
ıu_ÿÎš_m­
)) {

175 
	`·nic
("smp_callin:…hys CPU#%d, CPU#%d‡lready…resent??\n",

176 
phys_id
, 
ıuid
);

178 
	`D´štk
("CPU#%d (phy ID: %dèwa™šg fÜ CALLOUT\n", 
ıuid
, 
phys_id
);

191 
timeout
 = 
jiff›s
 + 2*
HZ
;

192 
	`time_befÜe
(
jiff›s
, 
timeout
)) {

196 ià(
	`ıu_is£t
(
ıuid
, 
ıu_ÿÎout_m­
))

198 
	`ıu_»Ïx
();

201 ià(!
	`time_befÜe
(
jiff›s
, 
timeout
)) {

202 
	`·nic
("smp_callin: CPU%d started up but did‚ot get‡ callout!\n",

203 
ıuid
);

213 
	`D´štk
("CALLIN, before setup_local_APIC().\n");

214 
	`£tup_loÿl_APIC
();

222 
	`loÿl_œq_’abË
();

223 
	`ÿlib¿‹_d–ay
();

224 
	`loÿl_œq_di§bË
();

225 
	`D´štk
("Sck‡ˆabouˆ%p\n",&
ıuid
);

230 
	`smp_¡Üe_ıu_šfo
(
ıuid
);

235 
	`ıu_£t
(
ıuid
, 
ıu_ÿÎš_m­
);

236 
	}
}

239 
ıumask_t
 
	$ıu_cÜegroup_m­
(
ıu
)

241 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

246 ià(
sched_mc_pow”_§všgs
 || 
sched_smt_pow”_§všgs
)

247  
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
);

249  
c
->
Îc_sh¬ed_m­
;

250 
	}
}

253 
ıumask_t
 
	gıu_siblšg_£tup_m­
;

255 
šlše
 
	$£t_ıu_siblšg_m­
(
ıu
)

257 
i
;

258 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

260 
	`ıu_£t
(
ıu
, 
ıu_siblšg_£tup_m­
);

262 ià(
smp_num_siblšgs
 > 1) {

263 
	`fÜ_—ch_ıu_mask
(
i
, 
ıu_siblšg_£tup_m­
) {

264 ià(
c
->
phys_´oc_id
 =ğ
	`ıu_d©a
(
i
).phys_proc_id &&

265 
c
->
ıu_cÜe_id
 =ğ
	`ıu_d©a
(
i
).cpu_core_id) {

266 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
));

267 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
i
));

268 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

269 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
i
));

270 
	`ıu_£t
(
i
, 
c
->
Îc_sh¬ed_m­
);

271 
	`ıu_£t
(
ıu
, 
	`ıu_d©a
(
i
).
Îc_sh¬ed_m­
);

275 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, cpu));

278 
	`ıu_£t
(
ıu
, 
c
->
Îc_sh¬ed_m­
);

280 ià(
cu¼’t_ıu_d©a
.
x86_max_cÜes
 == 1) {

281 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
èğ³r_ıu(
ıu_siblšg_m­
, cpu);

282 
c
->
boÙed_cÜes
 = 1;

286 
	`fÜ_—ch_ıu_mask
(
i
, 
ıu_siblšg_£tup_m­
) {

287 ià(
	`³r_ıu
(
ıu_Îc_id
, 
ıu
è!ğ
BAD_APICID
 &&

288 
	`³r_ıu
(
ıu_Îc_id
, 
ıu
è=ğ³r_ıu(ıu_Îc_id, 
i
)) {

289 
	`ıu_£t
(
i
, 
c
->
Îc_sh¬ed_m­
);

290 
	`ıu_£t
(
ıu
, 
	`ıu_d©a
(
i
).
Îc_sh¬ed_m­
);

292 ià(
c
->
phys_´oc_id
 =ğ
	`ıu_d©a
(
i
).phys_proc_id) {

293 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

294 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
i
));

298 ià(
	`ıus_weight
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
)) == 1) {

303 ià(
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_siblšg_m­
, 
i
)) == i)

304 
c
->
boÙed_cÜes
++;

309 ià(
i
 !ğ
ıu
)

310 
	`ıu_d©a
(
i
).
boÙed_cÜes
++;

311 } ià(
i
 !ğ
ıu
 && !
c
->
boÙed_cÜes
)

312 
c
->
boÙed_cÜes
 = 
	`ıu_d©a
(
i
).booted_cores;

315 
	}
}

320 
__ıuš™
 
	$¡¬t_£cÚd¬y
()

327 
	`ıu_š™
();

328 
	`´“m±_di§bË
();

329 
	`smp_ÿÎš
();

332 
	`b¬r›r
();

337 
	`check_tsc_sync_rg‘
();

339 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

340 
	`di§bË_8259A_œq
(0);

341 
	`’abË_NMI_through_LVT0
(
NULL
);

342 
	`’abË_8259A_œq
(0);

349 
	`£t_ıu_siblšg_m­
(
	`smp_´oûssÜ_id
());

359 
	`lock_i_ÿÎ_lock
();

360 
	`¥š_lock
(&
veùÜ_lock
);

363 
	`__£tup_veùÜ_œq
(
	`smp_´oûssÜ_id
());

367 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
ıu_Úlše_m­
);

368 
	`³r_ıu
(
ıu_¡©e
, 
	`smp_´oûssÜ_id
()èğ
CPU_ONLINE
;

369 
	`¥š_uÆock
(&
veùÜ_lock
);

371 
	`uÆock_i_ÿÎ_lock
();

373 
	`£tup_£cÚd¬y_APIC_şock
();

375 
	`ıu_idË
();

376 
	}
}

378 vŞ©
š™_r¥
;

379 (*
š™Ÿl_code
)();

381 #ifdeà
APIC_DEBUG


382 
	$šquœe_»mÙe_­ic
(
­icid
)

384 
i
, 
»gs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

385 *
Çmes
[] = { "ID", "VERSION", "SPIV" };

386 
timeout
;

387 
¡©us
;

389 
	`´štk
(
KERN_INFO
 "Inquœšg„emÙAPIC #%d...\n", 
­icid
);

391 
i
 = 0; i < 
	`ARRAY_SIZE
(
»gs
); i++) {

392 
	`´štk
("... APIC #%d %s: ", 
­icid
, 
Çmes
[
i
]);

397 
¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

398 ià(
¡©us
)

399 
	`´štk
("a…revious APIC delivery may have failed\n");

401 
	`­ic_wr™e
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
­icid
));

402 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_DM_REMRD
 | 
»gs
[
i
]);

404 
timeout
 = 0;

406 
	`ud–ay
(100);

407 
¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_RR_MASK
;

408 } 
¡©us
 =ğ
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

410 
¡©us
) {

411 
APIC_ICR_RR_VALID
:

412 
¡©us
 = 
	`­ic_»ad
(
APIC_RRR
);

413 
	`´štk
("%08x\n", 
¡©us
);

416 
	`´štk
("failed\n");

419 
	}
}

425 
__ıuš™
 
	$wakeup_£cÚd¬y_vŸ_INIT
(
phys_­icid
, 
¡¬t_r
)

427 
£nd_¡©us
, 
acû±_¡©us
 = 0;

428 
maxlvt
, 
num_¡¬ts
, 
j
;

430 
	`D´štk
("Asserting INIT.\n");

435 
	`­ic_wr™e
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
phys_­icid
));

440 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT


441 | 
APIC_DM_INIT
);

443 
	`D´štk
("Waiting for sendo finish...\n");

444 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

446 
	`md–ay
(10);

448 
	`D´štk
("Deasserting INIT.\n");

451 
	`­ic_wr™e
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
phys_­icid
));

454 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

456 
	`D´štk
("Waiting for sendo finish...\n");

457 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

459 
	`mb
();

460 
	`©omic_£t
(&
š™_d—s£¹ed
, 1);

462 
num_¡¬ts
 = 2;

467 
	`D´štk
("#¡¬tu°loİs: %d.\n", 
num_¡¬ts
);

469 
maxlvt
 = 
	`g‘_maxlvt
();

471 
j
 = 1; j <ğ
num_¡¬ts
; j++) {

472 
	`D´štk
("S’dšg STARTUP #%d.\n",
j
);

473 
	`­ic_wr™e
(
APIC_ESR
, 0);

474 
	`­ic_»ad
(
APIC_ESR
);

475 
	`D´štk
("After‡pic_write.\n");

482 
	`­ic_wr™e
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
phys_­icid
));

486 
	`­ic_wr™e
(
APIC_ICR
, 
APIC_DM_STARTUP
 | (
¡¬t_r
 >> 12));

491 
	`ud–ay
(300);

493 
	`D´štk
("Startup…oint 1.\n");

495 
	`D´štk
("Waiting for sendo finish...\n");

496 
£nd_¡©us
 = 
	`§ã_­ic_wa™_iü_idË
();

501 
	`ud–ay
(200);

505 ià(
maxlvt
 > 3) {

506 
	`­ic_wr™e
(
APIC_ESR
, 0);

508 
acû±_¡©us
 = (
	`­ic_»ad
(
APIC_ESR
) & 0xEF);

509 ià(
£nd_¡©us
 || 
acû±_¡©us
)

512 
	`D´štk
("After Startup.\n");

514 ià(
£nd_¡©us
)

515 
	`´štk
(
KERN_ERR
 "APIC‚ever delivered???\n");

516 ià(
acû±_¡©us
)

517 
	`´štk
(
KERN_ERR
 "APIC d–iv”yƒ¼Ü (%lx).\n", 
acû±_¡©us
);

519  (
£nd_¡©us
 | 
acû±_¡©us
);

520 
	}
}

522 
	sü—‹_idË
 {

523 
wÜk_¡ruù
 
	mwÜk
;

524 
sk_¡ruù
 *
	midË
;

525 
com¶‘iÚ
 
	mdÚe
;

526 
	mıu
;

529 
__ıuš™
 
	$do_fÜk_idË
(
wÜk_¡ruù
 *
wÜk
)

531 
ü—‹_idË
 *
c_idË
 =

532 
	`cÚš”_of
(
wÜk
, 
ü—‹_idË
, work);

534 
c_idË
->
idË
 = 
	`fÜk_idË
(c_idË->
ıu
);

535 
	`com¶‘e
(&
c_idË
->
dÚe
);

536 
	}
}

541 
__ıuš™
 
	$do_boÙ_ıu
(
ıu
, 
­icid
)

543 
boÙ_”rÜ
;

544 
timeout
;

545 
¡¬t_r
;

546 
ü—‹_idË
 
c_idË
 = {

547 .
wÜk
 = 
	`__WORK_INITIALIZER
(
c_idË
.wÜk, 
do_fÜk_idË
),

548 .
ıu
 = cpu,

549 .
dÚe
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idË
.done),

553 ià(!
ıu_gdt_desü
[
ıu
].
add»ss
 &&

554 !(
ıu_gdt_desü
[
ıu
].
add»ss
 = 
	`g‘_z”Ûd_·ge
(
GFP_KERNEL
))) {

555 
	`´štk
(
KERN_ERR
 "FaedØ®loÿ‹ GDT fÜ CPU %d\n", 
ıu
);

560 ià(
	`ıu_pda
(
ıu
è=ğ&
boÙ_ıu_pda
[cpu]) {

561 
x8664_pda
 *
Ãwpda
, *
pda
;

562 
node
 = 
	`ıu_to_node
(
ıu
);

563 
pda
 = 
	`ıu_pda
(
ıu
);

564 
Ãwpda
 = 
	`km®loc_node
( (
x8664_pda
), 
GFP_ATOMIC
,

565 
node
);

566 ià(
Ãwpda
) {

567 
	`memıy
(
Ãwpda
, 
pda
,  (
x8664_pda
));

568 
	`ıu_pda
(
ıu
èğ
Ãwpda
;

570 
	`´štk
(
KERN_ERR


572 
ıu
, 
node
);

575 
	`®‹º©ives_smp_sw™ch
(1);

577 
c_idË
.
idË
 = 
	`g‘_idË_fÜ_ıu
(
ıu
);

579 ià(
c_idË
.
idË
) {

580 
c_idË
.
idË
->
th»ad
.
r¥
 = (è(((
±_»gs
 *)

581 (
THREAD_SIZE
 + 
	`sk_¡ack_·ge
(
c_idË
.
idË
))) - 1);

582 
	`š™_idË
(
c_idË
.
idË
, 
ıu
);

583 
do_»¡
;

596 ià(!
	`kev’td_up
(è|| 
	`cu¼’t_is_kev’td
())

597 
c_idË
.
wÜk
.
	`func
(&c_idle.work);

599 
	`scheduË_wÜk
(&
c_idË
.
wÜk
);

600 
	`wa™_fÜ_com¶‘iÚ
(&
c_idË
.
dÚe
);

603 ià(
	`IS_ERR
(
c_idË
.
idË
)) {

604 
	`´štk
("çed fÜk fÜ CPU %d\n", 
ıu
);

605  
	`PTR_ERR
(
c_idË
.
idË
);

608 
	`£t_idË_fÜ_ıu
(
ıu
, 
c_idË
.
idË
);

610 
do_»¡
:

612 
	`ıu_pda
(
ıu
)->
pcu¼’t
 = 
c_idË
.
idË
;

614 
¡¬t_r
 = 
	`£tup_ŒampŞše
();

616 
š™_r¥
 = 
c_idË
.
idË
->
th»ad
.
r¥
;

617 
	`³r_ıu
(
š™_tss
,
ıu
).
r¥0
 = 
š™_r¥
;

618 
š™Ÿl_code
 = 
¡¬t_£cÚd¬y
;

619 
	`ş—r_tsk_th»ad_æag
(
c_idË
.
idË
, 
TIF_FORK
);

621 
	`´štk
(
KERN_INFO
 "BoÙšg…roûssÜ %d/%d APIC 0x%x\n", 
ıu
,

622 
	`ıus_weight
(
ıu_´e£Á_m­
),

623 
­icid
);

630 
	`©omic_£t
(&
š™_d—s£¹ed
, 0);

632 
	`D´štk
("Setting warm„eset code‡nd vector.\n");

634 
	`CMOS_WRITE
(0xa, 0xf);

635 
	`loÿl_æush_b
();

636 
	`D´štk
("1.\n");

637 *((vŞ©*è
	`phys_to_vœt
(0x469)èğ
¡¬t_r
 >> 4;

638 
	`D´štk
("2.\n");

639 *((vŞ©*è
	`phys_to_vœt
(0x467)èğ
¡¬t_r
 & 0xf;

640 
	`D´štk
("3.\n");

645 
	`­ic_wr™e
(
APIC_ESR
, 0);

646 
	`­ic_»ad
(
APIC_ESR
);

651 
boÙ_”rÜ
 = 0;

656 
boÙ_”rÜ
 = 
	`wakeup_£cÚd¬y_vŸ_INIT
(
­icid
, 
¡¬t_r
);

658 ià(!
boÙ_”rÜ
) {

662 
	`D´štk
("BefÜC®louˆ%d.\n", 
ıu
);

663 
	`ıu_£t
(
ıu
, 
ıu_ÿÎout_m­
);

664 
	`D´štk
("Aá” C®louˆ%d.\n", 
ıu
);

669 
timeout
 = 0;imeout < 50000;imeout++) {

670 ià(
	`ıu_is£t
(
ıu
, 
ıu_ÿÎš_m­
))

672 
	`ud–ay
(100);

675 ià(
	`ıu_is£t
(
ıu
, 
ıu_ÿÎš_m­
)) {

677 
	`D´štk
("CPU has booted.\n");

679 
boÙ_”rÜ
 = 1;

680 ià(*((vŞ©*)
	`phys_to_vœt
(
SMP_TRAMPOLINE_BASE
))

683 
	`´štk
("Stuck ??\n");

686 
	`´štk
("Not„esponding.\n");

687 #ifdeà
APIC_DEBUG


688 
	`šquœe_»mÙe_­ic
(
­icid
);

692 ià(
boÙ_”rÜ
) {

693 
	`ıu_ş—r
(
ıu
, 
ıu_ÿÎout_m­
);

694 
	`ş—r_b™
(
ıu
, &
ıu_š™Ÿlized
);

695 
	`ş—r_node_ıumask
(
ıu
);

696 
	`ıu_ş—r
(
ıu
, 
ıu_´e£Á_m­
);

697 
	`ıu_ş—r
(
ıu
, 
ıu_possibË_m­
);

698 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
èğ
BAD_APICID
;

699  -
EIO
;

703 
	}
}

705 
cyşes_t
 
	gÿcheæush_time
;

706 
	gÿche_deÿy_ticks
;

711 
__ıuš™
 
	$smp_ş—nup_boÙ
()

717 
	`CMOS_WRITE
(0, 0xf);

722 *((vŞ©*è
	`phys_to_vœt
(0x467)) = 0;

723 
	}
}

730 
__š™
 
	$di§bË_smp
()

732 
ıu_´e£Á_m­
 = 
	`ıumask_of_ıu
(0);

733 
ıu_possibË_m­
 = 
	`ıumask_of_ıu
(0);

734 ià(
smp_found_cÚfig
)

735 
phys_ıu_´e£Á_m­
 = 
	`physid_mask_of_physid
(
boÙ_ıu_id
);

737 
phys_ıu_´e£Á_m­
 = 
	`physid_mask_of_physid
(0);

738 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_siblšg_m­
, 0));

739 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_cÜe_m­
, 0));

740 
	}
}

742 #ifdeà
CONFIG_HOTPLUG_CPU


744 
add™iÚ®_ıus
 
	g__š™d©a
 = -1;

763 
__š™
 
	$´efl_possibË_m­
()

765 
i
;

766 
possibË
;

768 ià(
add™iÚ®_ıus
 == -1) {

769 ià(
di§bËd_ıus
 > 0)

770 
add™iÚ®_ıus
 = 
di§bËd_ıus
;

772 
add™iÚ®_ıus
 = 0;

774 
possibË
 = 
num_´oûssÜs
 + 
add™iÚ®_ıus
;

775 ià(
possibË
 > 
NR_CPUS
)

776 
possibË
 = 
NR_CPUS
;

778 
	`´štk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

779 
possibË
,

780 
	`max_t
(, 
possibË
 - 
num_´oûssÜs
, 0));

782 
i
 = 0; i < 
possibË
; i++)

783 
	`ıu_£t
(
i
, 
ıu_possibË_m­
);

784 
	}
}

790 
__š™
 
	$smp_§n™y_check
(
max_ıus
)

792 ià(!
	`physid_is£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
)) {

793 
	`´štk
("weird, boot CPU (#%d)‚ot†isted byhe BIOS.\n",

794 
	`h¬d_smp_´oûssÜ_id
());

795 
	`physid_£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
);

802 ià(!
smp_found_cÚfig
) {

803 
	`´štk
(
KERN_NOTICE
 "SMP motherboard‚ot detected.\n");

804 
	`di§bË_smp
();

805 ià(
	`APIC_š™_unroûssÜ
())

806 
	`´štk
(
KERN_NOTICE
 "Local APIC‚ot detected."

815 ià(!
	`physid_is£t
(
boÙ_ıu_id
, 
phys_ıu_´e£Á_m­
)) {

816 
	`´štk
(
KERN_NOTICE
 "weird, boot CPU (#%d)‚ot†isted byhe BIOS.\n",

817 
boÙ_ıu_id
);

818 
	`physid_£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
);

824 ià(!
ıu_has_­ic
) {

825 
	`´štk
(
KERN_ERR
 "BIOS bug,†ocal APIC #%d‚ot detected!...\n",

826 
boÙ_ıu_id
);

827 
	`´štk
(
KERN_ERR
 "... forcing use of dummy APICƒmulation. (tell your hw vendor)\n");

828 
Ä_ißpics
 = 0;

835 ià(!
max_ıus
) {

836 
	`´štk
(
KERN_INFO
 "SMP mode deactivated, forcing use of dummy APICƒmulation.\n");

837 
Ä_ißpics
 = 0;

842 
	}
}

850 
__š™
 
	$smp_£t_­icids
()

852 
ıu
;

854 
	`fÜ_—ch_ıu_mask
(
ıu
, 
ıu_possibË_m­
) {

855 ià(
	`³r_ıu_off£t
(
ıu
))

856 
	`³r_ıu
(
x86_ıu_to_­icid
, 
ıu
) =

857 
x86_ıu_to_­icid_š™
[
ıu
];

861 
x86_ıu_to_­icid_±r
 = 
NULL
;

862 
	}
}

868 
__š™
 
	$smp_´•¬e_ıus
(
max_ıus
)

870 
	`nmi_w©chdog_deçuÉ
();

871 
cu¼’t_ıu_d©a
 = 
boÙ_ıu_d©a
;

872 
	`cu¼’t_th»ad_šfo
()->
ıu
 = 0;

873 
	`smp_£t_­icids
();

874 
	`£t_ıu_siblšg_m­
(0);

876 ià(
	`smp_§n™y_check
(
max_ıus
) < 0) {

877 
	`´štk
(
KERN_INFO
 "SMP disabled\n");

878 
	`di§bË_smp
();

886 
	`£tup_loÿl_APIC
();

888 ià(
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
)è!ğ
boÙ_ıu_id
) {

889 
	`·nic
("Boot APIC ID in†ocal APIC unexpected (%d vs %d)",

890 
	`GET_APIC_ID
(
	`­ic_»ad
(
APIC_ID
)), 
boÙ_ıu_id
);

897 ià(!
sk_ißpic_£tup
 && 
Ä_ißpics
)

898 
	`£tup_IO_APIC
();

900 
Ä_ißpics
 = 0;

906 
	`£tup_boÙ_APIC_şock
();

907 
	}
}

912 
__š™
 
	$smp_´•¬e_boÙ_ıu
()

914 
me
 = 
	`smp_´oûssÜ_id
();

915 
	`ıu_£t
(
me
, 
ıu_Úlše_m­
);

916 
	`ıu_£t
(
me
, 
ıu_ÿÎout_m­
);

917 
	`³r_ıu
(
ıu_¡©e
, 
me
èğ
CPU_ONLINE
;

918 
	}
}

923 
__ıuš™
 
	$__ıu_up
(
ıu
)

925 
­icid
 = 
	`ıu_´e£Á_to_­icid
(
ıu
);

926 
æags
;

927 
”r
;

929 
	`WARN_ON
(
	`œqs_di§bËd
());

931 
	`D´štk
("++++++++++++++++++++=_---CPU UP %u\n", 
ıu
);

933 ià(
­icid
 =ğ
BAD_APICID
 ||‡picid =ğ
boÙ_ıu_id
 ||

934 !
	`physid_is£t
(
­icid
, 
phys_ıu_´e£Á_m­
)) {

935 
	`´štk
("__ıu_up: bad cpu %d\n", 
ıu
);

936  -
EINVAL
;

942 ià(
	`ıu_is£t
(
ıu
, 
ıu_ÿÎš_m­
)) {

943 
	`D´štk
("do_boÙ_ıu %d AÌ—dy s¹ed\n", 
ıu
);

944  -
ENOSYS
;

951 
	`mŒr_§ve_¡©e
();

953 
	`³r_ıu
(
ıu_¡©e
, 
ıu
èğ
CPU_UP_PREPARE
;

955 
”r
 = 
	`do_boÙ_ıu
(
ıu
, 
­icid
);

956 ià(
”r
 < 0) {

957 
	`D´štk
("do_boÙ_ıu faed %d\n", 
”r
);

958  
”r
;

962 
	`D´štk
("wa™šg fÜ cpu %d\n", 
ıu
);

967 
	`loÿl_œq_§ve
(
æags
);

968 
	`check_tsc_sync_sourû
(
ıu
);

969 
	`loÿl_œq_»¡Üe
(
æags
);

971 !
	`ıu_is£t
(
ıu
, 
ıu_Úlše_m­
))

972 
	`ıu_»Ïx
();

973 
”r
 = 0;

975  
”r
;

976 
	}
}

981 
__š™
 
	$smp_ıus_dÚe
(
max_ıus
)

983 
	`smp_ş—nup_boÙ
();

984 
	`£tup_ißpic_de¡
();

985 
	`check_nmi_w©chdog
();

986 
	}
}

988 #ifdeà
CONFIG_HOTPLUG_CPU


990 
	$»move_siblšgšfo
(
ıu
)

992 
siblšg
;

993 
ıušfo_x86
 *
c
 = &
	`ıu_d©a
(
ıu
);

995 
	`fÜ_—ch_ıu_mask
(
siblšg
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
)) {

996 
	`ıu_ş—r
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
siblšg
));

1000 ià(
	`ıus_weight
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
)) == 1)

1001 
	`ıu_d©a
(
siblšg
).
boÙed_cÜes
--;

1004 
	`fÜ_—ch_ıu_mask
(
siblšg
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
))

1005 
	`ıu_ş—r
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
siblšg
));

1006 
	`ıus_ş—r
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
));

1007 
	`ıus_ş—r
(
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

1008 
c
->
phys_´oc_id
 = 0;

1009 
c
->
ıu_cÜe_id
 = 0;

1010 
	`ıu_ş—r
(
ıu
, 
ıu_siblšg_£tup_m­
);

1011 
	}
}

1013 
	$»move_ıu_äom_m­s
()

1015 
ıu
 = 
	`smp_´oûssÜ_id
();

1017 
	`ıu_ş—r
(
ıu
, 
ıu_ÿÎout_m­
);

1018 
	`ıu_ş—r
(
ıu
, 
ıu_ÿÎš_m­
);

1019 
	`ş—r_b™
(
ıu
, &
ıu_š™Ÿlized
);

1020 
	`ş—r_node_ıumask
(
ıu
);

1021 
	}
}

1023 
	$__ıu_di§bË
()

1025 
ıu
 = 
	`smp_´oûssÜ_id
();

1035 ià(
ıu
 == 0)

1036  -
EBUSY
;

1038 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

1039 
	`¡İ_­ic_nmi_w©chdog
(
NULL
);

1040 
	`ş—r_loÿl_APIC
();

1048 
	`loÿl_œq_’abË
();

1049 
	`md–ay
(1);

1051 
	`loÿl_œq_di§bË
();

1052 
	`»move_siblšgšfo
(
ıu
);

1054 
	`¥š_lock
(&
veùÜ_lock
);

1056 
	`ıu_ş—r
(
ıu
, 
ıu_Úlše_m­
);

1057 
	`¥š_uÆock
(&
veùÜ_lock
);

1058 
	`»move_ıu_äom_m­s
();

1059 
	`fixup_œqs
(
ıu_Úlše_m­
);

1061 
	}
}

1063 
	$__ıu_d›
(
ıu
)

1066 
i
;

1068 
i
 = 0; i < 10; i++) {

1070 ià(
	`³r_ıu
(
ıu_¡©e
, 
ıu
è=ğ
CPU_DEAD
) {

1071 
	`´štk
 ("CPU %d i now ofæše\n", 
ıu
);

1072 ià(1 =ğ
	`num_Úlše_ıus
())

1073 
	`®‹º©ives_smp_sw™ch
(0);

1076 
	`m¦“p
(100);

1078 
	`´štk
(
KERN_ERR
 "CPU %u didn'ˆd›...\n", 
ıu
);

1079 
	}
}

1081 
__š™
 
	$£tup_add™iÚ®_ıus
(*
s
)

1083  
s
 && 
	`g‘_İtiÚ
(&s, &
add™iÚ®_ıus
è? 0 : -
EINVAL
;

1084 
	}
}

1085 
—¾y_·¿m
("add™iÚ®_ıus", 
£tup_add™iÚ®_ıus
);

1089 
	$__ıu_di§bË
()

1091  -
ENOSYS
;

1092 
	}
}

1094 
	$__ıu_d›
(
ıu
)

1097 
	`BUG
();

1098 
	}
}

	@/cmpt816/linux/arch/x86/kernel/suspend_64.c

10 
	~<lšux/smp.h
>

11 
	~<lšux/su¥’d.h
>

12 
	~<asm/´Ùo.h
>

13 
	~<asm/·ge.h
>

14 
	~<asm/pgbË.h
>

15 
	~<asm/mŒr.h
>

18 cÚ¡ 
__no§ve_begš
, 
__no§ve_’d
;

20 
§ved_cÚ‹xt
 
	g§ved_cÚ‹xt
;

22 
	$__§ve_´oûssÜ_¡©e
(
§ved_cÚ‹xt
 *
ùxt
)

24 
	`k”Ãl_åu_begš
();

29 
	`¡Üe_gdt
((
desc_±r
 *)&
ùxt
->
gdt_lim™
);

30 
	`¡Üe_idt
((
desc_±r
 *)&
ùxt
->
idt_lim™
);

31 
	`¡Üe_Œ
(
ùxt
->
Œ
);

37 
asm
 vŞ©("movw %%ds, %0" : "=m" (
ùxt
->
ds
));

38 
asm
 vŞ©("movw %%es, %0" : "=m" (
ùxt
->
es
));

39 
asm
 vŞ©("movw %%fs, %0" : "=m" (
ùxt
->
fs
));

40 
asm
 vŞ©("movw %%gs, %0" : "=m" (
ùxt
->
gs
));

41 
asm
 vŞ©("movw %%ss, %0" : "=m" (
ùxt
->
ss
));

43 
	`rdm¤l
(
MSR_FS_BASE
, 
ùxt
->
fs_ba£
);

44 
	`rdm¤l
(
MSR_GS_BASE
, 
ùxt
->
gs_ba£
);

45 
	`rdm¤l
(
MSR_KERNEL_GS_BASE
, 
ùxt
->
gs_k”Ãl_ba£
);

46 
	`mŒr_§ve_fixed_¿nges
(
NULL
);

51 
	`rdm¤l
(
MSR_EFER
, 
ùxt
->
eãr
);

52 
ùxt
->
ü0
 = 
	`»ad_ü0
();

53 
ùxt
->
ü2
 = 
	`»ad_ü2
();

54 
ùxt
->
ü3
 = 
	`»ad_ü3
();

55 
ùxt
->
ü4
 = 
	`»ad_ü4
();

56 
ùxt
->
ü8
 = 
	`»ad_ü8
();

57 
	}
}

59 
	$§ve_´oûssÜ_¡©e
()

61 
	`__§ve_´oûssÜ_¡©e
(&
§ved_cÚ‹xt
);

62 
	}
}

64 
	$do_åu_’d
()

69 
	`k”Ãl_åu_’d
();

70 
	}
}

72 
	$__»¡Üe_´oûssÜ_¡©e
(
§ved_cÚ‹xt
 *
ùxt
)

77 
	`wrm¤l
(
MSR_EFER
, 
ùxt
->
eãr
);

78 
	`wr™e_ü8
(
ùxt
->
ü8
);

79 
	`wr™e_ü4
(
ùxt
->
ü4
);

80 
	`wr™e_ü3
(
ùxt
->
ü3
);

81 
	`wr™e_ü2
(
ùxt
->
ü2
);

82 
	`wr™e_ü0
(
ùxt
->
ü0
);

88 
	`lßd_gdt
((cÚ¡ 
desc_±r
 *)&
ùxt
->
gdt_lim™
);

89 
	`lßd_idt
((cÚ¡ 
desc_±r
 *)&
ùxt
->
idt_lim™
);

95 
asm
 vŞ©("movw %0, %%ds" :: "r" (
ùxt
->
ds
));

96 
asm
 vŞ©("movw %0, %%es" :: "r" (
ùxt
->
es
));

97 
asm
 vŞ©("movw %0, %%fs" :: "r" (
ùxt
->
fs
));

98 
	`lßd_gs_šdex
(
ùxt
->
gs
);

99 
asm
 vŞ©("movw %0, %%ss" :: "r" (
ùxt
->
ss
));

101 
	`wrm¤l
(
MSR_FS_BASE
, 
ùxt
->
fs_ba£
);

102 
	`wrm¤l
(
MSR_GS_BASE
, 
ùxt
->
gs_ba£
);

103 
	`wrm¤l
(
MSR_KERNEL_GS_BASE
, 
ùxt
->
gs_k”Ãl_ba£
);

105 
	`fix_´oûssÜ_cÚ‹xt
();

107 
	`do_åu_’d
();

108 
	`mŒr_­_š™
();

109 
	}
}

111 
	$»¡Üe_´oûssÜ_¡©e
()

113 
	`__»¡Üe_´oûssÜ_¡©e
(&
§ved_cÚ‹xt
);

114 
	}
}

116 
	$fix_´oûssÜ_cÚ‹xt
()

118 
ıu
 = 
	`smp_´oûssÜ_id
();

119 
tss_¡ruù
 *
t
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

121 
	`£t_tss_desc
(
ıu
,
t
);

123 
	`ıu_gdt
(
ıu
)[
GDT_ENTRY_TSS
].
ty³
 = 9;

125 
	`sysÿÎ_š™
();

126 
	`lßd_TR_desc
();

127 
	`lßd_LDT
(&
cu¼’t
->
aùive_mm
->
cÚ‹xt
);

132 ià(
cu¼’t
->
th»ad
.
debug»g7
){

133 
	`lßddebug
(&
cu¼’t
->
th»ad
, 0);

134 
	`lßddebug
(&
cu¼’t
->
th»ad
, 1);

135 
	`lßddebug
(&
cu¼’t
->
th»ad
, 2);

136 
	`lßddebug
(&
cu¼’t
->
th»ad
, 3);

138 
	`lßddebug
(&
cu¼’t
->
th»ad
, 6);

139 
	`lßddebug
(&
cu¼’t
->
th»ad
, 7);

142 
	}
}

144 #ifdeà
CONFIG_HIBERNATION


146 
»¡Üe_image
();

152 
	g»¡Üe_jump_add»ss
;

158 
	g»¡Üe_ü3
;

160 
pgd_t
 *
	g‹mp_Ëv–4_pgt
;

162 *
	g»loÿ‹d_»¡Üe_code
;

164 
	$»s_phys_pud_š™
(
pud_t
 *
pud
, 
add»ss
, 
’d
)

166 
i
, 
j
;

168 
i
 = 
	`pud_šdex
(
add»ss
);

169 
pud
 =…ud + 
i
;

170 ; 
i
 < 
PTRS_PER_PUD
; 
pud
++, i++) {

171 
·ddr
;

172 
pmd_t
 *
pmd
;

174 
·ddr
 = 
add»ss
 + 
i
*
PUD_SIZE
;

175 ià(
·ddr
 >ğ
’d
)

178 
pmd
 = (
pmd_t
 *)
	`g‘_§ã_·ge
(
GFP_ATOMIC
);

179 ià(!
pmd
)

180  -
ENOMEM
;

181 
	`£t_pud
(
pud
, 
	`__pud
(
	`__·
(
pmd
è| 
_KERNPG_TABLE
));

182 
j
 = 0; j < 
PTRS_PER_PMD
; 
pmd
++, j++, 
·ddr
 +ğ
PMD_SIZE
) {

183 
³
;

185 ià(
·ddr
 >ğ
’d
)

187 
³
 = 
__PAGE_KERNEL_LARGE_EXEC
 | 
·ddr
;

188 
³
 &ğ
__suµÜ‹d_±e_mask
;

189 
	`£t_pmd
(
pmd
, 
	`__pmd
(
³
));

193 
	}
}

195 
	$£t_up_‹mpÜ¬y_m­pšgs
()

197 
¡¬t
, 
’d
, 
Ãxt
;

198 
”rÜ
;

200 
‹mp_Ëv–4_pgt
 = (
pgd_t
 *)
	`g‘_§ã_·ge
(
GFP_ATOMIC
);

201 ià(!
‹mp_Ëv–4_pgt
)

202  -
ENOMEM
;

205 
	`£t_pgd
(
‹mp_Ëv–4_pgt
 + 
	`pgd_šdex
(
__START_KERNEL_m­
),

206 
š™_Ëv–4_pgt
[
	`pgd_šdex
(
__START_KERNEL_m­
)]);

209 
¡¬t
 = ()
	`pâ_to_kaddr
(0);

210 
’d
 = ()
	`pâ_to_kaddr
(
’d_pâ
);

212 ; 
¡¬t
 < 
’d
; s¹ = 
Ãxt
) {

213 
pud_t
 *
pud
 = (pud_ˆ*)
	`g‘_§ã_·ge
(
GFP_ATOMIC
);

214 ià(!
pud
)

215  -
ENOMEM
;

216 
Ãxt
 = 
¡¬t
 + 
PGDIR_SIZE
;

217 ià(
Ãxt
 > 
’d
)

218 
Ãxt
 = 
’d
;

219 ià((
”rÜ
 = 
	`»s_phys_pud_š™
(
pud
, 
	`__·
(
¡¬t
), __·(
Ãxt
))))

220  
”rÜ
;

221 
	`£t_pgd
(
‹mp_Ëv–4_pgt
 + 
	`pgd_šdex
(
¡¬t
),

222 
	`mk_k”Ãl_pgd
(
	`__·
(
pud
)));

225 
	}
}

227 
	$swsu¥_¬ch_»sume
()

229 
”rÜ
;

232 ià((
”rÜ
 = 
	`£t_up_‹mpÜ¬y_m­pšgs
()))

233  
”rÜ
;

235 
»loÿ‹d_»¡Üe_code
 = (*)
	`g‘_§ã_·ge
(
GFP_ATOMIC
);

236 ià(!
»loÿ‹d_»¡Üe_code
)

237  -
ENOMEM
;

238 
	`memıy
(
»loÿ‹d_»¡Üe_code
, &
cÜe_»¡Üe_code
,

239 &
»¡Üe_»gi¡”s
 - &
cÜe_»¡Üe_code
);

241 
	`»¡Üe_image
();

243 
	}
}

249 
	$pâ_is_no§ve
(
pâ
)

251 
no§ve_begš_pâ
 = 
	`__·_symbŞ
(&
__no§ve_begš
è>> 
PAGE_SHIFT
;

252 
no§ve_’d_pâ
 = 
	`PAGE_ALIGN
(
	`__·_symbŞ
(&
__no§ve_’d
)è>> 
PAGE_SHIFT
;

253  (
pâ
 >ğ
no§ve_begš_pâ
è&& (pâ < 
no§ve_’d_pâ
);

254 
	}
}

256 
	s»¡Üe_d©a_»cÜd
 {

257 
	mjump_add»ss
;

258 
	mü3
;

259 
	mmagic
;

262 
	#RESTORE_MAGIC
 0x0123456789ABCDEFUL

	)

269 
	$¬ch_hib”ÇtiÚ_h—d”_§ve
(*
addr
, 
max_size
)

271 
»¡Üe_d©a_»cÜd
 *
rdr
 = 
addr
;

273 ià(
max_size
 < (
»¡Üe_d©a_»cÜd
))

274  -
EOVERFLOW
;

275 
rdr
->
jump_add»ss
 = 
»¡Üe_jump_add»ss
;

276 
rdr
->
ü3
 = 
»¡Üe_ü3
;

277 
rdr
->
magic
 = 
RESTORE_MAGIC
;

279 
	}
}

286 
	$¬ch_hib”ÇtiÚ_h—d”_»¡Üe
(*
addr
)

288 
»¡Üe_d©a_»cÜd
 *
rdr
 = 
addr
;

290 
»¡Üe_jump_add»ss
 = 
rdr
->
jump_add»ss
;

291 
»¡Üe_ü3
 = 
rdr
->
ü3
;

292  (
rdr
->
magic
 =ğ
RESTORE_MAGIC
è? 0 : -
EINVAL
;

293 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<lšux/”ºo.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/sysÿÎs.h
>

4 
	~<lšux/mm.h
>

5 
	~<lšux/fs.h
>

6 
	~<lšux/smp.h
>

7 
	~<lšux/£m.h
>

8 
	~<lšux/msg.h
>

9 
	~<lšux/shm.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/mmª.h
>

12 
	~<lšux/fe.h
>

13 
	~<lšux/ut¢ame.h
>

14 
	~<lšux/³rsÚ®™y.h
>

16 
	~<asm/uacûss.h
>

17 
	~<asm/Ÿ32.h
>

23 
asmlškage
 
	$sys_pe
(
__u£r
 *
fdes
)

25 
fd
[2];

26 
”rÜ
;

28 
”rÜ
 = 
	`do_pe
(
fd
);

29 ià(!
”rÜ
) {

30 ià(
	`cİy_to_u£r
(
fdes
, 
fd
, 2*()))

31 
”rÜ
 = -
EFAULT
;

33  
”rÜ
;

34 
	}
}

36 
asmlškage
 
	$sys_mm­
(
addr
, 
Ën
, 
´Ù
, 
æags
,

37 
fd
, 
off
)

39 
”rÜ
;

40 
fe
 * file;

42 
”rÜ
 = -
EINVAL
;

43 ià(
off
 & ~
PAGE_MASK
)

44 
out
;

46 
”rÜ
 = -
EBADF
;

47 
fe
 = 
NULL
;

48 
æags
 &ğ~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

49 ià(!(
æags
 & 
MAP_ANONYMOUS
)) {

50 
fe
 = 
	`fg‘
(
fd
);

51 ià(!
fe
)

52 
out
;

54 
	`down_wr™e
(&
cu¼’t
->
mm
->
mm­_£m
);

55 
”rÜ
 = 
	`do_mm­_pgoff
(
fe
, 
addr
, 
Ën
, 
´Ù
, 
æags
, 
off
 >> 
PAGE_SHIFT
);

56 
	`up_wr™e
(&
cu¼’t
->
mm
->
mm­_£m
);

58 ià(
fe
)

59 
	`åut
(
fe
);

60 
out
:

61  
”rÜ
;

62 
	}
}

64 
	$fšd_¡¬t_’d
(
æags
, *
begš
,

65 *
’d
)

67 ià(!
	`‹¡_th»ad_æag
(
TIF_IA32
è&& (
æags
 & 
MAP_32BIT
)) {

75 *
begš
 = 0x40000000;

76 *
’d
 = 0x80000000;

78 *
begš
 = 
TASK_UNMAPPED_BASE
;

79 *
’d
 = 
TASK_SIZE
;

81 
	}
}

84 
	$¬ch_g‘_unm­³d_¬—
(
fe
 *
fp
, 
addr
,

85 
Ën
, 
pgoff
, 
æags
)

87 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

88 
vm_¬—_¡ruù
 *
vma
;

89 
¡¬t_addr
;

90 
begš
, 
’d
;

92 ià(
æags
 & 
MAP_FIXED
)

93  
addr
;

95 
	`fšd_¡¬t_’d
(
æags
, &
begš
, &
’d
);

97 ià(
Ën
 > 
’d
)

98  -
ENOMEM
;

100 ià(
addr
) {

101 
addr
 = 
	`PAGE_ALIGN
(addr);

102 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

103 ià(
’d
 - 
Ën
 >ğ
addr
 &&

104 (!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
))

105  
addr
;

107 ià(((
æags
 & 
MAP_32BIT
è|| 
	`‹¡_th»ad_æag
(
TIF_IA32
))

108 && 
Ën
 <ğ
mm
->
ÿched_hŞe_size
) {

109 
mm
->
ÿched_hŞe_size
 = 0;

110 
mm
->
ä“_¬—_ÿche
 = 
begš
;

112 
addr
 = 
mm
->
ä“_¬—_ÿche
;

113 ià(
addr
 < 
begš
)

114 
addr
 = 
begš
;

115 
¡¬t_addr
 = 
addr
;

117 
fuÎ_£¬ch
:

118 
vma
 = 
	`fšd_vma
(
mm
, 
addr
); ; vm¨ğvma->
vm_Ãxt
) {

120 ià(
’d
 - 
Ën
 < 
addr
) {

125 ià(
¡¬t_addr
 !ğ
begš
) {

126 
¡¬t_addr
 = 
addr
 = 
begš
;

127 
mm
->
ÿched_hŞe_size
 = 0;

128 
fuÎ_£¬ch
;

130  -
ENOMEM
;

132 ià(!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
) {

136 
mm
->
ä“_¬—_ÿche
 = 
addr
 + 
Ën
;

137  
addr
;

139 ià(
addr
 + 
mm
->
ÿched_hŞe_size
 < 
vma
->
vm_¡¬t
)

140 
mm
->
ÿched_hŞe_size
 = 
vma
->
vm_¡¬t
 - 
addr
;

142 
addr
 = 
vma
->
vm_’d
;

144 
	}
}

146 
asmlškage
 
	$sys_uÇme
(
Ãw_ut¢ame
 
__u£r
 * 
Çme
)

148 
”r
;

149 
	`down_»ad
(&
uts_£m
);

150 
”r
 = 
	`cİy_to_u£r
(
Çme
, 
	`ut¢ame
(),  (*name));

151 
	`up_»ad
(&
uts_£m
);

152 ià(
	`³rsÚ®™y
(
cu¼’t
->
³rsÚ®™y
è=ğ
PER_LINUX32
)

153 
”r
 |ğ
	`cİy_to_u£r
(&
Çme
->
machše
, "i686", 5);

154  
”r
 ? -
EFAULT
 : 0;

155 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<lšux/lškage.h
>

4 
	~<lšux/sys.h
>

5 
	~<lšux/ÿche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
Ä
, 
sym
è
asmlškage
 
	`sym
(è;

	)

11 #undeà
_ASM_X86_64_UNISTD_H_


12 
	~<asm/uni¡d_64.h
>

14 #undeà
__SYSCALL


15 
	#__SYSCALL
(
Ä
, 
sym
è[‚¸] = sym,

	)

16 #undeà
_ASM_X86_64_UNISTD_H_


18 (*
	tsys_ÿÎ_±r_t
)();

20 
	`sys_ni_sysÿÎ
();

22 cÚ¡ 
sys_ÿÎ_±r_t
 
sys_ÿÎ_bË
[
__NR_sysÿÎ_max
+1] = {

24 [0 ... 
__NR_sysÿÎ_max
] = &
sys_ni_sysÿÎ
,

25 
	~<asm/uni¡d_64.h
>

26 
	}
};

	@/cmpt816/linux/arch/x86/kernel/time_64.c

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/š‹¼u±.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/mc146818¹c.h
>

19 
	~<lšux/time.h
>

20 
	~<lšux/iİÜt.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/deviû.h
>

23 
	~<lšux/sysdev.h
>

24 
	~<lšux/bcd.h
>

25 
	~<lšux/nÙif›r.h
>

26 
	~<lšux/ıu.h
>

27 
	~<lšux/k®lsyms.h
>

28 
	~<lšux/aıi.h
>

29 
	~<lšux/şockchs.h
>

31 #ifdeà
CONFIG_ACPI


32 
	~<aıi/achw¬e.h
>

33 
	~<aıi/aıi_bus.h
>

35 
	~<asm/i8253.h
>

36 
	~<asm/pgbË.h
>

37 
	~<asm/vsysÿÎ.h
>

38 
	~<asm/timex.h
>

39 
	~<asm/´Ùo.h
>

40 
	~<asm/h³t.h
>

41 
	~<asm/£ùiÚs.h
>

42 
	~<lšux/h³t.h
>

43 
	~<asm/­ic.h
>

44 
	~<asm/h³t.h
>

45 
	~<asm/mp¥ec.h
>

46 
	~<asm/nmi.h
>

47 
	~<asm/vgtod.h
>

49 
DEFINE_SPINLOCK
(
¹c_lock
);

50 
EXPORT_SYMBOL
(
¹c_lock
);

52 vŞ©
__jiff›s
 
	g__£ùiÚ_jiff›s
 = 
INITIAL_JIFFIES
;

54 
	$´ofe_pc
(
±_»gs
 *
»gs
)

56 
pc
 = 
	`š¡ruùiÚ_poš‹r
(
»gs
);

61 ià(!
	`u£r_mode
(
»gs
è&& 
	`š_lock_funùiÚs
(
pc
)) {

62 *
¥
 = (*)
»gs
->
r¥
;

63 ià(
¥
[0] >> 22)

64  
¥
[0];

65 ià(
¥
[1] >> 22)

66  
¥
[1];

68  
pc
;

69 
	}
}

70 
EXPORT_SYMBOL
(
´ofe_pc
);

80 
	$£t_¹c_mmss
(
nowtime
)

82 
»tv®
 = 0;

83 
»®_£cÚds
, 
»®_mšu‹s
, 
cmos_mšu‹s
;

84 
cÚŒŞ
, 
äeq_£Ëù
;

85 
æags
;

90 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

94 
cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

95 
	`CMOS_WRITE
(
cÚŒŞ
 | 
RTC_SET
, 
RTC_CONTROL
);

97 
äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

98 
	`CMOS_WRITE
(
äeq_£Ëù
 | 
RTC_DIV_RESET2
, 
RTC_FREQ_SELECT
);

100 
cmos_mšu‹s
 = 
	`CMOS_READ
(
RTC_MINUTES
);

101 
	`BCD_TO_BIN
(
cmos_mšu‹s
);

110 
»®_£cÚds
 = 
nowtime
 % 60;

111 
»®_mšu‹s
 = 
nowtime
 / 60;

112 ià(((
	`abs
(
»®_mšu‹s
 - 
cmos_mšu‹s
) + 15) / 30) & 1)

113 
»®_mšu‹s
 += 30;

114 
»®_mšu‹s
 %= 60;

116 ià(
	`abs
(
»®_mšu‹s
 - 
cmos_mšu‹s
) >= 30) {

117 
	`´štk
(
KERN_WARNING
 "time.c: can't update CMOS clock "

118 "äom %dØ%d\n", 
cmos_mšu‹s
, 
»®_mšu‹s
);

119 
»tv®
 = -1;

121 
	`BIN_TO_BCD
(
»®_£cÚds
);

122 
	`BIN_TO_BCD
(
»®_mšu‹s
);

123 
	`CMOS_WRITE
(
»®_£cÚds
, 
RTC_SECONDS
);

124 
	`CMOS_WRITE
(
»®_mšu‹s
, 
RTC_MINUTES
);

135 
	`CMOS_WRITE
(
cÚŒŞ
, 
RTC_CONTROL
);

136 
	`CMOS_WRITE
(
äeq_£Ëù
, 
RTC_FREQ_SELECT
);

138 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

140  
»tv®
;

141 
	}
}

143 
	$upd©e_³rsi¡’t_şock
(
time¥ec
 
now
)

145  
	`£t_¹c_mmss
(
now
.
tv_£c
);

146 
	}
}

148 
œq»tuº_t
 
	$tim”_ev’t_š‹¼u±
(
œq
, *
dev_id
)

150 
	`add_pda
(
œq0_œqs
, 1);

152 
glob®_şock_ev’t
->
	`ev’t_hªdËr
(global_clock_event);

154  
IRQ_HANDLED
;

155 
	}
}

157 
	$»ad_³rsi¡’t_şock
()

159 
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
;

160 
æags
;

161 
ûÁury
 = 0;

163 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

169 (
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
))

170 
	`ıu_»Ïx
();

174 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

175 
mš
 = 
	`CMOS_READ
(
RTC_MINUTES
);

176 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

177 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

178 
mÚ
 = 
	`CMOS_READ
(
RTC_MONTH
);

179 
y—r
 = 
	`CMOS_READ
(
RTC_YEAR
);

180 #ifdeà
CONFIG_ACPI


181 ià(
aıi_gbl_FADT
.
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
 &&

182 
aıi_gbl_FADT
.
ûÁury
)

183 
ûÁury
 = 
	`CMOS_READ
(
aıi_gbl_FADT
.century);

185 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

192 
	`BCD_TO_BIN
(
£c
);

193 
	`BCD_TO_BIN
(
mš
);

194 
	`BCD_TO_BIN
(
hour
);

195 
	`BCD_TO_BIN
(
day
);

196 
	`BCD_TO_BIN
(
mÚ
);

197 
	`BCD_TO_BIN
(
y—r
);

199 ià(
ûÁury
) {

200 
	`BCD_TO_BIN
(
ûÁury
);

201 
y—r
 +ğ
ûÁury
 * 100;

202 
	`´štk
(
KERN_INFO
 "Ex‹nded CMOS y—r: %d\n", 
ûÁury
 * 100);

208 
y—r
 += 2000;

211  
	`mktime
(
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
);

212 
	}
}

216 
	#TICK_COUNT
 100000000

	)

217 
__š™
 
	$tsc_ÿlib¿‹_ıu_khz
()

219 
tsc_¡¬t
, 
tsc_now
;

220 
i
, 
no_ùr_ä“
;

221 
evÁ£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

222 
æags
;

224 
i
 = 0; i < 4; i++)

225 ià(
	`ava_to_»¤v_³rfùr_nmi_b™
(
i
))

227 
no_ùr_ä“
 = (
i
 == 4);

228 ià(
no_ùr_ä“
) {

229 
i
 = 3;

230 
	`rdm¤l
(
MSR_K7_EVNTSEL3
, 
evÁ£l3
);

231 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 0);

232 
	`rdm¤l
(
MSR_K7_PERFCTR3
, 
pmc3
);

234 
	`»£rve_³rfùr_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

235 
	`»£rve_evÁ£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

237 
	`loÿl_œq_§ve
(
æags
);

239 
	`wrm¤l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

240 
	`wrm¤l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

241 
	`rdtsş
(
tsc_¡¬t
);

243 
	`rdm¤l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

244 
tsc_now
 = 
	`g‘_cyşes_sync
();

245 } (
tsc_now
 - 
tsc_¡¬t
è< 
TICK_COUNT
);

247 
	`loÿl_œq_»¡Üe
(
æags
);

248 ià(
no_ùr_ä“
) {

249 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 0);

250 
	`wrm¤l
(
MSR_K7_PERFCTR3
, 
pmc3
);

251 
	`wrm¤l
(
MSR_K7_EVNTSEL3
, 
evÁ£l3
);

253 
	`»Ëa£_³rfùr_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

254 
	`»Ëa£_evÁ£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

257  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_¡¬t
);

258 
	}
}

260 
œqaùiÚ
 
	gœq0
 = {

261 .
hªdËr
 = 
tim”_ev’t_š‹¼u±
,

262 .
	gæags
 = 
IRQF_DISABLED
 | 
IRQF_IRQPOLL
 | 
IRQF_NOBALANCING
,

263 .
	gmask
 = 
CPU_MASK_NONE
,

264 .
	gÇme
 = "timer"

267 
__š™
 
	$time_š™
()

269 ià(!
	`h³t_’abË
())

270 
	`£tup_p™_tim”
();

272 
	`£tup_œq
(0, &
œq0
);

274 
	`tsc_ÿlib¿‹
();

276 
ıu_khz
 = 
tsc_khz
;

277 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

278 
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 &&

279 
boÙ_ıu_d©a
.
x86
 == 16)

280 
ıu_khz
 = 
	`tsc_ÿlib¿‹_ıu_khz
();

282 ià(
	`unsynchrÚized_tsc
())

283 
	`m¬k_tsc_un¡abË
("TSCs unsynchronized");

285 ià(
	`ıu_has
(&
boÙ_ıu_d©a
, 
X86_FEATURE_RDTSCP
))

286 
vg‘ıu_mode
 = 
VGETCPU_RDTSCP
;

288 
vg‘ıu_mode
 = 
VGETCPU_LSL
;

290 
	`´štk
(
KERN_INFO
 "time.c: Detected %d.%03d MHz…rocessor.\n",

291 
ıu_khz
 / 1000, cpu_khz % 1000);

292 
	`š™_tsc_şocksourû
();

293 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<lšux/š™.h
>

29 
	~<lšux/smp.h
>

30 
	~<lšux/nodemask.h
>

31 
	~<lšux/mmzÚe.h
>

32 
	~<asm/ıu.h
>

34 
i386_ıu
 
	gıu_deviûs
[
NR_CPUS
];

36 
__ıuš™
 
	$¬ch_»gi¡”_ıu
(
num
)

47 #ifdeà
CONFIG_HOTPLUG_CPU


48 ià(
num
)

49 
ıu_deviûs
[
num
].
ıu
.
hÙ¶uggabË
 = 1;

52  
	`»gi¡”_ıu
(&
ıu_deviûs
[
num
].
ıu
,‚um);

53 
	}
}

55 #ifdeà
CONFIG_HOTPLUG_CPU


56 
	$¬ch_uÄegi¡”_ıu
(
num
)

58  
	`uÄegi¡”_ıu
(&
ıu_deviûs
[
num
].
ıu
);

59 
	}
}

60 
EXPORT_SYMBOL
(
¬ch_»gi¡”_ıu
);

61 
EXPORT_SYMBOL
(
¬ch_uÄegi¡”_ıu
);

64 
__š™
 
	$tİŞogy_š™
()

66 
i
;

68 #ifdeà
CONFIG_NUMA


69 
	`fÜ_—ch_Úlše_node
(
i
)

70 
	`»gi¡”_Úe_node
(
i
);

73 
	`fÜ_—ch_´e£Á_ıu
(
i
)

74 
	`¬ch_»gi¡”_ıu
(
i
);

76 
	}
}

78 
subsys_š™ÿÎ
(
tİŞogy_š™
);

	@/cmpt816/linux/arch/x86/kernel/traps_64.c

13 
	~<lšux/sched.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/±¿û.h
>

18 
	~<lšux/tim”.h
>

19 
	~<lšux/mm.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/d–ay.h
>

22 
	~<lšux/¥šlock.h
>

23 
	~<lšux/š‹¼u±.h
>

24 
	~<lšux/k®lsyms.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/moduË·¿m.h
>

27 
	~<lšux/nmi.h
>

28 
	~<lšux/k´obes.h
>

29 
	~<lšux/kexec.h
>

30 
	~<lšux/unwšd.h
>

31 
	~<lšux/uacûss.h
>

32 
	~<lšux/bug.h
>

33 
	~<lšux/kdebug.h
>

34 
	~<lšux/ut¢ame.h
>

36 #ià
defšed
(
CONFIG_EDAC
)

37 
	~<lšux/edac.h
>

40 
	~<asm/sy¡em.h
>

41 
	~<asm/io.h
>

42 
	~<asm/©omic.h
>

43 
	~<asm/debug»g.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/i387.h
>

46 
	~<asm/´oûssÜ.h
>

47 
	~<asm/unwšd.h
>

48 
	~<asm/smp.h
>

49 
	~<asm/pg®loc.h
>

50 
	~<asm/pda.h
>

51 
	~<asm/´Ùo.h
>

52 
	~<asm/nmi.h
>

53 
	~<asm/¡ackŒaû.h
>

55 
asmlškage
 
divide_”rÜ
();

56 
asmlškage
 
debug
();

57 
asmlškage
 
nmi
();

58 
asmlškage
 
št3
();

59 
asmlškage
 
ov”æow
();

60 
asmlškage
 
bounds
();

61 
asmlškage
 
šv®id_İ
();

62 
asmlškage
 
deviû_nÙ_avaabË
();

63 
asmlškage
 
doubË_çuÉ
();

64 
asmlškage
 
cİroûssÜ_£gm’t_ov”run
();

65 
asmlškage
 
šv®id_TSS
();

66 
asmlškage
 
£gm’t_nÙ_´e£Á
();

67 
asmlškage
 
¡ack_£gm’t
();

68 
asmlškage
 
g’”®_´ÙeùiÚ
();

69 
asmlškage
 
·ge_çuÉ
();

70 
asmlškage
 
cİroûssÜ_”rÜ
();

71 
asmlškage
 
simd_cİroûssÜ_”rÜ
();

72 
asmlškage
 
»£rved
();

73 
asmlškage
 
®ignm’t_check
();

74 
asmlškage
 
machše_check
();

75 
asmlškage
 
¥urious_š‹¼u±_bug
();

77 
šlše
 
	$cÚd™iÚ®_¡i
(
±_»gs
 *
»gs
)

79 ià(
»gs
->
eæags
 & 
X86_EFLAGS_IF
)

80 
	`loÿl_œq_’abË
();

81 
	}
}

83 
šlše
 
	$´“m±_cÚd™iÚ®_¡i
(
±_»gs
 *
»gs
)

85 
	`´“m±_di§bË
();

86 ià(
»gs
->
eæags
 & 
X86_EFLAGS_IF
)

87 
	`loÿl_œq_’abË
();

88 
	}
}

90 
šlše
 
	$´“m±_cÚd™iÚ®_şi
(
±_»gs
 *
»gs
)

92 ià(
»gs
->
eæags
 & 
X86_EFLAGS_IF
)

93 
	`loÿl_œq_di§bË
();

96 
	`´“m±_’abË_no_»sched
();

97 
	}
}

99 
	gk¡ack_d•th_to_´št
 = 12;

101 #ifdeà
CONFIG_KALLSYMS


102 
	$´štk_add»ss
(
add»ss
)

104 
off£t
 = 0, 
symsize
;

105 cÚ¡ *
symÇme
;

106 *
modÇme
;

107 *
d–im
 = ":";

108 
Çmebuf
[128];

110 
symÇme
 = 
	`k®lsyms_lookup
(
add»ss
, &
symsize
, &
off£t
,

111 &
modÇme
, 
Çmebuf
);

112 ià(!
symÇme
) {

113 
	`´štk
(" [<%016lx>]\n", 
add»ss
);

116 ià(!
modÇme
)

117 
modÇme
 = 
d–im
 = "";

118 
	`´štk
(" [<%016lx>] %s%s%s%s+0x%lx/0x%lx\n",

119 
add»ss
, 
d–im
, 
modÇme
, d–im, 
symÇme
, 
off£t
, 
symsize
);

120 
	}
}

122 
	$´štk_add»ss
(
add»ss
)

124 
	`´štk
(" [<%016lx>]\n", 
add»ss
);

125 
	}
}

128 *
	$š_exû±iÚ_¡ack
(
ıu
, 
¡ack
,

129 *
u£dp
, **
idp
)

131 
ids
[][8] = {

132 [
DEBUG_STACK
 - 1] = "#DB",

133 [
NMI_STACK
 - 1] = "NMI",

134 [
DOUBLEFAULT_STACK
 - 1] = "#DF",

135 [
STACKFAULT_STACK
 - 1] = "#SS",

136 [
MCE_STACK
 - 1] = "#MC",

137 #ià
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


138 [
N_EXCEPTION_STACKS
 ... N_EXCEPTION_STACKS + 
DEBUG_STKSZ
 / 
EXCEPTION_STKSZ
 - 2] = "#DB[?]"

141 
k
;

147 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

148 
’d
 = 
	`³r_ıu
(
Üig_i¡
, 
ıu
).
i¡
[
k
];

153 ià(
¡ack
 >ğ
’d
)

159 ià(
¡ack
 >ğ
’d
 - 
EXCEPTION_STKSZ
) {

166 ià(*
u£dp
 & (1U << 
k
))

168 *
u£dp
 |ğ1U << 
k
;

169 *
idp
 = 
ids
[
k
];

170  (*)
’d
;

177 #ià
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


178 ià(
k
 =ğ
DEBUG_STACK
 - 1 && 
¡ack
 >ğ
’d
 - 
DEBUG_STKSZ
) {

179 
j
 = 
N_EXCEPTION_STACKS
 - 1;

187 ++
j
;

188 
’d
 -ğ
EXCEPTION_STKSZ
;

189 
ids
[
j
][4] = '1' + (j - 
N_EXCEPTION_STACKS
);

190 } 
¡ack
 < 
’d
 - 
EXCEPTION_STKSZ
);

191 ià(*
u£dp
 & (1U << 
j
))

193 *
u£dp
 |ğ1U << 
j
;

194 *
idp
 = 
ids
[
j
];

195  (*)
’d
;

199  
NULL
;

200 
	}
}

202 
	#MSG
(
txt
è
İs
->
	`w¬nšg
(
d©a
,xt)

	)

211 
šlše
 
	$v®id_¡ack_±r
(
th»ad_šfo
 *
tšfo
, *
p
)

213 *
t
 = (*)
tšfo
;

214  
p
 > 
t
 &&… < + 
THREAD_SIZE
 - 3;

215 
	}
}

217 
	$dump_Œaû
(
sk_¡ruù
 *
tsk
, 
±_»gs
 *
»gs
,

218 *
¡ack
,

219 cÚ¡ 
¡ackŒaû_İs
 *
İs
, *
d©a
)

221 cÚ¡ 
ıu
 = 
	`g‘_ıu
();

222 *
œq¡ack_’d
 = (*)
	`ıu_pda
(
ıu
)->
œq¡ack±r
;

223 
u£d
 = 0;

224 
th»ad_šfo
 *
tšfo
;

226 ià(!
tsk
)

227 
tsk
 = 
cu¼’t
;

229 ià(!
¡ack
) {

230 
dummy
;

231 
¡ack
 = &
dummy
;

232 ià(
tsk
 &&sk !ğ
cu¼’t
)

233 
¡ack
 = (*)
tsk
->
th»ad
.
r¥
;

241 
	#HANDLE_STACK
(
cÚd
) \

242 dØ
cÚd
) { \

243 
addr
 = *
¡ack
++; \

246 ià(
	`__k”Ãl_‹xt_add»ss
(
addr
)) { \

255 
İs
->
	`add»ss
(
d©a
, 
addr
); \

257 } 0)

	)

265 *
id
;

266 *
e¡ack_’d
;

267 
e¡ack_’d
 = 
	`š_exû±iÚ_¡ack
(
ıu
, ()
¡ack
,

268 &
u£d
, &
id
);

270 ià(
e¡ack_’d
) {

271 ià(
İs
->
	`¡ack
(
d©a
, 
id
) < 0)

273 
	`HANDLE_STACK
 (
¡ack
 < 
e¡ack_’d
);

274 
İs
->
	`¡ack
(
d©a
, "<EOE>");

280 
¡ack
 = (*è
e¡ack_’d
[-2];

283 ià(
œq¡ack_’d
) {

284 *
œq¡ack
;

285 
œq¡ack
 = 
œq¡ack_’d
 -

286 (
IRQSTACKSIZE
 - 64è/ (*
œq¡ack
);

288 ià(
¡ack
 >ğ
œq¡ack
 && sck < 
œq¡ack_’d
) {

289 ià(
İs
->
	`¡ack
(
d©a
, "IRQ") < 0)

291 
	`HANDLE_STACK
 (
¡ack
 < 
œq¡ack_’d
);

297 
¡ack
 = (*è(
œq¡ack_’d
[-1]);

298 
œq¡ack_’d
 = 
NULL
;

299 
İs
->
	`¡ack
(
d©a
, "EOI");

309 
tšfo
 = 
	`sk_th»ad_šfo
(
tsk
);

310 
	`HANDLE_STACK
 (
	`v®id_¡ack_±r
(
tšfo
, 
¡ack
));

311 #undeà
HANDLE_STACK


312 
	`put_ıu
();

313 
	}
}

314 
EXPORT_SYMBOL
(
dump_Œaû
);

317 
	$´št_Œaû_w¬nšg_symbŞ
(*
d©a
, *
msg
, 
symbŞ
)

319 
	`´št_symbŞ
(
msg
, 
symbŞ
);

320 
	`´štk
("\n");

321 
	}
}

323 
	$´št_Œaû_w¬nšg
(*
d©a
, *
msg
)

325 
	`´štk
("%s\n", 
msg
);

326 
	}
}

328 
	$´št_Œaû_¡ack
(*
d©a
, *
Çme
)

330 
	`´štk
(" <%s> ", 
Çme
);

332 
	}
}

334 
	$´št_Œaû_add»ss
(*
d©a
, 
addr
)

336 
	`touch_nmi_w©chdog
();

337 
	`´štk_add»ss
(
addr
);

338 
	}
}

340 cÚ¡ 
¡ackŒaû_İs
 
	g´št_Œaû_İs
 = {

341 .
w¬nšg
 = 
´št_Œaû_w¬nšg
,

342 .
	gw¬nšg_symbŞ
 = 
´št_Œaû_w¬nšg_symbŞ
,

343 .
	g¡ack
 = 
´št_Œaû_¡ack
,

344 .
	gadd»ss
 = 
´št_Œaû_add»ss
,

348 
	$show_Œaû
(
sk_¡ruù
 *
tsk
, 
±_»gs
 *
»gs
, *
¡ack
)

350 
	`´štk
("\nCall Trace:\n");

351 
	`dump_Œaû
(
tsk
, 
»gs
, 
¡ack
, &
´št_Œaû_İs
, 
NULL
);

352 
	`´štk
("\n");

353 
	}
}

356 
	$_show_¡ack
(
sk_¡ruù
 *
tsk
, 
±_»gs
 *
»gs
, *
r¥
)

358 *
¡ack
;

359 
i
;

360 cÚ¡ 
ıu
 = 
	`smp_´oûssÜ_id
();

361 *
œq¡ack_’d
 = (*è(
	`ıu_pda
(
ıu
)->
œq¡ack±r
);

362 *
œq¡ack
 = (*è(
	`ıu_pda
(
ıu
)->
œq¡ack±r
 - 
IRQSTACKSIZE
);

367 ià(
r¥
 =ğ
NULL
) {

368 ià(
tsk
)

369 
r¥
 = (*)
tsk
->
th»ad
.rsp;

371 
r¥
 = (*)&rsp;

374 
¡ack
 = 
r¥
;

375 
i
=0; i < 
k¡ack_d•th_to_´št
; i++) {

376 ià(
¡ack
 >ğ
œq¡ack
 && sck <ğ
œq¡ack_’d
) {

377 ià(
¡ack
 =ğ
œq¡ack_’d
) {

378 
¡ack
 = (*è(
œq¡ack_’d
[-1]);

379 
	`´štk
(" <EOI> ");

382 ià(((è
¡ack
 & (
THREAD_SIZE
-1)) == 0)

385 ià(
i
 && ((i % 4) == 0))

386 
	`´štk
("\n");

387 
	`´štk
(" %016lx", *
¡ack
++);

388 
	`touch_nmi_w©chdog
();

390 
	`show_Œaû
(
tsk
, 
»gs
, 
r¥
);

391 
	}
}

393 
	$show_¡ack
(
sk_¡ruù
 *
tsk
, * 
r¥
)

395 
	`_show_¡ack
(
tsk
, 
NULL
, 
r¥
);

396 
	}
}

401 
	$dump_¡ack
()

403 
dummy
;

405 
	`´štk
("Pid: %d, comm: %.20s %s %s %.*s\n",

406 
cu¼’t
->
pid
, cu¼’t->
comm
, 
	`´št_š‹d
(),

407 
	`š™_ut¢ame
()->
»Ëa£
,

408 ()
	`¡rc¥n
(
	`š™_ut¢ame
()->
v”siÚ
, " "),

409 
	`š™_ut¢ame
()->
v”siÚ
);

410 
	`show_Œaû
(
NULL
, NULL, &
dummy
);

411 
	}
}

413 
EXPORT_SYMBOL
(
dump_¡ack
);

415 
	$show_»gi¡”s
(
±_»gs
 *
»gs
)

417 
i
;

418 
š_k”Ãl
 = !
	`u£r_mode
(
»gs
);

419 
r¥
;

420 cÚ¡ 
ıu
 = 
	`smp_´oûssÜ_id
();

421 
sk_¡ruù
 *
cur
 = 
	`ıu_pda
(
ıu
)->
pcu¼’t
;

423 
r¥
 = 
»gs
->rsp;

424 
	`´štk
("CPU %d ", 
ıu
);

425 
	`__show_»gs
(
»gs
);

426 
	`´štk
("Process %s (pid: %d,hreadinfo %p,ask %p)\n",

427 
cur
->
comm
, cur->
pid
, 
	`sk_th»ad_šfo
(cur), cur);

433 ià(
š_k”Ãl
) {

434 
	`´štk
("Stack: ");

435 
	`_show_¡ack
(
NULL
, 
»gs
, (*)
r¥
);

437 
	`´štk
("\nCode: ");

438 ià(
»gs
->
r
 < 
PAGE_OFFSET
)

439 
bad
;

441 
i
=0; i<20; i++) {

442 
c
;

443 ià(
	`__g‘_u£r
(
c
, &((*)
»gs
->
r
)[
i
])) {

444 
bad
:

445 
	`´štk
(" Bad RIP value.");

448 
	`´štk
("%02x ", 
c
);

451 
	`´štk
("\n");

452 
	}
}

454 
	$is_v®id_bugaddr
(
r
)

456 
ud2
;

458 ià(
	`__cİy_äom_u£r
(&
ud2
, (cÚ¡ 
__u£r
 *è
r
, (ud2)))

461  
ud2
 == 0x0b0f;

462 
	}
}

464 #ifdeà
CONFIG_BUG


465 
	$out_of_lše_bug
()

467 
	`BUG
();

468 
	}
}

469 
EXPORT_SYMBOL
(
out_of_lše_bug
);

472 
¿w_¥šlock_t
 
	gd›_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

473 
	gd›_owÃr
 = -1;

474 
	gd›_Ã¡_couÁ
;

476 
__k´obes
 
	$oİs_begš
()

478 
ıu
;

479 
æags
;

481 
	`oİs_’‹r
();

484 
	`¿w_loÿl_œq_§ve
(
æags
);

485 
ıu
 = 
	`smp_´oûssÜ_id
();

486 ià(!
	`__¿w_¥š_Œylock
(&
d›_lock
)) {

487 ià(
ıu
 =ğ
d›_owÃr
)

490 
	`__¿w_¥š_lock
(&
d›_lock
);

492 
d›_Ã¡_couÁ
++;

493 
d›_owÃr
 = 
ıu
;

494 
	`cÚsŞe_v”bo£
();

495 
	`bu¡_¥šlocks
(1);

496  
æags
;

497 
	}
}

499 
__k´obes
 
	$oİs_’d
(
æags
)

501 
d›_owÃr
 = -1;

502 
	`bu¡_¥šlocks
(0);

503 
d›_Ã¡_couÁ
--;

504 ià(!
d›_Ã¡_couÁ
)

506 
	`__¿w_¥š_uÆock
(&
d›_lock
);

507 
	`¿w_loÿl_œq_»¡Üe
(
æags
);

508 ià(
·nic_Ú_oİs
)

509 
	`·nic
("Fatalƒxception");

510 
	`oİs_ex™
();

511 
	}
}

513 
__k´obes
 
	$__d›
(cÚ¡ * 
¡r
, 
±_»gs
 * 
»gs
, 
”r
)

515 
d›_couÁ”
;

516 
	`´štk
(
KERN_EMERG
 "%s: %04lx [%u] ", 
¡r
, 
”r
 & 0xffff,++
d›_couÁ”
);

517 #ifdeà
CONFIG_PREEMPT


518 
	`´štk
("PREEMPT ");

520 #ifdeà
CONFIG_SMP


521 
	`´štk
("SMP ");

523 #ifdeà
CONFIG_DEBUG_PAGEALLOC


524 
	`´štk
("DEBUG_PAGEALLOC");

526 
	`´štk
("\n");

527 
	`nÙify_d›
(
DIE_OOPS
, 
¡r
, 
»gs
, 
”r
, 
cu¼’t
->
th»ad
.
Œ­_no
, 
SIGSEGV
);

528 
	`show_»gi¡”s
(
»gs
);

529 
	`add_št
(
TAINT_DIE
);

531 
	`´štk
(
KERN_ALERT
 "RIP ");

532 
	`´štk_add»ss
(
»gs
->
r
);

533 
	`´štk
(" RSP <%016lx>\n", 
»gs
->
r¥
);

534 ià(
	`kexec_should_üash
(
cu¼’t
))

535 
	`üash_kexec
(
»gs
);

536 
	}
}

538 
	$d›
(cÚ¡ * 
¡r
, 
±_»gs
 * 
»gs
, 
”r
)

540 
æags
 = 
	`oİs_begš
();

542 ià(!
	`u£r_mode
(
»gs
))

543 
	`»pÜt_bug
(
»gs
->
r
,„egs);

545 
	`__d›
(
¡r
, 
»gs
, 
”r
);

546 
	`oİs_’d
(
æags
);

547 
	`do_ex™
(
SIGSEGV
);

548 
	}
}

550 
__k´obes
 
	$d›_nmi
(*
¡r
, 
±_»gs
 *
»gs
, 
do_·nic
)

552 
æags
 = 
	`oİs_begš
();

558 
	`´štk
(
¡r
, 
	`smp_´oûssÜ_id
());

559 
	`show_»gi¡”s
(
»gs
);

560 ià(
	`kexec_should_üash
(
cu¼’t
))

561 
	`üash_kexec
(
»gs
);

562 ià(
do_·nic
 || 
·nic_Ú_oİs
)

563 
	`·nic
("Non maskable interrupt");

564 
	`oİs_’d
(
æags
);

565 
	`nmi_ex™
();

566 
	`loÿl_œq_’abË
();

567 
	`do_ex™
(
SIGSEGV
);

568 
	}
}

570 
__k´obes
 
	$do_Œ­
(
Œ­Ä
, 
sigÄ
, *
¡r
,

571 
±_»gs
 * 
»gs
, 
”rÜ_code
,

572 
sigšfo_t
 *
šfo
)

574 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

576 ià(
	`u£r_mode
(
»gs
)) {

587 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

588 
tsk
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

590 ià(
show_unhªdËd_sigÇls
 && 
	`unhªdËd_sigÇl
(
tsk
, 
sigÄ
) &&

591 
	`´štk_¿‹lim™
())

592 
	`´štk
(
KERN_INFO


594 
tsk
->
comm
,sk->
pid
, 
¡r
,

595 
»gs
->
r
,„egs->
r¥
, 
”rÜ_code
);

597 ià(
šfo
)

598 
	`fÜû_sig_šfo
(
sigÄ
, 
šfo
, 
tsk
);

600 
	`fÜû_sig
(
sigÄ
, 
tsk
);

607 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

608 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
);

609 ià(
fixup
)

610 
»gs
->
r
 = 
fixup
->fixup;

612 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

613 
tsk
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

614 
	`d›
(
¡r
, 
»gs
, 
”rÜ_code
);

618 
	}
}

620 
	#DO_ERROR
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
Çme
) \

621 
asmlškage
 
do_
##
	`Çme
(
±_»gs
 * 
»gs
, 
”rÜ_code
) \

623 ià(
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 
Œ­Ä
, 
sigÄ
) \

624 =ğ
NOTIFY_STOP
) \

626 
	`cÚd™iÚ®_¡i
(
»gs
); \

627 
	`do_Œ­
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
»gs
, 
”rÜ_code
, 
NULL
); \

628 }

	)

630 
	#DO_ERROR_INFO
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
Çme
, 
sicode
, 
sŸddr
) \

631 
asmlškage
 
do_
##
	`Çme
(
±_»gs
 * 
»gs
, 
”rÜ_code
) \

633 
sigšfo_t
 
šfo
; \

634 
šfo
.
si_signo
 = 
sigÄ
; \

635 
šfo
.
si_”ºo
 = 0; \

636 
šfo
.
si_code
 = 
sicode
; \

637 
šfo
.
si_addr
 = (
__u£r
 *)
sŸddr
; \

638 
	`Œaû_h¬dœqs_fixup
(); \

639 ià(
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 
Œ­Ä
, 
sigÄ
) \

640 =ğ
NOTIFY_STOP
) \

642 
	`cÚd™iÚ®_¡i
(
»gs
); \

643 
	`do_Œ­
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
»gs
, 
”rÜ_code
, &
šfo
); \

644 }

	)

646 
DO_ERROR_INFO
Ğ0, 
SIGFPE
, "divid”rÜ", 
divide_”rÜ
, 
FPE_INTDIV
, 
»gs
->
r
)

647 
DO_ERROR
Ğ4, 
SIGSEGV
, "ov”æow", 
ov”æow
)

648 
DO_ERROR
Ğ5, 
SIGSEGV
, "bounds", 
bounds
)

649 
DO_ERROR_INFO
Ğ6, 
SIGILL
, "šv®id opcode", 
šv®id_İ
, 
ILL_ILLOPN
, 
»gs
->
r
)

650 
DO_ERROR
Ğ7, 
SIGSEGV
, "deviû‚Ù‡vaabË", 
deviû_nÙ_avaabË
)

651 
DO_ERROR
Ğ9, 
SIGFPE
, "cİroûssÜ segm’ˆov”run", 
cİroûssÜ_£gm’t_ov”run
)

652 
DO_ERROR
(10, 
SIGSEGV
, "šv®id TSS", 
šv®id_TSS
)

653 
DO_ERROR
(11, 
SIGBUS
, "£gm’ˆnÙ…»£Á", 
£gm’t_nÙ_´e£Á
)

654 
DO_ERROR_INFO
(17, 
SIGBUS
, "®ignm’ˆcheck", 
®ignm’t_check
, 
BUS_ADRALN
, 0)

655 
DO_ERROR
(18, 
SIGSEGV
, "»£rved", 
»£rved
)

658 
asmlškage
 
	$do_¡ack_£gm’t
(
±_»gs
 *
»gs
, 
”rÜ_code
)

660 ià(
	`nÙify_d›
(
DIE_TRAP
, "¡ack segm’t", 
»gs
, 
”rÜ_code
,

661 12, 
SIGBUS
è=ğ
NOTIFY_STOP
)

663 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

664 
	`do_Œ­
(12, 
SIGBUS
, "¡ack segm’t", 
»gs
, 
”rÜ_code
, 
NULL
);

665 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

666 
	}
}

668 
asmlškage
 
	$do_doubË_çuÉ
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

670 cÚ¡ 
¡r
[] = "double fault";

671 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

674 
	`nÙify_d›
(
DIE_TRAP
, 
¡r
, 
»gs
, 
”rÜ_code
, 8, 
SIGSEGV
);

676 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

677 
tsk
->
th»ad
.
Œ­_no
 = 8;

682 
	`d›
(
¡r
, 
»gs
, 
”rÜ_code
);

683 
	}
}

685 
asmlškage
 
__k´obes
 
	$do_g’”®_´ÙeùiÚ
(
±_»gs
 * 
»gs
,

686 
”rÜ_code
)

688 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

690 
	`cÚd™iÚ®_¡i
(
»gs
);

692 ià(
	`u£r_mode
(
»gs
)) {

693 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

694 
tsk
->
th»ad
.
Œ­_no
 = 13;

696 ià(
show_unhªdËd_sigÇls
 && 
	`unhªdËd_sigÇl
(
tsk
, 
SIGSEGV
) &&

697 
	`´štk_¿‹lim™
())

698 
	`´štk
(
KERN_INFO


700 
tsk
->
comm
,sk->
pid
,

701 
»gs
->
r
,„egs->
r¥
, 
”rÜ_code
);

703 
	`fÜû_sig
(
SIGSEGV
, 
tsk
);

709 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

710 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
);

711 ià(
fixup
) {

712 
»gs
->
r
 = 
fixup
->fixup;

716 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

717 
tsk
->
th»ad
.
Œ­_no
 = 13;

718 ià(
	`nÙify_d›
(
DIE_GPF
, "g’”®…rÙeùiÚ fauÉ", 
»gs
,

719 
”rÜ_code
, 13, 
SIGSEGV
è=ğ
NOTIFY_STOP
)

721 
	`d›
("g’”®…rÙeùiÚ fauÉ", 
»gs
, 
”rÜ_code
);

723 
	}
}

725 
__k´obes
 

726 
	$mem_·r™y_”rÜ
(
»asÚ
, 
±_»gs
 * 
»gs
)

728 
	`´štk
(
KERN_EMERG
 "Uhhuh. NMI„eceived for unknown„eason %02x.\n",

729 
»asÚ
);

730 
	`´štk
(
KERN_EMERG
 "You have some hardware…roblem,†ikely onhe PCI bus.\n");

732 #ià
	`defšed
(
CONFIG_EDAC
)

733 if(
	`edac_hªdËr_£t
()) {

734 
	`edac_©omic_as£¹_”rÜ
();

739 ià(
·nic_Ú_uÄecov”ed_nmi
)

740 
	`·nic
("NMI: Not continuing");

742 
	`´štk
(
KERN_EMERG
 "Dazed‡nd confused, butryingo continue\n");

745 
»asÚ
 = (reason & 0xf) | 4;

746 
	`outb
(
»asÚ
, 0x61);

747 
	}
}

749 
__k´obes
 

750 
	$io_check_”rÜ
(
»asÚ
, 
±_»gs
 * 
»gs
)

752 
	`´štk
("NMI: IOCKƒrror (debug interrupt?)\n");

753 
	`show_»gi¡”s
(
»gs
);

756 
»asÚ
 = (reason & 0xf) | 8;

757 
	`outb
(
»asÚ
, 0x61);

758 
	`md–ay
(2000);

759 
»asÚ
 &= ~8;

760 
	`outb
(
»asÚ
, 0x61);

761 
	}
}

763 
__k´obes
 

764 
	$unknown_nmi_”rÜ
(
»asÚ
, 
±_»gs
 * 
»gs
)

766 
	`´štk
(
KERN_EMERG
 "Uhhuh. NMI„eceived for unknown„eason %02x.\n",

767 
»asÚ
);

768 
	`´štk
(
KERN_EMERG
 "Do you have‡ strange…ower saving modeƒnabled?\n");

770 ià(
·nic_Ú_uÄecov”ed_nmi
)

771 
	`·nic
("NMI: Not continuing");

773 
	`´štk
(
KERN_EMERG
 "Dazed‡nd confused, butryingo continue\n");

774 
	}
}

778 
asmlškage
 
__k´obes
 
	$deçuÉ_do_nmi
(
±_»gs
 *
»gs
)

780 
»asÚ
 = 0;

781 
ıu
;

783 
ıu
 = 
	`smp_´oûssÜ_id
();

786 ià(!
ıu
)

787 
»asÚ
 = 
	`g‘_nmi_»asÚ
();

789 ià(!(
»asÚ
 & 0xc0)) {

790 ià(
	`nÙify_d›
(
DIE_NMI_IPI
, "nmi_i", 
»gs
, 
»asÚ
, 2, 
SIGINT
)

791 =ğ
NOTIFY_STOP
)

797 ià(
	`nmi_w©chdog_tick
(
»gs
,
»asÚ
))

799 ià(!
	`do_nmi_ÿÎback
(
»gs
,
ıu
))

800 
	`unknown_nmi_”rÜ
(
»asÚ
, 
»gs
);

804 ià(
	`nÙify_d›
(
DIE_NMI
, "nmi", 
»gs
, 
»asÚ
, 2, 
SIGINT
è=ğ
NOTIFY_STOP
)

809 ià(
»asÚ
 & 0x80)

810 
	`mem_·r™y_”rÜ
(
»asÚ
, 
»gs
);

811 ià(
»asÚ
 & 0x40)

812 
	`io_check_”rÜ
(
»asÚ
, 
»gs
);

813 
	}
}

816 
asmlškage
 
__k´obes
 
	$do_št3
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

818 
	`Œaû_h¬dœqs_fixup
();

820 ià(
	`nÙify_d›
(
DIE_INT3
, "št3", 
»gs
, 
”rÜ_code
, 3, 
SIGTRAP
è=ğ
NOTIFY_STOP
) {

823 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

824 
	`do_Œ­
(3, 
SIGTRAP
, "št3", 
»gs
, 
”rÜ_code
, 
NULL
);

825 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

826 
	}
}

831 
asmlškage
 
__k´obes
 
±_»gs
 *
	$sync_»gs
(
±_»gs
 *
”egs
)

833 
±_»gs
 *
»gs
 = 
”egs
;

835 ià(
”egs
 =ğ(
±_»gs
 *ë»gs->
r¥
)

838 ià(
	`u£r_mode
(
”egs
))

839 
»gs
 = 
	`sk_±_»gs
(
cu¼’t
);

842 ià(
”egs
->
eæags
 & 
X86_EFLAGS_IF
)

843 
»gs
 = (
±_»gs
 *)(
”egs
->
r¥
 -= (pt_regs));

844 ià(
”egs
 !ğ
»gs
)

845 *
»gs
 = *
”egs
;

846  
»gs
;

847 
	}
}

850 
asmlškage
 
__k´obes
 
	$do_debug
(
±_»gs
 * 
»gs
,

851 
”rÜ_code
)

853 
cÚd™iÚ
;

854 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

855 
sigšfo_t
 
šfo
;

857 
	`Œaû_h¬dœqs_fixup
();

859 
	`g‘_debug»g
(
cÚd™iÚ
, 6);

861 ià(
	`nÙify_d›
(
DIE_DEBUG
, "debug", 
»gs
, 
cÚd™iÚ
, 
”rÜ_code
,

862 
SIGTRAP
è=ğ
NOTIFY_STOP
)

865 
	`´“m±_cÚd™iÚ®_¡i
(
»gs
);

868 ià(
cÚd™iÚ
 & (
DR_TRAP0
|
DR_TRAP1
|
DR_TRAP2
|
DR_TRAP3
)) {

869 ià(!
tsk
->
th»ad
.
debug»g7
) {

870 
ş—r_dr7
;

874 
tsk
->
th»ad
.
debug»g6
 = 
cÚd™iÚ
;

877 ià(
cÚd™iÚ
 & 
DR_STEP
) {

887 ià(!
	`u£r_mode
(
»gs
))

888 
ş—r_TF_»’abË
;

893 ià(
tsk
->
±¿û
 & 
PT_DTRACE
) {

894 
»gs
->
eæags
 &ğ~
TF_MASK
;

895 
tsk
->
±¿û
 &ğ~
PT_DTRACE
;

900 
tsk
->
th»ad
.
Œ­_no
 = 1;

901 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

902 
šfo
.
si_signo
 = 
SIGTRAP
;

903 
šfo
.
si_”ºo
 = 0;

904 
šfo
.
si_code
 = 
TRAP_BRKPT
;

905 
šfo
.
si_addr
 = 
	`u£r_mode
(
»gs
è? (
__u£r
 *ìegs->
r
 : 
NULL
;

906 
	`fÜû_sig_šfo
(
SIGTRAP
, &
šfo
, 
tsk
);

908 
ş—r_dr7
:

909 
	`£t_debug»g
(0UL, 7);

910 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

913 
ş—r_TF_»’abË
:

914 
	`£t_tsk_th»ad_æag
(
tsk
, 
TIF_SINGLESTEP
);

915 
»gs
->
eæags
 &ğ~
TF_MASK
;

916 
	`´“m±_cÚd™iÚ®_şi
(
»gs
);

917 
	}
}

919 
	$k”Ãl_m©h_”rÜ
(
±_»gs
 *
»gs
, cÚ¡ *
¡r
, 
Œ­Ä
)

921 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

922 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
);

923 ià(
fixup
) {

924 
»gs
->
r
 = 
fixup
->fixup;

927 
	`nÙify_d›
(
DIE_GPF
, 
¡r
, 
»gs
, 0, 
Œ­Ä
, 
SIGFPE
);

929 
cu¼’t
->
th»ad
.
Œ­_no
 = 
Œ­Ä
;

930 
	`d›
(
¡r
, 
»gs
, 0);

932 
	}
}

939 
asmlškage
 
	$do_cİroûssÜ_”rÜ
(
±_»gs
 *
»gs
)

941 
__u£r
 *
r
 = (__u£¸*)(
»gs
->rip);

942 
sk_¡ruù
 * 
sk
;

943 
sigšfo_t
 
šfo
;

944 
cwd
, 
swd
;

946 
	`cÚd™iÚ®_¡i
(
»gs
);

947 ià(!
	`u£r_mode
(
»gs
) &&

948 
	`k”Ãl_m©h_”rÜ
(
»gs
, "kernel x87 mathƒrror", 16))

954 
sk
 = 
cu¼’t
;

955 
	`§ve_š™_åu
(
sk
);

956 
sk
->
th»ad
.
Œ­_no
 = 16;

957 
sk
->
th»ad
.
”rÜ_code
 = 0;

958 
šfo
.
si_signo
 = 
SIGFPE
;

959 
šfo
.
si_”ºo
 = 0;

960 
šfo
.
si_code
 = 
__SI_FAULT
;

961 
šfo
.
si_addr
 = 
r
;

972 
cwd
 = 
	`g‘_åu_cwd
(
sk
);

973 
swd
 = 
	`g‘_åu_swd
(
sk
);

974 
swd
 & ~
cwd
 & 0x3f) {

984 
šfo
.
si_code
 = 
FPE_FLTINV
;

988 
šfo
.
si_code
 = 
FPE_FLTUND
;

991 
šfo
.
si_code
 = 
FPE_FLTDIV
;

994 
šfo
.
si_code
 = 
FPE_FLTOVF
;

997 
šfo
.
si_code
 = 
FPE_FLTRES
;

1000 
	`fÜû_sig_šfo
(
SIGFPE
, &
šfo
, 
sk
);

1001 
	}
}

1003 
asmlškage
 
	$bad_šŒ
()

1005 
	`´štk
("bad interrupt");

1006 
	}
}

1008 
asmlškage
 
	$do_simd_cİroûssÜ_”rÜ
(
±_»gs
 *
»gs
)

1010 
__u£r
 *
r
 = (__u£¸*)(
»gs
->rip);

1011 
sk_¡ruù
 * 
sk
;

1012 
sigšfo_t
 
šfo
;

1013 
mxc¤
;

1015 
	`cÚd™iÚ®_¡i
(
»gs
);

1016 ià(!
	`u£r_mode
(
»gs
) &&

1017 
	`k”Ãl_m©h_”rÜ
(
»gs
, "kernel simd mathƒrror", 19))

1023 
sk
 = 
cu¼’t
;

1024 
	`§ve_š™_åu
(
sk
);

1025 
sk
->
th»ad
.
Œ­_no
 = 19;

1026 
sk
->
th»ad
.
”rÜ_code
 = 0;

1027 
šfo
.
si_signo
 = 
SIGFPE
;

1028 
šfo
.
si_”ºo
 = 0;

1029 
šfo
.
si_code
 = 
__SI_FAULT
;

1030 
šfo
.
si_addr
 = 
r
;

1037 
mxc¤
 = 
	`g‘_åu_mxc¤
(
sk
);

1038 ~((
mxc¤
 & 0x1f80) >> 7) & (mxcsr & 0x3f)) {

1043 
šfo
.
si_code
 = 
FPE_FLTINV
;

1047 
šfo
.
si_code
 = 
FPE_FLTUND
;

1050 
šfo
.
si_code
 = 
FPE_FLTDIV
;

1053 
šfo
.
si_code
 = 
FPE_FLTOVF
;

1056 
šfo
.
si_code
 = 
FPE_FLTRES
;

1059 
	`fÜû_sig_šfo
(
SIGFPE
, &
šfo
, 
sk
);

1060 
	}
}

1062 
asmlškage
 
	$do_¥urious_š‹¼u±_bug
(
±_»gs
 * 
»gs
)

1064 
	}
}

1066 
asmlškage
 
__©Œibu‹__
((
w—k
)è
	$smp_th”m®_š‹¼u±
()

1068 
	}
}

1070 
asmlškage
 
__©Œibu‹__
((
w—k
)è
	$mû_th»shŞd_š‹¼u±
()

1072 
	}
}

1081 
asmlškage
 
	$m©h_¡©e_»¡Üe
()

1083 
sk_¡ruù
 *
me
 = 
cu¼’t
;

1084 
	`şts
();

1086 ià(!
	`u£d_m©h
())

1087 
	`š™_åu
(
me
);

1088 
	`»¡Üe_åu_checkšg
(&
me
->
th»ad
.
i387
.
fx§ve
);

1089 
	`sk_th»ad_šfo
(
me
)->
¡©us
 |ğ
TS_USEDFPU
;

1090 
me
->
åu_couÁ”
++;

1091 
	}
}

1093 
__š™
 
	$Œ­_š™
()

1095 
	`£t_šŒ_g©e
(0,&
divide_”rÜ
);

1096 
	`£t_šŒ_g©e_i¡
(1,&
debug
,
DEBUG_STACK
);

1097 
	`£t_šŒ_g©e_i¡
(2,&
nmi
,
NMI_STACK
);

1098 
	`£t_sy¡em_g©e_i¡
(3,&
št3
,
DEBUG_STACK
);

1099 
	`£t_sy¡em_g©e
(4,&
ov”æow
);

1100 
	`£t_šŒ_g©e
(5,&
bounds
);

1101 
	`£t_šŒ_g©e
(6,&
šv®id_İ
);

1102 
	`£t_šŒ_g©e
(7,&
deviû_nÙ_avaabË
);

1103 
	`£t_šŒ_g©e_i¡
(8,&
doubË_çuÉ
, 
DOUBLEFAULT_STACK
);

1104 
	`£t_šŒ_g©e
(9,&
cİroûssÜ_£gm’t_ov”run
);

1105 
	`£t_šŒ_g©e
(10,&
šv®id_TSS
);

1106 
	`£t_šŒ_g©e
(11,&
£gm’t_nÙ_´e£Á
);

1107 
	`£t_šŒ_g©e_i¡
(12,&
¡ack_£gm’t
,
STACKFAULT_STACK
);

1108 
	`£t_šŒ_g©e
(13,&
g’”®_´ÙeùiÚ
);

1109 
	`£t_šŒ_g©e
(14,&
·ge_çuÉ
);

1110 
	`£t_šŒ_g©e
(15,&
¥urious_š‹¼u±_bug
);

1111 
	`£t_šŒ_g©e
(16,&
cİroûssÜ_”rÜ
);

1112 
	`£t_šŒ_g©e
(17,&
®ignm’t_check
);

1113 #ifdeà
CONFIG_X86_MCE


1114 
	`£t_šŒ_g©e_i¡
(18,&
machše_check
, 
MCE_STACK
);

1116 
	`£t_šŒ_g©e
(19,&
simd_cİroûssÜ_”rÜ
);

1118 #ifdeà
CONFIG_IA32_EMULATION


1119 
	`£t_sy¡em_g©e
(
IA32_SYSCALL_VECTOR
, 
Ÿ32_sysÿÎ
);

1125 
	`ıu_š™
();

1126 
	}
}

1129 
__š™
 
	$oİs_£tup
(*
s
)

1131 ià(!
s
)

1132  -
EINVAL
;

1133 ià(!
	`¡rcmp
(
s
, "panic"))

1134 
·nic_Ú_oİs
 = 1;

1136 
	}
}

1137 
—¾y_·¿m
("oİs", 
oİs_£tup
);

1139 
__š™
 
	$k¡ack_£tup
(*
s
)

1141 ià(!
s
)

1142  -
EINVAL
;

1143 
k¡ack_d•th_to_´št
 = 
	`sim¶e_¡¹oul
(
s
,
NULL
,0);

1145 
	}
}

1146 
—¾y_·¿m
("k¡ack", 
k¡ack_£tup
);

	@/cmpt816/linux/arch/x86/kernel/tsc_64.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/š‹¼u±.h
>

4 
	~<lšux/š™.h
>

5 
	~<lšux/şocksourû.h
>

6 
	~<lšux/time.h
>

7 
	~<lšux/aıi.h
>

8 
	~<lšux/ıuäeq.h
>

9 
	~<lšux/aıi_pmtmr.h
>

11 
	~<asm/h³t.h
>

12 
	~<asm/timex.h
>

14 
nÙsc
 
	g__š™d©a
 = 0;

16 
	gıu_khz
;

17 
EXPORT_SYMBOL
(
ıu_khz
);

18 
	gtsc_khz
;

19 
EXPORT_SYMBOL
(
tsc_khz
);

21 
cyc2ns_sÿË
 
	g__»ad_mo¡ly
;

23 
šlše
 
	$£t_cyc2ns_sÿË
(
khz
)

25 
cyc2ns_sÿË
 = (
NSEC_PER_MSEC
 << 
NS_SCALE
è/ 
khz
;

26 
	}
}

28 
	$cyşes_2_ns
(
cyc
)

30  (
cyc
 * 
cyc2ns_sÿË
è>> 
NS_SCALE
;

31 
	}
}

33 
	$sched_şock
()

35 
a
 = 0;

43 
	`rdtsşl
(
a
);

44  
	`cyşes_2_ns
(
a
);

45 
	}
}

47 
	gtsc_un¡abË
;

49 
šlše
 
	$check_tsc_un¡abË
()

51  
tsc_un¡abË
;

52 
	}
}

53 #ifdeà
CONFIG_CPU_FREQ


66 
	g»f_äeq
;

67 
	gloİs_³r_jiffy_»f
;

68 
	gtsc_khz_»f
;

70 
	$time_ıuäeq_nÙif›r
(
nÙif›r_block
 *
nb
, 
v®
,

71 *
d©a
)

73 
ıuäeq_äeqs
 *
äeq
 = 
d©a
;

74 *
Íj
, 
dummy
;

76 ià(
	`ıu_has
(&
	`ıu_d©a
(
äeq
->
ıu
), 
X86_FEATURE_CONSTANT_TSC
))

79 
Íj
 = &
dummy
;

80 ià(!(
äeq
->
æags
 & 
CPUFREQ_CONST_LOOPS
))

81 #ifdeà
CONFIG_SMP


82 
Íj
 = &
	`ıu_d©a
(
äeq
->
ıu
).
loİs_³r_jiffy
;

84 
Íj
 = &
boÙ_ıu_d©a
.
loİs_³r_jiffy
;

87 ià(!
»f_äeq
) {

88 
»f_äeq
 = 
äeq
->
Şd
;

89 
loİs_³r_jiffy_»f
 = *
Íj
;

90 
tsc_khz_»f
 = 
tsc_khz
;

92 ià((
v®
 =ğ
CPUFREQ_PRECHANGE
 && 
äeq
->
Şd
 < f»q->
Ãw
) ||

93 (
v®
 =ğ
CPUFREQ_POSTCHANGE
 && 
äeq
->
Şd
 > f»q->
Ãw
) ||

94 (
v®
 =ğ
CPUFREQ_RESUMECHANGE
)) {

95 *
Íj
 =

96 
	`ıuäeq_sÿË
(
loİs_³r_jiffy_»f
, 
»f_äeq
, 
äeq
->
Ãw
);

98 
tsc_khz
 = 
	`ıuäeq_sÿË
(
tsc_khz_»f
, 
»f_äeq
, 
äeq
->
Ãw
);

99 ià(!(
äeq
->
æags
 & 
CPUFREQ_CONST_LOOPS
))

100 
	`m¬k_tsc_un¡abË
("cpufreq changes");

103 
	`£t_cyc2ns_sÿË
(
tsc_khz_»f
);

106 
	}
}

108 
nÙif›r_block
 
	gtime_ıuäeq_nÙif›r_block
 = {

109 .
nÙif›r_ÿÎ
 = 
time_ıuäeq_nÙif›r


112 
__š™
 
	$ıuäeq_tsc
()

114 
	`ıuäeq_»gi¡”_nÙif›r
(&
time_ıuäeq_nÙif›r_block
,

115 
CPUFREQ_TRANSITION_NOTIFIER
);

117 
	}
}

119 
cÜe_š™ÿÎ
(
ıuäeq_tsc
);

123 
	#MAX_RETRIES
 5

	)

124 
	#SMI_TRESHOLD
 50000

	)

129 
__š™
 
	$tsc_»ad_»fs
(*
pm
,

130 *
h³t
)

132 
t1
, 
t2
;

133 
i
;

135 
i
 = 0; i < 
MAX_RETRIES
; i++) {

136 
t1
 = 
	`g‘_cyşes_sync
();

137 ià(
h³t
)

138 *
h³t
 = 
	`h³t_»adl
(
HPET_COUNTER
) & 0xFFFFFFFF;

140 *
pm
 = 
	`aıi_pm_»ad_—¾y
();

141 
t2
 = 
	`g‘_cyşes_sync
();

142 ià((
t2
 - 
t1
è< 
SMI_TRESHOLD
)

143  
t2
;

145  
ULONG_MAX
;

146 
	}
}

151 
__š™
 
	$tsc_ÿlib¿‹
()

153 
æags
, 
tsc1
, 
tsc2
, 
Œ1
, 
Œ2
, 
pm1
, 
pm2
, 
h³t1
, 
h³t2
;

154 
h³t
 = 
	`is_h³t_’abËd
();

156 
	`loÿl_œq_§ve
(
æags
);

158 
tsc1
 = 
	`tsc_»ad_»fs
(&
pm1
, 
h³t
 ? &
h³t1
 : 
NULL
);

160 
	`outb
((
	`šb
(0x61) & ~0x02) | 0x01, 0x61);

162 
	`outb
(0xb0, 0x43);

163 
	`outb
((
CLOCK_TICK_RATE
 / (1000 / 50)) & 0xff, 0x42);

164 
	`outb
((
CLOCK_TICK_RATE
 / (1000 / 50)) >> 8, 0x42);

165 
Œ1
 = 
	`g‘_cyşes_sync
();

166 (
	`šb
(0x61) & 0x20) == 0);

167 
Œ2
 = 
	`g‘_cyşes_sync
();

169 
tsc2
 = 
	`tsc_»ad_»fs
(&
pm2
, 
h³t
 ? &
h³t2
 : 
NULL
);

171 
	`loÿl_œq_»¡Üe
(
æags
);

177 
tsc_khz
 = (
Œ2
 - 
Œ1
) / 50;

180 ià(!
h³t
 && !
pm1
 && !
pm2
) {

181 
	`´štk
(
KERN_INFO
 "TSC calibrated‡gainst PIT\n");

186 ià(
tsc1
 =ğ
ULONG_MAX
 || 
tsc2
 == ULONG_MAX) {

187 
	`´štk
(
KERN_WARNING
 "TSC calibration disturbed by SMI, "

192 
tsc2
 = (tsc2 - 
tsc1
) * 1000000L;

194 ià(
h³t
) {

195 
	`´štk
(
KERN_INFO
 "TSC calibrated‡gainst HPET\n");

196 ià(
h³t2
 < 
h³t1
)

197 
h³t2
 += 0x100000000;

198 
h³t2
 -ğ
h³t1
;

199 
tsc1
 = (
h³t2
 * 
	`h³t_»adl
(
HPET_PERIOD
)) / 1000000;

201 
	`´štk
(
KERN_INFO
 "TSC calibrated‡gainst PM_TIMER\n");

202 ià(
pm2
 < 
pm1
)

203 
pm2
 +ğ
ACPI_PM_OVRRUN
;

204 
pm2
 -ğ
pm1
;

205 
tsc1
 = (
pm2
 * 1000000000è/ 
PMTMR_TICKS_PER_SEC
;

208 
tsc_khz
 = 
tsc2
 / 
tsc1
;

209 
	`£t_cyc2ns_sÿË
(
tsc_khz
);

210 
	}
}

216 
__ıuš™
 
	$unsynchrÚized_tsc
()

218 ià(
tsc_un¡abË
)

221 #ifdeà
CONFIG_SMP


222 ià(
	`­ic_is_şu¡”ed_box
())

227 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) {

228 #ifdeà
CONFIG_ACPI


230 ià(
aıi_gbl_FADT
.
h—d”
.
Ëngth
 > 0 &&

231 
aıi_gbl_FADT
.
C3Ï‹ncy
 < 1000)

238  
	`num_´e£Á_ıus
() > 1;

239 
	}
}

241 
__š™
 
	$nÙsc_£tup
(*
s
)

243 
nÙsc
 = 1;

245 
	}
}

247 
__£tup
("nÙsc", 
nÙsc_£tup
);

251 
cyşe_t
 
	$»ad_tsc
()

253 
cyşe_t
 
»t
 = (cyşe_t)
	`g‘_cyşes_sync
();

254  
»t
;

255 
	}
}

257 
cyşe_t
 
__vsysÿÎ_â
 
	$v»ad_tsc
()

259 
cyşe_t
 
»t
 = (cyşe_t)
	`g‘_cyşes_sync
();

260  
»t
;

261 
	}
}

263 
şocksourû
 
	gşocksourû_tsc
 = {

264 .
Çme
 = "tsc",

265 .
	g¿tšg
 = 300,

266 .
	g»ad
 = 
»ad_tsc
,

267 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

268 .
	gshiá
 = 22,

269 .
	gæags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

270 
CLOCK_SOURCE_MUST_VERIFY
,

271 .
	gv»ad
 = 
v»ad_tsc
,

274 
	$m¬k_tsc_un¡abË
(*
»asÚ
)

276 ià(!
tsc_un¡abË
) {

277 
tsc_un¡abË
 = 1;

278 
	`´štk
("M¬kšg TSC un¡abË dutØ%s\n", 
»asÚ
);

280 ià(
şocksourû_tsc
.
muÉ
)

281 
	`şocksourû_chªge_¿tšg
(&
şocksourû_tsc
, 0);

283 
şocksourû_tsc
.
¿tšg
 = 0;

285 
	}
}

286 
EXPORT_SYMBOL_GPL
(
m¬k_tsc_un¡abË
);

288 
__š™
 
	$š™_tsc_şocksourû
()

290 ià(!
nÙsc
) {

291 
şocksourû_tsc
.
muÉ
 = 
	`şocksourû_khz2muÉ
(
tsc_khz
,

292 
şocksourû_tsc
.
shiá
);

293 ià(
	`check_tsc_un¡abË
())

294 
şocksourû_tsc
.
¿tšg
 = 0;

296 
	`şocksourû_»gi¡”
(&
şocksourû_tsc
);

298 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<lšux/¥šlock.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/smp.h
>

21 
	~<lšux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__ıuš™d©a
 
©omic_t
 
	g¡¬t_couÁ
;

29 
__ıuš™d©a
 
©omic_t
 
	g¡İ_couÁ
;

36 
__ıuš™d©a
 
¿w_¥šlock_t
 
	gsync_lock
 = 
__RAW_SPIN_LOCK_UNLOCKED
;

37 
__ıuš™d©a
 
cyşes_t
 
	gÏ¡_tsc
;

38 
__ıuš™d©a
 
cyşes_t
 
	gmax_w¬p
;

39 
__ıuš™d©a
 
	gÄ_w¬ps
;

44 
__ıuš™
 
	$check_tsc_w¬p
()

46 
cyşes_t
 
¡¬t
, 
now
, 
´ev
, 
’d
;

47 
i
;

49 
¡¬t
 = 
	`g‘_cyşes_sync
();

53 
’d
 = 
¡¬t
 + 
tsc_khz
 * 20ULL;

54 
now
 = 
¡¬t
;

56 
i
 = 0; ; i++) {

62 
	`__¿w_¥š_lock
(&
sync_lock
);

63 
´ev
 = 
Ï¡_tsc
;

64 
now
 = 
	`g‘_cyşes_sync
();

65 
Ï¡_tsc
 = 
now
;

66 
	`__¿w_¥š_uÆock
(&
sync_lock
);

74 ià(
	`uÆik–y
(!(
i
 & 7))) {

75 ià(
now
 > 
’d
 || 
i
 > 100000000)

77 
	`ıu_»Ïx
();

78 
	`touch_nmi_w©chdog
();

84 ià(
	`uÆik–y
(
´ev
 > 
now
)) {

85 
	`__¿w_¥š_lock
(&
sync_lock
);

86 
max_w¬p
 = 
	`max
(max_w¬p, 
´ev
 - 
now
);

87 
Ä_w¬ps
++;

88 
	`__¿w_¥š_uÆock
(&
sync_lock
);

92 
	}
}

98 
__ıuš™
 
	$check_tsc_sync_sourû
(
ıu
)

100 
ıus
 = 2;

106 ià(
	`unsynchrÚized_tsc
())

109 
	`´štk
(
KERN_INFO
 "checking TSC synchronization [CPU#%d -> CPU#%d]:",

110 
	`smp_´oûssÜ_id
(), 
ıu
);

115 
	`©omic_£t
(&
¡İ_couÁ
, 0);

120 
	`©omic_»ad
(&
¡¬t_couÁ
è!ğ
ıus
-1)

121 
	`ıu_»Ïx
();

125 
	`©omic_šc
(&
¡¬t_couÁ
);

127 
	`check_tsc_w¬p
();

129 
	`©omic_»ad
(&
¡İ_couÁ
è!ğ
ıus
-1)

130 
	`ıu_»Ïx
();

135 
	`©omic_£t
(&
¡¬t_couÁ
, 0);

137 ià(
Ä_w¬ps
) {

138 
	`´štk
("\n");

139 
	`´štk
(
KERN_WARNING
 "Measured %Ld cycles TSC warp between CPUs,"

140 "uºšg ofàTSC clock.\n", 
max_w¬p
);

141 
	`m¬k_tsc_un¡abË
("check_tsc_sync_source failed");

142 
Ä_w¬ps
 = 0;

143 
max_w¬p
 = 0;

144 
Ï¡_tsc
 = 0;

146 
	`´štk
("…assed.\n");

152 
	`©omic_šc
(&
¡İ_couÁ
);

153 
	}
}

158 
__ıuš™
 
	$check_tsc_sync_rg‘
()

160 
ıus
 = 2;

162 ià(
	`unsynchrÚized_tsc
())

169 
	`©omic_šc
(&
¡¬t_couÁ
);

170 
	`©omic_»ad
(&
¡¬t_couÁ
è!ğ
ıus
)

171 
	`ıu_»Ïx
();

173 
	`check_tsc_w¬p
();

178 
	`©omic_šc
(&
¡İ_couÁ
);

183 
	`©omic_»ad
(&
¡İ_couÁ
è!ğ
ıus
)

184 
	`ıu_»Ïx
();

185 
	}
}

186 #undeà
NR_LOOPS


	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

20 
	~<lšux/time.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/tim”.h
>

24 
	~<lšux/£qlock.h
>

25 
	~<lšux/jiff›s.h
>

26 
	~<lšux/sysùl.h
>

27 
	~<lšux/şocksourû.h
>

28 
	~<lšux/g‘ıu.h
>

29 
	~<lšux/ıu.h
>

30 
	~<lšux/smp.h
>

31 
	~<lšux/nÙif›r.h
>

33 
	~<asm/vsysÿÎ.h
>

34 
	~<asm/pgbË.h
>

35 
	~<asm/·ge.h
>

36 
	~<asm/uni¡d.h
>

37 
	~<asm/fixm­.h
>

38 
	~<asm/”ºo.h
>

39 
	~<asm/io.h
>

40 
	~<asm/£gm’t.h
>

41 
	~<asm/desc.h
>

42 
	~<asm/tİŞogy.h
>

43 
	~<asm/vgtod.h
>

45 
	#__vsysÿÎ
(
Ä
è
	`__©Œibu‹__
 ((
unu£d
,
	`__£ùiÚ__
(".vsysÿÎ_" #Ä)))

	)

46 
	#__sysÿÎ_şobb”
 "r11","rcx","memÜy"

	)

47 
	#__·_vsymbŞ
(
x
) \

48 ({
v
; \

49 
__vsysÿÎ_0
; \

50 
	`asm
("" : "ô" (
v
è: "0" (
x
)); \

51 ((
v
 - 
VSYSCALL_START
è+ 
	`__·_symbŞ
(&
__vsysÿÎ_0
)); })

	)

59 
__vg‘ıu_mode
 
	g__£ùiÚ_vg‘ıu_mode
;

61 
vsysÿÎ_gtod_d©a
 
__vsysÿÎ_gtod_d©a
 
	g__£ùiÚ_vsysÿÎ_gtod_d©a
 =

63 .
lock
 = 
SEQLOCK_UNLOCKED
,

64 .
	gsysùl_’abËd
 = 1,

67 
	$upd©e_vsysÿÎ_tz
()

69 
æags
;

71 
	`wr™e_£qlock_œq§ve
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

73 
vsysÿÎ_gtod_d©a
.
sys_tz
 = sys_tz;

74 
	`wr™e_£quÆock_œq»¡Üe
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

75 
	}
}

77 
	$upd©e_vsysÿÎ
(
time¥ec
 *
w®l_time
, 
şocksourû
 *
şock
)

79 
æags
;

81 
	`wr™e_£qlock_œq§ve
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

83 
vsysÿÎ_gtod_d©a
.
şock
.
v»ad
 = clock->vread;

84 
vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
 = clock->cycle_last;

85 
vsysÿÎ_gtod_d©a
.
şock
.
mask
 = clock->mask;

86 
vsysÿÎ_gtod_d©a
.
şock
.
muÉ
 = clock->mult;

87 
vsysÿÎ_gtod_d©a
.
şock
.
shiá
 = clock->shift;

88 
vsysÿÎ_gtod_d©a
.
w®l_time_£c
 = 
w®l_time
->
tv_£c
;

89 
vsysÿÎ_gtod_d©a
.
w®l_time_n£c
 = 
w®l_time
->
tv_n£c
;

90 
vsysÿÎ_gtod_d©a
.
w®l_to_mÚÙÚic
 = wall_to_monotonic;

91 
	`wr™e_£quÆock_œq»¡Üe
(&
vsysÿÎ_gtod_d©a
.
lock
, 
æags
);

92 
	}
}

97 
__®ways_šlše
 
	$do_g‘_tz
(
timezÚe
 * 
tz
)

99 *
tz
 = 
__vsysÿÎ_gtod_d©a
.
sys_tz
;

100 
	}
}

102 
__®ways_šlše
 
	$g‘timeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

104 
»t
;

105 
asm
 volatile("vsysc2: syscall"

106 : "÷" (
»t
)

107 : "0" (
__NR_g‘timeofday
),"D" (
tv
),"S" (
tz
)

108 : 
__sysÿÎ_şobb”
 );

109  
»t
;

110 
	}
}

112 
__®ways_šlše
 
	$time_sysÿÎ
(*
t
)

114 
£cs
;

115 
asm
 volatile("vsysc1: syscall"

116 : "÷" (
£cs
)

117 : "0" (
__NR_time
),"D" (
t
è: 
__sysÿÎ_şobb”
);

118  
£cs
;

119 
	}
}

121 
__®ways_šlše
 
	$do_vg‘timeofday
(
timev®
 * 
tv
)

123 
cyşe_t
 
now
, 
ba£
, 
mask
, 
cyşe_d–
;

124 
£q
;

125 
muÉ
, 
shiá
, 
n£c
;

126 
	`cyşe_t
 (*
v»ad
)();

128 
£q
 = 
	`»ad_£qbegš
(&
__vsysÿÎ_gtod_d©a
.
lock
);

130 
v»ad
 = 
__vsysÿÎ_gtod_d©a
.
şock
.vread;

131 ià(
	`uÆik–y
(!
__vsysÿÎ_gtod_d©a
.
sysùl_’abËd
 || !
v»ad
)) {

132 
	`g‘timeofday
(
tv
,
NULL
);

135 
now
 = 
	`v»ad
();

136 
ba£
 = 
__vsysÿÎ_gtod_d©a
.
şock
.
cyşe_Ï¡
;

137 
mask
 = 
__vsysÿÎ_gtod_d©a
.
şock
.mask;

138 
muÉ
 = 
__vsysÿÎ_gtod_d©a
.
şock
.mult;

139 
shiá
 = 
__vsysÿÎ_gtod_d©a
.
şock
.shift;

141 
tv
->
tv_£c
 = 
__vsysÿÎ_gtod_d©a
.
w®l_time_£c
;

142 
n£c
 = 
__vsysÿÎ_gtod_d©a
.
w®l_time_n£c
;

143 } 
	`»ad_£q»Œy
(&
__vsysÿÎ_gtod_d©a
.
lock
, 
£q
));

146 
cyşe_d–
 = (
now
 - 
ba£
è& 
mask
;

148 
n£c
 +ğ(
cyşe_d–
 * 
muÉ
è>> 
shiá
;

150 
n£c
 >ğ
NSEC_PER_SEC
) {

151 
tv
->
tv_£c
 += 1;

152 
n£c
 -ğ
NSEC_PER_SEC
;

154 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

155 
	}
}

157 
	$__vsysÿÎ
(0è
	$vg‘timeofday
(
timev®
 * 
tv
, 
timezÚe
 * 
tz
)

159 ià(
tv
)

160 
	`do_vg‘timeofday
(
tv
);

161 ià(
tz
)

162 
	`do_g‘_tz
(
tz
);

164 
	}
}

168 
time_t
 
	$__vsysÿÎ
(1è
	$vtime
(
time_t
 *
t
)

170 
timev®
 
tv
;

171 
time_t
 
»suÉ
;

172 ià(
	`uÆik–y
(!
__vsysÿÎ_gtod_d©a
.
sysùl_’abËd
))

173  
	`time_sysÿÎ
(
t
);

175 
	`vg‘timeofday
(&
tv
, 
NULL
);

176 
»suÉ
 = 
tv
.
tv_£c
;

177 ià(
t
)

178 *
t
 = 
»suÉ
;

179  
»suÉ
;

180 
	}
}

190 
	$__vsysÿÎ
(2)

191 
	$vg‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
tÿche
)

193 
dummy
, 
p
;

194 
j
 = 0;

204 ià(
tÿche
 &&ÿche->
blob
[0] =ğ(
j
 = 
__jiff›s
)) {

205 
p
 = 
tÿche
->
blob
[1];

206 } ià(
__vg‘ıu_mode
 =ğ
VGETCPU_RDTSCP
) {

208 
	`rdtsı
(
dummy
, dummy, 
p
);

211 
	`asm
("l¦ %1,%0" : "ô" (
p
è: "r" (
__PER_CPU_SEG
));

213 ià(
tÿche
) {

214 
tÿche
->
blob
[0] = 
j
;

215 
tÿche
->
blob
[1] = 
p
;

217 ià(
ıu
)

218 *
ıu
 = 
p
 & 0xfff;

219 ià(
node
)

220 *
node
 = 
p
 >> 12;

222 
	}
}

224 
	$__vsysÿÎ
(3è
	$v’osys_1
()

226  -
ENOSYS
;

227 
	}
}

229 #ifdeà
CONFIG_SYSCTL


231 
	#SYSCALL
 0x050f

	)

232 
	#NOP2
 0x9090

	)

237 
	$vsysÿÎ_sysùl_chªge
(
ùl_bË
 *
ùl
, 
wr™e
, 
fe
 * 
fp
,

238 
__u£r
 *
bufãr
, 
size_t
 *
ËÅ
, 
loff_t
 *
µos
)

240 
u16
 
vsysc1
, 
vsysc2
;

241 
u16
 
__iomem
 *
m­1
;

242 
u16
 
__iomem
 *
m­2
;

243 
»t
 = 
	`´oc_doštvec
(
ùl
, 
wr™e
, 
fp
, 
bufãr
, 
ËÅ
, 
µos
);

244 ià(!
wr™e
)

245  
»t
;

248 
m­1
 = 
	`iÜem­
(
	`__·_vsymbŞ
(&
vsysc1
), 2);

249 ià(!
m­1
)

250  -
ENOMEM
;

251 
m­2
 = 
	`iÜem­
(
	`__·_vsymbŞ
(&
vsysc2
), 2);

252 ià(!
m­2
) {

253 
»t
 = -
ENOMEM
;

254 
out
;

256 ià(!
vsysÿÎ_gtod_d©a
.
sysùl_’abËd
) {

257 
	`wr™ew
(
SYSCALL
, 
m­1
);

258 
	`wr™ew
(
SYSCALL
, 
m­2
);

260 
	`wr™ew
(
NOP2
, 
m­1
);

261 
	`wr™ew
(
NOP2
, 
m­2
);

263 
	`iounm­
(
m­2
);

264 
out
:

265 
	`iounm­
(
m­1
);

266  
»t
;

267 
	}
}

269 
ùl_bË
 
	gk”Ãl_bË2
[] = {

270 { .
´oúame
 = "vsyscall64",

271 .
	gd©a
 = &
vsysÿÎ_gtod_d©a
.
sysùl_’abËd
, .
	gmaxËn
 = (),

272 .
	gmode
 = 0644,

273 .
	g´oc_hªdËr
 = 
vsysÿÎ_sysùl_chªge
 },

277 
ùl_bË
 
	gk”Ãl_roÙ_bË2
[] = {

278 { .
ùl_Çme
 = 
CTL_KERN
, .
	g´oúame
 = "k”Ãl", .
	gmode
 = 0555,

279 .
	gchd
 = 
k”Ãl_bË2
 },

287 
__ıuš™
 
	$vsysÿÎ_£t_ıu
(
ıu
)

289 *
d
;

290 
node
 = 0;

291 #ifdeà
CONFIG_NUMA


292 
node
 = 
	`ıu_to_node
(
ıu
);

294 ià(
	`ıu_has
(&
	`ıu_d©a
(
ıu
), 
X86_FEATURE_RDTSCP
))

295 
	`wr™e_rdtsı_aux
((
node
 << 12è| 
ıu
);

300 
d
 = (*)(
	`ıu_gdt
(
ıu
è+ 
GDT_ENTRY_PER_CPU
);

301 *
d
 = 0x0f40000000000ULL;

302 *
d
 |ğ
ıu
;

303 *
d
 |ğ(
node
 & 0xf) << 12;

304 *
d
 |ğ(
node
 >> 4) << 48;

305 
	}
}

307 
__ıuš™
 
	$ıu_vsysÿÎ_š™
(*
¬g
)

310 
	`vsysÿÎ_£t_ıu
(
	`¿w_smp_´oûssÜ_id
());

311 
	}
}

313 
__ıuš™


314 
	$ıu_vsysÿÎ_nÙif›r
(
nÙif›r_block
 *
n
, 
aùiÚ
, *
¬g
)

316 
ıu
 = ()
¬g
;

317 ià(
aùiÚ
 =ğ
CPU_ONLINE
 ||‡ùiÚ =ğ
CPU_ONLINE_FROZEN
)

318 
	`smp_ÿÎ_funùiÚ_sšgË
(
ıu
, 
ıu_vsysÿÎ_š™
, 
NULL
, 0, 1);

319  
NOTIFY_DONE
;

320 
	}
}

322 
__š™
 
	$m­_vsysÿÎ
()

324 
__vsysÿÎ_0
;

325 
phy§ddr_·ge0
 = 
	`__·_symbŞ
(&
__vsysÿÎ_0
);

328 
	`__£t_fixm­
(
VSYSCALL_FIRST_PAGE
, 
phy§ddr_·ge0
, 
PAGE_KERNEL_VSYSCALL
);

329 
	}
}

331 
__š™
 
	$vsysÿÎ_š™
()

333 
	`BUG_ON
(((è&
vg‘timeofday
 !=

334 
	`VSYSCALL_ADDR
(
__NR_vg‘timeofday
)));

335 
	`BUG_ON
((è&
vtime
 !ğ
	`VSYSCALL_ADDR
(
__NR_vtime
));

336 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0è!ğ
	`__fix_to_vœt
(
VSYSCALL_FIRST_PAGE
)));

337 
	`BUG_ON
((è&
vg‘ıu
 !ğ
	`VSYSCALL_ADDR
(
__NR_vg‘ıu
));

338 
	`m­_vsysÿÎ
();

339 #ifdeà
CONFIG_SYSCTL


340 
	`»gi¡”_sysùl_bË
(
k”Ãl_roÙ_bË2
);

342 
	`Ú_—ch_ıu
(
ıu_vsysÿÎ_š™
, 
NULL
, 0, 1);

343 
	`hÙıu_nÙif›r
(
ıu_vsysÿÎ_nÙif›r
, 0);

345 
	}
}

347 
__š™ÿÎ
(
vsysÿÎ_š™
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<lšux/moduË.h
>

5 
	~<lšux/smp.h
>

7 
	~<asm/£m­hÜe.h
>

8 
	~<asm/´oûssÜ.h
>

9 
	~<asm/uacûss.h
>

10 
	~<asm/pgbË.h
>

12 
EXPORT_SYMBOL
(
k”Ãl_th»ad
);

14 
EXPORT_SYMBOL
(
__down_çed
);

15 
EXPORT_SYMBOL
(
__down_çed_š‹¼u±ibË
);

16 
EXPORT_SYMBOL
(
__down_çed_Œylock
);

17 
EXPORT_SYMBOL
(
__up_wakeup
);

19 
EXPORT_SYMBOL
(
__g‘_u£r_1
);

20 
EXPORT_SYMBOL
(
__g‘_u£r_2
);

21 
EXPORT_SYMBOL
(
__g‘_u£r_4
);

22 
EXPORT_SYMBOL
(
__g‘_u£r_8
);

23 
EXPORT_SYMBOL
(
__put_u£r_1
);

24 
EXPORT_SYMBOL
(
__put_u£r_2
);

25 
EXPORT_SYMBOL
(
__put_u£r_4
);

26 
EXPORT_SYMBOL
(
__put_u£r_8
);

28 
EXPORT_SYMBOL
(
cİy_u£r_g’”ic
);

29 
EXPORT_SYMBOL
(
__cİy_u£r_noÿche
);

30 
EXPORT_SYMBOL
(
cİy_äom_u£r
);

31 
EXPORT_SYMBOL
(
cİy_to_u£r
);

32 
EXPORT_SYMBOL
(
__cİy_äom_u£r_š©omic
);

34 
EXPORT_SYMBOL
(
cİy_·ge
);

35 
EXPORT_SYMBOL
(
ş—r_·ge
);

37 #ifdeà
CONFIG_SMP


38 
__wr™e_lock_çed
(
rwlock_t
 *
rw
);

39 
__»ad_lock_çed
(
rwlock_t
 *
rw
);

40 
EXPORT_SYMBOL
(
__wr™e_lock_çed
);

41 
EXPORT_SYMBOL
(
__»ad_lock_çed
);

46 #undeà
memıy


47 #undeà
mem£t


48 #undeà
memmove


50 * 
mem£t
(*,,
__k”Ãl_size_t
);

51 * 
memıy
(*,cÚ¡ *,
__k”Ãl_size_t
);

52 * 
__memıy
(*,cÚ¡ *,
__k”Ãl_size_t
);

54 
EXPORT_SYMBOL
(
mem£t
);

55 
EXPORT_SYMBOL
(
memıy
);

56 
EXPORT_SYMBOL
(
__memıy
);

58 
EXPORT_SYMBOL
(
em±y_z”o_·ge
);

59 
EXPORT_SYMBOL
(
š™_Ëv–4_pgt
);

60 
EXPORT_SYMBOL
(
lßd_gs_šdex
);

62 
EXPORT_SYMBOL
(
_´oxy_pda
);

	@/cmpt816/linux/arch/x86/mm/extable_64.c

5 
	~<lšux/moduË.h
>

6 
	~<lšux/¥šlock.h
>

7 
	~<lšux/š™.h
>

8 
	~<asm/uacûss.h
>

11 cÚ¡ 
exû±iÚ_bË_’Œy
 *

12 
	$£¬ch_exbË
(cÚ¡ 
exû±iÚ_bË_’Œy
 *
fœ¡
,

13 cÚ¡ 
exû±iÚ_bË_’Œy
 *
Ï¡
,

14 
v®ue
)

17 ià((
v®ue
 >> 32) == 0)

18 
v®ue
 |= 0xffffffffUL << 32;

20 
fœ¡
 <ğ
Ï¡
) {

21 cÚ¡ 
exû±iÚ_bË_’Œy
 *
mid
;

22 
diff
;

24 
mid
 = (
Ï¡
 - 
fœ¡
) / 2 + first;

25 
diff
 = 
mid
->
š¢
 - 
v®ue
;

26 ià(
diff
 == 0)

27  
mid
;

28 ià(
diff
 < 0)

29 
fœ¡
 = 
mid
+1;

31 
Ï¡
 = 
mid
-1;

33  
NULL
;

34 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault_64.c

8 
	~<lšux/sigÇl.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/ty³s.h
>

14 
	~<lšux/±¿û.h
>

15 
	~<lšux/mmª.h
>

16 
	~<lšux/mm.h
>

17 
	~<lšux/smp.h
>

18 
	~<lšux/š‹¼u±.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/‰y.h
>

21 
	~<lšux/vt_k”n.h
>

22 
	~<lšux/comp”.h
>

23 
	~<lšux/vm®loc.h
>

24 
	~<lšux/moduË.h
>

25 
	~<lšux/k´obes.h
>

26 
	~<lšux/uacûss.h
>

27 
	~<lšux/kdebug.h
>

28 
	~<lšux/k´obes.h
>

30 
	~<asm/sy¡em.h
>

31 
	~<asm/pg®loc.h
>

32 
	~<asm/smp.h
>

33 
	~<asm/bæush.h
>

34 
	~<asm/´Ùo.h
>

35 
	~<asm-g’”ic/£ùiÚs.h
>

38 
	#PF_PROT
 (1<<0è

	)

39 
	#PF_WRITE
 (1<<1)

	)

40 
	#PF_USER
 (1<<2)

	)

41 
	#PF_RSVD
 (1<<3)

	)

42 
	#PF_INSTR
 (1<<4)

	)

44 #ifdeà
CONFIG_KPROBES


45 
šlše
 
	$nÙify_·ge_çuÉ
(
±_»gs
 *
»gs
)

47 
»t
 = 0;

50 ià(!
	`u£r_mode
(
»gs
)) {

51 
	`´“m±_di§bË
();

52 ià(
	`k´obe_ruÂšg
(è&& 
	`k´obe_çuÉ_hªdËr
(
»gs
, 14))

53 
»t
 = 1;

54 
	`´“m±_’abË
();

57  
»t
;

58 
	}
}

60 
šlše
 
	$nÙify_·ge_çuÉ
(
±_»gs
 *
»gs
)

63 
	}
}

69 
nošlše
 
	$is_´eãtch
(
±_»gs
 *
»gs
, 
addr
,

70 
”rÜ_code
)

72 *
š¡r
;

73 
sÿn_mÜe
 = 1;

74 
´eãtch
 = 0;

75 *
max_š¡r
;

78 ià(
”rÜ_code
 & 
PF_INSTR
)

81 
š¡r
 = (
__u£r
 *)
	`cÚv”t_r_to_lš—r
(
cu¼’t
, 
»gs
);

82 
max_š¡r
 = 
š¡r
 + 15;

84 ià(
	`u£r_mode
(
»gs
è&& 
š¡r
 >ğ(*)
TASK_SIZE
)

87 
sÿn_mÜe
 && 
š¡r
 < 
max_š¡r
) {

88 
İcode
;

89 
š¡r_hi
;

90 
š¡r_lo
;

92 ià(
	`´obe_k”Ãl_add»ss
(
š¡r
, 
İcode
))

95 
š¡r_hi
 = 
İcode
 & 0xf0;

96 
š¡r_lo
 = 
İcode
 & 0x0f;

97 
š¡r
++;

99 
š¡r_hi
) {

106 
sÿn_mÜe
 = ((
š¡r_lo
 & 7) == 0x6);

116 
sÿn_mÜe
 = (!
	`u£r_mode
(
»gs
)è|| (»gs->
cs
 =ğ
__USER_CS
);

121 
sÿn_mÜe
 = (
š¡r_lo
 & 0xC) == 0x4;

125 
sÿn_mÜe
 = !
š¡r_lo
 || (instr_lo>>1) == 1;

129 
sÿn_mÜe
 = 0;

130 ià(
	`´obe_k”Ãl_add»ss
(
š¡r
, 
İcode
))

132 
´eãtch
 = (
š¡r_lo
 == 0xF) &&

133 (
İcode
 == 0x0D || opcode == 0x18);

136 
sÿn_mÜe
 = 0;

140  
´eãtch
;

141 
	}
}

143 
	$bad_add»ss
(*
p
)

145 
dummy
;

146  
	`´obe_k”Ãl_add»ss
((*)
p
, 
dummy
);

147 
	}
}

149 
	$dump_·g‘abË
(
add»ss
)

151 
pgd_t
 *
pgd
;

152 
pud_t
 *
pud
;

153 
pmd_t
 *
pmd
;

154 
±e_t
 *
±e
;

156 
pgd
 = (
pgd_t
 *)
	`»ad_ü3
();

158 
pgd
 = 
	`__va
((ígd & 
PHYSICAL_PAGE_MASK
);

159 
pgd
 +ğ
	`pgd_šdex
(
add»ss
);

160 ià(
	`bad_add»ss
(
pgd
)è
bad
;

161 
	`´štk
("PGD %lx ", 
	`pgd_v®
(*
pgd
));

162 ià(!
	`pgd_´e£Á
(*
pgd
)è
»t
;

164 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

165 ià(
	`bad_add»ss
(
pud
)è
bad
;

166 
	`´štk
("PUD %lx ", 
	`pud_v®
(*
pud
));

167 ià(!
	`pud_´e£Á
(*
pud
)è
»t
;

169 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

170 ià(
	`bad_add»ss
(
pmd
)è
bad
;

171 
	`´štk
("PMD %lx ", 
	`pmd_v®
(*
pmd
));

172 ià(!
	`pmd_´e£Á
(*
pmd
è|| 
	`pmd_Ïrge
(*pmd)è
»t
;

174 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

175 ià(
	`bad_add»ss
(
±e
)è
bad
;

176 
	`´štk
("PTE %lx", 
	`±e_v®
(*
±e
));

177 
»t
:

178 
	`´štk
("\n");

180 
bad
:

181 
	`´štk
("BAD\n");

182 
	}
}

184 cÚ¡ 
	g”¿93_w¬nšg
[] =

185 
KERN_ERR
 "******* Your BIOS seemso‚ot contain‡ fix for K8ƒrrata #93\n"

186 
KERN_ERR
 "******* Working‡round it, but it may cause SEGVs or burn…ower.\n"

187 
KERN_ERR
 "******* Please consider‡ BIOS update.\n"

188 
KERN_ERR
 "******* Disabling USB†egacy inhe BIOS may‡lso help.\n";

198 
	$is_”¿93
(
±_»gs
 *
»gs
, 
add»ss
)

200 
w¬Ãd
;

201 ià(
add»ss
 !ğ
»gs
->
r
)

203 ià((
add»ss
 >> 32) != 0)

205 
add»ss
 |= 0xffffffffUL << 32;

206 ià((
add»ss
 >ğ(
u64
)
_¡ext
 &&‡dd»s <ğ(u64)
_‘ext
) ||

207 (
add»ss
 >ğ
MODULES_VADDR
 &&‡dd»s <ğ
MODULES_END
)) {

208 ià(!
w¬Ãd
) {

209 
	`´štk
(
”¿93_w¬nšg
);

210 
w¬Ãd
 = 1;

212 
»gs
->
r
 = 
add»ss
;

216 
	}
}

218 
nošlše
 
	$pgbË_bad
(
add»ss
, 
±_»gs
 *
»gs
,

219 
”rÜ_code
)

221 
æags
 = 
	`oİs_begš
();

222 
sk_¡ruù
 *
tsk
;

224 
	`´štk
(
KERN_ALERT
 "%s: Corrupted…ageable‡t‡ddress %lx\n",

225 
cu¼’t
->
comm
, 
add»ss
);

226 
	`dump_·g‘abË
(
add»ss
);

227 
tsk
 = 
cu¼’t
;

228 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

229 
tsk
->
th»ad
.
Œ­_no
 = 14;

230 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

231 
	`__d›
("Bad…ag‘abË", 
»gs
, 
”rÜ_code
);

232 
	`oİs_’d
(
æags
);

233 
	`do_ex™
(
SIGKILL
);

234 
	}
}

241 
	$vm®loc_çuÉ
(
add»ss
)

243 
pgd_t
 *
pgd
, *
pgd_»f
;

244 
pud_t
 *
pud
, *
pud_»f
;

245 
pmd_t
 *
pmd
, *
pmd_»f
;

246 
±e_t
 *
±e
, *
±e_»f
;

252 
pgd
 = 
	`pgd_off£t
(
cu¼’t
->
mm
 ?: &
š™_mm
, 
add»ss
);

253 
pgd_»f
 = 
	`pgd_off£t_k
(
add»ss
);

254 ià(
	`pgd_nÚe
(*
pgd_»f
))

256 ià(
	`pgd_nÚe
(*
pgd
))

257 
	`£t_pgd
(
pgd
, *
pgd_»f
);

259 
	`BUG_ON
(
	`pgd_·ge_vaddr
(*
pgd
è!ğpgd_·ge_vaddr(*
pgd_»f
));

264 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

265 
pud_»f
 = 
	`pud_off£t
(
pgd_»f
, 
add»ss
);

266 ià(
	`pud_nÚe
(*
pud_»f
))

268 ià(
	`pud_nÚe
(*
pud
è|| 
	`pud_·ge_vaddr
(*pudè!ğpud_·ge_vaddr(*
pud_»f
))

269 
	`BUG
();

270 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

271 
pmd_»f
 = 
	`pmd_off£t
(
pud_»f
, 
add»ss
);

272 ià(
	`pmd_nÚe
(*
pmd_»f
))

274 ià(
	`pmd_nÚe
(*
pmd
è|| 
	`pmd_·ge
(*pmdè!ğpmd_·ge(*
pmd_»f
))

275 
	`BUG
();

276 
±e_»f
 = 
	`±e_off£t_k”Ãl
(
pmd_»f
, 
add»ss
);

277 ià(!
	`±e_´e£Á
(*
±e_»f
))

279 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

283 ià(!
	`±e_´e£Á
(*
±e
è|| 
	`±e_pâ
(*±eè!ğ±e_pâ(*
±e_»f
))

284 
	`BUG
();

286 
	}
}

288 
	gshow_unhªdËd_sigÇls
 = 1;

295 
asmlškage
 
__k´obes
 
	$do_·ge_çuÉ
(
±_»gs
 *
»gs
,

296 
”rÜ_code
)

298 
sk_¡ruù
 *
tsk
;

299 
mm_¡ruù
 *
mm
;

300 
vm_¬—_¡ruù
 * 
vma
;

301 
add»ss
;

302 cÚ¡ 
exû±iÚ_bË_’Œy
 *
fixup
;

303 
wr™e
, 
çuÉ
;

304 
æags
;

305 
sigšfo_t
 
šfo
;

310 
	`Œaû_h¬dœqs_fixup
();

312 
tsk
 = 
cu¼’t
;

313 
mm
 = 
tsk
->mm;

314 
	`´eãtchw
(&
mm
->
mm­_£m
);

317 
add»ss
 = 
	`»ad_ü2
();

319 
šfo
.
si_code
 = 
SEGV_MAPERR
;

335 ià(
	`uÆik–y
(
add»ss
 >ğ
TASK_SIZE64
)) {

341 ià(!(
”rÜ_code
 & (
PF_RSVD
|
PF_USER
|
PF_PROT
)) &&

342 ((
add»ss
 >ğ
VMALLOC_START
 &&‡dd»s < 
VMALLOC_END
))) {

343 ià(
	`vm®loc_çuÉ
(
add»ss
) >= 0)

346 ià(
	`nÙify_·ge_çuÉ
(
»gs
))

352 
bad_¬—_no£m­hÜe
;

355 ià(
	`nÙify_·ge_çuÉ
(
»gs
))

358 ià(
	`lik–y
(
»gs
->
eæags
 & 
X86_EFLAGS_IF
))

359 
	`loÿl_œq_’abË
();

361 ià(
	`uÆik–y
(
”rÜ_code
 & 
PF_RSVD
))

362 
	`pgbË_bad
(
add»ss
, 
»gs
, 
”rÜ_code
);

368 ià(
	`uÆik–y
(
	`š_©omic
(è|| !
mm
))

369 
bad_¬—_no£m­hÜe
;

375 ià(
	`u£r_mode_vm
(
»gs
))

376 
”rÜ_code
 |ğ
PF_USER
;

378 
agaš
:

394 ià(!
	`down_»ad_Œylock
(&
mm
->
mm­_£m
)) {

395 ià((
”rÜ_code
 & 
PF_USER
) == 0 &&

396 !
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
))

397 
bad_¬—_no£m­hÜe
;

398 
	`down_»ad
(&
mm
->
mm­_£m
);

401 
vma
 = 
	`fšd_vma
(
mm
, 
add»ss
);

402 ià(!
vma
)

403 
bad_¬—
;

404 ià(
	`lik–y
(
vma
->
vm_¡¬t
 <ğ
add»ss
))

405 
good_¬—
;

406 ià(!(
vma
->
vm_æags
 & 
VM_GROWSDOWN
))

407 
bad_¬—
;

408 ià(
”rÜ_code
 & 4) {

412 ià(
add»ss
 + 65536 + 32 * (è< 
»gs
->
r¥
)

413 
bad_¬—
;

415 ià(
	`ex·nd_¡ack
(
vma
, 
add»ss
))

416 
bad_¬—
;

421 
good_¬—
:

422 
šfo
.
si_code
 = 
SEGV_ACCERR
;

423 
wr™e
 = 0;

424 
”rÜ_code
 & (
PF_PROT
|
PF_WRITE
)) {

427 
PF_WRITE
:

428 ià(!(
vma
->
vm_æags
 & 
VM_WRITE
))

429 
bad_¬—
;

430 
wr™e
++;

432 
PF_PROT
:

433 
bad_¬—
;

435 ià(!(
vma
->
vm_æags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
)))

436 
bad_¬—
;

444 
çuÉ
 = 
	`hªdË_mm_çuÉ
(
mm
, 
vma
, 
add»ss
, 
wr™e
);

445 ià(
	`uÆik–y
(
çuÉ
 & 
VM_FAULT_ERROR
)) {

446 ià(
çuÉ
 & 
VM_FAULT_OOM
)

447 
out_of_memÜy
;

448 ià(
çuÉ
 & 
VM_FAULT_SIGBUS
)

449 
do_sigbus
;

450 
	`BUG
();

452 ià(
çuÉ
 & 
VM_FAULT_MAJOR
)

453 
tsk
->
maj_æt
++;

455 
tsk
->
mš_æt
++;

456 
	`up_»ad
(&
mm
->
mm­_£m
);

463 
bad_¬—
:

464 
	`up_»ad
(&
mm
->
mm­_£m
);

466 
bad_¬—_no£m­hÜe
:

468 ià(
”rÜ_code
 & 
PF_USER
) {

473 
	`loÿl_œq_’abË
();

475 ià(
	`is_´eãtch
(
»gs
, 
add»ss
, 
”rÜ_code
))

484 ià((
»gs
->
cs
 =ğ
__USER32_CS
 || (regs->cs & (1<<2))) &&

485 (
add»ss
 >> 32))

488 ià(
show_unhªdËd_sigÇls
 && 
	`unhªdËd_sigÇl
(
tsk
, 
SIGSEGV
) &&

489 
	`´štk_¿‹lim™
()) {

490 
	`´štk
(

492 
tsk
->
pid
 > 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

493 
tsk
->
comm
,sk->
pid
, 
add»ss
, 
»gs
->
r
,

494 
»gs
->
r¥
, 
”rÜ_code
);

497 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

499 
tsk
->
th»ad
.
”rÜ_code
 =ƒ¼Ü_cod| (
add»ss
 >ğ
TASK_SIZE
);

500 
tsk
->
th»ad
.
Œ­_no
 = 14;

501 
šfo
.
si_signo
 = 
SIGSEGV
;

502 
šfo
.
si_”ºo
 = 0;

504 
šfo
.
si_addr
 = (
__u£r
 *)
add»ss
;

505 
	`fÜû_sig_šfo
(
SIGSEGV
, &
šfo
, 
tsk
);

509 
no_cÚ‹xt
:

512 
fixup
 = 
	`£¬ch_exû±iÚ_bËs
(
»gs
->
r
);

513 ià(
fixup
) {

514 
»gs
->
r
 = 
fixup
->fixup;

522 ià(
	`is_´eãtch
(
»gs
, 
add»ss
, 
”rÜ_code
))

525 ià(
	`is_”¿93
(
»gs
, 
add»ss
))

533 
æags
 = 
	`oİs_begš
();

535 ià(
add»ss
 < 
PAGE_SIZE
)

536 
	`´štk
(
KERN_ALERT
 "Unableo handle kernel NULL…ointer dereference");

538 
	`´štk
(
KERN_ALERT
 "Unableo handle kernel…aging„equest");

539 
	`´štk
("‡ˆ%016lx RIP: \n" 
KERN_ALERT
,
add»ss
);

540 
	`´štk_add»ss
(
»gs
->
r
);

541 
	`dump_·g‘abË
(
add»ss
);

542 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

543 
tsk
->
th»ad
.
Œ­_no
 = 14;

544 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

545 
	`__d›
("Oİs", 
»gs
, 
”rÜ_code
);

547 
	`´štk
(
KERN_EMERG
 "CR2: %016lx\n", 
add»ss
);

548 
	`oİs_’d
(
æags
);

549 
	`do_ex™
(
SIGKILL
);

555 
out_of_memÜy
:

556 
	`up_»ad
(&
mm
->
mm­_£m
);

557 ià(
	`is_glob®_š™
(
cu¼’t
)) {

558 
	`y›ld
();

559 
agaš
;

561 
	`´štk
("VM: klšg…roûs %s\n", 
tsk
->
comm
);

562 ià(
”rÜ_code
 & 4)

563 
	`do_group_ex™
(
SIGKILL
);

564 
no_cÚ‹xt
;

566 
do_sigbus
:

567 
	`up_»ad
(&
mm
->
mm­_£m
);

570 ià(!(
”rÜ_code
 & 
PF_USER
))

571 
no_cÚ‹xt
;

573 
tsk
->
th»ad
.
ü2
 = 
add»ss
;

574 
tsk
->
th»ad
.
”rÜ_code
 =ƒrror_code;

575 
tsk
->
th»ad
.
Œ­_no
 = 14;

576 
šfo
.
si_signo
 = 
SIGBUS
;

577 
šfo
.
si_”ºo
 = 0;

578 
šfo
.
si_code
 = 
BUS_ADRERR
;

579 
šfo
.
si_addr
 = (
__u£r
 *)
add»ss
;

580 
	`fÜû_sig_šfo
(
SIGBUS
, &
šfo
, 
tsk
);

582 
	}
}

584 
DEFINE_SPINLOCK
(
pgd_lock
);

585 
LIST_HEAD
(
pgd_li¡
);

587 
	$vm®loc_sync_®l
()

593 
	`DECLARE_BITMAP
(
šsync
, 
PTRS_PER_PGD
);

594 
¡¬t
 = 
VMALLOC_START
 & 
PGDIR_MASK
;

595 
add»ss
;

597 
add»ss
 = 
¡¬t
;‡dd»s <ğ
VMALLOC_END
;‡dd»s +ğ
PGDIR_SIZE
) {

598 ià(!
	`‹¡_b™
(
	`pgd_šdex
(
add»ss
), 
šsync
)) {

599 cÚ¡ 
pgd_t
 *
pgd_»f
 = 
	`pgd_off£t_k
(
add»ss
);

600 
·ge
 *page;

602 ià(
	`pgd_nÚe
(*
pgd_»f
))

604 
	`¥š_lock
(&
pgd_lock
);

605 
	`li¡_fÜ_—ch_’Œy
(
·ge
, &
pgd_li¡
, 
Ìu
) {

606 
pgd_t
 *
pgd
;

607 
pgd
 = (
pgd_t
 *)
	`·ge_add»ss
(
·ge
è+ 
	`pgd_šdex
(
add»ss
);

608 ià(
	`pgd_nÚe
(*
pgd
))

609 
	`£t_pgd
(
pgd
, *
pgd_»f
);

611 
	`BUG_ON
(
	`pgd_·ge_vaddr
(*
pgd
è!ğpgd_·ge_vaddr(*
pgd_»f
));

613 
	`¥š_uÆock
(&
pgd_lock
);

614 
	`£t_b™
(
	`pgd_šdex
(
add»ss
), 
šsync
);

616 ià(
add»ss
 =ğ
¡¬t
)

617 
¡¬t
 = 
add»ss
 + 
PGDIR_SIZE
;

620 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

621 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1è& 
PGDIR_MASK
) ==

622 (
__START_KERNEL
 & 
PGDIR_MASK
)));

623 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<lšux/š™.h
>

8 
	~<lšux/fs.h
>

9 
	~<lšux/mm.h
>

10 
	~<lšux/hug‘lb.h
>

11 
	~<lšux/·gem­.h
>

12 
	~<lšux/¦ab.h
>

13 
	~<lšux/”r.h
>

14 
	~<lšux/sysùl.h
>

15 
	~<asm/mmª.h
>

16 
	~<asm/b.h
>

17 
	~<asm/bæush.h
>

19 
	$·ge_bË_sh¬—bË
(
vm_¬—_¡ruù
 *
svma
,

20 
vm_¬—_¡ruù
 *
vma
,

21 
addr
, 
pgoff_t
 
idx
)

23 
§ddr
 = ((
idx
 - 
svma
->
vm_pgoff
è<< 
PAGE_SHIFT
) +

24 
svma
->
vm_¡¬t
;

25 
sba£
 = 
§ddr
 & 
PUD_MASK
;

26 
s_’d
 = 
sba£
 + 
PUD_SIZE
;

32 ià(
	`pmd_šdex
(
addr
è!ğpmd_šdex(
§ddr
) ||

33 
vma
->
vm_æags
 !ğ
svma
->vm_flags ||

34 
sba£
 < 
svma
->
vm_¡¬t
 || svma->
vm_’d
 < 
s_’d
)

37  
§ddr
;

38 
	}
}

40 
	$vma_sh¬—bË
(
vm_¬—_¡ruù
 *
vma
, 
addr
)

42 
ba£
 = 
addr
 & 
PUD_MASK
;

43 
’d
 = 
ba£
 + 
PUD_SIZE
;

48 ià(
vma
->
vm_æags
 & 
VM_MAYSHARE
 &&

49 
vma
->
vm_¡¬t
 <ğ
ba£
 && 
’d
 <ğvma->
vm_’d
)

52 
	}
}

57 
	$huge_pmd_sh¬e
(
mm_¡ruù
 *
mm
, 
addr
, 
pud_t
 *
pud
)

59 
vm_¬—_¡ruù
 *
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

60 
add»ss_¥aû
 *
m­pšg
 = 
vma
->
vm_fe
->
f_m­pšg
;

61 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_¡¬t
è>> 
PAGE_SHIFT
) +

62 
vma
->
vm_pgoff
;

63 
´io_Œ“_™”
 
™”
;

64 
vm_¬—_¡ruù
 *
svma
;

65 
§ddr
;

66 
±e_t
 *
¥‹
 = 
NULL
;

68 ià(!
	`vma_sh¬—bË
(
vma
, 
addr
))

71 
	`¥š_lock
(&
m­pšg
->
i_mm­_lock
);

72 
	`vma_´io_Œ“_fÜ—ch
(
svma
, &
™”
, &
m­pšg
->
i_mm­
, 
idx
, idx) {

73 ià(
svma
 =ğ
vma
)

76 
§ddr
 = 
	`·ge_bË_sh¬—bË
(
svma
, 
vma
, 
addr
, 
idx
);

77 ià(
§ddr
) {

78 
¥‹
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
§ddr
);

79 ià(
¥‹
) {

80 
	`g‘_·ge
(
	`vœt_to_·ge
(
¥‹
));

86 ià(!
¥‹
)

87 
out
;

89 
	`¥š_lock
(&
mm
->
·ge_bË_lock
);

90 ià(
	`pud_nÚe
(*
pud
))

91 
	`pud_pİuÏ‹
(
mm
, 
pud
, (è
¥‹
 & 
PAGE_MASK
);

93 
	`put_·ge
(
	`vœt_to_·ge
(
¥‹
));

94 
	`¥š_uÆock
(&
mm
->
·ge_bË_lock
);

95 
out
:

96 
	`¥š_uÆock
(&
m­pšg
->
i_mm­_lock
);

97 
	}
}

111 
	$huge_pmd_unsh¬e
(
mm_¡ruù
 *
mm
, *
addr
, 
±e_t
 *
±•
)

113 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

114 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

116 
	`BUG_ON
(
	`·ge_couÁ
(
	`vœt_to_·ge
(
±•
)) == 0);

117 ià(
	`·ge_couÁ
(
	`vœt_to_·ge
(
±•
)) == 1)

120 
	`pud_ş—r
(
pud
);

121 
	`put_·ge
(
	`vœt_to_·ge
(
±•
));

122 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

124 
	}
}

126 
±e_t
 *
	$huge_±e_®loc
(
mm_¡ruù
 *
mm
, 
addr
)

128 
pgd_t
 *
pgd
;

129 
pud_t
 *
pud
;

130 
±e_t
 *
±e
 = 
NULL
;

132 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

133 
pud
 = 
	`pud_®loc
(
mm
, 
pgd
, 
addr
);

134 ià(
pud
) {

135 ià(
	`pud_nÚe
(*
pud
))

136 
	`huge_pmd_sh¬e
(
mm
, 
addr
, 
pud
);

137 
±e
 = (
±e_t
 *è
	`pmd_®loc
(
mm
, 
pud
, 
addr
);

139 
	`BUG_ON
(
±e
 && !
	`±e_nÚe
(*±eè&& !
	`±e_huge
(*pte));

141  
±e
;

142 
	}
}

144 
±e_t
 *
	$huge_±e_off£t
(
mm_¡ruù
 *
mm
, 
addr
)

146 
pgd_t
 *
pgd
;

147 
pud_t
 *
pud
;

148 
pmd_t
 *
pmd
 = 
NULL
;

150 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

151 ià(
	`pgd_´e£Á
(*
pgd
)) {

152 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

153 ià(
	`pud_´e£Á
(*
pud
))

154 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

156  (
±e_t
 *è
pmd
;

157 
	}
}

160 
·ge
 *

161 
	$fŞlow_huge_addr
(
mm_¡ruù
 *
mm
, 
add»ss
, 
wr™e
)

163 
¡¬t
 = 
add»ss
;

164 
Ëngth
 = 1;

165 
Ä
;

166 
·ge
 *page;

167 
vm_¬—_¡ruù
 *
vma
;

169 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

170 ià(!
vma
 || !
	`is_vm_hug‘lb_·ge
(vma))

171  
	`ERR_PTR
(-
EINVAL
);

173 
±e
 = 
	`huge_±e_off£t
(
mm
, 
add»ss
);

176 
	`WARN_ON
(!
±e
 || 
	`±e_nÚe
(*pte));

178 
·ge
 = &
	`±e_·ge
(*
±e
)[
vpâ
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

180 
	`WARN_ON
(!
	`PageCompound
(
·ge
));

182  
·ge
;

183 
	}
}

185 
	$pmd_huge
(
pmd_t
 
pmd
)

188 
	}
}

190 
·ge
 *

191 
	$fŞlow_huge_pmd
(
mm_¡ruù
 *
mm
, 
add»ss
,

192 
pmd_t
 *
pmd
, 
wr™e
)

194  
NULL
;

195 
	}
}

199 
·ge
 *

200 
	$fŞlow_huge_addr
(
mm_¡ruù
 *
mm
, 
add»ss
, 
wr™e
)

202  
	`ERR_PTR
(-
EINVAL
);

203 
	}
}

205 
	$pmd_huge
(
pmd_t
 
pmd
)

207  !!(
	`pmd_v®
(
pmd
è& 
_PAGE_PSE
);

208 
	}
}

210 
·ge
 *

211 
	$fŞlow_huge_pmd
(
mm_¡ruù
 *
mm
, 
add»ss
,

212 
pmd_t
 *
pmd
, 
wr™e
)

214 
·ge
 *page;

216 
·ge
 = 
	`±e_·ge
(*(
±e_t
 *)
pmd
);

217 ià(
·ge
)

218 
·ge
 +ğ((
add»ss
 & ~
HPAGE_MASK
è>> 
PAGE_SHIFT
);

219  
·ge
;

220 
	}
}

225 #ifdeà
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


226 
	$hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
 *file,

227 
addr
, 
Ën
,

228 
pgoff
, 
æags
)

230 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

231 
vm_¬—_¡ruù
 *
vma
;

232 
¡¬t_addr
;

234 ià(
Ën
 > 
mm
->
ÿched_hŞe_size
) {

235 
¡¬t_addr
 = 
mm
->
ä“_¬—_ÿche
;

237 
¡¬t_addr
 = 
TASK_UNMAPPED_BASE
;

238 
mm
->
ÿched_hŞe_size
 = 0;

241 
fuÎ_£¬ch
:

242 
addr
 = 
	`ALIGN
(
¡¬t_addr
, 
HPAGE_SIZE
);

244 
vma
 = 
	`fšd_vma
(
mm
, 
addr
); ; vm¨ğvma->
vm_Ãxt
) {

246 ià(
TASK_SIZE
 - 
Ën
 < 
addr
) {

251 ià(
¡¬t_addr
 !ğ
TASK_UNMAPPED_BASE
) {

252 
¡¬t_addr
 = 
TASK_UNMAPPED_BASE
;

253 
mm
->
ÿched_hŞe_size
 = 0;

254 
fuÎ_£¬ch
;

256  -
ENOMEM
;

258 ià(!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
) {

259 
mm
->
ä“_¬—_ÿche
 = 
addr
 + 
Ën
;

260  
addr
;

262 ià(
addr
 + 
mm
->
ÿched_hŞe_size
 < 
vma
->
vm_¡¬t
)

263 
mm
->
ÿched_hŞe_size
 = 
vma
->
vm_¡¬t
 - 
addr
;

264 
addr
 = 
	`ALIGN
(
vma
->
vm_’d
, 
HPAGE_SIZE
);

266 
	}
}

268 
	$hug‘lb_g‘_unm­³d_¬—_tİdown
(
fe
 *file,

269 
addr0
, 
Ën
,

270 
pgoff
, 
æags
)

272 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

273 
vm_¬—_¡ruù
 *
vma
, *
´ev_vma
;

274 
ba£
 = 
mm
->
mm­_ba£
, 
addr
 = 
addr0
;

275 
Ïrge¡_hŞe
 = 
mm
->
ÿched_hŞe_size
;

276 
fœ¡_time
 = 1;

279 ià(
mm
->
ä“_¬—_ÿche
 > 
ba£
)

280 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

282 ià(
Ën
 <ğ
Ïrge¡_hŞe
) {

283 
Ïrge¡_hŞe
 = 0;

284 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

286 
Œy_agaš
:

288 ià(
mm
->
ä“_¬—_ÿche
 < 
Ën
)

289 
ç
;

292 
addr
 = (
mm
->
ä“_¬—_ÿche
 - 
Ën
è& 
HPAGE_MASK
;

298 ià(!(
vma
 = 
	`fšd_vma_´ev
(
mm
, 
addr
, &
´ev_vma
)))

299  
addr
;

305 ià(
addr
 + 
Ën
 <ğ
vma
->
vm_¡¬t
 &&

306 (!
´ev_vma
 || (
addr
 >ğ´ev_vma->
vm_’d
))) {

308 
mm
->
ÿched_hŞe_size
 = 
Ïrge¡_hŞe
;

309  (
mm
->
ä“_¬—_ÿche
 = 
addr
);

312 ià(
mm
->
ä“_¬—_ÿche
 =ğ
vma
->
vm_’d
) {

313 
mm
->
ä“_¬—_ÿche
 = 
vma
->
vm_¡¬t
;

314 
mm
->
ÿched_hŞe_size
 = 
Ïrge¡_hŞe
;

319 ià(
addr
 + 
Ïrge¡_hŞe
 < 
vma
->
vm_¡¬t
)

320 
Ïrge¡_hŞe
 = 
vma
->
vm_¡¬t
 - 
addr
;

323 
addr
 = (
vma
->
vm_¡¬t
 - 
Ën
è& 
HPAGE_MASK
;

324 } 
Ën
 <ğ
vma
->
vm_¡¬t
);

326 
ç
:

331 ià(
fœ¡_time
) {

332 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

333 
Ïrge¡_hŞe
 = 0;

334 
fœ¡_time
 = 0;

335 
Œy_agaš
;

343 
mm
->
ä“_¬—_ÿche
 = 
TASK_UNMAPPED_BASE
;

344 
mm
->
ÿched_hŞe_size
 = ~0UL;

345 
addr
 = 
	`hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
, 
addr0
,

346 
Ën
, 
pgoff
, 
æags
);

351 
mm
->
ä“_¬—_ÿche
 = 
ba£
;

352 
mm
->
ÿched_hŞe_size
 = ~0UL;

354  
addr
;

355 
	}
}

358 
	$hug‘lb_g‘_unm­³d_¬—
(
fe
 *fe, 
addr
,

359 
Ën
, 
pgoff
, 
æags
)

361 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

362 
vm_¬—_¡ruù
 *
vma
;

364 ià(
Ën
 & ~
HPAGE_MASK
)

365  -
EINVAL
;

366 ià(
Ën
 > 
TASK_SIZE
)

367  -
ENOMEM
;

369 ià(
æags
 & 
MAP_FIXED
) {

370 ià(
	`´•¬e_hug•age_¿nge
(
addr
, 
Ën
))

371  -
EINVAL
;

372  
addr
;

375 ià(
addr
) {

376 
addr
 = 
	`ALIGN
×ddr, 
HPAGE_SIZE
);

377 
vma
 = 
	`fšd_vma
(
mm
, 
addr
);

378 ià(
TASK_SIZE
 - 
Ën
 >ğ
addr
 &&

379 (!
vma
 || 
addr
 + 
Ën
 <ğvma->
vm_¡¬t
))

380  
addr
;

382 ià(
mm
->
g‘_unm­³d_¬—
 =ğ
¬ch_g‘_unm­³d_¬—
)

383  
	`hug‘lb_g‘_unm­³d_¬—_bÙtomup
(
fe
, 
addr
, 
Ën
,

384 
pgoff
, 
æags
);

386  
	`hug‘lb_g‘_unm­³d_¬—_tİdown
(
fe
, 
addr
, 
Ën
,

387 
pgoff
, 
æags
);

388 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<lšux/sigÇl.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/±¿û.h
>

16 
	~<lšux/mmª.h
>

17 
	~<lšux/mm.h
>

18 
	~<lšux/sw­.h
>

19 
	~<lšux/smp.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/·gem­.h
>

22 
	~<lšux/boÙmem.h
>

23 
	~<lšux/´oc_fs.h
>

24 
	~<lšux/pci.h
>

25 
	~<lšux/pâ.h
>

26 
	~<lšux/poisÚ.h
>

27 
	~<lšux/dma-m­pšg.h
>

28 
	~<lšux/moduË.h
>

29 
	~<lšux/memÜy_hÙ¶ug.h
>

30 
	~<lšux/nmi.h
>

32 
	~<asm/´oûssÜ.h
>

33 
	~<asm/sy¡em.h
>

34 
	~<asm/uacûss.h
>

35 
	~<asm/pgbË.h
>

36 
	~<asm/pg®loc.h
>

37 
	~<asm/dma.h
>

38 
	~<asm/fixm­.h
>

39 
	~<asm/e820.h
>

40 
	~<asm/­ic.h
>

41 
	~<asm/b.h
>

42 
	~<asm/mmu_cÚ‹xt.h
>

43 
	~<asm/´Ùo.h
>

44 
	~<asm/smp.h
>

45 
	~<asm/£ùiÚs.h
>

47 #iâdeà
D´štk


48 
	#D´štk
(
x
...)

	)

51 cÚ¡ 
dma_m­pšg_İs
* 
	gdma_İs
;

52 
EXPORT_SYMBOL
(
dma_İs
);

54 
dma_»£rve
 
	g__š™d©a
;

56 
DEFINE_PER_CPU
(
mmu_g©h”
, 
mmu_g©h”s
);

64 
	$show_mem
()

66 
i
, 
tÙ®
 = 0, 
»£rved
 = 0;

67 
sh¬ed
 = 0, 
ÿched
 = 0;

68 
pg_d©a_t
 *
pgd©
;

69 
·ge
 *page;

71 
	`´štk
(
KERN_INFO
 "Mem-info:\n");

72 
	`show_ä“_¬—s
();

73 
	`´štk
(
KERN_INFO
 "F»sw­: %6ldkB\n", 
Ä_sw­_·ges
<<(
PAGE_SHIFT
-10));

75 
	`fÜ_—ch_Úlše_pgd©
(
pgd©
) {

76 
i
 = 0; i < 
pgd©
->
node_¥ªÃd_·ges
; ++i) {

79 ià(
	`uÆik–y
(
i
 % 
MAX_ORDER_NR_PAGES
 == 0)) {

80 
	`touch_nmi_w©chdog
();

82 ià(!
	`pâ_v®id
(
pgd©
->
node_¡¬t_pâ
 + 
i
))

84 
·ge
 = 
	`pâ_to_·ge
(
pgd©
->
node_¡¬t_pâ
 + 
i
);

85 
tÙ®
++;

86 ià(
	`PageRe£rved
(
·ge
))

87 
»£rved
++;

88 ià(
	`PageSw­Cache
(
·ge
))

89 
ÿched
++;

90 ià(
	`·ge_couÁ
(
·ge
))

91 
sh¬ed
 +ğ
	`·ge_couÁ
(
·ge
) - 1;

94 
	`´štk
(
KERN_INFO
 "%lu…age oàRAM\n", 
tÙ®
);

95 
	`´štk
(
KERN_INFO
 "%lu„e£rved…ages\n",
»£rved
);

96 
	`´štk
(
KERN_INFO
 "%lu…age sh¬ed\n",
sh¬ed
);

97 
	`´štk
(
KERN_INFO
 "%lu…age sw­ cached\n",
ÿched
);

98 
	}
}

100 
	gaá”_boÙmem
;

102 
__š™
 *
	$¥p_g‘·ge
()

104 *
±r
;

105 ià(
aá”_boÙmem
)

106 
±r
 = (*è
	`g‘_z”Ûd_·ge
(
GFP_ATOMIC
);

108 
±r
 = 
	`®loc_boÙmem_·ges
(
PAGE_SIZE
);

109 ià(!
±r
 || ((íŒ & ~
PAGE_MASK
))

110 
	`·nic
("£t_±e_phys: cªnÙ‡Îoÿ‹…agd©¨%s\n", 
aá”_boÙmem
?"after bootmem":"");

112 
	`D´štk
("¥p_g‘·g%p\n", 
±r
);

113  
±r
;

114 
	}
}

116 
__š™
 
	$£t_±e_phys
(
vaddr
,

117 
phys
, 
pg´Ù_t
 
´Ù
)

119 
pgd_t
 *
pgd
;

120 
pud_t
 *
pud
;

121 
pmd_t
 *
pmd
;

122 
±e_t
 *
±e
, 
Ãw_±e
;

124 
	`D´štk
("£t_±e_phy %lxØ%lx\n", 
vaddr
, 
phys
);

126 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

127 ià(
	`pgd_nÚe
(*
pgd
)) {

128 
	`´štk
("PGD FIXMAP MISSING, it should be setup in head.S!\n");

131 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

132 ià(
	`pud_nÚe
(*
pud
)) {

133 
pmd
 = (
pmd_t
 *è
	`¥p_g‘·ge
();

134 
	`£t_pud
(
pud
, 
	`__pud
(
	`__·
(
pmd
è| 
_KERNPG_TABLE
 | 
_PAGE_USER
));

135 ià(
pmd
 !ğ
	`pmd_off£t
(
pud
, 0)) {

136 
	`´štk
("PAGETABLE BUG #01! %°<-> %p\n", 
pmd
, 
	`pmd_off£t
(
pud
,0));

140 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

141 ià(
	`pmd_nÚe
(*
pmd
)) {

142 
±e
 = (
±e_t
 *è
	`¥p_g‘·ge
();

143 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__·
(
±e
è| 
_KERNPG_TABLE
 | 
_PAGE_USER
));

144 ià(
±e
 !ğ
	`±e_off£t_k”Ãl
(
pmd
, 0)) {

145 
	`´štk
("PAGETABLE BUG #02!\n");

149 
Ãw_±e
 = 
	`pâ_±e
(
phys
 >> 
PAGE_SHIFT
, 
´Ù
);

151 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
vaddr
);

152 ià(!
	`±e_nÚe
(*
±e
) &&

153 
	`±e_v®
(*
±e
è!ğÕ‹_v®(
Ãw_±e
è& 
__suµÜ‹d_±e_mask
))

154 
	`±e_ERROR
(*
±e
);

155 
	`£t_±e
(
±e
, 
Ãw_±e
);

161 
	`__æush_b_Úe
(
vaddr
);

162 
	}
}

165 
__š™


166 
	$__£t_fixm­
 (
fixed_add»s£s
 
idx
, 
phys
, 
pg´Ù_t
 
´Ù
)

168 
add»ss
 = 
	`__fix_to_vœt
(
idx
);

170 ià(
idx
 >ğ
__’d_of_fixed_add»s£s
) {

171 
	`´štk
("Invalid __set_fixmap\n");

174 
	`£t_±e_phys
(
add»ss
, 
phys
, 
´Ù
);

175 
	}
}

177 
__memš™d©a
 
	gbË_¡¬t
, 
	gbË_’d
;

179 
__memš™
 *
	$®loc_low_·ge
(*
phys
)

181 
pâ
 = 
bË_’d
++;

182 *
adr
;

184 ià(
aá”_boÙmem
) {

185 
adr
 = (*)
	`g‘_z”Ûd_·ge
(
GFP_ATOMIC
);

186 *
phys
 = 
	`__·
(
adr
);

187  
adr
;

190 ià(
pâ
 >ğ
’d_pâ
)

191 
	`·nic
("alloc_low_page:„an out of memory");

193 
adr
 = 
	`—¾y_iÜem­
(
pâ
 * 
PAGE_SIZE
, PAGE_SIZE);

194 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

195 *
phys
 = 
pâ
 * 
PAGE_SIZE
;

196  
adr
;

197 
	}
}

199 
__memš™
 
	$unm­_low_·ge
(*
adr
)

202 ià(
aá”_boÙmem
)

205 
	`—¾y_iounm­
(
adr
, 
PAGE_SIZE
);

206 
	}
}

209 
__memš™
 *
	$—¾y_iÜem­
(
addr
, 
size
)

211 
vaddr
;

212 
pmd_t
 *
pmd
, *
Ï¡_pmd
;

213 
i
, 
pmds
;

215 
pmds
 = ((
addr
 & ~
PMD_MASK
è+ 
size
 + ~PMD_MASKè/ 
PMD_SIZE
;

216 
vaddr
 = 
__START_KERNEL_m­
;

217 
pmd
 = 
Ëv–2_k”Ãl_pgt
;

218 
Ï¡_pmd
 = 
Ëv–2_k”Ãl_pgt
 + 
PTRS_PER_PMD
 - 1;

219 ; 
pmd
 <ğ
Ï¡_pmd
;…md++, 
vaddr
 +ğ
PMD_SIZE
) {

220 
i
 = 0; i < 
pmds
; i++) {

221 ià(
	`pmd_´e£Á
(
pmd
[
i
]))

222 
Ãxt
;

224 
vaddr
 +ğ
addr
 & ~
PMD_MASK
;

225 
addr
 &ğ
PMD_MASK
;

226 
i
 = 0; i < 
pmds
; i++, 
addr
 +ğ
PMD_SIZE
)

227 
	`£t_pmd
(
pmd
 + 
i
,
	`__pmd
(
addr
 | 
_KERNPG_TABLE
 | 
_PAGE_PSE
));

228 
	`__æush_b
();

229  (*)
vaddr
;

230 
Ãxt
:

233 
	`´štk
("—¾y_iÜem­(0x%lx, %luèçed\n", 
addr
, 
size
);

234  
NULL
;

235 
	}
}

238 
__memš™
 
	$—¾y_iounm­
(*
addr
, 
size
)

240 
vaddr
;

241 
pmd_t
 *
pmd
;

242 
i
, 
pmds
;

244 
vaddr
 = ()
addr
;

245 
pmds
 = ((
vaddr
 & ~
PMD_MASK
è+ 
size
 + ~PMD_MASKè/ 
PMD_SIZE
;

246 
pmd
 = 
Ëv–2_k”Ãl_pgt
 + 
	`pmd_šdex
(
vaddr
);

247 
i
 = 0; i < 
pmds
; i++)

248 
	`pmd_ş—r
(
pmd
 + 
i
);

249 
	`__æush_b
();

250 
	}
}

252 
__memš™


253 
	$phys_pmd_š™
(
pmd_t
 *
pmd_·ge
, 
add»ss
, 
’d
)

255 
i
 = 
	`pmd_šdex
(
add»ss
);

257 ; 
i
 < 
PTRS_PER_PMD
; i++, 
add»ss
 +ğ
PMD_SIZE
) {

258 
’Œy
;

259 
pmd_t
 *
pmd
 = 
pmd_·ge
 + 
	`pmd_šdex
(
add»ss
);

261 ià(
add»ss
 >ğ
’d
) {

262 ià(!
aá”_boÙmem
)

263 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

264 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

268 ià(
	`pmd_v®
(*
pmd
))

271 
’Œy
 = 
_PAGE_NX
|
_PAGE_PSE
|
_KERNPG_TABLE
|
_PAGE_GLOBAL
|
add»ss
;

272 
’Œy
 &ğ
__suµÜ‹d_±e_mask
;

273 
	`£t_pmd
(
pmd
, 
	`__pmd
(
’Œy
));

275 
	}
}

277 
__memš™


278 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
add»ss
, 
’d
)

280 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
,0);

281 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

282 
	`phys_pmd_š™
(
pmd
, 
add»ss
, 
’d
);

283 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

284 
	`__æush_b_®l
();

285 
	}
}

287 
__memš™
 
	$phys_pud_š™
(
pud_t
 *
pud_·ge
, 
addr
, 
’d
)

289 
i
 = 
	`pud_šdex
(
addr
);

292 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add¸& 
PUD_MASK
è+ 
PUD_SIZE
 ) {

293 
pmd_phys
;

294 
pud_t
 *
pud
 = 
pud_·ge
 + 
	`pud_šdex
(
addr
);

295 
pmd_t
 *
pmd
;

297 ià(
addr
 >ğ
’d
)

300 ià(!
aá”_boÙmem
 && !
	`e820_ªy_m­³d
(
addr
,addr+
PUD_SIZE
,0)) {

301 
	`£t_pud
(
pud
, 
	`__pud
(0));

305 ià(
	`pud_v®
(*
pud
)) {

306 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
’d
);

310 
pmd
 = 
	`®loc_low_·ge
(&
pmd_phys
);

311 
	`¥š_lock
(&
š™_mm
.
·ge_bË_lock
);

312 
	`£t_pud
(
pud
, 
	`__pud
(
pmd_phys
 | 
_KERNPG_TABLE
));

313 
	`phys_pmd_š™
(
pmd
, 
addr
, 
’d
);

314 
	`¥š_uÆock
(&
š™_mm
.
·ge_bË_lock
);

315 
	`unm­_low_·ge
(
pmd
);

317 
	`__æush_b
();

318 
	}
}

320 
__š™
 
	$fšd_—¾y_bË_¥aû
(
’d
)

322 
puds
, 
pmds
, 
bËs
, 
¡¬t
;

324 
puds
 = (
’d
 + 
PUD_SIZE
 - 1è>> 
PUD_SHIFT
;

325 
pmds
 = (
’d
 + 
PMD_SIZE
 - 1è>> 
PMD_SHIFT
;

326 
bËs
 = 
	`round_up
(
puds
 * (
pud_t
), 
PAGE_SIZE
) +

327 
	`round_up
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

332 
¡¬t
 = 0x8000;

333 
bË_¡¬t
 = 
	`fšd_e820_¬—
(
¡¬t
, 
’d
, 
bËs
);

334 ià(
bË_¡¬t
 == -1UL)

335 
	`·nic
("Cannot find space forhe kernel…ageables");

337 
bË_¡¬t
 >>ğ
PAGE_SHIFT
;

338 
bË_’d
 = 
bË_¡¬t
;

340 
	`—¾y_´štk
("kernel direct mappingables upo %lx @ %lx-%lx\n",

341 
’d
, 
bË_¡¬t
 << 
PAGE_SHIFT
,

342 (
bË_¡¬t
 << 
PAGE_SHIFT
è+ 
bËs
);

343 
	}
}

348 
__š™_»fok
 
	$š™_memÜy_m­pšg
(
¡¬t
, 
’d
)

350 
Ãxt
;

352 
	`D´štk
("init_memory_mapping\n");

360 ià(!
aá”_boÙmem
)

361 
	`fšd_—¾y_bË_¥aû
(
’d
);

363 
¡¬t
 = ()
	`__va
(start);

364 
’d
 = ()
	`__va
(end);

366 ; 
¡¬t
 < 
’d
; s¹ = 
Ãxt
) {

367 
pud_phys
;

368 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
¡¬t
);

369 
pud_t
 *
pud
;

371 ià(
aá”_boÙmem
)

372 
pud
 = 
	`pud_off£t
(
pgd
, 
¡¬t
 & 
PGDIR_MASK
);

374 
pud
 = 
	`®loc_low_·ge
(&
pud_phys
);

376 
Ãxt
 = 
¡¬t
 + 
PGDIR_SIZE
;

377 ià(
Ãxt
 > 
’d
)

378 
Ãxt
 = 
’d
;

379 
	`phys_pud_š™
(
pud
, 
	`__·
(
¡¬t
), __·(
Ãxt
));

380 ià(!
aá”_boÙmem
)

381 
	`£t_pgd
(
	`pgd_off£t_k
(
¡¬t
), 
	`mk_k”Ãl_pgd
(
pud_phys
));

382 
	`unm­_low_·ge
(
pud
);

385 ià(!
aá”_boÙmem
)

386 
mmu_ü4_ã©u»s
 = 
	`»ad_ü4
();

387 
	`__æush_b_®l
();

388 
	}
}

390 #iâdeà
CONFIG_NUMA


391 
__š™
 
	$·gšg_š™
()

393 
max_zÚe_pâs
[
MAX_NR_ZONES
];

394 
	`mem£t
(
max_zÚe_pâs
, 0, (max_zone_pfns));

395 
max_zÚe_pâs
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

396 
max_zÚe_pâs
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

397 
max_zÚe_pâs
[
ZONE_NORMAL
] = 
’d_pâ
;

399 
	`memÜy_´e£Á
(0, 0, 
’d_pâ
);

400 
	`¥¬£_š™
();

401 
	`ä“_¬—_š™_nodes
(
max_zÚe_pâs
);

402 
	}
}

409 
__š™
 
	$ş—r_k”Ãl_m­pšg
(
add»ss
, 
size
)

411 
’d
 = 
add»ss
 + 
size
;

413 
	`BUG_ON
(
add»ss
 & ~
LARGE_PAGE_MASK
);

414 
	`BUG_ON
(
size
 & ~
LARGE_PAGE_MASK
);

416 ; 
add»ss
 < 
’d
;‡dd»s +ğ
LARGE_PAGE_SIZE
) {

417 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
add»ss
);

418 
pud_t
 *
pud
;

419 
pmd_t
 *
pmd
;

420 ià(
	`pgd_nÚe
(*
pgd
))

422 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

423 ià(
	`pud_nÚe
(*
pud
))

425 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

426 ià(!
pmd
 || 
	`pmd_nÚe
(*pmd))

428 ià(0 =ğ(
	`pmd_v®
(*
pmd
è& 
_PAGE_PSE
)) {

430 
	`´štk
(
KERN_ERR


432 
	`pmd_ERROR
(*
pmd
);

434 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

436 
	`__æush_b_®l
();

437 
	}
}

442 
	$Úlše_·ge
(
·ge
 *page)

444 
	`CË¬PageRe£rved
(
·ge
);

445 
	`š™_·ge_couÁ
(
·ge
);

446 
	`__ä“_·ge
(
·ge
);

447 
tÙ®¿m_·ges
++;

448 
num_phy¥ages
++;

449 
	}
}

451 #ifdeà
CONFIG_MEMORY_HOTPLUG


456 
	$¬ch_add_memÜy
(
nid
, 
u64
 
¡¬t
, u64 
size
)

458 
pgli¡_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

459 
zÚe
 *zÚğ
pgd©
->
node_zÚes
 + 
ZONE_NORMAL
;

460 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

461 
Ä_·ges
 = 
size
 >> 
PAGE_SHIFT
;

462 
»t
;

464 
	`š™_memÜy_m­pšg
(
¡¬t
, (¡¬ˆ+ 
size
 -1));

466 
»t
 = 
	`__add_·ges
(
zÚe
, 
¡¬t_pâ
, 
Ä_·ges
);

467 ià(
»t
)

468 
”rÜ
;

470  
»t
;

471 
”rÜ
:

472 
	`´štk
("%s: ProbËmƒncouÁ”ed iÀ__add_·ges!\n", 
__func__
);

473  
»t
;

474 
	}
}

475 
EXPORT_SYMBOL_GPL
(
¬ch_add_memÜy
);

477 #ià!
defšed
(
CONFIG_ACPI_NUMA
è&& defšed(
CONFIG_NUMA
)

478 
	$memÜy_add_phy§ddr_to_nid
(
u64
 
¡¬t
)

481 
	}
}

482 
EXPORT_SYMBOL_GPL
(
memÜy_add_phy§ddr_to_nid
);

487 #ifdeà
CONFIG_MEMORY_HOTPLUG_RESERVE


492 
	$__add_·ges
(
zÚe
 *
z
, 
¡¬t_pâ
, 
Ä_·ges
)

494 
”r
 = -
EIO
;

495 
pâ
;

496 
tÙ®
 = 0, 
mem
 = 0;

497 
pâ
 = 
¡¬t_pâ
;…â < s¹_pâ + 
Ä_·ges
;…fn++) {

498 ià(
	`pâ_v®id
(
pâ
)) {

499 
	`Úlše_·ge
(
	`pâ_to_·ge
(
pâ
));

500 
”r
 = 0;

501 
mem
++;

503 
tÙ®
++;

505 ià(!
”r
) {

506 
z
->
¥ªÃd_·ges
 +ğ
tÙ®
;

507 
z
->
´e£Á_·ges
 +ğ
mem
;

508 
z
->
zÚe_pgd©
->
node_¥ªÃd_·ges
 +ğ
tÙ®
;

509 
z
->
zÚe_pgd©
->
node_´e£Á_·ges
 +ğ
mem
;

511  
”r
;

512 
	}
}

515 
kcÜe_li¡
 
	gkcÜe_mem
, 
	gkcÜe_vm®loc
, 
	gkcÜe_k”Ãl
, 
	gkcÜe_moduËs
,

516 
	gkcÜe_vsysÿÎ
;

518 
__š™
 
	$mem_š™
()

520 
codesize
, 
»£rved·ges
, 
d©asize
, 
š™size
;

522 
	`pci_iommu_®loc
();

525 
	`mem£t
(
em±y_z”o_·ge
, 0, 
PAGE_SIZE
);

527 
»£rved·ges
 = 0;

530 #ifdeà
CONFIG_NUMA


531 
tÙ®¿m_·ges
 = 
	`numa_ä“_®l_boÙmem
();

533 
tÙ®¿m_·ges
 = 
	`ä“_®l_boÙmem
();

535 
»£rved·ges
 = 
’d_pâ
 - 
tÙ®¿m_·ges
 -

536 
	`ab£Á_·ges_š_¿nge
(0, 
’d_pâ
);

538 
aá”_boÙmem
 = 1;

540 
codesize
 = (è&
_‘ext
 - (è&
_‹xt
;

541 
d©asize
 = (è&
_ed©a
 - (è&
_‘ext
;

542 
š™size
 = (è&
__š™_’d
 - (è&
__š™_begš
;

545 
	`kşi¡_add
(&
kcÜe_mem
, 
	`__va
(0), 
max_low_pâ
 << 
PAGE_SHIFT
);

546 
	`kşi¡_add
(&
kcÜe_vm®loc
, (*)
VMALLOC_START
,

547 
VMALLOC_END
-
VMALLOC_START
);

548 
	`kşi¡_add
(&
kcÜe_k”Ãl
, &
_¡ext
, 
_’d
 - _stext);

549 
	`kşi¡_add
(&
kcÜe_moduËs
, (*)
MODULES_VADDR
, 
MODULES_LEN
);

550 
	`kşi¡_add
(&
kcÜe_vsysÿÎ
, (*)
VSYSCALL_START
,

551 
VSYSCALL_END
 - 
VSYSCALL_START
);

553 
	`´štk
("Memory: %luk/%luk‡vailable (%ldk kernel code, %ldk„eserved, %ldk data, %ldk init)\n",

554 (è
	`Ä_ä“_·ges
(è<< (
PAGE_SHIFT
-10),

555 
’d_pâ
 << (
PAGE_SHIFT
-10),

556 
codesize
 >> 10,

557 
»£rved·ges
 << (
PAGE_SHIFT
-10),

558 
d©asize
 >> 10,

559 
š™size
 >> 10);

560 
	}
}

562 
	$ä“_š™_·ges
(*
wh©
, 
begš
, 
’d
)

564 
addr
;

566 ià(
begš
 >ğ
’d
)

569 
	`´štk
(
KERN_INFO
 "F»ešg %s: %luk f»ed\n", 
wh©
, (
’d
 - 
begš
) >> 10);

570 
addr
 = 
begš
;‡dd¸< 
’d
;‡dd¸+ğ
PAGE_SIZE
) {

571 
	`CË¬PageRe£rved
(
	`vœt_to_·ge
(
addr
));

572 
	`š™_·ge_couÁ
(
	`vœt_to_·ge
(
addr
));

573 
	`mem£t
((*)(
addr
 & ~(
PAGE_SIZE
-1)),

574 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

575 ià(
addr
 >ğ
__START_KERNEL_m­
)

576 
	`chªge_·ge_©Œ_addr
(
addr
, 1, 
	`__pg´Ù
(0));

577 
	`ä“_·ge
(
addr
);

578 
tÙ®¿m_·ges
++;

580 ià(
addr
 > 
__START_KERNEL_m­
)

581 
	`glob®_æush_b
();

582 
	}
}

584 
	$ä“_š™mem
()

586 
	`ä“_š™_·ges
("unused kernel memory",

587 ()(&
__š™_begš
),

588 ()(&
__š™_’d
));

589 
	}
}

591 #ifdeà
CONFIG_DEBUG_RODATA


593 
	$m¬k_rod©a_ro
()

595 
¡¬t
 = ()
_¡ext
, 
’d
;

597 #ifdeà
CONFIG_HOTPLUG_CPU


599 ià(
	`num_possibË_ıus
() > 1)

600 
¡¬t
 = ()
_‘ext
;

603 #ifdeà
CONFIG_KPROBES


604 
¡¬t
 = ()
__¡¬t_rod©a
;

607 
’d
 = ()
__’d_rod©a
;

608 
¡¬t
 = (¡¬ˆ+ 
PAGE_SIZE
 - 1è& 
PAGE_MASK
;

609 
’d
 &ğ
PAGE_MASK
;

610 ià(
’d
 <ğ
¡¬t
)

613 
	`chªge_·ge_©Œ_addr
(
¡¬t
, (
’d
 - s¹è>> 
PAGE_SHIFT
, 
PAGE_KERNEL_RO
);

615 
	`´štk
(
KERN_INFO
 "Write…rotectinghe kernel„ead-only data: %luk\n",

616 (
’d
 - 
¡¬t
) >> 10);

624 
	`glob®_æush_b
();

625 
	}
}

628 #ifdeà
CONFIG_BLK_DEV_INITRD


629 
	$ä“_š™rd_mem
(
¡¬t
, 
’d
)

631 
	`ä“_š™_·ges
("š™rd memÜy", 
¡¬t
, 
’d
);

632 
	}
}

635 
__š™
 
	$»£rve_boÙmem_g’”ic
(
phys
, 
Ën
)

637 #ifdeà
CONFIG_NUMA


638 
nid
 = 
	`phys_to_nid
(
phys
);

640 
pâ
 = 
phys
 >> 
PAGE_SHIFT
;

641 ià(
pâ
 >ğ
’d_pâ
) {

644 ià(
pâ
 < 
’d_pâ_m­
)

646 
	`´štk
(
KERN_ERR
 "reserve_bootmem: illegal„eserve %lx %u\n",

647 
phys
, 
Ën
);

652 #ifdeà
CONFIG_NUMA


653 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Ën
);

655 
	`»£rve_boÙmem
(
phys
, 
Ën
);

657 ià(
phys
+
Ën
 <ğ
MAX_DMA_PFN
*
PAGE_SIZE
) {

658 
dma_»£rve
 +ğ
Ën
 / 
PAGE_SIZE
;

659 
	`£t_dma_»£rve
(
dma_»£rve
);

661 
	}
}

663 
	$k”n_addr_v®id
(
addr
)

665 
above
 = (()
addr
è>> 
__VIRTUAL_MASK_SHIFT
;

666 
pgd_t
 *
pgd
;

667 
pud_t
 *
pud
;

668 
pmd_t
 *
pmd
;

669 
±e_t
 *
±e
;

671 ià(
above
 != 0 &&‡bove != -1UL)

674 
pgd
 = 
	`pgd_off£t_k
(
addr
);

675 ià(
	`pgd_nÚe
(*
pgd
))

678 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

679 ià(
	`pud_nÚe
(*
pud
))

682 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

683 ià(
	`pmd_nÚe
(*
pmd
))

685 ià(
	`pmd_Ïrge
(*
pmd
))

686  
	`pâ_v®id
(
	`pmd_pâ
(*
pmd
));

688 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
addr
);

689 ià(
	`±e_nÚe
(*
±e
))

691  
	`pâ_v®id
(
	`±e_pâ
(*
±e
));

692 
	}
}

698 
vm_¬—_¡ruù
 
	gg©e_vma
 = {

699 .
vm_¡¬t
 = 
VSYSCALL_START
,

700 .
	gvm_’d
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 << 
PAGE_SHIFT
),

701 .
	gvm_·ge_´Ù
 = 
PAGE_READONLY_EXEC
,

702 .
	gvm_æags
 = 
VM_READ
 | 
VM_EXEC


705 
vm_¬—_¡ruù
 *
	$g‘_g©e_vma
(
sk_¡ruù
 *
tsk
)

707 #ifdeà
CONFIG_IA32_EMULATION


708 ià(
	`‹¡_tsk_th»ad_æag
(
tsk
, 
TIF_IA32
))

709  
NULL
;

711  &
g©e_vma
;

712 
	}
}

714 
	$š_g©e_¬—
(
sk_¡ruù
 *
sk
, 
addr
)

716 
vm_¬—_¡ruù
 *
vma
 = 
	`g‘_g©e_vma
(
sk
);

717 ià(!
vma
)

719  (
addr
 >ğ
vma
->
vm_¡¬t
è&& (add¸< vma->
vm_’d
);

720 
	}
}

726 
	$š_g©e_¬—_no_sk
(
addr
)

728  (
addr
 >ğ
VSYSCALL_START
è&& (add¸< 
VSYSCALL_END
);

729 
	}
}

731 cÚ¡ *
	$¬ch_vma_Çme
(
vm_¬—_¡ruù
 *
vma
)

733 ià(
vma
->
vm_mm
 && vma->
vm_¡¬t
 =ğ()vma->vm_mm->
cÚ‹xt
.
vdso
)

735 ià(
vma
 =ğ&
g©e_vma
)

737  
NULL
;

738 
	}
}

740 #ifdeà
CONFIG_SPARSEMEM_VMEMMAP


744 
__memš™
 
	$vmemm­_pİuÏ‹
(
·ge
 *
¡¬t_·ge
,

745 
size
, 
node
)

747 
addr
 = ()
¡¬t_·ge
;

748 
’d
 = ()(
¡¬t_·ge
 + 
size
);

749 
Ãxt
;

750 
pgd_t
 *
pgd
;

751 
pud_t
 *
pud
;

752 
pmd_t
 *
pmd
;

754 ; 
addr
 < 
’d
;‡dd¸ğ
Ãxt
) {

755 
Ãxt
 = 
	`pmd_addr_’d
(
addr
, 
’d
);

757 
pgd
 = 
	`vmemm­_pgd_pİuÏ‹
(
addr
, 
node
);

758 ià(!
pgd
)

759  -
ENOMEM
;

760 
pud
 = 
	`vmemm­_pud_pİuÏ‹
(
pgd
, 
addr
, 
node
);

761 ià(!
pud
)

762  -
ENOMEM
;

764 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

765 ià(
	`pmd_nÚe
(*
pmd
)) {

766 
±e_t
 
’Œy
;

767 *
p
 = 
	`vmemm­_®loc_block
(
PMD_SIZE
, 
node
);

768 ià(!
p
)

769  -
ENOMEM
;

771 
’Œy
 = 
	`pâ_±e
(
	`__·
(
p
è>> 
PAGE_SHIFT
, 
PAGE_KERNEL
);

772 
	`mk_±e_huge
(
’Œy
);

773 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_v®
(
’Œy
)));

775 
	`´štk
(
KERN_DEBUG
 " [%lx-%lx] PMD ->%p on‚ode %d\n",

776 
addr
,‡dd¸+ 
PMD_SIZE
 - 1, 
p
, 
node
);

778 
	`vmemm­_v”ify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
Ãxt
);

782 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap_64.c

11 
	~<lšux/vm®loc.h
>

12 
	~<lšux/š™.h
>

13 
	~<lšux/¦ab.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/io.h
>

17 
	~<asm/pg®loc.h
>

18 
	~<asm/fixm­.h
>

19 
	~<asm/bæush.h
>

20 
	~<asm/ÿcheæush.h
>

21 
	~<asm/´Ùo.h
>

23 
	$__phys_addr
(
x
)

25 ià(
x
 >ğ
__START_KERNEL_m­
)

26  
x
 - 
__START_KERNEL_m­
 + 
phys_ba£
;

27  
x
 - 
PAGE_OFFSET
;

28 
	}
}

29 
EXPORT_SYMBOL
(
__phys_addr
);

31 
	#ISA_START_ADDRESS
 0xa0000

	)

32 
	#ISA_END_ADDRESS
 0x100000

	)

39 
	$iÜem­_chªge_©Œ
(
phys_addr
, 
size
,

40 
æags
)

42 
”r
 = 0;

43 ià(
phys_addr
 + 
size
 - 1 < (
’d_pâ_m­
 << 
PAGE_SHIFT
)) {

44 
Åages
 = (
size
 + 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
;

45 
vaddr
 = (è
	`__va
(
phys_addr
);

51 
”r
 = 
	`chªge_·ge_©Œ_addr
(
vaddr
,
Åages
,
	`__pg´Ù
(
__PAGE_KERNEL
|
æags
));

52 ià(!
”r
)

53 
	`glob®_æush_b
();

55  
”r
;

56 
	}
}

71 
__iomem
 * 
	$__iÜem­
(
phys_addr
, 
size
, 
æags
)

73 * 
addr
;

74 
vm_¡ruù
 * 
¬—
;

75 
off£t
, 
Ï¡_addr
;

76 
pg´Ù_t
 
pg´Ù
;

79 
Ï¡_addr
 = 
phys_addr
 + 
size
 - 1;

80 ià(!
size
 || 
Ï¡_addr
 < 
phys_addr
)

81  
NULL
;

86 ià(
phys_addr
 >ğ
ISA_START_ADDRESS
 && 
Ï¡_addr
 < 
ISA_END_ADDRESS
)

87  (
__fÜû
 
__iomem
 *)
	`phys_to_vœt
(
phys_addr
);

89 #ifdeà
CONFIG_FLATMEM


93 ià(
Ï¡_addr
 < 
	`vœt_to_phys
(
high_memÜy
)) {

94 *
t_addr
, *
t_’d
;

95 
·ge
 *page;

97 
t_addr
 = 
	`__va
(
phys_addr
);

98 
t_’d
 = 
t_addr
 + (
size
 - 1);

100 
·ge
 = 
	`vœt_to_·ge
(
t_addr
);…ag<ğvœt_to_·ge(
t_’d
);…age++)

101 if(!
	`PageRe£rved
(
·ge
))

102  
NULL
;

106 
pg´Ù
 = 
	`__pg´Ù
(
_PAGE_PRESENT
 | 
_PAGE_RW
 | 
_PAGE_GLOBAL


107 | 
_PAGE_DIRTY
 | 
_PAGE_ACCESSED
 | 
æags
);

111 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

112 
phys_addr
 &ğ
PAGE_MASK
;

113 
size
 = 
	`PAGE_ALIGN
(
Ï¡_addr
+1è- 
phys_addr
;

118 
¬—
 = 
	`g‘_vm_¬—
(
size
, 
VM_IOREMAP
 | (
æags
 << 20));

119 ià(!
¬—
)

120  
NULL
;

121 
¬—
->
phys_addr
 =…hys_addr;

122 
addr
 = 
¬—
->addr;

123 ià(
	`iÜem­_·ge_¿nge
(()
addr
, (ïdd¸+ 
size
,

124 
phys_addr
, 
pg´Ù
)) {

125 
	`»move_vm_¬—
((*)(
PAGE_MASK
 & (è
addr
));

126  
NULL
;

128 ià(
æags
 && 
	`iÜem­_chªge_©Œ
(
phys_addr
, 
size
, flags) < 0) {

129 
¬—
->
æags
 &= 0xffffff;

130 
	`vunm­
(
addr
);

131  
NULL
;

133  (
__fÜû
 
__iomem
 *è(
off£t
 + (*)
addr
);

134 
	}
}

135 
EXPORT_SYMBOL
(
__iÜem­
);

159 
__iomem
 *
	$iÜem­_noÿche
 (
phys_addr
, 
size
)

161  
	`__iÜem­
(
phys_addr
, 
size
, 
_PAGE_PCD
);

162 
	}
}

163 
EXPORT_SYMBOL
(
iÜem­_noÿche
);

171 
	$iounm­
(vŞ©
__iomem
 *
addr
)

173 
vm_¡ruù
 *
p
, *
o
;

175 ià(
addr
 <ğ
high_memÜy
)

177 ià(
addr
 >ğ
	`phys_to_vœt
(
ISA_START_ADDRESS
) &&

178 
addr
 < 
	`phys_to_vœt
(
ISA_END_ADDRESS
))

181 
addr
 = (vŞ©
__iomem
 *)(
PAGE_MASK
 & (
__fÜû
)addr);

187 
	`»ad_lock
(&
vmli¡_lock
);

188 
p
 = 
vmli¡
;…;… =…->
Ãxt
) {

189 ià(
p
->
addr
 ==‡ddr)

192 
	`»ad_uÆock
(&
vmli¡_lock
);

194 ià(!
p
) {

195 
	`´štk
("iounm­: bad‡dd»s %p\n", 
addr
);

196 
	`dump_¡ack
();

201 ià(
p
->
æags
 >> 20)

202 
	`iÜem­_chªge_©Œ
(
p
->
phys_addr
,…->
size
, 0);

205 
o
 = 
	`»move_vm_¬—
((*)
addr
);

206 
	`BUG_ON
(
p
 !ğ
o
 || o =ğ
NULL
);

207 
	`kä“
(
p
);

208 
	}
}

209 
EXPORT_SYMBOL
(
iounm­
);

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/š™.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<lšux/pci_ids.h
>

16 
	~<asm/ty³s.h
>

17 
	~<asm/mmzÚe.h
>

18 
	~<asm/´Ùo.h
>

19 
	~<asm/e820.h
>

20 
	~<asm/pci-dœeù.h
>

21 
	~<asm/numa.h
>

23 
__š™
 
	$fšd_nÜthbridge
()

25 
num
;

27 
num
 = 0;‚um < 32;‚um++) {

28 
u32
 
h—d”
;

30 
h—d”
 = 
	`»ad_pci_cÚfig
(0, 
num
, 0, 0x00);

31 ià(
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)))

34 
h—d”
 = 
	`»ad_pci_cÚfig
(0, 
num
, 1, 0x00);

35 ià(
h—d”
 !ğ(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)))

37  
num
;

41 
	}
}

43 
__š™
 
	$k8_sÿn_nodes
(
¡¬t
, 
’d
)

45 
´evba£
;

46 
boÙnode
 
nodes
[8];

47 
nodeid
, 
i
, 
j
, 
nb
;

48 
nodeids
[8];

49 
found
 = 0;

50 
u32
 
»g
;

51 
numnodes
;

52 
num_cÜes
;

54 ià(!
	`—¾y_pci_®lowed
())

57 
nb
 = 
	`fšd_nÜthbridge
();

58 ià(
nb
 < 0)

59  
nb
;

61 
	`´štk
(
KERN_INFO
 "SÿÂšg NUMAİŞogy iÀNÜthbridg%d\n", 
nb
);

63 
num_cÜes
 = (
	`ıuid_ecx
(0x80000008) & 0xff) + 1;

64 
	`´štk
(
KERN_INFO
 "CPU ha %d‚um_cÜes\n", 
num_cÜes
);

66 
»g
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 0, 0x60);

67 
numnodes
 = ((
»g
 >> 4) & 0xF) + 1;

68 ià(
numnodes
 <= 1)

71 
	`´štk
(
KERN_INFO
 "Numb” oànode %d\n", 
numnodes
);

73 
	`mem£t
(&
nodes
,0,(nodes));

74 
´evba£
 = 0;

75 
i
 = 0; i < 8; i++) {

76 
ba£
,
lim™
;

77 
u32
 
nodeid
;

79 
ba£
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 1, 0x40 + 
i
*8);

80 
lim™
 = 
	`»ad_pci_cÚfig
(0, 
nb
, 1, 0x44 + 
i
*8);

82 
nodeid
 = 
lim™
 & 7;

83 
nodeids
[
i
] = 
nodeid
;

84 ià((
ba£
 & 3) == 0) {

85 ià(
i
 < 
numnodes
)

86 
	`´štk
("Skpšg di§bËd‚od%d\n", 
i
);

89 ià(
nodeid
 >ğ
numnodes
) {

90 
	`´štk
("IgnÜšgƒxûs nod%d (%lx:%lx)\n", 
nodeid
,

91 
ba£
, 
lim™
);

95 ià(!
lim™
) {

96 
	`´štk
(
KERN_INFO
 "Skpšg‚od’Œy %d (ba£ %lx)\n", 
i
,

97 
ba£
);

100 ià((
ba£
 >> 8è& 3 || (
lim™
 >> 8) & 3) {

101 
	`´štk
(
KERN_ERR
 "Node %d using interleaving mode %lx/%lx\n",

102 
nodeid
, (
ba£
>>8)&3, (
lim™
>>8) & 3);

105 ià(
	`node_is£t
(
nodeid
, 
node_possibË_m­
)) {

106 
	`´štk
(
KERN_INFO
 "Node %d‡lready…resent. Skipping\n",

107 
nodeid
);

111 
lim™
 >>= 16;

112 
lim™
 <<= 24;

113 
lim™
 |= (1<<24)-1;

114 
lim™
++;

116 ià(
lim™
 > 
’d_pâ
 << 
PAGE_SHIFT
)

117 
lim™
 = 
’d_pâ
 << 
PAGE_SHIFT
;

118 ià(
lim™
 <ğ
ba£
)

121 
ba£
 >>= 16;

122 
ba£
 <<= 24;

124 ià(
ba£
 < 
¡¬t
)

125 
ba£
 = 
¡¬t
;

126 ià(
lim™
 > 
’d
)

127 
lim™
 = 
’d
;

128 ià(
lim™
 =ğ
ba£
) {

129 
	`´štk
(
KERN_ERR
 "Em±y‚od%d\n", 
nodeid
);

132 ià(
lim™
 < 
ba£
) {

133 
	`´štk
(
KERN_ERR
 "Node %d bogus settings %lx-%lx.\n",

134 
nodeid
, 
ba£
, 
lim™
);

139 ià(
´evba£
 > 
ba£
) {

140 
	`´štk
(
KERN_ERR
 "Node map‚ot sorted %lx,%lx\n",

141 
´evba£
,
ba£
);

145 
	`´štk
(
KERN_INFO
 "Node %d MemBase %016lx Limit %016lx\n",

146 
nodeid
, 
ba£
, 
lim™
);

148 
found
++;

150 
nodes
[
nodeid
].
¡¬t
 = 
ba£
;

151 
nodes
[
nodeid
].
’d
 = 
lim™
;

152 
	`e820_»gi¡”_aùive_»giÚs
(
nodeid
,

153 
nodes
[
nodeid
].
¡¬t
 >> 
PAGE_SHIFT
,

154 
nodes
[
nodeid
].
’d
 >> 
PAGE_SHIFT
);

156 
´evba£
 = 
ba£
;

158 
	`node_£t
(
nodeid
, 
node_possibË_m­
);

161 ià(!
found
)

164 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 8);

165 ià(
memnode_shiá
 < 0) {

166 
	`´štk
(
KERN_ERR
 "No NUMA‚ode hash function found. Contact maintainer\n");

169 
	`´štk
(
KERN_INFO
 "Usšg‚odhash shiá oà%d\n", 
memnode_shiá
);

171 
i
 = 0; i < 8; i++) {

172 ià(
nodes
[
i
].
¡¬t
 !ğnodes[i].
’d
) {

173 
nodeid
 = 
nodeids
[
i
];

174 
j
 = 0; j < 
num_cÜes
; j++)

175 
­icid_to_node
[(
nodeid
 * 
num_cÜes
è+ 
j
] = 
i
;

176 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

180 
	`numa_š™_¬¿y
();

182 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap_64.c

4 
	~<lšux/mm.h
>

5 
	~<lšux/sched.h
>

6 
	~<lšux/¿ndom.h
>

7 
	~<asm/Ÿ32.h
>

11 
	$¬ch_pick_mm­_Ïyout
(
mm_¡ruù
 *
mm
)

13 #ifdeà
CONFIG_IA32_EMULATION


14 ià(
	`cu¼’t_th»ad_šfo
()->
æags
 & 
_TIF_IA32
)

15  
	`Ÿ32_pick_mm­_Ïyout
(
mm
);

17 
mm
->
mm­_ba£
 = 
TASK_UNMAPPED_BASE
;

18 ià(
cu¼’t
->
æags
 & 
PF_RANDOMIZE
) {

23 
ºd
 = 
	`g‘_¿ndom_št
() & 0xfffffff;

24 
mm
->
mm­_ba£
 +ğ(()
ºd
è<< 
PAGE_SHIFT
;

26 
mm
->
g‘_unm­³d_¬—
 = 
¬ch_g‘_unm­³d_¬—
;

27 
mm
->
unm­_¬—
 = 
¬ch_unm­_¬—
;

28 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/boÙmem.h
>

10 
	~<lšux/mmzÚe.h
>

11 
	~<lšux/ùy³.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/nodemask.h
>

15 
	~<asm/e820.h
>

16 
	~<asm/´Ùo.h
>

17 
	~<asm/dma.h
>

18 
	~<asm/numa.h
>

19 
	~<asm/aıi.h
>

21 #iâdeà
D´štk


22 
	#D´štk
(
x
...)

	)

25 
pgli¡_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__»ad_mo¡ly
;

26 
boÙmem_d©a_t
 
	g¶©_node_bd©a
[
MAX_NUMNODES
];

28 
memnode
 
	gmemnode
;

30 
	gıu_to_node
[
NR_CPUS
] 
	g__»ad_mo¡ly
 = {

31 [0 ... 
NR_CPUS
-1] = 
NUMA_NO_NODE


33 
	g­icid_to_node
[
MAX_LOCAL_APIC
] 
	g__ıuš™d©a
 = {

34 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


36 
ıumask_t
 
	gnode_to_ıumask
[
MAX_NUMNODES
] 
	g__»ad_mo¡ly
;

38 
numa_off
 
	g__š™d©a
;

39 
__š™d©a
 
	gnodem­_addr
;

40 
__š™d©a
 
	gnodem­_size
;

50 
__š™


51 
	$pİuÏ‹_memnodem­
(cÚ¡ 
boÙnode
 *
nodes
, 
numnodes
, 
shiá
)

53 
i
;

54 
»s
 = -1;

55 
addr
, 
’d
;

57 
	`mem£t
(
memnodem­
, 0xff, 
memnodem­size
);

58 
i
 = 0; i < 
numnodes
; i++) {

59 
addr
 = 
nodes
[
i
].
¡¬t
;

60 
’d
 = 
nodes
[
i
].end;

61 ià(
addr
 >ğ
’d
)

63 ià((
’d
 >> 
shiá
è>ğ
memnodem­size
)

66 ià(
memnodem­
[
addr
 >> 
shiá
] != 0xff)

68 
memnodem­
[
addr
 >> 
shiá
] = 
i
;

69 
addr
 +ğ(1UL << 
shiá
);

70 } 
addr
 < 
’d
);

71 
»s
 = 1;

73  
»s
;

74 
	}
}

76 
__š™
 
	$®loÿ‹_ÿch—ligÃd_memnodem­
()

78 
·d
, 
·d_addr
;

80 
memnodem­
 = 
memnode
.
embedded_m­
;

81 ià(
memnodem­size
 <= 48)

84 
·d
 = 
L1_CACHE_BYTES
 - 1;

85 
·d_addr
 = 0x8000;

86 
nodem­_size
 = 
·d
 + 
memnodem­size
;

87 
nodem­_addr
 = 
	`fšd_e820_¬—
(
·d_addr
, 
’d_pâ
<<
PAGE_SHIFT
,

88 
nodem­_size
);

89 ià(
nodem­_addr
 == -1UL) {

90 
	`´štk
(
KERN_ERR


92 
nodem­_addr
 = 
nodem­_size
 = 0;

95 
·d_addr
 = (
nodem­_addr
 + 
·d
) & ~pad;

96 
memnodem­
 = 
	`phys_to_vœt
(
·d_addr
);

98 
	`´štk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

99 
nodem­_addr
,‚odem­_add¸+ 
nodem­_size
);

101 
	}
}

107 
__š™


108 
	$exŒaù_lsb_äom_nodes
 (cÚ¡ 
boÙnode
 *
nodes
, 
numnodes
)

110 
i
, 
nodes_u£d
 = 0;

111 
¡¬t
, 
’d
;

112 
b™f›ld
 = 0, 
memtİ
 = 0;

114 
i
 = 0; i < 
numnodes
; i++) {

115 
¡¬t
 = 
nodes
[
i
].start;

116 
’d
 = 
nodes
[
i
].end;

117 ià(
¡¬t
 >ğ
’d
)

119 
b™f›ld
 |ğ
¡¬t
;

120 
nodes_u£d
++;

121 ià(
’d
 > 
memtİ
)

122 
memtİ
 = 
’d
;

124 ià(
nodes_u£d
 <= 1)

125 
i
 = 63;

127 
i
 = 
	`fšd_fœ¡_b™
(&
b™f›ld
, ()*8);

128 
memnodem­size
 = (
memtİ
 >> 
i
)+1;

129  
i
;

130 
	}
}

132 
__š™
 
	$compu‹_hash_shiá
(
boÙnode
 *
nodes
, 
numnodes
)

134 
shiá
;

136 
shiá
 = 
	`exŒaù_lsb_äom_nodes
(
nodes
, 
numnodes
);

137 ià(
	`®loÿ‹_ÿch—ligÃd_memnodem­
())

139 
	`´štk
(
KERN_DEBUG
 "NUMA: Using %d forhe hash shift.\n",

140 
shiá
);

142 ià(
	`pİuÏ‹_memnodem­
(
nodes
, 
numnodes
, 
shiá
) != 1) {

143 
	`´štk
(
KERN_INFO


146 
shiá
);

149  
shiá
;

150 
	}
}

152 #ifdeà
CONFIG_SPARSEMEM


153 
	$—¾y_pâ_to_nid
(
pâ
)

155  
	`phys_to_nid
(
pâ
 << 
PAGE_SHIFT
);

156 
	}
}

159 * 
__š™


160 
	$—¾y_node_mem
(
nodeid
, 
¡¬t
, 
’d
,

161 
size
)

163 
mem
 = 
	`fšd_e820_¬—
(
¡¬t
, 
’d
, 
size
);

164 *
±r
;

165 ià(
mem
 != -1L)

166  
	`__va
(
mem
);

167 
±r
 = 
	`__®loc_boÙmem_nİªic
(
size
,

168 
SMP_CACHE_BYTES
, 
	`__·
(
MAX_DMA_ADDRESS
));

169 ià(
±r
 =ğ
NULL
) {

170 
	`´štk
(
KERN_ERR
 "Cannot find %lu bytes in‚ode %d\n",

171 
size
, 
nodeid
);

172  
NULL
;

174  
±r
;

175 
	}
}

178 
__š™
 
	$£tup_node_boÙmem
(
nodeid
, 
¡¬t
, 
’d
)

180 
¡¬t_pâ
, 
’d_pâ
, 
boÙm­_·ges
, 
boÙm­_size
, 
boÙm­_¡¬t
;

181 
noded©a_phys
;

182 *
boÙm­
;

183 cÚ¡ 
pgd©_size
 = 
	`round_up
((
pg_d©a_t
), 
PAGE_SIZE
);

185 
¡¬t
 = 
	`round_up
(¡¬t, 
ZONE_ALIGN
);

187 
	`´štk
(
KERN_INFO
 "BoÙmem s‘u°nod%d %016lx-%016lx\n", 
nodeid
, 
¡¬t
, 
’d
);

189 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

190 
’d_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

192 
node_d©a
[
nodeid
] = 
	`—¾y_node_mem
Òodeid, 
¡¬t
, 
’d
, 
pgd©_size
);

193 ià(
node_d©a
[
nodeid
] =ğ
NULL
)

195 
noded©a_phys
 = 
	`__·
(
node_d©a
[
nodeid
]);

197 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

198 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
¶©_node_bd©a
[nodeid];

199 
	`NODE_DATA
(
nodeid
)->
node_¡¬t_pâ
 = 
¡¬t_pâ
;

200 
	`NODE_DATA
(
nodeid
)->
node_¥ªÃd_·ges
 = 
’d_pâ
 - 
¡¬t_pâ
;

203 
boÙm­_·ges
 = 
	`boÙmem_boÙm­_·ges
(
’d_pâ
 - 
¡¬t_pâ
);

204 
boÙm­_¡¬t
 = 
	`round_up
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

205 
boÙm­
 = 
	`—¾y_node_mem
(
nodeid
, 
boÙm­_¡¬t
, 
’d
,

206 
boÙm­_·ges
<<
PAGE_SHIFT
);

207 ià(
boÙm­
 =ğ
NULL
) {

208 ià(
noded©a_phys
 < 
¡¬t
 ||‚oded©a_phy >ğ
’d
)

209 
	`ä“_boÙmem
(()
node_d©a
[
nodeid
],
pgd©_size
);

210 
node_d©a
[
nodeid
] = 
NULL
;

213 
boÙm­_¡¬t
 = 
	`__·
(
boÙm­
);

214 
	`D´štk
("boÙm­ s¹ %lu…age %lu\n", 
boÙm­_¡¬t
, 
boÙm­_·ges
);

216 
boÙm­_size
 = 
	`š™_boÙmem_node
(
	`NODE_DATA
(
nodeid
),

217 
boÙm­_¡¬t
 >> 
PAGE_SHIFT
,

218 
¡¬t_pâ
, 
’d_pâ
);

220 
	`ä“_boÙmem_w™h_aùive_»giÚs
(
nodeid
, 
’d
);

222 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
noded©a_phys
, 
pgd©_size
);

223 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
boÙm­_¡¬t
, 
boÙm­_·ges
<<
PAGE_SHIFT
);

224 #ifdeà
CONFIG_ACPI_NUMA


225 
	`¤©_»£rve_add_¬—
(
nodeid
);

227 
	`node_£t_Úlše
(
nodeid
);

228 
	}
}

231 
__š™
 
	$£tup_node_zÚes
(
nodeid
)

233 
¡¬t_pâ
, 
’d_pâ
, 
memm­size
, 
lim™
;

235 
¡¬t_pâ
 = 
	`node_¡¬t_pâ
(
nodeid
);

236 
’d_pâ
 = 
	`node_’d_pâ
(
nodeid
);

238 
	`D´štk
(
KERN_INFO
 "Setting up memmap for‚ode %d %lx-%lx\n",

239 
nodeid
, 
¡¬t_pâ
, 
’d_pâ
);

243 
memm­size
 = (
·ge
è* (
’d_pâ
-
¡¬t_pâ
);

244 
lim™
 = 
’d_pâ
 << 
PAGE_SHIFT
;

245 #ifdeà
CONFIG_FLAT_NODE_MEM_MAP


246 
	`NODE_DATA
(
nodeid
)->
node_mem_m­
 =

247 
	`__®loc_boÙmem_cÜe
(
	`NODE_DATA
(
nodeid
)->
bd©a
,

248 
memm­size
, 
SMP_CACHE_BYTES
,

249 
	`round_down
(
lim™
 - 
memm­size
, 
PAGE_SIZE
),

250 
lim™
);

252 
	}
}

254 
__š™
 
	$numa_š™_¬¿y
()

256 
¼
, 
i
;

262 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

263 
i
 = 0; i < 
NR_CPUS
; i++) {

264 ià(
	`ıu_to_node
(
i
è!ğ
NUMA_NO_NODE
)

266 
	`numa_£t_node
(
i
, 
¼
);

267 
¼
 = 
	`Ãxt_node
Ôr, 
node_Úlše_m­
);

268 ià(
¼
 =ğ
MAX_NUMNODES
)

269 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

272 
	}
}

274 #ifdeà
CONFIG_NUMA_EMU


276 *
cmdlše
 
	g__š™d©a
;

284 
__š™
 
	$£tup_node_¿nge
(
nid
, 
boÙnode
 *
nodes
, 
u64
 *
addr
,

285 
u64
 
size
, u64 
max_addr
)

287 
»t
 = 0;

288 
nodes
[
nid
].
¡¬t
 = *
addr
;

289 *
addr
 +ğ
size
;

290 ià(*
addr
 >ğ
max_addr
) {

291 *
addr
 = 
max_addr
;

292 
»t
 = -1;

294 
nodes
[
nid
].
’d
 = *
addr
;

295 
	`node_£t
(
nid
, 
node_possibË_m­
);

296 
	`´štk
(
KERN_INFO
 "Fakšg‚od%d‡ˆ%016Lx-%016Lx (%LuMB)\n", 
nid
,

297 
nodes
[
nid
].
¡¬t
,‚odes[nid].
’d
,

298 (
nodes
[
nid
].
’d
 -‚odes[nid].
¡¬t
) >> 20);

299  
»t
;

300 
	}
}

307 
__š™
 
	$¥l™_nodes_equ®ly
(
boÙnode
 *
nodes
, 
u64
 *
addr
,

308 
u64
 
max_addr
, 
node_¡¬t
,

309 
num_nodes
)

311 
big
;

312 
u64
 
size
;

313 
i
;

315 ià(
num_nodes
 <= 0)

317 ià(
num_nodes
 > 
MAX_NUMNODES
)

318 
num_nodes
 = 
MAX_NUMNODES
;

319 
size
 = (
max_addr
 - *
addr
 - 
	`e820_hŞe_size
(*addr, max_addr)) /

320 
num_nodes
;

325 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
è* 
num_nodes
) /

326 
FAKE_NODE_MIN_SIZE
;

329 
size
 &ğ
FAKE_NODE_MIN_HASH_MASK
;

330 ià(!
size
) {

331 
	`´štk
(
KERN_ERR
 "Notƒnough memory forƒach‚ode. "

336 
i
 = 
node_¡¬t
; i < 
num_nodes
 +‚ode_start; i++) {

337 
u64
 
’d
 = *
addr
 + 
size
;

338 ià(
i
 < 
big
)

339 
’d
 +ğ
FAKE_NODE_MIN_SIZE
;

344 ià(
i
 =ğ
num_nodes
 + 
node_¡¬t
 - 1)

345 
’d
 = 
max_addr
;

347 
’d
 - *
addr
 - 
	`e820_hŞe_size
(*addr,ƒnd) <

348 
size
) {

349 
’d
 +ğ
FAKE_NODE_MIN_SIZE
;

350 ià(
’d
 > 
max_addr
) {

351 
’d
 = 
max_addr
;

355 ià(
	`£tup_node_¿nge
(
i
, 
nodes
, 
addr
, 
’d
 - *addr, 
max_addr
) < 0)

358  
i
 - 
node_¡¬t
 + 1;

359 
	}
}

366 
__š™
 
	$¥l™_nodes_by_size
(
boÙnode
 *
nodes
, 
u64
 *
addr
,

367 
u64
 
max_addr
, 
node_¡¬t
, u64 
size
)

369 
i
 = 
node_¡¬t
;

370 
size
 = (siz<< 20è& 
FAKE_NODE_MIN_HASH_MASK
;

371 !
	`£tup_node_¿nge
(
i
++, 
nodes
, 
addr
, 
size
, 
max_addr
))

373  
i
 - 
node_¡¬t
;

374 
	}
}

380 
__š™
 
	$numa_emuÏtiÚ
(
¡¬t_pâ
, 
’d_pâ
)

382 
boÙnode
 
nodes
[
MAX_NUMNODES
];

383 
u64
 
addr
 = 
¡¬t_pâ
 << 
PAGE_SHIFT
;

384 
u64
 
max_addr
 = 
’d_pâ
 << 
PAGE_SHIFT
;

385 
num_nodes
 = 0;

386 
cÛff_æag
;

387 
cÛff
 = -1;

388 
num
 = 0;

389 
u64
 
size
;

390 
i
;

392 
	`mem£t
(&
nodes
, 0, (nodes));

397 ià(!
	`¡rchr
(
cmdlše
, '*') && !strchr(cmdline, ',')) {

398 
num_nodes
 = 
	`¥l™_nodes_equ®ly
(
nodes
, &
addr
, 
max_addr
, 0,

399 
	`sim¶e_¡¹Ş
(
cmdlše
, 
NULL
, 0));

400 ià(
num_nodes
 < 0)

401  
num_nodes
;

402 
out
;

406 
cÛff_æag
 = 0; ; 
cmdlše
++) {

407 ià(*
cmdlše
 && 
	`isdig™
(*cmdline)) {

408 
num
 =‚um * 10 + *
cmdlše
 - '0';

411 ià(*
cmdlše
 == '*') {

412 ià(
num
 > 0)

413 
cÛff
 = 
num
;

414 
cÛff_æag
 = 1;

416 ià(!*
cmdlše
 || *cmdline == ',') {

417 ià(!
cÛff_æag
)

418 
cÛff
 = 1;

423 
size
 = ((
u64
)
num
 << 20è& 
FAKE_NODE_MIN_HASH_MASK
;

424 ià(
size
)

425 
i
 = 0; i < 
cÛff
; i++, 
num_nodes
++)

426 ià(
	`£tup_node_¿nge
(
num_nodes
, 
nodes
,

427 &
addr
, 
size
, 
max_addr
) < 0)

428 
dÚe
;

429 ià(!*
cmdlše
)

431 
cÛff_æag
 = 0;

432 
cÛff
 = -1;

434 
num
 = 0;

436 
dÚe
:

437 ià(!
num_nodes
)

440 ià(
addr
 < 
max_addr
) {

441 ià(
cÛff_æag
 && 
cÛff
 < 0) {

443 
num_nodes
 +ğ
	`¥l™_nodes_by_size
(
nodes
, &
addr
, 
max_addr
,

444 
num_nodes
, 
num
);

445 
out
;

447 *(
cmdlše
 - 1)) {

450 ià(
cÛff
 <= 0)

452 
num_nodes
 +ğ
	`¥l™_nodes_equ®ly
(
nodes
, &
addr
, 
max_addr
,

453 
num_nodes
, 
cÛff
);

460 
	`£tup_node_¿nge
(
num_nodes
, 
nodes
, &
addr
,

461 
max_addr
 - 
addr
, max_addr);

462 
num_nodes
++;

465 
out
:

466 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 
num_nodes
);

467 ià(
memnode_shiá
 < 0) {

468 
memnode_shiá
 = 0;

469 
	`´štk
(
KERN_ERR
 "No NUMA hash function found. NUMAƒmulation "

479 
	`»move_®l_aùive_¿nges
();

480 #ifdeà
CONFIG_ACPI_NUMA


481 
aıi_numa
 = -1;

483 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
) {

484 
	`e820_»gi¡”_aùive_»giÚs
(
i
, 
nodes
[i].
¡¬t
 >> 
PAGE_SHIFT
,

485 
nodes
[
i
].
’d
 >> 
PAGE_SHIFT
);

486 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

488 
	`aıi_çke_nodes
(
nodes
, 
num_nodes
);

489 
	`numa_š™_¬¿y
();

491 
	}
}

494 
__š™
 
	$numa_š™mem_š™
(
¡¬t_pâ
, 
’d_pâ
)

496 
i
;

498 
	`nodes_ş—r
(
node_possibË_m­
);

500 #ifdeà
CONFIG_NUMA_EMU


501 ià(
cmdlše
 && !
	`numa_emuÏtiÚ
(
¡¬t_pâ
, 
’d_pâ
))

503 
	`nodes_ş—r
(
node_possibË_m­
);

506 #ifdeà
CONFIG_ACPI_NUMA


507 ià(!
numa_off
 && !
	`aıi_sÿn_nodes
(
¡¬t_pâ
 << 
PAGE_SHIFT
,

508 
’d_pâ
 << 
PAGE_SHIFT
))

510 
	`nodes_ş—r
(
node_possibË_m­
);

513 #ifdeà
CONFIG_K8_NUMA


514 ià(!
numa_off
 && !
	`k8_sÿn_nodes
(
¡¬t_pâ
<<
PAGE_SHIFT
, 
’d_pâ
<<PAGE_SHIFT))

516 
	`nodes_ş—r
(
node_possibË_m­
);

518 
	`´štk
(
KERN_INFO
 "%s\n",

519 
numa_off
 ? "NUMAurned off" : "No NUMA configuration found");

521 
	`´štk
(
KERN_INFO
 "Faking‡‚ode‡t %016lx-%016lx\n",

522 
¡¬t_pâ
 << 
PAGE_SHIFT
,

523 
’d_pâ
 << 
PAGE_SHIFT
);

525 
memnode_shiá
 = 63;

526 
memnodem­
 = 
memnode
.
embedded_m­
;

527 
memnodem­
[0] = 0;

528 
	`nodes_ş—r
(
node_Úlše_m­
);

529 
	`node_£t_Úlše
(0);

530 
	`node_£t
(0, 
node_possibË_m­
);

531 
i
 = 0; i < 
NR_CPUS
; i++)

532 
	`numa_£t_node
(
i
, 0);

533 
node_to_ıumask
[0] = 
	`ıumask_of_ıu
(0);

534 
	`e820_»gi¡”_aùive_»giÚs
(0, 
¡¬t_pâ
, 
’d_pâ
);

535 
	`£tup_node_boÙmem
(0, 
¡¬t_pâ
 << 
PAGE_SHIFT
, 
’d_pâ
 << PAGE_SHIFT);

536 
	}
}

538 
__ıuš™
 
	$numa_add_ıu
(
ıu
)

540 
	`£t_b™
(
ıu
, &
node_to_ıumask
[
	`ıu_to_node
(cpu)]);

541 
	}
}

543 
__ıuš™
 
	$numa_£t_node
(
ıu
, 
node
)

545 
	`ıu_pda
(
ıu
)->
nod’umb”
 = 
node
;

546 
	`ıu_to_node
(
ıu
èğ
node
;

547 
	}
}

549 
__š™
 
	$numa_ä“_®l_boÙmem
()

551 
i
;

552 
·ges
 = 0;

553 
	`fÜ_—ch_Úlše_node
(
i
) {

554 
·ges
 +ğ
	`ä“_®l_boÙmem_node
(
	`NODE_DATA
(
i
));

556  
·ges
;

557 
	}
}

559 
__š™
 
	$·gšg_š™
()

561 
i
;

562 
max_zÚe_pâs
[
MAX_NR_ZONES
];

563 
	`mem£t
(
max_zÚe_pâs
, 0, (max_zone_pfns));

564 
max_zÚe_pâs
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

565 
max_zÚe_pâs
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

566 
max_zÚe_pâs
[
ZONE_NORMAL
] = 
’d_pâ
;

568 
	`¥¬£_memÜy_´e£Á_w™h_aùive_»giÚs
(
MAX_NUMNODES
);

569 
	`¥¬£_š™
();

571 
	`fÜ_—ch_Úlše_node
(
i
) {

572 
	`£tup_node_zÚes
(
i
);

575 
	`ä“_¬—_š™_nodes
(
max_zÚe_pâs
);

576 
	}
}

578 
__š™
 
	$numa_£tup
(*
İt
)

580 ià(!
İt
)

581  -
EINVAL
;

582 ià(!
	`¡ºcmp
(
İt
,"off",3))

583 
numa_off
 = 1;

584 #ifdeà
CONFIG_NUMA_EMU


585 ià(!
	`¡ºcmp
(
İt
, "fake=", 5))

586 
cmdlše
 = 
İt
 + 5;

588 #ifdeà
CONFIG_ACPI_NUMA


589 ià(!
	`¡ºcmp
(
İt
,"noacpi",6))

590 
aıi_numa
 = -1;

591 ià(!
	`¡ºcmp
(
İt
,"hotadd=", 7))

592 
hÙadd_³rûÁ
 = 
	`sim¶e_¡¹oul
(
İt
+7, 
NULL
, 10);

595 
	}
}

597 
—¾y_·¿m
("numa", 
numa_£tup
);

611 
__š™
 
	$š™_ıu_to_node
()

613 
i
;

614 
i
 = 0; i < 
NR_CPUS
; i++) {

615 
u8
 
­icid
 = 
x86_ıu_to_­icid_š™
[
i
];

616 ià(
­icid
 =ğ
BAD_APICID
)

618 ià(
­icid_to_node
[
­icid
] =ğ
NUMA_NO_NODE
)

620 
	`numa_£t_node
(
i
,
­icid_to_node
[
­icid
]);

622 
	}
}

624 
EXPORT_SYMBOL
(
ıu_to_node
);

625 
EXPORT_SYMBOL
(
node_to_ıumask
);

626 
EXPORT_SYMBOL
(
memnode
);

627 
EXPORT_SYMBOL
(
node_d©a
);

629 #ifdeà
CONFIG_DISCONTIGMEM


637 
	$pâ_v®id
(
pâ
)

639 
nid
;

640 ià(
pâ
 >ğ
num_phy¥ages
)

642 
nid
 = 
	`pâ_to_nid
(
pâ
);

643 ià(
nid
 == 0xff)

645  
pâ
 >ğ
	`node_¡¬t_pâ
(
nid
è&& (pâè< 
	`node_’d_pâ
(nid);

646 
	}
}

647 
EXPORT_SYMBOL
(
pâ_v®id
);

	@/cmpt816/linux/arch/x86/mm/pageattr_64.c

6 
	~<lšux/mm.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/highmem.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<asm/uacûss.h
>

12 
	~<asm/´oûssÜ.h
>

13 
	~<asm/bæush.h
>

14 
	~<asm/io.h
>

16 
±e_t
 *
	$lookup_add»ss
(
add»ss
)

18 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
add»ss
);

19 
pud_t
 *
pud
;

20 
pmd_t
 *
pmd
;

21 
±e_t
 *
±e
;

22 ià(
	`pgd_nÚe
(*
pgd
))

23  
NULL
;

24 
pud
 = 
	`pud_off£t
(
pgd
, 
add»ss
);

25 ià(!
	`pud_´e£Á
(*
pud
))

26  
NULL
;

27 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

28 ià(!
	`pmd_´e£Á
(*
pmd
))

29  
NULL
;

30 ià(
	`pmd_Ïrge
(*
pmd
))

31  (
±e_t
 *)
pmd
;

32 
±e
 = 
	`±e_off£t_k”Ãl
(
pmd
, 
add»ss
);

33 ià(
±e
 && !
	`±e_´e£Á
(*pte))

34 
±e
 = 
NULL
;

35  
±e
;

36 
	}
}

38 
·ge
 *
	$¥l™_Ïrge_·ge
(
add»ss
, 
pg´Ù_t
 
´Ù
,

39 
pg´Ù_t
 
»f_´Ù
)

41 
i
;

42 
addr
;

43 
·ge
 *
ba£
 = 
	`®loc_·ges
(
GFP_KERNEL
, 0);

44 
±e_t
 *
pba£
;

45 ià(!
ba£
)

46  
NULL
;

51 
	`S‘PagePriv©e
(
ba£
);

52 
	`·ge_´iv©e
(
ba£
) = 0;

54 
add»ss
 = 
	`__·
(address);

55 
addr
 = 
add»ss
 & 
LARGE_PAGE_MASK
;

56 
pba£
 = (
±e_t
 *)
	`·ge_add»ss
(
ba£
);

57 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
addr
 +ğ
PAGE_SIZE
) {

58 
pba£
[
i
] = 
	`pâ_±e
(
addr
 >> 
PAGE_SHIFT
,

59 
addr
 =ğ
add»ss
 ? 
´Ù
 : 
»f_´Ù
);

61  
ba£
;

62 
	}
}

64 
	$şæush_ÿche_¿nge
(*
adr
, 
size
)

66 
i
;

67 
i
 = 0; i < 
size
; i +ğ
boÙ_ıu_d©a
.
x86_şæush_size
)

68 
	`şæush
(
adr
+
i
);

69 
	}
}

71 
	$æush_k”Ãl_m­
(*
¬g
)

73 
li¡_h—d
 *
l
 = (li¡_h—d *)
¬g
;

74 
·ge
 *
pg
;

79 ià(1 || !
ıu_has_şæush
)

80 
asm
 volatile("wbinvd" ::: "memory");

81 
	`li¡_fÜ_—ch_’Œy
(
pg
, 
l
, 
Ìu
) {

82 *
adr
 = 
	`·ge_add»ss
(
pg
);

83 
	`şæush_ÿche_¿nge
(
adr
, 
PAGE_SIZE
);

85 
	`__æush_b_®l
();

86 
	}
}

88 
šlše
 
	$æush_m­
(
li¡_h—d
 *
l
)

90 
	`Ú_—ch_ıu
(
æush_k”Ãl_m­
, 
l
, 1, 1);

91 
	}
}

93 
LIST_HEAD
(
deã¼ed_·ges
);

95 
šlše
 
	$§ve_·ge
(
·ge
 *
åage
)

97 ià(!
	`‹¡_ªd_£t_b™
(
PG_¬ch_1
, &
åage
->
æags
))

98 
	`li¡_add
(&
åage
->
Ìu
, &
deã¼ed_·ges
);

99 
	}
}

105 
	$»v”t_·ge
(
add»ss
, 
pg´Ù_t
 
»f_´Ù
)

107 
pgd_t
 *
pgd
;

108 
pud_t
 *
pud
;

109 
pmd_t
 *
pmd
;

110 
±e_t
 
Ïrge_±e
;

111 
pâ
;

113 
pgd
 = 
	`pgd_off£t_k
(
add»ss
);

114 
	`BUG_ON
(
	`pgd_nÚe
(*
pgd
));

115 
pud
 = 
	`pud_off£t
(
pgd
,
add»ss
);

116 
	`BUG_ON
(
	`pud_nÚe
(*
pud
));

117 
pmd
 = 
	`pmd_off£t
(
pud
, 
add»ss
);

118 
	`BUG_ON
(
	`pmd_v®
(*
pmd
è& 
_PAGE_PSE
);

119 
pâ
 = (
	`__·
(
add»ss
è& 
LARGE_PAGE_MASK
è>> 
PAGE_SHIFT
;

120 
Ïrge_±e
 = 
	`pâ_±e
(
pâ
, 
»f_´Ù
);

121 
Ïrge_±e
 = 
	`±e_mkhuge
(large_pte);

122 
	`£t_±e
((
±e_t
 *)
pmd
, 
Ïrge_±e
);

123 
	}
}

126 
	$__chªge_·ge_©Œ
(
add»ss
, 
pâ
, 
pg´Ù_t
 
´Ù
,

127 
pg´Ù_t
 
»f_´Ù
)

129 
±e_t
 *
k±e
;

130 
·ge
 *
k±e_·ge
;

131 
pg´Ù_t
 
»f_´Ù2
;

133 
k±e
 = 
	`lookup_add»ss
(
add»ss
);

134 ià(!
k±e
)  0;

135 
k±e_·ge
 = 
	`vœt_to_·ge
((()
k±e
è& 
PAGE_MASK
);

136 
	`BUG_ON
(
	`PageLRU
(
k±e_·ge
));

137 
	`BUG_ON
(
	`PageCompound
(
k±e_·ge
));

138 ià(
	`pg´Ù_v®
(
´Ù
è!ğpg´Ù_v®(
»f_´Ù
)) {

139 ià(!
	`±e_huge
(*
k±e
)) {

140 
	`£t_±e
(
k±e
, 
	`pâ_±e
(
pâ
, 
´Ù
));

146 
·ge
 *
¥l™
;

147 
»f_´Ù2
 = 
	`±e_pg´Ù
(
	`±e_şrhuge
(*
k±e
));

148 
¥l™
 = 
	`¥l™_Ïrge_·ge
(
add»ss
, 
´Ù
, 
»f_´Ù2
);

149 ià(!
¥l™
)

150  -
ENOMEM
;

151 
	`pg´Ù_v®
(
»f_´Ù2
è&ğ~
_PAGE_NX
;

152 
	`£t_±e
(
k±e
, 
	`mk_±e
(
¥l™
, 
»f_´Ù2
));

153 
k±e_·ge
 = 
¥l™
;

155 
	`·ge_´iv©e
(
k±e_·ge
)++;

156 } ià(!
	`±e_huge
(*
k±e
)) {

157 
	`£t_±e
(
k±e
, 
	`pâ_±e
(
pâ
, 
»f_´Ù
));

158 
	`BUG_ON
(
	`·ge_´iv©e
(
k±e_·ge
) == 0);

159 
	`·ge_´iv©e
(
k±e_·ge
)--;

161 
	`BUG
();

164 
	`BUG_ON
(
	`PageRe£rved
(
k±e_·ge
));

166 
	`§ve_·ge
(
k±e_·ge
);

167 ià(
	`·ge_´iv©e
(
k±e_·ge
) == 0)

168 
	`»v”t_·ge
(
add»ss
, 
»f_´Ù
);

170 
	}
}

185 
	$chªge_·ge_©Œ_addr
(
add»ss
, 
num·ges
, 
pg´Ù_t
 
´Ù
)

187 
”r
 = 0, 
k”Ãl_m­
 = 0;

188 
i
;

190 ià(
add»ss
 >ğ
__START_KERNEL_m­


191 && 
add»ss
 < 
__START_KERNEL_m­
 + 
KERNEL_TEXT_SIZE
) {

192 
add»ss
 = ()
	`__va
(
	`__·
(address));

193 
k”Ãl_m­
 = 1;

196 
	`down_wr™e
(&
š™_mm
.
mm­_£m
);

197 
i
 = 0; i < 
num·ges
; i++, 
add»ss
 +ğ
PAGE_SIZE
) {

198 
pâ
 = 
	`__·
(
add»ss
è>> 
PAGE_SHIFT
;

200 ià(!
k”Ãl_m­
 || 
	`±e_´e£Á
(
	`pâ_±e
(0, 
´Ù
))) {

201 
”r
 = 
	`__chªge_·ge_©Œ
(
add»ss
, 
pâ
, 
´Ù
, 
PAGE_KERNEL
);

202 ià(
”r
)

207 ià(
	`__·
(
add»ss
è< 
KERNEL_TEXT_SIZE
) {

208 
addr2
;

209 
pg´Ù_t
 
´Ù2
;

210 
addr2
 = 
__START_KERNEL_m­
 + 
	`__·
(
add»ss
);

212 
´Ù2
 = 
	`±e_pg´Ù
(
	`±e_mkexec
(
	`pâ_±e
(0, 
´Ù
)));

213 
”r
 = 
	`__chªge_·ge_©Œ
(
addr2
, 
pâ
, 
´Ù2
,

214 
PAGE_KERNEL_EXEC
);

217 
	`up_wr™e
(&
š™_mm
.
mm­_£m
);

218  
”r
;

219 
	}
}

222 
	$chªge_·ge_©Œ
(
·ge
 *·ge, 
num·ges
, 
pg´Ù_t
 
´Ù
)

224 
addr
 = ()
	`·ge_add»ss
(
·ge
);

225  
	`chªge_·ge_©Œ_addr
(
addr
, 
num·ges
, 
´Ù
);

226 
	}
}

228 
	$glob®_æush_b
()

230 
·ge
 *
pg
, *
Ãxt
;

231 
li¡_h—d
 
l
;

238 
	`down_wr™e
(&
š™_mm
.
mm­_£m
);

239 
	`li¡_»¶aû_š™
(&
deã¼ed_·ges
, &
l
);

240 
	`up_wr™e
(&
š™_mm
.
mm­_£m
);

242 
	`æush_m­
(&
l
);

244 
	`li¡_fÜ_—ch_’Œy_§ã
(
pg
, 
Ãxt
, &
l
, 
Ìu
) {

245 
	`li¡_d–
(&
pg
->
Ìu
);

246 
	`ş—r_b™
(
PG_¬ch_1
, &
pg
->
æags
);

247 ià(
	`·ge_´iv©e
(
pg
) != 0)

249 
	`CË¬PagePriv©e
(
pg
);

250 
	`__ä“_·ge
(
pg
);

252 
	}
}

254 
EXPORT_SYMBOL
(
chªge_·ge_©Œ
);

255 
EXPORT_SYMBOL
(
glob®_æush_b
);

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/aıi.h
>

14 
	~<lšux/mmzÚe.h
>

15 
	~<lšux/b™m­.h
>

16 
	~<lšux/moduË.h
>

17 
	~<lšux/tİŞogy.h
>

18 
	~<lšux/boÙmem.h
>

19 
	~<lšux/mm.h
>

20 
	~<asm/´Ùo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

24 
aıi_numa
 
	g__š™d©a
;

26 
aıi_bË_¦™
 *
	gaıi_¦™
;

28 
nodemask_t
 
nodes_·r£d
 
	g__š™d©a
;

29 
boÙnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__š™d©a
;

30 
boÙnode
 
	gnodes_add
[
MAX_NUMNODES
];

31 
found_add_¬—
 
	g__š™d©a
;

32 
hÙadd_³rûÁ
 
	g__š™d©a
 = 0;

36 
	#NODE_MIN_SIZE
 (4*1024*1024)

	)

38 
__š™
 
	$£tup_node
(
pxm
)

40  
	`aıi_m­_pxm_to_node
(
pxm
);

41 
	}
}

43 
__š™
 
	$cÚæiùšg_nodes
(
¡¬t
, 
’d
)

45 
i
;

46 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
) {

47 
boÙnode
 *
nd
 = &
nodes
[
i
];

48 ià(
nd
->
¡¬t
 =ğnd->
’d
)

50 ià(
nd
->
’d
 > 
¡¬t
 &&‚d->start <ƒnd)

51  
i
;

52 ià(
nd
->
’d
 =ğ’d &&‚d->
¡¬t
 == start)

53  
i
;

56 
	}
}

58 
__š™
 
	$cutoff_node
(
i
, 
¡¬t
, 
’d
)

60 
boÙnode
 *
nd
 = &
nodes
[
i
];

62 ià(
found_add_¬—
)

65 ià(
nd
->
¡¬t
 < start) {

66 
nd
->
¡¬t
 = start;

67 ià(
nd
->
’d
 <‚d->
¡¬t
)

68 
nd
->
¡¬t
 =‚d->
’d
;

70 ià(
nd
->
’d
 >ƒnd) {

71 
nd
->
’d
 =ƒnd;

72 ià(
nd
->
¡¬t
 >‚d->
’d
)

73 
nd
->
¡¬t
 =‚d->
’d
;

75 
	}
}

77 
__š™
 
	$bad_¤©
()

79 
i
;

80 
	`´štk
(
KERN_ERR
 "SRAT: SRAT‚ot used.\n");

81 
aıi_numa
 = -1;

82 
found_add_¬—
 = 0;

83 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

84 
­icid_to_node
[
i
] = 
NUMA_NO_NODE
;

85 
i
 = 0; i < 
MAX_NUMNODES
; i++)

86 
nodes_add
[
i
].
¡¬t
 = 
nodes
[i].
’d
 = 0;

87 
	`»move_®l_aùive_¿nges
();

88 
	}
}

90 
__š™
 
šlše
 
	$¤©_di§bËd
()

92  
numa_off
 || 
aıi_numa
 < 0;

93 
	}
}

101 
__š™
 
	$¦™_v®id
(
aıi_bË_¦™
 *
¦™
)

103 
i
, 
j
;

104 
d
 = 
¦™
->
loÿl™y_couÁ
;

105 
i
 = 0; i < 
d
; i++) {

106 
j
 = 0; j < 
d
; j++) {

107 
u8
 
v®
 = 
¦™
->
’Œy
[
d
*
i
 + 
j
];

108 ià(
i
 =ğ
j
) {

109 ià(
v®
 !ğ
LOCAL_DISTANCE
)

111 } ià(
v®
 <ğ
LOCAL_DISTANCE
)

116 
	}
}

119 
__š™
 
	$aıi_numa_¦™_š™
(
aıi_bË_¦™
 *
¦™
)

121 ià(!
	`¦™_v®id
(
¦™
)) {

122 
	`´štk
(
KERN_INFO
 "ACPI: SLITable†ooks invalid. Not used.\n");

125 
aıi_¦™
 = 
¦™
;

126 
	}
}

129 
__š™


130 
	$aıi_numa_´oûssÜ_affš™y_š™
(
aıi_¤©_ıu_affš™y
 *
·
)

132 
pxm
, 
node
;

133 ià(
	`¤©_di§bËd
())

135 ià(
·
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_ıu_affš™y
)) {

136 
	`bad_¤©
();

139 ià((
·
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

141 
pxm
 = 
·
->
´oxim™y_domaš_lo
;

142 
node
 = 
	`£tup_node
(
pxm
);

143 ià(
node
 < 0) {

144 
	`´štk
(
KERN_ERR
 "SRAT: ToØmªy…roxim™y domaš %x\n", 
pxm
);

145 
	`bad_¤©
();

148 
­icid_to_node
[
·
->
­ic_id
] = 
node
;

149 
aıi_numa
 = 1;

150 
	`´štk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

151 
pxm
, 
·
->
­ic_id
, 
node
);

152 
	}
}

154 #ifdeà
CONFIG_MEMORY_HOTPLUG_RESERVE


158 
	$hÙadd_’ough_memÜy
(
boÙnode
 *
nd
)

160 
®loÿ‹d
;

161 
Ï¡_¬—_’d
;

162 
·ges
 = (
nd
->
’d
 -‚d->
¡¬t
è>> 
PAGE_SHIFT
;

163 
mem
 = 
·ges
 * (
·ge
);

164 
addr
;

165 
®lowed
;

166 
Şd·ges
 = 
·ges
;

168 ià(
mem
 < 0)

170 
®lowed
 = (
’d_pâ
 - 
	`ab£Á_·ges_š_¿nge
(0,ƒnd_pâ)è* 
PAGE_SIZE
;

171 
®lowed
 = (®lowed / 100è* 
hÙadd_³rûÁ
;

172 ià(
®loÿ‹d
 + 
mem
 > 
®lowed
) {

173 
¿nge
;

178 ià(
®loÿ‹d
 >ğ
®lowed
)

180 
¿nge
 = 
®lowed
 - 
®loÿ‹d
;

181 
·ges
 = (
¿nge
 / 
PAGE_SIZE
);

182 
mem
 = 
·ges
 * (
·ge
);

183 
nd
->
’d
 =‚d->
¡¬t
 + 
¿nge
;

186 
addr
 = 
	`fšd_e820_¬—
(
Ï¡_¬—_’d
, 
’d_pâ
<<
PAGE_SHIFT
, 
mem
);

187 ià(
addr
 == -1UL)

189 ià(
·ges
 !ğ
Şd·ges
)

190 
	`´štk
(
KERN_NOTICE
 "SRAT: Hotadd‡rea†imitedo %lu bytes\n",

191 
·ges
 << 
PAGE_SHIFT
);

192 
Ï¡_¬—_’d
 = 
addr
 + 
mem
;

193 
®loÿ‹d
 +ğ
mem
;

195 
	}
}

197 
	$upd©e_’d_of_memÜy
(
’d
)

199 
found_add_¬—
 = 1;

200 ià((
’d
 >> 
PAGE_SHIFT
è> 
’d_pâ
)

201 
’d_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

203 
	}
}

205 
šlše
 
	$§ve_add_šfo
()

207  
hÙadd_³rûÁ
 > 0;

208 
	}
}

210 
	$upd©e_’d_of_memÜy
(
’d
è{ -1;
	}
}

211 
	$hÙadd_’ough_memÜy
(
boÙnode
 *
nd
è{ 1;
	}
}

212 #ifdeà
CONFIG_MEMORY_HOTPLUG_SPARSE


213 
šlše
 
	$§ve_add_šfo
(è{ 1;
	}
}

215 
šlše
 
	$§ve_add_šfo
(è{ 0;
	}
}

223 
	$»£rve_hÙadd
(
node
, 
¡¬t
, 
’d
)

225 
s_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

226 
e_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

227 
»t
 = 0, 
chªged
 = 0;

228 
boÙnode
 *
nd
 = &
nodes_add
[
node
];

236 ià((sigÃd )(
’d
 - 
¡¬t
è< 
NODE_MIN_SIZE
) {

237 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug‡reaoo small\n");

242 ià(
	`ab£Á_·ges_š_¿nge
(
s_pâ
, 
e_pâ
) !=ƒ_pfn - s_pfn) {

243 
	`´štk
(
KERN_ERR


245 
s_pâ
, 
e_pâ
);

249 ià(!
	`hÙadd_’ough_memÜy
(&
nodes_add
[
node
])) {

250 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug‡reaoo†arge\n");

256 ià(
nd
->
¡¬t
 =ğnd->
’d
) {

257 
nd
->
¡¬t
 = start;

258 
nd
->
’d
 =ƒnd;

259 
chªged
 = 1;

261 ià(
nd
->
¡¬t
 =ğ
’d
) {

262 
nd
->
¡¬t
 = start;

263 
chªged
 = 1;

265 ià(
nd
->
’d
 =ğ
¡¬t
) {

266 
nd
->
’d
 =ƒnd;

267 
chªged
 = 1;

269 ià(!
chªged
)

270 
	`´štk
(
KERN_ERR
 "SRAT: Hotplug zone‚ot continuous. Partly ignored\n");

273 
»t
 = 
	`upd©e_’d_of_memÜy
(
nd
->
’d
);

275 ià(
chªged
)

276 
	`´štk
(
KERN_INFO
 "SRAT: hÙ…lug zÚfound %Lx - %Lx\n", 
nd
->
¡¬t
,‚d->
’d
);

277  
»t
;

278 
	}
}

281 
__š™


282 
	$aıi_numa_memÜy_affš™y_š™
(
aıi_¤©_mem_affš™y
 *
ma
)

284 
boÙnode
 *
nd
, 
Şdnode
;

285 
¡¬t
, 
’d
;

286 
node
, 
pxm
;

287 
i
;

289 ià(
	`¤©_di§bËd
())

291 ià(
ma
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_mem_affš™y
)) {

292 
	`bad_¤©
();

295 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

298 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
è&& !
	`§ve_add_šfo
())

300 
¡¬t
 = 
ma
->
ba£_add»ss
;

301 
’d
 = 
¡¬t
 + 
ma
->
Ëngth
;

302 
pxm
 = 
ma
->
´oxim™y_domaš
;

303 
node
 = 
	`£tup_node
(
pxm
);

304 ià(
node
 < 0) {

305 
	`´štk
(
KERN_ERR
 "SRAT: Too many…roximity domains.\n");

306 
	`bad_¤©
();

309 
i
 = 
	`cÚæiùšg_nodes
(
¡¬t
, 
’d
);

310 ià(
i
 =ğ
node
) {

311 
	`´štk
(
KERN_WARNING


313 
pxm
, 
¡¬t
, 
’d
, 
nodes
[
i
].start,‚odes[i].end);

314 } ià(
i
 >= 0) {

315 
	`´štk
(
KERN_ERR


317 
pxm
, 
¡¬t
, 
’d
, 
	`node_to_pxm
(
i
),

318 
nodes
[
i
].
¡¬t
,‚odes[i].
’d
);

319 
	`bad_¤©
();

322 
nd
 = &
nodes
[
node
];

323 
Şdnode
 = *
nd
;

324 ià(!
	`node_‹¡_ªd_£t
(
node
, 
nodes_·r£d
)) {

325 
nd
->
¡¬t
 = start;

326 
nd
->
’d
 =ƒnd;

328 ià(
¡¬t
 < 
nd
->start)

329 
nd
->
¡¬t
 = start;

330 ià(
nd
->
’d
 <ƒnd)

331 
nd
->
’d
 =ƒnd;

334 
	`´štk
(
KERN_INFO
 "SRAT: Nod%u PXM %u %Lx-%Lx\n", 
node
, 
pxm
,

335 
nd
->
¡¬t
,‚d->
’d
);

336 
	`e820_»gi¡”_aùive_»giÚs
(
node
, 
nd
->
¡¬t
 >> 
PAGE_SHIFT
,

337 
nd
->
’d
 >> 
PAGE_SHIFT
);

338 
	`push_node_bound¬›s
(
node
, 
nd
->
¡¬t
 >> 
PAGE_SHIFT
,

339 
nd
->
’d
 >> 
PAGE_SHIFT
);

341 ià((
ma
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) &&

342 (
	`»£rve_hÙadd
(
node
, 
¡¬t
, 
’d
) < 0)) {

344 
	`´štk
(
KERN_NOTICE
 "SRAT: Hotplug„egion ignored\n");

345 *
nd
 = 
Şdnode
;

346 ià((
nd
->
¡¬t
 |‚d->
’d
) == 0)

347 
	`node_ş—r
(
node
, 
nodes_·r£d
);

349 
	}
}

353 
__š™
 
	$nodes_cov”_memÜy
(cÚ¡ 
boÙnode
 *
nodes
)

355 
i
;

356 
pxm¿m
, 
e820¿m
;

358 
pxm¿m
 = 0;

359 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
) {

360 
s
 = 
nodes
[
i
].
¡¬t
 >> 
PAGE_SHIFT
;

361 
e
 = 
nodes
[
i
].
’d
 >> 
PAGE_SHIFT
;

362 
pxm¿m
 +ğ
e
 - 
s
;

363 
pxm¿m
 -ğ
	`ab£Á_·ges_š_¿nge
(
s
, 
e
);

364 ià(()
pxm¿m
 < 0)

365 
pxm¿m
 = 0;

368 
e820¿m
 = 
’d_pâ
 - 
	`ab£Á_·ges_š_¿nge
(0,ƒnd_pfn);

370 ià(()(
e820¿m
 - 
pxm¿m
) >= 1*1024*1024) {

371 
	`´štk
(
KERN_ERR


373 (
pxm¿m
 << 
PAGE_SHIFT
) >> 20,

374 (
e820¿m
 << 
PAGE_SHIFT
) >> 20);

378 
	}
}

380 
	$uÅ¬£_node
(
node
)

382 
i
;

383 
	`node_ş—r
(
node
, 
nodes_·r£d
);

384 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++) {

385 ià(
­icid_to_node
[
i
] =ğ
node
)

386 
­icid_to_node
[
i
] = 
NUMA_NO_NODE
;

388 
	}
}

390 
__š™
 
	$aıi_numa_¬ch_fixup
(è{
	}
}

393 
__š™
 
	$aıi_sÿn_nodes
(
¡¬t
, 
’d
)

395 
i
;

397 ià(
aıi_numa
 <= 0)

401 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

402 
	`cutoff_node
(
i
, 
¡¬t
, 
’d
);

403 ià((
nodes
[
i
].
’d
 -‚odes[i].
¡¬t
è< 
NODE_MIN_SIZE
) {

404 
	`uÅ¬£_node
(
i
);

405 
	`node_£t_ofæše
(
i
);

409 ià(!
	`nodes_cov”_memÜy
(
nodes
)) {

410 
	`bad_¤©
();

414 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 
MAX_NUMNODES
);

415 ià(
memnode_shiá
 < 0) {

416 
	`´štk
(
KERN_ERR


418 
	`bad_¤©
();

422 
node_possibË_m­
 = 
nodes_·r£d
;

425 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
)

426 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

429 
	`fÜ_—ch_node_mask
(
i
, 
node_possibË_m­
)

430 ià(!
	`node_Úlše
(
i
))

431 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

433 
i
 = 0; i < 
NR_CPUS
; i++) {

434 ià(
	`ıu_to_node
(
i
è=ğ
NUMA_NO_NODE
)

436 ià(!
	`node_is£t
(
	`ıu_to_node
(
i
), 
node_possibË_m­
))

437 
	`numa_£t_node
(
i
, 
NUMA_NO_NODE
);

439 
	`numa_š™_¬¿y
();

441 
	}
}

443 #ifdeà
CONFIG_NUMA_EMU


444 
__š™
 
	$fšd_node_by_addr
(
addr
)

446 
»t
 = 
NUMA_NO_NODE
;

447 
i
;

449 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
) {

455 ià(
addr
 >ğ
nodes
[
i
].
¡¬t
 &&‡dd¸<‚odes[i].
’d
) {

456 
»t
 = 
i
;

460  
i
;

461 
	}
}

471 
__š™
 
	$aıi_çke_nodes
(cÚ¡ 
boÙnode
 *
çke_nodes
, 
num_nodes
)

473 
i
, 
j
;

474 
çke_node_to_pxm_m­
[
MAX_NUMNODES
] = {

475 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


477 
çke_­icid_to_node
[
MAX_LOCAL_APIC
] = {

478 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


481 
	`´štk
(
KERN_INFO
 "Faking PXM‡ffinity for fake‚odes on„eal "

483 
i
 = 0; i < 
num_nodes
; i++) {

484 
nid
, 
pxm
;

486 
nid
 = 
	`fšd_node_by_addr
(
çke_nodes
[
i
].
¡¬t
);

487 ià(
nid
 =ğ
NUMA_NO_NODE
)

489 
pxm
 = 
	`node_to_pxm
(
nid
);

490 ià(
pxm
 =ğ
PXM_INVAL
)

492 
çke_node_to_pxm_m­
[
i
] = 
pxm
;

497 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

498 ià(
­icid_to_node
[
j
] =ğ
nid
)

499 
çke_­icid_to_node
[
j
] = 
i
;

501 
i
 = 0; i < 
num_nodes
; i++)

502 
	`__aıi_m­_pxm_to_node
(
çke_node_to_pxm_m­
[
i
], i);

503 
	`memıy
(
­icid_to_node
, 
çke_­icid_to_node
, (apicid_to_node));

505 
	`nodes_ş—r
(
nodes_·r£d
);

506 
i
 = 0; i < 
num_nodes
; i++)

507 ià(
çke_nodes
[
i
].
¡¬t
 !ğçke_nodes[i].
’d
)

508 
	`node_£t
(
i
, 
nodes_·r£d
);

509 
	`WARN_ON
(!
	`nodes_cov”_memÜy
(
çke_nodes
));

510 
	}
}

512 
	$nuÎ_¦™_node_com·»
(
a
, 
b
)

514  
	`node_to_pxm
(
a
è=ğnode_to_pxm(
b
);

515 
	}
}

517 
	$nuÎ_¦™_node_com·»
(
a
, 
b
)

519  
a
 =ğ
b
;

520 
	}
}

523 
__š™
 
	$¤©_»£rve_add_¬—
(
nodeid
)

525 ià(
found_add_¬—
 && 
nodes_add
[
nodeid
].
’d
) {

526 
u64
 
tÙ®_mb
;

528 
	`´štk
(
KERN_INFO
 "SRAT: Reserving hot-add memory space "

530 
nodeid
, 
nodes_add
[nodeid].
¡¬t
,‚odes_add[nodeid].
’d
);

531 
tÙ®_mb
 = (
nodes_add
[
nodeid
].
’d
 -‚odes_add[nodeid].
¡¬t
)

532 >> 
PAGE_SHIFT
;

533 
tÙ®_mb
 *ğ(
·ge
);

534 
tÙ®_mb
 >>= 20;

535 
	`´štk
(
KERN_INFO
 "SRAT: This will cost you %Lu MB of "

536 "´e-®loÿ‹d memÜy.\n", ()
tÙ®_mb
);

537 
	`»£rve_boÙmem_node
(
	`NODE_DATA
(
nodeid
), 
nodes_add
[nodeid].
¡¬t
,

538 
nodes_add
[
nodeid
].
’d
 -‚odes_add[nodeid].
¡¬t
);

540 
	}
}

542 
	$__node_di¡ªû
(
a
, 
b
)

544 
šdex
;

546 ià(!
aıi_¦™
)

547  
	`nuÎ_¦™_node_com·»
(
a
, 
b
è? 
LOCAL_DISTANCE
 :

548 
REMOTE_DISTANCE
;

549 
šdex
 = 
aıi_¦™
->
loÿl™y_couÁ
 * 
	`node_to_pxm
(
a
);

550  
aıi_¦™
->
’Œy
[
šdex
 + 
	`node_to_pxm
(
b
)];

551 
	}
}

553 
EXPORT_SYMBOL
(
__node_di¡ªû
);

555 
	$memÜy_add_phy§ddr_to_nid
(
u64
 
¡¬t
)

557 
i
, 
»t
 = 0;

559 
	`fÜ_—ch_node
(
i
)

560 ià(
nodes_add
[
i
].
¡¬t
 <ğ¡¬ˆ&&‚odes_add[i].
’d
 > start)

561 
»t
 = 
i
;

563  
»t
;

564 
	}
}

565 
EXPORT_SYMBOL_GPL
(
memÜy_add_phy§ddr_to_nid
);

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/posix-tim”s.h
>

14 
	~<lšux/time.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<asm/vsysÿÎ.h
>

17 
	~<asm/vgtod.h
>

18 
	~<asm/timex.h
>

19 
	~<asm/h³t.h
>

20 
	~<asm/uni¡d.h
>

21 
	~<asm/io.h
>

22 
	~<asm/vgtod.h
>

23 
	~"vex‹º.h
"

25 
	#gtod
 
vdso_vsysÿÎ_gtod_d©a


	)

27 
	$vdso_çÎback_g‘time
(
şock
, 
time¥ec
 *
ts
)

29 
»t
;

30 
	`asm
("sysÿÎ" : "÷" (
»t
) :

31 "0" (
__NR_şock_g‘time
),"D" (
şock
), "S" (
ts
) : "memory");

32  
»t
;

33 
	}
}

35 
šlše
 
	$vg‘ns
()

37 
v
;

38 
	`cyşes_t
 (*
v»ad
)();

39 
v»ad
 = 
gtod
->
şock
.vread;

40 
v
 = (
	`v»ad
(è- 
gtod
->
şock
.
cyşe_Ï¡
è& gtod->şock.
mask
;

41  (
v
 * 
gtod
->
şock
.
muÉ
è>> gtod->şock.
shiá
;

42 
	}
}

44 
nošlše
 
	$do_»®time
(
time¥ec
 *
ts
)

46 
£q
, 
ns
;

48 
£q
 = 
	`»ad_£qbegš
(&
gtod
->
lock
);

49 
ts
->
tv_£c
 = 
gtod
->
w®l_time_£c
;

50 
ts
->
tv_n£c
 = 
gtod
->
w®l_time_n£c
;

51 
ns
 = 
	`vg‘ns
();

52 } 
	`uÆik–y
(
	`»ad_£q»Œy
(&
gtod
->
lock
, 
£q
)));

53 
	`time¥ec_add_ns
(
ts
, 
ns
);

55 
	}
}

58 
	$v£t_nÜm®ized_time¥ec
(
time¥ec
 *
ts
, 
£c
, 
n£c
)

60 
n£c
 >ğ
NSEC_PER_SEC
) {

61 
n£c
 -ğ
NSEC_PER_SEC
;

62 ++
£c
;

64 
n£c
 < 0) {

65 
n£c
 +ğ
NSEC_PER_SEC
;

66 --
£c
;

68 
ts
->
tv_£c
 = 
£c
;

69 
ts
->
tv_n£c
 = 
n£c
;

70 
	}
}

72 
nošlše
 
	$do_mÚÙÚic
(
time¥ec
 *
ts
)

74 
£q
, 
ns
, 
£cs
;

76 
£q
 = 
	`»ad_£qbegš
(&
gtod
->
lock
);

77 
£cs
 = 
gtod
->
w®l_time_£c
;

78 
ns
 = 
gtod
->
w®l_time_n£c
 + 
	`vg‘ns
();

79 
£cs
 +ğ
gtod
->
w®l_to_mÚÙÚic
.
tv_£c
;

80 
ns
 +ğ
gtod
->
w®l_to_mÚÙÚic
.
tv_n£c
;

81 } 
	`uÆik–y
(
	`»ad_£q»Œy
(&
gtod
->
lock
, 
£q
)));

82 
	`v£t_nÜm®ized_time¥ec
(
ts
, 
£cs
, 
ns
);

84 
	}
}

86 
	$__vdso_şock_g‘time
(
şockid_t
 
şock
, 
time¥ec
 *
ts
)

88 ià(
	`lik–y
(
gtod
->
sysùl_’abËd
 && gtod->
şock
.
v»ad
))

89 
şock
) {

90 
CLOCK_REALTIME
:

91  
	`do_»®time
(
ts
);

92 
CLOCK_MONOTONIC
:

93  
	`do_mÚÙÚic
(
ts
);

95  
	`vdso_çÎback_g‘time
(
şock
, 
ts
);

96 
	}
}

97 
	$şock_g‘time
(
şockid_t
, 
time¥ec
 *)

98 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_clock_gettime")));

100 
	$__vdso_g‘timeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

102 
»t
;

103 ià(
	`lik–y
(
gtod
->
sysùl_’abËd
 && gtod->
şock
.
v»ad
)) {

104 
	`BUILD_BUG_ON
(
	`off£tof
(
timev®
, 
tv_u£c
) !=

105 
	`off£tof
(
time¥ec
, 
tv_n£c
) ||

106 (*
tv
è!ğ(
time¥ec
));

107 
	`do_»®time
((
time¥ec
 *)
tv
);

108 
tv
->
tv_u£c
 /= 1000;

109 ià(
	`uÆik–y
(
tz
 !ğ
NULL
)) {

112 
	`memıy
(
tz
, &
gtod
->
sys_tz
, (
timezÚe
));

116 
	`asm
("sysÿÎ" : "÷" (
»t
) :

117 "0" (
__NR_g‘timeofday
), "D" (
tv
), "S" (
tz
) : "memory");

118  
»t
;

119 
	}
}

120 
	$g‘timeofday
(
timev®
 *, 
timezÚe
 *)

121 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/g‘ıu.h
>

10 
	~<lšux/jiff›s.h
>

11 
	~<lšux/time.h
>

12 
	~<asm/vsysÿÎ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vex‹º.h
"

16 
	$__vdso_g‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
unu£d
)

18 
dummy
, 
p
;

20 ià(*
vdso_vg‘ıu_mode
 =ğ
VGETCPU_RDTSCP
) {

22 
	`rdtsı
(
dummy
, dummy, 
p
);

25 
	`asm
("l¦ %1,%0" : "ô" (
p
è: "r" (
__PER_CPU_SEG
));

27 ià(
ıu
)

28 *
ıu
 = 
p
 & 0xfff;

29 ià(
node
)

30 *
node
 = 
p
 >> 12;

32 
	}
}

34 
	$g‘ıu
(*
ıu
, *
node
, 
g‘ıu_ÿche
 *
tÿche
)

35 
	`__©Œibu‹__
((
w—k
, 
	`®Ÿs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<lšux/mm.h
>

7 
	~<lšux/”r.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/¿ndom.h
>

11 
	~<asm/vsysÿÎ.h
>

12 
	~<asm/vgtod.h
>

13 
	~<asm/´Ùo.h
>

14 
	~"voff£t.h
"

16 
	gvdso_’abËd
 = 1;

18 
	#VEXTERN
(
x
è
	`ty³of
(
__
 ## xè*
vdso_
 ## x;

	)

19 
	~"vex‹º.h
"

20 #undeà
VEXTERN


22 
vdso_k”Ãl_¡¬t
[], 
vdso_¡¬t
[], 
vdso_’d
[];

23 
vdso_sync_ıuid
;

25 
·ge
 **
	gvdso_·ges
;

27 
šlše
 *
	$v¬_»f
(*
vba£
, *
v¬
, *
Çme
)

29 
off£t
 = 
v¬
 - &
vdso_k”Ãl_¡¬t
[0] + 
VDSO_TEXT_OFFSET
;

30 *
p
 = 
vba£
 + 
off£t
;

31 ià(*(**)
p
 !ğ(*)
VMAGIC
) {

32 
	`´štk
("VDSO: v¬ŸbË % brok’\n", 
Çme
);

33 
vdso_’abËd
 = 0;

35  
p
;

36 
	}
}

38 
__š™
 
	$š™_vdso_v¬s
()

40 
Åages
 = (
vdso_’d
 - 
vdso_¡¬t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

41 
i
;

42 *
vba£
;

44 
vdso_·ges
 = 
	`km®loc
((
·ge
 *è* 
Åages
, 
GFP_KERNEL
);

45 ià(!
vdso_·ges
)

46 
oom
;

47 
i
 = 0; i < 
Åages
; i++) {

48 
·ge
 *
p
;

49 
p
 = 
	`®loc_·ge
(
GFP_KERNEL
);

50 ià(!
p
)

51 
oom
;

52 
vdso_·ges
[
i
] = 
p
;

53 
	`cİy_·ge
(
	`·ge_add»ss
(
p
), 
vdso_¡¬t
 + 
i
*
PAGE_SIZE
);

56 
vba£
 = 
	`vm­
(
vdso_·ges
, 
Åages
, 0, 
PAGE_KERNEL
);

57 ià(!
vba£
)

58 
oom
;

60 ià(
	`memcmp
(
vba£
, "\177ELF", 4)) {

61 
	`´štk
("VDSO: I'm broken;‚ot ELF\n");

62 
vdso_’abËd
 = 0;

65 
	#V
(
x
è*(
	`ty³of
(xè*è
	`v¬_»f
(
vba£
, (*)
	`RELOC_HIDE
(&x, 0), #x)

	)

66 
	#VEXTERN
(
x
) \

67 
	`V
(
vdso_
 ## 
x
èğ&
__
 ## x;

	)

68 
	~"vex‹º.h
"

69 #undeà
VEXTERN


72 
oom
:

73 
	`´štk
("Cannot‡llocate vdso\n");

74 
vdso_’abËd
 = 0;

75  -
ENOMEM
;

76 
	}
}

77 
__š™ÿÎ
(
š™_vdso_v¬s
);

79 
	glšux_bš´m
;

85 
	$vdso_addr
(
¡¬t
, 
Ën
)

87 
addr
, 
’d
;

88 
off£t
;

89 
’d
 = (
¡¬t
 + 
PMD_SIZE
 - 1è& 
PMD_MASK
;

90 ià(
’d
 >ğ
TASK_SIZE64
)

91 
’d
 = 
TASK_SIZE64
;

92 
’d
 -ğ
Ën
;

94 
off£t
 = 
	`g‘_¿ndom_št
(è& (
PTRS_PER_PTE
 - 1);

95 
addr
 = 
¡¬t
 + (
off£t
 << 
PAGE_SHIFT
);

96 ià(
addr
 >ğ
’d
)

97 
addr
 = 
’d
;

98  
addr
;

99 
	}
}

103 
	$¬ch_£tup_add™iÚ®_·ges
(
lšux_bš´m
 *
b´m
, 
ex¡ack
)

105 
mm_¡ruù
 *
mm
 = 
cu¼’t
->mm;

106 
addr
;

107 
»t
;

108 
Ën
 = 
	`round_up
(
vdso_’d
 - 
vdso_¡¬t
, 
PAGE_SIZE
);

110 ià(!
vdso_’abËd
)

113 
	`down_wr™e
(&
mm
->
mm­_£m
);

114 
addr
 = 
	`vdso_addr
(
mm
->
¡¬t_¡ack
, 
Ën
);

115 
addr
 = 
	`g‘_unm­³d_¬—
(
NULL
,‡ddr, 
Ën
, 0, 0);

116 ià(
	`IS_ERR_VALUE
(
addr
)) {

117 
»t
 = 
addr
;

118 
up_ç
;

121 
»t
 = 
	`š¡®l_¥ecŸl_m­pšg
(
mm
, 
addr
, 
Ën
,

122 
VM_READ
|
VM_EXEC
|

123 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

124 
VM_ALWAYSDUMP
,

125 
vdso_·ges
);

126 ià(
»t
)

127 
up_ç
;

129 
cu¼’t
->
mm
->
cÚ‹xt
.
vdso
 = (*)
addr
;

130 
up_ç
:

131 
	`up_wr™e
(&
mm
->
mm­_£m
);

132  
»t
;

133 
	}
}

135 
__š™
 
	$vdso_£tup
(*
s
)

137 
vdso_’abËd
 = 
	`sim¶e_¡¹oul
(
s
, 
NULL
, 0);

139 
	}
}

140 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/time.h
>

7 
	~<asm/vsysÿÎ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
è
	`ty³of
 (
__
 ## xè*cÚ¡ 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vex‹º.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<lšux/jiff›s.h
>

8 
	~<lšux/d–ay.h
>

9 
	~<lšux/š™.h
>

11 
	~<asm/timex.h
>

13 
	g´e£t_Íj
;

14 
__š™
 
	$Íj_£tup
(*
¡r
)

16 
´e£t_Íj
 = 
	`sim¶e_¡¹oul
(
¡r
,
NULL
,0);

18 
	}
}

20 
__£tup
("Íj=", 
Íj_£tup
);

22 #ifdeà
ARCH_HAS_READ_CURRENT_TIMER


29 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100è? 1 : (HZ/100))

	)

30 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

32 
__devš™
 
	$ÿlib¿‹_d–ay_dœeù
()

34 
´e_¡¬t
, 
¡¬t
, 
po¡_¡¬t
;

35 
´e_’d
, 
’d
, 
po¡_’d
;

36 
¡¬t_jiff›s
;

37 
tsc_¿‹_mš
, 
tsc_¿‹_max
;

38 
good_tsc_sum
 = 0;

39 
good_tsc_couÁ
 = 0;

40 
i
;

42 ià(
	`»ad_cu¼’t_tim”
(&
´e_¡¬t
) < 0 )

64 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

65 
´e_¡¬t
 = 0;

66 
	`»ad_cu¼’t_tim”
(&
¡¬t
);

67 
¡¬t_jiff›s
 = 
jiff›s
;

68 
jiff›s
 <ğ(
¡¬t_jiff›s
 + 1)) {

69 
´e_¡¬t
 = 
¡¬t
;

70 
	`»ad_cu¼’t_tim”
(&
¡¬t
);

72 
	`»ad_cu¼’t_tim”
(&
po¡_¡¬t
);

74 
´e_’d
 = 0;

75 
’d
 = 
po¡_¡¬t
;

76 
jiff›s
 <=

77 (
¡¬t_jiff›s
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

78 
´e_’d
 = 
’d
;

79 
	`»ad_cu¼’t_tim”
(&
’d
);

81 
	`»ad_cu¼’t_tim”
(&
po¡_’d
);

83 
tsc_¿‹_max
 = (
po¡_’d
 - 
´e_¡¬t
è/ 
DELAY_CALIBRATION_TICKS
;

84 
tsc_¿‹_mš
 = (
´e_’d
 - 
po¡_¡¬t
è/ 
DELAY_CALIBRATION_TICKS
;

90 ià(
´e_¡¬t
 !ğ0 && 
´e_’d
 != 0 &&

91 (
tsc_¿‹_max
 - 
tsc_¿‹_mš
) < (tsc_rate_max >> 3)) {

92 
good_tsc_couÁ
++;

93 
good_tsc_sum
 +ğ
tsc_¿‹_max
;

97 ià(
good_tsc_couÁ
)

98  (
good_tsc_sum
/
good_tsc_couÁ
);

100 
	`´štk
(
KERN_WARNING
 "calibrate_delay_direct() failedo get‡ good "

103 
	}
}

105 
__devš™
 
	$ÿlib¿‹_d–ay_dœeù
(è{ 0;
	}
}

113 
	#LPS_PREC
 8

	)

115 
__devš™
 
	$ÿlib¿‹_d–ay
()

117 
ticks
, 
loİb™
;

118 
Ís_´ecisiÚ
 = 
LPS_PREC
;

120 ià(
´e£t_Íj
) {

121 
loİs_³r_jiffy
 = 
´e£t_Íj
;

122 
	`´štk
("Calibrating delay†oop (skipped)... "

124 
loİs_³r_jiffy
/(500000/
HZ
),

125 (
loİs_³r_jiffy
/(5000/
HZ
)) % 100);

126 } ià((
loİs_³r_jiffy
 = 
	`ÿlib¿‹_d–ay_dœeù
()) != 0) {

127 
	`´štk
("Calibrating delay usingimer specific„outine.. ");

128 
	`´štk
("%lu.%02lu BogoMIPS (lpj=%lu)\n",

129 
loİs_³r_jiffy
/(500000/
HZ
),

130 (
loİs_³r_jiffy
/(5000/
HZ
)) % 100,

131 
loİs_³r_jiffy
);

133 
loİs_³r_jiffy
 = (1<<12);

135 
	`´štk
(
KERN_DEBUG
 "Calibrating delay†oop... ");

136 (
loİs_³r_jiffy
 <<= 1) != 0) {

138 
ticks
 = 
jiff›s
;

139 
ticks
 =ğ
jiff›s
)

142 
ticks
 = 
jiff›s
;

143 
	`__d–ay
(
loİs_³r_jiffy
);

144 
ticks
 = 
jiff›s
 -icks;

145 ià(
ticks
)

153 
loİs_³r_jiffy
 >>= 1;

154 
loİb™
 = 
loİs_³r_jiffy
;

155 
Ís_´ecisiÚ
-- && (
loİb™
 >>= 1)) {

156 
loİs_³r_jiffy
 |ğ
loİb™
;

157 
ticks
 = 
jiff›s
;

158 
ticks
 =ğ
jiff›s
)

160 
ticks
 = 
jiff›s
;

161 
	`__d–ay
(
loİs_³r_jiffy
);

162 ià(
jiff›s
 !ğ
ticks
)

163 
loİs_³r_jiffy
 &ğ~
loİb™
;

167 
	`´štk
("%lu.%02lu BogoMIPS (lpj=%lu)\n",

168 
loİs_³r_jiffy
/(500000/
HZ
),

169 (
loİs_³r_jiffy
/(5000/
HZ
)) % 100,

170 
loİs_³r_jiffy
);

173 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/ùy³.h
>

4 
	~<lšux/fd.h
>

5 
	~<lšux/‰y.h
>

6 
	~<lšux/su¥’d.h
>

7 
	~<lšux/roÙ_dev.h
>

8 
	~<lšux/£cur™y.h
>

9 
	~<lšux/d–ay.h
>

10 
	~<lšux/g’hd.h
>

11 
	~<lšux/mouÁ.h
>

12 
	~<lšux/deviû.h
>

13 
	~<lšux/š™.h
>

15 
	~<lšux/nfs_fs.h
>

16 
	~<lšux/nfs_fs_sb.h
>

17 
	~<lšux/nfs_mouÁ.h
>

19 
	~"do_mouÁs.h
"

21 
g‘_fesy¡em_li¡
(* 
buf
);

23 
__š™d©a
 
	grd_dŞßd
;

25 
	groÙ_mouÁæags
 = 
MS_RDONLY
 | 
MS_SILENT
;

26 * 
__š™d©a
 
	groÙ_deviû_Çme
;

27 
__š™d©a
 
	g§ved_roÙ_Çme
[64];

28 
__š™d©a
 
	groÙ_wa™
;

30 
dev_t
 
	gROOT_DEV
;

32 
__š™
 
	$lßd_¿mdisk
(*
¡r
)

34 
rd_dŞßd
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0) & 3;

36 
	}
}

37 
__£tup
("lßd_¿mdisk=", 
lßd_¿mdisk
);

39 
__š™
 
	$»adÚly
(*
¡r
)

41 ià(*
¡r
)

43 
roÙ_mouÁæags
 |ğ
MS_RDONLY
;

45 
	}
}

47 
__š™
 
	$»adwr™e
(*
¡r
)

49 ià(*
¡r
)

51 
roÙ_mouÁæags
 &ğ~
MS_RDONLY
;

53 
	}
}

55 
__£tup
("ro", 
»adÚly
);

56 
__£tup
("rw", 
»adwr™e
);

58 
dev_t
 
	$Œy_Çme
(*
Çme
, 
·¹
)

60 
·th
[64];

61 
buf
[32];

62 
¿nge
;

63 
dev_t
 
»s
;

64 *
s
;

65 
Ën
;

66 
fd
;

67 
maj
, 
mš
;

71 
	`¥rštf
(
·th
, "/sys/block/%s/dev", 
Çme
);

72 
fd
 = 
	`sys_İ’
(
·th
, 0, 0);

73 ià(
fd
 < 0)

74 
ç
;

75 
Ën
 = 
	`sys_»ad
(
fd
, 
buf
, 32);

76 
	`sys_şo£
(
fd
);

77 ià(
Ën
 <ğ0 ||†’ =ğ32 || 
buf
[len - 1] != '\n')

78 
ç
;

79 
buf
[
Ën
 - 1] = '\0';

80 ià(
	`ssÿnf
(
buf
, "%u:%u", &
maj
, &
mš
) == 2) {

84 
»s
 = 
	`MKDEV
(
maj
, 
mš
);

85 ià(
maj
 !ğ
	`MAJOR
(
»s
è|| 
mš
 !ğ
	`MINOR
(res))

86 
ç
;

91 
»s
 = 
	`Ãw_decode_dev
(
	`sim¶e_¡¹oul
(
buf
, &
s
, 16));

92 ià(*
s
)

93 
ç
;

97 ià(!
·¹
)

98  
»s
;

101 
	`¥rštf
(
·th
, "/sys/block/%s/¿nge", 
Çme
);

102 
fd
 = 
	`sys_İ’
(
·th
, 0, 0);

103 ià(
fd
 < 0)

104 
ç
;

105 
Ën
 = 
	`sys_»ad
(
fd
, 
buf
, 32);

106 
	`sys_şo£
(
fd
);

107 ià(
Ën
 <ğ0 ||†’ =ğ32 || 
buf
[len - 1] != '\n')

108 
ç
;

109 
buf
[
Ën
 - 1] = '\0';

110 
¿nge
 = 
	`sim¶e_¡¹oul
(
buf
, &
s
, 10);

111 ià(*
s
)

112 
ç
;

115 ià(
·¹
 < 
¿nge
)

116  
»s
 + 
·¹
;

117 
ç
:

119 
	}
}

140 
dev_t
 
	$Çme_to_dev_t
(*
Çme
)

142 
s
[32];

143 *
p
;

144 
dev_t
 
»s
 = 0;

145 
·¹
;

147 #ifdeà
CONFIG_SYSFS


148 
mkdœ_”r
 = 
	`sys_mkdœ
("/sys", 0700);

149 ià(
	`sys_mouÁ
("sysfs", "/sys", "sysfs", 0, 
NULL
) < 0)

150 
out
;

153 ià(
	`¡ºcmp
(
Çme
, "/dev/", 5) != 0) {

154 
maj
, 
mš
;

156 ià(
	`ssÿnf
(
Çme
, "%u:%u", &
maj
, &
mš
) == 2) {

157 
»s
 = 
	`MKDEV
(
maj
, 
mš
);

158 ià(
maj
 !ğ
	`MAJOR
(
»s
è|| 
mš
 !ğ
	`MINOR
(res))

159 
ç
;

161 
»s
 = 
	`Ãw_decode_dev
(
	`sim¶e_¡¹oul
(
Çme
, &
p
, 16));

162 ià(*
p
)

163 
ç
;

165 
dÚe
;

167 
Çme
 += 5;

168 
»s
 = 
RoÙ_NFS
;

169 ià(
	`¡rcmp
(
Çme
, "nfs") == 0)

170 
dÚe
;

171 
»s
 = 
RoÙ_RAM0
;

172 ià(
	`¡rcmp
(
Çme
, "ram") == 0)

173 
dÚe
;

175 ià(
	`¡¾’
(
Çme
) > 31)

176 
ç
;

177 
	`¡rıy
(
s
, 
Çme
);

178 
p
 = 
s
; *p;…++)

179 ià(*
p
 == '/')

180 *
p
 = '!';

181 
»s
 = 
	`Œy_Çme
(
s
, 0);

182 ià(
»s
)

183 
dÚe
;

185 
p
 > 
s
 && 
	`isdig™
(p[-1]))

186 
p
--;

187 ià(
p
 =ğ
s
 || !*p || *p == '0')

188 
ç
;

189 
·¹
 = 
	`sim¶e_¡¹oul
(
p
, 
NULL
, 10);

190 *
p
 = '\0';

191 
»s
 = 
	`Œy_Çme
(
s
, 
·¹
);

192 ià(
»s
)

193 
dÚe
;

195 ià(
p
 < 
s
 + 2 || !
	`isdig™
(p[-2]) ||…[-1] != 'p')

196 
ç
;

197 
p
[-1] = '\0';

198 
»s
 = 
	`Œy_Çme
(
s
, 
·¹
);

199 
dÚe
:

200 #ifdeà
CONFIG_SYSFS


201 
	`sys_umouÁ
("/sys", 0);

202 
out
:

203 ià(!
mkdœ_”r
)

204 
	`sys_rmdœ
("/sys");

206  
»s
;

207 
ç
:

208 
»s
 = 0;

209 
dÚe
;

210 
	}
}

212 
__š™
 
	$roÙ_dev_£tup
(*
lše
)

214 
	`¡¾ıy
(
§ved_roÙ_Çme
, 
lše
, (saved_root_name));

216 
	}
}

218 
__£tup
("roÙ=", 
roÙ_dev_£tup
);

220 
__š™
 
	$roÙwa™_£tup
(*
¡r
)

222 ià(*
¡r
)

224 
roÙ_wa™
 = 1;

226 
	}
}

228 
__£tup
("roÙwa™", 
roÙwa™_£tup
);

230 * 
__š™d©a
 
	groÙ_mouÁ_d©a
;

231 
__š™
 
	$roÙ_d©a_£tup
(*
¡r
)

233 
roÙ_mouÁ_d©a
 = 
¡r
;

235 
	}
}

237 * 
__š™d©a
 
	groÙ_fs_Çmes
;

238 
__š™
 
	$fs_Çmes_£tup
(*
¡r
)

240 
roÙ_fs_Çmes
 = 
¡r
;

242 
	}
}

244 
__š™d©a
 
	groÙ_d–ay
;

245 
__š™
 
	$roÙ_d–ay_£tup
(*
¡r
)

247 
roÙ_d–ay
 = 
	`sim¶e_¡¹oul
(
¡r
, 
NULL
, 0);

249 
	}
}

251 
__£tup
("roÙæags=", 
roÙ_d©a_£tup
);

252 
__£tup
("roÙf¡y³=", 
fs_Çmes_£tup
);

253 
__£tup
("roÙd–ay=", 
roÙ_d–ay_£tup
);

255 
__š™
 
	$g‘_fs_Çmes
(*
·ge
)

257 *
s
 = 
·ge
;

259 ià(
roÙ_fs_Çmes
) {

260 
	`¡rıy
(
·ge
, 
roÙ_fs_Çmes
);

261 *
s
++) {

262 ià(
s
[-1] == ',')

263 
s
[-1] = '\0';

266 
Ën
 = 
	`g‘_fesy¡em_li¡
(
·ge
);

267 *
p
, *
Ãxt
;

269 
·ge
[
Ën
] = '\0';

270 
p
 = 
·ge
-1;…;… = 
Ãxt
) {

271 
Ãxt
 = 
	`¡rchr
(++
p
, '\n');

272 ià(*
p
++ != '\t')

274 (*
s
++ = *
p
++) != '\n')

276 
s
[-1] = '\0';

279 *
s
 = '\0';

280 
	}
}

282 
__š™
 
	$do_mouÁ_roÙ
(*
Çme
, *
fs
, 
æags
, *
d©a
)

284 
”r
 = 
	`sys_mouÁ
(
Çme
, "/roÙ", 
fs
, 
æags
, 
d©a
);

285 ià(
”r
)

286  
”r
;

288 
	`sys_chdœ
("/root");

289 
ROOT_DEV
 = 
cu¼’t
->
fs
->
pwdmÁ
->
mÁ_sb
->
s_dev
;

290 
	`´štk
("VFS: Mounted„oot (%s filesystem)%s.\n",

291 
cu¼’t
->
fs
->
pwdmÁ
->
mÁ_sb
->
s_ty³
->
Çme
,

292 
cu¼’t
->
fs
->
pwdmÁ
->
mÁ_sb
->
s_æags
 & 
MS_RDONLY
 ?

295 
	}
}

297 
__š™
 
	$mouÁ_block_roÙ
(*
Çme
, 
æags
)

299 *
fs_Çmes
 = 
	`__g‘Çme
();

300 *
p
;

301 #ifdeà
CONFIG_BLOCK


302 
b
[
BDEVNAME_SIZE
];

304 cÚ¡ *
b
 = 
Çme
;

307 
	`g‘_fs_Çmes
(
fs_Çmes
);

308 
»Œy
:

309 
p
 = 
fs_Çmes
; *p;… +ğ
	`¡¾’
(p)+1) {

310 
”r
 = 
	`do_mouÁ_roÙ
(
Çme
, 
p
, 
æags
, 
roÙ_mouÁ_d©a
);

311 
”r
) {

313 
out
;

314 -
EACCES
:

315 
æags
 |ğ
MS_RDONLY
;

316 
»Œy
;

317 -
EINVAL
:

325 #ifdeà
CONFIG_BLOCK


326 
	`__bdevÇme
(
ROOT_DEV
, 
b
);

328 
	`´štk
("VFS: Cannot open„oot device \"%s\" or %s\n",

329 
roÙ_deviû_Çme
, 
b
);

330 
	`´štk
("Please‡ppend‡ correct \"root=\" boot option; here‡rehe‡vailable…artitions:\n");

332 
	`´štk_®l_·¹™iÚs
();

333 
	`·nic
("VFS: UÇbËØmouÁ„oÙ f Ú %s", 
b
);

336 
	`´štk
("List of‡ll…artitions:\n");

337 
	`´štk_®l_·¹™iÚs
();

338 
	`´štk
("No filesystem could mount„oot,ried: ");

339 
p
 = 
fs_Çmes
; *p;… +ğ
	`¡¾’
(p)+1)

340 
	`´štk
(" %s", 
p
);

341 
	`´štk
("\n");

342 #ifdeà
CONFIG_BLOCK


343 
	`__bdevÇme
(
ROOT_DEV
, 
b
);

345 
	`·nic
("VFS: UÇbËØmouÁ„oÙ f Ú %s", 
b
);

346 
out
:

347 
	`puŠame
(
fs_Çmes
);

348 
	}
}

350 #ifdeà
CONFIG_ROOT_NFS


351 
__š™
 
	$mouÁ_nfs_roÙ
()

353 *
d©a
 = 
	`nfs_roÙ_d©a
();

355 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

356 ià(
d©a
 &&

357 
	`do_mouÁ_roÙ
("/dev/roÙ", "nfs", 
roÙ_mouÁæags
, 
d©a
) == 0)

360 
	}
}

363 #ià
defšed
(
CONFIG_BLK_DEV_RAM
è|| defšed(
CONFIG_BLK_DEV_FD
)

364 
__š™
 
	$chªge_æİpy
(*
fmt
, ...)

366 
‹rmios
ermios;

367 
buf
[80];

368 
c
;

369 
fd
;

370 
va_li¡
 
¬gs
;

371 
	`va_¡¬t
(
¬gs
, 
fmt
);

372 
	`v¥rštf
(
buf
, 
fmt
, 
¬gs
);

373 
	`va_’d
(
¬gs
);

374 
fd
 = 
	`sys_İ’
("/dev/roÙ", 
O_RDWR
 | 
O_NDELAY
, 0);

375 ià(
fd
 >= 0) {

376 
	`sys_ioùl
(
fd
, 
FDEJECT
, 0);

377 
	`sys_şo£
(
fd
);

379 
	`´štk
(
KERN_NOTICE
 "VFS: In£¹ % ªd…»s ENTER\n", 
buf
);

380 
fd
 = 
	`sys_İ’
("/dev/cÚsŞe", 
O_RDWR
, 0);

381 ià(
fd
 >= 0) {

382 
	`sys_ioùl
(
fd
, 
TCGETS
, ()&
‹rmios
);

383 
‹rmios
.
c_læag
 &ğ~
ICANON
;

384 
	`sys_ioùl
(
fd
, 
TCSETSF
, ()&
‹rmios
);

385 
	`sys_»ad
(
fd
, &
c
, 1);

386 
‹rmios
.
c_læag
 |ğ
ICANON
;

387 
	`sys_ioùl
(
fd
, 
TCSETSF
, ()&
‹rmios
);

388 
	`sys_şo£
(
fd
);

390 
	}
}

393 
__š™
 
	$mouÁ_roÙ
()

395 #ifdeà
CONFIG_ROOT_NFS


396 ià(
	`MAJOR
(
ROOT_DEV
è=ğ
UNNAMED_MAJOR
) {

397 ià(
	`mouÁ_nfs_roÙ
())

400 
	`´štk
(
KERN_ERR
 "VFS: Unableo mount„oot fs via NFS,rying floppy.\n");

401 
ROOT_DEV
 = 
RoÙ_FD0
;

404 #ifdeà
CONFIG_BLK_DEV_FD


405 ià(
	`MAJOR
(
ROOT_DEV
è=ğ
FLOPPY_MAJOR
) {

407 ià(
rd_dŞßd
==2) {

408 ià(
	`rd_lßd_disk
(1)) {

409 
ROOT_DEV
 = 
RoÙ_RAM1
;

410 
roÙ_deviû_Çme
 = 
NULL
;

413 
	`chªge_æİpy
("root floppy");

416 #ifdeà
CONFIG_BLOCK


417 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

418 
	`mouÁ_block_roÙ
("/dev/roÙ", 
roÙ_mouÁæags
);

420 
	}
}

425 
__š™
 
	$´•¬e_Çme¥aû
()

427 
is_æİpy
;

429 ià(
roÙ_d–ay
) {

430 
	`´štk
(
KERN_INFO
 "Waiting %dsec before mounting„oot device...\n",

431 
roÙ_d–ay
);

432 
	`s¦“p
(
roÙ_d–ay
);

436 
	`driv”_´obe_dÚe
() != 0)

437 
	`m¦“p
(100);

439 
	`md_run_£tup
();

441 ià(
§ved_roÙ_Çme
[0]) {

442 
roÙ_deviû_Çme
 = 
§ved_roÙ_Çme
;

443 ià(!
	`¡ºcmp
(
roÙ_deviû_Çme
, "mtd", 3)) {

444 
	`mouÁ_block_roÙ
(
roÙ_deviû_Çme
, 
roÙ_mouÁæags
);

445 
out
;

447 
ROOT_DEV
 = 
	`Çme_to_dev_t
(
roÙ_deviû_Çme
);

448 ià(
	`¡ºcmp
(
roÙ_deviû_Çme
, "/dev/", 5) == 0)

449 
roÙ_deviû_Çme
 += 5;

452 ià(
	`š™rd_lßd
())

453 
out
;

456 ià((
ROOT_DEV
 =ğ0è&& 
roÙ_wa™
) {

457 
	`´štk
(
KERN_INFO
 "Waiting for„oot device %s...\n",

458 
§ved_roÙ_Çme
);

459 
	`driv”_´obe_dÚe
() != 0 ||

460 (
ROOT_DEV
 = 
	`Çme_to_dev_t
(
§ved_roÙ_Çme
)) == 0)

461 
	`m¦“p
(100);

464 
is_æİpy
 = 
	`MAJOR
(
ROOT_DEV
è=ğ
FLOPPY_MAJOR
;

466 ià(
is_æİpy
 && 
rd_dŞßd
 && 
	`rd_lßd_disk
(0))

467 
ROOT_DEV
 = 
RoÙ_RAM0
;

469 
	`mouÁ_roÙ
();

470 
out
:

471 
	`sys_mouÁ
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

472 
	`sys_chroÙ
(".");

473 
	`£cur™y_sb_po¡_mouÁroÙ
();

474 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<lšux/uni¡d.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/fs.h
>

4 
	~<lšux/mšix_fs.h
>

5 
	~<lšux/ext2_fs.h
>

6 
	~<lšux/romfs_fs.h
>

7 
	~<lšux/š™rd.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/ä“z”.h
>

11 
	~"do_mouÁs.h
"

13 
	gš™rd_¡¬t
, 
	gš™rd_’d
;

14 
	gš™rd_b–ow_¡¬t_ok
;

15 
	g»®_roÙ_dev
;

16 
__š™d©a
 
	gŞd_fd
, 
	groÙ_fd
;

17 
__š™d©a
 
	gmouÁ_š™rd
 = 1;

19 
__š™
 
	$no_š™rd
(*
¡r
)

21 
mouÁ_š™rd
 = 0;

23 
	}
}

25 
__£tup
("noš™rd", 
no_š™rd
);

27 
__š™
 
	$do_lšuxrc
(* 
sh–l
)

29 *
¬gv
[] = { "lšuxrc", 
NULL
, };

30 * 
’vp_š™
[];

32 
	`sys_şo£
(
Şd_fd
);sys_şo£(
roÙ_fd
);

33 
	`sys_şo£
(0);sys_close(1);sys_close(2);

34 
	`sys_£tsid
();

35 (è
	`sys_İ’
("/dev/cÚsŞe",
O_RDWR
,0);

36 (è
	`sys_dup
(0);

37 (è
	`sys_dup
(0);

38  
	`k”Ãl_execve
(
sh–l
, 
¬gv
, 
’vp_š™
);

39 
	}
}

41 
__š™
 
	$hªdË_š™rd
()

43 
”rÜ
;

44 
pid
;

46 
»®_roÙ_dev
 = 
	`Ãw_’code_dev
(
ROOT_DEV
);

47 
	`ü—‹_dev
("/dev/roÙ.Şd", 
RoÙ_RAM0
);

49 
	`mouÁ_block_roÙ
("/dev/roÙ.Şd", 
roÙ_mouÁæags
 & ~
MS_RDONLY
);

50 
	`sys_mkdœ
("/old", 0700);

51 
roÙ_fd
 = 
	`sys_İ’
("/", 0, 0);

52 
Şd_fd
 = 
	`sys_İ’
("/old", 0, 0);

54 
	`sys_chdœ
("/root");

55 
	`sys_mouÁ
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

56 
	`sys_chroÙ
(".");

62 
cu¼’t
->
æags
 |ğ
PF_FREEZER_SKIP
;

64 
pid
 = 
	`k”Ãl_th»ad
(
do_lšuxrc
, "/lšuxrc", 
SIGCHLD
);

65 ià(
pid
 > 0)

66 
pid
 !ğ
	`sys_wa™4
(-1, 
NULL
, 0, NULL))

67 
	`y›ld
();

69 
cu¼’t
->
æags
 &ğ~
PF_FREEZER_SKIP
;

72 
	`sys_fchdœ
(
Şd_fd
);

73 
	`sys_mouÁ
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

75 
	`sys_fchdœ
(
roÙ_fd
);

76 
	`sys_chroÙ
(".");

77 
	`sys_şo£
(
Şd_fd
);

78 
	`sys_şo£
(
roÙ_fd
);

80 ià(
	`Ãw_decode_dev
(
»®_roÙ_dev
è=ğ
RoÙ_RAM0
) {

81 
	`sys_chdœ
("/old");

85 
ROOT_DEV
 = 
	`Ãw_decode_dev
(
»®_roÙ_dev
);

86 
	`mouÁ_roÙ
();

88 
	`´štk
(
KERN_NOTICE
 "Tryingo move old„ooto /initrd ... ");

89 
”rÜ
 = 
	`sys_mouÁ
("/Şd", "/roÙ/š™rd", 
NULL
, 
MS_MOVE
, NULL);

90 ià(!
”rÜ
)

91 
	`´štk
("okay\n");

93 
fd
 = 
	`sys_İ’
("/dev/roÙ.Şd", 
O_RDWR
, 0);

94 ià(
”rÜ
 =ğ-
ENOENT
)

95 
	`´štk
("/initrd does‚otƒxist. Ignored.\n");

97 
	`´štk
("failed\n");

98 
	`´štk
(
KERN_NOTICE
 "Unmounting old„oot\n");

99 
	`sys_umouÁ
("/Şd", 
MNT_DETACH
);

100 
	`´štk
(
KERN_NOTICE
 "Tryingo free„amdisk memory ... ");

101 ià(
fd
 < 0) {

102 
”rÜ
 = 
fd
;

104 
”rÜ
 = 
	`sys_ioùl
(
fd
, 
BLKFLSBUF
, 0);

105 
	`sys_şo£
(
fd
);

107 
	`´štk
(!
”rÜ
 ? "okay\n" : "failed\n");

109 
	}
}

111 
__š™
 
	$š™rd_lßd
()

113 ià(
mouÁ_š™rd
) {

114 
	`ü—‹_dev
("/dev/¿m", 
RoÙ_RAM0
);

121 ià(
	`rd_lßd_image
("/š™rd.image"è&& 
ROOT_DEV
 !ğ
RoÙ_RAM0
) {

122 
	`sys_uÆšk
("/initrd.image");

123 
	`hªdË_š™rd
();

127 
	`sys_uÆšk
("/initrd.image");

129 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/fs.h
>

4 
	~<lšux/mšix_fs.h
>

5 
	~<lšux/ext2_fs.h
>

6 
	~<lšux/romfs_fs.h
>

7 
	~<lšux/üamfs_fs.h
>

8 
	~<lšux/š™rd.h
>

9 
	~<lšux/¡ršg.h
>

11 
	~"do_mouÁs.h
"

13 
	#BUILD_CRAMDISK


	)

15 
__š™d©a
 
	grd_´om±
 = 1;

17 
__š™
 
	$´om±_¿mdisk
(*
¡r
)

19 
rd_´om±
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0) & 1;

21 
	}
}

22 
__£tup
("´om±_¿mdisk=", 
´om±_¿mdisk
);

24 
__š™d©a
 
	grd_image_¡¬t
;

26 
__š™
 
	$¿mdisk_¡¬t_£tup
(*
¡r
)

28 
rd_image_¡¬t
 = 
	`sim¶e_¡¹Ş
(
¡r
,
NULL
,0);

30 
	}
}

31 
__£tup
("¿mdisk_¡¬t=", 
¿mdisk_¡¬t_£tup
);

33 
__š™
 
üd_lßd
(
š_fd
, 
out_fd
);

48 
__š™


49 
	$id’tify_¿mdisk_image
(
fd
, 
¡¬t_block
)

51 cÚ¡ 
size
 = 512;

52 
mšix_su³r_block
 *
mšixsb
;

53 
ext2_su³r_block
 *
ext2sb
;

54 
romfs_su³r_block
 *
romfsb
;

55 
üamfs_su³r
 *
üamfsb
;

56 
nblocks
 = -1;

57 *
buf
;

59 
buf
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

60 ià(!
buf
)

63 
mšixsb
 = (
mšix_su³r_block
 *è
buf
;

64 
ext2sb
 = (
ext2_su³r_block
 *è
buf
;

65 
romfsb
 = (
romfs_su³r_block
 *è
buf
;

66 
üamfsb
 = (
üamfs_su³r
 *è
buf
;

67 
	`mem£t
(
buf
, 0xe5, 
size
);

72 
	`sys_l£ek
(
fd
, 
¡¬t_block
 * 
BLOCK_SIZE
, 0);

73 
	`sys_»ad
(
fd
, 
buf
, 
size
);

78 ià(
buf
[0] == 037 && ((buf[1] == 0213) || (buf[1] == 0236))) {

79 
	`´štk
(
KERN_NOTICE


81 
¡¬t_block
);

82 
nblocks
 = 0;

83 
dÚe
;

87 ià(
romfsb
->
wÜd0
 =ğ
ROMSB_WORD0
 &&

88 
romfsb
->
wÜd1
 =ğ
ROMSB_WORD1
) {

89 
	`´štk
(
KERN_NOTICE


91 
¡¬t_block
);

92 
nblocks
 = (
	`Áohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

93 
dÚe
;

96 ià(
üamfsb
->
magic
 =ğ
CRAMFS_MAGIC
) {

97 
	`´štk
(
KERN_NOTICE


99 
¡¬t_block
);

100 
nblocks
 = (
üamfsb
->
size
 + 
BLOCK_SIZE
 - 1è>> 
BLOCK_SIZE_BITS
;

101 
dÚe
;

107 
	`sys_l£ek
(
fd
, (
¡¬t_block
+1è* 
BLOCK_SIZE
, 0);

108 
	`sys_»ad
(
fd
, 
buf
, 
size
);

111 ià(
mšixsb
->
s_magic
 =ğ
MINIX_SUPER_MAGIC
 ||

112 
mšixsb
->
s_magic
 =ğ
MINIX_SUPER_MAGIC2
) {

113 
	`´štk
(
KERN_NOTICE


115 
¡¬t_block
);

116 
nblocks
 = 
mšixsb
->
s_nzÚes
 << mšixsb->
s_log_zÚe_size
;

117 
dÚe
;

121 ià(
ext2sb
->
s_magic
 =ğ
	`ıu_to_Ë16
(
EXT2_SUPER_MAGIC
)) {

122 
	`´štk
(
KERN_NOTICE


124 
¡¬t_block
);

125 
nblocks
 = 
	`Ë32_to_ıu
(
ext2sb
->
s_blocks_couÁ
) <<

126 
	`Ë32_to_ıu
(
ext2sb
->
s_log_block_size
);

127 
dÚe
;

130 
	`´štk
(
KERN_NOTICE


132 
¡¬t_block
);

134 
dÚe
:

135 
	`sys_l£ek
(
fd
, 
¡¬t_block
 * 
BLOCK_SIZE
, 0);

136 
	`kä“
(
buf
);

137  
nblocks
;

138 
	}
}

140 
__š™
 
	$rd_lßd_image
(*
äom
)

142 
»s
 = 0;

143 
š_fd
, 
out_fd
;

144 
rd_blocks
, 
devblocks
;

145 
nblocks
, 
i
, 
disk
;

146 *
buf
 = 
NULL
;

147 
rÙ©e
 = 0;

148 #ià!
	`defšed
(
CONFIG_S390
è&& !defšed(
CONFIG_PPC_ISERIES
)

149 
rÙ©Ü
[4] = { '|' , '/' , '-' , '\\' };

152 
out_fd
 = 
	`sys_İ’
("/dev/¿m", 
O_RDWR
, 0);

153 ià(
out_fd
 < 0)

154 
out
;

156 
š_fd
 = 
	`sys_İ’
(
äom
, 
O_RDONLY
, 0);

157 ià(
š_fd
 < 0)

158 
noşo£_šput
;

160 
nblocks
 = 
	`id’tify_¿mdisk_image
(
š_fd
, 
rd_image_¡¬t
);

161 ià(
nblocks
 < 0)

162 
dÚe
;

164 ià(
nblocks
 == 0) {

165 #ifdeà
BUILD_CRAMDISK


166 ià(
	`üd_lßd
(
š_fd
, 
out_fd
) == 0)

167 
sucûssful_lßd
;

169 
	`´štk
(
KERN_NOTICE


173 
dÚe
;

187 ià(
	`sys_ioùl
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

188 
rd_blocks
 = 0;

190 
rd_blocks
 >>= 1;

192 ià(
nblocks
 > 
rd_blocks
) {

193 
	`´štk
("RAMDISK: imageoo big! (%dKiB/%ldKiB)\n",

194 
nblocks
, 
rd_blocks
);

195 
dÚe
;

201 ià(
	`sys_ioùl
(
š_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

202 
devblocks
 = 0;

204 
devblocks
 >>= 1;

206 ià(
	`¡rcmp
(
äom
, "/initrd.image") == 0)

207 
devblocks
 = 
nblocks
;

209 ià(
devblocks
 == 0) {

210 
	`´štk
(
KERN_ERR
 "RAMDISK: could‚ot determine device size\n");

211 
dÚe
;

214 
buf
 = 
	`km®loc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

215 ià(
buf
 == 0) {

216 
	`´štk
(
KERN_ERR
 "RAMDISK: could‚ot‡llocate buffer\n");

217 
dÚe
;

220 
	`´štk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] into„am disk... ",

221 
nblocks
, (Òblocks-1)/
devblocks
)+1,‚blocks>devblocks ? "s" : "");

222 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

223 ià(
i
 && (˜% 
devblocks
 == 0)) {

224 
	`´štk
("dÚdisk #%d.\n", 
disk
++);

225 
rÙ©e
 = 0;

226 ià(
	`sys_şo£
(
š_fd
)) {

227 
	`´štk
("Error closinghe disk.\n");

228 
noşo£_šput
;

230 
	`chªge_æİpy
("disk #%d", 
disk
);

231 
š_fd
 = 
	`sys_İ’
(
äom
, 
O_RDONLY
, 0);

232 ià(
š_fd
 < 0) {

233 
	`´štk
("Error opening disk.\n");

234 
noşo£_šput
;

236 
	`´štk
("Lßdšg disk #%d... ", 
disk
);

238 
	`sys_»ad
(
š_fd
, 
buf
, 
BLOCK_SIZE
);

239 
	`sys_wr™e
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

240 #ià!
	`defšed
(
CONFIG_S390
è&& !defšed(
CONFIG_PPC_ISERIES
)

241 ià(!(
i
 % 16)) {

242 
	`´štk
("%c\b", 
rÙ©Ü
[
rÙ©e
 & 0x3]);

243 
rÙ©e
++;

247 
	`´štk
("done.\n");

249 
sucûssful_lßd
:

250 
»s
 = 1;

251 
dÚe
:

252 
	`sys_şo£
(
š_fd
);

253 
noşo£_šput
:

254 
	`sys_şo£
(
out_fd
);

255 
out
:

256 
	`kä“
(
buf
);

257 
	`sys_uÆšk
("/dev/ram");

258  
»s
;

259 
	}
}

261 
__š™
 
	$rd_lßd_disk
(
n
)

263 ià(
rd_´om±
)

264 
	`chªge_æİpy
("root floppy disko be†oaded into RAM disk");

265 
	`ü—‹_dev
("/dev/roÙ", 
ROOT_DEV
);

266 
	`ü—‹_dev
("/dev/¿m", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

267  
	`rd_lßd_image
("/dev/root");

268 
	}
}

270 #ifdeà
BUILD_CRAMDISK


276 
	#OF
(
¬gs
è
	)
args

278 #iâdeà
memz”o


279 
	#memz”o
(
s
, 
n
è
	`mem£t
 ((s), 0, (n))

	)

282 
	tuch
;

283 
	tush
;

284 
	tulg
;

286 
	#INBUFSIZ
 4096

	)

287 
	#WSIZE
 0x8000

	)

290 
uch
 *
	gšbuf
;

291 
uch
 *
	gwšdow
;

293 
	gšsize
;

294 
	gš±r
;

295 
	goutút
;

296 
	gex™_code
;

297 
	gunz_”rÜ
;

298 
	gby‹s_out
;

299 
	güd_šfd
, 
	güd_outfd
;

301 
	#g‘_by‹
(è(
š±r
 < 
šsize
 ? 
šbuf
[š±r++] : 
	`fl_šbuf
())

	)

304 
	#As£¹
(
cÚd
,
msg
)

	)

305 
	#T¿û
(
x
)

	)

306 
	#T¿ûv
(
x
)

	)

307 
	#T¿ûvv
(
x
)

	)

308 
	#T¿ûc
(
c
,
x
)

	)

309 
	#T¿ûcv
(
c
,
x
)

	)

311 
	#STATIC
 

	)

312 
	#INIT
 
__š™


	)

314 
__š™
 
fl_šbuf
();

315 
__š™
 
æush_wšdow
();

316 
__š™
 *
m®loc
(
size_t
 
size
);

317 
__š™
 
ä“
(*
wh”e
);

318 
__š™
 
”rÜ
(*
m
);

319 
__š™
 
gz_m¬k
(**);

320 
__š™
 
gz_»Ëa£
(**);

322 
	~"../lib/šæ©e.c
"

324 
__š™
 *
	$m®loc
(
size_t
 
size
)

326  
	`km®loc
(
size
, 
GFP_KERNEL
);

327 
	}
}

329 
__š™
 
	$ä“
(*
wh”e
)

331 
	`kä“
(
wh”e
);

332 
	}
}

334 
__š™
 
	$gz_m¬k
(**
±r
)

336 
	}
}

338 
__š™
 
	$gz_»Ëa£
(**
±r
)

340 
	}
}

348 
__š™
 
	$fl_šbuf
()

350 ià(
ex™_code
)  -1;

352 
šsize
 = 
	`sys_»ad
(
üd_šfd
, 
šbuf
, 
INBUFSIZ
);

353 ià(
šsize
 == 0) {

354 
	`”rÜ
("RAMDISK:„an out of compressed data");

358 
š±r
 = 1;

360  
šbuf
[0];

361 
	}
}

367 
__š™
 
	$æush_wšdow
()

369 
ulg
 
c
 = 
üc
;

370 
n
, 
wr™‹n
;

371 
uch
 *
š
, 
ch
;

373 
wr™‹n
 = 
	`sys_wr™e
(
üd_outfd
, 
wšdow
, 
outút
);

374 ià(
wr™‹n
 !ğ
outút
 && 
unz_”rÜ
 == 0) {

375 
	`´štk
(
KERN_ERR
 "RAMDISK: incomplete write (%d != %d) %ld\n",

376 
wr™‹n
, 
outút
, 
by‹s_out
);

377 
unz_”rÜ
 = 1;

379 
š
 = 
wšdow
;

380 
n
 = 0;‚ < 
outút
;‚++) {

381 
ch
 = *
š
++;

382 
c
 = 
üc_32_b
[(()ø^ 
ch
) & 0xff] ^ (c >> 8);

384 
üc
 = 
c
;

385 
by‹s_out
 +ğ(
ulg
)
outút
;

386 
outút
 = 0;

387 
	}
}

389 
__š™
 
	$”rÜ
(*
x
)

391 
	`´štk
(
KERN_ERR
 "%s\n", 
x
);

392 
ex™_code
 = 1;

393 
unz_”rÜ
 = 1;

394 
	}
}

396 
__š™
 
	$üd_lßd
(
š_fd
, 
out_fd
)

398 
»suÉ
;

400 
šsize
 = 0;

401 
š±r
 = 0;

402 
outút
 = 0;

403 
ex™_code
 = 0;

404 
by‹s_out
 = 0;

405 
üc
 = (
ulg
)0xffffffffL;

407 
üd_šfd
 = 
š_fd
;

408 
üd_outfd
 = 
out_fd
;

409 
šbuf
 = 
	`km®loc
(
INBUFSIZ
, 
GFP_KERNEL
);

410 ià(!
šbuf
) {

411 
	`´štk
(
KERN_ERR
 "RAMDISK: Couldn't‡llocate gzip buffer\n");

414 
wšdow
 = 
	`km®loc
(
WSIZE
, 
GFP_KERNEL
);

415 ià(!
wšdow
) {

416 
	`´štk
(
KERN_ERR
 "RAMDISK: Couldn't‡llocate gzip window\n");

417 
	`kä“
(
šbuf
);

420 
	`makeüc
();

421 
»suÉ
 = 
	`gunz
();

422 ià(
unz_”rÜ
)

423 
»suÉ
 = 1;

424 
	`kä“
(
šbuf
);

425 
	`kä“
(
wšdow
);

426  
»suÉ
;

427 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/fs.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/fú.h
>

6 
	~<lšux/d–ay.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/sysÿÎs.h
>

10 
__š™d©a
 *
	gmes§ge
;

11 
__š™
 
	$”rÜ
(*
x
)

13 ià(!
mes§ge
)

14 
mes§ge
 = 
x
;

15 
	}
}

17 
__š™
 *
	$m®loc
(
size_t
 
size
)

19  
	`km®loc
(
size
, 
GFP_KERNEL
);

20 
	}
}

22 
__š™
 
	$ä“
(*
wh”e
)

24 
	`kä“
(
wh”e
);

25 
	}
}

29 
	#N_ALIGN
(
Ën
è(((Ö’è+ 1è& ~3è+ 2)

	)

31 
__š™d©a
 
	shash
 {

32 
	mšo
, 
	mmšÜ
, 
	mmajÜ
;

33 
mode_t
 
	mmode
;

34 
hash
 *
	mÃxt
;

35 
	mÇme
[
N_ALIGN
(
PATH_MAX
)];

36 } *
	gh—d
[32];

38 
šlše
 
	$hash
(
majÜ
, 
mšÜ
, 
šo
)

40 
tmp
 = 
šo
 + 
mšÜ
 + (
majÜ
 << 3);

41 
tmp
 +=mp >> 5;

42  
tmp
 & 31;

43 
	}
}

45 
__š™
 *
	$fšd_lšk
(
majÜ
, 
mšÜ
, 
šo
,

46 
mode_t
 
mode
, *
Çme
)

48 
hash
 **
p
, *
q
;

49 
p
 = 
h—d
 + 
	`hash
(
majÜ
, 
mšÜ
, 
šo
); *p;… = &(*p)->
Ãxt
) {

50 ià((*
p
)->
šo
 != ino)

52 ià((*
p
)->
mšÜ
 != minor)

54 ià((*
p
)->
majÜ
 != major)

56 ià(((*
p
)->
mode
 ^ modeè& 
S_IFMT
)

58  (*
p
)->
Çme
;

60 
q
 = (
hash
 *)
	`m®loc
((hash));

61 ià(!
q
)

62 
	`·nic
("can't‡llocate†ink hashƒntry");

63 
q
->
majÜ
 = major;

64 
q
->
mšÜ
 = minor;

65 
q
->
šo
 = ino;

66 
q
->
mode
 = mode;

67 
	`¡rıy
(
q
->
Çme
,‚ame);

68 
q
->
Ãxt
 = 
NULL
;

69 *
p
 = 
q
;

70  
NULL
;

71 
	}
}

73 
__š™
 
	$ä“_hash
()

75 
hash
 **
p
, *
q
;

76 
p
 = 
h—d
;… < head + 32;…++) {

77 *
p
) {

78 
q
 = *
p
;

79 *
p
 = 
q
->
Ãxt
;

80 
	`ä“
(
q
);

83 
	}
}

87 
__š™d©a
 
	gšo
, 
	gmajÜ
, 
	gmšÜ
, 
	gÆšk
;

88 
__š™d©a
 
mode_t
 
	gmode
;

89 
__š™d©a
 
	gbody_Ën
, 
	gÇme_Ën
;

90 
__š™d©a
 
uid_t
 
	guid
;

91 
__š™d©a
 
gid_t
 
	ggid
;

92 
__š™d©a
 
	grdev
;

94 
__š™
 
	$·r£_h—d”
(*
s
)

96 
·r£d
[12];

97 
buf
[9];

98 
i
;

100 
buf
[8] = '\0';

101 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

102 
	`memıy
(
buf
, 
s
, 8);

103 
·r£d
[
i
] = 
	`sim¶e_¡¹oul
(
buf
, 
NULL
, 16);

105 
šo
 = 
·r£d
[0];

106 
mode
 = 
·r£d
[1];

107 
uid
 = 
·r£d
[2];

108 
gid
 = 
·r£d
[3];

109 
Æšk
 = 
·r£d
[4];

110 
body_Ën
 = 
·r£d
[6];

111 
majÜ
 = 
·r£d
[7];

112 
mšÜ
 = 
·r£d
[8];

113 
rdev
 = 
	`Ãw_’code_dev
(
	`MKDEV
(
·r£d
[9],…arsed[10]));

114 
Çme_Ën
 = 
·r£d
[11];

115 
	}
}

119 
__š™d©a
 
	e¡©e
 {

120 
	mS¹
,

121 
	mCŞËù
,

122 
	mGÙH—d”
,

123 
	mSkIt
,

124 
	mGÙName
,

125 
	mCİyFe
,

126 
	mGÙSymlšk
,

127 
	mRe£t


128 } 
	g¡©e
, 
	gÃxt_¡©e
;

130 
__š™d©a
 *
	gviùim
;

131 
__š™d©a
 
	gcouÁ
;

132 
__š™d©a
 
loff_t
 
	gthis_h—d”
, 
	gÃxt_h—d”
;

134 
__š™d©a
 
	gdry_run
;

136 
šlše
 
__š™
 
	$—t
(
n
)

138 
viùim
 +ğ
n
;

139 
this_h—d”
 +ğ
n
;

140 
couÁ
 -ğ
n
;

141 
	}
}

143 
__š™d©a
 *
	gcŞËùed
;

144 
__š™d©a
 
	g»mašs
;

145 
__š™d©a
 *
	gcŞËù
;

147 
__š™
 
	$»ad_što
(*
buf
, 
size
, 
¡©e
 
Ãxt
)

149 ià(
couÁ
 >ğ
size
) {

150 
cŞËùed
 = 
viùim
;

151 
	`—t
(
size
);

152 
¡©e
 = 
Ãxt
;

154 
cŞËù
 = 
cŞËùed
 = 
buf
;

155 
»mašs
 = 
size
;

156 
Ãxt_¡©e
 = 
Ãxt
;

157 
¡©e
 = 
CŞËù
;

159 
	}
}

161 
__š™d©a
 *
	gh—d”_buf
, *
	gsymlšk_buf
, *
	gÇme_buf
;

163 
__š™
 
	$do_¡¬t
()

165 
	`»ad_što
(
h—d”_buf
, 110, 
GÙH—d”
);

167 
	}
}

169 
__š™
 
	$do_cŞËù
()

171 
n
 = 
»mašs
;

172 ià(
couÁ
 < 
n
)

173 
n
 = 
couÁ
;

174 
	`memıy
(
cŞËù
, 
viùim
, 
n
);

175 
	`—t
(
n
);

176 
cŞËù
 +ğ
n
;

177 ià((
»mašs
 -ğ
n
) != 0)

179 
¡©e
 = 
Ãxt_¡©e
;

181 
	}
}

183 
__š™
 
	$do_h—d”
()

185 ià(
	`memcmp
(
cŞËùed
, "070707", 6)==0) {

186 
	`”rÜ
("incorrect cpio method used: use -H‚ewc option");

189 ià(
	`memcmp
(
cŞËùed
, "070701", 6)) {

190 
	`”rÜ
("no cpio magic");

193 
	`·r£_h—d”
(
cŞËùed
);

194 
Ãxt_h—d”
 = 
this_h—d”
 + 
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
;

195 
Ãxt_h—d”
 = (next_header + 3) & ~3;

196 ià(
dry_run
) {

197 
	`»ad_što
(
Çme_buf
, 
	`N_ALIGN
(
Çme_Ën
), 
GÙName
);

200 
¡©e
 = 
SkIt
;

201 ià(
Çme_Ën
 <ğ0 ||‚ame_ËÀ> 
PATH_MAX
)

203 ià(
	`S_ISLNK
(
mode
)) {

204 ià(
body_Ën
 > 
PATH_MAX
)

206 
cŞËù
 = 
cŞËùed
 = 
symlšk_buf
;

207 
»mašs
 = 
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
;

208 
Ãxt_¡©e
 = 
GÙSymlšk
;

209 
¡©e
 = 
CŞËù
;

212 ià(
	`S_ISREG
(
mode
è|| !
body_Ën
)

213 
	`»ad_što
(
Çme_buf
, 
	`N_ALIGN
(
Çme_Ën
), 
GÙName
);

215 
	}
}

217 
__š™
 
	$do_sk
()

219 ià(
this_h—d”
 + 
couÁ
 < 
Ãxt_h—d”
) {

220 
	`—t
(
couÁ
);

223 
	`—t
(
Ãxt_h—d”
 - 
this_h—d”
);

224 
¡©e
 = 
Ãxt_¡©e
;

227 
	}
}

229 
__š™
 
	$do_»£t
()

231 
couÁ
 && *
viùim
 == '\0')

232 
	`—t
(1);

233 ià(
couÁ
 && (
this_h—d”
 & 3))

234 
	`”rÜ
("broken…adding");

236 
	}
}

238 
__š™
 
	$maybe_lšk
()

240 ià(
Æšk
 >= 2) {

241 *
Şd
 = 
	`fšd_lšk
(
majÜ
, 
mšÜ
, 
šo
, 
mode
, 
cŞËùed
);

242 ià(
Şd
)

243  (
	`sys_lšk
(
Şd
, 
cŞËùed
) < 0) ? -1 : 1;

246 
	}
}

248 
__š™
 
	$ş—n_·th
(*
·th
, 
mode_t
 
mode
)

250 
¡©
 
¡
;

252 ià(!
	`sys_Ãwl¡©
(
·th
, &
¡
è&& (¡.
¡_mode
^
mode
è& 
S_IFMT
) {

253 ià(
	`S_ISDIR
(
¡
.
¡_mode
))

254 
	`sys_rmdœ
(
·th
);

256 
	`sys_uÆšk
(
·th
);

258 
	}
}

260 
__š™d©a
 
	gwfd
;

262 
__š™
 
	$do_Çme
()

264 
¡©e
 = 
SkIt
;

265 
Ãxt_¡©e
 = 
Re£t
;

266 ià(
	`¡rcmp
(
cŞËùed
, "TRAILER!!!") == 0) {

267 
	`ä“_hash
();

270 ià(
dry_run
)

272 
	`ş—n_·th
(
cŞËùed
, 
mode
);

273 ià(
	`S_ISREG
(
mode
)) {

274 
ml
 = 
	`maybe_lšk
();

275 ià(
ml
 >= 0) {

276 
İ’æags
 = 
O_WRONLY
|
O_CREAT
;

277 ià(
ml
 != 1)

278 
İ’æags
 |ğ
O_TRUNC
;

279 
wfd
 = 
	`sys_İ’
(
cŞËùed
, 
İ’æags
, 
mode
);

281 ià(
wfd
 >= 0) {

282 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

283 
	`sys_fchmod
(
wfd
, 
mode
);

284 
¡©e
 = 
CİyFe
;

287 } ià(
	`S_ISDIR
(
mode
)) {

288 
	`sys_mkdœ
(
cŞËùed
, 
mode
);

289 
	`sys_chown
(
cŞËùed
, 
uid
, 
gid
);

290 
	`sys_chmod
(
cŞËùed
, 
mode
);

291 } ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode) ||

292 
	`S_ISFIFO
(
mode
è|| 
	`S_ISSOCK
(mode)) {

293 ià(
	`maybe_lšk
() == 0) {

294 
	`sys_mknod
(
cŞËùed
, 
mode
, 
rdev
);

295 
	`sys_chown
(
cŞËùed
, 
uid
, 
gid
);

296 
	`sys_chmod
(
cŞËùed
, 
mode
);

300 
	}
}

302 
__š™
 
	$do_cİy
()

304 ià(
couÁ
 >ğ
body_Ën
) {

305 
	`sys_wr™e
(
wfd
, 
viùim
, 
body_Ën
);

306 
	`sys_şo£
(
wfd
);

307 
	`—t
(
body_Ën
);

308 
¡©e
 = 
SkIt
;

311 
	`sys_wr™e
(
wfd
, 
viùim
, 
couÁ
);

312 
body_Ën
 -ğ
couÁ
;

313 
	`—t
(
couÁ
);

316 
	}
}

318 
__š™
 
	$do_symlšk
()

320 
cŞËùed
[
	`N_ALIGN
(
Çme_Ën
è+ 
body_Ën
] = '\0';

321 
	`ş—n_·th
(
cŞËùed
, 0);

322 
	`sys_symlšk
(
cŞËùed
 + 
	`N_ALIGN
(
Çme_Ën
), collected);

323 
	`sys_lchown
(
cŞËùed
, 
uid
, 
gid
);

324 
¡©e
 = 
SkIt
;

325 
Ãxt_¡©e
 = 
Re£t
;

327 
	}
}

329 
__š™d©a
 (*
aùiÚs
[])() = {

330 [
S¹
] = 
do_¡¬t
,

331 [
CŞËù
] = 
do_cŞËù
,

332 [
GÙH—d”
] = 
do_h—d”
,

333 [
SkIt
] = 
do_sk
,

334 [
GÙName
] = 
do_Çme
,

335 [
CİyFe
] = 
do_cİy
,

336 [
GÙSymlšk
] = 
do_symlšk
,

337 [
Re£t
] = 
do_»£t
,

338 
	}
};

340 
__š™
 
	$wr™e_bufãr
(*
buf
, 
Ën
)

342 
couÁ
 = 
Ën
;

343 
viùim
 = 
buf
;

345 !
aùiÚs
[
¡©e
]())

347  
Ën
 - 
couÁ
;

348 
	}
}

350 
__š™
 
	$æush_bufãr
(*
buf
, 
Ën
)

352 
wr™‹n
;

353 ià(
mes§ge
)

355 (
wr™‹n
 = 
	`wr™e_bufãr
(
buf
, 
Ën
)è<†’ && !
mes§ge
) {

356 
c
 = 
buf
[
wr™‹n
];

357 ià(
c
 == '0') {

358 
buf
 +ğ
wr™‹n
;

359 
Ën
 -ğ
wr™‹n
;

360 
¡©e
 = 
S¹
;

361 } ià(
c
 == 0) {

362 
buf
 +ğ
wr™‹n
;

363 
Ën
 -ğ
wr™‹n
;

364 
¡©e
 = 
Re£t
;

366 
	`”rÜ
("junk in compressed‡rchive");

368 
	}
}

374 
	#OF
(
¬gs
è
	)
args

376 #iâdeà
memz”o


377 
	#memz”o
(
s
, 
n
è
	`mem£t
 ((s), 0, (n))

	)

380 
	tuch
;

381 
	tush
;

382 
	tulg
;

384 
	#WSIZE
 0x8000

	)

387 
uch
 *
	gšbuf
;

388 
uch
 *
	gwšdow
;

390 
	gšsize
;

391 
	gš±r
;

392 
	goutút
;

393 
	gby‹s_out
;

395 
	#g‘_by‹
(è(
š±r
 < 
šsize
 ? 
šbuf
[š±r++] : -1)

	)

398 
	#As£¹
(
cÚd
,
msg
)

	)

399 
	#T¿û
(
x
)

	)

400 
	#T¿ûv
(
x
)

	)

401 
	#T¿ûvv
(
x
)

	)

402 
	#T¿ûc
(
c
,
x
)

	)

403 
	#T¿ûcv
(
c
,
x
)

	)

405 
	#STATIC
 

	)

406 
	#INIT
 
__š™


	)

408 
__š™
 
æush_wšdow
();

409 
__š™
 
”rÜ
(*
m
);

410 
__š™
 
gz_m¬k
(**);

411 
__š™
 
gz_»Ëa£
(**);

413 
	~"../lib/šæ©e.c
"

415 
__š™
 
	$gz_m¬k
(**
±r
)

417 
	}
}

419 
__š™
 
	$gz_»Ëa£
(**
±r
)

421 
	}
}

427 
__š™
 
	$æush_wšdow
()

429 
ulg
 
c
 = 
üc
;

430 
n
;

431 
uch
 *
š
, 
ch
;

433 
	`æush_bufãr
(
wšdow
, 
outút
);

434 
š
 = 
wšdow
;

435 
n
 = 0;‚ < 
outút
;‚++) {

436 
ch
 = *
š
++;

437 
c
 = 
üc_32_b
[(()ø^ 
ch
) & 0xff] ^ (c >> 8);

439 
üc
 = 
c
;

440 
by‹s_out
 +ğ(
ulg
)
outút
;

441 
outút
 = 0;

442 
	}
}

444 * 
__š™
 
	$uÅack_to_roÙfs
(*
buf
, 
Ën
, 
check_Úly
)

446 
wr™‹n
;

447 
dry_run
 = 
check_Úly
;

448 
h—d”_buf
 = 
	`m®loc
(110);

449 
symlšk_buf
 = 
	`m®loc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAX) + 1);

450 
Çme_buf
 = 
	`m®loc
(
	`N_ALIGN
(
PATH_MAX
));

451 
wšdow
 = 
	`m®loc
(
WSIZE
);

452 ià(!
wšdow
 || !
h—d”_buf
 || !
symlšk_buf
 || !
Çme_buf
)

453 
	`·nic
("can't‡llocate buffers");

454 
¡©e
 = 
S¹
;

455 
this_h—d”
 = 0;

456 
mes§ge
 = 
NULL
;

457 !
mes§ge
 && 
Ën
) {

458 
loff_t
 
§ved_off£t
 = 
this_h—d”
;

459 ià(*
buf
 =ğ'0' && !(
this_h—d”
 & 3)) {

460 
¡©e
 = 
S¹
;

461 
wr™‹n
 = 
	`wr™e_bufãr
(
buf
, 
Ën
);

462 
buf
 +ğ
wr™‹n
;

463 
Ën
 -ğ
wr™‹n
;

466 ià(!*
buf
) {

467 
buf
++;

468 
Ën
--;

469 
this_h—d”
++;

472 
this_h—d”
 = 0;

473 
šsize
 = 
Ën
;

474 
šbuf
 = 
buf
;

475 
š±r
 = 0;

476 
outút
 = 0;

477 
by‹s_out
 = 0;

478 
üc
 = (
ulg
)0xffffffffL;

479 
	`makeüc
();

480 
	`gunz
();

481 ià(
¡©e
 !ğ
Re£t
)

482 
	`”rÜ
("junk in gzipped‡rchive");

483 
this_h—d”
 = 
§ved_off£t
 + 
š±r
;

484 
buf
 +ğ
š±r
;

485 
Ën
 -ğ
š±r
;

487 
	`ä“
(
wšdow
);

488 
	`ä“
(
Çme_buf
);

489 
	`ä“
(
symlšk_buf
);

490 
	`ä“
(
h—d”_buf
);

491  
mes§ge
;

492 
	}
}

494 
__š™d©a
 
	gdo_»š_š™rd
;

496 
__š™
 
	$»š_š™rd_·¿m
(*
¡r
)

498 ià(*
¡r
)

500 
do_»š_š™rd
 = 1;

502 
	}
}

503 
__£tup
("»š_š™rd", 
»š_š™rd_·¿m
);

505 
__š™¿mfs_¡¬t
[], 
__š™¿mfs_’d
[];

506 #ifdeà
CONFIG_BLK_DEV_INITRD


507 
	~<lšux/š™rd.h
>

508 
	~<lšux/kexec.h
>

510 
__š™
 
	$ä“_š™rd
()

512 #ifdeà
CONFIG_KEXEC


513 
üashk_¡¬t
 = ()
	`__va
(
üashk_»s
.
¡¬t
);

514 
üashk_’d
 = ()
	`__va
(
üashk_»s
.
’d
);

516 ià(
do_»š_š™rd
)

517 
sk
;

519 #ifdeà
CONFIG_KEXEC


524 ià(
š™rd_¡¬t
 < 
üashk_’d
 && 
š™rd_’d
 > 
üashk_¡¬t
) {

529 
	`mem£t
((*)
š™rd_¡¬t
, 0, 
š™rd_’d
 - initrd_start);

530 ià(
š™rd_¡¬t
 < 
üashk_¡¬t
)

531 
	`ä“_š™rd_mem
(
š™rd_¡¬t
, 
üashk_¡¬t
);

532 ià(
š™rd_’d
 > 
üashk_’d
)

533 
	`ä“_š™rd_mem
(
üashk_’d
, 
š™rd_’d
);

536 
	`ä“_š™rd_mem
(
š™rd_¡¬t
, 
š™rd_’d
);

537 
sk
:

538 
š™rd_¡¬t
 = 0;

539 
š™rd_’d
 = 0;

540 
	}
}

544 
__š™
 
	$pİuÏ‹_roÙfs
()

546 *
”r
 = 
	`uÅack_to_roÙfs
(
__š™¿mfs_¡¬t
,

547 
__š™¿mfs_’d
 - 
__š™¿mfs_¡¬t
, 0);

548 ià(
”r
)

549 
	`·nic
(
”r
);

550 #ifdeà
CONFIG_BLK_DEV_INITRD


551 ià(
š™rd_¡¬t
) {

552 #ifdeà
CONFIG_BLK_DEV_RAM


553 
fd
;

554 
	`´štk
(
KERN_INFO
 "checking if image is initramfs...");

555 
”r
 = 
	`uÅack_to_roÙfs
((*)
š™rd_¡¬t
,

556 
š™rd_’d
 - 
š™rd_¡¬t
, 1);

557 ià(!
”r
) {

558 
	`´štk
(" it is\n");

559 
	`uÅack_to_roÙfs
((*)
š™rd_¡¬t
,

560 
š™rd_’d
 - 
š™rd_¡¬t
, 0);

561 
	`ä“_š™rd
();

564 
	`´štk
("™ i¢'ˆ(%s);†ook likª in™rd\n", 
”r
);

565 
fd
 = 
	`sys_İ’
("/š™rd.image", 
O_WRONLY
|
O_CREAT
, 0700);

566 ià(
fd
 >= 0) {

567 
	`sys_wr™e
(
fd
, (*)
š™rd_¡¬t
,

568 
š™rd_’d
 - 
š™rd_¡¬t
);

569 
	`sys_şo£
(
fd
);

570 
	`ä“_š™rd
();

573 
	`´štk
(
KERN_INFO
 "Unpacking initramfs...");

574 
”r
 = 
	`uÅack_to_roÙfs
((*)
š™rd_¡¬t
,

575 
š™rd_’d
 - 
š™rd_¡¬t
, 0);

576 ià(
”r
)

577 
	`·nic
(
”r
);

578 
	`´štk
(" done\n");

579 
	`ä“_š™rd
();

584 
	}
}

585 
roÙfs_š™ÿÎ
(
pİuÏ‹_roÙfs
);

	@/cmpt816/linux/init/main.c

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/moduË.h
>

14 
	~<lšux/´oc_fs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/sysÿÎs.h
>

17 
	~<lšux/¡ršg.h
>

18 
	~<lšux/ùy³.h
>

19 
	~<lšux/d–ay.h
>

20 
	~<lšux/ut¢ame.h
>

21 
	~<lšux/iİÜt.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/smp_lock.h
>

24 
	~<lšux/š™rd.h
>

25 
	~<lšux/hd»g.h
>

26 
	~<lšux/boÙmem.h
>

27 
	~<lšux/‰y.h
>

28 
	~<lšux/gå.h
>

29 
	~<lšux/³rıu.h
>

30 
	~<lšux/kmod.h
>

31 
	~<lšux/k”Ãl_¡©.h
>

32 
	~<lšux/¡¬t_k”Ãl.h
>

33 
	~<lšux/£cur™y.h
>

34 
	~<lšux/wÜkqueue.h
>

35 
	~<lšux/´ofe.h
>

36 
	~<lšux/rcupd©e.h
>

37 
	~<lšux/moduË·¿m.h
>

38 
	~<lšux/k®lsyms.h
>

39 
	~<lšux/wr™eback.h
>

40 
	~<lšux/ıu.h
>

41 
	~<lšux/ıu£t.h
>

42 
	~<lšux/cgroup.h
>

43 
	~<lšux/efi.h
>

44 
	~<lšux/tick.h
>

45 
	~<lšux/š‹¼u±.h
>

46 
	~<lšux/sk¡©s_k”n.h
>

47 
	~<lšux/d–ayacù.h
>

48 
	~<lšux/uni¡d.h
>

49 
	~<lšux/rm­.h
>

50 
	~<lšux/mempŞicy.h
>

51 
	~<lšux/key.h
>

52 
	~<lšux/unwšd.h
>

53 
	~<lšux/bufãr_h—d.h
>

54 
	~<lšux/debug_locks.h
>

55 
	~<lšux/lockd•.h
>

56 
	~<lšux/pid_Çme¥aû.h
>

57 
	~<lšux/deviû.h
>

58 
	~<lšux/kth»ad.h
>

59 
	~<lšux/sched.h
>

61 
	~<asm/io.h
>

62 
	~<asm/bugs.h
>

63 
	~<asm/£tup.h
>

64 
	~<asm/£ùiÚs.h
>

65 
	~<asm/ÿcheæush.h
>

67 #ifdeà
CONFIG_X86_LOCAL_APIC


68 
	~<asm/smp.h
>

76 #ià
__GNUC__
 =ğ4 && 
__GNUC_MINOR__
 =ğ1 && 
__GNUC_PATCHLEVEL__
 == 0

77 #w¬nšg 
gcc
-4.1.0 
is
 
known
 
to
 
miscompe
 
the
 
k”Ãl
. 
A
 
difã»Á
 
comp”
 
v”siÚ
 i 
»comm’ded
.

80 
k”Ãl_š™
(*);

82 
š™_IRQ
();

83 
fÜk_š™
();

84 
mÿ_š™
();

85 
sbus_š™
();

86 
sigÇls_š™
();

87 
pidhash_š™
();

88 
pidm­_š™
();

89 
´io_Œ“_š™
();

90 
¿dix_Œ“_š™
();

91 
ä“_š™mem
();

92 #ifdef 
CONFIG_ACPI


93 
aıi_—¾y_š™
();

95 
šlše
 
	$aıi_—¾y_š™
(è{ 
	}
}

97 #iâdeà
CONFIG_DEBUG_RODATA


98 
šlše
 
	$m¬k_rod©a_ro
(è{ 
	}
}

101 #ifdeà
CONFIG_TC


102 
tc_š™
();

105 
sy¡em_¡©es
 
	gsy¡em_¡©e
;

106 
EXPORT_SYMBOL
(
sy¡em_¡©e
);

111 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

112 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

114 
time_š™
();

116 (*
Ï‹_time_š™
)();

117 
	`soáœq_š™
();

120 
__š™d©a
 
boÙ_commªd_lše
[
COMMAND_LINE_SIZE
];

122 *
§ved_commªd_lše
;

124 *
¡©ic_commªd_lše
;

126 *
execu‹_commªd
;

127 *
¿mdisk_execu‹_commªd
;

129 #ifdeà
CONFIG_SMP


131 
__š™d©a
 
max_ıus
 = 
NR_CPUS
;

143 #iâdeà
CONFIG_X86_IO_APIC


144 
šlše
 
	$di§bË_ißpic_£tup
(è{
	}
};

147 
__š™
 
	$nosmp
(*
¡r
)

149 
max_ıus
 = 0;

150 
	`di§bË_ißpic_£tup
();

152 
	}
}

154 
—¾y_·¿m
("nosmp", 
nosmp
);

156 
__š™
 
	$maxıus
(*
¡r
)

158 
	`g‘_İtiÚ
(&
¡r
, &
max_ıus
);

159 ià(
max_ıus
 == 0)

160 
	`di§bË_ißpic_£tup
();

163 
	}
}

165 
—¾y_·¿m
("maxıus", 
maxıus
);

167 
	#max_ıus
 
NR_CPUS


	)

179 
	g»£t_deviûs
;

180 
EXPORT_SYMBOL
(
»£t_deviûs
);

182 
__š™
 
	$£t_»£t_deviûs
(*
¡r
)

184 
»£t_deviûs
 = 1;

186 
	}
}

188 
__£tup
("»£t_deviûs", 
£t_»£t_deviûs
);

190 * 
	g¬gv_š™
[
MAX_INIT_ARGS
+2] = { "š™", 
NULL
, };

191 * 
	g’vp_š™
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMöšux", 
NULL
, };

192 cÚ¡ *
	g·nic_Ï‹r
, *
	g·nic_·¿m
;

194 
obs_k”Ãl_·¿m
 
__£tup_¡¬t
[], 
__£tup_’d
[];

196 
__š™
 
	$obsŞ‘e_check£tup
(*
lše
)

198 
obs_k”Ãl_·¿m
 *
p
;

199 
had_—¾y_·¿m
 = 0;

201 
p
 = 
__£tup_¡¬t
;

203 
n
 = 
	`¡¾’
(
p
->
¡r
);

204 ià(!
	`¡ºcmp
(
lše
, 
p
->
¡r
, 
n
)) {

205 ià(
p
->
—¾y
) {

210 ià(
lše
[
n
] == '\0' ||†ine[n] == '=')

211 
had_—¾y_·¿m
 = 1;

212 } ià(!
p
->
£tup_func
) {

213 
	`´štk
(
KERN_WARNING
 "Parameter %s is obsolete,"

214 " ignÜed\n", 
p
->
¡r
);

216 } ià(
p
->
	`£tup_func
(
lše
 + 
n
))

219 
p
++;

220 } 
p
 < 
__£tup_’d
);

222  
had_—¾y_·¿m
;

223 
	}
}

229 
	gloİs_³r_jiffy
 = (1<<12);

231 
EXPORT_SYMBOL
(
loİs_³r_jiffy
);

233 
__š™
 
	$debug_k”Ãl
(*
¡r
)

235 ià(*
¡r
)

237 
cÚsŞe_logËv–
 = 10;

239 
	}
}

241 
__š™
 
	$qu›t_k”Ãl
(*
¡r
)

243 ià(*
¡r
)

245 
cÚsŞe_logËv–
 = 4;

247 
	}
}

249 
__£tup
("debug", 
debug_k”Ãl
);

250 
__£tup
("qu›t", 
qu›t_k”Ãl
);

252 
__š™
 
	$logËv–
(*
¡r
)

254 
	`g‘_İtiÚ
(&
¡r
, &
cÚsŞe_logËv–
);

256 
	}
}

258 
__£tup
("logËv–=", 
logËv–
);

264 
__š™
 
	$unknown_boÙİtiÚ
(*
·¿m
, *
v®
)

267 ià(
v®
) {

269 ià(
v®
 =ğ
·¿m
+
	`¡¾’
(param)+1)

270 
v®
[-1] = '=';

271 ià(
v®
 =ğ
·¿m
+
	`¡¾’
(param)+2) {

272 
v®
[-2] = '=';

273 
	`memmove
(
v®
-1, v®, 
	`¡¾’
(val)+1);

274 
v®
--;

276 
	`BUG
();

280 ià(
	`obsŞ‘e_check£tup
(
·¿m
))

287 ià(
	`¡rchr
(
·¿m
, '.'è&& (!
v®
 || strchr(param, '.') < val)) {

288 
	`´štk
(
KERN_ERR
 "UnknowÀboÙ o±iÚ `%s': ignÜšg\n", 
·¿m
);

292 ià(
·nic_Ï‹r
)

295 ià(
v®
) {

297 
i
;

298 
i
 = 0; 
’vp_š™
[i]; i++) {

299 ià(
i
 =ğ
MAX_INIT_ENVS
) {

300 
·nic_Ï‹r
 = "Too many bootƒnv vars‡t `%s'";

301 
·nic_·¿m
 = 
·¿m
;

303 ià(!
	`¡ºcmp
(
·¿m
, 
’vp_š™
[
i
], 
v®
 -…aram))

306 
’vp_š™
[
i
] = 
·¿m
;

309 
i
;

310 
i
 = 0; 
¬gv_š™
[i]; i++) {

311 ià(
i
 =ğ
MAX_INIT_ARGS
) {

312 
·nic_Ï‹r
 = "Too many boot init vars‡t `%s'";

313 
·nic_·¿m
 = 
·¿m
;

316 
¬gv_š™
[
i
] = 
·¿m
;

319 
	}
}

321 
__š™
 
	$š™_£tup
(*
¡r
)

323 
i
;

325 
execu‹_commªd
 = 
¡r
;

332 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

333 
¬gv_š™
[
i
] = 
NULL
;

335 
	}
}

336 
__£tup
("š™=", 
š™_£tup
);

338 
__š™
 
	$rdš™_£tup
(*
¡r
)

340 
i
;

342 
¿mdisk_execu‹_commªd
 = 
¡r
;

344 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

345 
¬gv_š™
[
i
] = 
NULL
;

347 
	}
}

348 
__£tup
("rdš™=", 
rdš™_£tup
);

350 #iâdeà
CONFIG_SMP


352 #ifdeà
CONFIG_X86_LOCAL_APIC


353 
__š™
 
	$smp_š™
()

355 
	`APIC_š™_unroûssÜ
();

356 
	}
}

358 
	#smp_š™
(èdØ{ } 0)

	)

361 
šlše
 
	$£tup_³r_ıu_¬—s
(è{ 
	}
}

362 
šlše
 
	$smp_´•¬e_ıus
(
maxıus
è{ 
	}
}

366 #ifdeà
__GENERIC_PER_CPU


367 
	g__³r_ıu_off£t
[
NR_CPUS
] 
	g__»ad_mo¡ly
;

369 
EXPORT_SYMBOL
(
__³r_ıu_off£t
);

371 
__š™
 
	$£tup_³r_ıu_¬—s
()

373 
size
, 
i
;

374 *
±r
;

375 
Ä_possibË_ıus
 = 
	`num_possibË_ıus
();

378 
size
 = 
	`ALIGN
(
PERCPU_ENOUGH_ROOM
, 
PAGE_SIZE
);

379 
±r
 = 
	`®loc_boÙmem_·ges
(
size
 * 
Ä_possibË_ıus
);

381 
	`fÜ_—ch_possibË_ıu
(
i
) {

382 
__³r_ıu_off£t
[
i
] = 
±r
 - 
__³r_ıu_¡¬t
;

383 
	`memıy
(
±r
, 
__³r_ıu_¡¬t
, 
__³r_ıu_’d
 - __per_cpu_start);

384 
±r
 +ğ
size
;

386 
	}
}

390 
__š™
 
	$smp_š™
()

392 
ıu
;

395 
	`fÜ_—ch_´e£Á_ıu
(
ıu
) {

396 ià(
	`num_Úlše_ıus
(è>ğ
max_ıus
)

398 ià(!
	`ıu_Úlše
(
ıu
))

399 
	`ıu_up
(
ıu
);

403 
	`´štk
(
KERN_INFO
 "Broughˆu°%ld CPUs\n", ()
	`num_Úlše_ıus
());

404 
	`smp_ıus_dÚe
(
max_ıus
);

405 
	}
}

415 
__š™
 
	$£tup_commªd_lše
(*
commªd_lše
)

417 
§ved_commªd_lše
 = 
	`®loc_boÙmem
(
	`¡¾’
 (
boÙ_commªd_lše
)+1);

418 
¡©ic_commªd_lše
 = 
	`®loc_boÙmem
(
	`¡¾’
 (
commªd_lše
)+1);

419 
	`¡rıy
 (
§ved_commªd_lše
, 
boÙ_commªd_lše
);

420 
	`¡rıy
 (
¡©ic_commªd_lše
, 
commªd_lše
);

421 
	}
}

432 
nošlše
 
__š™_»fok
 
	$»¡_š™
()

433 
	$__»Ëa£s
(
k”Ãl_lock
)

435 
pid
;

437 
	`k”Ãl_th»ad
(
k”Ãl_š™
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

438 
	`numa_deçuÉ_pŞicy
();

439 
pid
 = 
	`k”Ãl_th»ad
(
kth»add
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

440 
kth»add_sk
 = 
	`fšd_sk_by_pid
(
pid
);

441 
	`uÆock_k”Ãl
();

447 
	`š™_idË_boÙup_sk
(
cu¼’t
);

448 
	`´“m±_’abË_no_»sched
();

449 
	`scheduË
();

450 
	`´“m±_di§bË
();

453 
	`ıu_idË
();

454 
	}
}

457 
__š™
 
	$do_—¾y_·¿m
(*
·¿m
, *
v®
)

459 
obs_k”Ãl_·¿m
 *
p
;

461 
p
 = 
__£tup_¡¬t
;… < 
__£tup_’d
;…++) {

462 ià((
p
->
—¾y
 && 
	`¡rcmp
(
·¿m
,…->
¡r
) == 0) ||

463 (
	`¡rcmp
(
·¿m
, "console") == 0 &&

464 
	`¡rcmp
(
p
->
¡r
, "earlycon") == 0)

466 ià(
p
->
	`£tup_func
(
v®
) != 0)

467 
	`´štk
(
KERN_WARNING


468 "M®fÜmedƒ¬ly o±iÚ '%s'\n", 
·¿m
);

473 
	}
}

476 
__š™
 
	$·r£_—¾y_·¿m
()

478 
__š™d©a
 
dÚe
 = 0;

479 
__š™d©a
 
tmp_cmdlše
[
COMMAND_LINE_SIZE
];

481 ià(
dÚe
)

485 
	`¡¾ıy
(
tmp_cmdlše
, 
boÙ_commªd_lše
, 
COMMAND_LINE_SIZE
);

486 
	`·r£_¬gs
("—¾y o±iÚs", 
tmp_cmdlše
, 
NULL
, 0, 
do_—¾y_·¿m
);

487 
dÚe
 = 1;

488 
	}
}

494 
__š™
 
	$boÙ_ıu_š™
()

496 
ıu
 = 
	`smp_´oûssÜ_id
();

498 
	`ıu_£t
(
ıu
, 
ıu_Úlše_m­
);

499 
	`ıu_£t
(
ıu
, 
ıu_´e£Á_m­
);

500 
	`ıu_£t
(
ıu
, 
ıu_possibË_m­
);

501 
	}
}

503 
__š™
 
__©Œibu‹__
((
w—k
)è
	$smp_£tup_´oûssÜ_id
()

505 
	}
}

507 
asmlškage
 
__š™
 
	$¡¬t_k”Ãl
()

509 * 
commªd_lše
;

510 
k”Ãl_·¿m
 
__¡¬t___·¿m
[], 
__¡İ___·¿m
[];

512 
	`smp_£tup_´oûssÜ_id
();

518 
	`unwšd_š™
();

519 
	`lockd•_š™
();

520 
	`cgroup_š™_—¾y
();

522 
	`loÿl_œq_di§bË
();

523 
	`—¾y_boÙ_œqs_off
();

524 
	`—¾y_š™_œq_lock_şass
();

530 
	`lock_k”Ãl
();

531 
	`tick_š™
();

532 
	`boÙ_ıu_š™
();

533 
	`·ge_add»ss_š™
();

534 
	`´štk
(
KERN_NOTICE
);

535 
	`´štk
(
lšux_bªÃr
);

536 
	`£tup_¬ch
(&
commªd_lše
);

537 
	`£tup_commªd_lše
(
commªd_lše
);

538 
	`unwšd_£tup
();

539 
	`£tup_³r_ıu_¬—s
();

540 
	`smp_´•¬e_boÙ_ıu
();

547 
	`sched_š™
();

552 
	`´“m±_di§bË
();

553 
	`bud_®l_zÚ–i¡s
();

554 
	`·ge_®loc_š™
();

555 
	`´štk
(
KERN_NOTICE
 "K”ÃÈcommªd†še: %s\n", 
boÙ_commªd_lše
);

556 
	`·r£_—¾y_·¿m
();

557 
	`·r£_¬gs
("BoÙšg k”Ãl", 
¡©ic_commªd_lše
, 
__¡¬t___·¿m
,

558 
__¡İ___·¿m
 - 
__¡¬t___·¿m
,

559 &
unknown_boÙİtiÚ
);

560 ià(!
	`œqs_di§bËd
()) {

561 
	`´štk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

563 
	`loÿl_œq_di§bË
();

565 
	`sÜt_maš_exbË
();

566 
	`Œ­_š™
();

567 
	`rcu_š™
();

568 
	`š™_IRQ
();

569 
	`pidhash_š™
();

570 
	`š™_tim”s
();

571 
	`h¹im”s_š™
();

572 
	`soáœq_š™
();

573 
	`timek“pšg_š™
();

574 
	`time_š™
();

575 
	`´ofe_š™
();

576 ià(!
	`œqs_di§bËd
())

577 
	`´štk
("start_kernel(): bug: interrupts wereƒnabledƒarly\n");

578 
	`—¾y_boÙ_œqs_Ú
();

579 
	`loÿl_œq_’abË
();

586 
	`cÚsŞe_š™
();

587 ià(
·nic_Ï‹r
)

588 
	`·nic
(
·nic_Ï‹r
, 
·nic_·¿m
);

590 
	`lockd•_šfo
();

597 
	`lockšg_£láe¡
();

599 #ifdeà
CONFIG_BLK_DEV_INITRD


600 ià(
š™rd_¡¬t
 && !
š™rd_b–ow_¡¬t_ok
 &&

601 
š™rd_¡¬t
 < 
mš_low_pâ
 << 
PAGE_SHIFT
) {

602 
	`´štk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

603 "di§blšg it.\n",
š™rd_¡¬t
,
mš_low_pâ
 << 
PAGE_SHIFT
);

604 
š™rd_¡¬t
 = 0;

607 
	`vfs_ÿches_š™_—¾y
();

608 
	`ıu£t_š™_—¾y
();

609 
	`mem_š™
();

610 
	`kmem_ÿche_š™
();

611 
	`£tup_³r_ıu_·ge£t
();

612 
	`numa_pŞicy_š™
();

613 ià(
Ï‹_time_š™
)

614 
	`Ï‹_time_š™
();

615 
	`ÿlib¿‹_d–ay
();

616 
	`pidm­_š™
();

617 
	`pgbË_ÿche_š™
();

618 
	`´io_Œ“_š™
();

619 
	`ªÚ_vma_š™
();

620 #ifdeà
CONFIG_X86


621 ià(
efi_’abËd
)

622 
	`efi_’‹r_vœtu®_mode
();

624 
	`fÜk_š™
(
num_phy¥ages
);

625 
	`´oc_ÿches_š™
();

626 
	`bufãr_š™
();

627 
	`uÂamed_dev_š™
();

628 
	`key_š™
();

629 
	`£cur™y_š™
();

630 
	`vfs_ÿches_š™
(
num_phy¥ages
);

631 
	`¿dix_Œ“_š™
();

632 
	`sigÇls_š™
();

634 
	`·ge_wr™eback_š™
();

635 #ifdeà
CONFIG_PROC_FS


636 
	`´oc_roÙ_š™
();

638 
	`cgroup_š™
();

639 
	`ıu£t_š™
();

640 
	`sk¡©s_š™_—¾y
();

641 
	`d–ayacù_š™
();

643 
	`check_bugs
();

645 
	`aıi_—¾y_š™
();

648 
	`»¡_š™
();

649 
	}
}

651 
__š™d©a
 
	gš™ÿÎ_debug
;

653 
__š™
 
	$š™ÿÎ_debug_£tup
(*
¡r
)

655 
š™ÿÎ_debug
 = 1;

657 
	}
}

658 
__£tup
("š™ÿÎ_debug", 
š™ÿÎ_debug_£tup
);

660 
š™ÿÎ_t
 
__š™ÿÎ_¡¬t
[], 
__š™ÿÎ_’d
[];

662 
__š™
 
	$do_š™ÿÎs
()

664 
š™ÿÎ_t
 *
ÿÎ
;

665 
couÁ
 = 
	`´“m±_couÁ
();

667 
ÿÎ
 = 
__š™ÿÎ_¡¬t
; c®È< 
__š™ÿÎ_’d
; call++) {

668 
ktime_t
 
t0
, 
t1
, 
d–
;

669 *
msg
 = 
NULL
;

670 
msgbuf
[40];

671 
»suÉ
;

673 ià(
š™ÿÎ_debug
) {

674 
	`´štk
("C®lšg in™ÿÎ 0x%p", *
ÿÎ
);

675 
	`´št_â_desütÜ_symbŞ
(": %s()",

676 (è*
ÿÎ
);

677 
	`´štk
("\n");

678 
t0
 = 
	`ktime_g‘
();

681 
»suÉ
 = (*
ÿÎ
)();

683 ià(
š™ÿÎ_debug
) {

684 
t1
 = 
	`ktime_g‘
();

685 
d–
 = 
	`ktime_sub
(
t1
, 
t0
);

687 
	`´štk
("š™ÿÎ 0x%p", *
ÿÎ
);

688 
	`´št_â_desütÜ_symbŞ
(": %s()",

689 (è*
ÿÎ
);

690 
	`´štk
("„‘uºed %d.\n", 
»suÉ
);

692 
	`´štk
("initcall 0x%p„an for %Ld msecs: ",

693 *
ÿÎ
, ()
d–
.
tv64
 >> 20);

694 
	`´št_â_desütÜ_symbŞ
("%s()\n",

695 (è*
ÿÎ
);

698 ià(
»suÉ
 &&„esuÉ !ğ-
ENODEV
 && 
š™ÿÎ_debug
) {

699 
	`¥rštf
(
msgbuf
, "”rÜ cod%d", 
»suÉ
);

700 
msg
 = 
msgbuf
;

702 ià(
	`´“m±_couÁ
(è!ğ
couÁ
) {

703 
msg
 = "preemption imbalance";

704 
	`´“m±_couÁ
(èğ
couÁ
;

706 ià(
	`œqs_di§bËd
()) {

707 
msg
 = "disabled interrupts";

708 
	`loÿl_œq_’abË
();

710 ià(
msg
) {

711 
	`´štk
(
KERN_WARNING
 "š™ÿÎ‡ˆ0x%p", *
ÿÎ
);

712 
	`´št_â_desütÜ_symbŞ
(": %s()",

713 (è*
ÿÎ
);

714 
	`´štk
(":„‘uºed w™h %s\n", 
msg
);

719 
	`æush_scheduËd_wÜk
();

720 
	}
}

729 
__š™
 
	$do_basic_£tup
()

732 
	`š™_wÜkqueues
();

733 
	`u£rmodeh–³r_š™
();

734 
	`driv”_š™
();

735 
	`š™_œq_´oc
();

736 
	`do_š™ÿÎs
();

737 
	}
}

739 
__š™d©a
 
	gnosoálockup
;

741 
__š™
 
	$nosoálockup_£tup
(*
¡r
)

743 
nosoálockup
 = 1;

745 
	}
}

746 
__£tup
("nosoálockup", 
nosoálockup_£tup
);

748 
__š™
 
	$do_´e_smp_š™ÿÎs
()

750 
	`¥awn_ksoáœqd
();

752 
	`mig¿tiÚ_š™
();

753 
	`¥awn_ksoáœqd
();

754 ià(!
nosoálockup
)

755 
	`¥awn_soálockup_sk
();

756 
	}
}

758 
	$run_š™_´oûss
(*
š™_f’ame
)

760 
¬gv_š™
[0] = 
š™_f’ame
;

761 
	`k”Ãl_execve
(
š™_f’ame
, 
¬gv_š™
, 
’vp_š™
);

762 
	}
}

767 
nošlše
 
	$š™_po¡
()

769 
	`ä“_š™mem
();

770 
	`uÆock_k”Ãl
();

771 
	`m¬k_rod©a_ro
();

772 
sy¡em_¡©e
 = 
SYSTEM_RUNNING
;

773 
	`numa_deçuÉ_pŞicy
();

775 ià(
	`sys_İ’
((cÚ¡ 
__u£r
 *è"/dev/cÚsŞe", 
O_RDWR
, 0) < 0)

776 
	`´štk
(
KERN_WARNING
 "Warning: unableo open‡n initial console.\n");

778 (è
	`sys_dup
(0);

779 (è
	`sys_dup
(0);

781 ià(
¿mdisk_execu‹_commªd
) {

782 
	`run_š™_´oûss
(
¿mdisk_execu‹_commªd
);

783 
	`´štk
(
KERN_WARNING
 "Failedoƒxecute %s\n",

784 
¿mdisk_execu‹_commªd
);

793 ià(
execu‹_commªd
) {

794 
	`run_š™_´oûss
(
execu‹_commªd
);

795 
	`´štk
(
KERN_WARNING
 "Failedoƒxecute %s. Attempting "

796 "deçuÉs...\n", 
execu‹_commªd
);

798 
	`run_š™_´oûss
("/sbin/init");

799 
	`run_š™_´oûss
("/etc/init");

800 
	`run_š™_´oûss
("/bin/init");

801 
	`run_š™_´oûss
("/bin/sh");

803 
	`·nic
("No init found. Try…assing init= optiono kernel.");

804 
	}
}

806 
__š™
 
	$k”Ãl_š™
(* 
unu£d
)

808 
	`lock_k”Ãl
();

812 
	`£t_ıus_®lowed
(
cu¼’t
, 
CPU_MASK_ALL
);

821 
š™_pid_ns
.
chd_»­”
 = 
cu¼’t
;

823 
	`__£t_¥ecŸl_pids
(1, 1);

824 
ÿd_pid
 = 
	`sk_pid
(
cu¼’t
);

826 
	`smp_´•¬e_ıus
(
max_ıus
);

828 
	`do_´e_smp_š™ÿÎs
();

830 
	`smp_š™
();

831 
	`sched_š™_smp
();

833 
	`ıu£t_š™_smp
();

835 
	`do_basic_£tup
();

842 ià(!
¿mdisk_execu‹_commªd
)

843 
¿mdisk_execu‹_commªd
 = "/init";

845 ià(
	`sys_acûss
((cÚ¡ 
__u£r
 *è
¿mdisk_execu‹_commªd
, 0) != 0) {

846 
¿mdisk_execu‹_commªd
 = 
NULL
;

847 
	`´•¬e_Çme¥aû
();

855 
	`š™_po¡
();

857 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<lšux/compe.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/uts.h
>

12 
	~<lšux/ut¢ame.h
>

13 
	~<lšux/ut¤–—£.h
>

14 
	~<lšux/v”siÚ.h
>

16 
	#v”siÚ
(
a
è
V”siÚ_
 ## 
	)
a

17 
	#v”siÚ_¡ršg
(
a
è
	`v”siÚ
×)

	)

19 
v”siÚ_¡ršg
(
LINUX_VERSION_CODE
);

21 
uts_Çme¥aû
 
	gš™_uts_ns
 = {

22 .
k»f
 = {

23 .
»fcouÁ
 = 
ATOMIC_INIT
(2),

25 .
	gÇme
 = {

26 .
sy¢ame
 = 
UTS_SYSNAME
,

27 .
	gnod’ame
 = 
UTS_NODENAME
,

28 .
	g»Ëa£
 = 
UTS_RELEASE
,

29 .
	gv”siÚ
 = 
UTS_VERSION
,

30 .
	gmachše
 = 
UTS_MACHINE
,

31 .
	gdomašÇme
 = 
UTS_DOMAINNAME
,

34 
EXPORT_SYMBOL_GPL
(
š™_uts_ns
);

37 cÚ¡ 
	glšux_bªÃr
[] =

38 "Lšux v”siÚ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

39 
LINUX_COMPILE_HOST
 "è(" 
LINUX_COMPILER
 "è" 
UTS_VERSION
 "\n";

41 cÚ¡ 
	glšux_´oc_bªÃr
[] =

43 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

44 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
92
3935
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/processor.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep_64.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/powernow-k8.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel_64.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/state.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/e820_64.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/genapic_64.c
/cmpt816/linux/arch/x86/kernel/genapic_flat_64.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/i387_64.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259_64.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_apic_64.c
/cmpt816/linux/arch/x86/kernel/ioport_64.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kprobes_64.c
/cmpt816/linux/arch/x86/kernel/ldt_64.c
/cmpt816/linux/arch/x86/kernel/module_64.c
/cmpt816/linux/arch/x86/kernel/mpparse_64.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/nmi_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma_64.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu_64.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb_64.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace_64.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot_64.c
/cmpt816/linux/arch/x86/kernel/setup64.c
/cmpt816/linux/arch/x86/kernel/setup_64.c
/cmpt816/linux/arch/x86/kernel/signal_64.c
/cmpt816/linux/arch/x86/kernel/smp_64.c
/cmpt816/linux/arch/x86/kernel/smpboot_64.c
/cmpt816/linux/arch/x86/kernel/suspend_64.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/time_64.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/traps_64.c
/cmpt816/linux/arch/x86/kernel/tsc_64.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/mm/extable_64.c
/cmpt816/linux/arch/x86/mm/fault_64.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap_64.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap_64.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr_64.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
