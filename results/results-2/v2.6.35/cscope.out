cscope 15 /cmpt816/data -q 0000011227 0001412637
	@/cmpt816/linux/arch/x86/ia32/audit.c

1 
	~<asm/uni°d_32.h
>

3 
	gü32_dú_˛ass
[] = {

4 
	~<asm-gíîic/audô_dú_wrôe.h
>

8 
	gü32_ch©å_˛ass
[] = {

9 
	~<asm-gíîic/audô_ch™ge_©å.h
>

13 
	gü32_wrôe_˛ass
[] = {

14 
	~<asm-gíîic/audô_wrôe.h
>

18 
	gü32_ªad_˛ass
[] = {

19 
	~<asm-gíîic/audô_ªad.h
>

23 
	gü32_sig«l_˛ass
[] = {

24 
	~<asm-gíîic/audô_sig«l.h
>

28 
	$ü32_˛assify_sysˇŒ
(
sysˇŒ
)

30 
sysˇŒ
) {

31 
__NR_›í
:

33 
__NR_›í©
:

35 
__NR_sockëˇŒ
:

37 
__NR_execve
:

42 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ia32_signal.c

11 
	~<löux/sched.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/uni°d.h
>

20 
	~<löux/°ddef.h
>

21 
	~<löux/≥rs⁄Æôy.h
>

22 
	~<löux/com∑t.h
>

23 
	~<löux/böfmts.h
>

24 
	~<asm/uc⁄ãxt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/±ø˚.h
>

28 
	~<asm/ü32_uni°d.h
>

29 
	~<asm/u£r32.h
>

30 
	~<asm/sigc⁄ãxt32.h
>

31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/vdso.h
>

33 
	~<asm/sig‰ame.h
>

34 
	~<asm/sys_ü32.h
>

36 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

38 
	#FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

39 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

40 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

41 
X86_EFLAGS_CF
)

	)

43 
sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
);

45 
	$c›y_sigöfo_to_u£r32
(
com∑t_sigöfo_t
 
__u£r
 *
to
, 
sigöfo_t
 *
‰om
)

47 
îr
 = 0;

49 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
to
, (
com∑t_sigöfo_t
)))

50  -
EFAULT
;

52 
put_u£r_åy
 {

58 
	`put_u£r_ex
(
‰om
->
si_signo
, &
to
->si_signo);

59 
	`put_u£r_ex
(
‰om
->
si_î∫o
, &
to
->si_errno);

60 
	`put_u£r_ex
(()
‰om
->
si_code
, &
to
->si_code);

62 i‡(
‰om
->
si_code
 < 0) {

63 
	`put_u£r_ex
(
‰om
->
si_pid
, &
to
->si_pid);

64 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

65 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
), &
to
->si_ptr);

71 
	`put_u£r_ex
(
‰om
->
_sifõlds
.
_∑d
[0],

72 &
to
->
_sifõlds
.
_∑d
[0]);

73 
‰om
->
si_code
 >> 16) {

74 
__SI_FAULT
 >> 16:

76 
__SI_CHLD
 >> 16:

77 
	`put_u£r_ex
(
‰om
->
si_utime
, &
to
->si_utime);

78 
	`put_u£r_ex
(
‰om
->
si_°ime
, &
to
->si_stime);

79 
	`put_u£r_ex
(
‰om
->
si_°©us
, &
to
->si_status);

82 
__SI_KILL
 >> 16:

83 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

85 
__SI_POLL
 >> 16:

86 
	`put_u£r_ex
(
‰om
->
si_fd
, &
to
->si_fd);

88 
__SI_TIMER
 >> 16:

89 
	`put_u£r_ex
(
‰om
->
si_ovîrun
, &
to
->si_overrun);

90 
	`put_u£r_ex
(
	`±r_to_com∑t
(
‰om
->
si_±r
),

91 &
to
->
si_±r
);

94 
__SI_RT
 >> 16:

95 
__SI_MESGQ
 >> 16:

96 
	`put_u£r_ex
(
‰om
->
si_uid
, &
to
->si_uid);

97 
	`put_u£r_ex
(
‰om
->
si_öt
, &
to
->si_int);

101 } 
	`put_u£r_ˇtch
(
îr
);

103  
îr
;

104 
	}
}

106 
	$c›y_sigöfo_‰om_u£r32
(
sigöfo_t
 *
to
, 
com∑t_sigöfo_t
 
__u£r
 *
‰om
)

108 
îr
 = 0;

109 
u32
 
±r32
;

111 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰om
, (
com∑t_sigöfo_t
)))

112  -
EFAULT
;

114 
gë_u£r_åy
 {

115 
	`gë_u£r_ex
(
to
->
si_signo
, &
‰om
->si_signo);

116 
	`gë_u£r_ex
(
to
->
si_î∫o
, &
‰om
->si_errno);

117 
	`gë_u£r_ex
(
to
->
si_code
, &
‰om
->si_code);

119 
	`gë_u£r_ex
(
to
->
si_pid
, &
‰om
->si_pid);

120 
	`gë_u£r_ex
(
to
->
si_uid
, &
‰om
->si_uid);

121 
	`gë_u£r_ex
(
±r32
, &
‰om
->
si_±r
);

122 
to
->
si_±r
 = 
	`com∑t_±r
(
±r32
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

128 
asmlökage
 
	$sys32_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

130 
mask
 &
_BLOCKABLE
;

131 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

132 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

133 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

134 
	`ªˇlc_sig≥ndög
();

135 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

137 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

138 
	`scheduÀ
();

139 
	`£t_ª°‹e_sigmask
();

140  -
ERESTARTNOHAND
;

141 
	}
}

143 
asmlökage
 
	$sys32_sigÆt°ack
(c⁄° 
°ack_ü32_t
 
__u£r
 *
uss_±r
,

144 
°ack_ü32_t
 
__u£r
 *
uoss_±r
,

145 
±_ªgs
 *
ªgs
)

147 
°ack_t
 
uss
, 
uoss
;

148 
ªt
, 
îr
 = 0;

149 
mm_£gmít_t
 
£g
;

151 i‡(
uss_±r
) {

152 
u32
 
±r
;

154 
	`mem£t
(&
uss
, 0, (
°ack_t
));

155 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
uss_±r
, (
°ack_ü32_t
)))

156  -
EFAULT
;

158 
gë_u£r_åy
 {

159 
	`gë_u£r_ex
(
±r
, &
uss_±r
->
ss_•
);

160 
	`gë_u£r_ex
(
uss
.
ss_Êags
, &
uss_±r
->ss_flags);

161 
	`gë_u£r_ex
(
uss
.
ss_size
, &
uss_±r
->ss_size);

162 } 
	`gë_u£r_ˇtch
(
îr
);

164 i‡(
îr
)

165  -
EFAULT
;

166 
uss
.
ss_•
 = 
	`com∑t_±r
(
±r
);

168 
£g
 = 
	`gë_fs
();

169 
	`£t_fs
(
KERNEL_DS
);

170 
ªt
 = 
	`do_sigÆt°ack
(
uss_±r
 ? &
uss
 : 
NULL
, &
uoss
, 
ªgs
->
•
);

171 
	`£t_fs
(
£g
);

172 i‡(
ªt
 >0 && 
uoss_±r
) {

173 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss_±r
, (
°ack_ü32_t
)))

174  -
EFAULT
;

176 
put_u£r_åy
 {

177 
	`put_u£r_ex
(
	`±r_to_com∑t
(
uoss
.
ss_•
), &
uoss_±r
->ss_sp);

178 
	`put_u£r_ex
(
uoss
.
ss_Êags
, &
uoss_±r
->ss_flags);

179 
	`put_u£r_ex
(
uoss
.
ss_size
, &
uoss_±r
->ss_size);

180 } 
	`put_u£r_ˇtch
(
îr
);

182 i‡(
îr
)

183 
ªt
 = -
EFAULT
;

185  
ªt
;

186 
	}
}

191 
	#lﬂd£gmít_gs
(
v
Ë
	`lﬂd_gs_ödex
(v)

	)

192 
	#lﬂd£gmít_fs
(
v
Ë
	`lﬂd£gmít
(
fs
, v)

	)

193 
	#lﬂd£gmít_ds
(
v
Ë
	`lﬂd£gmít
(
ds
, v)

	)

194 
	#lﬂd£gmít_es
(
v
Ë
	`lﬂd£gmít
(
es
, v)

	)

196 
	#gë_u£r_£g
(
£g
Ë({ 
v
; 
	`ßve£gmít
(£g, v); v; })

	)

197 
	#£t_u£r_£g
(
£g
, 
v
Ë
lﬂd£gmít_
##
	`£g
(v)

	)

199 
	#COPY
(
x
) { \

200 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

201 }

	)

203 
	#GET_SEG
(
£g
) ({ \

204 
tmp
; \

205 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

206 
tmp
; \

207 })

	)

209 
	#COPY_SEG_CPL3
(
£g
) do { \

210 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

211 } 0)

	)

213 
	#RELOAD_SEG
(
£g
) { \

214 
¥e
 = 
	`GET_SEG
(
£g
); \

215 
cur
 = 
	`gë_u£r_£g
(
£g
); \

216 
¥e
 |= 3; \

217 i‡(
¥e
 !
cur
) \

218 
	`£t_u£r_£g
(
£g
, 
¥e
); \

219 }

	)

221 
	$ü32_ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
,

222 
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

223 *
∑x
)

225 
tmpÊags
, 
îr
 = 0;

226 
__u£r
 *
buf
;

227 
u32
 
tmp
;

230 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

232 
gë_u£r_åy
 {

239 
	`RELOAD_SEG
(
gs
);

240 
	`RELOAD_SEG
(
fs
);

241 
	`RELOAD_SEG
(
ds
);

242 
	`RELOAD_SEG
(
es
);

244 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

245 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

248 
	`COPY_SEG_CPL3
(
cs
);

249 
	`COPY_SEG_CPL3
(
ss
);

251 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

252 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

254 
ªgs
->
‹ig_ax
 = -1;

256 
	`gë_u£r_ex
(
tmp
, &
sc
->
Â°©e
);

257 
buf
 = 
	`com∑t_±r
(
tmp
);

258 
îr
 |
	`ª°‹e_i387_x°©e_ü32
(
buf
);

260 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

261 } 
	`gë_u£r_ˇtch
(
îr
);

263  
îr
;

264 
	}
}

266 
asmlökage
 
	$sys32_sigªtu∫
(
±_ªgs
 *
ªgs
)

268 
sig‰ame_ü32
 
__u£r
 *
‰ame
 = (sig‰ame_ü32 __u£∏*)(
ªgs
->
•
-8);

269 
sig£t_t
 
£t
;

270 
ax
;

272 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

273 
bad‰ame
;

274 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
)

275 || (
_COMPAT_NSIG_WORDS
 > 1

276 && 
	`__c›y_‰om_u£r
((((*Ë&
£t
.
sig
) + 4),

277 &
‰ame
->
exåamask
,

278 (
‰ame
->
exåamask
))))

279 
bad‰ame
;

281 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

282 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

283 
cuºít
->
blocked
 = 
£t
;

284 
	`ªˇlc_sig≥ndög
();

285 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

287 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

288 
bad‰ame
;

289  
ax
;

291 
bad‰ame
:

292 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bit sigreturn");

294 
	}
}

296 
asmlökage
 
	$sys32_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

299 
sig£t_t
 
£t
;

300 
ax
;

301 
±_ªgs
 
åegs
;

303 
‰ame
 = (
π_sig‰ame_ü32
 
__u£r
 *)(
ªgs
->
•
 - 4);

305 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

306 
bad‰ame
;

307 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

308 
bad‰ame
;

310 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

311 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

312 
cuºít
->
blocked
 = 
£t
;

313 
	`ªˇlc_sig≥ndög
();

314 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

316 i‡(
	`ü32_ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

317 
bad‰ame
;

319 
åegs
 = *
ªgs
;

320 i‡(
	`sys32_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, &
åegs
Ë=-
EFAULT
)

321 
bad‰ame
;

323  
ax
;

325 
bad‰ame
:

326 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "32bitÑt sigreturn");

328 
	}
}

334 
	$ü32_£tup_sigc⁄ãxt
(
sigc⁄ãxt_ü32
 
__u£r
 *
sc
,

335 
__u£r
 *
Â°©e
,

336 
±_ªgs
 *
ªgs
, 
mask
)

338 
îr
 = 0;

340 
put_u£r_åy
 {

341 
	`put_u£r_ex
(
	`gë_u£r_£g
(
gs
), (
__u£r
 *)&
sc
->gs);

342 
	`put_u£r_ex
(
	`gë_u£r_£g
(
fs
), (
__u£r
 *)&
sc
->fs);

343 
	`put_u£r_ex
(
	`gë_u£r_£g
(
ds
), (
__u£r
 *)&
sc
->ds);

344 
	`put_u£r_ex
(
	`gë_u£r_£g
(
es
), (
__u£r
 *)&
sc
->es);

346 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

347 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

348 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

349 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

350 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

351 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

352 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

353 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

354 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

355 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

356 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

357 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

358 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

359 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

360 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

362 
	`put_u£r_ex
(
	`±r_to_com∑t
(
Â°©e
), &
sc
->fpstate);

365 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

366 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

367 } 
	`put_u£r_ˇtch
(
îr
);

369  
îr
;

370 
	}
}

375 
__u£r
 *
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
,

376 
size_t
 
‰ame_size
,

377 **
Â°©e
)

379 
•
;

382 
•
 = 
ªgs
->sp;

385 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

386 i‡(
	`ßs_ss_Êags
(
•
) == 0)

387 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

391 i‡((
ªgs
->
ss
 & 0xffffË!
__USER32_DS
 &&

392 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

393 
ka
->
ß
.
ß_ª°‹î
)

394 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

396 i‡(
	`u£d_m©h
()) {

397 
•
 = s∞- 
sig_x°©e_ü32_size
;

398 *
Â°©e
 = (
_Â°©e_ü32
 *Ë
•
;

399 i‡(
	`ßve_i387_x°©e_ü32
(*
Â°©e
) < 0)

400  (
__u£r
 *) -1L;

403 
•
 -
‰ame_size
;

406 
•
 = ((sp + 4) & -16ul) - 4;

407  (
__u£r
 *Ë
•
;

408 
	}
}

410 
	$ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

411 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

413 
sig‰ame_ü32
 
__u£r
 *
‰ame
;

414 
__u£r
 *
ª°‹î
;

415 
îr
 = 0;

416 
__u£r
 *
Â°©e
 = 
NULL
;

420 
u16
 
p›lmovl
;

421 
u32
 
vÆ
;

422 
u16
 
öt80
;

423 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

425 
__NR_ü32_sigªtu∫
,

429 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

431 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

432  -
EFAULT
;

434 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

435  -
EFAULT
;

437 i‡(
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

438  -
EFAULT
;

440 i‡(
_COMPAT_NSIG_WORDS
 > 1) {

441 i‡(
	`__c›y_to_u£r
(
‰ame
->
exåamask
, &
£t
->
sig
[1],

442 (
‰ame
->
exåamask
)))

443  -
EFAULT
;

446 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

447 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

450 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

451 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

452 
sigªtu∫
);

454 
ª°‹î
 = &
‰ame
->
ªtcode
;

457 
put_u£r_åy
 {

458 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

464 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

465 } 
	`put_u£r_ˇtch
(
îr
);

467 i‡(
îr
)

468  -
EFAULT
;

471 
ªgs
->
•
 = (Ë
‰ame
;

472 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

475 
ªgs
->
ax
 = 
sig
;

476 
ªgs
->
dx
 = 0;

477 
ªgs
->
cx
 = 0;

479 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

480 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

482 
ªgs
->
cs
 = 
__USER32_CS
;

483 
ªgs
->
ss
 = 
__USER32_DS
;

486 
	}
}

488 
	$ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

489 
com∑t_sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

491 
π_sig‰ame_ü32
 
__u£r
 *
‰ame
;

492 
__u£r
 *
ª°‹î
;

493 
îr
 = 0;

494 
__u£r
 *
Â°©e
 = 
NULL
;

498 
u8
 
movl
;

499 
u32
 
vÆ
;

500 
u16
 
öt80
;

501 
u8
 
∑d
;

502 } 
	`__©åibuã__
((
∑cked
)Ë
code
 = {

504 
__NR_ü32_π_sigªtu∫
,

509 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

511 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

512  -
EFAULT
;

514 
put_u£r_åy
 {

515 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

516 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
öfo
), &‰ame->
pöfo
);

517 
	`put_u£r_ex
(
	`±r_to_com∑t
(&
‰ame
->
uc
), &‰ame->
puc
);

518 
îr
 |
	`c›y_sigöfo_to_u£r32
(&
‰ame
->
öfo
, info);

521 i‡(
˝u_has_xßve
)

522 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

524 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

525 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

526 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

527 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

528 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

529 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

530 
îr
 |
	`ü32_£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

531 
ªgs
, 
£t
->
sig
[0]);

532 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

534 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

535 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

537 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
,

538 
π_sigªtu∫
);

539 
	`put_u£r_ex
(
	`±r_to_com∑t
(
ª°‹î
), &
‰ame
->
¥ëcode
);

545 
	`put_u£r_ex
(*((
u64
 *)&
code
), (u64 *)
‰ame
->
ªtcode
);

546 } 
	`put_u£r_ˇtch
(
îr
);

548 i‡(
îr
)

549  -
EFAULT
;

552 
ªgs
->
•
 = (Ë
‰ame
;

553 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

556 
ªgs
->
ax
 = 
sig
;

557 
ªgs
->
dx
 = (Ë&
‰ame
->
öfo
;

558 
ªgs
->
cx
 = (Ë&
‰ame
->
uc
;

560 
	`lﬂd£gmít
(
ds
, 
__USER32_DS
);

561 
	`lﬂd£gmít
(
es
, 
__USER32_DS
);

563 
ªgs
->
cs
 = 
__USER32_CS
;

564 
ªgs
->
ss
 = 
__USER32_DS
;

567 
	}
}

	@/cmpt816/linux/arch/x86/ia32/ipc32.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/•ölock.h
>

3 
	~<löux/li°.h
>

4 
	~<löux/sysˇŒs.h
>

5 
	~<löux/time.h
>

6 
	~<löux/£m.h
>

7 
	~<löux/msg.h
>

8 
	~<löux/shm.h
>

9 
	~<löux/ùc.h
>

10 
	~<löux/com∑t.h
>

11 
	~<asm/sys_ü32.h
>

13 
asmlökage
 
	$sys32_ùc
(
u32
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

14 
com∑t_u±r_t
 
±r
, 
u32
 
fi·h
)

16 
vîsi⁄
;

18 
vîsi⁄
 = 
ˇŒ
 >> 16;

19 
ˇŒ
 &= 0xffff;

21 
ˇŒ
) {

22 
SEMOP
:

24  
	`sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
, 
NULL
);

25 
SEMTIMEDOP
:

26  
	`com∑t_sys_£mtimed›
(
fú°
, 
	`com∑t_±r
(
±r
), 
£c⁄d
,

27 
	`com∑t_±r
(
fi·h
));

28 
SEMGET
:

29  
	`sys_£mgë
(
fú°
, 
£c⁄d
, 
thúd
);

30 
SEMCTL
:

31  
	`com∑t_sys_£m˘l
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

33 
MSGSND
:

34  
	`com∑t_sys_msg¢d
(
fú°
, 
£c⁄d
, 
thúd
, 
	`com∑t_±r
(
±r
));

35 
MSGRCV
:

36  
	`com∑t_sys_msgrcv
(
fú°
, 
£c⁄d
, 
fi·h
, 
thúd
,

37 
vîsi⁄
, 
	`com∑t_±r
(
±r
));

38 
MSGGET
:

39  
	`sys_msggë
((
key_t
Ë
fú°
, 
£c⁄d
);

40 
MSGCTL
:

41  
	`com∑t_sys_msg˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

43 
SHMAT
:

44  
	`com∑t_sys_shm©
(
fú°
, 
£c⁄d
, 
thúd
, 
vîsi⁄
,

45 
	`com∑t_±r
(
±r
));

46 
SHMDT
:

47  
	`sys_shmdt
(
	`com∑t_±r
(
±r
));

48 
SHMGET
:

49  
	`sys_shmgë
(
fú°
, ()
£c⁄d
, 
thúd
);

50 
SHMCTL
:

51  
	`com∑t_sys_shm˘l
(
fú°
, 
£c⁄d
, 
	`com∑t_±r
(
±r
));

53  -
ENOSYS
;

54 
	}
}

	@/cmpt816/linux/arch/x86/ia32/sys_ia32.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/sig«l.h
>

28 
	~<löux/sysˇŒs.h
>

29 
	~<löux/times.h
>

30 
	~<löux/ut¢ame.h
>

31 
	~<löux/smp_lock.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/uio.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/≥rs⁄Æôy.h
>

36 
	~<löux/°©.h
>

37 
	~<löux/rw£m.h
>

38 
	~<löux/com∑t.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/±ø˚.h
>

41 
	~<löux/highuid.h
>

42 
	~<löux/sys˘l.h
>

43 
	~<löux/¶ab.h
>

44 
	~<asm/mm™.h
>

45 
	~<asm/ty≥s.h
>

46 
	~<asm/uac˚ss.h
>

47 
	~<asm/©omic.h
>

48 
	~<asm/vgtod.h
>

49 
	~<asm/sys_ü32.h
>

51 
	#AA
(
__x
Ë(()(__x))

	)

54 
asmlökage
 
	$sys32_åunˇã64
(
__u£r
 *
fûíame
,

55 
off£t_low
,

56 
off£t_high
)

58  
	`sys_åunˇã
(
fûíame
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

59 
	}
}

61 
asmlökage
 
	$sys32_·runˇã64
(
fd
, 
off£t_low
,

62 
off£t_high
)

64  
	`sys_·runˇã
(
fd
, ((
loff_t
Ë
off£t_high
 << 32Ë| 
off£t_low
);

65 
	}
}

71 
	$˝_°©64
(
°©64
 
__u£r
 *
ubuf
, 
k°©
 *
°©
)

73 
	`ty≥of
(
ubuf
->
°_uid
Ë
uid
 = 0;

74 
	`ty≥of
(
ubuf
->
°_gid
Ë
gid
 = 0;

75 
	`SET_UID
(
uid
, 
°©
->uid);

76 
	`SET_GID
(
gid
, 
°©
->gid);

77 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ubuf
, (
°©64
)) ||

78 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
dev
), &
ubuf
->
°_dev
) ||

79 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
__°_öo
) ||

80 
	`__put_u£r
(
°©
->
öo
, &
ubuf
->
°_öo
) ||

81 
	`__put_u£r
(
°©
->
mode
, &
ubuf
->
°_mode
) ||

82 
	`__put_u£r
(
°©
->
∆ök
, &
ubuf
->
°_∆ök
) ||

83 
	`__put_u£r
(
uid
, &
ubuf
->
°_uid
) ||

84 
	`__put_u£r
(
gid
, &
ubuf
->
°_gid
) ||

85 
	`__put_u£r
(
	`huge_ícode_dev
(
°©
->
rdev
), &
ubuf
->
°_rdev
) ||

86 
	`__put_u£r
(
°©
->
size
, &
ubuf
->
°_size
) ||

87 
	`__put_u£r
(
°©
->
©ime
.
tv_£c
, &
ubuf
->
°_©ime
) ||

88 
	`__put_u£r
(
°©
->
©ime
.
tv_n£c
, &
ubuf
->
°_©ime_n£c
) ||

89 
	`__put_u£r
(
°©
->
mtime
.
tv_£c
, &
ubuf
->
°_mtime
) ||

90 
	`__put_u£r
(
°©
->
mtime
.
tv_n£c
, &
ubuf
->
°_mtime_n£c
) ||

91 
	`__put_u£r
(
°©
->
˘ime
.
tv_£c
, &
ubuf
->
°_˘ime
) ||

92 
	`__put_u£r
(
°©
->
˘ime
.
tv_n£c
, &
ubuf
->
°_˘ime_n£c
) ||

93 
	`__put_u£r
(
°©
->
blksize
, &
ubuf
->
°_blksize
) ||

94 
	`__put_u£r
(
°©
->
blocks
, &
ubuf
->
°_blocks
))

95  -
EFAULT
;

97 
	}
}

99 
asmlökage
 
	$sys32_°©64
(
__u£r
 *
fûíame
,

100 
°©64
 
__u£r
 *
°©buf
)

102 
k°©
 
°©
;

103 
ªt
 = 
	`vfs_°©
(
fûíame
, &
°©
);

105 i‡(!
ªt
)

106 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

107  
ªt
;

108 
	}
}

110 
asmlökage
 
	$sys32_l°©64
(
__u£r
 *
fûíame
,

111 
°©64
 
__u£r
 *
°©buf
)

113 
k°©
 
°©
;

114 
ªt
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

115 i‡(!
ªt
)

116 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

117  
ªt
;

118 
	}
}

120 
asmlökage
 
	$sys32_f°©64
(
fd
, 
°©64
 
__u£r
 *
°©buf
)

122 
k°©
 
°©
;

123 
ªt
 = 
	`vfs_f°©
(
fd
, &
°©
);

124 i‡(!
ªt
)

125 
ªt
 = 
	`˝_°©64
(
°©buf
, &
°©
);

126  
ªt
;

127 
	}
}

129 
asmlökage
 
	$sys32_f°©©
(
dfd
, 
__u£r
 *
fûíame
,

130 
°©64
 
__u£r
 *
°©buf
, 
Êag
)

132 
k°©
 
°©
;

133 
îr‹
;

135 
îr‹
 = 
	`vfs_f°©©
(
dfd
, 
fûíame
, &
°©
, 
Êag
);

136 i‡(
îr‹
)

137  
îr‹
;

138  
	`˝_°©64
(
°©buf
, &
°©
);

139 
	}
}

147 
	smm≠_¨g_°ru˘32
 {

148 
	maddr
;

149 
	mÀn
;

150 
	m¥Ÿ
;

151 
	mÊags
;

152 
	mfd
;

153 
	moff£t
;

156 
asmlökage
 
	$sys32_mm≠
(
mm≠_¨g_°ru˘32
 
__u£r
 *
¨g
)

158 
mm≠_¨g_°ru˘32
 
a
;

160 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

161  -
EFAULT
;

163 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

164  -
EINVAL
;

166  
	`sys_mm≠_pgoff
(
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,á.
fd
,

167 
a
.
off£t
>>
PAGE_SHIFT
);

168 
	}
}

170 
asmlökage
 
	$sys32_m¥Ÿe˘
(
°¨t
, 
size_t
 
Àn
,

171 
¥Ÿ
)

173  
	`sys_m¥Ÿe˘
(
°¨t
, 
Àn
, 
¥Ÿ
);

174 
	}
}

176 
asmlökage
 
	$sys32_π_siga˘i⁄
(
sig
, 
siga˘i⁄32
 
__u£r
 *
a˘
,

177 
siga˘i⁄32
 
__u£r
 *
ﬂ˘
,

178 
sig£tsize
)

180 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

181 
ªt
;

182 
com∑t_sig£t_t
 
£t32
;

185 i‡(
sig£tsize
 !(
com∑t_sig£t_t
))

186  -
EINVAL
;

188 i‡(
a˘
) {

189 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

191 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

192 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

193 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

194 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

195 
	`__c›y_‰om_u£r
(&
£t32
, &
a˘
->
ß_mask
,

196 (
com∑t_sig£t_t
)))

197  -
EFAULT
;

198 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

199 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

205 
_NSIG_WORDS
) {

206 4: 
√w_ka
.
ß
.
ß_mask
.
sig
[3] = 
£t32
.sig[6]

207 | ((()
£t32
.
sig
[7]) << 32);

208 3: 
√w_ka
.
ß
.
ß_mask
.
sig
[2] = 
£t32
.sig[4]

209 | ((()
£t32
.
sig
[5]) << 32);

210 2: 
√w_ka
.
ß
.
ß_mask
.
sig
[1] = 
£t32
.sig[2]

211 | ((()
£t32
.
sig
[3]) << 32);

212 1: 
√w_ka
.
ß
.
ß_mask
.
sig
[0] = 
£t32
.sig[0]

213 | ((()
£t32
.
sig
[1]) << 32);

217 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

219 i‡(!
ªt
 && 
ﬂ˘
) {

224 
_NSIG_WORDS
) {

226 
£t32
.
sig
[7] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[3] >> 32);

227 
£t32
.
sig
[6] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[3];

229 
£t32
.
sig
[5] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[2] >> 32);

230 
£t32
.
sig
[4] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[2];

232 
£t32
.
sig
[3] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[1] >> 32);

233 
£t32
.
sig
[2] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[1];

235 
£t32
.
sig
[1] = (
ﬁd_ka
.
ß
.
ß_mask
.sig[0] >> 32);

236 
£t32
.
sig
[0] = 
ﬁd_ka
.
ß
.
ß_mask
.sig[0];

238 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

239 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

240 &
ﬂ˘
->
ß_h™dÀr
) ||

241 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

242 &
ﬂ˘
->
ß_ª°‹î
) ||

243 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

244 
	`__c›y_to_u£r
(&
ﬂ˘
->
ß_mask
, &
£t32
,

245 (
com∑t_sig£t_t
)))

246  -
EFAULT
;

249  
ªt
;

250 
	}
}

252 
asmlökage
 
	$sys32_siga˘i⁄
(
sig
, 
ﬁd_siga˘i⁄32
 
__u£r
 *
a˘
,

253 
ﬁd_siga˘i⁄32
 
__u£r
 *
ﬂ˘
)

255 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

256 
ªt
;

258 i‡(
a˘
) {

259 
com∑t_ﬁd_sig£t_t
 
mask
;

260 
com∑t_u±r_t
 
h™dÀr
, 
ª°‹î
;

262 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

263 
	`__gë_u£r
(
h™dÀr
, &
a˘
->
ß_h™dÀr
) ||

264 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags) ||

265 
	`__gë_u£r
(
ª°‹î
, &
a˘
->
ß_ª°‹î
) ||

266 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
))

267  -
EFAULT
;

269 
√w_ka
.
ß
.
ß_h™dÀr
 = 
	`com∑t_±r
(
h™dÀr
);

270 
√w_ka
.
ß
.
ß_ª°‹î
 = 
	`com∑t_±r
(
ª°‹î
);

272 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

275 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

277 i‡(!
ªt
 && 
ﬂ˘
) {

278 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

279 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_h™dÀr
),

280 &
ﬂ˘
->
ß_h™dÀr
) ||

281 
	`__put_u£r
(
	`±r_to_com∑t
(
ﬁd_ka
.
ß
.
ß_ª°‹î
),

282 &
ﬂ˘
->
ß_ª°‹î
) ||

283 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags) ||

284 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask))

285  -
EFAULT
;

288  
ªt
;

289 
	}
}

291 
asmlökage
 
	$sys32_π_sig¥ocmask
(
how
, 
com∑t_sig£t_t
 
__u£r
 *
£t
,

292 
com∑t_sig£t_t
 
__u£r
 *
o£t
,

293 
sig£tsize
)

295 
sig£t_t
 
s
;

296 
com∑t_sig£t_t
 
s32
;

297 
ªt
;

298 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

300 i‡(
£t
) {

301 i‡(
	`c›y_‰om_u£r
(&
s32
, 
£t
, (
com∑t_sig£t_t
)))

302  -
EFAULT
;

303 
_NSIG_WORDS
) {

304 4: 
s
.
sig
[3] = 
s32
.sig[6] | ((()s32.sig[7]) << 32);

305 3: 
s
.
sig
[2] = 
s32
.sig[4] | ((()s32.sig[5]) << 32);

306 2: 
s
.
sig
[1] = 
s32
.sig[2] | ((()s32.sig[3]) << 32);

307 1: 
s
.
sig
[0] = 
s32
.sig[0] | ((()s32.sig[1]) << 32);

310 
	`£t_fs
(
KERNEL_DS
);

311 
ªt
 = 
	`sys_π_sig¥ocmask
(
how
,

312 
£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

313 
o£t
 ? (
sig£t_t
 
__u£r
 *)&
s
 : 
NULL
,

314 
sig£tsize
);

315 
	`£t_fs
(
ﬁd_fs
);

316 i‡(
ªt
)

317  
ªt
;

318 i‡(
o£t
) {

319 
_NSIG_WORDS
) {

320 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

321 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

322 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

323 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

325 i‡(
	`c›y_to_u£r
(
o£t
, &
s32
, (
com∑t_sig£t_t
)))

326  -
EFAULT
;

329 
	}
}

331 
asmlökage
 
	$sys32_Æ¨m
(
£c⁄ds
)

333  
	`Æ¨m_£tôimî
(
£c⁄ds
);

334 
	}
}

336 
asmlökage
 
	$sys32_waôpid
(
com∑t_pid_t
 
pid
, *
°©_addr
,

337 
›ti⁄s
)

339  
	`com∑t_sys_waô4
(
pid
, 
°©_addr
, 
›ti⁄s
, 
NULL
);

340 
	}
}

344 
asmlökage
 
	$sys32_sysfs
(
›ti⁄
, 
u32
 
¨g1
, u32 
¨g2
)

346  
	`sys_sysfs
(
›ti⁄
, 
¨g1
, 
¨g2
);

347 
	}
}

349 
asmlökage
 
	$sys32_sched_º_gë_öãrvÆ
(
com∑t_pid_t
 
pid
,

350 
com∑t_time•ec
 
__u£r
 *
öãrvÆ
)

352 
time•ec
 
t
;

353 
ªt
;

354 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

356 
	`£t_fs
(
KERNEL_DS
);

357 
ªt
 = 
	`sys_sched_º_gë_öãrvÆ
(
pid
, (
time•ec
 
__u£r
 *)&
t
);

358 
	`£t_fs
(
ﬁd_fs
);

359 i‡(
	`put_com∑t_time•ec
(&
t
, 
öãrvÆ
))

360  -
EFAULT
;

361  
ªt
;

362 
	}
}

364 
asmlökage
 
	$sys32_π_sig≥ndög
(
com∑t_sig£t_t
 
__u£r
 *
£t
,

365 
com∑t_size_t
 
sig£tsize
)

367 
sig£t_t
 
s
;

368 
com∑t_sig£t_t
 
s32
;

369 
ªt
;

370 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

372 
	`£t_fs
(
KERNEL_DS
);

373 
ªt
 = 
	`sys_π_sig≥ndög
((
sig£t_t
 
__u£r
 *)&
s
, 
sig£tsize
);

374 
	`£t_fs
(
ﬁd_fs
);

375 i‡(!
ªt
) {

376 
_NSIG_WORDS
) {

377 4: 
s32
.
sig
[7] = (
s
.sig[3] >> 32); s32.sig[6] = s.sig[3];

378 3: 
s32
.
sig
[5] = (
s
.sig[2] >> 32); s32.sig[4] = s.sig[2];

379 2: 
s32
.
sig
[3] = (
s
.sig[1] >> 32); s32.sig[2] = s.sig[1];

380 1: 
s32
.
sig
[1] = (
s
.sig[0] >> 32); s32.sig[0] = s.sig[0];

382 i‡(
	`c›y_to_u£r
(
£t
, &
s32
, (
com∑t_sig£t_t
)))

383  -
EFAULT
;

385  
ªt
;

386 
	}
}

388 
asmlökage
 
	$sys32_π_sigqueueöfo
(
pid
, 
sig
,

389 
com∑t_sigöfo_t
 
__u£r
 *
uöfo
)

391 
sigöfo_t
 
öfo
;

392 
ªt
;

393 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

395 i‡(
	`c›y_sigöfo_‰om_u£r32
(&
öfo
, 
uöfo
))

396  -
EFAULT
;

397 
	`£t_fs
(
KERNEL_DS
);

398 
ªt
 = 
	`sys_π_sigqueueöfo
(
pid
, 
sig
, (
sigöfo_t
 
__u£r
 *)&
öfo
);

399 
	`£t_fs
(
ﬁd_fs
);

400  
ªt
;

401 
	}
}

404 
asmlökage
 
	$sys32_¥ód
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

405 
u32
 
po¶o
, u32 
poshi
)

407  
	`sys_¥ód64
(
fd
, 
ubuf
, 
cou¡
,

408 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

409 
	}
}

411 
asmlökage
 
	$sys32_pwrôe
(
fd
, 
__u£r
 *
ubuf
, 
u32
 
cou¡
,

412 
u32
 
po¶o
, u32 
poshi
)

414  
	`sys_pwrôe64
(
fd
, 
ubuf
, 
cou¡
,

415 ((
loff_t
)
	`AA
(
poshi
Ë<< 32Ë| AA(
po¶o
));

416 
	}
}

419 
asmlökage
 
	$sys32_≥rs⁄Æôy
(
≥rs⁄Æôy
)

421 
ªt
;

423 i‡(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_LINUX32
 &&

424 
≥rs⁄Æôy
 =
PER_LINUX
)

425 
≥rs⁄Æôy
 = 
PER_LINUX32
;

426 
ªt
 = 
	`sys_≥rs⁄Æôy
(
≥rs⁄Æôy
);

427 i‡(
ªt
 =
PER_LINUX32
)

428 
ªt
 = 
PER_LINUX
;

429  
ªt
;

430 
	}
}

432 
asmlökage
 
	$sys32_£ndfûe
(
out_fd
, 
ö_fd
,

433 
com∑t_off_t
 
__u£r
 *
off£t
, 
s32
 
cou¡
)

435 
mm_£gmít_t
 
ﬁd_fs
 = 
	`gë_fs
();

436 
ªt
;

437 
off_t
 
of
;

439 i‡(
off£t
 && 
	`gë_u£r
(
of
, offset))

440  -
EFAULT
;

442 
	`£t_fs
(
KERNEL_DS
);

443 
ªt
 = 
	`sys_£ndfûe
(
out_fd
, 
ö_fd
, 
off£t
 ? (
off_t
 
__u£r
 *)&
of
 : 
NULL
,

444 
cou¡
);

445 
	`£t_fs
(
ﬁd_fs
);

447 i‡(
off£t
 && 
	`put_u£r
(
of
, offset))

448  -
EFAULT
;

449  
ªt
;

450 
	}
}

452 
asmlökage
 
	$sys32_execve
(
__u£r
 *
«me
, 
com∑t_u±r_t
 __u£∏*
¨gv
,

453 
com∑t_u±r_t
 
__u£r
 *
ívp
, 
±_ªgs
 *
ªgs
)

455 
îr‹
;

456 *
fûíame
;

458 
fûíame
 = 
	`gë«me
(
«me
);

459 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

460 i‡(
	`IS_ERR
(
fûíame
))

461  
îr‹
;

462 
îr‹
 = 
	`com∑t_do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

463 
	`puäame
(
fûíame
);

464  
îr‹
;

465 
	}
}

467 
asmlökage
 
	$sys32_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

468 
±_ªgs
 *
ªgs
)

470 
__u£r
 *
∑ª¡_tid
 = (__u£∏*)
ªgs
->
dx
;

471 
__u£r
 *
chûd_tid
 = (__u£∏*)
ªgs
->
di
;

473 i‡(!
√w•
)

474 
√w•
 = 
ªgs
->
•
;

475  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

476 
	}
}

482 
	$sys32_l£ek
(
fd
, 
off£t
, 
whí˚
)

484  
	`sys_l£ek
(
fd
, 
off£t
, 
whí˚
);

485 
	}
}

487 
	$sys32_kûl
(
pid
, 
sig
)

489  
	`sys_kûl
(
pid
, 
sig
);

490 
	}
}

492 
	$sys32_Ádvi£64_64
(
fd
, 
__u32
 
off£t_low
, __u32 
off£t_high
,

493 
__u32
 
Àn_low
, __u32 
Àn_high
, 
advi˚
)

495  
	`sys_Ádvi£64_64
(
fd
,

496 (((
u64
)
off£t_high
)<<32Ë| 
off£t_low
,

497 (((
u64
)
Àn_high
)<<32Ë| 
Àn_low
,

498 
advi˚
);

499 
	}
}

501 
	$sys32_vm86_w¨nög
()

503 
èsk_°ru˘
 *
me
 = 
cuºít
;

504 
œ°comm
[(
me
->
comm
)];

506 i‡(
	`°∫cmp
(
œ°comm
, 
me
->
comm
, (lastcomm))) {

507 
	`com∑t_¥ötk
(
KERN_INFO


509 
me
->
comm
);

510 
	`°∫˝y
(
œ°comm
, 
me
->
comm
, (lastcomm));

512  -
ENOSYS
;

513 
	}
}

515 
	$sys32_lookup_dcookõ
(
u32
 
addr_low
, u32 
addr_high
,

516 
__u£r
 *
buf
, 
size_t
 
Àn
)

518  
	`sys_lookup_dcookõ
(((
u64
)
addr_high
 << 32Ë| 
addr_low
, 
buf
, 
Àn
);

519 
	}
}

521 
asmlökage
 
ssize_t
 
	$sys32_ªadahód
(
fd
, 
off_lo
, 
off_hi
,

522 
size_t
 
cou¡
)

524  
	`sys_ªadahód
(
fd
, ((
u64
)
off_hi
 << 32Ë| 
off_lo
, 
cou¡
);

525 
	}
}

527 
asmlökage
 
	$sys32_sync_fûe_ønge
(
fd
, 
off_low
, 
off_hi
,

528 
n_low
, 
n_hi
, 
Êags
)

530  
	`sys_sync_fûe_ønge
(
fd
,

531 ((
u64
)
off_hi
 << 32Ë| 
off_low
,

532 ((
u64
)
n_hi
 << 32Ë| 
n_low
, 
Êags
);

533 
	}
}

535 
asmlökage
 
	$sys32_Ádvi£64
(
fd
, 
off£t_lo
, 
off£t_hi
,

536 
size_t
 
Àn
, 
advi˚
)

538  
	`sys_Ádvi£64_64
(
fd
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

539 
Àn
, 
advi˚
);

540 
	}
}

542 
asmlökage
 
	$sys32_ÁŒoˇã
(
fd
, 
mode
, 
off£t_lo
,

543 
off£t_hi
, 
Àn_lo
,

544 
Àn_hi
)

546  
	`sys_ÁŒoˇã
(
fd
, 
mode
, ((
u64
)
off£t_hi
 << 32Ë| 
off£t_lo
,

547 ((
u64
)
Àn_hi
 << 32Ë| 
Àn_lo
);

548 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/boot.c

26 
	~<löux/öô.h
>

27 
	~<löux/a˝i.h
>

28 
	~<löux/a˝i_pmtmr.h
>

29 
	~<löux/efi.h
>

30 
	~<löux/˝umask.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/dmi.h
>

33 
	~<löux/úq.h
>

34 
	~<löux/¶ab.h
>

35 
	~<löux/boŸmem.h
>

36 
	~<löux/i›‹t.h
>

37 
	~<löux/pci.h
>

39 
	~<asm/pci_x86.h
>

40 
	~<asm/pgèbÀ.h
>

41 
	~<asm/io_≠ic.h
>

42 
	~<asm/≠ic.h
>

43 
	~<asm/io.h
>

44 
	~<asm/mp•ec.h
>

45 
	~<asm/smp.h
>

47 
__öôd©a
 
	ga˝i_f‹˚
 = 0;

48 
u32
 
	ga˝i_rsdt_f‹˚d
;

49 
	ga˝i_dißbÀd
;

50 
EXPORT_SYMBOL
(
a˝i_dißbÀd
);

52 #ifdef 
CONFIG_X86_64


53 
	~<asm/¥Ÿo.h
>

54 
	~<asm/numa_64.h
>

57 
	#BAD_MADT_ENTRY
(
íåy
, 
íd
) ( \

58 (!
íåy
Ë|| (Î¡ry + (*íåyË> 
íd
 || \

59 ((
a˝i_subèbÀ_hódî
 *)
íåy
)->
Àngth
 < (*íåy))

	)

61 
	#PREFIX
 "ACPI: "

	)

63 
	ga˝i_noúq
;

64 
	ga˝i_pci_dißbÀd
;

65 
EXPORT_SYMBOL
(
a˝i_pci_dißbÀd
);

67 
	ga˝i_œpic
;

68 
	ga˝i_iﬂpic
;

69 
	ga˝i_°ri˘
;

71 
u8
 
a˝i_sci_Êags
 
	g__öôd©a
;

72 
a˝i_sci_ovîride_gsi
 
	g__öôd©a
;

73 
a˝i_skù_timî_ovîride
 
	g__öôd©a
;

74 
a˝i_u£_timî_ovîride
 
	g__öôd©a
;

76 #ifde‡
CONFIG_X86_LOCAL_APIC


77 
u64
 
a˝i_œpic_addr
 
	g__öôd©a
 = 
APIC_DEFAULT_PHYS_BASE
;

80 #i‚de‡
__HAVE_ARCH_CMPXCHG


81 #w¨nög 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
™d
 
œãr
 
h¨dw¨e


92 
a˝i_úq_modñ_id
 
	ga˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_PIC
;

99 
u32
 
	giß_úq_to_gsi
[
NR_IRQS_LEGACY
] 
	g__ªad_mo°ly
 = {

103 
	$gsi_to_úq
(
gsi
)

105 
úq
 = 
gsi
 + 
NR_IRQS_LEGACY
;

106 
i
;

108 
i
 = 0; i < 
NR_IRQS_LEGACY
; i++) {

109 i‡(
iß_úq_to_gsi
[
i
] =
gsi
) {

110  
i
;

118 i‡(
gsi
 >
NR_IRQS_LEGACY
)

119 
úq
 = 
gsi
;

121 
úq
 = 
gsi_t›
 + 
gsi
;

123  
úq
;

124 
	}
}

126 
u32
 
	$úq_to_gsi
(
úq
)

128 
gsi
;

130 i‡(
úq
 < 
NR_IRQS_LEGACY
)

131 
gsi
 = 
iß_úq_to_gsi
[
úq
];

132 i‡(
úq
 < 
gsi_t›
)

133 
gsi
 = 
úq
;

134 i‡(
úq
 < (
gsi_t›
 + 
NR_IRQS_LEGACY
))

135 
gsi
 = 
úq
 - 
gsi_t›
;

137 
gsi
 = 0xffffffff;

139  
gsi
;

140 
	}
}

154 *
__öô
 
	$__a˝i_m≠_èbÀ
(
phys
, 
size
)

157 i‡(!
phys
 || !
size
)

158  
NULL
;

160  
	`óæy_i‹em≠
(
phys
, 
size
);

161 
	}
}

162 
__öô
 
	$__a˝i_unm≠_èbÀ
(*
m≠
, 
size
)

164 i‡(!
m≠
 || !
size
)

167 
	`óæy_iounm≠
(
m≠
, 
size
);

168 
	}
}

170 #ifde‡
CONFIG_X86_LOCAL_APIC


171 
__öô
 
	$a˝i_∑r£_madt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

173 
a˝i_èbÀ_madt
 *
madt
 = 
NULL
;

175 i‡(!
˝u_has_≠ic
)

176  -
EINVAL
;

178 
madt
 = (
a˝i_èbÀ_madt
 *)
èbÀ
;

179 i‡(!
madt
) {

180 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map MADT\n");

181  -
ENODEV
;

184 i‡(
madt
->
addªss
) {

185 
a˝i_œpic_addr
 = (
u64
Ë
madt
->
addªss
;

187 
	`¥ötk
(
KERN_DEBUG
 
PREFIX
 "Local APICáddress 0x%08x\n",

188 
madt
->
addªss
);

191 
	`deÁu…_a˝i_madt_€m_check
(
madt
->
hódî
.
€m_id
,

192 
madt
->
hódî
.
€m_èbÀ_id
);

195 
	}
}

197 
__˝uöô
 
	$a˝i_ªgi°î_œpic
(
id
, 
u8
 
íabÀd
)

199 
vî
 = 0;

201 i‡(!
íabÀd
) {

202 ++
dißbÀd_˝us
;

206 i‡(
boŸ_˝u_physiˇl_≠icid
 != -1U)

207 
vî
 = 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
];

209 
	`gíîic_¥o˚ss‹_öfo
(
id
, 
vî
);

210 
	}
}

212 
__öô


213 
	$a˝i_∑r£_x2≠ic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

215 
a˝i_madt_loˇl_x2≠ic
 *
¥o˚ss‹
 = 
NULL
;

217 
¥o˚ss‹
 = (
a˝i_madt_loˇl_x2≠ic
 *)
hódî
;

219 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

220  -
EINVAL
;

222 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

224 #ifde‡
CONFIG_X86_X2APIC


232 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
loˇl_≠ic_id
,

233 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

235 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "x2apicÉntry ignored\n");

239 
	}
}

241 
__öô


242 
	$a˝i_∑r£_œpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

244 
a˝i_madt_loˇl_≠ic
 *
¥o˚ss‹
 = 
NULL
;

246 
¥o˚ss‹
 = (
a˝i_madt_loˇl_≠ic
 *)
hódî
;

248 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

249  -
EINVAL
;

251 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

260 
	`a˝i_ªgi°î_œpic
(
¥o˚ss‹
->
id
,

261 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

264 
	}
}

266 
__öô


267 
	$a˝i_∑r£_ßpic
(
a˝i_subèbÀ_hódî
 *
hódî
, c⁄° 
íd
)

269 
a˝i_madt_loˇl_ßpic
 *
¥o˚ss‹
 = 
NULL
;

271 
¥o˚ss‹
 = (
a˝i_madt_loˇl_ßpic
 *)
hódî
;

273 i‡(
	`BAD_MADT_ENTRY
(
¥o˚ss‹
, 
íd
))

274  -
EINVAL
;

276 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

278 
	`a˝i_ªgi°î_œpic
((
¥o˚ss‹
->
id
 << 8Ë|Öro˚ss‹->
eid
,

279 
¥o˚ss‹
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

282 
	}
}

284 
__öô


285 
	$a˝i_∑r£_œpic_addr_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

286 c⁄° 
íd
)

288 
a˝i_madt_loˇl_≠ic_ovîride
 *
œpic_addr_ovr
 = 
NULL
;

290 
œpic_addr_ovr
 = (
a˝i_madt_loˇl_≠ic_ovîride
 *)
hódî
;

292 i‡(
	`BAD_MADT_ENTRY
(
œpic_addr_ovr
, 
íd
))

293  -
EINVAL
;

295 
a˝i_œpic_addr
 = 
œpic_addr_ovr
->
addªss
;

298 
	}
}

300 
__öô


301 
	$a˝i_∑r£_x2≠ic_nmi
(
a˝i_subèbÀ_hódî
 *
hódî
,

302 c⁄° 
íd
)

304 
a˝i_madt_loˇl_x2≠ic_nmi
 *
x2≠ic_nmi
 = 
NULL
;

306 
x2≠ic_nmi
 = (
a˝i_madt_loˇl_x2≠ic_nmi
 *)
hódî
;

308 i‡(
	`BAD_MADT_ENTRY
(
x2≠ic_nmi
, 
íd
))

309  -
EINVAL
;

311 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

313 i‡(
x2≠ic_nmi
->
löt
 != 1)

314 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

317 
	}
}

319 
__öô


320 
	$a˝i_∑r£_œpic_nmi
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

322 
a˝i_madt_loˇl_≠ic_nmi
 *
œpic_nmi
 = 
NULL
;

324 
œpic_nmi
 = (
a˝i_madt_loˇl_≠ic_nmi
 *)
hódî
;

326 i‡(
	`BAD_MADT_ENTRY
(
œpic_nmi
, 
íd
))

327  -
EINVAL
;

329 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

331 i‡(
œpic_nmi
->
löt
 != 1)

332 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "NMIÇot connectedÅo LINT 1!\n");

335 
	}
}

339 #ifde‡
CONFIG_X86_IO_APIC


341 
__öô


342 
	$a˝i_∑r£_iﬂpic
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

344 
a˝i_madt_io_≠ic
 *
iﬂpic
 = 
NULL
;

346 
iﬂpic
 = (
a˝i_madt_io_≠ic
 *)
hódî
;

348 i‡(
	`BAD_MADT_ENTRY
(
iﬂpic
, 
íd
))

349  -
EINVAL
;

351 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

353 
	`mp_ªgi°î_iﬂpic
(
iﬂpic
->
id
,

354 
iﬂpic
->
addªss
, iﬂpic->
globÆ_úq_ba£
);

357 
	}
}

362 
__öô
 
	$a˝i_sci_iﬂpic_£tup
(
u8
 
bus_úq
, 
u16
 
pﬁ¨ôy
, u16 
åiggî
, 
u32
 
gsi
)

364 i‡(
åiggî
 == 0)

365 
åiggî
 = 3;

367 i‡(
pﬁ¨ôy
 == 0)

368 
pﬁ¨ôy
 = 3;

371 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
)

372 
åiggî
 = (
a˝i_sci_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2;

374 i‡(
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
)

375 
pﬁ¨ôy
 = 
a˝i_sci_Êags
 & 
ACPI_MADT_POLARITY_MASK
;

382 
	`mp_ovîride_Àgacy_úq
(
bus_úq
, 
pﬁ¨ôy
, 
åiggî
, 
gsi
);

388 
a˝i_sci_ovîride_gsi
 = 
gsi
;

390 
	}
}

392 
__öô


393 
	$a˝i_∑r£_öt_§c_ovr
(
a˝i_subèbÀ_hódî
 * 
hódî
,

394 c⁄° 
íd
)

396 
a˝i_madt_öãºu±_ovîride
 *
öt§c
 = 
NULL
;

398 
öt§c
 = (
a˝i_madt_öãºu±_ovîride
 *)
hódî
;

400 i‡(
	`BAD_MADT_ENTRY
(
öt§c
, 
íd
))

401  -
EINVAL
;

403 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

405 i‡(
öt§c
->
sour˚_úq
 =
a˝i_gbl_FADT
.
sci_öãºu±
) {

406 
	`a˝i_sci_iﬂpic_£tup
(
öt§c
->
sour˚_úq
,

407 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

408 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

409 
öt§c
->
globÆ_úq
);

413 i‡(
a˝i_skù_timî_ovîride
 &&

414 
öt§c
->
sour˚_úq
 =0 && i¡§c->
globÆ_úq
 == 2) {

415 
	`¥ötk
(
PREFIX
 "BIOS IRQ0Öin2 override ignored.\n");

419 
	`mp_ovîride_Àgacy_úq
(
öt§c
->
sour˚_úq
,

420 
öt§c
->
öti_Êags
 & 
ACPI_MADT_POLARITY_MASK
,

421 (
öt§c
->
öti_Êags
 & 
ACPI_MADT_TRIGGER_MASK
) >> 2,

422 
öt§c
->
globÆ_úq
);

425 
	}
}

427 
__öô


428 
	$a˝i_∑r£_nmi_§c
(
a˝i_subèbÀ_hódî
 * 
hódî
, c⁄° 
íd
)

430 
a˝i_madt_nmi_sour˚
 *
nmi_§c
 = 
NULL
;

432 
nmi_§c
 = (
a˝i_madt_nmi_sour˚
 *)
hódî
;

434 i‡(
	`BAD_MADT_ENTRY
(
nmi_§c
, 
íd
))

435  -
EINVAL
;

437 
	`a˝i_èbÀ_¥öt_madt_íåy
(
hódî
);

442 
	}
}

460 
__öô
 
	$a˝i_pic_sci_£t_åiggî
(
úq
, 
u16
 
åiggî
)

462 
mask
 = 1 << 
úq
;

463 
ﬁd
, 
√w
;

466 
ﬁd
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

473 
√w
 = 
a˝i_noúq
 ? 
ﬁd
 : 0;

479 
åiggî
) {

481 
√w
 &~
mask
;

484 
√w
 |
mask
;

488 i‡(
ﬁd
 =
√w
)

491 
	`¥ötk
(
PREFIX
 "£âög ELCRÅÿ%04x (‰om %04x)\n", 
√w
, 
ﬁd
);

492 
	`outb
(
√w
, 0x4d0);

493 
	`outb
(
√w
 >> 8, 0x4d1);

494 
	}
}

496 
	$a˝i_gsi_to_úq
(
u32
 
gsi
, *
úq
)

498 *
úq
 = 
	`gsi_to_úq
(
gsi
);

500 #ifde‡
CONFIG_X86_IO_APIC


501 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
)

502 
	`£tup_IO_APIC_úq_exåa
(
gsi
);

506 
	}
}

508 
	$a˝i_iß_úq_to_gsi
(
iß_úq
, 
u32
 *
gsi
)

510 i‡(
iß_úq
 >= 16)

512 *
gsi
 = 
	`úq_to_gsi
(
iß_úq
);

514 
	}
}

520 
	$a˝i_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

522 
úq
;

523 
∂©_gsi
 = 
gsi
;

525 #ifde‡
CONFIG_PCI


529 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_PIC
) {

530 i‡(
åiggî
 =
ACPI_LEVEL_SENSITIVE
)

531 
	`eiß_£t_Àvñ_úq
(
gsi
);

535 #ifde‡
CONFIG_X86_IO_APIC


536 i‡(
a˝i_úq_modñ
 =
ACPI_IRQ_MODEL_IOAPIC
) {

537 
∂©_gsi
 = 
	`mp_ªgi°î_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

540 
úq
 = 
	`gsi_to_úq
(
∂©_gsi
);

542  
úq
;

543 
	}
}

548 #ifde‡
CONFIG_ACPI_HOTPLUG_CPU


549 
	~<a˝i/¥o˚ss‹.h
>

551 
	$a˝i_m≠_˝u2node
(
a˝i_h™dÀ
 
h™dÀ
, 
˝u
, 
physid
)

553 #ifde‡
CONFIG_ACPI_NUMA


554 
nid
;

556 
nid
 = 
	`a˝i_gë_node
(
h™dÀ
);

557 i‡(
nid
 =-1 || !
	`node_⁄löe
(nid))

559 #ifde‡
CONFIG_X86_64


560 
≠icid_to_node
[
physid
] = 
nid
;

561 
	`numa_£t_node
(
˝u
, 
nid
);

563 
≠icid_2_node
[
physid
] = 
nid
;

564 
˝u_to_node_m≠
[
˝u
] = 
nid
;

568 
	}
}

570 
__˝uöô
 
	$_a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

572 
a˝i_buf„r
 
buf„r
 = { 
ACPI_ALLOCATE_BUFFER
, 
NULL
 };

573 
a˝i_obje˘
 *
obj
;

574 
a˝i_madt_loˇl_≠ic
 *
œpic
;

575 
˝umask_v¨_t
 
tmp_m≠
, 
√w_m≠
;

576 
u8
 
physid
;

577 
˝u
;

578 
ªtvÆ
 = -
ENOMEM
;

580 i‡(
	`ACPI_FAILURE
(
	`a˝i_evÆu©e_obje˘
(
h™dÀ
, "_MAT", 
NULL
, &
buf„r
)))

581  -
EINVAL
;

583 i‡(!
buf„r
.
Àngth
 || !buf„r.
poöãr
)

584  -
EINVAL
;

586 
obj
 = 
buf„r
.
poöãr
;

587 i‡(
obj
->
ty≥
 !
ACPI_TYPE_BUFFER
 ||

588 
obj
->
buf„r
.
Àngth
 < (*
œpic
)) {

589 
	`k‰ì
(
buf„r
.
poöãr
);

590  -
EINVAL
;

593 
œpic
 = (
a˝i_madt_loˇl_≠ic
 *)
obj
->
buf„r
.
poöãr
;

595 i‡(
œpic
->
hódî
.
ty≥
 !
ACPI_MADT_TYPE_LOCAL_APIC
 ||

596 !(
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
)) {

597 
	`k‰ì
(
buf„r
.
poöãr
);

598  -
EINVAL
;

601 
physid
 = 
œpic
->
id
;

603 
	`k‰ì
(
buf„r
.
poöãr
);

604 
buf„r
.
Àngth
 = 
ACPI_ALLOCATE_BUFFER
;

605 
buf„r
.
poöãr
 = 
NULL
;

607 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_m≠
, 
GFP_KERNEL
))

608 
out
;

610 i‡(!
	`Æloc_˝umask_v¨
(&
√w_m≠
, 
GFP_KERNEL
))

611 
‰ì_tmp_m≠
;

613 
	`˝umask_c›y
(
tmp_m≠
, 
˝u_¥e£¡_mask
);

614 
	`a˝i_ªgi°î_œpic
(
physid
, 
œpic
->
œpic_Êags
 & 
ACPI_MADT_ENABLED
);

620 
	`˝umask_™dnŸ
(
√w_m≠
, 
˝u_¥e£¡_mask
, 
tmp_m≠
);

621 i‡(
	`˝umask_em±y
(
√w_m≠
)) {

622 
	`¥ötk
 ("UnableÅo mapÜapicÅoÜogical cpuÇumber\n");

623 
ªtvÆ
 = -
EINVAL
;

624 
‰ì_√w_m≠
;

627 
	`a˝i_¥o˚ss‹_£t_pdc
(
h™dÀ
);

629 
˝u
 = 
	`˝umask_fú°
(
√w_m≠
);

630 
	`a˝i_m≠_˝u2node
(
h™dÀ
, 
˝u
, 
physid
);

632 *
p˝u
 = 
˝u
;

633 
ªtvÆ
 = 0;

635 
‰ì_√w_m≠
:

636 
	`‰ì_˝umask_v¨
(
√w_m≠
);

637 
‰ì_tmp_m≠
:

638 
	`‰ì_˝umask_v¨
(
tmp_m≠
);

639 
out
:

640  
ªtvÆ
;

641 
	}
}

644 
__ªf
 
	$a˝i_m≠_lßpic
(
a˝i_h™dÀ
 
h™dÀ
, *
p˝u
)

646  
	`_a˝i_m≠_lßpic
(
h™dÀ
, 
p˝u
);

647 
	}
}

648 
EXPORT_SYMBOL
(
a˝i_m≠_lßpic
);

650 
	$a˝i_unm≠_lßpic
(
˝u
)

652 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) = -1;

653 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

654 
num_¥o˚ss‹s
--;

657 
	}
}

659 
EXPORT_SYMBOL
(
a˝i_unm≠_lßpic
);

662 
	$a˝i_ªgi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u64
 
phys_addr
, 
u32
 
gsi_ba£
)

665  -
EINVAL
;

666 
	}
}

668 
EXPORT_SYMBOL
(
a˝i_ªgi°î_iﬂpic
);

670 
	$a˝i_uƒegi°î_iﬂpic
(
a˝i_h™dÀ
 
h™dÀ
, 
u32
 
gsi_ba£
)

673  -
EINVAL
;

674 
	}
}

676 
EXPORT_SYMBOL
(
a˝i_uƒegi°î_iﬂpic
);

678 
__öô
 
	$a˝i_∑r£_sbf
(
a˝i_èbÀ_hódî
 *
èbÀ
)

680 
a˝i_èbÀ_boŸ
 *
sb
;

682 
sb
 = (
a˝i_èbÀ_boŸ
 *)
èbÀ
;

683 i‡(!
sb
) {

684 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map SBF\n");

685  -
ENODEV
;

688 
sbf_p‹t
 = 
sb
->
cmos_ödex
;

691 
	}
}

693 #ifde‡
CONFIG_HPET_TIMER


694 
	~<asm/h≥t.h
>

696 
__öôd©a
 
ªsour˚
 *
	gh≥t_ªs
;

698 
__öô
 
	$a˝i_∑r£_h≥t
(
a˝i_èbÀ_hódî
 *
èbÀ
)

700 
a˝i_èbÀ_h≥t
 *
h≥t_tbl
;

702 
h≥t_tbl
 = (
a˝i_èbÀ_h≥t
 *)
èbÀ
;

703 i‡(!
h≥t_tbl
) {

704 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "UnableÅo map HPET\n");

705  -
ENODEV
;

708 i‡(
h≥t_tbl
->
addªss
.
•a˚_id
 !
ACPI_SPACE_MEM
) {

709 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPETÅimers must beÜocated in "

714 
h≥t_addªss
 = 
h≥t_tbl
->
addªss
.address;

715 
h≥t_blockid
 = 
h≥t_tbl
->
£quí˚
;

721 i‡(!
h≥t_addªss
) {

722 
	`¥ötk
(
KERN_WARNING
 
PREFIX


724 
h≥t_tbl
->
id
, 
h≥t_addªss
);

727 #ifde‡
CONFIG_X86_64


733 i‡(
h≥t_addªss
 == 0xfed0000000000000UL) {

734 i‡(!
h≥t_f‹˚_u£r
) {

735 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "HPET id: %#x "

738 "fix iàu∞tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

739 
h≥t_addªss
 = 0;

742 
	`¥ötk
(
KERN_WARNING
 
PREFIX


744 "tÿ0x„d00000.\n", 
h≥t_tbl
->
id
);

745 
h≥t_addªss
 >>= 32;

748 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

749 
h≥t_tbl
->
id
, 
h≥t_addªss
);

755 
	#HPET_RESOURCE_NAME_SIZE
 9

	)

756 
h≥t_ªs
 = 
	`Æloc_boŸmem
((*h≥t_ªsË+ 
HPET_RESOURCE_NAME_SIZE
);

758 
h≥t_ªs
->
«me
 = (*)&hpet_res[1];

759 
h≥t_ªs
->
Êags
 = 
IORESOURCE_MEM
;

760 
	`¢¥ötf
((*)
h≥t_ªs
->
«me
, 
HPET_RESOURCE_NAME_SIZE
, "HPET %u",

761 
h≥t_tbl
->
£quí˚
);

763 
h≥t_ªs
->
°¨t
 = 
h≥t_addªss
;

764 
h≥t_ªs
->
íd
 = 
h≥t_addªss
 + (1 * 1024) - 1;

767 
	}
}

773 
__öô
 
	$h≥t_ö£π_ªsour˚
()

775 i‡(!
h≥t_ªs
)

778  
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
h≥t_ªs
);

779 
	}
}

781 
œã_öôˇŒ
(
h≥t_ö£π_ªsour˚
);

784 
	#a˝i_∑r£_h≥t
 
NULL


	)

787 
__öô
 
	$a˝i_∑r£_Ádt
(
a˝i_èbÀ_hódî
 *
èbÀ
)

790 #ifde‡
CONFIG_X86_PM_TIMER


792 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
) {

794 i‡(
a˝i_gbl_FADT
.
xpm_timî_block
.
•a˚_id
 !=

795 
ACPI_ADR_SPACE_SYSTEM_IO
)

798 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
xpm_timî_block
.
addªss
;

804 i‡(!
pmtmr_i›‹t
)

805 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

808 
pmtmr_i›‹t
 = 
a˝i_gbl_FADT
.
pm_timî_block
;

810 i‡(
pmtmr_i›‹t
)

811 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

812 
pmtmr_i›‹t
);

815 
	}
}

817 #ifdef 
CONFIG_X86_LOCAL_APIC


823 
__öô
 
	$a˝i_ªgi°î_œpic_addªss
(
addªss
)

825 
mp_œpic_addr
 = 
addªss
;

827 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
addªss
);

828 i‡(
boŸ_˝u_physiˇl_≠icid
 == -1U) {

829 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

830 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
] =

831 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

833 
	}
}

835 
__öô
 
	$óæy_a˝i_∑r£_madt_œpic_addr_ovr
()

837 
cou¡
;

839 i‡(!
˝u_has_≠ic
)

840  -
ENODEV
;

847 
cou¡
 =

848 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

849 
a˝i_∑r£_œpic_addr_ovr
, 0);

850 i‡(
cou¡
 < 0) {

851 
	`¥ötk
(
KERN_ERR
 
PREFIX


853  
cou¡
;

856 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

858  
cou¡
;

859 
	}
}

861 
__öô
 
	$a˝i_∑r£_madt_œpic_íåõs
()

863 
cou¡
;

864 
x2cou¡
 = 0;

866 i‡(!
˝u_has_≠ic
)

867  -
ENODEV
;

874 
cou¡
 =

875 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

876 
a˝i_∑r£_œpic_addr_ovr
, 0);

877 i‡(
cou¡
 < 0) {

878 
	`¥ötk
(
KERN_ERR
 
PREFIX


880  
cou¡
;

883 
	`a˝i_ªgi°î_œpic_addªss
(
a˝i_œpic_addr
);

885 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

886 
a˝i_∑r£_ßpic
, 
MAX_APICS
);

888 i‡(!
cou¡
) {

889 
x2cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

890 
a˝i_∑r£_x2≠ic
, 
MAX_APICS
);

891 
cou¡
 = 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

892 
a˝i_∑r£_œpic
, 
MAX_APICS
);

894 i‡(!
cou¡
 && !
x2cou¡
) {

895 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No LAPICÉntriesÖresent\n");

897  -
ENODEV
;

898 } i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

899 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPICÉntry\n");

901  
cou¡
;

904 
x2cou¡
 =

905 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

906 
a˝i_∑r£_x2≠ic_nmi
, 0);

907 
cou¡
 =

908 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
, 
a˝i_∑r£_œpic_nmi
, 0);

909 i‡(
cou¡
 < 0 || 
x2cou¡
 < 0) {

910 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing LAPIC NMIÉntry\n");

912  
cou¡
;

915 
	}
}

918 #ifdef 
CONFIG_X86_IO_APIC


919 
	#MP_ISA_BUS
 0

	)

921 #ifde‡
CONFIG_X86_ES7000


922 
es7000_∂©
;

925 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

926 
mpc_öt§c
 *
mp_úq
)

928 
	`mem˝y
(
mp_úq
, 
m
, (
mpc_öt§c
));

929 
	}
}

931 
	$mp_úq_cmp
(
mpc_öt§c
 *
mp_úq
,

932 
mpc_öt§c
 *
m
)

934  
	`memcmp
(
mp_úq
, 
m
, (
mpc_öt§c
));

935 
	}
}

937 
	$ßve_mp_úq
(
mpc_öt§c
 *
m
)

939 
i
;

941 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

942 i‡(!
	`mp_úq_cmp
(&
mp_úqs
[
i
], 
m
))

946 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

947 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

948 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

949 
	}
}

951 
__öô
 
	$mp_ovîride_Àgacy_úq
(
u8
 
bus_úq
, u8 
pﬁ¨ôy
, u8 
åiggî
, 
u32
 
gsi
)

953 
iﬂpic
;

954 
pö
;

955 
mpc_öt§c
 
mp_úq
;

960 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

961 i‡(
iﬂpic
 < 0)

963 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

970 i‡((
bus_úq
 =0Ë&& (
åiggî
 == 3))

971 
åiggî
 = 1;

973 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

974 
mp_úq
.
úqty≥
 = 
mp_INT
;

975 
mp_úq
.
úqÊag
 = (
åiggî
 << 2Ë| 
pﬁ¨ôy
;

976 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

977 
mp_úq
.
§cbusúq
 = 
bus_úq
;

978 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

979 
mp_úq
.
d°úq
 = 
pö
;

981 
	`ßve_mp_úq
(&
mp_úq
);

983 
iß_úq_to_gsi
[
bus_úq
] = 
gsi
;

984 
	}
}

986 
__öô
 
	$mp_c⁄fig_a˝i_Àgacy_úqs
()

988 
i
;

989 
mpc_öt§c
 
mp_úq
;

991 #i‡
	`deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

995 
mp_bus_id_to_ty≥
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

997 
	`£t_bô
(
MP_ISA_BUS
, 
mp_bus_nŸ_pci
);

998 
	`¥_debug
("Bu†#%d i†ISA\n", 
MP_ISA_BUS
);

1000 #ifde‡
CONFIG_X86_ES7000


1004 i‡(
es7000_∂©
 == 1)

1012 
i
 = 0; i < 16; i++) {

1013 
iﬂpic
, 
pö
;

1014 
d°≠ic
;

1015 
idx
;

1016 
u32
 
gsi
;

1019 i‡(
	`a˝i_iß_úq_to_gsi
(
i
, &
gsi
))

1025 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1026 i‡(
iﬂpic
 < 0)

1028 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1029 
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1031 
idx
 = 0; idx < 
mp_úq_íåõs
; idx++) {

1032 
mpc_öt§c
 *
úq
 = 
mp_úqs
 + 
idx
;

1035 i‡(
úq
->
§cbus
 =
MP_ISA_BUS
 && irq->
§cbusúq
 =
i
)

1039 i‡(
úq
->
d°≠ic
 =d°≠i¯&& irq->
d°úq
 =
pö
)

1043 i‡(
idx
 !
mp_úq_íåõs
) {

1044 
	`¥ötk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ovîride.\n", 
i
);

1048 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1049 
mp_úq
.
úqÊag
 = 0;

1050 
mp_úq
.
§cbus
 = 
MP_ISA_BUS
;

1051 
mp_úq
.
d°≠ic
 = dstapic;

1052 
mp_úq
.
úqty≥
 = 
mp_INT
;

1053 
mp_úq
.
§cbusúq
 = 
i
;

1054 
mp_úq
.
d°úq
 = 
pö
;

1056 
	`ßve_mp_úq
(&
mp_úq
);

1058 
	}
}

1060 
	$mp_c⁄fig_a˝i_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
,

1061 
pﬁ¨ôy
)

1063 #ifde‡
CONFIG_X86_MPPARSE


1064 
mpc_öt§c
 
mp_úq
;

1065 
pci_dev
 *
pdev
;

1066 
numbî
;

1067 
dev‚
;

1068 
iﬂpic
;

1069 
u8
 
pö
;

1071 i‡(!
a˝i_iﬂpic
)

1073 i‡(!
dev
)

1075 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

1078 
pdev
 = 
	`to_pci_dev
(
dev
);

1079 
numbî
 = 
pdev
->
bus
->number;

1080 
dev‚
 = 
pdev
->devfn;

1081 
pö
 = 
pdev
->pin;

1083 
mp_úq
.
ty≥
 = 
MP_INTSRC
;

1084 
mp_úq
.
úqty≥
 = 
mp_INT
;

1085 
mp_úq
.
úqÊag
 = (
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 4 : 0x0c) |

1086 (
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 1 : 3);

1087 
mp_úq
.
§cbus
 = 
numbî
;

1088 
mp_úq
.
§cbusúq
 = (((
dev‚
 >> 3Ë& 0x1fË<< 2Ë| ((
pö
 - 1) & 3);

1089 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1090 
mp_úq
.
d°≠ic
 = 
mp_iﬂpics
[
iﬂpic
].
≠icid
;

1091 
mp_úq
.
d°úq
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1093 
	`ßve_mp_úq
(&
mp_úq
);

1096 
	}
}

1098 
	$mp_ªgi°î_gsi
(
devi˚
 *
dev
, 
u32
 
gsi
, 
åiggî
, 
pﬁ¨ôy
)

1100 
iﬂpic
;

1101 
iﬂpic_pö
;

1102 
io_≠ic_úq_©å
 
úq_©å
;

1104 i‡(
a˝i_úq_modñ
 !
ACPI_IRQ_MODEL_IOAPIC
)

1105  
gsi
;

1108 i‡(
a˝i_gbl_FADT
.
sci_öãºu±
 =
gsi
)

1109  
gsi
;

1111 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

1112 i‡(
iﬂpic
 < 0) {

1113 
	`¥ötk
(
KERN_WARNING
 "NÿIOAPIC f‹ GSI %u\n", 
gsi
);

1114  
gsi
;

1117 
iﬂpic_pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

1119 i‡(
iﬂpic_pö
 > 
MP_MAX_IOAPIC_PIN
) {

1120 
	`¥ötk
(
KERN_ERR
 "InvalidÑeferenceÅo IOAPICÖin "

1121 "%d-%d\n", 
mp_iﬂpics
[
iﬂpic
].
≠icid
,

1122 
iﬂpic_pö
);

1123  
gsi
;

1126 i‡(
íabÀ_upd©e_m±abÀ
)

1127 
	`mp_c⁄fig_a˝i_gsi
(
dev
, 
gsi
, 
åiggî
, 
pﬁ¨ôy
);

1129 
	`£t_io_≠ic_úq_©å
(&
úq_©å
, 
iﬂpic
, 
iﬂpic_pö
,

1130 
åiggî
 =
ACPI_EDGE_SENSITIVE
 ? 0 : 1,

1131 
pﬁ¨ôy
 =
ACPI_ACTIVE_HIGH
 ? 0 : 1);

1132 
	`io_≠ic_£t_pci_routög
(
dev
, 
	`gsi_to_úq
(
gsi
), &
úq_©å
);

1134  
gsi
;

1135 
	}
}

1141 
__öô
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1143 
cou¡
;

1151 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
)

1152  -
ENODEV
;

1154 i‡(!
˝u_has_≠ic
)

1155  -
ENODEV
;

1160 i‡(
skù_iﬂpic_£tup
) {

1161 
	`¥ötk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPICÖrobe "

1163  -
ENODEV
;

1166 
cou¡
 =

1167 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_IO_APIC
, 
a˝i_∑r£_iﬂpic
,

1168 
MAX_IO_APICS
);

1169 i‡(!
cou¡
) {

1170 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "No IOAPICÉntriesÖresent\n");

1171  -
ENODEV
;

1172 } i‡(
cou¡
 < 0) {

1173 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing IOAPICÉntry\n");

1174  
cou¡
;

1177 
cou¡
 =

1178 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
, 
a˝i_∑r£_öt_§c_ovr
,

1179 
ƒ_úqs
);

1180 i‡(
cou¡
 < 0) {

1181 
	`¥ötk
(
KERN_ERR
 
PREFIX


1184  
cou¡
;

1191 i‡(!
a˝i_sci_ovîride_gsi
)

1192 
	`a˝i_sci_iﬂpic_£tup
(
a˝i_gbl_FADT
.
sci_öãºu±
, 0, 0,

1193 
a˝i_gbl_FADT
.
sci_öãºu±
);

1196 
	`mp_c⁄fig_a˝i_Àgacy_úqs
();

1198 
cou¡
 =

1199 
	`a˝i_èbÀ_∑r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
, 
a˝i_∑r£_nmi_§c
,

1200 
ƒ_úqs
);

1201 i‡(
cou¡
 < 0) {

1202 
	`¥ötk
(
KERN_ERR
 
PREFIX
 "ErrorÖarsing NMI SRCÉntry\n");

1204  
cou¡
;

1208 
	}
}

1210 
ölöe
 
	$a˝i_∑r£_madt_iﬂpic_íåõs
()

1213 
	}
}

1216 
__öô
 
	$óæy_a˝i_¥o˚ss_madt
()

1218 #ifde‡
CONFIG_X86_LOCAL_APIC


1219 
îr‹
;

1221 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1226 
îr‹
 = 
	`óæy_a˝i_∑r£_madt_œpic_addr_ovr
();

1227 i‡(!
îr‹
) {

1228 
a˝i_œpic
 = 1;

1229 
smp_found_c⁄fig
 = 1;

1231 i‡(
îr‹
 =-
EINVAL
) {

1235 
	`¥ötk
(
KERN_ERR
 
PREFIX


1237 
	`dißbÀ_a˝i
();

1241 
	}
}

1243 
__öô
 
	$a˝i_¥o˚ss_madt
()

1245 #ifde‡
CONFIG_X86_LOCAL_APIC


1246 
îr‹
;

1248 i‡(!
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_MADT
, 
a˝i_∑r£_madt
)) {

1253 
îr‹
 = 
	`a˝i_∑r£_madt_œpic_íåõs
();

1254 i‡(!
îr‹
) {

1255 
a˝i_œpic
 = 1;

1260 
îr‹
 = 
	`a˝i_∑r£_madt_iﬂpic_íåõs
();

1261 i‡(!
îr‹
) {

1262 
a˝i_úq_modñ
 = 
ACPI_IRQ_MODEL_IOAPIC
;

1263 
a˝i_iﬂpic
 = 1;

1265 
smp_found_c⁄fig
 = 1;

1268 i‡(
îr‹
 =-
EINVAL
) {

1272 
	`¥ötk
(
KERN_ERR
 
PREFIX


1274 
	`dißbÀ_a˝i
();

1282 i‡(
smp_found_c⁄fig
) {

1283 
	`¥ötk
(
KERN_WARNING
 
PREFIX


1285 
smp_found_c⁄fig
 = 0;

1293 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

1294 
	`¥ötk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration "

1296 i‡(
a˝i_œpic
)

1297 
	`¥ötk
(
KERN_INFO
 "Using ACPI forÖrocessor (LAPIC) "

1301 
	}
}

1303 
__öô
 
	$dißbÀ_a˝i_úq
(c⁄° 
dmi_sy°em_id
 *
d
)

1305 i‡(!
a˝i_f‹˚
) {

1306 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofácpi=noirq\n",

1307 
d
->
idít
);

1308 
	`a˝i_noúq_£t
();

1311 
	}
}

1313 
__öô
 
	$dißbÀ_a˝i_pci
(c⁄° 
dmi_sy°em_id
 *
d
)

1315 i‡(!
a˝i_f‹˚
) {

1316 
	`¥ötk
(
KERN_NOTICE
 "%s detected: force use ofÖci=noacpi\n",

1317 
d
->
idít
);

1318 
	`a˝i_dißbÀ_pci
();

1321 
	}
}

1323 
__öô
 
	$dmi_dißbÀ_a˝i
(c⁄° 
dmi_sy°em_id
 *
d
)

1325 i‡(!
a˝i_f‹˚
) {

1326 
	`¥ötk
(
KERN_NOTICE
 "%†dëe˘ed:á˝òoff\n", 
d
->
idít
);

1327 
	`dißbÀ_a˝i
();

1329 
	`¥ötk
(
KERN_NOTICE


1333 
	}
}

1338 
__öô
 
	$dmi_ign‹e_úq0_timî_ovîride
(c⁄° 
dmi_sy°em_id
 *
d
)

1344 i‡(!
a˝i_skù_timî_ovîride
) {

1345 
	`WARN
(1, 
KERN_ERR
 "ati_ixp4x0 quirkÇot complete.\n");

1346 
	`¥_nŸi˚
("%s detected: Ignoring BIOS IRQ0Öin2 override\n",

1347 
d
->
idít
);

1348 
a˝i_skù_timî_ovîride
 = 1;

1351 
	}
}

1357 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ
[] = {

1362 .
ˇŒback
 = 
dmi_dißbÀ_a˝i
,

1363 .
	gidít
 = "IBM Thinkpad",

1364 .
	gm©ches
 = {

1365 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1366 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

1374 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1375 .
	gidít
 = "ASUS A7V",

1376 .
	gm©ches
 = {

1377 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

1378 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

1380 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1391 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1392 .
	gidít
 = "IBM Thinkpad 600 Series 2645",

1393 .
	gm©ches
 = {

1394 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1395 
DMI_MATCH
(
DMI_BOARD_NAME
, "2645"),

1399 .
	gˇŒback
 = 
dißbÀ_a˝i_úq
,

1400 .
	gidít
 = "IBM Thinkpad 600 Series 2646",

1401 .
	gm©ches
 = {

1402 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

1403 
DMI_MATCH
(
DMI_BOARD_NAME
, "2646"),

1410 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1411 .
	gidít
 = "ASUS PR-DLS",

1412 .
	gm©ches
 = {

1413 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

1414 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

1415 
DMI_MATCH
(
DMI_BIOS_VERSION
,

1417 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

1421 .
	gˇŒback
 = 
dißbÀ_a˝i_pci
,

1422 .
	gidít
 = "Acer TravelMate 36x Laptop",

1423 .
	gm©ches
 = {

1424 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

1425 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

1432 
dmi_sy°em_id
 
__öôd©a
 
	ga˝i_dmi_èbÀ_œã
[] = {

1444 .
ˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1445 .
	gidít
 = "HPÇx6115Üaptop",

1446 .
	gm©ches
 = {

1447 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1448 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6115"),

1452 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1453 .
	gidít
 = "HP NX6125Üaptop",

1454 .
	gm©ches
 = {

1455 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1456 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6125"),

1460 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1461 .
	gidít
 = "HP NX6325Üaptop",

1462 .
	gm©ches
 = {

1463 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1464 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP CompaqÇx6325"),

1468 .
	gˇŒback
 = 
dmi_ign‹e_úq0_timî_ovîride
,

1469 .
	gidít
 = "HP 6715bÜaptop",

1470 .
	gm©ches
 = {

1471 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

1472 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq 6715b"),

1497 
__öô
 
	$a˝i_boŸ_èbÀ_öô
()

1499 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ
);

1504 i‡(
a˝i_dißbÀd
)

1510 i‡(
	`a˝i_èbÀ_öô
()) {

1511 
	`dißbÀ_a˝i
();

1515 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1520 i‡(
	`a˝i_bœckli°ed
()) {

1521 i‡(
a˝i_f‹˚
) {

1522 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

1524 
	`¥ötk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

1525 
	`dißbÀ_a˝i
();

1529 
	}
}

1531 
__öô
 
	$óæy_a˝i_boŸ_öô
()

1536 i‡(
a˝i_dißbÀd
)

1542 
	`óæy_a˝i_¥o˚ss_madt
();

1545 
	}
}

1547 
__öô
 
	$a˝i_boŸ_öô
()

1550 
	`dmi_check_sy°em
(
a˝i_dmi_èbÀ_œã
);

1555 i‡(
a˝i_dißbÀd
)

1558 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_BOOT
, 
a˝i_∑r£_sbf
);

1563 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_FADT
, 
a˝i_∑r£_Ádt
);

1568 
	`a˝i_¥o˚ss_madt
();

1570 
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
a˝i_∑r£_h≥t
);

1572 i‡(!
a˝i_noúq
)

1573 
x86_öô
.
pci
.
öô
 = 
pci_a˝i_öô
;

1576 
	}
}

1578 
__öô
 
	$∑r£_a˝i
(*
¨g
)

1580 i‡(!
¨g
)

1581  -
EINVAL
;

1584 i‡(
	`°rcmp
(
¨g
, "off") == 0) {

1585 
	`dißbÀ_a˝i
();

1588 i‡(
	`°rcmp
(
¨g
, "force") == 0) {

1589 
a˝i_f‹˚
 = 1;

1590 
a˝i_dißbÀd
 = 0;

1593 i‡(
	`°rcmp
(
¨g
, "strict") == 0) {

1594 
a˝i_°ri˘
 = 1;

1597 i‡(
	`°rcmp
(
¨g
, "rsdt") == 0) {

1598 
a˝i_rsdt_f‹˚d
 = 1;

1601 i‡(
	`°rcmp
(
¨g
, "noirq") == 0) {

1602 
	`a˝i_noúq_£t
();

1605 i‡(
	`°rcmp
(
¨g
, "copy_dsdt") == 0) {

1606 
a˝i_gbl_c›y_dsdt_loˇŒy
 = 1;

1609  -
EINVAL
;

1612 
	}
}

1613 
óæy_∑øm
("a˝i", 
∑r£_a˝i
);

1616 
__öô
 
	$∑r£_pci
(*
¨g
)

1618 i‡(
¨g
 && 
	`°rcmp
(arg, "noacpi") == 0)

1619 
	`a˝i_dißbÀ_pci
();

1621 
	}
}

1622 
óæy_∑øm
("pci", 
∑r£_pci
);

1624 
__öô
 
	$a˝i_mps_check
()

1626 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& !deföed(
CONFIG_X86_MPPARSE
)

1628 i‡(
a˝i_dißbÀd
 || 
a˝i_noúq
) {

1629 
	`¥ötk
(
KERN_WARNING
 "MPS support code isÇot built-in.\n"

1636 
	}
}

1638 #ifde‡
CONFIG_X86_IO_APIC


1639 
__öô
 
	$∑r£_a˝i_skù_timî_ovîride
(*
¨g
)

1641 
a˝i_skù_timî_ovîride
 = 1;

1643 
	}
}

1644 
óæy_∑øm
("a˝i_skù_timî_ovîride", 
∑r£_a˝i_skù_timî_ovîride
);

1646 
__öô
 
	$∑r£_a˝i_u£_timî_ovîride
(*
¨g
)

1648 
a˝i_u£_timî_ovîride
 = 1;

1650 
	}
}

1651 
óæy_∑øm
("a˝i_u£_timî_ovîride", 
∑r£_a˝i_u£_timî_ovîride
);

1654 
__öô
 
	$£tup_a˝i_sci
(*
s
)

1656 i‡(!
s
)

1657  -
EINVAL
;

1658 i‡(!
	`°rcmp
(
s
, "edge"))

1659 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_EDGE
 |

1660 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1661 i‡(!
	`°rcmp
(
s
, "level"))

1662 
a˝i_sci_Êags
 = 
ACPI_MADT_TRIGGER_LEVEL
 |

1663 (
a˝i_sci_Êags
 & ~
ACPI_MADT_TRIGGER_MASK
);

1664 i‡(!
	`°rcmp
(
s
, "high"))

1665 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_HIGH
 |

1666 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1667 i‡(!
	`°rcmp
(
s
, "low"))

1668 
a˝i_sci_Êags
 = 
ACPI_MADT_POLARITY_ACTIVE_LOW
 |

1669 (
a˝i_sci_Êags
 & ~
ACPI_MADT_POLARITY_MASK
);

1671  -
EINVAL
;

1673 
	}
}

1674 
óæy_∑øm
("a˝i_sci", 
£tup_a˝i_sci
);

1676 
	$__a˝i_acquúe_globÆ_lock
(*
lock
)

1678 
ﬁd
, 
√w
, 
vÆ
;

1680 
ﬁd
 = *
lock
;

1681 
√w
 = (((
ﬁd
 & ~0x3) + 2) + ((old >> 1) & 0x1));

1682 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1683 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1684  (
√w
 < 3) ? -1 : 0;

1685 
	}
}

1687 
	$__a˝i_ªÀa£_globÆ_lock
(*
lock
)

1689 
ﬁd
, 
√w
, 
vÆ
;

1691 
ﬁd
 = *
lock
;

1692 
√w
 = 
ﬁd
 & ~0x3;

1693 
vÆ
 = 
	`cmpxchg
(
lock
, 
ﬁd
, 
√w
);

1694 } 
	`u∆ikñy
 (
vÆ
 !
ﬁd
));

1695  
ﬁd
 & 0x1;

1696 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/cstate.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/a˝i.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/sched.h
>

14 
	~<a˝i/¥o˚ss‹.h
>

15 
	~<asm/a˝i.h
>

27 
	$a˝i_¥o˚ss‹_powî_öô_bm_check
(
a˝i_¥o˚ss‹_Êags
 *
Êags
,

28 
˝u
)

30 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

32 
Êags
->
bm_check
 = 0;

33 i‡(
	`num_⁄löe_˝us
() == 1)

34 
Êags
->
bm_check
 = 1;

35 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

41 
Êags
->
bm_check
 = 1;

50 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

51 (
c
->
x86
 > 0x‡|| (c->x86 =6 && c->
x86_modñ
 >= 0x0f)))

52 
Êags
->
bm_c⁄åﬁ
 = 0;

53 
	}
}

54 
EXPORT_SYMBOL
(
a˝i_¥o˚ss‹_powî_öô_bm_check
);

58 
	sc°©e_íåy
 {

60 
	móx
;

61 
	mecx
;

62 } 
	m°©es
[
ACPI_PROCESSOR_MAX_POWER
];

64 
c°©e_íåy
 *
	g˝u_c°©e_íåy
;

66 
	gmwaô_suµ‹ãd
[
ACPI_PROCESSOR_MAX_POWER
];

68 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

69 
	#MWAIT_CSTATE_MASK
 (0xf)

	)

70 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

72 
	#CPUID_MWAIT_LEAF
 (5)

	)

73 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

74 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

76 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

78 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

80 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
(*
_cx
)

82 
a˝i_¥o˚ss‹_cx
 *
cx
 = 
_cx
;

83 
ªtvÆ
;

84 
óx
, 
ebx
, 
ecx
, 
edx
;

85 
edx_∑π
;

86 
c°©e_ty≥
;

87 
num_c°©e_subty≥
;

89 
	`˝uid
(
CPUID_MWAIT_LEAF
, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
c°©e_ty≥
 = ((
cx
->
addªss
 >> 
MWAIT_SUBSTATE_SIZE
) &

93 
MWAIT_CSTATE_MASK
) + 1;

94 
edx_∑π
 = 
edx
 >> (
c°©e_ty≥
 * 
MWAIT_SUBSTATE_SIZE
);

95 
num_c°©e_subty≥
 = 
edx_∑π
 & 
MWAIT_SUBSTATE_MASK
;

97 
ªtvÆ
 = 0;

98 i‡(
num_c°©e_subty≥
 < (
cx
->
addªss
 & 
MWAIT_SUBSTATE_MASK
)) {

99 
ªtvÆ
 = -1;

100 
out
;

104 i‡(!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

105 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
)) {

106 
ªtvÆ
 = -1;

107 
out
;

110 i‡(!
mwaô_suµ‹ãd
[
c°©e_ty≥
]) {

111 
mwaô_suµ‹ãd
[
c°©e_ty≥
] = 1;

112 
	`¥ötk
(
KERN_DEBUG


114 "°©e\n", 
cx
->
ty≥
);

116 
	`¢¥ötf
(
cx
->
desc
,

117 
ACPI_CX_DESC_LEN
, "ACPI FFH INTEL MWAIT 0x%x",

118 
cx
->
addªss
);

119 
out
:

120  
ªtvÆ
;

121 
	}
}

123 
	$a˝i_¥o˚ss‹_ffh_c°©e_¥obe
(
˝u
,

124 
a˝i_¥o˚ss‹_cx
 *
cx
, 
a˝i_powî_ªgi°î
 *
ªg
)

126 
c°©e_íåy
 *
≥r˝u_íåy
;

127 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

128 
ªtvÆ
;

130 i‡(!
˝u_c°©e_íåy
 || 
c
->
˝uid_Àvñ
 < 
CPUID_MWAIT_LEAF
)

133 i‡(
ªg
->
bô_off£t
 !
NATIVE_CSTATE_BEYOND_HALT
)

136 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

137 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = 0;

138 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 0;

142 
ªtvÆ
 = 
	`w‹k_⁄_˝u
(
˝u
, 
a˝i_¥o˚ss‹_ffh_c°©e_¥obe_˝u
, 
cx
);

143 i‡(
ªtvÆ
 == 0) {

145 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
 = cx->
addªss
;

146 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
 = 
MWAIT_ECX_INTERRUPT_BREAK
;

154 i‡((
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
Ë&& !(
ªg
->
ac˚ss_size
 & 0x2))

155 
cx
->
bm_°s_skù
 = 1;

157  
ªtvÆ
;

158 
	}
}

159 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_¥obe
);

161 
	$a˝i_¥o˚ss‹_ffh_c°©e_íãr
(
a˝i_¥o˚ss‹_cx
 *
cx
)

163 
˝u
 = 
	`smp_¥o˚ss‹_id
();

164 
c°©e_íåy
 *
≥r˝u_íåy
;

166 
≥r˝u_íåy
 = 
	`≥r_˝u_±r
(
˝u_c°©e_íåy
, 
˝u
);

167 
	`mwaô_idÀ_wôh_höts
(
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
óx
,

168 
≥r˝u_íåy
->
°©es
[
cx
->
ödex
].
ecx
);

169 
	}
}

170 
EXPORT_SYMBOL_GPL
(
a˝i_¥o˚ss‹_ffh_c°©e_íãr
);

172 
__öô
 
	$ffh_c°©e_öô
()

174 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

175 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
)

178 
˝u_c°©e_íåy
 = 
	`Æloc_≥r˝u
(
c°©e_íåy
);

180 
	}
}

182 
__exô
 
	$ffh_c°©e_exô
()

184 
	`‰ì_≥r˝u
(
˝u_c°©e_íåy
);

185 
˝u_c°©e_íåy
 = 
NULL
;

186 
	}
}

188 
¨ch_öôˇŒ
(
ffh_c°©e_öô
);

189 
__exôˇŒ
(
ffh_c°©e_exô
);

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c

1 
	~"../../../boŸ/ªgs.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c

1 
	~"../../../boŸ/video-bios.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c

1 
	~"../../../boŸ/video-mode.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c

1 
	~"../../../boŸ/video-veß.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c

1 
	~"../../../boŸ/video-vga.c
"

	@/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c

1 
	~"wakeup.h
"

2 
	~"boŸ.h
"

4 
	$udñay
(
lo›s
)

6 
lo›s
--)

7 
	`io_dñay
();

8 
	}
}

10 
	$bìp
(
hz
)

12 
u8
 
íabÀ
;

14 i‡(!
hz
) {

15 
íabÀ
 = 0x00;

17 
u16
 
div
 = 1193181/
hz
;

19 
	`outb
(0xb6, 0x43);

20 
	`io_dñay
();

21 
	`outb
(
div
, 0x42);

22 
	`io_dñay
();

23 
	`outb
(
div
 >> 8, 0x42);

24 
	`io_dñay
();

26 
íabÀ
 = 0x03;

28 
	`öb
(0x61);

29 
	`io_dñay
();

30 
	`outb
(
íabÀ
, 0x61);

31 
	`io_dñay
();

32 
	}
}

34 
	#DOT_HZ
 880

	)

35 
	#DASH_HZ
 587

	)

36 
	#US_PER_DOT
 125000

	)

39 
	$£nd_m‹£
(c⁄° *
∑âîn
)

41 
s
;

43 (
s
 = *
∑âîn
++)) {

44 
s
) {

46 
	`bìp
(
DOT_HZ
);

47 
	`udñay
(
US_PER_DOT
);

48 
	`bìp
(0);

49 
	`udñay
(
US_PER_DOT
);

52 
	`bìp
(
DASH_HZ
);

53 
	`udñay
(
US_PER_DOT
 * 3);

54 
	`bìp
(0);

55 
	`udñay
(
US_PER_DOT
);

58 
	`udñay
(
US_PER_DOT
 * 3);

62 
	}
}

64 
	$maö
()

67 i‡(
wakeup_hódî
.
ªÆ_magic
 != 0x12345678)

70 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 4)

71 
	`£nd_m‹£
("...-");

73 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 1)

74 
asm
 volatile("lcallw $0xc000,$3");

76 i‡(
wakeup_hódî
.
ªÆmode_Êags
 & 2) {

78 
	`¥obe_ˇrds
(0);

79 
	`£t_mode
(
wakeup_hódî
.
video_mode
);

81 
	}
}

	@/cmpt816/linux/arch/x86/kernel/acpi/sleep.c

8 
	~<löux/a˝i.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/dmi.h
>

11 
	~<löux/˝umask.h
>

12 
	~<asm/£gmít.h
>

13 
	~<asm/desc.h
>

15 
	~"ªÆmode/wakeup.h
"

16 
	~"¶ìp.h
"

18 
	ga˝i_wakeup_addªss
;

19 
	ga˝i_ªÆmode_Êags
;

22 
	ga˝i_ªÆmode
;

24 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_64BIT
)

25 
	gãmp_°ack
[4096];

36 
	$a˝i_ßve_°©e_mem
()

38 
wakeup_hódî
 *
hódî
;

40 i‡(!
a˝i_ªÆmode
) {

41 
	`¥ötk
(
KERN_ERR
 "CouldÇotállocate memory during boot, "

43  -
ENOMEM
;

45 
	`mem˝y
((*)
a˝i_ªÆmode
, &
wakeup_code_°¨t
, 
WAKEUP_SIZE
);

47 
hódî
 = (
wakeup_hódî
 *)(
a˝i_ªÆmode
 + 
HEADER_OFFSET
);

48 i‡(
hódî
->
sig«tuª
 != 0x51ee1111) {

49 
	`¥ötk
(
KERN_ERR
 "wakeup header doesÇot match\n");

50  -
EINVAL
;

53 
hódî
->
video_mode
 = 
ßved_video_mode
;

55 
hódî
->
wakeup_jmp_£g
 = 
a˝i_wakeup_addªss
 >> 4;

66 
hódî
->
wakeup_gdt
[0] =

67 (
u64
)((
hódî
->
wakeup_gdt
) - 1) +

68 ((
u64
)(
a˝i_wakeup_addªss
 +

69 ((*)&
hódî
->
wakeup_gdt
 - (*)
a˝i_ªÆmode
))

72 
hódî
->
wakeup_gdt
[1] =

73 
	`GDT_ENTRY
(0x809b, 
a˝i_wakeup_addªss
, 0xfffff);

75 
hódî
->
wakeup_gdt
[2] =

76 
	`GDT_ENTRY
(0x8093, 
a˝i_wakeup_addªss
, 0xfffff);

78 #i‚de‡
CONFIG_64BIT


79 
	`°‹e_gdt
((
desc_±r
 *)&
hódî
->
pmode_gdt
);

81 i‡(
	`rdm§_ß„
(
MSR_EFER
, &
hódî
->
pmode_e„r_low
,

82 &
hódî
->
pmode_e„r_high
))

83 
hódî
->
pmode_e„r_low
 = hódî->
pmode_e„r_high
 = 0;

86 
hódî
->
pmode_¸0
 = 
	`ªad_¸0
();

87 
hódî
->
pmode_¸4
 = 
	`ªad_¸4_ß„
();

88 
hódî
->
ªÆmode_Êags
 = 
a˝i_ªÆmode_Êags
;

89 
hódî
->
ªÆ_magic
 = 0x12345678;

91 #i‚de‡
CONFIG_64BIT


92 
hódî
->
pmode_íåy
 = (
u32
)&
wakeup_pmode_ªtu∫
;

93 
hódî
->
pmode_¸3
 = (
u32
)(
swsu•_pg_dú
 - 
__PAGE_OFFSET
);

94 
ßved_magic
 = 0x12345678;

96 
hódî
->
åampﬁöe_£gmít
 = 
	`£tup_åampﬁöe
() >> 4;

97 #ifde‡
CONFIG_SMP


98 
°ack_°¨t
.
•
 = 
ãmp_°ack
 + (temp_stack);

99 
óæy_gdt_des¸
.
addªss
 =

100 ()
	`gë_˝u_gdt_èbÀ
(
	`smp_¥o˚ss‹_id
());

101 
öôül_gs
 = 
	`≥r_˝u_off£t
(
	`smp_¥o˚ss‹_id
());

103 
öôül_code
 = ()
wakeup_l⁄g64
;

104 
ßved_magic
 = 0x123456789abcdef0L;

108 
	}
}

113 
	$a˝i_ª°‹e_°©e_mem
()

115 
	}
}

126 
__öô
 
	$a˝i_ª£rve_wakeup_mem‹y
()

128 
mem
;

130 i‡((&
wakeup_code_íd
 - &
wakeup_code_°¨t
Ë> 
WAKEUP_SIZE
) {

131 
	`¥ötk
(
KERN_ERR


136 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
WAKEUP_SIZE
, 
PAGE_SIZE
);

138 i‡(
mem
 == -1L) {

139 
	`¥ötk
(
KERN_ERR
 "ACPI: CannotállocateÜowmem, S3 disabled.\n");

142 
a˝i_ªÆmode
 = (Ë
	`phys_to_vút
(
mem
);

143 
a˝i_wakeup_addªss
 = 
mem
;

144 
	`ª£rve_óæy
(
mem
, mem + 
WAKEUP_SIZE
, "ACPI WAKEUP");

145 
	}
}

148 
__öô
 
	$a˝i_¶ìp_£tup
(*
°r
)

150 (
°r
 !
NULL
) && (*str != '\0')) {

151 i‡(
	`°∫cmp
(
°r
, "s3_bios", 7) == 0)

152 
a˝i_ªÆmode_Êags
 |= 1;

153 i‡(
	`°∫cmp
(
°r
, "s3_mode", 7) == 0)

154 
a˝i_ªÆmode_Êags
 |= 2;

155 i‡(
	`°∫cmp
(
°r
, "s3_beep", 7) == 0)

156 
a˝i_ªÆmode_Êags
 |= 4;

157 #ifde‡
CONFIG_HIBERNATION


158 i‡(
	`°∫cmp
(
°r
, "s4_nohwsig", 10) == 0)

159 
	`a˝i_no_s4_hw_sig«tuª
();

160 i‡(
	`°∫cmp
(
°r
, "s4_nonvs", 8) == 0) {

161 
	`¥_w¨nög
("ACPI:ácpi_sleep=s4_nonvs is deprecated, "

163 
	`a˝i_nvs_noßve
();

166 i‡(
	`°∫cmp
(
°r
, "nonvs", 5) == 0)

167 
	`a˝i_nvs_noßve
();

168 i‡(
	`°∫cmp
(
°r
, "old_ordering", 12) == 0)

169 
	`a˝i_ﬁd_su•íd_‹dîög
();

170 
°r
 = 
	`°rchr
(str, ',');

171 i‡(
°r
 !
NULL
)

172 
°r
 +
	`°r•n
(str, ", \t");

175 
	}
}

177 
__£tup
("a˝i_¶ìp=", 
a˝i_¶ìp_£tup
);

	@/cmpt816/linux/arch/x86/kernel/alternative.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/muãx.h
>

4 
	~<löux/li°.h
>

5 
	~<löux/°rögify.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/mm.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~<löux/mem‹y.h
>

10 
	~<löux/°›_machöe.h
>

11 
	~<löux/¶ab.h
>

12 
	~<asm/Æã∫©ive.h
>

13 
	~<asm/£˘i⁄s.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/nmi.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/ˇcheÊush.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/io.h
>

21 
	~<asm/fixm≠.h
>

23 
	#MAX_PATCH_LEN
 (255-1)

	)

25 #ifde‡
CONFIG_HOTPLUG_CPU


26 
	gsmp_Æt_⁄˚
;

28 
__öô
 
	$boŸ⁄ly
(*
°r
)

30 
smp_Æt_⁄˚
 = 1;

32 
	}
}

33 
__£tup
("smp-Æt-boŸ", 
boŸ⁄ly
);

35 
	#smp_Æt_⁄˚
 1

	)

38 
__öôd©a_‹_moduÀ
 
	gdebug_Æã∫©ive
;

40 
__öô
 
	$debug_Æt
(*
°r
)

42 
debug_Æã∫©ive
 = 1;

44 
	}
}

45 
__£tup
("debug-Æã∫©ive", 
debug_Æt
);

47 
	gn‹ïœ˚_smp
;

49 
__öô
 
	$£tup_n‹ïœ˚_smp
(*
°r
)

51 
n‹ïœ˚_smp
 = 1;

53 
	}
}

54 
__£tup
("n‹ïœ˚-smp", 
£tup_n‹ïœ˚_smp
);

56 #ifde‡
CONFIG_PARAVIRT


57 
__öôd©a_‹_moduÀ
 
	gn‹ïœ˚_∑øvút
 = 0;

59 
__öô
 
	$£tup_n‹ïœ˚_∑øvút
(*
°r
)

61 
n‹ïœ˚_∑øvút
 = 1;

63 
	}
}

64 
__£tup
("n‹ïœ˚-∑øvút", 
£tup_n‹ïœ˚_∑øvút
);

67 
	#DPRINTK
(
fmt
, 
¨gs
...Ëi‡(
debug_Æã∫©ive
) \

68 
	`¥ötk
(
KERN_DEBUG
 
fmt
, 
¨gs
)

	)

70 #i‡
deföed
(
GENERIC_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

74 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nintelnops: "

75 
GENERIC_NOP1
 
GENERIC_NOP2
 
GENERIC_NOP3
 
GENERIC_NOP4
 
GENERIC_NOP5
 
GENERIC_NOP6


76 
GENERIC_NOP7
 
GENERIC_NOP8


78 c⁄° 
öã ›s
[];

79 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


80 
	göãl_n›s
[
ASM_NOP_MAX
+1] = {

81 
NULL
,

82 
öã ›s
,

83 
öã ›s
 + 1,

84 
öã ›s
 + 1 + 2,

85 
öã ›s
 + 1 + 2 + 3,

86 
öã ›s
 + 1 + 2 + 3 + 4,

87 
öã ›s
 + 1 + 2 + 3 + 4 + 5,

88 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6,

89 
öã ›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

93 #ifde‡
K8_NOP1


94 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk8nops: "

95 
K8_NOP1
 
K8_NOP2
 
K8_NOP3
 
K8_NOP4
 
K8_NOP5
 
K8_NOP6


96 
K8_NOP7
 
K8_NOP8


98 c⁄° 
k8n›s
[];

99 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


100 
	gk8_n›s
[
ASM_NOP_MAX
+1] = {

101 
NULL
,

102 
k8n›s
,

103 
k8n›s
 + 1,

104 
k8n›s
 + 1 + 2,

105 
k8n›s
 + 1 + 2 + 3,

106 
k8n›s
 + 1 + 2 + 3 + 4,

107 
k8n›s
 + 1 + 2 + 3 + 4 + 5,

108 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

109 
k8n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

113 #i‡
deföed
(
K7_NOP1
Ë&& !deföed(
CONFIG_X86_64
)

114 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\nk7nops: "

115 
K7_NOP1
 
K7_NOP2
 
K7_NOP3
 
K7_NOP4
 
K7_NOP5
 
K7_NOP6


116 
K7_NOP7
 
K7_NOP8


118 c⁄° 
k7n›s
[];

119 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


120 
	gk7_n›s
[
ASM_NOP_MAX
+1] = {

121 
NULL
,

122 
k7n›s
,

123 
k7n›s
 + 1,

124 
k7n›s
 + 1 + 2,

125 
k7n›s
 + 1 + 2 + 3,

126 
k7n›s
 + 1 + 2 + 3 + 4,

127 
k7n›s
 + 1 + 2 + 3 + 4 + 5,

128 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

129 
k7n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

133 #ifde‡
P6_NOP1


134 
asm
("\t" 
__°rögify
(
__INITRODATA_OR_MODULE
) "\np6nops: "

135 
P6_NOP1
 
P6_NOP2
 
P6_NOP3
 
P6_NOP4
 
P6_NOP5
 
P6_NOP6


136 
P6_NOP7
 
P6_NOP8


138 c⁄° 
p6n›s
[];

139 c⁄° *c⁄° 
__öôc⁄°_‹_moduÀ


140 
	gp6_n›s
[
ASM_NOP_MAX
+1] = {

141 
NULL
,

142 
p6n›s
,

143 
p6n›s
 + 1,

144 
p6n›s
 + 1 + 2,

145 
p6n›s
 + 1 + 2 + 3,

146 
p6n›s
 + 1 + 2 + 3 + 4,

147 
p6n›s
 + 1 + 2 + 3 + 4 + 5,

148 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6,

149 
p6n›s
 + 1 + 2 + 3 + 4 + 5 + 6 + 7,

153 #ifde‡
CONFIG_X86_64


155 
__vsysˇŒ_0
;

156 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

158 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

159 
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

160  
p6_n›s
;

162  
k8_n›s
;

163 
	}
}

167 c⁄° *c⁄° *
__öô_‹_moduÀ
 
	$föd_n›_èbÀ
()

169 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K8
))

170  
k8_n›s
;

171 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_K7
))

172  
k7_n›s
;

173 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_NOPL
))

174  
p6_n›s
;

176  
öãl_n›s
;

177 
	}
}

182 
__öô_‹_moduÀ
 
	$add_n›s
(*
ö¢s
, 
Àn
)

184 c⁄° *c⁄° *
n›èbÀ
 = 
	`föd_n›_èbÀ
();

186 
Àn
 > 0) {

187 
n›Àn
 = 
Àn
;

188 i‡(
n›Àn
 > 
ASM_NOP_MAX
)

189 
n›Àn
 = 
ASM_NOP_MAX
;

190 
	`mem˝y
(
ö¢s
, 
n›èbÀ
[
n›Àn
],Çoplen);

191 
ö¢s
 +
n›Àn
;

192 
Àn
 -
n›Àn
;

194 
	}
}

196 
Æt_ö°r
 
__Æt_ö°ru˘i⁄s
[], 
__Æt_ö°ru˘i⁄s_íd
[];

197 
s32
 
__smp_locks
[], 
__smp_locks_íd
[];

198 *
ãxt_poke_óæy
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
);

206 
__öô_‹_moduÀ
 
	$≠∂y_Æã∫©ives
(
Æt_ö°r
 *
°¨t
,

207 
Æt_ö°r
 *
íd
)

209 
Æt_ö°r
 *
a
;

210 
u8
 
ö¢buf
[
MAX_PATCH_LEN
];

212 
	`DPRINTK
("%s:á…ÅabÀ %∞-> %p\n", 
__func__
, 
°¨t
, 
íd
);

213 
a
 = 
°¨t
;á < 
íd
;á++) {

214 
u8
 *
ö°r
 = 
a
->instr;

215 
	`BUG_ON
(
a
->
ª∂a˚míéí
 >á->
ö°æí
);

216 
	`BUG_ON
(
a
->
ö°æí
 > (
ö¢buf
));

217 i‡(!
	`boŸ_˝u_has
(
a
->
˝uid
))

219 #ifde‡
CONFIG_X86_64


221 i‡(
ö°r
 >(
u8
 *)
VSYSCALL_START
 && in°∏< (u8*)
VSYSCALL_END
) {

222 
ö°r
 = 
	`__va
(ö°∏- (
u8
*)
VSYSCALL_START
 + (u8*)
	`__∑_symbﬁ
(&
__vsysˇŒ_0
));

223 
	`DPRINTK
("%s: vsyscall fixup: %p => %p\n",

224 
__func__
, 
a
->
ö°r
, instr);

227 
	`mem˝y
(
ö¢buf
, 
a
->
ª∂a˚mít
,á->
ª∂a˚míéí
);

228 i‡(*
ö¢buf
 =0xe8 && 
a
->
ª∂a˚míéí
 == 5)

229 *(
s32
 *)(
ö¢buf
 + 1Ë+
a
->
ª∂a˚mít
 -á->
ö°r
;

230 
	`add_n›s
(
ö¢buf
 + 
a
->
ª∂a˚míéí
,

231 
a
->
ö°æí
 -á->
ª∂a˚míéí
);

232 
	`ãxt_poke_óæy
(
ö°r
, 
ö¢buf
, 
a
->
ö°æí
);

234 
	}
}

236 #ifde‡
CONFIG_SMP


238 
	$Æã∫©ives_smp_lock
(c⁄° 
s32
 *
°¨t
, c⁄° s32 *
íd
,

239 
u8
 *
ãxt
, u8 *
ãxt_íd
)

241 c⁄° 
s32
 *
poff
;

243 
	`muãx_lock
(&
ãxt_muãx
);

244 
poff
 = 
°¨t
;Öof‡< 
íd
;Öoff++) {

245 
u8
 *
±r
 = (u8 *)
poff
 + *poff;

247 i‡(!*
poff
 || 
±r
 < 
ãxt
 ||Öå >
ãxt_íd
)

250 i‡(*
±r
 == 0x3e)

251 
	`ãxt_poke
(
±r
, (([]){0xf0}), 1);

253 
	`muãx_u∆ock
(&
ãxt_muãx
);

254 
	}
}

256 
	$Æã∫©ives_smp_u∆ock
(c⁄° 
s32
 *
°¨t
, c⁄° s32 *
íd
,

257 
u8
 *
ãxt
, u8 *
ãxt_íd
)

259 c⁄° 
s32
 *
poff
;

261 i‡(
n‹ïœ˚_smp
)

264 
	`muãx_lock
(&
ãxt_muãx
);

265 
poff
 = 
°¨t
;Öof‡< 
íd
;Öoff++) {

266 
u8
 *
±r
 = (u8 *)
poff
 + *poff;

268 i‡(!*
poff
 || 
±r
 < 
ãxt
 ||Öå >
ãxt_íd
)

271 i‡(*
±r
 == 0xf0)

272 
	`ãxt_poke
(
±r
, (([]){0x3E}), 1);

274 
	`muãx_u∆ock
(&
ãxt_muãx
);

275 
	}
}

277 
	ssmp_Æt_moduÀ
 {

279 
moduÀ
 *
	mmod
;

280 *
	m«me
;

283 c⁄° 
s32
 *
	mlocks
;

284 c⁄° 
s32
 *
	mlocks_íd
;

287 
u8
 *
	mãxt
;

288 
u8
 *
	mãxt_íd
;

290 
li°_hód
 
	m√xt
;

292 
LIST_HEAD
(
smp_Æt_moduÀs
);

293 
DEFINE_MUTEX
(
smp_Æt
);

294 
	gsmp_mode
 = 1;

296 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_add
(
moduÀ
 *
mod
,

297 *
«me
,

298 *
locks
, *
locks_íd
,

299 *
ãxt
, *
ãxt_íd
)

301 
smp_Æt_moduÀ
 *
smp
;

303 i‡(
n‹ïœ˚_smp
)

306 i‡(
smp_Æt_⁄˚
) {

307 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

308 
	`Æã∫©ives_smp_u∆ock
(
locks
, 
locks_íd
,

309 
ãxt
, 
ãxt_íd
);

313 
smp
 = 
	`kzÆloc
((*smp), 
GFP_KERNEL
);

314 i‡(
NULL
 =
smp
)

317 
smp
->
mod
 = mod;

318 
smp
->
«me
 =Çame;

319 
smp
->
locks
 =Üocks;

320 
smp
->
locks_íd
 =Üocks_end;

321 
smp
->
ãxt
 =Åext;

322 
smp
->
ãxt_íd
 =Åext_end;

323 
	`DPRINTK
("%s:Üocks %p -> %p,Åext %p -> %p,Çame %s\n",

324 
__func__
, 
smp
->
locks
, smp->
locks_íd
,

325 
smp
->
ãxt
, smp->
ãxt_íd
, smp->
«me
);

327 
	`muãx_lock
(&
smp_Æt
);

328 
	`li°_add_èû
(&
smp
->
√xt
, &
smp_Æt_moduÀs
);

329 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_UP
))

330 
	`Æã∫©ives_smp_u∆ock
(
smp
->
locks
, smp->
locks_íd
,

331 
smp
->
ãxt
, smp->
ãxt_íd
);

332 
	`muãx_u∆ock
(&
smp_Æt
);

333 
	}
}

335 
__öô_‹_moduÀ
 
	$Æã∫©ives_smp_moduÀ_dñ
(
moduÀ
 *
mod
)

337 
smp_Æt_moduÀ
 *
ôem
;

339 i‡(
smp_Æt_⁄˚
 || 
n‹ïœ˚_smp
)

342 
	`muãx_lock
(&
smp_Æt
);

343 
	`li°_f‹_óch_íåy
(
ôem
, &
smp_Æt_moduÀs
, 
√xt
) {

344 i‡(
mod
 !
ôem
->mod)

346 
	`li°_dñ
(&
ôem
->
√xt
);

347 
	`muãx_u∆ock
(&
smp_Æt
);

348 
	`DPRINTK
("%s: %s\n", 
__func__
, 
ôem
->
«me
);

349 
	`k‰ì
(
ôem
);

352 
	`muãx_u∆ock
(&
smp_Æt
);

353 
	}
}

355 
	$Æã∫©ives_smp_swôch
(
smp
)

357 
smp_Æt_moduÀ
 *
mod
;

359 #ifde‡
CONFIG_LOCKDEP


367 
	`¥ötk
("lockdep: fixing upálternatives.\n");

370 i‡(
n‹ïœ˚_smp
 || 
smp_Æt_⁄˚
)

372 
	`BUG_ON
(!
smp
 && (
	`num_⁄löe_˝us
() > 1));

374 
	`muãx_lock
(&
smp_Æt
);

380 i‡(
smp
 =
smp_mode
) {

382 } i‡(
smp
) {

383 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo SMP code\n");

384 
	`˛ór_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

385 
	`˛ór_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

386 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

387 
	`Æã∫©ives_smp_lock
(
mod
->
locks
, mod->
locks_íd
,

388 
mod
->
ãxt
, mod->
ãxt_íd
);

390 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

391 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

392 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

393 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
)

394 
	`Æã∫©ives_smp_u∆ock
(
mod
->
locks
, mod->
locks_íd
,

395 
mod
->
ãxt
, mod->
ãxt_íd
);

397 
smp_mode
 = 
smp
;

398 
	`muãx_u∆ock
(&
smp_Æt
);

399 
	}
}

402 
	$Æã∫©ives_ãxt_ª£rved
(*
°¨t
, *
íd
)

404 
smp_Æt_moduÀ
 *
mod
;

405 c⁄° 
s32
 *
poff
;

406 
u8
 *
ãxt_°¨t
 = 
°¨t
;

407 
u8
 *
ãxt_íd
 = 
íd
;

409 
	`li°_f‹_óch_íåy
(
mod
, &
smp_Æt_moduÀs
, 
√xt
) {

410 i‡(
mod
->
ãxt
 > 
ãxt_íd
 || mod->ãxt_íd < 
ãxt_°¨t
)

412 
poff
 = 
mod
->
locks
;Öof‡< mod->
locks_íd
;Öoff++) {

413 c⁄° 
u8
 *
±r
 = (c⁄° u8 *)
poff
 + *poff;

415 i‡(
ãxt_°¨t
 <
±r
 && 
ãxt_íd
 >Ötr)

421 
	}
}

424 #ifde‡
CONFIG_PARAVIRT


425 
__öô_‹_moduÀ
 
	$≠∂y_∑øvút
(
∑øvút_∑tch_sôe
 *
°¨t
,

426 
∑øvút_∑tch_sôe
 *
íd
)

428 
∑øvút_∑tch_sôe
 *
p
;

429 
ö¢buf
[
MAX_PATCH_LEN
];

431 i‡(
n‹ïœ˚_∑øvút
)

434 
p
 = 
°¨t
;Ö < 
íd
;Ö++) {

435 
u£d
;

437 
	`BUG_ON
(
p
->
Àn
 > 
MAX_PATCH_LEN
);

439 
	`mem˝y
(
ö¢buf
, 
p
->
ö°r
,Ö->
Àn
);

440 
u£d
 = 
pv_öô_›s
.
	`∑tch
(
p
->
ö°πy≥
,Ö->
˛obbîs
, 
ö¢buf
,

441 ()
p
->
ö°r
,Ö->
Àn
);

443 
	`BUG_ON
(
u£d
 > 
p
->
Àn
);

446 
	`add_n›s
(
ö¢buf
 + 
u£d
, 
p
->
Àn
 - used);

447 
	`ãxt_poke_óæy
(
p
->
ö°r
, 
ö¢buf
,Ö->
Àn
);

449 
	}
}

450 
∑øvút_∑tch_sôe
 
__°¨t_∑øö°ru˘i⁄s
[],

451 
__°›_∑øö°ru˘i⁄s
[];

454 
__öô
 
	$Æã∫©ive_ö°ru˘i⁄s
()

459 
	`°›_nmi
();

472 
	`≠∂y_Æã∫©ives
(
__Æt_ö°ru˘i⁄s
, 
__Æt_ö°ru˘i⁄s_íd
);

477 #ifde‡
CONFIG_HOTPLUG_CPU


478 i‡(
	`num_possibÀ_˝us
() < 2)

479 
smp_Æt_⁄˚
 = 1;

482 #ifde‡
CONFIG_SMP


483 i‡(
smp_Æt_⁄˚
) {

484 i‡(1 =
	`num_possibÀ_˝us
()) {

485 
	`¥ötk
(
KERN_INFO
 "SMPálternatives: switchingÅo UP code\n");

486 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_UP
);

487 
	`£t_˝u_ˇp
(&
	`˝u_d©a
(0), 
X86_FEATURE_UP
);

489 
	`Æã∫©ives_smp_u∆ock
(
__smp_locks
, 
__smp_locks_íd
,

490 
_ãxt
, 
_ëext
);

493 
	`Æã∫©ives_smp_moduÀ_add
(
NULL
, "core kernel",

494 
__smp_locks
, 
__smp_locks_íd
,

495 
_ãxt
, 
_ëext
);

498 i‡(
	`num_¥e£¡_˝us
(Ë=1 || 
£tup_max_˝us
 <= 1)

499 
	`Æã∫©ives_smp_swôch
(0);

502 
	`≠∂y_∑øvút
(
__∑øö°ru˘i⁄s
, 
__∑øö°ru˘i⁄s_íd
);

504 i‡(
smp_Æt_⁄˚
)

505 
	`‰ì_öô_∑ges
("SMPálternatives",

506 ()
__smp_locks
,

507 ()
__smp_locks_íd
);

509 
	`ª°¨t_nmi
();

510 
	}
}

524 *
__öô_‹_moduÀ
 
	$ãxt_poke_óæy
(*
addr
, c⁄° *
›code
,

525 
size_t
 
Àn
)

527 
Êags
;

528 
	`loˇl_úq_ßve
(
Êags
);

529 
	`mem˝y
(
addr
, 
›code
, 
Àn
);

530 
	`sync_c‹e
();

531 
	`loˇl_úq_ª°‹e
(
Êags
);

534  
addr
;

535 
	}
}

550 *
__k¥obes
 
	$ãxt_poke
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

552 
Êags
;

553 *
vaddr
;

554 
∑ge
 *
∑ges
[2];

555 
i
;

557 i‡(!
	`c‹e_kî√l_ãxt
(()
addr
)) {

558 
∑ges
[0] = 
	`vmÆloc_to_∑ge
(
addr
);

559 
∑ges
[1] = 
	`vmÆloc_to_∑ge
(
addr
 + 
PAGE_SIZE
);

561 
∑ges
[0] = 
	`vút_to_∑ge
(
addr
);

562 
	`WARN_ON
(!
	`PageRe£rved
(
∑ges
[0]));

563 
∑ges
[1] = 
	`vút_to_∑ge
(
addr
 + 
PAGE_SIZE
);

565 
	`BUG_ON
(!
∑ges
[0]);

566 
	`loˇl_úq_ßve
(
Êags
);

567 
	`£t_fixm≠
(
FIX_TEXT_POKE0
, 
	`∑ge_to_phys
(
∑ges
[0]));

568 i‡(
∑ges
[1])

569 
	`£t_fixm≠
(
FIX_TEXT_POKE1
, 
	`∑ge_to_phys
(
∑ges
[1]));

570 
vaddr
 = (*)
	`fix_to_vút
(
FIX_TEXT_POKE0
);

571 
	`mem˝y
(&
vaddr
[()
addr
 & ~
PAGE_MASK
], 
›code
, 
Àn
);

572 
	`˛ór_fixm≠
(
FIX_TEXT_POKE0
);

573 i‡(
∑ges
[1])

574 
	`˛ór_fixm≠
(
FIX_TEXT_POKE1
);

575 
	`loˇl_Êush_éb
();

576 
	`sync_c‹e
();

579 
i
 = 0; i < 
Àn
; i++)

580 
	`BUG_ON
(((*)
addr
)[
i
] !((*)
›code
)[i]);

581 
	`loˇl_úq_ª°‹e
(
Êags
);

582  
addr
;

583 
	}
}

589 
©omic_t
 
	g°›_machöe_fú°
;

590 
	gwrŸe_ãxt
;

592 
	sãxt_poke_∑øms
 {

593 *
	maddr
;

594 c⁄° *
	m›code
;

595 
size_t
 
	mÀn
;

598 
__k¥obes
 
	$°›_machöe_ãxt_poke
(*
d©a
)

600 
ãxt_poke_∑øms
 *
çp
 = 
d©a
;

602 i‡(
	`©omic_dec_™d_ã°
(&
°›_machöe_fú°
)) {

603 
	`ãxt_poke
(
çp
->
addr
,Åµ->
›code
,Åµ->
Àn
);

604 
	`smp_wmb
();

605 
wrŸe_ãxt
 = 1;

607 !
wrŸe_ãxt
)

608 
	`˝u_ªœx
();

609 
	`smp_mb
();

612 
	`Êush_iˇche_ønge
(()
çp
->
addr
,

613 ()
çp
->
addr
 +Åµ->
Àn
);

615 
	}
}

630 *
__k¥obes
 
	$ãxt_poke_smp
(*
addr
, c⁄° *
›code
, 
size_t
 
Àn
)

632 
ãxt_poke_∑øms
 
çp
;

634 
çp
.
addr
 =áddr;

635 
çp
.
›code
 = opcode;

636 
çp
.
Àn
 =Üen;

637 
	`©omic_£t
(&
°›_machöe_fú°
, 1);

638 
wrŸe_ãxt
 = 0;

639 
	`°›_machöe
(
°›_machöe_ãxt_poke
, (*)&
çp
, 
NULL
);

640  
addr
;

641 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu.c

20 
	~<löux/pci.h
>

21 
	~<löux/bôm≠.h
>

22 
	~<löux/¶ab.h
>

23 
	~<löux/debugfs.h
>

24 
	~<löux/sˇâîli°.h
>

25 
	~<löux/dma-m≠pög.h
>

26 
	~<löux/iommu-hñ≥r.h
>

27 
	~<löux/iommu.h
>

28 
	~<asm/¥Ÿo.h
>

29 
	~<asm/iommu.h
>

30 
	~<asm/g¨t.h
>

31 
	~<asm/amd_iommu_¥Ÿo.h
>

32 
	~<asm/amd_iommu_ty≥s.h
>

33 
	~<asm/amd_iommu.h
>

35 
	#CMD_SET_TYPE
(
cmd
, 
t
Ë((cmd)->
d©a
[1] |(—Ë<< 28))

	)

37 
	#EXIT_LOOP_COUNT
 10000000

	)

39 
DEFINE_RWLOCK
(
amd_iommu_devèbÀ_lock
);

42 
LIST_HEAD
(
iommu_pd_li°
);

43 
DEFINE_SPINLOCK
(
iommu_pd_li°_lock
);

49 
¥Ÿe˘i⁄_domaö
 *
	g±_domaö
;

51 
iommu_›s
 
	gamd_iommu_›s
;

56 
	siommu_cmd
 {

57 
u32
 
	md©a
[4];

60 
ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
);

61 
upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
);

69 
ölöe
 
u16
 
	$gë_devi˚_id
(
devi˚
 *
dev
)

71 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

73  
	`ˇlc_devid
(
pdev
->
bus
->
numbî
,Ödev->
dev‚
);

74 
	}
}

76 
iommu_dev_d©a
 *
	$gë_dev_d©a
(
devi˚
 *
dev
)

78  
dev
->
¨chd©a
.
iommu
;

79 
	}
}

85 
dma_›s_domaö
 *
	$föd_¥Ÿe˘i⁄_domaö
(
u16
 
devid
)

87 
dma_›s_domaö
 *
íåy
, *
ªt
 = 
NULL
;

88 
Êags
;

89 
u16
 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

91 i‡(
	`li°_em±y
(&
iommu_pd_li°
))

92  
NULL
;

94 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

96 
	`li°_f‹_óch_íåy
(
íåy
, &
iommu_pd_li°
, 
li°
) {

97 i‡(
íåy
->
èrgë_dev
 =
devid
 ||

98 
íåy
->
èrgë_dev
 =
Æüs
) {

99 
ªt
 = 
íåy
;

104 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

106  
ªt
;

107 
	}
}

113 
boﬁ
 
	$check_devi˚
(
devi˚
 *
dev
)

115 
u16
 
devid
;

117 i‡(!
dev
 || !dev->
dma_mask
)

118  
Ál£
;

121 i‡(
dev
->
bus
 !&
pci_bus_ty≥
)

122  
Ál£
;

124 
devid
 = 
	`gë_devi˚_id
(
dev
);

127 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

128  
Ál£
;

130 i‡(
amd_iommu_æookup_èbÀ
[
devid
] =
NULL
)

131  
Ál£
;

133  
åue
;

134 
	}
}

136 
	$iommu_öô_devi˚
(
devi˚
 *
dev
)

138 
iommu_dev_d©a
 *
dev_d©a
;

139 
pci_dev
 *
pdev
;

140 
u16
 
devid
, 
Æüs
;

142 i‡(
dev
->
¨chd©a
.
iommu
)

145 
dev_d©a
 = 
	`kzÆloc
((*dev_d©a), 
GFP_KERNEL
);

146 i‡(!
dev_d©a
)

147  -
ENOMEM
;

149 
dev_d©a
->
dev
 = dev;

151 
devid
 = 
	`gë_devi˚_id
(
dev
);

152 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

153 
pdev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
Æüs
),álias & 0xff);

154 i‡(
pdev
)

155 
dev_d©a
->
Æüs
 = &
pdev
->
dev
;

157 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

159 
dev
->
¨chd©a
.
iommu
 = 
dev_d©a
;

163 
	}
}

165 
	$iommu_unöô_devi˚
(
devi˚
 *
dev
)

167 
	`k‰ì
(
dev
->
¨chd©a
.
iommu
);

168 
	}
}

170 
__öô
 
	$amd_iommu_unöô_devi˚s
()

172 
pci_dev
 *
pdev
 = 
NULL
;

174 
	`f‹_óch_pci_dev
(
pdev
) {

176 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

179 
	`iommu_unöô_devi˚
(&
pdev
->
dev
);

181 
	}
}

183 
__öô
 
	$amd_iommu_öô_devi˚s
()

185 
pci_dev
 *
pdev
 = 
NULL
;

186 
ªt
 = 0;

188 
	`f‹_óch_pci_dev
(
pdev
) {

190 i‡(!
	`check_devi˚
(&
pdev
->
dev
))

193 
ªt
 = 
	`iommu_öô_devi˚
(&
pdev
->
dev
);

194 i‡(
ªt
)

195 
out_‰ì
;

200 
out_‰ì
:

202 
	`amd_iommu_unöô_devi˚s
();

204  
ªt
;

205 
	}
}

206 #ifde‡
CONFIG_AMD_IOMMU_STATS


212 
DECLARE_STATS_COUNTER
(
com∂_waô
);

213 
DECLARE_STATS_COUNTER
(
˙t_m≠_sögÀ
);

214 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

215 
DECLARE_STATS_COUNTER
(
˙t_m≠_sg
);

216 
DECLARE_STATS_COUNTER
(
˙t_unm≠_sg
);

217 
DECLARE_STATS_COUNTER
(
˙t_Æloc_cohîít
);

218 
DECLARE_STATS_COUNTER
(
˙t_‰ì_cohîít
);

219 
DECLARE_STATS_COUNTER
(
¸oss_∑ge
);

220 
DECLARE_STATS_COUNTER
(
domaö_Êush_sögÀ
);

221 
DECLARE_STATS_COUNTER
(
domaö_Êush_Æl
);

222 
DECLARE_STATS_COUNTER
(
Ælo˚d_io_mem
);

223 
DECLARE_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

225 
díåy
 *
	g°©s_dú
;

226 
díåy
 *
	gde_fÊush
;

228 
	$amd_iommu_°©s_add
(
__iommu_cou¡î
 *
˙t
)

230 i‡(
°©s_dú
 =
NULL
)

233 
˙t
->
dít
 = 
	`debugfs_¸óã_u64
(˙t->
«me
, 0444, 
°©s_dú
,

234 &
˙t
->
vÆue
);

235 
	}
}

237 
	$amd_iommu_°©s_öô
()

239 
°©s_dú
 = 
	`debugfs_¸óã_dú
("amd-iommu", 
NULL
);

240 i‡(
°©s_dú
 =
NULL
)

243 
de_fÊush
 = 
	`debugfs_¸óã_boﬁ
("fuŒÊush", 0444, 
°©s_dú
,

244 (
u32
 *)&
amd_iommu_unm≠_Êush
);

246 
	`amd_iommu_°©s_add
(&
com∂_waô
);

247 
	`amd_iommu_°©s_add
(&
˙t_m≠_sögÀ
);

248 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sögÀ
);

249 
	`amd_iommu_°©s_add
(&
˙t_m≠_sg
);

250 
	`amd_iommu_°©s_add
(&
˙t_unm≠_sg
);

251 
	`amd_iommu_°©s_add
(&
˙t_Æloc_cohîít
);

252 
	`amd_iommu_°©s_add
(&
˙t_‰ì_cohîít
);

253 
	`amd_iommu_°©s_add
(&
¸oss_∑ge
);

254 
	`amd_iommu_°©s_add
(&
domaö_Êush_sögÀ
);

255 
	`amd_iommu_°©s_add
(&
domaö_Êush_Æl
);

256 
	`amd_iommu_°©s_add
(&
Ælo˚d_io_mem
);

257 
	`amd_iommu_°©s_add
(&
tŸÆ_m≠_ªque°s
);

258 
	}
}

268 
	$dump_dã_íåy
(
u16
 
devid
)

270 
i
;

272 
i
 = 0; i < 8; ++i)

273 
	`¥_îr
("AMD-Vi: DTE[%d]: %08x\n", 
i
,

274 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
]);

275 
	}
}

277 
	$dump_comm™d
(
phys_addr
)

279 
iommu_cmd
 *
cmd
 = 
	`phys_to_vút
(
phys_addr
);

280 
i
;

282 
i
 = 0; i < 4; ++i)

283 
	`¥_îr
("AMD-Vi: CMD[%d]: %08x\n", 
i
, 
cmd
->
d©a
[i]);

284 
	}
}

286 
	$iommu_¥öt_evít
(
amd_iommu
 *
iommu
, *
__evt
)

288 
u32
 *
evít
 = 
__evt
;

289 
ty≥
 = (
evít
[1] >> 
EVENT_TYPE_SHIFT
Ë& 
EVENT_TYPE_MASK
;

290 
devid
 = (
evít
[0] >> 
EVENT_DEVID_SHIFT
Ë& 
EVENT_DEVID_MASK
;

291 
domid
 = (
evít
[1] >> 
EVENT_DOMID_SHIFT
Ë& 
EVENT_DOMID_MASK
;

292 
Êags
 = (
evít
[1] >> 
EVENT_FLAGS_SHIFT
Ë& 
EVENT_FLAGS_MASK
;

293 
u64
 
addªss
 = (u64)(((u64)
evít
[3]) << 32) |Évent[2];

295 
	`¥ötk
(
KERN_ERR
 "AMD-Vi: EventÜogged [");

297 
ty≥
) {

298 
EVENT_TYPE_ILL_DEV
:

299 
	`¥ötk
("ILLEGAL_DEV_TABLE_ENTRY device=%02x:%02x.%x "

301 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

302 
addªss
, 
Êags
);

303 
	`dump_dã_íåy
(
devid
);

305 
EVENT_TYPE_IO_FAULT
:

306 
	`¥ötk
("IO_PAGE_FAULT device=%02x:%02x.%x "

308 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

309 
domid
, 
addªss
, 
Êags
);

311 
EVENT_TYPE_DEV_TAB_ERR
:

312 
	`¥ötk
("DEV_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

314 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

315 
addªss
, 
Êags
);

317 
EVENT_TYPE_PAGE_TAB_ERR
:

318 
	`¥ötk
("PAGE_TAB_HARDWARE_ERROR device=%02x:%02x.%x "

320 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

321 
domid
, 
addªss
, 
Êags
);

323 
EVENT_TYPE_ILL_CMD
:

324 
	`¥ötk
("ILLEGAL_COMMAND_ERRORáddªss=0x%016Œx]\n", 
addªss
);

325 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

326 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

327 
	`dump_comm™d
(
addªss
);

329 
EVENT_TYPE_CMD_HARD_ERR
:

330 
	`¥ötk
("COMMAND_HARDWARE_ERRORáddress=0x%016llx "

331 "Êags=0x%04x]\n", 
addªss
, 
Êags
);

333 
EVENT_TYPE_IOTLB_INV_TO
:

334 
	`¥ötk
("IOTLB_INV_TIMEOUT device=%02x:%02x.%x "

336 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

337 
addªss
);

339 
EVENT_TYPE_INV_DEV_REQ
:

340 
	`¥ötk
("INVALID_DEVICE_REQUEST device=%02x:%02x.%x "

342 
	`PCI_BUS
(
devid
), 
	`PCI_SLOT
(devid), 
	`PCI_FUNC
(devid),

343 
addªss
, 
Êags
);

346 
	`¥ötk
(
KERN_ERR
 "UNKNOWNÅy≥=0x%02x]\n", 
ty≥
);

348 
	}
}

350 
	$iommu_pﬁl_evíts
(
amd_iommu
 *
iommu
)

352 
u32
 
hód
, 
èû
;

353 
Êags
;

355 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

357 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

358 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

360 
hód
 !
èû
) {

361 
	`iommu_¥öt_evít
(
iommu
, iommu->
evt_buf
 + 
hód
);

362 
hód
 = (hód + 
EVENT_ENTRY_SIZE
Ë% 
iommu
->
evt_buf_size
;

365 
	`wrôñ
(
hód
, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

367 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

368 
	}
}

370 
úqªtu∫_t
 
	$amd_iommu_öt_h™dÀr
(
úq
, *
d©a
)

372 
amd_iommu
 *
iommu
;

374 
	`f‹_óch_iommu
(
iommu
)

375 
	`iommu_pﬁl_evíts
(
iommu
);

377  
IRQ_HANDLED
;

378 
	}
}

390 
	$__iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

392 
u32
 
èû
, 
hód
;

393 
u8
 *
èrgë
;

395 
	`WARN_ON
(
iommu
->
cmd_buf_size
 & 
CMD_BUFFER_UNINITIALIZED
);

396 
èû
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

397 
èrgë
 = 
iommu
->
cmd_buf
 + 
èû
;

398 
	`mem˝y_toio
(
èrgë
, 
cmd
, (*cmd));

399 
èû
 = (èû + (*
cmd
)Ë% 
iommu
->
cmd_buf_size
;

400 
hód
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

401 i‡(
èû
 =
hód
)

402  -
ENOMEM
;

403 
	`wrôñ
(
èû
, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

406 
	}
}

412 
	$iommu_queue_comm™d
(
amd_iommu
 *
iommu
, 
iommu_cmd
 *
cmd
)

414 
Êags
;

415 
ªt
;

417 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

418 
ªt
 = 
	`__iommu_queue_comm™d
(
iommu
, 
cmd
);

419 i‡(!
ªt
)

420 
iommu
->
√ed_sync
 = 
åue
;

421 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

423  
ªt
;

424 
	}
}

430 
	$__iommu_waô_f‹_com∂ëi⁄
(
amd_iommu
 *
iommu
)

432 
ªady
 = 0;

433 
°©us
 = 0;

434 
i
 = 0;

436 
	`INC_STATS_COUNTER
(
com∂_waô
);

438 !
ªady
 && (
i
 < 
EXIT_LOOP_COUNT
)) {

439 ++
i
;

441 
°©us
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

442 
ªady
 = 
°©us
 & 
MMIO_STATUS_COM_WAIT_INT_MASK
;

446 
°©us
 &~
MMIO_STATUS_COM_WAIT_INT_MASK
;

447 
	`wrôñ
(
°©us
, 
iommu
->
mmio_ba£
 + 
MMIO_STATUS_OFFSET
);

449 i‡(
	`u∆ikñy
(
i
 =
EXIT_LOOP_COUNT
))

450 
iommu
->
ª£t_ö_¥ogªss
 = 
åue
;

451 
	}
}

457 
	$__iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

459 
iommu_cmd
 
cmd
;

461 
	`mem£t
(&
cmd
, 0, (cmd));

462 
cmd
.
d©a
[0] = 
CMD_COMPL_WAIT_INT_MASK
;

463 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_COMPL_WAIT
);

465  
	`__iommu_queue_comm™d
(
iommu
, &
cmd
);

466 
	}
}

475 
	$iommu_com∂ëi⁄_waô
(
amd_iommu
 *
iommu
)

477 
ªt
 = 0;

478 
Êags
;

480 
	`•ö_lock_úqßve
(&
iommu
->
lock
, 
Êags
);

482 i‡(!
iommu
->
√ed_sync
)

483 
out
;

485 
ªt
 = 
	`__iommu_com∂ëi⁄_waô
(
iommu
);

487 
iommu
->
√ed_sync
 = 
Ál£
;

489 i‡(
ªt
)

490 
out
;

492 
	`__iommu_waô_f‹_com∂ëi⁄
(
iommu
);

494 
out
:

495 
	`•ö_u∆ock_úqª°‹e
(&
iommu
->
lock
, 
Êags
);

497 i‡(
iommu
->
ª£t_ö_¥ogªss
)

498 
	`ª£t_iommu_comm™d_buf„r
(
iommu
);

501 
	}
}

503 
	$iommu_Êush_com∂ëe
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

505 
i
;

507 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

508 i‡(!
domaö
->
dev_iommu
[
i
])

515 
	`iommu_com∂ëi⁄_waô
(
amd_iommus
[
i
]);

517 
	}
}

522 
	$iommu_Êush_devi˚
(
devi˚
 *
dev
)

524 
amd_iommu
 *
iommu
;

525 
iommu_cmd
 
cmd
;

526 
u16
 
devid
;

528 
devid
 = 
	`gë_devi˚_id
(
dev
);

529 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

532 
	`mem£t
(&
cmd
, 0, (cmd));

533 
	`CMD_SET_TYPE
(&
cmd
, 
CMD_INV_DEV_ENTRY
);

534 
cmd
.
d©a
[0] = 
devid
;

536  
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

537 
	}
}

539 
	$__iommu_buûd_öv_iommu_∑ges
(
iommu_cmd
 *
cmd
, 
u64
 
addªss
,

540 
u16
 
domid
, 
pde
, 
s
)

542 
	`mem£t
(
cmd
, 0, (*cmd));

543 
addªss
 &
PAGE_MASK
;

544 
	`CMD_SET_TYPE
(
cmd
, 
CMD_INV_IOMMU_PAGES
);

545 
cmd
->
d©a
[1] |
domid
;

546 
cmd
->
d©a
[2] = 
	`lowî_32_bôs
(
addªss
);

547 
cmd
->
d©a
[3] = 
	`uµî_32_bôs
(
addªss
);

548 i‡(
s
)

549 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_SIZE_MASK
;

550 i‡(
pde
)

551 
cmd
->
d©a
[2] |
CMD_INV_IOMMU_PAGES_PDE_MASK
;

552 
	}
}

557 
	$iommu_queue_öv_iommu_∑ges
(
amd_iommu
 *
iommu
,

558 
u64
 
addªss
, 
u16
 
domid
, 
pde
, 
s
)

560 
iommu_cmd
 
cmd
;

561 
ªt
;

563 
	`__iommu_buûd_öv_iommu_∑ges
(&
cmd
, 
addªss
, 
domid
, 
pde
, 
s
);

565 
ªt
 = 
	`iommu_queue_comm™d
(
iommu
, &
cmd
);

567  
ªt
;

568 
	}
}

575 
	$__iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

576 
u64
 
addªss
, 
size_t
 
size
, 
pde
)

578 
s
 = 0, 
i
;

579 
∑ges
 = 
	`iommu_num_∑ges
(
addªss
, 
size
, 
PAGE_SIZE
);

581 
addªss
 &
PAGE_MASK
;

583 i‡(
∑ges
 > 1) {

588 
addªss
 = 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
;

589 
s
 = 1;

593 
i
 = 0; i < 
amd_iommus_¥e£¡
; ++i) {

594 i‡(!
domaö
->
dev_iommu
[
i
])

601 
	`iommu_queue_öv_iommu_∑ges
(
amd_iommus
[
i
], 
addªss
,

602 
domaö
->
id
, 
pde
, 
s
);

606 
	}
}

608 
	$iommu_Êush_∑ges
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

609 
u64
 
addªss
, 
size_t
 
size
)

611 
	`__iommu_Êush_∑ges
(
domaö
, 
addªss
, 
size
, 0);

612 
	}
}

615 
	$iommu_Êush_éb
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

617 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 0);

618 
	}
}

621 
	$iommu_Êush_éb_pde
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

623 
	`__iommu_Êush_∑ges
(
domaö
, 0, 
CMD_INV_IOMMU_ALL_PAGES_ADDRESS
, 1);

624 
	}
}

630 
	$iommu_Êush_domaö_devi˚s
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

632 
iommu_dev_d©a
 *
dev_d©a
;

633 
Êags
;

635 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

637 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
)

638 
	`iommu_Êush_devi˚
(
dev_d©a
->
dev
);

640 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

641 
	}
}

643 
	$iommu_Êush_Æl_domaö_devi˚s
()

645 
¥Ÿe˘i⁄_domaö
 *
domaö
;

646 
Êags
;

648 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

650 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

651 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

652 
	`iommu_Êush_com∂ëe
(
domaö
);

655 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

656 
	}
}

658 
	$amd_iommu_Êush_Æl_devi˚s
()

660 
	`iommu_Êush_Æl_domaö_devi˚s
();

661 
	}
}

667 
	$amd_iommu_Êush_Æl_domaös
()

669 
¥Ÿe˘i⁄_domaö
 *
domaö
;

670 
Êags
;

672 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

674 
	`li°_f‹_óch_íåy
(
domaö
, &
amd_iommu_pd_li°
, 
li°
) {

675 
	`•ö_lock
(&
domaö
->
lock
);

676 
	`iommu_Êush_éb_pde
(
domaö
);

677 
	`iommu_Êush_com∂ëe
(
domaö
);

678 
	`•ö_u∆ock
(&
domaö
->
lock
);

681 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

682 
	}
}

684 
	$ª£t_iommu_comm™d_buf„r
(
amd_iommu
 *
iommu
)

686 
	`¥_îr
("AMD-Vi: Resetting IOMMU command buffer\n");

688 i‡(
iommu
->
ª£t_ö_¥ogªss
)

689 
	`∑nic
("AMD-Vi: ILLEGAL_COMMAND_ERROR whileÑesetting command buffer\n");

691 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

692 
	`amd_iommu_Êush_Æl_devi˚s
();

693 
	`amd_iommu_Êush_Æl_domaös
();

695 
iommu
->
ª£t_ö_¥ogªss
 = 
Ál£
;

696 
	}
}

710 
boﬁ
 
	$ö¸ó£_addªss_•a˚
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

711 
gÂ_t
 
gÂ
)

713 
u64
 *
±e
;

715 i‡(
domaö
->
mode
 =
PAGE_MODE_6_LEVEL
)

717  
Ál£
;

719 
±e
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

720 i‡(!
±e
)

721  
Ál£
;

723 *
±e
 = 
	`PM_LEVEL_PDE
(
domaö
->
mode
,

724 
	`vút_to_phys
(
domaö
->
±_roŸ
));

725 
domaö
->
±_roŸ
 = 
±e
;

726 
domaö
->
mode
 += 1;

727 
domaö
->
upd©ed
 = 
åue
;

729  
åue
;

730 
	}
}

732 
u64
 *
	$Æloc_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
,

733 
addªss
,

734 
∑ge_size
,

735 
u64
 **
±e_∑ge
,

736 
gÂ_t
 
gÂ
)

738 
Àvñ
, 
íd_lvl
;

739 
u64
 *
±e
, *
∑ge
;

741 
	`BUG_ON
(!
	`is_powî_of_2
(
∑ge_size
));

743 
addªss
 > 
	`PM_LEVEL_SIZE
(
domaö
->
mode
))

744 
	`ö¸ó£_addªss_•a˚
(
domaö
, 
gÂ
);

746 
Àvñ
 = 
domaö
->
mode
 - 1;

747 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

748 
addªss
 = 
	`PAGE_SIZE_ALIGN
◊ddªss, 
∑ge_size
);

749 
íd_lvl
 = 
	`PAGE_SIZE_LEVEL
(
∑ge_size
);

751 
Àvñ
 > 
íd_lvl
) {

752 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
)) {

753 
∑ge
 = (
u64
 *)
	`gë_zî€d_∑ge
(
gÂ
);

754 i‡(!
∑ge
)

755  
NULL
;

756 *
±e
 = 
	`PM_LEVEL_PDE
(
Àvñ
, 
	`vút_to_phys
(
∑ge
));

760 i‡(
	`PM_PTE_LEVEL
(*
±e
Ë!
Àvñ
)

761  
NULL
;

763 
Àvñ
 -= 1;

765 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

767 i‡(
±e_∑ge
 && 
Àvñ
 =
íd_lvl
)

768 *
±e_∑ge
 = 
±e
;

770 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

773  
±e
;

774 
	}
}

780 
u64
 *
	$„tch_±e
(
¥Ÿe˘i⁄_domaö
 *
domaö
, 
addªss
)

782 
Àvñ
;

783 
u64
 *
±e
;

785 i‡(
addªss
 > 
	`PM_LEVEL_SIZE
(
domaö
->
mode
))

786  
NULL
;

788 
Àvñ
 = 
domaö
->
mode
 - 1;

789 
±e
 = &
domaö
->
±_roŸ
[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

791 
Àvñ
 > 0) {

794 i‡(!
	`IOMMU_PTE_PRESENT
(*
±e
))

795  
NULL
;

798 i‡(
	`PM_PTE_LEVEL
(*
±e
) == 0x07) {

799 
±e_mask
, 
__±e
;

805 
±e_mask
 = 
	`PTE_PAGE_SIZE
(*
±e
);

806 
±e_mask
 = ~((
	`PAGE_SIZE_PTE_COUNT
(pte_mask) << 3) - 1);

807 
__±e
 = (()
±e
Ë& 
±e_mask
;

809  (
u64
 *)
__±e
;

813 i‡(
	`PM_PTE_LEVEL
(*
±e
Ë!
Àvñ
)

814  
NULL
;

816 
Àvñ
 -= 1;

819 
±e
 = 
	`IOMMU_PTE_PAGE
(*pte);

820 
±e
 = &±e[
	`PM_LEVEL_INDEX
(
Àvñ
, 
addªss
)];

823  
±e
;

824 
	}
}

833 
	$iommu_m≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

834 
bus_addr
,

835 
phys_addr
,

836 
¥Ÿ
,

837 
∑ge_size
)

839 
u64
 
__±e
, *
±e
;

840 
i
, 
cou¡
;

842 i‡(!(
¥Ÿ
 & 
IOMMU_PROT_MASK
))

843  -
EINVAL
;

845 
bus_addr
 = 
	`PAGE_ALIGN
(bus_addr);

846 
phys_addr
 = 
	`PAGE_ALIGN
(phys_addr);

847 
cou¡
 = 
	`PAGE_SIZE_PTE_COUNT
(
∑ge_size
);

848 
±e
 = 
	`Æloc_±e
(
dom
, 
bus_addr
, 
∑ge_size
, 
NULL
, 
GFP_KERNEL
);

850 
i
 = 0; i < 
cou¡
; ++i)

851 i‡(
	`IOMMU_PTE_PRESENT
(
±e
[
i
]))

852  -
EBUSY
;

854 i‡(
∑ge_size
 > 
PAGE_SIZE
) {

855 
__±e
 = 
	`PAGE_SIZE_PTE
(
phys_addr
, 
∑ge_size
);

856 
__±e
 |
	`PM_LEVEL_ENC
(7Ë| 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

858 
__±e
 = 
phys_addr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

860 i‡(
¥Ÿ
 & 
IOMMU_PROT_IR
)

861 
__±e
 |
IOMMU_PTE_IR
;

862 i‡(
¥Ÿ
 & 
IOMMU_PROT_IW
)

863 
__±e
 |
IOMMU_PTE_IW
;

865 
i
 = 0; i < 
cou¡
; ++i)

866 
±e
[
i
] = 
__±e
;

868 
	`upd©e_domaö
(
dom
);

871 
	}
}

873 
	$iommu_unm≠_∑ge
(
¥Ÿe˘i⁄_domaö
 *
dom
,

874 
bus_addr
,

875 
∑ge_size
)

877 
unm≠_size
, 
unm≠≥d
;

878 
u64
 *
±e
;

880 
	`BUG_ON
(!
	`is_powî_of_2
(
∑ge_size
));

882 
unm≠≥d
 = 0;

884 
unm≠≥d
 < 
∑ge_size
) {

886 
±e
 = 
	`„tch_±e
(
dom
, 
bus_addr
);

888 i‡(!
±e
) {

893 
unm≠_size
 = 
PAGE_SIZE
;

894 } i‡(
	`PM_PTE_LEVEL
(*
±e
) == 0) {

896 
unm≠_size
 = 
PAGE_SIZE
;

897 *
±e
 = 0ULL;

899 
cou¡
, 
i
;

902 
unm≠_size
 = 
	`PTE_PAGE_SIZE
(*
±e
);

903 
cou¡
 = 
	`PAGE_SIZE_PTE_COUNT
(
unm≠_size
);

904 
i
 = 0; i < 
cou¡
; i++)

905 
±e
[
i
] = 0ULL;

908 
bus_addr
 = (bus_add∏& ~(
unm≠_size
 - 1)) + unmap_size;

909 
unm≠≥d
 +
unm≠_size
;

912 
	`BUG_ON
(!
	`is_powî_of_2
(
unm≠≥d
));

914  
unm≠≥d
;

915 
	}
}

921 
	$iommu_f‹_unôy_m≠
(
amd_iommu
 *
iommu
,

922 
unôy_m≠_íåy
 *
íåy
)

924 
u16
 
bdf
, 
i
;

926 
i
 = 
íåy
->
devid_°¨t
; i <íåy->
devid_íd
; ++i) {

927 
bdf
 = 
amd_iommu_Æüs_èbÀ
[
i
];

928 i‡(
amd_iommu_æookup_èbÀ
[
bdf
] =
iommu
)

933 
	}
}

939 
	$dma_›s_unôy_m≠
(
dma_›s_domaö
 *
dma_dom
,

940 
unôy_m≠_íåy
 *
e
)

942 
u64
 
addr
;

943 
ªt
;

945 
addr
 = 
e
->
addªss_°¨t
;ádd∏<É->
addªss_íd
;

946 
addr
 +
PAGE_SIZE
) {

947 
ªt
 = 
	`iommu_m≠_∑ge
(&
dma_dom
->
domaö
, 
addr
,áddr, 
e
->
¥Ÿ
,

948 
PAGE_SIZE
);

949 i‡(
ªt
)

950  
ªt
;

955 i‡(
addr
 < 
dma_dom
->
≠îtuª_size
)

956 
	`__£t_bô
(
addr
 >> 
PAGE_SHIFT
,

957 
dma_dom
->
≠îtuª
[0]->
bôm≠
);

961 
	}
}

969 
	$iommu_öô_unôy_m≠pögs
(
amd_iommu
 *
iommu
)

971 
unôy_m≠_íåy
 *
íåy
;

972 
ªt
;

974 
	`li°_f‹_óch_íåy
(
íåy
, &
amd_iommu_unôy_m≠
, 
li°
) {

975 i‡(!
	`iommu_f‹_unôy_m≠
(
iommu
, 
íåy
))

977 
ªt
 = 
	`dma_›s_unôy_m≠
(
iommu
->
deÁu…_dom
, 
íåy
);

978 i‡(
ªt
)

979  
ªt
;

983 
	}
}

988 
	$öô_unôy_m≠pögs_f‹_devi˚
(
dma_›s_domaö
 *
dma_dom
,

989 
u16
 
devid
)

991 
unôy_m≠_íåy
 *
e
;

992 
ªt
;

994 
	`li°_f‹_óch_íåy
(
e
, &
amd_iommu_unôy_m≠
, 
li°
) {

995 i‡(!(
devid
 >
e
->
devid_°¨t
 && devid <e->
devid_íd
))

997 
ªt
 = 
	`dma_›s_unôy_m≠
(
dma_dom
, 
e
);

998 i‡(
ªt
)

999  
ªt
;

1003 
	}
}

1025 
	$dma_›s_ª£rve_addªs£s
(
dma_›s_domaö
 *
dom
,

1026 
°¨t_∑ge
,

1027 
∑ges
)

1029 
i
, 
œ°_∑ge
 = 
dom
->
≠îtuª_size
 >> 
PAGE_SHIFT
;

1031 i‡(
°¨t_∑ge
 + 
∑ges
 > 
œ°_∑ge
)

1032 
∑ges
 = 
œ°_∑ge
 - 
°¨t_∑ge
;

1034 
i
 = 
°¨t_∑ge
; i < sèπ_∑gê+ 
∑ges
; ++i) {

1035 
ödex
 = 
i
 / 
APERTURE_RANGE_PAGES
;

1036 
∑ge
 = 
i
 % 
APERTURE_RANGE_PAGES
;

1037 
	`__£t_bô
(
∑ge
, 
dom
->
≠îtuª
[
ödex
]->
bôm≠
);

1039 
	}
}

1046 
	$Æloc_√w_ønge
(
dma_›s_domaö
 *
dma_dom
,

1047 
boﬁ
 
p›uœã
, 
gÂ_t
 
gÂ
)

1049 
ödex
 = 
dma_dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

1050 
amd_iommu
 *
iommu
;

1051 
i
;

1053 #ifde‡
CONFIG_IOMMU_STRESS


1054 
p›uœã
 = 
Ál£
;

1057 i‡(
ödex
 >
APERTURE_MAX_RANGES
)

1058  -
ENOMEM
;

1060 
dma_dom
->
≠îtuª
[
ödex
] = 
	`kzÆloc
((
≠îtuª_ønge
), 
gÂ
);

1061 i‡(!
dma_dom
->
≠îtuª
[
ödex
])

1062  -
ENOMEM
;

1064 
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
 = (*)
	`gë_zî€d_∑ge
(
gÂ
);

1065 i‡(!
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
)

1066 
out_‰ì
;

1068 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
 = dma_dom->
≠îtuª_size
;

1070 i‡(
p›uœã
) {

1071 
addªss
 = 
dma_dom
->
≠îtuª_size
;

1072 
i
, 
num_±es
 = 
APERTURE_RANGE_PAGES
 / 512;

1073 
u64
 *
±e
, *
±e_∑ge
;

1075 
i
 = 0; i < 
num_±es
; ++i) {

1076 
±e
 = 
	`Æloc_±e
(&
dma_dom
->
domaö
, 
addªss
, 
PAGE_SIZE
,

1077 &
±e_∑ge
, 
gÂ
);

1078 i‡(!
±e
)

1079 
out_‰ì
;

1081 
dma_dom
->
≠îtuª
[
ödex
]->
±e_∑ges
[
i
] = 
±e_∑ge
;

1083 
addªss
 +
APERTURE_RANGE_SIZE
 / 64;

1087 
dma_dom
->
≠îtuª_size
 +
APERTURE_RANGE_SIZE
;

1090 
	`f‹_óch_iommu
(
iommu
) {

1091 i‡(
iommu
->
ex˛usi⁄_°¨t
 &&

1092 
iommu
->
ex˛usi⁄_°¨t
 >
dma_dom
->
≠îtuª
[
ödex
]->
off£t


1093 && 
iommu
->
ex˛usi⁄_°¨t
 < 
dma_dom
->
≠îtuª_size
) {

1094 
°¨çage
;

1095 
∑ges
 = 
	`iommu_num_∑ges
(
iommu
->
ex˛usi⁄_°¨t
,

1096 
iommu
->
ex˛usi⁄_Àngth
,

1097 
PAGE_SIZE
);

1098 
°¨çage
 = 
iommu
->
ex˛usi⁄_°¨t
 >> 
PAGE_SHIFT
;

1099 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
°¨çage
, 
∑ges
);

1109 
i
 = 
dma_dom
->
≠îtuª
[
ödex
]->
off£t
;

1110 
i
 < 
dma_dom
->
≠îtuª_size
;

1111 
i
 +
PAGE_SIZE
) {

1112 
u64
 *
±e
 = 
	`„tch_±e
(&
dma_dom
->
domaö
, 
i
);

1113 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

1116 
	`dma_›s_ª£rve_addªs£s
(
dma_dom
, 
i
 << 
PAGE_SHIFT
, 1);

1119 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1123 
out_‰ì
:

1124 
	`upd©e_domaö
(&
dma_dom
->
domaö
);

1126 
	`‰ì_∑ge
(()
dma_dom
->
≠îtuª
[
ödex
]->
bôm≠
);

1128 
	`k‰ì
(
dma_dom
->
≠îtuª
[
ödex
]);

1129 
dma_dom
->
≠îtuª
[
ödex
] = 
NULL
;

1131  -
ENOMEM
;

1132 
	}
}

1134 
	$dma_›s_¨ó_Æloc
(
devi˚
 *
dev
,

1135 
dma_›s_domaö
 *
dom
,

1136 
∑ges
,

1137 
Æign_mask
,

1138 
u64
 
dma_mask
,

1139 
°¨t
)

1141 
√xt_bô
 = 
dom
->
√xt_addªss
 % 
APERTURE_RANGE_SIZE
;

1142 
max_ödex
 = 
dom
->
≠îtuª_size
 >> 
APERTURE_RANGE_SHIFT
;

1143 
i
 = 
°¨t
 >> 
APERTURE_RANGE_SHIFT
;

1144 
bound¨y_size
;

1145 
addªss
 = -1;

1146 
limô
;

1148 
√xt_bô
 >>
PAGE_SHIFT
;

1150 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

1151 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

1153 ;
i
 < 
max_ödex
; ++i) {

1154 
off£t
 = 
dom
->
≠îtuª
[
i
]->off£à>> 
PAGE_SHIFT
;

1156 i‡(
dom
->
≠îtuª
[
i
]->
off£t
 >
dma_mask
)

1159 
limô
 = 
	`iommu_devi˚_max_ödex
(
APERTURE_RANGE_PAGES
, 
off£t
,

1160 
dma_mask
 >> 
PAGE_SHIFT
);

1162 
addªss
 = 
	`iommu_¨ó_Æloc
(
dom
->
≠îtuª
[
i
]->
bôm≠
,

1163 
limô
, 
√xt_bô
, 
∑ges
, 0,

1164 
bound¨y_size
, 
Æign_mask
);

1165 i‡(
addªss
 != -1) {

1166 
addªss
 = 
dom
->
≠îtuª
[
i
]->
off£t
 +

1167 (
addªss
 << 
PAGE_SHIFT
);

1168 
dom
->
√xt_addªss
 = 
addªss
 + (
∑ges
 << 
PAGE_SHIFT
);

1172 
√xt_bô
 = 0;

1175  
addªss
;

1176 
	}
}

1178 
	$dma_›s_Æloc_addªs£s
(
devi˚
 *
dev
,

1179 
dma_›s_domaö
 *
dom
,

1180 
∑ges
,

1181 
Æign_mask
,

1182 
u64
 
dma_mask
)

1184 
addªss
;

1186 #ifde‡
CONFIG_IOMMU_STRESS


1187 
dom
->
√xt_addªss
 = 0;

1188 
dom
->
√ed_Êush
 = 
åue
;

1191 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1192 
dma_mask
, 
dom
->
√xt_addªss
);

1194 i‡(
addªss
 == -1) {

1195 
dom
->
√xt_addªss
 = 0;

1196 
addªss
 = 
	`dma_›s_¨ó_Æloc
(
dev
, 
dom
, 
∑ges
, 
Æign_mask
,

1197 
dma_mask
, 0);

1198 
dom
->
√ed_Êush
 = 
åue
;

1201 i‡(
	`u∆ikñy
(
addªss
 == -1))

1202 
addªss
 = 
DMA_ERROR_CODE
;

1204 
	`WARN_ON
((
addªss
 + (
PAGE_SIZE
*
∑ges
)Ë> 
dom
->
≠îtuª_size
);

1206  
addªss
;

1207 
	}
}

1214 
	$dma_›s_‰ì_addªs£s
(
dma_›s_domaö
 *
dom
,

1215 
addªss
,

1216 
∑ges
)

1218 
i
 = 
addªss
 >> 
APERTURE_RANGE_SHIFT
;

1219 
≠îtuª_ønge
 *
ønge
 = 
dom
->
≠îtuª
[
i
];

1221 
	`BUG_ON
(
i
 >
APERTURE_MAX_RANGES
 || 
ønge
 =
NULL
);

1223 #ifde‡
CONFIG_IOMMU_STRESS


1224 i‡(
i
 < 4)

1228 i‡(
addªss
 >
dom
->
√xt_addªss
)

1229 
dom
->
√ed_Êush
 = 
åue
;

1231 
addªss
 = (addªs†% 
APERTURE_RANGE_SIZE
Ë>> 
PAGE_SHIFT
;

1233 
	`bôm≠_˛ór
(
ønge
->
bôm≠
, 
addªss
, 
∑ges
);

1235 
	}
}

1250 
	$add_domaö_to_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1252 
Êags
;

1254 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1255 
	`li°_add
(&
domaö
->
li°
, &
amd_iommu_pd_li°
);

1256 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1257 
	}
}

1263 
	$dñ_domaö_‰om_li°
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1265 
Êags
;

1267 
	`•ö_lock_úqßve
(&
amd_iommu_pd_lock
, 
Êags
);

1268 
	`li°_dñ
(&
domaö
->
li°
);

1269 
	`•ö_u∆ock_úqª°‹e
(&
amd_iommu_pd_lock
, 
Êags
);

1270 
	}
}

1272 
u16
 
	$domaö_id_Æloc
()

1274 
Êags
;

1275 
id
;

1277 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1278 
id
 = 
	`föd_fú°_zîo_bô
(
amd_iommu_pd_Æloc_bôm≠
, 
MAX_DOMAIN_ID
);

1279 
	`BUG_ON
(
id
 == 0);

1280 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1281 
	`__£t_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1283 
id
 = 0;

1284 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1286  
id
;

1287 
	}
}

1289 
	$domaö_id_‰ì
(
id
)

1291 
Êags
;

1293 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1294 i‡(
id
 > 0 && id < 
MAX_DOMAIN_ID
)

1295 
	`__˛ór_bô
(
id
, 
amd_iommu_pd_Æloc_bôm≠
);

1296 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1297 
	}
}

1299 
	$‰ì_∑gëabÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1301 
i
, 
j
;

1302 
u64
 *
p1
, *
p2
, *
p3
;

1304 
p1
 = 
domaö
->
±_roŸ
;

1306 i‡(!
p1
)

1309 
i
 = 0; i < 512; ++i) {

1310 i‡(!
	`IOMMU_PTE_PRESENT
(
p1
[
i
]))

1313 
p2
 = 
	`IOMMU_PTE_PAGE
(
p1
[
i
]);

1314 
j
 = 0; j < 512; ++j) {

1315 i‡(!
	`IOMMU_PTE_PRESENT
(
p2
[
j
]))

1317 
p3
 = 
	`IOMMU_PTE_PAGE
(
p2
[
j
]);

1318 
	`‰ì_∑ge
(()
p3
);

1321 
	`‰ì_∑ge
(()
p2
);

1324 
	`‰ì_∑ge
(()
p1
);

1326 
domaö
->
±_roŸ
 = 
NULL
;

1327 
	}
}

1333 
	$dma_›s_domaö_‰ì
(
dma_›s_domaö
 *
dom
)

1335 
i
;

1337 i‡(!
dom
)

1340 
	`dñ_domaö_‰om_li°
(&
dom
->
domaö
);

1342 
	`‰ì_∑gëabÀ
(&
dom
->
domaö
);

1344 
i
 = 0; i < 
APERTURE_MAX_RANGES
; ++i) {

1345 i‡(!
dom
->
≠îtuª
[
i
])

1347 
	`‰ì_∑ge
(()
dom
->
≠îtuª
[
i
]->
bôm≠
);

1348 
	`k‰ì
(
dom
->
≠îtuª
[
i
]);

1351 
	`k‰ì
(
dom
);

1352 
	}
}

1359 
dma_›s_domaö
 *
	$dma_›s_domaö_Æloc
()

1361 
dma_›s_domaö
 *
dma_dom
;

1363 
dma_dom
 = 
	`kzÆloc
((
dma_›s_domaö
), 
GFP_KERNEL
);

1364 i‡(!
dma_dom
)

1365  
NULL
;

1367 
	`•ö_lock_öô
(&
dma_dom
->
domaö
.
lock
);

1369 
dma_dom
->
domaö
.
id
 = 
	`domaö_id_Æloc
();

1370 i‡(
dma_dom
->
domaö
.
id
 == 0)

1371 
‰ì_dma_dom
;

1372 
	`INIT_LIST_HEAD
(&
dma_dom
->
domaö
.
dev_li°
);

1373 
dma_dom
->
domaö
.
mode
 = 
PAGE_MODE_2_LEVEL
;

1374 
dma_dom
->
domaö
.
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1375 
dma_dom
->
domaö
.
Êags
 = 
PD_DMA_OPS_MASK
;

1376 
dma_dom
->
domaö
.
¥iv
 = dma_dom;

1377 i‡(!
dma_dom
->
domaö
.
±_roŸ
)

1378 
‰ì_dma_dom
;

1380 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1381 
dma_dom
->
èrgë_dev
 = 0xffff;

1383 
	`add_domaö_to_li°
(&
dma_dom
->
domaö
);

1385 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
åue
, 
GFP_KERNEL
))

1386 
‰ì_dma_dom
;

1392 
dma_dom
->
≠îtuª
[0]->
bôm≠
[0] = 1;

1393 
dma_dom
->
√xt_addªss
 = 0;

1396  
dma_dom
;

1398 
‰ì_dma_dom
:

1399 
	`dma_›s_domaö_‰ì
(
dma_dom
);

1401  
NULL
;

1402 
	}
}

1408 
boﬁ
 
	$dma_›s_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1410  
domaö
->
Êags
 & 
PD_DMA_OPS_MASK
;

1411 
	}
}

1413 
	$£t_dã_íåy
(
u16
 
devid
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1415 
u64
 
±e_roŸ
 = 
	`vút_to_phys
(
domaö
->
±_roŸ
);

1417 
±e_roŸ
 |(
domaö
->
mode
 & 
DEV_ENTRY_MODE_MASK
)

1418 << 
DEV_ENTRY_MODE_SHIFT
;

1419 
±e_roŸ
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1421 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 
domaö
->
id
;

1422 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 
	`uµî_32_bôs
(
±e_roŸ
);

1423 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
	`lowî_32_bôs
(
±e_roŸ
);

1424 
	}
}

1426 
	$˛ór_dã_íåy
(
u16
 
devid
)

1429 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[0] = 
IOMMU_PTE_P
 | 
IOMMU_PTE_TV
;

1430 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[1] = 0;

1431 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[2] = 0;

1433 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

1434 
	}
}

1436 
	$do_©èch
(
devi˚
 *
dev
, 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1438 
iommu_dev_d©a
 *
dev_d©a
;

1439 
amd_iommu
 *
iommu
;

1440 
u16
 
devid
;

1442 
devid
 = 
	`gë_devi˚_id
(
dev
);

1443 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1444 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1447 
dev_d©a
->
domaö
 = domain;

1448 
	`li°_add
(&
dev_d©a
->
li°
, &
domaö
->
dev_li°
);

1449 
	`£t_dã_íåy
(
devid
, 
domaö
);

1452 
domaö
->
dev_iommu
[
iommu
->
ödex
] += 1;

1453 
domaö
->
dev_˙t
 += 1;

1456 
	`iommu_Êush_devi˚
(
dev
);

1457 
	}
}

1459 
	$do_dëach
(
devi˚
 *
dev
)

1461 
iommu_dev_d©a
 *
dev_d©a
;

1462 
amd_iommu
 *
iommu
;

1463 
u16
 
devid
;

1465 
devid
 = 
	`gë_devi˚_id
(
dev
);

1466 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1467 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1470 
dev_d©a
->
domaö
->
dev_iommu
[
iommu
->
ödex
] -= 1;

1471 
dev_d©a
->
domaö
->
dev_˙t
 -= 1;

1474 
dev_d©a
->
domaö
 = 
NULL
;

1475 
	`li°_dñ
(&
dev_d©a
->
li°
);

1476 
	`˛ór_dã_íåy
(
devid
);

1479 
	`iommu_Êush_devi˚
(
dev
);

1480 
	}
}

1486 
	$__©èch_devi˚
(
devi˚
 *
dev
,

1487 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1489 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1490 
ªt
;

1492 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1493 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1495 i‡(!
Æüs_d©a
)

1496  -
EINVAL
;

1499 
	`•ö_lock
(&
domaö
->
lock
);

1502 
ªt
 = -
EBUSY
;

1503 i‡(
Æüs_d©a
->
domaö
 !
NULL
 &&

1504 
Æüs_d©a
->
domaö
 != domain)

1505 
out_u∆ock
;

1507 i‡(
dev_d©a
->
domaö
 !
NULL
 &&

1508 
dev_d©a
->
domaö
 != domain)

1509 
out_u∆ock
;

1512 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1513 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1514 i‡(
Æüs_d©a
->
domaö
 =
NULL
)

1515 
	`do_©èch
(
dev_d©a
->
Æüs
, 
domaö
);

1517 
	`©omic_öc
(&
Æüs_d©a
->
böd
);

1520 i‡(
dev_d©a
->
domaö
 =
NULL
)

1521 
	`do_©èch
(
dev
, 
domaö
);

1523 
	`©omic_öc
(&
dev_d©a
->
böd
);

1525 
ªt
 = 0;

1527 
out_u∆ock
:

1530 
	`•ö_u∆ock
(&
domaö
->
lock
);

1532  
ªt
;

1533 
	}
}

1539 
	$©èch_devi˚
(
devi˚
 *
dev
,

1540 
¥Ÿe˘i⁄_domaö
 *
domaö
)

1542 
Êags
;

1543 
ªt
;

1545 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1546 
ªt
 = 
	`__©èch_devi˚
(
dev
, 
domaö
);

1547 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1554 
	`iommu_Êush_éb_pde
(
domaö
);

1556  
ªt
;

1557 
	}
}

1562 
	$__dëach_devi˚
(
devi˚
 *
dev
)

1564 
iommu_dev_d©a
 *
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1565 
iommu_dev_d©a
 *
Æüs_d©a
;

1566 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1567 
Êags
;

1569 
	`BUG_ON
(!
dev_d©a
->
domaö
);

1571 
domaö
 = 
dev_d©a
->domain;

1573 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

1575 i‡(
dev_d©a
->
Æüs
 !
dev
) {

1576 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1577 i‡(
	`©omic_dec_™d_ã°
(&
Æüs_d©a
->
böd
))

1578 
	`do_dëach
(
dev_d©a
->
Æüs
);

1581 i‡(
	`©omic_dec_™d_ã°
(&
dev_d©a
->
böd
))

1582 
	`do_dëach
(
dev
);

1584 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

1591 i‡(
iommu_∑ss_through
 &&

1592 (
dev_d©a
->
domaö
 =
NULL
 && domaö !
±_domaö
))

1593 
	`__©èch_devi˚
(
dev
, 
±_domaö
);

1594 
	}
}

1599 
	$dëach_devi˚
(
devi˚
 *
dev
)

1601 
Êags
;

1604 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1605 
	`__dëach_devi˚
(
dev
);

1606 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1607 
	}
}

1613 
¥Ÿe˘i⁄_domaö
 *
	$domaö_f‹_devi˚
(
devi˚
 *
dev
)

1615 
¥Ÿe˘i⁄_domaö
 *
dom
;

1616 
iommu_dev_d©a
 *
dev_d©a
, *
Æüs_d©a
;

1617 
Êags
;

1618 
u16
 
devid
, 
Æüs
;

1620 
devid
 = 
	`gë_devi˚_id
(
dev
);

1621 
Æüs
 = 
amd_iommu_Æüs_èbÀ
[
devid
];

1622 
dev_d©a
 = 
	`gë_dev_d©a
(
dev
);

1623 
Æüs_d©a
 = 
	`gë_dev_d©a
(
dev_d©a
->
Æüs
);

1624 i‡(!
Æüs_d©a
)

1625  
NULL
;

1627 
	`ªad_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1628 
dom
 = 
dev_d©a
->
domaö
;

1629 i‡(
dom
 =
NULL
 &&

1630 
Æüs_d©a
->
domaö
 !
NULL
) {

1631 
	`__©èch_devi˚
(
dev
, 
Æüs_d©a
->
domaö
);

1632 
dom
 = 
Æüs_d©a
->
domaö
;

1635 
	`ªad_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

1637  
dom
;

1638 
	}
}

1640 
	$devi˚_ch™ge_nŸifõr
(
nŸifõr_block
 *
nb
,

1641 
a˘i⁄
, *
d©a
)

1643 
devi˚
 *
dev
 = 
d©a
;

1644 
u16
 
devid
;

1645 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1646 
dma_›s_domaö
 *
dma_domaö
;

1647 
amd_iommu
 *
iommu
;

1648 
Êags
;

1650 i‡(!
	`check_devi˚
(
dev
))

1653 
devid
 = 
	`gë_devi˚_id
(
dev
);

1654 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

1656 
a˘i⁄
) {

1657 
BUS_NOTIFY_UNBOUND_DRIVER
:

1659 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1661 i‡(!
domaö
)

1662 
out
;

1663 i‡(
iommu_∑ss_through
)

1665 
	`dëach_devi˚
(
dev
);

1667 
BUS_NOTIFY_ADD_DEVICE
:

1669 
	`iommu_öô_devi˚
(
dev
);

1671 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1674 
dma_domaö
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1675 i‡(
dma_domaö
)

1676 
out
;

1677 
dma_domaö
 = 
	`dma_›s_domaö_Æloc
();

1678 i‡(!
dma_domaö
)

1679 
out
;

1680 
dma_domaö
->
èrgë_dev
 = 
devid
;

1682 
	`•ö_lock_úqßve
(&
iommu_pd_li°_lock
, 
Êags
);

1683 
	`li°_add_èû
(&
dma_domaö
->
li°
, &
iommu_pd_li°
);

1684 
	`•ö_u∆ock_úqª°‹e
(&
iommu_pd_li°_lock
, 
Êags
);

1687 
BUS_NOTIFY_DEL_DEVICE
:

1689 
	`iommu_unöô_devi˚
(
dev
);

1692 
out
;

1695 
	`iommu_Êush_devi˚
(
dev
);

1696 
	`iommu_com∂ëi⁄_waô
(
iommu
);

1698 
out
:

1700 
	}
}

1702 
nŸifõr_block
 
	gdevi˚_nb
 = {

1703 .
nŸifõr_ˇŒ
 = 
devi˚_ch™ge_nŸifõr
,

1706 
	$amd_iommu_öô_nŸifõr
()

1708 
	`bus_ªgi°î_nŸifõr
(&
pci_bus_ty≥
, &
devi˚_nb
);

1709 
	}
}

1724 
¥Ÿe˘i⁄_domaö
 *
	$gë_domaö
(
devi˚
 *
dev
)

1726 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1727 
dma_›s_domaö
 *
dma_dom
;

1728 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev
);

1730 i‡(!
	`check_devi˚
(
dev
))

1731  
	`ERR_PTR
(-
EINVAL
);

1733 
domaö
 = 
	`domaö_f‹_devi˚
(
dev
);

1734 i‡(
domaö
 !
NULL
 && !
	`dma_›s_domaö
(domain))

1735  
	`ERR_PTR
(-
EBUSY
);

1737 i‡(
domaö
 !
NULL
)

1738  
domaö
;

1741 
dma_dom
 = 
	`föd_¥Ÿe˘i⁄_domaö
(
devid
);

1742 i‡(!
dma_dom
)

1743 
dma_dom
 = 
amd_iommu_æookup_èbÀ
[
devid
]->
deÁu…_dom
;

1744 
	`©èch_devi˚
(
dev
, &
dma_dom
->
domaö
);

1745 
	`DUMP_¥ötk
("UsingÖrotection domain %d for device %s\n",

1746 
dma_dom
->
domaö
.
id
, 
	`dev_«me
(
dev
));

1748  &
dma_dom
->
domaö
;

1749 
	}
}

1751 
	$upd©e_devi˚_èbÀ
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1753 
iommu_dev_d©a
 *
dev_d©a
;

1755 
	`li°_f‹_óch_íåy
(
dev_d©a
, &
domaö
->
dev_li°
, 
li°
) {

1756 
u16
 
devid
 = 
	`gë_devi˚_id
(
dev_d©a
->
dev
);

1757 
	`£t_dã_íåy
(
devid
, 
domaö
);

1759 
	}
}

1761 
	$upd©e_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

1763 i‡(!
domaö
->
upd©ed
)

1766 
	`upd©e_devi˚_èbÀ
(
domaö
);

1767 
	`iommu_Êush_domaö_devi˚s
(
domaö
);

1768 
	`iommu_Êush_éb_pde
(
domaö
);

1770 
domaö
->
upd©ed
 = 
Ál£
;

1771 
	}
}

1776 
u64
* 
	$dma_›s_gë_±e
(
dma_›s_domaö
 *
dom
,

1777 
addªss
)

1779 
≠îtuª_ønge
 *
≠îtuª
;

1780 
u64
 *
±e
, *
±e_∑ge
;

1782 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1783 i‡(!
≠îtuª
)

1784  
NULL
;

1786 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1787 i‡(!
±e
) {

1788 
±e
 = 
	`Æloc_±e
(&
dom
->
domaö
, 
addªss
, 
PAGE_SIZE
, &
±e_∑ge
,

1789 
GFP_ATOMIC
);

1790 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)] = 
±e_∑ge
;

1792 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1794 
	`upd©e_domaö
(&
dom
->
domaö
);

1796  
±e
;

1797 
	}
}

1803 
dma_addr_t
 
	$dma_›s_domaö_m≠
(
dma_›s_domaö
 *
dom
,

1804 
addªss
,

1805 
phys_addr_t
 
∑ddr
,

1806 
dúe˘i⁄
)

1808 
u64
 *
±e
, 
__±e
;

1810 
	`WARN_ON
(
addªss
 > 
dom
->
≠îtuª_size
);

1812 
∑ddr
 &
PAGE_MASK
;

1814 
±e
 = 
	`dma_›s_gë_±e
(
dom
, 
addªss
);

1815 i‡(!
±e
)

1816  
DMA_ERROR_CODE
;

1818 
__±e
 = 
∑ddr
 | 
IOMMU_PTE_P
 | 
IOMMU_PTE_FC
;

1820 i‡(
dúe˘i⁄
 =
DMA_TO_DEVICE
)

1821 
__±e
 |
IOMMU_PTE_IR
;

1822 i‡(
dúe˘i⁄
 =
DMA_FROM_DEVICE
)

1823 
__±e
 |
IOMMU_PTE_IW
;

1824 i‡(
dúe˘i⁄
 =
DMA_BIDIRECTIONAL
)

1825 
__±e
 |
IOMMU_PTE_IR
 | 
IOMMU_PTE_IW
;

1827 
	`WARN_ON
(*
±e
);

1829 *
±e
 = 
__±e
;

1831  (
dma_addr_t
)
addªss
;

1832 
	}
}

1837 
	$dma_›s_domaö_unm≠
(
dma_›s_domaö
 *
dom
,

1838 
addªss
)

1840 
≠îtuª_ønge
 *
≠îtuª
;

1841 
u64
 *
±e
;

1843 i‡(
addªss
 >
dom
->
≠îtuª_size
)

1846 
≠îtuª
 = 
dom
->≠îtuª[
	`APERTURE_RANGE_INDEX
(
addªss
)];

1847 i‡(!
≠îtuª
)

1850 
±e
 = 
≠îtuª
->
±e_∑ges
[
	`APERTURE_PAGE_INDEX
(
addªss
)];

1851 i‡(!
±e
)

1854 
±e
 +
	`PM_LEVEL_INDEX
(0, 
addªss
);

1856 
	`WARN_ON
(!*
±e
);

1858 *
±e
 = 0ULL;

1859 
	}
}

1867 
dma_addr_t
 
	$__m≠_sögÀ
(
devi˚
 *
dev
,

1868 
dma_›s_domaö
 *
dma_dom
,

1869 
phys_addr_t
 
∑ddr
,

1870 
size_t
 
size
,

1871 
dú
,

1872 
boﬁ
 
Æign
,

1873 
u64
 
dma_mask
)

1875 
dma_addr_t
 
off£t
 = 
∑ddr
 & ~
PAGE_MASK
;

1876 
dma_addr_t
 
addªss
, 
°¨t
, 
ªt
;

1877 
∑ges
;

1878 
Æign_mask
 = 0;

1879 
i
;

1881 
∑ges
 = 
	`iommu_num_∑ges
(
∑ddr
, 
size
, 
PAGE_SIZE
);

1882 
∑ddr
 &
PAGE_MASK
;

1884 
	`INC_STATS_COUNTER
(
tŸÆ_m≠_ªque°s
);

1886 i‡(
∑ges
 > 1)

1887 
	`INC_STATS_COUNTER
(
¸oss_∑ge
);

1889 i‡(
Æign
)

1890 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

1892 
ªåy
:

1893 
addªss
 = 
	`dma_›s_Æloc_addªs£s
(
dev
, 
dma_dom
, 
∑ges
, 
Æign_mask
,

1894 
dma_mask
);

1895 i‡(
	`u∆ikñy
(
addªss
 =
DMA_ERROR_CODE
)) {

1901 
dma_dom
->
√xt_addªss
 = dma_dom->
≠îtuª_size
;

1903 i‡(
	`Æloc_√w_ønge
(
dma_dom
, 
Ál£
, 
GFP_ATOMIC
))

1904 
out
;

1910 
ªåy
;

1913 
°¨t
 = 
addªss
;

1914 
i
 = 0; i < 
∑ges
; ++i) {

1915 
ªt
 = 
	`dma_›s_domaö_m≠
(
dma_dom
, 
°¨t
, 
∑ddr
, 
dú
);

1916 i‡(
ªt
 =
DMA_ERROR_CODE
)

1917 
out_unm≠
;

1919 
∑ddr
 +
PAGE_SIZE
;

1920 
°¨t
 +
PAGE_SIZE
;

1922 
addªss
 +
off£t
;

1924 
	`ADD_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1926 i‡(
	`u∆ikñy
(
dma_dom
->
√ed_Êush
 && !
amd_iommu_unm≠_Êush
)) {

1927 
	`iommu_Êush_éb
(&
dma_dom
->
domaö
);

1928 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1929 } i‡(
	`u∆ikñy
(
amd_iommu_≈_ˇche
))

1930 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
addªss
, 
size
);

1932 
out
:

1933  
addªss
;

1935 
out_unm≠
:

1937 --
i
; i >= 0; --i) {

1938 
°¨t
 -
PAGE_SIZE
;

1939 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1942 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
addªss
, 
∑ges
);

1944  
DMA_ERROR_CODE
;

1945 
	}
}

1951 
	$__unm≠_sögÀ
(
dma_›s_domaö
 *
dma_dom
,

1952 
dma_addr_t
 
dma_addr
,

1953 
size_t
 
size
,

1954 
dú
)

1956 
dma_addr_t
 
i
, 
°¨t
;

1957 
∑ges
;

1959 i‡((
dma_addr
 =
DMA_ERROR_CODE
) ||

1960 (
dma_addr
 + 
size
 > 
dma_dom
->
≠îtuª_size
))

1963 
∑ges
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

1964 
dma_addr
 &
PAGE_MASK
;

1965 
°¨t
 = 
dma_addr
;

1967 
i
 = 0; i < 
∑ges
; ++i) {

1968 
	`dma_›s_domaö_unm≠
(
dma_dom
, 
°¨t
);

1969 
°¨t
 +
PAGE_SIZE
;

1972 
	`SUB_STATS_COUNTER
(
Ælo˚d_io_mem
, 
size
);

1974 
	`dma_›s_‰ì_addªs£s
(
dma_dom
, 
dma_addr
, 
∑ges
);

1976 i‡(
amd_iommu_unm≠_Êush
 || 
dma_dom
->
√ed_Êush
) {

1977 
	`iommu_Êush_∑ges
(&
dma_dom
->
domaö
, 
dma_addr
, 
size
);

1978 
dma_dom
->
√ed_Êush
 = 
Ál£
;

1980 
	}
}

1985 
dma_addr_t
 
	$m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

1986 
off£t
, 
size_t
 
size
,

1987 
dma_d©a_dúe˘i⁄
 
dú
,

1988 
dma_©ås
 *
©ås
)

1990 
Êags
;

1991 
¥Ÿe˘i⁄_domaö
 *
domaö
;

1992 
dma_addr_t
 
addr
;

1993 
u64
 
dma_mask
;

1994 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

1996 
	`INC_STATS_COUNTER
(
˙t_m≠_sögÀ
);

1998 
domaö
 = 
	`gë_domaö
(
dev
);

1999 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

2000  (
dma_addr_t
)
∑ddr
;

2001 i‡(
	`IS_ERR
(
domaö
))

2002  
DMA_ERROR_CODE
;

2004 
dma_mask
 = *
dev
->dma_mask;

2006 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2008 
addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
, 
size
, 
dú
, 
Ál£
,

2009 
dma_mask
);

2010 i‡(
addr
 =
DMA_ERROR_CODE
)

2011 
out
;

2013 
	`iommu_Êush_com∂ëe
(
domaö
);

2015 
out
:

2016 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2018  
addr
;

2019 
	}
}

2024 
	$unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

2025 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

2027 
Êags
;

2028 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2030 
	`INC_STATS_COUNTER
(
˙t_unm≠_sögÀ
);

2032 
domaö
 = 
	`gë_domaö
(
dev
);

2033 i‡(
	`IS_ERR
(
domaö
))

2036 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2038 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
dú
);

2040 
	`iommu_Êush_com∂ëe
(
domaö
);

2042 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2043 
	}
}

2049 
	$m≠_sg_no_iommu
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

2050 
√Àms
, 
dú
)

2052 
sˇâîli°
 *
s
;

2053 
i
;

2055 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2056 
s
->
dma_addªss
 = (
dma_addr_t
)
	`sg_phys
(s);

2057 
s
->
dma_Àngth
 = s->
Àngth
;

2060  
√Àms
;

2061 
	}
}

2067 
	$m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

2068 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

2069 
dma_©ås
 *
©ås
)

2071 
Êags
;

2072 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2073 
i
;

2074 
sˇâîli°
 *
s
;

2075 
phys_addr_t
 
∑ddr
;

2076 
m≠≥d_ñems
 = 0;

2077 
u64
 
dma_mask
;

2079 
	`INC_STATS_COUNTER
(
˙t_m≠_sg
);

2081 
domaö
 = 
	`gë_domaö
(
dev
);

2082 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
)

2083  
	`m≠_sg_no_iommu
(
dev
, 
sgli°
, 
√Àms
, 
dú
);

2084 i‡(
	`IS_ERR
(
domaö
))

2087 
dma_mask
 = *
dev
->dma_mask;

2089 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2091 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2092 
∑ddr
 = 
	`sg_phys
(
s
);

2094 
s
->
dma_addªss
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
,

2095 
∑ddr
, 
s
->
Àngth
, 
dú
, 
Ál£
,

2096 
dma_mask
);

2098 i‡(
s
->
dma_addªss
) {

2099 
s
->
dma_Àngth
 = s->
Àngth
;

2100 
m≠≥d_ñems
++;

2102 
unm≠
;

2105 
	`iommu_Êush_com∂ëe
(
domaö
);

2107 
out
:

2108 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2110  
m≠≥d_ñems
;

2111 
unm≠
:

2112 
	`f‹_óch_sg
(
sgli°
, 
s
, 
m≠≥d_ñems
, 
i
) {

2113 i‡(
s
->
dma_addªss
)

2114 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2115 
s
->
dma_Àngth
, 
dú
);

2116 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2119 
m≠≥d_ñems
 = 0;

2121 
out
;

2122 
	}
}

2128 
	$unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

2129 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

2130 
dma_©ås
 *
©ås
)

2132 
Êags
;

2133 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2134 
sˇâîli°
 *
s
;

2135 
i
;

2137 
	`INC_STATS_COUNTER
(
˙t_unm≠_sg
);

2139 
domaö
 = 
	`gë_domaö
(
dev
);

2140 i‡(
	`IS_ERR
(
domaö
))

2143 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2145 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

2146 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
s
->
dma_addªss
,

2147 
s
->
dma_Àngth
, 
dú
);

2148 
s
->
dma_addªss
 = s->
dma_Àngth
 = 0;

2151 
	`iommu_Êush_com∂ëe
(
domaö
);

2153 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2154 
	}
}

2159 *
	$Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2160 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

2162 
Êags
;

2163 *
vút_addr
;

2164 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2165 
phys_addr_t
 
∑ddr
;

2166 
u64
 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2168 
	`INC_STATS_COUNTER
(
˙t_Æloc_cohîít
);

2170 
domaö
 = 
	`gë_domaö
(
dev
);

2171 i‡(
	`PTR_ERR
(
domaö
Ë=-
EINVAL
) {

2172 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2173 *
dma_addr
 = 
	`__∑
(
vút_addr
);

2174  
vút_addr
;

2175 } i‡(
	`IS_ERR
(
domaö
))

2176  
NULL
;

2178 
dma_mask
 = 
dev
->
cohîít_dma_mask
;

2179 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

2180 
Êag
 |
__GFP_ZERO
;

2182 
vút_addr
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
	`gë_‹dî
(
size
));

2183 i‡(!
vút_addr
)

2184  
NULL
;

2186 
∑ddr
 = 
	`vút_to_phys
(
vút_addr
);

2188 i‡(!
dma_mask
)

2189 
dma_mask
 = *
dev
->dma_mask;

2191 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2193 *
dma_addr
 = 
	`__m≠_sögÀ
(
dev
, 
domaö
->
¥iv
, 
∑ddr
,

2194 
size
, 
DMA_BIDIRECTIONAL
, 
åue
, 
dma_mask
);

2196 i‡(*
dma_addr
 =
DMA_ERROR_CODE
) {

2197 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2198 
out_‰ì
;

2201 
	`iommu_Êush_com∂ëe
(
domaö
);

2203 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2205  
vút_addr
;

2207 
out_‰ì
:

2209 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2211  
NULL
;

2212 
	}
}

2217 
	$‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

2218 *
vút_addr
, 
dma_addr_t
 
dma_addr
)

2220 
Êags
;

2221 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2223 
	`INC_STATS_COUNTER
(
˙t_‰ì_cohîít
);

2225 
domaö
 = 
	`gë_domaö
(
dev
);

2226 i‡(
	`IS_ERR
(
domaö
))

2227 
‰ì_mem
;

2229 
	`•ö_lock_úqßve
(&
domaö
->
lock
, 
Êags
);

2231 
	`__unm≠_sögÀ
(
domaö
->
¥iv
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
);

2233 
	`iommu_Êush_com∂ëe
(
domaö
);

2235 
	`•ö_u∆ock_úqª°‹e
(&
domaö
->
lock
, 
Êags
);

2237 
‰ì_mem
:

2238 
	`‰ì_∑ges
(()
vút_addr
, 
	`gë_‹dî
(
size
));

2239 
	}
}

2245 
	$amd_iommu_dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

2247  
	`check_devi˚
(
dev
);

2248 
	}
}

2257 
	$¥óŒoc_¥Ÿe˘i⁄_domaös
()

2259 
pci_dev
 *
dev
 = 
NULL
;

2260 
dma_›s_domaö
 *
dma_dom
;

2261 
u16
 
devid
;

2263 
	`f‹_óch_pci_dev
(
dev
) {

2266 i‡(!
	`check_devi˚
(&
dev
->dev))

2270 i‡(
	`domaö_f‹_devi˚
(&
dev
->dev))

2273 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2275 
dma_dom
 = 
	`dma_›s_domaö_Æloc
();

2276 i‡(!
dma_dom
)

2278 
	`öô_unôy_m≠pögs_f‹_devi˚
(
dma_dom
, 
devid
);

2279 
dma_dom
->
èrgë_dev
 = 
devid
;

2281 
	`©èch_devi˚
(&
dev
->dev, &
dma_dom
->
domaö
);

2283 
	`li°_add_èû
(&
dma_dom
->
li°
, &
iommu_pd_li°
);

2285 
	}
}

2287 
dma_m≠_›s
 
	gamd_iommu_dma_›s
 = {

2288 .
Æloc_cohîít
 =álloc_coherent,

2289 .
	g‰ì_cohîít
 = 
‰ì_cohîít
,

2290 .
	gm≠_∑ge
 = 
m≠_∑ge
,

2291 .
	gunm≠_∑ge
 = 
unm≠_∑ge
,

2292 .
	gm≠_sg
 = 
m≠_sg
,

2293 .
	gunm≠_sg
 = 
unm≠_sg
,

2294 .
	gdma_suµ‹ãd
 = 
amd_iommu_dma_suµ‹ãd
,

2301 
__öô
 
	$amd_iommu_öô_≠i
()

2303 
	`ªgi°î_iommu
(&
amd_iommu_›s
);

2304 
	}
}

2306 
__öô
 
	$amd_iommu_öô_dma_›s
()

2308 
amd_iommu
 *
iommu
;

2309 
ªt
;

2316 
	`f‹_óch_iommu
(
iommu
) {

2317 
iommu
->
deÁu…_dom
 = 
	`dma_›s_domaö_Æloc
();

2318 i‡(
iommu
->
deÁu…_dom
 =
NULL
)

2319  -
ENOMEM
;

2320 
iommu
->
deÁu…_dom
->
domaö
.
Êags
 |
PD_DEFAULT_MASK
;

2321 
ªt
 = 
	`iommu_öô_unôy_m≠pögs
(
iommu
);

2322 i‡(
ªt
)

2323 
‰ì_domaös
;

2329 
	`¥óŒoc_¥Ÿe˘i⁄_domaös
();

2331 
iommu_dëe˘ed
 = 1;

2332 
swiŸlb
 = 0;

2335 
dma_›s
 = &
amd_iommu_dma_›s
;

2337 
	`amd_iommu_°©s_öô
();

2341 
‰ì_domaös
:

2343 
	`f‹_óch_iommu
(
iommu
) {

2344 i‡(
iommu
->
deÁu…_dom
)

2345 
	`dma_›s_domaö_‰ì
(
iommu
->
deÁu…_dom
);

2348  
ªt
;

2349 
	}
}

2361 
	$˛ónup_domaö
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2363 
iommu_dev_d©a
 *
dev_d©a
, *
√xt
;

2364 
Êags
;

2366 
	`wrôe_lock_úqßve
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2368 
	`li°_f‹_óch_íåy_ß„
(
dev_d©a
, 
√xt
, &
domaö
->
dev_li°
, 
li°
) {

2369 
devi˚
 *
dev
 = 
dev_d©a
->dev;

2371 
	`__dëach_devi˚
(
dev
);

2372 
	`©omic_£t
(&
dev_d©a
->
böd
, 0);

2375 
	`wrôe_u∆ock_úqª°‹e
(&
amd_iommu_devèbÀ_lock
, 
Êags
);

2376 
	}
}

2378 
	$¥Ÿe˘i⁄_domaö_‰ì
(
¥Ÿe˘i⁄_domaö
 *
domaö
)

2380 i‡(!
domaö
)

2383 
	`dñ_domaö_‰om_li°
(
domaö
);

2385 i‡(
domaö
->
id
)

2386 
	`domaö_id_‰ì
(
domaö
->
id
);

2388 
	`k‰ì
(
domaö
);

2389 
	}
}

2391 
¥Ÿe˘i⁄_domaö
 *
	$¥Ÿe˘i⁄_domaö_Æloc
()

2393 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2395 
domaö
 = 
	`kzÆloc
((*domaö), 
GFP_KERNEL
);

2396 i‡(!
domaö
)

2397  
NULL
;

2399 
	`•ö_lock_öô
(&
domaö
->
lock
);

2400 
	`muãx_öô
(&
domaö
->
≠i_lock
);

2401 
domaö
->
id
 = 
	`domaö_id_Æloc
();

2402 i‡(!
domaö
->
id
)

2403 
out_îr
;

2404 
	`INIT_LIST_HEAD
(&
domaö
->
dev_li°
);

2406 
	`add_domaö_to_li°
(
domaö
);

2408  
domaö
;

2410 
out_îr
:

2411 
	`k‰ì
(
domaö
);

2413  
NULL
;

2414 
	}
}

2416 
	$amd_iommu_domaö_öô
(
iommu_domaö
 *
dom
)

2418 
¥Ÿe˘i⁄_domaö
 *
domaö
;

2420 
domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2421 i‡(!
domaö
)

2422 
out_‰ì
;

2424 
domaö
->
mode
 = 
PAGE_MODE_3_LEVEL
;

2425 
domaö
->
±_roŸ
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

2426 i‡(!
domaö
->
±_roŸ
)

2427 
out_‰ì
;

2429 
dom
->
¥iv
 = 
domaö
;

2433 
out_‰ì
:

2434 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2436  -
ENOMEM
;

2437 
	}
}

2439 
	$amd_iommu_domaö_de°roy
(
iommu_domaö
 *
dom
)

2441 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2443 i‡(!
domaö
)

2446 i‡(
domaö
->
dev_˙t
 > 0)

2447 
	`˛ónup_domaö
(
domaö
);

2449 
	`BUG_ON
(
domaö
->
dev_˙t
 != 0);

2451 
	`‰ì_∑gëabÀ
(
domaö
);

2453 
	`¥Ÿe˘i⁄_domaö_‰ì
(
domaö
);

2455 
dom
->
¥iv
 = 
NULL
;

2456 
	}
}

2458 
	$amd_iommu_dëach_devi˚
(
iommu_domaö
 *
dom
,

2459 
devi˚
 *
dev
)

2461 
iommu_dev_d©a
 *
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2462 
amd_iommu
 *
iommu
;

2463 
u16
 
devid
;

2465 i‡(!
	`check_devi˚
(
dev
))

2468 
devid
 = 
	`gë_devi˚_id
(
dev
);

2470 i‡(
dev_d©a
->
domaö
 !
NULL
)

2471 
	`dëach_devi˚
(
dev
);

2473 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2474 i‡(!
iommu
)

2477 
	`iommu_Êush_devi˚
(
dev
);

2478 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2479 
	}
}

2481 
	$amd_iommu_©èch_devi˚
(
iommu_domaö
 *
dom
,

2482 
devi˚
 *
dev
)

2484 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2485 
iommu_dev_d©a
 *
dev_d©a
;

2486 
amd_iommu
 *
iommu
;

2487 
ªt
;

2488 
u16
 
devid
;

2490 i‡(!
	`check_devi˚
(
dev
))

2491  -
EINVAL
;

2493 
dev_d©a
 = 
dev
->
¨chd©a
.
iommu
;

2495 
devid
 = 
	`gë_devi˚_id
(
dev
);

2497 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2498 i‡(!
iommu
)

2499  -
EINVAL
;

2501 i‡(
dev_d©a
->
domaö
)

2502 
	`dëach_devi˚
(
dev
);

2504 
ªt
 = 
	`©èch_devi˚
(
dev
, 
domaö
);

2506 
	`iommu_com∂ëi⁄_waô
(
iommu
);

2508  
ªt
;

2509 
	}
}

2511 
	$amd_iommu_m≠
(
iommu_domaö
 *
dom
, 
iova
,

2512 
phys_addr_t
 
∑ddr
, 
gÂ_‹dî
, 
iommu_¥Ÿ
)

2514 
∑ge_size
 = 0x1000UL << 
gÂ_‹dî
;

2515 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2516 
¥Ÿ
 = 0;

2517 
ªt
;

2519 i‡(
iommu_¥Ÿ
 & 
IOMMU_READ
)

2520 
¥Ÿ
 |
IOMMU_PROT_IR
;

2521 i‡(
iommu_¥Ÿ
 & 
IOMMU_WRITE
)

2522 
¥Ÿ
 |
IOMMU_PROT_IW
;

2524 
	`muãx_lock
(&
domaö
->
≠i_lock
);

2525 
ªt
 = 
	`iommu_m≠_∑ge
(
domaö
, 
iova
, 
∑ddr
, 
¥Ÿ
, 
∑ge_size
);

2526 
	`muãx_u∆ock
(&
domaö
->
≠i_lock
);

2528  
ªt
;

2529 
	}
}

2531 
	$amd_iommu_unm≠
(
iommu_domaö
 *
dom
, 
iova
,

2532 
gÂ_‹dî
)

2534 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2535 
∑ge_size
, 
unm≠_size
;

2537 
∑ge_size
 = 0x1000UL << 
gÂ_‹dî
;

2539 
	`muãx_lock
(&
domaö
->
≠i_lock
);

2540 
unm≠_size
 = 
	`iommu_unm≠_∑ge
(
domaö
, 
iova
, 
∑ge_size
);

2541 
	`muãx_u∆ock
(&
domaö
->
≠i_lock
);

2543 
	`iommu_Êush_éb_pde
(
domaö
);

2545  
	`gë_‹dî
(
unm≠_size
);

2546 
	}
}

2548 
phys_addr_t
 
	$amd_iommu_iova_to_phys
(
iommu_domaö
 *
dom
,

2549 
iova
)

2551 
¥Ÿe˘i⁄_domaö
 *
domaö
 = 
dom
->
¥iv
;

2552 
off£t_mask
;

2553 
phys_addr_t
 
∑ddr
;

2554 
u64
 *
±e
, 
__±e
;

2556 
±e
 = 
	`„tch_±e
(
domaö
, 
iova
);

2558 i‡(!
±e
 || !
	`IOMMU_PTE_PRESENT
(*pte))

2561 i‡(
	`PM_PTE_LEVEL
(*
±e
) == 0)

2562 
off£t_mask
 = 
PAGE_SIZE
 - 1;

2564 
off£t_mask
 = 
	`PTE_PAGE_SIZE
(*
±e
) - 1;

2566 
__±e
 = *
±e
 & 
PM_ADDR_MASK
;

2567 
∑ddr
 = (
__±e
 & ~
off£t_mask
Ë| (
iova
 & offset_mask);

2569  
∑ddr
;

2570 
	}
}

2572 
	$amd_iommu_domaö_has_ˇp
(
iommu_domaö
 *
domaö
,

2573 
ˇp
)

2576 
	}
}

2578 
iommu_›s
 
	gamd_iommu_›s
 = {

2579 .
domaö_öô
 = 
amd_iommu_domaö_öô
,

2580 .
	gdomaö_de°roy
 = 
amd_iommu_domaö_de°roy
,

2581 .
	g©èch_dev
 = 
amd_iommu_©èch_devi˚
,

2582 .
	gdëach_dev
 = 
amd_iommu_dëach_devi˚
,

2583 .
	gm≠
 = 
amd_iommu_m≠
,

2584 .
	gunm≠
 = 
amd_iommu_unm≠
,

2585 .
	giova_to_phys
 = 
amd_iommu_iova_to_phys
,

2586 .
	gdomaö_has_ˇp
 = 
amd_iommu_domaö_has_ˇp
,

2599 
__öô
 
	$amd_iommu_öô_∑s°hrough
()

2601 
amd_iommu
 *
iommu
;

2602 
pci_dev
 *
dev
 = 
NULL
;

2603 
u16
 
devid
;

2606 
±_domaö
 = 
	`¥Ÿe˘i⁄_domaö_Æloc
();

2607 i‡(!
±_domaö
)

2608  -
ENOMEM
;

2610 
±_domaö
->
mode
 |
PAGE_MODE_NONE
;

2612 (
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev)Ë!
NULL
) {

2614 i‡(!
	`check_devi˚
(&
dev
->dev))

2617 
devid
 = 
	`gë_devi˚_id
(&
dev
->dev);

2619 
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

2620 i‡(!
iommu
)

2623 
	`©èch_devi˚
(&
dev
->dev, 
±_domaö
);

2626 
	`¥_öfo
("AMD-Vi: Initialized for Passthrough Mode\n");

2629 
	}
}

	@/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c

20 
	~<löux/pci.h
>

21 
	~<löux/a˝i.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/msi.h
>

27 
	~<asm/pci-dúe˘.h
>

28 
	~<asm/amd_iommu_¥Ÿo.h
>

29 
	~<asm/amd_iommu_ty≥s.h
>

30 
	~<asm/amd_iommu.h
>

31 
	~<asm/iommu.h
>

32 
	~<asm/g¨t.h
>

33 
	~<asm/x86_öô.h
>

38 
	#IVRS_HEADER_LENGTH
 48

	)

40 
	#ACPI_IVHD_TYPE
 0x10

	)

41 
	#ACPI_IVMD_TYPE_ALL
 0x20

	)

42 
	#ACPI_IVMD_TYPE
 0x21

	)

43 
	#ACPI_IVMD_TYPE_RANGE
 0x22

	)

45 
	#IVHD_DEV_ALL
 0x01

	)

46 
	#IVHD_DEV_SELECT
 0x02

	)

47 
	#IVHD_DEV_SELECT_RANGE_START
 0x03

	)

48 
	#IVHD_DEV_RANGE_END
 0x04

	)

49 
	#IVHD_DEV_ALIAS
 0x42

	)

50 
	#IVHD_DEV_ALIAS_RANGE
 0x43

	)

51 
	#IVHD_DEV_EXT_SELECT
 0x46

	)

52 
	#IVHD_DEV_EXT_SELECT_RANGE
 0x47

	)

54 
	#IVHD_FLAG_HT_TUN_EN_MASK
 0x01

	)

55 
	#IVHD_FLAG_PASSPW_EN_MASK
 0x02

	)

56 
	#IVHD_FLAG_RESPASSPW_EN_MASK
 0x04

	)

57 
	#IVHD_FLAG_ISOC_EN_MASK
 0x08

	)

59 
	#IVMD_FLAG_EXCL_RANGE
 0x08

	)

60 
	#IVMD_FLAG_UNITY_MAP
 0x01

	)

62 
	#ACPI_DEVFLAG_INITPASS
 0x01

	)

63 
	#ACPI_DEVFLAG_EXTINT
 0x02

	)

64 
	#ACPI_DEVFLAG_NMI
 0x04

	)

65 
	#ACPI_DEVFLAG_SYSMGT1
 0x10

	)

66 
	#ACPI_DEVFLAG_SYSMGT2
 0x20

	)

67 
	#ACPI_DEVFLAG_LINT0
 0x40

	)

68 
	#ACPI_DEVFLAG_LINT1
 0x80

	)

69 
	#ACPI_DEVFLAG_ATSDIS
 0x10000000

	)

82 
	sivhd_hódî
 {

83 
u8
 
	mty≥
;

84 
u8
 
	mÊags
;

85 
u16
 
	mÀngth
;

86 
u16
 
	mdevid
;

87 
u16
 
	mˇp_±r
;

88 
u64
 
	mmmio_phys
;

89 
u16
 
	mpci_£g
;

90 
u16
 
	möfo
;

91 
u32
 
	mª£rved
;

92 } 
__©åibuã__
((
∑cked
));

98 
	sivhd_íåy
 {

99 
u8
 
	mty≥
;

100 
u16
 
	mdevid
;

101 
u8
 
	mÊags
;

102 
u32
 
	mext
;

103 } 
__©åibuã__
((
∑cked
));

109 
	sivmd_hódî
 {

110 
u8
 
	mty≥
;

111 
u8
 
	mÊags
;

112 
u16
 
	mÀngth
;

113 
u16
 
	mdevid
;

114 
u16
 
	maux
;

115 
u64
 
	mªsv
;

116 
u64
 
	mønge_°¨t
;

117 
u64
 
	mønge_Àngth
;

118 } 
__©åibuã__
((
∑cked
));

120 
boﬁ
 
	gamd_iommu_dump
;

122 
__öôd©a
 
	gamd_iommu_dëe˘ed
;

123 
boﬁ
 
__öôd©a
 
	gamd_iommu_dißbÀd
;

125 
u16
 
	gamd_iommu_œ°_bdf
;

127 
LIST_HEAD
(
amd_iommu_unôy_m≠
);

129 
boﬁ
 
	gamd_iommu_unm≠_Êush
;

131 
LIST_HEAD
(
amd_iommu_li°
);

135 
amd_iommu
 *
	gamd_iommus
[
MAX_IOMMUS
];

136 
	gamd_iommus_¥e£¡
;

139 
boﬁ
 
amd_iommu_≈_ˇche
 
	g__ªad_mo°ly
;

144 
__öôd©a
 
	gamd_iommu_öô_îr
;

149 
LIST_HEAD
(
amd_iommu_pd_li°
);

150 
•ölock_t
 
	gamd_iommu_pd_lock
;

158 
dev_èbÀ_íåy
 *
	gamd_iommu_dev_èbÀ
;

165 
u16
 *
	gamd_iommu_Æüs_èbÀ
;

171 
amd_iommu
 **
	gamd_iommu_æookup_èbÀ
;

177 *
	gamd_iommu_pd_Æloc_bôm≠
;

179 
u32
 
	gdev_èbÀ_size
;

180 
u32
 
	gÆüs_èbÀ_size
;

181 
u32
 
	gæookup_èbÀ_size
;

183 
ölöe
 
	$upd©e_œ°_devid
(
u16
 
devid
)

185 i‡(
devid
 > 
amd_iommu_œ°_bdf
)

186 
amd_iommu_œ°_bdf
 = 
devid
;

187 
	}
}

189 
ölöe
 
	$tbl_size
(
íåy_size
)

191 
shi·
 = 
PAGE_SHIFT
 +

192 
	`gë_‹dî
((()
amd_iommu_œ°_bdf
 + 1Ë* 
íåy_size
);

194  1UL << 
shi·
;

195 
	}
}

210 
	$iommu_£t_ex˛usi⁄_ønge
(
amd_iommu
 *
iommu
)

212 
u64
 
°¨t
 = 
iommu
->
ex˛usi⁄_°¨t
 & 
PAGE_MASK
;

213 
u64
 
limô
 = (
°¨t
 + 
iommu
->
ex˛usi⁄_Àngth
Ë& 
PAGE_MASK
;

214 
u64
 
íåy
;

216 i‡(!
iommu
->
ex˛usi⁄_°¨t
)

219 
íåy
 = 
°¨t
 | 
MMIO_EXCL_ENABLE_MASK
;

220 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_BASE_OFFSET
,

221 &
íåy
, (entry));

223 
íåy
 = 
limô
;

224 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EXCL_LIMIT_OFFSET
,

225 &
íåy
, (entry));

226 
	}
}

229 
__öô
 
	$iommu_£t_devi˚_èbÀ
(
amd_iommu
 *
iommu
)

231 
u64
 
íåy
;

233 
	`BUG_ON
(
iommu
->
mmio_ba£
 =
NULL
);

235 
íåy
 = 
	`vút_to_phys
(
amd_iommu_dev_èbÀ
);

236 
íåy
 |(
dev_èbÀ_size
 >> 12) - 1;

237 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_DEV_TABLE_OFFSET
,

238 &
íåy
, (entry));

239 
	}
}

242 
	$iommu_„©uª_íabÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

244 
u32
 
˘æ
;

246 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

247 
˘æ
 |(1 << 
bô
);

248 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

249 
	}
}

251 
	$iommu_„©uª_dißbÀ
(
amd_iommu
 *
iommu
, 
u8
 
bô
)

253 
u32
 
˘æ
;

255 
˘æ
 = 
	`ªadl
(
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

256 
˘æ
 &~(1 << 
bô
);

257 
	`wrôñ
(
˘æ
, 
iommu
->
mmio_ba£
 + 
MMIO_CONTROL_OFFSET
);

258 
	}
}

261 
	$iommu_íabÀ
(
amd_iommu
 *
iommu
)

263 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Enabling IOMMUát %s cap 0x%hx\n",

264 
	`dev_«me
(&
iommu
->
dev
->dev), iommu->
ˇp_±r
);

266 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

267 
	}
}

269 
	$iommu_dißbÀ
(
amd_iommu
 *
iommu
)

272 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

275 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

276 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

279 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_IOMMU_EN
);

280 
	}
}

286 
u8
 * 
__öô
 
	$iommu_m≠_mmio_•a˚
(
u64
 
addªss
)

288 
u8
 *
ªt
;

290 i‡(!
	`ªque°_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
, "amd_iommu")) {

291 
	`¥_îr
("AMD-Vi: CanÇotÑeserve memoryÑegion %llx for mmio\n",

292 
addªss
);

293 
	`¥_îr
("AMD-Vi: This isá BIOS bug. Please contact your hardware vendor\n");

294  
NULL
;

297 
ªt
 = 
	`i‹em≠_noˇche
(
addªss
, 
MMIO_REGION_LENGTH
);

298 i‡(
ªt
 !
NULL
)

299  
ªt
;

301 
	`ªÀa£_mem_ªgi⁄
(
addªss
, 
MMIO_REGION_LENGTH
);

303  
NULL
;

304 
	}
}

306 
__öô
 
	$iommu_unm≠_mmio_•a˚
(
amd_iommu
 *
iommu
)

308 i‡(
iommu
->
mmio_ba£
)

309 
	`iounm≠
(
iommu
->
mmio_ba£
);

310 
	`ªÀa£_mem_ªgi⁄
(
iommu
->
mmio_phys
, 
MMIO_REGION_LENGTH
);

311 
	}
}

325 
ölöe
 
	$ivhd_íåy_Àngth
(
u8
 *
ivhd
)

327  0x04 << (*
ivhd
 >> 6);

328 
	}
}

334 
__öô
 
	$föd_œ°_devid_⁄_pci
(
bus
, 
dev
, 
‚
, 
ˇp_±r
)

336 
u32
 
ˇp
;

338 
ˇp
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 
‚
, 
ˇp_±r
+
MMIO_RANGE_OFFSET
);

339 
	`upd©e_œ°_devid
(
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ˇp
), 
	`MMIO_GET_LD
(cap)));

342 
	}
}

348 
__öô
 
	$föd_œ°_devid_‰om_ivhd
(
ivhd_hódî
 *
h
)

350 
u8
 *
p
 = (*)
h
, *
íd
 = (*)h;

351 
ivhd_íåy
 *
dev
;

353 
p
 +(*
h
);

354 
íd
 +
h
->
Àngth
;

356 
	`föd_œ°_devid_⁄_pci
(
	`PCI_BUS
(
h
->
devid
),

357 
	`PCI_SLOT
(
h
->
devid
),

358 
	`PCI_FUNC
(
h
->
devid
),

359 
h
->
ˇp_±r
);

361 
p
 < 
íd
) {

362 
dev
 = (
ivhd_íåy
 *)
p
;

363 
dev
->
ty≥
) {

364 
IVHD_DEV_SELECT
:

365 
IVHD_DEV_RANGE_END
:

366 
IVHD_DEV_ALIAS
:

367 
IVHD_DEV_EXT_SELECT
:

369 
	`upd©e_œ°_devid
(
dev
->
devid
);

374 
p
 +
	`ivhd_íåy_Àngth
(p);

377 
	`WARN_ON
(
p
 !
íd
);

380 
	}
}

387 
__öô
 
	$föd_œ°_devid_a˝i
(
a˝i_èbÀ_hódî
 *
èbÀ
)

389 
i
;

390 
u8
 
checksum
 = 0, *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

391 
ivhd_hódî
 *
h
;

397 
i
 = 0; i < 
èbÀ
->
Àngth
; ++i)

398 
checksum
 +
p
[
i
];

399 i‡(
checksum
 != 0) {

401 
amd_iommu_öô_îr
 = -
ENODEV
;

405 
p
 +
IVRS_HEADER_LENGTH
;

407 
íd
 +
èbÀ
->
Àngth
;

408 
p
 < 
íd
) {

409 
h
 = (
ivhd_hódî
 *)
p
;

410 
h
->
ty≥
) {

411 
ACPI_IVHD_TYPE
:

412 
	`föd_œ°_devid_‰om_ivhd
(
h
);

417 
p
 +
h
->
Àngth
;

419 
	`WARN_ON
(
p
 !
íd
);

422 
	}
}

438 
u8
 * 
__öô
 
	$Æloc_comm™d_buf„r
(
amd_iommu
 *
iommu
)

440 
u8
 *
cmd_buf
 = (u8 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

441 
	`gë_‹dî
(
CMD_BUFFER_SIZE
));

443 i‡(
cmd_buf
 =
NULL
)

444  
NULL
;

446 
iommu
->
cmd_buf_size
 = 
CMD_BUFFER_SIZE
 | 
CMD_BUFFER_UNINITIALIZED
;

448  
cmd_buf
;

449 
	}
}

455 
	$amd_iommu_ª£t_cmd_buf„r
(
amd_iommu
 *
iommu
)

457 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

459 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_HEAD_OFFSET
);

460 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_CMD_TAIL_OFFSET
);

462 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_CMDBUF_EN
);

463 
	}
}

469 
	$iommu_íabÀ_comm™d_buf„r
(
amd_iommu
 *
iommu
)

471 
u64
 
íåy
;

473 
	`BUG_ON
(
iommu
->
cmd_buf
 =
NULL
);

475 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
cmd_buf
);

476 
íåy
 |
MMIO_CMD_SIZE_512
;

478 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_CMD_BUF_OFFSET
,

479 &
íåy
, (entry));

481 
	`amd_iommu_ª£t_cmd_buf„r
(
iommu
);

482 
iommu
->
cmd_buf_size
 &~(
CMD_BUFFER_UNINITIALIZED
);

483 
	}
}

485 
__öô
 
	$‰ì_comm™d_buf„r
(
amd_iommu
 *
iommu
)

487 
	`‰ì_∑ges
(()
iommu
->
cmd_buf
,

488 
	`gë_‹dî
(
iommu
->
cmd_buf_size
 & ~(
CMD_BUFFER_UNINITIALIZED
)));

489 
	}
}

492 
u8
 * 
__öô
 
	$Æloc_evít_buf„r
(
amd_iommu
 *
iommu
)

494 
iommu
->
evt_buf
 = (
u8
 *)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

495 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

497 i‡(
iommu
->
evt_buf
 =
NULL
)

498  
NULL
;

500 
iommu
->
evt_buf_size
 = 
EVT_BUFFER_SIZE
;

502  
iommu
->
evt_buf
;

503 
	}
}

505 
	$iommu_íabÀ_evít_buf„r
(
amd_iommu
 *
iommu
)

507 
u64
 
íåy
;

509 
	`BUG_ON
(
iommu
->
evt_buf
 =
NULL
);

511 
íåy
 = (
u64
)
	`vút_to_phys
(
iommu
->
evt_buf
Ë| 
EVT_LEN_MASK
;

513 
	`mem˝y_toio
(
iommu
->
mmio_ba£
 + 
MMIO_EVT_BUF_OFFSET
,

514 &
íåy
, (entry));

517 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_HEAD_OFFSET
);

518 
	`wrôñ
(0x00, 
iommu
->
mmio_ba£
 + 
MMIO_EVT_TAIL_OFFSET
);

520 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_LOG_EN
);

521 
	}
}

523 
__öô
 
	$‰ì_evít_buf„r
(
amd_iommu
 *
iommu
)

525 
	`‰ì_∑ges
(()
iommu
->
evt_buf
, 
	`gë_‹dî
(
EVT_BUFFER_SIZE
));

526 
	}
}

529 
	$£t_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

531 
i
 = (
bô
 >> 5) & 0x07;

532 
_bô
 = 
bô
 & 0x1f;

534 
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] |(1 << 
_bô
);

535 
	}
}

537 
	$gë_dev_íåy_bô
(
u16
 
devid
, 
u8
 
bô
)

539 
i
 = (
bô
 >> 5) & 0x07;

540 
_bô
 = 
bô
 & 0x1f;

542  (
amd_iommu_dev_èbÀ
[
devid
].
d©a
[
i
] & (1 << 
_bô
)) >> _bit;

543 
	}
}

546 
	$amd_iommu_≠∂y_îøtum_63
(
u16
 
devid
)

548 
sysmgt
;

550 
sysmgt
 = 
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
) |

551 (
	`gë_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
) << 1);

553 i‡(
sysmgt
 == 0x01)

554 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_IW
);

555 
	}
}

558 
__öô
 
	$£t_iommu_f‹_devi˚
(
amd_iommu
 *
iommu
, 
u16
 
devid
)

560 
amd_iommu_æookup_èbÀ
[
devid
] = 
iommu
;

561 
	}
}

567 
__öô
 
	$£t_dev_íåy_‰om_a˝i
(
amd_iommu
 *
iommu
,

568 
u16
 
devid
, 
u32
 
Êags
, u32 
ext_Êags
)

570 i‡(
Êags
 & 
ACPI_DEVFLAG_INITPASS
)

571 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_INIT_PASS
);

572 i‡(
Êags
 & 
ACPI_DEVFLAG_EXTINT
)

573 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_EINT_PASS
);

574 i‡(
Êags
 & 
ACPI_DEVFLAG_NMI
)

575 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_NMI_PASS
);

576 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT1
)

577 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT1
);

578 i‡(
Êags
 & 
ACPI_DEVFLAG_SYSMGT2
)

579 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_SYSMGT2
);

580 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT0
)

581 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT0_PASS
);

582 i‡(
Êags
 & 
ACPI_DEVFLAG_LINT1
)

583 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_LINT1_PASS
);

585 
	`amd_iommu_≠∂y_îøtum_63
(
devid
);

587 
	`£t_iommu_f‹_devi˚
(
iommu
, 
devid
);

588 
	}
}

594 
__öô
 
	$£t_devi˚_ex˛usi⁄_ønge
(
u16
 
devid
, 
ivmd_hódî
 *
m
)

596 
amd_iommu
 *
iommu
 = 
amd_iommu_æookup_èbÀ
[
devid
];

598 i‡(!(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
))

601 i‡(
iommu
) {

607 
	`£t_dev_íåy_bô
(
m
->
devid
, 
DEV_ENTRY_EX
);

608 
iommu
->
ex˛usi⁄_°¨t
 = 
m
->
ønge_°¨t
;

609 
iommu
->
ex˛usi⁄_Àngth
 = 
m
->
ønge_Àngth
;

611 
	}
}

618 
__öô
 
	$öô_iommu_‰om_pci
(
amd_iommu
 *
iommu
)

620 
ˇp_±r
 = 
iommu
->cap_ptr;

621 
u32
 
ønge
, 
misc
;

623 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_CAP_HDR_OFFSET
,

624 &
iommu
->
ˇp
);

625 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_RANGE_OFFSET
,

626 &
ønge
);

627 
	`pci_ªad_c⁄fig_dw‹d
(
iommu
->
dev
, 
ˇp_±r
 + 
MMIO_MISC_OFFSET
,

628 &
misc
);

630 
iommu
->
fú°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

631 
	`MMIO_GET_FD
(
ønge
));

632 
iommu
->
œ°_devi˚
 = 
	`ˇlc_devid
(
	`MMIO_GET_BUS
(
ønge
),

633 
	`MMIO_GET_LD
(
ønge
));

634 
iommu
->
evt_msi_num
 = 
	`MMIO_MSI_NUM
(
misc
);

635 
	}
}

641 
__öô
 
	$öô_iommu_‰om_a˝i
(
amd_iommu
 *
iommu
,

642 
ivhd_hódî
 *
h
)

644 
u8
 *
p
 = (u8 *)
h
;

645 
u8
 *
íd
 = 
p
, 
Êags
 = 0;

646 
u16
 
dev_i
, 
devid
 = 0, 
devid_°¨t
 = 0, 
devid_to
 = 0;

647 
u32
 
ext_Êags
 = 0;

648 
boﬁ
 
Æüs
 = 
Ál£
;

649 
ivhd_íåy
 *
e
;

655 
h
->
Êags
 & 
IVHD_FLAG_HT_TUN_EN_MASK
 ?

656 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_HT_TUN_EN
) :

657 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_HT_TUN_EN
);

659 
h
->
Êags
 & 
IVHD_FLAG_PASSPW_EN_MASK
 ?

660 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_PASSPW_EN
) :

661 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_PASSPW_EN
);

663 
h
->
Êags
 & 
IVHD_FLAG_RESPASSPW_EN_MASK
 ?

664 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
) :

665 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_RESPASSPW_EN
);

667 
h
->
Êags
 & 
IVHD_FLAG_ISOC_EN_MASK
 ?

668 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_ISOC_EN
) :

669 
	`iommu_„©uª_dißbÀ
(
iommu
, 
CONTROL_ISOC_EN
);

674 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_COHERENT_EN
);

679 
p
 +(
ivhd_hódî
);

680 
íd
 +
h
->
Àngth
;

683 
p
 < 
íd
) {

684 
e
 = (
ivhd_íåy
 *)
p
;

685 
e
->
ty≥
) {

686 
IVHD_DEV_ALL
:

688 
	`DUMP_¥ötk
(" DEV_ALL\t\t\t first devid: %02x:%02x.%x"

690 
	`PCI_BUS
(
iommu
->
fú°_devi˚
),

691 
	`PCI_SLOT
(
iommu
->
fú°_devi˚
),

692 
	`PCI_FUNC
(
iommu
->
fú°_devi˚
),

693 
	`PCI_BUS
(
iommu
->
œ°_devi˚
),

694 
	`PCI_SLOT
(
iommu
->
œ°_devi˚
),

695 
	`PCI_FUNC
(
iommu
->
œ°_devi˚
),

696 
e
->
Êags
);

698 
dev_i
 = 
iommu
->
fú°_devi˚
;

699 
dev_i
 <
iommu
->
œ°_devi˚
; ++dev_i)

700 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

701 
e
->
Êags
, 0);

703 
IVHD_DEV_SELECT
:

705 
	`DUMP_¥ötk
(" DEV_SELECT\t\t\t devid: %02x:%02x.%x "

707 
	`PCI_BUS
(
e
->
devid
),

708 
	`PCI_SLOT
(
e
->
devid
),

709 
	`PCI_FUNC
(
e
->
devid
),

710 
e
->
Êags
);

712 
devid
 = 
e
->devid;

713 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
, 0);

715 
IVHD_DEV_SELECT_RANGE_START
:

717 
	`DUMP_¥ötk
(" DEV_SELECT_RANGE_START\t "

719 
	`PCI_BUS
(
e
->
devid
),

720 
	`PCI_SLOT
(
e
->
devid
),

721 
	`PCI_FUNC
(
e
->
devid
),

722 
e
->
Êags
);

724 
devid_°¨t
 = 
e
->
devid
;

725 
Êags
 = 
e
->flags;

726 
ext_Êags
 = 0;

727 
Æüs
 = 
Ál£
;

729 
IVHD_DEV_ALIAS
:

731 
	`DUMP_¥ötk
(" DEV_ALIAS\t\t\t devid: %02x:%02x.%x "

733 
	`PCI_BUS
(
e
->
devid
),

734 
	`PCI_SLOT
(
e
->
devid
),

735 
	`PCI_FUNC
(
e
->
devid
),

736 
e
->
Êags
,

737 
	`PCI_BUS
(
e
->
ext
 >> 8),

738 
	`PCI_SLOT
(
e
->
ext
 >> 8),

739 
	`PCI_FUNC
(
e
->
ext
 >> 8));

741 
devid
 = 
e
->devid;

742 
devid_to
 = 
e
->
ext
 >> 8;

743 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
 , 
e
->
Êags
, 0);

744 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid_to
, 
e
->
Êags
, 0);

745 
amd_iommu_Æüs_èbÀ
[
devid
] = 
devid_to
;

747 
IVHD_DEV_ALIAS_RANGE
:

749 
	`DUMP_¥ötk
(" DEV_ALIAS_RANGE\t\t "

752 
	`PCI_BUS
(
e
->
devid
),

753 
	`PCI_SLOT
(
e
->
devid
),

754 
	`PCI_FUNC
(
e
->
devid
),

755 
e
->
Êags
,

756 
	`PCI_BUS
(
e
->
ext
 >> 8),

757 
	`PCI_SLOT
(
e
->
ext
 >> 8),

758 
	`PCI_FUNC
(
e
->
ext
 >> 8));

760 
devid_°¨t
 = 
e
->
devid
;

761 
Êags
 = 
e
->flags;

762 
devid_to
 = 
e
->
ext
 >> 8;

763 
ext_Êags
 = 0;

764 
Æüs
 = 
åue
;

766 
IVHD_DEV_EXT_SELECT
:

768 
	`DUMP_¥ötk
(" DEV_EXT_SELECT\t\t devid: %02x:%02x.%x "

770 
	`PCI_BUS
(
e
->
devid
),

771 
	`PCI_SLOT
(
e
->
devid
),

772 
	`PCI_FUNC
(
e
->
devid
),

773 
e
->
Êags
,É->
ext
);

775 
devid
 = 
e
->devid;

776 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
devid
, 
e
->
Êags
,

777 
e
->
ext
);

779 
IVHD_DEV_EXT_SELECT_RANGE
:

781 
	`DUMP_¥ötk
(" DEV_EXT_SELECT_RANGE\t devid: "

783 
	`PCI_BUS
(
e
->
devid
),

784 
	`PCI_SLOT
(
e
->
devid
),

785 
	`PCI_FUNC
(
e
->
devid
),

786 
e
->
Êags
,É->
ext
);

788 
devid_°¨t
 = 
e
->
devid
;

789 
Êags
 = 
e
->flags;

790 
ext_Êags
 = 
e
->
ext
;

791 
Æüs
 = 
Ál£
;

793 
IVHD_DEV_RANGE_END
:

795 
	`DUMP_¥ötk
(" DEV_RANGE_END\t\t devid: %02x:%02x.%x\n",

796 
	`PCI_BUS
(
e
->
devid
),

797 
	`PCI_SLOT
(
e
->
devid
),

798 
	`PCI_FUNC
(
e
->
devid
));

800 
devid
 = 
e
->devid;

801 
dev_i
 = 
devid_°¨t
; dev_ò<
devid
; ++dev_i) {

802 i‡(
Æüs
) {

803 
amd_iommu_Æüs_èbÀ
[
dev_i
] = 
devid_to
;

804 
	`£t_dev_íåy_‰om_a˝i
(
iommu
,

805 
devid_to
, 
Êags
, 
ext_Êags
);

807 
	`£t_dev_íåy_‰om_a˝i
(
iommu
, 
dev_i
,

808 
Êags
, 
ext_Êags
);

815 
p
 +
	`ivhd_íåy_Àngth
(p);

817 
	}
}

820 
__öô
 
	$öô_iommu_devi˚s
(
amd_iommu
 *
iommu
)

822 
u16
 
i
;

824 
i
 = 
iommu
->
fú°_devi˚
; i <iommu->
œ°_devi˚
; ++i)

825 
	`£t_iommu_f‹_devi˚
(
iommu
, 
i
);

828 
	}
}

830 
__öô
 
	$‰ì_iommu_⁄e
(
amd_iommu
 *
iommu
)

832 
	`‰ì_comm™d_buf„r
(
iommu
);

833 
	`‰ì_evít_buf„r
(
iommu
);

834 
	`iommu_unm≠_mmio_•a˚
(
iommu
);

835 
	}
}

837 
__öô
 
	$‰ì_iommu_Æl
()

839 
amd_iommu
 *
iommu
, *
√xt
;

841 
	`f‹_óch_iommu_ß„
(
iommu
, 
√xt
) {

842 
	`li°_dñ
(&
iommu
->
li°
);

843 
	`‰ì_iommu_⁄e
(
iommu
);

844 
	`k‰ì
(
iommu
);

846 
	}
}

853 
__öô
 
	$öô_iommu_⁄e
(
amd_iommu
 *
iommu
, 
ivhd_hódî
 *
h
)

855 
	`•ö_lock_öô
(&
iommu
->
lock
);

858 
	`li°_add_èû
(&
iommu
->
li°
, &
amd_iommu_li°
);

859 
iommu
->
ödex
 = 
amd_iommus_¥e£¡
++;

861 i‡(
	`u∆ikñy
(
iommu
->
ödex
 >
MAX_IOMMUS
)) {

862 
	`WARN
(1, "AMD-Vi: System has more IOMMUsÅhan supported byÅhis driver\n");

863  -
ENOSYS
;

867 
amd_iommus
[
iommu
->
ödex
] = iommu;

872 
iommu
->
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
	`PCI_BUS
(
h
->
devid
), h->devid & 0xff);

873 i‡(!
iommu
->
dev
)

876 
iommu
->
ˇp_±r
 = 
h
->cap_ptr;

877 
iommu
->
pci_£g
 = 
h
->pci_seg;

878 
iommu
->
mmio_phys
 = 
h
->mmio_phys;

879 
iommu
->
mmio_ba£
 = 
	`iommu_m≠_mmio_•a˚
(
h
->
mmio_phys
);

880 i‡(!
iommu
->
mmio_ba£
)

881  -
ENOMEM
;

883 
iommu
->
cmd_buf
 = 
	`Æloc_comm™d_buf„r
(iommu);

884 i‡(!
iommu
->
cmd_buf
)

885  -
ENOMEM
;

887 
iommu
->
evt_buf
 = 
	`Æloc_evít_buf„r
(iommu);

888 i‡(!
iommu
->
evt_buf
)

889  -
ENOMEM
;

891 
iommu
->
öt_íabÀd
 = 
Ál£
;

893 
	`öô_iommu_‰om_pci
(
iommu
);

894 
	`öô_iommu_‰om_a˝i
(
iommu
, 
h
);

895 
	`öô_iommu_devi˚s
(
iommu
);

897 i‡(
iommu
->
ˇp
 & (1UL << 
IOMMU_CAP_NPCACHE
))

898 
amd_iommu_≈_ˇche
 = 
åue
;

900  
	`pci_íabÀ_devi˚
(
iommu
->
dev
);

901 
	}
}

907 
__öô
 
	$öô_iommu_Æl
(
a˝i_èbÀ_hódî
 *
èbÀ
)

909 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

910 
ivhd_hódî
 *
h
;

911 
amd_iommu
 *
iommu
;

912 
ªt
;

914 
íd
 +
èbÀ
->
Àngth
;

915 
p
 +
IVRS_HEADER_LENGTH
;

917 
p
 < 
íd
) {

918 
h
 = (
ivhd_hódî
 *)
p
;

919 *
p
) {

920 
ACPI_IVHD_TYPE
:

922 
	`DUMP_¥ötk
("device: %02x:%02x.%01x cap: %04x "

924 
	`PCI_BUS
(
h
->
devid
), 
	`PCI_SLOT
(h->devid),

925 
	`PCI_FUNC
(
h
->
devid
), h->
ˇp_±r
,

926 
h
->
pci_£g
, h->
Êags
, h->
öfo
);

927 
	`DUMP_¥ötk
(" mmio-addr: %016llx\n",

928 
h
->
mmio_phys
);

930 
iommu
 = 
	`kzÆloc
((
amd_iommu
), 
GFP_KERNEL
);

931 i‡(
iommu
 =
NULL
) {

932 
amd_iommu_öô_îr
 = -
ENOMEM
;

936 
ªt
 = 
	`öô_iommu_⁄e
(
iommu
, 
h
);

937 i‡(
ªt
) {

938 
amd_iommu_öô_îr
 = 
ªt
;

945 
p
 +
h
->
Àngth
;

948 
	`WARN_ON
(
p
 !
íd
);

951 
	}
}

962 
	$iommu_£tup_msi
(
amd_iommu
 *
iommu
)

964 
r
;

966 i‡(
	`pci_íabÀ_msi
(
iommu
->
dev
))

969 
r
 = 
	`ªque°_úq
(
iommu
->
dev
->
úq
, 
amd_iommu_öt_h™dÀr
,

970 
IRQF_SAMPLE_RANDOM
,

972 
NULL
);

974 i‡(
r
) {

975 
	`pci_dißbÀ_msi
(
iommu
->
dev
);

979 
iommu
->
öt_íabÀd
 = 
åue
;

980 
	`iommu_„©uª_íabÀ
(
iommu
, 
CONTROL_EVT_INT_EN
);

983 
	}
}

985 
	$iommu_öô_msi
(
amd_iommu
 *
iommu
)

987 i‡(
iommu
->
öt_íabÀd
)

990 i‡(
	`pci_föd_ˇ∑bûôy
(
iommu
->
dev
, 
PCI_CAP_ID_MSI
))

991  
	`iommu_£tup_msi
(
iommu
);

994 
	}
}

1004 
__öô
 
	$‰ì_unôy_m≠s
()

1006 
unôy_m≠_íåy
 *
íåy
, *
√xt
;

1008 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, &
amd_iommu_unôy_m≠
, 
li°
) {

1009 
	`li°_dñ
(&
íåy
->
li°
);

1010 
	`k‰ì
(
íåy
);

1012 
	}
}

1015 
__öô
 
	$öô_ex˛usi⁄_ønge
(
ivmd_hódî
 *
m
)

1017 
i
;

1019 
m
->
ty≥
) {

1020 
ACPI_IVMD_TYPE
:

1021 
	`£t_devi˚_ex˛usi⁄_ønge
(
m
->
devid
, m);

1023 
ACPI_IVMD_TYPE_ALL
:

1024 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1025 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1027 
ACPI_IVMD_TYPE_RANGE
:

1028 
i
 = 
m
->
devid
; i <m->
aux
; ++i)

1029 
	`£t_devi˚_ex˛usi⁄_ønge
(
i
, 
m
);

1036 
	}
}

1039 
__öô
 
	$öô_unôy_m≠_ønge
(
ivmd_hódî
 *
m
)

1041 
unôy_m≠_íåy
 *
e
 = 0;

1042 *
s
;

1044 
e
 = 
	`kzÆloc
((*e), 
GFP_KERNEL
);

1045 i‡(
e
 =
NULL
)

1046  -
ENOMEM
;

1048 
m
->
ty≥
) {

1050 
	`k‰ì
(
e
);

1052 
ACPI_IVMD_TYPE
:

1053 
s
 = "IVMD_TYPEi\t\t\t";

1054 
e
->
devid_°¨t
 =É->
devid_íd
 = 
m
->
devid
;

1056 
ACPI_IVMD_TYPE_ALL
:

1057 
s
 = "IVMD_TYPE_ALL\t\t";

1058 
e
->
devid_°¨t
 = 0;

1059 
e
->
devid_íd
 = 
amd_iommu_œ°_bdf
;

1061 
ACPI_IVMD_TYPE_RANGE
:

1062 
s
 = "IVMD_TYPE_RANGE\t\t";

1063 
e
->
devid_°¨t
 = 
m
->
devid
;

1064 
e
->
devid_íd
 = 
m
->
aux
;

1067 
e
->
addªss_°¨t
 = 
	`PAGE_ALIGN
(
m
->
ønge_°¨t
);

1068 
e
->
addªss_íd
 =É->
addªss_°¨t
 + 
	`PAGE_ALIGN
(
m
->
ønge_Àngth
);

1069 
e
->
¥Ÿ
 = 
m
->
Êags
 >> 1;

1071 
	`DUMP_¥ötk
("%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x"

1072 "Ñ™ge_°¨t: %016ŒxÑ™ge_íd: %016Œx fœgs: %x\n", 
s
,

1073 
	`PCI_BUS
(
e
->
devid_°¨t
), 
	`PCI_SLOT
(e->devid_start),

1074 
	`PCI_FUNC
(
e
->
devid_°¨t
), 
	`PCI_BUS
”->
devid_íd
),

1075 
	`PCI_SLOT
(
e
->
devid_íd
), 
	`PCI_FUNC
(e->devid_end),

1076 
e
->
addªss_°¨t
,É->
addªss_íd
, 
m
->
Êags
);

1078 
	`li°_add_èû
(&
e
->
li°
, &
amd_iommu_unôy_m≠
);

1081 
	}
}

1084 
__öô
 
	$öô_mem‹y_deföôi⁄s
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1086 
u8
 *
p
 = (u8 *)
èbÀ
, *
íd
 = (u8 *)table;

1087 
ivmd_hódî
 *
m
;

1089 
íd
 +
èbÀ
->
Àngth
;

1090 
p
 +
IVRS_HEADER_LENGTH
;

1092 
p
 < 
íd
) {

1093 
m
 = (
ivmd_hódî
 *)
p
;

1094 i‡(
m
->
Êags
 & 
IVMD_FLAG_EXCL_RANGE
)

1095 
	`öô_ex˛usi⁄_ønge
(
m
);

1096 i‡(
m
->
Êags
 & 
IVMD_FLAG_UNITY_MAP
)

1097 
	`öô_unôy_m≠_ønge
(
m
);

1099 
p
 +
m
->
Àngth
;

1103 
	}
}

1109 
	$öô_devi˚_èbÀ
()

1111 
u16
 
devid
;

1113 
devid
 = 0; devid <
amd_iommu_œ°_bdf
; ++devid) {

1114 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_VALID
);

1115 
	`£t_dev_íåy_bô
(
devid
, 
DEV_ENTRY_TRANSLATION
);

1117 
	}
}

1123 
	$íabÀ_iommus
()

1125 
amd_iommu
 *
iommu
;

1127 
	`f‹_óch_iommu
(
iommu
) {

1128 
	`iommu_dißbÀ
(
iommu
);

1129 
	`iommu_£t_devi˚_èbÀ
(
iommu
);

1130 
	`iommu_íabÀ_comm™d_buf„r
(
iommu
);

1131 
	`iommu_íabÀ_evít_buf„r
(
iommu
);

1132 
	`iommu_£t_ex˛usi⁄_ønge
(
iommu
);

1133 
	`iommu_öô_msi
(
iommu
);

1134 
	`iommu_íabÀ
(
iommu
);

1136 
	}
}

1138 
	$dißbÀ_iommus
()

1140 
amd_iommu
 *
iommu
;

1142 
	`f‹_óch_iommu
(
iommu
)

1143 
	`iommu_dißbÀ
(
iommu
);

1144 
	}
}

1151 
	$amd_iommu_ªsume
(
sys_devi˚
 *
dev
)

1154 
	`íabÀ_iommus
();

1160 
	`amd_iommu_Êush_Æl_devi˚s
();

1161 
	`amd_iommu_Êush_Æl_domaös
();

1164 
	}
}

1166 
	$amd_iommu_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1169 
	`dißbÀ_iommus
();

1172 
	}
}

1174 
sysdev_˛ass
 
	gamd_iommu_sysdev_˛ass
 = {

1175 .
«me
 = "amd_iommu",

1176 .
	gsu•íd
 = 
amd_iommu_su•íd
,

1177 .
	gªsume
 = 
amd_iommu_ªsume
,

1180 
sys_devi˚
 
	gdevi˚_amd_iommu
 = {

1181 .
id
 = 0,

1182 .
	g˛s
 = &
amd_iommu_sysdev_˛ass
,

1213 
__öô
 
	$amd_iommu_öô
()

1215 
i
, 
ªt
 = 0;

1222 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
föd_œ°_devid_a˝i
) != 0)

1223  -
ENODEV
;

1225 
ªt
 = 
amd_iommu_öô_îr
;

1226 i‡(
ªt
)

1227 
out
;

1229 
dev_èbÀ_size
 = 
	`tbl_size
(
DEV_TABLE_ENTRY_SIZE
);

1230 
Æüs_èbÀ_size
 = 
	`tbl_size
(
ALIAS_TABLE_ENTRY_SIZE
);

1231 
æookup_èbÀ_size
 = 
	`tbl_size
(
RLOOKUP_TABLE_ENTRY_SIZE
);

1233 
ªt
 = -
ENOMEM
;

1236 
amd_iommu_dev_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

1237 
	`gë_‹dî
(
dev_èbÀ_size
));

1238 i‡(
amd_iommu_dev_èbÀ
 =
NULL
)

1239 
out
;

1245 
amd_iommu_Æüs_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1246 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1247 i‡(
amd_iommu_Æüs_èbÀ
 =
NULL
)

1248 
‰ì
;

1251 
amd_iommu_æookup_èbÀ
 = (*)
	`__gë_‰ì_∑ges
(

1252 
GFP_KERNEL
 | 
__GFP_ZERO
,

1253 
	`gë_‹dî
(
æookup_èbÀ_size
));

1254 i‡(
amd_iommu_æookup_èbÀ
 =
NULL
)

1255 
‰ì
;

1257 
amd_iommu_pd_Æloc_bôm≠
 = (*)
	`__gë_‰ì_∑ges
(

1258 
GFP_KERNEL
 | 
__GFP_ZERO
,

1259 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1260 i‡(
amd_iommu_pd_Æloc_bôm≠
 =
NULL
)

1261 
‰ì
;

1264 
	`öô_devi˚_èbÀ
();

1269 
i
 = 0; i <
amd_iommu_œ°_bdf
; ++i)

1270 
amd_iommu_Æüs_èbÀ
[
i
] = i;

1276 
amd_iommu_pd_Æloc_bôm≠
[0] = 1;

1278 
	`•ö_lock_öô
(&
amd_iommu_pd_lock
);

1284 
ªt
 = -
ENODEV
;

1285 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_iommu_Æl
) != 0)

1286 
‰ì
;

1288 i‡(
amd_iommu_öô_îr
) {

1289 
ªt
 = 
amd_iommu_öô_îr
;

1290 
‰ì
;

1293 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
öô_mem‹y_deföôi⁄s
) != 0)

1294 
‰ì
;

1296 i‡(
amd_iommu_öô_îr
) {

1297 
ªt
 = 
amd_iommu_öô_îr
;

1298 
‰ì
;

1301 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
amd_iommu_sysdev_˛ass
);

1302 i‡(
ªt
)

1303 
‰ì
;

1305 
ªt
 = 
	`sysdev_ªgi°î
(&
devi˚_amd_iommu
);

1306 i‡(
ªt
)

1307 
‰ì
;

1309 
ªt
 = 
	`amd_iommu_öô_devi˚s
();

1310 i‡(
ªt
)

1311 
‰ì
;

1313 
	`íabÀ_iommus
();

1315 i‡(
iommu_∑ss_through
)

1316 
ªt
 = 
	`amd_iommu_öô_∑s°hrough
();

1318 
ªt
 = 
	`amd_iommu_öô_dma_›s
();

1320 i‡(
ªt
)

1321 
‰ì_dißbÀ
;

1323 
	`amd_iommu_öô_≠i
();

1325 
	`amd_iommu_öô_nŸifõr
();

1327 i‡(
iommu_∑ss_through
)

1328 
out
;

1330 i‡(
amd_iommu_unm≠_Êush
)

1331 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: IO/TLB flush on unmapÉnabled\n");

1333 
	`¥ötk
(
KERN_INFO
 "AMD-Vi: Lazy IO/TLB flushingÉnabled\n");

1335 
x86_∂©f‹m
.
iommu_shutdown
 = 
dißbÀ_iommus
;

1336 
out
:

1337  
ªt
;

1339 
‰ì_dißbÀ
:

1340 
	`dißbÀ_iommus
();

1342 
‰ì
:

1343 
	`amd_iommu_unöô_devi˚s
();

1345 
	`‰ì_∑ges
(()
amd_iommu_pd_Æloc_bôm≠
,

1346 
	`gë_‹dî
(
MAX_DOMAIN_ID
/8));

1348 
	`‰ì_∑ges
(()
amd_iommu_æookup_èbÀ
,

1349 
	`gë_‹dî
(
æookup_èbÀ_size
));

1351 
	`‰ì_∑ges
(()
amd_iommu_Æüs_èbÀ
,

1352 
	`gë_‹dî
(
Æüs_èbÀ_size
));

1354 
	`‰ì_∑ges
(()
amd_iommu_dev_èbÀ
,

1355 
	`gë_‹dî
(
dev_èbÀ_size
));

1357 
	`‰ì_iommu_Æl
();

1359 
	`‰ì_unôy_m≠s
();

1361 #ifde‡
CONFIG_GART_IOMMU


1366 
	`g¨t_iommu_öô
();

1370 
out
;

1371 
	}
}

1380 
__öô
 
	$óæy_amd_iommu_dëe˘
(
a˝i_èbÀ_hódî
 *
èbÀ
)

1383 
	}
}

1385 
__öô
 
	$amd_iommu_dëe˘
()

1387 i‡(
no_iommu
 || (
iommu_dëe˘ed
 && !
g¨t_iommu_≠îtuª
))

1390 i‡(
amd_iommu_dißbÀd
)

1393 i‡(
	`a˝i_èbÀ_∑r£
("IVRS", 
óæy_amd_iommu_dëe˘
) == 0) {

1394 
iommu_dëe˘ed
 = 1;

1395 
amd_iommu_dëe˘ed
 = 1;

1396 
x86_öô
.
iommu
.
iommu_öô
 = 
amd_iommu_öô
;

1399 
	`pci_ªque°_acs
();

1401 
	}
}

1410 
__öô
 
	$∑r£_amd_iommu_dump
(*
°r
)

1412 
amd_iommu_dump
 = 
åue
;

1415 
	}
}

1417 
__öô
 
	$∑r£_amd_iommu_›ti⁄s
(*
°r
)

1419 ; *
°r
; ++str) {

1420 i‡(
	`°∫cmp
(
°r
, "fullflush", 9) == 0)

1421 
amd_iommu_unm≠_Êush
 = 
åue
;

1422 i‡(
	`°∫cmp
(
°r
, "off", 3) == 0)

1423 
amd_iommu_dißbÀd
 = 
åue
;

1427 
	}
}

1429 
__£tup
("amd_iommu_dump", 
∑r£_amd_iommu_dump
);

1430 
__£tup
("amd_iommu=", 
∑r£_amd_iommu_›ti⁄s
);

	@/cmpt816/linux/arch/x86/kernel/aperture_64.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/boŸmem.h
>

17 
	~<löux/mmz⁄e.h
>

18 
	~<löux/pci_ids.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/su•íd.h
>

23 
	~<löux/kmemÀak.h
>

24 
	~<asm/e820.h
>

25 
	~<asm/io.h
>

26 
	~<asm/iommu.h
>

27 
	~<asm/g¨t.h
>

28 
	~<asm/pci-dúe˘.h
>

29 
	~<asm/dma.h
>

30 
	~<asm/k8.h
>

31 
	~<asm/x86_öô.h
>

33 
	gg¨t_iommu_≠îtuª
;

34 
g¨t_iommu_≠îtuª_dißbÀd
 
	g__öôd©a
;

35 
g¨t_iommu_≠îtuª_Ælowed
 
	g__öôd©a
;

37 
ÁŒback_≠î_‹dî
 
	g__öôd©a
 = 1;

38 
ÁŒback_≠î_f‹˚
 
	g__öôd©a
;

40 
fix_≠îtuª
 
	g__öôd©a
 = 1;

42 
	sbus_dev_ønge
 {

43 
	mbus
;

44 
	mdev_ba£
;

45 
	mdev_limô
;

48 
bus_dev_ønge
 
	gbus_dev_ønges
[] 
	g__öôd©a
 = {

54 
ªsour˚
 
	gg¨t_ªsour˚
 = {

55 .
«me
 = "GART",

56 .
	gÊags
 = 
IORESOURCE_MEM
,

59 
__öô
 
	$ö£π_≠îtuª_ªsour˚
(
u32
 
≠î_ba£
, u32 
≠î_size
)

61 
g¨t_ªsour˚
.
°¨t
 = 
≠î_ba£
;

62 
g¨t_ªsour˚
.
íd
 = 
≠î_ba£
 + 
≠î_size
 - 1;

63 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
g¨t_ªsour˚
);

64 
	}
}

69 
u32
 
__öô
 
	$Æloˇã_≠îtuª
()

71 
u32
 
≠î_size
;

72 *
p
;

75 i‡(
ÁŒback_≠î_‹dî
 > 5)

76 
ÁŒback_≠î_‹dî
 = 5;

77 
≠î_size
 = (32 * 1024 * 1024Ë<< 
ÁŒback_≠î_‹dî
;

98 
p
 = 
	`__Æloc_boŸmem_n›™ic
(
≠î_size
,áper_size, 512ULL<<20);

103 
	`kmemÀak_ign‹e
(
p
);

104 i‡(!
p
 || 
	`__∑
’)+
≠î_size
 > 0xffffffff) {

105 
	`¥ötk
(
KERN_ERR


107 
p
, 
≠î_size
>>10);

108 i‡(
p
)

109 
	`‰ì_boŸmem
(
	`__∑
(
p
), 
≠î_size
);

112 
	`¥ötk
(
KERN_INFO
 "Mappingáperture over %d KB of RAM @ %lx\n",

113 
≠î_size
 >> 10, 
	`__∑
(
p
));

114 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
	`__∑
(
p
), 
≠î_size
);

115 
	`ªgi°î_noßve_ªgi⁄
((
u32
)
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

116 (
u32
)
	`__∑
(
p
+
≠î_size
Ë>> 
PAGE_SHIFT
);

118  (
u32
)
	`__∑
(
p
);

119 
	}
}

123 
u32
 
__öô
 
	$föd_ˇp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
)

125 
byãs
;

126 
u8
 
pos
;

128 i‡(!(
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
PCI_STATUS
) &

129 
PCI_STATUS_CAP_LIST
))

132 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
PCI_CAPABILITY_LIST
);

133 
byãs
 = 0; byã†< 48 && 
pos
 >= 0x40; bytes++) {

134 
u8
 
id
;

136 
pos
 &= ~3;

137 
id
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
, 
pos
+
PCI_CAP_LIST_ID
);

138 i‡(
id
 == 0xff)

140 i‡(
id
 =
ˇp
)

141  
pos
;

142 
pos
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

143 
pos
+
PCI_CAP_LIST_NEXT
);

146 
	}
}

149 
u32
 
__öô
 
	$ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
, 
u32
 *
‹dî
)

151 
u32
 
≠size
;

152 
u32
 
≠sizîeg
;

153 
nbôs
;

154 
u32
 
≠î_low
, 
≠î_hi
;

155 
u64
 
≠î
;

156 
u32
 
ﬁd_‹dî
;

158 
	`¥ötk
(
KERN_INFO
 "AGP bridgê© %02x:%02x:%02x\n", 
bus
, 
¶Ÿ
, 
func
);

159 
≠sizîeg
 = 
	`ªad_pci_c⁄fig_16
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
 + 0x14);

160 i‡(
≠sizîeg
 == 0xffffffff) {

161 
	`¥ötk
(
KERN_ERR
 "APSIZE in AGP bridge unreadable\n");

166 
ﬁd_‹dî
 = *
‹dî
;

168 
≠size
 = 
≠sizîeg
 & 0xfff;

170 i‡(
≠size
 & 0xff)

171 
≠size
 |= 0xf00;

172 
nbôs
 = 
	`hweight16
(
≠size
);

173 *
‹dî
 = 7 - 
nbôs
;

174 i‡(()*
‹dî
 < 0)

175 *
‹dî
 = 0;

177 
≠î_low
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x10);

178 
≠î_hi
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
, 0x14);

179 
≠î
 = (
≠î_low
 & ~((1<<22)-1)Ë| ((
u64
)
≠î_hi
 << 32);

185 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx old size %u MB\n",

186 
≠î
, 32 << 
ﬁd_‹dî
);

187 i‡(
≠î
 + (32ULL<<(20 + *
‹dî
)) > 0x100000000ULL) {

188 
	`¥ötk
(
KERN_INFO
 "Aperture size %u MB (APSIZE %x) isÇotÑight, using settings from NB\n",

189 32 << *
‹dî
, 
≠sizîeg
);

190 *
‹dî
 = 
ﬁd_‹dî
;

193 
	`¥ötk
(
KERN_INFO
 "Aperture from AGP @ %Lx size %u MB (APSIZE %x)\n",

194 
≠î
, 32 << *
‹dî
, 
≠sizîeg
);

196 i‡(!
	`≠îtuª_vÆid
(
≠î
, (32*1024*1024Ë<< *
‹dî
, 32<<20))

198  (
u32
)
≠î
;

199 
	}
}

214 
u32
 
__öô
 
	$£¨ch_agp_bridge
(
u32
 *
‹dî
, *
vÆid_agp
)

216 
bus
, 
¶Ÿ
, 
func
;

219 
bus
 = 0; bus < 256; bus++) {

220 
¶Ÿ
 = 0; slot < 32; slot++) {

221 
func
 = 0; func < 8; func++) {

222 
u32
 
˛ass
, 
ˇp
;

223 
u8
 
ty≥
;

224 
˛ass
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 
func
,

225 
PCI_CLASS_REVISION
);

226 i‡(
˛ass
 == 0xffffffff)

229 
˛ass
 >> 16) {

230 
PCI_CLASS_BRIDGE_HOST
:

231 
PCI_CLASS_BRIDGE_OTHER
:

233 
ˇp
 = 
	`föd_ˇp
(
bus
, 
¶Ÿ
, 
func
,

234 
PCI_CAP_ID_AGP
);

235 i‡(!
ˇp
)

237 *
vÆid_agp
 = 1;

238  
	`ªad_agp
(
bus
, 
¶Ÿ
, 
func
, 
ˇp
,

239 
‹dî
);

243 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
bus
, 
¶Ÿ
, 
func
,

244 
PCI_HEADER_TYPE
);

245 i‡(!(
ty≥
 & 0x80))

250 
	`¥ötk
(
KERN_INFO
 "No AGP bridge found\n");

253 
	}
}

255 
g¨t_fix_e820
 
	g__öôd©a
 = 1;

257 
__öô
 
	$∑r£_g¨t_mem
(*
p
)

259 i‡(!
p
)

260  -
EINVAL
;

262 i‡(!
	`°∫cmp
(
p
, "off", 3))

263 
g¨t_fix_e820
 = 0;

264 i‡(!
	`°∫cmp
(
p
, "on", 2))

265 
g¨t_fix_e820
 = 1;

268 
	}
}

269 
óæy_∑øm
("g¨t_fix_e820", 
∑r£_g¨t_mem
);

271 
__öô
 
	$óæy_g¨t_iommu_check
()

283 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

284 
i
, 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

285 
u32
 
˘l
;

286 
u32
 
≠î_size
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

287 
u64
 
≠î_ba£
 = 0, 
œ°_≠î_ba£
 = 0;

288 
≠î_íabÀd
 = 0, 
œ°_≠î_íabÀd
 = 0, 
œ°_vÆid
 = 0;

290 i‡(!
	`óæy_pci_Ælowed
())

294 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

296 
fix
 = 0;

297 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

298 
bus
;

299 
dev_ba£
, 
dev_limô
;

301 
bus
 = 
bus_dev_ønges
[
i
].bus;

302 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

303 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

305 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

306 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

309 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

310 
≠î_íabÀd
 = 
˘l
 & 
AMD64_GARTEN
;

311 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

312 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

313 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

314 
≠î_ba£
 <<= 25;

316 i‡(
œ°_vÆid
) {

317 i‡((
≠î_‹dî
 !
œ°_≠î_‹dî
) ||

318 (
≠î_ba£
 !
œ°_≠î_ba£
) ||

319 (
≠î_íabÀd
 !
œ°_≠î_íabÀd
)) {

320 
fix
 = 1;

325 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

326 
œ°_≠î_ba£
 = 
≠î_ba£
;

327 
œ°_≠î_íabÀd
 = 
≠î_íabÀd
;

328 
œ°_vÆid
 = 1;

332 i‡(!
fix
 && !
≠î_íabÀd
)

335 i‡(!
≠î_ba£
 || !
≠î_size
 ||áper_base +áper_size > 0x100000000UL)

336 
fix
 = 1;

338 i‡(
g¨t_fix_e820
 && !
fix
 && 
≠î_íabÀd
) {

339 i‡(
	`e820_™y_m≠≥d
(
≠î_ba£
,á≥r_ba£ + 
≠î_size
,

340 
E820_RAM
)) {

342 
	`¥ötk
(
KERN_INFO
 "updateÉ820 for GART\n");

343 
	`e820_add_ªgi⁄
(
≠î_ba£
, 
≠î_size
, 
E820_RESERVED
);

344 
	`upd©e_e820
();

348 i‡(
vÆid_agp
)

352 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

353 
bus
;

354 
dev_ba£
, 
dev_limô
;

356 
bus
 = 
bus_dev_ønges
[
i
].bus;

357 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

358 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

360 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

361 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

364 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
);

365 
˘l
 &~
AMD64_GARTEN
;

366 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

370 
	}
}

372 
__öôd©a
 
	g¥öãd_g¨t_size_msg
;

374 
__öô
 
	$g¨t_iommu_hﬁe_öô
()

376 
u32
 
agp_≠î_ba£
 = 0, 
agp_≠î_‹dî
 = 0;

377 
u32
 
≠î_size
, 
≠î_Æloc
 = 0, 
≠î_‹dî
 = 0, 
œ°_≠î_‹dî
 = 0;

378 
u64
 
≠î_ba£
, 
œ°_≠î_ba£
 = 0;

379 
fix
, 
¶Ÿ
, 
vÆid_agp
 = 0;

380 
i
, 
node
;

382 i‡(
g¨t_iommu_≠îtuª_dißbÀd
 || !
fix_≠îtuª
 ||

383 !
	`óæy_pci_Ælowed
())

386 
	`¥ötk
(
KERN_INFO
 "Checkingáperture...\n");

388 i‡(!
ÁŒback_≠î_f‹˚
)

389 
agp_≠î_ba£
 = 
	`£¨ch_agp_bridge
(&
agp_≠î_‹dî
, &
vÆid_agp
);

391 
fix
 = 0;

392 
node
 = 0;

393 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

394 
bus
;

395 
dev_ba£
, 
dev_limô
;

396 
u32
 
˘l
;

398 
bus
 = 
bus_dev_ønges
[
i
].bus;

399 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

400 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

402 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

403 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

406 
iommu_dëe˘ed
 = 1;

407 
g¨t_iommu_≠îtuª
 = 1;

408 
x86_öô
.
iommu
.
iommu_öô
 = 
g¨t_iommu_öô
;

410 
˘l
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3,

411 
AMD64_GARTAPERTURECTL
);

419 
˘l
 &~
GARTEN
;

420 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
˘l
);

422 
≠î_‹dî
 = (
˘l
 >> 1) & 7;

423 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

424 
≠î_ba£
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
) & 0x7fff;

425 
≠î_ba£
 <<= 25;

427 
	`¥ötk
(
KERN_INFO
 "Node %d:áperture @ %Lx size %u MB\n",

428 
node
, 
≠î_ba£
, 
≠î_size
 >> 20);

429 
node
++;

431 i‡(!
	`≠îtuª_vÆid
(
≠î_ba£
, 
≠î_size
, 64<<20)) {

432 i‡(
vÆid_agp
 && 
agp_≠î_ba£
 &&

433 
agp_≠î_ba£
 =
≠î_ba£
 &&

434 
agp_≠î_‹dî
 =
≠î_‹dî
) {

436 i‡(!
no_iommu
 &&

437 
max_p‚
 > 
MAX_DMA32_PFN
 &&

438 !
¥öãd_g¨t_size_msg
) {

439 
	`¥ötk
(
KERN_ERR
 "youáre using iommu withágp, but GART size isÜessÅhan 64M\n");

440 
	`¥ötk
(
KERN_ERR
 "please increase GART size in your BIOS setup\n");

441 
	`¥ötk
(
KERN_ERR
 "if BIOS doesn't haveÅhat option, contact your HW vendor!\n");

442 
¥öãd_g¨t_size_msg
 = 1;

445 
fix
 = 1;

446 
out
;

450 i‡((
œ°_≠î_‹dî
 && 
≠î_‹dî
 !=Üast_aper_order) ||

451 (
œ°_≠î_ba£
 && 
≠î_ba£
 !=Üast_aper_base)) {

452 
fix
 = 1;

453 
out
;

455 
œ°_≠î_‹dî
 = 
≠î_‹dî
;

456 
œ°_≠î_ba£
 = 
≠î_ba£
;

460 
out
:

461 i‡(!
fix
 && !
ÁŒback_≠î_f‹˚
) {

462 i‡(
œ°_≠î_ba£
) {

463 
n
 = (32 * 1024 * 1024Ë<< 
œ°_≠î_‹dî
;

465 
	`ö£π_≠îtuª_ªsour˚
((
u32
)
œ°_≠î_ba£
, 
n
);

470 i‡(!
ÁŒback_≠î_f‹˚
) {

471 
≠î_Æloc
 = 
agp_≠î_ba£
;

472 
≠î_‹dî
 = 
agp_≠î_‹dî
;

475 i‡(
≠î_Æloc
) {

477 } i‡((!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
) ||

478 
f‹˚_iommu
 ||

479 
vÆid_agp
 ||

480 
ÁŒback_≠î_f‹˚
) {

481 
	`¥ötk
(
KERN_INFO


483 
	`¥ötk
(
KERN_INFO


485 
	`¥ötk
(
KERN_INFO


487 32 << 
ÁŒback_≠î_‹dî
);

489 
≠î_‹dî
 = 
ÁŒback_≠î_‹dî
;

490 
≠î_Æloc
 = 
	`Æloˇã_≠îtuª
();

491 i‡(!
≠î_Æloc
) {

500 
	`∑nic
("NotÉnough memory foráperture");

507 
i
 = 0; i < 
	`ARRAY_SIZE
(
bus_dev_ønges
); i++) {

508 
bus
;

509 
dev_ba£
, 
dev_limô
;

511 
bus
 = 
bus_dev_ønges
[
i
].bus;

512 
dev_ba£
 = 
bus_dev_ønges
[
i
].dev_base;

513 
dev_limô
 = 
bus_dev_ønges
[
i
].dev_limit;

514 
¶Ÿ
 = 
dev_ba£
; slŸ < 
dev_limô
; slot++) {

515 i‡(!
	`óæy_is_k8_nb
(
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 0x00)))

521 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTURECTL
, 
≠î_‹dî
 << 1);

522 
	`wrôe_pci_c⁄fig
(
bus
, 
¶Ÿ
, 3, 
AMD64_GARTAPERTUREBASE
, 
≠î_Æloc
 >> 25);

526 
	`£t_up_g¨t_ªsume
(
≠î_‹dî
, 
≠î_Æloc
);

527 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/apic.c

17 
	~<löux/≥rf_evít.h
>

18 
	~<löux/kî√l_°©.h
>

19 
	~<löux/mc146818πc.h
>

20 
	~<löux/a˝i_pmtmr.h
>

21 
	~<löux/˛ockchùs.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/·ø˚.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/moduÀ.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/dñay.h
>

29 
	~<löux/timex.h
>

30 
	~<löux/dm¨.h
>

31 
	~<löux/öô.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/dmi.h
>

34 
	~<löux/nmi.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/mm.h
>

38 
	~<asm/≥rf_evít.h
>

39 
	~<asm/x86_öô.h
>

40 
	~<asm/pgÆloc.h
>

41 
	~<asm/©omic.h
>

42 
	~<asm/mp•ec.h
>

43 
	~<asm/i8253.h
>

44 
	~<asm/i8259.h
>

45 
	~<asm/¥Ÿo.h
>

46 
	~<asm/≠ic.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/h≥t.h
>

49 
	~<asm/idÀ.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/smp.h
>

52 
	~<asm/m˚.h
>

53 
	~<asm/kvm_∑ø.h
>

54 
	~<asm/tsc.h
>

56 
	gnum_¥o˚ss‹s
;

58 
dißbÀd_˝us
 
	g__˝uöôd©a
;

61 
	gboŸ_˝u_physiˇl_≠icid
 = -1U;

66 
	gmax_physiˇl_≠icid
;

71 
physid_mask_t
 
	gphys_˝u_¥e£¡_m≠
;

76 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_˝u_to_≠icid
, 
BAD_APICID
);

77 
DEFINE_EARLY_PER_CPU
(
u16
, 
x86_bios_˝u_≠icid
, 
BAD_APICID
);

78 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_≠icid
);

79 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_bios_˝u_≠icid
);

81 #ifde‡
CONFIG_X86_32


87 
	gf‹˚_íabÀ_loˇl_≠ic
;

91 
__öô
 
	$∑r£_œpic
(*
¨g
)

93 
f‹˚_íabÀ_loˇl_≠ic
 = 1;

95 
	}
}

96 
óæy_∑øm
("œpic", 
∑r£_œpic
);

98 
	gíabÀd_vü_≠icba£
;

108 
ölöe
 
	$im¸_pic_to_≠ic
()

111 
	`outb
(0x70, 0x22);

113 
	`outb
(0x01, 0x23);

114 
	}
}

116 
ölöe
 
	$im¸_≠ic_to_pic
()

119 
	`outb
(0x70, 0x22);

121 
	`outb
(0x00, 0x23);

122 
	}
}

125 #ifde‡
CONFIG_X86_64


126 
≠ic_ˇlibøã_pmtmr
 
	g__öôd©a
;

127 
__öô
 
	$£tup_≠i˝mtimî
(*
s
)

129 
≠ic_ˇlibøã_pmtmr
 = 1;

130 
	`nŸsc_£tup
(
NULL
);

132 
	}
}

133 
__£tup
("≠i˝mtimî", 
£tup_≠i˝mtimî
);

136 
	gx2≠ic_mode
;

137 #ifde‡
CONFIG_X86_X2APIC


139 
	gx2≠ic_¥ì«bÀd
;

140 
__öô
 
	$£tup_nox2≠ic
(*
°r
)

142 i‡(
	`x2≠ic_íabÀd
()) {

143 
	`¥_w¨nög
("BiosálreadyÉnabled x2apic, "

148 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_X2APIC
);

150 
	}
}

151 
óæy_∑øm
("nox2≠ic", 
£tup_nox2≠ic
);

154 
	gmp_œpic_addr
;

155 
	gdißbÀ_≠ic
;

157 
dißbÀ_≠ic_timî
 
	g__˝uöôd©a
;

159 
	gloˇl_≠ic_timî_c2_ok
;

160 
EXPORT_SYMBOL_GPL
(
loˇl_≠ic_timî_c2_ok
);

162 
	gfú°_sy°em_ve˘‹
 = 0xfe;

167 
	g≠ic_vîbosôy
;

169 
	gpic_mode
;

172 
	gsmp_found_c⁄fig
;

174 
ªsour˚
 
	gœpic_ªsour˚
 = {

175 .
«me
 = "Local APIC",

176 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
,

179 
	gˇlibøti⁄_ªsu…
;

181 
œpic_√xt_evít
(
dñè
,

182 
˛ock_evít_devi˚
 *
evt
);

183 
œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

184 
˛ock_evít_devi˚
 *
evt
);

185 
œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
);

186 
≠ic_pm_a˘iv©e
();

191 
˛ock_evít_devi˚
 
	gœpic_˛ockevít
 = {

192 .
«me
 = "lapic",

193 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT


194 | 
CLOCK_EVT_FEAT_C3STOP
 | 
CLOCK_EVT_FEAT_DUMMY
,

195 .
	gshi·
 = 32,

196 .
	g£t_mode
 = 
œpic_timî_£tup
,

197 .
	g£t_√xt_evít
 = 
œpic_√xt_evít
,

198 .
	gbrﬂdˇ°
 = 
œpic_timî_brﬂdˇ°
,

199 .
	gøtög
 = 100,

200 .
	gúq
 = -1,

202 
DEFINE_PER_CPU
(
˛ock_evít_devi˚
, 
œpic_evíts
);

204 
	g≠ic_phys
;

209 
ölöe
 
	$œpic_gë_vîsi⁄
()

211  
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

212 
	}
}

217 
ölöe
 
	$œpic_is_öãgøãd
()

219 #ifde‡
CONFIG_X86_64


222  
	`APIC_INTEGRATED
(
	`œpic_gë_vîsi⁄
());

224 
	}
}

229 
	$modîn_≠ic
()

232 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
 &&

233 
boŸ_˝u_d©a
.
x86
 >= 0xf)

235  
	`œpic_gë_vîsi⁄
() >= 0x14;

236 
	}
}

242 
	$≠ic_dißbÀ
()

244 
	`¥_öfo
("APIC: switchedÅoápic NOOP\n");

245 
≠ic
 = &
≠ic_no›
;

246 
	}
}

248 
	$«tive_≠ic_waô_i¸_idÀ
()

250 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
)

251 
	`˝u_ªœx
();

252 
	}
}

254 
u32
 
	$«tive_ß„_≠ic_waô_i¸_idÀ
()

256 
u32
 
£nd_°©us
;

257 
timeout
;

259 
timeout
 = 0;

261 
£nd_°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_BUSY
;

262 i‡(!
£nd_°©us
)

264 
	`udñay
(100);

265 } 
timeout
++ < 1000);

267  
£nd_°©us
;

268 
	}
}

270 
	$«tive_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
)

272 
	`≠ic_wrôe
(
APIC_ICR2
, 
	`SET_APIC_DEST_FIELD
(
id
));

273 
	`≠ic_wrôe
(
APIC_ICR
, 
low
);

274 
	}
}

276 
u64
 
	$«tive_≠ic_i¸_ªad
()

278 
u32
 
i¸1
, 
i¸2
;

280 
i¸2
 = 
	`≠ic_ªad
(
APIC_ICR2
);

281 
i¸1
 = 
	`≠ic_ªad
(
APIC_ICR
);

283  
i¸1
 | ((
u64
)
i¸2
 << 32);

284 
	}
}

289 
__˝uöô
 
	$íabÀ_NMI_through_LVT0
()

291 
v
;

294 
v
 = 
APIC_DM_NMI
;

297 i‡(!
	`œpic_is_öãgøãd
())

298 
v
 |
APIC_LVT_LEVEL_TRIGGER
;

300 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
);

301 
	}
}

303 #ifde‡
CONFIG_X86_32


307 
	$gë_physiˇl_brﬂdˇ°
()

309  
	`modîn_≠ic
() ? 0xff : 0xf;

310 
	}
}

316 
	$œpic_gë_maxlvt
()

318 
v
;

320 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

325  
	`APIC_INTEGRATED
(
	`GET_APIC_VERSION
(
v
)Ë? 
	`GET_APIC_MAXLVT
(v) : 2;

326 
	}
}

333 
	#APIC_DIVISOR
 16

	)

345 
	$__£tup_APIC_LVTT
(
˛ocks
, 
⁄eshŸ
, 
úqí
)

347 
lvâ_vÆue
, 
tmp_vÆue
;

349 
lvâ_vÆue
 = 
LOCAL_TIMER_VECTOR
;

350 i‡(!
⁄eshŸ
)

351 
lvâ_vÆue
 |
APIC_LVT_TIMER_PERIODIC
;

352 i‡(!
	`œpic_is_öãgøãd
())

353 
lvâ_vÆue
 |
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

355 i‡(!
úqí
)

356 
lvâ_vÆue
 |
APIC_LVT_MASKED
;

358 
	`≠ic_wrôe
(
APIC_LVTT
, 
lvâ_vÆue
);

363 
tmp_vÆue
 = 
	`≠ic_ªad
(
APIC_TDCR
);

364 
	`≠ic_wrôe
(
APIC_TDCR
,

365 (
tmp_vÆue
 & ~(
APIC_TDR_DIV_1
 | 
APIC_TDR_DIV_TMBASE
)) |

366 
APIC_TDR_DIV_16
);

368 i‡(!
⁄eshŸ
)

369 
	`≠ic_wrôe
(
APIC_TMICT
, 
˛ocks
 / 
APIC_DIVISOR
);

370 
	}
}

382 
	#APIC_EILVT_LVTOFF_MCE
 0

	)

383 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

385 
	$£tup_APIC_eûvt
(
u8
 
lvt_off
, u8 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

387 
ªg
 = (
lvt_off
 << 4Ë+ 
	`APIC_EILVTn
(0);

388 
v
 = (
mask
 << 16Ë| (
msg_ty≥
 << 8Ë| 
ve˘‹
;

390 
	`≠ic_wrôe
(
ªg
, 
v
);

391 
	}
}

393 
u8
 
	$£tup_APIC_eûvt_m˚
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

395 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_MCE
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

396  
APIC_EILVT_LVTOFF_MCE
;

397 
	}
}

399 
u8
 
	$£tup_APIC_eûvt_ibs
(
u8
 
ve˘‹
, u8 
msg_ty≥
, u8 
mask
)

401 
	`£tup_APIC_eûvt
(
APIC_EILVT_LVTOFF_IBS
, 
ve˘‹
, 
msg_ty≥
, 
mask
);

402  
APIC_EILVT_LVTOFF_IBS
;

403 
	}
}

404 
EXPORT_SYMBOL_GPL
(
£tup_APIC_eûvt_ibs
);

409 
	$œpic_√xt_evít
(
dñè
,

410 
˛ock_evít_devi˚
 *
evt
)

412 
	`≠ic_wrôe
(
APIC_TMICT
, 
dñè
);

414 
	}
}

419 
	$œpic_timî_£tup
(
˛ock_evít_mode
 
mode
,

420 
˛ock_evít_devi˚
 *
evt
)

422 
Êags
;

423 
v
;

426 i‡(
evt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
)

429 
	`loˇl_úq_ßve
(
Êags
);

431 
mode
) {

432 
CLOCK_EVT_MODE_PERIODIC
:

433 
CLOCK_EVT_MODE_ONESHOT
:

434 
	`__£tup_APIC_LVTT
(
ˇlibøti⁄_ªsu…
,

435 
mode
 !
CLOCK_EVT_MODE_PERIODIC
, 1);

437 
CLOCK_EVT_MODE_UNUSED
:

438 
CLOCK_EVT_MODE_SHUTDOWN
:

439 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

440 
v
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

441 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
);

442 
	`≠ic_wrôe
(
APIC_TMICT
, 0);

444 
CLOCK_EVT_MODE_RESUME
:

449 
	`loˇl_úq_ª°‹e
(
Êags
);

450 
	}
}

455 
	$œpic_timî_brﬂdˇ°
(c⁄° 
˝umask
 *
mask
)

457 #ifde‡
CONFIG_SMP


458 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
LOCAL_TIMER_VECTOR
);

460 
	}
}

466 
__˝uöô
 
	$£tup_APIC_timî
()

468 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

470 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_ARAT
)) {

471 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_C3STOP
;

473 
œpic_˛ockevít
.
øtög
 = 150;

476 
	`mem˝y
(
Àvt
, &
œpic_˛ockevít
, (*levt));

477 
Àvt
->
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

479 
	`˛ockevíts_ªgi°î_devi˚
(
Àvt
);

480 
	}
}

503 
	#LAPIC_CAL_LOOPS
 (
HZ
/10)

	)

505 
__öôd©a
 
	gœpic_ˇl_lo›s
 = -1;

506 
__öôd©a
 
	gœpic_ˇl_t1
, 
	gœpic_ˇl_t2
;

507 
__öôd©a
 
	gœpic_ˇl_tsc1
, 
	gœpic_ˇl_tsc2
;

508 
__öôd©a
 
	gœpic_ˇl_pm1
, 
	gœpic_ˇl_pm2
;

509 
__öôd©a
 
	gœpic_ˇl_j1
, 
	gœpic_ˇl_j2
;

514 
__öô
 
	$œpic_ˇl_h™dÀr
(
˛ock_evít_devi˚
 *
dev
)

516 
tsc
 = 0;

517 
èpic
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

518 
pm
 = 
	`a˝i_pm_ªad_óæy
();

520 i‡(
˝u_has_tsc
)

521 
	`rdts˛l
(
tsc
);

523 
œpic_ˇl_lo›s
++) {

525 
œpic_ˇl_t1
 = 
èpic
;

526 
œpic_ˇl_tsc1
 = 
tsc
;

527 
œpic_ˇl_pm1
 = 
pm
;

528 
œpic_ˇl_j1
 = 
jiffõs
;

531 
LAPIC_CAL_LOOPS
:

532 
œpic_ˇl_t2
 = 
èpic
;

533 
œpic_ˇl_tsc2
 = 
tsc
;

534 i‡(
pm
 < 
œpic_ˇl_pm1
)

535 
pm
 +
ACPI_PM_OVRRUN
;

536 
œpic_ˇl_pm2
 = 
pm
;

537 
œpic_ˇl_j2
 = 
jiffõs
;

540 
	}
}

542 
__öô


543 
	$ˇlibøã_by_pmtimî
(
dñèpm
, *
dñè
, *
dñètsc
)

545 c⁄° 
pm_100ms
 = 
PMTMR_TICKS_PER_SEC
 / 10;

546 c⁄° 
pm_thªsh
 = 
pm_100ms
 / 100;

547 
mu…
;

548 
u64
 
ªs
;

550 #i‚de‡
CONFIG_X86_PM_TIMER


554 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-Timî dñè = %ld\n", 
dñèpm
);

557 i‡(!
dñèpm
)

560 
mu…
 = 
	`˛ocksour˚_hz2mu…
(
PMTMR_TICKS_PER_SEC
, 22);

562 i‡(
dñèpm
 > (
pm_100ms
 - 
pm_thªsh
) &&

563 
dñèpm
 < (
pm_100ms
 + 
pm_thªsh
)) {

564 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... PM-TimerÑesult ok\n");

568 
ªs
 = (((
u64
)
dñèpm
Ë* 
mu…
) >> 22;

569 
	`do_div
(
ªs
, 1000000);

570 
	`¥_w¨nög
("APIC calibrationÇot consistent "

571 "wôh PM-Timî: %ldm†ö°ód o‡100ms\n",()
ªs
);

574 
ªs
 = (((
u64
)(*
dñè
)Ë* 
pm_100ms
);

575 
	`do_div
(
ªs
, 
dñèpm
);

576 
	`¥_öfo
("APIC deltaádjustedÅo PM-Timer: "

577 "%lu (%ld)\n", ()
ªs
, *
dñè
);

578 *
dñè
 = ()
ªs
;

581 i‡(
˝u_has_tsc
) {

582 
ªs
 = (((
u64
)(*
dñètsc
)Ë* 
pm_100ms
);

583 
	`do_div
(
ªs
, 
dñèpm
);

584 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "TSC deltaádjustedÅo "

586 ()
ªs
, *
dñètsc
);

587 *
dñètsc
 = ()
ªs
;

591 
	}
}

593 
__öô
 
	$ˇlibøã_APIC_˛ock
()

595 
˛ock_evít_devi˚
 *
Àvt
 = &
	`__gë_˝u_v¨
(
œpic_evíts
);

596 (*
ªÆ_h™dÀr
)(
˛ock_evít_devi˚
 *
dev
);

597 
dñèj
;

598 
dñè
, 
dñètsc
;

599 
pm_ª„ªn˚d
 = 0;

601 
	`loˇl_úq_dißbÀ
();

604 
ªÆ_h™dÀr
 = 
globÆ_˛ock_evít
->
evít_h™dÀr
;

605 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

611 
	`__£tup_APIC_LVTT
(0xffffffff, 0, 0);

614 
	`loˇl_úq_íabÀ
();

616 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

617 
	`˝u_ªœx
();

619 
	`loˇl_úq_dißbÀ
();

622 
globÆ_˛ock_evít
->
evít_h™dÀr
 = 
ªÆ_h™dÀr
;

625 
dñè
 = 
œpic_ˇl_t1
 - 
œpic_ˇl_t2
;

626 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "...Ü≠i¯dñè = %ld\n", 
dñè
);

628 
dñètsc
 = ()(
œpic_ˇl_tsc2
 - 
œpic_ˇl_tsc1
);

631 
pm_ª„ªn˚d
 = !
	`ˇlibøã_by_pmtimî
(
œpic_ˇl_pm2
 - 
œpic_ˇl_pm1
,

632 &
dñè
, &
dñètsc
);

635 
œpic_˛ockevít
.
mu…
 = 
	`div_sc
(
dñè
, 
TICK_NSEC
 * 
LAPIC_CAL_LOOPS
,

636 
œpic_˛ockevít
.
shi·
);

637 
œpic_˛ockevít
.
max_dñè_ns
 =

638 
	`˛ockevít_dñè2ns
(0x7FFFFF, &
œpic_˛ockevít
);

639 
œpic_˛ockevít
.
mö_dñè_ns
 =

640 
	`˛ockevít_dñè2ns
(0xF, &
œpic_˛ockevít
);

642 
ˇlibøti⁄_ªsu…
 = (
dñè
 * 
APIC_DIVISOR
Ë/ 
LAPIC_CAL_LOOPS
;

644 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... dñè %ld\n", 
dñè
);

645 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... mu…: %u\n", 
œpic_˛ockevít
.
mu…
);

646 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... calibrationÑesult: %u\n",

647 
ˇlibøti⁄_ªsu…
);

649 i‡(
˝u_has_tsc
) {

650 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... CPU clock speed is "

652 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë/ (1000000 / 
HZ
),

653 (
dñètsc
 / 
LAPIC_CAL_LOOPS
Ë% (1000000 / 
HZ
));

656 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "..... host bus clock speed is "

658 
ˇlibøti⁄_ªsu…
 / (1000000 / 
HZ
),

659 
ˇlibøti⁄_ªsu…
 % (1000000 / 
HZ
));

664 i‡(
ˇlibøti⁄_ªsu…
 < (1000000 / 
HZ
)) {

665 
	`loˇl_úq_íabÀ
();

666 
	`¥_w¨nög
("APIC frequencyÅoo slow, disablingápicÅimer\n");

670 
Àvt
->
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

676 i‡(!
pm_ª„ªn˚d
) {

677 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... verify APICÅimer\n");

682 
Àvt
->
evít_h™dÀr
 = 
œpic_ˇl_h™dÀr
;

683 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_PERIODIC
, 
Àvt
);

684 
œpic_ˇl_lo›s
 = -1;

687 
	`loˇl_úq_íabÀ
();

689 
œpic_ˇl_lo›s
 <
LAPIC_CAL_LOOPS
)

690 
	`˝u_ªœx
();

693 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
Àvt
);

696 
dñèj
 = 
œpic_ˇl_j2
 - 
œpic_ˇl_j1
;

697 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffõ†dñè = %lu\n", 
dñèj
);

700 i‡(
dñèj
 >
LAPIC_CAL_LOOPS
-2 && deltaj <= LAPIC_CAL_LOOPS+2)

701 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "... jiffiesÑesult ok\n");

703 
Àvt
->
„©uªs
 |
CLOCK_EVT_FEAT_DUMMY
;

705 
	`loˇl_úq_íabÀ
();

707 i‡(
Àvt
->
„©uªs
 & 
CLOCK_EVT_FEAT_DUMMY
) {

708 
	`¥_w¨nög
("APICÅimer disabled dueÅo verification failure\n");

713 
	}
}

720 
__öô
 
	$£tup_boŸ_APIC_˛ock
()

728 i‡(
dißbÀ_≠ic_timî
) {

729 
	`¥_öfo
("Disabling APICÅimer\n");

731 i‡(
	`num_possibÀ_˝us
() > 1) {

732 
œpic_˛ockevít
.
mu…
 = 1;

733 
	`£tup_APIC_timî
();

738 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "UsingÜocal APICÅimer interrupts.\n"

741 i‡(
	`ˇlibøã_APIC_˛ock
()) {

743 i‡(
	`num_possibÀ_˝us
() > 1)

744 
	`£tup_APIC_timî
();

753 i‡(
nmi_w©chdog
 !
NMI_IO_APIC
)

754 
œpic_˛ockevít
.
„©uªs
 &~
CLOCK_EVT_FEAT_DUMMY
;

756 
	`¥_w¨nög
("APICÅimerÑegisteredás dummy,"

757 " duêtÿnmi_w©chdog=%d!\n", 
nmi_w©chdog
);

760 
	`£tup_APIC_timî
();

761 
	}
}

763 
__˝uöô
 
	$£tup_£c⁄d¨y_APIC_˛ock
()

765 
	`£tup_APIC_timî
();

766 
	}
}

771 
	$loˇl_≠ic_timî_öãºu±
()

773 
˝u
 = 
	`smp_¥o˚ss‹_id
();

774 
˛ock_evít_devi˚
 *
evt
 = &
	`≥r_˝u
(
œpic_evíts
, 
˝u
);

787 i‡(!
evt
->
evít_h™dÀr
) {

788 
	`¥_w¨nög
("Spuriou†LAPICÅimî i¡îru± o¿˝u %d\n", 
˝u
);

790 
	`œpic_timî_£tup
(
CLOCK_EVT_MODE_SHUTDOWN
, 
evt
);

797 
	`öc_úq_°©
(
≠ic_timî_úqs
);

799 
evt
->
	`evít_h™dÀr
(evt);

800 
	}
}

810 
__úq_íåy
 
	$smp_≠ic_timî_öãºu±
(
±_ªgs
 *
ªgs
)

812 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

818 
	`ack_APIC_úq
();

824 
	`exô_idÀ
();

825 
	`úq_íãr
();

826 
	`loˇl_≠ic_timî_öãºu±
();

827 
	`úq_exô
();

829 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

830 
	}
}

832 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

834  -
EINVAL
;

835 
	}
}

848 
	$˛ór_loˇl_APIC
()

850 
maxlvt
;

851 
u32
 
v
;

854 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

857 
maxlvt
 = 
	`œpic_gë_maxlvt
();

862 i‡(
maxlvt
 >= 3) {

863 
v
 = 
ERROR_APIC_VECTOR
;

864 
	`≠ic_wrôe
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

870 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

871 
	`≠ic_wrôe
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

872 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

873 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

874 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

875 
	`≠ic_wrôe
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

876 i‡(
maxlvt
 >= 4) {

877 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

878 
	`≠ic_wrôe
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

882 #ifde‡
CONFIG_X86_THERMAL_VECTOR


883 i‡(
maxlvt
 >= 5) {

884 
v
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

885 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

888 #ifde‡
CONFIG_X86_MCE_INTEL


889 i‡(
maxlvt
 >= 6) {

890 
v
 = 
	`≠ic_ªad
(
APIC_LVTCMCI
);

891 i‡(!(
v
 & 
APIC_LVT_MASKED
))

892 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
v
 | 
APIC_LVT_MASKED
);

899 
	`≠ic_wrôe
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

900 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

901 
	`≠ic_wrôe
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

902 i‡(
maxlvt
 >= 3)

903 
	`≠ic_wrôe
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

904 i‡(
maxlvt
 >= 4)

905 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

908 i‡(
	`œpic_is_öãgøãd
()) {

909 i‡(
maxlvt
 > 3)

911 
	`≠ic_wrôe
(
APIC_ESR
, 0);

912 
	`≠ic_ªad
(
APIC_ESR
);

914 
	}
}

919 
	$dißbÀ_loˇl_APIC
()

921 
vÆue
;

924 i‡(!
x2≠ic_mode
 && !
≠ic_phys
)

927 
	`˛ór_loˇl_APIC
();

933 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

934 
vÆue
 &~
APIC_SPIV_APIC_ENABLED
;

935 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

937 #ifde‡
CONFIG_X86_32


942 i‡(
íabÀd_vü_≠icba£
) {

943 
l
, 
h
;

945 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

946 
l
 &~
MSR_IA32_APICBASE_ENABLE
;

947 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

950 
	}
}

958 
	$œpic_shutdown
()

960 
Êags
;

962 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

965 
	`loˇl_úq_ßve
(
Êags
);

967 #ifde‡
CONFIG_X86_32


968 i‡(!
íabÀd_vü_≠icba£
)

969 
	`˛ór_loˇl_APIC
();

972 
	`dißbÀ_loˇl_APIC
();

975 
	`loˇl_úq_ª°‹e
(
Êags
);

976 
	}
}

983 
__öô
 
	$vîify_loˇl_APIC
()

985 
ªg0
, 
ªg1
;

990 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVR
);

991 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg0
);

992 
	`≠ic_wrôe
(
APIC_LVR
, 
ªg0
 ^ 
APIC_LVR_MASK
);

993 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVR
);

994 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög VERSION: %x\n", 
ªg1
);

1001 i‡(
ªg1
 !
ªg0
)

1007 
ªg1
 = 
	`GET_APIC_VERSION
(
ªg0
);

1008 i‡(
ªg1
 == 0x00 ||Ñeg1 == 0xff)

1010 
ªg1
 = 
	`œpic_gë_maxlvt
();

1011 i‡(
ªg1
 < 0x02 ||Ñeg1 == 0xff)

1017 
ªg0
 = 
	`≠ic_ªad
(
APIC_ID
);

1018 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg0
);

1019 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
 ^ 
≠ic
->
≠ic_id_mask
);

1020 
ªg1
 = 
	`≠ic_ªad
(
APIC_ID
);

1021 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög ID: %x\n", 
ªg1
);

1022 
	`≠ic_wrôe
(
APIC_ID
, 
ªg0
);

1023 i‡(
ªg1
 !(
ªg0
 ^ 
≠ic
->
≠ic_id_mask
))

1031 
ªg0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1032 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT0: %x\n", 
ªg0
);

1033 
ªg1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1034 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Gëtög LVT1: %x\n", 
ªg1
);

1037 
	}
}

1042 
__öô
 
	$sync_Arb_IDs
()

1048 i‡(
	`modîn_≠ic
(Ë|| 
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
)

1054 
	`≠ic_waô_i¸_idÀ
();

1056 
	`≠ic_¥ötk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

1057 
	`≠ic_wrôe
(
APIC_ICR
, 
APIC_DEST_ALLINC
 |

1058 
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
);

1059 
	}
}

1064 
__öô
 
	$öô_b•_APIC
()

1066 
vÆue
;

1072 i‡(
smp_found_c⁄fig
 || !
˝u_has_≠ic
)

1078 
	`˛ór_loˇl_APIC
();

1083 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1084 
vÆue
 &~
APIC_VECTOR_MASK
;

1085 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1087 #ifde‡
CONFIG_X86_32


1089 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

1090 (
boŸ_˝u_d©a
.
x86
 == 15))

1091 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1094 
vÆue
 |
APIC_SPIV_FOCUS_DISABLED
;

1095 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1096 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1101 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

1102 
vÆue
 = 
APIC_DM_NMI
;

1103 i‡(!
	`œpic_is_öãgøãd
())

1104 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1105 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1106 
	}
}

1108 
__˝uöô
 
	$œpic_£tup_e§
()

1110 
ﬁdvÆue
, 
vÆue
, 
maxlvt
;

1112 i‡(!
	`œpic_is_öãgøãd
()) {

1113 
	`¥_öfo
("No ESR for 82489DX.\n");

1117 i‡(
≠ic
->
dißbÀ_e§
) {

1124 
	`¥_öfo
("Leaving ESR disabled.\n");

1128 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1129 i‡(
maxlvt
 > 3)

1130 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1131 
ﬁdvÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1134 
vÆue
 = 
ERROR_APIC_VECTOR
;

1135 
	`≠ic_wrôe
(
APIC_LVTERR
, 
vÆue
);

1140 i‡(
maxlvt
 > 3)

1141 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1142 
vÆue
 = 
	`≠ic_ªad
(
APIC_ESR
);

1143 i‡(
vÆue
 !
ﬁdvÆue
)

1144 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ESR value beforeÉnabling "

1146 
ﬁdvÆue
, 
vÆue
);

1147 
	}
}

1153 
__˝uöô
 
	$£tup_loˇl_APIC
()

1155 
vÆue
, 
queued
;

1156 
i
, 
j
, 
acked
 = 0;

1157 
tsc
 = 0, 
¡sc
;

1158 
max_lo›s
 = 
˝u_khz
;

1160 i‡(
˝u_has_tsc
)

1161 
	`rdts˛l
(
tsc
);

1163 i‡(
dißbÀ_≠ic
) {

1164 
	`¨ch_dißbÀ_smp_suµ‹t
();

1168 #ifde‡
CONFIG_X86_32


1170 i‡(
	`œpic_is_öãgøãd
(Ë&& 
≠ic
->
dißbÀ_e§
) {

1171 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1172 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1173 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1174 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1177 
	`≥rf_evíts_œpic_öô
();

1179 
	`¥ìm±_dißbÀ
();

1185 
	`BUG_ON
(!
≠ic
->
	`≠ic_id_ªgi°îed
());

1192 
≠ic
->
	`öô_≠ic_ldr
();

1198 
vÆue
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1199 
vÆue
 &~
APIC_TPRI_MASK
;

1200 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
vÆue
);

1214 
queued
 = 0;

1215 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--)

1216 
queued
 |
	`≠ic_ªad
(
APIC_IRR
 + 
i
*0x10);

1218 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

1219 
vÆue
 = 
	`≠ic_ªad
(
APIC_ISR
 + 
i
*0x10);

1220 
j
 = 31; j >= 0; j--) {

1221 i‡(
vÆue
 & (1<<
j
)) {

1222 
	`ack_APIC_úq
();

1223 
acked
++;

1227 i‡(
acked
 > 256) {

1228 
	`¥ötk
(
KERN_ERR
 "LAPICÖending interruptsáfter %d EOI\n",

1229 
acked
);

1232 i‡(
˝u_has_tsc
) {

1233 
	`rdts˛l
(
¡sc
);

1234 
max_lo›s
 = (
˝u_khz
 << 10Ë- (
¡sc
 - 
tsc
);

1236 
max_lo›s
--;

1237 } 
queued
 && 
max_lo›s
 > 0);

1238 
	`WARN_ON
(
max_lo›s
 <= 0);

1243 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1244 
vÆue
 &~
APIC_VECTOR_MASK
;

1248 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1250 #ifde‡
CONFIG_X86_32


1276 
vÆue
 &~
APIC_SPIV_FOCUS_DISABLED
;

1282 
vÆue
 |
SPURIOUS_APIC_VECTOR
;

1283 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1295 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
Ë& 
APIC_LVT_MASKED
;

1296 i‡(!
	`smp_¥o˚ss‹_id
(Ë&& (
pic_mode
 || !
vÆue
)) {

1297 
vÆue
 = 
APIC_DM_EXTINT
;

1298 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

1299 
	`smp_¥o˚ss‹_id
());

1301 
vÆue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

1302 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

1303 
	`smp_¥o˚ss‹_id
());

1305 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1310 i‡(!
	`smp_¥o˚ss‹_id
())

1311 
vÆue
 = 
APIC_DM_NMI
;

1313 
vÆue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

1314 i‡(!
	`œpic_is_öãgøãd
())

1315 
vÆue
 |
APIC_LVT_LEVEL_TRIGGER
;

1316 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1318 
	`¥ìm±_íabÀ
();

1320 #ifde‡
CONFIG_X86_MCE_INTEL


1322 i‡(
	`smp_¥o˚ss‹_id
() == 0)

1323 
	`cmci_ªcheck
();

1325 
	}
}

1327 
__˝uöô
 
	$íd_loˇl_APIC_£tup
()

1329 
	`œpic_£tup_e§
();

1331 #ifde‡
CONFIG_X86_32


1333 
vÆue
;

1335 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1336 
vÆue
 |(
APIC_LVT_MASKED
 | 
LOCAL_TIMER_VECTOR
);

1337 
	`≠ic_wrôe
(
APIC_LVTT
, 
vÆue
);

1341 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

1342 
	`≠ic_pm_a˘iv©e
();

1343 
	}
}

1345 #ifde‡
CONFIG_X86_X2APIC


1346 
	$check_x2≠ic
()

1348 i‡(
	`x2≠ic_íabÀd
()) {

1349 
	`¥_öfo
("x2apicÉnabled by BIOS, switchingÅo x2apic ops\n");

1350 
x2≠ic_¥ì«bÀd
 = 
x2≠ic_mode
 = 1;

1352 
	}
}

1354 
	$íabÀ_x2≠ic
()

1356 
m§
, 
m§2
;

1358 i‡(!
x2≠ic_mode
)

1361 
	`rdm§
(
MSR_IA32_APICBASE
, 
m§
, 
m§2
);

1362 i‡(!(
m§
 & 
X2APIC_ENABLE
)) {

1363 
	`¥ötk_⁄˚
(
KERN_INFO
 "Enabling x2apic\n");

1364 
	`wrm§
(
MSR_IA32_APICBASE
, 
m§
 | 
X2APIC_ENABLE
, 0);

1366 
	}
}

1369 
__öô
 
	$íabÀ_IR
()

1371 #ifde‡
CONFIG_INTR_REMAP


1372 i‡(!
	`öå_ªm≠pög_suµ‹ãd
()) {

1373 
	`¥_debug
("intr-remappingÇot supported\n");

1377 i‡(!
x2≠ic_¥ì«bÀd
 && 
skù_iﬂpic_£tup
) {

1378 
	`¥_öfo
("SkippedÉnabling intr-remap because of skipping "

1383 i‡(
	`íabÀ_öå_ªm≠pög
(
	`x2≠ic_suµ‹ãd
()))

1386 
	`¥_öfo
("Enabled Interrupt-remapping\n");

1392 
	}
}

1394 
__öô
 
	$íabÀ_IR_x2≠ic
()

1396 
Êags
;

1397 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

1398 
ªt
, 
x2≠ic_íabÀd
 = 0;

1399 
dm¨_èbÀ_öô_ªt
;

1401 
dm¨_èbÀ_öô_ªt
 = 
	`dm¨_èbÀ_öô
();

1402 i‡(
dm¨_èbÀ_öô_ªt
 && !
	`x2≠ic_suµ‹ãd
())

1405 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

1406 i‡(!
iﬂpic_íåõs
) {

1407 
	`¥_îr
("Allocate ioapic_entries failed\n");

1408 
out
;

1411 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

1412 i‡(
ªt
) {

1413 
	`¥_öfo
("Savög IO-APIC sèã faûed: %d\n", 
ªt
);

1414 
out
;

1417 
	`loˇl_úq_ßve
(
Êags
);

1418 
Àgacy_pic
->
	`mask_Æl
();

1419 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

1421 i‡(
dm¨_èbÀ_öô_ªt
)

1422 
ªt
 = 0;

1424 
ªt
 = 
	`íabÀ_IR
();

1426 i‡(!
ªt
) {

1430 i‡(
max_physiˇl_≠icid
 > 255 || !
	`kvm_∑ø_avaûabÀ
())

1431 
nox2≠ic
;

1436 
	`x2≠ic_f‹˚_phys
();

1439 
x2≠ic_íabÀd
 = 1;

1441 i‡(
	`x2≠ic_suµ‹ãd
(Ë&& !
x2≠ic_mode
) {

1442 
x2≠ic_mode
 = 1;

1443 
	`íabÀ_x2≠ic
();

1444 
	`¥_öfo
("Enabled x2apic\n");

1447 
nox2≠ic
:

1448 i‡(!
ªt
)

1449 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

1450 
Àgacy_pic
->
	`ª°‹e_mask
();

1451 
	`loˇl_úq_ª°‹e
(
Êags
);

1453 
out
:

1454 i‡(
iﬂpic_íåõs
)

1455 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

1457 i‡(
x2≠ic_íabÀd
)

1460 i‡(
x2≠ic_¥ì«bÀd
)

1461 
	`∑nic
("x2apic:Énabled by BIOS but kernel init failed.");

1462 i‡(
˝u_has_x2≠ic
)

1463 
	`¥_öfo
("NotÉnabling x2apic, Intr-remapping init failed.\n");

1464 
	}
}

1466 #ifde‡
CONFIG_X86_64


1473 
__öô
 
	$dëe˘_öô_APIC
()

1475 i‡(!
˝u_has_≠ic
) {

1476 
	`¥_öfo
("NoÜocal APICÖresent\n");

1480 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1482 
	}
}

1487 
__öô
 
	$dëe˘_öô_APIC
()

1489 
u32
 
h
, 
l
, 
„©uªs
;

1492 i‡(
dißbÀ_≠ic
)

1495 
boŸ_˝u_d©a
.
x86_víd‹
) {

1496 
X86_VENDOR_AMD
:

1497 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 > 1) ||

1498 (
boŸ_˝u_d©a
.
x86
 >= 15))

1500 
no_≠ic
;

1501 
X86_VENDOR_INTEL
:

1502 i‡(
boŸ_˝u_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

1503 (
boŸ_˝u_d©a
.
x86
 =5 && 
˝u_has_≠ic
))

1505 
no_≠ic
;

1507 
no_≠ic
;

1510 i‡(!
˝u_has_≠ic
) {

1515 i‡(!
f‹˚_íabÀ_loˇl_≠ic
) {

1516 
	`¥_öfo
("Local APIC disabled by BIOS -- "

1525 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1526 i‡(!(
l
 & 
MSR_IA32_APICBASE_ENABLE
)) {

1527 
	`¥_öfo
("Local APIC disabled by BIOS --Ñeenabling.\n");

1528 
l
 &~
MSR_IA32_APICBASE_BASE
;

1529 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

1530 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1531 
íabÀd_vü_≠icba£
 = 1;

1538 
„©uªs
 = 
	`˝uid_edx
(1);

1539 i‡(!(
„©uªs
 & (1 << 
X86_FEATURE_APIC
))) {

1540 
	`¥_w¨nög
("CouldÇotÉnable APIC!\n");

1543 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_APIC
);

1544 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

1547 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

1548 i‡(
l
 & 
MSR_IA32_APICBASE_ENABLE
)

1549 
mp_œpic_addr
 = 
l
 & 
MSR_IA32_APICBASE_BASE
;

1551 
	`¥_öfo
("FoundándÉnabledÜocal APIC!\n");

1553 
	`≠ic_pm_a˘iv©e
();

1557 
no_≠ic
:

1558 
	`¥_öfo
("NoÜocal APICÖresent or hardware disabled\n");

1560 
	}
}

1563 #ifde‡
CONFIG_X86_64


1564 
__öô
 
	$óæy_öô_œpic_m≠pög
()

1570 i‡(!
smp_found_c⁄fig
)

1573 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
mp_œpic_addr
);

1574 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %16lx (%16lx)\n",

1575 
APIC_BASE
, 
mp_œpic_addr
);

1581 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1582 
	}
}

1588 
__öô
 
	$öô_≠ic_m≠pögs
()

1590 
√w_≠icid
;

1592 i‡(
x2≠ic_mode
) {

1593 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1598 i‡(!
smp_found_c⁄fig
 && 
	`dëe˘_öô_APIC
()) {

1600 
	`¥_öfo
("APIC: disableápic facility\n");

1601 
	`≠ic_dißbÀ
();

1603 
≠ic_phys
 = 
mp_œpic_addr
;

1609 i‡(!
a˝i_œpic
)

1610 
	`£t_fixm≠_noˇche
(
FIX_APIC_BASE
, 
≠ic_phys
);

1612 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped APICÅo %08lx (%08lx)\n",

1613 
APIC_BASE
, 
≠ic_phys
);

1620 
√w_≠icid
 = 
	`ªad_≠ic_id
();

1621 i‡(
boŸ_˝u_physiˇl_≠icid
 !
√w_≠icid
) {

1622 
boŸ_˝u_physiˇl_≠icid
 = 
√w_≠icid
;

1630 
≠ic_vîsi⁄
[
√w_≠icid
] =

1631 
	`GET_APIC_VERSION
(
	`≠ic_ªad
(
APIC_LVR
));

1633 
	}
}

1639 
	g≠ic_vîsi⁄
[
MAX_APICS
];

1641 
__öô
 
	$APIC_öô_unùro˚ss‹
()

1643 i‡(
dißbÀ_≠ic
) {

1644 
	`¥_öfo
("Apic disabled\n");

1647 #ifde‡
CONFIG_X86_64


1648 i‡(!
˝u_has_≠ic
) {

1649 
dißbÀ_≠ic
 = 1;

1650 
	`¥_öfo
("Apic disabled by BIOS\n");

1654 i‡(!
smp_found_c⁄fig
 && !
˝u_has_≠ic
)

1660 i‡(!
˝u_has_≠ic
 &&

1661 
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

1662 
	`¥_îr
("BIOS bug,Üocal APIC 0x%xÇot detected!...\n",

1663 
boŸ_˝u_physiˇl_≠icid
);

1668 #i‚de‡
CONFIG_SMP


1669 
	`íabÀ_IR_x2≠ic
();

1670 
	`deÁu…_£tup_≠ic_routög
();

1673 
	`vîify_loˇl_APIC
();

1674 
	`c⁄√˘_b•_APIC
();

1676 #ifde‡
CONFIG_X86_64


1677 
	`≠ic_wrôe
(
APIC_ID
, 
	`SET_APIC_ID
(
boŸ_˝u_physiˇl_≠icid
));

1684 #ifde‡
CONFIG_CRASH_DUMP


1685 
boŸ_˝u_physiˇl_≠icid
 = 
	`ªad_≠ic_id
();

1688 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

1689 
	`£tup_loˇl_APIC
();

1691 #ifde‡
CONFIG_X86_IO_APIC


1696 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1697 
	`íabÀ_IO_APIC
();

1700 
	`íd_loˇl_APIC_£tup
();

1702 #ifde‡
CONFIG_X86_IO_APIC


1703 i‡(
smp_found_c⁄fig
 && !
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1704 
	`£tup_IO_APIC
();

1706 
ƒ_iﬂpics
 = 0;

1707 
	`loˇli£_nmi_w©chdog
();

1710 
	`loˇli£_nmi_w©chdog
();

1713 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1714 #ifde‡
CONFIG_X86_64


1715 
	`check_nmi_w©chdog
();

1719 
	}
}

1728 
	$smp_•urious_öãºu±
(
±_ªgs
 *
ªgs
)

1730 
u32
 
v
;

1732 
	`exô_idÀ
();

1733 
	`úq_íãr
();

1739 
v
 = 
	`≠ic_ªad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1740 i‡(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f)))

1741 
	`ack_APIC_úq
();

1743 
	`öc_úq_°©
(
úq_•urious_cou¡
);

1746 
	`¥_öfo
("spurious APIC interrupt on CPU#%d, "

1747 "shouldÇevî h≠≥n.\n", 
	`smp_¥o˚ss‹_id
());

1748 
	`úq_exô
();

1749 
	}
}

1754 
	$smp_îr‹_öãºu±
(
±_ªgs
 *
ªgs
)

1756 
u32
 
v
, 
v1
;

1758 
	`exô_idÀ
();

1759 
	`úq_íãr
();

1761 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1762 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1763 
v1
 = 
	`≠ic_ªad
(
APIC_ESR
);

1764 
	`ack_APIC_úq
();

1765 
	`©omic_öc
(&
úq_îr_cou¡
);

1778 
	`¥_debug
("APICÉrror on CPU%d: %02x(%02x)\n",

1779 
	`smp_¥o˚ss‹_id
(), 
v
 , 
v1
);

1780 
	`úq_exô
();

1781 
	}
}

1786 
__öô
 
	$c⁄√˘_b•_APIC
()

1788 #ifde‡
CONFIG_X86_32


1789 i‡(
pic_mode
) {

1793 
	`˛ór_loˇl_APIC
();

1798 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "leaving PIC mode, "

1800 
	`im¸_pic_to_≠ic
();

1803 i‡(
≠ic
->
íabÀ_≠ic_mode
)

1804 
≠ic
->
	`íabÀ_≠ic_mode
();

1805 
	}
}

1814 
	$disc⁄√˘_b•_APIC
(
vút_wúe_£tup
)

1816 
vÆue
;

1818 #ifde‡
CONFIG_X86_32


1819 i‡(
pic_mode
) {

1826 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "disabling APIC mode, "

1828 
	`im¸_≠ic_to_pic
();

1836 
vÆue
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1837 
vÆue
 &~
APIC_VECTOR_MASK
;

1838 
vÆue
 |
APIC_SPIV_APIC_ENABLED
;

1839 
vÆue
 |= 0xf;

1840 
	`≠ic_wrôe
(
APIC_SPIV
, 
vÆue
);

1842 i‡(!
vút_wúe_£tup
) {

1847 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1848 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1849 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1850 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1851 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1852 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_EXTINT
);

1853 
	`≠ic_wrôe
(
APIC_LVT0
, 
vÆue
);

1856 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

1863 
vÆue
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1864 
vÆue
 &~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

1865 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

1866 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

1867 
vÆue
 |
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

1868 
vÆue
 = 
	`SET_APIC_DELIVERY_MODE
(vÆue, 
APIC_MODE_NMI
);

1869 
	`≠ic_wrôe
(
APIC_LVT1
, 
vÆue
);

1870 
	}
}

1872 
__˝uöô
 
	$gíîic_¥o˚ss‹_öfo
(
≠icid
, 
vîsi⁄
)

1874 
˝u
;

1879 i‡(
vîsi⁄
 == 0x0) {

1880 
	`¥_w¨nög
("BIOS bug, APIC version is 0 for CPU#%d! "

1882 
vîsi⁄
);

1883 
vîsi⁄
 = 0x10;

1885 
≠ic_vîsi⁄
[
≠icid
] = 
vîsi⁄
;

1887 i‡(
num_¥o˚ss‹s
 >
ƒ_˝u_ids
) {

1888 
max
 = 
ƒ_˝u_ids
;

1889 
this˝u
 = 
max
 + 
dißbÀd_˝us
;

1891 
	`¥_w¨nög
(

1893 " Pro˚ss‹ %d/0x%x ign‹ed.\n", 
max
, 
this˝u
, 
≠icid
);

1895 
dißbÀd_˝us
++;

1899 
num_¥o˚ss‹s
++;

1900 
˝u
 = 
	`˝umask_√xt_zîo
(-1, 
˝u_¥e£¡_mask
);

1902 i‡(
vîsi⁄
 !
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])

1903 
	`WARN_ONCE
(1,

1905 
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
], 
˝u
, 
vîsi⁄
);

1907 
	`physid_£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
);

1908 i‡(
≠icid
 =
boŸ_˝u_physiˇl_≠icid
) {

1914 
˝u
 = 0;

1916 i‡(
≠icid
 > 
max_physiˇl_≠icid
)

1917 
max_physiˇl_≠icid
 = 
≠icid
;

1919 #i‡
	`deföed
(
CONFIG_SMP
Ë|| deföed(
CONFIG_X86_64
)

1920 
	`óæy_≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
≠icid
;

1921 
	`óæy_≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
Ë
≠icid
;

1924 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

1925 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

1926 
	}
}

1928 
	$h¨d_smp_¥o˚ss‹_id
()

1930  
	`ªad_≠ic_id
();

1931 
	}
}

1933 
	$deÁu…_öô_≠ic_ldr
()

1935 
vÆ
;

1937 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_VALUE
);

1938 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

1939 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(1UL << 
	`smp_¥o˚ss‹_id
());

1940 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

1941 
	}
}

1943 #ifde‡
CONFIG_X86_32


1944 
	$deÁu…_≠icid_to_node
(
logiˇl_≠icid
)

1946 #ifde‡
CONFIG_SMP


1947  
≠icid_2_node
[
	`h¨d_smp_¥o˚ss‹_id
()];

1951 
	}
}

1957 #ifde‡
CONFIG_PM


1965 
	ma˘ive
;

1967 
	m≠ic_id
;

1968 
	m≠ic_èsk¥i
;

1969 
	m≠ic_ldr
;

1970 
	m≠ic_d‰
;

1971 
	m≠ic_•iv
;

1972 
	m≠ic_lvâ
;

1973 
	m≠ic_lvçc
;

1974 
	m≠ic_lvt0
;

1975 
	m≠ic_lvt1
;

1976 
	m≠ic_lvãº
;

1977 
	m≠ic_tmi˘
;

1978 
	m≠ic_td¸
;

1979 
	m≠ic_thmr
;

1980 } 
	g≠ic_pm_°©e
;

1982 
	$œpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1984 
Êags
;

1985 
maxlvt
;

1987 i‡(!
≠ic_pm_°©e
.
a˘ive
)

1990 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1992 
≠ic_pm_°©e
.
≠ic_id
 = 
	`≠ic_ªad
(
APIC_ID
);

1993 
≠ic_pm_°©e
.
≠ic_èsk¥i
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1994 
≠ic_pm_°©e
.
≠ic_ldr
 = 
	`≠ic_ªad
(
APIC_LDR
);

1995 
≠ic_pm_°©e
.
≠ic_d‰
 = 
	`≠ic_ªad
(
APIC_DFR
);

1996 
≠ic_pm_°©e
.
≠ic_•iv
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1997 
≠ic_pm_°©e
.
≠ic_lvâ
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1998 i‡(
maxlvt
 >= 4)

1999 
≠ic_pm_°©e
.
≠ic_lvçc
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

2000 
≠ic_pm_°©e
.
≠ic_lvt0
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2001 
≠ic_pm_°©e
.
≠ic_lvt1
 = 
	`≠ic_ªad
(
APIC_LVT1
);

2002 
≠ic_pm_°©e
.
≠ic_lvãº
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

2003 
≠ic_pm_°©e
.
≠ic_tmi˘
 = 
	`≠ic_ªad
(
APIC_TMICT
);

2004 
≠ic_pm_°©e
.
≠ic_td¸
 = 
	`≠ic_ªad
(
APIC_TDCR
);

2005 #ifde‡
CONFIG_X86_THERMAL_VECTOR


2006 i‡(
maxlvt
 >= 5)

2007 
≠ic_pm_°©e
.
≠ic_thmr
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

2010 
	`loˇl_úq_ßve
(
Êags
);

2011 
	`dißbÀ_loˇl_APIC
();

2013 i‡(
öå_ªm≠pög_íabÀd
)

2014 
	`dißbÀ_öå_ªm≠pög
();

2016 
	`loˇl_úq_ª°‹e
(
Êags
);

2018 
	}
}

2020 
	$œpic_ªsume
(
sys_devi˚
 *
dev
)

2022 
l
, 
h
;

2023 
Êags
;

2024 
maxlvt
;

2025 
ªt
 = 0;

2026 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
 = 
NULL
;

2028 i‡(!
≠ic_pm_°©e
.
a˘ive
)

2031 
	`loˇl_úq_ßve
(
Êags
);

2032 i‡(
öå_ªm≠pög_íabÀd
) {

2033 
iﬂpic_íåõs
 = 
	`Æloc_iﬂpic_íåõs
();

2034 i‡(!
iﬂpic_íåõs
) {

2035 
	`WARN
(1, "Alloc ioapic_entries inÜapicÑesume failed.");

2036 
ªt
 = -
ENOMEM
;

2037 
ª°‹e
;

2040 
ªt
 = 
	`ßve_IO_APIC_£tup
(
iﬂpic_íåõs
);

2041 i‡(
ªt
) {

2042 
	`WARN
(1, "Savög IO-APIC sèã faûed: %d\n", 
ªt
);

2043 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2044 
ª°‹e
;

2047 
	`mask_IO_APIC_£tup
(
iﬂpic_íåõs
);

2048 
Àgacy_pic
->
	`mask_Æl
();

2051 i‡(
x2≠ic_mode
)

2052 
	`íabÀ_x2≠ic
();

2060 
	`rdm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2061 
l
 &~
MSR_IA32_APICBASE_BASE
;

2062 
l
 |
MSR_IA32_APICBASE_ENABLE
 | 
mp_œpic_addr
;

2063 
	`wrm§
(
MSR_IA32_APICBASE
, 
l
, 
h
);

2066 
maxlvt
 = 
	`œpic_gë_maxlvt
();

2067 
	`≠ic_wrôe
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

2068 
	`≠ic_wrôe
(
APIC_ID
, 
≠ic_pm_°©e
.
≠ic_id
);

2069 
	`≠ic_wrôe
(
APIC_DFR
, 
≠ic_pm_°©e
.
≠ic_d‰
);

2070 
	`≠ic_wrôe
(
APIC_LDR
, 
≠ic_pm_°©e
.
≠ic_ldr
);

2071 
	`≠ic_wrôe
(
APIC_TASKPRI
, 
≠ic_pm_°©e
.
≠ic_èsk¥i
);

2072 
	`≠ic_wrôe
(
APIC_SPIV
, 
≠ic_pm_°©e
.
≠ic_•iv
);

2073 
	`≠ic_wrôe
(
APIC_LVT0
, 
≠ic_pm_°©e
.
≠ic_lvt0
);

2074 
	`≠ic_wrôe
(
APIC_LVT1
, 
≠ic_pm_°©e
.
≠ic_lvt1
);

2075 #i‡
	`deföed
(
CONFIG_X86_MCE_P4THERMAL
Ë|| deföed(
CONFIG_X86_MCE_INTEL
)

2076 i‡(
maxlvt
 >= 5)

2077 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
≠ic_pm_°©e
.
≠ic_thmr
);

2079 i‡(
maxlvt
 >= 4)

2080 
	`≠ic_wrôe
(
APIC_LVTPC
, 
≠ic_pm_°©e
.
≠ic_lvçc
);

2081 
	`≠ic_wrôe
(
APIC_LVTT
, 
≠ic_pm_°©e
.
≠ic_lvâ
);

2082 
	`≠ic_wrôe
(
APIC_TDCR
, 
≠ic_pm_°©e
.
≠ic_td¸
);

2083 
	`≠ic_wrôe
(
APIC_TMICT
, 
≠ic_pm_°©e
.
≠ic_tmi˘
);

2084 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2085 
	`≠ic_ªad
(
APIC_ESR
);

2086 
	`≠ic_wrôe
(
APIC_LVTERR
, 
≠ic_pm_°©e
.
≠ic_lvãº
);

2087 
	`≠ic_wrôe
(
APIC_ESR
, 0);

2088 
	`≠ic_ªad
(
APIC_ESR
);

2090 i‡(
öå_ªm≠pög_íabÀd
) {

2091 
	`ªíabÀ_öå_ªm≠pög
(
x2≠ic_mode
);

2092 
Àgacy_pic
->
	`ª°‹e_mask
();

2093 
	`ª°‹e_IO_APIC_£tup
(
iﬂpic_íåõs
);

2094 
	`‰ì_iﬂpic_íåõs
(
iﬂpic_íåõs
);

2096 
ª°‹e
:

2097 
	`loˇl_úq_ª°‹e
(
Êags
);

2099  
ªt
;

2100 
	}
}

2107 
sysdev_˛ass
 
	gœpic_sys˛ass
 = {

2108 .
«me
 = "lapic",

2109 .
	gªsume
 = 
œpic_ªsume
,

2110 .
	gsu•íd
 = 
œpic_su•íd
,

2113 
sys_devi˚
 
	gdevi˚_œpic
 = {

2114 .
id
 = 0,

2115 .
	g˛s
 = &
œpic_sys˛ass
,

2118 
__˝uöô
 
	$≠ic_pm_a˘iv©e
()

2120 
≠ic_pm_°©e
.
a˘ive
 = 1;

2121 
	}
}

2123 
__öô
 
	$öô_œpic_sysfs
()

2125 
îr‹
;

2127 i‡(!
˝u_has_≠ic
)

2131 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
œpic_sys˛ass
);

2132 i‡(!
îr‹
)

2133 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic
);

2134  
îr‹
;

2135 
	}
}

2138 
c‹e_öôˇŒ
(
öô_œpic_sysfs
);

2142 
	$≠ic_pm_a˘iv©e
(Ë{ 
	}
}

2146 #ifde‡
CONFIG_X86_64


2148 
__˝uöô
 
	$≠ic_˛u°î_num
()

2150 
i
, 
˛u°îs
, 
zîos
;

2151 
id
;

2152 
u16
 *
bios_˝u_≠icid
;

2153 
	`DECLARE_BITMAP
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2155 
bios_˝u_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
);

2156 
	`bôm≠_zîo
(
˛u°îm≠
, 
NUM_APIC_CLUSTERS
);

2158 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

2160 i‡(
bios_˝u_≠icid
) {

2161 
id
 = 
bios_˝u_≠icid
[
i
];

2162 } i‡(
i
 < 
ƒ_˝u_ids
) {

2163 i‡(
	`˝u_¥e£¡
(
i
))

2164 
id
 = 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
i
);

2170 i‡(
id
 !
BAD_APICID
)

2171 
	`__£t_bô
(
	`APIC_CLUSTERID
(
id
), 
˛u°îm≠
);

2180 
˛u°îs
 = 0;

2181 
zîos
 = 0;

2182 
i
 = 0; i < 
NUM_APIC_CLUSTERS
; i++) {

2183 i‡(
	`ã°_bô
(
i
, 
˛u°îm≠
)) {

2184 
˛u°îs
 +1 + 
zîos
;

2185 
zîos
 = 0;

2187 ++
zîos
;

2190  
˛u°îs
;

2191 
	}
}

2193 
__˝uöôd©a
 
	gmu…i_checked
;

2194 
__˝uöôd©a
 
	gmu…i
;

2196 
__˝uöô
 
	$£t_mu…i
(c⁄° 
dmi_sy°em_id
 *
d
)

2198 i‡(
mu…i
)

2200 
	`¥_öfo
("APIC: %†dëe˘ed, Mu…òChassis\n", 
d
->
idít
);

2201 
mu…i
 = 1;

2203 
	}
}

2205 c⁄° 
__˝uöôc⁄°
 
dmi_sy°em_id
 
	gmu…i_dmi_èbÀ
[] = {

2207 .
ˇŒback
 = 
£t_mu…i
,

2208 .
	gidít
 = "IBM System Summit2",

2209 .
	gm©ches
 = {

2210 
DMI_MATCH
(
DMI_SYS_VENDOR
, "IBM"),

2211 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Summit2"),

2217 
__˝uöô
 
	$dmi_check_mu…i
()

2219 i‡(
mu…i_checked
)

2222 
	`dmi_check_sy°em
(
mu…i_dmi_èbÀ
);

2223 
mu…i_checked
 = 1;

2224 
	}
}

2234 
__˝uöô
 
	$≠ic_is_˛u°îed_box
()

2236 
	`dmi_check_mu…i
();

2237 i‡(
mu…i
)

2240 i‡(!
	`is_vsmp_box
())

2247 i‡(
	`≠ic_˛u°î_num
() > 1)

2251 
	}
}

2257 
__öô
 
	$£tup_dißbÀ≠ic
(*
¨g
)

2259 
dißbÀ_≠ic
 = 1;

2260 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

2262 
	}
}

2263 
óæy_∑øm
("dißbÀ≠ic", 
£tup_dißbÀ≠ic
);

2266 
__öô
 
	$£tup_nﬁ≠ic
(*
¨g
)

2268  
	`£tup_dißbÀ≠ic
(
¨g
);

2269 
	}
}

2270 
óæy_∑øm
("nﬁ≠ic", 
£tup_nﬁ≠ic
);

2272 
__öô
 
	$∑r£_œpic_timî_c2_ok
(*
¨g
)

2274 
loˇl_≠ic_timî_c2_ok
 = 1;

2276 
	}
}

2277 
óæy_∑øm
("œpic_timî_c2_ok", 
∑r£_œpic_timî_c2_ok
);

2279 
__öô
 
	$∑r£_dißbÀ_≠ic_timî
(*
¨g
)

2281 
dißbÀ_≠ic_timî
 = 1;

2283 
	}
}

2284 
óæy_∑øm
("nﬂpi˘imî", 
∑r£_dißbÀ_≠ic_timî
);

2286 
__öô
 
	$∑r£_nﬁ≠ic_timî
(*
¨g
)

2288 
dißbÀ_≠ic_timî
 = 1;

2290 
	}
}

2291 
óæy_∑øm
("nﬁ≠ic_timî", 
∑r£_nﬁ≠ic_timî
);

2293 
__öô
 
	$≠ic_£t_vîbosôy
(*
¨g
)

2295 i‡(!
¨g
) {

2296 #ifde‡
CONFIG_X86_64


2297 
skù_iﬂpic_£tup
 = 0;

2300  -
EINVAL
;

2303 i‡(
	`°rcmp
("debug", 
¨g
) == 0)

2304 
≠ic_vîbosôy
 = 
APIC_DEBUG
;

2305 i‡(
	`°rcmp
("vîbo£", 
¨g
) == 0)

2306 
≠ic_vîbosôy
 = 
APIC_VERBOSE
;

2308 
	`¥_w¨nög
("APIC VerbosityÜevel %sÇotÑecognised"

2309 " u£ápic=vîbo£ o∏≠ic=debug\n", 
¨g
);

2310  -
EINVAL
;

2314 
	}
}

2315 
óæy_∑øm
("≠ic", 
≠ic_£t_vîbosôy
);

2317 
__öô
 
	$œpic_ö£π_ªsour˚
()

2319 i‡(!
≠ic_phys
)

2323 
œpic_ªsour˚
.
°¨t
 = 
≠ic_phys
;

2324 
œpic_ªsour˚
.
íd
 =Ü≠ic_ªsour˚.
°¨t
 + 
PAGE_SIZE
 - 1;

2325 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
œpic_ªsour˚
);

2328 
	}
}

2334 
œã_öôˇŒ
(
œpic_ö£π_ªsour˚
);

	@/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<asm/smp.h
>

20 
	~<asm/≠ic.h
>

21 
	~<asm/ùi.h
>

23 #ifde‡
CONFIG_ACPI


24 
	~<a˝i/a˝i_bus.h
>

27 
	$Ê©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

30 
	}
}

32 c⁄° 
˝umask
 *
	$Ê©_èrgë_˝us
()

34  
˝u_⁄löe_mask
;

35 
	}
}

37 
	$Ê©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

47 
	`˝umask_˛ór
(
ªtmask
);

48 
	`˝umask_bôs
(
ªtmask
)[0] = 
APIC_ALL_CPUS
;

49 
	}
}

58 
	$Ê©_öô_≠ic_ldr
()

60 
vÆ
;

61 
num
, 
id
;

63 
num
 = 
	`smp_¥o˚ss‹_id
();

64 
id
 = 1UL << 
num
;

65 
	`≠ic_wrôe
(
APIC_DFR
, 
APIC_DFR_FLAT
);

66 
vÆ
 = 
	`≠ic_ªad
(
APIC_LDR
Ë& ~
APIC_LDR_MASK
;

67 
vÆ
 |
	`SET_APIC_LOGICAL_ID
(
id
);

68 
	`≠ic_wrôe
(
APIC_LDR
, 
vÆ
);

69 
	}
}

71 
ölöe
 
	$_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
)

73 
Êags
;

75 
	`loˇl_úq_ßve
(
Êags
);

76 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

77 
	`loˇl_úq_ª°‹e
(
Êags
);

78 
	}
}

80 
	$Ê©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

82 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

84 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

85 
	}
}

88 
	$Ê©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

90 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

91 
˝u
 = 
	`smp_¥o˚ss‹_id
();

93 i‡(
˝u
 < 
BITS_PER_LONG
)

94 
	`˛ór_bô
(
˝u
, &
mask
);

96 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

97 
	}
}

99 
	$Ê©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

101 
˝u
 = 
	`smp_¥o˚ss‹_id
();

102 #ifdef 
CONFIG_HOTPLUG_CPU


103 
hŸ∂ug
 = 1;

105 
hŸ∂ug
 = 0;

107 i‡(
hŸ∂ug
 || 
ve˘‹
 =
NMI_VECTOR
) {

108 i‡(!
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
	`˝umask_of
(
˝u
))) {

109 
mask
 = 
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0];

111 i‡(
˝u
 < 
BITS_PER_LONG
)

112 
	`˛ór_bô
(
˝u
, &
mask
);

114 
	`_Ê©_£nd_IPI_mask
(
mask
, 
ve˘‹
);

116 } i‡(
	`num_⁄löe_˝us
() > 1) {

117 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLBUT
,

118 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

120 
	}
}

122 
	$Ê©_£nd_IPI_Æl
(
ve˘‹
)

124 i‡(
ve˘‹
 =
NMI_VECTOR
) {

125 
	`Ê©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

127 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_ALLINC
,

128 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

130 
	}
}

132 
	$Ê©_gë_≠ic_id
(
x
)

134 
id
;

136 
id
 = (((
x
)>>24) & 0xFFu);

138  
id
;

139 
	}
}

141 
	$£t_≠ic_id
(
id
)

143 
x
;

145 
x
 = ((
id
 & 0xFFu)<<24);

146  
x
;

147 
	}
}

149 
	$ªad_x≠ic_id
()

151 
id
;

153 
id
 = 
	`Ê©_gë_≠ic_id
(
	`≠ic_ªad
(
APIC_ID
));

154  
id
;

155 
	}
}

157 
	$Ê©_≠ic_id_ªgi°îed
()

159  
	`physid_is£t
(
	`ªad_x≠ic_id
(), 
phys_˝u_¥e£¡_m≠
);

160 
	}
}

162 
	$Ê©_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

164  
öôül_≠ic_id
 >> 
ödex_msb
;

165 
	}
}

167 
≠ic
 
	g≠ic_Ê©
 = {

168 .
«me
 = "flat",

169 .
	g¥obe
 = 
NULL
,

170 .
	ga˝i_madt_€m_check
 = 
Ê©_a˝i_madt_€m_check
,

171 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

173 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

174 .
	gúq_de°_mode
 = 1,

176 .
	gèrgë_˝us
 = 
Ê©_èrgë_˝us
,

177 .
	gdißbÀ_e§
 = 0,

178 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

179 .
	gcheck_≠icid_u£d
 = 
NULL
,

180 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

182 .
	gve˘‹_Æloˇti⁄_domaö
 = 
Ê©_ve˘‹_Æloˇti⁄_domaö
,

183 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

185 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

186 .
	g£tup_≠ic_routög
 = 
NULL
,

187 .
	gmu…i_timî_check
 = 
NULL
,

188 .
	g≠icid_to_node
 = 
NULL
,

189 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

190 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

191 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

192 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

193 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

194 .
	gíabÀ_≠ic_mode
 = 
NULL
,

195 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

196 .
	gmps_€m_check
 = 
NULL
,

198 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

199 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

200 .
	g≠ic_id_mask
 = 0xFFu << 24,

202 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

203 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

205 .
	g£nd_IPI_mask
 = 
Ê©_£nd_IPI_mask
,

206 .
	g£nd_IPI_mask_Ælbut£lf
 = 
Ê©_£nd_IPI_mask_Ælbut£lf
,

207 .
	g£nd_IPI_Ælbut£lf
 = 
Ê©_£nd_IPI_Ælbut£lf
,

208 .
	g£nd_IPI_Æl
 = 
Ê©_£nd_IPI_Æl
,

209 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

211 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

212 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

213 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

214 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

215 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

217 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

218 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

219 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

220 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

221 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

222 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

230 
	$physÊ©_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

232 #ifde‡
CONFIG_ACPI


238 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

239 (
a˝i_gbl_FADT
.
Êags
 & 
ACPI_FADT_APIC_PHYSICAL
)) {

240 
	`¥ötk
(
KERN_DEBUG
 "system APIC only can useÖhysical flat");

244 i‡(!
	`°∫cmp
(
€m_id
, "IBM", 3Ë&& !°∫cmp(
€m_èbÀ_id
, "EXA", 3)) {

245 
	`¥ötk
(
KERN_DEBUG
 "IBM Summit detected, will useápicÖhysical");

251 
	}
}

253 c⁄° 
˝umask
 *
	$physÊ©_èrgë_˝us
()

255  
˝u_⁄löe_mask
;

256 
	}
}

258 
	$physÊ©_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

260 
	`˝umask_˛ór
(
ªtmask
);

261 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

262 
	}
}

264 
	$physÊ©_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

266 
	`deÁu…_£nd_IPI_mask_£quí˚_phys
(
˝umask
, 
ve˘‹
);

267 
	}
}

269 
	$physÊ©_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *cpumask,

270 
ve˘‹
)

272 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝umask
, 
ve˘‹
);

273 
	}
}

275 
	$physÊ©_£nd_IPI_Ælbut£lf
(
ve˘‹
)

277 
	`deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(
˝u_⁄löe_mask
, 
ve˘‹
);

278 
	}
}

280 
	$physÊ©_£nd_IPI_Æl
(
ve˘‹
)

282 
	`physÊ©_£nd_IPI_mask
(
˝u_⁄löe_mask
, 
ve˘‹
);

283 
	}
}

285 
	$physÊ©_˝u_mask_to_≠icid
(c⁄° 
˝umask
 *cpumask)

287 
˝u
;

293 
˝u
 = 
	`˝umask_fú°
(
˝umask
);

294 i‡(()
˝u
 < 
ƒ_˝u_ids
)

295  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

297  
BAD_APICID
;

298 
	}
}

301 
	$physÊ©_˝u_mask_to_≠icid_™d
(c⁄° 
˝umask
 *cpumask,

302 c⁄° 
˝umask
 *
™dmask
)

304 
˝u
;

310 
	`f‹_óch_˝u_™d
(
˝u
, 
˝umask
, 
™dmask
) {

311 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_⁄löe_mask
))

314  
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
);

315 
	}
}

317 
≠ic
 
	g≠ic_physÊ©
 = {

319 .
«me
 = "physical flat",

320 .
	g¥obe
 = 
NULL
,

321 .
	ga˝i_madt_€m_check
 = 
physÊ©_a˝i_madt_€m_check
,

322 .
	g≠ic_id_ªgi°îed
 = 
Ê©_≠ic_id_ªgi°îed
,

324 .
	gúq_dñivîy_mode
 = 
de°_Fixed
,

325 .
	gúq_de°_mode
 = 0,

327 .
	gèrgë_˝us
 = 
physÊ©_èrgë_˝us
,

328 .
	gdißbÀ_e§
 = 0,

329 .
	gde°_logiˇl
 = 0,

330 .
	gcheck_≠icid_u£d
 = 
NULL
,

331 .
	gcheck_≠icid_¥e£¡
 = 
NULL
,

333 .
	gve˘‹_Æloˇti⁄_domaö
 = 
physÊ©_ve˘‹_Æloˇti⁄_domaö
,

335 .
	göô_≠ic_ldr
 = 
Ê©_öô_≠ic_ldr
,

337 .
	giﬂpic_phys_id_m≠
 = 
NULL
,

338 .
	g£tup_≠ic_routög
 = 
NULL
,

339 .
	gmu…i_timî_check
 = 
NULL
,

340 .
	g≠icid_to_node
 = 
NULL
,

341 .
	g˝u_to_logiˇl_≠icid
 = 
NULL
,

342 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

343 .
	g≠icid_to_˝u_¥e£¡
 = 
NULL
,

344 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

345 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

346 .
	gíabÀ_≠ic_mode
 = 
NULL
,

347 .
	gphys_pkg_id
 = 
Ê©_phys_pkg_id
,

348 .
	gmps_€m_check
 = 
NULL
,

350 .
	ggë_≠ic_id
 = 
Ê©_gë_≠ic_id
,

351 .
	g£t_≠ic_id
 = 
£t_≠ic_id
,

352 .
	g≠ic_id_mask
 = 0xFFu << 24,

354 .
	g˝u_mask_to_≠icid
 = 
physÊ©_˝u_mask_to_≠icid
,

355 .
	g˝u_mask_to_≠icid_™d
 = 
physÊ©_˝u_mask_to_≠icid_™d
,

357 .
	g£nd_IPI_mask
 = 
physÊ©_£nd_IPI_mask
,

358 .
	g£nd_IPI_mask_Ælbut£lf
 = 
physÊ©_£nd_IPI_mask_Ælbut£lf
,

359 .
	g£nd_IPI_Ælbut£lf
 = 
physÊ©_£nd_IPI_Ælbut£lf
,

360 .
	g£nd_IPI_Æl
 = 
physÊ©_£nd_IPI_Æl
,

361 .
	g£nd_IPI_£lf
 = 
≠ic_£nd_IPI_£lf
,

363 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

364 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

365 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

366 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

367 .
	göquúe_ªmŸe_≠ic
 = 
deÁu…_öquúe_ªmŸe_≠ic
,

369 .
	gªad
 = 
«tive_≠ic_mem_ªad
,

370 .
	gwrôe
 = 
«tive_≠ic_mem_wrôe
,

371 .
	gi¸_ªad
 = 
«tive_≠ic_i¸_ªad
,

372 .
	gi¸_wrôe
 = 
«tive_≠ic_i¸_wrôe
,

373 .
	gwaô_i¸_idÀ
 = 
«tive_≠ic_waô_i¸_idÀ
,

374 .
	gß„_waô_i¸_idÀ
 = 
«tive_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c

12 
	~<löux/thªads.h
>

13 
	~<löux/˝umask.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/˘y≥.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/î∫o.h
>

20 
	~<asm/fixm≠.h
>

21 
	~<asm/mp•ec.h
>

22 
	~<asm/≠icdef.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/£tup.h
>

26 
	~<löux/smp.h
>

27 
	~<asm/ùi.h
>

29 
	~<löux/öãºu±.h
>

30 
	~<asm/a˝i.h
>

31 
	~<asm/e820.h
>

33 
	$no›_öô_≠ic_ldr
(Ë{ 
	}
}

34 
	$no›_£nd_IPI_mask
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

35 
	$no›_£nd_IPI_mask_Ælbut£lf
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
Ë{ 
	}
}

36 
	$no›_£nd_IPI_Ælbut£lf
(
ve˘‹
Ë{ 
	}
}

37 
	$no›_£nd_IPI_Æl
(
ve˘‹
Ë{ 
	}
}

38 
	$no›_£nd_IPI_£lf
(
ve˘‹
Ë{ 
	}
}

39 
	$no›_≠ic_waô_i¸_idÀ
(Ë{ 
	}
}

40 
	$no›_≠ic_i¸_wrôe
(
u32
 
low
, u32 
id
Ë{ 
	}
}

42 
	$no›_wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_eù
)

45 
	}
}

47 
u32
 
	$no›_ß„_≠ic_waô_i¸_idÀ
()

50 
	}
}

52 
u64
 
	$no›_≠ic_i¸_ªad
()

55 
	}
}

57 
	$no›_˝u_to_logiˇl_≠icid
(
˝u
)

60 
	}
}

62 
	$no›_phys_pkg_id
(
˝uid_≠ic
, 
ödex_msb
)

65 
	}
}

67 
	$no›_gë_≠ic_id
(
x
)

70 
	}
}

72 
	$no›_¥obe
()

79 
	}
}

81 
	$no›_≠ic_id_ªgi°îed
()

89  
	`physid_is£t
(0, 
phys_˝u_¥e£¡_m≠
);

90 
	}
}

92 c⁄° 
˝umask
 *
	$no›_èrgë_˝us
()

95  
	`˝umask_of
(0);

96 
	}
}

98 
	$no›_check_≠icid_u£d
(
physid_mask_t
 *
m≠
, 
≠icid
)

100  
	`physid_is£t
(
≠icid
, *
m≠
);

101 
	}
}

103 
	$no›_check_≠icid_¥e£¡
(
bô
)

105  
	`physid_is£t
(
bô
, 
phys_˝u_¥e£¡_m≠
);

106 
	}
}

108 
	$no›_ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
˝umask
 *
ªtmask
)

110 i‡(
˝u
 != 0)

111 
	`¥_w¨nög
("APIC: Vectorállocated forÇon-BSP cpu\n");

112 
	`˝umask_˛ór
(
ªtmask
);

113 
	`˝umask_£t_˝u
(
˝u
, 
ªtmask
);

114 
	}
}

116 
	$no›_≠icid_to_node
(
logiˇl_≠icid
)

120 
	}
}

122 
u32
 
	$no›_≠ic_ªad
(
u32
 
ªg
)

124 
	`WARN_ON_ONCE
((
˝u_has_≠ic
 && !
dißbÀ_≠ic
));

126 
	}
}

128 
	$no›_≠ic_wrôe
(
u32
 
ªg
, u32 
v
)

130 
	`WARN_ON_ONCE
(
˝u_has_≠ic
 && !
dißbÀ_≠ic
);

131 
	}
}

133 
≠ic
 
	g≠ic_no›
 = {

134 .
«me
 = "noop",

135 .
	g¥obe
 = 
no›_¥obe
,

136 .
	ga˝i_madt_€m_check
 = 
NULL
,

138 .
	g≠ic_id_ªgi°îed
 = 
no›_≠ic_id_ªgi°îed
,

140 .
	gúq_dñivîy_mode
 = 
de°_Lowe°Prio
,

142 .
	gúq_de°_mode
 = 1,

144 .
	gèrgë_˝us
 = 
no›_èrgë_˝us
,

145 .
	gdißbÀ_e§
 = 0,

146 .
	gde°_logiˇl
 = 
APIC_DEST_LOGICAL
,

147 .
	gcheck_≠icid_u£d
 = 
no›_check_≠icid_u£d
,

148 .
	gcheck_≠icid_¥e£¡
 = 
no›_check_≠icid_¥e£¡
,

150 .
	gve˘‹_Æloˇti⁄_domaö
 = 
no›_ve˘‹_Æloˇti⁄_domaö
,

151 .
	göô_≠ic_ldr
 = 
no›_öô_≠ic_ldr
,

153 .
	giﬂpic_phys_id_m≠
 = 
deÁu…_iﬂpic_phys_id_m≠
,

154 .
	g£tup_≠ic_routög
 = 
NULL
,

155 .
	gmu…i_timî_check
 = 
NULL
,

156 .
	g≠icid_to_node
 = 
no›_≠icid_to_node
,

158 .
	g˝u_to_logiˇl_≠icid
 = 
no›_˝u_to_logiˇl_≠icid
,

159 .
	g˝u_¥e£¡_to_≠icid
 = 
deÁu…_˝u_¥e£¡_to_≠icid
,

160 .
	g≠icid_to_˝u_¥e£¡
 = 
physid_£t_mask_of_physid
,

162 .
	g£tup_p‹tio_ªm≠
 = 
NULL
,

163 .
	gcheck_phys_≠icid_¥e£¡
 = 
deÁu…_check_phys_≠icid_¥e£¡
,

164 .
	gíabÀ_≠ic_mode
 = 
NULL
,

166 .
	gphys_pkg_id
 = 
no›_phys_pkg_id
,

168 .
	gmps_€m_check
 = 
NULL
,

170 .
	ggë_≠ic_id
 = 
no›_gë_≠ic_id
,

171 .
	g£t_≠ic_id
 = 
NULL
,

172 .
	g≠ic_id_mask
 = 0x0F << 24,

174 .
	g˝u_mask_to_≠icid
 = 
deÁu…_˝u_mask_to_≠icid
,

175 .
	g˝u_mask_to_≠icid_™d
 = 
deÁu…_˝u_mask_to_≠icid_™d
,

177 .
	g£nd_IPI_mask
 = 
no›_£nd_IPI_mask
,

178 .
	g£nd_IPI_mask_Ælbut£lf
 = 
no›_£nd_IPI_mask_Ælbut£lf
,

179 .
	g£nd_IPI_Ælbut£lf
 = 
no›_£nd_IPI_Ælbut£lf
,

180 .
	g£nd_IPI_Æl
 = 
no›_£nd_IPI_Æl
,

181 .
	g£nd_IPI_£lf
 = 
no›_£nd_IPI_£lf
,

183 .
	gwakeup_£c⁄d¨y_˝u
 = 
no›_wakeup_£c⁄d¨y_˝u
,

186 .
	gåampﬁöe_phys_low
 = 
DEFAULT_TRAMPOLINE_PHYS_LOW
,

187 .
	gåampﬁöe_phys_high
 = 
DEFAULT_TRAMPOLINE_PHYS_HIGH
,

189 .
	gwaô_f‹_öô_dós£π
 = 
NULL
,

191 .
	gsmp_ˇŒö_˛ór_loˇl_≠ic
 = 
NULL
,

192 .
	göquúe_ªmŸe_≠ic
 = 
NULL
,

194 .
	gªad
 = 
no›_≠ic_ªad
,

195 .
	gwrôe
 = 
no›_≠ic_wrôe
,

196 .
	gi¸_ªad
 = 
no›_≠ic_i¸_ªad
,

197 .
	gi¸_wrôe
 = 
no›_≠ic_i¸_wrôe
,

198 .
	gwaô_i¸_idÀ
 = 
no›_≠ic_waô_i¸_idÀ
,

199 .
	gß„_waô_i¸_idÀ
 = 
no›_ß„_≠ic_waô_i¸_idÀ
,

	@/cmpt816/linux/arch/x86/kernel/apic/io_apic.c

23 
	~<löux/mm.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/sched.h
>

28 
	~<löux/pci.h
>

29 
	~<löux/mc146818πc.h
>

30 
	~<löux/compûî.h
>

31 
	~<löux/a˝i.h
>

32 
	~<löux/moduÀ.h
>

33 
	~<löux/sysdev.h
>

34 
	~<löux/msi.h
>

35 
	~<löux/htúq.h
>

36 
	~<löux/‰ìzî.h
>

37 
	~<löux/kthªad.h
>

38 
	~<löux/jiffõs.h
>

39 
	~<löux/¶ab.h
>

40 #ifde‡
CONFIG_ACPI


41 
	~<a˝i/a˝i_bus.h
>

43 
	~<löux/boŸmem.h
>

44 
	~<löux/dm¨.h
>

45 
	~<löux/h≥t.h
>

47 
	~<asm/idÀ.h
>

48 
	~<asm/io.h
>

49 
	~<asm/smp.h
>

50 
	~<asm/˝u.h
>

51 
	~<asm/desc.h
>

52 
	~<asm/¥Ÿo.h
>

53 
	~<asm/a˝i.h
>

54 
	~<asm/dma.h
>

55 
	~<asm/timî.h
>

56 
	~<asm/i8259.h
>

57 
	~<asm/nmi.h
>

58 
	~<asm/msidef.h
>

59 
	~<asm/hy≥πøn•‹t.h
>

60 
	~<asm/£tup.h
>

61 
	~<asm/úq_ªm≠pög.h
>

62 
	~<asm/h≥t.h
>

63 
	~<asm/hw_úq.h
>

65 
	~<asm/≠ic.h
>

67 
	#__≠icdebugöô
(
ty≥
Ëty≥ 
__öô


	)

68 
	#f‹_óch_úq_pö
(
íåy
, 
hód
) \

69 
íåy
 = 
hód
;É¡ry;É¡ry =É¡ry->
√xt
)

	)

75 
	gsis_≠ic_bug
 = -1;

77 
DEFINE_RAW_SPINLOCK
(
iﬂpic_lock
);

78 
DEFINE_RAW_SPINLOCK
(
ve˘‹_lock
);

83 
	gƒ_iﬂpic_ªgi°îs
[
MAX_IO_APICS
];

86 
mpc_iﬂpic
 
	gmp_iﬂpics
[
MAX_IO_APICS
];

87 
	gƒ_iﬂpics
;

90 
mp_iﬂpic_gsi
 
	gmp_gsi_routög
[
MAX_IO_APICS
];

93 
u32
 
	ggsi_t›
;

96 
mpc_öt§c
 
	gmp_úqs
[
MAX_IRQ_SOURCES
];

99 
	gmp_úq_íåõs
;

102 
	gƒ_úqs_gsi
 = 
NR_IRQS_LEGACY
;

104 #i‡
deföed
 (
CONFIG_MCA
Ë|| deföed (
CONFIG_EISA
)

105 
	gmp_bus_id_to_ty≥
[
MAX_MP_BUSSES
];

108 
DECLARE_BITMAP
(
mp_bus_nŸ_pci
, 
MAX_MP_BUSSES
);

110 
	gskù_iﬂpic_£tup
;

112 
	$¨ch_dißbÀ_smp_suµ‹t
()

114 #ifde‡
CONFIG_PCI


115 
noiﬂpicquúk
 = 1;

116 
noiﬂpi¸îouã
 = -1;

118 
skù_iﬂpic_£tup
 = 1;

119 
	}
}

121 
__öô
 
	$∑r£_nﬂpic
(*
°r
)

124 
	`¨ch_dißbÀ_smp_suµ‹t
();

126 
	}
}

127 
óæy_∑øm
("nﬂpic", 
∑r£_nﬂpic
);

129 
	súq_pö_li°
 {

130 
	m≠ic
, 
	mpö
;

131 
úq_pö_li°
 *
	m√xt
;

134 
úq_pö_li°
 *
	$gë_⁄e_‰ì_úq_2_pö
(
node
)

136 
úq_pö_li°
 *
pö
;

138 
pö
 = 
	`kzÆloc_node
((*pö), 
GFP_ATOMIC
, 
node
);

140  
pö
;

141 
	}
}

144 #ifde‡
CONFIG_SPARSE_IRQ


145 
úq_cfg
 
	gúq_cfgx
[
NR_IRQS_LEGACY
];

147 
úq_cfg
 
	gúq_cfgx
[
NR_IRQS
];

150 
__öô
 
	$¨ch_óæy_úq_öô
()

152 
úq_cfg
 *
cfg
;

153 
úq_desc
 *
desc
;

154 
cou¡
;

155 
node
;

156 
i
;

158 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

159 
ƒ_úqs_gsi
 = 0;

160 
io_≠ic_úqs
 = ~0UL;

163 
cfg
 = 
úq_cfgx
;

164 
cou¡
 = 
	`ARRAY_SIZE
(
úq_cfgx
);

165 
node

	`˝u_to_node
(
boŸ_˝u_id
);

167 
i
 = 0; i < 
cou¡
; i++) {

168 
desc
 = 
	`úq_to_desc
(
i
);

169 
desc
->
chù_d©a
 = &
cfg
[
i
];

170 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
domaö
, 
GFP_NOWAIT
, 
node
);

171 
	`zÆloc_˝umask_v¨_node
(&
cfg
[
i
].
ﬁd_domaö
, 
GFP_NOWAIT
, 
node
);

176 i‡(
i
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

177 
cfg
[
i
].
ve˘‹
 = 
IRQ0_VECTOR
 + i;

178 
	`˝umask_£t_˝u
(0, 
cfg
[
i
].
domaö
);

183 
	}
}

185 #ifde‡
CONFIG_SPARSE_IRQ


186 
úq_cfg
 *
	$úq_cfg
(
úq
)

188 
úq_cfg
 *
cfg
 = 
NULL
;

189 
úq_desc
 *
desc
;

191 
desc
 = 
	`úq_to_desc
(
úq
);

192 i‡(
desc
)

193 
cfg
 = 
desc
->
chù_d©a
;

195  
cfg
;

196 
	}
}

198 
úq_cfg
 *
	$gë_⁄e_‰ì_úq_cfg
(
node
)

200 
úq_cfg
 *
cfg
;

202 
cfg
 = 
	`kzÆloc_node
((*cfg), 
GFP_ATOMIC
, 
node
);

203 i‡(
cfg
) {

204 i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
domaö
, 
GFP_ATOMIC
, 
node
)) {

205 
	`k‰ì
(
cfg
);

206 
cfg
 = 
NULL
;

207 } i‡(!
	`zÆloc_˝umask_v¨_node
(&
cfg
->
ﬁd_domaö
,

208 
GFP_ATOMIC
, 
node
)) {

209 
	`‰ì_˝umask_v¨
(
cfg
->
domaö
);

210 
	`k‰ì
(
cfg
);

211 
cfg
 = 
NULL
;

215  
cfg
;

216 
	}
}

218 
	$¨ch_öô_chù_d©a
(
úq_desc
 *
desc
, 
node
)

220 
úq_cfg
 *
cfg
;

222 
cfg
 = 
desc
->
chù_d©a
;

223 i‡(!
cfg
) {

224 
desc
->
chù_d©a
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

225 i‡(!
desc
->
chù_d©a
) {

226 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_cfg\n");

227 
	`BUG_ON
(1);

232 
	}
}

236 
	$öô_c›y_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
, 
node
)

238 
úq_pö_li°
 *
ﬁd_íåy
, *
hód
, *
èû
, *
íåy
;

240 
cfg
->
úq_2_pö
 = 
NULL
;

241 
ﬁd_íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

242 i‡(!
ﬁd_íåy
)

245 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

246 i‡(!
íåy
)

249 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

250 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

251 
hód
 = 
íåy
;

252 
èû
 = 
íåy
;

253 
ﬁd_íåy
 = old_íåy->
√xt
;

254 
ﬁd_íåy
) {

255 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

256 i‡(!
íåy
) {

257 
íåy
 = 
hód
;

258 
íåy
) {

259 
hód
 = 
íåy
->
√xt
;

260 
	`k‰ì
(
íåy
);

261 
íåy
 = 
hód
;

266 
íåy
->
≠ic
 = 
ﬁd_íåy
->apic;

267 
íåy
->
pö
 = 
ﬁd_íåy
->pin;

268 
èû
->
√xt
 = 
íåy
;

269 
èû
 = 
íåy
;

270 
ﬁd_íåy
 = old_íåy->
√xt
;

273 
èû
->
√xt
 = 
NULL
;

274 
cfg
->
úq_2_pö
 = 
hód
;

275 
	}
}

277 
	$‰ì_úq_2_pö
(
úq_cfg
 *
ﬁd_cfg
, úq_cfg *
cfg
)

279 
úq_pö_li°
 *
íåy
, *
√xt
;

281 i‡(
ﬁd_cfg
->
úq_2_pö
 =
cfg
->irq_2_pin)

284 
íåy
 = 
ﬁd_cfg
->
úq_2_pö
;

286 
íåy
) {

287 
√xt
 = 
íåy
->next;

288 
	`k‰ì
(
íåy
);

289 
íåy
 = 
√xt
;

291 
ﬁd_cfg
->
úq_2_pö
 = 
NULL
;

292 
	}
}

294 
	$¨ch_öô_c›y_chù_d©a
(
úq_desc
 *
ﬁd_desc
,

295 
úq_desc
 *
desc
, 
node
)

297 
úq_cfg
 *
cfg
;

298 
úq_cfg
 *
ﬁd_cfg
;

300 
cfg
 = 
	`gë_⁄e_‰ì_úq_cfg
(
node
);

302 i‡(!
cfg
)

305 
desc
->
chù_d©a
 = 
cfg
;

307 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

309 
	`mem˝y
(
cfg
, 
ﬁd_cfg
, (
úq_cfg
));

311 
	`öô_c›y_úq_2_pö
(
ﬁd_cfg
, 
cfg
, 
node
);

312 
	}
}

314 
	$‰ì_úq_cfg
(
úq_cfg
 *
ﬁd_cfg
)

316 
	`k‰ì
(
ﬁd_cfg
);

317 
	}
}

319 
	$¨ch_‰ì_chù_d©a
(
úq_desc
 *
ﬁd_desc
, úq_des¯*
desc
)

321 
úq_cfg
 *
ﬁd_cfg
, *
cfg
;

323 
ﬁd_cfg
 = 
ﬁd_desc
->
chù_d©a
;

324 
cfg
 = 
desc
->
chù_d©a
;

326 i‡(
ﬁd_cfg
 =
cfg
)

329 i‡(
ﬁd_cfg
) {

330 
	`‰ì_úq_2_pö
(
ﬁd_cfg
, 
cfg
);

331 
	`‰ì_úq_cfg
(
ﬁd_cfg
);

332 
ﬁd_desc
->
chù_d©a
 = 
NULL
;

334 
	}
}

338 
úq_cfg
 *
	$úq_cfg
(
úq
)

340  
úq
 < 
ƒ_úqs
 ? 
úq_cfgx
 + irq : 
NULL
;

341 
	}
}

345 
	sio_≠ic
 {

346 
	mödex
;

347 
	munu£d
[3];

348 
	md©a
;

349 
	munu£d2
[11];

350 
	meoi
;

353 
__©åibuã_c⁄°__
 
io_≠ic
 
__iomem
 *
	$io_≠ic_ba£
(
idx
)

355  (
__iomem
 *Ë
	`__fix_to_vút
(
FIX_IO_APIC_BASE_0
 + 
idx
)

356 + (
mp_iﬂpics
[
idx
].
≠iˇddr
 & ~
PAGE_MASK
);

357 
	}
}

359 
ölöe
 
	$io_≠ic_eoi
(
≠ic
, 
ve˘‹
)

361 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

362 
	`wrôñ
(
ve˘‹
, &
io_≠ic
->
eoi
);

363 
	}
}

365 
ölöe
 
	$io_≠ic_ªad
(
≠ic
, 
ªg
)

367 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

368 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

369  
	`ªadl
(&
io_≠ic
->
d©a
);

370 
	}
}

372 
ölöe
 
	$io_≠ic_wrôe
(
≠ic
, 
ªg
, 
vÆue
)

374 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

375 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

376 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

377 
	}
}

385 
ölöe
 
	$io_≠ic_modify
(
≠ic
, 
ªg
, 
vÆue
)

387 
io_≠ic
 
__iomem
 *io_≠i¯
	`io_≠ic_ba£
(
≠ic
);

389 i‡(
sis_≠ic_bug
)

390 
	`wrôñ
(
ªg
, &
io_≠ic
->
ödex
);

391 
	`wrôñ
(
vÆue
, &
io_≠ic
->
d©a
);

392 
	}
}

394 
boﬁ
 
	$io_≠ic_Àvñ_ack_≥ndög
(
úq_cfg
 *
cfg
)

396 
úq_pö_li°
 *
íåy
;

397 
Êags
;

399 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

400 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

401 
ªg
;

402 
pö
;

404 
pö
 = 
íåy
->pin;

405 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
*2);

407 i‡(
ªg
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

408 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

409  
åue
;

412 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

414  
Ál£
;

415 
	}
}

417 
	uíåy_uni⁄
 {

418 °ru˘ { 
u32
 
	mw1
, 
	mw2
; };

419 
IO_APIC_rouã_íåy
 
	míåy
;

422 
IO_APIC_rouã_íåy
 
	$iﬂpic_ªad_íåy
(
≠ic
, 
pö
)

424 
íåy_uni⁄
 
eu
;

425 
Êags
;

426 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

427 
eu
.
w1
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 2 * 
pö
);

428 
eu
.
w2
 = 
	`io_≠ic_ªad
(
≠ic
, 0x11 + 2 * 
pö
);

429 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

430  
eu
.
íåy
;

431 
	}
}

440 
	$__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

442 
íåy_uni⁄
 
eu
 = {{0, 0}};

444 
eu
.
íåy
 = 
e
;

445 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

446 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

447 
	}
}

449 
	$iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
IO_APIC_rouã_íåy
 
e
)

451 
Êags
;

452 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

453 
	`__iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
e
);

454 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

455 
	}
}

462 
	$iﬂpic_mask_íåy
(
≠ic
, 
pö
)

464 
Êags
;

465 
íåy_uni⁄
 
eu
 = { .
íåy
.
mask
 = 1 };

467 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

468 
	`io_≠ic_wrôe
(
≠ic
, 0x10 + 2*
pö
, 
eu
.
w1
);

469 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 2*
pö
, 
eu
.
w2
);

470 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

471 
	}
}

479 
	$add_pö_to_úq_node_n›™ic
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

481 
úq_pö_li°
 **
œ°
, *
íåy
;

484 
œ°
 = &
cfg
->
úq_2_pö
;

485 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

486 i‡(
íåy
->
≠ic
 =≠i¯&&É¡ry->
pö
 ==Öin)

488 
œ°
 = &
íåy
->
√xt
;

491 
íåy
 = 
	`gë_⁄e_‰ì_úq_2_pö
(
node
);

492 i‡(!
íåy
) {

493 
	`¥ötk
(
KERN_ERR
 "canÇotálloc irq_pin_list (%d,%d,%d)\n",

494 
node
, 
≠ic
, 
pö
);

495  -
ENOMEM
;

497 
íåy
->
≠ic
 =ápic;

498 
íåy
->
pö
 =Öin;

500 *
œ°
 = 
íåy
;

502 
	}
}

504 
	$add_pö_to_úq_node
(
úq_cfg
 *
cfg
, 
node
, 
≠ic
, 
pö
)

506 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
≠ic
, 
pö
))

507 
	`∑nic
("IO-APIC: failedÅoádd irq-pin. CanÇotÖroceed\n");

508 
	}
}

513 
__öô
 
	$ª∂a˚_pö_©_úq_node
(
úq_cfg
 *
cfg
, 
node
,

514 
ﬁd≠ic
, 
ﬁdpö
,

515 
√w≠ic
, 
√wpö
)

517 
úq_pö_li°
 *
íåy
;

519 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

520 i‡(
íåy
->
≠ic
 =
ﬁd≠ic
 &&É¡ry->
pö
 =
ﬁdpö
) {

521 
íåy
->
≠ic
 = 
√w≠ic
;

522 
íåy
->
pö
 = 
√wpö
;

529 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
√w≠ic
, 
√wpö
);

530 
	}
}

532 
__io_≠ic_modify_úq
(
úq_pö_li°
 *
íåy
,

533 
mask_™d
, 
mask_‹
,

534 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

536 
ªg
, 
pö
;

538 
pö
 = 
íåy
->pin;

539 
ªg
 = 
	`io_≠ic_ªad
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2);

540 
ªg
 &
mask_™d
;

541 
ªg
 |
mask_‹
;

542 
	`io_≠ic_modify
(
íåy
->
≠ic
, 0x10 + 
pö
 * 2, 
ªg
);

543 i‡(
föÆ
)

544 
	`föÆ
(
íåy
);

545 
	}
}

547 
io_≠ic_modify_úq
(
úq_cfg
 *
cfg
,

548 
mask_™d
, 
mask_‹
,

549 (*
föÆ
)(
úq_pö_li°
 *
íåy
))

551 
úq_pö_li°
 *
íåy
;

553 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

554 
	`__io_≠ic_modify_úq
(
íåy
, 
mask_™d
, 
mask_‹
, 
föÆ
);

555 
	}
}

557 
	$__mask_™d_edge_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

559 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_LEVEL_TRIGGER
,

560 
IO_APIC_REDIR_MASKED
, 
NULL
);

561 
	}
}

563 
	$__unmask_™d_Àvñ_IO_APIC_úq
(
úq_pö_li°
 *
íåy
)

565 
	`__io_≠ic_modify_úq
(
íåy
, ~
IO_APIC_REDIR_MASKED
,

566 
IO_APIC_REDIR_LEVEL_TRIGGER
, 
NULL
);

567 
	}
}

569 
	$__unmask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

571 
	`io_≠ic_modify_úq
(
cfg
, ~
IO_APIC_REDIR_MASKED
, 0, 
NULL
);

572 
	}
}

574 
	$io_≠ic_sync
(
úq_pö_li°
 *
íåy
)

580 
io_≠ic
 
__iomem
 *io_apic;

581 
io_≠ic
 = 
	`io_≠ic_ba£
(
íåy
->
≠ic
);

582 
	`ªadl
(&
io_≠ic
->
d©a
);

583 
	}
}

585 
	$__mask_IO_APIC_úq
(
úq_cfg
 *
cfg
)

587 
	`io_≠ic_modify_úq
(
cfg
, ~0, 
IO_APIC_REDIR_MASKED
, &
io_≠ic_sync
);

588 
	}
}

590 
	$mask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

592 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

593 
Êags
;

595 
	`BUG_ON
(!
cfg
);

597 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

598 
	`__mask_IO_APIC_úq
(
cfg
);

599 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

600 
	}
}

602 
	$unmask_IO_APIC_úq_desc
(
úq_desc
 *
desc
)

604 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

605 
Êags
;

607 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

608 
	`__unmask_IO_APIC_úq
(
cfg
);

609 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

610 
	}
}

612 
	$mask_IO_APIC_úq
(
úq
)

614 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

616 
	`mask_IO_APIC_úq_desc
(
desc
);

617 
	}
}

618 
	$unmask_IO_APIC_úq
(
úq
)

620 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

622 
	`unmask_IO_APIC_úq_desc
(
desc
);

623 
	}
}

625 
	$˛ór_IO_APIC_pö
(
≠ic
, 
pö
)

627 
IO_APIC_rouã_íåy
 
íåy
;

630 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

631 i‡(
íåy
.
dñivîy_mode
 =
de°_SMI
)

636 
	`iﬂpic_mask_íåy
(
≠ic
, 
pö
);

637 
	}
}

639 
	$˛ór_IO_APIC
 ()

641 
≠ic
, 
pö
;

643 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

644 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

645 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

646 
	}
}

648 #ifde‡
CONFIG_X86_32


654 
	#MAX_PIRQS
 8

	)

655 
	gpúq_íåõs
[
MAX_PIRQS
] = {

656 [0 ... 
MAX_PIRQS
 - 1] = -1

659 
__öô
 
	$iﬂpic_púq_£tup
(*
°r
)

661 
i
, 
max
;

662 
öts
[
MAX_PIRQS
+1];

664 
	`gë_›ti⁄s
(
°r
, 
	`ARRAY_SIZE
(
öts
), ints);

666 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


668 
max
 = 
MAX_PIRQS
;

669 i‡(
öts
[0] < 
MAX_PIRQS
)

670 
max
 = 
öts
[0];

672 
i
 = 0; i < 
max
; i++) {

673 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


674 "... PIRQ%d -> IRQ %d\n", 
i
, 
öts
[i+1]);

678 
púq_íåõs
[
MAX_PIRQS
-
i
-1] = 
öts
[i+1];

681 
	}
}

683 
__£tup
("púq=", 
iﬂpic_púq_£tup
);

686 
IO_APIC_rouã_íåy
 **
	$Æloc_iﬂpic_íåõs
()

688 
≠ic
;

689 
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
;

691 
iﬂpic_íåõs
 = 
	`kzÆloc
((*iﬂpic_íåõsË* 
ƒ_iﬂpics
,

692 
GFP_ATOMIC
);

693 i‡(!
iﬂpic_íåõs
)

696 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

697 
iﬂpic_íåõs
[
≠ic
] =

698 
	`kzÆloc
((
IO_APIC_rouã_íåy
) *

699 
ƒ_iﬂpic_ªgi°îs
[
≠ic
], 
GFP_ATOMIC
);

700 i‡(!
iﬂpic_íåõs
[
≠ic
])

701 
nomem
;

704  
iﬂpic_íåõs
;

706 
nomem
:

707 --
≠ic
 >= 0)

708 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

709 
	`k‰ì
(
iﬂpic_íåõs
);

712 
	}
}

717 
	$ßve_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

719 
≠ic
, 
pö
;

721 i‡(!
iﬂpic_íåõs
)

722  -
ENOMEM
;

724 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

725 i‡(!
iﬂpic_íåõs
[
≠ic
])

726  -
ENOMEM
;

728 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

729 
iﬂpic_íåõs
[
≠ic
][
pö
] =

730 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

734 
	}
}

739 
	$mask_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

741 
≠ic
, 
pö
;

743 i‡(!
iﬂpic_íåõs
)

746 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

747 i‡(!
iﬂpic_íåõs
[
≠ic
])

750 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

751 
IO_APIC_rouã_íåy
 
íåy
;

753 
íåy
 = 
iﬂpic_íåõs
[
≠ic
][
pö
];

754 i‡(!
íåy
.
mask
) {

755 
íåy
.
mask
 = 1;

756 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy
);

760 
	}
}

765 
	$ª°‹e_IO_APIC_£tup
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

767 
≠ic
, 
pö
;

769 i‡(!
iﬂpic_íåõs
)

770  -
ENOMEM
;

772 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

773 i‡(!
iﬂpic_íåõs
[
≠ic
])

774  -
ENOMEM
;

776 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++)

777 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
,

778 
iﬂpic_íåõs
[
≠ic
][
pö
]);

781 
	}
}

783 
	$‰ì_iﬂpic_íåõs
(
IO_APIC_rouã_íåy
 **
iﬂpic_íåõs
)

785 
≠ic
;

787 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

788 
	`k‰ì
(
iﬂpic_íåõs
[
≠ic
]);

790 
	`k‰ì
(
iﬂpic_íåõs
);

791 
	}
}

796 
	$föd_úq_íåy
(
≠ic
, 
pö
, 
ty≥
)

798 
i
;

800 
i
 = 0; i < 
mp_úq_íåõs
; i++)

801 i‡(
mp_úqs
[
i
].
úqty≥
 =
ty≥
 &&

802 (
mp_úqs
[
i
].
d°≠ic
 =
mp_iﬂpics
[
≠ic
].
≠icid
 ||

803 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
) &&

804 
mp_úqs
[
i
].
d°úq
 =
pö
)

805  
i
;

808 
	}
}

813 
__öô
 
	$föd_iß_úq_pö
(
úq
, 
ty≥
)

815 
i
;

817 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

818 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

820 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

821 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

822 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

824  
mp_úqs
[
i
].
d°úq
;

827 
	}
}

829 
__öô
 
	$föd_iß_úq_≠ic
(
úq
, 
ty≥
)

831 
i
;

833 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

834 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

836 i‡(
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

837 (
mp_úqs
[
i
].
úqty≥
 =
ty≥
) &&

838 (
mp_úqs
[
i
].
§cbusúq
 =
úq
))

841 i‡(
i
 < 
mp_úq_íåõs
) {

842 
≠ic
;

843 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

844 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
)

845  
≠ic
;

850 
	}
}

852 #i‡
deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

856 
	$EISA_ELCR
(
úq
)

858 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

859 
p‹t
 = 0x4d0 + (
úq
 >> 3);

860  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

862 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


863 "Brokí MPèbÀÑï‹t†ISA irq %d\n", 
úq
);

865 
	}
}

872 
	#deÁu…_ISA_åiggî
(
idx
Ë(0)

	)

873 
	#deÁu…_ISA_pﬁ¨ôy
(
idx
Ë(0)

	)

880 
	#deÁu…_EISA_åiggî
(
idx
Ë(
	`EISA_ELCR
(
mp_úqs
[idx].
§cbusúq
))

	)

881 
	#deÁu…_EISA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

886 
	#deÁu…_PCI_åiggî
(
idx
Ë(1)

	)

887 
	#deÁu…_PCI_pﬁ¨ôy
(
idx
Ë(1)

	)

892 
	#deÁu…_MCA_åiggî
(
idx
Ë(1)

	)

893 
	#deÁu…_MCA_pﬁ¨ôy
(
idx
Ë
	`deÁu…_ISA_pﬁ¨ôy
(idx)

	)

895 
	$MPBIOS_pﬁ¨ôy
(
idx
)

897 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

898 
pﬁ¨ôy
;

903 
mp_úqs
[
idx
].
úqÊag
 & 3)

906 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

907 
pﬁ¨ôy
 = 
	`deÁu…_ISA_pﬁ¨ôy
(
idx
);

909 
pﬁ¨ôy
 = 
	`deÁu…_PCI_pﬁ¨ôy
(
idx
);

913 
pﬁ¨ôy
 = 0;

918 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

919 
pﬁ¨ôy
 = 1;

924 
pﬁ¨ôy
 = 1;

929 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

930 
pﬁ¨ôy
 = 1;

934  
pﬁ¨ôy
;

935 
	}
}

937 
	$MPBIOS_åiggî
(
idx
)

939 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

940 
åiggî
;

945 (
mp_úqs
[
idx
].
úqÊag
>>2) & 3)

948 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
))

949 
åiggî
 = 
	`deÁu…_ISA_åiggî
(
idx
);

951 
åiggî
 = 
	`deÁu…_PCI_åiggî
(
idx
);

952 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

953 
mp_bus_id_to_ty≥
[
bus
]) {

954 
MP_BUS_ISA
:

959 
MP_BUS_EISA
:

961 
åiggî
 = 
	`deÁu…_EISA_åiggî
(
idx
);

964 
MP_BUS_PCI
:

969 
MP_BUS_MCA
:

971 
åiggî
 = 
	`deÁu…_MCA_åiggî
(
idx
);

976 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

977 
åiggî
 = 1;

985 
åiggî
 = 0;

990 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

991 
åiggî
 = 1;

996 
åiggî
 = 1;

1001 
	`¥ötk
(
KERN_WARNING
 "broken BIOS!!\n");

1002 
åiggî
 = 0;

1006  
åiggî
;

1007 
	}
}

1009 
ölöe
 
	$úq_pﬁ¨ôy
(
idx
)

1011  
	`MPBIOS_pﬁ¨ôy
(
idx
);

1012 
	}
}

1014 
ölöe
 
	$úq_åiggî
(
idx
)

1016  
	`MPBIOS_åiggî
(
idx
);

1017 
	}
}

1019 
	$pö_2_úq
(
idx
, 
≠ic
, 
pö
)

1021 
úq
;

1022 
bus
 = 
mp_úqs
[
idx
].
§cbus
;

1027 i‡(
mp_úqs
[
idx
].
d°úq
 !
pö
)

1028 
	`¥ötk
(
KERN_ERR
 "broken BIOS or MPTABLEÖarser,áyiee!!\n");

1030 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1031 
úq
 = 
mp_úqs
[
idx
].
§cbusúq
;

1033 
u32
 
gsi
 = 
mp_gsi_routög
[
≠ic
].
gsi_ba£
 + 
pö
;

1035 i‡(
gsi
 >
NR_IRQS_LEGACY
)

1036 
úq
 = 
gsi
;

1038 
úq
 = 
gsi_t›
 + 
gsi
;

1041 #ifde‡
CONFIG_X86_32


1045 i‡((
pö
 >= 16) && (pin <= 23)) {

1046 i‡(
púq_íåõs
[
pö
-16] != -1) {

1047 i‡(!
púq_íåõs
[
pö
-16]) {

1048 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1049 "dißblög PIRQ%d\n", 
pö
-16);

1051 
úq
 = 
púq_íåõs
[
pö
-16];

1052 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG


1054 
pö
-16, 
úq
);

1060  
úq
;

1061 
	}
}

1067 
	$IO_APIC_gë_PCI_úq_ve˘‹
(
bus
, 
¶Ÿ
, 
pö
,

1068 
io_≠ic_úq_©å
 *
úq_©å
)

1070 
≠ic
, 
i
, 
be°_guess
 = -1;

1072 
	`≠ic_¥ötk
(
APIC_DEBUG
,

1074 
bus
, 
¶Ÿ
, 
pö
);

1075 i‡(
	`ã°_bô
(
bus
, 
mp_bus_nŸ_pci
)) {

1076 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1077 "PCI BIOSÖas£dÇ⁄exi°íàPCI bu†%d!\n", 
bus
);

1080 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

1081 
lbus
 = 
mp_úqs
[
i
].
§cbus
;

1083 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++)

1084 i‡(
mp_iﬂpics
[
≠ic
].
≠icid
 =
mp_úqs
[
i
].
d°≠ic
 ||

1085 
mp_úqs
[
i
].
d°≠ic
 =
MP_APIC_ALL
)

1088 i‡(!
	`ã°_bô
(
lbus
, 
mp_bus_nŸ_pci
) &&

1089 !
mp_úqs
[
i
].
úqty≥
 &&

1090 (
bus
 =
lbus
) &&

1091 (
¶Ÿ
 =((
mp_úqs
[
i
].
§cbusúq
 >> 2) & 0x1f))) {

1092 
úq
 = 
	`pö_2_úq
(
i
, 
≠ic
, 
mp_úqs
[i].
d°úq
);

1094 i‡(!(
≠ic
 || 
	`IO_APIC_IRQ
(
úq
)))

1097 i‡(
pö
 =(
mp_úqs
[
i
].
§cbusúq
 & 3)) {

1098 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1099 
mp_úqs
[
i
].
d°úq
,

1100 
	`úq_åiggî
(
i
),

1101 
	`úq_pﬁ¨ôy
(
i
));

1102  
úq
;

1108 i‡(
be°_guess
 < 0) {

1109 
	`£t_io_≠ic_úq_©å
(
úq_©å
, 
≠ic
,

1110 
mp_úqs
[
i
].
d°úq
,

1111 
	`úq_åiggî
(
i
),

1112 
	`úq_pﬁ¨ôy
(
i
));

1113 
be°_guess
 = 
úq
;

1117  
be°_guess
;

1118 
	}
}

1119 
EXPORT_SYMBOL
(
IO_APIC_gë_PCI_úq_ve˘‹
);

1121 
	$lock_ve˘‹_lock
()

1126 
	`øw_•ö_lock
(&
ve˘‹_lock
);

1127 
	}
}

1129 
	$u∆ock_ve˘‹_lock
()

1131 
	`øw_•ö_u∆ock
(&
ve˘‹_lock
);

1132 
	}
}

1135 
	$__assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1148 
cuºít_ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
 + 
VECTOR_OFFSET_START
;

1149 
cuºít_off£t
 = 
VECTOR_OFFSET_START
 % 8;

1150 
ﬁd_ve˘‹
;

1151 
˝u
, 
îr
;

1152 
˝umask_v¨_t
 
tmp_mask
;

1154 i‡(
cfg
->
move_ö_¥ogªss
)

1155  -
EBUSY
;

1157 i‡(!
	`Æloc_˝umask_v¨
(&
tmp_mask
, 
GFP_ATOMIC
))

1158  -
ENOMEM
;

1160 
ﬁd_ve˘‹
 = 
cfg
->
ve˘‹
;

1161 i‡(
ﬁd_ve˘‹
) {

1162 
	`˝umask_™d
(
tmp_mask
, 
mask
, 
˝u_⁄löe_mask
);

1163 
	`˝umask_™d
(
tmp_mask
, 
cfg
->
domaö
,Åmp_mask);

1164 i‡(!
	`˝umask_em±y
(
tmp_mask
)) {

1165 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1171 
îr
 = -
ENOSPC
;

1172 
	`f‹_óch_˝u_™d
(
˝u
, 
mask
, 
˝u_⁄löe_mask
) {

1173 
√w_˝u
;

1174 
ve˘‹
, 
off£t
;

1176 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(
˝u
, 
tmp_mask
);

1178 
ve˘‹
 = 
cuºít_ve˘‹
;

1179 
off£t
 = 
cuºít_off£t
;

1180 
√xt
:

1181 
ve˘‹
 += 8;

1182 i‡(
ve˘‹
 >
fú°_sy°em_ve˘‹
) {

1184 
off£t
 = (offset + 1) % 8;

1185 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
 + 
off£t
;

1187 i‡(
	`u∆ikñy
(
cuºít_ve˘‹
 =
ve˘‹
))

1190 i‡(
	`ã°_bô
(
ve˘‹
, 
u£d_ve˘‹s
))

1191 
√xt
;

1193 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1194 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] != -1)

1195 
√xt
;

1197 
cuºít_ve˘‹
 = 
ve˘‹
;

1198 
cuºít_off£t
 = 
off£t
;

1199 i‡(
ﬁd_ve˘‹
) {

1200 
cfg
->
move_ö_¥ogªss
 = 1;

1201 
	`˝umask_c›y
(
cfg
->
ﬁd_domaö
, cfg->
domaö
);

1203 
	`f‹_óch_˝u_™d
(
√w_˝u
, 
tmp_mask
, 
˝u_⁄löe_mask
)

1204 
	`≥r_˝u
(
ve˘‹_úq
, 
√w_˝u
)[
ve˘‹
] = 
úq
;

1205 
cfg
->
ve˘‹
 = vector;

1206 
	`˝umask_c›y
(
cfg
->
domaö
, 
tmp_mask
);

1207 
îr
 = 0;

1210 
	`‰ì_˝umask_v¨
(
tmp_mask
);

1211  
îr
;

1212 
	}
}

1214 
	$assign_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
, c⁄° 
˝umask
 *
mask
)

1216 
îr
;

1217 
Êags
;

1219 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

1220 
îr
 = 
	`__assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
);

1221 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

1222  
îr
;

1223 
	}
}

1225 
	$__˛ór_úq_ve˘‹
(
úq
, 
úq_cfg
 *
cfg
)

1227 
˝u
, 
ve˘‹
;

1229 
	`BUG_ON
(!
cfg
->
ve˘‹
);

1231 
ve˘‹
 = 
cfg
->vector;

1232 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
domaö
, 
˝u_⁄löe_mask
)

1233 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1235 
cfg
->
ve˘‹
 = 0;

1236 
	`˝umask_˛ór
(
cfg
->
domaö
);

1238 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

1240 
	`f‹_óch_˝u_™d
(
˝u
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
) {

1241 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
;

1242 
ve˘‹
++) {

1243 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] !
úq
)

1245 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1249 
cfg
->
move_ö_¥ogªss
 = 0;

1250 
	}
}

1252 
	$__£tup_ve˘‹_úq
(
˝u
)

1255 
úq
, 
ve˘‹
;

1256 
úq_cfg
 *
cfg
;

1257 
úq_desc
 *
desc
;

1264 
	`øw_•ö_lock
(&
ve˘‹_lock
);

1266 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1267 
cfg
 = 
desc
->
chù_d©a
;

1273 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
 && !
	`IO_APIC_IRQ
(irq))

1274 
	`˝umask_£t_˝u
(
˝u
, 
cfg
->
domaö
);

1276 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1278 
ve˘‹
 = 
cfg
->vector;

1279 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = 
úq
;

1282 
ve˘‹
 = 0; ve˘‹ < 
NR_VECTORS
; ++vector) {

1283 
úq
 = 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
];

1284 i‡(
úq
 < 0)

1287 
cfg
 = 
	`úq_cfg
(
úq
);

1288 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
cfg
->
domaö
))

1289 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] = -1;

1291 
	`øw_•ö_u∆ock
(&
ve˘‹_lock
);

1292 
	}
}

1294 
úq_chù
 
	giﬂpic_chù
;

1295 
úq_chù
 
	gú_iﬂpic_chù
;

1297 
	#IOAPIC_AUTO
 -1

	)

1298 
	#IOAPIC_EDGE
 0

	)

1299 
	#IOAPIC_LEVEL
 1

	)

1301 #ifde‡
CONFIG_X86_32


1302 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1304 
≠ic
, 
idx
, 
pö
;

1306 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1307 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1308 
idx
 = 
	`föd_úq_íåy
(
≠ic
, 
pö
, 
mp_INT
);

1309 i‡((
idx
 !-1Ë&& (
úq
 =
	`pö_2_úq
(idx, 
≠ic
, 
pö
)))

1310  
	`úq_åiggî
(
idx
);

1317 
	}
}

1319 
ölöe
 
	$IO_APIC_úq_åiggî
(
úq
)

1322 
	}
}

1325 
	$iﬂpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
, 
åiggî
)

1328 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1329 
åiggî
 =
IOAPIC_LEVEL
)

1330 
desc
->
°©us
 |
IRQ_LEVEL
;

1332 
desc
->
°©us
 &~
IRQ_LEVEL
;

1334 i‡(
	`úq_ªm≠≥d
(
úq
)) {

1335 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

1336 i‡(
åiggî
)

1337 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1338 
h™dÀ_Á°eoi_úq
,

1341 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_iﬂpic_chù
,

1342 
h™dÀ_edge_úq
, "edge");

1346 i‡((
åiggî
 =
IOAPIC_AUTO
 && 
	`IO_APIC_úq_åiggî
(
úq
)) ||

1347 
åiggî
 =
IOAPIC_LEVEL
)

1348 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1349 
h™dÀ_Á°eoi_úq
,

1352 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
iﬂpic_chù
,

1353 
h™dÀ_edge_úq
, "edge");

1354 
	}
}

1356 
	$£tup_iﬂpic_íåy
(
≠ic_id
, 
úq
,

1357 
IO_APIC_rouã_íåy
 *
íåy
,

1358 
de°ö©i⁄
, 
åiggî
,

1359 
pﬁ¨ôy
, 
ve˘‹
, 
pö
)

1364 
	`mem£t
(
íåy
,0,(*entry));

1366 i‡(
öå_ªm≠pög_íabÀd
) {

1367 
öãl_iommu
 *
iommu
 = 
	`m≠_iﬂpic_to_ú
(
≠ic_id
);

1368 
úã
 irte;

1369 
IR_IO_APIC_rouã_íåy
 *
ú_íåy
 =

1370 (
IR_IO_APIC_rouã_íåy
 *Ë
íåy
;

1371 
ödex
;

1373 i‡(!
iommu
)

1374 
	`∑nic
("Nÿm≠pög iommu f‹ iﬂpi¯%d\n", 
≠ic_id
);

1376 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

1377 i‡(
ödex
 < 0)

1378 
	`∑nic
("FaûedÅÿÆloˇã IRTE f‹ iﬂpi¯%d\n", 
≠ic_id
);

1380 
	`mem£t
(&
úã
, 0, (irte));

1382 
úã
.
¥e£¡
 = 1;

1383 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

1391 
úã
.
åiggî_mode
 = 0;

1392 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1393 
úã
.
ve˘‹
 = vector;

1394 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°ö©i⁄
);

1397 
	`£t_iﬂpic_sid
(&
úã
, 
≠ic_id
);

1399 
	`modify_úã
(
úq
, &
úã
);

1401 
ú_íåy
->
ödex2
 = (
ödex
 >> 15) & 0x1;

1402 
ú_íåy
->
zîo
 = 0;

1403 
ú_íåy
->
f‹m©
 = 1;

1404 
ú_íåy
->
ödex
 = (index & 0x7fff);

1409 
ú_íåy
->
ve˘‹
 = 
pö
;

1411 
íåy
->
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1412 
íåy
->
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1413 
íåy
->
de°
 = 
de°ö©i⁄
;

1414 
íåy
->
ve˘‹
 = vector;

1417 
íåy
->
mask
 = 0;

1418 
íåy
->
åiggî
 =Årigger;

1419 
íåy
->
pﬁ¨ôy
 =Öolarity;

1424 i‡(
åiggî
)

1425 
íåy
->
mask
 = 1;

1427 
	}
}

1429 
	$£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
úq_desc
 *
desc
,

1430 
åiggî
, 
pﬁ¨ôy
)

1432 
úq_cfg
 *
cfg
;

1433 
IO_APIC_rouã_íåy
 
íåy
;

1434 
de°
;

1436 i‡(!
	`IO_APIC_IRQ
(
úq
))

1439 
cfg
 = 
desc
->
chù_d©a
;

1446 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
 && 
	`˝umask_ã°_˝u
(0, 
cfg
->
domaö
))

1447 
≠ic
->
	`ve˘‹_Æloˇti⁄_domaö
(0, 
cfg
->
domaö
);

1449 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
()))

1452 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

1454 
	`≠ic_¥ötk
(
APIC_VERBOSE
,
KERN_DEBUG


1457 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
, 
pö
, 
cfg
->
ve˘‹
,

1458 
úq
, 
åiggî
, 
pﬁ¨ôy
);

1461 i‡(
	`£tup_iﬂpic_íåy
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
úq
, &
íåy
,

1462 
de°
, 
åiggî
, 
pﬁ¨ôy
, 
cfg
->
ve˘‹
, 
pö
)) {

1463 
	`¥ötk
("FailedÅo setup ioapicÉntry for ioapic %d,Öin %d\n",

1464 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1465 
	`__˛ór_úq_ve˘‹
(
úq
, 
cfg
);

1469 
	`iﬂpic_ªgi°î_öå
(
úq
, 
desc
, 
åiggî
);

1470 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1471 
Àgacy_pic
->
chù
->
	`mask
(
úq
);

1473 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1474 
	}
}

1477 
DECLARE_BITMAP
(
pö_¥ogømmed
, 
MP_MAX_IOAPIC_PIN
 + 1);

1478 } 
	gmp_iﬂpic_routög
[
MAX_IO_APICS
];

1480 
__öô
 
	$£tup_IO_APIC_úqs
()

1482 
≠ic_id
, 
pö
, 
idx
, 
úq
;

1483 
nŸc⁄
 = 0;

1484 
úq_desc
 *
desc
;

1485 
úq_cfg
 *
cfg
;

1486 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1488 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

1490 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++)

1491 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic_id
];Öin++) {

1492 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1493 i‡(
idx
 == -1) {

1494 i‡(!
nŸc⁄
) {

1495 
nŸc⁄
 = 1;

1496 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1497 
KERN_DEBUG
 " %d-%d",

1498 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1500 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " %d-%d",

1501 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1504 i‡(
nŸc⁄
) {

1505 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1507 
nŸc⁄
 = 0;

1510 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1512 i‡((
≠ic_id
 > 0Ë&& (
úq
 > 16))

1519 i‡(
≠ic
->
mu…i_timî_check
 &&

1520 
≠ic
->
	`mu…i_timî_check
(
≠ic_id
, 
úq
))

1523 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1524 i‡(!
desc
) {

1525 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1528 
cfg
 = 
desc
->
chù_d©a
;

1529 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1534 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1535 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1538 i‡(
nŸc⁄
)

1539 
	`≠ic_¥ötk
(
APIC_VERBOSE
,

1541 
	}
}

1548 
	$£tup_IO_APIC_úq_exåa
(
u32
 
gsi
)

1550 
≠ic_id
 = 0, 
pö
, 
idx
, 
úq
;

1551 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

1552 
úq_desc
 *
desc
;

1553 
úq_cfg
 *
cfg
;

1558 
≠ic_id
 = 
	`mp_föd_iﬂpic
(
gsi
);

1559 i‡(
≠ic_id
 < 0)

1562 
pö
 = 
	`mp_föd_iﬂpic_pö
(
≠ic_id
, 
gsi
);

1563 
idx
 = 
	`föd_úq_íåy
(
≠ic_id
, 
pö
, 
mp_INT
);

1564 i‡(
idx
 == -1)

1567 
úq
 = 
	`pö_2_úq
(
idx
, 
≠ic_id
, 
pö
);

1568 #ifde‡
CONFIG_SPARSE_IRQ


1569 
desc
 = 
	`úq_to_desc
(
úq
);

1570 i‡(
desc
)

1573 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

1574 i‡(!
desc
) {

1575 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
úq
);

1579 
cfg
 = 
desc
->
chù_d©a
;

1580 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic_id
, 
pö
);

1582 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
≠ic_id
].
pö_¥ogømmed
)) {

1583 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

1584 
mp_iﬂpics
[
≠ic_id
].
≠icid
, 
pö
);

1587 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
≠ic_id
].
pö_¥ogømmed
);

1589 
	`£tup_IO_APIC_úq
(
≠ic_id
, 
pö
, 
úq
, 
desc
,

1590 
	`úq_åiggî
(
idx
), 
	`úq_pﬁ¨ôy
(idx));

1591 
	}
}

1596 
__öô
 
	$£tup_timî_IRQ0_pö
(
≠ic_id
, 
pö
,

1597 
ve˘‹
)

1599 
IO_APIC_rouã_íåy
 
íåy
;

1601 i‡(
öå_ªm≠pög_íabÀd
)

1604 
	`mem£t
(&
íåy
, 0, (entry));

1610 
íåy
.
de°_mode
 = 
≠ic
->
úq_de°_mode
;

1611 
íåy
.
mask
 = 0;

1612 
íåy
.
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid
◊pic->
	`èrgë_˝us
());

1613 
íåy
.
dñivîy_mode
 = 
≠ic
->
úq_dñivîy_mode
;

1614 
íåy
.
pﬁ¨ôy
 = 0;

1615 
íåy
.
åiggî
 = 0;

1616 
íåy
.
ve˘‹
 = vector;

1622 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

1627 
	`iﬂpic_wrôe_íåy
(
≠ic_id
, 
pö
, 
íåy
);

1628 
	}
}

1631 
	$__≠icdebugöô
(Ë
	$¥öt_IO_APIC
()

1633 
≠ic
, 
i
;

1634 
IO_APIC_ªg_00
 
ªg_00
;

1635 
IO_APIC_ªg_01
 
ªg_01
;

1636 
IO_APIC_ªg_02
 
ªg_02
;

1637 
IO_APIC_ªg_03
 
ªg_03
;

1638 
Êags
;

1639 
úq_cfg
 *
cfg
;

1640 
úq_desc
 *
desc
;

1641 
úq
;

1643 
	`¥ötk
(
KERN_DEBUG
 "numbî o‡MP IRQ sour˚s: %d.\n", 
mp_úq_íåõs
);

1644 
i
 = 0; i < 
ƒ_iﬂpics
; i++)

1645 
	`¥ötk
(
KERN_DEBUG
 "number of IO-APIC #%dÑegisters: %d.\n",

1646 
mp_iﬂpics
[
i
].
≠icid
, 
ƒ_iﬂpic_ªgi°îs
[i]);

1652 
	`¥ötk
(
KERN_INFO
 "testingÅhe IO APIC.......................\n");

1654 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1656 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

1657 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 0);

1658 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 1);

1659 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x10)

1660 
ªg_02
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 2);

1661 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >= 0x20)

1662 
ªg_03
.
øw
 = 
	`io_≠ic_ªad
(
≠ic
, 3);

1663 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

1665 
	`¥ötk
("\n");

1666 
	`¥ötk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_iﬂpics
[
≠ic
].
≠icid
);

1667 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #00: %08X\n", 
ªg_00
.
øw
);

1668 
	`¥ötk
(
KERN_DEBUG
 "....... :Öhysiˇ»APIC id: %02X\n", 
ªg_00
.
bôs
.
ID
);

1669 
	`¥ötk
(
KERN_DEBUG
 "....... : Dñivîy Ty≥: %X\n", 
ªg_00
.
bôs
.
dñivîy_ty≥
);

1670 
	`¥ötk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
ªg_00
.
bôs
.
LTS
);

1672 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #01: %08X\n", *(*)&
ªg_01
);

1673 
	`¥ötk
(
KERN_DEBUG
 "....... : maxÑedúe˘i⁄É¡rõs: %04X\n", 
ªg_01
.
bôs
.
íåõs
);

1675 
	`¥ötk
(
KERN_DEBUG
 "....... : PRQ im∂emíãd: %X\n", 
ªg_01
.
bôs
.
PRQ
);

1676 
	`¥ötk
(
KERN_DEBUG
 "....... : IO APIC vîsi⁄: %04X\n", 
ªg_01
.
bôs
.
vîsi⁄
);

1683 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x10 && 
ªg_02
.
øw
 !=Ñeg_01.raw) {

1684 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #02: %08X\n", 
ªg_02
.
øw
);

1685 
	`¥ötk
(
KERN_DEBUG
 "....... :árbôøti⁄: %02X\n", 
ªg_02
.
bôs
.
¨bôøti⁄
);

1693 i‡(
ªg_01
.
bôs
.
vîsi⁄
 >0x20 && 
ªg_03
.
øw
 !
ªg_02
.raw &&

1694 
ªg_03
.
øw
 !
ªg_01
.raw) {

1695 
	`¥ötk
(
KERN_DEBUG
 "....Ñegi°î #03: %08X\n", 
ªg_03
.
øw
);

1696 
	`¥ötk
(
KERN_DEBUG
 "....... : BoŸ DT : %X\n", 
ªg_03
.
bôs
.
boŸ_DT
);

1699 
	`¥ötk
(
KERN_DEBUG
 ".... IRQÑedirectionÅable:\n");

1701 
	`¥ötk
(
KERN_DEBUG
 " NR Dst Mask Trig IRR Pol"

1704 
i
 = 0; i <
ªg_01
.
bôs
.
íåõs
; i++) {

1705 
IO_APIC_rouã_íåy
 
íåy
;

1707 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
i
);

1709 
	`¥ötk
(
KERN_DEBUG
 " %02x %03X ",

1710 
i
,

1711 
íåy
.
de°


1714 
	`¥ötk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1715 
íåy
.
mask
,

1716 
íåy
.
åiggî
,

1717 
íåy
.
úr
,

1718 
íåy
.
pﬁ¨ôy
,

1719 
íåy
.
dñivîy_°©us
,

1720 
íåy
.
de°_mode
,

1721 
íåy
.
dñivîy_mode
,

1722 
íåy
.
ve˘‹


1726 
	`¥ötk
(
KERN_DEBUG
 "IRQÅoÖin mappings:\n");

1727 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

1728 
úq_pö_li°
 *
íåy
;

1730 
cfg
 = 
desc
->
chù_d©a
;

1731 
íåy
 = 
cfg
->
úq_2_pö
;

1732 i‡(!
íåy
)

1734 
	`¥ötk
(
KERN_DEBUG
 "IRQ%d ", 
úq
);

1735 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
)

1736 
	`¥ötk
("-> %d:%d", 
íåy
->
≠ic
,É¡ry->
pö
);

1737 
	`¥ötk
("\n");

1740 
	`¥ötk
(
KERN_INFO
 ".................................... done.\n");

1743 
	}
}

1745 
	$__≠icdebugöô
(Ë
	$¥öt_APIC_fõld
(
ba£
)

1747 
i
;

1749 
	`¥ötk
(
KERN_DEBUG
);

1751 
i
 = 0; i < 8; i++)

1752 
	`¥ötk
(
KERN_CONT
 "%08x", 
	`≠ic_ªad
(
ba£
 + 
i
*0x10));

1754 
	`¥ötk
(
KERN_CONT
 "\n");

1755 
	}
}

1757 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APIC
(*
dummy
)

1759 
i
, 
v
, 
vî
, 
maxlvt
;

1760 
u64
 
i¸
;

1762 
	`¥ötk
(
KERN_DEBUG
 "printingÜocal APIC contents on CPU#%d/%d:\n",

1763 
	`smp_¥o˚ss‹_id
(), 
	`h¨d_smp_¥o˚ss‹_id
());

1764 
v
 = 
	`≠ic_ªad
(
APIC_ID
);

1765 
	`¥ötk
(
KERN_INFO
 "... APIC ID: %08x (%01x)\n", 
v
, 
	`ªad_≠ic_id
());

1766 
v
 = 
	`≠ic_ªad
(
APIC_LVR
);

1767 
	`¥ötk
(
KERN_INFO
 "... APIC VERSION: %08x\n", 
v
);

1768 
vî
 = 
	`GET_APIC_VERSION
(
v
);

1769 
maxlvt
 = 
	`œpic_gë_maxlvt
();

1771 
v
 = 
	`≠ic_ªad
(
APIC_TASKPRI
);

1772 
	`¥ötk
(
KERN_DEBUG
 "... APIC TASKPRI: %08x (%02x)\n", 
v
, v & 
APIC_TPRI_MASK
);

1774 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1775 i‡(!
	`APIC_XAPIC
(
vî
)) {

1776 
v
 = 
	`≠ic_ªad
(
APIC_ARBPRI
);

1777 
	`¥ötk
(
KERN_DEBUG
 "... APIC ARBPRI: %08x (%02x)\n", 
v
,

1778 
v
 & 
APIC_ARBPRI_MASK
);

1780 
v
 = 
	`≠ic_ªad
(
APIC_PROCPRI
);

1781 
	`¥ötk
(
KERN_DEBUG
 "... APIC PROCPRI: %08x\n", 
v
);

1788 i‡(!
	`APIC_INTEGRATED
(
vî
Ë|| 
maxlvt
 == 3) {

1789 
v
 = 
	`≠ic_ªad
(
APIC_RRR
);

1790 
	`¥ötk
(
KERN_DEBUG
 "... APIC RRR: %08x\n", 
v
);

1793 
v
 = 
	`≠ic_ªad
(
APIC_LDR
);

1794 
	`¥ötk
(
KERN_DEBUG
 "... APIC LDR: %08x\n", 
v
);

1795 i‡(!
	`x2≠ic_íabÀd
()) {

1796 
v
 = 
	`≠ic_ªad
(
APIC_DFR
);

1797 
	`¥ötk
(
KERN_DEBUG
 "... APIC DFR: %08x\n", 
v
);

1799 
v
 = 
	`≠ic_ªad
(
APIC_SPIV
);

1800 
	`¥ötk
(
KERN_DEBUG
 "... APIC SPIV: %08x\n", 
v
);

1802 
	`¥ötk
(
KERN_DEBUG
 "... APIC ISR field:\n");

1803 
	`¥öt_APIC_fõld
(
APIC_ISR
);

1804 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMR field:\n");

1805 
	`¥öt_APIC_fõld
(
APIC_TMR
);

1806 
	`¥ötk
(
KERN_DEBUG
 "... APIC IRR field:\n");

1807 
	`¥öt_APIC_fõld
(
APIC_IRR
);

1809 i‡(
	`APIC_INTEGRATED
(
vî
)) {

1810 i‡(
maxlvt
 > 3)

1811 
	`≠ic_wrôe
(
APIC_ESR
, 0);

1813 
v
 = 
	`≠ic_ªad
(
APIC_ESR
);

1814 
	`¥ötk
(
KERN_DEBUG
 "... APIC ESR: %08x\n", 
v
);

1817 
i¸
 = 
	`≠ic_i¸_ªad
();

1818 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR: %08x\n", (
u32
)
i¸
);

1819 
	`¥ötk
(
KERN_DEBUG
 "... APIC ICR2: %08x\n", (
u32
)(
i¸
 >> 32));

1821 
v
 = 
	`≠ic_ªad
(
APIC_LVTT
);

1822 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTT: %08x\n", 
v
);

1824 i‡(
maxlvt
 > 3) {

1825 
v
 = 
	`≠ic_ªad
(
APIC_LVTPC
);

1826 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTPC: %08x\n", 
v
);

1828 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

1829 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT0: %08x\n", 
v
);

1830 
v
 = 
	`≠ic_ªad
(
APIC_LVT1
);

1831 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVT1: %08x\n", 
v
);

1833 i‡(
maxlvt
 > 2) {

1834 
v
 = 
	`≠ic_ªad
(
APIC_LVTERR
);

1835 
	`¥ötk
(
KERN_DEBUG
 "... APIC LVTERR: %08x\n", 
v
);

1838 
v
 = 
	`≠ic_ªad
(
APIC_TMICT
);

1839 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMICT: %08x\n", 
v
);

1840 
v
 = 
	`≠ic_ªad
(
APIC_TMCCT
);

1841 
	`¥ötk
(
KERN_DEBUG
 "... APIC TMCCT: %08x\n", 
v
);

1842 
v
 = 
	`≠ic_ªad
(
APIC_TDCR
);

1843 
	`¥ötk
(
KERN_DEBUG
 "... APIC TDCR: %08x\n", 
v
);

1845 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_EXTAPIC
)) {

1846 
v
 = 
	`≠ic_ªad
(
APIC_EFEAT
);

1847 
maxlvt
 = (
v
 >> 16) & 0xff;

1848 
	`¥ötk
(
KERN_DEBUG
 "... APIC EFEAT: %08x\n", 
v
);

1849 
v
 = 
	`≠ic_ªad
(
APIC_ECTRL
);

1850 
	`¥ötk
(
KERN_DEBUG
 "... APIC ECTRL: %08x\n", 
v
);

1851 
i
 = 0; i < 
maxlvt
; i++) {

1852 
v
 = 
	`≠ic_ªad
(
	`APIC_EILVTn
(
i
));

1853 
	`¥ötk
(
KERN_DEBUG
 "... APIC EILVT%d: %08x\n", 
i
, 
v
);

1856 
	`¥ötk
("\n");

1857 
	}
}

1859 
	$__≠icdebugöô
(Ë
	$¥öt_loˇl_APICs
(
max˝u
)

1861 
˝u
;

1863 i‡(!
max˝u
)

1866 
	`¥ìm±_dißbÀ
();

1867 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1868 i‡(
˝u
 >
max˝u
)

1870 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
¥öt_loˇl_APIC
, 
NULL
, 1);

1872 
	`¥ìm±_íabÀ
();

1873 
	}
}

1875 
	$__≠icdebugöô
(Ë
	$¥öt_PIC
()

1877 
v
;

1878 
Êags
;

1880 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1883 
	`¥ötk
(
KERN_DEBUG
 "\nprinting PIC contents\n");

1885 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

1887 
v
 = 
	`öb
(0xa1) << 8 | inb(0x21);

1888 
	`¥ötk
(
KERN_DEBUG
 "... PIC IMR: %04x\n", 
v
);

1890 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1891 
	`¥ötk
(
KERN_DEBUG
 "... PIC IRR: %04x\n", 
v
);

1893 
	`outb
(0x0b,0xa0);

1894 
	`outb
(0x0b,0x20);

1895 
v
 = 
	`öb
(0xa0) << 8 | inb(0x20);

1896 
	`outb
(0x0a,0xa0);

1897 
	`outb
(0x0a,0x20);

1899 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

1901 
	`¥ötk
(
KERN_DEBUG
 "... PIC ISR: %04x\n", 
v
);

1903 
v
 = 
	`öb
(0x4d1) << 8 | inb(0x4d0);

1904 
	`¥ötk
(
KERN_DEBUG
 "... PIC ELCR: %04x\n", 
v
);

1905 
	}
}

1907 
__öôd©a
 
	gshow_œpic
 = 1;

1908 
__öô
 
	$£tup_show_œpic
(*
¨g
)

1910 
num
 = -1;

1912 i‡(
	`°rcmp
(
¨g
, "all") == 0) {

1913 
show_œpic
 = 
CONFIG_NR_CPUS
;

1915 
	`gë_›ti⁄
(&
¨g
, &
num
);

1916 i‡(
num
 >= 0)

1917 
show_œpic
 = 
num
;

1921 
	}
}

1922 
__£tup
("show_œpic=", 
£tup_show_œpic
);

1924 
	$__≠icdebugöô
(Ë
	$¥öt_ICs
()

1926 i‡(
≠ic_vîbosôy
 =
APIC_QUIET
)

1929 
	`¥öt_PIC
();

1932 i‡(!
˝u_has_≠ic
 && !
	`≠ic_‰om_smp_c⁄fig
())

1935 
	`¥öt_loˇl_APICs
(
show_œpic
);

1936 
	`¥öt_IO_APIC
();

1939 
	}
}

1941 
fs_öôˇŒ
(
¥öt_ICs
);

1945 °ru˘ { 
	mpö
, 
	m≠ic
; } 
	giﬂpic_i8259
 = { -1, -1 };

1947 
__öô
 
	$íabÀ_IO_APIC
()

1949 
i8259_≠ic
, 
i8259_pö
;

1950 
≠ic
;

1952 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

1955 
≠ic
 = 0;ápi¯< 
ƒ_iﬂpics
;ápic++) {

1956 
pö
;

1958 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
≠ic
];Öin++) {

1959 
IO_APIC_rouã_íåy
 
íåy
;

1960 
íåy
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

1965 i‡((
íåy
.
mask
 =0Ë&& (íåy.
dñivîy_mode
 =
de°_ExtINT
)) {

1966 
iﬂpic_i8259
.
≠ic
 =ápic;

1967 
iﬂpic_i8259
.
pö
 =Öin;

1968 
found_i8259
;

1972 
found_i8259
:

1978 
i8259_pö
 = 
	`föd_iß_úq_pö
(0, 
mp_ExtINT
);

1979 
i8259_≠ic
 = 
	`föd_iß_úq_≠ic
(0, 
mp_ExtINT
);

1981 i‡((
iﬂpic_i8259
.
pö
 =-1Ë&& (
i8259_pö
 >= 0)) {

1982 
	`¥ötk
(
KERN_WARNING
 "ExtINTÇot setup in hardware butÑeported by MPÅable\n");

1983 
iﬂpic_i8259
.
pö
 = 
i8259_pö
;

1984 
iﬂpic_i8259
.
≠ic
 = 
i8259_≠ic
;

1987 i‡(((
iﬂpic_i8259
.
≠ic
 !
i8259_≠ic
Ë|| (iﬂpic_i8259.
pö
 !
i8259_pö
)) &&

1988 (
i8259_pö
 >0Ë&& (
iﬂpic_i8259
.
pö
 >= 0))

1990 
	`¥ötk
(
KERN_WARNING
 "ExtINT in hardwareánd MPÅable differ\n");

1996 
	`˛ór_IO_APIC
();

1997 
	}
}

2002 
	$dißbÀ_IO_APIC
()

2007 
	`˛ór_IO_APIC
();

2009 i‡(!
Àgacy_pic
->
ƒ_Àgacy_úqs
)

2022 i‡(
iﬂpic_i8259
.
pö
 !-1 && !
öå_ªm≠pög_íabÀd
) {

2023 
IO_APIC_rouã_íåy
 
íåy
;

2025 
	`mem£t
(&
íåy
, 0, (entry));

2026 
íåy
.
mask
 = 0;

2027 
íåy
.
åiggî
 = 0;

2028 
íåy
.
úr
 = 0;

2029 
íåy
.
pﬁ¨ôy
 = 0;

2030 
íåy
.
dñivîy_°©us
 = 0;

2031 
íåy
.
de°_mode
 = 0;

2032 
íåy
.
dñivîy_mode
 = 
de°_ExtINT
;

2033 
íåy
.
ve˘‹
 = 0;

2034 
íåy
.
de°
 = 
	`ªad_≠ic_id
();

2039 
	`iﬂpic_wrôe_íåy
(
iﬂpic_i8259
.
≠ic
, iﬂpic_i8259.
pö
, 
íåy
);

2045 i‡(
˝u_has_≠ic
 || 
	`≠ic_‰om_smp_c⁄fig
())

2046 
	`disc⁄√˘_b•_APIC
(!
öå_ªm≠pög_íabÀd
 &&

2047 
iﬂpic_i8259
.
pö
 != -1);

2048 
	}
}

2050 #ifde‡
CONFIG_X86_32


2058 
__öô
 
	$£tup_iﬂpic_ids_‰om_mpc
()

2060 
IO_APIC_ªg_00
 
ªg_00
;

2061 
physid_mask_t
 
phys_id_¥e£¡_m≠
;

2062 
≠ic_id
;

2063 
i
;

2064 
ﬁd_id
;

2065 
Êags
;

2067 i‡(
a˝i_iﬂpic
)

2073 i‡(!(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
)

2074 || 
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

2080 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
phys_id_¥e£¡_m≠
);

2085 
≠ic_id
 = 0;ápic_id < 
ƒ_iﬂpics
;ápic_id++) {

2088 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2089 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2090 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2092 
ﬁd_id
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2094 i‡(
mp_iﬂpics
[
≠ic_id
].
≠icid
 >
	`gë_physiˇl_brﬂdˇ°
()) {

2095 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inÅhe MPCÅable!...\n",

2096 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2097 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2098 
ªg_00
.
bôs
.
ID
);

2099 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
ªg_00
.
bôs
.
ID
;

2107 i‡(
≠ic
->
	`check_≠icid_u£d
(&
phys_id_¥e£¡_m≠
,

2108 
mp_iﬂpics
[
≠ic_id
].
≠icid
)) {

2109 
	`¥ötk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d isálready used!...\n",

2110 
≠ic_id
, 
mp_iﬂpics
[≠ic_id].
≠icid
);

2111 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++)

2112 i‡(!
	`physid_is£t
(
i
, 
phys_id_¥e£¡_m≠
))

2114 i‡(
i
 >
	`gë_physiˇl_brﬂdˇ°
())

2115 
	`∑nic
("Max APIC IDÉxceeded!\n");

2116 
	`¥ötk
(
KERN_ERR
 "... fixing upÅo %d. (tell your hw vendor)\n",

2117 
i
);

2118 
	`physid_£t
(
i
, 
phys_id_¥e£¡_m≠
);

2119 
mp_iﬂpics
[
≠ic_id
].
≠icid
 = 
i
;

2121 
physid_mask_t
 
tmp
;

2122 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
mp_iﬂpics
[
≠ic_id
].
≠icid
, &
tmp
);

2123 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Setting %d inÅhe "

2125 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2126 
	`physids_‹
(
phys_id_¥e£¡_m≠
,Öhys_id_¥e£¡_m≠, 
tmp
);

2134 i‡(
ﬁd_id
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2135 
i
 = 0; i < 
mp_úq_íåõs
; i++)

2136 i‡(
mp_úqs
[
i
].
d°≠ic
 =
ﬁd_id
)

2137 
mp_úqs
[
i
].
d°≠ic


2138 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2144 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


2146 
mp_iﬂpics
[
≠ic_id
].
≠icid
);

2148 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
≠ic_id
].
≠icid
;

2149 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2150 
	`io_≠ic_wrôe
(
≠ic_id
, 0, 
ªg_00
.
øw
);

2151 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2156 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2157 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
≠ic_id
, 0);

2158 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2159 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
≠ic_id
].
≠icid
)

2160 
	`¥ötk
("couldÇot set ID!\n");

2162 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " ok.\n");

2164 
	}
}

2167 
no_timî_check
 
	g__öôd©a
;

2169 
__öô
 
	$nŸimîcheck
(*
s
)

2171 
no_timî_check
 = 1;

2173 
	}
}

2174 
__£tup
("no_timî_check", 
nŸimîcheck
);

2184 
__öô
 
	$timî_úq_w‹ks
()

2186 
t1
 = 
jiffõs
;

2187 
Êags
;

2189 i‡(
no_timî_check
)

2192 
	`loˇl_ßve_Êags
(
Êags
);

2193 
	`loˇl_úq_íabÀ
();

2195 
	`mdñay
((10 * 1000Ë/ 
HZ
);

2196 
	`loˇl_úq_ª°‹e
(
Êags
);

2207 i‡(
	`time_a·î
(
jiffõs
, 
t1
 + 4))

2210 
	}
}

2235 
	$°¨tup_iﬂpic_úq
(
úq
)

2237 
was_≥ndög
 = 0;

2238 
Êags
;

2239 
úq_cfg
 *
cfg
;

2241 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2242 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

2243 
Àgacy_pic
->
chù
->
	`mask
(
úq
);

2244 i‡(
Àgacy_pic
->
	`úq_≥ndög
(
úq
))

2245 
was_≥ndög
 = 1;

2247 
cfg
 = 
	`úq_cfg
(
úq
);

2248 
	`__unmask_IO_APIC_úq
(
cfg
);

2249 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2251  
was_≥ndög
;

2252 
	}
}

2254 
	$iﬂpic_ªåiggî_úq
(
úq
)

2257 
úq_cfg
 *
cfg
 = 
	`úq_cfg
(
úq
);

2258 
Êags
;

2260 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

2261 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
	`˝umask_fú°
(
cfg
->
domaö
)), cfg->
ve˘‹
);

2262 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

2265 
	}
}

2276 #ifde‡
CONFIG_SMP


2277 
	$£nd_˛ónup_ve˘‹
(
úq_cfg
 *
cfg
)

2279 
˝umask_v¨_t
 
˛ónup_mask
;

2281 i‡(
	`u∆ikñy
(!
	`Æloc_˝umask_v¨
(&
˛ónup_mask
, 
GFP_ATOMIC
))) {

2282 
i
;

2283 
	`f‹_óch_˝u_™d
(
i
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
)

2284 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
i
), 
IRQ_MOVE_CLEANUP_VECTOR
);

2286 
	`˝umask_™d
(
˛ónup_mask
, 
cfg
->
ﬁd_domaö
, 
˝u_⁄löe_mask
);

2287 
≠ic
->
	`£nd_IPI_mask
(
˛ónup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

2288 
	`‰ì_˝umask_v¨
(
˛ónup_mask
);

2290 
cfg
->
move_ö_¥ogªss
 = 0;

2291 
	}
}

2293 
	$__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
úq_cfg
 *
cfg
)

2295 
≠ic
, 
pö
;

2296 
úq_pö_li°
 *
íåy
;

2297 
u8
 
ve˘‹
 = 
cfg
->vector;

2299 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2300 
ªg
;

2302 
≠ic
 = 
íåy
->apic;

2303 
pö
 = 
íåy
->pin;

2308 i‡(!
	`úq_ªm≠≥d
(
úq
))

2309 
	`io_≠ic_wrôe
(
≠ic
, 0x11 + 
pö
*2, 
de°
);

2310 
ªg
 = 
	`io_≠ic_ªad
(
≠ic
, 0x10 + 
pö
*2);

2311 
ªg
 &~
IO_APIC_REDIR_VECTOR_MASK
;

2312 
ªg
 |
ve˘‹
;

2313 
	`io_≠ic_modify
(
≠ic
, 0x10 + 
pö
*2, 
ªg
);

2315 
	}
}

2323 
	$£t_desc_afföôy
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
,

2324 *
de°_id
)

2326 
úq_cfg
 *
cfg
;

2327 
úq
;

2329 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2332 
úq
 = 
desc
->irq;

2333 
cfg
 = 
desc
->
chù_d©a
;

2334 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2337 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2339 *
de°_id
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
desc
->
afföôy
, 
cfg
->
domaö
);

2341 
	}
}

2344 
	$£t_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2346 
úq_cfg
 *
cfg
;

2347 
Êags
;

2348 
de°
;

2349 
úq
;

2350 
ªt
 = -1;

2352 
úq
 = 
desc
->irq;

2353 
cfg
 = 
desc
->
chù_d©a
;

2355 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2356 
ªt
 = 
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
);

2357 i‡(!
ªt
) {

2359 
de°
 = 
	`SET_APIC_LOGICAL_ID
(dest);

2360 
	`__èrgë_IO_APIC_úq
(
úq
, 
de°
, 
cfg
);

2362 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2364  
ªt
;

2365 
	}
}

2368 
	$£t_iﬂpic_afföôy_úq
(
úq
, c⁄° 
˝umask
 *
mask
)

2370 
úq_desc
 *
desc
;

2372 
desc
 = 
	`úq_to_desc
(
úq
);

2374  
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2375 
	}
}

2377 #ifde‡
CONFIG_INTR_REMAP


2391 
	$migøã_iﬂpic_úq_desc
(
úq_desc
 *
desc
, c⁄° 
˝umask
 *
mask
)

2393 
úq_cfg
 *
cfg
;

2394 
úã
 irte;

2395 
de°
;

2396 
úq
;

2397 
ªt
 = -1;

2399 i‡(!
	`˝umask_öãr£˘s
(
mask
, 
˝u_⁄löe_mask
))

2400  
ªt
;

2402 
úq
 = 
desc
->irq;

2403 i‡(
	`gë_úã
(
úq
, &
úã
))

2404  
ªt
;

2406 
cfg
 = 
desc
->
chù_d©a
;

2407 i‡(
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
mask
))

2408  
ªt
;

2410 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
, 
mask
);

2412 
úã
.
ve˘‹
 = 
cfg
->vector;

2413 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

2418 
	`modify_úã
(
úq
, &
úã
);

2420 i‡(
cfg
->
move_ö_¥ogªss
)

2421 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2423 
	`˝umask_c›y
(
desc
->
afföôy
, 
mask
);

2426 
	}
}

2431 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2432 c⁄° 
˝umask
 *
mask
)

2434  
	`migøã_iﬂpic_úq_desc
(
desc
, 
mask
);

2435 
	}
}

2436 
	$£t_ú_iﬂpic_afföôy_úq
(
úq
,

2437 c⁄° 
˝umask
 *
mask
)

2439 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2441  
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

2442 
	}
}

2444 
ölöe
 
	$£t_ú_iﬂpic_afföôy_úq_desc
(
úq_desc
 *
desc
,

2445 c⁄° 
˝umask
 *
mask
)

2448 
	}
}

2451 
asmlökage
 
	$smp_úq_move_˛ónup_öãºu±
()

2453 
ve˘‹
, 
me
;

2455 
	`ack_APIC_úq
();

2456 
	`exô_idÀ
();

2457 
	`úq_íãr
();

2459 
me
 = 
	`smp_¥o˚ss‹_id
();

2460 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

2461 
úq
;

2462 
úr
;

2463 
úq_desc
 *
desc
;

2464 
úq_cfg
 *
cfg
;

2465 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

2467 i‡(
úq
 == -1)

2470 
desc
 = 
	`úq_to_desc
(
úq
);

2471 i‡(!
desc
)

2474 
cfg
 = 
	`úq_cfg
(
úq
);

2475 
	`øw_•ö_lock
(&
desc
->
lock
);

2481 i‡(
cfg
->
move_ö_¥ogªss
)

2482 
u∆ock
;

2484 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2485 
u∆ock
;

2487 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

2495 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

2496 
≠ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

2497 
u∆ock
;

2499 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] = -1;

2500 
u∆ock
:

2501 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

2504 
	`úq_exô
();

2505 
	}
}

2507 
	$__úq_com∂ëe_move
(
úq_desc
 **
des˝
, 
ve˘‹
)

2509 
úq_desc
 *
desc
 = *
des˝
;

2510 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2511 
me
;

2513 i‡(
	`likñy
(!
cfg
->
move_ö_¥ogªss
))

2516 
me
 = 
	`smp_¥o˚ss‹_id
();

2518 i‡(
ve˘‹
 =
cfg
->ve˘‹ && 
	`˝umask_ã°_˝u
(
me
, cfg->
domaö
))

2519 
	`£nd_˛ónup_ve˘‹
(
cfg
);

2520 
	}
}

2522 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
)

2524 
	`__úq_com∂ëe_move
(
des˝
, ~
	`gë_úq_ªgs
()->
‹ig_ax
);

2525 
	}
}

2527 
	$úq_f‹˚_com∂ëe_move
(
úq
)

2529 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2530 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2532 i‡(!
cfg
)

2535 
	`__úq_com∂ëe_move
(&
desc
, 
cfg
->
ve˘‹
);

2536 
	}
}

2538 
ölöe
 
	$úq_com∂ëe_move
(
úq_desc
 **
des˝
Ë{
	}
}

2541 
	$ack_≠ic_edge
(
úq
)

2543 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2545 
	`úq_com∂ëe_move
(&
desc
);

2546 
	`move_«tive_úq
(
úq
);

2547 
	`ack_APIC_úq
();

2548 
	}
}

2550 
©omic_t
 
	gúq_mis_cou¡
;

2568 
	$__eoi_iﬂpic_úq
(
úq
, 
úq_cfg
 *
cfg
)

2570 
úq_pö_li°
 *
íåy
;

2572 
	`f‹_óch_úq_pö
(
íåy
, 
cfg
->
úq_2_pö
) {

2573 i‡(
mp_iﬂpics
[
íåy
->
≠ic
].
≠icvî
 >= 0x20) {

2580 i‡(
	`úq_ªm≠≥d
(
úq
))

2581 
	`io_≠ic_eoi
(
íåy
->
≠ic
,É¡ry->
pö
);

2583 
	`io_≠ic_eoi
(
íåy
->
≠ic
, 
cfg
->
ve˘‹
);

2585 
	`__mask_™d_edge_IO_APIC_úq
(
íåy
);

2586 
	`__unmask_™d_Àvñ_IO_APIC_úq
(
íåy
);

2589 
	}
}

2591 
	$eoi_iﬂpic_úq
(
úq_desc
 *
desc
)

2593 
úq_cfg
 *
cfg
;

2594 
Êags
;

2595 
úq
;

2597 
úq
 = 
desc
->irq;

2598 
cfg
 = 
desc
->
chù_d©a
;

2600 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

2601 
	`__eoi_iﬂpic_úq
(
úq
, 
cfg
);

2602 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

2603 
	}
}

2605 
	$ack_≠ic_Àvñ
(
úq
)

2607 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2608 
v
;

2609 
i
;

2610 
úq_cfg
 *
cfg
;

2611 
do_unmask_úq
 = 0;

2613 
	`úq_com∂ëe_move
(&
desc
);

2614 #ifde‡
CONFIG_GENERIC_PENDING_IRQ


2616 i‡(
	`u∆ikñy
(
desc
->
°©us
 & 
IRQ_MOVE_PENDING
)) {

2617 
do_unmask_úq
 = 1;

2618 
	`mask_IO_APIC_úq_desc
(
desc
);

2654 
cfg
 = 
desc
->
chù_d©a
;

2655 
i
 = 
cfg
->
ve˘‹
;

2656 
v
 = 
	`≠ic_ªad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

2662 
	`ack_APIC_úq
();

2671 i‡(!(
v
 & (1 << (
i
 & 0x1f)))) {

2672 
	`©omic_öc
(&
úq_mis_cou¡
);

2674 
	`eoi_iﬂpic_úq
(
desc
);

2678 i‡(
	`u∆ikñy
(
do_unmask_úq
)) {

2705 
cfg
 = 
desc
->
chù_d©a
;

2706 i‡(!
	`io_≠ic_Àvñ_ack_≥ndög
(
cfg
))

2707 
	`move_masked_úq
(
úq
);

2708 
	`unmask_IO_APIC_úq_desc
(
desc
);

2710 
	}
}

2712 #ifde‡
CONFIG_INTR_REMAP


2713 
	$ú_ack_≠ic_edge
(
úq
)

2715 
	`ack_APIC_úq
();

2716 
	}
}

2718 
	$ú_ack_≠ic_Àvñ
(
úq
)

2720 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

2722 
	`ack_APIC_úq
();

2723 
	`eoi_iﬂpic_úq
(
desc
);

2724 
	}
}

2727 
úq_chù
 
iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2728 .
«me
 = "IO-APIC",

2729 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2730 .
	gmask
 = 
mask_IO_APIC_úq
,

2731 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2732 .
	gack
 = 
ack_≠ic_edge
,

2733 .
	geoi
 = 
ack_≠ic_Àvñ
,

2734 #ifde‡
CONFIG_SMP


2735 .
	g£t_afföôy
 = 
£t_iﬂpic_afföôy_úq
,

2737 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2740 
úq_chù
 
ú_iﬂpic_chù
 
	g__ªad_mo°ly
 = {

2741 .
«me
 = "IR-IO-APIC",

2742 .
	g°¨tup
 = 
°¨tup_iﬂpic_úq
,

2743 .
	gmask
 = 
mask_IO_APIC_úq
,

2744 .
	gunmask
 = 
unmask_IO_APIC_úq
,

2745 #ifde‡
CONFIG_INTR_REMAP


2746 .
	gack
 = 
ú_ack_≠ic_edge
,

2747 .
	geoi
 = 
ú_ack_≠ic_Àvñ
,

2748 #ifde‡
CONFIG_SMP


2749 .
	g£t_afföôy
 = 
£t_ú_iﬂpic_afföôy_úq
,

2752 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

2755 
ölöe
 
	$öô_IO_APIC_å≠s
()

2757 
úq
;

2758 
úq_desc
 *
desc
;

2759 
úq_cfg
 *
cfg
;

2772 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

2773 
cfg
 = 
desc
->
chù_d©a
;

2774 i‡(
	`IO_APIC_IRQ
(
úq
Ë&& 
cfg
 && !cfg->
ve˘‹
) {

2780 i‡(
úq
 < 
Àgacy_pic
->
ƒ_Àgacy_úqs
)

2781 
Àgacy_pic
->
	`make_úq
(
úq
);

2784 
desc
->
chù
 = &
no_úq_chù
;

2787 
	}
}

2793 
	$mask_œpic_úq
(
úq
)

2795 
v
;

2797 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2798 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

2799 
	}
}

2801 
	$unmask_œpic_úq
(
úq
)

2803 
v
;

2805 
v
 = 
	`≠ic_ªad
(
APIC_LVT0
);

2806 
	`≠ic_wrôe
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

2807 
	}
}

2809 
	$ack_œpic_úq
(
úq
)

2811 
	`ack_APIC_úq
();

2812 
	}
}

2814 
úq_chù
 
œpic_chù
 
	g__ªad_mo°ly
 = {

2815 .
«me
 = "local-APIC",

2816 .
	gmask
 = 
mask_œpic_úq
,

2817 .
	gunmask
 = 
unmask_œpic_úq
,

2818 .
	gack
 = 
ack_œpic_úq
,

2821 
	$œpic_ªgi°î_öå
(
úq
, 
úq_desc
 *
desc
)

2823 
desc
->
°©us
 &~
IRQ_LEVEL
;

2824 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
œpic_chù
, 
h™dÀ_edge_úq
,

2826 
	}
}

2828 
__öô
 
	$£tup_nmi
()

2839 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO
 "activating NMI Watchdog ...");

2841 
	`íabÀ_NMI_through_LVT0
();

2843 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " done.\n");

2844 
	}
}

2853 
ölöe
 
__öô
 
	$u∆ock_ExtINT_logic
()

2855 
≠ic
, 
pö
, 
i
;

2856 
IO_APIC_rouã_íåy
 
íåy0
, 
íåy1
;

2857 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

2859 
pö
 = 
	`föd_iß_úq_pö
(8, 
mp_INT
);

2860 i‡(
pö
 == -1) {

2861 
	`WARN_ON_ONCE
(1);

2864 
≠ic
 = 
	`föd_iß_úq_≠ic
(8, 
mp_INT
);

2865 i‡(
≠ic
 == -1) {

2866 
	`WARN_ON_ONCE
(1);

2870 
íåy0
 = 
	`iﬂpic_ªad_íåy
(
≠ic
, 
pö
);

2871 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2873 
	`mem£t
(&
íåy1
, 0, (entry1));

2875 
íåy1
.
de°_mode
 = 0;

2876 
íåy1
.
mask
 = 0;

2877 
íåy1
.
de°
 = 
	`h¨d_smp_¥o˚ss‹_id
();

2878 
íåy1
.
dñivîy_mode
 = 
de°_ExtINT
;

2879 
íåy1
.
pﬁ¨ôy
 = 
íåy0
.polarity;

2880 
íåy1
.
åiggî
 = 0;

2881 
íåy1
.
ve˘‹
 = 0;

2883 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy1
);

2885 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

2886 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

2887 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
 & ~
RTC_RATE_SELECT
) | 0x6,

2888 
RTC_FREQ_SELECT
);

2889 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
 | 
RTC_PIE
, 
RTC_CONTROL
);

2891 
i
 = 100;

2892 
i
-- > 0) {

2893 
	`mdñay
(10);

2894 i‡((
	`CMOS_READ
(
RTC_INTR_FLAGS
Ë& 
RTC_PF
) == RTC_PF)

2895 
i
 -= 10;

2898 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

2899 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

2900 
	`˛ór_IO_APIC_pö
(
≠ic
, 
pö
);

2902 
	`iﬂpic_wrôe_íåy
(
≠ic
, 
pö
, 
íåy0
);

2903 
	}
}

2905 
dißbÀ_timî_pö_1
 
	g__öôd©a
;

2907 
__öô
 
	$dißbÀ_timî_pö_£tup
(*
¨g
)

2909 
dißbÀ_timî_pö_1
 = 1;

2911 
	}
}

2912 
óæy_∑øm
("dißbÀ_timî_pö_1", 
dißbÀ_timî_pö_£tup
);

2914 
timî_through_8259
 
	g__öôd©a
;

2924 
ölöe
 
__öô
 
	$check_timî
()

2926 
úq_desc
 *
desc
 = 
	`úq_to_desc
(0);

2927 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

2928 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

2929 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
;

2930 
Êags
;

2931 
no_pö1
 = 0;

2933 
	`loˇl_úq_ßve
(
Êags
);

2938 
Àgacy_pic
->
chù
->
	`mask
(0);

2939 
	`assign_úq_ve˘‹
(0, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

2950 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

2951 
Àgacy_pic
->
	`öô
(1);

2952 #ifde‡
CONFIG_X86_32


2954 
vî
;

2956 
vî
 = 
	`≠ic_ªad
(
APIC_LVR
);

2957 
vî
 = 
	`GET_APIC_VERSION
(ver);

2958 
timî_ack
 = (
nmi_w©chdog
 =
NMI_IO_APIC
 && !
	`APIC_INTEGRATED
(
vî
));

2962 
pö1
 = 
	`föd_iß_úq_pö
(0, 
mp_INT
);

2963 
≠ic1
 = 
	`föd_iß_úq_≠ic
(0, 
mp_INT
);

2964 
pö2
 = 
iﬂpic_i8259
.
pö
;

2965 
≠ic2
 = 
iﬂpic_i8259
.
≠ic
;

2967 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..TIMER: vector=0x%02X "

2969 
cfg
->
ve˘‹
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

2978 i‡(
pö1
 == -1) {

2979 i‡(
öå_ªm≠pög_íabÀd
)

2980 
	`∑nic
("BIOS bug:ÅimerÇot connectedÅo IO-APIC");

2981 
pö1
 = 
pö2
;

2982 
≠ic1
 = 
≠ic2
;

2983 
no_pö1
 = 1;

2984 } i‡(
pö2
 == -1) {

2985 
pö2
 = 
pö1
;

2986 
≠ic2
 = 
≠ic1
;

2989 i‡(
pö1
 != -1) {

2993 i‡(
no_pö1
) {

2994 
	`add_pö_to_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
);

2995 
	`£tup_timî_IRQ0_pö
(
≠ic1
, 
pö1
, 
cfg
->
ve˘‹
);

3002 
idx
;

3003 
idx
 = 
	`föd_úq_íåy
(
≠ic1
, 
pö1
, 
mp_INT
);

3004 i‡(
idx
 !-1 && 
	`úq_åiggî
(idx))

3005 
	`unmask_IO_APIC_úq_desc
(
desc
);

3007 i‡(
	`timî_úq_w‹ks
()) {

3008 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3009 
	`£tup_nmi
();

3010 
Àgacy_pic
->
chù
->
	`unmask
(0);

3012 i‡(
dißbÀ_timî_pö_1
 > 0)

3013 
	`˛ór_IO_APIC_pö
(0, 
pö1
);

3014 
out
;

3016 i‡(
öå_ªm≠pög_íabÀd
)

3017 
	`∑nic
("timer doesn't workÅhrough Interrupt-remapped IO-APIC");

3018 
	`loˇl_úq_dißbÀ
();

3019 
	`˛ór_IO_APIC_pö
(
≠ic1
, 
pö1
);

3020 i‡(!
no_pö1
)

3021 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_ERR
 "..MP-BIOS bug: "

3024 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "...tryingÅo set upÅimer "

3026 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3027 "..... (foundápi¯%dÖö %dË...\n", 
≠ic2
, 
pö2
);

3031 
	`ª∂a˚_pö_©_úq_node
(
cfg
, 
node
, 
≠ic1
, 
pö1
, 
≠ic2
, 
pö2
);

3032 
	`£tup_timî_IRQ0_pö
(
≠ic2
, 
pö2
, 
cfg
->
ve˘‹
);

3033 
Àgacy_pic
->
chù
->
	`unmask
(0);

3034 i‡(
	`timî_úq_w‹ks
()) {

3035 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... works.\n");

3036 
timî_through_8259
 = 1;

3037 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3038 
Àgacy_pic
->
chù
->
	`mask
(0);

3039 
	`£tup_nmi
();

3040 
Àgacy_pic
->
chù
->
	`unmask
(0);

3042 
out
;

3047 
	`loˇl_úq_dißbÀ
();

3048 
Àgacy_pic
->
chù
->
	`mask
(0);

3049 
	`˛ór_IO_APIC_pö
(
≠ic2
, 
pö2
);

3050 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "....... failed.\n");

3053 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

3054 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_WARNING
 "timer doesn't work "

3056 
nmi_w©chdog
 = 
NMI_NONE
;

3058 #ifde‡
CONFIG_X86_32


3059 
timî_ack
 = 0;

3062 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3065 
	`œpic_ªgi°î_öå
(0, 
desc
);

3066 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3067 
Àgacy_pic
->
chù
->
	`unmask
(0);

3069 i‡(
	`timî_úq_w‹ks
()) {

3070 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3071 
out
;

3073 
	`loˇl_úq_dißbÀ
();

3074 
Àgacy_pic
->
chù
->
	`mask
(0);

3075 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
cfg
->
ve˘‹
);

3076 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed.\n");

3078 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO


3081 
Àgacy_pic
->
	`öô
(0);

3082 
Àgacy_pic
->
	`make_úq
(0);

3083 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

3085 
	`u∆ock_ExtINT_logic
();

3087 i‡(
	`timî_úq_w‹ks
()) {

3088 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... works.\n");

3089 
out
;

3091 
	`loˇl_úq_dißbÀ
();

3092 
	`≠ic_¥ötk
(
APIC_QUIET
, 
KERN_INFO
 "..... failed :(.\n");

3093 
	`∑nic
("IO-APIC +Åimer doesn't work! Boot withápic=debugánd sendá "

3095 
out
:

3096 
	`loˇl_úq_ª°‹e
(
Êags
);

3097 
	}
}

3116 
	#PIC_IRQS
 (1UL << 
PIC_CASCADE_IR
)

	)

3118 
__öô
 
	$£tup_IO_APIC
()

3124 
io_≠ic_úqs
 = 
Àgacy_pic
->
ƒ_Àgacy_úqs
 ? ~
PIC_IRQS
 : ~0UL;

3126 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "ENABLING IO-APIC IRQs\n");

3130 
x86_öô
.
mµ¨£
.
	`£tup_iﬂpic_ids
();

3132 
	`sync_Arb_IDs
();

3133 
	`£tup_IO_APIC_úqs
();

3134 
	`öô_IO_APIC_å≠s
();

3135 i‡(
Àgacy_pic
->
ƒ_Àgacy_úqs
)

3136 
	`check_timî
();

3137 
	}
}

3144 
__öô
 
	$io_≠ic_bug_föÆize
()

3146 i‡(
sis_≠ic_bug
 == -1)

3147 
sis_≠ic_bug
 = 0;

3149 
	}
}

3151 
œã_öôˇŒ
(
io_≠ic_bug_föÆize
);

3153 
	ssysfs_iﬂpic_d©a
 {

3154 
sys_devi˚
 
	mdev
;

3155 
IO_APIC_rouã_íåy
 
	míåy
[0];

3157 
sysfs_iﬂpic_d©a
 * 
	gmp_iﬂpic_d©a
[
MAX_IO_APICS
];

3159 
	$iﬂpic_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

3161 
IO_APIC_rouã_íåy
 *
íåy
;

3162 
sysfs_iﬂpic_d©a
 *
d©a
;

3163 
i
;

3165 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3166 
íåy
 = 
d©a
->entry;

3167 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i ++, 
íåy
 ++ )

3168 *
íåy
 = 
	`iﬂpic_ªad_íåy
(
dev
->
id
, 
i
);

3171 
	}
}

3173 
	$iﬂpic_ªsume
(
sys_devi˚
 *
dev
)

3175 
IO_APIC_rouã_íåy
 *
íåy
;

3176 
sysfs_iﬂpic_d©a
 *
d©a
;

3177 
Êags
;

3178 
IO_APIC_ªg_00
 
ªg_00
;

3179 
i
;

3181 
d©a
 = 
	`c⁄èöî_of
(
dev
, 
sysfs_iﬂpic_d©a
, dev);

3182 
íåy
 = 
d©a
->entry;

3184 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3185 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
dev
->
id
, 0);

3186 i‡(
ªg_00
.
bôs
.
ID
 !
mp_iﬂpics
[
dev
->
id
].
≠icid
) {

3187 
ªg_00
.
bôs
.
ID
 = 
mp_iﬂpics
[
dev
->
id
].
≠icid
;

3188 
	`io_≠ic_wrôe
(
dev
->
id
, 0, 
ªg_00
.
øw
);

3190 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3191 
i
 = 0; i < 
ƒ_iﬂpic_ªgi°îs
[
dev
->
id
]; i++)

3192 
	`iﬂpic_wrôe_íåy
(
dev
->
id
, 
i
, 
íåy
[i]);

3195 
	}
}

3197 
sysdev_˛ass
 
	giﬂpic_sysdev_˛ass
 = {

3198 .
«me
 = "ioapic",

3199 .
	gsu•íd
 = 
iﬂpic_su•íd
,

3200 .
	gªsume
 = 
iﬂpic_ªsume
,

3203 
__öô
 
	$iﬂpic_öô_sysfs
()

3205 
sys_devi˚
 * 
dev
;

3206 
i
, 
size
, 
îr‹
;

3208 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
iﬂpic_sysdev_˛ass
);

3209 i‡(
îr‹
)

3210  
îr‹
;

3212 
i
 = 0; i < 
ƒ_iﬂpics
; i++ ) {

3213 
size
 = (
sys_devi˚
Ë+ 
ƒ_iﬂpic_ªgi°îs
[
i
]

3214 * (
IO_APIC_rouã_íåy
);

3215 
mp_iﬂpic_d©a
[
i
] = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3216 i‡(!
mp_iﬂpic_d©a
[
i
]) {

3217 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3220 
dev
 = &
mp_iﬂpic_d©a
[
i
]->dev;

3221 
dev
->
id
 = 
i
;

3222 
dev
->
˛s
 = &
iﬂpic_sysdev_˛ass
;

3223 
îr‹
 = 
	`sysdev_ªgi°î
(
dev
);

3224 i‡(
îr‹
) {

3225 
	`k‰ì
(
mp_iﬂpic_d©a
[
i
]);

3226 
mp_iﬂpic_d©a
[
i
] = 
NULL
;

3227 
	`¥ötk
(
KERN_ERR
 "C™'àsu•íd/ªsumêIOAPIC %d\n", 
i
);

3233 
	}
}

3235 
devi˚_öôˇŒ
(
iﬂpic_öô_sysfs
);

3240 
	$¸óã_úq_ƒ
(
úq_w™t
, 
node
)

3243 
úq
;

3244 
√w
;

3245 
Êags
;

3246 
úq_cfg
 *
cfg_√w
 = 
NULL
;

3247 
úq_desc
 *
desc_√w
 = 
NULL
;

3249 
úq
 = 0;

3250 i‡(
úq_w™t
 < 
ƒ_úqs_gsi
)

3251 
úq_w™t
 = 
ƒ_úqs_gsi
;

3253 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3254 
√w
 = 
úq_w™t
;Çew < 
ƒ_úqs
;Çew++) {

3255 
desc_√w
 = 
	`úq_to_desc_Æloc_node
(
√w
, 
node
);

3256 i‡(!
desc_√w
) {

3257 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯f‹ %d\n", 
√w
);

3260 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3262 i‡(
cfg_√w
->
ve˘‹
 != 0)

3265 
desc_√w
 = 
	`move_úq_desc
(desc_√w, 
node
);

3266 
cfg_√w
 = 
desc_√w
->
chù_d©a
;

3268 i‡(
	`__assign_úq_ve˘‹
(
√w
, 
cfg_√w
, 
≠ic
->
	`èrgë_˝us
()) == 0)

3269 
úq
 = 
√w
;

3272 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3274 i‡(
úq
 > 0)

3275 
	`dy«mic_úq_öô_kìp_chù_d©a
(
úq
);

3277  
úq
;

3278 
	}
}

3280 
	$¸óã_úq
()

3282 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3283 
úq_w™t
;

3284 
úq
;

3286 
úq_w™t
 = 
ƒ_úqs_gsi
;

3287 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3289 i‡(
úq
 == 0)

3290 
úq
 = -1;

3292  
úq
;

3293 
	}
}

3295 
	$de°roy_úq
(
úq
)

3297 
Êags
;

3299 
	`dy«mic_úq_˛ónup_kìp_chù_d©a
(
úq
);

3301 
	`‰ì_úã
(
úq
);

3302 
	`øw_•ö_lock_úqßve
(&
ve˘‹_lock
, 
Êags
);

3303 
	`__˛ór_úq_ve˘‹
(
úq
, 
	`gë_úq_chù_d©a
(irq));

3304 
	`øw_•ö_u∆ock_úqª°‹e
(&
ve˘‹_lock
, 
Êags
);

3305 
	}
}

3310 #ifde‡
CONFIG_PCI_MSI


3311 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
úq
,

3312 
msi_msg
 *
msg
, 
u8
 
h≥t_id
)

3314 
úq_cfg
 *
cfg
;

3315 
îr
;

3316 
de°
;

3318 i‡(
dißbÀ_≠ic
)

3319  -
ENXIO
;

3321 
cfg
 = 
	`úq_cfg
(
úq
);

3322 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3323 i‡(
îr
)

3324  
îr
;

3326 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,ápic->
	`èrgë_˝us
());

3328 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3329 
úã
 irte;

3330 
ú_ödex
;

3331 
u16
 
sub_h™dÀ
;

3333 
ú_ödex
 = 
	`m≠_úq_to_úã_h™dÀ
(
úq
, &
sub_h™dÀ
);

3334 
	`BUG_ON
(
ú_ödex
 == -1);

3336 
	`mem£t
 (&
úã
, 0, (irte));

3338 
úã
.
¥e£¡
 = 1;

3339 
úã
.
d°_mode
 = 
≠ic
->
úq_de°_mode
;

3340 
úã
.
åiggî_mode
 = 0;

3341 
úã
.
dlvry_mode
 = 
≠ic
->
úq_dñivîy_mode
;

3342 
úã
.
ve˘‹
 = 
cfg
->vector;

3343 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3346 i‡(
pdev
)

3347 
	`£t_msi_sid
(&
úã
, 
pdev
);

3349 
	`£t_h≥t_sid
(&
úã
, 
h≥t_id
);

3351 
	`modify_úã
(
úq
, &
úã
);

3353 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3354 
msg
->
d©a
 = 
sub_h™dÀ
;

3355 
msg
->
addªss_lo
 = 
MSI_ADDR_BASE_LO
 | 
MSI_ADDR_IR_EXT_INT
 |

3356 
MSI_ADDR_IR_SHV
 |

3357 
	`MSI_ADDR_IR_INDEX1
(
ú_ödex
) |

3358 
	`MSI_ADDR_IR_INDEX2
(
ú_ödex
);

3360 i‡(
	`x2≠ic_íabÀd
())

3361 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
 |

3362 
	`MSI_ADDR_EXT_DEST_ID
(
de°
);

3364 
msg
->
addªss_hi
 = 
MSI_ADDR_BASE_HI
;

3366 
msg
->
addªss_lo
 =

3367 
MSI_ADDR_BASE_LO
 |

3368 ((
≠ic
->
úq_de°_mode
 == 0) ?

3369 
MSI_ADDR_DEST_MODE_PHYSICAL
:

3370 
MSI_ADDR_DEST_MODE_LOGICAL
) |

3371 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3372 
MSI_ADDR_REDIRECTION_CPU
:

3373 
MSI_ADDR_REDIRECTION_LOWPRI
) |

3374 
	`MSI_ADDR_DEST_ID
(
de°
);

3376 
msg
->
d©a
 =

3377 
MSI_DATA_TRIGGER_EDGE
 |

3378 
MSI_DATA_LEVEL_ASSERT
 |

3379 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3380 
MSI_DATA_DELIVERY_FIXED
:

3381 
MSI_DATA_DELIVERY_LOWPRI
) |

3382 
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3384  
îr
;

3385 
	}
}

3387 #ifde‡
CONFIG_SMP


3388 
	$£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3390 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3391 
úq_cfg
 *
cfg
;

3392 
msi_msg
 
msg
;

3393 
de°
;

3395 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3398 
cfg
 = 
desc
->
chù_d©a
;

3400 
	`ªad_msi_msg_desc
(
desc
, &
msg
);

3402 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3403 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3404 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3405 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3407 
	`wrôe_msi_msg_desc
(
desc
, &
msg
);

3410 
	}
}

3411 #ifde‡
CONFIG_INTR_REMAP


3417 
	$ú_£t_msi_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3419 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3420 
úq_cfg
 *
cfg
 = 
desc
->
chù_d©a
;

3421 
de°
;

3422 
úã
 irte;

3424 i‡(
	`gë_úã
(
úq
, &
úã
))

3427 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3430 
úã
.
ve˘‹
 = 
cfg
->vector;

3431 
úã
.
de°_id
 = 
	`IRTE_DEST
(
de°
);

3436 
	`modify_úã
(
úq
, &
úã
);

3443 i‡(
cfg
->
move_ö_¥ogªss
)

3444 
	`£nd_˛ónup_ve˘‹
(
cfg
);

3447 
	}
}

3456 
úq_chù
 
	gmsi_chù
 = {

3457 .
«me
 = "PCI-MSI",

3458 .
	gunmask
 = 
unmask_msi_úq
,

3459 .
	gmask
 = 
mask_msi_úq
,

3460 .
	gack
 = 
ack_≠ic_edge
,

3461 #ifde‡
CONFIG_SMP


3462 .
	g£t_afföôy
 = 
£t_msi_úq_afföôy
,

3464 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3467 
úq_chù
 
	gmsi_ú_chù
 = {

3468 .
«me
 = "IR-PCI-MSI",

3469 .
	gunmask
 = 
unmask_msi_úq
,

3470 .
	gmask
 = 
mask_msi_úq
,

3471 #ifde‡
CONFIG_INTR_REMAP


3472 .
	gack
 = 
ú_ack_≠ic_edge
,

3473 #ifde‡
CONFIG_SMP


3474 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3477 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3485 
	$msi_Æloc_úã
(
pci_dev
 *
dev
, 
úq
, 
nvec
)

3487 
öãl_iommu
 *
iommu
;

3488 
ödex
;

3490 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3491 i‡(!
iommu
) {

3492 
	`¥ötk
(
KERN_ERR


3493 "U«bÀÅÿm≠ PCI %†tÿiommu\n", 
	`pci_«me
(
dev
));

3494  -
ENOENT
;

3497 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 
nvec
);

3498 i‡(
ödex
 < 0) {

3499 
	`¥ötk
(
KERN_ERR


3500 "U«bÀÅÿÆloˇã %d IRTE f‹ PCI %s\n", 
nvec
,

3501 
	`pci_«me
(
dev
));

3502  -
ENOSPC
;

3504  
ödex
;

3505 
	}
}

3507 
	$£tup_msi_úq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
úq
)

3509 
ªt
;

3510 
msi_msg
 
msg
;

3512 
ªt
 = 
	`msi_compo£_msg
(
dev
, 
úq
, &
msg
, -1);

3513 i‡(
ªt
 < 0)

3514  
ªt
;

3516 
	`£t_úq_msi
(
úq
, 
msidesc
);

3517 
	`wrôe_msi_msg
(
úq
, &
msg
);

3519 i‡(
	`úq_ªm≠≥d
(
úq
)) {

3520 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3524 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3525 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_ú_chù
, 
h™dÀ_edge_úq
, "edge");

3527 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
msi_chù
, 
h™dÀ_edge_úq
, "edge");

3529 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ MSI/MSI-X\n", 
úq
);

3532 
	}
}

3534 
	$¨ch_£tup_msi_úqs
(
pci_dev
 *
dev
, 
nvec
, 
ty≥
)

3536 
úq
;

3537 
ªt
, 
sub_h™dÀ
;

3538 
msi_desc
 *
msidesc
;

3539 
úq_w™t
;

3540 
öãl_iommu
 *
iommu
 = 
NULL
;

3541 
ödex
 = 0;

3542 
node
;

3545 i‡(
ty≥
 =
PCI_CAP_ID_MSI
 && 
nvec
 > 1)

3548 
node
 = 
	`dev_to_node
(&
dev
->dev);

3549 
úq_w™t
 = 
ƒ_úqs_gsi
;

3550 
sub_h™dÀ
 = 0;

3551 
	`li°_f‹_óch_íåy
(
msidesc
, &
dev
->
msi_li°
, 
li°
) {

3552 
úq
 = 
	`¸óã_úq_ƒ
(
úq_w™t
, 
node
);

3553 i‡(
úq
 == 0)

3555 
úq_w™t
 = 
úq
 + 1;

3556 i‡(!
öå_ªm≠pög_íabÀd
)

3557 
no_ú
;

3559 i‡(!
sub_h™dÀ
) {

3564 
ödex
 = 
	`msi_Æloc_úã
(
dev
, 
úq
, 
nvec
);

3565 i‡(
ödex
 < 0) {

3566 
ªt
 = 
ödex
;

3567 
îr‹
;

3570 
iommu
 = 
	`m≠_dev_to_ú
(
dev
);

3571 i‡(!
iommu
) {

3572 
ªt
 = -
ENOENT
;

3573 
îr‹
;

3580 
	`£t_úã_úq
(
úq
, 
iommu
, 
ödex
, 
sub_h™dÀ
);

3582 
no_ú
:

3583 
ªt
 = 
	`£tup_msi_úq
(
dev
, 
msidesc
, 
úq
);

3584 i‡(
ªt
 < 0)

3585 
îr‹
;

3586 
sub_h™dÀ
++;

3590 
îr‹
:

3591 
	`de°roy_úq
(
úq
);

3592  
ªt
;

3593 
	}
}

3595 
	$¨ch_ã¨down_msi_úq
(
úq
)

3597 
	`de°roy_úq
(
úq
);

3598 
	}
}

3600 #i‡
deföed
 (
CONFIG_DMAR
Ë|| deföed (
CONFIG_INTR_REMAP
)

3601 #ifde‡
CONFIG_SMP


3602 
	$dm¨_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3604 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3605 
úq_cfg
 *
cfg
;

3606 
msi_msg
 
msg
;

3607 
de°
;

3609 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3612 
cfg
 = 
desc
->
chù_d©a
;

3614 
	`dm¨_msi_ªad
(
úq
, &
msg
);

3616 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3617 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3618 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3619 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3621 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3624 
	}
}

3628 
úq_chù
 
	gdm¨_msi_ty≥
 = {

3629 .
«me
 = "DMAR_MSI",

3630 .
	gunmask
 = 
dm¨_msi_unmask
,

3631 .
	gmask
 = 
dm¨_msi_mask
,

3632 .
	gack
 = 
ack_≠ic_edge
,

3633 #ifde‡
CONFIG_SMP


3634 .
	g£t_afföôy
 = 
dm¨_msi_£t_afföôy
,

3636 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3639 
	$¨ch_£tup_dm¨_msi
(
úq
)

3641 
ªt
;

3642 
msi_msg
 
msg
;

3644 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, -1);

3645 i‡(
ªt
 < 0)

3646  
ªt
;

3647 
	`dm¨_msi_wrôe
(
úq
, &
msg
);

3648 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
dm¨_msi_ty≥
, 
h™dÀ_edge_úq
,

3651 
	}
}

3654 #ifde‡
CONFIG_HPET_TIMER


3656 #ifde‡
CONFIG_SMP


3657 
	$h≥t_msi_£t_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3659 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3660 
úq_cfg
 *
cfg
;

3661 
msi_msg
 
msg
;

3662 
de°
;

3664 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3667 
cfg
 = 
desc
->
chù_d©a
;

3669 
	`h≥t_msi_ªad
(
úq
, &
msg
);

3671 
msg
.
d©a
 &~
MSI_DATA_VECTOR_MASK
;

3672 
msg
.
d©a
 |
	`MSI_DATA_VECTOR
(
cfg
->
ve˘‹
);

3673 
msg
.
addªss_lo
 &~
MSI_ADDR_DEST_ID_MASK
;

3674 
msg
.
addªss_lo
 |
	`MSI_ADDR_DEST_ID
(
de°
);

3676 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3679 
	}
}

3683 
úq_chù
 
	gú_h≥t_msi_ty≥
 = {

3684 .
«me
 = "IR-HPET_MSI",

3685 .
	gunmask
 = 
h≥t_msi_unmask
,

3686 .
	gmask
 = 
h≥t_msi_mask
,

3687 #ifde‡
CONFIG_INTR_REMAP


3688 .
	gack
 = 
ú_ack_≠ic_edge
,

3689 #ifde‡
CONFIG_SMP


3690 .
	g£t_afföôy
 = 
ú_£t_msi_úq_afföôy
,

3693 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3696 
úq_chù
 
	gh≥t_msi_ty≥
 = {

3697 .
«me
 = "HPET_MSI",

3698 .
	gunmask
 = 
h≥t_msi_unmask
,

3699 .
	gmask
 = 
h≥t_msi_mask
,

3700 .
	gack
 = 
ack_≠ic_edge
,

3701 #ifde‡
CONFIG_SMP


3702 .
	g£t_afföôy
 = 
h≥t_msi_£t_afföôy
,

3704 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3707 
	$¨ch_£tup_h≥t_msi
(
úq
, 
id
)

3709 
ªt
;

3710 
msi_msg
 
msg
;

3711 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3713 i‡(
öå_ªm≠pög_íabÀd
) {

3714 
öãl_iommu
 *
iommu
 = 
	`m≠_h≥t_to_ú
(
id
);

3715 
ödex
;

3717 i‡(!
iommu
)

3720 
ödex
 = 
	`Æloc_úã
(
iommu
, 
úq
, 1);

3721 i‡(
ödex
 < 0)

3725 
ªt
 = 
	`msi_compo£_msg
(
NULL
, 
úq
, &
msg
, 
id
);

3726 i‡(
ªt
 < 0)

3727  
ªt
;

3729 
	`h≥t_msi_wrôe
(
úq
, &
msg
);

3730 
desc
->
°©us
 |
IRQ_MOVE_PCNTXT
;

3731 i‡(
	`úq_ªm≠≥d
(
úq
))

3732 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ú_h≥t_msi_ty≥
,

3733 
h™dÀ_edge_úq
, "edge");

3735 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
h≥t_msi_ty≥
,

3736 
h™dÀ_edge_úq
, "edge");

3739 
	}
}

3746 #ifde‡
CONFIG_HT_IRQ


3748 #ifde‡
CONFIG_SMP


3750 
	$èrgë_ht_úq
(
úq
, 
de°
, 
u8
 
ve˘‹
)

3752 
ht_úq_msg
 
msg
;

3753 
	`„tch_ht_úq_msg
(
úq
, &
msg
);

3755 
msg
.
addªss_lo
 &~(
HT_IRQ_LOW_VECTOR_MASK
 | 
HT_IRQ_LOW_DEST_ID_MASK
);

3756 
msg
.
addªss_hi
 &~(
HT_IRQ_HIGH_DEST_ID_MASK
);

3758 
msg
.
addªss_lo
 |
	`HT_IRQ_LOW_VECTOR
(
ve˘‹
Ë| 
	`HT_IRQ_LOW_DEST_ID
(
de°
);

3759 
msg
.
addªss_hi
 |
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3761 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3762 
	}
}

3764 
	$£t_ht_úq_afföôy
(
úq
, c⁄° 
˝umask
 *
mask
)

3766 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
úq
);

3767 
úq_cfg
 *
cfg
;

3768 
de°
;

3770 i‡(
	`£t_desc_afföôy
(
desc
, 
mask
, &
de°
))

3773 
cfg
 = 
desc
->
chù_d©a
;

3775 
	`èrgë_ht_úq
(
úq
, 
de°
, 
cfg
->
ve˘‹
);

3778 
	}
}

3782 
úq_chù
 
	ght_úq_chù
 = {

3783 .
«me
 = "PCI-HT",

3784 .
	gmask
 = 
mask_ht_úq
,

3785 .
	gunmask
 = 
unmask_ht_úq
,

3786 .
	gack
 = 
ack_≠ic_edge
,

3787 #ifde‡
CONFIG_SMP


3788 .
	g£t_afföôy
 = 
£t_ht_úq_afföôy
,

3790 .
	gªåiggî
 = 
iﬂpic_ªåiggî_úq
,

3793 
	$¨ch_£tup_ht_úq
(
úq
, 
pci_dev
 *
dev
)

3795 
úq_cfg
 *
cfg
;

3796 
îr
;

3798 i‡(
dißbÀ_≠ic
)

3799  -
ENXIO
;

3801 
cfg
 = 
	`úq_cfg
(
úq
);

3802 
îr
 = 
	`assign_úq_ve˘‹
(
úq
, 
cfg
, 
≠ic
->
	`èrgë_˝us
());

3803 i‡(!
îr
) {

3804 
ht_úq_msg
 
msg
;

3805 
de°
;

3807 
de°
 = 
≠ic
->
	`˝u_mask_to_≠icid_™d
(
cfg
->
domaö
,

3808 
≠ic
->
	`èrgë_˝us
());

3810 
msg
.
addªss_hi
 = 
	`HT_IRQ_HIGH_DEST_ID
(
de°
);

3812 
msg
.
addªss_lo
 =

3813 
HT_IRQ_LOW_BASE
 |

3814 
	`HT_IRQ_LOW_DEST_ID
(
de°
) |

3815 
	`HT_IRQ_LOW_VECTOR
(
cfg
->
ve˘‹
) |

3816 ((
≠ic
->
úq_de°_mode
 == 0) ?

3817 
HT_IRQ_LOW_DM_PHYSICAL
 :

3818 
HT_IRQ_LOW_DM_LOGICAL
) |

3819 
HT_IRQ_LOW_RQEOI_EDGE
 |

3820 ((
≠ic
->
úq_dñivîy_mode
 !
de°_Lowe°Prio
) ?

3821 
HT_IRQ_LOW_MT_FIXED
 :

3822 
HT_IRQ_LOW_MT_ARBITRATED
) |

3823 
HT_IRQ_LOW_IRQ_MASKED
;

3825 
	`wrôe_ht_úq_msg
(
úq
, &
msg
);

3827 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
ht_úq_chù
,

3828 
h™dÀ_edge_úq
, "edge");

3830 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "úq %d f‹ HT\n", 
úq
);

3832  
îr
;

3833 
	}
}

3836 
__öô
 
	$io_≠ic_gë_ªdú_íåõs
 (
iﬂpic
)

3838 
IO_APIC_ªg_01
 
ªg_01
;

3839 
Êags
;

3841 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3842 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

3843 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

3849  
ªg_01
.
bôs
.
íåõs
 + 1;

3850 
	}
}

3852 
__öô
 
	$¥obe_ƒ_úqs_gsi
()

3854 
ƒ
;

3856 
ƒ
 = 
gsi_t›
 + 
NR_IRQS_LEGACY
;

3857 i‡(
ƒ
 > 
ƒ_úqs_gsi
)

3858 
ƒ_úqs_gsi
 = 
ƒ
;

3860 
	`¥ötk
(
KERN_DEBUG
 "ƒ_úqs_gsi: %d\n", 
ƒ_úqs_gsi
);

3861 
	}
}

3863 #ifde‡
CONFIG_SPARSE_IRQ


3864 
__öô
 
	$¨ch_¥obe_ƒ_úqs
()

3866 
ƒ
;

3868 i‡(
ƒ_úqs
 > (
NR_VECTORS
 * 
ƒ_˝u_ids
))

3869 
ƒ_úqs
 = 
NR_VECTORS
 * 
ƒ_˝u_ids
;

3871 
ƒ
 = 
ƒ_úqs_gsi
 + 8 * 
ƒ_˝u_ids
;

3872 #i‡
	`deföed
(
CONFIG_PCI_MSI
Ë|| deföed(
CONFIG_HT_IRQ
)

3876 
ƒ
 +
ƒ_úqs_gsi
 * 16;

3878 i‡(
ƒ
 < 
ƒ_úqs
)

3879 
ƒ_úqs
 = 
ƒ
;

3882 
	}
}

3885 
	$__io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3886 
io_≠ic_úq_©å
 *
úq_©å
)

3888 
úq_desc
 *
desc
;

3889 
úq_cfg
 *
cfg
;

3890 
node
;

3891 
iﬂpic
, 
pö
;

3892 
åiggî
, 
pﬁ¨ôy
;

3894 
iﬂpic
 = 
úq_©å
->ioapic;

3895 i‡(!
	`IO_APIC_IRQ
(
úq
)) {

3896 
	`≠ic_¥ötk
(
APIC_QUIET
,
KERN_ERR
 "IOAPIC[%d]: InvalidÑeferenceÅo IRQ 0\n",

3897 
iﬂpic
);

3898  -
EINVAL
;

3901 i‡(
dev
)

3902 
node
 = 
	`dev_to_node
(
dev
);

3904 
node
 = 
	`˝u_to_node
(
boŸ_˝u_id
);

3906 
desc
 = 
	`úq_to_desc_Æloc_node
(
úq
, 
node
);

3907 i‡(!
desc
) {

3908 
	`¥ötk
(
KERN_INFO
 "ˇ¿nŸ gë irq_des¯%d\n", 
úq
);

3912 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3913 
åiggî
 = 
úq_©å
->trigger;

3914 
pﬁ¨ôy
 = 
úq_©å
->polarity;

3919 i‡(
úq
 >
Àgacy_pic
->
ƒ_Àgacy_úqs
) {

3920 
cfg
 = 
desc
->
chù_d©a
;

3921 i‡(
	`add_pö_to_úq_node_n›™ic
(
cfg
, 
node
, 
iﬂpic
, 
pö
)) {

3922 
	`¥ötk
(
KERN_INFO
 "canÇotáddÖin %d for irq %d\n",

3923 
pö
, 
úq
);

3928 
	`£tup_IO_APIC_úq
(
iﬂpic
, 
pö
, 
úq
, 
desc
, 
åiggî
, 
pﬁ¨ôy
);

3931 
	}
}

3933 
	$io_≠ic_£t_pci_routög
(
devi˚
 *
dev
, 
úq
,

3934 
io_≠ic_úq_©å
 *
úq_©å
)

3936 
iﬂpic
, 
pö
;

3942 
iﬂpic
 = 
úq_©å
->ioapic;

3943 
pö
 = 
úq_©å
->
iﬂpic_pö
;

3944 i‡(
	`ã°_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
)) {

3945 
	`¥_debug
("Pin %d-%dálreadyÖrogrammed\n",

3946 
mp_iﬂpics
[
iﬂpic
].
≠icid
, 
pö
);

3949 
	`£t_bô
(
pö
, 
mp_iﬂpic_routög
[
iﬂpic
].
pö_¥ogømmed
);

3951  
	`__io_≠ic_£t_pci_routög
(
dev
, 
úq
, 
úq_©å
);

3952 
	}
}

3954 
u8
 
__öô
 
	$io_≠ic_unique_id
(
u8
 
id
)

3956 #ifde‡
CONFIG_X86_32


3957 i‡((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
) &&

3958 !
	`APIC_XAPIC
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]))

3959  
	`io_≠ic_gë_unique_id
(
ƒ_iﬂpics
, 
id
);

3961  
id
;

3963 
i
;

3964 
	`DECLARE_BITMAP
(
u£d
, 256);

3966 
	`bôm≠_zîo
(
u£d
, 256);

3967 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

3968 
mpc_iﬂpic
 *
ü
 = &
mp_iﬂpics
[
i
];

3969 
	`__£t_bô
(
ü
->
≠icid
, 
u£d
);

3971 i‡(!
	`ã°_bô
(
id
, 
u£d
))

3972  
id
;

3973  
	`föd_fú°_zîo_bô
(
u£d
, 256);

3975 
	}
}

3977 #ifde‡
CONFIG_X86_32


3978 
__öô
 
	$io_≠ic_gë_unique_id
(
iﬂpic
, 
≠ic_id
)

3980 
IO_APIC_ªg_00
 
ªg_00
;

3981 
physid_mask_t
 
≠ic_id_m≠
 = 
PHYSID_MASK_NONE
;

3982 
physid_mask_t
 
tmp
;

3983 
Êags
;

3984 
i
 = 0;

3995 i‡(
	`physids_em±y
(
≠ic_id_m≠
))

3996 
≠ic
->
	`iﬂpic_phys_id_m≠
(&
phys_˝u_¥e£¡_m≠
, &
≠ic_id_m≠
);

3998 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

3999 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4000 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4002 i‡(
≠ic_id
 >
	`gë_physiˇl_brﬂdˇ°
()) {

4003 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]: Invalidápic_id %d,Årying "

4004 "%d\n", 
iﬂpic
, 
≠ic_id
, 
ªg_00
.
bôs
.
ID
);

4005 
≠ic_id
 = 
ªg_00
.
bôs
.
ID
;

4012 i‡(
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
≠ic_id
)) {

4014 
i
 = 0; i < 
	`gë_physiˇl_brﬂdˇ°
(); i++) {

4015 i‡(!
≠ic
->
	`check_≠icid_u£d
(&
≠ic_id_m≠
, 
i
))

4019 i‡(
i
 =
	`gë_physiˇl_brﬂdˇ°
())

4020 
	`∑nic
("Maxápic_idÉxceeded!\n");

4022 
	`¥ötk
(
KERN_WARNING
 "IOAPIC[%d]:ápic_id %dálready used, "

4023 "åyög %d\n", 
iﬂpic
, 
≠ic_id
, 
i
);

4025 
≠ic_id
 = 
i
;

4028 
≠ic
->
	`≠icid_to_˝u_¥e£¡
(
≠ic_id
, &
tmp
);

4029 
	`physids_‹
(
≠ic_id_m≠
,ápic_id_m≠, 
tmp
);

4031 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4032 
ªg_00
.
bôs
.
ID
 = 
≠ic_id
;

4034 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4035 
	`io_≠ic_wrôe
(
iﬂpic
, 0, 
ªg_00
.
øw
);

4036 
ªg_00
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 0);

4037 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4040 i‡(
ªg_00
.
bôs
.
ID
 !
≠ic_id
) {

4041 
	`¥ötk
("IOAPIC[%d]: U«bÀÅÿch™gê≠ic_id!\n", 
iﬂpic
);

4046 
	`≠ic_¥ötk
(
APIC_VERBOSE
, 
KERN_INFO


4047 "IOAPIC[%d]: Assig√dápic_id %d\n", 
iﬂpic
, 
≠ic_id
);

4049  
≠ic_id
;

4050 
	}
}

4053 
__öô
 
	$io_≠ic_gë_vîsi⁄
(
iﬂpic
)

4055 
IO_APIC_ªg_01
 
ªg_01
;

4056 
Êags
;

4058 
	`øw_•ö_lock_úqßve
(&
iﬂpic_lock
, 
Êags
);

4059 
ªg_01
.
øw
 = 
	`io_≠ic_ªad
(
iﬂpic
, 1);

4060 
	`øw_•ö_u∆ock_úqª°‹e
(&
iﬂpic_lock
, 
Êags
);

4062  
ªg_01
.
bôs
.
vîsi⁄
;

4063 
	}
}

4065 
	$a˝i_gë_ovîride_úq
(
u32
 
gsi
, *
åiggî
, *
pﬁ¨ôy
)

4067 
iﬂpic
, 
pö
, 
idx
;

4069 i‡(
skù_iﬂpic_£tup
)

4072 
iﬂpic
 = 
	`mp_föd_iﬂpic
(
gsi
);

4073 i‡(
iﬂpic
 < 0)

4076 
pö
 = 
	`mp_föd_iﬂpic_pö
(
iﬂpic
, 
gsi
);

4077 i‡(
pö
 < 0)

4080 
idx
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4081 i‡(
idx
 < 0)

4084 *
åiggî
 = 
	`úq_åiggî
(
idx
);

4085 *
pﬁ¨ôy
 = 
	`úq_pﬁ¨ôy
(
idx
);

4087 
	}
}

4094 #ifde‡
CONFIG_SMP


4095 
__öô
 
	$£tup_iﬂpic_de°
()

4097 
pö
, 
iﬂpic
, 
úq
, 
úq_íåy
;

4098 
úq_desc
 *
desc
;

4099 c⁄° 
˝umask
 *
mask
;

4101 i‡(
skù_iﬂpic_£tup
 == 1)

4104 
iﬂpic
 = 0; iﬂpi¯< 
ƒ_iﬂpics
; ioapic++)

4105 
pö
 = 0;Öö < 
ƒ_iﬂpic_ªgi°îs
[
iﬂpic
];Öin++) {

4106 
úq_íåy
 = 
	`föd_úq_íåy
(
iﬂpic
, 
pö
, 
mp_INT
);

4107 i‡(
úq_íåy
 == -1)

4109 
úq
 = 
	`pö_2_úq
(
úq_íåy
, 
iﬂpic
, 
pö
);

4111 i‡((
iﬂpic
 > 0Ë&& (
úq
 > 16))

4114 
desc
 = 
	`úq_to_desc
(
úq
);

4119 i‡(
desc
->
°©us
 &

4120 (
IRQ_NO_BALANCING
 | 
IRQ_AFFINITY_SET
))

4121 
mask
 = 
desc
->
afföôy
;

4123 
mask
 = 
≠ic
->
	`èrgë_˝us
();

4125 i‡(
öå_ªm≠pög_íabÀd
)

4126 
	`£t_ú_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4128 
	`£t_iﬂpic_afföôy_úq_desc
(
desc
, 
mask
);

4131 
	}
}

4134 
	#IOAPIC_RESOURCE_NAME_SIZE
 11

	)

4136 
ªsour˚
 *
	giﬂpic_ªsour˚s
;

4138 
ªsour˚
 * 
__öô
 
	$iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
)

4140 
n
;

4141 
ªsour˚
 *
ªs
;

4142 *
mem
;

4143 
i
;

4145 i‡(
ƒ_iﬂpics
 <= 0)

4146  
NULL
;

4148 
n
 = 
IOAPIC_RESOURCE_NAME_SIZE
 + (
ªsour˚
);

4149 
n
 *
ƒ_iﬂpics
;

4151 
mem
 = 
	`Æloc_boŸmem
(
n
);

4152 
ªs
 = (*)
mem
;

4154 
mem
 +(
ªsour˚
Ë* 
ƒ_iﬂpics
;

4156 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4157 
ªs
[
i
].
«me
 = 
mem
;

4158 
ªs
[
i
].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

4159 
	`¢¥ötf
(
mem
, 
IOAPIC_RESOURCE_NAME_SIZE
, "IOAPIC %u", 
i
);

4160 
mem
 +
IOAPIC_RESOURCE_NAME_SIZE
;

4163 
iﬂpic_ªsour˚s
 = 
ªs
;

4165  
ªs
;

4166 
	}
}

4168 
__öô
 
	$iﬂpic_öô_m≠pögs
()

4170 
iﬂpic_phys
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

4171 
ªsour˚
 *
iﬂpic_ªs
;

4172 
i
;

4174 
iﬂpic_ªs
 = 
	`iﬂpic_£tup_ªsour˚s
(
ƒ_iﬂpics
);

4175 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4176 i‡(
smp_found_c⁄fig
) {

4177 
iﬂpic_phys
 = 
mp_iﬂpics
[
i
].
≠iˇddr
;

4178 #ifde‡
CONFIG_X86_32


4179 i‡(!
iﬂpic_phys
) {

4180 
	`¥ötk
(
KERN_ERR


4184 
smp_found_c⁄fig
 = 0;

4185 
skù_iﬂpic_£tup
 = 1;

4186 
Áke_iﬂpic_∑ge
;

4190 #ifde‡
CONFIG_X86_32


4191 
Áke_iﬂpic_∑ge
:

4193 
iﬂpic_phys
 = ()
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

4194 
iﬂpic_phys
 = 
	`__∑
(ioapic_phys);

4196 
	`£t_fixm≠_noˇche
(
idx
, 
iﬂpic_phys
);

4197 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "mapped IOAPICÅo %08lx (%08lx)\n",

4198 
	`__fix_to_vút
(
idx
Ë+ (
iﬂpic_phys
 & ~
PAGE_MASK
),

4199 
iﬂpic_phys
);

4200 
idx
++;

4202 
iﬂpic_ªs
->
°¨t
 = 
iﬂpic_phys
;

4203 
iﬂpic_ªs
->
íd
 = 
iﬂpic_phys
 + 
IO_APIC_SLOT_SIZE
 - 1;

4204 
iﬂpic_ªs
++;

4206 
	}
}

4208 
__öô
 
	$iﬂpic_ö£π_ªsour˚s
()

4210 
i
;

4211 
ªsour˚
 *
r
 = 
iﬂpic_ªsour˚s
;

4213 i‡(!
r
) {

4214 i‡(
ƒ_iﬂpics
 > 0)

4215 
	`¥ötk
(
KERN_ERR


4220 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4221 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
r
);

4222 
r
++;

4224 
	}
}

4226 
	$mp_föd_iﬂpic
(
u32
 
gsi
)

4228 
i
 = 0;

4231 
i
 = 0; i < 
ƒ_iﬂpics
; i++) {

4232 i‡((
gsi
 >
mp_gsi_routög
[
i
].
gsi_ba£
)

4233 && (
gsi
 <
mp_gsi_routög
[
i
].
gsi_íd
))

4234  
i
;

4237 
	`¥ötk
(
KERN_ERR
 "ERROR: U«bÀÅÿloˇã IOAPIC f‹ GSI %d\n", 
gsi
);

4239 
	}
}

4241 
	$mp_föd_iﬂpic_pö
(
iﬂpic
, 
u32
 
gsi
)

4243 i‡(
	`WARN_ON
(
iﬂpic
 == -1))

4245 i‡(
	`WARN_ON
(
gsi
 > 
mp_gsi_routög
[
iﬂpic
].
gsi_íd
))

4248  
gsi
 - 
mp_gsi_routög
[
iﬂpic
].
gsi_ba£
;

4249 
	}
}

4251 
	$bad_iﬂpic
(
addªss
)

4253 i‡(
ƒ_iﬂpics
 >
MAX_IO_APICS
) {

4254 
	`¥ötk
(
KERN_WARNING
 "WARING: Max # of I/O APICs (%d)Éxceeded "

4255 "(found %d), skùpög\n", 
MAX_IO_APICS
, 
ƒ_iﬂpics
);

4258 i‡(!
addªss
) {

4259 
	`¥ötk
(
KERN_WARNING
 "WARNING: Bogus (zero) I/O APICáddress"

4264 
	}
}

4266 
__öô
 
	$mp_ªgi°î_iﬂpic
(
id
, 
u32
 
addªss
, u32 
gsi_ba£
)

4268 
idx
 = 0;

4269 
íåõs
;

4271 i‡(
	`bad_iﬂpic
(
addªss
))

4274 
idx
 = 
ƒ_iﬂpics
;

4276 
mp_iﬂpics
[
idx
].
ty≥
 = 
MP_IOAPIC
;

4277 
mp_iﬂpics
[
idx
].
Êags
 = 
MPC_APIC_USABLE
;

4278 
mp_iﬂpics
[
idx
].
≠iˇddr
 = 
addªss
;

4280 
	`£t_fixm≠_noˇche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
addªss
);

4281 
mp_iﬂpics
[
idx
].
≠icid
 = 
	`io_≠ic_unique_id
(
id
);

4282 
mp_iﬂpics
[
idx
].
≠icvî
 = 
	`io_≠ic_gë_vîsi⁄
(idx);

4288 
íåõs
 = 
	`io_≠ic_gë_ªdú_íåõs
(
idx
);

4289 
mp_gsi_routög
[
idx
].
gsi_ba£
 = gsi_base;

4290 
mp_gsi_routög
[
idx
].
gsi_íd
 = 
gsi_ba£
 + 
íåõs
 - 1;

4295 
ƒ_iﬂpic_ªgi°îs
[
idx
] = 
íåõs
;

4297 i‡(
mp_gsi_routög
[
idx
].
gsi_íd
 >
gsi_t›
)

4298 
gsi_t›
 = 
mp_gsi_routög
[
idx
].
gsi_íd
 + 1;

4300 
	`¥ötk
(
KERN_INFO
 "IOAPIC[%d]:ápic_id %d, version %d,áddress 0x%x, "

4301 "GSI %d-%d\n", 
idx
, 
mp_iﬂpics
[idx].
≠icid
,

4302 
mp_iﬂpics
[
idx
].
≠icvî
, mp_iﬂpics[idx].
≠iˇddr
,

4303 
mp_gsi_routög
[
idx
].
gsi_ba£
, mp_gsi_routög[idx].
gsi_íd
);

4305 
ƒ_iﬂpics
++;

4306 
	}
}

4309 
__öô
 
	$¥e_öô_≠ic_IRQ0
()

4311 
úq_cfg
 *
cfg
;

4312 
úq_desc
 *
desc
;

4314 
	`¥ötk
(
KERN_INFO
 "Early APIC setup for systemÅimer0\n");

4315 #i‚de‡
CONFIG_SMP


4316 
phys_˝u_¥e£¡_m≠
 = 
	`physid_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
);

4318 
desc
 = 
	`úq_to_desc_Æloc_node
(0, 0);

4320 
	`£tup_loˇl_APIC
();

4322 
cfg
 = 
	`úq_cfg
(0);

4323 
	`add_pö_to_úq_node
(
cfg
, 0, 0, 0);

4324 
	`£t_úq_chù_™d_h™dÀr_«me
(0, &
iﬂpic_chù
, 
h™dÀ_edge_úq
, "edge");

4326 
	`£tup_IO_APIC_úq
(0, 0, 0, 
desc
, 0, 0);

4327 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/ipi.c

1 
	~<löux/˝umask.h
>

2 
	~<löux/öãºu±.h
>

3 
	~<löux/öô.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/mc146818πc.h
>

10 
	~<löux/ˇche.h
>

11 
	~<löux/˝u.h
>

12 
	~<löux/moduÀ.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/mår.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/ùi.h
>

22 
	$deÁu…_£nd_IPI_mask_£quí˚_phys
(c⁄° 
˝umask
 *
mask
, 
ve˘‹
)

24 
quîy_˝u
;

25 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

33 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

34 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

35 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

40 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_phys
(c⁄° 
˝umask
 *
mask
,

41 
ve˘‹
)

43 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

44 
quîy_˝u
;

45 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

50 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

51 i‡(
quîy_˝u
 =
this_˝u
)

53 
	`__deÁu…_£nd_IPI_de°_fõld
(
	`≥r_˝u
(
x86_˝u_to_≠icid
,

54 
quîy_˝u
), 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
	$deÁu…_£nd_IPI_mask_£quí˚_logiˇl
(c⁄° 
˝umask
 *
mask
,

60 
ve˘‹
)

62 
Êags
;

63 
quîy_˝u
;

71 
	`loˇl_úq_ßve
(
Êags
);

72 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
)

73 
	`__deÁu…_£nd_IPI_de°_fõld
(

74 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

75 
≠ic
->
de°_logiˇl
);

76 
	`loˇl_úq_ª°‹e
(
Êags
);

77 
	}
}

79 
	$deÁu…_£nd_IPI_mask_Ælbut£lf_logiˇl
(c⁄° 
˝umask
 *
mask
,

80 
ve˘‹
)

82 
Êags
;

83 
quîy_˝u
;

84 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

88 
	`loˇl_úq_ßve
(
Êags
);

89 
	`f‹_óch_˝u
(
quîy_˝u
, 
mask
) {

90 i‡(
quîy_˝u
 =
this_˝u
)

92 
	`__deÁu…_£nd_IPI_de°_fõld
(

93 
≠ic
->
	`˝u_to_logiˇl_≠icid
(
quîy_˝u
), 
ve˘‹
,

94 
≠ic
->
de°_logiˇl
);

96 
	`loˇl_úq_ª°‹e
(
Êags
);

97 
	}
}

99 #ifde‡
CONFIG_X86_32


104 
	$deÁu…_£nd_IPI_mask_logiˇl
(c⁄° 
˝umask
 *˝umask, 
ve˘‹
)

106 
mask
 = 
	`˝umask_bôs
(
˝umask
)[0];

107 
Êags
;

109 i‡(
	`WARN_ONCE
(!
mask
, "empty IPI mask"))

112 
	`loˇl_úq_ßve
(
Êags
);

113 
	`WARN_ON
(
mask
 & ~
	`˝umask_bôs
(
˝u_⁄löe_mask
)[0]);

114 
	`__deÁu…_£nd_IPI_de°_fõld
(
mask
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

118 
	$deÁu…_£nd_IPI_Ælbut£lf
(
ve˘‹
)

124 i‡(!(
	`num_⁄löe_˝us
() > 1))

127 
	`__deÁu…_loˇl_£nd_IPI_Ælbut£lf
(
ve˘‹
);

128 
	}
}

130 
	$deÁu…_£nd_IPI_Æl
(
ve˘‹
)

132 
	`__deÁu…_loˇl_£nd_IPI_Æl
(
ve˘‹
);

133 
	}
}

135 
	$deÁu…_£nd_IPI_£lf
(
ve˘‹
)

137 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
≠ic
->
de°_logiˇl
);

138 
	}
}

141 
	$c⁄vît_≠icid_to_˝u
(
≠ic_id
)

143 
i
;

145 
	`f‹_óch_possibÀ_˝u
(
i
) {

146 i‡(
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
i
Ë=
≠ic_id
)

147  
i
;

150 
	}
}

152 
	$ß„_smp_¥o˚ss‹_id
()

154 
≠icid
, 
˝uid
;

156 i‡(!
˝u_has_≠ic
)

159 
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

160 i‡(
≠icid
 =
BAD_APICID
)

163 
˝uid
 = 
	`c⁄vît_≠icid_to_˝u
(
≠icid
);

165  
˝uid
 >= 0 ? cpuid : 0;

166 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/nmi.c

14 
	~<asm/≠ic.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/sysdev.h
>

23 
	~<löux/sys˘l.h
>

24 
	~<löux/≥r˝u.h
>

25 
	~<löux/k¥obes.h
>

26 
	~<löux/˝umask.h
>

27 
	~<löux/kî√l_°©.h
>

28 
	~<löux/kdebug.h
>

29 
	~<löux/smp.h
>

31 
	~<asm/i8259.h
>

32 
	~<asm/io_≠ic.h
>

33 
	~<asm/¥Ÿo.h
>

34 
	~<asm/timî.h
>

36 
	~<asm/m˚.h
>

38 
	~<asm/mach_å≠s.h
>

40 
	gunknown_nmi_∑nic
;

41 
	gnmi_w©chdog_íabÀd
;

44 
	$DECLARE_BITMAP
(
backåa˚_mask
, 
NR_CPUS
Ë
__ªad_mo°ly
;

52 
©omic_t
 
nmi_a˘ive
 = 
	`ATOMIC_INIT
(0);

53 
	`EXPORT_SYMBOL
(
nmi_a˘ive
);

55 
nmi_w©chdog
 = 
NMI_NONE
;

56 
	`EXPORT_SYMBOL
(
nmi_w©chdog
);

58 
∑nic_⁄_timeout
;

60 
nmi_hz
 = 
HZ
;

61 
	`DEFINE_PER_CPU
(, 
wd_íabÀd
);

62 
ídÊag
 
__öôd©a
;

64 
ölöe
 
	$gë_nmi_cou¡
(
˝u
)

66  
	`≥r_˝u
(
úq_°©
, 
˝u
).
__nmi_cou¡
;

67 
	}
}

69 
ölöe
 
	$m˚_ö_¥ogªss
()

71 #i‡
	`deföed
(
CONFIG_X86_MCE
)

72  
	`©omic_ªad
(&
m˚_íåy
) > 0;

75 
	}
}

81 
ölöe
 
	$gë_timî_úqs
(
˝u
)

83  
	`≥r_˝u
(
úq_°©
, 
˝u
).
≠ic_timî_úqs
 +

84 
	`≥r_˝u
(
úq_°©
, 
˝u
).
úq0_úqs
;

85 
	}
}

87 #ifde‡
CONFIG_SMP


93 
__öô
 
	$nmi_˝u_busy
(*
d©a
)

95 
	`loˇl_úq_íabÀ_ö_h¨dúq
();

104 
ídÊag
 == 0)

105 
	`mb
();

106 
	}
}

109 
	$ªp‹t_brokí_nmi
(
˝u
, *
¥ev_nmi_cou¡
)

111 
	`¥ötk
(
KERN_CONT
 "\n");

113 
	`¥ötk
(
KERN_WARNING


115 
˝u
, 
¥ev_nmi_cou¡
[˝u], 
	`gë_nmi_cou¡
(cpu));

117 
	`¥ötk
(
KERN_WARNING


119 
	`¥ötk
(
KERN_WARNING


122 
	`≥r_˝u
(
wd_íabÀd
, 
˝u
) = 0;

123 
	`©omic_dec
(&
nmi_a˘ive
);

124 
	}
}

126 
	$__a˝i_nmi_dißbÀ
(*
__unu£d
)

128 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
);

129 
	}
}

131 
__öô
 
	$check_nmi_w©chdog
()

133 *
¥ev_nmi_cou¡
;

134 
˝u
;

136 i‡(!
	`nmi_w©chdog_a˘ive
(Ë|| !
	`©omic_ªad
(&
nmi_a˘ive
))

139 
¥ev_nmi_cou¡
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

140 i‡(!
¥ev_nmi_cou¡
)

141 
îr‹
;

143 
	`¥ötk
(
KERN_INFO
 "Testing NMI watchdog ... ");

145 #ifde‡
CONFIG_SMP


146 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

147 
	`smp_ˇŒ_fun˘i⁄
(
nmi_˝u_busy
, (*)&
ídÊag
, 0);

150 
	`f‹_óch_possibÀ_˝u
(
˝u
)

151 
¥ev_nmi_cou¡
[
˝u
] = 
	`gë_nmi_cou¡
(cpu);

152 
	`loˇl_úq_íabÀ
();

153 
	`mdñay
((20 * 1000Ë/ 
nmi_hz
);

155 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

156 i‡(!
	`≥r_˝u
(
wd_íabÀd
, 
˝u
))

158 i‡(
	`gë_nmi_cou¡
(
˝u
Ë- 
¥ev_nmi_cou¡
[cpu] <= 5)

159 
	`ªp‹t_brokí_nmi
(
˝u
, 
¥ev_nmi_cou¡
);

161 
ídÊag
 = 1;

162 i‡(!
	`©omic_ªad
(&
nmi_a˘ive
)) {

163 
	`k‰ì
(
¥ev_nmi_cou¡
);

164 
	`©omic_£t
(&
nmi_a˘ive
, -1);

165 
îr‹
;

167 
	`¥ötk
("OK.\n");

173 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

174 
nmi_hz
 = 
	`œpic_adju°_nmi_hz
(1);

176 
	`k‰ì
(
¥ev_nmi_cou¡
);

178 
îr‹
:

179 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

180 i‡(!
timî_through_8259
)

181 
Àgacy_pic
->
chù
->
	`mask
(0);

182 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

185 #ifde‡
CONFIG_X86_32


186 
timî_ack
 = 0;

189 
	}
}

191 
__öô
 
	$£tup_nmi_w©chdog
(*
°r
)

193 
nmi
;

195 i‡(!
	`°∫cmp
(
°r
, "panic", 5)) {

196 
∑nic_⁄_timeout
 = 1;

197 
°r
 = 
	`°rchr
(str, ',');

198 i‡(!
°r
)

200 ++
°r
;

203 i‡(!
	`°∫cmp
(
°r
, "lapic", 5))

204 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

205 i‡(!
	`°∫cmp
(
°r
, "ioapic", 6))

206 
nmi_w©chdog
 = 
NMI_IO_APIC
;

208 
	`gë_›ti⁄
(&
°r
, &
nmi
);

209 i‡(
nmi
 >
NMI_INVALID
)

211 
nmi_w©chdog
 = 
nmi
;

215 
	}
}

216 
__£tup
("nmi_w©chdog=", 
£tup_nmi_w©chdog
);

221 #ifde‡
CONFIG_PM


223 
	gnmi_pm_a˘ive
;

225 
	$œpic_nmi_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

228 
nmi_pm_a˘ive
 = 
	`©omic_ªad
(&
nmi_a˘ive
);

229 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

230 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

232 
	}
}

234 
	$œpic_nmi_ªsume
(
sys_devi˚
 *
dev
)

237 i‡(
nmi_pm_a˘ive
 > 0) {

238 
	`£tup_≠ic_nmi_w©chdog
(
NULL
);

239 
	`touch_nmi_w©chdog
();

242 
	}
}

244 
sysdev_˛ass
 
	gnmi_sys˛ass
 = {

245 .
«me
 = "lapic_nmi",

246 .
	gªsume
 = 
œpic_nmi_ªsume
,

247 .
	gsu•íd
 = 
œpic_nmi_su•íd
,

250 
sys_devi˚
 
	gdevi˚_œpic_nmi
 = {

251 .
id
 = 0,

252 .
	g˛s
 = &
nmi_sys˛ass
,

255 
__öô
 
	$öô_œpic_nmi_sysfs
()

257 
îr‹
;

263 i‡(
nmi_w©chdog
 !
NMI_LOCAL_APIC
)

266 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) < 0)

269 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
nmi_sys˛ass
);

270 i‡(!
îr‹
)

271 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_œpic_nmi
);

272  
îr‹
;

273 
	}
}

276 
œã_öôˇŒ
(
öô_œpic_nmi_sysfs
);

280 
	$__a˝i_nmi_íabÀ
(*
__unu£d
)

282 
	`≠ic_wrôe
(
APIC_LVT0
, 
APIC_DM_NMI
);

283 
	}
}

288 
	$a˝i_nmi_íabÀ
()

290 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

291 
	`⁄_óch_˝u
(
__a˝i_nmi_íabÀ
, 
NULL
, 1);

292 
	}
}

297 
	$a˝i_nmi_dißbÀ
()

299 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë&& 
nmi_w©chdog
 =
NMI_IO_APIC
)

300 
	`⁄_óch_˝u
(
__a˝i_nmi_dißbÀ
, 
NULL
, 1);

301 
	}
}

307 
	$˝u_nmi_£t_wd_íabÀd
()

309 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

310 
	}
}

312 
	$£tup_≠ic_nmi_w©chdog
(*
unu£d
)

314 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
))

319 i‡(
	`smp_¥o˚ss‹_id
(Ë!0 && 
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

322 
nmi_w©chdog
) {

323 
NMI_LOCAL_APIC
:

324 i‡(
	`œpic_w©chdog_öô
(
nmi_hz
) < 0) {

325 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

329 
NMI_IO_APIC
:

330 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

331 
	`©omic_öc
(&
nmi_a˘ive
);

333 
	}
}

335 
	$°›_≠ic_nmi_w©chdog
(*
unu£d
)

338 i‡(!
	`nmi_w©chdog_a˘ive
())

340 i‡(
	`__gë_˝u_v¨
(
wd_íabÀd
) == 0)

342 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

343 
	`œpic_w©chdog_°›
();

345 
	`__a˝i_nmi_dißbÀ
(
NULL
);

346 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 0;

347 
	`©omic_dec
(&
nmi_a˘ive
);

348 
	}
}

364 
DEFINE_PER_CPU
(, 
œ°_úq_sum
);

365 
DEFINE_PER_CPU
(, 
Æît_cou¡î
);

366 
DEFINE_PER_CPU
(, 
nmi_touch
);

368 
	$touch_nmi_w©chdog
()

370 i‡(
	`nmi_w©chdog_a˘ive
()) {

371 
˝u
;

378 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

379 i‡(
	`≥r_˝u
(
nmi_touch
, 
˝u
) != 1)

380 
	`≥r_˝u
(
nmi_touch
, 
˝u
) = 1;

387 
	`touch_so·lockup_w©chdog
();

388 
	}
}

389 
EXPORT_SYMBOL
(
touch_nmi_w©chdog
);

391 
nŸø˚
 
__k¥obes
 

392 
	$nmi_w©chdog_tick
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

399 
sum
;

400 
touched
 = 0;

401 
˝u
 = 
	`smp_¥o˚ss‹_id
();

402 
rc
 = 0;

405 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

406 =
NOTIFY_STOP
) {

407 
rc
 = 1;

408 
touched
 = 1;

411 
sum
 = 
	`gë_timî_úqs
(
˝u
);

413 i‡(
	`__gë_˝u_v¨
(
nmi_touch
)) {

414 
	`__gë_˝u_v¨
(
nmi_touch
) = 0;

415 
touched
 = 1;

419 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
))) {

420 
	`DEFINE_RAW_SPINLOCK
(
lock
);

422 
	`øw_•ö_lock
(&
lock
);

423 
	`¥ötk
(
KERN_WARNING
 "NMI backåa˚ f‹ cpu %d\n", 
˝u
);

424 
	`show_ªgs
(
ªgs
);

425 
	`dump_°ack
();

426 
	`øw_•ö_u∆ock
(&
lock
);

427 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
backåa˚_mask
));

429 
rc
 = 1;

433 i‡(
	`m˚_ö_¥ogªss
())

434 
touched
 = 1;

437 i‡(!
touched
 && 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë=
sum
) {

442 
	`__this_˝u_öc
(
Æît_cou¡î
);

443 i‡(
	`__this_˝u_ªad
(
Æît_cou¡î
Ë=5 * 
nmi_hz
)

447 
	`dõ_nmi
("BUG: NMI Watchdog detected LOCKUP",

448 
ªgs
, 
∑nic_⁄_timeout
);

450 
	`__gë_˝u_v¨
(
œ°_úq_sum
Ë
sum
;

451 
	`__this_˝u_wrôe
(
Æît_cou¡î
, 0);

455 i‡(!
	`__gë_˝u_v¨
(
wd_íabÀd
))

456  
rc
;

457 
nmi_w©chdog
) {

458 
NMI_LOCAL_APIC
:

459 
rc
 |
	`œpic_wd_evít
(
nmi_hz
);

461 
NMI_IO_APIC
:

467 
rc
 = 1;

470  
rc
;

471 
	}
}

473 #ifde‡
CONFIG_SYSCTL


475 
	$íabÀ_iﬂpic_nmi_w©chdog_sögÀ
(*
unu£d
)

477 
	`__gë_˝u_v¨
(
wd_íabÀd
) = 1;

478 
	`©omic_öc
(&
nmi_a˘ive
);

479 
	`__a˝i_nmi_íabÀ
(
NULL
);

480 
	}
}

482 
	$íabÀ_iﬂpic_nmi_w©chdog
()

484 
	`⁄_óch_˝u
(
íabÀ_iﬂpic_nmi_w©chdog_sögÀ
, 
NULL
, 1);

485 
	`touch_nmi_w©chdog
();

486 
	}
}

488 
	$dißbÀ_iﬂpic_nmi_w©chdog
()

490 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

491 
	}
}

493 
__öô
 
	$£tup_unknown_nmi_∑nic
(*
°r
)

495 
unknown_nmi_∑nic
 = 1;

497 
	}
}

498 
__£tup
("unknown_nmi_∑nic", 
£tup_unknown_nmi_∑nic
);

500 
	$unknown_nmi_∑nic_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

502 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

503 
buf
[64];

505 
	`•rötf
(
buf
, "NMIÑe˚ived f‹ unknow¿ªas⁄ %02x\n", 
ªas⁄
);

506 
	`dõ_nmi
(
buf
, 
ªgs
, 1);

508 
	}
}

513 
	$¥oc_nmi_íabÀd
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

514 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

516 
ﬁd_°©e
;

518 
nmi_w©chdog_íabÀd
 = (
	`©omic_ªad
(&
nmi_a˘ive
) > 0) ? 1 : 0;

519 
ﬁd_°©e
 = 
nmi_w©chdog_íabÀd
;

520 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
buf„r
, 
Àngth
, 
µos
);

521 i‡(!!
ﬁd_°©e
 =!!
nmi_w©chdog_íabÀd
)

524 i‡(
	`©omic_ªad
(&
nmi_a˘ive
Ë< 0 || !
	`nmi_w©chdog_a˘ive
()) {

525 
	`¥ötk
(
KERN_WARNING


527  -
EIO
;

530 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
) {

531 i‡(
nmi_w©chdog_íabÀd
)

532 
	`íabÀ_œpic_nmi_w©chdog
();

534 
	`dißbÀ_œpic_nmi_w©chdog
();

535 } i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

536 i‡(
nmi_w©chdog_íabÀd
)

537 
	`íabÀ_iﬂpic_nmi_w©chdog
();

539 
	`dißbÀ_iﬂpic_nmi_w©chdog
();

541 
	`¥ötk
(
KERN_WARNING


543  -
EIO
;

546 
	}
}

550 
	$do_nmi_ˇŒback
(
±_ªgs
 *
ªgs
, 
˝u
)

552 #ifde‡
CONFIG_SYSCTL


553 i‡(
unknown_nmi_∑nic
)

554  
	`unknown_nmi_∑nic_ˇŒback
(
ªgs
, 
˝u
);

557 
	}
}

559 
	$¨ch_åiggî_Æl_˝u_backåa˚
()

561 
i
;

563 
	`˝umask_c›y
(
	`to_˝umask
(
backåa˚_mask
), 
˝u_⁄löe_mask
);

565 
	`¥ötk
(
KERN_INFO
 "sending NMIÅoáll CPUs:\n");

566 
≠ic
->
	`£nd_IPI_Æl
(
NMI_VECTOR
);

569 
i
 = 0; i < 10 * 1000; i++) {

570 i‡(
	`˝umask_em±y
(
	`to_˝umask
(
backåa˚_mask
)))

572 
	`mdñay
(1);

574 
	}
}

	@/cmpt816/linux/arch/x86/kernel/apic/probe_64.c

11 
	~<löux/thªads.h
>

12 
	~<löux/˝umask.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/˘y≥.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/dm¨.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/ùi.h
>

24 
	~<asm/£tup.h
>

26 
≠ic
 
≠ic_Ê©
;

27 
≠ic
 
≠ic_physÊ©
;

28 
≠ic
 
≠ic_x2xpic_uv_x
;

29 
≠ic
 
≠ic_x2≠ic_phys
;

30 
≠ic
 
≠ic_x2≠ic_˛u°î
;

32 
≠ic
 
__ªad_mo°ly
 *
	g≠ic
 = &
≠ic_Ê©
;

33 
EXPORT_SYMBOL_GPL
(
≠ic
);

35 
≠ic
 *
	g≠ic_¥obe
[] 
	g__öôd©a
 = {

36 #ifde‡
CONFIG_X86_UV


37 &
≠ic_x2≠ic_uv_x
,

39 #ifde‡
CONFIG_X86_X2APIC


40 &
≠ic_x2≠ic_phys
,

41 &
≠ic_x2≠ic_˛u°î
,

43 &
≠ic_physÊ©
,

44 
NULL
,

47 
	$≠icid_phys_pkg_id
(
öôül_≠ic_id
, 
ödex_msb
)

49  
	`h¨d_smp_¥o˚ss‹_id
(Ë>> 
ödex_msb
;

50 
	}
}

55 
__öô
 
	$deÁu…_£tup_≠ic_routög
()

57 #ifde‡
CONFIG_X86_X2APIC


58 i‡(
x2≠ic_mode


59 #ifde‡
CONFIG_X86_UV


60 && 
≠ic
 !&
≠ic_x2≠ic_uv_x


63 i‡(
x2≠ic_phys
)

64 
≠ic
 = &
≠ic_x2≠ic_phys
;

66 
≠ic
 = &
≠ic_x2≠ic_˛u°î
;

70 i‡(
≠ic
 =&
≠ic_Ê©
 && 
	`num_possibÀ_˝us
() > 8)

71 
≠ic
 = &
≠ic_physÊ©
;

73 
	`¥ötk
(
KERN_INFO
 "Sëtög APICÑoutögÅÿ%s\n", 
≠ic
->
«me
);

75 i‡(
	`is_vsmp_box
()) {

77 
≠ic
->
phys_pkg_id
 = 
≠icid_phys_pkg_id
;

84 i‡(
öå_ªm≠pög_íabÀd
)

85 
	`íabÀ_drhd_Áu…_h™dlög
();

86 
	}
}

90 
	$≠ic_£nd_IPI_£lf
(
ve˘‹
)

92 
	`__deÁu…_£nd_IPI_sh‹tcut
(
APIC_DEST_SELF
, 
ve˘‹
, 
APIC_DEST_PHYSICAL
);

93 
	}
}

95 
__öô
 
	$deÁu…_a˝i_madt_€m_check
(*
€m_id
, *
€m_èbÀ_id
)

97 
i
;

99 
i
 = 0; 
≠ic_¥obe
[i]; ++i) {

100 i‡(
≠ic_¥obe
[
i
]->
	`a˝i_madt_€m_check
(
€m_id
, 
€m_èbÀ_id
)) {

101 
≠ic
 = 
≠ic_¥obe
[
i
];

102 
	`¥ötk
(
KERN_INFO
 "Setting APICÑoutingÅo %s.\n",

103 
≠ic
->
«me
);

108 
	}
}

	@/cmpt816/linux/arch/x86/kernel/audit_64.c

1 
	~<löux/öô.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/audô.h
>

4 
	~<asm/uni°d.h
>

6 
	gdú_˛ass
[] = {

7 
	~<asm-gíîic/audô_dú_wrôe.h
>

11 
	gªad_˛ass
[] = {

12 
	~<asm-gíîic/audô_ªad.h
>

16 
	gwrôe_˛ass
[] = {

17 
	~<asm-gíîic/audô_wrôe.h
>

21 
	gch©å_˛ass
[] = {

22 
	~<asm-gíîic/audô_ch™ge_©å.h
>

26 
	gsig«l_˛ass
[] = {

27 
	~<asm-gíîic/audô_sig«l.h
>

31 
	$audô_˛assify_¨ch
(
¨ch
)

33 #ifde‡
CONFIG_IA32_EMULATION


34 i‡(
¨ch
 =
AUDIT_ARCH_I386
)

38 
	}
}

40 
	$audô_˛assify_sysˇŒ
(
abi
, 
sysˇŒ
)

42 #ifde‡
CONFIG_IA32_EMULATION


43 
	`ü32_˛assify_sysˇŒ
();

44 i‡(
abi
 =
AUDIT_ARCH_I386
)

45  
	`ü32_˛assify_sysˇŒ
(
sysˇŒ
);

47 
sysˇŒ
) {

48 
__NR_›í
:

50 
__NR_›í©
:

52 
__NR_execve
:

57 
	}
}

59 
__öô
 
	$audô_˛as£s_öô
()

61 #ifde‡
CONFIG_IA32_EMULATION


62 
__u32
 
ü32_dú_˛ass
[];

63 
__u32
 
ü32_wrôe_˛ass
[];

64 
__u32
 
ü32_ªad_˛ass
[];

65 
__u32
 
ü32_ch©å_˛ass
[];

66 
__u32
 
ü32_sig«l_˛ass
[];

67 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE_32
, 
ü32_wrôe_˛ass
);

68 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ_32
, 
ü32_ªad_˛ass
);

69 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE_32
, 
ü32_dú_˛ass
);

70 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR_32
, 
ü32_ch©å_˛ass
);

71 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL_32
, 
ü32_sig«l_˛ass
);

73 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_WRITE
, 
wrôe_˛ass
);

74 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_READ
, 
ªad_˛ass
);

75 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_DIR_WRITE
, 
dú_˛ass
);

76 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_CHATTR
, 
ch©å_˛ass
);

77 
	`audô_ªgi°î_˛ass
(
AUDIT_CLASS_SIGNAL
, 
sig«l_˛ass
);

79 
	}
}

81 
__öôˇŒ
(
audô_˛as£s_öô
);

	@/cmpt816/linux/arch/x86/kernel/bootflag.c

4 
	~<löux/ty≥s.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/•ölock.h
>

9 
	~<löux/a˝i.h
>

10 
	~<asm/io.h
>

12 
	~<löux/mc146818πc.h
>

14 
	#SBF_RESERVED
 (0x78)

	)

15 
	#SBF_PNPOS
 (1<<0)

	)

16 
	#SBF_BOOTING
 (1<<1)

	)

17 
	#SBF_DIAG
 (1<<2)

	)

18 
	#SBF_PARITY
 (1<<7)

	)

20 
sbf_p‹t
 
	g__öôd©a
 = -1;

22 
__öô
 
	$∑rôy
(
u8
 
v
)

24 
x
 = 0;

25 
i
;

27 
i
 = 0; i < 8; i++) {

28 
x
 ^(
v
 & 1);

29 
v
 >>= 1;

32  
x
;

33 
	}
}

35 
__öô
 
	$sbf_wrôe
(
u8
 
v
)

37 
Êags
;

39 i‡(
sbf_p‹t
 != -1) {

40 
v
 &~
SBF_PARITY
;

41 i‡(!
	`∑rôy
(
v
))

42 
v
 |
SBF_PARITY
;

44 
	`¥ötk
(
KERN_INFO
 "Simple Boot Flagát 0x%x setÅo 0x%x\n",

45 
sbf_p‹t
, 
v
);

47 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

48 
	`CMOS_WRITE
(
v
, 
sbf_p‹t
);

49 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

51 
	}
}

53 
u8
 
__öô
 
	$sbf_ªad
()

55 
Êags
;

56 
u8
 
v
;

58 i‡(
sbf_p‹t
 == -1)

61 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

62 
v
 = 
	`CMOS_READ
(
sbf_p‹t
);

63 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

65  
v
;

66 
	}
}

68 
__öô
 
	$sbf_vÆue_vÆid
(
u8
 
v
)

70 i‡(
v
 & 
SBF_RESERVED
)

72 i‡(!
	`∑rôy
(
v
))

76 
	}
}

78 
__öô
 
	$sbf_öô
()

80 
u8
 
v
;

82 i‡(
sbf_p‹t
 == -1)

85 
v
 = 
	`sbf_ªad
();

86 i‡(!
	`sbf_vÆue_vÆid
(
v
)) {

87 
	`¥ötk
(
KERN_WARNING
 "Simple Boot Flag value 0x%xÑead from "

88 "CMOS RAM wa†övÆid\n", 
v
);

91 
v
 &~
SBF_RESERVED
;

92 
v
 &~
SBF_BOOTING
;

93 
v
 &~
SBF_DIAG
;

94 #i‡
	`deföed
(
CONFIG_ISAPNP
)

95 
v
 |
SBF_PNPOS
;

97 
	`sbf_wrôe
(
v
);

100 
	}
}

101 
moduÀ_öô
(
sbf_öô
);

	@/cmpt816/linux/arch/x86/kernel/check.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/kthªad.h
>

4 
	~<löux/w‹kqueue.h
>

5 
	~<asm/e820.h
>

6 
	~<asm/¥Ÿo.h
>

14 
	#MAX_SCAN_AREAS
 8

	)

16 
__ªad_mo°ly
 
	gmem‹y_c‹ru±i⁄_check
 = -1;

18 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_size
 = 64*1024;

19 
__ªad_mo°ly
 
	gc‹ru±i⁄_check_≥riod
 = 60;

21 
e820íåy
 
	gsˇn_¨ós
[
MAX_SCAN_AREAS
];

22 
	gnum_sˇn_¨ós
;

25 
__öô
 
	$£t_c‹ru±i⁄_check
(*
¨g
)

27 *
íd
;

29 
mem‹y_c‹ru±i⁄_check
 = 
	`sim∂e_°πﬁ
(
¨g
, &
íd
, 10);

31  (*
íd
 =0Ë? 0 : -
EINVAL
;

32 
	}
}

33 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check", 
£t_c‹ru±i⁄_check
);

35 
__öô
 
	$£t_c‹ru±i⁄_check_≥riod
(*
¨g
)

37 *
íd
;

39 
c‹ru±i⁄_check_≥riod
 = 
	`sim∂e_°πoul
(
¨g
, &
íd
, 10);

41  (*
íd
 =0Ë? 0 : -
EINVAL
;

42 
	}
}

43 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_≥riod", 
£t_c‹ru±i⁄_check_≥riod
);

45 
__öô
 
	$£t_c‹ru±i⁄_check_size
(*
¨g
)

47 *
íd
;

48 
size
;

50 
size
 = 
	`mem∑r£
(
¨g
, &
íd
);

52 i‡(*
íd
 == '\0')

53 
c‹ru±i⁄_check_size
 = 
size
;

55  (
size
 =
c‹ru±i⁄_check_size
Ë? 0 : -
EINVAL
;

56 
	}
}

57 
óæy_∑øm
("mem‹y_c‹ru±i⁄_check_size", 
£t_c‹ru±i⁄_check_size
);

60 
__öô
 
	$£tup_bios_c‹ru±i⁄_check
()

62 
u64
 
addr
 = 
PAGE_SIZE
;

64 i‡(
mem‹y_c‹ru±i⁄_check
 == -1) {

65 
mem‹y_c‹ru±i⁄_check
 =

66 #ifde‡
CONFIG_X86_BOOTPARAM_MEMORY_CORRUPTION_CHECK


74 i‡(
c‹ru±i⁄_check_size
 == 0)

75 
mem‹y_c‹ru±i⁄_check
 = 0;

77 i‡(!
mem‹y_c‹ru±i⁄_check
)

80 
c‹ru±i⁄_check_size
 = 
	`round_up
(c‹ru±i⁄_check_size, 
PAGE_SIZE
);

82 
addr
 < 
c‹ru±i⁄_check_size
 && 
num_sˇn_¨ós
 < 
MAX_SCAN_AREAS
) {

83 
u64
 
size
;

84 
addr
 = 
	`föd_e820_¨ó_size
◊ddr, &
size
, 
PAGE_SIZE
);

86 i‡(!(
addr
 + 1))

89 i‡(
addr
 >
c‹ru±i⁄_check_size
)

92 i‡((
addr
 + 
size
Ë> 
c‹ru±i⁄_check_size
)

93 
size
 = 
c‹ru±i⁄_check_size
 - 
addr
;

95 
	`e820_upd©e_ønge
(
addr
, 
size
, 
E820_RAM
, 
E820_RESERVED
);

96 
sˇn_¨ós
[
num_sˇn_¨ós
].
addr
 =áddr;

97 
sˇn_¨ós
[
num_sˇn_¨ós
].
size
 = size;

98 
num_sˇn_¨ós
++;

101 
	`mem£t
(
	`__va
(
addr
), 0, 
size
);

103 
addr
 +
size
;

106 
	`¥ötk
(
KERN_INFO
 "Scanning %dáreas forÜow memory corruption\n",

107 
num_sˇn_¨ós
);

108 
	`upd©e_e820
();

109 
	}
}

112 
	$check_f‹_bios_c‹ru±i⁄
()

114 
i
;

115 
c‹ru±i⁄
 = 0;

117 i‡(!
mem‹y_c‹ru±i⁄_check
)

120 
i
 = 0; i < 
num_sˇn_¨ós
; i++) {

121 *
addr
 = 
	`__va
(
sˇn_¨ós
[
i
].addr);

122 
size
 = 
sˇn_¨ós
[
i
].size;

124 ; 
size
; 
addr
++, size -= ()) {

125 i‡(!*
addr
)

127 
	`¥ötk
(
KERN_ERR
 "CorruptedÜow memoryát %p (%lxÖhys) = %08lx\n",

128 
addr
, 
	`__∑
(addr), *addr);

129 
c‹ru±i⁄
 = 1;

130 *
addr
 = 0;

134 
	`WARN_ONCE
(
c‹ru±i⁄
, 
KERN_ERR
 "Memory corruption detected inÜow memory\n");

135 
	}
}

137 
check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
);

138 
DECLARE_DELAYED_WORK
(
bios_check_w‹k
, 
check_c‹ru±i⁄
);

140 
	$check_c‹ru±i⁄
(
w‹k_°ru˘
 *
dummy
)

142 
	`check_f‹_bios_c‹ru±i⁄
();

143 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
,

144 
	`round_jiffõs_ªœtive
(
c‹ru±i⁄_check_≥riod
*
HZ
));

145 
	}
}

147 
	$°¨t_≥riodic_check_f‹_c‹ru±i⁄
()

149 i‡(!
mem‹y_c‹ru±i⁄_check
 || 
c‹ru±i⁄_check_≥riod
 == 0)

152 
	`¥ötk
(
KERN_INFO
 "Scanning forÜow memory corruptionÉvery %d seconds\n",

153 
c‹ru±i⁄_check_≥riod
);

156 
	`scheduÀ_dñayed_w‹k
(&
bios_check_w‹k
, 0);

158 
	}
}

160 
moduÀ_öô
(
°¨t_≥riodic_check_f‹_c‹ru±i⁄
);

	@/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c

5 
	~<löux/˝u.h
>

7 
	~<asm/∑t.h
>

8 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/≠ic.h
>

12 
	s˝uid_bô
 {

13 
u16
 
	m„©uª
;

14 
u8
 
	mªg
;

15 
u8
 
	mbô
;

16 
u32
 
	mÀvñ
;

19 
	e˝uid_ªgs
 {

20 
	mCR_EAX
 = 0,

21 
	mCR_ECX
,

22 
	mCR_EDX
,

23 
	mCR_EBX


26 
__˝uöô
 
	$öô_sˇâîed_˝uid_„©uªs
(
˝uöfo_x86
 *
c
)

28 
u32
 
max_Àvñ
;

29 
u32
 
ªgs
[4];

30 c⁄° 
˝uid_bô
 *
cb
;

32 c⁄° 
˝uid_bô
 
__˝uöôc⁄°
 
˝uid_bôs
[] = {

33 { 
X86_FEATURE_IDA
, 
CR_EAX
, 1, 0x00000006 },

34 { 
X86_FEATURE_ARAT
, 
CR_EAX
, 2, 0x00000006 },

35 { 
X86_FEATURE_APERFMPERF
, 
CR_ECX
, 0, 0x00000006 },

36 { 
X86_FEATURE_CPB
, 
CR_EDX
, 9, 0x80000007 },

37 { 
X86_FEATURE_NPT
, 
CR_EDX
, 0, 0x8000000a },

38 { 
X86_FEATURE_LBRV
, 
CR_EDX
, 1, 0x8000000a },

39 { 
X86_FEATURE_SVML
, 
CR_EDX
, 2, 0x8000000a },

40 { 
X86_FEATURE_NRIPS
, 
CR_EDX
, 3, 0x8000000a },

44 
cb
 = 
˝uid_bôs
; cb->
„©uª
; cb++) {

47 
max_Àvñ
 = 
	`˝uid_óx
(
cb
->
Àvñ
 & 0xffff0000);

48 i‡(
max_Àvñ
 < 
cb
->
Àvñ
 ||

49 
max_Àvñ
 > (
cb
->
Àvñ
 | 0xffff))

52 
	`˝uid
(
cb
->
Àvñ
, &
ªgs
[
CR_EAX
], &ªgs[
CR_EBX
],

53 &
ªgs
[
CR_ECX
], &ªgs[
CR_EDX
]);

55 i‡(
ªgs
[
cb
->
ªg
] & (1 << cb->
bô
))

56 
	`£t_˝u_ˇp
(
c
, 
cb
->
„©uª
);

58 
	}
}

61 
	#SMT_LEVEL
 0

	)

64 
	#INVALID_TYPE
 0

	)

65 
	#SMT_TYPE
 1

	)

66 
	#CORE_TYPE
 2

	)

68 
	#LEAFB_SUBTYPE
(
ecx
Ë((”cxË>> 8Ë& 0xff)

	)

69 
	#BITS_SHIFT_NEXT_LEVEL
(
óx
Ë(”axË& 0x1f)

	)

70 
	#LEVEL_MAX_SIBLINGS
(
ebx
Ë(”bxË& 0xffff)

	)

77 
__˝uöô
 
	$dëe˘_exãnded_t›ﬁogy
(
˝uöfo_x86
 *
c
)

79 #ifde‡
CONFIG_SMP


80 
óx
, 
ebx
, 
ecx
, 
edx
, 
sub_ödex
;

81 
ht_mask_width
, 
c‹e_∂us_mask_width
;

82 
c‹e_£À˘_mask
, 
c‹e_Àvñ_siblögs
;

83 
boﬁ
 
¥öãd
;

85 i‡(
c
->
˝uid_Àvñ
 < 0xb)

88 
	`˝uid_cou¡
(0xb, 
SMT_LEVEL
, &
óx
, &
ebx
, &
ecx
, &
edx
);

93 i‡(
ebx
 =0 || (
	`LEAFB_SUBTYPE
(
ecx
Ë!
SMT_TYPE
))

96 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XTOPOLOGY
);

101 
c
->
öôül_≠icid
 = 
edx
;

106 
c‹e_Àvñ_siblögs
 = 
smp_num_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

107 
c‹e_∂us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

109 
sub_ödex
 = 1;

111 
	`˝uid_cou¡
(0xb, 
sub_ödex
, &
óx
, &
ebx
, &
ecx
, &
edx
);

116 i‡(
	`LEAFB_SUBTYPE
(
ecx
Ë=
CORE_TYPE
) {

117 
c‹e_Àvñ_siblögs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

118 
c‹e_∂us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
óx
);

122 
sub_ödex
++;

123 } 
	`LEAFB_SUBTYPE
(
ecx
Ë!
INVALID_TYPE
);

125 
c‹e_£À˘_mask
 = (~(-1 << 
c‹e_∂us_mask_width
)Ë>> 
ht_mask_width
;

127 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ht_mask_width
)

128 & 
c‹e_£À˘_mask
;

129 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
c‹e_∂us_mask_width
);

133 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

135 
c
->
x86_max_c‹es
 = (
c‹e_Àvñ_siblögs
 / 
smp_num_siblögs
);

137 i‡(!
¥öãd
) {

138 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

139 
c
->
phys_¥oc_id
);

140 i‡(
c
->
x86_max_c‹es
 > 1)

141 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

142 
c
->
˝u_c‹e_id
);

143 
¥öãd
 = 1;

147 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/amd.c

1 
	~<löux/öô.h
>

2 
	~<löux/bô›s.h
>

3 
	~<löux/mm.h
>

5 
	~<löux/io.h
>

6 
	~<asm/¥o˚ss‹.h
>

7 
	~<asm/≠ic.h
>

8 
	~<asm/˝u.h
>

9 
	~<asm/pci-dúe˘.h
>

11 #ifde‡
CONFIG_X86_64


12 
	~<asm/numa_64.h
>

13 
	~<asm/mmc⁄fig.h
>

14 
	~<asm/ˇcheÊush.h
>

17 
	~"˝u.h
"

19 #ifde‡
CONFIG_X86_32


33 
vide
();

34 
__asm__
(".align 4\nvide:Ñet");

36 
__˝uöô
 
	$öô_amd_k5
(
˝uöfo_x86
 *
c
)

44 
	#CBAR
 (0xfffcË

	)

45 
	#CBAR_ENB
 (0x80000000)

	)

46 
	#CBAR_KEY
 (0X000000CB)

	)

47 i‡(
c
->
x86_modñ
 == 9 || c->x86_model == 10) {

48 i‡(
	`öl
(
CBAR
Ë& 
CBAR_ENB
)

49 
	`oué
(0 | 
CBAR_KEY
, 
CBAR
);

51 
	}
}

54 
__˝uöô
 
	$öô_amd_k6
(
˝uöfo_x86
 *
c
)

56 
u32
 
l
, 
h
;

57 
mbyãs
 = 
num_phy•ages
 >> (20-
PAGE_SHIFT
);

59 i‡(
c
->
x86_modñ
 < 6) {

61 i‡(
c
->
x86_modñ
 == 0) {

62 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_APIC
);

63 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PGE
);

68 i‡(
c
->
x86_modñ
 =6 && c->
x86_mask
 == 1) {

69 c⁄° 
K6_BUG_LOOP
 = 1000000;

70 
n
;

71 (*
f_vide
)();

72 
d
, 
d2
;

74 
	`¥ötk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

81 
n
 = 
K6_BUG_LOOP
;

82 
f_vide
 = 
vide
;

83 
	`rdts˛
(
d
);

84 
n
--)

85 
	`f_vide
();

86 
	`rdts˛
(
d2
);

87 
d
 = 
d2
-d;

89 i‡(
d
 > 20*
K6_BUG_LOOP
)

90 
	`¥ötk
(
KERN_CONT


93 
	`¥ötk
(
KERN_CONT
 "probably OK (after B9730xxxx).\n");

94 
	`¥ötk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

98 i‡(
c
->
x86_modñ
 < 8 ||

99 (
c
->
x86_modñ
 =8 && c->
x86_mask
 < 8)) {

101 i‡(
mbyãs
 > 508)

102 
mbyãs
 = 508;

104 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

105 i‡((
l
&0x0000FFFF) == 0) {

106 
Êags
;

107 
l
 = (1<<0)|((
mbyãs
/4)<<1);

108 
	`loˇl_úq_ßve
(
Êags
);

109 
	`wbövd
();

110 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

111 
	`loˇl_úq_ª°‹e
(
Êags
);

112 
	`¥ötk
(
KERN_INFO
 "Enabling old style K6 writeállocation for %d Mb\n",

113 
mbyãs
);

118 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 > 7) ||

119 
c
->
x86_modñ
 == 9 || c->x86_model == 13) {

122 i‡(
mbyãs
 > 4092)

123 
mbyãs
 = 4092;

125 
	`rdm§
(
MSR_K6_WHCR
, 
l
, 
h
);

126 i‡((
l
&0xFFFF0000) == 0) {

127 
Êags
;

128 
l
 = ((
mbyãs
>>2)<<22)|(1<<16);

129 
	`loˇl_úq_ßve
(
Êags
);

130 
	`wbövd
();

131 
	`wrm§
(
MSR_K6_WHCR
, 
l
, 
h
);

132 
	`loˇl_úq_ª°‹e
(
Êags
);

133 
	`¥ötk
(
KERN_INFO
 "EnablingÇew style K6 writeállocation for %d Mb\n",

134 
mbyãs
);

140 i‡(
c
->
x86_modñ
 == 10) {

145 
	}
}

147 
__˝uöô
 
	$amd_k7_smp_check
(
˝uöfo_x86
 *
c
)

149 #ifde‡
CONFIG_SMP


151 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

159 i‡((
c
->
x86_modñ
 =6Ë&& ((c->
x86_mask
 == 0) ||

160 (
c
->
x86_mask
 == 1)))

161 
vÆid_k7
;

164 i‡((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 == 0))

165 
vÆid_k7
;

174 i‡(((
c
->
x86_modñ
 =6Ë&& (c->
x86_mask
 >= 2)) ||

175 ((
c
->
x86_modñ
 =7Ë&& (c->
x86_mask
 >= 1)) ||

176 (
c
->
x86_modñ
 > 7))

177 i‡(
˝u_has_mp
)

178 
vÆid_k7
;

186 
	`WARN_ONCE
(1, "WARNING: This combination of AMD"

188 i‡(!
	`ã°_èöt
(
TAINT_UNSAFE_SMP
))

189 
	`add_èöt
(
TAINT_UNSAFE_SMP
);

191 
vÆid_k7
:

194 
	}
}

196 
__˝uöô
 
	$öô_amd_k7
(
˝uöfo_x86
 *
c
)

198 
u32
 
l
, 
h
;

205 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 10) {

206 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XMM
)) {

207 
	`¥ötk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

208 
	`rdm§
(
MSR_K7_HWCR
, 
l
, 
h
);

209 
l
 &= ~0x00008000;

210 
	`wrm§
(
MSR_K7_HWCR
, 
l
, 
h
);

211 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_XMM
);

220 i‡((
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 1) || (c->x86_model > 8)) {

221 
	`rdm§
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

222 i‡((
l
 & 0xfff00000) != 0x20000000) {

223 
	`¥ötk
(
KERN_INFO


225 
l
, ((l & 0x000fffff)|0x20000000));

226 
	`wrm§
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

230 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K7
);

232 
	`amd_k7_smp_check
(
c
);

233 
	}
}

236 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

237 
__˝uöô
 
	$√¨by_node
(
≠icid
)

239 
i
, 
node
;

241 
i
 = 
≠icid
 - 1; i >= 0; i--) {

242 
node
 = 
≠icid_to_node
[
i
];

243 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

244  
node
;

246 
i
 = 
≠icid
 + 1; i < 
MAX_LOCAL_APIC
; i++) {

247 
node
 = 
≠icid_to_node
[
i
];

248 i‡(
node
 !
NUMA_NO_NODE
 && 
	`node_⁄löe
(node))

249  
node
;

251  
	`fú°_node
(
node_⁄löe_m≠
);

252 
	}
}

259 #ifde‡
CONFIG_X86_HT


260 
__˝uöô
 
	$amd_fixup_dcm
(
˝uöfo_x86
 *
c
)

262 
vÆue
;

263 
u32
 
nodes
, 
c‹es_≥r_node
;

264 
˝u
 = 
	`smp_¥o˚ss‹_id
();

266 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_NODEID_MSR
))

270 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
))

273 
	`rdm§l
(
MSR_FAM10H_NODE_ID
, 
vÆue
);

275 
nodes
 = ((
vÆue
 >> 3) & 7) + 1;

276 i‡(
nodes
 == 1)

279 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_AMD_DCM
);

280 
c‹es_≥r_node
 = 
c
->
x86_max_c‹es
 / 
nodes
;

283 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
vÆue
 & 7;

286 
c
->
˝u_c‹e_id
 = c->˝u_c‹e_id % 
c‹es_≥r_node
;

287 
	}
}

294 
__˝uöô
 
	$amd_dëe˘_cmp
(
˝uöfo_x86
 *
c
)

296 #ifde‡
CONFIG_X86_HT


297 
bôs
;

298 
˝u
 = 
	`smp_¥o˚ss‹_id
();

300 
bôs
 = 
c
->
x86_c‹eid_bôs
;

302 
c
->
˝u_c‹e_id
 = c->
öôül_≠icid
 & ((1 << 
bôs
)-1);

304 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
 >> 
bôs
;

306 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
c
->
phys_¥oc_id
;

308 i‡((
c
->
x86
 =0x10Ë&& (c->
x86_modñ
 == 9))

309 
	`amd_fixup_dcm
(
c
);

311 
	}
}

313 
	$amd_gë_nb_id
(
˝u
)

315 
id
 = 0;

316 #ifde‡
CONFIG_SMP


317 
id
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

319  
id
;

320 
	}
}

321 
EXPORT_SYMBOL_GPL
(
amd_gë_nb_id
);

323 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

325 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

326 
˝u
 = 
	`smp_¥o˚ss‹_id
();

327 
node
;

328 
≠icid
 = 
c
->apicid;

330 
node
 = 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
);

332 i‡(
≠icid_to_node
[
≠icid
] !
NUMA_NO_NODE
)

333 
node
 = 
≠icid_to_node
[
≠icid
];

334 i‡(!
	`node_⁄löe
(
node
)) {

345 
ht_nodeid
 = 
c
->
öôül_≠icid
;

347 i‡(
ht_nodeid
 >= 0 &&

348 
≠icid_to_node
[
ht_nodeid
] !
NUMA_NO_NODE
)

349 
node
 = 
≠icid_to_node
[
ht_nodeid
];

351 i‡(!
	`node_⁄löe
(
node
))

352 
node
 = 
	`√¨by_node
(
≠icid
);

354 
	`numa_£t_node
(
˝u
, 
node
);

356 
	}
}

358 
__˝uöô
 
	$óæy_öô_amd_mc
(
˝uöfo_x86
 *
c
)

360 #ifde‡
CONFIG_X86_HT


361 
bôs
, 
ecx
;

364 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000008)

367 
ecx
 = 
	`˝uid_ecx
(0x80000008);

369 
c
->
x86_max_c‹es
 = (
ecx
 & 0xff) + 1;

372 
bôs
 = (
ecx
 >> 12) & 0xF;

375 i‡(
bôs
 == 0) {

376 (1 << 
bôs
Ë< 
c
->
x86_max_c‹es
)

377 
bôs
++;

380 
c
->
x86_c‹eid_bôs
 = 
bôs
;

382 
	}
}

384 
__˝uöô
 
	$óæy_öô_amd
(
˝uöfo_x86
 *
c
)

386 
	`óæy_öô_amd_mc
(
c
);

392 i‡(
c
->
x86_powî
 & (1 << 8)) {

393 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

394 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

397 #ifde‡
CONFIG_X86_64


398 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSCALL32
);

401 i‡(
c
->
x86
 == 5)

402 i‡(
c
->
x86_modñ
 == 13 || c->x86_model == 9 ||

403 (
c
->
x86_modñ
 =8 && c->
x86_mask
 >= 8))

404 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K6_MTRR
);

406 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_PCI
)

408 i‡(
˝u_has_≠ic
 && 
c
->
x86
 >= 0xf) {

409 
vÆ
;

410 
vÆ
 = 
	`ªad_pci_c⁄fig
(0, 24, 0, 0x68);

411 i‡((
vÆ
 & ((1 << 17) | (1 << 18))) == ((1 << 17) | (1 << 18)))

412 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EXTD_APICID
);

415 
	}
}

417 
__˝uöô
 
	$öô_amd
(
˝uöfo_x86
 *
c
)

419 #ifde‡
CONFIG_SMP


420 
vÆue
;

429 i‡(
c
->
x86
 == 0xf) {

430 
	`rdm§l
(
MSR_K7_HWCR
, 
vÆue
);

431 
vÆue
 |= 1 << 6;

432 
	`wrm§l
(
MSR_K7_HWCR
, 
vÆue
);

436 
	`óæy_öô_amd
(
c
);

442 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

444 #ifde‡
CONFIG_X86_64


446 i‡(
c
->
x86
 == 0xf) {

447 
u32
 
Àvñ
;

449 
Àvñ
 = 
	`˝uid_óx
(1);

450 i‡((
Àvñ
 >= 0x0f48 &&Üevel < 0x0f50) ||Üevel >= 0x0f58)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

458 i‡(
c
->
x86_modñ
 < 0x14 && 
	`˝u_has
(c, 
X86_FEATURE_LAHF_LM
)) {

459 
u64
 
vÆ
;

461 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_LAHF_LM
);

462 i‡(!
	`rdm§l_amd_ß„
(0xc001100d, &
vÆ
)) {

463 
vÆ
 &= ~(1ULL << 32);

464 
	`wrm§l_amd_ß„
(0xc001100d, 
vÆ
);

469 i‡(
c
->
x86
 == 0x10 || c->x86 == 0x11)

470 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

473 
c
->
≠icid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

482 
c
->
x86
) {

484 
	`öô_amd_k5
(
c
);

487 
	`öô_amd_k6
(
c
);

490 
	`öô_amd_k7
(
c
);

495 i‡(
c
->
x86
 < 6)

496 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_MCE
);

500 i‡(
c
->
x86
 >= 6)

501 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FXSAVE_LEAK
);

503 i‡(!
c
->
x86_modñ_id
[0]) {

504 
c
->
x86
) {

508 
	`°r˝y
(
c
->
x86_modñ_id
, "Hammer");

513 
	`˝u_dëe˘_ˇche_sizes
(
c
);

516 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

517 
	`amd_dëe˘_cmp
(
c
);

518 
	`§©_dëe˘_node
(
c
);

521 #ifde‡
CONFIG_X86_32


522 
	`dëe˘_ht
(
c
);

525 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000006) {

526 i‡((
c
->
x86
 >0x0fË&& (
	`˝uid_edx
(0x80000006) & 0xf000))

527 
num_ˇche_Àaves
 = 4;

529 
num_ˇche_Àaves
 = 3;

532 i‡(
c
->
x86
 >= 0xf && c->x86 <= 0x11)

533 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_K8
);

535 i‡(
˝u_has_xmm2
) {

537 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_MFENCE_RDTSC
);

540 #ifde‡
CONFIG_X86_64


541 i‡(
c
->
x86
 == 0x10) {

543 i‡(
c
 =&
boŸ_˝u_d©a
)

544 
	`check_íabÀ_amd_mmc⁄f_dmi
();

546 
	`Ám10h_check_íabÀ_mmcfg
();

549 i‡(
c
 =&
boŸ_˝u_d©a
 && c->
x86
 >= 0xf && c->x86 <= 0x11) {

550 
t£g
;

557 i‡(!
	`rdm§l_ß„
(
MSR_K8_TSEG_ADDR
, &
t£g
)) {

558 
	`¥ötk
(
KERN_DEBUG
 "t£g: %010Œx\n", 
t£g
);

559 i‡((
t£g
>>
PMD_SHIFT
) <

560 (
max_low_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) ||

561 ((
t£g
>>
PMD_SHIFT
) <

562 (
max_p‚_m≠≥d
>>(
PMD_SHIFT
-
PAGE_SHIFT
)) &&

563 (
t£g
>>
PMD_SHIFT
) >= (1ULL<<(32 - PMD_SHIFT))))

564 
	`£t_mem‹y_4k
(()
	`__va
(
t£g
), 1);

568 
	}
}

570 #ifde‡
CONFIG_X86_32


571 
__˝uöô
 
	$amd_size_ˇche
(
˝uöfo_x86
 *
c
,

572 
size
)

575 i‡((
c
->
x86
 == 6)) {

577 i‡(
c
->
x86_modñ
 =3 && c->
x86_mask
 == 0)

578 
size
 = 64;

580 i‡(
c
->
x86_modñ
 == 4 &&

581 (
c
->
x86_mask
 == 0 || c->x86_mask == 1))

582 
size
 = 256;

584  
size
;

585 
	}
}

588 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gamd_˝u_dev
 = {

589 .
c_víd‹
 = "AMD",

590 .
	gc_idít
 = { "AuthenticAMD" },

591 #ifde‡
CONFIG_X86_32


592 .
	gc_modñs
 = {

593 { .
víd‹
 = 
X86_VENDOR_AMD
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

604 .
	gc_size_ˇche
 = 
amd_size_ˇche
,

606 .
	gc_óæy_öô
 = 
óæy_öô_amd
,

607 .
	gc_öô
 = 
öô_amd
,

608 .
	gc_x86_víd‹
 = 
X86_VENDOR_AMD
,

611 
˝u_dev_ªgi°î
(
amd_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

8 
	~<asm/Æã∫©ive.h
>

9 
	~<asm/bugs.h
>

10 
	~<asm/¥o˚ss‹.h
>

11 
	~<asm/mår.h
>

12 
	~<asm/ˇcheÊush.h
>

14 
__öô
 
	$check_bugs
()

16 
	`idítify_boŸ_˝u
();

17 #i‡!
	`deföed
(
CONFIG_SMP
)

18 
	`¥ötk
(
KERN_INFO
 "CPU: ");

19 
	`¥öt_˝u_öfo
(&
boŸ_˝u_d©a
);

21 
	`Æã∫©ive_ö°ru˘i⁄s
();

31 i‡(!
dúe˘_gb∑ges
)

32 
	`£t_mem‹y_4k
(()
	`__va
(0), 1);

33 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/capflags.c

1 
	~<asm/˝u„©uª.h
>

3 c⁄° * c⁄° 
	gx86_ˇp_Êags
[
NCAPINTS
*32] = {

4 [
X86_FEATURE_FPU
] = "fpu",

5 [
X86_FEATURE_VME
] = "vme",

6 [
X86_FEATURE_DE
] = "de",

7 [
X86_FEATURE_PSE
] = "pse",

8 [
X86_FEATURE_TSC
] = "tsc",

9 [
X86_FEATURE_MSR
] = "msr",

10 [
X86_FEATURE_PAE
] = "pae",

11 [
X86_FEATURE_MCE
] = "mce",

12 [
X86_FEATURE_CX8
] = "cx8",

13 [
X86_FEATURE_APIC
] = "apic",

14 [
X86_FEATURE_SEP
] = "sep",

15 [
X86_FEATURE_MTRR
] = "mtrr",

16 [
X86_FEATURE_PGE
] = "pge",

17 [
X86_FEATURE_MCA
] = "mca",

18 [
X86_FEATURE_CMOV
] = "cmov",

19 [
X86_FEATURE_PAT
] = "pat",

20 [
X86_FEATURE_PSE36
] = "pse36",

21 [
X86_FEATURE_PN
] = "pn",

22 [
X86_FEATURE_CLFLSH
] = "clflush",

23 [
X86_FEATURE_DS
] = "dts",

24 [
X86_FEATURE_ACPI
] = "acpi",

25 [
X86_FEATURE_MMX
] = "mmx",

26 [
X86_FEATURE_FXSR
] = "fxsr",

27 [
X86_FEATURE_XMM
] = "sse",

28 [
X86_FEATURE_XMM2
] = "sse2",

29 [
X86_FEATURE_SELFSNOOP
] = "ss",

30 [
X86_FEATURE_HT
] = "ht",

31 [
X86_FEATURE_ACC
] = "tm",

32 [
X86_FEATURE_IA64
] = "ia64",

33 [
X86_FEATURE_PBE
] = "pbe",

34 [
X86_FEATURE_SYSCALL
] = "syscall",

35 [
X86_FEATURE_MP
] = "mp",

36 [
X86_FEATURE_NX
] = "nx",

37 [
X86_FEATURE_MMXEXT
] = "mmxext",

38 [
X86_FEATURE_FXSR_OPT
] = "fxsr_opt",

39 [
X86_FEATURE_GBPAGES
] = "pdpe1gb",

40 [
X86_FEATURE_RDTSCP
] = "rdtscp",

41 [
X86_FEATURE_LM
] = "lm",

42 [
X86_FEATURE_3DNOWEXT
] = "3dnowext",

43 [
X86_FEATURE_3DNOW
] = "3dnow",

44 [
X86_FEATURE_RECOVERY
] = "recovery",

45 [
X86_FEATURE_LONGRUN
] = "longrun",

46 [
X86_FEATURE_LRTI
] = "lrti",

47 [
X86_FEATURE_CXMMX
] = "cxmmx",

48 [
X86_FEATURE_K6_MTRR
] = "k6_mtrr",

49 [
X86_FEATURE_CYRIX_ARR
] = "cyrix_arr",

50 [
X86_FEATURE_CENTAUR_MCR
] = "centaur_mcr",

51 [
X86_FEATURE_CONSTANT_TSC
] = "constant_tsc",

52 [
X86_FEATURE_UP
] = "up",

53 [
X86_FEATURE_ARCH_PERFMON
] = "arch_perfmon",

54 [
X86_FEATURE_PEBS
] = "pebs",

55 [
X86_FEATURE_BTS
] = "bts",

56 [
X86_FEATURE_REP_GOOD
] = "rep_good",

57 [
X86_FEATURE_NOPL
] = "nopl",

58 [
X86_FEATURE_AMDC1E
] = "amdc1e",

59 [
X86_FEATURE_XTOPOLOGY
] = "xtopology",

60 [
X86_FEATURE_TSC_RELIABLE
] = "tsc_reliable",

61 [
X86_FEATURE_NONSTOP_TSC
] = "nonstop_tsc",

62 [
X86_FEATURE_EXTD_APICID
] = "extd_apicid",

63 [
X86_FEATURE_AMD_DCM
] = "amd_dcm",

64 [
X86_FEATURE_APERFMPERF
] = "aperfmperf",

65 [
X86_FEATURE_XMM3
] = "pni",

66 [
X86_FEATURE_PCLMULQDQ
] = "pclmulqdq",

67 [
X86_FEATURE_DTES64
] = "dtes64",

68 [
X86_FEATURE_MWAIT
] = "monitor",

69 [
X86_FEATURE_DSCPL
] = "ds_cpl",

70 [
X86_FEATURE_VMX
] = "vmx",

71 [
X86_FEATURE_SMX
] = "smx",

72 [
X86_FEATURE_EST
] = "est",

73 [
X86_FEATURE_TM2
] = "tm2",

74 [
X86_FEATURE_SSSE3
] = "ssse3",

75 [
X86_FEATURE_CID
] = "cid",

76 [
X86_FEATURE_FMA
] = "fma",

77 [
X86_FEATURE_CX16
] = "cx16",

78 [
X86_FEATURE_XTPR
] = "xtpr",

79 [
X86_FEATURE_PDCM
] = "pdcm",

80 [
X86_FEATURE_DCA
] = "dca",

81 [
X86_FEATURE_XMM4_1
] = "sse4_1",

82 [
X86_FEATURE_XMM4_2
] = "sse4_2",

83 [
X86_FEATURE_X2APIC
] = "x2apic",

84 [
X86_FEATURE_MOVBE
] = "movbe",

85 [
X86_FEATURE_POPCNT
] = "popcnt",

86 [
X86_FEATURE_AES
] = "aes",

87 [
X86_FEATURE_XSAVE
] = "xsave",

88 [
X86_FEATURE_AVX
] = "avx",

89 [
X86_FEATURE_HYPERVISOR
] = "hypervisor",

90 [
X86_FEATURE_XSTORE
] = "rng",

91 [
X86_FEATURE_XSTORE_EN
] = "rng_en",

92 [
X86_FEATURE_XCRYPT
] = "ace",

93 [
X86_FEATURE_XCRYPT_EN
] = "ace_en",

94 [
X86_FEATURE_ACE2
] = "ace2",

95 [
X86_FEATURE_ACE2_EN
] = "ace2_en",

96 [
X86_FEATURE_PHE
] = "phe",

97 [
X86_FEATURE_PHE_EN
] = "phe_en",

98 [
X86_FEATURE_PMM
] = "pmm",

99 [
X86_FEATURE_PMM_EN
] = "pmm_en",

100 [
X86_FEATURE_LAHF_LM
] = "lahf_lm",

101 [
X86_FEATURE_CMP_LEGACY
] = "cmp_legacy",

102 [
X86_FEATURE_SVM
] = "svm",

103 [
X86_FEATURE_EXTAPIC
] = "extapic",

104 [
X86_FEATURE_CR8_LEGACY
] = "cr8_legacy",

105 [
X86_FEATURE_ABM
] = "abm",

106 [
X86_FEATURE_SSE4A
] = "sse4a",

107 [
X86_FEATURE_MISALIGNSSE
] = "misalignsse",

108 [
X86_FEATURE_3DNOWPREFETCH
] = "3dnowprefetch",

109 [
X86_FEATURE_OSVW
] = "osvw",

110 [
X86_FEATURE_IBS
] = "ibs",

111 [
X86_FEATURE_SSE5
] = "sse5",

112 [
X86_FEATURE_SKINIT
] = "skinit",

113 [
X86_FEATURE_WDT
] = "wdt",

114 [
X86_FEATURE_NODEID_MSR
] = "nodeid_msr",

115 [
X86_FEATURE_IDA
] = "ida",

116 [
X86_FEATURE_ARAT
] = "arat",

117 [
X86_FEATURE_CPB
] = "cpb",

118 [
X86_FEATURE_TPR_SHADOW
] = "tpr_shadow",

119 [
X86_FEATURE_VNMI
] = "vnmi",

120 [
X86_FEATURE_FLEXPRIORITY
] = "flexpriority",

121 [
X86_FEATURE_EPT
] = "ept",

122 [
X86_FEATURE_VPID
] = "vpid",

123 [
X86_FEATURE_NPT
] = "npt",

124 [
X86_FEATURE_LBRV
] = "lbrv",

125 [
X86_FEATURE_SVML
] = "svm_lock",

126 [
X86_FEATURE_NRIPS
] = "nrip_save",

	@/cmpt816/linux/arch/x86/kernel/cpu/centaur.c

1 
	~<löux/bô›s.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/¥o˚ss‹.h
>

6 
	~<asm/e820.h
>

7 
	~<asm/mår.h
>

8 
	~<asm/m§.h
>

10 
	~"˝u.h
"

12 #ifde‡
CONFIG_X86_OOSTORE


14 
u32
 
__˝uöô
 
	$powî2
(
u32
 
x
)

16 
u32
 
s
 = 1;

18 
s
 <
x
)

19 
s
 <<= 1;

21  
s
 >>= 1;

22 
	}
}

28 
__˝uöô
 
	$˚¡aur_m¸_ö£π
(
ªg
, 
u32
 
ba£
, u32 
size
, 
key
)

30 
u32
 
lo
, 
hi
;

32 
hi
 = 
ba£
 & ~0xFFF;

33 
lo
 = ~(
size
-1);

34 
lo
 &= ~0xFFF;

35 
lo
 |
key
;

36 
	`wrm§
(
ªg
+
MSR_IDT_MCR0
, 
lo
, 
hi
);

37 
	`mår_˚¡aur_ªp‹t_m¸
(
ªg
, 
lo
, 
hi
);

38 
	}
}

45 
u32
 
__˝uöô
 
	$ømt›
()

47 
u32
 
˛ù
 = 0xFFFFFFFFUL;

48 
u32
 
t›
 = 0;

49 
i
;

51 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

52 
°¨t
, 
íd
;

54 i‡(
e820
.
m≠
[
i
].
addr
 > 0xFFFFFFFFUL)

60 i‡(
e820
.
m≠
[
i
].
ty≥
 =
E820_RESERVED
) {

61 i‡(
e820
.
m≠
[
i
].
addr
 >= 0x100000UL &&

62 
e820
.
m≠
[
i
].
addr
 < 
˛ù
)

63 
˛ù
 = 
e820
.
m≠
[
i
].
addr
;

66 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

67 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
;

68 i‡(
°¨t
 >
íd
)

70 i‡(
íd
 > 
t›
)

71 
t›
 = 
íd
;

85 i‡(
t›
 > 
˛ù
)

86 
t›
 = 
˛ù
;

88  
t›
;

89 
	}
}

94 
__˝uöô
 
	$˚¡aur_m¸_compuã
(
ƒ
, 
key
)

96 
u32
 
mem
 = 
	`ømt›
();

97 
u32
 
roŸ
 = 
	`powî2
(
mem
);

98 
u32
 
ba£
 = 
roŸ
;

99 
u32
 
t›
 = 
roŸ
;

100 
u32
 
Êo‹
 = 0;

101 
˘
 = 0;

103 
˘
 < 
ƒ
) {

104 
u32
 
f•a˚
 = 0;

105 
u32
 
high
;

106 
u32
 
low
;

111 
high
 = 
	`powî2
(
mem
-
t›
);

116 
low
 = 
ba£
/2;

122 i‡(
ba£
 <= 1024*1024)

123 
low
 = 0;

130 i‡(
Êo‹
 == 0)

131 
f•a˚
 = 512*1024;

132 i‡(
Êo‹
 == 512*1024)

133 
f•a˚
 = 128*1024;

140 i‡(
f•a˚
 > 
high
 && f•a˚ > 
low
) {

141 
	`˚¡aur_m¸_ö£π
(
˘
, 
Êo‹
, 
f•a˚
, 
key
);

142 
Êo‹
 +
f•a˚
;

143 } i‡(
high
 > 
low
) {

144 
	`˚¡aur_m¸_ö£π
(
˘
, 
t›
, 
high
, 
key
);

145 
t›
 +
high
;

146 } i‡(
low
 > 0) {

147 
ba£
 -
low
;

148 
	`˚¡aur_m¸_ö£π
(
˘
, 
ba£
, 
low
, 
key
);

151 
˘
++;

157  
˘
;

158 
	}
}

160 
__˝uöô
 
	$˚¡aur_¸óã_›timÆ_m¸
()

162 
u£d
;

163 
i
;

175 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 31);

180 
i
 = 
u£d
; i < 8; i++)

181 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

182 
	}
}

184 
__˝uöô
 
	$wöchù2_¸óã_›timÆ_m¸
()

186 
u32
 
lo
, 
hi
;

187 
u£d
;

188 
i
;

199 
u£d
 = 
	`˚¡aur_m¸_compuã
(6, 25);

204 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

205 
i
 = 0; i < 
u£d
; i++)

206 
lo
 |1<<(9+
i
);

207 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

213 
i
 = 
u£d
; i < 8; i++)

214 
	`wrm§
(
MSR_IDT_MCR0
+
i
, 0, 0);

215 
	}
}

220 
__˝uöô
 
	$wöchù2_u≈rŸe˘_m¸
()

222 
u32
 
lo
, 
hi
;

223 
u32
 
key
;

225 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

226 
lo
 &= ~0x1C0;

227 
key
 = (
lo
>>17) & 7;

228 
lo
 |
key
<<6;

229 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

230 
	}
}

232 
__˝uöô
 
	$wöchù2_¥Ÿe˘_m¸
()

234 
u32
 
lo
, 
hi
;

236 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

237 
lo
 &= ~0x1C0;

238 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

239 
	}
}

242 
	#ACE_PRESENT
 (1 << 6)

	)

243 
	#ACE_ENABLED
 (1 << 7)

	)

244 
	#ACE_FCR
 (1 << 28Ë

	)

246 
	#RNG_PRESENT
 (1 << 2)

	)

247 
	#RNG_ENABLED
 (1 << 3)

	)

248 
	#RNG_ENABLE
 (1 << 6Ë

	)

250 
__˝uöô
 
	$öô_c3
(
˝uöfo_x86
 *
c
)

252 
u32
 
lo
, 
hi
;

255 i‡(
	`˝uid_óx
(0xC0000000) >= 0xC0000001) {

256 
u32
 
tmp
 = 
	`˝uid_edx
(0xC0000001);

259 i‡((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

260 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

261 
lo
 |
ACE_FCR
;

262 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

263 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

267 i‡((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

268 
	`rdm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

269 
lo
 |
RNG_ENABLE
;

270 
	`wrm§
(
MSR_VIA_RNG
, 
lo
, 
hi
);

271 
	`¥ötk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

277 
c
->
x86_ˇ∑bûôy
[5] = 
	`˝uid_edx
(0xC0000001);

279 #ifde‡
CONFIG_X86_32


281 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model <= 9) {

282 
	`rdm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

283 
lo
 |= (1<<1 | 1<<7);

284 
	`wrm§
(
MSR_VIA_FCR
, 
lo
, 
hi
);

285 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

289 i‡(
c
->
x86_modñ
 >= 6 && c->x86_model < 9)

290 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

292 i‡(
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0xf) {

293 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

294 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

297 
	`˝u_dëe˘_ˇche_sizes
(
c
);

298 
	}
}

301 
	mECX8
 = 1<<1,

302 
	mEIERRINT
 = 1<<2,

303 
	mDPM
 = 1<<3,

304 
	mDMCE
 = 1<<4,

305 
	mDSTPCLK
 = 1<<5,

306 
	mELINEAR
 = 1<<6,

307 
	mDSMC
 = 1<<7,

308 
	mDTLOCK
 = 1<<8,

309 
	mEDCTLB
 = 1<<8,

310 
	mEMMX
 = 1<<9,

311 
	mDPDC
 = 1<<11,

312 
	mEBRPRED
 = 1<<12,

313 
	mDIC
 = 1<<13,

314 
	mDDC
 = 1<<14,

315 
	mDNA
 = 1<<15,

316 
	mERETSTK
 = 1<<16,

317 
	mE2MMX
 = 1<<19,

318 
	mEAMD3D
 = 1<<20,

321 
__˝uöô
 
	$óæy_öô_˚¡aur
(
˝uöfo_x86
 *
c
)

323 
c
->
x86
) {

324 #ifde‡
CONFIG_X86_32


327 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

331 i‡(
c
->
x86_modñ
 >= 0xf)

332 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

335 #ifde‡
CONFIG_X86_64


336 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

338 
	}
}

340 
__˝uöô
 
	$öô_˚¡aur
(
˝uöfo_x86
 *
c
)

342 #ifde‡
CONFIG_X86_32


343 *
«me
;

344 
u32
 
f¸_£t
 = 0;

345 
u32
 
f¸_˛r
 = 0;

346 
u32
 
lo
, 
hi
, 
√wlo
;

347 
u32
 
Ø
, 
bb
, 
cc
, 
dd
;

353 
	`˛ór_˝u_ˇp
(
c
, 0*32+31);

355 
	`óæy_öô_˚¡aur
(
c
);

356 
c
->
x86
) {

357 #ifde‡
CONFIG_X86_32


359 
c
->
x86_modñ
) {

361 
«me
 = "C6";

362 
f¸_£t
 = 
ECX8
|
DSMC
|
EDCTLB
|
EMMX
|
ERETSTK
;

363 
f¸_˛r
 = 
DPDC
;

364 
	`¥ötk
(
KERN_NOTICE
 "Disabling bugged TSC.\n");

365 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TSC
);

366 #ifde‡
CONFIG_X86_OOSTORE


367 
	`˚¡aur_¸óã_›timÆ_m¸
();

378 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 0x01F0001F, 0);

382 
c
->
x86_mask
) {

384 
«me
 = "2";

387 
«me
 = "2A";

390 
«me
 = "2B";

393 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

394 
E2MMX
|
EAMD3D
;

395 
f¸_˛r
 = 
DPDC
;

396 #ifde‡
CONFIG_X86_OOSTORE


397 
	`wöchù2_u≈rŸe˘_m¸
();

398 
	`wöchù2_¸óã_›timÆ_m¸
();

399 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

406 
lo
 |= 31;

407 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

408 
	`wöchù2_¥Ÿe˘_m¸
();

412 
«me
 = "3";

413 
f¸_£t
 = 
ECX8
|
DSMC
|
DTLOCK
|
EMMX
|
EBRPRED
|
ERETSTK
|

414 
E2MMX
|
EAMD3D
;

415 
f¸_˛r
 = 
DPDC
;

416 #ifde‡
CONFIG_X86_OOSTORE


417 
	`wöchù2_u≈rŸe˘_m¸
();

418 
	`wöchù2_¸óã_›timÆ_m¸
();

419 
	`rdm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

426 
lo
 |= 31;

427 
	`wrm§
(
MSR_IDT_MCR_CTRL
, 
lo
, 
hi
);

428 
	`wöchù2_¥Ÿe˘_m¸
();

432 
«me
 = "??";

435 
	`rdm§
(
MSR_IDT_FCR1
, 
lo
, 
hi
);

436 
√wlo
 = (
lo
|
f¸_£t
Ë& (~
f¸_˛r
);

438 i‡(
√wlo
 !
lo
) {

439 
	`¥ötk
(
KERN_INFO
 "Centaur FCR was 0x%XÇow 0x%X\n",

440 
lo
, 
√wlo
);

441 
	`wrm§
(
MSR_IDT_FCR1
, 
√wlo
, 
hi
);

443 
	`¥ötk
(
KERN_INFO
 "Cíèu∏FCR i†0x%X\n", 
lo
);

446 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CENTAUR_MCR
);

448 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CX8
);

450 i‡(
c
->
x86_modñ
 >= 8)

451 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_3DNOW
);

453 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000005) {

455 
	`˝uid
(0x80000005, &
Ø
, &
bb
, &
cc
, &
dd
);

457 
c
->
x86_ˇche_size
 = (
cc
>>24)+(
dd
>>24);

459 
	`•rötf
(
c
->
x86_modñ_id
, "WöChù %s", 
«me
);

463 
	`öô_c3
(
c
);

466 #ifde‡
CONFIG_X86_64


467 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

469 
	}
}

471 
__˝uöô


472 
	$˚¡aur_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

474 #ifde‡
CONFIG_X86_32


476 i‡((
c
->
x86
 =6Ë&& ((c->
x86_modñ
 == 7) || (c->x86_model == 8)))

477 
size
 >>= 8;

484 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 == 9) &&

485 (
c
->
x86_mask
 =1Ë&& (
size
 == 65))

486 
size
 -= 1;

488  
size
;

489 
	}
}

491 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	g˚¡aur_˝u_dev
 = {

492 .
c_víd‹
 = "Centaur",

493 .
	gc_idít
 = { "CentaurHauls" },

494 .
	gc_óæy_öô
 = 
óæy_öô_˚¡aur
,

495 .
	gc_öô
 = 
öô_˚¡aur
,

496 .
	gc_size_ˇche
 = 
˚¡aur_size_ˇche
,

497 .
	gc_x86_víd‹
 = 
X86_VENDOR_CENTAUR
,

500 
˝u_dev_ªgi°î
(
˚¡aur_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/common.c

1 
	~<löux/boŸmem.h
>

2 
	~<löux/lökage.h
>

3 
	~<löux/bô›s.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/≥r˝u.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kgdb.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/io.h
>

15 
	~<asm/°ack¥Ÿe˘‹.h
>

16 
	~<asm/≥rf_evít.h
>

17 
	~<asm/mmu_c⁄ãxt.h
>

18 
	~<asm/hy≥rvis‹.h
>

19 
	~<asm/¥o˚ss‹.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<löux/t›ﬁogy.h
>

22 
	~<löux/˝umask.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/≠ic.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/mår.h
>

31 
	~<löux/numa.h
>

32 
	~<asm/asm.h
>

33 
	~<asm/˝u.h
>

34 
	~<asm/m˚.h
>

35 
	~<asm/m§.h
>

36 
	~<asm/∑t.h
>

38 #ifde‡
CONFIG_X86_LOCAL_APIC


39 
	~<asm/uv/uv.h
>

42 
	~"˝u.h
"

45 
˝umask_v¨_t
 
	g˝u_öôülized_mask
;

46 
˝umask_v¨_t
 
	g˝u_ˇŒout_mask
;

47 
˝umask_v¨_t
 
	g˝u_ˇŒö_mask
;

50 
˝umask_v¨_t
 
	g˝u_siblög_£tup_mask
;

53 
__öô
 
	$£tup_˝u_loˇl_masks
()

55 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_öôülized_mask
);

56 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒö_mask
);

57 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_ˇŒout_mask
);

58 
	`Æloc_boŸmem_˝umask_v¨
(&
˝u_siblög_£tup_mask
);

59 
	}
}

61 
__˝uöô
 
	$deÁu…_öô
(
˝uöfo_x86
 *
c
)

63 #ifde‡
CONFIG_X86_64


64 
	`˝u_dëe˘_ˇche_sizes
(
c
);

68 i‡(
c
->
˝uid_Àvñ
 == -1) {

70 i‡(
c
->
x86
 == 4)

71 
	`°r˝y
(
c
->
x86_modñ_id
, "486");

72 i‡(
c
->
x86
 == 3)

73 
	`°r˝y
(
c
->
x86_modñ_id
, "386");

76 
	}
}

78 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	gdeÁu…_˝u
 = {

79 .
c_öô
 = 
deÁu…_öô
,

80 .
	gc_víd‹
 = "Unknown",

81 .
	gc_x86_víd‹
 = 
X86_VENDOR_UNKNOWN
,

84 c⁄° 
˝u_dev
 *
this_˝u
 
	g__˝uöôd©a
 = &
deÁu…_˝u
;

86 
DEFINE_PER_CPU_PAGE_ALIGNED
(
gdt_∑ge
, gdt_∑geË{ .
gdt
 = {

87 #ifde‡
CONFIG_X86_64


96 [
GDT_ENTRY_KERNEL32_CS
] = 
GDT_ENTRY_INIT
(0xc09b, 0, 0xfffff),

97 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xa09b, 0, 0xfffff),

98 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc093, 0, 0xfffff),

99 [
GDT_ENTRY_DEFAULT_USER32_CS
] = 
GDT_ENTRY_INIT
(0xc0fb, 0, 0xfffff),

100 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f3, 0, 0xfffff),

101 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xa0fb, 0, 0xfffff),

103 [
GDT_ENTRY_KERNEL_CS
] = 
GDT_ENTRY_INIT
(0xc09a, 0, 0xfffff),

104 [
GDT_ENTRY_KERNEL_DS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

105 [
GDT_ENTRY_DEFAULT_USER_CS
] = 
GDT_ENTRY_INIT
(0xc0fa, 0, 0xfffff),

106 [
GDT_ENTRY_DEFAULT_USER_DS
] = 
GDT_ENTRY_INIT
(0xc0f2, 0, 0xfffff),

113 [
GDT_ENTRY_PNPBIOS_CS32
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

115 [
GDT_ENTRY_PNPBIOS_CS16
] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

117 [
GDT_ENTRY_PNPBIOS_DS
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0xffff),

119 [
GDT_ENTRY_PNPBIOS_TS1
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

121 [
GDT_ENTRY_PNPBIOS_TS2
] = 
GDT_ENTRY_INIT
(0x0092, 0, 0),

127 [
GDT_ENTRY_APMBIOS_BASE
] = 
GDT_ENTRY_INIT
(0x409a, 0, 0xffff),

129 [
GDT_ENTRY_APMBIOS_BASE
+1] = 
GDT_ENTRY_INIT
(0x009a, 0, 0xffff),

131 [
GDT_ENTRY_APMBIOS_BASE
+2] = 
GDT_ENTRY_INIT
(0x4092, 0, 0xffff),

133 [
GDT_ENTRY_ESPFIX_SS
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

134 [
GDT_ENTRY_PERCPU
] = 
GDT_ENTRY_INIT
(0xc092, 0, 0xfffff),

135 
	gGDT_STACK_CANARY_INIT


138 
EXPORT_PER_CPU_SYMBOL_GPL
(
gdt_∑ge
);

140 
__öô
 
	$x86_xßve_£tup
(*
s
)

142 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XSAVE
);

144 
	}
}

145 
__£tup
("noxßve", 
x86_xßve_£tup
);

147 #ifde‡
CONFIG_X86_32


148 
ˇchesize_ovîride
 
	g__˝uöôd©a
 = -1;

149 
dißbÀ_x86_£rül_ƒ
 
	g__˝uöôd©a
 = 1;

151 
__öô
 
	$ˇchesize_£tup
(*
°r
)

153 
	`gë_›ti⁄
(&
°r
, &
ˇchesize_ovîride
);

155 
	}
}

156 
__£tup
("ˇchesize=", 
ˇchesize_£tup
);

158 
__öô
 
	$x86_fx§_£tup
(*
s
)

160 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_FXSR
);

161 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_XMM
);

163 
	}
}

164 
__£tup
("nofx§", 
x86_fx§_£tup
);

166 
__öô
 
	$x86_£p_£tup
(*
s
)

168 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_SEP
);

170 
	}
}

171 
__£tup
("no£p", 
x86_£p_£tup
);

174 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

176 
u32
 
f1
, 
f2
;

185 
asm
 volatile ("pushfl \n\t"

196 : "=&r" (
f1
), "=&r" (
f2
)

197 : "ú" (
Êag
));

199  ((
f1
^
f2
Ë& 
Êag
) != 0;

200 
	}
}

203 
__˝uöô
 
	$have_˝uid_p
()

205  
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_ID
);

206 
	}
}

208 
__˝uöô
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

210 
lo
, 
hi
;

212 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_PN
Ë|| !
dißbÀ_x86_£rül_ƒ
)

217 
	`rdm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

218 
lo
 |= 0x200000;

219 
	`wrm§
(
MSR_IA32_BBL_CR_CTL
, 
lo
, 
hi
);

221 
	`¥ötk
(
KERN_NOTICE
 "CPU serialÇumber disabled.\n");

222 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PN
);

225 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

226 
	}
}

228 
__öô
 
	$x86_£rül_ƒ_£tup
(*
s
)

230 
dißbÀ_x86_£rül_ƒ
 = 0;

232 
	}
}

233 
__£tup
("£rü umbî", 
x86_£rül_ƒ_£tup
);

235 
ölöe
 
	$Êag_is_ch™góbÀ_p
(
u32
 
Êag
)

238 
	}
}

240 
ölöe
 
	$have_˝uid_p
()

243 
	}
}

244 
ölöe
 
	$squash_the_°upid_£rül_numbî
(
˝uöfo_x86
 *
c
)

246 
	}
}

254 
	s˝uid_dïídít_„©uª
 {

255 
u32
 
	m„©uª
;

256 
u32
 
	mÀvñ
;

259 c⁄° 
˝uid_dïídít_„©uª
 
__˝uöôc⁄°


260 
	g˝uid_dïídít_„©uªs
[] = {

261 { 
X86_FEATURE_MWAIT
, 0x00000005 },

262 { 
X86_FEATURE_DCA
, 0x00000009 },

263 { 
X86_FEATURE_XSAVE
, 0x0000000d },

267 
__˝uöô
 
	$fûãr_˝uid_„©uªs
(
˝uöfo_x86
 *
c
, 
boﬁ
 
w¨n
)

269 c⁄° 
˝uid_dïídít_„©uª
 *
df
;

271 
df
 = 
˝uid_dïídít_„©uªs
; df->
„©uª
; df++) {

273 i‡(!
	`˝u_has
(
c
, 
df
->
„©uª
))

282 i‡(!((
s32
)
df
->
Àvñ
 < 0 ?

283 (
u32
)
df
->
Àvñ
 > (u32)
c
->
exãnded_˝uid_Àvñ
 :

284 (
s32
)
df
->
Àvñ
 > (s32)
c
->
˝uid_Àvñ
))

287 
	`˛ór_˝u_ˇp
(
c
, 
df
->
„©uª
);

288 i‡(!
w¨n
)

291 
	`¥ötk
(
KERN_WARNING


293 
x86_ˇp_Êags
[
df
->
„©uª
], df->
Àvñ
);

295 
	}
}

305 c⁄° *
__˝uöô
 
	$èbÀ_lookup_modñ
(
˝uöfo_x86
 *
c
)

307 c⁄° 
˝u_modñ_öfo
 *
öfo
;

309 i‡(
c
->
x86_modñ
 >= 16)

310  
NULL
;

312 i‡(!
this_˝u
)

313  
NULL
;

315 
öfo
 = 
this_˝u
->
c_modñs
;

317 
öfo
 && info->
Ámûy
) {

318 i‡(
öfo
->
Ámûy
 =
c
->
x86
)

319  
öfo
->
modñ_«mes
[
c
->
x86_modñ
];

320 
öfo
++;

322  
NULL
;

323 
	}
}

325 
__u32
 
	g˝u_ˇps_˛óªd
[
NCAPINTS
] 
	g__˝uöôd©a
;

326 
__u32
 
	g˝u_ˇps_£t
[
NCAPINTS
] 
	g__˝uöôd©a
;

328 
	$lﬂd_≥r˝u_£gmít
(
˝u
)

330 #ifde‡
CONFIG_X86_32


331 
	`lﬂd£gmít
(
fs
, 
__KERNEL_PERCPU
);

333 
	`lﬂd£gmít
(
gs
, 0);

334 
	`wrm§l
(
MSR_GS_BASE
, ()
	`≥r_˝u
(
úq_°ack_uni⁄
.
gs_ba£
, 
˝u
));

336 
	`lﬂd_°ack_ˇ«ry_£gmít
();

337 
	}
}

343 
	$swôch_to_√w_gdt
(
˝u
)

345 
desc_±r
 
gdt_des¸
;

347 
gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

348 
gdt_des¸
.
size
 = 
GDT_SIZE
 - 1;

349 
	`lﬂd_gdt
(&
gdt_des¸
);

352 
	`lﬂd_≥r˝u_£gmít
(
˝u
);

353 
	}
}

355 c⁄° 
˝u_dev
 *
__˝uöôd©a
 
	g˝u_devs
[
X86_VENDOR_NUM
] = {};

357 
__˝uöô
 
	$gë_modñ_«me
(
˝uöfo_x86
 *
c
)

359 *
v
;

360 *
p
, *
q
;

362 i‡(
c
->
exãnded_˝uid_Àvñ
 < 0x80000004)

365 
v
 = (*)
c
->
x86_modñ_id
;

366 
	`˝uid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

367 
	`˝uid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

368 
	`˝uid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

369 
c
->
x86_modñ_id
[48] = 0;

375 
p
 = 
q
 = &
c
->
x86_modñ_id
[0];

376 *
p
 == ' ')

377 
p
++;

378 i‡(
p
 !
q
) {

379 *
p
)

380 *
q
++ = *
p
++;

381 
q
 <&
c
->
x86_modñ_id
[48])

382 *
q
++ = '\0';

384 
	}
}

386 
__˝uöô
 
	$˝u_dëe˘_ˇche_sizes
(
˝uöfo_x86
 *
c
)

388 
n
, 
dummy
, 
ebx
, 
ecx
, 
edx
, 
l2size
;

390 
n
 = 
c
->
exãnded_˝uid_Àvñ
;

392 i‡(
n
 >= 0x80000005) {

393 
	`˝uid
(0x80000005, &
dummy
, &
ebx
, &
ecx
, &
edx
);

394 
c
->
x86_ˇche_size
 = (
ecx
>>24Ë+ (
edx
>>24);

395 #ifde‡
CONFIG_X86_64


397 
c
->
x86_ébsize
 = 0;

401 i‡(
n
 < 0x80000006)

404 
	`˝uid
(0x80000006, &
dummy
, &
ebx
, &
ecx
, &
edx
);

405 
l2size
 = 
ecx
 >> 16;

407 #ifde‡
CONFIG_X86_64


408 
c
->
x86_ébsize
 +((
ebx
 >> 16) & 0xfff) + (ebx & 0xfff);

411 i‡(
this_˝u
->
c_size_ˇche
)

412 
l2size
 = 
this_˝u
->
	`c_size_ˇche
(
c
,Ü2size);

415 i‡(
ˇchesize_ovîride
 != -1)

416 
l2size
 = 
ˇchesize_ovîride
;

418 i‡(
l2size
 == 0)

422 
c
->
x86_ˇche_size
 = 
l2size
;

423 
	}
}

425 
__˝uöô
 
	$dëe˘_ht
(
˝uöfo_x86
 *
c
)

427 #ifde‡
CONFIG_X86_HT


428 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

429 
ödex_msb
, 
c‹e_bôs
;

430 
boﬁ
 
¥öãd
;

432 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_HT
))

435 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CMP_LEGACY
))

436 
out
;

438 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

441 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
edx
);

443 
smp_num_siblögs
 = (
ebx
 & 0xff0000) >> 16;

445 i‡(
smp_num_siblögs
 == 1) {

446 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Hyper-Threading is disabled\n");

447 
out
;

450 i‡(
smp_num_siblögs
 <= 1)

451 
out
;

453 i‡(
smp_num_siblögs
 > 
ƒ_˝u_ids
) {

454 
	`¥_w¨nög
("CPU: UnsupportedÇumber of siblings %d",

455 
smp_num_siblögs
);

456 
smp_num_siblögs
 = 1;

460 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

461 
c
->
phys_¥oc_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
);

463 
smp_num_siblögs
 = smp_num_siblög†/ 
c
->
x86_max_c‹es
;

465 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
smp_num_siblögs
);

467 
c‹e_bôs
 = 
	`gë_cou¡_‹dî
(
c
->
x86_max_c‹es
);

469 
c
->
˝u_c‹e_id
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 
ödex_msb
) &

470 ((1 << 
c‹e_bôs
) - 1);

472 
out
:

473 i‡(!
¥öãd
 && (
c
->
x86_max_c‹es
 * 
smp_num_siblögs
) > 1) {

474 
	`¥ötk
(
KERN_INFO
 "CPU: Physical Processor ID: %d\n",

475 
c
->
phys_¥oc_id
);

476 
	`¥ötk
(
KERN_INFO
 "CPU: Processor Core ID: %d\n",

477 
c
->
˝u_c‹e_id
);

478 
¥öãd
 = 1;

481 
	}
}

483 
__˝uöô
 
	$gë_˝u_víd‹
(
˝uöfo_x86
 *
c
)

485 *
v
 = 
c
->
x86_víd‹_id
;

486 
i
;

488 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

489 i‡(!
˝u_devs
[
i
])

492 i‡(!
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[0]) ||

493 (
˝u_devs
[
i
]->
c_idít
[1] &&

494 !
	`°rcmp
(
v
, 
˝u_devs
[
i
]->
c_idít
[1]))) {

496 
this_˝u
 = 
˝u_devs
[
i
];

497 
c
->
x86_víd‹
 = 
this_˝u
->
c_x86_víd‹
;

502 
	`¥ötk_⁄˚
(
KERN_ERR


504 "CPU: You∏sy°em may bêun°abÀ.\n", 
v
);

506 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

507 
this_˝u
 = &
deÁu…_˝u
;

508 
	}
}

510 
__˝uöô
 
	$˝u_dëe˘
(
˝uöfo_x86
 *
c
)

513 
	`˝uid
(0x00000000, (*)&
c
->
˝uid_Àvñ
,

514 (*)&
c
->
x86_víd‹_id
[0],

515 (*)&
c
->
x86_víd‹_id
[8],

516 (*)&
c
->
x86_víd‹_id
[4]);

518 
c
->
x86
 = 4;

520 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

521 
u32
 
junk
, 
tfms
, 
ˇp0
, 
misc
;

523 
	`˝uid
(0x00000001, &
tfms
, &
misc
, &
junk
, &
ˇp0
);

524 
c
->
x86
 = (
tfms
 >> 8) & 0xf;

525 
c
->
x86_modñ
 = (
tfms
 >> 4) & 0xf;

526 
c
->
x86_mask
 = 
tfms
 & 0xf;

528 i‡(
c
->
x86
 == 0xf)

529 
c
->
x86
 +(
tfms
 >> 20) & 0xff;

530 i‡(
c
->
x86
 >= 0x6)

531 
c
->
x86_modñ
 +((
tfms
 >> 16) & 0xf) << 4;

533 i‡(
ˇp0
 & (1<<19)) {

534 
c
->
x86_˛Êush_size
 = ((
misc
 >> 8) & 0xff) * 8;

535 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

538 
	}
}

540 
__˝uöô
 
	$gë_˝u_ˇp
(
˝uöfo_x86
 *
c
)

542 
u32
 
tfms
, 
xlvl
;

543 
u32
 
ebx
;

546 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

547 
u32
 
ˇ∑bûôy
, 
exˇp
;

549 
	`˝uid
(0x00000001, &
tfms
, &
ebx
, &
exˇp
, &
ˇ∑bûôy
);

550 
c
->
x86_ˇ∑bûôy
[0] = 
ˇ∑bûôy
;

551 
c
->
x86_ˇ∑bûôy
[4] = 
exˇp
;

555 
xlvl
 = 
	`˝uid_óx
(0x80000000);

556 
c
->
exãnded_˝uid_Àvñ
 = 
xlvl
;

558 i‡((
xlvl
 & 0xffff0000) == 0x80000000) {

559 i‡(
xlvl
 >= 0x80000001) {

560 
c
->
x86_ˇ∑bûôy
[1] = 
	`˝uid_edx
(0x80000001);

561 
c
->
x86_ˇ∑bûôy
[6] = 
	`˝uid_ecx
(0x80000001);

565 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000008) {

566 
u32
 
óx
 = 
	`˝uid_óx
(0x80000008);

568 
c
->
x86_vút_bôs
 = (
óx
 >> 8) & 0xff;

569 
c
->
x86_phys_bôs
 = 
óx
 & 0xff;

571 #ifde‡
CONFIG_X86_32


572 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_PAE
Ë|| cpu_has(c, 
X86_FEATURE_PSE36
))

573 
c
->
x86_phys_bôs
 = 36;

576 i‡(
c
->
exãnded_˝uid_Àvñ
 >= 0x80000007)

577 
c
->
x86_powî
 = 
	`˝uid_edx
(0x80000007);

579 
	}
}

581 
__˝uöô
 
	$idítify_˝u_wôhout_˝uid
(
˝uöfo_x86
 *
c
)

583 #ifde‡
CONFIG_X86_32


584 
i
;

590 i‡(
	`Êag_is_ch™góbÀ_p
(
X86_EFLAGS_AC
))

591 
c
->
x86
 = 4;

593 
c
->
x86
 = 3;

595 
i
 = 0; i < 
X86_VENDOR_NUM
; i++)

596 i‡(
˝u_devs
[
i
] && cpu_devs[i]->
c_idítify
) {

597 
c
->
x86_víd‹_id
[0] = 0;

598 
˝u_devs
[
i
]->
	`c_idítify
(
c
);

599 i‡(
c
->
x86_víd‹_id
[0]) {

600 
	`gë_˝u_víd‹
(
c
);

605 
	}
}

616 
__öô
 
	$óæy_idítify_˝u
(
˝uöfo_x86
 *
c
)

618 #ifde‡
CONFIG_X86_64


619 
c
->
x86_˛Êush_size
 = 64;

620 
c
->
x86_phys_bôs
 = 36;

621 
c
->
x86_vút_bôs
 = 48;

623 
c
->
x86_˛Êush_size
 = 32;

624 
c
->
x86_phys_bôs
 = 32;

625 
c
->
x86_vút_bôs
 = 32;

627 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

629 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

630 
c
->
exãnded_˝uid_Àvñ
 = 0;

632 i‡(!
	`have_˝uid_p
())

633 
	`idítify_˝u_wôhout_˝uid
(
c
);

636 i‡(!
	`have_˝uid_p
())

639 
	`˝u_dëe˘
(
c
);

641 
	`gë_˝u_víd‹
(
c
);

643 
	`gë_˝u_ˇp
(
c
);

645 i‡(
this_˝u
->
c_óæy_öô
)

646 
this_˝u
->
	`c_óæy_öô
(
c
);

648 #ifde‡
CONFIG_SMP


649 
c
->
˝u_ödex
 = 
boŸ_˝u_id
;

651 
	`fûãr_˝uid_„©uªs
(
c
, 
Ál£
);

652 
	}
}

654 
__öô
 
	$óæy_˝u_öô
()

656 c⁄° 
˝u_dev
 *c⁄° *
cdev
;

657 
cou¡
 = 0;

659 #ifde‡
PROCESSOR_SELECT


660 
	`¥ötk
(
KERN_INFO
 "KERNEL supported cpus:\n");

663 
cdev
 = 
__x86_˝u_dev_°¨t
; cdev < 
__x86_˝u_dev_íd
; cdev++) {

664 c⁄° 
˝u_dev
 *
˝udev
 = *
cdev
;

666 i‡(
cou¡
 >
X86_VENDOR_NUM
)

668 
˝u_devs
[
cou¡
] = 
˝udev
;

669 
cou¡
++;

671 #ifde‡
PROCESSOR_SELECT


673 
j
;

675 
j
 = 0; j < 2; j++) {

676 i‡(!
˝udev
->
c_idít
[
j
])

678 
	`¥ötk
(
KERN_INFO
 " %†%s\n", 
˝udev
->
c_víd‹
,

679 
˝udev
->
c_idít
[
j
]);

684 
	`óæy_idítify_˝u
(&
boŸ_˝u_d©a
);

685 
	}
}

695 
__˝uöô
 
	$dëe˘_n›l
(
˝uöfo_x86
 *
c
)

697 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_NOPL
);

698 
	}
}

700 
__˝uöô
 
	$gíîic_idítify
(
˝uöfo_x86
 *
c
)

702 
c
->
exãnded_˝uid_Àvñ
 = 0;

704 i‡(!
	`have_˝uid_p
())

705 
	`idítify_˝u_wôhout_˝uid
(
c
);

708 i‡(!
	`have_˝uid_p
())

711 
	`˝u_dëe˘
(
c
);

713 
	`gë_˝u_víd‹
(
c
);

715 
	`gë_˝u_ˇp
(
c
);

717 i‡(
c
->
˝uid_Àvñ
 >= 0x00000001) {

718 
c
->
öôül_≠icid
 = (
	`˝uid_ebx
(1) >> 24) & 0xFF;

719 #ifde‡
CONFIG_X86_32


720 #ifde‡
CONFIG_X86_HT


721 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

723 
c
->
≠icid
 = c->
öôül_≠icid
;

727 #ifde‡
CONFIG_X86_HT


728 
c
->
phys_¥oc_id
 = c->
öôül_≠icid
;

732 
	`gë_modñ_«me
(
c
);

734 
	`öô_sˇâîed_˝uid_„©uªs
(
c
);

735 
	`dëe˘_n›l
(
c
);

736 
	}
}

741 
__˝uöô
 
	$idítify_˝u
(
˝uöfo_x86
 *
c
)

743 
i
;

745 
c
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

746 
c
->
x86_ˇche_size
 = -1;

747 
c
->
x86_víd‹
 = 
X86_VENDOR_UNKNOWN
;

748 
c
->
x86_modñ
 = c->
x86_mask
 = 0;

749 
c
->
x86_víd‹_id
[0] = '\0';

750 
c
->
x86_modñ_id
[0] = '\0';

751 
c
->
x86_max_c‹es
 = 1;

752 
c
->
x86_c‹eid_bôs
 = 0;

753 #ifde‡
CONFIG_X86_64


754 
c
->
x86_˛Êush_size
 = 64;

755 
c
->
x86_phys_bôs
 = 36;

756 
c
->
x86_vút_bôs
 = 48;

758 
c
->
˝uid_Àvñ
 = -1;

759 
c
->
x86_˛Êush_size
 = 32;

760 
c
->
x86_phys_bôs
 = 32;

761 
c
->
x86_vút_bôs
 = 32;

763 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
;

764 
	`mem£t
(&
c
->
x86_ˇ∑bûôy
, 0,  c->x86_capability);

766 
	`gíîic_idítify
(
c
);

768 i‡(
this_˝u
->
c_idítify
)

769 
this_˝u
->
	`c_idítify
(
c
);

772 
i
 = 0; i < 
NCAPINTS
; i++) {

773 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

774 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

777 #ifde‡
CONFIG_X86_64


778 
c
->
≠icid
 = 
≠ic
->
	`phys_pkg_id
(c->
öôül_≠icid
, 0);

791 i‡(
this_˝u
->
c_öô
)

792 
this_˝u
->
	`c_öô
(
c
);

795 
	`squash_the_°upid_£rül_numbî
(
c
);

803 
	`fûãr_˝uid_„©uªs
(
c
, 
åue
);

806 i‡(!
c
->
x86_modñ_id
[0]) {

807 c⁄° *
p
;

808 
p
 = 
	`èbÀ_lookup_modñ
(
c
);

809 i‡(
p
)

810 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

813 
	`•rötf
(
c
->
x86_modñ_id
, "%02x/%02x",

814 
c
->
x86
, c->
x86_modñ
);

817 #ifde‡
CONFIG_X86_64


818 
	`dëe˘_ht
(
c
);

821 
	`öô_hy≥rvis‹
(
c
);

827 
i
 = 0; i < 
NCAPINTS
; i++) {

828 
c
->
x86_ˇ∑bûôy
[
i
] &~
˝u_ˇps_˛óªd
[i];

829 
c
->
x86_ˇ∑bûôy
[
i
] |
˝u_ˇps_£t
[i];

838 i‡(
c
 !&
boŸ_˝u_d©a
) {

840 
i
 = 0; i < 
NCAPINTS
; i++)

841 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[
i
] &
c
->x86_capability[i];

845 
	`mcheck_˝u_öô
(
c
);

847 
	`£À˘_idÀ_routöe
(
c
);

849 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

850 
	`numa_add_˝u
(
	`smp_¥o˚ss‹_id
());

852 
	}
}

854 #ifde‡
CONFIG_X86_64


855 
	$vgë˝u_£t_mode
()

857 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_RDTSCP
))

858 
vgë˝u_mode
 = 
VGETCPU_RDTSCP
;

860 
vgë˝u_mode
 = 
VGETCPU_LSL
;

861 
	}
}

864 
__öô
 
	$idítify_boŸ_˝u
()

866 
	`idítify_˝u
(&
boŸ_˝u_d©a
);

867 
	`öô_c1e_mask
();

868 #ifde‡
CONFIG_X86_32


869 
	`sy£¡î_£tup
();

870 
	`íabÀ_£p_˝u
();

872 
	`vgë˝u_£t_mode
();

874 
	`öô_hw_≥rf_evíts
();

875 
	}
}

877 
__˝uöô
 
	$idítify_£c⁄d¨y_˝u
(
˝uöfo_x86
 *
c
)

879 
	`BUG_ON
(
c
 =&
boŸ_˝u_d©a
);

880 
	`idítify_˝u
(
c
);

881 #ifde‡
CONFIG_X86_32


882 
	`íabÀ_£p_˝u
();

884 
	`mår_≠_öô
();

885 
	}
}

887 
	sm§_ønge
 {

888 
	mmö
;

889 
	mmax
;

892 c⁄° 
m§_ønge
 
	gm§_ønge_¨øy
[] 
	g__˝uöôc⁄°
 = {

899 
__˝uöô
 
	$¥öt_˝u_m§
()

901 
ödex_mö
, 
ödex_max
;

902 
ödex
;

903 
u64
 
vÆ
;

904 
i
;

906 
i
 = 0; i < 
	`ARRAY_SIZE
(
m§_ønge_¨øy
); i++) {

907 
ödex_mö
 = 
m§_ønge_¨øy
[
i
].
mö
;

908 
ödex_max
 = 
m§_ønge_¨øy
[
i
].
max
;

910 
ödex
 = 
ödex_mö
; index < 
ödex_max
; index++) {

911 i‡(
	`rdm§l_amd_ß„
(
ödex
, &
vÆ
))

913 
	`¥ötk
(
KERN_INFO
 " MSR%08x: %016Œx\n", 
ödex
, 
vÆ
);

916 
	}
}

918 
show_m§
 
	g__˝uöôd©a
;

920 
__öô
 
	$£tup_show_m§
(*
¨g
)

922 
num
;

924 
	`gë_›ti⁄
(&
¨g
, &
num
);

926 i‡(
num
 > 0)

927 
show_m§
 = 
num
;

929 
	}
}

930 
__£tup
("show_m§=", 
£tup_show_m§
);

932 
__öô
 
	$£tup_no˛Êush
(*
¨g
)

934 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_CLFLSH
);

936 
	}
}

937 
__£tup
("no˛Êush", 
£tup_no˛Êush
);

939 
__˝uöô
 
	$¥öt_˝u_öfo
(
˝uöfo_x86
 *
c
)

941 c⁄° *
víd‹
 = 
NULL
;

943 i‡(
c
->
x86_víd‹
 < 
X86_VENDOR_NUM
) {

944 
víd‹
 = 
this_˝u
->
c_víd‹
;

946 i‡(
c
->
˝uid_Àvñ
 >= 0)

947 
víd‹
 = 
c
->
x86_víd‹_id
;

950 i‡(
víd‹
 && !
	`°r°r
(
c
->
x86_modñ_id
, vendor))

951 
	`¥ötk
(
KERN_CONT
 "%†", 
víd‹
);

953 i‡(
c
->
x86_modñ_id
[0])

954 
	`¥ötk
(
KERN_CONT
 "%s", 
c
->
x86_modñ_id
);

956 
	`¥ötk
(
KERN_CONT
 "%d86", 
c
->
x86
);

958 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

959 
	`¥ötk
(
KERN_CONT
 " sãµög %02x\n", 
c
->
x86_mask
);

961 
	`¥ötk
(
KERN_CONT
 "\n");

963 #ifde‡
CONFIG_SMP


964 i‡(
c
->
˝u_ödex
 < 
show_m§
)

965 
	`¥öt_˝u_m§
();

967 i‡(
show_m§
)

968 
	`¥öt_˝u_m§
();

970 
	}
}

972 
__öô
 
	$£tup_dißbÀ˝uid
(*
¨g
)

974 
bô
;

976 i‡(
	`gë_›ti⁄
(&
¨g
, &
bô
Ë&& bô < 
NCAPINTS
*32)

977 
	`£tup_˛ór_˝u_ˇp
(
bô
);

982 
	}
}

983 
__£tup
("˛ór˝uid=", 
£tup_dißbÀ˝uid
);

985 #ifde‡
CONFIG_X86_64


986 
desc_±r
 
	gidt_des¸
 = { 
NR_VECTORS
 * 16 - 1, (Ë
idt_èbÀ
 };

988 
	$DEFINE_PER_CPU_FIRST
(
úq_°ack_uni⁄
,

989 
úq_°ack_uni⁄
Ë
	`__Æig√d
(
PAGE_SIZE
);

995 
	$DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë
____ˇchñöe_Æig√d
 =

996 &
öô_èsk
;

997 
	`EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

999 
	`DEFINE_PER_CPU
(, 
kî√l_°ack
) =

1000 ()&
öô_thªad_uni⁄
 - 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

1001 
	`EXPORT_PER_CPU_SYMBOL
(
kî√l_°ack
);

1003 
	`DEFINE_PER_CPU
(*, 
úq_°ack_±r
) =

1004 
	`öô_≥r_˝u_v¨
(
úq_°ack_uni⁄
.
úq_°ack
Ë+ 
IRQ_STACK_SIZE
 - 64;

1006 
	`DEFINE_PER_CPU
(, 
úq_cou¡
) = -1;

1014 c⁄° 
ex˚±i⁄_°ack_sizes
[
N_EXCEPTION_STACKS
] = {

1015 [0 ... 
N_EXCEPTION_STACKS
 - 1] = 
EXCEPTION_STKSZ
,

1016 [
DEBUG_STACK
 - 1] = 
DEBUG_STKSZ


1017 
	}
};

1019 
DEFINE_PER_CPU_PAGE_ALIGNED
(, 
ex˚±i⁄_°acks


1020 [(
N_EXCEPTION_STACKS
 - 1Ë* 
EXCEPTION_STKSZ
 + 
DEBUG_STKSZ
]);

1023 
	$sysˇŒ_öô
()

1030 
	`wrm§l
(
MSR_STAR
, ((
u64
)
__USER32_CS
)<<48 | ((u64)
__KERNEL_CS
)<<32);

1031 
	`wrm§l
(
MSR_LSTAR
, 
sy°em_ˇŒ
);

1032 
	`wrm§l
(
MSR_CSTAR
, 
ign‹e_sy§ë
);

1034 #ifde‡
CONFIG_IA32_EMULATION


1035 
	`sysˇŒ32_˝u_öô
();

1039 
	`wrm§l
(
MSR_SYSCALL_MASK
,

1040 
X86_EFLAGS_TF
|
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_IOPL
);

1041 
	}
}

1043 
	gkî√l_eÊags
;

1049 
DEFINE_PER_CPU
(
‹ig_i°
, orig_ist);

1053 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
cuºít_èsk
Ë&
öô_èsk
;

1054 
EXPORT_PER_CPU_SYMBOL
(
cuºít_èsk
);

1056 #ifde‡
CONFIG_CC_STACKPROTECTOR


1057 
DEFINE_PER_CPU_ALIGNED
(
°ack_ˇ«ry
, stack_canary);

1061 
±_ªgs
 * 
__˝uöô
 
	$idÀ_ªgs
(
±_ªgs
 *
ªgs
)

1063 
	`mem£t
(
ªgs
, 0, (
±_ªgs
));

1064 
ªgs
->
fs
 = 
__KERNEL_PERCPU
;

1065 
ªgs
->
gs
 = 
__KERNEL_STACK_CANARY
;

1067  
ªgs
;

1068 
	}
}

1074 
	$˛ór_Æl_debug_ªgs
()

1076 
i
;

1078 
i
 = 0; i < 8; i++) {

1080 i‡((
i
 == 4) || (i == 5))

1083 
	`£t_debugªg
(0, 
i
);

1085 
	}
}

1087 #ifde‡
CONFIG_KGDB


1092 
	$dbg_ª°‹e_debug_ªgs
()

1094 i‡(
	`u∆ikñy
(
kgdb_c⁄√˘ed
 && 
¨ch_kgdb_›s
.
c‹ª˘_hw_bªak
))

1095 
¨ch_kgdb_›s
.
	`c‹ª˘_hw_bªak
();

1096 
	}
}

1098 
	#dbg_ª°‹e_debug_ªgs
()

	)

1108 #ifde‡
CONFIG_X86_64


1110 
__˝uöô
 
	$˝u_öô
()

1112 
‹ig_i°
 *
oi°
;

1113 
èsk_°ru˘
 *
me
;

1114 
tss_°ru˘
 *
t
;

1115 
v
;

1116 
˝u
;

1117 
i
;

1119 
˝u
 = 
	`°ack_smp_¥o˚ss‹_id
();

1120 
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1121 
oi°
 = &
	`≥r_˝u
(
‹ig_i°
, 
˝u
);

1123 #ifde‡
CONFIG_NUMA


1124 i‡(
˝u
 !0 && 
	`≥r˝u_ªad
(
numa_node
) == 0 &&

1125 
	`óæy_˝u_to_node
(
˝u
Ë!
NUMA_NO_NODE
)

1126 
	`£t_numa_node
(
	`óæy_˝u_to_node
(
˝u
));

1129 
me
 = 
cuºít
;

1131 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
))

1132 
	`∑nic
("CPU#%dáÃódy inôülized!\n", 
˝u
);

1134 
	`¥_debug
("Inôülizög CPU#%d\n", 
˝u
);

1136 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1143 
	`swôch_to_√w_gdt
(
˝u
);

1144 
	`lﬂd£gmít
(
fs
, 0);

1146 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

1148 
	`mem£t
(
me
->
thªad
.
és_¨øy
, 0, 
GDT_ENTRY_TLS_ENTRIES
 * 8);

1149 
	`sysˇŒ_öô
();

1151 
	`wrm§l
(
MSR_FS_BASE
, 0);

1152 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 0);

1153 
	`b¨rõr
();

1155 
	`x86_c⁄figuª_nx
();

1156 i‡(
˝u
 != 0)

1157 
	`íabÀ_x2≠ic
();

1162 i‡(!
oi°
->
i°
[0]) {

1163 *
e°acks
 = 
	`≥r_˝u
(
ex˚±i⁄_°acks
, 
˝u
);

1165 
v
 = 0; v < 
N_EXCEPTION_STACKS
; v++) {

1166 
e°acks
 +
ex˚±i⁄_°ack_sizes
[
v
];

1167 
oi°
->
i°
[
v
] = 
t
->
x86_tss
.ist[v] =

1168 ()
e°acks
;

1172 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1178 
i
 = 0; i <
IO_BITMAP_LONGS
; i++)

1179 
t
->
io_bôm≠
[
i
] = ~0UL;

1181 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1182 
me
->
a˘ive_mm
 = &
öô_mm
;

1183 
	`BUG_ON
(
me
->
mm
);

1184 
	`íãr_œzy_éb
(&
öô_mm
, 
me
);

1186 
	`lﬂd_•0
(
t
, &
cuºít
->
thªad
);

1187 
	`£t_tss_desc
(
˝u
, 
t
);

1188 
	`lﬂd_TR_desc
();

1189 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1191 
	`˛ór_Æl_debug_ªgs
();

1192 
	`dbg_ª°‹e_debug_ªgs
();

1194 
	`Âu_öô
();

1196 
	`øw_loˇl_ßve_Êags
(
kî√l_eÊags
);

1198 i‡(
	`is_uv_sy°em
())

1199 
	`uv_˝u_öô
();

1200 
	}
}

1204 
__˝uöô
 
	$˝u_öô
()

1206 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1207 
èsk_°ru˘
 *
cuº
 = 
cuºít
;

1208 
tss_°ru˘
 *
t
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

1209 
thªad_°ru˘
 *
thªad
 = &
cuº
->thread;

1211 i‡(
	`˝umask_ã°_™d_£t_˝u
(
˝u
, 
˝u_öôülized_mask
)) {

1212 
	`¥ötk
(
KERN_WARNING
 "CPU#%dáÃódy inôülized!\n", 
˝u
);

1214 
	`loˇl_úq_íabÀ
();

1217 
	`¥ötk
(
KERN_INFO
 "Inôülizög CPU#%d\n", 
˝u
);

1219 i‡(
˝u_has_vme
 || 
˝u_has_tsc
 || 
˝u_has_de
)

1220 
	`˛ór_ö_¸4
(
X86_CR4_VME
|
X86_CR4_PVI
|
X86_CR4_TSD
|
X86_CR4_DE
);

1222 
	`lﬂd_idt
(&
idt_des¸
);

1223 
	`swôch_to_√w_gdt
(
˝u
);

1228 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

1229 
cuº
->
a˘ive_mm
 = &
öô_mm
;

1230 
	`BUG_ON
(
cuº
->
mm
);

1231 
	`íãr_œzy_éb
(&
öô_mm
, 
cuº
);

1233 
	`lﬂd_•0
(
t
, 
thªad
);

1234 
	`£t_tss_desc
(
˝u
, 
t
);

1235 
	`lﬂd_TR_desc
();

1236 
	`lﬂd_LDT
(&
öô_mm
.
c⁄ãxt
);

1238 
t
->
x86_tss
.
io_bôm≠_ba£
 = 
	`off£tof
(
tss_°ru˘
, 
io_bôm≠
);

1240 #ifde‡
CONFIG_DOUBLEFAULT


1242 
	`__£t_tss_desc
(
˝u
, 
GDT_ENTRY_DOUBLEFAULT_TSS
, &
doubÀÁu…_tss
);

1245 
	`˛ór_Æl_debug_ªgs
();

1246 
	`dbg_ª°‹e_debug_ªgs
();

1251 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

1252 
	`˛ór_u£d_m©h
();

1253 
	`mxc§_„©uª_mask_öô
();

1258 i‡(
	`smp_¥o˚ss‹_id
(Ë=
boŸ_˝u_id
)

1259 
	`öô_thªad_x°©e
();

1261 
	`xßve_öô
();

1262 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c

28 
	~<löux/kî√l.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/˝u‰eq.h
>

34 
	~<löux/compûî.h
>

35 
	~<löux/dmi.h
>

36 
	~<löux/¶ab.h
>

37 
	~<åa˚/evíts/powî.h
>

39 
	~<löux/a˝i.h
>

40 
	~<löux/io.h
>

41 
	~<löux/dñay.h
>

42 
	~<löux/uac˚ss.h
>

44 
	~<a˝i/¥o˚ss‹.h
>

46 
	~<asm/m§.h
>

47 
	~<asm/¥o˚ss‹.h
>

48 
	~<asm/˝u„©uª.h
>

49 
	~"m≥rf.h
"

51 
	#d¥ötk
(
msg
...Ë
	`˝u‰eq_debug_¥ötk
(
CPUFREQ_DEBUG_DRIVER
, \

52 "a˝i-˝u‰eq", 
msg
)

	)

54 
MODULE_AUTHOR
("Paul Diefenbaugh, Dominik Brodowski");

55 
MODULE_DESCRIPTION
("ACPI Processor P-States Driver");

56 
MODULE_LICENSE
("GPL");

59 
	mUNDEFINED_CAPABLE
 = 0,

60 
	mSYSTEM_INTEL_MSR_CAPABLE
,

61 
	mSYSTEM_IO_CAPABLE
,

64 
	#INTEL_MSR_RANGE
 (0xffff)

	)

66 
	sa˝i_˝u‰eq_d©a
 {

67 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ma˝i_d©a
;

68 
˝u‰eq_‰equícy_èbÀ
 *
	m‰eq_èbÀ
;

69 
	mªsume
;

70 
	m˝u_„©uª
;

73 
DEFINE_PER_CPU
(
a˝i_˝u‰eq_d©a
 *, 
ac‰eq_d©a
);

76 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
	ga˝i_≥rf_d©a
;

78 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
;

80 
	ga˝i_p°©e_°ri˘
;

82 
	$check_e°_˝u
(
˝uid
)

84 
˝uöfo_x86
 *
˝u
 = &
	`˝u_d©a
(
˝uid
);

86  
	`˝u_has
(
˝u
, 
X86_FEATURE_EST
);

87 
	}
}

89 
	$exåa˘_io
(
u32
 
vÆue
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

91 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

92 
i
;

94 
≥rf
 = 
d©a
->
a˝i_d©a
;

96 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

97 i‡(
vÆue
 =
≥rf
->
°©es
[
i
].
°©us
)

98  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

101 
	}
}

103 
	$exåa˘_m§
(
u32
 
m§
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

105 
i
;

106 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

108 
m§
 &
INTEL_MSR_RANGE
;

109 
≥rf
 = 
d©a
->
a˝i_d©a
;

111 
i
 = 0; 
d©a
->
‰eq_èbÀ
[i].
‰equícy
 !
CPUFREQ_TABLE_END
; i++) {

112 i‡(
m§
 =
≥rf
->
°©es
[
d©a
->
‰eq_èbÀ
[
i
].
ödex
].
°©us
)

113  
d©a
->
‰eq_èbÀ
[
i
].
‰equícy
;

115  
d©a
->
‰eq_èbÀ
[0].
‰equícy
;

116 
	}
}

118 
	$exåa˘_‰eq
(
u32
 
vÆ
, 
a˝i_˝u‰eq_d©a
 *
d©a
)

120 
d©a
->
˝u_„©uª
) {

121 
SYSTEM_INTEL_MSR_CAPABLE
:

122  
	`exåa˘_m§
(
vÆ
, 
d©a
);

123 
SYSTEM_IO_CAPABLE
:

124  
	`exåa˘_io
(
vÆ
, 
d©a
);

128 
	}
}

130 
	sm§_addr
 {

131 
u32
 
	mªg
;

134 
	sio_addr
 {

135 
u16
 
	mp‹t
;

136 
u8
 
	mbô_width
;

139 
	sdrv_cmd
 {

140 
	mty≥
;

141 c⁄° 
˝umask
 *
	mmask
;

143 
m§_addr
 
	mm§
;

144 
io_addr
 
	mio
;

145 } 
	maddr
;

146 
u32
 
	mvÆ
;

150 
	$do_drv_ªad
(*
_cmd
)

152 
drv_cmd
 *
cmd
 = 
_cmd
;

153 
u32
 
h
;

155 
cmd
->
ty≥
) {

156 
SYSTEM_INTEL_MSR_CAPABLE
:

157 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, cmd->
vÆ
, 
h
);

159 
SYSTEM_IO_CAPABLE
:

160 
	`a˝i_os_ªad_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

161 &
cmd
->
vÆ
,

162 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

167 
	}
}

170 
	$do_drv_wrôe
(*
_cmd
)

172 
drv_cmd
 *
cmd
 = 
_cmd
;

173 
u32
 
lo
, 
hi
;

175 
cmd
->
ty≥
) {

176 
SYSTEM_INTEL_MSR_CAPABLE
:

177 
	`rdm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

178 
lo
 = (lÿ& ~
INTEL_MSR_RANGE
Ë| (
cmd
->
vÆ
 & INTEL_MSR_RANGE);

179 
	`wrm§
(
cmd
->
addr
.
m§
.
ªg
, 
lo
, 
hi
);

181 
SYSTEM_IO_CAPABLE
:

182 
	`a˝i_os_wrôe_p‹t
((
a˝i_io_addªss
)
cmd
->
addr
.
io
.
p‹t
,

183 
cmd
->
vÆ
,

184 (
u32
)
cmd
->
addr
.
io
.
bô_width
);

189 
	}
}

191 
	$drv_ªad
(
drv_cmd
 *
cmd
)

193 
îr
;

194 
cmd
->
vÆ
 = 0;

196 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_™y
(
cmd
->
mask
, 
do_drv_ªad
, cmd, 1);

197 
	`WARN_ON_ONCE
(
îr
);

198 
	}
}

200 
	$drv_wrôe
(
drv_cmd
 *
cmd
)

202 
this_˝u
;

204 
this_˝u
 = 
	`gë_˝u
();

205 i‡(
	`˝umask_ã°_˝u
(
this_˝u
, 
cmd
->
mask
))

206 
	`do_drv_wrôe
(
cmd
);

207 
	`smp_ˇŒ_fun˘i⁄_m™y
(
cmd
->
mask
, 
do_drv_wrôe
, cmd, 1);

208 
	`put_˝u
();

209 
	}
}

211 
u32
 
	$gë_cur_vÆ
(c⁄° 
˝umask
 *
mask
)

213 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

214 
drv_cmd
 
cmd
;

216 i‡(
	`u∆ikñy
(
	`˝umask_em±y
(
mask
)))

219 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
˝u_„©uª
) {

220 
SYSTEM_INTEL_MSR_CAPABLE
:

221 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

222 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_STATUS
;

224 
SYSTEM_IO_CAPABLE
:

225 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

226 
≥rf
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
	`˝umask_fú°
(
mask
))->
a˝i_d©a
;

227 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

228 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

234 
cmd
.
mask
 = mask;

235 
	`drv_ªad
(&
cmd
);

237 
	`d¥ötk
("gë_cur_vÆ = %u\n", 
cmd
.
vÆ
);

239  
cmd
.
vÆ
;

240 
	}
}

242 
	$gë_cur_‰eq_⁄_˝u
(
˝u
)

244 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
);

245 
‰eq
;

246 
ˇched_‰eq
;

248 
	`d¥ötk
("gë_cur_‰eq_⁄_˝u (%d)\n", 
˝u
);

250 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

251 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

255 
ˇched_‰eq
 = 
d©a
->
‰eq_èbÀ
[d©a->
a˝i_d©a
->
°©e
].
‰equícy
;

256 
‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
	`˝umask_of
(
˝u
)), 
d©a
);

257 i‡(
‰eq
 !
ˇched_‰eq
) {

262 
d©a
->
ªsume
 = 1;

265 
	`d¥ötk
("cu∏‰eq = %u\n", 
‰eq
);

267  
‰eq
;

268 
	}
}

270 
	$check_‰eqs
(c⁄° 
˝umask
 *
mask
, 
‰eq
,

271 
a˝i_˝u‰eq_d©a
 *
d©a
)

273 
cur_‰eq
;

274 
i
;

276 
i
 = 0; i < 100; i++) {

277 
cur_‰eq
 = 
	`exåa˘_‰eq
(
	`gë_cur_vÆ
(
mask
), 
d©a
);

278 i‡(
cur_‰eq
 =
‰eq
)

280 
	`udñay
(10);

283 
	}
}

285 
	$a˝i_˝u‰eq_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

286 
èrgë_‰eq
, 
ªœti⁄
)

288 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

289 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

290 
˝u‰eq_‰eqs
 
‰eqs
;

291 
drv_cmd
 
cmd
;

292 
√xt_°©e
 = 0;

293 
√xt_≥rf_°©e
 = 0;

294 
i
;

295 
ªsu…
 = 0;

297 
	`d¥ötk
("a˝i_˝u‰eq_èrgë %d (%d)\n", 
èrgë_‰eq
, 
pﬁicy
->
˝u
);

299 i‡(
	`u∆ikñy
(
d©a
 =
NULL
 ||

300 
d©a
->
a˝i_d©a
 =
NULL
 || d©a->
‰eq_èbÀ
 == NULL)) {

301  -
ENODEV
;

304 
≥rf
 = 
d©a
->
a˝i_d©a
;

305 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_èrgë
(
pﬁicy
,

306 
d©a
->
‰eq_èbÀ
,

307 
èrgë_‰eq
,

308 
ªœti⁄
, &
√xt_°©e
);

309 i‡(
	`u∆ikñy
(
ªsu…
)) {

310 
ªsu…
 = -
ENODEV
;

311 
out
;

314 
√xt_≥rf_°©e
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
ödex
;

315 i‡(
≥rf
->
°©e
 =
√xt_≥rf_°©e
) {

316 i‡(
	`u∆ikñy
(
d©a
->
ªsume
)) {

317 
	`d¥ötk
("CalledáfterÑesume,ÑesettingÅo P%d\n",

318 
√xt_≥rf_°©e
);

319 
d©a
->
ªsume
 = 0;

321 
	`d¥ötk
("AlreadyátÅarget state (P%d)\n",

322 
√xt_≥rf_°©e
);

323 
out
;

327 
	`åa˚_powî_‰equícy
(
POWER_PSTATE
, 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
);

329 
d©a
->
˝u_„©uª
) {

330 
SYSTEM_INTEL_MSR_CAPABLE
:

331 
cmd
.
ty≥
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

332 
cmd
.
addr
.
m§
.
ªg
 = 
MSR_IA32_PERF_CTL
;

333 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

335 
SYSTEM_IO_CAPABLE
:

336 
cmd
.
ty≥
 = 
SYSTEM_IO_CAPABLE
;

337 
cmd
.
addr
.
io
.
p‹t
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.
addªss
;

338 
cmd
.
addr
.
io
.
bô_width
 = 
≥rf
->
c⁄åﬁ_ªgi°î
.bit_width;

339 
cmd
.
vÆ
 = (
u32
Ë
≥rf
->
°©es
[
√xt_≥rf_°©e
].
c⁄åﬁ
;

342 
ªsu…
 = -
ENODEV
;

343 
out
;

347 i‡(
pﬁicy
->
sh¨ed_ty≥
 !
CPUFREQ_SHARED_TYPE_ANY
)

348 
cmd
.
mask
 = 
pﬁicy
->
˝us
;

350 
cmd
.
mask
 = 
	`˝umask_of
(
pﬁicy
->
˝u
);

352 
‰eqs
.
ﬁd
 = 
≥rf
->
°©es
[≥rf->
°©e
].
c‹e_‰equícy
 * 1000;

353 
‰eqs
.
√w
 = 
d©a
->
‰eq_èbÀ
[
√xt_°©e
].
‰equícy
;

354 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

355 
‰eqs
.
˝u
 = 
i
;

356 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

359 
	`drv_wrôe
(&
cmd
);

361 i‡(
a˝i_p°©e_°ri˘
) {

362 i‡(!
	`check_‰eqs
(
cmd
.
mask
, 
‰eqs
.
√w
, 
d©a
)) {

363 
	`d¥ötk
("acpi_cpufreq_target failed (%d)\n",

364 
pﬁicy
->
˝u
);

365 
ªsu…
 = -
EAGAIN
;

366 
out
;

370 
	`f‹_óch_˝u
(
i
, 
cmd
.
mask
) {

371 
‰eqs
.
˝u
 = 
i
;

372 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

374 
≥rf
->
°©e
 = 
√xt_≥rf_°©e
;

376 
out
:

377  
ªsu…
;

378 
	}
}

380 
	$a˝i_˝u‰eq_vîify
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

382 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

384 
	`d¥ötk
("acpi_cpufreq_verify\n");

386  
	`˝u‰eq_‰equícy_èbÀ_vîify
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

387 
	}
}

390 
	$a˝i_˝u‰eq_guess_‰eq
(
a˝i_˝u‰eq_d©a
 *
d©a
, 
˝u
)

392 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
 = 
d©a
->
a˝i_d©a
;

394 i‡(
˝u_khz
) {

396 
i
;

397 
‰eq
;

398 
‰eqn
 = 
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

400 
i
 = 0; i < (
≥rf
->
°©e_cou¡
-1); i++) {

401 
‰eq
 = 
‰eqn
;

402 
‰eqn
 = 
≥rf
->
°©es
[
i
+1].
c‹e_‰equícy
 * 1000;

403 i‡((2 * 
˝u_khz
Ë> (
‰eqn
 + 
‰eq
)) {

404 
≥rf
->
°©e
 = 
i
;

405  
‰eq
;

408 
≥rf
->
°©e
 =Öîf->
°©e_cou¡
-1;

409  
‰eqn
;

412 
≥rf
->
°©e
 = 0;

413  
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000;

415 
	}
}

417 
	$‰ì_a˝i_≥rf_d©a
()

419 
i
;

422 
	`f‹_óch_possibÀ_˝u
(
i
)

423 
	`‰ì_˝umask_v¨
(
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)

424 ->
sh¨ed_˝u_m≠
);

425 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

426 
	}
}

436 
__öô
 
	$a˝i_˝u‰eq_óæy_öô
()

438 
i
;

439 
	`d¥ötk
("acpi_cpufreq_early_init\n");

441 
a˝i_≥rf_d©a
 = 
	`Æloc_≥r˝u
(
a˝i_¥o˚ss‹_≥rf‹m™˚
);

442 i‡(!
a˝i_≥rf_d©a
) {

443 
	`d¥ötk
("MemoryállocationÉrror forácpi_perf_data.\n");

444  -
ENOMEM
;

446 
	`f‹_óch_possibÀ_˝u
(
i
) {

447 i‡(!
	`zÆloc_˝umask_v¨_node
(

448 &
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
i
)->
sh¨ed_˝u_m≠
,

449 
GFP_KERNEL
, 
	`˝u_to_node
(
i
))) {

452 
	`‰ì_a˝i_≥rf_d©a
();

453  -
ENOMEM
;

458 
	`a˝i_¥o˚ss‹_¥îegi°î_≥rf‹m™˚
(
a˝i_≥rf_d©a
);

460 
	}
}

462 #ifde‡
CONFIG_SMP


469 
	gbios_wôh_sw_™y_bug
;

471 
	$sw_™y_bug_found
(c⁄° 
dmi_sy°em_id
 *
d
)

473 
bios_wôh_sw_™y_bug
 = 1;

475 
	}
}

477 c⁄° 
dmi_sy°em_id
 
	gsw_™y_bug_dmi_èbÀ
[] = {

479 .
ˇŒback
 = 
sw_™y_bug_found
,

480 .
	gidít
 = "Supermicro Server X6DLP",

481 .
	gm©ches
 = {

482 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Supermicro"),

483 
DMI_MATCH
(
DMI_BIOS_VERSION
, "080010"),

484 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "X6DLP"),

490 
	$a˝i_˝u‰eq_bœckli°
(
˝uöfo_x86
 *
c
)

497 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

498 i‡((
c
->
x86
 == 15) &&

499 (
c
->
x86_modñ
 == 6) &&

500 (
c
->
x86_mask
 == 8)) {

501 
	`¥ötk
(
KERN_INFO
 "acpi-cpufreq: Intel(R) "

505  -
ENODEV
;

509 
	}
}

512 
	$a˝i_˝u‰eq_˝u_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

514 
i
;

515 
vÆid_°©es
 = 0;

516 
˝u
 = 
pﬁicy
->cpu;

517 
a˝i_˝u‰eq_d©a
 *
d©a
;

518 
ªsu…
 = 0;

519 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
pﬁicy
->
˝u
);

520 
a˝i_¥o˚ss‹_≥rf‹m™˚
 *
≥rf
;

521 #ifde‡
CONFIG_SMP


522 
bœckli°ed
;

525 
	`d¥ötk
("acpi_cpufreq_cpu_init\n");

527 #ifde‡
CONFIG_SMP


528 i‡(
bœckli°ed
)

529  
bœckli°ed
;

530 
bœckli°ed
 = 
	`a˝i_˝u‰eq_bœckli°
(
c
);

531 i‡(
bœckli°ed
)

532  
bœckli°ed
;

535 
d©a
 = 
	`kzÆloc
((
a˝i_˝u‰eq_d©a
), 
GFP_KERNEL
);

536 i‡(!
d©a
)

537  -
ENOMEM
;

539 
d©a
->
a˝i_d©a
 = 
	`≥r_˝u_±r
(
a˝i_≥rf_d©a
, 
˝u
);

540 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
d©a
;

542 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_CONSTANT_TSC
))

543 
a˝i_˝u‰eq_drivî
.
Êags
 |
CPUFREQ_CONST_LOOPS
;

545 
ªsu…
 = 
	`a˝i_¥o˚ss‹_ªgi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
, 
˝u
);

546 i‡(
ªsu…
)

547 
îr_‰ì
;

549 
≥rf
 = 
d©a
->
a˝i_d©a
;

550 
pﬁicy
->
sh¨ed_ty≥
 = 
≥rf
->shared_type;

556 i‡(
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ALL
 ||

557 
pﬁicy
->
sh¨ed_ty≥
 =
CPUFREQ_SHARED_TYPE_ANY
) {

558 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

560 
	`˝umask_c›y
(
pﬁicy
->
ªœãd_˝us
, 
≥rf
->
sh¨ed_˝u_m≠
);

562 #ifde‡
CONFIG_SMP


563 
	`dmi_check_sy°em
(
sw_™y_bug_dmi_èbÀ
);

564 i‡(
bios_wôh_sw_™y_bug
 && 
	`˝umask_weight
(
pﬁicy
->
˝us
) == 1) {

565 
pﬁicy
->
sh¨ed_ty≥
 = 
CPUFREQ_SHARED_TYPE_ALL
;

566 
	`˝umask_c›y
(
pﬁicy
->
˝us
, 
	`˝u_c‹e_mask
(
˝u
));

571 i‡(
≥rf
->
°©e_cou¡
 <= 1) {

572 
	`d¥ötk
("No P-States\n");

573 
ªsu…
 = -
ENODEV
;

574 
îr_uƒeg
;

577 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 !≥rf->
°©us_ªgi°î
.space_id) {

578 
ªsu…
 = -
ENODEV
;

579 
îr_uƒeg
;

582 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

583 
ACPI_ADR_SPACE_SYSTEM_IO
:

584 
	`d¥ötk
("SYSTEM IOáddr space\n");

585 
d©a
->
˝u_„©uª
 = 
SYSTEM_IO_CAPABLE
;

587 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

588 
	`d¥ötk
("HARDWAREáddr space\n");

589 i‡(!
	`check_e°_˝u
(
˝u
)) {

590 
ªsu…
 = -
ENODEV
;

591 
îr_uƒeg
;

593 
d©a
->
˝u_„©uª
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

596 
	`d¥ötk
("Unknownáddr space %d\n",

597 (
u32
Ë(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
));

598 
ªsu…
 = -
ENODEV
;

599 
îr_uƒeg
;

602 
d©a
->
‰eq_èbÀ
 = 
	`kmÆloc
((
˝u‰eq_‰equícy_èbÀ
) *

603 (
≥rf
->
°©e_cou¡
+1), 
GFP_KERNEL
);

604 i‡(!
d©a
->
‰eq_èbÀ
) {

605 
ªsu…
 = -
ENOMEM
;

606 
îr_uƒeg
;

610 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 0;

611 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

612 i‡((
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000) >

613 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
)

614 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 =

615 
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
 * 1000;

619 i‡(
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
 =
ACPI_ADR_SPACE_FIXED_HARDWARE
 &&

620 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 > 20 * 1000) {

621 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 20 * 1000;

622 
	`¥ötk_⁄˚
(
KERN_INFO


627 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++) {

628 i‡(
i
 > 0 && 
≥rf
->
°©es
[i].
c‹e_‰equícy
 >=

629 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
-1].
‰equícy
 / 1000)

632 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
ödex
 = 
i
;

633 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 =

634 
≥rf
->
°©es
[
i
].
c‹e_‰equícy
 * 1000;

635 
vÆid_°©es
++;

637 
d©a
->
‰eq_èbÀ
[
vÆid_°©es
].
‰equícy
 = 
CPUFREQ_TABLE_END
;

638 
≥rf
->
°©e
 = 0;

640 
ªsu…
 = 
	`˝u‰eq_‰equícy_èbÀ_˝uöfo
(
pﬁicy
, 
d©a
->
‰eq_èbÀ
);

641 i‡(
ªsu…
)

642 
îr_‰eq‰ì
;

644 i‡(
≥rf
->
°©es
[0].
c‹e_‰equícy
 * 1000 !
pﬁicy
->
˝uöfo
.
max_‰eq
)

645 
	`¥ötk
(
KERN_WARNING
 
FW_WARN
 "P-state 0 isÇot max freq\n");

647 
≥rf
->
c⁄åﬁ_ªgi°î
.
•a˚_id
) {

648 
ACPI_ADR_SPACE_SYSTEM_IO
:

650 
pﬁicy
->
cur
 = 
	`a˝i_˝u‰eq_guess_‰eq
(
d©a
,Öﬁicy->
˝u
);

652 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

653 
a˝i_˝u‰eq_drivî
.
gë
 = 
gë_cur_‰eq_⁄_˝u
;

654 
pﬁicy
->
cur
 = 
	`gë_cur_‰eq_⁄_˝u
(
˝u
);

661 
	`a˝i_¥o˚ss‹_nŸify_smm
(
THIS_MODULE
);

664 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_APERFMPERF
))

665 
a˝i_˝u‰eq_drivî
.
gëavg
 = 
˝u‰eq_gë_mósuªd_≥rf
;

667 
	`d¥ötk
("CPU%u - ACPIÖîf‹m™˚ m™agemíàa˘iv©ed.\n", 
˝u
);

668 
i
 = 0; i < 
≥rf
->
°©e_cou¡
; i++)

669 
	`d¥ötk
(" %cP%d: %d MHz, %d mW, %d uS\n",

670 (
i
 =
≥rf
->
°©e
 ? '*' : ' '), i,

671 (
u32
Ë
≥rf
->
°©es
[
i
].
c‹e_‰equícy
,

672 (
u32
Ë
≥rf
->
°©es
[
i
].
powî
,

673 (
u32
Ë
≥rf
->
°©es
[
i
].
å™sôi⁄_œãncy
);

675 
	`˝u‰eq_‰equícy_èbÀ_gë_©å
(
d©a
->
‰eq_èbÀ
, 
pﬁicy
->
˝u
);

681 
d©a
->
ªsume
 = 1;

683  
ªsu…
;

685 
îr_‰eq‰ì
:

686 
	`k‰ì
(
d©a
->
‰eq_èbÀ
);

687 
îr_uƒeg
:

688 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
≥rf
, 
˝u
);

689 
îr_‰ì
:

690 
	`k‰ì
(
d©a
);

691 
	`≥r_˝u
(
ac‰eq_d©a
, 
˝u
Ë
NULL
;

693  
ªsu…
;

694 
	}
}

696 
	$a˝i_˝u‰eq_˝u_exô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

698 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

700 
	`d¥ötk
("acpi_cpufreq_cpu_exit\n");

702 i‡(
d©a
) {

703 
	`˝u‰eq_‰equícy_èbÀ_put_©å
(
pﬁicy
->
˝u
);

704 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
Ë
NULL
;

705 
	`a˝i_¥o˚ss‹_uƒegi°î_≥rf‹m™˚
(
d©a
->
a˝i_d©a
,

706 
pﬁicy
->
˝u
);

707 
	`k‰ì
(
d©a
);

711 
	}
}

713 
	$a˝i_˝u‰eq_ªsume
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

715 
a˝i_˝u‰eq_d©a
 *
d©a
 = 
	`≥r_˝u
(
ac‰eq_d©a
, 
pﬁicy
->
˝u
);

717 
	`d¥ötk
("acpi_cpufreq_resume\n");

719 
d©a
->
ªsume
 = 1;

722 
	}
}

724 
‰eq_©å
 *
	ga˝i_˝u‰eq_©å
[] = {

725 &
˝u‰eq_‰eq_©å_sˇlög_avaûabÀ_‰eqs
,

726 
NULL
,

729 
˝u‰eq_drivî
 
	ga˝i_˝u‰eq_drivî
 = {

730 .
vîify
 = 
a˝i_˝u‰eq_vîify
,

731 .
	gèrgë
 = 
a˝i_˝u‰eq_èrgë
,

732 .
	gbios_limô
 = 
a˝i_¥o˚ss‹_gë_bios_limô
,

733 .
	göô
 = 
a˝i_˝u‰eq_˝u_öô
,

734 .
	gexô
 = 
a˝i_˝u‰eq_˝u_exô
,

735 .
	gªsume
 = 
a˝i_˝u‰eq_ªsume
,

736 .
	g«me
 = "acpi-cpufreq",

737 .
	gow√r
 = 
THIS_MODULE
,

738 .
	g©å
 = 
a˝i_˝u‰eq_©å
,

741 
__öô
 
	$a˝i_˝u‰eq_öô
()

743 
ªt
;

745 i‡(
a˝i_dißbÀd
)

748 
	`d¥ötk
("acpi_cpufreq_init\n");

750 
ªt
 = 
	`a˝i_˝u‰eq_óæy_öô
();

751 i‡(
ªt
)

752  
ªt
;

754 
ªt
 = 
	`˝u‰eq_ªgi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

755 i‡(
ªt
)

756 
	`‰ì_a˝i_≥rf_d©a
();

758  
ªt
;

759 
	}
}

761 
__exô
 
	$a˝i_˝u‰eq_exô
()

763 
	`d¥ötk
("acpi_cpufreq_exit\n");

765 
	`˝u‰eq_uƒegi°î_drivî
(&
a˝i_˝u‰eq_drivî
);

767 
	`‰ì_≥r˝u
(
a˝i_≥rf_d©a
);

768 
	}
}

770 
moduÀ_∑øm
(
a˝i_p°©e_°ri˘
, 
uöt
, 0644);

771 
MODULE_PARM_DESC
(
a˝i_p°©e_°ri˘
,

775 
œã_öôˇŒ
(
a˝i_˝u‰eq_öô
);

776 
moduÀ_exô
(
a˝i_˝u‰eq_exô
);

778 
MODULE_ALIAS
("acpi");

	@/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/mperf.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/smp.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/˝u‰eq.h
>

6 
	~<löux/¶ab.h
>

8 
	~"m≥rf.h
"

10 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ac‰eq_ﬁd_≥rf
);

13 
	$ªad_mósuªd_≥rf_˘rs
(*
_cur
)

15 
≠îfm≥rf
 *
am
 = 
_cur
;

17 
	`gë_≠îfm≥rf
(
am
);

18 
	}
}

33 
	$˝u‰eq_gë_mósuªd_≥rf
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

34 
˝u
)

36 
≠îfm≥rf
 
≥rf
;

37 
øtio
;

38 
ªtvÆ
;

40 i‡(
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
ªad_mósuªd_≥rf_˘rs
, &
≥rf
, 1))

43 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(&
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
), &
≥rf
);

44 
	`≥r_˝u
(
ac‰eq_ﬁd_≥rf
, 
˝u
Ë
≥rf
;

46 
ªtvÆ
 = (
pﬁicy
->
˝uöfo
.
max_‰eq
 * 
øtio
Ë>> 
APERFMPERF_SHIFT
;

48  
ªtvÆ
;

49 
	}
}

50 
EXPORT_SYMBOL_GPL
(
˝u‰eq_gë_mósuªd_≥rf
);

51 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c

24 
	~<löux/moduÀ.h
>

25 
	~<asm/¥o˚ss‹.h
>

26 
	~<asm/hy≥rvis‹.h
>

33 c⁄° 
__öôc⁄°
 
hy≥rvis‹_x86
 * c⁄° 
	ghy≥rvis‹s
[] =

35 &
x86_hy≥r_vmw¨e
,

36 &
x86_hy≥r_ms_hy≥rv
,

39 c⁄° 
hy≥rvis‹_x86
 *
	gx86_hy≥r
;

40 
EXPORT_SYMBOL
(
x86_hy≥r
);

42 
ölöe
 
__öô


43 
	$dëe˘_hy≥rvis‹_víd‹
()

45 c⁄° 
hy≥rvis‹_x86
 *
h
, * c⁄° *
p
;

47 
p
 = 
hy≥rvis‹s
;Ö < hy≥rvis‹†+ 
	`ARRAY_SIZE
(hypervisors);Ö++) {

48 
h
 = *
p
;

49 i‡(
h
->
	`dëe˘
()) {

50 
x86_hy≥r
 = 
h
;

51 
	`¥ötk
(
KERN_INFO
 "Hy≥rvis‹ dëe˘ed: %s\n", 
h
->
«me
);

55 
	}
}

57 
__˝uöô
 
	$öô_hy≥rvis‹
(
˝uöfo_x86
 *
c
)

59 i‡(
x86_hy≥r
 && x86_hy≥r->
£t_˝u_„©uªs
)

60 
x86_hy≥r
->
	`£t_˝u_„©uªs
(
c
);

61 
	}
}

63 
__öô
 
	$öô_hy≥rvis‹_∂©f‹m
()

66 
	`dëe˘_hy≥rvis‹_víd‹
();

68 i‡(!
x86_hy≥r
)

71 
	`öô_hy≥rvis‹
(&
boŸ_˝u_d©a
);

73 i‡(
x86_hy≥r
->
öô_∂©f‹m
)

74 
x86_hy≥r
->
	`öô_∂©f‹m
();

75 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/intel.c

1 
	~<löux/öô.h
>

2 
	~<löux/kî√l.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/bô›s.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/thªad_öfo.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/uac˚ss.h
>

12 
	~<asm/¥o˚ss‹.h
>

13 
	~<asm/pgèbÀ.h
>

14 
	~<asm/m§.h
>

15 
	~<asm/bugs.h
>

16 
	~<asm/˝u.h
>

18 #ifde‡
CONFIG_X86_64


19 
	~<löux/t›ﬁogy.h
>

20 
	~<asm/numa_64.h
>

23 
	~"˝u.h
"

25 #ifde‡
CONFIG_X86_LOCAL_APIC


26 
	~<asm/mp•ec.h
>

27 
	~<asm/≠ic.h
>

30 
__˝uöô
 
	$óæy_öô_öãl
(
˝uöfo_x86
 *
c
)

33 i‡(
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xd)) {

34 
u64
 
misc_íabÀ
;

36 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

38 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

39 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

40 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

41 
c
->
˝uid_Àvñ
 = 
	`˝uid_óx
(0);

45 i‡((
c
->
x86
 =0x‡&& c->
x86_modñ
 >= 0x03) ||

46 (
c
->
x86
 =0x6 && c->
x86_modñ
 >= 0x0e))

47 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

57 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =0x1¯&& c->
x86_mask
 <= 2) {

58 
u32
 
ucode
, 
junk
;

60 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

61 
	`sync_c‹e
();

62 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
junk
, 
ucode
);

64 i‡(
ucode
 < 0x20e) {

65 
	`¥ötk
(
KERN_WARNING
 "Atom PSEÉrratum detected, BIOS microcode updateÑecommended\n");

66 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PSE
);

70 #ifde‡
CONFIG_X86_64


71 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_SYSENTER32
);

74 i‡(
c
->
x86
 =15 && c->
x86_ˇche_Æignmít
 == 64)

75 
c
->
x86_ˇche_Æignmít
 = 128;

79 i‡(
c
->
x86
 =0xF && c->
x86_modñ
 == 0x3

80 && (
c
->
x86_mask
 == 0x3 || c->x86_mask == 0x4))

81 
c
->
x86_phys_bôs
 = 36;

90 i‡(
c
->
x86_powî
 & (1 << 8)) {

91 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

92 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_NONSTOP_TSC
);

93 i‡(!
	`check_tsc_un°abÀ
())

94 
sched_˛ock_°abÀ
 = 1;

107 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 15)

108 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_PAT
);

110 #ifde‡
CONFIG_KMEMCHECK


119 i‡(
c
->
x86
 == 15) {

120 
u64
 
misc_íabÀ
;

122 
	`rdm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

124 i‡(
misc_íabÀ
 & 
MSR_IA32_MISC_ENABLE_FAST_STRING
) {

125 
	`¥ötk
(
KERN_INFO
 "kmemcheck: Disabling fast string operations\n");

127 
misc_íabÀ
 &~
MSR_IA32_MISC_ENABLE_FAST_STRING
;

128 
	`wrm§l
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
);

132 
	}
}

134 #ifde‡
CONFIG_X86_32


141 
__˝uöô
 
	$µro_wôh_øm_bug
()

144 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

145 
boŸ_˝u_d©a
.
x86
 == 6 &&

146 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

147 
boŸ_˝u_d©a
.
x86_mask
 < 8) {

148 
	`¥ötk
(
KERN_INFO
 "Pentium Pro with Errata#50 detected. TakingÉvasiveáction.\n");

152 
	}
}

154 #ifde‡
CONFIG_X86_F00F_BUG


155 
__˝uöô
 
	$å≠_öô_f00f_bug
()

157 
	`__£t_fixm≠
(
FIX_F00F_IDT
, 
	`__∑
(&
idt_èbÀ
), 
PAGE_KERNEL_RO
);

163 
idt_des¸
.
addªss
 = 
	`fix_to_vút
(
FIX_F00F_IDT
);

164 
	`lﬂd_idt
(&
idt_des¸
);

165 
	}
}

168 
__˝uöô
 
	$öãl_smp_check
(
˝uöfo_x86
 *
c
)

170 #ifde‡
CONFIG_SMP


172 i‡(
c
->
˝u_ödex
 =
boŸ_˝u_id
)

178 i‡(
c
->
x86
 == 5 &&

179 
c
->
x86_mask
 >= 1 && c->x86_mask <= 4 &&

180 
c
->
x86_modñ
 <= 3) {

184 
	`WARN_ONCE
(1, "WARNING: SMP operation may be unreliable"

188 
	}
}

190 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

192 
lo
, 
hi
;

194 #ifde‡
CONFIG_X86_F00F_BUG


201 
c
->
f00f_bug
 = 0;

202 i‡(!
	`∑øvút_íabÀd
(Ë&& 
c
->
x86
 == 5) {

203 
f00f_w‹k¨ound_íabÀd
;

205 
c
->
f00f_bug
 = 1;

206 i‡(!
f00f_w‹k¨ound_íabÀd
) {

207 
	`å≠_öô_f00f_bug
();

208 
	`¥ötk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundÉnabled.\n");

209 
f00f_w‹k¨ound_íabÀd
 = 1;

218 i‡((
c
->
x86
<<8 | c->
x86_modñ
<<4 | c->
x86_mask
) < 0x633)

219 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_SEP
);

225 i‡((
c
->
x86
 =15Ë&& (c->
x86_modñ
 =1Ë&& (c->
x86_mask
 == 1)) {

226 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

227 i‡((
lo
 & 
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
) == 0) {

228 
	`¥ötk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

229 
	`¥ötk
 (
KERN_INFO
 "CPU: Disabling hardwareÖrefetching (Errata 037)\n");

230 
lo
 |
MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
;

231 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

241 i‡(
˝u_has_≠ic
 && (
c
->
x86
<<8 | c->
x86_modñ
<<4) == 0x520 &&

242 (
c
->
x86_mask
 < 0x6 || c->x86_mask == 0xb))

243 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_11AP
);

246 #ifde‡
CONFIG_X86_INTEL_USERCOPY


250 
c
->
x86
) {

256 
mov¶_mask
.
mask
 = 7;

259 
mov¶_mask
.
mask
 = 7;

264 #ifde‡
CONFIG_X86_NUMAQ


265 
	`numaq_tsc_dißbÀ
();

268 
	`öãl_smp_check
(
c
);

269 
	}
}

271 
__˝uöô
 
	$öãl_w‹k¨ounds
(
˝uöfo_x86
 *
c
)

273 
	}
}

276 
__˝uöô
 
	$§©_dëe˘_node
(
˝uöfo_x86
 *
c
)

278 #i‡
	`deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_64
)

279 
node
;

280 
˝u
 = 
	`smp_¥o˚ss‹_id
();

281 
≠icid
 = 
˝u_has_≠ic
 ? 
	`h¨d_smp_¥o˚ss‹_id
(Ë: 
c
->apicid;

285 
node
 = 
≠icid_to_node
[
≠icid
];

286 i‡(
node
 =
NUMA_NO_NODE
)

287 
node
 = 
	`fú°_node
(
node_⁄löe_m≠
);

288 i‡(!
	`node_⁄löe
(
node
)) {

290 
node
 = 
	`˝u_to_node
(
˝u
);

292 
	`numa_£t_node
(
˝u
, 
node
);

294 
	}
}

299 
__˝uöô
 
	$öãl_num_˝u_c‹es
(
˝uöfo_x86
 *
c
)

301 
óx
, 
ebx
, 
ecx
, 
edx
;

303 i‡(
c
->
˝uid_Àvñ
 < 4)

307 
	`˝uid_cou¡
(4, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

308 i‡(
óx
 & 0x1f)

309  (
óx
 >> 26) + 1;

312 
	}
}

314 
__˝uöô
 
	$dëe˘_vmx_vútˇp
(
˝uöfo_x86
 *
c
)

317 
	#X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
 0x00200000

	)

318 
	#X86_VMX_FEATURE_PROC_CTLS_VNMI
 0x00400000

	)

319 
	#X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
 0x80000000

	)

320 
	#X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
 0x00000001

	)

321 
	#X86_VMX_FEATURE_PROC_CTLS2_EPT
 0x00000002

	)

322 
	#X86_VMX_FEATURE_PROC_CTLS2_VPID
 0x00000020

	)

324 
u32
 
vmx_m§_low
, 
vmx_m§_high
, 
m§_˘l
, 
m§_˘l2
;

326 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

327 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

328 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

329 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

330 
	`˛ór_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

332 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS
, 
vmx_m§_low
, 
vmx_m§_high
);

333 
m§_˘l
 = 
vmx_m§_high
 | 
vmx_m§_low
;

334 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
)

335 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TPR_SHADOW
);

336 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_VNMI
)

337 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VNMI
);

338 i‡(
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_2ND_CTLS
) {

339 
	`rdm§
(
MSR_IA32_VMX_PROCBASED_CTLS2
,

340 
vmx_m§_low
, 
vmx_m§_high
);

341 
m§_˘l2
 = 
vmx_m§_high
 | 
vmx_m§_low
;

342 i‡((
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VIRT_APIC
) &&

343 (
m§_˘l
 & 
X86_VMX_FEATURE_PROC_CTLS_TPR_SHADOW
))

344 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_FLEXPRIORITY
);

345 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_EPT
)

346 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_EPT
);

347 i‡(
m§_˘l2
 & 
X86_VMX_FEATURE_PROC_CTLS2_VPID
)

348 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_VPID
);

350 
	}
}

352 
__˝uöô
 
	$öô_öãl
(
˝uöfo_x86
 *
c
)

354 
l2
 = 0;

356 
	`óæy_öô_öãl
(
c
);

358 
	`öãl_w‹k¨ounds
(
c
);

365 
	`dëe˘_exãnded_t›ﬁogy
(
c
);

367 
l2
 = 
	`öô_öãl_ˇcheöfo
(
c
);

368 i‡(
c
->
˝uid_Àvñ
 > 9) {

369 
óx
 = 
	`˝uid_óx
(10);

371 i‡((
óx
 & 0xff) && (((eax>>8) & 0xff) > 1))

372 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_ARCH_PERFMON
);

375 i‡(
˝u_has_xmm2
)

376 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_LFENCE_RDTSC
);

377 i‡(
˝u_has_ds
) {

378 
l1
;

379 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l1
, 
l2
);

380 i‡(!(
l1
 & (1<<11)))

381 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_BTS
);

382 i‡(!(
l1
 & (1<<12)))

383 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_PEBS
);

386 i‡(
c
->
x86
 =6 && c->
x86_modñ
 =29 && 
˝u_has_˛Êush
)

387 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CLFLUSH_MONITOR
);

389 #ifde‡
CONFIG_X86_64


390 i‡(
c
->
x86
 == 15)

391 
c
->
x86_ˇche_Æignmít
 = c->
x86_˛Êush_size
 * 2;

392 i‡(
c
->
x86
 == 6)

393 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_REP_GOOD
);

400 i‡(
c
->
x86
 == 6) {

401 *
p
 = 
NULL
;

403 
c
->
x86_modñ
) {

405 i‡(
c
->
x86_mask
 == 0) {

406 i‡(
l2
 == 0)

407 
p
 = "Celeron (Covington)";

408 i‡(
l2
 == 256)

409 
p
 = "Mobile Pentium II (Dixon)";

414 i‡(
l2
 == 128)

415 
p
 = "Celeron (Mendocino)";

416 i‡(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

417 
p
 = "Celeron-A";

421 i‡(
l2
 == 128)

422 
p
 = "Celeron (Coppermine)";

426 i‡(
p
)

427 
	`°r˝y
(
c
->
x86_modñ_id
, 
p
);

430 i‡(
c
->
x86
 == 15)

431 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P4
);

432 i‡(
c
->
x86
 == 6)

433 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_P3
);

436 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_XTOPOLOGY
)) {

441 
c
->
x86_max_c‹es
 = 
	`öãl_num_˝u_c‹es
(c);

442 #ifde‡
CONFIG_X86_32


443 
	`dëe˘_ht
(
c
);

448 
	`§©_dëe˘_node
(
c
);

450 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_VMX
))

451 
	`dëe˘_vmx_vútˇp
(
c
);

452 
	}
}

454 #ifde‡
CONFIG_X86_32


455 
__˝uöô
 
	$öãl_size_ˇche
(
˝uöfo_x86
 *
c
, 
size
)

463 i‡((
c
->
x86
 =6Ë&& (c->
x86_modñ
 =11Ë&& (
size
 == 0))

464 
size
 = 256;

465  
size
;

466 
	}
}

469 c⁄° 
˝u_dev
 
__˝uöôc⁄°
 
	göãl_˝u_dev
 = {

470 .
c_víd‹
 = "Intel",

471 .
	gc_idít
 = { "GenuineIntel" },

472 #ifde‡
CONFIG_X86_32


473 .
	gc_modñs
 = {

474 { .
víd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 4, .
	gmodñ_«mes
 =

487 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 5, .
	gmodñ_«mes
 =

498 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 6, .
	gmodñ_«mes
 =

512 { .
	gvíd‹
 = 
X86_VENDOR_INTEL
, .
	gÁmûy
 = 15, .
	gmodñ_«mes
 =

522 .
	gc_size_ˇche
 = 
öãl_size_ˇche
,

524 .
	gc_óæy_öô
 = 
óæy_öô_öãl
,

525 .
	gc_öô
 = 
öô_öãl
,

526 .
	gc_x86_víd‹
 = 
X86_VENDOR_INTEL
,

529 
˝u_dev_ªgi°î
(
öãl_˝u_dev
);

	@/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c

10 
	~<löux/öô.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/˝u.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<löux/smp.h
>

20 
	~<asm/k8.h
>

21 
	~<asm/smp.h
>

23 
	#LVL_1_INST
 1

	)

24 
	#LVL_1_DATA
 2

	)

25 
	#LVL_2
 3

	)

26 
	#LVL_3
 4

	)

27 
	#LVL_TRACE
 5

	)

29 
	s_ˇche_èbÀ
 {

30 
	mdes¸ùt‹
;

31 
	mˇche_ty≥
;

32 
	msize
;

35 
	#MB
(
x
Ë((xË* 1024)

	)

40 c⁄° 
_ˇche_èbÀ
 
__˝uöôc⁄°
 
	gˇche_èbÀ
[] =

42 { 0x06, 
LVL_1_INST
, 8 },

43 { 0x08, 
LVL_1_INST
, 16 },

44 { 0x09, 
LVL_1_INST
, 32 },

45 { 0x0a, 
LVL_1_DATA
, 8 },

46 { 0x0c, 
LVL_1_DATA
, 16 },

47 { 0x0d, 
LVL_1_DATA
, 16 },

48 { 0x21, 
LVL_2
, 256 },

49 { 0x22, 
LVL_3
, 512 },

50 { 0x23, 
LVL_3
, 
MB
(1) },

51 { 0x25, 
LVL_3
, 
MB
(2) },

52 { 0x29, 
LVL_3
, 
MB
(4) },

53 { 0x2c, 
LVL_1_DATA
, 32 },

54 { 0x30, 
LVL_1_INST
, 32 },

55 { 0x39, 
LVL_2
, 128 },

56 { 0x3a, 
LVL_2
, 192 },

57 { 0x3b, 
LVL_2
, 128 },

58 { 0x3c, 
LVL_2
, 256 },

59 { 0x3d, 
LVL_2
, 384 },

60 { 0x3e, 
LVL_2
, 512 },

61 { 0x3f, 
LVL_2
, 256 },

62 { 0x41, 
LVL_2
, 128 },

63 { 0x42, 
LVL_2
, 256 },

64 { 0x43, 
LVL_2
, 512 },

65 { 0x44, 
LVL_2
, 
MB
(1) },

66 { 0x45, 
LVL_2
, 
MB
(2) },

67 { 0x46, 
LVL_3
, 
MB
(4) },

68 { 0x47, 
LVL_3
, 
MB
(8) },

69 { 0x49, 
LVL_3
, 
MB
(4) },

70 { 0x4a, 
LVL_3
, 
MB
(6) },

71 { 0x4b, 
LVL_3
, 
MB
(8) },

72 { 0x4c, 
LVL_3
, 
MB
(12) },

73 { 0x4d, 
LVL_3
, 
MB
(16) },

74 { 0x4e, 
LVL_2
, 
MB
(6) },

75 { 0x60, 
LVL_1_DATA
, 16 },

76 { 0x66, 
LVL_1_DATA
, 8 },

77 { 0x67, 
LVL_1_DATA
, 16 },

78 { 0x68, 
LVL_1_DATA
, 32 },

79 { 0x70, 
LVL_TRACE
, 12 },

80 { 0x71, 
LVL_TRACE
, 16 },

81 { 0x72, 
LVL_TRACE
, 32 },

82 { 0x73, 
LVL_TRACE
, 64 },

83 { 0x78, 
LVL_2
, 
MB
(1) },

84 { 0x79, 
LVL_2
, 128 },

85 { 0x7a, 
LVL_2
, 256 },

86 { 0x7b, 
LVL_2
, 512 },

87 { 0x7c, 
LVL_2
, 
MB
(1) },

88 { 0x7d, 
LVL_2
, 
MB
(2) },

89 { 0x7f, 
LVL_2
, 512 },

90 { 0x82, 
LVL_2
, 256 },

91 { 0x83, 
LVL_2
, 512 },

92 { 0x84, 
LVL_2
, 
MB
(1) },

93 { 0x85, 
LVL_2
, 
MB
(2) },

94 { 0x86, 
LVL_2
, 512 },

95 { 0x87, 
LVL_2
, 
MB
(1) },

96 { 0xd0, 
LVL_3
, 512 },

97 { 0xd1, 
LVL_3
, 
MB
(1) },

98 { 0xd2, 
LVL_3
, 
MB
(2) },

99 { 0xd6, 
LVL_3
, 
MB
(1) },

100 { 0xd7, 
LVL_3
, 
MB
(2) },

101 { 0xd8, 
LVL_3
, 
MB
(4) },

102 { 0xdc, 
LVL_3
, 
MB
(2) },

103 { 0xdd, 
LVL_3
, 
MB
(4) },

104 { 0xde, 
LVL_3
, 
MB
(8) },

105 { 0xe2, 
LVL_3
, 
MB
(2) },

106 { 0xe3, 
LVL_3
, 
MB
(4) },

107 { 0xe4, 
LVL_3
, 
MB
(8) },

108 { 0xó, 
LVL_3
, 
MB
(12) },

109 { 0xeb, 
LVL_3
, 
MB
(18) },

110 { 0xec, 
LVL_3
, 
MB
(24) },

115 
	e_ˇche_ty≥
 {

116 
	mCACHE_TYPE_NULL
 = 0,

117 
	mCACHE_TYPE_DATA
 = 1,

118 
	mCACHE_TYPE_INST
 = 2,

119 
	mCACHE_TYPE_UNIFIED
 = 3

122 
	u_˝uid4_Àaf_óx
 {

124 
_ˇche_ty≥
 
	mty≥
:5;

125 
	mÀvñ
:3;

126 
	mis_£lf_öôülizög
:1;

127 
	mis_fuŒy_assocütive
:1;

128 
	mª£rved
:4;

129 
	mnum_thªads_sh¨ög
:12;

130 
	mnum_c‹es_⁄_dõ
:6;

131 } 
	m•lô
;

132 
u32
 
	mfuŒ
;

135 
	u_˝uid4_Àaf_ebx
 {

137 
	mcohîícy_löe_size
:12;

138 
	mphysiˇl_löe_∑πôi⁄
:10;

139 
	mways_of_assocütivôy
:10;

140 } 
	m•lô
;

141 
u32
 
	mfuŒ
;

144 
	u_˝uid4_Àaf_ecx
 {

146 
	mnumbî_of_£ts
:32;

147 } 
	m•lô
;

148 
u32
 
	mfuŒ
;

151 
	samd_l3_ˇche
 {

152 
pci_dev
 *
	mdev
;

153 
boﬁ
 
	mˇn_dißbÀ
;

154 
	mödi˚s
;

155 
u8
 
	msubˇches
[4];

158 
	s_˝uid4_öfo
 {

159 
_˝uid4_Àaf_óx
 
	móx
;

160 
_˝uid4_Àaf_ebx
 
	mebx
;

161 
_˝uid4_Àaf_ecx
 
	mecx
;

162 
	msize
;

163 
amd_l3_ˇche
 *
	ml3
;

164 
DECLARE_BITMAP
(
sh¨ed_˝u_m≠
, 
NR_CPUS
);

168 
	s_˝uid4_öfo_ªgs
 {

169 
_˝uid4_Àaf_óx
 
	móx
;

170 
_˝uid4_Àaf_ebx
 
	mebx
;

171 
_˝uid4_Àaf_ecx
 
	mecx
;

172 
	msize
;

173 
amd_l3_ˇche
 *
	ml3
;

176 
	gnum_ˇche_Àaves
;

184 
	ul1_ˇche
 {

186 
	mlöe_size
:8;

187 
	mlöes_≥r_èg
:8;

188 
	massoc
:8;

189 
	msize_ö_kb
:8;

191 
	mvÆ
;

194 
	ul2_ˇche
 {

196 
	mlöe_size
:8;

197 
	mlöes_≥r_èg
:4;

198 
	massoc
:4;

199 
	msize_ö_kb
:16;

201 
	mvÆ
;

204 
	ul3_ˇche
 {

206 
	mlöe_size
:8;

207 
	mlöes_≥r_èg
:4;

208 
	massoc
:4;

209 
	mªs
:2;

210 
	msize_ícoded
:14;

212 
	mvÆ
;

215 c⁄° 
__˝uöôc⁄°
 
	gassocs
[] = {

229 c⁄° 
__˝uöôc⁄°
 
	gÀvñs
[] = { 1, 1, 2, 3 };

230 c⁄° 
__˝uöôc⁄°
 
	gty≥s
[] = { 1, 2, 3, 3 };

232 
__˝uöô


233 
	$amd_˝uid4
(
Àaf
, 
_˝uid4_Àaf_óx
 *
óx
,

234 
_˝uid4_Àaf_ebx
 *
ebx
,

235 
_˝uid4_Àaf_ecx
 *
ecx
)

237 
dummy
;

238 
löe_size
, 
löes_≥r_èg
, 
assoc
, 
size_ö_kb
;

239 
l1_ˇche
 
l1i
, 
l1d
;

240 
l2_ˇche
 
l2
;

241 
l3_ˇche
 
l3
;

242 
l1_ˇche
 *
l1
 = &
l1d
;

244 
óx
->
fuŒ
 = 0;

245 
ebx
->
fuŒ
 = 0;

246 
ecx
->
fuŒ
 = 0;

248 
	`˝uid
(0x80000005, &
dummy
, &dummy, &
l1d
.
vÆ
, &
l1i
.val);

249 
	`˝uid
(0x80000006, &
dummy
, &dummy, &
l2
.
vÆ
, &
l3
.val);

251 
Àaf
) {

253 
l1
 = &
l1i
;

255 i‡(!
l1
->
vÆ
)

257 
assoc
 = 
assocs
[
l1
->assoc];

258 
löe_size
 = 
l1
->line_size;

259 
löes_≥r_èg
 = 
l1
->lines_per_tag;

260 
size_ö_kb
 = 
l1
->size_in_kb;

263 i‡(!
l2
.
vÆ
)

265 
assoc
 = 
assocs
[
l2
.assoc];

266 
löe_size
 = 
l2
.line_size;

267 
löes_≥r_èg
 = 
l2
.lines_per_tag;

269 
size_ö_kb
 = 
cuºít_˝u_d©a
.
x86_ˇche_size
;

272 i‡(!
l3
.
vÆ
)

274 
assoc
 = 
assocs
[
l3
.assoc];

275 
löe_size
 = 
l3
.line_size;

276 
löes_≥r_èg
 = 
l3
.lines_per_tag;

277 
size_ö_kb
 = 
l3
.
size_ícoded
 * 512;

278 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_AMD_DCM
)) {

279 
size_ö_kb
 = size_in_kb >> 1;

280 
assoc
 =ássoc >> 1;

287 
óx
->
•lô
.
is_£lf_öôülizög
 = 1;

288 
óx
->
•lô
.
ty≥
 = 
ty≥s
[
Àaf
];

289 
óx
->
•lô
.
Àvñ
 = 
Àvñs
[
Àaf
];

290 
óx
->
•lô
.
num_thªads_sh¨ög
 = 0;

291 
óx
->
•lô
.
num_c‹es_⁄_dõ
 = 
cuºít_˝u_d©a
.
x86_max_c‹es
 - 1;

294 i‡(
assoc
 == 0xffff)

295 
óx
->
•lô
.
is_fuŒy_assocütive
 = 1;

296 
ebx
->
•lô
.
cohîícy_löe_size
 = 
löe_size
 - 1;

297 
ebx
->
•lô
.
ways_of_assocütivôy
 = 
assoc
 - 1;

298 
ebx
->
•lô
.
physiˇl_löe_∑πôi⁄
 = 
löes_≥r_èg
 - 1;

299 
ecx
->
•lô
.
numbî_of_£ts
 = (
size_ö_kb
 * 1024Ë/ 
löe_size
 /

300 (
ebx
->
•lô
.
ways_of_assocütivôy
 + 1) - 1;

301 
	}
}

303 
	s_ˇche_©å
 {

304 
©åibuã
 
	m©å
;

305 
ssize_t
 (*
show
)(
	m_˝uid4_öfo
 *, *);

306 
ssize_t
 (*
°‹e
)(
	m_˝uid4_öfo
 *, c⁄° *, 
size_t
 
	mcou¡
);

309 #ifde‡
CONFIG_CPU_SUP_AMD


314 
amd_l3_ˇche
 **
__˝uöôd©a
 
	gl3_ˇches
;

316 
__˝uöô
 
	$amd_ˇlc_l3_ödi˚s
(
amd_l3_ˇche
 *
l3
)

318 
sc0
, 
sc1
, 
sc2
, 
sc3
;

319 
u32
 
vÆ
 = 0;

321 
	`pci_ªad_c⁄fig_dw‹d
(
l3
->
dev
, 0x1C4, &
vÆ
);

324 
l3
->
subˇches
[0] = 
sc0
 = !(
vÆ
 & 
	`BIT
(0));

325 
l3
->
subˇches
[1] = 
sc1
 = !(
vÆ
 & 
	`BIT
(4));

326 
l3
->
subˇches
[2] = 
sc2
 = !(
vÆ
 & 
	`BIT
(8)) + !(val & BIT(9));

327 
l3
->
subˇches
[3] = 
sc3
 = !(
vÆ
 & 
	`BIT
(12)) + !(val & BIT(13));

329 
l3
->
ödi˚s
 = (
	`max
(max(max(
sc0
, 
sc1
), 
sc2
), 
sc3
) << 10) - 1;

330 
	}
}

332 
amd_l3_ˇche
 * 
__˝uöô
 
	$amd_öô_l3_ˇche
(
node
)

334 
amd_l3_ˇche
 *
l3
;

335 
pci_dev
 *
dev
 = 
	`node_to_k8_nb_misc
(
node
);

337 
l3
 = 
	`kzÆloc
((
amd_l3_ˇche
), 
GFP_ATOMIC
);

338 i‡(!
l3
) {

339 
	`¥ötk
(
KERN_WARNING
 "Errorállocating L3 struct\n");

340  
NULL
;

343 
l3
->
dev
 = dev;

345 
	`amd_ˇlc_l3_ödi˚s
(
l3
);

347  
l3
;

348 
	}
}

350 
__˝uöô


351 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

353 
node
;

355 i‡(
boŸ_˝u_d©a
.
x86
 != 0x10)

358 i‡(
ödex
 < 3)

362 i‡(
boŸ_˝u_d©a
.
x86_modñ
 < 0x8)

365 i‡((
boŸ_˝u_d©a
.
x86_modñ
 == 0x8 ||

366 
boŸ_˝u_d©a
.
x86_modñ
 == 0x9)

368 
boŸ_˝u_d©a
.
x86_mask
 < 0x1)

372 i‡(
num_k8_n‹thbridges
 == 0)

379 i‡(!
l3_ˇches
) {

380 
size
 = 
num_k8_n‹thbridges
 * (
amd_l3_ˇche
 *);

382 
l3_ˇches
 = 
	`kzÆloc
(
size
, 
GFP_ATOMIC
);

383 i‡(!
l3_ˇches
)

387 
node
 = 
	`amd_gë_nb_id
(
	`smp_¥o˚ss‹_id
());

389 i‡(!
l3_ˇches
[
node
]) {

390 
l3_ˇches
[
node
] = 
	`amd_öô_l3_ˇche
(node);

391 
l3_ˇches
[
node
]->
ˇn_dißbÀ
 = 
åue
;

394 
	`WARN_ON
(!
l3_ˇches
[
node
]);

396 
this_Àaf
->
l3
 = 
l3_ˇches
[
node
];

397 
	}
}

399 
ssize_t
 
	$show_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
,

400 
¶Ÿ
)

402 
pci_dev
 *
dev
 = 
this_Àaf
->
l3
->dev;

403 
ªg
 = 0;

405 i‡(!
this_Àaf
->
l3
 || !this_Àaf->l3->
ˇn_dißbÀ
)

406  -
EINVAL
;

408 i‡(!
dev
)

409  -
EINVAL
;

411 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x1BC + 
¶Ÿ
 * 4, &
ªg
);

412  
	`•rötf
(
buf
, "0x%08x\n", 
ªg
);

413 
	}
}

415 
	#SHOW_CACHE_DISABLE
(
¶Ÿ
) \

416 
ssize_t
 \

417 
show_ˇche_dißbÀ_
##
	`¶Ÿ
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

419  
	`show_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
¶Ÿ
); \

420 }

	)

421 
	$SHOW_CACHE_DISABLE
(0)

422 
	$SHOW_CACHE_DISABLE
(1)

424 
	$amd_l3_dißbÀ_ödex
(
amd_l3_ˇche
 *
l3
, 
˝u
,

425 
¶Ÿ
, 
idx
)

427 
i
;

429 
idx
 |
	`BIT
(30);

434 
i
 = 0; i < 4; i++) {

435 
u32
 
ªg
 = 
idx
 | (
i
 << 20);

437 i‡(!
l3
->
subˇches
[
i
])

440 
	`pci_wrôe_c⁄fig_dw‹d
(
l3
->
dev
, 0x1BC + 
¶Ÿ
 * 4, 
ªg
);

447 
	`wbövd_⁄_˝u
(
˝u
);

449 
ªg
 |
	`BIT
(31);

450 
	`pci_wrôe_c⁄fig_dw‹d
(
l3
->
dev
, 0x1BC + 
¶Ÿ
 * 4, 
ªg
);

452 
	}
}

455 
ssize_t
 
	$°‹e_ˇche_dißbÀ
(
_˝uid4_öfo
 *
this_Àaf
,

456 c⁄° *
buf
, 
size_t
 
cou¡
,

457 
¶Ÿ
)

459 
pci_dev
 *
dev
 = 
this_Àaf
->
l3
->dev;

460 
˝u
 = 
	`˝umask_fú°
(
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

461 
vÆ
 = 0;

463 
	#SUBCACHE_MASK
 (3UL << 20)

	)

464 
	#SUBCACHE_INDEX
 0xfff

	)

466 i‡(!
this_Àaf
->
l3
 || !this_Àaf->l3->
ˇn_dißbÀ
)

467  -
EINVAL
;

469 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

470  -
EPERM
;

472 i‡(!
dev
)

473  -
EINVAL
;

475 i‡(
	`°ri˘_°πoul
(
buf
, 10, &
vÆ
) < 0)

476  -
EINVAL
;

479 i‡((
vÆ
 & ~(
SUBCACHE_MASK
 | 
SUBCACHE_INDEX
)) ||

480 ((
vÆ
 & 
SUBCACHE_INDEX
Ë> 
this_Àaf
->
l3
->
ödi˚s
))

481  -
EINVAL
;

483 
	`amd_l3_dißbÀ_ödex
(
this_Àaf
->
l3
, 
˝u
, 
¶Ÿ
, 
vÆ
);

485  
cou¡
;

486 
	}
}

488 
	#STORE_CACHE_DISABLE
(
¶Ÿ
) \

489 
ssize_t
 \

490 
°‹e_ˇche_dißbÀ_
##
	`¶Ÿ
(
_˝uid4_öfo
 *
this_Àaf
, \

491 c⁄° *
buf
, 
size_t
 
cou¡
) \

493  
	`°‹e_ˇche_dißbÀ
(
this_Àaf
, 
buf
, 
cou¡
, 
¶Ÿ
); \

494 }

	)

495 
	$STORE_CACHE_DISABLE
(0)

496 
	$STORE_CACHE_DISABLE
(1)

498 
_ˇche_©å
 
ˇche_dißbÀ_0
 = 
	`__ATTR
(cache_disable_0, 0644,

499 
show_ˇche_dißbÀ_0
, 
°‹e_ˇche_dißbÀ_0
);

500 
_ˇche_©å
 
ˇche_dißbÀ_1
 = 
	`__ATTR
(cache_disable_1, 0644,

501 
show_ˇche_dißbÀ_1
, 
°‹e_ˇche_dißbÀ_1
);

504 
__˝uöô


505 
	$amd_check_l3_dißbÀ
(
ödex
, 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

507 
	}
};

511 
__˝uöô
 
	$˝uid4_ˇche_lookup_ªgs
(
ödex
,

512 
_˝uid4_öfo_ªgs
 *
this_Àaf
)

514 
_˝uid4_Àaf_óx
 
óx
;

515 
_˝uid4_Àaf_ebx
 
ebx
;

516 
_˝uid4_Àaf_ecx
 
ecx
;

517 
edx
;

519 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) {

520 
	`amd_˝uid4
(
ödex
, &
óx
, &
ebx
, &
ecx
);

521 
	`amd_check_l3_dißbÀ
(
ödex
, 
this_Àaf
);

523 
	`˝uid_cou¡
(4, 
ödex
, &
óx
.
fuŒ
, &
ebx
.fuŒ, &
ecx
.fuŒ, &
edx
);

526 i‡(
óx
.
•lô
.
ty≥
 =
CACHE_TYPE_NULL
)

527  -
EIO
;

529 
this_Àaf
->
óx
 =Éax;

530 
this_Àaf
->
ebx
 =Ébx;

531 
this_Àaf
->
ecx
 =Écx;

532 
this_Àaf
->
size
 = (
ecx
.
•lô
.
numbî_of_£ts
 + 1) *

533 (
ebx
.
•lô
.
cohîícy_löe_size
 + 1) *

534 (
ebx
.
•lô
.
physiˇl_löe_∑πôi⁄
 + 1) *

535 (
ebx
.
•lô
.
ways_of_assocütivôy
 + 1);

537 
	}
}

539 
__˝uöô
 
	$föd_num_ˇche_Àaves
()

541 
óx
, 
ebx
, 
ecx
, 
edx
;

542 
_˝uid4_Àaf_óx
 
ˇche_óx
;

543 
i
 = -1;

546 ++
i
;

548 
	`˝uid_cou¡
(4, 
i
, &
óx
, &
ebx
, &
ecx
, &
edx
);

549 
ˇche_óx
.
fuŒ
 = 
óx
;

550 } 
ˇche_óx
.
•lô
.
ty≥
 !
CACHE_TYPE_NULL
);

551  
i
;

552 
	}
}

554 
__˝uöô
 
	$öô_öãl_ˇcheöfo
(
˝uöfo_x86
 *
c
)

557 
åa˚
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

558 
√w_l1d
 = 0, 
√w_l1i
 = 0;

559 
√w_l2
 = 0, 
√w_l3
 = 0, 
i
;

560 
l2_id
 = 0, 
l3_id
 = 0, 
num_thªads_sh¨ög
, 
ödex_msb
;

561 #ifde‡
CONFIG_X86_HT


562 
˝u
 = 
c
->
˝u_ödex
;

565 i‡(
c
->
˝uid_Àvñ
 > 3) {

566 
is_öôülized
;

568 i‡(
is_öôülized
 == 0) {

570 
num_ˇche_Àaves
 = 
	`föd_num_ˇche_Àaves
();

571 
is_öôülized
++;

578 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

579 
_˝uid4_öfo_ªgs
 
this_Àaf
;

580 
ªtvÆ
;

582 
ªtvÆ
 = 
	`˝uid4_ˇche_lookup_ªgs
(
i
, &
this_Àaf
);

583 i‡(
ªtvÆ
 >= 0) {

584 
this_Àaf
.
óx
.
•lô
.
Àvñ
) {

586 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

587 
CACHE_TYPE_DATA
)

588 
√w_l1d
 = 
this_Àaf
.
size
/1024;

589 i‡(
this_Àaf
.
óx
.
•lô
.
ty≥
 ==

590 
CACHE_TYPE_INST
)

591 
√w_l1i
 = 
this_Àaf
.
size
/1024;

594 
√w_l2
 = 
this_Àaf
.
size
/1024;

595 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

596 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

597 
l2_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

600 
√w_l3
 = 
this_Àaf
.
size
/1024;

601 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
.
óx
.
•lô
.num_threads_sharing;

602 
ödex_msb
 = 
	`gë_cou¡_‹dî
(

603 
num_thªads_sh¨ög
);

604 
l3_id
 = 
c
->
≠icid
 >> 
ödex_msb
;

616 i‡((
num_ˇche_Àaves
 =0 || 
c
->
x86
 =15Ë&& c->
˝uid_Àvñ
 > 1) {

618 
j
, 
n
;

619 
ªgs
[4];

620 *
dp
 = (*)
ªgs
;

621 
⁄ly_åa˚
 = 0;

623 i‡(
num_ˇche_Àaves
 !0 && 
c
->
x86
 == 15)

624 
⁄ly_åa˚
 = 1;

627 
n
 = 
	`˝uid_óx
(2) & 0xFF;

629 
i
 = 0 ; i < 
n
 ; i++) {

630 
	`˝uid
(2, &
ªgs
[0], &regs[1], &regs[2], &regs[3]);

633 
j
 = 0 ; j < 3 ; j++)

634 i‡(
ªgs
[
j
] & (1 << 31))

635 
ªgs
[
j
] = 0;

638 
j
 = 1 ; j < 16 ; j++) {

639 
des
 = 
dp
[
j
];

640 
k
 = 0;

643 
ˇche_èbÀ
[
k
].
des¸ùt‹
 != 0) {

644 i‡(
ˇche_èbÀ
[
k
].
des¸ùt‹
 =
des
) {

645 i‡(
⁄ly_åa˚
 && 
ˇche_èbÀ
[
k
].
ˇche_ty≥
 !
LVL_TRACE
)

647 
ˇche_èbÀ
[
k
].
ˇche_ty≥
) {

648 
LVL_1_INST
:

649 
l1i
 +
ˇche_èbÀ
[
k
].
size
;

651 
LVL_1_DATA
:

652 
l1d
 +
ˇche_èbÀ
[
k
].
size
;

654 
LVL_2
:

655 
l2
 +
ˇche_èbÀ
[
k
].
size
;

657 
LVL_3
:

658 
l3
 +
ˇche_èbÀ
[
k
].
size
;

660 
LVL_TRACE
:

661 
åa˚
 +
ˇche_èbÀ
[
k
].
size
;

668 
k
++;

674 i‡(
√w_l1d
)

675 
l1d
 = 
√w_l1d
;

677 i‡(
√w_l1i
)

678 
l1i
 = 
√w_l1i
;

680 i‡(
√w_l2
) {

681 
l2
 = 
√w_l2
;

682 #ifde‡
CONFIG_X86_HT


683 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l2_id
;

687 i‡(
√w_l3
) {

688 
l3
 = 
√w_l3
;

689 #ifde‡
CONFIG_X86_HT


690 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë
l3_id
;

694 
c
->
x86_ˇche_size
 = 
l3
 ?Ü3 : (
l2
 ?Ü2 : (
l1i
+
l1d
));

696  
l2
;

697 
	}
}

699 #ifde‡
CONFIG_SYSFS


702 
DEFINE_PER_CPU
(
_˝uid4_öfo
 *, 
ici_˝uid4_öfo
);

703 
	#CPUID4_INFO_IDX
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_˝uid4_öfo
, x))[y]))

	)

705 #ifde‡
CONFIG_SMP


706 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

708 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

709 
num_thªads_sh¨ög
;

710 
ödex_msb
, 
i
, 
siblög
;

711 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

713 i‡((
ödex
 =3Ë&& (
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)) {

714 
	`f‹_óch_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
) {

715 i‡(!
	`≥r_˝u
(
ici_˝uid4_öfo
, 
i
))

717 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

718 
	`f‹_óch_˝u
(
siblög
, 
c
->
Œc_sh¨ed_m≠
) {

719 i‡(!
	`˝u_⁄löe
(
siblög
))

721 
	`£t_bô
(
siblög
, 
this_Àaf
->
sh¨ed_˝u_m≠
);

726 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

727 
num_thªads_sh¨ög
 = 1 + 
this_Àaf
->
óx
.
•lô
.num_threads_sharing;

729 i‡(
num_thªads_sh¨ög
 == 1)

730 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

732 
ödex_msb
 = 
	`gë_cou¡_‹dî
(
num_thªads_sh¨ög
);

734 
	`f‹_óch_⁄löe_˝u
(
i
) {

735 i‡(
	`˝u_d©a
(
i
).
≠icid
 >> 
ödex_msb
 ==

736 
c
->
≠icid
 >> 
ödex_msb
) {

737 
	`˝umask_£t_˝u
(
i
,

738 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
));

739 i‡(
i
 !
˝u
 && 
	`≥r_˝u
(
ici_˝uid4_öfo
, i)) {

740 
siblög_Àaf
 =

741 
	`CPUID4_INFO_IDX
(
i
, 
ödex
);

742 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(

743 
siblög_Àaf
->
sh¨ed_˝u_m≠
));

748 
	}
}

749 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

751 
_˝uid4_öfo
 *
this_Àaf
, *
siblög_Àaf
;

752 
siblög
;

754 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
ödex
);

755 
	`f‹_óch_˝u
(
siblög
, 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
)) {

756 
siblög_Àaf
 = 
	`CPUID4_INFO_IDX
(
siblög
, 
ödex
);

757 
	`˝umask_˛ór_˝u
(
˝u
,

758 
	`to_˝umask
(
siblög_Àaf
->
sh¨ed_˝u_m≠
));

760 
	}
}

762 
__˝uöô
 
	$ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
ödex
)

764 
	}
}

766 
__˝uöô
 
	$ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
ödex
)

768 
	}
}

771 
__˝uöô
 
	$‰ì_ˇche_©åibuãs
(
˝u
)

773 
i
;

775 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

776 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

778 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
)->
l3
);

779 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

780 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

781 
	}
}

784 
__˝uöô
 
	$˝uid4_ˇche_lookup
(
ödex
, 
_˝uid4_öfo
 *
this_Àaf
)

786 
_˝uid4_öfo_ªgs
 *
Àaf_ªgs
 =

787 (
_˝uid4_öfo_ªgs
 *)
this_Àaf
;

789  
	`˝uid4_ˇche_lookup_ªgs
(
ödex
, 
Àaf_ªgs
);

790 
	}
}

792 
__˝uöô
 
	$gë_˝u_Àaves
(*
_ªtvÆ
)

794 
j
, *
ªtvÆ
 = 
_ªtvÆ
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

797 
j
 = 0; j < 
num_ˇche_Àaves
; j++) {

798 
_˝uid4_öfo
 *
this_Àaf
;

799 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
j
);

800 *
ªtvÆ
 = 
	`˝uid4_ˇche_lookup
(
j
, 
this_Àaf
);

801 i‡(
	`u∆ikñy
(*
ªtvÆ
 < 0)) {

802 
i
;

804 
i
 = 0; i < 
j
; i++)

805 
	`ˇche_ªmove_sh¨ed_˝u_m≠
(
˝u
, 
i
);

808 
	`ˇche_sh¨ed_˝u_m≠_£tup
(
˝u
, 
j
);

810 
	}
}

812 
__˝uöô
 
	$dëe˘_ˇche_©åibuãs
(
˝u
)

814 
ªtvÆ
;

816 i‡(
num_ˇche_Àaves
 == 0)

817  -
ENOENT
;

819 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
	`kzÆloc
(

820 (
_˝uid4_öfo
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

821 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

822  -
ENOMEM
;

824 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
gë_˝u_Àaves
, &
ªtvÆ
, 
åue
);

825 i‡(
ªtvÆ
) {

826 
	`k‰ì
(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
));

827 
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë
NULL
;

830  
ªtvÆ
;

831 
	}
}

833 
	~<löux/kobje˘.h
>

834 
	~<löux/sysfs.h
>

836 
sysdev_˛ass
 
˝u_sysdev_˛ass
;

839 
DEFINE_PER_CPU
(
kobje˘
 *, 
ici_ˇche_kobje˘
);

841 
	s_ödex_kobje˘
 {

842 
kobje˘
 
	mkobj
;

843 
	m˝u
;

844 
	mödex
;

848 
DEFINE_PER_CPU
(
_ödex_kobje˘
 *, 
ici_ödex_kobje˘
);

849 
	#INDEX_KOBJECT_PTR
(
x
, 
y
Ë(&((
	`≥r_˝u
(
ici_ödex_kobje˘
, x))[y]))

	)

851 
	#show_⁄e_∂us
(
fûe_«me
, 
obje˘
, 
vÆ
) \

852 
ssize_t
 
show_
##
fûe_«me
 \

853 (
_˝uid4_öfo
 *
this_Àaf
, *
buf
) \

855  
	`•rötf
(
buf
, "%lu\n", ()
this_Àaf
->
obje˘
 + 
vÆ
); \

856 }

	)

858 
show_⁄e_∂us
(
Àvñ
, 
óx
.
•lô
.level, 0);

859 
show_⁄e_∂us
(
cohîícy_löe_size
, 
ebx
.
•lô
.coherency_line_size, 1);

860 
show_⁄e_∂us
(
physiˇl_löe_∑πôi⁄
, 
ebx
.
•lô
.physical_line_partition, 1);

861 
show_⁄e_∂us
(
ways_of_assocütivôy
, 
ebx
.
•lô
.ways_of_associativity, 1);

862 
show_⁄e_∂us
(
numbî_of_£ts
, 
ecx
.
•lô
.number_of_sets, 1);

864 
ssize_t
 
	$show_size
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

866  
	`•rötf
(
buf
, "%luK\n", 
this_Àaf
->
size
 / 1024);

867 
	}
}

869 
ssize_t
 
	$show_sh¨ed_˝u_m≠_func
(
_˝uid4_öfo
 *
this_Àaf
,

870 
ty≥
, *
buf
)

872 
±rdiff_t
 
Àn
 = 
	`PTR_ALIGN
(
buf
 + 
PAGE_SIZE
 - 1, PAGE_SIZE) - buf;

873 
n
 = 0;

875 i‡(
Àn
 > 1) {

876 c⁄° 
˝umask
 *
mask
;

878 
mask
 = 
	`to_˝umask
(
this_Àaf
->
sh¨ed_˝u_m≠
);

879 
n
 = 
ty≥
 ?

880 
	`˝uli°_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
) :

881 
	`˝umask_s˙¥ötf
(
buf
, 
Àn
-2, 
mask
);

882 
buf
[
n
++] = '\n';

883 
buf
[
n
] = '\0';

885  
n
;

886 
	}
}

888 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_m≠
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

890  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 0, 
buf
);

891 
	}
}

893 
ölöe
 
ssize_t
 
	$show_sh¨ed_˝u_li°
(
_˝uid4_öfo
 *
Àaf
, *
buf
)

895  
	`show_sh¨ed_˝u_m≠_func
(
Àaf
, 1, 
buf
);

896 
	}
}

898 
ssize_t
 
	$show_ty≥
(
_˝uid4_öfo
 *
this_Àaf
, *
buf
)

900 
this_Àaf
->
óx
.
•lô
.
ty≥
) {

901 
CACHE_TYPE_DATA
:

902  
	`•rötf
(
buf
, "Data\n");

903 
CACHE_TYPE_INST
:

904  
	`•rötf
(
buf
, "Instruction\n");

905 
CACHE_TYPE_UNIFIED
:

906  
	`•rötf
(
buf
, "Unified\n");

908  
	`•rötf
(
buf
, "Unknown\n");

910 
	}
}

912 
	#to_obje˘
(
k
Ë
	`c⁄èöî_of
(k, 
_ödex_kobje˘
, 
kobj
)

	)

913 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
_ˇche_©å
, 
©å
)

	)

915 
	#deföe_⁄e_ro
(
_«me
) \

916 
_ˇche_©å
 
_«me
 = \

917 
	`__ATTR
(
_«me
, 0444, 
show_
##_«me, 
NULL
)

	)

919 
deföe_⁄e_ro
(
Àvñ
);

920 
deföe_⁄e_ro
(
ty≥
);

921 
deföe_⁄e_ro
(
cohîícy_löe_size
);

922 
deföe_⁄e_ro
(
physiˇl_löe_∑πôi⁄
);

923 
deföe_⁄e_ro
(
ways_of_assocütivôy
);

924 
deföe_⁄e_ro
(
numbî_of_£ts
);

925 
deföe_⁄e_ro
(
size
);

926 
deföe_⁄e_ro
(
sh¨ed_˝u_m≠
);

927 
deföe_⁄e_ro
(
sh¨ed_˝u_li°
);

929 
	#DEFAULT_SYSFS_CACHE_ATTRS
 \

930 &
ty≥
.
©å
, \

931 &
Àvñ
.
©å
, \

932 &
cohîícy_löe_size
.
©å
, \

933 &
physiˇl_löe_∑πôi⁄
.
©å
, \

934 &
ways_of_assocütivôy
.
©å
, \

935 &
numbî_of_£ts
.
©å
, \

936 &
size
.
©å
, \

937 &
sh¨ed_˝u_m≠
.
©å
, \

938 &
sh¨ed_˝u_li°
.
©å


	)

940 
©åibuã
 *
	gdeÁu…_©ås
[] = {

941 
DEFAULT_SYSFS_CACHE_ATTRS
,

942 
NULL


945 
©åibuã
 *
	gdeÁu…_l3_©ås
[] = {

946 
DEFAULT_SYSFS_CACHE_ATTRS
,

947 #ifde‡
CONFIG_CPU_SUP_AMD


948 &
ˇche_dißbÀ_0
.
©å
,

949 &
ˇche_dißbÀ_1
.
©å
,

951 
NULL


954 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

956 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

957 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

958 
ssize_t
 
ªt
;

960 
ªt
 = 
Áâr
->
show
 ?

961 
Áâr
->
	`show
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

962 
buf
) :

964  
ªt
;

965 
	}
}

967 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

968 c⁄° *
buf
, 
size_t
 
cou¡
)

970 
_ˇche_©å
 *
Áâr
 = 
	`to_©å
(
©å
);

971 
_ödex_kobje˘
 *
this_Àaf
 = 
	`to_obje˘
(
kobj
);

972 
ssize_t
 
ªt
;

974 
ªt
 = 
Áâr
->
°‹e
 ?

975 
Áâr
->
	`°‹e
(
	`CPUID4_INFO_IDX
(
this_Àaf
->
˝u
,Åhis_Àaf->
ödex
),

976 
buf
, 
cou¡
) :

978  
ªt
;

979 
	}
}

981 c⁄° 
sysfs_›s
 
	gsysfs_›s
 = {

982 .
show
 = show,

983 .
	g°‹e
 = 
°‹e
,

986 
kobj_ty≥
 
	gkty≥_ˇche
 = {

987 .
sysfs_›s
 = &sysfs_ops,

988 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

991 
kobj_ty≥
 
	gkty≥_≥r˝u_íåy
 = {

992 .
sysfs_›s
 = &sysfs_ops,

995 
__˝uöô
 
	$˝uid4_ˇche_sysfs_exô
(
˝u
)

997 
	`k‰ì
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

998 
	`k‰ì
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
));

999 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë
NULL
;

1000 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
NULL
;

1001 
	`‰ì_ˇche_©åibuãs
(
˝u
);

1002 
	}
}

1004 
__˝uöô
 
	$˝uid4_ˇche_sysfs_öô
(
˝u
)

1006 
îr
;

1008 i‡(
num_ˇche_Àaves
 == 0)

1009  -
ENOENT
;

1011 
îr
 = 
	`dëe˘_ˇche_©åibuãs
(
˝u
);

1012 i‡(
îr
)

1013  
îr
;

1016 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
) =

1017 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

1018 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
Ë=
NULL
))

1019 
îr_out
;

1021 
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë
	`kzÆloc
(

1022 (
_ödex_kobje˘
Ë* 
num_ˇche_Àaves
, 
GFP_KERNEL
);

1023 i‡(
	`u∆ikñy
(
	`≥r_˝u
(
ici_ödex_kobje˘
, 
˝u
Ë=
NULL
))

1024 
îr_out
;

1028 
îr_out
:

1029 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1030  -
ENOMEM
;

1031 
	}
}

1033 
DECLARE_BITMAP
(
ˇche_dev_m≠
, 
NR_CPUS
);

1036 
__˝uöô
 
	$ˇche_add_dev
(
sys_devi˚
 * 
sys_dev
)

1038 
˝u
 = 
sys_dev
->
id
;

1039 
i
, 
j
;

1040 
_ödex_kobje˘
 *
this_obje˘
;

1041 
_˝uid4_öfo
 *
this_Àaf
;

1042 
ªtvÆ
;

1044 
ªtvÆ
 = 
	`˝uid4_ˇche_sysfs_öô
(
˝u
);

1045 i‡(
	`u∆ikñy
(
ªtvÆ
 < 0))

1046  
ªtvÆ
;

1048 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

1049 &
kty≥_≥r˝u_íåy
,

1050 &
sys_dev
->
kobj
, "%s", "cache");

1051 i‡(
ªtvÆ
 < 0) {

1052 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1053  
ªtvÆ
;

1056 
i
 = 0; i < 
num_ˇche_Àaves
; i++) {

1057 
this_obje˘
 = 
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
);

1058 
this_obje˘
->
˝u
 = cpu;

1059 
this_obje˘
->
ödex
 = 
i
;

1061 
this_Àaf
 = 
	`CPUID4_INFO_IDX
(
˝u
, 
i
);

1063 i‡(
this_Àaf
->
l3
 &&Åhis_Àaf->l3->
ˇn_dißbÀ
)

1064 
kty≥_ˇche
.
deÁu…_©ås
 = 
deÁu…_l3_©ås
;

1066 
kty≥_ˇche
.
deÁu…_©ås
 = default_attrs;

1068 
ªtvÆ
 = 
	`kobje˘_öô_™d_add
(&(
this_obje˘
->
kobj
),

1069 &
kty≥_ˇche
,

1070 
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
),

1071 "ödex%1lu", 
i
);

1072 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

1073 
j
 = 0; j < 
i
; j++)

1074 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
j
)->
kobj
));

1075 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

1076 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1077  
ªtvÆ
;

1079 
	`kobje˘_uevít
(&(
this_obje˘
->
kobj
), 
KOBJ_ADD
);

1081 
	`˝umask_£t_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

1083 
	`kobje˘_uevít
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
), 
KOBJ_ADD
);

1085 
	}
}

1087 
__˝uöô
 
	$ˇche_ªmove_dev
(
sys_devi˚
 * 
sys_dev
)

1089 
˝u
 = 
sys_dev
->
id
;

1090 
i
;

1092 i‡(
	`≥r_˝u
(
ici_˝uid4_öfo
, 
˝u
Ë=
NULL
)

1094 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
)))

1096 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
ˇche_dev_m≠
));

1098 
i
 = 0; i < 
num_ˇche_Àaves
; i++)

1099 
	`kobje˘_put
(&(
	`INDEX_KOBJECT_PTR
(
˝u
, 
i
)->
kobj
));

1100 
	`kobje˘_put
(
	`≥r_˝u
(
ici_ˇche_kobje˘
, 
˝u
));

1101 
	`˝uid4_ˇche_sysfs_exô
(
˝u
);

1102 
	}
}

1104 
__˝uöô
 
	$ˇcheöfo_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

1105 
a˘i⁄
, *
h˝u
)

1107 
˝u
 = ()
h˝u
;

1108 
sys_devi˚
 *
sys_dev
;

1110 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

1111 
a˘i⁄
) {

1112 
CPU_ONLINE
:

1113 
CPU_ONLINE_FROZEN
:

1114 
	`ˇche_add_dev
(
sys_dev
);

1116 
CPU_DEAD
:

1117 
CPU_DEAD_FROZEN
:

1118 
	`ˇche_ªmove_dev
(
sys_dev
);

1121  
NOTIFY_OK
;

1122 
	}
}

1124 
nŸifõr_block
 
__˝uöôd©a
 
	gˇcheöfo_˝u_nŸifõr
 = {

1125 .
nŸifõr_ˇŒ
 = 
ˇcheöfo_˝u_ˇŒback
,

1128 
__˝uöô
 
	$ˇche_sysfs_öô
()

1130 
i
;

1132 i‡(
num_ˇche_Àaves
 == 0)

1135 
	`f‹_óch_⁄löe_˝u
(
i
) {

1136 
îr
;

1137 
sys_devi˚
 *
sys_dev
 = 
	`gë_˝u_sysdev
(
i
);

1139 
îr
 = 
	`ˇche_add_dev
(
sys_dev
);

1140 i‡(
îr
)

1141  
îr
;

1143 
	`ªgi°î_hŸ˝u_nŸifõr
(&
ˇcheöfo_˝u_nŸifõr
);

1145 
	}
}

1147 
devi˚_öôˇŒ
(
ˇche_sysfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/debugfs.h
>

16 
	~<asm/m˚.h
>

18 
	~"m˚-öã∫Æ.h
"

32 
	ec⁄ãxt
 { 
	mIN_KERNEL
 = 1, 
	mIN_USER
 = 2 };

33 
	e£r
 { 
	mSER_REQUIRED
 = 1, 
	mNO_SER
 = 2 };

35 
	s£vîôy
 {

36 
u64
 
	mmask
;

37 
u64
 
	mªsu…
;

38 
	m£v
;

39 
	mmcgmask
;

40 
	mmcgªs
;

41 
	m£r
;

42 
	mc⁄ãxt
;

43 
	mcovîed
;

44 *
	mmsg
;

45 } 
	g£vîôõs
[] = {

46 
	#KERNEL
 .
c⁄ãxt
 = 
IN_KERNEL


	)

47 
	#USER
 .
c⁄ãxt
 = 
IN_USER


	)

48 
	#SER
 .
£r
 = 
SER_REQUIRED


	)

49 
	#NOSER
 .
£r
 = 
NO_SER


	)

50 
	#SEV
(
s
Ë.
£v
 = 
MCE_
 ## s ## 
_SEVERITY


	)

51 
	#BITCLR
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = 0, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

52 
	#BITSET
(
x
, 
s
, 
m
, 
r
...Ë{ .
mask
 = x, .
ªsu…
 = x, 
	`SEV
(s), .
msg
 = m, ##Ñ }

	)

53 
	#MCGMASK
(
x
, 
ªs
, 
s
, 
m
, 
r
...) \

54 { .
mcgmask
 = 
x
, .
mcgªs
 = 
ªs
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

55 
	#MASK
(
x
, 
y
, 
s
, 
m
, 
r
...) \

56 { .
mask
 = 
x
, .
ªsu…
 = 
y
, 
	`SEV
(
s
), .
msg
 = 
m
, ## 
r
 }

	)

57 
	#MCI_UC_S
 (
MCI_STATUS_UC
|
MCI_STATUS_S
)

	)

58 
	#MCI_UC_SAR
 (
MCI_STATUS_UC
|
MCI_STATUS_S
|
MCI_STATUS_AR
)

	)

59 
	#MCACOD
 0xffff

	)

61 
BITCLR
(
MCI_STATUS_VAL
, 
NO
, "Invalid"),

62 
BITCLR
(
MCI_STATUS_EN
, 
NO
, "NotÉnabled"),

63 
BITSET
(
MCI_STATUS_PCC
, 
PANIC
, "Processor context corrupt"),

65 
MCGMASK
(
MCG_STATUS_MCIP
, 0, 
PANIC
, "MCIPÇot set in MCA handler"),

67 
MCGMASK
(
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
, 0, 
PANIC
,

69 
MCGMASK
(
MCG_STATUS_RIPV
, 0, 
PANIC
, "In kernelándÇoÑestart IP",

70 
KERNEL
),

71 
BITCLR
(
MCI_STATUS_UC
, 
KEEP
, "C‹ª˘edÉº‹", 
NOSER
),

72 
MASK
(
MCI_STATUS_OVER
|
MCI_STATUS_UC
|
MCI_STATUS_EN
, MCI_STATUS_UC, 
SOME
,

73 "Spuriou†nŸÉ«bÀd", 
SER
),

76 
MASK
(
MCI_UC_SAR
, 
MCI_STATUS_UC
, 
KEEP
,

77 "Unc‹ª˘edÇÿa˘i⁄Ñequúed", 
SER
),

78 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_STATUS_UC
|
MCI_STATUS_AR
, 
PANIC
,

79 "IŒegÆ combö©i⁄ (UCNA wôh AR=1)", 
SER
),

80 
MASK
(
MCI_STATUS_S
, 0, 
KEEP
, "N⁄ sig«Œed machöêcheck", 
SER
),

83 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, MCI_STATUS_OVER|MCI_UC_SAR, 
PANIC
,

84 "A˘i⁄Ñequúed wôhÜo°Évíts", 
SER
),

85 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
|
MCACOD
, MCI_UC_SAR, 
PANIC
,

86 "A˘i⁄Ñequúed; unknow¿MCACOD", 
SER
),

89 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|0xfff0, 
MCI_UC_S
|0xc0, 
AO
,

90 "A˘i⁄ o±i⁄Æ: mem‹y s¸ubbögÉº‹", 
SER
),

91 
MASK
(
MCI_UC_SAR
|
MCI_STATUS_OVER
|
MCACOD
, 
MCI_UC_S
|0x17a, 
AO
,

92 "A˘i⁄ o±i⁄Æ:Üa°Üevñ cachêwrôebackÉº‹", 
SER
),

94 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
, 
SOME
,

95 "A˘i⁄ o±i⁄Æ unknow¿MCACOD", 
SER
),

96 
MASK
(
MCI_STATUS_OVER
|
MCI_UC_SAR
, 
MCI_UC_S
|MCI_STATUS_OVER, 
SOME
,

97 "A˘i⁄ o±i⁄Æ wôhÜo°Évíts", 
SER
),

98 
BITSET
(
MCI_STATUS_UC
|
MCI_STATUS_OVER
, 
PANIC
, "Overflowed uncorrected"),

99 
BITSET
(
MCI_STATUS_UC
, 
UC
, "Uncorrected"),

100 
BITSET
(0, 
SOME
, "No match")

107 
	$îr‹_c⁄ãxt
(
m˚
 *
m
)

109 i‡(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
)

110  (
m
->
ù
 && (m->
cs
 & 3Ë=3Ë? 
IN_USER
 : 
IN_KERNEL
;

112  
IN_KERNEL
;

113 
	}
}

115 
	$m˚_£vîôy
(
m˚
 *
a
, 
tﬁî™t
, **
msg
)

117 
c⁄ãxt
 
˘x
 = 
	`îr‹_c⁄ãxt
(
a
);

118 
£vîôy
 *
s
;

120 
s
 = 
£vîôõs
;; s++) {

121 i‡((
a
->
°©us
 & 
s
->
mask
Ë!s->
ªsu…
)

123 i‡((
a
->
mcg°©us
 & 
s
->
mcgmask
Ë!s->
mcgªs
)

125 i‡(
s
->
£r
 =
SER_REQUIRED
 && !
m˚_£r
)

127 i‡(
s
->
£r
 =
NO_SER
 && 
m˚_£r
)

129 i‡(
s
->
c⁄ãxt
 && 
˘x
 != s->context)

131 i‡(
msg
)

132 *
msg
 = 
s
->msg;

133 
s
->
covîed
 = 1;

134 i‡(
s
->
£v
 >
MCE_UC_SEVERITY
 && 
˘x
 =
IN_KERNEL
) {

135 i‡(
∑nic_⁄_o›s
 || 
tﬁî™t
 < 1)

136  
MCE_PANIC_SEVERITY
;

138  
s
->
£v
;

140 
	}
}

142 #ifde‡
CONFIG_DEBUG_FS


143 *
	$s_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

145 i‡(*
pos
 >
	`ARRAY_SIZE
(
£vîôõs
))

146  
NULL
;

147  &
£vîôõs
[*
pos
];

148 
	}
}

150 *
	$s_√xt
(
£q_fûe
 *
f
, *
d©a
, 
loff_t
 *
pos
)

152 i‡(++(*
pos
Ë>
	`ARRAY_SIZE
(
£vîôõs
))

153  
NULL
;

154  &
£vîôõs
[*
pos
];

155 
	}
}

157 
	$s_°›
(
£q_fûe
 *
f
, *
d©a
)

159 
	}
}

161 
	$s_show
(
£q_fûe
 *
f
, *
d©a
)

163 
£vîôy
 *
£r
 = 
d©a
;

164 
	`£q_¥ötf
(
f
, "%d\t%s\n", 
£r
->
covîed
, sî->
msg
);

166 
	}
}

168 c⁄° 
£q_›î©i⁄s
 
	g£vîôõs_£q_›s
 = {

169 .
°¨t
 = 
s_°¨t
,

170 .
	g√xt
 = 
s_√xt
,

171 .
	g°›
 = 
s_°›
,

172 .
	gshow
 = 
s_show
,

175 
	$£vîôõs_covîage_›í
(
öode
 *öode, 
fûe
 *file)

177  
	`£q_›í
(
fûe
, &
£vîôõs_£q_›s
);

178 
	}
}

180 
ssize_t
 
	$£vîôõs_covîage_wrôe
(
fûe
 *file,

181 c⁄° 
__u£r
 *
ubuf
,

182 
size_t
 
cou¡
, 
loff_t
 *
µos
)

184 
i
;

185 
i
 = 0; i < 
	`ARRAY_SIZE
(
£vîôõs
); i++)

186 
£vîôõs
[
i
].
covîed
 = 0;

187  
cou¡
;

188 
	}
}

190 c⁄° 
fûe_›î©i⁄s
 
	g£vîôõs_covîage_f›s
 = {

191 .
›í
 = 
£vîôõs_covîage_›í
,

192 .
	gªÀa£
 = 
£q_ªÀa£
,

193 .
	gªad
 = 
£q_ªad
,

194 .
	gwrôe
 = 
£vîôõs_covîage_wrôe
,

197 
__öô
 
	$£vîôõs_debugfs_öô
()

199 
díåy
 *
dm˚
 = 
NULL
, *
f£vîôõs_covîage
 = NULL;

201 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

202 i‡(
dm˚
 =
NULL
)

203 
îr_out
;

204 
f£vîôõs_covîage
 = 
	`debugfs_¸óã_fûe
("severities-coverage",

205 0444, 
dm˚
, 
NULL
,

206 &
£vîôõs_covîage_f›s
);

207 i‡(
f£vîôõs_covîage
 =
NULL
)

208 
îr_out
;

212 
îr_out
:

213  -
ENOMEM
;

214 
	}
}

215 
œã_öôˇŒ
(
£vîôõs_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c

10 
	~<löux/thªad_öfo.h
>

11 
	~<löux/ˇ∑bûôy.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/kÆlsyms.h
>

16 
	~<löux/rcupd©e.h
>

17 
	~<löux/kobje˘.h
>

18 
	~<löux/uac˚ss.h
>

19 
	~<löux/kdebug.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≥r˝u.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/sysdev.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/˘y≥.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/sysfs.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/¶ab.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/kmod.h
>

32 
	~<löux/pﬁl.h
>

33 
	~<löux/nmi.h
>

34 
	~<löux/˝u.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/fs.h
>

37 
	~<löux/mm.h
>

38 
	~<löux/debugfs.h
>

39 
	~<löux/edac_m˚.h
>

41 
	~<asm/¥o˚ss‹.h
>

42 
	~<asm/hw_úq.h
>

43 
	~<asm/≠ic.h
>

44 
	~<asm/idÀ.h
>

45 
	~<asm/ùi.h
>

46 
	~<asm/m˚.h
>

47 
	~<asm/m§.h
>

49 
	~"m˚-öã∫Æ.h
"

51 
DEFINE_MUTEX
(
m˚_ªad_muãx
);

53 
	#rcu_dîe„ªn˚_check_m˚
(
p
) \

54 
	`rcu_dîe„ªn˚_check
((
p
), \

55 
	`rcu_ªad_lock_sched_hñd
() || \

56 
	`lockdï_is_hñd
(&
m˚_ªad_muãx
))

	)

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<åa˚/evíts/m˚.h
>

61 
m˚_dißbÀd
 
	g__ªad_mo°ly
;

63 
	#MISC_MCELOG_MINOR
 227

	)

65 
	#SPINUNIT
 100

	)

67 
©omic_t
 
	gm˚_íåy
;

69 
DEFINE_PER_CPU
(, 
m˚_ex˚±i⁄_cou¡
);

78 
tﬁî™t
 
	g__ªad_mo°ly
 = 1;

79 
b™ks
 
	g__ªad_mo°ly
;

80 
rù_m§
 
	g__ªad_mo°ly
;

81 
m˚_boŸlog
 
	g__ªad_mo°ly
 = -1;

82 
m⁄¨ch_timeout
 
	g__ªad_mo°ly
 = -1;

83 
m˚_∑nic_timeout
 
	g__ªad_mo°ly
;

84 
m˚_d⁄t_log_˚
 
	g__ªad_mo°ly
;

85 
m˚_cmci_dißbÀd
 
	g__ªad_mo°ly
;

86 
m˚_ign‹e_˚
 
	g__ªad_mo°ly
;

87 
m˚_£r
 
	g__ªad_mo°ly
;

89 
m˚_b™k
 *
m˚_b™ks
 
	g__ªad_mo°ly
;

92 
	gm˚_√ed_nŸify
;

93 
	gm˚_hñ≥r
[128];

94 *
	gm˚_hñ≥r_¨gv
[2] = { 
m˚_hñ≥r
, 
NULL
 };

96 
DECLARE_WAIT_QUEUE_HEAD
(
m˚_waô
);

97 
DEFINE_PER_CPU
(
m˚
, 
m˚s_£í
);

98 
	g˝u_missög
;

104 
ATOMIC_NOTIFIER_HEAD
(
x86_m˚_decodî_chaö
);

105 
EXPORT_SYMBOL_GPL
(
x86_m˚_decodî_chaö
);

107 
	$deÁu…_decode_m˚
(
nŸifõr_block
 *
nb
, 
vÆ
,

108 *
d©a
)

110 
	`¥_emîg
("No humanÑeadable MCE decoding support onÅhis CPUÅype.\n");

111 
	`¥_emîg
("RunÅhe messageÅhrough 'mcelog --ascii'Åo decode.\n");

113  
NOTIFY_STOP
;

114 
	}
}

116 
nŸifõr_block
 
	gm˚_dec_nb
 = {

117 .
nŸifõr_ˇŒ
 = 
deÁu…_decode_m˚
,

118 .
	g¥i‹ôy
 = -1,

122 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_pﬁl_b™ks
) = {

123 [0 ... 
BITS_TO_LONGS
(
MAX_NR_BANKS
)-1] = ~0UL

126 
DEFINE_PER_CPU
(
w‹k_°ru˘
, 
m˚_w‹k
);

129 
	$m˚_£tup
(
m˚
 *
m
)

131 
	`mem£t
(
m
, 0, (
m˚
));

132 
m
->
˝u
 = m->
ext˝u
 = 
	`smp_¥o˚ss‹_id
();

133 
	`rdts˛l
(
m
->
tsc
);

135 
m
->
time
 = 
	`gë_£c⁄ds
();

136 
m
->
˝uvíd‹
 = 
boŸ_˝u_d©a
.
x86_víd‹
;

137 
m
->
˝uid
 = 
	`˝uid_óx
(1);

138 #ifde‡
CONFIG_SMP


139 
m
->
sockëid
 = 
	`˝u_d©a
(m->
ext˝u
).
phys_¥oc_id
;

141 
m
->
≠icid
 = 
	`˝u_d©a
(m->
ext˝u
).
öôül_≠icid
;

142 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
m
->
mcgˇp
);

143 
	}
}

145 
DEFINE_PER_CPU
(
m˚
, 
öje˘m
);

146 
EXPORT_PER_CPU_SYMBOL_GPL
(
öje˘m
);

154 
m˚_log
 
	gm˚log
 = {

155 .
sig«tuª
 = 
MCE_LOG_SIGNATURE
,

156 .
	gÀn
 = 
MCE_LOG_LEN
,

157 .
	gªc‹dÀn
 = (
m˚
),

160 
	$m˚_log
(
m˚
 *mce)

162 
√xt
, 
íåy
;

165 
	`åa˚_m˚_ªc‹d
(
m˚
);

167 
m˚
->
föished
 = 0;

168 
	`wmb
();

170 
íåy
 = 
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.
√xt
);

178 i‡(
	`edac_m˚_∑r£
(
m˚
))

186 i‡(
íåy
 >
MCE_LOG_LEN
) {

187 
	`£t_bô
(
MCE_OVERFLOW
,

188 (*)&
m˚log
.
Êags
);

192 i‡(
m˚log
.
íåy
[íåy].
föished
) {

193 
íåy
++;

198 
	`smp_rmb
();

199 
√xt
 = 
íåy
 + 1;

200 i‡(
	`cmpxchg
(&
m˚log
.
√xt
, 
íåy
,Çext) ==Éntry)

203 
	`mem˝y
(
m˚log
.
íåy
 +É¡ry, 
m˚
, (mce));

204 
	`wmb
();

205 
m˚log
.
íåy
[íåy].
föished
 = 1;

206 
	`wmb
();

208 
m˚
->
föished
 = 1;

209 
	`£t_bô
(0, &
m˚_√ed_nŸify
);

210 
	}
}

212 
	$¥öt_m˚
(
m˚
 *
m
)

214 
	`¥_emîg
("CPU %d: Machine Check Exception: %16Lx Bank %d: %016Lx\n",

215 
m
->
ext˝u
, m->
mcg°©us
, m->
b™k
, m->
°©us
);

217 i‡(
m
->
ù
) {

218 
	`¥_emîg
("RIP%s %02x:<%016Lx> ",

219 !(
m
->
mcg°©us
 & 
MCG_STATUS_EIPV
) ? " !INEXACT!" : "",

220 
m
->
cs
, m->
ù
);

222 i‡(
m
->
cs
 =
__KERNEL_CS
)

223 
	`¥öt_symbﬁ
("{%s}", 
m
->
ù
);

224 
	`¥_c⁄t
("\n");

227 
	`¥_emîg
("TSC %Œx ", 
m
->
tsc
);

228 i‡(
m
->
addr
)

229 
	`¥_c⁄t
("ADDR %Œx ", 
m
->
addr
);

230 i‡(
m
->
misc
)

231 
	`¥_c⁄t
("MISC %Œx ", 
m
->
misc
);

233 
	`¥_c⁄t
("\n");

234 
	`¥_emîg
("PROCESSOR %u:%x TIME %llu SOCKET %u APIC %x\n",

235 
m
->
˝uvíd‹
, m->
˝uid
, m->
time
, m->
sockëid
, m->
≠icid
);

241 
	`©omic_nŸifõr_ˇŒ_chaö
(&
x86_m˚_decodî_chaö
, 0, 
m
);

242 
	}
}

244 
	$¥öt_m˚_hód
()

246 
	`¥_emîg
("\nHARDWARE ERROR\n");

247 
	}
}

249 
	$¥öt_m˚_èû
()

251 
	`¥_emîg
("This isÇotá softwareÖroblem!\n");

252 
	}
}

254 
	#PANIC_TIMEOUT
 5

	)

256 
©omic_t
 
	gm˚_∑ni˚d
;

258 
	gÁke_∑nic
;

259 
©omic_t
 
	gm˚_Áke_∑ni˚d
;

262 
	$waô_f‹_∑nic
()

264 
timeout
 = 
PANIC_TIMEOUT
*
USEC_PER_SEC
;

266 
	`¥ìm±_dißbÀ
();

267 
	`loˇl_úq_íabÀ
();

268 
timeout
-- > 0)

269 
	`udñay
(1);

270 i‡(
∑nic_timeout
 == 0)

271 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

272 
	`∑nic
("Panicing machine check CPU died");

273 
	}
}

275 
	$m˚_∑nic
(*
msg
, 
m˚
 *
föÆ
, *
exp
)

277 
i
, 
≠ei_îr
 = 0;

279 i‡(!
Áke_∑nic
) {

283 i‡(
	`©omic_öc_ªtu∫
(&
m˚_∑ni˚d
) > 1)

284 
	`waô_f‹_∑nic
();

285 
	`b¨rõr
();

287 
	`bu°_•ölocks
(1);

288 
	`c⁄sﬁe_vîbo£
();

291 i‡(
	`©omic_öc_ªtu∫
(&
m˚_Áke_∑ni˚d
) > 1)

294 
	`¥öt_m˚_hód
();

296 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

297 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

298 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

300 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
)) {

301 
	`¥öt_m˚
(
m
);

302 i‡(!
≠ei_îr
)

303 
≠ei_îr
 = 
	`≠ei_wrôe_m˚
(
m
);

307 
i
 = 0; i < 
MCE_LOG_LEN
; i++) {

308 
m˚
 *
m
 = &
m˚log
.
íåy
[
i
];

309 i‡(!(
m
->
°©us
 & 
MCI_STATUS_VAL
))

311 i‡(!(
m
->
°©us
 & 
MCI_STATUS_UC
))

313 i‡(!
föÆ
 || 
	`memcmp
(
m
, föÆ, (
m˚
))) {

314 
	`¥öt_m˚
(
m
);

315 i‡(!
≠ei_îr
)

316 
≠ei_îr
 = 
	`≠ei_wrôe_m˚
(
m
);

319 i‡(
föÆ
) {

320 
	`¥öt_m˚
(
föÆ
);

321 i‡(!
≠ei_îr
)

322 
≠ei_îr
 = 
	`≠ei_wrôe_m˚
(
föÆ
);

324 i‡(
˝u_missög
)

325 
	`¥ötk
(
KERN_EMERG
 "Some CPUs didn'tánswer in synchronization\n");

326 
	`¥öt_m˚_èû
();

327 i‡(
exp
)

328 
	`¥ötk
(
KERN_EMERG
 "Machöêcheck: %s\n", 
exp
);

329 i‡(!
Áke_∑nic
) {

330 i‡(
∑nic_timeout
 == 0)

331 
∑nic_timeout
 = 
m˚_∑nic_timeout
;

332 
	`∑nic
(
msg
);

334 
	`¥ötk
(
KERN_EMERG
 "Fakêkî√»∑nic: %s\n", 
msg
);

335 
	}
}

339 
	$m§_to_off£t
(
u32
 
m§
)

341 
b™k
 = 
	`__gë_˝u_v¨
(
öje˘m
.bank);

343 i‡(
m§
 =
rù_m§
)

344  
	`off£tof
(
m˚
, 
ù
);

345 i‡(
m§
 =
	`MSR_IA32_MCx_STATUS
(
b™k
))

346  
	`off£tof
(
m˚
, 
°©us
);

347 i‡(
m§
 =
	`MSR_IA32_MCx_ADDR
(
b™k
))

348  
	`off£tof
(
m˚
, 
addr
);

349 i‡(
m§
 =
	`MSR_IA32_MCx_MISC
(
b™k
))

350  
	`off£tof
(
m˚
, 
misc
);

351 i‡(
m§
 =
MSR_IA32_MCG_STATUS
)

352  
	`off£tof
(
m˚
, 
mcg°©us
);

354 
	}
}

357 
u64
 
	$m˚_rdm§l
(
u32
 
m§
)

359 
u64
 
v
;

361 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

362 
off£t
 = 
	`m§_to_off£t
(
m§
);

364 i‡(
off£t
 < 0)

366  *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
);

369 i‡(
	`rdm§l_ß„
(
m§
, &
v
)) {

370 
	`WARN_ONCE
(1, "m˚: U«bÀÅÿªad m§ %d!\n", 
m§
);

376 
v
 = 0;

379  
v
;

380 
	}
}

382 
	$m˚_wrm§l
(
u32
 
m§
, 
u64
 
v
)

384 i‡(
	`__gë_˝u_v¨
(
öje˘m
).
föished
) {

385 
off£t
 = 
	`m§_to_off£t
(
m§
);

387 i‡(
off£t
 >= 0)

388 *(
u64
 *)((*)&
	`__gë_˝u_v¨
(
öje˘m
Ë+ 
off£t
Ë
v
;

391 
	`wrm§l
(
m§
, 
v
);

392 
	}
}

399 
	#MCE_RING_SIZE
 16

	)

401 
	sm˚_rög
 {

402 
	m°¨t
;

403 
	míd
;

404 
	mrög
[
MCE_RING_SIZE
];

406 
DEFINE_PER_CPU
(
m˚_rög
, mce_ring);

409 
	$m˚_rög_em±y
()

411 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

413  
r
->
°¨t
 =r->
íd
;

414 
	}
}

416 
	$m˚_rög_gë
(*
p‚
)

418 
m˚_rög
 *
r
;

419 
ªt
 = 0;

421 *
p‚
 = 0;

422 
	`gë_˝u
();

423 
r
 = &
	`__gë_˝u_v¨
(
m˚_rög
);

424 i‡(
r
->
°¨t
 =r->
íd
)

425 
out
;

426 *
p‚
 = 
r
->
rög
[r->
°¨t
];

427 
r
->
°¨t
 = (r->°¨à+ 1Ë% 
MCE_RING_SIZE
;

428 
ªt
 = 1;

429 
out
:

430 
	`put_˝u
();

431  
ªt
;

432 
	}
}

435 
	$m˚_rög_add
(
p‚
)

437 
m˚_rög
 *
r
 = &
	`__gë_˝u_v¨
(mce_ring);

438 
√xt
;

440 
√xt
 = (
r
->
íd
 + 1Ë% 
MCE_RING_SIZE
;

441 i‡(
√xt
 =
r
->
°¨t
)

443 
r
->
rög
[r->
íd
] = 
p‚
;

444 
	`wmb
();

445 
r
->
íd
 = 
√xt
;

447 
	}
}

449 
	$m˚_avaûabÀ
(
˝uöfo_x86
 *
c
)

451 i‡(
m˚_dißbÀd
)

453  
	`˝u_has
(
c
, 
X86_FEATURE_MCE
Ë&& cpu_has(c, 
X86_FEATURE_MCA
);

454 
	}
}

456 
	$m˚_scheduÀ_w‹k
()

458 i‡(!
	`m˚_rög_em±y
()) {

459 
w‹k_°ru˘
 *
w‹k
 = &
	`__gë_˝u_v¨
(
m˚_w‹k
);

460 i‡(!
	`w‹k_≥ndög
(
w‹k
))

461 
	`scheduÀ_w‹k
(
w‹k
);

463 
	}
}

469 
ölöe
 
	$m˚_gë_rù
(
m˚
 *
m
, 
±_ªgs
 *
ªgs
)

472 i‡(
ªgs
 && (
m
->
mcg°©us
 & (
MCG_STATUS_RIPV
|
MCG_STATUS_EIPV
))) {

473 
m
->
ù
 = 
ªgs
->ip;

474 
m
->
cs
 = 
ªgs
->cs;

476 
m
->
ù
 = 0;

477 
m
->
cs
 = 0;

479 i‡(
rù_m§
)

480 
m
->
ù
 = 
	`m˚_rdm§l
(
rù_m§
);

481 
	}
}

483 #ifde‡
CONFIG_X86_LOCAL_APIC


489 
asmlökage
 
	$smp_m˚_£lf_öãºu±
(
±_ªgs
 *
ªgs
)

491 
	`ack_APIC_úq
();

492 
	`exô_idÀ
();

493 
	`úq_íãr
();

494 
	`m˚_nŸify_úq
();

495 
	`m˚_scheduÀ_w‹k
();

496 
	`úq_exô
();

497 
	}
}

500 
	$m˚_ªp‹t_evít
(
±_ªgs
 *
ªgs
)

502 i‡(
ªgs
->
Êags
 & (
X86_VM_MASK
|
X86_EFLAGS_IF
)) {

503 
	`m˚_nŸify_úq
();

510 
	`m˚_scheduÀ_w‹k
();

514 #ifde‡
CONFIG_X86_LOCAL_APIC


519 i‡(!
˝u_has_≠ic
)

528 
≠ic
->
	`£nd_IPI_£lf
(
MCE_SELF_VECTOR
);

535 
	`≠ic_waô_i¸_idÀ
();

537 
	}
}

539 
DEFINE_PER_CPU
(, 
m˚_pﬁl_cou¡
);

556 
	$machöe_check_pﬁl
(
m˝_Êags
 
Êags
, 
m˚_b™ks_t
 *
b
)

558 
m˚
 
m
;

559 
i
;

561 
	`≥r˝u_öc
(
m˚_pﬁl_cou¡
);

563 
	`m˚_£tup
(&
m
);

565 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

566 
i
 = 0; i < 
b™ks
; i++) {

567 i‡(!
m˚_b™ks
[
i
].
˘l
 || !
	`ã°_bô
(i, *
b
))

570 
m
.
misc
 = 0;

571 
m
.
addr
 = 0;

572 
m
.
b™k
 = 
i
;

573 
m
.
tsc
 = 0;

575 
	`b¨rõr
();

576 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

577 i‡(!(
m
.
°©us
 & 
MCI_STATUS_VAL
))

586 i‡(!(
Êags
 & 
MCP_UC
) &&

587 (
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)))

590 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

591 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

592 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

593 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

595 i‡(!(
Êags
 & 
MCP_TIMESTAMP
))

596 
m
.
tsc
 = 0;

601 i‡(!(
Êags
 & 
MCP_DONTLOG
Ë&& !
m˚_d⁄t_log_˚
) {

602 
	`m˚_log
(&
m
);

603 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

609 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

617 
	`sync_c‹e
();

618 
	}
}

619 
EXPORT_SYMBOL_GPL
(
machöe_check_pﬁl
);

625 
	$m˚_no_way_out
(
m˚
 *
m
, **
msg
)

627 
i
;

629 
i
 = 0; i < 
b™ks
; i++) {

630 
m
->
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

631 i‡(
	`m˚_£vîôy
(
m
, 
tﬁî™t
, 
msg
Ë>
MCE_PANIC_SEVERITY
)

635 
	}
}

641 
©omic_t
 
	gm˚_executög
;

646 
©omic_t
 
	gm˚_ˇŒö
;

651 
	$m˚_timed_out
(
u64
 *
t
)

659 
	`rmb
();

660 i‡(
	`©omic_ªad
(&
m˚_∑ni˚d
))

661 
	`waô_f‹_∑nic
();

662 i‡(!
m⁄¨ch_timeout
)

663 
out
;

664 i‡((
s64
)*
t
 < 
SPINUNIT
) {

666 i‡(
tﬁî™t
 < 1)

667 
	`m˚_∑nic
("Timeout synchronizing machine check over CPUs",

668 
NULL
, NULL);

669 
˝u_missög
 = 1;

672 *
t
 -
SPINUNIT
;

673 
out
:

674 
	`touch_nmi_w©chdog
();

676 
	}
}

702 
	$m˚_ªign
()

704 
˝u
;

705 
m˚
 *
m
 = 
NULL
;

706 
globÆ_w‹°
 = 0;

707 *
msg
 = 
NULL
;

708 *
nmsg
 = 
NULL
;

715 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

716 
£vîôy
 = 
	`m˚_£vîôy
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 
tﬁî™t
,

717 &
nmsg
);

718 i‡(
£vîôy
 > 
globÆ_w‹°
) {

719 
msg
 = 
nmsg
;

720 
globÆ_w‹°
 = 
£vîôy
;

721 
m
 = &
	`≥r_˝u
(
m˚s_£í
, 
˝u
);

730 i‡(
m
 && 
globÆ_w‹°
 >
MCE_PANIC_SEVERITY
 && 
tﬁî™t
 < 3)

731 
	`m˚_∑nic
("F©Æ Machöêcheck", 
m
, 
msg
);

743 i‡(
globÆ_w‹°
 <
MCE_KEEP_SEVERITY
 && 
tﬁî™t
 < 3)

744 
	`m˚_∑nic
("Machöêcheck from unknow¿sour˚", 
NULL
, NULL);

750 
	`f‹_óch_possibÀ_˝u
(
˝u
)

751 
	`mem£t
(&
	`≥r_˝u
(
m˚s_£í
, 
˝u
), 0, (
m˚
));

752 
	}
}

754 
©omic_t
 
	gglobÆ_nwo
;

763 
	$m˚_°¨t
(*
no_way_out
)

765 
‹dî
;

766 
˝us
 = 
	`num_⁄löe_˝us
();

767 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

769 i‡(!
timeout
)

772 
	`©omic_add
(*
no_way_out
, &
globÆ_nwo
);

776 
	`smp_wmb
();

777 
‹dî
 = 
	`©omic_öc_ªtu∫
(&
m˚_ˇŒö
);

782 
	`©omic_ªad
(&
m˚_ˇŒö
Ë!
˝us
) {

783 i‡(
	`m˚_timed_out
(&
timeout
)) {

784 
	`©omic_£t
(&
globÆ_nwo
, 0);

787 
	`ndñay
(
SPINUNIT
);

793 
	`smp_rmb
();

795 i‡(
‹dî
 == 1) {

799 
	`©omic_£t
(&
m˚_executög
, 1);

807 
	`©omic_ªad
(&
m˚_executög
Ë< 
‹dî
) {

808 i‡(
	`m˚_timed_out
(&
timeout
)) {

809 
	`©omic_£t
(&
globÆ_nwo
, 0);

812 
	`ndñay
(
SPINUNIT
);

819 *
no_way_out
 = 
	`©omic_ªad
(&
globÆ_nwo
);

821  
‹dî
;

822 
	}
}

828 
	$m˚_íd
(
‹dî
)

830 
ªt
 = -1;

831 
u64
 
timeout
 = (u64)
m⁄¨ch_timeout
 * 
NSEC_PER_USEC
;

833 i‡(!
timeout
)

834 
ª£t
;

835 i‡(
‹dî
 < 0)

836 
ª£t
;

841 
	`©omic_öc
(&
m˚_executög
);

843 i‡(
‹dî
 == 1) {

845 
˝us
 = 
	`num_⁄löe_˝us
();

851 
	`©omic_ªad
(&
m˚_executög
Ë<
˝us
) {

852 i‡(
	`m˚_timed_out
(&
timeout
))

853 
ª£t
;

854 
	`ndñay
(
SPINUNIT
);

857 
	`m˚_ªign
();

858 
	`b¨rõr
();

859 
ªt
 = 0;

864 
	`©omic_ªad
(&
m˚_executög
) != 0) {

865 i‡(
	`m˚_timed_out
(&
timeout
))

866 
ª£t
;

867 
	`ndñay
(
SPINUNIT
);

879 
ª£t
:

880 
	`©omic_£t
(&
globÆ_nwo
, 0);

881 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

882 
	`b¨rõr
();

887 
	`©omic_£t
(&
m˚_executög
, 0);

888  
ªt
;

889 
	}
}

897 
	$m˚_ußbÀ_addªss
(
m˚
 *
m
)

899 i‡(!(
m
->
°©us
 & 
MCI_STATUS_MISCV
Ë|| !(m->°©u†& 
MCI_STATUS_ADDRV
))

901 i‡((
m
->
misc
 & 0x3fË> 
PAGE_SHIFT
)

903 i‡(((
m
->
misc
 >> 6Ë& 7Ë!
MCM_ADDR_PHYS
)

906 
	}
}

908 
	$m˚_˛ór_°©e
(*
to˛ór
)

910 
i
;

912 
i
 = 0; i < 
b™ks
; i++) {

913 i‡(
	`ã°_bô
(
i
, 
to˛ór
))

914 
	`m˚_wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

916 
	}
}

930 
	$do_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

932 
m˚
 
m
, *
föÆ
;

933 
i
;

934 
w‹°
 = 0;

935 
£vîôy
;

940 
‹dî
;

945 
no_way_out
 = 0;

950 
kûl_ô
 = 0;

951 
	`DECLARE_BITMAP
(
to˛ór
, 
MAX_NR_BANKS
);

952 *
msg
 = "Unknown";

954 
	`©omic_öc
(&
m˚_íåy
);

956 
	`≥r˝u_öc
(
m˚_ex˚±i⁄_cou¡
);

958 i‡(
	`nŸify_dõ
(
DIE_NMI
, "machöêcheck", 
ªgs
, 
îr‹_code
,

959 18, 
SIGKILL
Ë=
NOTIFY_STOP
)

960 
out
;

961 i‡(!
b™ks
)

962 
out
;

964 
	`m˚_£tup
(&
m
);

966 
m
.
mcg°©us
 = 
	`m˚_rdm§l
(
MSR_IA32_MCG_STATUS
);

967 
föÆ
 = &
	`__gë_˝u_v¨
(
m˚s_£í
);

968 *
föÆ
 = 
m
;

970 
no_way_out
 = 
	`m˚_no_way_out
(&
m
, &
msg
);

972 
	`b¨rõr
();

977 i‡(!(
m
.
mcg°©us
 & 
MCG_STATUS_RIPV
))

978 
kûl_ô
 = 1;

985 
‹dî
 = 
	`m˚_°¨t
(&
no_way_out
);

986 
i
 = 0; i < 
b™ks
; i++) {

987 
	`__˛ór_bô
(
i
, 
to˛ór
);

988 i‡(!
m˚_b™ks
[
i
].
˘l
)

991 
m
.
misc
 = 0;

992 
m
.
addr
 = 0;

993 
m
.
b™k
 = 
i
;

995 
m
.
°©us
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_STATUS
(
i
));

996 i‡((
m
.
°©us
 & 
MCI_STATUS_VAL
) == 0)

1003 i‡(!(
m
.
°©us
 & (
m˚_£r
 ? 
MCI_STATUS_S
 : 
MCI_STATUS_UC
)) &&

1004 !
no_way_out
)

1010 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

1012 
£vîôy
 = 
	`m˚_£vîôy
(&
m
, 
tﬁî™t
, 
NULL
);

1018 i‡(
£vîôy
 =
MCE_KEEP_SEVERITY
 && !
no_way_out
)

1020 
	`__£t_bô
(
i
, 
to˛ór
);

1021 i‡(
£vîôy
 =
MCE_NO_SEVERITY
) {

1032 i‡(
£vîôy
 =
MCE_AR_SEVERITY
)

1033 
kûl_ô
 = 1;

1035 i‡(
m
.
°©us
 & 
MCI_STATUS_MISCV
)

1036 
m
.
misc
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_MISC
(
i
));

1037 i‡(
m
.
°©us
 & 
MCI_STATUS_ADDRV
)

1038 
m
.
addr
 = 
	`m˚_rdm§l
(
	`MSR_IA32_MCx_ADDR
(
i
));

1047 i‡(
£vîôy
 =
MCE_AO_SEVERITY
 && 
	`m˚_ußbÀ_addªss
(&
m
))

1048 
	`m˚_rög_add
(
m
.
addr
 >> 
PAGE_SHIFT
);

1050 
	`m˚_gë_rù
(&
m
, 
ªgs
);

1051 
	`m˚_log
(&
m
);

1053 i‡(
£vîôy
 > 
w‹°
) {

1054 *
föÆ
 = 
m
;

1055 
w‹°
 = 
£vîôy
;

1059 i‡(!
no_way_out
)

1060 
	`m˚_˛ór_°©e
(
to˛ór
);

1066 i‡(
	`m˚_íd
(
‹dî
) < 0)

1067 
no_way_out
 = 
w‹°
 >
MCE_PANIC_SEVERITY
;

1076 i‡(
no_way_out
 && 
tﬁî™t
 < 3)

1077 
	`m˚_∑nic
("F©Æ machöêcheck o¿cuºíàCPU", 
föÆ
, 
msg
);

1086 i‡(
kûl_ô
 && 
tﬁî™t
 < 3)

1087 
	`f‹˚_sig
(
SIGBUS
, 
cuºít
);

1090 
	`£t_thªad_Êag
(
TIF_MCE_NOTIFY
);

1092 i‡(
w‹°
 > 0)

1093 
	`m˚_ªp‹t_evít
(
ªgs
);

1094 
	`m˚_wrm§l
(
MSR_IA32_MCG_STATUS
, 0);

1095 
out
:

1096 
	`©omic_dec
(&
m˚_íåy
);

1097 
	`sync_c‹e
();

1098 
	}
}

1099 
EXPORT_SYMBOL_GPL
(
do_machöe_check
);

1102 
__©åibuã__
((
wók
)Ë
	$mem‹y_Áûuª
(
p‚
, 
ve˘‹
)

1104 
	`¥ötk
(
KERN_ERR
 "A˘i⁄ o±i⁄Æ mem‹y faûuªáà%lx ign‹ed\n", 
p‚
);

1105 
	}
}

1118 
	$m˚_nŸify_¥o˚ss
()

1120 
p‚
;

1121 
	`m˚_nŸify_úq
();

1122 
	`m˚_rög_gë
(&
p‚
))

1123 
	`mem‹y_Áûuª
(
p‚
, 
MCE_VECTOR
);

1124 
	}
}

1126 
	$m˚_¥o˚ss_w‹k
(
w‹k_°ru˘
 *
dummy
)

1128 
	`m˚_nŸify_¥o˚ss
();

1129 
	}
}

1131 #ifde‡
CONFIG_X86_MCE_INTEL


1145 
	$m˚_log_thîm_thrŸ_evít
(
__u64
 
°©us
)

1147 
m˚
 
m
;

1149 
	`m˚_£tup
(&
m
);

1150 
m
.
b™k
 = 
MCE_THERMAL_BANK
;

1151 
m
.
°©us
 = status;

1152 
	`m˚_log
(&
m
);

1153 
	}
}

1161 
	gcheck_öãrvÆ
 = 5 * 60;

1163 
DEFINE_PER_CPU
(, 
m˚_√xt_öãrvÆ
);

1164 
DEFINE_PER_CPU
(
timî_li°
, 
m˚_timî
);

1166 
	$m˚_°¨t_timî
(
d©a
)

1168 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
d©a
);

1169 *
n
;

1171 
	`WARN_ON
(
	`smp_¥o˚ss‹_id
(Ë!
d©a
);

1173 i‡(
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
)) {

1174 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

1175 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

1182 
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1183 i‡(
	`m˚_nŸify_úq
())

1184 *
n
 = 
	`max
(*n/2, 
HZ
/100);

1186 *
n
 = 
	`mö
(*n*2, ()
	`round_jiffõs_ªœtive
(
check_öãrvÆ
*
HZ
));

1188 
t
->
expúes
 = 
jiffõs
 + *
n
;

1189 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1190 
	}
}

1192 
	$m˚_do_åiggî
(
w‹k_°ru˘
 *
w‹k
)

1194 
	`ˇŒ_u£rmodehñ≥r
(
m˚_hñ≥r
, 
m˚_hñ≥r_¨gv
, 
NULL
, 
UMH_NO_WAIT
);

1195 
	}
}

1197 
DECLARE_WORK
(
m˚_åiggî_w‹k
, 
m˚_do_åiggî
);

1204 
	$m˚_nŸify_úq
()

1207 
	`DEFINE_RATELIMIT_STATE
(
øãlimô
, 60*
HZ
, 2);

1209 
	`˛ór_thªad_Êag
(
TIF_MCE_NOTIFY
);

1211 i‡(
	`ã°_™d_˛ór_bô
(0, &
m˚_√ed_nŸify
)) {

1212 
	`wake_up_öãºu±ibÀ
(&
m˚_waô
);

1219 i‡(
m˚_hñ≥r
[0] && !
	`w‹k_≥ndög
(&
m˚_åiggî_w‹k
))

1220 
	`scheduÀ_w‹k
(&
m˚_åiggî_w‹k
);

1222 i‡(
	`__øãlimô
(&
øãlimô
))

1223 
	`¥ötk
(
KERN_INFO
 "Machine checkÉventsÜogged\n");

1228 
	}
}

1229 
EXPORT_SYMBOL_GPL
(
m˚_nŸify_úq
);

1231 
__˝uöô
 
	$__mcheck_˝u_m˚_b™ks_öô
()

1233 
i
;

1235 
m˚_b™ks
 = 
	`kzÆloc
(
b™ks
 * (
m˚_b™k
), 
GFP_KERNEL
);

1236 i‡(!
m˚_b™ks
)

1237  -
ENOMEM
;

1238 
i
 = 0; i < 
b™ks
; i++) {

1239 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1241 
b
->
˘l
 = -1ULL;

1242 
b
->
öô
 = 1;

1245 
	}
}

1250 
__˝uöô
 
	$__mcheck_˝u_ˇp_öô
()

1252 
b
;

1253 
u64
 
ˇp
;

1255 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1257 
b
 = 
ˇp
 & 
MCG_BANKCNT_MASK
;

1258 i‡(!
b™ks
)

1259 
	`¥ötk
(
KERN_INFO
 "m˚: CPU suµ‹t†%d MCE b™ks\n", 
b
);

1261 i‡(
b
 > 
MAX_NR_BANKS
) {

1262 
	`¥ötk
(
KERN_WARNING


1264 
MAX_NR_BANKS
, 
b
);

1265 
b
 = 
MAX_NR_BANKS
;

1269 
	`WARN_ON
(
b™ks
 !0 && 
b
 != banks);

1270 
b™ks
 = 
b
;

1271 i‡(!
m˚_b™ks
) {

1272 
îr
 = 
	`__mcheck_˝u_m˚_b™ks_öô
();

1274 i‡(
îr
)

1275  
îr
;

1279 i‡((
ˇp
 & 
MCG_EXT_P
Ë&& 
	`MCG_EXT_CNT
(cap) >= 9)

1280 
rù_m§
 = 
MSR_IA32_MCG_EIP
;

1282 i‡(
ˇp
 & 
MCG_SER_P
)

1283 
m˚_£r
 = 1;

1286 
	}
}

1288 
	$__mcheck_˝u_öô_gíîic
()

1290 
m˚_b™ks_t
 
Æl_b™ks
;

1291 
u64
 
ˇp
;

1292 
i
;

1297 
	`bôm≠_fûl
(
Æl_b™ks
, 
MAX_NR_BANKS
);

1298 
	`machöe_check_pﬁl
(
MCP_UC
|(!
m˚_boŸlog
 ? 
MCP_DONTLOG
 : 0), &
Æl_b™ks
);

1300 
	`£t_ö_¸4
(
X86_CR4_MCE
);

1302 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

1303 i‡(
ˇp
 & 
MCG_CTL_P
)

1304 
	`wrm§
(
MSR_IA32_MCG_CTL
, 0xffffffff, 0xffffffff);

1306 
i
 = 0; i < 
b™ks
; i++) {

1307 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1309 i‡(!
b
->
öô
)

1311 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

1312 
	`wrm§l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0);

1314 
	}
}

1317 
__˝uöô
 
	$__mcheck_˝u_≠∂y_quúks
(
˝uöfo_x86
 *
c
)

1319 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_UNKNOWN
) {

1320 
	`¥_öfo
("MCE: unknown CPUÅype -ÇotÉnabling MCE support.\n");

1321  -
EOPNOTSUPP
;

1325 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
) {

1326 i‡(
c
->
x86
 =15 && 
b™ks
 > 4) {

1332 
	`˛ór_bô
(10, (*)&
m˚_b™ks
[4].
˘l
);

1334 i‡(
c
->
x86
 <17 && 
m˚_boŸlog
 < 0) {

1339 
m˚_boŸlog
 = 0;

1345 i‡(
c
->
x86
 =6 && 
b™ks
 > 0)

1346 
m˚_b™ks
[0].
˘l
 = 0;

1349 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
) {

1359 i‡(
c
->
x86
 =6 && c->
x86_modñ
 < 0x1A && 
b™ks
 > 0)

1360 
m˚_b™ks
[0].
öô
 = 0;

1366 i‡((
c
->
x86
 > 6 || (c->x86 =6 && c->
x86_modñ
 >= 0xe)) &&

1367 
m⁄¨ch_timeout
 < 0)

1368 
m⁄¨ch_timeout
 = 
USEC_PER_SEC
;

1374 i‡(
c
->
x86
 =6 && c->
x86_modñ
 <13 && 
m˚_boŸlog
 < 0)

1375 
m˚_boŸlog
 = 0;

1377 i‡(
m⁄¨ch_timeout
 < 0)

1378 
m⁄¨ch_timeout
 = 0;

1379 i‡(
m˚_boŸlog
 != 0)

1380 
m˚_∑nic_timeout
 = 30;

1383 
	}
}

1385 
__˝uöô
 
	$__mcheck_˝u_™cõ¡_öô
(
˝uöfo_x86
 *
c
)

1387 i‡(
c
->
x86
 != 5)

1389 
c
->
x86_víd‹
) {

1390 
X86_VENDOR_INTEL
:

1391 
	`öãl_p5_mcheck_öô
(
c
);

1393 
X86_VENDOR_CENTAUR
:

1394 
	`wöchù_mcheck_öô
(
c
);

1397 
	}
}

1399 
	$__mcheck_˝u_öô_víd‹
(
˝uöfo_x86
 *
c
)

1401 
c
->
x86_víd‹
) {

1402 
X86_VENDOR_INTEL
:

1403 
	`m˚_öãl_„©uª_öô
(
c
);

1405 
X86_VENDOR_AMD
:

1406 
	`m˚_amd_„©uª_öô
(
c
);

1411 
	}
}

1413 
	$__mcheck_˝u_öô_timî
()

1415 
timî_li°
 *
t
 = &
	`__gë_˝u_v¨
(
m˚_timî
);

1416 *
n
 = &
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
);

1418 
	`£tup_timî
(
t
, 
m˚_°¨t_timî
, 
	`smp_¥o˚ss‹_id
());

1420 i‡(
m˚_ign‹e_˚
)

1423 *
n
 = 
check_öãrvÆ
 * 
HZ
;

1424 i‡(!*
n
)

1426 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 + *
n
);

1427 
	`add_timî_⁄
(
t
, 
	`smp_¥o˚ss‹_id
());

1428 
	}
}

1431 
	$u√x≥˘ed_machöe_check
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

1433 
	`¥ötk
(
KERN_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

1434 
	`smp_¥o˚ss‹_id
());

1435 
	}
}

1438 (*
machöe_check_ve˘‹
)(
±_ªgs
 *, 
îr‹_code
) =

1439 
u√x≥˘ed_machöe_check
;

1445 
__˝uöô
 
	$mcheck_˝u_öô
(
˝uöfo_x86
 *
c
)

1447 i‡(
m˚_dißbÀd
)

1450 
	`__mcheck_˝u_™cõ¡_öô
(
c
);

1452 i‡(!
	`m˚_avaûabÀ
(
c
))

1455 i‡(
	`__mcheck_˝u_ˇp_öô
(Ë< 0 || 
	`__mcheck_˝u_≠∂y_quúks
(
c
) < 0) {

1456 
m˚_dißbÀd
 = 1;

1460 
machöe_check_ve˘‹
 = 
do_machöe_check
;

1462 
	`__mcheck_˝u_öô_gíîic
();

1463 
	`__mcheck_˝u_öô_víd‹
(
c
);

1464 
	`__mcheck_˝u_öô_timî
();

1465 
	`INIT_WORK
(&
	`__gë_˝u_v¨
(
m˚_w‹k
), 
m˚_¥o˚ss_w‹k
);

1467 
	}
}

1473 
DEFINE_SPINLOCK
(
m˚_°©e_lock
);

1474 
	g›í_cou¡
;

1475 
	g›í_ex˛u
;

1477 
	$m˚_›í
(
öode
 *öode, 
fûe
 *file)

1479 
	`•ö_lock
(&
m˚_°©e_lock
);

1481 i‡(
›í_ex˛u
 || (
›í_cou¡
 && (
fûe
->
f_Êags
 & 
O_EXCL
))) {

1482 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1484  -
EBUSY
;

1487 i‡(
fûe
->
f_Êags
 & 
O_EXCL
)

1488 
›í_ex˛u
 = 1;

1489 
›í_cou¡
++;

1491 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1493  
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
);

1494 
	}
}

1496 
	$m˚_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1498 
	`•ö_lock
(&
m˚_°©e_lock
);

1500 
›í_cou¡
--;

1501 
›í_ex˛u
 = 0;

1503 
	`•ö_u∆ock
(&
m˚_°©e_lock
);

1506 
	}
}

1508 
	$cﬁÀ˘_tscs
(*
d©a
)

1510 *
˝u_tsc
 = (*)
d©a
;

1512 
	`rdts˛l
(
˝u_tsc
[
	`smp_¥o˚ss‹_id
()]);

1513 
	}
}

1515 
	gm˚_≠ei_ªad_d⁄e
;

1518 
	$__m˚_ªad_≠ei
(
__u£r
 **
ubuf
, 
size_t
 
usize
)

1520 
rc
;

1521 
u64
 
ªc‹d_id
;

1522 
m˚
 
m
;

1524 i‡(
usize
 < (
m˚
))

1525  -
EINVAL
;

1527 
rc
 = 
	`≠ei_ªad_m˚
(&
m
, &
ªc‹d_id
);

1529 i‡(
rc
 <= 0) {

1530 
m˚_≠ei_ªad_d⁄e
 = 1;

1531  
rc
;

1533 
rc
 = -
EFAULT
;

1534 i‡(
	`c›y_to_u£r
(*
ubuf
, &
m
, (
m˚
)))

1535  
rc
;

1542 
rc
 = 
	`≠ei_˛ór_m˚
(
ªc‹d_id
);

1543 i‡(
rc
) {

1544 
m˚_≠ei_ªad_d⁄e
 = 1;

1545  
rc
;

1547 *
ubuf
 +(
m˚
);

1550 
	}
}

1552 
ssize_t
 
	$m˚_ªad
(
fûe
 *
fûp
, 
__u£r
 *
ubuf
, 
size_t
 
usize
,

1553 
loff_t
 *
off
)

1555 
__u£r
 *
buf
 = 
ubuf
;

1556 *
˝u_tsc
;

1557 
¥ev
, 
√xt
;

1558 
i
, 
îr
;

1560 
˝u_tsc
 = 
	`kmÆloc
(
ƒ_˝u_ids
 * (), 
GFP_KERNEL
);

1561 i‡(!
˝u_tsc
)

1562  -
ENOMEM
;

1564 
	`muãx_lock
(&
m˚_ªad_muãx
);

1566 i‡(!
m˚_≠ei_ªad_d⁄e
) {

1567 
îr
 = 
	`__m˚_ªad_≠ei
(&
buf
, 
usize
);

1568 i‡(
îr
 || 
buf
 !
ubuf
)

1569 
out
;

1572 
√xt
 = 
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.next);

1575 
îr
 = -
EINVAL
;

1576 i‡(*
off
 !0 || 
usize
 < 
MCE_LOG_LEN
*(
m˚
))

1577 
out
;

1579 
îr
 = 0;

1580 
¥ev
 = 0;

1582 
i
 = 
¥ev
; i < 
√xt
; i++) {

1583 
°¨t
 = 
jiffõs
;

1585 !
m˚log
.
íåy
[
i
].
föished
) {

1586 i‡(
	`time_a·î_eq
(
jiffõs
, 
°¨t
 + 2)) {

1587 
	`mem£t
(
m˚log
.
íåy
 + 
i
, 0,

1588 (
m˚
));

1589 
timeout
;

1591 
	`˝u_ªœx
();

1593 
	`smp_rmb
();

1594 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
 + 
i
,

1595 (
m˚
));

1596 
buf
 +(
m˚
);

1597 
timeout
:

1601 
	`mem£t
(
m˚log
.
íåy
 + 
¥ev
, 0,

1602 (
√xt
 - 
¥ev
Ë* (
m˚
));

1603 
¥ev
 = 
√xt
;

1604 
√xt
 = 
	`cmpxchg
(&
m˚log
.√xt, 
¥ev
, 0);

1605 } 
√xt
 !
¥ev
);

1607 
	`synchr⁄ize_sched
();

1613 
	`⁄_óch_˝u
(
cﬁÀ˘_tscs
, 
˝u_tsc
, 1);

1615 
i
 = 
√xt
; i < 
MCE_LOG_LEN
; i++) {

1616 i‡(
m˚log
.
íåy
[
i
].
föished
 &&

1617 
m˚log
.
íåy
[
i
].
tsc
 < 
˝u_tsc
[m˚log.íåy[i].
˝u
]) {

1618 
îr
 |
	`c›y_to_u£r
(
buf
, 
m˚log
.
íåy
+
i
,

1619 (
m˚
));

1620 
	`smp_rmb
();

1621 
buf
 +(
m˚
);

1622 
	`mem£t
(&
m˚log
.
íåy
[
i
], 0, (
m˚
));

1626 i‡(
îr
)

1627 
îr
 = -
EFAULT
;

1629 
out
:

1630 
	`muãx_u∆ock
(&
m˚_ªad_muãx
);

1631 
	`k‰ì
(
˝u_tsc
);

1633  
îr
 ?Éº : 
buf
 - 
ubuf
;

1634 
	}
}

1636 
	$m˚_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

1638 
	`pﬁl_waô
(
fûe
, &
m˚_waô
, 
waô
);

1639 i‡(
	`rcu_dîe„ªn˚_check_m˚
(
m˚log
.
√xt
))

1640  
POLLIN
 | 
POLLRDNORM
;

1641 i‡(!
m˚_≠ei_ªad_d⁄e
 && 
	`≠ei_check_m˚
())

1642  
POLLIN
 | 
POLLRDNORM
;

1644 
	}
}

1646 
	$m˚_io˘l
(
fûe
 *
f
, 
cmd
, 
¨g
)

1648 
__u£r
 *
p
 = (__u£∏*)
¨g
;

1650 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1651  -
EPERM
;

1653 
cmd
) {

1654 
MCE_GET_RECORD_LEN
:

1655  
	`put_u£r
((
m˚
), 
p
);

1656 
MCE_GET_LOG_LEN
:

1657  
	`put_u£r
(
MCE_LOG_LEN
, 
p
);

1658 
MCE_GETCLEAR_FLAGS
: {

1659 
Êags
;

1662 
Êags
 = 
m˚log
.flags;

1663 } 
	`cmpxchg
(&
m˚log
.
Êags
, flags, 0) != flags);

1665  
	`put_u£r
(
Êags
, 
p
);

1668  -
ENOTTY
;

1670 
	}
}

1673 
fûe_›î©i⁄s
 
	gm˚_chrdev_›s
 = {

1674 .
›í
 = 
m˚_›í
,

1675 .
	gªÀa£
 = 
m˚_ªÀa£
,

1676 .
	gªad
 = 
m˚_ªad
,

1677 .
	gpﬁl
 = 
m˚_pﬁl
,

1678 .
	gu∆ocked_io˘l
 = 
m˚_io˘l
,

1680 
EXPORT_SYMBOL_GPL
(
m˚_chrdev_›s
);

1682 
miscdevi˚
 
	gm˚_log_devi˚
 = {

1683 
MISC_MCELOG_MINOR
,

1685 &
m˚_chrdev_›s
,

1699 
__öô
 
	$mcheck_íabÀ
(*
°r
)

1701 i‡(*
°r
 == 0) {

1702 
	`íabÀ_p5_m˚
();

1705 i‡(*
°r
 == '=')

1706 
°r
++;

1707 i‡(!
	`°rcmp
(
°r
, "off"))

1708 
m˚_dißbÀd
 = 1;

1709 i‡(!
	`°rcmp
(
°r
, "no_cmci"))

1710 
m˚_cmci_dißbÀd
 = 1;

1711 i‡(!
	`°rcmp
(
°r
, "dont_log_ce"))

1712 
m˚_d⁄t_log_˚
 = 1;

1713 i‡(!
	`°rcmp
(
°r
, "ignore_ce"))

1714 
m˚_ign‹e_˚
 = 1;

1715 i‡(!
	`°rcmp
(
°r
, "bootlog") || !strcmp(str, "nobootlog"))

1716 
m˚_boŸlog
 = (
°r
[0] == 'b');

1717 i‡(
	`isdigô
(
°r
[0])) {

1718 
	`gë_›ti⁄
(&
°r
, &
tﬁî™t
);

1719 i‡(*
°r
 == ',') {

1720 ++
°r
;

1721 
	`gë_›ti⁄
(&
°r
, &
m⁄¨ch_timeout
);

1724 
	`¥ötk
(
KERN_INFO
 "mceárgument %s ignored. Please use /sys\n",

1725 
°r
);

1729 
	}
}

1730 
__£tup
("m˚", 
mcheck_íabÀ
);

1732 
__öô
 
	$mcheck_öô
()

1734 
	`©omic_nŸifõr_chaö_ªgi°î
(&
x86_m˚_decodî_chaö
, &
m˚_dec_nb
);

1736 
	`mcheck_öãl_thîm_öô
();

1739 
	}
}

1749 
	$m˚_dißbÀ_îr‹_ªp‹tög
()

1751 
i
;

1753 
i
 = 0; i < 
b™ks
; i++) {

1754 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

1756 i‡(
b
->
öô
)

1757 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

1760 
	}
}

1762 
	$m˚_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1764  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1765 
	}
}

1767 
	$m˚_shutdown
(
sys_devi˚
 *
dev
)

1769  
	`m˚_dißbÀ_îr‹_ªp‹tög
();

1770 
	}
}

1777 
	$m˚_ªsume
(
sys_devi˚
 *
dev
)

1779 
	`__mcheck_˝u_öô_gíîic
();

1780 
	`__mcheck_˝u_öô_víd‹
(&
cuºít_˝u_d©a
);

1783 
	}
}

1785 
	$m˚_˝u_ª°¨t
(*
d©a
)

1787 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1788 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1790 
	`__mcheck_˝u_öô_gíîic
();

1791 
	`__mcheck_˝u_öô_timî
();

1792 
	}
}

1795 
	$m˚_ª°¨t
()

1797 
	`⁄_óch_˝u
(
m˚_˝u_ª°¨t
, 
NULL
, 1);

1798 
	}
}

1801 
	$m˚_dißbÀ_˚
(*
Æl
)

1803 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1805 i‡(
Æl
)

1806 
	`dñ_timî_sync
(&
	`__gë_˝u_v¨
(
m˚_timî
));

1807 
	`cmci_˛ór
();

1808 
	}
}

1810 
	$m˚_íabÀ_˚
(*
Æl
)

1812 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

1814 
	`cmci_ªíabÀ
();

1815 
	`cmci_ªcheck
();

1816 i‡(
Æl
)

1817 
	`__mcheck_˝u_öô_timî
();

1818 
	}
}

1820 
sysdev_˛ass
 
	gm˚_sys˛ass
 = {

1821 .
su•íd
 = 
m˚_su•íd
,

1822 .
	gshutdown
 = 
m˚_shutdown
,

1823 .
	gªsume
 = 
m˚_ªsume
,

1824 .
	g«me
 = "machinecheck",

1827 
DEFINE_PER_CPU
(
sys_devi˚
, 
m˚_dev
);

1829 
__˝uöôd©a


1830 (*
thªshﬁd_˝u_ˇŒback
)(
a˘i⁄
, 
˝u
);

1832 
ölöe
 
m˚_b™k
 *
	$©å_to_b™k
(
sysdev_©åibuã
 *
©å
)

1834  
	`c⁄èöî_of
(
©å
, 
m˚_b™k
,áttr);

1835 
	}
}

1837 
ssize_t
 
	$show_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1838 *
buf
)

1840  
	`•rötf
(
buf
, "%Œx\n", 
	`©å_to_b™k
(
©å
)->
˘l
);

1841 
	}
}

1843 
ssize_t
 
	$£t_b™k
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1844 c⁄° *
buf
, 
size_t
 
size
)

1846 
u64
 
√w
;

1848 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1849  -
EINVAL
;

1851 
	`©å_to_b™k
(
©å
)->
˘l
 = 
√w
;

1852 
	`m˚_ª°¨t
();

1854  
size
;

1855 
	}
}

1857 
ssize_t


1858 
	$show_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
, *
buf
)

1860 
	`°r˝y
(
buf
, 
m˚_hñ≥r
);

1861 
	`°rˇt
(
buf
, "\n");

1862  
	`°æí
(
m˚_hñ≥r
) + 1;

1863 
	}
}

1865 
ssize_t
 
	$£t_åiggî
(
sys_devi˚
 *
s
, 
sysdev_©åibuã
 *
©å
,

1866 c⁄° *
buf
, 
size_t
 
siz
)

1868 *
p
;

1870 
	`°∫˝y
(
m˚_hñ≥r
, 
buf
, (mce_helper));

1871 
m˚_hñ≥r
[(mce_helper)-1] = 0;

1872 
p
 = 
	`°rchr
(
m˚_hñ≥r
, '\n');

1874 i‡(
p
)

1875 *
p
 = 0;

1877  
	`°æí
(
m˚_hñ≥r
Ë+ !!
p
;

1878 
	}
}

1880 
ssize_t
 
	$£t_ign‹e_˚
(
sys_devi˚
 *
s
,

1881 
sysdev_©åibuã
 *
©å
,

1882 c⁄° *
buf
, 
size_t
 
size
)

1884 
u64
 
√w
;

1886 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1887  -
EINVAL
;

1889 i‡(
m˚_ign‹e_˚
 ^ !!
√w
) {

1890 i‡(
√w
) {

1892 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, (*)1, 1);

1893 
m˚_ign‹e_˚
 = 1;

1896 
m˚_ign‹e_˚
 = 0;

1897 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, (*)1, 1);

1900  
size
;

1901 
	}
}

1903 
ssize_t
 
	$£t_cmci_dißbÀd
(
sys_devi˚
 *
s
,

1904 
sysdev_©åibuã
 *
©å
,

1905 c⁄° *
buf
, 
size_t
 
size
)

1907 
u64
 
√w
;

1909 i‡(
	`°ri˘_°πouŒ
(
buf
, 0, &
√w
) < 0)

1910  -
EINVAL
;

1912 i‡(
m˚_cmci_dißbÀd
 ^ !!
√w
) {

1913 i‡(
√w
) {

1915 
	`⁄_óch_˝u
(
m˚_dißbÀ_˚
, 
NULL
, 1);

1916 
m˚_cmci_dißbÀd
 = 1;

1919 
m˚_cmci_dißbÀd
 = 0;

1920 
	`⁄_óch_˝u
(
m˚_íabÀ_˚
, 
NULL
, 1);

1923  
size
;

1924 
	}
}

1926 
ssize_t
 
	$°‹e_öt_wôh_ª°¨t
(
sys_devi˚
 *
s
,

1927 
sysdev_©åibuã
 *
©å
,

1928 c⁄° *
buf
, 
size_t
 
size
)

1930 
ssize_t
 
ªt
 = 
	`sysdev_°‹e_öt
(
s
, 
©å
, 
buf
, 
size
);

1931 
	`m˚_ª°¨t
();

1932  
ªt
;

1933 
	}
}

1935 
SYSDEV_ATTR
(
åiggî
, 0644, 
show_åiggî
, 
£t_åiggî
);

1936 
SYSDEV_INT_ATTR
(
tﬁî™t
, 0644,Åolerant);

1937 
SYSDEV_INT_ATTR
(
m⁄¨ch_timeout
, 0644, monarch_timeout);

1938 
SYSDEV_INT_ATTR
(
d⁄t_log_˚
, 0644, 
m˚_d⁄t_log_˚
);

1940 
sysdev_ext_©åibuã
 
	g©å_check_öãrvÆ
 = {

1941 
_SYSDEV_ATTR
(
check_öãrvÆ
, 0644, 
sysdev_show_öt
,

1942 
°‹e_öt_wôh_ª°¨t
),

1943 &
check_öãrvÆ


1946 
sysdev_ext_©åibuã
 
	g©å_ign‹e_˚
 = {

1947 
_SYSDEV_ATTR
(
ign‹e_˚
, 0644, 
sysdev_show_öt
, 
£t_ign‹e_˚
),

1948 &
m˚_ign‹e_˚


1951 
sysdev_ext_©åibuã
 
	g©å_cmci_dißbÀd
 = {

1952 
_SYSDEV_ATTR
(
cmci_dißbÀd
, 0644, 
sysdev_show_öt
, 
£t_cmci_dißbÀd
),

1953 &
m˚_cmci_dißbÀd


1956 
sysdev_©åibuã
 *
	gm˚_©ås
[] = {

1957 &
©å_tﬁî™t
.
©å
,

1958 &
©å_check_öãrvÆ
.
©å
,

1959 &
©å_åiggî
,

1960 &
©å_m⁄¨ch_timeout
.
©å
,

1961 &
©å_d⁄t_log_˚
.
©å
,

1962 &
©å_ign‹e_˚
.
©å
,

1963 &
©å_cmci_dißbÀd
.
©å
,

1964 
NULL


1967 
˝umask_v¨_t
 
	gm˚_dev_öôülized
;

1970 
__˝uöô
 
	$m˚_¸óã_devi˚
(
˝u
)

1972 
îr
;

1973 
i
, 
j
;

1975 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

1976  -
EIO
;

1978 
	`mem£t
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 0, (
kobje˘
));

1979 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
id
 = cpu;

1980 
	`≥r_˝u
(
m˚_dev
, 
˝u
).
˛s
 = &
m˚_sys˛ass
;

1982 
îr
 = 
	`sysdev_ªgi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

1983 i‡(
îr
)

1984  
îr
;

1986 
i
 = 0; 
m˚_©ås
[i]; i++) {

1987 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

1988 i‡(
îr
)

1989 
îr‹
;

1991 
j
 = 0; j < 
b™ks
; j++) {

1992 
îr
 = 
	`sysdev_¸óã_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
),

1993 &
m˚_b™ks
[
j
].
©å
);

1994 i‡(
îr
)

1995 
îr‹2
;

1997 
	`˝umask_£t_˝u
(
˝u
, 
m˚_dev_öôülized
);

2000 
îr‹2
:

2001 --
j
 >= 0)

2002 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
j
].
©å
);

2003 
îr‹
:

2004 --
i
 >= 0)

2005 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

2007 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

2009  
îr
;

2010 
	}
}

2012 
__˝uöô
 
	$m˚_ªmove_devi˚
(
˝u
)

2014 
i
;

2016 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
m˚_dev_öôülized
))

2019 
i
 = 0; 
m˚_©ås
[i]; i++)

2020 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), 
m˚_©ås
[
i
]);

2022 
i
 = 0; i < 
b™ks
; i++)

2023 
	`sysdev_ªmove_fûe
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
), &
m˚_b™ks
[
i
].
©å
);

2025 
	`sysdev_uƒegi°î
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
));

2026 
	`˝umask_˛ór_˝u
(
˝u
, 
m˚_dev_öôülized
);

2027 
	}
}

2030 
__˝uöô
 
	$m˚_dißbÀ_˝u
(*
h
)

2032 
a˘i⁄
 = *(*)
h
;

2033 
i
;

2035 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

2038 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

2039 
	`cmci_˛ór
();

2040 
i
 = 0; i < 
b™ks
; i++) {

2041 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2043 i‡(
b
->
öô
)

2044 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 0);

2046 
	}
}

2048 
__˝uöô
 
	$m˚_ªíabÀ_˝u
(*
h
)

2050 
a˘i⁄
 = *(*)
h
;

2051 
i
;

2053 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
))

2056 i‡(!(
a˘i⁄
 & 
CPU_TASKS_FROZEN
))

2057 
	`cmci_ªíabÀ
();

2058 
i
 = 0; i < 
b™ks
; i++) {

2059 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2061 i‡(
b
->
öô
)

2062 
	`wrm§l
(
	`MSR_IA32_MCx_CTL
(
i
), 
b
->
˘l
);

2064 
	}
}

2067 
__˝uöô


2068 
	$m˚_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
, *
h˝u
)

2070 
˝u
 = ()
h˝u
;

2071 
timî_li°
 *
t
 = &
	`≥r_˝u
(
m˚_timî
, 
˝u
);

2073 
a˘i⁄
) {

2074 
CPU_ONLINE
:

2075 
CPU_ONLINE_FROZEN
:

2076 
	`m˚_¸óã_devi˚
(
˝u
);

2077 i‡(
thªshﬁd_˝u_ˇŒback
)

2078 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2080 
CPU_DEAD
:

2081 
CPU_DEAD_FROZEN
:

2082 i‡(
thªshﬁd_˝u_ˇŒback
)

2083 
	`thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
);

2084 
	`m˚_ªmove_devi˚
(
˝u
);

2086 
CPU_DOWN_PREPARE
:

2087 
CPU_DOWN_PREPARE_FROZEN
:

2088 
	`dñ_timî_sync
(
t
);

2089 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_dißbÀ_˝u
, &
a˘i⁄
, 1);

2091 
CPU_DOWN_FAILED
:

2092 
CPU_DOWN_FAILED_FROZEN
:

2093 i‡(!
m˚_ign‹e_˚
 && 
check_öãrvÆ
) {

2094 
t
->
expúes
 = 
	`round_jiffõs
(
jiffõs
 +

2095 
	`__gë_˝u_v¨
(
m˚_√xt_öãrvÆ
));

2096 
	`add_timî_⁄
(
t
, 
˝u
);

2098 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
m˚_ªíabÀ_˝u
, &
a˘i⁄
, 1);

2100 
CPU_POST_DEAD
:

2102 
	`cmci_ªdiscovî
(
˝u
);

2105  
NOTIFY_OK
;

2106 
	}
}

2108 
nŸifõr_block
 
m˚_˝u_nŸifõr
 
	g__˝uöôd©a
 = {

2109 .
nŸifõr_ˇŒ
 = 
m˚_˝u_ˇŒback
,

2112 
__öô
 
	$m˚_öô_b™ks
()

2114 
i
;

2116 
i
 = 0; i < 
b™ks
; i++) {

2117 
m˚_b™k
 *
b
 = &
m˚_b™ks
[
i
];

2118 
sysdev_©åibuã
 *
a
 = &
b
->
©å
;

2120 
	`sysfs_©å_öô
(&
a
->
©å
);

2121 
a
->
©å
.
«me
 = 
b
->
©å«me
;

2122 
	`¢¥ötf
(
b
->
©å«me
, 
ATTR_LEN
, "b™k%d", 
i
);

2124 
a
->
©å
.
mode
 = 0644;

2125 
a
->
show
 = 
show_b™k
;

2126 
a
->
°‹e
 = 
£t_b™k
;

2128 
	}
}

2130 
__öô
 
	$mcheck_öô_devi˚
()

2132 
îr
;

2133 
i
 = 0;

2135 i‡(!
	`m˚_avaûabÀ
(&
boŸ_˝u_d©a
))

2136  -
EIO
;

2138 
	`zÆloc_˝umask_v¨
(&
m˚_dev_öôülized
, 
GFP_KERNEL
);

2140 
	`m˚_öô_b™ks
();

2142 
îr
 = 
	`sysdev_˛ass_ªgi°î
(&
m˚_sys˛ass
);

2143 i‡(
îr
)

2144  
îr
;

2146 
	`f‹_óch_⁄löe_˝u
(
i
) {

2147 
îr
 = 
	`m˚_¸óã_devi˚
(
i
);

2148 i‡(
îr
)

2149  
îr
;

2152 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m˚_˝u_nŸifõr
);

2153 
	`misc_ªgi°î
(&
m˚_log_devi˚
);

2155  
îr
;

2156 
	}
}

2158 
devi˚_öôˇŒ
(
mcheck_öô_devi˚
);

2163 
__öô
 
	$mcheck_dißbÀ
(*
°r
)

2165 
m˚_dißbÀd
 = 1;

2167 
	}
}

2168 
__£tup
("nom˚", 
mcheck_dißbÀ
);

2170 #ifde‡
CONFIG_DEBUG_FS


2171 
díåy
 *
	$m˚_gë_debugfs_dú
()

2173 
díåy
 *
dm˚
;

2175 i‡(!
dm˚
)

2176 
dm˚
 = 
	`debugfs_¸óã_dú
("m˚", 
NULL
);

2178  
dm˚
;

2179 
	}
}

2181 
	$m˚_ª£t
()

2183 
˝u_missög
 = 0;

2184 
	`©omic_£t
(&
m˚_Áke_∑ni˚d
, 0);

2185 
	`©omic_£t
(&
m˚_executög
, 0);

2186 
	`©omic_£t
(&
m˚_ˇŒö
, 0);

2187 
	`©omic_£t
(&
globÆ_nwo
, 0);

2188 
	}
}

2190 
	$Áke_∑nic_gë
(*
d©a
, 
u64
 *
vÆ
)

2192 *
vÆ
 = 
Áke_∑nic
;

2194 
	}
}

2196 
	$Áke_∑nic_£t
(*
d©a
, 
u64
 
vÆ
)

2198 
	`m˚_ª£t
();

2199 
Áke_∑nic
 = 
vÆ
;

2201 
	}
}

2203 
DEFINE_SIMPLE_ATTRIBUTE
(
Áke_∑nic_f›s
, 
Áke_∑nic_gë
,

2204 
Áke_∑nic_£t
, "%llu\n");

2206 
__öô
 
	$mcheck_debugfs_öô
()

2208 
díåy
 *
dm˚
, *
fÁke_∑nic
;

2210 
dm˚
 = 
	`m˚_gë_debugfs_dú
();

2211 i‡(!
dm˚
)

2212  -
ENOMEM
;

2213 
fÁke_∑nic
 = 
	`debugfs_¸óã_fûe
("Áke_∑nic", 0444, 
dm˚
, 
NULL
,

2214 &
Áke_∑nic_f›s
);

2215 i‡(!
fÁke_∑nic
)

2216  -
ENOMEM
;

2219 
	}
}

2220 
œã_öôˇŒ
(
mcheck_debugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/kobje˘.h
>

19 
	~<löux/≥r˝u.h
>

20 
	~<löux/sysdev.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/sysfs.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/˝u.h
>

27 
	~<löux/smp.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

34 
	#PFX
 "m˚_thªshﬁd: "

	)

35 
	#VERSION
 "vîsi⁄ 1.1.1"

	)

36 
	#NR_BANKS
 6

	)

37 
	#NR_BLOCKS
 9

	)

38 
	#THRESHOLD_MAX
 0xFFF

	)

39 
	#INT_TYPE_APIC
 0x00020000

	)

40 
	#MASK_VALID_HI
 0x80000000

	)

41 
	#MASK_CNTP_HI
 0x40000000

	)

42 
	#MASK_LOCKED_HI
 0x20000000

	)

43 
	#MASK_LVTOFF_HI
 0x00F00000

	)

44 
	#MASK_COUNT_EN_HI
 0x00080000

	)

45 
	#MASK_INT_TYPE_HI
 0x00060000

	)

46 
	#MASK_OVERFLOW_HI
 0x00010000

	)

47 
	#MASK_ERR_COUNT_HI
 0x00000FFF

	)

48 
	#MASK_BLKPTR_LO
 0xFF000000

	)

49 
	#MCG_XBLK_ADDR
 0xC0000400

	)

51 
	sthªshﬁd_block
 {

52 
	mblock
;

53 
	mb™k
;

54 
	m˝u
;

55 
u32
 
	maddªss
;

56 
u16
 
	möãºu±_íabÀ
;

57 
u16
 
	mthªshﬁd_limô
;

58 
kobje˘
 
	mkobj
;

59 
li°_hód
 
	mmiscj
;

63 
thªshﬁd_block
 
	gthªshﬁd_deÁu…s
 = {

64 .
öãºu±_íabÀ
 = 0,

65 .
	gthªshﬁd_limô
 = 
THRESHOLD_MAX
,

68 
	sthªshﬁd_b™k
 {

69 
kobje˘
 *
	mkobj
;

70 
thªshﬁd_block
 *
	mblocks
;

71 
˝umask_v¨_t
 
	m˝us
;

73 
DEFINE_PER_CPU
(
thªshﬁd_b™k
 * [
NR_BANKS
], 
thªshﬁd_b™ks
);

75 #ifde‡
CONFIG_SMP


76 
	gsh¨ed_b™k
[
NR_BANKS
] = {

81 
DEFINE_PER_CPU
(, 
b™k_m≠
);

83 
amd_thªshﬁd_öãºu±
();

89 
	sthªsh_ª°¨t
 {

90 
thªshﬁd_block
 *
	mb
;

91 
	mª£t
;

92 
u16
 
	mﬁd_limô
;

97 
	$thªshﬁd_ª°¨t_b™k
(*
_å
)

99 
thªsh_ª°¨t
 *
å
 = 
_å
;

100 
u32
 
mci_misc_hi
, 
mci_misc_lo
;

102 
	`rdm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

104 i‡(
å
->
b
->
thªshﬁd_limô
 < (
mci_misc_hi
 & 
THRESHOLD_MAX
))

105 
å
->
ª£t
 = 1;

107 i‡(
å
->
ª£t
) {

108 
mci_misc_hi
 =

109 (
mci_misc_hi
 & ~(
MASK_ERR_COUNT_HI
 | 
MASK_OVERFLOW_HI
)) |

110 (
THRESHOLD_MAX
 - 
å
->
b
->
thªshﬁd_limô
);

111 } i‡(
å
->
ﬁd_limô
) {

112 
√w_cou¡
 = (
mci_misc_hi
 & 
THRESHOLD_MAX
) +

113 (
å
->
ﬁd_limô
 -År->
b
->
thªshﬁd_limô
);

115 
mci_misc_hi
 = (mci_misc_hò& ~
MASK_ERR_COUNT_HI
) |

116 (
√w_cou¡
 & 
THRESHOLD_MAX
);

119 
å
->
b
->
öãºu±_íabÀ
 ?

120 (
mci_misc_hi
 = (mci_misc_hò& ~
MASK_INT_TYPE_HI
Ë| 
INT_TYPE_APIC
) :

121 (
mci_misc_hi
 &~
MASK_INT_TYPE_HI
);

123 
mci_misc_hi
 |
MASK_COUNT_EN_HI
;

124 
	`wrm§
(
å
->
b
->
addªss
, 
mci_misc_lo
, 
mci_misc_hi
);

125 
	}
}

128 
	$m˚_amd_„©uª_öô
(
˝uöfo_x86
 *
c
)

130 
˝u
 = 
	`smp_¥o˚ss‹_id
();

131 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

132 
b™k
, 
block
;

133 
thªsh_ª°¨t
 
å
;

134 
u8
 
lvt_off
;

136 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

137 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

138 i‡(
block
 == 0)

139 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

140 i‡(
block
 == 1) {

141 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

142 i‡(!
addªss
)

144 
addªss
 +
MCG_XBLK_ADDR
;

146 ++
addªss
;

148 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

151 i‡(!(
high
 & 
MASK_VALID_HI
)) {

152 i‡(
block
)

158 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

159 (
high
 & 
MASK_LOCKED_HI
))

162 i‡(!
block
)

163 
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë|(1 << 
b™k
);

164 #ifde‡
CONFIG_SMP


165 i‡(
sh¨ed_b™k
[
b™k
] && 
c
->
˝u_c‹e_id
)

168 
lvt_off
 = 
	`£tup_APIC_eûvt_m˚
(
THRESHOLD_APIC_VECTOR
,

169 
APIC_EILVT_MSG_FIX
, 0);

171 
high
 &~
MASK_LVTOFF_HI
;

172 
high
 |
lvt_off
 << 20;

173 
	`wrm§
(
addªss
, 
low
, 
high
);

175 
thªshﬁd_deÁu…s
.
addªss
 =áddress;

176 
å
.
b
 = &
thªshﬁd_deÁu…s
;

177 
å
.
ª£t
 = 0;

178 
å
.
ﬁd_limô
 = 0;

179 
	`thªshﬁd_ª°¨t_b™k
(&
å
);

181 
m˚_thªshﬁd_ve˘‹
 = 
amd_thªshﬁd_öãºu±
;

184 
	}
}

195 
	$amd_thªshﬁd_öãºu±
()

197 
u32
 
low
 = 0, 
high
 = 0, 
addªss
 = 0;

198 
b™k
, 
block
;

199 
m˚
 
m
;

201 
	`m˚_£tup
(&
m
);

204 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

205 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
m
.
˝u
Ë& (1 << 
b™k
)))

207 
block
 = 0; block < 
NR_BLOCKS
; ++block) {

208 i‡(
block
 == 0) {

209 
addªss
 = 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4;

210 } i‡(
block
 == 1) {

211 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

212 i‡(!
addªss
)

214 
addªss
 +
MCG_XBLK_ADDR
;

216 ++
addªss
;

219 i‡(
	`rdm§_ß„
(
addªss
, &
low
, &
high
))

222 i‡(!(
high
 & 
MASK_VALID_HI
)) {

223 i‡(
block
)

229 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

230 (
high
 & 
MASK_LOCKED_HI
))

237 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
,

238 &
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

240 i‡(
high
 & 
MASK_OVERFLOW_HI
) {

241 
	`rdm§l
(
addªss
, 
m
.
misc
);

242 
	`rdm§l
(
MSR_IA32_MC0_STATUS
 + 
b™k
 * 4,

243 
m
.
°©us
);

244 
m
.
b™k
 = 
K8_MCE_THRESHOLD_BASE


245 + 
b™k
 * 
NR_BLOCKS


246 + 
block
;

247 
	`m˚_log
(&
m
);

252 
	}
}

258 
	sthªshﬁd_©å
 {

259 
©åibuã
 
	m©å
;

260 
ssize_t
 (*
show
Ë(
	mthªshﬁd_block
 *, *);

261 
ssize_t
 (*
°‹e
Ë(
	mthªshﬁd_block
 *, c⁄° *, 
size_t
 
	mcou¡
);

264 
	#SHOW_FIELDS
(
«me
) \

265 
ssize_t
 
show_
 ## 
	`«me
(
thªshﬁd_block
 *
b
, *
buf
) \

267  
	`•rötf
(
buf
, "%lx\n", (Ë
b
->
«me
); \

268 }

	)

269 
	$SHOW_FIELDS
(
öãºu±_íabÀ
)

270 
	$SHOW_FIELDS
(
thªshﬁd_limô
)

272 
ssize_t


273 
	$°‹e_öãºu±_íabÀ
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

275 
thªsh_ª°¨t
 
å
;

276 
√w
;

278 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

279  -
EINVAL
;

281 
b
->
öãºu±_íabÀ
 = !!
√w
;

283 
å
.
b
 = b;

284 
å
.
ª£t
 = 0;

285 
å
.
ﬁd_limô
 = 0;

287 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

289  
size
;

290 
	}
}

292 
ssize_t


293 
	$°‹e_thªshﬁd_limô
(
thªshﬁd_block
 *
b
, c⁄° *
buf
, 
size_t
 
size
)

295 
thªsh_ª°¨t
 
å
;

296 
√w
;

298 i‡(
	`°ri˘_°πoul
(
buf
, 0, &
√w
) < 0)

299  -
EINVAL
;

301 i‡(
√w
 > 
THRESHOLD_MAX
)

302 
√w
 = 
THRESHOLD_MAX
;

303 i‡(
√w
 < 1)

304 
√w
 = 1;

306 
å
.
ﬁd_limô
 = 
b
->
thªshﬁd_limô
;

307 
b
->
thªshﬁd_limô
 = 
√w
;

308 
å
.
b
 = b;

309 
å
.
ª£t
 = 0;

311 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

313  
size
;

314 
	}
}

316 
	sthªshﬁd_block_¸oss_˝u
 {

317 
thªshﬁd_block
 *
	mtb
;

318 
	mªtvÆ
;

321 
	$loˇl_îr‹_cou¡_h™dÀr
(*
_tbcc
)

323 
thªshﬁd_block_¸oss_˝u
 *
tbcc
 = 
_tbcc
;

324 
thªshﬁd_block
 *
b
 = 
tbcc
->
tb
;

325 
u32
 
low
, 
high
;

327 
	`rdm§
(
b
->
addªss
, 
low
, 
high
);

328 
tbcc
->
ªtvÆ
 = (
high
 & 0xFFFË- (
THRESHOLD_MAX
 - 
b
->
thªshﬁd_limô
);

329 
	}
}

331 
ssize_t
 
	$show_îr‹_cou¡
(
thªshﬁd_block
 *
b
, *
buf
)

333 
thªshﬁd_block_¸oss_˝u
 
tbcc
 = { .
tb
 = 
b
, };

335 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
loˇl_îr‹_cou¡_h™dÀr
, &
tbcc
, 1);

336  
	`•rötf
(
buf
, "%lx\n", 
tbcc
.
ªtvÆ
);

337 
	}
}

339 
ssize_t
 
	$°‹e_îr‹_cou¡
(
thªshﬁd_block
 *
b
,

340 c⁄° *
buf
, 
size_t
 
cou¡
)

342 
thªsh_ª°¨t
 
å
 = { .
b
 = b, .
ª£t
 = 1, .
ﬁd_limô
 = 0 };

344 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
b
->
˝u
, 
thªshﬁd_ª°¨t_b™k
, &
å
, 1);

346 
	}
}

348 
	#RW_ATTR
(
vÆ
) \

349 
thªshﬁd_©å
 
vÆ
 = { \

350 .
©å
 = {.
«me
 = 
	`__°rögify
(
vÆ
), .
mode
 = 0644 }, \

351 .
show
 = 
show_
## 
vÆ
, \

352 .
°‹e
 = 
°‹e_
## 
vÆ
, \

353 };

	)

355 
RW_ATTR
(
öãºu±_íabÀ
);

356 
RW_ATTR
(
thªshﬁd_limô
);

357 
RW_ATTR
(
îr‹_cou¡
);

359 
©åibuã
 *
	gdeÁu…_©ås
[] = {

360 &
öãºu±_íabÀ
.
©å
,

361 &
thªshﬁd_limô
.
©å
,

362 &
îr‹_cou¡
.
©å
,

363 
NULL


366 
	#to_block
(
k
Ë
	`c⁄èöî_of
(k, 
thªshﬁd_block
, 
kobj
)

	)

367 
	#to_©å
(
a
Ë
	`c⁄èöî_of
◊, 
thªshﬁd_©å
, 
©å
)

	)

369 
ssize_t
 
	$show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
buf
)

371 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

372 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

373 
ssize_t
 
ªt
;

375 
ªt
 = 
a
->
show
 ?á->
	`show
(
b
, 
buf
Ë: -
EIO
;

377  
ªt
;

378 
	}
}

380 
ssize_t
 
	$°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

381 c⁄° *
buf
, 
size_t
 
cou¡
)

383 
thªshﬁd_block
 *
b
 = 
	`to_block
(
kobj
);

384 
thªshﬁd_©å
 *
a
 = 
	`to_©å
(
©å
);

385 
ssize_t
 
ªt
;

387 
ªt
 = 
a
->
°‹e
 ?á->
	`°‹e
(
b
, 
buf
, 
cou¡
Ë: -
EIO
;

389  
ªt
;

390 
	}
}

392 c⁄° 
sysfs_›s
 
	gthªshﬁd_›s
 = {

393 .
show
 = show,

394 .
	g°‹e
 = 
°‹e
,

397 
kobj_ty≥
 
	gthªshﬁd_kty≥
 = {

398 .
sysfs_›s
 = &
thªshﬁd_›s
,

399 .
	gdeÁu…_©ås
 = 
deÁu…_©ås
,

402 
__˝uöô
 
	$Æloˇã_thªshﬁd_blocks
(
˝u
,

403 
b™k
,

404 
block
,

405 
u32
 
addªss
)

407 
thªshﬁd_block
 *
b
 = 
NULL
;

408 
u32
 
low
, 
high
;

409 
îr
;

411 i‡((
b™k
 >
NR_BANKS
Ë|| (
block
 >
NR_BLOCKS
))

414 i‡(
	`rdm§_ß„_⁄_˝u
(
˝u
, 
addªss
, &
low
, &
high
))

417 i‡(!(
high
 & 
MASK_VALID_HI
)) {

418 i‡(
block
)

419 
ªcur£
;

424 i‡(!(
high
 & 
MASK_CNTP_HI
) ||

425 (
high
 & 
MASK_LOCKED_HI
))

426 
ªcur£
;

428 
b
 = 
	`kzÆloc
((
thªshﬁd_block
), 
GFP_KERNEL
);

429 i‡(!
b
)

430  -
ENOMEM
;

432 
b
->
block
 = block;

433 
b
->
b™k
 = bank;

434 
b
->
˝u
 = cpu;

435 
b
->
addªss
 =áddress;

436 
b
->
öãºu±_íabÀ
 = 0;

437 
b
->
thªshﬁd_limô
 = 
THRESHOLD_MAX
;

439 
	`INIT_LIST_HEAD
(&
b
->
miscj
);

441 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
) {

442 
	`li°_add
(&
b
->
miscj
,

443 &
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
->
miscj
);

445 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
b
;

448 
îr
 = 
	`kobje˘_öô_™d_add
(&
b
->
kobj
, &
thªshﬁd_kty≥
,

449 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
kobj
,

450 "misc%i", 
block
);

451 i‡(
îr
)

452 
out_‰ì
;

453 
ªcur£
:

454 i‡(!
block
) {

455 
addªss
 = (
low
 & 
MASK_BLKPTR_LO
) >> 21;

456 i‡(!
addªss
)

458 
addªss
 +
MCG_XBLK_ADDR
;

460 ++
addªss
;

463 
îr
 = 
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, ++
block
, 
addªss
);

464 i‡(
îr
)

465 
out_‰ì
;

467 i‡(
b
)

468 
	`kobje˘_uevít
(&
b
->
kobj
, 
KOBJ_ADD
);

470  
îr
;

472 
out_‰ì
:

473 i‡(
b
) {

474 
	`kobje˘_put
(&
b
->
kobj
);

475 
	`k‰ì
(
b
);

477  
îr
;

478 
	}
}

480 
__˝uöô
 

481 
	$loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
)

483  
	`Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
, 0,

484 
MSR_IA32_MC0_MISC
 + 
b™k
 * 4);

485 
	}
}

488 
__˝uöô
 
	$thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
)

490 
i
, 
îr
 = 0;

491 
thªshﬁd_b™k
 *
b
 = 
NULL
;

492 
«me
[32];

493 #ifde‡
CONFIG_SMP


494 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

497 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

499 #ifde‡
CONFIG_SMP


500 i‡(
	`˝u_d©a
(
˝u
).
˝u_c‹e_id
 && 
sh¨ed_b™k
[
b™k
]) {

501 
i
 = 
	`˝umask_fú°
(
c
->
Œc_sh¨ed_m≠
);

504 i‡(
	`˝u_d©a
(
i
).
˝u_c‹e_id
)

505 
out
;

508 i‡(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
])

509 
out
;

511 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
];

513 i‡(!
b
)

514 
out
;

516 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
,

517 
b
->
kobj
, 
«me
);

518 i‡(
îr
)

519 
out
;

521 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

522 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

524 
out
;

528 
b
 = 
	`kzÆloc
((
thªshﬁd_b™k
), 
GFP_KERNEL
);

529 i‡(!
b
) {

530 
îr
 = -
ENOMEM
;

531 
out
;

533 i‡(!
	`Æloc_˝umask_v¨
(&
b
->
˝us
, 
GFP_KERNEL
)) {

534 
	`k‰ì
(
b
);

535 
îr
 = -
ENOMEM
;

536 
out
;

539 
b
->
kobj
 = 
	`kobje˘_¸óã_™d_add
(
«me
, &
	`≥r_˝u
(
m˚_dev
, 
˝u
).kobj);

540 i‡(!
b
->
kobj
)

541 
out_‰ì
;

543 #i‚de‡
CONFIG_SMP


544 
	`˝umask_£èŒ
(
b
->
˝us
);

546 
	`˝umask_c›y
(
b
->
˝us
, 
c
->
Œc_sh¨ed_m≠
);

549 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
b
;

551 
îr
 = 
	`loˇl_Æloˇã_thªshﬁd_blocks
(
˝u
, 
b™k
);

552 i‡(
îr
)

553 
out_‰ì
;

555 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

556 i‡(
i
 =
˝u
)

559 
îr
 = 
	`sysfs_¸óã_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
,

560 
b
->
kobj
, 
«me
);

561 i‡(
îr
)

562 
out
;

564 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
b
;

567 
out
;

569 
out_‰ì
:

570 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

571 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

572 
	`k‰ì
(
b
);

573 
out
:

574  
îr
;

575 
	}
}

578 
__˝uöô
 
	$thªshﬁd_¸óã_devi˚
(
˝u
)

580 
b™k
;

581 
îr
 = 0;

583 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

584 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

586 
îr
 = 
	`thªshﬁd_¸óã_b™k
(
˝u
, 
b™k
);

587 i‡(
îr
)

588 
out
;

590 
out
:

591  
îr
;

592 
	}
}

600 
	$dóŒoˇã_thªshﬁd_block
(
˝u
,

601 
b™k
)

603 
thªshﬁd_block
 *
pos
 = 
NULL
;

604 
thªshﬁd_block
 *
tmp
 = 
NULL
;

605 
thªshﬁd_b™k
 *
hód
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

607 i‡(!
hód
)

610 
	`li°_f‹_óch_íåy_ß„
(
pos
, 
tmp
, &
hód
->
blocks
->
miscj
, miscj) {

611 
	`kobje˘_put
(&
pos
->
kobj
);

612 
	`li°_dñ
(&
pos
->
miscj
);

613 
	`k‰ì
(
pos
);

616 
	`k‰ì
(
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
);

617 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
]->
blocks
 = 
NULL
;

618 
	}
}

620 
	$thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
)

622 
thªshﬁd_b™k
 *
b
;

623 
«me
[32];

624 
i
 = 0;

626 
b
 = 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
];

627 i‡(!
b
)

629 i‡(!
b
->
blocks
)

630 
‰ì_out
;

632 
	`•rötf
(
«me
, "thªshﬁd_b™k%i", 
b™k
);

634 #ifde‡
CONFIG_SMP


636 i‡(
sh¨ed_b™k
[
b™k
] && 
b
->
blocks
->
˝u
 != cpu) {

637 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
˝u
).
kobj
, 
«me
);

638 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

645 
	`f‹_óch_˝u
(
i
, 
b
->
˝us
) {

646 i‡(
i
 =
˝u
)

649 
	`sysfs_ªmove_lök
(&
	`≥r_˝u
(
m˚_dev
, 
i
).
kobj
, 
«me
);

650 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
i
)[
b™k
] = 
NULL
;

653 
	`dóŒoˇã_thªshﬁd_block
(
˝u
, 
b™k
);

655 
‰ì_out
:

656 
	`kobje˘_dñ
(
b
->
kobj
);

657 
	`kobje˘_put
(
b
->
kobj
);

658 
	`‰ì_˝umask_v¨
(
b
->
˝us
);

659 
	`k‰ì
(
b
);

660 
	`≥r_˝u
(
thªshﬁd_b™ks
, 
˝u
)[
b™k
] = 
NULL
;

661 
	}
}

663 
	$thªshﬁd_ªmove_devi˚
(
˝u
)

665 
b™k
;

667 
b™k
 = 0; b™k < 
NR_BANKS
; ++bank) {

668 i‡(!(
	`≥r_˝u
(
b™k_m≠
, 
˝u
Ë& (1 << 
b™k
)))

670 
	`thªshﬁd_ªmove_b™k
(
˝u
, 
b™k
);

672 
	}
}

675 
__˝uöô


676 
	$amd_64_thªshﬁd_˝u_ˇŒback
(
a˘i⁄
, 
˝u
)

678 
a˘i⁄
) {

679 
CPU_ONLINE
:

680 
CPU_ONLINE_FROZEN
:

681 
	`thªshﬁd_¸óã_devi˚
(
˝u
);

683 
CPU_DEAD
:

684 
CPU_DEAD_FROZEN
:

685 
	`thªshﬁd_ªmove_devi˚
(
˝u
);

690 
	}
}

692 
__öô
 
	$thªshﬁd_öô_devi˚
()

694 
l˝u
 = 0;

697 
	`f‹_óch_⁄löe_˝u
(
l˝u
) {

698 
îr
 = 
	`thªshﬁd_¸óã_devi˚
(
l˝u
);

700 i‡(
îr
)

701  
îr
;

703 
thªshﬁd_˝u_ˇŒback
 = 
amd_64_thªshﬁd_˝u_ˇŒback
;

706 
	}
}

707 
devi˚_öôˇŒ
(
thªshﬁd_öô_devi˚
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c

8 
	~<löux/gÂ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/öãºu±.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/sched.h
>

13 
	~<asm/≠ic.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/m§.h
>

16 
	~<asm/m˚.h
>

25 
DEFINE_PER_CPU
(
m˚_b™ks_t
, 
m˚_b™ks_ow√d
);

31 
DEFINE_SPINLOCK
(
cmci_discovî_lock
);

33 
	#CMCI_THRESHOLD
 1

	)

35 
	$cmci_suµ‹ãd
(*
b™ks
)

37 
u64
 
ˇp
;

39 i‡(
m˚_cmci_dißbÀd
 || 
m˚_ign‹e_˚
)

47 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
)

49 i‡(!
˝u_has_≠ic
 || 
	`œpic_gë_maxlvt
() < 6)

51 
	`rdm§l
(
MSR_IA32_MCG_CAP
, 
ˇp
);

52 *
b™ks
 = 
	`mö_t
(, 
MAX_NR_BANKS
, 
ˇp
 & 0xff);

53  !!(
ˇp
 & 
MCG_CMCI_P
);

54 
	}
}

62 
	$öãl_thªshﬁd_öãºu±
()

64 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

65 
	`m˚_nŸify_úq
();

66 
	}
}

68 
	$¥öt_upd©e
(*
ty≥
, *
hdr
, 
num
)

70 i‡(*
hdr
 == 0)

71 
	`¥ötk
(
KERN_INFO
 "CPU %d MCA b™ks", 
	`smp_¥o˚ss‹_id
());

72 *
hdr
 = 1;

73 
	`¥ötk
(
KERN_CONT
 " %s:%d", 
ty≥
, 
num
);

74 
	}
}

81 
	$cmci_discovî
(
b™ks
, 
boŸ
)

83 *
ow√d
 = (*)&
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
);

84 
Êags
;

85 
hdr
 = 0;

86 
i
;

88 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

89 
i
 = 0; i < 
b™ks
; i++) {

90 
u64
 
vÆ
;

92 i‡(
	`ã°_bô
(
i
, 
ow√d
))

95 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

98 i‡(
vÆ
 & 
CMCI_EN
) {

99 i‡(
	`ã°_™d_˛ór_bô
(
i
, 
ow√d
Ë&& !
boŸ
)

100 
	`¥öt_upd©e
("SHD", &
hdr
, 
i
);

101 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

105 
vÆ
 |
CMCI_EN
 | 
CMCI_THRESHOLD
;

106 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

107 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

110 i‡(
vÆ
 & 
CMCI_EN
) {

111 i‡(!
	`ã°_™d_£t_bô
(
i
, 
ow√d
Ë&& !
boŸ
)

112 
	`¥öt_upd©e
("CMCI", &
hdr
, 
i
);

113 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
));

115 
	`WARN_ON
(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_pﬁl_b™ks
)));

118 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

119 i‡(
hdr
)

120 
	`¥ötk
(
KERN_CONT
 "\n");

121 
	}
}

127 
	$cmci_ªcheck
()

129 
Êags
;

130 
b™ks
;

132 i‡(!
	`m˚_avaûabÀ
(&
cuºít_˝u_d©a
Ë|| !
	`cmci_suµ‹ãd
(&
b™ks
))

134 
	`loˇl_úq_ßve
(
Êags
);

135 
	`machöe_check_pﬁl
(
MCP_TIMESTAMP
, &
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

136 
	`loˇl_úq_ª°‹e
(
Êags
);

137 
	}
}

143 
	$cmci_˛ór
()

145 
Êags
;

146 
i
;

147 
b™ks
;

148 
u64
 
vÆ
;

150 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

152 
	`•ö_lock_úqßve
(&
cmci_discovî_lock
, 
Êags
);

153 
i
 = 0; i < 
b™ks
; i++) {

154 i‡(!
	`ã°_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
)))

157 
	`rdm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

158 
vÆ
 &~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
);

159 
	`wrm§l
(
	`MSR_IA32_MCx_CTL2
(
i
), 
vÆ
);

160 
	`__˛ór_bô
(
i
, 
	`__gë_˝u_v¨
(
m˚_b™ks_ow√d
));

162 
	`•ö_u∆ock_úqª°‹e
(&
cmci_discovî_lock
, 
Êags
);

163 
	}
}

169 
	$cmci_ªdiscovî
(
dyög
)

171 
b™ks
;

172 
˝u
;

173 
˝umask_v¨_t
 
ﬁd
;

175 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

177 i‡(!
	`Æloc_˝umask_v¨
(&
ﬁd
, 
GFP_KERNEL
))

179 
	`˝umask_c›y
(
ﬁd
, &
cuºít
->
˝us_Ælowed
);

181 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

182 i‡(
˝u
 =
dyög
)

184 i‡(
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
˝u
)))

187 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

188 
	`cmci_discovî
(
b™ks
, 0);

191 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
ﬁd
);

192 
	`‰ì_˝umask_v¨
(
ﬁd
);

193 
	}
}

198 
	$cmci_ªíabÀ
()

200 
b™ks
;

201 i‡(
	`cmci_suµ‹ãd
(&
b™ks
))

202 
	`cmci_discovî
(
b™ks
, 0);

203 
	}
}

205 
	$öãl_öô_cmci
()

207 
b™ks
;

209 i‡(!
	`cmci_suµ‹ãd
(&
b™ks
))

212 
m˚_thªshﬁd_ve˘‹
 = 
öãl_thªshﬁd_öãºu±
;

213 
	`cmci_discovî
(
b™ks
, 1);

220 
	`≠ic_wrôe
(
APIC_LVTCMCI
, 
THRESHOLD_APIC_VECTOR
|
APIC_DM_FIXED
);

221 
	`cmci_ªcheck
();

222 
	}
}

224 
	$m˚_öãl_„©uª_öô
(
˝uöfo_x86
 *
c
)

226 
	`öãl_öô_thîmÆ
(
c
);

227 
	`öãl_öô_cmci
();

228 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c

16 
	~<löux/öãºu±.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/jiffõs.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/≥r˝u.h
>

21 
	~<löux/sysdev.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/˝u.h
>

27 
	~<asm/¥o˚ss‹.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/idÀ.h
>

31 
	~<asm/m˚.h
>

32 
	~<asm/m§.h
>

35 
	#CHECK_INTERVAL
 (300 * 
HZ
)

	)

40 
	sthîmÆ_°©e
 {

41 
boﬁ
 
	mis_thrŸéed
;

43 
u64
 
	m√xt_check
;

44 
	mthrŸée_cou¡
;

45 
	mœ°_thrŸée_cou¡
;

48 
DEFINE_PER_CPU
(
thîmÆ_°©e
,Åhermal_state);

50 
©omic_t
 
	gthîm_thrŸ_í
 = 
ATOMIC_INIT
(0);

52 
u32
 
lvâhmr_öô
 
	g__ªad_mo°ly
;

54 #ifde‡
CONFIG_SYSFS


55 
	#deföe_thîm_thrŸ_sysdev_⁄e_ro
(
_«me
) \

56 
	`SYSDEV_ATTR
(
_«me
, 0444, 
thîm_thrŸ_sysdev_show_
##_«me, 
NULL
)

	)

58 
	#deföe_thîm_thrŸ_sysdev_show_func
(
«me
) \

60 
ssize_t
 
thîm_thrŸ_sysdev_show_
##
	`«me
( \

61 
sys_devi˚
 *
dev
, \

62 
sysdev_©åibuã
 *
©å
, \

63 *
buf
) \

65 
˝u
 = 
dev
->
id
; \

66 
ssize_t
 
ªt
; \

68 
	`¥ìm±_dißbÀ
(); \

69 i‡(
	`˝u_⁄löe
(
˝u
)) \

70 
ªt
 = 
	`•rötf
(
buf
, "%lu\n", \

71 
	`≥r_˝u
(
thîmÆ_°©e
, 
˝u
).
«me
); \

73 
ªt
 = 0; \

74 
	`¥ìm±_íabÀ
(); \

76  
ªt
; \

77 }

	)

79 
deföe_thîm_thrŸ_sysdev_show_func
(
thrŸée_cou¡
);

80 
deföe_thîm_thrŸ_sysdev_⁄e_ro
(
thrŸée_cou¡
);

82 
©åibuã
 *
	gthîmÆ_thrŸée_©ås
[] = {

83 &
©å_thrŸée_cou¡
.
©å
,

84 
NULL


87 
©åibuã_group
 
	gthîmÆ_thrŸée_©å_group
 = {

88 .
©ås
 = 
thîmÆ_thrŸée_©ås
,

89 .
	g«me
 = "thermal_throttle"

109 
	$thîm_thrŸ_¥o˚ss
(
boﬁ
 
is_thrŸéed
)

111 
thîmÆ_°©e
 *
°©e
;

112 
this_˝u
;

113 
boﬁ
 
was_thrŸéed
;

114 
u64
 
now
;

116 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

117 
now
 = 
	`gë_jiffõs_64
();

118 
°©e
 = &
	`≥r_˝u
(
thîmÆ_°©e
, 
this_˝u
);

120 
was_thrŸéed
 = 
°©e
->
is_thrŸéed
;

121 
°©e
->
is_thrŸéed
 = is_throttled;

123 i‡(
is_thrŸéed
)

124 
°©e
->
thrŸée_cou¡
++;

126 i‡(
	`time_bef‹e64
(
now
, 
°©e
->
√xt_check
) &&

127 
°©e
->
thrŸée_cou¡
 !°©e->
œ°_thrŸée_cou¡
)

130 
°©e
->
√xt_check
 = 
now
 + 
CHECK_INTERVAL
;

131 
°©e
->
œ°_thrŸée_cou¡
 = sèã->
thrŸée_cou¡
;

134 i‡(
is_thrŸéed
) {

135 
	`¥ötk
(
KERN_CRIT
 "CPU%d: Tem≥øtuªábovêthªshﬁd, cpu clockÅhrŸéed (tŸÆÉvít†%lu)\n", 
this_˝u
, 
°©e
->
thrŸée_cou¡
);

137 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

140 i‡(
was_thrŸéed
) {

141 
	`¥ötk
(
KERN_INFO
 "CPU%d: Tem≥øtuª/•ìdÇ‹mÆ\n", 
this_˝u
);

146 
	}
}

148 #ifde‡
CONFIG_SYSFS


150 
__˝uöô
 
	$thîmÆ_thrŸée_add_dev
(
sys_devi˚
 *
sys_dev
)

152  
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
,

153 &
thîmÆ_thrŸée_©å_group
);

154 
	}
}

156 
__˝uöô
 
	$thîmÆ_thrŸée_ªmove_dev
(
sys_devi˚
 *
sys_dev
)

158 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
thîmÆ_thrŸée_©å_group
);

159 
	}
}

162 
DEFINE_MUTEX
(
thîm_˝u_lock
);

165 
__˝uöô
 

166 
	$thîmÆ_thrŸée_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

167 
a˘i⁄
,

168 *
h˝u
)

170 
˝u
 = ()
h˝u
;

171 
sys_devi˚
 *
sys_dev
;

172 
îr
 = 0;

174 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

176 
a˘i⁄
) {

177 
CPU_UP_PREPARE
:

178 
CPU_UP_PREPARE_FROZEN
:

179 
	`muãx_lock
(&
thîm_˝u_lock
);

180 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
sys_dev
);

181 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

182 
	`WARN_ON
(
îr
);

184 
CPU_UP_CANCELED
:

185 
CPU_UP_CANCELED_FROZEN
:

186 
CPU_DEAD
:

187 
CPU_DEAD_FROZEN
:

188 
	`muãx_lock
(&
thîm_˝u_lock
);

189 
	`thîmÆ_thrŸée_ªmove_dev
(
sys_dev
);

190 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

193  
	`nŸifõr_‰om_î∫o
(
îr
);

194 
	}
}

196 
nŸifõr_block
 
thîmÆ_thrŸée_˝u_nŸifõr
 
	g__˝uöôd©a
 =

198 .
nŸifõr_ˇŒ
 = 
thîmÆ_thrŸée_˝u_ˇŒback
,

201 
__öô
 
	$thîmÆ_thrŸée_öô_devi˚
()

203 
˝u
 = 0;

204 
îr
;

206 i‡(!
	`©omic_ªad
(&
thîm_thrŸ_í
))

209 
	`ªgi°î_hŸ˝u_nŸifõr
(&
thîmÆ_thrŸée_˝u_nŸifõr
);

211 #ifde‡
CONFIG_HOTPLUG_CPU


212 
	`muãx_lock
(&
thîm_˝u_lock
);

215 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

216 
îr
 = 
	`thîmÆ_thrŸée_add_dev
(
	`gë_˝u_sysdev
(
˝u
));

217 
	`WARN_ON
(
îr
);

219 #ifde‡
CONFIG_HOTPLUG_CPU


220 
	`muãx_u∆ock
(&
thîm_˝u_lock
);

224 
	}
}

225 
devi˚_öôˇŒ
(
thîmÆ_thrŸée_öô_devi˚
);

230 
	$öãl_thîmÆ_öãºu±
()

232 
__u64
 
m§_vÆ
;

234 
	`rdm§l
(
MSR_IA32_THERM_STATUS
, 
m§_vÆ
);

235 i‡(
	`thîm_thrŸ_¥o˚ss
((
m§_vÆ
 & 
THERM_STATUS_PROCHOT
) != 0))

236 
	`m˚_log_thîm_thrŸ_evít
(
m§_vÆ
);

237 
	}
}

239 
	$u√x≥˘ed_thîmÆ_öãºu±
()

241 
	`¥ötk
(
KERN_ERR
 "CPU%d: Unexpected LVT TMR interrupt!\n",

242 
	`smp_¥o˚ss‹_id
());

243 
	`add_èöt
(
TAINT_MACHINE_CHECK
);

244 
	}
}

246 (*
smp_thîmÆ_ve˘‹
)(Ë
u√x≥˘ed_thîmÆ_öãºu±
;

248 
asmlökage
 
	$smp_thîmÆ_öãºu±
(
±_ªgs
 *
ªgs
)

250 
	`exô_idÀ
();

251 
	`úq_íãr
();

252 
	`öc_úq_°©
(
úq_thîmÆ_cou¡
);

253 
	`smp_thîmÆ_ve˘‹
();

254 
	`úq_exô
();

256 
	`ack_APIC_úq
();

257 
	}
}

260 
	$öãl_thîmÆ_suµ‹ãd
(
˝uöfo_x86
 *
c
)

262 i‡(!
˝u_has_≠ic
)

264 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_ACPI
Ë|| !˝u_has(c, 
X86_FEATURE_ACC
))

267 
	}
}

269 
__öô
 
	$mcheck_öãl_thîm_öô
()

276 i‡(
	`öãl_thîmÆ_suµ‹ãd
(&
boŸ_˝u_d©a
))

277 
lvâhmr_öô
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

278 
	}
}

280 
	$öãl_öô_thîmÆ
(
˝uöfo_x86
 *
c
)

282 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
tm2
 = 0;

284 
u32
 
l
, 
h
;

286 i‡(!
	`öãl_thîmÆ_suµ‹ãd
(
c
))

294 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

305 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
lvâhmr_öô
);

307 
h
 = 
lvâhmr_öô
;

309 i‡((
l
 & 
MSR_IA32_MISC_ENABLE_TM1
Ë&& (
h
 & 
APIC_DM_SMI
)) {

310 
	`¥ötk
(
KERN_DEBUG


311 "CPU%d: ThîmÆ m⁄ô‹ög h™dÀd by SMI\n", 
˝u
);

316 i‡(
h
 & 
APIC_VECTOR_MASK
) {

317 
	`¥ötk
(
KERN_DEBUG


319 
˝u
, (
h
 & 
APIC_VECTOR_MASK
));

324 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TM2
)) {

325 i‡(
c
->
x86
 =6 && (c->
x86_modñ
 == 9 || c->x86_model == 13)) {

326 
	`rdm§
(
MSR_THERM2_CTL
, 
l
, 
h
);

327 i‡(
l
 & 
MSR_THERM2_CTL_TM_SELECT
)

328 
tm2
 = 1;

329 } i‡(
l
 & 
MSR_IA32_MISC_ENABLE_TM2
)

330 
tm2
 = 1;

334 
h
 = 
THERMAL_APIC_VECTOR
 | 
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
;

335 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
h
);

337 
	`rdm§
(
MSR_IA32_THERM_INTERRUPT
, 
l
, 
h
);

338 
	`wrm§
(
MSR_IA32_THERM_INTERRUPT
,

339 
l
 | (
THERM_INT_LOW_ENABLE
 | 
THERM_INT_HIGH_ENABLE
), 
h
);

341 
smp_thîmÆ_ve˘‹
 = 
öãl_thîmÆ_öãºu±
;

343 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
l
, 
h
);

344 
	`wrm§
(
MSR_IA32_MISC_ENABLE
, 
l
 | 
MSR_IA32_MISC_ENABLE_TM1
, 
h
);

347 
l
 = 
	`≠ic_ªad
(
APIC_LVTTHMR
);

348 
	`≠ic_wrôe
(
APIC_LVTTHMR
, 
l
 & ~
APIC_LVT_MASKED
);

350 
	`¥ötk_⁄˚
(
KERN_INFO
 "CPU0: Thermal monitoringÉnabled (%s)\n",

351 
tm2
 ? "TM2" : "TM1");

354 
	`©omic_£t
(&
thîm_thrŸ_í
, 1);

355 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c

4 
	~<löux/öãºu±.h
>

5 
	~<löux/kî√l.h
>

7 
	~<asm/úq_ve˘‹s.h
>

8 
	~<asm/≠ic.h
>

9 
	~<asm/idÀ.h
>

10 
	~<asm/m˚.h
>

12 
	$deÁu…_thªshﬁd_öãºu±
()

14 
	`¥ötk
(
KERN_ERR
 "UnexpectedÅhreshold interruptát vector %x\n",

15 
THRESHOLD_APIC_VECTOR
);

16 
	}
}

18 (*
m˚_thªshﬁd_ve˘‹
)(Ë
deÁu…_thªshﬁd_öãºu±
;

20 
asmlökage
 
	$smp_thªshﬁd_öãºu±
()

22 
	`exô_idÀ
();

23 
	`úq_íãr
();

24 
	`öc_úq_°©
(
úq_thªshﬁd_cou¡
);

25 
	`m˚_thªshﬁd_ve˘‹
();

26 
	`úq_exô
();

28 
	`ack_APIC_úq
();

29 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mshyperv.c

13 
	~<löux/ty≥s.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<asm/¥o˚ss‹.h
>

16 
	~<asm/hy≥rvis‹.h
>

17 
	~<asm/hy≥rv.h
>

18 
	~<asm/mshy≥rv.h
>

20 
ms_hy≥rv_öfo
 
	gms_hy≥rv
;

22 
boﬁ
 
__öô
 
	$ms_hy≥rv_∂©f‹m
()

24 
u32
 
óx
;

25 
u32
 
hyp_sig«tuª
[3];

27 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_HYPERVISOR
))

28  
Ál£
;

30 
	`˝uid
(
HYPERV_CPUID_VENDOR_AND_MAX_FUNCTIONS
,

31 &
óx
, &
hyp_sig«tuª
[0], &hyp_signature[1], &hyp_signature[2]);

33  
óx
 >
HYPERV_CPUID_MIN
 &&

34 
óx
 <
HYPERV_CPUID_MAX
 &&

35 !
	`memcmp
("Mi¸oso· Hv", 
hyp_sig«tuª
, 12);

36 
	}
}

38 
__öô
 
	$ms_hy≥rv_öô_∂©f‹m
()

43 
ms_hy≥rv
.
„©uªs
 = 
	`˝uid_óx
(
HYPERV_CPUID_FEATURES
);

44 
ms_hy≥rv
.
höts
 = 
	`˝uid_óx
(
HYPERV_CPUID_ENLIGHTMENT_INFO
);

46 
	`¥ötk
(
KERN_INFO
 "HyperV: features 0x%x, hints 0x%x\n",

47 
ms_hy≥rv
.
„©uªs
, ms_hy≥rv.
höts
);

48 
	}
}

50 c⁄° 
__ªfc⁄°
 
hy≥rvis‹_x86
 
	gx86_hy≥r_ms_hy≥rv
 = {

51 .
«me
 = "Microsoft HyperV",

52 .
	gdëe˘
 = 
ms_hy≥rv_∂©f‹m
,

53 .
	göô_∂©f‹m
 = 
ms_hy≥rv_öô_∂©f‹m
,

55 
EXPORT_SYMBOL
(
x86_hy≥r_ms_hy≥rv
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/˝u.h
>

25 
	~<löux/muãx.h
>

26 
	~<löux/uac˚ss.h
>

27 
	~<löux/kvm_∑ø.h
>

28 
	~<löux/ønge.h
>

30 
	~<asm/¥o˚ss‹.h
>

31 
	~<asm/e820.h
>

32 
	~<asm/mår.h
>

33 
	~<asm/m§.h
>

35 
	~"mår.h
"

37 
	sv¨_mår_ønge_°©e
 {

38 
	mba£_p‚
;

39 
	msize_p‚
;

40 
mår_ty≥
 
	mty≥
;

43 
	sv¨_mår_°©e
 {

44 
	mønge_°¨tk
;

45 
	mønge_sizek
;

46 
	mchunk_sizek
;

47 
	mgøn_sizek
;

48 
	mªg
;

52 
	#RANGE_NUM
 256

	)

54 
ønge
 
__öôd©a
 
	gønge
[
RANGE_NUM
];

55 
__öôd©a
 
	gƒ_ønge
;

57 
v¨_mår_ønge_°©e
 
__öôd©a
 
	gønge_°©e
[
RANGE_NUM
];

59 
__öôd©a
 
	gdebug_¥öt
;

60 
	#D¥ötk
(
x
...Ëdÿ{ i‡(
debug_¥öt
Ë
	`¥ötk
(
KERN_DEBUG
 x); } 0)

	)

62 
	#BIOS_BUG_MSG
 
KERN_WARNING
 \

63 "WARNING: BIOS bug: VAR MTRR %d c⁄èö†°øngêUCÉ¡ry undî 1M, check wôh you∏sy°em víd‹!\n"

	)

65 
__öô


66 
	$x86_gë_mår_mem_ønge
(
ønge
 *ønge, 
ƒ_ønge
,

67 
exåa_ªmove_ba£
,

68 
exåa_ªmove_size
)

70 
ba£
, 
size
;

71 
mår_ty≥
 
ty≥
;

72 
i
;

74 
i
 = 0; i < 
num_v¨_ønges
; i++) {

75 
ty≥
 = 
ønge_°©e
[
i
].type;

76 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

78 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

79 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

80 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
, 
RANGE_NUM
,Çr_range,

81 
ba£
, ba£ + 
size
);

83 i‡(
debug_¥öt
) {

84 
	`¥ötk
(
KERN_DEBUG
 "After WB checking\n");

85 
i
 = 0; i < 
ƒ_ønge
; i++)

86 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

87 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

91 
i
 = 0; i < 
num_v¨_ønges
; i++) {

92 
ty≥
 = 
ønge_°©e
[
i
].type;

93 i‡(
ty≥
 !
MTRR_TYPE_UNCACHABLE
 &&

94 
ty≥
 !
MTRR_TYPE_WRPROT
)

96 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

97 i‡(!
size
)

99 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

100 i‡(
ba£
 < (1<<(20-
PAGE_SHIFT
)Ë&& 
mår_°©e
.
have_fixed
 &&

101 (
mår_°©e
.
íabÀd
 & 1)) {

103 
	`¥ötk
(
BIOS_BUG_MSG
, 
i
);

104 i‡(
ba£
 + 
size
 <(1<<(20-
PAGE_SHIFT
)))

106 
size
 -(1<<(20-
PAGE_SHIFT
)Ë- 
ba£
;

107 
ba£
 = 1<<(20-
PAGE_SHIFT
);

109 
	`subåa˘_ønge
(
ønge
, 
RANGE_NUM
, 
ba£
, ba£ + 
size
);

111 i‡(
exåa_ªmove_size
)

112 
	`subåa˘_ønge
(
ønge
, 
RANGE_NUM
, 
exåa_ªmove_ba£
,

113 
exåa_ªmove_ba£
 + 
exåa_ªmove_size
);

115 i‡(
debug_¥öt
) {

116 
	`¥ötk
(
KERN_DEBUG
 "After UC checking\n");

117 
i
 = 0; i < 
RANGE_NUM
; i++) {

118 i‡(!
ønge
[
i
].
íd
)

120 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

121 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

126 
ƒ_ønge
 = 
	`˛ón_s‹t_ønge
(
ønge
, 
RANGE_NUM
);

127 i‡(
debug_¥öt
) {

128 
	`¥ötk
(
KERN_DEBUG
 "After sorting\n");

129 
i
 = 0; i < 
ƒ_ønge
; i++)

130 
	`¥ötk
(
KERN_DEBUG
 "MTRR MAP PFN: %016llx - %016llx\n",

131 
ønge
[
i
].
°¨t
,Ñ™ge[i].
íd
);

134  
ƒ_ønge
;

135 
	}
}

137 #ifde‡
CONFIG_MTRR_SANITIZER


139 
__öô
 
	$sum_ønges
(
ønge
 *ønge, 
ƒ_ønge
)

141 
sum
 = 0;

142 
i
;

144 
i
 = 0; i < 
ƒ_ønge
; i++)

145 
sum
 +
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
;

147  
sum
;

148 
	}
}

150 
íabÀ_mår_˛ónup
 
	g__öôd©a
 =

151 
CONFIG_MTRR_SANITIZER_ENABLE_DEFAULT
;

153 
__öô
 
	$dißbÀ_mår_˛ónup_£tup
(*
°r
)

155 
íabÀ_mår_˛ónup
 = 0;

157 
	}
}

158 
óæy_∑øm
("dißbÀ_mår_˛ónup", 
dißbÀ_mår_˛ónup_£tup
);

160 
__öô
 
	$íabÀ_mår_˛ónup_£tup
(*
°r
)

162 
íabÀ_mår_˛ónup
 = 1;

164 
	}
}

165 
óæy_∑øm
("íabÀ_mår_˛ónup", 
íabÀ_mår_˛ónup_£tup
);

167 
__öô
 
	$mår_˛ónup_debug_£tup
(*
°r
)

169 
debug_¥öt
 = 1;

171 
	}
}

172 
óæy_∑øm
("mår_˛ónup_debug", 
mår_˛ónup_debug_£tup
);

174 
__öô


175 
	$£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

176 
ty≥
, 
addªss_bôs
)

178 
u32
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

179 
u64
 
ba£
, 
mask
;

181 i‡(!
sizek
) {

182 
	`fûl_mår_v¨_ønge
(
ªg
, 0, 0, 0, 0);

186 
mask
 = (1ULL << 
addªss_bôs
) - 1;

187 
mask
 &~((((
u64
)
sizek
) << 10) - 1);

189 
ba£
 = ((
u64
)
ba£k
) << 10;

191 
ba£
 |
ty≥
;

192 
mask
 |= 0x800;

194 
ba£_lo
 = 
ba£
 & ((1ULL<<32) - 1);

195 
ba£_hi
 = 
ba£
 >> 32;

197 
mask_lo
 = 
mask
 & ((1ULL<<32) - 1);

198 
mask_hi
 = 
mask
 >> 32;

200 
	`fûl_mår_v¨_ønge
(
ªg
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
);

201 
	}
}

203 
__öô


204 
	$ßve_v¨_mår
(
ªg
, 
ba£k
, 
sizek
,

205 
ty≥
)

207 
ønge_°©e
[
ªg
].
ba£_p‚
 = 
ba£k
 >> (
PAGE_SHIFT
 - 10);

208 
ønge_°©e
[
ªg
].
size_p‚
 = 
sizek
 >> (
PAGE_SHIFT
 - 10);

209 
ønge_°©e
[
ªg
].
ty≥
 =Åype;

210 
	}
}

212 
__öô
 
	$£t_v¨_mår_Æl
(
addªss_bôs
)

214 
ba£k
, 
sizek
;

215 
ty≥
;

216 
ªg
;

218 
ªg
 = 0;Ñeg < 
num_v¨_ønges
;Ñeg++) {

219 
ba£k
 = 
ønge_°©e
[
ªg
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

220 
sizek
 = 
ønge_°©e
[
ªg
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

221 
ty≥
 = 
ønge_°©e
[
ªg
].type;

223 
	`£t_v¨_mår
(
ªg
, 
ba£k
, 
sizek
, 
ty≥
, 
addªss_bôs
);

225 
	}
}

227 
	$to_size_Á˘‹
(
sizek
, *
Á˘‹p
)

229 
ba£
 = 
sizek
;

230 
Á˘‹
;

232 i‡(
ba£
 & ((1<<10) - 1)) {

234 
Á˘‹
 = 'K';

235 } i‡(
ba£
 & ((1<<20) - 1)) {

236 
Á˘‹
 = 'M';

237 
ba£
 >>= 10;

239 
Á˘‹
 = 'G';

240 
ba£
 >>= 20;

243 *
Á˘‹p
 = 
Á˘‹
;

245  
ba£
;

246 
	}
}

248 
__öô


249 
	$ønge_to_mår
(
ªg
, 
ønge_°¨tk
,

250 
ønge_sizek
, 
ty≥
)

252 i‡(!
ønge_sizek
 || (
ªg
 >
num_v¨_ønges
))

253  
ªg
;

255 
ønge_sizek
) {

256 
max_Æign
, 
Æign
;

257 
sizek
;

260 i‡(
ønge_°¨tk
)

261 
max_Æign
 = 
	`ffs
(
ønge_°¨tk
) - 1;

263 
max_Æign
 = 32;

265 
Æign
 = 
	`Ês
(
ønge_sizek
) - 1;

266 i‡(
Æign
 > 
max_Æign
)

267 
Æign
 = 
max_Æign
;

269 
sizek
 = 1 << 
Æign
;

270 i‡(
debug_¥öt
) {

271 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

272 
°¨t_ba£
, 
size_ba£
;

274 
°¨t_ba£
 = 
	`to_size_Á˘‹
(
ønge_°¨tk
, &
°¨t_Á˘‹
);

275 
size_ba£
 = 
	`to_size_Á˘‹
(
sizek
, &
size_Á˘‹
);

277 
	`D¥ötk
("Setting variable MTRR %d, "

279 
ªg
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

280 
size_ba£
, 
size_Á˘‹
,

281 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

282 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other")

285 
	`ßve_v¨_mår
(
ªg
++, 
ønge_°¨tk
, 
sizek
, 
ty≥
);

286 
ønge_°¨tk
 +
sizek
;

287 
ønge_sizek
 -
sizek
;

288 i‡(
ªg
 >
num_v¨_ønges
)

291  
ªg
;

292 
	}
}

294 
__öô


295 
	$ønge_to_mår_wôh_hﬁe
(
v¨_mår_°©e
 *
°©e
, 
ba£k
,

296 
sizek
)

298 
hﬁe_ba£k
, 
hﬁe_sizek
;

299 
£c⁄d_ba£k
, 
£c⁄d_sizek
;

300 
ønge0_ba£k
, 
ønge0_sizek
;

301 
ønge_ba£k
, 
ønge_sizek
;

302 
chunk_sizek
;

303 
gøn_sizek
;

305 
hﬁe_ba£k
 = 0;

306 
hﬁe_sizek
 = 0;

307 
£c⁄d_ba£k
 = 0;

308 
£c⁄d_sizek
 = 0;

309 
chunk_sizek
 = 
°©e
->chunk_sizek;

310 
gøn_sizek
 = 
°©e
->gran_sizek;

313 
ønge_ba£k
 = 
	`ALIGN
(
°©e
->
ønge_°¨tk
, 
gøn_sizek
);

314 i‡((
ønge_ba£k
 > 
ba£k
) && basek)

315  
£c⁄d_sizek
;

317 
°©e
->
ønge_sizek
 -(
ønge_ba£k
 - sèã->
ønge_°¨tk
);

318 
ønge_sizek
 = 
	`ALIGN
(
°©e
->ønge_sizek, 
gøn_sizek
);

320 
ønge_sizek
 > 
°©e
->range_sizek) {

321 
ønge_sizek
 -
gøn_sizek
;

322 i‡(!
ønge_sizek
)

325 
°©e
->
ønge_sizek
 =Ñange_sizek;

328 
ønge0_ba£k
 = 
°©e
->
ønge_°¨tk
;

329 
ønge0_sizek
 = 
	`ALIGN
(
°©e
->
ønge_sizek
, 
chunk_sizek
);

332 i‡(
ønge0_sizek
 =
°©e
->
ønge_sizek
) {

333 
	`D¥ötk
("rangeX: %016lx - %016lx\n",

334 
ønge0_ba£k
<<10,

335 (
ønge0_ba£k
 + 
°©e
->
ønge_sizek
)<<10);

336 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

337 
°©e
->
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

342 i‡(
sizek
) {

343 
ønge0_ba£k
 + 
ønge0_sizek
 > (
ba£k
 + 
sizek
)) {

344 i‡(
ønge0_sizek
 >
chunk_sizek
)

345 
ønge0_sizek
 -
chunk_sizek
;

347 
ønge0_sizek
 = 0;

349 i‡(!
ønge0_sizek
)

354 
£c⁄d_åy
:

355 
ønge_ba£k
 = 
ønge0_ba£k
 + 
ønge0_sizek
;

358 i‡(
ønge_ba£k
 > 
ba£k
 &&Ñ™ge_ba£k <(ba£k + 
sizek
))

359 
£c⁄d_sizek
 = 
ønge_ba£k
 - 
ba£k
;

361 i‡(
ønge0_sizek
 > 
°©e
->
ønge_sizek
) {

364 
hﬁe_sizek
 = 
ønge0_sizek
 - 
°©e
->
ønge_sizek
 - 
£c⁄d_sizek
;

367 i‡(
hﬁe_sizek
 >(
ønge0_sizek
 >> 1) &&

368 
ønge0_sizek
 >
chunk_sizek
) {

369 
ønge0_sizek
 -
chunk_sizek
;

370 
£c⁄d_sizek
 = 0;

371 
hﬁe_sizek
 = 0;

373 
£c⁄d_åy
;

377 i‡(
ønge0_sizek
) {

378 
	`D¥ötk
("range0: %016lx - %016lx\n",

379 
ønge0_ba£k
<<10,

380 (
ønge0_ba£k
 + 
ønge0_sizek
)<<10);

381 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge0_ba£k
,

382 
ønge0_sizek
, 
MTRR_TYPE_WRBACK
);

385 i‡(
ønge0_sizek
 < 
°©e
->
ønge_sizek
) {

387 
ønge_sizek
 = 
°©e
->ønge_sizek - 
ønge0_sizek
;

389 
	`D¥ötk
("range: %016lx - %016lx\n",

390 
ønge_ba£k
<<10,

391 (
ønge_ba£k
 + 
ønge_sizek
)<<10);

393 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
ønge_ba£k
,

394 
ønge_sizek
, 
MTRR_TYPE_WRBACK
);

397 i‡(
hﬁe_sizek
) {

398 
hﬁe_ba£k
 = 
ønge_ba£k
 - 
hﬁe_sizek
 - 
£c⁄d_sizek
;

399 
	`D¥ötk
("hole: %016lx - %016lx\n",

400 
hﬁe_ba£k
<<10,

401 (
hﬁe_ba£k
 + 
hﬁe_sizek
)<<10);

402 
°©e
->
ªg
 = 
	`ønge_to_mår
(°©e->ªg, 
hﬁe_ba£k
,

403 
hﬁe_sizek
, 
MTRR_TYPE_UNCACHABLE
);

406  
£c⁄d_sizek
;

407 
	}
}

409 
__öô


410 
	$£t_v¨_mår_ønge
(
v¨_mår_°©e
 *
°©e
, 
ba£_p‚
,

411 
size_p‚
)

413 
ba£k
, 
sizek
;

414 
£c⁄d_sizek
 = 0;

416 i‡(
°©e
->
ªg
 >
num_v¨_ønges
)

419 
ba£k
 = 
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

420 
sizek
 = 
size_p‚
 << (
PAGE_SHIFT
 - 10);

423 i‡((
ba£k
 <= 1024) ||

424 (
°©e
->
ønge_°¨tk
 + sèã->
ønge_sizek
 =
ba£k
)) {

425 
ídk
 = 
ba£k
 + 
sizek
;

426 
°©e
->
ønge_sizek
 = 
ídk
 - sèã->
ønge_°¨tk
;

430 i‡(
°©e
->
ønge_sizek
 != 0)

431 
£c⁄d_sizek
 = 
	`ønge_to_mår_wôh_hﬁe
(
°©e
, 
ba£k
, 
sizek
);

434 
°©e
->
ønge_°¨tk
 = 
ba£k
 + 
£c⁄d_sizek
;

435 
°©e
->
ønge_sizek
 = 
sizek
 - 
£c⁄d_sizek
;

436 
	}
}

439 
u64
 
mår_chunk_size
 
	g__öôd©a
 = (256ULL<<20);

441 
__öô
 
	$∑r£_mår_chunk_size_›t
(*
p
)

443 i‡(!
p
)

444  -
EINVAL
;

445 
mår_chunk_size
 = 
	`mem∑r£
(
p
, &p);

447 
	}
}

448 
óæy_∑øm
("mår_chunk_size", 
∑r£_mår_chunk_size_›t
);

451 
u64
 
mår_gøn_size
 
	g__öôd©a
;

453 
__öô
 
	$∑r£_mår_gøn_size_›t
(*
p
)

455 i‡(!
p
)

456  -
EINVAL
;

457 
mår_gøn_size
 = 
	`mem∑r£
(
p
, &p);

459 
	}
}

460 
óæy_∑øm
("mår_gøn_size", 
∑r£_mår_gøn_size_›t
);

462 
ƒ_mår_•¨e_ªg
 
	g__öôd©a
 =

463 
CONFIG_MTRR_SANITIZER_SPARE_REG_NR_DEFAULT
;

465 
__öô
 
	$∑r£_mår_•¨e_ªg
(*
¨g
)

467 i‡(
¨g
)

468 
ƒ_mår_•¨e_ªg
 = 
	`sim∂e_°πoul
(
¨g
, 
NULL
, 0);

470 
	}
}

471 
óæy_∑øm
("mår_•¨e_ªg_ƒ", 
∑r£_mår_•¨e_ªg
);

473 
__öô


474 
	$x86_£tup_v¨_mårs
(
ønge
 *ønge, 
ƒ_ønge
,

475 
u64
 
chunk_size
, u64 
gøn_size
)

477 
v¨_mår_°©e
 
v¨_°©e
;

478 
num_ªg
;

479 
i
;

481 
v¨_°©e
.
ønge_°¨tk
 = 0;

482 
v¨_°©e
.
ønge_sizek
 = 0;

483 
v¨_°©e
.
ªg
 = 0;

484 
v¨_°©e
.
chunk_sizek
 = 
chunk_size
 >> 10;

485 
v¨_°©e
.
gøn_sizek
 = 
gøn_size
 >> 10;

487 
	`mem£t
(
ønge_°©e
, 0, (range_state));

490 
i
 = 0; i < 
ƒ_ønge
; i++) {

491 
	`£t_v¨_mår_ønge
(&
v¨_°©e
, 
ønge
[
i
].
°¨t
,

492 
ønge
[
i
].
íd
 -Ñ™ge[i].
°¨t
);

496 i‡(
v¨_°©e
.
ønge_sizek
 != 0)

497 
	`ønge_to_mår_wôh_hﬁe
(&
v¨_°©e
, 0, 0);

499 
num_ªg
 = 
v¨_°©e
.
ªg
;

501 
v¨_°©e
.
ªg
 < 
num_v¨_ønges
) {

502 
	`ßve_v¨_mår
(
v¨_°©e
.
ªg
, 0, 0, 0);

503 
v¨_°©e
.
ªg
++;

506  
num_ªg
;

507 
	}
}

509 
	smår_˛ónup_ªsu…
 {

510 
	mgøn_sizek
;

511 
	mchunk_sizek
;

512 
	mlo£_covî_sizek
;

513 
	mnum_ªg
;

514 
	mbad
;

522 
	#NUM_RESULT
 136

	)

523 
	#PSHIFT
 (
PAGE_SHIFT
 - 10)

	)

525 
mår_˛ónup_ªsu…
 
__öôd©a
 
	gªsu…
[
NUM_RESULT
];

526 
__öôd©a
 
	gmö_loss_p‚
[
RANGE_NUM
];

528 
__öô
 
	$¥öt_out_mår_ønge_°©e
()

530 
°¨t_Á˘‹
 = 'K', 
size_Á˘‹
 = 'K';

531 
°¨t_ba£
, 
size_ba£
;

532 
mår_ty≥
 
ty≥
;

533 
i
;

535 
i
 = 0; i < 
num_v¨_ønges
; i++) {

537 
size_ba£
 = 
ønge_°©e
[
i
].
size_p‚
 << (
PAGE_SHIFT
 - 10);

538 i‡(!
size_ba£
)

541 
size_ba£
 = 
	`to_size_Á˘‹
(size_ba£, &
size_Á˘‹
),

542 
°¨t_ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
 << (
PAGE_SHIFT
 - 10);

543 
°¨t_ba£
 = 
	`to_size_Á˘‹
(°¨t_ba£, &
°¨t_Á˘‹
),

544 
ty≥
 = 
ønge_°©e
[
i
].type;

546 
	`¥ötk
(
KERN_DEBUG
 "reg %d, base: %ld%cB,Ñange: %ld%cB,Åype %s\n",

547 
i
, 
°¨t_ba£
, 
°¨t_Á˘‹
,

548 
size_ba£
, 
size_Á˘‹
,

549 (
ty≥
 =
MTRR_TYPE_UNCACHABLE
) ? "UC" :

550 ((
ty≥
 =
MTRR_TYPE_WRPROT
) ? "WP" :

551 ((
ty≥
 =
MTRR_TYPE_WRBACK
) ? "WB" : "Other"))

554 
	}
}

556 
__öô
 
	$mår_√ed_˛ónup
()

558 
i
;

559 
mår_ty≥
 
ty≥
;

560 
size
;

562 
num
[
MTRR_NUM_TYPES
 + 1];

565 
	`mem£t
(
num
, 0, (num));

566 
i
 = 0; i < 
num_v¨_ønges
; i++) {

567 
ty≥
 = 
ønge_°©e
[
i
].type;

568 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

569 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

571 i‡(!
size
)

572 
ty≥
 = 
MTRR_NUM_TYPES
;

573 
num
[
ty≥
]++;

577 i‡(!
num
[
MTRR_TYPE_UNCACHABLE
])

581 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

582 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

586 
	}
}

588 
__öôd©a
 
	gønge_sums
;

590 
__öô


591 
	$mår_ˇlc_ønge_°©e
(
u64
 
chunk_size
, u64 
gøn_size
,

592 
x_ªmove_ba£
,

593 
x_ªmove_size
, 
i
)

595 
ønge
 
ønge_√w
[
RANGE_NUM
];

596 
ønge_sums_√w
;

597 
ƒ_ønge_√w
;

598 
num_ªg
;

601 
num_ªg
 = 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

604 
	`mem£t
(
ønge_√w
, 0, (range_new));

605 
ƒ_ønge_√w
 = 
	`x86_gë_mår_mem_ønge
(
ønge_√w
, 0,

606 
x_ªmove_ba£
, 
x_ªmove_size
);

607 
ønge_sums_√w
 = 
	`sum_ønges
(
ønge_√w
, 
ƒ_ønge_√w
);

609 
ªsu…
[
i
].
chunk_sizek
 = 
chunk_size
 >> 10;

610 
ªsu…
[
i
].
gøn_sizek
 = 
gøn_size
 >> 10;

611 
ªsu…
[
i
].
num_ªg
 =Çum_reg;

613 i‡(
ønge_sums
 < 
ønge_sums_√w
) {

614 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums_√w
 - 
ønge_sums
Ë<< 
PSHIFT
;

615 
ªsu…
[
i
].
bad
 = 1;

617 
ªsu…
[
i
].
lo£_covî_sizek
 = (
ønge_sums
 - 
ønge_sums_√w
Ë<< 
PSHIFT
;

621 i‡(!
ªsu…
[
i
].
bad
 && !ªsu…[i].
lo£_covî_sizek
) {

622 i‡(
ƒ_ønge_√w
 !
ƒ_ønge
 || 
	`memcmp
(
ønge
, 
ønge_√w
, (range)))

623 
ªsu…
[
i
].
bad
 = 1;

626 i‡(!
ªsu…
[
i
].
bad
 && (
ønge_sums
 - 
ønge_sums_√w
 < 
mö_loss_p‚
[
num_ªg
]))

627 
mö_loss_p‚
[
num_ªg
] = 
ønge_sums
 - 
ønge_sums_√w
;

628 
	}
}

630 
__öô
 
	$mår_¥öt_out_⁄e_ªsu…
(
i
)

632 
gøn_ba£
, 
chunk_ba£
, 
lo£_ba£
;

633 
gøn_Á˘‹
, 
chunk_Á˘‹
, 
lo£_Á˘‹
;

635 
gøn_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
gøn_sizek
, &
gøn_Á˘‹
),

636 
chunk_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
chunk_sizek
, &
chunk_Á˘‹
),

637 
lo£_ba£
 = 
	`to_size_Á˘‹
(
ªsu…
[
i
].
lo£_covî_sizek
, &
lo£_Á˘‹
),

639 
	`¥_öfo
("%sgran_size: %ld%c \tchunk_size: %ld%c \t",

640 
ªsu…
[
i
].
bad
 ? "*BAD*" : " ",

641 
gøn_ba£
, 
gøn_Á˘‹
, 
chunk_ba£
, 
chunk_Á˘‹
);

642 
	`¥_c⁄t
("num_reg: %d \tlose cover RAM: %s%ld%c\n",

643 
ªsu…
[
i
].
num_ªg
,Ñesu…[i].
bad
 ? "-" : "",

644 
lo£_ba£
, 
lo£_Á˘‹
);

645 
	}
}

647 
__öô
 
	$mår_£¨ch_›timÆ_ödex
()

649 
num_ªg_good
;

650 
ödex_good
;

651 
i
;

653 i‡(
ƒ_mår_•¨e_ªg
 >
num_v¨_ønges
)

654 
ƒ_mår_•¨e_ªg
 = 
num_v¨_ønges
 - 1;

656 
num_ªg_good
 = -1;

657 
i
 = 
num_v¨_ønges
 - 
ƒ_mår_•¨e_ªg
; i > 0; i--) {

658 i‡(!
mö_loss_p‚
[
i
])

659 
num_ªg_good
 = 
i
;

662 
ödex_good
 = -1;

663 i‡(
num_ªg_good
 != -1) {

664 
i
 = 0; i < 
NUM_RESULT
; i++) {

665 i‡(!
ªsu…
[
i
].
bad
 &&

666 
ªsu…
[
i
].
num_ªg
 =
num_ªg_good
 &&

667 !
ªsu…
[
i
].
lo£_covî_sizek
) {

668 
ödex_good
 = 
i
;

674  
ödex_good
;

675 
	}
}

677 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

679 
x_ªmove_ba£
, 
x_ªmove_size
;

680 
ba£
, 
size
, 
def
, 
dummy
;

681 
u64
 
chunk_size
, 
gøn_size
;

682 
mår_ty≥
 
ty≥
;

683 
ödex_good
;

684 
i
;

686 i‡(!
	`is_˝u
(
INTEL
Ë|| 
íabÀ_mår_˛ónup
 < 1)

689 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

690 
def
 &= 0xff;

691 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

695 
	`mem£t
(
ønge_°©e
, 0, (range_state));

696 
i
 = 0; i < 
num_v¨_ønges
; i++) {

697 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

698 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

699 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

700 
ønge_°©e
[
i
].
ty≥
 =Åype;

704 i‡(!
	`mår_√ed_˛ónup
())

708 
	`¥ötk
(
KERN_DEBUG
 "original variable MTRRs\n");

709 
	`¥öt_out_mår_ønge_°©e
();

711 
	`mem£t
(
ønge
, 0, (range));

712 
x_ªmove_size
 = 0;

713 
x_ªmove_ba£
 = 1 << (32 - 
PAGE_SHIFT
);

714 i‡(
mår_tom2
)

715 
x_ªmove_size
 = (
mår_tom2
 >> 
PAGE_SHIFT
Ë- 
x_ªmove_ba£
;

717 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
, 0, 
x_ªmove_ba£
, 
x_ªmove_size
);

722 
ƒ_ønge
 = 
	`add_ønge_wôh_mîge
(
ønge
, 
RANGE_NUM
,Çr_range, 0,

723 1ULL<<(20 - 
PAGE_SHIFT
));

725 
	`s‹t_ønge
(
ønge
, 
ƒ_ønge
);

727 
ønge_sums
 = 
	`sum_ønges
(
ønge
, 
ƒ_ønge
);

728 
	`¥ötk
(
KERN_INFO
 "total RAM covered: %ldM\n",

729 
ønge_sums
 >> (20 - 
PAGE_SHIFT
));

731 i‡(
mår_chunk_size
 && 
mår_gøn_size
) {

732 
i
 = 0;

733 
	`mår_ˇlc_ønge_°©e
(
mår_chunk_size
, 
mår_gøn_size
,

734 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

736 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

738 i‡(!
ªsu…
[
i
].
bad
) {

739 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

740 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

741 
	`¥öt_out_mår_ønge_°©e
();

744 
	`¥ötk
(
KERN_INFO
 "invalid mtrr_gran_size or mtrr_chunk_size, "

748 
i
 = 0;

749 
	`mem£t
(
mö_loss_p‚
, 0xff, (min_loss_pfn));

750 
	`mem£t
(
ªsu…
, 0, (result));

751 
gøn_size
 = (1ULL<<16); gran_size < (1ULL<<32); gran_size <<= 1) {

753 
chunk_size
 = 
gøn_size
; chunk_size < (1ULL<<32);

754 
chunk_size
 <<= 1) {

756 i‡(
i
 >
NUM_RESULT
)

759 
	`mår_ˇlc_ønge_°©e
(
chunk_size
, 
gøn_size
,

760 
x_ªmove_ba£
, 
x_ªmove_size
, 
i
);

761 i‡(
debug_¥öt
) {

762 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

763 
	`¥ötk
(
KERN_INFO
 "\n");

766 
i
++;

771 
ödex_good
 = 
	`mår_£¨ch_›timÆ_ödex
();

773 i‡(
ödex_good
 != -1) {

774 
	`¥ötk
(
KERN_INFO
 "Found optimal setting for mtrr clean up\n");

775 
i
 = 
ödex_good
;

776 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

779 
chunk_size
 = 
ªsu…
[
i
].
chunk_sizek
;

780 
chunk_size
 <<= 10;

781 
gøn_size
 = 
ªsu…
[
i
].
gøn_sizek
;

782 
gøn_size
 <<= 10;

783 
	`x86_£tup_v¨_mårs
(
ønge
, 
ƒ_ønge
, 
chunk_size
, 
gøn_size
);

784 
	`£t_v¨_mår_Æl
(
addªss_bôs
);

785 
	`¥ötk
(
KERN_DEBUG
 "New variable MTRRs\n");

786 
	`¥öt_out_mår_ønge_°©e
();

790 
i
 = 0; i < 
NUM_RESULT
; i++)

791 
	`mår_¥öt_out_⁄e_ªsu…
(
i
);

794 
	`¥ötk
(
KERN_INFO
 "mtrr_cleanup: canÇot find optimal value\n");

795 
	`¥ötk
(
KERN_INFO
 "please specify mtrr_gran_size/mtrr_chunk_size\n");

798 
	}
}

800 
__öô
 
	$mår_˛ónup
(
addªss_bôs
)

803 
	}
}

806 
	gdißbÀ_mår_åim
;

808 
__öô
 
	$dißbÀ_mår_åim_£tup
(*
°r
)

810 
dißbÀ_mår_åim
 = 1;

812 
	}
}

813 
óæy_∑øm
("dißbÀ_mår_åim", 
dißbÀ_mår_åim_£tup
);

821 
	#Tom2E«bÀd
 (1U << 21)

	)

822 
	#Tom2F‹˚MemTy≥WB
 (1U << 22)

	)

824 
__öô
 
	$amd_•ecül_deÁu…_mår
()

826 
u32
 
l
, 
h
;

828 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_AMD
)

830 i‡(
boŸ_˝u_d©a
.
x86
 < 0xf || boot_cpu_data.x86 > 0x11)

833 i‡(
	`rdm§_ß„
(
MSR_K8_SYSCFG
, &
l
, &
h
) < 0)

839 i‡((
l
 & (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
)) ==

840 (
Tom2E«bÀd
 | 
Tom2F‹˚MemTy≥WB
))

843 
	}
}

845 
u64
 
__öô


846 
	$ªÆ_åim_mem‹y
(
°¨t_p‚
, 
limô_p‚
)

848 
u64
 
åim_°¨t
, 
åim_size
;

850 
åim_°¨t
 = 
°¨t_p‚
;

851 
åim_°¨t
 <<
PAGE_SHIFT
;

853 
åim_size
 = 
limô_p‚
;

854 
åim_size
 <<
PAGE_SHIFT
;

855 
åim_size
 -
åim_°¨t
;

857  
	`e820_upd©e_ønge
(
åim_°¨t
, 
åim_size
, 
E820_RAM
, 
E820_RESERVED
);

858 
	}
}

871 
__öô
 
	$mår_åim_unˇched_mem‹y
(
íd_p‚
)

873 
i
, 
ba£
, 
size
, 
highe°_p‚
 = 0, 
def
, 
dummy
;

874 
mår_ty≥
 
ty≥
;

875 
u64
 
tŸÆ_åim_size
;

877 
num
[
MTRR_NUM_TYPES
 + 1];

883 i‡(!
	`is_˝u
(
INTEL
Ë|| 
dißbÀ_mår_åim
)

886 
	`rdm§
(
MSR_MTRRdefTy≥
, 
def
, 
dummy
);

887 
def
 &= 0xff;

888 i‡(
def
 !
MTRR_TYPE_UNCACHABLE
)

892 
	`mem£t
(
ønge_°©e
, 0, (range_state));

893 
i
 = 0; i < 
num_v¨_ønges
; i++) {

894 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

895 
ønge_°©e
[
i
].
ba£_p‚
 = 
ba£
;

896 
ønge_°©e
[
i
].
size_p‚
 = 
size
;

897 
ønge_°©e
[
i
].
ty≥
 =Åype;

901 
i
 = 0; i < 
num_v¨_ønges
; i++) {

902 
ty≥
 = 
ønge_°©e
[
i
].type;

903 i‡(
ty≥
 !
MTRR_TYPE_WRBACK
)

905 
ba£
 = 
ønge_°©e
[
i
].
ba£_p‚
;

906 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

907 i‡(
highe°_p‚
 < 
ba£
 + 
size
)

908 
highe°_p‚
 = 
ba£
 + 
size
;

912 i‡(!
highe°_p‚
) {

913 
	`¥ötk
(
KERN_INFO
 "CPU MTRRsáll blank - virtualized system.\n");

918 
	`mem£t
(
num
, 0, (num));

919 
i
 = 0; i < 
num_v¨_ønges
; i++) {

920 
ty≥
 = 
ønge_°©e
[
i
].type;

921 i‡(
ty≥
 >
MTRR_NUM_TYPES
)

923 
size
 = 
ønge_°©e
[
i
].
size_p‚
;

924 i‡(!
size
)

925 
ty≥
 = 
MTRR_NUM_TYPES
;

926 
num
[
ty≥
]++;

930 i‡(!
num
[
MTRR_TYPE_WRBACK
])

934 i‡(
num
[
MTRR_TYPE_WRBACK
] +Çum[
MTRR_TYPE_UNCACHABLE
] !=

935 
num_v¨_ønges
 - 
num
[
MTRR_NUM_TYPES
])

938 
	`mem£t
(
ønge
, 0, (range));

939 
ƒ_ønge
 = 0;

940 i‡(
mår_tom2
) {

941 
ønge
[
ƒ_ønge
].
°¨t
 = (1ULL<<(32 - 
PAGE_SHIFT
));

942 
ønge
[
ƒ_ønge
].
íd
 = 
mår_tom2
 >> 
PAGE_SHIFT
;

943 i‡(
highe°_p‚
 < 
ønge
[
ƒ_ønge
].
íd
)

944 
highe°_p‚
 = 
ønge
[
ƒ_ønge
].
íd
;

945 
ƒ_ønge
++;

947 
ƒ_ønge
 = 
	`x86_gë_mår_mem_ønge
(
ønge
,Çr_range, 0, 0);

950 
tŸÆ_åim_size
 = 0;

951 i‡(
ønge
[0].
°¨t
)

952 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(0, 
ønge
[0].
°¨t
);

955 
i
 = 0; i < 
ƒ_ønge
 - 1; i++) {

956 i‡(
ønge
[
i
].
íd
 <Ñ™ge[i+1].
°¨t
)

957 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
,

958 
ønge
[
i
+1].
°¨t
);

962 
i
 = 
ƒ_ønge
 - 1;

963 i‡(
ønge
[
i
].
íd
 < 
íd_p‚
)

964 
tŸÆ_åim_size
 +
	`ªÆ_åim_mem‹y
(
ønge
[
i
].
íd
,

965 
íd_p‚
);

967 i‡(
tŸÆ_åim_size
) {

968 
	`¥_w¨nög
("WARNING: BIOS bug: CPU MTRR†d⁄'àcovîáŒ o‡mem‹y,Üosög %ŒuMB o‡RAM.\n", 
tŸÆ_åim_size
 >> 20);

970 i‡(!
ch™ged_by_mår_˛ónup
)

971 
	`WARN_ON
(1);

973 
	`¥_öfo
("updateÉ820 for mtrr\n");

974 
	`upd©e_e820
();

980 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c

5 
	#DEBUG


	)

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/io.h
>

10 
	~<löux/mm.h
>

12 
	~<asm/¥o˚ss‹-Êags.h
>

13 
	~<asm/˝u„©uª.h
>

14 
	~<asm/ébÊush.h
>

15 
	~<asm/sy°em.h
>

16 
	~<asm/mår.h
>

17 
	~<asm/m§.h
>

18 
	~<asm/∑t.h
>

20 
	~"mår.h
"

22 
	sfixed_ønge_block
 {

23 
	mba£_m§
;

24 
	mønges
;

27 
fixed_ønge_block
 
	gfixed_ønge_blocks
[] = {

28 { 
MSR_MTRRfix64K_00000
, 1 },

29 { 
MSR_MTRRfix16K_80000
, 2 },

30 { 
MSR_MTRRfix4K_C0000
, 8 },

34 
	gsmp_ch™ges_mask
;

35 
	gmår_°©e_£t
;

36 
u64
 
	gmår_tom2
;

38 
mår_°©e_ty≥
 
	gmår_°©e
;

39 
EXPORT_SYMBOL_GPL
(
mår_°©e
);

49 
ölöe
 
	$k8_check_syscfg_døm_mod_í
()

51 
u32
 
lo
, 
hi
;

53 i‡(!((
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
) &&

54 (
boŸ_˝u_d©a
.
x86
 >= 0x0f)))

57 
	`rdm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

58 i‡(
lo
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
) {

59 
	`¥ötk
(
KERN_ERR
 
FW_WARN
 "MTRR: CPU %u: SYSCFG[MtrrFixDramModEn]"

61 
	`smp_¥o˚ss‹_id
());

62 
lo
 &~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

63 
	`mår_wrm§
(
MSR_K8_SYSCFG
, 
lo
, 
hi
);

65 
	}
}

73 
u8
 
	$mår_ty≥_lookup
(
u64
 
°¨t
, u64 
íd
)

75 
i
;

76 
u64
 
ba£
, 
mask
;

77 
u8
 
¥ev_m©ch
, 
cuº_m©ch
;

79 i‡(!
mår_°©e_£t
)

82 i‡(!
mår_°©e
.
íabÀd
)

86 
íd
--;

89 i‡(
mår_°©e
.
have_fixed
 && (
°¨t
 < 0x100000)) {

90 
idx
;

92 i‡(
°¨t
 < 0x80000) {

93 
idx
 = 0;

94 
idx
 +(
°¨t
 >> 16);

95  
mår_°©e
.
fixed_ønges
[
idx
];

96 } i‡(
°¨t
 < 0xC0000) {

97 
idx
 = 1 * 8;

98 
idx
 +((
°¨t
 - 0x80000) >> 14);

99  
mår_°©e
.
fixed_ønges
[
idx
];

100 } i‡(
°¨t
 < 0x1000000) {

101 
idx
 = 3 * 8;

102 
idx
 +((
°¨t
 - 0xC0000) >> 12);

103  
mår_°©e
.
fixed_ønges
[
idx
];

112 i‡(!(
mår_°©e
.
íabÀd
 & 2))

113  
mår_°©e
.
def_ty≥
;

115 
¥ev_m©ch
 = 0xFF;

116 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

117 
°¨t_°©e
, 
íd_°©e
;

119 i‡(!(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11)))

122 
ba£
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
) << 32) +

123 (
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 
PAGE_MASK
);

124 
mask
 = (((
u64
)
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
) << 32) +

125 (
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & 
PAGE_MASK
);

127 
°¨t_°©e
 = ((
°¨t
 & 
mask
Ë=(
ba£
 & mask));

128 
íd_°©e
 = ((
íd
 & 
mask
Ë=(
ba£
 & mask));

129 i‡(
°¨t_°©e
 !
íd_°©e
)

132 i‡((
°¨t
 & 
mask
Ë!(
ba£
 & mask))

135 
cuº_m©ch
 = 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff;

136 i‡(
¥ev_m©ch
 == 0xFF) {

137 
¥ev_m©ch
 = 
cuº_m©ch
;

141 i‡(
¥ev_m©ch
 =
MTRR_TYPE_UNCACHABLE
 ||

142 
cuº_m©ch
 =
MTRR_TYPE_UNCACHABLE
) {

143  
MTRR_TYPE_UNCACHABLE
;

146 i‡((
¥ev_m©ch
 =
MTRR_TYPE_WRBACK
 &&

147 
cuº_m©ch
 =
MTRR_TYPE_WRTHROUGH
) ||

148 (
¥ev_m©ch
 =
MTRR_TYPE_WRTHROUGH
 &&

149 
cuº_m©ch
 =
MTRR_TYPE_WRBACK
)) {

150 
¥ev_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

151 
cuº_m©ch
 = 
MTRR_TYPE_WRTHROUGH
;

154 i‡(
¥ev_m©ch
 !
cuº_m©ch
)

155  
MTRR_TYPE_UNCACHABLE
;

158 i‡(
mår_tom2
) {

159 i‡(
°¨t
 >(1ULL<<32Ë&& (
íd
 < 
mår_tom2
))

160  
MTRR_TYPE_WRBACK
;

163 i‡(
¥ev_m©ch
 != 0xFF)

164  
¥ev_m©ch
;

166  
mår_°©e
.
def_ty≥
;

167 
	}
}

171 
	$gë_mår_v¨_ønge
(
ödex
, 
mår_v¨_ønge
 *
vr
)

173 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

174 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

175 
	}
}

178 
	$fûl_mår_v¨_ønge
(
ödex
,

179 
u32
 
ba£_lo
, u32 
ba£_hi
, u32 
mask_lo
, u32 
mask_hi
)

181 
mår_v¨_ønge
 *
vr
;

183 
vr
 = 
mår_°©e
.
v¨_ønges
;

185 
vr
[
ödex
].
ba£_lo
 = base_lo;

186 
vr
[
ödex
].
ba£_hi
 = base_hi;

187 
vr
[
ödex
].
mask_lo
 = mask_lo;

188 
vr
[
ödex
].
mask_hi
 = mask_hi;

189 
	}
}

191 
	$gë_fixed_ønges
(
mår_ty≥
 *
‰s
)

193 *
p
 = (*)
‰s
;

194 
i
;

196 
	`k8_check_syscfg_døm_mod_í
();

198 
	`rdm§
(
MSR_MTRRfix64K_00000
, 
p
[0],Ö[1]);

200 
i
 = 0; i < 2; i++)

201 
	`rdm§
(
MSR_MTRRfix16K_80000
 + 
i
, 
p
[2 + i * 2],Ö[3 + i * 2]);

202 
i
 = 0; i < 8; i++)

203 
	`rdm§
(
MSR_MTRRfix4K_C0000
 + 
i
, 
p
[6 + i * 2],Ö[7 + i * 2]);

204 
	}
}

206 
	$mår_ßve_fixed_ønges
(*
öfo
)

208 i‡(
˝u_has_mår
)

209 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

210 
	}
}

212 
__öôd©a
 
	gœ°_fixed_°¨t
;

213 
__öôd©a
 
	gœ°_fixed_íd
;

214 
mår_ty≥
 
__öôd©a
 
	gœ°_fixed_ty≥
;

216 
__öô
 
	$¥öt_fixed_œ°
()

218 i‡(!
œ°_fixed_íd
)

221 
	`¥_debug
(" %05X-%05X %s\n", 
œ°_fixed_°¨t
,

222 
œ°_fixed_íd
 - 1, 
	`mår_©åib_to_°r
(
œ°_fixed_ty≥
));

224 
œ°_fixed_íd
 = 0;

225 
	}
}

227 
__öô
 
	$upd©e_fixed_œ°
(
ba£
, 
íd
,

228 
mår_ty≥
 
ty≥
)

230 
œ°_fixed_°¨t
 = 
ba£
;

231 
œ°_fixed_íd
 = 
íd
;

232 
œ°_fixed_ty≥
 = 
ty≥
;

233 
	}
}

235 
__öô


236 
	$¥öt_fixed
(
ba£
, 
°ï
, c⁄° 
mår_ty≥
 *
ty≥s
)

238 
i
;

240 
i
 = 0; i < 8; ++i, ++
ty≥s
, 
ba£
 +
°ï
) {

241 i‡(
œ°_fixed_íd
 == 0) {

242 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

245 i‡(
œ°_fixed_íd
 =
ba£
 && 
œ°_fixed_ty≥
 =*
ty≥s
) {

246 
œ°_fixed_íd
 = 
ba£
 + 
°ï
;

250 
	`¥öt_fixed_œ°
();

251 
	`upd©e_fixed_œ°
(
ba£
, ba£ + 
°ï
, *
ty≥s
);

253 
	}
}

255 
¥ï¨e_£t
();

256 
po°_£t
();

258 
__öô
 
	$¥öt_mår_°©e
()

260 
i
;

261 
high_width
;

263 
	`¥_debug
("MTRR defaultÅype: %s\n",

264 
	`mår_©åib_to_°r
(
mår_°©e
.
def_ty≥
));

265 i‡(
mår_°©e
.
have_fixed
) {

266 
	`¥_debug
("MTRR fixedÑanges %sabled:\n",

267 
mår_°©e
.
íabÀd
 & 1 ? "en" : "dis");

268 
	`¥öt_fixed
(0x00000, 0x10000, 
mår_°©e
.
fixed_ønges
 + 0);

269 
i
 = 0; i < 2; ++i)

270 
	`¥öt_fixed
(0x80000 + 
i
 * 0x20000, 0x04000,

271 
mår_°©e
.
fixed_ønges
 + (
i
 + 1) * 8);

272 
i
 = 0; i < 8; ++i)

273 
	`¥öt_fixed
(0xC0000 + 
i
 * 0x08000, 0x01000,

274 
mår_°©e
.
fixed_ønges
 + (
i
 + 3) * 8);

277 
	`¥öt_fixed_œ°
();

279 
	`¥_debug
("MTRR variableÑanges %sabled:\n",

280 
mår_°©e
.
íabÀd
 & 2 ? "en" : "dis");

281 i‡(
size_‹_mask
 & 0xffffffffUL)

282 
high_width
 = 
	`ffs
(
size_‹_mask
 & 0xffffffffUL) - 1;

284 
high_width
 = 
	`ffs
(
size_‹_mask
>>32) + 32 - 1;

285 
high_width
 = (high_width - (32 - 
PAGE_SHIFT
) + 3) / 4;

287 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

288 i‡(
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 & (1 << 11))

289 
	`¥_debug
(" %u base %0*X%05X000 mask %0*X%05X000 %s\n",

290 
i
,

291 
high_width
,

292 
mår_°©e
.
v¨_ønges
[
i
].
ba£_hi
,

293 
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 >> 12,

294 
high_width
,

295 
mår_°©e
.
v¨_ønges
[
i
].
mask_hi
,

296 
mår_°©e
.
v¨_ønges
[
i
].
mask_lo
 >> 12,

297 
	`mår_©åib_to_°r
(
mår_°©e
.
v¨_ønges
[
i
].
ba£_lo
 & 0xff));

299 
	`¥_debug
(" %u dißbÀd\n", 
i
);

301 i‡(
mår_tom2
)

302 
	`¥_debug
("TOM2: %016Œxák®%ŒdM\n", 
mår_tom2
, mtrr_tom2>>20);

303 
	}
}

306 
__öô
 
	$gë_mår_°©e
()

308 
mår_v¨_ønge
 *
vrs
;

309 
Êags
;

310 
lo
, 
dummy
;

311 
i
;

313 
vrs
 = 
mår_°©e
.
v¨_ønges
;

315 
	`rdm§
(
MSR_MTRRˇp
, 
lo
, 
dummy
);

316 
mår_°©e
.
have_fixed
 = (
lo
 >> 8) & 1;

318 
i
 = 0; i < 
num_v¨_ønges
; i++)

319 
	`gë_mår_v¨_ønge
(
i
, &
vrs
[i]);

320 i‡(
mår_°©e
.
have_fixed
)

321 
	`gë_fixed_ønges
(
mår_°©e
.
fixed_ønges
);

323 
	`rdm§
(
MSR_MTRRdefTy≥
, 
lo
, 
dummy
);

324 
mår_°©e
.
def_ty≥
 = (
lo
 & 0xff);

325 
mår_°©e
.
íabÀd
 = (
lo
 & 0xc00) >> 10;

327 i‡(
	`amd_•ecül_deÁu…_mår
()) {

328 
low
, 
high
;

331 
	`rdm§
(
MSR_K8_TOP_MEM2
, 
low
, 
high
);

332 
mår_tom2
 = 
high
;

333 
mår_tom2
 <<= 32;

334 
mår_tom2
 |
low
;

335 
mår_tom2
 &= 0xffffff800000ULL;

338 
	`¥öt_mår_°©e
();

340 
mår_°©e_£t
 = 1;

343 
	`loˇl_úq_ßve
(
Êags
);

344 
	`¥ï¨e_£t
();

346 
	`∑t_öô
();

348 
	`po°_£t
();

349 
	`loˇl_úq_ª°‹e
(
Êags
);

350 
	}
}

353 
__öô
 
	$mår_°©e_w¨n
()

355 
mask
 = 
smp_ch™ges_mask
;

357 i‡(!
mask
)

359 i‡(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

360 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent fixed MTRR settings\n");

361 i‡(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

362 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent variable MTRR settings\n");

363 i‡(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

364 
	`¥_w¨nög
("mtrr: your CPUs had inconsistent MTRRdefType settings\n");

366 
	`¥ötk
(
KERN_INFO
 "mtrr:Örobably your BIOS doesÇot setupáll CPUs.\n");

367 
	`¥ötk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

368 
	}
}

375 
	$mår_wrm§
(
m§
, 
a
, 
b
)

377 i‡(
	`wrm§_ß„
(
m§
, 
a
, 
b
) < 0) {

378 
	`¥ötk
(
KERN_ERR


380 
	`smp_¥o˚ss‹_id
(), 
m§
, 
a
, 
b
);

382 
	}
}

391 
	$£t_fixed_ønge
(
m§
, 
boﬁ
 *
ch™ged
, *
m§w‹ds
)

393 
lo
, 
hi
;

395 
	`rdm§
(
m§
, 
lo
, 
hi
);

397 i‡(
lo
 !
m§w‹ds
[0] || 
hi
 != msrwords[1]) {

398 
	`mår_wrm§
(
m§
, 
m§w‹ds
[0], msrwords[1]);

399 *
ch™ged
 = 
åue
;

401 
	}
}

412 
	$gíîic_gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚_ªg
)

414 
lba£
, 
lsize
;

415 
mår_ty≥
 
…y≥
;

416 
i
, 
max
;

418 
max
 = 
num_v¨_ønges
;

419 i‡(
ª∂a˚_ªg
 >0 &&Ñïœ˚_ªg < 
max
)

420  
ª∂a˚_ªg
;

422 
i
 = 0; i < 
max
; ++i) {

423 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

424 i‡(
lsize
 == 0)

425  
i
;

428  -
ENOSPC
;

429 
	}
}

431 
	$gíîic_gë_mår
(
ªg
, *
ba£
,

432 *
size
, 
mår_ty≥
 *
ty≥
)

434 
mask_lo
, 
mask_hi
, 
ba£_lo
, 
ba£_hi
;

435 
tmp
, 
hi
;

436 
˝u
;

442 
˝u
 = 
	`gë_˝u
();

444 
	`rdm§
(
	`MTRRphysMask_MSR
(
ªg
), 
mask_lo
, 
mask_hi
);

446 i‡((
mask_lo
 & 0x800) == 0) {

448 *
ba£
 = 0;

449 *
size
 = 0;

450 *
ty≥
 = 0;

451 
out_put_˝u
;

454 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
ba£_lo
, 
ba£_hi
);

457 
tmp
 = 
mask_hi
 << (32 - 
PAGE_SHIFT
Ë| 
mask_lo
 >> PAGE_SHIFT;

458 
mask_lo
 = 
size_‹_mask
 | 
tmp
;

461 
hi
 = 
	`Ês
(
tmp
);

462 i‡(
hi
 > 0) {

463 
tmp
 |~((1<<(
hi
 - 1)) - 1);

465 i‡(
tmp
 !
mask_lo
) {

466 
	`¥ötk
(
KERN_WARNING
 "mtrr: your BIOS has configuredán incorrect mask, fixing it.\n");

467 
mask_lo
 = 
tmp
;

475 *
size
 = -
mask_lo
;

476 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
Ë| 
ba£_lo
 >> PAGE_SHIFT;

477 *
ty≥
 = 
ba£_lo
 & 0xff;

479 
out_put_˝u
:

480 
	`put_˝u
();

481 
	}
}

488 
	$£t_fixed_ønges
(
mår_ty≥
 *
‰s
)

490 *
ßved
 = (*)
‰s
;

491 
boﬁ
 
ch™ged
 = 
Ál£
;

492 
block
 = -1, 
ønge
;

494 
	`k8_check_syscfg_døm_mod_í
();

496 
fixed_ønge_blocks
[++
block
].
ønges
) {

497 
ønge
 = 0;Ñ™gê< 
fixed_ønge_blocks
[
block
].
ønges
;Ñange++)

498 
	`£t_fixed_ønge
(
fixed_ønge_blocks
[
block
].
ba£_m§
 + 
ønge
,

499 &
ch™ged
, (*)
ßved
++);

502  
ch™ged
;

503 
	}
}

509 
boﬁ
 
	$£t_mår_v¨_ønges
(
ödex
, 
mår_v¨_ønge
 *
vr
)

511 
lo
, 
hi
;

512 
boﬁ
 
ch™ged
 = 
Ál£
;

514 
	`rdm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
lo
, 
hi
);

515 i‡((
vr
->
ba£_lo
 & 0xfffff0ffULË!(
lo
 & 0xfffff0ffUL)

516 || (
vr
->
ba£_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

517 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

519 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ödex
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

520 
ch™ged
 = 
åue
;

523 
	`rdm§
(
	`MTRRphysMask_MSR
(
ödex
), 
lo
, 
hi
);

525 i‡((
vr
->
mask_lo
 & 0xfffff800ULË!(
lo
 & 0xfffff800UL)

526 || (
vr
->
mask_hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
))) !=

527 (
hi
 & (
size_™d_mask
 >> (32 - 
PAGE_SHIFT
)))) {

528 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ödex
), 
vr
->
mask_lo
, vr->
mask_hi
);

529 
ch™ged
 = 
åue
;

531  
ch™ged
;

532 
	}
}

534 
u32
 
	gde·y≥_lo
, 
	gde·y≥_hi
;

542 
	$£t_mår_°©e
()

544 
ch™ge_mask
 = 0;

545 
i
;

547 
i
 = 0; i < 
num_v¨_ønges
; i++) {

548 i‡(
	`£t_mår_v¨_ønges
(
i
, &
mår_°©e
.
v¨_ønges
[i]))

549 
ch™ge_mask
 |
MTRR_CHANGE_MASK_VARIABLE
;

552 i‡(
mår_°©e
.
have_fixed
 && 
	`£t_fixed_ønges
(mår_°©e.
fixed_ønges
))

553 
ch™ge_mask
 |
MTRR_CHANGE_MASK_FIXED
;

559 i‡((
de·y≥_lo
 & 0xffË!
mår_°©e
.
def_ty≥


560 || ((
de·y≥_lo
 & 0xc00Ë>> 10Ë!
mår_°©e
.
íabÀd
) {

562 
de·y≥_lo
 = (de·y≥_lÿ& ~0xcffË| 
mår_°©e
.
def_ty≥
 |

563 (
mår_°©e
.
íabÀd
 << 10);

564 
ch™ge_mask
 |
MTRR_CHANGE_MASK_DEFTYPE
;

567  
ch™ge_mask
;

568 
	}
}

571 
	g¸4
;

572 
DEFINE_RAW_SPINLOCK
(
£t_©omicôy_lock
);

581 
	$¥ï¨e_£t
(Ë
	$__acquúes
(
£t_©omicôy_lock
)

583 
¸0
;

592 
	`øw_•ö_lock
(&
£t_©omicôy_lock
);

595 
¸0
 = 
	`ªad_¸0
(Ë| 
X86_CR0_CD
;

596 
	`wrôe_¸0
(
¸0
);

597 
	`wbövd
();

600 i‡(
˝u_has_pge
) {

601 
¸4
 = 
	`ªad_¸4
();

602 
	`wrôe_¸4
(
¸4
 & ~
X86_CR4_PGE
);

606 
	`__Êush_éb
();

609 
	`rdm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

612 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
 & ~0xcff, 
de·y≥_hi
);

613 
	}
}

615 
	$po°_£t
(Ë
	$__ªÀa£s
(
£t_©omicôy_lock
)

618 
	`__Êush_éb
();

621 
	`mår_wrm§
(
MSR_MTRRdefTy≥
, 
de·y≥_lo
, 
de·y≥_hi
);

624 
	`wrôe_¸0
(
	`ªad_¸0
() & 0xbfffffff);

627 i‡(
˝u_has_pge
)

628 
	`wrôe_¸4
(
¸4
);

629 
	`øw_•ö_u∆ock
(&
£t_©omicôy_lock
);

630 
	}
}

632 
	$gíîic_£t_Æl
()

634 
mask
, 
cou¡
;

635 
Êags
;

637 
	`loˇl_úq_ßve
(
Êags
);

638 
	`¥ï¨e_£t
();

641 
mask
 = 
	`£t_mår_°©e
();

644 
	`∑t_öô
();

646 
	`po°_£t
();

647 
	`loˇl_úq_ª°‹e
(
Êags
);

650 
cou¡
 = 0; cou¡ <  
mask
 * 8; ++count) {

651 i‡(
mask
 & 0x01)

652 
	`£t_bô
(
cou¡
, &
smp_ch™ges_mask
);

653 
mask
 >>= 1;

656 
	}
}

668 
	$gíîic_£t_mår
(
ªg
, 
ba£
,

669 
size
, 
mår_ty≥
 
ty≥
)

671 
Êags
;

672 
mår_v¨_ønge
 *
vr
;

674 
vr
 = &
mår_°©e
.
v¨_ønges
[
ªg
];

676 
	`loˇl_úq_ßve
(
Êags
);

677 
	`¥ï¨e_£t
();

679 i‡(
size
 == 0) {

684 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 0, 0);

685 
	`mem£t
(
vr
, 0, (
mår_v¨_ønge
));

687 
vr
->
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty≥
;

688 
vr
->
ba£_hi
 = (
ba£
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

689 
vr
->
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

690 
vr
->
mask_hi
 = (-
size
 & 
size_™d_mask
Ë>> (32 - 
PAGE_SHIFT
);

692 
	`mår_wrm§
(
	`MTRRphysBa£_MSR
(
ªg
), 
vr
->
ba£_lo
, vr->
ba£_hi
);

693 
	`mår_wrm§
(
	`MTRRphysMask_MSR
(
ªg
), 
vr
->
mask_lo
, vr->
mask_hi
);

696 
	`po°_£t
();

697 
	`loˇl_úq_ª°‹e
(
Êags
);

698 
	}
}

700 
	$gíîic_vÆid©e_add_∑ge
(
ba£
, 
size
,

701 
ty≥
)

703 
lba£
, 
œ°
;

709 i‡(
	`is_˝u
(
INTEL
Ë&& 
boŸ_˝u_d©a
.
x86
 == 6 &&

710 
boŸ_˝u_d©a
.
x86_modñ
 == 1 &&

711 
boŸ_˝u_d©a
.
x86_mask
 <= 7) {

712 i‡(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

713 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸ 4 MiBálig√d\n", 
ba£
);

714  -
EINVAL
;

716 i‡(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

717 (
ty≥
 =
MTRR_TYPE_WRCOMB


718 || 
ty≥
 =
MTRR_TYPE_WRBACK
)) {

719 
	`¥_w¨nög
("mtrr: writable mtrr between 0x70000000ánd 0x7003FFFF may hangÅhe CPU.\n");

720  -
EINVAL
;

728 
œ°
 = 
ba£
 + 
size
 - 1;

729 
lba£
 = 
ba£
; !÷ba£ & 1Ë&& (
œ°
 & 1);

730 
lba£
 =Üba£ >> 1, 
œ°
 =Üast >> 1)

732 i‡(
lba£
 !
œ°
) {

733 
	`¥_w¨nög
("mår: ba£(0x%lx000Ëi†nŸálig√d o¿®size(0x%lx000Ëbound¨y\n", 
ba£
, 
size
);

734  -
EINVAL
;

737 
	}
}

739 
	$gíîic_have_wrcomb
()

741 
c⁄fig
, 
dummy
;

742 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

743  
c⁄fig
 & (1 << 10);

744 
	}
}

746 
	$posôive_have_wrcomb
()

749 
	}
}

754 c⁄° 
mår_›s
 
	ggíîic_mår_›s
 = {

755 .
u£_öãl_if
 = 1,

756 .
	g£t_Æl
 = 
gíîic_£t_Æl
,

757 .
	ggë
 = 
gíîic_gë_mår
,

758 .
	ggë_‰ì_ªgi⁄
 = 
gíîic_gë_‰ì_ªgi⁄
,

759 .
	g£t
 = 
gíîic_£t_mår
,

760 .
	gvÆid©e_add_∑ge
 = 
gíîic_vÆid©e_add_∑ge
,

761 .
	ghave_wrcomb
 = 
gíîic_have_wrcomb
,

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c

1 
	~<löux/ˇ∑bûôy.h
>

2 
	~<löux/£q_fûe.h
>

3 
	~<löux/uac˚ss.h
>

4 
	~<löux/¥oc_fs.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/˘y≥.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/öô.h
>

11 
	#LINE_SIZE
 80

	)

13 
	~<asm/mår.h
>

15 
	~"mår.h
"

17 
	#FILE_FCOUNT
(
f
Ë(((
£q_fûe
 *)((f)->
¥iv©e_d©a
))->
¥iv©e
)

	)

19 c⁄° *c⁄° 
	gmår_°rögs
[
MTRR_NUM_TYPES
] =

30 c⁄° *
	$mår_©åib_to_°r
(
x
)

32  (
x
 <6Ë? 
mår_°rögs
[x] : "?";

33 
	}
}

35 #ifde‡
CONFIG_PROC_FS


38 
	$mår_fûe_add
(
ba£
, 
size
,

39 
ty≥
, 
boﬁ
 
ö¸emít
, 
fûe
 *fûe, 
∑ge
)

41 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

42 
ªg
, 
max
;

44 
max
 = 
num_v¨_ønges
;

45 i‡(
fcou¡
 =
NULL
) {

46 
fcou¡
 = 
	`kzÆloc
(
max
 *  *fcou¡, 
GFP_KERNEL
);

47 i‡(!
fcou¡
)

48  -
ENOMEM
;

49 
	`FILE_FCOUNT
(
fûe
Ë
fcou¡
;

51 i‡(!
∑ge
) {

52 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

53  -
EINVAL
;

54 
ba£
 >>
PAGE_SHIFT
;

55 
size
 >>
PAGE_SHIFT
;

57 
ªg
 = 
	`mår_add_∑ge
(
ba£
, 
size
, 
ty≥
, 
åue
);

58 i‡(
ªg
 >= 0)

59 ++
fcou¡
[
ªg
];

60  
ªg
;

61 
	}
}

64 
	$mår_fûe_dñ
(
ba£
, 
size
,

65 
fûe
 *fûe, 
∑ge
)

67 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

68 
ªg
;

70 i‡(!
∑ge
) {

71 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1)))

72  -
EINVAL
;

73 
ba£
 >>
PAGE_SHIFT
;

74 
size
 >>
PAGE_SHIFT
;

76 
ªg
 = 
	`mår_dñ_∑ge
(-1, 
ba£
, 
size
);

77 i‡(
ªg
 < 0)

78  
ªg
;

79 i‡(
fcou¡
 =
NULL
)

80  
ªg
;

81 i‡(
fcou¡
[
ªg
] < 1)

82  -
EINVAL
;

83 --
fcou¡
[
ªg
];

84  
ªg
;

85 
	}
}

93 
ssize_t


94 
	$mår_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 * 
µos
)

96 
i
, 
îr
;

97 
ªg
;

98 
ba£
, 
size
;

99 *
±r
;

100 
löe
[
LINE_SIZE
];

101 
Àngth
;

102 
size_t
 
löñí
;

104 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

105  -
EPERM
;

107 
	`mem£t
(
löe
, 0, 
LINE_SIZE
);

109 
Àngth
 = 
Àn
;

110 
Àngth
--;

112 i‡(
Àngth
 > 
LINE_SIZE
 - 1)

113 
Àngth
 = 
LINE_SIZE
 - 1;

115 i‡(
Àngth
 < 0)

116  -
EINVAL
;

118 i‡(
	`c›y_‰om_u£r
(
löe
, 
buf
, 
Àngth
))

119  -
EFAULT
;

121 
löñí
 = 
	`°æí
(
löe
);

122 
±r
 = 
löe
 + 
löñí
 - 1;

123 i‡(
löñí
 && *
±r
 == '\n')

124 *
±r
 = '\0';

126 i‡(!
	`°∫cmp
(
löe
, "disable=", 8)) {

127 
ªg
 = 
	`sim∂e_°πoul
(
löe
 + 8, &
±r
, 0);

128 
îr
 = 
	`mår_dñ_∑ge
(
ªg
, 0, 0);

129 i‡(
îr
 < 0)

130  
îr
;

131  
Àn
;

134 i‡(
	`°∫cmp
(
löe
, "base=", 5))

135  -
EINVAL
;

137 
ba£
 = 
	`sim∂e_°πouŒ
(
löe
 + 5, &
±r
, 0);

138 
±r
 = 
	`skù_•a˚s
(ptr);

140 i‡(
	`°∫cmp
(
±r
, "size=", 5))

141  -
EINVAL
;

143 
size
 = 
	`sim∂e_°πouŒ
(
±r
 + 5, &ptr, 0);

144 i‡((
ba£
 & 0xfffË|| (
size
 & 0xfff))

145  -
EINVAL
;

146 
±r
 = 
	`skù_•a˚s
(ptr);

148 i‡(
	`°∫cmp
(
±r
, "type=", 5))

149  -
EINVAL
;

150 
±r
 = 
	`skù_•a˚s
(ptr + 5);

152 
i
 = 0; i < 
MTRR_NUM_TYPES
; ++i) {

153 i‡(
	`°rcmp
(
±r
, 
mår_°rögs
[
i
]))

155 
ba£
 >>
PAGE_SHIFT
;

156 
size
 >>
PAGE_SHIFT
;

157 
îr
 = 
	`mår_add_∑ge
(()
ba£
, ()
size
, 
i
, 
åue
);

158 i‡(
îr
 < 0)

159  
îr
;

160  
Àn
;

162  -
EINVAL
;

163 
	}
}

166 
	$mår_io˘l
(
fûe
 *fûe, 
cmd
, 
__¨g
)

168 
îr
 = 0;

169 
mår_ty≥
 
ty≥
;

170 
size
;

171 
mår_£¡ry
 
£¡ry
;

172 
mår_gíåy
 
gíåy
;

173 
__u£r
 *
¨g
 = (__u£∏*Ë
__¨g
;

175 
cmd
) {

176 
MTRRIOC_ADD_ENTRY
:

177 
MTRRIOC_SET_ENTRY
:

178 
MTRRIOC_DEL_ENTRY
:

179 
MTRRIOC_KILL_ENTRY
:

180 
MTRRIOC_ADD_PAGE_ENTRY
:

181 
MTRRIOC_SET_PAGE_ENTRY
:

182 
MTRRIOC_DEL_PAGE_ENTRY
:

183 
MTRRIOC_KILL_PAGE_ENTRY
:

184 i‡(
	`c›y_‰om_u£r
(&
£¡ry
, 
¨g
,  sentry))

185  -
EFAULT
;

187 
MTRRIOC_GET_ENTRY
:

188 
MTRRIOC_GET_PAGE_ENTRY
:

189 i‡(
	`c›y_‰om_u£r
(&
gíåy
, 
¨g
,  gentry))

190  -
EFAULT
;

192 #ifde‡
CONFIG_COMPAT


193 
MTRRIOC32_ADD_ENTRY
:

194 
MTRRIOC32_SET_ENTRY
:

195 
MTRRIOC32_DEL_ENTRY
:

196 
MTRRIOC32_KILL_ENTRY
:

197 
MTRRIOC32_ADD_PAGE_ENTRY
:

198 
MTRRIOC32_SET_PAGE_ENTRY
:

199 
MTRRIOC32_DEL_PAGE_ENTRY
:

200 
MTRRIOC32_KILL_PAGE_ENTRY
: {

201 
mår_£¡ry32
 
__u£r
 *
s32
;

203 
s32
 = (
mår_£¡ry32
 
__u£r
 *)
__¨g
;

204 
îr
 = 
	`gë_u£r
(
£¡ry
.
ba£
, &
s32
->base);

205 
îr
 |
	`gë_u£r
(
£¡ry
.
size
, &
s32
->size);

206 
îr
 |
	`gë_u£r
(
£¡ry
.
ty≥
, &
s32
->type);

207 i‡(
îr
)

208  
îr
;

211 
MTRRIOC32_GET_ENTRY
:

212 
MTRRIOC32_GET_PAGE_ENTRY
: {

213 
mår_gíåy32
 
__u£r
 *
g32
;

215 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

216 
îr
 = 
	`gë_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

217 
îr
 |
	`gë_u£r
(
gíåy
.
ba£
, &
g32
->base);

218 
îr
 |
	`gë_u£r
(
gíåy
.
size
, &
g32
->size);

219 
îr
 |
	`gë_u£r
(
gíåy
.
ty≥
, &
g32
->type);

220 i‡(
îr
)

221  
îr
;

227 
cmd
) {

229  -
ENOTTY
;

230 
MTRRIOC_ADD_ENTRY
:

231 #ifde‡
CONFIG_COMPAT


232 
MTRRIOC32_ADD_ENTRY
:

234 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

235  -
EPERM
;

236 
îr
 =

237 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

238 
fûe
, 0);

240 
MTRRIOC_SET_ENTRY
:

241 #ifde‡
CONFIG_COMPAT


242 
MTRRIOC32_SET_ENTRY
:

244 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

245  -
EPERM
;

246 
îr
 = 
	`mår_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

248 
MTRRIOC_DEL_ENTRY
:

249 #ifde‡
CONFIG_COMPAT


250 
MTRRIOC32_DEL_ENTRY
:

252 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

253  -
EPERM
;

254 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 0);

256 
MTRRIOC_KILL_ENTRY
:

257 #ifde‡
CONFIG_COMPAT


258 
MTRRIOC32_KILL_ENTRY
:

260 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

261  -
EPERM
;

262 
îr
 = 
	`mår_dñ
(-1, 
£¡ry
.
ba£
, síåy.
size
);

264 
MTRRIOC_GET_ENTRY
:

265 #ifde‡
CONFIG_COMPAT


266 
MTRRIOC32_GET_ENTRY
:

268 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

269  -
EINVAL
;

270 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

273 i‡(
gíåy
.
ba£
 + 
size
 - 1 >(1UL << (8 * (gíåy.sizeË- 
PAGE_SHIFT
))

274 || 
size
 >(1UL << (8 * (
gíåy
.sizeË- 
PAGE_SHIFT
)))

275 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

277 
gíåy
.
ba£
 <<
PAGE_SHIFT
;

278 
gíåy
.
size
 = sizê<< 
PAGE_SHIFT
;

279 
gíåy
.
ty≥
 =Åype;

283 
MTRRIOC_ADD_PAGE_ENTRY
:

284 #ifde‡
CONFIG_COMPAT


285 
MTRRIOC32_ADD_PAGE_ENTRY
:

287 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

288  -
EPERM
;

289 
îr
 =

290 
	`mår_fûe_add
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
åue
,

291 
fûe
, 1);

293 
MTRRIOC_SET_PAGE_ENTRY
:

294 #ifde‡
CONFIG_COMPAT


295 
MTRRIOC32_SET_PAGE_ENTRY
:

297 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

298  -
EPERM
;

299 
îr
 =

300 
	`mår_add_∑ge
(
£¡ry
.
ba£
, síåy.
size
, síåy.
ty≥
, 
Ál£
);

302 
MTRRIOC_DEL_PAGE_ENTRY
:

303 #ifde‡
CONFIG_COMPAT


304 
MTRRIOC32_DEL_PAGE_ENTRY
:

306 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

307  -
EPERM
;

308 
îr
 = 
	`mår_fûe_dñ
(
£¡ry
.
ba£
, síåy.
size
, 
fûe
, 1);

310 
MTRRIOC_KILL_PAGE_ENTRY
:

311 #ifde‡
CONFIG_COMPAT


312 
MTRRIOC32_KILL_PAGE_ENTRY
:

314 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

315  -
EPERM
;

316 
îr
 = 
	`mår_dñ_∑ge
(-1, 
£¡ry
.
ba£
, síåy.
size
);

318 
MTRRIOC_GET_PAGE_ENTRY
:

319 #ifde‡
CONFIG_COMPAT


320 
MTRRIOC32_GET_PAGE_ENTRY
:

322 i‡(
gíåy
.
ªgnum
 >
num_v¨_ønges
)

323  -
EINVAL
;

324 
mår_if
->
	`gë
(
gíåy
.
ªgnum
, &gíåy.
ba£
, &
size
, &
ty≥
);

326 i‡(
size
 !(
	`__ty≥of__
(
gíåy
.size))size)

327 
gíåy
.
ba£
 = gíåy.
size
 = gíåy.
ty≥
 = 0;

329 
gíåy
.
size
 = size;

330 
gíåy
.
ty≥
 =Åype;

335 i‡(
îr
)

336  
îr
;

338 
cmd
) {

339 
MTRRIOC_GET_ENTRY
:

340 
MTRRIOC_GET_PAGE_ENTRY
:

341 i‡(
	`c›y_to_u£r
(
¨g
, &
gíåy
,  gentry))

342 
îr
 = -
EFAULT
;

344 #ifde‡
CONFIG_COMPAT


345 
MTRRIOC32_GET_ENTRY
:

346 
MTRRIOC32_GET_PAGE_ENTRY
: {

347 
mår_gíåy32
 
__u£r
 *
g32
;

349 
g32
 = (
mår_gíåy32
 
__u£r
 *)
__¨g
;

350 
îr
 = 
	`put_u£r
(
gíåy
.
ba£
, &
g32
->base);

351 
îr
 |
	`put_u£r
(
gíåy
.
size
, &
g32
->size);

352 
îr
 |
	`put_u£r
(
gíåy
.
ªgnum
, &
g32
->regnum);

353 
îr
 |
	`put_u£r
(
gíåy
.
ty≥
, &
g32
->type);

358  
îr
;

359 
	}
}

361 
	$mår_˛o£
(
öode
 *
öo
, 
fûe
 *file)

363 *
fcou¡
 = 
	`FILE_FCOUNT
(
fûe
);

364 
i
, 
max
;

366 i‡(
fcou¡
 !
NULL
) {

367 
max
 = 
num_v¨_ønges
;

368 
i
 = 0; i < 
max
; ++i) {

369 
fcou¡
[
i
] > 0) {

370 
	`mår_dñ
(
i
, 0, 0);

371 --
fcou¡
[
i
];

374 
	`k‰ì
(
fcou¡
);

375 
	`FILE_FCOUNT
(
fûe
Ë
NULL
;

377  
	`sögÀ_ªÀa£
(
öo
, 
fûe
);

378 
	}
}

380 
mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
);

382 
	$mår_›í
(
öode
 *öode, 
fûe
 *file)

384 i‡(!
mår_if
)

385  -
EIO
;

386 i‡(!
mår_if
->
gë
)

387  -
ENXIO
;

388  
	`sögÀ_›í
(
fûe
, 
mår_£q_show
, 
NULL
);

389 
	}
}

391 c⁄° 
fûe_›î©i⁄s
 
	gmår_f›s
 = {

392 .
ow√r
 = 
THIS_MODULE
,

393 .
	g›í
 = 
mår_›í
,

394 .
	gªad
 = 
£q_ªad
,

395 .
	gŒ£ek
 = 
£q_l£ek
,

396 .
	gwrôe
 = 
mår_wrôe
,

397 .
	gu∆ocked_io˘l
 = 
mår_io˘l
,

398 .
	gcom∑t_io˘l
 = 
mår_io˘l
,

399 .
	gªÀa£
 = 
mår_˛o£
,

402 
	$mår_£q_show
(
£q_fûe
 *
£q
, *
off£t
)

404 
Á˘‹
;

405 
i
, 
max
, 
Àn
;

406 
mår_ty≥
 
ty≥
;

407 
ba£
, 
size
;

409 
Àn
 = 0;

410 
max
 = 
num_v¨_ønges
;

411 
i
 = 0; i < 
max
; i++) {

412 
mår_if
->
	`gë
(
i
, &
ba£
, &
size
, &
ty≥
);

413 i‡(
size
 == 0) {

414 
mår_ußge_èbÀ
[
i
] = 0;

417 i‡(
size
 < (0x100000 >> 
PAGE_SHIFT
)) {

419 
Á˘‹
 = 'K';

420 
size
 <<
PAGE_SHIFT
 - 10;

422 
Á˘‹
 = 'M';

423 
size
 >>20 - 
PAGE_SHIFT
;

426 
Àn
 +
	`£q_¥ötf
(
£q
, "reg%02i: base=0x%06lx000 "

428 
i
, 
ba£
, ba£ >> (20 - 
PAGE_SHIFT
), 
size
,

429 
Á˘‹
, 
mår_ußge_èbÀ
[
i
],

430 
	`mår_©åib_to_°r
(
ty≥
));

433 
	}
}

435 
__öô
 
	$mår_if_öô
()

437 
˝uöfo_x86
 *
c
 = &
boŸ_˝u_d©a
;

439 i‡((!
	`˝u_has
(
c
, 
X86_FEATURE_MTRR
)) &&

440 (!
	`˝u_has
(
c
, 
X86_FEATURE_K6_MTRR
)) &&

441 (!
	`˝u_has
(
c
, 
X86_FEATURE_CYRIX_ARR
)) &&

442 (!
	`˝u_has
(
c
, 
X86_FEATURE_CENTAUR_MCR
)))

443  -
ENODEV
;

445 
	`¥oc_¸óã
("mår", 
S_IWUSR
 | 
S_IRUGO
, 
NULL
, &
mår_f›s
);

447 
	}
}

448 
¨ch_öôˇŒ
(
mår_if_öô
);

	@/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c

34 
	#DEBUG


	)

36 
	~<löux/ty≥s.h
>

38 
	~<löux/kvm_∑ø.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/moduÀ.h
>

41 
	~<löux/muãx.h
>

42 
	~<löux/öô.h
>

43 
	~<löux/s‹t.h
>

44 
	~<löux/˝u.h
>

45 
	~<löux/pci.h
>

46 
	~<löux/smp.h
>

48 
	~<asm/¥o˚ss‹.h
>

49 
	~<asm/e820.h
>

50 
	~<asm/mår.h
>

51 
	~<asm/m§.h
>

53 
	~"mår.h
"

55 
u32
 
	gnum_v¨_ønges
;

57 
	gmår_ußge_èbÀ
[
MTRR_MAX_VAR_RANGES
];

58 
DEFINE_MUTEX
(
mår_muãx
);

60 
u64
 
	gsize_‹_mask
, 
	gsize_™d_mask
;

61 
boﬁ
 
	gmår_≠s_dñayed_öô
;

63 c⁄° 
mår_›s
 *
	gmår_›s
[
X86_VENDOR_NUM
];

65 c⁄° 
mår_›s
 *
	gmår_if
;

67 
£t_mår
(
ªg
, 
ba£
,

68 
size
, 
mår_ty≥
 
ty≥
);

70 
	$£t_mår_›s
(c⁄° 
mår_›s
 *
›s
)

72 i‡(
›s
->
víd‹
 && ops->víd‹ < 
X86_VENDOR_NUM
)

73 
mår_›s
[
›s
->
víd‹
] = ops;

74 
	}
}

77 
	$have_wrcomb
()

79 
pci_dev
 *
dev
;

80 
u8
 
ªv
;

82 
dev
 = 
	`pci_gë_˛ass
(
PCI_CLASS_BRIDGE_HOST
 << 8, 
NULL
);

83 i‡(
dev
 !
NULL
) {

89 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_SERVERWORKS
 &&

90 
dev
->
devi˚
 =
PCI_DEVICE_ID_SERVERWORKS_LE
) {

91 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

92 i‡(
ªv
 <= 5) {

93 
	`¥_öfo
("mtrr: Serverworks LEÑev < 6 detected. Write-combining disabled.\n");

94 
	`pci_dev_put
(
dev
);

102 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_INTEL
 &&

103 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTEL_82451NX
) {

104 
	`¥_öfo
("mtrr: Intel 450NX MMC detected. Write-combining disabled.\n");

105 
	`pci_dev_put
(
dev
);

108 
	`pci_dev_put
(
dev
);

110  
mår_if
->
have_wrcomb
 ? mår_if->
	`have_wrcomb
() : 0;

111 
	}
}

114 
__öô
 
	$£t_num_v¨_ønges
()

116 
c⁄fig
 = 0, 
dummy
;

118 i‡(
	`u£_öãl
())

119 
	`rdm§
(
MSR_MTRRˇp
, 
c⁄fig
, 
dummy
);

120 i‡(
	`is_˝u
(
AMD
))

121 
c⁄fig
 = 2;

122 i‡(
	`is_˝u
(
CYRIX
Ë|| is_˝u(
CENTAUR
))

123 
c⁄fig
 = 8;

125 
num_v¨_ønges
 = 
c⁄fig
 & 0xff;

126 
	}
}

128 
__öô
 
	$öô_èbÀ
()

130 
i
, 
max
;

132 
max
 = 
num_v¨_ønges
;

133 
i
 = 0; i < 
max
; i++)

134 
mår_ußge_èbÀ
[
i
] = 1;

135 
	}
}

137 
	s£t_mår_d©a
 {

138 
©omic_t
 
	mcou¡
;

139 
©omic_t
 
	mg©e
;

140 
	msmp_ba£
;

141 
	msmp_size
;

142 
	msmp_ªg
;

143 
mår_ty≥
 
	msmp_ty≥
;

152 
	$ùi_h™dÀr
(*
öfo
)

154 #ifde‡
CONFIG_SMP


155 
£t_mår_d©a
 *
d©a
 = 
öfo
;

156 
Êags
;

158 
	`loˇl_úq_ßve
(
Êags
);

160 
	`©omic_dec
(&
d©a
->
cou¡
);

161 !
	`©omic_ªad
(&
d©a
->
g©e
))

162 
	`˝u_ªœx
();

165 i‡(
d©a
->
smp_ªg
 != ~0U) {

166 
mår_if
->
	`£t
(
d©a
->
smp_ªg
, d©a->
smp_ba£
,

167 
d©a
->
smp_size
, d©a->
smp_ty≥
);

168 } i‡(
mår_≠s_dñayed_öô
) {

172 
mår_if
->
	`£t_Æl
();

175 
	`©omic_dec
(&
d©a
->
cou¡
);

176 
	`©omic_ªad
(&
d©a
->
g©e
))

177 
	`˝u_ªœx
();

179 
	`©omic_dec
(&
d©a
->
cou¡
);

180 
	`loˇl_úq_ª°‹e
(
Êags
);

182 
	}
}

184 
ölöe
 
	$ty≥s_com∑tibÀ
(
mår_ty≥
 
ty≥1
, mår_ty≥ 
ty≥2
)

186  
ty≥1
 =
MTRR_TYPE_UNCACHABLE
 ||

187 
ty≥2
 =
MTRR_TYPE_UNCACHABLE
 ||

188 (
ty≥1
 =
MTRR_TYPE_WRTHROUGH
 && 
ty≥2
 =
MTRR_TYPE_WRBACK
) ||

189 (
ty≥1
 =
MTRR_TYPE_WRBACK
 && 
ty≥2
 =
MTRR_TYPE_WRTHROUGH
);

190 
	}
}

233 
	$£t_mår
(
ªg
, 
ba£
, 
size
, 
mår_ty≥
 
ty≥
)

235 
£t_mår_d©a
 
d©a
;

236 
Êags
;

238 
d©a
.
smp_ªg
 = 
ªg
;

239 
d©a
.
smp_ba£
 = 
ba£
;

240 
d©a
.
smp_size
 = 
size
;

241 
d©a
.
smp_ty≥
 = 
ty≥
;

242 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

245 
	`smp_wmb
();

246 
	`©omic_£t
(&
d©a
.
g©e
, 0);

249 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_h™dÀr
, &
d©a
, 0) != 0)

250 
	`∑nic
("mtrr:Åimed out waiting for other CPUs\n");

252 
	`loˇl_úq_ßve
(
Êags
);

254 
	`©omic_ªad
(&
d©a
.
cou¡
))

255 
	`˝u_ªœx
();

258 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

259 
	`smp_wmb
();

260 
	`©omic_£t
(&
d©a
.
g©e
, 1);

271 i‡(
ªg
 != ~0U)

272 
mår_if
->
	`£t
(
ªg
, 
ba£
, 
size
, 
ty≥
);

273 i‡(!
mår_≠s_dñayed_öô
)

274 
mår_if
->
	`£t_Æl
();

277 
	`©omic_ªad
(&
d©a
.
cou¡
))

278 
	`˝u_ªœx
();

280 
	`©omic_£t
(&
d©a
.
cou¡
, 
	`num_boŸög_˝us
() - 1);

281 
	`smp_wmb
();

282 
	`©omic_£t
(&
d©a
.
g©e
, 0);

288 
	`©omic_ªad
(&
d©a
.
cou¡
))

289 
	`˝u_ªœx
();

291 
	`loˇl_úq_ª°‹e
(
Êags
);

292 
	}
}

329 
	$mår_add_∑ge
(
ba£
, 
size
,

330 
ty≥
, 
boﬁ
 
ö¸emít
)

332 
lba£
, 
lsize
;

333 
i
, 
ª∂a˚
, 
îr‹
;

334 
mår_ty≥
 
…y≥
;

336 i‡(!
mår_if
)

337  -
ENXIO
;

339 
îr‹
 = 
mår_if
->
	`vÆid©e_add_∑ge
(
ba£
, 
size
, 
ty≥
);

340 i‡(
îr‹
)

341  
îr‹
;

343 i‡(
ty≥
 >
MTRR_NUM_TYPES
) {

344 
	`¥_w¨nög
("mår:Åy≥: %u invÆid\n", 
ty≥
);

345  -
EINVAL
;

349 i‡((
ty≥
 =
MTRR_TYPE_WRCOMB
Ë&& !
	`have_wrcomb
()) {

350 
	`¥_w¨nög
("mtrr: yourÖrocessor doesn't support write-combining\n");

351  -
ENOSYS
;

354 i‡(!
size
) {

355 
	`¥_w¨nög
("mtrr: zero sizedÑequest\n");

356  -
EINVAL
;

359 i‡(
ba£
 & 
size_‹_mask
 || 
size
 & size_or_mask) {

360 
	`¥_w¨nög
("mtrr: base or sizeÉxceedsÅhe MTRR width\n");

361  -
EINVAL
;

364 
îr‹
 = -
EINVAL
;

365 
ª∂a˚
 = -1;

368 
	`gë_⁄löe_˝us
();

371 
	`muãx_lock
(&
mår_muãx
);

372 
i
 = 0; i < 
num_v¨_ønges
; ++i) {

373 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

374 i‡(!
lsize
 || 
ba£
 > 
lba£
 +Üsize - 1 ||

375 
ba£
 + 
size
 - 1 < 
lba£
)

381 i‡(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >Üba£ + 
lsize
 - 1) {

382 i‡(
ba£
 <
lba£
 &&

383 
ba£
 + 
size
 - 1 >
lba£
 + 
lsize
 - 1) {

385 i‡(
ty≥
 =
…y≥
) {

386 
ª∂a˚
 =Ñïœ˚ =-1 ? 
i
 : -2;

388 } i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

391 
	`¥_w¨nög
("mtrr: 0x%lx000,0x%lx000 overlapsÉxisting"

392 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

393 
lsize
);

394 
out
;

397 i‡(
…y≥
 !
ty≥
) {

398 i‡(
	`ty≥s_com∑tibÀ
(
ty≥
, 
…y≥
))

400 
	`¥_w¨nög
("mtrr:Åype mismatch for %lx000,%lx000 old: %sÇew: %s\n",

401 
ba£
, 
size
, 
	`mår_©åib_to_°r
(
…y≥
),

402 
	`mår_©åib_to_°r
(
ty≥
));

403 
out
;

405 i‡(
ö¸emít
)

406 ++
mår_ußge_èbÀ
[
i
];

407 
îr‹
 = 
i
;

408 
out
;

411 
i
 = 
mår_if
->
	`gë_‰ì_ªgi⁄
(
ba£
, 
size
, 
ª∂a˚
);

412 i‡(
i
 >= 0) {

413 
	`£t_mår
(
i
, 
ba£
, 
size
, 
ty≥
);

414 i‡(
	`likñy
(
ª∂a˚
 < 0)) {

415 
mår_ußge_èbÀ
[
i
] = 1;

417 
mår_ußge_èbÀ
[
i
] = mår_ußge_èbÀ[
ª∂a˚
];

418 i‡(
ö¸emít
)

419 
mår_ußge_èbÀ
[
i
]++;

420 i‡(
	`u∆ikñy
(
ª∂a˚
 !
i
)) {

421 
	`£t_mår
(
ª∂a˚
, 0, 0, 0);

422 
mår_ußge_èbÀ
[
ª∂a˚
] = 0;

426 
	`¥_öfo
("mtrr:Ço more MTRRsávailable\n");

428 
îr‹
 = 
i
;

429 
out
:

430 
	`muãx_u∆ock
(&
mår_muãx
);

431 
	`put_⁄löe_˝us
();

432  
îr‹
;

433 
	}
}

435 
	$mår_check
(
ba£
, 
size
)

437 i‡((
ba£
 & (
PAGE_SIZE
 - 1)Ë|| (
size
 & (PAGE_SIZE - 1))) {

438 
	`¥_w¨nög
("mtrr: sizeánd base must be multiples of 4 kiB\n");

439 
	`¥_debug
("mår: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

440 
	`dump_°ack
();

444 
	}
}

481 
	$mår_add
(
ba£
, 
size
, 
ty≥
,

482 
boﬁ
 
ö¸emít
)

484 i‡(
	`mår_check
(
ba£
, 
size
))

485  -
EINVAL
;

486  
	`mår_add_∑ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty≥
,

487 
ö¸emít
);

488 
	}
}

489 
EXPORT_SYMBOL
(
mår_add
);

505 
	$mår_dñ_∑ge
(
ªg
, 
ba£
, 
size
)

507 
i
, 
max
;

508 
mår_ty≥
 
…y≥
;

509 
lba£
, 
lsize
;

510 
îr‹
 = -
EINVAL
;

512 i‡(!
mår_if
)

513  -
ENXIO
;

515 
max
 = 
num_v¨_ønges
;

517 
	`gë_⁄löe_˝us
();

518 
	`muãx_lock
(&
mår_muãx
);

519 i‡(
ªg
 < 0) {

521 
i
 = 0; i < 
max
; ++i) {

522 
mår_if
->
	`gë
(
i
, &
lba£
, &
lsize
, &
…y≥
);

523 i‡(
lba£
 =
ba£
 && 
lsize
 =
size
) {

524 
ªg
 = 
i
;

528 i‡(
ªg
 < 0) {

529 
	`¥_debug
("mtrr:Ço MTRR for %lx000,%lx000 found\n",

530 
ba£
, 
size
);

531 
out
;

534 i‡(
ªg
 >
max
) {

535 
	`¥_w¨nög
("mår:Ñegi°î: %dÅoÿbig\n", 
ªg
);

536 
out
;

538 
mår_if
->
	`gë
(
ªg
, &
lba£
, &
lsize
, &
…y≥
);

539 i‡(
lsize
 < 1) {

540 
	`¥_w¨nög
("mår: MTRR %dÇŸ u£d\n", 
ªg
);

541 
out
;

543 i‡(
mår_ußge_èbÀ
[
ªg
] < 1) {

544 
	`¥_w¨nög
("mår:Ñeg: %d ha†cou¡=0\n", 
ªg
);

545 
out
;

547 i‡(--
mår_ußge_èbÀ
[
ªg
] < 1)

548 
	`£t_mår
(
ªg
, 0, 0, 0);

549 
îr‹
 = 
ªg
;

550 
out
:

551 
	`muãx_u∆ock
(&
mår_muãx
);

552 
	`put_⁄löe_˝us
();

553  
îr‹
;

554 
	}
}

570 
	$mår_dñ
(
ªg
, 
ba£
, 
size
)

572 i‡(
	`mår_check
(
ba£
, 
size
))

573  -
EINVAL
;

574  
	`mår_dñ_∑ge
(
ªg
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

575 
	}
}

576 
EXPORT_SYMBOL
(
mår_dñ
);

583 
__öô
 
	$öô_ifs
()

585 #i‚de‡
CONFIG_X86_64


586 
	`amd_öô_mår
();

587 
	`cyrix_öô_mår
();

588 
	`˚¡aur_öô_mår
();

590 
	}
}

595 
	smår_vÆue
 {

596 
mår_ty≥
 
	m…y≥
;

597 
	mlba£
;

598 
	mlsize
;

601 
mår_vÆue
 
	gmår_vÆue
[
MTRR_MAX_VAR_RANGES
];

603 
	$mår_ßve
(
sys_devi˚
 *
sysdev
, 
pm_mesßge_t
 
°©e
)

605 
i
;

607 
i
 = 0; i < 
num_v¨_ønges
; i++) {

608 
mår_if
->
	`gë
(
i
, &
mår_vÆue
[i].
lba£
,

609 &
mår_vÆue
[
i
].
lsize
,

610 &
mår_vÆue
[
i
].
…y≥
);

613 
	}
}

615 
	$mår_ª°‹e
(
sys_devi˚
 *
sysdev
)

617 
i
;

619 
i
 = 0; i < 
num_v¨_ønges
; i++) {

620 i‡(
mår_vÆue
[
i
].
lsize
) {

621 
	`£t_mår
(
i
, 
mår_vÆue
[i].
lba£
,

622 
mår_vÆue
[
i
].
lsize
,

623 
mår_vÆue
[
i
].
…y≥
);

627 
	}
}

631 
sysdev_drivî
 
	gmår_sysdev_drivî
 = {

632 .
su•íd
 = 
mår_ßve
,

633 .
	gªsume
 = 
mår_ª°‹e
,

636 
__öôd©a
 
	gch™ged_by_mår_˛ónup
;

645 
__öô
 
	$mår_bp_öô
()

647 
u32
 
phys_addr
;

649 
	`öô_ifs
();

651 
phys_addr
 = 32;

653 i‡(
˝u_has_mår
) {

654 
mår_if
 = &
gíîic_mår_›s
;

655 
size_‹_mask
 = 0xff000000;

656 
size_™d_mask
 = 0x00f00000;

657 
phys_addr
 = 36;

664 i‡(
	`˝uid_óx
(0x80000000) >= 0x80000008) {

665 
phys_addr
 = 
	`˝uid_óx
(0x80000008) & 0xff;

667 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_INTEL
 &&

668 
boŸ_˝u_d©a
.
x86
 == 0xF &&

669 
boŸ_˝u_d©a
.
x86_modñ
 == 0x3 &&

670 (
boŸ_˝u_d©a
.
x86_mask
 == 0x3 ||

671 
boŸ_˝u_d©a
.
x86_mask
 == 0x4))

672 
phys_addr
 = 36;

674 
size_‹_mask
 = ~((1ULL << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

675 
size_™d_mask
 = ~
size_‹_mask
 & 0xfffff00000ULL;

676 } i‡(
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_CENTAUR
 &&

677 
boŸ_˝u_d©a
.
x86
 == 6) {

682 
size_‹_mask
 = 0xfff00000;

683 
size_™d_mask
 = 0;

684 
phys_addr
 = 32;

687 
boŸ_˝u_d©a
.
x86_víd‹
) {

688 
X86_VENDOR_AMD
:

689 i‡(
˝u_has_k6_mår
) {

691 
mår_if
 = 
mår_›s
[
X86_VENDOR_AMD
];

692 
size_‹_mask
 = 0xfff00000;

693 
size_™d_mask
 = 0;

696 
X86_VENDOR_CENTAUR
:

697 i‡(
˝u_has_˚¡aur_m¸
) {

698 
mår_if
 = 
mår_›s
[
X86_VENDOR_CENTAUR
];

699 
size_‹_mask
 = 0xfff00000;

700 
size_™d_mask
 = 0;

703 
X86_VENDOR_CYRIX
:

704 i‡(
˝u_has_cyrix_¨r
) {

705 
mår_if
 = 
mår_›s
[
X86_VENDOR_CYRIX
];

706 
size_‹_mask
 = 0xfff00000;

707 
size_™d_mask
 = 0;

715 i‡(
mår_if
) {

716 
	`£t_num_v¨_ønges
();

717 
	`öô_èbÀ
();

718 i‡(
	`u£_öãl
()) {

719 
	`gë_mår_°©e
();

721 i‡(
	`mår_˛ónup
(
phys_addr
)) {

722 
ch™ged_by_mår_˛ónup
 = 1;

723 
mår_if
->
	`£t_Æl
();

727 
	}
}

729 
	$mår_≠_öô
()

731 i‡(!
	`u£_öãl
(Ë|| 
mår_≠s_dñayed_öô
)

746 
	`£t_mår
(~0U, 0, 0, 0);

747 
	}
}

752 
	$mår_ßve_°©e
()

754 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(0, 
mår_ßve_fixed_ønges
, 
NULL
, 1);

755 
	}
}

757 
	$£t_mår_≠s_dñayed_öô
()

759 i‡(!
	`u£_öãl
())

762 
mår_≠s_dñayed_öô
 = 
åue
;

763 
	}
}

768 
	$mår_≠s_öô
()

770 i‡(!
	`u£_öãl
())

773 
	`£t_mår
(~0U, 0, 0, 0);

774 
mår_≠s_dñayed_öô
 = 
Ál£
;

775 
	}
}

777 
	$mår_bp_ª°‹e
()

779 i‡(!
	`u£_öãl
())

782 
mår_if
->
	`£t_Æl
();

783 
	}
}

785 
__öô
 
	$mår_öô_föülize
()

787 i‡(!
mår_if
)

790 i‡(
	`u£_öãl
()) {

791 i‡(!
ch™ged_by_mår_˛ónup
)

792 
	`mår_°©e_w¨n
();

804 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mår_sysdev_drivî
);

807 
	}
}

808 
subsys_öôˇŒ
(
mår_öô_föülize
);

	@/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c

15 
	~<löux/≥rf_evít.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/nŸifõr.h
>

18 
	~<löux/h¨dúq.h
>

19 
	~<löux/k¥obes.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/kdebug.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/uac˚ss.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/highmem.h
>

26 
	~<löux/˝u.h
>

27 
	~<löux/bô›s.h
>

29 
	~<asm/≠ic.h
>

30 
	~<asm/°ackåa˚.h
>

31 
	~<asm/nmi.h
>

32 
	~<asm/com∑t.h
>

35 #unde‡
wrm§l


36 
	#wrm§l
(
m§
, 
vÆ
) \

38 
	`åa˚_¥ötk
("wrm§l(%lx, %lx)\n", ()(
m§
),\

39 ()(
vÆ
)); \

40 
	`«tive_wrôe_m§
((
m§
), (
u32
)((
u64
)(
vÆ
)), \

41 (
u32
)((
u64
)(
vÆ
) >> 32)); \

42 } 0)

	)

49 
	$c›y_‰om_u£r_nmi
(*
to
, c⁄° 
__u£r
 *
‰om
, 
n
)

51 
off£t
, 
addr
 = ()
‰om
;

52 
ty≥
 = 
	`ö_nmi
(Ë? 
KM_NMI
 : 
KM_IRQ0
;

53 
size
, 
Àn
 = 0;

54 
∑ge
 *page;

55 *
m≠
;

56 
ªt
;

59 
ªt
 = 
	`__gë_u£r_∑ges_Á°
(
addr
, 1, 0, &
∑ge
);

60 i‡(!
ªt
)

63 
off£t
 = 
addr
 & (
PAGE_SIZE
 - 1);

64 
size
 = 
	`mö
(
PAGE_SIZE
 - 
off£t
, 
n
 - 
Àn
);

66 
m≠
 = 
	`km≠_©omic
(
∑ge
, 
ty≥
);

67 
	`mem˝y
(
to
, 
m≠
+
off£t
, 
size
);

68 
	`kunm≠_©omic
(
m≠
, 
ty≥
);

69 
	`put_∑ge
(
∑ge
);

71 
Àn
 +
size
;

72 
to
 +
size
;

73 
addr
 +
size
;

75 } 
Àn
 < 
n
);

77  
Àn
;

78 
	}
}

80 
	sevít_c⁄°øöt
 {

82 
	midxmsk
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

83 
u64
 
	midxmsk64
;

85 
u64
 
	mcode
;

86 
u64
 
	mcmask
;

87 
	mweight
;

90 
	samd_nb
 {

91 
	mnb_id
;

92 
	mªf˙t
;

93 
≥rf_evít
 *
	mow√rs
[
X86_PMC_IDX_MAX
];

94 
evít_c⁄°øöt
 
	mevít_c⁄°øöts
[
X86_PMC_IDX_MAX
];

97 
	#MAX_LBR_ENTRIES
 16

	)

99 
	s˝u_hw_evíts
 {

103 
≥rf_evít
 *
	mevíts
[
X86_PMC_IDX_MAX
];

104 
	ma˘ive_mask
[
BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

105 
	míabÀd
;

107 
	mn_evíts
;

108 
	mn_added
;

109 
	mn_txn
;

110 
	massign
[
X86_PMC_IDX_MAX
];

111 
u64
 
	mègs
[
X86_PMC_IDX_MAX
];

112 
≥rf_evít
 *
	mevít_li°
[
X86_PMC_IDX_MAX
];

114 
	mgroup_Êag
;

119 
debug_°‹e
 *
	mds
;

120 
u64
 
	m≥bs_íabÀd
;

125 
	mlbr_u£rs
;

126 *
	mlbr_c⁄ãxt
;

127 
≥rf_bønch_°ack
 
	mlbr_°ack
;

128 
≥rf_bønch_íåy
 
	mlbr_íåõs
[
MAX_LBR_ENTRIES
];

133 
amd_nb
 *
	mamd_nb
;

136 
	#__EVENT_CONSTRAINT
(
c
, 
n
, 
m
, 
w
) {\

137 { .
idxmsk64
 = (
n
) }, \

138 .
code
 = (
c
), \

139 .
cmask
 = (
m
), \

140 .
weight
 = (
w
), \

141 }

	)

143 
	#EVENT_CONSTRAINT
(
c
, 
n
, 
m
) \

144 
	`__EVENT_CONSTRAINT
(
c
, 
n
, 
m
, 
	`HWEIGHT
“))

	)

149 
	#INTEL_EVENT_CONSTRAINT
(
c
, 
n
) \

150 
	`EVENT_CONSTRAINT
(
c
, 
n
, 
ARCH_PERFMON_EVENTSEL_EVENT
)

	)

163 
	#FIXED_EVENT_CONSTRAINT
(
c
, 
n
) \

164 
	`EVENT_CONSTRAINT
(
c
, (1ULL << (32+
n
)), 
X86_RAW_EVENT_MASK
)

	)

169 
	#PEBS_EVENT_CONSTRAINT
(
c
, 
n
) \

170 
	`EVENT_CONSTRAINT
(
c
, 
n
, 
INTEL_ARCH_EVENT_MASK
)

	)

172 
	#EVENT_CONSTRAINT_END
 \

173 
	`EVENT_CONSTRAINT
(0, 0, 0)

	)

175 
	#f‹_óch_evít_c⁄°øöt
(
e
, 
c
) \

176 (
e
Ë(
c
); (e)->
weight
; (e)++)

	)

178 
	u≥rf_ˇ∑bûôõs
 {

180 
u64
 
	mlbr_f‹m©
 : 6;

181 
u64
 
	m≥bs_å≠
 : 1;

182 
u64
 
	m≥bs_¨ch_ªg
 : 1;

183 
u64
 
	m≥bs_f‹m©
 : 4;

184 
u64
 
	msmm_‰ìze
 : 1;

186 
u64
 
	mˇ∑bûôõs
;

192 
	sx86_pmu
 {

196 c⁄° *
	m«me
;

197 
	mvîsi⁄
;

198 (*
	mh™dÀ_úq
)(
	m±_ªgs
 *);

199 (*
	mdißbÀ_Æl
)();

200 (*
	míabÀ_Æl
)(
	madded
);

201 (*
	míabÀ
)(
	m≥rf_evít
 *);

202 (*
	mdißbÀ
)(
	m≥rf_evít
 *);

203 (*
	mhw_c⁄fig
)(
≥rf_evít
 *
	mevít
);

204 (*
	mscheduÀ_evíts
)(
˝u_hw_evíts
 *
	m˝uc
, 
	mn
, *
	massign
);

205 
	mevít£l
;

206 
	m≥rf˘r
;

207 
u64
 (*
evít_m≠
)();

208 
	mmax_evíts
;

209 
	mnum_cou¡îs
;

210 
	mnum_cou¡îs_fixed
;

211 
	m˙tvÆ_bôs
;

212 
u64
 
	m˙tvÆ_mask
;

213 
	m≠ic
;

214 
u64
 
	mmax_≥riod
;

215 
	mevít_c⁄°øöt
 *

216 (*
	mgë_evít_c⁄°øöts
)(
˝u_hw_evíts
 *
	m˝uc
,

217 
≥rf_evít
 *
	mevít
);

219 (*
	mput_evít_c⁄°øöts
)(
˝u_hw_evíts
 *
	m˝uc
,

220 
≥rf_evít
 *
	mevít
);

221 
evít_c⁄°øöt
 *
	mevít_c⁄°øöts
;

222 (*
	mquúks
)();

224 (*
	m˝u_¥ï¨e
)(
	m˝u
);

225 (*
	m˝u_°¨tög
)(
	m˝u
);

226 (*
	m˝u_dyög
)(
	m˝u
);

227 (*
	m˝u_dód
)(
	m˝u
);

232 
u64
 
	möãl_˘æ
;

233 
≥rf_ˇ∑bûôõs
 
	möãl_ˇp
;

238 
	mbts
, 
	m≥bs
;

239 
	m≥bs_ªc‹d_size
;

240 (*
	mdøö_≥bs
)(
±_ªgs
 *
	mªgs
);

241 
evít_c⁄°øöt
 *
	m≥bs_c⁄°øöts
;

246 
	mlbr_tos
, 
	mlbr_‰om
, 
	mlbr_to
;

247 
	mlbr_ƒ
;

250 
x86_pmu
 x86_pmu 
	g__ªad_mo°ly
;

252 
DEFINE_PER_CPU
(
˝u_hw_evíts
, cpu_hw_events) = {

253 .
íabÀd
 = 1,

256 
x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
);

266 
	#C
(
x
Ë
PERF_COUNT_HW_CACHE_
##
	)
x

268 
u64
 
__ªad_mo°ly
 
	ghw_ˇche_evít_ids


269 [
PERF_COUNT_HW_CACHE_MAX
]

270 [
PERF_COUNT_HW_CACHE_OP_MAX
]

271 [
PERF_COUNT_HW_CACHE_RESULT_MAX
];

278 
u64


279 
	$x86_≥rf_evít_upd©e
(
≥rf_evít
 *
evít
)

281 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

282 
shi·
 = 64 - 
x86_pmu
.
˙tvÆ_bôs
;

283 
u64
 
¥ev_øw_cou¡
, 
√w_øw_cou¡
;

284 
idx
 = 
hwc
->idx;

285 
s64
 
dñè
;

287 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

297 
agaö
:

298 
¥ev_øw_cou¡
 = 
	`©omic64_ªad
(&
hwc
->
¥ev_cou¡
);

299 
	`rdm§l
(
hwc
->
evít_ba£
 + 
idx
, 
√w_øw_cou¡
);

301 i‡(
	`©omic64_cmpxchg
(&
hwc
->
¥ev_cou¡
, 
¥ev_øw_cou¡
,

302 
√w_øw_cou¡
Ë!
¥ev_øw_cou¡
)

303 
agaö
;

313 
dñè
 = (
√w_øw_cou¡
 << 
shi·
Ë- (
¥ev_øw_cou¡
 << shift);

314 
dñè
 >>
shi·
;

316 
	`©omic64_add
(
dñè
, &
evít
->
cou¡
);

317 
	`©omic64_sub
(
dñè
, &
hwc
->
≥riod_À·
);

319  
√w_øw_cou¡
;

320 
	}
}

322 
©omic_t
 
	ga˘ive_evíts
;

323 
DEFINE_MUTEX
(
pmc_ª£rve_muãx
);

325 #ifde‡
CONFIG_X86_LOCAL_APIC


327 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
()

329 
i
;

331 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

332 
	`dißbÀ_œpic_nmi_w©chdog
();

334 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

335 i‡(!
	`ª£rve_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
))

336 
≥rf˘r_Áû
;

339 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

340 i‡(!
	`ª£rve_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
))

341 
evít£l_Áû
;

344  
åue
;

346 
evít£l_Áû
:

347 
i
--; i >= 0; i--)

348 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

350 
i
 = 
x86_pmu
.
num_cou¡îs
;

352 
≥rf˘r_Áû
:

353 
i
--; i >= 0; i--)

354 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

356 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

357 
	`íabÀ_œpic_nmi_w©chdog
();

359  
Ál£
;

360 
	}
}

362 
	$ªÀa£_pmc_h¨dw¨e
()

364 
i
;

366 
i
 = 0; i < 
x86_pmu
.
num_cou¡îs
; i++) {

367 
	`ªÀa£_≥rf˘r_nmi
(
x86_pmu
.
≥rf˘r
 + 
i
);

368 
	`ªÀa£_ev¡£l_nmi
(
x86_pmu
.
evít£l
 + 
i
);

371 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

372 
	`íabÀ_œpic_nmi_w©chdog
();

373 
	}
}

377 
boﬁ
 
	$ª£rve_pmc_h¨dw¨e
(Ë{  
åue
; 
	}
}

378 
	$ªÀa£_pmc_h¨dw¨e
(Ë{
	}
}

382 
ª£rve_ds_buf„rs
();

383 
ªÀa£_ds_buf„rs
();

385 
	$hw_≥rf_evít_de°roy
(
≥rf_evít
 *
evít
)

387 i‡(
	`©omic_dec_™d_muãx_lock
(&
a˘ive_evíts
, &
pmc_ª£rve_muãx
)) {

388 
	`ªÀa£_pmc_h¨dw¨e
();

389 
	`ªÀa£_ds_buf„rs
();

390 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

392 
	}
}

394 
ölöe
 
	$x86_pmu_öôülized
()

396  
x86_pmu
.
h™dÀ_úq
 !
NULL
;

397 
	}
}

399 
ölöe
 

400 
	$£t_ext_hw_©å
(
hw_≥rf_evít
 *
hwc
, 
≥rf_evít_©å
 *
©å
)

402 
ˇche_ty≥
, 
ˇche_›
, 
ˇche_ªsu…
;

403 
u64
 
c⁄fig
, 
vÆ
;

405 
c⁄fig
 = 
©å
->config;

407 
ˇche_ty≥
 = (
c⁄fig
 >> 0) & 0xff;

408 i‡(
ˇche_ty≥
 >
PERF_COUNT_HW_CACHE_MAX
)

409  -
EINVAL
;

411 
ˇche_›
 = (
c⁄fig
 >> 8) & 0xff;

412 i‡(
ˇche_›
 >
PERF_COUNT_HW_CACHE_OP_MAX
)

413  -
EINVAL
;

415 
ˇche_ªsu…
 = (
c⁄fig
 >> 16) & 0xff;

416 i‡(
ˇche_ªsu…
 >
PERF_COUNT_HW_CACHE_RESULT_MAX
)

417  -
EINVAL
;

419 
vÆ
 = 
hw_ˇche_evít_ids
[
ˇche_ty≥
][
ˇche_›
][
ˇche_ªsu…
];

421 i‡(
vÆ
 == 0)

422  -
ENOENT
;

424 i‡(
vÆ
 == -1)

425  -
EINVAL
;

427 
hwc
->
c⁄fig
 |
vÆ
;

430 
	}
}

432 
	$x86_£tup_≥rf˘r
(
≥rf_evít
 *
evít
)

434 
≥rf_evít_©å
 *
©å
 = &
evít
->attr;

435 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

436 
u64
 
c⁄fig
;

438 i‡(!
hwc
->
ßm∂e_≥riod
) {

439 
hwc
->
ßm∂e_≥riod
 = 
x86_pmu
.
max_≥riod
;

440 
hwc
->
œ°_≥riod
 = hwc->
ßm∂e_≥riod
;

441 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, hwc->
ßm∂e_≥riod
);

449 i‡(!
x86_pmu
.
≠ic
)

450  -
EOPNOTSUPP
;

453 i‡(
©å
->
ty≥
 =
PERF_TYPE_RAW
)

456 i‡(
©å
->
ty≥
 =
PERF_TYPE_HW_CACHE
)

457  
	`£t_ext_hw_©å
(
hwc
, 
©å
);

459 i‡(
©å
->
c⁄fig
 >
x86_pmu
.
max_evíts
)

460  -
EINVAL
;

465 
c⁄fig
 = 
x86_pmu
.
	`evít_m≠
(
©å
->config);

467 i‡(
c⁄fig
 == 0)

468  -
ENOENT
;

470 i‡(
c⁄fig
 == -1LL)

471  -
EINVAL
;

476 i‡((
©å
->
c⁄fig
 =
PERF_COUNT_HW_BRANCH_INSTRUCTIONS
) &&

477 (
hwc
->
ßm∂e_≥riod
 == 1)) {

479 i‡(!
x86_pmu
.
bts
)

480  -
EOPNOTSUPP
;

483 i‡(!
©å
->
ex˛ude_kî√l
)

484  -
EOPNOTSUPP
;

487 
hwc
->
c⁄fig
 |= config;

490 
	}
}

492 
	$x86_pmu_hw_c⁄fig
(
≥rf_evít
 *
evít
)

494 i‡(
evít
->
©å
.
¥eci£_ù
) {

495 
¥eci£
 = 0;

498 i‡(
x86_pmu
.
≥bs
)

499 
¥eci£
++;

502 i‡(
x86_pmu
.
lbr_ƒ
)

503 
¥eci£
++;

505 i‡(
evít
->
©å
.
¥eci£_ù
 > 
¥eci£
)

506  -
EOPNOTSUPP
;

513 
evít
->
hw
.
c⁄fig
 = 
ARCH_PERFMON_EVENTSEL_INT
;

518 i‡(!
evít
->
©å
.
ex˛ude_u£r
)

519 
evít
->
hw
.
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_USR
;

520 i‡(!
evít
->
©å
.
ex˛ude_kî√l
)

521 
evít
->
hw
.
c⁄fig
 |
ARCH_PERFMON_EVENTSEL_OS
;

523 i‡(
evít
->
©å
.
ty≥
 =
PERF_TYPE_RAW
)

524 
evít
->
hw
.
c⁄fig
 |evít->
©å
.c⁄fig & 
X86_RAW_EVENT_MASK
;

526  
	`x86_£tup_≥rf˘r
(
evít
);

527 
	}
}

532 
	$__hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

534 
îr
;

536 i‡(!
	`x86_pmu_öôülized
())

537  -
ENODEV
;

539 
îr
 = 0;

540 i‡(!
	`©omic_öc_nŸ_zîo
(&
a˘ive_evíts
)) {

541 
	`muãx_lock
(&
pmc_ª£rve_muãx
);

542 i‡(
	`©omic_ªad
(&
a˘ive_evíts
) == 0) {

543 i‡(!
	`ª£rve_pmc_h¨dw¨e
())

544 
îr
 = -
EBUSY
;

546 
îr
 = 
	`ª£rve_ds_buf„rs
();

547 i‡(
îr
)

548 
	`ªÀa£_pmc_h¨dw¨e
();

551 i‡(!
îr
)

552 
	`©omic_öc
(&
a˘ive_evíts
);

553 
	`muãx_u∆ock
(&
pmc_ª£rve_muãx
);

555 i‡(
îr
)

556  
îr
;

558 
evít
->
de°roy
 = 
hw_≥rf_evít_de°roy
;

560 
evít
->
hw
.
idx
 = -1;

561 
evít
->
hw
.
œ°_˝u
 = -1;

562 
evít
->
hw
.
œ°_èg
 = ~0ULL;

564  
x86_pmu
.
	`hw_c⁄fig
(
evít
);

565 
	}
}

567 
	$x86_pmu_dißbÀ_Æl
()

569 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

570 
idx
;

572 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

573 
u64
 
vÆ
;

575 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

577 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

578 i‡(!(
vÆ
 & 
ARCH_PERFMON_EVENTSEL_ENABLE
))

580 
vÆ
 &~
ARCH_PERFMON_EVENTSEL_ENABLE
;

581 
	`wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

583 
	}
}

585 
	$hw_≥rf_dißbÀ
()

587 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

589 i‡(!
	`x86_pmu_öôülized
())

592 i‡(!
˝uc
->
íabÀd
)

595 
˝uc
->
n_added
 = 0;

596 
˝uc
->
íabÀd
 = 0;

597 
	`b¨rõr
();

599 
x86_pmu
.
	`dißbÀ_Æl
();

600 
	}
}

602 
	$x86_pmu_íabÀ_Æl
(
added
)

604 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

605 
idx
;

607 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

608 
≥rf_evít
 *
evít
 = 
˝uc
->
evíts
[
idx
];

609 
u64
 
vÆ
;

611 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

614 
vÆ
 = 
evít
->
hw
.
c⁄fig
;

615 
vÆ
 |
ARCH_PERFMON_EVENTSEL_ENABLE
;

616 
	`wrm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
vÆ
);

618 
	}
}

620 c⁄° 
pmu
 
	gpmu
;

622 
ölöe
 
	$is_x86_evít
(
≥rf_evít
 *
evít
)

624  
evít
->
pmu
 == &pmu;

625 
	}
}

627 
	$x86_scheduÀ_evíts
(
˝u_hw_evíts
 *
˝uc
, 
n
, *
assign
)

629 
evít_c⁄°øöt
 *
c
, *
c⁄°øöts
[
X86_PMC_IDX_MAX
];

630 
u£d_mask
[
	`BITS_TO_LONGS
(
X86_PMC_IDX_MAX
)];

631 
i
, 
j
, 
w
, 
wmax
, 
num
 = 0;

632 
hw_≥rf_evít
 *
hwc
;

634 
	`bôm≠_zîo
(
u£d_mask
, 
X86_PMC_IDX_MAX
);

636 
i
 = 0; i < 
n
; i++) {

637 
c
 = 
x86_pmu
.
	`gë_evít_c⁄°øöts
(
˝uc
, cpuc->
evít_li°
[
i
]);

638 
c⁄°øöts
[
i
] = 
c
;

644 
i
 = 0; i < 
n
; i++) {

645 
hwc
 = &
˝uc
->
evít_li°
[
i
]->
hw
;

646 
c
 = 
c⁄°øöts
[
i
];

649 i‡(
hwc
->
idx
 == -1)

653 i‡(!
	`ã°_bô
(
hwc
->
idx
, 
c
->
idxmsk
))

657 i‡(
	`ã°_bô
(
hwc
->
idx
, 
u£d_mask
))

660 
	`__£t_bô
(
hwc
->
idx
, 
u£d_mask
);

661 i‡(
assign
)

662 
assign
[
i
] = 
hwc
->
idx
;

664 i‡(
i
 =
n
)

665 
d⁄e
;

671 
	`bôm≠_zîo
(
u£d_mask
, 
X86_PMC_IDX_MAX
);

682 
wmax
 = 
x86_pmu
.
num_cou¡îs
;

689 i‡(
x86_pmu
.
num_cou¡îs_fixed
)

690 
wmax
++;

692 
w
 = 1, 
num
 = 
n
;Çum && w <
wmax
; w++) {

694 
i
 = 0; 
num
 && i < 
n
; i++) {

695 
c
 = 
c⁄°øöts
[
i
];

696 
hwc
 = &
˝uc
->
evít_li°
[
i
]->
hw
;

698 i‡(
c
->
weight
 !
w
)

701 
	`f‹_óch_£t_bô
(
j
, 
c
->
idxmsk
, 
X86_PMC_IDX_MAX
) {

702 i‡(!
	`ã°_bô
(
j
, 
u£d_mask
))

706 i‡(
j
 =
X86_PMC_IDX_MAX
)

709 
	`__£t_bô
(
j
, 
u£d_mask
);

711 i‡(
assign
)

712 
assign
[
i
] = 
j
;

713 
num
--;

716 
d⁄e
:

721 i‡(!
assign
 || 
num
) {

722 
i
 = 0; i < 
n
; i++) {

723 i‡(
x86_pmu
.
put_evít_c⁄°øöts
)

724 
x86_pmu
.
	`put_evít_c⁄°øöts
(
˝uc
, cpuc->
evít_li°
[
i
]);

727  
num
 ? -
ENOSPC
 : 0;

728 
	}
}

734 
	$cﬁÀ˘_evíts
(
˝u_hw_evíts
 *
˝uc
, 
≥rf_evít
 *
Àadî
, 
boﬁ
 
dogΩ
)

736 
≥rf_evít
 *
evít
;

737 
n
, 
max_cou¡
;

739 
max_cou¡
 = 
x86_pmu
.
num_cou¡îs
 + x86_pmu.
num_cou¡îs_fixed
;

742 
n
 = 
˝uc
->
n_evíts
;

744 i‡(
	`is_x86_evít
(
Àadî
)) {

745 i‡(
n
 >
max_cou¡
)

746  -
ENOSPC
;

747 
˝uc
->
evít_li°
[
n
] = 
Àadî
;

748 
n
++;

750 i‡(!
dogΩ
)

751  
n
;

753 
	`li°_f‹_óch_íåy
(
evít
, &
Àadî
->
siblög_li°
, 
group_íåy
) {

754 i‡(!
	`is_x86_evít
(
evít
) ||

755 
evít
->
°©e
 <
PERF_EVENT_STATE_OFF
)

758 i‡(
n
 >
max_cou¡
)

759  -
ENOSPC
;

761 
˝uc
->
evít_li°
[
n
] = 
evít
;

762 
n
++;

764  
n
;

765 
	}
}

767 
ölöe
 
	$x86_assign_hw_evít
(
≥rf_evít
 *
evít
,

768 
˝u_hw_evíts
 *
˝uc
, 
i
)

770 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

772 
hwc
->
idx
 = 
˝uc
->
assign
[
i
];

773 
hwc
->
œ°_˝u
 = 
	`smp_¥o˚ss‹_id
();

774 
hwc
->
œ°_èg
 = ++
˝uc
->
ègs
[
i
];

776 i‡(
hwc
->
idx
 =
X86_PMC_IDX_FIXED_BTS
) {

777 
hwc
->
c⁄fig_ba£
 = 0;

778 
hwc
->
evít_ba£
 = 0;

779 } i‡(
hwc
->
idx
 >
X86_PMC_IDX_FIXED
) {

780 
hwc
->
c⁄fig_ba£
 = 
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
;

785 
hwc
->
evít_ba£
 =

786 
MSR_ARCH_PERFMON_FIXED_CTR0
 - 
X86_PMC_IDX_FIXED
;

788 
hwc
->
c⁄fig_ba£
 = 
x86_pmu
.
evít£l
;

789 
hwc
->
evít_ba£
 = 
x86_pmu
.
≥rf˘r
;

791 
	}
}

793 
ölöe
 
	$m©ch_¥ev_assignmít
(
hw_≥rf_evít
 *
hwc
,

794 
˝u_hw_evíts
 *
˝uc
,

795 
i
)

797  
hwc
->
idx
 =
˝uc
->
assign
[
i
] &&

798 
hwc
->
œ°_˝u
 =
	`smp_¥o˚ss‹_id
() &&

799 
hwc
->
œ°_èg
 =
˝uc
->
ègs
[
i
];

800 
	}
}

802 
x86_pmu_°¨t
(
≥rf_evít
 *
evít
);

803 
x86_pmu_°›
(
≥rf_evít
 *
evít
);

805 
	$hw_≥rf_íabÀ
()

807 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

808 
≥rf_evít
 *
evít
;

809 
hw_≥rf_evít
 *
hwc
;

810 
i
, 
added
 = 
˝uc
->
n_added
;

812 i‡(!
	`x86_pmu_öôülized
())

815 i‡(
˝uc
->
íabÀd
)

818 i‡(
˝uc
->
n_added
) {

819 
n_ru¬ög
 = 
˝uc
->
n_evíts
 - cpuc->
n_added
;

827 
i
 = 0; i < 
n_ru¬ög
; i++) {

828 
evít
 = 
˝uc
->
evít_li°
[
i
];

829 
hwc
 = &
evít
->
hw
;

837 i‡(
hwc
->
idx
 == -1 ||

838 
	`m©ch_¥ev_assignmít
(
hwc
, 
˝uc
, 
i
))

841 
	`x86_pmu_°›
(
evít
);

844 
i
 = 0; i < 
˝uc
->
n_evíts
; i++) {

845 
evít
 = 
˝uc
->
evít_li°
[
i
];

846 
hwc
 = &
evít
->
hw
;

848 i‡(!
	`m©ch_¥ev_assignmít
(
hwc
, 
˝uc
, 
i
))

849 
	`x86_assign_hw_evít
(
evít
, 
˝uc
, 
i
);

850 i‡(
i
 < 
n_ru¬ög
)

853 
	`x86_pmu_°¨t
(
evít
);

855 
˝uc
->
n_added
 = 0;

856 
	`≥rf_evíts_œpic_öô
();

859 
˝uc
->
íabÀd
 = 1;

860 
	`b¨rõr
();

862 
x86_pmu
.
	`íabÀ_Æl
(
added
);

863 
	}
}

865 
ölöe
 
	$__x86_pmu_íabÀ_evít
(
hw_≥rf_evít
 *
hwc
,

866 
u64
 
íabÀ_mask
)

868 
	`wrm§l
(
hwc
->
c⁄fig_ba£
 + hwc->
idx
, hwc->
c⁄fig
 | 
íabÀ_mask
);

869 
	}
}

871 
ölöe
 
	$x86_pmu_dißbÀ_evít
(
≥rf_evít
 *
evít
)

873 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

875 
	`wrm§l
(
hwc
->
c⁄fig_ba£
 + hwc->
idx
, hwc->
c⁄fig
);

876 
	}
}

878 
DEFINE_PER_CPU
(
u64
 [
X86_PMC_IDX_MAX
], 
pmc_¥ev_À·
);

885 
	$x86_≥rf_evít_£t_≥riod
(
≥rf_evít
 *
evít
)

887 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

888 
s64
 
À·
 = 
	`©omic64_ªad
(&
hwc
->
≥riod_À·
);

889 
s64
 
≥riod
 = 
hwc
->
ßm∂e_≥riod
;

890 
ªt
 = 0, 
idx
 = 
hwc
->idx;

892 i‡(
idx
 =
X86_PMC_IDX_FIXED_BTS
)

898 i‡(
	`u∆ikñy
(
À·
 <-
≥riod
)) {

899 
À·
 = 
≥riod
;

900 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

901 
hwc
->
œ°_≥riod
 = 
≥riod
;

902 
ªt
 = 1;

905 i‡(
	`u∆ikñy
(
À·
 <= 0)) {

906 
À·
 +
≥riod
;

907 
	`©omic64_£t
(&
hwc
->
≥riod_À·
, 
À·
);

908 
hwc
->
œ°_≥riod
 = 
≥riod
;

909 
ªt
 = 1;

914 i‡(
	`u∆ikñy
(
À·
 < 2))

915 
À·
 = 2;

917 i‡(
À·
 > 
x86_pmu
.
max_≥riod
)

918 
À·
 = 
x86_pmu
.
max_≥riod
;

920 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
	`smp_¥o˚ss‹_id
()Ë
À·
;

926 
	`©omic64_£t
(&
hwc
->
¥ev_cou¡
, (
u64
)-
À·
);

928 
	`wrm§l
(
hwc
->
evít_ba£
 + 
idx
,

929 (
u64
)(-
À·
Ë& 
x86_pmu
.
˙tvÆ_mask
);

931 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

933  
ªt
;

934 
	}
}

936 
	$x86_pmu_íabÀ_evít
(
≥rf_evít
 *
evít
)

938 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

939 i‡(
˝uc
->
íabÀd
)

940 
	`__x86_pmu_íabÀ_evít
(&
evít
->
hw
,

941 
ARCH_PERFMON_EVENTSEL_ENABLE
);

942 
	}
}

953 
	$x86_pmu_íabÀ
(
≥rf_evít
 *
evít
)

955 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

956 
hw_≥rf_evít
 *
hwc
;

957 
assign
[
X86_PMC_IDX_MAX
];

958 
n
, 
n0
, 
ªt
;

960 
hwc
 = &
evít
->
hw
;

962 
n0
 = 
˝uc
->
n_evíts
;

963 
n
 = 
	`cﬁÀ˘_evíts
(
˝uc
, 
evít
, 
Ál£
);

964 i‡(
n
 < 0)

965  
n
;

972 i‡(
˝uc
->
group_Êag
 & 
PERF_EVENT_TXN_STARTED
)

973 
out
;

975 
ªt
 = 
x86_pmu
.
	`scheduÀ_evíts
(
˝uc
, 
n
, 
assign
);

976 i‡(
ªt
)

977  
ªt
;

982 
	`mem˝y
(
˝uc
->
assign
,ássign, 
n
*());

984 
out
:

985 
˝uc
->
n_evíts
 = 
n
;

986 
˝uc
->
n_added
 +
n
 - 
n0
;

987 
˝uc
->
n_txn
 +
n
 - 
n0
;

990 
	}
}

992 
	$x86_pmu_°¨t
(
≥rf_evít
 *
evít
)

994 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

995 
idx
 = 
evít
->
hw
.idx;

997 i‡(
idx
 == -1)

998  -
EAGAIN
;

1000 
	`x86_≥rf_evít_£t_≥riod
(
evít
);

1001 
˝uc
->
evíts
[
idx
] = 
evít
;

1002 
	`__£t_bô
(
idx
, 
˝uc
->
a˘ive_mask
);

1003 
x86_pmu
.
	`íabÀ
(
evít
);

1004 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1007 
	}
}

1009 
	$x86_pmu_u¡hrŸée
(
≥rf_evít
 *
evít
)

1011 
ªt
 = 
	`x86_pmu_°¨t
(
evít
);

1012 
	`WARN_ON_ONCE
(
ªt
);

1013 
	}
}

1015 
	$≥rf_evít_¥öt_debug
()

1017 
u64
 
˘æ
, 
°©us
, 
ovîÊow
, 
pmc_˘æ
, 
pmc_cou¡
, 
¥ev_À·
, 
fixed
;

1018 
u64
 
≥bs
;

1019 
˝u_hw_evíts
 *
˝uc
;

1020 
Êags
;

1021 
˝u
, 
idx
;

1023 i‡(!
x86_pmu
.
num_cou¡îs
)

1026 
	`loˇl_úq_ßve
(
Êags
);

1028 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1029 
˝uc
 = &
	`≥r_˝u
(
˝u_hw_evíts
, 
˝u
);

1031 i‡(
x86_pmu
.
vîsi⁄
 >= 2) {

1032 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
˘æ
);

1033 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
°©us
);

1034 
	`rdm§l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
ovîÊow
);

1035 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR_CTRL
, 
fixed
);

1036 
	`rdm§l
(
MSR_IA32_PEBS_ENABLE
, 
≥bs
);

1038 
	`¥_öfo
("\n");

1039 
	`¥_öfo
("CPU#%d: cål: %016Œx\n", 
˝u
, 
˘æ
);

1040 
	`¥_öfo
("CPU#%d: sètus: %016Œx\n", 
˝u
, 
°©us
);

1041 
	`¥_öfo
("CPU#%d: ovîÊow: %016Œx\n", 
˝u
, 
ovîÊow
);

1042 
	`¥_öfo
("CPU#%d: fixed: %016Œx\n", 
˝u
, 
fixed
);

1043 
	`¥_öfo
("CPU#%d:Öebs: %016Œx\n", 
˝u
, 
≥bs
);

1045 
	`¥_öfo
("CPU#%d:á˘ive: %016Œx\n", 
˝u
, *(
u64
 *)
˝uc
->
a˘ive_mask
);

1047 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1048 
	`rdm§l
(
x86_pmu
.
evít£l
 + 
idx
, 
pmc_˘æ
);

1049 
	`rdm§l
(
x86_pmu
.
≥rf˘r
 + 
idx
, 
pmc_cou¡
);

1051 
¥ev_À·
 = 
	`≥r_˝u
(
pmc_¥ev_À·
[
idx
], 
˝u
);

1053 
	`¥_öfo
("CPU#%d: gen-PMC%d ctrl: %016llx\n",

1054 
˝u
, 
idx
, 
pmc_˘æ
);

1055 
	`¥_öfo
("CPU#%d: gen-PMC%d count: %016llx\n",

1056 
˝u
, 
idx
, 
pmc_cou¡
);

1057 
	`¥_öfo
("CPU#%d: gen-PMC%dÜeft: %016llx\n",

1058 
˝u
, 
idx
, 
¥ev_À·
);

1060 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs_fixed
; idx++) {

1061 
	`rdm§l
(
MSR_ARCH_PERFMON_FIXED_CTR0
 + 
idx
, 
pmc_cou¡
);

1063 
	`¥_öfo
("CPU#%d: fixed-PMC%d count: %016llx\n",

1064 
˝u
, 
idx
, 
pmc_cou¡
);

1066 
	`loˇl_úq_ª°‹e
(
Êags
);

1067 
	}
}

1069 
	$x86_pmu_°›
(
≥rf_evít
 *
evít
)

1071 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1072 
hw_≥rf_evít
 *
hwc
 = &
evít
->
hw
;

1073 
idx
 = 
hwc
->idx;

1075 i‡(!
	`__ã°_™d_˛ór_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1078 
x86_pmu
.
	`dißbÀ
(
evít
);

1084 
	`x86_≥rf_evít_upd©e
(
evít
);

1086 
˝uc
->
evíts
[
idx
] = 
NULL
;

1087 
	}
}

1089 
	$x86_pmu_dißbÀ
(
≥rf_evít
 *
evít
)

1091 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1092 
i
;

1099 i‡(
˝uc
->
group_Êag
 & 
PERF_EVENT_TXN_STARTED
)

1102 
	`x86_pmu_°›
(
evít
);

1104 
i
 = 0; i < 
˝uc
->
n_evíts
; i++) {

1105 i‡(
evít
 =
˝uc
->
evít_li°
[
i
]) {

1107 i‡(
x86_pmu
.
put_evít_c⁄°øöts
)

1108 
x86_pmu
.
	`put_evít_c⁄°øöts
(
˝uc
, 
evít
);

1110 ++
i
 < 
˝uc
->
n_evíts
)

1111 
˝uc
->
evít_li°
[
i
-1] = cpuc->event_list[i];

1113 --
˝uc
->
n_evíts
;

1117 
	`≥rf_evít_upd©e_u£Ωage
(
evít
);

1118 
	}
}

1120 
	$x86_pmu_h™dÀ_úq
(
±_ªgs
 *
ªgs
)

1122 
≥rf_ßm∂e_d©a
 
d©a
;

1123 
˝u_hw_evíts
 *
˝uc
;

1124 
≥rf_evít
 *
evít
;

1125 
hw_≥rf_evít
 *
hwc
;

1126 
idx
, 
h™dÀd
 = 0;

1127 
u64
 
vÆ
;

1129 
	`≥rf_ßm∂e_d©a_öô
(&
d©a
, 0);

1131 
˝uc
 = &
	`__gë_˝u_v¨
(
˝u_hw_evíts
);

1133 
idx
 = 0; idx < 
x86_pmu
.
num_cou¡îs
; idx++) {

1134 i‡(!
	`ã°_bô
(
idx
, 
˝uc
->
a˘ive_mask
))

1137 
evít
 = 
˝uc
->
evíts
[
idx
];

1138 
hwc
 = &
evít
->
hw
;

1140 
vÆ
 = 
	`x86_≥rf_evít_upd©e
(
evít
);

1141 i‡(
vÆ
 & (1ULL << (
x86_pmu
.
˙tvÆ_bôs
 - 1)))

1147 
h™dÀd
 = 1;

1148 
d©a
.
≥riod
 = 
evít
->
hw
.
œ°_≥riod
;

1150 i‡(!
	`x86_≥rf_evít_£t_≥riod
(
evít
))

1153 i‡(
	`≥rf_evít_ovîÊow
(
evít
, 1, &
d©a
, 
ªgs
))

1154 
	`x86_pmu_°›
(
evít
);

1157 i‡(
h™dÀd
)

1158 
	`öc_úq_°©
(
≠ic_≥rf_úqs
);

1160  
h™dÀd
;

1161 
	}
}

1163 
	$smp_≥rf_≥ndög_öãºu±
(
±_ªgs
 *
ªgs
)

1165 
	`úq_íãr
();

1166 
	`ack_APIC_úq
();

1167 
	`öc_úq_°©
(
≠ic_≥ndög_úqs
);

1168 
	`≥rf_evít_do_≥ndög
();

1169 
	`úq_exô
();

1170 
	}
}

1172 
	$£t_≥rf_evít_≥ndög
()

1174 #ifde‡
CONFIG_X86_LOCAL_APIC


1175 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1178 
≠ic
->
	`£nd_IPI_£lf
(
LOCAL_PENDING_VECTOR
);

1180 
	}
}

1182 
	$≥rf_evíts_œpic_öô
()

1184 i‡(!
x86_pmu
.
≠ic
 || !
	`x86_pmu_öôülized
())

1190 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1191 
	}
}

1193 
__k¥obes


1194 
	$≥rf_evít_nmi_h™dÀr
(
nŸifõr_block
 *
£lf
,

1195 
cmd
, *
__¨gs
)

1197 
dõ_¨gs
 *
¨gs
 = 
__¨gs
;

1198 
±_ªgs
 *
ªgs
;

1200 i‡(!
	`©omic_ªad
(&
a˘ive_evíts
))

1201  
NOTIFY_DONE
;

1203 
cmd
) {

1204 
DIE_NMI
:

1205 
DIE_NMI_IPI
:

1209  
NOTIFY_DONE
;

1212 
ªgs
 = 
¨gs
->regs;

1214 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

1222 
x86_pmu
.
	`h™dÀ_úq
(
ªgs
);

1224  
NOTIFY_STOP
;

1225 
	}
}

1227 
__ªad_mo°ly
 
nŸifõr_block
 
	g≥rf_evít_nmi_nŸifõr
 = {

1228 .
nŸifõr_ˇŒ
 = 
≥rf_evít_nmi_h™dÀr
,

1229 .
	g√xt
 = 
NULL
,

1230 .
	g¥i‹ôy
 = 1

1233 
evít_c⁄°øöt
 
	gunc⁄°øöed
;

1234 
evít_c⁄°øöt
 
	gem±yc⁄°øöt
;

1236 
evít_c⁄°øöt
 *

1237 
	$x86_gë_evít_c⁄°øöts
(
˝u_hw_evíts
 *
˝uc
, 
≥rf_evít
 *
evít
)

1239 
evít_c⁄°øöt
 *
c
;

1241 i‡(
x86_pmu
.
evít_c⁄°øöts
) {

1242 
	`f‹_óch_evít_c⁄°øöt
(
c
, 
x86_pmu
.
evít_c⁄°øöts
) {

1243 i‡((
evít
->
hw
.
c⁄fig
 & 
c
->
cmask
Ë=c->
code
)

1244  
c
;

1248  &
unc⁄°øöed
;

1249 
	}
}

1251 
	~"≥rf_evít_amd.c
"

1252 
	~"≥rf_evít_p6.c
"

1253 
	~"≥rf_evít_p4.c
"

1254 
	~"≥rf_evít_öãl_lbr.c
"

1255 
	~"≥rf_evít_öãl_ds.c
"

1256 
	~"≥rf_evít_öãl.c
"

1258 
__˝uöô


1259 
	$x86_pmu_nŸifõr
(
nŸifõr_block
 *
£lf
, 
a˘i⁄
, *
h˝u
)

1261 
˝u
 = ()
h˝u
;

1262 
ªt
 = 
NOTIFY_OK
;

1264 
a˘i⁄
 & ~
CPU_TASKS_FROZEN
) {

1265 
CPU_UP_PREPARE
:

1266 i‡(
x86_pmu
.
˝u_¥ï¨e
)

1267 
ªt
 = 
x86_pmu
.
	`˝u_¥ï¨e
(
˝u
);

1270 
CPU_STARTING
:

1271 i‡(
x86_pmu
.
˝u_°¨tög
)

1272 
x86_pmu
.
	`˝u_°¨tög
(
˝u
);

1275 
CPU_DYING
:

1276 i‡(
x86_pmu
.
˝u_dyög
)

1277 
x86_pmu
.
	`˝u_dyög
(
˝u
);

1280 
CPU_UP_CANCELED
:

1281 
CPU_DEAD
:

1282 i‡(
x86_pmu
.
˝u_dód
)

1283 
x86_pmu
.
	`˝u_dód
(
˝u
);

1290  
ªt
;

1291 
	}
}

1293 
__öô
 
	$pmu_check_≠ic
()

1295 i‡(
˝u_has_≠ic
)

1298 
x86_pmu
.
≠ic
 = 0;

1299 
	`¥_öfo
("no APIC, boot withÅhe \"lapic\" bootÖarameterÅo force-enable it.\n");

1300 
	`¥_öfo
("no hardware sampling interruptávailable.\n");

1301 
	}
}

1303 
__öô
 
	$öô_hw_≥rf_evíts
()

1305 
evít_c⁄°øöt
 *
c
;

1306 
îr
;

1308 
	`¥_öfo
("Performance Events: ");

1310 
boŸ_˝u_d©a
.
x86_víd‹
) {

1311 
X86_VENDOR_INTEL
:

1312 
îr
 = 
	`öãl_pmu_öô
();

1314 
X86_VENDOR_AMD
:

1315 
îr
 = 
	`amd_pmu_öô
();

1320 i‡(
îr
 != 0) {

1321 
	`¥_c⁄t
("no PMU driver, softwareÉvents only.\n");

1325 
	`pmu_check_≠ic
();

1327 
	`¥_c⁄t
("%†PMU drivî.\n", 
x86_pmu
.
«me
);

1329 i‡(
x86_pmu
.
quúks
)

1330 
x86_pmu
.
	`quúks
();

1332 i‡(
x86_pmu
.
num_cou¡îs
 > 
X86_PMC_MAX_GENERIC
) {

1333 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents %d > max(%d), clipping!",

1334 
x86_pmu
.
num_cou¡îs
, 
X86_PMC_MAX_GENERIC
);

1335 
x86_pmu
.
num_cou¡îs
 = 
X86_PMC_MAX_GENERIC
;

1337 
x86_pmu
.
öãl_˘æ
 = (1 << x86_pmu.
num_cou¡îs
) - 1;

1338 
≥rf_max_evíts
 = 
x86_pmu
.
num_cou¡îs
;

1340 i‡(
x86_pmu
.
num_cou¡îs_fixed
 > 
X86_PMC_MAX_FIXED
) {

1341 
	`WARN
(1, 
KERN_ERR
 "hwÖerfÉvents fixed %d > max(%d), clipping!",

1342 
x86_pmu
.
num_cou¡îs_fixed
, 
X86_PMC_MAX_FIXED
);

1343 
x86_pmu
.
num_cou¡îs_fixed
 = 
X86_PMC_MAX_FIXED
;

1346 
x86_pmu
.
öãl_˘æ
 |=

1347 ((1LL << 
x86_pmu
.
num_cou¡îs_fixed
)-1Ë<< 
X86_PMC_IDX_FIXED
;

1349 
	`≥rf_evíts_œpic_öô
();

1350 
	`ªgi°î_dõ_nŸifõr
(&
≥rf_evít_nmi_nŸifõr
);

1352 
unc⁄°øöed
 = (
evít_c⁄°øöt
)

1353 
	`__EVENT_CONSTRAINT
(0, (1ULL << 
x86_pmu
.
num_cou¡îs
) - 1,

1354 0, 
x86_pmu
.
num_cou¡îs
);

1356 i‡(
x86_pmu
.
evít_c⁄°øöts
) {

1357 
	`f‹_óch_evít_c⁄°øöt
(
c
, 
x86_pmu
.
evít_c⁄°øöts
) {

1358 i‡(
c
->
cmask
 !
X86_RAW_EVENT_MASK
)

1361 
c
->
idxmsk64
 |(1ULL << 
x86_pmu
.
num_cou¡îs
) - 1;

1362 
c
->
weight
 +
x86_pmu
.
num_cou¡îs
;

1366 
	`¥_öfo
("... vîsi⁄: %d\n", 
x86_pmu
.
vîsi⁄
);

1367 
	`¥_öfo
("... bô width: %d\n", 
x86_pmu
.
˙tvÆ_bôs
);

1368 
	`¥_öfo
("... gíîi¯ªgi°îs: %d\n", 
x86_pmu
.
num_cou¡îs
);

1369 
	`¥_öfo
("... vÆuêmask: %016Lx\n", 
x86_pmu
.
˙tvÆ_mask
);

1370 
	`¥_öfo
("... maxÖîiod: %016Lx\n", 
x86_pmu
.
max_≥riod
);

1371 
	`¥_öfo
("... fixed-puΩo£Évíts: %d\n", 
x86_pmu
.
num_cou¡îs_fixed
);

1372 
	`¥_öfo
("...Évíàmask: %016Lx\n", 
x86_pmu
.
öãl_˘æ
);

1374 
	`≥rf_˝u_nŸifõr
(
x86_pmu_nŸifõr
);

1375 
	}
}

1377 
ölöe
 
	$x86_pmu_ªad
(
≥rf_evít
 *
evít
)

1379 
	`x86_≥rf_evít_upd©e
(
evít
);

1380 
	}
}

1387 
	$x86_pmu_°¨t_txn
(c⁄° 
pmu
 *pmu)

1389 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1391 
˝uc
->
group_Êag
 |
PERF_EVENT_TXN_STARTED
;

1392 
˝uc
->
n_txn
 = 0;

1393 
	}
}

1400 
	$x86_pmu_ˇn˚l_txn
(c⁄° 
pmu
 *pmu)

1402 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1404 
˝uc
->
group_Êag
 &~
PERF_EVENT_TXN_STARTED
;

1408 
˝uc
->
n_added
 -˝uc->
n_txn
;

1409 
˝uc
->
n_evíts
 -˝uc->
n_txn
;

1410 
	}
}

1417 
	$x86_pmu_commô_txn
(c⁄° 
pmu
 *pmu)

1419 
˝u_hw_evíts
 *
˝uc
 = &
	`__gë_˝u_v¨
(cpu_hw_events);

1420 
assign
[
X86_PMC_IDX_MAX
];

1421 
n
, 
ªt
;

1423 
n
 = 
˝uc
->
n_evíts
;

1425 i‡(!
	`x86_pmu_öôülized
())

1426  -
EAGAIN
;

1428 
ªt
 = 
x86_pmu
.
	`scheduÀ_evíts
(
˝uc
, 
n
, 
assign
);

1429 i‡(
ªt
)

1430  
ªt
;

1436 
	`mem˝y
(
˝uc
->
assign
,ássign, 
n
*());

1442 
˝uc
->
n_txn
 = 0;

1445 
	}
}

1447 c⁄° 
pmu
 
	gpmu
 = {

1448 .
íabÀ
 = 
x86_pmu_íabÀ
,

1449 .
	gdißbÀ
 = 
x86_pmu_dißbÀ
,

1450 .
	g°¨t
 = 
x86_pmu_°¨t
,

1451 .
	g°›
 = 
x86_pmu_°›
,

1452 .
	gªad
 = 
x86_pmu_ªad
,

1453 .
	gu¡hrŸée
 = 
x86_pmu_u¡hrŸée
,

1454 .
	g°¨t_txn
 = 
x86_pmu_°¨t_txn
,

1455 .
	gˇn˚l_txn
 = 
x86_pmu_ˇn˚l_txn
,

1456 .
	gcommô_txn
 = 
x86_pmu_commô_txn
,

1462 
	$vÆid©e_evít
(
≥rf_evít
 *
evít
)

1464 
˝u_hw_evíts
 *
Áke_˝uc
;

1465 
evít_c⁄°øöt
 *
c
;

1466 
ªt
 = 0;

1468 
Áke_˝uc
 = 
	`kmÆloc
((*Áke_˝uc), 
GFP_KERNEL
 | 
__GFP_ZERO
);

1469 i‡(!
Áke_˝uc
)

1470  -
ENOMEM
;

1472 
c
 = 
x86_pmu
.
	`gë_evít_c⁄°øöts
(
Áke_˝uc
, 
evít
);

1474 i‡(!
c
 || !c->
weight
)

1475 
ªt
 = -
ENOSPC
;

1477 i‡(
x86_pmu
.
put_evít_c⁄°øöts
)

1478 
x86_pmu
.
	`put_evít_c⁄°øöts
(
Áke_˝uc
, 
evít
);

1480 
	`k‰ì
(
Áke_˝uc
);

1482  
ªt
;

1483 
	}
}

1496 
	$vÆid©e_group
(
≥rf_evít
 *
evít
)

1498 
≥rf_evít
 *
Àadî
 = 
evít
->
group_Àadî
;

1499 
˝u_hw_evíts
 *
Áke_˝uc
;

1500 
ªt
, 
n
;

1502 
ªt
 = -
ENOMEM
;

1503 
Áke_˝uc
 = 
	`kmÆloc
((*Áke_˝uc), 
GFP_KERNEL
 | 
__GFP_ZERO
);

1504 i‡(!
Áke_˝uc
)

1505 
out
;

1513 
ªt
 = -
ENOSPC
;

1514 
n
 = 
	`cﬁÀ˘_evíts
(
Áke_˝uc
, 
Àadî
, 
åue
);

1515 i‡(
n
 < 0)

1516 
out_‰ì
;

1518 
Áke_˝uc
->
n_evíts
 = 
n
;

1519 
n
 = 
	`cﬁÀ˘_evíts
(
Áke_˝uc
, 
evít
, 
Ál£
);

1520 i‡(
n
 < 0)

1521 
out_‰ì
;

1523 
Áke_˝uc
->
n_evíts
 = 
n
;

1525 
ªt
 = 
x86_pmu
.
	`scheduÀ_evíts
(
Áke_˝uc
, 
n
, 
NULL
);

1527 
out_‰ì
:

1528 
	`k‰ì
(
Áke_˝uc
);

1529 
out
:

1530  
ªt
;

1531 
	}
}

1533 c⁄° 
pmu
 *
	$hw_≥rf_evít_öô
(
≥rf_evít
 *
evít
)

1535 c⁄° 
pmu
 *
tmp
;

1536 
îr
;

1538 
îr
 = 
	`__hw_≥rf_evít_öô
(
evít
);

1539 i‡(!
îr
) {

1545 
tmp
 = 
evít
->
pmu
;

1546 
evít
->
pmu
 = &pmu;

1548 i‡(
evít
->
group_Àadî
 !=Évent)

1549 
îr
 = 
	`vÆid©e_group
(
evít
);

1551 
îr
 = 
	`vÆid©e_evít
(
evít
);

1553 
evít
->
pmu
 = 
tmp
;

1555 i‡(
îr
) {

1556 i‡(
evít
->
de°roy
)

1557 
evít
->
	`de°roy
(event);

1558  
	`ERR_PTR
(
îr
);

1561  &
pmu
;

1562 
	}
}

1568 
ölöe


1569 
	$ˇŒchaö_°‹e
(
≥rf_ˇŒchaö_íåy
 *
íåy
, 
u64
 
ù
)

1571 i‡(
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
)

1572 
íåy
->
ù
[íåy->
ƒ
++] = ip;

1573 
	}
}

1575 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_úq_íåy
);

1576 
DEFINE_PER_CPU
(
≥rf_ˇŒchaö_íåy
, 
pmc_nmi_íåy
);

1580 
	$backåa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

1583 
	}
}

1585 
	$backåa˚_w¨nög
(*
d©a
, *
msg
)

1588 
	}
}

1590 
	$backåa˚_°ack
(*
d©a
, *
«me
)

1593 
	}
}

1595 
	$backåa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

1597 
≥rf_ˇŒchaö_íåy
 *
íåy
 = 
d©a
;

1599 
	`ˇŒchaö_°‹e
(
íåy
, 
addr
);

1600 
	}
}

1602 c⁄° 
°ackåa˚_›s
 
	gbackåa˚_›s
 = {

1603 .
w¨nög
 = 
backåa˚_w¨nög
,

1604 .
	gw¨nög_symbﬁ
 = 
backåa˚_w¨nög_symbﬁ
,

1605 .
	g°ack
 = 
backåa˚_°ack
,

1606 .
	gaddªss
 = 
backåa˚_addªss
,

1607 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack_bp
,

1610 
	~"../dump°ack.h
"

1613 
	$≥rf_ˇŒchaö_kî√l
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1615 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_KERNEL
);

1616 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1618 
	`dump_åa˚
(
NULL
, 
ªgs
, NULL,Ñegs->
bp
, &
backåa˚_›s
, 
íåy
);

1619 
	}
}

1621 #ifde‡
CONFIG_COMPAT


1622 
ölöe
 

1623 
	$≥rf_ˇŒchaö_u£r32
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1626 
°ack_‰ame_ü32
 
‰ame
;

1627 c⁄° 
__u£r
 *
Â
;

1629 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
))

1632 
Â
 = 
	`com∑t_±r
(
ªgs
->
bp
);

1633 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

1634 
byãs
;

1635 
‰ame
.
√xt_‰ame
 = 0;

1636 
‰ame
.
ªtu∫_addªss
 = 0;

1638 
byãs
 = 
	`c›y_‰om_u£r_nmi
(&
‰ame
, 
Â
, (frame));

1639 i‡(
byãs
 !(
‰ame
))

1642 i‡(
Â
 < 
	`com∑t_±r
(
ªgs
->
•
))

1645 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

1646 
Â
 = 
	`com∑t_±r
(
‰ame
.
√xt_‰ame
);

1649 
	}
}

1651 
ölöe
 

1652 
	$≥rf_ˇŒchaö_u£r32
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1655 
	}
}

1659 
	$≥rf_ˇŒchaö_u£r
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1661 
°ack_‰ame
 
‰ame
;

1662 c⁄° 
__u£r
 *
Â
;

1664 i‡(!
	`u£r_mode
(
ªgs
))

1665 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

1667 
Â
 = (
__u£r
 *)
ªgs
->
bp
;

1669 
	`ˇŒchaö_°‹e
(
íåy
, 
PERF_CONTEXT_USER
);

1670 
	`ˇŒchaö_°‹e
(
íåy
, 
ªgs
->
ù
);

1672 i‡(
	`≥rf_ˇŒchaö_u£r32
(
ªgs
, 
íåy
))

1675 
íåy
->
ƒ
 < 
PERF_MAX_STACK_DEPTH
) {

1676 
byãs
;

1677 
‰ame
.
√xt_‰ame
 = 
NULL
;

1678 
‰ame
.
ªtu∫_addªss
 = 0;

1680 
byãs
 = 
	`c›y_‰om_u£r_nmi
(&
‰ame
, 
Â
, (frame));

1681 i‡(
byãs
 !(
‰ame
))

1684 i‡(()
Â
 < 
ªgs
->
•
)

1687 
	`ˇŒchaö_°‹e
(
íåy
, 
‰ame
.
ªtu∫_addªss
);

1688 
Â
 = 
‰ame
.
√xt_‰ame
;

1690 
	}
}

1693 
	$≥rf_do_ˇŒchaö
(
±_ªgs
 *
ªgs
, 
≥rf_ˇŒchaö_íåy
 *
íåy
)

1695 
is_u£r
;

1697 i‡(!
ªgs
)

1700 
is_u£r
 = 
	`u£r_mode
(
ªgs
);

1702 i‡(
is_u£r
 && 
cuºít
->
°©e
 !
TASK_RUNNING
)

1705 i‡(!
is_u£r
)

1706 
	`≥rf_ˇŒchaö_kî√l
(
ªgs
, 
íåy
);

1708 i‡(
cuºít
->
mm
)

1709 
	`≥rf_ˇŒchaö_u£r
(
ªgs
, 
íåy
);

1710 
	}
}

1712 
≥rf_ˇŒchaö_íåy
 *
	$≥rf_ˇŒchaö
(
±_ªgs
 *
ªgs
)

1714 
≥rf_ˇŒchaö_íåy
 *
íåy
;

1716 i‡(
≥rf_gue°_cbs
 &&Öîf_gue°_cbs->
	`is_ö_gue°
()) {

1718  
NULL
;

1721 i‡(
	`ö_nmi
())

1722 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_nmi_íåy
);

1724 
íåy
 = &
	`__gë_˝u_v¨
(
pmc_úq_íåy
);

1726 
íåy
->
ƒ
 = 0;

1728 
	`≥rf_do_ˇŒchaö
(
ªgs
, 
íåy
);

1730  
íåy
;

1731 
	}
}

1733 
	$≥rf_¨ch_„tch_ˇŒî_ªgs
(
±_ªgs
 *
ªgs
, 
ù
, 
skù
)

1735 
ªgs
->
ù
 = ip;

1740 
ªgs
->
bp
 = 
	`ªwöd_‰ame_poöãr
(
skù
 + 1);

1741 
ªgs
->
cs
 = 
__KERNEL_CS
;

1746 
ªgs
->
Êags
 = 0;

1747 
	}
}

1749 
	$≥rf_ö°ru˘i⁄_poöãr
(
±_ªgs
 *
ªgs
)

1751 
ù
;

1753 i‡(
≥rf_gue°_cbs
 &&Öîf_gue°_cbs->
	`is_ö_gue°
())

1754 
ù
 = 
≥rf_gue°_cbs
->
	`gë_gue°_ù
();

1756 
ù
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

1758  
ù
;

1759 
	}
}

1761 
	$≥rf_misc_Êags
(
±_ªgs
 *
ªgs
)

1763 
misc
 = 0;

1765 i‡(
≥rf_gue°_cbs
 &&Öîf_gue°_cbs->
	`is_ö_gue°
()) {

1766 i‡(
≥rf_gue°_cbs
->
	`is_u£r_mode
())

1767 
misc
 |
PERF_RECORD_MISC_GUEST_USER
;

1769 
misc
 |
PERF_RECORD_MISC_GUEST_KERNEL
;

1771 i‡(
	`u£r_mode
(
ªgs
))

1772 
misc
 |
PERF_RECORD_MISC_USER
;

1774 
misc
 |
PERF_RECORD_MISC_KERNEL
;

1777 i‡(
ªgs
->
Êags
 & 
PERF_EFLAGS_EXACT
)

1778 
misc
 |
PERF_RECORD_MISC_EXACT_IP
;

1780  
misc
;

1781 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/bô›s.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/nmi.h
>

20 
	~<löux/k¥obes.h
>

22 
	~<asm/≠ic.h
>

23 
	~<asm/≥rf_evít.h
>

25 
	snmi_w©chdog_˘lblk
 {

26 
	mcc¸_m§
;

27 
	m≥rf˘r_m§
;

28 
	mev¡£l_m§
;

32 
	swd_›s
 {

33 (*
	mª£rve
)();

34 (*
	muƒe£rve
)();

35 (*
	m£tup
)(
	mnmi_hz
);

36 (*
	mª¨m
)(
nmi_w©chdog_˘lblk
 *
	mwd
, 
	mnmi_hz
);

37 (*
	m°›
)();

38 
	m≥rf˘r
;

39 
	mev¡£l
;

40 
u64
 
	mcheckbô
;

43 c⁄° 
wd_›s
 *
	gwd_›s
;

51 
	#NMI_MAX_COUNTER_BITS
 66

	)

60 
DECLARE_BITMAP
(
≥rf˘r_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

61 
DECLARE_BITMAP
(
ev¡£l_nmi_ow√r
, 
NMI_MAX_COUNTER_BITS
);

63 
DEFINE_PER_CPU
(
nmi_w©chdog_˘lblk
,Çmi_watchdog_ctlblk);

66 
ölöe
 
	$nmi_≥rf˘r_m§_to_bô
(
m§
)

69 
boŸ_˝u_d©a
.
x86_víd‹
) {

70 
X86_VENDOR_AMD
:

71  
m§
 - 
MSR_K7_PERFCTR0
;

72 
X86_VENDOR_INTEL
:

73 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

74  
m§
 - 
MSR_ARCH_PERFMON_PERFCTR0
;

76 
boŸ_˝u_d©a
.
x86
) {

78  
m§
 - 
MSR_P6_PERFCTR0
;

80  
m§
 - 
MSR_P4_BPU_PERFCTR0
;

84 
	}
}

90 
ölöe
 
	$nmi_ev¡£l_m§_to_bô
(
m§
)

93 
boŸ_˝u_d©a
.
x86_víd‹
) {

94 
X86_VENDOR_AMD
:

95  
m§
 - 
MSR_K7_EVNTSEL0
;

96 
X86_VENDOR_INTEL
:

97 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
))

98  
m§
 - 
MSR_ARCH_PERFMON_EVENTSEL0
;

100 
boŸ_˝u_d©a
.
x86
) {

102  
m§
 - 
MSR_P6_EVNTSEL0
;

104  
m§
 - 
MSR_P4_BSU_ESCR0
;

109 
	}
}

112 
	$avaû_to_ª§v_≥rf˘r_nmi_bô
(
cou¡î
)

114 
	`BUG_ON
(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
);

116  !
	`ã°_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

117 
	}
}

118 
EXPORT_SYMBOL
(
avaû_to_ª§v_≥rf˘r_nmi_bô
);

120 
	$ª£rve_≥rf˘r_nmi
(
m§
)

122 
cou¡î
;

124 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

126 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

129 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
))

132 
	}
}

133 
EXPORT_SYMBOL
(
ª£rve_≥rf˘r_nmi
);

135 
	$ªÀa£_≥rf˘r_nmi
(
m§
)

137 
cou¡î
;

139 
cou¡î
 = 
	`nmi_≥rf˘r_m§_to_bô
(
m§
);

141 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

144 
	`˛ór_bô
(
cou¡î
, 
≥rf˘r_nmi_ow√r
);

145 
	}
}

146 
EXPORT_SYMBOL
(
ªÀa£_≥rf˘r_nmi
);

148 
	$ª£rve_ev¡£l_nmi
(
m§
)

150 
cou¡î
;

152 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

154 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

157 i‡(!
	`ã°_™d_£t_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
))

160 
	}
}

161 
EXPORT_SYMBOL
(
ª£rve_ev¡£l_nmi
);

163 
	$ªÀa£_ev¡£l_nmi
(
m§
)

165 
cou¡î
;

167 
cou¡î
 = 
	`nmi_ev¡£l_m§_to_bô
(
m§
);

169 i‡(
cou¡î
 > 
NMI_MAX_COUNTER_BITS
)

172 
	`˛ór_bô
(
cou¡î
, 
ev¡£l_nmi_ow√r
);

173 
	}
}

174 
EXPORT_SYMBOL
(
ªÀa£_ev¡£l_nmi
);

176 
	$dißbÀ_œpic_nmi_w©chdog
()

178 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

180 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) <= 0)

183 
	`⁄_óch_˝u
(
°›_≠ic_nmi_w©chdog
, 
NULL
, 1);

185 i‡(
wd_›s
)

186 
wd_›s
->
	`uƒe£rve
();

188 
	`BUG_ON
(
	`©omic_ªad
(&
nmi_a˘ive
) != 0);

189 
	}
}

191 
	$íabÀ_œpic_nmi_w©chdog
()

193 
	`BUG_ON
(
nmi_w©chdog
 !
NMI_LOCAL_APIC
);

196 i‡(
	`©omic_ªad
(&
nmi_a˘ive
) != 0)

200 i‡(!
wd_›s
)

202 i‡(!
wd_›s
->
	`ª£rve
()) {

203 
	`¥ötk
(
KERN_ERR
 "NMI watchdog: cannotÑeserveÖerfctrs\n");

207 
	`⁄_óch_˝u
(
£tup_≠ic_nmi_w©chdog
, 
NULL
, 1);

208 
	`touch_nmi_w©chdog
();

209 
	}
}

215 
	$adju°_f‹_32bô_˘r
(
hz
)

217 
u64
 
cou¡î_vÆ
;

218 
ªtvÆ
 = 
hz
;

227 
cou¡î_vÆ
 = (
u64
)
˝u_khz
 * 1000;

228 
	`do_div
(
cou¡î_vÆ
, 
ªtvÆ
);

229 i‡(
cou¡î_vÆ
 > 0x7fffffffULL) {

230 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

231 
	`do_div
(
cou¡
, 0x7fffffffUL);

232 
ªtvÆ
 = 
cou¡
 + 1;

234  
ªtvÆ
;

235 
	}
}

237 
	$wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
,

238 c⁄° *
des¸
, 
nmi_hz
)

240 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

242 
	`do_div
(
cou¡
, 
nmi_hz
);

243 i‡(
des¸
)

244 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

245 
	`wrm§l
(
≥rf˘r_m§
, 0 - 
cou¡
);

246 
	}
}

248 
	$wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
,

249 c⁄° *
des¸
, 
nmi_hz
)

251 
u64
 
cou¡
 = (u64)
˝u_khz
 * 1000;

253 
	`do_div
(
cou¡
, 
nmi_hz
);

254 i‡(
des¸
)

255 
	`¥_debug
("£âög %†tÿ-0x%08Lx\n", 
des¸
, 
cou¡
);

256 
	`wrm§
(
≥rf˘r_m§
, (
u32
)(-
cou¡
), 0);

257 
	}
}

263 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

264 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

265 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

266 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

267 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

268 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

270 
	$£tup_k7_w©chdog
(
nmi_hz
)

272 
≥rf˘r_m§
, 
ev¡£l_m§
;

273 
ev¡£l
;

274 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

276 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

277 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

279 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

281 
ev¡£l
 = 
K7_EVNTSEL_INT


282 | 
K7_EVNTSEL_OS


283 | 
K7_EVNTSEL_USR


284 | 
K7_NMI_EVENT
;

287 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

288 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "K7_PERFCTR0", 
nmi_hz
);

291 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

292 
wd
->
ev¡£l_m§
 =Évntsel_msr;

293 
wd
->
cc¸_m§
 = 0;

296 
	`˝u_nmi_£t_wd_íabÀd
();

298 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

299 
ev¡£l
 |
K7_EVNTSEL_ENABLE
;

300 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

303 
	}
}

305 
	$sögÀ_m§_°›_w©chdog
()

307 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

309 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

310 
	}
}

312 
	$sögÀ_m§_ª£rve
()

314 i‡(!
	`ª£rve_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
))

317 i‡(!
	`ª£rve_ev¡£l_nmi
(
wd_›s
->
ev¡£l
)) {

318 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

322 
	}
}

324 
	$sögÀ_m§_uƒe£rve
()

326 
	`ªÀa£_ev¡£l_nmi
(
wd_›s
->
ev¡£l
);

327 
	`ªÀa£_≥rf˘r_nmi
(
wd_›s
->
≥rf˘r
);

328 
	}
}

330 
__k¥obes


331 
	$sögÀ_m§_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

334 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

335 
	}
}

337 c⁄° 
wd_›s
 
	gk7_wd_›s
 = {

338 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

339 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

340 .
	g£tup
 = 
£tup_k7_w©chdog
,

341 .
	gª¨m
 = 
sögÀ_m§_ª¨m
,

342 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

343 .
	g≥rf˘r
 = 
MSR_K7_PERFCTR0
,

344 .
	gev¡£l
 = 
MSR_K7_EVNTSEL0
,

345 .
	gcheckbô
 = 1ULL << 47,

351 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

352 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

353 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

354 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

355 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

356 
	#P6_NMI_EVENT
 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


	)

358 
	$£tup_p6_w©chdog
(
nmi_hz
)

360 
≥rf˘r_m§
, 
ev¡£l_m§
;

361 
ev¡£l
;

362 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

364 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

365 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

368 i‡(
	`wrm§_ß„
(
≥rf˘r_m§
, 0, 0) < 0)

371 
ev¡£l
 = 
P6_EVNTSEL_INT


372 | 
P6_EVNTSEL_OS


373 | 
P6_EVNTSEL_USR


374 | 
P6_NMI_EVENT
;

377 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

378 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

379 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "P6_PERFCTR0", 
nmi_hz
);

382 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

383 
wd
->
ev¡£l_m§
 =Évntsel_msr;

384 
wd
->
cc¸_m§
 = 0;

387 
	`˝u_nmi_£t_wd_íabÀd
();

389 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

390 
ev¡£l
 |
P6_EVNTSEL0_ENABLE
;

391 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

394 
	}
}

396 
__k¥obes
 
	$p6_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

404 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

407 
	`wrôe_w©chdog_cou¡î32
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

408 
	}
}

410 c⁄° 
wd_›s
 
	gp6_wd_›s
 = {

411 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

412 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

413 .
	g£tup
 = 
£tup_p6_w©chdog
,

414 .
	gª¨m
 = 
p6_ª¨m
,

415 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

416 .
	g≥rf˘r
 = 
MSR_P6_PERFCTR0
,

417 .
	gev¡£l
 = 
MSR_P6_EVNTSEL0
,

418 .
	gcheckbô
 = 1ULL << 39,

425 
	#MSR_P4_MISC_ENABLE_PERF_AVAIL
 (1 << 7)

	)

426 
	#P4_ESCR_EVENT_SELECT
(
N
Ë((NË<< 25)

	)

427 
	#P4_ESCR_OS
 (1 << 3)

	)

428 
	#P4_ESCR_USR
 (1 << 2)

	)

429 
	#P4_CCCR_OVF_PMI0
 (1 << 26)

	)

430 
	#P4_CCCR_OVF_PMI1
 (1 << 27)

	)

431 
	#P4_CCCR_THRESHOLD
(
N
Ë((NË<< 20)

	)

432 
	#P4_CCCR_COMPLEMENT
 (1 << 19)

	)

433 
	#P4_CCCR_COMPARE
 (1 << 18)

	)

434 
	#P4_CCCR_REQUIRED
 (3 << 16)

	)

435 
	#P4_CCCR_ESCR_SELECT
(
N
Ë((NË<< 13)

	)

436 
	#P4_CCCR_ENABLE
 (1 << 12)

	)

437 
	#P4_CCCR_OVF
 (1 << 31)

	)

439 
	#P4_CONTROLS
 18

	)

440 
	gp4_c⁄åﬁs
[18] = {

441 
MSR_P4_BPU_CCCR0
,

442 
MSR_P4_BPU_CCCR1
,

443 
MSR_P4_BPU_CCCR2
,

444 
MSR_P4_BPU_CCCR3
,

445 
MSR_P4_MS_CCCR0
,

446 
MSR_P4_MS_CCCR1
,

447 
MSR_P4_MS_CCCR2
,

448 
MSR_P4_MS_CCCR3
,

449 
MSR_P4_FLAME_CCCR0
,

450 
MSR_P4_FLAME_CCCR1
,

451 
MSR_P4_FLAME_CCCR2
,

452 
MSR_P4_FLAME_CCCR3
,

453 
MSR_P4_IQ_CCCR0
,

454 
MSR_P4_IQ_CCCR1
,

455 
MSR_P4_IQ_CCCR2
,

456 
MSR_P4_IQ_CCCR3
,

457 
MSR_P4_IQ_CCCR4
,

458 
MSR_P4_IQ_CCCR5
,

465 
	$£tup_p4_w©chdog
(
nmi_hz
)

467 
≥rf˘r_m§
, 
ev¡£l_m§
, 
cc¸_m§
;

468 
ev¡£l
, 
cc¸_vÆ
;

469 
misc_íabÀ
, 
dummy
;

470 
ht_num
;

471 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

473 
	`rdm§
(
MSR_IA32_MISC_ENABLE
, 
misc_íabÀ
, 
dummy
);

474 i‡(!(
misc_íabÀ
 & 
MSR_P4_MISC_ENABLE_PERF_AVAIL
))

477 #ifde‡
CONFIG_SMP


479 i‡(
smp_num_siblögs
 == 2) {

480 
ebx
, 
≠icid
;

482 
ebx
 = 
	`˝uid_ebx
(1);

483 
≠icid
 = (
ebx
 >> 24) & 0xff;

484 
ht_num
 = 
≠icid
 & 1;

487 
ht_num
 = 0;

495 i‡(!
ht_num
) {

497 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR0
;

498 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

499 
cc¸_m§
 = 
MSR_P4_IQ_CCCR0
;

500 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
 | 
	`P4_CCCR_ESCR_SELECT
(4);

511 i‡(
ª£t_devi˚s
) {

512 
low
, 
high
;

513 
i
;

515 
i
 = 0; i < 
P4_CONTROLS
; i++) {

516 
	`rdm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

517 
low
 &~(
P4_CCCR_ENABLE
 | 
P4_CCCR_OVF
);

518 
	`wrm§
(
p4_c⁄åﬁs
[
i
], 
low
, 
high
);

523 
≥rf˘r_m§
 = 
MSR_P4_IQ_PERFCTR1
;

524 
ev¡£l_m§
 = 
MSR_P4_CRU_ESCR0
;

525 
cc¸_m§
 = 
MSR_P4_IQ_CCCR1
;

528 i‡(
boŸ_˝u_d©a
.
x86_modñ
 =4 && boŸ_˝u_d©a.
x86_mask
 == 4)

529 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI0
;

531 
cc¸_vÆ
 = 
P4_CCCR_OVF_PMI1
;

532 
cc¸_vÆ
 |
	`P4_CCCR_ESCR_SELECT
(4);

535 
ev¡£l
 = 
	`P4_ESCR_EVENT_SELECT
(0x3F)

536 | 
P4_ESCR_OS


537 | 
P4_ESCR_USR
;

539 
cc¸_vÆ
 |
	`P4_CCCR_THRESHOLD
(15)

540 | 
P4_CCCR_COMPLEMENT


541 | 
P4_CCCR_COMPARE


542 | 
P4_CCCR_REQUIRED
;

544 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

545 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

546 
	`wrôe_w©chdog_cou¡î
(
≥rf˘r_m§
, "P4_IQ_COUNTER0", 
nmi_hz
);

548 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

549 
wd
->
ev¡£l_m§
 =Évntsel_msr;

550 
wd
->
cc¸_m§
 = cccr_msr;

553 
	`˝u_nmi_£t_wd_íabÀd
();

555 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

556 
cc¸_vÆ
 |
P4_CCCR_ENABLE
;

557 
	`wrm§
(
cc¸_m§
, 
cc¸_vÆ
, 0);

559 
	}
}

561 
	$°›_p4_w©chdog
()

563 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

564 
	`wrm§
(
wd
->
cc¸_m§
, 0, 0);

565 
	`wrm§
(
wd
->
ev¡£l_m§
, 0, 0);

566 
	}
}

568 
	$p4_ª£rve
()

570 i‡(!
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
))

572 #ifde‡
CONFIG_SMP


573 i‡(
smp_num_siblögs
 > 1 && !
	`ª£rve_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
))

574 
Áû1
;

576 i‡(!
	`ª£rve_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
))

577 
Áû2
;

580 
Áû2
:

581 #ifde‡
CONFIG_SMP


582 i‡(
smp_num_siblögs
 > 1)

583 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

584 
Áû1
:

586 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

588 
	}
}

590 
	$p4_uƒe£rve
()

592 #ifde‡
CONFIG_SMP


593 i‡(
smp_num_siblögs
 > 1)

594 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR1
);

596 
	`ªÀa£_ev¡£l_nmi
(
MSR_P4_CRU_ESCR0
);

597 
	`ªÀa£_≥rf˘r_nmi
(
MSR_P4_IQ_PERFCTR0
);

598 
	}
}

600 
__k¥obes
 
	$p4_ª¨m
(
nmi_w©chdog_˘lblk
 *
wd
, 
nmi_hz
)

602 
dummy
;

610 
	`rdm§l
(
wd
->
cc¸_m§
, 
dummy
);

611 
dummy
 &~
P4_CCCR_OVF
;

612 
	`wrm§l
(
wd
->
cc¸_m§
, 
dummy
);

613 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

615 
	`wrôe_w©chdog_cou¡î
(
wd
->
≥rf˘r_m§
, 
NULL
, 
nmi_hz
);

616 
	}
}

618 c⁄° 
wd_›s
 
	gp4_wd_›s
 = {

619 .
ª£rve
 = 
p4_ª£rve
,

620 .
	guƒe£rve
 = 
p4_uƒe£rve
,

621 .
	g£tup
 = 
£tup_p4_w©chdog
,

622 .
	gª¨m
 = 
p4_ª¨m
,

623 .
	g°›
 = 
°›_p4_w©chdog
,

625 .
	g≥rf˘r
 = 
MSR_P4_BPU_PERFCTR0
,

626 .
	gev¡£l
 = 
MSR_P4_BSU_ESCR0
,

627 .
	gcheckbô
 = 1ULL << 39,

634 
	#ARCH_PERFMON_NMI_EVENT_SEL
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_SEL


	)

635 
	#ARCH_PERFMON_NMI_EVENT_UMASK
 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_UMASK


	)

637 
wd_›s
 
	göãl_¨ch_wd_›s
;

639 
	$£tup_öãl_¨ch_w©chdog
(
nmi_hz
)

641 
ebx
;

642 
˝uid10_óx
 
óx
;

643 
unu£d
;

644 
≥rf˘r_m§
, 
ev¡£l_m§
;

645 
ev¡£l
;

646 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

653 
	`˝uid
(10, &(
óx
.
fuŒ
), &
ebx
, &
unu£d
, &unused);

654 i‡((
óx
.
•lô
.
mask_Àngth
 <

655 (
ARCH_PERFMON_UNHALTED_CORE_CYCLES_INDEX
+1)) ||

656 (
ebx
 & 
ARCH_PERFMON_UNHALTED_CORE_CYCLES_PRESENT
))

659 
≥rf˘r_m§
 = 
wd_›s
->
≥rf˘r
;

660 
ev¡£l_m§
 = 
wd_›s
->
ev¡£l
;

662 
	`wrm§l
(
≥rf˘r_m§
, 0UL);

664 
ev¡£l
 = 
ARCH_PERFMON_EVENTSEL_INT


665 | 
ARCH_PERFMON_EVENTSEL_OS


666 | 
ARCH_PERFMON_EVENTSEL_USR


667 | 
ARCH_PERFMON_NMI_EVENT_SEL


668 | 
ARCH_PERFMON_NMI_EVENT_UMASK
;

671 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

672 
nmi_hz
 = 
	`adju°_f‹_32bô_˘r
(nmi_hz);

673 
	`wrôe_w©chdog_cou¡î32
(
≥rf˘r_m§
, "INTEL_ARCH_PERFCTR0", 
nmi_hz
);

675 
wd
->
≥rf˘r_m§
 =Öerfctr_msr;

676 
wd
->
ev¡£l_m§
 =Évntsel_msr;

677 
wd
->
cc¸_m§
 = 0;

680 
	`˝u_nmi_£t_wd_íabÀd
();

682 
	`≠ic_wrôe
(
APIC_LVTPC
, 
APIC_DM_NMI
);

683 
ev¡£l
 |
ARCH_PERFMON_EVENTSEL_ENABLE
;

684 
	`wrm§
(
ev¡£l_m§
, 
ev¡£l
, 0);

685 
öãl_¨ch_wd_›s
.
checkbô
 = 1ULL << (
óx
.
•lô
.
bô_width
 - 1);

687 
	}
}

689 
wd_›s
 
öãl_¨ch_wd_›s
 
	g__ªad_mo°ly
 = {

690 .
ª£rve
 = 
sögÀ_m§_ª£rve
,

691 .
	guƒe£rve
 = 
sögÀ_m§_uƒe£rve
,

692 .
	g£tup
 = 
£tup_öãl_¨ch_w©chdog
,

693 .
	gª¨m
 = 
p6_ª¨m
,

694 .
	g°›
 = 
sögÀ_m§_°›_w©chdog
,

695 .
	g≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR1
,

696 .
	gev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL1
,

699 
	$¥obe_nmi_w©chdog
()

701 
boŸ_˝u_d©a
.
x86_víd‹
) {

702 
X86_VENDOR_AMD
:

703 i‡(
boŸ_˝u_d©a
.
x86
 != 6 && boot_cpu_data.x86 != 15 &&

704 
boŸ_˝u_d©a
.
x86
 != 16 && boot_cpu_data.x86 != 17)

706 
wd_›s
 = &
k7_wd_›s
;

708 
X86_VENDOR_INTEL
:

715 i‡((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 14) ||

716 ((
boŸ_˝u_d©a
.
x86
 =6 && boŸ_˝u_d©a.
x86_modñ
 == 15 &&

717 
boŸ_˝u_d©a
.
x86_mask
 == 4))) {

718 
öãl_¨ch_wd_›s
.
≥rf˘r
 = 
MSR_ARCH_PERFMON_PERFCTR0
;

719 
öãl_¨ch_wd_›s
.
ev¡£l
 = 
MSR_ARCH_PERFMON_EVENTSEL0
;

721 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_ARCH_PERFMON
)) {

722 
wd_›s
 = &
öãl_¨ch_wd_›s
;

725 
boŸ_˝u_d©a
.
x86
) {

727 i‡(
boŸ_˝u_d©a
.
x86_modñ
 > 13)

730 
wd_›s
 = &
p6_wd_›s
;

733 
wd_›s
 = &
p4_wd_›s
;

740 
	}
}

744 
	$œpic_w©chdog_öô
(
nmi_hz
)

746 i‡(!
wd_›s
) {

747 
	`¥obe_nmi_w©chdog
();

748 i‡(!
wd_›s
) {

749 
	`¥ötk
(
KERN_INFO
 "NMI watchdog: CPUÇot supported\n");

753 i‡(!
wd_›s
->
	`ª£rve
()) {

754 
	`¥ötk
(
KERN_ERR


760 i‡(!(
wd_›s
->
	`£tup
(
nmi_hz
))) {

761 
	`¥ötk
(
KERN_ERR
 "Cannot setup NMI watchdog on CPU %d\n",

762 
	`øw_smp_¥o˚ss‹_id
());

767 
	}
}

769 
	$œpic_w©chdog_°›
()

771 i‡(
wd_›s
)

772 
wd_›s
->
	`°›
();

773 
	}
}

775 
	$œpic_adju°_nmi_hz
(
hz
)

777 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

778 i‡(
wd
->
≥rf˘r_m§
 =
MSR_P6_PERFCTR0
 ||

779 
wd
->
≥rf˘r_m§
 =
MSR_ARCH_PERFMON_PERFCTR1
)

780 
hz
 = 
	`adju°_f‹_32bô_˘r
(hz);

781  
hz
;

782 
	}
}

784 
__k¥obes
 
	$œpic_wd_evít
(
nmi_hz
)

786 
nmi_w©chdog_˘lblk
 *
wd
 = &
	`__gë_˝u_v¨
(nmi_watchdog_ctlblk);

787 
u64
 
˘r
;

789 
	`rdm§l
(
wd
->
≥rf˘r_m§
, 
˘r
);

790 i‡(
˘r
 & 
wd_›s
->
checkbô
)

793 
wd_›s
->
	`ª¨m
(
wd
, 
nmi_hz
);

795 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c

7 
	~<asm/˝u„©uª.h
>

9 c⁄° *c⁄° 
	gx86_powî_Êags
[32] = {

	@/cmpt816/linux/arch/x86/kernel/cpu/proc.c

1 
	~<löux/smp.h
>

2 
	~<löux/timex.h
>

3 
	~<löux/°rög.h
>

4 
	~<löux/£q_fûe.h
>

5 
	~<löux/˝u‰eq.h
>

10 
	$show_˝uöfo_c‹e
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
,

11 
˝u
)

13 #ifde‡
CONFIG_SMP


14 i‡(
c
->
x86_max_c‹es
 * 
smp_num_siblögs
 > 1) {

15 
	`£q_¥ötf
(
m
, "physiˇ»id\t: %d\n", 
c
->
phys_¥oc_id
);

16 
	`£q_¥ötf
(
m
, "siblings\t: %d\n",

17 
	`˝umask_weight
(
	`˝u_c‹e_mask
(
˝u
)));

18 
	`£q_¥ötf
(
m
, "c‹êid\t\t: %d\n", 
c
->
˝u_c‹e_id
);

19 
	`£q_¥ötf
(
m
, "˝u c‹es\t: %d\n", 
c
->
boŸed_c‹es
);

20 
	`£q_¥ötf
(
m
, "≠icid\t\t: %d\n", 
c
->
≠icid
);

21 
	`£q_¥ötf
(
m
, "öôü»≠icid\t: %d\n", 
c
->
öôül_≠icid
);

24 
	}
}

26 #ifde‡
CONFIG_X86_32


27 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

33 
Âu_ex˚±i⁄
 = 
c
->
h¨d_m©h
 && (
ign‹e_Âu_úq
 || 
˝u_has_Âu
);

34 
	`£q_¥ötf
(
m
,

43 
c
->
fdiv_bug
 ? "yes" : "no",

44 
c
->
h…_w‹ks_ok
 ? "no" : "yes",

45 
c
->
f00f_bug
 ? "yes" : "no",

46 
c
->
coma_bug
 ? "yes" : "no",

47 
c
->
h¨d_m©h
 ? "yes" : "no",

48 
Âu_ex˚±i⁄
 ? "yes" : "no",

49 
c
->
˝uid_Àvñ
,

50 
c
->
wp_w‹ks_ok
 ? "yes" : "no");

51 
	}
}

53 
	$show_˝uöfo_misc
(
£q_fûe
 *
m
, 
˝uöfo_x86
 *
c
)

55 
	`£q_¥ötf
(
m
,

60 
c
->
˝uid_Àvñ
);

61 
	}
}

64 
	$show_˝uöfo
(
£q_fûe
 *
m
, *
v
)

66 
˝uöfo_x86
 *
c
 = 
v
;

67 
˝u
 = 0;

68 
i
;

70 #ifde‡
CONFIG_SMP


71 
˝u
 = 
c
->
˝u_ödex
;

73 
	`£q_¥ötf
(
m
, "processor\t: %u\n"

78 
˝u
,

79 
c
->
x86_víd‹_id
[0] ? c->x86_vendor_id : "unknown",

80 
c
->
x86
,

81 
c
->
x86_modñ
,

82 
c
->
x86_modñ_id
[0] ? c->x86_model_id : "unknown");

84 i‡(
c
->
x86_mask
 || c->
˝uid_Àvñ
 >= 0)

85 
	`£q_¥ötf
(
m
, "°ïpög\t: %d\n", 
c
->
x86_mask
);

87 
	`£q_¥ötf
(
m
, "stepping\t: unknown\n");

89 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_TSC
)) {

90 
‰eq
 = 
	`˝u‰eq_quick_gë
(
˝u
);

92 i‡(!
‰eq
)

93 
‰eq
 = 
˝u_khz
;

94 
	`£q_¥ötf
(
m
, "cpu MHz\t\t: %u.%03u\n",

95 
‰eq
 / 1000, (freq % 1000));

99 i‡(
c
->
x86_ˇche_size
 >= 0)

100 
	`£q_¥ötf
(
m
, "ˇchêsize\t: %d KB\n", 
c
->
x86_ˇche_size
);

102 
	`show_˝uöfo_c‹e
(
m
, 
c
, 
˝u
);

103 
	`show_˝uöfo_misc
(
m
, 
c
);

105 
	`£q_¥ötf
(
m
, "flags\t\t:");

106 
i
 = 0; i < 32*
NCAPINTS
; i++)

107 i‡(
	`˝u_has
(
c
, 
i
Ë&& 
x86_ˇp_Êags
[i] !
NULL
)

108 
	`£q_¥ötf
(
m
, " %s", 
x86_ˇp_Êags
[
i
]);

110 
	`£q_¥ötf
(
m
, "\nbogomips\t: %lu.%02lu\n",

111 
c
->
lo›s_≥r_jiffy
/(500000/
HZ
),

112 (
c
->
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100);

114 #ifde‡
CONFIG_X86_64


115 i‡(
c
->
x86_ébsize
 > 0)

116 
	`£q_¥ötf
(
m
, "TLB size\t: %d 4KÖages\n", 
c
->
x86_ébsize
);

118 
	`£q_¥ötf
(
m
, "˛Êush size\t: %u\n", 
c
->
x86_˛Êush_size
);

119 
	`£q_¥ötf
(
m
, "ˇche_Æignmít\t: %d\n", 
c
->
x86_ˇche_Æignmít
);

120 
	`£q_¥ötf
(
m
, "address sizes\t: %u bitsÖhysical, %u bits virtual\n",

121 
c
->
x86_phys_bôs
, c->
x86_vút_bôs
);

123 
	`£q_¥ötf
(
m
, "power management:");

124 
i
 = 0; i < 32; i++) {

125 i‡(
c
->
x86_powî
 & (1 << 
i
)) {

126 i‡(
i
 < 
	`ARRAY_SIZE
(
x86_powî_Êags
) &&

127 
x86_powî_Êags
[
i
])

128 
	`£q_¥ötf
(
m
, "%s%s",

129 
x86_powî_Êags
[
i
][0] ? " " : "",

130 
x86_powî_Êags
[
i
]);

132 
	`£q_¥ötf
(
m
, " [%d]", 
i
);

136 
	`£q_¥ötf
(
m
, "\n\n");

139 
	}
}

141 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

143 i‡(*
pos
 == 0)

144 *
pos
 = 
	`˝umask_fú°
(
˝u_⁄löe_mask
);

146 *
pos
 = 
	`˝umask_√xt
(*po†- 1, 
˝u_⁄löe_mask
);

147 i‡((*
pos
Ë< 
ƒ_˝u_ids
)

148  &
	`˝u_d©a
(*
pos
);

149  
NULL
;

150 
	}
}

152 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

154 (*
pos
)++;

155  
	`c_°¨t
(
m
, 
pos
);

156 
	}
}

158 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

160 
	}
}

162 c⁄° 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

163 .
°¨t
 = 
c_°¨t
,

164 .
	g√xt
 = 
c_√xt
,

165 .
	g°›
 = 
c_°›
,

166 .
	gshow
 = 
show_˝uöfo
,

	@/cmpt816/linux/arch/x86/kernel/cpu/sched.c

1 
	~<löux/sched.h
>

2 
	~<löux/m©h64.h
>

3 
	~<löux/≥r˝u.h
>

4 
	~<löux/úqÊags.h
>

6 
	~<asm/˝u„©uª.h
>

7 
	~<asm/¥o˚ss‹.h
>

9 #ifde‡
CONFIG_SMP


11 
DEFINE_PER_CPU
(
≠îfm≥rf
, 
ﬁd_≥rf_sched
);

13 
	$sˇÀ_≠îfm≥rf
()

15 
≠îfm≥rf
 
vÆ
, *
ﬁd
 = &
	`__gë_˝u_v¨
(
ﬁd_≥rf_sched
);

16 
øtio
, 
Êags
;

18 
	`loˇl_úq_ßve
(
Êags
);

19 
	`gë_≠îfm≥rf
(&
vÆ
);

20 
	`loˇl_úq_ª°‹e
(
Êags
);

22 
øtio
 = 
	`ˇlc_≠îfm≥rf_øtio
(
ﬁd
, &
vÆ
);

23 *
ﬁd
 = 
vÆ
;

25  
øtio
;

26 
	}
}

28 
	$¨ch_sˇÀ_‰eq_powî
(
sched_domaö
 *
sd
, 
˝u
)

34 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

35  
	`sˇÀ_≠îfm≥rf
();

41  
	`deÁu…_sˇÀ_‰eq_powî
(
sd
, 
˝u
);

42 
	}
}

44 
	$¨ch_sˇÀ_smt_powî
(
sched_domaö
 *
sd
, 
˝u
)

49 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_APERFMPERF
))

50  
SCHED_LOAD_SCALE
;

52  
	`deÁu…_sˇÀ_smt_powî
(
sd
, 
˝u
);

53 
	}
}

	@/cmpt816/linux/arch/x86/kernel/cpu/vmware.c

24 
	~<löux/dmi.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<asm/div64.h
>

27 
	~<asm/x86_öô.h
>

28 
	~<asm/hy≥rvis‹.h
>

30 
	#CPUID_VMWARE_INFO_LEAF
 0x40000000

	)

31 
	#VMWARE_HYPERVISOR_MAGIC
 0x564D5868

	)

32 
	#VMWARE_HYPERVISOR_PORT
 0x5658

	)

34 
	#VMWARE_PORT_CMD_GETVERSION
 10

	)

35 
	#VMWARE_PORT_CMD_GETHZ
 45

	)

37 
	#VMWARE_PORT
(
cmd
, 
óx
, 
ebx
, 
ecx
, 
edx
) \

38 
	`__asm__
("inl (%%dx)" : \

39 "˜"(
óx
), "=c"(
ecx
), "=d"(
edx
), "=b"(
ebx
) : \

40 "0"(
VMWARE_HYPERVISOR_MAGIC
), \

41 "1"(
VMWARE_PORT_CMD_
##
cmd
), \

42 "2"(
VMWARE_HYPERVISOR_PORT
), "3"(
UINT_MAX
) : \

43 "mem‹y");

	)

45 
ölöe
 
	$__vmw¨e_∂©f‹m
()

47 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

48 
	`VMWARE_PORT
(
GETVERSION
, 
óx
, 
ebx
, 
ecx
, 
edx
);

49  
óx
 !(
uöt32_t
)-1 && 
ebx
 =
VMWARE_HYPERVISOR_MAGIC
;

50 
	}
}

52 
	$vmw¨e_gë_tsc_khz
()

54 
uöt64_t
 
tsc_hz
;

55 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

57 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

59 
tsc_hz
 = 
óx
 | (((
uöt64_t
)
ebx
) << 32);

60 
	`do_div
(
tsc_hz
, 1000);

61 
	`BUG_ON
(
tsc_hz
 >> 32);

62 
	`¥ötk
(
KERN_INFO
 "TSC freqÑead from hypervisor : %lu.%03lu MHz\n",

63 (Ë
tsc_hz
 / 1000,

64 (Ë
tsc_hz
 % 1000);

65  
tsc_hz
;

66 
	}
}

68 
__öô
 
	$vmw¨e_∂©f‹m_£tup
()

70 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

72 
	`VMWARE_PORT
(
GETHZ
, 
óx
, 
ebx
, 
ecx
, 
edx
);

74 i‡(
ebx
 !
UINT_MAX
)

75 
x86_∂©f‹m
.
ˇlibøã_tsc
 = 
vmw¨e_gë_tsc_khz
;

77 
	`¥ötk
(
KERN_WARNING


79 
	}
}

86 
boﬁ
 
__öô
 
	$vmw¨e_∂©f‹m
()

88 i‡(
˝u_has_hy≥rvis‹
) {

89 
óx
;

90 
hy≥r_víd‹_id
[3];

92 
	`˝uid
(
CPUID_VMWARE_INFO_LEAF
, &
óx
, &
hy≥r_víd‹_id
[0],

93 &
hy≥r_víd‹_id
[1], &hyper_vendor_id[2]);

94 i‡(!
	`memcmp
(
hy≥r_víd‹_id
, "VMwareVMware", 12))

95  
åue
;

96 } i‡(
dmi_avaûabÀ
 && 
	`dmi_«me_ö_£rül
("VMware") &&

97 
	`__vmw¨e_∂©f‹m
())

98  
åue
;

100  
Ál£
;

101 
	}
}

115 
__˝uöô
 
	$vmw¨e_£t_˝u_„©uªs
(
˝uöfo_x86
 *
c
)

117 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_CONSTANT_TSC
);

118 
	`£t_˝u_ˇp
(
c
, 
X86_FEATURE_TSC_RELIABLE
);

119 
	}
}

121 c⁄° 
__ªfc⁄°
 
hy≥rvis‹_x86
 
	gx86_hy≥r_vmw¨e
 = {

122 .
«me
 = "VMware",

123 .
	gdëe˘
 = 
vmw¨e_∂©f‹m
,

124 .
	g£t_˝u_„©uªs
 = 
vmw¨e_£t_˝u_„©uªs
,

125 .
	göô_∂©f‹m
 = 
vmw¨e_∂©f‹m_£tup
,

127 
EXPORT_SYMBOL
(
x86_hy≥r_vmw¨e
);

	@/cmpt816/linux/arch/x86/kernel/cpuid.c

28 
	~<löux/moduÀ.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/î∫o.h
>

32 
	~<löux/f˙é.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/pﬁl.h
>

35 
	~<löux/smp.h
>

36 
	~<löux/smp_lock.h
>

37 
	~<löux/maj‹.h
>

38 
	~<löux/fs.h
>

39 
	~<löux/devi˚.h
>

40 
	~<löux/˝u.h
>

41 
	~<löux/nŸifõr.h
>

42 
	~<löux/uac˚ss.h
>

43 
	~<löux/gÂ.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/m§.h
>

47 
	~<asm/sy°em.h
>

49 
˛ass
 *
	g˝uid_˛ass
;

51 
	s˝uid_ªgs
 {

52 
u32
 
	móx
, 
	mebx
, 
	mecx
, 
	medx
;

55 
	$˝uid_smp_˝uid
(*
cmd_block
)

57 
˝uid_ªgs
 *
cmd
 = (˝uid_ªg†*)
cmd_block
;

59 
	`˝uid_cou¡
(
cmd
->
óx
, cmd->
ecx
,

60 &
cmd
->
óx
, &cmd->
ebx
, &cmd->
ecx
, &cmd->
edx
);

61 
	}
}

63 
loff_t
 
	$˝uid_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

65 
loff_t
 
ªt
;

66 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

68 
	`muãx_lock
(&
öode
->
i_muãx
);

69 
‹ig
) {

71 
fûe
->
f_pos
 = 
off£t
;

72 
ªt
 = 
fûe
->
f_pos
;

75 
fûe
->
f_pos
 +
off£t
;

76 
ªt
 = 
fûe
->
f_pos
;

79 
ªt
 = -
EINVAL
;

81 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

82  
ªt
;

83 
	}
}

85 
ssize_t
 
	$˝uid_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

86 
size_t
 
cou¡
, 
loff_t
 *
µos
)

88 
__u£r
 *
tmp
 = 
buf
;

89 
˝uid_ªgs
 
cmd
;

90 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

91 
u64
 
pos
 = *
µos
;

92 
ssize_t
 
byãs
 = 0;

93 
îr
 = 0;

95 i‡(
cou¡
 % 16)

96  -
EINVAL
;

98 ; 
cou¡
; count -= 16) {

99 
cmd
.
óx
 = 
pos
;

100 
cmd
.
ecx
 = 
pos
 >> 32;

101 
îr
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝uid_smp_˝uid
, &
cmd
, 1);

102 i‡(
îr
)

104 i‡(
	`c›y_to_u£r
(
tmp
, &
cmd
, 16)) {

105 
îr
 = -
EFAULT
;

108 
tmp
 += 16;

109 
byãs
 += 16;

110 *
µos
 = ++
pos
;

113  
byãs
 ? byã†: 
îr
;

114 
	}
}

116 
	$˝uid_›í
(
öode
 *öode, 
fûe
 *file)

118 
˝u
;

119 
˝uöfo_x86
 *
c
;

121 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

122 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

123  -
ENXIO
;

125 
c
 = &
	`˝u_d©a
(
˝u
);

126 i‡(
c
->
˝uid_Àvñ
 < 0)

127  -
EIO
;

130 
	}
}

135 c⁄° 
fûe_›î©i⁄s
 
	g˝uid_f›s
 = {

136 .
ow√r
 = 
THIS_MODULE
,

137 .
	gŒ£ek
 = 
˝uid_£ek
,

138 .
	gªad
 = 
˝uid_ªad
,

139 .
	g›í
 = 
˝uid_›í
,

142 
__˝uöô
 
	$˝uid_devi˚_¸óã
(
˝u
)

144 
devi˚
 *
dev
;

146 
dev
 = 
	`devi˚_¸óã
(
˝uid_˛ass
, 
NULL
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
), NULL,

147 "˝u%d", 
˝u
);

148  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

149 
	}
}

151 
	$˝uid_devi˚_de°roy
(
˝u
)

153 
	`devi˚_de°roy
(
˝uid_˛ass
, 
	`MKDEV
(
CPUID_MAJOR
, 
˝u
));

154 
	}
}

156 
__˝uöô
 
	$˝uid_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

157 
a˘i⁄
,

158 *
h˝u
)

160 
˝u
 = ()
h˝u
;

161 
îr
 = 0;

163 
a˘i⁄
) {

164 
CPU_UP_PREPARE
:

165 
îr
 = 
	`˝uid_devi˚_¸óã
(
˝u
);

167 
CPU_UP_CANCELED
:

168 
CPU_UP_CANCELED_FROZEN
:

169 
CPU_DEAD
:

170 
	`˝uid_devi˚_de°roy
(
˝u
);

173  
	`nŸifõr_‰om_î∫o
(
îr
);

174 
	}
}

176 
nŸifõr_block
 
__ªfd©a
 
	g˝uid_˛ass_˝u_nŸifõr
 =

178 .
nŸifõr_ˇŒ
 = 
˝uid_˛ass_˝u_ˇŒback
,

181 *
	$˝uid_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

183  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/˝uid", 
	`MINOR
(
dev
->
devt
));

184 
	}
}

186 
__öô
 
	$˝uid_öô
()

188 
i
, 
îr
 = 0;

189 
i
 = 0;

191 i‡(
	`__ªgi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
,

192 "˝u/˝uid", &
˝uid_f›s
)) {

193 
	`¥ötk
(
KERN_ERR
 "cpuid: unableÅo get major %d for cpuid\n",

194 
CPUID_MAJOR
);

195 
îr
 = -
EBUSY
;

196 
out
;

198 
˝uid_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "cpuid");

199 i‡(
	`IS_ERR
(
˝uid_˛ass
)) {

200 
îr
 = 
	`PTR_ERR
(
˝uid_˛ass
);

201 
out_chrdev
;

203 
˝uid_˛ass
->
devnode
 = 
˝uid_devnode
;

204 
	`f‹_óch_⁄löe_˝u
(
i
) {

205 
îr
 = 
	`˝uid_devi˚_¸óã
(
i
);

206 i‡(
îr
 != 0)

207 
out_˛ass
;

209 
	`ªgi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

211 
îr
 = 0;

212 
out
;

214 
out_˛ass
:

215 
i
 = 0;

216 
	`f‹_óch_⁄löe_˝u
(
i
) {

217 
	`˝uid_devi˚_de°roy
(
i
);

219 
	`˛ass_de°roy
(
˝uid_˛ass
);

220 
out_chrdev
:

221 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

222 
out
:

223  
îr
;

224 
	}
}

226 
__exô
 
	$˝uid_exô
()

228 
˝u
 = 0;

230 
	`f‹_óch_⁄löe_˝u
(
˝u
)

231 
	`˝uid_devi˚_de°roy
(
˝u
);

232 
	`˛ass_de°roy
(
˝uid_˛ass
);

233 
	`__uƒegi°î_chrdev
(
CPUID_MAJOR
, 0, 
NR_CPUS
, "cpu/cpuid");

234 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
˝uid_˛ass_˝u_nŸifõr
);

235 
	}
}

237 
moduÀ_öô
(
˝uid_öô
);

238 
moduÀ_exô
(
˝uid_exô
);

240 
MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

241 
MODULE_DESCRIPTION
("x86 generic CPUID driver");

242 
MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/crash.c

10 
	~<löux/öô.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/ªboŸ.h
>

15 
	~<löux/kexec.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/ñfc‹e.h
>

20 
	~<asm/¥o˚ss‹.h
>

21 
	~<asm/h¨dúq.h
>

22 
	~<asm/nmi.h
>

23 
	~<asm/hw_úq.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/h≥t.h
>

26 
	~<löux/kdebug.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ªboŸ.h
>

29 
	~<asm/vúãxt.h
>

31 #i‡
deföed
(
CONFIG_SMP
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

33 
	$kdump_nmi_ˇŒback
(
˝u
, 
dõ_¨gs
 *
¨gs
)

35 
±_ªgs
 *
ªgs
;

36 #ifde‡
CONFIG_X86_32


37 
±_ªgs
 
fixed_ªgs
;

40 
ªgs
 = 
¨gs
->regs;

42 #ifde‡
CONFIG_X86_32


43 i‡(!
	`u£r_mode_vm
(
ªgs
)) {

44 
	`¸ash_fixup_ss_e•
(&
fixed_ªgs
, 
ªgs
);

45 
ªgs
 = &
fixed_ªgs
;

48 
	`¸ash_ßve_˝u
(
ªgs
, 
˝u
);

56 
	`˝u_emîgícy_vmxoff
();

57 
	`˝u_emîgícy_svm_dißbÀ
();

59 
	`dißbÀ_loˇl_APIC
();

60 
	}
}

62 
	$kdump_nmi_shoŸdown_˝us
()

64 
	`nmi_shoŸdown_˝us
(
kdump_nmi_ˇŒback
);

66 
	`dißbÀ_loˇl_APIC
();

67 
	}
}

70 
	$kdump_nmi_shoŸdown_˝us
()

73 
	}
}

76 
	$«tive_machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

87 
	`loˇl_úq_dißbÀ
();

89 
	`kdump_nmi_shoŸdown_˝us
();

95 
	`˝u_emîgícy_vmxoff
();

96 
	`˝u_emîgícy_svm_dißbÀ
();

98 
	`œpic_shutdown
();

99 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

100 
	`dißbÀ_IO_APIC
();

102 #ifde‡
CONFIG_HPET_TIMER


103 
	`h≥t_dißbÀ
();

105 
	`¸ash_ßve_˝u
(
ªgs
, 
	`ß„_smp_¥o˚ss‹_id
());

106 
	}
}

	@/cmpt816/linux/arch/x86/kernel/crash_dump_64.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/io.h
>

14 
	gñfc‹ehdr_addr
 = 
ELFCORE_ADDR_MAX
;

29 
ssize_t
 
	$c›y_ﬁdmem_∑ge
(
p‚
, *
buf
,

30 
size_t
 
csize
, 
off£t
, 
u£rbuf
)

32 *
vaddr
;

34 i‡(!
csize
)

37 
vaddr
 = 
	`i‹em≠
(
p‚
 << 
PAGE_SHIFT
, 
PAGE_SIZE
);

38 i‡(!
vaddr
)

39  -
ENOMEM
;

41 i‡(
u£rbuf
) {

42 i‡(
	`c›y_to_u£r
(
buf
, 
vaddr
 + 
off£t
, 
csize
)) {

43 
	`iounm≠
(
vaddr
);

44  -
EFAULT
;

47 
	`mem˝y
(
buf
, 
vaddr
 + 
off£t
, 
csize
);

49 
	`iounm≠
(
vaddr
);

50  
csize
;

51 
	}
}

	@/cmpt816/linux/arch/x86/kernel/dumpstack.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/ut¢ame.h
>

9 
	~<löux/h¨dúq.h
>

10 
	~<löux/kdebug.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/±ø˚.h
>

13 
	~<löux/·ø˚.h
>

14 
	~<löux/kexec.h
>

15 
	~<löux/bug.h
>

16 
	~<löux/nmi.h
>

17 
	~<löux/sysfs.h
>

19 
	~<asm/°ackåa˚.h
>

21 
	~"dump°ack.h
"

23 
	g∑nic_⁄_uƒecovîed_nmi
;

24 
	g∑nic_⁄_io_nmi
;

25 
	gcode_byãs
 = 64;

26 
	gk°ack_dïth_to_¥öt
 = 3 * 
STACKSLOTS_PER_LINE
;

27 
	gdõ_cou¡î
;

29 
	$¥ötk_addªss
(
addªss
, 
ªlübÀ
)

31 
	`¥ötk
(" [<%p>] %s%pS\n", (*Ë
addªss
,

32 
ªlübÀ
 ? "" : "? ", (*Ë
addªss
);

33 
	}
}

35 #ifde‡
CONFIG_FUNCTION_GRAPH_TRACER


37 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

38 c⁄° 
°ackåa˚_›s
 *
›s
,

39 
thªad_öfo
 *
töfo
, *
gøph
)

41 
èsk_°ru˘
 *
èsk
 = 
töfo
->task;

42 
ªt_addr
;

43 
ödex
 = 
èsk
->
cuº_ªt_°ack
;

45 i‡(
addr
 !()
ªtu∫_to_h™dÀr
)

48 i‡(!
èsk
->
ªt_°ack
 || 
ödex
 < *
gøph
)

51 
ödex
 -*
gøph
;

52 
ªt_addr
 = 
èsk
->
ªt_°ack
[
ödex
].
ªt
;

54 
›s
->
	`addªss
(
d©a
, 
ªt_addr
, 1);

56 (*
gøph
)++;

57 
	}
}

59 
ölöe
 

60 
	$¥öt_·ø˚_gøph_addr
(
addr
, *
d©a
,

61 c⁄° 
°ackåa˚_›s
 *
›s
,

62 
thªad_öfo
 *
töfo
, *
gøph
)

63 { 
	}
}

73 
ölöe
 
	$vÆid_°ack_±r
(
thªad_öfo
 *
töfo
,

74 *
p
, 
size
, *
íd
)

76 *
t
 = 
töfo
;

77 i‡(
íd
) {

78 i‡(
p
 < 
íd
 &&Ö >”nd-
THREAD_SIZE
))

83  
p
 > 
t
 &&Ö <Å + 
THREAD_SIZE
 - 
size
;

84 
	}
}

87 
	$¥öt_c⁄ãxt_°ack
(
thªad_öfo
 *
töfo
,

88 *
°ack
, 
bp
,

89 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

90 *
íd
, *
gøph
)

92 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

94 
	`vÆid_°ack_±r
(
töfo
, 
°ack
, (*°ack), 
íd
)) {

95 
addr
;

97 
addr
 = *
°ack
;

98 i‡(
	`__kî√l_ãxt_addªss
(
addr
)) {

99 i‡((Ë
°ack
 =
bp
 + ()) {

100 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

101 
‰ame
 = føme->
√xt_‰ame
;

102 
bp
 = (Ë
‰ame
;

104 
›s
->
	`addªss
(
d©a
, 
addr
, 0);

106 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

108 
°ack
++;

110  
bp
;

111 
	}
}

112 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack
);

115 
	$¥öt_c⁄ãxt_°ack_bp
(
thªad_öfo
 *
töfo
,

116 *
°ack
, 
bp
,

117 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
,

118 *
íd
, *
gøph
)

120 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

121 *
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

123 
	`vÆid_°ack_±r
(
töfo
, 
ªt_addr
, (*ªt_addr), 
íd
)) {

124 
addr
 = *
ªt_addr
;

126 i‡(!
	`__kî√l_ãxt_addªss
(
addr
))

129 
›s
->
	`addªss
(
d©a
, 
addr
, 1);

130 
‰ame
 = føme->
√xt_‰ame
;

131 
ªt_addr
 = &
‰ame
->
ªtu∫_addªss
;

132 
	`¥öt_·ø˚_gøph_addr
(
addr
, 
d©a
, 
›s
, 
töfo
, 
gøph
);

135  ()
‰ame
;

136 
	}
}

137 
EXPORT_SYMBOL_GPL
(
¥öt_c⁄ãxt_°ack_bp
);

141 
	$¥öt_åa˚_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

143 
	`¥ötk
(
d©a
);

144 
	`¥öt_symbﬁ
(
msg
, 
symbﬁ
);

145 
	`¥ötk
("\n");

146 
	}
}

148 
	$¥öt_åa˚_w¨nög
(*
d©a
, *
msg
)

150 
	`¥ötk
("%s%s\n", (*)
d©a
, 
msg
);

151 
	}
}

153 
	$¥öt_åa˚_°ack
(*
d©a
, *
«me
)

155 
	`¥ötk
("%†<%s> ", (*)
d©a
, 
«me
);

157 
	}
}

162 
	$¥öt_åa˚_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

164 
	`touch_nmi_w©chdog
();

165 
	`¥ötk
(
d©a
);

166 
	`¥ötk_addªss
(
addr
, 
ªlübÀ
);

167 
	}
}

169 c⁄° 
°ackåa˚_›s
 
	g¥öt_åa˚_›s
 = {

170 .
w¨nög
 = 
¥öt_åa˚_w¨nög
,

171 .
	gw¨nög_symbﬁ
 = 
¥öt_åa˚_w¨nög_symbﬁ
,

172 .
	g°ack
 = 
¥öt_åa˚_°ack
,

173 .
	gaddªss
 = 
¥öt_åa˚_addªss
,

174 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

178 
	$show_åa˚_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

179 *
°ack
, 
bp
, *
log_lvl
)

181 
	`¥ötk
("%sCÆ»Tø˚:\n", 
log_lvl
);

182 
	`dump_åa˚
(
èsk
, 
ªgs
, 
°ack
, 
bp
, &
¥öt_åa˚_›s
, 
log_lvl
);

183 
	}
}

185 
	$show_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

186 *
°ack
, 
bp
)

188 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
°ack
, 
bp
, "");

189 
	}
}

191 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

193 
	`show_°ack_log_lvl
(
èsk
, 
NULL
, 
•
, 0, "");

194 
	}
}

199 
	$dump_°ack
()

201 
bp
 = 0;

202 
°ack
;

204 #ifde‡
CONFIG_FRAME_POINTER


205 i‡(!
bp
)

206 
	`gë_bp
(
bp
);

209 
	`¥ötk
("Pid: %d, comm: %.20s %s %s %.*s\n",

210 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

211 
	`öô_ut¢ame
()->
ªÀa£
,

212 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

213 
	`öô_ut¢ame
()->
vîsi⁄
);

214 
	`show_åa˚
(
NULL
, NULL, &
°ack
, 
bp
);

215 
	}
}

216 
EXPORT_SYMBOL
(
dump_°ack
);

218 
¨ch_•ölock_t
 
	gdõ_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

219 
	gdõ_ow√r
 = -1;

220 
	gdõ_√°_cou¡
;

222 
__k¥obes
 
	$o›s_begö
()

224 
˝u
;

225 
Êags
;

227 
	`o›s_íãr
();

230 
	`øw_loˇl_úq_ßve
(
Êags
);

231 
˝u
 = 
	`smp_¥o˚ss‹_id
();

232 i‡(!
	`¨ch_•ö_åylock
(&
dõ_lock
)) {

233 i‡(
˝u
 =
dõ_ow√r
)

236 
	`¨ch_•ö_lock
(&
dõ_lock
);

238 
dõ_√°_cou¡
++;

239 
dõ_ow√r
 = 
˝u
;

240 
	`c⁄sﬁe_vîbo£
();

241 
	`bu°_•ölocks
(1);

242  
Êags
;

243 
	}
}

245 
__k¥obes
 
	$o›s_íd
(
Êags
, 
±_ªgs
 *
ªgs
, 
sigƒ
)

247 i‡(
ªgs
 && 
	`kexec_should_¸ash
(
cuºít
))

248 
	`¸ash_kexec
(
ªgs
);

250 
	`bu°_•ölocks
(0);

251 
dõ_ow√r
 = -1;

252 
	`add_èöt
(
TAINT_DIE
);

253 
dõ_√°_cou¡
--;

254 i‡(!
dõ_√°_cou¡
)

256 
	`¨ch_•ö_u∆ock
(&
dõ_lock
);

257 
	`øw_loˇl_úq_ª°‹e
(
Êags
);

258 
	`o›s_exô
();

260 i‡(!
sigƒ
)

262 i‡(
	`ö_öãºu±
())

263 
	`∑nic
("FatalÉxception in interrupt");

264 i‡(
∑nic_⁄_o›s
)

265 
	`∑nic
("FatalÉxception");

266 
	`do_exô
(
sigƒ
);

267 
	}
}

269 
__k¥obes
 
	$__dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

271 #ifde‡
CONFIG_X86_32


272 
ss
;

273 
•
;

275 
	`¥ötk
(
KERN_EMERG
 "%s: %04lx [#%d] ", 
°r
, 
îr
 & 0xffff, ++
dõ_cou¡î
);

276 #ifde‡
CONFIG_PREEMPT


277 
	`¥ötk
("PREEMPT ");

279 #ifde‡
CONFIG_SMP


280 
	`¥ötk
("SMP ");

282 #ifde‡
CONFIG_DEBUG_PAGEALLOC


283 
	`¥ötk
("DEBUG_PAGEALLOC");

285 
	`¥ötk
("\n");

286 
	`sysfs_¥ötk_œ°_fûe
();

287 i‡(
	`nŸify_dõ
(
DIE_OOPS
, 
°r
, 
ªgs
, 
îr
,

288 
cuºít
->
thªad
.
å≠_no
, 
SIGSEGV
Ë=
NOTIFY_STOP
)

291 
	`show_ªgi°îs
(
ªgs
);

292 #ifde‡
CONFIG_X86_32


293 i‡(
	`u£r_mode_vm
(
ªgs
)) {

294 
•
 = 
ªgs
->sp;

295 
ss
 = 
ªgs
->ss & 0xffff;

297 
•
 = 
	`kî√l_°ack_poöãr
(
ªgs
);

298 
	`ßve£gmít
(
ss
, ss);

300 
	`¥ötk
(
KERN_EMERG
 "EIP: [<%08lx>] ", 
ªgs
->
ù
);

301 
	`¥öt_symbﬁ
("%s", 
ªgs
->
ù
);

302 
	`¥ötk
(" SS:ESP %04x:%08lx\n", 
ss
, 
•
);

305 
	`¥ötk
(
KERN_ALERT
 "RIP ");

306 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

307 
	`¥ötk
(" RSP <%016lx>\n", 
ªgs
->
•
);

310 
	}
}

316 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

318 
Êags
 = 
	`o›s_begö
();

319 
sig
 = 
SIGSEGV
;

321 i‡(!
	`u£r_mode_vm
(
ªgs
))

322 
	`ªp‹t_bug
(
ªgs
->
ù
,Ñegs);

324 i‡(
	`__dõ
(
°r
, 
ªgs
, 
îr
))

325 
sig
 = 0;

326 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

327 
	}
}

329 
nŸø˚
 
__k¥obes


330 
	$dõ_nmi
(*
°r
, 
±_ªgs
 *
ªgs
, 
do_∑nic
)

332 
Êags
;

334 i‡(
	`nŸify_dõ
(
DIE_NMIWATCHDOG
, 
°r
, 
ªgs
, 0, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

341 
Êags
 = 
	`o›s_begö
();

342 
	`¥ötk
(
KERN_EMERG
 "%s", 
°r
);

343 
	`¥ötk
(" on CPU%d, ip %08lx,Ñegisters:\n",

344 
	`smp_¥o˚ss‹_id
(), 
ªgs
->
ù
);

345 
	`show_ªgi°îs
(
ªgs
);

346 
	`o›s_íd
(
Êags
, 
ªgs
, 0);

347 i‡(
do_∑nic
 || 
∑nic_⁄_o›s
)

348 
	`∑nic
("Non maskable interrupt");

349 
	`nmi_exô
();

350 
	`loˇl_úq_íabÀ
();

351 
	`do_exô
(
SIGBUS
);

352 
	}
}

354 
__öô
 
	$o›s_£tup
(*
s
)

356 i‡(!
s
)

357  -
EINVAL
;

358 i‡(!
	`°rcmp
(
s
, "panic"))

359 
∑nic_⁄_o›s
 = 1;

361 
	}
}

362 
óæy_∑øm
("o›s", 
o›s_£tup
);

364 
__öô
 
	$k°ack_£tup
(*
s
)

366 i‡(!
s
)

367  -
EINVAL
;

368 
k°ack_dïth_to_¥öt
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

370 
	}
}

371 
óæy_∑øm
("k°ack", 
k°ack_£tup
);

373 
__öô
 
	$code_byãs_£tup
(*
s
)

375 
code_byãs
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

376 i‡(
code_byãs
 > 8192)

377 
code_byãs
 = 8192;

380 
	}
}

381 
__£tup
("code_byãs=", 
code_byãs_£tup
);

	@/cmpt816/linux/arch/x86/kernel/dumpstack_64.c

5 
	~<löux/kÆlsyms.h
>

6 
	~<löux/k¥obes.h
>

7 
	~<löux/uac˚ss.h
>

8 
	~<löux/h¨dúq.h
>

9 
	~<löux/kdebug.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/±ø˚.h
>

12 
	~<löux/kexec.h
>

13 
	~<löux/sysfs.h
>

14 
	~<löux/bug.h
>

15 
	~<löux/nmi.h
>

17 
	~<asm/°ackåa˚.h
>

19 
	~"dump°ack.h
"

21 
	#N_EXCEPTION_STACKS_END
 \

22 (
N_EXCEPTION_STACKS
 + 
DEBUG_STKSZ
/
EXCEPTION_STKSZ
 - 2)

	)

24 
	gx86_°ack_ids
[][8] = {

25 [ 
DEBUG_STACK
-1 ] = "#DB",

26 [ 
NMI_STACK
-1 ] = "NMI",

27 [ 
DOUBLEFAULT_STACK
-1 ] = "#DF",

28 [ 
STACKFAULT_STACK
-1 ] = "#SS",

29 [ 
MCE_STACK
-1 ] = "#MC",

30 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


31 [ 
N_EXCEPTION_STACKS
 ...

32 
N_EXCEPTION_STACKS_END
 ] = "#DB[?]"

36 *
	$ö_ex˚±i⁄_°ack
(
˝u
, 
°ack
,

37 *
u£dp
, **
idp
)

39 
k
;

45 
k
 = 0; k < 
N_EXCEPTION_STACKS
; k++) {

46 
íd
 = 
	`≥r_˝u
(
‹ig_i°
, 
˝u
).
i°
[
k
];

51 i‡(
°ack
 >
íd
)

57 i‡(
°ack
 >
íd
 - 
EXCEPTION_STKSZ
) {

64 i‡(*
u£dp
 & (1U << 
k
))

66 *
u£dp
 |1U << 
k
;

67 *
idp
 = 
x86_°ack_ids
[
k
];

68  (*)
íd
;

75 #i‡
DEBUG_STKSZ
 > 
EXCEPTION_STKSZ


76 i‡(
k
 =
DEBUG_STACK
 - 1 && 
°ack
 >
íd
 - 
DEBUG_STKSZ
) {

77 
j
 = 
N_EXCEPTION_STACKS
 - 1;

85 ++
j
;

86 
íd
 -
EXCEPTION_STKSZ
;

87 
x86_°ack_ids
[
j
][4] = '1' +

88 (
j
 - 
N_EXCEPTION_STACKS
);

89 } 
°ack
 < 
íd
 - 
EXCEPTION_STKSZ
);

90 i‡(*
u£dp
 & (1U << 
j
))

92 *
u£dp
 |1U << 
j
;

93 *
idp
 = 
x86_°ack_ids
[
j
];

94  (*)
íd
;

98  
NULL
;

99 
	}
}

101 
ölöe
 

102 
	$ö_úq_°ack
(*
°ack
, *
úq_°ack
,

103 *
úq_°ack_íd
)

105  (
°ack
 >
úq_°ack
 && sèck < 
úq_°ack_íd
);

106 
	}
}

117 
ölöe
 

118 
	$fixup_bp_úq_lök
(
bp
, *
°ack
,

119 *
úq_°ack
, *
úq_°ack_íd
)

121 #ifde‡
CONFIG_FRAME_POINTER


122 
°ack_‰ame
 *
‰ame
 = (°ack_‰amê*)
bp
;

123 
√xt
;

125 i‡(!
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
)) {

126 i‡(!
	`¥obe_kî√l_addªss
(&
‰ame
->
√xt_‰ame
, 
√xt
))

127  
√xt
;

129 
	`WARN_ONCE
(1, "Perf: bad frameÖointer = %p in "

130 "ˇŒchaö\n", &
‰ame
->
√xt_‰ame
);

133  
bp
;

134 
	}
}

143 
	$dump_åa˚
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

144 *
°ack
, 
bp
,

145 c⁄° 
°ackåa˚_›s
 *
›s
, *
d©a
)

147 c⁄° 
˝u
 = 
	`gë_˝u
();

148 *
úq_°ack_íd
 =

149 (*)
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
);

150 
u£d
 = 0;

151 
thªad_öfo
 *
töfo
;

152 
gøph
 = 0;

154 i‡(!
èsk
)

155 
èsk
 = 
cuºít
;

157 i‡(!
°ack
) {

158 
dummy
;

159 
°ack
 = &
dummy
;

160 i‡(
èsk
 &&Åask !
cuºít
)

161 
°ack
 = (*)
èsk
->
thªad
.
•
;

164 #ifde‡
CONFIG_FRAME_POINTER


165 i‡(!
bp
) {

166 i‡(
èsk
 =
cuºít
) {

168 
	`gë_bp
(
bp
);

171 
bp
 = *(*Ë
èsk
->
thªad
.
•
;

181 
töfo
 = 
	`èsk_thªad_öfo
(
èsk
);

183 *
id
;

184 *
e°ack_íd
;

185 
e°ack_íd
 = 
	`ö_ex˚±i⁄_°ack
(
˝u
, ()
°ack
,

186 &
u£d
, &
id
);

188 i‡(
e°ack_íd
) {

189 i‡(
›s
->
	`°ack
(
d©a
, 
id
) < 0)

192 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp, ops,

193 
d©a
, 
e°ack_íd
, &
gøph
);

194 
›s
->
	`°ack
(
d©a
, "<EOE>");

200 
°ack
 = (*Ë
e°ack_íd
[-2];

203 i‡(
úq_°ack_íd
) {

204 *
úq_°ack
;

205 
úq_°ack
 = 
úq_°ack_íd
 -

206 (
IRQ_STACK_SIZE
 - 64Ë/ (*
úq_°ack
);

208 i‡(
	`ö_úq_°ack
(
°ack
, 
úq_°ack
, 
úq_°ack_íd
)) {

209 i‡(
›s
->
	`°ack
(
d©a
, "IRQ") < 0)

211 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp,

212 
›s
, 
d©a
, 
úq_°ack_íd
, &
gøph
);

218 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

219 
bp
 = 
	`fixup_bp_úq_lök
(bp, 
°ack
, 
úq_°ack
,

220 
úq_°ack_íd
);

221 
úq_°ack_íd
 = 
NULL
;

222 
›s
->
	`°ack
(
d©a
, "EOI");

232 
bp
 = 
›s
->
	`wÆk_°ack
(
töfo
, 
°ack
, bp, ops, 
d©a
, 
NULL
, &
gøph
);

233 
	`put_˝u
();

234 
	}
}

235 
EXPORT_SYMBOL
(
dump_åa˚
);

238 
	$show_°ack_log_lvl
(
èsk_°ru˘
 *
èsk
, 
±_ªgs
 *
ªgs
,

239 *
•
, 
bp
, *
log_lvl
)

241 *
úq_°ack_íd
;

242 *
úq_°ack
;

243 *
°ack
;

244 
˝u
;

245 
i
;

247 
	`¥ìm±_dißbÀ
();

248 
˝u
 = 
	`smp_¥o˚ss‹_id
();

250 
úq_°ack_íd
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
));

251 
úq_°ack
 = (*)(
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
Ë- 
IRQ_STACK_SIZE
);

257 i‡(
•
 =
NULL
) {

258 i‡(
èsk
)

259 
•
 = (*)
èsk
->
thªad
.sp;

261 
•
 = (*)&sp;

264 
°ack
 = 
•
;

265 
i
 = 0; i < 
k°ack_dïth_to_¥öt
; i++) {

266 i‡(
°ack
 >
úq_°ack
 && sèck <
úq_°ack_íd
) {

267 i‡(
°ack
 =
úq_°ack_íd
) {

268 
°ack
 = (*Ë(
úq_°ack_íd
[-1]);

269 
	`¥ötk
(" <EOI> ");

272 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

275 i‡(
i
 && ((ò% 
STACKSLOTS_PER_LINE
) == 0))

276 
	`¥ötk
("\n%s", 
log_lvl
);

277 
	`¥ötk
(" %016lx", *
°ack
++);

278 
	`touch_nmi_w©chdog
();

280 
	`¥ìm±_íabÀ
();

282 
	`¥ötk
("\n");

283 
	`show_åa˚_log_lvl
(
èsk
, 
ªgs
, 
•
, 
bp
, 
log_lvl
);

284 
	}
}

286 
	$show_ªgi°îs
(
±_ªgs
 *
ªgs
)

288 
i
;

289 
•
;

290 c⁄° 
˝u
 = 
	`smp_¥o˚ss‹_id
();

291 
èsk_°ru˘
 *
cur
 = 
cuºít
;

293 
•
 = 
ªgs
->sp;

294 
	`¥ötk
("CPU %d ", 
˝u
);

295 
	`¥öt_moduÀs
();

296 
	`__show_ªgs
(
ªgs
, 1);

297 
	`¥ötk
("Process %s (pid: %d,Åhreadinfo %p,Åask %p)\n",

298 
cur
->
comm
, cur->
pid
, 
	`èsk_thªad_öfo
(cur), cur);

304 i‡(!
	`u£r_mode
(
ªgs
)) {

305 
code_¥ﬁogue
 = 
code_byãs
 * 43 / 64;

306 
code_Àn
 = 
code_byãs
;

307 
c
;

308 
u8
 *
ù
;

310 
	`¥ötk
(
KERN_EMERG
 "Stack:\n");

311 
	`show_°ack_log_lvl
(
NULL
, 
ªgs
, (*)
•
,

312 
ªgs
->
bp
, 
KERN_EMERG
);

314 
	`¥ötk
(
KERN_EMERG
 "Code: ");

316 
ù
 = (
u8
 *)
ªgs
->ù - 
code_¥ﬁogue
;

317 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 || 
	`¥obe_kî√l_addªss
(ù, 
c
)) {

319 
ù
 = (
u8
 *)
ªgs
->ip;

320 
code_Àn
 = code_À¿- 
code_¥ﬁogue
 + 1;

322 
i
 = 0; i < 
code_Àn
; i++, 
ù
++) {

323 i‡(
ù
 < (
u8
 *)
PAGE_OFFSET
 ||

324 
	`¥obe_kî√l_addªss
(
ù
, 
c
)) {

325 
	`¥ötk
(" Bad RIP value.");

328 i‡(
ù
 =(
u8
 *)
ªgs
->ip)

329 
	`¥ötk
("<%02x> ", 
c
);

331 
	`¥ötk
("%02x ", 
c
);

334 
	`¥ötk
("\n");

335 
	}
}

337 
	$is_vÆid_bugaddr
(
ù
)

339 
ud2
;

341 i‡(
	`__c›y_‰om_u£r
(&
ud2
, (c⁄° 
__u£r
 *Ë
ù
, (ud2)))

344  
ud2
 == 0x0b0f;

345 
	}
}

	@/cmpt816/linux/arch/x86/kernel/e820.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/boŸmem.h
>

15 
	~<löux/p‚.h
>

16 
	~<löux/su•íd.h
>

17 
	~<löux/fúmw¨e-m≠.h
>

19 
	~<asm/e820.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/£tup.h
>

37 
e820m≠
 
	ge820
;

38 
e820m≠
 
	ge820_ßved
;

41 
	gpci_mem_°¨t
 = 0xaeedbabe;

42 #ifde‡
CONFIG_PCI


43 
EXPORT_SYMBOL
(
pci_mem_°¨t
);

51 
	$e820_™y_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

53 
i
;

55 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

56 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

58 i‡(
ty≥
 && 
ei
->type !=Åype)

60 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

65 
	}
}

66 
EXPORT_SYMBOL_GPL
(
e820_™y_m≠≥d
);

74 
__öô
 
	$e820_Æl_m≠≥d
(
u64
 
°¨t
, u64 
íd
, 
ty≥
)

76 
i
;

78 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

79 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

81 i‡(
ty≥
 && 
ei
->type !=Åype)

84 i‡(
ei
->
addr
 >
íd
 ||Éi->add∏+Éi->
size
 <
°¨t
)

90 i‡(
ei
->
addr
 <
°¨t
)

91 
°¨t
 = 
ei
->
addr
 +Éi->
size
;

96 i‡(
°¨t
 >
íd
)

100 
	}
}

105 
__öô
 
	$__e820_add_ªgi⁄
(
e820m≠
 *
e820x
, 
u64
 
°¨t
, u64 
size
,

106 
ty≥
)

108 
x
 = 
e820x
->
ƒ_m≠
;

110 i‡(
x
 >
	`ARRAY_SIZE
(
e820x
->
m≠
)) {

111 
	`¥ötk
(
KERN_ERR
 "Ooops! Too manyÉntries inÅhe memory map!\n");

115 
e820x
->
m≠
[
x
].
addr
 = 
°¨t
;

116 
e820x
->
m≠
[
x
].
size
 = size;

117 
e820x
->
m≠
[
x
].
ty≥
 =Åype;

118 
e820x
->
ƒ_m≠
++;

119 
	}
}

121 
__öô
 
	$e820_add_ªgi⁄
(
u64
 
°¨t
, u64 
size
, 
ty≥
)

123 
	`__e820_add_ªgi⁄
(&
e820
, 
°¨t
, 
size
, 
ty≥
);

124 
	}
}

126 
__öô
 
	$e820_¥öt_ty≥
(
u32
 
ty≥
)

128 
ty≥
) {

129 
E820_RAM
:

130 
E820_RESERVED_KERN
:

131 
	`¥ötk
(
KERN_CONT
 "(usable)");

133 
E820_RESERVED
:

134 
	`¥ötk
(
KERN_CONT
 "(reserved)");

136 
E820_ACPI
:

137 
	`¥ötk
(
KERN_CONT
 "(ACPI data)");

139 
E820_NVS
:

140 
	`¥ötk
(
KERN_CONT
 "(ACPI NVS)");

142 
E820_UNUSABLE
:

143 
	`¥ötk
(
KERN_CONT
 "(unusable)");

146 
	`¥ötk
(
KERN_CONT
 "ty≥ %u", 
ty≥
);

149 
	}
}

151 
__öô
 
	$e820_¥öt_m≠
(*
who
)

153 
i
;

155 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

156 
	`¥ötk
(
KERN_INFO
 " %s: %016Lx - %016Lx ", 
who
,

157 (Ë
e820
.
m≠
[
i
].
addr
,

159 (
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
));

160 
	`e820_¥öt_ty≥
(
e820
.
m≠
[
i
].
ty≥
);

161 
	`¥ötk
(
KERN_CONT
 "\n");

163 
	}
}

227 
__öô
 
	$ßnôize_e820_m≠
(
e820íåy
 *
biosm≠
, 
max_ƒ_m≠
,

228 
u32
 *
≤r_m≠
)

230 
	sch™ge_membî
 {

231 
e820íåy
 *
pbios
;

232 
addr
;

234 
ch™ge_membî
 
ch™ge_poöt_li°
[2*
E820_X_MAX
] 
__öôd©a
;

235 
ch™ge_membî
 *
ch™ge_poöt
[2*
E820_X_MAX
] 
__öôd©a
;

236 
e820íåy
 *
ovîœp_li°
[
E820_X_MAX
] 
__öôd©a
;

237 
e820íåy
 
√w_bios
[
E820_X_MAX
] 
__öôd©a
;

238 
ch™ge_membî
 *
ch™ge_tmp
;

239 
cuºít_ty≥
, 
œ°_ty≥
;

240 
œ°_addr
;

241 
chgidx
, 
°ûl_ch™gög
;

242 
ovîœp_íåõs
;

243 
√w_bios_íåy
;

244 
ﬁd_ƒ
, 
√w_ƒ
, 
chg_ƒ
;

245 
i
;

248 i‡(*
≤r_m≠
 < 2)

251 
ﬁd_ƒ
 = *
≤r_m≠
;

252 
	`BUG_ON
(
ﬁd_ƒ
 > 
max_ƒ_m≠
);

255 
i
 = 0; i < 
ﬁd_ƒ
; i++)

256 i‡(
biosm≠
[
i
].
addr
 + biosm≠[i].
size
 < biosmap[i].addr)

260 
i
 = 0; i < 2 * 
ﬁd_ƒ
; i++)

261 
ch™ge_poöt
[
i
] = &
ch™ge_poöt_li°
[i];

265 
chgidx
 = 0;

266 
i
 = 0; i < 
ﬁd_ƒ
; i++) {

267 i‡(
biosm≠
[
i
].
size
 != 0) {

268 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr;

269 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

270 
ch™ge_poöt
[
chgidx
]->
addr
 = 
biosm≠
[
i
].addr +

271 
biosm≠
[
i
].
size
;

272 
ch™ge_poöt
[
chgidx
++]->
pbios
 = &
biosm≠
[
i
];

275 
chg_ƒ
 = 
chgidx
;

278 
°ûl_ch™gög
 = 1;

279 
°ûl_ch™gög
) {

280 
°ûl_ch™gög
 = 0;

281 
i
 = 1; i < 
chg_ƒ
; i++) {

282 
cuøddr
, 
œ°addr
;

283 
cuΩbaddr
, 
œ°pbaddr
;

285 
cuøddr
 = 
ch™ge_poöt
[
i
]->
addr
;

286 
œ°addr
 = 
ch™ge_poöt
[
i
 - 1]->
addr
;

287 
cuΩbaddr
 = 
ch™ge_poöt
[
i
]->
pbios
->
addr
;

288 
œ°pbaddr
 = 
ch™ge_poöt
[
i
 - 1]->
pbios
->
addr
;

297 i‡(
cuøddr
 < 
œ°addr
 ||

298 (
cuøddr
 =
œ°addr
 && cuødd∏=
cuΩbaddr
 &&

299 
œ°addr
 !
œ°pbaddr
)) {

300 
ch™ge_tmp
 = 
ch™ge_poöt
[
i
];

301 
ch™ge_poöt
[
i
] = change_point[i-1];

302 
ch™ge_poöt
[
i
-1] = 
ch™ge_tmp
;

303 
°ûl_ch™gög
 = 1;

309 
ovîœp_íåõs
 = 0;

310 
√w_bios_íåy
 = 0;

311 
œ°_ty≥
 = 0;

312 
œ°_addr
 = 0;

315 
chgidx
 = 0; chgidx < 
chg_ƒ
; chgidx++) {

317 i‡(
ch™ge_poöt
[
chgidx
]->
addr
 ==

318 
ch™ge_poöt
[
chgidx
]->
pbios
->
addr
) {

323 
ovîœp_li°
[
ovîœp_íåõs
++] =

324 
ch™ge_poöt
[
chgidx
]->
pbios
;

330 
i
 = 0; i < 
ovîœp_íåõs
; i++) {

331 i‡(
ovîœp_li°
[
i
] ==

332 
ch™ge_poöt
[
chgidx
]->
pbios
)

333 
ovîœp_li°
[
i
] =

334 
ovîœp_li°
[
ovîœp_íåõs
-1];

336 
ovîœp_íåõs
--;

343 
cuºít_ty≥
 = 0;

344 
i
 = 0; i < 
ovîœp_íåõs
; i++)

345 i‡(
ovîœp_li°
[
i
]->
ty≥
 > 
cuºít_ty≥
)

346 
cuºít_ty≥
 = 
ovîœp_li°
[
i
]->
ty≥
;

351 i‡(
cuºít_ty≥
 !
œ°_ty≥
) {

352 i‡(
œ°_ty≥
 != 0) {

353 
√w_bios
[
√w_bios_íåy
].
size
 =

354 
ch™ge_poöt
[
chgidx
]->
addr
 - 
œ°_addr
;

359 i‡(
√w_bios
[
√w_bios_íåy
].
size
 != 0)

364 i‡(++
√w_bios_íåy
 >
max_ƒ_m≠
)

367 i‡(
cuºít_ty≥
 != 0) {

368 
√w_bios
[
√w_bios_íåy
].
addr
 =

369 
ch™ge_poöt
[
chgidx
]->
addr
;

370 
√w_bios
[
√w_bios_íåy
].
ty≥
 = 
cuºít_ty≥
;

371 
œ°_addr
 = 
ch™ge_poöt
[
chgidx
]->
addr
;

373 
œ°_ty≥
 = 
cuºít_ty≥
;

377 
√w_ƒ
 = 
√w_bios_íåy
;

380 
	`mem˝y
(
biosm≠
, 
√w_bios
, 
√w_ƒ
 * (
e820íåy
));

381 *
≤r_m≠
 = 
√w_ƒ
;

384 
	}
}

386 
__öô
 
	$__≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

388 
ƒ_m≠
) {

389 
u64
 
°¨t
 = 
biosm≠
->
addr
;

390 
u64
 
size
 = 
biosm≠
->size;

391 
u64
 
íd
 = 
°¨t
 + 
size
;

392 
u32
 
ty≥
 = 
biosm≠
->type;

395 i‡(
°¨t
 > 
íd
)

398 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
ty≥
);

400 
biosm≠
++;

401 
ƒ_m≠
--;

404 
	}
}

415 
__öô
 
	$≠≥nd_e820_m≠
(
e820íåy
 *
biosm≠
, 
ƒ_m≠
)

418 i‡(
ƒ_m≠
 < 2)

421  
	`__≠≥nd_e820_m≠
(
biosm≠
, 
ƒ_m≠
);

422 
	}
}

424 
u64
 
__öô
 
	$__e820_upd©e_ønge
(
e820m≠
 *
e820x
, 
u64
 
°¨t
,

425 
u64
 
size
, 
ﬁd_ty≥
,

426 
√w_ty≥
)

428 
u64
 
íd
;

429 
i
;

430 
u64
 
ªÆ_upd©ed_size
 = 0;

432 
	`BUG_ON
(
ﬁd_ty≥
 =
√w_ty≥
);

434 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

435 
size
 = 
ULLONG_MAX
 - 
°¨t
;

437 
íd
 = 
°¨t
 + 
size
;

438 
	`¥ötk
(
KERN_DEBUG
 "e820 updateÑange: %016Lx - %016Lx ",

439 (Ë
°¨t
,

440 (Ë
íd
);

441 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

442 
	`¥ötk
(
KERN_CONT
 " ==> ");

443 
	`e820_¥öt_ty≥
(
√w_ty≥
);

444 
	`¥ötk
(
KERN_CONT
 "\n");

446 
i
 = 0; i < 
e820x
->
ƒ_m≠
; i++) {

447 
e820íåy
 *
ei
 = &
e820x
->
m≠
[
i
];

448 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

449 
u64
 
ei_íd
;

451 i‡(
ei
->
ty≥
 !
ﬁd_ty≥
)

454 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

456 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

457 
ei
->
ty≥
 = 
√w_ty≥
;

458 
ªÆ_upd©ed_size
 +
ei
->
size
;

463 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

464 
	`__e820_add_ªgi⁄
(
e820x
, 
°¨t
, 
size
, 
√w_ty≥
);

465 
	`__e820_add_ªgi⁄
(
e820x
, 
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

466 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

467 
ªÆ_upd©ed_size
 +
size
;

472 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

473 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

474 i‡(
föÆ_°¨t
 >
föÆ_íd
)

477 
	`__e820_add_ªgi⁄
(
e820x
, 
föÆ_°¨t
, 
föÆ_íd
 - final_start,

478 
√w_ty≥
);

480 
ªÆ_upd©ed_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

486 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

487 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

489 
ei
->
addr
 = 
föÆ_íd
;

491  
ªÆ_upd©ed_size
;

492 
	}
}

494 
u64
 
__öô
 
	$e820_upd©e_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

495 
√w_ty≥
)

497  
	`__e820_upd©e_ønge
(&
e820
, 
°¨t
, 
size
, 
ﬁd_ty≥
, 
√w_ty≥
);

498 
	}
}

500 
u64
 
__öô
 
	$e820_upd©e_ønge_ßved
(
u64
 
°¨t
, u64 
size
,

501 
ﬁd_ty≥
, 
√w_ty≥
)

503  
	`__e820_upd©e_ønge
(&
e820_ßved
, 
°¨t
, 
size
, 
ﬁd_ty≥
,

504 
√w_ty≥
);

505 
	}
}

508 
u64
 
__öô
 
	$e820_ªmove_ønge
(
u64
 
°¨t
, u64 
size
, 
ﬁd_ty≥
,

509 
checkty≥
)

511 
i
;

512 
u64
 
íd
;

513 
u64
 
ªÆ_ªmoved_size
 = 0;

515 i‡(
size
 > (
ULLONG_MAX
 - 
°¨t
))

516 
size
 = 
ULLONG_MAX
 - 
°¨t
;

518 
íd
 = 
°¨t
 + 
size
;

519 
	`¥ötk
(
KERN_DEBUG
 "e820ÑemoveÑange: %016Lx - %016Lx ",

520 (Ë
°¨t
,

521 (Ë
íd
);

522 i‡(
checkty≥
)

523 
	`e820_¥öt_ty≥
(
ﬁd_ty≥
);

524 
	`¥ötk
(
KERN_CONT
 "\n");

526 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

527 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

528 
u64
 
föÆ_°¨t
, 
föÆ_íd
;

529 
u64
 
ei_íd
;

531 i‡(
checkty≥
 && 
ei
->
ty≥
 !
ﬁd_ty≥
)

534 
ei_íd
 = 
ei
->
addr
 +Éi->
size
;

536 i‡(
ei
->
addr
 >
°¨t
 && 
ei_íd
 <
íd
) {

537 
ªÆ_ªmoved_size
 +
ei
->
size
;

538 
	`mem£t
(
ei
, 0, (
e820íåy
));

543 i‡(
ei
->
addr
 < 
°¨t
 && 
ei_íd
 > 
íd
) {

544 
	`e820_add_ªgi⁄
(
íd
, 
ei_íd
 -Énd, 
ei
->
ty≥
);

545 
ei
->
size
 = 
°¨t
 -Éi->
addr
;

546 
ªÆ_ªmoved_size
 +
size
;

551 
föÆ_°¨t
 = 
	`max
(
°¨t
, 
ei
->
addr
);

552 
föÆ_íd
 = 
	`mö
(
íd
, 
ei_íd
);

553 i‡(
föÆ_°¨t
 >
föÆ_íd
)

555 
ªÆ_ªmoved_size
 +
föÆ_íd
 - 
föÆ_°¨t
;

561 
ei
->
size
 -
föÆ_íd
 - 
föÆ_°¨t
;

562 i‡(
ei
->
addr
 < 
föÆ_°¨t
)

564 
ei
->
addr
 = 
föÆ_íd
;

566  
ªÆ_ªmoved_size
;

567 
	}
}

569 
__öô
 
	$upd©e_e820
()

571 
u32
 
ƒ_m≠
;

573 
ƒ_m≠
 = 
e820
.nr_map;

574 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ_m≠
))

576 
e820
.
ƒ_m≠
 =Çr_map;

577 
	`¥ötk
(
KERN_INFO
 "modifiedÖhysical RAM map:\n");

578 
	`e820_¥öt_m≠
("modified");

579 
	}
}

580 
__öô
 
	$upd©e_e820_ßved
()

582 
u32
 
ƒ_m≠
;

584 
ƒ_m≠
 = 
e820_ßved
.nr_map;

585 i‡(
	`ßnôize_e820_m≠
(
e820_ßved
.
m≠
, 
	`ARRAY_SIZE
”820_ßved.m≠), &
ƒ_m≠
))

587 
e820_ßved
.
ƒ_m≠
 =Çr_map;

588 
	}
}

589 
	#MAX_GAP_END
 0x100000000uŒ

	)

593 
__öô
 
	$e820_£¨ch_g≠
(*
g≠°¨t
, *
g≠size
,

594 
°¨t_addr
, 
íd_addr
)

596 
œ°
;

597 
i
 = 
e820
.
ƒ_m≠
;

598 
found
 = 0;

600 
œ°
 = (
íd_addr
 &&Énd_add∏< 
MAX_GAP_END
) ?Énd_addr : MAX_GAP_END;

602 --
i
 >= 0) {

603 
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

604 
íd
 = 
°¨t
 + 
e820
.
m≠
[
i
].
size
;

606 i‡(
íd
 < 
°¨t_addr
)

613 i‡(
œ°
 > 
íd
) {

614 
g≠
 = 
œ°
 - 
íd
;

616 i‡(
g≠
 >*
g≠size
) {

617 *
g≠size
 = 
g≠
;

618 *
g≠°¨t
 = 
íd
;

619 
found
 = 1;

622 i‡(
°¨t
 < 
œ°
)

623 
œ°
 = 
°¨t
;

625  
found
;

626 
	}
}

634 
__öô
 
	$e820_£tup_g≠
()

636 
g≠°¨t
, 
g≠size
;

637 
found
;

639 
g≠°¨t
 = 0x10000000;

640 
g≠size
 = 0x400000;

641 
found
 = 
	`e820_£¨ch_g≠
(&
g≠°¨t
, &
g≠size
, 0, 
MAX_GAP_END
);

643 #ifde‡
CONFIG_X86_64


644 i‡(!
found
) {

645 
g≠°¨t
 = (
max_p‚
 << 
PAGE_SHIFT
) + 1024*1024;

646 
	`¥ötk
(
KERN_ERR


655 
pci_mem_°¨t
 = 
g≠°¨t
;

657 
	`¥ötk
(
KERN_INFO


659 
pci_mem_°¨t
, 
g≠°¨t
, 
g≠size
);

660 
	}
}

668 
__öô
 
	$∑r£_e820_ext
(
£tup_d©a
 *
sd©a
, 
∑_d©a
)

670 
u32
 
m≠_Àn
;

671 
íåõs
;

672 
e820íåy
 *
extm≠
;

674 
íåõs
 = 
sd©a
->
Àn
 / (
e820íåy
);

675 
m≠_Àn
 = 
sd©a
->
Àn
 + (
£tup_d©a
);

676 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

677 
sd©a
 = 
	`óæy_i‹em≠
(
∑_d©a
, 
m≠_Àn
);

678 
extm≠
 = (
e820íåy
 *)(
sd©a
->
d©a
);

679 
	`__≠≥nd_e820_m≠
(
extm≠
, 
íåõs
);

680 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

681 i‡(
m≠_Àn
 > 
PAGE_SIZE
)

682 
	`óæy_iounm≠
(
sd©a
, 
m≠_Àn
);

683 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

684 
	`e820_¥öt_m≠
("extended");

685 
	}
}

687 #i‡
deföed
(
CONFIG_X86_64
) || \

688 (
deföed
(
CONFIG_X86_32
Ë&& 
	$deföed
(
CONFIG_HIBERNATION
))

697 
__öô
 
	$e820_m¨k_noßve_ªgi⁄s
(
limô_p‚
)

699 
i
;

700 
p‚
;

702 
p‚
 = 
	`PFN_DOWN
(
e820
.
m≠
[0].
addr
 +É820.m≠[0].
size
);

703 
i
 = 1; i < 
e820
.
ƒ_m≠
; i++) {

704 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

706 i‡(
p‚
 < 
	`PFN_UP
(
ei
->
addr
))

707 
	`ªgi°î_noßve_ªgi⁄
(
p‚
, 
	`PFN_UP
(
ei
->
addr
));

709 
p‚
 = 
	`PFN_DOWN
(
ei
->
addr
 +Éi->
size
);

710 i‡(
ei
->
ty≥
 !
E820_RAM
 &&Éi->ty≥ !
E820_RESERVED_KERN
)

711 
	`ªgi°î_noßve_ªgi⁄
(
	`PFN_UP
(
ei
->
addr
), 
p‚
);

713 i‡(
p‚
 >
limô_p‚
)

716 
	}
}

719 #ifde‡
CONFIG_HIBERNATION


724 
__öô
 
	$e820_m¨k_nvs_mem‹y
()

726 
i
;

728 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

729 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

731 i‡(
ei
->
ty≥
 =
E820_NVS
)

732 
	`su•íd_nvs_ªgi°î
(
ei
->
addr
,Éi->
size
);

736 
	}
}

737 
c‹e_öôˇŒ
(
e820_m¨k_nvs_mem‹y
);

743 
u64
 
__öô
 
	$föd_e820_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

745 
i
;

747 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

748 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

749 
u64
 
addr
;

750 
u64
 
ei_°¨t
, 
ei_œ°
;

752 i‡(
ei
->
ty≥
 !
E820_RAM
)

755 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

756 
ei_°¨t
 = 
ei
->
addr
;

757 
addr
 = 
	`föd_óæy_¨ó
(
ei_°¨t
, 
ei_œ°
, 
°¨t
, 
íd
,

758 
size
, 
Æign
);

760 i‡(
addr
 != -1ULL)

761  
addr
;

764 
	}
}

766 
u64
 
__öô
 
	$föd_fw_memm≠_¨ó
(
u64
 
°¨t
, u64 
íd
, u64 
size
, u64 
Æign
)

768  
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

769 
	}
}

771 
u64
 
__öô
 
	$gë_max_m≠≥d
()

773 
u64
 
íd
 = 
max_p‚_m≠≥d
;

775 
íd
 <<
PAGE_SHIFT
;

777  
íd
;

778 
	}
}

782 
u64
 
__öô
 
	$föd_e820_¨ó_size
(
u64
 
°¨t
, u64 *
sizï
, u64 
Æign
)

784 
i
;

786 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

787 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

788 
u64
 
addr
;

789 
u64
 
ei_°¨t
, 
ei_œ°
;

791 i‡(
ei
->
ty≥
 !
E820_RAM
)

794 
ei_œ°
 = 
ei
->
addr
 +Éi->
size
;

795 
ei_°¨t
 = 
ei
->
addr
;

796 
addr
 = 
	`föd_óæy_¨ó_size
(
ei_°¨t
, 
ei_œ°
, 
°¨t
,

797 
sizï
, 
Æign
);

799 i‡(
addr
 != -1ULL)

800  
addr
;

804 
	}
}

809 
u64
 
__öô
 
	$óæy_ª£rve_e820
(
u64
 
°¨â
, u64 
sizë
, u64 
Æign
)

811 
u64
 
size
 = 0;

812 
u64
 
addr
;

813 
u64
 
°¨t
;

815 
°¨t
 = 
°¨â
; ; sèπ +
size
) {

816 
°¨t
 = 
	`föd_e820_¨ó_size
(°¨t, &
size
, 
Æign
);

817 i‡(!(
°¨t
 + 1))

819 i‡(
size
 >
sizë
)

823 #ifde‡
CONFIG_X86_32


824 i‡(
°¨t
 >
MAXMEM
)

826 i‡(
°¨t
 + 
size
 > 
MAXMEM
)

827 
size
 = 
MAXMEM
 - 
°¨t
;

830 
addr
 = 
	`round_down
(
°¨t
 + 
size
 - 
sizë
, 
Æign
);

831 i‡(
addr
 < 
°¨t
)

833 
	`e820_upd©e_ønge
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

834 
	`e820_upd©e_ønge_ßved
(
addr
, 
sizë
, 
E820_RAM
, 
E820_RESERVED
);

835 
	`¥ötk
(
KERN_INFO
 "updateÉ820 forÉarly_reserve_e820\n");

836 
	`upd©e_e820
();

837 
	`upd©e_e820_ßved
();

839  
addr
;

840 
	}
}

842 #ifde‡
CONFIG_X86_32


843 #ifde‡
CONFIG_X86_PAE


844 
	#MAX_ARCH_PFN
 (1ULL<<(36-
PAGE_SHIFT
))

	)

846 
	#MAX_ARCH_PFN
 (1ULL<<(32-
PAGE_SHIFT
))

	)

849 
	#MAX_ARCH_PFN
 
MAXMEM
>>
PAGE_SHIFT


	)

855 
__öô
 
	$e820_íd_p‚
(
limô_p‚
, 
ty≥
)

857 
i
;

858 
œ°_p‚
 = 0;

859 
max_¨ch_p‚
 = 
MAX_ARCH_PFN
;

861 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

862 
e820íåy
 *
ei
 = &
e820
.
m≠
[
i
];

863 
°¨t_p‚
;

864 
íd_p‚
;

866 i‡(
ei
->
ty≥
 !=Åype)

869 
°¨t_p‚
 = 
ei
->
addr
 >> 
PAGE_SHIFT
;

870 
íd_p‚
 = (
ei
->
addr
 +Éi->
size
Ë>> 
PAGE_SHIFT
;

872 i‡(
°¨t_p‚
 >
limô_p‚
)

874 i‡(
íd_p‚
 > 
limô_p‚
) {

875 
œ°_p‚
 = 
limô_p‚
;

878 i‡(
íd_p‚
 > 
œ°_p‚
)

879 
œ°_p‚
 = 
íd_p‚
;

882 i‡(
œ°_p‚
 > 
max_¨ch_p‚
)

883 
œ°_p‚
 = 
max_¨ch_p‚
;

885 
	`¥ötk
(
KERN_INFO
 "last_pfn = %#lx max_arch_pfn = %#lx\n",

886 
œ°_p‚
, 
max_¨ch_p‚
);

887  
œ°_p‚
;

888 
	}
}

889 
__öô
 
	$e820_íd_of_øm_p‚
()

891  
	`e820_íd_p‚
(
MAX_ARCH_PFN
, 
E820_RAM
);

892 
	}
}

894 
__öô
 
	$e820_íd_of_low_øm_p‚
()

896  
	`e820_íd_p‚
(1UL<<(32 - 
PAGE_SHIFT
), 
E820_RAM
);

897 
	}
}

902 
__öô
 
	$e820_föd_a˘ive_ªgi⁄
(c⁄° 
e820íåy
 *
ei
,

903 
°¨t_p‚
,

904 
œ°_p‚
,

905 *
ei_°¨ç‚
,

906 *
ei_ídp‚
)

908 
u64
 
Æign
 = 
PAGE_SIZE
;

910 *
ei_°¨ç‚
 = 
	`round_up
(
ei
->
addr
, 
Æign
Ë>> 
PAGE_SHIFT
;

911 *
ei_ídp‚
 = 
	`round_down
(
ei
->
addr
 +Éi->
size
, 
Æign
Ë>> 
PAGE_SHIFT
;

914 i‡(*
ei_°¨ç‚
 >*
ei_ídp‚
)

918 i‡(
ei
->
ty≥
 !
E820_RAM
 || *
ei_ídp‚
 <
°¨t_p‚
 ||

919 *
ei_°¨ç‚
 >
œ°_p‚
)

923 i‡(*
ei_°¨ç‚
 < 
°¨t_p‚
)

924 *
ei_°¨ç‚
 = 
°¨t_p‚
;

925 i‡(*
ei_ídp‚
 > 
œ°_p‚
)

926 *
ei_ídp‚
 = 
œ°_p‚
;

929 
	}
}

932 
__öô
 
	$e820_ªgi°î_a˘ive_ªgi⁄s
(
nid
, 
°¨t_p‚
,

933 
œ°_p‚
)

935 
ei_°¨ç‚
;

936 
ei_ídp‚
;

937 
i
;

939 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++)

940 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

941 
°¨t_p‚
, 
œ°_p‚
,

942 &
ei_°¨ç‚
, &
ei_ídp‚
))

943 
	`add_a˘ive_ønge
(
nid
, 
ei_°¨ç‚
, 
ei_ídp‚
);

944 
	}
}

951 
u64
 
__öô
 
	$e820_hﬁe_size
(
u64
 
°¨t
, u64 
íd
)

953 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

954 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

955 
ei_°¨ç‚
, 
ei_ídp‚
, 
øm
 = 0;

956 
i
;

958 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

959 i‡(
	`e820_föd_a˘ive_ªgi⁄
(&
e820
.
m≠
[
i
],

960 
°¨t_p‚
, 
œ°_p‚
,

961 &
ei_°¨ç‚
, &
ei_ídp‚
))

962 
øm
 +
ei_ídp‚
 - 
ei_°¨ç‚
;

964  
íd
 - 
°¨t
 - ((
u64
)
øm
 << 
PAGE_SHIFT
);

965 
	}
}

967 
	$óæy_∑nic
(*
msg
)

969 
	`óæy_¥ötk
(
msg
);

970 
	`∑nic
(
msg
);

971 
	}
}

973 
u£rdef
 
	g__öôd©a
;

976 
__öô
 
	$∑r£_mem›t
(*
p
)

978 
u64
 
mem_size
;

980 i‡(!
p
)

981  -
EINVAL
;

983 #ifde‡
CONFIG_X86_32


984 i‡(!
	`°rcmp
(
p
, "nopentium")) {

985 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_PSE
);

990 
u£rdef
 = 1;

991 
mem_size
 = 
	`mem∑r£
(
p
, &p);

992 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

995 
	}
}

996 
óæy_∑øm
("mem", 
∑r£_mem›t
);

998 
__öô
 
	$∑r£_memm≠_›t
(*
p
)

1000 *
ﬁdp
;

1001 
u64
 
°¨t_©
, 
mem_size
;

1003 i‡(!
p
)

1004  -
EINVAL
;

1006 i‡(!
	`°∫cmp
(
p
, "exactmap", 8)) {

1007 #ifde‡
CONFIG_CRASH_DUMP


1013 
ßved_max_p‚
 = 
	`e820_íd_of_øm_p‚
();

1015 
e820
.
ƒ_m≠
 = 0;

1016 
u£rdef
 = 1;

1020 
ﬁdp
 = 
p
;

1021 
mem_size
 = 
	`mem∑r£
(
p
, &p);

1022 i‡(
p
 =
ﬁdp
)

1023  -
EINVAL
;

1025 
u£rdef
 = 1;

1026 i‡(*
p
 == '@') {

1027 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1028 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RAM
);

1029 } i‡(*
p
 == '#') {

1030 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1031 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_ACPI
);

1032 } i‡(*
p
 == '$') {

1033 
°¨t_©
 = 
	`mem∑r£
(
p
+1, &p);

1034 
	`e820_add_ªgi⁄
(
°¨t_©
, 
mem_size
, 
E820_RESERVED
);

1036 
	`e820_ªmove_ønge
(
mem_size
, 
ULLONG_MAX
 - mem_size, 
E820_RAM
, 1);

1038  *
p
 ='\0' ? 0 : -
EINVAL
;

1039 
	}
}

1040 
óæy_∑øm
("memm≠", 
∑r£_memm≠_›t
);

1042 
__öô
 
	$föish_e820_∑rsög
()

1044 i‡(
u£rdef
) {

1045 
u32
 
ƒ
 = 
e820
.
ƒ_m≠
;

1047 i‡(
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &
ƒ
) < 0)

1048 
	`óæy_∑nic
("Invalid user supplied memory map");

1049 
e820
.
ƒ_m≠
 = 
ƒ
;

1051 
	`¥ötk
(
KERN_INFO
 "user-definedÖhysical RAM map:\n");

1052 
	`e820_¥öt_m≠
("user");

1054 
	}
}

1056 
ölöe
 c⁄° *
	$e820_ty≥_to_°rög
(
e820_ty≥
)

1058 
e820_ty≥
) {

1059 
E820_RESERVED_KERN
:

1060 
E820_RAM
:  "System RAM";

1061 
E820_ACPI
:  "ACPI Tables";

1062 
E820_NVS
:  "ACPI Non-volatile Storage";

1063 
E820_UNUSABLE
:  "Unusable memory";

1066 
	}
}

1071 
ªsour˚
 
__öôd©a
 *
	ge820_ªs
;

1072 
__öô
 
	$e820_ª£rve_ªsour˚s
()

1074 
i
;

1075 
ªsour˚
 *
ªs
;

1076 
u64
 
íd
;

1078 
ªs
 = 
	`Æloc_boŸmem
((
ªsour˚
Ë* 
e820
.
ƒ_m≠
);

1079 
e820_ªs
 = 
ªs
;

1080 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1081 
íd
 = 
e820
.
m≠
[
i
].
addr
 +É820.m≠[i].
size
 - 1;

1082 i‡(
íd
 !(
ªsour˚_size_t
)end) {

1083 
ªs
++;

1086 
ªs
->
«me
 = 
	`e820_ty≥_to_°rög
(
e820
.
m≠
[
i
].
ty≥
);

1087 
ªs
->
°¨t
 = 
e820
.
m≠
[
i
].
addr
;

1088 
ªs
->
íd
 =Énd;

1090 
ªs
->
Êags
 = 
IORESOURCE_MEM
;

1097 i‡(
e820
.
m≠
[
i
].
ty≥
 !
E820_RESERVED
 || 
ªs
->
°¨t
 < (1ULL<<20)) {

1098 
ªs
->
Êags
 |
IORESOURCE_BUSY
;

1099 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

1101 
ªs
++;

1104 
i
 = 0; i < 
e820_ßved
.
ƒ_m≠
; i++) {

1105 
e820íåy
 *
íåy
 = &
e820_ßved
.
m≠
[
i
];

1106 
	`fúmw¨e_m≠_add_óæy
(
íåy
->
addr
,

1107 
íåy
->
addr
 +É¡ry->
size
 - 1,

1108 
	`e820_ty≥_to_°rög
(
íåy
->
ty≥
));

1110 
	}
}

1113 
	$øm_Æignmít
(
ªsour˚_size_t
 
pos
)

1115 
mb
 = 
pos
 >> 20;

1118 i‡(!
mb
)

1122 i‡(
mb
 < 16)

1127 
	}
}

1129 
	#MAX_RESOURCE_SIZE
 ((
ªsour˚_size_t
)-1)

	)

1131 
__öô
 
	$e820_ª£rve_ªsour˚s_œã
()

1133 
i
;

1134 
ªsour˚
 *
ªs
;

1136 
ªs
 = 
e820_ªs
;

1137 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1138 i‡(!
ªs
->
∑ª¡
 &&Ñes->
íd
)

1139 
	`ö£π_ªsour˚_ex∑nd_to_fô
(&
iomem_ªsour˚
, 
ªs
);

1140 
ªs
++;

1147 
i
 = 0; i < 
e820
.
ƒ_m≠
; i++) {

1148 
e820íåy
 *
íåy
 = &
e820
.
m≠
[
i
];

1149 
u64
 
°¨t
, 
íd
;

1151 i‡(
íåy
->
ty≥
 !
E820_RAM
)

1153 
°¨t
 = 
íåy
->
addr
 +É¡ry->
size
;

1154 
íd
 = 
	`round_up
(
°¨t
, 
	`øm_Æignmít
(start)) - 1;

1155 i‡(
íd
 > 
MAX_RESOURCE_SIZE
)

1156 
íd
 = 
MAX_RESOURCE_SIZE
;

1157 i‡(
°¨t
 >
íd
)

1159 
	`¥ötk
(
KERN_DEBUG
 "reserve RAM buffer: %016llx - %016llx ",

1160 
°¨t
, 
íd
);

1161 
	`ª£rve_ªgi⁄_wôh_•lô
(&
iomem_ªsour˚
, 
°¨t
, 
íd
,

1164 
	}
}

1166 *
__öô
 
	$deÁu…_machöe_•ecific_mem‹y_£tup
()

1168 *
who
 = "BIOS-e820";

1169 
u32
 
√w_ƒ
;

1176 
√w_ƒ
 = 
boŸ_∑øms
.
e820_íåõs
;

1177 
	`ßnôize_e820_m≠
(
boŸ_∑øms
.
e820_m≠
,

1178 
	`ARRAY_SIZE
(
boŸ_∑øms
.
e820_m≠
),

1179 &
√w_ƒ
);

1180 
boŸ_∑øms
.
e820_íåõs
 = 
√w_ƒ
;

1181 i‡(
	`≠≥nd_e820_m≠
(
boŸ_∑øms
.
e820_m≠
, boŸ_∑øms.
e820_íåõs
)

1183 
u64
 
mem_size
;

1186 i‡(
boŸ_∑øms
.
Æt_mem_k


1187 < 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
) {

1188 
mem_size
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
ext_mem_k
;

1189 
who
 = "BIOS-88";

1191 
mem_size
 = 
boŸ_∑øms
.
Æt_mem_k
;

1192 
who
 = "BIOS-e801";

1195 
e820
.
ƒ_m≠
 = 0;

1196 
	`e820_add_ªgi⁄
(0, 
	`LOWMEMSIZE
(), 
E820_RAM
);

1197 
	`e820_add_ªgi⁄
(
HIGH_MEMORY
, 
mem_size
 << 10, 
E820_RAM
);

1201  
who
;

1202 
	}
}

1204 
__öô
 
	$£tup_mem‹y_m≠
()

1206 *
who
;

1208 
who
 = 
x86_öô
.
ªsour˚s
.
	`mem‹y_£tup
();

1209 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

1210 
	`¥ötk
(
KERN_INFO
 "BIOS-providedÖhysical RAM map:\n");

1211 
	`e820_¥öt_m≠
(
who
);

1212 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early-quirks.c

12 
	~<löux/pci.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/pci_ids.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/dma.h
>

17 
	~<asm/io_≠ic.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/iommu.h
>

20 
	~<asm/g¨t.h
>

21 
	~<asm/h≥t.h
>

23 
__öô
 
	$fix_hy≥πøn•‹t_c⁄fig
(
num
, 
¶Ÿ
, 
func
)

25 
u32
 
htcfg
;

32 
htcfg
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68);

33 i‡(
htcfg
 & (1 << 18)) {

34 
	`¥ötk
(
KERN_INFO
 "Detected use ofÉxtendedápic ids "

36 i‡((
htcfg
 & (1 << 17)) == 0) {

37 
	`¥ötk
(
KERN_INFO
 "Enabling hypertransportÉxtended "

39 
	`¥ötk
(
KERN_INFO
 "NoteÅhis isá bios bug, "

41 
htcfg
 |= (1 << 17);

42 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x68, 
htcfg
);

47 
	}
}

49 
__öô
 
	$vü_bugs
(
num
, 
¶Ÿ
, 
func
)

51 #ifde‡
CONFIG_GART_IOMMU


52 i‡((
max_p‚
 > 
MAX_DMA32_PFN
 || 
f‹˚_iommu
) &&

53 !
g¨t_iommu_≠îtuª_Ælowed
) {

54 
	`¥ötk
(
KERN_INFO


57 
g¨t_iommu_≠îtuª_dißbÀd
 = 1;

60 
	}
}

62 #ifde‡
CONFIG_ACPI


63 #ifde‡
CONFIG_X86_IO_APIC


65 
__öô
 
	$nvidü_h≥t_check
(
a˝i_èbÀ_hódî
 *
hódî
)

68 
	}
}

72 
__öô
 
	$nvidü_bugs
(
num
, 
¶Ÿ
, 
func
)

74 #ifde‡
CONFIG_ACPI


75 #ifde‡
CONFIG_X86_IO_APIC


83 i‡(
a˝i_u£_timî_ovîride
)

86 i‡(
	`a˝i_èbÀ_∑r£
(
ACPI_SIG_HPET
, 
nvidü_h≥t_check
)) {

87 
a˝i_skù_timî_ovîride
 = 1;

88 
	`¥ötk
(
KERN_INFO
 "Nvidia board "

91 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

98 
	}
}

100 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

101 #i‡
deföed
(
CONFIG_ACPI
Ë&& deföed(
CONFIG_X86_IO_APIC
)

102 
u32
 
__öô
 
	$©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
)

104 
u32
 
d
;

105 
u8
 
b
;

107 
b
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac);

108 
b
 &= ~(1<<5);

109 
	`wrôe_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
, 0xac, 
b
);

111 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

112 
d
 |= 1<<8;

113 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

115 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

116 
d
 &= 0xff;

117  
d
;

118 
	}
}

121 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

123 
u32
 
d
;

124 
u8
 
b
;

126 i‡(
a˝i_u£_timî_ovîride
)

129 
d
 = 
	`©i_ixp4x0_ªv
(
num
, 
¶Ÿ
, 
func
);

130 i‡(
d
 < 0x82)

131 
a˝i_skù_timî_ovîride
 = 1;

134 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

135 i‡(!(
b
 & 0x2))

136 
a˝i_skù_timî_ovîride
 = 1;

139 i‡(
a˝i_skù_timî_ovîride
) {

140 
	`¥ötk
(
KERN_INFO
 "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

141 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

142 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

145 
	}
}

147 
u32
 
__öô
 
	$©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
)

149 
u32
 
ﬁd
, 
d
;

151 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70);

152 
ﬁd
 = 
d
;

153 
d
 &= ~(1<<8);

154 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
d
);

155 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x8);

156 
d
 &= 0xff;

157 
	`wrôe_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x70, 
ﬁd
);

159  
d
;

160 
	}
}

162 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

164 
u32
 
d
, 
ªv
;

166 i‡(
a˝i_u£_timî_ovîride
)

169 
ªv
 = 
	`©i_sbx00_ªv
(
num
, 
¶Ÿ
, 
func
);

170 i‡(
ªv
 > 0x13)

174 
d
 = 
	`ªad_pci_c⁄fig
(
num
, 
¶Ÿ
, 
func
, 0x64);

175 i‡(!(
d
 & (1<<14)))

176 
a˝i_skù_timî_ovîride
 = 1;

178 i‡(
a˝i_skù_timî_ovîride
) {

179 
	`¥ötk
(
KERN_INFO
 "SB600Ñevisi⁄ 0x%x\n", 
ªv
);

180 
	`¥ötk
(
KERN_INFO
 "Ignoring ACPIÅimer override.\n");

181 
	`¥ötk
(
KERN_INFO
 "If you gotÅimerÅrouble "

184 
	}
}

186 
__öô
 
	$©i_bugs
(
num
, 
¶Ÿ
, 
func
)

188 
	}
}

190 
__öô
 
	$©i_bugs_c⁄td
(
num
, 
¶Ÿ
, 
func
)

192 
	}
}

203 
__öô
 
	$©i_h≥t_bugs
(
num
, 
¶Ÿ
, 
func
)

205 #ifde‡
CONFIG_HPET_TIMER


206 
h≥t_ªadback_cmp
 = 1;

208 
	}
}

210 
	#QFLAG_APPLY_ONCE
 0x1

	)

211 
	#QFLAG_APPLIED
 0x2

	)

212 
	#QFLAG_DONE
 (
QFLAG_APPLY_ONCE
|
QFLAG_APPLIED
)

	)

213 
	schù£t
 {

214 
u32
 
	mvíd‹
;

215 
u32
 
	mdevi˚
;

216 
u32
 
	m˛ass
;

217 
u32
 
	m˛ass_mask
;

218 
u32
 
	mÊags
;

219 (*
	mf
)(
	mnum
, 
	m¶Ÿ
, 
	mfunc
);

228 
chù£t
 
	góæy_qrk
[] 
	g__öôd©a
 = {

229 { 
PCI_VENDOR_ID_NVIDIA
, 
PCI_ANY_ID
,

230 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
nvidü_bugs
 },

231 { 
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
,

232 
PCI_CLASS_BRIDGE_PCI
, 
PCI_ANY_ID
, 
QFLAG_APPLY_ONCE
, 
vü_bugs
 },

233 { 
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

234 
PCI_CLASS_BRIDGE_HOST
, 
PCI_ANY_ID
, 0, 
fix_hy≥πøn•‹t_c⁄fig
 },

235 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

236 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs
 },

237 { 
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

238 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_bugs_c⁄td
 },

239 { 
PCI_VENDOR_ID_ATI
, 
PCI_ANY_ID
,

240 
PCI_CLASS_SERIAL_SMBUS
, 
PCI_ANY_ID
, 0, 
©i_h≥t_bugs
 },

255 
__öô
 
	$check_dev_quúk
(
num
, 
¶Ÿ
, 
func
)

257 
u16
 
˛ass
;

258 
u16
 
víd‹
;

259 
u16
 
devi˚
;

260 
u8
 
ty≥
;

261 
i
;

263 
˛ass
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_CLASS_DEVICE
);

265 i‡(
˛ass
 == 0xffff)

268 
víd‹
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_VENDOR_ID
);

270 
devi˚
 = 
	`ªad_pci_c⁄fig_16
(
num
, 
¶Ÿ
, 
func
, 
PCI_DEVICE_ID
);

272 
i
 = 0; 
óæy_qrk
[i].
f
 !
NULL
; i++) {

273 i‡(((
óæy_qrk
[
i
].
víd‹
 =
PCI_ANY_ID
) ||

274 (
óæy_qrk
[
i
].
víd‹
 == vendor)) &&

275 ((
óæy_qrk
[
i
].
devi˚
 =
PCI_ANY_ID
) ||

276 (
óæy_qrk
[
i
].
devi˚
 == device)) &&

277 (!((
óæy_qrk
[
i
].
˛ass
 ^ class) &

278 
óæy_qrk
[
i
].
˛ass_mask
))) {

279 i‡((
óæy_qrk
[
i
].
Êags
 &

280 
QFLAG_DONE
) != QFLAG_DONE)

281 
óæy_qrk
[
i
].
	`f
(
num
, 
¶Ÿ
, 
func
);

282 
óæy_qrk
[
i
].
Êags
 |
QFLAG_APPLIED
;

286 
ty≥
 = 
	`ªad_pci_c⁄fig_byã
(
num
, 
¶Ÿ
, 
func
,

287 
PCI_HEADER_TYPE
);

288 i‡(!(
ty≥
 & 0x80))

292 
	}
}

294 
__öô
 
	$óæy_quúks
()

296 
¶Ÿ
, 
func
;

298 i‡(!
	`óæy_pci_Ælowed
())

303 
¶Ÿ
 = 0; slot < 32; slot++)

304 
func
 = 0; func < 8; func++) {

306 i‡(
	`check_dev_quúk
(0, 
¶Ÿ
, 
func
))

309 
	}
}

	@/cmpt816/linux/arch/x86/kernel/early_printk.c

1 
	~<löux/c⁄sﬁe.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/°rög.h
>

5 
	~<löux/s¸ìn_öfo.h
>

6 
	~<löux/usb/ch9.h
>

7 
	~<löux/pci_ªgs.h
>

8 
	~<löux/pci_ids.h
>

9 
	~<löux/î∫o.h
>

10 
	~<asm/io.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/f˙é.h
>

13 
	~<asm/£tup.h
>

14 
	~<xí/hvc-c⁄sﬁe.h
>

15 
	~<asm/pci-dúe˘.h
>

16 
	~<asm/fixm≠.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<löux/usb/ehci_def.h
>

21 
	#VGABASE
 (
__ISA_IO_ba£
 + 0xb8000)

	)

23 
	gmax_ypos
 = 25, 
	gmax_xpos
 = 80;

24 
	gcuºít_ypos
 = 25, 
	gcuºít_xpos
;

26 
	$óæy_vga_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
°r
, 
n
)

28 
c
;

29 
i
, 
k
, 
j
;

31 (
c
 = *
°r
++Ë!'\0' && 
n
-- > 0) {

32 i‡(
cuºít_ypos
 >
max_ypos
) {

34 
k
 = 1, 
j
 = 0; k < 
max_ypos
; k++, j++) {

35 
i
 = 0; i < 
max_xpos
; i++) {

36 
	`wrôew
(
	`ªadw
(
VGABASE
+2*(
max_xpos
*
k
+
i
)),

37 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

40 
i
 = 0; i < 
max_xpos
; i++)

41 
	`wrôew
(0x720, 
VGABASE
 + 2*(
max_xpos
*
j
 + 
i
));

42 
cuºít_ypos
 = 
max_ypos
-1;

44 #ifde‡
CONFIG_KGDB_KDB


45 i‡(
c
 == '\b') {

46 i‡(
cuºít_xpos
 > 0)

47 
cuºít_xpos
--;

48 } i‡(
c
 == '\r') {

49 
cuºít_xpos
 = 0;

52 i‡(
c
 == '\n') {

53 
cuºít_xpos
 = 0;

54 
cuºít_ypos
++;

55 } i‡(
c
 != '\r') {

56 
	`wrôew
(((0x7 << 8Ë| (Ë
c
),

57 
VGABASE
 + 2*(
max_xpos
*
cuºít_ypos
 +

58 
cuºít_xpos
++));

59 i‡(
cuºít_xpos
 >
max_xpos
) {

60 
cuºít_xpos
 = 0;

61 
cuºít_ypos
++;

65 
	}
}

67 
c⁄sﬁe
 
	góæy_vga_c⁄sﬁe
 = {

68 .
«me
 = "earlyvga",

69 .
	gwrôe
 = 
óæy_vga_wrôe
,

70 .
	gÊags
 = 
CON_PRINTBUFFER
,

71 .
	gödex
 = -1,

76 
	góæy_£rül_ba£
 = 0x3f8;

78 
	#XMTRDY
 0x20

	)

80 
	#DLAB
 0x80

	)

82 
	#TXR
 0

	)

83 
	#RXR
 0

	)

84 
	#IER
 1

	)

85 
	#IIR
 2

	)

86 
	#FCR
 2

	)

87 
	#LCR
 3

	)

88 
	#MCR
 4

	)

89 
	#LSR
 5

	)

90 
	#MSR
 6

	)

91 
	#DLL
 0

	)

92 
	#DLH
 1

	)

94 
	$óæy_£rül_putc
(
ch
)

96 
timeout
 = 0xffff;

98 (
	`öb
(
óæy_£rül_ba£
 + 
LSR
Ë& 
XMTRDY
Ë=0 && --
timeout
)

99 
	`˝u_ªœx
();

100 
	`outb
(
ch
, 
óæy_£rül_ba£
 + 
TXR
);

101  
timeout
 ? 0 : -1;

102 
	}
}

104 
	$óæy_£rül_wrôe
(
c⁄sﬁe
 *
c⁄
, c⁄° *
s
, 
n
)

106 *
s
 && 
n
-- > 0) {

107 i‡(*
s
 == '\n')

108 
	`óæy_£rül_putc
('\r');

109 
	`óæy_£rül_putc
(*
s
);

110 
s
++;

112 
	}
}

114 
	#DEFAULT_BAUD
 9600

	)

116 
__öô
 
	$óæy_£rül_öô
(*
s
)

118 
c
;

119 
divis‹
;

120 
baud
 = 
DEFAULT_BAUD
;

121 *
e
;

123 i‡(*
s
 == ',')

124 ++
s
;

126 i‡(*
s
) {

127 
p‹t
;

128 i‡(!
	`°∫cmp
(
s
, "0x", 2)) {

129 
óæy_£rül_ba£
 = 
	`sim∂e_°πoul
(
s
, &
e
, 16);

131 c⁄° 
__öôc⁄°
 
ba£s
[] = { 0x3f8, 0x2f8 };

133 i‡(!
	`°∫cmp
(
s
, "ttyS", 4))

134 
s
 += 4;

135 
p‹t
 = 
	`sim∂e_°πoul
(
s
, &
e
, 10);

136 i‡(
p‹t
 > 1 || 
s
 =
e
)

137 
p‹t
 = 0;

138 
óæy_£rül_ba£
 = 
ba£s
[
p‹t
];

140 
s
 +
	`°rc•n
(s, ",");

141 i‡(*
s
 == ',')

142 
s
++;

145 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
LCR
);

146 
	`outb
(0, 
óæy_£rül_ba£
 + 
IER
);

147 
	`outb
(0, 
óæy_£rül_ba£
 + 
FCR
);

148 
	`outb
(0x3, 
óæy_£rül_ba£
 + 
MCR
);

150 i‡(*
s
) {

151 
baud
 = 
	`sim∂e_°πoul
(
s
, &
e
, 0);

152 i‡(
baud
 =0 || 
s
 =
e
)

153 
baud
 = 
DEFAULT_BAUD
;

156 
divis‹
 = 115200 / 
baud
;

157 
c
 = 
	`öb
(
óæy_£rül_ba£
 + 
LCR
);

158 
	`outb
(
c
 | 
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

159 
	`outb
(
divis‹
 & 0xff, 
óæy_£rül_ba£
 + 
DLL
);

160 
	`outb
((
divis‹
 >> 8Ë& 0xff, 
óæy_£rül_ba£
 + 
DLH
);

161 
	`outb
(
c
 & ~
DLAB
, 
óæy_£rül_ba£
 + 
LCR
);

162 
	}
}

164 
c⁄sﬁe
 
	góæy_£rül_c⁄sﬁe
 = {

165 .
«me
 = "earlyser",

166 .
	gwrôe
 = 
óæy_£rül_wrôe
,

167 .
	gÊags
 = 
CON_PRINTBUFFER
,

168 .
	gödex
 = -1,

172 
c⁄sﬁe
 *
	góæy_c⁄sﬁe
 = &
óæy_vga_c⁄sﬁe
;

173 
__öôd©a
 
	góæy_c⁄sﬁe_öôülized
;

175 
asmlökage
 
	$óæy_¥ötk
(c⁄° *
fmt
, ...)

177 
buf
[512];

178 
n
;

179 
va_li°
 
≠
;

181 
	`va_°¨t
(
≠
, 
fmt
);

182 
n
 = 
	`vs˙¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

183 
óæy_c⁄sﬁe
->
	`wrôe
”¨ly_c⁄sﬁe, 
buf
, 
n
);

184 
	`va_íd
(
≠
);

185 
	}
}

187 
ölöe
 
	$óæy_c⁄sﬁe_ªgi°î
(
c⁄sﬁe
 *
c⁄
, 
kìp_óæy
)

189 i‡(
óæy_c⁄sﬁe
->
ödex
 != -1) {

190 
	`¥ötk
(
KERN_CRIT
 "ERROR:Éarlyprintk= %sálready used\n",

191 
c⁄
->
«me
);

194 
óæy_c⁄sﬁe
 = 
c⁄
;

195 i‡(
kìp_óæy
)

196 
óæy_c⁄sﬁe
->
Êags
 &~
CON_BOOT
;

198 
óæy_c⁄sﬁe
->
Êags
 |
CON_BOOT
;

199 
	`ªgi°î_c⁄sﬁe
(
óæy_c⁄sﬁe
);

200 
	}
}

202 
__öô
 
	$£tup_óæy_¥ötk
(*
buf
)

204 
kìp
;

206 i‡(!
buf
)

209 i‡(
óæy_c⁄sﬁe_öôülized
)

211 
óæy_c⁄sﬁe_öôülized
 = 1;

213 
kìp
 = (
	`°r°r
(
buf
, "kìp"Ë!
NULL
);

215 *
buf
 != '\0') {

216 i‡(!
	`°∫cmp
(
buf
, "serial", 6)) {

217 
buf
 += 6;

218 
	`óæy_£rül_öô
(
buf
);

219 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

220 i‡(!
	`°∫cmp
(
buf
, ",ttyS", 5))

221 
buf
 += 5;

223 i‡(!
	`°∫cmp
(
buf
, "ttyS", 4)) {

224 
	`óæy_£rül_öô
(
buf
 + 4);

225 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_£rül_c⁄sﬁe
, 
kìp
);

227 i‡(!
	`°∫cmp
(
buf
, "vga", 3) &&

228 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_isVGA
 == 1) {

229 
max_xpos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_cﬁs
;

230 
max_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_video_löes
;

231 
cuºít_ypos
 = 
boŸ_∑øms
.
s¸ìn_öfo
.
‹ig_y
;

232 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_vga_c⁄sﬁe
, 
kìp
);

234 #ifde‡
CONFIG_EARLY_PRINTK_DBGP


235 i‡(!
	`°∫cmp
(
buf
, "dbgp", 4Ë&& !
	`óæy_dbgp_öô
(buf + 4))

236 
	`óæy_c⁄sﬁe_ªgi°î
(&
óæy_dbgp_c⁄sﬁe
, 
kìp
);

238 #ifde‡
CONFIG_HVC_XEN


239 i‡(!
	`°∫cmp
(
buf
, "xen", 3))

240 
	`óæy_c⁄sﬁe_ªgi°î
(&
xíboŸ_c⁄sﬁe
, 
kìp
);

242 
buf
++;

245 
	}
}

247 
óæy_∑øm
("óæy¥ötk", 
£tup_óæy_¥ötk
);

	@/cmpt816/linux/arch/x86/kernel/efi.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/efi.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/•ölock.h
>

34 
	~<löux/uac˚ss.h
>

35 
	~<löux/time.h
>

36 
	~<löux/io.h
>

37 
	~<löux/ªboŸ.h
>

38 
	~<löux/bcd.h
>

40 
	~<asm/£tup.h
>

41 
	~<asm/efi.h
>

42 
	~<asm/time.h
>

43 
	~<asm/ˇcheÊush.h
>

44 
	~<asm/ébÊush.h
>

45 
	~<asm/x86_öô.h
>

47 
	#EFI_DEBUG
 1

	)

48 
	#PFX
 "EFI: "

	)

50 
	gefi_íabÀd
;

51 
EXPORT_SYMBOL
(
efi_íabÀd
);

53 
efi
 
	gefi
;

54 
EXPORT_SYMBOL
(
efi
);

56 
efi_mem‹y_m≠
 
	gmemm≠
;

58 
efi
 
efi_phys
 
	g__öôd©a
;

59 
efi_sy°em_èbÀ_t
 
efi_sy°ab
 
	g__öôd©a
;

61 
__öô
 
	$£tup_n€fi
(*
¨g
)

63 
efi_íabÀd
 = 0;

65 
	}
}

66 
óæy_∑øm
("n€fi", 
£tup_n€fi
);

68 
	gadd_efi_memm≠
;

69 
EXPORT_SYMBOL
(
add_efi_memm≠
);

71 
__öô
 
	$£tup_add_efi_memm≠
(*
¨g
)

73 
add_efi_memm≠
 = 1;

75 
	}
}

76 
óæy_∑øm
("add_efi_memm≠", 
£tup_add_efi_memm≠
);

79 
efi_°©us_t
 
	$vút_efi_gë_time
(
efi_time_t
 *
tm
, 
efi_time_ˇp_t
 *
tc
)

81  
	`efi_ˇŒ_vút2
(
gë_time
, 
tm
, 
tc
);

82 
	}
}

84 
efi_°©us_t
 
	$vút_efi_£t_time
(
efi_time_t
 *
tm
)

86  
	`efi_ˇŒ_vút1
(
£t_time
, 
tm
);

87 
	}
}

89 
efi_°©us_t
 
	$vút_efi_gë_wakeup_time
(
efi_boﬁ_t
 *
íabÀd
,

90 
efi_boﬁ_t
 *
≥ndög
,

91 
efi_time_t
 *
tm
)

93  
	`efi_ˇŒ_vút3
(
gë_wakeup_time
,

94 
íabÀd
, 
≥ndög
, 
tm
);

95 
	}
}

97 
efi_°©us_t
 
	$vút_efi_£t_wakeup_time
(
efi_boﬁ_t
 
íabÀd
, 
efi_time_t
 *
tm
)

99  
	`efi_ˇŒ_vút2
(
£t_wakeup_time
,

100 
íabÀd
, 
tm
);

101 
	}
}

103 
efi_°©us_t
 
	$vút_efi_gë_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

104 
efi_guid_t
 *
víd‹
,

105 
u32
 *
©å
,

106 *
d©a_size
,

107 *
d©a
)

109  
	`efi_ˇŒ_vút5
(
gë_v¨übÀ
,

110 
«me
, 
víd‹
, 
©å
,

111 
d©a_size
, 
d©a
);

112 
	}
}

114 
efi_°©us_t
 
	$vút_efi_gë_√xt_v¨übÀ
(*
«me_size
,

115 
efi_ch¨16_t
 *
«me
,

116 
efi_guid_t
 *
víd‹
)

118  
	`efi_ˇŒ_vút3
(
gë_√xt_v¨übÀ
,

119 
«me_size
, 
«me
, 
víd‹
);

120 
	}
}

122 
efi_°©us_t
 
	$vút_efi_£t_v¨übÀ
(
efi_ch¨16_t
 *
«me
,

123 
efi_guid_t
 *
víd‹
,

124 
©å
,

125 
d©a_size
,

126 *
d©a
)

128  
	`efi_ˇŒ_vút5
(
£t_v¨übÀ
,

129 
«me
, 
víd‹
, 
©å
,

130 
d©a_size
, 
d©a
);

131 
	}
}

133 
efi_°©us_t
 
	$vút_efi_gë_√xt_high_m⁄o_cou¡
(
u32
 *
cou¡
)

135  
	`efi_ˇŒ_vút1
(
gë_√xt_high_m⁄o_cou¡
, 
cou¡
);

136 
	}
}

138 
	$vút_efi_ª£t_sy°em
(
ª£t_ty≥
,

139 
efi_°©us_t
 
°©us
,

140 
d©a_size
,

141 
efi_ch¨16_t
 *
d©a
)

143 
	`efi_ˇŒ_vút4
(
ª£t_sy°em
, 
ª£t_ty≥
, 
°©us
,

144 
d©a_size
, 
d©a
);

145 
	}
}

147 
efi_°©us_t
 
	$vút_efi_£t_vútuÆ_addªss_m≠
(

148 
mem‹y_m≠_size
,

149 
des¸ùt‹_size
,

150 
u32
 
des¸ùt‹_vîsi⁄
,

151 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

153  
	`efi_ˇŒ_vút4
(
£t_vútuÆ_addªss_m≠
,

154 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

155 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

156 
	}
}

158 
efi_°©us_t
 
__öô
 
	$phys_efi_£t_vútuÆ_addªss_m≠
(

159 
mem‹y_m≠_size
,

160 
des¸ùt‹_size
,

161 
u32
 
des¸ùt‹_vîsi⁄
,

162 
efi_mem‹y_desc_t
 *
vútuÆ_m≠
)

164 
efi_°©us_t
 
°©us
;

166 
	`efi_ˇŒ_phys_¥ñog
();

167 
°©us
 = 
	`efi_ˇŒ_phys4
(
efi_phys
.
£t_vútuÆ_addªss_m≠
,

168 
mem‹y_m≠_size
, 
des¸ùt‹_size
,

169 
des¸ùt‹_vîsi⁄
, 
vútuÆ_m≠
);

170 
	`efi_ˇŒ_phys_ïûog
();

171  
°©us
;

172 
	}
}

174 
efi_°©us_t
 
__öô
 
	$phys_efi_gë_time
(
efi_time_t
 *
tm
,

175 
efi_time_ˇp_t
 *
tc
)

177 
efi_°©us_t
 
°©us
;

179 
	`efi_ˇŒ_phys_¥ñog
();

180 
°©us
 = 
	`efi_ˇŒ_phys2
(
efi_phys
.
gë_time
, 
tm
, 
tc
);

181 
	`efi_ˇŒ_phys_ïûog
();

182  
°©us
;

183 
	}
}

185 
	$efi_£t_πc_mmss
(
nowtime
)

187 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
;

188 
efi_°©us_t
 
°©us
;

189 
efi_time_t
 
e·
;

190 
efi_time_ˇp_t
 
ˇp
;

192 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

193 i‡(
°©us
 !
EFI_SUCCESS
) {

194 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

198 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

199 
ªÆ_möuãs
 = 
nowtime
 / 60;

200 i‡(((
	`abs
(
ªÆ_möuãs
 - 
e·
.
möuã
) + 15)/30) & 1)

201 
ªÆ_möuãs
 += 30;

202 
ªÆ_möuãs
 %= 60;

203 
e·
.
möuã
 = 
ªÆ_möuãs
;

204 
e·
.
£c⁄d
 = 
ªÆ_£c⁄ds
;

206 
°©us
 = 
efi
.
	`£t_time
(&
e·
);

207 i‡(
°©us
 !
EFI_SUCCESS
) {

208 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can't writeÅime!\n");

212 
	}
}

214 
	$efi_gë_time
()

216 
efi_°©us_t
 
°©us
;

217 
efi_time_t
 
e·
;

218 
efi_time_ˇp_t
 
ˇp
;

220 
°©us
 = 
efi
.
	`gë_time
(&
e·
, &
ˇp
);

221 i‡(
°©us
 !
EFI_SUCCESS
)

222 
	`¥ötk
(
KERN_ERR
 "Oops:Éfitime: can'tÑeadÅime!\n");

224  
	`mktime
(
e·
.
yór
,É·.
m⁄th
,É·.
day
,É·.
hour
,

225 
e·
.
möuã
,É·.
£c⁄d
);

226 
	}
}

234 
__öô
 
	$do_add_efi_memm≠
()

236 *
p
;

238 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

239 
efi_mem‹y_desc_t
 *
md
 = 
p
;

240 
°¨t
 = 
md
->
phys_addr
;

241 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

242 
e820_ty≥
;

244 
md
->
ty≥
) {

245 
EFI_LOADER_CODE
:

246 
EFI_LOADER_DATA
:

247 
EFI_BOOT_SERVICES_CODE
:

248 
EFI_BOOT_SERVICES_DATA
:

249 
EFI_CONVENTIONAL_MEMORY
:

250 i‡(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)

251 
e820_ty≥
 = 
E820_RAM
;

253 
e820_ty≥
 = 
E820_RESERVED
;

255 
EFI_ACPI_RECLAIM_MEMORY
:

256 
e820_ty≥
 = 
E820_ACPI
;

258 
EFI_ACPI_MEMORY_NVS
:

259 
e820_ty≥
 = 
E820_NVS
;

261 
EFI_UNUSABLE_MEMORY
:

262 
e820_ty≥
 = 
E820_UNUSABLE
;

270 
e820_ty≥
 = 
E820_RESERVED
;

273 
	`e820_add_ªgi⁄
(
°¨t
, 
size
, 
e820_ty≥
);

275 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

276 
	}
}

278 
__öô
 
	$efi_ª£rve_óæy
()

280 
pm≠
;

282 #ifde‡
CONFIG_X86_32


283 
pm≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
;

285 
pm≠
 = (
boŸ_∑øms
.
efi_öfo
.
efi_memm≠
 |

286 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_hi
<<32));

288 
memm≠
.
phys_m≠
 = (*)
pm≠
;

289 
memm≠
.
ƒ_m≠
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memm≠_size
 /

290 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

291 
memm≠
.
desc_vîsi⁄
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_vîsi⁄
;

292 
memm≠
.
desc_size
 = 
boŸ_∑øms
.
efi_öfo
.
efi_memdesc_size
;

293 
	`ª£rve_óæy
(
pm≠
,Öm≠ + 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
,

295 
	}
}

297 #i‡
EFI_DEBUG


298 
__öô
 
	$¥öt_efi_memm≠
()

300 
efi_mem‹y_desc_t
 *
md
;

301 *
p
;

302 
i
;

304 
p
 = 
memm≠
.
m≠
, 
i
 = 0;

305 
p
 < 
memm≠
.
m≠_íd
;

306 
p
 +
memm≠
.
desc_size
, 
i
++) {

307 
md
 = 
p
;

308 
	`¥ötk
(
KERN_INFO
 
PFX
 "mem%02u:Åype=%u,áttr=0x%llx, "

310 
i
, 
md
->
ty≥
, md->
©åibuã
, md->
phys_addr
,

311 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
),

312 (
md
->
num_∑ges
 >> (20 - 
EFI_PAGE_SHIFT
)));

314 
	}
}

317 
__öô
 
	$efi_öô
()

319 
efi_c⁄fig_èbÀ_t
 *
c⁄fig_èbÀs
;

320 
efi_ru¡ime_£rvi˚s_t
 *
ru¡ime
;

321 
efi_ch¨16_t
 *
c16
;

322 
víd‹
[100] = "unknown";

323 
i
 = 0;

324 *
tmp
;

326 #ifde‡
CONFIG_X86_32


327 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
;

329 
efi_phys
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *)

330 (
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab
 |

331 ((
__u64
)
boŸ_∑øms
.
efi_öfo
.
efi_sy°ab_hi
<<32));

334 
efi
.
sy°ab
 = 
	`óæy_i‹em≠
(()
efi_phys
.systab,

335 (
efi_sy°em_èbÀ_t
));

336 i‡(
efi
.
sy°ab
 =
NULL
)

337 
	`¥ötk
(
KERN_ERR
 "Couldn't mapÅhe EFI systemÅable!\n");

338 
	`mem˝y
(&
efi_sy°ab
, 
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

339 
	`óæy_iounm≠
(
efi
.
sy°ab
, (
efi_sy°em_èbÀ_t
));

340 
efi
.
sy°ab
 = &
efi_sy°ab
;

345 i‡(
efi
.
sy°ab
->
hdr
.
sig«tuª
 !
EFI_SYSTEM_TABLE_SIGNATURE
)

346 
	`¥ötk
(
KERN_ERR
 "EFI systemÅable signature incorrect!\n");

347 i‡((
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16) == 0)

348 
	`¥ötk
(
KERN_ERR
 "Warning: EFI systemÅable version "

350 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

351 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff);

356 
c16
 = 
tmp
 = 
	`óæy_i‹em≠
(
efi
.
sy°ab
->
fw_víd‹
, 2);

357 i‡(
c16
) {

358 
i
 = 0; i < (
víd‹
Ë- 1 && *
c16
; ++i)

359 
víd‹
[
i
] = *
c16
++;

360 
víd‹
[
i
] = '\0';

362 
	`¥ötk
(
KERN_ERR
 
PFX
 "CouldÇot mapÅhe firmware vendor!\n");

363 
	`óæy_iounm≠
(
tmp
, 2);

365 
	`¥ötk
(
KERN_INFO
 "EFI v%u.%.02u by %s\n",

366 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 >> 16,

367 
efi
.
sy°ab
->
hdr
.
ªvisi⁄
 & 0xffff, 
víd‹
);

372 
c⁄fig_èbÀs
 = 
	`óæy_i‹em≠
(

373 
efi
.
sy°ab
->
èbÀs
,

374 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

375 i‡(
c⁄fig_èbÀs
 =
NULL
)

376 
	`¥ötk
(
KERN_ERR
 "CouldÇot map EFI Configuration Table!\n");

378 
	`¥ötk
(
KERN_INFO
);

379 
i
 = 0; i < 
efi
.
sy°ab
->
ƒ_èbÀs
; i++) {

380 i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
, 
MPS_TABLE_GUID
)) {

381 
efi
.
mps
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

382 
	`¥ötk
(" MPS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

383 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

384 
ACPI_20_TABLE_GUID
)) {

385 
efi
.
a˝i20
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

386 
	`¥ötk
(" ACPI 2.0=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

387 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

388 
ACPI_TABLE_GUID
)) {

389 
efi
.
a˝i
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

390 
	`¥ötk
(" ACPI=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

391 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

392 
SMBIOS_TABLE_GUID
)) {

393 
efi
.
smbios
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

394 
	`¥ötk
(" SMBIOS=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

395 #ifde‡
CONFIG_X86_UV


396 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

397 
UV_SYSTEM_TABLE_GUID
)) {

398 
efi
.
uv_sy°ab
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

399 
	`¥ötk
(" UVsy°ab=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

401 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

402 
HCDP_TABLE_GUID
)) {

403 
efi
.
hcdp
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

404 
	`¥ötk
(" HCDP=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

405 } i‡(!
	`efi_guidcmp
(
c⁄fig_èbÀs
[
i
].
guid
,

406 
UGA_IO_PROTOCOL_GUID
)) {

407 
efi
.
uga
 = 
c⁄fig_èbÀs
[
i
].
èbÀ
;

408 
	`¥ötk
(" UGA=0x%lx ", 
c⁄fig_èbÀs
[
i
].
èbÀ
);

411 
	`¥ötk
("\n");

412 
	`óæy_iounm≠
(
c⁄fig_èbÀs
,

413 
efi
.
sy°ab
->
ƒ_èbÀs
 * (
efi_c⁄fig_èbÀ_t
));

421 
ru¡ime
 = 
	`óæy_i‹em≠
(()
efi
.
sy°ab
->runtime,

422 (
efi_ru¡ime_£rvi˚s_t
));

423 i‡(
ru¡ime
 !
NULL
) {

429 
efi_phys
.
gë_time
 = (
efi_gë_time_t
 *)
ru¡ime
->get_time;

430 
efi_phys
.
£t_vútuÆ_addªss_m≠
 =

431 (
efi_£t_vútuÆ_addªss_m≠_t
 *)

432 
ru¡ime
->
£t_vútuÆ_addªss_m≠
;

437 
efi
.
gë_time
 = 
phys_efi_gë_time
;

439 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFIÑuntime service "

441 
	`óæy_iounm≠
(
ru¡ime
, (
efi_ru¡ime_£rvi˚s_t
));

444 
memm≠
.
m≠
 = 
	`óæy_i‹em≠
(()memm≠.
phys_m≠
,

445 
memm≠
.
ƒ_m≠
 * memm≠.
desc_size
);

446 i‡(
memm≠
.
m≠
 =
NULL
)

447 
	`¥ötk
(
KERN_ERR
 "CouldÇot mapÅhe EFI memory map!\n");

448 
memm≠
.
m≠_íd
 = memm≠.
m≠
 + (memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

450 i‡(
memm≠
.
desc_size
 !(
efi_mem‹y_desc_t
))

451 
	`¥ötk
(
KERN_WARNING


454 i‡(
add_efi_memm≠
)

455 
	`do_add_efi_memm≠
();

457 #ifde‡
CONFIG_X86_32


458 
x86_∂©f‹m
.
gë_wÆl˛ock
 = 
efi_gë_time
;

459 
x86_∂©f‹m
.
£t_wÆl˛ock
 = 
efi_£t_πc_mmss
;

463 
ªboŸ_ty≥
 = 
BOOT_EFI
;

465 #i‡
EFI_DEBUG


466 
	`¥öt_efi_memm≠
();

468 
	}
}

470 
__öô
 
	$ru¡ime_code_∑ge_mkexec
()

472 
efi_mem‹y_desc_t
 *
md
;

473 *
p
;

474 
u64
 
addr
, 
≈ages
;

477 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

478 
md
 = 
p
;

480 i‡(
md
->
ty≥
 !
EFI_RUNTIME_SERVICES_CODE
)

483 
addr
 = 
md
->
vút_addr
;

484 
≈ages
 = 
md
->
num_∑ges
;

485 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

486 
	`£t_mem‹y_x
(
addr
, 
≈ages
);

488 
	}
}

498 
__öô
 
	$efi_íãr_vútuÆ_mode
()

500 
efi_mem‹y_desc_t
 *
md
;

501 
efi_°©us_t
 
°©us
;

502 
size
;

503 
u64
 
íd
, 
sy°ab
, 
addr
, 
≈ages
, 
íd_p‚
;

504 *
p
, *
va
;

506 
efi
.
sy°ab
 = 
NULL
;

507 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

508 
md
 = 
p
;

509 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_RUNTIME
))

512 
size
 = 
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
;

513 
íd
 = 
md
->
phys_addr
 + 
size
;

515 
íd_p‚
 = 
	`PFN_UP
(
íd
);

516 i‡(
íd_p‚
 <
max_low_p‚_m≠≥d


517 || (
íd_p‚
 > (1UL << (32 - 
PAGE_SHIFT
))

518 && 
íd_p‚
 <
max_p‚_m≠≥d
))

519 
va
 = 
	`__va
(
md
->
phys_addr
);

521 
va
 = 
	`efi_i‹em≠
(
md
->
phys_addr
, 
size
, md->
ty≥
);

523 
md
->
vút_addr
 = (
u64
Ë(Ë
va
;

525 i‡(!
va
) {

526 
	`¥ötk
(
KERN_ERR
 
PFX
 "ioremap of 0x%llX failed!\n",

527 ()
md
->
phys_addr
);

531 i‡(!(
md
->
©åibuã
 & 
EFI_MEMORY_WB
)) {

532 
addr
 = 
md
->
vút_addr
;

533 
≈ages
 = 
md
->
num_∑ges
;

534 
	`memønge_efi_to_«tive
(&
addr
, &
≈ages
);

535 
	`£t_mem‹y_uc
(
addr
, 
≈ages
);

538 
sy°ab
 = (
u64
Ë(Ë
efi_phys
.systab;

539 i‡(
md
->
phys_addr
 <
sy°ab
 && sy°ab < 
íd
) {

540 
sy°ab
 +
md
->
vút_addr
 - md->
phys_addr
;

541 
efi
.
sy°ab
 = (
efi_sy°em_èbÀ_t
 *) () systab;

545 
	`BUG_ON
(!
efi
.
sy°ab
);

547 
°©us
 = 
	`phys_efi_£t_vútuÆ_addªss_m≠
(

548 
memm≠
.
desc_size
 * memm≠.
ƒ_m≠
,

549 
memm≠
.
desc_size
,

550 
memm≠
.
desc_vîsi⁄
,

551 
memm≠
.
phys_m≠
);

553 i‡(
°©us
 !
EFI_SUCCESS
) {

554 
	`¥ötk
(
KERN_ALERT
 "UnableÅo switch EFI into virtual mode "

555 "(°©us=%lx)!\n", 
°©us
);

556 
	`∑nic
("EFI callÅo SetVirtualAddressMap() failed!");

565 
efi
.
gë_time
 = 
vút_efi_gë_time
;

566 
efi
.
£t_time
 = 
vút_efi_£t_time
;

567 
efi
.
gë_wakeup_time
 = 
vút_efi_gë_wakeup_time
;

568 
efi
.
£t_wakeup_time
 = 
vút_efi_£t_wakeup_time
;

569 
efi
.
gë_v¨übÀ
 = 
vút_efi_gë_v¨übÀ
;

570 
efi
.
gë_√xt_v¨übÀ
 = 
vút_efi_gë_√xt_v¨übÀ
;

571 
efi
.
£t_v¨übÀ
 = 
vút_efi_£t_v¨übÀ
;

572 
efi
.
gë_√xt_high_m⁄o_cou¡
 = 
vút_efi_gë_√xt_high_m⁄o_cou¡
;

573 
efi
.
ª£t_sy°em
 = 
vút_efi_ª£t_sy°em
;

574 
efi
.
£t_vútuÆ_addªss_m≠
 = 
vút_efi_£t_vútuÆ_addªss_m≠
;

575 i‡(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
)

576 
	`ru¡ime_code_∑ge_mkexec
();

577 
	`óæy_iounm≠
(
memm≠
.
m≠
, memm≠.
ƒ_m≠
 * memm≠.
desc_size
);

578 
memm≠
.
m≠
 = 
NULL
;

579 
	}
}

584 
u32
 
	$efi_mem_ty≥
(
phys_addr
)

586 
efi_mem‹y_desc_t
 *
md
;

587 *
p
;

589 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

590 
md
 = 
p
;

591 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

592 (
phys_addr
 < (
md
->phys_addr +

593 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

594  
md
->
ty≥
;

597 
	}
}

599 
u64
 
	$efi_mem_©åibuãs
(
phys_addr
)

601 
efi_mem‹y_desc_t
 *
md
;

602 *
p
;

604 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

605 
md
 = 
p
;

606 i‡((
md
->
phys_addr
 <=Öhys_addr) &&

607 (
phys_addr
 < (
md
->phys_addr +

608 (
md
->
num_∑ges
 << 
EFI_PAGE_SHIFT
))))

609  
md
->
©åibuã
;

612 
	}
}

	@/cmpt816/linux/arch/x86/kernel/efi_64.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/efi.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/ªboŸ.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/e820.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/efi.h
>

38 
	~<asm/ˇcheÊush.h
>

39 
	~<asm/fixm≠.h
>

41 
pgd_t
 
ßve_pgd
 
	g__öôd©a
;

42 
efi_Êags
 
	g__öôd©a
;

44 
__öô
 
	$óæy_m≠pög_£t_exec
(
°¨t
,

45 
íd
,

46 
execuèbÀ
)

48 
num_∑ges
;

50 
°¨t
 &
PMD_MASK
;

51 
íd
 = (íd + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

52 
num_∑ges
 = (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

53 i‡(
execuèbÀ
)

54 
	`£t_mem‹y_x
(()
	`__va
(
°¨t
), 
num_∑ges
);

56 
	`£t_mem‹y_nx
(()
	`__va
(
°¨t
), 
num_∑ges
);

57 
	}
}

59 
__öô
 
	$óæy_ru¡ime_code_m≠pög_£t_exec
(
execuèbÀ
)

61 
efi_mem‹y_desc_t
 *
md
;

62 *
p
;

64 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

68 
p
 = 
memm≠
.
m≠
;Ö < memm≠.
m≠_íd
;Ö +memm≠.
desc_size
) {

69 
md
 = 
p
;

70 i‡(
md
->
ty≥
 =
EFI_RUNTIME_SERVICES_CODE
) {

71 
íd
;

72 
íd
 = 
md
->
phys_addr
 + (md->
num_∑ges
 << 
EFI_PAGE_SHIFT
);

73 
	`óæy_m≠pög_£t_exec
(
md
->
phys_addr
, 
íd
, 
execuèbÀ
);

76 
	}
}

78 
__öô
 
	$efi_ˇŒ_phys_¥ñog
()

80 
vaddªss
;

82 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(1);

83 
	`loˇl_úq_ßve
(
efi_Êags
);

84 
vaddªss
 = ()
	`__va
(0x0UL);

85 
ßve_pgd
 = *
	`pgd_off£t_k
(0x0UL);

86 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), *pgd_off£t_k(
vaddªss
));

87 
	`__Êush_éb_Æl
();

88 
	}
}

90 
__öô
 
	$efi_ˇŒ_phys_ïûog
()

95 
	`£t_pgd
(
	`pgd_off£t_k
(0x0UL), 
ßve_pgd
);

96 
	`__Êush_éb_Æl
();

97 
	`loˇl_úq_ª°‹e
(
efi_Êags
);

98 
	`óæy_ru¡ime_code_m≠pög_£t_exec
(0);

99 
	}
}

101 
__iomem
 *
__öô
 
	$efi_i‹em≠
(
phys_addr
, 
size
,

102 
u32
 
ty≥
)

104 
œ°_m≠_p‚
;

106 i‡(
ty≥
 =
EFI_MEMORY_MAPPED_IO
)

107  
	`i‹em≠
(
phys_addr
, 
size
);

109 
œ°_m≠_p‚
 = 
	`öô_mem‹y_m≠pög
(
phys_addr
,Öhys_add∏+ 
size
);

110 i‡((
œ°_m≠_p‚
 << 
PAGE_SHIFT
Ë< 
phys_addr
 + 
size
)

111  
NULL
;

113  (
__iomem
 *)
	`__va
(
phys_addr
);

114 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/öô.h
>

4 
	~<asm/£tup.h
>

5 
	~<asm/bios_ebda.h
>

7 
	#BIOS_LOWMEM_KILOBYTES
 0x413

	)

19 
__öô
 
	$ª£rve_ebda_ªgi⁄
()

21 
lowmem
, 
ebda_addr
;

29 i‡(
	`∑øvút_íabÀd
())

33 
lowmem
 = *(*)
	`__va
(
BIOS_LOWMEM_KILOBYTES
);

34 
lowmem
 <<= 10;

37 
ebda_addr
 = 
	`gë_bios_ebda
();

41 i‡((
lowmem
 - 
ebda_addr
) <= 0x10000)

42 
lowmem
 = 
ebda_addr
;

46 i‡((
ebda_addr
 =0Ë&& (
lowmem
 >= 0x9f000))

47 
lowmem
 = 0x9f000;

50 i‡((
lowmem
 == 0) || (lowmem >= 0x100000))

51 
lowmem
 = 0x9f000;

54 
	`ª£rve_óæy_ovîœp_ok
(
lowmem
, 0x100000, "BIOSÑeserved");

55 
	}
}

	@/cmpt816/linux/arch/x86/kernel/head64.c

7 
	~<löux/öô.h
>

8 
	~<löux/lökage.h
>

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/≥r˝u.h
>

13 
	~<löux/°¨t_kî√l.h
>

14 
	~<löux/io.h
>

16 
	~<asm/¥o˚ss‹.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/£tup.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/£˘i⁄s.h
>

24 
	~<asm/kdebug.h
>

25 
	~<asm/e820.h
>

26 
	~<asm/åampﬁöe.h
>

27 
	~<asm/bios_ebda.h
>

29 
__öô
 
	$z≠_idítôy_m≠pögs
()

31 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(0UL);

32 
	`pgd_˛ór
(
pgd
);

33 
	`__Êush_éb_Æl
();

34 
	}
}

38 
__öô
 
	$˛ór_bss
()

40 
	`mem£t
(
__bss_°¨t
, 0,

41 (Ë
__bss_°›
 - (Ë
__bss_°¨t
);

42 
	}
}

44 
__öô
 
	$c›y_boŸd©a
(*
ªÆ_mode_d©a
)

46 * 
comm™d_löe
;

48 
	`mem˝y
(&
boŸ_∑øms
, 
ªÆ_mode_d©a
,  boot_params);

49 i‡(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
) {

50 
comm™d_löe
 = 
	`__va
(
boŸ_∑øms
.
hdr
.
cmd_löe_±r
);

51 
	`mem˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
, 
COMMAND_LINE_SIZE
);

53 
	}
}

55 
__öô
 
	$x86_64_°¨t_kî√l
(* 
ªÆ_mode_d©a
)

57 
i
;

63 
	`BUILD_BUG_ON
(
MODULES_VADDR
 < 
KERNEL_IMAGE_START
);

64 
	`BUILD_BUG_ON
(
MODULES_VADDR
-
KERNEL_IMAGE_START
 < 
KERNEL_IMAGE_SIZE
);

65 
	`BUILD_BUG_ON
(
MODULES_LEN
 + 
KERNEL_IMAGE_SIZE
 > 2*
PUD_SIZE
);

66 
	`BUILD_BUG_ON
((
KERNEL_IMAGE_START
 & ~
PMD_MASK
) != 0);

67 
	`BUILD_BUG_ON
((
MODULES_VADDR
 & ~
PMD_MASK
) != 0);

68 
	`BUILD_BUG_ON
(!(
MODULES_VADDR
 > 
__START_KERNEL
));

69 
	`BUILD_BUG_ON
(!(((
MODULES_END
 - 1Ë& 
PGDIR_MASK
) ==

70 (
__START_KERNEL
 & 
PGDIR_MASK
)));

71 
	`BUILD_BUG_ON
(
	`__fix_to_vút
(
__íd_of_fixed_addªs£s
Ë<
MODULES_END
);

74 
	`˛ór_bss
();

77 
	`z≠_idítôy_m≠pögs
();

80 
	`˛ónup_highm≠
();

82 
i
 = 0; i < 
NUM_EXCEPTION_VECTORS
; i++) {

83 #ifde‡
CONFIG_EARLY_PRINTK


84 
	`£t_öå_g©e
(
i
, &
óæy_idt_h™dÀrs
[i]);

86 
	`£t_öå_g©e
(
i
, 
óæy_idt_h™dÀr
);

89 
	`lﬂd_idt
((c⁄° 
desc_±r
 *)&
idt_des¸
);

91 i‡(
c⁄sﬁe_logÀvñ
 == 10)

92 
	`óæy_¥ötk
("Kernelálive\n");

94 
	`x86_64_°¨t_ª£rv©i⁄s
(
ªÆ_mode_d©a
);

95 
	}
}

97 
__öô
 
	$x86_64_°¨t_ª£rv©i⁄s
(*
ªÆ_mode_d©a
)

99 
	`c›y_boŸd©a
(
	`__va
(
ªÆ_mode_d©a
));

101 
	`ª£rve_óæy
(
	`__∑_symbﬁ
(&
_ãxt
), __∑_symbﬁ(&
__bss_°›
), "TEXT DATA BSS");

103 #ifde‡
CONFIG_BLK_DEV_INITRD


105 i‡(
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 && boŸ_∑øms.hdr.
ømdisk_image
) {

107 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

108 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

109 
ømdisk_íd
 = 
	`PAGE_ALIGN
(
ømdisk_image
 + 
ømdisk_size
);

110 
	`ª£rve_óæy
(
ømdisk_image
, 
ømdisk_íd
, "RAMDISK");

114 
	`ª£rve_ebda_ªgi⁄
();

122 
	`°¨t_kî√l
();

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/hpet.c

1 
	~<löux/˛ocksour˚.h
>

2 
	~<löux/˛ockchùs.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/sysdev.h
>

5 
	~<löux/dñay.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/h≥t.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/˝u.h
>

11 
	~<löux/pm.h
>

12 
	~<löux/io.h
>

14 
	~<asm/fixm≠.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

18 
	#HPET_MASK
 
	`CLOCKSOURCE_MASK
(32)

	)

19 
	#HPET_SHIFT
 22

	)

23 
	#FSEC_PER_NSEC
 1000000L

	)

25 
	#HPET_DEV_USED_BIT
 2

	)

26 
	#HPET_DEV_USED
 (1 << 
HPET_DEV_USED_BIT
)

	)

27 
	#HPET_DEV_VALID
 0x8

	)

28 
	#HPET_DEV_FSB_CAP
 0x1000

	)

29 
	#HPET_DEV_PERI_CAP
 0x2000

	)

31 
	#EVT_TO_HPET_DEV
(
evt
Ë
	`c⁄èöî_of
”vt, 
h≥t_dev
,Évt)

	)

36 
	gh≥t_addªss
;

37 
u8
 
	gh≥t_blockid
;

38 
u8
 
	gh≥t_msi_dißbÀ
;

39 
u8
 
	gh≥t_ªadback_cmp
;

41 #ifde‡
CONFIG_PCI_MSI


42 
	gh≥t_num_timîs
;

44 
__iomem
 *
	gh≥t_vút_addªss
;

46 
	sh≥t_dev
 {

47 
˛ock_evít_devi˚
 
	mevt
;

48 
	mnum
;

49 
	m˝u
;

50 
	múq
;

51 
	mÊags
;

52 
	m«me
[10];

55 
ölöe
 
	$h≥t_ªadl
(
a
)

57  
	`ªadl
(
h≥t_vút_addªss
 + 
a
);

58 
	}
}

60 
ölöe
 
	$h≥t_wrôñ
(
d
, 
a
)

62 
	`wrôñ
(
d
, 
h≥t_vút_addªss
 + 
a
);

63 
	}
}

65 #ifde‡
CONFIG_X86_64


66 
	~<asm/pgèbÀ.h
>

69 
ölöe
 
	$h≥t_£t_m≠pög
()

71 
h≥t_vút_addªss
 = 
	`i‹em≠_noˇche
(
h≥t_addªss
, 
HPET_MMAP_SIZE
);

72 #ifde‡
CONFIG_X86_64


73 
	`__£t_fixm≠
(
VSYSCALL_HPET
, 
h≥t_addªss
, 
PAGE_KERNEL_VSYSCALL_NOCACHE
);

75 
	}
}

77 
ölöe
 
	$h≥t_˛ór_m≠pög
()

79 
	`iounm≠
(
h≥t_vút_addªss
);

80 
h≥t_vút_addªss
 = 
NULL
;

81 
	}
}

86 
	gboŸ_h≥t_dißbÀ
;

87 
	gh≥t_f‹˚_u£r
;

88 
	gh≥t_vîbo£
;

90 
__öô
 
	$h≥t_£tup
(*
°r
)

92 i‡(
°r
) {

93 i‡(!
	`°∫cmp
("dißbÀ", 
°r
, 7))

94 
boŸ_h≥t_dißbÀ
 = 1;

95 i‡(!
	`°∫cmp
("f‹˚", 
°r
, 5))

96 
h≥t_f‹˚_u£r
 = 1;

97 i‡(!
	`°∫cmp
("vîbo£", 
°r
, 7))

98 
h≥t_vîbo£
 = 1;

101 
	}
}

102 
__£tup
("h≥t=", 
h≥t_£tup
);

104 
__öô
 
	$dißbÀ_h≥t
(*
°r
)

106 
boŸ_h≥t_dißbÀ
 = 1;

108 
	}
}

109 
__£tup
("noh≥t", 
dißbÀ_h≥t
);

111 
ölöe
 
	$is_h≥t_ˇ∑bÀ
()

113  !
boŸ_h≥t_dißbÀ
 && 
h≥t_addªss
;

114 
	}
}

119 
	gh≥t_Àgacy_öt_íabÀd
;

124 
	$is_h≥t_íabÀd
()

126  
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_Àgacy_öt_íabÀd
;

127 
	}
}

128 
EXPORT_SYMBOL_GPL
(
is_h≥t_íabÀd
);

130 
	$_h≥t_¥öt_c⁄fig
(c⁄° *
fun˘i⁄
, 
löe
)

132 
u32
 
i
, 
timîs
, 
l
, 
h
;

133 
	`¥ötk
(
KERN_INFO
 "h≥t: %s(%d):\n", 
fun˘i⁄
, 
löe
);

134 
l
 = 
	`h≥t_ªadl
(
HPET_ID
);

135 
h
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

136 
timîs
 = ((
l
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

137 
	`¥ötk
(
KERN_INFO
 "h≥t: ID: 0x%x, PERIOD: 0x%x\n", 
l
, 
h
);

138 
l
 = 
	`h≥t_ªadl
(
HPET_CFG
);

139 
h
 = 
	`h≥t_ªadl
(
HPET_STATUS
);

140 
	`¥ötk
(
KERN_INFO
 "h≥t: CFG: 0x%x, STATUS: 0x%x\n", 
l
, 
h
);

141 
l
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

142 
h
 = 
	`h≥t_ªadl
(
HPET_COUNTER
+4);

143 
	`¥ötk
(
KERN_INFO
 "h≥t: COUNTER_l: 0x%x, COUNTER_h: 0x%x\n", 
l
, 
h
);

145 
i
 = 0; i < 
timîs
; i++) {

146 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

147 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
)+4);

148 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x\n",

149 
i
, 
l
, 
h
);

150 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
));

151 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
i
)+4);

152 
	`¥ötk
(
KERN_INFO
 "hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x\n",

153 
i
, 
l
, 
h
);

154 
l
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
));

155 
h
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
i
)+4);

156 
	`¥ötk
(
KERN_INFO
 "hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x\n",

157 
i
, 
l
, 
h
);

159 
	}
}

161 
	#h≥t_¥öt_c⁄fig
() \

163 i‡(
h≥t_vîbo£
) \

164 
	`_h≥t_¥öt_c⁄fig
(
__FUNCTION__
, 
__LINE__
); \

165 } 0)

	)

171 #ifde‡
CONFIG_HPET


173 
h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
);

175 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
)

177 
h≥t
 
__iomem
 *h≥à
h≥t_vút_addªss
;

178 
h≥t_timî
 
__iomem
 *
timî
 = &
h≥t
->
h≥t_timîs
[2];

179 
ƒtimîs
, 
i
;

180 
h≥t_d©a
 
hd
;

182 
ƒtimîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
) + 1;

184 
	`mem£t
(&
hd
, 0, (hd));

185 
hd
.
hd_phys_addªss
 = 
h≥t_addªss
;

186 
hd
.
hd_addªss
 = 
h≥t
;

187 
hd
.
hd_núqs
 = 
ƒtimîs
;

188 
	`h≥t_ª£rve_timî
(&
hd
, 0);

190 #ifde‡
CONFIG_HPET_EMULATE_RTC


191 
	`h≥t_ª£rve_timî
(&
hd
, 1);

199 
hd
.
hd_úq
[0] = 
HPET_LEGACY_8254
;

200 
hd
.
hd_úq
[1] = 
HPET_LEGACY_RTC
;

202 
i
 = 2; i < 
ƒtimîs
; 
timî
++, i++) {

203 
hd
.
hd_úq
[
i
] = (
	`ªadl
(&
timî
->
h≥t_c⁄fig
) &

204 
Tn_INT_ROUTE_CNF_MASK
Ë>> 
Tn_INT_ROUTE_CNF_SHIFT
;

207 
	`h≥t_ª£rve_msi_timîs
(&
hd
);

209 
	`h≥t_Æloc
(&
hd
);

211 
	}
}

213 
	$h≥t_ª£rve_∂©f‹m_timîs
(
id
Ë{ 
	}
}

219 
	gh≥t_≥riod
;

221 
h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

222 
˛ock_evít_devi˚
 *
evt
);

223 
h≥t_Àgacy_√xt_evít
(
dñè
,

224 
˛ock_evít_devi˚
 *
evt
);

229 
˛ock_evít_devi˚
 
	gh≥t_˛ockevít
 = {

230 .
«me
 = "hpet",

231 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

232 .
	g£t_mode
 = 
h≥t_Àgacy_£t_mode
,

233 .
	g£t_√xt_evít
 = 
h≥t_Àgacy_√xt_evít
,

234 .
	gshi·
 = 32,

235 .
	gúq
 = 0,

236 .
	gøtög
 = 50,

239 
	$h≥t_°›_cou¡î
()

241 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

242 
cfg
 &~
HPET_CFG_ENABLE
;

243 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

244 
	}
}

246 
	$h≥t_ª£t_cou¡î
()

248 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
);

249 
	`h≥t_wrôñ
(0, 
HPET_COUNTER
 + 4);

250 
	}
}

252 
	$h≥t_°¨t_cou¡î
()

254 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

255 
cfg
 |
HPET_CFG_ENABLE
;

256 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

257 
	}
}

259 
	$h≥t_ª°¨t_cou¡î
()

261 
	`h≥t_°›_cou¡î
();

262 
	`h≥t_ª£t_cou¡î
();

263 
	`h≥t_°¨t_cou¡î
();

264 
	}
}

266 
	$h≥t_ªsume_devi˚
()

268 
	`f‹˚_h≥t_ªsume
();

269 
	}
}

271 
	$h≥t_ªsume_cou¡î
(
˛ocksour˚
 *
cs
)

273 
	`h≥t_ªsume_devi˚
();

274 
	`h≥t_ª°¨t_cou¡î
();

275 
	}
}

277 
	$h≥t_íabÀ_Àgacy_öt
()

279 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

281 
cfg
 |
HPET_CFG_LEGACY
;

282 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

283 
h≥t_Àgacy_öt_íabÀd
 = 1;

284 
	}
}

286 
	$h≥t_Àgacy_˛ockevít_ªgi°î
()

289 
	`h≥t_íabÀ_Àgacy_öt
();

299 
h≥t_˛ockevít
.
mu…
 = 
	`div_sc
((Ë
FSEC_PER_NSEC
,

300 
h≥t_≥riod
, 
h≥t_˛ockevít
.
shi·
);

302 
h≥t_˛ockevít
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,

303 &
h≥t_˛ockevít
);

305 
h≥t_˛ockevít
.
mö_dñè_ns
 = 5000;

311 
h≥t_˛ockevít
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

312 
	`˛ockevíts_ªgi°î_devi˚
(&
h≥t_˛ockevít
);

313 
globÆ_˛ock_evít
 = &
h≥t_˛ockevít
;

314 
	`¥ötk
(
KERN_DEBUG
 "hpet clockeventÑegistered\n");

315 
	}
}

317 
h≥t_£tup_msi_úq
(
úq
);

319 
	$h≥t_£t_mode
(
˛ock_evít_mode
 
mode
,

320 
˛ock_evít_devi˚
 *
evt
, 
timî
)

322 
cfg
, 
cmp
, 
now
;

323 
uöt64_t
 
dñè
;

325 
mode
) {

326 
CLOCK_EVT_MODE_PERIODIC
:

327 
	`h≥t_°›_cou¡î
();

328 
dñè
 = ((
uöt64_t
)(
NSEC_PER_SEC
/
HZ
)Ë* 
evt
->
mu…
;

329 
dñè
 >>
evt
->
shi·
;

330 
now
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

331 
cmp
 = 
now
 + (Ë
dñè
;

332 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

334 
cfg
 &~
HPET_TN_LEVEL
;

335 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_PERIODIC
 |

336 
HPET_TN_SETVAL
 | 
HPET_TN_32BIT
;

337 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

338 
	`h≥t_wrôñ
(
cmp
, 
	`HPET_Tn_CMP
(
timî
));

339 
	`udñay
(1);

347 
	`h≥t_wrôñ
((Ë
dñè
, 
	`HPET_Tn_CMP
(
timî
));

348 
	`h≥t_°¨t_cou¡î
();

349 
	`h≥t_¥öt_c⁄fig
();

352 
CLOCK_EVT_MODE_ONESHOT
:

353 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

354 
cfg
 &~
HPET_TN_PERIODIC
;

355 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

356 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

359 
CLOCK_EVT_MODE_UNUSED
:

360 
CLOCK_EVT_MODE_SHUTDOWN
:

361 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
timî
));

362 
cfg
 &~
HPET_TN_ENABLE
;

363 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
timî
));

366 
CLOCK_EVT_MODE_RESUME
:

367 i‡(
timî
 == 0) {

368 
	`h≥t_íabÀ_Àgacy_öt
();

370 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

371 
	`h≥t_£tup_msi_úq
(
hdev
->
úq
);

372 
	`dißbÀ_úq
(
hdev
->
úq
);

373 
	`úq_£t_afföôy
(
hdev
->
úq
, 
	`˝umask_of
(hdev->
˝u
));

374 
	`íabÀ_úq
(
hdev
->
úq
);

376 
	`h≥t_¥öt_c⁄fig
();

379 
	}
}

381 
	$h≥t_√xt_evít
(
dñè
,

382 
˛ock_evít_devi˚
 *
evt
, 
timî
)

384 
u32
 
˙t
;

386 
˙t
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

387 
˙t
 +(
u32
Ë
dñè
;

388 
	`h≥t_wrôñ
(
˙t
, 
	`HPET_Tn_CMP
(
timî
));

410 i‡(
h≥t_ªadback_cmp
 || 
h≥t_vîbo£
) {

411 
u32
 
cmp
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CMP
(
timî
));

413 i‡(
cmp
 !
˙t
)

414 
	`¥ötk_⁄˚
(
KERN_WARNING


418  (
s32
)(
	`h≥t_ªadl
(
HPET_COUNTER
Ë- 
˙t
Ë>0 ? -
ETIME
 : 0;

419 
	}
}

421 
	$h≥t_Àgacy_£t_mode
(
˛ock_evít_mode
 
mode
,

422 
˛ock_evít_devi˚
 *
evt
)

424 
	`h≥t_£t_mode
(
mode
, 
evt
, 0);

425 
	}
}

427 
	$h≥t_Àgacy_√xt_evít
(
dñè
,

428 
˛ock_evít_devi˚
 *
evt
)

430  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 0);

431 
	}
}

436 #ifde‡
CONFIG_PCI_MSI


438 
DEFINE_PER_CPU
(
h≥t_dev
 *, 
˝u_h≥t_dev
);

439 
h≥t_dev
 *
	gh≥t_devs
;

441 
	$h≥t_msi_unmask
(
úq
)

443 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

444 
cfg
;

447 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

448 
cfg
 |
HPET_TN_FSB
;

449 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

450 
	}
}

452 
	$h≥t_msi_mask
(
úq
)

454 
cfg
;

455 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

458 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
hdev
->
num
));

459 
cfg
 &~
HPET_TN_FSB
;

460 
	`h≥t_wrôñ
(
cfg
, 
	`HPET_Tn_CFG
(
hdev
->
num
));

461 
	}
}

463 
	$h≥t_msi_wrôe
(
úq
, 
msi_msg
 *
msg
)

465 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

467 
	`h≥t_wrôñ
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
));

468 
	`h≥t_wrôñ
(
msg
->
addªss_lo
, 
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

469 
	}
}

471 
	$h≥t_msi_ªad
(
úq
, 
msi_msg
 *
msg
)

473 
h≥t_dev
 *
hdev
 = 
	`gë_úq_d©a
(
úq
);

475 
msg
->
d©a
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
));

476 
msg
->
addªss_lo
 = 
	`h≥t_ªadl
(
	`HPET_Tn_ROUTE
(
hdev
->
num
) + 4);

477 
msg
->
addªss_hi
 = 0;

478 
	}
}

480 
	$h≥t_msi_£t_mode
(
˛ock_evít_mode
 
mode
,

481 
˛ock_evít_devi˚
 *
evt
)

483 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

484 
	`h≥t_£t_mode
(
mode
, 
evt
, 
hdev
->
num
);

485 
	}
}

487 
	$h≥t_msi_√xt_evít
(
dñè
,

488 
˛ock_evít_devi˚
 *
evt
)

490 
h≥t_dev
 *
hdev
 = 
	`EVT_TO_HPET_DEV
(
evt
);

491  
	`h≥t_√xt_evít
(
dñè
, 
evt
, 
hdev
->
num
);

492 
	}
}

494 
	$h≥t_£tup_msi_úq
(
úq
)

496 i‡(
	`¨ch_£tup_h≥t_msi
(
úq
, 
h≥t_blockid
)) {

497 
	`de°roy_úq
(
úq
);

498  -
EINVAL
;

501 
	}
}

503 
	$h≥t_assign_úq
(
h≥t_dev
 *
dev
)

505 
úq
;

507 
úq
 = 
	`¸óã_úq
();

508 i‡(!
úq
)

509  -
EINVAL
;

511 
	`£t_úq_d©a
(
úq
, 
dev
);

513 i‡(
	`h≥t_£tup_msi_úq
(
úq
))

514  -
EINVAL
;

516 
dev
->
úq
 = irq;

518 
	}
}

520 
úqªtu∫_t
 
	$h≥t_öãºu±_h™dÀr
(
úq
, *
d©a
)

522 
h≥t_dev
 *
dev
 = (h≥t_dev *)
d©a
;

523 
˛ock_evít_devi˚
 *
hevt
 = &
dev
->
evt
;

525 i‡(!
hevt
->
evít_h™dÀr
) {

526 
	`¥ötk
(
KERN_INFO
 "Spurious HPETÅimer interrupt on HPETÅimer %d\n",

527 
dev
->
num
);

528  
IRQ_HANDLED
;

531 
hevt
->
	`evít_h™dÀr
(hevt);

532  
IRQ_HANDLED
;

533 
	}
}

535 
	$h≥t_£tup_úq
(
h≥t_dev
 *
dev
)

538 i‡(
	`ªque°_úq
(
dev
->
úq
, 
h≥t_öãºu±_h™dÀr
,

539 
IRQF_TIMER
 | 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
,

540 
dev
->
«me
, dev))

543 
	`dißbÀ_úq
(
dev
->
úq
);

544 
	`úq_£t_afföôy
(
dev
->
úq
, 
	`˝umask_of
(dev->
˝u
));

545 
	`íabÀ_úq
(
dev
->
úq
);

547 
	`¥ötk
(
KERN_DEBUG
 "hpet: %s irq %d for MSI\n",

548 
dev
->
«me
, dev->
úq
);

551 
	}
}

554 
	$öô_⁄e_h≥t_msi_˛ockevít
(
h≥t_dev
 *
hdev
, 
˝u
)

556 
˛ock_evít_devi˚
 *
evt
 = &
hdev
->evt;

557 
uöt64_t
 
h≥t_‰eq
;

559 
	`WARN_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

560 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

563 i‡(
	`h≥t_£tup_msi_úq
(
hdev
->
úq
))

566 
hdev
->
˝u
 = cpu;

567 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
hdev
;

568 
evt
->
«me
 = 
hdev
->name;

569 
	`h≥t_£tup_úq
(
hdev
);

570 
evt
->
úq
 = 
hdev
->irq;

572 
evt
->
øtög
 = 110;

573 
evt
->
„©uªs
 = 
CLOCK_EVT_FEAT_ONESHOT
;

574 i‡(
hdev
->
Êags
 & 
HPET_DEV_PERI_CAP
)

575 
evt
->
„©uªs
 |
CLOCK_EVT_FEAT_PERIODIC
;

577 
evt
->
£t_mode
 = 
h≥t_msi_£t_mode
;

578 
evt
->
£t_√xt_evít
 = 
h≥t_msi_√xt_evít
;

579 
evt
->
shi·
 = 32;

586 
h≥t_‰eq
 = 1000000000000000ULL;

587 
	`do_div
(
h≥t_‰eq
, 
h≥t_≥riod
);

588 
evt
->
mu…
 = 
	`div_sc
((Ë
h≥t_‰eq
,

589 
NSEC_PER_SEC
, 
evt
->
shi·
);

591 
evt
->
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFFFFFF,Évt);

593 
evt
->
mö_dñè_ns
 = 5000;

595 
evt
->
˝umask
 = 
	`˝umask_of
(
hdev
->
˝u
);

596 
	`˛ockevíts_ªgi°î_devi˚
(
evt
);

597 
	}
}

599 #ifde‡
CONFIG_HPET


601 
	#RESERVE_TIMERS
 1

	)

603 
	#RESERVE_TIMERS
 0

	)

606 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

608 
id
;

609 
num_timîs
;

610 
num_timîs_u£d
 = 0;

611 
i
;

613 i‡(
h≥t_msi_dißbÀ
)

616 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

618 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

620 
num_timîs
 = ((
id
 & 
HPET_ID_NUMBER
Ë>> 
HPET_ID_NUMBER_SHIFT
);

621 
num_timîs
++;

622 
	`h≥t_¥öt_c⁄fig
();

624 
h≥t_devs
 = 
	`kzÆloc
((
h≥t_dev
Ë* 
num_timîs
, 
GFP_KERNEL
);

625 i‡(!
h≥t_devs
)

628 
h≥t_num_timîs
 = 
num_timîs
;

630 
i
 = 
°¨t_timî
; i < 
num_timîs
 - 
RESERVE_TIMERS
; i++) {

631 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
num_timîs_u£d
];

632 
cfg
 = 
	`h≥t_ªadl
(
	`HPET_Tn_CFG
(
i
));

635 i‡(!(
cfg
 & 
HPET_TN_FSB_CAP
))

638 
hdev
->
Êags
 = 0;

639 i‡(
cfg
 & 
HPET_TN_PERIODIC_CAP
)

640 
hdev
->
Êags
 |
HPET_DEV_PERI_CAP
;

641 
hdev
->
num
 = 
i
;

643 
	`•rötf
(
hdev
->
«me
, "h≥t%d", 
i
);

644 i‡(
	`h≥t_assign_úq
(
hdev
))

647 
hdev
->
Êags
 |
HPET_DEV_FSB_CAP
;

648 
hdev
->
Êags
 |
HPET_DEV_VALID
;

649 
num_timîs_u£d
++;

650 i‡(
num_timîs_u£d
 =
	`num_possibÀ_˝us
())

654 
	`¥ötk
(
KERN_INFO
 "HPET: %dÅimers inÅotal, %dÅimers will be used forÖer-cpuÅimer\n",

655 
num_timîs
, 
num_timîs_u£d
);

656 
	}
}

658 #ifde‡
CONFIG_HPET


659 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

661 
i
;

663 i‡(!
h≥t_devs
)

666 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

667 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

669 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

672 
hd
->
hd_úq
[
hdev
->
num
] = hdev->
úq
;

673 
	`h≥t_ª£rve_timî
(
hd
, 
hdev
->
num
);

675 
	}
}

678 
h≥t_dev
 *
	$h≥t_gë_unu£d_timî
()

680 
i
;

682 i‡(!
h≥t_devs
)

683  
NULL
;

685 
i
 = 0; i < 
h≥t_num_timîs
; i++) {

686 
h≥t_dev
 *
hdev
 = &
h≥t_devs
[
i
];

688 i‡(!(
hdev
->
Êags
 & 
HPET_DEV_VALID
))

690 i‡(
	`ã°_™d_£t_bô
(
HPET_DEV_USED_BIT
,

691 (*)&
hdev
->
Êags
))

693  
hdev
;

695  
NULL
;

696 
	}
}

698 
	sh≥t_w‹k_°ru˘
 {

699 
dñayed_w‹k
 
	mw‹k
;

700 
com∂ëi⁄
 
	mcom∂ëe
;

703 
	$h≥t_w‹k
(
w‹k_°ru˘
 *
w
)

705 
h≥t_dev
 *
hdev
;

706 
˝u
 = 
	`smp_¥o˚ss‹_id
();

707 
h≥t_w‹k_°ru˘
 *
h≥t_w‹k
;

709 
h≥t_w‹k
 = 
	`c⁄èöî_of
(
w
, 
h≥t_w‹k_°ru˘
, 
w‹k
.work);

711 
hdev
 = 
	`h≥t_gë_unu£d_timî
();

712 i‡(
hdev
)

713 
	`öô_⁄e_h≥t_msi_˛ockevít
(
hdev
, 
˝u
);

715 
	`com∂ëe
(&
h≥t_w‹k
->
com∂ëe
);

716 
	}
}

718 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

719 
a˘i⁄
, *
h˝u
)

721 
˝u
 = ()
h˝u
;

722 
h≥t_w‹k_°ru˘
 
w‹k
;

723 
h≥t_dev
 *
hdev
 = 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
);

725 
a˘i⁄
 & 0xf) {

726 
CPU_ONLINE
:

727 
	`INIT_DELAYED_WORK_ON_STACK
(&
w‹k
.w‹k, 
h≥t_w‹k
);

728 
	`öô_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

730 
	`scheduÀ_dñayed_w‹k_⁄
(
˝u
, &
w‹k
.work, 0);

731 
	`waô_f‹_com∂ëi⁄
(&
w‹k
.
com∂ëe
);

732 
	`de°roy_timî_⁄_°ack
(&
w‹k
.w‹k.
timî
);

734 
CPU_DEAD
:

735 i‡(
hdev
) {

736 
	`‰ì_úq
(
hdev
->
úq
, hdev);

737 
hdev
->
Êags
 &~
HPET_DEV_USED
;

738 
	`≥r_˝u
(
˝u_h≥t_dev
, 
˝u
Ë
NULL
;

742  
NOTIFY_OK
;

743 
	}
}

746 
	$h≥t_£tup_msi_úq
(
úq
)

749 
	}
}

750 
	$h≥t_msi_ˇ∑bûôy_lookup
(
°¨t_timî
)

753 
	}
}

755 #ifde‡
CONFIG_HPET


756 
	$h≥t_ª£rve_msi_timîs
(
h≥t_d©a
 *
hd
)

759 
	}
}

762 
	$h≥t_˝uhp_nŸify
(
nŸifõr_block
 *
n
,

763 
a˘i⁄
, *
h˝u
)

765  
NOTIFY_OK
;

766 
	}
}

773 
cy˛e_t
 
	$ªad_h≥t
(
˛ocksour˚
 *
cs
)

775  (
cy˛e_t
)
	`h≥t_ªadl
(
HPET_COUNTER
);

776 
	}
}

778 #ifde‡
CONFIG_X86_64


779 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_h≥t
()

781  
	`ªadl
((c⁄° 
__iomem
 *)
	`fix_to_vút
(
VSYSCALL_HPET
) + 0xf0);

782 
	}
}

785 
˛ocksour˚
 
	g˛ocksour˚_h≥t
 = {

786 .
«me
 = "hpet",

787 .
	gøtög
 = 250,

788 .
	gªad
 = 
ªad_h≥t
,

789 .
	gmask
 = 
HPET_MASK
,

790 .
	gshi·
 = 
HPET_SHIFT
,

791 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

792 .
	gªsume
 = 
h≥t_ªsume_cou¡î
,

793 #ifde‡
CONFIG_X86_64


794 .
	gvªad
 = 
vªad_h≥t
,

798 
	$h≥t_˛ocksour˚_ªgi°î
()

800 
u64
 
°¨t
, 
now
;

801 
cy˛e_t
 
t1
;

804 
	`h≥t_ª°¨t_cou¡î
();

807 
t1
 = 
	`h≥t_ªadl
(
HPET_COUNTER
);

808 
	`rdts˛l
(
°¨t
);

817 
	`ªp_n›
();

818 
	`rdts˛l
(
now
);

819 } (
now
 - 
°¨t
) < 200000UL);

821 i‡(
t1
 =
	`h≥t_ªadl
(
HPET_COUNTER
)) {

822 
	`¥ötk
(
KERN_WARNING


824  -
ENODEV
;

835 
˛ocksour˚_h≥t
.
mu…
 = 
	`div_sc
(
h≥t_≥riod
, 
FSEC_PER_NSEC
, 
HPET_SHIFT
);

837 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_h≥t
);

840 
	}
}

845 
__öô
 
	$h≥t_íabÀ
()

847 
id
;

848 
i
;

850 i‡(!
	`is_h≥t_ˇ∑bÀ
())

853 
	`h≥t_£t_m≠pög
();

858 
h≥t_≥riod
 = 
	`h≥t_ªadl
(
HPET_PERIOD
);

873 
i
 = 0; 
	`h≥t_ªadl
(
HPET_CFG
) == 0xFFFFFFFF; i++) {

874 i‡(
i
 == 1000) {

875 
	`¥ötk
(
KERN_WARNING


878 
out_noh≥t
;

882 i‡(
h≥t_≥riod
 < 
HPET_MIN_PERIOD
 || h≥t_≥riod > 
HPET_MAX_PERIOD
)

883 
out_noh≥t
;

889 
id
 = 
	`h≥t_ªadl
(
HPET_ID
);

890 
	`h≥t_¥öt_c⁄fig
();

892 #ifde‡
CONFIG_HPET_EMULATE_RTC


897 i‡(!(
id
 & 
HPET_ID_NUMBER
))

898 
out_noh≥t
;

901 i‡(
	`h≥t_˛ocksour˚_ªgi°î
())

902 
out_noh≥t
;

904 i‡(
id
 & 
HPET_ID_LEGSUP
) {

905 
	`h≥t_Àgacy_˛ockevít_ªgi°î
();

910 
out_noh≥t
:

911 
	`h≥t_˛ór_m≠pög
();

912 
h≥t_addªss
 = 0;

914 
	}
}

922 
__öô
 
	$h≥t_œã_öô
()

924 
˝u
;

926 i‡(
boŸ_h≥t_dißbÀ
)

927  -
ENODEV
;

929 i‡(!
h≥t_addªss
) {

930 i‡(!
f‹˚_h≥t_addªss
)

931  -
ENODEV
;

933 
h≥t_addªss
 = 
f‹˚_h≥t_addªss
;

934 
	`h≥t_íabÀ
();

937 i‡(!
h≥t_vút_addªss
)

938  -
ENODEV
;

940 i‡(
	`h≥t_ªadl
(
HPET_ID
Ë& 
HPET_ID_LEGSUP
)

941 
	`h≥t_msi_ˇ∑bûôy_lookup
(2);

943 
	`h≥t_msi_ˇ∑bûôy_lookup
(0);

945 
	`h≥t_ª£rve_∂©f‹m_timîs
(
	`h≥t_ªadl
(
HPET_ID
));

946 
	`h≥t_¥öt_c⁄fig
();

948 i‡(
h≥t_msi_dißbÀ
)

951 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_ARAT
))

954 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

955 
	`h≥t_˝uhp_nŸify
(
NULL
, 
CPU_ONLINE
, (*)()
˝u
);

959 
	`hŸ˝u_nŸifõr
(
h≥t_˝uhp_nŸify
, -20);

962 
	}
}

963 
fs_öôˇŒ
(
h≥t_œã_öô
);

965 
	$h≥t_dißbÀ
()

967 i‡(
	`is_h≥t_ˇ∑bÀ
(Ë&& 
h≥t_vút_addªss
) {

968 
cfg
 = 
	`h≥t_ªadl
(
HPET_CFG
);

970 i‡(
h≥t_Àgacy_öt_íabÀd
) {

971 
cfg
 &~
HPET_CFG_LEGACY
;

972 
h≥t_Àgacy_öt_íabÀd
 = 0;

974 
cfg
 &~
HPET_CFG_ENABLE
;

975 
	`h≥t_wrôñ
(
cfg
, 
HPET_CFG
);

977 
	}
}

979 #ifde‡
CONFIG_HPET_EMULATE_RTC


995 
	~<löux/mc146818πc.h
>

996 
	~<löux/πc.h
>

997 
	~<asm/πc.h
>

999 
	#DEFAULT_RTC_INT_FREQ
 64

	)

1000 
	#DEFAULT_RTC_SHIFT
 6

	)

1001 
	#RTC_NUM_INTS
 1

	)

1003 
	gh≥t_πc_Êags
;

1004 
	gh≥t_¥ev_upd©e_£c
;

1005 
πc_time
 
	gh≥t_Æ¨m_time
;

1006 
	gh≥t_põ_cou¡
;

1007 
u32
 
	gh≥t_t1_cmp
;

1008 
u32
 
	gh≥t_deÁu…_dñè
;

1009 
u32
 
	gh≥t_põ_dñè
;

1010 
	gh≥t_põ_limô
;

1012 
πc_úq_h™dÀr
 
	gúq_h™dÀr
;

1017 
ölöe
 
	$h≥t_˙t_ahód
(
u32
 
c1
, u32 
c2
)

1019  (
s32
)(
c2
 - 
c1
) < 0;

1020 
	}
}

1025 
	$h≥t_ªgi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1027 i‡(!
	`is_h≥t_íabÀd
())

1028  -
ENODEV
;

1029 i‡(
úq_h™dÀr
)

1030  -
EBUSY
;

1032 
úq_h™dÀr
 = 
h™dÀr
;

1035 
	}
}

1036 
EXPORT_SYMBOL_GPL
(
h≥t_ªgi°î_úq_h™dÀr
);

1042 
	$h≥t_uƒegi°î_úq_h™dÀr
(
πc_úq_h™dÀr
 
h™dÀr
)

1044 i‡(!
	`is_h≥t_íabÀd
())

1047 
úq_h™dÀr
 = 
NULL
;

1048 
h≥t_πc_Êags
 = 0;

1049 
	}
}

1050 
EXPORT_SYMBOL_GPL
(
h≥t_uƒegi°î_úq_h™dÀr
);

1058 
	$h≥t_πc_timî_öô
()

1060 
cfg
, 
˙t
, 
dñè
;

1061 
Êags
;

1063 i‡(!
	`is_h≥t_íabÀd
())

1066 i‡(!
h≥t_deÁu…_dñè
) {

1067 
uöt64_t
 
˛c
;

1069 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1070 
˛c
 >>
h≥t_˛ockevít
.
shi·
 + 
DEFAULT_RTC_SHIFT
;

1071 
h≥t_deÁu…_dñè
 = 
˛c
;

1074 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1075 
dñè
 = 
h≥t_deÁu…_dñè
;

1077 
dñè
 = 
h≥t_põ_dñè
;

1079 
	`loˇl_úq_ßve
(
Êags
);

1081 
˙t
 = 
dñè
 + 
	`h≥t_ªadl
(
HPET_COUNTER
);

1082 
	`h≥t_wrôñ
(
˙t
, 
HPET_T1_CMP
);

1083 
h≥t_t1_cmp
 = 
˙t
;

1085 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1086 
cfg
 &~
HPET_TN_PERIODIC
;

1087 
cfg
 |
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

1088 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1090 
	`loˇl_úq_ª°‹e
(
Êags
);

1093 
	}
}

1094 
EXPORT_SYMBOL_GPL
(
h≥t_πc_timî_öô
);

1101 
	$h≥t_mask_πc_úq_bô
(
bô_mask
)

1103 i‡(!
	`is_h≥t_íabÀd
())

1106 
h≥t_πc_Êags
 &~
bô_mask
;

1108 
	}
}

1109 
EXPORT_SYMBOL_GPL
(
h≥t_mask_πc_úq_bô
);

1111 
	$h≥t_£t_πc_úq_bô
(
bô_mask
)

1113 
ﬁdbôs
 = 
h≥t_πc_Êags
;

1115 i‡(!
	`is_h≥t_íabÀd
())

1118 
h≥t_πc_Êags
 |
bô_mask
;

1120 i‡((
bô_mask
 & 
RTC_UIE
Ë&& !(
ﬁdbôs
 & RTC_UIE))

1121 
h≥t_¥ev_upd©e_£c
 = -1;

1123 i‡(!
ﬁdbôs
)

1124 
	`h≥t_πc_timî_öô
();

1127 
	}
}

1128 
EXPORT_SYMBOL_GPL
(
h≥t_£t_πc_úq_bô
);

1130 
	$h≥t_£t_Æ¨m_time
(
hrs
, 
mö
,

1131 
£c
)

1133 i‡(!
	`is_h≥t_íabÀd
())

1136 
h≥t_Æ¨m_time
.
tm_hour
 = 
hrs
;

1137 
h≥t_Æ¨m_time
.
tm_mö
 = 
mö
;

1138 
h≥t_Æ¨m_time
.
tm_£c
 = 
£c
;

1141 
	}
}

1142 
EXPORT_SYMBOL_GPL
(
h≥t_£t_Æ¨m_time
);

1144 
	$h≥t_£t_≥riodic_‰eq
(
‰eq
)

1146 
uöt64_t
 
˛c
;

1148 i‡(!
	`is_h≥t_íabÀd
())

1151 i‡(
‰eq
 <
DEFAULT_RTC_INT_FREQ
)

1152 
h≥t_põ_limô
 = 
DEFAULT_RTC_INT_FREQ
 / 
‰eq
;

1154 
˛c
 = (
uöt64_t
Ë
h≥t_˛ockevít
.
mu…
 * 
NSEC_PER_SEC
;

1155 
	`do_div
(
˛c
, 
‰eq
);

1156 
˛c
 >>
h≥t_˛ockevít
.
shi·
;

1157 
h≥t_põ_dñè
 = 
˛c
;

1158 
h≥t_põ_limô
 = 0;

1161 
	}
}

1162 
EXPORT_SYMBOL_GPL
(
h≥t_£t_≥riodic_‰eq
);

1164 
	$h≥t_πc_dr›≥d_úq
()

1166  
	`is_h≥t_íabÀd
();

1167 
	}
}

1168 
EXPORT_SYMBOL_GPL
(
h≥t_πc_dr›≥d_úq
);

1170 
	$h≥t_πc_timî_ªöô
()

1172 
cfg
, 
dñè
;

1173 
lo°_öts
 = -1;

1175 i‡(
	`u∆ikñy
(!
h≥t_πc_Êags
)) {

1176 
cfg
 = 
	`h≥t_ªadl
(
HPET_T1_CFG
);

1177 
cfg
 &~
HPET_TN_ENABLE
;

1178 
	`h≥t_wrôñ
(
cfg
, 
HPET_T1_CFG
);

1182 i‡(!(
h≥t_πc_Êags
 & 
RTC_PIE
Ë|| 
h≥t_põ_limô
)

1183 
dñè
 = 
h≥t_deÁu…_dñè
;

1185 
dñè
 = 
h≥t_põ_dñè
;

1192 
h≥t_t1_cmp
 +
dñè
;

1193 
	`h≥t_wrôñ
(
h≥t_t1_cmp
, 
HPET_T1_CMP
);

1194 
lo°_öts
++;

1195 } !
	`h≥t_˙t_ahód
(
h≥t_t1_cmp
, 
	`h≥t_ªadl
(
HPET_COUNTER
)));

1197 i‡(
lo°_öts
) {

1198 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
)

1199 
h≥t_põ_cou¡
 +
lo°_öts
;

1200 i‡(
	`¥ötk_øãlimô
())

1201 
	`¥ötk
(
KERN_WARNING
 "hpet1:Üost %dÑtc interrupts\n",

1202 
lo°_öts
);

1204 
	}
}

1206 
úqªtu∫_t
 
	$h≥t_πc_öãºu±
(
úq
, *
dev_id
)

1208 
πc_time
 
cuº_time
;

1209 
πc_öt_Êag
 = 0;

1211 
	`h≥t_πc_timî_ªöô
();

1212 
	`mem£t
(&
cuº_time
, 0, (
πc_time
));

1214 i‡(
h≥t_πc_Êags
 & (
RTC_UIE
 | 
RTC_AIE
))

1215 
	`gë_πc_time
(&
cuº_time
);

1217 i‡(
h≥t_πc_Êags
 & 
RTC_UIE
 &&

1218 
cuº_time
.
tm_£c
 !
h≥t_¥ev_upd©e_£c
) {

1219 i‡(
h≥t_¥ev_upd©e_£c
 >= 0)

1220 
πc_öt_Êag
 = 
RTC_UF
;

1221 
h≥t_¥ev_upd©e_£c
 = 
cuº_time
.
tm_£c
;

1224 i‡(
h≥t_πc_Êags
 & 
RTC_PIE
 &&

1225 ++
h≥t_põ_cou¡
 >
h≥t_põ_limô
) {

1226 
πc_öt_Êag
 |
RTC_PF
;

1227 
h≥t_põ_cou¡
 = 0;

1230 i‡(
h≥t_πc_Êags
 & 
RTC_AIE
 &&

1231 (
cuº_time
.
tm_£c
 =
h≥t_Æ¨m_time
.tm_sec) &&

1232 (
cuº_time
.
tm_mö
 =
h≥t_Æ¨m_time
.tm_min) &&

1233 (
cuº_time
.
tm_hour
 =
h≥t_Æ¨m_time
.tm_hour))

1234 
πc_öt_Êag
 |
RTC_AF
;

1236 i‡(
πc_öt_Êag
) {

1237 
πc_öt_Êag
 |(
RTC_IRQF
 | (
RTC_NUM_INTS
 << 8));

1238 i‡(
úq_h™dÀr
)

1239 
	`úq_h™dÀr
(
πc_öt_Êag
, 
dev_id
);

1241  
IRQ_HANDLED
;

1242 
	}
}

1243 
EXPORT_SYMBOL_GPL
(
h≥t_πc_öãºu±
);

	@/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c

30 
	~<löux/≥rf_evít.h
>

31 
	~<löux/hw_bªakpoöt.h
>

32 
	~<löux/úqÊags.h
>

33 
	~<löux/nŸifõr.h
>

34 
	~<löux/kÆlsyms.h
>

35 
	~<löux/k¥obes.h
>

36 
	~<löux/≥r˝u.h
>

37 
	~<löux/kdebug.h
>

38 
	~<löux/kî√l.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/sched.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/smp.h
>

44 
	~<asm/hw_bªakpoöt.h
>

45 
	~<asm/¥o˚ss‹.h
>

46 
	~<asm/debugªg.h
>

49 
DEFINE_PER_CPU
(, 
˝u_dr7
);

50 
EXPORT_PER_CPU_SYMBOL
(
˝u_dr7
);

53 
DEFINE_PER_CPU
(, 
˝u_debugªg
[
HBP_NUM
]);

59 
DEFINE_PER_CPU
(
≥rf_evít
 *, 
bp_≥r_ªg
[
HBP_NUM
]);

62 
ölöe
 

63 
	$__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

65 
bp_öfo
;

67 
bp_öfo
 = (
Àn
 | 
ty≥
) & 0xf;

68 
bp_öfo
 <<(
DR_CONTROL_SHIFT
 + 
d∫um
 * 
DR_CONTROL_SIZE
);

69 
bp_öfo
 |(
DR_GLOBAL_ENABLE
 << (
d∫um
 * 
DR_ENABLE_SIZE
));

71  
bp_öfo
;

72 
	}
}

78 
	$ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
)

80  
	`__ícode_dr7
(
d∫um
, 
Àn
, 
ty≥
Ë| 
DR_GLOBAL_SLOWDOWN
;

81 
	}
}

87 
	$decode_dr7
(
dr7
, 
b≤um
, *
Àn
, *
ty≥
)

89 
bp_öfo
 = 
dr7
 >> (
DR_CONTROL_SHIFT
 + 
b≤um
 * 
DR_CONTROL_SIZE
);

91 *
Àn
 = (
bp_öfo
 & 0xc) | 0x40;

92 *
ty≥
 = (
bp_öfo
 & 0x3) | 0x80;

94  (
dr7
 >> (
b≤um
 * 
DR_ENABLE_SIZE
)) & 0x3;

95 
	}
}

106 
	$¨ch_ö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

108 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

109 *
dr7
;

110 
i
;

112 
i
 = 0; i < 
HBP_NUM
; i++) {

113 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

115 i‡(!*
¶Ÿ
) {

116 *
¶Ÿ
 = 
bp
;

121 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

122  -
EBUSY
;

124 
	`£t_debugªg
(
öfo
->
addªss
, 
i
);

125 
	`__gë_˝u_v¨
(
˝u_debugªg
[
i
]Ë
öfo
->
addªss
;

127 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

128 *
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

130 
	`£t_debugªg
(*
dr7
, 7);

133 
	}
}

144 
	$¨ch_unö°Æl_hw_bªakpoöt
(
≥rf_evít
 *
bp
)

146 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

147 *
dr7
;

148 
i
;

150 
i
 = 0; i < 
HBP_NUM
; i++) {

151 
≥rf_evít
 **
¶Ÿ
 = &
	`__gë_˝u_v¨
(
bp_≥r_ªg
[
i
]);

153 i‡(*
¶Ÿ
 =
bp
) {

154 *
¶Ÿ
 = 
NULL
;

159 i‡(
	`WARN_ONCE
(
i
 =
HBP_NUM
, "Can't findány breakpoint slot"))

162 
dr7
 = &
	`__gë_˝u_v¨
(
˝u_dr7
);

163 *
dr7
 &~
	`__ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

165 
	`£t_debugªg
(*
dr7
, 7);

166 
	}
}

168 
	$gë_hbp_Àn
(
u8
 
hbp_Àn
)

170 
Àn_ö_byãs
 = 0;

172 
hbp_Àn
) {

173 
X86_BREAKPOINT_LEN_1
:

174 
Àn_ö_byãs
 = 1;

176 
X86_BREAKPOINT_LEN_2
:

177 
Àn_ö_byãs
 = 2;

179 
X86_BREAKPOINT_LEN_4
:

180 
Àn_ö_byãs
 = 4;

182 #ifde‡
CONFIG_X86_64


183 
X86_BREAKPOINT_LEN_8
:

184 
Àn_ö_byãs
 = 8;

188  
Àn_ö_byãs
;

189 
	}
}

194 
	$¨ch_check_bp_ö_kî√l•a˚
(
≥rf_evít
 *
bp
)

196 
Àn
;

197 
va
;

198 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

200 
va
 = 
öfo
->
addªss
;

201 
Àn
 = 
	`gë_hbp_Àn
(
öfo
->len);

203  (
va
 >
TASK_SIZE
Ë&& ((v®+ 
Àn
 - 1) >= TASK_SIZE);

204 
	}
}

206 
	$¨ch_bp_gíîic_fõlds
(
x86_Àn
, 
x86_ty≥
,

207 *
gí_Àn
, *
gí_ty≥
)

210 
x86_Àn
) {

211 
X86_BREAKPOINT_LEN_1
:

212 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_1
;

214 
X86_BREAKPOINT_LEN_2
:

215 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_2
;

217 
X86_BREAKPOINT_LEN_4
:

218 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_4
;

220 #ifde‡
CONFIG_X86_64


221 
X86_BREAKPOINT_LEN_8
:

222 *
gí_Àn
 = 
HW_BREAKPOINT_LEN_8
;

226  -
EINVAL
;

230 
x86_ty≥
) {

231 
X86_BREAKPOINT_EXECUTE
:

232 *
gí_ty≥
 = 
HW_BREAKPOINT_X
;

234 
X86_BREAKPOINT_WRITE
:

235 *
gí_ty≥
 = 
HW_BREAKPOINT_W
;

237 
X86_BREAKPOINT_RW
:

238 *
gí_ty≥
 = 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
;

241  -
EINVAL
;

245 
	}
}

248 
	$¨ch_buûd_bp_öfo
(
≥rf_evít
 *
bp
)

250 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

252 
öfo
->
addªss
 = 
bp
->
©å
.
bp_addr
;

255 
bp
->
©å
.
bp_Àn
) {

256 
HW_BREAKPOINT_LEN_1
:

257 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_1
;

259 
HW_BREAKPOINT_LEN_2
:

260 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_2
;

262 
HW_BREAKPOINT_LEN_4
:

263 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_4
;

265 #ifde‡
CONFIG_X86_64


266 
HW_BREAKPOINT_LEN_8
:

267 
öfo
->
Àn
 = 
X86_BREAKPOINT_LEN_8
;

271  -
EINVAL
;

275 
bp
->
©å
.
bp_ty≥
) {

276 
HW_BREAKPOINT_W
:

277 
öfo
->
ty≥
 = 
X86_BREAKPOINT_WRITE
;

279 
HW_BREAKPOINT_W
 | 
HW_BREAKPOINT_R
:

280 
öfo
->
ty≥
 = 
X86_BREAKPOINT_RW
;

282 
HW_BREAKPOINT_X
:

283 
öfo
->
ty≥
 = 
X86_BREAKPOINT_EXECUTE
;

286  -
EINVAL
;

290 
	}
}

294 
	$¨ch_vÆid©e_hwbk±_£âögs
(
≥rf_evít
 *
bp
)

296 
¨ch_hw_bªakpoöt
 *
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

297 
Æign
;

298 
ªt
;

301 
ªt
 = 
	`¨ch_buûd_bp_öfo
(
bp
);

302 i‡(
ªt
)

303  
ªt
;

305 
ªt
 = -
EINVAL
;

307 
öfo
->
Àn
) {

308 
X86_BREAKPOINT_LEN_1
:

309 
Æign
 = 0;

311 
X86_BREAKPOINT_LEN_2
:

312 
Æign
 = 1;

314 
X86_BREAKPOINT_LEN_4
:

315 
Æign
 = 3;

317 #ifde‡
CONFIG_X86_64


318 
X86_BREAKPOINT_LEN_8
:

319 
Æign
 = 7;

323  
ªt
;

330 i‡(
öfo
->
addªss
 & 
Æign
)

331  -
EINVAL
;

334 
	}
}

344 
	$aout_dump_debugªgs
(
u£r
 *
dump
)

346 
i
;

347 
dr7
 = 0;

348 
≥rf_evít
 *
bp
;

349 
¨ch_hw_bªakpoöt
 *
öfo
;

350 
thªad_°ru˘
 *
thªad
 = &
cuºít
->thread;

352 
i
 = 0; i < 
HBP_NUM
; i++) {

353 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

355 i‡(
bp
 && !bp->
©å
.
dißbÀd
) {

356 
dump
->
u_debugªg
[
i
] = 
bp
->
©å
.
bp_addr
;

357 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
);

358 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

360 
dump
->
u_debugªg
[
i
] = 0;

364 
dump
->
u_debugªg
[4] = 0;

365 
dump
->
u_debugªg
[5] = 0;

366 
dump
->
u_debugªg
[6] = 
cuºít
->
thªad
.
debugªg6
;

368 
dump
->
u_debugªg
[7] = 
dr7
;

369 
	}
}

370 
EXPORT_SYMBOL_GPL
(
aout_dump_debugªgs
);

375 
	$Êush_±ø˚_hw_bªakpoöt
(
èsk_°ru˘
 *
tsk
)

377 
i
;

378 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

380 
i
 = 0; i < 
HBP_NUM
; i++) {

381 
	`uƒegi°î_hw_bªakpoöt
(
t
->
±ø˚_bps
[
i
]);

382 
t
->
±ø˚_bps
[
i
] = 
NULL
;

384 
	}
}

386 
	$hw_bªakpoöt_ª°‹e
()

388 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[0]), 0);

389 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[1]), 1);

390 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[2]), 2);

391 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_debugªg
[3]), 3);

392 
	`£t_debugªg
(
cuºít
->
thªad
.
debugªg6
, 6);

393 
	`£t_debugªg
(
	`__gë_˝u_v¨
(
˝u_dr7
), 7);

394 
	}
}

395 
EXPORT_SYMBOL_GPL
(
hw_bªakpoöt_ª°‹e
);

413 
__k¥obes
 
	$hw_bªakpoöt_h™dÀr
(
dõ_¨gs
 *
¨gs
)

415 
i
, 
˝u
, 
rc
 = 
NOTIFY_STOP
;

416 
≥rf_evít
 *
bp
;

417 
dr7
, 
dr6
;

418 *
dr6_p
;

421 
dr6_p
 = (*)
	`ERR_PTR
(
¨gs
->
îr
);

422 
dr6
 = *
dr6_p
;

425 i‡((
dr6
 & 
DR_TRAP_BITS
) == 0)

426  
NOTIFY_DONE
;

428 
	`gë_debugªg
(
dr7
, 7);

430 
	`£t_debugªg
(0UL, 7);

436 
cuºít
->
thªad
.
debugªg6
 &~
DR_TRAP_BITS
;

437 
˝u
 = 
	`gë_˝u
();

440 
i
 = 0; i < 
HBP_NUM
; ++i) {

441 i‡(
	`likñy
(!(
dr6
 & (
DR_TRAP0
 << 
i
))))

450 
	`rcu_ªad_lock
();

452 
bp
 = 
	`≥r_˝u
(
bp_≥r_ªg
[
i
], 
˝u
);

457 (*
dr6_p
Ë&~(
DR_TRAP0
 << 
i
);

462 i‡(!
bp
) {

463 
	`rcu_ªad_u∆ock
();

467 
	`≥rf_bp_evít
(
bp
, 
¨gs
->
ªgs
);

469 
	`rcu_ªad_u∆ock
();

476 i‡((
cuºít
->
thªad
.
debugªg6
 & 
DR_TRAP_BITS
) ||

477 (
dr6
 & (~
DR_TRAP_BITS
)))

478 
rc
 = 
NOTIFY_DONE
;

480 
	`£t_debugªg
(
dr7
, 7);

481 
	`put_˝u
();

483  
rc
;

484 
	}
}

489 
__k¥obes
 
	$hw_bªakpoöt_ex˚±i⁄s_nŸify
(

490 
nŸifõr_block
 *
unu£d
, 
vÆ
, *
d©a
)

492 i‡(
vÆ
 !
DIE_DEBUG
)

493  
NOTIFY_DONE
;

495  
	`hw_bªakpoöt_h™dÀr
(
d©a
);

496 
	}
}

498 
	$hw_bªakpoöt_pmu_ªad
(
≥rf_evít
 *
bp
)

501 
	}
}

	@/cmpt816/linux/arch/x86/kernel/i387.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/ªg£t.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/¶ab.h
>

13 
	~<asm/sigc⁄ãxt.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/m©h_emu.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/±ø˚.h
>

18 
	~<asm/i387.h
>

19 
	~<asm/u£r.h
>

21 #ifde‡
CONFIG_X86_64


22 
	~<asm/sigc⁄ãxt32.h
>

23 
	~<asm/u£r32.h
>

25 
	#ßve_i387_x°©e_ü32
 
ßve_i387_x°©e


	)

26 
	#ª°‹e_i387_x°©e_ü32
 
ª°‹e_i387_x°©e


	)

27 
	#_Â°©e_ü32
 
_Â°©e


	)

28 
	#_x°©e_ü32
 
_x°©e


	)

29 
	#sig_x°©e_ü32_size
 
sig_x°©e_size


	)

30 
	#fx_sw_ª£rved_ü32
 
fx_sw_ª£rved


	)

31 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

32 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

35 #ifde‡
CONFIG_MATH_EMULATION


36 
	#HAVE_HWFP
 (
boŸ_˝u_d©a
.
h¨d_m©h
)

	)

38 
	#HAVE_HWFP
 1

	)

41 
mxc§_„©uª_mask
 
	g__ªad_mo°ly
 = 0xffffffffu;

42 
	gx°©e_size
;

43 
	gsig_x°©e_ü32_size
 = (
_Â°©e_ü32
);

44 
i387_fxßve_°ru˘
 
fx_s¸©ch
 
	g__˝uöôd©a
;

46 
__˝uöô
 
	$mxc§_„©uª_mask_öô
()

48 
mask
 = 0;

50 
	`˛ts
();

51 i‡(
˝u_has_fx§
) {

52 
	`mem£t
(&
fx_s¸©ch
, 0, (
i387_fxßve_°ru˘
));

53 
asm
 vﬁ©ûe("fxßvê%0" : : "m" (
fx_s¸©ch
));

54 
mask
 = 
fx_s¸©ch
.
mxc§_mask
;

55 i‡(
mask
 == 0)

56 
mask
 = 0x0000ffbf;

58 
mxc§_„©uª_mask
 &
mask
;

59 
	`°ts
();

60 
	}
}

62 
__˝uöô
 
	$öô_thªad_x°©e
()

64 i‡(!
HAVE_HWFP
) {

65 
x°©e_size
 = (
i387_so·_°ru˘
);

69 i‡(
˝u_has_xßve
) {

70 
	`xßve_˙txt_öô
();

74 i‡(
˝u_has_fx§
)

75 
x°©e_size
 = (
i387_fxßve_°ru˘
);

76 #ifde‡
CONFIG_X86_32


78 
x°©e_size
 = (
i387_fßve_°ru˘
);

80 
	}
}

82 #ifde‡
CONFIG_X86_64


87 
__˝uöô
 
	$Âu_öô
()

89 
ﬁd¸0
 = 
	`ªad_¸0
();

91 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

92 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

94 
	`wrôe_¸0
(
ﬁd¸0
 & ~(
X86_CR0_TS
|
X86_CR0_EM
));

99 i‡(!
	`smp_¥o˚ss‹_id
())

100 
	`öô_thªad_x°©e
();

101 
	`xßve_öô
();

103 
	`mxc§_„©uª_mask_öô
();

105 
	`cuºít_thªad_öfo
()->
°©us
 = 0;

106 
	`˛ór_u£d_m©h
();

107 
	}
}

110 
	$Âu_föô
(
Âu
 *fpu)

112 #ifde‡
CONFIG_X86_32


113 i‡(!
HAVE_HWFP
) {

114 
	`föô_so·_Âu
(&
Âu
->
°©e
->
so·
);

119 i‡(
˝u_has_fx§
) {

120 
i387_fxßve_°ru˘
 *
fx
 = &
Âu
->
°©e
->
fxßve
;

122 
	`mem£t
(
fx
, 0, 
x°©e_size
);

123 
fx
->
cwd
 = 0x37f;

124 i‡(
˝u_has_xmm
)

125 
fx
->
mxc§
 = 
MXCSR_DEFAULT
;

127 
i387_fßve_°ru˘
 *
Â
 = &
Âu
->
°©e
->
fßve
;

128 
	`mem£t
(
Â
, 0, 
x°©e_size
);

129 
Â
->
cwd
 = 0xffff037fu;

130 
Â
->
swd
 = 0xffff0000u;

131 
Â
->
twd
 = 0xffffffffu;

132 
Â
->
fos
 = 0xffff0000u;

134 
	}
}

142 
	$öô_Âu
(
èsk_°ru˘
 *
tsk
)

144 
ªt
;

146 i‡(
	`tsk_u£d_m©h
(
tsk
)) {

147 i‡(
HAVE_HWFP
 && 
tsk
 =
cuºít
)

148 
	`u∆azy_Âu
(
tsk
);

155 
ªt
 = 
	`Âu_Æloc
(&
tsk
->
thªad
.
Âu
);

156 i‡(
ªt
)

157  
ªt
;

159 
	`Âu_föô
(&
tsk
->
thªad
.
Âu
);

161 
	`£t_°›≥d_chûd_u£d_m©h
(
tsk
);

163 
	}
}

170 
	$Âªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

172  
	`tsk_u£d_m©h
(
èrgë
Ë? 
ªg£t
->
n
 : 0;

173 
	}
}

175 
	$xÂªgs_a˘ive
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
)

177  (
˝u_has_fx§
 && 
	`tsk_u£d_m©h
(
èrgë
)Ë? 
ªg£t
->
n
 : 0;

178 
	}
}

180 
	$xÂªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

181 
pos
, 
cou¡
,

182 *
kbuf
, 
__u£r
 *
ubuf
)

184 
ªt
;

186 i‡(!
˝u_has_fx§
)

187  -
ENODEV
;

189 
ªt
 = 
	`öô_Âu
(
èrgë
);

190 i‡(
ªt
)

191  
ªt
;

193  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

194 &
èrgë
->
thªad
.
Âu
.
°©e
->
fxßve
, 0, -1);

195 
	}
}

197 
	$xÂªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

198 
pos
, 
cou¡
,

199 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

201 
ªt
;

203 i‡(!
˝u_has_fx§
)

204  -
ENODEV
;

206 
ªt
 = 
	`öô_Âu
(
èrgë
);

207 i‡(
ªt
)

208  
ªt
;

210 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

211 &
èrgë
->
thªad
.
Âu
.
°©e
->
fxßve
, 0, -1);

216 
èrgë
->
thªad
.
Âu
.
°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

222 i‡(
˝u_has_xßve
)

223 
èrgë
->
thªad
.
Âu
.
°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

225  
ªt
;

226 
	}
}

228 
	$x°©îegs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

229 
pos
, 
cou¡
,

230 *
kbuf
, 
__u£r
 *
ubuf
)

232 
ªt
;

234 i‡(!
˝u_has_xßve
)

235  -
ENODEV
;

237 
ªt
 = 
	`öô_Âu
(
èrgë
);

238 i‡(
ªt
)

239  
ªt
;

246 
	`mem˝y
(&
èrgë
->
thªad
.
Âu
.
°©e
->
fxßve
.
sw_ª£rved
,

247 
x°©e_fx_sw_byãs
, (xstate_fx_sw_bytes));

252 
ªt
 = 
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

253 &
èrgë
->
thªad
.
Âu
.
°©e
->
xßve
, 0, -1);

254  
ªt
;

255 
	}
}

257 
	$x°©îegs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

258 
pos
, 
cou¡
,

259 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

261 
ªt
;

262 
xßve_hdr_°ru˘
 *
xßve_hdr
;

264 i‡(!
˝u_has_xßve
)

265  -
ENODEV
;

267 
ªt
 = 
	`öô_Âu
(
èrgë
);

268 i‡(
ªt
)

269  
ªt
;

271 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

272 &
èrgë
->
thªad
.
Âu
.
°©e
->
xßve
, 0, -1);

277 
èrgë
->
thªad
.
Âu
.
°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

279 
xßve_hdr
 = &
èrgë
->
thªad
.
Âu
.
°©e
->
xßve
.xsave_hdr;

281 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

285 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

287  
ªt
;

288 
	}
}

290 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


296 
ölöe
 
	$twd_i387_to_fx§
(
twd
)

298 
tmp
;

301 
tmp
 = ~
twd
;

302 
tmp
 = (tmp | (tmp>>1)) & 0x5555;

304 
tmp
 = (tmp | (tmp >> 1)) & 0x3333;

305 
tmp
 = (tmp | (tmp >> 2)) & 0x0f0f;

306 
tmp
 = (tmp | (tmp >> 4)) & 0x00ff;

308  
tmp
;

309 
	}
}

311 
	#FPREG_ADDR
(
f
, 
n
Ë((*)&(f)->
°_•a˚
 + (nË* 16);

	)

312 
	#FP_EXP_TAG_VALID
 0

	)

313 
	#FP_EXP_TAG_ZERO
 1

	)

314 
	#FP_EXP_TAG_SPECIAL
 2

	)

315 
	#FP_EXP_TAG_EMPTY
 3

	)

317 
ölöe
 
u32
 
	$twd_fx§_to_i387
(
i387_fxßve_°ru˘
 *
fxßve
)

319 
_Âxªg
 *
°
;

320 
u32
 
tos
 = (
fxßve
->
swd
 >> 11) & 7;

321 
u32
 
twd
 = (Ë
fxßve
->twd;

322 
u32
 
èg
;

323 
u32
 
ªt
 = 0xffff0000u;

324 
i
;

326 
i
 = 0; i < 8; i++, 
twd
 >>= 1) {

327 i‡(
twd
 & 0x1) {

328 
°
 = 
	`FPREG_ADDR
(
fxßve
, (
i
 - 
tos
) & 7);

330 
°
->
exp⁄ít
 & 0x7fff) {

332 
èg
 = 
FP_EXP_TAG_SPECIAL
;

335 i‡(!
°
->
signifiˇnd
[0] &&

336 !
°
->
signifiˇnd
[1] &&

337 !
°
->
signifiˇnd
[2] &&

338 !
°
->
signifiˇnd
[3])

339 
èg
 = 
FP_EXP_TAG_ZERO
;

341 
èg
 = 
FP_EXP_TAG_SPECIAL
;

344 i‡(
°
->
signifiˇnd
[3] & 0x8000)

345 
èg
 = 
FP_EXP_TAG_VALID
;

347 
èg
 = 
FP_EXP_TAG_SPECIAL
;

351 
èg
 = 
FP_EXP_TAG_EMPTY
;

353 
ªt
 |
èg
 << (2 * 
i
);

355  
ªt
;

356 
	}
}

363 
	$c⁄vît_‰om_fx§
(
u£r_i387_ü32_°ru˘
 *
ív
, 
èsk_°ru˘
 *
tsk
)

365 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
Âu
.
°©e
->fxsave;

366 
_Âªg
 *
to
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

367 
_Âxªg
 *
‰om
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

368 
i
;

370 
ív
->
cwd
 = 
fxßve
->cwd | 0xffff0000u;

371 
ív
->
swd
 = 
fxßve
->swd | 0xffff0000u;

372 
ív
->
twd
 = 
	`twd_fx§_to_i387
(
fxßve
);

374 #ifde‡
CONFIG_X86_64


375 
ív
->
fù
 = 
fxßve
->
rù
;

376 
ív
->
foo
 = 
fxßve
->
rdp
;

377 i‡(
tsk
 =
cuºít
) {

382 
	`asm
("mov %%ds, %[fos]" : [
fos
] "Ù" (
ív
->fos));

383 
	`asm
("mov %%cs, %[fcs]" : [
fcs
] "Ù" (
ív
->fcs));

385 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

387 
ív
->
fos
 = 0xffff0000 | 
tsk
->
thªad
.
ds
;

388 
ív
->
fcs
 = 
ªgs
->
cs
;

391 
ív
->
fù
 = 
fxßve
->fip;

392 
ív
->
fcs
 = (
u16
Ë
fxßve
->fc†| ((
u32
Ëfxßve->
f›
 << 16);

393 
ív
->
foo
 = 
fxßve
->foo;

394 
ív
->
fos
 = 
fxßve
->fos;

397 
i
 = 0; i < 8; ++i)

398 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (to[0]));

399 
	}
}

401 
	$c⁄vît_to_fx§
(
èsk_°ru˘
 *
tsk
,

402 c⁄° 
u£r_i387_ü32_°ru˘
 *
ív
)

405 
i387_fxßve_°ru˘
 *
fxßve
 = &
tsk
->
thªad
.
Âu
.
°©e
->fxsave;

406 
_Âªg
 *
‰om
 = (_Âªg *Ë&
ív
->
°_•a˚
[0];

407 
_Âxªg
 *
to
 = (_Âxªg *Ë&
fxßve
->
°_•a˚
[0];

408 
i
;

410 
fxßve
->
cwd
 = 
ív
->cwd;

411 
fxßve
->
swd
 = 
ív
->swd;

412 
fxßve
->
twd
 = 
	`twd_i387_to_fx§
(
ív
->twd);

413 
fxßve
->
f›
 = (
u16
Ë((
u32
Ë
ív
->
fcs
 >> 16);

414 #ifde‡
CONFIG_X86_64


415 
fxßve
->
rù
 = 
ív
->
fù
;

416 
fxßve
->
rdp
 = 
ív
->
foo
;

419 
fxßve
->
fù
 = 
ív
->fip;

420 
fxßve
->
fcs
 = (
ív
->fcs & 0xffff);

421 
fxßve
->
foo
 = 
ív
->foo;

422 
fxßve
->
fos
 = 
ív
->fos;

425 
i
 = 0; i < 8; ++i)

426 
	`mem˝y
(&
to
[
i
], &
‰om
[i], (from[0]));

427 
	}
}

429 
	$Âªgs_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

430 
pos
, 
cou¡
,

431 *
kbuf
, 
__u£r
 *
ubuf
)

433 
u£r_i387_ü32_°ru˘
 
ív
;

434 
ªt
;

436 
ªt
 = 
	`öô_Âu
(
èrgë
);

437 i‡(
ªt
)

438  
ªt
;

440 i‡(!
HAVE_HWFP
)

441  
	`Âªgs_so·_gë
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

443 i‡(!
˝u_has_fx§
) {

444  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

445 &
èrgë
->
thªad
.
Âu
.
°©e
->
fßve
, 0,

449 i‡(
kbuf
 && 
pos
 =0 && 
cou¡
 =(
ív
)) {

450 
	`c⁄vît_‰om_fx§
(
kbuf
, 
èrgë
);

454 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

456  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

457 
	}
}

459 
	$Âªgs_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

460 
pos
, 
cou¡
,

461 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

463 
u£r_i387_ü32_°ru˘
 
ív
;

464 
ªt
;

466 
ªt
 = 
	`öô_Âu
(
èrgë
);

467 i‡(
ªt
)

468  
ªt
;

470 i‡(!
HAVE_HWFP
)

471  
	`Âªgs_so·_£t
(
èrgë
, 
ªg£t
, 
pos
, 
cou¡
, 
kbuf
, 
ubuf
);

473 i‡(!
˝u_has_fx§
) {

474  
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

475 &
èrgë
->
thªad
.
Âu
.
°©e
->
fßve
, 0, -1);

478 i‡(
pos
 > 0 || 
cou¡
 < (
ív
))

479 
	`c⁄vît_‰om_fx§
(&
ív
, 
èrgë
);

481 
ªt
 = 
	`u£r_ªg£t_c›yö
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
, &
ív
, 0, -1);

482 i‡(!
ªt
)

483 
	`c⁄vît_to_fx§
(
èrgë
, &
ív
);

489 i‡(
˝u_has_xßve
)

490 
èrgë
->
thªad
.
Âu
.
°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FP
;

491  
ªt
;

492 
	}
}

498 
ölöe
 
	$ßve_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

500 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

501 
i387_fßve_°ru˘
 *
Â
 = &
tsk
->
thªad
.
Âu
.
°©e
->
fßve
;

503 
Â
->
°©us
 = fp->
swd
;

504 i‡(
	`__c›y_to_u£r
(
buf
, 
Â
, (
i387_fßve_°ru˘
)))

507 
	}
}

509 
	$ßve_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

511 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

512 
i387_fxßve_°ru˘
 *
fx
 = &
tsk
->
thªad
.
Âu
.
°©e
->
fxßve
;

513 
u£r_i387_ü32_°ru˘
 
ív
;

514 
îr
 = 0;

516 
	`c⁄vît_‰om_fx§
(&
ív
, 
tsk
);

517 i‡(
	`__c›y_to_u£r
(
buf
, &
ív
, (env)))

520 
îr
 |
	`__put_u£r
(
fx
->
swd
, &
buf
->
°©us
);

521 
îr
 |
	`__put_u£r
(
X86_FXSR_MAGIC
, &
buf
->
magic
);

522 i‡(
îr
)

525 i‡(
	`__c›y_to_u£r
(&
buf
->
_fx§_ív
[0], 
fx
, 
x°©e_size
))

528 
	}
}

530 
	$ßve_i387_xßve
(
__u£r
 *
buf
)

532 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

533 
_Â°©e_ü32
 
__u£r
 *
fx
 = 
buf
;

534 
îr
 = 0;

547 
tsk
->
thªad
.
Âu
.
°©e
->
xßve
.
xßve_hdr
.
x°©e_bv
 |
XSTATE_FPSSE
;

549 i‡(
	`ßve_i387_fxßve
(
fx
) < 0)

552 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved_ü32
,

553 (
_Âx_sw_byãs
));

554 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

555 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_ü32_size


556 - 
FP_XSTATE_MAGIC2_SIZE
));

557 i‡(
îr
)

561 
	}
}

563 
	$ßve_i387_x°©e_ü32
(
__u£r
 *
buf
)

565 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

566 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

568 i‡(!
	`u£d_m©h
())

571 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_ü32_size
))

572  -
EACCES
;

577 
	`˛ór_u£d_m©h
();

579 i‡(!
HAVE_HWFP
) {

580  
	`Âªgs_so·_gë
(
cuºít
, 
NULL
,

581 0, (
u£r_i387_ü32_°ru˘
),

582 
NULL
, 
Â
) ? -1 : 1;

585 
	`u∆azy_Âu
(
tsk
);

587 i‡(
˝u_has_xßve
)

588  
	`ßve_i387_xßve
(
Â
);

589 i‡(
˝u_has_fx§
)

590  
	`ßve_i387_fxßve
(
Â
);

592  
	`ßve_i387_fßve
(
Â
);

593 
	}
}

595 
ölöe
 
	$ª°‹e_i387_fßve
(
_Â°©e_ü32
 
__u£r
 *
buf
)

597 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

599  
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
Âu
.
°©e
->
fßve
, 
buf
,

600 (
i387_fßve_°ru˘
));

601 
	}
}

603 
	$ª°‹e_i387_fxßve
(
_Â°©e_ü32
 
__u£r
 *
buf
,

604 
size
)

606 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

607 
u£r_i387_ü32_°ru˘
 
ív
;

608 
îr
;

610 
îr
 = 
	`__c›y_‰om_u£r
(&
tsk
->
thªad
.
Âu
.
°©e
->
fxßve
, &
buf
->
_fx§_ív
[0],

611 
size
);

613 
tsk
->
thªad
.
Âu
.
°©e
->
fxßve
.
mxc§
 &
mxc§_„©uª_mask
;

614 i‡(
îr
 || 
	`__c›y_‰om_u£r
(&
ív
, 
buf
, (env)))

616 
	`c⁄vît_to_fx§
(
tsk
, &
ív
);

619 
	}
}

621 
	$ª°‹e_i387_xßve
(
__u£r
 *
buf
)

623 
_Âx_sw_byãs
 
fx_sw_u£r
;

624 
_Â°©e_ü32
 
__u£r
 *
fx_u£r
 =

625 ((
_Â°©e_ü32
 
__u£r
 *Ë
buf
);

626 
i387_fxßve_°ru˘
 
__u£r
 *
fx
 =

627 (
i387_fxßve_°ru˘
 
__u£r
 *Ë&
fx_u£r
->
_fx§_ív
[0];

628 
xßve_hdr_°ru˘
 *
xßve_hdr
 =

629 &
cuºít
->
thªad
.
Âu
.
°©e
->
xßve
.
xßve_hdr
;

630 
u64
 
mask
;

631 
îr
;

633 i‡(
	`check_f‹_x°©e
(
fx
, 
buf
, &
fx_sw_u£r
))

634 
fx_⁄ly
;

636 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

638 
îr
 = 
	`ª°‹e_i387_fxßve
(
buf
, 
fx_sw_u£r
.
x°©e_size
);

640 
xßve_hdr
->
x°©e_bv
 &
p˙txt_mask
;

644 
xßve_hdr
->
ª£rved1
[0] = xsave_hdr->reserved1[1] = 0;

650 
mask
 = ~(
p˙txt_mask
 & ~mask);

651 
xßve_hdr
->
x°©e_bv
 &
mask
;

653  
îr
;

654 
fx_⁄ly
:

660 
xßve_hdr
->
x°©e_bv
 = 
XSTATE_FPSSE
;

661  
	`ª°‹e_i387_fxßve
(
buf
, (
i387_fxßve_°ru˘
));

662 
	}
}

664 
	$ª°‹e_i387_x°©e_ü32
(
__u£r
 *
buf
)

666 
îr
;

667 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

668 
_Â°©e_ü32
 
__u£r
 *
Â
 = (_Â°©e_ü32 __u£∏*Ë
buf
;

670 i‡(
HAVE_HWFP
)

671 
	`˛ór_Âu
(
tsk
);

673 i‡(!
buf
) {

674 i‡(
	`u£d_m©h
()) {

675 
	`˛ór_Âu
(
tsk
);

676 
	`˛ór_u£d_m©h
();

681 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_ü32_size
))

682  -
EACCES
;

684 i‡(!
	`u£d_m©h
()) {

685 
îr
 = 
	`öô_Âu
(
tsk
);

686 i‡(
îr
)

687  
îr
;

690 i‡(
HAVE_HWFP
) {

691 i‡(
˝u_has_xßve
)

692 
îr
 = 
	`ª°‹e_i387_xßve
(
buf
);

693 i‡(
˝u_has_fx§
)

694 
îr
 = 
	`ª°‹e_i387_fxßve
(
Â
, (

695 
i387_fxßve_°ru˘
));

697 
îr
 = 
	`ª°‹e_i387_fßve
(
Â
);

699 
îr
 = 
	`Âªgs_so·_£t
(
cuºít
, 
NULL
,

700 0, (
u£r_i387_ü32_°ru˘
),

701 
NULL
, 
Â
) != 0;

703 
	`£t_u£d_m©h
();

705  
îr
;

706 
	}
}

715 
	$dump_Âu
(
±_ªgs
 *
ªgs
, 
u£r_i387_°ru˘
 *
Âu
)

717 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

718 
ÂvÆid
;

720 
ÂvÆid
 = !!
	`u£d_m©h
();

721 i‡(
ÂvÆid
)

722 
ÂvÆid
 = !
	`Âªgs_gë
(
tsk
, 
NULL
,

723 0, (
u£r_i387_ü32_°ru˘
),

724 
Âu
, 
NULL
);

726  
ÂvÆid
;

727 
	}
}

728 
EXPORT_SYMBOL
(
dump_Âu
);

	@/cmpt816/linux/arch/x86/kernel/i8237.c

12 
	~<löux/öô.h
>

13 
	~<löux/sysdev.h
>

15 
	~<asm/dma.h
>

24 
	$i8237A_ªsume
(
sys_devi˚
 *
dev
)

26 
Êags
;

27 
i
;

29 
Êags
 = 
	`˛aim_dma_lock
();

31 
	`dma_outb
(0, 
DMA1_RESET_REG
);

32 
	`dma_outb
(0, 
DMA2_RESET_REG
);

34 
i
 = 0; i < 8; i++) {

35 
	`£t_dma_addr
(
i
, 0x000000);

37 
	`£t_dma_cou¡
(
i
, 1);

41 
	`íabÀ_dma
(4);

43 
	`ªÀa£_dma_lock
(
Êags
);

46 
	}
}

48 
	$i8237A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

51 
	}
}

53 
sysdev_˛ass
 
	gi8237_sysdev_˛ass
 = {

54 .
«me
 = "i8237",

55 .
	gsu•íd
 = 
i8237A_su•íd
,

56 .
	gªsume
 = 
i8237A_ªsume
,

59 
sys_devi˚
 
	gdevi˚_i8237A
 = {

60 .
id
 = 0,

61 .
	g˛s
 = &
i8237_sysdev_˛ass
,

64 
__öô
 
	$i8237A_öô_sysfs
()

66 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8237_sysdev_˛ass
);

67 i‡(!
îr‹
)

68 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8237A
);

69  
îr‹
;

70 
	}
}

71 
devi˚_öôˇŒ
(
i8237A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/i8253.c

5 
	~<löux/˛ockchùs.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/•ölock.h
>

8 
	~<löux/jiffõs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/io.h
>

15 
	~<asm/i8253.h
>

16 
	~<asm/h≥t.h
>

17 
	~<asm/smp.h
>

19 
DEFINE_RAW_SPINLOCK
(
i8253_lock
);

20 
EXPORT_SYMBOL
(
i8253_lock
);

26 
˛ock_evít_devi˚
 *
	gglobÆ_˛ock_evít
;

33 
	$öô_pô_timî
(
˛ock_evít_mode
 
mode
,

34 
˛ock_evít_devi˚
 *
evt
)

36 
	`øw_•ö_lock
(&
i8253_lock
);

38 
mode
) {

39 
CLOCK_EVT_MODE_PERIODIC
:

41 
	`outb_pô
(0x34, 
PIT_MODE
);

42 
	`outb_pô
(
LATCH
 & 0xf‡, 
PIT_CH0
);

43 
	`outb_pô
(
LATCH
 >> 8 , 
PIT_CH0
);

46 
CLOCK_EVT_MODE_SHUTDOWN
:

47 
CLOCK_EVT_MODE_UNUSED
:

48 i‡(
evt
->
mode
 =
CLOCK_EVT_MODE_PERIODIC
 ||

49 
evt
->
mode
 =
CLOCK_EVT_MODE_ONESHOT
) {

50 
	`outb_pô
(0x30, 
PIT_MODE
);

51 
	`outb_pô
(0, 
PIT_CH0
);

52 
	`outb_pô
(0, 
PIT_CH0
);

56 
CLOCK_EVT_MODE_ONESHOT
:

58 
	`outb_pô
(0x38, 
PIT_MODE
);

61 
CLOCK_EVT_MODE_RESUME
:

65 
	`øw_•ö_u∆ock
(&
i8253_lock
);

66 
	}
}

73 
	$pô_√xt_evít
(
dñè
, 
˛ock_evít_devi˚
 *
evt
)

75 
	`øw_•ö_lock
(&
i8253_lock
);

76 
	`outb_pô
(
dñè
 & 0xf‡, 
PIT_CH0
);

77 
	`outb_pô
(
dñè
 >> 8 , 
PIT_CH0
);

78 
	`øw_•ö_u∆ock
(&
i8253_lock
);

81 
	}
}

91 
˛ock_evít_devi˚
 
	gpô_˚
 = {

92 .
«me
 = "pit",

93 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

94 .
	g£t_mode
 = 
öô_pô_timî
,

95 .
	g£t_√xt_evít
 = 
pô_√xt_evít
,

96 .
	gshi·
 = 32,

97 .
	gúq
 = 0,

104 
__öô
 
	$£tup_pô_timî
()

110 
pô_˚
.
˝umask
 = 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
());

111 
pô_˚
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,Öô_˚.
shi·
);

112 
pô_˚
.
max_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0x7FFF, &pit_ce);

113 
pô_˚
.
mö_dñè_ns
 = 
	`˛ockevít_dñè2ns
(0xF, &pit_ce);

115 
	`˛ockevíts_ªgi°î_devi˚
(&
pô_˚
);

116 
globÆ_˛ock_evít
 = &
pô_˚
;

117 
	}
}

119 #i‚de‡
CONFIG_X86_64


125 
cy˛e_t
 
	$pô_ªad
(
˛ocksour˚
 *
cs
)

127 
ﬁd_cou¡
;

128 
u32
 
ﬁd_jifs
;

129 
Êags
;

130 
cou¡
;

131 
u32
 
jifs
;

133 
	`øw_•ö_lock_úqßve
(&
i8253_lock
, 
Êags
);

147 
jifs
 = 
jiffõs
;

148 
	`outb_pô
(0x00, 
PIT_MODE
);

149 
cou¡
 = 
	`öb_pô
(
PIT_CH0
);

150 
cou¡
 |
	`öb_pô
(
PIT_CH0
) << 8;

153 i‡(
cou¡
 > 
LATCH
) {

154 
	`outb_pô
(0x34, 
PIT_MODE
);

155 
	`outb_pô
(
LATCH
 & 0xff, 
PIT_CH0
);

156 
	`outb_pô
(
LATCH
 >> 8, 
PIT_CH0
);

157 
cou¡
 = 
LATCH
 - 1;

173 i‡(
cou¡
 > 
ﬁd_cou¡
 && 
jifs
 =
ﬁd_jifs
)

174 
cou¡
 = 
ﬁd_cou¡
;

176 
ﬁd_cou¡
 = 
cou¡
;

177 
ﬁd_jifs
 = 
jifs
;

179 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8253_lock
, 
Êags
);

181 
cou¡
 = (
LATCH
 - 1) - count;

183  (
cy˛e_t
)(
jifs
 * 
LATCH
Ë+ 
cou¡
;

184 
	}
}

186 
˛ocksour˚
 
	gpô_cs
 = {

187 .
«me
 = "pit",

188 .
	gøtög
 = 110,

189 .
	gªad
 = 
pô_ªad
,

190 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

191 .
	gmu…
 = 0,

192 .
	gshi·
 = 20,

195 
__öô
 
	$öô_pô_˛ocksour˚
()

204 i‡(
	`num_possibÀ_˝us
(Ë> 1 || 
	`is_h≥t_íabÀd
() ||

205 
pô_˚
.
mode
 !
CLOCK_EVT_MODE_PERIODIC
)

208 
pô_cs
.
mu…
 = 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
,Öô_cs.
shi·
);

210  
	`˛ocksour˚_ªgi°î
(&
pô_cs
);

211 
	}
}

212 
¨ch_öôˇŒ
(
öô_pô_˛ocksour˚
);

	@/cmpt816/linux/arch/x86/kernel/i8259.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/øndom.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/kî√l_°©.h
>

11 
	~<löux/sysdev.h
>

12 
	~<löux/bô›s.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/io.h
>

15 
	~<löux/dñay.h
>

17 
	~<asm/©omic.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/timî.h
>

20 
	~<asm/hw_úq.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/desc.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/i8259.h
>

33 
	gi8259A_auto_eoi
;

34 
DEFINE_RAW_SPINLOCK
(
i8259A_lock
);

35 
mask_™d_ack_8259A
();

36 
mask_8259A
();

37 
unmask_8259A
();

38 
dißbÀ_8259A_úq
(
úq
);

39 
íabÀ_8259A_úq
(
úq
);

40 
öô_8259A
(
auto_eoi
);

41 
i8259A_úq_≥ndög
(
úq
);

43 
úq_chù
 
	gi8259A_chù
 = {

44 .
«me
 = "XT-PIC",

45 .
	gmask
 = 
dißbÀ_8259A_úq
,

46 .
	gdißbÀ
 = 
dißbÀ_8259A_úq
,

47 .
	gunmask
 = 
íabÀ_8259A_úq
,

48 .
	gmask_ack
 = 
mask_™d_ack_8259A
,

58 
	gˇched_úq_mask
 = 0xffff;

69 
	gio_≠ic_úqs
;

71 
	$dißbÀ_8259A_úq
(
úq
)

73 
mask
 = 1 << 
úq
;

74 
Êags
;

76 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

77 
ˇched_úq_mask
 |
mask
;

78 i‡(
úq
 & 8)

79 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

81 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

82 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

83 
	}
}

85 
	$íabÀ_8259A_úq
(
úq
)

87 
mask
 = ~(1 << 
úq
);

88 
Êags
;

90 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

91 
ˇched_úq_mask
 &
mask
;

92 i‡(
úq
 & 8)

93 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

95 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

96 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

97 
	}
}

99 
	$i8259A_úq_≥ndög
(
úq
)

101 
mask
 = 1<<
úq
;

102 
Êags
;

103 
ªt
;

105 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

106 i‡(
úq
 < 8)

107 
ªt
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
mask
;

109 
ªt
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
mask
 >> 8);

110 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

112  
ªt
;

113 
	}
}

115 
	$make_8259A_úq
(
úq
)

117 
	`dißbÀ_úq_nosync
(
úq
);

118 
io_≠ic_úqs
 &~(1<<
úq
);

119 
	`£t_úq_chù_™d_h™dÀr_«me
(
úq
, &
i8259A_chù
, 
h™dÀ_Àvñ_úq
,

121 
	`íabÀ_úq
(
úq
);

122 
	}
}

130 
ölöe
 
	$i8259A_úq_ªÆ
(
úq
)

132 
vÆue
;

133 
úqmask
 = 1<<
úq
;

135 i‡(
úq
 < 8) {

136 
	`outb
(0x0B, 
PIC_MASTER_CMD
);

137 
vÆue
 = 
	`öb
(
PIC_MASTER_CMD
Ë& 
úqmask
;

138 
	`outb
(0x0A, 
PIC_MASTER_CMD
);

139  
vÆue
;

141 
	`outb
(0x0B, 
PIC_SLAVE_CMD
);

142 
vÆue
 = 
	`öb
(
PIC_SLAVE_CMD
Ë& (
úqmask
 >> 8);

143 
	`outb
(0x0A, 
PIC_SLAVE_CMD
);

144  
vÆue
;

145 
	}
}

153 
	$mask_™d_ack_8259A
(
úq
)

155 
úqmask
 = 1 << 
úq
;

156 
Êags
;

158 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

174 i‡(
ˇched_úq_mask
 & 
úqmask
)

175 
•urious_8259A_úq
;

176 
ˇched_úq_mask
 |
úqmask
;

178 
h™dÀ_ªÆ_úq
:

179 i‡(
úq
 & 8) {

180 
	`öb
(
PIC_SLAVE_IMR
);

181 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

183 
	`outb
(0x60+(
úq
&7), 
PIC_SLAVE_CMD
);

185 
	`outb
(0x60+
PIC_CASCADE_IR
, 
PIC_MASTER_CMD
);

187 
	`öb
(
PIC_MASTER_IMR
);

188 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

189 
	`outb
(0x60+
úq
, 
PIC_MASTER_CMD
);

191 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

194 
•urious_8259A_úq
:

198 i‡(
	`i8259A_úq_ªÆ
(
úq
))

203 
h™dÀ_ªÆ_úq
;

206 
•urious_úq_mask
;

211 i‡(!(
•urious_úq_mask
 & 
úqmask
)) {

212 
	`¥ötk
(
KERN_DEBUG


213 "•uriou†8259A i¡îru±: IRQ%d.\n", 
úq
);

214 
•urious_úq_mask
 |
úqmask
;

216 
	`©omic_öc
(&
úq_îr_cou¡
);

222 
h™dÀ_ªÆ_úq
;

224 
	}
}

226 
	gúq_åiggî
[2];

230 
	$ª°‹e_ELCR
(*
åiggî
)

232 
	`outb
(
åiggî
[0], 0x4d0);

233 
	`outb
(
åiggî
[1], 0x4d1);

234 
	}
}

236 
	$ßve_ELCR
(*
åiggî
)

239 
åiggî
[0] = 
	`öb
(0x4d0) & 0xF8;

240 
åiggî
[1] = 
	`öb
(0x4d1) & 0xDE;

241 
	}
}

243 
	$i8259A_ªsume
(
sys_devi˚
 *
dev
)

245 
	`öô_8259A
(
i8259A_auto_eoi
);

246 
	`ª°‹e_ELCR
(
úq_åiggî
);

248 
	}
}

250 
	$i8259A_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

252 
	`ßve_ELCR
(
úq_åiggî
);

254 
	}
}

256 
	$i8259A_shutdown
(
sys_devi˚
 *
dev
)

262 
	`outb
(0xff, 
PIC_MASTER_IMR
);

263 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

265 
	}
}

267 
sysdev_˛ass
 
	gi8259_sysdev_˛ass
 = {

268 .
«me
 = "i8259",

269 .
	gsu•íd
 = 
i8259A_su•íd
,

270 .
	gªsume
 = 
i8259A_ªsume
,

271 .
	gshutdown
 = 
i8259A_shutdown
,

274 
sys_devi˚
 
	gdevi˚_i8259A
 = {

275 .
id
 = 0,

276 .
	g˛s
 = &
i8259_sysdev_˛ass
,

279 
	$mask_8259A
()

281 
Êags
;

283 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

285 
	`outb
(0xff, 
PIC_MASTER_IMR
);

286 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

288 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

289 
	}
}

291 
	$unmask_8259A
()

293 
Êags
;

295 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

297 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

298 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

300 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

301 
	}
}

303 
	$öô_8259A
(
auto_eoi
)

305 
Êags
;

307 
i8259A_auto_eoi
 = 
auto_eoi
;

309 
	`øw_•ö_lock_úqßve
(&
i8259A_lock
, 
Êags
);

311 
	`outb
(0xff, 
PIC_MASTER_IMR
);

312 
	`outb
(0xff, 
PIC_SLAVE_IMR
);

317 
	`outb_pic
(0x11, 
PIC_MASTER_CMD
);

321 
	`outb_pic
(
IRQ0_VECTOR
, 
PIC_MASTER_IMR
);

324 
	`outb_pic
(1U << 
PIC_CASCADE_IR
, 
PIC_MASTER_IMR
);

326 i‡(
auto_eoi
)

327 
	`outb_pic
(
MASTER_ICW4_DEFAULT
 | 
PIC_ICW4_AEOI
, 
PIC_MASTER_IMR
);

329 
	`outb_pic
(
MASTER_ICW4_DEFAULT
, 
PIC_MASTER_IMR
);

331 
	`outb_pic
(0x11, 
PIC_SLAVE_CMD
);

334 
	`outb_pic
(
IRQ8_VECTOR
, 
PIC_SLAVE_IMR
);

336 
	`outb_pic
(
PIC_CASCADE_IR
, 
PIC_SLAVE_IMR
);

338 
	`outb_pic
(
SLAVE_ICW4_DEFAULT
, 
PIC_SLAVE_IMR
);

340 i‡(
auto_eoi
)

345 
i8259A_chù
.
mask_ack
 = 
dißbÀ_8259A_úq
;

347 
i8259A_chù
.
mask_ack
 = 
mask_™d_ack_8259A
;

349 
	`udñay
(100);

351 
	`outb
(
ˇched_ma°î_mask
, 
PIC_MASTER_IMR
);

352 
	`outb
(
ˇched_¶ave_mask
, 
PIC_SLAVE_IMR
);

354 
	`øw_•ö_u∆ock_úqª°‹e
(&
i8259A_lock
, 
Êags
);

355 
	}
}

363 
	$Àgacy_pic_no›
(Ë{ 
	}
};

364 
	$Àgacy_pic_uöt_no›
(
unu£d
Ë{ 
	}
};

365 
	$Àgacy_pic_öt_no›
(
unu£d
Ë{ 
	}
};

367 
úq_chù
 
	gdummy_pic_chù
 = {

368 .
«me
 = "dummyÖic",

369 .
	gmask
 = 
Àgacy_pic_uöt_no›
,

370 .
	gunmask
 = 
Àgacy_pic_uöt_no›
,

371 .
	gdißbÀ
 = 
Àgacy_pic_uöt_no›
,

372 .
	gmask_ack
 = 
Àgacy_pic_uöt_no›
,

374 
	$Àgacy_pic_úq_≥ndög_no›
(
úq
)

377 
	}
}

379 
Àgacy_pic
 
	gnuŒ_Àgacy_pic
 = {

380 .
ƒ_Àgacy_úqs
 = 0,

381 .
	gchù
 = &
dummy_pic_chù
,

382 .
	gmask_Æl
 = 
Àgacy_pic_no›
,

383 .
	gª°‹e_mask
 = 
Àgacy_pic_no›
,

384 .
	göô
 = 
Àgacy_pic_öt_no›
,

385 .
	gúq_≥ndög
 = 
Àgacy_pic_úq_≥ndög_no›
,

386 .
	gmake_úq
 = 
Àgacy_pic_uöt_no›
,

389 
Àgacy_pic
 
	gdeÁu…_Àgacy_pic
 = {

390 .
ƒ_Àgacy_úqs
 = 
NR_IRQS_LEGACY
,

391 .
	gchù
 = &
i8259A_chù
,

392 .
	gmask_Æl
 = 
mask_8259A
,

393 .
	gª°‹e_mask
 = 
unmask_8259A
,

394 .
	göô
 = 
öô_8259A
,

395 .
	gúq_≥ndög
 = 
i8259A_úq_≥ndög
,

396 .
	gmake_úq
 = 
make_8259A_úq
,

399 
Àgacy_pic
 *
	gÀgacy_pic
 = &
deÁu…_Àgacy_pic
;

401 
__öô
 
	$i8259A_öô_sysfs
()

403 
îr‹
;

405 i‡(
Àgacy_pic
 !&
deÁu…_Àgacy_pic
)

408 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
i8259_sysdev_˛ass
);

409 i‡(!
îr‹
)

410 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_i8259A
);

411  
îr‹
;

412 
	}
}

414 
devi˚_öôˇŒ
(
i8259A_öô_sysfs
);

	@/cmpt816/linux/arch/x86/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

9 
	~<asm/uac˚ss.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/desc.h
>

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

23 
thªad_uni⁄
 
öô_thªad_uni⁄
 
	g__öô_èsk_d©a
 =

24 { 
INIT_THREAD_INFO
(
öô_èsk
) };

31 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

32 
EXPORT_SYMBOL
(
öô_èsk
);

41 
DEFINE_PER_CPU_SHARED_ALIGNED
(
tss_°ru˘
, 
öô_tss
Ë
INIT_TSS
;

	@/cmpt816/linux/arch/x86/kernel/io_delay.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/io.h
>

15 
io_dñay_ty≥
 
	g__ªad_mo°ly
 = 
CONFIG_DEFAULT_IO_DELAY_TYPE
;

17 
__öôd©a
 
	gio_dñay_ovîride
;

22 
	$«tive_io_dñay
()

24 
io_dñay_ty≥
) {

26 
CONFIG_IO_DELAY_TYPE_0X80
:

27 
asm
 volatile ("outb %al, $0x80");

29 
CONFIG_IO_DELAY_TYPE_0XED
:

30 
asm
 volatile ("outb %al, $0xed");

32 
CONFIG_IO_DELAY_TYPE_UDELAY
:

40 
	`udñay
(2);

41 
CONFIG_IO_DELAY_TYPE_NONE
:

44 
	}
}

45 
EXPORT_SYMBOL
(
«tive_io_dñay
);

47 
__öô
 
	$dmi_io_dñay_0xed_p‹t
(c⁄° 
dmi_sy°em_id
 *
id
)

49 i‡(
io_dñay_ty≥
 =
CONFIG_IO_DELAY_TYPE_0X80
) {

50 
	`¥_nŸi˚
("%s: usög 0xed I/O dñayÖ‹t\n", 
id
->
idít
);

51 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

55 
	}
}

61 
dmi_sy°em_id
 
__öôd©a
 
	gio_dñay_0xed_p‹t_dmi_èbÀ
[] = {

63 .
ˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

64 .
	gidít
 = "Compaq Presario V6000",

65 .
	gm©ches
 = {

66 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

67 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

71 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

72 .
	gidít
 = "HP Pavilion dv9000z",

73 .
	gm©ches
 = {

74 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

75 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

79 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

80 .
	gidít
 = "HP Pavilion dv6000",

81 .
	gm©ches
 = {

82 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

83 
DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

87 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

88 .
	gidít
 = "HP PavilionÅx1000",

89 .
	gm©ches
 = {

90 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

91 
DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

95 .
	gˇŒback
 = 
dmi_io_dñay_0xed_p‹t
,

96 .
	gidít
 = "Presario F700",

97 .
	gm©ches
 = {

98 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

99 
DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

105 
__öô
 
	$io_dñay_öô
()

107 i‡(!
io_dñay_ovîride
)

108 
	`dmi_check_sy°em
(
io_dñay_0xed_p‹t_dmi_èbÀ
);

109 
	}
}

111 
__öô
 
	$io_dñay_∑øm
(*
s
)

113 i‡(!
s
)

114  -
EINVAL
;

116 i‡(!
	`°rcmp
(
s
, "0x80"))

117 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0X80
;

118 i‡(!
	`°rcmp
(
s
, "0xed"))

119 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_0XED
;

120 i‡(!
	`°rcmp
(
s
, "udelay"))

121 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_UDELAY
;

122 i‡(!
	`°rcmp
(
s
, "none"))

123 
io_dñay_ty≥
 = 
CONFIG_IO_DELAY_TYPE_NONE
;

125  -
EINVAL
;

127 
io_dñay_ovîride
 = 1;

129 
	}
}

131 
óæy_∑øm
("io_dñay", 
io_dñay_∑øm
);

	@/cmpt816/linux/arch/x86/kernel/ioport.c

6 
	~<löux/sched.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/ˇ∑bûôy.h
>

9 
	~<löux/î∫o.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/i›‹t.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/°ddef.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/thªad_öfo.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<asm/sysˇŒs.h
>

20 
	$£t_bôm≠
(*
bôm≠
, 
ba£
,

21 
exã¡
, 
√w_vÆue
)

23 
i
;

25 
i
 = 
ba£
; i < ba£ + 
exã¡
; i++) {

26 i‡(
√w_vÆue
)

27 
	`__£t_bô
(
i
, 
bôm≠
);

29 
	`__˛ór_bô
(
i
, 
bôm≠
);

31 
	}
}

36 
asmlökage
 
	$sys_i›îm
(
‰om
, 
num
, 
tu∫_⁄
)

38 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

39 
tss_°ru˘
 *
tss
;

40 
i
, 
max_l⁄g
, 
byãs
, 
byãs_upd©ed
;

42 i‡((
‰om
 + 
num
 <‰omË|| (‰om +Çum > 
IO_BITMAP_BITS
))

43  -
EINVAL
;

44 i‡(
tu∫_⁄
 && !
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

45  -
EPERM
;

52 i‡(!
t
->
io_bôm≠_±r
) {

53 *
bôm≠
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

55 i‡(!
bôm≠
)

56  -
ENOMEM
;

58 
	`mem£t
(
bôm≠
, 0xff, 
IO_BITMAP_BYTES
);

59 
t
->
io_bôm≠_±r
 = 
bôm≠
;

60 
	`£t_thªad_Êag
(
TIF_IO_BITMAP
);

70 
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

72 
	`£t_bôm≠
(
t
->
io_bôm≠_±r
, 
‰om
, 
num
, !
tu∫_⁄
);

78 
max_l⁄g
 = 0;

79 
i
 = 0; i < 
IO_BITMAP_LONGS
; i++)

80 i‡(
t
->
io_bôm≠_±r
[
i
] != ~0UL)

81 
max_l⁄g
 = 
i
;

83 
byãs
 = (
max_l⁄g
 + 1) * ();

84 
byãs_upd©ed
 = 
	`max
(
byãs
, 
t
->
io_bôm≠_max
);

86 
t
->
io_bôm≠_max
 = 
byãs
;

89 
	`mem˝y
(
tss
->
io_bôm≠
, 
t
->
io_bôm≠_±r
, 
byãs_upd©ed
);

91 
	`put_˝u
();

94 
	}
}

106 
	$sys_i›l
(
Àvñ
, 
±_ªgs
 *
ªgs
)

108 
ﬁd
 = (
ªgs
->
Êags
 >> 12) & 3;

109 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

111 i‡(
Àvñ
 > 3)

112  -
EINVAL
;

114 i‡(
Àvñ
 > 
ﬁd
) {

115 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
))

116  -
EPERM
;

118 
ªgs
->
Êags
 = (ªgs->Êag†& ~
X86_EFLAGS_IOPL
Ë| (
Àvñ
 << 12);

119 
t
->
i›l
 = 
Àvñ
 << 12;

120 
	`£t_i›l_mask
(
t
->
i›l
);

123 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq.c

4 
	~<löux/˝u.h
>

5 
	~<löux/öãºu±.h
>

6 
	~<löux/kî√l_°©.h
>

7 
	~<löux/£q_fûe.h
>

8 
	~<löux/smp.h
>

9 
	~<löux/·ø˚.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/io_≠ic.h
>

13 
	~<asm/úq.h
>

14 
	~<asm/idÀ.h
>

15 
	~<asm/m˚.h
>

16 
	~<asm/hw_úq.h
>

18 
©omic_t
 
	gúq_îr_cou¡
;

21 (*
x86_∂©f‹m_ùi_ˇŒback
)(Ë
NULL
;

27 
	$ack_bad_úq
(
úq
)

29 i‡(
	`¥ötk_øãlimô
())

30 
	`¥_îr
("u√x≥˘ed IRQÅø∞© ve˘‹ %02x\n", 
úq
);

41 
	`ack_APIC_úq
();

42 
	}
}

44 
	#úq_°©s
(
x
Ë(&
	`≥r_˝u
(
úq_°©
, x))

	)

48 
	$show_Ÿhî_öãºu±s
(
£q_fûe
 *
p
, 
¥ec
)

50 
j
;

52 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "NMI");

53 
	`f‹_óch_⁄löe_˝u
(
j
)

54 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
__nmi_cou¡
);

55 
	`£q_¥ötf
(
p
, " Non-maskable interrupts\n");

56 #ifde‡
CONFIG_X86_LOCAL_APIC


57 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "LOC");

58 
	`f‹_óch_⁄löe_˝u
(
j
)

59 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_timî_úqs
);

60 
	`£q_¥ötf
(
p
, " LocalÅimer interrupts\n");

62 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "SPU");

63 
	`f‹_óch_⁄löe_˝u
(
j
)

64 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_•urious_cou¡
);

65 
	`£q_¥ötf
(
p
, " Spurious interrupts\n");

66 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PMI");

67 
	`f‹_óch_⁄löe_˝u
(
j
)

68 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥rf_úqs
);

69 
	`£q_¥ötf
(
p
, " Performance monitoring interrupts\n");

70 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PND");

71 
	`f‹_óch_⁄löe_˝u
(
j
)

72 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
≠ic_≥ndög_úqs
);

73 
	`£q_¥ötf
(
p
, " PerformanceÖending work\n");

75 i‡(
x86_∂©f‹m_ùi_ˇŒback
) {

76 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "PLT");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
x86_∂©f‹m_ùis
);

79 
	`£q_¥ötf
(
p
, " Platform interrupts\n");

81 #ifde‡
CONFIG_SMP


82 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "RES");

83 
	`f‹_óch_⁄löe_˝u
(
j
)

84 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ªsched_cou¡
);

85 
	`£q_¥ötf
(
p
, " Rescheduling interrupts\n");

86 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "CAL");

87 
	`f‹_óch_⁄löe_˝u
(
j
)

88 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_ˇŒ_cou¡
);

89 
	`£q_¥ötf
(
p
, " Function call interrupts\n");

90 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TLB");

91 
	`f‹_óch_⁄löe_˝u
(
j
)

92 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_éb_cou¡
);

93 
	`£q_¥ötf
(
p
, " TLB shootdowns\n");

95 #ifde‡
CONFIG_X86_THERMAL_VECTOR


96 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "TRM");

97 
	`f‹_óch_⁄löe_˝u
(
j
)

98 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thîmÆ_cou¡
);

99 
	`£q_¥ötf
(
p
, " ThermalÉvent interrupts\n");

101 #ifde‡
CONFIG_X86_MCE_THRESHOLD


102 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "THR");

103 
	`f‹_óch_⁄löe_˝u
(
j
)

104 
	`£q_¥ötf
(
p
, "%10u ", 
	`úq_°©s
(
j
)->
úq_thªshﬁd_cou¡
);

105 
	`£q_¥ötf
(
p
, " Threshold APIC interrupts\n");

107 #ifde‡
CONFIG_X86_MCE


108 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCE");

109 
	`f‹_óch_⁄löe_˝u
(
j
)

110 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
j
));

111 
	`£q_¥ötf
(
p
, " Machine checkÉxceptions\n");

112 
	`£q_¥ötf
(
p
, "%*s: ", 
¥ec
, "MCP");

113 
	`f‹_óch_⁄löe_˝u
(
j
)

114 
	`£q_¥ötf
(
p
, "%10u ", 
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
j
));

115 
	`£q_¥ötf
(
p
, " Machine checkÖolls\n");

117 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "ERR", 
	`©omic_ªad
(&
úq_îr_cou¡
));

118 #i‡
	`deföed
(
CONFIG_X86_IO_APIC
)

119 
	`£q_¥ötf
(
p
, "%*s: %10u\n", 
¥ec
, "MIS", 
	`©omic_ªad
(&
úq_mis_cou¡
));

122 
	}
}

124 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

126 
Êags
, 
™y_cou¡
 = 0;

127 
i
 = *(
loff_t
 *Ë
v
, 
j
, 
¥ec
;

128 
úqa˘i⁄
 *
a˘i⁄
;

129 
úq_desc
 *
desc
;

131 i‡(
i
 > 
ƒ_úqs
)

134 
¥ec
 = 3, 
j
 = 1000;Öª¯< 10 && j <
ƒ_úqs
; ++prec)

135 
j
 *= 10;

137 i‡(
i
 =
ƒ_úqs
)

138  
	`show_Ÿhî_öãºu±s
(
p
, 
¥ec
);

141 i‡(
i
 == 0) {

142 
	`£q_¥ötf
(
p
, "%*s", 
¥ec
 + 8, "");

143 
	`f‹_óch_⁄löe_˝u
(
j
)

144 
	`£q_¥ötf
(
p
, "CPU%-8d", 
j
);

145 
	`£q_putc
(
p
, '\n');

148 
desc
 = 
	`úq_to_desc
(
i
);

149 i‡(!
desc
)

152 
	`øw_•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

153 
	`f‹_óch_⁄löe_˝u
(
j
)

154 
™y_cou¡
 |
	`k°©_úqs_˝u
(
i
, 
j
);

155 
a˘i⁄
 = 
desc
->action;

156 i‡(!
a˘i⁄
 && !
™y_cou¡
)

157 
out
;

159 
	`£q_¥ötf
(
p
, "%*d: ", 
¥ec
, 
i
);

160 
	`f‹_óch_⁄löe_˝u
(
j
)

161 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs_˝u
(
i
, 
j
));

162 
	`£q_¥ötf
(
p
, " %8s", 
desc
->
chù
->
«me
);

163 
	`£q_¥ötf
(
p
, "-%-8s", 
desc
->
«me
);

165 i‡(
a˘i⁄
) {

166 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

167 (
a˘i⁄
 =á˘i⁄->
√xt
Ë!
NULL
)

168 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

171 
	`£q_putc
(
p
, '\n');

172 
out
:

173 
	`øw_•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

175 
	}
}

180 
u64
 
	$¨ch_úq_°©_˝u
(
˝u
)

182 
u64
 
sum
 = 
	`úq_°©s
(
˝u
)->
__nmi_cou¡
;

184 #ifde‡
CONFIG_X86_LOCAL_APIC


185 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_timî_úqs
;

186 
sum
 +
	`úq_°©s
(
˝u
)->
úq_•urious_cou¡
;

187 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥rf_úqs
;

188 
sum
 +
	`úq_°©s
(
˝u
)->
≠ic_≥ndög_úqs
;

190 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

191 
sum
 +
	`úq_°©s
(
˝u
)->
x86_∂©f‹m_ùis
;

192 #ifde‡
CONFIG_SMP


193 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ªsched_cou¡
;

194 
sum
 +
	`úq_°©s
(
˝u
)->
úq_ˇŒ_cou¡
;

195 
sum
 +
	`úq_°©s
(
˝u
)->
úq_éb_cou¡
;

197 #ifde‡
CONFIG_X86_THERMAL_VECTOR


198 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thîmÆ_cou¡
;

200 #ifde‡
CONFIG_X86_MCE_THRESHOLD


201 
sum
 +
	`úq_°©s
(
˝u
)->
úq_thªshﬁd_cou¡
;

203 #ifde‡
CONFIG_X86_MCE


204 
sum
 +
	`≥r_˝u
(
m˚_ex˚±i⁄_cou¡
, 
˝u
);

205 
sum
 +
	`≥r_˝u
(
m˚_pﬁl_cou¡
, 
˝u
);

207  
sum
;

208 
	}
}

210 
u64
 
	$¨ch_úq_°©
()

212 
u64
 
sum
 = 
	`©omic_ªad
(&
úq_îr_cou¡
);

214 #ifde‡
CONFIG_X86_IO_APIC


215 
sum
 +
	`©omic_ªad
(&
úq_mis_cou¡
);

217  
sum
;

218 
	}
}

226 
__úq_íåy
 
	$do_IRQ
(
±_ªgs
 *
ªgs
)

228 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

231 
ve˘‹
 = ~
ªgs
->
‹ig_ax
;

232 
úq
;

234 
	`exô_idÀ
();

235 
	`úq_íãr
();

237 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

239 i‡(!
	`h™dÀ_úq
(
úq
, 
ªgs
)) {

240 
	`ack_APIC_úq
();

242 i‡(
	`¥ötk_øãlimô
())

243 
	`¥_emîg
("%s: %d.%d No irq handler for vector (irq %d)\n",

244 
__func__
, 
	`smp_¥o˚ss‹_id
(), 
ve˘‹
, 
úq
);

247 
	`úq_exô
();

249 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

251 
	}
}

256 
	$smp_x86_∂©f‹m_ùi
(
±_ªgs
 *
ªgs
)

258 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

260 
	`ack_APIC_úq
();

262 
	`exô_idÀ
();

264 
	`úq_íãr
();

266 
	`öc_úq_°©
(
x86_∂©f‹m_ùis
);

268 i‡(
x86_∂©f‹m_ùi_ˇŒback
)

269 
	`x86_∂©f‹m_ùi_ˇŒback
();

271 
	`úq_exô
();

273 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

274 
	}
}

276 
EXPORT_SYMBOL_GPL
(
ve˘‹_u£d_by_≥r˝u_úq
);

278 #ifde‡
CONFIG_HOTPLUG_CPU


280 
	$fixup_úqs
()

282 
úq
, 
ve˘‹
;

283 
w¨√d
;

284 
úq_desc
 *
desc
;

286 
	`f‹_óch_úq_desc
(
úq
, 
desc
) {

287 
bªak_afföôy
 = 0;

288 
£t_afföôy
 = 1;

289 c⁄° 
˝umask
 *
afföôy
;

291 i‡(!
desc
)

293 i‡(
úq
 == 2)

297 
	`øw_•ö_lock
(&
desc
->
lock
);

299 
afföôy
 = 
desc
->affinity;

300 i‡(!
	`úq_has_a˘i⁄
(
úq
) ||

301 
	`˝umask_equÆ
(
afföôy
, 
˝u_⁄löe_mask
)) {

302 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

311 
	`úq_f‹˚_com∂ëe_move
(
úq
);

313 i‡(
	`˝umask_™y_™d
(
afföôy
, 
˝u_⁄löe_mask
Ë>
ƒ_˝u_ids
) {

314 
bªak_afföôy
 = 1;

315 
afföôy
 = 
˝u_Æl_mask
;

318 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
mask
)

319 
desc
->
chù
->
	`mask
(
úq
);

321 i‡(
desc
->
chù
->
£t_afföôy
)

322 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
afföôy
);

323 i‡(!(
w¨√d
++))

324 
£t_afföôy
 = 0;

326 i‡(!(
desc
->
°©us
 & 
IRQ_MOVE_PCNTXT
Ë&& desc->
chù
->
unmask
)

327 
desc
->
chù
->
	`unmask
(
úq
);

329 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

331 i‡(
bªak_afföôy
 && 
£t_afföôy
)

332 
	`¥ötk
("Brokêafföôy f‹ irq %i\n", 
úq
);

333 i‡(!
£t_afföôy
)

334 
	`¥ötk
("C™nŸ sëáfföôy f‹ irq %i\n", 
úq
);

346 
	`mdñay
(1);

348 
ve˘‹
 = 
FIRST_EXTERNAL_VECTOR
; ve˘‹ < 
NR_VECTORS
; vector++) {

349 
úr
;

351 i‡(
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
] < 0)

354 
úr
 = 
	`≠ic_ªad
(
APIC_IRR
 + (
ve˘‹
 / 32 * 0x10));

355 i‡(
úr
 & (1 << (
ve˘‹
 % 32))) {

356 
úq
 = 
	`__gë_˝u_v¨
(
ve˘‹_úq
)[
ve˘‹
];

358 
desc
 = 
	`úq_to_desc
(
úq
);

359 
	`øw_•ö_lock
(&
desc
->
lock
);

360 i‡(
desc
->
chù
->
ªåiggî
)

361 
desc
->
chù
->
	`ªåiggî
(
úq
);

362 
	`øw_•ö_u∆ock
(&
desc
->
lock
);

365 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irq_64.c

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/·ø˚.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/smp.h
>

19 
	~<asm/io_≠ic.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/≠ic.h
>

23 
DEFINE_PER_CPU_SHARED_ALIGNED
(
úq_˝u°©_t
, 
úq_°©
);

24 
EXPORT_PER_CPU_SYMBOL
(
úq_°©
);

26 
DEFINE_PER_CPU
(
±_ªgs
 *, 
úq_ªgs
);

27 
EXPORT_PER_CPU_SYMBOL
(
úq_ªgs
);

36 
ölöe
 
	$°ack_ovîÊow_check
(
±_ªgs
 *
ªgs
)

38 #ifde‡
CONFIG_DEBUG_STACKOVERFLOW


39 
u64
 
curba£
 = (u64)
	`èsk_°ack_∑ge
(
cuºít
);

41 
	`WARN_ONCE
(
ªgs
->
•
 >
curba£
 &&

42 
ªgs
->
•
 <
curba£
 + 
THREAD_SIZE
 &&

43 
ªgs
->
•
 < 
curba£
 + (
thªad_öfo
) +

44 (
±_ªgs
) + 128,

47 
cuºít
->
comm
, 
curba£
, 
ªgs
->
•
);

49 
	}
}

51 
boﬁ
 
	$h™dÀ_úq
(
úq
, 
±_ªgs
 *
ªgs
)

53 
úq_desc
 *
desc
;

55 
	`°ack_ovîÊow_check
(
ªgs
);

57 
desc
 = 
	`úq_to_desc
(
úq
);

58 i‡(
	`u∆ikñy
(!
desc
))

59  
Ál£
;

61 
	`gíîic_h™dÀ_úq_desc
(
úq
, 
desc
);

62  
åue
;

63 
	}
}

66 
ˇŒ_so·úq
();

68 
asmlökage
 
	$do_so·úq
()

70 
__u32
 
≥ndög
;

71 
Êags
;

73 i‡(
	`ö_öãºu±
())

76 
	`loˇl_úq_ßve
(
Êags
);

77 
≥ndög
 = 
	`loˇl_so·úq_≥ndög
();

79 i‡(
≥ndög
) {

80 
	`ˇŒ_so·úq
();

81 
	`WARN_ON_ONCE
(
	`so·úq_cou¡
());

83 
	`loˇl_úq_ª°‹e
(
Êags
);

84 
	}
}

	@/cmpt816/linux/arch/x86/kernel/irqinit.c

1 
	~<löux/lökage.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sig«l.h
>

4 
	~<löux/sched.h
>

5 
	~<löux/i›‹t.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/timex.h
>

8 
	~<löux/øndom.h
>

9 
	~<löux/k¥obes.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kî√l_°©.h
>

12 
	~<löux/sysdev.h
>

13 
	~<löux/bô›s.h
>

14 
	~<löux/a˝i.h
>

15 
	~<löux/io.h
>

16 
	~<löux/dñay.h
>

18 
	~<asm/©omic.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/timî.h
>

21 
	~<asm/hw_úq.h
>

22 
	~<asm/pgèbÀ.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/i8259.h
>

27 
	~<asm/å≠s.h
>

45 #ifde‡
CONFIG_X86_32


58 
úqªtu∫_t
 
	$m©h_îr‹_úq
(
˝l
, *
dev_id
)

60 
	`outb
(0, 0xF0);

61 i‡(
ign‹e_Âu_úq
 || !
boŸ_˝u_d©a
.
h¨d_m©h
)

62  
IRQ_NONE
;

63 
	`m©h_îr‹
(
	`gë_úq_ªgs
(), 0, 16);

64  
IRQ_HANDLED
;

65 
	}
}

71 
úqa˘i⁄
 
	gÂu_úq
 = {

72 .
h™dÀr
 = 
m©h_îr‹_úq
,

73 .
	g«me
 = "fpu",

80 
úqa˘i⁄
 
	gúq2
 = {

81 .
h™dÀr
 = 
no_a˘i⁄
,

82 .
	g«me
 = "cascade",

85 
DEFINE_PER_CPU
(
ve˘‹_úq_t
, 
ve˘‹_úq
) = {

86 [0 ... 
NR_VECTORS
 - 1] = -1,

89 
	$ve˘‹_u£d_by_≥r˝u_úq
(
ve˘‹
)

91 
˝u
;

93 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

94 i‡(
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
ve˘‹
] != -1)

99 
	}
}

101 
__öô
 
	$öô_ISA_úqs
()

103 
i
;

105 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

106 
	`öô_b•_APIC
();

108 
Àgacy_pic
->
	`öô
(0);

113 
i
 = 0; i < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; i++) {

114 
úq_desc
 *
desc
 = 
	`úq_to_desc
(
i
);

116 
desc
->
°©us
 = 
IRQ_DISABLED
;

117 
desc
->
a˘i⁄
 = 
NULL
;

118 
desc
->
dïth
 = 1;

120 
	`£t_úq_chù_™d_h™dÀr_«me
(
i
, &
i8259A_chù
,

121 
h™dÀ_Àvñ_úq
, "XT");

123 
	}
}

125 
__öô
 
	$öô_IRQ
()

127 
i
;

137 
i
 = 0; i < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; i++)

138 
	`≥r_˝u
(
ve˘‹_úq
, 0)[
IRQ0_VECTOR
 + 
i
] = i;

140 
x86_öô
.
úqs
.
	`öå_öô
();

141 
	}
}

146 
	$£tup_ve˘‹_úq
(
˝u
)

148 #i‚de‡
CONFIG_X86_IO_APIC


149 
úq
;

158 
úq
 = 0; irq < 
Àgacy_pic
->
ƒ_Àgacy_úqs
; irq++)

159 
	`≥r_˝u
(
ve˘‹_úq
, 
˝u
)[
IRQ0_VECTOR
 + 
úq
] = irq;

162 
	`__£tup_ve˘‹_úq
(
˝u
);

163 
	}
}

165 
__öô
 
	$smp_öå_öô
()

167 #ifde‡
CONFIG_SMP


168 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

173 
	`Æloc_öå_g©e
(
RESCHEDULE_VECTOR
, 
ªscheduÀ_öãºu±
);

176 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+0, 
övÆid©e_öãºu±0
);

177 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+1, 
övÆid©e_öãºu±1
);

178 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+2, 
övÆid©e_öãºu±2
);

179 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+3, 
övÆid©e_öãºu±3
);

180 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+4, 
övÆid©e_öãºu±4
);

181 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+5, 
övÆid©e_öãºu±5
);

182 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+6, 
övÆid©e_öãºu±6
);

183 
	`Æloc_öå_g©e
(
INVALIDATE_TLB_VECTOR_START
+7, 
övÆid©e_öãºu±7
);

186 
	`Æloc_öå_g©e
(
CALL_FUNCTION_VECTOR
, 
ˇŒ_fun˘i⁄_öãºu±
);

189 
	`Æloc_öå_g©e
(
CALL_FUNCTION_SINGLE_VECTOR
,

190 
ˇŒ_fun˘i⁄_sögÀ_öãºu±
);

193 
	`£t_öå_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
úq_move_˛ónup_öãºu±
);

194 
	`£t_bô
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_ve˘‹s
);

197 
	`Æloc_öå_g©e
(
REBOOT_VECTOR
, 
ªboŸ_öãºu±
);

200 
	}
}

202 
__öô
 
	$≠ic_öå_öô
()

204 
	`smp_öå_öô
();

206 #ifde‡
CONFIG_X86_THERMAL_VECTOR


207 
	`Æloc_öå_g©e
(
THERMAL_APIC_VECTOR
, 
thîmÆ_öãºu±
);

209 #ifde‡
CONFIG_X86_MCE_THRESHOLD


210 
	`Æloc_öå_g©e
(
THRESHOLD_APIC_VECTOR
, 
thªshﬁd_öãºu±
);

212 #i‡
	`deföed
(
CONFIG_X86_MCE
Ë&& deföed(
CONFIG_X86_LOCAL_APIC
)

213 
	`Æloc_öå_g©e
(
MCE_SELF_VECTOR
, 
m˚_£lf_öãºu±
);

216 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_LOCAL_APIC
)

218 
	`Æloc_öå_g©e
(
LOCAL_TIMER_VECTOR
, 
≠ic_timî_öãºu±
);

221 
	`Æloc_öå_g©e
(
X86_PLATFORM_IPI_VECTOR
, 
x86_∂©f‹m_ùi
);

224 
	`Æloc_öå_g©e
(
SPURIOUS_APIC_VECTOR
, 
•urious_öãºu±
);

225 
	`Æloc_öå_g©e
(
ERROR_APIC_VECTOR
, 
îr‹_öãºu±
);

228 #ifde‡
CONFIG_PERF_EVENTS


229 
	`Æloc_öå_g©e
(
LOCAL_PENDING_VECTOR
, 
≥rf_≥ndög_öãºu±
);

233 
	}
}

235 
__öô
 
	$«tive_öô_IRQ
()

237 
i
;

240 
x86_öô
.
úqs
.
	`¥e_ve˘‹_öô
();

242 
	`≠ic_öå_öô
();

249 
i
 = 
FIRST_EXTERNAL_VECTOR
; i < 
NR_VECTORS
; i++) {

251 i‡(!
	`ã°_bô
(
i
, 
u£d_ve˘‹s
))

252 
	`£t_öå_g©e
(
i
, 
öãºu±
[i-
FIRST_EXTERNAL_VECTOR
]);

255 i‡(!
a˝i_iﬂpic
)

256 
	`£tup_úq
(2, &
úq2
);

258 #ifde‡
CONFIG_X86_32


263 i‡(
boŸ_˝u_d©a
.
h¨d_m©h
 && !
˝u_has_Âu
)

264 
	`£tup_úq
(
FPU_IRQ
, &
Âu_úq
);

266 
	`úq_˘x_öô
(
	`smp_¥o˚ss‹_id
());

268 
	}
}

	@/cmpt816/linux/arch/x86/kernel/k8.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/öô.h
>

8 
	~<löux/î∫o.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/•ölock.h
>

11 
	~<asm/k8.h
>

13 
	gnum_k8_n‹thbridges
;

14 
EXPORT_SYMBOL
(
num_k8_n‹thbridges
);

16 
u32
 *
	gÊush_w‹ds
;

18 
pci_devi˚_id
 
	gk8_nb_ids
[] = {

19 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
) },

20 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
) },

23 
EXPORT_SYMBOL
(
k8_nb_ids
);

25 
pci_dev
 **
	gk8_n‹thbridges
;

26 
EXPORT_SYMBOL
(
k8_n‹thbridges
);

28 
pci_dev
 *
	$√xt_k8_n‹thbridge
(
pci_dev
 *
dev
)

31 
dev
 = 
	`pci_gë_devi˚
(
PCI_ANY_ID
, PCI_ANY_ID, dev);

32 i‡(!
dev
)

34 } !
	`pci_m©ch_id
(&
k8_nb_ids
[0], 
dev
));

35  
dev
;

36 
	}
}

38 
	$ˇche_k8_n‹thbridges
()

40 
i
;

41 
pci_dev
 *
dev
;

43 i‡(
num_k8_n‹thbridges
)

46 
dev
 = 
NULL
;

47 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
)

48 
num_k8_n‹thbridges
++;

50 
k8_n‹thbridges
 = 
	`kmÆloc
((
num_k8_n‹thbridges
 + 1) * (*),

51 
GFP_KERNEL
);

52 i‡(!
k8_n‹thbridges
)

53  -
ENOMEM
;

55 i‡(!
num_k8_n‹thbridges
) {

56 
k8_n‹thbridges
[0] = 
NULL
;

60 
Êush_w‹ds
 = 
	`kmÆloc
(
num_k8_n‹thbridges
 * (
u32
), 
GFP_KERNEL
);

61 i‡(!
Êush_w‹ds
) {

62 
	`k‰ì
(
k8_n‹thbridges
);

63  -
ENOMEM
;

66 
dev
 = 
NULL
;

67 
i
 = 0;

68 (
dev
 = 
	`√xt_k8_n‹thbridge
(dev)Ë!
NULL
) {

69 
k8_n‹thbridges
[
i
] = 
dev
;

70 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x9c, &
Êush_w‹ds
[
i
++]);

72 
k8_n‹thbridges
[
i
] = 
NULL
;

74 
	}
}

75 
EXPORT_SYMBOL_GPL
(
ˇche_k8_n‹thbridges
);

79 
__öô
 
	$óæy_is_k8_nb
(
u32
 
devi˚
)

81 
pci_devi˚_id
 *
id
;

82 
u32
 
víd‹
 = 
devi˚
 & 0xffff;

83 
devi˚
 >>= 16;

84 
id
 = 
k8_nb_ids
; id->
víd‹
; id++)

85 i‡(
víd‹
 =
id
->víd‹ && 
devi˚
 == id->device)

88 
	}
}

90 
	$k8_Êush_g¨ts
()

92 
Êushed
, 
i
;

93 
Êags
;

94 
	`DEFINE_SPINLOCK
(
g¨t_lock
);

100 
	`•ö_lock_úqßve
(&
g¨t_lock
, 
Êags
);

101 
Êushed
 = 0;

102 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

103 
	`pci_wrôe_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
], 0x9c,

104 
Êush_w‹ds
[
i
]|1);

105 
Êushed
++;

107 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

108 
u32
 
w
;

111 
	`pci_ªad_c⁄fig_dw‹d
(
k8_n‹thbridges
[
i
],

112 0x9c, &
w
);

113 i‡(!(
w
 & 1))

115 
	`˝u_ªœx
();

118 
	`•ö_u∆ock_úqª°‹e
(&
g¨t_lock
, 
Êags
);

119 i‡(!
Êushed
)

120 
	`¥ötk
("nothingÅo flush?\n");

121 
	}
}

122 
EXPORT_SYMBOL_GPL
(
k8_Êush_g¨ts
);

124 
__öô
 
	$öô_k8_nbs
()

126 
îr
 = 0;

128 
îr
 = 
	`ˇche_k8_n‹thbridges
();

130 i‡(
îr
 < 0)

131 
	`¥ötk
(
KERN_NOTICE
 "K8 NB: CannotÉnumerate AMDÇorthbridges.\n");

133  
îr
;

134 
	}
}

137 
fs_öôˇŒ
(
öô_k8_nbs
);

	@/cmpt816/linux/arch/x86/kernel/kdebugfs.c

9 
	~<löux/debugfs.h
>

10 
	~<löux/uac˚ss.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/°©.h
>

15 
	~<löux/io.h
>

16 
	~<löux/mm.h
>

18 
	~<asm/£tup.h
>

20 
díåy
 *
	g¨ch_debugfs_dú
;

21 
EXPORT_SYMBOL
(
¨ch_debugfs_dú
);

23 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


24 
	s£tup_d©a_node
 {

25 
u64
 
	m∑ddr
;

26 
u32
 
	mty≥
;

27 
u32
 
	mÀn
;

30 
ssize_t
 
	$£tup_d©a_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

31 
size_t
 
cou¡
, 
loff_t
 *
µos
)

33 
£tup_d©a_node
 *
node
 = 
fûe
->
¥iv©e_d©a
;

34 
ªmaö
;

35 
loff_t
 
pos
 = *
µos
;

36 
∑ge
 *
pg
;

37 *
p
;

38 
u64
 
∑
;

40 i‡(
pos
 < 0)

41  -
EINVAL
;

43 i‡(
pos
 >
node
->
Àn
)

46 i‡(
cou¡
 > 
node
->
Àn
 - 
pos
)

47 
cou¡
 = 
node
->
Àn
 - 
pos
;

49 
∑
 = 
node
->
∑ddr
 + (
£tup_d©a
Ë+ 
pos
;

50 
pg
 = 
	`p‚_to_∑ge
((
∑
 + 
cou¡
 - 1Ë>> 
PAGE_SHIFT
);

51 i‡(
	`PageHighMem
(
pg
)) {

52 
p
 = 
	`i‹em≠_ˇche
(
∑
, 
cou¡
);

53 i‡(!
p
)

54  -
ENXIO
;

56 
p
 = 
	`__va
(
∑
);

58 
ªmaö
 = 
	`c›y_to_u£r
(
u£r_buf
, 
p
, 
cou¡
);

60 i‡(
	`PageHighMem
(
pg
))

61 
	`iounm≠
(
p
);

63 i‡(
ªmaö
)

64  -
EFAULT
;

66 *
µos
 = 
pos
 + 
cou¡
;

68  
cou¡
;

69 
	}
}

71 
	$£tup_d©a_›í
(
öode
 *öode, 
fûe
 *file)

73 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

76 
	}
}

78 c⁄° 
fûe_›î©i⁄s
 
	gf›s_£tup_d©a
 = {

79 .
ªad
 = 
£tup_d©a_ªad
,

80 .
	g›í
 = 
£tup_d©a_›í
,

83 
__öô


84 
	$¸óã_£tup_d©a_node
(
díåy
 *
∑ª¡
, 
no
,

85 
£tup_d©a_node
 *
node
)

87 
díåy
 *
d
, *
ty≥
, *
d©a
;

88 
buf
[16];

90 
	`•rötf
(
buf
, "%d", 
no
);

91 
d
 = 
	`debugfs_¸óã_dú
(
buf
, 
∑ª¡
);

92 i‡(!
d
)

93  -
ENOMEM
;

95 
ty≥
 = 
	`debugfs_¸óã_x32
("ty≥", 
S_IRUGO
, 
d
, &
node
->type);

96 i‡(!
ty≥
)

97 
îr_dú
;

99 
d©a
 = 
	`debugfs_¸óã_fûe
("d©a", 
S_IRUGO
, 
d
, 
node
, &
f›s_£tup_d©a
);

100 i‡(!
d©a
)

101 
îr_ty≥
;

105 
îr_ty≥
:

106 
	`debugfs_ªmove
(
ty≥
);

107 
îr_dú
:

108 
	`debugfs_ªmove
(
d
);

109  -
ENOMEM
;

110 
	}
}

112 
__öô
 
	$¸óã_£tup_d©a_nodes
(
díåy
 *
∑ª¡
)

114 
£tup_d©a_node
 *
node
;

115 
£tup_d©a
 *
d©a
;

116 
îr‹
 = -
ENOMEM
;

117 
díåy
 *
d
;

118 
∑ge
 *
pg
;

119 
u64
 
∑_d©a
;

120 
no
 = 0;

122 
d
 = 
	`debugfs_¸óã_dú
("£tup_d©a", 
∑ª¡
);

123 i‡(!
d
)

124  -
ENOMEM
;

126 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

128 
∑_d©a
) {

129 
node
 = 
	`kmÆloc
((*node), 
GFP_KERNEL
);

130 i‡(!
node
)

131 
îr_dú
;

133 
pg
 = 
	`p‚_to_∑ge
((
∑_d©a
+(*
d©a
)-1Ë>> 
PAGE_SHIFT
);

134 i‡(
	`PageHighMem
(
pg
)) {

135 
d©a
 = 
	`i‹em≠_ˇche
(
∑_d©a
, (*data));

136 i‡(!
d©a
) {

137 
	`k‰ì
(
node
);

138 
îr‹
 = -
ENXIO
;

139 
îr_dú
;

142 
d©a
 = 
	`__va
(
∑_d©a
);

144 
node
->
∑ddr
 = 
∑_d©a
;

145 
node
->
ty≥
 = 
d©a
->type;

146 
node
->
Àn
 = 
d©a
->len;

147 
îr‹
 = 
	`¸óã_£tup_d©a_node
(
d
, 
no
, 
node
);

148 
∑_d©a
 = 
d©a
->
√xt
;

150 i‡(
	`PageHighMem
(
pg
))

151 
	`iounm≠
(
d©a
);

152 i‡(
îr‹
)

153 
îr_dú
;

154 
no
++;

159 
îr_dú
:

160 
	`debugfs_ªmove
(
d
);

161  
îr‹
;

162 
	}
}

164 
debugfs_blob_wøµî
 
	gboŸ_∑øms_blob
 = {

165 .
d©a
 = &
boŸ_∑øms
,

166 .
	gsize
 = (
boŸ_∑øms
),

169 
__öô
 
	$boŸ_∑øms_kdebugfs_öô
()

171 
díåy
 *
dbp
, *
vîsi⁄
, *
d©a
;

172 
îr‹
 = -
ENOMEM
;

174 
dbp
 = 
	`debugfs_¸óã_dú
("boŸ_∑øms", 
NULL
);

175 i‡(!
dbp
)

176  -
ENOMEM
;

178 
vîsi⁄
 = 
	`debugfs_¸óã_x16
("vîsi⁄", 
S_IRUGO
, 
dbp
,

179 &
boŸ_∑øms
.
hdr
.
vîsi⁄
);

180 i‡(!
vîsi⁄
)

181 
îr_dú
;

183 
d©a
 = 
	`debugfs_¸óã_blob
("d©a", 
S_IRUGO
, 
dbp
,

184 &
boŸ_∑øms_blob
);

185 i‡(!
d©a
)

186 
îr_vîsi⁄
;

188 
îr‹
 = 
	`¸óã_£tup_d©a_nodes
(
dbp
);

189 i‡(
îr‹
)

190 
îr_d©a
;

194 
îr_d©a
:

195 
	`debugfs_ªmove
(
d©a
);

196 
îr_vîsi⁄
:

197 
	`debugfs_ªmove
(
vîsi⁄
);

198 
îr_dú
:

199 
	`debugfs_ªmove
(
dbp
);

200  
îr‹
;

201 
	}
}

204 
__öô
 
	$¨ch_kdebugfs_öô
()

206 
îr‹
 = 0;

208 
¨ch_debugfs_dú
 = 
	`debugfs_¸óã_dú
("x86", 
NULL
);

209 i‡(!
¨ch_debugfs_dú
)

210  -
ENOMEM
;

212 #ifde‡
CONFIG_DEBUG_BOOT_PARAMS


213 
îr‹
 = 
	`boŸ_∑øms_kdebugfs_öô
();

216  
îr‹
;

217 
	}
}

218 
¨ch_öôˇŒ
(
¨ch_kdebugfs_öô
);

	@/cmpt816/linux/arch/x86/kernel/kprobes.c

43 
	~<löux/k¥obes.h
>

44 
	~<löux/±ø˚.h
>

45 
	~<löux/°rög.h
>

46 
	~<löux/¶ab.h
>

47 
	~<löux/h¨dúq.h
>

48 
	~<löux/¥ìm±.h
>

49 
	~<löux/moduÀ.h
>

50 
	~<löux/kdebug.h
>

51 
	~<löux/kÆlsyms.h
>

52 
	~<löux/·ø˚.h
>

54 
	~<asm/ˇcheÊush.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/pgèbÀ.h
>

57 
	~<asm/uac˚ss.h
>

58 
	~<asm/Æã∫©ive.h
>

59 
	~<asm/ö¢.h
>

60 
	~<asm/debugªg.h
>

62 
j¥obe_ªtu∫_íd
();

64 
DEFINE_PER_CPU
(
k¥obe
 *, 
cuºít_k¥obe
Ë
NULL
;

65 
DEFINE_PER_CPU
(
k¥obe_˘lblk
, kprobe_ctlblk);

67 
	#°ack_addr
(
ªgs
Ë((*)
	`kî√l_°ack_poöãr
‘egs))

	)

69 
	#W
(
row
, 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
ba
, 
bb
, 
bc
, 
bd
, 
be
, 
bf
)\

70 (((
b0
##
UL
 << 0x0)|(
b1
##UL << 0x1)|(
b2
##UL << 0x2)|(
b3
##UL << 0x3) | \

71 (
b4
##
UL
 << 0x4)|(
b5
##UL << 0x5)|(
b6
##UL << 0x6)|(
b7
##UL << 0x7) | \

72 (
b8
##
UL
 << 0x8)|(
b9
##UL << 0x9)|(
ba
##UL << 0xa)|(
bb
##UL << 0xb) | \

73 (
bc
##
UL
 << 0xc)|(
bd
##UL << 0xd)|(
be
##UL << 0xe)|(
bf
##UL << 0xf)) \

74 << (
row
 % 32))

	)

79 c⁄° 
u32
 
	gtwobyã_is_boo°abÀ
[256 / 32] = {

82 
W
(0x00, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0) |

83 
W
(0x10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

84 
W
(0x20, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

85 
W
(0x30, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

86 
W
(0x40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) |

87 
W
(0x50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) ,

88 
W
(0x60, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1) |

89 
W
(0x70, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1) ,

90 
W
(0x80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0) |

91 
W
(0x90, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1) ,

92 
W
(0xa0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

93 
W
(0xb0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1) ,

94 
W
(0xc0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1) |

95 
W
(0xd0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) ,

96 
W
(0xe0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1) |

97 
W
(0xf0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0)

101 #unde‡
W


103 
kªçrobe_bœckpoöt
 
	gkªçrobe_bœckli°
[] = {

106 {
NULL
, NULL}

108 c⁄° 
	gkªçrobe_bœckli°_size
 = 
ARRAY_SIZE
(
kªçrobe_bœckli°
);

110 
__k¥obes
 
	$__sy¡hesize_ªœtive_ö¢
(*
‰om
, *
to
, 
u8
 
›
)

112 
	s__¨ch_ªœtive_ö¢
 {

113 
u8
 
›
;

114 
s32
 
øddr
;

115 } 
	`__©åibuã__
((
∑cked
)Ë*
ö¢
;

117 
ö¢
 = (
__¨ch_ªœtive_ö¢
 *)
‰om
;

118 
ö¢
->
øddr
 = (
s32
)(()(
to
Ë- (()(
‰om
) + 5));

119 
ö¢
->
›
 = op;

120 
	}
}

123 
__k¥obes
 
	$sy¡hesize_ªljump
(*
‰om
, *
to
)

125 
	`__sy¡hesize_ªœtive_ö¢
(
‰om
, 
to
, 
RELATIVEJUMP_OPCODE
);

126 
	}
}

132 
__k¥obes
 
	$is_REX_¥efix
(
k¥obe_›code_t
 *
ö¢
)

134 #ifde‡
CONFIG_X86_64


135 i‡((*
ö¢
 & 0xf0) == 0x40)

139 
	}
}

145 
__k¥obes
 
	$ˇn_boo°
(
k¥obe_›code_t
 *
›codes
)

147 
k¥obe_›code_t
 
›code
;

148 
k¥obe_›code_t
 *
‹ig_›codes
 = 
›codes
;

150 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(()
›codes
))

153 
ªåy
:

154 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

156 
›code
 = *(
›codes
++);

159 i‡(
›code
 == 0x0f) {

160 i‡(
›codes
 - 
‹ig_›codes
 > 
MAX_INSN_SIZE
 - 1)

162  
	`ã°_bô
(*
›codes
,

163 (*)
twobyã_is_boo°abÀ
);

166 
›code
 & 0xf0) {

167 #ifde‡
CONFIG_X86_64


169 
ªåy
;

172 i‡(0x63 < 
›code
 && opcode < 0x67)

173 
ªåy
;

175  (
›code
 != 0x62 && opcode != 0x67);

180  (0xc1 < 
›code
 && opcode < 0xcc) || opcode == 0xcf;

183  (
›code
 == 0xd4 || opcode == 0xd5 || opcode == 0xd7);

186  ((
›code
 & 0x04) || opcode == 0xea);

188 i‡((
›code
 & 0x0c) == 0 && opcode != 0xf1)

189 
ªåy
;

191  (
›code
 == 0xf5 || (0xf7 < opcode && opcode < 0xfe));

194 i‡(
›code
 == 0x26 || opcode == 0x36 || opcode == 0x3e)

195 
ªåy
;

197  (
›code
 != 0x2e && opcode != 0x9a);

199 
	}
}

202 
	$ªcovî_¥obed_ö°ru˘i⁄
(
k¥obe_›code_t
 *
buf
, 
addr
)

204 
k¥obe
 *
kp
;

205 
kp
 = 
	`gë_k¥obe
((*)
addr
);

206 i‡(!
kp
)

207  -
EINVAL
;

222 
	`mem˝y
(
buf
, 
kp
->
addr
, 
MAX_INSN_SIZE
 * (
k¥obe_›code_t
));

223 
buf
[0] = 
kp
->
›code
;

225 
	}
}

228 
	g__dummy_buf
[
KSYM_NAME_LEN
];

231 
__k¥obes
 
	$ˇn_¥obe
(
∑ddr
)

233 
ªt
;

234 
addr
, 
off£t
 = 0;

235 
ö¢
 insn;

236 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

238 i‡(!
	`kÆlsyms_lookup
(
∑ddr
, 
NULL
, &
off£t
, NULL, 
__dummy_buf
))

242 
addr
 = 
∑ddr
 - 
off£t
;

243 
addr
 < 
∑ddr
) {

244 
	`kî√l_ö¢_öô
(&
ö¢
, (*)
addr
);

245 
	`ö¢_gë_›code
(&
ö¢
);

252 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

253 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
, 
addr
);

254 i‡(
ªt
)

261 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

263 
	`ö¢_gë_Àngth
(&
ö¢
);

264 
addr
 +
ö¢
.
Àngth
;

267  (
addr
 =
∑ddr
);

268 
	}
}

273 
__k¥obes
 
	$is_IF_modifõr
(
k¥obe_›code_t
 *
ö¢
)

275 *
ö¢
) {

287 i‡(
	`is_REX_¥efix
(
ö¢
))

288  
	`is_IF_modifõr
(++
ö¢
);

291 
	}
}

300 
__k¥obes
 
	$__c›y_ö°ru˘i⁄
(
u8
 *
de°
, u8 *
§c
, 
ªcovî
)

302 
ö¢
 insn;

303 
ªt
;

304 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

306 
	`kî√l_ö¢_öô
(&
ö¢
, 
§c
);

307 i‡(
ªcovî
) {

308 
	`ö¢_gë_›code
(&
ö¢
);

309 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

310 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
,

311 ()
§c
);

312 i‡(
ªt
)

314 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

317 
	`ö¢_gë_Àngth
(&
ö¢
);

318 
	`mem˝y
(
de°
, 
ö¢
.
kaddr
, in¢.
Àngth
);

320 #ifde‡
CONFIG_X86_64


321 i‡(
	`ö¢_rù_ªœtive
(&
ö¢
)) {

322 
s64
 
√wdi•
;

323 
u8
 *
di•
;

324 
	`kî√l_ö¢_öô
(&
ö¢
, 
de°
);

325 
	`ö¢_gë_di•œ˚mít
(&
ö¢
);

338 
√wdi•
 = (
u8
 *Ë
§c
 + (
s64
Ë
ö¢
.
di•œ˚mít
.
vÆue
 -

339 (
u8
 *Ë
de°
;

340 
	`BUG_ON
((
s64
Ë(
s32
Ë
√wdi•
 !=Çewdisp);

341 
di•
 = (
u8
 *Ë
de°
 + 
	`ö¢_off£t_di•œ˚mít
(&
ö¢
);

342 *(
s32
 *Ë
di•
 = (s32Ë
√wdi•
;

345  
ö¢
.
Àngth
;

346 
	}
}

348 
__k¥obes
 
	$¨ch_c›y_k¥obe
(
k¥obe
 *
p
)

354 
	`__c›y_ö°ru˘i⁄
(
p
->
aö¢
.
ö¢
,Ö->
addr
, 0);

356 i‡(
	`ˇn_boo°
(
p
->
addr
))

357 
p
->
aö¢
.
boo°abÀ
 = 0;

359 
p
->
aö¢
.
boo°abÀ
 = -1;

361 
p
->
›code
 = *p->
addr
;

362 
	}
}

364 
__k¥obes
 
	$¨ch_¥ï¨e_k¥obe
(
k¥obe
 *
p
)

366 i‡(
	`Æã∫©ives_ãxt_ª£rved
(
p
->
addr
,Ö->addr))

367  -
EINVAL
;

369 i‡(!
	`ˇn_¥obe
(()
p
->
addr
))

370  -
EILSEQ
;

372 
p
->
aö¢
.
ö¢
 = 
	`gë_ö¢_¶Ÿ
();

373 i‡(!
p
->
aö¢
.
ö¢
)

374  -
ENOMEM
;

375 
	`¨ch_c›y_k¥obe
(
p
);

377 
	}
}

379 
__k¥obes
 
	$¨ch_¨m_k¥obe
(
k¥obe
 *
p
)

381 
	`ãxt_poke
(
p
->
addr
, (([]){
BREAKPOINT_INSTRUCTION
}), 1);

382 
	}
}

384 
__k¥obes
 
	$¨ch_dißrm_k¥obe
(
k¥obe
 *
p
)

386 
	`ãxt_poke
(
p
->
addr
, &p->
›code
, 1);

387 
	}
}

389 
__k¥obes
 
	$¨ch_ªmove_k¥obe
(
k¥obe
 *
p
)

391 i‡(
p
->
aö¢
.
ö¢
) {

392 
	`‰ì_ö¢_¶Ÿ
(
p
->
aö¢
.
ö¢
, (p->aö¢.
boo°abÀ
 == 1));

393 
p
->
aö¢
.
ö¢
 = 
NULL
;

395 
	}
}

397 
__k¥obes
 
	$ßve_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

399 
kcb
->
¥ev_k¥obe
.
kp
 = 
	`k¥obe_ru¬ög
();

400 
kcb
->
¥ev_k¥obe
.
°©us
 = kcb->
k¥obe_°©us
;

401 
kcb
->
¥ev_k¥obe
.
ﬁd_Êags
 = kcb->
k¥obe_ﬁd_Êags
;

402 
kcb
->
¥ev_k¥obe
.
ßved_Êags
 = kcb->
k¥obe_ßved_Êags
;

403 
	}
}

405 
__k¥obes
 
	$ª°‹e_¥evious_k¥obe
(
k¥obe_˘lblk
 *
kcb
)

407 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
kcb
->
¥ev_k¥obe
.
kp
;

408 
kcb
->
k¥obe_°©us
 = kcb->
¥ev_k¥obe
.
°©us
;

409 
kcb
->
k¥obe_ﬁd_Êags
 = kcb->
¥ev_k¥obe
.
ﬁd_Êags
;

410 
kcb
->
k¥obe_ßved_Êags
 = kcb->
¥ev_k¥obe
.
ßved_Êags
;

411 
	}
}

413 
__k¥obes
 
	$£t_cuºít_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

414 
k¥obe_˘lblk
 *
kcb
)

416 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
p
;

417 
kcb
->
k¥obe_ßved_Êags
 = kcb->
k¥obe_ﬁd_Êags


418 (
ªgs
->
Êags
 & (
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
));

419 i‡(
	`is_IF_modifõr
(
p
->
aö¢
.
ö¢
))

420 
kcb
->
k¥obe_ßved_Êags
 &~
X86_EFLAGS_IF
;

421 
	}
}

423 
__k¥obes
 
	$˛ór_btf
()

425 i‡(
	`ã°_thªad_Êag
(
TIF_BLOCKSTEP
)) {

426 
debug˘l
 = 
	`gë_debug˘lm§
();

428 
debug˘l
 &~
DEBUGCTLMSR_BTF
;

429 
	`upd©e_debug˘lm§
(
debug˘l
);

431 
	}
}

433 
__k¥obes
 
	$ª°‹e_btf
()

435 i‡(
	`ã°_thªad_Êag
(
TIF_BLOCKSTEP
)) {

436 
debug˘l
 = 
	`gë_debug˘lm§
();

438 
debug˘l
 |
DEBUGCTLMSR_BTF
;

439 
	`upd©e_debug˘lm§
(
debug˘l
);

441 
	}
}

443 
__k¥obes
 
	$¨ch_¥ï¨e_kªçrobe
(
kªçrobe_ö°™˚
 *
ri
,

444 
±_ªgs
 *
ªgs
)

446 *
ßø
 = 
	`°ack_addr
(
ªgs
);

448 
ri
->
ªt_addr
 = (
k¥obe_›code_t
 *Ë*
ßø
;

451 *
ßø
 = (Ë&
kªçrobe_åampﬁöe
;

452 
	}
}

454 #ifde‡
CONFIG_OPTPROBES


455 
__k¥obes
 
£tup_dëour_executi⁄
(
k¥obe
 *
p
,

456 
±_ªgs
 *
ªgs
,

457 
ªíãr
);

459 
	#£tup_dëour_executi⁄
(
p
, 
ªgs
, 
ªíãr
Ë(0)

	)

462 
__k¥obes
 
	$£tup_sögÀ°ï
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

463 
k¥obe_˘lblk
 *
kcb
, 
ªíãr
)

465 i‡(
	`£tup_dëour_executi⁄
(
p
, 
ªgs
, 
ªíãr
))

468 #i‡!
	`deföed
(
CONFIG_PREEMPT
)

469 i‡(
p
->
aö¢
.
boo°abÀ
 =1 && !p->
po°_h™dÀr
) {

471 i‡(!
ªíãr
)

472 
	`ª£t_cuºít_k¥obe
();

478 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

479 
	`¥ìm±_íabÀ_no_ªsched
();

483 i‡(
ªíãr
) {

484 
	`ßve_¥evious_k¥obe
(
kcb
);

485 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

486 
kcb
->
k¥obe_°©us
 = 
KPROBE_REENTER
;

488 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SS
;

490 
	`˛ór_btf
();

491 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

492 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

494 i‡(
p
->
›code
 =
BREAKPOINT_INSTRUCTION
)

495 
ªgs
->
ù
 = ()
p
->
addr
;

497 
ªgs
->
ù
 = ()
p
->
aö¢
.
ö¢
;

498 
	}
}

505 
__k¥obes
 
	$ªíãr_k¥obe
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
,

506 
k¥obe_˘lblk
 *
kcb
)

508 
kcb
->
k¥obe_°©us
) {

509 
KPROBE_HIT_SSDONE
:

510 
KPROBE_HIT_ACTIVE
:

511 
	`k¥obes_öc_nmis£d_cou¡
(
p
);

512 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 1);

514 
KPROBE_HIT_SS
:

521 
	`¥ötk
(
KERN_WARNING
 "Unrecoverable kprobe detectedát %p.\n",

522 
p
->
addr
);

523 
	`dump_k¥obe
(
p
);

524 
	`BUG
();

527 
	`WARN_ON
(1);

532 
	}
}

538 
__k¥obes
 
	$k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

540 
k¥obe_›code_t
 *
addr
;

541 
k¥obe
 *
p
;

542 
k¥obe_˘lblk
 *
kcb
;

544 
addr
 = (
k¥obe_›code_t
 *)(
ªgs
->
ù
 - (kprobe_opcode_t));

551 
	`¥ìm±_dißbÀ
();

553 
kcb
 = 
	`gë_k¥obe_˘lblk
();

554 
p
 = 
	`gë_k¥obe
(
addr
);

556 i‡(
p
) {

557 i‡(
	`k¥obe_ru¬ög
()) {

558 i‡(
	`ªíãr_k¥obe
(
p
, 
ªgs
, 
kcb
))

561 
	`£t_cuºít_k¥obe
(
p
, 
ªgs
, 
kcb
);

562 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

572 i‡(!
p
->
¥e_h™dÀr
 || !p->
	`¥e_h™dÀr
’, 
ªgs
))

573 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 0);

576 } i‡(*
addr
 !
BREAKPOINT_INSTRUCTION
) {

586 
ªgs
->
ù
 = ()
addr
;

587 
	`¥ìm±_íabÀ_no_ªsched
();

589 } i‡(
	`k¥obe_ru¬ög
()) {

590 
p
 = 
	`__gë_˝u_v¨
(
cuºít_k¥obe
);

591 i‡(
p
->
bªak_h™dÀr
 &&Ö->
	`bªak_h™dÀr
’, 
ªgs
)) {

592 
	`£tup_sögÀ°ï
(
p
, 
ªgs
, 
kcb
, 0);

597 
	`¥ìm±_íabÀ_no_ªsched
();

599 
	}
}

601 #ifde‡
CONFIG_X86_64


602 
	#SAVE_REGS_STRING
 \

619 "Öushq %r15\n"

	)

620 
	#RESTORE_REGS_STRING
 \

637 "áddq $24, %r•\n"

	)

639 
	#SAVE_REGS_STRING
 \

651 "Öush»%ebx\n"

	)

652 
	#RESTORE_REGS_STRING
 \

661 "ádd»$24, %e•\n"

	)

668 
__u£d
 
__k¥obes
 
	$kªçrobe_åampﬁöe_hﬁdî
()

670 
asm
 volatile (

673 #ifde‡
CONFIG_X86_64


677 
SAVE_REGS_STRING


682 
RESTORE_REGS_STRING


686 
SAVE_REGS_STRING


694 
RESTORE_REGS_STRING


698 
	}
}

703 
__u£d
 
__k¥obes
 *
	$åampﬁöe_h™dÀr
(
±_ªgs
 *
ªgs
)

705 
kªçrobe_ö°™˚
 *
ri
 = 
NULL
;

706 
hli°_hód
 *
hód
, 
em±y_Ω
;

707 
hli°_node
 *
node
, *
tmp
;

708 
Êags
, 
‹ig_ªt_addªss
 = 0;

709 
åampﬁöe_addªss
 = ()&
kªçrobe_åampﬁöe
;

711 
	`INIT_HLIST_HEAD
(&
em±y_Ω
);

712 
	`kªçrobe_hash_lock
(
cuºít
, &
hód
, &
Êags
);

714 #ifde‡
CONFIG_X86_64


715 
ªgs
->
cs
 = 
__KERNEL_CS
;

717 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

718 
ªgs
->
gs
 = 0;

720 
ªgs
->
ù
 = 
åampﬁöe_addªss
;

721 
ªgs
->
‹ig_ax
 = ~0UL;

736 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, 
hód
, 
hli°
) {

737 i‡(
ri
->
èsk
 !
cuºít
)

741 i‡(
ri
->
Ω
 &&Ñi->Ω->
h™dÀr
) {

742 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
ri
->
Ω
->
kp
;

743 
	`gë_k¥obe_˘lblk
()->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

744 
ri
->
Ω
->
	`h™dÀr
‘i, 
ªgs
);

745 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

748 
‹ig_ªt_addªss
 = ()
ri
->
ªt_addr
;

749 
	`ªcy˛e_Ω_ö°
(
ri
, &
em±y_Ω
);

751 i‡(
‹ig_ªt_addªss
 !
åampﬁöe_addªss
)

760 
	`kªçrobe_as£π
(
ri
, 
‹ig_ªt_addªss
, 
åampﬁöe_addªss
);

762 
	`kªçrobe_hash_u∆ock
(
cuºít
, &
Êags
);

764 
	`hli°_f‹_óch_íåy_ß„
(
ri
, 
node
, 
tmp
, &
em±y_Ω
, 
hli°
) {

765 
	`hli°_dñ
(&
ri
->
hli°
);

766 
	`k‰ì
(
ri
);

768  (*)
‹ig_ªt_addªss
;

769 
	}
}

798 
__k¥obes
 
	$ªsume_executi⁄
(
k¥obe
 *
p
,

799 
±_ªgs
 *
ªgs
, 
k¥obe_˘lblk
 *
kcb
)

801 *
tos
 = 
	`°ack_addr
(
ªgs
);

802 
c›y_ù
 = ()
p
->
aö¢
.
ö¢
;

803 
‹ig_ù
 = ()
p
->
addr
;

804 
k¥obe_›code_t
 *
ö¢
 = 
p
->
aö¢
.insn;

807 i‡(
	`is_REX_¥efix
(
ö¢
))

808 
ö¢
++;

810 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

811 *
ö¢
) {

813 *
tos
 &~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
);

814 *
tos
 |
kcb
->
k¥obe_ﬁd_Êags
;

823 
p
->
aö¢
.
boo°abÀ
 = 1;

824 
no_ch™ge
;

826 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

828 #ifde‡
CONFIG_X86_32


830 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

831 
no_ch™ge
;

834 i‡((
ö¢
[1] & 0x30) == 0x10) {

840 *
tos
 = 
‹ig_ù
 + (*to†- 
c›y_ù
);

841 
no_ch™ge
;

842 } i‡(((
ö¢
[1] & 0x31) == 0x20) ||

843 ((
ö¢
[1] & 0x31) == 0x21)) {

848 
p
->
aö¢
.
boo°abÀ
 = 1;

849 
no_ch™ge
;

855 i‡(
p
->
aö¢
.
boo°abÀ
 == 0) {

856 i‡((
ªgs
->
ù
 > 
c›y_ù
) &&

857 (
ªgs
->
ù
 - 
c›y_ù
Ë+ 5 < 
MAX_INSN_SIZE
) {

862 
	`sy¡hesize_ªljump
((*)
ªgs
->
ù
,

863 (*)
‹ig_ù
 + (
ªgs
->
ù
 - 
c›y_ù
));

864 
p
->
aö¢
.
boo°abÀ
 = 1;

866 
p
->
aö¢
.
boo°abÀ
 = -1;

870 
ªgs
->
ù
 +
‹ig_ù
 - 
c›y_ù
;

872 
no_ch™ge
:

873 
	`ª°‹e_btf
();

874 
	}
}

880 
__k¥obes
 
	$po°_k¥obe_h™dÀr
(
±_ªgs
 *
ªgs
)

882 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

883 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

885 i‡(!
cur
)

888 
	`ªsume_executi⁄
(
cur
, 
ªgs
, 
kcb
);

889 
ªgs
->
Êags
 |
kcb
->
k¥obe_ßved_Êags
;

891 i‡((
kcb
->
k¥obe_°©us
 !
KPROBE_REENTER
Ë&& 
cur
->
po°_h™dÀr
) {

892 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_SSDONE
;

893 
cur
->
	`po°_h™dÀr
(cur, 
ªgs
, 0);

897 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
) {

898 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

899 
out
;

901 
	`ª£t_cuºít_k¥obe
();

902 
out
:

903 
	`¥ìm±_íabÀ_no_ªsched
();

910 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
)

914 
	}
}

916 
__k¥obes
 
	$k¥obe_Áu…_h™dÀr
(
±_ªgs
 *
ªgs
, 
å≠ƒ
)

918 
k¥obe
 *
cur
 = 
	`k¥obe_ru¬ög
();

919 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

921 
kcb
->
k¥obe_°©us
) {

922 
KPROBE_HIT_SS
:

923 
KPROBE_REENTER
:

931 
ªgs
->
ù
 = ()
cur
->
addr
;

932 
ªgs
->
Êags
 |
kcb
->
k¥obe_ﬁd_Êags
;

933 i‡(
kcb
->
k¥obe_°©us
 =
KPROBE_REENTER
)

934 
	`ª°‹e_¥evious_k¥obe
(
kcb
);

936 
	`ª£t_cuºít_k¥obe
();

937 
	`¥ìm±_íabÀ_no_ªsched
();

939 
KPROBE_HIT_ACTIVE
:

940 
KPROBE_HIT_SSDONE
:

946 
	`k¥obes_öc_nmis£d_cou¡
(
cur
);

955 i‡(
cur
->
Áu…_h™dÀr
 && cur->
	`Áu…_h™dÀr
(cur, 
ªgs
, 
å≠ƒ
))

962 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

974 
	}
}

979 
__k¥obes
 
	$k¥obe_ex˚±i⁄s_nŸify
(
nŸifõr_block
 *
£lf
,

980 
vÆ
, *
d©a
)

982 
dõ_¨gs
 *
¨gs
 = 
d©a
;

983 
ªt
 = 
NOTIFY_DONE
;

985 i‡(
¨gs
->
ªgs
 && 
	`u£r_mode_vm
(args->regs))

986  
ªt
;

988 
vÆ
) {

989 
DIE_INT3
:

990 i‡(
	`k¥obe_h™dÀr
(
¨gs
->
ªgs
))

991 
ªt
 = 
NOTIFY_STOP
;

993 
DIE_DEBUG
:

994 i‡(
	`po°_k¥obe_h™dÀr
(
¨gs
->
ªgs
)) {

999 (*(*)
	`ERR_PTR
(
¨gs
->
îr
)Ë&~
DR_STEP
;

1000 
ªt
 = 
NOTIFY_STOP
;

1003 
DIE_GPF
:

1009 i‡(!
	`¥ìm±ibÀ
(Ë&& 
	`k¥obe_ru¬ög
() &&

1010 
	`k¥obe_Áu…_h™dÀr
(
¨gs
->
ªgs
,árgs->
å≠ƒ
))

1011 
ªt
 = 
NOTIFY_STOP
;

1016  
ªt
;

1017 
	}
}

1019 
__k¥obes
 
	$£tjmp_¥e_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1021 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1022 
addr
;

1023 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1025 
kcb
->
j¥obe_ßved_ªgs
 = *
ªgs
;

1026 
kcb
->
j¥obe_ßved_•
 = 
	`°ack_addr
(
ªgs
);

1027 
addr
 = ()(
kcb
->
j¥obe_ßved_•
);

1036 
	`mem˝y
(
kcb
->
j¥obes_°ack
, (
k¥obe_›code_t
 *)
addr
,

1037 
	`MIN_STACK_SIZE
(
addr
));

1038 
ªgs
->
Êags
 &~
X86_EFLAGS_IF
;

1039 
	`åa˚_h¨dúqs_off
();

1040 
ªgs
->
ù
 = ()(
jp
->
íåy
);

1042 
	}
}

1044 
__k¥obes
 
	$j¥obe_ªtu∫
()

1046 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1048 
asm
 volatile (

1049 #ifde‡
CONFIG_X86_64


1058 (
kcb
->
j¥obe_ßved_•
):"memory");

1059 
	}
}

1061 
__k¥obes
 
	$l⁄gjmp_bªak_h™dÀr
(
k¥obe
 *
p
, 
±_ªgs
 *
ªgs
)

1063 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1064 
u8
 *
addr
 = (u8 *Ë(
ªgs
->
ù
 - 1);

1065 
j¥obe
 *
jp
 = 
	`c⁄èöî_of
(
p
, j¥obe, 
kp
);

1067 i‡((
addr
 > (
u8
 *Ë
j¥obe_ªtu∫
) &&

1068 (
addr
 < (
u8
 *Ë
j¥obe_ªtu∫_íd
)) {

1069 i‡(
	`°ack_addr
(
ªgs
Ë!
kcb
->
j¥obe_ßved_•
) {

1070 
±_ªgs
 *
ßved_ªgs
 = &
kcb
->
j¥obe_ßved_ªgs
;

1071 
	`¥ötk
(
KERN_ERR


1073 
	`°ack_addr
(
ªgs
), 
kcb
->
j¥obe_ßved_•
);

1074 
	`¥ötk
(
KERN_ERR
 "SavedÑegi°î†f‹ j¥obê%p\n", 
jp
);

1075 
	`show_ªgi°îs
(
ßved_ªgs
);

1076 
	`¥ötk
(
KERN_ERR
 "CurrentÑegisters\n");

1077 
	`show_ªgi°îs
(
ªgs
);

1078 
	`BUG
();

1080 *
ªgs
 = 
kcb
->
j¥obe_ßved_ªgs
;

1081 
	`mem˝y
((
k¥obe_›code_t
 *)(
kcb
->
j¥obe_ßved_•
),

1082 
kcb
->
j¥obes_°ack
,

1083 
	`MIN_STACK_SIZE
(
kcb
->
j¥obe_ßved_•
));

1084 
	`¥ìm±_íabÀ_no_ªsched
();

1088 
	}
}

1091 #ifde‡
CONFIG_OPTPROBES


1094 
__k¥obes
 
	$sy¡hesize_ªlˇŒ
(*
‰om
, *
to
)

1096 
	`__sy¡hesize_ªœtive_ö¢
(
‰om
, 
to
, 
RELATIVECALL_OPCODE
);

1097 
	}
}

1100 
__k¥obes
 
	$sy¡hesize_£t_¨g1
(
k¥obe_›code_t
 *
addr
,

1101 
vÆ
)

1103 #ifde‡
CONFIG_X86_64


1104 *
addr
++ = 0x48;

1105 *
addr
++ = 0xbf;

1107 *
addr
++ = 0xb8;

1109 *(*)
addr
 = 
vÆ
;

1110 
	}
}

1112 
__k¥obes
 
	$k¥obes_›tö¢_ãm∂©e_hﬁdî
()

1114 
asm
 volatile (

1117 #ifde‡
CONFIG_X86_64


1121 
SAVE_REGS_STRING


1125 
ASM_NOP5


1126 
ASM_NOP5


1129 
ASM_NOP5


1133 
RESTORE_REGS_STRING


1139 
SAVE_REGS_STRING


1143 
ASM_NOP5


1146 
ASM_NOP5


1147 
RESTORE_REGS_STRING


1153 
	}
}

1155 
	#TMPL_MOVE_IDX
 \

1156 (()&
›çrobe_ãm∂©e_vÆ
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1157 
	#TMPL_CALL_IDX
 \

1158 (()&
›çrobe_ãm∂©e_ˇŒ
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1159 
	#TMPL_END_IDX
 \

1160 (()&
›çrobe_ãm∂©e_íd
 - ()&
›çrobe_ãm∂©e_íåy
)

	)

1162 
	#INT3_SIZE
 (
k¥obe_›code_t
)

	)

1165 
__k¥obes
 
	$›timized_ˇŒback
(
›timized_k¥obe
 *
›
,

1166 
±_ªgs
 *
ªgs
)

1168 
k¥obe_˘lblk
 *
kcb
 = 
	`gë_k¥obe_˘lblk
();

1170 
	`¥ìm±_dißbÀ
();

1171 i‡(
	`k¥obe_ru¬ög
()) {

1172 
	`k¥obes_öc_nmis£d_cou¡
(&
›
->
kp
);

1175 #ifde‡
CONFIG_X86_64


1176 
ªgs
->
cs
 = 
__KERNEL_CS
;

1178 
ªgs
->
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

1179 
ªgs
->
gs
 = 0;

1181 
ªgs
->
ù
 = ()
›
->
kp
.
addr
 + 
INT3_SIZE
;

1182 
ªgs
->
‹ig_ax
 = ~0UL;

1184 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë&
›
->
kp
;

1185 
kcb
->
k¥obe_°©us
 = 
KPROBE_HIT_ACTIVE
;

1186 
	`›t_¥e_h™dÀr
(&
›
->
kp
, 
ªgs
);

1187 
	`__gë_˝u_v¨
(
cuºít_k¥obe
Ë
NULL
;

1189 
	`¥ìm±_íabÀ_no_ªsched
();

1190 
	}
}

1192 
__k¥obes
 
	$c›y_›timized_ö°ru˘i⁄s
(
u8
 *
de°
, u8 *
§c
)

1194 
Àn
 = 0, 
ªt
;

1196 
Àn
 < 
RELATIVEJUMP_SIZE
) {

1197 
ªt
 = 
	`__c›y_ö°ru˘i⁄
(
de°
 + 
Àn
, 
§c
 +Üen, 1);

1198 i‡(!
ªt
 || !
	`ˇn_boo°
(
de°
 + 
Àn
))

1199  -
EINVAL
;

1200 
Àn
 +
ªt
;

1203 i‡(
	`·ø˚_ãxt_ª£rved
(
§c
, sr¯+ 
Àn
 - 1) ||

1204 
	`Æã∫©ives_ãxt_ª£rved
(
§c
, sr¯+ 
Àn
 - 1))

1205  -
EBUSY
;

1207  
Àn
;

1208 
	}
}

1211 
__k¥obes
 
	$ö¢_is_ödúe˘_jump
(
ö¢
 *insn)

1213  ((
ö¢
->
›code
.
byãs
[0] == 0xff &&

1214 (
	`X86_MODRM_REG
(
ö¢
->
modrm
.
vÆue
) & 6) == 4) ||

1215 
ö¢
->
›code
.
byãs
[0] == 0xea);

1216 
	}
}

1219 
	$ö¢_jump_öto_ønge
(
ö¢
 *ö¢, 
°¨t
, 
Àn
)

1221 
èrgë
 = 0;

1223 
ö¢
->
›code
.
byãs
[0]) {

1232 i‡((
ö¢
->
›code
.
byãs
[1] & 0xf0) == 0x80)

1236 i‡((
ö¢
->
›code
.
byãs
[0] & 0xf0) == 0x70)

1240 
èrgë
 = ()
ö¢
->
√xt_byã
 + in¢->
immedüã
.
vÆue
;

1242  (
°¨t
 <
èrgë
 &&Å¨gë <°¨à+ 
Àn
);

1243 
	}
}

1246 
__k¥obes
 
	$ˇn_›timize
(
∑ddr
)

1248 
ªt
;

1249 
addr
, 
size
 = 0, 
off£t
 = 0;

1250 
ö¢
 insn;

1251 
k¥obe_›code_t
 
buf
[
MAX_INSN_SIZE
];

1253 
__dummy_buf
[
KSYM_NAME_LEN
];

1256 i‡(!
	`kÆlsyms_lookup
(
∑ddr
, &
size
, &
off£t
, 
NULL
, 
__dummy_buf
))

1260 i‡(
size
 - 
off£t
 < 
RELATIVEJUMP_SIZE
)

1264 
addr
 = 
∑ddr
 - 
off£t
;

1265 
addr
 < 
∑ddr
 - 
off£t
 + 
size
) {

1266 i‡(
	`£¨ch_ex˚±i⁄_èbÀs
(
addr
))

1272 
	`kî√l_ö¢_öô
(&
ö¢
, (*)
addr
);

1273 
	`ö¢_gë_›code
(&
ö¢
);

1274 i‡(
ö¢
.
›code
.
byãs
[0] =
BREAKPOINT_INSTRUCTION
) {

1275 
ªt
 = 
	`ªcovî_¥obed_ö°ru˘i⁄
(
buf
, 
addr
);

1276 i‡(
ªt
)

1278 
	`kî√l_ö¢_öô
(&
ö¢
, 
buf
);

1280 
	`ö¢_gë_Àngth
(&
ö¢
);

1282 
ö¢
.
kaddr
 = (*)
addr
;

1283 
ö¢
.
√xt_byã
 = (*)(
addr
 + in¢.
Àngth
);

1285 i‡(
	`ö¢_is_ödúe˘_jump
(&
ö¢
) ||

1286 
	`ö¢_jump_öto_ønge
(&
ö¢
, 
∑ddr
 + 
INT3_SIZE
,

1287 
RELATIVE_ADDR_SIZE
))

1289 
addr
 +
ö¢
.
Àngth
;

1293 
	}
}

1296 
__k¥obes
 
	$¨ch_check_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1298 
i
;

1299 
k¥obe
 *
p
;

1301 
i
 = 1; i < 
›
->
›tö¢
.
size
; i++) {

1302 
p
 = 
	`gë_k¥obe
(
›
->
kp
.
addr
 + 
i
);

1303 i‡(
p
 && !
	`k¥obe_dißbÀd
(p))

1304  -
EEXIST
;

1308 
	}
}

1311 
__k¥obes
 
	$¨ch_wôhö_›timized_k¥obe
(
›timized_k¥obe
 *
›
,

1312 
addr
)

1314  (()
›
->
kp
.
addr
 <=áddr &&

1315 ()
›
->
kp
.
addr
 + op->
›tö¢
.
size
 >áddr);

1316 
	}
}

1319 
__k¥obes


1320 
	$__¨ch_ªmove_›timized_k¥obe
(
›timized_k¥obe
 *
›
, 
dúty
)

1322 i‡(
›
->
›tö¢
.
ö¢
) {

1323 
	`‰ì_›tö¢_¶Ÿ
(
›
->
›tö¢
.
ö¢
, 
dúty
);

1324 
›
->
›tö¢
.
ö¢
 = 
NULL
;

1325 
›
->
›tö¢
.
size
 = 0;

1327 
	}
}

1329 
__k¥obes
 
	$¨ch_ªmove_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1331 
	`__¨ch_ªmove_›timized_k¥obe
(
›
, 1);

1332 
	}
}

1338 
__k¥obes
 
	$¨ch_¥ï¨e_›timized_k¥obe
(
›timized_k¥obe
 *
›
)

1340 
u8
 *
buf
;

1341 
ªt
;

1342 
ªl
;

1344 i‡(!
	`ˇn_›timize
(()
›
->
kp
.
addr
))

1345  -
EILSEQ
;

1347 
›
->
›tö¢
.
ö¢
 = 
	`gë_›tö¢_¶Ÿ
();

1348 i‡(!
›
->
›tö¢
.
ö¢
)

1349  -
ENOMEM
;

1355 
ªl
 = ()
›
->
›tö¢
.
ö¢
 - ()›->
kp
.
addr
 + 
RELATIVEJUMP_SIZE
;

1356 i‡(
	`abs
(
ªl
) > 0x7fffffff)

1357  -
ERANGE
;

1359 
buf
 = (
u8
 *)
›
->
›tö¢
.
ö¢
;

1362 
ªt
 = 
	`c›y_›timized_ö°ru˘i⁄s
(
buf
 + 
TMPL_END_IDX
, 
›
->
kp
.
addr
);

1363 i‡(
ªt
 < 0) {

1364 
	`__¨ch_ªmove_›timized_k¥obe
(
›
, 0);

1365  
ªt
;

1367 
›
->
›tö¢
.
size
 = 
ªt
;

1370 
	`mem˝y
(
buf
, &
›çrobe_ãm∂©e_íåy
, 
TMPL_END_IDX
);

1373 
	`sy¡hesize_£t_¨g1
(
buf
 + 
TMPL_MOVE_IDX
, ()
›
);

1376 
	`sy¡hesize_ªlˇŒ
(
buf
 + 
TMPL_CALL_IDX
, 
›timized_ˇŒback
);

1379 
	`sy¡hesize_ªljump
(
buf
 + 
TMPL_END_IDX
 + 
›
->
›tö¢
.
size
,

1380 (
u8
 *)
›
->
kp
.
addr
 + op->
›tö¢
.
size
);

1382 
	`Êush_iˇche_ønge
((Ë
buf
,

1383 (Ë
buf
 + 
TMPL_END_IDX
 +

1384 
›
->
›tö¢
.
size
 + 
RELATIVEJUMP_SIZE
);

1386 
	}
}

1389 
__k¥obes
 
	$¨ch_›timize_k¥obe
(
›timized_k¥obe
 *
›
)

1391 
jmp_code
[
RELATIVEJUMP_SIZE
];

1392 
s32
 
ªl
 = (s32)(()
›
->
›tö¢
.
ö¢
 -

1393 (()
›
->
kp
.
addr
 + 
RELATIVEJUMP_SIZE
));

1396 
	`mem˝y
(
›
->
›tö¢
.
c›õd_ö¢
, op->
kp
.
addr
 + 
INT3_SIZE
,

1397 
RELATIVE_ADDR_SIZE
);

1399 
jmp_code
[0] = 
RELATIVEJUMP_OPCODE
;

1400 *(
s32
 *)(&
jmp_code
[1]Ë
ªl
;

1407 
	`ãxt_poke_smp
(
›
->
kp
.
addr
, 
jmp_code
, 
RELATIVEJUMP_SIZE
);

1409 
	}
}

1412 
__k¥obes
 
	$¨ch_un›timize_k¥obe
(
›timized_k¥obe
 *
›
)

1414 
u8
 
buf
[
RELATIVEJUMP_SIZE
];

1417 
buf
[0] = 
BREAKPOINT_INSTRUCTION
;

1418 
	`mem˝y
(
buf
 + 1, 
›
->
›tö¢
.
c›õd_ö¢
, 
RELATIVE_ADDR_SIZE
);

1419 
	`ãxt_poke_smp
(
›
->
kp
.
addr
, 
buf
, 
RELATIVEJUMP_SIZE
);

1420 
	}
}

1422 
__k¥obes
 
	$£tup_dëour_executi⁄
(
k¥obe
 *
p
,

1423 
±_ªgs
 *
ªgs
,

1424 
ªíãr
)

1426 
›timized_k¥obe
 *
›
;

1428 i‡(
p
->
Êags
 & 
KPROBE_FLAG_OPTIMIZED
) {

1430 
›
 = 
	`c⁄èöî_of
(
p
, 
›timized_k¥obe
, 
kp
);

1432 
ªgs
->
ù
 = ()
›
->
›tö¢
.
ö¢
 + 
TMPL_END_IDX
;

1433 i‡(!
ªíãr
)

1434 
	`ª£t_cuºít_k¥obe
();

1435 
	`¥ìm±_íabÀ_no_ªsched
();

1439 
	}
}

1442 
__öô
 
	$¨ch_öô_k¥obes
()

1445 
	}
}

1447 
__k¥obes
 
	$¨ch_åampﬁöe_k¥obe
(
k¥obe
 *
p
)

1450 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ldt.c

9 
	~<löux/î∫o.h
>

10 
	~<löux/gÂ.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/°rög.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/smp.h
>

15 
	~<löux/vmÆloc.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/ldt.h
>

20 
	~<asm/desc.h
>

21 
	~<asm/mmu_c⁄ãxt.h
>

22 
	~<asm/sysˇŒs.h
>

24 #ifde‡
CONFIG_SMP


25 
	$Êush_ldt
(*
cuºít_mm
)

27 i‡(
cuºít
->
a˘ive_mm
 =
cuºít_mm
)

28 
	`lﬂd_LDT
(&
cuºít
->
a˘ive_mm
->
c⁄ãxt
);

29 
	}
}

32 
	$Æloc_ldt
(
mm_c⁄ãxt_t
 *
pc
, 
möcou¡
, 
ªlﬂd
)

34 *
ﬁdldt
, *
√wldt
;

35 
ﬁdsize
;

37 i‡(
möcou¡
 <
pc
->
size
)

39 
ﬁdsize
 = 
pc
->
size
;

40 
möcou¡
 = (möcou¡ + (
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1)) &

41 (~(
PAGE_SIZE
 / 
LDT_ENTRY_SIZE
 - 1));

42 i‡(
möcou¡
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

43 
√wldt
 = 
	`vmÆloc
(
möcou¡
 * 
LDT_ENTRY_SIZE
);

45 
√wldt
 = (*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
);

47 i‡(!
√wldt
)

48  -
ENOMEM
;

50 i‡(
ﬁdsize
)

51 
	`mem˝y
(
√wldt
, 
pc
->
ldt
, 
ﬁdsize
 * 
LDT_ENTRY_SIZE
);

52 
ﬁdldt
 = 
pc
->
ldt
;

53 
	`mem£t
(
√wldt
 + 
ﬁdsize
 * 
LDT_ENTRY_SIZE
, 0,

54 (
möcou¡
 - 
ﬁdsize
Ë* 
LDT_ENTRY_SIZE
);

56 
	`∑øvút_Æloc_ldt
(
√wldt
, 
möcou¡
);

58 #ifde‡
CONFIG_X86_64


60 
	`wmb
();

62 
pc
->
ldt
 = 
√wldt
;

63 
	`wmb
();

64 
pc
->
size
 = 
möcou¡
;

65 
	`wmb
();

67 i‡(
ªlﬂd
) {

68 #ifde‡
CONFIG_SMP


69 
	`¥ìm±_dißbÀ
();

70 
	`lﬂd_LDT
(
pc
);

71 i‡(!
	`˝umask_equÆ
(
	`mm_˝umask
(
cuºít
->
mm
),

72 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
())))

73 
	`smp_ˇŒ_fun˘i⁄
(
Êush_ldt
, 
cuºít
->
mm
, 1);

74 
	`¥ìm±_íabÀ
();

76 
	`lﬂd_LDT
(
pc
);

79 i‡(
ﬁdsize
) {

80 
	`∑øvút_‰ì_ldt
(
ﬁdldt
, 
ﬁdsize
);

81 i‡(
ﬁdsize
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

82 
	`v‰ì
(
ﬁdldt
);

84 
	`put_∑ge
(
	`vút_to_∑ge
(
ﬁdldt
));

87 
	}
}

89 
ölöe
 
	$c›y_ldt
(
mm_c⁄ãxt_t
 *
√w
, mm_c⁄ãxt_à*
ﬁd
)

91 
îr
 = 
	`Æloc_ldt
(
√w
, 
ﬁd
->
size
, 0);

92 
i
;

94 i‡(
îr
 < 0)

95  
îr
;

97 
i
 = 0; i < 
ﬁd
->
size
; i++)

98 
	`wrôe_ldt_íåy
(
√w
->
ldt
, 
i
, 
ﬁd
->ldà+ i * 
LDT_ENTRY_SIZE
);

100 
	}
}

106 
	$öô_√w_c⁄ãxt
(
èsk_°ru˘
 *
tsk
, 
mm_°ru˘
 *
mm
)

108 
mm_°ru˘
 *
ﬁd_mm
;

109 
ªtvÆ
 = 0;

111 
	`muãx_öô
(&
mm
->
c⁄ãxt
.
lock
);

112 
mm
->
c⁄ãxt
.
size
 = 0;

113 
ﬁd_mm
 = 
cuºít
->
mm
;

114 i‡(
ﬁd_mm
 && old_mm->
c⁄ãxt
.
size
 > 0) {

115 
	`muãx_lock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

116 
ªtvÆ
 = 
	`c›y_ldt
(&
mm
->
c⁄ãxt
, &
ﬁd_mm
->context);

117 
	`muãx_u∆ock
(&
ﬁd_mm
->
c⁄ãxt
.
lock
);

119  
ªtvÆ
;

120 
	}
}

127 
	$de°roy_c⁄ãxt
(
mm_°ru˘
 *
mm
)

129 i‡(
mm
->
c⁄ãxt
.
size
) {

130 #ifde‡
CONFIG_X86_32


132 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

133 
	`˛ór_LDT
();

135 
	`∑øvút_‰ì_ldt
(
mm
->
c⁄ãxt
.
ldt
, mm->c⁄ãxt.
size
);

136 i‡(
mm
->
c⁄ãxt
.
size
 * 
LDT_ENTRY_SIZE
 > 
PAGE_SIZE
)

137 
	`v‰ì
(
mm
->
c⁄ãxt
.
ldt
);

139 
	`put_∑ge
(
	`vút_to_∑ge
(
mm
->
c⁄ãxt
.
ldt
));

140 
mm
->
c⁄ãxt
.
size
 = 0;

142 
	}
}

144 
	$ªad_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

146 
îr
;

147 
size
;

148 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

150 i‡(!
mm
->
c⁄ãxt
.
size
)

152 i‡(
byãcou¡
 > 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
)

153 
byãcou¡
 = 
LDT_ENTRY_SIZE
 * 
LDT_ENTRIES
;

155 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

156 
size
 = 
mm
->
c⁄ãxt
.sizê* 
LDT_ENTRY_SIZE
;

157 i‡(
size
 > 
byãcou¡
)

158 
size
 = 
byãcou¡
;

160 
îr
 = 0;

161 i‡(
	`c›y_to_u£r
(
±r
, 
mm
->
c⁄ãxt
.
ldt
, 
size
))

162 
îr
 = -
EFAULT
;

163 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

164 i‡(
îr
 < 0)

165 
îr‹_ªtu∫
;

166 i‡(
size
 !
byãcou¡
) {

168 i‡(
	`˛ór_u£r
(
±r
 + 
size
, 
byãcou¡
 - size) != 0) {

169 
îr
 = -
EFAULT
;

170 
îr‹_ªtu∫
;

173  
byãcou¡
;

174 
îr‹_ªtu∫
:

175  
îr
;

176 
	}
}

178 
	$ªad_deÁu…_ldt
(
__u£r
 *
±r
, 
byãcou¡
)

181 #ifde‡
CONFIG_X86_32


182 
size
 = 5 * (
desc_°ru˘
);

184 
size
 = 128;

186 i‡(
byãcou¡
 > 
size
)

187 
byãcou¡
 = 
size
;

188 i‡(
	`˛ór_u£r
(
±r
, 
byãcou¡
))

189  -
EFAULT
;

190  
byãcou¡
;

191 
	}
}

193 
	$wrôe_ldt
(
__u£r
 *
±r
, 
byãcou¡
, 
ﬁdmode
)

195 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

196 
desc_°ru˘
 
ldt
;

197 
îr‹
;

198 
u£r_desc
 
ldt_öfo
;

200 
îr‹
 = -
EINVAL
;

201 i‡(
byãcou¡
 !(
ldt_öfo
))

202 
out
;

203 
îr‹
 = -
EFAULT
;

204 i‡(
	`c›y_‰om_u£r
(&
ldt_öfo
, 
±r
, (ldt_info)))

205 
out
;

207 
îr‹
 = -
EINVAL
;

208 i‡(
ldt_öfo
.
íåy_numbî
 >
LDT_ENTRIES
)

209 
out
;

210 i‡(
ldt_öfo
.
c⁄ã¡s
 == 3) {

211 i‡(
ﬁdmode
)

212 
out
;

213 i‡(
ldt_öfo
.
£g_nŸ_¥e£¡
 == 0)

214 
out
;

217 
	`muãx_lock
(&
mm
->
c⁄ãxt
.
lock
);

218 i‡(
ldt_öfo
.
íåy_numbî
 >
mm
->
c⁄ãxt
.
size
) {

219 
îr‹
 = 
	`Æloc_ldt
(&
cuºít
->
mm
->
c⁄ãxt
,

220 
ldt_öfo
.
íåy_numbî
 + 1, 1);

221 i‡(
îr‹
 < 0)

222 
out_u∆ock
;

226 i‡(
ldt_öfo
.
ba£_addr
 =0 &&Üdt_öfo.
limô
 == 0) {

227 i‡(
ﬁdmode
 || 
	`LDT_em±y
(&
ldt_öfo
)) {

228 
	`mem£t
(&
ldt
, 0, (ldt));

229 
ö°Æl
;

233 
	`fûl_ldt
(&
ldt
, &
ldt_öfo
);

234 i‡(
ﬁdmode
)

235 
ldt
.
avl
 = 0;

238 
ö°Æl
:

239 
	`wrôe_ldt_íåy
(
mm
->
c⁄ãxt
.
ldt
, 
ldt_öfo
.
íåy_numbî
, &ldt);

240 
îr‹
 = 0;

242 
out_u∆ock
:

243 
	`muãx_u∆ock
(&
mm
->
c⁄ãxt
.
lock
);

244 
out
:

245  
îr‹
;

246 
	}
}

248 
asmlökage
 
	$sys_modify_ldt
(
func
, 
__u£r
 *
±r
,

249 
byãcou¡
)

251 
ªt
 = -
ENOSYS
;

253 
func
) {

255 
ªt
 = 
	`ªad_ldt
(
±r
, 
byãcou¡
);

258 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 1);

261 
ªt
 = 
	`ªad_deÁu…_ldt
(
±r
, 
byãcou¡
);

264 
ªt
 = 
	`wrôe_ldt
(
±r
, 
byãcou¡
, 0);

267  
ªt
;

268 
	}
}

	@/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c

9 
	~<löux/mm.h
>

10 
	~<löux/kexec.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/gÂ.h
>

13 
	~<löux/ªboŸ.h
>

14 
	~<löux/numa.h
>

15 
	~<löux/·ø˚.h
>

16 
	~<löux/io.h
>

17 
	~<löux/su•íd.h
>

19 
	~<asm/pgèbÀ.h
>

20 
	~<asm/ébÊush.h
>

21 
	~<asm/mmu_c⁄ãxt.h
>

22 
	~<asm/debugªg.h
>

24 
	$öô_⁄e_Àvñ2_∑ge
(
kimage
 *
image
, 
pgd_t
 *
pgd
,

25 
addr
)

27 
pud_t
 *
pud
;

28 
pmd_t
 *
pmd
;

29 
∑ge
 *page;

30 
ªsu…
 = -
ENOMEM
;

32 
addr
 &
PMD_MASK
;

33 
pgd
 +
	`pgd_ödex
(
addr
);

34 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

35 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

36 i‡(!
∑ge
)

37 
out
;

38 
pud
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

39 
	`mem£t
(
pud
, 0, 
PAGE_SIZE
);

40 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

42 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

43 i‡(!
	`pud_¥e£¡
(*
pud
)) {

44 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

45 i‡(!
∑ge
)

46 
out
;

47 
pmd
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

48 
	`mem£t
(
pmd
, 0, 
PAGE_SIZE
);

49 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

51 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

52 i‡(!
	`pmd_¥e£¡
(*
pmd
))

53 
	`£t_pmd
(
pmd
, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

54 
ªsu…
 = 0;

55 
out
:

56  
ªsu…
;

57 
	}
}

59 
	$öô_Àvñ2_∑ge
(
pmd_t
 *
Àvñ2p
, 
addr
)

61 
íd_addr
;

63 
addr
 &
PAGE_MASK
;

64 
íd_addr
 = 
addr
 + 
PUD_SIZE
;

65 
addr
 < 
íd_addr
) {

66 
	`£t_pmd
(
Àvñ2p
++, 
	`__pmd
(
addr
 | 
__PAGE_KERNEL_LARGE_EXEC
));

67 
addr
 +
PMD_SIZE
;

69 
	}
}

71 
	$öô_Àvñ3_∑ge
(
kimage
 *
image
, 
pud_t
 *
Àvñ3p
,

72 
addr
, 
œ°_addr
)

74 
íd_addr
;

75 
ªsu…
;

77 
ªsu…
 = 0;

78 
addr
 &
PAGE_MASK
;

79 
íd_addr
 = 
addr
 + 
PGDIR_SIZE
;

80 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

81 
∑ge
 *page;

82 
pmd_t
 *
Àvñ2p
;

84 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

85 i‡(!
∑ge
) {

86 
ªsu…
 = -
ENOMEM
;

87 
out
;

89 
Àvñ2p
 = (
pmd_t
 *)
	`∑ge_addªss
(
∑ge
);

90 
	`öô_Àvñ2_∑ge
(
Àvñ2p
, 
addr
);

91 
	`£t_pud
(
Àvñ3p
++, 
	`__pud
(
	`__∑
(
Àvñ2p
Ë| 
_KERNPG_TABLE
));

92 
addr
 +
PUD_SIZE
;

95 
addr
 < 
íd_addr
) {

96 
	`pud_˛ór
(
Àvñ3p
++);

97 
addr
 +
PUD_SIZE
;

99 
out
:

100  
ªsu…
;

101 
	}
}

104 
	$öô_Àvñ4_∑ge
(
kimage
 *
image
, 
pgd_t
 *
Àvñ4p
,

105 
addr
, 
œ°_addr
)

107 
íd_addr
;

108 
ªsu…
;

110 
ªsu…
 = 0;

111 
addr
 &
PAGE_MASK
;

112 
íd_addr
 = 
addr
 + (
PTRS_PER_PGD
 * 
PGDIR_SIZE
);

113 (
addr
 < 
œ°_addr
Ë&& (add∏< 
íd_addr
)) {

114 
∑ge
 *page;

115 
pud_t
 *
Àvñ3p
;

117 
∑ge
 = 
	`kimage_Æloc_c⁄åﬁ_∑ges
(
image
, 0);

118 i‡(!
∑ge
) {

119 
ªsu…
 = -
ENOMEM
;

120 
out
;

122 
Àvñ3p
 = (
pud_t
 *)
	`∑ge_addªss
(
∑ge
);

123 
ªsu…
 = 
	`öô_Àvñ3_∑ge
(
image
, 
Àvñ3p
, 
addr
, 
œ°_addr
);

124 i‡(
ªsu…
)

125 
out
;

126 
	`£t_pgd
(
Àvñ4p
++, 
	`__pgd
(
	`__∑
(
Àvñ3p
Ë| 
_KERNPG_TABLE
));

127 
addr
 +
PGDIR_SIZE
;

130 
addr
 < 
íd_addr
) {

131 
	`pgd_˛ór
(
Àvñ4p
++);

132 
addr
 +
PGDIR_SIZE
;

134 
out
:

135  
ªsu…
;

136 
	}
}

138 
	$‰ì_å™sôi⁄_pgèbÀ
(
kimage
 *
image
)

140 
	`‰ì_∑ge
(()
image
->
¨ch
.
pud
);

141 
	`‰ì_∑ge
(()
image
->
¨ch
.
pmd
);

142 
	`‰ì_∑ge
(()
image
->
¨ch
.
±e
);

143 
	}
}

145 
	$öô_å™sôi⁄_pgèbÀ
(
kimage
 *
image
, 
pgd_t
 *
pgd
)

147 
pud_t
 *
pud
;

148 
pmd_t
 *
pmd
;

149 
±e_t
 *
±e
;

150 
vaddr
, 
∑ddr
;

151 
ªsu…
 = -
ENOMEM
;

153 
vaddr
 = ()
ªloˇã_kî√l
;

154 
∑ddr
 = 
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
)+
PAGE_SIZE
);

155 
pgd
 +
	`pgd_ödex
(
vaddr
);

156 i‡(!
	`pgd_¥e£¡
(*
pgd
)) {

157 
pud
 = (
pud_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

158 i‡(!
pud
)

159 
îr
;

160 
image
->
¨ch
.
pud
 =Öud;

161 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
));

163 
pud
 = 
	`pud_off£t
(
pgd
, 
vaddr
);

164 i‡(!
	`pud_¥e£¡
(*
pud
)) {

165 
pmd
 = (
pmd_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

166 i‡(!
pmd
)

167 
îr
;

168 
image
->
¨ch
.
pmd
 =Ömd;

169 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
));

171 
pmd
 = 
	`pmd_off£t
(
pud
, 
vaddr
);

172 i‡(!
	`pmd_¥e£¡
(*
pmd
)) {

173 
±e
 = (
±e_t
 *)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

174 i‡(!
±e
)

175 
îr
;

176 
image
->
¨ch
.
±e
 =Öte;

177 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`__∑
(
±e
Ë| 
_KERNPG_TABLE
));

179 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

180 
	`£t_±e
(
±e
, 
	`p‚_±e
(
∑ddr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_EXEC
));

182 
îr
:

183 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

184  
ªsu…
;

185 
	}
}

188 
	$öô_pgèbÀ
(
kimage
 *
image
, 
°¨t_pgèbÀ
)

190 
pgd_t
 *
Àvñ4p
;

191 
ªsu…
;

192 
Àvñ4p
 = (
pgd_t
 *)
	`__va
(
°¨t_pgèbÀ
);

193 
ªsu…
 = 
	`öô_Àvñ4_∑ge
(
image
, 
Àvñ4p
, 0, 
max_p‚
 << 
PAGE_SHIFT
);

194 i‡(
ªsu…
)

195  
ªsu…
;

200 
ªsu…
 = 
	`öô_⁄e_Àvñ2_∑ge
(
image
, 
Àvñ4p
, image->
°¨t
);

201 i‡(
ªsu…
)

202  
ªsu…
;

203  
	`öô_å™sôi⁄_pgèbÀ
(
image
, 
Àvñ4p
);

204 
	}
}

206 
	$£t_idt
(*
√widt
, 
u16
 
limô
)

208 
desc_±r
 
curidt
;

211 
curidt
.
size
 = 
limô
;

212 
curidt
.
addªss
 = ()
√widt
;

214 
__asm__
 
	`__vﬁ©ûe__
 (

216 : : "m" (
curidt
)

218 
	}
};

221 
	$£t_gdt
(*
√wgdt
, 
u16
 
limô
)

223 
desc_±r
 
curgdt
;

226 
curgdt
.
size
 = 
limô
;

227 
curgdt
.
addªss
 = ()
√wgdt
;

229 
__asm__
 
	`__vﬁ©ûe__
 (

231 : : "m" (
curgdt
)

233 
	}
};

235 
	$lﬂd_£gmíts
()

237 
__asm__
 
	`__vﬁ©ûe__
 (

243 : : "a" (
__KERNEL_DS
) : "memory"

245 
	}
}

247 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

249 
°¨t_pgèbÀ
;

250 
ªsu…
;

253 
°¨t_pgèbÀ
 = 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

256 
ªsu…
 = 
	`öô_pgèbÀ
(
image
, 
°¨t_pgèbÀ
);

257 i‡(
ªsu…
)

258  
ªsu…
;

261 
	}
}

263 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

265 
	`‰ì_å™sôi⁄_pgèbÀ
(
image
);

266 
	}
}

272 
	$machöe_kexec
(
kimage
 *
image
)

274 
∑ge_li°
[
PAGES_NR
];

275 *
c⁄åﬁ_∑ge
;

276 
ßve_·ø˚_íabÀd
;

278 #ifde‡
CONFIG_KEXEC_JUMP


279 i‡(
image
->
¥e£rve_c⁄ãxt
)

280 
	`ßve_¥o˚ss‹_°©e
();

283 
ßve_·ø˚_íabÀd
 = 
	`__·ø˚_íabÀd_ßve
();

286 
	`loˇl_úq_dißbÀ
();

287 
	`hw_bªakpoöt_dißbÀ
();

289 i‡(
image
->
¥e£rve_c⁄ãxt
) {

290 #ifde‡
CONFIG_X86_IO_APIC


298 
	`dißbÀ_IO_APIC
();

302 
c⁄åﬁ_∑ge
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
Ë+ 
PAGE_SIZE
;

303 
	`mem˝y
(
c⁄åﬁ_∑ge
, 
ªloˇã_kî√l
, 
KEXEC_CONTROL_CODE_MAX_SIZE
);

305 
∑ge_li°
[
PA_CONTROL_PAGE
] = 
	`vút_to_phys
(
c⁄åﬁ_∑ge
);

306 
∑ge_li°
[
VA_CONTROL_PAGE
] = ()
c⁄åﬁ_∑ge
;

307 
∑ge_li°
[
PA_TABLE_PAGE
] =

308 ()
	`__∑
(
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
));

310 i‡(
image
->
ty≥
 =
KEXEC_TYPE_DEFAULT
)

311 
∑ge_li°
[
PA_SWAP_PAGE
] = (
	`∑ge_to_p‚
(
image
->
sw≠_∑ge
)

312 << 
PAGE_SHIFT
);

324 
	`lﬂd_£gmíts
();

329 
	`£t_gdt
(
	`phys_to_vút
(0), 0);

330 
	`£t_idt
(
	`phys_to_vút
(0), 0);

333 
image
->
°¨t
 = 
	`ªloˇã_kî√l
(()image->
hód
,

334 ()
∑ge_li°
,

335 
image
->
°¨t
,

336 
image
->
¥e£rve_c⁄ãxt
);

338 #ifde‡
CONFIG_KEXEC_JUMP


339 i‡(
image
->
¥e£rve_c⁄ãxt
)

340 
	`ª°‹e_¥o˚ss‹_°©e
();

343 
	`__·ø˚_íabÀd_ª°‹e
(
ßve_·ø˚_íabÀd
);

344 
	}
}

346 
	$¨ch_¸ash_ßve_vmc‹eöfo
()

348 
	`VMCOREINFO_SYMBOL
(
phys_ba£
);

349 
	`VMCOREINFO_SYMBOL
(
öô_Àvñ4_pgt
);

351 #ifde‡
CONFIG_NUMA


352 
	`VMCOREINFO_SYMBOL
(
node_d©a
);

353 
	`VMCOREINFO_LENGTH
(
node_d©a
, 
MAX_NUMNODES
);

355 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_amd.c

17 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

19 
	~<löux/fúmw¨e.h
>

20 
	~<löux/pci_ids.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/vmÆloc.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/pci.h
>

27 
	~<asm/mi¸ocode.h
>

28 
	~<asm/¥o˚ss‹.h
>

29 
	~<asm/m§.h
>

31 
MODULE_DESCRIPTION
("AMD Microcode Update Driver");

32 
MODULE_AUTHOR
("Peter Oruba");

33 
MODULE_LICENSE
("GPL v2");

35 
	#UCODE_MAGIC
 0x00414d44

	)

36 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

37 
	#UCODE_UCODE_TYPE
 0x00000001

	)

39 
	sequiv_˝u_íåy
 {

40 
u32
 
	mö°ÆÀd_˝u
;

41 
u32
 
	mfixed_îøè_mask
;

42 
u32
 
	mfixed_îøè_com∑ª
;

43 
u16
 
	mequiv_˝u
;

44 
u16
 
	mªs
;

45 } 
__©åibuã__
((
∑cked
));

47 
	smi¸ocode_hódî_amd
 {

48 
u32
 
	md©a_code
;

49 
u32
 
	m∑tch_id
;

50 
u16
 
	mmc_∑tch_d©a_id
;

51 
u8
 
	mmc_∑tch_d©a_Àn
;

52 
u8
 
	möô_Êag
;

53 
u32
 
	mmc_∑tch_d©a_checksum
;

54 
u32
 
	mnb_dev_id
;

55 
u32
 
	msb_dev_id
;

56 
u16
 
	m¥o˚ss‹_ªv_id
;

57 
u8
 
	mnb_ªv_id
;

58 
u8
 
	msb_ªv_id
;

59 
u8
 
	mbios_≠i_ªv
;

60 
u8
 
	mª£rved1
[3];

61 
u32
 
	mm©ch_ªg
[8];

62 } 
__©åibuã__
((
∑cked
));

64 
	smi¸ocode_amd
 {

65 
mi¸ocode_hódî_amd
 
	mhdr
;

66 
	mmpb
[0];

69 
	#UCODE_MAX_SIZE
 2048

	)

70 
	#UCODE_CONTAINER_SECTION_HDR
 8

	)

71 
	#UCODE_CONTAINER_HEADER_SIZE
 12

	)

73 
equiv_˝u_íåy
 *
	gequiv_˝u_èbÀ
;

75 
	$cﬁÀ˘_˝u_öfo_amd
(
˝u
, 
˝u_sig«tuª
 *
csig
)

77 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

78 
u32
 
dummy
;

80 
	`mem£t
(
csig
, 0, (*csig));

81 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
 || c->
x86
 < 0x10) {

82 
	`¥_w¨nög
("microcode: CPU%d: AMD CPU family 0x%xÇot "

83 "suµ‹ãd\n", 
˝u
, 
c
->
x86
);

86 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
csig
->
ªv
, 
dummy
);

87 
	`¥_öfo
("CPU%d:Ö©ch_Àvñ=0x%x\n", 
˝u
, 
csig
->
ªv
);

89 
	}
}

91 
	$gë_m©chög_mi¸ocode
(
˝u
, *
mc
, 
ªv
)

93 
mi¸ocode_hódî_amd
 *
mc_hódî
 = 
mc
;

94 
cuºít_˝u_id
;

95 
u16
 
equiv_˝u_id
 = 0;

96 
i
 = 0;

98 
	`BUG_ON
(
equiv_˝u_èbÀ
 =
NULL
);

99 
cuºít_˝u_id
 = 
	`˝uid_óx
(0x00000001);

101 
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
 != 0) {

102 i‡(
cuºít_˝u_id
 =
equiv_˝u_èbÀ
[
i
].
ö°ÆÀd_˝u
) {

103 
equiv_˝u_id
 = 
equiv_˝u_èbÀ
[
i
].
equiv_˝u
;

106 
i
++;

109 i‡(!
equiv_˝u_id
)

112 i‡(
mc_hódî
->
¥o˚ss‹_ªv_id
 !
equiv_˝u_id
)

116 i‡(
mc_hódî
->
nb_dev_id
 || mc_hódî->
sb_dev_id
) {

117 
	`¥_îr
("CPU%d:Üoading of chipset specific codeÇot yet supported\n",

118 
˝u
);

122 i‡(
mc_hódî
->
∑tch_id
 <
ªv
)

126 
	}
}

128 
	$≠∂y_mi¸ocode_amd
(
˝u
)

130 
u32
 
ªv
, 
dummy
;

131 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

132 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u_num
;

133 
mi¸ocode_amd
 *
mc_amd
 = 
uci
->
mc
;

136 
	`BUG_ON
(
˝u_num
 !
˝u
);

138 i‡(
mc_amd
 =
NULL
)

141 
	`wrm§l
(
MSR_AMD64_PATCH_LOADER
, (
u64
)()&
mc_amd
->
hdr
.
d©a_code
);

143 
	`rdm§
(
MSR_AMD64_PATCH_LEVEL
, 
ªv
, 
dummy
);

146 i‡(
ªv
 !
mc_amd
->
hdr
.
∑tch_id
) {

147 
	`¥_îr
("CPU%d: update failed (forÖatch_level=0x%x)\n",

148 
˝u
, 
mc_amd
->
hdr
.
∑tch_id
);

152 
	`¥_öfo
("CPU%d: upd©ed (√wÖ©ch_Àvñ=0x%x)\n", 
˝u
, 
ªv
);

153 
uci
->
˝u_sig
.
ªv
 =Ñev;

156 
	}
}

158 
	$gë_ucode_d©a
(*
to
, c⁄° 
u8
 *
‰om
, 
size_t
 
n
)

160 
	`mem˝y
(
to
, 
‰om
, 
n
);

162 
	}
}

165 
	$gë_√xt_ucode
(c⁄° 
u8
 *
buf
, 
size
, *
mc_size
)

167 
tŸÆ_size
;

168 
u8
 
£˘i⁄_hdr
[
UCODE_CONTAINER_SECTION_HDR
];

169 *
mc
;

171 i‡(
	`gë_ucode_d©a
(
£˘i⁄_hdr
, 
buf
, 
UCODE_CONTAINER_SECTION_HDR
))

172  
NULL
;

174 i‡(
£˘i⁄_hdr
[0] !
UCODE_UCODE_TYPE
) {

175 
	`¥_îr
("error: invalidÅype field in container file section header\n");

176  
NULL
;

179 
tŸÆ_size
 = (Ë(
£˘i⁄_hdr
[4] + (section_hdr[5] << 8));

181 i‡(
tŸÆ_size
 > 
size
 ||ÅŸÆ_sizê> 
UCODE_MAX_SIZE
) {

182 
	`¥_îr
("error: size mismatch\n");

183  
NULL
;

186 
mc
 = 
	`vmÆloc
(
UCODE_MAX_SIZE
);

187 i‡(
mc
) {

188 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

189 i‡(
	`gë_ucode_d©a
(
mc
, 
buf
 + 
UCODE_CONTAINER_SECTION_HDR
,

190 
tŸÆ_size
)) {

191 
	`v‰ì
(
mc
);

192 
mc
 = 
NULL
;

194 *
mc_size
 = 
tŸÆ_size
 + 
UCODE_CONTAINER_SECTION_HDR
;

196  
mc
;

197 
	}
}

199 
	$ö°Æl_equiv_˝u_èbÀ
(c⁄° 
u8
 *
buf
)

201 
u8
 *
c⁄èöî_hdr
[
UCODE_CONTAINER_HEADER_SIZE
];

202 *
buf_pos
 = (*)
c⁄èöî_hdr
;

203 
size
;

205 i‡(
	`gë_ucode_d©a
(&
c⁄èöî_hdr
, 
buf
, 
UCODE_CONTAINER_HEADER_SIZE
))

208 
size
 = 
buf_pos
[2];

210 i‡(
buf_pos
[1] !
UCODE_EQUIV_CPU_TABLE_TYPE
 || !
size
) {

211 
	`¥_îr
("error: invalidÅype field in container file section header\n");

215 
equiv_˝u_èbÀ
 = (
equiv_˝u_íåy
 *Ë
	`vmÆloc
(
size
);

216 i‡(!
equiv_˝u_èbÀ
) {

217 
	`¥_îr
("failedÅoállocateÉquivalent CPUÅable\n");

221 
buf
 +
UCODE_CONTAINER_HEADER_SIZE
;

222 i‡(
	`gë_ucode_d©a
(
equiv_˝u_èbÀ
, 
buf
, 
size
)) {

223 
	`v‰ì
(
equiv_˝u_èbÀ
);

227  
size
 + 
UCODE_CONTAINER_HEADER_SIZE
;

228 
	}
}

230 
	$‰ì_equiv_˝u_èbÀ
()

232 
	`v‰ì
(
equiv_˝u_èbÀ
);

233 
equiv_˝u_èbÀ
 = 
NULL
;

234 
	}
}

236 
ucode_°©e


237 
	$gíîic_lﬂd_mi¸ocode
(
˝u
, c⁄° 
u8
 *
d©a
, 
size_t
 
size
)

239 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

240 c⁄° 
u8
 *
ucode_±r
 = 
d©a
;

241 *
√w_mc
 = 
NULL
;

242 *
mc
;

243 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

244 
À·ovî
;

245 
off£t
;

246 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

248 
off£t
 = 
	`ö°Æl_equiv_˝u_èbÀ
(
ucode_±r
);

249 i‡(!
off£t
) {

250 
	`¥_îr
("failedÅo createÉquivalent cpuÅable\n");

251  
UCODE_ERROR
;

254 
ucode_±r
 +
off£t
;

255 
À·ovî
 = 
size
 - 
off£t
;

257 
À·ovî
) {

258 
	`unöôülized_v¨
(
mc_size
);

259 
mi¸ocode_hódî_amd
 *
mc_hódî
;

261 
mc
 = 
	`gë_√xt_ucode
(
ucode_±r
, 
À·ovî
, &
mc_size
);

262 i‡(!
mc
)

265 
mc_hódî
 = (
mi¸ocode_hódî_amd
 *)
mc
;

266 i‡(
	`gë_m©chög_mi¸ocode
(
˝u
, 
mc
, 
√w_ªv
)) {

267 
	`v‰ì
(
√w_mc
);

268 
√w_ªv
 = 
mc_hódî
->
∑tch_id
;

269 
√w_mc
 = 
mc
;

271 
	`v‰ì
(
mc
);

273 
ucode_±r
 +
mc_size
;

274 
À·ovî
 -
mc_size
;

277 i‡(
√w_mc
) {

278 i‡(!
À·ovî
) {

279 
	`v‰ì
(
uci
->
mc
);

280 
uci
->
mc
 = 
√w_mc
;

281 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

282 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

284 
	`v‰ì
(
√w_mc
);

285 
°©e
 = 
UCODE_ERROR
;

288 
°©e
 = 
UCODE_NFOUND
;

290 
	`‰ì_equiv_˝u_èbÀ
();

292  
°©e
;

293 
	}
}

295 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

297 c⁄° *
fw_«me
 = "amd-ucode/microcode_amd.bin";

298 c⁄° 
fúmw¨e
 *firmware;

299 
ucode_°©e
 
ªt
;

301 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
fw_«me
, 
devi˚
)) {

302 
	`¥ötk
(
KERN_ERR
 "mi¸ocode: faûedÅÿlﬂd fûê%s\n", 
fw_«me
);

303  
UCODE_NFOUND
;

306 i‡(*(
u32
 *)
fúmw¨e
->
d©a
 !
UCODE_MAGIC
) {

307 
	`¥_îr
("invalid UCODE_MAGIC (0x%08x)\n",

308 *(
u32
 *)
fúmw¨e
->
d©a
);

309  
UCODE_ERROR
;

312 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, 
fúmw¨e
->
d©a
, fúmw¨e->
size
);

314 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

316  
ªt
;

317 
	}
}

319 
ucode_°©e


320 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

322 
	`¥_öfo
("AMD microcode update via /dev/cpu/microcodeÇot supported\n");

323  
UCODE_ERROR
;

324 
	}
}

326 
	$mi¸ocode_föi_˝u_amd
(
˝u
)

328 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

330 
	`v‰ì
(
uci
->
mc
);

331 
uci
->
mc
 = 
NULL
;

332 
	}
}

334 
mi¸ocode_›s
 
	gmi¸ocode_amd_›s
 = {

335 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

336 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

337 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo_amd
,

338 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode_amd
,

339 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u_amd
,

342 
mi¸ocode_›s
 * 
__öô
 
	$öô_amd_mi¸ocode
()

344  &
mi¸ocode_amd_›s
;

345 
	}
}

	@/cmpt816/linux/arch/x86/kernel/microcode_core.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/∂©f‹m_devi˚.h
>

77 
	~<löux/miscdevi˚.h
>

78 
	~<löux/ˇ∑bûôy.h
>

79 
	~<löux/kî√l.h
>

80 
	~<löux/moduÀ.h
>

81 
	~<löux/muãx.h
>

82 
	~<löux/˝u.h
>

83 
	~<löux/fs.h
>

84 
	~<löux/mm.h
>

86 
	~<asm/mi¸ocode.h
>

87 
	~<asm/¥o˚ss‹.h
>

89 
MODULE_DESCRIPTION
("Microcode Update Driver");

90 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

91 
MODULE_LICENSE
("GPL");

93 
	#MICROCODE_VERSION
 "2.00"

	)

95 
mi¸ocode_›s
 *
	gmi¸ocode_›s
;

109 
DEFINE_MUTEX
(
mi¸ocode_muãx
);

111 
ucode_˝u_öfo
 
	gucode_˝u_öfo
[
NR_CPUS
];

112 
EXPORT_SYMBOL_GPL
(
ucode_˝u_öfo
);

118 
	s˝u_öfo_˘x
 {

119 
˝u_sig«tuª
 *
	m˝u_sig
;

120 
	mîr
;

123 
	$cﬁÀ˘_˝u_öfo_loˇl
(*
¨g
)

125 
˝u_öfo_˘x
 *
˘x
 = 
¨g
;

127 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`cﬁÀ˘_˝u_öfo
(
	`smp_¥o˚ss‹_id
(),

128 
˘x
->
˝u_sig
);

129 
	}
}

131 
	$cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, 
˝u_sig«tuª
 *
˝u_sig
)

133 
˝u_öfo_˘x
 
˘x
 = { .
˝u_sig
 = cpu_sig, .
îr
 = 0 };

134 
ªt
;

136 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
cﬁÀ˘_˝u_öfo_loˇl
, &
˘x
, 1);

137 i‡(!
ªt
)

138 
ªt
 = 
˘x
.
îr
;

140  
ªt
;

141 
	}
}

143 
	$cﬁÀ˘_˝u_öfo
(
˝u
)

145 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

146 
ªt
;

148 
	`mem£t
(
uci
, 0, (*uci));

150 
ªt
 = 
	`cﬁÀ˘_˝u_öfo_⁄_èrgë
(
˝u
, &
uci
->
˝u_sig
);

151 i‡(!
ªt
)

152 
uci
->
vÆid
 = 1;

154  
ªt
;

155 
	}
}

157 
	s≠∂y_mi¸ocode_˘x
 {

158 
	mîr
;

161 
	$≠∂y_mi¸ocode_loˇl
(*
¨g
)

163 
≠∂y_mi¸ocode_˘x
 *
˘x
 = 
¨g
;

165 
˘x
->
îr
 = 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
	`smp_¥o˚ss‹_id
());

166 
	}
}

168 
	$≠∂y_mi¸ocode_⁄_èrgë
(
˝u
)

170 
≠∂y_mi¸ocode_˘x
 
˘x
 = { .
îr
 = 0 };

171 
ªt
;

173 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
≠∂y_mi¸ocode_loˇl
, &
˘x
, 1);

174 i‡(!
ªt
)

175 
ªt
 = 
˘x
.
îr
;

177  
ªt
;

178 
	}
}

180 #ifde‡
CONFIG_MICROCODE_OLD_INTERFACE


181 
	$do_mi¸ocode_upd©e
(c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

183 
îr‹
 = 0;

184 
˝u
;

186 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

187 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

188 
ucode_°©e
 
u°©e
;

190 i‡(!
uci
->
vÆid
)

193 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_u£r
(
˝u
, 
buf
, 
size
);

194 i‡(
u°©e
 =
UCODE_ERROR
) {

195 
îr‹
 = -1;

197 } i‡(
u°©e
 =
UCODE_OK
)

198 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

201  
îr‹
;

202 
	}
}

204 
	$mi¸ocode_›í
(
öode
 *öode, 
fûe
 *file)

206  
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
Ë? 
	`n⁄£ekabÀ_›í
(
öode
, 
fûe
Ë: -
EPERM
;

207 
	}
}

209 
ssize_t
 
	$mi¸ocode_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

210 
size_t
 
Àn
, 
loff_t
 *
µos
)

212 
ssize_t
 
ªt
 = -
EINVAL
;

214 i‡((
Àn
 >> 
PAGE_SHIFT
Ë> 
tŸÆøm_∑ges
) {

215 
	`¥_îr
("toÿmuch d©®(max %ldÖages)\n", 
tŸÆøm_∑ges
);

216  
ªt
;

219 
	`gë_⁄löe_˝us
();

220 
	`muãx_lock
(&
mi¸ocode_muãx
);

222 i‡(
	`do_mi¸ocode_upd©e
(
buf
, 
Àn
) == 0)

223 
ªt
 = (
ssize_t
)
Àn
;

225 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

226 
	`put_⁄löe_˝us
();

228  
ªt
;

229 
	}
}

231 c⁄° 
fûe_›î©i⁄s
 
	gmi¸ocode_f›s
 = {

232 .
ow√r
 = 
THIS_MODULE
,

233 .
	gwrôe
 = 
mi¸ocode_wrôe
,

234 .
	g›í
 = 
mi¸ocode_›í
,

237 
miscdevi˚
 
	gmi¸ocode_dev
 = {

238 .
mö‹
 = 
MICROCODE_MINOR
,

239 .
	g«me
 = "microcode",

240 .
	gnodíame
 = "cpu/microcode",

241 .
	gf›s
 = &
mi¸ocode_f›s
,

244 
__öô
 
	$mi¸ocode_dev_öô
()

246 
îr‹
;

248 
îr‹
 = 
	`misc_ªgi°î
(&
mi¸ocode_dev
);

249 i‡(
îr‹
) {

250 
	`¥_îr
("ˇn'àmisc_ªgi°î o¿mö‹=%d\n", 
MICROCODE_MINOR
);

251  
îr‹
;

255 
	}
}

257 
	$mi¸ocode_dev_exô
()

259 
	`misc_dîegi°î
(&
mi¸ocode_dev
);

260 
	}
}

262 
MODULE_ALIAS_MISCDEV
(
MICROCODE_MINOR
);

263 
MODULE_ALIAS
("devname:cpu/microcode");

265 
	#mi¸ocode_dev_öô
(Ë0

	)

266 
	#mi¸ocode_dev_exô
(Ëdÿ{ } 0)

	)

270 
∂©f‹m_devi˚
 *
	gmi¸ocode_pdev
;

272 
	$ªlﬂd_f‹_˝u
(
˝u
)

274 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

275 
îr
 = 0;

277 
	`muãx_lock
(&
mi¸ocode_muãx
);

278 i‡(
uci
->
vÆid
) {

279 
ucode_°©e
 
u°©e
;

281 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

282 i‡(
u°©e
 =
UCODE_OK
)

283 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

285 i‡(
u°©e
 =
UCODE_ERROR
)

286 
îr
 = -
EINVAL
;

288 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

290  
îr
;

291 
	}
}

293 
ssize_t
 
	$ªlﬂd_°‹e
(
sys_devi˚
 *
dev
,

294 
sysdev_©åibuã
 *
©å
,

295 c⁄° *
buf
, 
size_t
 
size
)

297 
vÆ
;

298 
˝u
 = 
dev
->
id
;

299 
ªt
 = 0;

300 *
íd
;

302 
vÆ
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

303 i‡(
íd
 =
buf
)

304  -
EINVAL
;

306 i‡(
vÆ
 == 1) {

307 
	`gë_⁄löe_˝us
();

308 i‡(
	`˝u_⁄löe
(
˝u
))

309 
ªt
 = 
	`ªlﬂd_f‹_˝u
(
˝u
);

310 
	`put_⁄löe_˝us
();

313 i‡(!
ªt
)

314 
ªt
 = 
size
;

316  
ªt
;

317 
	}
}

319 
ssize_t
 
	$vîsi⁄_show
(
sys_devi˚
 *
dev
,

320 
sysdev_©åibuã
 *
©å
, *
buf
)

322 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

324  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
ªv
);

325 
	}
}

327 
ssize_t
 
	$pf_show
(
sys_devi˚
 *
dev
,

328 
sysdev_©åibuã
 *
©å
, *
buf
)

330 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
dev
->
id
;

332  
	`•rötf
(
buf
, "0x%x\n", 
uci
->
˝u_sig
.
pf
);

333 
	}
}

335 
SYSDEV_ATTR
(
ªlﬂd
, 0200, 
NULL
, 
ªlﬂd_°‹e
);

336 
SYSDEV_ATTR
(
vîsi⁄
, 0400, 
vîsi⁄_show
, 
NULL
);

337 
SYSDEV_ATTR
(
¥o˚ss‹_Êags
, 0400, 
pf_show
, 
NULL
);

339 
©åibuã
 *
	gmc_deÁu…_©ås
[] = {

340 &
©å_ªlﬂd
.
©å
,

341 &
©å_vîsi⁄
.
©å
,

342 &
©å_¥o˚ss‹_Êags
.
©å
,

343 
NULL


346 
©åibuã_group
 
	gmc_©å_group
 = {

347 .
©ås
 = 
mc_deÁu…_©ås
,

348 .
	g«me
 = "microcode",

351 
	$mi¸ocode_föi_˝u
(
˝u
)

353 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

355 
mi¸ocode_›s
->
	`mi¸ocode_föi_˝u
(
˝u
);

356 
uci
->
vÆid
 = 0;

357 
	}
}

359 
ucode_°©e
 
	$mi¸ocode_ªsume_˝u
(
˝u
)

361 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

363 i‡(!
uci
->
mc
)

364  
UCODE_NFOUND
;

366 
	`¥_debug
("CPU%d upd©ed up⁄Ñesume\n", 
˝u
);

367 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

369  
UCODE_OK
;

370 
	}
}

372 
ucode_°©e
 
	$mi¸ocode_öô_˝u
(
˝u
)

374 
ucode_°©e
 
u°©e
;

376 i‡(
	`cﬁÀ˘_˝u_öfo
(
˝u
))

377  
UCODE_ERROR
;

380 i‡(
sy°em_°©e
 !
SYSTEM_RUNNING
)

381  
UCODE_NFOUND
;

383 
u°©e
 = 
mi¸ocode_›s
->
	`ªque°_mi¸ocode_fw
(
˝u
, &
mi¸ocode_pdev
->
dev
);

385 i‡(
u°©e
 =
UCODE_OK
) {

386 
	`¥_debug
("CPU%d upd©ed up⁄ inô\n", 
˝u
);

387 
	`≠∂y_mi¸ocode_⁄_èrgë
(
˝u
);

390  
u°©e
;

391 
	}
}

393 
ucode_°©e
 
	$mi¸ocode_upd©e_˝u
(
˝u
)

395 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

396 
ucode_°©e
 
u°©e
;

398 i‡(
uci
->
vÆid
)

399 
u°©e
 = 
	`mi¸ocode_ªsume_˝u
(
˝u
);

401 
u°©e
 = 
	`mi¸ocode_öô_˝u
(
˝u
);

403  
u°©e
;

404 
	}
}

406 
	$mc_sysdev_add
(
sys_devi˚
 *
sys_dev
)

408 
îr
, 
˝u
 = 
sys_dev
->
id
;

410 i‡(!
	`˝u_⁄löe
(
˝u
))

413 
	`¥_debug
("CPU%dádded\n", 
˝u
);

415 
îr
 = 
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

416 i‡(
îr
)

417  
îr
;

419 i‡(
	`mi¸ocode_öô_˝u
(
˝u
Ë=
UCODE_ERROR
)

420 
îr
 = -
EINVAL
;

422  
îr
;

423 
	}
}

425 
	$mc_sysdev_ªmove
(
sys_devi˚
 *
sys_dev
)

427 
˝u
 = 
sys_dev
->
id
;

429 i‡(!
	`˝u_⁄löe
(
˝u
))

432 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

433 
	`mi¸ocode_föi_˝u
(
˝u
);

434 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

436 
	}
}

438 
	$mc_sysdev_ªsume
(
sys_devi˚
 *
dev
)

440 
˝u
 = 
dev
->
id
;

441 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

443 i‡(!
	`˝u_⁄löe
(
˝u
))

453 
	`WARN_ON
(
˝u
 != 0);

455 i‡(
uci
->
vÆid
 && uci->
mc
)

456 
mi¸ocode_›s
->
	`≠∂y_mi¸ocode
(
˝u
);

459 
	}
}

461 
sysdev_drivî
 
	gmc_sysdev_drivî
 = {

462 .
add
 = 
mc_sysdev_add
,

463 .
	gªmove
 = 
mc_sysdev_ªmove
,

464 .
	gªsume
 = 
mc_sysdev_ªsume
,

467 
__˝uöô
 

468 
	$mc_˝u_ˇŒback
(
nŸifõr_block
 *
nb
, 
a˘i⁄
, *
h˝u
)

470 
˝u
 = ()
h˝u
;

471 
sys_devi˚
 *
sys_dev
;

473 
sys_dev
 = 
	`gë_˝u_sysdev
(
˝u
);

474 
a˘i⁄
) {

475 
CPU_ONLINE
:

476 
CPU_ONLINE_FROZEN
:

477 
	`mi¸ocode_upd©e_˝u
(
˝u
);

478 
CPU_DOWN_FAILED
:

479 
CPU_DOWN_FAILED_FROZEN
:

480 
	`¥_debug
("CPU%dádded\n", 
˝u
);

481 i‡(
	`sysfs_¸óã_group
(&
sys_dev
->
kobj
, &
mc_©å_group
))

482 
	`¥_îr
("FaûedÅÿ¸óã grou∞f‹ CPU%d\n", 
˝u
);

484 
CPU_DOWN_PREPARE
:

485 
CPU_DOWN_PREPARE_FROZEN
:

487 
	`sysfs_ªmove_group
(&
sys_dev
->
kobj
, &
mc_©å_group
);

488 
	`¥_debug
("CPU%dÑemoved\n", 
˝u
);

490 
CPU_DEAD
:

491 
CPU_UP_CANCELED_FROZEN
:

493 
	`mi¸ocode_föi_˝u
(
˝u
);

496  
NOTIFY_OK
;

497 
	}
}

499 
nŸifõr_block
 
__ªfd©a
 
	gmc_˝u_nŸifõr
 = {

500 .
nŸifõr_ˇŒ
 = 
mc_˝u_ˇŒback
,

503 
__öô
 
	$mi¸ocode_öô
()

505 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(0);

506 
îr‹
;

508 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_INTEL
)

509 
mi¸ocode_›s
 = 
	`öô_öãl_mi¸ocode
();

510 i‡(
c
->
x86_víd‹
 =
X86_VENDOR_AMD
)

511 
mi¸ocode_›s
 = 
	`öô_amd_mi¸ocode
();

513 i‡(!
mi¸ocode_›s
) {

514 
	`¥_îr
("no support forÅhis CPU vendor\n");

515  -
ENODEV
;

518 
mi¸ocode_pdev
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("microcode", -1,

519 
NULL
, 0);

520 i‡(
	`IS_ERR
(
mi¸ocode_pdev
)) {

521 
	`mi¸ocode_dev_exô
();

522  
	`PTR_ERR
(
mi¸ocode_pdev
);

525 
	`gë_⁄löe_˝us
();

526 
	`muãx_lock
(&
mi¸ocode_muãx
);

528 
îr‹
 = 
	`sysdev_drivî_ªgi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

530 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

531 
	`put_⁄löe_˝us
();

533 i‡(
îr‹
) {

534 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

535  
îr‹
;

538 
îr‹
 = 
	`mi¸ocode_dev_öô
();

539 i‡(
îr‹
)

540  
îr‹
;

542 
	`ªgi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

544 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION


548 
	}
}

549 
moduÀ_öô
(
mi¸ocode_öô
);

551 
__exô
 
	$mi¸ocode_exô
()

553 
	`mi¸ocode_dev_exô
();

555 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
mc_˝u_nŸifõr
);

557 
	`gë_⁄löe_˝us
();

558 
	`muãx_lock
(&
mi¸ocode_muãx
);

560 
	`sysdev_drivî_uƒegi°î
(&
˝u_sysdev_˛ass
, &
mc_sysdev_drivî
);

562 
	`muãx_u∆ock
(&
mi¸ocode_muãx
);

563 
	`put_⁄löe_˝us
();

565 
	`∂©f‹m_devi˚_uƒegi°î
(
mi¸ocode_pdev
);

567 
mi¸ocode_›s
 = 
NULL
;

569 
	`¥_öfo
("Mi¸ocodêUpd©êDrivî: v" 
MICROCODE_VERSION
 "Ñemoved.\n");

570 
	}
}

571 
moduÀ_exô
(
mi¸ocode_exô
);

	@/cmpt816/linux/arch/x86/kernel/microcode_intel.c

74 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

76 
	~<löux/fúmw¨e.h
>

77 
	~<löux/uac˚ss.h
>

78 
	~<löux/kî√l.h
>

79 
	~<löux/moduÀ.h
>

80 
	~<löux/vmÆloc.h
>

82 
	~<asm/mi¸ocode.h
>

83 
	~<asm/¥o˚ss‹.h
>

84 
	~<asm/m§.h
>

86 
MODULE_DESCRIPTION
("Microcode Update Driver");

87 
MODULE_AUTHOR
("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");

88 
MODULE_LICENSE
("GPL");

90 
	smi¸ocode_hódî_öãl
 {

91 
	mhdrvî
;

92 
	mªv
;

93 
	md©e
;

94 
	msig
;

95 
	mcksum
;

96 
	mldrvî
;

97 
	mpf
;

98 
	md©asize
;

99 
	mtŸÆsize
;

100 
	mª£rved
[3];

103 
	smi¸ocode_öãl
 {

104 
mi¸ocode_hódî_öãl
 
	mhdr
;

105 
	mbôs
[0];

109 
	sexãnded_sig«tuª
 {

110 
	msig
;

111 
	mpf
;

112 
	mcksum
;

115 
	sexãnded_sigèbÀ
 {

116 
	mcou¡
;

117 
	mcksum
;

118 
	mª£rved
[3];

119 
exãnded_sig«tuª
 
	msigs
[0];

122 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

123 
	#MC_HEADER_SIZE
 ((
mi¸ocode_hódî_öãl
))

	)

124 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

125 
	#EXT_HEADER_SIZE
 ((
exãnded_sigèbÀ
))

	)

126 
	#EXT_SIGNATURE_SIZE
 ((
exãnded_sig«tuª
))

	)

127 
	#DWSIZE
 ((
u32
))

	)

129 
	#gë_tŸÆsize
(
mc
) \

130 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 ? \

131 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
tŸÆsize
 : \

132 
DEFAULT_UCODE_TOTALSIZE
)

	)

134 
	#gë_d©asize
(
mc
) \

135 (((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 ? \

136 ((
mi¸ocode_öãl
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

138 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

139 (((
s1
Ë=(
s2
)Ë&& (((
p1
Ë& (
p2
)Ë|| ((’1Ë=0Ë&& (’2Ë=0))))

	)

141 
	#exâabÀ_size
(
ë
Ë(”t)->
cou¡
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

143 
	$cﬁÀ˘_˝u_öfo
(
˝u_num
, 
˝u_sig«tuª
 *
csig
)

145 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u_num
);

146 
vÆ
[2];

148 
	`mem£t
(
csig
, 0, (*csig));

150 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_INTEL
 || c->
x86
 < 6 ||

151 
	`˝u_has
(
c
, 
X86_FEATURE_IA64
)) {

152 
	`¥_îr
("CPU%dÇŸá c≠abÀ I¡ñÖro˚ss‹\n", 
˝u_num
);

156 
csig
->
sig
 = 
	`˝uid_óx
(0x00000001);

158 i‡((
c
->
x86_modñ
 >5Ë|| (c->
x86
 > 6)) {

160 
	`rdm§
(
MSR_IA32_PLATFORM_ID
, 
vÆ
[0], val[1]);

161 
csig
->
pf
 = 1 << ((
vÆ
[1] >> 18) & 7);

164 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

166 
	`sync_c‹e
();

168 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], 
csig
->
ªv
);

170 
	`¥_öfo
("CPU%d sig=0x%x,Öf=0x%x,Ñevision=0x%x\n",

171 
˝u_num
, 
csig
->
sig
, csig->
pf
, csig->
ªv
);

174 
	}
}

176 
ölöe
 
	$upd©e_m©ch_˝u
(
˝u_sig«tuª
 *
csig
, 
sig
, 
pf
)

178  (!
	`sigm©ch
(
sig
, 
csig
->sig, 
pf
, csig->pf)) ? 0 : 1;

179 
	}
}

181 
ölöe
 

182 
	$upd©e_m©ch_ªvisi⁄
(
mi¸ocode_hódî_öãl
 *
mc_hódî
, 
ªv
)

184  (
mc_hódî
->
ªv
 <=Ñev) ? 0 : 1;

185 
	}
}

187 
	$mi¸ocode_ßnôy_check
(*
mc
)

189 
tŸÆ_size
, 
d©a_size
, 
ext_èbÀ_size
;

190 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

191 
exãnded_sigèbÀ
 *
ext_hódî
 = 
NULL
;

192 
sum
, 
‹ig_sum
, 
ext_sigcou¡
 = 0, 
i
;

193 
exãnded_sig«tuª
 *
ext_sig
;

195 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

196 
d©a_size
 = 
	`gë_d©asize
(
mc_hódî
);

198 i‡(
d©a_size
 + 
MC_HEADER_SIZE
 > 
tŸÆ_size
) {

199 
	`¥_îr
("error! Bad data size in microcode data file\n");

200  -
EINVAL
;

203 i‡(
mc_hódî
->
ldrvî
 !1 || mc_hódî->
hdrvî
 != 1) {

204 
	`¥_îr
("error! Unknown microcode update format\n");

205  -
EINVAL
;

207 
ext_èbÀ_size
 = 
tŸÆ_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

208 i‡(
ext_èbÀ_size
) {

209 i‡((
ext_èbÀ_size
 < 
EXT_HEADER_SIZE
)

210 || ((
ext_èbÀ_size
 - 
EXT_HEADER_SIZE
Ë% 
EXT_SIGNATURE_SIZE
)) {

211 
	`¥_îr
("error! SmallÉxttable size in microcode data file\n");

212  -
EINVAL
;

214 
ext_hódî
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

215 i‡(
ext_èbÀ_size
 !
	`exâabÀ_size
(
ext_hódî
)) {

216 
	`¥_îr
("error! BadÉxttable size in microcode data file\n");

217  -
EFAULT
;

219 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

223 i‡(
ext_èbÀ_size
) {

224 
ext_èbÀ_sum
 = 0;

225 *
ext_èbÀp
 = (*)
ext_hódî
;

227 
i
 = 
ext_èbÀ_size
 / 
DWSIZE
;

228 
i
--)

229 
ext_èbÀ_sum
 +
ext_èbÀp
[
i
];

230 i‡(
ext_èbÀ_sum
) {

231 
	`¥_w¨nög
("aborting, badÉxtended signatureÅable checksum\n");

232  -
EINVAL
;

237 
‹ig_sum
 = 0;

238 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
Ë/ 
DWSIZE
;

239 
i
--)

240 
‹ig_sum
 +((*)
mc
)[
i
];

241 i‡(
‹ig_sum
) {

242 
	`¥_îr
("aborting, bad checksum\n");

243  -
EINVAL
;

245 i‡(!
ext_èbÀ_size
)

248 
i
 = 0; i < 
ext_sigcou¡
; i++) {

249 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
 +

250 
EXT_SIGNATURE_SIZE
 * 
i
;

251 
sum
 = 
‹ig_sum


252 - (
mc_hódî
->
sig
 + mc_hódî->
pf
 + mc_hódî->
cksum
)

253 + (
ext_sig
->
sig
 +Éxt_sig->
pf
 +Éxt_sig->
cksum
);

254 i‡(
sum
) {

255 
	`¥_îr
("aborting, bad checksum\n");

256  -
EINVAL
;

260 
	}
}

267 
	$gë_m©chög_mi¸ocode
(
˝u_sig«tuª
 *
˝u_sig
, *
mc
, 
ªv
)

269 
mi¸ocode_hódî_öãl
 *
mc_hódî
 = 
mc
;

270 
exãnded_sigèbÀ
 *
ext_hódî
;

271 
tŸÆ_size
 = 
	`gë_tŸÆsize
(
mc_hódî
);

272 
ext_sigcou¡
, 
i
;

273 
exãnded_sig«tuª
 *
ext_sig
;

275 i‡(!
	`upd©e_m©ch_ªvisi⁄
(
mc_hódî
, 
ªv
))

278 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
mc_hódî
->
sig
, mc_hódî->
pf
))

282 i‡(
tŸÆ_size
 <
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
)

285 
ext_hódî
 = 
mc
 + 
	`gë_d©asize
(
mc_hódî
Ë+ 
MC_HEADER_SIZE
;

286 
ext_sigcou¡
 = 
ext_hódî
->
cou¡
;

287 
ext_sig
 = (*)
ext_hódî
 + 
EXT_HEADER_SIZE
;

289 
i
 = 0; i < 
ext_sigcou¡
; i++) {

290 i‡(
	`upd©e_m©ch_˝u
(
˝u_sig
, 
ext_sig
->
sig
,Éxt_sig->
pf
))

292 
ext_sig
++;

295 
	}
}

297 
	$≠∂y_mi¸ocode
(
˝u
)

299 
mi¸ocode_öãl
 *
mc_öãl
;

300 
ucode_˝u_öfo
 *
uci
;

301 
vÆ
[2];

302 
˝u_num
;

304 
˝u_num
 = 
	`øw_smp_¥o˚ss‹_id
();

305 
uci
 = 
ucode_˝u_öfo
 + 
˝u
;

306 
mc_öãl
 = 
uci
->
mc
;

309 
	`BUG_ON
(
˝u_num
 !
˝u
);

311 i‡(
mc_öãl
 =
NULL
)

315 
	`wrm§
(
MSR_IA32_UCODE_WRITE
,

316 (Ë
mc_öãl
->
bôs
,

317 (Ë
mc_öãl
->
bôs
 >> 16 >> 16);

318 
	`wrm§
(
MSR_IA32_UCODE_REV
, 0, 0);

321 
	`sync_c‹e
();

324 
	`rdm§
(
MSR_IA32_UCODE_REV
, 
vÆ
[0], val[1]);

326 i‡(
vÆ
[1] !
mc_öãl
->
hdr
.
ªv
) {

327 
	`¥_îr
("CPU%d updateÅoÑevision 0x%x failed\n",

328 
˝u_num
, 
mc_öãl
->
hdr
.
ªv
);

331 
	`¥_öfo
("CPU%d updatedÅoÑevision 0x%x, date = %04x-%02x-%02x\n",

332 
˝u_num
, 
vÆ
[1],

333 
mc_öãl
->
hdr
.
d©e
 & 0xffff,

334 
mc_öãl
->
hdr
.
d©e
 >> 24,

335 (
mc_öãl
->
hdr
.
d©e
 >> 16) & 0xff);

337 
uci
->
˝u_sig
.
ªv
 = 
vÆ
[1];

340 
	}
}

342 
ucode_°©e
 
gíîic_lﬂd_mi¸ocode
(
˝u
, *
d©a
, 
size_t
 
size
,

343 (*
gë_ucode_d©a
)(*, c⁄° *, 
size_t
))

345 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

346 
u8
 *
ucode_±r
 = 
d©a
, *
√w_mc
 = 
NULL
, *
mc
 = NULL;

347 
√w_ªv
 = 
uci
->
˝u_sig
.
ªv
;

348 
À·ovî
 = 
size
;

349 
ucode_°©e
 
°©e
 = 
UCODE_OK
;

350 
cuº_mc_size
 = 0;

352 
À·ovî
) {

353 
mi¸ocode_hódî_öãl
 
mc_hódî
;

354 
mc_size
;

356 i‡(
	`gë_ucode_d©a
(&
mc_hódî
, 
ucode_±r
, (mc_header)))

359 
mc_size
 = 
	`gë_tŸÆsize
(&
mc_hódî
);

360 i‡(!
mc_size
 || mc_sizê> 
À·ovî
) {

361 
	`¥_îr
("error! Bad data in microcode data file\n");

366 i‡(!
mc
 || 
mc_size
 > 
cuº_mc_size
) {

367 i‡(
mc
)

368 
	`v‰ì
(
mc
);

369 
mc
 = 
	`vmÆloc
(
mc_size
);

370 i‡(!
mc
)

372 
cuº_mc_size
 = 
mc_size
;

375 i‡(
	`gë_ucode_d©a
(
mc
, 
ucode_±r
, 
mc_size
) ||

376 
	`mi¸ocode_ßnôy_check
(
mc
) < 0) {

377 
	`v‰ì
(
mc
);

381 i‡(
	`gë_m©chög_mi¸ocode
(&
uci
->
˝u_sig
, 
mc
, 
√w_ªv
)) {

382 i‡(
√w_mc
)

383 
	`v‰ì
(
√w_mc
);

384 
√w_ªv
 = 
mc_hódî
.
ªv
;

385 
√w_mc
 = 
mc
;

386 
mc
 = 
NULL
;

389 
ucode_±r
 +
mc_size
;

390 
À·ovî
 -
mc_size
;

393 i‡(
mc
)

394 
	`v‰ì
(
mc
);

396 i‡(
À·ovî
) {

397 i‡(
√w_mc
)

398 
	`v‰ì
(
√w_mc
);

399 
°©e
 = 
UCODE_ERROR
;

400 
out
;

403 i‡(!
√w_mc
) {

404 
°©e
 = 
UCODE_NFOUND
;

405 
out
;

408 i‡(
uci
->
mc
)

409 
	`v‰ì
(
uci
->
mc
);

410 
uci
->
mc
 = (
mi¸ocode_öãl
 *)
√w_mc
;

412 
	`¥_debug
("CPU%d foundá matching microcode update with version 0x%x (current=0x%x)\n",

413 
˝u
, 
√w_ªv
, 
uci
->
˝u_sig
.
ªv
);

414 
out
:

415  
°©e
;

416 
	}
}

418 
	$gë_ucode_fw
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

420 
	`mem˝y
(
to
, 
‰om
, 
n
);

422 
	}
}

424 
ucode_°©e
 
	$ªque°_mi¸ocode_fw
(
˝u
, 
devi˚
 *device)

426 
«me
[30];

427 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

428 c⁄° 
fúmw¨e
 *firmware;

429 
ucode_°©e
 
ªt
;

431 
	`•rötf
(
«me
, "intel-ucode/%02x-%02x-%02x",

432 
c
->
x86
, c->
x86_modñ
, c->
x86_mask
);

434 i‡(
	`ªque°_fúmw¨e
(&
fúmw¨e
, 
«me
, 
devi˚
)) {

435 
	`¥_debug
("d©®fûê%†lﬂd faûed\n", 
«me
);

436  
UCODE_NFOUND
;

439 
ªt
 = 
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
fúmw¨e
->
d©a
,

440 
fúmw¨e
->
size
, &
gë_ucode_fw
);

442 
	`ªÀa£_fúmw¨e
(
fúmw¨e
);

444  
ªt
;

445 
	}
}

447 
	$gë_ucode_u£r
(*
to
, c⁄° *
‰om
, 
size_t
 
n
)

449  
	`c›y_‰om_u£r
(
to
, 
‰om
, 
n
);

450 
	}
}

452 
ucode_°©e


453 
	$ªque°_mi¸ocode_u£r
(
˝u
, c⁄° 
__u£r
 *
buf
, 
size_t
 
size
)

455  
	`gíîic_lﬂd_mi¸ocode
(
˝u
, (*)
buf
, 
size
, &
gë_ucode_u£r
);

456 
	}
}

458 
	$mi¸ocode_föi_˝u
(
˝u
)

460 
ucode_˝u_öfo
 *
uci
 = ucode_˝u_öfÿ+ 
˝u
;

462 
	`v‰ì
(
uci
->
mc
);

463 
uci
->
mc
 = 
NULL
;

464 
	}
}

466 
mi¸ocode_›s
 
	gmi¸ocode_öãl_›s
 = {

467 .
ªque°_mi¸ocode_u£r
 =Ñequest_microcode_user,

468 .
	gªque°_mi¸ocode_fw
 = 
ªque°_mi¸ocode_fw
,

469 .
	gcﬁÀ˘_˝u_öfo
 = 
cﬁÀ˘_˝u_öfo
,

470 .
	g≠∂y_mi¸ocode
 = 
≠∂y_mi¸ocode
,

471 .
	gmi¸ocode_föi_˝u
 = 
mi¸ocode_föi_˝u
,

474 
mi¸ocode_›s
 * 
__öô
 
	$öô_öãl_mi¸ocode
()

476  &
mi¸ocode_öãl_›s
;

477 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/dmi.h
>

10 
	~<löux/ønge.h
>

12 
	~<asm/pci-dúe˘.h
>

13 
	~<löux/s‹t.h
>

14 
	~<asm/io.h
>

15 
	~<asm/m§.h
>

16 
	~<asm/a˝i.h
>

17 
	~<asm/mmc⁄fig.h
>

18 
	~<asm/pci_x86.h
>

20 
	spci_ho°bridge_¥obe
 {

21 
u32
 
	mbus
;

22 
u32
 
	m¶Ÿ
;

23 
u32
 
	mvíd‹
;

24 
u32
 
	mdevi˚
;

27 
u64
 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£
;

28 
__˝uöôd©a
 
	gÁm10h_pci_mmc⁄f_ba£_°©us
;

30 
pci_ho°bridge_¥obe
 
	gpci_¥obes
[] 
	g__˝uöôd©a
 = {

31 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

32 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

35 
__˝uöô
 
	$cmp_ønge
(c⁄° *
x1
, c⁄° *
x2
)

37 c⁄° 
ønge
 *
r1
 = 
x1
;

38 c⁄° 
ønge
 *
r2
 = 
x2
;

39 
°¨t1
, 
°¨t2
;

41 
°¨t1
 = 
r1
->
°¨t
 >> 32;

42 
°¨t2
 = 
r2
->
°¨t
 >> 32;

44  
°¨t1
 - 
°¨t2
;

45 
	}
}

49 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

50 
	#BASE_VALID
(
b
Ë((b !(0xfdULL << 32)Ë&& (b !(0x„ULL << 32)))

	)

51 
__˝uöô
 
	$gë_Ám10h_pci_mmc⁄f_ba£
()

53 
i
;

54 
bus
;

55 
¶Ÿ
;

56 
found
;

58 
u64
 
vÆ
;

59 
u32
 
addªss
;

60 
u64
 
tom2
;

61 
u64
 
ba£
 = 
FAM10H_PCI_MMCONF_BASE
;

63 
hi_mmio_num
;

64 
ønge
Ñange[8];

68 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
)

71 i‡(!
	`óæy_pci_Ælowed
())

72 
Áû
;

74 
found
 = 0;

75 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_¥obes
); i++) {

76 
u32
 
id
;

77 
u16
 
devi˚
;

78 
u16
 
víd‹
;

80 
bus
 = 
pci_¥obes
[
i
].bus;

81 
¶Ÿ
 = 
pci_¥obes
[
i
].slot;

82 
id
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 0, 
PCI_VENDOR_ID
);

84 
víd‹
 = 
id
 & 0xffff;

85 
devi˚
 = (
id
>>16) & 0xffff;

86 i‡(
pci_¥obes
[
i
].
víd‹
 == vendor &&

87 
pci_¥obes
[
i
].
devi˚
 == device) {

88 
found
 = 1;

93 i‡(!
found
)

94 
Áû
;

97 
addªss
 = 
MSR_K8_SYSCFG
;

98 
	`rdm§l
(
addªss
, 
vÆ
);

101 i‡(!(
vÆ
 & (1<<21))) {

102 
tom2
 = 0;

105 
addªss
 = 
MSR_K8_TOP_MEM2
;

106 
	`rdm§l
(
addªss
, 
vÆ
);

107 
tom2
 = 
vÆ
 & (0xffffULL<<32);

110 i‡(
ba£
 <
tom2
)

111 
ba£
 = 
tom2
 + (1ULL<<32);

117 
hi_mmio_num
 = 0;

118 
i
 = 0; i < 8; i++) {

119 
u32
 
ªg
;

120 
u64
 
°¨t
;

121 
u64
 
íd
;

122 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x80 + (
i
 << 3));

123 i‡(!(
ªg
 & 3))

126 
°¨t
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

127 
ªg
 = 
	`ªad_pci_c⁄fig
(
bus
, 
¶Ÿ
, 1, 0x84 + (
i
 << 3));

128 
íd
 = (((
u64
)
ªg
) << 8) & (0xffULL << 32);

130 i‡(!
íd
)

133 
ønge
[
hi_mmio_num
].
°¨t
 = start;

134 
ønge
[
hi_mmio_num
].
íd
 =Énd;

135 
hi_mmio_num
++;

138 i‡(!
hi_mmio_num
)

139 
out
;

142 
	`s‹t
(
ønge
, 
hi_mmio_num
, (ønge), 
cmp_ønge
, 
NULL
);

144 i‡(
ønge
[
hi_mmio_num
 - 1].
íd
 < 
ba£
)

145 
out
;

146 i‡(
ønge
[0].
°¨t
 > 
ba£
)

147 
out
;

150 
ba£
 = 
ønge
[0].
°¨t
 - (1ULL << 32);

151 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

152 
out
;

153 
ba£
 = 
ønge
[
hi_mmio_num
 - 1].
íd
 + (1ULL << 32);

154 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

155 
out
;

157 i‡(
hi_mmio_num
 > 1)

158 
i
 = 0; i < 
hi_mmio_num
 - 1; i++) {

159 i‡(
ønge
[
i
 + 1].
°¨t
 > (ønge[i].
íd
 + (1ULL << 32))) {

160 
ba£
 = 
ønge
[
i
].
íd
 + (1ULL << 32);

161 i‡((
ba£
 > 
tom2
Ë&& 
	`BASE_VALID
(base))

162 
out
;

166 
Áû
:

167 
Ám10h_pci_mmc⁄f_ba£_°©us
 = -1;

169 
out
:

170 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

171 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

172 
	}
}

174 
__˝uöô
 
	$Ám10h_check_íabÀ_mmcfg
()

176 
u64
 
vÆ
;

177 
u32
 
addªss
;

179 i‡(!(
pci_¥obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

182 
addªss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

183 
	`rdm§l
(
addªss
, 
vÆ
);

186 i‡(
vÆ
 & 
FAM10H_MMIO_CONF_ENABLE
) {

187 
bu¢bôs
;

188 
bu¢bôs
 = (
vÆ
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

189 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

192 i‡(!
a˝i_pci_dißbÀd
 || 
bu¢bôs
 >= 8) {

193 
u64
 
ba£
;

194 
ba£
 = 
vÆ
 & (0xffffULL << 32);

195 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0) {

196 
Ám10h_pci_mmc⁄f_ba£
 = 
ba£
;

197 
Ám10h_pci_mmc⁄f_ba£_°©us
 = 1;

199 } i‡(
Ám10h_pci_mmc⁄f_ba£
 =
ba£
)

208 
	`gë_Ám10h_pci_mmc⁄f_ba£
();

209 i‡(
Ám10h_pci_mmc⁄f_ba£_°©us
 <= 0)

212 
	`¥ötk
(
KERN_INFO
 "Enable MMCONFIG on AMD Family 10h\n");

213 
vÆ
 &~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

214 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

215 
vÆ
 |
Ám10h_pci_mmc⁄f_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

216 
FAM10H_MMIO_CONF_ENABLE
;

217 
	`wrm§l
(
addªss
, 
vÆ
);

218 
	}
}

220 
__devöô
 
	$£t_check_íabÀ_amd_mmc⁄f
(c⁄° 
dmi_sy°em_id
 *
d
)

222 
pci_¥obe
 |
PCI_CHECK_ENABLE_AMD_MMCONF
;

224 
	}
}

226 c⁄° 
dmi_sy°em_id
 
__˝uöôc⁄°
 
	gmmc⁄f_dmi_èbÀ
[] = {

228 .
ˇŒback
 = 
£t_check_íabÀ_amd_mmc⁄f
,

229 .
	gidít
 = "Sun Microsystems Machine",

230 .
	gm©ches
 = {

231 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

237 
__˝uöô
 
	$check_íabÀ_amd_mmc⁄f_dmi
()

239 
	`dmi_check_sy°em
(
mmc⁄f_dmi_èbÀ
);

240 
	}
}

	@/cmpt816/linux/arch/x86/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/bug.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/gÂ.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/pgèbÀ.h
>

33 
	#DEBUGP
 
¥ötk


	)

35 
	#DEBUGP
(
fmt
...)

	)

38 *
	$moduÀ_Æloc
(
size
)

40 
vm_°ru˘
 *
¨ó
;

42 i‡(!
size
)

43  
NULL
;

44 
size
 = 
	`PAGE_ALIGN
(size);

45 i‡(
size
 > 
MODULES_LEN
)

46  
NULL
;

48 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULES_VADDR
, 
MODULES_END
);

49 i‡(!
¨ó
)

50  
NULL
;

52  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
,

53 
PAGE_KERNEL_EXEC
);

54 
	}
}

57 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

59 
	`v‰ì
(
moduÀ_ªgi⁄
);

60 
	}
}

63 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

64 
Elf_Shdr
 *
£chdrs
,

65 *
£c°rögs
,

66 
moduÀ
 *
mod
)

69 
	}
}

71 #ifde‡
CONFIG_X86_32


72 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
,

73 c⁄° *
°πab
,

74 
symödex
,

75 
ªl£c
,

76 
moduÀ
 *
me
)

78 
i
;

79 
Elf32_Rñ
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

80 
Elf32_Sym
 *
sym
;

81 
uöt32_t
 *
loˇti⁄
;

83 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

84 
£chdrs
[
ªl£c
].
sh_öfo
);

85 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

87 
loˇti⁄
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


88 + 
ªl
[
i
].
r_off£t
;

91 
sym
 = (
Elf32_Sym
 *)
£chdrs
[
symödex
].
sh_addr


92 + 
	`ELF32_R_SYM
(
ªl
[
i
].
r_öfo
);

94 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

95 
R_386_32
:

97 *
loˇti⁄
 +
sym
->
°_vÆue
;

99 
R_386_PC32
:

101 *
loˇti⁄
 +
sym
->
°_vÆue
 - (
uöt32_t
)location;

104 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %u\n",

105 
me
->
«me
, 
	`ELF32_R_TYPE
(
ªl
[
i
].
r_öfo
));

106  -
ENOEXEC
;

110 
	}
}

112 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
,

113 c⁄° *
°πab
,

114 
symödex
,

115 
ªl£c
,

116 
moduÀ
 *
me
)

118 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

119 
me
->
«me
);

120  -
ENOEXEC
;

121 
	}
}

123 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
,

124 c⁄° *
°πab
,

125 
symödex
,

126 
ªl£c
,

127 
moduÀ
 *
me
)

129 
i
;

130 
Elf64_Rña
 *
ªl
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

131 
Elf64_Sym
 *
sym
;

132 *
loc
;

133 
u64
 
vÆ
;

135 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

136 
£chdrs
[
ªl£c
].
sh_öfo
);

137 
i
 = 0; i < 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªl
); i++) {

139 
loc
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr


140 + 
ªl
[
i
].
r_off£t
;

144 
sym
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr


145 + 
	`ELF64_R_SYM
(
ªl
[
i
].
r_öfo
);

147 
	`DEBUGP
("type %d st_value %LxÑ_addend %LxÜoc %Lx\n",

148 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
),

149 
sym
->
°_vÆue
, 
ªl
[
i
].
r_addíd
, (
u64
)
loc
);

151 
vÆ
 = 
sym
->
°_vÆue
 + 
ªl
[
i
].
r_addíd
;

153 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
)) {

154 
R_X86_64_NONE
:

156 
R_X86_64_64
:

157 *(
u64
 *)
loc
 = 
vÆ
;

159 
R_X86_64_32
:

160 *(
u32
 *)
loc
 = 
vÆ
;

161 i‡(
vÆ
 !*(
u32
 *)
loc
)

162 
ovîÊow
;

164 
R_X86_64_32S
:

165 *(
s32
 *)
loc
 = 
vÆ
;

166 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

167 
ovîÊow
;

169 
R_X86_64_PC32
:

170 
vÆ
 -(
u64
)
loc
;

171 *(
u32
 *)
loc
 = 
vÆ
;

173 i‡((
s64
)
vÆ
 !*(
s32
 *)
loc
)

174 
ovîÊow
;

178 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelaÑelocation: %llu\n",

179 
me
->
«me
, 
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
));

180  -
ENOEXEC
;

185 
ovîÊow
:

186 
	`¥ötk
(
KERN_ERR
 "overflow inÑelocationÅype %d val %Lx\n",

187 ()
	`ELF64_R_TYPE
(
ªl
[
i
].
r_öfo
), 
vÆ
);

188 
	`¥ötk
(
KERN_ERR
 "`%s'ÜikelyÇot compiled with -mcmodel=kernel\n",

189 
me
->
«me
);

190  -
ENOEXEC
;

191 
	}
}

193 
	$≠∂y_ªloˇã
(
Elf_Shdr
 *
£chdrs
,

194 c⁄° *
°πab
,

195 
symödex
,

196 
ªl£c
,

197 
moduÀ
 *
me
)

199 
	`¥ötk
(
KERN_ERR
 "nonáddÑelocationÇot supported\n");

200  -
ENOSYS
;

201 
	}
}

205 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
,

206 c⁄° 
Elf_Shdr
 *
£chdrs
,

207 
moduÀ
 *
me
)

209 c⁄° 
Elf_Shdr
 *
s
, *
ãxt
 = 
NULL
, *
Æt
 = NULL, *
locks
 = NULL,

210 *
∑ø
 = 
NULL
;

211 *
£c°rögs
 = (*)
hdr
 + 
£chdrs
[hdr->
e_sh°∫dx
].
sh_off£t
;

213 
s
 = 
£chdrs
; s < sechdr†+ 
hdr
->
e_shnum
; s++) {

214 i‡(!
	`°rcmp
(".ãxt", 
£c°rögs
 + 
s
->
sh_«me
))

215 
ãxt
 = 
s
;

216 i‡(!
	`°rcmp
(".Ætö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

217 
Æt
 = 
s
;

218 i‡(!
	`°rcmp
(".smp_locks", 
£c°rögs
 + 
s
->
sh_«me
))

219 
locks
 = 
s
;

220 i‡(!
	`°rcmp
(".∑øö°ru˘i⁄s", 
£c°rögs
 + 
s
->
sh_«me
))

221 
∑ø
 = 
s
;

224 i‡(
Æt
) {

226 *
a£g
 = (*)
Æt
->
sh_addr
;

227 
	`≠∂y_Æã∫©ives
(
a£g
,á£g + 
Æt
->
sh_size
);

229 i‡(
locks
 && 
ãxt
) {

230 *
l£g
 = (*)
locks
->
sh_addr
;

231 *
t£g
 = (*)
ãxt
->
sh_addr
;

232 
	`Æã∫©ives_smp_moduÀ_add
(
me
, me->
«me
,

233 
l£g
,Ü£g + 
locks
->
sh_size
,

234 
t£g
,Å£g + 
ãxt
->
sh_size
);

237 i‡(
∑ø
) {

238 *
p£g
 = (*)
∑ø
->
sh_addr
;

239 
	`≠∂y_∑øvút
(
p£g
,Ö£g + 
∑ø
->
sh_size
);

242  
	`moduÀ_bug_föÆize
(
hdr
, 
£chdrs
, 
me
);

243 
	}
}

245 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

247 
	`Æã∫©ives_smp_moduÀ_dñ
(
mod
);

248 
	`moduÀ_bug_˛ónup
(
mod
);

249 
	}
}

	@/cmpt816/linux/arch/x86/kernel/mpparse.c

10 
	~<löux/mm.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/dñay.h
>

13 
	~<löux/boŸmem.h
>

14 
	~<löux/kî√l_°©.h
>

15 
	~<löux/mc146818πc.h
>

16 
	~<löux/bô›s.h
>

17 
	~<löux/a˝i.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/pci.h
>

22 
	~<asm/mår.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/pgÆloc.h
>

25 
	~<asm/io_≠ic.h
>

26 
	~<asm/¥Ÿo.h
>

27 
	~<asm/bios_ebda.h
>

28 
	~<asm/e820.h
>

29 
	~<asm/åampﬁöe.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/smp.h
>

33 
	~<asm/≠ic.h
>

38 
__öô
 
	$mpf_checksum
(*
mp
, 
Àn
)

40 
sum
 = 0;

42 
Àn
--)

43 
sum
 +*
mp
++;

45  
sum
 & 0xFF;

46 
	}
}

48 
__öô
 
	$deÁu…_mpc_≠ic_id
(
mpc_˝u
 *
m
)

50  
m
->
≠icid
;

51 
	}
}

53 
__öô
 
	$MP_¥o˚ss‹_öfo
(
mpc_˝u
 *
m
)

55 
≠icid
;

56 *
boŸup_˝u
 = "";

58 i‡(!(
m
->
˝uÊag
 & 
CPU_ENABLED
)) {

59 
dißbÀd_˝us
++;

63 
≠icid
 = 
x86_öô
.
mµ¨£
.
	`mpc_≠ic_id
(
m
);

65 i‡(
m
->
˝uÊag
 & 
CPU_BOOTPROCESSOR
) {

66 
boŸup_˝u
 = " (Bootup-CPU)";

67 
boŸ_˝u_physiˇl_≠icid
 = 
m
->
≠icid
;

70 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹ #%d%s\n", 
m
->
≠icid
, 
boŸup_˝u
);

71 
	`gíîic_¥o˚ss‹_öfo
(
≠icid
, 
m
->
≠icvî
);

72 
	}
}

74 #ifde‡
CONFIG_X86_IO_APIC


75 
__öô
 
	$deÁu…_mpc_€m_bus_öfo
(
mpc_bus
 *
m
, *
°r
)

77 
	`mem˝y
(
°r
, 
m
->
bu°y≥
, 6);

78 
°r
[6] = 0;

79 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Bu†#%d i†%s\n", 
m
->
busid
, 
°r
);

80 
	}
}

82 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
)

84 
°r
[7];

86 
x86_öô
.
mµ¨£
.
	`mpc_€m_bus_öfo
(
m
, 
°r
);

88 #i‡
MAX_MP_BUSSES
 < 256

89 i‡(
m
->
busid
 >
MAX_MP_BUSSES
) {

90 
	`¥ötk
(
KERN_WARNING
 "MPÅable busid value (%d) for bustype %s "

92 
m
->
busid
, 
°r
, 
MAX_MP_BUSSES
 - 1);

97 i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA) - 1) == 0) {

98 
	`£t_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

99 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

100 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_ISA
;

102 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI) - 1) == 0) {

103 i‡(
x86_öô
.
mµ¨£
.
mpc_€m_pci_bus
)

104 
x86_öô
.
mµ¨£
.
	`mpc_€m_pci_bus
(
m
);

106 
	`˛ór_bô
(
m
->
busid
, 
mp_bus_nŸ_pci
);

107 #i‡
	`deföed
(
CONFIG_EISA
Ë|| deföed(
CONFIG_MCA
)

108 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_PCI
;

109 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA) - 1) == 0) {

110 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_EISA
;

111 } i‡(
	`°∫cmp
(
°r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA) - 1) == 0) {

112 
mp_bus_id_to_ty≥
[
m
->
busid
] = 
MP_BUS_MCA
;

115 
	`¥ötk
(
KERN_WARNING
 "Unknow¿bu°y≥ %†- ign‹ög\n", 
°r
);

116 
	}
}

118 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
)

120 i‡(!(
m
->
Êags
 & 
MPC_APIC_USABLE
))

123 
	`¥ötk
(
KERN_INFO
 "I/O APIC #%d Version %dát 0x%X.\n",

124 
m
->
≠icid
, m->
≠icvî
, m->
≠iˇddr
);

126 
	`mp_ªgi°î_iﬂpic
(
m
->
≠icid
, m->
≠iˇddr
, 
gsi_t›
);

127 
	}
}

129 
	$¥öt_MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

131 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

133 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbus
,

134 
m
->
§cbusúq
, m->
d°≠ic
, m->
d°úq
);

135 
	}
}

137 
__öô
 
	$¥öt_mp_úq_öfo
(
mpc_öt§c
 *
mp_úq
)

139 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Int:Åype %d,Öol %d,Årig %d, bus %02x,"

141 
mp_úq
->
úqty≥
, mp_úq->
úqÊag
 & 3,

142 (
mp_úq
->
úqÊag
 >> 2Ë& 3, mp_úq->
§cbus
,

143 
mp_úq
->
§cbusúq
, mp_úq->
d°≠ic
, mp_úq->
d°úq
);

144 
	}
}

146 
__öô
 
	$assign_to_mp_úq
(
mpc_öt§c
 *
m
,

147 
mpc_öt§c
 *
mp_úq
)

149 
mp_úq
->
d°≠ic
 = 
m
->dstapic;

150 
mp_úq
->
ty≥
 = 
m
->type;

151 
mp_úq
->
úqty≥
 = 
m
->irqtype;

152 
mp_úq
->
úqÊag
 = 
m
->irqflag;

153 
mp_úq
->
§cbus
 = 
m
->srcbus;

154 
mp_úq
->
§cbusúq
 = 
m
->srcbusirq;

155 
mp_úq
->
d°úq
 = 
m
->dstirq;

156 
	}
}

158 
__öô
 
	$assign_to_mpc_öt§c
(
mpc_öt§c
 *
mp_úq
,

159 
mpc_öt§c
 *
m
)

161 
m
->
d°≠ic
 = 
mp_úq
->dstapic;

162 
m
->
ty≥
 = 
mp_úq
->type;

163 
m
->
úqty≥
 = 
mp_úq
->irqtype;

164 
m
->
úqÊag
 = 
mp_úq
->irqflag;

165 
m
->
§cbus
 = 
mp_úq
->srcbus;

166 
m
->
§cbusúq
 = 
mp_úq
->srcbusirq;

167 
m
->
d°úq
 = 
mp_úq
->dstirq;

168 
	}
}

170 
__öô
 
	$mp_úq_mpc_öt§c_cmp
(
mpc_öt§c
 *
mp_úq
,

171 
mpc_öt§c
 *
m
)

173 i‡(
mp_úq
->
d°≠ic
 !
m
->dstapic)

175 i‡(
mp_úq
->
ty≥
 !
m
->type)

177 i‡(
mp_úq
->
úqty≥
 !
m
->irqtype)

179 i‡(
mp_úq
->
úqÊag
 !
m
->irqflag)

181 i‡(
mp_úq
->
§cbus
 !
m
->srcbus)

183 i‡(
mp_úq
->
§cbusúq
 !
m
->srcbusirq)

185 i‡(
mp_úq
->
d°úq
 !
m
->dstirq)

189 
	}
}

191 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
)

193 
i
;

195 
	`¥öt_MP_öt§c_öfo
(
m
);

197 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

198 i‡(!
	`mp_úq_mpc_öt§c_cmp
(&
mp_úqs
[
i
], 
m
))

202 
	`assign_to_mp_úq
(
m
, &
mp_úqs
[
mp_úq_íåõs
]);

203 i‡(++
mp_úq_íåõs
 =
MAX_IRQ_SOURCES
)

204 
	`∑nic
("Max # of irq sourcesÉxceeded!!\n");

205 
	}
}

207 
ölöe
 
__öô
 
	$MP_bus_öfo
(
mpc_bus
 *
m
Ë{
	}
}

208 
ölöe
 
__öô
 
	$MP_iﬂpic_öfo
(
mpc_iﬂpic
 *
m
Ë{
	}
}

209 
ölöe
 
__öô
 
	$MP_öt§c_öfo
(
mpc_öt§c
 *
m
Ë{
	}
}

213 
__öô
 
	$MP_löt§c_öfo
(
mpc_löt§c
 *
m
)

215 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Lint:Åype %d,Öol %d,Årig %d, bus %02x,"

217 
m
->
úqty≥
, m->
úqÊag
 & 3, (m->úqÊag >> 2Ë& 3, m->
§cbusid
,

218 
m
->
§cbusúq
, m->
de°≠ic
, m->
de°≠i˛öt
);

219 
	}
}

225 
__öô
 
	$smp_check_mpc
(
mpc_èbÀ
 *
mpc
, *
€m
, *
°r
)

228 i‡(
	`memcmp
(
mpc
->
sig«tuª
, 
MPC_SIGNATURE
, 4)) {

229 
	`¥ötk
(
KERN_ERR
 "MPTABLE: bad signature [%c%c%c%c]!\n",

230 
mpc
->
sig«tuª
[0], mpc->signature[1],

231 
mpc
->
sig«tuª
[2], mpc->signature[3]);

234 i‡(
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
)) {

235 
	`¥ötk
(
KERN_ERR
 "MPTABLE: checksumÉrror!\n");

238 i‡(
mpc
->
•ec
 != 0x01 && mpc->spec != 0x04) {

239 
	`¥ötk
(
KERN_ERR
 "MPTABLE: badÅable version (%d)!!\n",

240 
mpc
->
•ec
);

243 i‡(!
mpc
->
œpic
) {

244 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇullÜocal APICáddress!\n");

247 
	`mem˝y
(
€m
, 
mpc
->oem, 8);

248 
€m
[8] = 0;

249 
	`¥ötk
(
KERN_INFO
 "MPTABLE: OEM ID: %s\n", 
€m
);

251 
	`mem˝y
(
°r
, 
mpc
->
¥odu˘id
, 12);

252 
°r
[12] = 0;

254 
	`¥ötk
(
KERN_INFO
 "MPTABLE: Produ˘ ID: %s\n", 
°r
);

256 
	`¥ötk
(
KERN_INFO
 "MPTABLE: APICát: 0x%X\n", 
mpc
->
œpic
);

259 
	}
}

261 
	$skù_íåy
(**
±r
, *
cou¡
, 
size
)

263 *
±r
 +
size
;

264 *
cou¡
 +
size
;

265 
	}
}

267 
__öô
 
	$smp_dump_m±abÀ
(
mpc_èbÀ
 *
mpc
, *
m±
)

269 
	`¥ötk
(
KERN_ERR
 "Your mptable is wrong, contact your HW vendor!\n"

270 "ty≥ %x\n", *
m±
);

271 
	`¥öt_hex_dump
(
KERN_ERR
, " ", 
DUMP_PREFIX_ADDRESS
, 16,

272 1, 
mpc
, mpc->
Àngth
, 1);

273 
	}
}

275 
__öô
 
	$deÁu…_smp_ªad_mpc_€m
(
mpc_èbÀ
 *
mpc
Ë{ 
	}
}

277 
__öô
 
	$smp_ªad_mpc
(
mpc_èbÀ
 *
mpc
, 
óæy
)

279 
°r
[16];

280 
€m
[10];

282 
cou¡
 = (*
mpc
);

283 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

285 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

288 #ifde‡
CONFIG_X86_32


289 
	`gíîic_mps_€m_check
(
mpc
, 
€m
, 
°r
);

292 i‡(!
a˝i_œpic
)

293 
mp_œpic_addr
 = 
mpc
->
œpic
;

295 i‡(
óæy
)

298 i‡(
mpc
->
€m±r
)

299 
x86_öô
.
mµ¨£
.
	`smp_ªad_mpc_€m
(
mpc
);

304 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(0);

306 
cou¡
 < 
mpc
->
Àngth
) {

307 *
m±
) {

308 
MP_PROCESSOR
:

310 i‡(!
a˝i_œpic
)

311 
	`MP_¥o˚ss‹_öfo
((
mpc_˝u
 *)
m±
);

312 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

314 
MP_BUS
:

315 
	`MP_bus_öfo
((
mpc_bus
 *)
m±
);

316 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

318 
MP_IOAPIC
:

319 
	`MP_iﬂpic_öfo
((
mpc_iﬂpic
 *)
m±
);

320 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

322 
MP_INTSRC
:

323 
	`MP_öt§c_öfo
((
mpc_öt§c
 *)
m±
);

324 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

326 
MP_LINTSRC
:

327 
	`MP_löt§c_öfo
((
mpc_löt§c
 *)
m±
);

328 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

332 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

333 
cou¡
 = 
mpc
->
Àngth
;

336 
x86_öô
.
mµ¨£
.
	`mpc_ªc‹d
(1);

339 i‡(!
num_¥o˚ss‹s
)

340 
	`¥ötk
(
KERN_ERR
 "MPTABLE:ÇoÖrocessorsÑegistered!\n");

341  
num_¥o˚ss‹s
;

342 
	}
}

344 #ifde‡
CONFIG_X86_IO_APIC


346 
__öô
 
	$ELCR_åiggî
(
úq
)

348 
p‹t
;

350 
p‹t
 = 0x4d0 + (
úq
 >> 3);

351  (
	`öb
(
p‹t
Ë>> (
úq
 & 7)) & 1;

352 
	}
}

354 
__öô
 
	$c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
)

356 
mpc_öt§c
 
öt§c
;

357 
i
;

358 
ELCR_ÁŒback
 = 0;

360 
öt§c
.
ty≥
 = 
MP_INTSRC
;

361 
öt§c
.
úqÊag
 = 0;

362 
öt§c
.
§cbus
 = 0;

363 
öt§c
.
d°≠ic
 = 
mp_iﬂpics
[0].
≠icid
;

365 
öt§c
.
úqty≥
 = 
mp_INT
;

375 i‡(
mpc_deÁu…_ty≥
 == 5) {

376 
	`¥ötk
(
KERN_INFO
 "ISA/PCI busÅype withÇo IRQ information... "

379 i‡(
	`ELCR_åiggî
(0) || ELCR_trigger(1) || ELCR_trigger(2) ||

380 
	`ELCR_åiggî
(13))

381 
	`¥ötk
(
KERN_ERR
 "ELCR contains invalid data... "

384 
	`¥ötk
(
KERN_INFO


386 
ELCR_ÁŒback
 = 1;

390 
i
 = 0; i < 16; i++) {

391 
mpc_deÁu…_ty≥
) {

393 i‡(
i
 == 0 || i == 13)

397 i‡(
i
 == 2)

401 i‡(
ELCR_ÁŒback
) {

407 i‡(
	`ELCR_åiggî
(
i
))

408 
öt§c
.
úqÊag
 = 13;

410 
öt§c
.
úqÊag
 = 0;

413 
öt§c
.
§cbusúq
 = 
i
;

414 
öt§c
.
d°úq
 = 
i
 ? i : 2;

415 
	`MP_öt§c_öfo
(&
öt§c
);

418 
öt§c
.
úqty≥
 = 
mp_ExtINT
;

419 
öt§c
.
§cbusúq
 = 0;

420 
öt§c
.
d°úq
 = 0;

421 
	`MP_öt§c_öfo
(&
öt§c
);

422 
	}
}

425 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
)

427 
mpc_iﬂpic
 
iﬂpic
;

428 
mpc_bus
 
bus
;

430 
bus
.
ty≥
 = 
MP_BUS
;

431 
bus
.
busid
 = 0;

432 
mpc_deÁu…_ty≥
) {

434 
	`¥ötk
(
KERN_ERR
 "???\nUnknown standard configuration %d\n",

435 
mpc_deÁu…_ty≥
);

439 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

444 
	`mem˝y
(
bus
.
bu°y≥
, "EISA ", 6);

448 
	`mem˝y
(
bus
.
bu°y≥
, "MCA ", 6);

450 
	`MP_bus_öfo
(&
bus
);

451 i‡(
mpc_deÁu…_ty≥
 > 4) {

452 
bus
.
busid
 = 1;

453 
	`mem˝y
(
bus
.
bu°y≥
, "PCI ", 6);

454 
	`MP_bus_öfo
(&
bus
);

457 
iﬂpic
.
ty≥
 = 
MP_IOAPIC
;

458 
iﬂpic
.
≠icid
 = 2;

459 
iﬂpic
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

460 
iﬂpic
.
Êags
 = 
MPC_APIC_USABLE
;

461 
iﬂpic
.
≠iˇddr
 = 
IO_APIC_DEFAULT_PHYS_BASE
;

462 
	`MP_iﬂpic_öfo
(&
iﬂpic
);

467 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(
mpc_deÁu…_ty≥
);

468 
	}
}

470 
ölöe
 
__öô
 
	$c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
Ë{ 
	}
}

473 
ölöe
 
__öô
 
	$c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpc_deÁu…_ty≥
)

475 
mpc_˝u
 
¥o˚ss‹
;

476 
mpc_löt§c
 
löt§c
;

477 
löây≥s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

478 
i
;

483 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

488 
¥o˚ss‹
.
ty≥
 = 
MP_PROCESSOR
;

490 
¥o˚ss‹
.
≠icvî
 = 
mpc_deÁu…_ty≥
 > 4 ? 0x10 : 0x01;

491 
¥o˚ss‹
.
˝uÊag
 = 
CPU_ENABLED
;

492 
¥o˚ss‹
.
˝u„©uª
 = (
boŸ_˝u_d©a
.
x86
 << 8) |

493 (
boŸ_˝u_d©a
.
x86_modñ
 << 4Ë| boŸ_˝u_d©a.
x86_mask
;

494 
¥o˚ss‹
.
„©uªÊag
 = 
boŸ_˝u_d©a
.
x86_ˇ∑bûôy
[0];

495 
¥o˚ss‹
.
ª£rved
[0] = 0;

496 
¥o˚ss‹
.
ª£rved
[1] = 0;

497 
i
 = 0; i < 2; i++) {

498 
¥o˚ss‹
.
≠icid
 = 
i
;

499 
	`MP_¥o˚ss‹_öfo
(&
¥o˚ss‹
);

502 
	`c⁄°ru˘_iﬂpic_èbÀ
(
mpc_deÁu…_ty≥
);

504 
löt§c
.
ty≥
 = 
MP_LINTSRC
;

505 
löt§c
.
úqÊag
 = 0;

506 
löt§c
.
§cbusid
 = 0;

507 
löt§c
.
§cbusúq
 = 0;

508 
löt§c
.
de°≠ic
 = 
MP_APIC_ALL
;

509 
i
 = 0; i < 2; i++) {

510 
löt§c
.
úqty≥
 = 
löây≥s
[
i
];

511 
löt§c
.
de°≠i˛öt
 = 
i
;

512 
	`MP_löt§c_öfo
(&
löt§c
);

514 
	}
}

516 
mpf_öãl
 *
	gmpf_found
;

518 
__öô
 
	$gë_mpc_size
(
phy•å
)

520 
mpc_èbÀ
 *
mpc
;

521 
size
;

523 
mpc
 = 
	`óæy_i‹em≠
(
phy•å
, 
PAGE_SIZE
);

524 
size
 = 
mpc
->
Àngth
;

525 
	`óæy_iounm≠
(
mpc
, 
PAGE_SIZE
);

526 
	`≠ic_¥ötk
(
APIC_VERBOSE
, " mpc: %lx-%lx\n", 
phy•å
,Öhy•å + 
size
);

528  
size
;

529 
	}
}

531 
__öô
 
	$check_phy•å
(
mpf_öãl
 *
mpf
, 
óæy
)

533 
mpc_èbÀ
 *
mpc
;

534 
size
;

536 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

537 
mpc
 = 
	`óæy_i‹em≠
(
mpf
->
phy•å
, 
size
);

542 i‡(!
	`smp_ªad_mpc
(
mpc
, 
óæy
)) {

543 #ifde‡
CONFIG_X86_LOCAL_APIC


544 
smp_found_c⁄fig
 = 0;

546 
	`¥ötk
(
KERN_ERR
 "BIOS bug, MPÅableÉrrors detected!...\n"

548 
	`óæy_iounm≠
(
mpc
, 
size
);

551 
	`óæy_iounm≠
(
mpc
, 
size
);

553 i‡(
óæy
)

556 #ifde‡
CONFIG_X86_IO_APIC


562 i‡(!
mp_úq_íåõs
) {

563 
mpc_bus
 
bus
;

565 
	`¥ötk
(
KERN_ERR
 "BIOS bug,ÇoÉxplicit IRQÉntries, "

568 
bus
.
ty≥
 = 
MP_BUS
;

569 
bus
.
busid
 = 0;

570 
	`mem˝y
(
bus
.
bu°y≥
, "ISA ", 6);

571 
	`MP_bus_öfo
(&
bus
);

573 
	`c⁄°ru˘_deÁu…_ioúq_m±abÀ
(0);

578 
	}
}

583 
__öô
 
	$deÁu…_gë_smp_c⁄fig
(
óæy
)

585 
mpf_öãl
 *
mpf
 = 
mpf_found
;

587 i‡(!
mpf
)

590 i‡(
a˝i_œpic
 && 
óæy
)

597 i‡(
a˝i_œpic
 && 
a˝i_iﬂpic
)

600 
	`¥ötk
(
KERN_INFO
 "Intel MultiProcessor Specification v1.%d\n",

601 
mpf
->
•ecifiˇti⁄
);

602 #i‡
	`deföed
(
CONFIG_X86_LOCAL_APIC
Ë&& deföed(
CONFIG_X86_32
)

603 i‡(
mpf
->
„©uª2
 & (1 << 7)) {

604 
	`¥ötk
(
KERN_INFO
 " IMCRánd PIC compatibility mode.\n");

605 
pic_mode
 = 1;

607 
	`¥ötk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

608 
pic_mode
 = 0;

614 i‡(
mpf
->
„©uª1
 != 0) {

615 i‡(
óæy
) {

619 
mp_œpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

623 
	`¥ötk
(
KERN_INFO
 "Default MP configuration #%d\n",

624 
mpf
->
„©uª1
);

625 
	`c⁄°ru˘_deÁu…_ISA_m±abÀ
(
mpf
->
„©uª1
);

627 } i‡(
mpf
->
phy•å
) {

628 i‡(
	`check_phy•å
(
mpf
, 
óæy
))

631 
	`BUG
();

633 i‡(!
óæy
)

634 
	`¥ötk
(
KERN_INFO
 "Pro˚ss‹s: %d\n", 
num_¥o˚ss‹s
);

638 
	}
}

640 
__öô
 
	$smp_ª£rve_mem‹y
(
mpf_öãl
 *
mpf
)

642 
size
 = 
	`gë_mpc_size
(
mpf
->
phy•å
);

644 
	`ª£rve_óæy_ovîœp_ok
(
mpf
->
phy•å
, mpf->phy•å+
size
, "MP-table mpc");

645 
	}
}

647 
__öô
 
	$smp_sˇn_c⁄fig
(
ba£
, 
Àngth
)

649 *
bp
 = 
	`phys_to_vút
(
ba£
);

650 
mpf_öãl
 *
mpf
;

651 
mem
;

653 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "Scan SMP from %p for %ld bytes.\n",

654 
bp
, 
Àngth
);

655 
	`BUILD_BUG_ON
((*
mpf
) != 16);

657 
Àngth
 > 0) {

658 
mpf
 = (
mpf_öãl
 *)
bp
;

659 i‡((*
bp
 =
SMP_MAGIC_IDENT
) &&

660 (
mpf
->
Àngth
 == 1) &&

661 !
	`mpf_checksum
((*)
bp
, 16) &&

662 ((
mpf
->
•ecifiˇti⁄
 == 1)

663 || (
mpf
->
•ecifiˇti⁄
 == 4))) {

664 #ifde‡
CONFIG_X86_LOCAL_APIC


665 
smp_found_c⁄fig
 = 1;

667 
mpf_found
 = 
mpf
;

669 
	`¥ötk
(
KERN_INFO
 "found SMP MP-tableát [%p] %llx\n",

670 
mpf
, (
u64
)
	`vút_to_phys
(mpf));

672 
mem
 = 
	`vút_to_phys
(
mpf
);

673 
	`ª£rve_óæy_ovîœp_ok
(
mem
, mem + (*
mpf
), "MP-table mpf");

674 i‡(
mpf
->
phy•å
)

675 
	`smp_ª£rve_mem‹y
(
mpf
);

679 
bp
 += 4;

680 
Àngth
 -= 16;

683 
	}
}

685 
__öô
 
	$deÁu…_föd_smp_c⁄fig
()

687 
addªss
;

697 i‡(
	`smp_sˇn_c⁄fig
(0x0, 0x400) ||

698 
	`smp_sˇn_c⁄fig
(639 * 0x400, 0x400) ||

699 
	`smp_sˇn_c⁄fig
(0xF0000, 0x10000))

718 
addªss
 = 
	`gë_bios_ebda
();

719 i‡(
addªss
)

720 
	`smp_sˇn_c⁄fig
(
addªss
, 0x400);

721 
	}
}

723 #ifde‡
CONFIG_X86_IO_APIC


724 
u8
 
__öôd©a
 
	gúq_u£d
[
MAX_IRQ_SOURCES
];

726 
__öô
 
	$gë_MP_öt§c_ödex
(
mpc_öt§c
 *
m
)

728 
i
;

730 i‡(
m
->
úqty≥
 !
mp_INT
)

733 i‡(
m
->
úqÊag
 != 0x0f)

738 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

739 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

742 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

745 i‡(
mp_úqs
[
i
].
§cbus
 !
m
->srcbus)

747 i‡(
mp_úqs
[
i
].
§cbusúq
 !
m
->srcbusirq)

749 i‡(
úq_u£d
[
i
]) {

753 
úq_u£d
[
i
] = 1;

754  
i
;

759 
	}
}

761 
	#SPARE_SLOT_NUM
 20

	)

763 
mpc_öt§c
 
__öôd©a
 *
	gm_•¨e
[
SPARE_SLOT_NUM
];

765 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
)

767 
i
;

769 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "OLD ");

770 
	`¥öt_MP_öt§c_öfo
(
m
);

772 
i
 = 
	`gë_MP_öt§c_ödex
(
m
);

773 i‡(
i
 > 0) {

774 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

775 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "NEW ");

776 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

779 i‡(!
i
) {

783 i‡(*
ƒ_m_•¨e
 < 
SPARE_SLOT_NUM
) {

788 
m_•¨e
[*
ƒ_m_•¨e
] = 
m
;

789 *
ƒ_m_•¨e
 += 1;

791 
	}
}

794 
ölöe
 
__öô
 
	$check_úq_§c
(
mpc_öt§c
 *
m
, *
ƒ_m_•¨e
Ë{
	}
}

798 
	$check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
)

800 
ªt
 = 0;

802 i‡(!
mpc_√w_phys
 || 
cou¡
 <
mpc_√w_Àngth
) {

803 
	`WARN
(1, "upd©e_m±abÀ: Nÿ•¨ê¶Ÿ†÷ígth: %x)\n", 
cou¡
);

807  
ªt
;

808 
	}
}

810 
__öô
 
	$ª∂a˚_öt§c_Æl
(
mpc_èbÀ
 *
mpc
,

811 
mpc_√w_phys
,

812 
mpc_√w_Àngth
)

814 #ifde‡
CONFIG_X86_IO_APIC


815 
i
;

817 
cou¡
 = (*
mpc
);

818 
ƒ_m_•¨e
 = 0;

819 *
m±
 = ((*)
mpc
Ë+ 
cou¡
;

821 
	`¥ötk
(
KERN_INFO
 "mpc_Àngth %x\n", 
mpc
->
Àngth
);

822 
cou¡
 < 
mpc
->
Àngth
) {

823 *
m±
) {

824 
MP_PROCESSOR
:

825 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_˝u
));

827 
MP_BUS
:

828 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_bus
));

830 
MP_IOAPIC
:

831 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_iﬂpic
));

833 
MP_INTSRC
:

834 
	`check_úq_§c
((
mpc_öt§c
 *)
m±
, &
ƒ_m_•¨e
);

835 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_öt§c
));

837 
MP_LINTSRC
:

838 
	`skù_íåy
(&
m±
, &
cou¡
, (
mpc_löt§c
));

842 
	`smp_dump_m±abÀ
(
mpc
, 
m±
);

843 
out
;

847 #ifde‡
CONFIG_X86_IO_APIC


848 
i
 = 0; i < 
mp_úq_íåõs
; i++) {

849 i‡(
úq_u£d
[
i
])

852 i‡(
mp_úqs
[
i
].
úqty≥
 !
mp_INT
)

855 i‡(
mp_úqs
[
i
].
úqÊag
 != 0x0f)

858 i‡(
ƒ_m_•¨e
 > 0) {

859 
	`≠ic_¥ötk
(
APIC_VERBOSE
, "*NEW* found\n");

860 
ƒ_m_•¨e
--;

861 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m_•¨e
[
ƒ_m_•¨e
]);

862 
m_•¨e
[
ƒ_m_•¨e
] = 
NULL
;

864 
mpc_öt§c
 *
m
 = (mpc_öt§¯*)
m±
;

865 
cou¡
 +(
mpc_öt§c
);

866 i‡(
	`check_¶Ÿ
(
mpc_√w_phys
, 
mpc_√w_Àngth
, 
cou¡
) < 0)

867 
out
;

868 
	`assign_to_mpc_öt§c
(&
mp_úqs
[
i
], 
m
);

869 
mpc
->
Àngth
 = 
cou¡
;

870 
m±
 +(
mpc_öt§c
);

872 
	`¥öt_mp_úq_öfo
(&
mp_úqs
[
i
]);

875 
out
:

877 
mpc
->
checksum
 = 0;

878 
mpc
->
checksum
 -
	`mpf_checksum
((*)mpc, mpc->
Àngth
);

881 
	}
}

883 
	gíabÀ_upd©e_m±abÀ
;

885 
__öô
 
	$upd©e_m±abÀ_£tup
(*
°r
)

887 
íabÀ_upd©e_m±abÀ
 = 1;

888 #ifde‡
CONFIG_PCI


889 
pci_rouãúq
 = 1;

892 
	}
}

893 
óæy_∑øm
("upd©e_m±abÀ", 
upd©e_m±abÀ_£tup
);

895 
__öôd©a
 
	gmpc_√w_phys
;

896 
mpc_√w_Àngth
 
	g__öôd©a
 = 4096;

899 
__öôd©a
 
	gÆloc_m±abÀ
;

900 
__öô
 
	$∑r£_Æloc_m±abÀ_›t
(*
p
)

902 
íabÀ_upd©e_m±abÀ
 = 1;

903 #ifde‡
CONFIG_PCI


904 
pci_rouãúq
 = 1;

906 
Æloc_m±abÀ
 = 1;

907 i‡(!
p
)

909 
mpc_√w_Àngth
 = 
	`mem∑r£
(
p
, &p);

911 
	}
}

912 
óæy_∑øm
("Æloc_m±abÀ", 
∑r£_Æloc_m±abÀ_›t
);

914 
__öô
 
	$óæy_ª£rve_e820_mpc_√w
()

916 i‡(
íabÀ_upd©e_m±abÀ
 && 
Æloc_m±abÀ
) {

917 
u64
 
°¨â
 = 0;

918 
mpc_√w_phys
 = 
	`óæy_ª£rve_e820
(
°¨â
, 
mpc_√w_Àngth
, 4);

920 
	}
}

922 
__öô
 
	$upd©e_mp_èbÀ
()

924 
°r
[16];

925 
€m
[10];

926 
mpf_öãl
 *
mpf
;

927 
mpc_èbÀ
 *
mpc
, *
mpc_√w
;

929 i‡(!
íabÀ_upd©e_m±abÀ
)

932 
mpf
 = 
mpf_found
;

933 i‡(!
mpf
)

939 i‡(
mpf
->
„©uª1
 != 0)

942 i‡(!
mpf
->
phy•å
)

945 
mpc
 = 
	`phys_to_vút
(
mpf
->
phy•å
);

947 i‡(!
	`smp_check_mpc
(
mpc
, 
€m
, 
°r
))

950 
	`¥ötk
(
KERN_INFO
 "mpf: %Œx\n", (
u64
)
	`vút_to_phys
(
mpf
));

951 
	`¥ötk
(
KERN_INFO
 "phy•å: %x\n", 
mpf
->
phy•å
);

953 i‡(
mpc_√w_phys
 && 
mpc
->
Àngth
 > 
mpc_√w_Àngth
) {

954 
mpc_√w_phys
 = 0;

955 
	`¥ötk
(
KERN_INFO
 "mpc_new_length is %ld,Ölease useálloc_mptable=8k\n",

956 
mpc_√w_Àngth
);

959 i‡(!
mpc_√w_phys
) {

960 
ﬁd
, 
√w
;

962 
mpc
->
checksum
 = 0;

963 
ﬁd
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

964 
mpc
->
checksum
 = 0xff;

965 
√w
 = 
	`mpf_checksum
((*)
mpc
, mpc->
Àngth
);

966 i‡(
ﬁd
 =
√w
) {

967 
	`¥ötk
(
KERN_INFO
 "mpc isÑeadonly,ÖleaseÅryálloc_mptable instead\n");

970 
	`¥ötk
(
KERN_INFO
 "use in-positonÑeplacing\n");

972 
mpf
->
phy•å
 = 
mpc_√w_phys
;

973 
mpc_√w
 = 
	`phys_to_vút
(
mpc_√w_phys
);

974 
	`mem˝y
(
mpc_√w
, 
mpc
, mpc->
Àngth
);

975 
mpc
 = 
mpc_√w
;

977 i‡(
mpc_√w_phys
 - 
mpf
->
phy•å
) {

978 
mpf_öãl
 *
mpf_√w
;

980 
	`¥ötk
(
KERN_INFO
 "mpfÇew: %x\n", 0x400 - 16);

981 
mpf_√w
 = 
	`phys_to_vút
(0x400 - 16);

982 
	`mem˝y
(
mpf_√w
, 
mpf
, 16);

983 
mpf
 = 
mpf_√w
;

984 
mpf
->
phy•å
 = 
mpc_√w_phys
;

986 
mpf
->
checksum
 = 0;

987 
mpf
->
checksum
 -
	`mpf_checksum
((*)mpf, 16);

988 
	`¥ötk
(
KERN_INFO
 "phy•åÇew: %x\n", 
mpf
->
phy•å
);

997 
	`ª∂a˚_öt§c_Æl
(
mpc
, 
mpc_√w_phys
, 
mpc_√w_Àngth
);

1000 
	}
}

1002 
œã_öôˇŒ
(
upd©e_mp_èbÀ
);

	@/cmpt816/linux/arch/x86/kernel/msr.c

25 
	~<löux/moduÀ.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/î∫o.h
>

29 
	~<löux/f˙é.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/pﬁl.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/smp_lock.h
>

34 
	~<löux/maj‹.h
>

35 
	~<löux/fs.h
>

36 
	~<löux/devi˚.h
>

37 
	~<löux/˝u.h
>

38 
	~<löux/nŸifõr.h
>

39 
	~<löux/uac˚ss.h
>

40 
	~<löux/gÂ.h
>

42 
	~<asm/¥o˚ss‹.h
>

43 
	~<asm/m§.h
>

44 
	~<asm/sy°em.h
>

46 
˛ass
 *
	gm§_˛ass
;

48 
loff_t
 
	$m§_£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹ig
)

50 
loff_t
 
ªt
;

51 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

53 
	`muãx_lock
(&
öode
->
i_muãx
);

54 
‹ig
) {

56 
fûe
->
f_pos
 = 
off£t
;

57 
ªt
 = 
fûe
->
f_pos
;

60 
fûe
->
f_pos
 +
off£t
;

61 
ªt
 = 
fûe
->
f_pos
;

64 
ªt
 = -
EINVAL
;

66 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

67  
ªt
;

68 
	}
}

70 
ssize_t
 
	$m§_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

71 
size_t
 
cou¡
, 
loff_t
 *
µos
)

73 
u32
 
__u£r
 *
tmp
 = (u32 __u£∏*Ë
buf
;

74 
u32
 
d©a
[2];

75 
u32
 
ªg
 = *
µos
;

76 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

77 
îr
 = 0;

78 
ssize_t
 
byãs
 = 0;

80 i‡(
cou¡
 % 8)

81  -
EINVAL
;

83 ; 
cou¡
; count -= 8) {

84 
îr
 = 
	`rdm§_ß„_⁄_˝u
(
˝u
, 
ªg
, &
d©a
[0], &data[1]);

85 i‡(
îr
)

87 i‡(
	`c›y_to_u£r
(
tmp
, &
d©a
, 8)) {

88 
îr
 = -
EFAULT
;

91 
tmp
 += 2;

92 
byãs
 += 8;

95  
byãs
 ? byã†: 
îr
;

96 
	}
}

98 
ssize_t
 
	$m§_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

99 
size_t
 
cou¡
, 
loff_t
 *
µos
)

101 c⁄° 
u32
 
__u£r
 *
tmp
 = (c⁄° u32 __u£∏*)
buf
;

102 
u32
 
d©a
[2];

103 
u32
 
ªg
 = *
µos
;

104 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

105 
îr
 = 0;

106 
ssize_t
 
byãs
 = 0;

108 i‡(
cou¡
 % 8)

109  -
EINVAL
;

111 ; 
cou¡
; count -= 8) {

112 i‡(
	`c›y_‰om_u£r
(&
d©a
, 
tmp
, 8)) {

113 
îr
 = -
EFAULT
;

116 
îr
 = 
	`wrm§_ß„_⁄_˝u
(
˝u
, 
ªg
, 
d©a
[0], data[1]);

117 i‡(
îr
)

119 
tmp
 += 2;

120 
byãs
 += 8;

123  
byãs
 ? byã†: 
îr
;

124 
	}
}

126 
	$m§_io˘l
(
fûe
 *fûe, 
ioc
, 
¨g
)

128 
u32
 
__u£r
 *
uªgs
 = (u32 __u£∏*)
¨g
;

129 
u32
 
ªgs
[8];

130 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

131 
îr
;

133 
ioc
) {

134 
X86_IOC_RDMSR_REGS
:

135 i‡(!(
fûe
->
f_mode
 & 
FMODE_READ
)) {

136 
îr
 = -
EBADF
;

139 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

140 
îr
 = -
EFAULT
;

143 
îr
 = 
	`rdm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

144 i‡(
îr
)

146 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

147 
îr
 = -
EFAULT
;

150 
X86_IOC_WRMSR_REGS
:

151 i‡(!(
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

152 
îr
 = -
EBADF
;

155 i‡(
	`c›y_‰om_u£r
(&
ªgs
, 
uªgs
, Ñegs)) {

156 
îr
 = -
EFAULT
;

159 
îr
 = 
	`wrm§_ß„_ªgs_⁄_˝u
(
˝u
, 
ªgs
);

160 i‡(
îr
)

162 i‡(
	`c›y_to_u£r
(
uªgs
, &
ªgs
, Ñegs))

163 
îr
 = -
EFAULT
;

167 
îr
 = -
ENOTTY
;

171  
îr
;

172 
	}
}

174 
	$m§_›í
(
öode
 *öode, 
fûe
 *file)

176 
˝u
;

177 
˝uöfo_x86
 *
c
;

179 
˝u
 = 
	`imö‹
(
fûe
->
f_∑th
.
díåy
->
d_öode
);

180 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_⁄löe
(cpu))

181  -
ENXIO
;

183 
c
 = &
	`˝u_d©a
(
˝u
);

184 i‡(!
	`˝u_has
(
c
, 
X86_FEATURE_MSR
))

185  -
EIO
;

188 
	}
}

193 c⁄° 
fûe_›î©i⁄s
 
	gm§_f›s
 = {

194 .
ow√r
 = 
THIS_MODULE
,

195 .
	gŒ£ek
 = 
m§_£ek
,

196 .
	gªad
 = 
m§_ªad
,

197 .
	gwrôe
 = 
m§_wrôe
,

198 .
	g›í
 = 
m§_›í
,

199 .
	gu∆ocked_io˘l
 = 
m§_io˘l
,

200 .
	gcom∑t_io˘l
 = 
m§_io˘l
,

203 
__˝uöô
 
	$m§_devi˚_¸óã
(
˝u
)

205 
devi˚
 *
dev
;

207 
dev
 = 
	`devi˚_¸óã
(
m§_˛ass
, 
NULL
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
), NULL,

208 "m§%d", 
˝u
);

209  
	`IS_ERR
(
dev
Ë? 
	`PTR_ERR
(dev) : 0;

210 
	}
}

212 
	$m§_devi˚_de°roy
(
˝u
)

214 
	`devi˚_de°roy
(
m§_˛ass
, 
	`MKDEV
(
MSR_MAJOR
, 
˝u
));

215 
	}
}

217 
__˝uöô
 
	$m§_˛ass_˝u_ˇŒback
(
nŸifõr_block
 *
nfb
,

218 
a˘i⁄
, *
h˝u
)

220 
˝u
 = ()
h˝u
;

221 
îr
 = 0;

223 
a˘i⁄
) {

224 
CPU_UP_PREPARE
:

225 
îr
 = 
	`m§_devi˚_¸óã
(
˝u
);

227 
CPU_UP_CANCELED
:

228 
CPU_UP_CANCELED_FROZEN
:

229 
CPU_DEAD
:

230 
	`m§_devi˚_de°roy
(
˝u
);

233  
	`nŸifõr_‰om_î∫o
(
îr
);

234 
	}
}

236 
nŸifõr_block
 
__ªfd©a
 
	gm§_˛ass_˝u_nŸifõr
 = {

237 .
nŸifõr_ˇŒ
 = 
m§_˛ass_˝u_ˇŒback
,

240 *
	$m§_devnode
(
devi˚
 *
dev
, 
mode_t
 *
mode
)

242  
	`ka•rötf
(
GFP_KERNEL
, "˝u/%u/m§", 
	`MINOR
(
dev
->
devt
));

243 
	}
}

245 
__öô
 
	$m§_öô
()

247 
i
, 
îr
 = 0;

248 
i
 = 0;

250 i‡(
	`__ªgi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "˝u/m§", &
m§_f›s
)) {

251 
	`¥ötk
(
KERN_ERR
 "msr: unableÅo get major %d for msr\n",

252 
MSR_MAJOR
);

253 
îr
 = -
EBUSY
;

254 
out
;

256 
m§_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "msr");

257 i‡(
	`IS_ERR
(
m§_˛ass
)) {

258 
îr
 = 
	`PTR_ERR
(
m§_˛ass
);

259 
out_chrdev
;

261 
m§_˛ass
->
devnode
 = 
m§_devnode
;

262 
	`f‹_óch_⁄löe_˝u
(
i
) {

263 
îr
 = 
	`m§_devi˚_¸óã
(
i
);

264 i‡(
îr
 != 0)

265 
out_˛ass
;

267 
	`ªgi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

269 
îr
 = 0;

270 
out
;

272 
out_˛ass
:

273 
i
 = 0;

274 
	`f‹_óch_⁄löe_˝u
(
i
)

275 
	`m§_devi˚_de°roy
(
i
);

276 
	`˛ass_de°roy
(
m§_˛ass
);

277 
out_chrdev
:

278 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

279 
out
:

280  
îr
;

281 
	}
}

283 
__exô
 
	$m§_exô
()

285 
˝u
 = 0;

286 
	`f‹_óch_⁄löe_˝u
(
˝u
)

287 
	`m§_devi˚_de°roy
(
˝u
);

288 
	`˛ass_de°roy
(
m§_˛ass
);

289 
	`__uƒegi°î_chrdev
(
MSR_MAJOR
, 0, 
NR_CPUS
, "cpu/msr");

290 
	`uƒegi°î_hŸ˝u_nŸifõr
(&
m§_˛ass_˝u_nŸifõr
);

291 
	}
}

293 
moduÀ_öô
(
m§_öô
);

294 
	$moduÀ_exô
(
m§_exô
)

296 
	`MODULE_AUTHOR
("H. Peter Anvin <hpa@zytor.com>");

297 
	`MODULE_DESCRIPTION
("x86 generic MSR driver");

298 
	`MODULE_LICENSE
("GPL");

	@/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c

25 
	~<löux/kî√l.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/ty≥s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/•ölock.h
>

31 
	~<löux/°rög.h
>

32 
	~<löux/¸ash_dump.h
>

33 
	~<löux/dma-m≠pög.h
>

34 
	~<löux/bôm≠.h
>

35 
	~<löux/pci_ids.h
>

36 
	~<löux/pci.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/sˇâîli°.h
>

39 
	~<löux/iommu-hñ≥r.h
>

41 
	~<asm/iommu.h
>

42 
	~<asm/ˇlg¨y.h
>

43 
	~<asm/t˚.h
>

44 
	~<asm/pci-dúe˘.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/rio.h
>

48 
	~<asm/bios_ebda.h
>

49 
	~<asm/x86_öô.h
>

51 #ifde‡
CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT


52 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 1;

54 
u£_ˇlg¨y
 
	g__ªad_mo°ly
 = 0;

57 
	#PCI_DEVICE_ID_IBM_CALGARY
 0x02a1

	)

58 
	#PCI_DEVICE_ID_IBM_CALIOC2
 0x0308

	)

61 
	#CALGARY_CONFIG_REG
 0x0108

	)

62 
	#PHB_CSR_OFFSET
 0x0110

	)

63 
	#PHB_PLSSR_OFFSET
 0x0120

	)

64 
	#PHB_CONFIG_RW_OFFSET
 0x0160

	)

65 
	#PHB_IOBASE_BAR_LOW
 0x0170

	)

66 
	#PHB_IOBASE_BAR_HIGH
 0x0180

	)

67 
	#PHB_MEM_1_LOW
 0x0190

	)

68 
	#PHB_MEM_1_HIGH
 0x01A0

	)

69 
	#PHB_IO_ADDR_SIZE
 0x01B0

	)

70 
	#PHB_MEM_1_SIZE
 0x01C0

	)

71 
	#PHB_MEM_ST_OFFSET
 0x01D0

	)

72 
	#PHB_AER_OFFSET
 0x0200

	)

73 
	#PHB_CONFIG_0_HIGH
 0x0220

	)

74 
	#PHB_CONFIG_0_LOW
 0x0230

	)

75 
	#PHB_CONFIG_0_END
 0x0240

	)

76 
	#PHB_MEM_2_LOW
 0x02B0

	)

77 
	#PHB_MEM_2_HIGH
 0x02C0

	)

78 
	#PHB_MEM_2_SIZE_HIGH
 0x02D0

	)

79 
	#PHB_MEM_2_SIZE_LOW
 0x02E0

	)

80 
	#PHB_DOSHOLE_OFFSET
 0x08E0

	)

83 
	#PHB_SAVIOR_L2
 0x0DB0

	)

84 
	#PHB_PAGE_MIG_CTRL
 0x0DA8

	)

85 
	#PHB_PAGE_MIG_DEBUG
 0x0DA0

	)

86 
	#PHB_ROOT_COMPLEX_STATUS
 0x0CB0

	)

89 
	#PHB_TCE_ENABLE
 0x20000000

	)

90 
	#PHB_SLOT_DISABLE
 0x1C000000

	)

91 
	#PHB_DAC_DISABLE
 0x01000000

	)

92 
	#PHB_MEM2_ENABLE
 0x00400000

	)

93 
	#PHB_MCSR_ENABLE
 0x00100000

	)

95 
	#TAR_SW_BITS
 0x0000ffffffff800fUL

	)

96 
	#TAR_VALID
 0x0000000000000008UL

	)

98 
	#CSR_AGENT_MASK
 0xf„0ffff

	)

100 
	#CCR_2SEC_TIMEOUT
 0x000000000000000EUL

	)

102 
	#PMR_SOFTSTOP
 0x80000000

	)

103 
	#PMR_SOFTSTOPFAULT
 0x40000000

	)

104 
	#PMR_HARDSTOP
 0x20000000

	)

113 
	#MAX_PHB_BUS_NUM
 256

	)

115 
	#PHBS_PER_CALGARY
 4

	)

118 c⁄° 
	gèr_off£ts
[] = {

125 c⁄° 
	g•lô_queue_off£ts
[] = {

132 c⁄° 
	gphb_off£ts
[] = {

141 c⁄° 
	gphb_debug_off£ts
[] = {

153 
	#PHB_DEBUG_STUFF_OFFSET
 0x0020

	)

155 
	#EMERGENCY_PAGES
 32

	)

157 
	g•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_UNSPECIFIED
;

158 
å™¶©e_em±y_¶Ÿs
 
	g__ªad_mo°ly
 = 0;

159 
ˇlg¨y_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

161 
rio_èbÀ_hdr
 *rio_èbÀ_hd∏
	g__öôd©a
;

162 
sˇl_dëaû
 *
	gsˇl_devs
[
MAX_NUMNODES
] 
	g__öôd©a
;

163 
rio_dëaû
 *
	grio_devs
[
MAX_NUMNODES
 * 4] 
	g__öôd©a
;

165 
	sˇlg¨y_bus_öfo
 {

166 *
	mt˚_•a˚
;

167 
	må™¶©i⁄_dißbÀd
;

168 sig√d 
	mphbid
;

169 
__iomem
 *
	mbb¨
;

172 
ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

173 
ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

174 
ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

175 
ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
);

176 
ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
);

177 
ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
);

178 
ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
);

179 
gë_t˚_•a˚_‰om_èr
();

181 
ˇl_chù£t_›s
 
	gˇlg¨y_chù_›s
 = {

182 .
h™dÀ_quúks
 = 
ˇlg¨y_h™dÀ_quúks
,

183 .
	gt˚_ˇche_bœ°
 = 
ˇlg¨y_t˚_ˇche_bœ°
,

184 .
	gdump_îr‹_ªgs
 = 
ˇlg¨y_dump_îr‹_ªgs


187 
ˇl_chù£t_›s
 
	gˇlioc2_chù_›s
 = {

188 .
h™dÀ_quúks
 = 
ˇlioc2_h™dÀ_quúks
,

189 .
	gt˚_ˇche_bœ°
 = 
ˇlioc2_t˚_ˇche_bœ°
,

190 .
	gdump_îr‹_ªgs
 = 
ˇlioc2_dump_îr‹_ªgs


193 
ˇlg¨y_bus_öfo
 
	gbus_öfo
[
MAX_PHB_BUS_NUM
] = { { 
NULL
, 0, 0 }, };

195 
ölöe
 
	$å™¶©i⁄_íabÀd
(
iommu_èbÀ
 *
tbl
)

198  (
tbl
 !
NULL
);

199 
	}
}

201 
	$iommu_ønge_ª£rve
(
iommu_èbÀ
 *
tbl
,

202 
°¨t_addr
, 
≈ages
)

204 
ödex
;

205 
íd
;

206 
Êags
;

208 
ödex
 = 
°¨t_addr
 >> 
PAGE_SHIFT
;

211 i‡(
ödex
 >
tbl
->
ô_size
)

214 
íd
 = 
ödex
 + 
≈ages
;

215 i‡(
íd
 > 
tbl
->
ô_size
)

216 
íd
 = 
tbl
->
ô_size
;

218 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

220 
	`bôm≠_£t
(
tbl
->
ô_m≠
, 
ödex
, 
≈ages
);

222 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

223 
	}
}

225 
	$iommu_ønge_Æloc
(
devi˚
 *
dev
,

226 
iommu_èbÀ
 *
tbl
,

227 
≈ages
)

229 
Êags
;

230 
off£t
;

231 
bound¨y_size
;

233 
bound¨y_size
 = 
	`ALIGN
(
	`dma_gë_£g_bound¨y
(
dev
) + 1,

234 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

236 
	`BUG_ON
(
≈ages
 == 0);

238 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

240 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
,Åbl->
ô_höt
,

241 
≈ages
, 0, 
bound¨y_size
, 0);

242 i‡(
off£t
 == ~0UL) {

243 
tbl
->
chù_›s
->
	`t˚_ˇche_bœ°
(tbl);

245 
off£t
 = 
	`iommu_¨ó_Æloc
(
tbl
->
ô_m≠
,Åbl->
ô_size
, 0,

246 
≈ages
, 0, 
bound¨y_size
, 0);

247 i‡(
off£t
 == ~0UL) {

248 
	`¥ötk
(
KERN_WARNING
 "Calgary: IOMMU full.\n");

249 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

250 i‡(
∑nic_⁄_ovîÊow
)

251 
	`∑nic
("Calgary: fixÅheállocator.\n");

253  
DMA_ERROR_CODE
;

257 
tbl
->
ô_höt
 = 
off£t
 + 
≈ages
;

258 
	`BUG_ON
(
tbl
->
ô_höt
 >Åbl->
ô_size
);

260 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

262  
off£t
;

263 
	}
}

265 
dma_addr_t
 
	$iommu_Æloc
(
devi˚
 *
dev
, 
iommu_èbÀ
 *
tbl
,

266 *
vaddr
, 
≈ages
, 
dúe˘i⁄
)

268 
íåy
;

269 
dma_addr_t
 
ªt
;

271 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

273 i‡(
	`u∆ikñy
(
íåy
 =
DMA_ERROR_CODE
)) {

274 
	`¥ötk
(
KERN_WARNING
 "Calgary: failedÅoállocate %uÖages in "

275 "iommu %p\n", 
≈ages
, 
tbl
);

276  
DMA_ERROR_CODE
;

280 
ªt
 = (
íåy
 << 
PAGE_SHIFT
Ë| (()
vaddr
 & ~
PAGE_MASK
);

283 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, ()
vaddr
 & 
PAGE_MASK
,

284 
dúe˘i⁄
);

285  
ªt
;

286 
	}
}

288 
	$iommu_‰ì
(
iommu_èbÀ
 *
tbl
, 
dma_addr_t
 
dma_addr
,

289 
≈ages
)

291 
íåy
;

292 
badíd
;

293 
Êags
;

296 
badíd
 = 
DMA_ERROR_CODE
 + (
EMERGENCY_PAGES
 * 
PAGE_SIZE
);

297 i‡(
	`u∆ikñy
((
dma_addr
 >
DMA_ERROR_CODE
Ë&& (dma_add∏< 
badíd
))) {

298 
	`WARN
(1, 
KERN_ERR
 "Calgary: driverÅried unmapping bad DMA "

299 "addªs†0x%Lx\n", 
dma_addr
);

303 
íåy
 = 
dma_addr
 >> 
PAGE_SHIFT
;

305 
	`BUG_ON
(
íåy
 + 
≈ages
 > 
tbl
->
ô_size
);

307 
	`t˚_‰ì
(
tbl
, 
íåy
, 
≈ages
);

309 
	`•ö_lock_úqßve
(&
tbl
->
ô_lock
, 
Êags
);

311 
	`bôm≠_˛ór
(
tbl
->
ô_m≠
, 
íåy
, 
≈ages
);

313 
	`•ö_u∆ock_úqª°‹e
(&
tbl
->
ô_lock
, 
Êags
);

314 
	}
}

316 
ölöe
 
iommu_èbÀ
 *
	$föd_iommu_èbÀ
(
devi˚
 *
dev
)

318 
pci_dev
 *
pdev
;

319 
pci_bus
 *
pbus
;

320 
iommu_èbÀ
 *
tbl
;

322 
pdev
 = 
	`to_pci_dev
(
dev
);

325 
pbus
 = 
pdev
->
bus
;

327 
tbl
 = 
	`pci_iommu
(
pbus
);

328 i‡(
tbl
 &&Åbl->
ô_bu¢o
 =
pbus
->
numbî
)

330 
tbl
 = 
NULL
;

331 
pbus
 =Öbus->
∑ª¡
;

332 } 
pbus
);

334 
	`BUG_ON
(
tbl
 && (tbl->
ô_bu¢o
 !
pbus
->
numbî
));

336  
tbl
;

337 
	}
}

339 
	$ˇlg¨y_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sgli°
,

340 
√Àms
,
dma_d©a_dúe˘i⁄
 
dú
,

341 
dma_©ås
 *
©ås
)

343 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

344 
sˇâîli°
 *
s
;

345 
i
;

347 i‡(!
	`å™¶©i⁄_íabÀd
(
tbl
))

350 
	`f‹_óch_sg
(
sgli°
, 
s
, 
√Àms
, 
i
) {

351 
≈ages
;

352 
dma_addr_t
 
dma
 = 
s
->
dma_addªss
;

353 
dmÆí
 = 
s
->
dma_Àngth
;

355 i‡(
dmÆí
 == 0)

358 
≈ages
 = 
	`iommu_num_∑ges
(
dma
, 
dmÆí
, 
PAGE_SIZE
);

359 
	`iommu_‰ì
(
tbl
, 
dma
, 
≈ages
);

361 
	}
}

363 
	$ˇlg¨y_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

364 
√Àms
, 
dma_d©a_dúe˘i⁄
 
dú
,

365 
dma_©ås
 *
©ås
)

367 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

368 
sˇâîli°
 *
s
;

369 
vaddr
;

370 
≈ages
;

371 
íåy
;

372 
i
;

374 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

375 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

377 
vaddr
 = (Ë
	`sg_vút
(
s
);

378 
≈ages
 = 
	`iommu_num_∑ges
(
vaddr
, 
s
->
Àngth
, 
PAGE_SIZE
);

380 
íåy
 = 
	`iommu_ønge_Æloc
(
dev
, 
tbl
, 
≈ages
);

381 i‡(
íåy
 =
DMA_ERROR_CODE
) {

383 
s
->
dma_Àngth
 = 0;

384 
îr‹
;

387 
s
->
dma_addªss
 = (
íåy
 << 
PAGE_SHIFT
Ë| s->
off£t
;

390 
	`t˚_buûd
(
tbl
, 
íåy
, 
≈ages
, 
vaddr
 & 
PAGE_MASK
, 
dú
);

392 
s
->
dma_Àngth
 = s->
Àngth
;

395  
√Àms
;

396 
îr‹
:

397 
	`ˇlg¨y_unm≠_sg
(
dev
, 
sg
, 
√Àms
, 
dú
, 
NULL
);

398 
	`f‹_óch_sg
(
sg
, 
s
, 
√Àms
, 
i
) {

399 
sg
->
dma_addªss
 = 
DMA_ERROR_CODE
;

400 
sg
->
dma_Àngth
 = 0;

403 
	}
}

405 
dma_addr_t
 
	$ˇlg¨y_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

406 
off£t
, 
size_t
 
size
,

407 
dma_d©a_dúe˘i⁄
 
dú
,

408 
dma_©ås
 *
©ås
)

410 *
vaddr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

411 
uaddr
;

412 
≈ages
;

413 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

415 
uaddr
 = ()
vaddr
;

416 
≈ages
 = 
	`iommu_num_∑ges
(
uaddr
, 
size
, 
PAGE_SIZE
);

418  
	`iommu_Æloc
(
dev
, 
tbl
, 
vaddr
, 
≈ages
, 
dú
);

419 
	}
}

421 
	$ˇlg¨y_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

422 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

423 
dma_©ås
 *
©ås
)

425 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

426 
≈ages
;

428 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

429 
	`iommu_‰ì
(
tbl
, 
dma_addr
, 
≈ages
);

430 
	}
}

432 * 
	$ˇlg¨y_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

433 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êag
)

435 *
ªt
 = 
NULL
;

436 
dma_addr_t
 
m≠pög
;

437 
≈ages
, 
‹dî
;

438 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

440 
size
 = 
	`PAGE_ALIGN
(size);

441 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

442 
‹dî
 = 
	`gë_‹dî
(
size
);

444 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

447 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
Êag
, 
‹dî
);

448 i‡(!
ªt
)

449 
îr‹
;

450 
	`mem£t
(
ªt
, 0, 
size
);

453 
m≠pög
 = 
	`iommu_Æloc
(
dev
, 
tbl
, 
ªt
, 
≈ages
, 
DMA_BIDIRECTIONAL
);

454 i‡(
m≠pög
 =
DMA_ERROR_CODE
)

455 
‰ì
;

456 *
dma_h™dÀ
 = 
m≠pög
;

457  
ªt
;

458 
‰ì
:

459 
	`‰ì_∑ges
(()
ªt
, 
	`gë_‹dî
(
size
));

460 
ªt
 = 
NULL
;

461 
îr‹
:

462  
ªt
;

463 
	}
}

465 
	$ˇlg¨y_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

466 *
vaddr
, 
dma_addr_t
 
dma_h™dÀ
)

468 
≈ages
;

469 
iommu_èbÀ
 *
tbl
 = 
	`föd_iommu_èbÀ
(
dev
);

471 
size
 = 
	`PAGE_ALIGN
(size);

472 
≈ages
 = 
size
 >> 
PAGE_SHIFT
;

474 
	`iommu_‰ì
(
tbl
, 
dma_h™dÀ
, 
≈ages
);

475 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

476 
	}
}

478 
dma_m≠_›s
 
	gˇlg¨y_dma_›s
 = {

479 .
Æloc_cohîít
 = 
ˇlg¨y_Æloc_cohîít
,

480 .
	g‰ì_cohîít
 = 
ˇlg¨y_‰ì_cohîít
,

481 .
	gm≠_sg
 = 
ˇlg¨y_m≠_sg
,

482 .
	gunm≠_sg
 = 
ˇlg¨y_unm≠_sg
,

483 .
	gm≠_∑ge
 = 
ˇlg¨y_m≠_∑ge
,

484 .
	gunm≠_∑ge
 = 
ˇlg¨y_unm≠_∑ge
,

487 
ölöe
 
__iomem
 * 
	$bu¢o_to_bb¨
(
num
)

489  
bus_öfo
[
num
].
bb¨
;

490 
	}
}

492 
ölöe
 
	$bu¢o_to_phbid
(
num
)

494  
bus_öfo
[
num
].
phbid
;

495 
	}
}

497 
ölöe
 
	$•lô_queue_off£t
(
num
)

499 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

501  
•lô_queue_off£ts
[
idx
];

502 
	}
}

504 
ölöe
 
	$èr_off£t
(
num
)

506 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

508  
èr_off£ts
[
idx
];

509 
	}
}

511 
ölöe
 
	$phb_off£t
(
num
)

513 
size_t
 
idx
 = 
	`bu¢o_to_phbid
(
num
);

515  
phb_off£ts
[
idx
];

516 
	}
}

518 
ölöe
 
__iomem
* 
	$ˇlg¨y_ªg
(
__iomem
 *
b¨
, 
off£t
)

520 
èrgë
 = (()
b¨
Ë| 
off£t
;

521  (
__iomem
*)
èrgë
;

522 
	}
}

524 
ölöe
 
	$is_ˇlioc2
(
devi˚
)

526  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALIOC2
);

527 
	}
}

529 
ölöe
 
	$is_ˇlg¨y
(
devi˚
)

531  (
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
);

532 
	}
}

534 
ölöe
 
	$is_ˇl_pci_dev
(
devi˚
)

536  (
	`is_ˇlg¨y
(
devi˚
Ë|| 
	`is_ˇlioc2
(device));

537 
	}
}

539 
	$ˇlg¨y_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

541 
u64
 
vÆ
;

542 
u32
 
´r
;

543 
i
 = 0;

544 
__iomem
 *
bb¨
 = 
tbl
->bbar;

545 
__iomem
 *
èrgë
;

548 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

549 
´r
 = 
	`ªadl
(
èrgë
);

550 
	`wrôñ
(0, 
èrgë
);

553 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

554 
vÆ
 = 
	`ªadl
(
èrgë
);

557 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
tbl
->
ô_bu¢o
));

559 
vÆ
 = 
	`ªadq
(
èrgë
);

560 
i
++;

561 } (
vÆ
 & 0xffË!0xf‡&& 
i
 < 100);

562 i‡(
i
 == 100)

563 
	`¥ötk
(
KERN_WARNING
 "Calgary: PCI busÇot quiesced, "

567 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
tbl
->
ô_bu¢o
));

568 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

571 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_AER_OFFSET
);

572 
	`wrôñ
(
´r
, 
èrgë
);

573 ()
	`ªadl
(
èrgë
);

574 
	}
}

576 
	$ˇlioc2_t˚_ˇche_bœ°
(
iommu_èbÀ
 *
tbl
)

578 
__iomem
 *
bb¨
 = 
tbl
->bbar;

579 
__iomem
 *
èrgë
;

580 
u64
 
vÆ64
;

581 
u32
 
vÆ
;

582 
i
 = 0;

583 
cou¡
 = 1;

584 
bus
 = 
tbl
->
ô_bu¢o
;

586 
begö
:

587 
	`¥ötk
(
KERN_DEBUG
 "Calgary: CalIOC2 bus 0x%xÉnteringÅce cache blast "

588 "£quí˚ - cou¡ %d\n", 
bus
, 
cou¡
);

591 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

592 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

593 
	`¥ötk
(
KERN_DEBUG
 "1a.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

594 
vÆ
 |
PMR_SOFTSTOP
;

595 
	`¥ötk
(
KERN_DEBUG
 "1b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

596 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

599 
	`¥ötk
(
KERN_DEBUG
 "2a. startingÅoÖoll split queues\n");

600 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`•lô_queue_off£t
(
bus
));

602 
vÆ64
 = 
	`ªadq
(
èrgë
);

603 
i
++;

604 } (
vÆ64
 & 0xffË!0xf‡&& 
i
 < 100);

605 i‡(
i
 == 100)

606 
	`¥ötk
(
KERN_WARNING
 "CalIOC2: PCI busÇot quiesced, "

610 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

611 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

612 
	`¥ötk
(
KERN_DEBUG
 "3.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

615 i‡(
vÆ
 & 
PMR_SOFTSTOPFAULT
) {

616 i‡(++
cou¡
 < 100)

617 
begö
;

619 
	`¥ötk
(
KERN_WARNING
 "CalIOC2:Åoo many SoftStopFaults, "

626 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

627 
	`¥ötk
(
KERN_DEBUG
 "5a. sœmmög i¡ÿH¨dSt› byÑódög %p\n", 
èrgë
);

628 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

629 
	`¥ötk
(
KERN_DEBUG
 "5b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

630 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_DEBUG
);

631 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

632 
	`¥ötk
(
KERN_DEBUG
 "5c.Ñód 0x%x [LE] from %∞(debug)\n", 
vÆ
, 
èrgë
);

635 
	`¥ötk
(
KERN_DEBUG
 "6. invalidating TCE cache\n");

636 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
bus
));

637 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

640 
	`¥ötk
(
KERN_DEBUG
 "7a. Re-reading PMCR\n");

641 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

642 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

643 
	`¥ötk
(
KERN_DEBUG
 "7b.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

646 
	`¥ötk
(
KERN_DEBUG
 "8a.Ñemoving HardStop from PMCR\n");

647 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bus
Ë| 
PHB_PAGE_MIG_CTRL
);

648 
vÆ
 = 0;

649 
	`¥ötk
(
KERN_DEBUG
 "8b. wrôög 0x%x [LE]Åÿ%p\n", 
vÆ
, 
èrgë
);

650 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

651 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

652 
	`¥ötk
(
KERN_DEBUG
 "8c.Ñód 0x%x [LE] from %p\n", 
vÆ
, 
èrgë
);

653 
	}
}

655 
__öô
 
	$ˇlg¨y_ª£rve_mem_ªgi⁄
(
pci_dev
 *
dev
, 
u64
 
°¨t
,

656 
u64
 
limô
)

658 
num∑ges
;

660 
limô
 =Üimit | 0xfffff;

661 
limô
++;

663 
num∑ges
 = ((
limô
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

664 
	`iommu_ønge_ª£rve
(
	`pci_iommu
(
dev
->
bus
), 
°¨t
, 
num∑ges
);

665 
	}
}

667 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
pci_dev
 *
dev
)

669 
__iomem
 *
èrgë
;

670 
u64
 
low
, 
high
, 
sizñow
;

671 
u64
 
°¨t
, 
limô
;

672 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

673 
bu¢um
 = 
dev
->
bus
->
numbî
;

674 
__iomem
 *
bb¨
 = 
tbl
->bbar;

677 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_LOW
);

678 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

679 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_HIGH
);

680 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

681 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_1_SIZE
);

682 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

684 
°¨t
 = (
high
 << 32Ë| 
low
;

685 
limô
 = 
sizñow
;

687 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

688 
	}
}

690 
__öô
 
	$ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
pci_dev
 *
dev
)

692 
__iomem
 *
èrgë
;

693 
u32
 
vÆ32
;

694 
u64
 
low
, 
high
, 
sizñow
, 
sizehigh
;

695 
u64
 
°¨t
, 
limô
;

696 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

697 
bu¢um
 = 
dev
->
bus
->
numbî
;

698 
__iomem
 *
bb¨
 = 
tbl
->bbar;

701 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

702 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

703 i‡(!(
vÆ32
 & 
PHB_MEM2_ENABLE
))

706 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_LOW
);

707 
low
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

708 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_HIGH
);

709 
high
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

710 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_LOW
);

711 
sizñow
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

712 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_MEM_2_SIZE_HIGH
);

713 
sizehigh
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

715 
°¨t
 = (
high
 << 32Ë| 
low
;

716 
limô
 = (
sizehigh
 << 32Ë| 
sizñow
;

718 
	`ˇlg¨y_ª£rve_mem_ªgi⁄
(
dev
, 
°¨t
, 
limô
);

719 
	}
}

728 
__öô
 
	$ˇlg¨y_ª£rve_ªgi⁄s
(
pci_dev
 *
dev
)

730 
≈ages
;

731 
u64
 
°¨t
;

732 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

735 
	`iommu_ønge_ª£rve
(
tbl
, 
DMA_ERROR_CODE
, 
EMERGENCY_PAGES
);

739 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
)) {

740 
°¨t
 = (640 * 1024);

741 
≈ages
 = ((1024 - 640Ë* 1024Ë>> 
PAGE_SHIFT
;

743 
°¨t
 = 0;

744 
≈ages
 = (1 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

746 
	`iommu_ønge_ª£rve
(
tbl
, 
°¨t
, 
≈ages
);

749 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_1
(
dev
);

750 
	`ˇlg¨y_ª£rve_≥rùhîÆ_mem_2
(
dev
);

751 
	}
}

753 
__öô
 
	$ˇlg¨y_£tup_èr
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

755 
u64
 
vÆ64
;

756 
u64
 
èbÀ_phys
;

757 
__iomem
 *
èrgë
;

758 
ªt
;

759 
iommu_èbÀ
 *
tbl
;

762 
ªt
 = 
	`buûd_t˚_èbÀ
(
dev
, 
bb¨
);

763 i‡(
ªt
)

764  
ªt
;

766 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

767 
tbl
->
ô_ba£
 = ()
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
;

769 i‡(
	`is_kdump_kî√l
())

770 
	`ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
tbl
);

772 
	`t˚_‰ì
(
tbl
, 0,Åbl->
ô_size
);

774 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
))

775 
tbl
->
chù_›s
 = &
ˇlg¨y_chù_›s
;

776 i‡(
	`is_ˇlioc2
(
dev
->
devi˚
))

777 
tbl
->
chù_›s
 = &
ˇlioc2_chù_›s
;

779 
	`BUG
();

781 
	`ˇlg¨y_ª£rve_ªgi⁄s
(
dev
);

784 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

785 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

788 
vÆ64
 &~
TAR_SW_BITS
;

789 
èbÀ_phys
 = (
u64
)
	`__∑
(
tbl
->
ô_ba£
);

791 
vÆ64
 |
èbÀ_phys
;

793 
	`BUG_ON
(
•ecifõd_èbÀ_size
 > 
TCE_TABLE_SIZE_8M
);

794 
vÆ64
 |(
u64
Ë
•ecifõd_èbÀ_size
;

796 
tbl
->
èr_vÆ
 = 
	`˝u_to_be64
(
vÆ64
);

798 
	`wrôeq
(
tbl
->
èr_vÆ
, 
èrgë
);

799 
	`ªadq
(
èrgë
);

802 
	}
}

804 
__öô
 
	$ˇlg¨y_‰ì_bus
(
pci_dev
 *
dev
)

806 
u64
 
vÆ64
;

807 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

808 
__iomem
 *
èrgë
;

809 
bôm≠sz
;

811 
èrgë
 = 
	`ˇlg¨y_ªg
(
tbl
->
bb¨
, 
	`èr_off£t
(
dev
->
bus
->
numbî
));

812 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

813 
vÆ64
 &~
TAR_SW_BITS
;

814 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

815 
	`ªadq
(
èrgë
);

817 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

818 
	`‰ì_∑ges
(()
tbl
->
ô_m≠
, 
	`gë_‹dî
(
bôm≠sz
));

819 
tbl
->
ô_m≠
 = 
NULL
;

821 
	`k‰ì
(
tbl
);

823 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

826 
bus_öfo
[
dev
->
bus
->
numbî
].
t˚_•a˚
 = 
NULL
;

827 
	}
}

829 
	$ˇlg¨y_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

831 
__iomem
 *
bb¨
 = 
tbl
->bbar;

832 
__iomem
 *
èrgë
;

833 
u32
 
c§
, 
∂s§
;

835 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

836 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

838 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_PLSSR_OFFSET
);

839 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

842 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on Calgary PHB 0x%x, "

843 "0x%08x@CSR 0x%08x@PLSSR\n", 
tbl
->
ô_bu¢o
, 
c§
, 
∂s§
);

844 
	}
}

846 
	$ˇlioc2_dump_îr‹_ªgs
(
iommu_èbÀ
 *
tbl
)

848 
__iomem
 *
bb¨
 = 
tbl
->bbar;

849 
u32
 
c§
, 
csmr
, 
∂s§
, 
mck
, 
rc°©
;

850 
__iomem
 *
èrgë
;

851 
phboff
 = 
	`phb_off£t
(
tbl
->
ô_bu¢o
);

852 
îroff
;

853 
u32
 
îºegs
[7];

854 
i
;

857 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_CSR_OFFSET
);

858 
c§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

860 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_PLSSR_OFFSET
);

861 
∂s§
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

863 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x290);

864 
csmr
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

866 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 0x800);

867 
mck
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

869 
	`¥ötk
(
KERN_EMERG
 "Calgary: DMAÉrror on CalIOC2 PHB 0x%x\n",

870 
tbl
->
ô_bu¢o
);

872 
	`¥ötk
(
KERN_EMERG
 "Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK\n",

873 
c§
, 
∂s§
, 
csmr
, 
mck
);

876 
	`¥ötk
(
KERN_EMERG
 "Calgary: ");

877 
i
 = 0; i < 
	`ARRAY_SIZE
(
îºegs
); i++) {

879 
îroff
 = (0x810 + (
i
 * 0x10));

880 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
îroff
);

881 
îºegs
[
i
] = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

882 
	`¥ötk
("0x%08x@0x%lx ", 
îºegs
[
i
], 
îroff
);

884 
	`¥ötk
("\n");

887 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
phboff
 | 
PHB_ROOT_COMPLEX_STATUS
);

888 
rc°©
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

889 
	`¥ötk
(
KERN_EMERG
 "CÆg¨y: 0x%08x@0x%x\n", 
rc°©
,

890 
PHB_ROOT_COMPLEX_STATUS
);

891 
	}
}

893 
	$ˇlg¨y_w©chdog
(
d©a
)

895 
pci_dev
 *
dev
 = (pci_dev *)
d©a
;

896 
iommu_èbÀ
 *
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

897 
__iomem
 *
bb¨
 = 
tbl
->bbar;

898 
u32
 
vÆ32
;

899 
__iomem
 *
èrgë
;

901 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
Ë| 
PHB_CSR_OFFSET
);

902 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

905 i‡(
vÆ32
 & 
CSR_AGENT_MASK
) {

906 
tbl
->
chù_›s
->
	`dump_îr‹_ªgs
(tbl);

909 
	`wrôñ
(0, 
èrgë
);

912 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
tbl
->
ô_bu¢o
) |

913 
PHB_CONFIG_RW_OFFSET
);

914 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

915 
vÆ32
 |
PHB_SLOT_DISABLE
;

916 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

917 
	`ªadl
(
èrgë
);

920 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
 + 2 * 
HZ
);

922 
	}
}

924 
__öô
 
	$ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
__iomem
 *
bb¨
,

925 
bu¢um
, 
timeout
)

927 
u64
 
vÆ64
;

928 
__iomem
 *
èrgë
;

929 
phb_shi·
 = ~0;

930 
u64
 
mask
;

932 
	`bu¢o_to_phbid
(
bu¢um
)) {

933 0: 
phb_shi·
 = (63 - 19);

935 1: 
phb_shi·
 = (63 - 23);

937 2: 
phb_shi·
 = (63 - 27);

939 3: 
phb_shi·
 = (63 - 35);

942 
	`BUG_ON
(
	`bu¢o_to_phbid
(
bu¢um
));

945 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
CALGARY_CONFIG_REG
);

946 
vÆ64
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

949 
mask
 = ~(0xFUL << 
phb_shi·
);

950 
vÆ64
 &
mask
;

951 
vÆ64
 |(
timeout
 << 
phb_shi·
);

952 
	`wrôeq
(
	`˝u_to_be64
(
vÆ64
), 
èrgë
);

953 
	`ªadq
(
èrgë
);

954 
	}
}

956 
__öô
 
	$ˇlioc2_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

958 
bu¢um
 = 
dev
->
bus
->
numbî
;

959 
__iomem
 *
bb¨
 = 
tbl
->bbar;

960 
__iomem
 *
èrgë
;

961 
u32
 
vÆ
;

966 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_SAVIOR_L2
);

967 
vÆ
 = 
	`˝u_to_be32
(
	`ªadl
(
èrgë
));

968 
vÆ
 |= 0x00800000;

969 
	`wrôñ
(
	`˝u_to_be32
(
vÆ
), 
èrgë
);

970 
	}
}

972 
__öô
 
	$ˇlg¨y_h™dÀ_quúks
(
iommu_èbÀ
 *
tbl
, 
pci_dev
 *
dev
)

974 
bu¢um
 = 
dev
->
bus
->
numbî
;

980 i‡(
	`is_ˇlg¨y
(
dev
->
devi˚
Ë&& (
bu¢um
 == 1))

981 
	`ˇlg¨y_£t_•lô_com∂ëi⁄_timeout
(
tbl
->
bb¨
, 
bu¢um
,

982 
CCR_2SEC_TIMEOUT
);

983 
	}
}

985 
__öô
 
	$ˇlg¨y_íabÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

987 
u32
 
vÆ32
;

988 
bu¢um
;

989 
__iomem
 *
èrgë
;

990 
__iomem
 *
bb¨
;

991 
iommu_èbÀ
 *
tbl
;

993 
bu¢um
 = 
dev
->
bus
->
numbî
;

994 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

995 
bb¨
 = 
tbl
->bbar;

998 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

999 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1000 
vÆ32
 |
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
;

1002 
	`¥ötk
(
KERN_INFO
 "Calgary:ÉnablingÅranslation on %s PHB %#x\n",

1003 (
dev
->
devi˚
 =
PCI_DEVICE_ID_IBM_CALGARY
) ?

1004 "CÆg¨y" : "CÆIOC2", 
bu¢um
);

1005 
	`¥ötk
(
KERN_INFO
 "Calgary:Érrant DMAs willÇow beÖrevented onÅhis "

1008 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1009 
	`ªadl
(
èrgë
);

1011 
	`öô_timî
(&
tbl
->
w©chdog_timî
);

1012 
tbl
->
w©chdog_timî
.
fun˘i⁄
 = &
ˇlg¨y_w©chdog
;

1013 
tbl
->
w©chdog_timî
.
d©a
 = ()
dev
;

1014 
	`mod_timî
(&
tbl
->
w©chdog_timî
, 
jiffõs
);

1015 
	}
}

1017 
__öô
 
	$ˇlg¨y_dißbÀ_å™¶©i⁄
(
pci_dev
 *
dev
)

1019 
u32
 
vÆ32
;

1020 
bu¢um
;

1021 
__iomem
 *
èrgë
;

1022 
__iomem
 *
bb¨
;

1023 
iommu_èbÀ
 *
tbl
;

1025 
bu¢um
 = 
dev
->
bus
->
numbî
;

1026 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1027 
bb¨
 = 
tbl
->bbar;

1030 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
	`phb_off£t
(
bu¢um
Ë| 
PHB_CONFIG_RW_OFFSET
);

1031 
vÆ32
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1032 
vÆ32
 &~(
PHB_TCE_ENABLE
 | 
PHB_DAC_DISABLE
 | 
PHB_MCSR_ENABLE
);

1034 
	`¥ötk
(
KERN_INFO
 "CÆg¨y: dißblögÅøn¶©i⁄ o¿PHB %#x!\n", 
bu¢um
);

1035 
	`wrôñ
(
	`˝u_to_be32
(
vÆ32
), 
èrgë
);

1036 
	`ªadl
(
èrgë
);

1038 
	`dñ_timî_sync
(&
tbl
->
w©chdog_timî
);

1039 
	}
}

1041 
__öô
 
	$ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
pci_dev
 *
dev
)

1043 
	`pci_dev_gë
(
dev
);

1044 
	`£t_pci_iommu
(
dev
->
bus
, 
NULL
);

1047 i‡(
dev
->
bus
->
∑ª¡
)

1048 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1050 
dev
->
bus
->
£lf
 = dev;

1051 
	}
}

1053 
__öô
 
	$ˇlg¨y_öô_⁄e
(
pci_dev
 *
dev
)

1055 
__iomem
 *
bb¨
;

1056 
iommu_èbÀ
 *
tbl
;

1057 
ªt
;

1059 
bb¨
 = 
	`bu¢o_to_bb¨
(
dev
->
bus
->
numbî
);

1060 
ªt
 = 
	`ˇlg¨y_£tup_èr
(
dev
, 
bb¨
);

1061 i‡(
ªt
)

1062 
d⁄e
;

1064 
	`pci_dev_gë
(
dev
);

1066 i‡(
dev
->
bus
->
∑ª¡
) {

1067 i‡(
dev
->
bus
->
∑ª¡
->
£lf
)

1068 
	`¥ötk
(
KERN_WARNING
 "Calgary: IEEEE, dev %p has "

1069 "bus->∑ª¡->£lf!\n", 
dev
);

1070 
dev
->
bus
->
∑ª¡
->
£lf
 = dev;

1072 
dev
->
bus
->
£lf
 = dev;

1074 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1075 
tbl
->
chù_›s
->
	`h™dÀ_quúks
—bl, 
dev
);

1077 
	`ˇlg¨y_íabÀ_å™¶©i⁄
(
dev
);

1081 
d⁄e
:

1082  
ªt
;

1083 
	}
}

1085 
__öô
 
	$ˇlg¨y_loˇã_bb¨s
()

1087 
ªt
;

1088 
rioidx
, 
phb
, 
bus
;

1089 
__iomem
 *
bb¨
;

1090 
__iomem
 *
èrgë
;

1091 
off£t
;

1092 
u8
 
°¨t_bus
, 
íd_bus
;

1093 
u32
 
vÆ
;

1095 
ªt
 = -
ENODATA
;

1096 
rioidx
 = 0;Ñioidx < 
rio_èbÀ_hdr
->
num_rio_dev
;Ñioidx++) {

1097 
rio_dëaû
 *
rio
 = 
rio_devs
[
rioidx
];

1099 i‡((
rio
->
ty≥
 !
COMPAT_CALGARY
Ë&& (rio->ty≥ !
ALT_CALGARY
))

1103 
bb¨
 = 
	`i‹em≠_noˇche
(
rio
->
BBAR
, 1024 * 1024);

1104 i‡(!
bb¨
)

1105 
îr‹
;

1107 
phb
 = 0;Öhb < 
PHBS_PER_CALGARY
;Öhb++) {

1108 
off£t
 = 
phb_debug_off£ts
[
phb
] | 
PHB_DEBUG_STUFF_OFFSET
;

1109 
èrgë
 = 
	`ˇlg¨y_ªg
(
bb¨
, 
off£t
);

1111 
vÆ
 = 
	`be32_to_˝u
(
	`ªadl
(
èrgë
));

1113 
°¨t_bus
 = (
u8
)((
vÆ
 & 0x00FF0000) >> 16);

1114 
íd_bus
 = (
u8
)((
vÆ
 & 0x0000FF00) >> 8);

1116 i‡(
íd_bus
) {

1117 
bus
 = 
°¨t_bus
; bu†<
íd_bus
; bus++) {

1118 
bus_öfo
[
bus
].
bb¨
 = bbar;

1119 
bus_öfo
[
bus
].
phbid
 = 
phb
;

1122 
bus_öfo
[
°¨t_bus
].
bb¨
 = bbar;

1123 
bus_öfo
[
°¨t_bus
].
phbid
 = 
phb
;

1130 
îr‹
:

1132 
bus
 = 0; bu†< 
	`ARRAY_SIZE
(
bus_öfo
); bus++)

1133 i‡(
bus_öfo
[
bus
].
bb¨
)

1134 
	`iounm≠
(
bus_öfo
[
bus
].
bb¨
);

1136  
ªt
;

1137 
	}
}

1139 
__öô
 
	$ˇlg¨y_öô
()

1141 
ªt
;

1142 
pci_dev
 *
dev
 = 
NULL
;

1143 
ˇlg¨y_bus_öfo
 *
öfo
;

1145 
ªt
 = 
	`ˇlg¨y_loˇã_bb¨s
();

1146 i‡(
ªt
)

1147  
ªt
;

1150 i‡(
	`is_kdump_kî√l
())

1151 
	`gë_t˚_•a˚_‰om_èr
();

1154 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1155 i‡(!
dev
)

1157 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1160 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1161 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1162 
	`ˇlg¨y_öô_⁄e_n⁄åa¶©ed
(
dev
);

1166 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1169 
ªt
 = 
	`ˇlg¨y_öô_⁄e
(
dev
);

1170 i‡(
ªt
)

1171 
îr‹
;

1174 
dev
 = 
NULL
;

1175 
	`f‹_óch_pci_dev
(
dev
) {

1176 
iommu_èbÀ
 *
tbl
;

1178 
tbl
 = 
	`föd_iommu_èbÀ
(&
dev
->dev);

1180 i‡(
	`å™¶©i⁄_íabÀd
(
tbl
))

1181 
dev
->dev.
¨chd©a
.
dma_›s
 = &
ˇlg¨y_dma_›s
;

1184  
ªt
;

1186 
îr‹
:

1188 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1189 i‡(!
dev
)

1191 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1194 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1195 i‡(
öfo
->
å™¶©i⁄_dißbÀd
) {

1196 
	`pci_dev_put
(
dev
);

1199 i‡(!
öfo
->
t˚_•a˚
 && !
å™¶©e_em±y_¶Ÿs
)

1202 
	`ˇlg¨y_dißbÀ_å™¶©i⁄
(
dev
);

1203 
	`ˇlg¨y_‰ì_bus
(
dev
);

1204 
	`pci_dev_put
(
dev
);

1205 
dev
->dev.
¨chd©a
.
dma_›s
 = 
NULL
;

1208  
ªt
;

1209 
	}
}

1211 
ölöe
 
__öô
 
	$dëîmöe_t˚_èbÀ_size
(
u64
 
øm
)

1213 
ªt
;

1215 i‡(
•ecifõd_èbÀ_size
 !
TCE_TABLE_SIZE_UNSPECIFIED
)

1216  
•ecifõd_èbÀ_size
;

1225 
ªt
 = 
	`gë_‹dî
(
øm
 >> 13);

1226 i‡(
ªt
 > 
TCE_TABLE_SIZE_8M
)

1227 
ªt
 = 
TCE_TABLE_SIZE_8M
;

1229  
ªt
;

1230 
	}
}

1232 
__öô
 
	$buûd_dëaû_¨øys
()

1234 
±r
;

1235 
numnodes
, 
i
;

1236 
sˇl_dëaû_size
, 
rio_dëaû_size
;

1238 
numnodes
 = 
rio_èbÀ_hdr
->
num_sˇl_dev
;

1239 i‡(
numnodes
 > 
MAX_NUMNODES
){

1240 
	`¥ötk
(
KERN_WARNING


1243 
MAX_NUMNODES
, 
numnodes
);

1244  -
ENODEV
;

1247 
rio_èbÀ_hdr
->
vîsi⁄
){

1249 
sˇl_dëaû_size
 = 11;

1250 
rio_dëaû_size
 = 13;

1253 
sˇl_dëaû_size
 = 12;

1254 
rio_dëaû_size
 = 15;

1257 
	`¥ötk
(
KERN_WARNING


1259 
rio_èbÀ_hdr
->
vîsi⁄
);

1260  -
EPROTO
;

1263 
±r
 = (()
rio_èbÀ_hdr
) + 3;

1264 
i
 = 0; i < 
numnodes
; i++, 
±r
 +
sˇl_dëaû_size
)

1265 
sˇl_devs
[
i
] = (
sˇl_dëaû
 *)
±r
;

1267 
i
 = 0; i < 
rio_èbÀ_hdr
->
num_rio_dev
;

1268 
i
++, 
±r
 +
rio_dëaû_size
)

1269 
rio_devs
[
i
] = (
rio_dëaû
 *)
±r
;

1272 
	}
}

1274 
__öô
 
	$ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_dev
)

1276 
dev
;

1277 
u32
 
vÆ
;

1279 i‡(
pci_dev
 =
PCI_DEVICE_ID_IBM_CALIOC2
) {

1287 
dev
 = 1; dev < 8; dev++) {

1288 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 
dev
, 0, 0);

1289 i‡(
vÆ
 != 0xffffffff)

1292  (
vÆ
 != 0xffffffff);

1293 
	}
}

1300 
	$ˇlg¨y_öô_bôm≠_‰om_t˚_èbÀ
(
iommu_èbÀ
 *
tbl
)

1302 
u64
 *
ç
;

1303 
ödex
;

1304 
ç
 = ((
u64
 *)
tbl
->
ô_ba£
);

1305 
ödex
 = 0 ; index < 
tbl
->
ô_size
; index++) {

1306 i‡(*
ç
 != 0x0)

1307 
	`£t_bô
(
ödex
, 
tbl
->
ô_m≠
);

1308 
ç
++;

1310 
	}
}

1317 
__öô
 
	$gë_t˚_•a˚_‰om_èr
()

1319 
bus
;

1320 
__iomem
 *
èrgë
;

1321 
t˚_•a˚
;

1323 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1324 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1325 
pci_devi˚
;

1326 
u32
 
vÆ
;

1328 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1329 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1331 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1333 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1336 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1337 
å™¶©e_em±y_¶Ÿs
) {

1338 
èrgë
 = 
	`ˇlg¨y_ªg
(
bus_öfo
[
bus
].
bb¨
,

1339 
	`èr_off£t
(
bus
));

1340 
t˚_•a˚
 = 
	`be64_to_˝u
(
	`ªadq
(
èrgë
));

1341 
t˚_•a˚
 =Å˚_•a˚ & 
TAR_SW_BITS
;

1343 
t˚_•a˚
 =Å˚_•a˚ & (~
•ecifõd_èbÀ_size
);

1344 
öfo
->
t˚_•a˚
 = (
u64
 *)
	`__va
(tce_space);

1348 
	}
}

1350 
__öô
 
	$ˇlg¨y_iommu_öô
()

1352 
ªt
;

1355 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Using Calgary IOMMU\n");

1357 
ªt
 = 
	`ˇlg¨y_öô
();

1358 i‡(
ªt
) {

1359 
	`¥ötk
(
KERN_ERR
 "PCI-DMA: Calgary init failed %d, "

1360 "ÁŒög backÅÿno_iommu\n", 
ªt
);

1361  
ªt
;

1365 
	}
}

1367 
__öô
 
	$dëe˘_ˇlg¨y
()

1369 
bus
;

1370 *
tbl
;

1371 
ˇlg¨y_found
 = 0;

1372 
±r
;

1373 
off£t
, 
¥ev_off£t
;

1374 
ªt
;

1380 i‡(
no_iommu
 || 
iommu_dëe˘ed
)

1383 i‡(!
u£_ˇlg¨y
)

1386 i‡(!
	`óæy_pci_Ælowed
())

1389 
	`¥ötk
(
KERN_DEBUG
 "Calgary: detecting Calgary via BIOS EBDAárea\n");

1391 
±r
 = ()
	`phys_to_vút
(
	`gë_bios_ebda
());

1393 
rio_èbÀ_hdr
 = 
NULL
;

1394 
¥ev_off£t
 = 0;

1395 
off£t
 = 0x180;

1400 
off£t
 > 
¥ev_off£t
) {

1402 i‡(*((*)(
±r
 + 
off£t
 + 2)) == 0x4752){

1404 
rio_èbÀ_hdr
 = (rio_èbÀ_hd∏*)(
±r
 + 
off£t
 + 4);

1407 
¥ev_off£t
 = 
off£t
;

1408 
off£t
 = *((*)(
±r
 + offset));

1410 i‡(!
rio_èbÀ_hdr
) {

1411 
	`¥ötk
(
KERN_DEBUG
 "Calgary: UnableÅoÜocate Rio GrandeÅable "

1416 
ªt
 = 
	`buûd_dëaû_¨øys
();

1417 i‡(
ªt
) {

1418 
	`¥ötk
(
KERN_DEBUG
 "CÆg¨y: buûd_dëaû_¨øy†ªà%d\n", 
ªt
);

1422 
•ecifõd_èbÀ_size
 = 
	`dëîmöe_t˚_èbÀ_size
((
	`is_kdump_kî√l
() ?

1423 
ßved_max_p‚
 : 
max_p‚
Ë* 
PAGE_SIZE
);

1425 
bus
 = 0; bu†< 
MAX_PHB_BUS_NUM
; bus++) {

1426 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1427 
pci_devi˚
;

1428 
u32
 
vÆ
;

1430 
vÆ
 = 
	`ªad_pci_c⁄fig
(
bus
, 0, 0, 0);

1431 
pci_devi˚
 = (
vÆ
 & 0xFFFF0000) >> 16;

1433 i‡(!
	`is_ˇl_pci_dev
(
pci_devi˚
))

1436 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1439 i‡(
	`ˇlg¨y_bus_has_devi˚s
(
bus
, 
pci_devi˚
) ||

1440 
å™¶©e_em±y_¶Ÿs
) {

1445 i‡(!
	`is_kdump_kî√l
()) {

1446 
tbl
 = 
	`Æloc_t˚_èbÀ
();

1447 i‡(!
tbl
)

1448 
˛ónup
;

1449 
öfo
->
t˚_•a˚
 = 
tbl
;

1451 
ˇlg¨y_found
 = 1;

1455 
	`¥ötk
(
KERN_DEBUG
 "Calgary: finished detection, Calgary %s\n",

1456 
ˇlg¨y_found
 ? "found" : "not found");

1458 i‡(
ˇlg¨y_found
) {

1459 
iommu_dëe˘ed
 = 1;

1460 
ˇlg¨y_dëe˘ed
 = 1;

1461 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary IOMMU detected.\n");

1462 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: Calgary TCEÅable spec is %d\n",

1463 
•ecifõd_èbÀ_size
);

1465 
x86_öô
.
iommu
.
iommu_öô
 = 
ˇlg¨y_iommu_öô
;

1469 
˛ónup
:

1470 --
bus
; bus >= 0; --bus) {

1471 
ˇlg¨y_bus_öfo
 *
öfo
 = &
bus_öfo
[
bus
];

1473 i‡(
öfo
->
t˚_•a˚
)

1474 
	`‰ì_t˚_èbÀ
(
öfo
->
t˚_•a˚
);

1476 
	}
}

1478 
__öô
 
	$ˇlg¨y_∑r£_›ti⁄s
(*
p
)

1480 
bridge
;

1481 
size_t
 
Àn
;

1482 * 
ídp
;

1484 *
p
) {

1485 i‡(!
	`°∫cmp
(
p
, "64k", 3))

1486 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_64K
;

1487 i‡(!
	`°∫cmp
(
p
, "128k", 4))

1488 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_128K
;

1489 i‡(!
	`°∫cmp
(
p
, "256k", 4))

1490 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_256K
;

1491 i‡(!
	`°∫cmp
(
p
, "512k", 4))

1492 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_512K
;

1493 i‡(!
	`°∫cmp
(
p
, "1M", 2))

1494 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_1M
;

1495 i‡(!
	`°∫cmp
(
p
, "2M", 2))

1496 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_2M
;

1497 i‡(!
	`°∫cmp
(
p
, "4M", 2))

1498 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_4M
;

1499 i‡(!
	`°∫cmp
(
p
, "8M", 2))

1500 
•ecifõd_èbÀ_size
 = 
TCE_TABLE_SIZE_8M
;

1502 
Àn
 = 
	`°æí
("translate_empty_slots");

1503 i‡(!
	`°∫cmp
(
p
, "å™¶©e_em±y_¶Ÿs", 
Àn
))

1504 
å™¶©e_em±y_¶Ÿs
 = 1;

1506 
Àn
 = 
	`°æí
("disable");

1507 i‡(!
	`°∫cmp
(
p
, "dißbÀ", 
Àn
)) {

1508 
p
 +
Àn
;

1509 i‡(*
p
 == '=')

1510 ++
p
;

1511 i‡(*
p
 == '\0')

1513 
bridge
 = 
	`sim∂e_°πoul
(
p
, &
ídp
, 0);

1514 i‡(
p
 =
ídp
)

1517 i‡(
bridge
 < 
MAX_PHB_BUS_NUM
) {

1518 
	`¥ötk
(
KERN_INFO
 "Calgary: disabling "

1519 "å™¶©i⁄ f‹ PHB %#x\n", 
bridge
);

1520 
bus_öfo
[
bridge
].
å™¶©i⁄_dißbÀd
 = 1;

1524 
p
 = 
	`°Ωbrk
(p, ",");

1525 i‡(!
p
)

1528 
p
++;

1531 
	}
}

1532 
__£tup
("ˇlg¨y=", 
ˇlg¨y_∑r£_›ti⁄s
);

1534 
__öô
 
	$ˇlg¨y_fixup_⁄e_t˚_•a˚
(
pci_dev
 *
dev
)

1536 
iommu_èbÀ
 *
tbl
;

1537 
≈ages
;

1538 
i
;

1540 
tbl
 = 
	`pci_iommu
(
dev
->
bus
);

1542 
i
 = 0; i < 4; i++) {

1543 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
PCI_BRIDGE_RESOURCES
 + 
i
];

1546 i‡(!(
r
->
Êags
 & 
IORESOURCE_MEM
))

1550 i‡(!
r
->
°¨t
)

1554 
≈ages
 = (
r
->
íd
 -Ñ->
°¨t
Ë>> 
PAGE_SHIFT
;

1555 
≈ages
++;

1557 
	`iommu_ønge_ª£rve
(
tbl
, 
r
->
°¨t
, 
≈ages
);

1559 
	}
}

1561 
__öô
 
	$ˇlg¨y_fixup_t˚_•a˚s
()

1563 
pci_dev
 *
dev
 = 
NULL
;

1564 
ˇlg¨y_bus_öfo
 *
öfo
;

1566 i‡(
no_iommu
 || 
swiŸlb
 || !
ˇlg¨y_dëe˘ed
)

1567  -
ENODEV
;

1569 
	`¥ötk
(
KERN_DEBUG
 "Calgary: fixing upÅce spaces\n");

1572 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_IBM
, 
PCI_ANY_ID
, dev);

1573 i‡(!
dev
)

1575 i‡(!
	`is_ˇl_pci_dev
(
dev
->
devi˚
))

1578 
öfo
 = &
bus_öfo
[
dev
->
bus
->
numbî
];

1579 i‡(
öfo
->
å™¶©i⁄_dißbÀd
)

1582 i‡(!
öfo
->
t˚_•a˚
)

1585 
	`ˇlg¨y_fixup_⁄e_t˚_•a˚
(
dev
);

1590 
	}
}

1596 
roŸfs_öôˇŒ
(
ˇlg¨y_fixup_t˚_•a˚s
);

	@/cmpt816/linux/arch/x86/kernel/pci-dma.c

1 
	~<löux/dma-m≠pög.h
>

2 
	~<löux/dma-debug.h
>

3 
	~<löux/dm¨.h
>

4 
	~<löux/boŸmem.h
>

5 
	~<löux/gÂ.h
>

6 
	~<löux/pci.h
>

7 
	~<löux/kmemÀak.h
>

9 
	~<asm/¥Ÿo.h
>

10 
	~<asm/dma.h
>

11 
	~<asm/iommu.h
>

12 
	~<asm/g¨t.h
>

13 
	~<asm/ˇlg¨y.h
>

14 
	~<asm/amd_iommu.h
>

15 
	~<asm/x86_öô.h
>

17 
f‹bid_dac
 
	g__ªad_mo°ly
;

19 
dma_m≠_›s
 *
	gdma_›s
 = &
nommu_dma_›s
;

20 
EXPORT_SYMBOL
(
dma_›s
);

22 
iommu_ßc_f‹˚
 
	g__ªad_mo°ly
;

24 #ifde‡
CONFIG_IOMMU_DEBUG


25 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 1;

26 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 1;

28 
∑nic_⁄_ovîÊow
 
	g__ªad_mo°ly
 = 0;

29 
f‹˚_iommu
 
	g__ªad_mo°ly
 = 0;

32 
iommu_mîge
 
	g__ªad_mo°ly
 = 0;

34 
no_iommu
 
	g__ªad_mo°ly
;

36 
iommu_dëe˘ed
 
	g__ªad_mo°ly
 = 0;

45 
iommu_∑ss_through
 
	g__ªad_mo°ly
;

48 
devi˚
 
	gx86_dma_ÁŒback_dev
 = {

49 .
öô_«me
 = "fallback device",

50 .
	gcohîít_dma_mask
 = 
ISA_DMA_BIT_MASK
,

51 .
	gdma_mask
 = &
x86_dma_ÁŒback_dev
.
cohîít_dma_mask
,

53 
EXPORT_SYMBOL
(
x86_dma_ÁŒback_dev
);

56 
	#PREALLOC_DMA_DEBUG_ENTRIES
 32768

	)

58 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

60 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

61  -
EIO
;

63 *
dev
->
dma_mask
 = 
mask
;

66 
	}
}

67 
EXPORT_SYMBOL
(
dma_£t_mask
);

69 #i‡
deföed
(
CONFIG_X86_64
Ë&& !deföed(
CONFIG_NUMA
)

70 
__öôd©a
 *
	gdma32_boŸmem_±r
;

71 
dma32_boŸmem_size
 
	g__öôd©a
 = (128ULL<<20);

73 
__öô
 
	$∑r£_dma32_size_›t
(*
p
)

75 i‡(!
p
)

76  -
EINVAL
;

77 
dma32_boŸmem_size
 = 
	`mem∑r£
(
p
, &p);

79 
	}
}

80 
óæy_∑øm
("dma32_size", 
∑r£_dma32_size_›t
);

82 
__öô
 
	$dma32_ª£rve_boŸmem
()

84 
size
, 
Æign
;

85 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

92 
Æign
 = 64ULL<<20;

93 
size
 = 
	`roundup
(
dma32_boŸmem_size
, 
Æign
);

94 
dma32_boŸmem_±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
,

100 
	`kmemÀak_ign‹e
(
dma32_boŸmem_±r
);

101 i‡(
dma32_boŸmem_±r
)

102 
dma32_boŸmem_size
 = 
size
;

104 
dma32_boŸmem_size
 = 0;

105 
	}
}

106 
__öô
 
	$dma32_‰ì_boŸmem
()

109 i‡(
max_p‚
 <
MAX_DMA32_PFN
)

112 i‡(!
dma32_boŸmem_±r
)

115 
	`‰ì_boŸmem
(
	`__∑
(
dma32_boŸmem_±r
), 
dma32_boŸmem_size
);

117 
dma32_boŸmem_±r
 = 
NULL
;

118 
dma32_boŸmem_size
 = 0;

119 
	}
}

121 
__öô
 
	$dma32_ª£rve_boŸmem
()

123 
	}
}

124 
__öô
 
	$dma32_‰ì_boŸmem
()

126 
	}
}

130 
__öô
 
	$pci_iommu_Æloc
()

133 
	`dma32_‰ì_boŸmem
();

135 i‡(
	`pci_swiŸlb_dëe˘
())

136 
out
;

138 
	`g¨t_iommu_hﬁe_öô
();

140 
	`dëe˘_ˇlg¨y
();

142 
	`dëe˘_öãl_iommu
();

145 
	`amd_iommu_dëe˘
();

146 
out
:

147 
	`pci_swiŸlb_öô
();

148 
	}
}

150 *
	$dma_gíîic_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

151 
dma_addr_t
 *
dma_addr
, 
gÂ_t
 
Êag
)

153 
dma_mask
;

154 
∑ge
 *page;

155 
dma_addr_t
 
addr
;

157 
dma_mask
 = 
	`dma_Æloc_cohîít_mask
(
dev
, 
Êag
);

159 
Êag
 |
__GFP_ZERO
;

160 
agaö
:

161 
∑ge
 = 
	`Æloc_∑ges_node
(
	`dev_to_node
(
dev
), 
Êag
, 
	`gë_‹dî
(
size
));

162 i‡(!
∑ge
)

163  
NULL
;

165 
addr
 = 
	`∑ge_to_phys
(
∑ge
);

166 i‡(
addr
 + 
size
 > 
dma_mask
) {

167 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

169 i‡(
dma_mask
 < 
	`DMA_BIT_MASK
(32Ë&& !(
Êag
 & 
GFP_DMA
)) {

170 
Êag
 = (Êag & ~
GFP_DMA32
Ë| 
GFP_DMA
;

171 
agaö
;

174  
NULL
;

177 *
dma_addr
 = 
addr
;

178  
	`∑ge_addªss
(
∑ge
);

179 
	}
}

185 
__öô
 
	$iommu_£tup
(*
p
)

187 
iommu_mîge
 = 1;

189 i‡(!
p
)

190  -
EINVAL
;

192 *
p
) {

193 i‡(!
	`°∫cmp
(
p
, "off", 3))

194 
no_iommu
 = 1;

196 i‡(!
	`°∫cmp
(
p
, "force", 5))

197 
f‹˚_iommu
 = 1;

198 i‡(!
	`°∫cmp
(
p
, "noforce", 7)) {

199 
iommu_mîge
 = 0;

200 
f‹˚_iommu
 = 0;

203 i‡(!
	`°∫cmp
(
p
, "biomerge", 8)) {

204 
iommu_mîge
 = 1;

205 
f‹˚_iommu
 = 1;

207 i‡(!
	`°∫cmp
(
p
, "panic", 5))

208 
∑nic_⁄_ovîÊow
 = 1;

209 i‡(!
	`°∫cmp
(
p
, "nopanic", 7))

210 
∑nic_⁄_ovîÊow
 = 0;

211 i‡(!
	`°∫cmp
(
p
, "merge", 5)) {

212 
iommu_mîge
 = 1;

213 
f‹˚_iommu
 = 1;

215 i‡(!
	`°∫cmp
(
p
, "nomerge", 7))

216 
iommu_mîge
 = 0;

217 i‡(!
	`°∫cmp
(
p
, "forcesac", 8))

218 
iommu_ßc_f‹˚
 = 1;

219 i‡(!
	`°∫cmp
(
p
, "allowdac", 8))

220 
f‹bid_dac
 = 0;

221 i‡(!
	`°∫cmp
(
p
, "nodac", 5))

222 
f‹bid_dac
 = 1;

223 i‡(!
	`°∫cmp
(
p
, "usedac", 6)) {

224 
f‹bid_dac
 = -1;

227 #ifde‡
CONFIG_SWIOTLB


228 i‡(!
	`°∫cmp
(
p
, "soft", 4))

229 
swiŸlb
 = 1;

231 i‡(!
	`°∫cmp
(
p
, "pt", 2))

232 
iommu_∑ss_through
 = 1;

234 
	`g¨t_∑r£_›ti⁄s
(
p
);

236 #ifde‡
CONFIG_CALGARY_IOMMU


237 i‡(!
	`°∫cmp
(
p
, "calgary", 7))

238 
u£_ˇlg¨y
 = 1;

241 
p
 +
	`°rc•n
(p, ",");

242 i‡(*
p
 == ',')

243 ++
p
;

246 
	}
}

247 
óæy_∑øm
("iommu", 
iommu_£tup
);

249 
	$dma_suµ‹ãd
(
devi˚
 *
dev
, 
u64
 
mask
)

251 
dma_m≠_›s
 *
›s
 = 
	`gë_dma_›s
(
dev
);

253 #ifde‡
CONFIG_PCI


254 i‡(
mask
 > 0xfffffff‡&& 
f‹bid_dac
 > 0) {

255 
	`dev_öfo
(
dev
, "PCI: Disallowing DAC for device\n");

260 i‡(
›s
->
dma_suµ‹ãd
)

261  
›s
->
	`dma_suµ‹ãd
(
dev
, 
mask
);

266 i‡(
mask
 < 
	`DMA_BIT_MASK
(24))

281 i‡(
iommu_ßc_f‹˚
 && (
mask
 >
	`DMA_BIT_MASK
(40))) {

282 
	`dev_öfo
(
dev
, "F‹˚ SAC wôh mask %Lx\n", 
mask
);

287 
	}
}

288 
EXPORT_SYMBOL
(
dma_suµ‹ãd
);

290 
__öô
 
	$pci_iommu_öô
()

292 
	`dma_debug_öô
(
PREALLOC_DMA_DEBUG_ENTRIES
);

294 #ifde‡
CONFIG_PCI


295 
	`dma_debug_add_bus
(&
pci_bus_ty≥
);

297 
x86_öô
.
iommu
.
	`iommu_öô
();

299 i‡(
swiŸlb
) {

300 
	`¥ötk
(
KERN_INFO
 "PCI-DMA: "

302 
	`swiŸlb_¥öt_öfo
();

304 
	`swiŸlb_‰ì
();

307 
	}
}

309 
roŸfs_öôˇŒ
(
pci_iommu_öô
);

311 #ifde‡
CONFIG_PCI


314 
__devöô
 
	$vü_no_dac
(
pci_dev
 *
dev
)

316 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
 && 
f‹bid_dac
 == 0) {

317 
	`dev_öfo
(&
dev
->dev, "disabling DAC on VIA PCI bridge\n");

318 
f‹bid_dac
 = 1;

320 
	}
}

321 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_VIA
, 
PCI_ANY_ID
, 
vü_no_dac
);

	@/cmpt816/linux/arch/x86/kernel/pci-gart_64.c

14 
	~<löux/ty≥s.h
>

15 
	~<löux/˘y≥.h
>

16 
	~<löux/agp_backíd.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/•ölock.h
>

22 
	~<löux/pci.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/t›ﬁogy.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bôm≠.h
>

27 
	~<löux/kdebug.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<löux/iommu-hñ≥r.h
>

30 
	~<löux/sysdev.h
>

31 
	~<löux/io.h
>

32 
	~<löux/gÂ.h
>

33 
	~<asm/©omic.h
>

34 
	~<asm/mår.h
>

35 
	~<asm/pgèbÀ.h
>

36 
	~<asm/¥Ÿo.h
>

37 
	~<asm/iommu.h
>

38 
	~<asm/g¨t.h
>

39 
	~<asm/ˇcheÊush.h
>

40 
	~<asm/swiŸlb.h
>

41 
	~<asm/dma.h
>

42 
	~<asm/k8.h
>

43 
	~<asm/x86_öô.h
>

45 
	giommu_bus_ba£
;

46 
	giommu_size
;

47 
	giommu_∑ges
;

49 
u32
 *
	giommu_g©t_ba£
;

51 
dma_addr_t
 
	gbad_dma_addr
;

60 
	giommu_fuŒÊush
 = 1;

63 
DEFINE_SPINLOCK
(
iommu_bôm≠_lock
);

65 *
	giommu_g¨t_bôm≠
;

67 
u32
 
	gg¨t_unm≠≥d_íåy
;

69 
	#GPTE_VALID
 1

	)

70 
	#GPTE_COHERENT
 2

	)

71 
	#GPTE_ENCODE
(
x
) \

72 (((
x
Ë& 0xfffff000Ë| (((xË>> 32Ë<< 4Ë| 
GPTE_VALID
 | 
GPTE_COHERENT
)

	)

73 
	#GPTE_DECODE
(
x
Ë(((xË& 0xfffff000Ë| (((
u64
)(xË& 0xff0Ë<< 28))

	)

75 
	#EMERGENCY_PAGES
 32

	)

77 #ifde‡
CONFIG_AGP


78 
	#AGPEXTERN
 

	)

80 
	#AGPEXTERN


	)

84 
AGPEXTERN
 
agp_mem‹y_ª£rved
;

85 
AGPEXTERN
 
__u32
 *
	gagp_g©t_èbÀ
;

87 
	g√xt_bô
;

88 
boﬁ
 
	g√ed_Êush
;

90 
	$Æloc_iommu
(
devi˚
 *
dev
, 
size
,

91 
Æign_mask
)

93 
off£t
, 
Êags
;

94 
bound¨y_size
;

95 
ba£_ödex
;

97 
ba£_ödex
 = 
	`ALIGN
(
iommu_bus_ba£
 & 
	`dma_gë_£g_bound¨y
(
dev
),

98 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

99 
bound¨y_size
 = 
	`ALIGN
((
u64
)
	`dma_gë_£g_bound¨y
(
dev
) + 1,

100 
PAGE_SIZE
Ë>> 
PAGE_SHIFT
;

102 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

103 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 
√xt_bô
,

104 
size
, 
ba£_ödex
, 
bound¨y_size
, 
Æign_mask
);

105 i‡(
off£t
 == -1) {

106 
√ed_Êush
 = 
åue
;

107 
off£t
 = 
	`iommu_¨ó_Æloc
(
iommu_g¨t_bôm≠
, 
iommu_∑ges
, 0,

108 
size
, 
ba£_ödex
, 
bound¨y_size
,

109 
Æign_mask
);

111 i‡(
off£t
 != -1) {

112 
√xt_bô
 = 
off£t
+
size
;

113 i‡(
√xt_bô
 >
iommu_∑ges
) {

114 
√xt_bô
 = 0;

115 
√ed_Êush
 = 
åue
;

118 i‡(
iommu_fuŒÊush
)

119 
√ed_Êush
 = 
åue
;

120 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

122  
off£t
;

123 
	}
}

125 
	$‰ì_iommu
(
off£t
, 
size
)

127 
Êags
;

129 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

130 
	`bôm≠_˛ór
(
iommu_g¨t_bôm≠
, 
off£t
, 
size
);

131 i‡(
off£t
 >
√xt_bô
)

132 
√xt_bô
 = 
off£t
 + 
size
;

133 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

134 
	}
}

139 
	$Êush_g¨t
()

141 
Êags
;

143 
	`•ö_lock_úqßve
(&
iommu_bôm≠_lock
, 
Êags
);

144 i‡(
√ed_Êush
) {

145 
	`k8_Êush_g¨ts
();

146 
√ed_Êush
 = 
Ál£
;

148 
	`•ö_u∆ock_úqª°‹e
(&
iommu_bôm≠_lock
, 
Êags
);

149 
	}
}

151 #ifde‡
CONFIG_IOMMU_LEAK


153 
	gÀak_åa˚
;

154 
	giommu_Àak_∑ges
 = 20;

156 
	$dump_Àak
()

158 
dump
;

160 i‡(
dump
)

162 
dump
 = 1;

164 
	`show_°ack
(
NULL
, NULL);

165 
	`debug_dma_dump_m≠pögs
(
NULL
);

166 
	}
}

169 
	$iommu_fuŒ
(
devi˚
 *
dev
, 
size_t
 
size
, 
dú
)

181 
	`dev_îr
(
dev
, "PCI-DMA: Ouào‡IOMMU s∑˚ f‹ %lu byãs\n", 
size
);

183 i‡(
size
 > 
PAGE_SIZE
*
EMERGENCY_PAGES
) {

184 i‡(
dú
 =
PCI_DMA_FROMDEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

185 
	`∑nic
("PCI-DMA: Memory would be corrupted\n");

186 i‡(
dú
 =
PCI_DMA_TODEVICE
 || dú =
PCI_DMA_BIDIRECTIONAL
)

187 
	`∑nic
(
KERN_ERR


190 #ifde‡
CONFIG_IOMMU_LEAK


191 
	`dump_Àak
();

193 
	}
}

195 
ölöe
 

196 
	$√ed_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

198  
f‹˚_iommu
 || !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

199 
	}
}

201 
ölöe
 

202 
	$n⁄f‹˚d_iommu
(
devi˚
 *
dev
, 
addr
, 
size_t
 
size
)

204  !
	`dma_ˇ∑bÀ
(
dev
, 
addr
, 
size
);

205 
	}
}

210 
dma_addr_t
 
	$dma_m≠_¨ó
(
devi˚
 *
dev
, 
dma_addr_t
 
phys_mem
,

211 
size_t
 
size
, 
dú
, 
Æign_mask
)

213 
≈ages
 = 
	`iommu_num_∑ges
(
phys_mem
, 
size
, 
PAGE_SIZE
);

214 
iommu_∑ge
 = 
	`Æloc_iommu
(
dev
, 
≈ages
, 
Æign_mask
);

215 
i
;

217 i‡(
iommu_∑ge
 == -1) {

218 i‡(!
	`n⁄f‹˚d_iommu
(
dev
, 
phys_mem
, 
size
))

219  
phys_mem
;

220 i‡(
∑nic_⁄_ovîÊow
)

221 
	`∑nic
("dma_m≠_¨ó ovîÊow %lu byãs\n", 
size
);

222 
	`iommu_fuŒ
(
dev
, 
size
, 
dú
);

223  
bad_dma_addr
;

226 
i
 = 0; i < 
≈ages
; i++) {

227 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
	`GPTE_ENCODE
(
phys_mem
);

228 
phys_mem
 +
PAGE_SIZE
;

230  
iommu_bus_ba£
 + 
iommu_∑ge
*
PAGE_SIZE
 + (
phys_mem
 & ~
PAGE_MASK
);

231 
	}
}

234 
dma_addr_t
 
	$g¨t_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

235 
off£t
, 
size_t
 
size
,

236 
dma_d©a_dúe˘i⁄
 
dú
,

237 
dma_©ås
 *
©ås
)

239 
bus
;

240 
phys_addr_t
 
∑ddr
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

242 i‡(!
dev
)

243 
dev
 = &
x86_dma_ÁŒback_dev
;

245 i‡(!
	`√ed_iommu
(
dev
, 
∑ddr
, 
size
))

246  
∑ddr
;

248 
bus
 = 
	`dma_m≠_¨ó
(
dev
, 
∑ddr
, 
size
, 
dú
, 0);

249 
	`Êush_g¨t
();

251  
bus
;

252 
	}
}

257 
	$g¨t_unm≠_∑ge
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
,

258 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
,

259 
dma_©ås
 *
©ås
)

261 
iommu_∑ge
;

262 
≈ages
;

263 
i
;

265 i‡(
dma_addr
 < 
iommu_bus_ba£
 + 
EMERGENCY_PAGES
*
PAGE_SIZE
 ||

266 
dma_addr
 >
iommu_bus_ba£
 + 
iommu_size
)

269 
iommu_∑ge
 = (
dma_addr
 - 
iommu_bus_ba£
)>>
PAGE_SHIFT
;

270 
≈ages
 = 
	`iommu_num_∑ges
(
dma_addr
, 
size
, 
PAGE_SIZE
);

271 
i
 = 0; i < 
≈ages
; i++) {

272 
iommu_g©t_ba£
[
iommu_∑ge
 + 
i
] = 
g¨t_unm≠≥d_íåy
;

274 
	`‰ì_iommu
(
iommu_∑ge
, 
≈ages
);

275 
	}
}

280 
	$g¨t_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

281 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

283 
sˇâîli°
 *
s
;

284 
i
;

286 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

287 i‡(!
s
->
dma_Àngth
 || !s->
Àngth
)

289 
	`g¨t_unm≠_∑ge
(
dev
, 
s
->
dma_addªss
, s->
dma_Àngth
, 
dú
, 
NULL
);

291 
	}
}

294 
	$dma_m≠_sg_n⁄f‹˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
,

295 
√¡s
, 
dú
)

297 
sˇâîli°
 *
s
;

298 
i
;

300 #ifde‡
CONFIG_IOMMU_DEBUG


301 
	`¥_debug
("dma_map_sg overflow\n");

304 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

305 
addr
 = 
	`sg_phys
(
s
);

307 i‡(
	`n⁄f‹˚d_iommu
(
dev
, 
addr
, 
s
->
Àngth
)) {

308 
addr
 = 
	`dma_m≠_¨ó
(
dev
,áddr, 
s
->
Àngth
, 
dú
, 0);

309 i‡(
addr
 =
bad_dma_addr
) {

310 i‡(
i
 > 0)

311 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
i
, 
dú
, 
NULL
);

312 
√¡s
 = 0;

313 
sg
[0].
dma_Àngth
 = 0;

317 
s
->
dma_addªss
 = 
addr
;

318 
s
->
dma_Àngth
 = s->
Àngth
;

320 
	`Êush_g¨t
();

322  
√¡s
;

323 
	}
}

326 
	$__dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
,

327 
√Àms
, 
sˇâîli°
 *
sout
,

328 
∑ges
)

330 
iommu_°¨t
 = 
	`Æloc_iommu
(
dev
, 
∑ges
, 0);

331 
iommu_∑ge
 = 
iommu_°¨t
;

332 
sˇâîli°
 *
s
;

333 
i
;

335 i‡(
iommu_°¨t
 == -1)

338 
	`f‹_óch_sg
(
°¨t
, 
s
, 
√Àms
, 
i
) {

339 
∑ges
, 
addr
;

340 
phys_addr
 = 
s
->
dma_addªss
;

342 
	`BUG_ON
(
s
 !
°¨t
 && s->
off£t
);

343 i‡(
s
 =
°¨t
) {

344 
sout
->
dma_addªss
 = 
iommu_bus_ba£
;

345 
sout
->
dma_addªss
 +
iommu_∑ge
*
PAGE_SIZE
 + 
s
->
off£t
;

346 
sout
->
dma_Àngth
 = 
s
->
Àngth
;

348 
sout
->
dma_Àngth
 +
s
->
Àngth
;

351 
addr
 = 
phys_addr
;

352 
∑ges
 = 
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

353 
∑ges
--) {

354 
iommu_g©t_ba£
[
iommu_∑ge
] = 
	`GPTE_ENCODE
(
addr
);

355 
addr
 +
PAGE_SIZE
;

356 
iommu_∑ge
++;

359 
	`BUG_ON
(
iommu_∑ge
 - 
iommu_°¨t
 !
∑ges
);

362 
	}
}

364 
ölöe
 

365 
	$dma_m≠_c⁄t
(
devi˚
 *
dev
, 
sˇâîli°
 *
°¨t
, 
√Àms
,

366 
sˇâîli°
 *
sout
, 
∑ges
, 
√ed
)

368 i‡(!
√ed
) {

369 
	`BUG_ON
(
√Àms
 != 1);

370 
sout
->
dma_addªss
 = 
°¨t
->dma_address;

371 
sout
->
dma_Àngth
 = 
°¨t
->
Àngth
;

374  
	`__dma_m≠_c⁄t
(
dev
, 
°¨t
, 
√Àms
, 
sout
, 
∑ges
);

375 
	}
}

381 
	$g¨t_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

382 
dma_d©a_dúe˘i⁄
 
dú
, 
dma_©ås
 *
©ås
)

384 
sˇâîli°
 *
s
, *
ps
, *
°¨t_sg
, *
sgm≠
;

385 
√ed
 = 0, 
√xäìd
, 
i
, 
out
, 
°¨t
;

386 
∑ges
 = 0;

387 
£g_size
;

388 
max_£g_size
;

390 i‡(
√¡s
 == 0)

393 i‡(!
dev
)

394 
dev
 = &
x86_dma_ÁŒback_dev
;

396 
out
 = 0;

397 
°¨t
 = 0;

398 
°¨t_sg
 = 
sg
;

399 
sgm≠
 = 
sg
;

400 
£g_size
 = 0;

401 
max_£g_size
 = 
	`dma_gë_max_£g_size
(
dev
);

402 
ps
 = 
NULL
;

404 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

405 
dma_addr_t
 
addr
 = 
	`sg_phys
(
s
);

407 
s
->
dma_addªss
 = 
addr
;

408 
	`BUG_ON
(
s
->
Àngth
 == 0);

410 
√xäìd
 = 
	`√ed_iommu
(
dev
, 
addr
, 
s
->
Àngth
);

413 i‡(
i
 > 
°¨t
) {

419 i‡(!
iommu_mîge
 || !
√xäìd
 || !
√ed
 || 
s
->
off£t
 ||

420 (
s
->
Àngth
 + 
£g_size
 > 
max_£g_size
) ||

421 (
ps
->
off£t
 +Ös->
Àngth
Ë% 
PAGE_SIZE
) {

422 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
,

423 
sgm≠
, 
∑ges
, 
√ed
) < 0)

424 
îr‹
;

425 
out
++;

427 
£g_size
 = 0;

428 
sgm≠
 = 
	`sg_√xt
(sgmap);

429 
∑ges
 = 0;

430 
°¨t
 = 
i
;

431 
°¨t_sg
 = 
s
;

435 
£g_size
 +
s
->
Àngth
;

436 
√ed
 = 
√xäìd
;

437 
∑ges
 +
	`iommu_num_∑ges
(
s
->
off£t
, s->
Àngth
, 
PAGE_SIZE
);

438 
ps
 = 
s
;

440 i‡(
	`dma_m≠_c⁄t
(
dev
, 
°¨t_sg
, 
i
 - 
°¨t
, 
sgm≠
, 
∑ges
, 
√ed
) < 0)

441 
îr‹
;

442 
out
++;

443 
	`Êush_g¨t
();

444 i‡(
out
 < 
√¡s
) {

445 
sgm≠
 = 
	`sg_√xt
(sgmap);

446 
sgm≠
->
dma_Àngth
 = 0;

448  
out
;

450 
îr‹
:

451 
	`Êush_g¨t
();

452 
	`g¨t_unm≠_sg
(
dev
, 
sg
, 
out
, 
dú
, 
NULL
);

455 i‡(
f‹˚_iommu
 || 
iommu_mîge
) {

456 
out
 = 
	`dma_m≠_sg_n⁄f‹˚
(
dev
, 
sg
, 
√¡s
, 
dú
);

457 i‡(
out
 > 0)

458  
out
;

460 i‡(
∑nic_⁄_ovîÊow
)

461 
	`∑nic
("dma_m≠_sg: ovîÊow o¿%luÖages\n", 
∑ges
);

463 
	`iommu_fuŒ
(
dev
, 
∑ges
 << 
PAGE_SHIFT
, 
dú
);

464 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
)

465 
s
->
dma_addªss
 = 
bad_dma_addr
;

467 
	}
}

471 
	$g¨t_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addr
,

472 
gÂ_t
 
Êag
)

474 
dma_addr_t
 
∑ddr
;

475 
Æign_mask
;

476 
∑ge
 *page;

478 i‡(
f‹˚_iommu
 && !(
Êag
 & 
GFP_DMA
)) {

479 
Êag
 &~(
__GFP_DMA
 | 
__GFP_HIGHMEM
 | 
__GFP_DMA32
);

480 
∑ge
 = 
	`Æloc_∑ges
(
Êag
 | 
__GFP_ZERO
, 
	`gë_‹dî
(
size
));

481 i‡(!
∑ge
)

482  
NULL
;

484 
Æign_mask
 = (1UL << 
	`gë_‹dî
(
size
)) - 1;

485 
∑ddr
 = 
	`dma_m≠_¨ó
(
dev
, 
	`∑ge_to_phys
(
∑ge
), 
size
,

486 
DMA_BIDIRECTIONAL
, 
Æign_mask
);

488 
	`Êush_g¨t
();

489 i‡(
∑ddr
 !
bad_dma_addr
) {

490 *
dma_addr
 = 
∑ddr
;

491  
	`∑ge_addªss
(
∑ge
);

493 
	`__‰ì_∑ges
(
∑ge
, 
	`gë_‹dî
(
size
));

495  
	`dma_gíîic_Æloc_cohîít
(
dev
, 
size
, 
dma_addr
, 
Êag
);

497  
NULL
;

498 
	}
}

502 
	$g¨t_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

503 
dma_addr_t
 
dma_addr
)

505 
	`g¨t_unm≠_∑ge
(
dev
, 
dma_addr
, 
size
, 
DMA_BIDIRECTIONAL
, 
NULL
);

506 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

507 
	}
}

509 
	$g¨t_m≠pög_îr‹
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
)

511  (
dma_addr
 =
bad_dma_addr
);

512 
	}
}

514 
	gno_agp
;

516 
__öô
 
	$check_iommu_size
(
≠î
, 
u64
 
≠î_size
)

518 
a
;

520 i‡(!
iommu_size
) {

521 
iommu_size
 = 
≠î_size
;

522 i‡(!
no_agp
)

523 
iommu_size
 /= 2;

526 
a
 = 
≠î
 + 
iommu_size
;

527 
iommu_size
 -
	`round_up
(
a
, 
PMD_PAGE_SIZE
) -á;

529 i‡(
iommu_size
 < 64*1024*1024) {

530 
	`¥_w¨nög
(

533 
iommu_size
 >> 20);

536  
iommu_size
;

537 
	}
}

539 
__öô
 
	$ªad_≠îtuª
(
pci_dev
 *
dev
, 
u32
 *
size
)

541 
≠î_size
 = 0, 
≠î_ba£_32
, 
≠î_‹dî
;

542 
u64
 
≠î_ba£
;

544 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, &
≠î_ba£_32
);

545 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
≠î_‹dî
);

546 
≠î_‹dî
 = (aper_order >> 1) & 7;

548 
≠î_ba£
 = 
≠î_ba£_32
 & 0x7fff;

549 
≠î_ba£
 <<= 25;

551 
≠î_size
 = (32 * 1024 * 1024Ë<< 
≠î_‹dî
;

552 i‡(
≠î_ba£
 + 
≠î_size
 > 0x100000000UL || !aper_size)

553 
≠î_ba£
 = 0;

555 *
size
 = 
≠î_size
;

556  
≠î_ba£
;

557 
	}
}

559 
	$íabÀ_g¨t_å™¶©i⁄s
()

561 
i
;

563 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

564 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

566 
	`íabÀ_g¨t_å™¶©i⁄
(
dev
, 
	`__∑
(
agp_g©t_èbÀ
));

570 
	`k8_Êush_g¨ts
();

571 
	}
}

577 
boﬁ
 
	gfix_up_n‹th_bridges
;

578 
u32
 
	g≠îtuª_‹dî
;

579 
u32
 
	g≠îtuª_Æloc
;

581 
	$£t_up_g¨t_ªsume
(
u32
 
≠î_‹dî
, u32 
≠î_Æloc
)

583 
fix_up_n‹th_bridges
 = 
åue
;

584 
≠îtuª_‹dî
 = 
≠î_‹dî
;

585 
≠îtuª_Æloc
 = 
≠î_Æloc
;

586 
	}
}

588 
	$g¨t_fixup_n‹thbridges
(
sys_devi˚
 *
dev
)

590 
i
;

592 i‡(!
fix_up_n‹th_bridges
)

595 
	`¥_öfo
("PCI-DMA: Restoring GARTáperture settings\n");

597 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

598 
pci_dev
 *
dev
 = 
k8_n‹thbridges
[
i
];

604 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
≠îtuª_‹dî
 << 1);

605 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTUREBASE
, 
≠îtuª_Æloc
 >> 25);

607 
	}
}

609 
	$g¨t_ªsume
(
sys_devi˚
 *
dev
)

611 
	`¥_öfo
("PCI-DMA: Resuming GART IOMMU\n");

613 
	`g¨t_fixup_n‹thbridges
(
dev
);

615 
	`íabÀ_g¨t_å™¶©i⁄s
();

618 
	}
}

620 
	$g¨t_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

623 
	}
}

625 
sysdev_˛ass
 
	gg¨t_sysdev_˛ass
 = {

626 .
«me
 = "gart",

627 .
	gsu•íd
 = 
g¨t_su•íd
,

628 .
	gªsume
 = 
g¨t_ªsume
,

632 
sys_devi˚
 
	gdevi˚_g¨t
 = {

633 .
˛s
 = &
g¨t_sysdev_˛ass
,

640 
__öô
 
	$öô_k8_g©t
(
agp_kîn_öfo
 *
öfo
)

642 
≠î_size
, 
g©t_size
, 
√w_≠î_size
;

643 
≠î_ba£
, 
√w_≠î_ba£
;

644 
pci_dev
 *
dev
;

645 *
g©t
;

646 
i
, 
îr‹
;

648 
	`¥_öfo
("PCI-DMA: Disabling AGP.\n");

650 
≠î_size
 = 
≠î_ba£
 = 
öfo
->aper_size = 0;

651 
dev
 = 
NULL
;

652 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

653 
dev
 = 
k8_n‹thbridges
[
i
];

654 
√w_≠î_ba£
 = 
	`ªad_≠îtuª
(
dev
, &
√w_≠î_size
);

655 i‡(!
√w_≠î_ba£
)

656 
nommu
;

658 i‡(!
≠î_ba£
) {

659 
≠î_size
 = 
√w_≠î_size
;

660 
≠î_ba£
 = 
√w_≠î_ba£
;

662 i‡(
≠î_size
 !
√w_≠î_size
 || 
≠î_ba£
 !
√w_≠î_ba£
)

663 
nommu
;

665 i‡(!
≠î_ba£
)

666 
nommu
;

668 
öfo
->
≠î_ba£
 =áper_base;

669 
öfo
->
≠î_size
 =áper_size >> 20;

671 
g©t_size
 = (
≠î_size
 >> 
PAGE_SHIFT
Ë* (
u32
);

672 
g©t
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

673 
	`gë_‹dî
(
g©t_size
));

674 i‡(!
g©t
)

675 
	`∑nic
("Cannotállocate GATTÅable");

676 i‡(
	`£t_mem‹y_uc
(()
g©t
, 
g©t_size
 >> 
PAGE_SHIFT
))

677 
	`∑nic
("CouldÇot set GART PTEsÅo uncacheableÖages");

679 
agp_g©t_èbÀ
 = 
g©t
;

681 
îr‹
 = 
	`sysdev_˛ass_ªgi°î
(&
g¨t_sysdev_˛ass
);

682 i‡(!
îr‹
)

683 
îr‹
 = 
	`sysdev_ªgi°î
(&
devi˚_g¨t
);

684 i‡(
îr‹
)

685 
	`∑nic
("CouldÇotÑegister gart_sysdev -- "

688 
	`Êush_g¨t
();

690 
	`¥_öfo
("PCI-DMA:áperture base @ %x size %u KB\n",

691 
≠î_ba£
, 
≠î_size
>>10);

695 
nommu
:

697 
	`¥_w¨nög
("PCI-DMA: MoreÅhan 4GB of RAMándÇo IOMMU\n"

700 
	}
}

702 
dma_m≠_›s
 
	gg¨t_dma_›s
 = {

703 .
m≠_sg
 = 
g¨t_m≠_sg
,

704 .
	gunm≠_sg
 = 
g¨t_unm≠_sg
,

705 .
	gm≠_∑ge
 = 
g¨t_m≠_∑ge
,

706 .
	gunm≠_∑ge
 = 
g¨t_unm≠_∑ge
,

707 .
	gÆloc_cohîít
 = 
g¨t_Æloc_cohîít
,

708 .
	g‰ì_cohîít
 = 
g¨t_‰ì_cohîít
,

709 .
	gm≠pög_îr‹
 = 
g¨t_m≠pög_îr‹
,

712 
	$g¨t_iommu_shutdown
()

714 
pci_dev
 *
dev
;

715 
i
;

718 i‡(!
no_agp
)

721 
i
 = 0; i < 
num_k8_n‹thbridges
; i++) {

722 
u32
 
˘l
;

724 
dev
 = 
k8_n‹thbridges
[
i
];

725 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, &
˘l
);

727 
˘l
 &~
GARTEN
;

729 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
AMD64_GARTAPERTURECTL
, 
˘l
);

731 
	}
}

733 
__öô
 
	$g¨t_iommu_öô
()

735 
agp_kîn_öfo
 
öfo
;

736 
iommu_°¨t
;

737 
≠î_ba£
, 
≠î_size
;

738 
°¨t_p‚
, 
íd_p‚
;

739 
s¸©ch
;

740 
i
;

742 i‡(
num_k8_n‹thbridges
 == 0)

745 #i‚de‡
CONFIG_AGP_AMD64


746 
no_agp
 = 1;

750 
no_agp
 =Ço_agp ||

751 (
	`agp_amd64_öô
() < 0) ||

752 (
	`agp_c›y_öfo
(
agp_bridge
, &
öfo
) < 0);

755 i‡(
no_iommu
 ||

756 (!
f‹˚_iommu
 && 
max_p‚
 <
MAX_DMA32_PFN
) ||

757 !
g¨t_iommu_≠îtuª
 ||

758 (
no_agp
 && 
	`öô_k8_g©t
(&
öfo
) < 0)) {

759 i‡(
max_p‚
 > 
MAX_DMA32_PFN
) {

760 
	`¥_w¨nög
("MoreÅhan 4GB of memory but GART IOMMUÇotávailable.\n");

761 
	`¥_w¨nög
("falling backÅo iommu=soft.\n");

767 
≠î_size
 = 
öfo
.aper_size << 20;

768 
≠î_ba£
 = 
öfo
.aper_base;

769 
íd_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
Ë+ (
≠î_size
>>PAGE_SHIFT);

771 i‡(
íd_p‚
 > 
max_low_p‚_m≠≥d
) {

772 
°¨t_p‚
 = (
≠î_ba£
>>
PAGE_SHIFT
);

773 
	`öô_mem‹y_m≠pög
(
°¨t_p‚
<<
PAGE_SHIFT
, 
íd_p‚
<<PAGE_SHIFT);

776 
	`¥_öfo
("PCI-DMA: using GART IOMMU.\n");

777 
iommu_size
 = 
	`check_iommu_size
(
öfo
.
≠î_ba£
, 
≠î_size
);

778 
iommu_∑ges
 = 
iommu_size
 >> 
PAGE_SHIFT
;

780 
iommu_g¨t_bôm≠
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
 | 
__GFP_ZERO
,

781 
	`gë_‹dî
(
iommu_∑ges
/8));

782 i‡(!
iommu_g¨t_bôm≠
)

783 
	`∑nic
("Cannotállocate iommu bitmap\n");

785 #ifde‡
CONFIG_IOMMU_LEAK


786 i‡(
Àak_åa˚
) {

787 
ªt
;

789 
ªt
 = 
	`dma_debug_ªsize_íåõs
(
iommu_∑ges
);

790 i‡(
ªt
)

791 
	`¥_debug
("PCI-DMA: CannotÅraceállÅheÉntries\n");

799 
	`bôm≠_£t
(
iommu_g¨t_bôm≠
, 0, 
EMERGENCY_PAGES
);

801 
	`¥_öfo
("PCI-DMA: Reserving %luMB of IOMMUárea inÅhe AGPáperture\n",

802 
iommu_size
 >> 20);

804 
agp_mem‹y_ª£rved
 = 
iommu_size
;

805 
iommu_°¨t
 = 
≠î_size
 - 
iommu_size
;

806 
iommu_bus_ba£
 = 
öfo
.
≠î_ba£
 + 
iommu_°¨t
;

807 
bad_dma_addr
 = 
iommu_bus_ba£
;

808 
iommu_g©t_ba£
 = 
agp_g©t_èbÀ
 + (
iommu_°¨t
>>
PAGE_SHIFT
);

819 
	`£t_mem‹y_≈
(()
	`__va
(
iommu_bus_ba£
),

820 
iommu_size
 >> 
PAGE_SHIFT
);

829 
	`wbövd
();

837 
	`íabÀ_g¨t_å™¶©i⁄s
();

845 
s¸©ch
 = 
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

846 i‡(!
s¸©ch
)

847 
	`∑nic
("Cannotállocate iommu scratchÖage");

848 
g¨t_unm≠≥d_íåy
 = 
	`GPTE_ENCODE
(
	`__∑
(
s¸©ch
));

849 
i
 = 
EMERGENCY_PAGES
; i < 
iommu_∑ges
; i++)

850 
iommu_g©t_ba£
[
i
] = 
g¨t_unm≠≥d_íåy
;

852 
	`Êush_g¨t
();

853 
dma_›s
 = &
g¨t_dma_›s
;

854 
x86_∂©f‹m
.
iommu_shutdown
 = 
g¨t_iommu_shutdown
;

855 
swiŸlb
 = 0;

858 
	}
}

860 
__öô
 
	$g¨t_∑r£_›ti⁄s
(*
p
)

862 
¨g
;

864 #ifde‡
CONFIG_IOMMU_LEAK


865 i‡(!
	`°∫cmp
(
p
, "leak", 4)) {

866 
Àak_åa˚
 = 1;

867 
p
 += 4;

868 i‡(*
p
 == '=')

869 ++
p
;

870 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

871 
iommu_Àak_∑ges
 = 
¨g
;

874 i‡(
	`isdigô
(*
p
Ë&& 
	`gë_›ti⁄
(&p, &
¨g
))

875 
iommu_size
 = 
¨g
;

876 i‡(!
	`°∫cmp
(
p
, "fullflush", 9))

877 
iommu_fuŒÊush
 = 1;

878 i‡(!
	`°∫cmp
(
p
, "nofullflush", 11))

879 
iommu_fuŒÊush
 = 0;

880 i‡(!
	`°∫cmp
(
p
, "noagp", 5))

881 
no_agp
 = 1;

882 i‡(!
	`°∫cmp
(
p
, "noaperture", 10))

883 
fix_≠îtuª
 = 0;

885 i‡(!
	`°∫cmp
(
p
, "force", 5))

886 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

887 i‡(!
	`°∫cmp
(
p
, "allowed", 7))

888 
g¨t_iommu_≠îtuª_Ælowed
 = 1;

889 i‡(!
	`°∫cmp
(
p
, "memaper", 7)) {

890 
ÁŒback_≠î_f‹˚
 = 1;

891 
p
 += 7;

892 i‡(*
p
 == '=') {

893 ++
p
;

894 i‡(
	`gë_›ti⁄
(&
p
, &
¨g
))

895 
ÁŒback_≠î_‹dî
 = 
¨g
;

898 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pci-nommu.c

3 
	~<löux/dma-m≠pög.h
>

4 
	~<löux/sˇâîli°.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/öô.h
>

7 
	~<löux/gÂ.h
>

8 
	~<löux/pci.h
>

9 
	~<löux/mm.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/iommu.h
>

13 
	~<asm/dma.h
>

16 
	$check_addr
(*
«me
, 
devi˚
 *
hwdev
, 
dma_addr_t
 
bus
, 
size_t
 
size
)

18 i‡(
hwdev
 && !
	`dma_ˇ∑bÀ
(hwdev, 
bus
, 
size
)) {

19 i‡(*
hwdev
->
dma_mask
 >
	`DMA_BIT_MASK
(32))

20 
	`¥ötk
(
KERN_ERR


22 
«me
, ()
bus
, 
size
,

23 ()*
hwdev
->
dma_mask
);

27 
	}
}

29 
dma_addr_t
 
	$nommu_m≠_∑ge
(
devi˚
 *
dev
, 
∑ge
 *page,

30 
off£t
, 
size_t
 
size
,

31 
dma_d©a_dúe˘i⁄
 
dú
,

32 
dma_©ås
 *
©ås
)

34 
dma_addr_t
 
bus
 = 
	`∑ge_to_phys
(
∑ge
Ë+ 
off£t
;

35 
	`WARN_ON
(
size
 == 0);

36 i‡(!
	`check_addr
("m≠_sögÀ", 
dev
, 
bus
, 
size
))

37  
DMA_ERROR_CODE
;

38 
	`Êush_wrôe_buf„rs
();

39  
bus
;

40 
	}
}

57 
	$nommu_m≠_sg
(
devi˚
 *
hwdev
, 
sˇâîli°
 *
sg
,

58 
√¡s
, 
dma_d©a_dúe˘i⁄
 
dú
,

59 
dma_©ås
 *
©ås
)

61 
sˇâîli°
 *
s
;

62 
i
;

64 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

66 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

67 
	`BUG_ON
(!
	`sg_∑ge
(
s
));

68 
s
->
dma_addªss
 = 
	`sg_phys
(s);

69 i‡(!
	`check_addr
("m≠_sg", 
hwdev
, 
s
->
dma_addªss
, s->
Àngth
))

71 
s
->
dma_Àngth
 = s->
Àngth
;

73 
	`Êush_wrôe_buf„rs
();

74  
√¡s
;

75 
	}
}

77 
	$nommu_‰ì_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
, *
vaddr
,

78 
dma_addr_t
 
dma_addr
)

80 
	`‰ì_∑ges
(()
vaddr
, 
	`gë_‹dî
(
size
));

81 
	}
}

83 
	$nommu_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
,

84 
dma_addr_t
 
addr
, 
size_t
 
size
,

85 
dma_d©a_dúe˘i⁄
 
dú
)

87 
	`Êush_wrôe_buf„rs
();

88 
	}
}

91 
	$nommu_sync_sg_f‹_devi˚
(
devi˚
 *
dev
,

92 
sˇâîli°
 *
sg
, 
√Àms
,

93 
dma_d©a_dúe˘i⁄
 
dú
)

95 
	`Êush_wrôe_buf„rs
();

96 
	}
}

98 
dma_m≠_›s
 
	gnommu_dma_›s
 = {

99 .
Æloc_cohîít
 = 
dma_gíîic_Æloc_cohîít
,

100 .
	g‰ì_cohîít
 = 
nommu_‰ì_cohîít
,

101 .
	gm≠_sg
 = 
nommu_m≠_sg
,

102 .
	gm≠_∑ge
 = 
nommu_m≠_∑ge
,

103 .
	gsync_sögÀ_f‹_devi˚
 = 
nommu_sync_sögÀ_f‹_devi˚
,

104 .
	gsync_sg_f‹_devi˚
 = 
nommu_sync_sg_f‹_devi˚
,

105 .
	gis_phys
 = 1,

	@/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c

3 
	~<löux/pci.h
>

4 
	~<löux/ˇche.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/swiŸlb.h
>

7 
	~<löux/boŸmem.h
>

8 
	~<löux/dma-m≠pög.h
>

10 
	~<asm/iommu.h
>

11 
	~<asm/swiŸlb.h
>

12 
	~<asm/dma.h
>

14 
swiŸlb
 
	g__ªad_mo°ly
;

16 *
	$x86_swiŸlb_Æloc_cohîít
(
devi˚
 *
hwdev
, 
size_t
 
size
,

17 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
Êags
)

19 *
vaddr
;

21 
vaddr
 = 
	`dma_gíîic_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

22 i‡(
vaddr
)

23  
vaddr
;

25  
	`swiŸlb_Æloc_cohîít
(
hwdev
, 
size
, 
dma_h™dÀ
, 
Êags
);

26 
	}
}

28 
dma_m≠_›s
 
	gswiŸlb_dma_›s
 = {

29 .
m≠pög_îr‹
 = 
swiŸlb_dma_m≠pög_îr‹
,

30 .
	gÆloc_cohîít
 = 
x86_swiŸlb_Æloc_cohîít
,

31 .
	g‰ì_cohîít
 = 
swiŸlb_‰ì_cohîít
,

32 .
	gsync_sögÀ_f‹_˝u
 = 
swiŸlb_sync_sögÀ_f‹_˝u
,

33 .
	gsync_sögÀ_f‹_devi˚
 = 
swiŸlb_sync_sögÀ_f‹_devi˚
,

34 .
	gsync_sg_f‹_˝u
 = 
swiŸlb_sync_sg_f‹_˝u
,

35 .
	gsync_sg_f‹_devi˚
 = 
swiŸlb_sync_sg_f‹_devi˚
,

36 .
	gm≠_sg
 = 
swiŸlb_m≠_sg_©ås
,

37 .
	gunm≠_sg
 = 
swiŸlb_unm≠_sg_©ås
,

38 .
	gm≠_∑ge
 = 
swiŸlb_m≠_∑ge
,

39 .
	gunm≠_∑ge
 = 
swiŸlb_unm≠_∑ge
,

40 .
	gdma_suµ‹ãd
 = 
NULL
,

49 
__öô
 
	$pci_swiŸlb_dëe˘
()

51 
u£_swiŸlb
 = 
swiŸlb
 | 
swiŸlb_f‹˚
;

54 #ifde‡
CONFIG_X86_64


55 i‡(!
no_iommu
 && 
max_p‚
 > 
MAX_DMA32_PFN
)

56 
swiŸlb
 = 1;

58 i‡(
swiŸlb_f‹˚
)

59 
swiŸlb
 = 1;

61  
u£_swiŸlb
;

62 
	}
}

64 
__öô
 
	$pci_swiŸlb_öô
()

66 i‡(
swiŸlb
) {

67 
	`swiŸlb_öô
(0);

68 
dma_›s
 = &
swiŸlb_dma_›s
;

70 
	}
}

	@/cmpt816/linux/arch/x86/kernel/pcspeaker.c

1 
	~<löux/∂©f‹m_devi˚.h
>

2 
	~<löux/îr.h
>

3 
	~<löux/öô.h
>

5 
__öô
 
	$add_pc•kr
()

7 
∂©f‹m_devi˚
 *
pd
;

9 
pd
 = 
	`∂©f‹m_devi˚_ªgi°î_sim∂e
("pc•kr", -1, 
NULL
, 0);

11  
	`IS_ERR
(
pd
Ë? 
	`PTR_ERR
(pd) : 0;

12 
	}
}

13 
devi˚_öôˇŒ
(
add_pc•kr
);

	@/cmpt816/linux/arch/x86/kernel/pmtimer_64.c

17 
	~<löux/jiffõs.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/time.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/˝umask.h
>

22 
	~<löux/a˝i_pmtmr.h
>

24 
	~<asm/io.h
>

25 
	~<asm/¥Ÿo.h
>

26 
	~<asm/m§.h
>

27 
	~<asm/vsysˇŒ.h
>

29 
ölöe
 
u32
 
	$cyc2us
(
u32
 
cy˛es
)

38 
cy˛es
 *= 286;

39  (
cy˛es
 >> 10);

40 
	}
}

42 
	$pmtimî_waô_tick
()

44 
u32
 
a
, 
b
;

45 
a
 = 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
;

46 
a
 =
b
;

47 
b
 = 
	`öl
(
pmtmr_i›‹t
Ë& 
ACPI_PM_MASK
)

48 
	`˝u_ªœx
();

49  
b
;

50 
	}
}

53 
	$pmtimî_waô
(
us
)

55 
u32
 
a
, 
b
;

56 
a
 = 
	`pmtimî_waô_tick
();

58 
b
 = 
	`öl
(
pmtmr_i›‹t
);

59 
	`˝u_ªœx
();

60 } 
	`cyc2us
(
b
 - 
a
Ë< 
us
);

61 
	}
}

63 
__öô
 
	$n›mtimî_£tup
(*
s
)

65 
pmtmr_i›‹t
 = 0;

67 
	}
}

69 
__£tup
("n›mtimî", 
n›mtimî_£tup
);

	@/cmpt816/linux/arch/x86/kernel/process.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/smp.h
>

5 
	~<löux/¥˘l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/pm.h
>

10 
	~<löux/˛ockchùs.h
>

11 
	~<löux/øndom.h
>

12 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

13 
	~<löux/dmi.h
>

14 
	~<löux/ut¢ame.h
>

15 
	~<åa˚/evíts/powî.h
>

16 
	~<löux/hw_bªakpoöt.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/≠ic.h
>

19 
	~<asm/sysˇŒs.h
>

20 
	~<asm/idÀ.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/i387.h
>

23 
	~<asm/debugªg.h
>

25 
	gidÀ_hÆt
;

26 
EXPORT_SYMBOL
(
idÀ_hÆt
);

27 
	gidÀ_nomwaô
;

28 
EXPORT_SYMBOL
(
idÀ_nomwaô
);

30 
kmem_ˇche
 *
	gèsk_x°©e_ˇchï
;

32 
	$¨ch_dup_èsk_°ru˘
(
èsk_°ru˘
 *
d°
, èsk_°ru˘ *
§c
)

34 
ªt
;

36 *
d°
 = *
§c
;

37 i‡(
	`Âu_Æloˇãd
(&
§c
->
thªad
.
Âu
)) {

38 
	`mem£t
(&
d°
->
thªad
.
Âu
, 0, (dst->thread.fpu));

39 
ªt
 = 
	`Âu_Æloc
(&
d°
->
thªad
.
Âu
);

40 i‡(
ªt
)

41  
ªt
;

42 
	`Âu_c›y
(&
d°
->
thªad
.
Âu
, &
§c
->thread.fpu);

45 
	}
}

47 
	$‰ì_thªad_x°©e
(
èsk_°ru˘
 *
tsk
)

49 
	`Âu_‰ì
(&
tsk
->
thªad
.
Âu
);

50 
	}
}

52 
	$‰ì_thªad_öfo
(
thªad_öfo
 *
ti
)

54 
	`‰ì_thªad_x°©e
(
ti
->
èsk
);

55 
	`‰ì_∑ges
(()
ti
, 
	`gë_‹dî
(
THREAD_SIZE
));

56 
	}
}

58 
	$¨ch_èsk_ˇche_öô
()

60 
èsk_x°©e_ˇchï
 =

61 
	`kmem_ˇche_¸óã
("èsk_x°©e", 
x°©e_size
,

62 
	`__Æignof__
(
thªad_x°©e
),

63 
SLAB_PANIC
 | 
SLAB_NOTRACK
, 
NULL
);

64 
	}
}

69 
	$exô_thªad
()

71 
èsk_°ru˘
 *
me
 = 
cuºít
;

72 
thªad_°ru˘
 *
t
 = &
me
->
thªad
;

73 *
bp
 = 
t
->
io_bôm≠_±r
;

75 i‡(
bp
) {

76 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
	`gë_˝u
());

78 
t
->
io_bôm≠_±r
 = 
NULL
;

79 
	`˛ór_thªad_Êag
(
TIF_IO_BITMAP
);

83 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
t
->
io_bôm≠_max
);

84 
t
->
io_bôm≠_max
 = 0;

85 
	`put_˝u
();

86 
	`k‰ì
(
bp
);

88 
	}
}

90 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

92 
	`show_ªgi°îs
(
ªgs
);

93 
	`show_åa˚
(
NULL
, 
ªgs
, (*)
	`kî√l_°ack_poöãr
(regs),

94 
ªgs
->
bp
);

95 
	}
}

97 
	$show_ªgs_comm⁄
()

99 c⁄° *
bﬂrd
, *
¥odu˘
;

101 
bﬂrd
 = 
	`dmi_gë_sy°em_öfo
(
DMI_BOARD_NAME
);

102 i‡(!
bﬂrd
)

103 
bﬂrd
 = "";

104 
¥odu˘
 = 
	`dmi_gë_sy°em_öfo
(
DMI_PRODUCT_NAME
);

105 i‡(!
¥odu˘
)

106 
¥odu˘
 = "";

108 
	`¥ötk
(
KERN_CONT
 "\n");

109 
	`¥ötk
(
KERN_DEFAULT
 "Pid: %d, comm: %.20s %s %s %.*s %s/%s\n",

110 
cuºít
->
pid
, cuºít->
comm
, 
	`¥öt_èöãd
(),

111 
	`öô_ut¢ame
()->
ªÀa£
,

112 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

113 
	`öô_ut¢ame
()->
vîsi⁄
, 
bﬂrd
, 
¥odu˘
);

114 
	}
}

116 
	$Êush_thªad
()

118 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

120 
	`Êush_±ø˚_hw_bªakpoöt
(
tsk
);

121 
	`mem£t
(
tsk
->
thªad
.
és_¨øy
, 0, (tsk->thread.tls_array));

125 
tsk
->
Âu_cou¡î
 = 0;

126 
	`˛ór_Âu
(
tsk
);

127 
	`˛ór_u£d_m©h
();

128 
	}
}

130 
	$h¨d_dißbÀ_TSC
()

132 
	`wrôe_¸4
(
	`ªad_¸4
(Ë| 
X86_CR4_TSD
);

133 
	}
}

135 
	$dißbÀ_TSC
()

137 
	`¥ìm±_dißbÀ
();

138 i‡(!
	`ã°_™d_£t_thªad_Êag
(
TIF_NOTSC
))

143 
	`h¨d_dißbÀ_TSC
();

144 
	`¥ìm±_íabÀ
();

145 
	}
}

147 
	$h¨d_íabÀ_TSC
()

149 
	`wrôe_¸4
(
	`ªad_¸4
(Ë& ~
X86_CR4_TSD
);

150 
	}
}

152 
	$íabÀ_TSC
()

154 
	`¥ìm±_dißbÀ
();

155 i‡(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_NOTSC
))

160 
	`h¨d_íabÀ_TSC
();

161 
	`¥ìm±_íabÀ
();

162 
	}
}

164 
	$gë_tsc_mode
(
adr
)

166 
vÆ
;

168 i‡(
	`ã°_thªad_Êag
(
TIF_NOTSC
))

169 
vÆ
 = 
PR_TSC_SIGSEGV
;

171 
vÆ
 = 
PR_TSC_ENABLE
;

173  
	`put_u£r
(
vÆ
, (
__u£r
 *)
adr
);

174 
	}
}

176 
	$£t_tsc_mode
(
vÆ
)

178 i‡(
vÆ
 =
PR_TSC_SIGSEGV
)

179 
	`dißbÀ_TSC
();

180 i‡(
vÆ
 =
PR_TSC_ENABLE
)

181 
	`íabÀ_TSC
();

183  -
EINVAL
;

186 
	}
}

188 
	$__swôch_to_xåa
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
,

189 
tss_°ru˘
 *
tss
)

191 
thªad_°ru˘
 *
¥ev
, *
√xt
;

193 
¥ev
 = &
¥ev_p
->
thªad
;

194 
√xt
 = &
√xt_p
->
thªad
;

196 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_BLOCKSTEP
) ^

197 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_BLOCKSTEP
)) {

198 
debug˘l
 = 
	`gë_debug˘lm§
();

200 
debug˘l
 &~
DEBUGCTLMSR_BTF
;

201 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_BLOCKSTEP
))

202 
debug˘l
 |
DEBUGCTLMSR_BTF
;

204 
	`upd©e_debug˘lm§
(
debug˘l
);

207 i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_NOTSC
) ^

208 
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
)) {

210 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_NOTSC
))

211 
	`h¨d_dißbÀ_TSC
();

213 
	`h¨d_íabÀ_TSC
();

216 i‡(
	`ã°_tsk_thªad_Êag
(
√xt_p
, 
TIF_IO_BITMAP
)) {

221 
	`mem˝y
(
tss
->
io_bôm≠
, 
√xt
->
io_bôm≠_±r
,

222 
	`max
(
¥ev
->
io_bôm≠_max
, 
√xt
->io_bitmap_max));

223 } i‡(
	`ã°_tsk_thªad_Êag
(
¥ev_p
, 
TIF_IO_BITMAP
)) {

227 
	`mem£t
(
tss
->
io_bôm≠
, 0xff, 
¥ev
->
io_bôm≠_max
);

229 
	`¥›ag©e_u£r_ªtu∫_nŸify
(
¥ev_p
, 
√xt_p
);

230 
	}
}

232 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

234  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0, 
NULL
, NULL);

235 
	}
}

247 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

249  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
•
,Ñegs, 0,

250 
NULL
, NULL);

251 
	}
}

254 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

255 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
, 
±_ªgs
 *
ªgs
)

257 i‡(!
√w•
)

258 
√w•
 = 
ªgs
->
•
;

259  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

260 
	}
}

267 
kî√l_thªad_hñ≥r
();

272 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
Êags
)

274 
±_ªgs
 
ªgs
;

276 
	`mem£t
(&
ªgs
, 0, (regs));

278 
ªgs
.
si
 = (Ë
‚
;

279 
ªgs
.
di
 = (Ë
¨g
;

281 #ifde‡
CONFIG_X86_32


282 
ªgs
.
ds
 = 
__USER_DS
;

283 
ªgs
.
es
 = 
__USER_DS
;

284 
ªgs
.
fs
 = 
__KERNEL_PERCPU
;

285 
ªgs
.
gs
 = 
__KERNEL_STACK_CANARY
;

287 
ªgs
.
ss
 = 
__KERNEL_DS
;

290 
ªgs
.
‹ig_ax
 = -1;

291 
ªgs
.
ù
 = (Ë
kî√l_thªad_hñ≥r
;

292 
ªgs
.
cs
 = 
__KERNEL_CS
 | 
	`gë_kî√l_Ωl
();

293 
ªgs
.
Êags
 = 
X86_EFLAGS_IF
 | 0x2;

296  
	`do_f‹k
(
Êags
 | 
CLONE_VM
 | 
CLONE_UNTRACED
, 0, &
ªgs
, 0, 
NULL
, NULL);

297 
	}
}

298 
EXPORT_SYMBOL
(
kî√l_thªad
);

303 
	$sys_execve
(
__u£r
 *
«me
, __u£∏* __u£∏*
¨gv
,

304 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

306 
îr‹
;

307 *
fûíame
;

309 
fûíame
 = 
	`gë«me
(
«me
);

310 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

311 i‡(
	`IS_ERR
(
fûíame
))

312  
îr‹
;

313 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

315 #ifde‡
CONFIG_X86_32


316 i‡(
îr‹
 == 0) {

318 
	`£t_thªad_Êag
(
TIF_IRET
);

322 
	`puäame
(
fûíame
);

323  
îr‹
;

324 
	}
}

329 
	gboŸ_›ti⁄_idÀ_ovîride
 = 0;

330 
EXPORT_SYMBOL
(
boŸ_›ti⁄_idÀ_ovîride
);

335 (*
pm_idÀ
)();

336 
	`EXPORT_SYMBOL
(
pm_idÀ
);

338 #ifde‡
CONFIG_X86_32


343 
h…_cou¡î
;

344 
	$dißbÀ_h…
()

346 
h…_cou¡î
++;

347 
	}
}

348 
EXPORT_SYMBOL
(
dißbÀ_h…
);

350 
	$íabÀ_h…
()

352 
h…_cou¡î
--;

353 
	}
}

354 
EXPORT_SYMBOL
(
íabÀ_h…
);

356 
ölöe
 
	$h…_u£_hÆt
()

358  (!
h…_cou¡î
 && 
boŸ_˝u_d©a
.
h…_w‹ks_ok
);

359 
	}
}

361 
ölöe
 
	$h…_u£_hÆt
()

364 
	}
}

371 
	$deÁu…_idÀ
()

373 i‡(
	`h…_u£_hÆt
()) {

374 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

375 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_POLLING
;

380 
	`smp_mb
();

382 i‡(!
	`√ed_ªsched
())

383 
	`ß„_hÆt
();

385 
	`loˇl_úq_íabÀ
();

386 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

388 
	`loˇl_úq_íabÀ
();

390 
	`˝u_ªœx
();

392 
	}
}

393 #ifde‡
CONFIG_APM_MODULE


394 
EXPORT_SYMBOL
(
deÁu…_idÀ
);

397 
	$°›_this_˝u
(*
dummy
)

399 
	`loˇl_úq_dißbÀ
();

403 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
Ál£
);

404 
	`dißbÀ_loˇl_APIC
();

407 i‡(
	`h…_w‹ks
(
	`smp_¥o˚ss‹_id
()))

408 
	`hÆt
();

410 
	}
}

412 
	$do_nŸhög
(*
unu£d
)

414 
	}
}

424 
	$˝u_idÀ_waô
()

426 
	`smp_mb
();

428 
	`smp_ˇŒ_fun˘i⁄
(
do_nŸhög
, 
NULL
, 1);

429 
	}
}

430 
EXPORT_SYMBOL_GPL
(
˝u_idÀ_waô
);

442 
	$mwaô_idÀ_wôh_höts
(
ax
, 
cx
)

444 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, (
ax
>>4)+1);

445 i‡(!
	`√ed_ªsched
()) {

446 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

447 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

449 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

450 
	`smp_mb
();

451 i‡(!
	`√ed_ªsched
())

452 
	`__mwaô
(
ax
, 
cx
);

454 
	}
}

457 
	$mwaô_idÀ
()

459 i‡(!
	`√ed_ªsched
()) {

460 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 1);

461 i‡(
	`˝u_has
(&
cuºít_˝u_d©a
, 
X86_FEATURE_CLFLUSH_MONITOR
))

462 
	`˛Êush
((*)&
	`cuºít_thªad_öfo
()->
Êags
);

464 
	`__m⁄ô‹
((*)&
	`cuºít_thªad_öfo
()->
Êags
, 0, 0);

465 
	`smp_mb
();

466 i‡(!
	`√ed_ªsched
())

467 
	`__°i_mwaô
(0, 0);

469 
	`loˇl_úq_íabÀ
();

471 
	`loˇl_úq_íabÀ
();

472 
	}
}

479 
	$pﬁl_idÀ
()

481 
	`åa˚_powî_°¨t
(
POWER_CSTATE
, 0);

482 
	`loˇl_úq_íabÀ
();

483 !
	`√ed_ªsched
())

484 
	`˝u_ªœx
();

485 
	`åa˚_powî_íd
(0);

486 
	}
}

500 
__˝uöôd©a
 
	gf‹˚_mwaô
;

502 
	#MWAIT_INFO
 0x05

	)

503 
	#MWAIT_ECX_EXTENDED_INFO
 0x01

	)

504 
	#MWAIT_EDX_C1
 0xf0

	)

506 
__˝uöô
 
	$mwaô_ußbÀ
(c⁄° 
˝uöfo_x86
 *
c
)

508 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

510 i‡(
f‹˚_mwaô
)

513 i‡(
c
->
˝uid_Àvñ
 < 
MWAIT_INFO
)

516 
	`˝uid
(
MWAIT_INFO
, &
óx
, &
ebx
, &
ecx
, &
edx
);

518 i‡(!(
ecx
 & 
MWAIT_ECX_EXTENDED_INFO
))

525  (
edx
 & 
MWAIT_EDX_C1
);

526 
	}
}

534 
__˝uöô
 
	$check_c1e_idÀ
(c⁄° 
˝uöfo_x86
 *
c
)

536 
u64
 
vÆ
;

537 i‡(
c
->
x86_víd‹
 !
X86_VENDOR_AMD
)

538 
no_c1e_idÀ
;

541 i‡(
c
->
x86
 =0x0F && c->
x86_modñ
 >= 0x40)

544 i‡(
c
->
x86
 == 0x10) {

549 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_OSVW
)) {

550 
	`rdm§l
(
MSR_AMD64_OSVW_ID_LENGTH
, 
vÆ
);

551 i‡(
vÆ
 >= 2) {

552 
	`rdm§l
(
MSR_AMD64_OSVW_STATUS
, 
vÆ
);

553 i‡(!(
vÆ
 & 
	`BIT
(1)))

554 
no_c1e_idÀ
;

560 
no_c1e_idÀ
:

562 
	}
}

564 
˝umask_v¨_t
 
	gc1e_mask
;

565 
	gc1e_dëe˘ed
;

567 
	$c1e_ªmove_˝u
(
˝u
)

569 i‡(
c1e_mask
 !
NULL
)

570 
	`˝umask_˛ór_˝u
(
˝u
, 
c1e_mask
);

571 
	}
}

578 
	$c1e_idÀ
()

580 i‡(
	`√ed_ªsched
())

583 i‡(!
c1e_dëe˘ed
) {

584 
u32
 
lo
, 
hi
;

586 
	`rdm§
(
MSR_K8_INT_PENDING_MSG
, 
lo
, 
hi
);

587 i‡(
lo
 & 
K8_INTP_C1E_ACTIVE_MASK
) {

588 
c1e_dëe˘ed
 = 1;

589 i‡(!
	`boŸ_˝u_has
(
X86_FEATURE_NONSTOP_TSC
))

590 
	`m¨k_tsc_un°abÀ
("TSC halt in AMD C1E");

591 
	`¥ötk
(
KERN_INFO
 "System has AMD C1EÉnabled\n");

592 
	`£t_˝u_ˇp
(&
boŸ_˝u_d©a
, 
X86_FEATURE_AMDC1E
);

596 i‡(
c1e_dëe˘ed
) {

597 
˝u
 = 
	`smp_¥o˚ss‹_id
();

599 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
c1e_mask
)) {

600 
	`˝umask_£t_˝u
(
˝u
, 
c1e_mask
);

604 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_FORCE
,

605 &
˝u
);

606 
	`¥ötk
(
KERN_INFO
 "SwitchÅo broadcast mode on CPU%d\n",

607 
˝u
);

609 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_ENTER
, &
˝u
);

611 
	`deÁu…_idÀ
();

617 
	`loˇl_úq_dißbÀ
();

618 
	`˛ockevíts_nŸify
(
CLOCK_EVT_NOTIFY_BROADCAST_EXIT
, &
˝u
);

619 
	`loˇl_úq_íabÀ
();

621 
	`deÁu…_idÀ
();

622 
	}
}

624 
__˝uöô
 
	$£À˘_idÀ_routöe
(c⁄° 
˝uöfo_x86
 *
c
)

626 #ifde‡
CONFIG_SMP


627 i‡(
pm_idÀ
 =
pﬁl_idÀ
 && 
smp_num_siblögs
 > 1) {

628 
	`¥ötk_⁄˚
(
KERN_WARNING
 "WARNING:Öolling idleánd HTÉnabled,"

632 i‡(
pm_idÀ
)

635 i‡(
	`˝u_has
(
c
, 
X86_FEATURE_MWAIT
Ë&& 
	`mwaô_ußbÀ
(c)) {

639 
	`¥ötk
(
KERN_INFO
 "using mwait in idleÅhreads.\n");

640 
pm_idÀ
 = 
mwaô_idÀ
;

641 } i‡(
	`check_c1e_idÀ
(
c
)) {

642 
	`¥ötk
(
KERN_INFO
 "using C1Eáware idleÑoutine\n");

643 
pm_idÀ
 = 
c1e_idÀ
;

645 
pm_idÀ
 = 
deÁu…_idÀ
;

646 
	}
}

648 
__öô
 
	$öô_c1e_mask
()

651 i‡(
pm_idÀ
 =
c1e_idÀ
)

652 
	`zÆloc_˝umask_v¨
(&
c1e_mask
, 
GFP_KERNEL
);

653 
	}
}

655 
__öô
 
	$idÀ_£tup
(*
°r
)

657 i‡(!
°r
)

658  -
EINVAL
;

660 i‡(!
	`°rcmp
(
°r
, "poll")) {

661 
	`¥ötk
("usingÖolling idleÅhreads.\n");

662 
pm_idÀ
 = 
pﬁl_idÀ
;

663 } i‡(!
	`°rcmp
(
°r
, "mwait"))

664 
f‹˚_mwaô
 = 1;

665 i‡(!
	`°rcmp
(
°r
, "halt")) {

673 
pm_idÀ
 = 
deÁu…_idÀ
;

674 
idÀ_hÆt
 = 1;

676 } i‡(!
	`°rcmp
(
°r
, "nomwait")) {

683 
idÀ_nomwaô
 = 1;

688 
boŸ_›ti⁄_idÀ_ovîride
 = 1;

690 
	}
}

691 
óæy_∑øm
("idÀ", 
idÀ_£tup
);

693 
	$¨ch_Æign_°ack
(
•
)

695 i‡(!(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
Ë&& 
øndomize_va_•a˚
)

696 
•
 -
	`gë_øndom_öt
() % 8192;

697  
•
 & ~0xf;

698 
	}
}

700 
	$¨ch_øndomize_brk
(
mm_°ru˘
 *
mm
)

702 
ønge_íd
 = 
mm
->
brk
 + 0x02000000;

703  
	`øndomize_ønge
(
mm
->
brk
, 
ønge_íd
, 0) ? : mm->brk;

704 
	}
}

	@/cmpt816/linux/arch/x86/kernel/process_64.c

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/˝u.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/ñfc‹e.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/u£r.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/dñay.h
>

30 
	~<löux/moduÀ.h
>

31 
	~<löux/±ø˚.h
>

32 
	~<löux/nŸifõr.h
>

33 
	~<löux/k¥obes.h
>

34 
	~<löux/kdebug.h
>

35 
	~<löux/tick.h
>

36 
	~<löux/¥˘l.h
>

37 
	~<löux/uac˚ss.h
>

38 
	~<löux/io.h
>

39 
	~<löux/·ø˚.h
>

41 
	~<asm/pgèbÀ.h
>

42 
	~<asm/sy°em.h
>

43 
	~<asm/¥o˚ss‹.h
>

44 
	~<asm/i387.h
>

45 
	~<asm/mmu_c⁄ãxt.h
>

46 
	~<asm/¥˘l.h
>

47 
	~<asm/desc.h
>

48 
	~<asm/¥Ÿo.h
>

49 
	~<asm/ü32.h
>

50 
	~<asm/idÀ.h
>

51 
	~<asm/sysˇŒs.h
>

52 
	~<asm/debugªg.h
>

54 
asmlökage
 
ªt_‰om_f‹k
();

56 
DEFINE_PER_CPU
(, 
ﬁd_r•
);

57 
DEFINE_PER_CPU
(, 
is_idÀ
);

59 
ATOMIC_NOTIFIER_HEAD
(
idÀ_nŸifõr
);

61 
	$idÀ_nŸifõr_ªgi°î
(
nŸifõr_block
 *
n
)

63 
	`©omic_nŸifõr_chaö_ªgi°î
(&
idÀ_nŸifõr
, 
n
);

64 
	}
}

65 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_ªgi°î
);

67 
	$idÀ_nŸifõr_uƒegi°î
(
nŸifõr_block
 *
n
)

69 
	`©omic_nŸifõr_chaö_uƒegi°î
(&
idÀ_nŸifõr
, 
n
);

70 
	}
}

71 
EXPORT_SYMBOL_GPL
(
idÀ_nŸifõr_uƒegi°î
);

73 
	$íãr_idÀ
()

75 
	`≥r˝u_wrôe
(
is_idÀ
, 1);

76 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_START
, 
NULL
);

77 
	}
}

79 
	$__exô_idÀ
()

81 i‡(
	`x86_ã°_™d_˛ór_bô_≥r˝u
(0, 
is_idÀ
) == 0)

83 
	`©omic_nŸifõr_ˇŒ_chaö
(&
idÀ_nŸifõr
, 
IDLE_END
, 
NULL
);

84 
	}
}

87 
	$exô_idÀ
()

90 i‡(
cuºít
->
pid
)

92 
	`__exô_idÀ
();

93 
	}
}

95 #i‚de‡
CONFIG_SMP


96 
ölöe
 
	$∂ay_dód
()

98 
	`BUG
();

99 
	}
}

108 
	$˝u_idÀ
()

110 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_POLLING
;

119 
	`boŸ_öô_°ack_ˇ«ry
();

123 
	`tick_nohz_°›_sched_tick
(1);

124 !
	`√ed_ªsched
()) {

126 
	`rmb
();

128 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
()))

129 
	`∂ay_dód
();

135 
	`loˇl_úq_dißbÀ
();

136 
	`íãr_idÀ
();

138 
	`°›_¸ôiˇl_timögs
();

139 
	`pm_idÀ
();

140 
	`°¨t_¸ôiˇl_timögs
();

144 
	`__exô_idÀ
();

147 
	`tick_nohz_ª°¨t_sched_tick
();

148 
	`¥ìm±_íabÀ_no_ªsched
();

149 
	`scheduÀ
();

150 
	`¥ìm±_dißbÀ
();

152 
	}
}

155 
	$__show_ªgs
(
±_ªgs
 *
ªgs
, 
Æl
)

157 
¸0
 = 0L, 
¸2
 = 0L, 
¸3
 = 0L, 
¸4
 = 0L, 
fs
, 
gs
, 
shadowgs
;

158 
d0
, 
d1
, 
d2
, 
d3
, 
d6
, 
d7
;

159 
fsödex
, 
gsödex
;

160 
ds
, 
cs
, 
es
;

162 
	`show_ªgs_comm⁄
();

163 
	`¥ötk
(
KERN_DEFAULT
 "RIP: %04lx:[<%016lx>] ", 
ªgs
->
cs
 & 0xffff,Ñegs->
ù
);

164 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

165 
	`¥ötk
(
KERN_DEFAULT
 "RSP: %04lx:%016lx EFLAGS: %08lx\n", 
ªgs
->
ss
,

166 
ªgs
->
•
,Ñegs->
Êags
);

167 
	`¥ötk
(
KERN_DEFAULT
 "RAX: %016lx RBX: %016lx RCX: %016lx\n",

168 
ªgs
->
ax
,Ñegs->
bx
,Ñegs->
cx
);

169 
	`¥ötk
(
KERN_DEFAULT
 "RDX: %016lx RSI: %016lx RDI: %016lx\n",

170 
ªgs
->
dx
,Ñegs->
si
,Ñegs->
di
);

171 
	`¥ötk
(
KERN_DEFAULT
 "RBP: %016lx R08: %016lx R09: %016lx\n",

172 
ªgs
->
bp
,Ñegs->
r8
,Ñegs->
r9
);

173 
	`¥ötk
(
KERN_DEFAULT
 "R10: %016lx R11: %016lx R12: %016lx\n",

174 
ªgs
->
r10
,Ñegs->
r11
,Ñegs->
r12
);

175 
	`¥ötk
(
KERN_DEFAULT
 "R13: %016lx R14: %016lx R15: %016lx\n",

176 
ªgs
->
r13
,Ñegs->
r14
,Ñegs->
r15
);

178 
	`asm
("mov»%%ds,%0" : "Ù" (
ds
));

179 
	`asm
("mov»%%cs,%0" : "Ù" (
cs
));

180 
	`asm
("mov»%%es,%0" : "Ù" (
es
));

181 
	`asm
("mov»%%fs,%0" : "Ù" (
fsödex
));

182 
	`asm
("mov»%%gs,%0" : "Ù" (
gsödex
));

184 
	`rdm§l
(
MSR_FS_BASE
, 
fs
);

185 
	`rdm§l
(
MSR_GS_BASE
, 
gs
);

186 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
shadowgs
);

188 i‡(!
Æl
)

191 
¸0
 = 
	`ªad_¸0
();

192 
¸2
 = 
	`ªad_¸2
();

193 
¸3
 = 
	`ªad_¸3
();

194 
¸4
 = 
	`ªad_¸4
();

196 
	`¥ötk
(
KERN_DEFAULT
 "FS: %016lx(%04x) GS:%016lx(%04x) knlGS:%016lx\n",

197 
fs
, 
fsödex
, 
gs
, 
gsödex
, 
shadowgs
);

198 
	`¥ötk
(
KERN_DEFAULT
 "CS: %04x DS: %04x ES: %04x CR0: %016lx\n", 
cs
, 
ds
,

199 
es
, 
¸0
);

200 
	`¥ötk
(
KERN_DEFAULT
 "CR2: %016lx CR3: %016lx CR4: %016lx\n", 
¸2
, 
¸3
,

201 
¸4
);

203 
	`gë_debugªg
(
d0
, 0);

204 
	`gë_debugªg
(
d1
, 1);

205 
	`gë_debugªg
(
d2
, 2);

206 
	`¥ötk
(
KERN_DEFAULT
 "DR0: %016lx DR1: %016lx DR2: %016lx\n", 
d0
, 
d1
, 
d2
);

207 
	`gë_debugªg
(
d3
, 3);

208 
	`gë_debugªg
(
d6
, 6);

209 
	`gë_debugªg
(
d7
, 7);

210 
	`¥ötk
(
KERN_DEFAULT
 "DR3: %016lx DR6: %016lx DR7: %016lx\n", 
d3
, 
d6
, 
d7
);

211 
	}
}

213 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

215 i‡(
dód_èsk
->
mm
) {

216 i‡(
dód_èsk
->
mm
->
c⁄ãxt
.
size
) {

217 
	`¥ötk
("WARNING: deadÖrocess %8s still has LDT? <%p/%d>\n",

218 
dód_èsk
->
comm
,

219 
dód_èsk
->
mm
->
c⁄ãxt
.
ldt
,

220 
dód_èsk
->
mm
->
c⁄ãxt
.
size
);

221 
	`BUG
();

224 
	}
}

226 
ölöe
 
	$£t_32bô_és
(
èsk_°ru˘
 *
t
, 
és
, 
u32
 
addr
)

228 
u£r_desc
 
ud
 = {

229 .
ba£_addr
 = 
addr
,

230 .
limô
 = 0xfffff,

231 .
£g_32bô
 = 1,

232 .
limô_ö_∑ges
 = 1,

233 .
u£abÀ
 = 1,

235 
desc_°ru˘
 *
desc
 = 
t
->
thªad
.
és_¨øy
;

236 
desc
 +
és
;

237 
	`fûl_ldt
(
desc
, &
ud
);

238 
	}
}

240 
ölöe
 
u32
 
	$ªad_32bô_és
(
èsk_°ru˘
 *
t
, 
és
)

242  
	`gë_desc_ba£
(&
t
->
thªad
.
és_¨øy
[
és
]);

243 
	}
}

249 
	$¥ï¨e_to_c›y
(
èsk_°ru˘
 *
tsk
)

251 
	`u∆azy_Âu
(
tsk
);

252 
	}
}

254 
	$c›y_thªad
(
˛⁄e_Êags
, 
•
,

255 
unu£d
,

256 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

258 
îr
;

259 
±_ªgs
 *
chûdªgs
;

260 
èsk_°ru˘
 *
me
 = 
cuºít
;

262 
chûdªgs
 = ((
±_ªgs
 *)

263 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
p
))) - 1;

264 *
chûdªgs
 = *
ªgs
;

266 
chûdªgs
->
ax
 = 0;

267 i‡(
	`u£r_mode
(
ªgs
))

268 
chûdªgs
->
•
 = sp;

270 
chûdªgs
->
•
 = ()childregs;

272 
p
->
thªad
.
•
 = (Ë
chûdªgs
;

273 
p
->
thªad
.
•0
 = (Ë(
chûdªgs
+1);

274 
p
->
thªad
.
u£r•
 = 
me
->thread.usersp;

276 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_FORK
);

278 
p
->
thªad
.
io_bôm≠_±r
 = 
NULL
;

280 
	`ßve£gmít
(
gs
, 
p
->
thªad
.
gsödex
);

281 
p
->
thªad
.
gs
 =Ö->thªad.
gsödex
 ? 0 : 
me
->thread.gs;

282 
	`ßve£gmít
(
fs
, 
p
->
thªad
.
fsödex
);

283 
p
->
thªad
.
fs
 =Ö->thªad.
fsödex
 ? 0 : 
me
->thread.fs;

284 
	`ßve£gmít
(
es
, 
p
->
thªad
.es);

285 
	`ßve£gmít
(
ds
, 
p
->
thªad
.ds);

287 
îr
 = -
ENOMEM
;

288 
	`mem£t
(
p
->
thªad
.
±ø˚_bps
, 0, (p->thread.ptrace_bps));

290 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
me
, 
TIF_IO_BITMAP
))) {

291 
p
->
thªad
.
io_bôm≠_±r
 = 
	`kmÆloc
(
IO_BITMAP_BYTES
, 
GFP_KERNEL
);

292 i‡(!
p
->
thªad
.
io_bôm≠_±r
) {

293 
p
->
thªad
.
io_bôm≠_max
 = 0;

294  -
ENOMEM
;

296 
	`mem˝y
(
p
->
thªad
.
io_bôm≠_±r
, 
me
->thread.io_bitmap_ptr,

297 
IO_BITMAP_BYTES
);

298 
	`£t_tsk_thªad_Êag
(
p
, 
TIF_IO_BITMAP
);

304 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
) {

305 #ifde‡
CONFIG_IA32_EMULATION


306 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

307 
îr
 = 
	`do_£t_thªad_¨ó
(
p
, -1,

308 (
u£r_desc
 
__u£r
 *)
chûdªgs
->
si
, 0);

311 
îr
 = 
	`do_¨ch_¥˘l
(
p
, 
ARCH_SET_FS
, 
chûdªgs
->
r8
);

312 i‡(
îr
)

313 
out
;

315 
îr
 = 0;

316 
out
:

317 i‡(
îr
 && 
p
->
thªad
.
io_bôm≠_±r
) {

318 
	`k‰ì
(
p
->
thªad
.
io_bôm≠_±r
);

319 
p
->
thªad
.
io_bôm≠_max
 = 0;

322  
îr
;

323 
	}
}

326 
	$°¨t_thªad_comm⁄
(
±_ªgs
 *
ªgs
, 
√w_ù
,

327 
√w_•
,

328 
_cs
, 
_ss
, 
_ds
)

330 
	`lﬂd£gmít
(
fs
, 0);

331 
	`lﬂd£gmít
(
es
, 
_ds
);

332 
	`lﬂd£gmít
(
ds
, 
_ds
);

333 
	`lﬂd_gs_ödex
(0);

334 
ªgs
->
ù
 = 
√w_ù
;

335 
ªgs
->
•
 = 
√w_•
;

336 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√w_•
);

337 
ªgs
->
cs
 = 
_cs
;

338 
ªgs
->
ss
 = 
_ss
;

339 
ªgs
->
Êags
 = 
X86_EFLAGS_IF
;

340 
	`£t_fs
(
USER_DS
);

344 
	`‰ì_thªad_x°©e
(
cuºít
);

345 
	}
}

348 
	$°¨t_thªad
(
±_ªgs
 *
ªgs
, 
√w_ù
, 
√w_•
)

350 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

351 
__USER_CS
, 
__USER_DS
, 0);

352 
	}
}

354 #ifde‡
CONFIG_IA32_EMULATION


355 
	$°¨t_thªad_ü32
(
±_ªgs
 *
ªgs
, 
u32
 
√w_ù
, u32 
√w_•
)

357 
	`°¨t_thªad_comm⁄
(
ªgs
, 
√w_ù
, 
√w_•
,

358 
__USER32_CS
, 
__USER32_DS
, __USER32_DS);

359 
	}
}

372 
__nŸø˚_funcgøph
 
èsk_°ru˘
 *

373 
	$__swôch_to
(
èsk_°ru˘
 *
¥ev_p
, èsk_°ru˘ *
√xt_p
)

375 
thªad_°ru˘
 *
¥ev
 = &
¥ev_p
->
thªad
;

376 
thªad_°ru˘
 *
√xt
 = &
√xt_p
->
thªad
;

377 
˝u
 = 
	`smp_¥o˚ss‹_id
();

378 
tss_°ru˘
 *
tss
 = &
	`≥r_˝u
(
öô_tss
, 
˝u
);

379 
fsödex
, 
gsödex
;

380 
boﬁ
 
¥ñﬂd_Âu
;

387 
¥ñﬂd_Âu
 = 
	`tsk_u£d_m©h
(
√xt_p
Ë&&Çext_p->
Âu_cou¡î
 > 5;

390 i‡(
¥ñﬂd_Âu
)

391 
	`¥e„tch
(
√xt
->
Âu
.
°©e
);

396 
	`lﬂd_•0
(
tss
, 
√xt
);

402 
	`ßve£gmít
(
es
, 
¥ev
->es);

403 i‡(
	`u∆ikñy
(
√xt
->
es
 | 
¥ev
->es))

404 
	`lﬂd£gmít
(
es
, 
√xt
->es);

406 
	`ßve£gmít
(
ds
, 
¥ev
->ds);

407 i‡(
	`u∆ikñy
(
√xt
->
ds
 | 
¥ev
->ds))

408 
	`lﬂd£gmít
(
ds
, 
√xt
->ds);

416 
	`ßve£gmít
(
fs
, 
fsödex
);

417 
	`ßve£gmít
(
gs
, 
gsödex
);

419 
	`lﬂd_TLS
(
√xt
, 
˝u
);

422 
	`u∆azy_Âu
(
¥ev_p
);

425 i‡(
¥ñﬂd_Âu
)

426 
	`˛ts
();

435 
	`¨ch_íd_c⁄ãxt_swôch
(
√xt_p
);

444 i‡(
	`u∆ikñy
(
fsödex
 | 
√xt
->fsödex | 
¥ev
->
fs
)) {

445 
	`lﬂd£gmít
(
fs
, 
√xt
->
fsödex
);

451 i‡(
fsödex
)

452 
¥ev
->
fs
 = 0;

455 i‡(
√xt
->
fs
)

456 
	`wrm§l
(
MSR_FS_BASE
, 
√xt
->
fs
);

457 
¥ev
->
fsödex
 = fsindex;

459 i‡(
	`u∆ikñy
(
gsödex
 | 
√xt
->gsödex | 
¥ev
->
gs
)) {

460 
	`lﬂd_gs_ödex
(
√xt
->
gsödex
);

461 i‡(
gsödex
)

462 
¥ev
->
gs
 = 0;

464 i‡(
√xt
->
gs
)

465 
	`wrm§l
(
MSR_KERNEL_GS_BASE
, 
√xt
->
gs
);

466 
¥ev
->
gsödex
 = gsindex;

471 
¥ev
->
u£r•
 = 
	`≥r˝u_ªad
(
ﬁd_r•
);

472 
	`≥r˝u_wrôe
(
ﬁd_r•
, 
√xt
->
u£r•
);

473 
	`≥r˝u_wrôe
(
cuºít_èsk
, 
√xt_p
);

475 
	`≥r˝u_wrôe
(
kî√l_°ack
,

476 ()
	`èsk_°ack_∑ge
(
√xt_p
) +

477 
THREAD_SIZE
 - 
KERNEL_STACK_OFFSET
);

482 i‡(
	`u∆ikñy
(
	`èsk_thªad_öfo
(
√xt_p
)->
Êags
 & 
_TIF_WORK_CTXSW_NEXT
 ||

483 
	`èsk_thªad_öfo
(
¥ev_p
)->
Êags
 & 
_TIF_WORK_CTXSW_PREV
))

484 
	`__swôch_to_xåa
(
¥ev_p
, 
√xt_p
, 
tss
);

490 i‡(
¥ñﬂd_Âu
)

491 
	`__m©h_°©e_ª°‹e
();

493  
¥ev_p
;

494 
	}
}

496 
	$£t_≥rs⁄Æôy_64bô
()

501 
	`˛ór_thªad_Êag
(
TIF_IA32
);

507 
cuºít
->
≥rs⁄Æôy
 &~
READ_IMPLIES_EXEC
;

508 
	}
}

510 
	$£t_≥rs⁄Æôy_ü32
()

515 
	`£t_thªad_Êag
(
TIF_IA32
);

516 
cuºít
->
≥rs⁄Æôy
 |
f‹˚_≥rs⁄Æôy32
;

519 
	`cuºít_thªad_öfo
()->
°©us
 |
TS_COMPAT
;

520 
	}
}

522 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

524 
°ack
;

525 
u64
 
Â
, 
ù
;

526 
cou¡
 = 0;

528 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

530 
°ack
 = ()
	`èsk_°ack_∑ge
(
p
);

531 i‡(
p
->
thªad
.
•
 < 
°ack
 ||Ö->thªad.• >°ack+
THREAD_SIZE
)

533 
Â
 = *(
u64
 *)(
p
->
thªad
.
•
);

535 i‡(
Â
 < ()
°ack
 ||

536 
Â
 >()
°ack
+
THREAD_SIZE
)

538 
ù
 = *(
u64
 *)(
Â
+8);

539 i‡(!
	`ö_sched_fun˘i⁄s
(
ù
))

540  
ù
;

541 
Â
 = *(
u64
 *)fp;

542 } 
cou¡
++ < 16);

544 
	}
}

546 
	$do_¨ch_¥˘l
(
èsk_°ru˘
 *
èsk
, 
code
, 
addr
)

548 
ªt
 = 0;

549 
doô
 = 
èsk
 =
cuºít
;

550 
˝u
;

552 
code
) {

553 
ARCH_SET_GS
:

554 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

555  -
EPERM
;

556 
˝u
 = 
	`gë_˝u
();

559 i‡(
addr
 <= 0xffffffff) {

560 
	`£t_32bô_és
(
èsk
, 
GS_TLS
, 
addr
);

561 i‡(
doô
) {

562 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

563 
	`lﬂd_gs_ödex
(
GS_TLS_SEL
);

565 
èsk
->
thªad
.
gsödex
 = 
GS_TLS_SEL
;

566 
èsk
->
thªad
.
gs
 = 0;

568 
èsk
->
thªad
.
gsödex
 = 0;

569 
èsk
->
thªad
.
gs
 = 
addr
;

570 i‡(
doô
) {

571 
	`lﬂd_gs_ödex
(0);

572 
ªt
 = 
	`checkög_wrm§l
(
MSR_KERNEL_GS_BASE
, 
addr
);

575 
	`put_˝u
();

577 
ARCH_SET_FS
:

580 i‡(
addr
 >
	`TASK_SIZE_OF
(
èsk
))

581  -
EPERM
;

582 
˝u
 = 
	`gë_˝u
();

585 i‡(
addr
 <= 0xffffffff) {

586 
	`£t_32bô_és
(
èsk
, 
FS_TLS
, 
addr
);

587 i‡(
doô
) {

588 
	`lﬂd_TLS
(&
èsk
->
thªad
, 
˝u
);

589 
	`lﬂd£gmít
(
fs
, 
FS_TLS_SEL
);

591 
èsk
->
thªad
.
fsödex
 = 
FS_TLS_SEL
;

592 
èsk
->
thªad
.
fs
 = 0;

594 
èsk
->
thªad
.
fsödex
 = 0;

595 
èsk
->
thªad
.
fs
 = 
addr
;

596 i‡(
doô
) {

599 
	`lﬂd£gmít
(
fs
, 0);

600 
ªt
 = 
	`checkög_wrm§l
(
MSR_FS_BASE
, 
addr
);

603 
	`put_˝u
();

605 
ARCH_GET_FS
: {

606 
ba£
;

607 i‡(
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
)

608 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
FS_TLS
);

609 i‡(
doô
)

610 
	`rdm§l
(
MSR_FS_BASE
, 
ba£
);

612 
ba£
 = 
èsk
->
thªad
.
fs
;

613 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

616 
ARCH_GET_GS
: {

617 
ba£
;

618 
gsödex
;

619 i‡(
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
)

620 
ba£
 = 
	`ªad_32bô_és
(
èsk
, 
GS_TLS
);

621 i‡(
doô
) {

622 
	`ßve£gmít
(
gs
, 
gsödex
);

623 i‡(
gsödex
)

624 
	`rdm§l
(
MSR_KERNEL_GS_BASE
, 
ba£
);

626 
ba£
 = 
èsk
->
thªad
.
gs
;

628 
ba£
 = 
èsk
->
thªad
.
gs
;

629 
ªt
 = 
	`put_u£r
(
ba£
, (
__u£r
 *)
addr
);

634 
ªt
 = -
EINVAL
;

638  
ªt
;

639 
	}
}

641 
	$sys_¨ch_¥˘l
(
code
, 
addr
)

643  
	`do_¨ch_¥˘l
(
cuºít
, 
code
, 
addr
);

644 
	}
}

646 
	$KSTK_ESP
(
èsk_°ru˘
 *
èsk
)

648  (
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
)) ?

649 (
	`èsk_±_ªgs
(
èsk
)->
•
Ë: (—ask)->
thªad
.
u£r•
);

650 
	}
}

	@/cmpt816/linux/arch/x86/kernel/ptrace.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/smp.h
>

11 
	~<löux/î∫o.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/±ø˚.h
>

14 
	~<löux/ªg£t.h
>

15 
	~<löux/åa˚hook.h
>

16 
	~<löux/u£r.h
>

17 
	~<löux/ñf.h
>

18 
	~<löux/£curôy.h
>

19 
	~<löux/audô.h
>

20 
	~<löux/£ccomp.h
>

21 
	~<löux/sig«l.h
>

22 
	~<löux/≥rf_evít.h
>

23 
	~<löux/hw_bªakpoöt.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/¥o˚ss‹.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/debugªg.h
>

31 
	~<asm/ldt.h
>

32 
	~<asm/desc.h
>

33 
	~<asm/¥˘l.h
>

34 
	~<asm/¥Ÿo.h
>

35 
	~<asm/hw_bªakpoöt.h
>

37 
	~"és.h
"

39 
	#CREATE_TRACE_POINTS


	)

40 
	~<åa˚/evíts/sysˇŒs.h
>

42 
	ex86_ªg£t
 {

43 
	mREGSET_GENERAL
,

44 
	mREGSET_FP
,

45 
	mREGSET_XFP
,

46 
	mREGSET_IOPERM64
 = 
REGSET_XFP
,

47 
	mREGSET_XSTATE
,

48 
	mREGSET_TLS
,

49 
	mREGSET_IOPERM32
,

52 
	s±_ªgs_off£t
 {

53 c⁄° *
	m«me
;

54 
	moff£t
;

57 
	#REG_OFFSET_NAME
(
r
Ë{.
«me
 = #r, .
off£t
 = 
	`off£tof
(
±_ªgs
,Ñ)}

	)

58 
	#REG_OFFSET_END
 {.
«me
 = 
NULL
, .
off£t
 = 0}

	)

60 c⁄° 
±_ªgs_off£t
 
	gªgoff£t_èbÀ
[] = {

61 #ifde‡
CONFIG_X86_64


62 
REG_OFFSET_NAME
(
r15
),

63 
REG_OFFSET_NAME
(
r14
),

64 
REG_OFFSET_NAME
(
r13
),

65 
REG_OFFSET_NAME
(
r12
),

66 
REG_OFFSET_NAME
(
r11
),

67 
REG_OFFSET_NAME
(
r10
),

68 
REG_OFFSET_NAME
(
r9
),

69 
REG_OFFSET_NAME
(
r8
),

71 
REG_OFFSET_NAME
(
bx
),

72 
REG_OFFSET_NAME
(
cx
),

73 
REG_OFFSET_NAME
(
dx
),

74 
REG_OFFSET_NAME
(
si
),

75 
REG_OFFSET_NAME
(
di
),

76 
REG_OFFSET_NAME
(
bp
),

77 
REG_OFFSET_NAME
(
ax
),

78 #ifde‡
CONFIG_X86_32


79 
REG_OFFSET_NAME
(
ds
),

80 
REG_OFFSET_NAME
(
es
),

81 
REG_OFFSET_NAME
(
fs
),

82 
REG_OFFSET_NAME
(
gs
),

84 
REG_OFFSET_NAME
(
‹ig_ax
),

85 
REG_OFFSET_NAME
(
ù
),

86 
REG_OFFSET_NAME
(
cs
),

87 
REG_OFFSET_NAME
(
Êags
),

88 
REG_OFFSET_NAME
(
•
),

89 
REG_OFFSET_NAME
(
ss
),

90 
REG_OFFSET_END
,

100 
	$ªgs_quîy_ªgi°î_off£t
(c⁄° *
«me
)

102 c⁄° 
±_ªgs_off£t
 *
roff
;

103 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

104 i‡(!
	`°rcmp
(
roff
->
«me
,Çame))

105  
roff
->
off£t
;

106  -
EINVAL
;

107 
	}
}

116 c⁄° *
	$ªgs_quîy_ªgi°î_«me
(
off£t
)

118 c⁄° 
±_ªgs_off£t
 *
roff
;

119 
roff
 = 
ªgoff£t_èbÀ
;Ñoff->
«me
 !
NULL
;Ñoff++)

120 i‡(
roff
->
off£t
 == offset)

121  
roff
->
«me
;

122  
NULL
;

123 
	}
}

125 c⁄° 
	g¨g_offs_èbÀ
[] = {

126 #ifde‡
CONFIG_X86_32


127 [0] = 
off£tof
(
±_ªgs
, 
ax
),

128 [1] = 
off£tof
(
±_ªgs
, 
dx
),

129 [2] = 
off£tof
(
±_ªgs
, 
cx
)

131 [0] = 
off£tof
(
±_ªgs
, 
di
),

132 [1] = 
off£tof
(
±_ªgs
, 
si
),

133 [2] = 
off£tof
(
±_ªgs
, 
dx
),

134 [3] = 
off£tof
(
±_ªgs
, 
cx
),

135 [4] = 
off£tof
(
±_ªgs
, 
r8
),

136 [5] = 
off£tof
(
±_ªgs
, 
r9
)

148 
	#FLAG_MASK_32
 (() \

149 (
X86_EFLAGS_CF
 | 
X86_EFLAGS_PF
 | \

150 
X86_EFLAGS_AF
 | 
X86_EFLAGS_ZF
 | \

151 
X86_EFLAGS_SF
 | 
X86_EFLAGS_TF
 | \

152 
X86_EFLAGS_DF
 | 
X86_EFLAGS_OF
 | \

153 
X86_EFLAGS_RF
 | 
X86_EFLAGS_AC
))

	)

158 
ölöe
 
boﬁ
 
	$övÆid_£À˘‹
(
u16
 
vÆue
)

160  
	`u∆ikñy
(
vÆue
 !0 && (vÆuê& 
SEGMENT_RPL_MASK
Ë!
USER_RPL
);

161 
	}
}

163 #ifde‡
CONFIG_X86_32


165 
	#FLAG_MASK
 
FLAG_MASK_32


	)

167 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
ªgno
)

169 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
bx
) != 0);

170  &
ªgs
->
bx
 + (
ªgno
 >> 2);

171 
	}
}

173 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

178 
ªtvÆ
;

179 i‡(
off£t
 !
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
))

180 
ªtvÆ
 = *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

182 i‡(
èsk
 =
cuºít
)

183 
ªtvÆ
 = 
	`gë_u£r_gs
(
	`èsk_±_ªgs
(
èsk
));

185 
ªtvÆ
 = 
	`èsk_u£r_gs
(
èsk
);

187  
ªtvÆ
;

188 
	}
}

190 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

191 
off£t
, 
u16
 
vÆue
)

196 i‡(
	`övÆid_£À˘‹
(
vÆue
))

197  -
EIO
;

208 
off£t
) {

209 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

210 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

211 i‡(
	`u∆ikñy
(
vÆue
 == 0))

212  -
EIO
;

215 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
Ë
vÆue
;

218 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

219 i‡(
èsk
 =
cuºít
)

220 
	`£t_u£r_gs
(
	`èsk_±_ªgs
(
èsk
), 
vÆue
);

222 
	`èsk_u£r_gs
(
èsk
Ë
vÆue
;

226 
	}
}

230 
	#FLAG_MASK
 (
FLAG_MASK_32
 | 
X86_EFLAGS_NT
)

	)

232 *
	$±_ªgs_ac˚ss
(
±_ªgs
 *
ªgs
, 
off£t
)

234 
	`BUILD_BUG_ON
(
	`off£tof
(
±_ªgs
, 
r15
) != 0);

235  &
ªgs
->
r15
 + (
off£t
 / (regs->r15));

236 
	}
}

238 
u16
 
	$gë_£gmít_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

243 
£g
;

245 
off£t
) {

246 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

247 i‡(
èsk
 =
cuºít
) {

249 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

250  
£g
;

252  
èsk
->
thªad
.
fsödex
;

253 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

254 i‡(
èsk
 =
cuºít
) {

255 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

256  
£g
;

258  
èsk
->
thªad
.
gsödex
;

259 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

260 i‡(
èsk
 =
cuºít
) {

261 
	`asm
("mov»%%ds,%0" : "Ù" (
£g
));

262  
£g
;

264  
èsk
->
thªad
.
ds
;

265 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

266 i‡(
èsk
 =
cuºít
) {

267 
	`asm
("mov»%%es,%0" : "Ù" (
£g
));

268  
£g
;

270  
èsk
->
thªad
.
es
;

272 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

273 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

276  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

277 
	}
}

279 
	$£t_£gmít_ªg
(
èsk_°ru˘
 *
èsk
,

280 
off£t
, 
u16
 
vÆue
)

285 i‡(
	`övÆid_£À˘‹
(
vÆue
))

286  -
EIO
;

288 
off£t
) {

289 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs
):

294 i‡((
vÆue
 =
FS_TLS_SEL
 && 
èsk
->
thªad
.
fsödex
 == 0 &&

295 
èsk
->
thªad
.
fs
 != 0) ||

296 (
vÆue
 =0 && 
èsk
->
thªad
.
fsödex
 =
FS_TLS_SEL
 &&

297 
èsk
->
thªad
.
fs
 == 0))

299 
èsk
->
thªad
.
fsödex
 = 
vÆue
;

300 i‡(
èsk
 =
cuºít
)

301 
	`lﬂd£gmít
(
fs
, 
èsk
->
thªad
.
fsödex
);

303 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs
):

308 i‡((
vÆue
 =
GS_TLS_SEL
 && 
èsk
->
thªad
.
gsödex
 == 0 &&

309 
èsk
->
thªad
.
gs
 != 0) ||

310 (
vÆue
 =0 && 
èsk
->
thªad
.
gsödex
 =
GS_TLS_SEL
 &&

311 
èsk
->
thªad
.
gs
 == 0))

313 
èsk
->
thªad
.
gsödex
 = 
vÆue
;

314 i‡(
èsk
 =
cuºít
)

315 
	`lﬂd_gs_ödex
(
èsk
->
thªad
.
gsödex
);

317 
	`off£tof
(
u£r_ªgs_°ru˘
,
ds
):

318 
èsk
->
thªad
.
ds
 = 
vÆue
;

319 i‡(
èsk
 =
cuºít
)

320 
	`lﬂd£gmít
(
ds
, 
èsk
->
thªad
.ds);

322 
	`off£tof
(
u£r_ªgs_°ru˘
,
es
):

323 
èsk
->
thªad
.
es
 = 
vÆue
;

324 i‡(
èsk
 =
cuºít
)

325 
	`lﬂd£gmít
(
es
, 
èsk
->
thªad
.es);

331 
	`off£tof
(
u£r_ªgs_°ru˘
,
cs
):

332 i‡(
	`u∆ikñy
(
vÆue
 == 0))

333  -
EIO
;

334 #ifde‡
CONFIG_IA32_EMULATION


335 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

336 
	`èsk_±_ªgs
(
èsk
)->
cs
 = 
vÆue
;

339 
	`off£tof
(
u£r_ªgs_°ru˘
,
ss
):

340 i‡(
	`u∆ikñy
(
vÆue
 == 0))

341  -
EIO
;

342 #ifde‡
CONFIG_IA32_EMULATION


343 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

344 
	`èsk_±_ªgs
(
èsk
)->
ss
 = 
vÆue
;

350 
	}
}

354 
	$gë_Êags
(
èsk_°ru˘
 *
èsk
)

356 
ªtvÆ
 = 
	`èsk_±_ªgs
(
èsk
)->
Êags
;

361 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

362 
ªtvÆ
 &~
X86_EFLAGS_TF
;

364  
ªtvÆ
;

365 
	}
}

367 
	$£t_Êags
(
èsk_°ru˘
 *
èsk
, 
vÆue
)

369 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

376 i‡(
vÆue
 & 
X86_EFLAGS_TF
)

377 
	`˛ór_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
);

378 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_FORCED_TF
))

379 
vÆue
 |
X86_EFLAGS_TF
;

381 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FLAG_MASK
Ë| (
vÆue
 & FLAG_MASK);

384 
	}
}

386 
	$puåeg
(
èsk_°ru˘
 *
chûd
,

387 
off£t
, 
vÆue
)

389 
off£t
) {

390 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

391 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

392 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

393 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

394 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

395 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

396  
	`£t_£gmít_ªg
(
chûd
, 
off£t
, 
vÆue
);

398 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

399  
	`£t_Êags
(
chûd
, 
vÆue
);

401 #ifde‡
CONFIG_X86_64


402 
	`off£tof
(
u£r_ªgs_°ru˘
,
fs_ba£
):

403 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

404  -
EIO
;

410 i‡(
chûd
->
thªad
.
fs
 !
vÆue
)

411  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_FS
, 
vÆue
);

413 
	`off£tof
(
u£r_ªgs_°ru˘
,
gs_ba£
):

417 i‡(
vÆue
 >
	`TASK_SIZE_OF
(
chûd
))

418  -
EIO
;

419 i‡(
chûd
->
thªad
.
gs
 !
vÆue
)

420  
	`do_¨ch_¥˘l
(
chûd
, 
ARCH_SET_GS
, 
vÆue
);

425 *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
chûd
), 
off£t
Ë
vÆue
;

427 
	}
}

429 
	$gëªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

431 
off£t
) {

432 
	`off£tof
(
u£r_ªgs_°ru˘
, 
cs
):

433 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ds
):

434 
	`off£tof
(
u£r_ªgs_°ru˘
, 
es
):

435 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs
):

436 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs
):

437 
	`off£tof
(
u£r_ªgs_°ru˘
, 
ss
):

438  
	`gë_£gmít_ªg
(
èsk
, 
off£t
);

440 
	`off£tof
(
u£r_ªgs_°ru˘
, 
Êags
):

441  
	`gë_Êags
(
èsk
);

443 #ifde‡
CONFIG_X86_64


444 
	`off£tof
(
u£r_ªgs_°ru˘
, 
fs_ba£
): {

450 
£g
 = 
èsk
->
thªad
.
fsödex
;

451 i‡(
èsk
->
thªad
.
fs
 != 0)

452  
èsk
->
thªad
.
fs
;

453 i‡(
èsk
 =
cuºít
)

454 
	`asm
("mov»%%fs,%0" : "Ù" (
£g
));

455 i‡(
£g
 !
FS_TLS_SEL
)

457  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
FS_TLS
]);

459 
	`off£tof
(
u£r_ªgs_°ru˘
, 
gs_ba£
): {

463 
£g
 = 
èsk
->
thªad
.
gsödex
;

464 i‡(
èsk
->
thªad
.
gs
 != 0)

465  
èsk
->
thªad
.
gs
;

466 i‡(
èsk
 =
cuºít
)

467 
	`asm
("mov»%%gs,%0" : "Ù" (
£g
));

468 i‡(
£g
 !
GS_TLS_SEL
)

470  
	`gë_desc_ba£
(&
èsk
->
thªad
.
és_¨øy
[
GS_TLS
]);

475  *
	`±_ªgs_ac˚ss
(
	`èsk_±_ªgs
(
èsk
), 
off£t
);

476 
	}
}

478 
	$gíªgs_gë
(
èsk_°ru˘
 *
èrgë
,

479 c⁄° 
u£r_ªg£t
 *
ªg£t
,

480 
pos
, 
cou¡
,

481 *
kbuf
, 
__u£r
 *
ubuf
)

483 i‡(
kbuf
) {

484 *
k
 = 
kbuf
;

485 
cou¡
 >(*
k
)) {

486 *
k
++ = 
	`gëªg
(
èrgë
, 
pos
);

487 
cou¡
 -(*
k
);

488 
pos
 +(*
k
);

491 
__u£r
 *
u
 = 
ubuf
;

492 
cou¡
 >(*
u
)) {

493 i‡(
	`__put_u£r
(
	`gëªg
(
èrgë
, 
pos
), 
u
++))

494  -
EFAULT
;

495 
cou¡
 -(*
u
);

496 
pos
 +(*
u
);

501 
	}
}

503 
	$gíªgs_£t
(
èsk_°ru˘
 *
èrgë
,

504 c⁄° 
u£r_ªg£t
 *
ªg£t
,

505 
pos
, 
cou¡
,

506 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

508 
ªt
 = 0;

509 i‡(
kbuf
) {

510 c⁄° *
k
 = 
kbuf
;

511 
cou¡
 >(*
k
Ë&& !
ªt
) {

512 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, *
k
++);

513 
cou¡
 -(*
k
);

514 
pos
 +(*
k
);

517 c⁄° 
__u£r
 *
u
 = 
ubuf
;

518 
cou¡
 >(*
u
Ë&& !
ªt
) {

519 
w‹d
;

520 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

521 i‡(
ªt
)

523 
ªt
 = 
	`puåeg
(
èrgë
, 
pos
, 
w‹d
);

524 
cou¡
 -(*
u
);

525 
pos
 +(*
u
);

528  
ªt
;

529 
	}
}

531 
	$±ø˚_åiggîed
(
≥rf_evít
 *
bp
, 
nmi
,

532 
≥rf_ßm∂e_d©a
 *
d©a
,

533 
±_ªgs
 *
ªgs
)

535 
i
;

536 
thªad_°ru˘
 *
thªad
 = &(
cuºít
->thread);

542 
i
 = 0; i < 
HBP_NUM
; i++) {

543 i‡(
thªad
->
±ø˚_bps
[
i
] =
bp
)

547 
thªad
->
debugªg6
 |(
DR_TRAP0
 << 
i
);

548 
	}
}

555 
	$±ø˚_gë_dr7
(
≥rf_evít
 *
bp
[])

557 
i
;

558 
dr7
 = 0;

559 
¨ch_hw_bªakpoöt
 *
öfo
;

561 
i
 = 0; i < 
HBP_NUM
; i++) {

562 i‡(
bp
[
i
] && !bp[i]->
©å
.
dißbÀd
) {

563 
öfo
 = 
	`cou¡î_¨ch_bp
(
bp
[
i
]);

564 
dr7
 |
	`ícode_dr7
(
i
, 
öfo
->
Àn
, info->
ty≥
);

568  
dr7
;

569 
	}
}

572 
	$±ø˚_modify_bªakpoöt
(
≥rf_evít
 *
bp
, 
Àn
, 
ty≥
,

573 
èsk_°ru˘
 *
tsk
, 
dißbÀd
)

575 
îr
;

576 
gí_Àn
, 
gí_ty≥
;

577 
≥rf_evít_©å
 
©å
;

584 i‡(!
bp
)

585  -
EINVAL
;

587 
îr
 = 
	`¨ch_bp_gíîic_fõlds
(
Àn
, 
ty≥
, &
gí_Àn
, &
gí_ty≥
);

588 i‡(
îr
)

589  
îr
;

591 
©å
 = 
bp
->attr;

592 
©å
.
bp_Àn
 = 
gí_Àn
;

593 
©å
.
bp_ty≥
 = 
gí_ty≥
;

594 
©å
.
dißbÀd
 = disabled;

596  
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

597 
	}
}

602 
	$±ø˚_wrôe_dr7
(
èsk_°ru˘
 *
tsk
, 
d©a
)

604 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

605 
ﬁd_dr7
;

606 
i
, 
‹ig_ªt
 = 0, 
rc
 = 0;

607 
íabÀd
, 
£c⁄d_∑ss
 = 0;

608 
Àn
, 
ty≥
;

609 
≥rf_evít
 *
bp
;

611 
d©a
 &~
DR_CONTROL_RESERVED
;

612 
ﬁd_dr7
 = 
	`±ø˚_gë_dr7
(
thªad
->
±ø˚_bps
);

613 
ª°‹e
:

618 
i
 = 0; i < 
HBP_NUM
; i++) {

619 
íabÀd
 = 
	`decode_dr7
(
d©a
, 
i
, &
Àn
, &
ty≥
);

620 
bp
 = 
thªad
->
±ø˚_bps
[
i
];

622 i‡(!
íabÀd
) {

623 i‡(
bp
) {

631 i‡(!
£c⁄d_∑ss
)

634 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
,

635 
tsk
, 1);

636 i‡(
rc
)

642 
rc
 = 
	`±ø˚_modify_bªakpoöt
(
bp
, 
Àn
, 
ty≥
, 
tsk
, 0);

643 i‡(
rc
)

650 i‡(!
£c⁄d_∑ss
) {

651 
£c⁄d_∑ss
 = 1;

652 i‡(
rc
 < 0) {

653 
‹ig_ªt
 = 
rc
;

654 
d©a
 = 
ﬁd_dr7
;

656 
ª°‹e
;

658  ((
‹ig_ªt
 < 0Ë? orig_ªà: 
rc
);

659 
	}
}

664 
	$±ø˚_gë_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
)

666 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

667 
vÆ
 = 0;

669 i‡(
n
 < 
HBP_NUM
) {

670 
≥rf_evít
 *
bp
;

671 
bp
 = 
thªad
->
±ø˚_bps
[
n
];

672 i‡(!
bp
)

674 
vÆ
 = 
bp
->
hw
.
öfo
.
addªss
;

675 } i‡(
n
 == 6) {

676 
vÆ
 = 
thªad
->
debugªg6
;

677 } i‡(
n
 == 7) {

678 
vÆ
 = 
thªad
->
±ø˚_dr7
;

680  
vÆ
;

681 
	}
}

683 
	$±ø˚_£t_bªakpoöt_addr
(
èsk_°ru˘
 *
tsk
, 
ƒ
,

684 
addr
)

686 
≥rf_evít
 *
bp
;

687 
thªad_°ru˘
 *
t
 = &
tsk
->
thªad
;

688 
≥rf_evít_©å
 
©å
;

690 i‡(!
t
->
±ø˚_bps
[
ƒ
]) {

691 
	`±ø˚_bªakpoöt_öô
(&
©å
);

696 
©å
.
bp_addr
 = 
addr
;

697 
©å
.
bp_Àn
 = 
HW_BREAKPOINT_LEN_1
;

698 
©å
.
bp_ty≥
 = 
HW_BREAKPOINT_W
;

699 
©å
.
dißbÀd
 = 1;

701 
bp
 = 
	`ªgi°î_u£r_hw_bªakpoöt
(&
©å
, 
±ø˚_åiggîed
, 
tsk
);

712 i‡(
	`IS_ERR
(
bp
))

713  
	`PTR_ERR
(
bp
);

715 
t
->
±ø˚_bps
[
ƒ
] = 
bp
;

717 
îr
;

719 
bp
 = 
t
->
±ø˚_bps
[
ƒ
];

721 
©å
 = 
bp
->attr;

722 
©å
.
bp_addr
 = 
addr
;

723 
îr
 = 
	`modify_u£r_hw_bªakpoöt
(
bp
, &
©å
);

724 i‡(
îr
)

725  
îr
;

730 
	}
}

735 
	$±ø˚_£t_debugªg
(
èsk_°ru˘
 *
tsk
, 
n
, 
vÆ
)

737 
thªad_°ru˘
 *
thªad
 = &(
tsk
->thread);

738 
rc
 = 0;

741 i‡(
n
 == 4 ||Ç == 5)

742  -
EIO
;

744 i‡(
n
 == 6) {

745 
thªad
->
debugªg6
 = 
vÆ
;

746 
ªt_∑th
;

748 i‡(
n
 < 
HBP_NUM
) {

749 
rc
 = 
	`±ø˚_£t_bªakpoöt_addr
(
tsk
, 
n
, 
vÆ
);

750 i‡(
rc
)

751  
rc
;

754 i‡(
n
 == 7) {

755 
rc
 = 
	`±ø˚_wrôe_dr7
(
tsk
, 
vÆ
);

756 i‡(!
rc
)

757 
thªad
->
±ø˚_dr7
 = 
vÆ
;

760 
ªt_∑th
:

761  
rc
;

762 
	}
}

768 
	$i›îm_a˘ive
(
èsk_°ru˘
 *
èrgë
,

769 c⁄° 
u£r_ªg£t
 *
ªg£t
)

771  
èrgë
->
thªad
.
io_bôm≠_max
 / 
ªg£t
->
size
;

772 
	}
}

774 
	$i›îm_gë
(
èsk_°ru˘
 *
èrgë
,

775 c⁄° 
u£r_ªg£t
 *
ªg£t
,

776 
pos
, 
cou¡
,

777 *
kbuf
, 
__u£r
 *
ubuf
)

779 i‡(!
èrgë
->
thªad
.
io_bôm≠_±r
)

780  -
ENXIO
;

782  
	`u£r_ªg£t_c›yout
(&
pos
, &
cou¡
, &
kbuf
, &
ubuf
,

783 
èrgë
->
thªad
.
io_bôm≠_±r
,

784 0, 
IO_BITMAP_BYTES
);

785 
	}
}

792 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

794 
	`u£r_dißbÀ_sögÀ_°ï
(
chûd
);

795 #ifde‡
TIF_SYSCALL_EMU


796 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_EMU
);

798 
	}
}

800 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


801 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
;

804 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

806 
ªt
;

807 
__u£r
 *
d©≠
 = (__u£∏*)
d©a
;

809 
ªque°
) {

811 
PTRACE_PEEKUSR
: {

812 
tmp
;

814 
ªt
 = -
EIO
;

815 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

816 
addr
 >(
u£r
))

819 
tmp
 = 0;

820 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

821 
tmp
 = 
	`gëªg
(
chûd
, 
addr
);

822 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

823 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

824 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

825 
tmp
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
addr
 / (
d©a
));

827 
ªt
 = 
	`put_u£r
(
tmp
, 
d©≠
);

831 
PTRACE_POKEUSR
:

832 
ªt
 = -
EIO
;

833 i‡((
addr
 & ((
d©a
) - 1)) ||áddr < 0 ||

834 
addr
 >(
u£r
))

837 i‡(
addr
 < (
u£r_ªgs_°ru˘
))

838 
ªt
 = 
	`puåeg
(
chûd
, 
addr
, 
d©a
);

839 i‡(
addr
 >
	`off£tof
(
u£r
, 
u_debugªg
[0]) &&

840 
addr
 <
	`off£tof
(
u£r
, 
u_debugªg
[7])) {

841 
addr
 -
	`off£tof
(
u£r
, 
u_debugªg
[0]);

842 
ªt
 = 
	`±ø˚_£t_debugªg
(
chûd
,

843 
addr
 / (
d©a
), data);

847 
PTRACE_GETREGS
:

848  
	`c›y_ªg£t_to_u£r
(
chûd
,

849 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

850 
REGSET_GENERAL
,

851 0, (
u£r_ªgs_°ru˘
),

852 
d©≠
);

854 
PTRACE_SETREGS
:

855  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

856 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

857 
REGSET_GENERAL
,

858 0, (
u£r_ªgs_°ru˘
),

859 
d©≠
);

861 
PTRACE_GETFPREGS
:

862  
	`c›y_ªg£t_to_u£r
(
chûd
,

863 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

864 
REGSET_FP
,

865 0, (
u£r_i387_°ru˘
),

866 
d©≠
);

868 
PTRACE_SETFPREGS
:

869  
	`c›y_ªg£t_‰om_u£r
(
chûd
,

870 
	`èsk_u£r_ªg£t_võw
(
cuºít
),

871 
REGSET_FP
,

872 0, (
u£r_i387_°ru˘
),

873 
d©≠
);

875 #ifde‡
CONFIG_X86_32


876 
PTRACE_GETFPXREGS
:

877  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

878 
REGSET_XFP
,

879 0, (
u£r_fx§_°ru˘
),

880 
d©≠
Ë? -
EIO
 : 0;

882 
PTRACE_SETFPXREGS
:

883  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

884 
REGSET_XFP
,

885 0, (
u£r_fx§_°ru˘
),

886 
d©≠
Ë? -
EIO
 : 0;

889 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


890 
PTRACE_GET_THREAD_AREA
:

891 i‡(
addr
 < 0)

892  -
EIO
;

893 
ªt
 = 
	`do_gë_thªad_¨ó
(
chûd
, 
addr
,

894 (
u£r_desc
 
__u£r
 *Ë
d©a
);

897 
PTRACE_SET_THREAD_AREA
:

898 i‡(
addr
 < 0)

899  -
EIO
;

900 
ªt
 = 
	`do_£t_thªad_¨ó
(
chûd
, 
addr
,

901 (
u£r_desc
 
__u£r
 *Ë
d©a
, 0);

905 #ifde‡
CONFIG_X86_64


909 
PTRACE_ARCH_PRCTL
:

910 
ªt
 = 
	`do_¨ch_¥˘l
(
chûd
, 
d©a
, 
addr
);

915 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

919  
ªt
;

920 
	}
}

922 #ifde‡
CONFIG_IA32_EMULATION


924 
	~<löux/com∑t.h
>

925 
	~<löux/sysˇŒs.h
>

926 
	~<asm/ü32.h
>

927 
	~<asm/u£r32.h
>

929 
	#R32
(
l
,
q
) \

930 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

931 
ªgs
->
q
 = 
vÆue
; 

	)

933 
	#SEG32
(
rs
) \

934 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

935  
	`£t_£gmít_ªg
(
chûd
, \

936 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
), \

937 
vÆue
); \

938 

	)

940 
	$puåeg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 
vÆue
)

942 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

944 
ªgno
) {

946 
	`SEG32
(
cs
);

947 
	`SEG32
(
ds
);

948 
	`SEG32
(
es
);

949 
	`SEG32
(
fs
);

950 
	`SEG32
(
gs
);

951 
	`SEG32
(
ss
);

953 
	`R32
(
ebx
, 
bx
);

954 
	`R32
(
ecx
, 
cx
);

955 
	`R32
(
edx
, 
dx
);

956 
	`R32
(
edi
, 
di
);

957 
	`R32
(
esi
, 
si
);

958 
	`R32
(
ebp
, 
bp
);

959 
	`R32
(
óx
, 
ax
);

960 
	`R32
(
eù
, 
ù
);

961 
	`R32
(
e•
, 
•
);

963 
	`off£tof
(
u£r32
, 
ªgs
.
‹ig_óx
):

971 
ªgs
->
‹ig_ax
 = 
vÆue
;

972 i‡(
	`sysˇŒ_gë_ƒ
(
chûd
, 
ªgs
) >= 0)

973 
	`èsk_thªad_öfo
(
chûd
)->
°©us
 |
TS_COMPAT
;

976 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

977  
	`£t_Êags
(
chûd
, 
vÆue
);

979 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

980 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

981 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

982  
	`±ø˚_£t_debugªg
(
chûd
, 
ªgno
 / 4, 
vÆue
);

985 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

986  -
EIO
;

995 
	}
}

997 #unde‡
R32


998 #unde‡
SEG32


1000 
	#R32
(
l
,
q
) \

1001 
	`off£tof
(
u£r32
, 
ªgs
.
l
): \

1002 *
vÆ
 = 
ªgs
->
q
; 

	)

1004 
	#SEG32
(
rs
) \

1005 
	`off£tof
(
u£r32
, 
ªgs
.
rs
): \

1006 *
vÆ
 = 
	`gë_£gmít_ªg
(
chûd
, \

1007 
	`off£tof
(
u£r_ªgs_°ru˘
, 
rs
)); \

1008 

	)

1010 
	$gëªg32
(
èsk_°ru˘
 *
chûd
, 
ªgno
, 
u32
 *
vÆ
)

1012 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

1014 
ªgno
) {

1016 
	`SEG32
(
ds
);

1017 
	`SEG32
(
es
);

1018 
	`SEG32
(
fs
);

1019 
	`SEG32
(
gs
);

1021 
	`R32
(
cs
, cs);

1022 
	`R32
(
ss
, ss);

1023 
	`R32
(
ebx
, 
bx
);

1024 
	`R32
(
ecx
, 
cx
);

1025 
	`R32
(
edx
, 
dx
);

1026 
	`R32
(
edi
, 
di
);

1027 
	`R32
(
esi
, 
si
);

1028 
	`R32
(
ebp
, 
bp
);

1029 
	`R32
(
óx
, 
ax
);

1030 
	`R32
(
‹ig_óx
, 
‹ig_ax
);

1031 
	`R32
(
eù
, 
ù
);

1032 
	`R32
(
e•
, 
•
);

1034 
	`off£tof
(
u£r32
, 
ªgs
.
eÊags
):

1035 *
vÆ
 = 
	`gë_Êags
(
chûd
);

1038 
	`off£tof
(
u£r32
, 
u_debugªg
[0]) ...

1039 
	`off£tof
(
u£r32
, 
u_debugªg
[7]):

1040 
ªgno
 -
	`off£tof
(
u£r32
, 
u_debugªg
[0]);

1041 *
vÆ
 = 
	`±ø˚_gë_debugªg
(
chûd
, 
ªgno
 / 4);

1045 i‡(
ªgno
 > (
u£r32
) || (regno & 3))

1046  -
EIO
;

1052 *
vÆ
 = 0;

1056 
	}
}

1058 #unde‡
R32


1059 #unde‡
SEG32


1061 
	$gíªgs32_gë
(
èsk_°ru˘
 *
èrgë
,

1062 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1063 
pos
, 
cou¡
,

1064 *
kbuf
, 
__u£r
 *
ubuf
)

1066 i‡(
kbuf
) {

1067 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1068 
cou¡
 >(*
k
)) {

1069 
	`gëªg32
(
èrgë
, 
pos
, 
k
++);

1070 
cou¡
 -(*
k
);

1071 
pos
 +(*
k
);

1074 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1075 
cou¡
 >(*
u
)) {

1076 
com∑t_ul⁄g_t
 
w‹d
;

1077 
	`gëªg32
(
èrgë
, 
pos
, &
w‹d
);

1078 i‡(
	`__put_u£r
(
w‹d
, 
u
++))

1079  -
EFAULT
;

1080 
cou¡
 -(*
u
);

1081 
pos
 +(*
u
);

1086 
	}
}

1088 
	$gíªgs32_£t
(
èsk_°ru˘
 *
èrgë
,

1089 c⁄° 
u£r_ªg£t
 *
ªg£t
,

1090 
pos
, 
cou¡
,

1091 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

1093 
ªt
 = 0;

1094 i‡(
kbuf
) {

1095 c⁄° 
com∑t_ul⁄g_t
 *
k
 = 
kbuf
;

1096 
cou¡
 >(*
k
Ë&& !
ªt
) {

1097 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, *
k
++);

1098 
cou¡
 -(*
k
);

1099 
pos
 +(*
k
);

1102 c⁄° 
com∑t_ul⁄g_t
 
__u£r
 *
u
 = 
ubuf
;

1103 
cou¡
 >(*
u
Ë&& !
ªt
) {

1104 
com∑t_ul⁄g_t
 
w‹d
;

1105 
ªt
 = 
	`__gë_u£r
(
w‹d
, 
u
++);

1106 i‡(
ªt
)

1108 
ªt
 = 
	`puåeg32
(
èrgë
, 
pos
, 
w‹d
);

1109 
cou¡
 -(*
u
);

1110 
pos
 +(*
u
);

1113  
ªt
;

1114 
	}
}

1116 
	$com∑t_¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
com∑t_l⁄g_t
 
ªque°
,

1117 
com∑t_ul⁄g_t
 
ˇddr
, com∑t_ul⁄g_à
cd©a
)

1119 
addr
 = 
ˇddr
;

1120 
d©a
 = 
cd©a
;

1121 
__u£r
 *
d©≠
 = 
	`com∑t_±r
(
d©a
);

1122 
ªt
;

1123 
__u32
 
vÆ
;

1125 
ªque°
) {

1126 
PTRACE_PEEKUSR
:

1127 
ªt
 = 
	`gëªg32
(
chûd
, 
addr
, &
vÆ
);

1128 i‡(
ªt
 == 0)

1129 
ªt
 = 
	`put_u£r
(
vÆ
, (
__u32
 
__u£r
 *)
d©≠
);

1132 
PTRACE_POKEUSR
:

1133 
ªt
 = 
	`puåeg32
(
chûd
, 
addr
, 
d©a
);

1136 
PTRACE_GETREGS
:

1137  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1138 
REGSET_GENERAL
,

1139 0, (
u£r_ªgs_°ru˘32
),

1140 
d©≠
);

1142 
PTRACE_SETREGS
:

1143  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1144 
REGSET_GENERAL
, 0,

1145 (
u£r_ªgs_°ru˘32
),

1146 
d©≠
);

1148 
PTRACE_GETFPREGS
:

1149  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1150 
REGSET_FP
, 0,

1151 (
u£r_i387_ü32_°ru˘
),

1152 
d©≠
);

1154 
PTRACE_SETFPREGS
:

1155  
	`c›y_ªg£t_‰om_u£r
(

1156 
chûd
, &
u£r_x86_32_võw
, 
REGSET_FP
,

1157 0, (
u£r_i387_ü32_°ru˘
), 
d©≠
);

1159 
PTRACE_GETFPXREGS
:

1160  
	`c›y_ªg£t_to_u£r
(
chûd
, &
u£r_x86_32_võw
,

1161 
REGSET_XFP
, 0,

1162 (
u£r32_fx§_°ru˘
),

1163 
d©≠
);

1165 
PTRACE_SETFPXREGS
:

1166  
	`c›y_ªg£t_‰om_u£r
(
chûd
, &
u£r_x86_32_võw
,

1167 
REGSET_XFP
, 0,

1168 (
u£r32_fx§_°ru˘
),

1169 
d©≠
);

1171 
PTRACE_GET_THREAD_AREA
:

1172 
PTRACE_SET_THREAD_AREA
:

1173  
	`¨ch_±ø˚
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1176  
	`com∑t_±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

1179  
ªt
;

1180 
	}
}

1184 #ifde‡
CONFIG_X86_64


1186 
u£r_ªg£t
 
	gx86_64_ªg£ts
[] 
	g__ªad_mo°ly
 = {

1187 [
REGSET_GENERAL
] = {

1188 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1189 .
	gn
 = (
u£r_ªgs_°ru˘
) / (),

1190 .
	gsize
 = (), .
	gÆign
 = (),

1191 .
	ggë
 = 
gíªgs_gë
, .
	g£t
 = 
gíªgs_£t


1193 [
REGSET_FP
] = {

1194 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1195 .
	gn
 = (
u£r_i387_°ru˘
) / (),

1196 .
	gsize
 = (), .
	gÆign
 = (),

1197 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1199 [
REGSET_XSTATE
] = {

1200 .
c‹e_nŸe_ty≥
 = 
NT_X86_XSTATE
,

1201 .
	gsize
 = (
u64
), .
	gÆign
 = (u64),

1202 .
	ga˘ive
 = 
x°©îegs_a˘ive
, .
	ggë
 = 
x°©îegs_gë
,

1203 .
	g£t
 = 
x°©îegs_£t


1205 [
REGSET_IOPERM64
] = {

1206 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1207 .
	gn
 = 
IO_BITMAP_LONGS
,

1208 .
	gsize
 = (), .
	gÆign
 = (),

1209 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1213 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_64_võw
 = {

1214 .
«me
 = "x86_64", .
	ge_machöe
 = 
EM_X86_64
,

1215 .
	gªg£ts
 = 
x86_64_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_64_regsets)

1220 
	#u£r_ªgs_°ru˘32
 
u£r_ªgs_°ru˘


	)

1221 
	#gíªgs32_gë
 
gíªgs_gë


	)

1222 
	#gíªgs32_£t
 
gíªgs_£t


	)

1224 
	#u£r_i387_ü32_°ru˘
 
u£r_i387_°ru˘


	)

1225 
	#u£r32_fx§_°ru˘
 
u£r_fx§_°ru˘


	)

1229 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1230 
u£r_ªg£t
 
	gx86_32_ªg£ts
[] 
	g__ªad_mo°ly
 = {

1231 [
REGSET_GENERAL
] = {

1232 .
c‹e_nŸe_ty≥
 = 
NT_PRSTATUS
,

1233 .
	gn
 = (
u£r_ªgs_°ru˘32
Ë/ (
u32
),

1234 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1235 .
	ggë
 = 
gíªgs32_gë
, .
	g£t
 = 
gíªgs32_£t


1237 [
REGSET_FP
] = {

1238 .
c‹e_nŸe_ty≥
 = 
NT_PRFPREG
,

1239 .
	gn
 = (
u£r_i387_ü32_°ru˘
Ë/ (
u32
),

1240 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1241 .
	ga˘ive
 = 
Âªgs_a˘ive
, .
	ggë
 = 
Âªgs_gë
, .
	g£t
 = 
Âªgs_£t


1243 [
REGSET_XFP
] = {

1244 .
c‹e_nŸe_ty≥
 = 
NT_PRXFPREG
,

1245 .
	gn
 = (
u£r32_fx§_°ru˘
Ë/ (
u32
),

1246 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1247 .
	ga˘ive
 = 
xÂªgs_a˘ive
, .
	ggë
 = 
xÂªgs_gë
, .
	g£t
 = 
xÂªgs_£t


1249 [
REGSET_XSTATE
] = {

1250 .
c‹e_nŸe_ty≥
 = 
NT_X86_XSTATE
,

1251 .
	gsize
 = (
u64
), .
	gÆign
 = (u64),

1252 .
	ga˘ive
 = 
x°©îegs_a˘ive
, .
	ggë
 = 
x°©îegs_gë
,

1253 .
	g£t
 = 
x°©îegs_£t


1255 [
REGSET_TLS
] = {

1256 .
c‹e_nŸe_ty≥
 = 
NT_386_TLS
,

1257 .
	gn
 = 
GDT_ENTRY_TLS_ENTRIES
, .
	gbüs
 = 
GDT_ENTRY_TLS_MIN
,

1258 .
	gsize
 = (
u£r_desc
),

1259 .
	gÆign
 = (
u£r_desc
),

1260 .
	ga˘ive
 = 
ªg£t_és_a˘ive
,

1261 .
	ggë
 = 
ªg£t_és_gë
, .
	g£t
 = 
ªg£t_és_£t


1263 [
REGSET_IOPERM32
] = {

1264 .
c‹e_nŸe_ty≥
 = 
NT_386_IOPERM
,

1265 .
	gn
 = 
IO_BITMAP_BYTES
 / (
u32
),

1266 .
	gsize
 = (
u32
), .
	gÆign
 = (u32),

1267 .
	ga˘ive
 = 
i›îm_a˘ive
, .
	ggë
 = 
i›îm_gë


1271 c⁄° 
u£r_ªg£t_võw
 
	gu£r_x86_32_võw
 = {

1272 .
«me
 = "i386", .
	ge_machöe
 = 
EM_386
,

1273 .
	gªg£ts
 = 
x86_32_ªg£ts
, .
	gn
 = 
ARRAY_SIZE
(x86_32_regsets)

1281 
u64
 
	gx°©e_fx_sw_byãs
[
USER_XSTATE_FX_SW_WORDS
];

1283 
	$upd©e_ªg£t_x°©e_öfo
(
size
, 
u64
 
x°©e_mask
)

1285 #ifde‡
CONFIG_X86_64


1286 
x86_64_ªg£ts
[
REGSET_XSTATE
].
n
 = 
size
 / (
u64
);

1288 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1289 
x86_32_ªg£ts
[
REGSET_XSTATE
].
n
 = 
size
 / (
u64
);

1291 
x°©e_fx_sw_byãs
[
USER_XSTATE_XCR0_WORD
] = 
x°©e_mask
;

1292 
	}
}

1294 c⁄° 
u£r_ªg£t_võw
 *
	$èsk_u£r_ªg£t_võw
(
èsk_°ru˘
 *
èsk
)

1296 #ifde‡
CONFIG_IA32_EMULATION


1297 i‡(
	`ã°_tsk_thªad_Êag
(
èsk
, 
TIF_IA32
))

1299 #i‡
deföed
 
CONFIG_X86_32
 || deföed 
CONFIG_IA32_EMULATION


1300  &
u£r_x86_32_võw
;

1302 #ifde‡
CONFIG_X86_64


1303  &
u£r_x86_64_võw
;

1305 
	}
}

1307 
	$fûl_sigå≠_öfo
(
èsk_°ru˘
 *
tsk
,

1308 
±_ªgs
 *
ªgs
,

1309 
îr‹_code
, 
si_code
,

1310 
sigöfo
 *
öfo
)

1312 
tsk
->
thªad
.
å≠_no
 = 1;

1313 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

1315 
	`mem£t
(
öfo
, 0, (*info));

1316 
öfo
->
si_signo
 = 
SIGTRAP
;

1317 
öfo
->
si_code
 = si_code;

1318 
öfo
->
si_addr
 = 
	`u£r_mode_vm
(
ªgs
Ë? (
__u£r
 *Ïegs->
ù
 : 
NULL
;

1319 
	}
}

1321 
	$u£r_sögÀ_°ï_sigöfo
(
èsk_°ru˘
 *
tsk
,

1322 
±_ªgs
 *
ªgs
,

1323 
sigöfo
 *
öfo
)

1325 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 0, 
TRAP_BRKPT
, 
öfo
);

1326 
	}
}

1328 
	$£nd_sigå≠
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
,

1329 
îr‹_code
, 
si_code
)

1331 
sigöfo
 
öfo
;

1333 
	`fûl_sigå≠_öfo
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
, &
öfo
);

1335 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

1336 
	}
}

1339 #ifde‡
CONFIG_X86_32


1340 
	#IS_IA32
 1

	)

1341 #ñi‡
deföed
 
CONFIG_IA32_EMULATION


1342 
	#IS_IA32
 
	`is_com∑t_èsk
()

	)

1344 
	#IS_IA32
 0

	)

1351 
asmªg∑rm
 
	$sysˇŒ_åa˚_íãr
(
±_ªgs
 *
ªgs
)

1353 
ªt
 = 0;

1362 i‡(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
))

1363 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

1366 
	`£cuª_computög
(
ªgs
->
‹ig_ax
);

1368 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
)))

1369 
ªt
 = -1L;

1371 i‡((
ªt
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
)) &&

1372 
	`åa˚hook_ªp‹t_sysˇŒ_íåy
(
ªgs
))

1373 
ªt
 = -1L;

1375 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1376 
	`åa˚_sys_íãr
(
ªgs
,Ñegs->
‹ig_ax
);

1378 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
)) {

1379 i‡(
IS_IA32
)

1380 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_I386
,

1381 
ªgs
->
‹ig_ax
,

1382 
ªgs
->
bx
,Ñegs->
cx
,

1383 
ªgs
->
dx
,Ñegs->
si
);

1384 #ifde‡
CONFIG_X86_64


1386 
	`audô_sysˇŒ_íåy
(
AUDIT_ARCH_X86_64
,

1387 
ªgs
->
‹ig_ax
,

1388 
ªgs
->
di
,Ñegs->
si
,

1389 
ªgs
->
dx
,Ñegs->
r10
);

1393  
ªt
 ?: 
ªgs
->
‹ig_ax
;

1394 
	}
}

1396 
asmªg∑rm
 
	$sysˇŒ_åa˚_Àave
(
±_ªgs
 *
ªgs
)

1398 
boﬁ
 
°ï
;

1400 i‡(
	`u∆ikñy
(
cuºít
->
audô_c⁄ãxt
))

1401 
	`audô_sysˇŒ_exô
(
	`AUDITSC_RESULT
(
ªgs
->
ax
),Ñegs->ax);

1403 i‡(
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACEPOINT
)))

1404 
	`åa˚_sys_exô
(
ªgs
,Ñegs->
ax
);

1412 
°ï
 = 
	`u∆ikñy
(
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
)) &&

1413 !
	`ã°_thªad_Êag
(
TIF_SYSCALL_EMU
);

1414 i‡(
°ï
 || 
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

1415 
	`åa˚hook_ªp‹t_sysˇŒ_exô
(
ªgs
, 
°ï
);

1416 
	}
}

	@/cmpt816/linux/arch/x86/kernel/quirks.c

4 
	~<löux/pci.h
>

5 
	~<löux/úq.h
>

7 
	~<asm/h≥t.h
>

9 #i‡
deföed
(
CONFIG_X86_IO_APIC
Ë&& deföed(
CONFIG_SMP
Ë&& deföed(
CONFIG_PCI
)

11 
__devöô
 
	$quúk_öãl_úqbÆ™˚
(
pci_dev
 *
dev
)

13 
u8
 
c⁄fig
, 
ªv
;

14 
u16
 
w‹d
;

21 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_CLASS_REVISION
, &
ªv
);

22 i‡(
ªv
 > 0x9)

26 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xf4, &
c⁄fig
);

27 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
|0x2);

33 
	`pci_bus_ªad_c⁄fig_w‹d
(
dev
->
bus
, 
	`PCI_DEVFN
(8, 0), 0x4c, &
w‹d
);

35 i‡(!(
w‹d
 & (1 << 13))) {

36 
	`dev_öfo
(&
dev
->dev, "Intel E7520/7320/7525 detected; "

38 
	`noúqdebug_£tup
("");

39 #ifde‡
CONFIG_PROC_FS


40 
no_úq_afföôy
 = 1;

45 i‡(!(
c⁄fig
 & 0x2))

46 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xf4, 
c⁄fig
);

47 
	}
}

48 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7320_MCH
,

49 
quúk_öãl_úqbÆ™˚
);

50 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7525_MCH
,

51 
quúk_öãl_úqbÆ™˚
);

52 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_E7520_MCH
,

53 
quúk_öãl_úqbÆ™˚
);

56 #i‡
deföed
(
CONFIG_HPET_TIMER
)

57 
	gf‹˚_h≥t_addªss
;

60 
	mNONE_FORCE_HPET_RESUME
,

61 
	mOLD_ICH_FORCE_HPET_RESUME
,

62 
	mICH_FORCE_HPET_RESUME
,

63 
	mVT8237_FORCE_HPET_RESUME
,

64 
	mNVIDIA_FORCE_HPET_RESUME
,

65 
	mATI_FORCE_HPET_RESUME
,

66 } 
	gf‹˚_h≥t_ªsume_ty≥
;

68 
__iomem
 *
	grcba_ba£
;

70 
	$ich_f‹˚_h≥t_ªsume
()

72 
u32
 
vÆ
;

74 i‡(!
f‹˚_h≥t_addªss
)

77 
	`BUG_ON
(
rcba_ba£
 =
NULL
);

80 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

81 i‡(!(
vÆ
 & 0x80)) {

83 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

86 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

87 i‡(!(
vÆ
 & 0x80))

88 
	`BUG
();

90 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

93 
	}
}

95 
	$ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

97 
u32
 
vÆ
;

98 
u32
 
	`unöôülized_v¨
(
rcba
);

99 
îr
 = 0;

101 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

104 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xF0, &
rcba
);

105 
rcba
 &= 0xFFFFC000;

106 i‡(
rcba
 == 0) {

107 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "RCBA disabled; "

113 
rcba_ba£
 = 
	`i‹em≠_noˇche
(
rcba
, 0x4000);

114 i‡(
rcba_ba£
 =
NULL
) {

115 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ioremap failed; "

121 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

123 i‡(
vÆ
 & 0x80) {

125 
vÆ
 = val & 0x3;

126 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

127 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

128 "0x%lx\n", 
f‹˚_h≥t_addªss
);

129 
	`iounm≠
(
rcba_ba£
);

134 
	`wrôñ
(
vÆ
 | 0x80, 
rcba_ba£
 + 0x3404);

136 
vÆ
 = 
	`ªadl
(
rcba_ba£
 + 0x3404);

137 i‡(!(
vÆ
 & 0x80)) {

138 
îr
 = 1;

140 
vÆ
 = val & 0x3;

141 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

144 i‡(
îr
) {

145 
f‹˚_h≥t_addªss
 = 0;

146 
	`iounm≠
(
rcba_ba£
);

147 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev,

150 
f‹˚_h≥t_ªsume_ty≥
 = 
ICH_FORCE_HPET_RESUME
;

151 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

152 "0x%lx\n", 
f‹˚_h≥t_addªss
);

154 
	}
}

156 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB2_0
,

157 
ich_f‹˚_íabÀ_h≥t
);

158 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_0
,

159 
ich_f‹˚_íabÀ_h≥t
);

160 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH6_1
,

161 
ich_f‹˚_íabÀ_h≥t
);

162 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_0
,

163 
ich_f‹˚_íabÀ_h≥t
);

164 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_1
,

165 
ich_f‹˚_íabÀ_h≥t
);

166 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH7_31
,

167 
ich_f‹˚_íabÀ_h≥t
);

168 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_1
,

169 
ich_f‹˚_íabÀ_h≥t
);

170 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH8_4
,

171 
ich_f‹˚_íabÀ_h≥t
);

172 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_7
,

173 
ich_f‹˚_íabÀ_h≥t
);

174 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x3a16,

175 
ich_f‹˚_íabÀ_h≥t
);

177 
pci_dev
 *
	gˇched_dev
;

179 
	$h≥t_¥öt_f‹˚_öfo
()

181 
	`¥ötk
(
KERN_INFO
 "HPETÇotÉnabled in BIOS. "

183 
	}
}

185 
	$ﬁd_ich_f‹˚_h≥t_ªsume
()

187 
u32
 
vÆ
;

188 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

190 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

193 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

194 
gí_˙é
 &= (~(0x7 << 15));

195 
gí_˙é
 |= (0x4 << 15);

197 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, 
gí_˙é
);

198 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0xD0, &
gí_˙é
);

199 
vÆ
 = 
gí_˙é
 >> 15;

200 
vÆ
 &= 0x7;

201 i‡(
vÆ
 == 0x4)

202 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

204 
	`BUG
();

205 
	}
}

207 
	$ﬁd_ich_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

209 
u32
 
vÆ
;

210 
u32
 
	`unöôülized_v¨
(
gí_˙é
);

212 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

215 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

220 
vÆ
 = 
gí_˙é
 >> 15;

221 
vÆ
 &= 0x7;

222 i‡(
vÆ
 & 0x4) {

223 
vÆ
 &= 0x3;

224 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

225 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

226 
f‹˚_h≥t_addªss
);

234 
gí_˙é
 &= (~(0x7 << 15));

235 
gí_˙é
 |= (0x4 << 15);

236 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0xD0, 
gí_˙é
);

238 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0xD0, &
gí_˙é
);

240 
vÆ
 = 
gí_˙é
 >> 15;

241 
vÆ
 &= 0x7;

242 i‡(
vÆ
 & 0x4) {

244 
vÆ
 &= 0x3;

245 
f‹˚_h≥t_addªss
 = 0xFED00000 | (
vÆ
 << 12);

246 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

247 "0x%lx\n", 
f‹˚_h≥t_addªss
);

248 
ˇched_dev
 = 
dev
;

249 
f‹˚_h≥t_ªsume_ty≥
 = 
OLD_ICH_FORCE_HPET_RESUME
;

253 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

254 
	}
}

260 
	$ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
(
pci_dev
 *
dev
)

262 i‡(
h≥t_f‹˚_u£r
)

263 
	`ﬁd_ich_f‹˚_íabÀ_h≥t
(
dev
);

264 
	}
}

266 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ESB_1
,

267 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

268 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_0
,

269 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

270 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801CA_12
,

271 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

272 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_0
,

273 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

274 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801DB_12
,

275 
ﬁd_ich_f‹˚_íabÀ_h≥t_u£r
);

276 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_0
,

277 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

278 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82801EB_12
,

279 
ﬁd_ich_f‹˚_íabÀ_h≥t
);

282 
	$vt8237_f‹˚_h≥t_ªsume
()

284 
u32
 
vÆ
;

286 i‡(!
f‹˚_h≥t_addªss
 || !
ˇched_dev
)

289 
vÆ
 = 0xfed00000 | 0x80;

290 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, 
vÆ
);

292 
	`pci_ªad_c⁄fig_dw‹d
(
ˇched_dev
, 0x68, &
vÆ
);

293 i‡(
vÆ
 & 0x80)

294 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

296 
	`BUG
();

297 
	}
}

299 
	$vt8237_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

301 
u32
 
	`unöôülized_v¨
(
vÆ
);

303 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

306 i‡(!
h≥t_f‹˚_u£r
) {

307 
	`h≥t_¥öt_f‹˚_öfo
();

311 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

316 i‡(
vÆ
 & 0x80) {

317 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

318 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "HPETát 0x%lx\n",

319 
f‹˚_h≥t_addªss
);

327 
vÆ
 = 0xfed00000 | 0x80;

328 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x68, 
vÆ
);

330 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x68, &
vÆ
);

331 i‡(
vÆ
 & 0x80) {

332 
f‹˚_h≥t_addªss
 = (
vÆ
 & ~0x3ff);

333 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát "

334 "0x%lx\n", 
f‹˚_h≥t_addªss
);

335 
ˇched_dev
 = 
dev
;

336 
f‹˚_h≥t_ªsume_ty≥
 = 
VT8237_FORCE_HPET_RESUME
;

340 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "FailedÅo forceÉnable HPET\n");

341 
	}
}

343 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8235
,

344 
vt8237_f‹˚_íabÀ_h≥t
);

345 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_8237
,

346 
vt8237_f‹˚_íabÀ_h≥t
);

348 
	$©i_f‹˚_h≥t_ªsume
()

350 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x14, 0xfed00000);

351 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

352 
	}
}

354 
u32
 
	$©i_ixp4x0_ªv
(
pci_dev
 *
dev
)

356 
u32
 
d
;

357 
u8
 
b
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 0xac, &
b
);

360 
b
 &= ~(1<<5);

361 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0xac, 
b
);

362 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x70, &
d
);

363 
d
 |= 1<<8;

364 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x70, 
d
);

365 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x8, &
d
);

366 
d
 &= 0xff;

367 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "SB4X0Ñevisi⁄ 0x%x\n", 
d
);

368  
d
;

369 
	}
}

371 
	$©i_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

373 
u32
 
d
, 
vÆ
;

374 
u8
 
b
;

376 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

379 i‡(!
h≥t_f‹˚_u£r
) {

380 
	`h≥t_¥öt_f‹˚_öfo
();

384 
d
 = 
	`©i_ixp4x0_ªv
(
dev
);

385 i‡(
d
 < 0x82)

389 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x14, 0xfed00000);

390 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x14, &
vÆ
);

393 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

394 
b
 |= 0x1;

395 
	`outb
(0x72, 0xcd6); outb(
b
, 0xcd7);

396 
	`outb
(0x72, 0xcd6); 
b
 = 
	`öb
(0xcd7);

397 i‡(!(
b
 & 0x1))

399 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

400 
d
 |= (1<<10);

401 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x64, 
d
);

402 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x64, &
d
);

403 i‡(!(
d
 & (1<<10)))

406 
f‹˚_h≥t_addªss
 = 
vÆ
;

407 
f‹˚_h≥t_ªsume_ty≥
 = 
ATI_FORCE_HPET_RESUME
;

408 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

409 
f‹˚_h≥t_addªss
);

410 
ˇched_dev
 = 
dev
;

411 
	}
}

412 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_IXP400_SMBUS
,

413 
©i_f‹˚_íabÀ_h≥t
);

418 
	$nvidü_f‹˚_h≥t_ªsume
()

420 
	`pci_wrôe_c⁄fig_dw‹d
(
ˇched_dev
, 0x44, 0xfed00001);

421 
	`¥ötk
(
KERN_DEBUG
 "ForceÉnabled HPETátÑesume\n");

422 
	}
}

424 
	$nvidü_f‹˚_íabÀ_h≥t
(
pci_dev
 *
dev
)

426 
u32
 
	`unöôülized_v¨
(
vÆ
);

428 i‡(
h≥t_addªss
 || 
f‹˚_h≥t_addªss
)

431 i‡(!
h≥t_f‹˚_u£r
) {

432 
	`h≥t_¥öt_f‹˚_öfo
();

436 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x44, 0xfed00001);

437 
	`pci_ªad_c⁄fig_dw‹d
(
dev
, 0x44, &
vÆ
);

438 
f‹˚_h≥t_addªss
 = 
vÆ
 & 0xfffffffe;

439 
f‹˚_h≥t_ªsume_ty≥
 = 
NVIDIA_FORCE_HPET_RESUME
;

440 
	`dev_¥ötk
(
KERN_DEBUG
, &
dev
->dev, "ForceÉnabled HPETát 0x%lx\n",

441 
f‹˚_h≥t_addªss
);

442 
ˇched_dev
 = 
dev
;

444 
	}
}

447 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0050,

448 
nvidü_f‹˚_íabÀ_h≥t
);

449 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0051,

450 
nvidü_f‹˚_íabÀ_h≥t
);

453 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0260,

454 
nvidü_f‹˚_íabÀ_h≥t
);

455 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0360,

456 
nvidü_f‹˚_íabÀ_h≥t
);

457 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0361,

458 
nvidü_f‹˚_íabÀ_h≥t
);

459 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0362,

460 
nvidü_f‹˚_íabÀ_h≥t
);

461 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0363,

462 
nvidü_f‹˚_íabÀ_h≥t
);

463 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0364,

464 
nvidü_f‹˚_íabÀ_h≥t
);

465 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0365,

466 
nvidü_f‹˚_íabÀ_h≥t
);

467 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0366,

468 
nvidü_f‹˚_íabÀ_h≥t
);

469 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_NVIDIA
, 0x0367,

470 
nvidü_f‹˚_íabÀ_h≥t
);

472 
	$f‹˚_h≥t_ªsume
()

474 
f‹˚_h≥t_ªsume_ty≥
) {

475 
ICH_FORCE_HPET_RESUME
:

476 
	`ich_f‹˚_h≥t_ªsume
();

478 
OLD_ICH_FORCE_HPET_RESUME
:

479 
	`ﬁd_ich_f‹˚_h≥t_ªsume
();

481 
VT8237_FORCE_HPET_RESUME
:

482 
	`vt8237_f‹˚_h≥t_ªsume
();

484 
NVIDIA_FORCE_HPET_RESUME
:

485 
	`nvidü_f‹˚_h≥t_ªsume
();

487 
ATI_FORCE_HPET_RESUME
:

488 
	`©i_f‹˚_h≥t_ªsume
();

493 
	}
}

502 
	$f‹˚_dißbÀ_h≥t_msi
(
pci_dev
 *
unu£d
)

504 
h≥t_msi_dißbÀ
 = 1;

505 
	}
}

507 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_ATI
, 
PCI_DEVICE_ID_ATI_SBX00_SMBUS
,

508 
f‹˚_dißbÀ_h≥t_msi
);

512 #i‡
deföed
(
CONFIG_PCI
Ë&& deföed(
CONFIG_NUMA
)

514 
__öô
 
	$quúk_amd_nb_node
(
pci_dev
 *
dev
)

516 
pci_dev
 *
nb_ht
;

517 
dev‚
;

518 
u32
 
node
;

519 
u32
 
vÆ
;

521 
dev‚
 = 
	`PCI_DEVFN
(
	`PCI_SLOT
(
dev
->devfn), 0);

522 
nb_ht
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, 
dev‚
);

523 i‡(!
nb_ht
)

526 
	`pci_ªad_c⁄fig_dw‹d
(
nb_ht
, 0x60, &
vÆ
);

527 
node
 = 
vÆ
 & 7;

532 i‡(
	`node_⁄löe
(
node
))

533 
	`£t_dev_node
(&
dev
->dev, 
node
);

534 
	`pci_dev_put
(
nb_ht
);

535 
	}
}

537 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB
,

538 
quúk_amd_nb_node
);

539 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
,

540 
quúk_amd_nb_node
);

541 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
,

542 
quúk_amd_nb_node
);

543 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_K8_NB_MISC
,

544 
quúk_amd_nb_node
);

545 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_HT
,

546 
quúk_amd_nb_node
);

547 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MAP
,

548 
quúk_amd_nb_node
);

549 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_DRAM
,

550 
quúk_amd_nb_node
);

551 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_MISC
,

552 
quúk_amd_nb_node
);

553 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_AMD
, 
PCI_DEVICE_ID_AMD_10H_NB_LINK
,

554 
quúk_amd_nb_node
);

	@/cmpt816/linux/arch/x86/kernel/reboot.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ªboŸ.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/pm.h
>

5 
	~<löux/efi.h
>

6 
	~<löux/dmi.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/tboŸ.h
>

9 
	~<a˝i/ªboŸ.h
>

10 
	~<asm/io.h
>

11 
	~<asm/≠ic.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/h≥t.h
>

14 
	~<asm/pgèbÀ.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/ªboŸ_fixups.h
>

17 
	~<asm/ªboŸ.h
>

18 
	~<asm/pci_x86.h
>

19 
	~<asm/vúãxt.h
>

20 
	~<asm/˝u.h
>

22 #ifde‡
CONFIG_X86_32


23 
	~<löux/˘y≥.h
>

24 
	~<löux/mc146818πc.h
>

26 
	~<asm/x86_öô.h
>

32 (*
pm_powî_off
)();

33 
	`EXPORT_SYMBOL
(
pm_powî_off
);

35 c⁄° 
desc_±r
 
no_idt
 = {
	}
};

36 
	gªboŸ_mode
;

37 
ªboŸ_ty≥
 
	gªboŸ_ty≥
 = 
BOOT_KBD
;

38 
	gªboŸ_f‹˚
;

40 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_SMP
)

41 
	gªboŸ_˝u
 = -1;

48 
	gªboŸ_emîgícy
;

51 
boﬁ
 
	gp‹t_cf9_ß„
 = 
Ál£
;

65 
__öô
 
	$ªboŸ_£tup
(*
°r
)

68 *
°r
) {

70 
ªboŸ_mode
 = 0x1234;

74 
ªboŸ_mode
 = 0;

77 #ifde‡
CONFIG_X86_32


78 #ifde‡
CONFIG_SMP


80 i‡(
	`isdigô
(*(
°r
+1))) {

81 
ªboŸ_˝u
 = (Ë(*(
°r
+1) - '0');

82 i‡(
	`isdigô
(*(
°r
+2)))

83 
ªboŸ_˝u
 =ÑeboŸ_˝u*10 + ()(*(
°r
+2) - '0');

98 
ªboŸ_ty≥
 = *
°r
;

102 
ªboŸ_f‹˚
 = 1;

106 
°r
 = 
	`°rchr
(str, ',');

107 i‡(
°r
)

108 
°r
++;

113 
	}
}

115 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

118 #ifde‡
CONFIG_X86_32


128 
__öô
 
	$£t_bios_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

130 i‡(
ªboŸ_ty≥
 !
BOOT_BIOS
) {

131 
ªboŸ_ty≥
 = 
BOOT_BIOS
;

132 
	`¥ötk
(
KERN_INFO
 "%†£rõ†bﬂrd dëe˘ed. Sñe˘ög BIOS-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

135 
	}
}

137 
dmi_sy°em_id
 
__öôd©a
 
	gªboŸ_dmi_èbÀ
[] = {

139 .
ˇŒback
 = 
£t_bios_ªboŸ
,

140 .
	gidít
 = "Dell E520",

141 .
	gm©ches
 = {

142 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

143 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DM061"),

147 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

148 .
	gidít
 = "Dell PowerEdge 1300",

149 .
	gm©ches
 = {

150 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

151 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

155 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

156 .
	gidít
 = "Dell PowerEdge 300",

157 .
	gm©ches
 = {

158 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

159 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

163 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

164 .
	gidít
 = "Dell OptiPlex 745",

165 .
	gm©ches
 = {

166 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

167 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

171 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

172 .
	gidít
 = "Dell OptiPlex 745",

173 .
	gm©ches
 = {

174 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

175 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

176 
DMI_MATCH
(
DMI_BOARD_NAME
, "0MM599"),

180 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

181 .
	gidít
 = "Dell OptiPlex 745",

182 .
	gm©ches
 = {

183 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

184 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 745"),

185 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KW626"),

189 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

190 .
	gidít
 = "Dell OptiPlex 330",

191 .
	gm©ches
 = {

192 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

193 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 330"),

194 
DMI_MATCH
(
DMI_BOARD_NAME
, "0KP561"),

198 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

199 .
	gidít
 = "Dell OptiPlex 360",

200 .
	gm©ches
 = {

201 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

202 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 360"),

203 
DMI_MATCH
(
DMI_BOARD_NAME
, "0T656F"),

207 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

208 .
	gidít
 = "Dell OptiPlex 760",

209 .
	gm©ches
 = {

210 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

211 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "OptiPlex 760"),

212 
DMI_MATCH
(
DMI_BOARD_NAME
, "0G919G"),

216 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

217 .
	gidít
 = "Dell PowerEdge 2400",

218 .
	gm©ches
 = {

219 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

220 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

224 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

225 .
	gidít
 = "Dell Precision T5400",

226 .
	gm©ches
 = {

227 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

228 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T5400"),

232 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

233 .
	gidít
 = "Dell Precision T7400",

234 .
	gm©ches
 = {

235 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

236 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Precision WorkStation T7400"),

240 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

241 .
	gidít
 = "HP Compaq Laptop",

242 .
	gm©ches
 = {

243 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

244 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

248 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

249 .
	gidít
 = "Dell XPS710",

250 .
	gm©ches
 = {

251 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

252 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell XPS710"),

256 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

257 .
	gidít
 = "Dell DXP061",

258 .
	gm©ches
 = {

259 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Inc."),

260 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Dell DXP061"),

264 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

265 .
	gidít
 = "Sony VGN-Z540N",

266 .
	gm©ches
 = {

267 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sony Corporation"),

268 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "VGN-Z540N"),

272 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

273 .
	gidít
 = "CompuLab SBC-FITPC2",

274 .
	gm©ches
 = {

275 
DMI_MATCH
(
DMI_SYS_VENDOR
, "CompuLab"),

276 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "SBC-FITPC2"),

280 .
	gˇŒback
 = 
£t_bios_ªboŸ
,

281 .
	gidít
 = "ASUS P4S800",

282 .
	gm©ches
 = {

283 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

284 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4S800"),

290 
__öô
 
	$ªboŸ_öô
()

292 
	`dmi_check_sy°em
(
ªboŸ_dmi_èbÀ
);

294 
	}
}

295 
c‹e_öôˇŒ
(
ªboŸ_öô
);

304 
	gªÆ_mode_gdt_íåõs
 [3] =

311 c⁄° 
desc_±r


312 
	gªÆ_mode_gdt
 = {  (
ªÆ_mode_gdt_íåõs
) - 1, ()real_mode_gdt_entries },

313 
	gªÆ_mode_idt
 = { 0x3ff, 0 };

333 c⁄° 
	gªÆ_mode_swôch
 [] =

347 c⁄° 
	gjump_to_bios
 [] =

357 
	$machöe_ªÆ_ª°¨t
(c⁄° *
code
, 
Àngth
)

359 
	`loˇl_úq_dißbÀ
();

370 
	`•ö_lock
(&
πc_lock
);

371 
	`CMOS_WRITE
(0x00, 0x8f);

372 
	`•ö_u∆ock
(&
πc_lock
);

377 
	`mem˝y
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

378 (
sw≠≥r_pg_dú
 [0]Ë* 
KERNEL_PGD_PTRS
);

383 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

390 *((*)0x472Ë
ªboŸ_mode
;

397 
	`mem˝y
((*)(0x1000 - (
ªÆ_mode_swôch
) - 100),

398 
ªÆ_mode_swôch
,  (real_mode_switch));

399 
	`mem˝y
((*)(0x1000 - 100), 
code
, 
Àngth
);

402 
	`lﬂd_idt
(&
ªÆ_mode_idt
);

407 
	`lﬂd_gdt
(&
ªÆ_mode_gdt
);

414 
__asm__
 
	`__vﬁ©ûe__
 ("movl $0x0010,%%eax\n"

424 
__asm__
 
	`__vﬁ©ûe__
 ("ljmp $0x0008,%0"

426 : "i" ((*)(0x1000 -  (
ªÆ_mode_swôch
) - 100)));

427 
	}
}

428 #ifde‡
CONFIG_APM_MODULE


429 
EXPORT_SYMBOL
(
machöe_ªÆ_ª°¨t
);

437 
__öô
 
	$£t_pci_ªboŸ
(c⁄° 
dmi_sy°em_id
 *
d
)

439 i‡(
ªboŸ_ty≥
 !
BOOT_CF9
) {

440 
ªboŸ_ty≥
 = 
BOOT_CF9
;

441 
	`¥ötk
(
KERN_INFO
 "%s series board detected. "

442 "Sñe˘ög PCI-mëhod f‹ÑeboŸs.\n", 
d
->
idít
);

445 
	}
}

447 
dmi_sy°em_id
 
__öôd©a
 
	gpci_ªboŸ_dmi_èbÀ
[] = {

449 .
ˇŒback
 = 
£t_pci_ªboŸ
,

450 .
	gidít
 = "Apple MacBook5",

451 .
	gm©ches
 = {

452 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

453 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBook5"),

457 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

458 .
	gidít
 = "Apple MacBookPro5",

459 .
	gm©ches
 = {

460 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

461 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "MacBookPro5"),

465 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

466 .
	gidít
 = "Apple Macmini3,1",

467 .
	gm©ches
 = {

468 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

469 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Macmini3,1"),

473 .
	gˇŒback
 = 
£t_pci_ªboŸ
,

474 .
	gidít
 = "Apple iMac9,1",

475 .
	gm©ches
 = {

476 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Apple Inc."),

477 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "iMac9,1"),

483 
__öô
 
	$pci_ªboŸ_öô
()

485 
	`dmi_check_sy°em
(
pci_ªboŸ_dmi_èbÀ
);

487 
	}
}

488 
c‹e_öôˇŒ
(
pci_ªboŸ_öô
);

490 
ölöe
 
	$kb_waô
()

492 
i
;

494 
i
 = 0; i < 0x10000; i++) {

495 i‡((
	`öb
(0x64) & 0x02) == 0)

497 
	`udñay
(2);

499 
	}
}

501 
	$vmxoff_nmi
(
˝u
, 
dõ_¨gs
 *
¨gs
)

503 
	`˝u_emîgícy_vmxoff
();

504 
	}
}

508 
	$emîgícy_vmx_dißbÀ_Æl
()

511 
	`loˇl_úq_dißbÀ
();

531 i‡(
	`˝u_has_vmx
(Ë&& 
	`˝u_vmx_íabÀd
()) {

534 
	`˝u_vmxoff
();

537 
	`nmi_shoŸdown_˝us
(
vmxoff_nmi
);

540 
	}
}

543 
__©åibuã__
((
wók
)Ë
	$mach_ªboŸ_fixups
()

545 
	}
}

547 
	$«tive_machöe_emîgícy_ª°¨t
()

549 
i
;

551 i‡(
ªboŸ_emîgícy
)

552 
	`emîgícy_vmx_dißbÀ_Æl
();

554 
	`tboŸ_shutdown
(
TB_SHUTDOWN_REBOOT
);

557 *((*)
	`__va
(0x472)Ë
ªboŸ_mode
;

561 
ªboŸ_ty≥
) {

562 
BOOT_KBD
:

563 
	`mach_ªboŸ_fixups
();

565 
i
 = 0; i < 10; i++) {

566 
	`kb_waô
();

567 
	`udñay
(50);

568 
	`outb
(0xfe, 0x64);

569 
	`udñay
(50);

572 
BOOT_TRIPLE
:

573 
	`lﬂd_idt
(&
no_idt
);

574 
__asm__
 
	`__vﬁ©ûe__
("int3");

576 
ªboŸ_ty≥
 = 
BOOT_KBD
;

579 #ifde‡
CONFIG_X86_32


580 
BOOT_BIOS
:

581 
	`machöe_ªÆ_ª°¨t
(
jump_to_bios
, (jump_to_bios));

583 
ªboŸ_ty≥
 = 
BOOT_KBD
;

587 
BOOT_ACPI
:

588 
	`a˝i_ªboŸ
();

589 
ªboŸ_ty≥
 = 
BOOT_KBD
;

592 
BOOT_EFI
:

593 i‡(
efi_íabÀd
)

594 
efi
.
	`ª£t_sy°em
(
ªboŸ_mode
 ?

595 
EFI_RESET_WARM
 :

596 
EFI_RESET_COLD
,

597 
EFI_SUCCESS
, 0, 
NULL
);

598 
ªboŸ_ty≥
 = 
BOOT_KBD
;

601 
BOOT_CF9
:

602 
p‹t_cf9_ß„
 = 
åue
;

605 
BOOT_CF9_COND
:

606 i‡(
p‹t_cf9_ß„
) {

607 
u8
 
cf9
 = 
	`öb
(0xcf9) & ~6;

608 
	`outb
(
cf9
|2, 0xcf9);

609 
	`udñay
(50);

610 
	`outb
(
cf9
|6, 0xcf9);

611 
	`udñay
(50);

613 
ªboŸ_ty≥
 = 
BOOT_KBD
;

617 
	}
}

619 
	$«tive_machöe_shutdown
()

622 #ifde‡
CONFIG_SMP


625 
ªboŸ_˝u_id
 = 0;

627 #ifde‡
CONFIG_X86_32


629 i‡((
ªboŸ_˝u
 !-1Ë&& (ªboŸ_˝u < 
ƒ_˝u_ids
) &&

630 
	`˝u_⁄löe
(
ªboŸ_˝u
))

631 
ªboŸ_˝u_id
 = 
ªboŸ_˝u
;

635 i‡(!
	`˝u_⁄löe
(
ªboŸ_˝u_id
))

636 
ªboŸ_˝u_id
 = 
	`smp_¥o˚ss‹_id
();

639 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
	`˝umask_of
(
ªboŸ_˝u_id
));

644 
	`smp_£nd_°›
();

647 
	`œpic_shutdown
();

649 #ifde‡
CONFIG_X86_IO_APIC


650 
	`dißbÀ_IO_APIC
();

653 #ifde‡
CONFIG_HPET_TIMER


654 
	`h≥t_dißbÀ
();

657 #ifde‡
CONFIG_X86_64


658 
x86_∂©f‹m
.
	`iommu_shutdown
();

660 
	}
}

662 
	$__machöe_emîgícy_ª°¨t
(
emîgícy
)

664 
ªboŸ_emîgícy
 = 
emîgícy
;

665 
machöe_›s
.
	`emîgícy_ª°¨t
();

666 
	}
}

668 
	$«tive_machöe_ª°¨t
(*
__unu£d
)

670 
	`¥ötk
("machineÑestart\n");

672 i‡(!
ªboŸ_f‹˚
)

673 
	`machöe_shutdown
();

674 
	`__machöe_emîgícy_ª°¨t
(0);

675 
	}
}

677 
	$«tive_machöe_hÆt
()

680 
	`machöe_shutdown
();

682 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

685 
	`°›_this_˝u
(
NULL
);

686 
	}
}

688 
	$«tive_machöe_powî_off
()

690 i‡(
pm_powî_off
) {

691 i‡(!
ªboŸ_f‹˚
)

692 
	`machöe_shutdown
();

693 
	`pm_powî_off
();

696 
	`tboŸ_shutdown
(
TB_SHUTDOWN_HALT
);

697 
	}
}

699 
machöe_›s
 
	gmachöe_›s
 = {

700 .
powî_off
 = 
«tive_machöe_powî_off
,

701 .
	gshutdown
 = 
«tive_machöe_shutdown
,

702 .
	gemîgícy_ª°¨t
 = 
«tive_machöe_emîgícy_ª°¨t
,

703 .
	gª°¨t
 = 
«tive_machöe_ª°¨t
,

704 .
	ghÆt
 = 
«tive_machöe_hÆt
,

705 #ifde‡
CONFIG_KEXEC


706 .
	g¸ash_shutdown
 = 
«tive_machöe_¸ash_shutdown
,

710 
	$machöe_powî_off
()

712 
machöe_›s
.
	`powî_off
();

713 
	}
}

715 
	$machöe_shutdown
()

717 
machöe_›s
.
	`shutdown
();

718 
	}
}

720 
	$machöe_emîgícy_ª°¨t
()

722 
	`__machöe_emîgícy_ª°¨t
(1);

723 
	}
}

725 
	$machöe_ª°¨t
(*
cmd
)

727 
machöe_›s
.
	`ª°¨t
(
cmd
);

728 
	}
}

730 
	$machöe_hÆt
()

732 
machöe_›s
.
	`hÆt
();

733 
	}
}

735 #ifde‡
CONFIG_KEXEC


736 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

738 
machöe_›s
.
	`¸ash_shutdown
(
ªgs
);

739 
	}
}

743 #i‡
deföed
(
CONFIG_SMP
)

746 
	g¸ashög_˝u
;

747 
nmi_shoŸdown_cb
 
	gshoŸdown_ˇŒback
;

749 
©omic_t
 
	gwaôög_f‹_¸ash_ùi
;

751 
	$¸ash_nmi_ˇŒback
(
nŸifõr_block
 *
£lf
,

752 
vÆ
, *
d©a
)

754 
˝u
;

756 i‡(
vÆ
 !
DIE_NMI_IPI
)

757  
NOTIFY_OK
;

759 
˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

765 i‡(
˝u
 =
¸ashög_˝u
)

766  
NOTIFY_STOP
;

767 
	`loˇl_úq_dißbÀ
();

769 
	`shoŸdown_ˇŒback
(
˝u
, (
dõ_¨gs
 *)
d©a
);

771 
	`©omic_dec
(&
waôög_f‹_¸ash_ùi
);

773 
	`hÆt
();

775 
	`˝u_ªœx
();

778 
	}
}

780 
	$smp_£nd_nmi_Ælbut£lf
()

782 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
NMI_VECTOR
);

783 
	}
}

785 
nŸifõr_block
 
	g¸ash_nmi_nb
 = {

786 .
nŸifõr_ˇŒ
 = 
¸ash_nmi_ˇŒback
,

795 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

797 
m£cs
;

798 
	`loˇl_úq_dißbÀ
();

801 
¸ashög_˝u
 = 
	`ß„_smp_¥o˚ss‹_id
();

803 
shoŸdown_ˇŒback
 = 
ˇŒback
;

805 
	`©omic_£t
(&
waôög_f‹_¸ash_ùi
, 
	`num_⁄löe_˝us
() - 1);

807 i‡(
	`ªgi°î_dõ_nŸifõr
(&
¸ash_nmi_nb
))

812 
	`wmb
();

814 
	`smp_£nd_nmi_Ælbut£lf
();

816 
m£cs
 = 1000;

817 (
	`©omic_ªad
(&
waôög_f‹_¸ash_ùi
Ë> 0Ë&& 
m£cs
) {

818 
	`mdñay
(1);

819 
m£cs
--;

823 
	}
}

825 
	$nmi_shoŸdown_˝us
(
nmi_shoŸdown_cb
 
ˇŒback
)

828 
	}
}

	@/cmpt816/linux/arch/x86/kernel/rtc.c

4 
	~<löux/∂©f‹m_devi˚.h
>

5 
	~<löux/mc146818πc.h
>

6 
	~<löux/a˝i.h
>

7 
	~<löux/bcd.h
>

8 
	~<löux/≤p.h
>

10 
	~<asm/vsysˇŒ.h
>

11 
	~<asm/x86_öô.h
>

12 
	~<asm/time.h
>

14 #ifde‡
CONFIG_X86_32


20 vﬁ©ûê
	gcmos_lock
;

21 
EXPORT_SYMBOL
(
cmos_lock
);

25 
	#CMOS_YEARS_OFFS
 2000

	)

27 
DEFINE_SPINLOCK
(
πc_lock
);

28 
EXPORT_SYMBOL
(
πc_lock
);

40 
	$mach_£t_πc_mmss
(
nowtime
)

42 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

43 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

44 
ªtvÆ
 = 0;

47 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

48 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

51 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

52 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

54 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

55 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

56 
cmos_möuãs
 = 
	`bcd2bö
(cmos_minutes);

64 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

65 
ªÆ_möuãs
 = 
nowtime
 / 60;

67 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

68 
ªÆ_möuãs
 += 30;

69 
ªÆ_möuãs
 %= 60;

71 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

72 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

73 
ªÆ_£c⁄ds
 = 
	`bö2bcd
(real_seconds);

74 
ªÆ_möuãs
 = 
	`bö2bcd
(real_minutes);

76 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
, 
RTC_SECONDS
);

77 
	`CMOS_WRITE
(
ªÆ_möuãs
, 
RTC_MINUTES
);

79 
	`¥ötk
(
KERN_WARNING


81 
cmos_möuãs
, 
ªÆ_möuãs
);

82 
ªtvÆ
 = -1;

92 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

93 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

95  
ªtvÆ
;

96 
	}
}

98 
	$mach_gë_cmos_time
()

100 
°©us
, 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
˚¡ury
 = 0;

108 (
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
))

109 
	`˝u_ªœx
();

111 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

112 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

113 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

114 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

115 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

116 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

118 #ifde‡
CONFIG_ACPI


119 i‡(
a˝i_gbl_FADT
.
hódî
.
ªvisi⁄
 >
FADT2_REVISION_ID
 &&

120 
a˝i_gbl_FADT
.
˚¡ury
)

121 
˚¡ury
 = 
	`CMOS_READ
(
a˝i_gbl_FADT
.century);

124 
°©us
 = 
	`CMOS_READ
(
RTC_CONTROL
);

125 
	`WARN_ON_ONCE
(
RTC_ALWAYS_BCD
 && (
°©us
 & 
RTC_DM_BINARY
));

127 i‡(
RTC_ALWAYS_BCD
 || !(
°©us
 & 
RTC_DM_BINARY
)) {

128 
£c
 = 
	`bcd2bö
(sec);

129 
mö
 = 
	`bcd2bö
(min);

130 
hour
 = 
	`bcd2bö
(hour);

131 
day
 = 
	`bcd2bö
(day);

132 
m⁄
 = 
	`bcd2bö
(mon);

133 
yór
 = 
	`bcd2bö
(year);

136 i‡(
˚¡ury
) {

137 
˚¡ury
 = 
	`bcd2bö
(century);

138 
yór
 +
˚¡ury
 * 100;

139 
	`¥ötk
(
KERN_INFO
 "Exãnded CMOS yór: %d\n", 
˚¡ury
 * 100);

141 
yór
 +
CMOS_YEARS_OFFS
;

143  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

144 
	}
}

147 
	$πc_cmos_ªad
(
addr
)

149 
vÆ
;

151 
	`lock_cmos_¥efix
(
addr
);

152 
	`outb
(
addr
, 
	`RTC_PORT
(0));

153 
vÆ
 = 
	`öb
(
	`RTC_PORT
(1));

154 
	`lock_cmos_suffix
(
addr
);

156  
vÆ
;

157 
	}
}

158 
EXPORT_SYMBOL
(
πc_cmos_ªad
);

160 
	$πc_cmos_wrôe
(
vÆ
, 
addr
)

162 
	`lock_cmos_¥efix
(
addr
);

163 
	`outb
(
addr
, 
	`RTC_PORT
(0));

164 
	`outb
(
vÆ
, 
	`RTC_PORT
(1));

165 
	`lock_cmos_suffix
(
addr
);

166 
	}
}

167 
EXPORT_SYMBOL
(
πc_cmos_wrôe
);

169 
	$upd©e_≥rsi°ít_˛ock
(
time•ec
 
now
)

171 
Êags
;

172 
ªtvÆ
;

174 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

175 
ªtvÆ
 = 
x86_∂©f‹m
.
	`£t_wÆl˛ock
(
now
.
tv_£c
);

176 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

178  
ªtvÆ
;

179 
	}
}

182 
	$ªad_≥rsi°ít_˛ock
(
time•ec
 *
ts
)

184 
ªtvÆ
, 
Êags
;

186 
	`•ö_lock_úqßve
(&
πc_lock
, 
Êags
);

187 
ªtvÆ
 = 
x86_∂©f‹m
.
	`gë_wÆl˛ock
();

188 
	`•ö_u∆ock_úqª°‹e
(&
πc_lock
, 
Êags
);

190 
ts
->
tv_£c
 = 
ªtvÆ
;

191 
ts
->
tv_n£c
 = 0;

192 
	}
}

194 
	$«tive_ªad_tsc
()

196  
	`__«tive_ªad_tsc
();

197 
	}
}

198 
EXPORT_SYMBOL
(
«tive_ªad_tsc
);

201 
ªsour˚
 
	gπc_ªsour˚s
[] = {

203 .
°¨t
 = 
RTC_PORT
(0),

204 .
	gíd
 = 
RTC_PORT
(1),

205 .
	gÊags
 = 
IORESOURCE_IO
,

208 .
°¨t
 = 
RTC_IRQ
,

209 .
	gíd
 = 
RTC_IRQ
,

210 .
	gÊags
 = 
IORESOURCE_IRQ
,

214 
∂©f‹m_devi˚
 
	gπc_devi˚
 = {

215 .
«me
 = "rtc_cmos",

216 .
	gid
 = -1,

217 .
	gªsour˚
 = 
πc_ªsour˚s
,

218 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

221 
__öô
 
	$add_πc_cmos
()

223 #ifde‡
CONFIG_PNP


224 c⁄° *
ids
[] 
__öôc⁄°
 =

226 
≤p_dev
 *
dev
;

227 
≤p_id
 *
id
;

228 
i
;

230 
	`≤p_f‹_óch_dev
(
dev
) {

231 
id
 = 
dev
->id; id; id = id->
√xt
) {

232 
i
 = 0; i < 
	`ARRAY_SIZE
(
ids
); i++) {

233 i‡(
	`com∑ª_≤p_id
(
id
, 
ids
[
i
]) != 0)

240 
	`∂©f‹m_devi˚_ªgi°î
(&
πc_devi˚
);

241 
	`dev_öfo
(&
πc_devi˚
.
dev
,

245 
	}
}

246 
devi˚_öôˇŒ
(
add_πc_cmos
);

	@/cmpt816/linux/arch/x86/kernel/setup.c

24 
	~<löux/sched.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/mmz⁄e.h
>

27 
	~<löux/s¸ìn_öfo.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/a˝i.h
>

30 
	~<löux/sfi.h
>

31 
	~<löux/≠m_bios.h
>

32 
	~<löux/öôrd.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/c⁄sﬁe.h
>

36 
	~<löux/mˇ.h
>

37 
	~<löux/roŸ_dev.h
>

38 
	~<löux/highmem.h
>

39 
	~<löux/moduÀ.h
>

40 
	~<löux/efi.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/edd.h
>

43 
	~<löux/iscsi_ib·.h
>

44 
	~<löux/nodemask.h
>

45 
	~<löux/kexec.h
>

46 
	~<löux/dmi.h
>

47 
	~<löux/p‚.h
>

48 
	~<löux/pci.h
>

49 
	~<asm/pci-dúe˘.h
>

50 
	~<löux/öô_ohci1394_dma.h
>

51 
	~<löux/kvm_∑ø.h
>

53 
	~<löux/î∫o.h
>

54 
	~<löux/kî√l.h
>

55 
	~<löux/°ddef.h
>

56 
	~<löux/uni°d.h
>

57 
	~<löux/±ø˚.h
>

58 
	~<löux/u£r.h
>

59 
	~<löux/dñay.h
>

61 
	~<löux/kÆlsyms.h
>

62 
	~<löux/˝u‰eq.h
>

63 
	~<löux/dma-m≠pög.h
>

64 
	~<löux/˘y≥.h
>

65 
	~<löux/uac˚ss.h
>

67 
	~<löux/≥r˝u.h
>

68 
	~<löux/¸ash_dump.h
>

69 
	~<löux/tboŸ.h
>

71 
	~<video/edid.h
>

73 
	~<asm/mår.h
>

74 
	~<asm/≠ic.h
>

75 
	~<asm/åampﬁöe.h
>

76 
	~<asm/e820.h
>

77 
	~<asm/mp•ec.h
>

78 
	~<asm/£tup.h
>

79 
	~<asm/efi.h
>

80 
	~<asm/timî.h
>

81 
	~<asm/i8259.h
>

82 
	~<asm/£˘i⁄s.h
>

83 
	~<asm/dmi.h
>

84 
	~<asm/io_≠ic.h
>

85 
	~<asm/i°.h
>

86 
	~<asm/vmi.h
>

87 
	~<asm/£tup_¨ch.h
>

88 
	~<asm/bios_ebda.h
>

89 
	~<asm/ˇcheÊush.h
>

90 
	~<asm/¥o˚ss‹.h
>

91 
	~<asm/bugs.h
>

93 
	~<asm/sy°em.h
>

94 
	~<asm/vsysˇŒ.h
>

95 
	~<asm/˝u.h
>

96 
	~<asm/desc.h
>

97 
	~<asm/dma.h
>

98 
	~<asm/iommu.h
>

99 
	~<asm/g¨t.h
>

100 
	~<asm/mmu_c⁄ãxt.h
>

101 
	~<asm/¥Ÿo.h
>

103 
	~<asm/∑øvút.h
>

104 
	~<asm/hy≥rvis‹.h
>

106 
	~<asm/≥r˝u.h
>

107 
	~<asm/t›ﬁogy.h
>

108 
	~<asm/≠icdef.h
>

109 
	~<asm/k8.h
>

110 #ifde‡
CONFIG_X86_64


111 
	~<asm/numa_64.h
>

113 
	~<asm/m˚.h
>

120 
	gmax_low_p‚_m≠≥d
;

121 
	gmax_p‚_m≠≥d
;

123 #ifde‡
CONFIG_DMI


124 
RESERVE_BRK
(
dmi_Æloc
, 65536);

127 
boŸ_˝u_id
 
	g__ªad_mo°ly
;

129 
__öôd©a
 
	g_brk_°¨t
 = ()
__brk_ba£
;

130 
	g_brk_íd
 = ()
__brk_ba£
;

132 #ifde‡
CONFIG_X86_64


133 
	$deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
)

135  
	`__deÁu…_˝u_¥e£¡_to_≠icid
(
mps_˝u
);

136 
	}
}

138 
	$deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
)

140  
	`__deÁu…_check_phys_≠icid_¥e£¡
(
phys_≠icid
);

141 
	}
}

144 #i‚de‡
CONFIG_DEBUG_BOOT_PARAMS


145 
boŸ_∑øms
 
__öôd©a
 
	gboŸ_∑øms
;

147 
boŸ_∑øms
 
	gboŸ_∑øms
;

153 
ªsour˚
 
	gd©a_ªsour˚
 = {

154 .
«me
 = "Kernel data",

155 .
	g°¨t
 = 0,

156 .
	gíd
 = 0,

157 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


160 
ªsour˚
 
	gcode_ªsour˚
 = {

161 .
«me
 = "Kernel code",

162 .
	g°¨t
 = 0,

163 .
	gíd
 = 0,

164 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


167 
ªsour˚
 
	gbss_ªsour˚
 = {

168 .
«me
 = "Kernel bss",

169 .
	g°¨t
 = 0,

170 .
	gíd
 = 0,

171 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


175 #ifde‡
CONFIG_X86_32


177 
˝uöfo_x86
 
√w_˝u_d©a
 
	g__˝uöôd©a
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

179 
˝uöfo_x86
 
boŸ_˝u_d©a
 
	g__ªad_mo°ly
 = {0, 0, 0, 0, -1, 1, 0, 0, -1};

180 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

181 
	$£t_mˇ_bus
(
x
)

183 #ifde‡
CONFIG_MCA


184 
MCA_bus
 = 
x
;

186 
	}
}

188 
	gdef_to_bigsmp
;

191 
	gmachöe_id
;

192 
	gmachöe_submodñ_id
;

193 
	gBIOS_ªvisi⁄
;

195 
≠m_öfo
 
	g≠m_öfo
;

196 
EXPORT_SYMBOL
(
≠m_öfo
);

198 #i‡
deföed
(
CONFIG_X86_SPEEDSTEP_SMI
) || \

199 
	$deföed
(
CONFIG_X86_SPEEDSTEP_SMI_MODULE
)

200 
i°_öfo
 ist_info;

201 
	`EXPORT_SYMBOL
(
i°_öfo
);

203 
i°_öfo
 ist_info;

207 
˝uöfo_x86
 
boŸ_˝u_d©a
 
__ªad_mo°ly
 = {

208 .
x86_phys_bôs
 = 
MAX_PHYSMEM_BITS
,

209 
	}
};

210 
EXPORT_SYMBOL
(
boŸ_˝u_d©a
);

214 #i‡!
deföed
(
CONFIG_X86_PAE
Ë|| deföed(
CONFIG_X86_64
)

215 
	gmmu_¸4_„©uªs
;

217 
	gmmu_¸4_„©uªs
 = 
X86_CR4_PAE
;

221 
	gboŸlﬂdî_ty≥
, 
	gboŸlﬂdî_vîsi⁄
;

226 
s¸ìn_öfo
 
	gs¸ìn_öfo
;

227 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

228 
edid_öfo
 
	gedid_öfo
;

229 
EXPORT_SYMBOL_GPL
(
edid_öfo
);

231 
roŸ_mou¡Êags
;

233 
	gßved_video_mode
;

235 
	#RAMDISK_IMAGE_START_MASK
 0x07FF

	)

236 
	#RAMDISK_PROMPT_FLAG
 0x8000

	)

237 
	#RAMDISK_LOAD_FLAG
 0x4000

	)

239 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

240 #ifde‡
CONFIG_CMDLINE_BOOL


241 
__öôd©a
 
	gbuûtö_cmdlöe
[
COMMAND_LINE_SIZE
] = 
CONFIG_CMDLINE
;

244 #i‡
deföed
(
CONFIG_EDD
Ë|| deföed(
CONFIG_EDD_MODULE
)

245 
edd
 
	gedd
;

246 #ifde‡
CONFIG_EDD_MODULE


247 
EXPORT_SYMBOL
(
edd
);

254 
ölöe
 
__öô
 
	$c›y_edd
()

256 
	`mem˝y
(
edd
.
mbr_sig«tuª
, 
boŸ_∑øms
.
edd_mbr_sig_buf„r
,

257 (
edd
.
mbr_sig«tuª
));

258 
	`mem˝y
(
edd
.
edd_öfo
, 
boŸ_∑øms
.
eddbuf
, (edd.edd_info));

259 
edd
.
mbr_sig«tuª_ƒ
 = 
boŸ_∑øms
.
edd_mbr_sig_buf_íåõs
;

260 
edd
.
edd_öfo_ƒ
 = 
boŸ_∑øms
.
eddbuf_íåõs
;

261 
	}
}

263 
ölöe
 
__öô
 
	$c›y_edd
()

265 
	}
}

268 * 
__öô
 
	$exãnd_brk
(
size_t
 
size
, size_à
Æign
)

270 
size_t
 
mask
 = 
Æign
 - 1;

271 *
ªt
;

273 
	`BUG_ON
(
_brk_°¨t
 == 0);

274 
	`BUG_ON
(
Æign
 & 
mask
);

276 
_brk_íd
 = (_brk_íd + 
mask
) & ~mask;

277 
	`BUG_ON
((*)(
_brk_íd
 + 
size
Ë> 
__brk_limô
);

279 
ªt
 = (*)
_brk_íd
;

280 
_brk_íd
 +
size
;

282 
	`mem£t
(
ªt
, 0, 
size
);

284  
ªt
;

285 
	}
}

287 #ifde‡
CONFIG_X86_64


288 
__öô
 
	$öô_gb∑ges
()

290 i‡(
dúe˘_gb∑ges
 && 
˝u_has_gb∑ges
)

291 
	`¥ötk
(
KERN_INFO
 "Using GBÖages for direct mapping\n");

293 
dúe˘_gb∑ges
 = 0;

294 
	}
}

296 
ölöe
 
	$öô_gb∑ges
()

298 
	}
}

301 
__öô
 
	$ª£rve_brk
()

303 i‡(
_brk_íd
 > 
_brk_°¨t
)

304 
	`ª£rve_óæy
(
	`__∑
(
_brk_°¨t
), __∑(
_brk_íd
), "BRK");

308 
_brk_°¨t
 = 0;

309 
	}
}

311 #ifde‡
CONFIG_BLK_DEV_INITRD


313 
	#MAX_MAP_CHUNK
 (
NR_FIX_BTMAPS
 << 
PAGE_SHIFT
)

	)

314 
__öô
 
	$ªloˇã_öôrd
()

317 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

318 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

319 
u64
 
¨ó_size
 = 
	`PAGE_ALIGN
(
ømdisk_size
);

320 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

321 
u64
 
ømdisk_hîe
;

322 
¶›
, 
˛í
, 
m≠addr
;

323 *
p
, *
q
;

326 
ømdisk_hîe
 = 
	`föd_e820_¨ó
(0, 
íd_of_lowmem
, 
¨ó_size
,

327 
PAGE_SIZE
);

329 i‡(
ømdisk_hîe
 == -1ULL)

330 
	`∑nic
("Cannot findÖlace forÇew RAMDISK of size %lld\n",

331 
ømdisk_size
);

335 
	`ª£rve_óæy
(
ømdisk_hîe
,Ñamdisk_hîê+ 
¨ó_size
,

337 
öôrd_°¨t
 = 
ømdisk_hîe
 + 
PAGE_OFFSET
;

338 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

339 
	`¥ötk
(
KERN_INFO
 "AllocatedÇew RAMDISK: %08llx - %08llx\n",

340 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
);

342 
q
 = (*)
öôrd_°¨t
;

345 i‡(
ømdisk_image
 < 
íd_of_lowmem
) {

346 
˛í
 = 
íd_of_lowmem
 - 
ømdisk_image
;

347 
p
 = (*)
	`__va
(
ømdisk_image
);

348 
	`mem˝y
(
q
, 
p
, 
˛í
);

349 
q
 +
˛í
;

350 
ømdisk_image
 +
˛í
;

351 
ømdisk_size
 -
˛í
;

355 
ømdisk_size
) {

356 
¶›
 = 
ømdisk_image
 & ~
PAGE_MASK
;

357 
˛í
 = 
ømdisk_size
;

358 i‡(
˛í
 > 
MAX_MAP_CHUNK
-
¶›
)

359 
˛í
 = 
MAX_MAP_CHUNK
-
¶›
;

360 
m≠addr
 = 
ømdisk_image
 & 
PAGE_MASK
;

361 
p
 = 
	`óæy_memªm≠
(
m≠addr
, 
˛í
+
¶›
);

362 
	`mem˝y
(
q
, 
p
+
¶›
, 
˛í
);

363 
	`óæy_iounm≠
(
p
, 
˛í
+
¶›
);

364 
q
 +
˛í
;

365 
ømdisk_image
 +
˛í
;

366 
ømdisk_size
 -
˛í
;

369 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

370 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

371 
	`¥ötk
(
KERN_INFO
 "Move RAMDISK from %016llx - %016llxÅo"

373 
ømdisk_image
,Ñamdisk_imagê+ 
ømdisk_size
 - 1,

374 
ømdisk_hîe
,Ñamdisk_hîê+ 
ømdisk_size
 - 1);

375 
	}
}

377 
__öô
 
	$ª£rve_öôrd
()

380 
u64
 
ømdisk_image
 = 
boŸ_∑øms
.
hdr
.ramdisk_image;

381 
u64
 
ømdisk_size
 = 
boŸ_∑øms
.
hdr
.ramdisk_size;

382 
u64
 
ømdisk_íd
 = 
	`PAGE_ALIGN
(
ømdisk_image
 + 
ømdisk_size
);

383 
u64
 
íd_of_lowmem
 = 
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
;

385 i‡(!
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
 ||

386 !
ømdisk_image
 || !
ømdisk_size
)

389 
öôrd_°¨t
 = 0;

391 i‡(
ømdisk_size
 >(
íd_of_lowmem
>>1)) {

392 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

393 
	`¥ötk
(
KERN_ERR
 "initrdÅooÜargeÅo handle, "

398 
	`¥ötk
(
KERN_INFO
 "RAMDISK: %08Œx - %08Œx\n", 
ømdisk_image
,

399 
ømdisk_íd
);

402 i‡(
ømdisk_íd
 <
íd_of_lowmem
) {

408 
öôrd_°¨t
 = 
ømdisk_image
 + 
PAGE_OFFSET
;

409 
öôrd_íd
 = 
öôrd_°¨t
 + 
ømdisk_size
;

413 
	`ªloˇã_öôrd
();

415 
	`‰ì_óæy
(
ømdisk_image
, 
ømdisk_íd
);

416 
	}
}

418 
__öô
 
	$ª£rve_öôrd
()

420 
	}
}

423 
__öô
 
	$∑r£_£tup_d©a
()

425 
£tup_d©a
 *
d©a
;

426 
u64
 
∑_d©a
;

428 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

430 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

431 
∑_d©a
) {

432 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, 
PAGE_SIZE
);

433 
d©a
->
ty≥
) {

434 
SETUP_E820_EXT
:

435 
	`∑r£_e820_ext
(
d©a
, 
∑_d©a
);

440 
∑_d©a
 = 
d©a
->
√xt
;

441 
	`óæy_iounm≠
(
d©a
, 
PAGE_SIZE
);

443 
	}
}

445 
__öô
 
	$e820_ª£rve_£tup_d©a
()

447 
£tup_d©a
 *
d©a
;

448 
u64
 
∑_d©a
;

449 
found
 = 0;

451 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

453 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

454 
∑_d©a
) {

455 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

456 
	`e820_upd©e_ønge
(
∑_d©a
, (*
d©a
)+d©a->
Àn
,

457 
E820_RAM
, 
E820_RESERVED_KERN
);

458 
found
 = 1;

459 
∑_d©a
 = 
d©a
->
√xt
;

460 
	`óæy_iounm≠
(
d©a
, (*data));

462 i‡(!
found
)

465 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

466 
	`mem˝y
(&
e820_ßved
, &
e820
, (
e820m≠
));

467 
	`¥ötk
(
KERN_INFO
 "extendedÖhysical RAM map:\n");

468 
	`e820_¥öt_m≠
("reserve setup_data");

469 
	}
}

471 
__öô
 
	$ª£rve_óæy_£tup_d©a
()

473 
£tup_d©a
 *
d©a
;

474 
u64
 
∑_d©a
;

475 
buf
[32];

477 i‡(
boŸ_∑øms
.
hdr
.
vîsi⁄
 < 0x0209)

479 
∑_d©a
 = 
boŸ_∑øms
.
hdr
.
£tup_d©a
;

480 
∑_d©a
) {

481 
d©a
 = 
	`óæy_memªm≠
(
∑_d©a
, (*data));

482 
	`•rötf
(
buf
, "£tu∞d©®%x", 
d©a
->
ty≥
);

483 
	`ª£rve_óæy
(
∑_d©a
,Öa_d©a+(*
d©a
)+d©a->
Àn
, 
buf
);

484 
∑_d©a
 = 
d©a
->
√xt
;

485 
	`óæy_iounm≠
(
d©a
, (*data));

487 
	}
}

493 #ifde‡
CONFIG_KEXEC


495 
ölöe
 
	$gë_tŸÆ_mem
()

497 
tŸÆ
;

499 
tŸÆ
 = 
max_p‚
 - 
mö_low_p‚
;

501  
tŸÆ
 << 
PAGE_SHIFT
;

502 
	}
}

504 
__öô
 
	$ª£rve_¸ashkî√l
()

506 
tŸÆ_mem
;

507 
¸ash_size
, 
¸ash_ba£
;

508 
ªt
;

510 
tŸÆ_mem
 = 
	`gë_tŸÆ_mem
();

512 
ªt
 = 
	`∑r£_¸ashkî√l
(
boŸ_comm™d_löe
, 
tŸÆ_mem
,

513 &
¸ash_size
, &
¸ash_ba£
);

514 i‡(
ªt
 !0 || 
¸ash_size
 <= 0)

518 i‡(
¸ash_ba£
 <= 0) {

519 c⁄° 
Æignmít
 = 16<<20;

521 
¸ash_ba£
 = 
	`föd_e820_¨ó
(
Æignmít
, 
ULONG_MAX
, 
¸ash_size
,

522 
Æignmít
);

523 i‡(
¸ash_ba£
 == -1ULL) {

524 
	`¥_öfo
("crashkernelÑeservation failed - No suitableárea found.\n");

528 
°¨t
;

530 
°¨t
 = 
	`föd_e820_¨ó
(
¸ash_ba£
, 
ULONG_MAX
, 
¸ash_size
,

532 i‡(
°¨t
 !
¸ash_ba£
) {

533 
	`¥_öfo
("crashkernelÑeservation failed - memory is in use.\n");

537 
	`ª£rve_óæy
(
¸ash_ba£
, cøsh_ba£ + 
¸ash_size
, "CRASH KERNEL");

539 
	`¥ötk
(
KERN_INFO
 "Reserving %ldMB of memoryát %ldMB "

541 ()(
¸ash_size
 >> 20),

542 ()(
¸ash_ba£
 >> 20),

543 ()(
tŸÆ_mem
 >> 20));

545 
¸ashk_ªs
.
°¨t
 = 
¸ash_ba£
;

546 
¸ashk_ªs
.
íd
 = 
¸ash_ba£
 + 
¸ash_size
 - 1;

547 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
¸ashk_ªs
);

548 
	}
}

550 
__öô
 
	$ª£rve_¸ashkî√l
()

552 
	}
}

555 
ªsour˚
 
	g°™d¨d_io_ªsour˚s
[] = {

556 { .
«me
 = "dma1", .
	g°¨t
 = 0x00, .
	gíd
 = 0x1f,

557 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

558 { .
	g«me
 = "pic1", .
	g°¨t
 = 0x20, .
	gíd
 = 0x21,

559 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

560 { .
	g«me
 = "timî0", .
	g°¨t
 = 0x40, .
	gíd
 = 0x43,

561 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

562 { .
	g«me
 = "timî1", .
	g°¨t
 = 0x50, .
	gíd
 = 0x53,

563 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

564 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x60, .
	gíd
 = 0x60,

565 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

566 { .
	g«me
 = "keybﬂrd", .
	g°¨t
 = 0x64, .
	gíd
 = 0x64,

567 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

568 { .
	g«me
 = "dm®∑gêªg", .
	g°¨t
 = 0x80, .
	gíd
 = 0x8f,

569 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

570 { .
	g«me
 = "pic2", .
	g°¨t
 = 0xa0, .
	gíd
 = 0xa1,

571 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

572 { .
	g«me
 = "dma2", .
	g°¨t
 = 0xc0, .
	gíd
 = 0xdf,

573 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 },

574 { .
	g«me
 = "Âu", .
	g°¨t
 = 0xf0, .
	gíd
 = 0xff,

575 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_IO
 }

578 
__öô
 
	$ª£rve_°™d¨d_io_ªsour˚s
()

580 
i
;

583 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); i++)

584 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
°™d¨d_io_ªsour˚s
[
i
]);

586 
	}
}

594 #ifde‡
CONFIG_CRASH_DUMP


599 
__öô
 
	$£tup_ñfc‹ehdr
(*
¨g
)

601 *
íd
;

602 i‡(!
¨g
)

603  -
EINVAL
;

604 
ñfc‹ehdr_addr
 = 
	`mem∑r£
(
¨g
, &
íd
);

605  
íd
 > 
¨g
 ? 0 : -
EINVAL
;

606 
	}
}

607 
óæy_∑øm
("ñfc‹ehdr", 
£tup_ñfc‹ehdr
);

610 
__öô
 
	$ª£rve_ib·_ªgi⁄
()

612 
addr
, 
size
 = 0;

614 
addr
 = 
	`föd_ib·_ªgi⁄
(&
size
);

616 i‡(
size
)

617 
	`ª£rve_óæy_ovîœp_ok
(
addr
,ádd∏+ 
size
, "ibft");

618 
	}
}

620 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


621 
__öô
 
	$dmi_low_mem‹y_c‹ru±i⁄
(c⁄° 
dmi_sy°em_id
 *
d
)

623 
	`¥ötk
(
KERN_NOTICE


625 
d
->
idít
);

627 
	`e820_upd©e_ønge
(0, 0x10000, 
E820_RAM
, 
E820_RESERVED
);

628 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

631 
	}
}

635 
dmi_sy°em_id
 
__öôd©a
 
	gbad_bios_dmi_èbÀ
[] = {

636 #ifde‡
CONFIG_X86_RESERVE_LOW_64K


638 .
ˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

639 .
	gidít
 = "AMI BIOS",

640 .
	gm©ches
 = {

641 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "American Megatrends Inc."),

645 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

646 .
	gidít
 = "Phoenix BIOS",

647 .
	gm©ches
 = {

648 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix Technologies"),

652 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

653 .
	gidít
 = "Phoenix/MSC BIOS",

654 .
	gm©ches
 = {

655 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "Phoenix/MSC"),

666 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

667 .
	gidít
 = "AMI BIOS",

668 .
	gm©ches
 = {

669 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45ID"),

673 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

674 .
	gidít
 = "AMI BIOS",

675 .
	gm©ches
 = {

676 
DMI_MATCH
(
DMI_BOARD_NAME
, "DG45FC"),

684 .
	gˇŒback
 = 
dmi_low_mem‹y_c‹ru±i⁄
,

685 .
	gidít
 = "Phoenix BIOS",

686 .
	gm©ches
 = {

687 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Inspiron 1012"),

694 
__öô
 
	$åim_bios_ønge
()

701 
	`e820_upd©e_ønge
(0, 
PAGE_SIZE
, 
E820_RAM
, 
E820_RESERVED
);

707 
	`e820_ªmove_ønge
(
BIOS_BEGIN
, 
BIOS_END
 - BIOS_BEGIN, 
E820_RAM
, 1);

708 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

709 
	}
}

724 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

726 
a˝i
 = 0;

727 
k8
 = 0;

729 #ifde‡
CONFIG_X86_32


730 
	`mem˝y
(&
boŸ_˝u_d©a
, &
√w_˝u_d©a
, (new_cpu_data));

731 
	`visws_óæy_dëe˘
();

733 
	`¥ötk
(
KERN_INFO
 "Comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

737 
	`vmi_öô
();

739 
	`óæy_å≠_öô
();

740 
	`óæy_˝u_öô
();

741 
	`óæy_i‹em≠_öô
();

743 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
boŸ_∑øms
.
hdr
.
roŸ_dev
);

744 
s¸ìn_öfo
 = 
boŸ_∑øms
.screen_info;

745 
edid_öfo
 = 
boŸ_∑øms
.edid_info;

746 #ifde‡
CONFIG_X86_32


747 
≠m_öfo
.
bios
 = 
boŸ_∑øms
.
≠m_bios_öfo
;

748 
i°_öfo
 = 
boŸ_∑øms
.ist_info;

749 i‡(
boŸ_∑øms
.
sys_desc_èbÀ
.
Àngth
 != 0) {

750 
	`£t_mˇ_bus
(
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[3] & 0x2);

751 
machöe_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[0];

752 
machöe_submodñ_id
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[1];

753 
BIOS_ªvisi⁄
 = 
boŸ_∑øms
.
sys_desc_èbÀ
.
èbÀ
[2];

756 
ßved_video_mode
 = 
boŸ_∑øms
.
hdr
.
vid_mode
;

757 
boŸlﬂdî_ty≥
 = 
boŸ_∑øms
.
hdr
.
ty≥_of_lﬂdî
;

758 i‡((
boŸlﬂdî_ty≥
 >> 4) == 0xe) {

759 
boŸlﬂdî_ty≥
 &= 0xf;

760 
boŸlﬂdî_ty≥
 |(
boŸ_∑øms
.
hdr
.
ext_lﬂdî_ty≥
+0x10) << 4;

762 
boŸlﬂdî_vîsi⁄
 = 
boŸlﬂdî_ty≥
 & 0xf;

763 
boŸlﬂdî_vîsi⁄
 |
boŸ_∑øms
.
hdr
.
ext_lﬂdî_vî
 << 4;

765 #ifde‡
CONFIG_BLK_DEV_RAM


766 
rd_image_°¨t
 = 
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_IMAGE_START_MASK
;

767 
rd_¥om±
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_PROMPT_FLAG
) != 0);

768 
rd_dﬁﬂd
 = ((
boŸ_∑øms
.
hdr
.
øm_size
 & 
RAMDISK_LOAD_FLAG
) != 0);

770 #ifde‡
CONFIG_EFI


771 i‡(!
	`°∫cmp
((*)&
boŸ_∑øms
.
efi_öfo
.
efi_lﬂdî_sig«tuª
,

772 #ifde‡
CONFIG_X86_32


778 
efi_íabÀd
 = 1;

779 
	`efi_ª£rve_óæy
();

783 
x86_öô
.
€m
.
	`¨ch_£tup
();

785 
	`£tup_mem‹y_m≠
();

786 
	`∑r£_£tup_d©a
();

788 
	`e820_ª£rve_£tup_d©a
();

790 
	`c›y_edd
();

792 i‡(!
boŸ_∑øms
.
hdr
.
roŸ_Êags
)

793 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

794 
öô_mm
.
°¨t_code
 = (Ë
_ãxt
;

795 
öô_mm
.
íd_code
 = (Ë
_ëext
;

796 
öô_mm
.
íd_d©a
 = (Ë
_ed©a
;

797 
öô_mm
.
brk
 = 
_brk_íd
;

799 
code_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ãxt
);

800 
code_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ëext
)-1;

801 
d©a_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(
_ëext
);

802 
d©a_ªsour˚
.
íd
 = 
	`vút_to_phys
(
_ed©a
)-1;

803 
bss_ªsour˚
.
°¨t
 = 
	`vút_to_phys
(&
__bss_°¨t
);

804 
bss_ªsour˚
.
íd
 = 
	`vút_to_phys
(&
__bss_°›
)-1;

806 #ifde‡
CONFIG_CMDLINE_BOOL


807 #ifde‡
CONFIG_CMDLINE_OVERRIDE


808 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

810 i‡(
buûtö_cmdlöe
[0]) {

812 
	`°æˇt
(
buûtö_cmdlöe
, " ", 
COMMAND_LINE_SIZE
);

813 
	`°æˇt
(
buûtö_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

814 
	`°æ˝y
(
boŸ_comm™d_löe
, 
buûtö_cmdlöe
, 
COMMAND_LINE_SIZE
);

819 
	`°æ˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

820 *
cmdlöe_p
 = 
comm™d_löe
;

829 
	`x86_c⁄figuª_nx
();

831 
	`∑r£_óæy_∑øm
();

833 
	`x86_ªp‹t_nx
();

836 
	`vmi_a˘iv©e
();

839 
	`ª£rve_óæy_£tup_d©a
();

841 i‡(
	`a˝i_mps_check
()) {

842 #ifde‡
CONFIG_X86_LOCAL_APIC


843 
dißbÀ_≠ic
 = 1;

845 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_APIC
);

848 #ifde‡
CONFIG_PCI


849 i‡(
pci_óæy_dump_ªgs
)

850 
	`óæy_dump_pci_devi˚s
();

853 
	`föish_e820_∑rsög
();

855 i‡(
efi_íabÀd
)

856 
	`efi_öô
();

858 
	`dmi_sˇn_machöe
();

860 
	`dmi_check_sy°em
(
bad_bios_dmi_èbÀ
);

866 
	`öô_hy≥rvis‹_∂©f‹m
();

868 
x86_öô
.
ªsour˚s
.
	`¥obe_roms
();

871 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
code_ªsour˚
);

872 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
d©a_ªsour˚
);

873 
	`ö£π_ªsour˚
(&
iomem_ªsour˚
, &
bss_ªsour˚
);

875 
	`åim_bios_ønge
();

876 #ifde‡
CONFIG_X86_32


877 i‡(
	`µro_wôh_øm_bug
()) {

878 
	`e820_upd©e_ønge
(0x70000000ULL, 0x40000ULL, 
E820_RAM
,

879 
E820_RESERVED
);

880 
	`ßnôize_e820_m≠
(
e820
.
m≠
, 
	`ARRAY_SIZE
”820.m≠), &e820.
ƒ_m≠
);

881 
	`¥ötk
(
KERN_INFO
 "fixedÖhysical RAM map:\n");

882 
	`e820_¥öt_m≠
("bad_ppro");

885 
	`óæy_g¨t_iommu_check
();

892 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

895 
	`óæy_ª£rve_e820_mpc_√w
();

897 
	`mår_bp_öô
();

898 i‡(
	`mår_åim_unˇched_mem‹y
(
max_p‚
))

899 
max_p‚
 = 
	`e820_íd_of_øm_p‚
();

901 #ifde‡
CONFIG_X86_32


903 
	`föd_low_p‚_ønge
();

905 
num_phy•ages
 = 
max_p‚
;

907 
	`check_x2≠ic
();

911 i‡(
max_p‚
 > (1UL<<(32 - 
PAGE_SHIFT
)))

912 
max_low_p‚
 = 
	`e820_íd_of_low_øm_p‚
();

914 
max_low_p‚
 = 
max_p‚
;

916 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

917 
max_p‚_m≠≥d
 = 
KERNEL_IMAGE_SIZE
 >> 
PAGE_SHIFT
;

920 #ifde‡
CONFIG_X86_CHECK_BIOS_CORRUPTION


921 
	`£tup_bios_c‹ru±i⁄_check
();

924 
	`¥ötk
(
KERN_DEBUG
 "initial memory mapped : 0 - %08lx\n",

925 
max_p‚_m≠≥d
<<
PAGE_SHIFT
);

927 
	`ª£rve_brk
();

932 
	`föd_smp_c⁄fig
();

934 
	`ª£rve_ib·_ªgi⁄
();

936 
	`ª£rve_åampﬁöe_mem‹y
();

938 #ifde‡
CONFIG_ACPI_SLEEP


943 
	`a˝i_ª£rve_wakeup_mem‹y
();

945 
	`öô_gb∑ges
();

948 
max_low_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

949 
max_p‚_m≠≥d
 = 
max_low_p‚_m≠≥d
;

951 #ifde‡
CONFIG_X86_64


952 i‡(
max_p‚
 > 
max_low_p‚
) {

953 
max_p‚_m≠≥d
 = 
	`öô_mem‹y_m≠pög
(1UL<<32,

954 
max_p‚
<<
PAGE_SHIFT
);

956 
max_low_p‚
 = 
max_p‚
;

964 #ifde‡
CONFIG_PROVIDE_OHCI1394_DMA_INIT


965 i‡(
öô_ohci1394_dma_óæy
)

966 
	`öô_ohci1394_dma_⁄_Æl_c⁄åﬁÀrs
();

969 
	`ª£rve_öôrd
();

971 
	`ª£rve_¸ashkî√l
();

973 
	`vsmp_öô
();

975 
	`io_dñay_öô
();

980 
	`a˝i_boŸ_èbÀ_öô
();

982 
	`óæy_a˝i_boŸ_öô
();

984 #ifde‡
CONFIG_ACPI_NUMA


988 
a˝i
 = 
	`a˝i_numa_öô
();

991 #ifde‡
CONFIG_K8_NUMA


992 i‡(!
a˝i
)

993 
k8
 = !
	`k8_numa_öô
(0, 
max_p‚
);

996 
	`öômem_öô
(0, 
max_p‚
, 
a˝i
, 
k8
);

997 #i‚de‡
CONFIG_NO_BOOTMEM


998 
	`óæy_ªs_to_boŸmem
(0, 
max_low_p‚
<<
PAGE_SHIFT
);

1001 
	`dma32_ª£rve_boŸmem
();

1003 #ifde‡
CONFIG_KVM_CLOCK


1004 
	`kvm˛ock_öô
();

1007 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_°¨t
(
sw≠≥r_pg_dú
);

1008 
	`∑gög_öô
();

1009 
x86_öô
.
∑gög
.
	`∑gëabÀ_£tup_d⁄e
(
sw≠≥r_pg_dú
);

1011 
	`tboŸ_¥obe
();

1013 #ifde‡
CONFIG_X86_64


1014 
	`m≠_vsysˇŒ
();

1017 
	`gíîic_≠ic_¥obe
();

1019 
	`óæy_quúks
();

1024 
	`a˝i_boŸ_öô
();

1026 
	`sfi_öô
();

1031 i‡(
smp_found_c⁄fig
)

1032 
	`gë_smp_c⁄fig
();

1034 
	`¥efûl_possibÀ_m≠
();

1036 #ifde‡
CONFIG_X86_64


1037 
	`öô_˝u_to_node
();

1040 
	`öô_≠ic_m≠pögs
();

1041 
	`iﬂpic_öô_m≠pögs
();

1044 
	`¥obe_ƒ_úqs_gsi
();

1046 
	`kvm_gue°_öô
();

1048 
	`e820_ª£rve_ªsour˚s
();

1049 
	`e820_m¨k_noßve_ªgi⁄s
(
max_low_p‚
);

1051 
x86_öô
.
ªsour˚s
.
	`ª£rve_ªsour˚s
();

1053 
	`e820_£tup_g≠
();

1055 #ifde‡
CONFIG_VT


1056 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

1057 i‡(!
efi_íabÀd
 || (
	`efi_mem_ty≥
(0xa0000Ë!
EFI_CONVENTIONAL_MEMORY
))

1058 
c⁄swôchp
 = &
vga_c⁄
;

1059 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

1060 
c⁄swôchp
 = &
dummy_c⁄
;

1063 
x86_öô
.
€m
.
	`b™√r
();

1065 
	`mcheck_öô
();

1066 
	}
}

1068 #ifde‡
CONFIG_X86_32


1070 
ªsour˚
 
	gvideo_øm_ªsour˚
 = {

1071 .
«me
 = "Video RAMárea",

1072 .
	g°¨t
 = 0xa0000,

1073 .
	gíd
 = 0xbffff,

1074 .
	gÊags
 = 
IORESOURCE_BUSY
 | 
IORESOURCE_MEM


1077 
__öô
 
	$i386_ª£rve_ªsour˚s
()

1079 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm_ªsour˚
);

1080 
	`ª£rve_°™d¨d_io_ªsour˚s
();

1081 
	}
}

	@/cmpt816/linux/arch/x86/kernel/setup_percpu.c

1 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

3 
	~<löux/kî√l.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/öô.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/≥r˝u.h
>

8 
	~<löux/kexec.h
>

9 
	~<löux/¸ash_dump.h
>

10 
	~<löux/smp.h
>

11 
	~<löux/t›ﬁogy.h
>

12 
	~<löux/p‚.h
>

13 
	~<asm/£˘i⁄s.h
>

14 
	~<asm/¥o˚ss‹.h
>

15 
	~<asm/£tup.h
>

16 
	~<asm/mp•ec.h
>

17 
	~<asm/≠icdef.h
>

18 
	~<asm/highmem.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/˝umask.h
>

21 
	~<asm/˝u.h
>

22 
	~<asm/°ack¥Ÿe˘‹.h
>

24 
DEFINE_PER_CPU
(, 
˝u_numbî
);

25 
EXPORT_PER_CPU_SYMBOL
(
˝u_numbî
);

27 #ifde‡
CONFIG_X86_64


28 
	#BOOT_PERCPU_OFFSET
 (()
__≥r_˝u_lﬂd
)

	)

30 
	#BOOT_PERCPU_OFFSET
 0

	)

33 
DEFINE_PER_CPU
(, 
this_˝u_off
Ë
BOOT_PERCPU_OFFSET
;

34 
EXPORT_PER_CPU_SYMBOL
(
this_˝u_off
);

36 
	g__≥r_˝u_off£t
[
NR_CPUS
] 
	g__ªad_mo°ly
 = {

37 [0 ... 
NR_CPUS
-1] = 
BOOT_PERCPU_OFFSET
,

39 
EXPORT_SYMBOL
(
__≥r_˝u_off£t
);

48 #ifde‡
CONFIG_X86_64


49 
	#PERCPU_FIRST_CHUNK_RESERVE
 
PERCPU_MODULE_RESERVE


	)

51 
	#PERCPU_FIRST_CHUNK_RESERVE
 0

	)

54 #ifde‡
CONFIG_X86_32


65 
boﬁ
 
__öô
 
	$p˝u_√ed_numa
()

67 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


68 
pg_d©a_t
 *
œ°
 = 
NULL
;

69 
˝u
;

71 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

72 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

74 i‡(
	`node_⁄löe
(
node
Ë&& 
	`NODE_DATA
(node) &&

75 
œ°
 &&Üa° !
	`NODE_DATA
(
node
))

76  
åue
;

78 
œ°
 = 
	`NODE_DATA
(
node
);

81  
Ál£
;

82 
	}
}

98 * 
__öô
 
	$p˝u_Æloc_boŸmem
(
˝u
, 
size
,

99 
Æign
)

101 c⁄° 
gﬂl
 = 
	`__∑
(
MAX_DMA_ADDRESS
);

102 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


103 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

104 *
±r
;

106 i‡(!
	`node_⁄löe
(
node
Ë|| !
	`NODE_DATA
(node)) {

107 
±r
 = 
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

108 
	`¥_öfo
("cpu %d hasÇoÇode %d orÇode-local memory\n",

109 
˝u
, 
node
);

110 
	`¥_debug
("per cpu data for cpu%d %lu bytesát %016lx\n",

111 
˝u
, 
size
, 
	`__∑
(
±r
));

113 
±r
 = 
	`__Æloc_boŸmem_node_n›™ic
(
	`NODE_DATA
(
node
),

114 
size
, 
Æign
, 
gﬂl
);

115 
	`¥_debug
("per cpu data for cpu%d %lu bytes onÇode%dát %016lx\n",

116 
˝u
, 
size
, 
node
, 
	`__∑
(
±r
));

118  
±r
;

120  
	`__Æloc_boŸmem_n›™ic
(
size
, 
Æign
, 
gﬂl
);

122 
	}
}

127 * 
__öô
 
	$p˝u_fc_Æloc
(
˝u
, 
size_t
 
size
, size_à
Æign
)

129  
	`p˝u_Æloc_boŸmem
(
˝u
, 
size
, 
Æign
);

130 
	}
}

132 
__öô
 
	$p˝u_fc_‰ì
(*
±r
, 
size_t
 
size
)

134 #ifde‡
CONFIG_NO_BOOTMEM


135 
u64
 
°¨t
 = 
	`__∑
(
±r
);

136 
u64
 
íd
 = 
°¨t
 + 
size
;

137 
	`‰ì_óæy_∑πül
(
°¨t
, 
íd
);

139 
	`‰ì_boŸmem
(
	`__∑
(
±r
), 
size
);

141 
	}
}

143 
__öô
 
	$p˝u_˝u_di°™˚
(
‰om
, 
to
)

145 #ifde‡
CONFIG_NEED_MULTIPLE_NODES


146 i‡(
	`óæy_˝u_to_node
(
‰om
Ë=óæy_˝u_to_node(
to
))

147  
LOCAL_DISTANCE
;

149  
REMOTE_DISTANCE
;

151  
LOCAL_DISTANCE
;

153 
	}
}

155 
__öô
 
	$p˝up_p›uœã_±e
(
addr
)

157 
	`p›uœã_exåa_±e
(
addr
);

158 
	}
}

160 
ölöe
 
	$£tup_≥r˝u_£gmít
(
˝u
)

162 #ifde‡
CONFIG_X86_32


163 
desc_°ru˘
 
gdt
;

165 
	`∑ck_des¸ùt‹
(&
gdt
, 
	`≥r_˝u_off£t
(
˝u
), 0xFFFFF,

166 0x2 | 
DESCTYPE_S
, 0x8);

167 
gdt
.
s
 = 1;

168 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
),

169 
GDT_ENTRY_PERCPU
, &
gdt
, 
DESCTYPE_S
);

171 
	}
}

173 
__öô
 
	$£tup_≥r_˝u_¨ós
()

175 
˝u
;

176 
dñè
;

177 
rc
;

179 
	`¥_öfo
("NR_CPUS:%dÇr_cpumask_bits:%dÇr_cpu_ids:%dÇr_node_ids:%d\n",

180 
NR_CPUS
, 
ƒ_˝umask_bôs
, 
ƒ_˝u_ids
, 
ƒ_node_ids
);

188 #ifde‡
CONFIG_X86_32


189 i‡(
p˝u_cho£n_fc
 =
PCPU_FC_AUTO
 && 
	`p˝u_√ed_numa
())

190 
p˝u_cho£n_fc
 = 
PCPU_FC_PAGE
;

192 
rc
 = -
EINVAL
;

193 i‡(
p˝u_cho£n_fc
 !
PCPU_FC_PAGE
) {

194 c⁄° 
size_t
 
©om_size
 = 
˝u_has_p£
 ? 
PMD_SIZE
 : 
PAGE_SIZE
;

195 c⁄° 
size_t
 
dyn_size
 = 
PERCPU_MODULE_RESERVE
 +

196 
PERCPU_DYNAMIC_RESERVE
 - 
PERCPU_FIRST_CHUNK_RESERVE
;

198 
rc
 = 
	`p˝u_embed_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

199 
dyn_size
, 
©om_size
,

200 
p˝u_˝u_di°™˚
,

201 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
);

202 i‡(
rc
 < 0)

203 
	`¥_w¨nög
("%sállocator failed (%d), falling backÅoÖage size\n",

204 
p˝u_fc_«mes
[
p˝u_cho£n_fc
], 
rc
);

206 i‡(
rc
 < 0)

207 
rc
 = 
	`p˝u_∑ge_fú°_chunk
(
PERCPU_FIRST_CHUNK_RESERVE
,

208 
p˝u_fc_Æloc
, 
p˝u_fc_‰ì
,

209 
p˝up_p›uœã_±e
);

210 i‡(
rc
 < 0)

211 
	`∑nic
("ˇ¬Ÿ inôülizê≥r˝uáª®”º=%d)", 
rc
);

214 
dñè
 = ()
p˝u_ba£_addr
 - ()
__≥r_˝u_°¨t
;

215 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

216 
	`≥r_˝u_off£t
(
˝u
Ë
dñè
 + 
p˝u_unô_off£ts
[cpu];

217 
	`≥r_˝u
(
this_˝u_off
, 
˝u
Ë
	`≥r_˝u_off£t
(cpu);

218 
	`≥r_˝u
(
˝u_numbî
, 
˝u
) = cpu;

219 
	`£tup_≥r˝u_£gmít
(
˝u
);

220 
	`£tup_°ack_ˇ«ry_£gmít
(
˝u
);

228 #ifde‡
CONFIG_X86_LOCAL_APIC


229 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
) =

230 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_≠icid
, 
˝u
);

231 
	`≥r_˝u
(
x86_bios_˝u_≠icid
, 
˝u
) =

232 
	`óæy_≥r_˝u_m≠
(
x86_bios_˝u_≠icid
, 
˝u
);

234 #ifde‡
CONFIG_X86_64


235 
	`≥r_˝u
(
úq_°ack_±r
, 
˝u
) =

236 
	`≥r_˝u
(
úq_°ack_uni⁄
.
úq_°ack
, 
˝u
) +

237 
IRQ_STACK_SIZE
 - 64;

238 #ifde‡
CONFIG_NUMA


239 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
) =

240 
	`óæy_≥r_˝u_m≠
(
x86_˝u_to_node_m≠
, 
˝u
);

249 
	`£t_˝u_numa_node
(
˝u
, 
	`óæy_˝u_to_node
(cpu));

256 i‡(
˝u
 =
boŸ_˝u_id
)

257 
	`swôch_to_√w_gdt
(
˝u
);

261 #ifde‡
CONFIG_X86_LOCAL_APIC


262 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
Ë
NULL
;

263 
	`óæy_≥r_˝u_±r
(
x86_bios_˝u_≠icid
Ë
NULL
;

265 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_NUMA
)

266 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
Ë
NULL
;

270 
	`£tup_node_to_˝umask_m≠
();

273 
	`£tup_˝u_loˇl_masks
();

274 
	}
}

	@/cmpt816/linux/arch/x86/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/smp.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/sig«l.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/waô.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/åa˚hook.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/≥rs⁄Æôy.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/u£r-ªtu∫-nŸifõr.h
>

24 
	~<asm/¥o˚ss‹.h
>

25 
	~<asm/uc⁄ãxt.h
>

26 
	~<asm/i387.h
>

27 
	~<asm/vdso.h
>

28 
	~<asm/m˚.h
>

30 #ifde‡
CONFIG_X86_64


31 
	~<asm/¥Ÿo.h
>

32 
	~<asm/ü32_uni°d.h
>

35 
	~<asm/sysˇŒ.h
>

36 
	~<asm/sysˇŒs.h
>

38 
	~<asm/sig‰ame.h
>

40 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

42 
	#__FIX_EFLAGS
 (
X86_EFLAGS_AC
 | 
X86_EFLAGS_OF
 | \

43 
X86_EFLAGS_DF
 | 
X86_EFLAGS_TF
 | 
X86_EFLAGS_SF
 | \

44 
X86_EFLAGS_ZF
 | 
X86_EFLAGS_AF
 | 
X86_EFLAGS_PF
 | \

45 
X86_EFLAGS_CF
)

	)

47 #ifde‡
CONFIG_X86_32


48 
	#FIX_EFLAGS
 (
__FIX_EFLAGS
 | 
X86_EFLAGS_RF
)

	)

50 
	#FIX_EFLAGS
 
__FIX_EFLAGS


	)

53 
	#COPY
(
x
) do { \

54 
	`gë_u£r_ex
(
ªgs
->
x
, &
sc
->x); \

55 } 0)

	)

57 
	#GET_SEG
(
£g
) ({ \

58 
tmp
; \

59 
	`gë_u£r_ex
(
tmp
, &
sc
->
£g
); \

60 
tmp
; \

61 })

	)

63 
	#COPY_SEG
(
£g
) do { \

64 
ªgs
->
£g
 = 
	`GET_SEG
(seg); \

65 } 0)

	)

67 
	#COPY_SEG_CPL3
(
£g
) do { \

68 
ªgs
->
£g
 = 
	`GET_SEG
(seg) | 3; \

69 } 0)

	)

72 
	$ª°‹e_sigc⁄ãxt
(
±_ªgs
 *
ªgs
, 
sigc⁄ãxt
 
__u£r
 *
sc
,

73 *
∑x
)

75 
__u£r
 *
buf
;

76 
tmpÊags
;

77 
îr
 = 0;

80 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

82 
gë_u£r_åy
 {

84 #ifde‡
CONFIG_X86_32


85 
	`£t_u£r_gs
(
ªgs
, 
	`GET_SEG
(
gs
));

86 
	`COPY_SEG
(
fs
);

87 
	`COPY_SEG
(
es
);

88 
	`COPY_SEG
(
ds
);

91 
	`COPY
(
di
); COPY(
si
); COPY(
bp
); COPY(
•
); COPY(
bx
);

92 
	`COPY
(
dx
); COPY(
cx
); COPY(
ù
);

94 #ifde‡
CONFIG_X86_64


95 
	`COPY
(
r8
);

96 
	`COPY
(
r9
);

97 
	`COPY
(
r10
);

98 
	`COPY
(
r11
);

99 
	`COPY
(
r12
);

100 
	`COPY
(
r13
);

101 
	`COPY
(
r14
);

102 
	`COPY
(
r15
);

105 #ifde‡
CONFIG_X86_32


106 
	`COPY_SEG_CPL3
(
cs
);

107 
	`COPY_SEG_CPL3
(
ss
);

112 
	`COPY_SEG_CPL3
(
cs
);

115 
	`gë_u£r_ex
(
tmpÊags
, &
sc
->
Êags
);

116 
ªgs
->
Êags
 = (ªgs->Êag†& ~
FIX_EFLAGS
Ë| (
tmpÊags
 & FIX_EFLAGS);

117 
ªgs
->
‹ig_ax
 = -1;

119 
	`gë_u£r_ex
(
buf
, &
sc
->
Â°©e
);

120 
îr
 |
	`ª°‹e_i387_x°©e
(
buf
);

122 
	`gë_u£r_ex
(*
∑x
, &
sc
->
ax
);

123 } 
	`gë_u£r_ˇtch
(
îr
);

125  
îr
;

126 
	}
}

129 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, __u£∏*
Â°©e
,

130 
±_ªgs
 *
ªgs
, 
mask
)

132 
îr
 = 0;

134 
put_u£r_åy
 {

136 #ifde‡
CONFIG_X86_32


137 
	`put_u£r_ex
(
	`gë_u£r_gs
(
ªgs
), (
__u£r
 *)&
sc
->
gs
);

138 
	`put_u£r_ex
(
ªgs
->
fs
, (
__u£r
 *)&
sc
->fs);

139 
	`put_u£r_ex
(
ªgs
->
es
, (
__u£r
 *)&
sc
->es);

140 
	`put_u£r_ex
(
ªgs
->
ds
, (
__u£r
 *)&
sc
->ds);

143 
	`put_u£r_ex
(
ªgs
->
di
, &
sc
->di);

144 
	`put_u£r_ex
(
ªgs
->
si
, &
sc
->si);

145 
	`put_u£r_ex
(
ªgs
->
bp
, &
sc
->bp);

146 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->sp);

147 
	`put_u£r_ex
(
ªgs
->
bx
, &
sc
->bx);

148 
	`put_u£r_ex
(
ªgs
->
dx
, &
sc
->dx);

149 
	`put_u£r_ex
(
ªgs
->
cx
, &
sc
->cx);

150 
	`put_u£r_ex
(
ªgs
->
ax
, &
sc
->ax);

151 #ifde‡
CONFIG_X86_64


152 
	`put_u£r_ex
(
ªgs
->
r8
, &
sc
->r8);

153 
	`put_u£r_ex
(
ªgs
->
r9
, &
sc
->r9);

154 
	`put_u£r_ex
(
ªgs
->
r10
, &
sc
->r10);

155 
	`put_u£r_ex
(
ªgs
->
r11
, &
sc
->r11);

156 
	`put_u£r_ex
(
ªgs
->
r12
, &
sc
->r12);

157 
	`put_u£r_ex
(
ªgs
->
r13
, &
sc
->r13);

158 
	`put_u£r_ex
(
ªgs
->
r14
, &
sc
->r14);

159 
	`put_u£r_ex
(
ªgs
->
r15
, &
sc
->r15);

162 
	`put_u£r_ex
(
cuºít
->
thªad
.
å≠_no
, &
sc
->
å≠no
);

163 
	`put_u£r_ex
(
cuºít
->
thªad
.
îr‹_code
, &
sc
->
îr
);

164 
	`put_u£r_ex
(
ªgs
->
ù
, &
sc
->ip);

165 #ifde‡
CONFIG_X86_32


166 
	`put_u£r_ex
(
ªgs
->
cs
, (
__u£r
 *)&
sc
->cs);

167 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

168 
	`put_u£r_ex
(
ªgs
->
•
, &
sc
->
•_©_sig«l
);

169 
	`put_u£r_ex
(
ªgs
->
ss
, (
__u£r
 *)&
sc
->ss);

171 
	`put_u£r_ex
(
ªgs
->
Êags
, &
sc
->flags);

172 
	`put_u£r_ex
(
ªgs
->
cs
, &
sc
->cs);

173 
	`put_u£r_ex
(0, &
sc
->
gs
);

174 
	`put_u£r_ex
(0, &
sc
->
fs
);

177 
	`put_u£r_ex
(
Â°©e
, &
sc
->fpstate);

180 
	`put_u£r_ex
(
mask
, &
sc
->
ﬁdmask
);

181 
	`put_u£r_ex
(
cuºít
->
thªad
.
¸2
, &
sc
->cr2);

182 } 
	`put_u£r_ˇtch
(
îr
);

184  
îr
;

185 
	}
}

194 
	$Æign_sig‰ame
(
•
)

196 #ifde‡
CONFIG_X86_32


201 
•
 = ((sp + 4) & -16ul) - 4;

203 
•
 = 
	`round_down
(sp, 16) - 8;

205  
•
;

206 
	}
}

208 
ölöe
 
__u£r
 *

209 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
size_t
 
‰ame_size
,

210 
__u£r
 **
Â°©e
)

213 
•
 = 
ªgs
->sp;

214 
⁄sig°ack
 = 
	`⁄_sig_°ack
(
•
);

216 #ifde‡
CONFIG_X86_64


218 
•
 -= 128;

221 i‡(!
⁄sig°ack
) {

223 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
) {

224 i‡(
cuºít
->
ßs_ss_size
)

225 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

227 #ifde‡
CONFIG_X86_32


229 i‡((
ªgs
->
ss
 & 0xffffË!
__USER_DS
 &&

230 !(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) &&

231 
ka
->
ß
.
ß_ª°‹î
)

232 
•
 = (Ë
ka
->
ß
.
ß_ª°‹î
;

237 i‡(
	`u£d_m©h
()) {

238 
•
 -
sig_x°©e_size
;

239 #ifde‡
CONFIG_X86_64


240 
•
 = 
	`round_down
(sp, 64);

242 *
Â°©e
 = (
__u£r
 *)
•
;

245 
•
 = 
	`Æign_sig‰ame
(• - 
‰ame_size
);

251 i‡(
⁄sig°ack
 && !
	`likñy
(
	`⁄_sig_°ack
(
•
)))

252  (
__u£r
 *)-1L;

255 i‡(
	`u£d_m©h
(Ë&& 
	`ßve_i387_x°©e
(*
Â°©e
) < 0)

256  (
__u£r
 *)-1L;

258  (
__u£r
 *)
•
;

259 
	}
}

261 #ifde‡
CONFIG_X86_32


263 
u16
 
	mp›lmovl
;

264 
u32
 
	mvÆ
;

265 
u16
 
	möt80
;

266 } 
__©åibuã__
((
∑cked
)Ë
	gªtcode
 = {

268 
__NR_sigªtu∫
,

273 
u8
 
	mmovl
;

274 
u32
 
	mvÆ
;

275 
u16
 
	möt80
;

276 
u8
 
	m∑d
;

277 } 
__©åibuã__
((
∑cked
)Ë
	gπ_ªtcode
 = {

279 
__NR_π_sigªtu∫
,

285 
	$__£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

286 
±_ªgs
 *
ªgs
)

288 
sig‰ame
 
__u£r
 *
‰ame
;

289 
__u£r
 *
ª°‹î
;

290 
îr
 = 0;

291 
__u£r
 *
Â°©e
 = 
NULL
;

293 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

295 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

296  -
EFAULT
;

298 i‡(
	`__put_u£r
(
sig
, &
‰ame
->sig))

299  -
EFAULT
;

301 i‡(
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
Â°©e
, 
ªgs
, 
£t
->
sig
[0]))

302  -
EFAULT
;

304 i‡(
_NSIG_WORDS
 > 1) {

305 i‡(
	`__c›y_to_u£r
(&
‰ame
->
exåamask
, &
£t
->
sig
[1],

306 (
‰ame
->
exåamask
)))

307  -
EFAULT
;

310 i‡(
cuºít
->
mm
->
c⁄ãxt
.
vdso
)

311 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
sigªtu∫
);

313 
ª°‹î
 = &
‰ame
->
ªtcode
;

314 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

315 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

318 
îr
 |
	`__put_u£r
(
ª°‹î
, &
‰ame
->
¥ëcode
);

327 
îr
 |
	`__put_u£r
(*((
u64
 *)&
ªtcode
), (u64 *)
‰ame
->retcode);

329 i‡(
îr
)

330  -
EFAULT
;

333 
ªgs
->
•
 = ()
‰ame
;

334 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

335 
ªgs
->
ax
 = ()
sig
;

336 
ªgs
->
dx
 = 0;

337 
ªgs
->
cx
 = 0;

339 
ªgs
->
ds
 = 
__USER_DS
;

340 
ªgs
->
es
 = 
__USER_DS
;

341 
ªgs
->
ss
 = 
__USER_DS
;

342 
ªgs
->
cs
 = 
__USER_CS
;

345 
	}
}

347 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

348 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

350 
π_sig‰ame
 
__u£r
 *
‰ame
;

351 
__u£r
 *
ª°‹î
;

352 
îr
 = 0;

353 
__u£r
 *
Â°©e
 = 
NULL
;

355 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*‰ame), &
Â°©e
);

357 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

358  -
EFAULT
;

360 
put_u£r_åy
 {

361 
	`put_u£r_ex
(
sig
, &
‰ame
->sig);

362 
	`put_u£r_ex
(&
‰ame
->
öfo
, &‰ame->
pöfo
);

363 
	`put_u£r_ex
(&
‰ame
->
uc
, &‰ame->
puc
);

364 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

367 i‡(
˝u_has_xßve
)

368 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

370 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

371 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

372 
	`put_u£r_ex
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

373 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

374 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

375 
	`put_u£r_ex
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

376 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â°©e
,

377 
ªgs
, 
£t
->
sig
[0]);

378 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

381 
ª°‹î
 = 
	`VDSO32_SYMBOL
(
cuºít
->
mm
->
c⁄ãxt
.
vdso
, 
π_sigªtu∫
);

382 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
)

383 
ª°‹î
 = 
ka
->
ß
.
ß_ª°‹î
;

384 
	`put_u£r_ex
(
ª°‹î
, &
‰ame
->
¥ëcode
);

393 
	`put_u£r_ex
(*((
u64
 *)&
π_ªtcode
), (u64 *)
‰ame
->
ªtcode
);

394 } 
	`put_u£r_ˇtch
(
îr
);

396 i‡(
îr
)

397  -
EFAULT
;

400 
ªgs
->
•
 = ()
‰ame
;

401 
ªgs
->
ù
 = ()
ka
->
ß
.
ß_h™dÀr
;

402 
ªgs
->
ax
 = ()
sig
;

403 
ªgs
->
dx
 = ()&
‰ame
->
öfo
;

404 
ªgs
->
cx
 = ()&
‰ame
->
uc
;

406 
ªgs
->
ds
 = 
__USER_DS
;

407 
ªgs
->
es
 = 
__USER_DS
;

408 
ªgs
->
ss
 = 
__USER_DS
;

409 
ªgs
->
cs
 = 
__USER_CS
;

412 
	}
}

414 
	$__£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

415 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

417 
π_sig‰ame
 
__u£r
 *
‰ame
;

418 
__u£r
 *
Â
 = 
NULL
;

419 
îr
 = 0;

420 
èsk_°ru˘
 *
me
 = 
cuºít
;

422 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (
π_sig‰ame
), &
Â
);

424 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

425  -
EFAULT
;

427 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
) {

428 i‡(
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info))

429  -
EFAULT
;

432 
put_u£r_åy
 {

434 i‡(
˝u_has_xßve
)

435 
	`put_u£r_ex
(
UC_FP_XSTATE
, &
‰ame
->
uc
.
uc_Êags
);

437 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_Êags
);

438 
	`put_u£r_ex
(0, &
‰ame
->
uc
.
uc_lök
);

439 
	`put_u£r_ex
(
me
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

440 
	`put_u£r_ex
(
	`ßs_ss_Êags
(
ªgs
->
•
),

441 &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

442 
	`put_u£r_ex
(
me
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

443 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
Â
, 
ªgs
, 
£t
->
sig
[0]);

444 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

449 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

450 
	`put_u£r_ex
(
ka
->
ß
.
ß_ª°‹î
, &
‰ame
->
¥ëcode
);

453 
îr
 |-
EFAULT
;

455 } 
	`put_u£r_ˇtch
(
îr
);

457 i‡(
îr
)

458  -
EFAULT
;

461 
ªgs
->
di
 = 
sig
;

463 
ªgs
->
ax
 = 0;

467 
ªgs
->
si
 = ()&
‰ame
->
öfo
;

468 
ªgs
->
dx
 = ()&
‰ame
->
uc
;

469 
ªgs
->
ù
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

471 
ªgs
->
•
 = ()
‰ame
;

475 
ªgs
->
cs
 = 
__USER_CS
;

478 
	}
}

481 #ifde‡
CONFIG_X86_32


485 
asmlökage
 

486 
	$sys_sigsu•íd
(
hi°‹y0
, 
hi°‹y1
, 
ﬁd_sig£t_t
 
mask
)

488 
mask
 &
_BLOCKABLE
;

489 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

490 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

491 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

492 
	`ªˇlc_sig≥ndög
();

493 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

495 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

496 
	`scheduÀ
();

497 
	`£t_ª°‹e_sigmask
();

499  -
ERESTARTNOHAND
;

500 
	}
}

502 
asmlökage
 

503 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

504 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

506 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

507 
ªt
 = 0;

509 i‡(
a˘
) {

510 
ﬁd_sig£t_t
 
mask
;

512 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)))

513  -
EFAULT
;

515 
gë_u£r_åy
 {

516 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler);

517 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

518 
	`gë_u£r_ex
(
mask
, &
a˘
->
ß_mask
);

519 
	`gë_u£r_ex
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer);

520 } 
	`gë_u£r_ˇtch
(
ªt
);

522 i‡(
ªt
)

523  -
EFAULT
;

524 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

527 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

529 i‡(!
ªt
 && 
ﬂ˘
) {

530 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)))

531  -
EFAULT
;

533 
put_u£r_åy
 {

534 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler);

535 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

536 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

537 
	`put_u£r_ex
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer);

538 } 
	`put_u£r_ˇtch
(
ªt
);

540 i‡(
ªt
)

541  -
EFAULT
;

544  
ªt
;

545 
	}
}

549 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
,

550 
±_ªgs
 *
ªgs
)

552  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
ªgs
->
•
);

553 
	}
}

558 #ifde‡
CONFIG_X86_32


559 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

561 
sig‰ame
 
__u£r
 *
‰ame
;

562 
ax
;

563 
sig£t_t
 
£t
;

565 
‰ame
 = (
sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - 8);

567 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

568 
bad‰ame
;

569 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
‰ame
->
sc
.
ﬁdmask
Ë|| (
_NSIG_WORDS
 > 1

570 && 
	`__c›y_‰om_u£r
(&
£t
.
sig
[1], &
‰ame
->
exåamask
,

571 (
‰ame
->
exåamask
))))

572 
bad‰ame
;

574 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

575 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

576 
cuºít
->
blocked
 = 
£t
;

577 
	`ªˇlc_sig≥ndög
();

578 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

580 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
sc
, &
ax
))

581 
bad‰ame
;

582  
ax
;

584 
bad‰ame
:

585 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "sigreturn");

588 
	}
}

591 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

593 
π_sig‰ame
 
__u£r
 *
‰ame
;

594 
ax
;

595 
sig£t_t
 
£t
;

597 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)(
ªgs
->
•
 - ());

598 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
, (*frame)))

599 
bad‰ame
;

600 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

601 
bad‰ame
;

603 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

604 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

605 
cuºít
->
blocked
 = 
£t
;

606 
	`ªˇlc_sig≥ndög
();

607 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

609 i‡(
	`ª°‹e_sigc⁄ãxt
(
ªgs
, &
‰ame
->
uc
.
uc_mc⁄ãxt
, &
ax
))

610 
bad‰ame
;

612 i‡(
	`do_sigÆt°ack
(&
‰ame
->
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
•
Ë=-
EFAULT
)

613 
bad‰ame
;

615  
ax
;

617 
bad‰ame
:

618 
	`sig«l_Áu…
(
ªgs
, 
‰ame
, "rt_sigreturn");

620 
	}
}

625 
	$sigƒ_c⁄vît
(
sig
)

627 #ifde‡
CONFIG_X86_32


628 
thªad_öfo
 *
öfo
 = 
	`cuºít_thªad_öfo
();

630 i‡(
öfo
->
exec_domaö
 && info->exec_domaö->
sig«l_övm≠
 && 
sig
 < 32)

631  
öfo
->
exec_domaö
->
sig«l_övm≠
[
sig
];

633  
sig
;

634 
	}
}

636 #ifde‡
CONFIG_X86_32


638 
	#is_ü32
 1

	)

639 
	#ü32_£tup_‰ame
 
__£tup_‰ame


	)

640 
	#ü32_£tup_π_‰ame
 
__£tup_π_‰ame


	)

644 #ifde‡
CONFIG_IA32_EMULATION


645 
	#is_ü32
 
	`ã°_thªad_Êag
(
TIF_IA32
)

	)

647 
	#is_ü32
 0

	)

650 
ü32_£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

651 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

652 
ü32_£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
,

653 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
);

658 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

659 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

661 
usig
 = 
	`sigƒ_c⁄vît
(
sig
);

662 
ªt
;

665 i‡(
is_ü32
) {

666 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

667 
ªt
 = 
	`ü32_£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

669 
ªt
 = 
	`ü32_£tup_‰ame
(
usig
, 
ka
, 
£t
, 
ªgs
);

671 
ªt
 = 
	`__£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
£t
, 
ªgs
);

673 i‡(
ªt
) {

674 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

675  -
EFAULT
;

678  
ªt
;

679 
	}
}

682 
	$h™dÀ_sig«l
(
sig
, 
sigöfo_t
 *
öfo
, 
k_siga˘i⁄
 *
ka
,

683 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
)

685 
ªt
;

688 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

690 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

691 -
ERESTART_RESTARTBLOCK
:

692 -
ERESTARTNOHAND
:

693 
ªgs
->
ax
 = -
EINTR
;

696 -
ERESTARTSYS
:

697 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

698 
ªgs
->
ax
 = -
EINTR
;

702 -
ERESTARTNOINTR
:

703 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

704 
ªgs
->
ù
 -= 2;

713 i‡(
	`u∆ikñy
(
ªgs
->
Êags
 & 
X86_EFLAGS_TF
) &&

714 
	`likñy
(
	`ã°_™d_˛ór_thªad_Êag
(
TIF_FORCED_TF
)))

715 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

717 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

719 i‡(
ªt
)

720  
ªt
;

722 #ifde‡
CONFIG_X86_64


728 
	`£t_fs
(
USER_DS
);

734 
ªgs
->
Êags
 &~
X86_EFLAGS_DF
;

742 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

744 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

745 
	`sig‹£ts
(&
cuºít
->
blocked
, &cuºít->blocked, &
ka
->
ß
.
ß_mask
);

746 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

747 
	`sigadd£t
(&
cuºít
->
blocked
, 
sig
);

748 
	`ªˇlc_sig≥ndög
();

749 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

751 
	`åa˚hook_sig«l_h™dÀr
(
sig
, 
öfo
, 
ka
, 
ªgs
,

752 
	`ã°_thªad_Êag
(
TIF_SINGLESTEP
));

755 
	}
}

757 #ifde‡
CONFIG_X86_32


758 
	#NR_ª°¨t_sysˇŒ
 
__NR_ª°¨t_sysˇŒ


	)

760 
	#NR_ª°¨t_sysˇŒ
 \

761 
	`ã°_thªad_Êag
(
TIF_IA32
Ë? 
__NR_ü32_ª°¨t_sysˇŒ
 : 
__NR_ª°¨t_sysˇŒ


	)

769 
	$do_sig«l
(
±_ªgs
 *
ªgs
)

771 
k_siga˘i⁄
 
ka
;

772 
sigöfo_t
 
öfo
;

773 
sigƒ
;

774 
sig£t_t
 *
ﬁd£t
;

783 i‡(!
	`u£r_mode
(
ªgs
))

786 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
)

787 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

789 
ﬁd£t
 = &
cuºít
->
blocked
;

791 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

792 i‡(
sigƒ
 > 0) {

794 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
öfo
, &
ka
, 
ﬁd£t
, 
ªgs
) == 0) {

801 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

807 i‡(
	`sysˇŒ_gë_ƒ
(
cuºít
, 
ªgs
) >= 0) {

809 
	`sysˇŒ_gë_îr‹
(
cuºít
, 
ªgs
)) {

810 -
ERESTARTNOHAND
:

811 -
ERESTARTSYS
:

812 -
ERESTARTNOINTR
:

813 
ªgs
->
ax
 =Ñegs->
‹ig_ax
;

814 
ªgs
->
ù
 -= 2;

817 -
ERESTART_RESTARTBLOCK
:

818 
ªgs
->
ax
 = 
NR_ª°¨t_sysˇŒ
;

819 
ªgs
->
ù
 -= 2;

828 i‡(
	`cuºít_thªad_öfo
()->
°©us
 & 
TS_RESTORE_SIGMASK
) {

829 
	`cuºít_thªad_öfo
()->
°©us
 &~
TS_RESTORE_SIGMASK
;

830 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

832 
	}
}

839 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, *
unu£d
, 
__u32
 
thªad_öfo_Êags
)

841 #ifde‡
CONFIG_X86_MCE


843 i‡(
thªad_öfo_Êags
 & 
_TIF_MCE_NOTIFY
)

844 
	`m˚_nŸify_¥o˚ss
();

848 i‡(
thªad_öfo_Êags
 & 
_TIF_SIGPENDING
)

849 
	`do_sig«l
(
ªgs
);

851 i‡(
thªad_öfo_Êags
 & 
_TIF_NOTIFY_RESUME
) {

852 
	`˛ór_thªad_Êag
(
TIF_NOTIFY_RESUME
);

853 
	`åa˚hook_nŸify_ªsume
(
ªgs
);

854 i‡(
cuºít
->
ª∂a˚mít_£ssi⁄_keyrög
)

855 
	`key_ª∂a˚_£ssi⁄_keyrög
();

857 i‡(
thªad_öfo_Êags
 & 
_TIF_USER_RETURN_NOTIFY
)

858 
	`fúe_u£r_ªtu∫_nŸifõrs
();

860 #ifde‡
CONFIG_X86_32


861 
	`˛ór_thªad_Êag
(
TIF_IRET
);

863 
	}
}

865 
	$sig«l_Áu…
(
±_ªgs
 *
ªgs
, 
__u£r
 *
‰ame
, *
whîe
)

867 
èsk_°ru˘
 *
me
 = 
cuºít
;

869 i‡(
show_unh™dÀd_sig«ls
 && 
	`¥ötk_øãlimô
()) {

870 
	`¥ötk
("%s"

872 
	`èsk_pid_ƒ
(
cuºít
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

873 
me
->
comm
, me->
pid
, 
whîe
, 
‰ame
,

874 
ªgs
->
ù
,Ñegs->
•
,Ñegs->
‹ig_ax
);

875 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

876 
	`¥ötk
(
KERN_CONT
 "\n");

879 
	`f‹˚_sig
(
SIGSEGV
, 
me
);

880 
	}
}

	@/cmpt816/linux/arch/x86/kernel/smp.c

14 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/mc146818πc.h
>

21 
	~<löux/ˇche.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/˝u.h
>

24 
	~<löux/gÂ.h
>

26 
	~<asm/mår.h
>

27 
	~<asm/ébÊush.h
>

28 
	~<asm/mmu_c⁄ãxt.h
>

29 
	~<asm/¥Ÿo.h
>

30 
	~<asm/≠ic.h
>

115 
	$«tive_smp_£nd_ªscheduÀ
(
˝u
)

117 i‡(
	`u∆ikñy
(
	`˝u_is_ofÊöe
(
˝u
))) {

118 
	`WARN_ON
(1);

121 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
RESCHEDULE_VECTOR
);

122 
	}
}

124 
	$«tive_£nd_ˇŒ_func_sögÀ_ùi
(
˝u
)

126 
≠ic
->
	`£nd_IPI_mask
(
	`˝umask_of
(
˝u
), 
CALL_FUNCTION_SINGLE_VECTOR
);

127 
	}
}

129 
	$«tive_£nd_ˇŒ_func_ùi
(c⁄° 
˝umask
 *
mask
)

131 
˝umask_v¨_t
 
Ælbut£lf
;

133 i‡(!
	`Æloc_˝umask_v¨
(&
Ælbut£lf
, 
GFP_ATOMIC
)) {

134 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

138 
	`˝umask_c›y
(
Ælbut£lf
, 
˝u_⁄löe_mask
);

139 
	`˝umask_˛ór_˝u
(
	`smp_¥o˚ss‹_id
(), 
Ælbut£lf
);

141 i‡(
	`˝umask_equÆ
(
mask
, 
Ælbut£lf
) &&

142 
	`˝umask_equÆ
(
˝u_⁄löe_mask
, 
˝u_ˇŒout_mask
))

143 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
CALL_FUNCTION_VECTOR
);

145 
≠ic
->
	`£nd_IPI_mask
(
mask
, 
CALL_FUNCTION_VECTOR
);

147 
	`‰ì_˝umask_v¨
(
Ælbut£lf
);

148 
	}
}

154 
asmlökage
 
	$smp_ªboŸ_öãºu±
()

156 
	`ack_APIC_úq
();

157 
	`úq_íãr
();

158 
	`°›_this_˝u
(
NULL
);

159 
	`úq_exô
();

160 
	}
}

162 
	$«tive_smp_£nd_°›
()

164 
Êags
;

165 
waô
;

167 i‡(
ªboŸ_f‹˚
)

179 i‡(
	`num_⁄löe_˝us
() > 1) {

180 
≠ic
->
	`£nd_IPI_Ælbut£lf
(
REBOOT_VECTOR
);

183 
waô
 = 
USEC_PER_SEC
;

184 
	`num_⁄löe_˝us
(Ë> 1 && 
waô
--)

185 
	`udñay
(1);

188 
	`loˇl_úq_ßve
(
Êags
);

189 
	`dißbÀ_loˇl_APIC
();

190 
	`loˇl_úq_ª°‹e
(
Êags
);

191 
	}
}

198 
	$smp_ªscheduÀ_öãºu±
(
±_ªgs
 *
ªgs
)

200 
	`ack_APIC_úq
();

201 
	`öc_úq_°©
(
úq_ªsched_cou¡
);

205 
	}
}

207 
	$smp_ˇŒ_fun˘i⁄_öãºu±
(
±_ªgs
 *
ªgs
)

209 
	`ack_APIC_úq
();

210 
	`úq_íãr
();

211 
	`gíîic_smp_ˇŒ_fun˘i⁄_öãºu±
();

212 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

213 
	`úq_exô
();

214 
	}
}

216 
	$smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
(
±_ªgs
 *
ªgs
)

218 
	`ack_APIC_úq
();

219 
	`úq_íãr
();

220 
	`gíîic_smp_ˇŒ_fun˘i⁄_sögÀ_öãºu±
();

221 
	`öc_úq_°©
(
úq_ˇŒ_cou¡
);

222 
	`úq_exô
();

223 
	}
}

225 
smp_›s
 
	gsmp_›s
 = {

226 .
smp_¥ï¨e_boŸ_˝u
 = 
«tive_smp_¥ï¨e_boŸ_˝u
,

227 .
	gsmp_¥ï¨e_˝us
 = 
«tive_smp_¥ï¨e_˝us
,

228 .
	gsmp_˝us_d⁄e
 = 
«tive_smp_˝us_d⁄e
,

230 .
	gsmp_£nd_°›
 = 
«tive_smp_£nd_°›
,

231 .
	gsmp_£nd_ªscheduÀ
 = 
«tive_smp_£nd_ªscheduÀ
,

233 .
	g˝u_up
 = 
«tive_˝u_up
,

234 .
	g˝u_dõ
 = 
«tive_˝u_dõ
,

235 .
	g˝u_dißbÀ
 = 
«tive_˝u_dißbÀ
,

236 .
	g∂ay_dód
 = 
«tive_∂ay_dód
,

238 .
	g£nd_ˇŒ_func_ùi
 = 
«tive_£nd_ˇŒ_func_ùi
,

239 .
	g£nd_ˇŒ_func_sögÀ_ùi
 = 
«tive_£nd_ˇŒ_func_sögÀ_ùi
,

241 
EXPORT_SYMBOL_GPL
(
smp_›s
);

	@/cmpt816/linux/arch/x86/kernel/smpboot.c

42 
	~<löux/öô.h
>

43 
	~<löux/smp.h
>

44 
	~<löux/moduÀ.h
>

45 
	~<löux/sched.h
>

46 
	~<löux/≥r˝u.h
>

47 
	~<löux/boŸmem.h
>

48 
	~<löux/îr.h
>

49 
	~<löux/nmi.h
>

50 
	~<löux/tboŸ.h
>

51 
	~<löux/°ack¥Ÿe˘‹.h
>

52 
	~<löux/gÂ.h
>

54 
	~<asm/a˝i.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/nmi.h
>

57 
	~<asm/úq.h
>

58 
	~<asm/idÀ.h
>

59 
	~<asm/åampﬁöe.h
>

60 
	~<asm/˝u.h
>

61 
	~<asm/numa.h
>

62 
	~<asm/pgèbÀ.h
>

63 
	~<asm/ébÊush.h
>

64 
	~<asm/mår.h
>

65 
	~<asm/vmi.h
>

66 
	~<asm/≠ic.h
>

67 
	~<asm/£tup.h
>

68 
	~<asm/uv/uv.h
>

69 
	~<löux/mc146818πc.h
>

71 
	~<asm/smpboŸ_hooks.h
>

72 
	~<asm/i8259.h
>

74 #ifde‡
CONFIG_X86_32


75 
u8
 
	g≠icid_2_node
[
MAX_APICID
];

76 
	glow_m≠pögs
;

80 
DEFINE_PER_CPU
(, 
˝u_°©e
) = { 0 };

86 #ifde‡
CONFIG_HOTPLUG_CPU


91 
DEFINE_PER_CPU
(
èsk_°ru˘
 *, 
idÀ_thªad_¨øy
);

92 
	#gë_idÀ_f‹_˝u
(
x
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, x))

	)

93 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
	`≥r_˝u
(
idÀ_thªad_¨øy
, xË’))

	)

95 
èsk_°ru˘
 *
	gidÀ_thªad_¨øy
[
NR_CPUS
] 
	g__˝uöôd©a
 ;

96 
	#gë_idÀ_f‹_˝u
(
x
Ë(
idÀ_thªad_¨øy
[(x)])

	)

97 
	#£t_idÀ_f‹_˝u
(
x
, 
p
Ë(
idÀ_thªad_¨øy
[(x)] = (p))

	)

101 
	gsmp_num_siblögs
 = 1;

102 
EXPORT_SYMBOL
(
smp_num_siblögs
);

105 
DEFINE_PER_CPU
(
u16
, 
˝u_Œc_id
Ë
BAD_APICID
;

108 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_siblög_m≠
);

109 
EXPORT_PER_CPU_SYMBOL
(
˝u_siblög_m≠
);

112 
DEFINE_PER_CPU
(
˝umask_v¨_t
, 
˝u_c‹e_m≠
);

113 
EXPORT_PER_CPU_SYMBOL
(
˝u_c‹e_m≠
);

116 
DEFINE_PER_CPU_SHARED_ALIGNED
(
˝uöfo_x86
, 
˝u_öfo
);

117 
EXPORT_PER_CPU_SYMBOL
(
˝u_öfo
);

119 
©omic_t
 
	göô_dós£πed
;

121 #i‡
deföed
(
CONFIG_NUMA
Ë&& deföed(
CONFIG_X86_32
)

123 
	g˝u_to_node_m≠
[
NR_CPUS
] 
	g__ªad_mo°ly
 = { [0 ... NR_CPUS-1] = 0 };

124 
EXPORT_SYMBOL
(
˝u_to_node_m≠
);

127 
	$m≠_˝u_to_node
(
˝u
, 
node
)

129 
	`¥ötk
(
KERN_INFO
 "M≠pög cpu %dÅÿnodê%d\n", 
˝u
, 
node
);

130 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

131 
˝u_to_node_m≠
[
˝u
] = 
node
;

132 
	}
}

135 
	$unm≠_˝u_to_node
(
˝u
)

137 
node
;

139 
	`¥ötk
(
KERN_INFO
 "Unm≠pög cpu %d fromáŒÇodes\n", 
˝u
);

140 
node
 = 0;Çodê< 
MAX_NUMNODES
;Çode++)

141 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
node
]);

142 
˝u_to_node_m≠
[
˝u
] = 0;

143 
	}
}

145 
	#m≠_˝u_to_node
(
˝u
, 
node
Ë({})

	)

146 
	#unm≠_˝u_to_node
(
˝u
Ë({})

	)

149 #ifde‡
CONFIG_X86_32


150 
	gboŸ_˝u_logiˇl_≠icid
;

152 
u8
 
	g˝u_2_logiˇl_≠icid
[
NR_CPUS
] 
	g__ªad_mo°ly
 =

153 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

155 
	$m≠_˝u_to_logiˇl_≠icid
()

157 
˝u
 = 
	`smp_¥o˚ss‹_id
();

158 
≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

159 
node
 = 
≠ic
->
	`≠icid_to_node
(
≠icid
);

161 i‡(!
	`node_⁄löe
(
node
))

162 
node
 = 
fú°_⁄löe_node
;

164 
˝u_2_logiˇl_≠icid
[
˝u
] = 
≠icid
;

165 
	`m≠_˝u_to_node
(
˝u
, 
node
);

166 
	}
}

168 
	$numa_ªmove_˝u
(
˝u
)

170 
˝u_2_logiˇl_≠icid
[
˝u
] = 
BAD_APICID
;

171 
	`unm≠_˝u_to_node
(
˝u
);

172 
	}
}

174 
	#m≠_˝u_to_logiˇl_≠icid
(Ëdÿ{} 0)

	)

181 
__˝uöô
 
	$smp_ˇŒö
()

183 
˝uid
, 
phys_id
;

184 
timeout
;

192 i‡(
≠ic
->
waô_f‹_öô_dós£π
)

193 
≠ic
->
	`waô_f‹_öô_dós£π
(&
öô_dós£πed
);

198 
phys_id
 = 
	`ªad_≠ic_id
();

199 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

200 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒö_mask
)) {

201 
	`∑nic
("%s:Öhy†CPU#%d, CPU#%dáÃódyÖª£¡??\n", 
__func__
,

202 
phys_id
, 
˝uid
);

204 
	`¥_debug
("CPU#%d (phy†ID: %dËwaôög f‹ CALLOUT\n", 
˝uid
, 
phys_id
);

217 
timeout
 = 
jiffõs
 + 2*
HZ
;

218 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

222 i‡(
	`˝umask_ã°_˝u
(
˝uid
, 
˝u_ˇŒout_mask
))

224 
	`˝u_ªœx
();

227 i‡(!
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

228 
	`∑nic
("%s: CPU%d started up but didÇot getá callout!\n",

229 
__func__
, 
˝uid
);

239 
	`¥_debug
("CALLIN, before setup_local_APIC().\n");

240 i‡(
≠ic
->
smp_ˇŒö_˛ór_loˇl_≠ic
)

241 
≠ic
->
	`smp_ˇŒö_˛ór_loˇl_≠ic
();

242 
	`£tup_loˇl_APIC
();

243 
	`íd_loˇl_APIC_£tup
();

244 
	`m≠_˝u_to_logiˇl_≠icid
();

249 
	`£tup_ve˘‹_úq
(
	`smp_¥o˚ss‹_id
());

256 
	`loˇl_úq_íabÀ
();

257 
	`ˇlibøã_dñay
();

258 
	`loˇl_úq_dißbÀ
();

259 
	`¥_debug
("Sèckáàabouà%p\n", &
˝uid
);

264 
	`smp_°‹e_˝u_öfo
(
˝uid
);

266 
	`nŸify_˝u_°¨tög
(
˝uid
);

271 
	`˝umask_£t_˝u
(
˝uid
, 
˝u_ˇŒö_mask
);

272 
	}
}

277 
nŸø˚
 
__˝uöô
 
	$°¨t_£c⁄d¨y
(*
unu£d
)

284 
	`vmi_brögup
();

285 
	`˝u_öô
();

286 
	`¥ìm±_dißbÀ
();

287 
	`smp_ˇŒö
();

290 
	`b¨rõr
();

294 
	`check_tsc_sync_èrgë
();

296 i‡(
nmi_w©chdog
 =
NMI_IO_APIC
) {

297 
Àgacy_pic
->
chù
->
	`mask
(0);

298 
	`íabÀ_NMI_through_LVT0
();

299 
Àgacy_pic
->
chù
->
	`unmask
(0);

302 #ifde‡
CONFIG_X86_32


303 
low_m≠pögs
)

304 
	`˝u_ªœx
();

305 
	`__Êush_éb_Æl
();

309 
	`£t_˝u_siblög_m≠
(
	`øw_smp_¥o˚ss‹_id
());

310 
	`wmb
();

324 
	`ùi_ˇŒ_lock
();

325 
	`lock_ve˘‹_lock
();

326 
	`£t_˝u_⁄löe
(
	`smp_¥o˚ss‹_id
(), 
åue
);

327 
	`u∆ock_ve˘‹_lock
();

328 
	`ùi_ˇŒ_u∆ock
();

329 
	`≥r_˝u
(
˝u_°©e
, 
	`smp_¥o˚ss‹_id
()Ë
CPU_ONLINE
;

330 
x86_∂©f‹m
.
	`nmi_öô
();

333 
	`loˇl_úq_íabÀ
();

336 
	`boŸ_öô_°ack_ˇ«ry
();

338 
x86_˝uöô
.
	`£tup_≥r˝u_˛ockev
();

340 
	`wmb
();

341 
	`˝u_idÀ
();

342 
	}
}

344 #ifde‡
CONFIG_CPUMASK_OFFSTACK


346 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

347 c⁄° 
˝uöfo_x86
 *
§c
)

349 
˝umask
 *
Œc
 = 
d°
->
Œc_sh¨ed_m≠
;

350 *
d°
 = *
§c
;

351 
d°
->
Œc_sh¨ed_m≠
 = 
Œc
;

352 
	}
}

354 
ölöe
 
	$c›y_˝uöfo_x86
(
˝uöfo_x86
 *
d°
,

355 c⁄° 
˝uöfo_x86
 *
§c
)

357 *
d°
 = *
§c
;

358 
	}
}

366 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
id
)

368 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
id
);

370 
	`c›y_˝uöfo_x86
(
c
, &
boŸ_˝u_d©a
);

371 
c
->
˝u_ödex
 = 
id
;

372 i‡(
id
 != 0)

373 
	`idítify_£c⁄d¨y_˝u
(
c
);

374 
	}
}

377 
__˝uöô
 
	$£t_˝u_siblög_m≠
(
˝u
)

379 
i
;

380 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

382 
	`˝umask_£t_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

384 i‡(
smp_num_siblögs
 > 1) {

385 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

386 
˝uöfo_x86
 *
o
 = &
	`˝u_d©a
(
i
);

388 i‡(
c
->
phys_¥oc_id
 =
o
->phys_proc_id &&

389 
c
->
˝u_c‹e_id
 =
o
->cpu_core_id) {

390 
	`˝umask_£t_˝u
(
i
, 
	`˝u_siblög_mask
(
˝u
));

391 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(
i
));

392 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

393 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

394 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

395 
	`˝umask_£t_˝u
(
˝u
, 
o
->
Œc_sh¨ed_m≠
);

399 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_siblög_mask
(cpu));

402 
	`˝umask_£t_˝u
(
˝u
, 
c
->
Œc_sh¨ed_m≠
);

404 i‡(
cuºít_˝u_d©a
.
x86_max_c‹es
 == 1) {

405 
	`˝umask_c›y
(
	`˝u_c‹e_mask
(
˝u
), 
	`˝u_siblög_mask
(cpu));

406 
c
->
boŸed_c‹es
 = 1;

410 
	`f‹_óch_˝u
(
i
, 
˝u_siblög_£tup_mask
) {

411 i‡(
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë!
BAD_APICID
 &&

412 
	`≥r_˝u
(
˝u_Œc_id
, 
˝u
Ë=≥r_˝u(˝u_Œc_id, 
i
)) {

413 
	`˝umask_£t_˝u
(
i
, 
c
->
Œc_sh¨ed_m≠
);

414 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
);

416 i‡(
c
->
phys_¥oc_id
 =
	`˝u_d©a
(
i
).phys_proc_id) {

417 
	`˝umask_£t_˝u
(
i
, 
	`˝u_c‹e_mask
(
˝u
));

418 
	`˝umask_£t_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
i
));

422 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1) {

427 i‡(
	`˝umask_fú°
(
	`˝u_siblög_mask
(
i
)) == i)

428 
c
->
boŸed_c‹es
++;

433 i‡(
i
 !
˝u
)

434 
	`˝u_d©a
(
i
).
boŸed_c‹es
++;

435 } i‡(
i
 !
˝u
 && !
c
->
boŸed_c‹es
)

436 
c
->
boŸed_c‹es
 = 
	`˝u_d©a
(
i
).booted_cores;

439 
	}
}

442 c⁄° 
˝umask
 *
	$˝u_c‹egroup_mask
(
˝u
)

444 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

449 i‡((
sched_mc_powî_ßvögs
 || 
sched_smt_powî_ßvögs
) &&

450 !(
	`˝u_has
(
c
, 
X86_FEATURE_AMD_DCM
)))

451  
	`˝u_c‹e_mask
(
˝u
);

453  
c
->
Œc_sh¨ed_m≠
;

454 
	}
}

456 
	$im¥ess_‰õnds
()

458 
˝u
;

459 
bogosum
 = 0;

463 
	`¥_debug
("Before bogomips.\n");

464 
	`f‹_óch_possibÀ_˝u
(
˝u
)

465 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒout_mask
))

466 
bogosum
 +
	`˝u_d©a
(
˝u
).
lo›s_≥r_jiffy
;

467 
	`¥ötk
(
KERN_INFO


469 
	`num_⁄löe_˝us
(),

470 
bogosum
/(500000/
HZ
),

471 (
bogosum
/(5000/
HZ
))%100);

473 
	`¥_debug
("Before bogocount - settingáctivated=1.\n");

474 
	}
}

476 
	$__öquúe_ªmŸe_≠ic
(
≠icid
)

478 
i
, 
ªgs
[] = { 
APIC_ID
 >> 4, 
APIC_LVR
 >> 4, 
APIC_SPIV
 >> 4 };

479 *
«mes
[] = { "ID", "VERSION", "SPIV" };

480 
timeout
;

481 
u32
 
°©us
;

483 
	`¥ötk
(
KERN_INFO
 "InquúögÑemŸêAPIC 0x%x...\n", 
≠icid
);

485 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªgs
); i++) {

486 
	`¥ötk
(
KERN_INFO
 "... APIC 0x%x %s: ", 
≠icid
, 
«mes
[
i
]);

491 
°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

492 i‡(
°©us
)

493 
	`¥ötk
(
KERN_CONT


496 
	`≠ic_i¸_wrôe
(
APIC_DM_REMRD
 | 
ªgs
[
i
], 
≠icid
);

498 
timeout
 = 0;

500 
	`udñay
(100);

501 
°©us
 = 
	`≠ic_ªad
(
APIC_ICR
Ë& 
APIC_ICR_RR_MASK
;

502 } 
°©us
 =
APIC_ICR_RR_INPROG
 && 
timeout
++ < 1000);

504 
°©us
) {

505 
APIC_ICR_RR_VALID
:

506 
°©us
 = 
	`≠ic_ªad
(
APIC_RRR
);

507 
	`¥ötk
(
KERN_CONT
 "%08x\n", 
°©us
);

510 
	`¥ötk
(
KERN_CONT
 "failed\n");

513 
	}
}

520 
__˝uöô


521 
	$wakeup_£c⁄d¨y_˝u_vü_nmi
(
logiˇl_≠icid
, 
°¨t_eù
)

523 
£nd_°©us
, 
ac˚±_°©us
 = 0;

524 
maxlvt
;

529 
	`≠ic_i¸_wrôe
(
APIC_DM_NMI
 | 
≠ic
->
de°_logiˇl
, 
logiˇl_≠icid
);

531 
	`¥_debug
("Waiting for sendÅo finish...\n");

532 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

537 
	`udñay
(200);

538 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

539 
maxlvt
 = 
	`œpic_gë_maxlvt
();

540 i‡(
maxlvt
 > 3)

541 
	`≠ic_wrôe
(
APIC_ESR
, 0);

542 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

544 
	`¥_debug
("NMI sent.\n");

546 i‡(
£nd_°©us
)

547 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

548 i‡(
ac˚±_°©us
)

549 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

551  (
£nd_°©us
 | 
ac˚±_°©us
);

552 
	}
}

554 
__˝uöô


555 
	$wakeup_£c⁄d¨y_˝u_vü_öô
(
phys_≠icid
, 
°¨t_eù
)

557 
£nd_°©us
, 
ac˚±_°©us
 = 0;

558 
maxlvt
, 
num_°¨ts
, 
j
;

560 
maxlvt
 = 
	`œpic_gë_maxlvt
();

565 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
])) {

566 i‡(
maxlvt
 > 3)

567 
	`≠ic_wrôe
(
APIC_ESR
, 0);

568 
	`≠ic_ªad
(
APIC_ESR
);

571 
	`¥_debug
("Asserting INIT.\n");

579 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

580 
phys_≠icid
);

582 
	`¥_debug
("Waiting for sendÅo finish...\n");

583 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

585 
	`mdñay
(10);

587 
	`¥_debug
("Deasserting INIT.\n");

591 
	`≠ic_i¸_wrôe
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_≠icid
);

593 
	`¥_debug
("Waiting for sendÅo finish...\n");

594 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

596 
	`mb
();

597 
	`©omic_£t
(&
öô_dós£πed
, 1);

605 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
phys_≠icid
]))

606 
num_°¨ts
 = 2;

608 
num_°¨ts
 = 0;

614 
	`°¨tup_ùi_hook
(
phys_≠icid
, (Ë
°¨t_£c⁄d¨y
,

615 ()
°ack_°¨t
.
•
);

620 
	`¥_debug
("#°¨tu∞lo›s: %d.\n", 
num_°¨ts
);

622 
j
 = 1; j <
num_°¨ts
; j++) {

623 
	`¥_debug
("Sídög STARTUP #%d.\n", 
j
);

624 i‡(
maxlvt
 > 3)

625 
	`≠ic_wrôe
(
APIC_ESR
, 0);

626 
	`≠ic_ªad
(
APIC_ESR
);

627 
	`¥_debug
("Afterápic_write.\n");

636 
	`≠ic_i¸_wrôe
(
APIC_DM_STARTUP
 | (
°¨t_eù
 >> 12),

637 
phys_≠icid
);

642 
	`udñay
(300);

644 
	`¥_debug
("StartupÖoint 1.\n");

646 
	`¥_debug
("Waiting for sendÅo finish...\n");

647 
£nd_°©us
 = 
	`ß„_≠ic_waô_i¸_idÀ
();

652 
	`udñay
(200);

653 i‡(
maxlvt
 > 3)

654 
	`≠ic_wrôe
(
APIC_ESR
, 0);

655 
ac˚±_°©us
 = (
	`≠ic_ªad
(
APIC_ESR
) & 0xEF);

656 i‡(
£nd_°©us
 || 
ac˚±_°©us
)

659 
	`¥_debug
("After Startup.\n");

661 i‡(
£nd_°©us
)

662 
	`¥ötk
(
KERN_ERR
 "APICÇever delivered???\n");

663 i‡(
ac˚±_°©us
)

664 
	`¥ötk
(
KERN_ERR
 "APIC dñivîyÉº‹ (%lx).\n", 
ac˚±_°©us
);

666  (
£nd_°©us
 | 
ac˚±_°©us
);

667 
	}
}

669 
	s¸óã_idÀ
 {

670 
w‹k_°ru˘
 
	mw‹k
;

671 
èsk_°ru˘
 *
	midÀ
;

672 
com∂ëi⁄
 
	md⁄e
;

673 
	m˝u
;

676 
__˝uöô
 
	$do_f‹k_idÀ
(
w‹k_°ru˘
 *
w‹k
)

678 
¸óã_idÀ
 *
c_idÀ
 =

679 
	`c⁄èöî_of
(
w‹k
, 
¸óã_idÀ
, work);

681 
c_idÀ
->
idÀ
 = 
	`f‹k_idÀ
(c_idÀ->
˝u
);

682 
	`com∂ëe
(&
c_idÀ
->
d⁄e
);

683 
	}
}

686 
__˝uöô
 
	$™noun˚_˝u
(
˝u
, 
≠icid
)

688 
cuºít_node
 = -1;

689 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

691 i‡(
sy°em_°©e
 =
SYSTEM_BOOTING
) {

692 i‡(
node
 !
cuºít_node
) {

693 i‡(
cuºít_node
 > (-1))

694 
	`¥_c⁄t
(" Ok.\n");

695 
cuºít_node
 = 
node
;

696 
	`¥_öfo
("BoŸög Nodê%3d, Pro˚ss‹†", 
node
);

698 
	`¥_c⁄t
(" #%d%s", 
˝u
, cpu =(
ƒ_˝u_ids
 - 1) ? " Ok.\n" : "");

701 
	`¥_öfo
("Booting Node %d Processor %d APIC 0x%x\n",

702 
node
, 
˝u
, 
≠icid
);

703 
	}
}

711 
__˝uöô
 
	$do_boŸ_˝u
(
≠icid
, 
˝u
)

713 
boŸ_îr‹
 = 0;

714 
°¨t_ù
;

715 
timeout
;

716 
¸óã_idÀ
 
c_idÀ
 = {

717 .
˝u
 = cpu,

718 .
d⁄e
 = 
	`COMPLETION_INITIALIZER_ONSTACK
(
c_idÀ
.done),

721 
	`INIT_WORK_ON_STACK
(&
c_idÀ
.
w‹k
, 
do_f‹k_idÀ
);

723 
	`Æã∫©ives_smp_swôch
(1);

725 
c_idÀ
.
idÀ
 = 
	`gë_idÀ_f‹_˝u
(
˝u
);

731 i‡(
c_idÀ
.
idÀ
) {

732 
c_idÀ
.
idÀ
->
thªad
.
•
 = (Ë(((
±_ªgs
 *)

733 (
THREAD_SIZE
 + 
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
))) - 1);

734 
	`öô_idÀ
(
c_idÀ
.
idÀ
, 
˝u
);

735 
do_ª°
;

738 i‡(!
	`kevítd_up
(Ë|| 
	`cuºít_is_kevítd
())

739 
c_idÀ
.
w‹k
.
	`func
(&c_idle.work);

741 
	`scheduÀ_w‹k
(&
c_idÀ
.
w‹k
);

742 
	`waô_f‹_com∂ëi⁄
(&
c_idÀ
.
d⁄e
);

745 i‡(
	`IS_ERR
(
c_idÀ
.
idÀ
)) {

746 
	`¥ötk
("Áûed f‹k f‹ CPU %d\n", 
˝u
);

747 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

748  
	`PTR_ERR
(
c_idÀ
.
idÀ
);

751 
	`£t_idÀ_f‹_˝u
(
˝u
, 
c_idÀ
.
idÀ
);

752 
do_ª°
:

753 
	`≥r_˝u
(
cuºít_èsk
, 
˝u
Ë
c_idÀ
.
idÀ
;

754 #ifde‡
CONFIG_X86_32


756 
	`úq_˘x_öô
(
˝u
);

758 
	`˛ór_tsk_thªad_Êag
(
c_idÀ
.
idÀ
, 
TIF_FORK
);

759 
öôül_gs
 = 
	`≥r_˝u_off£t
(
˝u
);

760 
	`≥r_˝u
(
kî√l_°ack
, 
˝u
) =

761 ()
	`èsk_°ack_∑ge
(
c_idÀ
.
idÀ
) -

762 
KERNEL_STACK_OFFSET
 + 
THREAD_SIZE
;

764 
óæy_gdt_des¸
.
addªss
 = ()
	`gë_˝u_gdt_èbÀ
(
˝u
);

765 
öôül_code
 = ()
°¨t_£c⁄d¨y
;

766 
°ack_°¨t
.
•
 = (*Ë
c_idÀ
.
idÀ
->
thªad
.sp;

769 
°¨t_ù
 = 
	`£tup_åampﬁöe
();

772 
	`™noun˚_˝u
(
˝u
, 
≠icid
);

779 
	`©omic_£t
(&
öô_dós£πed
, 0);

781 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

783 
	`¥_debug
("Setting warmÑeset codeánd vector.\n");

785 
	`smpboŸ_£tup_w¨m_ª£t_ve˘‹
(
°¨t_ù
);

789 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
])) {

790 
	`≠ic_wrôe
(
APIC_ESR
, 0);

791 
	`≠ic_ªad
(
APIC_ESR
);

799 i‡(
≠ic
->
wakeup_£c⁄d¨y_˝u
)

800 
boŸ_îr‹
 = 
≠ic
->
	`wakeup_£c⁄d¨y_˝u
(
≠icid
, 
°¨t_ù
);

802 
boŸ_îr‹
 = 
	`wakeup_£c⁄d¨y_˝u_vü_öô
(
≠icid
, 
°¨t_ù
);

804 i‡(!
boŸ_îr‹
) {

808 
	`¥_debug
("Bef‹êCÆlouà%d.\n", 
˝u
);

809 
	`˝umask_£t_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

810 
	`¥_debug
("A·î CÆlouà%d.\n", 
˝u
);

815 
timeout
 = 0;Åimeout < 50000;Åimeout++) {

816 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

818 
	`udñay
(100);

821 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
))

822 
	`¥_debug
("CPU%d: ha†boŸed.\n", 
˝u
);

824 
boŸ_îr‹
 = 1;

825 i‡(*((vﬁ©ûê*)
åampﬁöe_ba£
)

828 
	`¥_îr
("CPU%d: Stuck ??\n", 
˝u
);

831 
	`¥_îr
("CPU%d: NŸÑe•⁄dög.\n", 
˝u
);

832 i‡(
≠ic
->
öquúe_ªmŸe_≠ic
)

833 
≠ic
->
	`öquúe_ªmŸe_≠ic
(
≠icid
);

837 i‡(
boŸ_îr‹
) {

839 
	`numa_ªmove_˝u
(
˝u
);

842 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

845 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

847 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

848 
	`≥r_˝u
(
x86_˝u_to_≠icid
, 
˝u
Ë
BAD_APICID
;

852 *((vﬁ©ûê*)
åampﬁöe_ba£
) = 0;

854 i‡(
	`gë_uv_sy°em_ty≥
(Ë!
UV_NON_UNIQUE_APIC
) {

858 
	`smpboŸ_ª°‹e_w¨m_ª£t_ve˘‹
();

861 
	`de°roy_w‹k_⁄_°ack
(&
c_idÀ
.
w‹k
);

862  
boŸ_îr‹
;

863 
	}
}

865 
__˝uöô
 
	$«tive_˝u_up
(
˝u
)

867 
≠icid
 = 
≠ic
->
	`˝u_¥e£¡_to_≠icid
(
˝u
);

868 
Êags
;

869 
îr
;

871 
	`WARN_ON
(
	`úqs_dißbÀd
());

873 
	`¥_debug
("++++++++++++++++++++=_---CPU UP %u\n", 
˝u
);

875 i‡(
≠icid
 =
BAD_APICID
 ||ápicid =
boŸ_˝u_physiˇl_≠icid
 ||

876 !
	`physid_is£t
(
≠icid
, 
phys_˝u_¥e£¡_m≠
)) {

877 
	`¥ötk
(
KERN_ERR
 "%s: bad cpu %d\n", 
__func__
, 
˝u
);

878  -
EINVAL
;

884 i‡(
	`˝umask_ã°_˝u
(
˝u
, 
˝u_ˇŒö_mask
)) {

885 
	`¥_debug
("do_boŸ_˝u %d AÃódy sèπed\n", 
˝u
);

886  -
ENOSYS
;

893 
	`mår_ßve_°©e
();

895 
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë
CPU_UP_PREPARE
;

897 #ifde‡
CONFIG_X86_32


899 
	`˛⁄e_pgd_ønge
(
sw≠≥r_pg_dú
, sw≠≥r_pg_dú + 
KERNEL_PGD_BOUNDARY
,

900 
	`mö_t
(, 
KERNEL_PGD_PTRS
, 
KERNEL_PGD_BOUNDARY
));

901 
	`Êush_éb_Æl
();

902 
low_m≠pögs
 = 1;

904 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

906 
	`z≠_low_m≠pögs
(
Ál£
);

907 
low_m≠pögs
 = 0;

909 
îr
 = 
	`do_boŸ_˝u
(
≠icid
, 
˝u
);

911 i‡(
îr
) {

912 
	`¥_debug
("do_boŸ_˝u faûed %d\n", 
îr
);

913  -
EIO
;

920 
	`loˇl_úq_ßve
(
Êags
);

921 
	`check_tsc_sync_sour˚
(
˝u
);

922 
	`loˇl_úq_ª°‹e
(
Êags
);

924 !
	`˝u_⁄löe
(
˝u
)) {

925 
	`˝u_ªœx
();

926 
	`touch_nmi_w©chdog
();

930 
	}
}

937 
__öô
 
	$dißbÀ_smp
()

939 
	`öô_˝u_¥e£¡
(
	`˝umask_of
(0));

940 
	`öô_˝u_possibÀ
(
	`˝umask_of
(0));

941 
	`smpboŸ_˛ór_io_≠ic_úqs
();

943 i‡(
smp_found_c⁄fig
)

944 
	`physid_£t_mask_of_physid
(
boŸ_˝u_physiˇl_≠icid
, &
phys_˝u_¥e£¡_m≠
);

946 
	`physid_£t_mask_of_physid
(0, &
phys_˝u_¥e£¡_m≠
);

947 
	`m≠_˝u_to_logiˇl_≠icid
();

948 
	`˝umask_£t_˝u
(0, 
	`˝u_siblög_mask
(0));

949 
	`˝umask_£t_˝u
(0, 
	`˝u_c‹e_mask
(0));

950 
	}
}

955 
__öô
 
	$smp_ßnôy_check
(
max_˝us
)

957 
	`¥ìm±_dißbÀ
();

959 #i‡!
	`deföed
(
CONFIG_X86_BIGSMP
Ë&& deföed(
CONFIG_X86_32
)

960 i‡(
def_to_bigsmp
 && 
ƒ_˝u_ids
 > 8) {

961 
˝u
;

962 
ƒ
;

964 
	`¥ötk
(
KERN_WARNING


968 
ƒ
 = 0;

969 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

970 i‡(
ƒ
 >= 8)

971 
	`£t_˝u_¥e£¡
(
˝u
, 
Ál£
);

972 
ƒ
++;

975 
ƒ
 = 0;

976 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

977 i‡(
ƒ
 >= 8)

978 
	`£t_˝u_possibÀ
(
˝u
, 
Ál£
);

979 
ƒ
++;

982 
ƒ_˝u_ids
 = 8;

986 i‡(!
	`physid_is£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
)) {

987 
	`¥ötk
(
KERN_WARNING


989 
	`h¨d_smp_¥o˚ss‹_id
());

991 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

998 i‡(!
smp_found_c⁄fig
 && !
a˝i_œpic
) {

999 
	`¥ìm±_íabÀ
();

1000 
	`¥ötk
(
KERN_NOTICE
 "SMP motherboardÇot detected.\n");

1001 
	`dißbÀ_smp
();

1002 i‡(
	`APIC_öô_unùro˚ss‹
())

1003 
	`¥ötk
(
KERN_NOTICE
 "Local APICÇot detected."

1012 i‡(!
≠ic
->
	`check_phys_≠icid_¥e£¡
(
boŸ_˝u_physiˇl_≠icid
)) {

1013 
	`¥ötk
(
KERN_NOTICE


1015 
boŸ_˝u_physiˇl_≠icid
);

1016 
	`physid_£t
(
	`h¨d_smp_¥o˚ss‹_id
(), 
phys_˝u_¥e£¡_m≠
);

1018 
	`¥ìm±_íabÀ
();

1023 i‡(
	`APIC_INTEGRATED
(
≠ic_vîsi⁄
[
boŸ_˝u_physiˇl_≠icid
]) &&

1024 !
˝u_has_≠ic
) {

1025 i‡(!
dißbÀ_≠ic
) {

1026 
	`¥_îr
("BIOS bug,Üocal APIC #%dÇot detected!...\n",

1027 
boŸ_˝u_physiˇl_≠icid
);

1028 
	`¥_îr
("... forcing use of dummy APICÉmulation."

1031 
	`smpboŸ_˛ór_io_≠ic
();

1032 
	`¨ch_dißbÀ_smp_suµ‹t
();

1036 
	`vîify_loˇl_APIC
();

1041 i‡(!
max_˝us
) {

1042 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

1043 
	`smpboŸ_˛ór_io_≠ic
();

1045 
	`loˇli£_nmi_w©chdog
();

1047 
	`c⁄√˘_b•_APIC
();

1048 
	`£tup_loˇl_APIC
();

1049 
	`íd_loˇl_APIC_£tup
();

1054 
	}
}

1056 
__öô
 
	$smp_˝u_ödex_deÁu…
()

1058 
i
;

1059 
˝uöfo_x86
 *
c
;

1061 
	`f‹_óch_possibÀ_˝u
(
i
) {

1062 
c
 = &
	`˝u_d©a
(
i
);

1064 
c
->
˝u_ödex
 = 
ƒ_˝u_ids
;

1066 
	}
}

1072 
__öô
 
	$«tive_smp_¥ï¨e_˝us
(
max_˝us
)

1074 
i
;

1076 
	`¥ìm±_dißbÀ
();

1077 
	`smp_˝u_ödex_deÁu…
();

1078 
cuºít_˝u_d©a
 = 
boŸ_˝u_d©a
;

1079 
	`˝umask_c›y
(
˝u_ˇŒö_mask
, 
	`˝umask_of
(0));

1080 
	`mb
();

1084 
	`smp_°‹e_˝u_öfo
(0);

1085 #ifde‡
CONFIG_X86_32


1086 
boŸ_˝u_logiˇl_≠icid
 = 
	`logiˇl_smp_¥o˚ss‹_id
();

1088 
	`cuºít_thªad_öfo
()->
˝u
 = 0;

1089 
	`f‹_óch_possibÀ_˝u
(
i
) {

1090 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_siblög_m≠
, 
i
), 
GFP_KERNEL
);

1091 
	`zÆloc_˝umask_v¨
(&
	`≥r_˝u
(
˝u_c‹e_m≠
, 
i
), 
GFP_KERNEL
);

1092 
	`zÆloc_˝umask_v¨
(&
	`˝u_d©a
(
i
).
Œc_sh¨ed_m≠
, 
GFP_KERNEL
);

1094 
	`£t_˝u_siblög_m≠
(0);

1096 
	`íabÀ_IR_x2≠ic
();

1097 
	`deÁu…_£tup_≠ic_routög
();

1099 i‡(
	`smp_ßnôy_check
(
max_˝us
) < 0) {

1100 
	`¥ötk
(
KERN_INFO
 "SMP disabled\n");

1101 
	`dißbÀ_smp
();

1102 
out
;

1105 
	`¥ìm±_dißbÀ
();

1106 i‡(
	`ªad_≠ic_id
(Ë!
boŸ_˝u_physiˇl_≠icid
) {

1107 
	`∑nic
("Boot APIC ID inÜocal APIC unexpected (%d vs %d)",

1108 
	`ªad_≠ic_id
(), 
boŸ_˝u_physiˇl_≠icid
);

1111 
	`¥ìm±_íabÀ
();

1113 
	`c⁄√˘_b•_APIC
();

1118 
	`£tup_loˇl_APIC
();

1123 i‡(!
skù_iﬂpic_£tup
 && 
ƒ_iﬂpics
)

1124 
	`íabÀ_IO_APIC
();

1126 
	`íd_loˇl_APIC_£tup
();

1128 
	`m≠_˝u_to_logiˇl_≠icid
();

1130 i‡(
≠ic
->
£tup_p‹tio_ªm≠
)

1131 
≠ic
->
	`£tup_p‹tio_ªm≠
();

1133 
	`smpboŸ_£tup_io_≠ic
();

1138 
	`¥ötk
(
KERN_INFO
 "CPU%d: ", 0);

1139 
	`¥öt_˝u_öfo
(&
	`˝u_d©a
(0));

1140 
x86_öô
.
timîs
.
	`£tup_≥r˝u_˛ockev
();

1142 i‡(
	`is_uv_sy°em
())

1143 
	`uv_sy°em_öô
();

1145 
	`£t_mår_≠s_dñayed_öô
();

1146 
out
:

1147 
	`¥ìm±_íabÀ
();

1148 
	}
}

1150 
	$¨ch_íabÀ_n⁄boŸ_˝us_begö
()

1152 
	`£t_mår_≠s_dñayed_öô
();

1153 
	}
}

1155 
	$¨ch_íabÀ_n⁄boŸ_˝us_íd
()

1157 
	`mår_≠s_öô
();

1158 
	}
}

1163 
__öô
 
	$«tive_smp_¥ï¨e_boŸ_˝u
()

1165 
me
 = 
	`smp_¥o˚ss‹_id
();

1166 
	`swôch_to_√w_gdt
(
me
);

1168 
	`˝umask_£t_˝u
(
me
, 
˝u_ˇŒout_mask
);

1169 
	`≥r_˝u
(
˝u_°©e
, 
me
Ë
CPU_ONLINE
;

1170 
	}
}

1172 
__öô
 
	$«tive_smp_˝us_d⁄e
(
max_˝us
)

1174 
	`¥_debug
("Boot done.\n");

1176 
	`im¥ess_‰õnds
();

1177 #ifde‡
CONFIG_X86_IO_APIC


1178 
	`£tup_iﬂpic_de°
();

1180 
	`check_nmi_w©chdog
();

1181 
	`mår_≠s_öô
();

1182 
	}
}

1184 
__öôd©a
 
	g£tup_possibÀ_˝us
 = -1;

1185 
__öô
 
	$_£tup_possibÀ_˝us
(*
°r
)

1187 
	`gë_›ti⁄
(&
°r
, &
£tup_possibÀ_˝us
);

1189 
	}
}

1190 
óæy_∑øm
("possibÀ_˝us", 
_£tup_possibÀ_˝us
);

1210 
__öô
 
	$¥efûl_possibÀ_m≠
()

1212 
i
, 
possibÀ
;

1215 i‡(!
num_¥o˚ss‹s
)

1216 
num_¥o˚ss‹s
 = 1;

1218 
i
 = 
£tup_max_˝us
 ?: 1;

1219 i‡(
£tup_possibÀ_˝us
 == -1) {

1220 
possibÀ
 = 
num_¥o˚ss‹s
;

1221 #ifde‡
CONFIG_HOTPLUG_CPU


1222 i‡(
£tup_max_˝us
)

1223 
possibÀ
 +
dißbÀd_˝us
;

1225 i‡(
possibÀ
 > 
i
)

1226 
possibÀ
 = 
i
;

1229 
possibÀ
 = 
£tup_possibÀ_˝us
;

1231 
tŸÆ_˝us
 = 
	`max_t
(, 
possibÀ
, 
num_¥o˚ss‹s
 + 
dißbÀd_˝us
);

1234 i‡(
possibÀ
 > 
ƒ_˝u_ids
) {

1235 
	`¥ötk
(
KERN_WARNING


1237 
possibÀ
, 
ƒ_˝u_ids
);

1238 
possibÀ
 = 
ƒ_˝u_ids
;

1241 #ifde‡
CONFIG_HOTPLUG_CPU


1242 i‡(!
£tup_max_˝us
)

1244 i‡(
possibÀ
 > 
i
) {

1245 
	`¥ötk
(
KERN_WARNING


1247 
possibÀ
, 
£tup_max_˝us
);

1248 
possibÀ
 = 
i
;

1251 
	`¥ötk
(
KERN_INFO
 "SMP: Allowing %d CPUs, %d hotplug CPUs\n",

1252 
possibÀ
, 
	`max_t
(,ÖossibÀ - 
num_¥o˚ss‹s
, 0));

1254 
i
 = 0; i < 
possibÀ
; i++)

1255 
	`£t_˝u_possibÀ
(
i
, 
åue
);

1256 ; 
i
 < 
NR_CPUS
; i++)

1257 
	`£t_˝u_possibÀ
(
i
, 
Ál£
);

1259 
ƒ_˝u_ids
 = 
possibÀ
;

1260 
	}
}

1262 #ifde‡
CONFIG_HOTPLUG_CPU


1264 
	$ªmove_siblögöfo
(
˝u
)

1266 
siblög
;

1267 
˝uöfo_x86
 *
c
 = &
	`˝u_d©a
(
˝u
);

1269 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_c‹e_mask
(
˝u
)) {

1270 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_c‹e_mask
(
siblög
));

1274 i‡(
	`˝umask_weight
(
	`˝u_siblög_mask
(
˝u
)) == 1)

1275 
	`˝u_d©a
(
siblög
).
boŸed_c‹es
--;

1278 
	`f‹_óch_˝u
(
siblög
, 
	`˝u_siblög_mask
(
˝u
))

1279 
	`˝umask_˛ór_˝u
(
˝u
, 
	`˝u_siblög_mask
(
siblög
));

1280 
	`˝umask_˛ór
(
	`˝u_siblög_mask
(
˝u
));

1281 
	`˝umask_˛ór
(
	`˝u_c‹e_mask
(
˝u
));

1282 
c
->
phys_¥oc_id
 = 0;

1283 
c
->
˝u_c‹e_id
 = 0;

1284 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_siblög_£tup_mask
);

1285 
	}
}

1287 
__ªf
 
	$ªmove_˝u_‰om_m≠s
(
˝u
)

1289 
	`£t_˝u_⁄löe
(
˝u
, 
Ál£
);

1290 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒout_mask
);

1291 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_ˇŒö_mask
);

1293 
	`˝umask_˛ór_˝u
(
˝u
, 
˝u_öôülized_mask
);

1294 
	`numa_ªmove_˝u
(
˝u
);

1295 
	}
}

1297 
	$˝u_dißbÀ_comm⁄
()

1299 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1301 
	`ªmove_siblögöfo
(
˝u
);

1304 
	`lock_ve˘‹_lock
();

1305 
	`ªmove_˝u_‰om_m≠s
(
˝u
);

1306 
	`u∆ock_ve˘‹_lock
();

1307 
	`fixup_úqs
();

1308 
	}
}

1310 
	$«tive_˝u_dißbÀ
()

1312 
˝u
 = 
	`smp_¥o˚ss‹_id
();

1322 i‡(
˝u
 == 0)

1323  -
EBUSY
;

1325 i‡(
nmi_w©chdog
 =
NMI_LOCAL_APIC
)

1326 
	`°›_≠ic_nmi_w©chdog
(
NULL
);

1327 
	`˛ór_loˇl_APIC
();

1329 
	`˝u_dißbÀ_comm⁄
();

1331 
	}
}

1333 
	$«tive_˝u_dõ
(
˝u
)

1336 
i
;

1338 
i
 = 0; i < 10; i++) {

1340 i‡(
	`≥r_˝u
(
˝u_°©e
, 
˝u
Ë=
CPU_DEAD
) {

1341 i‡(
sy°em_°©e
 =
SYSTEM_RUNNING
)

1342 
	`¥_öfo
("CPU %u i†now ofÊöe\n", 
˝u
);

1344 i‡(1 =
	`num_⁄löe_˝us
())

1345 
	`Æã∫©ives_smp_swôch
(0);

1348 
	`m¶ìp
(100);

1350 
	`¥_îr
("CPU %u didn'àdõ...\n", 
˝u
);

1351 
	}
}

1353 
	$∂ay_dód_comm⁄
()

1355 
	`idÀ_èsk_exô
();

1356 
	`ª£t_œzy_éb°©e
();

1357 
	`úq_˘x_exô
(
	`øw_smp_¥o˚ss‹_id
());

1358 
	`c1e_ªmove_˝u
(
	`øw_smp_¥o˚ss‹_id
());

1360 
	`mb
();

1362 
	`__gë_˝u_v¨
(
˝u_°©e
Ë
CPU_DEAD
;

1367 
	`loˇl_úq_dißbÀ
();

1368 
	}
}

1370 
	$«tive_∂ay_dód
()

1372 
	`∂ay_dód_comm⁄
();

1373 
	`tboŸ_shutdown
(
TB_SHUTDOWN_WFS
);

1374 
	`wbövd_hÆt
();

1375 
	}
}

1378 
	$«tive_˝u_dißbÀ
()

1380  -
ENOSYS
;

1381 
	}
}

1383 
	$«tive_˝u_dõ
(
˝u
)

1386 
	`BUG
();

1387 
	}
}

1389 
	$«tive_∂ay_dód
()

1391 
	`BUG
();

1392 
	}
}

	@/cmpt816/linux/arch/x86/kernel/stacktrace.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/uac˚ss.h
>

10 
	~<asm/°ackåa˚.h
>

12 
	$ßve_°ack_w¨nög
(*
d©a
, *
msg
)

14 
	}
}

17 
	$ßve_°ack_w¨nög_symbﬁ
(*
d©a
, *
msg
, 
symbﬁ
)

19 
	}
}

21 
	$ßve_°ack_°ack
(*
d©a
, *
«me
)

24 
	}
}

26 
	$ßve_°ack_addªss
(*
d©a
, 
addr
, 
ªlübÀ
)

28 
°ack_åa˚
 *
åa˚
 = 
d©a
;

29 i‡(!
ªlübÀ
)

31 i‡(
åa˚
->
skù
 > 0) {

32 
åa˚
->
skù
--;

35 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

36 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

37 
	}
}

40 
	$ßve_°ack_addªss_nosched
(*
d©a
, 
addr
, 
ªlübÀ
)

42 
°ack_åa˚
 *
åa˚
 = (°ack_åa˚ *)
d©a
;

43 i‡(!
ªlübÀ
)

45 i‡(
	`ö_sched_fun˘i⁄s
(
addr
))

47 i‡(
åa˚
->
skù
 > 0) {

48 
åa˚
->
skù
--;

51 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
addr
;

53 
	}
}

55 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s
 = {

56 .
w¨nög
 = 
ßve_°ack_w¨nög
,

57 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

58 .
	g°ack
 = 
ßve_°ack_°ack
,

59 .
	gaddªss
 = 
ßve_°ack_addªss
,

60 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

63 c⁄° 
°ackåa˚_›s
 
	gßve_°ack_›s_nosched
 = {

64 .
w¨nög
 = 
ßve_°ack_w¨nög
,

65 .
	gw¨nög_symbﬁ
 = 
ßve_°ack_w¨nög_symbﬁ
,

66 .
	g°ack
 = 
ßve_°ack_°ack
,

67 .
	gaddªss
 = 
ßve_°ack_addªss_nosched
,

68 .
	gwÆk_°ack
 = 
¥öt_c⁄ãxt_°ack
,

74 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

76 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 0, &
ßve_°ack_›s
, 
åa˚
);

77 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

78 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

79 
	}
}

80 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚
);

82 
	$ßve_°ack_åa˚_bp
(
°ack_åa˚
 *
åa˚
, 
bp
)

84 
	`dump_åa˚
(
cuºít
, 
NULL
, NULL, 
bp
, &
ßve_°ack_›s
, 
åa˚
);

85 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

86 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

87 
	}
}

89 
	$ßve_°ack_åa˚_tsk
(
èsk_°ru˘
 *
tsk
, 
°ack_åa˚
 *
åa˚
)

91 
	`dump_åa˚
(
tsk
, 
NULL
, NULL, 0, &
ßve_°ack_›s_nosched
, 
åa˚
);

92 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

93 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

94 
	}
}

95 
EXPORT_SYMBOL_GPL
(
ßve_°ack_åa˚_tsk
);

99 
	s°ack_‰ame
 {

100 c⁄° 
__u£r
 *
	m√xt_Â
;

101 
	mªt_addr
;

104 
	$c›y_°ack_‰ame
(c⁄° 
__u£r
 *
Â
, 
°ack_‰ame
 *
‰ame
)

106 
ªt
;

108 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
Â
, (*
‰ame
)))

111 
ªt
 = 1;

112 
	`∑geÁu…_dißbÀ
();

113 i‡(
	`__c›y_‰om_u£r_ö©omic
(
‰ame
, 
Â
, (*frame)))

114 
ªt
 = 0;

115 
	`∑geÁu…_íabÀ
();

117  
ªt
;

118 
	}
}

120 
ölöe
 
	$__ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

122 c⁄° 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

123 c⁄° 
__u£r
 *
Â
 = (c⁄° __u£∏*)
ªgs
->
bp
;

125 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

126 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ªgs
->
ù
;

128 
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
) {

129 
°ack_‰ame
 
‰ame
;

131 
‰ame
.
√xt_Â
 = 
NULL
;

132 
‰ame
.
ªt_addr
 = 0;

133 i‡(!
	`c›y_°ack_‰ame
(
Â
, &
‰ame
))

135 i‡(()
Â
 < 
ªgs
->
•
)

137 i‡(
‰ame
.
ªt_addr
) {

138 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] =

139 
‰ame
.
ªt_addr
;

141 i‡(
Â
 =
‰ame
.
√xt_Â
)

143 
Â
 = 
‰ame
.
√xt_Â
;

145 
	}
}

147 
	$ßve_°ack_åa˚_u£r
(
°ack_åa˚
 *
åa˚
)

152 i‡(
cuºít
->
mm
) {

153 
	`__ßve_°ack_åa˚_u£r
(
åa˚
);

155 i‡(
åa˚
->
ƒ_íåõs
 <Åø˚->
max_íåõs
)

156 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
ULONG_MAX
;

157 
	}
}

	@/cmpt816/linux/arch/x86/kernel/step.c

4 
	~<löux/sched.h
>

5 
	~<löux/mm.h
>

6 
	~<löux/±ø˚.h
>

7 
	~<asm/desc.h
>

9 
	$c⁄vît_ù_to_löór
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

11 
addr
, 
£g
;

13 
addr
 = 
ªgs
->
ù
;

14 
£g
 = 
ªgs
->
cs
 & 0xffff;

15 i‡(
	`v8086_mode
(
ªgs
)) {

16 
addr
 = (add∏& 0xffffË+ (
£g
 << 4);

17  
addr
;

26 i‡((
£g
 & 
SEGMENT_TI_MASK
Ë=
SEGMENT_LDT
) {

27 
desc_°ru˘
 *
desc
;

28 
ba£
;

30 
£g
 &= ~7UL;

32 
	`muãx_lock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

33 i‡(
	`u∆ikñy
((
£g
 >> 3Ë>
chûd
->
mm
->
c⁄ãxt
.
size
))

34 
addr
 = -1L;

36 
desc
 = 
chûd
->
mm
->
c⁄ãxt
.
ldt
 + 
£g
;

37 
ba£
 = 
	`gë_desc_ba£
(
desc
);

40 i‡(!
desc
->
d
)

41 
addr
 &= 0xffff;

42 
addr
 +
ba£
;

44 
	`muãx_u∆ock
(&
chûd
->
mm
->
c⁄ãxt
.
lock
);

47  
addr
;

48 
	}
}

50 
	$is_£âög_å≠_Êag
(
èsk_°ru˘
 *
chûd
, 
±_ªgs
 *
ªgs
)

52 
i
, 
c›õd
;

53 
›code
[15];

54 
addr
 = 
	`c⁄vît_ù_to_löór
(
chûd
, 
ªgs
);

56 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, 
›code
, (opcode), 0);

57 
i
 = 0; i < 
c›õd
; i++) {

58 
›code
[
i
]) {

75 #ifde‡
CONFIG_X86_64


77 i‡(
ªgs
->
cs
 !
__USER_CS
)

99 
	}
}

104 
	$íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

106 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

107 
oÊags
;

119 i‡(
	`u∆ikñy
(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
)))

120 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

127 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

129 
oÊags
 = 
ªgs
->
Êags
;

132 
ªgs
->
Êags
 |
X86_EFLAGS_TF
;

143 i‡(
	`is_£âög_å≠_Êag
(
chûd
, 
ªgs
)) {

144 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

152 i‡(
oÊags
 & 
X86_EFLAGS_TF
)

153  
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

155 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
);

158 
	}
}

163 
	$íabÀ_°ï
(
èsk_°ru˘
 *
chûd
, 
boﬁ
 
block
)

172 i‡(
	`íabÀ_sögÀ_°ï
(
chûd
Ë&& 
block
) {

173 
debug˘l
 = 
	`gë_debug˘lm§
();

175 
debug˘l
 |
DEBUGCTLMSR_BTF
;

176 
	`upd©e_debug˘lm§
(
debug˘l
);

177 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_BLOCKSTEP
);

178 } i‡(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_BLOCKSTEP
)) {

179 
debug˘l
 = 
	`gë_debug˘lm§
();

181 
debug˘l
 &~
DEBUGCTLMSR_BTF
;

182 
	`upd©e_debug˘lm§
(
debug˘l
);

183 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_BLOCKSTEP
);

185 
	}
}

187 
	$u£r_íabÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

189 
	`íabÀ_°ï
(
chûd
, 0);

190 
	}
}

192 
	$u£r_íabÀ_block_°ï
(
èsk_°ru˘
 *
chûd
)

194 
	`íabÀ_°ï
(
chûd
, 1);

195 
	}
}

197 
	$u£r_dißbÀ_sögÀ_°ï
(
èsk_°ru˘
 *
chûd
)

202 i‡(
	`ã°_tsk_thªad_Êag
(
chûd
, 
TIF_BLOCKSTEP
)) {

203 
debug˘l
 = 
	`gë_debug˘lm§
();

205 
debug˘l
 &~
DEBUGCTLMSR_BTF
;

206 
	`upd©e_debug˘lm§
(
debug˘l
);

207 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_BLOCKSTEP
);

211 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SINGLESTEP
);

214 i‡(
	`ã°_™d_˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_FORCED_TF
))

215 
	`èsk_±_ªgs
(
chûd
)->
Êags
 &~
X86_EFLAGS_TF
;

216 
	}
}

	@/cmpt816/linux/arch/x86/kernel/sys_x86_64.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/sysˇŒs.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/fs.h
>

6 
	~<löux/smp.h
>

7 
	~<löux/£m.h
>

8 
	~<löux/msg.h
>

9 
	~<löux/shm.h
>

10 
	~<löux/°©.h
>

11 
	~<löux/mm™.h
>

12 
	~<löux/fûe.h
>

13 
	~<löux/ut¢ame.h
>

14 
	~<löux/≥rs⁄Æôy.h
>

15 
	~<löux/øndom.h
>

16 
	~<löux/uac˚ss.h
>

18 
	~<asm/ü32.h
>

19 
	~<asm/sysˇŒs.h
>

21 
	$SYSCALL_DEFINE6
(
mm≠
, , 
addr
, , 
Àn
,

22 , 
¥Ÿ
, , 
Êags
,

23 , 
fd
, , 
off
)

25 
îr‹
;

26 
îr‹
 = -
EINVAL
;

27 i‡(
off
 & ~
PAGE_MASK
)

28 
out
;

30 
îr‹
 = 
	`sys_mm≠_pgoff
(
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
fd
, 
off
 >> 
PAGE_SHIFT
);

31 
out
:

32  
îr‹
;

33 
	}
}

35 
	$föd_°¨t_íd
(
Êags
, *
begö
,

36 *
íd
)

38 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
)) {

39 
√w_begö
;

47 *
begö
 = 0x40000000;

48 *
íd
 = 0x80000000;

49 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

50 
√w_begö
 = 
	`øndomize_ønge
(*
begö
, *begin + 0x02000000, 0);

51 i‡(
√w_begö
)

52 *
begö
 = 
√w_begö
;

55 *
begö
 = 
TASK_UNMAPPED_BASE
;

56 *
íd
 = 
TASK_SIZE
;

58 
	}
}

61 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

62 
Àn
, 
pgoff
, 
Êags
)

64 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

65 
vm_¨ó_°ru˘
 *
vma
;

66 
°¨t_addr
;

67 
begö
, 
íd
;

69 i‡(
Êags
 & 
MAP_FIXED
)

70  
addr
;

72 
	`föd_°¨t_íd
(
Êags
, &
begö
, &
íd
);

74 i‡(
Àn
 > 
íd
)

75  -
ENOMEM
;

77 i‡(
addr
) {

78 
addr
 = 
	`PAGE_ALIGN
(addr);

79 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

80 i‡(
íd
 - 
Àn
 >
addr
 &&

81 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

82  
addr
;

84 i‡(((
Êags
 & 
MAP_32BIT
Ë|| 
	`ã°_thªad_Êag
(
TIF_IA32
))

85 && 
Àn
 <
mm
->
ˇched_hﬁe_size
) {

86 
mm
->
ˇched_hﬁe_size
 = 0;

87 
mm
->
‰ì_¨ó_ˇche
 = 
begö
;

89 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

90 i‡(
addr
 < 
begö
)

91 
addr
 = 
begö
;

92 
°¨t_addr
 = 
addr
;

94 
fuŒ_£¨ch
:

95 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

97 i‡(
íd
 - 
Àn
 < 
addr
) {

102 i‡(
°¨t_addr
 !
begö
) {

103 
°¨t_addr
 = 
addr
 = 
begö
;

104 
mm
->
ˇched_hﬁe_size
 = 0;

105 
fuŒ_£¨ch
;

107  -
ENOMEM
;

109 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

113 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

114  
addr
;

116 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

117 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

119 
addr
 = 
vma
->
vm_íd
;

121 
	}
}

125 
	$¨ch_gë_unm≠≥d_¨ó_t›down
(
fûe
 *
fûp
, c⁄° 
addr0
,

126 c⁄° 
Àn
, c⁄° 
pgoff
,

127 c⁄° 
Êags
)

129 
vm_¨ó_°ru˘
 *
vma
;

130 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

131 
addr
 = 
addr0
;

134 i‡(
Àn
 > 
TASK_SIZE
)

135  -
ENOMEM
;

137 i‡(
Êags
 & 
MAP_FIXED
)

138  
addr
;

141 i‡(!
	`ã°_thªad_Êag
(
TIF_IA32
Ë&& (
Êags
 & 
MAP_32BIT
))

142 
bŸtomup
;

145 i‡(
addr
) {

146 
addr
 = 
	`PAGE_ALIGN
(addr);

147 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

148 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

149 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

150  
addr
;

154 i‡(
Àn
 <
mm
->
ˇched_hﬁe_size
) {

155 
mm
->
ˇched_hﬁe_size
 = 0;

156 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

160 
addr
 = 
mm
->
‰ì_¨ó_ˇche
;

163 i‡(
addr
 > 
Àn
) {

164 
vma
 = 
	`föd_vma
(
mm
, 
addr
-
Àn
);

165 i‡(!
vma
 || 
addr
 <vma->
vm_°¨t
)

167  
mm
->
‰ì_¨ó_ˇche
 = 
addr
-
Àn
;

170 i‡(
mm
->
mm≠_ba£
 < 
Àn
)

171 
bŸtomup
;

173 
addr
 = 
mm
->
mm≠_ba£
-
Àn
;

181 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

182 i‡(!
vma
 || 
addr
+
Àn
 <vma->
vm_°¨t
)

184  
mm
->
‰ì_¨ó_ˇche
 = 
addr
;

187 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

188 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

191 
addr
 = 
vma
->
vm_°¨t
-
Àn
;

192 } 
Àn
 < 
vma
->
vm_°¨t
);

194 
bŸtomup
:

201 
mm
->
ˇched_hﬁe_size
 = ~0UL;

202 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

203 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó
(
fûp
, 
addr0
, 
Àn
, 
pgoff
, 
Êags
);

207 
mm
->
‰ì_¨ó_ˇche
 = mm->
mm≠_ba£
;

208 
mm
->
ˇched_hﬁe_size
 = ~0UL;

210  
addr
;

211 
	}
}

	@/cmpt816/linux/arch/x86/kernel/syscall_64.c

3 
	~<löux/lökage.h
>

4 
	~<löux/sys.h
>

5 
	~<löux/ˇche.h
>

6 
	~<asm/asm-off£ts.h
>

8 
	#__NO_STUBS


	)

10 
	#__SYSCALL
(
ƒ
, 
sym
Ë
asmlökage
 
	`sym
(Ë;

	)

11 #unde‡
_ASM_X86_UNISTD_64_H


12 
	~<asm/uni°d_64.h
>

14 #unde‡
__SYSCALL


15 
	#__SYSCALL
(
ƒ
, 
sym
Ë[ƒ] = sym,

	)

16 #unde‡
_ASM_X86_UNISTD_64_H


18 (*
	tsys_ˇŒ_±r_t
)();

20 
	`sys_ni_sysˇŒ
();

22 c⁄° 
sys_ˇŒ_±r_t
 
sys_ˇŒ_èbÀ
[
__NR_sysˇŒ_max
+1] = {

27 [0 ... 
__NR_sysˇŒ_max
] = &
sys_ni_sysˇŒ
,

28 
	~<asm/uni°d_64.h
>

29 
	}
};

	@/cmpt816/linux/arch/x86/kernel/tce_64.c

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/•ölock.h
>

30 
	~<löux/°rög.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/dma-m≠pög.h
>

33 
	~<löux/boŸmem.h
>

34 
	~<asm/t˚.h
>

35 
	~<asm/ˇlg¨y.h
>

36 
	~<asm/¥Ÿo.h
>

39 
ölöe
 
	$Êush_t˚
(* 
t˚addr
)

42 i‡(
˝u_has_˛Êush
)

43 
	`˛Êush
(
t˚addr
);

45 
	`wbövd
();

46 
	}
}

48 
	$t˚_buûd
(
iommu_èbÀ
 *
tbl
, 
ödex
,

49 
≈ages
, 
uaddr
, 
dúe˘i⁄
)

51 
u64
* 
ç
;

52 
u64
 
t
;

53 
u64
 
Ωn
;

55 
t
 = (1 << 
TCE_READ_SHIFT
);

56 i‡(
dúe˘i⁄
 !
DMA_TO_DEVICE
)

57 
t
 |(1 << 
TCE_WRITE_SHIFT
);

59 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

61 
≈ages
--) {

62 
Ωn
 = (
	`vút_to_bus
((*)
uaddr
)Ë>> 
PAGE_SHIFT
;

63 
t
 &~
TCE_RPN_MASK
;

64 
t
 |(
Ωn
 << 
TCE_RPN_SHIFT
);

66 *
ç
 = 
	`˝u_to_be64
(
t
);

67 
	`Êush_t˚
(
ç
);

69 
uaddr
 +
PAGE_SIZE
;

70 
ç
++;

72 
	}
}

74 
	$t˚_‰ì
(
iommu_èbÀ
 *
tbl
, 
ödex
, 
≈ages
)

76 
u64
* 
ç
;

78 
ç
 = ((
u64
*)
tbl
->
ô_ba£
Ë+ 
ödex
;

80 
≈ages
--) {

81 *
ç
 = 
	`˝u_to_be64
(0);

82 
	`Êush_t˚
(
ç
);

83 
ç
++;

85 
	}
}

87 
ölöe
 
	$èbÀ_size_to_numbî_of_íåõs
(
size
)

94  (1 << 
size
) << 13;

95 
	}
}

97 
	$t˚_èbÀ_£ç¨ms
(
pci_dev
 *
dev
, 
iommu_èbÀ
 *
tbl
)

99 
bôm≠sz
;

100 
bmµages
;

101 
ªt
;

103 
tbl
->
ô_bu¢o
 = 
dev
->
bus
->
numbî
;

106 
tbl
->
ô_size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

112 
bôm≠sz
 = 
tbl
->
ô_size
 / 
BITS_PER_BYTE
;

113 
bmµages
 = 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
bôm≠sz
));

114 i‡(!
bmµages
) {

115 
	`¥ötk
(
KERN_ERR
 "Calgary: cannotállocate bitmap\n");

116 
ªt
 = -
ENOMEM
;

117 
d⁄e
;

120 
tbl
->
ô_m≠
 = (*)
bmµages
;

122 
	`mem£t
(
tbl
->
ô_m≠
, 0, 
bôm≠sz
);

124 
tbl
->
ô_höt
 = 0;

126 
	`•ö_lock_öô
(&
tbl
->
ô_lock
);

130 
d⁄e
:

131  
ªt
;

132 
	}
}

134 
__öô
 
	$buûd_t˚_èbÀ
(
pci_dev
 *
dev
, 
__iomem
 *
bb¨
)

136 
iommu_èbÀ
 *
tbl
;

137 
ªt
;

139 i‡(
	`pci_iommu
(
dev
->
bus
)) {

140 
	`¥ötk
(
KERN_ERR
 "Calgary: dev %p has sysdata->iommu %p\n",

141 
dev
, 
	`pci_iommu
(dev->
bus
));

142 
	`BUG
();

145 
tbl
 = 
	`kzÆloc
((
iommu_èbÀ
), 
GFP_KERNEL
);

146 i‡(!
tbl
) {

147 
	`¥ötk
(
KERN_ERR
 "Calgary:Érrorállocating iommu_table\n");

148 
ªt
 = -
ENOMEM
;

149 
d⁄e
;

152 
ªt
 = 
	`t˚_èbÀ_£ç¨ms
(
dev
, 
tbl
);

153 i‡(
ªt
)

154 
‰ì_tbl
;

156 
tbl
->
bb¨
 = bbar;

158 
	`£t_pci_iommu
(
dev
->
bus
, 
tbl
);

162 
‰ì_tbl
:

163 
	`k‰ì
(
tbl
);

164 
d⁄e
:

165  
ªt
;

166 
	}
}

168 * 
__öô
 
	$Æloc_t˚_èbÀ
()

170 
size
;

172 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

173 
size
 *
TCE_ENTRY_SIZE
;

175  
	`__Æloc_boŸmem_low
(
size
, size, 0);

176 
	}
}

178 
__öô
 
	$‰ì_t˚_èbÀ
(*
tbl
)

180 
size
;

182 i‡(!
tbl
)

185 
size
 = 
	`èbÀ_size_to_numbî_of_íåõs
(
•ecifõd_èbÀ_size
);

186 
size
 *
TCE_ENTRY_SIZE
;

188 
	`‰ì_boŸmem
(
	`__∑
(
tbl
), 
size
);

189 
	}
}

	@/cmpt816/linux/arch/x86/kernel/test_nx.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/s‹t.h
>

14 
	~<löux/¶ab.h
>

16 
	~<asm/uac˚ss.h
>

17 
	~<asm/asm.h
>

19 
rod©a_ã°_d©a
;

45 
	$fudze_ex˚±i⁄_èbÀ
(*
m¨kî
, *
√w
)

47 
moduÀ
 *
mod
 = 
THIS_MODULE
;

48 
ex˚±i⁄_èbÀ_íåy
 *
exèbÀ
;

56 i‡(
mod
->
num_exíåõs
 > 1) {

57 
	`¥ötk
(
KERN_ERR
 "test_nx:Åoo manyÉxceptionÅableÉntries!\n");

58 
	`¥ötk
(
KERN_ERR
 "test_nx:ÅestÑesultsáreÇotÑeliable.\n");

61 
exèbÀ
 = (
ex˚±i⁄_èbÀ_íåy
 *)
mod
->extable;

62 
exèbÀ
[0].
ö¢
 = ()
√w
;

63 
	}
}

71 
foo_œbñ
();

80 
noölöe
 
	$ã°_addªss
(*
addªss
)

82 
ªsu…
;

85 
	`fudze_ex˚±i⁄_èbÀ
(&
foo_œbñ
, 
addªss
);

86 
ªsu…
 = 1;

87 
asm
 volatile(

95 
	`_ASM_EXTABLE
(0b,2b)

96 : [
r¶t
] "Ù" (
ªsu…
)

97 : [
Áke_code
] "r" (
addªss
), [
zîo
] "r" (0UL), "0" (
ªsu…
)

100 
	`fudze_ex˚±i⁄_èbÀ
(
addªss
, &
foo_œbñ
);

102 i‡(
ªsu…
)

103  -
ENODEV
;

105 
	}
}

107 
	gã°_d©a
 = 0xC3;

109 
	$ã°_NX
()

111 
ªt
 = 0;

113 
°ackcode
[] = {0xC3, 0x90, 0 };

114 *
hóp
;

116 
ã°_d©a
 = 0xC3;

118 
	`¥ötk
(
KERN_INFO
 "Testing NXÖrotection\n");

121 i‡(
	`ã°_addªss
(&
°ackcode
)) {

122 
	`¥ötk
(
KERN_ERR
 "test_nx: stack wasÉxecutable\n");

123 
ªt
 = -
ENODEV
;

128 
hóp
 = 
	`kmÆloc
(64, 
GFP_KERNEL
);

129 i‡(!
hóp
)

130  -
ENOMEM
;

131 
hóp
[0] = 0xC3;

133 i‡(
	`ã°_addªss
(
hóp
)) {

134 
	`¥ötk
(
KERN_ERR
 "test_nx: heap wasÉxecutable\n");

135 
ªt
 = -
ENODEV
;

137 
	`k‰ì
(
hóp
);

145 #ifde‡
CONFIG_DEBUG_RODATA


147 i‡(
rod©a_ã°_d©a
 != 0xC3) {

148 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata marker has invalid value\n");

149 
ªt
 = -
ENODEV
;

150 } i‡(
	`ã°_addªss
(&
rod©a_ã°_d©a
)) {

151 
	`¥ötk
(
KERN_ERR
 "test_nx: .rodata section isÉxecutable\n");

152 
ªt
 = -
ENODEV
;

158 i‡(
	`ã°_addªss
(&
ã°_d©a
)) {

159 
	`¥ötk
(
KERN_ERR
 "test_nx: .data section isÉxecutable\n");

160 
ªt
 = -
ENODEV
;

165 
	}
}

167 
	$ã°_exô
()

169 
	}
}

171 
moduÀ_öô
(
ã°_NX
);

172 
moduÀ_exô
(
ã°_exô
);

173 
MODULE_LICENSE
("GPL");

174 
MODULE_DESCRIPTION
("Testcase forÅhe NX infrastructure");

175 
MODULE_AUTHOR
("Arjan van de Ven <arjan@linux.intel.com>");

	@/cmpt816/linux/arch/x86/kernel/time.c

12 
	~<löux/˛ockchùs.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/time.h
>

15 
	~<löux/mˇ.h
>

17 
	~<asm/vsysˇŒ.h
>

18 
	~<asm/x86_öô.h
>

19 
	~<asm/i8259.h
>

20 
	~<asm/i8253.h
>

21 
	~<asm/timî.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/time.h
>

25 #i‡
deföed
(
CONFIG_X86_32
Ë&& deföed(
CONFIG_X86_IO_APIC
)

26 
	gtimî_ack
;

29 #ifde‡
CONFIG_X86_64


30 vﬁ©ûê
__jiffõs
 
	g__£˘i⁄_jiffõs
 = 
INITIAL_JIFFIES
;

33 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

35 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

37 i‡(!
	`u£r_mode_vm
(
ªgs
Ë&& 
	`ö_lock_fun˘i⁄s
(
pc
)) {

38 #ifde‡
CONFIG_FRAME_POINTER


39  *(*)(
ªgs
->
bp
 + ());

41 *
•
 =

42 (*)
	`kî√l_°ack_poöãr
(
ªgs
);

48 i‡(
•
[0] >> 22)

49  
•
[0];

50 i‡(
•
[1] >> 22)

51  
•
[1];

54  
pc
;

55 
	}
}

56 
EXPORT_SYMBOL
(
¥ofûe_pc
);

61 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

64 
	`öc_úq_°©
(
úq0_úqs
);

67 i‡(
timî_ack
) {

73 
	`øw_•ö_lock
(&
i8259A_lock
);

74 
	`outb
(0x0c, 
PIC_MASTER_OCW3
);

76 
	`öb
(
PIC_MASTER_POLL
);

77 
	`øw_•ö_u∆ock
(&
i8259A_lock
);

80 
globÆ_˛ock_evít
->
	`evít_h™dÀr
(global_clock_event);

83 i‡(
MCA_bus
)

84 
	`outb_p
(
	`öb_p
(0x61)| 0x80, 0x61);

86  
IRQ_HANDLED
;

87 
	}
}

89 
úqa˘i⁄
 
	gúq0
 = {

90 .
h™dÀr
 = 
timî_öãºu±
,

91 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_NOBALANCING
 | 
IRQF_IRQPOLL
 | 
IRQF_TIMER
,

92 .
	g«me
 = "timer"

95 
__öô
 
	$£tup_deÁu…_timî_úq
()

97 
	`£tup_úq
(0, &
úq0
);

98 
	}
}

101 
__öô
 
	$h≥t_time_öô
()

103 i‡(!
	`h≥t_íabÀ
())

104 
	`£tup_pô_timî
();

105 
	`£tup_deÁu…_timî_úq
();

106 
	}
}

108 
__öô
 
	$x86_œã_time_öô
()

110 
x86_öô
.
timîs
.
	`timî_öô
();

111 
	`tsc_öô
();

112 
	}
}

118 
__öô
 
	$time_öô
()

120 
œã_time_öô
 = 
x86_œã_time_öô
;

121 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tls.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/u£r.h
>

5 
	~<löux/ªg£t.h
>

7 
	~<asm/uac˚ss.h
>

8 
	~<asm/desc.h
>

9 
	~<asm/sy°em.h
>

10 
	~<asm/ldt.h
>

11 
	~<asm/¥o˚ss‹.h
>

12 
	~<asm/¥Ÿo.h
>

13 
	~<asm/sysˇŒs.h
>

15 
	~"és.h
"

20 
	$gë_‰ì_idx
()

22 
thªad_°ru˘
 *
t
 = &
cuºít
->
thªad
;

23 
idx
;

25 
idx
 = 0; idx < 
GDT_ENTRY_TLS_ENTRIES
; idx++)

26 i‡(
	`desc_em±y
(&
t
->
és_¨øy
[
idx
]))

27  
idx
 + 
GDT_ENTRY_TLS_MIN
;

28  -
ESRCH
;

29 
	}
}

31 
	$£t_és_desc
(
èsk_°ru˘
 *
p
, 
idx
,

32 c⁄° 
u£r_desc
 *
öfo
, 
n
)

34 
thªad_°ru˘
 *
t
 = &
p
->
thªad
;

35 
desc_°ru˘
 *
desc
 = &
t
->
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
];

36 
˝u
;

41 
˝u
 = 
	`gë_˝u
();

43 
n
-- > 0) {

44 i‡(
	`LDT_em±y
(
öfo
))

45 
desc
->
a
 = desc->
b
 = 0;

47 
	`fûl_ldt
(
desc
, 
öfo
);

48 ++
öfo
;

49 ++
desc
;

52 i‡(
t
 =&
cuºít
->
thªad
)

53 
	`lﬂd_TLS
(
t
, 
˝u
);

55 
	`put_˝u
();

56 
	}
}

61 
	$do_£t_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

62 
u£r_desc
 
__u£r
 *
u_öfo
,

63 
ˇn_Æloˇã
)

65 
u£r_desc
 
öfo
;

67 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
u_öfo
, (info)))

68  -
EFAULT
;

70 i‡(
idx
 == -1)

71 
idx
 = 
öfo
.
íåy_numbî
;

77 i‡(
idx
 =-1 && 
ˇn_Æloˇã
) {

78 
idx
 = 
	`gë_‰ì_idx
();

79 i‡(
idx
 < 0)

80  
idx
;

81 i‡(
	`put_u£r
(
idx
, &
u_öfo
->
íåy_numbî
))

82  -
EFAULT
;

85 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

86  -
EINVAL
;

88 
	`£t_és_desc
(
p
, 
idx
, &
öfo
, 1);

91 
	}
}

93 
asmlökage
 
	$sys_£t_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

95 
ªt
 = 
	`do_£t_thªad_¨ó
(
cuºít
, -1, 
u_öfo
, 1);

96 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

97  
ªt
;

98 
	}
}

105 
	$fûl_u£r_desc
(
u£r_desc
 *
öfo
, 
idx
,

106 c⁄° 
desc_°ru˘
 *
desc
)

109 
	`mem£t
(
öfo
, 0, (*info));

110 
öfo
->
íåy_numbî
 = 
idx
;

111 
öfo
->
ba£_addr
 = 
	`gë_desc_ba£
(
desc
);

112 
öfo
->
limô
 = 
	`gë_desc_limô
(
desc
);

113 
öfo
->
£g_32bô
 = 
desc
->
d
;

114 
öfo
->
c⁄ã¡s
 = 
desc
->
ty≥
 >> 2;

115 
öfo
->
ªad_exec_⁄ly
 = !(
desc
->
ty≥
 & 2);

116 
öfo
->
limô_ö_∑ges
 = 
desc
->
g
;

117 
öfo
->
£g_nŸ_¥e£¡
 = !
desc
->
p
;

118 
öfo
->
u£abÀ
 = 
desc
->
avl
;

119 #ifde‡
CONFIG_X86_64


120 
öfo
->
lm
 = 
desc
->
l
;

122 
	}
}

124 
	$do_gë_thªad_¨ó
(
èsk_°ru˘
 *
p
, 
idx
,

125 
u£r_desc
 
__u£r
 *
u_öfo
)

127 
u£r_desc
 
öfo
;

129 i‡(
idx
 =-1 && 
	`gë_u£r
(idx, &
u_öfo
->
íåy_numbî
))

130  -
EFAULT
;

132 i‡(
idx
 < 
GDT_ENTRY_TLS_MIN
 || idx > 
GDT_ENTRY_TLS_MAX
)

133  -
EINVAL
;

135 
	`fûl_u£r_desc
(&
öfo
, 
idx
,

136 &
p
->
thªad
.
és_¨øy
[
idx
 - 
GDT_ENTRY_TLS_MIN
]);

138 i‡(
	`c›y_to_u£r
(
u_öfo
, &
öfo
, (info)))

139  -
EFAULT
;

141 
	}
}

143 
asmlökage
 
	$sys_gë_thªad_¨ó
(
u£r_desc
 
__u£r
 *
u_öfo
)

145 
ªt
 = 
	`do_gë_thªad_¨ó
(
cuºít
, -1, 
u_öfo
);

146 
	`asmlökage_¥Ÿe˘
(1, 
ªt
, 
u_öfo
);

147  
ªt
;

148 
	}
}

150 
	$ªg£t_és_a˘ive
(
èsk_°ru˘
 *
èrgë
,

151 c⁄° 
u£r_ªg£t
 *
ªg£t
)

153 
thªad_°ru˘
 *
t
 = &
èrgë
->
thªad
;

154 
n
 = 
GDT_ENTRY_TLS_ENTRIES
;

155 
n
 > 0 && 
	`desc_em±y
(&
t
->
és_¨øy
[n - 1]))

156 --
n
;

157  
n
;

158 
	}
}

160 
	$ªg£t_és_gë
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

161 
pos
, 
cou¡
,

162 *
kbuf
, 
__u£r
 *
ubuf
)

164 c⁄° 
desc_°ru˘
 *
és
;

166 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

167 (
pos
 % (
u£r_desc
)) != 0 ||

168 (
cou¡
 % (
u£r_desc
)) != 0)

169  -
EINVAL
;

171 
pos
 /(
u£r_desc
);

172 
cou¡
 /(
u£r_desc
);

174 
és
 = &
èrgë
->
thªad
.
és_¨øy
[
pos
];

176 i‡(
kbuf
) {

177 
u£r_desc
 *
öfo
 = 
kbuf
;

178 
cou¡
-- > 0)

179 
	`fûl_u£r_desc
(
öfo
++, 
GDT_ENTRY_TLS_MIN
 + 
pos
++,

180 
és
++);

182 
u£r_desc
 
__u£r
 *
u_öfo
 = 
ubuf
;

183 
cou¡
-- > 0) {

184 
u£r_desc
 
öfo
;

185 
	`fûl_u£r_desc
(&
öfo
, 
GDT_ENTRY_TLS_MIN
 + 
pos
++, 
és
++);

186 i‡(
	`__c›y_to_u£r
(
u_öfo
++, &
öfo
, (info)))

187  -
EFAULT
;

192 
	}
}

194 
	$ªg£t_és_£t
(
èsk_°ru˘
 *
èrgë
, c⁄° 
u£r_ªg£t
 *
ªg£t
,

195 
pos
, 
cou¡
,

196 c⁄° *
kbuf
, c⁄° 
__u£r
 *
ubuf
)

198 
u£r_desc
 
öfobuf
[
GDT_ENTRY_TLS_ENTRIES
];

199 c⁄° 
u£r_desc
 *
öfo
;

201 i‡(
pos
 > 
GDT_ENTRY_TLS_ENTRIES
 * (
u£r_desc
) ||

202 (
pos
 % (
u£r_desc
)) != 0 ||

203 (
cou¡
 % (
u£r_desc
)) != 0)

204  -
EINVAL
;

206 i‡(
kbuf
)

207 
öfo
 = 
kbuf
;

208 i‡(
	`__c›y_‰om_u£r
(
öfobuf
, 
ubuf
, 
cou¡
))

209  -
EFAULT
;

211 
öfo
 = 
öfobuf
;

213 
	`£t_és_desc
(
èrgë
,

214 
GDT_ENTRY_TLS_MIN
 + (
pos
 / (
u£r_desc
)),

215 
öfo
, 
cou¡
 / (
u£r_desc
));

218 
	}
}

	@/cmpt816/linux/arch/x86/kernel/topology.c

28 
	~<löux/nodemask.h
>

29 
	~<löux/mmz⁄e.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/smp.h
>

32 
	~<asm/˝u.h
>

34 
DEFINE_PER_CPU
(
x86_˝u
, 
˝u_devi˚s
);

36 #ifde‡
CONFIG_HOTPLUG_CPU


37 
__ªf
 
	$¨ch_ªgi°î_˝u
(
num
)

48 i‡(
num
)

49 
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
.
hŸ∂uggabÀ
 = 1;

51  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

52 
	}
}

53 
EXPORT_SYMBOL
(
¨ch_ªgi°î_˝u
);

55 
	$¨ch_uƒegi°î_˝u
(
num
)

57 
	`uƒegi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
);

58 
	}
}

59 
EXPORT_SYMBOL
(
¨ch_uƒegi°î_˝u
);

62 
__öô
 
	$¨ch_ªgi°î_˝u
(
num
)

64  
	`ªgi°î_˝u
(&
	`≥r_˝u
(
˝u_devi˚s
, 
num
).
˝u
,Çum);

65 
	}
}

68 
__öô
 
	$t›ﬁogy_öô
()

70 
i
;

72 #ifde‡
CONFIG_NUMA


73 
	`f‹_óch_⁄löe_node
(
i
)

74 
	`ªgi°î_⁄e_node
(
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
i
)

78 
	`¨ch_ªgi°î_˝u
(
i
);

81 
	}
}

82 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

	@/cmpt816/linux/arch/x86/kernel/trampoline.c

1 
	~<löux/io.h
>

3 
	~<asm/åampﬁöe.h
>

4 
	~<asm/e820.h
>

6 #i‡
deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_ACPI_SLEEP
)

7 
	#__åampöô


	)

8 
	#__åampöôd©a


	)

10 
	#__åampöô
 
__˝uöô


	)

11 
	#__åampöôd©a
 
__˝uöôd©a


	)

15 *
__åampöôd©a
 
	gåampﬁöe_ba£
;

17 
__öô
 
	$ª£rve_åampﬁöe_mem‹y
()

19 
mem
;

22 
mem
 = 
	`föd_e820_¨ó
(0, 1<<20, 
TRAMPOLINE_SIZE
, 
PAGE_SIZE
);

23 i‡(
mem
 == -1L)

24 
	`∑nic
("CannotállocateÅrampoline\n");

26 
åampﬁöe_ba£
 = 
	`__va
(
mem
);

27 
	`ª£rve_óæy
(
mem
, mem + 
TRAMPOLINE_SIZE
, "TRAMPOLINE");

28 
	}
}

35 
__åampöô
 
	$£tup_åampﬁöe
()

37 
	`mem˝y
(
åampﬁöe_ba£
, 
åampﬁöe_d©a
, 
TRAMPOLINE_SIZE
);

38  
	`vút_to_phys
(
åampﬁöe_ba£
);

39 
	}
}

	@/cmpt816/linux/arch/x86/kernel/traps.c

12 
	~<löux/öãºu±.h
>

13 
	~<löux/kÆlsyms.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/k¥obes.h
>

16 
	~<löux/uac˚ss.h
>

17 
	~<löux/kdebug.h
>

18 
	~<löux/kgdb.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/±ø˚.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/î∫o.h
>

25 
	~<löux/kexec.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/timî.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/bug.h
>

30 
	~<löux/nmi.h
>

31 
	~<löux/mm.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/io.h
>

35 #ifde‡
CONFIG_EISA


36 
	~<löux/i›‹t.h
>

37 
	~<löux/eiß.h
>

40 #ifde‡
CONFIG_MCA


41 
	~<löux/mˇ.h
>

44 #i‡
deföed
(
CONFIG_EDAC
)

45 
	~<löux/edac.h
>

48 
	~<asm/kmemcheck.h
>

49 
	~<asm/°ackåa˚.h
>

50 
	~<asm/¥o˚ss‹.h
>

51 
	~<asm/debugªg.h
>

52 
	~<asm/©omic.h
>

53 
	~<asm/sy°em.h
>

54 
	~<asm/å≠s.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/i387.h
>

57 
	~<asm/m˚.h
>

59 
	~<asm/mach_å≠s.h
>

61 #ifde‡
CONFIG_X86_64


62 
	~<asm/x86_öô.h
>

63 
	~<asm/pgÆloc.h
>

64 
	~<asm/¥Ÿo.h
>

66 
	~<asm/¥o˚ss‹-Êags.h
>

67 
	~<asm/£tup.h
>

69 
asmlökage
 
sy°em_ˇŒ
();

72 
	gign‹e_Âu_úq
;

78 
g©e_desc
 
	gidt_èbÀ
[
NR_VECTORS
] 
	g__∑ge_Æig√d_d©a
 = { { { { 0, 0 } } }, };

81 
DECLARE_BITMAP
(
u£d_ve˘‹s
, 
NR_VECTORS
);

82 
EXPORT_SYMBOL_GPL
(
u£d_ve˘‹s
);

84 
	gign‹e_nmis
;

86 
ölöe
 
	$c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

88 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

89 
	`loˇl_úq_íabÀ
();

90 
	}
}

92 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_°i
(
±_ªgs
 *
ªgs
)

94 
	`öc_¥ìm±_cou¡
();

95 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

96 
	`loˇl_úq_íabÀ
();

97 
	}
}

99 
ölöe
 
	$c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

101 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

102 
	`loˇl_úq_dißbÀ
();

103 
	}
}

105 
ölöe
 
	$¥ìm±_c⁄dôi⁄Æ_˛i
(
±_ªgs
 *
ªgs
)

107 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

108 
	`loˇl_úq_dißbÀ
();

109 
	`dec_¥ìm±_cou¡
();

110 
	}
}

112 
__k¥obes


113 
	$do_å≠
(
å≠ƒ
, 
sigƒ
, *
°r
, 
±_ªgs
 *
ªgs
,

114 
îr‹_code
, 
sigöfo_t
 *
öfo
)

116 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

118 #ifde‡
CONFIG_X86_32


119 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

124 i‡(
å≠ƒ
 < 6)

125 
vm86_å≠
;

126 
å≠_sig«l
;

130 i‡(!
	`u£r_mode
(
ªgs
))

131 
kî√l_å≠
;

133 #ifde‡
CONFIG_X86_32


134 
å≠_sig«l
:

145 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

146 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

148 #ifde‡
CONFIG_X86_64


149 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
sigƒ
) &&

150 
	`¥ötk_øãlimô
()) {

151 
	`¥ötk
(
KERN_INFO


153 
tsk
->
comm
,Åsk->
pid
, 
°r
,

154 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

155 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

156 
	`¥ötk
("\n");

160 i‡(
öfo
)

161 
	`f‹˚_sig_öfo
(
sigƒ
, 
öfo
, 
tsk
);

163 
	`f‹˚_sig
(
sigƒ
, 
tsk
);

166 
kî√l_å≠
:

167 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

168 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

169 
tsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

170 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

174 #ifde‡
CONFIG_X86_32


175 
vm86_å≠
:

176 i‡(
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

177 
îr‹_code
, 
å≠ƒ
))

178 
å≠_sig«l
;

181 
	}
}

183 
	#DO_ERROR
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
) \

184 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

186 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

187 =
NOTIFY_STOP
) \

189 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

190 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, 
NULL
); \

191 }

	)

193 
	#DO_ERROR_INFO
(
å≠ƒ
, 
sigƒ
, 
°r
, 
«me
, 
sicode
, 
süddr
) \

194 
dŸø∂ökage
 
do_
##
	`«me
(
±_ªgs
 *
ªgs
, 
îr‹_code
) \

196 
sigöfo_t
 
öfo
; \

197 
öfo
.
si_signo
 = 
sigƒ
; \

198 
öfo
.
si_î∫o
 = 0; \

199 
öfo
.
si_code
 = 
sicode
; \

200 
öfo
.
si_addr
 = (
__u£r
 *)
süddr
; \

201 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
sigƒ
) \

202 =
NOTIFY_STOP
) \

204 
	`c⁄dôi⁄Æ_°i
(
ªgs
); \

205 
	`do_å≠
(
å≠ƒ
, 
sigƒ
, 
°r
, 
ªgs
, 
îr‹_code
, &
öfo
); \

206 }

	)

208 
DO_ERROR_INFO
(0, 
SIGFPE
, "dividêîr‹", 
divide_îr‹
, 
FPE_INTDIV
, 
ªgs
->
ù
)

209 
DO_ERROR
(4, 
SIGSEGV
, "ovîÊow", 
ovîÊow
)

210 
DO_ERROR
(5, 
SIGSEGV
, "bounds", 
bounds
)

211 
DO_ERROR_INFO
(6, 
SIGILL
, "övÆid opcode", 
övÆid_›
, 
ILL_ILLOPN
, 
ªgs
->
ù
)

212 
DO_ERROR
(9, 
SIGFPE
, "c›ro˚ss‹ segmíàovîrun", 
c›ro˚ss‹_£gmít_ovîrun
)

213 
DO_ERROR
(10, 
SIGSEGV
, "övÆid TSS", 
övÆid_TSS
)

214 
DO_ERROR
(11, 
SIGBUS
, "£gmíànŸÖª£¡", 
£gmít_nŸ_¥e£¡
)

215 #ifde‡
CONFIG_X86_32


216 
DO_ERROR
(12, 
SIGBUS
, "°ack segmít", 
°ack_£gmít
)

218 
DO_ERROR_INFO
(17, 
SIGBUS
, "Æignmíàcheck", 
Æignmít_check
, 
BUS_ADRALN
, 0)

220 #ifde‡
CONFIG_X86_64


222 
dŸø∂ökage
 
	$do_°ack_£gmít
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

224 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "°ack segmít", 
ªgs
, 
îr‹_code
,

225 12, 
SIGBUS
Ë=
NOTIFY_STOP
)

227 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

228 
	`do_å≠
(12, 
SIGBUS
, "°ack segmít", 
ªgs
, 
îr‹_code
, 
NULL
);

229 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

230 
	}
}

232 
dŸø∂ökage
 
	$do_doubÀ_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

234 c⁄° 
°r
[] = "double fault";

235 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

238 
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 8, 
SIGSEGV
);

240 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

241 
tsk
->
thªad
.
å≠_no
 = 8;

248 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

249 
	}
}

252 
dŸø∂ökage
 
__k¥obes


253 
	$do_gíîÆ_¥Ÿe˘i⁄
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

255 
èsk_°ru˘
 *
tsk
;

257 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

259 #ifde‡
CONFIG_X86_32


260 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
)

261 
gp_ö_vm86
;

264 
tsk
 = 
cuºít
;

265 i‡(!
	`u£r_mode
(
ªgs
))

266 
gp_ö_kî√l
;

268 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

269 
tsk
->
thªad
.
å≠_no
 = 13;

271 i‡(
show_unh™dÀd_sig«ls
 && 
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
) &&

272 
	`¥ötk_øãlimô
()) {

273 
	`¥ötk
(
KERN_INFO


275 
tsk
->
comm
, 
	`èsk_pid_ƒ
(tsk),

276 
ªgs
->
ù
,Ñegs->
•
, 
îr‹_code
);

277 
	`¥öt_vma_addr
(" i¿", 
ªgs
->
ù
);

278 
	`¥ötk
("\n");

281 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

284 #ifde‡
CONFIG_X86_32


285 
gp_ö_vm86
:

286 
	`loˇl_úq_íabÀ
();

287 
	`h™dÀ_vm86_Áu…
((
kî√l_vm86_ªgs
 *Ë
ªgs
, 
îr‹_code
);

291 
gp_ö_kî√l
:

292 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

295 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

296 
tsk
->
thªad
.
å≠_no
 = 13;

297 i‡(
	`nŸify_dõ
(
DIE_GPF
, "gíîÆÖrŸe˘i⁄ fau…", 
ªgs
,

298 
îr‹_code
, 13, 
SIGSEGV
Ë=
NOTIFY_STOP
)

300 
	`dõ
("gíîÆÖrŸe˘i⁄ fau…", 
ªgs
, 
îr‹_code
);

301 
	}
}

303 
nŸø˚
 
__k¥obes
 

304 
	$mem_∑rôy_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

306 
	`¥ötk
(
KERN_EMERG


308 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

310 
	`¥ötk
(
KERN_EMERG


313 #i‡
	`deföed
(
CONFIG_EDAC
)

314 i‡(
	`edac_h™dÀr_£t
()) {

315 
	`edac_©omic_as£π_îr‹
();

320 i‡(
∑nic_⁄_uƒecovîed_nmi
)

321 
	`∑nic
("NMI: Not continuing");

323 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

326 
ªas⁄
 = (reason & 0xf) | 4;

327 
	`outb
(
ªas⁄
, 0x61);

328 
	}
}

330 
nŸø˚
 
__k¥obes
 

331 
	$io_check_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

333 
i
;

335 
	`¥ötk
(
KERN_EMERG
 "NMI: IOCKÉrror (debug interrupt?)\n");

336 
	`show_ªgi°îs
(
ªgs
);

338 i‡(
∑nic_⁄_io_nmi
)

339 
	`∑nic
("NMI IOCKÉrror: Not continuing");

342 
ªas⁄
 = (reason & 0xf) | 8;

343 
	`outb
(
ªas⁄
, 0x61);

345 
i
 = 2000;

346 --
i
)

347 
	`udñay
(1000);

349 
ªas⁄
 &= ~8;

350 
	`outb
(
ªas⁄
, 0x61);

351 
	}
}

353 
nŸø˚
 
__k¥obes
 

354 
	$unknown_nmi_îr‹
(
ªas⁄
, 
±_ªgs
 *
ªgs
)

356 i‡(
	`nŸify_dõ
(
DIE_NMIUNKNOWN
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
) ==

357 
NOTIFY_STOP
)

359 #ifde‡
CONFIG_MCA


364 i‡(
MCA_bus
) {

365 
	`mˇ_h™dÀ_nmi
();

369 
	`¥ötk
(
KERN_EMERG


371 
ªas⁄
, 
	`smp_¥o˚ss‹_id
());

373 
	`¥ötk
(
KERN_EMERG
 "Do you haveá strangeÖower saving modeÉnabled?\n");

374 i‡(
∑nic_⁄_uƒecovîed_nmi
)

375 
	`∑nic
("NMI: Not continuing");

377 
	`¥ötk
(
KERN_EMERG
 "Dazedánd confused, butÅryingÅo continue\n");

378 
	}
}

380 
nŸø˚
 
__k¥obes
 
	$deÁu…_do_nmi
(
±_ªgs
 *
ªgs
)

382 
ªas⁄
 = 0;

383 
˝u
;

385 
˝u
 = 
	`smp_¥o˚ss‹_id
();

388 i‡(!
˝u
)

389 
ªas⁄
 = 
	`gë_nmi_ªas⁄
();

391 i‡(!(
ªas⁄
 & 0xc0)) {

392 i‡(
	`nŸify_dõ
(
DIE_NMI_IPI
, "nmi_ùi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
)

393 =
NOTIFY_STOP
)

395 #ifde‡
CONFIG_X86_LOCAL_APIC


400 i‡(
	`nmi_w©chdog_tick
(
ªgs
, 
ªas⁄
))

402 i‡(!
	`do_nmi_ˇŒback
(
ªgs
, 
˝u
))

403 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

405 
	`unknown_nmi_îr‹
(
ªas⁄
, 
ªgs
);

410 i‡(
	`nŸify_dõ
(
DIE_NMI
, "nmi", 
ªgs
, 
ªas⁄
, 2, 
SIGINT
Ë=
NOTIFY_STOP
)

414 i‡(
ªas⁄
 & 0x80)

415 
	`mem_∑rôy_îr‹
(
ªas⁄
, 
ªgs
);

416 i‡(
ªas⁄
 & 0x40)

417 
	`io_check_îr‹
(
ªas⁄
, 
ªgs
);

418 #ifde‡
CONFIG_X86_32


423 
	`ªas£π_nmi
();

425 
	}
}

427 
dŸø∂ökage
 
nŸø˚
 
__k¥obes
 

428 
	$do_nmi
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

430 
	`nmi_íãr
();

432 
	`öc_úq_°©
(
__nmi_cou¡
);

434 i‡(!
ign‹e_nmis
)

435 
	`deÁu…_do_nmi
(
ªgs
);

437 
	`nmi_exô
();

438 
	}
}

440 
	$°›_nmi
()

442 
	`a˝i_nmi_dißbÀ
();

443 
ign‹e_nmis
++;

444 
	}
}

446 
	$ª°¨t_nmi
()

448 
ign‹e_nmis
--;

449 
	`a˝i_nmi_íabÀ
();

450 
	}
}

453 
dŸø∂ökage
 
__k¥obes
 
	$do_öt3
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

455 #ifde‡
CONFIG_KGDB_LOW_LEVEL_TRAP


456 i‡(
	`kgdb_Œ_å≠
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

457 =
NOTIFY_STOP
)

460 #ifde‡
CONFIG_KPROBES


461 i‡(
	`nŸify_dõ
(
DIE_INT3
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

462 =
NOTIFY_STOP
)

465 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "öt3", 
ªgs
, 
îr‹_code
, 3, 
SIGTRAP
)

466 =
NOTIFY_STOP
)

470 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

471 
	`do_å≠
(3, 
SIGTRAP
, "öt3", 
ªgs
, 
îr‹_code
, 
NULL
);

472 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

473 
	}
}

475 #ifde‡
CONFIG_X86_64


481 
asmlökage
 
__k¥obes
 
±_ªgs
 *
	$sync_ªgs
(
±_ªgs
 *
îegs
)

483 
±_ªgs
 *
ªgs
 = 
îegs
;

485 i‡(
îegs
 =(
±_ªgs
 *Îªgs->
•
)

488 i‡(
	`u£r_mode
(
îegs
))

489 
ªgs
 = 
	`èsk_±_ªgs
(
cuºít
);

494 i‡(
îegs
->
Êags
 & 
X86_EFLAGS_IF
)

495 
ªgs
 = (
±_ªgs
 *)(
îegs
->
•
 -= (pt_regs));

496 i‡(
îegs
 !
ªgs
)

497 *
ªgs
 = *
îegs
;

498  
ªgs
;

499 
	}
}

526 
dŸø∂ökage
 
__k¥obes
 
	$do_debug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

528 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

529 
u£r_i˚bp
 = 0;

530 
dr6
;

531 
si_code
;

533 
	`gë_debugªg
(
dr6
, 6);

536 
dr6
 &~
DR6_RESERVED
;

543 i‡(!
dr6
 && 
	`u£r_mode
(
ªgs
))

544 
u£r_i˚bp
 = 1;

547 i‡((
dr6
 & 
DR_STEP
Ë&& 
	`kmemcheck_å≠
(
ªgs
))

551 
	`£t_debugªg
(0, 6);

556 
	`˛ór_tsk_thªad_Êag
(
tsk
, 
TIF_BLOCKSTEP
);

559 
tsk
->
thªad
.
debugªg6
 = 
dr6
;

561 i‡(
	`nŸify_dõ
(
DIE_DEBUG
, "debug", 
ªgs
, 
	`PTR_ERR
(&
dr6
), 
îr‹_code
,

562 
SIGTRAP
Ë=
NOTIFY_STOP
)

566 
	`¥ìm±_c⁄dôi⁄Æ_°i
(
ªgs
);

568 i‡(
ªgs
->
Êags
 & 
X86_VM_MASK
) {

569 
	`h™dÀ_vm86_å≠
((
kî√l_vm86_ªgs
 *Ë
ªgs
,

570 
îr‹_code
, 1);

581 i‡((
dr6
 & 
DR_STEP
Ë&& !
	`u£r_mode
(
ªgs
)) {

582 
tsk
->
thªad
.
debugªg6
 &~
DR_STEP
;

583 
	`£t_tsk_thªad_Êag
(
tsk
, 
TIF_SINGLESTEP
);

584 
ªgs
->
Êags
 &~
X86_EFLAGS_TF
;

586 
si_code
 = 
	`gë_si_code
(
tsk
->
thªad
.
debugªg6
);

587 i‡(
tsk
->
thªad
.
debugªg6
 & (
DR_STEP
 | 
DR_TRAP_BITS
Ë|| 
u£r_i˚bp
)

588 
	`£nd_sigå≠
(
tsk
, 
ªgs
, 
îr‹_code
, 
si_code
);

589 
	`¥ìm±_c⁄dôi⁄Æ_˛i
(
ªgs
);

592 
	}
}

599 
	$m©h_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
å≠ƒ
)

601 
èsk_°ru˘
 *
èsk
 = 
cuºít
;

602 
sigöfo_t
 
öfo
;

603 
îr
;

604 *
°r
 = (
å≠ƒ
 == 16) ? "fpuÉxception" : "simdÉxception";

606 i‡(
	`nŸify_dõ
(
DIE_TRAP
, 
°r
, 
ªgs
, 
îr‹_code
, 
å≠ƒ
, 
SIGFPE
Ë=
NOTIFY_STOP
)

608 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

610 i‡(!
	`u£r_mode_vm
(
ªgs
))

612 i‡(!
	`fixup_ex˚±i⁄
(
ªgs
)) {

613 
èsk
->
thªad
.
îr‹_code
 =Érror_code;

614 
èsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

615 
	`dõ
(
°r
, 
ªgs
, 
îr‹_code
);

623 
	`ßve_öô_Âu
(
èsk
);

624 
èsk
->
thªad
.
å≠_no
 = 
å≠ƒ
;

625 
èsk
->
thªad
.
îr‹_code
 =Érror_code;

626 
öfo
.
si_signo
 = 
SIGFPE
;

627 
öfo
.
si_î∫o
 = 0;

628 
öfo
.
si_addr
 = (
__u£r
 *)
ªgs
->
ù
;

629 i‡(
å≠ƒ
 == 16) {

630 
cwd
, 
swd
;

641 
cwd
 = 
	`gë_Âu_cwd
(
èsk
);

642 
swd
 = 
	`gë_Âu_swd
(
èsk
);

644 
îr
 = 
swd
 & ~
cwd
;

652 
mxc§
 = 
	`gë_Âu_mxc§
(
èsk
);

653 
îr
 = ~(
mxc§
 >> 7) & mxcsr;

656 i‡(
îr
 & 0x001) {

662 
öfo
.
si_code
 = 
FPE_FLTINV
;

663 } i‡(
îr
 & 0x004) {

664 
öfo
.
si_code
 = 
FPE_FLTDIV
;

665 } i‡(
îr
 & 0x008) {

666 
öfo
.
si_code
 = 
FPE_FLTOVF
;

667 } i‡(
îr
 & 0x012) {

668 
öfo
.
si_code
 = 
FPE_FLTUND
;

669 } i‡(
îr
 & 0x020) {

670 
öfo
.
si_code
 = 
FPE_FLTRES
;

678 
	`f‹˚_sig_öfo
(
SIGFPE
, &
öfo
, 
èsk
);

679 
	}
}

681 
dŸø∂ökage
 
	$do_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

683 #ifde‡
CONFIG_X86_32


684 
ign‹e_Âu_úq
 = 1;

687 
	`m©h_îr‹
(
ªgs
, 
îr‹_code
, 16);

688 
	}
}

690 
dŸø∂ökage
 

691 
	$do_simd_c›ro˚ss‹_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

693 
	`m©h_îr‹
(
ªgs
, 
îr‹_code
, 19);

694 
	}
}

696 
dŸø∂ökage
 

697 
	$do_•urious_öãºu±_bug
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

699 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

702 
	`¥ötk
(
KERN_INFO
 "Ignoring P6 Local APIC Spurious Interrupt Bug...\n");

704 
	}
}

706 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thîmÆ_öãºu±
()

708 
	}
}

710 
asmlökage
 
__©åibuã__
((
wók
)Ë
	$smp_thªshﬁd_öãºu±
()

712 
	}
}

718 
	$__m©h_°©e_ª°‹e
()

720 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

721 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

726 i‡(
	`u∆ikñy
(
	`ª°‹e_Âu_checkög
(
tsk
))) {

727 
	`°ts
();

728 
	`f‹˚_sig
(
SIGSEGV
, 
tsk
);

732 
thªad
->
°©us
 |
TS_USEDFPU
;

733 
tsk
->
Âu_cou¡î
++;

734 
	}
}

746 
asmlökage
 
	$m©h_°©e_ª°‹e
()

748 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

749 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

751 i‡(!
	`tsk_u£d_m©h
(
tsk
)) {

752 
	`loˇl_úq_íabÀ
();

756 i‡(
	`öô_Âu
(
tsk
)) {

760 
	`do_group_exô
(
SIGKILL
);

763 
	`loˇl_úq_dißbÀ
();

766 
	`˛ts
();

768 
	`__m©h_°©e_ª°‹e
();

769 
	}
}

770 
EXPORT_SYMBOL_GPL
(
m©h_°©e_ª°‹e
);

772 #i‚de‡
CONFIG_MATH_EMULATION


773 
	$m©h_emuœã
(
m©h_emu_öfo
 *
öfo
)

775 
	`¥ötk
(
KERN_EMERG


777 
	`¥ötk
(
KERN_EMERG
 "kûlög %s.\n", 
cuºít
->
comm
);

778 
	`f‹˚_sig
(
SIGFPE
, 
cuºít
);

779 
	`scheduÀ
();

780 
	}
}

783 
dŸø∂ökage
 
__k¥obes


784 
	$do_devi˚_nŸ_avaûabÀ
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

786 #ifde‡
CONFIG_X86_32


787 i‡(
	`ªad_¸0
(Ë& 
X86_CR0_EM
) {

788 
m©h_emu_öfo
 
öfo
 = { };

790 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

792 
öfo
.
ªgs
 =Ñegs;

793 
	`m©h_emuœã
(&
öfo
);

795 
	`m©h_°©e_ª°‹e
();

796 
	`c⁄dôi⁄Æ_°i
(
ªgs
);

799 
	`m©h_°©e_ª°‹e
();

801 
	}
}

803 #ifde‡
CONFIG_X86_32


804 
dŸø∂ökage
 
	$do_úë_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

806 
sigöfo_t
 
öfo
;

807 
	`loˇl_úq_íabÀ
();

809 
öfo
.
si_signo
 = 
SIGILL
;

810 
öfo
.
si_î∫o
 = 0;

811 
öfo
.
si_code
 = 
ILL_BADSTK
;

812 
öfo
.
si_addr
 = 
NULL
;

813 i‡(
	`nŸify_dõ
(
DIE_TRAP
, "iretÉxception",

814 
ªgs
, 
îr‹_code
, 32, 
SIGILL
Ë=
NOTIFY_STOP
)

816 
	`do_å≠
(32, 
SIGILL
, "úëÉx˚±i⁄", 
ªgs
, 
îr‹_code
, &
öfo
);

817 
	}
}

821 
__öô
 
	$óæy_å≠_öô
()

823 
	`£t_öå_g©e_i°
(1, &
debug
, 
DEBUG_STACK
);

825 
	`£t_sy°em_öå_g©e_i°
(3, &
öt3
, 
DEBUG_STACK
);

826 
	`£t_öå_g©e
(14, &
∑ge_Áu…
);

827 
	`lﬂd_idt
(&
idt_des¸
);

828 
	}
}

830 
__öô
 
	$å≠_öô
()

832 
i
;

834 #ifde‡
CONFIG_EISA


835 
__iomem
 *
p
 = 
	`óæy_i‹em≠
(0x0FFFD9, 4);

837 i‡(
	`ªadl
(
p
) == 'E' + ('I'<<8) + ('S'<<16) + ('A'<<24))

838 
EISA_bus
 = 1;

839 
	`óæy_iounm≠
(
p
, 4);

842 
	`£t_öå_g©e
(0, &
divide_îr‹
);

843 
	`£t_öå_g©e_i°
(2, &
nmi
, 
NMI_STACK
);

845 
	`£t_sy°em_öå_g©e
(4, &
ovîÊow
);

846 
	`£t_öå_g©e
(5, &
bounds
);

847 
	`£t_öå_g©e
(6, &
övÆid_›
);

848 
	`£t_öå_g©e
(7, &
devi˚_nŸ_avaûabÀ
);

849 #ifde‡
CONFIG_X86_32


850 
	`£t_èsk_g©e
(8, 
GDT_ENTRY_DOUBLEFAULT_TSS
);

852 
	`£t_öå_g©e_i°
(8, &
doubÀ_Áu…
, 
DOUBLEFAULT_STACK
);

854 
	`£t_öå_g©e
(9, &
c›ro˚ss‹_£gmít_ovîrun
);

855 
	`£t_öå_g©e
(10, &
övÆid_TSS
);

856 
	`£t_öå_g©e
(11, &
£gmít_nŸ_¥e£¡
);

857 
	`£t_öå_g©e_i°
(12, &
°ack_£gmít
, 
STACKFAULT_STACK
);

858 
	`£t_öå_g©e
(13, &
gíîÆ_¥Ÿe˘i⁄
);

859 
	`£t_öå_g©e
(15, &
•urious_öãºu±_bug
);

860 
	`£t_öå_g©e
(16, &
c›ro˚ss‹_îr‹
);

861 
	`£t_öå_g©e
(17, &
Æignmít_check
);

862 #ifde‡
CONFIG_X86_MCE


863 
	`£t_öå_g©e_i°
(18, &
machöe_check
, 
MCE_STACK
);

865 
	`£t_öå_g©e
(19, &
simd_c›ro˚ss‹_îr‹
);

868 
i
 = 0; i < 
FIRST_EXTERNAL_VECTOR
; i++)

869 
	`£t_bô
(
i
, 
u£d_ve˘‹s
);

871 #ifde‡
CONFIG_IA32_EMULATION


872 
	`£t_sy°em_öå_g©e
(
IA32_SYSCALL_VECTOR
, 
ü32_sysˇŒ
);

873 
	`£t_bô
(
IA32_SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

876 #ifde‡
CONFIG_X86_32


877 i‡(
˝u_has_fx§
) {

878 
	`¥ötk
(
KERN_INFO
 "Enabling fast FPU saveándÑestore... ");

879 
	`£t_ö_¸4
(
X86_CR4_OSFXSR
);

880 
	`¥ötk
("done.\n");

882 i‡(
˝u_has_xmm
) {

883 
	`¥ötk
(
KERN_INFO


885 
	`£t_ö_¸4
(
X86_CR4_OSXMMEXCPT
);

886 
	`¥ötk
("done.\n");

889 
	`£t_sy°em_å≠_g©e
(
SYSCALL_VECTOR
, &
sy°em_ˇŒ
);

890 
	`£t_bô
(
SYSCALL_VECTOR
, 
u£d_ve˘‹s
);

896 
	`˝u_öô
();

898 
x86_öô
.
úqs
.
	`å≠_öô
();

899 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/öô.h
>

4 
	~<löux/moduÀ.h
>

5 
	~<löux/timî.h
>

6 
	~<löux/a˝i_pmtmr.h
>

7 
	~<löux/˝u‰eq.h
>

8 
	~<löux/dmi.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/˛ocksour˚.h
>

11 
	~<löux/≥r˝u.h
>

12 
	~<löux/timex.h
>

14 
	~<asm/h≥t.h
>

15 
	~<asm/timî.h
>

16 
	~<asm/vgtod.h
>

17 
	~<asm/time.h
>

18 
	~<asm/dñay.h
>

19 
	~<asm/hy≥rvis‹.h
>

20 
	~<asm/nmi.h
>

21 
	~<asm/x86_öô.h
>

23 
__ªad_mo°ly
 
	g˝u_khz
;

24 
EXPORT_SYMBOL
(
˝u_khz
);

26 
__ªad_mo°ly
 
	gtsc_khz
;

27 
EXPORT_SYMBOL
(
tsc_khz
);

32 
__ªad_mo°ly
 
	gtsc_un°abÀ
;

37 
__ªad_mo°ly
 
	gtsc_dißbÀd
 = -1;

39 
	gtsc_˛ocksour˚_ªlübÀ
;

43 
u64
 
	$«tive_sched_˛ock
()

45 
u64
 
this_off£t
;

55 i‡(
	`u∆ikñy
(
tsc_dißbÀd
)) {

57  (
jiffõs_64
 - 
INITIAL_JIFFIES
Ë* (1000000000 / 
HZ
);

61 
	`rdts˛l
(
this_off£t
);

64  
	`__cy˛es_2_ns
(
this_off£t
);

65 
	}
}

69 #ifde‡
CONFIG_PARAVIRT


70 
	$sched_˛ock
()

72  
	`∑øvút_sched_˛ock
();

73 
	}
}

76 
	$sched_˛ock
(Ë
	`__©åibuã__
((
	`Æüs
("native_sched_clock")));

79 
	$check_tsc_un°abÀ
()

81  
tsc_un°abÀ
;

82 
	}
}

83 
EXPORT_SYMBOL_GPL
(
check_tsc_un°abÀ
);

85 #ifde‡
CONFIG_X86_TSC


86 
__öô
 
	$nŸsc_£tup
(*
°r
)

88 
	`¥ötk
(
KERN_WARNING
 "notsc: Kernel compiled with CONFIG_X86_TSC, "

90 
tsc_dißbÀd
 = 1;

92 
	}
}

98 
__öô
 
	$nŸsc_£tup
(*
°r
)

100 
	`£tup_˛ór_˝u_ˇp
(
X86_FEATURE_TSC
);

102 
	}
}

105 
__£tup
("nŸsc", 
nŸsc_£tup
);

107 
__öô
 
	$tsc_£tup
(*
°r
)

109 i‡(!
	`°rcmp
(
°r
, "reliable"))

110 
tsc_˛ocksour˚_ªlübÀ
 = 1;

112 
	}
}

114 
__£tup
("tsc=", 
tsc_£tup
);

116 
	#MAX_RETRIES
 5

	)

117 
	#SMI_TRESHOLD
 50000

	)

122 
u64
 
	$tsc_ªad_ªfs
(
u64
 *
p
, 
h≥t
)

124 
u64
 
t1
, 
t2
;

125 
i
;

127 
i
 = 0; i < 
MAX_RETRIES
; i++) {

128 
t1
 = 
	`gë_cy˛es
();

129 i‡(
h≥t
)

130 *
p
 = 
	`h≥t_ªadl
(
HPET_COUNTER
) & 0xFFFFFFFF;

132 *
p
 = 
	`a˝i_pm_ªad_óæy
();

133 
t2
 = 
	`gë_cy˛es
();

134 i‡((
t2
 - 
t1
Ë< 
SMI_TRESHOLD
)

135  
t2
;

137  
ULLONG_MAX
;

138 
	}
}

143 
	$ˇlc_h≥t_ªf
(
u64
 
dñètsc
, u64 
h≥t1
, u64 
h≥t2
)

145 
u64
 
tmp
;

147 i‡(
h≥t2
 < 
h≥t1
)

148 
h≥t2
 += 0x100000000ULL;

149 
h≥t2
 -
h≥t1
;

150 
tmp
 = ((
u64
)
h≥t2
 * 
	`h≥t_ªadl
(
HPET_PERIOD
));

151 
	`do_div
(
tmp
, 1000000);

152 
	`do_div
(
dñètsc
, 
tmp
);

154  (Ë
dñètsc
;

155 
	}
}

160 
	$ˇlc_pmtimî_ªf
(
u64
 
dñètsc
, u64 
pm1
, u64 
pm2
)

162 
u64
 
tmp
;

164 i‡(!
pm1
 && !
pm2
)

165  
ULONG_MAX
;

167 i‡(
pm2
 < 
pm1
)

168 
pm2
 +(
u64
)
ACPI_PM_OVRRUN
;

169 
pm2
 -
pm1
;

170 
tmp
 = 
pm2
 * 1000000000LL;

171 
	`do_div
(
tmp
, 
PMTMR_TICKS_PER_SEC
);

172 
	`do_div
(
dñètsc
, 
tmp
);

174  (Ë
dñètsc
;

175 
	}
}

177 
	#CAL_MS
 10

	)

178 
	#CAL_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL_MS
))

	)

179 
	#CAL_PIT_LOOPS
 1000

	)

181 
	#CAL2_MS
 50

	)

182 
	#CAL2_LATCH
 (
CLOCK_TICK_RATE
 / (1000 / 
CAL2_MS
))

	)

183 
	#CAL2_PIT_LOOPS
 5000

	)

193 
	$pô_ˇlibøã_tsc
(
u32
 
œtch
, 
ms
, 
lo›mö
)

195 
u64
 
tsc
, 
t1
, 
t2
, 
dñè
;

196 
tscmö
, 
tscmax
;

197 
pô˙t
;

200 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

207 
	`outb
(0xb0, 0x43);

208 
	`outb
(
œtch
 & 0xff, 0x42);

209 
	`outb
(
œtch
 >> 8, 0x42);

211 
tsc
 = 
t1
 = 
t2
 = 
	`gë_cy˛es
();

213 
pô˙t
 = 0;

214 
tscmax
 = 0;

215 
tscmö
 = 
ULONG_MAX
;

216 (
	`öb
(0x61) & 0x20) == 0) {

217 
t2
 = 
	`gë_cy˛es
();

218 
dñè
 = 
t2
 - 
tsc
;

219 
tsc
 = 
t2
;

220 i‡((Ë
dñè
 < 
tscmö
)

221 
tscmö
 = (Ë
dñè
;

222 i‡((Ë
dñè
 > 
tscmax
)

223 
tscmax
 = (Ë
dñè
;

224 
pô˙t
++;

236 i‡(
pô˙t
 < 
lo›mö
 || 
tscmax
 > 10 * 
tscmö
)

237  
ULONG_MAX
;

240 
dñè
 = 
t2
 - 
t1
;

241 
	`do_div
(
dñè
, 
ms
);

242  
dñè
;

243 
	}
}

280 
ölöe
 
	$pô_vîify_msb
(
vÆ
)

283 
	`öb
(0x42);

284  
	`öb
(0x42Ë=
vÆ
;

285 
	}
}

287 
ölöe
 
	$pô_ex≥˘_msb
(
vÆ
, 
u64
 *
ts˝
, *
dñèp
)

289 
cou¡
;

290 
u64
 
tsc
 = 0;

292 
cou¡
 = 0; count < 50000; count++) {

293 i‡(!
	`pô_vîify_msb
(
vÆ
))

295 
tsc
 = 
	`gë_cy˛es
();

297 *
dñèp
 = 
	`gë_cy˛es
(Ë- 
tsc
;

298 *
ts˝
 = 
tsc
;

304  
cou¡
 > 5;

305 
	}
}

313 
	#MAX_QUICK_PIT_MS
 25

	)

314 
	#MAX_QUICK_PIT_ITERATIONS
 (
MAX_QUICK_PIT_MS
 * 
PIT_TICK_RATE
 / 1000 / 256)

	)

316 
	$quick_pô_ˇlibøã
()

318 
i
;

319 
u64
 
tsc
, 
dñè
;

320 
d1
, 
d2
;

323 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

334 
	`outb
(0xb0, 0x43);

337 
	`outb
(0xff, 0x42);

338 
	`outb
(0xff, 0x42);

346 
	`pô_vîify_msb
(0);

348 i‡(
	`pô_ex≥˘_msb
(0xff, &
tsc
, &
d1
)) {

349 
i
 = 1; i <
MAX_QUICK_PIT_ITERATIONS
; i++) {

350 i‡(!
	`pô_ex≥˘_msb
(0xff-
i
, &
dñè
, &
d2
))

356 
dñè
 -
tsc
;

357 i‡(
d1
+
d2
 >
dñè
 >> 11)

367 i‡(!
	`pô_vîify_msb
(0x„ - 
i
))

369 
suc˚ss
;

372 
	`¥ötk
("Fast TSC calibration failed\n");

375 
suc˚ss
:

391 
dñè
 +()(
d2
 - 
d1
)/2;

392 
dñè
 *
PIT_TICK_RATE
;

393 
	`do_div
(
dñè
, 
i
*256*1000);

394 
	`¥ötk
("Fast TSC calibration using PIT\n");

395  
dñè
;

396 
	}
}

401 
	$«tive_ˇlibøã_tsc
()

403 
u64
 
tsc1
, 
tsc2
, 
dñè
, 
ªf1
, 
ªf2
;

404 
tsc_pô_mö
 = 
ULONG_MAX
, 
tsc_ªf_mö
 = ULONG_MAX;

405 
Êags
, 
œtch
, 
ms
, 
Á°_ˇlibøã
;

406 
h≥t
 = 
	`is_h≥t_íabÀd
(), 
i
, 
lo›mö
;

408 
	`loˇl_úq_ßve
(
Êags
);

409 
Á°_ˇlibøã
 = 
	`quick_pô_ˇlibøã
();

410 
	`loˇl_úq_ª°‹e
(
Êags
);

411 i‡(
Á°_ˇlibøã
)

412  
Á°_ˇlibøã
;

440 
œtch
 = 
CAL_LATCH
;

441 
ms
 = 
CAL_MS
;

442 
lo›mö
 = 
CAL_PIT_LOOPS
;

444 
i
 = 0; i < 3; i++) {

445 
tsc_pô_khz
;

453 
	`loˇl_úq_ßve
(
Êags
);

454 
tsc1
 = 
	`tsc_ªad_ªfs
(&
ªf1
, 
h≥t
);

455 
tsc_pô_khz
 = 
	`pô_ˇlibøã_tsc
(
œtch
, 
ms
, 
lo›mö
);

456 
tsc2
 = 
	`tsc_ªad_ªfs
(&
ªf2
, 
h≥t
);

457 
	`loˇl_úq_ª°‹e
(
Êags
);

460 
tsc_pô_mö
 = 
	`mö
—sc_pô_mö, 
tsc_pô_khz
);

463 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
)

467 i‡(
tsc1
 =
ULLONG_MAX
 || 
tsc2
 == ULLONG_MAX)

470 
tsc2
 = (tsc2 - 
tsc1
) * 1000000LL;

471 i‡(
h≥t
)

472 
tsc2
 = 
	`ˇlc_h≥t_ªf
—sc2, 
ªf1
, 
ªf2
);

474 
tsc2
 = 
	`ˇlc_pmtimî_ªf
—sc2, 
ªf1
, 
ªf2
);

476 
tsc_ªf_mö
 = 
	`mö
—sc_ªf_mö, (Ë
tsc2
);

479 
dñè
 = ((
u64
Ë
tsc_pô_mö
) * 100;

480 
	`do_div
(
dñè
, 
tsc_ªf_mö
);

488 i‡(
dñè
 >= 90 && delta <= 110) {

489 
	`¥ötk
(
KERN_INFO


491 
h≥t
 ? "HPET" : "PMTIMER", 
i
 + 1);

492  
tsc_ªf_mö
;

501 i‡(
i
 =1 && 
tsc_pô_mö
 =
ULONG_MAX
) {

502 
œtch
 = 
CAL2_LATCH
;

503 
ms
 = 
CAL2_MS
;

504 
lo›mö
 = 
CAL2_PIT_LOOPS
;

511 i‡(
tsc_pô_mö
 =
ULONG_MAX
) {

513 
	`¥ötk
(
KERN_WARNING
 "TSC: UnableÅo calibrateágainst PIT\n");

516 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

517 
	`¥ötk
("TSC: NoÑeference (HPET/PMTIMER)ávailable\n");

522 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

523 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration "

529 
	`¥ötk
(
KERN_INFO
 "TSC: using %sÑeference calibration\n",

530 
h≥t
 ? "HPET" : "PMTIMER");

532  
tsc_ªf_mö
;

536 i‡(!
h≥t
 && !
ªf1
 && !
ªf2
) {

537 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

538  
tsc_pô_mö
;

542 i‡(
tsc_ªf_mö
 =
ULONG_MAX
) {

543 
	`¥ötk
(
KERN_WARNING
 "TSC: HPET/PMTIMER calibration failed. "

545  
tsc_pô_mö
;

553 
	`¥ötk
(
KERN_WARNING
 "TSC: PIT calibration deviates from %s: %lu %lu.\n",

554 
h≥t
 ? "HPET" : "PMTIMER", 
tsc_pô_mö
, 
tsc_ªf_mö
);

555 
	`¥ötk
(
KERN_INFO
 "TSC: Using PIT calibration value\n");

556  
tsc_pô_mö
;

557 
	}
}

559 
	$ªˇlibøã_˝u_khz
()

561 #i‚de‡
CONFIG_SMP


562 
˝u_khz_ﬁd
 = 
˝u_khz
;

564 i‡(
˝u_has_tsc
) {

565 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

566 
˝u_khz
 = 
tsc_khz
;

567 
	`˝u_d©a
(0).
lo›s_≥r_jiffy
 =

568 
	`˝u‰eq_sˇÀ
(
	`˝u_d©a
(0).
lo›s_≥r_jiffy
,

569 
˝u_khz_ﬁd
, 
˝u_khz
);

572  -
ENODEV
;

574  -
ENODEV
;

576 
	}
}

578 
EXPORT_SYMBOL
(
ªˇlibøã_˝u_khz
);

603 
DEFINE_PER_CPU
(, 
cyc2ns
);

604 
DEFINE_PER_CPU
(, 
cyc2ns_off£t
);

606 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
)

608 
tsc_now
, 
ns_now
, *
off£t
;

609 
Êags
, *
sˇÀ
;

611 
	`loˇl_úq_ßve
(
Êags
);

612 
	`sched_˛ock_idÀ_¶ìp_evít
();

614 
sˇÀ
 = &
	`≥r_˝u
(
cyc2ns
, 
˝u
);

615 
off£t
 = &
	`≥r_˝u
(
cyc2ns_off£t
, 
˝u
);

617 
	`rdts˛l
(
tsc_now
);

618 
ns_now
 = 
	`__cy˛es_2_ns
(
tsc_now
);

620 i‡(
˝u_khz
) {

621 *
sˇÀ
 = (
NSEC_PER_MSEC
 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

622 *
off£t
 = 
ns_now
 - (
tsc_now
 * *
sˇÀ
 >> 
CYC2NS_SCALE_FACTOR
);

625 
	`sched_˛ock_idÀ_wakeup_evít
(0);

626 
	`loˇl_úq_ª°‹e
(
Êags
);

627 
	}
}

629 #ifde‡
CONFIG_CPU_FREQ


642 
	gªf_‰eq
;

643 
	glo›s_≥r_jiffy_ªf
;

644 
	gtsc_khz_ªf
;

646 
	$time_˝u‰eq_nŸifõr
(
nŸifõr_block
 *
nb
, 
vÆ
,

647 *
d©a
)

649 
˝u‰eq_‰eqs
 *
‰eq
 = 
d©a
;

650 *
Õj
;

652 i‡(
	`˝u_has
(&
	`˝u_d©a
(
‰eq
->
˝u
), 
X86_FEATURE_CONSTANT_TSC
))

655 
Õj
 = &
boŸ_˝u_d©a
.
lo›s_≥r_jiffy
;

656 #ifde‡
CONFIG_SMP


657 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

658 
Õj
 = &
	`˝u_d©a
(
‰eq
->
˝u
).
lo›s_≥r_jiffy
;

661 i‡(!
ªf_‰eq
) {

662 
ªf_‰eq
 = 
‰eq
->
ﬁd
;

663 
lo›s_≥r_jiffy_ªf
 = *
Õj
;

664 
tsc_khz_ªf
 = 
tsc_khz
;

666 i‡((
vÆ
 =
CPUFREQ_PRECHANGE
 && 
‰eq
->
ﬁd
 < fªq->
√w
) ||

667 (
vÆ
 =
CPUFREQ_POSTCHANGE
 && 
‰eq
->
ﬁd
 > fªq->
√w
) ||

668 (
vÆ
 =
CPUFREQ_RESUMECHANGE
)) {

669 *
Õj
 = 
	`˝u‰eq_sˇÀ
(
lo›s_≥r_jiffy_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

671 
tsc_khz
 = 
	`˝u‰eq_sˇÀ
(
tsc_khz_ªf
, 
ªf_‰eq
, 
‰eq
->
√w
);

672 i‡(!(
‰eq
->
Êags
 & 
CPUFREQ_CONST_LOOPS
))

673 
	`m¨k_tsc_un°abÀ
("cpufreq changes");

676 
	`£t_cyc2ns_sˇÀ
(
tsc_khz
, 
‰eq
->
˝u
);

679 
	}
}

681 
nŸifõr_block
 
	gtime_˝u‰eq_nŸifõr_block
 = {

682 .
nŸifõr_ˇŒ
 = 
time_˝u‰eq_nŸifõr


685 
__öô
 
	$˝u‰eq_tsc
()

687 i‡(!
˝u_has_tsc
)

689 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

691 
	`˝u‰eq_ªgi°î_nŸifõr
(&
time_˝u‰eq_nŸifõr_block
,

692 
CPUFREQ_TRANSITION_NOTIFIER
);

694 
	}
}

696 
c‹e_öôˇŒ
(
˝u‰eq_tsc
);

702 
˛ocksour˚
 
	g˛ocksour˚_tsc
;

716 
cy˛e_t
 
	$ªad_tsc
(
˛ocksour˚
 *
cs
)

718 
cy˛e_t
 
ªt
 = (cy˛e_t)
	`gë_cy˛es
();

720  
ªt
 >
˛ocksour˚_tsc
.
cy˛e_œ°
 ?

721 
ªt
 : 
˛ocksour˚_tsc
.
cy˛e_œ°
;

722 
	}
}

724 #ifde‡
CONFIG_X86_64


725 
cy˛e_t
 
__vsysˇŒ_‚
 
	$vªad_tsc
()

727 
cy˛e_t
 
ªt
;

734 
	`rdtsc_b¨rõr
();

735 
ªt
 = (
cy˛e_t
)
	`vgë_cy˛es
();

736 
	`rdtsc_b¨rõr
();

738  
ªt
 >
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 ?

739 
ªt
 : 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

740 
	}
}

743 
	$ªsume_tsc
(
˛ocksour˚
 *
cs
)

745 
˛ocksour˚_tsc
.
cy˛e_œ°
 = 0;

746 
	}
}

748 
˛ocksour˚
 
	g˛ocksour˚_tsc
 = {

749 .
«me
 = "tsc",

750 .
	gøtög
 = 300,

751 .
	gªad
 = 
ªad_tsc
,

752 .
	gªsume
 = 
ªsume_tsc
,

753 .
	gmask
 = 
CLOCKSOURCE_MASK
(64),

754 .
	gshi·
 = 22,

755 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
 |

756 
CLOCK_SOURCE_MUST_VERIFY
,

757 #ifde‡
CONFIG_X86_64


758 .
	gvªad
 = 
vªad_tsc
,

762 
	$m¨k_tsc_un°abÀ
(*
ªas⁄
)

764 i‡(!
tsc_un°abÀ
) {

765 
tsc_un°abÀ
 = 1;

766 
sched_˛ock_°abÀ
 = 0;

767 
	`¥ötk
(
KERN_INFO
 "M¨kög TSC un°abÀ duêtÿ%s\n", 
ªas⁄
);

769 i‡(
˛ocksour˚_tsc
.
mu…
)

770 
	`˛ocksour˚_m¨k_un°abÀ
(&
˛ocksour˚_tsc
);

772 
˛ocksour˚_tsc
.
Êags
 |
CLOCK_SOURCE_UNSTABLE
;

773 
˛ocksour˚_tsc
.
øtög
 = 0;

776 
	}
}

778 
EXPORT_SYMBOL_GPL
(
m¨k_tsc_un°abÀ
);

780 
__öô
 
	$dmi_m¨k_tsc_un°abÀ
(c⁄° 
dmi_sy°em_id
 *
d
)

782 
	`¥ötk
(
KERN_NOTICE
 "%s detected: marking TSC unstable.\n",

783 
d
->
idít
);

784 
tsc_un°abÀ
 = 1;

786 
	}
}

789 
dmi_sy°em_id
 
__öôd©a
 
	gbad_tsc_dmi_èbÀ
[] = {

791 .
ˇŒback
 = 
dmi_m¨k_tsc_un°abÀ
,

792 .
	gidít
 = "IBM Thinkpad 380XD",

793 .
	gm©ches
 = {

794 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

795 
DMI_MATCH
(
DMI_BOARD_NAME
, "2635FA0"),

801 
__öô
 
	$check_sy°em_tsc_ªlübÀ
()

803 #ifde‡
CONFIG_MGEODE_LX


805 
	#RTSC_SUSP
 0x100

	)

806 
ªs_low
, 
ªs_high
;

808 
	`rdm§_ß„
(
MSR_GEODE_BUSCONT_CONF0
, &
ªs_low
, &
ªs_high
);

810 i‡(
ªs_low
 & 
RTSC_SUSP
)

811 
tsc_˛ocksour˚_ªlübÀ
 = 1;

813 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

814 
tsc_˛ocksour˚_ªlübÀ
 = 1;

815 
	}
}

821 
__˝uöô
 
	$unsynchr⁄ized_tsc
()

823 i‡(!
˝u_has_tsc
 || 
tsc_un°abÀ
)

826 #ifde‡
CONFIG_SMP


827 i‡(
	`≠ic_is_˛u°îed_box
())

831 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_CONSTANT_TSC
))

837 i‡(
boŸ_˝u_d©a
.
x86_víd‹
 !
X86_VENDOR_INTEL
) {

839 i‡(
	`num_possibÀ_˝us
() > 1)

840 
tsc_un°abÀ
 = 1;

843  
tsc_un°abÀ
;

844 
	}
}

846 
__öô
 
	$öô_tsc_˛ocksour˚
()

848 
˛ocksour˚_tsc
.
mu…
 = 
	`˛ocksour˚_khz2mu…
(
tsc_khz
,

849 
˛ocksour˚_tsc
.
shi·
);

850 i‡(
tsc_˛ocksour˚_ªlübÀ
)

851 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_MUST_VERIFY
;

853 i‡(
	`check_tsc_un°abÀ
()) {

854 
˛ocksour˚_tsc
.
øtög
 = 0;

855 
˛ocksour˚_tsc
.
Êags
 &~
CLOCK_SOURCE_IS_CONTINUOUS
;

857 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_tsc
);

858 
	}
}

860 #ifde‡
CONFIG_X86_64


865 
	#TICK_COUNT
 100000000

	)

866 
__öô
 
	$ˇlibøã_˝u
()

868 
tsc_°¨t
, 
tsc_now
;

869 
i
, 
no_˘r_‰ì
;

870 
ev¡£l3
 = 0, 
pmc3
 = 0, 
pmc_now
 = 0;

871 
Êags
;

873 
i
 = 0; i < 4; i++)

874 i‡(
	`avaû_to_ª§v_≥rf˘r_nmi_bô
(
i
))

876 
no_˘r_‰ì
 = (
i
 == 4);

877 i‡(
no_˘r_‰ì
) {

878 
	`WARN
(1, 
KERN_WARNING
 "Warning: AMDÖerfctrs busy ... "

880 
i
 = 3;

881 
	`rdm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

882 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

883 
	`rdm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

885 
	`ª£rve_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

886 
	`ª£rve_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

888 
	`loˇl_úq_ßve
(
Êags
);

890 
	`wrm§l
(
MSR_K7_PERFCTR0
 + 
i
, 0);

891 
	`wrm§l
(
MSR_K7_EVNTSEL0
 + 
i
, 1 << 22 | 3 << 16 | 0x76);

892 
	`rdts˛
(
tsc_°¨t
);

894 
	`rdm§l
(
MSR_K7_PERFCTR0
 + 
i
, 
pmc_now
);

895 
tsc_now
 = 
	`gë_cy˛es
();

896 } (
tsc_now
 - 
tsc_°¨t
Ë< 
TICK_COUNT
);

898 
	`loˇl_úq_ª°‹e
(
Êags
);

899 i‡(
no_˘r_‰ì
) {

900 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 0);

901 
	`wrm§l
(
MSR_K7_PERFCTR3
, 
pmc3
);

902 
	`wrm§l
(
MSR_K7_EVNTSEL3
, 
ev¡£l3
);

904 
	`ªÀa£_≥rf˘r_nmi
(
MSR_K7_PERFCTR0
 + 
i
);

905 
	`ªÀa£_ev¡£l_nmi
(
MSR_K7_EVNTSEL0
 + 
i
);

908  
pmc_now
 * 
tsc_khz
 / (
tsc_now
 - 
tsc_°¨t
);

909 
	}
}

911 
ölöe
 
	$ˇlibøã_˝u
(Ë{  
˝u_khz
; 
	}
}

914 
__öô
 
	$tsc_öô
()

916 
u64
 
Õj
;

917 
˝u
;

919 
x86_öô
.
timîs
.
	`tsc_¥e_öô
();

921 i‡(!
˝u_has_tsc
)

924 
tsc_khz
 = 
x86_∂©f‹m
.
	`ˇlibøã_tsc
();

925 
˝u_khz
 = 
tsc_khz
;

927 i‡(!
tsc_khz
) {

928 
	`m¨k_tsc_un°abÀ
("couldÇot calculate TSC khz");

932 i‡(
	`˝u_has
(&
boŸ_˝u_d©a
, 
X86_FEATURE_CONSTANT_TSC
) &&

933 (
boŸ_˝u_d©a
.
x86_víd‹
 =
X86_VENDOR_AMD
))

934 
˝u_khz
 = 
	`ˇlibøã_˝u
();

936 
	`¥ötk
("Detected %lu.%03lu MHzÖrocessor.\n",

937 ()
˝u_khz
 / 1000,

938 ()
˝u_khz
 % 1000);

946 
	`f‹_óch_possibÀ_˝u
(
˝u
)

947 
	`£t_cyc2ns_sˇÀ
(
˝u_khz
, 
˝u
);

949 i‡(
tsc_dißbÀd
 > 0)

953 
tsc_dißbÀd
 = 0;

955 
Õj
 = ((
u64
)
tsc_khz
 * 1000);

956 
	`do_div
(
Õj
, 
HZ
);

957 
Õj_föe
 = 
Õj
;

959 
	`u£_tsc_dñay
();

961 
	`dmi_check_sy°em
(
bad_tsc_dmi_èbÀ
);

963 i‡(
	`unsynchr⁄ized_tsc
())

964 
	`m¨k_tsc_un°abÀ
("TSCs unsynchronized");

966 
	`check_sy°em_tsc_ªlübÀ
();

967 
	`öô_tsc_˛ocksour˚
();

968 
	}
}

	@/cmpt816/linux/arch/x86/kernel/tsc_sync.c

17 
	~<löux/•ölock.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/nmi.h
>

22 
	~<asm/tsc.h
>

28 
__˝uöôd©a
 
©omic_t
 
	g°¨t_cou¡
;

29 
__˝uöôd©a
 
©omic_t
 
	g°›_cou¡
;

36 
__˝uöôd©a
 
¨ch_•ölock_t
 
	gsync_lock
 = 
__ARCH_SPIN_LOCK_UNLOCKED
;

38 
__˝uöôd©a
 
cy˛es_t
 
	gœ°_tsc
;

39 
__˝uöôd©a
 
cy˛es_t
 
	gmax_w¨p
;

40 
__˝uöôd©a
 
	gƒ_w¨ps
;

45 
__˝uöô
 
	$check_tsc_w¨p
()

47 
cy˛es_t
 
°¨t
, 
now
, 
¥ev
, 
íd
;

48 
i
;

50 
	`rdtsc_b¨rõr
();

51 
°¨t
 = 
	`gë_cy˛es
();

52 
	`rdtsc_b¨rõr
();

56 
íd
 = 
°¨t
 + 
tsc_khz
 * 20ULL;

57 
now
 = 
°¨t
;

59 
i
 = 0; ; i++) {

65 
	`¨ch_•ö_lock
(&
sync_lock
);

66 
¥ev
 = 
œ°_tsc
;

67 
	`rdtsc_b¨rõr
();

68 
now
 = 
	`gë_cy˛es
();

69 
	`rdtsc_b¨rõr
();

70 
œ°_tsc
 = 
now
;

71 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

79 i‡(
	`u∆ikñy
(!(
i
 & 7))) {

80 i‡(
now
 > 
íd
 || 
i
 > 10000000)

82 
	`˝u_ªœx
();

83 
	`touch_nmi_w©chdog
();

89 i‡(
	`u∆ikñy
(
¥ev
 > 
now
)) {

90 
	`¨ch_•ö_lock
(&
sync_lock
);

91 
max_w¨p
 = 
	`max
(max_w¨p, 
¥ev
 - 
now
);

92 
ƒ_w¨ps
++;

93 
	`¨ch_•ö_u∆ock
(&
sync_lock
);

96 
	`WARN
(!(
now
-
°¨t
),

98 
now
-
°¨t
, 
íd
-start);

99 
	}
}

105 
__˝uöô
 
	$check_tsc_sync_sour˚
(
˝u
)

107 
˝us
 = 2;

113 i‡(
	`unsynchr⁄ized_tsc
())

116 i‡(
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
)) {

117 i‡(
˝u
 =(
ƒ_˝u_ids
-1Ë|| 
sy°em_°©e
 !
SYSTEM_BOOTING
)

118 
	`¥_öfo
(

126 
	`©omic_£t
(&
°›_cou¡
, 0);

131 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
-1)

132 
	`˝u_ªœx
();

136 
	`©omic_öc
(&
°¨t_cou¡
);

138 
	`check_tsc_w¨p
();

140 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
-1)

141 
	`˝u_ªœx
();

143 i‡(
ƒ_w¨ps
) {

144 
	`¥_w¨nög
("TSC synchronization [CPU#%d -> CPU#%d]:\n",

145 
	`smp_¥o˚ss‹_id
(), 
˝u
);

146 
	`¥_w¨nög
("Measured %Ld cycles TSC warp between CPUs, "

147 "tu∫ög of‡TSC clock.\n", 
max_w¨p
);

148 
	`m¨k_tsc_un°abÀ
("check_tsc_sync_source failed");

150 
	`¥_debug
("TSC synchronization [CPU#%d -> CPU#%d]:Öassed\n",

151 
	`smp_¥o˚ss‹_id
(), 
˝u
);

157 
	`©omic_£t
(&
°¨t_cou¡
, 0);

158 
ƒ_w¨ps
 = 0;

159 
max_w¨p
 = 0;

160 
œ°_tsc
 = 0;

165 
	`©omic_öc
(&
°›_cou¡
);

166 
	}
}

171 
__˝uöô
 
	$check_tsc_sync_èrgë
()

173 
˝us
 = 2;

175 i‡(
	`unsynchr⁄ized_tsc
(Ë|| 
	`boŸ_˝u_has
(
X86_FEATURE_TSC_RELIABLE
))

182 
	`©omic_öc
(&
°¨t_cou¡
);

183 
	`©omic_ªad
(&
°¨t_cou¡
Ë!
˝us
)

184 
	`˝u_ªœx
();

186 
	`check_tsc_w¨p
();

191 
	`©omic_öc
(&
°›_cou¡
);

196 
	`©omic_ªad
(&
°›_cou¡
Ë!
˝us
)

197 
	`˝u_ªœx
();

198 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsmp_64.c

15 
	~<löux/öô.h
>

16 
	~<löux/pci_ids.h
>

17 
	~<löux/pci_ªgs.h
>

19 
	~<asm/≠ic.h
>

20 
	~<asm/pci-dúe˘.h
>

21 
	~<asm/io.h
>

22 
	~<asm/∑øvút.h
>

23 
	~<asm/£tup.h
>

25 #i‡
deföed
 
CONFIG_PCI
 && deföed 
CONFIG_PARAVIRT


32 
	$vsmp_ßve_Ê
()

34 
Êags
 = 
	`«tive_ßve_Ê
();

36 i‡(!(
Êags
 & 
X86_EFLAGS_IF
Ë|| (Êag†& 
X86_EFLAGS_AC
))

37 
Êags
 &~
X86_EFLAGS_IF
;

38  
Êags
;

39 
	}
}

40 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ßve_Ê
);

42 
	$vsmp_ª°‹e_Ê
(
Êags
)

44 i‡(
Êags
 & 
X86_EFLAGS_IF
)

45 
Êags
 &~
X86_EFLAGS_AC
;

47 
Êags
 |
X86_EFLAGS_AC
;

48 
	`«tive_ª°‹e_Ê
(
Êags
);

49 
	}
}

50 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_ª°‹e_Ê
);

52 
	$vsmp_úq_dißbÀ
()

54 
Êags
 = 
	`«tive_ßve_Ê
();

56 
	`«tive_ª°‹e_Ê
((
Êags
 & ~
X86_EFLAGS_IF
Ë| 
X86_EFLAGS_AC
);

57 
	}
}

58 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_dißbÀ
);

60 
	$vsmp_úq_íabÀ
()

62 
Êags
 = 
	`«tive_ßve_Ê
();

64 
	`«tive_ª°‹e_Ê
((
Êags
 | 
X86_EFLAGS_IF
Ë& (~
X86_EFLAGS_AC
));

65 
	}
}

66 
PV_CALLEE_SAVE_REGS_THUNK
(
vsmp_úq_íabÀ
);

68 
__öô_‹_moduÀ
 
	$vsmp_∑tch
(
u8
 
ty≥
, 
u16
 
˛obbîs
, *
ibuf
,

69 
addr
, 
Àn
)

71 
ty≥
) {

72 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_íabÀ
):

73 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
úq_dißbÀ
):

74 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ßve_Ê
):

75 
	`PARAVIRT_PATCH
(
pv_úq_›s
.
ª°‹e_Ê
):

76  
	`∑øvút_∑tch_deÁu…
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

78  
	`«tive_∑tch
(
ty≥
, 
˛obbîs
, 
ibuf
, 
addr
, 
Àn
);

81 
	}
}

83 
__öô
 
	$£t_vsmp_pv_›s
()

85 
__iomem
 *
addªss
;

86 
ˇp
, 
˘l
, 
cfg
;

89 
cfg
 = 
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_BASE_ADDRESS_0
);

90 
addªss
 = 
	`óæy_i‹em≠
(
cfg
, 8);

91 
ˇp
 = 
	`ªadl
(
addªss
);

92 
˘l
 = 
	`ªadl
(
addªss
 + 4);

93 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: capabilities:0x%08x control:0x%08x\n",

94 
ˇp
, 
˘l
);

95 i‡(
ˇp
 & 
˘l
 & (1 << 4)) {

97 
pv_úq_›s
.
úq_dißbÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_dißbÀ
);

98 
pv_úq_›s
.
úq_íabÀ
 = 
	`PV_CALLEE_SAVE
(
vsmp_úq_íabÀ
);

99 
pv_úq_›s
.
ßve_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ßve_Ê
);

100 
pv_úq_›s
.
ª°‹e_Ê
 = 
	`PV_CALLEE_SAVE
(
vsmp_ª°‹e_Ê
);

101 
pv_öô_›s
.
∑tch
 = 
vsmp_∑tch
;

103 
˘l
 &= ~(1 << 4);

104 
	`wrôñ
(
˘l
, 
addªss
 + 4);

105 
˘l
 = 
	`ªadl
(
addªss
 + 4);

106 
	`¥ötk
(
KERN_INFO
 "vSMP CTL: c⁄åﬁ sëÅo:0x%08x\n", 
˘l
);

109 
	`óæy_iounm≠
(
addªss
, 8);

110 
	}
}

112 
__öô
 
	$£t_vsmp_pv_›s
()

114 
	}
}

117 #ifde‡
CONFIG_PCI


118 
	gis_vsmp
 = -1;

120 
__öô
 
	$dëe˘_vsmp_box
()

122 
is_vsmp
 = 0;

124 i‡(!
	`óæy_pci_Ælowed
())

128 i‡(
	`ªad_pci_c⁄fig
(0, 0x1f, 0, 
PCI_VENDOR_ID
) ==

129 (
PCI_VENDOR_ID_SCALEMP
 | (
PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 << 16)))

130 
is_vsmp
 = 1;

131 
	}
}

133 
	$is_vsmp_box
()

135 i‡(
is_vsmp
 != -1)

136  
is_vsmp
;

138 
	`WARN_ON_ONCE
(1);

141 
	}
}

144 
__öô
 
	$dëe˘_vsmp_box
()

146 
	}
}

147 
	$is_vsmp_box
()

150 
	}
}

152 
__öô
 
	$vsmp_öô
()

154 
	`dëe˘_vsmp_box
();

155 i‡(!
	`is_vsmp_box
())

158 
	`£t_vsmp_pv_›s
();

160 
	}
}

	@/cmpt816/linux/arch/x86/kernel/vsyscall_64.c

21 
	#DISABLE_BRANCH_PROFILING


	)

23 
	~<löux/time.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/timî.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/jiffõs.h
>

29 
	~<löux/sys˘l.h
>

30 
	~<löux/˛ocksour˚.h
>

31 
	~<löux/gë˝u.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/smp.h
>

34 
	~<löux/nŸifõr.h
>

36 
	~<asm/vsysˇŒ.h
>

37 
	~<asm/pgèbÀ.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/uni°d.h
>

40 
	~<asm/fixm≠.h
>

41 
	~<asm/î∫o.h
>

42 
	~<asm/io.h
>

43 
	~<asm/£gmít.h
>

44 
	~<asm/desc.h
>

45 
	~<asm/t›ﬁogy.h
>

46 
	~<asm/vgtod.h
>

48 
	#__vsysˇŒ
(
ƒ
) \

49 
	`__©åibuã__
 ((
unu£d
, 
	`__£˘i⁄__
(".vsysˇŒ_" #ƒ))Ë
nŸø˚


	)

50 
	#__sysˇŒ_˛obbî
 "r11","cx","mem‹y"

	)

58 
__vgë˝u_mode
 
	g__£˘i⁄_vgë˝u_mode
;

60 
vsysˇŒ_gtod_d©a
 
__vsysˇŒ_gtod_d©a
 
	g__£˘i⁄_vsysˇŒ_gtod_d©a
 =

62 .
lock
 = 
SEQLOCK_UNLOCKED
,

63 .
	gsys˘l_íabÀd
 = 1,

66 
	$upd©e_vsysˇŒ_tz
()

68 
Êags
;

70 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

72 
vsysˇŒ_gtod_d©a
.
sys_tz
 = sys_tz;

73 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

74 
	}
}

76 
	$upd©e_vsysˇŒ
(
time•ec
 *
wÆl_time
, 
˛ocksour˚
 *
˛ock
,

77 
u32
 
mu…
)

79 
Êags
;

81 
	`wrôe_£qlock_úqßve
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

83 
vsysˇŒ_gtod_d©a
.
˛ock
.
vªad
 = clock->vread;

84 
vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
 = clock->cycle_last;

85 
vsysˇŒ_gtod_d©a
.
˛ock
.
mask
 = clock->mask;

86 
vsysˇŒ_gtod_d©a
.
˛ock
.
mu…
 = mult;

87 
vsysˇŒ_gtod_d©a
.
˛ock
.
shi·
 = clock->shift;

88 
vsysˇŒ_gtod_d©a
.
wÆl_time_£c
 = 
wÆl_time
->
tv_£c
;

89 
vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
 = 
wÆl_time
->
tv_n£c
;

90 
vsysˇŒ_gtod_d©a
.
wÆl_to_m⁄Ÿ⁄ic
 = wall_to_monotonic;

91 
vsysˇŒ_gtod_d©a
.
wÆl_time_cﬂr£
 = 
	`__cuºít_kî√l_time
();

92 
	`wrôe_£qu∆ock_úqª°‹e
(&
vsysˇŒ_gtod_d©a
.
lock
, 
Êags
);

93 
	}
}

98 
__Æways_ölöe
 
	$do_gë_tz
(
timez⁄e
 * 
tz
)

100 *
tz
 = 
__vsysˇŒ_gtod_d©a
.
sys_tz
;

101 
	}
}

103 
__Æways_ölöe
 
	$gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

105 
ªt
;

106 
asm
 volatile("syscall"

107 : "˜" (
ªt
)

108 : "0" (
__NR_gëtimeofday
),"D" (
tv
),"S" (
tz
)

109 : 
__sysˇŒ_˛obbî
 );

110  
ªt
;

111 
	}
}

113 
__Æways_ölöe
 
	$time_sysˇŒ
(*
t
)

115 
£cs
;

116 
asm
 volatile("syscall"

117 : "˜" (
£cs
)

118 : "0" (
__NR_time
),"D" (
t
Ë: 
__sysˇŒ_˛obbî
);

119  
£cs
;

120 
	}
}

122 
__Æways_ölöe
 
	$do_vgëtimeofday
(
timevÆ
 * 
tv
)

124 
cy˛e_t
 
now
, 
ba£
, 
mask
, 
cy˛e_dñè
;

125 
£q
;

126 
mu…
, 
shi·
, 
n£c
;

127 
	`cy˛e_t
 (*
vªad
)();

129 
£q
 = 
	`ªad_£qbegö
(&
__vsysˇŒ_gtod_d©a
.
lock
);

131 
vªad
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.vread;

132 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
 || !
vªad
)) {

133 
	`gëtimeofday
(
tv
,
NULL
);

137 
now
 = 
	`vªad
();

138 
ba£
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.
cy˛e_œ°
;

139 
mask
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mask;

140 
mu…
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.mult;

141 
shi·
 = 
__vsysˇŒ_gtod_d©a
.
˛ock
.shift;

143 
tv
->
tv_£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_£c
;

144 
n£c
 = 
__vsysˇŒ_gtod_d©a
.
wÆl_time_n£c
;

145 } 
	`ªad_£qªåy
(&
__vsysˇŒ_gtod_d©a
.
lock
, 
£q
));

148 
cy˛e_dñè
 = (
now
 - 
ba£
Ë& 
mask
;

150 
n£c
 +(
cy˛e_dñè
 * 
mu…
Ë>> 
shi·
;

152 
n£c
 >
NSEC_PER_SEC
) {

153 
tv
->
tv_£c
 += 1;

154 
n£c
 -
NSEC_PER_SEC
;

156 
tv
->
tv_u£c
 = 
n£c
 / 
NSEC_PER_USEC
;

157 
	}
}

159 
	$__vsysˇŒ
(0Ë
	$vgëtimeofday
(
timevÆ
 * 
tv
, 
timez⁄e
 * 
tz
)

161 i‡(
tv
)

162 
	`do_vgëtimeofday
(
tv
);

163 i‡(
tz
)

164 
	`do_gë_tz
(
tz
);

166 
	}
}

170 
time_t
 
	$__vsysˇŒ
(1Ë
	$vtime
(
time_t
 *
t
)

172 
timevÆ
 
tv
;

173 
time_t
 
ªsu…
;

174 i‡(
	`u∆ikñy
(!
__vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
))

175  
	`time_sysˇŒ
(
t
);

177 
	`vgëtimeofday
(&
tv
, 
NULL
);

178 
ªsu…
 = 
tv
.
tv_£c
;

179 i‡(
t
)

180 *
t
 = 
ªsu…
;

181  
ªsu…
;

182 
	}
}

192 
	$__vsysˇŒ
(2)

193 
	$vgë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

195 
p
;

196 
j
 = 0;

206 i‡(
tˇche
 &&Åˇche->
blob
[0] =(
j
 = 
__jiffõs
)) {

207 
p
 = 
tˇche
->
blob
[1];

208 } i‡(
__vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

210 
	`«tive_ªad_ts˝
(&
p
);

213 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

215 i‡(
tˇche
) {

216 
tˇche
->
blob
[0] = 
j
;

217 
tˇche
->
blob
[1] = 
p
;

219 i‡(
˝u
)

220 *
˝u
 = 
p
 & 0xfff;

221 i‡(
node
)

222 *
node
 = 
p
 >> 12;

224 
	}
}

226 
	$__vsysˇŒ
(3Ë
	$víosys_1
()

228  -
ENOSYS
;

229 
	}
}

231 #ifde‡
CONFIG_SYSCTL


232 
˘l_èbÀ
 
	gkî√l_èbÀ2
[] = {

233 { .
¥o˙ame
 = "vsyscall64",

234 .
	gd©a
 = &
vsysˇŒ_gtod_d©a
.
sys˘l_íabÀd
, .
	gmaxÀn
 = (),

235 .
	gmode
 = 0644,

236 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
 },

240 
˘l_èbÀ
 
	gkî√l_roŸ_èbÀ2
[] = {

241 { .
¥o˙ame
 = "kî√l", .
	gmode
 = 0555,

242 .
	gchûd
 = 
kî√l_èbÀ2
 },

249 
__˝uöô
 
	$vsysˇŒ_£t_˝u
(
˝u
)

251 
d
;

252 
node
 = 0;

253 #ifde‡
CONFIG_NUMA


254 
node
 = 
	`˝u_to_node
(
˝u
);

256 i‡(
	`˝u_has
(&
	`˝u_d©a
(
˝u
), 
X86_FEATURE_RDTSCP
))

257 
	`wrôe_rdts˝_aux
((
node
 << 12Ë| 
˝u
);

262 
d
 = 0x0f40000000000ULL;

263 
d
 |
˝u
;

264 
d
 |(
node
 & 0xf) << 12;

265 
d
 |(
node
 >> 4) << 48;

266 
	`wrôe_gdt_íåy
(
	`gë_˝u_gdt_èbÀ
(
˝u
), 
GDT_ENTRY_PER_CPU
, &
d
, 
DESCTYPE_S
);

267 
	}
}

269 
__˝uöô
 
	$˝u_vsysˇŒ_öô
(*
¨g
)

272 
	`vsysˇŒ_£t_˝u
(
	`øw_smp_¥o˚ss‹_id
());

273 
	}
}

275 
__˝uöô


276 
	$˝u_vsysˇŒ_nŸifõr
(
nŸifõr_block
 *
n
, 
a˘i⁄
, *
¨g
)

278 
˝u
 = ()
¨g
;

279 i‡(
a˘i⁄
 =
CPU_ONLINE
 ||á˘i⁄ =
CPU_ONLINE_FROZEN
)

280 
	`smp_ˇŒ_fun˘i⁄_sögÀ
(
˝u
, 
˝u_vsysˇŒ_öô
, 
NULL
, 1);

281  
NOTIFY_DONE
;

282 
	}
}

284 
__öô
 
	$m≠_vsysˇŒ
()

286 
__vsysˇŒ_0
;

287 
phyßddr_∑ge0
 = 
	`__∑_symbﬁ
(&
__vsysˇŒ_0
);

290 
	`__£t_fixm≠
(
VSYSCALL_FIRST_PAGE
, 
phyßddr_∑ge0
, 
PAGE_KERNEL_VSYSCALL
);

291 
	}
}

293 
__öô
 
	$vsysˇŒ_öô
()

295 
	`BUG_ON
(((Ë&
vgëtimeofday
 !=

296 
	`VSYSCALL_ADDR
(
__NR_vgëtimeofday
)));

297 
	`BUG_ON
((Ë&
vtime
 !
	`VSYSCALL_ADDR
(
__NR_vtime
));

298 
	`BUG_ON
((
	`VSYSCALL_ADDR
(0Ë!
	`__fix_to_vút
(
VSYSCALL_FIRST_PAGE
)));

299 
	`BUG_ON
((Ë&
vgë˝u
 !
	`VSYSCALL_ADDR
(
__NR_vgë˝u
));

300 #ifde‡
CONFIG_SYSCTL


301 
	`ªgi°î_sys˘l_èbÀ
(
kî√l_roŸ_èbÀ2
);

303 
	`⁄_óch_˝u
(
˝u_vsysˇŒ_öô
, 
NULL
, 1);

305 
	`hŸ˝u_nŸifõr
(
˝u_vsysˇŒ_nŸifõr
, 30);

307 
	}
}

309 
__öôˇŒ
(
vsysˇŒ_öô
);

	@/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/smp.h
>

7 
	~<√t/checksum.h
>

9 
	~<asm/¥o˚ss‹.h
>

10 
	~<asm/pgèbÀ.h
>

11 
	~<asm/uac˚ss.h
>

12 
	~<asm/desc.h
>

13 
	~<asm/·ø˚.h
>

15 #ifde‡
CONFIG_FUNCTION_TRACER


17 
EXPORT_SYMBOL
(
mcou¡
);

20 
EXPORT_SYMBOL
(
__gë_u£r_1
);

21 
EXPORT_SYMBOL
(
__gë_u£r_2
);

22 
EXPORT_SYMBOL
(
__gë_u£r_4
);

23 
EXPORT_SYMBOL
(
__gë_u£r_8
);

24 
EXPORT_SYMBOL
(
__put_u£r_1
);

25 
EXPORT_SYMBOL
(
__put_u£r_2
);

26 
EXPORT_SYMBOL
(
__put_u£r_4
);

27 
EXPORT_SYMBOL
(
__put_u£r_8
);

29 
EXPORT_SYMBOL
(
c›y_u£r_gíîic_°rög
);

30 
EXPORT_SYMBOL
(
c›y_u£r_gíîic_uƒﬁÀd
);

31 
EXPORT_SYMBOL
(
__c›y_u£r_noˇche
);

32 
EXPORT_SYMBOL
(
_c›y_‰om_u£r
);

33 
EXPORT_SYMBOL
(
_c›y_to_u£r
);

35 
EXPORT_SYMBOL
(
c›y_∑ge
);

36 
EXPORT_SYMBOL
(
˛ór_∑ge
);

38 
EXPORT_SYMBOL
(
csum_∑πül
);

44 #unde‡
mem˝y


45 #unde‡
mem£t


46 #unde‡
memmove


48 *
mem£t
(*, , 
__kî√l_size_t
);

49 *
mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

50 *
__mem˝y
(*, c⁄° *, 
__kî√l_size_t
);

52 
EXPORT_SYMBOL
(
mem£t
);

53 
EXPORT_SYMBOL
(
mem˝y
);

54 
EXPORT_SYMBOL
(
__mem˝y
);

56 
EXPORT_SYMBOL
(
em±y_zîo_∑ge
);

57 #i‚de‡
CONFIG_PARAVIRT


58 
EXPORT_SYMBOL
(
«tive_lﬂd_gs_ödex
);

	@/cmpt816/linux/arch/x86/kernel/x86_init.c

6 
	~<löux/öô.h
>

7 
	~<löux/i›‹t.h
>

8 
	~<löux/moduÀ.h
>

10 
	~<asm/bios_ebda.h
>

11 
	~<asm/∑øvút.h
>

12 
	~<asm/pci_x86.h
>

13 
	~<asm/mp•ec.h
>

14 
	~<asm/£tup.h
>

15 
	~<asm/≠ic.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/time.h
>

18 
	~<asm/úq.h
>

19 
	~<asm/∑t.h
>

20 
	~<asm/tsc.h
>

21 
	~<asm/iommu.h
>

23 
__˝uöô
 
	$x86_öô_no›
(Ë{ 
	}
}

24 
__öô
 
	$x86_öô_uöt_no›
(
unu£d
Ë{ 
	}
}

25 
__öô
 
	$x86_öô_pgd_no›
(
pgd_t
 *
unu£d
Ë{ 
	}
}

26 
__öô
 
	$iommu_öô_no›
(Ë{  0; 
	}
}

27 
	$iommu_shutdown_no›
(Ë{ 
	}
}

33 
x86_öô_›s
 
x86_öô
 
	g__öôd©a
 = {

35 .
ªsour˚s
 = {

36 .
¥obe_roms
 = 
x86_öô_no›
,

37 .
	gª£rve_ªsour˚s
 = 
ª£rve_°™d¨d_io_ªsour˚s
,

38 .
	gmem‹y_£tup
 = 
deÁu…_machöe_•ecific_mem‹y_£tup
,

41 .
	gmµ¨£
 = {

42 .
mpc_ªc‹d
 = 
x86_öô_uöt_no›
,

43 .
	g£tup_iﬂpic_ids
 = 
x86_öô_no›
,

44 .
	gmpc_≠ic_id
 = 
deÁu…_mpc_≠ic_id
,

45 .
	gsmp_ªad_mpc_€m
 = 
deÁu…_smp_ªad_mpc_€m
,

46 .
	gmpc_€m_bus_öfo
 = 
deÁu…_mpc_€m_bus_öfo
,

47 .
	gföd_smp_c⁄fig
 = 
deÁu…_föd_smp_c⁄fig
,

48 .
	ggë_smp_c⁄fig
 = 
deÁu…_gë_smp_c⁄fig
,

51 .
	gúqs
 = {

52 .
¥e_ve˘‹_öô
 = 
öô_ISA_úqs
,

53 .
	göå_öô
 = 
«tive_öô_IRQ
,

54 .
	gå≠_öô
 = 
x86_öô_no›
,

57 .
	g€m
 = {

58 .
¨ch_£tup
 = 
x86_öô_no›
,

59 .
	gb™√r
 = 
deÁu…_b™√r
,

62 .
	g∑gög
 = {

63 .
∑gëabÀ_£tup_°¨t
 = 
«tive_∑gëabÀ_£tup_°¨t
,

64 .
	g∑gëabÀ_£tup_d⁄e
 = 
«tive_∑gëabÀ_£tup_d⁄e
,

67 .
	gtimîs
 = {

68 .
£tup_≥r˝u_˛ockev
 = 
£tup_boŸ_APIC_˛ock
,

69 .
	gtsc_¥e_öô
 = 
x86_öô_no›
,

70 .
	gtimî_öô
 = 
h≥t_time_öô
,

73 .
	giommu
 = {

74 .
iommu_öô
 = 
iommu_öô_no›
,

77 .
	gpci
 = {

78 .
öô
 = 
x86_deÁu…_pci_öô
,

79 .
	göô_úq
 = 
x86_deÁu…_pci_öô_úq
,

80 .
	gfixup_úqs
 = 
x86_deÁu…_pci_fixup_úqs
,

84 
x86_˝uöô_›s
 
x86_˝uöô
 
	g__˝uöôd©a
 = {

85 .
£tup_≥r˝u_˛ockev
 = 
£tup_£c⁄d¨y_APIC_˛ock
,

88 
	$deÁu…_nmi_öô
(Ë{ 
	}
};

89 
	$deÁu…_i8042_dëe˘
(Ë{  1; 
	}
};

91 
x86_∂©f‹m_›s
 
	gx86_∂©f‹m
 = {

92 .
ˇlibøã_tsc
 = 
«tive_ˇlibøã_tsc
,

93 .
	ggë_wÆl˛ock
 = 
mach_gë_cmos_time
,

94 .
	g£t_wÆl˛ock
 = 
mach_£t_πc_mmss
,

95 .
	giommu_shutdown
 = 
iommu_shutdown_no›
,

96 .
	gis_u¡øcked_∑t_ønge
 = 
is_ISA_ønge
,

97 .
	gnmi_öô
 = 
deÁu…_nmi_öô
,

98 .
	gi8042_dëe˘
 = 
deÁu…_i8042_dëe˘


101 
EXPORT_SYMBOL_GPL
(
x86_∂©f‹m
);

	@/cmpt816/linux/arch/x86/kernel/xsave.c

6 
	~<löux/boŸmem.h
>

7 
	~<löux/com∑t.h
>

8 
	~<asm/i387.h
>

9 #ifde‡
CONFIG_IA32_EMULATION


10 
	~<asm/sigc⁄ãxt32.h
>

12 
	~<asm/x¸.h
>

17 
u64
 
	gp˙txt_mask
;

19 
_Âx_sw_byãs
 
	gfx_sw_ª£rved
;

20 #ifde‡
CONFIG_IA32_EMULATION


21 
_Âx_sw_byãs
 
	gfx_sw_ª£rved_ü32
;

28 
	$check_f‹_x°©e
(
i387_fxßve_°ru˘
 
__u£r
 *
buf
,

29 
__u£r
 *
Â°©e
,

30 
_Âx_sw_byãs
 *
fx_sw_u£r
)

32 
mö_x°©e_size
 = (
i387_fxßve_°ru˘
) +

33 (
xßve_hdr_°ru˘
);

34 
magic2
;

35 
îr
;

37 
îr
 = 
	`__c›y_‰om_u£r
(
fx_sw_u£r
, &
buf
->
sw_ª£rved
[0],

38 (
_Âx_sw_byãs
));

40 i‡(
îr
)

41  
îr
;

46 i‡(
fx_sw_u£r
->
magic1
 !
FP_XSTATE_MAGIC1
)

52 i‡(
fx_sw_u£r
->
x°©e_size
 < 
mö_x°©e_size
 ||

53 
fx_sw_u£r
->
x°©e_size
 > xstate_size ||

54 
fx_sw_u£r
->
x°©e_size
 > fx_sw_u£r->
exãnded_size
)

57 
îr
 = 
	`__gë_u£r
(
magic2
, (
__u32
 *Ë(((*)
Â°©e
) +

58 
fx_sw_u£r
->
exãnded_size
 -

59 
FP_XSTATE_MAGIC2_SIZE
));

66 i‡(
îr
 || 
magic2
 !
FP_XSTATE_MAGIC2
)

70 
	}
}

72 #ifde‡
CONFIG_X86_64


77 
	$ßve_i387_x°©e
(
__u£r
 *
buf
)

79 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

80 
îr
 = 0;

82 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
buf
, 
sig_x°©e_size
))

83  -
EACCES
;

85 
	`BUG_ON
(
sig_x°©e_size
 < 
x°©e_size
);

87 i‡(()
buf
 % 64)

88 
	`¥ötk
("ßve_i387_x°©e: bad fp°©ê%p\n", 
buf
);

90 i‡(!
	`u£d_m©h
())

93 i‡(
	`èsk_thªad_öfo
(
tsk
)->
°©us
 & 
TS_USEDFPU
) {

98 
îr
 = 
	`__˛ór_u£r
(
buf
, 
sig_x°©e_size
);

99 i‡(
îr
)

100  
îr
;

102 i‡(
	`u£_xßve
())

103 
îr
 = 
	`xßve_u£r
(
buf
);

105 
îr
 = 
	`fxßve_u£r
(
buf
);

107 i‡(
îr
)

108  
îr
;

109 
	`èsk_thªad_öfo
(
tsk
)->
°©us
 &~
TS_USEDFPU
;

110 
	`°ts
();

112 i‡(
	`__c›y_to_u£r
(
buf
, &
tsk
->
thªad
.
Âu
.
°©e
->
fxßve
,

113 
x°©e_size
))

117 
	`˛ór_u£d_m©h
();

119 i‡(
	`u£_xßve
()) {

120 
_Â°©e
 
__u£r
 *
fx
 = 
buf
;

121 
_x°©e
 
__u£r
 *
x
 = 
buf
;

122 
u64
 
x°©e_bv
;

124 
îr
 = 
	`__c›y_to_u£r
(&
fx
->
sw_ª£rved
, &
fx_sw_ª£rved
,

125 (
_Âx_sw_byãs
));

127 
îr
 |
	`__put_u£r
(
FP_XSTATE_MAGIC2
,

128 (
__u32
 
__u£r
 *Ë(
buf
 + 
sig_x°©e_size


129 - 
FP_XSTATE_MAGIC2_SIZE
));

136 
îr
 |
	`__gë_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

149 
x°©e_bv
 |
XSTATE_FPSSE
;

151 
îr
 |
	`__put_u£r
(
x°©e_bv
, &
x
->
x°©e_hdr
.xstate_bv);

153 i‡(
îr
)

154  
îr
;

158 
	}
}

164 
	$ª°‹e_u£r_x°©e
(
__u£r
 *
buf
)

166 
_Âx_sw_byãs
 
fx_sw_u£r
;

167 
u64
 
mask
;

168 
îr
;

170 i‡((()
buf
 % 64) ||

171 
	`check_f‹_x°©e
(
buf
, buf, &
fx_sw_u£r
))

172 
fx_⁄ly
;

174 
mask
 = 
fx_sw_u£r
.
x°©e_bv
;

179 
îr
 = 
	`xª°‹e_u£r
(
buf
, 
mask
);

180 i‡(
îr
)

181  
îr
;

186 
mask
 = 
p˙txt_mask
 & ~mask;

188 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
mask
);

192 
fx_⁄ly
:

198 
	`xr°‹_°©e
(
öô_x°©e_buf
, 
p˙txt_mask
 & ~
XSTATE_FPSSE
);

199  
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)
buf
);

200 
	}
}

205 
	$ª°‹e_i387_x°©e
(
__u£r
 *
buf
)

207 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

208 
îr
 = 0;

210 i‡(!
buf
) {

211 i‡(
	`u£d_m©h
())

212 
˛ór
;

215 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
buf
, 
sig_x°©e_size
))

216  -
EACCES
;

218 i‡(!
	`u£d_m©h
()) {

219 
îr
 = 
	`öô_Âu
(
tsk
);

220 i‡(
îr
)

221  
îr
;

224 i‡(!(
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 & 
TS_USEDFPU
)) {

225 
	`˛ts
();

226 
	`èsk_thªad_öfo
(
cuºít
)->
°©us
 |
TS_USEDFPU
;

228 i‡(
	`u£_xßve
())

229 
îr
 = 
	`ª°‹e_u£r_x°©e
(
buf
);

231 
îr
 = 
	`fxr°‹_checkög
((
__f‹˚
 
i387_fxßve_°ru˘
 *)

232 
buf
);

233 i‡(
	`u∆ikñy
(
îr
)) {

238 
˛ór
:

239 
	`˛ór_Âu
(
tsk
);

240 
	`˛ór_u£d_m©h
();

242  
îr
;

243 
	}
}

253 
	$¥ï¨e_fx_sw_‰ame
()

255 
size_exãnded
 = (
x°©e_size
 - (
i387_fxßve_°ru˘
)) +

256 
FP_XSTATE_MAGIC2_SIZE
;

258 
sig_x°©e_size
 = (
_Â°©e
Ë+ 
size_exãnded
;

260 #ifde‡
CONFIG_IA32_EMULATION


261 
sig_x°©e_ü32_size
 = (
_Â°©e_ü32
Ë+ 
size_exãnded
;

264 
	`mem£t
(&
fx_sw_ª£rved
, 0, (fx_sw_reserved));

266 
fx_sw_ª£rved
.
magic1
 = 
FP_XSTATE_MAGIC1
;

267 
fx_sw_ª£rved
.
exãnded_size
 = 
sig_x°©e_size
;

268 
fx_sw_ª£rved
.
x°©e_bv
 = 
p˙txt_mask
;

269 
fx_sw_ª£rved
.
x°©e_size
 = xstate_size;

270 #ifde‡
CONFIG_IA32_EMULATION


271 
	`mem˝y
(&
fx_sw_ª£rved_ü32
, &
fx_sw_ª£rved
,

272 (
_Âx_sw_byãs
));

273 
fx_sw_ª£rved_ü32
.
exãnded_size
 = 
sig_x°©e_ü32_size
;

275 
	}
}

280 
xßve_°ru˘
 *
	göô_x°©e_buf
;

282 #ifde‡
CONFIG_X86_64


283 
	gsig_x°©e_size
 = (
_Â°©e
);

289 
__˝uöô
 
	$xßve_öô
()

291 i‡(!
˝u_has_xßve
)

294 
	`£t_ö_¸4
(
X86_CR4_OSXSAVE
);

300 
	`x£tbv
(
XCR_XFEATURE_ENABLED_MASK
, 
p˙txt_mask
);

301 
	}
}

306 
__öô
 
	$£tup_x°©e_öô
()

308 
öô_x°©e_buf
 = 
	`Æloc_boŸmem
(
x°©e_size
);

309 
öô_x°©e_buf
->
i387
.
mxc§
 = 
MXCSR_DEFAULT
;

310 
	}
}

315 
__ªf
 
	$xßve_˙txt_öô
()

317 
óx
, 
ebx
, 
ecx
, 
edx
;

319 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

320 
p˙txt_mask
 = 
óx
 + ((
u64
)
edx
 << 32);

322 i‡((
p˙txt_mask
 & 
XSTATE_FPSSE
) != XSTATE_FPSSE) {

323 
	`¥ötk
(
KERN_ERR
 "FP/SSEÇot shown under xsave features 0x%llx\n",

324 
p˙txt_mask
);

325 
	`BUG
();

331 
p˙txt_mask
 =Ö˙txt_mask & 
XCNTXT_MASK
;

332 
	`xßve_öô
();

337 
	`˝uid_cou¡
(0xd, 0, &
óx
, &
ebx
, &
ecx
, &
edx
);

338 
x°©e_size
 = 
ebx
;

340 
	`upd©e_ªg£t_x°©e_öfo
(
x°©e_size
, 
p˙txt_mask
);

341 
	`¥ï¨e_fx_sw_‰ame
();

343 
	`£tup_x°©e_öô
();

345 
	`¥ötk
(
KERN_INFO
 "xsave/xrstor:Énabled xstate_bv 0x%llx, "

347 
p˙txt_mask
, 
x°©e_size
);

348 
	}
}

	@/cmpt816/linux/arch/x86/mm/extable.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/•ölock.h
>

3 
	~<asm/uac˚ss.h
>

6 
	$fixup_ex˚±i⁄
(
±_ªgs
 *
ªgs
)

8 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

10 #ifde‡
CONFIG_PNPBIOS


11 i‡(
	`u∆ikñy
(
	`SEGMENT_IS_PNP_CODE
(
ªgs
->
cs
))) {

12 
u32
 
≤p_bios_Áu…_eù
, 
≤p_bios_Áu…_e•
;

13 
u32
 
≤p_bios_is_uâî_¸≠
;

14 
≤p_bios_is_uâî_¸≠
 = 1;

15 
	`¥ötk
(
KERN_CRIT
 "PNPBIOS fault..áttemptingÑecovery.\n");

16 
__asm__
 volatile(

19 : : "g" (
≤p_bios_Áu…_e•
), "g" (
≤p_bios_Áu…_eù
));

20 
	`∑nic
("do_trap: can't hitÅhis");

24 
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
);

25 i‡(
fixup
) {

27 i‡(
fixup
->fixup < 16) {

28 
	`cuºít_thªad_öfo
()->
uac˚ss_îr
 = -
EFAULT
;

29 
ªgs
->
ù
 +
fixup
->fixup;

32 
ªgs
->
ù
 = 
fixup
->fixup;

37 
	}
}

	@/cmpt816/linux/arch/x86/mm/fault.c

6 
	~<löux/magic.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/kdebug.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/boŸmem.h
>

11 
	~<löux/k¥obes.h
>

12 
	~<löux/mmiŸø˚.h
>

13 
	~<löux/≥rf_evít.h
>

15 
	~<asm/å≠s.h
>

16 
	~<asm/pgÆloc.h
>

17 
	~<asm/kmemcheck.h
>

28 
	ex86_pf_îr‹_code
 {

30 
	mPF_PROT
 = 1 << 0,

31 
	mPF_WRITE
 = 1 << 1,

32 
	mPF_USER
 = 1 << 2,

33 
	mPF_RSVD
 = 1 << 3,

34 
	mPF_INSTR
 = 1 << 4,

41 
ölöe
 
__k¥obes


42 
	$kmmio_Áu…
(
±_ªgs
 *
ªgs
, 
addr
)

44 i‡(
	`u∆ikñy
(
	`is_kmmio_a˘ive
()))

45 i‡(
	`kmmio_h™dÀr
(
ªgs
, 
addr
) == 1)

48 
	}
}

50 
ölöe
 
__k¥obes
 
	$nŸify_∑ge_Áu…
(
±_ªgs
 *
ªgs
)

52 
ªt
 = 0;

55 i‡(
	`k¥obes_buût_ö
(Ë&& !
	`u£r_mode_vm
(
ªgs
)) {

56 
	`¥ìm±_dißbÀ
();

57 i‡(
	`k¥obe_ru¬ög
(Ë&& 
	`k¥obe_Áu…_h™dÀr
(
ªgs
, 14))

58 
ªt
 = 1;

59 
	`¥ìm±_íabÀ
();

62  
ªt
;

63 
	}
}

80 
ölöe
 

81 
	$check_¥e„tch_›code
(
±_ªgs
 *
ªgs
, *
ö°r
,

82 
›code
, *
¥e„tch
)

84 
ö°r_hi
 = 
›code
 & 0xf0;

85 
ö°r_lo
 = 
›code
 & 0x0f;

87 
ö°r_hi
) {

96  ((
ö°r_lo
 & 7) == 0x6);

97 #ifde‡
CONFIG_X86_64


106  (!
	`u£r_mode
(
ªgs
)Ë|| (ªgs->
cs
 =
__USER_CS
);

110  (
ö°r_lo
 & 0xC) == 0x4;

113  !
ö°r_lo
 || (instr_lo>>1) == 1;

116 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

119 *
¥e„tch
 = (
ö°r_lo
 == 0xF) &&

120 (
›code
 == 0x0D || opcode == 0x18);

125 
	}
}

128 
	$is_¥e„tch
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addr
)

130 *
max_ö°r
;

131 *
ö°r
;

132 
¥e„tch
 = 0;

138 i‡(
îr‹_code
 & 
PF_INSTR
)

141 
ö°r
 = (*)
	`c⁄vît_ù_to_löór
(
cuºít
, 
ªgs
);

142 
max_ö°r
 = 
ö°r
 + 15;

144 i‡(
	`u£r_mode
(
ªgs
Ë&& 
ö°r
 >(*)
TASK_SIZE
)

147 
ö°r
 < 
max_ö°r
) {

148 
›code
;

150 i‡(
	`¥obe_kî√l_addªss
(
ö°r
, 
›code
))

153 
ö°r
++;

155 i‡(!
	`check_¥e„tch_›code
(
ªgs
, 
ö°r
, 
›code
, &
¥e„tch
))

158  
¥e„tch
;

159 
	}
}

162 
	$f‹˚_sig_öfo_Áu…
(
si_signo
, 
si_code
, 
addªss
,

163 
èsk_°ru˘
 *
tsk
)

165 
sigöfo_t
 
öfo
;

167 
öfo
.
si_signo
 = si_signo;

168 
öfo
.
si_î∫o
 = 0;

169 
öfo
.
si_code
 = si_code;

170 
öfo
.
si_addr
 = (
__u£r
 *)
addªss
;

171 
öfo
.
si_addr_lsb
 = 
si_code
 =
BUS_MCEERR_AR
 ? 
PAGE_SHIFT
 : 0;

173 
	`f‹˚_sig_öfo
(
si_signo
, &
öfo
, 
tsk
);

174 
	}
}

176 
DEFINE_SPINLOCK
(
pgd_lock
);

177 
LIST_HEAD
(
pgd_li°
);

179 #ifde‡
CONFIG_X86_32


180 
ölöe
 
pmd_t
 *
	$vmÆloc_sync_⁄e
(
pgd_t
 *
pgd
, 
addªss
)

182 
ödex
 = 
	`pgd_ödex
(
addªss
);

183 
pgd_t
 *
pgd_k
;

184 
pud_t
 *
pud
, *
pud_k
;

185 
pmd_t
 *
pmd
, *
pmd_k
;

187 
pgd
 +
ödex
;

188 
pgd_k
 = 
öô_mm
.
pgd
 + 
ödex
;

190 i‡(!
	`pgd_¥e£¡
(*
pgd_k
))

191  
NULL
;

198 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

199 
pud_k
 = 
	`pud_off£t
(
pgd_k
, 
addªss
);

200 i‡(!
	`pud_¥e£¡
(*
pud_k
))

201  
NULL
;

203 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

204 
pmd_k
 = 
	`pmd_off£t
(
pud_k
, 
addªss
);

205 i‡(!
	`pmd_¥e£¡
(*
pmd_k
))

206  
NULL
;

208 i‡(!
	`pmd_¥e£¡
(*
pmd
))

209 
	`£t_pmd
(
pmd
, *
pmd_k
);

211 
	`BUG_ON
(
	`pmd_∑ge
(*
pmd
Ë!pmd_∑ge(*
pmd_k
));

213  
pmd_k
;

214 
	}
}

216 
	$vmÆloc_sync_Æl
()

218 
addªss
;

220 i‡(
SHARED_KERNEL_PMD
)

223 
addªss
 = 
VMALLOC_START
 & 
PMD_MASK
;

224 
addªss
 >
TASK_SIZE
 &&áddªs†< 
FIXADDR_TOP
;

225 
addªss
 +
PMD_SIZE
) {

227 
Êags
;

228 
∑ge
 *page;

230 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

231 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

232 i‡(!
	`vmÆloc_sync_⁄e
(
	`∑ge_addªss
(
∑ge
), 
addªss
))

235 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

237 
	}
}

244 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

246 
pgd_∑ddr
;

247 
pmd_t
 *
pmd_k
;

248 
±e_t
 *
±e_k
;

251 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

261 
pgd_∑ddr
 = 
	`ªad_¸3
();

262 
pmd_k
 = 
	`vmÆloc_sync_⁄e
(
	`__va
(
pgd_∑ddr
), 
addªss
);

263 i‡(!
pmd_k
)

266 
±e_k
 = 
	`±e_off£t_kî√l
(
pmd_k
, 
addªss
);

267 i‡(!
	`±e_¥e£¡
(*
±e_k
))

271 
	}
}

276 
ölöe
 

277 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

278 
èsk_°ru˘
 *
tsk
)

280 
bô
;

282 i‡(!
	`v8086_mode
(
ªgs
))

285 
bô
 = (
addªss
 - 0xA0000Ë>> 
PAGE_SHIFT
;

286 i‡(
bô
 < 32)

287 
tsk
->
thªad
.
s¸ìn_bôm≠
 |1 << 
bô
;

288 
	}
}

290 
boﬁ
 
	$low_p‚
(
p‚
)

292  
p‚
 < 
max_low_p‚
;

293 
	}
}

295 
	$dump_∑gëabÀ
(
addªss
)

297 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

298 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addªss
)];

299 
pmd_t
 *
pmd
;

300 
±e_t
 *
±e
;

302 #ifde‡
CONFIG_X86_PAE


303 
	`¥ötk
("*pd± = %016Lx ", 
	`pgd_vÆ
(*
pgd
));

304 i‡(!
	`low_p‚
(
	`pgd_vÆ
(*
pgd
Ë>> 
PAGE_SHIFT
Ë|| !
	`pgd_¥e£¡
(*pgd))

305 
out
;

307 
pmd
 = 
	`pmd_off£t
(
	`pud_off£t
(
pgd
, 
addªss
),áddress);

308 
	`¥ötk
(
KERN_CONT
 "*pdê%0*Lx ", (*
pmd
Ë* 2, (
u64
)
	`pmd_vÆ
(*pmd));

316 i‡(!
	`low_p‚
(
	`pmd_p‚
(*
pmd
)Ë|| !
	`pmd_¥e£¡
(*pmdË|| 
	`pmd_œrge
(*pmd))

317 
out
;

319 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

320 
	`¥ötk
("*±ê%0*Lx ", (*
±e
Ë* 2, (
u64
)
	`±e_vÆ
(*pte));

321 
out
:

322 
	`¥ötk
("\n");

323 
	}
}

327 
	$vmÆloc_sync_Æl
()

329 
addªss
;

331 
addªss
 = 
VMALLOC_START
 & 
PGDIR_MASK
;áddªs†<
VMALLOC_END
;

332 
addªss
 +
PGDIR_SIZE
) {

334 c⁄° 
pgd_t
 *
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

335 
Êags
;

336 
∑ge
 *page;

338 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

341 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

342 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

343 
pgd_t
 *
pgd
;

344 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

345 i‡(
	`pgd_n⁄e
(*
pgd
))

346 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

348 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

350 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

352 
	}
}

361 
noölöe
 
__k¥obes
 
	$vmÆloc_Áu…
(
addªss
)

363 
pgd_t
 *
pgd
, *
pgd_ªf
;

364 
pud_t
 *
pud
, *
pud_ªf
;

365 
pmd_t
 *
pmd
, *
pmd_ªf
;

366 
±e_t
 *
±e
, *
±e_ªf
;

369 i‡(!(
addªss
 >
VMALLOC_START
 &&áddªs†< 
VMALLOC_END
))

377 
pgd
 = 
	`pgd_off£t
(
cuºít
->
a˘ive_mm
, 
addªss
);

378 
pgd_ªf
 = 
	`pgd_off£t_k
(
addªss
);

379 i‡(
	`pgd_n⁄e
(*
pgd_ªf
))

382 i‡(
	`pgd_n⁄e
(*
pgd
))

383 
	`£t_pgd
(
pgd
, *
pgd_ªf
);

385 
	`BUG_ON
(
	`pgd_∑ge_vaddr
(*
pgd
Ë!pgd_∑ge_vaddr(*
pgd_ªf
));

392 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

393 
pud_ªf
 = 
	`pud_off£t
(
pgd_ªf
, 
addªss
);

394 i‡(
	`pud_n⁄e
(*
pud_ªf
))

397 i‡(
	`pud_n⁄e
(*
pud
Ë|| 
	`pud_∑ge_vaddr
(*pudË!pud_∑ge_vaddr(*
pud_ªf
))

398 
	`BUG
();

400 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

401 
pmd_ªf
 = 
	`pmd_off£t
(
pud_ªf
, 
addªss
);

402 i‡(
	`pmd_n⁄e
(*
pmd_ªf
))

405 i‡(
	`pmd_n⁄e
(*
pmd
Ë|| 
	`pmd_∑ge
(*pmdË!pmd_∑ge(*
pmd_ªf
))

406 
	`BUG
();

408 
±e_ªf
 = 
	`±e_off£t_kî√l
(
pmd_ªf
, 
addªss
);

409 i‡(!
	`±e_¥e£¡
(*
±e_ªf
))

412 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

419 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| 
	`±e_p‚
(*±eË!±e_p‚(*
±e_ªf
))

420 
	`BUG
();

423 
	}
}

425 c⁄° 
	gîøè93_w¨nög
[] =

426 
KERN_ERR


435 
ölöe
 

436 
	$check_v8086_mode
(
±_ªgs
 *
ªgs
, 
addªss
,

437 
èsk_°ru˘
 *
tsk
)

439 
	}
}

441 
	$bad_addªss
(*
p
)

443 
dummy
;

445  
	`¥obe_kî√l_addªss
((*)
p
, 
dummy
);

446 
	}
}

448 
	$dump_∑gëabÀ
(
addªss
)

450 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
(Ë& 
PHYSICAL_PAGE_MASK
);

451 
pgd_t
 *
pgd
 = 
ba£
 + 
	`pgd_ödex
(
addªss
);

452 
pud_t
 *
pud
;

453 
pmd_t
 *
pmd
;

454 
±e_t
 *
±e
;

456 i‡(
	`bad_addªss
(
pgd
))

457 
bad
;

459 
	`¥ötk
("PGD %lx ", 
	`pgd_vÆ
(*
pgd
));

461 i‡(!
	`pgd_¥e£¡
(*
pgd
))

462 
out
;

464 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

465 i‡(
	`bad_addªss
(
pud
))

466 
bad
;

468 
	`¥ötk
("PUD %lx ", 
	`pud_vÆ
(*
pud
));

469 i‡(!
	`pud_¥e£¡
(*
pud
Ë|| 
	`pud_œrge
(*pud))

470 
out
;

472 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

473 i‡(
	`bad_addªss
(
pmd
))

474 
bad
;

476 
	`¥ötk
("PMD %lx ", 
	`pmd_vÆ
(*
pmd
));

477 i‡(!
	`pmd_¥e£¡
(*
pmd
Ë|| 
	`pmd_œrge
(*pmd))

478 
out
;

480 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

481 i‡(
	`bad_addªss
(
±e
))

482 
bad
;

484 
	`¥ötk
("PTE %lx", 
	`±e_vÆ
(*
±e
));

485 
out
:

486 
	`¥ötk
("\n");

488 
bad
:

489 
	`¥ötk
("BAD\n");

490 
	}
}

508 
	$is_îøè93
(
±_ªgs
 *
ªgs
, 
addªss
)

510 #ifde‡
CONFIG_X86_64


511 i‡(
addªss
 !
ªgs
->
ù
)

514 i‡((
addªss
 >> 32) != 0)

517 
addªss
 |= 0xffffffffUL << 32;

518 i‡((
addªss
 >(
u64
)
_°ext
 &&áddªs†<(u64)
_ëext
) ||

519 (
addªss
 >
MODULES_VADDR
 &&áddªs†<
MODULES_END
)) {

520 
	`¥ötk_⁄˚
(
îøè93_w¨nög
);

521 
ªgs
->
ù
 = 
addªss
;

526 
	}
}

536 
	$is_îøè100
(
±_ªgs
 *
ªgs
, 
addªss
)

538 #ifde‡
CONFIG_X86_64


539 i‡((
ªgs
->
cs
 =
__USER32_CS
 || (ªgs->c†& (1<<2))Ë&& (
addªss
 >> 32))

543 
	}
}

545 
	$is_f00f_bug
(
±_ªgs
 *
ªgs
, 
addªss
)

547 #ifde‡
CONFIG_X86_F00F_BUG


548 
ƒ
;

553 i‡(
boŸ_˝u_d©a
.
f00f_bug
) {

554 
ƒ
 = (
addªss
 - 
idt_des¸
.address) >> 3;

556 i‡(
ƒ
 == 6) {

557 
	`do_övÆid_›
(
ªgs
, 0);

563 
	}
}

565 c⁄° 
	gnx_w¨nög
[] = 
KERN_CRIT


569 
	$show_Áu…_o›s
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

570 
addªss
)

572 i‡(!
	`o›s_may_¥öt
())

575 i‡(
îr‹_code
 & 
PF_INSTR
) {

576 
Àvñ
;

578 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

580 i‡(
±e
 && 
	`±e_¥e£¡
(*±eË&& !
	`±e_exec
(*pte))

581 
	`¥ötk
(
nx_w¨nög
, 
	`cuºít_uid
());

584 
	`¥ötk
(
KERN_ALERT
 "BUG: unableÅo handle kernel ");

585 i‡(
addªss
 < 
PAGE_SIZE
)

586 
	`¥ötk
(
KERN_CONT
 "NULLÖointer dereference");

588 
	`¥ötk
(
KERN_CONT
 "pagingÑequest");

590 
	`¥ötk
(
KERN_CONT
 "áà%p\n", (*Ë
addªss
);

591 
	`¥ötk
(
KERN_ALERT
 "IP:");

592 
	`¥ötk_addªss
(
ªgs
->
ù
, 1);

594 
	`dump_∑gëabÀ
(
addªss
);

595 
	}
}

597 
noölöe
 

598 
	$pgèbÀ_bad
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

599 
addªss
)

601 
èsk_°ru˘
 *
tsk
;

602 
Êags
;

603 
sig
;

605 
Êags
 = 
	`o›s_begö
();

606 
tsk
 = 
cuºít
;

607 
sig
 = 
SIGKILL
;

609 
	`¥ötk
(
KERN_ALERT
 "%s: CorruptedÖageÅableátáddress %lx\n",

610 
tsk
->
comm
, 
addªss
);

611 
	`dump_∑gëabÀ
(
addªss
);

613 
tsk
->
thªad
.
¸2
 = 
addªss
;

614 
tsk
->
thªad
.
å≠_no
 = 14;

615 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

617 i‡(
	`__dõ
("BadÖagëabÀ", 
ªgs
, 
îr‹_code
))

618 
sig
 = 0;

620 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

621 
	}
}

623 
noölöe
 

624 
	$no_c⁄ãxt
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

625 
addªss
)

627 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

628 *
°ackíd
;

629 
Êags
;

630 
sig
;

633 i‡(
	`fixup_ex˚±i⁄
(
ªgs
))

647 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

650 i‡(
	`is_îøè93
(
ªgs
, 
addªss
))

657 
Êags
 = 
	`o›s_begö
();

659 
	`show_Áu…_o›s
(
ªgs
, 
îr‹_code
, 
addªss
);

661 
°ackíd
 = 
	`íd_of_°ack
(
tsk
);

662 i‡(
tsk
 !&
öô_èsk
 && *
°ackíd
 !
STACK_END_MAGIC
)

663 
	`¥ötk
(
KERN_ALERT
 "Thread overran stack, or stack corrupted\n");

665 
tsk
->
thªad
.
¸2
 = 
addªss
;

666 
tsk
->
thªad
.
å≠_no
 = 14;

667 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

669 
sig
 = 
SIGKILL
;

670 i‡(
	`__dõ
("O›s", 
ªgs
, 
îr‹_code
))

671 
sig
 = 0;

674 
	`¥ötk
(
KERN_EMERG
 "CR2: %016lx\n", 
addªss
);

676 
	`o›s_íd
(
Êags
, 
ªgs
, 
sig
);

677 
	}
}

683 
ölöe
 

684 
	$show_sig«l_msg
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

685 
addªss
, 
èsk_°ru˘
 *
tsk
)

687 i‡(!
	`unh™dÀd_sig«l
(
tsk
, 
SIGSEGV
))

690 i‡(!
	`¥ötk_øãlimô
())

693 
	`¥ötk
("%s%s[%d]: segfaultát %lx ip %p sp %pÉrror %lx",

694 
	`èsk_pid_ƒ
(
tsk
Ë> 1 ? 
KERN_INFO
 : 
KERN_EMERG
,

695 
tsk
->
comm
, 
	`èsk_pid_ƒ
—sk), 
addªss
,

696 (*)
ªgs
->
ù
, (*Ïegs->
•
, 
îr‹_code
);

698 
	`¥öt_vma_addr
(
KERN_CONT
 " i¿", 
ªgs
->
ù
);

700 
	`¥ötk
(
KERN_CONT
 "\n");

701 
	}
}

704 
	$__bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

705 
addªss
, 
si_code
)

707 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

710 i‡(
îr‹_code
 & 
PF_USER
) {

714 
	`loˇl_úq_íabÀ
();

720 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

723 i‡(
	`is_îøè100
(
ªgs
, 
addªss
))

726 i‡(
	`u∆ikñy
(
show_unh™dÀd_sig«ls
))

727 
	`show_sig«l_msg
(
ªgs
, 
îr‹_code
, 
addªss
, 
tsk
);

730 
tsk
->
thªad
.
¸2
 = 
addªss
;

731 
tsk
->
thªad
.
îr‹_code
 =Éº‹_codê| (
addªss
 >
TASK_SIZE
);

732 
tsk
->
thªad
.
å≠_no
 = 14;

734 
	`f‹˚_sig_öfo_Áu…
(
SIGSEGV
, 
si_code
, 
addªss
, 
tsk
);

739 i‡(
	`is_f00f_bug
(
ªgs
, 
addªss
))

742 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

743 
	}
}

745 
noölöe
 

746 
	$bad_¨ó_no£m≠h‹e
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

747 
addªss
)

749 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

750 
	}
}

753 
	$__bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

754 
addªss
, 
si_code
)

756 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

762 
	`up_ªad
(&
mm
->
mm≠_£m
);

764 
	`__bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
, 
si_code
);

765 
	}
}

767 
noölöe
 

768 
	$bad_¨ó
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
)

770 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_MAPERR
);

771 
	}
}

773 
noölöe
 

774 
	$bad_¨ó_ac˚ss_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

775 
addªss
)

777 
	`__bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
, 
SEGV_ACCERR
);

778 
	}
}

782 
	$out_of_mem‹y
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

783 
addªss
)

789 
	`up_ªad
(&
cuºít
->
mm
->
mm≠_£m
);

791 
	`∑geÁu…_out_of_mem‹y
();

792 
	}
}

795 
	$do_sigbus
(
±_ªgs
 *
ªgs
, 
îr‹_code
, 
addªss
,

796 
Áu…
)

798 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

799 
mm_°ru˘
 *
mm
 = 
tsk
->mm;

800 
code
 = 
BUS_ADRERR
;

802 
	`up_ªad
(&
mm
->
mm≠_£m
);

805 i‡(!(
îr‹_code
 & 
PF_USER
))

806 
	`no_c⁄ãxt
(
ªgs
, 
îr‹_code
, 
addªss
);

809 i‡(
	`is_¥e„tch
(
ªgs
, 
îr‹_code
, 
addªss
))

812 
tsk
->
thªad
.
¸2
 = 
addªss
;

813 
tsk
->
thªad
.
îr‹_code
 =Érror_code;

814 
tsk
->
thªad
.
å≠_no
 = 14;

816 #ifde‡
CONFIG_MEMORY_FAILURE


817 i‡(
Áu…
 & 
VM_FAULT_HWPOISON
) {

818 
	`¥ötk
(
KERN_ERR


820 
tsk
->
comm
,Åsk->
pid
, 
addªss
);

821 
code
 = 
BUS_MCEERR_AR
;

824 
	`f‹˚_sig_öfo_Áu…
(
SIGBUS
, 
code
, 
addªss
, 
tsk
);

825 
	}
}

827 
noölöe
 

828 
	$mm_Áu…_îr‹
(
±_ªgs
 *
ªgs
, 
îr‹_code
,

829 
addªss
, 
Áu…
)

831 i‡(
Áu…
 & 
VM_FAULT_OOM
) {

832 
	`out_of_mem‹y
(
ªgs
, 
îr‹_code
, 
addªss
);

834 i‡(
Áu…
 & (
VM_FAULT_SIGBUS
|
VM_FAULT_HWPOISON
))

835 
	`do_sigbus
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

837 
	`BUG
();

839 
	}
}

841 
	$•urious_Áu…_check
(
îr‹_code
, 
±e_t
 *
±e
)

843 i‡((
îr‹_code
 & 
PF_WRITE
Ë&& !
	`±e_wrôe
(*
±e
))

846 i‡((
îr‹_code
 & 
PF_INSTR
Ë&& !
	`±e_exec
(*
±e
))

850 
	}
}

864 
noölöe
 
__k¥obes
 

865 
	$•urious_Áu…
(
îr‹_code
, 
addªss
)

867 
pgd_t
 *
pgd
;

868 
pud_t
 *
pud
;

869 
pmd_t
 *
pmd
;

870 
±e_t
 *
±e
;

871 
ªt
;

874 i‡(
îr‹_code
 & (
PF_USER
 | 
PF_RSVD
))

877 
pgd
 = 
öô_mm
.pgd + 
	`pgd_ödex
(
addªss
);

878 i‡(!
	`pgd_¥e£¡
(*
pgd
))

881 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

882 i‡(!
	`pud_¥e£¡
(*
pud
))

885 i‡(
	`pud_œrge
(*
pud
))

886  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pud
);

888 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

889 i‡(!
	`pmd_¥e£¡
(*
pmd
))

892 i‡(
	`pmd_œrge
(*
pmd
))

893  
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

895 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

896 i‡(!
	`±e_¥e£¡
(*
±e
))

899 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, 
±e
);

900 i‡(!
ªt
)

907 
ªt
 = 
	`•urious_Áu…_check
(
îr‹_code
, (
±e_t
 *Ë
pmd
);

908 
	`WARN_ONCE
(!
ªt
, "PMD has incorrectÖermission bits\n");

910  
ªt
;

911 
	}
}

913 
	gshow_unh™dÀd_sig«ls
 = 1;

915 
ölöe
 

916 
	$ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vm_¨ó_°ru˘
 *
vma
)

918 i‡(
wrôe
) {

920 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_WRITE
)))

926 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_PROT
))

930 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
 | 
VM_WRITE
))))

934 
	}
}

936 
	$Áu…_ö_kî√l_•a˚
(
addªss
)

938  
addªss
 >
TASK_SIZE_MAX
;

939 
	}
}

946 
dŸø∂ökage
 
__k¥obes


947 
	$do_∑ge_Áu…
(
±_ªgs
 *
ªgs
, 
îr‹_code
)

949 
vm_¨ó_°ru˘
 *
vma
;

950 
èsk_°ru˘
 *
tsk
;

951 
addªss
;

952 
mm_°ru˘
 *
mm
;

953 
wrôe
;

954 
Áu…
;

956 
tsk
 = 
cuºít
;

957 
mm
 = 
tsk
->mm;

960 
addªss
 = 
	`ªad_¸2
();

966 i‡(
	`kmemcheck_a˘ive
(
ªgs
))

967 
	`kmemcheck_hide
(
ªgs
);

968 
	`¥e„tchw
(&
mm
->
mm≠_£m
);

970 i‡(
	`u∆ikñy
(
	`kmmio_Áu…
(
ªgs
, 
addªss
)))

986 i‡(
	`u∆ikñy
(
	`Áu…_ö_kî√l_•a˚
(
addªss
))) {

987 i‡(!(
îr‹_code
 & (
PF_RSVD
 | 
PF_USER
 | 
PF_PROT
))) {

988 i‡(
	`vmÆloc_Áu…
(
addªss
) >= 0)

991 i‡(
	`kmemcheck_Áu…
(
ªgs
, 
addªss
, 
îr‹_code
))

996 i‡(
	`•urious_Áu…
(
îr‹_code
, 
addªss
))

1000 i‡(
	`nŸify_∑ge_Áu…
(
ªgs
))

1006 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1012 i‡(
	`u∆ikñy
(
	`nŸify_∑ge_Áu…
(
ªgs
)))

1021 i‡(
	`u£r_mode_vm
(
ªgs
)) {

1022 
	`loˇl_úq_íabÀ
();

1023 
îr‹_code
 |
PF_USER
;

1025 i‡(
ªgs
->
Êags
 & 
X86_EFLAGS_IF
)

1026 
	`loˇl_úq_íabÀ
();

1029 i‡(
	`u∆ikñy
(
îr‹_code
 & 
PF_RSVD
))

1030 
	`pgèbÀ_bad
(
ªgs
, 
îr‹_code
, 
addªss
);

1032 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS
, 1, 0, 
ªgs
, 
addªss
);

1038 i‡(
	`u∆ikñy
(
	`ö_©omic
(Ë|| !
mm
)) {

1039 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1059 i‡(
	`u∆ikñy
(!
	`down_ªad_åylock
(&
mm
->
mm≠_£m
))) {

1060 i‡((
îr‹_code
 & 
PF_USER
) == 0 &&

1061 !
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
ù
)) {

1062 
	`bad_¨ó_no£m≠h‹e
(
ªgs
, 
îr‹_code
, 
addªss
);

1065 
	`down_ªad
(&
mm
->
mm≠_£m
);

1072 
	`might_¶ìp
();

1075 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

1076 i‡(
	`u∆ikñy
(!
vma
)) {

1077 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1080 i‡(
	`likñy
(
vma
->
vm_°¨t
 <
addªss
))

1081 
good_¨ó
;

1082 i‡(
	`u∆ikñy
(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))) {

1083 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1086 i‡(
îr‹_code
 & 
PF_USER
) {

1093 i‡(
	`u∆ikñy
(
addªss
 + 65536 + 32 * (Ë< 
ªgs
->
•
)) {

1094 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1098 i‡(
	`u∆ikñy
(
	`ex∑nd_°ack
(
vma
, 
addªss
))) {

1099 
	`bad_¨ó
(
ªgs
, 
îr‹_code
, 
addªss
);

1107 
good_¨ó
:

1108 
wrôe
 = 
îr‹_code
 & 
PF_WRITE
;

1110 i‡(
	`u∆ikñy
(
	`ac˚ss_îr‹
(
îr‹_code
, 
wrôe
, 
vma
))) {

1111 
	`bad_¨ó_ac˚ss_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
);

1120 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
wrôe
 ? 
FAULT_FLAG_WRITE
 : 0);

1122 i‡(
	`u∆ikñy
(
Áu…
 & 
VM_FAULT_ERROR
)) {

1123 
	`mm_Áu…_îr‹
(
ªgs
, 
îr‹_code
, 
addªss
, 
Áu…
);

1127 i‡(
Áu…
 & 
VM_FAULT_MAJOR
) {

1128 
tsk
->
maj_Êt
++;

1129 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MAJ
, 1, 0,

1130 
ªgs
, 
addªss
);

1132 
tsk
->
mö_Êt
++;

1133 
	`≥rf_sw_evít
(
PERF_COUNT_SW_PAGE_FAULTS_MIN
, 1, 0,

1134 
ªgs
, 
addªss
);

1137 
	`check_v8086_mode
(
ªgs
, 
addªss
, 
tsk
);

1139 
	`up_ªad
(&
mm
->
mm≠_£m
);

1140 
	}
}

	@/cmpt816/linux/arch/x86/mm/gup.c

7 
	~<löux/sched.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/vm°©.h
>

10 
	~<löux/highmem.h
>

12 
	~<asm/pgèbÀ.h
>

14 
ölöe
 
±e_t
 
	$gup_gë_±e
(
±e_t
 *
±ï
)

16 #i‚de‡
CONFIG_X86_PAE


17  
	`ACCESS_ONCE
(*
±ï
);

51 
±e_t
 
±e
;

53 
ªåy
:

54 
±e
.
±e_low
 = 
±ï
->pte_low;

55 
	`smp_rmb
();

56 
±e
.
±e_high
 = 
±ï
->pte_high;

57 
	`smp_rmb
();

58 i‡(
	`u∆ikñy
(
±e
.
±e_low
 !
±ï
->pte_low))

59 
ªåy
;

61  
±e
;

63 
	}
}

70 
noölöe
 
	$gup_±e_ønge
(
pmd_t
 
pmd
, 
addr
,

71 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

73 
mask
;

74 
±e_t
 *
±ï
;

76 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

77 i‡(
wrôe
)

78 
mask
 |
_PAGE_RW
;

80 
±ï
 = 
	`±e_off£t_m≠
(&
pmd
, 
addr
);

82 
±e_t
 
±e
 = 
	`gup_gë_±e
(
±ï
);

83 
∑ge
 *page;

85 i‡((
	`±e_Êags
(
±e
Ë& (
mask
 | 
_PAGE_SPECIAL
)) != mask) {

86 
	`±e_unm≠
(
±ï
);

89 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

90 
∑ge
 = 
	`±e_∑ge
(
±e
);

91 
	`gë_∑ge
(
∑ge
);

92 
∑ges
[*
ƒ
] = 
∑ge
;

93 (*
ƒ
)++;

95 } 
±ï
++, 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

96 
	`±e_unm≠
(
±ï
 - 1);

99 
	}
}

101 
ölöe
 
	$gë_hód_∑ge_mu…ùÀ
(
∑ge
 *∑ge, 
ƒ
)

103 
	`VM_BUG_ON
(
∑ge
 !
	`compound_hód
(page));

104 
	`VM_BUG_ON
(
	`∑ge_cou¡
(
∑ge
) == 0);

105 
	`©omic_add
(
ƒ
, &
∑ge
->
_cou¡
);

106 
	}
}

108 
noölöe
 
	$gup_huge_pmd
(
pmd_t
 
pmd
, 
addr
,

109 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

111 
mask
;

112 
±e_t
 
±e
 = *’ã_à*)&
pmd
;

113 
∑ge
 *
hód
, *page;

114 
ªfs
;

116 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

117 i‡(
wrôe
)

118 
mask
 |
_PAGE_RW
;

119 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

122 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

123 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

125 
ªfs
 = 0;

126 
hód
 = 
	`±e_∑ge
(
±e
);

127 
∑ge
 = 
hód
 + ((
addr
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

129 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

130 
∑ges
[*
ƒ
] = 
∑ge
;

131 (*
ƒ
)++;

132 
∑ge
++;

133 
ªfs
++;

134 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

135 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

138 
	}
}

140 
	$gup_pmd_ønge
(
pud_t
 
pud
, 
addr
, 
íd
,

141 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

143 
√xt
;

144 
pmd_t
 *
pmdp
;

146 
pmdp
 = 
	`pmd_off£t
(&
pud
, 
addr
);

148 
pmd_t
 
pmd
 = *
pmdp
;

150 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

151 i‡(
	`pmd_n⁄e
(
pmd
))

153 i‡(
	`u∆ikñy
(
	`pmd_œrge
(
pmd
))) {

154 i‡(!
	`gup_huge_pmd
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

157 i‡(!
	`gup_±e_ønge
(
pmd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

160 } 
pmdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

163 
	}
}

165 
noölöe
 
	$gup_huge_pud
(
pud_t
 
pud
, 
addr
,

166 
íd
, 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

168 
mask
;

169 
±e_t
 
±e
 = *’ã_à*)&
pud
;

170 
∑ge
 *
hód
, *page;

171 
ªfs
;

173 
mask
 = 
_PAGE_PRESENT
|
_PAGE_USER
;

174 i‡(
wrôe
)

175 
mask
 |
_PAGE_RW
;

176 i‡((
	`±e_Êags
(
±e
Ë& 
mask
) != mask)

179 
	`VM_BUG_ON
(
	`±e_Êags
(
±e
Ë& 
_PAGE_SPECIAL
);

180 
	`VM_BUG_ON
(!
	`p‚_vÆid
(
	`±e_p‚
(
±e
)));

182 
ªfs
 = 0;

183 
hód
 = 
	`±e_∑ge
(
±e
);

184 
∑ge
 = 
hód
 + ((
addr
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

186 
	`VM_BUG_ON
(
	`compound_hód
(
∑ge
Ë!
hód
);

187 
∑ges
[*
ƒ
] = 
∑ge
;

188 (*
ƒ
)++;

189 
∑ge
++;

190 
ªfs
++;

191 } 
addr
 +
PAGE_SIZE
,ádd∏!
íd
);

192 
	`gë_hód_∑ge_mu…ùÀ
(
hód
, 
ªfs
);

195 
	}
}

197 
	$gup_pud_ønge
(
pgd_t
 
pgd
, 
addr
, 
íd
,

198 
wrôe
, 
∑ge
 **
∑ges
, *
ƒ
)

200 
√xt
;

201 
pud_t
 *
pudp
;

203 
pudp
 = 
	`pud_off£t
(&
pgd
, 
addr
);

205 
pud_t
 
pud
 = *
pudp
;

207 
√xt
 = 
	`pud_addr_íd
(
addr
, 
íd
);

208 i‡(
	`pud_n⁄e
(
pud
))

210 i‡(
	`u∆ikñy
(
	`pud_œrge
(
pud
))) {

211 i‡(!
	`gup_huge_pud
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

214 i‡(!
	`gup_pmd_ønge
(
pud
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, 
ƒ
))

217 } 
pudp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

220 
	}
}

226 
	$__gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

227 
∑ge
 **
∑ges
)

229 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

230 
addr
, 
Àn
, 
íd
;

231 
√xt
;

232 
Êags
;

233 
pgd_t
 *
pgdp
;

234 
ƒ
 = 0;

236 
°¨t
 &
PAGE_MASK
;

237 
addr
 = 
°¨t
;

238 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

239 
íd
 = 
°¨t
 + 
Àn
;

240 i‡(
	`u∆ikñy
(!
	`ac˚ss_ok
(
wrôe
 ? 
VERIFY_WRITE
 : 
VERIFY_READ
,

241 (
__u£r
 *)
°¨t
, 
Àn
)))

262 
	`loˇl_úq_ßve
(
Êags
);

263 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

265 
pgd_t
 
pgd
 = *
pgdp
;

267 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

268 i‡(
	`pgd_n⁄e
(
pgd
))

270 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

272 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

273 
	`loˇl_úq_ª°‹e
(
Êags
);

275  
ƒ
;

276 
	}
}

294 
	$gë_u£r_∑ges_Á°
(
°¨t
, 
ƒ_∑ges
, 
wrôe
,

295 
∑ge
 **
∑ges
)

297 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

298 
addr
, 
Àn
, 
íd
;

299 
√xt
;

300 
pgd_t
 *
pgdp
;

301 
ƒ
 = 0;

303 
°¨t
 &
PAGE_MASK
;

304 
addr
 = 
°¨t
;

305 
Àn
 = (Ë
ƒ_∑ges
 << 
PAGE_SHIFT
;

307 
íd
 = 
°¨t
 + 
Àn
;

308 i‡(
íd
 < 
°¨t
)

309 
¶ow_úq⁄
;

311 #ifde‡
CONFIG_X86_64


312 i‡(
íd
 >> 
__VIRTUAL_MASK_SHIFT
)

313 
¶ow_úq⁄
;

334 
	`loˇl_úq_dißbÀ
();

335 
pgdp
 = 
	`pgd_off£t
(
mm
, 
addr
);

337 
pgd_t
 
pgd
 = *
pgdp
;

339 
√xt
 = 
	`pgd_addr_íd
(
addr
, 
íd
);

340 i‡(
	`pgd_n⁄e
(
pgd
))

341 
¶ow
;

342 i‡(!
	`gup_pud_ønge
(
pgd
, 
addr
, 
√xt
, 
wrôe
, 
∑ges
, &
ƒ
))

343 
¶ow
;

344 } 
pgdp
++, 
addr
 = 
√xt
,ádd∏!
íd
);

345 
	`loˇl_úq_íabÀ
();

347 
	`VM_BUG_ON
(
ƒ
 !(
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
);

348  
ƒ
;

351 
ªt
;

353 
¶ow
:

354 
	`loˇl_úq_íabÀ
();

355 
¶ow_úq⁄
:

357 
°¨t
 +
ƒ
 << 
PAGE_SHIFT
;

358 
∑ges
 +
ƒ
;

360 
	`down_ªad
(&
mm
->
mm≠_£m
);

361 
ªt
 = 
	`gë_u£r_∑ges
(
cuºít
, 
mm
, 
°¨t
,

362 (
íd
 - 
°¨t
Ë>> 
PAGE_SHIFT
, 
wrôe
, 0, 
∑ges
, 
NULL
);

363 
	`up_ªad
(&
mm
->
mm≠_£m
);

366 i‡(
ƒ
 > 0) {

367 i‡(
ªt
 < 0)

368 
ªt
 = 
ƒ
;

370 
ªt
 +
ƒ
;

373  
ªt
;

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/hugetlbpage.c

7 
	~<löux/öô.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/hugëlb.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/îr.h
>

13 
	~<löux/sys˘l.h
>

14 
	~<asm/mm™.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/ébÊush.h
>

17 
	~<asm/pgÆloc.h
>

19 
	$∑ge_èbÀ_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
svma
,

20 
vm_¨ó_°ru˘
 *
vma
,

21 
addr
, 
pgoff_t
 
idx
)

23 
ßddr
 = ((
idx
 - 
svma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
) +

24 
svma
->
vm_°¨t
;

25 
sba£
 = 
ßddr
 & 
PUD_MASK
;

26 
s_íd
 = 
sba£
 + 
PUD_SIZE
;

29 
vm_Êags
 = 
vma
->vm_Êag†& ~
VM_LOCKED
;

30 
svm_Êags
 = 
svma
->
vm_Êags
 & ~
VM_LOCKED
;

36 i‡(
	`pmd_ödex
(
addr
Ë!pmd_ödex(
ßddr
) ||

37 
vm_Êags
 !
svm_Êags
 ||

38 
sba£
 < 
svma
->
vm_°¨t
 || svma->
vm_íd
 < 
s_íd
)

41  
ßddr
;

42 
	}
}

44 
	$vma_sh¨óbÀ
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

46 
ba£
 = 
addr
 & 
PUD_MASK
;

47 
íd
 = 
ba£
 + 
PUD_SIZE
;

52 i‡(
vma
->
vm_Êags
 & 
VM_MAYSHARE
 &&

53 
vma
->
vm_°¨t
 <
ba£
 && 
íd
 <vma->
vm_íd
)

56 
	}
}

61 
	$huge_pmd_sh¨e
(
mm_°ru˘
 *
mm
, 
addr
, 
pud_t
 *
pud
)

63 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

64 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

65 
pgoff_t
 
idx
 = ((
addr
 - 
vma
->
vm_°¨t
Ë>> 
PAGE_SHIFT
) +

66 
vma
->
vm_pgoff
;

67 
¥io_åì_ôî
 
ôî
;

68 
vm_¨ó_°ru˘
 *
svma
;

69 
ßddr
;

70 
±e_t
 *
•ã
 = 
NULL
;

72 i‡(!
	`vma_sh¨óbÀ
(
vma
, 
addr
))

75 
	`•ö_lock
(&
m≠pög
->
i_mm≠_lock
);

76 
	`vma_¥io_åì_f‹óch
(
svma
, &
ôî
, &
m≠pög
->
i_mm≠
, 
idx
, idx) {

77 i‡(
svma
 =
vma
)

80 
ßddr
 = 
	`∑ge_èbÀ_sh¨óbÀ
(
svma
, 
vma
, 
addr
, 
idx
);

81 i‡(
ßddr
) {

82 
•ã
 = 
	`huge_±e_off£t
(
svma
->
vm_mm
, 
ßddr
);

83 i‡(
•ã
) {

84 
	`gë_∑ge
(
	`vút_to_∑ge
(
•ã
));

90 i‡(!
•ã
)

91 
out
;

93 
	`•ö_lock
(&
mm
->
∑ge_èbÀ_lock
);

94 i‡(
	`pud_n⁄e
(*
pud
))

95 
	`pud_p›uœã
(
mm
, 
pud
, (
pmd_t
 *)(()
•ã
 & 
PAGE_MASK
));

97 
	`put_∑ge
(
	`vút_to_∑ge
(
•ã
));

98 
	`•ö_u∆ock
(&
mm
->
∑ge_èbÀ_lock
);

99 
out
:

100 
	`•ö_u∆ock
(&
m≠pög
->
i_mm≠_lock
);

101 
	}
}

115 
	$huge_pmd_unsh¨e
(
mm_°ru˘
 *
mm
, *
addr
, 
±e_t
 *
±ï
)

117 
pgd_t
 *
pgd
 = 
	`pgd_off£t
(
mm
, *
addr
);

118 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, *
addr
);

120 
	`BUG_ON
(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 0);

121 i‡(
	`∑ge_cou¡
(
	`vút_to_∑ge
(
±ï
)) == 1)

124 
	`pud_˛ór
(
pud
);

125 
	`put_∑ge
(
	`vút_to_∑ge
(
±ï
));

126 *
addr
 = 
	`ALIGN
(*addr, 
HPAGE_SIZE
 * 
PTRS_PER_PTE
) - HPAGE_SIZE;

128 
	}
}

130 
±e_t
 *
	$huge_±e_Æloc
(
mm_°ru˘
 *
mm
,

131 
addr
, 
sz
)

133 
pgd_t
 *
pgd
;

134 
pud_t
 *
pud
;

135 
±e_t
 *
±e
 = 
NULL
;

137 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

138 
pud
 = 
	`pud_Æloc
(
mm
, 
pgd
, 
addr
);

139 i‡(
pud
) {

140 i‡(
sz
 =
PUD_SIZE
) {

141 
±e
 = (
±e_t
 *)
pud
;

143 
	`BUG_ON
(
sz
 !
PMD_SIZE
);

144 i‡(
	`pud_n⁄e
(*
pud
))

145 
	`huge_pmd_sh¨e
(
mm
, 
addr
, 
pud
);

146 
±e
 = (
±e_t
 *Ë
	`pmd_Æloc
(
mm
, 
pud
, 
addr
);

149 
	`BUG_ON
(
±e
 && !
	`±e_n⁄e
(*±eË&& !
	`±e_huge
(*pte));

151  
±e
;

152 
	}
}

154 
±e_t
 *
	$huge_±e_off£t
(
mm_°ru˘
 *
mm
, 
addr
)

156 
pgd_t
 *
pgd
;

157 
pud_t
 *
pud
;

158 
pmd_t
 *
pmd
 = 
NULL
;

160 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

161 i‡(
	`pgd_¥e£¡
(*
pgd
)) {

162 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

163 i‡(
	`pud_¥e£¡
(*
pud
)) {

164 i‡(
	`pud_œrge
(*
pud
))

165  (
±e_t
 *)
pud
;

166 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

169  (
±e_t
 *Ë
pmd
;

170 
	}
}

173 
∑ge
 *

174 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

176 
°¨t
 = 
addªss
;

177 
Àngth
 = 1;

178 
ƒ
;

179 
∑ge
 *page;

180 
vm_¨ó_°ru˘
 *
vma
;

182 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

183 i‡(!
vma
 || !
	`is_vm_hugëlb_∑ge
(vma))

184  
	`ERR_PTR
(-
EINVAL
);

186 
±e
 = 
	`huge_±e_off£t
(
mm
, 
addªss
);

189 
	`WARN_ON
(!
±e
 || 
	`±e_n⁄e
(*pte));

191 
∑ge
 = &
	`±e_∑ge
(*
±e
)[
vp‚
 % (
HPAGE_SIZE
/
PAGE_SIZE
)];

193 
	`WARN_ON
(!
	`PageHód
(
∑ge
));

195  
∑ge
;

196 
	}
}

198 
	$pmd_huge
(
pmd_t
 
pmd
)

201 
	}
}

203 
	$pud_huge
(
pud_t
 
pud
)

206 
	}
}

208 
∑ge
 *

209 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

210 
pmd_t
 *
pmd
, 
wrôe
)

212  
NULL
;

213 
	}
}

217 
∑ge
 *

218 
	$fﬁlow_huge_addr
(
mm_°ru˘
 *
mm
, 
addªss
, 
wrôe
)

220  
	`ERR_PTR
(-
EINVAL
);

221 
	}
}

223 
	$pmd_huge
(
pmd_t
 
pmd
)

225  !!(
	`pmd_vÆ
(
pmd
Ë& 
_PAGE_PSE
);

226 
	}
}

228 
	$pud_huge
(
pud_t
 
pud
)

230  !!(
	`pud_vÆ
(
pud
Ë& 
_PAGE_PSE
);

231 
	}
}

233 
∑ge
 *

234 
	$fﬁlow_huge_pmd
(
mm_°ru˘
 *
mm
, 
addªss
,

235 
pmd_t
 *
pmd
, 
wrôe
)

237 
∑ge
 *page;

239 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pmd
);

240 i‡(
∑ge
)

241 
∑ge
 +((
addªss
 & ~
PMD_MASK
Ë>> 
PAGE_SHIFT
);

242  
∑ge
;

243 
	}
}

245 
∑ge
 *

246 
	$fﬁlow_huge_pud
(
mm_°ru˘
 *
mm
, 
addªss
,

247 
pud_t
 *
pud
, 
wrôe
)

249 
∑ge
 *page;

251 
∑ge
 = 
	`±e_∑ge
(*(
±e_t
 *)
pud
);

252 i‡(
∑ge
)

253 
∑ge
 +((
addªss
 & ~
PUD_MASK
Ë>> 
PAGE_SHIFT
);

254  
∑ge
;

255 
	}
}

261 #ifde‡
HAVE_ARCH_HUGETLB_UNMAPPED_AREA


262 
	$hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
 *file,

263 
addr
, 
Àn
,

264 
pgoff
, 
Êags
)

266 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

267 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

268 
vm_¨ó_°ru˘
 *
vma
;

269 
°¨t_addr
;

271 i‡(
Àn
 > 
mm
->
ˇched_hﬁe_size
) {

272 
°¨t_addr
 = 
mm
->
‰ì_¨ó_ˇche
;

274 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

275 
mm
->
ˇched_hﬁe_size
 = 0;

278 
fuŒ_£¨ch
:

279 
addr
 = 
	`ALIGN
(
°¨t_addr
, 
	`huge_∑ge_size
(
h
));

281 
vma
 = 
	`föd_vma
(
mm
, 
addr
); ; vm®vma->
vm_√xt
) {

283 i‡(
TASK_SIZE
 - 
Àn
 < 
addr
) {

288 i‡(
°¨t_addr
 !
TASK_UNMAPPED_BASE
) {

289 
°¨t_addr
 = 
TASK_UNMAPPED_BASE
;

290 
mm
->
ˇched_hﬁe_size
 = 0;

291 
fuŒ_£¨ch
;

293  -
ENOMEM
;

295 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
) {

296 
mm
->
‰ì_¨ó_ˇche
 = 
addr
 + 
Àn
;

297  
addr
;

299 i‡(
addr
 + 
mm
->
ˇched_hﬁe_size
 < 
vma
->
vm_°¨t
)

300 
mm
->
ˇched_hﬁe_size
 = 
vma
->
vm_°¨t
 - 
addr
;

301 
addr
 = 
	`ALIGN
(
vma
->
vm_íd
, 
	`huge_∑ge_size
(
h
));

303 
	}
}

305 
	$hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
 *file,

306 
addr0
, 
Àn
,

307 
pgoff
, 
Êags
)

309 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

310 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

311 
vm_¨ó_°ru˘
 *
vma
, *
¥ev_vma
;

312 
ba£
 = 
mm
->
mm≠_ba£
, 
addr
 = 
addr0
;

313 
œrge°_hﬁe
 = 
mm
->
ˇched_hﬁe_size
;

314 
fú°_time
 = 1;

317 i‡(
mm
->
‰ì_¨ó_ˇche
 > 
ba£
)

318 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

320 i‡(
Àn
 <
œrge°_hﬁe
) {

321 
œrge°_hﬁe
 = 0;

322 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

324 
åy_agaö
:

326 i‡(
mm
->
‰ì_¨ó_ˇche
 < 
Àn
)

327 
Áû
;

330 
addr
 = (
mm
->
‰ì_¨ó_ˇche
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

336 i‡(!(
vma
 = 
	`föd_vma_¥ev
(
mm
, 
addr
, &
¥ev_vma
)))

337  
addr
;

343 i‡(
addr
 + 
Àn
 <
vma
->
vm_°¨t
 &&

344 (!
¥ev_vma
 || (
addr
 >¥ev_vma->
vm_íd
))) {

346 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

347  (
mm
->
‰ì_¨ó_ˇche
 = 
addr
);

350 i‡(
mm
->
‰ì_¨ó_ˇche
 =
vma
->
vm_íd
) {

351 
mm
->
‰ì_¨ó_ˇche
 = 
vma
->
vm_°¨t
;

352 
mm
->
ˇched_hﬁe_size
 = 
œrge°_hﬁe
;

357 i‡(
addr
 + 
œrge°_hﬁe
 < 
vma
->
vm_°¨t
)

358 
œrge°_hﬁe
 = 
vma
->
vm_°¨t
 - 
addr
;

361 
addr
 = (
vma
->
vm_°¨t
 - 
Àn
Ë& 
	`huge_∑ge_mask
(
h
);

362 } 
Àn
 <
vma
->
vm_°¨t
);

364 
Áû
:

369 i‡(
fú°_time
) {

370 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

371 
œrge°_hﬁe
 = 0;

372 
fú°_time
 = 0;

373 
åy_agaö
;

381 
mm
->
‰ì_¨ó_ˇche
 = 
TASK_UNMAPPED_BASE
;

382 
mm
->
ˇched_hﬁe_size
 = ~0UL;

383 
addr
 = 
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr0
,

384 
Àn
, 
pgoff
, 
Êags
);

389 
mm
->
‰ì_¨ó_ˇche
 = 
ba£
;

390 
mm
->
ˇched_hﬁe_size
 = ~0UL;

392  
addr
;

393 
	}
}

396 
	$hugëlb_gë_unm≠≥d_¨ó
(
fûe
 *fûe, 
addr
,

397 
Àn
, 
pgoff
, 
Êags
)

399 
h°©e
 *
h
 = 
	`h°©e_fûe
(
fûe
);

400 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

401 
vm_¨ó_°ru˘
 *
vma
;

403 i‡(
Àn
 & ~
	`huge_∑ge_mask
(
h
))

404  -
EINVAL
;

405 i‡(
Àn
 > 
TASK_SIZE
)

406  -
ENOMEM
;

408 i‡(
Êags
 & 
MAP_FIXED
) {

409 i‡(
	`¥ï¨e_hugïage_ønge
(
fûe
, 
addr
, 
Àn
))

410  -
EINVAL
;

411  
addr
;

414 i‡(
addr
) {

415 
addr
 = 
	`ALIGN
◊ddr, 
	`huge_∑ge_size
(
h
));

416 
vma
 = 
	`föd_vma
(
mm
, 
addr
);

417 i‡(
TASK_SIZE
 - 
Àn
 >
addr
 &&

418 (!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
))

419  
addr
;

421 i‡(
mm
->
gë_unm≠≥d_¨ó
 =
¨ch_gë_unm≠≥d_¨ó
)

422  
	`hugëlb_gë_unm≠≥d_¨ó_bŸtomup
(
fûe
, 
addr
, 
Àn
,

423 
pgoff
, 
Êags
);

425  
	`hugëlb_gë_unm≠≥d_¨ó_t›down
(
fûe
, 
addr
, 
Àn
,

426 
pgoff
, 
Êags
);

427 
	}
}

431 #ifde‡
CONFIG_X86_64


432 
__öô
 
	$£tup_hugïagesz
(*
›t
)

434 
ps
 = 
	`mem∑r£
(
›t
, &opt);

435 i‡(
ps
 =
PMD_SIZE
) {

436 
	`hugëlb_add_h°©e
(
PMD_SHIFT
 - 
PAGE_SHIFT
);

437 } i‡(
ps
 =
PUD_SIZE
 && 
˝u_has_gb∑ges
) {

438 
	`hugëlb_add_h°©e
(
PUD_SHIFT
 - 
PAGE_SHIFT
);

440 
	`¥ötk
(
KERN_ERR
 "hugepagesz: UnsupportedÖage size %lu M\n",

441 
ps
 >> 20);

445 
	}
}

446 
__£tup
("hugïagesz=", 
£tup_hugïagesz
);

	@/cmpt816/linux/arch/x86/mm/init.c

1 
	~<löux/gÂ.h
>

2 
	~<löux/öôrd.h
>

3 
	~<löux/i›‹t.h
>

4 
	~<löux/sw≠.h
>

6 
	~<asm/ˇcheÊush.h
>

7 
	~<asm/e820.h
>

8 
	~<asm/öô.h
>

9 
	~<asm/∑ge.h
>

10 
	~<asm/∑ge_ty≥s.h
>

11 
	~<asm/£˘i⁄s.h
>

12 
	~<asm/£tup.h
>

13 
	~<asm/sy°em.h
>

14 
	~<asm/ébÊush.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/¥Ÿo.h
>

18 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

20 
__öôd©a
 
	ge820_èbÀ_°¨t
;

21 
__memöôd©a
 
	ge820_èbÀ_íd
;

22 
__memöôd©a
 
	ge820_èbÀ_t›
;

24 
	ga·î_boŸmem
;

26 
	gdúe˘_gb∑ges


27 #ifde‡
CONFIG_DIRECT_GBPAGES


32 
__öô
 
	$föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
,

33 
u£_gb∑ges
)

35 
puds
, 
pmds
, 
±es
, 
èbÀs
, 
°¨t
;

37 
puds
 = (
íd
 + 
PUD_SIZE
 - 1Ë>> 
PUD_SHIFT
;

38 
èbÀs
 = 
	`roundup
(
puds
 * (
pud_t
), 
PAGE_SIZE
);

40 i‡(
u£_gb∑ges
) {

41 
exåa
;

43 
exåa
 = 
íd
 - (”nd>>
PUD_SHIFT
) << PUD_SHIFT);

44 
pmds
 = (
exåa
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

46 
pmds
 = (
íd
 + 
PMD_SIZE
 - 1Ë>> 
PMD_SHIFT
;

48 
èbÀs
 +
	`roundup
(
pmds
 * (
pmd_t
), 
PAGE_SIZE
);

50 i‡(
u£_p£
) {

51 
exåa
;

53 
exåa
 = 
íd
 - (”nd>>
PMD_SHIFT
) << PMD_SHIFT);

54 #ifde‡
CONFIG_X86_32


55 
exåa
 +
PMD_SIZE
;

57 
±es
 = (
exåa
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

59 
±es
 = (
íd
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

61 
èbÀs
 +
	`roundup
(
±es
 * (
±e_t
), 
PAGE_SIZE
);

63 #ifde‡
CONFIG_X86_32


65 
èbÀs
 +
	`roundup
(
__íd_of_fixed_addªs£s
 * (
±e_t
), 
PAGE_SIZE
);

73 #ifde‡
CONFIG_X86_32


74 
°¨t
 = 0x7000;

76 
°¨t
 = 0x8000;

78 
e820_èbÀ_°¨t
 = 
	`föd_e820_¨ó
(
°¨t
, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
,

79 
èbÀs
, 
PAGE_SIZE
);

80 i‡(
e820_èbÀ_°¨t
 == -1UL)

81 
	`∑nic
("Cannot find space forÅhe kernelÖageÅables");

83 
e820_èbÀ_°¨t
 >>
PAGE_SHIFT
;

84 
e820_èbÀ_íd
 = 
e820_èbÀ_°¨t
;

85 
e820_èbÀ_t›
 = 
e820_èbÀ_°¨t
 + (
èbÀs
 >> 
PAGE_SHIFT
);

87 
	`¥ötk
(
KERN_DEBUG
 "kernel direct mappingÅables upÅo %lx @ %lx-%lx\n",

88 
íd
, 
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
, 
e820_èbÀ_t›
 << PAGE_SHIFT);

89 
	}
}

91 
	sm≠_ønge
 {

92 
	m°¨t
;

93 
	míd
;

94 
	m∑ge_size_mask
;

97 #ifde‡
CONFIG_X86_32


98 
	#NR_RANGE_MR
 3

	)

100 
	#NR_RANGE_MR
 5

	)

103 
__memöô
 
	$ßve_mr
(
m≠_ønge
 *
mr
, 
ƒ_ønge
,

104 
°¨t_p‚
, 
íd_p‚
,

105 
∑ge_size_mask
)

107 i‡(
°¨t_p‚
 < 
íd_p‚
) {

108 i‡(
ƒ_ønge
 >
NR_RANGE_MR
)

109 
	`∑nic
("run out ofÑange for init_memory_mapping\n");

110 
mr
[
ƒ_ønge
].
°¨t
 = 
°¨t_p‚
<<
PAGE_SHIFT
;

111 
mr
[
ƒ_ønge
].
íd
 = 
íd_p‚
<<
PAGE_SHIFT
;

112 
mr
[
ƒ_ønge
].
∑ge_size_mask
 =Öage_size_mask;

113 
ƒ_ønge
++;

116  
ƒ_ønge
;

117 
	}
}

124 
__öô_ªfok
 
	$öô_mem‹y_m≠pög
(
°¨t
,

125 
íd
)

127 
∑ge_size_mask
 = 0;

128 
°¨t_p‚
, 
íd_p‚
;

129 
ªt
 = 0;

130 
pos
;

132 
m≠_ønge
 
mr
[
NR_RANGE_MR
];

133 
ƒ_ønge
, 
i
;

134 
u£_p£
, 
u£_gb∑ges
;

136 
	`¥ötk
(
KERN_INFO
 "öô_mem‹y_m≠pög: %016lx-%016lx\n", 
°¨t
, 
íd
);

138 #i‡
	`deföed
(
CONFIG_DEBUG_PAGEALLOC
Ë|| deföed(
CONFIG_KMEMCHECK
)

144 
u£_p£
 = 
u£_gb∑ges
 = 0;

146 
u£_p£
 = 
˝u_has_p£
;

147 
u£_gb∑ges
 = 
dúe˘_gb∑ges
;

151 i‡(
˝u_has_p£
)

152 
	`£t_ö_¸4
(
X86_CR4_PSE
);

155 i‡(
˝u_has_pge
) {

156 
	`£t_ö_¸4
(
X86_CR4_PGE
);

157 
__suµ‹ãd_±e_mask
 |
_PAGE_GLOBAL
;

160 i‡(
u£_gb∑ges
)

161 
∑ge_size_mask
 |1 << 
PG_LEVEL_1G
;

162 i‡(
u£_p£
)

163 
∑ge_size_mask
 |1 << 
PG_LEVEL_2M
;

165 
	`mem£t
(
mr
, 0, (mr));

166 
ƒ_ønge
 = 0;

169 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

170 
pos
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

171 #ifde‡
CONFIG_X86_32


178 i‡(
pos
 == 0)

179 
íd_p‚
 = 1<<(
PMD_SHIFT
 - 
PAGE_SHIFT
);

181 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

182 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

184 
íd_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1)Ë>> 
PMD_SHIFT
)

185 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

187 i‡(
íd_p‚
 > (
íd
 >> 
PAGE_SHIFT
))

188 
íd_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

189 i‡(
°¨t_p‚
 < 
íd_p‚
) {

190 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

191 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

195 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

196 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

197 #ifde‡
CONFIG_X86_32


198 
íd_p‚
 = (
íd
>>
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

200 
íd_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

201 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

202 i‡(
íd_p‚
 > ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
)))

203 
íd_p‚
 = ((
íd
>>
PMD_SHIFT
)<<(PMD_SHIFT - 
PAGE_SHIFT
));

206 i‡(
°¨t_p‚
 < 
íd_p‚
) {

207 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

208 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

209 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

212 #ifde‡
CONFIG_X86_64


214 
°¨t_p‚
 = ((
pos
 + (
PUD_SIZE
 - 1))>>
PUD_SHIFT
)

215 << (
PUD_SHIFT
 - 
PAGE_SHIFT
);

216 
íd_p‚
 = (
íd
 >> 
PUD_SHIFT
Ë<< (PUD_SHIFT - 
PAGE_SHIFT
);

217 i‡(
°¨t_p‚
 < 
íd_p‚
) {

218 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

219 
∑ge_size_mask
 &

220 ((1<<
PG_LEVEL_2M
)|(1<<
PG_LEVEL_1G
)));

221 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

225 
°¨t_p‚
 = ((
pos
 + (
PMD_SIZE
 - 1))>>
PMD_SHIFT
)

226 << (
PMD_SHIFT
 - 
PAGE_SHIFT
);

227 
íd_p‚
 = (
íd
 >> 
PMD_SHIFT
Ë<< (PMD_SHIFT - 
PAGE_SHIFT
);

228 i‡(
°¨t_p‚
 < 
íd_p‚
) {

229 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
,

230 
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
));

231 
pos
 = 
íd_p‚
 << 
PAGE_SHIFT
;

236 
°¨t_p‚
 = 
pos
>>
PAGE_SHIFT
;

237 
íd_p‚
 = 
íd
>>
PAGE_SHIFT
;

238 
ƒ_ønge
 = 
	`ßve_mr
(
mr
,Çr_ønge, 
°¨t_p‚
, 
íd_p‚
, 0);

241 
i
 = 0; 
ƒ_ønge
 > 1 && i <Çr_range - 1; i++) {

242 
ﬁd_°¨t
;

243 i‡(
mr
[
i
].
íd
 !mr[i+1].
°¨t
 ||

244 
mr
[
i
].
∑ge_size_mask
 != mr[i+1].page_size_mask)

247 
ﬁd_°¨t
 = 
mr
[
i
].
°¨t
;

248 
	`memmove
(&
mr
[
i
], &mr[i+1],

249 (
ƒ_ønge
 - 1 - 
i
Ë* (
m≠_ønge
));

250 
mr
[
i
--].
°¨t
 = 
ﬁd_°¨t
;

251 
ƒ_ønge
--;

254 
i
 = 0; i < 
ƒ_ønge
; i++)

255 
	`¥ötk
(
KERN_DEBUG
 " %010lx - %010lxÖage %s\n",

256 
mr
[
i
].
°¨t
, mr[i].
íd
,

257 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
))?"1G":(

258 (
mr
[
i
].
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
))?"2M":"4k"));

267 i‡(!
a·î_boŸmem
)

268 
	`föd_óæy_èbÀ_•a˚
(
íd
, 
u£_p£
, 
u£_gb∑ges
);

270 
i
 = 0; i < 
ƒ_ønge
; i++)

271 
ªt
 = 
	`kî√l_physiˇl_m≠pög_öô
(
mr
[
i
].
°¨t
, mr[i].
íd
,

272 
mr
[
i
].
∑ge_size_mask
);

274 #ifde‡
CONFIG_X86_32


275 
	`óæy_i‹em≠_∑ge_èbÀ_ønge_öô
();

277 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

280 #ifde‡
CONFIG_X86_64


281 i‡(!
a·î_boŸmem
 && !
°¨t
) {

282 
pud_t
 *
pud
;

283 
pmd_t
 *
pmd
;

285 
mmu_¸4_„©uªs
 = 
	`ªad_¸4
();

293 
pud
 = 
	`pud_off£t
(
	`pgd_off£t_k
(
_brk_íd
), _brk_end);

294 
pmd
 = 
	`pmd_off£t
(
pud
, 
_brk_íd
 - 1);

295 ++
pmd
 <
	`pmd_off£t
(
pud
, ()
_íd
 - 1))

296 
	`pmd_˛ór
(
pmd
);

299 
	`__Êush_éb_Æl
();

301 i‡(!
a·î_boŸmem
 && 
e820_èbÀ_íd
 > 
e820_èbÀ_°¨t
)

302 
	`ª£rve_óæy
(
e820_èbÀ_°¨t
 << 
PAGE_SHIFT
,

303 
e820_èbÀ_íd
 << 
PAGE_SHIFT
, "PGTABLE");

305 i‡(!
a·î_boŸmem
)

306 
	`óæy_memã°
(
°¨t
, 
íd
);

308  
ªt
 >> 
PAGE_SHIFT
;

309 
	}
}

322 
	$devmem_is_Ælowed
(
∑gír
)

324 i‡(
∑gír
 <= 256)

326 i‡(
	`iomem_is_ex˛usive
(
∑gír
 << 
PAGE_SHIFT
))

328 i‡(!
	`∑ge_is_øm
(
∑gír
))

331 
	}
}

333 
	$‰ì_öô_∑ges
(*
wh©
, 
begö
, 
íd
)

335 
addr
;

336 
begö_Æig√d
, 
íd_Æig√d
;

339 
begö_Æig√d
 = 
	`PAGE_ALIGN
(
begö
);

340 
íd_Æig√d
 = 
íd
 & 
PAGE_MASK
;

342 i‡(
	`WARN_ON
(
begö_Æig√d
 !
begö
 || 
íd_Æig√d
 !
íd
)) {

343 
begö
 = 
begö_Æig√d
;

344 
íd
 = 
íd_Æig√d
;

347 i‡(
begö
 >
íd
)

350 
addr
 = 
begö
;

357 #ifde‡
CONFIG_DEBUG_PAGEALLOC


358 
	`¥ötk
(
KERN_INFO
 "debug: unmapping init memory %08lx..%08lx\n",

359 
begö
, 
íd
);

360 
	`£t_mem‹y_≈
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

367 
	`£t_mem‹y_rw
(
begö
, (
íd
 - begöË>> 
PAGE_SHIFT
);

369 
	`¥ötk
(
KERN_INFO
 "Fªeög %s: %luk fªed\n", 
wh©
, (
íd
 - 
begö
) >> 10);

371 ; 
addr
 < 
íd
;ádd∏+
PAGE_SIZE
) {

372 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
addr
));

373 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
addr
));

374 
	`mem£t
((*)
addr
, 
POISON_FREE_INITMEM
, 
PAGE_SIZE
);

375 
	`‰ì_∑ge
(
addr
);

376 
tŸÆøm_∑ges
++;

379 
	}
}

381 
	$‰ì_öômem
()

383 
	`‰ì_öô_∑ges
("unused kernel memory",

384 ()(&
__öô_begö
),

385 ()(&
__öô_íd
));

386 
	}
}

388 #ifde‡
CONFIG_BLK_DEV_INITRD


389 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

400 
	`‰ì_öô_∑ges
("öôrd mem‹y", 
°¨t
, 
	`PAGE_ALIGN
(
íd
));

401 
	}
}

	@/cmpt816/linux/arch/x86/mm/init_64.c

9 
	~<löux/sig«l.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/±ø˚.h
>

16 
	~<löux/mm™.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sw≠.h
>

19 
	~<löux/smp.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/∑gem≠.h
>

23 
	~<löux/boŸmem.h
>

24 
	~<löux/¥oc_fs.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/p‚.h
>

27 
	~<löux/pois⁄.h
>

28 
	~<löux/dma-m≠pög.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/mem‹y_hŸ∂ug.h
>

31 
	~<löux/nmi.h
>

32 
	~<löux/gÂ.h
>

34 
	~<asm/¥o˚ss‹.h
>

35 
	~<asm/bios_ebda.h
>

36 
	~<asm/sy°em.h
>

37 
	~<asm/uac˚ss.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/pgÆloc.h
>

40 
	~<asm/dma.h
>

41 
	~<asm/fixm≠.h
>

42 
	~<asm/e820.h
>

43 
	~<asm/≠ic.h
>

44 
	~<asm/éb.h
>

45 
	~<asm/mmu_c⁄ãxt.h
>

46 
	~<asm/¥Ÿo.h
>

47 
	~<asm/smp.h
>

48 
	~<asm/£˘i⁄s.h
>

49 
	~<asm/kdebug.h
>

50 
	~<asm/numa.h
>

51 
	~<asm/ˇcheÊush.h
>

52 
	~<asm/öô.h
>

53 
	~<löux/boŸmem.h
>

55 
dma_ª£rve
 
	g__öôd©a
;

57 
__öô
 
	$∑r£_dúe˘_gb∑ges_off
(*
¨g
)

59 
dúe˘_gb∑ges
 = 0;

61 
	}
}

62 
óæy_∑øm
("nogb∑ges", 
∑r£_dúe˘_gb∑ges_off
);

64 
__öô
 
	$∑r£_dúe˘_gb∑ges_⁄
(*
¨g
)

66 
dúe˘_gb∑ges
 = 1;

68 
	}
}

69 
óæy_∑øm
("gb∑ges", 
∑r£_dúe˘_gb∑ges_⁄
);

77 
±evÆ_t
 
__suµ‹ãd_±e_mask
 
	g__ªad_mo°ly
 = ~
_PAGE_IOMAP
;

78 
EXPORT_SYMBOL_GPL
(
__suµ‹ãd_±e_mask
);

80 
	gf‹˚_≥rs⁄Æôy32
;

90 
__öô
 
	$n⁄x32_£tup
(*
°r
)

92 i‡(!
	`°rcmp
(
°r
, "on"))

93 
f‹˚_≥rs⁄Æôy32
 &~
READ_IMPLIES_EXEC
;

94 i‡(!
	`°rcmp
(
°r
, "off"))

95 
f‹˚_≥rs⁄Æôy32
 |
READ_IMPLIES_EXEC
;

97 
	}
}

98 
__£tup
("n€xec32=", 
n⁄x32_£tup
);

104 
__ªf
 *
	$•p_gë∑ge
()

106 *
±r
;

108 i‡(
a·î_boŸmem
)

109 
±r
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

111 
±r
 = 
	`Æloc_boŸmem_∑ges
(
PAGE_SIZE
);

113 i‡(!
±r
 || ((Ìå & ~
PAGE_MASK
)) {

114 
	`∑nic
("set_pte_phys: cannotállocateÖage data %s\n",

115 
a·î_boŸmem
 ? "after bootmem" : "");

118 
	`¥_debug
("•p_gë∑gê%p\n", 
±r
);

120  
±r
;

121 
	}
}

123 
pud_t
 *
	$fûl_pud
(
pgd_t
 *
pgd
, 
vaddr
)

125 i‡(
	`pgd_n⁄e
(*
pgd
)) {

126 
pud_t
 *
pud
 = (pud_à*)
	`•p_gë∑ge
();

127 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
pud
);

128 i‡(
pud
 !
	`pud_off£t
(
pgd
, 0))

129 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #00! %p <-> %p\n",

130 
pud
, 
	`pud_off£t
(
pgd
, 0));

132  
	`pud_off£t
(
pgd
, 
vaddr
);

133 
	}
}

135 
pmd_t
 *
	$fûl_pmd
(
pud_t
 *
pud
, 
vaddr
)

137 i‡(
	`pud_n⁄e
(*
pud
)) {

138 
pmd_t
 *
pmd
 = (pmd_à*Ë
	`•p_gë∑ge
();

139 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
pmd
);

140 i‡(
pmd
 !
	`pmd_off£t
(
pud
, 0))

141 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #01! %p <-> %p\n",

142 
pmd
, 
	`pmd_off£t
(
pud
, 0));

144  
	`pmd_off£t
(
pud
, 
vaddr
);

145 
	}
}

147 
±e_t
 *
	$fûl_±e
(
pmd_t
 *
pmd
, 
vaddr
)

149 i‡(
	`pmd_n⁄e
(*
pmd
)) {

150 
±e_t
 *
±e
 = (±e_à*Ë
	`•p_gë∑ge
();

151 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
±e
);

152 i‡(
±e
 !
	`±e_off£t_kî√l
(
pmd
, 0))

153 
	`¥ötk
(
KERN_ERR
 "PAGETABLE BUG #02!\n");

155  
	`±e_off£t_kî√l
(
pmd
, 
vaddr
);

156 
	}
}

158 
	$£t_±e_vaddr_pud
(
pud_t
 *
pud_∑ge
, 
vaddr
, 
±e_t
 
√w_±e
)

160 
pud_t
 *
pud
;

161 
pmd_t
 *
pmd
;

162 
±e_t
 *
±e
;

164 
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
vaddr
);

165 
pmd
 = 
	`fûl_pmd
(
pud
, 
vaddr
);

166 
±e
 = 
	`fûl_±e
(
pmd
, 
vaddr
);

168 
	`£t_±e
(
±e
, 
√w_±e
);

174 
	`__Êush_éb_⁄e
(
vaddr
);

175 
	}
}

177 
	$£t_±e_vaddr
(
vaddr
, 
±e_t
 
±evÆ
)

179 
pgd_t
 *
pgd
;

180 
pud_t
 *
pud_∑ge
;

182 
	`¥_debug
("£t_±e_vadd∏%lxÅÿ%lx\n", 
vaddr
, 
	`«tive_±e_vÆ
(
±evÆ
));

184 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

185 i‡(
	`pgd_n⁄e
(*
pgd
)) {

186 
	`¥ötk
(
KERN_ERR


190 
pud_∑ge
 = (
pud_t
*)
	`pgd_∑ge_vaddr
(*
pgd
);

191 
	`£t_±e_vaddr_pud
(
pud_∑ge
, 
vaddr
, 
±evÆ
);

192 
	}
}

194 
pmd_t
 * 
__öô
 
	$p›uœã_exåa_pmd
(
vaddr
)

196 
pgd_t
 *
pgd
;

197 
pud_t
 *
pud
;

199 
pgd
 = 
	`pgd_off£t_k
(
vaddr
);

200 
pud
 = 
	`fûl_pud
(
pgd
, 
vaddr
);

201  
	`fûl_pmd
(
pud
, 
vaddr
);

202 
	}
}

204 
±e_t
 * 
__öô
 
	$p›uœã_exåa_±e
(
vaddr
)

206 
pmd_t
 *
pmd
;

208 
pmd
 = 
	`p›uœã_exåa_pmd
(
vaddr
);

209  
	`fûl_±e
(
pmd
, 
vaddr
);

210 
	}
}

215 
__öô
 
	$__öô_exåa_m≠pög
(
phys
, 
size
,

216 
pg¥Ÿ_t
 
¥Ÿ
)

218 
pgd_t
 *
pgd
;

219 
pud_t
 *
pud
;

220 
pmd_t
 *
pmd
;

222 
	`BUG_ON
((
phys
 & ~
PMD_MASK
Ë|| (
size
 & ~PMD_MASK));

223 ; 
size
; 
phys
 +
PMD_SIZE
, size -= PMD_SIZE) {

224 
pgd
 = 
	`pgd_off£t_k
(()
	`__va
(
phys
));

225 i‡(
	`pgd_n⁄e
(*
pgd
)) {

226 
pud
 = (
pud_t
 *Ë
	`•p_gë∑ge
();

227 
	`£t_pgd
(
pgd
, 
	`__pgd
(
	`__∑
(
pud
Ë| 
_KERNPG_TABLE
 |

228 
_PAGE_USER
));

230 
pud
 = 
	`pud_off£t
(
pgd
, ()
	`__va
(
phys
));

231 i‡(
	`pud_n⁄e
(*
pud
)) {

232 
pmd
 = (
pmd_t
 *Ë
	`•p_gë∑ge
();

233 
	`£t_pud
(
pud
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_KERNPG_TABLE
 |

234 
_PAGE_USER
));

236 
pmd
 = 
	`pmd_off£t
(
pud
, 
phys
);

237 
	`BUG_ON
(!
	`pmd_n⁄e
(*
pmd
));

238 
	`£t_pmd
(
pmd
, 
	`__pmd
(
phys
 | 
	`pg¥Ÿ_vÆ
(
¥Ÿ
)));

240 
	}
}

242 
__öô
 
	$öô_exåa_m≠pög_wb
(
phys
, 
size
)

244 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE
);

245 
	}
}

247 
__öô
 
	$öô_exåa_m≠pög_uc
(
phys
, 
size
)

249 
	`__öô_exåa_m≠pög
(
phys
, 
size
, 
PAGE_KERNEL_LARGE_NOCACHE
);

250 
	}
}

265 
__öô
 
	$˛ónup_highm≠
()

267 
vaddr
 = 
__START_KERNEL_m≠
;

268 
íd
 = 
	`roundup
(()
_íd
, 
PMD_SIZE
) - 1;

269 
pmd_t
 *
pmd
 = 
Àvñ2_kî√l_pgt
;

270 
pmd_t
 *
œ°_pmd
 = 
pmd
 + 
PTRS_PER_PMD
;

272 ; 
pmd
 < 
œ°_pmd
;Ömd++, 
vaddr
 +
PMD_SIZE
) {

273 i‡(
	`pmd_n⁄e
(*
pmd
))

275 i‡(
vaddr
 < (Ë
_ãxt
 || vadd∏> 
íd
)

276 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

278 
	}
}

280 
__ªf
 *
	$Æloc_low_∑ge
(*
phys
)

282 
p‚
 = 
e820_èbÀ_íd
++;

283 *
adr
;

285 i‡(
a·î_boŸmem
) {

286 
adr
 = (*)
	`gë_zî€d_∑ge
(
GFP_ATOMIC
 | 
__GFP_NOTRACK
);

287 *
phys
 = 
	`__∑
(
adr
);

289  
adr
;

292 i‡(
p‚
 >
e820_èbÀ_t›
)

293 
	`∑nic
("alloc_low_page:Ñan out of memory");

295 
adr
 = 
	`óæy_memªm≠
(
p‚
 * 
PAGE_SIZE
, PAGE_SIZE);

296 
	`mem£t
(
adr
, 0, 
PAGE_SIZE
);

297 *
phys
 = 
p‚
 * 
PAGE_SIZE
;

298  
adr
;

299 
	}
}

301 
__ªf
 
	$unm≠_low_∑ge
(*
adr
)

303 i‡(
a·î_boŸmem
)

306 
	`óæy_iounm≠
(
adr
, 
PAGE_SIZE
);

307 
	}
}

309 
__memöô


310 
	$phys_±e_öô
(
±e_t
 *
±e_∑ge
, 
addr
, 
íd
,

311 
pg¥Ÿ_t
 
¥Ÿ
)

313 
∑ges
 = 0;

314 
œ°_m≠_addr
 = 
íd
;

315 
i
;

317 
±e_t
 *
±e
 = 
±e_∑ge
 + 
	`±e_ödex
(
addr
);

319 
i
 = 
	`±e_ödex
(
addr
); i < 
PTRS_PER_PTE
; i++,ádd∏+
PAGE_SIZE
, 
±e
++) {

321 i‡(
addr
 >
íd
) {

322 i‡(!
a·î_boŸmem
) {

323 ; 
i
 < 
PTRS_PER_PTE
; i++, 
±e
++)

324 
	`£t_±e
(
±e
, 
	`__±e
(0));

335 i‡(
	`±e_vÆ
(*
±e
)) {

336 
∑ges
++;

341 
	`¥ötk
("Öte=%páddr=%lxÖte=%016lx\n",

342 
±e
, 
addr
, 
	`p‚_±e
◊dd∏>> 
PAGE_SHIFT
, 
PAGE_KERNEL
).pte);

343 
∑ges
++;

344 
	`£t_±e
(
±e
, 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
¥Ÿ
));

345 
œ°_m≠_addr
 = (
addr
 & 
PAGE_MASK
Ë+ 
PAGE_SIZE
;

348 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_4K
, 
∑ges
);

350  
œ°_m≠_addr
;

351 
	}
}

353 
__memöô


354 
	$phys_±e_upd©e
(
pmd_t
 *
pmd
, 
addªss
, 
íd
,

355 
pg¥Ÿ_t
 
¥Ÿ
)

357 
±e_t
 *
±e
 = (±e_à*)
	`pmd_∑ge_vaddr
(*
pmd
);

359  
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
¥Ÿ
);

360 
	}
}

362 
__memöô


363 
	$phys_pmd_öô
(
pmd_t
 *
pmd_∑ge
, 
addªss
, 
íd
,

364 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

366 
∑ges
 = 0;

367 
œ°_m≠_addr
 = 
íd
;

369 
i
 = 
	`pmd_ödex
(
addªss
);

371 ; 
i
 < 
PTRS_PER_PMD
; i++, 
addªss
 +
PMD_SIZE
) {

372 
±e_phys
;

373 
pmd_t
 *
pmd
 = 
pmd_∑ge
 + 
	`pmd_ödex
(
addªss
);

374 
±e_t
 *
±e
;

375 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
¥Ÿ
;

377 i‡(
addªss
 >
íd
) {

378 i‡(!
a·î_boŸmem
) {

379 ; 
i
 < 
PTRS_PER_PMD
; i++, 
pmd
++)

380 
	`£t_pmd
(
pmd
, 
	`__pmd
(0));

385 i‡(
	`pmd_vÆ
(*
pmd
)) {

386 i‡(!
	`pmd_œrge
(*
pmd
)) {

387 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

388 
œ°_m≠_addr
 = 
	`phys_±e_upd©e
(
pmd
, 
addªss
,

389 
íd
, 
¥Ÿ
);

390 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

405 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_2M
)) {

406 
∑ges
++;

409 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pmd
));

412 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_2M
)) {

413 
∑ges
++;

414 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

415 
	`£t_±e
((
±e_t
 *)
pmd
,

416 
	`p‚_±e
(
addªss
 >> 
PAGE_SHIFT
,

417 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_PSE
)));

418 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

419 
œ°_m≠_addr
 = (
addªss
 & 
PMD_MASK
Ë+ 
PMD_SIZE
;

423 
±e
 = 
	`Æloc_low_∑ge
(&
±e_phys
);

424 
œ°_m≠_addr
 = 
	`phys_±e_öô
(
±e
, 
addªss
, 
íd
, 
√w_¥Ÿ
);

425 
	`unm≠_low_∑ge
(
±e
);

427 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

428 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
	`__va
(
±e_phys
));

429 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

431 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_2M
, 
∑ges
);

432  
œ°_m≠_addr
;

433 
	}
}

435 
__memöô


436 
	$phys_pmd_upd©e
(
pud_t
 *
pud
, 
addªss
, 
íd
,

437 
∑ge_size_mask
, 
pg¥Ÿ_t
 
¥Ÿ
)

439 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 0);

440 
œ°_m≠_addr
;

442 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addªss
, 
íd
, 
∑ge_size_mask
, 
¥Ÿ
);

443 
	`__Êush_éb_Æl
();

444  
œ°_m≠_addr
;

445 
	}
}

447 
__memöô


448 
	$phys_pud_öô
(
pud_t
 *
pud_∑ge
, 
addr
, 
íd
,

449 
∑ge_size_mask
)

451 
∑ges
 = 0;

452 
œ°_m≠_addr
 = 
íd
;

453 
i
 = 
	`pud_ödex
(
addr
);

455 ; 
i
 < 
PTRS_PER_PUD
; i++, 
addr
 = (add∏& 
PUD_MASK
Ë+ 
PUD_SIZE
) {

456 
pmd_phys
;

457 
pud_t
 *
pud
 = 
pud_∑ge
 + 
	`pud_ödex
(
addr
);

458 
pmd_t
 *
pmd
;

459 
pg¥Ÿ_t
 
¥Ÿ
 = 
PAGE_KERNEL
;

461 i‡(
addr
 >
íd
)

464 i‡(!
a·î_boŸmem
 &&

465 !
	`e820_™y_m≠≥d
(
addr
,áddr+
PUD_SIZE
, 0)) {

466 
	`£t_pud
(
pud
, 
	`__pud
(0));

470 i‡(
	`pud_vÆ
(*
pud
)) {

471 i‡(!
	`pud_œrge
(*
pud
)) {

472 
œ°_m≠_addr
 = 
	`phys_pmd_upd©e
(
pud
, 
addr
, 
íd
,

473 
∑ge_size_mask
, 
¥Ÿ
);

488 i‡(
∑ge_size_mask
 & (1 << 
PG_LEVEL_1G
)) {

489 
∑ges
++;

492 
¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*(
±e_t
 *)
pud
));

495 i‡(
∑ge_size_mask
 & (1<<
PG_LEVEL_1G
)) {

496 
∑ges
++;

497 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

498 
	`£t_±e
((
±e_t
 *)
pud
,

499 
	`p‚_±e
(
addr
 >> 
PAGE_SHIFT
, 
PAGE_KERNEL_LARGE
));

500 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

501 
œ°_m≠_addr
 = (
addr
 & 
PUD_MASK
Ë+ 
PUD_SIZE
;

505 
pmd
 = 
	`Æloc_low_∑ge
(&
pmd_phys
);

506 
œ°_m≠_addr
 = 
	`phys_pmd_öô
(
pmd
, 
addr
, 
íd
, 
∑ge_size_mask
,

507 
¥Ÿ
);

508 
	`unm≠_low_∑ge
(
pmd
);

510 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

511 
	`pud_p›uœã
(&
öô_mm
, 
pud
, 
	`__va
(
pmd_phys
));

512 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

514 
	`__Êush_éb_Æl
();

516 
	`upd©e_∑ge_cou¡
(
PG_LEVEL_1G
, 
∑ges
);

518  
œ°_m≠_addr
;

519 
	}
}

521 
__memöô


522 
	$phys_pud_upd©e
(
pgd_t
 *
pgd
, 
addr
, 
íd
,

523 
∑ge_size_mask
)

525 
pud_t
 *
pud
;

527 
pud
 = (
pud_t
 *)
	`pgd_∑ge_vaddr
(*
pgd
);

529  
	`phys_pud_öô
(
pud
, 
addr
, 
íd
, 
∑ge_size_mask
);

530 
	}
}

532 
__memöô


533 
	$kî√l_physiˇl_m≠pög_öô
(
°¨t
,

534 
íd
,

535 
∑ge_size_mask
)

538 
√xt
, 
œ°_m≠_addr
 = 
íd
;

540 
°¨t
 = ()
	`__va
(start);

541 
íd
 = ()
	`__va
(end);

543 ; 
°¨t
 < 
íd
; sèπ = 
√xt
) {

544 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
°¨t
);

545 
pud_phys
;

546 
pud_t
 *
pud
;

548 
√xt
 = (
°¨t
 + 
PGDIR_SIZE
Ë& 
PGDIR_MASK
;

549 i‡(
√xt
 > 
íd
)

550 
√xt
 = 
íd
;

552 i‡(
	`pgd_vÆ
(*
pgd
)) {

553 
œ°_m≠_addr
 = 
	`phys_pud_upd©e
(
pgd
, 
	`__∑
(
°¨t
),

554 
	`__∑
(
íd
), 
∑ge_size_mask
);

558 
pud
 = 
	`Æloc_low_∑ge
(&
pud_phys
);

559 
œ°_m≠_addr
 = 
	`phys_pud_öô
(
pud
, 
	`__∑
(
°¨t
), __∑(
√xt
),

560 
∑ge_size_mask
);

561 
	`unm≠_low_∑ge
(
pud
);

563 
	`•ö_lock
(&
öô_mm
.
∑ge_èbÀ_lock
);

564 
	`pgd_p›uœã
(&
öô_mm
, 
pgd
, 
	`__va
(
pud_phys
));

565 
	`•ö_u∆ock
(&
öô_mm
.
∑ge_èbÀ_lock
);

567 
	`__Êush_éb_Æl
();

569  
œ°_m≠_addr
;

570 
	}
}

572 #i‚de‡
CONFIG_NUMA


573 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
íd_p‚
,

574 
a˝i
, 
k8
)

576 #i‚de‡
CONFIG_NO_BOOTMEM


577 
boŸm≠_size
, 
boŸm≠
;

579 
boŸm≠_size
 = 
	`boŸmem_boŸm≠_∑ges
(
íd_p‚
)<<
PAGE_SHIFT
;

580 
boŸm≠
 = 
	`föd_e820_¨ó
(0, 
íd_p‚
<<
PAGE_SHIFT
, 
boŸm≠_size
,

581 
PAGE_SIZE
);

582 i‡(
boŸm≠
 == -1L)

583 
	`∑nic
("C™nŸ föd boŸmem m≠ o‡sizê%ld\n", 
boŸm≠_size
);

584 
	`ª£rve_óæy
(
boŸm≠
, boŸm≠ + 
boŸm≠_size
, "BOOTMAP");

586 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(0), 
boŸm≠
 >> 
PAGE_SHIFT
,

587 0, 
íd_p‚
);

588 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

589 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(0, 
íd_p‚
);

591 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
íd_p‚
);

593 
	}
}

596 
__öô
 
	$∑gög_öô
()

598 
max_z⁄e_p‚s
[
MAX_NR_ZONES
];

600 
	`mem£t
(
max_z⁄e_p‚s
, 0, (max_zone_pfns));

601 
max_z⁄e_p‚s
[
ZONE_DMA
] = 
MAX_DMA_PFN
;

602 
max_z⁄e_p‚s
[
ZONE_DMA32
] = 
MAX_DMA32_PFN
;

603 
max_z⁄e_p‚s
[
ZONE_NORMAL
] = 
max_p‚
;

605 
	`•¨£_mem‹y_¥e£¡_wôh_a˘ive_ªgi⁄s
(
MAX_NUMNODES
);

606 
	`•¨£_öô
();

614 
	`node_˛ór_°©e
(0, 
N_NORMAL_MEMORY
);

616 
	`‰ì_¨ó_öô_nodes
(
max_z⁄e_p‚s
);

617 
	}
}

622 #ifde‡
CONFIG_MEMORY_HOTPLUG


627 
	$upd©e_íd_of_mem‹y_v¨s
(
u64
 
°¨t
, u64 
size
)

629 
íd_p‚
 = 
	`PFN_UP
(
°¨t
 + 
size
);

631 i‡(
íd_p‚
 > 
max_p‚
) {

632 
max_p‚
 = 
íd_p‚
;

633 
max_low_p‚
 = 
íd_p‚
;

634 
high_mem‹y
 = (*)
	`__va
(
max_p‚
 * 
PAGE_SIZE
 - 1) + 1;

636 
	}
}

642 
	$¨ch_add_mem‹y
(
nid
, 
u64
 
°¨t
, u64 
size
)

644 
pgli°_d©a
 *
pgd©
 = 
	`NODE_DATA
(
nid
);

645 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
ZONE_NORMAL
;

646 
œ°_m≠≥d_p‚
, 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

647 
ƒ_∑ges
 = 
size
 >> 
PAGE_SHIFT
;

648 
ªt
;

650 
œ°_m≠≥d_p‚
 = 
	`öô_mem‹y_m≠pög
(
°¨t
, sèπ + 
size
);

651 i‡(
œ°_m≠≥d_p‚
 > 
max_p‚_m≠≥d
)

652 
max_p‚_m≠≥d
 = 
œ°_m≠≥d_p‚
;

654 
ªt
 = 
	`__add_∑ges
(
nid
, 
z⁄e
, 
°¨t_p‚
, 
ƒ_∑ges
);

655 
	`WARN_ON_ONCE
(
ªt
);

658 
	`upd©e_íd_of_mem‹y_v¨s
(
°¨t
, 
size
);

660  
ªt
;

661 
	}
}

662 
EXPORT_SYMBOL_GPL
(
¨ch_add_mem‹y
);

664 #i‡!
deföed
(
CONFIG_ACPI_NUMA
Ë&& deföed(
CONFIG_NUMA
)

665 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

668 
	}
}

669 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

674 
kc‹e_li°
 
	gkc‹e_vsysˇŒ
;

676 
__öô
 
	$mem_öô
()

678 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
;

679 
ab£¡_∑ges
;

681 
	`pci_iommu_Æloc
();

685 
ª£rved∑ges
 = 0;

688 #ifde‡
CONFIG_NUMA


689 
tŸÆøm_∑ges
 = 
	`numa_‰ì_Æl_boŸmem
();

691 
tŸÆøm_∑ges
 = 
	`‰ì_Æl_boŸmem
();

694 
ab£¡_∑ges
 = 
	`ab£¡_∑ges_ö_ønge
(0, 
max_p‚
);

695 
ª£rved∑ges
 = 
max_p‚
 - 
tŸÆøm_∑ges
 - 
ab£¡_∑ges
;

696 
a·î_boŸmem
 = 1;

698 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

699 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_ëext
;

700 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

703 
	`k˛i°_add
(&
kc‹e_vsysˇŒ
, (*)
VSYSCALL_START
,

704 
VSYSCALL_END
 - 
VSYSCALL_START
, 
KCORE_OTHER
);

706 
	`¥ötk
(
KERN_INFO
 "Memory: %luk/%lukávailable (%ldk kernel code, "

708 
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

709 
max_p‚
 << (
PAGE_SHIFT
-10),

710 
codesize
 >> 10,

711 
ab£¡_∑ges
 << (
PAGE_SHIFT
-10),

712 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

713 
d©asize
 >> 10,

714 
öôsize
 >> 10);

715 
	}
}

717 #ifde‡
CONFIG_DEBUG_RODATA


718 c⁄° 
	grod©a_ã°_d©a
 = 0xC3;

719 
EXPORT_SYMBOL_GPL
(
rod©a_ã°_d©a
);

721 
	gkî√l_£t_to_ªad⁄ly
;

723 
	$£t_kî√l_ãxt_rw
()

725 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

726 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

728 i‡(!
kî√l_£t_to_ªad⁄ly
)

731 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead write\n",

732 
°¨t
, 
íd
);

739 
	`£t_mem‹y_rw
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

740 
	}
}

742 
	$£t_kî√l_ãxt_ro
()

744 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

745 
íd
 = 
	`PFN_ALIGN
(
__°›___ex_èbÀ
);

747 i‡(!
kî√l_£t_to_ªad⁄ly
)

750 
	`¥_debug
("Set kernelÅext: %lx - %lx forÑead only\n",

751 
°¨t
, 
íd
);

756 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

757 
	}
}

759 
	$m¨k_rod©a_ro
()

761 
°¨t
 = 
	`PFN_ALIGN
(
_ãxt
);

762 
rod©a_°¨t
 =

763 (()
__°¨t_rod©a
 + 
PAGE_SIZE
 - 1Ë& 
PAGE_MASK
;

764 
íd
 = (Ë&
__íd_rod©a_h∑ge_Æign
;

765 
ãxt_íd
 = 
	`PAGE_ALIGN
((Ë&
__°›___ex_èbÀ
);

766 
rod©a_íd
 = 
	`PAGE_ALIGN
((Ë&
__íd_rod©a
);

767 
d©a_°¨t
 = (Ë&
_sd©a
;

769 
	`¥ötk
(
KERN_INFO
 "WriteÖrotectingÅhe kernelÑead-only data: %luk\n",

770 (
íd
 - 
°¨t
) >> 10);

771 
	`£t_mem‹y_ro
(
°¨t
, (
íd
 - sèπË>> 
PAGE_SHIFT
);

773 
kî√l_£t_to_ªad⁄ly
 = 1;

779 
	`£t_mem‹y_nx
(
rod©a_°¨t
, (
íd
 -Ñod©a_°¨tË>> 
PAGE_SHIFT
);

781 
	`rod©a_ã°
();

783 #ifde‡
CONFIG_CPA_DEBUG


784 
	`¥ötk
(
KERN_INFO
 "Te°ög CPA: undÿ%lx-%lx\n", 
°¨t
, 
íd
);

785 
	`£t_mem‹y_rw
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

787 
	`¥ötk
(
KERN_INFO
 "Testing CPA:ágain\n");

788 
	`£t_mem‹y_ro
(
°¨t
, (
íd
-°¨tË>> 
PAGE_SHIFT
);

791 
	`‰ì_öô_∑ges
("unused kernel memory",

792 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
ãxt_íd
)),

794 
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_°¨t
)));

795 
	`‰ì_öô_∑ges
("unused kernel memory",

796 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
rod©a_íd
)),

797 (Ë
	`∑ge_addªss
(
	`vút_to_∑ge
(
d©a_°¨t
)));

798 
	}
}

802 
__öô
 
	$ª£rve_boŸmem_gíîic
(
phys
, 
Àn
,

803 
Êags
)

805 #ifde‡
CONFIG_NUMA


806 
nid
, 
√xt_nid
;

807 
ªt
;

809 
p‚
 = 
phys
 >> 
PAGE_SHIFT
;

811 i‡(
p‚
 >
max_p‚
) {

816 i‡(
p‚
 < 
max_p‚_m≠≥d
)

817  -
EFAULT
;

819 
	`¥ötk
(
KERN_ERR
 "reserve_bootmem: illegalÑeserve %lx %lu\n",

820 
phys
, 
Àn
);

821  -
EFAULT
;

825 #ifde‡
CONFIG_NUMA


826 
nid
 = 
	`phys_to_nid
(
phys
);

827 
√xt_nid
 = 
	`phys_to_nid
(
phys
 + 
Àn
 - 1);

828 i‡(
nid
 =
√xt_nid
)

829 
ªt
 = 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
phys
, 
Àn
, 
Êags
);

831 
ªt
 = 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

833 i‡(
ªt
 != 0)

834  
ªt
;

837 
	`ª£rve_boŸmem
(
phys
, 
Àn
, 
Êags
);

840 i‡(
phys
+
Àn
 <
MAX_DMA_PFN
*
PAGE_SIZE
) {

841 
dma_ª£rve
 +
Àn
 / 
PAGE_SIZE
;

842 
	`£t_dma_ª£rve
(
dma_ª£rve
);

846 
	}
}

848 
	$kîn_addr_vÆid
(
addr
)

850 
above
 = (()
addr
Ë>> 
__VIRTUAL_MASK_SHIFT
;

851 
pgd_t
 *
pgd
;

852 
pud_t
 *
pud
;

853 
pmd_t
 *
pmd
;

854 
±e_t
 *
±e
;

856 i‡(
above
 != 0 &&ábove != -1UL)

859 
pgd
 = 
	`pgd_off£t_k
(
addr
);

860 i‡(
	`pgd_n⁄e
(*
pgd
))

863 
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

864 i‡(
	`pud_n⁄e
(*
pud
))

867 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

868 i‡(
	`pmd_n⁄e
(*
pmd
))

871 i‡(
	`pmd_œrge
(*
pmd
))

872  
	`p‚_vÆid
(
	`pmd_p‚
(*
pmd
));

874 
±e
 = 
	`±e_off£t_kî√l
(
pmd
, 
addr
);

875 i‡(
	`±e_n⁄e
(*
±e
))

878  
	`p‚_vÆid
(
	`±e_p‚
(*
±e
));

879 
	}
}

886 
vm_¨ó_°ru˘
 
	gg©e_vma
 = {

887 .
vm_°¨t
 = 
VSYSCALL_START
,

888 .
	gvm_íd
 = 
VSYSCALL_START
 + (
VSYSCALL_MAPPED_PAGES
 * 
PAGE_SIZE
),

889 .
	gvm_∑ge_¥Ÿ
 = 
PAGE_READONLY_EXEC
,

890 .
	gvm_Êags
 = 
VM_READ
 | 
VM_EXEC


893 
vm_¨ó_°ru˘
 *
	$gë_g©e_vma
(
èsk_°ru˘
 *
tsk
)

895 #ifde‡
CONFIG_IA32_EMULATION


896 i‡(
	`ã°_tsk_thªad_Êag
(
tsk
, 
TIF_IA32
))

897  
NULL
;

899  &
g©e_vma
;

900 
	}
}

902 
	$ö_g©e_¨ó
(
èsk_°ru˘
 *
èsk
, 
addr
)

904 
vm_¨ó_°ru˘
 *
vma
 = 
	`gë_g©e_vma
(
èsk
);

906 i‡(!
vma
)

909  (
addr
 >
vma
->
vm_°¨t
Ë&& (add∏< vma->
vm_íd
);

910 
	}
}

917 
	$ö_g©e_¨ó_no_èsk
(
addr
)

919  (
addr
 >
VSYSCALL_START
Ë&& (add∏< 
VSYSCALL_END
);

920 
	}
}

922 c⁄° *
	$¨ch_vma_«me
(
vm_¨ó_°ru˘
 *
vma
)

924 i‡(
vma
->
vm_mm
 && vma->
vm_°¨t
 =()vma->vm_mm->
c⁄ãxt
.
vdso
)

926 i‡(
vma
 =&
g©e_vma
)

928  
NULL
;

929 
	}
}

931 #ifde‡
CONFIG_SPARSEMEM_VMEMMAP


935 
__memöôd©a
 
	gaddr_°¨t
, 
	gaddr_íd
;

936 
__memöôd©a
 *
	gp_°¨t
, *
	gp_íd
;

937 
__memöôd©a
 
	gnode_°¨t
;

939 
__memöô


940 
	$vmemm≠_p›uœã
(
∑ge
 *
°¨t_∑ge
, 
size
, 
node
)

942 
addr
 = ()
°¨t_∑ge
;

943 
íd
 = ()(
°¨t_∑ge
 + 
size
);

944 
√xt
;

945 
pgd_t
 *
pgd
;

946 
pud_t
 *
pud
;

947 
pmd_t
 *
pmd
;

949 ; 
addr
 < 
íd
;ádd∏
√xt
) {

950 *
p
 = 
NULL
;

952 
pgd
 = 
	`vmemm≠_pgd_p›uœã
(
addr
, 
node
);

953 i‡(!
pgd
)

954  -
ENOMEM
;

956 
pud
 = 
	`vmemm≠_pud_p›uœã
(
pgd
, 
addr
, 
node
);

957 i‡(!
pud
)

958  -
ENOMEM
;

960 i‡(!
˝u_has_p£
) {

961 
√xt
 = (
addr
 + 
PAGE_SIZE
Ë& 
PAGE_MASK
;

962 
pmd
 = 
	`vmemm≠_pmd_p›uœã
(
pud
, 
addr
, 
node
);

964 i‡(!
pmd
)

965  -
ENOMEM
;

967 
p
 = 
	`vmemm≠_±e_p›uœã
(
pmd
, 
addr
, 
node
);

969 i‡(!
p
)

970  -
ENOMEM
;

972 
addr_íd
 = 
addr
 + 
PAGE_SIZE
;

973 
p_íd
 = 
p
 + 
PAGE_SIZE
;

975 
√xt
 = 
	`pmd_addr_íd
(
addr
, 
íd
);

977 
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

978 i‡(
	`pmd_n⁄e
(*
pmd
)) {

979 
±e_t
 
íåy
;

981 
p
 = 
	`vmemm≠_Æloc_block_buf
(
PMD_SIZE
, 
node
);

982 i‡(!
p
)

983  -
ENOMEM
;

985 
íåy
 = 
	`p‚_±e
(
	`__∑
(
p
Ë>> 
PAGE_SHIFT
,

986 
PAGE_KERNEL_LARGE
);

987 
	`£t_pmd
(
pmd
, 
	`__pmd
(
	`±e_vÆ
(
íåy
)));

990 i‡(
p_íd
 !
p
 || 
node_°¨t
 !
node
) {

991 i‡(
p_°¨t
)

992 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

993 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

994 
addr_°¨t
 = 
addr
;

995 
node_°¨t
 = 
node
;

996 
p_°¨t
 = 
p
;

999 
addr_íd
 = 
addr
 + 
PMD_SIZE
;

1000 
p_íd
 = 
p
 + 
PMD_SIZE
;

1002 
	`vmemm≠_vîify
((
±e_t
 *)
pmd
, 
node
, 
addr
, 
√xt
);

1007 
	}
}

1009 
__memöô
 
	$vmemm≠_p›uœã_¥öt_œ°
()

1011 i‡(
p_°¨t
) {

1012 
	`¥ötk
(
KERN_DEBUG
 " [%lx-%lx] PMD -> [%p-%p] onÇode %d\n",

1013 
addr_°¨t
, 
addr_íd
-1, 
p_°¨t
, 
p_íd
-1, 
node_°¨t
);

1014 
p_°¨t
 = 
NULL
;

1015 
p_íd
 = 
NULL
;

1016 
node_°¨t
 = 0;

1018 
	}
}

	@/cmpt816/linux/arch/x86/mm/ioremap.c

9 
	~<löux/boŸmem.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/io.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/mmiŸø˚.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/e820.h
>

19 
	~<asm/fixm≠.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/ébÊush.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/∑t.h
>

25 
	~"phyßddr.h
"

31 
	$i‹em≠_ch™ge_©å
(
vaddr
, 
size
,

32 
¥Ÿ_vÆ
)

34 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

35 
îr
;

37 
¥Ÿ_vÆ
) {

38 
_PAGE_CACHE_UC
:

40 
îr
 = 
	`_£t_mem‹y_uc
(
vaddr
, 
ƒ∑ges
);

42 
_PAGE_CACHE_WC
:

43 
îr
 = 
	`_£t_mem‹y_wc
(
vaddr
, 
ƒ∑ges
);

45 
_PAGE_CACHE_WB
:

46 
îr
 = 
	`_£t_mem‹y_wb
(
vaddr
, 
ƒ∑ges
);

50  
îr
;

51 
	}
}

62 
__iomem
 *
	$__i‹em≠_ˇŒî
(
ªsour˚_size_t
 
phys_addr
,

63 
size
, 
¥Ÿ_vÆ
, *
ˇŒî
)

65 
p‚
, 
off£t
, 
vaddr
;

66 
ªsour˚_size_t
 
œ°_addr
;

67 c⁄° 
ªsour˚_size_t
 
u«lig√d_phys_addr
 = 
phys_addr
;

68 c⁄° 
u«lig√d_size
 = 
size
;

69 
vm_°ru˘
 *
¨ó
;

70 
√w_¥Ÿ_vÆ
;

71 
pg¥Ÿ_t
 
¥Ÿ
;

72 
ªtvÆ
;

73 
__iomem
 *
ªt_addr
;

76 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

77 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
)

78  
NULL
;

80 i‡(!
	`phys_addr_vÆid
(
phys_addr
)) {

81 
	`¥ötk
(
KERN_WARNING
 "ioremap: invalidÖhysicaláddress %llx\n",

82 ()
phys_addr
);

83 
	`WARN_ON_ONCE
(1);

84  
NULL
;

90 i‡(
	`is_ISA_ønge
(
phys_addr
, 
œ°_addr
))

91  (
__f‹˚
 
__iomem
 *)
	`phys_to_vút
(
phys_addr
);

97 
	`WARN_ONCE
(
	`iomem_m≠_ßnôy_check
(
phys_addr
, 
size
),

98 
KERN_INFO
 "Info: mapping multiple BARs. Your kernel is fine.");

103 
p‚
 = 
phys_addr
 >> 
PAGE_SHIFT
;

104 (
p‚
 << 
PAGE_SHIFT
Ë< (
œ°_addr
 & 
PAGE_MASK
);

105 
p‚
++) {

107 
is_øm
 = 
	`∑ge_is_øm
(
p‚
);

109 i‡(
is_øm
 && 
	`p‚_vÆid
(
p‚
Ë&& !
	`PageRe£rved
(
	`p‚_to_∑ge
(pfn)))

110  
NULL
;

111 
	`WARN_ON_ONCE
(
is_øm
);

117 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

118 
phys_addr
 &
PAGE_MASK
;

119 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
+1Ë- 
phys_addr
;

121 
ªtvÆ
 = 
	`ª£rve_memty≥
(
phys_addr
, (
u64
Ìhys_add∏+ 
size
,

122 
¥Ÿ_vÆ
, &
√w_¥Ÿ_vÆ
);

123 i‡(
ªtvÆ
) {

124 
	`¥ötk
(
KERN_ERR
 "i‹em≠Ñe£rve_memty≥ faûed %d\n", 
ªtvÆ
);

125  
NULL
;

128 i‡(
¥Ÿ_vÆ
 !
√w_¥Ÿ_vÆ
) {

129 i‡(!
	`is_√w_memty≥_Ælowed
(
phys_addr
, 
size
,

130 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
)) {

131 
	`¥ötk
(
KERN_ERR


133 ()
phys_addr
,

134 ()(
phys_addr
 + 
size
),

135 
¥Ÿ_vÆ
, 
√w_¥Ÿ_vÆ
);

136 
îr_‰ì_memty≥
;

138 
¥Ÿ_vÆ
 = 
√w_¥Ÿ_vÆ
;

141 
¥Ÿ_vÆ
) {

142 
_PAGE_CACHE_UC
:

144 
¥Ÿ
 = 
PAGE_KERNEL_IO_NOCACHE
;

146 
_PAGE_CACHE_UC_MINUS
:

147 
¥Ÿ
 = 
PAGE_KERNEL_IO_UC_MINUS
;

149 
_PAGE_CACHE_WC
:

150 
¥Ÿ
 = 
PAGE_KERNEL_IO_WC
;

152 
_PAGE_CACHE_WB
:

153 
¥Ÿ
 = 
PAGE_KERNEL_IO
;

160 
¨ó
 = 
	`gë_vm_¨ó_ˇŒî
(
size
, 
VM_IOREMAP
, 
ˇŒî
);

161 i‡(!
¨ó
)

162 
îr_‰ì_memty≥
;

163 
¨ó
->
phys_addr
 =Öhys_addr;

164 
vaddr
 = (Ë
¨ó
->
addr
;

166 i‡(
	`kî√l_m≠_sync_memty≥
(
phys_addr
, 
size
, 
¥Ÿ_vÆ
))

167 
îr_‰ì_¨ó
;

169 i‡(
	`i‹em≠_∑ge_ønge
(
vaddr
, vadd∏+ 
size
, 
phys_addr
, 
¥Ÿ
))

170 
îr_‰ì_¨ó
;

172 
ªt_addr
 = (
__iomem
 *Ë(
vaddr
 + 
off£t
);

173 
	`mmiŸø˚_i‹em≠
(
u«lig√d_phys_addr
, 
u«lig√d_size
, 
ªt_addr
);

175  
ªt_addr
;

176 
îr_‰ì_¨ó
:

177 
	`‰ì_vm_¨ó
(
¨ó
);

178 
îr_‰ì_memty≥
:

179 
	`‰ì_memty≥
(
phys_addr
,Öhys_add∏+ 
size
);

180  
NULL
;

181 
	}
}

204 
__iomem
 *
	$i‹em≠_noˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

213 
vÆ
 = 
_PAGE_CACHE_UC_MINUS
;

215  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
vÆ
,

216 
	`__buûtö_ªtu∫_addªss
(0));

217 
	}
}

218 
EXPORT_SYMBOL
(
i‹em≠_noˇche
);

230 
__iomem
 *
	$i‹em≠_wc
(
ªsour˚_size_t
 
phys_addr
, 
size
)

232 i‡(
∑t_íabÀd
)

233  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WC
,

234 
	`__buûtö_ªtu∫_addªss
(0));

236  
	`i‹em≠_noˇche
(
phys_addr
, 
size
);

237 
	}
}

238 
EXPORT_SYMBOL
(
i‹em≠_wc
);

240 
__iomem
 *
	$i‹em≠_ˇche
(
ªsour˚_size_t
 
phys_addr
, 
size
)

242  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, 
_PAGE_CACHE_WB
,

243 
	`__buûtö_ªtu∫_addªss
(0));

244 
	}
}

245 
EXPORT_SYMBOL
(
i‹em≠_ˇche
);

247 
__iomem
 *
	$i‹em≠_¥Ÿ
(
ªsour˚_size_t
 
phys_addr
, 
size
,

248 
¥Ÿ_vÆ
)

250  
	`__i‹em≠_ˇŒî
(
phys_addr
, 
size
, (
¥Ÿ_vÆ
 & 
_PAGE_CACHE_MASK
),

251 
	`__buûtö_ªtu∫_addªss
(0));

252 
	}
}

253 
EXPORT_SYMBOL
(
i‹em≠_¥Ÿ
);

261 
	$iounm≠
(vﬁ©ûê
__iomem
 *
addr
)

263 
vm_°ru˘
 *
p
, *
o
;

265 i‡((
__f‹˚
 *)
addr
 <
high_mem‹y
)

273 i‡((
__f‹˚
 *)
addr
 >
	`phys_to_vút
(
ISA_START_ADDRESS
) &&

274 (
__f‹˚
 *)
addr
 < 
	`phys_to_vút
(
ISA_END_ADDRESS
))

277 
addr
 = (vﬁ©ûê
__iomem
 *)

278 (
PAGE_MASK
 & (
__f‹˚
)
addr
);

280 
	`mmiŸø˚_iounm≠
(
addr
);

287 
	`ªad_lock
(&
vmli°_lock
);

288 
p
 = 
vmli°
;Ö;Ö =Ö->
√xt
) {

289 i‡(
p
->
addr
 =(
__f‹˚
 *)addr)

292 
	`ªad_u∆ock
(&
vmli°_lock
);

294 i‡(!
p
) {

295 
	`¥ötk
(
KERN_ERR
 "iounm≠: badáddªs†%p\n", 
addr
);

296 
	`dump_°ack
();

300 
	`‰ì_memty≥
(
p
->
phys_addr
,Ö->phys_add∏+ 
	`gë_vm_¨ó_size
(p));

303 
o
 = 
	`ªmove_vm_¨ó
((
__f‹˚
 *)
addr
);

304 
	`BUG_ON
(
p
 !
o
 || o =
NULL
);

305 
	`k‰ì
(
p
);

306 
	}
}

307 
EXPORT_SYMBOL
(
iounm≠
);

313 *
	$xœã_dev_mem_±r
(
phys
)

315 *
addr
;

316 
°¨t
 = 
phys
 & 
PAGE_MASK
;

319 i‡(
	`∑ge_is_øm
(
°¨t
 >> 
PAGE_SHIFT
))

320  
	`__va
(
phys
);

322 
addr
 = (
__f‹˚
 *)
	`i‹em≠_ˇche
(
°¨t
, 
PAGE_SIZE
);

323 i‡(
addr
)

324 
addr
 = (*)((Ôdd∏| (
phys
 & ~
PAGE_MASK
));

326  
addr
;

327 
	}
}

329 
	$unxœã_dev_mem_±r
(
phys
, *
addr
)

331 i‡(
	`∑ge_is_øm
(
phys
 >> 
PAGE_SHIFT
))

334 
	`iounm≠
((
__iomem
 *)(()
addr
 & 
PAGE_MASK
));

336 
	}
}

338 
__öôd©a
 
	góæy_i‹em≠_debug
;

340 
__öô
 
	$óæy_i‹em≠_debug_£tup
(*
°r
)

342 
óæy_i‹em≠_debug
 = 1;

345 
	}
}

346 
óæy_∑øm
("óæy_i‹em≠_debug", 
óæy_i‹em≠_debug_£tup
);

348 
__öôd©a
 
	ga·î_∑gög_öô
;

349 
±e_t
 
	gbm_±e
[
PAGE_SIZE
/’ã_t)] 
	g__∑ge_Æig√d_bss
;

351 
ölöe
 
pmd_t
 * 
__öô
 
	$óæy_i‹em≠_pmd
(
addr
)

354 
pgd_t
 *
ba£
 = 
	`__va
(
	`ªad_¸3
());

355 
pgd_t
 *
pgd
 = &
ba£
[
	`pgd_ödex
(
addr
)];

356 
pud_t
 *
pud
 = 
	`pud_off£t
(
pgd
, 
addr
);

357 
pmd_t
 *
pmd
 = 
	`pmd_off£t
(
pud
, 
addr
);

359  
pmd
;

360 
	}
}

362 
ölöe
 
±e_t
 * 
__öô
 
	$óæy_i‹em≠_±e
(
addr
)

364  &
bm_±e
[
	`±e_ödex
(
addr
)];

365 
	}
}

367 
	g¶Ÿ_vút
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

369 
__öô
 
	$óæy_i‹em≠_öô
()

371 
pmd_t
 *
pmd
;

372 
i
;

374 i‡(
óæy_i‹em≠_debug
)

375 
	`¥ötk
(
KERN_INFO
 "early_ioremap_init()\n");

377 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

378 
¶Ÿ_vút
[
i
] = 
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*i);

380 
pmd
 = 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

381 
	`mem£t
(
bm_±e
, 0, (bm_pte));

382 
	`pmd_p›uœã_kî√l
(&
öô_mm
, 
pmd
, 
bm_±e
);

388 
	#__FIXADDR_TOP
 (-
PAGE_SIZE
)

	)

389 
	`BUILD_BUG_ON
((
	`__fix_to_vút
(
FIX_BTMAP_BEGIN
Ë>> 
PMD_SHIFT
)

390 !(
	`__fix_to_vút
(
FIX_BTMAP_END
Ë>> 
PMD_SHIFT
));

391 #unde‡
__FIXADDR_TOP


392 i‡(
pmd
 !
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
))) {

393 
	`WARN_ON
(1);

394 
	`¥ötk
(
KERN_WARNING
 "pmd %p != %p\n",

395 
pmd
, 
	`óæy_i‹em≠_pmd
(
	`fix_to_vút
(
FIX_BTMAP_END
)));

396 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_BEGIN): %08lx\n",

397 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
));

398 
	`¥ötk
(
KERN_WARNING
 "fix_to_virt(FIX_BTMAP_END): %08lx\n",

399 
	`fix_to_vút
(
FIX_BTMAP_END
));

401 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_END: %d\n", 
FIX_BTMAP_END
);

402 
	`¥ötk
(
KERN_WARNING
 "FIX_BTMAP_BEGIN: %d\n",

403 
FIX_BTMAP_BEGIN
);

405 
	}
}

407 
__öô
 
	$óæy_i‹em≠_ª£t
()

409 
a·î_∑gög_öô
 = 1;

410 
	}
}

412 
__öô
 
	$__óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

413 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
Êags
)

415 
addr
 = 
	`__fix_to_vút
(
idx
);

416 
±e_t
 *
±e
;

418 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

419 
	`BUG
();

422 
±e
 = 
	`óæy_i‹em≠_±e
(
addr
);

424 i‡(
	`pg¥Ÿ_vÆ
(
Êags
))

425 
	`£t_±e
(
±e
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

427 
	`±e_˛ór
(&
öô_mm
, 
addr
, 
±e
);

428 
	`__Êush_éb_⁄e
(
addr
);

429 
	}
}

431 
ölöe
 
__öô
 
	$óæy_£t_fixm≠
(
fixed_addªs£s
 
idx
,

432 
phys_addr_t
 
phys
, 
pg¥Ÿ_t
 
¥Ÿ
)

434 i‡(
a·î_∑gög_öô
)

435 
	`__£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

437 
	`__óæy_£t_fixm≠
(
idx
, 
phys
, 
¥Ÿ
);

438 
	}
}

440 
ölöe
 
__öô
 
	$óæy_˛ór_fixm≠
(
fixed_addªs£s
 
idx
)

442 i‡(
a·î_∑gög_öô
)

443 
	`˛ór_fixm≠
(
idx
);

445 
	`__óæy_£t_fixm≠
(
idx
, 0, 
	`__pg¥Ÿ
(0));

446 
	}
}

448 
__iomem
 *
	g¥ev_m≠
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

449 
	g¥ev_size
[
FIX_BTMAPS_SLOTS
] 
	g__öôd©a
;

451 
__öô
 
	$fixup_óæy_i‹em≠
()

453 
i
;

455 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

456 i‡(
¥ev_m≠
[
i
]) {

457 
	`WARN_ON
(1);

462 
	`óæy_i‹em≠_öô
();

463 
	}
}

465 
__öô
 
	$check_óæy_i‹em≠_Àak
()

467 
cou¡
 = 0;

468 
i
;

470 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++)

471 i‡(
¥ev_m≠
[
i
])

472 
cou¡
++;

474 i‡(!
cou¡
)

476 
	`WARN
(1, 
KERN_WARNING


478 
cou¡
);

479 
	`¥ötk
(
KERN_WARNING


483 
	}
}

484 
œã_öôˇŒ
(
check_óæy_i‹em≠_Àak
);

486 
__öô
 
__iomem
 *

487 
	$__óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
, 
pg¥Ÿ_t
 
¥Ÿ
)

489 
off£t
;

490 
ªsour˚_size_t
 
œ°_addr
;

491 
ƒ∑ges
;

492 
fixed_addªs£s
 
idx0
, 
idx
;

493 
i
, 
¶Ÿ
;

495 
	`WARN_ON
(
sy°em_°©e
 !
SYSTEM_BOOTING
);

497 
¶Ÿ
 = -1;

498 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

499 i‡(!
¥ev_m≠
[
i
]) {

500 
¶Ÿ
 = 
i
;

505 i‡(
¶Ÿ
 < 0) {

506 
	`¥ötk
(
KERN_INFO
 "early_iomap(%08llx, %08lx)Çot found slot\n",

507 (
u64
)
phys_addr
, 
size
);

508 
	`WARN_ON
(1);

509  
NULL
;

512 i‡(
óæy_i‹em≠_debug
) {

513 
	`¥ötk
(
KERN_INFO
 "early_ioremap(%08llx, %08lx) [%d] => ",

514 (
u64
)
phys_addr
, 
size
, 
¶Ÿ
);

515 
	`dump_°ack
();

519 
œ°_addr
 = 
phys_addr
 + 
size
 - 1;

520 i‡(!
size
 || 
œ°_addr
 < 
phys_addr
) {

521 
	`WARN_ON
(1);

522  
NULL
;

525 
¥ev_size
[
¶Ÿ
] = 
size
;

529 
off£t
 = 
phys_addr
 & ~
PAGE_MASK
;

530 
phys_addr
 &
PAGE_MASK
;

531 
size
 = 
	`PAGE_ALIGN
(
œ°_addr
 + 1Ë- 
phys_addr
;

536 
ƒ∑ges
 = 
size
 >> 
PAGE_SHIFT
;

537 i‡(
ƒ∑ges
 > 
NR_FIX_BTMAPS
) {

538 
	`WARN_ON
(1);

539  
NULL
;

545 
idx0
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

546 
idx
 = 
idx0
;

547 
ƒ∑ges
 > 0) {

548 
	`óæy_£t_fixm≠
(
idx
, 
phys_addr
, 
¥Ÿ
);

549 
phys_addr
 +
PAGE_SIZE
;

550 --
idx
;

551 --
ƒ∑ges
;

553 i‡(
óæy_i‹em≠_debug
)

554 
	`¥ötk
(
KERN_CONT
 "%08lx + %08lx\n", 
off£t
, 
¶Ÿ_vút
[
¶Ÿ
]);

556 
¥ev_m≠
[
¶Ÿ
] = (
__iomem
 *)(
off£t
 + 
¶Ÿ_vút
[slot]);

557  
¥ev_m≠
[
¶Ÿ
];

558 
	}
}

561 
__öô
 
__iomem
 *

562 
	$óæy_i‹em≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

564  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL_IO
);

565 
	}
}

568 
__öô
 
__iomem
 *

569 
	$óæy_memªm≠
(
ªsour˚_size_t
 
phys_addr
, 
size
)

571  
	`__óæy_i‹em≠
(
phys_addr
, 
size
, 
PAGE_KERNEL
);

572 
	}
}

574 
__öô
 
	$óæy_iounm≠
(
__iomem
 *
addr
, 
size
)

576 
vút_addr
;

577 
off£t
;

578 
ƒ∑ges
;

579 
fixed_addªs£s
 
idx
;

580 
i
, 
¶Ÿ
;

582 
¶Ÿ
 = -1;

583 
i
 = 0; i < 
FIX_BTMAPS_SLOTS
; i++) {

584 i‡(
¥ev_m≠
[
i
] =
addr
) {

585 
¶Ÿ
 = 
i
;

590 i‡(
¶Ÿ
 < 0) {

591 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx)Çot found slot\n",

592 
addr
, 
size
);

593 
	`WARN_ON
(1);

597 i‡(
¥ev_size
[
¶Ÿ
] !
size
) {

598 
	`¥ötk
(
KERN_INFO
 "early_iounmap(%p, %08lx) [%d] sizeÇot consistent %08lx\n",

599 
addr
, 
size
, 
¶Ÿ
, 
¥ev_size
[slot]);

600 
	`WARN_ON
(1);

604 i‡(
óæy_i‹em≠_debug
) {

605 
	`¥ötk
(
KERN_INFO
 "óæy_iounm≠(%p, %08lxË[%d]\n", 
addr
,

606 
size
, 
¶Ÿ
);

607 
	`dump_°ack
();

610 
vút_addr
 = ()
addr
;

611 i‡(
vút_addr
 < 
	`fix_to_vút
(
FIX_BTMAP_BEGIN
)) {

612 
	`WARN_ON
(1);

615 
off£t
 = 
vút_addr
 & ~
PAGE_MASK
;

616 
ƒ∑ges
 = 
	`PAGE_ALIGN
(
off£t
 + 
size
 - 1Ë>> 
PAGE_SHIFT
;

618 
idx
 = 
FIX_BTMAP_BEGIN
 - 
NR_FIX_BTMAPS
*
¶Ÿ
;

619 
ƒ∑ges
 > 0) {

620 
	`óæy_˛ór_fixm≠
(
idx
);

621 --
idx
;

622 --
ƒ∑ges
;

624 
¥ev_m≠
[
¶Ÿ
] = 
NULL
;

625 
	}
}

	@/cmpt816/linux/arch/x86/mm/k8topology_64.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<asm/io.h
>

15 
	~<löux/pci_ids.h
>

16 
	~<löux/a˝i.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/mmz⁄e.h
>

19 
	~<asm/¥Ÿo.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/pci-dúe˘.h
>

22 
	~<asm/numa.h
>

23 
	~<asm/mp•ec.h
>

24 
	~<asm/≠ic.h
>

25 
	~<asm/k8.h
>

27 
boŸnode
 
__öôd©a
 
	gnodes
[8];

28 
nodemask_t
 
__öôd©a
 
	gnodes_∑r£d
 = 
NODE_MASK_NONE
;

30 
__öô
 
	$föd_n‹thbridge
()

32 
num
;

34 
num
 = 0;Çum < 32;Çum++) {

35 
u32
 
hódî
;

37 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 0, 0x00);

38 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1100<<16)) &&

39 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1200<<16)) &&

40 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1300<<16)))

43 
hódî
 = 
	`ªad_pci_c⁄fig
(0, 
num
, 1, 0x00);

44 i‡(
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1101<<16)) &&

45 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1201<<16)) &&

46 
hódî
 !(
PCI_VENDOR_ID_AMD
 | (0x1301<<16)))

48  
num
;

52 
	}
}

54 
__öô
 
	$óæy_gë_boŸ_˝u_id
()

60 #ifde‡
CONFIG_X86_MPPARSE


64 i‡(
smp_found_c⁄fig
)

65 
	`óæy_gë_smp_c⁄fig
();

67 
	`óæy_öô_œpic_m≠pög
();

68 
	}
}

70 
__öô
 
	$k8_gë_nodes
(
boŸnode
 *
phy¢odes
)

72 
i
;

73 
ªt
 = 0;

75 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

76 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

77 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

78 
ªt
++;

80  
ªt
;

81 
	}
}

83 
__öô
 
	$k8_numa_öô
(
°¨t_p‚
, 
íd_p‚
)

85 
°¨t
 = 
	`PFN_PHYS
(
°¨t_p‚
);

86 
íd
 = 
	`PFN_PHYS
(
íd_p‚
);

87 
numnodes
;

88 
¥evba£
;

89 
i
, 
nb
, 
found
 = 0;

90 
u32
 
nodeid
, 
ªg
;

92 i‡(!
	`óæy_pci_Ælowed
())

95 
nb
 = 
	`föd_n‹thbridge
();

96 i‡(
nb
 < 0)

97  
nb
;

99 
	`¥_öfo
("Sˇ¬ög NUMAÅ›ﬁogy i¿N‹thbridgê%d\n", 
nb
);

101 
ªg
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 0, 0x60);

102 
numnodes
 = ((
ªg
 >> 4) & 0xF) + 1;

103 i‡(
numnodes
 <= 1)

106 
	`¥_öfo
("Numbî o‡physiˇ»node†%d\n", 
numnodes
);

108 
¥evba£
 = 0;

109 
i
 = 0; i < 8; i++) {

110 
ba£
, 
limô
;

112 
ba£
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x40 + 
i
*8);

113 
limô
 = 
	`ªad_pci_c⁄fig
(0, 
nb
, 1, 0x44 + 
i
*8);

115 
nodeid
 = 
limô
 & 7;

116 i‡((
ba£
 & 3) == 0) {

117 i‡(
i
 < 
numnodes
)

118 
	`¥_öfo
("Skùpög dißbÀdÇodê%d\n", 
i
);

121 i‡(
nodeid
 >
numnodes
) {

122 
	`¥_öfo
("Ign‹ögÉx˚s†nodê%d (%lx:%lx)\n", 
nodeid
,

123 
ba£
, 
limô
);

127 i‡(!
limô
) {

128 
	`¥_öfo
("SkippingÇodeÉntry %d (base %lx)\n",

129 
i
, 
ba£
);

132 i‡((
ba£
 >> 8Ë& 3 || (
limô
 >> 8) & 3) {

133 
	`¥_îr
("Node %d using interleaving mode %lx/%lx\n",

134 
nodeid
, (
ba£
 >> 8Ë& 3, (
limô
 >> 8) & 3);

137 i‡(
	`node_is£t
(
nodeid
, 
nodes_∑r£d
)) {

138 
	`¥_öfo
("Node %dálreadyÖresent, skipping\n",

139 
nodeid
);

143 
limô
 >>= 16;

144 
limô
 <<= 24;

145 
limô
 |= (1<<24)-1;

146 
limô
++;

148 i‡(
limô
 > 
íd
)

149 
limô
 = 
íd
;

150 i‡(
limô
 <
ba£
)

153 
ba£
 >>= 16;

154 
ba£
 <<= 24;

156 i‡(
ba£
 < 
°¨t
)

157 
ba£
 = 
°¨t
;

158 i‡(
limô
 > 
íd
)

159 
limô
 = 
íd
;

160 i‡(
limô
 =
ba£
) {

161 
	`¥_îr
("Em±yÇodê%d\n", 
nodeid
);

164 i‡(
limô
 < 
ba£
) {

165 
	`¥_îr
("Node %d bogus settings %lx-%lx.\n",

166 
nodeid
, 
ba£
, 
limô
);

171 i‡(
¥evba£
 > 
ba£
) {

172 
	`¥_îr
("Node mapÇot sorted %lx,%lx\n",

173 
¥evba£
, 
ba£
);

177 
	`¥_öfo
("Node %d MemBase %016lx Limit %016lx\n",

178 
nodeid
, 
ba£
, 
limô
);

180 
found
++;

182 
nodes
[
nodeid
].
°¨t
 = 
ba£
;

183 
nodes
[
nodeid
].
íd
 = 
limô
;

185 
¥evba£
 = 
ba£
;

187 
	`node_£t
(
nodeid
, 
nodes_∑r£d
);

190 i‡(!
found
)

193 
	}
}

195 
__öô
 
	$k8_sˇn_nodes
()

197 
bôs
;

198 
c‹es
;

199 
≠icid_ba£
;

200 
i
;

202 
	`BUG_ON
(
	`nodes_em±y
(
nodes_∑r£d
));

203 
node_possibÀ_m≠
 = 
nodes_∑r£d
;

204 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 8, 
NULL
);

205 i‡(
memnode_shi·
 < 0) {

206 
	`¥_îr
("No NUMAÇode hash function found. Contact maintainer\n");

209 
	`¥_öfo
("UsögÇodêhash shi· o‡%d\n", 
memnode_shi·
);

212 
bôs
 = 
boŸ_˝u_d©a
.
x86_c‹eid_bôs
;

213 
c‹es
 = (1<<
bôs
);

214 
≠icid_ba£
 = 0;

216 
	`óæy_gë_boŸ_˝u_id
();

217 i‡(
boŸ_˝u_physiˇl_≠icid
 > 0) {

218 
	`¥_öfo
("BSP APIC ID: %02x\n", 
boŸ_˝u_physiˇl_≠icid
);

219 
≠icid_ba£
 = 
boŸ_˝u_physiˇl_≠icid
;

222 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

223 
j
;

225 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
,

226 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
,

227 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

228 
j
 = 
≠icid_ba£
; j < 
c‹es
 +ápicid_base; j++)

229 
≠icid_to_node
[(
i
 << 
bôs
Ë+ 
j
] = i;

230 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

233 
	`numa_öô_¨øy
();

235 
	}
}

	@/cmpt816/linux/arch/x86/mm/mmap.c

27 
	~<löux/≥rs⁄Æôy.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/limôs.h
>

31 
	~<löux/sched.h
>

32 
	~<asm/ñf.h
>

34 
	$°ack_maxøndom_size
()

36 
max
 = 0;

37 i‡((
cuºít
->
Êags
 & 
PF_RANDOMIZE
) &&

38 !(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_NO_RANDOMIZE
)) {

39 
max
 = ((-1UË& 
STACK_RND_MASK
Ë<< 
PAGE_SHIFT
;

42  
max
;

43 
	}
}

51 
	#MIN_GAP
 (128*1024*1024UL + 
	`°ack_maxøndom_size
())

	)

52 
	#MAX_GAP
 (
TASK_SIZE
/6*5)

	)

57 
	$mm≠_is_ü32
()

59 #ifde‡
CONFIG_X86_32


62 #ifde‡
CONFIG_IA32_EMULATION


63 i‡(
	`ã°_thªad_Êag
(
TIF_IA32
))

67 
	}
}

69 
	$mm≠_is_Àgacy
()

71 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_COMPAT_LAYOUT
)

74 i‡(
	`æimô
(
RLIMIT_STACK
Ë=
RLIM_INFINITY
)

77  
sys˘l_Àgacy_va_œyout
;

78 
	}
}

80 
	$mm≠_∫d
()

82 
∫d
 = 0;

88 i‡(
cuºít
->
Êags
 & 
PF_RANDOMIZE
) {

89 i‡(
	`mm≠_is_ü32
())

90 
∫d
 = ()
	`gë_øndom_öt
() % (1<<8);

92 
∫d
 = ()(
	`gë_øndom_öt
() % (1<<28));

94  
∫d
 << 
PAGE_SHIFT
;

95 
	}
}

97 
	$mm≠_ba£
()

99 
g≠
 = 
	`æimô
(
RLIMIT_STACK
);

101 i‡(
g≠
 < 
MIN_GAP
)

102 
g≠
 = 
MIN_GAP
;

103 i‡(
g≠
 > 
MAX_GAP
)

104 
g≠
 = 
MAX_GAP
;

106  
	`PAGE_ALIGN
(
TASK_SIZE
 - 
g≠
 - 
	`mm≠_∫d
());

107 
	}
}

113 
	$mm≠_Àgacy_ba£
()

115 i‡(
	`mm≠_is_ü32
())

116  
TASK_UNMAPPED_BASE
;

118  
TASK_UNMAPPED_BASE
 + 
	`mm≠_∫d
();

119 
	}
}

125 
	$¨ch_pick_mm≠_œyout
(
mm_°ru˘
 *
mm
)

127 i‡(
	`mm≠_is_Àgacy
()) {

128 
mm
->
mm≠_ba£
 = 
	`mm≠_Àgacy_ba£
();

129 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó
;

130 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó
;

132 
mm
->
mm≠_ba£
 = 
	`mm≠_ba£
();

133 
mm
->
gë_unm≠≥d_¨ó
 = 
¨ch_gë_unm≠≥d_¨ó_t›down
;

134 
mm
->
unm≠_¨ó
 = 
¨ch_unm≠_¨ó_t›down
;

136 
	}
}

	@/cmpt816/linux/arch/x86/mm/numa.c

2 
	~<löux/t›ﬁogy.h
>

3 
	~<löux/moduÀ.h
>

4 
	~<löux/boŸmem.h
>

9 
˝umask_v¨_t
 
	gnode_to_˝umask_m≠
[
MAX_NUMNODES
];

10 
EXPORT_SYMBOL
(
node_to_˝umask_m≠
);

19 
__öô
 
	$£tup_node_to_˝umask_m≠
()

21 
node
, 
num
 = 0;

24 i‡(
ƒ_node_ids
 =
MAX_NUMNODES
) {

25 
	`f‹_óch_node_mask
(
node
, 
node_possibÀ_m≠
)

26 
num
 = 
node
;

27 
ƒ_node_ids
 = 
num
 + 1;

31 
node
 = 0;Çodê< 
ƒ_node_ids
;Çode++)

32 
	`Æloc_boŸmem_˝umask_v¨
(&
node_to_˝umask_m≠
[
node
]);

35 
	`¥_debug
("Nodêtÿ˝umask m≠ f‹ %dÇodes\n", 
ƒ_node_ids
);

36 
	}
}

38 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


42 c⁄° 
˝umask
 *
	$˝umask_of_node
(
node
)

44 i‡(
node
 >
ƒ_node_ids
) {

45 
	`¥ötk
(
KERN_WARNING


47 
node
, 
ƒ_node_ids
);

48 
	`dump_°ack
();

49  
˝u_n⁄e_mask
;

51 i‡(
node_to_˝umask_m≠
[
node
] =
NULL
) {

52 
	`¥ötk
(
KERN_WARNING


54 
node
);

55 
	`dump_°ack
();

56  
˝u_⁄löe_mask
;

58  
node_to_˝umask_m≠
[
node
];

59 
	}
}

60 
EXPORT_SYMBOL
(
˝umask_of_node
);

	@/cmpt816/linux/arch/x86/mm/numa_64.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/mmz⁄e.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/nodemask.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/e820.h
>

17 
	~<asm/¥Ÿo.h
>

18 
	~<asm/dma.h
>

19 
	~<asm/numa.h
>

20 
	~<asm/a˝i.h
>

21 
	~<asm/k8.h
>

23 
pgli°_d©a
 *
	gnode_d©a
[
MAX_NUMNODES
] 
	g__ªad_mo°ly
;

24 
EXPORT_SYMBOL
(
node_d©a
);

26 
memnode
 
	gmemnode
;

28 
s16
 
	g≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__˝uöôd©a
 = {

29 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


32 
numa_off
 
	g__öôd©a
;

33 
__öôd©a
 
	gnodem≠_addr
;

34 
__öôd©a
 
	gnodem≠_size
;

39 
DEFINE_EARLY_PER_CPU
(, 
x86_˝u_to_node_m≠
, 
NUMA_NO_NODE
);

40 
EXPORT_EARLY_PER_CPU_SYMBOL
(
x86_˝u_to_node_m≠
);

49 
__öô
 
	$p›uœã_memnodem≠
(c⁄° 
boŸnode
 *
nodes
,

50 
numnodes
, 
shi·
, *
nodeids
)

52 
addr
, 
íd
;

53 
i
, 
ªs
 = -1;

55 
	`mem£t
(
memnodem≠
, 0xff, (
s16
)*
memnodem≠size
);

56 
i
 = 0; i < 
numnodes
; i++) {

57 
addr
 = 
nodes
[
i
].
°¨t
;

58 
íd
 = 
nodes
[
i
].end;

59 i‡(
addr
 >
íd
)

61 i‡((
íd
 >> 
shi·
Ë>
memnodem≠size
)

64 i‡(
memnodem≠
[
addr
 >> 
shi·
] !
NUMA_NO_NODE
)

67 i‡(!
nodeids
)

68 
memnodem≠
[
addr
 >> 
shi·
] = 
i
;

70 
memnodem≠
[
addr
 >> 
shi·
] = 
nodeids
[
i
];

72 
addr
 +(1UL << 
shi·
);

73 } 
addr
 < 
íd
);

74 
ªs
 = 1;

76  
ªs
;

77 
	}
}

79 
__öô
 
	$Æloˇã_ˇchólig√d_memnodem≠
()

81 
addr
;

83 
memnodem≠
 = 
memnode
.
embedded_m≠
;

84 i‡(
memnodem≠size
 <
	`ARRAY_SIZE
(
memnode
.
embedded_m≠
))

87 
addr
 = 0x8000;

88 
nodem≠_size
 = 
	`roundup
((
s16
Ë* 
memnodem≠size
, 
L1_CACHE_BYTES
);

89 
nodem≠_addr
 = 
	`föd_e820_¨ó
(
addr
, 
max_p‚
<<
PAGE_SHIFT
,

90 
nodem≠_size
, 
L1_CACHE_BYTES
);

91 i‡(
nodem≠_addr
 == -1UL) {

92 
	`¥ötk
(
KERN_ERR


94 
nodem≠_addr
 = 
nodem≠_size
 = 0;

97 
memnodem≠
 = 
	`phys_to_vút
(
nodem≠_addr
);

98 
	`ª£rve_óæy
(
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
, "MEMNODEMAP");

100 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

101 
nodem≠_addr
,Çodem≠_add∏+ 
nodem≠_size
);

103 
	}
}

109 
__öô
 
	$exåa˘_lsb_‰om_nodes
(c⁄° 
boŸnode
 *
nodes
,

110 
numnodes
)

112 
i
, 
nodes_u£d
 = 0;

113 
°¨t
, 
íd
;

114 
bôfõld
 = 0, 
memt›
 = 0;

116 
i
 = 0; i < 
numnodes
; i++) {

117 
°¨t
 = 
nodes
[
i
].start;

118 
íd
 = 
nodes
[
i
].end;

119 i‡(
°¨t
 >
íd
)

121 
bôfõld
 |
°¨t
;

122 
nodes_u£d
++;

123 i‡(
íd
 > 
memt›
)

124 
memt›
 = 
íd
;

126 i‡(
nodes_u£d
 <= 1)

127 
i
 = 63;

129 
i
 = 
	`föd_fú°_bô
(&
bôfõld
, ()*8);

130 
memnodem≠size
 = (
memt›
 >> 
i
)+1;

131  
i
;

132 
	}
}

134 
__öô
 
	$compuã_hash_shi·
(
boŸnode
 *
nodes
, 
numnodes
,

135 *
nodeids
)

137 
shi·
;

139 
shi·
 = 
	`exåa˘_lsb_‰om_nodes
(
nodes
, 
numnodes
);

140 i‡(
	`Æloˇã_ˇchólig√d_memnodem≠
())

142 
	`¥ötk
(
KERN_DEBUG
 "NUMA: Using %d forÅhe hash shift.\n",

143 
shi·
);

145 i‡(
	`p›uœã_memnodem≠
(
nodes
, 
numnodes
, 
shi·
, 
nodeids
) != 1) {

146 
	`¥ötk
(
KERN_INFO
 "Your memory isÇotáligned youÇeedÅo "

148 "shi·=%d\n", 
shi·
);

151  
shi·
;

152 
	}
}

154 
__memöô
 
	$__óæy_p‚_to_nid
(
p‚
)

156  
	`phys_to_nid
(
p‚
 << 
PAGE_SHIFT
);

157 
	}
}

159 * 
__öô
 
	$óæy_node_mem
(
nodeid
, 
°¨t
,

160 
íd
, 
size
,

161 
Æign
)

163 
mem
;

169 i‡(
°¨t
 < (
MAX_DMA_PFN
<<
PAGE_SHIFT
))

170 
°¨t
 = 
MAX_DMA_PFN
<<
PAGE_SHIFT
;

171 i‡(
°¨t
 < (
MAX_DMA32_PFN
<<
PAGE_SHIFT
) &&

172 
íd
 > (
MAX_DMA32_PFN
<<
PAGE_SHIFT
))

173 
°¨t
 = 
MAX_DMA32_PFN
<<
PAGE_SHIFT
;

174 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

175 i‡(
mem
 != -1L)

176  
	`__va
(
mem
);

179 
íd
 = 
max_p‚_m≠≥d
 << 
PAGE_SHIFT
;

180 i‡(
íd
 > (
MAX_DMA32_PFN
<<
PAGE_SHIFT
))

181 
°¨t
 = 
MAX_DMA32_PFN
<<
PAGE_SHIFT
;

183 
°¨t
 = 
MAX_DMA_PFN
<<
PAGE_SHIFT
;

184 
mem
 = 
	`föd_e820_¨ó
(
°¨t
, 
íd
, 
size
, 
Æign
);

185 i‡(
mem
 != -1L)

186  
	`__va
(
mem
);

188 
	`¥ötk
(
KERN_ERR
 "Cannot find %lu bytes inÇode %d\n",

189 
size
, 
nodeid
);

191  
NULL
;

192 
	}
}

195 
__öô


196 
	$£tup_node_boŸmem
(
nodeid
, 
°¨t
, 
íd
)

198 
°¨t_p‚
, 
œ°_p‚
, 
noded©a_phys
;

199 c⁄° 
pgd©_size
 = 
	`roundup
((
pg_d©a_t
), 
PAGE_SIZE
);

200 
nid
;

201 #i‚de‡
CONFIG_NO_BOOTMEM


202 
boŸm≠_°¨t
, 
boŸm≠_∑ges
, 
boŸm≠_size
;

203 *
boŸm≠
;

206 i‡(!
íd
)

213 i‡(
íd
 && (íd - 
°¨t
Ë< 
NODE_MIN_SIZE
)

216 
°¨t
 = 
	`roundup
(°¨t, 
ZONE_ALIGN
);

218 
	`¥ötk
(
KERN_INFO
 "Inômem sëu∞nodê%d %016lx-%016lx\n", 
nodeid
,

219 
°¨t
, 
íd
);

221 
°¨t_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

222 
œ°_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

224 
node_d©a
[
nodeid
] = 
	`óæy_node_mem
“odeid, 
°¨t
, 
íd
, 
pgd©_size
,

225 
SMP_CACHE_BYTES
);

226 i‡(
node_d©a
[
nodeid
] =
NULL
)

228 
noded©a_phys
 = 
	`__∑
(
node_d©a
[
nodeid
]);

229 
	`ª£rve_óæy
(
noded©a_phys
,Çoded©a_phy†+ 
pgd©_size
, "NODE_DATA");

230 
	`¥ötk
(
KERN_INFO
 " NODE_DATA [%016lx - %016lx]\n", 
noded©a_phys
,

231 
noded©a_phys
 + 
pgd©_size
 - 1);

232 
nid
 = 
	`phys_to_nid
(
noded©a_phys
);

233 i‡(
nid
 !
nodeid
)

234 
	`¥ötk
(
KERN_INFO
 " NODE_DATA(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

236 
	`mem£t
(
	`NODE_DATA
(
nodeid
), 0, (
pg_d©a_t
));

237 
	`NODE_DATA
(
nodeid
)->
node_id
 =Çodeid;

238 
	`NODE_DATA
(
nodeid
)->
node_°¨t_p‚
 = 
°¨t_p‚
;

239 
	`NODE_DATA
(
nodeid
)->
node_•™√d_∑ges
 = 
œ°_p‚
 - 
°¨t_p‚
;

241 #i‚de‡
CONFIG_NO_BOOTMEM


242 
	`NODE_DATA
(
nodeid
)->
bd©a
 = &
boŸmem_node_d©a
[nodeid];

251 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
œ°_p‚
 - 
°¨t_p‚
);

252 
boŸm≠_°¨t
 = 
	`roundup
(
noded©a_phys
 + 
pgd©_size
, 
PAGE_SIZE
);

257 
boŸm≠
 = 
	`óæy_node_mem
(
nodeid
, 
boŸm≠_°¨t
, 
íd
,

258 
boŸm≠_∑ges
<<
PAGE_SHIFT
, 
PAGE_SIZE
);

259 i‡(
boŸm≠
 =
NULL
) {

260 
	`‰ì_óæy
(
noded©a_phys
,Çoded©a_phy†+ 
pgd©_size
);

261 
node_d©a
[
nodeid
] = 
NULL
;

264 
boŸm≠_°¨t
 = 
	`__∑
(
boŸm≠
);

265 
	`ª£rve_óæy
(
boŸm≠_°¨t
, boŸm≠_°¨t+(
boŸm≠_∑ges
<<
PAGE_SHIFT
),

268 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nodeid
),

269 
boŸm≠_°¨t
 >> 
PAGE_SHIFT
,

270 
°¨t_p‚
, 
œ°_p‚
);

272 
	`¥ötk
(
KERN_INFO
 " bootmap [%016lx - %016lx]Öages %lx\n",

273 
boŸm≠_°¨t
, boŸm≠_°¨à+ 
boŸm≠_size
 - 1,

274 
boŸm≠_∑ges
);

275 
nid
 = 
	`phys_to_nid
(
boŸm≠_°¨t
);

276 i‡(
nid
 !
nodeid
)

277 
	`¥ötk
(
KERN_INFO
 " boŸm≠(%dË⁄Çodê%d\n", 
nodeid
, 
nid
);

279 
	`‰ì_boŸmem_wôh_a˘ive_ªgi⁄s
(
nodeid
, 
íd
);

282 
	`node_£t_⁄löe
(
nodeid
);

283 
	}
}

292 
__öô
 
	$numa_öô_¨øy
()

294 
º
, 
i
;

296 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

297 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

298 i‡(
	`óæy_˝u_to_node
(
i
Ë!
NUMA_NO_NODE
)

300 
	`numa_£t_node
(
i
, 
º
);

301 
º
 = 
	`√xt_node
‘r, 
node_⁄löe_m≠
);

302 i‡(
º
 =
MAX_NUMNODES
)

303 
º
 = 
	`fú°_node
(
node_⁄löe_m≠
);

305 
	}
}

307 #ifde‡
CONFIG_NUMA_EMU


309 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

310 
boŸnode
 
	gphy¢odes
[
MAX_NUMNODES
] 
	g__öôd©a
;

311 *
cmdlöe
 
	g__öôd©a
;

313 
__öô
 
	$£tup_phy¢odes
(
°¨t
, 
íd
,

314 
a˝i
, 
k8
)

316 
ƒ_nodes
 = 0;

317 
ªt
 = 0;

318 
i
;

320 #ifde‡
CONFIG_ACPI_NUMA


321 i‡(
a˝i
)

322 
ƒ_nodes
 = 
	`a˝i_gë_nodes
(
phy¢odes
);

324 #ifde‡
CONFIG_K8_NUMA


325 i‡(
k8
)

326 
ƒ_nodes
 = 
	`k8_gë_nodes
(
phy¢odes
);

333 
i
 = 0; i < 
ƒ_nodes
; i++) {

334 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

336 i‡(
phy¢odes
[
i
].
°¨t
 > 
íd
) {

337 
phy¢odes
[
i
].
íd
 =Öhy¢odes[i].
°¨t
;

340 i‡(
phy¢odes
[
i
].
íd
 < 
°¨t
) {

341 
phy¢odes
[
i
].
°¨t
 =Öhy¢odes[i].
íd
;

344 i‡(
phy¢odes
[
i
].
°¨t
 < start)

345 
phy¢odes
[
i
].
°¨t
 = start;

346 i‡(
phy¢odes
[
i
].
íd
 >Énd)

347 
phy¢odes
[
i
].
íd
 =Énd;

354 
i
 = 0; i < 
ƒ_nodes
; i++) {

355 i‡(
phy¢odes
[
i
].
°¨t
 =phy¢odes[i].
íd
)

357 
phy¢odes
[
ªt
].
°¨t
 =Öhy¢odes[
i
].start;

358 
phy¢odes
[
ªt
].
íd
 =Öhy¢odes[
i
].end;

359 
ªt
++;

366 i‡(!
ªt
) {

367 
phy¢odes
[
ªt
].
°¨t
 = start;

368 
phy¢odes
[
ªt
].
íd
 =Énd;

369 
ªt
 = 1;

371  
ªt
;

372 
	}
}

381 
__öô
 
	$£tup_node_ønge
(
nid
, 
u64
 *
addr
, u64 
size
, u64 
max_addr
)

383 
ªt
 = 0;

384 
nodes
[
nid
].
°¨t
 = *
addr
;

385 *
addr
 +
size
;

386 i‡(*
addr
 >
max_addr
) {

387 *
addr
 = 
max_addr
;

388 
ªt
 = -1;

390 
nodes
[
nid
].
íd
 = *
addr
;

391 
	`node_£t
(
nid
, 
node_possibÀ_m≠
);

392 
	`¥ötk
(
KERN_INFO
 "FakögÇodê%dáà%016Lx-%016Lx (%LuMB)\n", 
nid
,

393 
nodes
[
nid
].
°¨t
,Çodes[nid].
íd
,

394 (
nodes
[
nid
].
íd
 -Çodes[nid].
°¨t
) >> 20);

395  
ªt
;

396 
	}
}

402 
__öô
 
	$•lô_nodes_öãæóve
(
u64
 
addr
, u64 
max_addr
,

403 
ƒ_phys_nodes
, 
ƒ_nodes
)

405 
nodemask_t
 
phy¢ode_mask
 = 
NODE_MASK_NONE
;

406 
u64
 
size
;

407 
big
;

408 
ªt
 = 0;

409 
i
;

411 i‡(
ƒ_nodes
 <= 0)

413 i‡(
ƒ_nodes
 > 
MAX_NUMNODES
) {

414 
	`¥_öfo
("numa=fake=%dÅooÜarge,ÑeducingÅo %d\n",

415 
ƒ_nodes
, 
MAX_NUMNODES
);

416 
ƒ_nodes
 = 
MAX_NUMNODES
;

419 
size
 = (
max_addr
 - 
addr
 - 
	`e820_hﬁe_size
◊ddr, max_addr)Ë/ 
ƒ_nodes
;

424 
big
 = ((
size
 & ~
FAKE_NODE_MIN_HASH_MASK
Ë* 
ƒ_nodes
) /

425 
FAKE_NODE_MIN_SIZE
;

427 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

428 i‡(!
size
) {

429 
	`¥_îr
("NotÉnough memory forÉachÇode. "

434 
i
 = 0; i < 
ƒ_phys_nodes
; i++)

435 i‡(
phy¢odes
[
i
].
°¨t
 !phy¢odes[i].
íd
)

436 
	`node_£t
(
i
, 
phy¢ode_mask
);

442 
	`nodes_weight
(
phy¢ode_mask
)) {

443 
	`f‹_óch_node_mask
(
i
, 
phy¢ode_mask
) {

444 
u64
 
íd
 = 
phy¢odes
[
i
].
°¨t
 + 
size
;

445 
u64
 
dma32_íd
 = 
	`PFN_PHYS
(
MAX_DMA32_PFN
);

447 i‡(
ªt
 < 
big
)

448 
íd
 +
FAKE_NODE_MIN_SIZE
;

454 
íd
 - 
phy¢odes
[
i
].
°¨t
 -

455 
	`e820_hﬁe_size
(
phy¢odes
[
i
].
°¨t
, 
íd
Ë< 
size
) {

456 
íd
 +
FAKE_NODE_MIN_SIZE
;

457 i‡(
íd
 > 
phy¢odes
[
i
].end) {

458 
íd
 = 
phy¢odes
[
i
].end;

468 i‡(
íd
 < 
dma32_íd
 && dma32_end -Énd -

469 
	`e820_hﬁe_size
(
íd
, 
dma32_íd
Ë< 
FAKE_NODE_MIN_SIZE
)

470 
íd
 = 
dma32_íd
;

477 i‡(
phy¢odes
[
i
].
íd
 -Énd -

478 
	`e820_hﬁe_size
(
íd
, 
phy¢odes
[
i
].ídË< 
size
)

479 
íd
 = 
phy¢odes
[
i
].end;

486 i‡(
	`nodes_weight
(
phy¢ode_mask
Ë+ 
ªt
 >
ƒ_nodes
)

487 
íd
 = 
phy¢odes
[
i
].end;

489 i‡(
	`£tup_node_ønge
(
ªt
++, &
phy¢odes
[
i
].
°¨t
,

490 
íd
 - 
phy¢odes
[
i
].
°¨t
,

491 
phy¢odes
[
i
].
íd
) < 0)

492 
	`node_˛ór
(
i
, 
phy¢ode_mask
);

495  
ªt
;

496 
	}
}

502 
u64
 
__öô
 
	$föd_íd_of_node
(
u64
 
°¨t
, u64 
max_addr
, u64 
size
)

504 
u64
 
íd
 = 
°¨t
 + 
size
;

506 
íd
 - 
°¨t
 - 
	`e820_hﬁe_size
(°¨t,ÉndË< 
size
) {

507 
íd
 +
FAKE_NODE_MIN_SIZE
;

508 i‡(
íd
 > 
max_addr
) {

509 
íd
 = 
max_addr
;

513  
íd
;

514 
	}
}

520 
__öô
 
	$•lô_nodes_size_öãæóve
(
u64
 
addr
, u64 
max_addr
, u64 
size
)

522 
nodemask_t
 
phy¢ode_mask
 = 
NODE_MASK_NONE
;

523 
u64
 
mö_size
;

524 
ªt
 = 0;

525 
i
;

527 i‡(!
size
)

535 
mö_size
 = (
max_addr
 - 
addr
 - 
	`e820_hﬁe_size
(addr, max_addr)) /

536 
MAX_NUMNODES
;

537 
mö_size
 = 
	`max
(mö_size, 
FAKE_NODE_MIN_SIZE
);

538 i‡((
mö_size
 & 
FAKE_NODE_MIN_HASH_MASK
) < min_size)

539 
mö_size
 = (mö_sizê+ 
FAKE_NODE_MIN_SIZE
) &

540 
FAKE_NODE_MIN_HASH_MASK
;

541 i‡(
size
 < 
mö_size
) {

542 
	`¥_îr
("FakeÇode size %LuMBÅoo small, increasingÅo %LuMB\n",

543 
size
 >> 20, 
mö_size
 >> 20);

544 
size
 = 
mö_size
;

546 
size
 &
FAKE_NODE_MIN_HASH_MASK
;

548 
i
 = 0; i < 
MAX_NUMNODES
; i++)

549 i‡(
phy¢odes
[
i
].
°¨t
 !phy¢odes[i].
íd
)

550 
	`node_£t
(
i
, 
phy¢ode_mask
);

555 
	`nodes_weight
(
phy¢ode_mask
)) {

556 
	`f‹_óch_node_mask
(
i
, 
phy¢ode_mask
) {

557 
u64
 
dma32_íd
 = 
MAX_DMA32_PFN
 << 
PAGE_SHIFT
;

558 
u64
 
íd
;

560 
íd
 = 
	`föd_íd_of_node
(
phy¢odes
[
i
].
°¨t
,

561 
phy¢odes
[
i
].
íd
, 
size
);

567 i‡(
íd
 < 
dma32_íd
 && dma32_end -Énd -

568 
	`e820_hﬁe_size
(
íd
, 
dma32_íd
Ë< 
FAKE_NODE_MIN_SIZE
)

569 
íd
 = 
dma32_íd
;

576 i‡(
phy¢odes
[
i
].
íd
 -Énd -

577 
	`e820_hﬁe_size
(
íd
, 
phy¢odes
[
i
].ídË< 
size
)

578 
íd
 = 
phy¢odes
[
i
].end;

585 i‡(
	`£tup_node_ønge
(
ªt
++, &
phy¢odes
[
i
].
°¨t
,

586 
íd
 - 
phy¢odes
[
i
].
°¨t
,

587 
phy¢odes
[
i
].
íd
) < 0)

588 
	`node_˛ór
(
i
, 
phy¢ode_mask
);

591  
ªt
;

592 
	}
}

598 
__öô
 
	$numa_emuœti⁄
(
°¨t_p‚
,

599 
œ°_p‚
, 
a˝i
, 
k8
)

601 
u64
 
addr
 = 
°¨t_p‚
 << 
PAGE_SHIFT
;

602 
u64
 
max_addr
 = 
œ°_p‚
 << 
PAGE_SHIFT
;

603 
num_phys_nodes
;

604 
num_nodes
;

605 
i
;

607 
num_phys_nodes
 = 
	`£tup_phy¢odes
(
addr
, 
max_addr
, 
a˝i
, 
k8
);

613 i‡(
	`°rchr
(
cmdlöe
, 'M') || strchr(cmdline, 'G')) {

614 
u64
 
size
;

616 
size
 = 
	`mem∑r£
(
cmdlöe
, &cmdline);

617 
num_nodes
 = 
	`•lô_nodes_size_öãæóve
(
addr
, 
max_addr
, 
size
);

619 
n
;

621 
n
 = 
	`sim∂e_°πoul
(
cmdlöe
, 
NULL
, 0);

622 
num_nodes
 = 
	`•lô_nodes_öãæóve
(
addr
, 
max_addr
, 
num_phys_nodes
, 
n
);

625 i‡(
num_nodes
 < 0)

626  
num_nodes
;

627 
memnode_shi·
 = 
	`compuã_hash_shi·
(
nodes
, 
num_nodes
, 
NULL
);

628 i‡(
memnode_shi·
 < 0) {

629 
memnode_shi·
 = 0;

630 
	`¥ötk
(
KERN_ERR
 "No NUMA hash function found. NUMAÉmulation "

639 
	`ªmove_Æl_a˘ive_ønges
();

640 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
) {

641 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

642 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

643 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

645 
	`a˝i_Áke_nodes
(
nodes
, 
num_nodes
);

646 
	`numa_öô_¨øy
();

648 
	}
}

651 
__öô
 
	$öômem_öô
(
°¨t_p‚
, 
œ°_p‚
,

652 
a˝i
, 
k8
)

654 
i
;

656 
	`nodes_˛ór
(
node_possibÀ_m≠
);

657 
	`nodes_˛ór
(
node_⁄löe_m≠
);

659 #ifde‡
CONFIG_NUMA_EMU


660 i‡(
cmdlöe
 && !
	`numa_emuœti⁄
(
°¨t_p‚
, 
œ°_p‚
, 
a˝i
, 
k8
))

662 
	`nodes_˛ór
(
node_possibÀ_m≠
);

663 
	`nodes_˛ór
(
node_⁄löe_m≠
);

666 #ifde‡
CONFIG_ACPI_NUMA


667 i‡(!
numa_off
 && 
a˝i
 && !
	`a˝i_sˇn_nodes
(
°¨t_p‚
 << 
PAGE_SHIFT
,

668 
œ°_p‚
 << 
PAGE_SHIFT
))

670 
	`nodes_˛ór
(
node_possibÀ_m≠
);

671 
	`nodes_˛ór
(
node_⁄löe_m≠
);

674 #ifde‡
CONFIG_K8_NUMA


675 i‡(!
numa_off
 && 
k8
 && !
	`k8_sˇn_nodes
())

677 
	`nodes_˛ór
(
node_possibÀ_m≠
);

678 
	`nodes_˛ór
(
node_⁄löe_m≠
);

680 
	`¥ötk
(
KERN_INFO
 "%s\n",

681 
numa_off
 ? "NUMAÅurned off" : "No NUMA configuration found");

683 
	`¥ötk
(
KERN_INFO
 "FakingáÇodeát %016lx-%016lx\n",

684 
°¨t_p‚
 << 
PAGE_SHIFT
,

685 
œ°_p‚
 << 
PAGE_SHIFT
);

687 
memnode_shi·
 = 63;

688 
memnodem≠
 = 
memnode
.
embedded_m≠
;

689 
memnodem≠
[0] = 0;

690 
	`node_£t_⁄löe
(0);

691 
	`node_£t
(0, 
node_possibÀ_m≠
);

692 
i
 = 0; i < 
ƒ_˝u_ids
; i++)

693 
	`numa_£t_node
(
i
, 0);

694 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(0, 
°¨t_p‚
, 
œ°_p‚
);

695 
	`£tup_node_boŸmem
(0, 
°¨t_p‚
 << 
PAGE_SHIFT
, 
œ°_p‚
 << PAGE_SHIFT);

696 
	}
}

698 
__öô
 
	$numa_‰ì_Æl_boŸmem
()

700 
∑ges
 = 0;

701 
i
;

703 
	`f‹_óch_⁄löe_node
(
i
)

704 
∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
i
));

706 #ifde‡
CONFIG_NO_BOOTMEM


707 
∑ges
 +
	`‰ì_Æl_mem‹y_c‹e_óæy
(
MAX_NUMNODES
);

710  
∑ges
;

711 
	}
}

713 
__öô
 
	$numa_£tup
(*
›t
)

715 i‡(!
›t
)

716  -
EINVAL
;

717 i‡(!
	`°∫cmp
(
›t
, "off", 3))

718 
numa_off
 = 1;

719 #ifde‡
CONFIG_NUMA_EMU


720 i‡(!
	`°∫cmp
(
›t
, "fake=", 5))

721 
cmdlöe
 = 
›t
 + 5;

723 #ifde‡
CONFIG_ACPI_NUMA


724 i‡(!
	`°∫cmp
(
›t
, "noacpi", 6))

725 
a˝i_numa
 = -1;

728 
	}
}

729 
óæy_∑øm
("numa", 
numa_£tup
);

731 #ifde‡
CONFIG_NUMA


733 
__öô
 
	$föd_√¨_⁄löe_node
(
node
)

735 
n
, 
vÆ
;

736 
mö_vÆ
 = 
INT_MAX
;

737 
be°_node
 = -1;

739 
	`f‹_óch_⁄löe_node
(
n
) {

740 
vÆ
 = 
	`node_di°™˚
(
node
, 
n
);

742 i‡(
vÆ
 < 
mö_vÆ
) {

743 
mö_vÆ
 = 
vÆ
;

744 
be°_node
 = 
n
;

748  
be°_node
;

749 
	}
}

765 
__öô
 
	$öô_˝u_to_node
()

767 
˝u
;

768 
u16
 *
˝u_to_≠icid
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_≠icid
);

770 
	`BUG_ON
(
˝u_to_≠icid
 =
NULL
);

772 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

773 
node
;

774 
u16
 
≠icid
 = 
˝u_to_≠icid
[
˝u
];

776 i‡(
≠icid
 =
BAD_APICID
)

778 
node
 = 
≠icid_to_node
[
≠icid
];

779 i‡(
node
 =
NUMA_NO_NODE
)

781 i‡(!
	`node_⁄löe
(
node
))

782 
node
 = 
	`föd_√¨_⁄löe_node
(node);

783 
	`numa_£t_node
(
˝u
, 
node
);

785 
	}
}

789 
__˝uöô
 
	$numa_£t_node
(
˝u
, 
node
)

791 *
˝u_to_node_m≠
 = 
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
);

794 i‡(
˝u_to_node_m≠
) {

795 
˝u_to_node_m≠
[
˝u
] = 
node
;

799 #ifde‡
CONFIG_DEBUG_PER_CPU_MAPS


800 i‡(
˝u
 >
ƒ_˝u_ids
 || !
	`˝u_possibÀ
(cpu)) {

801 
	`¥ötk
(
KERN_ERR
 "numa_£t_node: invÆid cpu# (%d)\n", 
˝u
);

802 
	`dump_°ack
();

806 
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
Ë
node
;

808 i‡(
node
 !
NUMA_NO_NODE
)

809 
	`£t_˝u_numa_node
(
˝u
, 
node
);

810 
	}
}

812 
__˝uöô
 
	$numa_˛ór_node
(
˝u
)

814 
	`numa_£t_node
(
˝u
, 
NUMA_NO_NODE
);

815 
	}
}

817 #i‚de‡
CONFIG_DEBUG_PER_CPU_MAPS


819 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

821 
	`˝umask_£t_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

822 
	}
}

824 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

826 
	`˝umask_˛ór_˝u
(
˝u
, 
node_to_˝umask_m≠
[
	`óæy_˝u_to_node
(cpu)]);

827 
	}
}

834 
__˝uöô
 
	$numa_£t_˝umask
(
˝u
, 
íabÀ
)

836 
node
 = 
	`óæy_˝u_to_node
(
˝u
);

837 
˝umask
 *
mask
;

838 
buf
[64];

840 
mask
 = 
node_to_˝umask_m≠
[
node
];

841 i‡(
mask
 =
NULL
) {

842 
	`¥ötk
(
KERN_ERR
 "node_to_˝umask_m≠[%i] NULL\n", 
node
);

843 
	`dump_°ack
();

847 i‡(
íabÀ
)

848 
	`˝umask_£t_˝u
(
˝u
, 
mask
);

850 
	`˝umask_˛ór_˝u
(
˝u
, 
mask
);

852 
	`˝uli°_s˙¥ötf
(
buf
, (buf), 
mask
);

853 
	`¥ötk
(
KERN_DEBUG
 "%s cpu %dÇode %d: maskÇow %s\n",

854 
íabÀ
 ? "numa_add_˝u" : "numa_ªmove_˝u", 
˝u
, 
node
, 
buf
);

855 
	}
}

857 
__˝uöô
 
	$numa_add_˝u
(
˝u
)

859 
	`numa_£t_˝umask
(
˝u
, 1);

860 
	}
}

862 
__˝uöô
 
	$numa_ªmove_˝u
(
˝u
)

864 
	`numa_£t_˝umask
(
˝u
, 0);

865 
	}
}

867 
	$__˝u_to_node
(
˝u
)

869 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)) {

870 
	`¥ötk
(
KERN_WARNING


871 "˝u_to_node(%d): ußgêtoÿóæy!\n", 
˝u
);

872 
	`dump_°ack
();

873  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

875  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

876 
	}
}

877 
EXPORT_SYMBOL
(
__˝u_to_node
);

883 
	$óæy_˝u_to_node
(
˝u
)

885 i‡(
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
))

886  
	`óæy_≥r_˝u_±r
(
x86_˝u_to_node_m≠
)[
˝u
];

888 i‡(!
	`˝u_possibÀ
(
˝u
)) {

889 
	`¥ötk
(
KERN_WARNING


890 "óæy_˝u_to_node(%d):Çÿ≥r_˝uáªa!\n", 
˝u
);

891 
	`dump_°ack
();

892  
NUMA_NO_NODE
;

894  
	`≥r_˝u
(
x86_˝u_to_node_m≠
, 
˝u
);

895 
	}
}

	@/cmpt816/linux/arch/x86/mm/pageattr.c

5 
	~<löux/highmem.h
>

6 
	~<löux/boŸmem.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/öãºu±.h
>

11 
	~<löux/£q_fûe.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/p‚.h
>

14 
	~<löux/≥r˝u.h
>

15 
	~<löux/gÂ.h
>

17 
	~<asm/e820.h
>

18 
	~<asm/¥o˚ss‹.h
>

19 
	~<asm/ébÊush.h
>

20 
	~<asm/£˘i⁄s.h
>

21 
	~<asm/£tup.h
>

22 
	~<asm/uac˚ss.h
>

23 
	~<asm/pgÆloc.h
>

24 
	~<asm/¥Ÿo.h
>

25 
	~<asm/∑t.h
>

30 
	s˝a_d©a
 {

31 *
	mvaddr
;

32 
pg¥Ÿ_t
 
	mmask_£t
;

33 
pg¥Ÿ_t
 
	mmask_˛r
;

34 
	mnum∑ges
;

35 
	mÊags
;

36 
	mp‚
;

37 
	mf‹˚_•lô
 : 1;

38 
	mcuΩage
;

39 
∑ge
 **
	m∑ges
;

48 
DEFINE_SPINLOCK
(
˝a_lock
);

50 
	#CPA_FLUSHTLB
 1

	)

51 
	#CPA_ARRAY
 2

	)

52 
	#CPA_PAGES_ARRAY
 4

	)

54 #ifde‡
CONFIG_PROC_FS


55 
	gdúe˘_∑ges_cou¡
[
PG_LEVEL_NUM
];

57 
	$upd©e_∑ge_cou¡
(
Àvñ
, 
∑ges
)

59 
Êags
;

62 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

63 
dúe˘_∑ges_cou¡
[
Àvñ
] +
∑ges
;

64 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

65 
	}
}

67 
	$•lô_∑ge_cou¡
(
Àvñ
)

69 
dúe˘_∑ges_cou¡
[
Àvñ
]--;

70 
dúe˘_∑ges_cou¡
[
Àvñ
 - 1] +
PTRS_PER_PTE
;

71 
	}
}

73 
	$¨ch_ªp‹t_memöfo
(
£q_fûe
 *
m
)

75 
	`£q_¥ötf
(
m
, "DirectMap4k: %8lu kB\n",

76 
dúe˘_∑ges_cou¡
[
PG_LEVEL_4K
] << 2);

77 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

78 
	`£q_¥ötf
(
m
, "DirectMap2M: %8lu kB\n",

79 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 11);

81 
	`£q_¥ötf
(
m
, "DirectMap4M: %8lu kB\n",

82 
dúe˘_∑ges_cou¡
[
PG_LEVEL_2M
] << 12);

84 #ifde‡
CONFIG_X86_64


85 i‡(
dúe˘_gb∑ges
)

86 
	`£q_¥ötf
(
m
, "DirectMap1G: %8lu kB\n",

87 
dúe˘_∑ges_cou¡
[
PG_LEVEL_1G
] << 20);

89 
	}
}

91 
ölöe
 
	$•lô_∑ge_cou¡
(
Àvñ
Ë{ 
	}
}

94 #ifde‡
CONFIG_X86_64


96 
ölöe
 
	$highm≠_°¨t_p‚
()

98  
	`__∑
(
_ãxt
Ë>> 
PAGE_SHIFT
;

99 
	}
}

101 
ölöe
 
	$highm≠_íd_p‚
()

103  
	`__∑
(
	`roundup
(
_brk_íd
, 
PMD_SIZE
)Ë>> 
PAGE_SHIFT
;

104 
	}
}

108 #ifde‡
CONFIG_DEBUG_PAGEALLOC


109 
	#debug_∑góŒoc
 1

	)

111 
	#debug_∑góŒoc
 0

	)

114 
ölöe
 

115 
	$wôhö
(
addr
, 
°¨t
, 
íd
)

117  
addr
 >
°¨t
 &&ádd∏< 
íd
;

118 
	}
}

132 
	$˛Êush_ˇche_ønge
(*
vaddr
, 
size
)

134 *
víd
 = 
vaddr
 + 
size
 - 1;

136 
	`mb
();

138 ; 
vaddr
 < 
víd
; vadd∏+
boŸ_˝u_d©a
.
x86_˛Êush_size
)

139 
	`˛Êush
(
vaddr
);

143 
	`˛Êush
(
víd
);

145 
	`mb
();

146 
	}
}

147 
EXPORT_SYMBOL_GPL
(
˛Êush_ˇche_ønge
);

149 
	$__˝a_Êush_Æl
(*
¨g
)

151 
ˇche
 = ()
¨g
;

157 
	`__Êush_éb_Æl
();

159 i‡(
ˇche
 && 
boŸ_˝u_d©a
.
x86
 >= 4)

160 
	`wbövd
();

161 
	}
}

163 
	$˝a_Êush_Æl
(
ˇche
)

165 
	`BUG_ON
(
	`úqs_dißbÀd
());

167 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
ˇche
, 1);

168 
	}
}

170 
	$__˝a_Êush_ønge
(*
¨g
)

177 
	`__Êush_éb_Æl
();

178 
	}
}

180 
	$˝a_Êush_ønge
(
°¨t
, 
num∑ges
, 
ˇche
)

182 
i
, 
Àvñ
;

183 
addr
;

185 
	`BUG_ON
(
	`úqs_dißbÀd
());

186 
	`WARN_ON
(
	`PAGE_ALIGN
(
°¨t
) != start);

188 
	`⁄_óch_˝u
(
__˝a_Êush_ønge
, 
NULL
, 1);

190 i‡(!
ˇche
)

199 
i
 = 0, 
addr
 = 
°¨t
; i < 
num∑ges
; i++,ádd∏+
PAGE_SIZE
) {

200 
±e_t
 *
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

205 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

206 
	`˛Êush_ˇche_ønge
((*Ë
addr
, 
PAGE_SIZE
);

208 
	}
}

210 
	$˝a_Êush_¨øy
(*
°¨t
, 
num∑ges
, 
ˇche
,

211 
ö_Êags
, 
∑ge
 **
∑ges
)

213 
i
, 
Àvñ
;

214 
do_wbövd
 = 
ˇche
 && 
num∑ges
 >= 1024;

216 
	`BUG_ON
(
	`úqs_dißbÀd
());

218 
	`⁄_óch_˝u
(
__˝a_Êush_Æl
, (*Ë
do_wbövd
, 1);

220 i‡(!
ˇche
 || 
do_wbövd
)

229 
i
 = 0; i < 
num∑ges
; i++) {

230 
addr
;

231 
±e_t
 *
±e
;

233 i‡(
ö_Êags
 & 
CPA_PAGES_ARRAY
)

234 
addr
 = ()
	`∑ge_addªss
(
∑ges
[
i
]);

236 
addr
 = 
°¨t
[
i
];

238 
±e
 = 
	`lookup_addªss
(
addr
, &
Àvñ
);

243 i‡(
±e
 && (
	`±e_vÆ
(*±eË& 
_PAGE_PRESENT
))

244 
	`˛Êush_ˇche_ønge
((*)
addr
, 
PAGE_SIZE
);

246 
	}
}

254 
ölöe
 
pg¥Ÿ_t
 
	$°©ic_¥Ÿe˘i⁄s
(
pg¥Ÿ_t
 
¥Ÿ
, 
addªss
,

255 
p‚
)

257 
pg¥Ÿ_t
 
f‹biddí
 = 
	`__pg¥Ÿ
(0);

263 i‡(
	`wôhö
(
p‚
, 
BIOS_BEGIN
 >> 
PAGE_SHIFT
, 
BIOS_END
 >> PAGE_SHIFT))

264 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

271 i‡(
	`wôhö
(
addªss
, ()
_ãxt
, ()
_ëext
))

272 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_NX
;

278 i‡(
	`wôhö
(
p‚
, 
	`__∑
(()
__°¨t_rod©a
Ë>> 
PAGE_SHIFT
,

279 
	`__∑
(()
__íd_rod©a
Ë>> 
PAGE_SHIFT
))

280 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

282 #i‡
	`deföed
(
CONFIG_X86_64
Ë&& deföed(
CONFIG_DEBUG_RODATA
)

292 i‡(
kî√l_£t_to_ªad⁄ly
 &&

293 
	`wôhö
(
addªss
, ()
_ãxt
,

294 ()
__íd_rod©a_h∑ge_Æign
)) {

295 
Àvñ
;

314 i‡(
	`lookup_addªss
(
addªss
, &
Àvñ
Ë&& (Àvñ !
PG_LEVEL_4K
))

315 
	`pg¥Ÿ_vÆ
(
f‹biddí
Ë|
_PAGE_RW
;

319 
¥Ÿ
 = 
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
’rŸË& ~pg¥Ÿ_vÆ(
f‹biddí
));

321  
¥Ÿ
;

322 
	}
}

332 
±e_t
 *
	$lookup_addªss
(
addªss
, *
Àvñ
)

334 
pgd_t
 *
pgd
 = 
	`pgd_off£t_k
(
addªss
);

335 
pud_t
 *
pud
;

336 
pmd_t
 *
pmd
;

338 *
Àvñ
 = 
PG_LEVEL_NONE
;

340 i‡(
	`pgd_n⁄e
(*
pgd
))

341  
NULL
;

343 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

344 i‡(
	`pud_n⁄e
(*
pud
))

345  
NULL
;

347 *
Àvñ
 = 
PG_LEVEL_1G
;

348 i‡(
	`pud_œrge
(*
pud
Ë|| !
	`pud_¥e£¡
(*pud))

349  (
±e_t
 *)
pud
;

351 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

352 i‡(
	`pmd_n⁄e
(*
pmd
))

353  
NULL
;

355 *
Àvñ
 = 
PG_LEVEL_2M
;

356 i‡(
	`pmd_œrge
(*
pmd
Ë|| !
	`pmd_¥e£¡
(*pmd))

357  (
±e_t
 *)
pmd
;

359 *
Àvñ
 = 
PG_LEVEL_4K
;

361  
	`±e_off£t_kî√l
(
pmd
, 
addªss
);

362 
	}
}

363 
EXPORT_SYMBOL_GPL
(
lookup_addªss
);

368 
	$__£t_pmd_±e
(
±e_t
 *
k±e
, 
addªss
,Öã_à
±e
)

371 
	`£t_±e_©omic
(
k±e
, 
±e
);

372 #ifde‡
CONFIG_X86_32


373 i‡(!
SHARED_KERNEL_PMD
) {

374 
∑ge
 *page;

376 
	`li°_f‹_óch_íåy
(
∑ge
, &
pgd_li°
, 
Ãu
) {

377 
pgd_t
 *
pgd
;

378 
pud_t
 *
pud
;

379 
pmd_t
 *
pmd
;

381 
pgd
 = (
pgd_t
 *)
	`∑ge_addªss
(
∑ge
Ë+ 
	`pgd_ödex
(
addªss
);

382 
pud
 = 
	`pud_off£t
(
pgd
, 
addªss
);

383 
pmd
 = 
	`pmd_off£t
(
pud
, 
addªss
);

384 
	`£t_±e_©omic
((
±e_t
 *)
pmd
, 
±e
);

388 
	}
}

391 
	$åy_¥e£rve_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
,

392 
˝a_d©a
 *
˝a
)

394 
√xçage_addr
, 
num∑ges
, 
pmask
, 
psize
, 
Êags
, 
addr
, 
p‚
;

395 
±e_t
 
√w_±e
, 
ﬁd_±e
, *
tmp
;

396 
pg¥Ÿ_t
 
ﬁd_¥Ÿ
, 
√w_¥Ÿ
;

397 
i
, 
do_•lô
 = 1;

398 
Àvñ
;

400 i‡(
˝a
->
f‹˚_•lô
)

403 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

408 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

409 i‡(
tmp
 !
k±e
)

410 
out_u∆ock
;

412 
Àvñ
) {

413 
PG_LEVEL_2M
:

414 
psize
 = 
PMD_PAGE_SIZE
;

415 
pmask
 = 
PMD_PAGE_MASK
;

417 #ifde‡
CONFIG_X86_64


418 
PG_LEVEL_1G
:

419 
psize
 = 
PUD_PAGE_SIZE
;

420 
pmask
 = 
PUD_PAGE_MASK
;

424 
do_•lô
 = -
EINVAL
;

425 
out_u∆ock
;

432 
√xçage_addr
 = (
addªss
 + 
psize
Ë& 
pmask
;

433 
num∑ges
 = (
√xçage_addr
 - 
addªss
Ë>> 
PAGE_SHIFT
;

434 i‡(
num∑ges
 < 
˝a
->numpages)

435 
˝a
->
num∑ges
 =Çumpages;

440 
ﬁd_±e
 = *
k±e
;

441 
ﬁd_¥Ÿ
 = 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

443 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

444 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

450 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
Ë+ ((
addªss
 & (
psize
 - 1)Ë>> 
PAGE_SHIFT
);

451 
˝a
->
p‚
 =Öfn;

453 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

460 
addr
 = 
addªss
 + 
PAGE_SIZE
;

461 
p‚
++;

462 
i
 = 1; i < 
˝a
->
num∑ges
; i++, 
addr
 +
PAGE_SIZE
, 
p‚
++) {

463 
pg¥Ÿ_t
 
chk_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
(
√w_¥Ÿ
, 
addr
, 
p‚
);

465 i‡(
	`pg¥Ÿ_vÆ
(
chk_¥Ÿ
Ë!pg¥Ÿ_vÆ(
√w_¥Ÿ
))

466 
out_u∆ock
;

473 i‡(
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë=pg¥Ÿ_vÆ(
ﬁd_¥Ÿ
)) {

474 
do_•lô
 = 0;

475 
out_u∆ock
;

486 i‡(
addªss
 =(
√xçage_addr
 - 
psize
Ë&& 
˝a
->
num∑ges
 ==Çumpages) {

491 
√w_±e
 = 
	`p‚_±e
(
	`±e_p‚
(
ﬁd_±e
), 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

492 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
√w_±e
);

493 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

494 
do_•lô
 = 0;

497 
out_u∆ock
:

498 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

500  
do_•lô
;

501 
	}
}

503 
	$•lô_œrge_∑ge
(
±e_t
 *
k±e
, 
addªss
)

505 
Êags
, 
p‚
, 
p‚öc
 = 1;

506 
i
, 
Àvñ
;

507 
±e_t
 *
pba£
, *
tmp
;

508 
pg¥Ÿ_t
 
ªf_¥Ÿ
;

509 
∑ge
 *
ba£
;

511 i‡(!
debug_∑góŒoc
)

512 
	`•ö_u∆ock
(&
˝a_lock
);

513 
ba£
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_NOTRACK
, 0);

514 i‡(!
debug_∑góŒoc
)

515 
	`•ö_lock
(&
˝a_lock
);

516 i‡(!
ba£
)

517  -
ENOMEM
;

519 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

524 
tmp
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

525 i‡(
tmp
 !
k±e
)

526 
out_u∆ock
;

528 
pba£
 = (
±e_t
 *)
	`∑ge_addªss
(
ba£
);

529 
	`∑øvút_Æloc_±e
(&
öô_mm
, 
	`∑ge_to_p‚
(
ba£
));

530 
ªf_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
	`±e_˛rhuge
(*
k±e
));

537 
	`WARN_ON_ONCE
(
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë& 
_PAGE_PAT_LARGE
);

539 #ifde‡
CONFIG_X86_64


540 i‡(
Àvñ
 =
PG_LEVEL_1G
) {

541 
p‚öc
 = 
PMD_PAGE_SIZE
 >> 
PAGE_SHIFT
;

542 
	`pg¥Ÿ_vÆ
(
ªf_¥Ÿ
Ë|
_PAGE_PSE
;

549 
p‚
 = 
	`±e_p‚
(*
k±e
);

550 
i
 = 0; i < 
PTRS_PER_PTE
; i++, 
p‚
 +
p‚öc
)

551 
	`£t_±e
(&
pba£
[
i
], 
	`p‚_±e
(
p‚
, 
ªf_¥Ÿ
));

553 i‡(
addªss
 >()
	`__va
(0) &&

554 
addªss
 < ()
	`__va
(
max_low_p‚_m≠≥d
 << 
PAGE_SHIFT
))

555 
	`•lô_∑ge_cou¡
(
Àvñ
);

557 #ifde‡
CONFIG_X86_64


558 i‡(
addªss
 >()
	`__va
(1UL<<32) &&

559 
addªss
 < ()
	`__va
(
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))

560 
	`•lô_∑ge_cou¡
(
Àvñ
);

570 
	`__£t_pmd_±e
(
k±e
, 
addªss
, 
	`mk_±e
(
ba£
, 
	`__pg¥Ÿ
(
_KERNPG_TABLE
)));

580 
	`__Êush_éb_Æl
();

582 
ba£
 = 
NULL
;

584 
out_u∆ock
:

589 i‡(
ba£
)

590 
	`__‰ì_∑ge
(
ba£
);

591 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

594 
	}
}

596 
	$__˝a_¥o˚ss_Áu…
(
˝a_d©a
 *
˝a
, 
vaddr
,

597 
¥im¨y
)

602 i‡(!
¥im¨y
)

612 i‡(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

613 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
))) {

614 
˝a
->
num∑ges
 = 1;

615 
˝a
->
p‚
 = 
	`__∑
(
vaddr
Ë>> 
PAGE_SHIFT
;

618 
	`WARN
(1, 
KERN_WARNING
 "CPA: called for zeroÖte. "

619 "vadd∏%lx c∑->vadd∏%lx\n", 
vaddr
,

620 *
˝a
->
vaddr
);

622  -
EFAULT
;

624 
	}
}

626 
	$__ch™ge_∑ge_©å
(
˝a_d©a
 *
˝a
, 
¥im¨y
)

628 
addªss
;

629 
do_•lô
, 
îr
;

630 
Àvñ
;

631 
±e_t
 *
k±e
, 
ﬁd_±e
;

633 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

634 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

635 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

637 
addªss
 = ()
	`∑ge_addªss
(
∑ge
);

638 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

639 
addªss
 = 
˝a
->
vaddr
[˝a->
cuΩage
];

641 
addªss
 = *
˝a
->
vaddr
;

642 
ª≥©
:

643 
k±e
 = 
	`lookup_addªss
(
addªss
, &
Àvñ
);

644 i‡(!
k±e
)

645  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

647 
ﬁd_±e
 = *
k±e
;

648 i‡(!
	`±e_vÆ
(
ﬁd_±e
))

649  
	`__˝a_¥o˚ss_Áu…
(
˝a
, 
addªss
, 
¥im¨y
);

651 i‡(
Àvñ
 =
PG_LEVEL_4K
) {

652 
±e_t
 
√w_±e
;

653 
pg¥Ÿ_t
 
√w_¥Ÿ
 = 
	`±e_pg¥Ÿ
(
ﬁd_±e
);

654 
p‚
 = 
	`±e_p‚
(
ﬁd_±e
);

656 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë&~pg¥Ÿ_vÆ(
˝a
->
mask_˛r
);

657 
	`pg¥Ÿ_vÆ
(
√w_¥Ÿ
Ë|pg¥Ÿ_vÆ(
˝a
->
mask_£t
);

659 
√w_¥Ÿ
 = 
	`°©ic_¥Ÿe˘i⁄s
“ew_¥Ÿ, 
addªss
, 
p‚
);

666 
√w_±e
 = 
	`p‚_±e
(
p‚
, 
	`ˇn⁄_pg¥Ÿ
(
√w_¥Ÿ
));

667 
˝a
->
p‚
 =Öfn;

671 i‡(
	`±e_vÆ
(
ﬁd_±e
Ë!±e_vÆ(
√w_±e
)) {

672 
	`£t_±e_©omic
(
k±e
, 
√w_±e
);

673 
˝a
->
Êags
 |
CPA_FLUSHTLB
;

675 
˝a
->
num∑ges
 = 1;

683 
do_•lô
 = 
	`åy_¥e£rve_œrge_∑ge
(
k±e
, 
addªss
, 
˝a
);

689 i‡(
do_•lô
 <= 0)

690  
do_•lô
;

695 
îr
 = 
	`•lô_œrge_∑ge
(
k±e
, 
addªss
);

696 i‡(!
îr
) {

715 
	`Êush_éb_Æl
();

716 
ª≥©
;

719  
îr
;

720 
	}
}

722 
__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
);

724 
	$˝a_¥o˚ss_Æüs
(
˝a_d©a
 *
˝a
)

726 
˝a_d©a
 
Æüs_˝a
;

727 
œddr
 = ()
	`__va
(
˝a
->
p‚
 << 
PAGE_SHIFT
);

728 
vaddr
;

729 
ªt
;

731 i‡(
˝a
->
p‚
 >
max_p‚_m≠≥d
)

734 #ifde‡
CONFIG_X86_64


735 i‡(
˝a
->
p‚
 >
max_low_p‚_m≠≥d
 && c∑->p‚ < (1UL<<(32-
PAGE_SHIFT
)))

742 i‡(
˝a
->
Êags
 & 
CPA_PAGES_ARRAY
) {

743 
∑ge
 *∑gê
˝a
->
∑ges
[˝a->
cuΩage
];

744 i‡(
	`u∆ikñy
(
	`PageHighMem
(
∑ge
)))

746 
vaddr
 = ()
	`∑ge_addªss
(
∑ge
);

747 } i‡(
˝a
->
Êags
 & 
CPA_ARRAY
)

748 
vaddr
 = 
˝a
->vaddr[˝a->
cuΩage
];

750 
vaddr
 = *
˝a
->vaddr;

752 i‡(!(
	`wôhö
(
vaddr
, 
PAGE_OFFSET
,

753 
PAGE_OFFSET
 + (
max_p‚_m≠≥d
 << 
PAGE_SHIFT
)))) {

755 
Æüs_˝a
 = *
˝a
;

756 
Æüs_˝a
.
vaddr
 = &
œddr
;

757 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

759 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

760 i‡(
ªt
)

761  
ªt
;

764 #ifde‡
CONFIG_X86_64


770 i‡(!
	`wôhö
(
vaddr
, ()
_ãxt
, 
_brk_íd
) &&

771 
	`wôhö
(
˝a
->
p‚
, 
	`highm≠_°¨t_p‚
(), 
	`highm≠_íd_p‚
())) {

772 
ãmp_˝a_vaddr
 = (
˝a
->
p‚
 << 
PAGE_SHIFT
) +

773 
__START_KERNEL_m≠
 - 
phys_ba£
;

774 
Æüs_˝a
 = *
˝a
;

775 
Æüs_˝a
.
vaddr
 = &
ãmp_˝a_vaddr
;

776 
Æüs_˝a
.
Êags
 &~(
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
);

782 
	`__ch™ge_∑ge_©å_£t_˛r
(&
Æüs_˝a
, 0);

787 
	}
}

789 
	$__ch™ge_∑ge_©å_£t_˛r
(
˝a_d©a
 *
˝a
, 
checkÆüs
)

791 
ªt
, 
num∑ges
 = 
˝a
->numpages;

793 
num∑ges
) {

798 
˝a
->
num∑ges
 =Çumpages;

800 i‡(
˝a
->
Êags
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

801 
˝a
->
num∑ges
 = 1;

803 i‡(!
debug_∑góŒoc
)

804 
	`•ö_lock
(&
˝a_lock
);

805 
ªt
 = 
	`__ch™ge_∑ge_©å
(
˝a
, 
checkÆüs
);

806 i‡(!
debug_∑góŒoc
)

807 
	`•ö_u∆ock
(&
˝a_lock
);

808 i‡(
ªt
)

809  
ªt
;

811 i‡(
checkÆüs
) {

812 
ªt
 = 
	`˝a_¥o˚ss_Æüs
(
˝a
);

813 i‡(
ªt
)

814  
ªt
;

822 
	`BUG_ON
(
˝a
->
num∑ges
 >Çumpages);

823 
num∑ges
 -
˝a
->numpages;

824 i‡(
˝a
->
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
))

825 
˝a
->
cuΩage
++;

827 *
˝a
->
vaddr
 +˝a->
num∑ges
 * 
PAGE_SIZE
;

831 
	}
}

833 
ölöe
 
	$ˇche_©å
(
pg¥Ÿ_t
 
©å
)

835  
	`pg¥Ÿ_vÆ
(
©å
) &

836 (
_PAGE_PAT
 | 
_PAGE_PAT_LARGE
 | 
_PAGE_PWT
 | 
_PAGE_PCD
);

837 
	}
}

839 
	$ch™ge_∑ge_©å_£t_˛r
(*
addr
, 
num∑ges
,

840 
pg¥Ÿ_t
 
mask_£t
,Ög¥Ÿ_à
mask_˛r
,

841 
f‹˚_•lô
, 
ö_Êag
,

842 
∑ge
 **
∑ges
)

844 
˝a_d©a
 
˝a
;

845 
ªt
, 
ˇche
, 
checkÆüs
;

846 
baddr
 = 0;

852 
mask_£t
 = 
	`ˇn⁄_pg¥Ÿ
(mask_set);

853 
mask_˛r
 = 
	`ˇn⁄_pg¥Ÿ
(mask_clr);

854 i‡(!
	`pg¥Ÿ_vÆ
(
mask_£t
Ë&& !pg¥Ÿ_vÆ(
mask_˛r
Ë&& !
f‹˚_•lô
)

858 i‡(
ö_Êag
 & 
CPA_ARRAY
) {

859 
i
;

860 
i
 = 0; i < 
num∑ges
; i++) {

861 i‡(
addr
[
i
] & ~
PAGE_MASK
) {

862 
addr
[
i
] &
PAGE_MASK
;

863 
	`WARN_ON_ONCE
(1);

866 } i‡(!(
ö_Êag
 & 
CPA_PAGES_ARRAY
)) {

871 i‡(*
addr
 & ~
PAGE_MASK
) {

872 *
addr
 &
PAGE_MASK
;

876 
	`WARN_ON_ONCE
(1);

882 
baddr
 = *
addr
;

886 
	`km≠_Êush_unu£d
();

888 
	`vm_unm≠_Æü£s
();

890 
˝a
.
vaddr
 = 
addr
;

891 
˝a
.
∑ges
 =Öages;

892 
˝a
.
num∑ges
 =Çumpages;

893 
˝a
.
mask_£t
 = mask_set;

894 
˝a
.
mask_˛r
 = mask_clr;

895 
˝a
.
Êags
 = 0;

896 
˝a
.
cuΩage
 = 0;

897 
˝a
.
f‹˚_•lô
 = force_split;

899 i‡(
ö_Êag
 & (
CPA_ARRAY
 | 
CPA_PAGES_ARRAY
))

900 
˝a
.
Êags
 |
ö_Êag
;

903 
checkÆüs
 = (
	`pg¥Ÿ_vÆ
(
mask_£t
Ë|Ög¥Ÿ_vÆ(
mask_˛r
)Ë!
_PAGE_NX
;

905 
ªt
 = 
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 
checkÆüs
);

910 i‡(!(
˝a
.
Êags
 & 
CPA_FLUSHTLB
))

911 
out
;

917 
ˇche
 = 
	`ˇche_©å
(
mask_£t
);

925 i‡(!
ªt
 && 
˝u_has_˛Êush
) {

926 i‡(
˝a
.
Êags
 & (
CPA_PAGES_ARRAY
 | 
CPA_ARRAY
)) {

927 
	`˝a_Êush_¨øy
(
addr
, 
num∑ges
, 
ˇche
,

928 
˝a
.
Êags
, 
∑ges
);

930 
	`˝a_Êush_ønge
(
baddr
, 
num∑ges
, 
ˇche
);

932 
	`˝a_Êush_Æl
(
ˇche
);

934 
out
:

935  
ªt
;

936 
	}
}

938 
ölöe
 
	$ch™ge_∑ge_©å_£t
(*
addr
, 
num∑ges
,

939 
pg¥Ÿ_t
 
mask
, 
¨øy
)

941  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

942 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

943 
	}
}

945 
ölöe
 
	$ch™ge_∑ge_©å_˛ór
(*
addr
, 
num∑ges
,

946 
pg¥Ÿ_t
 
mask
, 
¨øy
)

948  
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

949 (
¨øy
 ? 
CPA_ARRAY
 : 0), 
NULL
);

950 
	}
}

952 
ölöe
 
	$˝a_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

953 
pg¥Ÿ_t
 
mask
)

955  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
mask
, 
	`__pg¥Ÿ
(0), 0,

956 
CPA_PAGES_ARRAY
, 
∑ges
);

957 
	}
}

959 
ölöe
 
	$˝a_˛ór_∑ges_¨øy
(
∑ge
 **
∑ges
, 
num∑ges
,

960 
pg¥Ÿ_t
 
mask
)

962  
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
num∑ges
, 
	`__pg¥Ÿ
(0), 
mask
, 0,

963 
CPA_PAGES_ARRAY
, 
∑ges
);

964 
	}
}

966 
	$_£t_mem‹y_uc
(
addr
, 
num∑ges
)

971  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

972 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

973 
	}
}

975 
	$£t_mem‹y_uc
(
addr
, 
num∑ges
)

977 
ªt
;

982 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

983 
_PAGE_CACHE_UC_MINUS
, 
NULL
);

984 i‡(
ªt
)

985 
out_îr
;

987 
ªt
 = 
	`_£t_mem‹y_uc
(
addr
, 
num∑ges
);

988 i‡(
ªt
)

989 
out_‰ì
;

993 
out_‰ì
:

994 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

995 
out_îr
:

996  
ªt
;

997 
	}
}

998 
EXPORT_SYMBOL
(
£t_mem‹y_uc
);

1000 
	$_£t_mem‹y_¨øy
(*
addr
, 
addrö¨øy
,

1001 
√w_ty≥
)

1003 
i
, 
j
;

1004 
ªt
;

1009 
i
 = 0; i < 
addrö¨øy
; i++) {

1010 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
,

1011 
√w_ty≥
, 
NULL
);

1012 i‡(
ªt
)

1013 
out_‰ì
;

1016 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(
addr
, 
addrö¨øy
,

1017 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 1);

1019 i‡(!
ªt
 && 
√w_ty≥
 =
_PAGE_CACHE_WC
)

1020 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(
addr
, 
addrö¨øy
,

1021 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1022 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1023 0, 
CPA_ARRAY
, 
NULL
);

1024 i‡(
ªt
)

1025 
out_‰ì
;

1029 
out_‰ì
:

1030 
j
 = 0; j < 
i
; j++)

1031 
	`‰ì_memty≥
(
	`__∑
(
addr
[
j
]), __∑◊ddr[j]Ë+ 
PAGE_SIZE
);

1033  
ªt
;

1034 
	}
}

1036 
	$£t_mem‹y_¨øy_uc
(*
addr
, 
addrö¨øy
)

1038  
	`_£t_mem‹y_¨øy
(
addr
, 
addrö¨øy
, 
_PAGE_CACHE_UC_MINUS
);

1039 
	}
}

1040 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_uc
);

1042 
	$£t_mem‹y_¨øy_wc
(*
addr
, 
addrö¨øy
)

1044  
	`_£t_mem‹y_¨øy
(
addr
, 
addrö¨øy
, 
_PAGE_CACHE_WC
);

1045 
	}
}

1046 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wc
);

1048 
	$_£t_mem‹y_wc
(
addr
, 
num∑ges
)

1050 
ªt
;

1051 
addr_c›y
 = 
addr
;

1053 
ªt
 = 
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
,

1054 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
), 0);

1055 i‡(!
ªt
) {

1056 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(&
addr_c›y
, 
num∑ges
,

1057 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1058 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1059 0, 0, 
NULL
);

1061  
ªt
;

1062 
	}
}

1064 
	$£t_mem‹y_wc
(
addr
, 
num∑ges
)

1066 
ªt
;

1068 i‡(!
∑t_íabÀd
)

1069  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1071 
ªt
 = 
	`ª£rve_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
,

1072 
_PAGE_CACHE_WC
, 
NULL
);

1073 i‡(
ªt
)

1074 
out_îr
;

1076 
ªt
 = 
	`_£t_mem‹y_wc
(
addr
, 
num∑ges
);

1077 i‡(
ªt
)

1078 
out_‰ì
;

1082 
out_‰ì
:

1083 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1084 
out_îr
:

1085  
ªt
;

1086 
	}
}

1087 
EXPORT_SYMBOL
(
£t_mem‹y_wc
);

1089 
	$_£t_mem‹y_wb
(
addr
, 
num∑ges
)

1091  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
,

1092 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 0);

1093 
	}
}

1095 
	$£t_mem‹y_wb
(
addr
, 
num∑ges
)

1097 
ªt
;

1099 
ªt
 = 
	`_£t_mem‹y_wb
(
addr
, 
num∑ges
);

1100 i‡(
ªt
)

1101  
ªt
;

1103 
	`‰ì_memty≥
(
	`__∑
(
addr
), __∑◊ddrË+ 
num∑ges
 * 
PAGE_SIZE
);

1105 
	}
}

1106 
EXPORT_SYMBOL
(
£t_mem‹y_wb
);

1108 
	$£t_mem‹y_¨øy_wb
(*
addr
, 
addrö¨øy
)

1110 
i
;

1111 
ªt
;

1113 
ªt
 = 
	`ch™ge_∑ge_©å_˛ór
(
addr
, 
addrö¨øy
,

1114 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
), 1);

1115 i‡(
ªt
)

1116  
ªt
;

1118 
i
 = 0; i < 
addrö¨øy
; i++)

1119 
	`‰ì_memty≥
(
	`__∑
(
addr
[
i
]), __∑◊ddr[i]Ë+ 
PAGE_SIZE
);

1122 
	}
}

1123 
EXPORT_SYMBOL
(
£t_mem‹y_¨øy_wb
);

1125 
	$£t_mem‹y_x
(
addr
, 
num∑ges
)

1127 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1130  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1131 
	}
}

1132 
EXPORT_SYMBOL
(
£t_mem‹y_x
);

1134 
	$£t_mem‹y_nx
(
addr
, 
num∑ges
)

1136 i‡(!(
__suµ‹ãd_±e_mask
 & 
_PAGE_NX
))

1139  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_NX
), 0);

1140 
	}
}

1141 
EXPORT_SYMBOL
(
£t_mem‹y_nx
);

1143 
	$£t_mem‹y_ro
(
addr
, 
num∑ges
)

1145  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1146 
	}
}

1147 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_ro
);

1149 
	$£t_mem‹y_rw
(
addr
, 
num∑ges
)

1151  
	`ch™ge_∑ge_©å_£t
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_RW
), 0);

1152 
	}
}

1153 
EXPORT_SYMBOL_GPL
(
£t_mem‹y_rw
);

1155 
	$£t_mem‹y_≈
(
addr
, 
num∑ges
)

1157  
	`ch™ge_∑ge_©å_˛ór
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(
_PAGE_PRESENT
), 0);

1158 
	}
}

1160 
	$£t_mem‹y_4k
(
addr
, 
num∑ges
)

1162  
	`ch™ge_∑ge_©å_£t_˛r
(&
addr
, 
num∑ges
, 
	`__pg¥Ÿ
(0),

1163 
	`__pg¥Ÿ
(0), 1, 0, 
NULL
);

1164 
	}
}

1166 
	$£t_∑ges_uc
(
∑ge
 *∑ge, 
num∑ges
)

1168 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1170  
	`£t_mem‹y_uc
(
addr
, 
num∑ges
);

1171 
	}
}

1172 
EXPORT_SYMBOL
(
£t_∑ges_uc
);

1174 
	$_£t_∑ges_¨øy
(
∑ge
 **
∑ges
, 
addrö¨øy
,

1175 
√w_ty≥
)

1177 
°¨t
;

1178 
íd
;

1179 
i
;

1180 
‰ì_idx
;

1181 
ªt
;

1183 
i
 = 0; i < 
addrö¨øy
; i++) {

1184 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1186 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1187 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1188 i‡(
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
√w_ty≥
, 
NULL
))

1189 
îr_out
;

1192 
ªt
 = 
	`˝a_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1193 
	`__pg¥Ÿ
(
_PAGE_CACHE_UC_MINUS
));

1194 i‡(!
ªt
 && 
√w_ty≥
 =
_PAGE_CACHE_WC
)

1195 
ªt
 = 
	`ch™ge_∑ge_©å_£t_˛r
(
NULL
, 
addrö¨øy
,

1196 
	`__pg¥Ÿ
(
_PAGE_CACHE_WC
),

1197 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
),

1198 0, 
CPA_PAGES_ARRAY
, 
∑ges
);

1199 i‡(
ªt
)

1200 
îr_out
;

1202 
îr_out
:

1203 
‰ì_idx
 = 
i
;

1204 
i
 = 0; i < 
‰ì_idx
; i++) {

1205 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1207 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1208 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1209 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1211  -
EINVAL
;

1212 
	}
}

1214 
	$£t_∑ges_¨øy_uc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1216  
	`_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
, 
_PAGE_CACHE_UC_MINUS
);

1217 
	}
}

1218 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_uc
);

1220 
	$£t_∑ges_¨øy_wc
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1222  
	`_£t_∑ges_¨øy
(
∑ges
, 
addrö¨øy
, 
_PAGE_CACHE_WC
);

1223 
	}
}

1224 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wc
);

1226 
	$£t_∑ges_wb
(
∑ge
 *∑ge, 
num∑ges
)

1228 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1230  
	`£t_mem‹y_wb
(
addr
, 
num∑ges
);

1231 
	}
}

1232 
EXPORT_SYMBOL
(
£t_∑ges_wb
);

1234 
	$£t_∑ges_¨øy_wb
(
∑ge
 **
∑ges
, 
addrö¨øy
)

1236 
ªtvÆ
;

1237 
°¨t
;

1238 
íd
;

1239 
i
;

1241 
ªtvÆ
 = 
	`˝a_˛ór_∑ges_¨øy
(
∑ges
, 
addrö¨øy
,

1242 
	`__pg¥Ÿ
(
_PAGE_CACHE_MASK
));

1243 i‡(
ªtvÆ
)

1244  
ªtvÆ
;

1246 
i
 = 0; i < 
addrö¨øy
; i++) {

1247 i‡(
	`PageHighMem
(
∑ges
[
i
]))

1249 
°¨t
 = 
	`∑ge_to_p‚
(
∑ges
[
i
]Ë<< 
PAGE_SHIFT
;

1250 
íd
 = 
°¨t
 + 
PAGE_SIZE
;

1251 
	`‰ì_memty≥
(
°¨t
, 
íd
);

1255 
	}
}

1256 
EXPORT_SYMBOL
(
£t_∑ges_¨øy_wb
);

1258 
	$£t_∑ges_x
(
∑ge
 *∑ge, 
num∑ges
)

1260 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1262  
	`£t_mem‹y_x
(
addr
, 
num∑ges
);

1263 
	}
}

1264 
EXPORT_SYMBOL
(
£t_∑ges_x
);

1266 
	$£t_∑ges_nx
(
∑ge
 *∑ge, 
num∑ges
)

1268 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1270  
	`£t_mem‹y_nx
(
addr
, 
num∑ges
);

1271 
	}
}

1272 
EXPORT_SYMBOL
(
£t_∑ges_nx
);

1274 
	$£t_∑ges_ro
(
∑ge
 *∑ge, 
num∑ges
)

1276 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1278  
	`£t_mem‹y_ro
(
addr
, 
num∑ges
);

1279 
	}
}

1281 
	$£t_∑ges_rw
(
∑ge
 *∑ge, 
num∑ges
)

1283 
addr
 = ()
	`∑ge_addªss
(
∑ge
);

1285  
	`£t_mem‹y_rw
(
addr
, 
num∑ges
);

1286 
	}
}

1288 #ifde‡
CONFIG_DEBUG_PAGEALLOC


1290 
	$__£t_∑ges_p
(
∑ge
 *∑ge, 
num∑ges
)

1292 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1293 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1294 .
num∑ges
 =Çumpages,

1295 .
mask_£t
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1296 .
mask_˛r
 = 
	`__pg¥Ÿ
(0),

1297 .
Êags
 = 0};

1305  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1306 
	}
}

1308 
	$__£t_∑ges_≈
(
∑ge
 *∑ge, 
num∑ges
)

1310 
ãm∑ddr
 = (Ë
	`∑ge_addªss
(
∑ge
);

1311 
˝a_d©a
 
˝a
 = { .
vaddr
 = &
ãm∑ddr
,

1312 .
num∑ges
 =Çumpages,

1313 .
mask_£t
 = 
	`__pg¥Ÿ
(0),

1314 .
mask_˛r
 = 
	`__pg¥Ÿ
(
_PAGE_PRESENT
 | 
_PAGE_RW
),

1315 .
Êags
 = 0};

1323  
	`__ch™ge_∑ge_©å_£t_˛r
(&
˝a
, 0);

1324 
	}
}

1326 
	$kî√l_m≠_∑ges
(
∑ge
 *∑ge, 
num∑ges
, 
íabÀ
)

1328 i‡(
	`PageHighMem
(
∑ge
))

1330 i‡(!
íabÀ
) {

1331 
	`debug_check_no_locks_‰ìd
(
	`∑ge_addªss
(
∑ge
),

1332 
num∑ges
 * 
PAGE_SIZE
);

1338 i‡(!
debug_∑góŒoc_íabÀd
)

1346 i‡(
íabÀ
)

1347 
	`__£t_∑ges_p
(
∑ge
, 
num∑ges
);

1349 
	`__£t_∑ges_≈
(
∑ge
, 
num∑ges
);

1355 
	`__Êush_éb_Æl
();

1356 
	}
}

1358 #ifde‡
CONFIG_HIBERNATION


1360 
boﬁ
 
	$kî√l_∑ge_¥e£¡
(
∑ge
 *page)

1362 
Àvñ
;

1363 
±e_t
 *
±e
;

1365 i‡(
	`PageHighMem
(
∑ge
))

1366  
Ál£
;

1368 
±e
 = 
	`lookup_addªss
(()
	`∑ge_addªss
(
∑ge
), &
Àvñ
);

1369  (
	`±e_vÆ
(*
±e
Ë& 
_PAGE_PRESENT
);

1370 
	}
}

1380 #ifde‡
CONFIG_CPA_DEBUG


1381 
	~"∑góâr-ã°.c
"

	@/cmpt816/linux/arch/x86/mm/pat.c

10 
	~<löux/£q_fûe.h
>

11 
	~<löux/boŸmem.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/rbåì.h
>

20 
	~<asm/ˇcheÊush.h
>

21 
	~<asm/¥o˚ss‹.h
>

22 
	~<asm/ébÊush.h
>

23 
	~<asm/x86_öô.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/f˙é.h
>

26 
	~<asm/e820.h
>

27 
	~<asm/mår.h
>

28 
	~<asm/∑ge.h
>

29 
	~<asm/m§.h
>

30 
	~<asm/∑t.h
>

31 
	~<asm/io.h
>

33 
	~"∑t_öã∫Æ.h
"

35 #ifde‡
CONFIG_X86_PAT


36 
__ªad_mo°ly
 
	g∑t_íabÀd
 = 1;

38 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

40 
∑t_íabÀd
 = 0;

41 
	`¥ötk
(
KERN_INFO
 "%s\n", 
ªas⁄
);

42 
	}
}

44 
__öô
 
	$n›©
(*
°r
)

46 
	`∑t_dißbÀ
("PAT support disabled.");

48 
	}
}

49 
óæy_∑øm
("n›©", 
n›©
);

51 
ölöe
 
	$∑t_dißbÀ
(c⁄° *
ªas⁄
)

53 ()
ªas⁄
;

54 
	}
}

58 
	g∑t_debug_íabÀ
;

60 
__öô
 
	$∑t_debug_£tup
(*
°r
)

62 
∑t_debug_íabÀ
 = 1;

64 
	}
}

65 
__£tup
("debug∑t", 
∑t_debug_£tup
);

67 
u64
 
__ªad_mo°ly
 
	gboŸ_∑t_°©e
;

70 
	mPAT_UC
 = 0,

71 
	mPAT_WC
 = 1,

72 
	mPAT_WT
 = 4,

73 
	mPAT_WP
 = 5,

74 
	mPAT_WB
 = 6,

75 
	mPAT_UC_MINUS
 = 7,

78 
	#PAT
(
x
, 
y
Ë((
u64
)
PAT_
 ## y << ((x)*8))

	)

80 
	$∑t_öô
()

82 
u64
 
∑t
;

83 
boﬁ
 
boŸ_˝u
 = !
boŸ_∑t_°©e
;

85 i‡(!
∑t_íabÀd
)

88 i‡(!
˝u_has_∑t
) {

89 i‡(!
boŸ_∑t_°©e
) {

90 
	`∑t_dißbÀ
("PATÇot supported by CPU.");

98 
	`¥ötk
(
KERN_ERR
 "PATÉnabled, "

100 
	`BUG
();

117 
∑t
 = 
	`PAT
(0, 
WB
Ë| PAT(1, 
WC
Ë| PAT(2, 
UC_MINUS
Ë| PAT(3, 
UC
) |

118 
	`PAT
(4, 
WB
Ë| PAT(5, 
WC
Ë| PAT(6, 
UC_MINUS
Ë| PAT(7, 
UC
);

121 i‡(!
boŸ_∑t_°©e
)

122 
	`rdm§l
(
MSR_IA32_CR_PAT
, 
boŸ_∑t_°©e
);

124 
	`wrm§l
(
MSR_IA32_CR_PAT
, 
∑t
);

126 i‡(
boŸ_˝u
)

127 
	`¥ötk
(
KERN_INFO
 "x86 PATÉnabled: cpu %d, old 0x%Lx,Çew 0x%Lx\n",

128 
	`smp_¥o˚ss‹_id
(), 
boŸ_∑t_°©e
, 
∑t
);

129 
	}
}

131 #unde‡
PAT


133 
DEFINE_SPINLOCK
(
memty≥_lock
);

142 
	$∑t_x_mår_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
)

148 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WB
) {

149 
u8
 
mår_ty≥
;

151 
mår_ty≥
 = 
	`mår_ty≥_lookup
(
°¨t
, 
íd
);

152 i‡(
mår_ty≥
 !
MTRR_TYPE_WRBACK
)

153  
_PAGE_CACHE_UC_MINUS
;

155  
_PAGE_CACHE_WB
;

158  
ªq_ty≥
;

159 
	}
}

161 
	$∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
)

163 
øm_∑ge
 = 0, 
nŸ_øm∑ge
 = 0;

164 
∑ge_ƒ
;

166 
∑ge_ƒ
 = (
°¨t
 >> 
PAGE_SHIFT
);Öage_ƒ < (
íd
 >> PAGE_SHIFT);

167 ++
∑ge_ƒ
) {

175 i‡(
∑ge_ƒ
 >(
ISA_END_ADDRESS
 >> 
PAGE_SHIFT
) &&

176 
	`∑ge_is_øm
(
∑ge_ƒ
))

177 
øm_∑ge
 = 1;

179 
nŸ_øm∑ge
 = 1;

181 i‡(
øm_∑ge
 =
nŸ_øm∑ge
)

185  
øm_∑ge
;

186 
	}
}

194 
	$ª£rve_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

195 *
√w_ty≥
)

197 
∑ge
 *page;

198 
u64
 
p‚
;

200 i‡(
ªq_ty≥
 =
_PAGE_CACHE_UC
) {

202 
	`WARN_ON_ONCE
(1);

203 
ªq_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

206 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

207 
ty≥
;

209 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

210 
ty≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

211 i‡(
ty≥
 != -1) {

212 
	`¥ötk
(
KERN_INFO
 "reserve_ram_pages_type failed "

214 
°¨t
, 
íd
, 
ty≥
, 
ªq_ty≥
);

215 i‡(
√w_ty≥
)

216 *
√w_ty≥
 = 
ty≥
;

218  -
EBUSY
;

222 i‡(
√w_ty≥
)

223 *
√w_ty≥
 = 
ªq_ty≥
;

225 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

226 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

227 
	`£t_∑ge_memty≥
(
∑ge
, 
ªq_ty≥
);

230 
	}
}

232 
	$‰ì_øm_∑ges_ty≥
(
u64
 
°¨t
, u64 
íd
)

234 
∑ge
 *page;

235 
u64
 
p‚
;

237 
p‚
 = (
°¨t
 >> 
PAGE_SHIFT
);Ö‚ < (
íd
 >> PAGE_SHIFT); ++pfn) {

238 
∑ge
 = 
	`p‚_to_∑ge
(
p‚
);

239 
	`£t_∑ge_memty≥
(
∑ge
, -1);

242 
	}
}

256 
	$ª£rve_memty≥
(
u64
 
°¨t
, u64 
íd
, 
ªq_ty≥
,

257 *
√w_ty≥
)

259 
memty≥
 *
√w
;

260 
a˘uÆ_ty≥
;

261 
is_ønge_øm
;

262 
îr
 = 0;

264 
	`BUG_ON
(
°¨t
 >
íd
);

266 i‡(!
∑t_íabÀd
) {

268 i‡(
√w_ty≥
) {

269 i‡(
ªq_ty≥
 =
_PAGE_CACHE_WC
)

270 *
√w_ty≥
 = 
_PAGE_CACHE_UC_MINUS
;

272 *
√w_ty≥
 = 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
;

278 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
)) {

279 i‡(
√w_ty≥
)

280 *
√w_ty≥
 = 
_PAGE_CACHE_WB
;

290 
a˘uÆ_ty≥
 = 
	`∑t_x_mår_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
 & 
_PAGE_CACHE_MASK
);

292 i‡(
√w_ty≥
)

293 *
√w_ty≥
 = 
a˘uÆ_ty≥
;

295 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

296 i‡(
is_ønge_øm
 == 1) {

298 
îr
 = 
	`ª£rve_øm_∑ges_ty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, 
√w_ty≥
);

300  
îr
;

301 } i‡(
is_ønge_øm
 < 0) {

302  -
EINVAL
;

305 
√w
 = 
	`kzÆloc
((
memty≥
), 
GFP_KERNEL
);

306 i‡(!
√w
)

307  -
ENOMEM
;

309 
√w
->
°¨t
 = start;

310 
√w
->
íd
 =Énd;

311 
√w
->
ty≥
 = 
a˘uÆ_ty≥
;

313 
	`•ö_lock
(&
memty≥_lock
);

315 
îr
 = 
	`rbt_memty≥_check_ö£π
(
√w
, 
√w_ty≥
);

316 i‡(
îr
) {

317 
	`¥ötk
(
KERN_INFO
 "reserve_memtype failed 0x%Lx-0x%Lx, "

319 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
));

320 
	`k‰ì
(
√w
);

321 
	`•ö_u∆ock
(&
memty≥_lock
);

323  
îr
;

326 
	`•ö_u∆ock
(&
memty≥_lock
);

328 
	`d¥ötk
("reserve_memtypeádded 0x%Lx-0x%Lx,Årack %s,Ñeq %s,Ñet %s\n",

329 
°¨t
, 
íd
, 
	`ˇâr_«me
(
√w
->
ty≥
), c©å_«me(
ªq_ty≥
),

330 
√w_ty≥
 ? 
	`ˇâr_«me
(*new_type) : "-");

332  
îr
;

333 
	}
}

335 
	$‰ì_memty≥
(
u64
 
°¨t
, u64 
íd
)

337 
îr
 = -
EINVAL
;

338 
is_ønge_øm
;

339 
memty≥
 *
íåy
;

341 i‡(!
∑t_íabÀd
)

345 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
°¨t
, 
íd
))

348 
is_ønge_øm
 = 
	`∑t_∑gî™ge_is_øm
(
°¨t
, 
íd
);

349 i‡(
is_ønge_øm
 == 1) {

351 
îr
 = 
	`‰ì_øm_∑ges_ty≥
(
°¨t
, 
íd
);

353  
îr
;

354 } i‡(
is_ønge_øm
 < 0) {

355  -
EINVAL
;

358 
	`•ö_lock
(&
memty≥_lock
);

359 
íåy
 = 
	`rbt_memty≥_îa£
(
°¨t
, 
íd
);

360 
	`•ö_u∆ock
(&
memty≥_lock
);

362 i‡(!
íåy
) {

363 
	`¥ötk
(
KERN_INFO
 "%s:%d freeing invalid memtype %Lx-%Lx\n",

364 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
, 
íd
);

365  -
EINVAL
;

368 
	`k‰ì
(
íåy
);

370 
	`d¥ötk
("‰ì_memty≥Ñeque° 0x%Lx-0x%Lx\n", 
°¨t
, 
íd
);

373 
	}
}

385 
	$lookup_memty≥
(
u64
 
∑ddr
)

387 
ªây≥
 = 
_PAGE_CACHE_WB
;

388 
memty≥
 *
íåy
;

390 i‡(
x86_∂©f‹m
.
	`is_u¡øcked_∑t_ønge
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
))

391  
ªây≥
;

393 i‡(
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
PAGE_SIZE
)) {

394 
∑ge
 *page;

395 
∑ge
 = 
	`p‚_to_∑ge
(
∑ddr
 >> 
PAGE_SHIFT
);

396 
ªây≥
 = 
	`gë_∑ge_memty≥
(
∑ge
);

401 i‡(
ªây≥
 == -1)

402 
ªây≥
 = 
_PAGE_CACHE_WB
;

404  
ªây≥
;

407 
	`•ö_lock
(&
memty≥_lock
);

409 
íåy
 = 
	`rbt_memty≥_lookup
(
∑ddr
);

410 i‡(
íåy
 !
NULL
)

411 
ªây≥
 = 
íåy
->
ty≥
;

413 
ªây≥
 = 
_PAGE_CACHE_UC_MINUS
;

415 
	`•ö_u∆ock
(&
memty≥_lock
);

416  
ªây≥
;

417 
	}
}

429 
	$io_ª£rve_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
,

430 *
ty≥
)

432 
ªsour˚_size_t
 
size
 = 
íd
 - 
°¨t
;

433 
ªq_ty≥
 = *
ty≥
;

434 
√w_ty≥
;

435 
ªt
;

437 
	`WARN_ON_ONCE
(
	`iomem_m≠_ßnôy_check
(
°¨t
, 
size
));

439 
ªt
 = 
	`ª£rve_memty≥
(
°¨t
, 
íd
, 
ªq_ty≥
, &
√w_ty≥
);

440 i‡(
ªt
)

441 
out_îr
;

443 i‡(!
	`is_√w_memty≥_Ælowed
(
°¨t
, 
size
, 
ªq_ty≥
, 
√w_ty≥
))

444 
out_‰ì
;

446 i‡(
	`kî√l_m≠_sync_memty≥
(
°¨t
, 
size
, 
√w_ty≥
) < 0)

447 
out_‰ì
;

449 *
ty≥
 = 
√w_ty≥
;

452 
out_‰ì
:

453 
	`‰ì_memty≥
(
°¨t
, 
íd
);

454 
ªt
 = -
EBUSY
;

455 
out_îr
:

456  
ªt
;

457 
	}
}

464 
	$io_‰ì_memty≥
(
ªsour˚_size_t
 
°¨t
,Ñesour˚_size_à
íd
)

466 
	`‰ì_memty≥
(
°¨t
, 
íd
);

467 
	}
}

469 
pg¥Ÿ_t
 
	$phys_mem_ac˚ss_¥Ÿ
(
fûe
 *fûe, 
p‚
,

470 
size
, 
pg¥Ÿ_t
 
vma_¥Ÿ
)

472  
vma_¥Ÿ
;

473 
	}
}

475 #ifde‡
CONFIG_STRICT_DEVMEM


477 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

480 
	}
}

483 
ölöe
 
	$ønge_is_Ælowed
(
p‚
, 
size
)

485 
u64
 
‰om
 = ((u64)
p‚
Ë<< 
PAGE_SHIFT
;

486 
u64
 
to
 = 
‰om
 + 
size
;

487 
u64
 
curs‹
 = 
‰om
;

489 i‡(!
∑t_íabÀd
)

492 
curs‹
 < 
to
) {

493 i‡(!
	`devmem_is_Ælowed
(
p‚
)) {

494 
	`¥ötk
(
KERN_INFO


496 
cuºít
->
comm
, 
‰om
, 
to
);

499 
curs‹
 +
PAGE_SIZE
;

500 
p‚
++;

503 
	}
}

506 
	$phys_mem_ac˚ss_¥Ÿ_Ælowed
(
fûe
 *fûe, 
p‚
,

507 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
)

509 
Êags
 = 
_PAGE_CACHE_WB
;

511 i‡(!
	`ønge_is_Ælowed
(
p‚
, 
size
))

514 i‡(
fûe
->
f_Êags
 & 
O_DSYNC
)

515 
Êags
 = 
_PAGE_CACHE_UC_MINUS
;

517 #ifde‡
CONFIG_X86_32


526 i‡(!
∑t_íabÀd
 &&

527 !(
	`boŸ_˝u_has
(
X86_FEATURE_MTRR
) ||

528 
	`boŸ_˝u_has
(
X86_FEATURE_K6_MTRR
) ||

529 
	`boŸ_˝u_has
(
X86_FEATURE_CYRIX_ARR
) ||

530 
	`boŸ_˝u_has
(
X86_FEATURE_CENTAUR_MCR
)) &&

531 (
p‚
 << 
PAGE_SHIFT
Ë>
	`__∑
(
high_mem‹y
)) {

532 
Êags
 = 
_PAGE_CACHE_UC
;

536 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_¥ŸË& ~
_PAGE_CACHE_MASK
) |

537 
Êags
);

539 
	}
}

545 
	$kî√l_m≠_sync_memty≥
(
u64
 
ba£
, 
size
, 
Êags
)

547 
id_sz
;

549 i‡(
ba£
 >
	`__∑
(
high_mem‹y
))

552 
id_sz
 = (
	`__∑
(
high_mem‹y
Ë< 
ba£
 + 
size
) ?

553 
	`__∑
(
high_mem‹y
Ë- 
ba£
 :

554 
size
;

556 i‡(
	`i‹em≠_ch™ge_©å
(()
	`__va
(
ba£
), 
id_sz
, 
Êags
) < 0) {

557 
	`¥ötk
(
KERN_INFO


560 
cuºít
->
comm
, cuºít->
pid
,

561 
	`ˇâr_«me
(
Êags
),

562 
ba£
, ()(ba£ + 
size
));

563  -
EINVAL
;

566 
	}
}

573 
	$ª£rve_p‚_ønge
(
u64
 
∑ddr
, 
size
, 
pg¥Ÿ_t
 *
vma_¥Ÿ
,

574 
°ri˘_¥Ÿ
)

576 
is_øm
 = 0;

577 
ªt
;

578 
w™t_Êags
 = (
	`pg¥Ÿ_vÆ
(*
vma_¥Ÿ
Ë& 
_PAGE_CACHE_MASK
);

579 
Êags
 = 
w™t_Êags
;

581 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

588 i‡(
is_øm
) {

589 i‡(!
∑t_íabÀd
)

592 
Êags
 = 
	`lookup_memty≥
(
∑ddr
);

593 i‡(
w™t_Êags
 !
Êags
) {

594 
	`¥ötk
(
KERN_WARNING


596 
cuºít
->
comm
, cuºít->
pid
,

597 
	`ˇâr_«me
(
w™t_Êags
),

598 ()
∑ddr
,

599 ()(
∑ddr
 + 
size
),

600 
	`ˇâr_«me
(
Êags
));

601 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

602 (~
_PAGE_CACHE_MASK
)) |

603 
Êags
);

608 
ªt
 = 
	`ª£rve_memty≥
(
∑ddr
,Öadd∏+ 
size
, 
w™t_Êags
, &
Êags
);

609 i‡(
ªt
)

610  
ªt
;

612 i‡(
Êags
 !
w™t_Êags
) {

613 i‡(
°ri˘_¥Ÿ
 ||

614 !
	`is_√w_memty≥_Ælowed
(
∑ddr
, 
size
, 
w™t_Êags
, 
Êags
)) {

615 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

616 
	`¥ötk
(
KERN_ERR
 "%s:%d mapÖfnÉxpected mappingÅype %s"

618 
cuºít
->
comm
, cuºít->
pid
,

619 
	`ˇâr_«me
(
w™t_Êags
),

620 ()
∑ddr
,

621 ()(
∑ddr
 + 
size
),

622 
	`ˇâr_«me
(
Êags
));

623  -
EINVAL
;

629 *
vma_¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(*vma_prot) &

630 (~
_PAGE_CACHE_MASK
)) |

631 
Êags
);

634 i‡(
	`kî√l_m≠_sync_memty≥
(
∑ddr
, 
size
, 
Êags
) < 0) {

635 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

636  -
EINVAL
;

639 
	}
}

645 
	$‰ì_p‚_ønge
(
u64
 
∑ddr
, 
size
)

647 
is_øm
;

649 
is_øm
 = 
	`∑t_∑gî™ge_is_øm
(
∑ddr
,Öadd∏+ 
size
);

650 i‡(
is_øm
 == 0)

651 
	`‰ì_memty≥
(
∑ddr
,Öadd∏+ 
size
);

652 
	}
}

661 
	$åack_p‚_vma_c›y
(
vm_¨ó_°ru˘
 *
vma
)

663 
ªsour˚_size_t
 
∑ddr
;

664 
¥Ÿ
;

665 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

666 
pg¥Ÿ_t
 
pg¥Ÿ
;

668 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

673 i‡(
	`fﬁlow_phys
(
vma
, vma->
vm_°¨t
, 0, &
¥Ÿ
, &
∑ddr
)) {

674 
	`WARN_ON_ONCE
(1);

675  -
EINVAL
;

677 
pg¥Ÿ
 = 
	`__pg¥Ÿ
(
¥Ÿ
);

678  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, &
pg¥Ÿ
, 1);

682 
	}
}

692 
	$åack_p‚_vma_√w
(
vm_¨ó_°ru˘
 *
vma
, 
pg¥Ÿ_t
 *
¥Ÿ
,

693 
p‚
, 
size
)

695 
Êags
;

696 
ªsour˚_size_t
 
∑ddr
;

697 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

699 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

701 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

702  
	`ª£rve_p‚_ønge
(
∑ddr
, 
vma_size
, 
¥Ÿ
, 0);

705 i‡(!
∑t_íabÀd
)

709 
Êags
 = 
	`lookup_memty≥
(
p‚
 << 
PAGE_SHIFT
);

710 *
¥Ÿ
 = 
	`__pg¥Ÿ
((
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
Ë& (~
_PAGE_CACHE_MASK
)) |

711 
Êags
);

714 
	}
}

721 
	$u¡øck_p‚_vma
(
vm_¨ó_°ru˘
 *
vma
, 
p‚
,

722 
size
)

724 
ªsour˚_size_t
 
∑ddr
;

725 
vma_size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

727 i‡(
	`is_löór_p‚_m≠pög
(
vma
)) {

729 
∑ddr
 = (
ªsour˚_size_t
)
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

730 
	`‰ì_p‚_ønge
(
∑ddr
, 
vma_size
);

733 
	}
}

735 
pg¥Ÿ_t
 
	$pg¥Ÿ_wrôecomböe
(
pg¥Ÿ_t
 
¥Ÿ
)

737 i‡(
∑t_íabÀd
)

738  
	`__pg¥Ÿ
(
	`pg¥Ÿ_vÆ
(
¥Ÿ
Ë| 
_PAGE_CACHE_WC
);

740  
	`pg¥Ÿ_n⁄ˇched
(
¥Ÿ
);

741 
	}
}

742 
EXPORT_SYMBOL_GPL
(
pg¥Ÿ_wrôecomböe
);

744 #i‡
deföed
(
CONFIG_DEBUG_FS
Ë&& deföed(
CONFIG_X86_PAT
)

746 
memty≥
 *
	$memty≥_gë_idx
(
loff_t
 
pos
)

748 
memty≥
 *
¥öt_íåy
;

749 
ªt
;

751 
¥öt_íåy
 = 
	`kzÆloc
((
memty≥
), 
GFP_KERNEL
);

752 i‡(!
¥öt_íåy
)

753  
NULL
;

755 
	`•ö_lock
(&
memty≥_lock
);

756 
ªt
 = 
	`rbt_memty≥_c›y_¡h_ñemít
(
¥öt_íåy
, 
pos
);

757 
	`•ö_u∆ock
(&
memty≥_lock
);

759 i‡(!
ªt
) {

760  
¥öt_íåy
;

762 
	`k‰ì
(
¥öt_íåy
);

763  
NULL
;

765 
	}
}

767 *
	$memty≥_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

769 i‡(*
pos
 == 0) {

770 ++*
pos
;

771 
	`£q_¥ötf
(
£q
, "PAT memtypeÜist:\n");

774  
	`memty≥_gë_idx
(*
pos
);

775 
	}
}

777 *
	$memty≥_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

779 ++*
pos
;

780  
	`memty≥_gë_idx
(*
pos
);

781 
	}
}

783 
	$memty≥_£q_°›
(
£q_fûe
 *
£q
, *
v
)

785 
	}
}

787 
	$memty≥_£q_show
(
£q_fûe
 *
£q
, *
v
)

789 
memty≥
 *
¥öt_íåy
 = (memty≥ *)
v
;

791 
	`£q_¥ötf
(
£q
, "%†@ 0x%Lx-0x%Lx\n", 
	`ˇâr_«me
(
¥öt_íåy
->
ty≥
),

792 
¥öt_íåy
->
°¨t
,Öröt_íåy->
íd
);

793 
	`k‰ì
(
¥öt_íåy
);

796 
	}
}

798 c⁄° 
£q_›î©i⁄s
 
	gmemty≥_£q_›s
 = {

799 .
°¨t
 = 
memty≥_£q_°¨t
,

800 .
	g√xt
 = 
memty≥_£q_√xt
,

801 .
	g°›
 = 
memty≥_£q_°›
,

802 .
	gshow
 = 
memty≥_£q_show
,

805 
	$memty≥_£q_›í
(
öode
 *öode, 
fûe
 *file)

807  
	`£q_›í
(
fûe
, &
memty≥_£q_›s
);

808 
	}
}

810 c⁄° 
fûe_›î©i⁄s
 
	gmemty≥_f›s
 = {

811 .
›í
 = 
memty≥_£q_›í
,

812 .
	gªad
 = 
£q_ªad
,

813 .
	gŒ£ek
 = 
£q_l£ek
,

814 .
	gªÀa£
 = 
£q_ªÀa£
,

817 
__öô
 
	$∑t_memty≥_li°_öô
()

819 i‡(
∑t_íabÀd
) {

820 
	`debugfs_¸óã_fûe
("∑t_memty≥_li°", 
S_IRUSR
,

821 
¨ch_debugfs_dú
, 
NULL
, &
memty≥_f›s
);

824 
	}
}

826 
œã_öôˇŒ
(
∑t_memty≥_li°_öô
);

	@/cmpt816/linux/arch/x86/mm/pat_rbtree.c

11 
	~<löux/£q_fûe.h
>

12 
	~<löux/debugfs.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/rbåì.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/gÂ.h
>

19 
	~<asm/pgèbÀ.h
>

20 
	~<asm/∑t.h
>

22 
	~"∑t_öã∫Æ.h
"

37 
rb_roŸ
 
	gmemty≥_rbroŸ
 = 
RB_ROOT
;

39 
	$is_node_ovîœp
(
memty≥
 *
node
, 
u64
 
°¨t
, u64 
íd
)

41 i‡(
node
->
°¨t
 >
íd
 ||Çode->end <= start)

45 
	}
}

47 
u64
 
	$gë_subåì_max_íd
(
rb_node
 *
node
)

49 
u64
 
ªt
 = 0;

50 i‡(
node
) {

51 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

52 
ªt
 = 
d©a
->
subåì_max_íd
;

54  
ªt
;

55 
	}
}

58 
	$memty≥_rb_augmít_cb
(
rb_node
 *
node
, *
__unu£d
)

60 
memty≥
 *
d©a
;

61 
u64
 
max_íd
, 
chûd_max_íd
;

63 i‡(!
node
)

66 
d©a
 = 
	`c⁄èöî_of
(
node
, 
memty≥
, 
rb
);

67 
max_íd
 = 
d©a
->
íd
;

69 
chûd_max_íd
 = 
	`gë_subåì_max_íd
(
node
->
rb_right
);

70 i‡(
chûd_max_íd
 > 
max_íd
)

71 
max_íd
 = 
chûd_max_íd
;

73 
chûd_max_íd
 = 
	`gë_subåì_max_íd
(
node
->
rb_À·
);

74 i‡(
chûd_max_íd
 > 
max_íd
)

75 
max_íd
 = 
chûd_max_íd
;

77 
d©a
->
subåì_max_íd
 = 
max_íd
;

78 
	}
}

81 
memty≥
 *
	$memty≥_rb_lowe°_m©ch
(
rb_roŸ
 *
roŸ
,

82 
u64
 
°¨t
, u64 
íd
)

84 
rb_node
 *
node
 = 
roŸ
->rb_node;

85 
memty≥
 *
œ°_lowî
 = 
NULL
;

87 
node
) {

88 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

90 i‡(
	`gë_subåì_max_íd
(
node
->
rb_À·
Ë> 
°¨t
) {

92 
node
 =Çode->
rb_À·
;

93 } i‡(
	`is_node_ovîœp
(
d©a
, 
°¨t
, 
íd
)) {

94 
œ°_lowî
 = 
d©a
;

96 } i‡(
°¨t
 >
d©a
->start) {

98 
node
 =Çode->
rb_right
;

103  
œ°_lowî
;

104 
	}
}

106 
memty≥
 *
	$memty≥_rb_exa˘_m©ch
(
rb_roŸ
 *
roŸ
,

107 
u64
 
°¨t
, u64 
íd
)

109 
memty≥
 *
m©ch
;

111 
m©ch
 = 
	`memty≥_rb_lowe°_m©ch
(
roŸ
, 
°¨t
, 
íd
);

112 
m©ch
 !
NULL
 && m©ch->
°¨t
 < 
íd
) {

113 
rb_node
 *
node
;

115 i‡(
m©ch
->
°¨t
 =°¨à&& m©ch->
íd
 ==Énd)

116  
m©ch
;

118 
node
 = 
	`rb_√xt
(&
m©ch
->
rb
);

119 i‡(
node
)

120 
m©ch
 = 
	`c⁄èöî_of
(
node
, 
memty≥
, 
rb
);

122 
m©ch
 = 
NULL
;

125  
NULL
;

126 
	}
}

128 
	$memty≥_rb_check_c⁄Êi˘
(
rb_roŸ
 *
roŸ
,

129 
u64
 
°¨t
, u64 
íd
,

130 
ªqty≥
, *
√wty≥
)

132 
rb_node
 *
node
;

133 
memty≥
 *
m©ch
;

134 
found_ty≥
 = 
ªqty≥
;

136 
m©ch
 = 
	`memty≥_rb_lowe°_m©ch
(&
memty≥_rbroŸ
, 
°¨t
, 
íd
);

137 i‡(
m©ch
 =
NULL
)

138 
suc˚ss
;

140 i‡(
m©ch
->
ty≥
 !
found_ty≥
 && 
√wty≥
 =
NULL
)

141 
Áûuª
;

143 
	`d¥ötk
("Ovîœ∞© 0x%Lx-0x%Lx\n", 
m©ch
->
°¨t
, m©ch->
íd
);

144 
found_ty≥
 = 
m©ch
->
ty≥
;

146 
node
 = 
	`rb_√xt
(&
m©ch
->
rb
);

147 
node
) {

148 
m©ch
 = 
	`c⁄èöî_of
(
node
, 
memty≥
, 
rb
);

150 i‡(
m©ch
->
°¨t
 >
íd
)

151 
suc˚ss
;

153 i‡(
	`is_node_ovîœp
(
m©ch
, 
°¨t
, 
íd
) &&

154 
m©ch
->
ty≥
 !
found_ty≥
) {

155 
Áûuª
;

158 
node
 = 
	`rb_√xt
(&
m©ch
->
rb
);

160 
suc˚ss
:

161 i‡(
√wty≥
)

162 *
√wty≥
 = 
found_ty≥
;

166 
Áûuª
:

167 
	`¥ötk
(
KERN_INFO
 "%s:%d conflicting memoryÅypes "

168 "%Lx-%Lx %s<->%s\n", 
cuºít
->
comm
, cuºít->
pid
, 
°¨t
,

169 
íd
, 
	`ˇâr_«me
(
found_ty≥
), c©å_«me(
m©ch
->
ty≥
));

170  -
EBUSY
;

171 
	}
}

173 
	$memty≥_rb_ö£π
(
rb_roŸ
 *
roŸ
, 
memty≥
 *
√wd©a
)

175 
rb_node
 **
node
 = &(
roŸ
->rb_node);

176 
rb_node
 *
∑ª¡
 = 
NULL
;

178 *
node
) {

179 
memty≥
 *
d©a
 = 
	`c⁄èöî_of
(*
node
, memty≥, 
rb
);

181 
∑ª¡
 = *
node
;

182 i‡(
√wd©a
->
°¨t
 <
d©a
->start)

183 
node
 = &((*node)->
rb_À·
);

184 i‡(
√wd©a
->
°¨t
 > 
d©a
->start)

185 
node
 = &((*node)->
rb_right
);

188 
	`rb_lök_node
(&
√wd©a
->
rb
, 
∑ª¡
, 
node
);

189 
	`rb_ö£π_cﬁ‹
(&
√wd©a
->
rb
, 
roŸ
);

190 
	`rb_augmít_ö£π
(&
√wd©a
->
rb
, 
memty≥_rb_augmít_cb
, 
NULL
);

191 
	}
}

193 
	$rbt_memty≥_check_ö£π
(
memty≥
 *
√w
, *
ªt_ty≥
)

195 
îr
 = 0;

197 
îr
 = 
	`memty≥_rb_check_c⁄Êi˘
(&
memty≥_rbroŸ
, 
√w
->
°¨t
,Çew->
íd
,

198 
√w
->
ty≥
, 
ªt_ty≥
);

200 i‡(!
îr
) {

201 i‡(
ªt_ty≥
)

202 
√w
->
ty≥
 = *
ªt_ty≥
;

204 
√w
->
subåì_max_íd
 =Çew->
íd
;

205 
	`memty≥_rb_ö£π
(&
memty≥_rbroŸ
, 
√w
);

207  
îr
;

208 
	}
}

210 
memty≥
 *
	$rbt_memty≥_îa£
(
u64
 
°¨t
, u64 
íd
)

212 
rb_node
 *
dì≥°
;

213 
memty≥
 *
d©a
;

215 
d©a
 = 
	`memty≥_rb_exa˘_m©ch
(&
memty≥_rbroŸ
, 
°¨t
, 
íd
);

216 i‡(!
d©a
)

217 
out
;

219 
dì≥°
 = 
	`rb_augmít_îa£_begö
(&
d©a
->
rb
);

220 
	`rb_îa£
(&
d©a
->
rb
, &
memty≥_rbroŸ
);

221 
	`rb_augmít_îa£_íd
(
dì≥°
, 
memty≥_rb_augmít_cb
, 
NULL
);

222 
out
:

223  
d©a
;

224 
	}
}

226 
memty≥
 *
	$rbt_memty≥_lookup
(
u64
 
addr
)

228 
memty≥
 *
d©a
;

229 
d©a
 = 
	`memty≥_rb_lowe°_m©ch
(&
memty≥_rbroŸ
, 
addr
,ádd∏+ 
PAGE_SIZE
);

230  
d©a
;

231 
	}
}

233 #i‡
deföed
(
CONFIG_DEBUG_FS
)

234 
	$rbt_memty≥_c›y_¡h_ñemít
(
memty≥
 *
out
, 
loff_t
 
pos
)

236 
rb_node
 *
node
;

237 
i
 = 1;

239 
node
 = 
	`rb_fú°
(&
memty≥_rbroŸ
);

240 
node
 && 
pos
 !
i
) {

241 
node
 = 
	`rb_√xt
(node);

242 
i
++;

245 i‡(
node
) {

246 
memty≥
 *
this
 = 
	`c⁄èöî_of
(
node
, memty≥, 
rb
);

247 *
out
 = *
this
;

252 
	}
}

	@/cmpt816/linux/arch/x86/mm/pgtable.c

1 
	~<löux/mm.h
>

2 
	~<löux/gÂ.h
>

3 
	~<asm/pgÆloc.h
>

4 
	~<asm/pgèbÀ.h
>

5 
	~<asm/éb.h
>

6 
	~<asm/fixm≠.h
>

8 
	#PGALLOC_GFP
 
GFP_KERNEL
 | 
__GFP_NOTRACK
 | 
__GFP_REPEAT
 | 
__GFP_ZERO


	)

10 #ifde‡
CONFIG_HIGHPTE


11 
	#PGALLOC_USER_GFP
 
__GFP_HIGHMEM


	)

13 
	#PGALLOC_USER_GFP
 0

	)

16 
gÂ_t
 
	g__u£Ωã_Æloc_gÂ
 = 
PGALLOC_GFP
 | 
PGALLOC_USER_GFP
;

18 
±e_t
 *
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

20  (
±e_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

21 
	}
}

23 
pgèbÀ_t
 
	$±e_Æloc_⁄e
(
mm_°ru˘
 *
mm
, 
addªss
)

25 
∑ge
 *
±e
;

27 
±e
 = 
	`Æloc_∑ges
(
__u£Ωã_Æloc_gÂ
, 0);

28 i‡(
±e
)

29 
	`pgèbÀ_∑ge_˘‹
(
±e
);

30  
±e
;

31 
	}
}

33 
__öô
 
	$£tup_u£Ωã
(*
¨g
)

35 i‡(!
¨g
)

36  -
EINVAL
;

42 i‡(
	`°rcmp
(
¨g
, "nohigh") == 0)

43 
__u£Ωã_Æloc_gÂ
 &~
__GFP_HIGHMEM
;

45  -
EINVAL
;

47 
	}
}

48 
óæy_∑øm
("u£Ωã", 
£tup_u£Ωã
);

50 
	$___±e_‰ì_éb
(
mmu_g©hî
 *
éb
, 
∑ge
 *
±e
)

52 
	`pgèbÀ_∑ge_dt‹
(
±e
);

53 
	`∑øvút_ªÀa£_±e
(
	`∑ge_to_p‚
(
±e
));

54 
	`éb_ªmove_∑ge
(
éb
, 
±e
);

55 
	}
}

57 #i‡
PAGETABLE_LEVELS
 > 2

58 
	$___pmd_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pmd_t
 *
pmd
)

60 
	`∑øvút_ªÀa£_pmd
(
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

61 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pmd
));

62 
	}
}

64 #i‡
PAGETABLE_LEVELS
 > 3

65 
	$___pud_‰ì_éb
(
mmu_g©hî
 *
éb
, 
pud_t
 *
pud
)

67 
	`∑øvút_ªÀa£_pud
(
	`__∑
(
pud
Ë>> 
PAGE_SHIFT
);

68 
	`éb_ªmove_∑ge
(
éb
, 
	`vút_to_∑ge
(
pud
));

69 
	}
}

73 
ölöe
 
	$pgd_li°_add
(
pgd_t
 *
pgd
)

75 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

77 
	`li°_add
(&
∑ge
->
Ãu
, &
pgd_li°
);

78 
	}
}

80 
ölöe
 
	$pgd_li°_dñ
(
pgd_t
 *
pgd
)

82 
∑ge
 *∑gê
	`vút_to_∑ge
(
pgd
);

84 
	`li°_dñ
(&
∑ge
->
Ãu
);

85 
	}
}

87 
	#UNSHARED_PTRS_PER_PGD
 \

88 (
SHARED_KERNEL_PMD
 ? 
KERNEL_PGD_BOUNDARY
 : 
PTRS_PER_PGD
)

	)

90 
	$pgd_˘‹
(
pgd_t
 *
pgd
)

95 i‡(
PAGETABLE_LEVELS
 == 2 ||

96 (
PAGETABLE_LEVELS
 =3 && 
SHARED_KERNEL_PMD
) ||

97 
PAGETABLE_LEVELS
 == 4) {

98 
	`˛⁄e_pgd_ønge
(
pgd
 + 
KERNEL_PGD_BOUNDARY
,

99 
sw≠≥r_pg_dú
 + 
KERNEL_PGD_BOUNDARY
,

100 
KERNEL_PGD_PTRS
);

101 
	`∑øvút_Æloc_pmd_˛⁄e
(
	`__∑
(
pgd
Ë>> 
PAGE_SHIFT
,

102 
	`__∑
(
sw≠≥r_pg_dú
Ë>> 
PAGE_SHIFT
,

103 
KERNEL_PGD_BOUNDARY
,

104 
KERNEL_PGD_PTRS
);

108 i‡(!
SHARED_KERNEL_PMD
)

109 
	`pgd_li°_add
(
pgd
);

110 
	}
}

112 
	$pgd_dt‹
(
pgd_t
 *
pgd
)

114 
Êags
;

116 i‡(
SHARED_KERNEL_PMD
)

119 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

120 
	`pgd_li°_dñ
(
pgd
);

121 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

122 
	}
}

135 #ifde‡
CONFIG_X86_PAE


147 
	#PREALLOCATED_PMDS
 
UNSHARED_PTRS_PER_PGD


	)

149 
	$pud_p›uœã
(
mm_°ru˘
 *
mm
, 
pud_t
 *
pudp
, 
pmd_t
 *
pmd
)

151 
	`∑øvút_Æloc_pmd
(
mm
, 
	`__∑
(
pmd
Ë>> 
PAGE_SHIFT
);

155 
	`£t_pud
(
pudp
, 
	`__pud
(
	`__∑
(
pmd
Ë| 
_PAGE_PRESENT
));

163 i‡(
mm
 =
cuºít
->
a˘ive_mm
)

164 
	`wrôe_¸3
(
	`ªad_¸3
());

165 
	}
}

169 
	#PREALLOCATED_PMDS
 0

	)

173 
	$‰ì_pmds
(
pmd_t
 *
pmds
[])

175 
i
;

177 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++)

178 i‡(
pmds
[
i
])

179 
	`‰ì_∑ge
(()
pmds
[
i
]);

180 
	}
}

182 
	$¥óŒoˇã_pmds
(
pmd_t
 *
pmds
[])

184 
i
;

185 
boﬁ
 
Áûed
 = 
Ál£
;

187 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

188 
pmd_t
 *
pmd
 = (pmd_à*)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

189 i‡(
pmd
 =
NULL
)

190 
Áûed
 = 
åue
;

191 
pmds
[
i
] = 
pmd
;

194 i‡(
Áûed
) {

195 
	`‰ì_pmds
(
pmds
);

196  -
ENOMEM
;

200 
	}
}

208 
	$pgd_m›_up_pmds
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgdp
)

210 
i
;

212 
i
 = 0; i < 
PREALLOCATED_PMDS
; i++) {

213 
pgd_t
 
pgd
 = 
pgdp
[
i
];

215 i‡(
	`pgd_vÆ
(
pgd
) != 0) {

216 
pmd_t
 *
pmd
 = (pmd_à*)
	`pgd_∑ge_vaddr
(
pgd
);

218 
pgdp
[
i
] = 
	`«tive_make_pgd
(0);

220 
	`∑øvút_ªÀa£_pmd
(
	`pgd_vÆ
(
pgd
Ë>> 
PAGE_SHIFT
);

221 
	`pmd_‰ì
(
mm
, 
pmd
);

224 
	}
}

226 
	$pgd_¥ï›uœã_pmd
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
, 
pmd_t
 *
pmds
[])

228 
pud_t
 *
pud
;

229 
addr
;

230 
i
;

232 i‡(
PREALLOCATED_PMDS
 == 0)

235 
pud
 = 
	`pud_off£t
(
pgd
, 0);

237 
addr
 = 
i
 = 0; i < 
PREALLOCATED_PMDS
;

238 
i
++, 
pud
++, 
addr
 +
PUD_SIZE
) {

239 
pmd_t
 *
pmd
 = 
pmds
[
i
];

241 i‡(
i
 >
KERNEL_PGD_BOUNDARY
)

242 
	`mem˝y
(
pmd
, (
pmd_t
 *)
	`pgd_∑ge_vaddr
(
sw≠≥r_pg_dú
[
i
]),

243 (
pmd_t
Ë* 
PTRS_PER_PMD
);

245 
	`pud_p›uœã
(
mm
, 
pud
, 
pmd
);

247 
	}
}

249 
pgd_t
 *
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

251 
pgd_t
 *
pgd
;

252 
pmd_t
 *
pmds
[
PREALLOCATED_PMDS
];

253 
Êags
;

255 
pgd
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
PGALLOC_GFP
);

257 i‡(
pgd
 =
NULL
)

258 
out
;

260 
mm
->
pgd
 =Ögd;

262 i‡(
	`¥óŒoˇã_pmds
(
pmds
) != 0)

263 
out_‰ì_pgd
;

265 i‡(
	`∑øvút_pgd_Æloc
(
mm
) != 0)

266 
out_‰ì_pmds
;

273 
	`•ö_lock_úqßve
(&
pgd_lock
, 
Êags
);

275 
	`pgd_˘‹
(
pgd
);

276 
	`pgd_¥ï›uœã_pmd
(
mm
, 
pgd
, 
pmds
);

278 
	`•ö_u∆ock_úqª°‹e
(&
pgd_lock
, 
Êags
);

280  
pgd
;

282 
out_‰ì_pmds
:

283 
	`‰ì_pmds
(
pmds
);

284 
out_‰ì_pgd
:

285 
	`‰ì_∑ge
(()
pgd
);

286 
out
:

287  
NULL
;

288 
	}
}

290 
	$pgd_‰ì
(
mm_°ru˘
 *
mm
, 
pgd_t
 *
pgd
)

292 
	`pgd_m›_up_pmds
(
mm
, 
pgd
);

293 
	`pgd_dt‹
(
pgd
);

294 
	`∑øvút_pgd_‰ì
(
mm
, 
pgd
);

295 
	`‰ì_∑ge
(()
pgd
);

296 
	}
}

298 
	$±ï_£t_ac˚ss_Êags
(
vm_¨ó_°ru˘
 *
vma
,

299 
addªss
, 
±e_t
 *
±ï
,

300 
±e_t
 
íåy
, 
dúty
)

302 
ch™ged
 = !
	`±e_ßme
(*
±ï
, 
íåy
);

304 i‡(
ch™ged
 && 
dúty
) {

305 *
±ï
 = 
íåy
;

306 
	`±e_upd©e_de„r
(
vma
->
vm_mm
, 
addªss
, 
±ï
);

307 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

310  
ch™ged
;

311 
	}
}

313 
	$±ï_ã°_™d_˛ór_young
(
vm_¨ó_°ru˘
 *
vma
,

314 
addr
, 
±e_t
 *
±ï
)

316 
ªt
 = 0;

318 i‡(
	`±e_young
(*
±ï
))

319 
ªt
 = 
	`ã°_™d_˛ór_bô
(
_PAGE_BIT_ACCESSED
,

320 (*Ë&
±ï
->
±e
);

322 i‡(
ªt
)

323 
	`±e_upd©e
(
vma
->
vm_mm
, 
addr
, 
±ï
);

325  
ªt
;

326 
	}
}

328 
	$±ï_˛ór_Êush_young
(
vm_¨ó_°ru˘
 *
vma
,

329 
addªss
, 
±e_t
 *
±ï
)

331 
young
;

333 
young
 = 
	`±ï_ã°_™d_˛ór_young
(
vma
, 
addªss
, 
±ï
);

334 i‡(
young
)

335 
	`Êush_éb_∑ge
(
vma
, 
addªss
);

337  
young
;

338 
	}
}

347 
__öô
 
	$ª£rve_t›_addªss
(
ª£rve
)

349 #ifde‡
CONFIG_X86_32


350 
	`BUG_ON
(
fixm≠s_£t
 > 0);

351 
	`¥ötk
(
KERN_INFO
 "Reserving virtualáddress spaceábove 0x%08x\n",

352 ()-
ª£rve
);

353 
__FIXADDR_TOP
 = -
ª£rve
 - 
PAGE_SIZE
;

355 
	}
}

357 
	gfixm≠s_£t
;

359 
	$__«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
±e_t
 
±e
)

361 
addªss
 = 
	`__fix_to_vút
(
idx
);

363 i‡(
idx
 >
__íd_of_fixed_addªs£s
) {

364 
	`BUG
();

367 
	`£t_±e_vaddr
(
addªss
, 
±e
);

368 
fixm≠s_£t
++;

369 
	}
}

371 
	$«tive_£t_fixm≠
(
fixed_addªs£s
 
idx
, 
phys_addr_t
 
phys
,

372 
pg¥Ÿ_t
 
Êags
)

374 
	`__«tive_£t_fixm≠
(
idx
, 
	`p‚_±e
(
phys
 >> 
PAGE_SHIFT
, 
Êags
));

375 
	}
}

	@/cmpt816/linux/arch/x86/mm/physaddr.c

1 
	~<löux/mmdebug.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/mm.h
>

5 
	~<asm/∑ge.h
>

7 
	~"phyßddr.h
"

9 #ifde‡
CONFIG_X86_64


11 
	$__phys_addr
(
x
)

13 i‡(
x
 >
__START_KERNEL_m≠
) {

14 
x
 -
__START_KERNEL_m≠
;

15 
	`VIRTUAL_BUG_ON
(
x
 >
KERNEL_IMAGE_SIZE
);

16 
x
 +
phys_ba£
;

18 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

19 
x
 -
PAGE_OFFSET
;

20 
	`VIRTUAL_BUG_ON
(!
	`phys_addr_vÆid
(
x
));

22  
x
;

23 
	}
}

24 
EXPORT_SYMBOL
(
__phys_addr
);

26 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

28 i‡(
x
 >
__START_KERNEL_m≠
) {

29 
x
 -
__START_KERNEL_m≠
;

30 i‡(
x
 >
KERNEL_IMAGE_SIZE
)

31  
Ál£
;

32 
x
 +
phys_ba£
;

34 i‡(
x
 < 
PAGE_OFFSET
)

35  
Ál£
;

36 
x
 -
PAGE_OFFSET
;

37 i‡(!
	`phys_addr_vÆid
(
x
))

38  
Ál£
;

41  
	`p‚_vÆid
(
x
 >> 
PAGE_SHIFT
);

42 
	}
}

43 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

47 #ifde‡
CONFIG_DEBUG_VIRTUAL


48 
	$__phys_addr
(
x
)

51 
	`VIRTUAL_BUG_ON
(
x
 < 
PAGE_OFFSET
);

52 
	`VIRTUAL_BUG_ON
(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
));

53  
x
 - 
PAGE_OFFSET
;

54 
	}
}

55 
EXPORT_SYMBOL
(
__phys_addr
);

58 
boﬁ
 
	$__vút_addr_vÆid
(
x
)

60 i‡(
x
 < 
PAGE_OFFSET
)

61  
Ál£
;

62 i‡(
__vmÆloc_°¨t_£t
 && 
	`is_vmÆloc_addr
((*Ë
x
))

63  
Ál£
;

64 i‡(
x
 >
FIXADDR_START
)

65  
Ál£
;

66  
	`p‚_vÆid
((
x
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
);

67 
	}
}

68 
EXPORT_SYMBOL
(
__vút_addr_vÆid
);

	@/cmpt816/linux/arch/x86/mm/setup_nx.c

1 
	~<löux/•ölock.h
>

2 
	~<löux/î∫o.h
>

3 
	~<löux/öô.h
>

5 
	~<asm/pgèbÀ.h
>

6 
	~<asm/¥Ÿo.h
>

8 
dißbÀ_nx
 
	g__˝uöôd©a
;

18 
__öô
 
	$n€xec_£tup
(*
°r
)

20 i‡(!
°r
)

21  -
EINVAL
;

22 i‡(!
	`°∫cmp
(
°r
, "on", 2)) {

23 
dißbÀ_nx
 = 0;

24 } i‡(!
	`°∫cmp
(
°r
, "off", 3)) {

25 
dißbÀ_nx
 = 1;

27 
	`x86_c⁄figuª_nx
();

29 
	}
}

30 
óæy_∑øm
("n€xec", 
n€xec_£tup
);

32 
__˝uöô
 
	$x86_c⁄figuª_nx
()

34 i‡(
˝u_has_nx
 && !
dißbÀ_nx
)

35 
__suµ‹ãd_±e_mask
 |
_PAGE_NX
;

37 
__suµ‹ãd_±e_mask
 &~
_PAGE_NX
;

38 
	}
}

40 
__öô
 
	$x86_ªp‹t_nx
()

42 i‡(!
˝u_has_nx
) {

43 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

46 #i‡
	`deföed
(
CONFIG_X86_64
Ë|| deföed(
CONFIG_X86_PAE
)

47 i‡(
dißbÀ_nx
) {

48 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

51 
	`¥ötk
(
KERN_INFO
 "NX (Execute Disable)Örotection: "

56 
	`¥ötk
(
KERN_NOTICE
 "Notice: NX (Execute Disable)Örotection "

60 
	}
}

	@/cmpt816/linux/arch/x86/mm/srat_64.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/a˝i.h
>

14 
	~<löux/mmz⁄e.h
>

15 
	~<löux/bôm≠.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/t›ﬁogy.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/mm.h
>

20 
	~<asm/¥Ÿo.h
>

21 
	~<asm/numa.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/≠ic.h
>

24 
	~<asm/uv/uv.h
>

26 
a˝i_numa
 
	g__öôd©a
;

28 
a˝i_èbÀ_¶ô
 *
	ga˝i_¶ô
;

30 
nodemask_t
 
nodes_∑r£d
 
	g__öôd©a
;

31 
nodemask_t
 
˝u_nodes_∑r£d
 
	g__öôd©a
;

32 
boŸnode
 
	gnodes
[
MAX_NUMNODES
] 
	g__öôd©a
;

33 
boŸnode
 
	gnodes_add
[
MAX_NUMNODES
];

35 
num_node_memblks
 
	g__öôd©a
;

36 
boŸnode
 
	gnode_memblk_ønge
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

37 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
] 
	g__öôd©a
;

39 
__öô
 
	$£tup_node
(
pxm
)

41  
	`a˝i_m≠_pxm_to_node
(
pxm
);

42 
	}
}

44 
__öô
 
	$c⁄Êi˘ög_memblks
(
°¨t
, 
íd
)

46 
i
;

47 
i
 = 0; i < 
num_node_memblks
; i++) {

48 
boŸnode
 *
nd
 = &
node_memblk_ønge
[
i
];

49 i‡(
nd
->
°¨t
 =nd->
íd
)

51 i‡(
nd
->
íd
 > 
°¨t
 &&Çd->start <Énd)

52  
memblk_nodeid
[
i
];

53 i‡(
nd
->
íd
 =íd &&Çd->
°¨t
 == start)

54  
memblk_nodeid
[
i
];

57 
	}
}

59 
__öô
 
	$cutoff_node
(
i
, 
°¨t
, 
íd
)

61 
boŸnode
 *
nd
 = &
nodes
[
i
];

63 i‡(
nd
->
°¨t
 < start) {

64 
nd
->
°¨t
 = start;

65 i‡(
nd
->
íd
 <Çd->
°¨t
)

66 
nd
->
°¨t
 =Çd->
íd
;

68 i‡(
nd
->
íd
 >Énd) {

69 
nd
->
íd
 =Énd;

70 i‡(
nd
->
°¨t
 >Çd->
íd
)

71 
nd
->
°¨t
 =Çd->
íd
;

73 
	}
}

75 
__öô
 
	$bad_§©
()

77 
i
;

78 
	`¥ötk
(
KERN_ERR
 "SRAT: SRATÇot used.\n");

79 
a˝i_numa
 = -1;

80 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

81 
≠icid_to_node
[
i
] = 
NUMA_NO_NODE
;

82 
i
 = 0; i < 
MAX_NUMNODES
; i++) {

83 
nodes
[
i
].
°¨t
 =Çodes[i].
íd
 = 0;

84 
nodes_add
[
i
].
°¨t
 =Çodes_add[i].
íd
 = 0;

86 
	`ªmove_Æl_a˘ive_ønges
();

87 
	}
}

89 
__öô
 
ölöe
 
	$§©_dißbÀd
()

91  
numa_off
 || 
a˝i_numa
 < 0;

92 
	}
}

95 
__öô
 
	$a˝i_numa_¶ô_öô
(
a˝i_èbÀ_¶ô
 *
¶ô
)

97 
Àngth
;

98 
phys
;

100 
Àngth
 = 
¶ô
->
hódî
.length;

101 
phys
 = 
	`föd_e820_¨ó
(0, 
max_p‚_m≠≥d
<<
PAGE_SHIFT
, 
Àngth
,

102 
PAGE_SIZE
);

104 i‡(
phys
 == -1L)

105 
	`∑nic
(" CanÇot save slit!\n");

107 
a˝i_¶ô
 = 
	`__va
(
phys
);

108 
	`mem˝y
(
a˝i_¶ô
, 
¶ô
, 
Àngth
);

109 
	`ª£rve_óæy
(
phys
,Öhy†+ 
Àngth
, "ACPI SLIT");

110 
	}
}

113 
__öô


114 
	$a˝i_numa_x2≠ic_afföôy_öô
(
a˝i_§©_x2≠ic_˝u_afföôy
 *
∑
)

116 
pxm
, 
node
;

117 
≠ic_id
;

119 i‡(
	`§©_dißbÀd
())

121 i‡(
∑
->
hódî
.
Àngth
 < (
a˝i_§©_x2≠ic_˝u_afföôy
)) {

122 
	`bad_§©
();

125 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

127 
pxm
 = 
∑
->
¥oximôy_domaö
;

128 
node
 = 
	`£tup_node
(
pxm
);

129 i‡(
node
 < 0) {

130 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

131 
	`bad_§©
();

135 
≠ic_id
 = 
∑
->apic_id;

136 
≠icid_to_node
[
≠ic_id
] = 
node
;

137 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

138 
a˝i_numa
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%04x -> Node %u\n",

140 
pxm
, 
≠ic_id
, 
node
);

141 
	}
}

144 
__öô


145 
	$a˝i_numa_¥o˚ss‹_afföôy_öô
(
a˝i_§©_˝u_afföôy
 *
∑
)

147 
pxm
, 
node
;

148 
≠ic_id
;

150 i‡(
	`§©_dißbÀd
())

152 i‡(
∑
->
hódî
.
Àngth
 !(
a˝i_§©_˝u_afföôy
)) {

153 
	`bad_§©
();

156 i‡((
∑
->
Êags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

158 
pxm
 = 
∑
->
¥oximôy_domaö_lo
;

159 
node
 = 
	`£tup_node
(
pxm
);

160 i‡(
node
 < 0) {

161 
	`¥ötk
(
KERN_ERR
 "SRAT: Toÿm™yÖroximôy domaö†%x\n", 
pxm
);

162 
	`bad_§©
();

166 i‡(
	`gë_uv_sy°em_ty≥
(Ë>
UV_X2APIC
)

167 
≠ic_id
 = (
∑
->≠ic_id << 8Ë|Öa->
loˇl_ßpic_eid
;

169 
≠ic_id
 = 
∑
->apic_id;

170 
≠icid_to_node
[
≠ic_id
] = 
node
;

171 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

172 
a˝i_numa
 = 1;

173 
	`¥ötk
(
KERN_INFO
 "SRAT: PXM %u -> APIC 0x%02x -> Node %u\n",

174 
pxm
, 
≠ic_id
, 
node
);

175 
	}
}

177 #ifde‡
CONFIG_MEMORY_HOTPLUG_SPARSE


178 
ölöe
 
	$ßve_add_öfo
(Ë{ 1;
	}
}

180 
ölöe
 
	$ßve_add_öfo
(Ë{ 0;
	}
}

186 
__öô


187 
	$upd©e_nodes_add
(
node
, 
°¨t
, 
íd
)

189 
s_p‚
 = 
°¨t
 >> 
PAGE_SHIFT
;

190 
e_p‚
 = 
íd
 >> 
PAGE_SHIFT
;

191 
ch™ged
 = 0;

192 
boŸnode
 *
nd
 = &
nodes_add
[
node
];

200 i‡((sig√d )(
íd
 - 
°¨t
Ë< 
NODE_MIN_SIZE
) {

201 
	`¥ötk
(
KERN_ERR
 "SRAT: HotplugáreaÅoo small\n");

206 i‡(
	`ab£¡_∑ges_ö_ønge
(
s_p‚
, 
e_p‚
) !=É_pfn - s_pfn) {

207 
	`¥ötk
(
KERN_ERR


209 
s_p‚
, 
e_p‚
);

215 i‡(
nd
->
°¨t
 =nd->
íd
) {

216 
nd
->
°¨t
 = start;

217 
nd
->
íd
 =Énd;

218 
ch™ged
 = 1;

220 i‡(
nd
->
°¨t
 =
íd
) {

221 
nd
->
°¨t
 = start;

222 
ch™ged
 = 1;

224 i‡(
nd
->
íd
 =
°¨t
) {

225 
nd
->
íd
 =Énd;

226 
ch™ged
 = 1;

228 i‡(!
ch™ged
)

229 
	`¥ötk
(
KERN_ERR
 "SRAT: Hotplug zoneÇot continuous. Partly ignored\n");

232 i‡(
ch™ged
) {

233 
	`node_£t
(
node
, 
˝u_nodes_∑r£d
);

234 
	`¥ötk
(
KERN_INFO
 "SRAT: hotÖlug zone found %Lx - %Lx\n",

235 
nd
->
°¨t
,Çd->
íd
);

237 
	}
}

240 
__öô


241 
	$a˝i_numa_mem‹y_afföôy_öô
(
a˝i_§©_mem_afföôy
 *
ma
)

243 
boŸnode
 *
nd
, 
ﬁdnode
;

244 
°¨t
, 
íd
;

245 
node
, 
pxm
;

246 
i
;

248 i‡(
	`§©_dißbÀd
())

250 i‡(
ma
->
hódî
.
Àngth
 !(
a˝i_§©_mem_afföôy
)) {

251 
	`bad_§©
();

254 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_ENABLED
) == 0)

257 i‡((
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
Ë&& !
	`ßve_add_öfo
())

259 
°¨t
 = 
ma
->
ba£_addªss
;

260 
íd
 = 
°¨t
 + 
ma
->
Àngth
;

261 
pxm
 = 
ma
->
¥oximôy_domaö
;

262 
node
 = 
	`£tup_node
(
pxm
);

263 i‡(
node
 < 0) {

264 
	`¥ötk
(
KERN_ERR
 "SRAT: Too manyÖroximity domains.\n");

265 
	`bad_§©
();

268 
i
 = 
	`c⁄Êi˘ög_memblks
(
°¨t
, 
íd
);

269 i‡(
i
 =
node
) {

270 
	`¥ötk
(
KERN_WARNING


272 
pxm
, 
°¨t
, 
íd
, 
nodes
[
i
].start,Çodes[i].end);

273 } i‡(
i
 >= 0) {

274 
	`¥ötk
(
KERN_ERR


276 
pxm
, 
°¨t
, 
íd
, 
	`node_to_pxm
(
i
),

277 
nodes
[
i
].
°¨t
,Çodes[i].
íd
);

278 
	`bad_§©
();

281 
nd
 = &
nodes
[
node
];

282 
ﬁdnode
 = *
nd
;

283 i‡(!
	`node_ã°_™d_£t
(
node
, 
nodes_∑r£d
)) {

284 
nd
->
°¨t
 = start;

285 
nd
->
íd
 =Énd;

287 i‡(
°¨t
 < 
nd
->start)

288 
nd
->
°¨t
 = start;

289 i‡(
nd
->
íd
 <Énd)

290 
nd
->
íd
 =Énd;

293 
	`¥ötk
(
KERN_INFO
 "SRAT: Nodê%u PXM %u %lx-%lx\n", 
node
, 
pxm
,

294 
°¨t
, 
íd
);

296 i‡(
ma
->
Êags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
) {

297 
	`upd©e_nodes_add
(
node
, 
°¨t
, 
íd
);

299 *
nd
 = 
ﬁdnode
;

300 i‡((
nd
->
°¨t
 |Çd->
íd
) == 0)

301 
	`node_˛ór
(
node
, 
nodes_∑r£d
);

304 
node_memblk_ønge
[
num_node_memblks
].
°¨t
 = start;

305 
node_memblk_ønge
[
num_node_memblks
].
íd
 =Énd;

306 
memblk_nodeid
[
num_node_memblks
] = 
node
;

307 
num_node_memblks
++;

308 
	}
}

312 
__öô
 
	$nodes_covî_mem‹y
(c⁄° 
boŸnode
 *
nodes
)

314 
i
;

315 
pxmøm
, 
e820øm
;

317 
pxmøm
 = 0;

318 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

319 
s
 = 
nodes
[
i
].
°¨t
 >> 
PAGE_SHIFT
;

320 
e
 = 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
;

321 
pxmøm
 +
e
 - 
s
;

322 
pxmøm
 -
	`__ab£¡_∑ges_ö_ønge
(
i
, 
s
, 
e
);

323 i‡(()
pxmøm
 < 0)

324 
pxmøm
 = 0;

327 
e820øm
 = 
max_p‚
 - (
	`e820_hﬁe_size
(0, max_p‚<<
PAGE_SHIFT
)>>PAGE_SHIFT);

329 i‡(()(
e820øm
 - 
pxmøm
Ë>(1<<(20 - 
PAGE_SHIFT
))) {

330 
	`¥ötk
(
KERN_ERR


332 (
pxmøm
 << 
PAGE_SHIFT
) >> 20,

333 (
e820øm
 << 
PAGE_SHIFT
) >> 20);

337 
	}
}

339 
__öô
 
	$a˝i_numa_¨ch_fixup
(Ë{
	}
}

341 
__öô
 
	$a˝i_gë_nodes
(
boŸnode
 *
phy¢odes
)

343 
i
;

344 
ªt
 = 0;

346 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

347 
phy¢odes
[
ªt
].
°¨t
 = 
nodes
[
i
].start;

348 
phy¢odes
[
ªt
].
íd
 = 
nodes
[
i
].end;

349 
ªt
++;

351  
ªt
;

352 
	}
}

355 
__öô
 
	$a˝i_sˇn_nodes
(
°¨t
, 
íd
)

357 
i
;

359 i‡(
a˝i_numa
 <= 0)

363 
i
 = 0; i < 
MAX_NUMNODES
; i++)

364 
	`cutoff_node
(
i
, 
°¨t
, 
íd
);

370 
i
 = 0; i < 
num_node_memblks
; ++i) {

371 
j
, 
k
;

373 
j
 = 
i
 + 1; j < 
num_node_memblks
; ++j) {

374 
°¨t
, 
íd
;

376 i‡(
memblk_nodeid
[
i
] !memblk_nodeid[
j
])

378 
°¨t
 = 
	`mö
(
node_memblk_ønge
[
i
].
íd
,

379 
node_memblk_ønge
[
j
].
íd
);

380 
íd
 = 
	`max
(
node_memblk_ønge
[
i
].
°¨t
,

381 
node_memblk_ønge
[
j
].
°¨t
);

382 
k
 = 0; k < 
num_node_memblks
; ++k) {

383 i‡(
memblk_nodeid
[
i
] =memblk_nodeid[
k
])

385 i‡(
°¨t
 < 
node_memblk_ønge
[
k
].
íd
 &&

386 
íd
 > 
node_memblk_ønge
[
k
].
°¨t
)

389 i‡(
k
 < 
num_node_memblks
)

391 
°¨t
 = 
	`mö
(
node_memblk_ønge
[
i
].start,

392 
node_memblk_ønge
[
j
].
°¨t
);

393 
íd
 = 
	`max
(
node_memblk_ønge
[
i
].end,

394 
node_memblk_ønge
[
j
].
íd
);

395 
	`¥ötk
(
KERN_INFO
 "SRAT: Node %d "

397 
memblk_nodeid
[
i
],

398 
node_memblk_ønge
[
i
].
°¨t
,

399 
node_memblk_ønge
[
i
].
íd
,

400 
node_memblk_ønge
[
j
].
°¨t
,

401 
node_memblk_ønge
[
j
].
íd
,

402 
°¨t
, 
íd
);

403 
node_memblk_ønge
[
i
].
°¨t
 = start;

404 
node_memblk_ønge
[
i
].
íd
 =Énd;

405 
k
 = --
num_node_memblks
 - 
j
;

406 
	`memmove
(
memblk_nodeid
 + 
j
, memblk_nodeid + j+1,

407 
k
 * (*
memblk_nodeid
));

408 
	`memmove
(
node_memblk_ønge
 + 
j
,Çode_memblk_range + j+1,

409 
k
 * (*
node_memblk_ønge
));

410 --
j
;

414 
memnode_shi·
 = 
	`compuã_hash_shi·
(
node_memblk_ønge
, 
num_node_memblks
,

415 
memblk_nodeid
);

416 i‡(
memnode_shi·
 < 0) {

417 
	`¥ötk
(
KERN_ERR


419 
	`bad_§©
();

423 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
)

424 
	`e820_ªgi°î_a˘ive_ªgi⁄s
(
i
, 
nodes
[i].
°¨t
 >> 
PAGE_SHIFT
,

425 
nodes
[
i
].
íd
 >> 
PAGE_SHIFT
);

427 
	`s‹t_node_m≠
();

428 i‡(!
	`nodes_covî_mem‹y
(
nodes
)) {

429 
	`bad_§©
();

434 
	`nodes_‹
(
node_possibÀ_m≠
, 
nodes_∑r£d
, 
˝u_nodes_∑r£d
);

437 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

438 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

441 
	`f‹_óch_node_mask
(
i
, 
node_possibÀ_m≠
)

442 i‡(!
	`node_⁄löe
(
i
))

443 
	`£tup_node_boŸmem
(
i
, 
nodes
[i].
°¨t
,Çodes[i].
íd
);

445 
i
 = 0; i < 
ƒ_˝u_ids
; i++) {

446 
node
 = 
	`óæy_˝u_to_node
(
i
);

448 i‡(
node
 =
NUMA_NO_NODE
)

450 i‡(!
	`node_⁄löe
(
node
))

451 
	`numa_˛ór_node
(
i
);

453 
	`numa_öô_¨øy
();

455 
	}
}

457 #ifde‡
CONFIG_NUMA_EMU


458 
	gÁke_node_to_pxm_m≠
[
MAX_NUMNODES
] 
	g__öôd©a
 = {

459 [0 ... 
MAX_NUMNODES
-1] = 
PXM_INVAL


461 
s16
 
	gÁke_≠icid_to_node
[
MAX_LOCAL_APIC
] 
	g__öôd©a
 = {

462 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


464 
__öô
 
	$föd_node_by_addr
(
addr
)

466 
ªt
 = 
NUMA_NO_NODE
;

467 
i
;

469 
	`f‹_óch_node_mask
(
i
, 
nodes_∑r£d
) {

475 i‡(
addr
 >
nodes
[
i
].
°¨t
 &&ádd∏<Çodes[i].
íd
) {

476 
ªt
 = 
i
;

480  
ªt
;

481 
	}
}

491 
__öô
 
	$a˝i_Áke_nodes
(c⁄° 
boŸnode
 *
Áke_nodes
, 
num_nodes
)

493 
i
, 
j
;

495 
	`¥ötk
(
KERN_INFO
 "Faking PXMáffinity for fakeÇodes onÑeal "

497 
i
 = 0; i < 
num_nodes
; i++) {

498 
nid
, 
pxm
;

500 
nid
 = 
	`föd_node_by_addr
(
Áke_nodes
[
i
].
°¨t
);

501 i‡(
nid
 =
NUMA_NO_NODE
)

503 
pxm
 = 
	`node_to_pxm
(
nid
);

504 i‡(
pxm
 =
PXM_INVAL
)

506 
Áke_node_to_pxm_m≠
[
i
] = 
pxm
;

511 
j
 = 0; j < 
MAX_LOCAL_APIC
; j++)

512 i‡(
≠icid_to_node
[
j
] =
nid
 &&

513 
Áke_≠icid_to_node
[
j
] =
NUMA_NO_NODE
)

514 
Áke_≠icid_to_node
[
j
] = 
i
;

516 
i
 = 0; i < 
num_nodes
; i++)

517 
	`__a˝i_m≠_pxm_to_node
(
Áke_node_to_pxm_m≠
[
i
], i);

518 
	`mem˝y
(
≠icid_to_node
, 
Áke_≠icid_to_node
, (apicid_to_node));

520 
	`nodes_˛ór
(
nodes_∑r£d
);

521 
i
 = 0; i < 
num_nodes
; i++)

522 i‡(
Áke_nodes
[
i
].
°¨t
 !Áke_nodes[i].
íd
)

523 
	`node_£t
(
i
, 
nodes_∑r£d
);

524 
	}
}

526 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

528  
	`node_to_pxm
(
a
Ë=node_to_pxm(
b
);

529 
	}
}

531 
	$nuŒ_¶ô_node_com∑ª
(
a
, 
b
)

533  
a
 =
b
;

534 
	}
}

537 
	$__node_di°™˚
(
a
, 
b
)

539 
ödex
;

541 i‡(!
a˝i_¶ô
)

542  
	`nuŒ_¶ô_node_com∑ª
(
a
, 
b
Ë? 
LOCAL_DISTANCE
 :

543 
REMOTE_DISTANCE
;

544 
ödex
 = 
a˝i_¶ô
->
loˇlôy_cou¡
 * 
	`node_to_pxm
(
a
);

545  
a˝i_¶ô
->
íåy
[
ödex
 + 
	`node_to_pxm
(
b
)];

546 
	}
}

548 
EXPORT_SYMBOL
(
__node_di°™˚
);

550 #i‡
deföed
(
CONFIG_MEMORY_HOTPLUG_SPARSE
Ë|| deföed(
CONFIG_ACPI_HOTPLUG_MEMORY
)

551 
	$mem‹y_add_phyßddr_to_nid
(
u64
 
°¨t
)

553 
i
, 
ªt
 = 0;

555 
	`f‹_óch_node
(
i
)

556 i‡(
nodes_add
[
i
].
°¨t
 <°¨à&&Çodes_add[i].
íd
 > start)

557 
ªt
 = 
i
;

559  
ªt
;

560 
	}
}

561 
EXPORT_SYMBOL_GPL
(
mem‹y_add_phyßddr_to_nid
);

	@/cmpt816/linux/arch/x86/mm/tlb.c

1 
	~<löux/öô.h
>

3 
	~<löux/mm.h
>

4 
	~<löux/•ölock.h
>

5 
	~<löux/smp.h
>

6 
	~<löux/öãºu±.h
>

7 
	~<löux/moduÀ.h
>

9 
	~<asm/ébÊush.h
>

10 
	~<asm/mmu_c⁄ãxt.h
>

11 
	~<asm/ˇche.h
>

12 
	~<asm/≠ic.h
>

13 
	~<asm/uv/uv.h
>

15 
DEFINE_PER_CPU_SHARED_ALIGNED
(
éb_°©e
, 
˝u_éb°©e
)

16 { &
öô_mm
, 0, };

40 
	usmp_Êush_°©e
 {

42 
mm_°ru˘
 *
	mÊush_mm
;

43 
	mÊush_va
;

44 
øw_•ölock_t
 
	méb°©e_lock
;

45 
DECLARE_BITMAP
(
Êush_˝umask
, 
NR_CPUS
);

47 
	m∑d
[
INTERNODE_CACHE_BYTES
];

48 } 
	g____ˇchñöe_öã∫odólig√d_ö_smp
;

53 
smp_Êush_°©e
 
	gÊush_°©e
[
NUM_INVALIDATE_TLB_VECTORS
];

59 
	$Àave_mm
(
˝u
)

61 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
)

62 
	`BUG
();

63 
	`˝umask_˛ór_˝u
(
˝u
,

64 
	`mm_˝umask
(
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)));

65 
	`lﬂd_¸3
(
sw≠≥r_pg_dú
);

66 
	}
}

67 
EXPORT_SYMBOL_GPL
(
Àave_mm
);

124 #ifde‡
CONFIG_X86_64


125 
	gasmlökage


127 
	$smp_övÆid©e_öãºu±
(
±_ªgs
 *
ªgs
)

129 
˝u
;

130 
£ndî
;

131 
smp_Êush_°©e
 *
f
;

133 
˝u
 = 
	`smp_¥o˚ss‹_id
();

138 
£ndî
 = ~
ªgs
->
‹ig_ax
 - 
INVALIDATE_TLB_VECTOR_START
;

139 
f
 = &
Êush_°©e
[
£ndî
];

141 i‡(!
	`˝umask_ã°_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
)))

142 
out
;

152 i‡(
f
->
Êush_mm
 =
	`≥r˝u_ªad
(
˝u_éb°©e
.
a˘ive_mm
)) {

153 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_OK
) {

154 i‡(
f
->
Êush_va
 =
TLB_FLUSH_ALL
)

155 
	`loˇl_Êush_éb
();

157 
	`__Êush_éb_⁄e
(
f
->
Êush_va
);

159 
	`Àave_mm
(
˝u
);

161 
out
:

162 
	`ack_APIC_úq
();

163 
	`smp_mb__bef‹e_˛ór_bô
();

164 
	`˝umask_˛ór_˝u
(
˝u
, 
	`to_˝umask
(
f
->
Êush_˝umask
));

165 
	`smp_mb__a·î_˛ór_bô
();

166 
	`öc_úq_°©
(
úq_éb_cou¡
);

167 
	}
}

169 
	$Êush_éb_Ÿhîs_ùi
(c⁄° 
˝umask
 *cpumask,

170 
mm_°ru˘
 *
mm
, 
va
)

172 
£ndî
;

173 
smp_Êush_°©e
 *
f
;

176 
£ndî
 = 
	`smp_¥o˚ss‹_id
(Ë% 
NUM_INVALIDATE_TLB_VECTORS
;

177 
f
 = &
Êush_°©e
[
£ndî
];

184 
	`øw_•ö_lock
(&
f
->
éb°©e_lock
);

186 
f
->
Êush_mm
 = 
mm
;

187 
f
->
Êush_va
 = 
va
;

188 i‡(
	`˝umask_™dnŸ
(
	`to_˝umask
(
f
->
Êush_˝umask
), 
˝umask
, 
	`˝umask_of
(
	`smp_¥o˚ss‹_id
()))) {

193 
≠ic
->
	`£nd_IPI_mask
(
	`to_˝umask
(
f
->
Êush_˝umask
),

194 
INVALIDATE_TLB_VECTOR_START
 + 
£ndî
);

196 !
	`˝umask_em±y
(
	`to_˝umask
(
f
->
Êush_˝umask
)))

197 
	`˝u_ªœx
();

200 
f
->
Êush_mm
 = 
NULL
;

201 
f
->
Êush_va
 = 0;

202 
	`øw_•ö_u∆ock
(&
f
->
éb°©e_lock
);

203 
	}
}

205 
	$«tive_Êush_éb_Ÿhîs
(c⁄° 
˝umask
 *cpumask,

206 
mm_°ru˘
 *
mm
, 
va
)

208 i‡(
	`is_uv_sy°em
()) {

209 
˝u
;

211 
˝u
 = 
	`gë_˝u
();

212 
˝umask
 = 
	`uv_Êush_éb_Ÿhîs
(˝umask, 
mm
, 
va
, 
˝u
);

213 i‡(
˝umask
)

214 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

215 
	`put_˝u
();

218 
	`Êush_éb_Ÿhîs_ùi
(
˝umask
, 
mm
, 
va
);

219 
	}
}

221 
__˝uöô
 
	$öô_smp_Êush
()

223 
i
;

225 
i
 = 0; i < 
	`ARRAY_SIZE
(
Êush_°©e
); i++)

226 
	`øw_•ö_lock_öô
(&
Êush_°©e
[
i
].
éb°©e_lock
);

229 
	}
}

230 
c‹e_öôˇŒ
(
öô_smp_Êush
);

232 
	$Êush_éb_cuºít_èsk
()

234 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

236 
	`¥ìm±_dißbÀ
();

238 
	`loˇl_Êush_éb
();

239 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

240 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

241 
	`¥ìm±_íabÀ
();

242 
	}
}

244 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

246 
	`¥ìm±_dißbÀ
();

248 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

249 i‡(
cuºít
->
mm
)

250 
	`loˇl_Êush_éb
();

252 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

254 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

255 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
TLB_FLUSH_ALL
);

257 
	`¥ìm±_íabÀ
();

258 
	}
}

260 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
va
)

262 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

264 
	`¥ìm±_dißbÀ
();

266 i‡(
cuºít
->
a˘ive_mm
 =
mm
) {

267 i‡(
cuºít
->
mm
)

268 
	`__Êush_éb_⁄e
(
va
);

270 
	`Àave_mm
(
	`smp_¥o˚ss‹_id
());

273 i‡(
	`˝umask_™y_but
(
	`mm_˝umask
(
mm
), 
	`smp_¥o˚ss‹_id
()Ë< 
ƒ_˝u_ids
)

274 
	`Êush_éb_Ÿhîs
(
	`mm_˝umask
(
mm
), mm, 
va
);

276 
	`¥ìm±_íabÀ
();

277 
	}
}

279 
	$do_Êush_éb_Æl
(*
öfo
)

281 
˝u
 = 
	`smp_¥o˚ss‹_id
();

283 
	`__Êush_éb_Æl
();

284 i‡(
	`≥r˝u_ªad
(
˝u_éb°©e
.
°©e
Ë=
TLBSTATE_LAZY
)

285 
	`Àave_mm
(
˝u
);

286 
	}
}

288 
	$Êush_éb_Æl
()

290 
	`⁄_óch_˝u
(
do_Êush_éb_Æl
, 
NULL
, 1);

291 
	}
}

	@/cmpt816/linux/arch/x86/vdso/vclock_gettime.c

13 
	#DISABLE_BRANCH_PROFILING


	)

15 
	~<löux/kî√l.h
>

16 
	~<löux/posix-timîs.h
>

17 
	~<löux/time.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/vsysˇŒ.h
>

20 
	~<asm/vgtod.h
>

21 
	~<asm/timex.h
>

22 
	~<asm/h≥t.h
>

23 
	~<asm/uni°d.h
>

24 
	~<asm/io.h
>

25 
	~"vexã∫.h
"

27 
	#gtod
 
vdso_vsysˇŒ_gtod_d©a


	)

29 
nŸø˚
 
	$vdso_ÁŒback_gëtime
(
˛ock
, 
time•ec
 *
ts
)

31 
ªt
;

32 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

33 "0" (
__NR_˛ock_gëtime
),"D" (
˛ock
), "S" (
ts
) : "memory");

34  
ªt
;

35 
	}
}

37 
nŸø˚
 
ölöe
 
	$vgëns
()

39 
v
;

40 
	`cy˛es_t
 (*
vªad
)();

41 
vªad
 = 
gtod
->
˛ock
.vread;

42 
v
 = (
	`vªad
(Ë- 
gtod
->
˛ock
.
cy˛e_œ°
Ë& gtod->˛ock.
mask
;

43  (
v
 * 
gtod
->
˛ock
.
mu…
Ë>> gtod->˛ock.
shi·
;

44 
	}
}

46 
nŸø˚
 
noölöe
 
	$do_ªÆtime
(
time•ec
 *
ts
)

48 
£q
, 
ns
;

50 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

51 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_£c
;

52 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_n£c
;

53 
ns
 = 
	`vgëns
();

54 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

55 
	`time•ec_add_ns
(
ts
, 
ns
);

57 
	}
}

60 
nŸø˚
 

61 
	$v£t_n‹mÆized_time•ec
(
time•ec
 *
ts
, 
£c
, 
n£c
)

63 
n£c
 >
NSEC_PER_SEC
) {

64 
n£c
 -
NSEC_PER_SEC
;

65 ++
£c
;

67 
n£c
 < 0) {

68 
n£c
 +
NSEC_PER_SEC
;

69 --
£c
;

71 
ts
->
tv_£c
 = 
£c
;

72 
ts
->
tv_n£c
 = 
n£c
;

73 
	}
}

75 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic
(
time•ec
 *
ts
)

77 
£q
, 
ns
, 
£cs
;

79 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

80 
£cs
 = 
gtod
->
wÆl_time_£c
;

81 
ns
 = 
gtod
->
wÆl_time_n£c
 + 
	`vgëns
();

82 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

83 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

84 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

85 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

87 
	}
}

89 
nŸø˚
 
noölöe
 
	$do_ªÆtime_cﬂr£
(
time•ec
 *
ts
)

91 
£q
;

93 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

94 
ts
->
tv_£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_sec;

95 
ts
->
tv_n£c
 = 
gtod
->
wÆl_time_cﬂr£
.tv_nsec;

96 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

98 
	}
}

100 
nŸø˚
 
noölöe
 
	$do_m⁄Ÿ⁄ic_cﬂr£
(
time•ec
 *
ts
)

102 
£q
, 
ns
, 
£cs
;

104 
£q
 = 
	`ªad_£qbegö
(&
gtod
->
lock
);

105 
£cs
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_£c
;

106 
ns
 = 
gtod
->
wÆl_time_cﬂr£
.
tv_n£c
;

107 
£cs
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
;

108 
ns
 +
gtod
->
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
;

109 } 
	`u∆ikñy
(
	`ªad_£qªåy
(&
gtod
->
lock
, 
£q
)));

110 
	`v£t_n‹mÆized_time•ec
(
ts
, 
£cs
, 
ns
);

112 
	}
}

114 
nŸø˚
 
	$__vdso_˛ock_gëtime
(
˛ockid_t
 
˛ock
, 
time•ec
 *
ts
)

116 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
))

117 
˛ock
) {

118 
CLOCK_REALTIME
:

119 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

120  
	`do_ªÆtime
(
ts
);

122 
CLOCK_MONOTONIC
:

123 i‡(
	`likñy
(
gtod
->
˛ock
.
vªad
))

124  
	`do_m⁄Ÿ⁄ic
(
ts
);

126 
CLOCK_REALTIME_COARSE
:

127  
	`do_ªÆtime_cﬂr£
(
ts
);

128 
CLOCK_MONOTONIC_COARSE
:

129  
	`do_m⁄Ÿ⁄ic_cﬂr£
(
ts
);

131  
	`vdso_ÁŒback_gëtime
(
˛ock
, 
ts
);

132 
	}
}

133 
	$˛ock_gëtime
(
˛ockid_t
, 
time•ec
 *)

134 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_clock_gettime")));

136 
nŸø˚
 
	$__vdso_gëtimeofday
(
timevÆ
 *
tv
, 
timez⁄e
 *
tz
)

138 
ªt
;

139 i‡(
	`likñy
(
gtod
->
sys˘l_íabÀd
 && gtod->
˛ock
.
vªad
)) {

140 i‡(
	`likñy
(
tv
 !
NULL
)) {

141 
	`BUILD_BUG_ON
(
	`off£tof
(
timevÆ
, 
tv_u£c
) !=

142 
	`off£tof
(
time•ec
, 
tv_n£c
) ||

143 (*
tv
Ë!(
time•ec
));

144 
	`do_ªÆtime
((
time•ec
 *)
tv
);

145 
tv
->
tv_u£c
 /= 1000;

147 i‡(
	`u∆ikñy
(
tz
 !
NULL
)) {

149 
tz
->
tz_möuãswe°
 = 
gtod
->
sys_tz
.tz_minuteswest;

150 
tz
->
tz_d°time
 = 
gtod
->
sys_tz
.tz_dsttime;

154 
	`asm
("sysˇŒ" : "˜" (
ªt
) :

155 "0" (
__NR_gëtimeofday
), "D" (
tv
), "S" (
tz
) : "memory");

156  
ªt
;

157 
	}
}

158 
	$gëtimeofday
(
timevÆ
 *, 
timez⁄e
 *)

159 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_gettimeofday")));

	@/cmpt816/linux/arch/x86/vdso/vgetcpu.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/gë˝u.h
>

10 
	~<löux/jiffõs.h
>

11 
	~<löux/time.h
>

12 
	~<asm/vsysˇŒ.h
>

13 
	~<asm/vgtod.h
>

14 
	~"vexã∫.h
"

16 
nŸø˚
 

17 
	$__vdso_gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
unu£d
)

19 
p
;

21 i‡(*
vdso_vgë˝u_mode
 =
VGETCPU_RDTSCP
) {

23 
	`«tive_ªad_ts˝
(&
p
);

26 
	`asm
("l¶ %1,%0" : "Ù" (
p
Ë: "r" (
__PER_CPU_SEG
));

28 i‡(
˝u
)

29 *
˝u
 = 
p
 & 0xfff;

30 i‡(
node
)

31 *
node
 = 
p
 >> 12;

33 
	}
}

35 
	$gë˝u
(*
˝u
, *
node
, 
gë˝u_ˇche
 *
tˇche
)

36 
	`__©åibuã__
((
wók
, 
	`Æüs
("__vdso_getcpu")));

	@/cmpt816/linux/arch/x86/vdso/vma.c

6 
	~<löux/mm.h
>

7 
	~<löux/îr.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/øndom.h
>

12 
	~<löux/ñf.h
>

13 
	~<asm/vsysˇŒ.h
>

14 
	~<asm/vgtod.h
>

15 
	~<asm/¥Ÿo.h
>

16 
	~<asm/vdso.h
>

18 
	~"vexã∫.h
"

19 #unde‡
VEXTERN


21 
__ªad_mo°ly
 
	gvdso_íabÀd
 = 1;

23 
vdso_°¨t
[], 
vdso_íd
[];

24 
vdso_sync_˝uid
;

26 
∑ge
 **
	gvdso_∑ges
;

27 
	gvdso_size
;

29 
ölöe
 *
	$v¨_ªf
(*
p
, *
«me
)

31 i‡(*(**)
p
 !(*)
VMAGIC
) {

32 
	`¥ötk
("VDSO: v¨übÀ %†brokí\n", 
«me
);

33 
vdso_íabÀd
 = 0;

35  
p
;

36 
	}
}

38 
__öô
 
	$öô_vdso_v¨s
()

40 
≈ages
 = (
vdso_íd
 - 
vdso_°¨t
 + 
PAGE_SIZE
 - 1) / PAGE_SIZE;

41 
i
;

42 *
vba£
;

44 
vdso_size
 = 
≈ages
 << 
PAGE_SHIFT
;

45 
vdso_∑ges
 = 
	`kmÆloc
((
∑ge
 *Ë* 
≈ages
, 
GFP_KERNEL
);

46 i‡(!
vdso_∑ges
)

47 
oom
;

48 
i
 = 0; i < 
≈ages
; i++) {

49 
∑ge
 *
p
;

50 
p
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

51 i‡(!
p
)

52 
oom
;

53 
vdso_∑ges
[
i
] = 
p
;

54 
	`c›y_∑ge
(
	`∑ge_addªss
(
p
), 
vdso_°¨t
 + 
i
*
PAGE_SIZE
);

57 
vba£
 = 
	`vm≠
(
vdso_∑ges
, 
≈ages
, 0, 
PAGE_KERNEL
);

58 i‡(!
vba£
)

59 
oom
;

61 i‡(
	`memcmp
(
vba£
, "\177ELF", 4)) {

62 
	`¥ötk
("VDSO: I'm broken;Çot ELF\n");

63 
vdso_íabÀd
 = 0;

66 
	#VEXTERN
(
x
) \

67 *(
	`ty≥of
(
__
 ## 
x
Ë**Ë
	`v¨_ªf
(
	`VDSO64_SYMBOL
(
vba£
, x), #xË&__ ## x;

	)

68 
	~"vexã∫.h
"

69 #unde‡
VEXTERN


72 
oom
:

73 
	`¥ötk
("Cannotállocate vdso\n");

74 
vdso_íabÀd
 = 0;

75  -
ENOMEM
;

76 
	}
}

77 
__öôˇŒ
(
öô_vdso_v¨s
);

79 
	glöux_bö¥m
;

85 
	$vdso_addr
(
°¨t
, 
Àn
)

87 
addr
, 
íd
;

88 
off£t
;

89 
íd
 = (
°¨t
 + 
PMD_SIZE
 - 1Ë& 
PMD_MASK
;

90 i‡(
íd
 >
TASK_SIZE_MAX
)

91 
íd
 = 
TASK_SIZE_MAX
;

92 
íd
 -
Àn
;

94 
off£t
 = 
	`gë_øndom_öt
(Ë& (
PTRS_PER_PTE
 - 1);

95 
addr
 = 
°¨t
 + (
off£t
 << 
PAGE_SHIFT
);

96 i‡(
addr
 >
íd
)

97 
addr
 = 
íd
;

98  
addr
;

99 
	}
}

103 
	$¨ch_£tup_addôi⁄Æ_∑ges
(
löux_bö¥m
 *
b¥m
, 
u£s_öãΩ
)

105 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

106 
addr
;

107 
ªt
;

109 i‡(!
vdso_íabÀd
)

112 
	`down_wrôe
(&
mm
->
mm≠_£m
);

113 
addr
 = 
	`vdso_addr
(
mm
->
°¨t_°ack
, 
vdso_size
);

114 
addr
 = 
	`gë_unm≠≥d_¨ó
(
NULL
,áddr, 
vdso_size
, 0, 0);

115 i‡(
	`IS_ERR_VALUE
(
addr
)) {

116 
ªt
 = 
addr
;

117 
up_Áû
;

120 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = (*)
addr
;

122 
ªt
 = 
	`ö°Æl_•ecül_m≠pög
(
mm
, 
addr
, 
vdso_size
,

123 
VM_READ
|
VM_EXEC
|

124 
VM_MAYREAD
|
VM_MAYWRITE
|
VM_MAYEXEC
|

125 
VM_ALWAYSDUMP
,

126 
vdso_∑ges
);

127 i‡(
ªt
) {

128 
cuºít
->
mm
->
c⁄ãxt
.
vdso
 = 
NULL
;

129 
up_Áû
;

132 
up_Áû
:

133 
	`up_wrôe
(&
mm
->
mm≠_£m
);

134  
ªt
;

135 
	}
}

137 
__öô
 
	$vdso_£tup
(*
s
)

139 
vdso_íabÀd
 = 
	`sim∂e_°πoul
(
s
, 
NULL
, 0);

141 
	}
}

142 
__£tup
("vdso=", 
vdso_£tup
);

	@/cmpt816/linux/arch/x86/vdso/vvar.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/time.h
>

7 
	~<asm/vsysˇŒ.h
>

8 
	~<asm/timex.h
>

9 
	~<asm/vgtod.h
>

11 
	#VEXTERN
(
x
Ë
	`ty≥of
 (
__
 ## xË*c⁄° 
vdso_
 ## x = (*)
VMAGIC
;

	)

12 
	~"vexã∫.h
"

	@/cmpt816/linux/init/calibrate.c

7 
	~<löux/jiffõs.h
>

8 
	~<löux/dñay.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/timex.h
>

11 
	~<löux/smp.h
>

13 
	gÕj_föe
;

14 
	g¥e£t_Õj
;

15 
__öô
 
	$Õj_£tup
(*
°r
)

17 
¥e£t_Õj
 = 
	`sim∂e_°πoul
(
°r
,
NULL
,0);

19 
	}
}

21 
__£tup
("Õj=", 
Õj_£tup
);

23 #ifde‡
ARCH_HAS_READ_CURRENT_TIMER


30 
	#DELAY_CALIBRATION_TICKS
 ((
HZ
 < 100Ë? 1 : (HZ/100))

	)

31 
	#MAX_DIRECT_CALIBRATION_RETRIES
 5

	)

33 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
()

35 
¥e_°¨t
, 
°¨t
, 
po°_°¨t
;

36 
¥e_íd
, 
íd
, 
po°_íd
;

37 
°¨t_jiffõs
;

38 
timî_øã_mö
, 
timî_øã_max
;

39 
good_timî_sum
 = 0;

40 
good_timî_cou¡
 = 0;

41 
i
;

43 i‡(
	`ªad_cuºít_timî
(&
¥e_°¨t
) < 0 )

65 
i
 = 0; i < 
MAX_DIRECT_CALIBRATION_RETRIES
; i++) {

66 
¥e_°¨t
 = 0;

67 
	`ªad_cuºít_timî
(&
°¨t
);

68 
°¨t_jiffõs
 = 
jiffõs
;

69 
jiffõs
 <(
°¨t_jiffõs
 + 1)) {

70 
¥e_°¨t
 = 
°¨t
;

71 
	`ªad_cuºít_timî
(&
°¨t
);

73 
	`ªad_cuºít_timî
(&
po°_°¨t
);

75 
¥e_íd
 = 0;

76 
íd
 = 
po°_°¨t
;

77 
jiffõs
 <=

78 (
°¨t_jiffõs
 + 1 + 
DELAY_CALIBRATION_TICKS
)) {

79 
¥e_íd
 = 
íd
;

80 
	`ªad_cuºít_timî
(&
íd
);

82 
	`ªad_cuºít_timî
(&
po°_íd
);

84 
timî_øã_max
 = (
po°_íd
 - 
¥e_°¨t
) /

85 
DELAY_CALIBRATION_TICKS
;

86 
timî_øã_mö
 = (
¥e_íd
 - 
po°_°¨t
) /

87 
DELAY_CALIBRATION_TICKS
;

93 i‡(
¥e_°¨t
 !0 && 
¥e_íd
 != 0 &&

94 (
timî_øã_max
 - 
timî_øã_mö
) < (timer_rate_max >> 3)) {

95 
good_timî_cou¡
++;

96 
good_timî_sum
 +
timî_øã_max
;

100 i‡(
good_timî_cou¡
)

101  (
good_timî_sum
/
good_timî_cou¡
);

103 
	`¥ötk
(
KERN_WARNING
 "calibrate_delay_direct() failedÅo getá good "

106 
	}
}

108 
__˝uöô
 
	$ˇlibøã_dñay_dúe˘
(Ë{ 0;
	}
}

120 
	#LPS_PREC
 8

	)

122 
__˝uöô
 
	$ˇlibøã_dñay
()

124 
ticks
, 
lo›bô
;

125 
Õs_¥ecisi⁄
 = 
LPS_PREC
;

126 
boﬁ
 
¥öãd
;

128 i‡(
¥e£t_Õj
) {

129 
lo›s_≥r_jiffy
 = 
¥e£t_Õj
;

130 i‡(!
¥öãd
)

131 
	`¥_öfo
("Calibrating delayÜoop (skipped) "

133 } i‡((!
¥öãd
Ë&& 
Õj_föe
) {

134 
lo›s_≥r_jiffy
 = 
Õj_föe
;

135 
	`¥_öfo
("Calibrating delayÜoop (skipped), "

137 } i‡((
lo›s_≥r_jiffy
 = 
	`ˇlibøã_dñay_dúe˘
()) != 0) {

138 i‡(!
¥öãd
)

139 
	`¥_öfo
("Calibrating delay usingÅimer "

142 
lo›s_≥r_jiffy
 = (1<<12);

144 i‡(!
¥öãd
)

145 
	`¥_öfo
("Calibrating delayÜoop... ");

146 (
lo›s_≥r_jiffy
 <<= 1) != 0) {

148 
ticks
 = 
jiffõs
;

149 
ticks
 =
jiffõs
)

152 
ticks
 = 
jiffõs
;

153 
	`__dñay
(
lo›s_≥r_jiffy
);

154 
ticks
 = 
jiffõs
 -Åicks;

155 i‡(
ticks
)

163 
lo›s_≥r_jiffy
 >>= 1;

164 
lo›bô
 = 
lo›s_≥r_jiffy
;

165 
Õs_¥ecisi⁄
-- && (
lo›bô
 >>= 1)) {

166 
lo›s_≥r_jiffy
 |
lo›bô
;

167 
ticks
 = 
jiffõs
;

168 
ticks
 =
jiffõs
)

170 
ticks
 = 
jiffõs
;

171 
	`__dñay
(
lo›s_≥r_jiffy
);

172 i‡(
jiffõs
 !
ticks
)

173 
lo›s_≥r_jiffy
 &~
lo›bô
;

176 i‡(!
¥öãd
)

177 
	`¥_c⁄t
("%lu.%02lu BogoMIPS (lpj=%lu)\n",

178 
lo›s_≥r_jiffy
/(500000/
HZ
),

179 (
lo›s_≥r_jiffy
/(5000/
HZ
)) % 100,Üoops_per_jiffy);

181 
¥öãd
 = 
åue
;

182 
	}
}

	@/cmpt816/linux/init/do_mounts.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/˘y≥.h
>

4 
	~<löux/fd.h
>

5 
	~<löux/ây.h
>

6 
	~<löux/su•íd.h
>

7 
	~<löux/roŸ_dev.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/gíhd.h
>

11 
	~<löux/mou¡.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/öôrd.h
>

16 
	~<löux/async.h
>

17 
	~<löux/fs_°ru˘.h
>

18 
	~<löux/¶ab.h
>

20 
	~<löux/nfs_fs.h
>

21 
	~<löux/nfs_fs_sb.h
>

22 
	~<löux/nfs_mou¡.h
>

24 
	~"do_mou¡s.h
"

26 
__öôd©a
 
	grd_dﬁﬂd
;

28 
	groŸ_mou¡Êags
 = 
MS_RDONLY
 | 
MS_SILENT
;

29 * 
__öôd©a
 
	groŸ_devi˚_«me
;

30 
__öôd©a
 
	gßved_roŸ_«me
[64];

31 
__öôd©a
 
	groŸ_waô
;

33 
dev_t
 
	gROOT_DEV
;

35 
__öô
 
	$lﬂd_ømdisk
(*
°r
)

37 
rd_dﬁﬂd
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 3;

39 
	}
}

40 
__£tup
("lﬂd_ømdisk=", 
lﬂd_ømdisk
);

42 
__öô
 
	$ªad⁄ly
(*
°r
)

44 i‡(*
°r
)

46 
roŸ_mou¡Êags
 |
MS_RDONLY
;

48 
	}
}

50 
__öô
 
	$ªadwrôe
(*
°r
)

52 i‡(*
°r
)

54 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

56 
	}
}

58 
__£tup
("ro", 
ªad⁄ly
);

59 
__£tup
("rw", 
ªadwrôe
);

78 
dev_t
 
	$«me_to_dev_t
(*
«me
)

80 
s
[32];

81 *
p
;

82 
dev_t
 
ªs
 = 0;

83 
∑π
;

85 i‡(
	`°∫cmp
(
«me
, "/dev/", 5) != 0) {

86 
maj
, 
mö
;

88 i‡(
	`ssˇnf
(
«me
, "%u:%u", &
maj
, &
mö
) == 2) {

89 
ªs
 = 
	`MKDEV
(
maj
, 
mö
);

90 i‡(
maj
 !
	`MAJOR
(
ªs
Ë|| 
mö
 !
	`MINOR
(res))

91 
Áû
;

93 
ªs
 = 
	`√w_decode_dev
(
	`sim∂e_°πoul
(
«me
, &
p
, 16));

94 i‡(*
p
)

95 
Áû
;

97 
d⁄e
;

100 
«me
 += 5;

101 
ªs
 = 
RoŸ_NFS
;

102 i‡(
	`°rcmp
(
«me
, "nfs") == 0)

103 
d⁄e
;

104 
ªs
 = 
RoŸ_RAM0
;

105 i‡(
	`°rcmp
(
«me
, "ram") == 0)

106 
d⁄e
;

108 i‡(
	`°æí
(
«me
) > 31)

109 
Áû
;

110 
	`°r˝y
(
s
, 
«me
);

111 
p
 = 
s
; *p;Ö++)

112 i‡(*
p
 == '/')

113 *
p
 = '!';

114 
ªs
 = 
	`blk_lookup_devt
(
s
, 0);

115 i‡(
ªs
)

116 
d⁄e
;

122 
p
 > 
s
 && 
	`isdigô
(p[-1]))

123 
p
--;

124 i‡(
p
 =
s
 || !*p || *p == '0')

125 
Áû
;

128 
∑π
 = 
	`sim∂e_°πoul
(
p
, 
NULL
, 10);

129 *
p
 = '\0';

130 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

131 i‡(
ªs
)

132 
d⁄e
;

135 i‡(
p
 < 
s
 + 2 || !
	`isdigô
(p[-2]) ||Ö[-1] != 'p')

136 
Áû
;

137 
p
[-1] = '\0';

138 
ªs
 = 
	`blk_lookup_devt
(
s
, 
∑π
);

139 i‡(
ªs
)

140 
d⁄e
;

142 
Áû
:

144 
d⁄e
:

145  
ªs
;

146 
	}
}

148 
__öô
 
	$roŸ_dev_£tup
(*
löe
)

150 
	`°æ˝y
(
ßved_roŸ_«me
, 
löe
, (saved_root_name));

152 
	}
}

154 
__£tup
("roŸ=", 
roŸ_dev_£tup
);

156 
__öô
 
	$roŸwaô_£tup
(*
°r
)

158 i‡(*
°r
)

160 
roŸ_waô
 = 1;

162 
	}
}

164 
__£tup
("roŸwaô", 
roŸwaô_£tup
);

166 * 
__öôd©a
 
	groŸ_mou¡_d©a
;

167 
__öô
 
	$roŸ_d©a_£tup
(*
°r
)

169 
roŸ_mou¡_d©a
 = 
°r
;

171 
	}
}

173 * 
__öôd©a
 
	groŸ_fs_«mes
;

174 
__öô
 
	$fs_«mes_£tup
(*
°r
)

176 
roŸ_fs_«mes
 = 
°r
;

178 
	}
}

180 
__öôd©a
 
	groŸ_dñay
;

181 
__öô
 
	$roŸ_dñay_£tup
(*
°r
)

183 
roŸ_dñay
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 0);

185 
	}
}

187 
__£tup
("roŸÊags=", 
roŸ_d©a_£tup
);

188 
__£tup
("roŸf°y≥=", 
fs_«mes_£tup
);

189 
__£tup
("roŸdñay=", 
roŸ_dñay_£tup
);

191 
__öô
 
	$gë_fs_«mes
(*
∑ge
)

193 *
s
 = 
∑ge
;

195 i‡(
roŸ_fs_«mes
) {

196 
	`°r˝y
(
∑ge
, 
roŸ_fs_«mes
);

197 *
s
++) {

198 i‡(
s
[-1] == ',')

199 
s
[-1] = '\0';

202 
Àn
 = 
	`gë_fûesy°em_li°
(
∑ge
);

203 *
p
, *
√xt
;

205 
∑ge
[
Àn
] = '\0';

206 
p
 = 
∑ge
-1;Ö;Ö = 
√xt
) {

207 
√xt
 = 
	`°rchr
(++
p
, '\n');

208 i‡(*
p
++ != '\t')

210 (*
s
++ = *
p
++) != '\n')

212 
s
[-1] = '\0';

215 *
s
 = '\0';

216 
	}
}

218 
__öô
 
	$do_mou¡_roŸ
(*
«me
, *
fs
, 
Êags
, *
d©a
)

220 
îr
 = 
	`sys_mou¡
(
«me
, "/roŸ", 
fs
, 
Êags
, 
d©a
);

221 i‡(
îr
)

222  
îr
;

224 
	`sys_chdú
("/root");

225 
ROOT_DEV
 = 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_dev
;

226 
	`¥ötk
("VFS: MountedÑoot (%s filesystem)%s on device %u:%u.\n",

227 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_ty≥
->
«me
,

228 
cuºít
->
fs
->
pwd
.
m¡
->
m¡_sb
->
s_Êags
 & 
MS_RDONLY
 ?

229 "Ñód⁄ly" : "", 
	`MAJOR
(
ROOT_DEV
), 
	`MINOR
(ROOT_DEV));

231 
	}
}

233 
__öô
 
	$mou¡_block_roŸ
(*
«me
, 
Êags
)

235 *
fs_«mes
 = 
	`__gë«me_gÂ
(
GFP_KERNEL


236 | 
__GFP_NOTRACK_FALSE_POSITIVE
);

237 *
p
;

238 #ifde‡
CONFIG_BLOCK


239 
b
[
BDEVNAME_SIZE
];

241 c⁄° *
b
 = 
«me
;

244 
	`gë_fs_«mes
(
fs_«mes
);

245 
ªåy
:

246 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1) {

247 
îr
 = 
	`do_mou¡_roŸ
(
«me
, 
p
, 
Êags
, 
roŸ_mou¡_d©a
);

248 
îr
) {

250 
out
;

251 -
EACCES
:

252 
Êags
 |
MS_RDONLY
;

253 
ªåy
;

254 -
EINVAL
:

262 #ifde‡
CONFIG_BLOCK


263 
	`__bdev«me
(
ROOT_DEV
, 
b
);

265 
	`¥ötk
("VFS: Cannot openÑoot device \"%s\" or %s\n",

266 
roŸ_devi˚_«me
, 
b
);

267 
	`¥ötk
("Pleaseáppendá correct \"root=\" boot option; hereáreÅheávailableÖartitions:\n");

269 
	`¥ötk_Æl_∑πôi⁄s
();

270 #ifde‡
CONFIG_DEBUG_BLOCK_EXT_DEVT


271 
	`¥ötk
("DEBUG_BLOCK_EXT_DEVT isÉnabled, youÇeedÅo specify "

274 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

277 
	`¥ötk
("List ofállÖartitions:\n");

278 
	`¥ötk_Æl_∑πôi⁄s
();

279 
	`¥ötk
("No filesystem could mountÑoot,Åried: ");

280 
p
 = 
fs_«mes
; *p;Ö +
	`°æí
(p)+1)

281 
	`¥ötk
(" %s", 
p
);

282 
	`¥ötk
("\n");

283 #ifde‡
CONFIG_BLOCK


284 
	`__bdev«me
(
ROOT_DEV
, 
b
);

286 
	`∑nic
("VFS: U«bÀÅÿmou¡ÑoŸ f†⁄ %s", 
b
);

287 
out
:

288 
	`puäame
(
fs_«mes
);

289 
	}
}

291 #ifde‡
CONFIG_ROOT_NFS


292 
__öô
 
	$mou¡_nfs_roŸ
()

294 *
d©a
 = 
	`nfs_roŸ_d©a
();

296 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

297 i‡(
d©a
 &&

298 
	`do_mou¡_roŸ
("/dev/roŸ", "nfs", 
roŸ_mou¡Êags
, 
d©a
) == 0)

301 
	}
}

304 #i‡
deföed
(
CONFIG_BLK_DEV_RAM
Ë|| deföed(
CONFIG_BLK_DEV_FD
)

305 
__öô
 
	$ch™ge_Ê›py
(*
fmt
, ...)

307 
ãrmios
Åermios;

308 
buf
[80];

309 
c
;

310 
fd
;

311 
va_li°
 
¨gs
;

312 
	`va_°¨t
(
¨gs
, 
fmt
);

313 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

314 
	`va_íd
(
¨gs
);

315 
fd
 = 
	`sys_›í
("/dev/roŸ", 
O_RDWR
 | 
O_NDELAY
, 0);

316 i‡(
fd
 >= 0) {

317 
	`sys_io˘l
(
fd
, 
FDEJECT
, 0);

318 
	`sys_˛o£
(
fd
);

320 
	`¥ötk
(
KERN_NOTICE
 "VFS: In£π %†™dÖªs†ENTER\n", 
buf
);

321 
fd
 = 
	`sys_›í
("/dev/c⁄sﬁe", 
O_RDWR
, 0);

322 i‡(
fd
 >= 0) {

323 
	`sys_io˘l
(
fd
, 
TCGETS
, ()&
ãrmios
);

324 
ãrmios
.
c_lÊag
 &~
ICANON
;

325 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

326 
	`sys_ªad
(
fd
, &
c
, 1);

327 
ãrmios
.
c_lÊag
 |
ICANON
;

328 
	`sys_io˘l
(
fd
, 
TCSETSF
, ()&
ãrmios
);

329 
	`sys_˛o£
(
fd
);

331 
	}
}

334 
__öô
 
	$mou¡_roŸ
()

336 #ifde‡
CONFIG_ROOT_NFS


337 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
UNNAMED_MAJOR
) {

338 i‡(
	`mou¡_nfs_roŸ
())

341 
	`¥ötk
(
KERN_ERR
 "VFS: UnableÅo mountÑoot fs via NFS,Årying floppy.\n");

342 
ROOT_DEV
 = 
RoŸ_FD0
;

345 #ifde‡
CONFIG_BLK_DEV_FD


346 i‡(
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
) {

348 i‡(
rd_dﬁﬂd
==2) {

349 i‡(
	`rd_lﬂd_disk
(1)) {

350 
ROOT_DEV
 = 
RoŸ_RAM1
;

351 
roŸ_devi˚_«me
 = 
NULL
;

354 
	`ch™ge_Ê›py
("root floppy");

357 #ifde‡
CONFIG_BLOCK


358 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

359 
	`mou¡_block_roŸ
("/dev/roŸ", 
roŸ_mou¡Êags
);

361 
	}
}

366 
__öô
 
	$¥ï¨e_«me•a˚
()

368 
is_Ê›py
;

370 i‡(
roŸ_dñay
) {

371 
	`¥ötk
(
KERN_INFO
 "Waiting %dsec before mountingÑoot device...\n",

372 
roŸ_dñay
);

373 
	`s¶ìp
(
roŸ_dñay
);

383 
	`waô_f‹_devi˚_¥obe
();

385 
	`md_run_£tup
();

387 i‡(
ßved_roŸ_«me
[0]) {

388 
roŸ_devi˚_«me
 = 
ßved_roŸ_«me
;

389 i‡(!
	`°∫cmp
(
roŸ_devi˚_«me
, "mtd", 3) ||

390 !
	`°∫cmp
(
roŸ_devi˚_«me
, "ubi", 3)) {

391 
	`mou¡_block_roŸ
(
roŸ_devi˚_«me
, 
roŸ_mou¡Êags
);

392 
out
;

394 
ROOT_DEV
 = 
	`«me_to_dev_t
(
roŸ_devi˚_«me
);

395 i‡(
	`°∫cmp
(
roŸ_devi˚_«me
, "/dev/", 5) == 0)

396 
roŸ_devi˚_«me
 += 5;

399 i‡(
	`öôrd_lﬂd
())

400 
out
;

403 i‡((
ROOT_DEV
 =0Ë&& 
roŸ_waô
) {

404 
	`¥ötk
(
KERN_INFO
 "Waiting forÑoot device %s...\n",

405 
ßved_roŸ_«me
);

406 
	`drivî_¥obe_d⁄e
() != 0 ||

407 (
ROOT_DEV
 = 
	`«me_to_dev_t
(
ßved_roŸ_«me
)) == 0)

408 
	`m¶ìp
(100);

409 
	`async_synchr⁄ize_fuŒ
();

412 
is_Ê›py
 = 
	`MAJOR
(
ROOT_DEV
Ë=
FLOPPY_MAJOR
;

414 i‡(
is_Ê›py
 && 
rd_dﬁﬂd
 && 
	`rd_lﬂd_disk
(0))

415 
ROOT_DEV
 = 
RoŸ_RAM0
;

417 
	`mou¡_roŸ
();

418 
out
:

419 
	`devtmpfs_mou¡
("dev");

420 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

421 
	`sys_chroŸ
(".");

422 
	}
}

	@/cmpt816/linux/init/do_mounts_initrd.c

1 
	~<löux/uni°d.h
>

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/öôrd.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/‰ìzî.h
>

11 
	~"do_mou¡s.h
"

13 
	göôrd_°¨t
, 
	göôrd_íd
;

14 
	göôrd_bñow_°¨t_ok
;

15 
	gªÆ_roŸ_dev
;

16 
__öôd©a
 
	gﬁd_fd
, 
	groŸ_fd
;

17 
__öôd©a
 
	gmou¡_öôrd
 = 1;

19 
__öô
 
	$no_öôrd
(*
°r
)

21 
mou¡_öôrd
 = 0;

23 
	}
}

25 
__£tup
("noöôrd", 
no_öôrd
);

27 
__öô
 
	$do_löuxrc
(* 
shñl
)

29 *
¨gv
[] = { "löuxrc", 
NULL
, };

30 * 
ívp_öô
[];

32 
	`sys_˛o£
(
ﬁd_fd
);sys_˛o£(
roŸ_fd
);

33 
	`sys_£tsid
();

34  
	`kî√l_execve
(
shñl
, 
¨gv
, 
ívp_öô
);

35 
	}
}

37 
__öô
 
	$h™dÀ_öôrd
()

39 
îr‹
;

40 
pid
;

42 
ªÆ_roŸ_dev
 = 
	`√w_ícode_dev
(
ROOT_DEV
);

43 
	`¸óã_dev
("/dev/roŸ.ﬁd", 
RoŸ_RAM0
);

45 
	`mou¡_block_roŸ
("/dev/roŸ.ﬁd", 
roŸ_mou¡Êags
 & ~
MS_RDONLY
);

46 
	`sys_mkdú
("/old", 0700);

47 
roŸ_fd
 = 
	`sys_›í
("/", 0, 0);

48 
ﬁd_fd
 = 
	`sys_›í
("/old", 0, 0);

50 
	`sys_chdú
("/root");

51 
	`sys_mou¡
(".", "/", 
NULL
, 
MS_MOVE
, NULL);

52 
	`sys_chroŸ
(".");

58 
cuºít
->
Êags
 |
PF_FREEZER_SKIP
;

60 
pid
 = 
	`kî√l_thªad
(
do_löuxrc
, "/löuxrc", 
SIGCHLD
);

61 i‡(
pid
 > 0)

62 
pid
 !
	`sys_waô4
(-1, 
NULL
, 0, NULL))

63 
	`yõld
();

65 
cuºít
->
Êags
 &~
PF_FREEZER_SKIP
;

68 
	`sys_fchdú
(
ﬁd_fd
);

69 
	`sys_mou¡
("/", ".", 
NULL
, 
MS_MOVE
, NULL);

71 
	`sys_fchdú
(
roŸ_fd
);

72 
	`sys_chroŸ
(".");

73 
	`sys_˛o£
(
ﬁd_fd
);

74 
	`sys_˛o£
(
roŸ_fd
);

76 i‡(
	`√w_decode_dev
(
ªÆ_roŸ_dev
Ë=
RoŸ_RAM0
) {

77 
	`sys_chdú
("/old");

81 
ROOT_DEV
 = 
	`√w_decode_dev
(
ªÆ_roŸ_dev
);

82 
	`mou¡_roŸ
();

84 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo move oldÑootÅo /initrd ... ");

85 
îr‹
 = 
	`sys_mou¡
("/ﬁd", "/roŸ/öôrd", 
NULL
, 
MS_MOVE
, NULL);

86 i‡(!
îr‹
)

87 
	`¥ötk
("okay\n");

89 
fd
 = 
	`sys_›í
("/dev/roŸ.ﬁd", 
O_RDWR
, 0);

90 i‡(
îr‹
 =-
ENOENT
)

91 
	`¥ötk
("/initrd doesÇotÉxist. Ignored.\n");

93 
	`¥ötk
("failed\n");

94 
	`¥ötk
(
KERN_NOTICE
 "Unmounting oldÑoot\n");

95 
	`sys_umou¡
("/ﬁd", 
MNT_DETACH
);

96 
	`¥ötk
(
KERN_NOTICE
 "TryingÅo freeÑamdisk memory ... ");

97 i‡(
fd
 < 0) {

98 
îr‹
 = 
fd
;

100 
îr‹
 = 
	`sys_io˘l
(
fd
, 
BLKFLSBUF
, 0);

101 
	`sys_˛o£
(
fd
);

103 
	`¥ötk
(!
îr‹
 ? "okay\n" : "failed\n");

105 
	}
}

107 
__öô
 
	$öôrd_lﬂd
()

109 i‡(
mou¡_öôrd
) {

110 
	`¸óã_dev
("/dev/øm", 
RoŸ_RAM0
);

117 i‡(
	`rd_lﬂd_image
("/öôrd.image"Ë&& 
ROOT_DEV
 !
RoŸ_RAM0
) {

118 
	`sys_u∆ök
("/initrd.image");

119 
	`h™dÀ_öôrd
();

123 
	`sys_u∆ök
("/initrd.image");

125 
	}
}

	@/cmpt816/linux/init/do_mounts_md.c

1 
	~<löux/dñay.h
>

2 
	~<löux/øid/md_u.h
>

3 
	~<löux/øid/md_p.h
>

5 
	~"do_mou¡s.h
"

16 #ifde‡
CONFIG_MD_AUTODETECT


17 
__öôd©a
 
	gøid_nﬂutodëe˘
;

19 
__öôd©a
 
	gøid_nﬂutodëe˘
=1;

21 
__öôd©a
 
	gøid_aut›¨t
;

24 
	mmö‹
;

25 
	m∑πôi⁄ed
;

26 
	mÀvñ
;

27 
	mchunk
;

28 *
	mdevi˚_«mes
;

29 } 
	gmd_£tup_¨gs
[256] 
	g__öôd©a
;

31 
md_£tup_íts
 
	g__öôd©a
;

53 
__öô
 
	$md_£tup
(*
°r
)

55 
mö‹
, 
Àvñ
, 
Á˘‹
, 
Áu…
, 
∑πôi⁄ed
 = 0;

56 *
≥∫ame
 = "";

57 *
°r1
;

58 
ít
;

60 i‡(*
°r
 == 'd') {

61 
∑πôi⁄ed
 = 1;

62 
°r
++;

64 i‡(
	`gë_›ti⁄
(&
°r
, &
mö‹
) != 2) {

65 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

68 
°r1
 = 
°r
;

69 
ít
=0 ;É¡< 
md_£tup_íts
 ;Ént++)

70 i‡(
md_£tup_¨gs
[
ít
].
mö‹
 == minor &&

71 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 ==Öartitioned) {

72 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d, Specified moreÅhan once. "

73 "RïœcögÖªviou†deföôi⁄.\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

76 i‡(
ít
 >
	`ARRAY_SIZE
(
md_£tup_¨gs
)) {

77 
	`¥ötk
(
KERN_WARNING
 "md: md=%s%d -Åoÿm™y md inôülißti⁄s\n", 
∑πôi⁄ed
?"d":"", 
mö‹
);

80 i‡(
ít
 >
md_£tup_íts
)

81 
md_£tup_íts
++;

82 
	`gë_›ti⁄
(&
°r
, &
Àvñ
)) {

84 i‡(
Àvñ
 =0 ||Üevñ =
LEVEL_LINEAR
) {

85 i‡(
	`gë_›ti⁄
(&
°r
, &
Á˘‹
) != 2 ||

86 
	`gë_›ti⁄
(&
°r
, &
Áu…
) != 2) {

87 
	`¥ötk
(
KERN_WARNING
 "md: Too fewárguments suppliedÅo md=.\n");

90 
md_£tup_¨gs
[
ít
].
Àvñ
 =Üevel;

91 
md_£tup_¨gs
[
ít
].
chunk
 = 1 << (
Á˘‹
+12);

92 i‡(
Àvñ
 =
LEVEL_LINEAR
)

93 
≥∫ame
 = "linear";

95 
≥∫ame
 = "raid0";

100 
°r
 = 
°r1
;

103 
md_£tup_¨gs
[
ít
].
Àvñ
 = 
LEVEL_NONE
;

104 
≥∫ame
="super-block";

107 
	`¥ötk
(
KERN_INFO
 "md: Will configure md%d (%s) from %s, below.\n",

108 
mö‹
, 
≥∫ame
, 
°r
);

109 
md_£tup_¨gs
[
ít
].
devi˚_«mes
 = 
°r
;

110 
md_£tup_¨gs
[
ít
].
∑πôi⁄ed
 =Öartitioned;

111 
md_£tup_¨gs
[
ít
].
mö‹
 = minor;

114 
	}
}

116 
__öô
 
	$md_£tup_drive
()

118 
mö‹
, 
i
, 
ít
, 
∑πôi⁄ed
;

119 
dev_t
 
dev
;

120 
dev_t
 
devi˚s
[
MD_SB_DISKS
+1];

122 
ít
 = 0;É¡ < 
md_£tup_íts
 ;Ént++) {

123 
fd
;

124 
îr
 = 0;

125 *
dev«me
;

126 
mdu_disk_öfo_t
 
döfo
;

127 
«me
[16];

129 
mö‹
 = 
md_£tup_¨gs
[
ít
].minor;

130 
∑πôi⁄ed
 = 
md_£tup_¨gs
[
ít
].partitioned;

131 
dev«me
 = 
md_£tup_¨gs
[
ít
].
devi˚_«mes
;

133 
	`•rötf
(
«me
, "/dev/md%s%d", 
∑πôi⁄ed
?"_d":"", 
mö‹
);

134 i‡(
∑πôi⁄ed
)

135 
dev
 = 
	`MKDEV
(
mdp_maj‹
, 
mö‹
 << 
MdpMö‹Shi·
);

137 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
mö‹
);

138 
	`¸óã_dev
(
«me
, 
dev
);

139 
i
 = 0; i < 
MD_SB_DISKS
 && 
dev«me
 !
NULL
; i++) {

140 *
p
;

141 
comp_«me
[64];

142 
u32
 
rdev
;

144 
p
 = 
	`°rchr
(
dev«me
, ',');

145 i‡(
p
)

146 *
p
++ = 0;

148 
dev
 = 
	`«me_to_dev_t
(
dev«me
);

149 i‡(
	`°∫cmp
(
dev«me
, "/dev/", 5) == 0)

150 
dev«me
 += 5;

151 
	`¢¥ötf
(
comp_«me
, 63, "/dev/%s", 
dev«me
);

152 
rdev
 = 
	`b°©
(
comp_«me
);

153 i‡(
rdev
)

154 
dev
 = 
	`√w_decode_dev
(
rdev
);

155 i‡(!
dev
) {

156 
	`¥ötk
(
KERN_WARNING
 "md: Unknow¿devi˚Çame: %s\n", 
dev«me
);

160 
devi˚s
[
i
] = 
dev
;

162 
dev«me
 = 
p
;

164 
devi˚s
[
i
] = 0;

166 i‡(!
i
)

169 
	`¥ötk
(
KERN_INFO
 "md: Loading md%s%d: %s\n",

170 
∑πôi⁄ed
 ? "_d" : "", 
mö‹
,

171 
md_£tup_¨gs
[
ít
].
devi˚_«mes
);

173 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

174 i‡(
fd
 < 0) {

175 
	`¥ötk
(
KERN_ERR
 "md: open failed - cannot start "

176 "¨øy %s\n", 
«me
);

179 i‡(
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, 0Ë=-
EBUSY
) {

180 
	`¥ötk
(
KERN_WARNING


182 
mö‹
);

183 
	`sys_˛o£
(
fd
);

187 i‡(
md_£tup_¨gs
[
ít
].
Àvñ
 !
LEVEL_NONE
) {

189 
mdu_¨øy_öfo_t
 
aöfo
;

190 
aöfo
.
Àvñ
 = 
md_£tup_¨gs
[
ít
].level;

191 
aöfo
.
size
 = 0;

192 
aöfo
.
ƒ_disks
 =0;

193 
aöfo
.
øid_disks
 =0;

194 
devi˚s
[
aöfo
.
øid_disks
])

195 
aöfo
.
øid_disks
++;

196 
aöfo
.
md_mö‹
 =
mö‹
;

197 
aöfo
.
nŸ_≥rsi°ít
 = 1;

199 
aöfo
.
°©e
 = (1 << 
MD_SB_CLEAN
);

200 
aöfo
.
œyout
 = 0;

201 
aöfo
.
chunk_size
 = 
md_£tup_¨gs
[
ít
].
chunk
;

202 
îr
 = 
	`sys_io˘l
(
fd
, 
SET_ARRAY_INFO
, ()&
aöfo
);

203 
i
 = 0; !
îr
 && i <
MD_SB_DISKS
; i++) {

204 
dev
 = 
devi˚s
[
i
];

205 i‡(!
dev
)

207 
döfo
.
numbî
 = 
i
;

208 
döfo
.
øid_disk
 = 
i
;

209 
döfo
.
°©e
 = (1<<
MD_DISK_ACTIVE
)|(1<<
MD_DISK_SYNC
);

210 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

211 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

212 
îr
 = 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

216 
i
 = 0; i <
MD_SB_DISKS
; i++) {

217 
dev
 = 
devi˚s
[
i
];

218 i‡(!
dev
)

220 
döfo
.
maj‹
 = 
	`MAJOR
(
dev
);

221 
döfo
.
mö‹
 = 
	`MINOR
(
dev
);

222 
	`sys_io˘l
(
fd
, 
ADD_NEW_DISK
, ()&
döfo
);

225 i‡(!
îr
)

226 
îr
 = 
	`sys_io˘l
(
fd
, 
RUN_ARRAY
, 0);

227 i‡(
îr
)

228 
	`¥ötk
(
KERN_WARNING
 "md: sèπög md%d faûed\n", 
mö‹
);

235 
	`sys_˛o£
(
fd
);

236 
fd
 = 
	`sys_›í
(
«me
, 0, 0);

237 
	`sys_io˘l
(
fd
, 
BLKRRPART
, 0);

239 
	`sys_˛o£
(
fd
);

241 
	}
}

243 
__öô
 
	$øid_£tup
(*
°r
)

245 
Àn
, 
pos
;

247 
Àn
 = 
	`°æí
(
°r
) + 1;

248 
pos
 = 0;

250 
pos
 < 
Àn
) {

251 *
comma
 = 
	`°rchr
(
°r
+
pos
, ',');

252 
wÀn
;

253 i‡(
comma
)

254 
wÀn
 = (
comma
-
°r
)-
pos
;

255 
wÀn
 = (
Àn
-1)-
pos
;

257 i‡(!
	`°∫cmp
(
°r
, "nﬂutodëe˘", 
wÀn
))

258 
øid_nﬂutodëe˘
 = 1;

259 i‡(!
	`°∫cmp
(
°r
, "autodëe˘", 
wÀn
))

260 
øid_nﬂutodëe˘
 = 0;

261 i‡(
	`°∫cmp
(
°r
, "∑πôi⁄abÀ", 
wÀn
)==0)

262 
øid_aut›¨t
 = 1;

263 i‡(
	`°∫cmp
(
°r
, "∑π", 
wÀn
)==0)

264 
øid_aut›¨t
 = 1;

265 
pos
 +
wÀn
+1;

268 
	}
}

270 
__£tup
("øid=", 
øid_£tup
);

271 
__£tup
("md=", 
md_£tup
);

273 
__öô
 
	$autodëe˘_øid
()

275 
fd
;

281 
	`¥ötk
(
KERN_INFO
 "md: Waiting foráll devicesÅo beávailable beforeáutodetect\n");

282 
	`¥ötk
(
KERN_INFO
 "md: If you don't useÑaid, useÑaid=noautodetect\n");

284 
	`waô_f‹_devi˚_¥obe
();

286 
fd
 = 
	`sys_›í
("/dev/md0", 0, 0);

287 i‡(
fd
 >= 0) {

288 
	`sys_io˘l
(
fd
, 
RAID_AUTORUN
, 
øid_aut›¨t
);

289 
	`sys_˛o£
(
fd
);

291 
	}
}

293 
__öô
 
	$md_run_£tup
()

295 
	`¸óã_dev
("/dev/md0", 
	`MKDEV
(
MD_MAJOR
, 0));

297 i‡(
øid_nﬂutodëe˘
)

298 
	`¥ötk
(
KERN_INFO
 "md: Skippingáutodetection of RAIDárrays. (raid=autodetect will force)\n");

300 
	`autodëe˘_øid
();

301 
	`md_£tup_drive
();

302 
	}
}

	@/cmpt816/linux/init/do_mounts_rd.c

2 
	~<löux/kî√l.h
>

3 
	~<löux/fs.h
>

4 
	~<löux/möix_fs.h
>

5 
	~<löux/ext2_fs.h
>

6 
	~<löux/romfs_fs.h
>

7 
	~<löux/¸amfs_fs.h
>

8 
	~<löux/öôrd.h
>

9 
	~<löux/°rög.h
>

10 
	~<löux/¶ab.h
>

12 
	~"do_mou¡s.h
"

13 
	~"../fs/squashfs/squashfs_fs.h
"

15 
	~<löux/decom¥ess/gíîic.h
>

18 
__öôd©a
 
	grd_¥om±
 = 1;

20 
__öô
 
	$¥om±_ømdisk
(*
°r
)

22 
rd_¥om±
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0) & 1;

24 
	}
}

25 
__£tup
("¥om±_ømdisk=", 
¥om±_ømdisk
);

27 
__öôd©a
 
	grd_image_°¨t
;

29 
__öô
 
	$ømdisk_°¨t_£tup
(*
°r
)

31 
rd_image_°¨t
 = 
	`sim∂e_°πﬁ
(
°r
,
NULL
,0);

33 
	}
}

34 
__£tup
("ømdisk_°¨t=", 
ømdisk_°¨t_£tup
);

36 
__öô
 
¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
);

52 
__öô


53 
	$idítify_ømdisk_image
(
fd
, 
°¨t_block
, 
decom¥ess_‚
 *
decom¥ess‹
)

55 c⁄° 
size
 = 512;

56 
möix_su≥r_block
 *
möixsb
;

57 
ext2_su≥r_block
 *
ext2sb
;

58 
romfs_su≥r_block
 *
romfsb
;

59 
¸amfs_su≥r
 *
¸amfsb
;

60 
squashfs_su≥r_block
 *
squashfsb
;

61 
nblocks
 = -1;

62 *
buf
;

63 c⁄° *
com¥ess_«me
;

65 
buf
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

66 i‡(!
buf
)

69 
möixsb
 = (
möix_su≥r_block
 *Ë
buf
;

70 
ext2sb
 = (
ext2_su≥r_block
 *Ë
buf
;

71 
romfsb
 = (
romfs_su≥r_block
 *Ë
buf
;

72 
¸amfsb
 = (
¸amfs_su≥r
 *Ë
buf
;

73 
squashfsb
 = (
squashfs_su≥r_block
 *Ë
buf
;

74 
	`mem£t
(
buf
, 0xe5, 
size
);

79 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

80 
	`sys_ªad
(
fd
, 
buf
, 
size
);

82 *
decom¥ess‹
 = 
	`decom¥ess_mëhod
(
buf
, 
size
, &
com¥ess_«me
);

83 i‡(
com¥ess_«me
) {

84 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: %s image foundát block %d\n",

85 
com¥ess_«me
, 
°¨t_block
);

86 i‡(!*
decom¥ess‹
)

87 
	`¥ötk
(
KERN_EMERG


89 
com¥ess_«me
);

90 
nblocks
 = 0;

91 
d⁄e
;

95 i‡(
romfsb
->
w‹d0
 =
ROMSB_WORD0
 &&

96 
romfsb
->
w‹d1
 =
ROMSB_WORD1
) {

97 
	`¥ötk
(
KERN_NOTICE


99 
°¨t_block
);

100 
nblocks
 = (
	`¡ohl
(
romfsb
->
size
)+
BLOCK_SIZE
-1)>>
BLOCK_SIZE_BITS
;

101 
d⁄e
;

104 i‡(
¸amfsb
->
magic
 =
CRAMFS_MAGIC
) {

105 
	`¥ötk
(
KERN_NOTICE


107 
°¨t_block
);

108 
nblocks
 = (
¸amfsb
->
size
 + 
BLOCK_SIZE
 - 1Ë>> 
BLOCK_SIZE_BITS
;

109 
d⁄e
;

113 i‡(
	`À32_to_˝u
(
squashfsb
->
s_magic
Ë=
SQUASHFS_MAGIC
) {

114 
	`¥ötk
(
KERN_NOTICE


116 
°¨t_block
);

117 
nblocks
 = (
	`À64_to_˝u
(
squashfsb
->
byãs_u£d
Ë+ 
BLOCK_SIZE
 - 1)

118 >> 
BLOCK_SIZE_BITS
;

119 
d⁄e
;

125 
	`sys_l£ek
(
fd
, (
°¨t_block
+1Ë* 
BLOCK_SIZE
, 0);

126 
	`sys_ªad
(
fd
, 
buf
, 
size
);

129 i‡(
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC
 ||

130 
möixsb
->
s_magic
 =
MINIX_SUPER_MAGIC2
) {

131 
	`¥ötk
(
KERN_NOTICE


133 
°¨t_block
);

134 
nblocks
 = 
möixsb
->
s_nz⁄es
 << möixsb->
s_log_z⁄e_size
;

135 
d⁄e
;

139 i‡(
ext2sb
->
s_magic
 =
	`˝u_to_À16
(
EXT2_SUPER_MAGIC
)) {

140 
	`¥ötk
(
KERN_NOTICE


142 
°¨t_block
);

143 
nblocks
 = 
	`À32_to_˝u
(
ext2sb
->
s_blocks_cou¡
) <<

144 
	`À32_to_˝u
(
ext2sb
->
s_log_block_size
);

145 
d⁄e
;

148 
	`¥ötk
(
KERN_NOTICE


150 
°¨t_block
);

152 
d⁄e
:

153 
	`sys_l£ek
(
fd
, 
°¨t_block
 * 
BLOCK_SIZE
, 0);

154 
	`k‰ì
(
buf
);

155  
nblocks
;

156 
	}
}

158 
__öô
 
	$rd_lﬂd_image
(*
‰om
)

160 
ªs
 = 0;

161 
ö_fd
, 
out_fd
;

162 
rd_blocks
, 
devblocks
;

163 
nblocks
, 
i
, 
disk
;

164 *
buf
 = 
NULL
;

165 
rŸ©e
 = 0;

166 
decom¥ess_‚
 
decom¥ess‹
 = 
NULL
;

167 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

168 
rŸ©‹
[4] = { '|' , '/' , '-' , '\\' };

171 
out_fd
 = 
	`sys_›í
("/dev/øm", 
O_RDWR
, 0);

172 i‡(
out_fd
 < 0)

173 
out
;

175 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

176 i‡(
ö_fd
 < 0)

177 
no˛o£_öput
;

179 
nblocks
 = 
	`idítify_ømdisk_image
(
ö_fd
, 
rd_image_°¨t
, &
decom¥ess‹
);

180 i‡(
nblocks
 < 0)

181 
d⁄e
;

183 i‡(
nblocks
 == 0) {

184 i‡(
	`¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess‹
) == 0)

185 
suc˚ssful_lﬂd
;

186 
d⁄e
;

200 i‡(
	`sys_io˘l
(
out_fd
, 
BLKGETSIZE
, ()&
rd_blocks
) < 0)

201 
rd_blocks
 = 0;

203 
rd_blocks
 >>= 1;

205 i‡(
nblocks
 > 
rd_blocks
) {

206 
	`¥ötk
("RAMDISK: imageÅoo big! (%dKiB/%ldKiB)\n",

207 
nblocks
, 
rd_blocks
);

208 
d⁄e
;

214 i‡(
	`sys_io˘l
(
ö_fd
, 
BLKGETSIZE
, ()&
devblocks
) < 0)

215 
devblocks
 = 0;

217 
devblocks
 >>= 1;

219 i‡(
	`°rcmp
(
‰om
, "/initrd.image") == 0)

220 
devblocks
 = 
nblocks
;

222 i‡(
devblocks
 == 0) {

223 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇot determine device size\n");

224 
d⁄e
;

227 
buf
 = 
	`kmÆloc
(
BLOCK_SIZE
, 
GFP_KERNEL
);

228 i‡(!
buf
) {

229 
	`¥ötk
(
KERN_ERR
 "RAMDISK: couldÇotállocate buffer\n");

230 
d⁄e
;

233 
	`¥ötk
(
KERN_NOTICE
 "RAMDISK: Loading %dKiB [%ld disk%s] intoÑam disk... ",

234 
nblocks
, (“blocks-1)/
devblocks
)+1,Çblocks>devblocks ? "s" : "");

235 
i
 = 0, 
disk
 = 1; i < 
nblocks
; i++) {

236 i‡(
i
 && (ò% 
devblocks
 == 0)) {

237 
	`¥ötk
("d⁄êdisk #%d.\n", 
disk
++);

238 
rŸ©e
 = 0;

239 i‡(
	`sys_˛o£
(
ö_fd
)) {

240 
	`¥ötk
("Error closingÅhe disk.\n");

241 
no˛o£_öput
;

243 
	`ch™ge_Ê›py
("disk #%d", 
disk
);

244 
ö_fd
 = 
	`sys_›í
(
‰om
, 
O_RDONLY
, 0);

245 i‡(
ö_fd
 < 0) {

246 
	`¥ötk
("Error opening disk.\n");

247 
no˛o£_öput
;

249 
	`¥ötk
("Lﬂdög disk #%d... ", 
disk
);

251 
	`sys_ªad
(
ö_fd
, 
buf
, 
BLOCK_SIZE
);

252 
	`sys_wrôe
(
out_fd
, 
buf
, 
BLOCK_SIZE
);

253 #i‡!
	`deföed
(
CONFIG_S390
Ë&& !deföed(
CONFIG_PPC_ISERIES
)

254 i‡(!(
i
 % 16)) {

255 
	`¥ötk
("%c\b", 
rŸ©‹
[
rŸ©e
 & 0x3]);

256 
rŸ©e
++;

260 
	`¥ötk
("done.\n");

262 
suc˚ssful_lﬂd
:

263 
ªs
 = 1;

264 
d⁄e
:

265 
	`sys_˛o£
(
ö_fd
);

266 
no˛o£_öput
:

267 
	`sys_˛o£
(
out_fd
);

268 
out
:

269 
	`k‰ì
(
buf
);

270 
	`sys_u∆ök
("/dev/ram");

271  
ªs
;

272 
	}
}

274 
__öô
 
	$rd_lﬂd_disk
(
n
)

276 i‡(
rd_¥om±
)

277 
	`ch™ge_Ê›py
("root floppy diskÅo beÜoaded into RAM disk");

278 
	`¸óã_dev
("/dev/roŸ", 
ROOT_DEV
);

279 
	`¸óã_dev
("/dev/øm", 
	`MKDEV
(
RAMDISK_MAJOR
, 
n
));

280  
	`rd_lﬂd_image
("/dev/root");

281 
	}
}

283 
	gexô_code
;

284 
	gdecom¥ess_îr‹
;

285 
	g¸d_öfd
, 
	g¸d_outfd
;

287 
__öô
 
	$com¥_fûl
(*
buf
, 
Àn
)

289 
r
 = 
	`sys_ªad
(
¸d_öfd
, 
buf
, 
Àn
);

290 i‡(
r
 < 0)

291 
	`¥ötk
(
KERN_ERR
 "RAMDISK:Érror whileÑeading compressed data");

292 i‡(
r
 == 0)

293 
	`¥ötk
(
KERN_ERR
 "RAMDISK: EOF whileÑeading compressed data");

294  
r
;

295 
	}
}

297 
__öô
 
	$com¥_Êush
(*
wödow
, 
out˙t
)

299 
wrôãn
 = 
	`sys_wrôe
(
¸d_outfd
, 
wödow
, 
out˙t
);

300 i‡(
wrôãn
 !
out˙t
) {

301 i‡(
decom¥ess_îr‹
 == 0)

302 
	`¥ötk
(
KERN_ERR


304 
wrôãn
, 
out˙t
);

305 
decom¥ess_îr‹
 = 1;

308  
out˙t
;

309 
	}
}

311 
__öô
 
	$îr‹
(*
x
)

313 
	`¥ötk
(
KERN_ERR
 "%s\n", 
x
);

314 
exô_code
 = 1;

315 
decom¥ess_îr‹
 = 1;

316 
	}
}

318 
__öô
 
	$¸d_lﬂd
(
ö_fd
, 
out_fd
, 
decom¥ess_‚
 
deco
)

320 
ªsu…
;

321 
¸d_öfd
 = 
ö_fd
;

322 
¸d_outfd
 = 
out_fd
;

323 
ªsu…
 = 
	`deco
(
NULL
, 0, 
com¥_fûl
, 
com¥_Êush
, NULL, NULL, 
îr‹
);

324 i‡(
decom¥ess_îr‹
)

325 
ªsu…
 = 1;

326  
ªsu…
;

327 
	}
}

	@/cmpt816/linux/init/initramfs.c

1 
	~<löux/öô.h
>

2 
	~<löux/fs.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/ty≥s.h
>

5 
	~<löux/f˙é.h
>

6 
	~<löux/dñay.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/dúít.h
>

9 
	~<löux/sysˇŒs.h
>

10 
	~<löux/utime.h
>

12 
__öôd©a
 *
	gmesßge
;

13 
__öô
 
	$îr‹
(*
x
)

15 i‡(!
mesßge
)

16 
mesßge
 = 
x
;

17 
	}
}

21 
	#N_ALIGN
(
Àn
Ë(((÷íË+ 1Ë& ~3Ë+ 2)

	)

23 
__öôd©a
 
	shash
 {

24 
	möo
, 
	mmö‹
, 
	mmaj‹
;

25 
mode_t
 
	mmode
;

26 
hash
 *
	m√xt
;

27 
	m«me
[
N_ALIGN
(
PATH_MAX
)];

28 } *
	ghód
[32];

30 
ölöe
 
	$hash
(
maj‹
, 
mö‹
, 
öo
)

32 
tmp
 = 
öo
 + 
mö‹
 + (
maj‹
 << 3);

33 
tmp
 +=Åmp >> 5;

34  
tmp
 & 31;

35 
	}
}

37 
__öô
 *
	$föd_lök
(
maj‹
, 
mö‹
, 
öo
,

38 
mode_t
 
mode
, *
«me
)

40 
hash
 **
p
, *
q
;

41 
p
 = 
hód
 + 
	`hash
(
maj‹
, 
mö‹
, 
öo
); *p;Ö = &(*p)->
√xt
) {

42 i‡((*
p
)->
öo
 != ino)

44 i‡((*
p
)->
mö‹
 != minor)

46 i‡((*
p
)->
maj‹
 != major)

48 i‡(((*
p
)->
mode
 ^ modeË& 
S_IFMT
)

50  (*
p
)->
«me
;

52 
q
 = 
	`kmÆloc
((
hash
), 
GFP_KERNEL
);

53 i‡(!
q
)

54 
	`∑nic
("can'tállocateÜink hashÉntry");

55 
q
->
maj‹
 = major;

56 
q
->
mö‹
 = minor;

57 
q
->
öo
 = ino;

58 
q
->
mode
 = mode;

59 
	`°r˝y
(
q
->
«me
,Çame);

60 
q
->
√xt
 = 
NULL
;

61 *
p
 = 
q
;

62  
NULL
;

63 
	}
}

65 
__öô
 
	$‰ì_hash
()

67 
hash
 **
p
, *
q
;

68 
p
 = 
hód
;Ö < head + 32;Ö++) {

69 *
p
) {

70 
q
 = *
p
;

71 *
p
 = 
q
->
√xt
;

72 
	`k‰ì
(
q
);

75 
	}
}

77 
__öô
 
	$do_utime
(
__u£r
 *
fûíame
, 
time_t
 
mtime
)

79 
time•ec
 
t
[2];

81 
t
[0].
tv_£c
 = 
mtime
;

82 
t
[0].
tv_n£c
 = 0;

83 
t
[1].
tv_£c
 = 
mtime
;

84 
t
[1].
tv_n£c
 = 0;

86  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
t
, 
AT_SYMLINK_NOFOLLOW
);

87 
	}
}

89 
__öôd©a
 
LIST_HEAD
(
dú_li°
);

90 
	sdú_íåy
 {

91 
li°_hód
 
	mli°
;

92 *
	m«me
;

93 
time_t
 
	mmtime
;

96 
__öô
 
	$dú_add
(c⁄° *
«me
, 
time_t
 
mtime
)

98 
dú_íåy
 *
de
 = 
	`kmÆloc
((dú_íåy), 
GFP_KERNEL
);

99 i‡(!
de
)

100 
	`∑nic
("can'tállocate dir_entry buffer");

101 
	`INIT_LIST_HEAD
(&
de
->
li°
);

102 
de
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

103 
de
->
mtime
 = mtime;

104 
	`li°_add
(&
de
->
li°
, &
dú_li°
);

105 
	}
}

107 
__öô
 
	$dú_utime
()

109 
dú_íåy
 *
de
, *
tmp
;

110 
	`li°_f‹_óch_íåy_ß„
(
de
, 
tmp
, &
dú_li°
, 
li°
) {

111 
	`li°_dñ
(&
de
->
li°
);

112 
	`do_utime
(
de
->
«me
, de->
mtime
);

113 
	`k‰ì
(
de
->
«me
);

114 
	`k‰ì
(
de
);

116 
	}
}

118 
__öôd©a
 
time_t
 
	gmtime
;

122 
__öôd©a
 
	göo
, 
	gmaj‹
, 
	gmö‹
, 
	g∆ök
;

123 
__öôd©a
 
mode_t
 
	gmode
;

124 
__öôd©a
 
	gbody_Àn
, 
	g«me_Àn
;

125 
__öôd©a
 
uid_t
 
	guid
;

126 
__öôd©a
 
gid_t
 
	ggid
;

127 
__öôd©a
 
	grdev
;

129 
__öô
 
	$∑r£_hódî
(*
s
)

131 
∑r£d
[12];

132 
buf
[9];

133 
i
;

135 
buf
[8] = '\0';

136 
i
 = 0, 
s
 += 6; i < 12; i++, s += 8) {

137 
	`mem˝y
(
buf
, 
s
, 8);

138 
∑r£d
[
i
] = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 16);

140 
öo
 = 
∑r£d
[0];

141 
mode
 = 
∑r£d
[1];

142 
uid
 = 
∑r£d
[2];

143 
gid
 = 
∑r£d
[3];

144 
∆ök
 = 
∑r£d
[4];

145 
mtime
 = 
∑r£d
[5];

146 
body_Àn
 = 
∑r£d
[6];

147 
maj‹
 = 
∑r£d
[7];

148 
mö‹
 = 
∑r£d
[8];

149 
rdev
 = 
	`√w_ícode_dev
(
	`MKDEV
(
∑r£d
[9],Öarsed[10]));

150 
«me_Àn
 = 
∑r£d
[11];

151 
	}
}

155 
__öôd©a
 
	e°©e
 {

156 
	mSèπ
,

157 
	mCﬁÀ˘
,

158 
	mGŸHódî
,

159 
	mSkùIt
,

160 
	mGŸName
,

161 
	mC›yFûe
,

162 
	mGŸSymlök
,

163 
	mRe£t


164 } 
	g°©e
, 
	g√xt_°©e
;

166 
__öôd©a
 *
	gvi˘im
;

167 
__öôd©a
 
	gcou¡
;

168 
__öôd©a
 
loff_t
 
	gthis_hódî
, 
	g√xt_hódî
;

170 
ölöe
 
__öô
 
	$ót
(
n
)

172 
vi˘im
 +
n
;

173 
this_hódî
 +
n
;

174 
cou¡
 -
n
;

175 
	}
}

177 
__öôd©a
 *
	gvcﬁÀ˘ed
;

178 
__öôd©a
 *
	gcﬁÀ˘ed
;

179 
__öôd©a
 
	gªmaös
;

180 
__öôd©a
 *
	gcﬁÀ˘
;

182 
__öô
 
	$ªad_öto
(*
buf
, 
size
, 
°©e
 
√xt
)

184 i‡(
cou¡
 >
size
) {

185 
cﬁÀ˘ed
 = 
vi˘im
;

186 
	`ót
(
size
);

187 
°©e
 = 
√xt
;

189 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
buf
;

190 
ªmaös
 = 
size
;

191 
√xt_°©e
 = 
√xt
;

192 
°©e
 = 
CﬁÀ˘
;

194 
	}
}

196 
__öôd©a
 *
	ghódî_buf
, *
	gsymlök_buf
, *
	g«me_buf
;

198 
__öô
 
	$do_°¨t
()

200 
	`ªad_öto
(
hódî_buf
, 110, 
GŸHódî
);

202 
	}
}

204 
__öô
 
	$do_cﬁÀ˘
()

206 
n
 = 
ªmaös
;

207 i‡(
cou¡
 < 
n
)

208 
n
 = 
cou¡
;

209 
	`mem˝y
(
cﬁÀ˘
, 
vi˘im
, 
n
);

210 
	`ót
(
n
);

211 
cﬁÀ˘
 +
n
;

212 i‡((
ªmaös
 -
n
) != 0)

214 
°©e
 = 
√xt_°©e
;

216 
	}
}

218 
__öô
 
	$do_hódî
()

220 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070707", 6)==0) {

221 
	`îr‹
("incorrect cpio method used: use -HÇewc option");

224 i‡(
	`memcmp
(
cﬁÀ˘ed
, "070701", 6)) {

225 
	`îr‹
("no cpio magic");

228 
	`∑r£_hódî
(
cﬁÀ˘ed
);

229 
√xt_hódî
 = 
this_hódî
 + 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

230 
√xt_hódî
 = (next_header + 3) & ~3;

231 
°©e
 = 
SkùIt
;

232 i‡(
«me_Àn
 <0 ||Çame_À¿> 
PATH_MAX
)

234 i‡(
	`S_ISLNK
(
mode
)) {

235 i‡(
body_Àn
 > 
PATH_MAX
)

237 
cﬁÀ˘
 = 
cﬁÀ˘ed
 = 
symlök_buf
;

238 
ªmaös
 = 
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
;

239 
√xt_°©e
 = 
GŸSymlök
;

240 
°©e
 = 
CﬁÀ˘
;

243 i‡(
	`S_ISREG
(
mode
Ë|| !
body_Àn
)

244 
	`ªad_öto
(
«me_buf
, 
	`N_ALIGN
(
«me_Àn
), 
GŸName
);

246 
	}
}

248 
__öô
 
	$do_skù
()

250 i‡(
this_hódî
 + 
cou¡
 < 
√xt_hódî
) {

251 
	`ót
(
cou¡
);

254 
	`ót
(
√xt_hódî
 - 
this_hódî
);

255 
°©e
 = 
√xt_°©e
;

258 
	}
}

260 
__öô
 
	$do_ª£t
()

262 
cou¡
 && *
vi˘im
 == '\0')

263 
	`ót
(1);

264 i‡(
cou¡
 && (
this_hódî
 & 3))

265 
	`îr‹
("brokenÖadding");

267 
	}
}

269 
__öô
 
	$maybe_lök
()

271 i‡(
∆ök
 >= 2) {

272 *
ﬁd
 = 
	`föd_lök
(
maj‹
, 
mö‹
, 
öo
, 
mode
, 
cﬁÀ˘ed
);

273 i‡(
ﬁd
)

274  (
	`sys_lök
(
ﬁd
, 
cﬁÀ˘ed
) < 0) ? -1 : 1;

277 
	}
}

279 
__öô
 
	$˛ón_∑th
(*
∑th
, 
mode_t
 
mode
)

281 
°©
 
°
;

283 i‡(!
	`sys_√wl°©
(
∑th
, &
°
Ë&& (°.
°_mode
^
mode
Ë& 
S_IFMT
) {

284 i‡(
	`S_ISDIR
(
°
.
°_mode
))

285 
	`sys_rmdú
(
∑th
);

287 
	`sys_u∆ök
(
∑th
);

289 
	}
}

291 
__öôd©a
 
	gwfd
;

293 
__öô
 
	$do_«me
()

295 
°©e
 = 
SkùIt
;

296 
√xt_°©e
 = 
Re£t
;

297 i‡(
	`°rcmp
(
cﬁÀ˘ed
, "TRAILER!!!") == 0) {

298 
	`‰ì_hash
();

301 
	`˛ón_∑th
(
cﬁÀ˘ed
, 
mode
);

302 i‡(
	`S_ISREG
(
mode
)) {

303 
ml
 = 
	`maybe_lök
();

304 i‡(
ml
 >= 0) {

305 
›íÊags
 = 
O_WRONLY
|
O_CREAT
;

306 i‡(
ml
 != 1)

307 
›íÊags
 |
O_TRUNC
;

308 
wfd
 = 
	`sys_›í
(
cﬁÀ˘ed
, 
›íÊags
, 
mode
);

310 i‡(
wfd
 >= 0) {

311 
	`sys_fchown
(
wfd
, 
uid
, 
gid
);

312 
	`sys_fchmod
(
wfd
, 
mode
);

313 i‡(
body_Àn
)

314 
	`sys_·runˇã
(
wfd
, 
body_Àn
);

315 
vcﬁÀ˘ed
 = 
	`k°rdup
(
cﬁÀ˘ed
, 
GFP_KERNEL
);

316 
°©e
 = 
C›yFûe
;

319 } i‡(
	`S_ISDIR
(
mode
)) {

320 
	`sys_mkdú
(
cﬁÀ˘ed
, 
mode
);

321 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

322 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

323 
	`dú_add
(
cﬁÀ˘ed
, 
mtime
);

324 } i‡(
	`S_ISBLK
(
mode
Ë|| 
	`S_ISCHR
(mode) ||

325 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

326 i‡(
	`maybe_lök
() == 0) {

327 
	`sys_mknod
(
cﬁÀ˘ed
, 
mode
, 
rdev
);

328 
	`sys_chown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

329 
	`sys_chmod
(
cﬁÀ˘ed
, 
mode
);

330 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

334 
	}
}

336 
__öô
 
	$do_c›y
()

338 i‡(
cou¡
 >
body_Àn
) {

339 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
body_Àn
);

340 
	`sys_˛o£
(
wfd
);

341 
	`do_utime
(
vcﬁÀ˘ed
, 
mtime
);

342 
	`k‰ì
(
vcﬁÀ˘ed
);

343 
	`ót
(
body_Àn
);

344 
°©e
 = 
SkùIt
;

347 
	`sys_wrôe
(
wfd
, 
vi˘im
, 
cou¡
);

348 
body_Àn
 -
cou¡
;

349 
	`ót
(
cou¡
);

352 
	}
}

354 
__öô
 
	$do_symlök
()

356 
cﬁÀ˘ed
[
	`N_ALIGN
(
«me_Àn
Ë+ 
body_Àn
] = '\0';

357 
	`˛ón_∑th
(
cﬁÀ˘ed
, 0);

358 
	`sys_symlök
(
cﬁÀ˘ed
 + 
	`N_ALIGN
(
«me_Àn
), collected);

359 
	`sys_lchown
(
cﬁÀ˘ed
, 
uid
, 
gid
);

360 
	`do_utime
(
cﬁÀ˘ed
, 
mtime
);

361 
°©e
 = 
SkùIt
;

362 
√xt_°©e
 = 
Re£t
;

364 
	}
}

366 
__öôd©a
 (*
a˘i⁄s
[])() = {

367 [
Sèπ
] = 
do_°¨t
,

368 [
CﬁÀ˘
] = 
do_cﬁÀ˘
,

369 [
GŸHódî
] = 
do_hódî
,

370 [
SkùIt
] = 
do_skù
,

371 [
GŸName
] = 
do_«me
,

372 [
C›yFûe
] = 
do_c›y
,

373 [
GŸSymlök
] = 
do_symlök
,

374 [
Re£t
] = 
do_ª£t
,

375 
	}
};

377 
__öô
 
	$wrôe_buf„r
(*
buf
, 
Àn
)

379 
cou¡
 = 
Àn
;

380 
vi˘im
 = 
buf
;

382 !
a˘i⁄s
[
°©e
]())

384  
Àn
 - 
cou¡
;

385 
	}
}

387 
__öô
 
	$Êush_buf„r
(*
bufv
, 
Àn
)

389 *
buf
 = (*Ë
bufv
;

390 
wrôãn
;

391 
‹igLí
 = 
Àn
;

392 i‡(
mesßge
)

394 (
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
)Ë<Üí && !
mesßge
) {

395 
c
 = 
buf
[
wrôãn
];

396 i‡(
c
 == '0') {

397 
buf
 +
wrôãn
;

398 
Àn
 -
wrôãn
;

399 
°©e
 = 
Sèπ
;

400 } i‡(
c
 == 0) {

401 
buf
 +
wrôãn
;

402 
Àn
 -
wrôãn
;

403 
°©e
 = 
Re£t
;

405 
	`îr‹
("junk in compressedárchive");

407  
‹igLí
;

408 
	}
}

410 
	gmy_ö±r
;

412 
	~<löux/decom¥ess/gíîic.h
>

414 * 
__öô
 
	$u≈ack_to_roŸfs
(*
buf
, 
Àn
)

416 
wrôãn
, 
ªs
;

417 
decom¥ess_‚
 
decom¥ess
;

418 c⁄° *
com¥ess_«me
;

419 
__öôd©a
 
msg_buf
[64];

421 
hódî_buf
 = 
	`kmÆloc
(110, 
GFP_KERNEL
);

422 
symlök_buf
 = 
	`kmÆloc
(
PATH_MAX
 + 
	`N_ALIGN
(PATH_MAXË+ 1, 
GFP_KERNEL
);

423 
«me_buf
 = 
	`kmÆloc
(
	`N_ALIGN
(
PATH_MAX
), 
GFP_KERNEL
);

425 i‡(!
hódî_buf
 || !
symlök_buf
 || !
«me_buf
)

426 
	`∑nic
("can'tállocate buffers");

428 
°©e
 = 
Sèπ
;

429 
this_hódî
 = 0;

430 
mesßge
 = 
NULL
;

431 !
mesßge
 && 
Àn
) {

432 
loff_t
 
ßved_off£t
 = 
this_hódî
;

433 i‡(*
buf
 ='0' && !(
this_hódî
 & 3)) {

434 
°©e
 = 
Sèπ
;

435 
wrôãn
 = 
	`wrôe_buf„r
(
buf
, 
Àn
);

436 
buf
 +
wrôãn
;

437 
Àn
 -
wrôãn
;

440 i‡(!*
buf
) {

441 
buf
++;

442 
Àn
--;

443 
this_hódî
++;

446 
this_hódî
 = 0;

447 
decom¥ess
 = 
	`decom¥ess_mëhod
(
buf
, 
Àn
, &
com¥ess_«me
);

448 i‡(
decom¥ess
) {

449 
ªs
 = 
	`decom¥ess
(
buf
, 
Àn
, 
NULL
, 
Êush_buf„r
, NULL,

450 &
my_ö±r
, 
îr‹
);

451 i‡(
ªs
)

452 
	`îr‹
("decompressor failed");

453 } i‡(
com¥ess_«me
) {

454 i‡(!
mesßge
) {

455 
	`¢¥ötf
(
msg_buf
,  msg_buf,

457 
com¥ess_«me
);

458 
mesßge
 = 
msg_buf
;

461 
	`îr‹
("junk in compressedárchive");

462 i‡(
°©e
 !
Re£t
)

463 
	`îr‹
("junk in compressedárchive");

464 
this_hódî
 = 
ßved_off£t
 + 
my_ö±r
;

465 
buf
 +
my_ö±r
;

466 
Àn
 -
my_ö±r
;

468 
	`dú_utime
();

469 
	`k‰ì
(
«me_buf
);

470 
	`k‰ì
(
symlök_buf
);

471 
	`k‰ì
(
hódî_buf
);

472  
mesßge
;

473 
	}
}

475 
__öôd©a
 
	gdo_ªèö_öôrd
;

477 
__öô
 
	$ªèö_öôrd_∑øm
(*
°r
)

479 i‡(*
°r
)

481 
do_ªèö_öôrd
 = 1;

483 
	}
}

484 
__£tup
("ªèö_öôrd", 
ªèö_öôrd_∑øm
);

486 
__öôømfs_°¨t
[], 
__öôømfs_íd
[];

487 
	~<löux/öôrd.h
>

488 
	~<löux/kexec.h
>

490 
__öô
 
	$‰ì_öôrd
()

492 #ifde‡
CONFIG_KEXEC


493 
¸ashk_°¨t
 = ()
	`__va
(
¸ashk_ªs
.
°¨t
);

494 
¸ashk_íd
 = ()
	`__va
(
¸ashk_ªs
.
íd
);

496 i‡(
do_ªèö_öôrd
)

497 
skù
;

499 #ifde‡
CONFIG_KEXEC


504 i‡(
öôrd_°¨t
 < 
¸ashk_íd
 && 
öôrd_íd
 > 
¸ashk_°¨t
) {

509 
	`mem£t
((*)
öôrd_°¨t
, 0, 
öôrd_íd
 - initrd_start);

510 i‡(
öôrd_°¨t
 < 
¸ashk_°¨t
)

511 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
¸ashk_°¨t
);

512 i‡(
öôrd_íd
 > 
¸ashk_íd
)

513 
	`‰ì_öôrd_mem
(
¸ashk_íd
, 
öôrd_íd
);

516 
	`‰ì_öôrd_mem
(
öôrd_°¨t
, 
öôrd_íd
);

517 
skù
:

518 
öôrd_°¨t
 = 0;

519 
öôrd_íd
 = 0;

520 
	}
}

522 #ifde‡
CONFIG_BLK_DEV_RAM


523 
	#BUF_SIZE
 1024

	)

524 
__öô
 
	$˛ón_roŸfs
()

526 
fd
;

527 *
buf
;

528 
löux_dúít64
 *
dúp
;

529 
num
;

531 
fd
 = 
	`sys_›í
("/", 
O_RDONLY
, 0);

532 
	`WARN_ON
(
fd
 < 0);

533 i‡(
fd
 < 0)

535 
buf
 = 
	`kzÆloc
(
BUF_SIZE
, 
GFP_KERNEL
);

536 
	`WARN_ON
(!
buf
);

537 i‡(!
buf
) {

538 
	`sys_˛o£
(
fd
);

542 
dúp
 = 
buf
;

543 
num
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

544 
num
 > 0) {

545 
num
 > 0) {

546 
°©
 
°
;

547 
ªt
;

549 
ªt
 = 
	`sys_√wl°©
(
dúp
->
d_«me
, &
°
);

550 
	`WARN_ON_ONCE
(
ªt
);

551 i‡(!
ªt
) {

552 i‡(
	`S_ISDIR
(
°
.
°_mode
))

553 
	`sys_rmdú
(
dúp
->
d_«me
);

555 
	`sys_u∆ök
(
dúp
->
d_«me
);

558 
num
 -
dúp
->
d_ª˛í
;

559 
dúp
 = (*)dú∞+ dúp->
d_ª˛í
;

561 
dúp
 = 
buf
;

562 
	`mem£t
(
buf
, 0, 
BUF_SIZE
);

563 
num
 = 
	`sys_gëdíts64
(
fd
, 
dúp
, 
BUF_SIZE
);

566 
	`sys_˛o£
(
fd
);

567 
	`k‰ì
(
buf
);

568 
	}
}

571 
__öô
 
	$p›uœã_roŸfs
()

573 *
îr
 = 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

574 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

575 i‡(
îr
)

576 
	`∑nic
(
îr
);

577 i‡(
öôrd_°¨t
) {

578 #ifde‡
CONFIG_BLK_DEV_RAM


579 
fd
;

580 
	`¥ötk
(
KERN_INFO
 "TryingÅo unpackÑootfs imageás initramfs...\n");

581 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

582 
öôrd_íd
 - 
öôrd_°¨t
);

583 i‡(!
îr
) {

584 
	`‰ì_öôrd
();

587 
	`˛ón_roŸfs
();

588 
	`u≈ack_to_roŸfs
(
__öôømfs_°¨t
,

589 
__öôømfs_íd
 - 
__öôømfs_°¨t
);

591 
	`¥ötk
(
KERN_INFO
 "rootfs image isÇot initramfs (%s)"

592 ";Üook†likê™ inôrd\n", 
îr
);

593 
fd
 = 
	`sys_›í
("/öôrd.image", 
O_WRONLY
|
O_CREAT
, 0700);

594 i‡(
fd
 >= 0) {

595 
	`sys_wrôe
(
fd
, (*)
öôrd_°¨t
,

596 
öôrd_íd
 - 
öôrd_°¨t
);

597 
	`sys_˛o£
(
fd
);

598 
	`‰ì_öôrd
();

601 
	`¥ötk
(
KERN_INFO
 "Unpacking initramfs...\n");

602 
îr
 = 
	`u≈ack_to_roŸfs
((*)
öôrd_°¨t
,

603 
öôrd_íd
 - 
öôrd_°¨t
);

604 i‡(
îr
)

605 
	`¥ötk
(
KERN_EMERG
 "Inôømf†u≈ackög faûed: %s\n", 
îr
);

606 
	`‰ì_öôrd
();

610 
	}
}

611 
roŸfs_öôˇŒ
(
p›uœã_roŸfs
);

	@/cmpt816/linux/init/main.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sysˇŒs.h
>

17 
	~<löux/°ack¥Ÿe˘‹.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/˘y≥.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/smp_lock.h
>

24 
	~<löux/öôrd.h
>

25 
	~<löux/boŸmem.h
>

26 
	~<löux/a˝i.h
>

27 
	~<löux/ây.h
>

28 
	~<löux/≥r˝u.h
>

29 
	~<löux/kmod.h
>

30 
	~<löux/vmÆloc.h
>

31 
	~<löux/kî√l_°©.h
>

32 
	~<löux/°¨t_kî√l.h
>

33 
	~<löux/£curôy.h
>

34 
	~<löux/smp.h
>

35 
	~<löux/w‹kqueue.h
>

36 
	~<löux/¥ofûe.h
>

37 
	~<löux/rcupd©e.h
>

38 
	~<löux/moduÀ∑øm.h
>

39 
	~<löux/kÆlsyms.h
>

40 
	~<löux/wrôeback.h
>

41 
	~<löux/˝u.h
>

42 
	~<löux/˝u£t.h
>

43 
	~<löux/cgroup.h
>

44 
	~<löux/efi.h
>

45 
	~<löux/tick.h
>

46 
	~<löux/öãºu±.h
>

47 
	~<löux/èsk°©s_kîn.h
>

48 
	~<löux/dñayac˘.h
>

49 
	~<löux/uni°d.h
>

50 
	~<löux/rm≠.h
>

51 
	~<löux/mempﬁicy.h
>

52 
	~<löux/key.h
>

53 
	~<löux/buf„r_hód.h
>

54 
	~<löux/∑ge_cgroup.h
>

55 
	~<löux/debug_locks.h
>

56 
	~<löux/debugobje˘s.h
>

57 
	~<löux/lockdï.h
>

58 
	~<löux/kmemÀak.h
>

59 
	~<löux/pid_«me•a˚.h
>

60 
	~<löux/devi˚.h
>

61 
	~<löux/kthªad.h
>

62 
	~<löux/sched.h
>

63 
	~<löux/sig«l.h
>

64 
	~<löux/idr.h
>

65 
	~<löux/kgdb.h
>

66 
	~<löux/·ø˚.h
>

67 
	~<löux/async.h
>

68 
	~<löux/kmemcheck.h
>

69 
	~<löux/kmemåa˚.h
>

70 
	~<löux/sfi.h
>

71 
	~<löux/shmem_fs.h
>

72 
	~<löux/¶ab.h
>

73 
	~<åa˚/boŸ.h
>

75 
	~<asm/io.h
>

76 
	~<asm/bugs.h
>

77 
	~<asm/£tup.h
>

78 
	~<asm/£˘i⁄s.h
>

79 
	~<asm/ˇcheÊush.h
>

81 #ifde‡
CONFIG_X86_LOCAL_APIC


82 
	~<asm/smp.h
>

85 
kî√l_öô
(*);

87 
öô_IRQ
();

88 
f‹k_öô
();

89 
mˇ_öô
();

90 
sbus_öô
();

91 
¥io_åì_öô
();

92 
ødix_åì_öô
();

93 
‰ì_öômem
();

94 #i‚de‡
CONFIG_DEBUG_RODATA


95 
ölöe
 
	$m¨k_rod©a_ro
(Ë{ 
	}
}

98 #ifde‡
CONFIG_TC


99 
tc_öô
();

102 
sy°em_°©es
 
sy°em_°©e
 
	g__ªad_mo°ly
;

103 
EXPORT_SYMBOL
(
sy°em_°©e
);

108 
	#MAX_INIT_ARGS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

109 
	#MAX_INIT_ENVS
 
CONFIG_INIT_ENV_ARG_LIMIT


	)

111 
time_öô
();

113 (*
__öôd©a
 
œã_time_öô
)();

114 
	`so·úq_öô
();

117 
__öôd©a
 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
];

119 *
ßved_comm™d_löe
;

121 *
°©ic_comm™d_löe
;

123 *
execuã_comm™d
;

124 *
ømdisk_execuã_comm™d
;

126 #ifde‡
CONFIG_SMP


128 
£tup_max_˝us
 = 
NR_CPUS
;

129 
	`EXPORT_SYMBOL
(
£tup_max_˝us
);

143 
__wók
 
	$¨ch_dißbÀ_smp_suµ‹t
(Ë{ 
	}
}

145 
__öô
 
	$nosmp
(*
°r
)

147 
£tup_max_˝us
 = 0;

148 
	`¨ch_dißbÀ_smp_suµ‹t
();

151 
	}
}

153 
óæy_∑øm
("nosmp", 
nosmp
);

156 
__öô
 
	$ƒ˝us
(*
°r
)

158 
ƒ_˝us
;

160 
	`gë_›ti⁄
(&
°r
, &
ƒ_˝us
);

161 i‡(
ƒ_˝us
 > 0 &&Çr_˝u†< 
ƒ_˝u_ids
)

162 
ƒ_˝u_ids
 = 
ƒ_˝us
;

165 
	}
}

167 
óæy_∑øm
("ƒ_˝us", 
ƒ˝us
);

169 
__öô
 
	$max˝us
(*
°r
)

171 
	`gë_›ti⁄
(&
°r
, &
£tup_max_˝us
);

172 i‡(
£tup_max_˝us
 == 0)

173 
	`¨ch_dißbÀ_smp_suµ‹t
();

176 
	}
}

178 
óæy_∑øm
("max˝us", 
max˝us
);

180 c⁄° 
	g£tup_max_˝us
 = 
NR_CPUS
;

192 
	gª£t_devi˚s
;

193 
EXPORT_SYMBOL
(
ª£t_devi˚s
);

195 
__öô
 
	$£t_ª£t_devi˚s
(*
°r
)

197 
ª£t_devi˚s
 = 1;

199 
	}
}

201 
__£tup
("ª£t_devi˚s", 
£t_ª£t_devi˚s
);

203 * 
	g¨gv_öô
[
MAX_INIT_ARGS
+2] = { "öô", 
NULL
, };

204 * 
	gívp_öô
[
MAX_INIT_ENVS
+2] = { "HOME=/", "TERMˆöux", 
NULL
, };

205 c⁄° *
	g∑nic_œãr
, *
	g∑nic_∑øm
;

207 
obs_kî√l_∑øm
 
__£tup_°¨t
[], 
__£tup_íd
[];

209 
__öô
 
	$obsﬁëe_check£tup
(*
löe
)

211 
obs_kî√l_∑øm
 *
p
;

212 
had_óæy_∑øm
 = 0;

214 
p
 = 
__£tup_°¨t
;

216 
n
 = 
	`°æí
(
p
->
°r
);

217 i‡(!
	`°∫cmp
(
löe
, 
p
->
°r
, 
n
)) {

218 i‡(
p
->
óæy
) {

223 i‡(
löe
[
n
] == '\0' ||Üine[n] == '=')

224 
had_óæy_∑øm
 = 1;

225 } i‡(!
p
->
£tup_func
) {

226 
	`¥ötk
(
KERN_WARNING
 "Parameter %s is obsolete,"

227 " ign‹ed\n", 
p
->
°r
);

229 } i‡(
p
->
	`£tup_func
(
löe
 + 
n
))

232 
p
++;

233 } 
p
 < 
__£tup_íd
);

235  
had_óæy_∑øm
;

236 
	}
}

242 
	glo›s_≥r_jiffy
 = (1<<12);

244 
EXPORT_SYMBOL
(
lo›s_≥r_jiffy
);

246 
__öô
 
	$debug_kî√l
(*
°r
)

248 
c⁄sﬁe_logÀvñ
 = 10;

250 
	}
}

252 
__öô
 
	$quõt_kî√l
(*
°r
)

254 
c⁄sﬁe_logÀvñ
 = 4;

256 
	}
}

258 
óæy_∑øm
("debug", 
debug_kî√l
);

259 
óæy_∑øm
("quõt", 
quõt_kî√l
);

261 
__öô
 
	$logÀvñ
(*
°r
)

263 
	`gë_›ti⁄
(&
°r
, &
c⁄sﬁe_logÀvñ
);

265 
	}
}

267 
óæy_∑øm
("logÀvñ", 
logÀvñ
);

273 
__öô
 
	$unknown_boŸ›ti⁄
(*
∑øm
, *
vÆ
)

276 i‡(
vÆ
) {

278 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+1)

279 
vÆ
[-1] = '=';

280 i‡(
vÆ
 =
∑øm
+
	`°æí
(param)+2) {

281 
vÆ
[-2] = '=';

282 
	`memmove
(
vÆ
-1, vÆ, 
	`°æí
(val)+1);

283 
vÆ
--;

285 
	`BUG
();

289 i‡(
	`obsﬁëe_check£tup
(
∑øm
))

293 i‡(
	`°rchr
(
∑øm
, '.'Ë&& (!
vÆ
 || strchr(param, '.') < val))

296 i‡(
∑nic_œãr
)

299 i‡(
vÆ
) {

301 
i
;

302 
i
 = 0; 
ívp_öô
[i]; i++) {

303 i‡(
i
 =
MAX_INIT_ENVS
) {

304 
∑nic_œãr
 = "Too many bootÉnv varsát `%s'";

305 
∑nic_∑øm
 = 
∑øm
;

307 i‡(!
	`°∫cmp
(
∑øm
, 
ívp_öô
[
i
], 
vÆ
 -Öaram))

310 
ívp_öô
[
i
] = 
∑øm
;

313 
i
;

314 
i
 = 0; 
¨gv_öô
[i]; i++) {

315 i‡(
i
 =
MAX_INIT_ARGS
) {

316 
∑nic_œãr
 = "Too many boot init varsát `%s'";

317 
∑nic_∑øm
 = 
∑øm
;

320 
¨gv_öô
[
i
] = 
∑øm
;

323 
	}
}

325 #ifde‡
CONFIG_DEBUG_PAGEALLOC


326 
__ªad_mo°ly
 
	gdebug_∑góŒoc_íabÀd
 = 0;

329 
__öô
 
	$öô_£tup
(*
°r
)

331 
i
;

333 
execuã_comm™d
 = 
°r
;

340 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

341 
¨gv_öô
[
i
] = 
NULL
;

343 
	}
}

344 
__£tup
("öô=", 
öô_£tup
);

346 
__öô
 
	$rdöô_£tup
(*
°r
)

348 
i
;

350 
ømdisk_execuã_comm™d
 = 
°r
;

352 
i
 = 1; i < 
MAX_INIT_ARGS
; i++)

353 
¨gv_öô
[
i
] = 
NULL
;

355 
	}
}

356 
__£tup
("rdöô=", 
rdöô_£tup
);

358 #i‚de‡
CONFIG_SMP


360 #ifde‡
CONFIG_X86_LOCAL_APIC


361 
__öô
 
	$smp_öô
()

363 
	`APIC_öô_unùro˚ss‹
();

364 
	}
}

366 
	#smp_öô
(Ëdÿ{ } 0)

	)

369 
ölöe
 
	$£tup_ƒ_˝u_ids
(Ë{ 
	}
}

370 
ölöe
 
	$smp_¥ï¨e_˝us
(
max˝us
Ë{ 
	}
}

375 
ƒ_˝u_ids
 
	g__ªad_mo°ly
 = 
NR_CPUS
;

376 
EXPORT_SYMBOL
(
ƒ_˝u_ids
);

379 
__öô
 
	$£tup_ƒ_˝u_ids
()

381 
ƒ_˝u_ids
 = 
	`föd_œ°_bô
(
	`˝umask_bôs
(
˝u_possibÀ_mask
),
NR_CPUS
) + 1;

382 
	}
}

385 
__öô
 
	$smp_öô
()

387 
˝u
;

390 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

391 i‡(
	`num_⁄löe_˝us
(Ë>
£tup_max_˝us
)

393 i‡(!
	`˝u_⁄löe
(
˝u
))

394 
	`˝u_up
(
˝u
);

398 
	`¥ötk
(
KERN_INFO
 "Broughàu∞%ld CPUs\n", ()
	`num_⁄löe_˝us
());

399 
	`smp_˝us_d⁄e
(
£tup_max_˝us
);

400 
	}
}

410 
__öô
 
	$£tup_comm™d_löe
(*
comm™d_löe
)

412 
ßved_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
boŸ_comm™d_löe
)+1);

413 
°©ic_comm™d_löe
 = 
	`Æloc_boŸmem
(
	`°æí
 (
comm™d_löe
)+1);

414 
	`°r˝y
 (
ßved_comm™d_löe
, 
boŸ_comm™d_löe
);

415 
	`°r˝y
 (
°©ic_comm™d_löe
, 
comm™d_löe
);

416 
	}
}

427 
__öôd©a
 
DECLARE_COMPLETION
(
kthªadd_d⁄e
);

429 
noölöe
 
__öô_ªfok
 
	$ª°_öô
()

430 
	$__ªÀa£s
(
kî√l_lock
)

432 
pid
;

434 
	`rcu_scheduÀr_°¨tög
();

440 
	`kî√l_thªad
(
kî√l_öô
, 
NULL
, 
CLONE_FS
 | 
CLONE_SIGHAND
);

441 
	`numa_deÁu…_pﬁicy
();

442 
pid
 = 
	`kî√l_thªad
(
kthªadd
, 
NULL
, 
CLONE_FS
 | 
CLONE_FILES
);

443 
	`rcu_ªad_lock
();

444 
kthªadd_èsk
 = 
	`föd_èsk_by_pid_ns
(
pid
, &
öô_pid_ns
);

445 
	`rcu_ªad_u∆ock
();

446 
	`com∂ëe
(&
kthªadd_d⁄e
);

447 
	`u∆ock_kî√l
();

453 
	`öô_idÀ_boŸup_èsk
(
cuºít
);

454 
	`¥ìm±_íabÀ_no_ªsched
();

455 
	`scheduÀ
();

456 
	`¥ìm±_dißbÀ
();

459 
	`˝u_idÀ
();

460 
	}
}

463 
__öô
 
	$do_óæy_∑øm
(*
∑øm
, *
vÆ
)

465 
obs_kî√l_∑øm
 *
p
;

467 
p
 = 
__£tup_°¨t
;Ö < 
__£tup_íd
;Ö++) {

468 i‡((
p
->
óæy
 && 
	`°rcmp
(
∑øm
,Ö->
°r
) == 0) ||

469 (
	`°rcmp
(
∑øm
, "console") == 0 &&

470 
	`°rcmp
(
p
->
°r
, "earlycon") == 0)

472 i‡(
p
->
	`£tup_func
(
vÆ
) != 0)

473 
	`¥ötk
(
KERN_WARNING


474 "MÆf‹medÉ¨ly o±i⁄ '%s'\n", 
∑øm
);

479 
	}
}

481 
__öô
 
	$∑r£_óæy_›ti⁄s
(*
cmdlöe
)

483 
	`∑r£_¨gs
("óæy o±i⁄s", 
cmdlöe
, 
NULL
, 0, 
do_óæy_∑øm
);

484 
	}
}

487 
__öô
 
	$∑r£_óæy_∑øm
()

489 
__öôd©a
 
d⁄e
 = 0;

490 
__öôd©a
 
tmp_cmdlöe
[
COMMAND_LINE_SIZE
];

492 i‡(
d⁄e
)

496 
	`°æ˝y
(
tmp_cmdlöe
, 
boŸ_comm™d_löe
, 
COMMAND_LINE_SIZE
);

497 
	`∑r£_óæy_›ti⁄s
(
tmp_cmdlöe
);

498 
d⁄e
 = 1;

499 
	}
}

505 
__öô
 
	$boŸ_˝u_öô
()

507 
˝u
 = 
	`smp_¥o˚ss‹_id
();

509 
	`£t_˝u_⁄löe
(
˝u
, 
åue
);

510 
	`£t_˝u_a˘ive
(
˝u
, 
åue
);

511 
	`£t_˝u_¥e£¡
(
˝u
, 
åue
);

512 
	`£t_˝u_possibÀ
(
˝u
, 
åue
);

513 
	}
}

515 
__öô
 
__wók
 
	$smp_£tup_¥o˚ss‹_id
()

517 
	}
}

519 
__öô
 
__wók
 
	$thªad_öfo_ˇche_öô
()

521 
	}
}

526 
__öô
 
	$mm_öô
()

532 
	`∑ge_cgroup_öô_Ê©mem
();

533 
	`mem_öô
();

534 
	`kmem_ˇche_öô
();

535 
	`pgèbÀ_ˇche_öô
();

536 
	`vmÆloc_öô
();

537 
	}
}

539 
asmlökage
 
__öô
 
	$°¨t_kî√l
()

541 * 
comm™d_löe
;

542 
kî√l_∑øm
 
__°¨t___∑øm
[], 
__°›___∑øm
[];

544 
	`smp_£tup_¥o˚ss‹_id
();

550 
	`lockdï_öô
();

551 
	`debug_obje˘s_óæy_öô
();

556 
	`boŸ_öô_°ack_ˇ«ry
();

558 
	`cgroup_öô_óæy
();

560 
	`loˇl_úq_dißbÀ
();

561 
	`óæy_boŸ_úqs_off
();

562 
	`óæy_öô_úq_lock_˛ass
();

568 
	`lock_kî√l
();

569 
	`tick_öô
();

570 
	`boŸ_˝u_öô
();

571 
	`∑ge_addªss_öô
();

572 
	`¥ötk
(
KERN_NOTICE
 "%s", 
löux_b™√r
);

573 
	`£tup_¨ch
(&
comm™d_löe
);

574 
	`mm_öô_ow√r
(&
öô_mm
, &
öô_èsk
);

575 
	`£tup_comm™d_löe
(
comm™d_löe
);

576 
	`£tup_ƒ_˝u_ids
();

577 
	`£tup_≥r_˝u_¨ós
();

578 
	`smp_¥ï¨e_boŸ_˝u
();

580 
	`buûd_Æl_z⁄ñi°s
(
NULL
);

581 
	`∑ge_Æloc_öô
();

583 
	`¥ötk
(
KERN_NOTICE
 "Kî√»comm™dÜöe: %s\n", 
boŸ_comm™d_löe
);

584 
	`∑r£_óæy_∑øm
();

585 
	`∑r£_¨gs
("BoŸög kî√l", 
°©ic_comm™d_löe
, 
__°¨t___∑øm
,

586 
__°›___∑øm
 - 
__°¨t___∑øm
,

587 &
unknown_boŸ›ti⁄
);

592 
	`pidhash_öô
();

593 
	`vfs_ˇches_öô_óæy
();

594 
	`s‹t_maö_exèbÀ
();

595 
	`å≠_öô
();

596 
	`mm_öô
();

602 
	`sched_öô
();

607 
	`¥ìm±_dißbÀ
();

608 i‡(!
	`úqs_dißbÀd
()) {

609 
	`¥ötk
(
KERN_WARNING
 "start_kernel(): bug: interrupts were "

611 
	`loˇl_úq_dißbÀ
();

613 
	`rcu_öô
();

614 
	`ødix_åì_öô
();

616 
	`óæy_úq_öô
();

617 
	`öô_IRQ
();

618 
	`¥io_åì_öô
();

619 
	`öô_timîs
();

620 
	`hπimîs_öô
();

621 
	`so·úq_öô
();

622 
	`timekìpög_öô
();

623 
	`time_öô
();

624 
	`¥ofûe_öô
();

625 i‡(!
	`úqs_dißbÀd
())

626 
	`¥ötk
(
KERN_CRIT
 "start_kernel(): bug: interrupts were "

628 
	`óæy_boŸ_úqs_⁄
();

629 
	`loˇl_úq_íabÀ
();

632 
gÂ_Ælowed_mask
 = 
__GFP_BITS_MASK
;

634 
	`kmem_ˇche_öô_œã
();

641 
	`c⁄sﬁe_öô
();

642 i‡(
∑nic_œãr
)

643 
	`∑nic
(
∑nic_œãr
, 
∑nic_∑øm
);

645 
	`lockdï_öfo
();

652 
	`lockög_£l·e°
();

654 #ifde‡
CONFIG_BLK_DEV_INITRD


655 i‡(
öôrd_°¨t
 && !
öôrd_bñow_°¨t_ok
 &&

656 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)Ë< 
mö_low_p‚
) {

657 
	`¥ötk
(
KERN_CRIT
 "initrd overwritten (0x%08lx < 0x%08lx) - "

659 
	`∑ge_to_p‚
(
	`vút_to_∑ge
((*)
öôrd_°¨t
)),

660 
mö_low_p‚
);

661 
öôrd_°¨t
 = 0;

664 
	`∑ge_cgroup_öô
();

665 
	`íabÀ_debug_∑góŒoc
();

666 
	`kmemåa˚_öô
();

667 
	`kmemÀak_öô
();

668 
	`debug_obje˘s_mem_öô
();

669 
	`idr_öô_ˇche
();

670 
	`£tup_≥r_˝u_∑ge£t
();

671 
	`numa_pﬁicy_öô
();

672 i‡(
œã_time_öô
)

673 
	`œã_time_öô
();

674 
	`sched_˛ock_öô
();

675 
	`ˇlibøã_dñay
();

676 
	`pidm≠_öô
();

677 
	`™⁄_vma_öô
();

678 #ifde‡
CONFIG_X86


679 i‡(
efi_íabÀd
)

680 
	`efi_íãr_vútuÆ_mode
();

682 
	`thªad_öfo_ˇche_öô
();

683 
	`¸ed_öô
();

684 
	`f‹k_öô
(
tŸÆøm_∑ges
);

685 
	`¥oc_ˇches_öô
();

686 
	`buf„r_öô
();

687 
	`key_öô
();

688 
	`£curôy_öô
();

689 
	`dbg_œã_öô
();

690 
	`vfs_ˇches_öô
(
tŸÆøm_∑ges
);

691 
	`sig«ls_öô
();

693 
	`∑ge_wrôeback_öô
();

694 #ifde‡
CONFIG_PROC_FS


695 
	`¥oc_roŸ_öô
();

697 
	`cgroup_öô
();

698 
	`˝u£t_öô
();

699 
	`èsk°©s_öô_óæy
();

700 
	`dñayac˘_öô
();

702 
	`check_bugs
();

704 
	`a˝i_óæy_öô
();

705 
	`sfi_öô_œã
();

707 
	`·ø˚_öô
();

710 
	`ª°_öô
();

711 
	}
}

714 
__öô
 
	$do_˘‹s
()

716 #ifde‡
CONFIG_CONSTRUCTORS


717 
˘‹_‚_t
 *
‚
 = (˘‹_‚_à*Ë
__˘‹s_°¨t
;

719 ; 
‚
 < (
˘‹_‚_t
 *Ë
__˘‹s_íd
; fn++)

720 (*
‚
)();

722 
	}
}

724 
	göôˇŒ_debug
;

725 
c‹e_∑øm
(
öôˇŒ_debug
, inôˇŒ_debug, 
boﬁ
, 0644);

727 
	gmsgbuf
[64];

728 
boŸ_åa˚_ˇŒ
 
	gˇŒ
;

729 
boŸ_åa˚_ªt
 
	gªt
;

731 
	$do_⁄e_öôˇŒ
(
öôˇŒ_t
 
‚
)

733 
cou¡
 = 
	`¥ìm±_cou¡
();

734 
ktime_t
 
ˇŒtime
, 
dñè
, 
ªâime
;

736 i‡(
öôˇŒ_debug
) {

737 
ˇŒ
.
ˇŒî
 = 
	`èsk_pid_ƒ
(
cuºít
);

738 
	`¥ötk
("ˇŒög %pF @ %i\n", 
‚
, 
ˇŒ
.
ˇŒî
);

739 
ˇŒtime
 = 
	`ktime_gë
();

740 
	`åa˚_boŸ_ˇŒ
(&
ˇŒ
, 
‚
);

741 
	`íabÀ_boŸ_åa˚
();

744 
ªt
.
ªsu…
 = 
	`‚
();

746 i‡(
öôˇŒ_debug
) {

747 
	`dißbÀ_boŸ_åa˚
();

748 
ªâime
 = 
	`ktime_gë
();

749 
dñè
 = 
	`ktime_sub
(
ªâime
, 
ˇŒtime
);

750 
ªt
.
duøti⁄
 = (Ë
	`ktime_to_ns
(
dñè
) >> 10;

751 
	`åa˚_boŸ_ªt
(&
ªt
, 
‚
);

752 
	`¥ötk
("öôˇŒ %pFÑëu∫ed %dá·î %Ld u£cs\n", 
‚
,

753 
ªt
.
ªsu…
,Ñë.
duøti⁄
);

756 
msgbuf
[0] = 0;

758 i‡(
ªt
.
ªsu…
 &&Ñë.ªsu… !-
ENODEV
 && 
öôˇŒ_debug
)

759 
	`•rötf
(
msgbuf
, "îr‹ codê%d ", 
ªt
.
ªsu…
);

761 i‡(
	`¥ìm±_cou¡
(Ë!
cou¡
) {

762 
	`°æˇt
(
msgbuf
, "preemption imbalance ", (msgbuf));

763 
	`¥ìm±_cou¡
(Ë
cou¡
;

765 i‡(
	`úqs_dißbÀd
()) {

766 
	`°æˇt
(
msgbuf
, "disabled interrupts ", (msgbuf));

767 
	`loˇl_úq_íabÀ
();

769 i‡(
msgbuf
[0]) {

770 
	`¥ötk
("öôˇŒ %pFÑëu∫ed wôh %s\n", 
‚
, 
msgbuf
);

773  
ªt
.
ªsu…
;

774 
	}
}

777 
öôˇŒ_t
 
__öôˇŒ_°¨t
[], 
__öôˇŒ_íd
[], 
__óæy_öôˇŒ_íd
[];

779 
__öô
 
	$do_öôˇŒs
()

781 
öôˇŒ_t
 *
‚
;

783 
‚
 = 
__óæy_öôˇŒ_íd
; f¿< 
__öôˇŒ_íd
; fn++)

784 
	`do_⁄e_öôˇŒ
(*
‚
);

787 
	`Êush_scheduÀd_w‹k
();

788 
	}
}

797 
__öô
 
	$do_basic_£tup
()

799 
	`öô_w‹kqueues
();

800 
	`˝u£t_öô_smp
();

801 
	`u£rmodehñ≥r_öô
();

802 
	`öô_tmpfs
();

803 
	`drivî_öô
();

804 
	`öô_úq_¥oc
();

805 
	`do_˘‹s
();

806 
	`do_öôˇŒs
();

807 
	}
}

809 
__öô
 
	$do_¥e_smp_öôˇŒs
()

811 
öôˇŒ_t
 *
‚
;

813 
‚
 = 
__öôˇŒ_°¨t
; f¿< 
__óæy_öôˇŒ_íd
; fn++)

814 
	`do_⁄e_öôˇŒ
(*
‚
);

815 
	}
}

817 
	$run_öô_¥o˚ss
(*
öô_fûíame
)

819 
¨gv_öô
[0] = 
öô_fûíame
;

820 
	`kî√l_execve
(
öô_fûíame
, 
¨gv_öô
, 
ívp_öô
);

821 
	}
}

826 
noölöe
 
	$öô_po°
()

827 
	$__ªÀa£s
(
kî√l_lock
)

830 
	`async_synchr⁄ize_fuŒ
();

831 
	`‰ì_öômem
();

832 
	`u∆ock_kî√l
();

833 
	`m¨k_rod©a_ro
();

834 
sy°em_°©e
 = 
SYSTEM_RUNNING
;

835 
	`numa_deÁu…_pﬁicy
();

838 
cuºít
->
sig«l
->
Êags
 |
SIGNAL_UNKILLABLE
;

840 i‡(
ømdisk_execuã_comm™d
) {

841 
	`run_öô_¥o˚ss
(
ømdisk_execuã_comm™d
);

842 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s\n",

843 
ømdisk_execuã_comm™d
);

852 i‡(
execuã_comm™d
) {

853 
	`run_öô_¥o˚ss
(
execuã_comm™d
);

854 
	`¥ötk
(
KERN_WARNING
 "FailedÅoÉxecute %s. Attempting "

855 "deÁu…s...\n", 
execuã_comm™d
);

857 
	`run_öô_¥o˚ss
("/sbin/init");

858 
	`run_öô_¥o˚ss
("/etc/init");

859 
	`run_öô_¥o˚ss
("/bin/init");

860 
	`run_öô_¥o˚ss
("/bin/sh");

862 
	`∑nic
("No init found. TryÖassing init= optionÅo kernel. "

864 
	}
}

866 
__öô
 
	$kî√l_öô
(* 
unu£d
)

871 
	`waô_f‹_com∂ëi⁄
(&
kthªadd_d⁄e
);

872 
	`lock_kî√l
();

877 
	`£t_mems_Ælowed
(
node_°©es
[
N_HIGH_MEMORY
]);

881 
	`£t_˝us_Ælowed_±r
(
cuºít
, 
˝u_Æl_mask
);

890 
öô_pid_ns
.
chûd_ª≠î
 = 
cuºít
;

892 
ˇd_pid
 = 
	`èsk_pid
(
cuºít
);

894 
	`smp_¥ï¨e_˝us
(
£tup_max_˝us
);

896 
	`do_¥e_smp_öôˇŒs
();

897 
	`°¨t_boŸ_åa˚
();

899 
	`smp_öô
();

900 
	`sched_öô_smp
();

902 
	`do_basic_£tup
();

905 i‡(
	`sys_›í
((c⁄° 
__u£r
 *Ë"/dev/c⁄sﬁe", 
O_RDWR
, 0) < 0)

906 
	`¥ötk
(
KERN_WARNING
 "Warning: unableÅo openán initial console.\n");

908 (Ë
	`sys_dup
(0);

909 (Ë
	`sys_dup
(0);

915 i‡(!
ømdisk_execuã_comm™d
)

916 
ømdisk_execuã_comm™d
 = "/init";

918 i‡(
	`sys_ac˚ss
((c⁄° 
__u£r
 *Ë
ømdisk_execuã_comm™d
, 0) != 0) {

919 
ømdisk_execuã_comm™d
 = 
NULL
;

920 
	`¥ï¨e_«me•a˚
();

929 
	`öô_po°
();

931 
	}
}

	@/cmpt816/linux/init/version.c

9 
	~<gíî©ed/compûe.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/uts.h
>

12 
	~<löux/ut¢ame.h
>

13 
	~<gíî©ed/ut§ñó£.h
>

14 
	~<löux/vîsi⁄.h
>

16 #i‚de‡
CONFIG_KALLSYMS


17 
	#vîsi⁄
(
a
Ë
Vîsi⁄_
 ## 
	)
a

18 
	#vîsi⁄_°rög
(
a
Ë
	`vîsi⁄
◊)

	)

20 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

21 
vîsi⁄_°rög
(
LINUX_VERSION_CODE
);

24 
uts_«me•a˚
 
	göô_uts_ns
 = {

25 .
kªf
 = {

26 .
ªfcou¡
 = 
ATOMIC_INIT
(2),

28 .
	g«me
 = {

29 .
sy¢ame
 = 
UTS_SYSNAME
,

30 .
	gnodíame
 = 
UTS_NODENAME
,

31 .
	gªÀa£
 = 
UTS_RELEASE
,

32 .
	gvîsi⁄
 = 
UTS_VERSION
,

33 .
	gmachöe
 = 
UTS_MACHINE
,

34 .
	gdomaö«me
 = 
UTS_DOMAINNAME
,

37 
EXPORT_SYMBOL_GPL
(
öô_uts_ns
);

40 c⁄° 
	glöux_b™√r
[] =

41 "Löux vîsi⁄ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

42 
LINUX_COMPILE_HOST
 "Ë(" 
LINUX_COMPILER
 "Ë" 
UTS_VERSION
 "\n";

44 c⁄° 
	glöux_¥oc_b™√r
[] =

46 " (" 
LINUX_COMPILE_BY
 "@" 
LINUX_COMPILE_HOST
 ")"

47 " (" 
LINUX_COMPILER
 ") %s\n";

	@/cmpt816/linux/scripts/mod/empty.c

	@
1
.
0
159
6769
/cmpt816/linux/arch/x86/ia32/audit.c
/cmpt816/linux/arch/x86/ia32/ia32_signal.c
/cmpt816/linux/arch/x86/ia32/ipc32.c
/cmpt816/linux/arch/x86/ia32/sys_ia32.c
/cmpt816/linux/arch/x86/kernel/acpi/boot.c
/cmpt816/linux/arch/x86/kernel/acpi/cstate.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/regs.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-bios.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-mode.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vesa.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/video-vga.c
/cmpt816/linux/arch/x86/kernel/acpi/realmode/wakemain.c
/cmpt816/linux/arch/x86/kernel/acpi/sleep.c
/cmpt816/linux/arch/x86/kernel/alternative.c
/cmpt816/linux/arch/x86/kernel/amd_iommu.c
/cmpt816/linux/arch/x86/kernel/amd_iommu_init.c
/cmpt816/linux/arch/x86/kernel/aperture_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic.c
/cmpt816/linux/arch/x86/kernel/apic/apic_flat_64.c
/cmpt816/linux/arch/x86/kernel/apic/apic_noop.c
/cmpt816/linux/arch/x86/kernel/apic/io_apic.c
/cmpt816/linux/arch/x86/kernel/apic/ipi.c
/cmpt816/linux/arch/x86/kernel/apic/nmi.c
/cmpt816/linux/arch/x86/kernel/apic/probe_64.c
/cmpt816/linux/arch/x86/kernel/audit_64.c
/cmpt816/linux/arch/x86/kernel/bootflag.c
/cmpt816/linux/arch/x86/kernel/check.c
/cmpt816/linux/arch/x86/kernel/cpu/addon_cpuid_features.c
/cmpt816/linux/arch/x86/kernel/cpu/amd.c
/cmpt816/linux/arch/x86/kernel/cpu/bugs_64.c
/cmpt816/linux/arch/x86/kernel/cpu/capflags.c
/cmpt816/linux/arch/x86/kernel/cpu/centaur.c
/cmpt816/linux/arch/x86/kernel/cpu/common.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
/cmpt816/linux/arch/x86/kernel/cpu/cpufreq/mperf.c
/cmpt816/linux/arch/x86/kernel/cpu/hypervisor.c
/cmpt816/linux/arch/x86/kernel/cpu/intel.c
/cmpt816/linux/arch/x86/kernel/cpu/intel_cacheinfo.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce-severity.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_amd.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/mce_intel.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/therm_throt.c
/cmpt816/linux/arch/x86/kernel/cpu/mcheck/threshold.c
/cmpt816/linux/arch/x86/kernel/cpu/mshyperv.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/cleanup.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/generic.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/if.c
/cmpt816/linux/arch/x86/kernel/cpu/mtrr/main.c
/cmpt816/linux/arch/x86/kernel/cpu/perf_event.c
/cmpt816/linux/arch/x86/kernel/cpu/perfctr-watchdog.c
/cmpt816/linux/arch/x86/kernel/cpu/powerflags.c
/cmpt816/linux/arch/x86/kernel/cpu/proc.c
/cmpt816/linux/arch/x86/kernel/cpu/sched.c
/cmpt816/linux/arch/x86/kernel/cpu/vmware.c
/cmpt816/linux/arch/x86/kernel/cpuid.c
/cmpt816/linux/arch/x86/kernel/crash.c
/cmpt816/linux/arch/x86/kernel/crash_dump_64.c
/cmpt816/linux/arch/x86/kernel/dumpstack.c
/cmpt816/linux/arch/x86/kernel/dumpstack_64.c
/cmpt816/linux/arch/x86/kernel/e820.c
/cmpt816/linux/arch/x86/kernel/early-quirks.c
/cmpt816/linux/arch/x86/kernel/early_printk.c
/cmpt816/linux/arch/x86/kernel/efi.c
/cmpt816/linux/arch/x86/kernel/efi_64.c
/cmpt816/linux/arch/x86/kernel/head.c
/cmpt816/linux/arch/x86/kernel/head64.c
/cmpt816/linux/arch/x86/kernel/hpet.c
/cmpt816/linux/arch/x86/kernel/hw_breakpoint.c
/cmpt816/linux/arch/x86/kernel/i387.c
/cmpt816/linux/arch/x86/kernel/i8237.c
/cmpt816/linux/arch/x86/kernel/i8253.c
/cmpt816/linux/arch/x86/kernel/i8259.c
/cmpt816/linux/arch/x86/kernel/init_task.c
/cmpt816/linux/arch/x86/kernel/io_delay.c
/cmpt816/linux/arch/x86/kernel/ioport.c
/cmpt816/linux/arch/x86/kernel/irq.c
/cmpt816/linux/arch/x86/kernel/irq_64.c
/cmpt816/linux/arch/x86/kernel/irqinit.c
/cmpt816/linux/arch/x86/kernel/k8.c
/cmpt816/linux/arch/x86/kernel/kdebugfs.c
/cmpt816/linux/arch/x86/kernel/kprobes.c
/cmpt816/linux/arch/x86/kernel/ldt.c
/cmpt816/linux/arch/x86/kernel/machine_kexec_64.c
/cmpt816/linux/arch/x86/kernel/microcode_amd.c
/cmpt816/linux/arch/x86/kernel/microcode_core.c
/cmpt816/linux/arch/x86/kernel/microcode_intel.c
/cmpt816/linux/arch/x86/kernel/mmconf-fam10h_64.c
/cmpt816/linux/arch/x86/kernel/module.c
/cmpt816/linux/arch/x86/kernel/mpparse.c
/cmpt816/linux/arch/x86/kernel/msr.c
/cmpt816/linux/arch/x86/kernel/pci-calgary_64.c
/cmpt816/linux/arch/x86/kernel/pci-dma.c
/cmpt816/linux/arch/x86/kernel/pci-gart_64.c
/cmpt816/linux/arch/x86/kernel/pci-nommu.c
/cmpt816/linux/arch/x86/kernel/pci-swiotlb.c
/cmpt816/linux/arch/x86/kernel/pcspeaker.c
/cmpt816/linux/arch/x86/kernel/pmtimer_64.c
/cmpt816/linux/arch/x86/kernel/process.c
/cmpt816/linux/arch/x86/kernel/process_64.c
/cmpt816/linux/arch/x86/kernel/ptrace.c
/cmpt816/linux/arch/x86/kernel/quirks.c
/cmpt816/linux/arch/x86/kernel/reboot.c
/cmpt816/linux/arch/x86/kernel/rtc.c
/cmpt816/linux/arch/x86/kernel/setup.c
/cmpt816/linux/arch/x86/kernel/setup_percpu.c
/cmpt816/linux/arch/x86/kernel/signal.c
/cmpt816/linux/arch/x86/kernel/smp.c
/cmpt816/linux/arch/x86/kernel/smpboot.c
/cmpt816/linux/arch/x86/kernel/stacktrace.c
/cmpt816/linux/arch/x86/kernel/step.c
/cmpt816/linux/arch/x86/kernel/sys_x86_64.c
/cmpt816/linux/arch/x86/kernel/syscall_64.c
/cmpt816/linux/arch/x86/kernel/tce_64.c
/cmpt816/linux/arch/x86/kernel/test_nx.c
/cmpt816/linux/arch/x86/kernel/time.c
/cmpt816/linux/arch/x86/kernel/tls.c
/cmpt816/linux/arch/x86/kernel/topology.c
/cmpt816/linux/arch/x86/kernel/trampoline.c
/cmpt816/linux/arch/x86/kernel/traps.c
/cmpt816/linux/arch/x86/kernel/tsc.c
/cmpt816/linux/arch/x86/kernel/tsc_sync.c
/cmpt816/linux/arch/x86/kernel/vsmp_64.c
/cmpt816/linux/arch/x86/kernel/vsyscall_64.c
/cmpt816/linux/arch/x86/kernel/x8664_ksyms_64.c
/cmpt816/linux/arch/x86/kernel/x86_init.c
/cmpt816/linux/arch/x86/kernel/xsave.c
/cmpt816/linux/arch/x86/mm/extable.c
/cmpt816/linux/arch/x86/mm/fault.c
/cmpt816/linux/arch/x86/mm/gup.c
/cmpt816/linux/arch/x86/mm/hugetlbpage.c
/cmpt816/linux/arch/x86/mm/init.c
/cmpt816/linux/arch/x86/mm/init_64.c
/cmpt816/linux/arch/x86/mm/ioremap.c
/cmpt816/linux/arch/x86/mm/k8topology_64.c
/cmpt816/linux/arch/x86/mm/mmap.c
/cmpt816/linux/arch/x86/mm/numa.c
/cmpt816/linux/arch/x86/mm/numa_64.c
/cmpt816/linux/arch/x86/mm/pageattr.c
/cmpt816/linux/arch/x86/mm/pat.c
/cmpt816/linux/arch/x86/mm/pat_rbtree.c
/cmpt816/linux/arch/x86/mm/pgtable.c
/cmpt816/linux/arch/x86/mm/physaddr.c
/cmpt816/linux/arch/x86/mm/setup_nx.c
/cmpt816/linux/arch/x86/mm/srat_64.c
/cmpt816/linux/arch/x86/mm/tlb.c
/cmpt816/linux/arch/x86/vdso/vclock_gettime.c
/cmpt816/linux/arch/x86/vdso/vgetcpu.c
/cmpt816/linux/arch/x86/vdso/vma.c
/cmpt816/linux/arch/x86/vdso/vvar.c
/cmpt816/linux/init/calibrate.c
/cmpt816/linux/init/do_mounts.c
/cmpt816/linux/init/do_mounts_initrd.c
/cmpt816/linux/init/do_mounts_md.c
/cmpt816/linux/init/do_mounts_rd.c
/cmpt816/linux/init/initramfs.c
/cmpt816/linux/init/main.c
/cmpt816/linux/init/version.c
/cmpt816/linux/scripts/mod/empty.c
